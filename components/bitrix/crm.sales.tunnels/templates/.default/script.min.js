this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(t,e,n,a,r,o){"use strict";var i;function s(){return o.Tag.render(i||(i=babelHelpers.taggedTemplateLiteral(['<div class="crm-st-kanban-stub"></div>'])))}function l(t){return o.Type.isArray(t)&&t.length===2&&t.every(o.Type.isNumber)}function u(t,e){if(!l(t)||!l(e)){throw new Error("Invalid lines. Line should be Array<number>")}var n=Math.min.apply(Math,babelHelpers.toConsumableArray(t));var a=Math.max.apply(Math,babelHelpers.toConsumableArray(t));var r=Math.min.apply(Math,babelHelpers.toConsumableArray(e));var o=Math.max.apply(Math,babelHelpers.toConsumableArray(e));return n>=r&&n<=o||a>=r&&a<=o||r>=n&&r<=a||o>=n&&o<=a}var c=function t(e){return o.Type.isNumber(e.left)&&o.Type.isNumber(e.top)&&o.Type.isNumber(e.width)&&o.Type.isNumber(e.height)};function d(t,e){if(!c(t)||!c(e)){throw new Error("Invalid rect. Rect should includes x, y, width and height props with a number value")}return{left:e.left-t.left,top:e.top-t.top,right:e.left-t.left+e.width,bottom:e.top-t.top+e.height,width:e.width,height:e.height}}function g(t){return o.Type.isNumber(t.left)&&o.Type.isNumber(t.top)&&o.Type.isNumber(t.width)&&o.Type.isNumber(t.height)}function m(t){if(!g(t)){throw new Error("Invalid rect. Rect should includes x, y, width and height props with a number value")}return{middleX:t.left+t.width/2,middleY:t.top+t.height/2}}var h,b,f,p;function v(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function y(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?v(Object(n),!0).forEach((function(e){babelHelpers.defineProperty(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):v(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var C=function(t){babelHelpers.inherits(n,t);babelHelpers.createClass(n,null,[{key:"getMarkerFromPoint",value:function t(e){return n.instances.find((function(t){return t.isReceiverIntersecting(e)}))}},{key:"emitReceiverDragOutForAll",value:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;n.instances.forEach((function(t){if(t!==e){t.onReceiverDragOut()}}))}},{key:"getAllLinks",value:function t(){return n.instances.reduce((function(t,e){return babelHelpers.toConsumableArray(e.links).reduce((function(t,e){return t.add(e)}),t)}),new Set)}},{key:"getAllStubLinks",value:function t(){return n.instances.reduce((function(t,e){return babelHelpers.toConsumableArray(e.stubLinks).reduce((function(t,e){return t.add(e)}),t)}),new Set)}},{key:"highlightLink",value:function t(){for(var e=arguments.length,a=new Array(e),r=0;r<e;r++){a[r]=arguments[r]}n.getAllLinks().forEach((function(t){if(!a.includes(t)){if([].concat(a).every((function(e){return e.from!==t.from}))){o.Dom.addClass(t.from.dispatcher,"crm-st-fade");o.Dom.addClass(t.from.receiver,"crm-st-fade");o.Dom.addClass(t.from.getTunnelButton(),"crm-st-fade")}o.Dom.addClass(t.to.dispatcher,"crm-st-fade");o.Dom.addClass(t.to.receiver,"crm-st-fade");o.Dom.addClass(t.node.node(),"crm-st-fade");o.Dom.addClass(t.arrow.select("path").node(),"crm-st-fade")}else{var e=t.node.node();e.parentNode.appendChild(e);var n=t.arrow.node();var r=n.closest("defs");o.Dom.insertAfter(n,r.firstChild)}}))}},{key:"unhighlightLinks",value:function t(){n.getAllLinks().forEach((function(t){o.Dom.removeClass(t.from.dispatcher,"crm-st-fade");o.Dom.removeClass(t.from.receiver,"crm-st-fade");o.Dom.removeClass(t.from.getTunnelButton(),"crm-st-fade");o.Dom.removeClass(t.to.dispatcher,"crm-st-fade");o.Dom.removeClass(t.to.receiver,"crm-st-fade");o.Dom.removeClass(t.node.node(),"crm-st-fade");o.Dom.removeClass(t.arrow.select("path").node(),"crm-st-fade")}))}},{key:"blurLinks",value:function t(e){n.getAllLinks().forEach((function(t){if(t.from===e||t.to===e){o.Dom.addClass(t.node.node(),"crm-st-blur-link");o.Dom.addClass(t.from.getTunnelButton(),"crm-st-blur-link")}}))}},{key:"unblurLinks",value:function t(){n.getAllLinks().forEach((function(t){o.Dom.removeClass(t.node.node(),"crm-st-blur-link");o.Dom.removeClass(t.from.getTunnelButton(),"crm-st-blur-link");o.Dom.removeClass(t.to.getTunnelButton(),"crm-st-blur-link")}))}},{key:"removeAllLinks",value:function t(){n.instances.forEach((function(t){var e=true;t.removeAllLinks(e)}));n.instances.forEach((function(t){t.removeAllStubLinks()}))}},{key:"restoreAllLinks",value:function t(){var e=true;n.getAllLinks().forEach((function(t){t.from.links["delete"](t);t.from.addLinkTo(t.to,t.robotAction,e)}))}},{key:"adjustLinks",value:function t(){n.getAllLinks().forEach((function(t,a){var r=t.from.getLinkPath(t.to);t.node.style("transition","none");e.select(t.from.getTunnelButton()).style("transition","none");t.from.showTunnelButton(r);t.node.attr("d",e.line()(r));t.path=r;clearTimeout(n.adjustLinksTimeoutIds[a]);n.adjustLinksTimeoutIds[a]=setTimeout((function(){t.node.style("transition",null);e.select(t.from.getTunnelButton()).style("transition",null)}),1e3)}))}}]);function n(t){var a;babelHelpers.classCallCheck(this,n);a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"links",new Set);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"stubLinks",new Set);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"cache",new o.Cache.MemoryCache);a.dispatcher=t.dispatcher;a.receiver=t.receiver;a.point=t.point;a.container=t.container;a.intermediateXPoints=t.intermediateXPoints;a.name=t.name;a.data=t.data;var r=a.getLinksRoot();if(!r.select("defs").node()){r.append("svg:defs").append("filter").attr("id","crm-st-blur").append("feGaussianBlur").attr("stdDeviation","2");r.select("#crm-st-blur").append("feColorMatrix").attr("type","saturate").attr("values","0")}a.onDispatcherMouseDown=a.onDispatcherMouseDown.bind(babelHelpers.assertThisInitialized(a));a.onMarkerRootMouseUp=a.onMarkerRootMouseUp.bind(babelHelpers.assertThisInitialized(a));a.onMarkerRootMouseMove=a.onMarkerRootMouseMove.bind(babelHelpers.assertThisInitialized(a));e.select(a.dispatcher).on("mousedown",a.onDispatcherMouseDown);n.instances.push(babelHelpers.assertThisInitialized(a));return a}babelHelpers.createClass(n,[{key:"disable",value:function t(){this.disabled=true}},{key:"enable",value:function t(){this.disabled=false}},{key:"isEnabled",value:function t(){return!this.disabled}},{key:"getMarkerRoot",value:function t(){var n=this;return this.cache.remember("markerRoot",(function(){var t=e.select(n.container).select(".crm-st-svg-root");if(t.node()){return t}return e.select(n.container).append("svg").attr("class","crm-st-svg-root")}))}},{key:"getMarkerRootRect",value:function t(){return this.getMarkerRoot().node().getBoundingClientRect()}},{key:"getLinksRoot",value:function t(){var n=this;return this.cache.remember("linksRoot",(function(){var t=e.select(n.container).select(".crm-st-svg-links-root");if(t.node()){return t}return e.select(n.container).append("svg").attr("class","crm-st-svg-links-root")}))}},{key:"getMarkerLine",value:function t(){return this.cache.remember("markerLine",this.getMarkerRoot().append("line").attr("class","crm-st-svg-marker"))}},{key:"removeMarkerLine",value:function t(){this.getMarkerLine().remove();this.cache["delete"]("markerLine")}},{key:"getDispatcherRect",value:function t(){var e=d(this.getMarkerRootRect(),this.dispatcher.getBoundingClientRect());return y(y({},e),m(e))}},{key:"getReceiverRect",value:function t(){var e=d(this.getMarkerRootRect(),this.receiver.getBoundingClientRect());return y(y({},e),m(e))}},{key:"getPointRect",value:function t(){var e=d(this.getMarkerRootRect(),this.point.getBoundingClientRect());return y(y({},e),m(e))}},{key:"getMarkerRootMousePosition",value:function t(){var n=e.mouse(this.getMarkerRoot().node()),a=babelHelpers.slicedToArray(n,2),r=a[0],o=a[1];return{x:r,y:o}}},{key:"onReceiverDragOver",value:function t(e,n){if(!this.hovered){this.hovered=true;this.emit("Marker:receiver:dragOver",{from:e,to:n})}}},{key:"onReceiverDragOut",value:function t(){if(this.hovered){this.hovered=false;this.emit("Marker:receiver:dragOut")}}},{key:"onDispatcherMouseDown",value:function t(){var e=this.getDispatcherRect(),n=e.middleX,a=e.middleY;this.getMarkerLine().attr("x1",n).attr("y1",a).attr("x2",n).attr("y2",a);this.getMarkerRoot().style("z-index","222").on("mousemove",this.onMarkerRootMouseMove).on("mouseup",this.onMarkerRootMouseUp);this.emit("Marker:dragStart")}},{key:"onMarkerRootMouseMove",value:function t(){var e=this.getMarkerRootMousePosition(),a=e.x,r=e.y;this.getMarkerLine().attr("x2",a).attr("y2",r);this.emit("Marker:drag");var o=this.getDestinationMarker();if(o&&o.isEnabled()){if(o!==this){o.onReceiverDragOver(this,o)}}n.emitReceiverDragOutForAll(o)}},{key:"onMarkerRootMouseUp",value:function t(){this.getMarkerRoot().on("mousemove",null).on("mouseup",null).style("z-index",null);this.removeMarkerLine();n.instances.forEach((function(t){return t.onReceiverDragOut()}));var e=this.getDestinationMarker();var a=new o.Event.BaseEvent({data:{from:this,to:e}});this.emit("Marker:dragEnd",a);if(e&&e.isEnabled()){if(e&&!a.isDefaultPrevented()){if(!this.data.column.data.isCategoryEditable){this.emit("Marker:error",{message:o.Loc.getMessage("CRM_ST_TUNNEL_EDIT_ACCESS_DENIED")});return}this.addLinkTo(e,"copy")}}}},{key:"getTunnelMenu",value:function t(){var e=this;return this.cache.remember("tunnelMenu",(function(){return new r.PopupMenuWindow({bindElement:e.getTunnelButton(),items:e.getTunnelMenuItems(babelHelpers.toConsumableArray(e.links)[0]),events:{onPopupClose:function t(){return e.deactivateTunnelButton()},onPopupShow:function t(){return e.activateTunnelButton()}}})}))}},{key:"getTunnelMenuItems",value:function t(e){var n=this;var a=function t(a){if(!o.Type.isNil(e)&&e.robotAction!==a){n.changeRobotAction(e,a);e.robotAction=a}this.getParentMenuWindow().close();this.getParentMenuWindow().getMenuItems()[0].setText(o.Loc.getMessage("CRM_ST_ROBOT_ACTION_".concat(a.toUpperCase())))};var r=o.Type.isNil(e)?"COPY":e.robotAction.toUpperCase();return[{text:o.Loc.getMessage("CRM_ST_ROBOT_ACTION_".concat(r)),items:[{text:o.Loc.getMessage("CRM_ST_ACTION_COPY"),onclick:function t(){a.call(this,"copy")}},{text:o.Loc.getMessage("CRM_ST_ACTION_MOVE"),onclick:function t(){a.call(this,"move")}}]},{text:o.Loc.getMessage("CRM_ST_SETTINGS"),onclick:function t(){n.editLink(e);this.close()}},{text:o.Loc.getMessage("CRM_ST_REMOVE"),onclick:function t(){n.removeLink(e);var a=this.getParentMenuWindow();if(a){a.removeMenuItem(this.getParentMenuItem().id)}}}]}},{key:"changeRobotAction",value:function t(e,n){var a=this;this.emit("Marker:changeRobotAction",{link:e,action:n,onChangeRobotEnd:function t(){return a.emit("Marker:editLink",{link:e})}})}},{key:"editLink",value:function t(e){this.emit("Marker:editLink",{link:e})}},{key:"addLinkTo",value:function t(a,r){var i=this;var s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;setTimeout((function(){if(!babelHelpers.toConsumableArray(i.links).some((function(t){return t.to===a}))){var t=i.getLinksRoot();var l=i.getLinkPath(a);var u=e.line();var c=i.data.column.getId().replace(":","-");var d=a.data.column.getId().replace(":","-");var g="".concat(c,"-").concat(d);var m=t.select("defs").append("svg:marker").attr("id",g).attr("refX",8).attr("refY",6).attr("markerWidth",30).attr("markerHeight",30).attr("markerUnits","userSpaceOnUse").attr("orient","auto").append("path").attr("d","M 0 0 12 6 0 12 3 6").attr("class","crm-st-svg-link-arrow").select((function t(){return this.parentNode}));var h=t.append("path").attr("class","crm-st-svg-link").attr("marker-end","url(#".concat(g,")")).attr("d",u(l));i.showTunnelButton(l);var b={from:i,to:a,node:h,robotAction:r,arrow:m,path:l};i.emit("Marker:linkFrom",{link:b,preventSave:s});a.emit("Marker:linkTo",{link:b,preventSave:s});i.links.add(b);var f=i.getTunnelsListMenu();var p=f.getMenuItems().length;f.addMenuItem({id:"#".concat(p),text:o.Text.encode(a.name),events:{onMouseEnter:function t(){n.highlightLink(b)},onMouseLeave:function t(){n.unhighlightLinks()}},items:i.getTunnelMenuItems(b)})}if(i.links.size>1){i.setTunnelsCounterValue(i.links.size)}}))}},{key:"addStubLinkTo",value:function t(n){var a=this;setTimeout((function(){if(!babelHelpers.toConsumableArray(a.stubLinks).some((function(t){return t.to===n}))){var t=a.getLinksRoot();var r=a.getLinkPath(n);var o=e.line();var i=a.data.column.getId().replace(":","-");var s=n.data.column.getId().replace(":","-");var l="".concat(i,"-").concat(s);var u=t.select("defs").append("svg:marker").attr("id",l).attr("refX",8).attr("refY",6).attr("markerWidth",30).attr("markerHeight",30).attr("markerUnits","userSpaceOnUse").attr("orient","auto").append("path").attr("d","M 0 0 12 6 0 12 3 6").attr("class","crm-st-svg-link-arrow crm-st-svg-link-arrow-stub").select((function t(){return this.parentNode}));var c=t.append("path").attr("class","crm-st-svg-link crm-st-svg-link-stub").attr("marker-end","url(#".concat(l,")")).attr("d",o(r));a.showTunnelStubButton(r);var d={from:a,to:n,node:c,arrow:u,path:r};a.emit("Marker:stubLinkFrom",{link:d,preventSave:true});n.emit("Marker:stubLinkTo",{link:d,preventSave:true});a.stubLinks.add(d)}}))}},{key:"updateLink",value:function t(n,a){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var o=this.getLinkPath(a);var i=e.line();var s=n.to;n.node.attr("d",i(o));n.path=o;n.to=a;this.emit("Marker:linkFrom",{link:n,preventSave:r});a.emit("Marker:linkTo",{link:n,preventSave:r});if(!s.isLinked()){s.emit("Marker:unlink")}}},{key:"removeLink",value:function t(e){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;e.hidden=true;if(!n){this.links["delete"](e)}e.node.remove();e.arrow.remove();if(!this.isLinkedFrom()){o.Dom.remove(e.from.getTunnelButton());this.getTunnelMenu().destroy();this.deactivateTunnelButton();this.cache["delete"]("tunnelMenu")}this.setTunnelsCounterValue(this.links.size);var a=babelHelpers.toConsumableArray(this.links).filter((function(t){return!t.hidden}));if(a.length<=1){if(this.getTunnelsListMenu().getPopupWindow().isShown()){this.getTunnelMenu().destroy();this.cache["delete"]("tunnelMenu");this.getTunnelMenu().show()}this.getTunnelsListMenu().destroy();this.deactivateTunnelButton();this.cache["delete"]("tunnelsListMenu")}e.from.emit("Marker:removeLinkFrom",{link:e,preventSave:n});if(!e.from.isLinked()){e.from.emit("Marker:unlink",{preventSave:n})}e.to.emit("Marker:removeTo",{link:e,preventSave:n});if(!e.to.isLinked()){e.to.emit("Marker:unlink",{preventSave:n})}}},{key:"removeAllLinks",value:function t(){var e=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this.links.forEach((function(t){return e.removeLink(t,n)}))}},{key:"removeStubLink",value:function t(e){this.stubLinks["delete"](e);e.node.remove();e.arrow.remove();if(!this.isLinkedStub()){o.Dom.remove(e.from.getStubTunnelButton())}e.from.emit("Marker:removeStubLink",{link:e});e.from.emit("Marker:removeStubLinkFrom",{link:e});if(!e.from.isLinkedStub()){e.from.emit("Marker:unlinkStub")}e.to.emit("Marker:removeStubTo",{link:e});if(!e.to.isLinkedStub()){e.to.emit("Marker:unlinkStub")}}},{key:"removeAllStubLinks",value:function t(){var e=this;this.stubLinks.forEach((function(t){return e.removeStubLink(t)}))}},{key:"isLinked",value:function t(){var e=this;return babelHelpers.toConsumableArray(n.getAllLinks()).some((function(t){return!t.hidden&&(t.from===e||t.to===e)}))}},{key:"isLinkedFrom",value:function t(){var e=this;return babelHelpers.toConsumableArray(n.getAllLinks()).some((function(t){return!t.hidden&&t.from===e}))}},{key:"isLinkedTo",value:function t(){var e=this;return babelHelpers.toConsumableArray(n.getAllLinks()).some((function(t){return!t.hidden&&t.to===e}))}},{key:"isLinkedStub",value:function t(){var e=this;return babelHelpers.toConsumableArray(n.getAllLinks()).some((function(t){return!t.hidden&&(t.from===e||t.to===e)}))}},{key:"showTunnelButton",value:function t(e){var n=this.getTunnelButton();var a=this.getCategory();var r=e[0][0];o.Tag.style(n)(h||(h=babelHelpers.taggedTemplateLiteral(["\n\t\t\tbottom: 0px;\n\t\t\tleft: ","px;\n\t\t\ttransform: translate3d(-50%, 50%, 0);\n\t\t"])),r);if(!a.contains(n)){o.Dom.append(n,a)}}},{key:"getStubTunnelButton",value:function t(){var e=this;return this.cache.remember("tunnelStubButton",(function(){var t=o.Runtime.clone(e.getTunnelButton());o.Dom.addClass(t,"crm-st-tunnel-button-stub");return t}))}},{key:"showTunnelStubButton",value:function t(e){var n=this.getStubTunnelButton();var a=this.getCategory();var r=e[0][0];o.Tag.style(n)(b||(b=babelHelpers.taggedTemplateLiteral(["\n\t\t\tbottom: 0px;\n\t\t\tleft: ","px;\n\t\t\ttransform: translate3d(-50%, 50%, 0);\n\t\t"])),r);if(!a.contains(n)){o.Dom.append(n,a)}}},{key:"getTunnelButton",value:function t(){var e=this;var a=this.data.column.data.isCategoryEditable;return this.cache.remember("tunnelButton",(function(){return o.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-tunnel-button" \n\t\t\t\t\t onmouseenter="','"\n\t\t\t\t\t onmouseleave="','"\n\t\t\t\t\t onclick="','"\n\t\t\t\t\t title="','"\n\t\t\t\t\t style="','"\n\t\t\t\t>',"</div>\n\t\t\t"])),e.onTunnelButtonMouseEnter.bind(e),n.onTunnelButtonMouseLeave,e.onTunnelButtonClick.bind(e),o.Loc.getMessage("CRM_ST_TUNNEL_BUTTON_TITLE"),!a?"pointer-events: none;":"",o.Loc.getMessage("CRM_ST_TUNNEL_BUTTON_LABEL"))}))}},{key:"onTunnelButtonMouseEnter",value:function t(){n.highlightLink.apply(n,babelHelpers.toConsumableArray(this.links))}},{key:"onTunnelButtonClick",value:function t(){if(BX.Crm.Restriction.Bitrix24.isRestricted("automation")){BX.Crm.Restriction.Bitrix24.getHandler("automation").call()}else if(this.links.size>1){if(this.isTunnelButtonActive()){this.getTunnelsListMenu().close();return}this.getTunnelsListMenu().show()}else{this.getTunnelMenu().show()}}},{key:"getTunnelsListMenu",value:function t(){var e=this;return this.cache.remember("tunnelsListMenu",new r.PopupMenuWindow({bindElement:this.getTunnelButton(),items:[],closeByEsc:true,menuShowDelay:0,events:{onPopupClose:function t(){return e.deactivateTunnelButton()},onPopupShow:function t(){return e.activateTunnelButton()}}}))}},{key:"activateTunnelButton",value:function t(){o.Dom.addClass(this.getTunnelButton(),"crm-st-tunnel-button-active")}},{key:"deactivateTunnelButton",value:function t(){o.Dom.removeClass(this.getTunnelButton(),"crm-st-tunnel-button-active")}},{key:"isTunnelButtonActive",value:function t(){return o.Dom.hasClass(this.getTunnelButton(),"crm-st-tunnel-button-active")}},{key:"getTunnelsCounter",value:function t(){return this.cache.remember("tunnelsCounter",o.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['<span class="crm-st-tunnel-button-counter">0</span>']))))}},{key:"setTunnelsCounterValue",value:function t(e){var n=this.getTunnelButton();var a=this.getTunnelsCounter();if(e>1){if(!n.contains(a)){o.Dom.append(a,n)}a.innerText=e}else{a.innerText=0;o.Dom.remove(a)}}},{key:"getCategory",value:function t(){return this.receiver.closest(".crm-st-category")}},{key:"getIntermediateXPoints",value:function t(){if(o.Type.isArray(this.intermediateXPoints)){var e=this.getMarkerRootRect();return this.intermediateXPoints.map((function(t){return t-e.left}))}if(o.Type.isFunction(this.intermediateXPoints)){var n=this.getMarkerRootRect();return this.intermediateXPoints().map((function(t){return t-n.left}))}return[]}},{key:"getNearestIntermediateXPoint",value:function t(e){return this.getIntermediateXPoints().reduce((function(t,n){return Math.abs(n-e)<Math.abs(t-e)?n:t}))}},{key:"getLinkPath",value:function t(e){var a=this;var r=e.getPointRect();var o=this.getDispatcherRect();var i=80;var s=10;var l=[];l.push([o.middleX,o.middleY]);l.push([o.middleX,o.middleY+i]);if(o.middleY!==r.middleY){var c=this.getNearestIntermediateXPoint(r.middleX);l.push([c,o.middleY+i]);l.push([c,r.middleY+i/3-s/3]);l.push([r.middleX,r.middleY+i/3-s/3])}else{l.push([r.middleX,r.middleY+i])}l.push([r.middleX,r.middleY+s]);var d=4;return babelHelpers.toConsumableArray(n.getAllLinks()).reduce((function(t,e){var n=e.from,r=e.path;if(n!==a){if(t[1][1]===r[1][1]){if(u([t[1][0],t[2][0]],[r[1][0],r[2][0]])){t[1][1]+=d;t[2][1]+=d}}if(r.length===6){if(t[1][1]===r[3][1]){if(u([t[1][0],t[2][0]],[r[3][0],r[4][0]])){t[1][1]+=d;t[2][1]+=d}}}if(t.length===6){if(t[3][1]===r[1][1]){if(u([t[3][0],t[4][0]],[r[1][0],r[2][0]])){t[3][1]+=d;t[4][1]+=d}}if(r.length===6){if(t[3][1]===r[3][1]){if(u([t[3][0],t[4][0]],[r[3][0],r[4][0]])){t[3][1]+=d;t[4][1]+=d}}}}if(t.length===6){if(t[2][0]===r[2][0]){if(u([t[2][1],t[3][1]],[r[2][1],r[3][1]])){t[2][0]+=d;t[3][0]+=d}}}}return t}),[].concat(l))}},{key:"getDestinationMarker",value:function t(){var e=this.getMarkerRootMousePosition();var a=n.getMarkerFromPoint(e);if(a&&a!==this){return a}return null}},{key:"isReceiverIntersecting",value:function t(e){var n=this.getReceiverRect();var a=10;return e.x>n.left&&e.x<n.right&&e.y>n.top&&e.y<n.bottom+a}},{key:"blurLinks",value:function t(){n.blurLinks(this)}},{key:"getData",value:function t(){return this.data}}],[{key:"onTunnelButtonMouseLeave",value:function t(){n.unhighlightLinks()}}]);return n}(o.Event.EventEmitter);babelHelpers.defineProperty(C,"instances",[]);babelHelpers.defineProperty(C,"paths",[]);babelHelpers.defineProperty(C,"adjustLinksTimeoutIds",{});function k(t){var e=t.data.from.data.column;var n=t.data.to.data.column;var a=e.getData();var r=n.getData();return String(a.category.id)===String(r.category.id)}function T(t){var e=t.data.from.data.column;var n=t.data.to.data.column;return babelHelpers.toConsumableArray(C.getAllLinks()).some((function(t){return t.from===n.marker&&t.to===e.marker}))}var S,L,E;var M=function(t){babelHelpers.inherits(e,t);function e(t){var n;babelHelpers.classCallCheck(this,e);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));n.currentName=n.getName();n.marker=new C({dispatcher:n.getDot(),receiver:n.getHeader(),point:n.getDot(),container:n.getData().appContainer,intermediateXPoints:function t(){return n.getIntermediateXPoints()},name:"".concat(n.getData().categoryName," (").concat(n.getName(),")"),data:{column:babelHelpers.assertThisInitialized(n)}});n.marker.subscribe("Marker:dragStart",n.onMarkerDragStart.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:receiver:dragOver",n.onMarkerDragOver.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:receiver:dragOut",n.onMarkerDragOut.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:dragEnd",n.onMarkerDragEnd.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:linkFrom",n.onMarkerLinkFrom.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:stubLinkFrom",n.onMarkerStubLinkFrom.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:linkTo",n.onMarkerLinkTo.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:stubLinkTo",n.onMarkerStubLinkTo.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:removeLinkFrom",n.onRemoveLinkFrom.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:changeRobotAction",n.onChangeRobotAction.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:editLink",n.onEditLink.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:unlink",n.onMarkerUnlink.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:unlinkStub",n.onMarkerUnlinkStub.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:error",n.onMarkerError.bind(babelHelpers.assertThisInitialized(n)));n.onTransitionStart=n.onTransitionStart.bind(babelHelpers.assertThisInitialized(n));n.onTransitionEnd=n.onTransitionEnd.bind(babelHelpers.assertThisInitialized(n));return n}babelHelpers.createClass(e,[{key:"isAllowedTransitionProperty",value:function t(e){return["width","min-width","max-width","transform"].includes(e)}},{key:"onTransitionStart",value:function t(e){if(e.srcElement===this.getContainer()&&this.isAllowedTransitionProperty(e.propertyName)){clearInterval(this.intervalId);this.intervalId=setInterval(C.adjustLinks,16)}}},{key:"onTransitionEnd",value:function t(e){if(e.srcElement===this.getContainer()&&this.isAllowedTransitionProperty(e.propertyName)){clearInterval(this.intervalId);this.intervalId=null}}},{key:"setOptions",value:function t(n){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"setOptions",this).call(this,n);if(o.Type.isFunction(n.data.onLink)){this.onLinkHandler=n.data.onLink}if(o.Type.isFunction(n.data.onRemoveLinkFrom)){this.onRemoveLinkFromHandler=n.data.onRemoveLinkFrom}if(o.Type.isFunction(n.data.onChangeRobotAction)){this.onChangeRobotAction=n.data.onChangeRobotAction}if(o.Type.isFunction(n.data.onEditLink)){this.onEditLinkhandler=n.data.onEditLink}if(o.Type.isFunction(n.data.onNameChange)){this.onNameChangeHandler=n.data.onNameChange}if(o.Type.isFunction(n.data.onColorChange)){this.onColorChangeHandler=n.data.onColorChange}if(o.Type.isFunction(n.data.onAddColumn)){this.onAddColumnHandler=n.data.onAddColumn}if(o.Type.isFunction(n.data.onRemove)){this.onRemoveHandler=n.data.onRemove}if(o.Type.isFunction(n.data.onChange)){this.onChangeHandler=n.data.onChange}if(o.Type.isFunction(n.data.onError)){this.onErrorHandler=n.data.onError}if(this.marker){this.marker.container=this.getData().appContainer;if(o.Type.isFunction(this.marker.cache.clear)){this.marker.cache.clear()}}}},{key:"onMarkerError",value:function t(e){this.onErrorHandler(e.data)}},{key:"onEditLink",value:function t(e){this.onEditLinkhandler(e.data)}},{key:"onMarkerLinkFrom",value:function t(e){this.onLinkHandler(e.data);this.activateDot()}},{key:"onMarkerStubLinkFrom",value:function t(){this.activateStubDot()}},{key:"onMarkerStubLinkTo",value:function t(){this.activateStubDot()}},{key:"onRemoveLinkFrom",value:function t(e){this.onRemoveLinkFromHandler(e.data)}},{key:"onMarkerLinkTo",value:function t(){this.activateDot()}},{key:"getIntermediateXPoints",value:function t(){var e=this.getData().stagesGroups,n=e.progressStagesGroup,a=e.successStagesGroup,r=e.failStagesGroup;var o=n.getBoundingClientRect();var i=a.getBoundingClientRect();var s=r.getBoundingClientRect();var l=15;return[o.left+l,i.left-l,i.left+l,i.right-l,i.right+l,s.right-l/2]}},{key:"onMarkerDragStart",value:function t(){this.activateDot()}},{key:"onMarkerDragOver",value:function t(e){if(k(e)||T(e)){e.preventDefault();this.disallowDot();return}this.allowDot();this.highlightDot()}},{key:"onMarkerDragOut",value:function t(){this.allowDot();this.unhighlightDot()}},{key:"onMarkerDragEnd",value:function t(e){if(!this.marker.isLinked()){this.deactivateDot()}if(e.data.from&&e.data.to){if(k(e)||T(e)){e.preventDefault()}}}},{key:"onMarkerUnlink",value:function t(){this.deactivateDot();this.deactivateStubDot()}},{key:"onMarkerUnlinkStub",value:function t(){this.deactivateStubDot()}},{key:"activateDot",value:function t(){o.Dom.addClass(this.getDot(),"crm-st-kanban-column-dot-active")}},{key:"deactivateDot",value:function t(){o.Dom.removeClass(this.getDot(),"crm-st-kanban-column-dot-active")}},{key:"activateStubDot",value:function t(){o.Dom.addClass(this.getDot(),"crm-st-kanban-column-dot-active-stub")}},{key:"deactivateStubDot",value:function t(){o.Dom.removeClass(this.getDot(),"crm-st-kanban-column-dot-active-stub")}},{key:"highlightDot",value:function t(){o.Dom.addClass(this.getDot(),"crm-st-kanban-column-dot-highlight")}},{key:"unhighlightDot",value:function t(){o.Dom.removeClass(this.getDot(),"crm-st-kanban-column-dot-highlight")}},{key:"allowDot",value:function t(){o.Dom.removeClass(this.getDot(),"crm-st-kanban-column-dot-disallow")}},{key:"disallowDot",value:function t(){o.Dom.addClass(this.getDot(),"crm-st-kanban-column-dot-disallow")}},{key:"getBody",value:function t(){return s()}},{key:"getDot",value:function t(){if(!o.Type.isDomNode(this.dot)){var e=o.Loc.getMessage("CRM_ST_DOT_TITLE");this.dot=o.Tag.render(S||(S=babelHelpers.taggedTemplateLiteral(['<div class="crm-st-kanban-column-dot" title="','">\n\t\t\t\t<span class="crm-st-kanban-column-dot-disallow-icon"> </span>\n\t\t\t\t<span class="crm-st-kanban-column-dot-pulse"> </span>\n\t\t\t</div>'])),e)}return this.dot}},{key:"getHeader",value:function t(){var n=babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"getHeader",this).call(this);if(!this.headerDotted){this.headerDotted=true;var a=this.getDot();o.Event.bind(a,"mousedown",(function(t){return t.stopPropagation()}));o.Event.bind(a,"mouseup",(function(t){return t.stopPropagation()}));o.Event.bind(a,"mousemove",(function(t){return t.stopPropagation()}));o.Dom.append(a,n)}o.Tag.attrs(n)(L||(L=babelHelpers.taggedTemplateLiteral(["\n\t\t\ttitle: ",";\n\t\t"])),this.getName());return n}},{key:"getSubTitle",value:function t(){return s()}},{key:"getContainer",value:function t(){var n=babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"getContainer",this).call(this);o.Dom.addClass(n,"crm-st-kanban-column");o.Event.bind(n,"transitionstart",this.onTransitionStart);o.Event.bind(n,"transitionend",this.onTransitionEnd);return n}},{key:"getTotalItem",value:function t(){this.layout.total=s();return this.layout.total}},{key:"handleTextBoxBlur",value:function t(n){var a=this;babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"handleTextBoxBlur",this).call(this,n);setTimeout((function(){if(a.currentName!==a.getName()){a.onNameChangeHandler(a);a.currentName=a.getName();o.Tag.attrs(a.getHeader())(E||(E=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t\ttitle: ",";\n\t\t\t\t"])),a.getName())}}),500)}},{key:"onColorSelected",value:function t(n){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"onColorSelected",this).call(this,n);this.onColorChangeHandler(this)}},{key:"handleAddColumnButtonClick",value:function t(e){this.onAddColumnHandler(this)}},{key:"handleRemoveButtonClick",value:function t(n){this.getConfirmDialog().setContent(o.Loc.getMessage("CRM_ST_CONFIRM_STAGE_REMOVE_TEXT"));babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"handleRemoveButtonClick",this).call(this,n)}},{key:"handleConfirmButtonClick",value:function t(){var n=this;var a=new o.Event.BaseEvent({data:{column:this,onConfirm:function t(){C.getAllLinks().forEach((function(t){if(String(t.to.data.column.id)===String(n.id)){t.from.removeLink(t)}if(String(t.from.data.column.id)===String(n.id)){t.from.removeLink(t)}}));babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"handleConfirmButtonClick",n).call(n);setTimeout((function(){C.removeAllLinks();C.restoreAllLinks()}))},onCancel:function t(){n.getConfirmDialog().close()}}});this.onRemoveHandler(a)}},{key:"switchToEditMode",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"switchToEditMode",this).call(this)}},{key:"applyEditMode",value:function t(){var n=BX.util.trim(this.getTitleTextBox().value);var a=this.colorChanged;var r=false;if(n.length>0&&this.getName()!==n){r=true}babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"applyEditMode",this).call(this);if(r||a){this.onChangeHandler(this)}C.adjustLinks()}},{key:"onColumnDrag",value:function t(n,a){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"onColumnDrag",this).call(this,n,a);C.adjustLinks()}},{key:"resetRectArea",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"resetRectArea",this).call(this);clearTimeout(this.resetRectAreaTimeoutId);this.resetRectAreaTimeoutId=setTimeout((function(){C.adjustLinks()}),200)}}]);return e}(n.Kanban.Column);var A=function(t){babelHelpers.inherits(e,t);function e(){var t;var n;babelHelpers.classCallCheck(this,e);for(var a=arguments.length,r=new Array(a),i=0;i<a;i++){r[i]=arguments[i]}n=babelHelpers.possibleConstructorReturn(this,(t=babelHelpers.getPrototypeOf(e)).call.apply(t,[this].concat(r)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"emitter",new o.Event.EventEmitter);return n}babelHelpers.createClass(e,[{key:"adjustLayout",value:function t(){}},{key:"adjustHeight",value:function t(){}},{key:"getEmptyStub",value:function t(){return s()}},{key:"getDropZoneArea",value:function t(){var n=babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"getDropZoneArea",this).call(this);o.Dom.addClass(n.getContainer(),"crm-st-kanban-stub");return n}},{key:"getGridContainer",value:function t(){var n=babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"getGridContainer",this).call(this);o.Dom.addClass(n,"crm-st-kanban-grid");return n}},{key:"getInnerContainer",value:function t(){var n=babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"getInnerContainer",this).call(this);o.Dom.addClass(n,"crm-st-kanban-inner");return n}},{key:"getOuterContainer",value:function t(){var n=babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"getOuterContainer",this).call(this);o.Dom.addClass(n,"crm-st-kanban");return n}},{key:"getLeftEar",value:function t(){return s()}},{key:"getRightEar",value:function t(){return s()}},{key:"onColumnDragStart",value:function t(n){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"onColumnDragStart",this).call(this,n);C.adjustLinks()}},{key:"onColumnDragStop",value:function t(n){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"onColumnDragStop",this).call(this,n);this.emitter.emit("Kanban.Grid:columns:sort");setTimeout((function(){C.adjustLinks()}));this.getColumns().forEach((function(t){clearInterval(t.intervalId)}))}},{key:"getColumns",value:function t(){this.columnsOrder.sort((function(t,e){if(t.getContainer().parentNode){var n=babelHelpers.toConsumableArray(t.getContainer().parentNode.children).indexOf(t.getContainer());var a=babelHelpers.toConsumableArray(e.getContainer().parentNode.children).indexOf(e.getContainer());return n>a?1:-1}}));return this.columnsOrder}}]);return e}(n.Kanban.Grid);var R,I,D,H,_,B,O,w,N,P,x,G,U,F,X,z,K,j,Y,W,V,q,Z,J,Q,$,tt,et,nt,at,rt;var ot=function(t){babelHelpers.inherits(e,t);babelHelpers.createClass(e,null,[{key:"createGrid",value:function t(e){return new A({renderTo:e.renderTo,canEditColumn:e.editable===true,canRemoveColumn:e.editable===true,canAddColumn:e.editable===true,canSortColumn:e.editable===true,columnType:e.columnType||"BX.Crm.SalesTunnels.Kanban.Column",dropzoneType:"BX.Crm.SalesTunnels.Kanban.DropZone",columns:e.columns})}}]);function e(t){var n;babelHelpers.classCallCheck(this,e);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));e.instances.push(babelHelpers.assertThisInitialized(n));n.renderTo=t.renderTo;n.appContainer=t.appContainer;n.id=t.id;n.name=t.name;n.access=t.access;n.sort=Number.parseInt(t.sort);n["default"]=Boolean(t["default"]);n.generatorsCount=Number(t.generatorsCount);n.generatorsListUrl=t.generatorsListUrl;n.stages=t.stages;n.robotsSettingsLink=t.robotsSettingsLink.replace("{category}",n.id);n.generatorSettingsLink=t.generatorSettingsLink;n.permissionEditLink=t.permissionEditLink.replace("{category}",n.id);n.cache=new o.Cache.MemoryCache;n.drawed=false;n.allowWrite=Boolean(t.allowWrite);n.isCategoryEditable=Boolean(t.isCategoryEditable);n.areStagesEditable=Boolean(t.areStagesEditable);n.isAvailableGenerator=t.isAvailableGenerator;n.isAutomationEnabled=t.isAutomationEnabled;n.isStagesEnabled=t.isStagesEnabled;if(!t.lazy){n.draw()}if(n.generatorsCount>0){n.showGeneratorLinkIcon()}var a=n.getDragButton();a.onbxdragstart=n.onDragStart.bind(babelHelpers.assertThisInitialized(n));a.onbxdrag=n.onDrag.bind(babelHelpers.assertThisInitialized(n));a.onbxdragstop=n.onDragStop.bind(babelHelpers.assertThisInitialized(n));jsDD.registerObject(a,40);n.adjustRobotsLinkIcon();n.getProgressKanban().emitter.subscribe("Kanban.Grid:removeColumn",(function(t){n.emit("Category:removeStage",t)})).subscribe("Kanban.Grid:columns:sort",(function(){setTimeout((function(){n.emit("Column:sort",{columns:n.getAllColumns()})}),500)}));n.getSuccessKanban().emitter.subscribe("Kanban.Grid:removeColumn",(function(t){n.emit("Category:removeStage",t)})).subscribe("Kanban.Grid:columns:sort",(function(){setTimeout((function(){n.emit("Column:sort",{columns:n.getAllColumns()})}),500)}));n.getFailKanban().emitter.subscribe("Kanban.Grid:removeColumn",(function(t){n.emit("Category:removeStage",t)})).subscribe("Kanban.Grid:columns:sort",(function(){setTimeout((function(){n.emit("Column:sort",{columns:n.getAllColumns()})}),500)}));if(!n.isCategoryEditable){o.Dom.addClass(n.getContainer(),"crm-st-category-editing-disabled")}if(!n.isAutomationEnabled){o.Dom.addClass(n.getContainer(),"crm-st-category-automation-disabled");n.getAllColumns().forEach((function(t){t.marker.disable()}))}if(!n.isStagesEnabled){o.Dom.addClass(n.getContainer(),"crm-st-category-stages-stub")}if(!n.isAvailableGenerator){o.Dom.addClass(n.getContainer(),"crm-st-category-generator-disabled")}return n}babelHelpers.createClass(e,[{key:"hasTunnels",value:function t(){if(!this.isAutomationEnabled){return false}return this.getAllColumns().some((function(t){return t.marker.links.size>0}))}},{key:"getRectArea",value:function t(){var e=this;return this.cache.remember("rectArea",(function(){var t=o.pos(e.getContainer());t.middle=t.top+t.height/2;return t}))}},{key:"getIndex",value:function t(){var e=this;return babelHelpers.toConsumableArray(this.getContainer().parentNode.querySelectorAll(".crm-st-category")).findIndex((function(t){return t===e.getContainer()}))}},{key:"getNextCategorySibling",value:function t(){var n=this;return e.instances.find((function(t,e){return e>n.getIndex()}))||null}},{key:"onDragStart",value:function t(){o.Dom.addClass(this.getContainer(),"crm-st-category-drag");C.removeAllLinks();this.dragOffset=jsDD.start_y-this.getRectArea().top;this.dragIndex=this.getIndex();this.dragTargetCategory=this.dragTargetCategory||this}},{key:"onDrag",value:function t(n,a){var r=this;o.Tag.style(this.getContainer())(R||(R=babelHelpers.taggedTemplateLiteral(["\n\t\t\ttransform: translate3d(0px, ","px, 0px);\n\t\t"])),a-this.dragOffset-this.getRectArea().top);var i=this.getRectArea().height;e.instances.forEach((function(t,e){if(t===r||o.Dom.hasClass(t.getContainer(),"crm-st-category-stub")){return}var n=t.getContainer();var s=t.getRectArea();var l=s.middle;if(a>l&&e>r.dragIndex&&n.style.transform!=="translate3d(0px, ".concat(-i,"px, 0px)")){o.Tag.style(n)(I||(I=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t\ttransition: 200ms;\n\t\t\t\t\ttransform: translate3d(0px, ","px, 0px);\n\t\t\t\t"])),-i);r.dragTargetCategory=t.getNextCategorySibling();t.cache["delete"]("rectArea")}if(a<l&&e<r.dragIndex&&n.style.transform!=="translate3d(0px, ".concat(i,"px, 0px)")){o.Tag.style(n)(D||(D=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t\ttransition: 200ms;\n\t\t\t\t\ttransform: translate3d(0px, ","px, 0px);\n\t\t\t\t"])),i);r.dragTargetCategory=t;t.cache["delete"]("rectArea")}var u=a<l&&e>r.dragIndex&&n.style.transform!==""&&n.style.transform!=="translate3d(0, 0, 0)";var c=a>l&&e<r.dragIndex&&n.style.transform!==""&&n.style.transform!=="translate3d(0, 0, 0)";if(c||u){o.Tag.style(n)(H||(H=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t\ttransition: 200ms;\n\t\t\t\t\ttransform: translate3d(0px, 0px, 0px);\n\t\t\t\t"])));r.dragTargetCategory=t;if(!u&&o.Dom.hasClass(t.getNextCategorySibling(),"crm-st-category-stub")){r.dragTargetCategory=t.getNextCategorySibling()}t.cache["delete"]("rectArea")}}))}},{key:"onDragStop",value:function t(){o.Dom.removeClass(this.getContainer(),"crm-st-category-drag");requestAnimationFrame((function(){C.restoreAllLinks()}));e.instances.forEach((function(t){o.Tag.style(t.getContainer())(_||(_=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\ttransform: null;\n\t\t\t\ttransition: null;\n\t\t\t"])));t.cache["delete"]("rectArea")}));if(this.dragTargetCategory){o.Dom.insertBefore(this.getContainer(),this.dragTargetCategory.getContainer())}else{o.Dom.append(this.getContainer(),this.getContainer().parentElement)}var n=e.instances.map((function(t){return t.getIndex()}));e.instances.sort((function(t,e){return t.getIndex()>e.getIndex()?1:-1}));var a=e.instances.map((function(t){return t.getIndex()}));if(JSON.stringify(n)!==JSON.stringify(a)){this.emit("Category:sort")}}},{key:"getContainer",value:function t(){var e=this;return this.cache.remember("container",(function(){return o.Tag.render(B||(B=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category" data-id="','">\n\t\t\t\t\t<div class="crm-st-category-action">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="crm-st-category-info">\n\t\t\t\t\t\t','\n\t\t\t\t\t\t<div class="crm-st-category-info-links">\n\t\t\t\t\t\t\t<div class="crm-st-category-info-links-item">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t\t",'\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="crm-st-category-info-links-item">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t\t",'\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="crm-st-category-stages">\n\t\t\t\t\t\t',"\n\t\t\t\t\t\t","\n\t\t\t\t\t\t","\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"])),e.id,e.getDragButton(),e.getTitleContainer(),e.getRobotsLink(),e.getRobotsHelpLink(),e.getGeneratorLink(),e.getGeneratorHelpLink(),e.getProgressContainer(),e.getSuccessContainer(),e.getFailContainer())}))}},{key:"getRobotsHelpLink",value:function t(){return this.cache.remember("robotsHelpLink",(function(){var t=function t(){if(window.top.BX.Helper){window.top.BX.Helper.show("redirect=detail&code=6908975")}};return o.Tag.render(O||(O=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span \n\t\t\t\t\tclass="crm-st-category-info-links-help crm-st-automation" \n\t\t\t\t\tonclick="','"\n\t\t\t\t\ttitle="','"\n\t\t\t\t\t> </span>\n\t\t\t'])),t,o.Text.encode(o.Loc.getMessage("CRM_ST_ROBOTS_HELP_BUTTON")))}))}},{key:"getGeneratorHelpLink",value:function t(){return this.cache.remember("generatorHelpLink",(function(){var t=function t(){if(window.top.BX.Helper){window.top.BX.Helper.show("redirect=detail&code=7530721")}};return o.Tag.render(w||(w=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span \n\t\t\t\t\tclass="crm-st-category-info-links-help crm-st-generator" \n\t\t\t\t\tonclick="','"\n\t\t\t\t\ttitle="','"\n\t\t\t\t\t> </span>\n\t\t\t'])),t,o.Text.encode(o.Loc.getMessage("CRM_ST_GENERATOR_HELP_BUTTON")))}))}},{key:"getProgressContainer",value:function t(){var e=this;return this.cache.remember("progressContainer",(function(){return o.Tag.render(N||(N=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-stages-group crm-st-category-stages-group-in-progress">\n\t\t\t\t\t<div class="crm-st-category-stages-group-header">\n\t\t\t\t\t\t<span class="crm-st-category-stages-group-header-text">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"])),o.Loc.getMessage(e.isStagesEnabled?"CRM_ST_STAGES_GROUP_IN_PROGRESS":"CRM_ST_STAGES_DISABLED"),e.getProgressStagesContainer())}))}},{key:"getProgressStagesContainer",value:function t(){return this.cache.remember("progressStagesContainer",(function(){return o.Tag.render(P||(P=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-stages-list"></div>\n\t\t\t'])))}))}},{key:"getProgressKanban",value:function t(){var n=this;return this.cache.remember("progressKanban",(function(){return e.createGrid({renderTo:n.getProgressStagesContainer(),editable:n.areStagesEditable,columns:n.stages.P.map((function(t){return new M({id:t.STATUS_ID,name:t.NAME,color:t.COLOR.replace("#",""),data:n.getColumnData(t)})}))})}))}},{key:"getSuccessContainer",value:function t(){var e=this;return this.cache.remember("successContainer",(function(){return o.Tag.render(x||(x=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-stages-group crm-st-category-stages-group-success">\n\t\t\t\t\t<div class="crm-st-category-stages-group-header">\n\t\t\t\t\t\t<span class="crm-st-category-stages-group-in-success"> </span> \n\t\t\t\t\t\t<span class="crm-st-category-stages-group-header-text">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"])),e.isStagesEnabled?o.Loc.getMessage("CRM_ST_STAGES_GROUP_SUCCESS"):"",e.getSuccessStagesContainer())}))}},{key:"getSuccessStagesContainer",value:function t(){return this.cache.remember("successStagesContainer",(function(){return o.Tag.render(G||(G=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-stages-list"></div>\n\t\t\t'])))}))}},{key:"getSuccessKanban",value:function t(){var n=this;return this.cache.remember("successKanban",(function(){return e.createGrid({renderTo:n.getSuccessStagesContainer(),editable:n.areStagesEditable,columns:n.stages.S.map((function(t){return new M({id:t.STATUS_ID,name:t.NAME,color:t.COLOR.replace("#",""),data:n.getColumnData(t),canRemove:false,canSort:false})}))})}))}},{key:"getFailContainer",value:function t(){var e=this;return this.cache.remember("failContainer",(function(){return o.Tag.render(U||(U=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-stages-group crm-st-category-stages-group-fail">\n\t\t\t\t\t<div class="crm-st-category-stages-group-header">\n\t\t\t\t\t\t<span class="crm-st-category-stages-group-in-fail"> </span> \n\t\t\t\t\t\t<span class="crm-st-category-stages-group-header-text">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"])),e.isStagesEnabled?o.Loc.getMessage("CRM_ST_STAGES_GROUP_FAIL"):"",e.getFailStagesContainer())}))}},{key:"getFailStagesContainer",value:function t(){return this.cache.remember("failStagesContainer",(function(){return o.Tag.render(F||(F=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-stages-list"></div>\n\t\t\t'])))}))}},{key:"getFailKanban",value:function t(){var n=this;return this.cache.remember("failKanban",(function(){return e.createGrid({renderTo:n.getFailStagesContainer(),editable:n.areStagesEditable,columns:n.stages.F.map((function(t){return new M({id:t.STATUS_ID,name:t.NAME,color:t.COLOR.replace("#",""),data:n.getColumnData(t)})}))})}))}},{key:"getColumnData",value:function t(e){var n=this;return{stageId:e.ID,entityId:e.ENTITY_ID,stage:e,onLink:function t(e){n.emit("Column:link",e);n.adjustRobotsLinkIcon()},onRemoveLinkFrom:function t(e){n.emit("Column:removeLinkFrom",e);n.adjustRobotsLinkIcon()},onChangeRobotAction:function t(e){n.emit("Column:changeRobotAction",e)},onEditLink:function t(e){n.emit("Column:editLink",e);n.adjustRobotsLinkIcon()},onNameChange:function t(e){n.emit("Column:nameChange",{column:e})},onColorChange:function t(e){n.emit("Column:colorChange",{column:e})},onAddColumn:function t(e){n.emit("Column:addColumn",{column:e})},onRemove:function t(e){n.emit("Column:remove",e)},onChange:function t(e){n.emit("Column:change",{column:e})},onSort:function t(){n.emit("Column:sort",{columns:n.getAllColumns()})},onError:function t(e){n.emit("Column:error",e)},category:this,appContainer:this.appContainer,categoryContainer:this.getFailContainer(),stagesGroups:{progressStagesGroup:this.getProgressContainer(),successStagesGroup:this.getSuccessContainer(),failStagesGroup:this.getFailContainer()},currentStageGroup:this.getFailContainer(),categoryName:this.getTitle().innerText,isCategoryEditable:this.isCategoryEditable,areStagesEditable:this.areStagesEditable}}},{key:"onRightsLinkClick",value:function t(e){var n=this;e.preventDefault();BX.SidePanel.Instance.open(this.robotsSettingsLink,{cacheable:false,events:{onClose:function t(){n.emit("Category:slider:close");n.emit("Category:slider:robots:close")}}})}},{key:"getRobotsLink",value:function t(){var e=this;return this.cache.remember("robotsLink",(function(){if(!e.isAutomationEnabled){return"<span></span>"}var t=BX.Crm.Restriction.Bitrix24.isRestricted("automation");var n=t?BX.Crm.Restriction.Bitrix24.getHandler("automation"):e.onRobotsLinkClick.bind(e);return o.Tag.render(X||(X=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t",'\n\t\t\t\t<span class="crm-st-category-info-links-link crm-st-robots-link crm-st-automation" onclick="','">\n\t\t\t\t\t',"\n\t\t\t\t</span>\n\t\t\t"])),t?'<span class="tariff-lock"></span>':"",n,o.Loc.getMessage("CRM_ST_ROBOT_SETTINGS_LINK_LABEL"))}))}},{key:"onRobotsLinkClick",value:function t(e){var n=this;e.preventDefault();BX.SidePanel.Instance.open(this.robotsSettingsLink,{cacheable:false,events:{onClose:function t(){n.emit("Category:slider:close");n.emit("Category:slider:robots:close")}}})}},{key:"getGeneratorLink",value:function t(){var e=this;return this.cache.remember("generatorLink",(function(){if(!e.isAvailableGenerator){return"<span></span>"}var t=BX.Crm.Restriction.Bitrix24.isRestricted("generator");var n=t?BX.Crm.Restriction.Bitrix24.getHandler("generator"):e.onGeneratorLinkClick.bind(e);return o.Tag.render(z||(z=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t",'\n\t\t\t\t<span class="crm-st-category-info-links-link crm-st-generator-link crm-st-generator" onclick="','">\n\t\t\t\t\t',"\n\t\t\t\t</span>\n\t\t\t"])),t?'<span class="tariff-lock"></span>':"",n,o.Loc.getMessage("CRM_ST_GENERATOR_SETTINGS_LINK_LABEL"))}))}},{key:"onGeneratorLinkClick",value:function t(e){var n=this;e.preventDefault();BX.SidePanel.Instance.open(this.generatorSettingsLink,{cacheable:false,events:{onClose:function t(){n.emit("Category:slider:close");n.emit("Category:slider:generator:close",{category:n})}}})}},{key:"getEditButton",value:function t(){var e=this;return this.cache.remember("editButton",(function(){return o.Tag.render(K||(K=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span \n\t\t\t\t\tclass="crm-st-edit-button" \n\t\t\t\t\tonmousedown="','"\n\t\t\t\t\ttitle="','"\n\t\t\t\t\t> </span>\n\t\t\t'])),e.onEditButtonClick.bind(e),o.Loc.getMessage("CRM_ST_EDIT_CATEGORY_TITLE"))}))}},{key:"activateEditButton",value:function t(){o.Dom.addClass(this.getEditButton(),"crm-st-edit-button-active")}},{key:"deactivateEditButton",value:function t(){o.Dom.removeClass(this.getEditButton(),"crm-st-edit-button-active")}},{key:"onEditButtonClick",value:function t(e){if(e){e.preventDefault()}if(this.isTitleEditEnabled()){this.disableTitleEdit();this.saveTitle();return}this.enableTitleEdit()}},{key:"showTitleEditor",value:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var n=this.getTitleEditor();var a=this.getTitle(),r=a.innerText;n.value=o.Type.isString(e)?e:o.Text.decode(r);o.Tag.style(n)(j||(j=babelHelpers.taggedTemplateLiteral(["\n\t\t\tdisplay: block;\n\t\t"])))}},{key:"hideTitleEditor",value:function t(){var e=this.getTitleEditor();o.Tag.style(e)(Y||(Y=babelHelpers.taggedTemplateLiteral(["\n\t\t\tdisplay: null;\n\t\t"])))}},{key:"focusOnTitleEditor",value:function t(){var e=this.getTitleEditor();e.focus();var n=this.getTitle();e.setSelectionRange(a,a);var a=n.innerText.length}},{key:"showTitle",value:function t(){o.Tag.style(this.getTitle())(W||(W=babelHelpers.taggedTemplateLiteral(["\n\t\t\tdisplay: null;\n\t\t"])))}},{key:"hideTitle",value:function t(){o.Tag.style(this.getTitle())(V||(V=babelHelpers.taggedTemplateLiteral(["\n\t\t\tdisplay: none;\n\t\t"])))}},{key:"saveTitle",value:function t(){var e=this.getTitle();var n=this.getTitleEditor();var a=n.value;var r=a.trim()||o.Loc.getMessage("CRM_ST_TITLE_EDITOR_PLACEHOLDER2");if(e.innerText!==r){e.innerText=r;o.Dom.attr(e,"title",r);this.name=r;this.emit("Category:title:save",{categoryId:this.id,value:r})}}},{key:"enableTitleEdit",value:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.hideTitle();this.showTitleEditor(e);this.activateEditButton();this.focusOnTitleEditor()}},{key:"disableTitleEdit",value:function t(){this.showTitle();this.hideTitleEditor();this.deactivateEditButton()}},{key:"isTitleEditEnabled",value:function t(){return o.Dom.hasClass(this.getEditButton(),"crm-st-edit-button-active")}},{key:"getOptionButton",value:function t(){var e=this;return this.cache.remember("optionButton",(function(){var t=o.Tag.render(q||(q=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span \n\t\t\t\t\tclass="crm-st-option-button" \n\t\t\t\t\tonclick="','" \n\t\t\t\t\ttitle="','"\n\t\t\t\t\t> </span>\n\t\t\t'])),e.onOptionButtonClick.bind(e),o.Loc.getMessage("CRM_ST_EDIT_RIGHTS_CATEGORY"));return t}))}},{key:"onOptionButtonClick",value:function t(){var n=this;var a=function t(e,a){n.emit("Category:access",{categoryId:n.id,access:a.dataset["access"],onConfirm:function t(){},onCancel:function t(){}});o.Dom.addClass(a.getContainer(),"menu-popup-item-accept");o.Dom.removeClass(a.getContainer(),"menu-popup-no-icon");n.access=a.dataset["access"];n.menuWindow.getMenuItems().forEach((function(t){if(t===a){return}o.Dom.removeClass(t.getContainer(),"menu-popup-item-accept");o.Dom.addClass(t.getContainer(),"menu-popup-no-icon")}));n.menuWindow.close()};var i=function t(e,a){n.emit("Category:access:copy",{categoryId:n.id,donorCategoryId:a.dataset["categoryId"],onConfirm:function t(){},onCancel:function t(){}});n.access=a.dataset["access"];n.menuWindow.getMenuItems().forEach((function(t){if(t.dataset===null){return}if(n.access===t.dataset["access"]){o.Dom.addClass(t.getContainer(),"menu-popup-item-accept");o.Dom.removeClass(t.getContainer(),"menu-popup-no-icon")}else{o.Dom.removeClass(t.getContainer(),"menu-popup-item-accept");o.Dom.addClass(t.getContainer(),"menu-popup-no-icon")}}));n.menuWindow.close()};var s=e.instances.filter((function(t){return n.id!==t.id&&t.id!=="stub"})).map((function(t){return{text:o.Text.encode(t.name),dataset:{categoryId:t.id,access:t.access},onclick:i}}));this.menuWindow=new r.Menu({id:"crm-tunnels-menu-".concat(o.Text.getRandom().toLowerCase()),bindElement:this.getOptionButton(),items:[{text:o.Loc.getMessage("CRM_MENU_RIGHTS_CATEGORY_ALL_FOR_ALL"),dataset:{access:"X"}},{text:o.Loc.getMessage("CRM_MENU_RIGHTS_CATEGORY_NONE_FOR_ALL"),dataset:{access:""}},{text:o.Loc.getMessage("CRM_MENU_RIGHTS_CATEGORY_OWN_FOR_ALL"),dataset:{access:"A"}},s.length>0?{text:o.Loc.getMessage("CRM_MENU_RIGHTS_CATEGORY_COPY_FROM_TUNNELS2"),items:s}:null,{delimiter:true},{text:o.Loc.getMessage("CRM_MENU_RIGHTS_CATEGORY_CUSTOM"),dataset:{access:false},className:this.access!=="A"&&this.access!=="X"&&this.access!==""?"menu-popup-item-accept":"",href:this.permissionEditLink,target:"_blank",onclick:function t(e,n){n.getMenuWindow().close()}}].filter((function(t){return t!==null})).map((function(t){if(t.dataset){if(n.access===t.dataset.access){t.className="menu-popup-item-accept"}if(!t.onclick){t.onclick=a}}return t})),events:{onClose:function(){o.Dom.removeClass(this.getOptionButton(),"crm-st-option-button-active");o.Dom.removeClass(this.getActionsButtons(),"crm-st-category-action-buttons-active");setTimeout(this.removeBlur.bind(this),200)}.bind(this)},angle:true,offsetLeft:9});o.Dom.addClass(this.getActionsButtons(),"crm-st-category-action-buttons-active");o.Dom.addClass(this.getOptionButton(),"crm-st-option-button-active");this.menuWindow.show();this.addBlur()}},{key:"getRemoveButton",value:function t(){var e=this;return this.cache.remember("removeButton",(function(){var t=o.Tag.render(Z||(Z=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span \n\t\t\t\t\tclass="crm-st-remove-button" \n\t\t\t\t\tonclick="','" \n\t\t\t\t\ttitle="','"\n\t\t\t\t\t> </span>\n\t\t\t'])),e.onRemoveButtonClick.bind(e),o.Loc.getMessage("CRM_ST_REMOVE_CATEGORY2"));if(e["default"]){o.Tag.style(t)(J||(J=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t\tdisplay: none;\n\t\t\t\t"])))}return t}))}},{key:"onRemoveButtonClick",value:function t(){var e=this;this.showConfirmRemovePopup().then((function(t){var n=t.confirm;if(n){e.emit("Category:remove",{categoryId:e.id,onConfirm:function t(){e.remove()},onCancel:function t(){e.removeBlur()}});return}e.removeBlur()}));this.addBlur()}},{key:"getAllColumns",value:function t(){var e=this.getProgressKanban().getColumns().sort((function(t,e){return t.getIndex()>e.getIndex()?1:-1}));var n=this.getSuccessKanban().getColumns().sort((function(t,e){return t.getIndex()>e.getIndex()?1:-1}));var a=this.getFailKanban().getColumns().sort((function(t,e){return t.getIndex()>e.getIndex()?1:-1}));return[].concat(babelHelpers.toConsumableArray(e),babelHelpers.toConsumableArray(n),babelHelpers.toConsumableArray(a))}},{key:"addBlur",value:function t(){o.Dom.addClass(this.getContainer(),"crm-st-blur");this.getAllColumns().forEach((function(t){t.marker.blurLinks()}))}},{key:"removeBlur",value:function t(){o.Dom.removeClass(this.getContainer(),"crm-st-blur");C.unblurLinks()}},{key:"remove",value:function t(){var n=this;o.Dom.remove(this.getContainer());C.getAllLinks().forEach((function(t){var e=t.from.data.column;var a=e.getData().category;var r=t.to.data.column;var o=r.getData().category;if(String(a.id)===String(n.id)){t.from.removeLink(t)}if(String(o.id)===String(n.id)){t.to.removeLink(t)}}));C.getAllStubLinks().forEach((function(t){var e=t.from.data.column;var a=e.getData().category;var r=t.to.data.column;var o=r.getData().category;if(String(a.id)===String(n.id)){t.from.removeStubLink(t)}if(String(o.id)===String(n.id)){t.to.removeStubLink(t)}}));e.instances=e.instances.filter((function(t){return t!==n}))}},{key:"getTitle",value:function t(){var e=o.Text.encode(this.name);return this.cache.remember("title",(function(){return o.Tag.render(Q||(Q=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<h3 class="crm-st-category-info-title" title="','">',"</h3>\n\t\t\t"])),e,e)}))}},{key:"getTitleEditor",value:function t(){var e=this;return this.cache.remember("titleEditor",(function(){var t=e.onTitleEditorKeyDown.bind(e);var n=e.onTitleEditorBlur.bind(e);return o.Tag.render($||($=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input class="crm-st-category-info-title-editor" \n\t\t\t\t\t onkeydown="','"\n\t\t\t\t\t onblur="','"\n\t\t\t\t\t value="','"\n\t\t\t\t\t placeholder="','"\n\t\t\t\t >\n\t\t\t'])),t,n,o.Text.encode(e.name),o.Loc.getMessage("CRM_ST_TITLE_EDITOR_PLACEHOLDER2"))}))}},{key:"onTitleEditorKeyDown",value:function t(e){e.stopPropagation();if(this.isTitleEditEnabled()){if(e.key.startsWith("Enter")){this.onEditButtonClick()}if(e.key.startsWith("Esc")){this.disableTitleEdit()}}}},{key:"onTitleEditorBlur",value:function t(){if(this.isTitleEditEnabled()){this.onEditButtonClick()}}},{key:"getActionsButtons",value:function t(){var e=this;return this.cache.remember("getActionsButtons",(function(){return o.Tag.render(tt||(tt=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-action-buttons">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"])),e.isCategoryEditable?e.getEditButton():"",e.isCategoryEditable?e.getOptionButton():"",e.isCategoryEditable?e.getRemoveButton():"")}))}},{key:"getTitleContainer",value:function t(){var e=this;return this.cache.remember("titleContainer",(function(){return o.Tag.render(et||(et=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-info-title-container">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"])),e.getTitle(),e.getTitleEditor(),e.getActionsButtons())}))}},{key:"getDragButton",value:function t(){return this.cache.remember("dragButton",(function(){return o.Tag.render(nt||(nt=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span \n\t\t\t\t\tclass="crm-st-category-action-drag"\n\t\t\t\t\ttitle="','"\n\t\t\t\t\t>&nbsp;</span>\n\t\t\t'])),o.Loc.getMessage("CRM_ST_CATEGORY_DRAG_BUTTON2"))}))}},{key:"isDrawed",value:function t(){return this.drawed}},{key:"draw",value:function t(){if(!this.isDrawed()){this.drawed=true;o.Dom.append(this.getContainer(),this.renderTo);this.getProgressKanban().draw();this.getSuccessKanban().draw();this.getFailKanban().draw()}}},{key:"getKanbanColumn",value:function t(e){var n=[].concat(babelHelpers.toConsumableArray(this.getProgressKanban().getColumns()),babelHelpers.toConsumableArray(this.getSuccessKanban().getColumns()),babelHelpers.toConsumableArray(this.getFailKanban().getColumns()));return n.find((function(t){return e===t.getId()||e===t.getData().statusId}))}},{key:"showConfirmRemovePopup",value:function t(){var e=this;return new Promise((function(t){void new r.PopupWindow({width:400,overlay:{opacity:30},titleBar:o.Loc.getMessage("CRM_ST_REMOVE_CATEGORY_CONFIRM_POPUP_TITLE2").replace("#name#",e.getTitle().innerText),content:o.Loc.getMessage("CRM_ST_REMOVE_CATEGORY_CONFIRM_POPUP_DESCRIPTION2"),buttons:[new r.PopupWindowButton({text:o.Loc.getMessage("CRM_ST_REMOVE_CATEGORY_CONFIRM_REMOVE_BUTTON_LABEL2"),className:"popup-window-button-decline",events:{click:function e(){t({confirm:true});this.popupWindow.destroy()}}}),new r.PopupWindowButtonLink({text:o.Loc.getMessage("CRM_ST_REMOVE_CATEGORY_CONFIRM_CANCEL_BUTTON_LABEL"),events:{click:function e(){t({confirm:false});this.popupWindow.destroy()}}})]}).show()}))}},{key:"getRobotsLinkIcon",value:function t(){return this.cache.remember("robotsLinkIcon",(function(){return o.Tag.render(at||(at=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span class="crm-st-robots-link-icon"> </span>\n\t\t\t'])))}))}},{key:"showRobotsLinkIcon",value:function t(){o.Dom.insertAfter(this.getRobotsLinkIcon(),this.getRobotsLink())}},{key:"hideRobotsLinkIcon",value:function t(){o.Dom.remove(this.getRobotsLinkIcon())}},{key:"adjustRobotsLinkIcon",value:function t(){var e=this;setTimeout((function(){if(e.hasTunnels()){e.showRobotsLinkIcon();return}e.hideRobotsLinkIcon()}))}},{key:"getGeneratorLinkIcon",value:function t(){var e=this;return this.cache.remember("generatorLinkIcon",(function(){var t=function t(){return BX.SidePanel.Instance.open(e.generatorsListUrl)};return o.Tag.render(rt||(rt=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span class="crm-st-generator-link-icon" onclick="','">',"</span>\n\t\t\t"])),t,e.generatorsCount)}))}},{key:"showGeneratorLinkIcon",value:function t(){o.Dom.insertAfter(this.getGeneratorLinkIcon(),this.getGeneratorLink())}}]);return e}(o.Event.EventEmitter);babelHelpers.defineProperty(ot,"instances",[]);var it=function(){function t(){babelHelpers.classCallCheck(this,t)}babelHelpers.createClass(t,null,[{key:"request",value:function e(n){var a=n.action,r=n.data,i=n.analyticsLabel;return new Promise((function(e,n){o.ajax.runComponentAction(t.component,a,{mode:"class",data:{data:r,entityTypeId:t.entityTypeId},analyticsLabel:i}).then(e,n)}))}},{key:"createCategory",value:function e(n){return t.request({action:"createCategory",analyticsLabel:{component:t.component,action:"create.new.category"},data:n})}},{key:"getCategory",value:function e(n){return t.request({action:"getCategory",analyticsLabel:{component:t.component,action:"get.category"},data:n})}},{key:"updateCategory",value:function e(n){return t.request({action:"updateCategory",analyticsLabel:{component:t.component,action:"update.category"},data:n})}},{key:"removeCategory",value:function e(n){return t.request({action:"removeCategory",analyticsLabel:{component:t.component,action:"remove.category"},data:n})}},{key:"accessCategory",value:function e(n){return t.request({action:"accessCategory",analyticsLabel:{component:t.component,action:"access.category"},data:n})}},{key:"copyAccessCategory",value:function e(n){return t.request({action:"copyAccessCategory",analyticsLabel:{component:t.component,action:"access.category"},data:n})}},{key:"createRobot",value:function e(n){return t.request({action:"createRobot",analyticsLabel:{component:t.component,action:"create.robot"},data:n})}},{key:"removeRobot",value:function e(n){return t.request({action:"removeRobot",analyticsLabel:{component:t.component,action:"remove.robot"},data:n})}},{key:"getRobotSettingsDialog",value:function e(n){return t.request({action:"getRobotSettingsDialog",analyticsLabel:{component:t.component,action:"settings.robot"},data:n})}},{key:"addStage",value:function e(n){return t.request({action:"addStage",analyticsLabel:{component:t.component,action:"add.stage"},data:n})}},{key:"removeStage",value:function e(n){return t.request({action:"removeStage",analyticsLabel:{component:t.component,action:"remove.stage"},data:n})}},{key:"updateStage",value:function e(n){return t.request({action:"updateStage",analyticsLabel:{component:t.component,action:"update.stage"},data:n})}},{key:"updateStages",value:function e(n){return t.request({action:"updateStages",analyticsLabel:{component:t.component,action:"update.stages"},data:n})}},{key:"getCategories",value:function e(){return t.request({action:"getCategories",analyticsLabel:{component:t.component,action:"get.categories"}})}}]);return t}();babelHelpers.defineProperty(it,"component","bitrix:crm.sales.tunnels");babelHelpers.defineProperty(it,"entityTypeId",2);var st=function(t){babelHelpers.inherits(e,t);function e(t){var n;babelHelpers.classCallCheck(this,e);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));o.Dom.addClass(n.getContainer(),"crm-st-category-stub");o.Dom.removeClass(n.getContainer(),"crm-st-category-automation-disabled");n.getAllColumns().forEach((function(t){t.marker.disable()}));return n}return e}(ot);function lt(t){return Array.from({length:t}).map((function(t,e){return{STATUS_ID:"stub_".concat(e),COLOR:"F1F5F7",NAME:"category stub"}}))}function ut(t){if(t.data&&t.data.errors&&o.Type.isArray(t.data.errors)&&t.data.errors.length>0){return t.data.errors.reduce((function(t,e){return"".concat(t).concat(o.Text.encode(e),"<br>")}),"")}if(t.errors&&o.Type.isArray(t.errors)&&t.errors.length>0){return t.errors.reduce((function(t,e){return"".concat(t).concat(o.Text.encode(e.message?e.message:e),"<br>")}),"")}return o.Loc.getMessage("CRM_ST_SAVE_ERROR2")}var ct=function(){function t(e){var n=this;babelHelpers.classCallCheck(this,t);this.container=e.container;this.entityTypeId=e.entityTypeId;this.documentType=e.documentType;this.addCategoryButtonTop=e.addCategoryButtonTop;this.helpButton=e.helpButton;this.categoriesOptions=e.categories;this.robotsUrl=e.robotsUrl;this.generatorUrl=e.generatorUrl;this.permissionEditUrl=e.permissionEditUrl;this.tunnelScheme=e.tunnelScheme;this.isCategoryEditable=Boolean(e.isCategoryEditable);this.isCategoryCreatable=Boolean(e.isCategoryCreatable);this.areStagesEditable=Boolean(e.areStagesEditable);this.isAvailableGenerator=e.isAvailableGenerator;this.isStagesEnabled=e.isStagesEnabled;this.isAutomationEnabled=e.isAutomationEnabled&&this.isStagesEnabled;this.categories=new Map;this.cache=new o.Cache.MemoryCache;this.isChanged=false;this.initCategories();this.initTunnels();it.entityTypeId=this.entityTypeId;if(this.isCategoryCreatable){setTimeout((function(){if(!n.hasTunnels()){n.showCategoryStub()}}))}o.Event.bind(this.getAddCategoryButton(),"click",this.onAddCategoryClick.bind(this));o.Event.bind(this.addCategoryButtonTop,"click",this.onAddCategoryTopClick.bind(this));o.Event.bind(this.helpButton,"click",this.onHelpButtonClick.bind(this));var a=o.Reflection.getClass("top.BX.Crm.ToolbarComponent")?o.Reflection.getClass("top.BX.Crm.ToolbarComponent").Instance:null;var r=this.getSlider();if(r&&a){o.Event.EventEmitter.subscribe("SidePanel.Slider:onClose",(function(){if(n.isChanged){a.emitCategoriesUpdatedEvent()}}))}this.constructor.lastInstance=this}babelHelpers.createClass(t,[{key:"hasTunnels",value:function t(){return this.getTunnels().length>0}},{key:"getContainer",value:function t(){return this.cache.remember("container",(function(){return document.querySelector(".crm-st")}))}},{key:"getAppContainer",value:function t(){var e=this;return this.cache.remember("appContainer",(function(){return e.getContainer().querySelector(".crm-st-container")}))}},{key:"getCategoriesContainer",value:function t(){var e=this;return this.cache.remember("categoriesContainer",(function(){return e.getAppContainer().querySelector(".crm-st-categories")}))}},{key:"getAddCategoryButton",value:function t(){var e=this;return this.cache.remember("addCategoryButton",(function(){return e.getContainer().querySelector(".crm-st-add-category-btn")}))}},{key:"getMaxSort",value:function t(){return babelHelpers.toConsumableArray(this.categories.values()).reduce((function(t,e){return t>e.sort?t:e.sort}),0)}},{key:"onAddCategoryClick",value:function t(e){var n=this;e.preventDefault();if(!this.isCategoryCreatable){return Promise.resolve(false)}if(BX.Crm.Restriction.Bitrix24.isRestricted("dealCategory")){var a=BX.Crm.Restriction.Bitrix24.getData("dealCategory");if(a&&a["quantityLimit"]<=this.categories.size){BX.Crm.Restriction.Bitrix24.getHandler("dealCategory").call();return Promise.resolve(false)}}return it.createCategory({name:o.Loc.getMessage("CRM_ST_TITLE_EDITOR_PLACEHOLDER2"),sort:this.getMaxSort()+10}).then((function(t){n.addCategoryFromOptions(t.data);var e=n.getStages();var a=[].concat(babelHelpers.toConsumableArray(t.data.STAGES.P),babelHelpers.toConsumableArray(t.data.STAGES.S),babelHelpers.toConsumableArray(t.data.STAGES.F));a.forEach((function(t){return e.push(t)}));var r=n.getCategory(t.data.ID);r.enableTitleEdit("");r.getAllColumns().forEach((function(t){n.tunnelScheme.stages.push({categoryId:t.getData().category.id,stageId:t.getId(),locked:false,tunnels:[]})}));if(n.isShownCategoryStub()){n.hideCategoryStub()}}))["catch"]((function(t){n.showErrorPopup(ut(t))}))}},{key:"onAddCategoryTopClick",value:function t(e){this.onAddCategoryClick(e).then((function(t){if(t){window.scrollTo(0,document.body.scrollHeight)}}))}},{key:"onHelpButtonClick",value:function t(e){e.preventDefault();if(top.BX.Helper){top.BX.Helper.show("redirect=detail&code=9474707")}}},{key:"getCategoryStub",value:function t(){var e=this;return this.cache.remember("categoryStub",(function(){return new st({renderTo:e.getCategoriesContainer(),appContainer:e.getAppContainer(),id:"stub",name:"stub",default:false,stages:{P:lt(5),S:lt(1),F:lt(2)},sort:0,robotsSettingsLink:e.robotsUrl,generatorSettingsLink:e.generatorUrl,permissionEditLink:e.permissionEditUrl,lazy:true,isAvailableGenerator:true,isStagesEnabled:e.isStagesEnabled,isAutomationEnabled:true})}))}},{key:"showCategoryStub",value:function t(){this.shownCategoryStub=true;var e=this.getCategoryStub();e.draw();var n=babelHelpers.toConsumableArray(this.categories.values())[0];var a=n.getSuccessKanban().getColumns(),r=babelHelpers.slicedToArray(a,1),o=r[0];var i=e.getProgressKanban().getColumns(),s=babelHelpers.slicedToArray(i,1),l=s[0];if(this.isAutomationEnabled){o.marker.addStubLinkTo(l.marker,true)}}},{key:"hideCategoryStub",value:function t(){this.shownCategoryStub=false;this.getCategoryStub().remove();this.cache["delete"]("categoryStub")}},{key:"isShownCategoryStub",value:function t(){return this.shownCategoryStub}},{key:"adjustCategoryStub",value:function t(){if(!this.hasTunnels()){this.showCategoryStub();return}this.hideCategoryStub()}},{key:"addCategoryFromOptions",value:function t(e){var n=this;var r=e.STAGES;if(!this.isStagesEnabled){r={P:lt(5),S:lt(1),F:lt(2)}}var i=new ot({renderTo:this.getCategoriesContainer(),appContainer:this.getAppContainer(),id:e.ID,name:e.NAME,default:e.IS_DEFAULT,stages:r,sort:e.SORT,access:e.ACCESS,robotsSettingsLink:this.robotsUrl,generatorSettingsLink:this.generatorUrl,permissionEditLink:this.permissionEditUrl,generatorsCount:e.RC_COUNT,generatorsListUrl:e.RC_LIST_URL,isCategoryEditable:this.isCategoryEditable,areStagesEditable:this.areStagesEditable,isAvailableGenerator:this.isAvailableGenerator,isAutomationEnabled:this.isAutomationEnabled,isStagesEnabled:this.isStagesEnabled});i.subscribe("Category:title:save",(function(t){var e=t.data,r=e.categoryId,i=e.value;it.updateCategory({id:r,fields:{NAME:i}}).then((function(){a.UI.Notification.Center.notify({content:o.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"});n.isChanged=true}))["catch"]((function(t){n.showErrorPopup(ut(t))}))})).subscribe("Category:access",(function(t){var e=t.data,r=e.categoryId,i=e.access;it.accessCategory({id:r,access:i}).then((function(){a.UI.Notification.Center.notify({content:o.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"})}))["catch"]((function(t){n.showErrorPopup(ut(t))}))})).subscribe("Category:access:copy",(function(t){var e=t.data,r=e.categoryId,i=e.donorCategoryId;it.copyAccessCategory({id:r,donorId:i}).then((function(){a.UI.Notification.Center.notify({content:o.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"})}))["catch"]((function(t){n.showErrorPopup(ut(t))}))})).subscribe("Category:remove",(function(t){it.removeCategory({id:t.data.categoryId}).then((function(){t.data.onConfirm();a.UI.Notification.Center.notify({content:o.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"});setTimeout((function(){if(n.isShownCategoryStub()){n.hideCategoryStub();n.showCategoryStub();return}n.adjustCategoryStub();C.adjustLinks()}));n.isChanged=true}))["catch"]((function(e){t.data.onCancel();n.showErrorPopup(ut(e))}))})).subscribe("Column:link",(function(t){if(!n.isAutomationEnabled){return}if(!t.data.preventSave){if(BX.Crm.Restriction.Bitrix24.isRestricted("automation")){return BX.Crm.Restriction.Bitrix24.getHandler("automation").call()}var e={category:t.data.link.from.getData().column.getData().category.id,stage:t.data.link.from.getData().column.data.stage.STATUS_ID};var r={category:t.data.link.to.getData().column.getData().category.id,stage:t.data.link.to.getData().column.data.stage.STATUS_ID};var i=t.data.link.robotAction;it.createRobot({from:e,to:r,robotAction:i}).then((function(t){a.UI.Notification.Center.notify({content:o.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"});var e=n.getStages().find((function(e){return String(e.CATEGORY_ID)===String(t.data.tunnel.srcCategory)&&String(e.STATUS_ID)===String(t.data.tunnel.srcStage)}));e.TUNNELS.push(t.data.tunnel)}))["catch"]((function(e){var a=t.data.link;a.from.removeLink(a);n.showErrorPopup(ut(e))}))}n.hideCategoryStub()})).subscribe("Column:removeLinkFrom",(function(t){if(!n.isAutomationEnabled){return}if(!t.data.preventSave){var e=t.data.link.from.getData().column;var r=t.data.link.to.getData().column;var i=e.getData().category.id;var s=e.getId();var l=r.getData().category.id;var u=r.getId();var c=n.getTunnelByLink(t.data.link);if(c){if(BX.Crm.Restriction.Bitrix24.isRestricted("automation")){return BX.Crm.Restriction.Bitrix24.getHandler("automation").call()}var d={srcCategory:i,srcStage:s,dstCategory:l,dstStage:u,robot:c.robot};it.removeRobot(d).then((function(){a.UI.Notification.Center.notify({content:o.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"})}))["catch"]((function(t){n.showErrorPopup(ut(t))}));var g=n.getStageDataById(s);g.TUNNELS=g.TUNNELS.filter((function(t){return!(String(t.srcStage)===String(s)&&String(t.srcCategory)===String(i)&&String(t.dstStage)===String(u)&&String(t.dstCategory)===String(l))}));n.adjustCategoryStub()}}})).subscribe("Column:changeRobotAction",(function(t){if(!n.isAutomationEnabled||t.data.preventSave){return}if(BX.Crm.Restriction.Bitrix24.isRestricted("automation")){return BX.Crm.Restriction.Bitrix24.getHandler("automation").call()}var e=t.data.link.from.getData().column;var r=t.data.link.to.getData().column;var i=e.getData().category.id;var s=e.getId();var l=r.getData().category.id;var u=r.getId();var c=n.getTunnelByLink(t.data.link);if(c){var d={category:i,stage:s};var g={category:l,stage:u};it.removeRobot(c).then((function(){it.createRobot({from:d,to:g,robotAction:t.data.link.robotAction}).then((function(e){a.UI.Notification.Center.notify({content:o.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"});var r=n.getStageDataById(s);var c=r.TUNNELS.findIndex((function(t){return String(t.srcStage)===String(s)&&String(t.srcCategory)===String(i)&&String(t.dstStage)===String(u)&&String(t.dstCategory)===String(l)}));if(c>=0){r.TUNNELS[c]=e.data.tunnel}t.data.onChangeRobotEnd()}))["catch"]((function(t){return n.showErrorPopup(ut(t))}))}))["catch"]((function(t){return n.showErrorPopup(ut(t))}))}})).subscribe("Column:editLink",(function(t){if(!n.isAutomationEnabled){return}var e=n.getTunnelByLink(t.data.link);BX.Bizproc.Automation.API.showRobotSettings(e.robot,n.documentType,e.srcStage,(function(r){e.robot=r.serialize();it.request({action:"updateRobot",analyticsLabel:{component:it.component,action:"update.robot"},data:e}).then((function(){a.UI.Notification.Center.notify({content:o.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"});e.dstCategory=r.getProperty("CategoryId");e.dstStage=r.getProperty("StageId");var i=n.getCategory(e.dstCategory);var s=i.getKanbanColumn(e.dstStage);t.data.link.from.updateLink(t.data.link,s.marker,true);n.adjustCategoryStub()}))["catch"]((function(t){n.showErrorPopup(ut(t))}))}))})).subscribe("Category:sort",(function(){var t=ot.instances.filter((function(t){return t.id!=="stub"})).map((function(t,e){return it.updateCategory({id:t.id,fields:{SORT:(e+1)*100}})}));Promise.all(t).then((function(){a.UI.Notification.Center.notify({content:o.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"});n.isChanged=true}))})).subscribe("Column:remove",(function(t){if(!o.Type.isNil(t.data.column.data.stageId)){var e=n.isAutomationEnabled?babelHelpers.toConsumableArray(C.getAllLinks()).some((function(e){return t.data.column.marker===e.from||t.data.column.marker===e.to})):false;it.removeStage({statusId:t.data.column.getId(),stageId:t.data.column.data.stageId,entityId:t.data.column.data.entityId}).then((function(){t.data.onConfirm();if(!e){a.UI.Notification.Center.notify({content:o.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"});n.isChanged=true}}))["catch"]((function(e){t.data.onCancel();n.showErrorPopup(ut(e))}))}})).subscribe("Column:change",(function(t){it.updateStage({statusId:t.data.column.getId(),stageId:t.data.column.data.stageId,entityId:t.data.column.data.entityId,name:t.data.column.getName(),sort:t.data.column.data.stage.SORT,color:t.data.column.getColor()}).then((function(t){var e=t.data;if(e.success){a.UI.Notification.Center.notify({content:o.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"});n.isChanged=true}else{n.showErrorPopup(ut({data:e}))}}))})).subscribe("Column:addColumn",(function(t){it.addStage({name:t.data.column.getGrid().getMessage("COLUMN_TITLE_PLACEHOLDER"),sort:function(){var e=t.data.column;return Number(e.data.stage.SORT)+1}(),entityId:function(){var e=t.data.column;return e.data.stage.ENTITY_ID}(),color:BX.Kanban.Column.DEFAULT_COLOR,semantics:function(){var e=t.data.column;return e.data.stage.SEMANTICS}(),categoryId:function(){var e=t.data.column;return e.data.category.id}()}).then((function(e){var r=e.data;a.UI.Notification.Center.notify({content:o.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"});n.isChanged=true;var i=r.stage;var s=t.data.column;var l=s.getGrid();var u=n.getCategory(s.data.category.id);i.TUNNELS=[];n.getStages().push(i);var c=l.getNextColumnSibling(s);var d=l.addColumn({id:i.STATUS_ID,name:i.NAME,color:i.COLOR.replace("#",""),data:u.getColumnData(i),targetId:c});d.switchToEditMode();C.adjustLinks()}))["catch"]((function(t){n.showErrorPopup(ut(t))}))})).subscribe("Column:sort",(function(t){var e=t.data.columns.map((function(t,e){var n=(e+1)*100;var a={statusId:t.getId(),stageId:t.data.stageId,entityId:t.data.entityId,name:t.getName(),sort:n,color:t.getColor()};t.data.stage.SORT=n;return a}));it.updateStages(e).then((function(t){var e=t.data;var r=e.every((function(t){return t.success}));if(r){a.UI.Notification.Center.notify({content:o.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"});n.isChanged=true}else{n.showErrorPopup(ut({data:e}))}}))})).subscribe("Category:slider:close",(function(){n.reload()})).subscribe("Column:error",(function(t){n.showErrorPopup(ut({data:{errors:[t.data.message]}}))}));this.categories.set(String(e.ID),i)}},{key:"showErrorPopup",value:function t(e){if(!this.errorPopup){this.errorPopup=new r.PopupWindow({titleBar:o.Loc.getMessage("CRM_ST_ERROR_POPUP_TITLE"),width:350,closeIcon:true,buttons:[new r.PopupWindowButtonLink({id:"close",text:o.Loc.getMessage("CRM_ST_ERROR_POPUP_CLOSE_BUTTON_LABEL"),events:{click:function t(){this.popupWindow.close()}}})]})}this.errorPopup.setContent(e);this.errorPopup.show()}},{key:"getSlider",value:function t(){return BX.SidePanel.Instance.getSlider(window.location.pathname)}},{key:"reload",value:function t(){var e=this.getSlider();if(e){e.reload()}}},{key:"getStageDataById",value:function t(e){return this.getStages().find((function(t){return String(t.STATUS_ID)===String(e)}))}},{key:"getTunnelByLink",value:function t(e){var n=e.from.getData().column;var a=e.to.getData().column;var r=n.getData().category.id;var o=n.getId();var i=a.getData().category.id;var s=a.getId();var l=this.getStageDataById(o);if(l){return l.TUNNELS.find((function(t){return String(t.srcCategory)===String(r)&&String(t.srcStage)===String(o)&&String(t.dstCategory)===String(i)&&String(t.dstStage)===String(s)}))}return null}},{key:"getCategory",value:function t(e){return this.categories.get(String(e))}},{key:"getStages",value:function t(){var e=this;return this.cache.remember("allStages",(function(){return e.categoriesOptions.reduce((function(t,e){return[].concat(babelHelpers.toConsumableArray(t),babelHelpers.toConsumableArray(e.STAGES.P),babelHelpers.toConsumableArray(e.STAGES.S),babelHelpers.toConsumableArray(e.STAGES.F))}),[])}))}},{key:"getTunnels",value:function t(){return this.getStages().reduce((function(t,e){return[].concat(babelHelpers.toConsumableArray(t),babelHelpers.toConsumableArray(e.TUNNELS||[]))}),[])}},{key:"initCategories",value:function t(){var e=this;this.categoriesOptions.map((function(t){e.addCategoryFromOptions(t)}))}},{key:"initTunnels",value:function t(){var e=this;if(!this.isAutomationEnabled){return}this.getStages().filter((function(t){return o.Type.isArray(t.TUNNELS)&&t.TUNNELS.length})).forEach((function(t){t.TUNNELS.forEach((function(t){var n=e.getCategory(t.srcCategory);var a=e.getCategory(t.dstCategory);if(n&&a){var r=n.getKanbanColumn(t.srcStage);var o=a.getKanbanColumn(t.dstStage);if(r&&o){var i=true;r.marker.addLinkTo(o.marker,t.robotAction,i)}}}))}))}}],[{key:"getLastInstance",value:function t(){return this.lastInstance}}]);return t}();babelHelpers.defineProperty(ct,"lastInstance",null);var dt={Column:M,Grid:A};t.Kanban=dt;t.Manager=ct})(this.BX.Crm.SalesTunnels=this.BX.Crm.SalesTunnels||{},BX.Main,BX,BX,BX.Main,BX);
//# sourceMappingURL=script.map.js