{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {Reflection, Type, ajax, Loc} from 'main.core';\nimport {Manager} from 'rpa.manager';\n\nconst namespace = Reflection.namespace('BX.Rpa');\n\nclass TaskComponent\n{\n\ttypeId = null;\n\titemId = null;\n\tbuttons: Array = [];\n\ttask = null;\n\tonTaskComplete = null;\n\teditor = false;\n\trequestStarted = false;\n\n\tconstructor(typeId, itemId, options)\n\t{\n\t\tthis.typeId = typeId;\n\t\tthis.itemId = itemId;\n\t\tthis.buttons = options.buttons || [];\n\t\tthis.task = options.task || null;\n\t\tthis.onTaskComplete = options.onTaskComplete || null;\n\t}\n\n\tinit()\n\t{\n\t\t[].forEach.call(\n\t\t\tthis.buttons,\n\t\t\t(btn) => {\n\t\t\t\tbtn.style.color = Manager.calculateTextColor(btn.style.backgroundColor);\n\t\t\t\tBX.bind(btn, 'click', this.clickButtonHandler.bind(this, btn));\n\t\t\t},\n\t\t\tthis\n\t\t);\n\n\t\tif (this.task.ACTIVITY === 'RpaRequestActivity')\n\t\t{\n\t\t\tthis.prepareEditor();\n\t\t}\n\t}\n\n\tstartRequest()\n\t{\n\t\tthis.requestStarted = true;\n\t\tif(BX.UI && BX.UI.ButtonManager)\n\t\t{\n\t\t\tthis.buttons.forEach((node) => {\n\t\t\t\tconst uiButton = BX.UI.ButtonManager.createFromNode(node);\n\t\t\t\tif(uiButton)\n\t\t\t\t{\n\t\t\t\t\tuiButton.setWaiting(true);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tstopRequest()\n\t{\n\t\tthis.requestStarted = false;\n\t\tif(BX.UI && BX.UI.ButtonManager)\n\t\t{\n\t\t\tthis.buttons.forEach((node) => {\n\t\t\t\tconst uiButton = BX.UI.ButtonManager.createFromNode(node);\n\t\t\t\tif(uiButton)\n\t\t\t\t{\n\t\t\t\t\tuiButton.setWaiting(false);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tclickButtonHandler(btn, event)\n\t{\n\t\tevent.preventDefault();\n\n\t\tif (this.editor)\n\t\t{\n\t\t\tif (this.validateFields())\n\t\t\t{\n\t\t\t\tthis.startRequest();\n\t\t\t\tthis.editor.save();\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.doTask(btn);\n\t\t}\n\t}\n\n\tdoTask(clickedButton)\n\t{\n\t\tif (this.requestStarted)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tthis.startRequest();\n\n\t\tlet formData = new FormData(clickedButton.closest('form'));\n\t\tformData.append(clickedButton.name, clickedButton.value);\n\n\t\tajax.runAction('rpa.task.do', {\n\t\t\tanalyticsLabel: 'rpaTaskDo',\n\t\t\tdata: formData\n\t\t}).then((response) =>\n\t\t{\n\t\t\tthis.stopRequest();\n\t\t\tif (response.data.completed)\n\t\t\t{\n\t\t\t\tif (this.onTaskComplete)\n\t\t\t\t{\n\t\t\t\t\tthis.onTaskComplete(response.data);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tprepareEditor()\n\t{\n\t\tthis.editor = Manager.getEditor(this.typeId, this.itemId);\n\t\tBX.addCustomEvent(window, 'BX.UI.EntityEditorAjax:onSubmitFailure', this.onEditorErrors.bind(this));\n\t\tBX.addCustomEvent(window, 'BX.UI.EntityEditorAjax:onSubmit', this.onEditorSubmit.bind(this));\n\t\tBX.addCustomEvent(window, 'BX.UI.EntityEditor:onSave', this.onEditorSave.bind(this));\n\t\tBX.addCustomEvent(window, \"BX.UI.EntityEditor:onFailedValidation\", this.onEditorErrors.bind(this));\n\n\t\tthis.unregisterActiveFields();\n\t}\n\n\tunregisterActiveFields()\n\t{\n\t\tconst showSection = this.editor.getControlById('to_show');\n\t\tconst fields = showSection ? showSection.getChildren() : [];\n\n\t\tfields.forEach((field) => {\n\t\t\tfield._isActive = false;\n\t\t});\n\t}\n\n\tvalidateFields()\n\t{\n\t\tlet result = true;\n\t\tconst setSection = this.editor.getControlById('to_set');\n\t\tconst fields = setSection ? setSection.getChildren() : [];\n\n\t\tfields.forEach((field) =>\n\t\t{\n\t\t\tif (BX.Main.UF.Factory.isEmpty(field.getId()))\n\t\t\t{\n\t\t\t\tlet control = this.editor.getControlById(field.getId());\n\t\t\t\tif (!control.hasError())\n\t\t\t\t{\n\t\t\t\t\tcontrol.showError(Loc.getMessage('RPA_TASK_FIELD_VALIDATION_ERROR'));\n\t\t\t\t}\n\t\t\t\tresult = false;\n\t\t\t}\n\t\t});\n\n\t\treturn result;\n\t}\n\n\tonEditorSubmit(entityData, response)\n\t{\n\t\tthis.stopRequest();\n\t\tif (response.data.completed && Type.isFunction(this.onTaskComplete))\n\t\t{\n\t\t\tsetTimeout(this.onTaskComplete.bind(this, response.data), 10);\n\t\t}\n\t}\n\n\tonEditorSave(editor, eventArgs)\n\t{\n\t\tif (this.editor === editor)\n\t\t{\n\t\t\teventArgs.enableCloseConfirmation = false;\n\t\t}\n\t}\n\n\tonEditorErrors(errors)\n\t{\n\t\tthis.stopRequest();\n\t\tlet msg = errors.pop().message;\n\n\t\tBX.UI.Notification.Center.notify({\n\t\t\tcontent: msg\n\t\t});\n\t}\n}\n\nnamespace.TaskComponent = TaskComponent;"],"names":["namespace","Reflection","TaskComponent","typeId","itemId","options","buttons","task","onTaskComplete","forEach","call","btn","style","color","Manager","calculateTextColor","backgroundColor","BX","bind","clickButtonHandler","ACTIVITY","prepareEditor","requestStarted","UI","ButtonManager","node","uiButton","createFromNode","setWaiting","event","preventDefault","editor","validateFields","startRequest","save","doTask","clickedButton","formData","FormData","closest","append","name","value","ajax","runAction","analyticsLabel","data","then","response","stopRequest","completed","getEditor","addCustomEvent","window","onEditorErrors","onEditorSubmit","onEditorSave","unregisterActiveFields","showSection","getControlById","fields","getChildren","field","_isActive","result","setSection","Main","UF","Factory","isEmpty","getId","control","hasError","showError","Loc","getMessage","entityData","Type","isFunction","setTimeout","eventArgs","enableCloseConfirmation","errors","msg","pop","message","Notification","Center","notify","content"],"mappings":"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"}