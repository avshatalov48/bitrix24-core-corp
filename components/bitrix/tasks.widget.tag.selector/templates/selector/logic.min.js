"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetTagSelector!="undefined"){return}BX.Tasks.Component.TasksWidgetTagSelector=BX.Tasks.Component.extend({sys:{code:"tag-sel-is"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);this.subInstance("items",(function(){return new this.constructor.Items({scope:this.scope(),data:this.option("data"),groupId:this.option("groupId"),taskId:this.option("taskId"),userName:this.option("userName"),isScrumTask:this.option("isScrumTask")==="Y",tagsAreConverting:this.option("tagsAreConverting"),preRendered:true})}))}}});BX.Tasks.Component.TasksWidgetTagSelector.Items=BX.Tasks.Util.ItemSet.extend({sys:{code:"tag-sel"},options:{controlBind:"class",itemFx:"horizontal",itemFxHoverDelete:true,dialog:null,dialogCallback:true},methods:{bindEvents:function(){this.callMethod(BX.Tasks.Util.ItemSet,"bindEvents");this.bindDelegateControl("form-control","click",this.passCtx(this.openAddForm));BX.addCustomEvent(window,"onTaskTagSelectAlt",this.onTagsChange.bind(this));var t=function(t){var e=t.oldTagsNames;if(this.opts.dialog){this.opts.dialog.hide()}var s=[];this.each((function(t){s.push(t)}));var a=[];s.forEach((function(t){a.push(t.display())}));var i=t.oldTagName;var o=t.newTagName;if(!this.opts.changedItems){this.opts.changedItems=[]}s.forEach(function(t){if(i&&o!==""&&t.display()===i){this.addItem({NAME:o});this.opts.changedItems.indexOf(o)===-1&&this.opts.changedItems.push(o);var s=this.opts.changedItems.indexOf(i);this.opts.changedItems.splice(s,s);this.deleteItem(t.value());return}if(i&&o===""&&t.display()===i){var a=this.opts.changedItems.indexOf(i);this.opts.changedItems.splice(a,a);this.deleteItem(t.value());return}if(e&&e.length!==0){if(e.indexOf(t.display())!==-1){var n=this.opts.changedItems.indexOf(i);this.opts.changedItems.splice(n,n);this.deleteItem(t.value());return}else{this.opts.changedItems.indexOf(t.display())===-1&&this.opts.changedItems.push(t.display())}return}this.opts.changedItems.indexOf(t.display())===-1&&this.opts.changedItems.push(t.display())}.bind(this));this.opts.dialog=null};var e=function(t){if(this.opts.dialog){this.selectedItems=this.opts.dialog.getSelectedItems();this.opts.dialog.hide();this.opts.dialog=null}if(!t.data.groupId||t.data.groupId.length===0){this.opts.groupId=0;this.tagOwner=this.option("userName")}else{this.opts.groupId=parseInt(t.data.groupId[0].match(/\d+/));this.tagOwner=t.data.owner}};BX.addCustomEvent("onProjectChanged",e.bind(this));BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"tasks",command:"tag_changed",callback:t.bind(this)});this.getTagSelector().load()},onTagsChange:function(t){var e=[];this.each((function(t){e.push(t.display())}));var s=this.getTagSelector().getItems();var a=[];for(var i=0;i<s.length;i++){var o=s[i];if(o.isSelected()){a.push(o.getTitle());if(!BX.util.in_array(o.getTitle(),e)){this.addItem({NAME:o.getTitle()})}}}this.each((function(t){if(!BX.util.in_array(t.display(),a)){this.deleteItem(t.value())}}))},openAddForm:function(t){if(this.option("tagsAreConverting")){var e=new top.BX.UI.Dialogs.MessageBox({title:BX.message("TASKS_WIDGET_TAG_SELECTOR_TAGS_ARE_CONVERTING_TITLE"),message:BX.message("TASKS_WIDGET_TAG_SELECTOR_TAGS_ARE_CONVERTING_TEXT"),buttons:top.BX.UI.Dialogs.MessageBoxButtons.OK,okCaption:BX.message("TASKS_WIDGET_TAG_SELECTOR_TAGS_ARE_CONVERTING_COME_BACK_LATER"),onOk:function(){e.close()}});e.show();return}this.getTagSelector().show()},onItemDeleteByCross:function(t){BX.onCustomEvent("onTaskTagDeleteByCross",[t.opts.data]);this.callMethod(BX.Tasks.Util.ItemSet,"onItemDeleteByCross",arguments);this.unselectDialogItem(t)},unselectDialogItem:function(t){var e=this.getTagSelector();if(!e){return}this.opts.dialogCallback=false;if(typeof t==="object"){t=t.data()}var s=e.getItem(this.prepareTagItemData(t,e));s&&s.deselect();this.opts.dialogCallback=true},prepareItemData:function(t){return["task-tag",t.NAME]},prepareTagItemData:function(t,e){var s=e.getItems();var a=null;s.forEach((function(e){if(e.title.text===t.NAME){a=e.id;return}}));return{id:a,entityId:"task-tag"}},extractItemDisplay:function(t){return t.NAME},extractItemValue:function(t){if("VALUE"in t){return t.VALUE}return Math.abs(this.hashCode(t.NAME))},hashCode:function(t){if(!BX.type.isNotEmptyString(t)){return 0}var e=0;for(var s=0;s<t.length;s++){var a=t.charCodeAt(s);if(a>255){a-=848}e=(e<<5)-e+a;e=e&e}return e},getTagSelector:function(){var t=this.opts.taskId;var e=this.opts.groupId;var s=this.selectedItems;var a=this.opts.changedItems;var i=this.tagOwner;if(this.opts.groupId===0){var o=BX.UI.EntitySelector.Dialog.getById("tasksMemberSelector_project");if(o){var n=o.getSelectedItems();if(n.length!==0){this.opts.dialog=null;this.opts.groupId=n[0].id;e=this.opts.groupId}}}var r=function(){var t=BX.UI.EntitySelector.Dialog.getById("tasksTagSelector");t.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=false;t.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=false};var d=function(){var t=BX.UI.EntitySelector.Dialog.getById("tasksTagSelector");t.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=true;t.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=true};var l=function(t){var e=t.getTarget();var s=t.getData().query;if(s.trim()!==""){r()}else{d()}};var c=function(t,e){var s=BX.UI.EntitySelector.Dialog.getById("tasksTagSelector");if(s.getContainer().querySelector(`div.${t}`)){return}var a=document.createElement("div");a.className=t;a.innerHTML=`\n\t\t\t\t\t\t<div class='ui-alert ui-alert-xs ui-alert-danger'  \n\t\t\t\t\t\t\t<span class='ui-alert-message'>\n\t\t\t\t\t\t\t\t${e}\n\t\t\t\t\t\t\t</span> \n\t\t\t\t\t\t</div>\n\t\t\t\t\t`;s.getFooterContainer().before(a)};var g=function(o){var n=o.getTarget();if(a){a.forEach((function(t){var e=n.addItem({id:t,entityId:"task-tag",title:t,tabs:"all",badges:[{title:i}]});e.select()}))}if(s){s.forEach((function(t){var e=t.title.text;var s=false;n.getItems().forEach((function(t){if(t.title.text===e){s=true;t.select();t.setBadges([{title:i}])}}));if(!s){var a=n.addItem({id:t.title.text,entityId:t.entityId,title:t.title.text,tabs:"all",badges:[{title:i}]});a.select()}}))}var r=["click","keydown"];var d=function(s){if(s.type==="keydown"){if(!((s.ctrlKey||s.metaKey)&&s.keyCode===13)){return}}var a=n.getTagSelectorQuery();if(a.trim()===""){return}BX.ajax.runComponentAction("bitrix:tasks.tag.list","addTag",{mode:"class",data:{newTag:a,taskId:t,groupId:e}}).then((function(t){if(t.data.success){var e=n.addItem({id:a,entityId:"task-tag",title:a,tabs:"all",badges:[{title:i}]});var s={title:t.data.owner};e.setBadges([s]);e.select();n.clearSearch()}else{var o="tasks-selector-add-tag-already-exists-alert";c(o,t.data.error);var r=function(){var t=n.getContainer().querySelector(`div.${o}`);t&&t.remove()};setTimeout(r,2e3)}}))};r.forEach((function(t){if(t==="click"){n.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").addEventListener(t,d)}else{n.getContainer().addEventListener(t,d)}}))};var h=function(){var t=document.querySelectorAll("div.task-options-item-open-inner");var e=this.control("form-control");t.forEach((function(t){if(t.contains(e)){e=t}}));return e}.bind(this);if(this.opts.dialog){return this.opts.dialog}this.opts.dialog=new BX.UI.EntitySelector.Dialog({id:"tasksTagSelector",targetNode:h(),enableSearch:true,width:350,height:400,multiple:true,dropdownMode:true,compactView:true,entities:[{id:"task-tag",options:{taskId:this.option("taskId"),groupId:this.opts.groupId}}],searchOptions:{allowCreateItem:false},footer:BX.Tasks.EntitySelector.Footer,footerOptions:{taskId:this.opts.taskId,groupId:this.opts.groupId},clearUnavailableItems:true,events:{onLoad:function(t){t.getTarget().getFooterContainer().style.zIndex=1;g(t)}.bind(this),onSearch:function(t){l(t)}.bind(this),"Item:onSelect":function(t){this.opts.dialogCallback&&this.onTagsChange(t)}.bind(this),"Item:onDeselect":function(t){this.opts.dialogCallback&&this.onTagsChange(t)}.bind(this)}});return this.opts.dialog}}})}).call(this);
//# sourceMappingURL=logic.map.js