{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {UI} from 'ui.notification';\nimport {MenuManager, PopupManager} from \"main.popup\";\nimport {Tag, Loc, Type, Dom, Reflection} from \"main.core\";\nimport {EventEmitter} from \"main.core.events\";\nimport {Loader} from \"main.loader\";\n\n\nconst namespace = Reflection.namespace('BX.Crm');\n\nexport class DedupeAutosearch\n{\n\tconstructor()\n\t{\n\t\tthis._componentName = '';\n\t\tthis._componentSignedParams = '';\n\t\tthis._entityTypeId = 0;\n\t\tthis._instanceId = '';\n\t\tthis._internalMergeStatus = '';\n\t\tthis._mergeCheckerTimeoutId = null;\n\t\tthis._mergerUrl = '';\n\t\tthis._dedupeListUrl = '';\n\t\tthis._execInterval = null;\n\t\tthis._intervalsList = [];\n\t\tthis._isDropdownMenuShown = false;\n\t\tthis._selectedExecInterval = null;\n\t\tthis._selectedExecIntervalNode = null;\n\t\tthis._status = '';\n\t\tthis._infoHelperId = '';\n\t\tthis._progressData = {};\n\n\t\tthis._settingsPopupId = 'autosearch-settings-popup';\n\t}\n\n\tinitialize(params)\n\t{\n\t\tthis._componentName = BX.prop.getString(params, 'componentName', '');\n\t\tthis._componentSignedParams = BX.prop.getString(params, 'signedParameters', '');\n\t\tthis._entityTypeId = BX.prop.getInteger(params, 'entityTypeId', 0);\n\t\tthis._instanceId = BX.Text.getRandom(8);\n\t\tthis._internalMergeStatus = 'waiting';\n\t\tthis._mergerUrl = BX.prop.getString(params, 'mergerUrl', '');\n\t\tthis._dedupeListUrl = BX.prop.getString(params, 'dedupeListUrl', '');\n\t\tthis._execInterval = BX.prop.getString(params, 'selectedInterval', '0');\n\t\tthis._intervalsList = BX.prop.getArray(params, 'intervals', []);\n\t\tthis._status = BX.prop.getString(params, 'status', '');\n\t\tthis._infoHelperId = BX.prop.getString(params, 'infoHelperId', '');\n\t\tthis._progressData = BX.prop.getObject(params, 'progressData', {});\n\n\t\tthis.tryToStartMerge(true);\n\n\t\tthis.subscribeEvents();\n\t}\n\n\tsubscribeEvents()\n\t{\n\t\tif (BX.PULL)\n\t\t{\n\t\t\tBX.PULL.subscribe({\n\t\t\t\ttype: BX.PullClient.SubscriptionType.Server,\n\t\t\t\tmoduleId: 'crm',\n\t\t\t\tcommand: 'dedupe.autosearch.startMerge',\n\t\t\t\tcallback: (params) =>\n\t\t\t\t{\n\t\t\t\t\tif (BX.prop.getInteger(params, 'entityTypeId', 0) === this._entityTypeId)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis._status = BX.prop.getString(params, 'status', '');\n\t\t\t\t\t\tthis._progressData = BX.prop.getObject(params, 'progressData', {});\n\n\t\t\t\t\t\tif (this._status === 'MERGING')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet notification = UI.Notification.Center.getBalloonById('crm.autosearch.start_merge');\n\t\t\t\t\t\t\tif (notification)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tnotification.close();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis.tryToStartMerge();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t\tBX.PULL.subscribe({\n\t\t\t\ttype: BX.PullClient.SubscriptionType.Server,\n\t\t\t\tmoduleId: 'crm',\n\t\t\t\tcommand: 'dedupe.autosearch.mergeComplete',\n\t\t\t\tcallback: (params) =>\n\t\t\t\t{\n\t\t\t\t\tif (BX.prop.getInteger(params, 'entityTypeId', 0) === this._entityTypeId)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst data = BX.prop.getObject(params, 'data', {});\n\t\t\t\t\t\tthis._status =  BX.prop.getInteger(data, 'CONFLICT_COUNT', 0) > 0 ?\n\t\t\t\t\t\t\t'CONFLICTS_RESOLVING' : '';\n\t\t\t\t\t\tclearTimeout(this._mergeCheckerTimeoutId);\n\t\t\t\t\t\tthis.showMergeCompleteNotification(data);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tEventEmitter.subscribe('onLocalStorageSet', this.onExternalEvent.bind(this));\n\t}\n\n\tshowSettings()\n\t{\n\t\tthis._selectedExecInterval = this._execInterval;\n\t\tconst popup = PopupManager.create({\n\t\t\tid: this._settingsPopupId,\n\t\t\tcacheable: false,\n\t\t\ttitleBar: Loc.getMessage('CRM_DP_AUTOSEARCH_SETTINGS_TITLE'),\n\t\t\tcontent: this.needLoadConflictsCount() ? this.getSettingsPopupLoader() : this.getSettingsPopupContent(),\n\t\t\tcloseByEsc: true,\n\t\t\tcloseIcon: true,\n\t\t\tdraggable: true,\n\t\t\twidth: 500,\n\t\t\tbuttons: [\n\t\t\t\tnew BX.UI.SaveButton({\n\t\t\t\t\tonclick: () =>\n\t\t\t\t\t{\n\t\t\t\t\t\tpopup.close();\n\t\t\t\t\t\tthis.saveSelectedExecInterval();\n\t\t\t\t\t}\n\t\t\t\t}),\n\t\t\t\tnew BX.UI.CancelButton({\n\t\t\t\t\tonclick: () =>\n\t\t\t\t\t{\n\t\t\t\t\t\tpopup.close();\n\t\t\t\t\t}\n\t\t\t\t}),\n\t\t\t]\n\t\t});\n\t\tpopup.show();\n\t\tif (this.needLoadConflictsCount())\n\t\t{\n\t\t\tthis.loadConflictsCount()\n\t\t\t\t.then((conflictsCount) =>\n\t\t\t\t{\n\t\t\t\t\tpopup.setContent(this.getSettingsPopupContent(conflictsCount));\n\t\t\t\t\tpopup.adjustPosition();\n\t\t\t\t}, () => {\n\t\t\t\t\tpopup.setContent(this.getSettingsPopupContent(0));\n\t\t\t\t\tpopup.adjustPosition();\n\t\t\t\t});\n\t\t}\n\t}\n\n\ttryToStartMerge(immediately = false)\n\t{\n\t\tif (this._status === 'READY_TO_MERGE')\n\t\t{\n\t\t\tthis.showStartConfirmation();\n\t\t}\n\t\tif (this._status === 'MERGING')\n\t\t{\n\t\t\tthis.startMerging(immediately ? 1 : this.getShortTimeout());\n\t\t}\n\t\tif (this._status === 'CONFLICTS_RESOLVING')\n\t\t{\n\t\t\tthis.showMergeCompleteNotification(this._progressData);\n\t\t}\n\t}\n\n\tshowStartConfirmation()\n\t{\n\t\tif (!BX.prop.getBoolean(this._progressData, 'SHOW_NOTIFICATION', true))\n\t\t{\n\t\t\t// message was already shown in this session\n\t\t\treturn;\n\t\t}\n\t\tconst entityTypeName = BX.CrmEntityType.resolveName(this._entityTypeId);\n\t\tconst foundItemsCount = BX.prop.getInteger(this._progressData, 'FOUND_ITEMS', 0);\n\t\tconst totalEntitiesCount = BX.prop.getInteger(this._progressData, 'TOTAL_ENTITIES', 0);\n\t\tconst notificationContent = Tag.render`\n\t\t\t<span>\n\t\t\t\t${Loc.getMessage('CRM_DP_AUTOSEARCH_START_CONFIRMATION_TEXT_' + entityTypeName)\n\t\t\t\t\t.replace('#FOUND_ITEMS_COUNT#', foundItemsCount)\n\t\t\t\t\t.replace('#TOTAL_ENTITIES_COUNT#', totalEntitiesCount)}\n\t\t\t\t<br>\n\t\t\t\t${Loc.getMessage('CRM_DP_AUTOSEARCH_START_CONFIRMATION_TEXT')}\n\t\t\t\t<span class=\"ui-hint notification-hint-inline\">\n\t\t\t\t\t<span class=\"ui-hint-icon\" onclick=\"${this.onHintClick.bind(this)}\"></span>\n\t\t\t\t</span>\n\t\t\t</span>`;\n\t\tUI.Notification.Center.notify({\n\t\t\tcontent: notificationContent,\n\t\t\tautoHide: false,\n\t\t\tid: 'crm.autosearch.start_merge',\n\t\t\twidth: 600,\n\t\t\tactions: [\n\t\t\t\t{\n\t\t\t\t\ttitle: Loc.getMessage('CRM_DP_AUTOSEARCH_START_CONFIRMATION_BUTTON'),\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: (event, balloon, action) =>\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.showSettings();\n\t\t\t\t\t\t\tballoon.close();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t],\n\t\t\tevents: {\n\t\t\t\tonOpen: function(event)\n\t\t\t\t{\n\t\t\t\t\tvar balloon = event.getBalloon();\n\t\t\t\t\tBX.UI.Hint.init(balloon.getContainer());\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tshowMergeCompleteNotification(data)\n\t{\n\t\tif (!BX.prop.getBoolean(data, 'SHOW_NOTIFICATION', true))\n\t\t{\n\t\t\t// message was already shown in this session\n\t\t\treturn;\n\t\t}\n\n\t\tconst entityTypeName = BX.CrmEntityType.resolveName(this._entityTypeId);\n\t\tconst successCount = BX.prop.getInteger(data, 'SUCCESS_COUNT', 0);\n\t\tconst conflictsCount = BX.prop.getInteger(data, 'CONFLICT_COUNT', 0);\n\n\t\tif (successCount === 0 && conflictsCount === 0)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet message = Tag.render`<div></div>`;\n\t\tconst automaticallyFoundText = successCount > 0 ?\n\t\t\tLoc.getMessage('CRM_DP_AUTOSEARCH_COMPLETE_TEXT_' + entityTypeName)\n\t\t\t\t.replace('#FOUND_ITEMS_COUNT#', successCount)\n\t\t\t:\n\t\t\tLoc.getMessage('CRM_DP_AUTOSEARCH_EMPTY_RESULTS_' + entityTypeName);\n\t\tDom.append(\n\t\t\tTag.render`<div>${automaticallyFoundText}</div>`,\n\t\t\tmessage\n\t\t);\n\t\tlet actions = [];\n\t\tlet notificationWidth = 400;\n\t\tif (conflictsCount > 0)\n\t\t{\n\t\t\tDom.append(Tag.render`<div>${Loc.getMessage('CRM_DP_AUTOSEARCH_COMPLETE_CONFLICTED_TEXT').replace('#CONFLICTS_COUNT#', conflictsCount)}</div>`, message);\n\t\t\tactions.push({\n\t\t\t\ttitle: Loc.getMessage('CRM_DP_AUTOSEARCH_COMPLETE_RESOLVE_CONFLICT_BUTTON'),\n\t\t\t\tevents: {\n\t\t\t\t\tclick: (event, balloon, action) =>\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.openMerger();\n\t\t\t\t\t\tballoon.close();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tnotificationWidth = 670;\n\t\t}\n\t\tUI.Notification.Center.notify({\n\t\t\tcontent: message,\n\t\t\tautoHide: false,\n\t\t\tid: 'crm.autosearch.merge_complete',\n\t\t\twidth: notificationWidth,\n\t\t\tactions: actions\n\t\t});\n\t}\n\n\tsaveSelectedExecInterval()\n\t{\n\t\tthis._execInterval = this._selectedExecInterval;\n\t\tBX.ajax.runComponentAction(\n\t\t\tthis._componentName,\n\t\t\t'setExecInterval',\n\t\t\t{\n\t\t\t\tmode: 'class',\n\t\t\t\tsignedParameters: this._componentSignedParams,\n\t\t\t\tdata: {\n\t\t\t\t\tinterval: this._selectedExecInterval\n\t\t\t\t}\n\t\t\t});\n\t}\n\n\tstartMerging(timeout)\n\t{\n\t\tconst p = new Promise((resolve, reject) => {\n\t\t\tthis.askIfNoActiveMerging(timeout, resolve);\n\t\t});\n\t\tp.then(() => this.doMerge());\n\t}\n\n\tdoMerge()\n\t{\n\t\tBX.ajax.runComponentAction(\n\t\t\tthis._componentName,\n\t\t\t'merge',\n\t\t\t{\n\t\t\t\tmode: 'class',\n\t\t\t\tsignedParameters: this._componentSignedParams,\n\t\t\t\tdata: {\n\t\t\t\t\tmergeId: this._instanceId\n\t\t\t\t}\n\t\t\t}).then((response) =>\n\t\t\t{\n\t\t\t\tconst data = BX.prop.getObject(response, \"data\", {});\n\t\t\t\tconst instanceId = BX.prop.getString(data, \"MERGE_ID\", \"\");\n\t\t\t\tif (instanceId === this._instanceId)\n\t\t\t\t{\n\t\t\t\t\tconst status = BX.prop.getString(data, \"STATUS\", \"\");\n\n\t\t\t\t\tif (status !== \"COMPLETED\")\n\t\t\t\t\t{\n\t\t\t\t\t\twindow.setTimeout(() => this.doMerge(), 400);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.startMerging(this.getLongTimeout());\n\t\t\t\t}\n\t\t\t},\n\t\t\t(response) =>\n\t\t\t{\n\t\t\t\tthis.startMerging(this.getShortTimeout());\n\t\t\t}\n\t\t);\n\t}\n\n\tgetSettingsPopupLoader()\n\t{\n\t\tconst loaderContainer = Tag.render`<div></div>`;\n\t\tloaderContainer.style.height = '180px';\n\n\t\tconst loader = new Loader({\n\t\t\ttarget: loaderContainer\n\t\t});\n\t\tsetTimeout(() => {\n\t\t\tloader.show();\n\t\t}, 10);\n\t\treturn loaderContainer;\n\t}\n\n\tgetSettingsPopupContent(conflictsCount)\n\t{\n\t\tconst selectedExecInterval =\n\t\t\tthis._intervalsList.reduce((prev, item) => (item.value === this._selectedExecInterval ? item.title : prev), '');\n\n\t\tthis._selectedExecIntervalNode = Tag.render`<div class=\"ui-ctl-element\">${selectedExecInterval}</div>`;\n\t\treturn Tag.render`\n\t\t\t<div>\n\t\t\t\t${this.getConflictsInfo(conflictsCount)}\n\t\t\t\t<p>${Loc.getMessage('CRM_DP_AUTOSEARCH_SETTINGS_NOTE')}</p>\n\t\t\t\t<div class=\"ui-ctl-label-text\">${Loc.getMessage('CRM_DP_AUTOSEARCH_SETTINGS_INTERVAL_TITLE')}</div>\n\t\t\t\t<div class=\"ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100\" onclick=\"${this.toggleIntervalsList.bind(this)}\">\n\t\t\t\t\t${this._selectedExecIntervalNode}\n\t\t\t\t\t<div class=\"ui-ctl-after ui-ctl-icon-angle\"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\tneedLoadConflictsCount()\n\t{\n\t\treturn (this._status === 'CONFLICTS_RESOLVING');\n\t}\n\n\tloadConflictsCount()\n\t{\n\t\treturn BX.ajax.runComponentAction(\n\t\t\tthis._componentName,\n\t\t\t'getStatistic',\n\t\t\t{\n\t\t\t\tmode: 'class',\n\t\t\t\tsignedParameters: this._componentSignedParams\n\t\t\t}).then((response) =>\n\t\t\t{\n\t\t\t\tconst data = BX.prop.getObject(response, \"data\", {});\n\t\t\t\treturn BX.prop.getInteger(data, \"conflictsCount\", 0);\n\t\t\t}\n\t\t);\n\t}\n\n\tgetConflictsInfo(conflictsCount)\n\t{\n\t\tif (!this.needLoadConflictsCount())\n\t\t{\n\t\t\treturn '';\n\t\t}\n\t\tif (conflictsCount <= 0)\n\t\t{\n\t\t\treturn '';\n\t\t}\n\t\treturn Tag.render`\n\t\t\t<div class=\"ui-alert ui-alert-warning\">\n\t\t\t\t<span class=\"ui-alert-message\">\n\t\t\t\t\t${Loc.getMessage('CRM_DP_AUTOSEARCH_SETTINGS_CONFLICTS_FOUND').replace('#CONFLICTS_COUNT#', conflictsCount)}\n\t\t\t\t\t<span class=\"ui-link\" onclick=\"${this.onStartMergeButtonClick.bind(this)}\">${Loc.getMessage('CRM_DP_AUTOSEARCH_COMPLETE_RESOLVE_CONFLICT_BUTTON')}</span>\n\t\t\t\t</span>\n\t\t\t</div>`;\n\t}\n\n\tgetShortTimeout()\n\t{\n\t\treturn Math.round(Math.random() * 5000) + 500;\n\t}\n\n\tgetLongTimeout()\n\t{\n\t\treturn Math.floor(Math.random() * 10000) + 30000;\n\t}\n\n\topenDedupeList()\n\t{\n\t\tlet url = BX.util.add_url_param(this._dedupeListUrl, {'is_automatic': 'yes'});\n\t\tBX.Crm.Page.openSlider(url);\n\t}\n\n\topenMerger()\n\t{\n\t\tlet url = BX.util.add_url_param(this._mergerUrl, {'is_automatic': 'yes'});\n\t\tBX.Crm.Page.openSlider(url);\n\t\tthis.bindMergerSliderEvent();\n\t}\n\n\ttoggleIntervalsList(e)\n\t{\n\t\tif (this._isDropdownMenuShown)\n\t\t{\n\t\t\tthis.closeDropdownMenu();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.showDropdownMenu(e.target);\n\t\t}\n\t}\n\n\tshowDropdownMenu(bindElement)\n\t{\n\t\tif (this._isDropdownMenuShown || !bindElement)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet menu = [];\n\t\tfor (let i = 0; i < this._intervalsList.length; i++)\n\t\t{\n\t\t\tmenu.push(\n\t\t\t\t{\n\t\t\t\t\ttext: this._intervalsList[i].title,\n\t\t\t\t\tvalue: this._intervalsList[i].value,\n\t\t\t\t\tonclick: this.onSelectInterval.bind(this, this._intervalsList[i].value)\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\n\t\tMenuManager.show(\n\t\t\t'autosearch-settings-intervals-dropdown',\n\t\t\tbindElement,\n\t\t\tmenu,\n\t\t\t{\n\t\t\t\twidth: bindElement.offsetWidth,\n\t\t\t\tangle: false,\n\t\t\t\tcacheable: false,\n\t\t\t\tevents:\n\t\t\t\t\t{\n\t\t\t\t\t\tonPopupShow: () =>\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis._isDropdownMenuShown = true;\n\t\t\t\t\t\t},\n\t\t\t\t\t\tonPopupClose: () =>\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis._isDropdownMenuShown = false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t}\n\t\t);\n\t}\n\n\tcloseDropdownMenu()\n\t{\n\t\tif (!this._isDropdownMenuShown)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet menu = MenuManager.getMenuById('autosearch-settings-intervals-dropdown');\n\t\tif (menu)\n\t\t{\n\t\t\tmenu.popupWindow.close();\n\t\t}\n\t}\n\n\taskIfNoActiveMerging(timeout, callback)\n\t{\n\t\tclearTimeout(this._mergeCheckerTimeoutId);\n\t\tthis._mergeCheckerTimeoutId = setTimeout(() =>\n\t\t{\n\t\t\tthis._internalMergeStatus = 'ready';\n\t\t\t// ask another tabs\n\t\t\tBX.localStorage.set(\n\t\t\t\t\"BX.Crm.onCrmEntityAutosearchStartMerge\",\n\t\t\t\t{\n\t\t\t\t\tentityTypeId: this._entityTypeId,\n\t\t\t\t\tinstanceId: this._instanceId\n\t\t\t\t},\n\t\t\t\t5\n\t\t\t);\n\t\t\tthis._mergeCheckerTimeoutId = setTimeout(() =>\n\t\t\t{\n\t\t\t\t// if another tabs don't change status\n\t\t\t\tif (this._internalMergeStatus === 'ready')\n\t\t\t\t{\n\t\t\t\t\t// we can start merging\n\t\t\t\t\tthis._internalMergeStatus = 'merging';\n\t\t\t\t\tcallback();\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t// if there is another tab with active merging, try to wait ~30 sec\n\t\t\t\t\tthis.askIfNoActiveMerging(this.getLongTimeout(), callback);\n\t\t\t\t}\n\t\t\t}, 5000);\n\t\t}, timeout);\n\t}\n\n\tbindMergerSliderEvent()\n\t{\n\t\tconst slider = BX.Crm.Page.getTopSlider();\n\t\tif (!slider)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tEventEmitter.subscribe(slider, \"SidePanel.Slider:onCloseStart\", this.onCloseMergeSlider.bind(this));\n\t}\n\n\tonExternalEvent(event)\n\t{\n\t\tlet dataArray = event.getData();\n\t\tif (!Type.isArray(dataArray))\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tlet data = dataArray[0];\n\n\t\tlet eventName = BX.prop.getString(data, \"key\", \"\");\n\n\t\tif (eventName === \"BX.Crm.onCrmEntityAutosearchStartMerge\" ||\n\t\t\teventName === \"BX.Crm.onCrmEntityAutosearchMergeStatusNotify\")\n\t\t{\n\t\t\tlet value = BX.prop.getObject(data, \"value\", {});\n\t\t\tlet entityTypeId = BX.prop.getInteger(value, \"entityTypeId\", 0);\n\t\t\tif (entityTypeId !== this._entityTypeId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tlet instanceId = BX.prop.getString(value, \"instanceId\", \"\");\n\n\t\t\tif (eventName === \"BX.Crm.onCrmEntityAutosearchStartMerge\")\n\t\t\t{\n\t\t\t\tif (instanceId !== this._instanceId && this._internalMergeStatus !== 'waiting')  // event from another tab\n\t\t\t\t{\n\t\t\t\t\tif (instanceId < this._instanceId || this._internalMergeStatus === 'merging')\n\t\t\t\t\t// notify only if current instance is already merging or if current instanceId is lower then another ready candidate\n\t\t\t\t\t{\n\t\t\t\t\t\tBX.localStorage.set(\n\t\t\t\t\t\t\t\"BX.Crm.onCrmEntityAutosearchMergeStatusNotify\",\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tentityTypeId: this._entityTypeId,\n\t\t\t\t\t\t\t\tinstanceId: instanceId,\n\t\t\t\t\t\t\t\tstatus: this._internalMergeStatus\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis._internalMergeStatus = 'waiting';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (eventName === \"BX.Crm.onCrmEntityAutosearchMergeStatusNotify\")\n\t\t\t{\n\t\t\t\tif (instanceId === this._instanceId)\n\t\t\t\t{\n\t\t\t\t\t// another tab canceled this merging\n\t\t\t\t\tthis._internalMergeStatus = 'waiting';\n\t\t\t\t}\n\n\t\t\t}\n\t\t}\n\t}\n\n\tonStartMergeButtonClick()\n\t{\n\t\tconst popup = PopupManager.getPopupById(this._settingsPopupId);\n\t\tif (popup && popup.isShown())\n\t\t{\n\t\t\tpopup.close();\n\t\t}\n\t\tthis.openMerger();\n\t}\n\n\tonSelectInterval(interval)\n\t{\n\t\tthis._selectedExecInterval = interval;\n\t\tif (Type.isDomNode(this._selectedExecIntervalNode))\n\t\t{\n\t\t\tthis._selectedExecIntervalNode.textContent =\n\t\t\t\tthis._intervalsList.reduce((prev, item) => (item.value === this._selectedExecInterval ? item.title : prev), '');\n\t\t}\n\t\tthis.closeDropdownMenu();\n\t}\n\n\tonHintClick()\n\t{\n\t\tif (this._infoHelperId)\n\t\t{\n\t\t\tBX.Helper.show(\"redirect=detail&code=\"+this._infoHelperId);\n\t\t}\n\t}\n\n\tonCloseMergeSlider(event)\n\t{\n\t\tif (top.BX.CRM && top.BX.CRM.Kanban)\n\t\t{\n\t\t\tvar kanban = top.BX.CRM.Kanban.Grid.getInstance();\n\t\t\tif (kanban)\n\t\t\t{\n\t\t\t\tkanban.reload();\n\t\t\t}\n\t\t}\n\t\tif (top.BX.Main.gridManager)\n\t\t{\n\t\t\tvar gridId = 'CRM_' +  BX.CrmEntityType.resolveName(this._entityTypeId) + '_LIST_V12'; // does not support deal categories\n\t\t\tvar grid = top.BX.Main.gridManager.getInstanceById(gridId);\n\t\t\tif (grid)\n\t\t\t{\n\t\t\t\tgrid.reload();\n\t\t\t}\n\t\t}\n\t}\n\n\tstatic create(params)\n\t{\n\t\tlet autosearch = new DedupeAutosearch();\n\t\tautosearch.initialize(params);\n\t\treturn autosearch;\n\t}\n\n\tstatic setDefault(instance, entityTypeName)\n\t{\n\t\tif (!Type.isObject(DedupeAutosearch.defaultInstance))\n\t\t{\n\t\t\tDedupeAutosearch.defaultInstance = {};\n\t\t}\n\t\tDedupeAutosearch.defaultInstance[entityTypeName] = instance\n\t}\n\n\tstatic getDefault(entityTypeName)\n\t{\n\t\treturn DedupeAutosearch.defaultInstance[entityTypeName];\n\t}\n}\n\n\nnamespace.DedupeAutosearch = DedupeAutosearch;"],"names":["namespace","Reflection","DedupeAutosearch","_componentName","_componentSignedParams","_entityTypeId","_instanceId","_internalMergeStatus","_mergeCheckerTimeoutId","_mergerUrl","_dedupeListUrl","_execInterval","_intervalsList","_isDropdownMenuShown","_selectedExecInterval","_selectedExecIntervalNode","_status","_infoHelperId","_progressData","_settingsPopupId","params","BX","prop","getString","getInteger","Text","getRandom","getArray","getObject","tryToStartMerge","subscribeEvents","PULL","subscribe","type","PullClient","SubscriptionType","Server","moduleId","command","callback","notification","UI","Notification","Center","getBalloonById","close","data","clearTimeout","showMergeCompleteNotification","EventEmitter","onExternalEvent","bind","popup","PopupManager","create","id","cacheable","titleBar","Loc","getMessage","content","needLoadConflictsCount","getSettingsPopupLoader","getSettingsPopupContent","closeByEsc","closeIcon","draggable","width","buttons","SaveButton","onclick","saveSelectedExecInterval","CancelButton","show","loadConflictsCount","then","conflictsCount","setContent","adjustPosition","immediately","showStartConfirmation","startMerging","getShortTimeout","getBoolean","entityTypeName","CrmEntityType","resolveName","foundItemsCount","totalEntitiesCount","notificationContent","Tag","render","replace","onHintClick","notify","autoHide","actions","title","events","click","event","balloon","action","showSettings","onOpen","getBalloon","Hint","init","getContainer","successCount","message","automaticallyFoundText","Dom","append","notificationWidth","push","openMerger","ajax","runComponentAction","mode","signedParameters","interval","timeout","p","Promise","resolve","reject","askIfNoActiveMerging","doMerge","mergeId","response","instanceId","status","window","setTimeout","getLongTimeout","loaderContainer","style","height","loader","Loader","target","selectedExecInterval","reduce","prev","item","value","getConflictsInfo","toggleIntervalsList","onStartMergeButtonClick","Math","round","random","floor","url","util","add_url_param","Crm","Page","openSlider","bindMergerSliderEvent","e","closeDropdownMenu","showDropdownMenu","bindElement","menu","i","length","text","onSelectInterval","MenuManager","offsetWidth","angle","onPopupShow","onPopupClose","getMenuById","popupWindow","localStorage","set","entityTypeId","slider","getTopSlider","onCloseMergeSlider","dataArray","getData","Type","isArray","eventName","getPopupById","isShown","isDomNode","textContent","Helper","top","CRM","Kanban","kanban","Grid","getInstance","reload","Main","gridManager","gridId","grid","getInstanceById","autosearch","initialize","instance","isObject","defaultInstance"],"mappings":"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"}