(function(e,t,n,i,r,a){"use strict";var s,o,l,c,u,g,p,d;var h=i.Reflection.namespace("BX.Crm");var _=function(){function e(){babelHelpers.classCallCheck(this,e);this._componentName="";this._componentSignedParams="";this._entityTypeId=0;this._instanceId="";this._internalMergeStatus="";this._mergeCheckerTimeoutId=null;this._mergerUrl="";this._dedupeListUrl="";this._execInterval=null;this._intervalsList=[];this._isDropdownMenuShown=false;this._selectedExecInterval=null;this._selectedExecIntervalNode=null;this._status="";this._infoHelperId="";this._progressData={};this._settingsPopupId="autosearch-settings-popup"}babelHelpers.createClass(e,[{key:"initialize",value:function e(t){this._componentName=BX.prop.getString(t,"componentName","");this._componentSignedParams=BX.prop.getString(t,"signedParameters","");this._entityTypeId=BX.prop.getInteger(t,"entityTypeId",0);this._instanceId=BX.Text.getRandom(8);this._internalMergeStatus="waiting";this._mergerUrl=BX.prop.getString(t,"mergerUrl","");this._dedupeListUrl=BX.prop.getString(t,"dedupeListUrl","");this._execInterval=BX.prop.getString(t,"selectedInterval","0");this._intervalsList=BX.prop.getArray(t,"intervals",[]);this._status=BX.prop.getString(t,"status","");this._infoHelperId=BX.prop.getString(t,"infoHelperId","");this._progressData=BX.prop.getObject(t,"progressData",{});this.tryToStartMerge(true);this.subscribeEvents()}},{key:"subscribeEvents",value:function e(){var n=this;if(BX.PULL){BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"crm",command:"dedupe.autosearch.startMerge",callback:function e(i){if(BX.prop.getInteger(i,"entityTypeId",0)===n._entityTypeId){n._status=BX.prop.getString(i,"status","");n._progressData=BX.prop.getObject(i,"progressData",{});if(n._status==="MERGING"){var r=t.UI.Notification.Center.getBalloonById("crm.autosearch.start_merge");if(r){r.close()}}n.tryToStartMerge()}}});BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"crm",command:"dedupe.autosearch.mergeComplete",callback:function e(t){if(BX.prop.getInteger(t,"entityTypeId",0)===n._entityTypeId){var i=BX.prop.getObject(t,"data",{});n._status=BX.prop.getInteger(i,"CONFLICT_COUNT",0)>0?"CONFLICTS_RESOLVING":"";clearTimeout(n._mergeCheckerTimeoutId);n.showMergeCompleteNotification(i)}}})}r.EventEmitter.subscribe("onLocalStorageSet",this.onExternalEvent.bind(this))}},{key:"showSettings",value:function e(){var t=this;this._selectedExecInterval=this._execInterval;var r=n.PopupManager.create({id:this._settingsPopupId,cacheable:false,titleBar:i.Loc.getMessage("CRM_DP_AUTOSEARCH_SETTINGS_TITLE"),content:this.needLoadConflictsCount()?this.getSettingsPopupLoader():this.getSettingsPopupContent(),closeByEsc:true,closeIcon:true,draggable:true,width:500,buttons:[new BX.UI.SaveButton({onclick:function e(){r.close();t.saveSelectedExecInterval()}}),new BX.UI.CancelButton({onclick:function e(){r.close()}})]});r.show();if(this.needLoadConflictsCount()){this.loadConflictsCount().then((function(e){r.setContent(t.getSettingsPopupContent(e));r.adjustPosition()}),(function(){r.setContent(t.getSettingsPopupContent(0));r.adjustPosition()}))}}},{key:"tryToStartMerge",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(this._status==="READY_TO_MERGE"){this.showStartConfirmation()}if(this._status==="MERGING"){this.startMerging(t?1:this.getShortTimeout())}if(this._status==="CONFLICTS_RESOLVING"){this.showMergeCompleteNotification(this._progressData)}}},{key:"showStartConfirmation",value:function e(){var n=this;if(!BX.prop.getBoolean(this._progressData,"SHOW_NOTIFICATION",true)){return}var r=BX.CrmEntityType.resolveName(this._entityTypeId);var a=BX.prop.getInteger(this._progressData,"FOUND_ITEMS",0);var o=BX.prop.getInteger(this._progressData,"TOTAL_ENTITIES",0);var l=i.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<span>\n\t\t\t\t","\n\t\t\t\t<br>\n\t\t\t\t",'\n\t\t\t\t<span class="ui-hint notification-hint-inline">\n\t\t\t\t\t<span class="ui-hint-icon" onclick="','"></span>\n\t\t\t\t</span>\n\t\t\t</span>'])),i.Loc.getMessage("CRM_DP_AUTOSEARCH_START_CONFIRMATION_TEXT_"+r).replace("#FOUND_ITEMS_COUNT#",a).replace("#TOTAL_ENTITIES_COUNT#",o),i.Loc.getMessage("CRM_DP_AUTOSEARCH_START_CONFIRMATION_TEXT"),this.onHintClick.bind(this));t.UI.Notification.Center.notify({content:l,autoHide:false,id:"crm.autosearch.start_merge",width:600,actions:[{title:i.Loc.getMessage("CRM_DP_AUTOSEARCH_START_CONFIRMATION_BUTTON"),events:{click:function e(t,i,r){n.showSettings();i.close()}}}],events:{onOpen:function e(t){var n=t.getBalloon();BX.UI.Hint.init(n.getContainer())}}})}},{key:"showMergeCompleteNotification",value:function e(n){var r=this;if(!BX.prop.getBoolean(n,"SHOW_NOTIFICATION",true)){return}var a=BX.CrmEntityType.resolveName(this._entityTypeId);var s=BX.prop.getInteger(n,"SUCCESS_COUNT",0);var u=BX.prop.getInteger(n,"CONFLICT_COUNT",0);if(s===0&&u===0){return}var g=i.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(["<div></div>"])));var p=s>0?i.Loc.getMessage("CRM_DP_AUTOSEARCH_COMPLETE_TEXT_"+a).replace("#FOUND_ITEMS_COUNT#",s):i.Loc.getMessage("CRM_DP_AUTOSEARCH_EMPTY_RESULTS_"+a);i.Dom.append(i.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(["<div>","</div>"])),p),g);var d=[];var h=400;if(u>0){i.Dom.append(i.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(["<div>","</div>"])),i.Loc.getMessage("CRM_DP_AUTOSEARCH_COMPLETE_CONFLICTED_TEXT").replace("#CONFLICTS_COUNT#",u)),g);d.push({title:i.Loc.getMessage("CRM_DP_AUTOSEARCH_COMPLETE_RESOLVE_CONFLICT_BUTTON"),events:{click:function e(t,n,i){r.openMerger();n.close()}}});h=670}t.UI.Notification.Center.notify({content:g,autoHide:false,id:"crm.autosearch.merge_complete",width:h,actions:d})}},{key:"saveSelectedExecInterval",value:function e(){this._execInterval=this._selectedExecInterval;BX.ajax.runComponentAction(this._componentName,"setExecInterval",{mode:"class",signedParameters:this._componentSignedParams,data:{interval:this._selectedExecInterval}})}},{key:"startMerging",value:function e(t){var n=this;var i=new Promise((function(e,i){n.askIfNoActiveMerging(t,e)}));i.then((function(){return n.doMerge()}))}},{key:"doMerge",value:function e(){var t=this;BX.ajax.runComponentAction(this._componentName,"merge",{mode:"class",signedParameters:this._componentSignedParams,data:{mergeId:this._instanceId}}).then((function(e){var n=BX.prop.getObject(e,"data",{});var i=BX.prop.getString(n,"MERGE_ID","");if(i===t._instanceId){var r=BX.prop.getString(n,"STATUS","");if(r!=="COMPLETED"){window.setTimeout((function(){return t.doMerge()}),400)}}else{t.startMerging(t.getLongTimeout())}}),(function(e){t.startMerging(t.getShortTimeout())}))}},{key:"getSettingsPopupLoader",value:function e(){var t=i.Tag.render(u||(u=babelHelpers.taggedTemplateLiteral(["<div></div>"])));t.style.height="180px";var n=new a.Loader({target:t});setTimeout((function(){n.show()}),10);return t}},{key:"getSettingsPopupContent",value:function e(t){var n=this;var r=this._intervalsList.reduce((function(e,t){return t.value===n._selectedExecInterval?t.title:e}),"");this._selectedExecIntervalNode=i.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(['<div class="ui-ctl-element">',"</div>"])),r);return i.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div>\n\t\t\t\t","\n\t\t\t\t<p>",'</p>\n\t\t\t\t<div class="ui-ctl-label-text">','</div>\n\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100" onclick="','">\n\t\t\t\t\t','\n\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),this.getConflictsInfo(t),i.Loc.getMessage("CRM_DP_AUTOSEARCH_SETTINGS_NOTE"),i.Loc.getMessage("CRM_DP_AUTOSEARCH_SETTINGS_INTERVAL_TITLE"),this.toggleIntervalsList.bind(this),this._selectedExecIntervalNode)}},{key:"needLoadConflictsCount",value:function e(){return this._status==="CONFLICTS_RESOLVING"}},{key:"loadConflictsCount",value:function e(){return BX.ajax.runComponentAction(this._componentName,"getStatistic",{mode:"class",signedParameters:this._componentSignedParams}).then((function(e){var t=BX.prop.getObject(e,"data",{});return BX.prop.getInteger(t,"conflictsCount",0)}))}},{key:"getConflictsInfo",value:function e(t){if(!this.needLoadConflictsCount()){return""}if(t<=0){return""}return i.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-alert ui-alert-warning">\n\t\t\t\t<span class="ui-alert-message">\n\t\t\t\t\t','\n\t\t\t\t\t<span class="ui-link" onclick="','">',"</span>\n\t\t\t\t</span>\n\t\t\t</div>"])),i.Loc.getMessage("CRM_DP_AUTOSEARCH_SETTINGS_CONFLICTS_FOUND").replace("#CONFLICTS_COUNT#",t),this.onStartMergeButtonClick.bind(this),i.Loc.getMessage("CRM_DP_AUTOSEARCH_COMPLETE_RESOLVE_CONFLICT_BUTTON"))}},{key:"getShortTimeout",value:function e(){return Math.round(Math.random()*5e3)+500}},{key:"getLongTimeout",value:function e(){return Math.floor(Math.random()*1e4)+3e4}},{key:"openDedupeList",value:function e(){var t=BX.util.add_url_param(this._dedupeListUrl,{is_automatic:"yes"});BX.Crm.Page.openSlider(t)}},{key:"openMerger",value:function e(){var t=BX.util.add_url_param(this._mergerUrl,{is_automatic:"yes"});BX.Crm.Page.openSlider(t);this.bindMergerSliderEvent()}},{key:"toggleIntervalsList",value:function e(t){if(this._isDropdownMenuShown){this.closeDropdownMenu()}else{this.showDropdownMenu(t.target)}}},{key:"showDropdownMenu",value:function e(t){var i=this;if(this._isDropdownMenuShown||!t){return}var r=[];for(var a=0;a<this._intervalsList.length;a++){r.push({text:this._intervalsList[a].title,value:this._intervalsList[a].value,onclick:this.onSelectInterval.bind(this,this._intervalsList[a].value)})}n.MenuManager.show("autosearch-settings-intervals-dropdown",t,r,{width:t.offsetWidth,angle:false,cacheable:false,events:{onPopupShow:function e(){i._isDropdownMenuShown=true},onPopupClose:function e(){i._isDropdownMenuShown=false}}})}},{key:"closeDropdownMenu",value:function e(){if(!this._isDropdownMenuShown){return}var t=n.MenuManager.getMenuById("autosearch-settings-intervals-dropdown");if(t){t.popupWindow.close()}}},{key:"askIfNoActiveMerging",value:function e(t,n){var i=this;clearTimeout(this._mergeCheckerTimeoutId);this._mergeCheckerTimeoutId=setTimeout((function(){i._internalMergeStatus="ready";BX.localStorage.set("BX.Crm.onCrmEntityAutosearchStartMerge",{entityTypeId:i._entityTypeId,instanceId:i._instanceId},5);i._mergeCheckerTimeoutId=setTimeout((function(){if(i._internalMergeStatus==="ready"){i._internalMergeStatus="merging";n()}else{i.askIfNoActiveMerging(i.getLongTimeout(),n)}}),5e3)}),t)}},{key:"bindMergerSliderEvent",value:function e(){var t=BX.Crm.Page.getTopSlider();if(!t){return}r.EventEmitter.subscribe(t,"SidePanel.Slider:onCloseStart",this.onCloseMergeSlider.bind(this))}},{key:"onExternalEvent",value:function e(t){var n=t.getData();if(!i.Type.isArray(n)){return}var r=n[0];var a=BX.prop.getString(r,"key","");if(a==="BX.Crm.onCrmEntityAutosearchStartMerge"||a==="BX.Crm.onCrmEntityAutosearchMergeStatusNotify"){var s=BX.prop.getObject(r,"value",{});var o=BX.prop.getInteger(s,"entityTypeId",0);if(o!==this._entityTypeId){return}var l=BX.prop.getString(s,"instanceId","");if(a==="BX.Crm.onCrmEntityAutosearchStartMerge"){if(l!==this._instanceId&&this._internalMergeStatus!=="waiting"){if(l<this._instanceId||this._internalMergeStatus==="merging"){BX.localStorage.set("BX.Crm.onCrmEntityAutosearchMergeStatusNotify",{entityTypeId:this._entityTypeId,instanceId:l,status:this._internalMergeStatus},5)}else{this._internalMergeStatus="waiting"}}}if(a==="BX.Crm.onCrmEntityAutosearchMergeStatusNotify"){if(l===this._instanceId){this._internalMergeStatus="waiting"}}}}},{key:"onStartMergeButtonClick",value:function e(){var t=n.PopupManager.getPopupById(this._settingsPopupId);if(t&&t.isShown()){t.close()}this.openMerger()}},{key:"onSelectInterval",value:function e(t){var n=this;this._selectedExecInterval=t;if(i.Type.isDomNode(this._selectedExecIntervalNode)){this._selectedExecIntervalNode.textContent=this._intervalsList.reduce((function(e,t){return t.value===n._selectedExecInterval?t.title:e}),"")}this.closeDropdownMenu()}},{key:"onHintClick",value:function e(){if(this._infoHelperId){BX.Helper.show("redirect=detail&code="+this._infoHelperId)}}},{key:"onCloseMergeSlider",value:function e(t){if(top.BX.CRM&&top.BX.CRM.Kanban){var n=top.BX.CRM.Kanban.Grid.getInstance();if(n){n.reload()}}if(top.BX.Main.gridManager){var i="CRM_"+BX.CrmEntityType.resolveName(this._entityTypeId)+"_LIST_V12";var r=top.BX.Main.gridManager.getInstanceById(i);if(r){r.reload()}}}}],[{key:"create",value:function t(n){var i=new e;i.initialize(n);return i}},{key:"setDefault",value:function t(n,r){if(!i.Type.isObject(e.defaultInstance)){e.defaultInstance={}}e.defaultInstance[r]=n}},{key:"getDefault",value:function t(n){return e.defaultInstance[n]}}]);return e}();h.DedupeAutosearch=_;e.DedupeAutosearch=_})(this.window=this.window||{},BX,BX.Main,BX,BX.Event,BX);
//# sourceMappingURL=script.map.js