BX.namespace("BX.Crm");if(typeof BX.Crm.DedupeWizard==="undefined"){BX.Crm.DedupeWizard=function(){this._id="";this._settings={};this._entityTypeId=0;this._steps={};this._config={};this._typeInfos={};this._currentScope="";this._scopeInfos={};this._contextId="";this._totalItemCount=0;this._totalEntityCount=0;this._mergedItemCount=0;this._mergedEntityCount=0;this._conflictedItemCount=0;this._conflictedEntityCount=0;this._resolvedItemCount=0;this._dedupeSettingsPath="";this._enableCloseConfirmation=false;this._enableEntityListReload=false};BX.Crm.DedupeWizard.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",0);this._currentScope=BX.prop.getString(this._settings,"currentScope","");this._scopeInfos=BX.prop.getObject(this._settings,"scopeInfos",{});this._contextId=BX.prop.getString(this._settings,"contextId","");this._typeInfos=BX.prop.getObject(this._settings,"typeInfos",{});this._config=BX.prop.getObject(this._settings,"config",{});this._indexAgentState=BX.prop.getObject(this._settings,"indexAgentState",{});this._mergeAgentState=BX.prop.getObject(this._settings,"mergeAgentState",{});this._dedupeSettingsPath=BX.prop.getString(this._settings,"dedupeSettingsPath","");this._mergeMode="auto";this._steps=BX.prop.getObject(this._settings,"steps",{});for(var i in this._steps){if(!this._steps.hasOwnProperty(i)){continue}this._steps[i].setWizard(this)}this.bindSliderEvents()},getId:function(){return this._id},getEntityTypeId:function(){return this._entityTypeId},getEntityTypeName:function(){return BX.CrmEntityType.resolveName(this._entityTypeId)},getConfig:function(){return BX.clone(this._config)},setConfig:function(t){this._config=t;BX.onCustomEvent(this,"onConfigChange")},getIndexAgentState:function(){return this._indexAgentState},clearMergeAgentState:function(){return this._mergeAgentState={}},setIndexAgentState:function(t){this._indexAgentState=t;BX.onCustomEvent(this,"onSetIndexAgentState")},getMergeAgentState:function(){return this._mergeAgentState},setMergeAgentState:function(t){this._mergeAgentState=t;BX.onCustomEvent(this,"onSetMergeAgentState")},getMessage:function(t){return BX.prop.getString(BX.Crm.DedupeWizard.messages,t,t)},restart:function(){this._steps["scanning"].restart()},getContextId:function(){return this._contextId},getCurrentScope:function(){return this._currentScope},getScopeInfos:function(){return this._scopeInfos},getTypeInfos:function(){return this._typeInfos},layout:function(){this._steps["scanning"].start()},getMergerUrl:function(){return BX.prop.getString(this._settings,"mergerUrl","")},getDedupeListUrl:function(){return BX.prop.getString(this._settings,"dedupeListUrl","")},getTotalItemCount:function(){return this._totalItemCount},setTotalItemCount:function(t){this._totalItemCount=t},getTotalEntityCount:function(){return this._totalEntityCount},setTotalEntityCount:function(t){this._totalEntityCount=t},getMergedItemCount:function(){return this._mergedItemCount},setMergedItemCount:function(t){this._mergedItemCount=t},getMergedEntityCount:function(){return this._mergedEntityCount},setMergedEntityCount:function(t){this._mergedEntityCount=t},getConflictedItemCount:function(){return this._conflictedItemCount},setConflictedItemCount:function(t){this._conflictedItemCount=t},getConflictedEntityCount:function(){return this._conflictedEntityCount},setConflictedEntityCount:function(t){this._conflictedEntityCount=t},getDedupeSettingsPath:function(){return this._dedupeSettingsPath},calculateEntityCount:function(t){if(!BX.type.isArray(t)){return}var e={};for(var i=0,n=t.length;i<n;i++){var r=t[i];var s=BX.prop.getInteger(r,"ROOT_ENTITY_ID",0);if(s>0){e[s.toString()]=true}var o=BX.prop.getArray(r,"ENTITY_IDS",[]);for(var a=0;a<o.length;a++){e[o[a].toString()]=true}}return Object.keys(e).length},getResolvedItemCount:function(){return this._resolvedItemCount},setResolvedItemCount:function(t){this._resolvedItemCount=t},getUnResolvedItemCount:function(){return this._conflictedItemCount-this._resolvedItemCount},setMergeMode:function(t){this._mergeMode=t;for(var e in this._steps){var i=this._steps[e];var n=BX(i.getId());if(n){n.classList.remove("crm-dedupe-wizard-container-merge-auto");n.classList.remove("crm-dedupe-wizard-container-merge-manual");n.classList.add("crm-dedupe-wizard-container-merge-"+t)}}},getMergeMode:function(){return this._mergeMode},openDedupeList:function(){var t={scope:BX.prop.getString(this._config,"scope",""),typeNames:BX.prop.getArray(this._config,"typeNames",[])};BX.Crm.Page.open(BX.util.add_url_param(this.getDedupeListUrl(),t))},openMerger:function(t){var e={scope:BX.prop.getString(this._config,"scope",""),typeNames:BX.prop.getArray(this._config,"typeNames",[]),externalContextId:t};BX.Crm.Page.open(BX.util.add_url_param(this.getMergerUrl(),e))},enableCloseConfirmation:function(t){this._enableCloseConfirmation=!!t},enableEntityListReload:function(t){this._enableEntityListReload=!!t},bindSliderEvents:function(){BX.addCustomEvent("SidePanel.Slider:onClose",this.onSliderClose.bind(this))},reloadEntityList:function(){if(top.BX.CRM&&top.BX.CRM.Kanban){var t=top.BX.CRM.Kanban.Grid.getInstance();if(t){t.reload()}}if(top.BX.Main.gridManager){var e="CRM_"+this.getEntityTypeName()+"_LIST_V12";var i=top.BX.Main.gridManager.getInstanceById(e);if(i){i.reload()}}},onSliderClose:function(t){var e=top.BX.SidePanel.Instance.getSliderByWindow(window);if(e!==t.getSlider()){return}if(!e.isOpen()){return}if(!this._enableCloseConfirmation){if(this._enableEntityListReload){this.reloadEntityList()}return}t.denyAction();var i=BX.Main.PopupManager.getPopupById("dedupe_wizard_close_confirmation");if(!i){i=BX.Main.PopupManager.create({id:"dedupe_wizard_close_confirmation",content:this.getMessage("closeConfirmationText"),titleBar:this.getMessage("closeConfirmationTitle"),buttons:[new BX.UI.CloseButton({color:BX.UI.ButtonColor.SUCCESS,events:{click:function(t){t.getContext().close();this._enableCloseConfirmation=false;top.BX.SidePanel.Instance.getSliderByWindow(window).close()}.bind(this)}}),new BX.UI.CancelButton({events:{click:function(t){t.getContext().close()}.bind(this)}})]})}i.show()},onStepStart:function(t){},onStepEnd:function(t){var e=t.getNextStepId();if(!(e!==""&&this._steps.hasOwnProperty(e))){return}this._steps[e].start()}};if(typeof BX.Crm.DedupeWizard.messages==="undefined"){BX.Crm.DedupeWizard.messages={}}BX.Crm.DedupeWizard.create=function(t,e){var i=new BX.Crm.DedupeWizard;i.initialize(t,e);return i}}if(typeof BX.Crm.DedupeWizardStep==="undefined"){BX.Crm.DedupeWizardStep=function(){this._id="";this._settings={};this._wizard=null;this._progressBar=null};BX.Crm.DedupeWizardStep.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._wizard=BX.prop.get(this._settings,"wizard")},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.prop.getObject(this._settings,"messages",{}),t,t)},getNextStepId:function(){return BX.prop.getString(this._settings,"nextStepId","")},setWizard:function(t){this._wizard=t},getWizard:function(){return this._wizard},getWrapper:function(){return BX(BX.prop.getString(this._settings,"wrapperId"))},getTitleWrapper:function(){return BX(BX.prop.getString(this._settings,"titleWrapperId"))},getSubtitleWrapper:function(){return BX(BX.prop.getString(this._settings,"subtitleWrapperId"))},prepareProgressBar:function(){if(!this._progressBar){this._progressBar=new BX.UI.ProgressBar({value:0,maxValue:100,color:BX.UI.ProgressBar.Color.SUCCESS,statusType:BX.UI.ProgressBar.Status.PERCENT,column:true})}this._progressBar.update(0);BX(BX.prop.getString(this._settings,"progressBarWrapperId")).appendChild(this._progressBar.getContainer())},setProgressBarValue:function(t){this._progressBar.update(t)},start:function(){this.getWrapper().style.display="";window.setTimeout(function(){this._wizard.onStepStart(this)}.bind(this),0)},goToScan:function(){this.getWrapper().style.display="none";this.deleteAgents();this._wizard.restart()},deleteAgents:function(){BX.ajax.runComponentAction("bitrix:crm.dedupe.wizard","deleteMergeBackground",{data:{entityTypeName:BX.CrmEntityType.resolveName(this._wizard.getEntityTypeId())}});BX.ajax.runComponentAction("bitrix:crm.dedupe.wizard","deleteRebuildIndexBackground",{data:{entityTypeName:BX.CrmEntityType.resolveName(this._wizard.getEntityTypeId())}})},end:function(){this.getWrapper().style.display="none";window.setTimeout(function(){this._wizard.onStepEnd(this)}.bind(this),0)}};BX.Crm.DedupeWizardStep.create=function(t,e){var i=new BX.Crm.DedupeWizardStep;i.initialize(t,e);return i}}if(typeof BX.Crm.DedupeWizardScanning==="undefined"){BX.Crm.DedupeWizardScanning=function(){BX.Crm.DedupeWizardScanning.superclass.constructor.apply(this);this._configHandler=BX.delegate(this.onConfigButtonClick,this);this._scanStartHandler=BX.delegate(this.onScanStartButtonClick,this);this._scanStopHandler=BX.delegate(this.onScanStopButtonClick,this);this._isScanRunning=false;BX.addCustomEvent(window,"SidePanel.Slider:onMessage",this.onSliderMessage.bind(this))};BX.extend(BX.Crm.DedupeWizardScanning,BX.Crm.DedupeWizardStep);BX.Crm.DedupeWizardScanning.prototype.start=function(){BX.Crm.DedupeWizardScanning.superclass.start.apply(this,arguments);this.layout()};BX.Crm.DedupeWizardScanning.prototype.restart=function(){BX.Crm.DedupeWizardScanning.superclass.start.apply(this,arguments);this.layoutBeforeStart()};BX.Crm.DedupeWizardScanning.prototype.layout=function(){var t=this.getIndexAgentState();var e=BX.prop.getString(t,"NEXT_STATUS","");var i=BX.prop.getString(t,"STATUS","");var n=BX.prop.getArray(this._wizard.getConfig(),"typeNames",[]);var r=false;if(e==="STATUS_UNDEFINED"){if(n.length<=0||i==="STATUS_INACTIVE"||i==="STATUS_STOPPED"){this.layoutBeforeStart();r=true}else if(i==="STATUS_FINISHED"){this._wizard.setTotalItemCount(BX.prop.getInteger(t,"FOUND_ITEMS",0));this._wizard.setTotalEntityCount(BX.prop.getInteger(t,"TOTAL_ENTITIES",0));window.setTimeout(function(){this.end()}.bind(this),0);r=true}}if(!r){this.layoutAfterStart()}};BX.Crm.DedupeWizardScanning.prototype.layoutAfterStart=function(){this.adjustConfigurationTitle();this.prepareProgressBar();BX(BX.prop.getString(this._settings,"buttonId")).style.display="none";document.body.querySelector(".crm-dedupe-wizard-start-control-box").classList.remove("crm-dedupe-wizard-start-control-box-default-state");document.body.querySelector(".crm-dedupe-wizard-start-icon-scanning").classList.add("crm-dedupe-wizard-start-icon-refresh-repeat-animation");this.setIsScanRunning(true);var t=this.getIndexAgentState();var e=BX.prop.getInteger(t,"TOTAL_ITEMS",0);var i=BX.prop.getInteger(t,"PROCESSED_ITEMS",0);if(i>0&&e>0){this.setProgressBarValue(100*i/e)}var n=BX(BX.prop.getString(this._settings,"stopButtonId"));if(n){n.style.display="";BX.bind(n,"click",this._scanStopHandler)}this.rebuildIndex(false)};BX.Crm.DedupeWizardScanning.prototype.layoutBeforeStart=function(){this.adjustConfigurationTitle();var t=document.body.querySelector(".crm-dedupe-wizard-start-control-box");var e=BX(BX.prop.getString(this._settings,"buttonId"));if(e){e.style.display="";t.classList.add("crm-dedupe-wizard-start-control-box-default-state");document.body.querySelector(".crm-dedupe-wizard-start-icon-scanning").classList.remove("crm-dedupe-wizard-start-icon-refresh-repeat-animation");BX.bind(e,"click",this._scanStartHandler)}var i=BX(BX.prop.getString(this._settings,"stopButtonId"));if(i){i.style.display="none";i.classList.remove("ui-btn-light");BX.bind(i,"click",this._scanStopHandler)}var n=BX(BX.prop.getString(this._settings,"configEditButtonId"));if(n){BX.bind(n,"click",this._configHandler)}BX.addCustomEvent(this._wizard,"onConfigChange",BX.delegate(this.onConfigChange,this))};BX.Crm.DedupeWizardScanning.prototype.adjustConfigurationTitle=function(){var t=BX(BX.prop.getString(this._settings,"configTitleId"));var e=BX(BX.prop.getString(this._settings,"configTitleTextId"));if(!t&&!e){return}var i=this._wizard.getTypeInfos();var n=this._wizard.getConfig();var r=BX.prop.getArray(n,"typeNames",[]);var s=BX.prop.getString(n,"scope","");var o=[];for(var a in i){if(!i.hasOwnProperty(a)){continue}var d=i[a];if(s===BX.prop.getString(d,"SCOPE")&&r.indexOf(BX.prop.getString(d,"NAME"))>=0){o.push(BX.prop.getString(d,"DESCRIPTION"))}}if(t){t.innerHTML=BX.util.htmlspecialchars(o.join(", "));BX.bind(t,"click",this._configHandler)}if(e){e.textContent=o.join(", ")}};BX.Crm.DedupeWizardScanning.prototype.setIsScanRunning=function(t){this._isScanRunning=!!t;var e=BX(BX.prop.getString(this._settings,"configEditModeContainer"));var i=BX(BX.prop.getString(this._settings,"configViewModeContainer"));if(t){e?e.style.display="none":null;i?i.style.display="":null}else{e?e.style.display="":null;i?i.style.display="none":null}};BX.Crm.DedupeWizardScanning.prototype.onConfigChange=function(){this.adjustConfigurationTitle()};BX.Crm.DedupeWizardScanning.prototype.onConfigButtonClick=function(t){t.preventDefault();if(this._isScanRunning){return}BX.SidePanel.Instance.open(this._wizard.getDedupeSettingsPath(),{allowChangeHistory:false,cacheable:false,width:600,requestMethod:"post",requestParams:{entityTypeId:this._wizard.getEntityTypeId(),guid:this._wizard.getId()}})};BX.Crm.DedupeWizardScanning.prototype.onScanStartButtonClick=function(t){if(this.rebuildIndex(true)){this.prepareProgressBar();BX(BX.prop.getString(this._settings,"buttonId")).style.display="none";BX(BX.prop.getString(this._settings,"stopButtonId")).style.display="";document.body.querySelector(".crm-dedupe-wizard-start-control-box").classList.remove("crm-dedupe-wizard-start-control-box-default-state");document.body.querySelector(".crm-dedupe-wizard-start-icon-scanning").classList.add("crm-dedupe-wizard-start-icon-refresh-repeat-animation")}};BX.Crm.DedupeWizardScanning.prototype.onScanStopButtonClick=function(t){this.stopRebuildIndex()};BX.Crm.DedupeWizardScanning.prototype.getNextStepId=function(){return this._wizard.getTotalItemCount()>0?"merging":"finish"};BX.Crm.DedupeWizardScanning.prototype.rebuildIndex=function(t){t=!!t;var e=this._wizard.getConfig();var i=BX.prop.getArray(e,"typeNames",[]);var n=BX.prop.getString(e,"scope","");if(i.length===0){BX.UI.Notification.Center.notify({content:this.getMessage("emptyConfig"),position:"top-center",autoHideDelay:5e3});return false}this.setIsScanRunning(true);BX.ajax.runComponentAction("bitrix:crm.dedupe.wizard","rebuildIndexBackground",{data:{entityTypeName:BX.CrmEntityType.resolveName(this._wizard.getEntityTypeId()),types:i,scope:n,tryStart:t?"Y":"N"}}).then(function(e){var i=e.data;var n=BX.prop.getString(i,"IS_ACTIVE","N")==="Y";var r=BX.prop.getString(i,"STATUS","");var s=r==="STATUS_INACTIVE"||r==="STATUS_PENDING_START"||r==="STATUS_RUNNING"||r==="STATUS_PENDING_STOP";if(t){this.clearMergeAgentState()}if(!n&&s){r="STATUS_STOPPED";s=false}if(s){window.setTimeout(function(){this.rebuildIndex(false)}.bind(this),3e3);if(r==="STATUS_RUNNING"||r==="STATUS_PENDING_STOP"){var o=BX.prop.getInteger(i,"TOTAL_ITEMS",0);var a=BX.prop.getInteger(i,"PROCESSED_ITEMS",0);if(a>0&&o>0){this.setProgressBarValue(100*a/o)}}}else if(r==="STATUS_FINISHED"||r==="STATUS_STOPPED"){if(r==="STATUS_FINISHED"){this.setProgressBarValue(100)}var d=BX(BX.prop.getString(this._settings,"stopButtonId"));if(d){d.style.display="none";BX.unbind(d,"click",this._scanStopHandler)}this._wizard.setTotalItemCount(BX.prop.getInteger(i,"FOUND_ITEMS",0));this._wizard.setTotalEntityCount(BX.prop.getInteger(i,"TOTAL_ENTITIES",0));this.setIsScanRunning(false);if(r==="STATUS_FINISHED"){window.setTimeout(function(){this.end()}.bind(this),200)}else if(r==="STATUS_STOPPED"){window.setTimeout(function(){this.restart()}.bind(this),200)}}}.bind(this)).catch(function(){this.setIsScanRunning(false)}.bind(this));return true};BX.Crm.DedupeWizardScanning.prototype.stopRebuildIndex=function(){var t=BX(BX.prop.getString(this._settings,"stopButtonId"));if(t){t.classList.add("ui-btn-light");BX.unbind(t,"click",this._scanStopHandler)}BX.ajax.runComponentAction("bitrix:crm.dedupe.wizard","stopRebuildIndexBackground",{data:{entityTypeName:BX.CrmEntityType.resolveName(this._wizard.getEntityTypeId())}}).then(function(t){var e=BX(BX.prop.getString(this._settings,"stopButtonId"));if(e){var i=BX.prop.getObject(t,"data",{});if(i["STATUS"]==="STATUS_INACTIVE"||i["STATUS"]==="STATUS_PENDING_STOP"||i["STATUS"]==="STATUS_STOPPED"||i["NEXT_STATUS"]==="STATUS_PENDING_STOP"){e.style.display="none"}else{e.classList.remove("ui-btn-light");BX.bind(e,"click",this._scanStopHandler)}}}.bind(this)).catch(function(){var t=BX(BX.prop.getString(this._settings,"stopButtonId"));if(t){t.classList.remove("ui-btn-light");BX.bind(t,"click",this._scanStopHandler)}}.bind(this));return true};BX.Crm.DedupeWizardScanning.prototype.onSliderMessage=function(t){if(t.getEventId()==="crm::onMergerSettingsChange"){var e=t.getData();this._wizard.setConfig(e.config)}};BX.Crm.DedupeWizardScanning.prototype.getIndexAgentState=function(){return this._wizard?this._wizard.getIndexAgentState():{}};BX.Crm.DedupeWizardScanning.prototype.clearMergeAgentState=function(){if(this._wizard){this._wizard.clearMergeAgentState()}};BX.Crm.DedupeWizardScanning.create=function(t,e){var i=new BX.Crm.DedupeWizardScanning;i.initialize(t,e);return i}}if(typeof BX.Crm.DedupeWizardMerging==="undefined"){BX.Crm.DedupeWizardMerging=function(){BX.Crm.DedupeWizardMerging.superclass.constructor.apply(this);this._totalItemCount=0;this._totalEntityCount=0;this._currentItemIndex=0;this._mergedItemCount=0;this._conflictedItemCount=0;this._returnToScanHandler=BX.delegate(this.onReturnToScanButtonClick,this);this._automaticMergeStartHandler=BX.delegate(this.onAutomaticMergeStartButtonClick,this);this._manualMergeStartHandler=BX.delegate(this.onManualMergeStartButtonClick,this);this._mergeStopHandler=BX.delegate(this.onMergeStopButtonClick,this)};BX.extend(BX.Crm.DedupeWizardMerging,BX.Crm.DedupeWizardStep);BX.Crm.DedupeWizardMerging.prototype.start=function(){this._totalItemCount=this._wizard.getTotalItemCount();this._totalEntityCount=this._wizard.getTotalEntityCount();this.layout();BX.Crm.DedupeWizardMerging.superclass.start.apply(this,arguments)};BX.Crm.DedupeWizardMerging.prototype.end=function(){BX.Crm.DedupeWizardMerging.superclass.end.apply(this,arguments)};BX.Crm.DedupeWizardMerging.prototype.layout=function(){var t=this.getMergeAgentState();var e=BX.prop.getString(t,"NEXT_STATUS","");var i=BX.prop.getString(t,"STATUS","");var n=(e==="STATUS_UNDEFINED"||e==="")&&(i==="STATUS_INACTIVE"||i==="STATUS_STOPPED"||i==="");var r=e==="STATUS_UNDEFINED"&&i==="STATUS_FINISHED";var s=e==="STATUS_UNDEFINED"&&i==="STATUS_STOPPED";var o=!(n||r||s);if(n){this.layoutBeforeStart()}else if(r){this.setMergeResult(t);window.setTimeout(function(){this.end()}.bind(this),0)}else if(o){var a=BX(this.getId()).querySelector(".crm-dedupe-wizard-start-control-box");var d=BX(BX.prop.getString(this._settings,"returnToScanButtonId"));var p=BX(BX.prop.getString(this._settings,"buttonId"));var g=BX(BX.prop.getString(this._settings,"alternateButtonId"));var u=document.body.querySelector(".crm-dedupe-wizard-start-icon-merging");if(p){if(a){a.classList.remove("crm-dedupe-wizard-start-control-box-default-state");a.classList.remove("crm-dedupe-wizard-start-control-box-ready-to-merge-state")}p.style.display="none";if(d){d.style.display="none"}if(g){g.style.display="none"}u.classList.add("crm-dedupe-wizard-start-icon-refresh-repeat-animation")}this.layoutAfterStart()}};BX.Crm.DedupeWizardMerging.prototype.prepareStopButton=function(t){var e=BX(BX.prop.getString(this._settings,"stopButtonId"));if(e){e.style.display=!!t?"":"none";BX.bind(e,"click",this._mergeStopHandler)}};BX.Crm.DedupeWizardMerging.prototype.layoutBeforeStart=function(){this.getTitleWrapper().innerHTML=this.getMessage("duplicatesFound").replace("#COUNT#",this._totalEntityCount);this.getSubtitleWrapper().innerHTML=this.getMessage("matchesFound").replace("#COUNT#",this._totalItemCount);var t=BX(this.getId()).querySelector(".crm-dedupe-wizard-start-control-box");var e=BX(BX.prop.getString(this._settings,"returnToScanButtonId"));var i=BX(BX.prop.getString(this._settings,"buttonId"));var n=BX(BX.prop.getString(this._settings,"alternateButtonId"));var r=BX(BX.prop.getString(this._settings,"stopButtonId"));var s=document.body.querySelector(".crm-dedupe-wizard-start-icon-merging");if(e){e.style.display="";BX.bind(e,"click",this._returnToScanHandler)}if(i){i.style.display="";t.classList.add("crm-dedupe-wizard-start-control-box-default-state");BX.bind(i,"click",this._automaticMergeStartHandler);BX.bind(i,"click",(function(){t.classList.remove("crm-dedupe-wizard-start-control-box-default-state");t.classList.remove("crm-dedupe-wizard-start-control-box-ready-to-merge-state");i.style.display="none";if(e){e.style.display="none"}if(n){n.style.display="none"}if(r){r.style.display=""}s.classList.add("crm-dedupe-wizard-start-icon-refresh-repeat-animation")}))}if(n){n.style.display="";BX.bind(n,"click",this._manualMergeStartHandler);BX.bind(n,"click",(function(){t.classList.remove("crm-dedupe-wizard-start-control-box-default-state");t.classList.remove("crm-dedupe-wizard-start-control-box-ready-to-merge-state");n.style.display="none";if(e){e.style.display="none"}if(i){i.style.display="none"}if(r){r.style.display="none"}s.classList.add("crm-dedupe-wizard-start-icon-refresh-repeat-animation")}))}var o=BX(BX.prop.getString(this._settings,"listButtonId"));if(o){o.style.display="";BX.bind(o,"click",this.onListButtonClick.bind(this))}this.prepareStopButton(false)};BX.Crm.DedupeWizardMerging.prototype.layoutAfterStart=function(t){t=!!t;this._currentItemIndex=0;this._wizard.setMergeMode("auto");this.prepareProgressBar();this.prepareStopButton(true);this.updateMergeProgress(this.getMergeAgentState());this.mergeBackground(t)};BX.Crm.DedupeWizardMerging.prototype.updateMergeProgress=function(t){this._mergedItemCount=BX.prop.getInteger(t,"MERGED_ITEMS",0);this._conflictedItemCount=BX.prop.getInteger(t,"CONFLICTED_ITEMS",0);this._currentItemIndex=BX.prop.getInteger(t,"PROCESSED_ITEMS",0);if(this._currentItemIndex>0&&this._totalItemCount>0){this.setProgressBarValue(100*this._currentItemIndex/this._totalItemCount)}};BX.Crm.DedupeWizardMerging.prototype.merge=function(t){var e=this._wizard.getConfig();var i=BX.prop.getArray(e,"typeNames",[]);var n=BX.prop.getString(e,"scope","");BX.ajax.runComponentAction("bitrix:crm.dedupe.wizard","merge",{data:{entityTypeName:BX.CrmEntityType.resolveName(this._wizard.getEntityTypeId()),types:i,scope:n,mode:this._wizard.getMergeMode()}}).then(function(t){var e=BX.prop.getObject(t,"data",{});var i=BX.prop.getString(e,"STATUS","");if(i==="SUCCESS"){this._mergedItemCount++}else if(i==="CONFLICT"){this._conflictedItemCount++}else if(i==="ERROR"){BX.UI.Notification.Center.notify({content:BX.prop.getString(e,"MESSAGE","Merge failed an error occurred during the merge operation."),position:"top-right",autoHideDelay:5e3})}this._currentItemIndex++;if(i!=="COMPLETED"){window.setTimeout(function(){this.merge()}.bind(this),400);this.setProgressBarValue(100*this._currentItemIndex/this._totalItemCount)}else{this.setMergeResult(e);this.setProgressBarValue(100);window.setTimeout(function(){this.end()}.bind(this),200)}}.bind(this))};BX.Crm.DedupeWizardMerging.prototype.mergeBackground=function(t){var e=this._wizard.getConfig();var i=BX.prop.getArray(e,"typeNames",[]);var n=BX.prop.getString(e,"scope","");BX.ajax.runComponentAction("bitrix:crm.dedupe.wizard","mergeBackground",{data:{entityTypeName:BX.CrmEntityType.resolveName(this._wizard.getEntityTypeId()),types:i,scope:n,tryStart:!!t?"Y":"N"}}).then(function(t){var e=BX.prop.getObject(t,"data",{});var i=BX.prop.getString(e,"IS_ACTIVE","N")==="Y";var n=BX.prop.getString(e,"STATUS","");var r=n==="STATUS_INACTIVE"||n==="STATUS_PENDING_START"||n==="STATUS_RUNNING"||n==="STATUS_PENDING_STOP";if(!i&&r){n="STATUS_STOPPED";r=false}if(r){window.setTimeout(function(){this.mergeBackground()}.bind(this),3e3);if(n==="STATUS_RUNNING"||n==="STATUS_PENDING_STOP"){this.updateMergeProgress(e)}}else if(n==="STATUS_FINISHED"||n==="STATUS_STOPPED"){this.setMergeResult(e);var s=BX(BX.prop.getString(this._settings,"stopButtonId"));if(s){s.style.display="none";BX.unbind(s,"click",this._mergeStopHandler)}if(n==="STATUS_STOPPED"){this.updateMergeProgress(e);window.setTimeout(function(){this.goToScan()}.bind(this),200)}else{this.setProgressBarValue(100);window.setTimeout(function(){this.end()}.bind(this),200)}}}.bind(this))};BX.Crm.DedupeWizardMerging.prototype.stopMergeBackground=function(){var t=BX(BX.prop.getString(this._settings,"stopButtonId"));if(t){t.classList.add("ui-btn-light");BX.unbind(t,"click",this._mergeStopHandler)}BX.ajax.runComponentAction("bitrix:crm.dedupe.wizard","stopMergeBackground",{data:{entityTypeName:BX.CrmEntityType.resolveName(this._wizard.getEntityTypeId())}}).then(function(t){var e=BX(BX.prop.getString(this._settings,"stopButtonId"));if(e){var i=BX.prop.getObject(t,"data",{});if(i["STATUS"]==="STATUS_PENDING_STOP"||i["STATUS"]==="STATUS_STOPPED"||i["NEXT_STATUS"]==="STATUS_PENDING_STOP"){e.style.display="none"}else{e.classList.remove("ui-btn-light");BX.bind(e,"click",this._mergeStopHandler)}}}.bind(this)).catch(function(){var t=BX(BX.prop.getString(this._settings,"stopButtonId"));if(t){t.classList.remove("ui-btn-light");BX.bind(t,"click",this._mergeStopHandler)}}.bind(this));return true};BX.Crm.DedupeWizardMerging.prototype.onReturnToScanButtonClick=function(t){this.goToScan()};BX.Crm.DedupeWizardMerging.prototype.onAutomaticMergeStartButtonClick=function(t){this.layoutAfterStart(true)};BX.Crm.DedupeWizardMerging.prototype.onManualMergeStartButtonClick=function(t){this._currentItemIndex=0;this._wizard.setMergeMode("manual");this.prepareProgressBar();this.merge()};BX.Crm.DedupeWizardMerging.prototype.onMergeStopButtonClick=function(t){this.stopMergeBackground()};BX.Crm.DedupeWizardMerging.prototype.onListButtonClick=function(t){this._wizard.openDedupeList();t.preventDefault()};BX.Crm.DedupeWizardMerging.prototype.getNextStepId=function(){if(this._wizard.getMergedItemCount()>0){return"mergingSummary"}return this._wizard.getConflictedItemCount()>0?"conflictResolving":"finish"};BX.Crm.DedupeWizardMerging.prototype.getMergeAgentState=function(){return this._wizard?this._wizard.getMergeAgentState():{}};BX.Crm.DedupeWizardMerging.prototype.setMergeResult=function(t){this._wizard.setMergedItemCount(this._wizard.getTotalItemCount()-BX.prop.getInteger(t,"TOTAL_ITEMS",0));this._wizard.setMergedEntityCount(this._wizard.getTotalEntityCount()-BX.prop.getInteger(t,"TOTAL_ENTITIES",0));this._wizard.setConflictedItemCount(this._wizard.getTotalItemCount()-this._wizard.getMergedItemCount());this._wizard.setConflictedEntityCount(this._wizard.getTotalEntityCount()-this._wizard.getMergedEntityCount())};BX.Crm.DedupeWizardMerging.create=function(t,e){var i=new BX.Crm.DedupeWizardMerging;i.initialize(t,e);return i}}if(typeof BX.Crm.DedupeWizardMergingSummary==="undefined"){BX.Crm.DedupeWizardMergingSummary=function(){BX.Crm.DedupeWizardMergingSummary.superclass.constructor.apply(this);this._buttonClickHandler=BX.delegate(this.onButtonClick,this)};BX.extend(BX.Crm.DedupeWizardMergingSummary,BX.Crm.DedupeWizardStep);BX.Crm.DedupeWizardMergingSummary.prototype.start=function(){this.layout();BX.Crm.DedupeWizardMergingSummary.superclass.start.apply(this,arguments)};BX.Crm.DedupeWizardMergingSummary.prototype.layout=function(){this.getTitleWrapper().innerHTML=this.getMessage("duplicatesProcessed").replace("#COUNT#",this._wizard.getMergedEntityCount());this.getSubtitleWrapper().innerHTML=this.getMessage("matchesProcessed").replace("#COUNT#",this._wizard.getMergedItemCount());var t=BX(BX.prop.getString(this._settings,"buttonId"));if(t){BX.bind(t,"click",this._buttonClickHandler)}};BX.Crm.DedupeWizardMergingSummary.prototype.onButtonClick=function(t){this.end()};BX.Crm.DedupeWizardMergingSummary.prototype.getNextStepId=function(){return this._wizard.getConflictedItemCount()>0?"conflictResolving":"finish"};BX.Crm.DedupeWizardMergingSummary.create=function(t,e){var i=new BX.Crm.DedupeWizardMergingSummary;i.initialize(t,e);return i}}if(typeof BX.Crm.DedupeWizardConflictResolving==="undefined"){BX.Crm.DedupeWizardConflictResolving=function(){BX.Crm.DedupeWizardConflictResolving.superclass.constructor.apply(this);this._returnToScanHandler=BX.delegate(this.onReturnToScanButtonClick,this);this._buttonClickHandler=BX.delegate(this.onButtonClick,this);this._externalEventHandler=null;this._contextId=""};BX.extend(BX.Crm.DedupeWizardConflictResolving,BX.Crm.DedupeWizardStep);BX.Crm.DedupeWizardConflictResolving.prototype.start=function(){this.layout();BX.Crm.DedupeWizardMergingSummary.superclass.start.apply(this,arguments)};BX.Crm.DedupeWizardConflictResolving.prototype.layout=function(){this.adjustTitle();var t=BX(BX.prop.getString(this._settings,"buttonId"));if(t){BX.bind(t,"click",this._buttonClickHandler)}var e=BX(BX.prop.getString(this._settings,"returnToScanButtonId"));if(e){BX.bind(e,"click",this._returnToScanHandler)}var i=BX(BX.prop.getString(this._settings,"listButtonId"));if(i){BX.bind(i,"click",this.onListButtonClick.bind(this))}if(this._wizard.getMergeMode()==="manual"){this._buttonClickHandler()}};BX.Crm.DedupeWizardConflictResolving.prototype.adjustTitle=function(){this.getTitleWrapper().innerHTML=this.getMessage("duplicatesConflicted").replace("#COUNT#",this._wizard.getConflictedEntityCount());this.getSubtitleWrapper().innerHTML=this.getMessage("matchesConflicted").replace("#COUNT#",this._wizard.getConflictedItemCount())};BX.Crm.DedupeWizardConflictResolving.prototype.onReturnToScanButtonClick=function(t){this.goToScan()};BX.Crm.DedupeWizardConflictResolving.prototype.onButtonClick=function(t){this._contextId=this._wizard.getContextId()+"_"+BX.util.getRandomString(6).toUpperCase();this._wizard.openMerger(this._contextId);if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}};BX.Crm.DedupeWizardConflictResolving.prototype.onListButtonClick=function(t){this._wizard.openDedupeList();t.preventDefault()};BX.Crm.DedupeWizardConflictResolving.prototype.onExternalEvent=function(t){var e=BX.prop.getString(t,"key","");if(e!=="onCrmEntityMergeComplete"&&e!=="onCrmEntityMergeSkip"){return}var i=BX.prop.getObject(t,"value",{});if(this._contextId!==BX.prop.getString(i,"context","")){return}var n=BX.prop.getString(i,"entityTypeName","");if(n!==this._wizard.getEntityTypeName()){return}var r=BX.prop.getInteger(i,"length",-1);if(r>=0){var s=this._wizard.getConflictedItemCount();if(s>=r){this._wizard.setResolvedItemCount(s-r)}else{this._wizard.setResolvedItemCount(0);this._wizard.setConflictedItemCount(r)}}var o=BX.prop.getInteger(i,"skipped",0);if(o>0){var a=this._wizard.getTotalEntityCount();this._wizard.setTotalEntityCount(Math.max(a-o,0))}if(this._wizard.getUnResolvedItemCount()===0){window.setTimeout(function(){this.end()}.bind(this),0)}};BX.Crm.DedupeWizardConflictResolving.prototype.getNextStepId=function(){return"finish"};BX.Crm.DedupeWizardConflictResolving.create=function(t,e){var i=new BX.Crm.DedupeWizardConflictResolving;i.initialize(t,e);return i}}if(typeof BX.Crm.DedupeWizardMergingFinish==="undefined"){BX.Crm.DedupeWizardMergingFinish=function(){BX.Crm.DedupeWizardMergingFinish.superclass.constructor.apply(this);this._returnToScanHandler=BX.delegate(this.onReturnToScanButtonClick,this)};BX.extend(BX.Crm.DedupeWizardMergingFinish,BX.Crm.DedupeWizardStep);BX.Crm.DedupeWizardMergingFinish.prototype.start=function(){this._wizard.enableEntityListReload(true);this._wizard.enableCloseConfirmation(false);BX.Crm.DedupeWizardMergingFinish.superclass.start.apply(this,arguments);this.layout()};BX.Crm.DedupeWizardMergingFinish.prototype.layout=function(){var t=this._wizard.getTotalEntityCount();if(parseInt(t)>0){this.getSubtitleWrapper().innerHTML=this.getMessage("duplicatesComplete").replace("#COUNT#",t)}else{this.getSubtitleWrapper().innerHTML=this.getMessage("duplicatesCompleteEmpty")}this.deleteAgents();var e=BX(BX.prop.getString(this._settings,"returnToScanButtonId"));if(e){BX.bind(e,"click",this._returnToScanHandler)}var i=BX(BX.prop.getString(this._settings,"backToListLinkId"));if(i){BX.bind(i,"click",this.onListButtonClick.bind(this))}};BX.Crm.DedupeWizardMergingFinish.prototype.onReturnToScanButtonClick=function(t){this.goToScan()};BX.Crm.DedupeWizardMergingFinish.prototype.onListButtonClick=function(t){var e=top.BX.SidePanel.Instance.getSliderByWindow(window);if(e&&e.isOpen()){e.close(false);t.preventDefault()}};BX.Crm.DedupeWizardMergingFinish.create=function(t,e){var i=new BX.Crm.DedupeWizardMergingFinish;i.initialize(t,e);return i}}
//# sourceMappingURL=script.map.js