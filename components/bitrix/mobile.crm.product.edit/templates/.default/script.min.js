BX.namespace("BX.Mobile.Crm.Product.Edit");BX.Mobile.Crm.Product.Edit={previewPhotoFile:"",previewPhotoDel:"",detailPhotoFile:"",detailPhotoDel:"",productViewPath:"",init:function(e){if(e&&typeof e==="object"){this.ajaxPath=e.ajaxPath||"";this.formActionUrl=e.formActionUrl||"";this.formId=e.formId||"";this.productViewPath=e.productViewPath||"";this.mode=e.mode||""}BX.addCustomEvent("onCrmProductDetailDelete",function(){BXMobileApp.onCustomEvent("onCrmProductListUpdate",{},true);BXMobileApp.UI.Page.close({drop:true})});if(this.mode=="EDIT"){BXMobileApp.addCustomEvent("onCrmProductEditUpdate",BX.proxy(function(e){if(e.formId==this.formId){BXMobileApp.UI.Page.reload()}},this))}if(this.mode=="VIEW"){BXMobileApp.addCustomEvent("onCrmProductViewUpdate",BX.proxy(function(e){if(e.formId==this.formId){BXMobileApp.UI.Page.reload()}},this));BX.addCustomEvent("onSubmitAjaxSuccess",BX.proxy(function(e){if(e.formId==this.formId)BXMobileApp.onCustomEvent("onCrmProductEditUpdate",{formId:this.formId},true)},this))}if(this.mode=="CREATE"){var o=function(){BX.removeCustomEvent("onOpenPageAfter",o);app.closeModalDialog()};BX.addCustomEvent("onCrmProductClosePage",function(){if(!(window.isCurrentPage&&window.isCurrentPage=="Y")){BX.addCustomEvent("onOpenPageAfter",o)}else{window.isCurrentPage=""}})}if(this.mode=="VIEW"){BXMobileApp.addCustomEvent("onSubmitForm",BX.proxy(function(e,o,t){if(e.formId==this.formId){if(t.checked==false||!t.hasAttribute("checked")){var i=BX.create("INPUT",{attrs:{type:"hidden",name:t.name,value:""}});t.parentNode.insertBefore(i,t)}}},this));BX.addCustomEvent("onSubmitAjaxSuccess",BX.proxy(function(e){if(e.hasOwnProperty("formId")&&e.formId==this.formId){BXMobileApp.onCustomEvent("onCrmProductListUpdate",{},true)}},this))}if(this.mode=="EDIT"||this.mode=="CREATE"){var t=BX.delegate(function(e,o,t){if(e==this.formId&&t){BX.addCustomEvent(t,"onChange",BX.proxy(this.onChange,this))}},this);BX.addCustomEvent("onInitialized",t);var i=BX.Mobile.Grid.Form.getByFormId(this.formId);t(this.formId,"",i)}},onChange:function(e,o,t,i){if(!(typeof i==="object"&&i))return;if(i.action=="add"){if(t.controlName=="PREVIEW_PICTURE")this.previewPhotoFile=i.file;else if(t.controlName=="DETAIL_PICTURE")this.detailPhotoFile=i.file}else if(i.action=="delete"){if(t.controlName=="PREVIEW_PICTURE"){this.previewPhotoDel="Y";this.previewPhotoFile=""}else if(t.controlName=="DETAIL_PICTURE"){this.detailPhotoDel="Y";this.detailPhotoFile=""}}},submit:function(){BXMobileApp.UI.Page.LoadingScreen.show();var e=BX(this.formId);if(e){var o={save:"Y",sessid:BX.bitrix_sessid()};BX.Mobile.Crm.Detail.collectInterfaceFormData(e,o);var t=new FormData;for(var i in o){if(o.hasOwnProperty(i)){t.append(i,o[i])}}if(this.previewPhotoFile){t.append("PREVIEW_PICTURE",this.previewPhotoFile,this.previewPhotoFile.name)}else if(this.previewPhotoDel=="Y"){t.append("PREVIEW_PICTURE_del","Y");t.append("PREVIEW_PICTURE",BX.UploaderUtils.dataURLToBlob("data:image/jpg;base64"),"")}if(this.detailPhotoFile){t.append("DETAIL_PICTURE",this.detailPhotoFile,this.detailPhotoFile.name)}else if(this.previewPhotoDel=="Y"){t.append("DETAIL_PICTURE_del","Y");t.append("DETAIL_PICTURE",BX.UploaderUtils.dataURLToBlob("data:image/jpg;base64"),"")}BX.ajax({method:"POST",dataType:"json",url:this.formActionUrl,data:t,preparePost:false,onsuccess:BX.proxy(function(e){if(e.error){app.alert({text:e.error})}else{if(this.mode=="EDIT"){BXMobileApp.onCustomEvent("onCrmProductListUpdate",{},true);BXMobileApp.onCustomEvent("onCrmProductViewUpdate",{formId:this.formId},true);app.closeModalDialog({cache:false})}if(this.mode=="CREATE"){var o=this.productViewPath.replace("#product_id#",e.itemId);BXMobileApp.onCustomEvent("onCrmProductLoadPageBlank",{path:o},true);app.closeModalDialog({cache:false})}}BXMobileApp.UI.Page.LoadingScreen.hide()},this)})}}};
//# sourceMappingURL=script.map.js