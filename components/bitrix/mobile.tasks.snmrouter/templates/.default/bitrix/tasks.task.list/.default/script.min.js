BX.namespace("BX.Tasks.Grid");BX.Tasks.GridActions={gridId:null,groupSelector:null,registeredTimerNodes:{},initPopupBaloon:function(e,t,r){this.groupSelector=null;BX.bind(BX(t+"_control"),"click",BX.delegate(function(){if(!this.groupSelector){this.groupSelector=new BX.Tasks.Integration.Socialnetwork.NetworkSelector({scope:BX(t+"_control"),id:"group-selector-"+this.gridId,mode:e,query:false,useSearch:true,useAdd:false,parent:this,popupOffsetTop:5,popupOffsetLeft:40});this.groupSelector.bindEvent("item-selected",BX.delegate(function(e){BX(t+"_control").value=BX.util.htmlspecialcharsback(e.nameFormatted)||"";BX(r+"_control").value=e.id||"";this.groupSelector.close()},this))}this.groupSelector.open()},this))},action:function(e,t,r){switch(e){default:this.doAction(e,t,r);break;case"add2Timeman":if(BX.addTaskToPlanner)BX.addTaskToPlanner(t);else if(window.top.BX.addTaskToPlanner)window.top.BX.addTaskToPlanner(t);break;case"delete":BX.Tasks.confirmDelete(BX.message("TASKS_COMMON_TASK_ALT_A")).then(function(){this.doAction(e,t,r)}.bind(this));break}},confirmGroupAction:function(e){BX.Tasks.confirm(BX.message("TASKS_CONFIRM_GROUP_ACTION")).then(function(){BX.Main.gridManager.getById(e).instance.sendSelected()}.bind(this))},doAction:function(e,t,r){r=r||{};r["id"]=t;this.getQuery().add("task."+e.toLowerCase(),r,{},BX.delegate(function(e,r){if(!e.checkHasErrors()){if(r.OPERATION=="task.delete"){BX.Tasks.Util.fireGlobalTaskEvent("DELETE",{ID:t})}if(!this.gridId){window.location.href=window.location.href;return}this.reloadRow(t)}},this))},reloadGrid:function(){if(BX.Bitrix24&&BX.Bitrix24.Slider&&BX.Bitrix24.Slider.getLastOpenPage()){BX.Bitrix24.Slider.destroy(BX.Bitrix24.Slider.getLastOpenPage().getUrl())}var e={apply_filter:"Y",clear_nav:"Y"};var t=BX.Main.gridManager.getById(this.gridId);if(t.hasOwnProperty("instance")){t.instance.reloadTable("POST",e)}},reloadRow:function(e){reloadParams={apply_filter:"Y",clear_nav:"Y"};gridObject=BX.Main.gridManager.getById(this.gridId);if(gridObject.hasOwnProperty("instance"))gridObject.instance.updateRow(e.toString())},getQuery:function(){if(!this.query){this.query=new BX.Tasks.Util.Query({autoExec:true})}return this.query},onDeadlineChangeClick:function(e,t,r){r=r||(new Date).getDate();BX.calendar({node:t,value:r,form:"",bTime:true,currentTime:Math.round(new Date/1e3)-(new Date).getTimezoneOffset()*60,bHideTimebar:true,callback_after:function(e,t){return function(r,i){var s=true;if(typeof i!=="undefined")s=i;BX.CJSTask.batchOperations([{operation:"CTaskItem::update()",taskData:{ID:t,DEADLINE:BX.calendar.ValueToString(r,s)}}],{callbackOnSuccess:function(e,t,r){return function(e){}}(e,t,r)});BX.Tasks.GridActions.reloadRow(t)}}(t,e)})},onMarkChangeClick:function(e,t,r){BX.TaskGradePopup.show(e,t,r,{events:{onPopupClose:this.__onGradePopupClose,onPopupChange:this.__onGradePopupChange}});BX.addClass(t,"task-grade-and-report-selected");return false},__onGradePopupClose:function(){BX.removeClass(this.bindElement,"task-grade-and-report-selected")},__onGradePopupChange:function(){this.bindElement.className="task-grade-and-report"+(this.listValue!=="NULL"?" task-grade-"+this.listItem.className:"")+(this.report?" task-in-report":"");this.bindElement.title=BX.message("TASKS_MARK")+": "+this.listItem.name;BX.Tasks.GridActions.action("update",this.id,{data:{MARK:this.listValue==="NULL"?"":this.listValue}})},renderTimerItem:function(e,t,r,i,s,a){var n="task-timer-inner";var o=t+s;var a=a||false;if(i)n=n+" task-timer-play";else if(a)n=n+" task-timer-pause";else n=n+" task-timer-clock";if(r>0&&o>r)n=n+" task-timer-overdue";return BX.create("span",{props:{id:"task-timer-block-"+e,className:"task-timer-block"},events:{click:function(e,t){return function(){if(BX.hasClass(BX("task-timer-block-inner-"+e),"task-timer-play")){BX.TasksTimerManager.stop(e)}else if(t){BX.TasksTimerManager.start(e)}}}(e,a)},children:[BX.create("span",{props:{id:"task-timer-block-inner-"+e,className:n},children:[BX.create("span",{props:{className:"task-timer-icon"}}),BX.create("span",{props:{id:"task-timer-block-value-"+e,className:"task-timer-time"},text:BX.Tasks.GridActions.renderTimerTimes(o,r,i)})]})]})},renderTimerTimes:function(e,t,r){var i="";var s=false;if(r)s=true;i=BX.Tasks.GridActions.renderSecondsToHHMMSS(e,s);if(t>0)i=i+" / "+BX.Tasks.GridActions.renderSecondsToHHMMSS(t,false);return i},renderSecondsToHHMMSS:function(e,t){var r="00";var i=""+Math.floor(e/3600);var s=""+Math.floor(e/60)%60;var a=0;var n="";n=r.substring(0,2-i.length)+i+":"+r.substring(0,2-s.length)+s;if(t){a=""+e%60;n=n+":"+r.substring(0,2-a.length)+a}return n},redrawTimerNode:function(e,t,r,i,s,a){var n=BX("task-timer-block-"+e);var o=BX.Tasks.GridActions.renderTimerItem(e,t,r,i,s,a);if(n){n.parentNode.replaceChild(o,n)}else{var d=BX("task-timer-block-container-"+e);if(d){if(this.registeredTimerNodes[e]){BX.removeCustomEvent(window,"onTaskTimerChange",this.registeredTimerNodes[e])}d.appendChild(o);if(BX("task-timer-block-"+e)){this.registeredTimerNodes[e]=this.__getTimerChangeCallback(e);BX.addCustomEvent(window,"onTaskTimerChange",this.registeredTimerNodes[e])}}}},removeTimerNode:function(e){var t=BX("task-timer-block-"+e);if(this.registeredTimerNodes[e])BX.removeCustomEvent(window,"onTaskTimerChange",this.registeredTimerNodes[e]);if(t)t.parentNode.removeChild(t)},__getTimerChangeCallback:function(e){var t=null;return function(r){var i=null;var s=null;if(r.action==="refresh_daemon_event"){if(r.taskId!==e){if(t==="paused")return;else i="paused"}else{if(t!=="playing")i="playing";BX.Tasks.GridActions.redrawTimerNode(r.taskId,r.data.TASK.TIME_SPENT_IN_LOGS,r.data.TASK.TIME_ESTIMATE,true,r.data.TIMER.RUN_TIME,true)}}else if(r.action==="start_timer"){if(e==r.taskId&&r.timerData&&e==r.timerData.TASK_ID){i="playing"}else i="paused"}else if(r.action==="stop_timer"){if(e==r.taskId)i="paused"}else if(r.action==="init_timer_data"){if(r.data.TIMER){if(r.data.TIMER.TASK_ID==e){if(r.data.TIMER.TIMER_STARTED_AT>0)i="playing";else i="paused"}else if(r.data.TIMER.TASK_ID>0){i="paused"}}}if(i!==null){s=BX("task-timer-block-inner-"+e);if(s&&!BX.hasClass(s,"task-timer-clock")){if(i==="paused"){BX.removeClass(s,"task-timer-play");BX.addClass(s,"task-timer-pause")}else if(i==="playing"){BX.removeClass(s,"task-timer-pause");BX.addClass(s,"task-timer-play")}}t=i}}}};(function(){"use strict";BX.addCustomEvent("tasksTaskEvent",BX.delegate(function(e,t){BX.Tasks.GridActions.reloadGrid()},this));BX.Tasks.Grid.Sorting=function(e){this.grid=BX.Main.gridManager.getInstanceById(e.gridId);this.currentGroupId=e.currentGroupId;this.treeMode=e.treeMode;BX.message(e.messages);this.init();BX.addCustomEvent("BX.Main.grid:rowDragStart",this.handleRowDragStart.bind(this));BX.addCustomEvent("BX.Main.grid:rowDragMove",this.handleRowDragMove.bind(this));BX.addCustomEvent("BX.Main.grid:rowDragEnd",this.handleRowDragEnd.bind(this))};BX.Tasks.Grid.Sorting.prototype={init:function(){this.dragRow=null;this.targetRow=null;this.error=false;this.targetTask=null;this.before=true;this.newGroup=null;this.newParentId=null},getGrid:function(){return this.grid},getRow:function(e){return this.getGrid().getRows().get(e)},getRowById:function(e){return this.getGrid().getRows().getById(e)},getRows:function(){return this.getGrid().getRows().getBodyChild()},getRowProp:function(e,t){return e.getNode().dataset[t]},getRowType:function(e){return this.getRowProp(e,"type")},getRowGroupId:function(e){return this.getRowProp(e,"groupId")},handleRowDragStart:function(e,t){this.dragRow=this.getRow(e.getDragItem())},handleRowDragMove:function(e,t){this.targetRow=this.getRow(e.getTargetItem());var r=this.targetRow?this.getRowType(this.targetRow):null;this.newParentId=null;this.error=false;var i=null;if(r==="task"){var s=this.targetRow.getParentId();if(s!==this.dragRow.getParentId()){this.newParentId=s}i=this.getGroupByRow(this.targetRow);this.targetTask=this.targetRow;this.before=true}else{if(r==="group"){i=this.getPreviousGroup(this.targetRow)}else{i=this.getLastGroup()}var a=this.getClosestTask(this.targetRow);this.targetTask=a.task;this.before=a.before}this.newGroup=i.id!==this.getGroupByRow(this.dragRow).id?i:null;if(r==="task"&&this.isChildOf(this.targetTask,this.dragRow)){this.error=true}else if(this.newGroup&&(this.getRowProp(this.dragRow,"canEdit")==="false"||!this.newGroup.canCreateTasks)){this.error=true}else if(this.newParentId!==null&&this.getRowProp(this.dragRow,"canEdit")==="false"){this.error=true}this.error?e.disallowMove(BX.message("TASKS_ACCESS_DENIED")):e.allowMove()},handleRowDragEnd:function(e,t){if(!this.error){this.save()}this.init()},save:function(){var e=this.dragRow.getId();var t=this.targetTask?this.targetTask.getId():null;if(e===t){return}var r={sourceId:e,targetId:t,before:this.before,currentGroupId:this.currentGroupId};if(this.newGroup!==null){r.newGroupId=this.newGroup.id;this.setGroupId(this.dragRow,r.newGroupId)}if(this.newParentId!==null&&this.treeMode){r.newParentId=this.newParentId}var i=new BX.Tasks.Util.Query;i.run("task.sorting.move",{data:r}).then(function(e){if(!e.getErrors().isEmpty()){BX.Tasks.confirm(e.getErrors().getMessages().join(" "),function(){BX.reload()},{buttonSet:[]})}});i.execute()},getParentRow:function(e){return this.getRowById(e.getParentId())},isChildOf:function(e,t){var r=this.getParentRow(e);while(r!==null){if(r===t){return true}r=this.getParentRow(r)}return false},getGroupById:function(e){var t=this.getRows();for(var r=0;r<t.length;r++){var i=t[r];if(this.getRowType(i)==="group"&&this.getRowGroupId(i)===String(e)){return this.getGroupByRow(i)}}return this.getDefaultProject()},setGroupId:function(e,t){e.getDataset().groupId=t;var r=e.getChildren();for(var i=0;i<r.length;i++){this.setGroupId(r[i],t)}},getDefaultProject:function(){return{id:"0",canCreateTasks:true}},getGroupByRow:function(e){if(this.getRowType(e)==="group"){return{id:this.getRowGroupId(e),canCreateTasks:this.getRowProp(e,"canCreateTasks")==="true"}}else{return this.getGroupById(this.getRowGroupId(e))}},getLastGroup:function(){var e=null;var t=this.getRows();for(var r=t.length-1;r>=0;r--){var i=t[r];if(this.getRowType(i)==="group"){return this.getGroupByRow(i)}}return this.getDefaultProject()},getPreviousGroup:function(e){var t=null;var r=this.getRows();var i=false;for(var s=r.length-1;s>=0;s--){var a=r[s];if(e===a){i=true;continue}if(i&&this.getRowType(a)==="group"){return this.getGroupByRow(a)}}return this.getDefaultProject()},getClosestTask:function(e){var t=this.getRows();var r=e?e.getIndex()-1:t.length;for(var i=r-1;i>=0;i--){if(this.getRowType(t[i])==="task"&&t[i].getDepth()==="0"){return{task:t[i],before:false}}}for(i=r+1;i<t.length;i++){if(this.getRowType(t[i])==="task"&&t[i].getDepth()==="0"){return{task:t[i],before:true}}}return{task:null,before:true}}}})();
//# sourceMappingURL=script.map.js