(function(){var t=window.BX;if(t&&t["Mobile"]&&t["Mobile"]["Tasks"]&&t["Mobile"]["Tasks"]["detail"])return;t.namespace("BX.Mobile.Tasks.detail");t.Mobile.Tasks.detail=function(e,s){this.parentConstruct(t.Mobile.Tasks.detail,e);t.merge(this,{sys:{classCode:"detail"},vars:{objectId:t.util.getRandomString()},task:e.taskData,taskEditObj:new t.Mobile.Tasks.edit({taskData:e.taskData,formId:e.formId,setTitle:false}),currentTs:e.currentTs,guid:e.guid,statuses:e.statuses});this.handleInitStack(s,t.Mobile.Tasks.detail,e);app.getPageParams({callback:function(e){if(e&&e["bSetFocusOnCommentsList"]=="YES"){t.ready((function(){var e;if((e=t("task-comments-block"))&&e){var s=t.pos(e);window.scrollTo(0,s["top"])}}))}}})};t.extend(t.Mobile.Tasks.detail,t.Mobile.Tasks.page);t.merge(t.Mobile.Tasks.detail.prototype,{init:function(){window.app.hidePopupLoader();this.act=t.delegate(this.act,this);this.actExecute=t.delegate(this.actExecute,this);this.actSuccess=t.delegate(this.actSuccess,this);this.actFailure=t.delegate(this.actFailure,this);this.stub=null;this.topPanelHeight=75;this.platformDelta=window.platform==="ios"?60:0;this.formInterface=t.Mobile.Grid.Form.getByFormId(this.option("formId"));this.forceHideButtons=false;this.timeout=0;this.timeoutSec=2e3;this.commentsList=null;this.unreadComments=new Map;this.commentsToRead=new Map;t.hide(t("commentsStub"));t.onCustomEvent("onTaskWasLoaded",[this.task]);if(typeof this.task["LOG_ID"]!="undefined"){var e={log_id:this.task["LOG_ID"],ts:this.currentTs,bPull:false};BXMobileApp.onCustomEvent("onLogEntryRead",e,true)}this.bindControls();this.bindEvents()},bindControls:function(){t.bind(t("options_button"),"click",t.proxy((function(){var t=[{guid:this.guid,taskId:this.task.ID}];BXMobileApp.onCustomEvent("onTaskDetailOptionsButtonClick",t,true)}),this));t.bind(t("down_button"),"click",t.delegate((function(){this.scrollToBottom()}),this));t.bind(t("up_button"),"click",t.delegate((function(){this.scrollToTop()}),this));if(t("favorites"+this.task["ID"])){t.bind(t("favorites"+this.task["ID"]),"click",t.proxy((function(){if(this.task["ACTION"]["ADD_FAVORITE"]){this.act("addFavorite");t.addClass(t("favorites"+this.task["ID"]),"active")}else if(this.task["ACTION"]["DELETE_FAVORITE"]){this.act("deleteFavorite");t.removeClass(t("favorites"+this.task["ID"]),"active")}}),this))}},bindEvents:function(){t.addCustomEvent(window,"OnUCHasBeenInitialized",function(t,e){console.log("OnUCHasBeenInitialized",e);if(t==="TASK_"+this.task.ID){this.commentsList=e;BXMobileApp.Events.postToComponent("task.view.onCommentsRead",{taskId:this.task.ID,newCommentsCount:0},"tasks.list");console.log("comments:"+this.commentsList.getCommentsCount())}}.bind(this));t.addCustomEvent(window,"onUCFormSubmit",t.delegate((function(){console.log("tasks: onUCFormSubmit");this.hideCommentsStub()}),this));t.addCustomEvent(window,"OnUCCommentWasPulled",function(e,s){console.log("OnUCCommentWasPulled");if(e[0]==="TASK_"+this.task.ID){var i=s.messageFields["AUTHOR"];if(Number(i["ID"])!==Number(t.message("USER_ID"))){this.unreadComments.set(e[1],new Date)}console.log("Unread comments:"+this.unreadComments);this.hideCommentsStub()}}.bind(this));t.addCustomEvent(window,"OnUCommentWasDeleted",function(t,e){console.log("OnUCommentWasDeleted:",arguments);var s=e[1];if(t==="TASK_"+this.task.ID&&this.unreadComments.delete(s)){BXMobileApp.Events.postToComponent("task.view.onCommentsRead",{taskId:this.task.ID,newCommentsCount:this.unreadComments.size},"tasks.view");BXMobileApp.Events.postToComponent("task.view.onCommentsRead",{taskId:this.task.ID,newCommentsCount:this.unreadComments.size},"tasks.list");console.log("this.commentsList.getCommentsCount():",this.commentsList.getCommentsCount())}}.bind(this));t.addCustomEvent(window,"OnUCCommentWasRead",function(t,e){console.log("OnUCCommentWasRead:",arguments);var s=e[1];if(t==="TASK_"+this.task.ID&&this.unreadComments.has(s)){this.commentsToRead.set(s,this.unreadComments.get(s));this.unreadComments.delete(s);BXMobileApp.Events.postToComponent("task.view.onCommentsRead",{taskId:this.task.ID,newCommentsCount:this.unreadComments.size},"tasks.view");BXMobileApp.Events.postToComponent("task.view.onCommentsRead",{taskId:this.task.ID,newCommentsCount:this.unreadComments.size},"tasks.list");if(this.timeout<=0){this.timeout=setTimeout(this.readComments.bind(this),this.timeoutSec)}}}.bind(this));window.addEventListener("scroll",this.onScrollEvent.bind(this));t.addCustomEvent("onKeyboardWillShow",function(){var e=t("up_button");var s=t("down_button");var i=t("options_button");var a="flow-button-hidden";this.forceHideButtons=true;if(!t.hasClass(i,a)){t.addClass(i,a)}if(!t.hasClass(s,a)){t.addClass(s,a)}t.hide(e)}.bind(this));t.addCustomEvent("onKeyboardWillHide",function(){var e=t("down_button");var s=t("options_button");var i="flow-button-hidden";this.forceHideButtons=false;if(t.hasClass(s,i)){t.removeClass(s,i)}if(t.hasClass(e,i)){t.removeClass(e,i)}this.onScrollEvent()}.bind(this));t.addCustomEvent("onTextPanelShown",t.delegate((function(e){if(!this.webViewHeight){this.webViewHeight=e.webViewHeight||document.body.clientHeight-this.topPanelHeight}if(t("post-comments-wrap")){window.scrollTo(0,this.getCommentElementScrollTo())}BXMobileApp.Events.postToComponent("task.view.onPageLoaded",{taskId:this.task.ID},"tasks.view");BXMobileApp.UI.Page.LoadingScreen.hide()}),this));BXMobileApp.addCustomEvent("tasks.view.native::onTaskUpdate",t.delegate((function(t){console.log("tasks.view.native::onTaskUpdate");if(t.taskId!==this.task.ID){return}if(t.hasOwnProperty("favorite")){document.querySelector("#favorites"+this.task.ID).classList.toggle("active")}if(t.hasOwnProperty("responsible")){window.app.reload()}}),this));BXMobileApp.addCustomEvent("tasks.view.native::onItemAction",t.delegate((function(e){if(Number(e.taskId)!==Number(this.task.ID)||e.taskGuid!==this.guid){return}var s={};var i={};switch(e.name){default:break;case"deadline":var a=this.getParsedDate(new Date(e.values.deadline));this.getFormElement(e.name).callback(a);break;case"responsible":case"auditor":case"accomplice":s=e.values.user;s={ID:s.id,NAME:s.name||s.title,IMAGE:s.icon||s.imageUrl||false};this.getFormElement(e.name).callback({a_users:[s]});break;case"group":i=e.values.group;i={ID:i.id,NAME:i.name,IMAGE:i.image||false};this.getFormElement(e.name).callback({b_groups:[i]});break;case"status":var o=t("bx-task-status-"+this.task["ID"]);if(o){o.innerHTML=t.message("TASKS_STATUS_"+this.statuses[e.values.status])}break}}),this));BXMobileApp.addCustomEvent("onItemSelected",t.delegate((function(){this.scrollToTop()}),this));BXMobileApp.addCustomEvent("onTaskWasUpdated",t.delegate((function(t,e,s,i,a){if(!s){e=t[1];t=t[0]}if(this.task["ID"]==t&&e!==this.taskEditObj.vars["id"]){if(!a){if(Application.getApiVersion()<31){window.app.showPopupLoader()}window.app.reload()}}}),this));BXMobileApp.addCustomEvent("onTaskWasRemoved",t.delegate((function(t,e,s){if(!s){t=t[0]}if(this.task["ID"]==t){window.app.closeController({drop:true})}}),this));BXMobileApp.addCustomEvent("onTaskWasPerformed",t.delegate((function(t,e,s){if(!s){s=t[2];e=t[1];t=t[0]}if(this.task["ID"]==t&&e!==this.variable("objectId")){if(s["OPERATION"]==="task.dayplan.timer.start"||s["OPERATION"]==="task.dayplan.timer.stop"||s["OPERATION"]==="task.complete"){this.actSuccess(s["OPERATION"],s,true)}else{this.actSuccess("get",s,false)}}}),this));t.MobileUI.addLivefeedLongTapHandler(t("post_inform_wrap_two"),{likeNodeClass:"post-item-informer-like"});t.MobileUI.addLivefeedLongTapHandler(t("task-comments-block"),{likeNodeClass:"post-comment-control-item-like"})},readComments:function(){this.timeout=0;this.commentsToRead.clear();t.ajax.runAction("tasks.task.view.update",{data:{taskId:this.task.ID}})},onScrollEvent:function(){if(this.forceHideButtons){return}var e=this.getScrollTop();var s=document.body.scrollHeight-2*this.webViewHeight+this.topPanelHeight+this.platformDelta;var i=this.webViewHeight-this.topPanelHeight;var a=t("up_button");var o=t("down_button");var n="task-show-button";if(e>i){t.addClass(a,n)}else{t.removeClass(a,n)}o.style.display=e<s?"block":"none"},getScrollTop:function(){return window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0},scrollToTop:function(){console.log("scrollToTop");app.exec("setScroll",{x:0,y:0,animated:true},false)},scrollToBottom:function(){console.log("scrollToBottom");var t=document.body.scrollHeight-document.body.clientHeight+this.platformDelta;app.exec("setScroll",{x:0,y:t,animated:true},false)},getParsedDate:function(t){var e=("0"+t.getDate()).slice(-2);var s=("0"+(t.getMonth()+1)).slice(-2);var i=t.getFullYear();var a=("0"+t.getHours()).slice(-2);var o=("0"+t.getMinutes()).slice(-2);return e+"."+s+"."+i+" "+a+":"+o},getFormElement:function(t){var e=0;switch(t){default:break;case"deadline":for(e=0;e<this.formInterface.elements.length;e++){if(this.formInterface.elements[e].node&&this.formInterface.elements[e].node.name==="data[DEADLINE]"){return this.formInterface.elements[e]}}break;case"responsible":case"auditor":case"accomplice":var s={responsible:"data[SE_RESPONSIBLE][0][ID]",auditor:"data[SE_AUDITOR][]",accomplice:"data[SE_ACCOMPLICE][]"};for(e=0;e<this.formInterface.elements.length;e++){if(this.formInterface.elements[e].select&&this.formInterface.elements[e].select.name===s[t]){return this.formInterface.elements[e]}}break;case"group":for(e=0;e<this.formInterface.elements.length;e++){if(this.formInterface.elements[e].select&&this.formInterface.elements[e].select.name==="data[SE_PROJECT][ID]"){return this.formInterface.elements[e]}}break}return null},getCommentElementScrollTo:function(){var e=t("post-comments-wrap");var s=t.findChild(e,{className:"post-comment-block-new"},true);if(s){return s.offsetTop-this.topPanelHeight}var i=t.findChild(e,{className:"post-comment-block"},true);if(!i){this.showCommentsStub(e);return this.stub.offsetTop}if(i.offsetTop>0){return i.offsetTop-this.topPanelHeight}var a=t.findChild(e,{className:"feed-com-collapsed"},true);if(a){return a.offsetTop-this.topPanelHeight}return e.offsetTop-this.topPanelHeight},hideCommentsStub:function(){if(this.stub&&t.isShown(this.stub)){t.hide(this.stub)}},showCommentsStub:function(e){if(!this.stub){this.stub=t("commentsStub");this.stub.style.height=this.webViewHeight-this.topPanelHeight+"px";t.append(this.stub,e);t.show(this.stub)}else{t.show(this.stub)}},getDefaultMenu:function(){var e=[{name:t.message("MB_TASKS_TASK_DETAIL_TASK_ADD"),arrowFlag:false,icon:"add",action:t.Mobile.Tasks.createWindow},{name:t.message("MB_TASKS_TASK_DETAIL_TASK_ADD_SUBTASK"),arrowFlag:false,icon:"add",action:t.proxy((function(){t.Mobile.Tasks.createWindow(null,this.task["ID"])}),this)}];var s,i=this.task["ACTION"],a=this.task["ID"];for(var o in this.task["ACTION"]){if(this.task["ACTION"].hasOwnProperty(o)){if(!i[o])continue;s=(o+"").toUpperCase();if(s=="EDIT"){e.push({name:t.message("MB_TASKS_TASK_DETAIL_BTN_EDIT"),icon:"edit",arrowFlag:false,action:function(){var e=t.message("TASK_PATH_TO_EDIT").replace(/#TASK_ID#/gi,a).replace(/#USER_ID#/gi,t.message("USER_ID")).replace(/#SALT#/gi,(new Date).getTime());window.BXMobileApp.PageManager.loadPageModal({url:e,bx24ModernStyle:true,cache:false})}})}else if(s=="REMOVE"){e.push({name:t.message("MB_TASKS_TASK_DETAIL_BTN_REMOVE"),icon:"delete",action:t.proxy((function(){window.app.confirm({title:t.message("MB_TASKS_TASK_REMOVE_CONFIRM_TITLE"),text:t.message("MB_TASKS_TASK_DETAIL_CONFIRM_REMOVE"),buttons:["OK",t.message("MB_TASKS_TASK_DETAIL_USER_SELECTOR_BTN_CANCEL")],callback:t.proxy((function(t){if(t==1){this.act("delete")}}),this)})}),this)})}else if(s=="START"){e.push({name:t.message("MB_TASKS_TASK_DETAIL_BTN_START_TASK"),icon:"play",action:t.proxy((function(){this.act("start")}),this)})}else if(s=="RENEW"){e.push({name:t.message("MB_TASKS_TASK_DETAIL_BTN_RENEW_TASK"),icon:"reload",action:t.proxy((function(){this.act("renew")}),this)})}else if(s=="COMPLETE"){e.push({name:t.message("MB_TASKS_TASK_DETAIL_BTN_CLOSE_TASK"),icon:"finish",action:t.proxy((function(){this.act("complete")}),this)})}else if(s=="DEFER"){e.push({name:t.message("MB_TASKS_TASK_DETAIL_BTN_PAUSE_TASK"),icon:"pause",action:t.proxy((function(){this.act("defer")}),this)})}else if(s=="APPROVE"){e.push({name:t.message("MB_TASKS_TASK_DETAIL_BTN_APPROVE_TASK"),icon:"check",action:t.proxy((function(){this.act("approve")}),this)})}else if(s=="DISAPPROVE"){e.push({name:t.message("MB_TASKS_TASK_DETAIL_BTN_REDO_TASK"),icon:"reload",action:t.proxy((function(){this.act("disapprove")}),this)})}else if(s=="DELEGATE"){e.push({name:t.message("MB_TASKS_TASK_DETAIL_BTN_DELEGATE_TASK"),icon:"finish",action:t.proxy((function(){new window.BXMobileApp.UI.Table({url:t.message("SITE_DIR")+"mobile/index.php?mobile_action=get_user_list",table_settings:{callback:t.proxy((function(t){if(!(t&&t.a_users&&t.a_users[0]))return;this.act("delegate",{userid:t.a_users[0]["ID"].toString()})}),this),markmode:true,multiple:false,return_full_mode:true,skipSpecialChars:true,modal:true,alphabet_index:true,outsection:false,cancelname:t.message("MB_TASKS_TASK_DETAIL_USER_SELECTOR_BTN_CANCEL")}},"users").show()}),this)})}else if(s=="ADD_FAVORITE"){e.push({name:t.message("MB_TASKS_TASK_DETAIL_BTN_ADD_FAVORITE_TASK"),image:"/bitrix/templates/mobile_app/images/tasks/menu/favorite.png",action:t.proxy((function(){this.act("addFavorite")}),this)})}else if(s=="DELETE_FAVORITE"){e.push({name:t.message("MB_TASKS_TASK_DETAIL_BTN_DELETE_FAVORITE_TASK"),image:"/bitrix/templates/mobile_app/images/tasks/menu/favorite.png",action:t.proxy((function(){this.act("deleteFavorite")}),this)})}}}return e},act:function(e,s,i){if(this.task.isBusy){return}if(this.appCtrls&&this.appCtrls.menu){this.appCtrls.menu.hide()}window.app.showPopupLoader();var a={userId:s?s["userid"]:false};if(i){window.app.BasicAuth({success:t.proxy((function(){t.ajax.runComponentAction("bitrix:tasks.task",e,{mode:"class",data:{taskId:this.task["ID"],parameters:a}}).then(function(t){this.task.isBusy=false;window.app.hidePopupLoader();this.actExecute(e,t)}.bind(this),function(t){this.task.isBusy=false;window.app.hidePopupLoader();this.actFailure()}.bind(this))}),this),failure:this.actFailure})}else{t.ajax.runComponentAction("bitrix:tasks.task",e,{mode:"class",data:{taskId:this.task["ID"],parameters:a},onrequeststart:function(t){this.xhr=t}.bind(this)}).then(function(t){this.task.isBusy=false;window.app.hidePopupLoader();this.actExecute(e,t)}.bind(this),function(t){this.task.isBusy=false;window.app.hidePopupLoader();if(this.xhr&&this.xhr.status&&this.xhr.status===401){this.act(e,s,true)}else if(t.errors&&t.errors.length){this.actError(t.errors)}else{this.actFailure()}}.bind(this))}},actError:function(e){if(e&&e.length>0){for(var s=0;s<e.length;s++){e[s]=e[s]["message"]||e[s]["code"]}window.app.alert({text:e.join(". "),title:t.message("MB_TASKS_TASK_ERROR_TITLE")})}},actExecute:function(t,e){window.app.hidePopupLoader();if(e.errors&&e.errors.length){this.actError(e.errors);return}if(t==="delete"){window.BXMobileApp.onCustomEvent("onTaskWasRemoved",[this.task["ID"],this.variable("objectId"),e.data],true,true);return}window.BXMobileApp.onCustomEvent("onTaskWasPerformed",[this.task["ID"],this.variable("objectId"),e.data],true,true);this.actSuccess(t,e.data,true)},actSuccess:function(e,s,i){var a,o=false;if(e==="deleteFavorite"){o=true;this.task["ACTION"]["DELETE_FAVORITE"]=false;this.task["ACTION"]["ADD_FAVORITE"]=true;if(t("favorites"+this.task["ID"]))t.removeClass(t("favorites"+this.task["ID"]),"active")}else if(e==="addFavorite"){o=true;this.task["ACTION"]["DELETE_FAVORITE"]=true;this.task["ACTION"]["ADD_FAVORITE"]=false;if(t("favorites"+this.task["ID"]))t.addClass(t("favorites"+this.task["ID"]),"active")}else if(e==="delegate"){t.reload()}else if(e==="get"){this.task["ACTION"]={};for(a in s["RESULT"]["CAN"]["ACTION"]){if(s["RESULT"]["CAN"]["ACTION"].hasOwnProperty(a)){this.task["ACTION"][a.toUpperCase()]=s["RESULT"]["CAN"]["ACTION"][a]==="YES"||s["RESULT"]["CAN"]["ACTION"][a]==="true"||s["RESULT"]["CAN"]["ACTION"][a]===true}}o=true;var n=s["RESULT"]["DATA"]["REAL_STATUS"];if(t("bx-task-status-"+this.task["ID"])&&n!=this.task["REAL_STATUS"]){this.task["REAL_STATUS"]=s["RESULT"]["DATA"]["REAL_STATUS"];this.task["STATUS"]=s["RESULT"]["DATA"]["STATUS"];var r=t.Mobile.Tasks.statusMap[n]||"STATE_UNKNOWN";t("bx-task-status-"+this.task["ID"]).innerHTML=t.message("TASKS_STATUS_"+r)}}else if(i===true){this.act("get",s)}if(Application.getApiVersion()<31&&o){this.resetMenu(this.getDefaultMenu())}},actFailure:function(){window.app.alert({text:t.message("TASKS_LIST_GROUP_ACTION_ERROR1"),title:t.message("MB_TASKS_TASK_ERROR_TITLE")})}});if(t.MobileUI.TextField.defaultParams){window.BX.MobileUI.TextField.show()}else{t.addCustomEvent(t.MobileUI.events.MOBILE_UI_TEXT_FIELD_SET_PARAMS,(function(){window.BX.MobileUI.TextField.show()}))}})();
//# sourceMappingURL=script.map.js