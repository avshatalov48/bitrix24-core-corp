function __MBTasks__mobile_tasks_snmrouter_init(){MBTasks.onPullHandler=function(a){var s=!!(a&&a.module_id&&a.module_id==="tasks"&&a.command&&(a.command==="task_update"||a.command==="task_remove")&&a.params&&a.params.TASK_ID&&a.params.event_GUID);if(!s)return;if(MBTasks.residentTaskId!=a.params.TASK_ID)return;if(MBTasks.CPT.router.UUIDs_processed.indexOf(a.params.event_GUID)!=-1)return;if(a.command==="task_remove"){MBTasks.clearCacheForTask(a.params.TASK_ID);if(MBTasks.residentTaskId==a.params.TASK_ID){MBTasks.CPT.view.resetToBulk();MBTasks.CPT.view.hideBottomLoader();var e=BX.message("MB_TASKS_TASK_DETAIL_TASK_WAS_REMOVED_OR_NOT_ENOUGH_RIGHTS");document.getElementById("tasks-view-title").innerHTML=e.replace("#TASK_ID#",a.params.TASK_ID)}return}MBTasks.reloadPageAndCache(a.params.TASK_ID)};MBTasks.addCommentsToCache=function(a,s){var e="c"+a.toString();MBTasks.cache[e]=s};MBTasks.addDetailsToCache=function(a,s){var e="d"+a.toString();MBTasks.cache[e]=s};MBTasks.clearCacheForTask=function(a){var s="c"+a.toString();var e="d"+a.toString();if(MBTasks.cache.hasOwnProperty(s))delete MBTasks.cache[s];if(MBTasks.cache.hasOwnProperty(e))delete MBTasks.cache[e]};MBTasks.getBaseTaskData=function(a){app.getPageParams({callback:function(s){if(s===false||!s.task_id){s=false}else s.dataSource="pageParams";window.I_7_PAGE_DATA_GOT=true;a(s)}})};MBTasks.getExtendedTaskData=function(a,s){MBTasks.getBaseTaskData(function(e){MBTasks.getExtendedTaskData_step2(e,a,s)})};MBTasks.getAllTaskDataWoCache=function(a,s,e,t){MBTasks.clearCacheForTask(a);var r={task_id:a};MBTasks.getBaseTaskData(function(a){MBTasks.getExtendedTaskData_step2(a,e,t,true,s)})};MBTasks.getExtendedTaskData_step2=function(a,s,e,t,r){window.I_8_GET_TASKS_DATA_S2=true;if(a===false||!a.task_id){window.I_8_1_GET_TASKS_DATA_S2_EXIT=true;s(false);e(false);return}var i=a.task_id.toString();var n="d"+i;var o="c"+i;var T=false;var d="";if(t===true){d="BASE_AND_DETAIL_AND_COMMENTS";T=true;var c=false;var k=false}else{var _=MBTasks.gear==="D"||MBTasks.gear==="OD";var u=MBTasks.gear==="OD";var c=_&&MBTasks.cache.hasOwnProperty(n);var k=u&&MBTasks.cache.hasOwnProperty(o);if(!(c&&k))T=true;if(!c&&!k)d="DETAIL_AND_COMMENTS";else if(!c)d="DETAIL";else if(!k)d="COMMENTS"}if(T){window.I_9_AJAX_LOADING=true;var f={site:MBTasks.site,lang:MBTasks.lang,subject:d,task_id:i,user_id:MBTasks.userId,action:"get_task_data",DATE_TIME_FORMAT:MBTasks.CPT.router.arParams.DATE_TIME_FORMAT,PATH_TEMPLATE_TO_USER_PROFILE:MBTasks.CPT.view.arParams.PATH_TEMPLATE_TO_USER_PROFILE,PATH_TO_FORUM_SMILE:MBTasks.CPT.view.arParams.PATH_TO_FORUM_SMILE,AVA_WIDTH:MBTasks.CPT.view.arParams.AVA_WIDTH,AVA_HEIGHT:MBTasks.CPT.view.arParams.AVA_HEIGHT},l={sessid:MBTasks.sessid,site:MBTasks.site,lang:MBTasks.lang,subject:d,task_id:i,user_id:MBTasks.userId,action:"get_task_data",DATE_TIME_FORMAT:MBTasks.CPT.router.arParams.DATE_TIME_FORMAT,PATH_TEMPLATE_TO_USER_PROFILE:MBTasks.CPT.view.arParams.PATH_TEMPLATE_TO_USER_PROFILE,PATH_TO_FORUM_SMILE:MBTasks.CPT.view.arParams.PATH_TO_FORUM_SMILE,AVA_WIDTH:MBTasks.CPT.view.arParams.AVA_WIDTH,AVA_HEIGHT:MBTasks.CPT.view.arParams.AVA_HEIGHT};function B(){if(t)r(false);if(!c)s(false);if(!k)e(false)}function m(a){if(typeof a=="undefined")app.reload();if(a&&(a=='{"status":"failed"}'||a.status=="failed")){app.BasicAuth({success:BX.delegate(function(a){MBTasks.sessid=a.sessid_md5;BX.ajax({timeout:30,method:"POST",dataType:"json",url:MBTasks.snmRouterAjaxUrl,data:l,onsuccess:function(a){try{m(a)}catch(s){}},onfailure:function(){try{B()}catch(a){}}})},this),failure:function(){try{B()}catch(a){}}})}else if(a&&a.task_id){if(a.commentsData)MBTasks.addCommentsToCache(a.task_id,a.commentsData);if(a.detailsData)MBTasks.addDetailsToCache(a.task_id,a.detailsData);if(t)r(a.baseData);if(a.commentsHTML){throw"commentsHTML should be explained"}if(a.commentsData)e(a.commentsData);if(a.detailsData)s(a.detailsData)}else{if(t)r(false);if(!c)s(false);if(!k)e(false)}}try{BX.ajax({timeout:30,method:"POST",dataType:"json",data:l,url:MBTasks.snmRouterAjaxUrl+(MBTasks.snmRouterAjaxUrl.indexOf("?")>=0?"&":"?")+BX.ajax.prepareData(f),onsuccess:function(a,s,e,t){return function(a){try{m(a)}catch(s){}}}(c,k,t,l),onfailure:function(a,s,e,t){return function(){if(arguments.length>=2&&arguments[0]=="status"&&arguments[1]=="401"){app.BasicAuth({success:BX.delegate(function(a){MBTasks.sessid=a.sessid_md5;BX.ajax({timeout:30,method:"POST",dataType:"json",url:MBTasks.snmRouterAjaxUrl,data:t,onsuccess:function(a){try{m(a)}catch(s){}},onfailure:function(){try{B()}catch(a){}}})},this),failure:function(){try{B()}catch(a){}}})}else{try{B()}catch(a){}}}}(c,k,t,l)})}catch(M){BX.debug("Ajax exception:");BX.debug(M)}}if(c)s(MBTasks.cache[n]);if(k)e(MBTasks.cache[o])};MBTasks.CPT.router.switchToMatrix=function(a){var s="tasks-router-"+a;MBTasks.selectedMatrix=a;if(s!="tasks-router-view"){BX("tasks-detail-card-container-over").style.opacity=0;BX("comment_send_form").style.opacity=0}if(s!="tasks-router-edit"){BX("tasks-router-edit").style.opacity=0}if(s!="tasks-router-removed-task"){BX("tasks-router-removed-task").style.opacity=0}if(s=="tasks-router-view"){BX("tasks-detail-card-container-over").style.opacity=1;BX("comment_send_form").style.opacity=1}else BX(s).style.opacity=1};MBTasks.pageHided=function(){BX("tasks-detail-card-container-over").style.opacity=0;BX("comment_send_form").style.opacity=0;BX("tasks-router-removed-task").style.opacity=0;BX("tasks-router-edit").style.opacity=0};MBTasks.pageOpened=function(a){window.I_5_PAGE_OPENED=true;MBTasks.getBaseTaskData(function(s){if(!s||!s.task_id||!s.params_emitter||s.params_emitter!=="tasks_list"){window.I_5_1_EXIT_KZ_BAD_ARG=true;return false}MBTasks.residentTaskId=s.task_id;MBTasks.selectedMatrix=s.matrix;MBTasks.gear=s.gear;var e=s.task_id;var t=false;if(MBTasks.showedBaseDataHash===false){t=true}if(e!==MBTasks.showedBaseDataHash)a=true;if(!a){if(s.matrix==="view"){BX("tasks-detail-card-container-over").style.opacity=1;BX("comment_send_form").style.opacity=1}else if(s.matrix==="edit"){BX("tasks-router-edit").style.opacity=1}return}if(s.matrix==="view"){MBTasks.CPT.view.resetToBulk();MBTasks.CPT.view.renderBaseData(s);BX("tasks-detail-card-container-over").style.opacity=1;BX("comment_send_form").style.opacity=1;BX("tasks-detail-card-container-over").scrollTop=0}else if(s.matrix==="edit"){MBTasks.CPT.edit.resetToBulk();MBTasks.CPT.edit.renderBaseData(s);BX("tasks-router-edit").style.opacity=1}MBTasks.showedBaseDataHash=e;if(t){if(!MBTasks.firstTime){app.hideLoadingScreen();app.pullDownLoadingStop()}}window.I_6_GET_EXTENDED_TASKS_DATA=true;MBTasks.getExtendedTaskData(function(a){MBTasks.CPT.view.renderDetailData(a)},function(a){MBTasks.CPT.view.renderCommentsData(a);if(MBTasks.firstTime){app.hidePopupLoader();BX("tasks-detail-card-container-over").style.display="block";MBTasks.firstTime=false}})})};MBTasks.reloadPageAndCache=function(a,s){var s=s||{showPopupLoader:true};if(s.showPopupLoader)app.showPopupLoader();MBTasks.getAllTaskDataWoCache(a,function(a){app.getPageParams({callback:function(s){if(!s||!s.task_id){return}for(var e in a){if(a.hasOwnProperty(e))s[e]=a[e]}s.status_id=a.status_id;s.status_formatted_name=a.status_formatted_name;app.changeCurPageParams({data:s,callback:function(){var a=true;MBTasks.pageOpened(a);app.pullDownLoadingStop();app.hidePopupLoader()}})}})},function(){},function(a){})};BX.addCustomEvent("onTaskEditPerfomed",function(a){if(a.rc<1)return;var s=a.rc;MBTasks.reloadPageAndCache(s)});BX.addCustomEvent("onTaskActionBeforePerfome",function(a){MBTasks.CPT.router.UUIDs_processed.push(a.UUID)});BX.addCustomEvent("onTaskActionPerfomed",function(a){if(!(a&&a.module_id&&a.module_id==="tasks"&&a.action))return;var s=a.data;if(a.action==="remove"){if(a.rc!=="executed")return;MBTasks.clearCacheForTask(s.task_id);if(MBTasks.residentTaskId==s.task_id){var e=BX.message("MB_TASKS_TASK_DETAIL_TASK_WAS_REMOVED");document.getElementById("tasks-view-title").innerHTML=e.replace("#TASK_ID#",s.task_id);app.closeController({drop:true})}}else if(a.action==="edit"||a.action==="delegate"){if(s.commentsData)MBTasks.addCommentsToCache(s.task_id,s.commentsData);if(s.detailsData)MBTasks.addDetailsToCache(s.task_id,s.detailsData);var t=function(a){app.getPageParams({callback:function(s){if(!s||!s.task_id||s.task_id!=a.task_id){return}for(var e in a){if(a.hasOwnProperty(e))s[e]=a[e]}app.changeCurPageParams({data:s,callback:function(){var a=true;MBTasks.pageOpened(a)}})}})}(s.baseData)}else{if(s.commentsData)MBTasks.addCommentsToCache(s.task_id,s.commentsData);if(s.detailsData)MBTasks.addDetailsToCache(s.task_id,s.detailsData);if(MBTasks.residentTaskId==s.task_id){var t=function(a){app.getPageParams({callback:function(s){if(!s||!s.task_id||s.task_id!=a.task_id){return}s.status_id=a.status_id;s.status_formatted_name=a.status_formatted_name;app.changeCurPageParams({data:s,callback:function(){var a=true;MBTasks.pageOpened(a)}})}})}(s.baseData)}}});BX.addCustomEvent("onTasksDataChange",function(a){if(!(a.module_id&&a.module_id==="tasks"&&a.emitter&&a.emitter!=="tasks component mobile.tasks.detail"))return;app.reload()})}
//# sourceMappingURL=script.map.js