(function(){BX.namespace("BX.Forum");if(BX.Forum["transliterate"])return;var e={};BX.Forum.transliterate=function(e){e.onblur=function(){clearInterval(e.bxfInterval)};e.bxfInterval=setInterval(function(){if(e.value!=e.bxValue){e.bxValue=e.value;BX.translit(e.value,{max_len:70,change_case:"L",replace_space:"-",replace_other:"",delete_repeat_replace:true,use_google:true,callback:function(t){e.nextSibling.value=t}})}},500)};BX.Forum.AddTags=function(e){if(e&&e.parentNode){var t=e.parentNode.parentNode.previousSibling,r=e.parentNode.parentNode;BX.show(t);BX.remove(e.parentNode);if(r.innerHTML==="")BX.remove(r);var i=t.getElementsByTagName("INPUT");for(var a=0;a<i.length;a++){if(i[a].type.toUpperCase()=="TEXT"){BX.Forum.CorrectTags(i[a]);i[a].focus();break}}}return false};BX.Forum.CorrectTags=function(e){if(BX("TAGS_div_frame"))BX("TAGS_div_frame").id=e.id+"_div_frame"};BX.Forum.Form=function(){var e=function(e,t){if(e&&e["formID"]){this.editor=t;this.form=document.forms[e["formID"]];this.onsuccess=BX.delegate(this.onsuccess,this);this.onfailure=BX.delegate(this.onfailure,this);this.submit=BX.delegate(this.submit,this);BX.bind(this.form,"submit",this.submit);this.isAjax=e["ajaxPost"]=="Y";if(e["captcha"]=="Y"){var r=new n(this.form);BX.addCustomEvent(t,"OnContentChanged",BX.proxy(r.Show,r));BX.ready(function(){BX.bind(BX("forum-refresh-captcha"),"click",BX.proxy(r.Update,r))});if(e["bVarsFromForm"]=="Y")r.Show()}}};e.prototype={submit:function(e){if(this.validate()){this.prepareForm();this.disableButtons(true);if(!this.isAjax)return true;this.send()}return BX.PreventDefault(e)},prepareForm:function(){if(this.form["FILES[]"]){var e=[],t=BX.type.isDomNode(this.form["FILES[]"])?this.form["FILES[]"]:this.form["FILES[]"][0],r=BX.type.isDomNode(this.form["FILES[]"])?false:0;do{if(!BX("filetoupload"+t.value)){e.push(BX.adjust(BX.clone(t),{attrs:{name:"FILES_TO_UPLOAD[]",id:"filetoupload"+t.value}}))}t=r===false?false:r<this.form["FILES[]"].length?this.form["FILES[]"][r++]:false}while(!!t);while(e.length>0)this.form.appendChild(e.pop())}},disableButtons:function(e){var t=this.form.getElementsByTagName("input");for(var r=0;r<t.length;r++){if(t[r].getAttribute("type")=="submit")t[r].disabled=e!==false}},validate:function(){this.editor.SaveContent();var e="",t=this.editor.GetContent(),r=t.length,i=64e3;if(this.form.TITLE&&this.form.TITLE.value.length<=0)e+=BX.message("no_topic_name");if(r<=0)e+=BX.message("no_message");else if(r>i)e+=BX.message("max_len").replace(/#MAX_LENGTH#/gi,i).replace(/#LENGTH#/gi,r);if(e!==""){alert(e);return false}return true},busy:false,send:function(){if(this.busy===true)return false;this.busy=true;var e=BX.ajax.prepareForm(this.form,{dataType:"json"}).data;this.page_number=this.page_number||(typeof oForum!="undefined"&&typeof oForum.page_number!="undefined"?parseInt(oForum.page_number):0);this.page_number=this.page_number||0;e["pageNumber"]=this.page_number;BX.ajax({method:"POST",url:this.form.action,data:e,dataType:"json",onsuccess:this.onsuccess,onfailure:this.onfailure});return true},clearForm:function(){window.LHEPostForm.reinitDataBefore("POST_MESSAGE");var e,t=LHEPostForm.getHandler("POST_MESSAGE");if(this.editor){this.editor.CheckAndReInit("");for(var r in t.arFiles){if(t.arFiles.hasOwnProperty(r)){if((e=BX("file-doc"+t.arFiles[r]["id"]))&&!!e){BX.remove(e);BX.hide(BX("wd-doc"+t.arFiles[r]["id"]));BX.remove(BX("filetoupload"+t.arFiles[r]["id"]))}}}}if((e=BX.findChild(document,{className:"forum-preview"},true))&&!!e)BX.remove(e);var i=BX.findChild(this.form,{tagName:"TR",className:"error-load"},true,true),a=null;if(i)while((a=i.pop())&&!!a)BX.hide(a);var n=null,o=BX.findChild(this.form,{attr:{name:"captcha_code"}},true),s=BX.findChild(this.form,{attr:{name:"captcha_word"}},true),l=BX.findChild(this.form,{className:"forum-reply-field-captcha-image"},true);if(l)n=BX.findChild(l,{tag:"img"});if(o&&s&&n){s.value="";BX.ajax.getCaptcha(function(e){o.value=e["captcha_sid"];n.src="/bitrix/tools/captcha.php?captcha_code="+e["captcha_sid"]})}},onsuccess:function(e){this.busy=false;this.disableButtons(false);var t=BX.findChildren(document,{className:"forum-block-inner"},true);if(!t||t.length<1)BX.reload();var r,n=t[t.length-1],o,s;if(e.status){if(e["pageNumber"])this.page_number=parseInt(e["pageNumber"]);if(e["previewMessage"]){var l=BX.findChild(document,{className:"forum-preview"},true),d=BX.findChild(document,{className:"forum_post_form"},true).parentNode;a(e["previewMessage"],l,d,{className:"forum_post_form"})}else if(e["message"]){if(e["navigation"]){var f=BX.processHTML(e["navigation"],false),u=BX.create("DIV",{html:f.HTML}),c=u.hasChildNodes()?u.childNodes[0].innerHTML:"",m=BX.findChildren(document,{className:"forum-navigation-box"},true),p;if(m){for(p=0;p<m.length;p++)m[p].innerHTML=c}}o=BX.processHTML(e.message,false);if(e["allMessages"]){var h=n.parentNode;BX.remove(n);h.innerHTML+=o.HTML}else if(typeof e.message!="undefined"){var g=BX.findChildren(n,{tagName:"table",className:"forum-post-table"},true);if(g.length>0){var B=g[g.length-1],v=BX.findChild(B,{tagName:"tfoot"},true);if(v)BX.remove(v)}s=BX.findChild(n,{className:"forum-block-inner-end"});if(s){n.insertBefore(BX.create("DIV",{html:o.HTML}),s)}else{n.innerHTML+=o.HTML}}this.clearForm()}if(o&&o.SCRIPT){setTimeout(function(){BX.ajax.processScripts(o.SCRIPT)},1e3)}if(e["messageID"])if((r=BX("message"+e["messageID"]))&&r)BX.scrollToNode(r)}i(e["statusMessage"]||"")},onfailure:function(){BX.reload()}};return e}();var t=null,r=function(e){var t=BX.create("div");t.innerHTML=e;if(t.childNodes.length>0)return t.childNodes[0];else return null},i=function(e){var t=BX.findChild(document,{className:"forum-note-box"},true,true),i;if(t){for(i=0;i<t.length;i++){BX.remove(t[i])}}var a=BX.findChildren(document,{className:"forum-block-container"},true);if(!a||a.length<1)return;var n=a[a.length-1];if(e.length<1)return;var o=r(e);if(!o)return;var s=["forum-info-box","forum-header-box","forum-reply-form"];var l=n;while((l=l.nextSibling)&&!!l){if(l.nodeType==1){var d=false;for(i in s){if(s.hasOwnProperty(i)&&BX.hasClass(l,s[i])){d=true;break}}if(d){l.parentNode.insertBefore(o,l);break}}}},a=function(e,t,i,a){var n=null;if(!BX.type.isDomNode(i))return false;if(!BX.type.isDomNode(e)&&!BX.type.isArray(e)&&e.length>0)if(!(e=r(e)))return false;if(BX.type.isDomNode(t)){n=t.nextSibling;t.parentNode.removeChild(t)}if(!n)n=BX.findChild(i,a,true);if(n){n.parentNode.insertBefore(e,n)}else{i.appendChild(e)}return true};BX.Forum.ShowLastEditReason=function(e,t){if(t&&e)BX.show(t);else if(t)BX.hide(t)};BX.Forum.ShowVote=function(e){var t=e.parentNode.parentNode;BX.remove(e.parentNode);if(t.innerHTML==="")BX.remove(t);BX.show(BX("vote_params"));return false};window.vote_remove_answer=function(e){if(typeof e!="object"||e===null)return false;vote_add_answer(e.parentNode.parentNode.parentNode,true);var t=e.parentNode.parentNode.firstChild,r=/ANS_(\d+)__(\d+)_/i,i=r.exec(t.parentNode.id),a=parseInt(i[1]),n=parseInt(i[2]);if(t.value!==""&&!confirm(BX.message("vote_drop_answer_confirm")))return false;if(t.form["ANSWER_DEL["+a+"]["+n+"]"])t.form["ANSWER_DEL["+a+"]["+n+"]"].value="Y";t.parentNode.parentNode.removeChild(t.parentNode);return false};window.vote_add_answer=function(e,t){if(!e||typeof e!="object")return false;var r=t!==true?e.parentNode.parentNode:e,i=r.lastChild.previousSibling?/ANS_(\d+)__(\d+)_/i:/addA(\d+)/i,a=i.exec(r.lastChild.previousSibling?r.lastChild.previousSibling.id:e.name),n=parseInt(a[1]),o=parseInt(a[2]);if(!window["__fqan"+n])window["__fqan"+n]=o+1;if(t!==true){o=window["__fqan"+n]++;var s=BX.create("DIV",{html:window["arVoteParams"]["template_answer"].replace(/#Q#/g,n).replace(/#A#/g,o)});r.insertBefore(s.firstChild,r.lastChild)}return false};window.vote_remove_question=function(e){if(typeof e!="object"||e===null)return false;var t=e.parentNode.previousSibling,r=parseInt(t.id.replace("QUESTION_",""));if(t.value!==""&&!confirm(BX.message("vote_drop_question_confirm")))return false;if(t.form["QUESTION_DEL["+r+"]"])t.form["QUESTION_DEL["+r+"]"].value="Y";t.parentNode.parentNode.parentNode.removeChild(t.parentNode.parentNode);return false};window.vote_add_question=function(e,t){if(!window["__fqn"])window["__fqn"]=parseInt(t)+1;t=window["__fqn"]++;var r=BX.create("DIV",{html:window["arVoteParams"]["template_question"].replace(/#Q#/g,t)});e.parentNode.insertBefore(r.firstChild,e);return false};window.quoteMessageEx=function(e){var t=window["BXHtmlEditor"]?window["BXHtmlEditor"].Get("POST_MESSAGE"):false,r="";if(!(t&&t.toolbar.controls.Quote))return false;var i=t.selection.GetRange(t.selection.GetSelection(document));if(i&&!i.collapsed){var a=BX.create("DIV",{html:i.toHtml()});t.GetIframeDoc();r=t.util.GetTextContentEx(a);BX.remove(a)}if(r!=="")BX.DoNothing();else if(e>0)r=BX("message_text_"+e,true)?BX("message_text_"+e,true).innerHTML:"";else if(e.length>0)r=e;r=r.replace(/[\n|\r]*<br(\s)*(\/)*>/gi,"\n");if(r!==""){var n=function(e,t){var r=" ",i=/showWMVPlayer.*?bx_wmv_player.*?file:[\s'"]*([^"']*).*?width:[\s'"]*([^"']*).*?height:[\s'"]*([^'"]*).*?/gi,a=i.exec(t);if(a)r="[VIDEO WIDTH="+a[2]+" HEIGHT="+a[3]+"]"+a[1]+"[/VIDEO]";if(r==" "){var n=/bxPlayerOnload[\s\S]*?[\s'"]*file[\s'"]*:[\s'"]*([^"']*)[\s\S]*?[\s'"]*height[\s'"]*:[\s'"]*([^"']*)[\s\S]*?[\s'"]*width[\s'"]*:[\s'"]*([^"']*)/gi;a=n.exec(t);if(a)r="[VIDEO WIDTH="+a[3]+" HEIGHT="+a[2]+"]"+a[1]+"[/VIDEO]"}return r};r=r.replace(/<script[^>]*>/gi,"").replace(/<\/script[^>]*>/gi,"");r=r.replace(/\001([^\002]*)\002/gi,n);r=r.replace(/<noscript[^>]*>/gi,"").replace(/<\/noscript[^>]*>/gi,"");r=r.replace(/\003([^\004]*)\004/gi," ");r=r.replace(/<table class=["]*forum-quote["]*>[^<]*<thead>[^<]*<tr>[^<]*<th>([^<]+)<\/th><\/tr><\/thead>[^<]*<tbody>[^<]*<tr>[^<]*<td>/gi,"");r=r.replace(/<table class=["]*forum-code["]*>[^<]*<thead>[^<]*<tr>[^<]*<th>([^<]+)<\/th><\/tr><\/thead>[^<]*<tbody>[^<]*<tr>[^<]*<td>/gi,"");r=r.replace(/<table class=["]*data-table["]*>[^<]*<tbody>/gi,"");r=r.replace(/<\/td>[^<]*<\/tr>(<\/tbody>)*<\/table>/gi,"");r=r.replace(/[\r|\n]{2,}([\001|\002])/gi,"\n$1");var o=0;while(o++<50&&(r.search(/\002([^\002\003]*)\003/gi)>=0||r.search(/\001([^\001\003]*)\003/gi)>=0)){r=r.replace(/\002([^\002\003]*)\003/gi,"[CODE]$1[/CODE]").replace(/\001([^\001\003]*)\003/gi,"[QUOTE]$1[/QUOTE]")}var s=function(e,t,r){var i=new RegExp("([^]*)("+t+")([^]*)","i");var a=new RegExp("((?:)(?:[^]*))("+t+")((?:[^]*)(?:))","i");var n=0;while(n++<300&&e.search(i)>=0)e=e.replace(a,"$1"+r+"$3");return e};o=0;while(o++<10&&r.search(/\004([^\004\003]*)\003/gi)>=0){r=s(r,"<tr>","[TR]");r=s(r,"</tr>","[/TR]");r=s(r,"<td>","[TD]");r=s(r,"</td>","[/TD]");r=r.replace(/\004([^\004\003]*)\003/gi,"[TABLE]$1[/TD][/TR][/TABLE]")}r=r.replace(/[\001\002\003\004]/gi,"");if(BX.browser.IsIE())r=r.replace(/<img(?:(?:\s+alt\s*=\s*"?smile([^"\s]+)"?)|(?:\s+\w+\s*=\s*[^\s>]*))*>/gi,"$1");else r=r.replace(/<img(.*?)alt=["]*smile([^"\s]+)["]*[^>]*>/gi,"$2");r=r.replace(/<img(.+?)data-code="(.+?)"(.+?)>/gi,"$2");r=r.replace(/<a[^>]+href=["]([^"]+)"[^>]+>([^<]+)<\/a>/gi,"[URL=$1]$2[/URL]").replace(/<a[^>]+href=[']([^']+)'[^>]+>([^<]+)<\/a>/gi,"[URL=$1]$2[/URL]").replace(/<[^>]+>/gi," ").replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&quot;/gi,'"').replace(/(smile(?=[:;8]))/g,"").replace(/&shy;/gi,"").replace(/&nbsp;/gi," ");if(!!t&&!!r){var l;if(e>0){if(BX("message_block_"+e,true)&&BX("message_block_"+e,true).hasAttribute("bx-author-name")){l={name:BX("message_block_"+e,true).getAttribute("bx-author-name"),id:BX("message_block_"+e,true).getAttribute("bx-author-id")}}}if(t.GetViewMode()=="code"&&t.bbCode){if(!l)l="";else if(l.id>0)l="[USER="+l.id+"]"+l.name+"[/USER]";else l=l.name;l=l!==""?l+BX.message("MPL_HAVE_WRITTEN")+"\n":"";r=l+r}else if(t.GetViewMode()=="wysiwyg"){if(!l)l="";else if(l.id>0)l='<span id="'+t.SetBxTag(false,{tag:"postuser",params:{value:l.id}})+'" style="color: #2067B0; border-bottom: 1px dashed #2067B0;">'+l.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>";else l="<span>"+l.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>";r=(l!==""?l+BX.message("MPL_HAVE_WRITTEN")+"<br>":"")+t.ParseContentFromBbCode(r)}t.action.actions.quote.setExternalSelection(r);t.action.Exec("quote");if(t.fAutosave)BX.bind(t.pEditorDocument,"keydown",BX.proxy(t.fAutosave.Init,t.fAutosave))}}return false};window.reply2author=function(e){var t="";if(e>0&&BX("message_block_"+e,true)&&BX("message_block_"+e,true).hasAttribute("bx-author-name")){t={name:BX("message_block_"+e,true).getAttribute("bx-author-name"),id:BX("message_block_"+e,true).getAttribute("bx-author-id")}}var r=window["BXHtmlEditor"]?window["BXHtmlEditor"].Get("POST_MESSAGE"):false;if(!!r&&!!t){if(r.GetViewMode()=="code"&&r.bbCode){t=t.id>0?"[USER="+t.id+"]"+t.name+"[/USER]":t.name;r.textareaView.WrapWith("",", ",t)}else if(r.GetViewMode()=="wysiwyg"){t=t.id>0?'<span id="'+r.SetBxTag(false,{tag:"postuser",params:{value:t.id}})+'" style="color: #2067B0; border-bottom: 1px dashed #2067B0;">'+t.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>":"<span>"+t.name.replace(/</gi,"&lt;").replace(/>/gi,"&gt;")+"</span>";r.InsertHtml(t+", ")}r.Focus();BX.defer(r.Focus,r)()}return false};BX.Forum.params={};BX.Forum.Init=function(e){if(!e||typeof e!="object"){return}BX.Forum.params=e;if(BX.message("LANGUAGE_ID")=="ru"){BX.removeCustomEvent(window,"OnEditorInitedBefore",BX.Forum.OnEditorInitedBefore);BX.addCustomEvent(window,"OnEditorInitedBefore",BX.Forum.OnEditorInitedBefore)}BX.removeCustomEvent(window,"OnEditorInitedAfter",BX.Forum.OnEditorInitedAfter);BX.addCustomEvent(window,"OnEditorInitedAfter",BX.Forum.OnEditorInitedAfter)};BX.Forum.OnEditorInitedAfter=function(e){e.insertImageAfterUpload=true;BX.bind(BX("post_message_hidden"),"focus",function(){e.Focus()});new BX.Forum.Form(BX.Forum.params,e)};BX.Forum.OnEditorInitedBefore=function(e){e.AddButton({id:"translit",name:"Translit",iconClassName:"bxhtmled-button-translit",disabledForTextarea:false,toolbarSort:205,handler:function(){var t=function(t){if(typeof e.bTranslited=="undefined")e.bTranslited=false;var r=[],i=0;function a(e,t,i,a){r.push(t);return""}function n(e,t,i,a){return r.shift()}var o=new RegExp("(\\[[^\\]]*\\])","gi");t=t.replace(o,a);if(e.bTranslited==false){for(i=0;i<capitEngLettersReg.length;i++)t=t.replace(capitEngLettersReg[i],capitRusLetters[i]);for(i=0;i<smallEngLettersReg.length;i++)t=t.replace(smallEngLettersReg[i],smallRusLetters[i]);e.bTranslited=true}else{for(i=0;i<capitRusLetters.length;i++)t=t.replace(capitRusLettersReg[i],capitEngLetters[i]);for(i=0;i<smallRusLetters.length;i++)t=t.replace(smallRusLettersReg[i],smallEngLetters[i]);e.bTranslited=false}t=t.replace(new RegExp("","g"),n);return t};e.SaveContent();var r=t(e.GetContent());BX.defer(function(){e.SetContent(r)})()}})};var n=function(e){if(e==null)return false;this.div=e.div||null;this.input=e.input||null;this.image=e.image||null;this.hidden=e.hidden||null;if(!(this.div&&this.input&&this.image&&this.hidden))return false;setTimeout(BX.proxy(this.Bind,this),200);return true};n.prototype={BindEvents:function(){var e=LHEPostForm.getEditor("POST_MESSAGE");BX.bind(LHEPostForm.getEditor("POST_MESSAGE"),"OnContentChanged",BX.proxy(this.Show,this))},Bind:function(){var e=LHEPostForm.getEditor("POST_MESSAGE");this.BindEvents();e.forumFormCaptcha=this;e.ffcSetEditorContent=e.SetContent;e.SetEditorContent=function(e){var t=this.ffcSetEditorContent(e);this.forumFormCaptcha.BindEvents();return t};if(e.GetContent().length>0)this.Show()},Show:function(){function e(e){var t=e.style.display||BX.style(e,"display");return t!="none"}if(!e(this.div)){BX.show(this.div);this.Update()}},UpdateControls:function(e){this.input.value="";this.hidden.value=e["captcha_sid"];this.image.src="/bitrix/tools/captcha.php?captcha_code="+e["captcha_sid"]},Update:function(){BX.ajax.getCaptcha(BX.proxy(this.UpdateControls,this))}}})();