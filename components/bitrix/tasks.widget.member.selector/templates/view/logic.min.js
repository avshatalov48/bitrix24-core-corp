"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetMemberSelectorView!="undefined"){return}BX.Tasks.Component.TasksWidgetMemberSelectorView=BX.Tasks.Component.extend({sys:{code:"mem-sel"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);this.switchDeleteButtonShow()},bindEvents:function(){this.getManager();var e={AUDITORS:"auditor",ACCOMPLICES:"accomplice",RESPONSIBLE:"responsible"};var t=this;if(this.option("role")==="AUDITORS"||this.option("role")==="ACCOMPLICES"){BX.Event.EventEmitter.subscribe("BX.Tasks.CheckListItem:"+e[this.option("role")]+"Added",function(e){t.getManager().onSelectorItemSelected(e.data);t.onChangeByUser()})}if(e[this.option("role")]){BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:"+e[this.option("role")]+"Selected",function(e){t.getManager().onSelectorItemSelected(e.data);t.onChangeByUser()});BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:"+e[this.option("role")]+"Deselected",function(e){t.getManager().onSelectorItemDeselected(e.data);if(t.option("role")==="AUDITORS"||t.option("role")==="ACCOMPLICES"){t.onChangeByUser()}})}},setHeaderButtonLabelText:function(e){this.control("header-button").innerHTML=BX.util.htmlspecialchars(e)},getManager:function(){return this.subInstance("mgr",function(){var e=new this.constructor.Manager({scope:this.scope(),data:this.option("data"),query:this.getQuery(),nameTemplate:this.option("nameTemplate"),min:this.option("min"),max:this.option("max"),path:this.option("path"),role:this.option("role"),taskLimitExceeded:this.option("taskLimitExceeded")});e.bindEvent("change-by-user",this.onChangeByUser.bind(this));return e})},onChangeByUser:function(){if(this.option("enableSync")){var e=parseInt(this.option("entityId"));var t=this.option("entityRoute");var i=this.option("fieldName");if(!e||!t||!i){return}var n={id:e,data:{}};var r=[];var s=[];this.getManager().each(function(e){s.push(e.value());r.push({ID:e.value(),NAME:e.data().NAME,LAST_NAME:e.data().LAST_NAME,EMAIL:e.data().EMAIL})});var a=this.getManager();this.getQuery().add("integration.intranet.absence",{userIds:s},{},BX.delegate(function(e,t){if(!e.checkHasErrors()){if(t.RESULT.length>0){var i=t.RESULT.reduce(function(e,t){return e+"<br />"+t});var n=BX.PopupWindowManager.create("popupMenuOptions",BX(a.scope()),{content:i,darkMode:true,autoHide:true,width:200});n.show()}}},this));n.data[i]=r;this.callRemote(t+".update",n).then(function(){BX.Tasks.Util.fireGlobalTaskEvent("UPDATE",{ID:e},{STAY_AT_PAGE:true},{id:e})});this.switchDeleteButtonShow()}},addItem:function(e){this.getManager().addItem(e)},deleteItem:function(e){this.getManager().deleteItem(this.getManager().extractItemValue(e))},switchDeleteButtonShow:function(e){if(this.option("min")!==1){return}var t=document.getElementsByClassName("js-id-mem-sel-is-i-delete");if(e){if(t.length===2){Object.keys(t).forEach(function(e){BX.addClass(t[e],"hidden")})}}else{if(t.length===1){BX.addClass(t[0],"hidden")}else{Object.keys(t).forEach(function(e){BX.removeClass(t[e],"hidden")})}}}}});BX.Tasks.Component.TasksWidgetMemberSelectorView.Manager=BX.Tasks.UserItemSet.extend({dialog:null,sys:{code:"mem-sel-is"},options:{preRendered:true,autoSync:true,role:false,multiple:false,useSearch:true,forceTop:true,useAdd:true,controlBind:"class",itemFx:"vertical",useSmartCodeNaming:true},methods:{construct:function(){this.callConstruct(BX.Tasks.UserItemSet);this.fireUserTriggeredChangeDebounce=BX.debounce(this.fireUserTriggeredChangeDebounce,800);this.initDialog()},initDialog:function(){this.dialog=new BX.UI.EntitySelector.Dialog({enableSearch:true,multiple:this.option("max")>1,context:"TASKS_MEMBER_SELECTOR_VIEW_"+this.option("role"),entities:this.getDialogEntities(),preselectedItems:this.getDialogSelectedItems(),undeselectedItems:this.getDialogUndeselectedItems(),events:{"Item:onSelect":function(e){var t=e.getData().item;var i=this.prepareUserData(t);var n={ACCOMPLICES:"accomplice",AUDITORS:"auditor",RESPONSIBLE:"responsible"};BX.Event.EventEmitter.emit("BX.Tasks.MemberSelector:"+n[this.option("role")]+"Selected",i)}.bind(this),"Item:onDeselect":function(e){var t=e.getData().item;var i=this.prepareUserData(t);var n={ACCOMPLICES:"accomplice",AUDITORS:"auditor",RESPONSIBLE:"responsible"};BX.Event.EventEmitter.emit("BX.Tasks.MemberSelector:"+n[this.option("role")]+"Deselected",i)}.bind(this)}});var e=this.scope().getElementsByClassName("js-id-mem-sel-is-control");for(var t=0;t<e.length;t++){var i=e[t];i.addEventListener("click",function(e){var t=this.option("role");var i=this.option("taskLimitExceeded");if((t==="ACCOMPLICES"||t==="AUDITORS")&&i){BX.UI.InfoHelper.show("limit_tasks_observers_participants");return}this.dialog.setTargetNode(e);this.dialog.show()}.bind(this))}},getDialogUndeselectedItems:function(){var e=this.option("data");var t=[];if(this.option("min")!==1||this.option("max")!==1){return}for(var i in e){t.push(this.prepareItemData(e[i]))}return t},getDialogSelectedItems:function(){var e=this.option("data");var t=[];for(var i in e){t.push(this.prepareItemData(e[i]))}return t},prepareItemData:function(e){var t=0;if(e.ID){t=e.ID}else if(e.id){t=e.id}var i=this.option("mode");return[i==="group"?"project":"user",t]},getDialogEntities:function(){var e=this.option("mode");var t=[];if(e==="user"){t=[{id:"user",options:{emailUsers:true,networkUsers:true,extranetUsers:true,inviteGuestLink:true,myEmailUsers:true}},{id:"department"}]}else if(e==="group"){t=[{id:"project"}]}return t},prepareUserData:function(e){var t=this.option("role");var i=e.getCustomData();var n=e.getEntityType();var r=this.option("mode");var s={ACCOMPLICES:"A",AUDITORS:"U",RESPONSIBLE:"R"};return{AVATAR:e.avatar,DESCRIPTION:"",entityType:s[t],id:e.getId(),name:i.get("name"),lastName:i.get("lastName"),email:i.get("email"),nameFormatted:BX.Text.encode(e.getTitle()),networkId:"",url:e.getLink(),user_type:n,type:{crmemail:false,extranet:n==="extranet",email:n==="email",network:n==="network"},VALUE:(r==="group"?"SG":"U")+e.getId()}},prepareData:function(e){e=this.callMethod(BX.Tasks.UserItemSet,"prepareData",arguments);e.AVATAR_CSS=e.AVATAR?"background: url('"+e.AVATAR+"') center no-repeat; background-size: 35px;":"";return e},openAddForm:function(){var e=this.option("role");var t=this.option("taskLimitExceeded");if((e==="ACCOMPLICES"||e==="AUDITORS")&&t){BX.UI.InfoHelper.show("limit_tasks_observers_participants");return}this.callMethod(BX.Tasks.UserItemSet,"openAddForm")},onClose:function(){if(this.vars.changed){this.fireUserTriggeredChange()}this.vars.changed=false},onItemDeleteClicked:function(e){this.parent().switchDeleteButtonShow(true);var t=this.doOnItem(e,this.deleteItem);if(t){this.fireUserTriggeredChangeDebounce()}},fireUserTriggeredChangeDebounce:function(){this.fireUserTriggeredChange()},fireUserTriggeredChange:function(){this.fireEvent("change-by-user")},deleteItem:function(e,t){if(this.callMethod(BX.Tasks.UserItemSet,"deleteItem",arguments)){this.unselectDialogItem(e);return true}return false},unselectDialogItem:function(e){if(typeof e!=="object"){return}if(!this.dialog){return}this.dialog.getItem(this.prepareItemData(e.data())).deselect()}}})}).call(this);
//# sourceMappingURL=logic.map.js