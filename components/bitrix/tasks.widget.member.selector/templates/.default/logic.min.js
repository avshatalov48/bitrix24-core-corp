"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetMemberSelector!="undefined"){return}BX.Tasks.Component.TasksWidgetMemberSelector=BX.Tasks.Component.extend({sys:{code:"tdp-mem-sel",types:[]},methodsStatic:{instances:[],getInstance:function(e){return BX.Tasks.Component.TasksWidgetMemberSelector.instances[e]},addInstance:function(e,t){BX.Tasks.Component.TasksWidgetMemberSelector.instances[e]=t}},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);BX.Tasks.Component.TasksWidgetMemberSelector.addInstance(this.id(),this);this.getSelector();if(this.option("inputSpecial")){this.getSelector().bindEvent("change",this.onChanged.bind(this))}var e=this;if(this.option("userType")==="auditor"||this.option("userType")==="accomplice"){BX.Event.EventEmitter.subscribe("BX.Tasks.CheckListItem:"+this.option("userType")+"Added",(function(t){e.getSelector().onSelectorItemSelected(t.data)}))}BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:"+this.option("userType")+"Selected",(function(t){e.getSelector().onControlItemSelected(t.data)}));BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:"+this.option("userType")+"Deselected",(function(t){e.getSelector().onSelectorItemDeselected(t.data)}))},onChanged:function(e){var t="";var i="";if(e[0]){t=this.getSelector().get(e[0]).id()}this.control("sole-input").value=t;if(e[0]&&e[0].substr(0,2)==="SG"){i=this.getSelector().get(e[0]).opts.data.DISPLAY;BX.onCustomEvent(this,"onProjectChanged",{groupId:e,owner:i})}else{BX.onCustomEvent(this,"onProjectChanged",{})}},getSelector:function(){return this.subInstance("selector",(function(){var e={loc:this.option("loc"),scope:this.scope(),hidePreviousIfSingleAndRequired:true,data:this.option("data"),max:this.option("max"),min:this.option("min"),nameTemplate:this.option("nameTemplate"),path:this.option("path"),preRendered:true,popupOffsetTop:3,popupOffsetLeft:40,readOnly:this.option("readOnly"),parent:this,userType:this.option("userType"),taskLimitExceeded:this.option("taskLimitExceeded"),viewSelectorEnabled:this.option("viewSelectorEnabled"),taskMailUserIntegrationEnabled:this.option("taskMailUserIntegrationEnabled"),taskMailUserIntegrationFeatureId:this.option("taskMailUserIntegrationFeatureId"),networkEnabled:this.option("networkEnabled"),isProjectLimitExceeded:this.option("isProjectLimitExceeded"),projectFeatureId:this.option("projectFeatureId"),entityId:this.option("entityId"),isCollaber:this.option("isCollaber"),isNeedShowPreselectedCollabHint:this.option("isNeedShowPreselectedCollabHint")};var t=this.option("types");e.mode=t.USER?"user":"group";e.useAdd=!!t["USER.MAIL"]&&this.option("modulesAvailable").mail;var i=new this.constructor.ItemManager(e);i.bindEvent("change",function e(){this.fireEvent("change",[arguments[0]])}.bind(this));return i}))},count:function(){return this.getSelector().count()},export:function(){return this.getSelector().exportItemData(true)},replaceItem:function(e,t){this.getSelector().replaceItem(e,t)},value:function(){return this.getSelector().value()},replaceAll:function(e){var t=this.getSelector();t.unload({itemFx:false,checkRestrictions:false});t.load(e)},readOnly:function(e){this.getSelector().readonly(e)}}});BX.Tasks.Component.TasksWidgetMemberSelector.ItemManager=BX.Tasks.UserItemSet.extend({dialog:null,dialogCallback:true,sys:{code:"tdp-mem-sel-is"},options:{controlBind:"class",itemFx:"horizontal",itemFxHoverDelete:true,prefixId:true,mode:"all",path:{},hidePreviousIfSingleAndRequired:false},methods:{construct:function(){this.callConstruct(BX.Tasks.UserItemSet);this.initDialog()},getDialog:function(){if(this.dialog){return this.dialog}this.dialog=new BX.UI.EntitySelector.Dialog({id:"tasksMemberSelector_"+this.option("userType"),enableSearch:true,multiple:this.option("max")>1,context:"TASKS_MEMBER_SELECTOR_EDIT_"+this.option("userType"),entities:this.getDialogEntities(),preselectedItems:this.getDialogSelectedItems(),autoHide:true,autoHideHandler:function(e){if(!BX.Dom.hasClass(e.target,"task-form-field-item-delete")){return true}var t=e.target.parentElement;var i=this.getItemByNode(t);return!i||i.detectScope()!==t}.bind(this),hideOnSelect:this.option("userType")==="responsible",events:{"Item:onSelect":function(e){if(this.dialogCallback===false){return}var t=e.getData().item;var i=this.prepareUserData(t);BX.Event.EventEmitter.emit("BX.Tasks.MemberSelector:"+this.option("userType")+"Selected",i);this.rerenderTitle(t)}.bind(this),"Item:onDeselect":function(e){if(this.dialogCallback===false){return}if(this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min===1&&this.count()===1){this.forceDeleteFirst()}else{var t=e.getData().item;var i=this.prepareUserData(t);BX.Event.EventEmitter.emit("BX.Tasks.MemberSelector:"+this.option("userType")+"Deselected",i)}}.bind(this),onHide:function(){if(this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min>0&&this.count()<1){this.restoreKept()}}.bind(this)}});return this.dialog},showPreselectedCollabHint:function(e){BX.Runtime.loadExtension("popup").then((()=>{const t=this.option("loc")?.preselectedCollabHint;const i=BX.PopupWindowManager.create("tasks-preselected-collab-hint",e,{offsetLeft:30,angle:true,closeByEsc:true,closeIcon:{top:"2px",right:"2px"},autoHide:true,content:`<div class="tasks-preselected-collab-popup-title">${t}</div>`});const s=()=>{const t=()=>{const t=e.getBoundingClientRect();const i=t.left+window.pageXOffset;const s=t.bottom+window.pageYOffset;return{left:i,top:s}};const s=t();if(s.left===0&&s.top===0){return}const o=document.querySelector(".bx-html-editor");if(!o){return}const n=new ResizeObserver((e=>{i.setBindElement(t());i.adjustPosition()}));n.observe(o);i.subscribe("onClose",(()=>{n.unobserve(o)}))};s();i.show()}))},initDialog:function(){var e=this.scope().getElementsByClassName("js-id-tdp-mem-sel-is-control");for(var t=0;t<e.length;t++){var i=e[t];if(this.option("isNeedShowPreselectedCollabHint")){this.showPreselectedCollabHint(i)}i.addEventListener("click",function(e){var t=this.option("userType");var i=this.option("taskLimitExceeded");var s=this.option("viewSelectorEnabled");if((t==="accomplice"||t==="auditor")&&(i||!s)){this.showLimit("tasks_observers_participants",e.target);return}if(t==="project"&&this.option("isProjectLimitExceeded")&&!this.option("isCollaber")){this.showLimit(this.option("projectFeatureId"));return}this.getDialog().setTargetNode(e.target.closest(".task-options-item-open-inner"));this.getDialog().show()}.bind(this))}},showLimit(e,t=null){BX.Runtime.loadExtension("tasks.limit").then((i=>{const{Limit:s}=i;s.showInstance({featureId:e,bindElement:t,limitAnalyticsLabels:{module:"tasks",source:"edit"}})}))},getDialogSelectedItems:function(){var e=this.option("data");var t=[];var i=null;for(var s=0;s<e.length;s++){i=this.prepareItemData(e[s]);if(i){t.push(i)}}return t},getDialogUndeselectedItems:function(){var e=this.option("data");var t=[];if(this.option("min")!==1||this.option("max")!==1){return}var i=null;for(var s=0;s<e.length;s++){i=this.prepareItemData(e[s]);if(i){t.push(i)}}return t},getDialogEntities:function(){var e=this.option("mode");var t=this.option("networkEnabled");var i=[];if(e==="user"){i=[{id:"user",options:{emailUsers:true,networkUsers:t,extranetUsers:true,inviteGuestLink:true,myEmailUsers:true,analyticsSource:"tasks",lockGuestLink:!this.option("taskMailUserIntegrationEnabled"),lockGuestLinkFeatureId:this.option("taskMailUserIntegrationFeatureId")}},{id:"department"}]}else if(e==="group"){i=[{id:"project",options:{shouldSelectDialogId:true}}]}return i},prepareItemData:function(e){var t=0;if(typeof e==="string"){t=e.replace(/[A-Za-z]/gi,"")}else if(typeof e==="object"){if(e.ID){t=e.ID}else if(e.id){t=e.id}}if(t<=0){return null}var i=this.option("mode");return[i==="group"?"project":"user",t]},prepareUserData:function(e){var t=e.getCustomData();var i=e.getEntityType();var s=this.option("mode");const o={AVATAR:e.avatar,DESCRIPTION:"",ENTITY_TYPE:s==="group"?"SG":"U",ID:e.getId(),NAME:t.get("name"),LAST_NAME:t.get("lastName"),EMAIL:t.get("email"),nameFormatted:BX.Text.encode(e.getTitle()),NETWORK_ID:"",USER_TYPE:i,type:{crmemail:false,extranet:i==="extranet",email:i==="email",network:i==="network",collab:i==="collab",collaber:i==="collaber"},VALUE:(s==="group"?"SG":"U")+e.getId()};if(i==="collab"){const t=e.getCustomData().get("dialogId");if(t){o.URL=this.option("path").collab?.replace("#DIALOG_ID#",t)}else{o.URL=""}}else{o.URL=e.getLink()}return o},onSearchBlurred:function(){var e=BX("invite-email-email-user-popup");if(e!==null&&e.style.display==="block"){return}if(this.callMethod(BX.Tasks.UserItemSet,"onSearchBlurred")){if(this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min>0){this.restoreKept()}}},onSelectorItemSelected:function(e){if(this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min>0){this.vars.changed=true;var t=this.extractItemValue(e);if(!this.hasItem(t)){this.addItem(e);this.vars.toDelete=false;if(!this.checkCanAddItems()){this.instances.selector.close();this.onSearchBlurred()}}this.resetInput()}else{this.callMethod(BX.Tasks.UserItemSet,"onSelectorItemSelected",arguments)}},onControlItemSelected:function(e){this.callMethod(BX.Tasks.UserItemSet,"onSelectorItemSelected",arguments)},openAddForm:function(){var e=this.option("userType");var t=this.option("taskLimitExceeded");if((e==="accomplice"||e==="auditor")&&t){BX.Runtime.loadExtension("tasks.limit").then((e=>{const{Limit:t}=e;t.showInstance({featureId:"tasks_observers_participants",limitAnalyticsLabels:{module:"tasks",source:"taskEdit"}})}));return}if(this.option("hidePreviousIfSingleAndRequired")){if(this.vars.constraint.min==1&&this.vars.constraint.max==1){this.forceDeleteFirst()}}this.callMethod(BX.Tasks.UserItemSet,"openAddForm")},onItemDeleteByCross:function(e){if(this.callMethod(BX.Tasks.UserItemSet,"onItemDeleteByCross",arguments)){return true}if(this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min===1&&this.count()===1){this.forceDeleteFirst();this.getDialog().setTargetNode(this.scope());this.getDialog().show()}return false},forceDeleteFirst:function(){var e=this.getItemFirst();if(e){this.vars.toDelete=e.data();this.deleteItem(e.value(),{checkRestrictions:false})}},restoreKept:function(){if(this.vars.toDelete){this.addItem(this.vars.toDelete,{checkRestrictions:false});this.vars.toDelete=false}},addItem:function(e,t){this.callMethod(BX.Tasks.UserItemSet,"addItem",arguments);this.selectDialogItem(e)},deleteItem:function(e,t){if(this.callMethod(BX.Tasks.UserItemSet,"deleteItem",arguments)){this.unselectDialogItem(e);return true}return false},unselectDialogItem:function(e){if(!this.getDialog()){return}this.dialogCallback=false;if(typeof e==="object"){e=e.data()}e=this.prepareItemData(e);if(e){var t=this.getDialog().getItem(e);t&&t.deselect()}this.dialogCallback=true},selectDialogItem:function(e){if(!this.getDialog()){return}this.dialogCallback=false;e=this.prepareItemData(e);if(e){var t=this.getDialog().getItem(e);t&&t.select(true)}this.dialogCallback=true},rerenderTitle(e){if(e.getEntityId()!=="project"){return}const t=this.option("entityId");const i=document.querySelector(`#task-${t}-group-title-edit`);if(!i){return}if(e?.entityType==="collab"){i.textContent=this.option("loc")?.type?.collab;return}i.textContent=this.option("loc")?.type?.group}}})}).call(this);
//# sourceMappingURL=logic.map.js