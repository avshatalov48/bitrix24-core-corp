(function(t,e,i,a,s){"use strict";BX.namespace("BX.Vote");var n=function(){function t(e,i){babelHelpers.classCallCheck(this,t);this.id=null;this.params={isNew:true,isSaved:false};if(e>0){this.params.isNew=false;this.id=e}else if(e!==0){this.id=e}this.data={MESSAGE:"",MESSAGE_TYPE:"text",FIELD_TYPE:0};this.adjust(i);a.EventEmitter.subscribe(this,"onApply",this.apply.bind(this));a.EventEmitter.subscribe(this,"onDelete",this.delete.bind(this))}babelHelpers.createClass(t,[{key:"adjust",value:function t(e){var i,a=BX.type.isPlainObject(e)?e:{};for(i in this.data){if(this.data.hasOwnProperty(i)){if(a[i])this.data[i]=a[i]}}}},{key:"getId",value:function t(){return this.id}},{key:"getData",value:function t(){return this.data}},{key:"apply",value:function t(e){var i=babelHelpers.slicedToArray(e.data,1),a=i[0];this.adjust(a);return this}},{key:"delete",value:function t(){return this}}]);return t}();n.repo={};n.getItem=function(t,e){var i=new n(t,BX.type.isPlainObject(e)?e:{});if(t!==0&&n.repo[t]){n.repo[t]=null;delete n.repo[t];n.repo[t]=i}return i};var l=function(){function t(e){babelHelpers.classCallCheck(this,t);this.values=[];this.valuesById={};this.valuesByCode={};e.forEach(function(t){this.values.push(t);this.valuesById[t["ID"].toLowerCase()]=t;this.valuesByCode[t["CODE"].toLowerCase()]=t}.bind(this))}babelHelpers.createClass(t,[{key:"getByCode",value:function t(e){return this.valuesByCode[e]}},{key:"getById",value:function t(e){return this.valuesById[e]}},{key:"getIdByCode",value:function t(e){if(this.valuesByCode.hasOwnProperty(e)){return this.valuesByCode[e]["ID"]}return null}}]);return t}();var r={setTypes:function t(e){r.obj=new l(e)},getValues:function t(){return r.obj.values},isTextType:function t(e){var i=r.obj.getById(e);if(BX.type.isPlainObject(i)){return i["CODE"].toUpperCase().substr(0,4)==="TEXT"}return false}};var o={setTypes:function t(e){o.obj=new l(e)},isCompatibilityMode:function t(){var e=BX("FIELD_TYPE").value;return String(e).toLowerCase()===o.obj.getIdByCode("compatibility")},getActive:function t(){return String(BX("FIELD_TYPE").value).toUpperCase()}};var u=function(){function t(){babelHelpers.classCallCheck(this,t);this.id="Editor";this.popup=null;this.reset();this.debug=true;return this}babelHelpers.createClass(t,[{key:"onApply",value:function t(e){a.EventEmitter.emit(this.answer,"onApply",[e]);a.EventEmitter.emit(this,"onApply",[this.answer.getId(),this.answer.getData(),Object.assign({},this.gridData)]);this.reset()}},{key:"onCancel",value:function t(){a.EventEmitter.emit(this.answer,"onCancel",[]);this.reset()}},{key:"onDelete",value:function t(){a.EventEmitter.emit(this.answer,"onDelete",[]);this.reset()}},{key:"setGridData",value:function t(e){this.gridData={gridInstanceId:e["gridInstanceId"],gridId:e["gridId"],maxSort:e["maxSort"]};return this}},{key:"getGridId",value:function t(){return this.gridData.gridId}},{key:"setAnswer",value:function t(e,i){var a=n.getItem(e,i);if(this.answer!==null&&this.answer!==a)this.onCancel();this.answer=a;return this}},{key:"reset",value:function t(){delete this.answer;this.answer=null;delete this.gridData;this.gridData={id:null,gridId:null,maxSort:null}}},{key:"show",value:function t(){this.showEditor(this.answer.getData())}},{key:"showEditor",value:function t(e){if(this.popup!==null)this.popup.close();var s=false;var n=String(e["FIELD_TYPE"]);var l="";r.getValues().forEach((function(t){l+=['<option value="'+t["ID"]+'"'+(n===t["ID"]?" selected":"")+">",t["TITLE"],"</option>"].join("")}));l=['<div class="ui-form-block ui-form-block-html-text">\t\t\t\t\t<label class="ui-ctl ui-ctl-radio ui-ctl-wa ui-ctl-xs"> \t\t\t\t\t\t<input type="radio" name="answer[MESSAGE_TYPE]" '+(e["MESSAGE_TYPE"]==="html"?"":"checked")+' class="ui-ctl-element" value="text"> \t\t\t\t\t\t<div class="ui-ctl-label-text">text</div> \t\t\t\t\t</label>\t\t\t\t\t<label className="ui-ctl ui-ctl-wa ui-ctl-xs"><div class="ui-ctl-label-text">&nbsp;/&nbsp;</div></label> \t\t\t\t\t<label class="ui-ctl ui-ctl-radio ui-ctl-wa ui-ctl-xs"> \t\t\t\t\t\t<input type="radio" name="answer[MESSAGE_TYPE]" '+(e["MESSAGE_TYPE"]==="html"?"checked":"")+' class="ui-ctl-element" value="html"> \t\t\t\t\t\t<div class="ui-ctl-label-text">html</div> \t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div class="ui-form-block">\t\t\t\t\t<div class="ui-ctl ui-ctl-textarea" id="answer_MESSAGE_block">\t\t\t\t\t\t<textarea name="answer[MESSAGE]" class="ui-ctl-element" id="ANSWER_MESSAGE" placeholder="'+i.Loc.getMessage("VOTE_ANSWER_PLACEHOLDER")+'">'+BX.util.htmlspecialchars(e["MESSAGE"])+'</textarea>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t\t<input id="answer_FIELD_TYPE" name="answer[FIELD_TYPE]" type="hidden" value="" class="ui-ctl-element"> '+(o.isCompatibilityMode()===true?'<div class="ui-form-block">\t\t\t\t\t<label for="id1" class="ui-ctl-label-text">'+i.Loc.getMessage("VOTE_ANSWER_FIELD_TYPE")+'</label>\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown">\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\t\t\t\t\t\t<select name="answer[FIELD_TYPE]" class="ui-ctl-element">'+l+"</select>\t\t\t\t\t</div>\t\t\t\t</div> ":'<input  name="answer[FIELD_TYPE]" type="hidden" value="'+o.getActive()+'">')].join();var u="";r.getValues().forEach((function(t){if(t["CODE"].substring(0,4).toUpperCase()==="TEXT"){s=s||n===t["ID"];u+=['<option value="'+t["ID"]+'"'+(n===t["ID"]?" selected":"")+">",t["TITLE"],"</option>"].join("")}}));u=['<div class="ui-form-block ui-form-block-html-text">\t\t\t\t\t<label class="ui-ctl ui-ctl-radio ui-ctl-wa ui-ctl-xs"> \t\t\t\t\t\t<input type="radio" name="answer[MESSAGE_TYPE]" '+(e["MESSAGE_TYPE"]==="html"?"":"checked")+' class="ui-ctl-element" value="text"> \t\t\t\t\t\t<div class="ui-ctl-label-text">text</div> \t\t\t\t\t</label>\t\t\t\t\t<label className="ui-ctl ui-ctl-wa ui-ctl-xs"><div class="ui-ctl-label-text">&nbsp;/&nbsp;</div></label> \t\t\t\t\t<label class="ui-ctl ui-ctl-radio ui-ctl-wa ui-ctl-xs"> \t\t\t\t\t\t<input type="radio" name="answer[MESSAGE_TYPE]" '+(e["MESSAGE_TYPE"]==="html"?"checked":"")+' class="ui-ctl-element" value="html"> \t\t\t\t\t\t<div class="ui-ctl-label-text">html</div> \t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div class="ui-form-block"> \t\t\t\t\t<div class="ui-ctl ui-ctl-textarea" id="answer_MESSAGE_block">\t\t\t\t\t\t<textarea name="answer[MESSAGE]" class="ui-ctl-element" id="ANSWER_MESSAGE" placeholder="'+i.Loc.getMessage("VOTE_ANSWER_PLACEHOLDER1")+'">'+BX.util.htmlspecialchars(e["MESSAGE"]||i.Loc.getMessage("VOTE_ANSWER_TEXT_OTHER"))+'</textarea>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t\t<div class="ui-form-block">\t\t\t\t\t<label for="id1" class="ui-ctl-label-text">'+i.Loc.getMessage("VOTE_ANSWER_FIELD_TYPE")+'</label>\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown">\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\t\t\t\t\t\t<select name="answer[FIELD_TYPE]" class="ui-ctl-element">',u,"</select>\t\t\t\t\t</div>\t\t\t\t</div> "].join();var c=BX.create("DIV",{attrs:{id:this.id+"Proper",className:"vote-edit-popup"},html:['<div class="vote-edit-inp-wrap">\t\t\t\t\t<form onsubmit="return false;" id="',this.id,'_form">\t\t\t\t\t\t',s?u:l,"</form>\t\t\t\t</div>"].join("")});var d=function(){var t=BX.ajax.prepareForm(BX(this.id+"_form"));if(BX.type.isNotEmptyString(t.data.answer.MESSAGE)){this.onApply(t.data.answer);this.popup.fired=true;this.popup.close()}else{BX.addClass(BX("answer_MESSAGE_block"),"ui-ctl-danger")}}.bind(this);this.popup=BX.PopupWindowManager.create("popup"+this.id,null,{titleBar:i.Loc.getMessage("VOTE_ANSWER_MESSAGE"),className:"vote-answer",autoHide:false,lightShadow:true,closeIcon:true,closeByEsc:true,zIndex:1,content:c,overlay:{},events:{onPopupClose:function(){if(this.popup.fired!==true){a.EventEmitter.emit(this,"onCancel",[this])}this.popup.destroy();this.popup=null}.bind(this),onAfterPopupShow:function(){setTimeout(function(){if(BX(this.id+"_form")){BX.focus(BX(this.id+"_form").elements["ANSWER_MESSAGE"]);BX.bind(BX(this.id+"_form").elements["ANSWER_MESSAGE"],"keydown",(function(t){if((t.ctrlKey===true||t.altKey===true)&&t.keyCode===13){d()}}))}}.bind(this),50)}.bind(this)},buttons:[new BX.PopupWindowButton({text:i.Loc.getMessage("VOTE_SAVE"),className:"",events:{click:d}}),new BX.PopupWindowButton({text:i.Loc.getMessage("VOTE_CANCEL"),className:"",events:{click:function(){this.onCancel();this.popup.fired=true;this.popup.close()}.bind(this)}})]});this.popup.show();this.popup.adjustPosition()}}]);return t}();BX.Vote.addTextAnswer=function(t){p(t,0,{FIELD_TYPE:4})};BX.Vote.addAnswer=function(t,e){p(t,0,e)};BX.Vote.editAnswer=function(t,e){var i=BX.Main.gridManager.getInstanceById(d[t]["gridId"]);var a=i!==null?i.getRows().getById(e).getEditData():{};p(t,e,a)};BX.Vote.setTypes=function(t){o.setTypes(t.questionTypes);r.setTypes(t.answerTypes)};BX.Vote.setParams=function(t,e){setTimeout((function(){v(e["formId"],e.gridId,t);BX.bind(document,"keydown",(function(e){if(e.keyCode===45&&e.ctrlKey===false&&e.metaKey===false&&e.altKey===false&&(!BX(e.target)||BX(e.target).tagName==="BODY")){BX.Vote.addAnswer(t,{})}}))}),50);d[t]={gridInstanceId:t,gridId:e.gridId,maxSort:e["maxSort"]||100};a.EventEmitter.subscribeOnce("onVoteQuestionDelete",(function(t){var a=babelHelpers.slicedToArray(t.data,2),n=a[0],l=a[1];if(confirm(i.Loc.getMessage("VOTE_DELETE_RECORD_CONFIRM"))){i.ajax.runComponentAction("bitrix:voting.admin.question.edit","delete",{mode:"class",signedParameters:e.componentSignedParams}).then((function(){window.location=i.Uri.addParam("/bitrix/admin/vote_question_list.php",{VOTE_ID:n,lang:i.Loc.getMessage("LANGUAGE_ID")})}),(function(t){var e=t.errors;var i=[];e.forEach((function(t){var e=t.message;i.push(e)}));s.MessageBox.alert(i.join(" "))}))}}))};var c=null;var d={};var p=function t(e,i,s){if(c===null){c=new u;a.EventEmitter.subscribe(c,"onApply",(function(t){var e=babelHelpers.slicedToArray(t.data,3),i=e[0],a=e[1],s=e[2];var n=s["gridId"];var l=BX.Main.gridManager.getInstanceById(n);if(l instanceof BX.Main.grid){var r=BX.clone(a);if(i!==null){l.updateRow(i,r,null,(function(){}))}else{d[s["gridInstanceId"]]["maxSort"]+=100;r["C_SORT"]=d[s["gridInstanceId"]]["maxSort"];l.addRow(r,null,(function(){}))}}}))}c.setGridData(d[e]).setAnswer(i,s).show()};a.EventEmitter.subscribe("Grid::beforeRequest",(function(t){var e=babelHelpers.slicedToArray(t.data,2),i=e[0],a=e[1];console.log("gridData, args: ",i,a);var s;for(s in d){if(d.hasOwnProperty(s)){if(d[s]["gridId"]===a.gridId){a.data.gridId=a.gridId;a.data.gridInstanceId=d[s]["gridInstanceId"]}}}}));var v=function t(e,i,s){var n=BX(e,true);var l="save";var u=function t(e){n.removeEventListener("submit",t);var r=BX.Main.gridManager.getInstanceById(i);if(!r.getRows().hasEditable()){E(n,i,s);return true}var o=function t(e){var a=babelHelpers.slicedToArray(e.data,1),o=a[0];if(o===r){n.appendChild(BX.create("INPUT",{props:{type:"hidden",name:l,value:"Y"}}));E(n,i,s);n.submit()}};a.EventEmitter.subscribeOnce("Grid::updated",o);r.editSelectedSave();return BX.PreventDefault(e)};n.addEventListener("submit",u);if(n.elements["apply"]){n.elements["apply"].addEventListener("mousedown",(function(){l="apply"}))}var c=function t(e){var a=e.target;var s=BX.Main.gridManager.getInstanceById(i).getRows();if(!o.isCompatibilityMode()&&s){var n=[];s.getRows().forEach((function(t){var e=BX.parseJSON(BX.data(t.getNode(),"item"),t);if(e&&BX.type.isPlainObject(e)&&e.hasOwnProperty("field_type")&&String(e["field_type"])!==String(a.value)&&!r.isTextType(e["field_type"])){t.select();n.push(t.getId())}}));if(n.length>0){BX.Main.gridManager.getInstanceById(i).reloadTable("POST",{ID:n,action_button_grid_vote_answer:"change_answer_type",FIELD_TYPE:this.value})}}};document.querySelectorAll("#"+e+" [name=FIELD_TYPE]").forEach((function(t){t.addEventListener("change",c)}))};var E=function t(e,i){var a=BX.Main.gridManager.getInstanceById(i);if(a){var s=a.getRows().getRows();s.forEach((function(t){if(t.getIndex()<1||t.getId()==="template_0"){return}var i=t.getId();e.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"ANSWER["+i.toLowerCase()+"][ID]",value:i}}));var a=BX.parseJSON(BX.data(t.getNode(),"item"),t);var s=function t(i,a,s){var n;for(var l in a){if(a.hasOwnProperty(l)){n="["+(s>0?l:String(l).toUpperCase())+"]";if(BX.type.isPlainObject(a[l])){t(i+n,a[l],s+1)}else{e.appendChild(BX.create("INPUT",{props:{type:"hidden",name:i+n,value:a[l]}}))}}}};if(BX.type.isPlainObject(a)){s("ANSWER["+i+"]",a,0)}}))}};var h=null;BX.Vote.showColorPicker=function(t){if(h===null){h=new BX.ColorPicker({bindElement:null,popupOptions:{angle:true}})}h.open({selectedColor:BX.type.isNotEmptyString(t.value)?t.value:null,bindElement:t,onColorSelected:function e(i){t.value=i}})}})(this.window=this.window||{},window,BX,BX.Event,BX.UI.Dialogs);
//# sourceMappingURL=script.map.js