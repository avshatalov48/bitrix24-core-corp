(function(){"use strict";BX.namespace("BX.Timeman.Component.Schedule.Edit.Calendar");BX.Timeman.Component.Schedule.Edit.Calendar.Exclusions=function(e){e.containerSelector='[data-role="timeman-schedule-calendars-container"]';BX.Timeman.Component.BaseComponent.apply(this,arguments);this.calendarParentId=this.selectOneByRole("calendar-parent-id");this.settingsBtn=this.selectOneByRole("calendars-settings-btn");this._currentYear=(new Date).getFullYear();this.calendarYear=this.selectOneByRole("calendar-year");this._months={1:[0,1,2],2:[3,4,5],3:[6,7,8],4:[9,10,11]};this.calendarTemplates=e.calendarTemplates||{};this.exclusionsData=e.calendarExclusions||{};if(this.exclusionsData.length!=="undefined"&&this.exclusionsData.length===0){this.exclusionsData=this._getDefaultExclusionsData()}this._holidays=this.selectOneByRole("calendar-holidays");this._weekends=this.selectOneByRole("calendar-weekends");this._createCalendars();this._addEventHandlers(e)};BX.Timeman.Component.Schedule.Edit.Calendar.Exclusions.prototype={__proto__:BX.Timeman.Component.BaseComponent.prototype,constructor:BX.Timeman.Component.Schedule.Edit.Calendar.Exclusions,_addEventHandlers:function(){this.quarterSwitchers=this.selectAllByRole("quarter-switcher");for(var e=0;e<this.quarterSwitchers.length;e++){BX.bind(this.quarterSwitchers[e],"change",BX.delegate(this._onQuarterSwitcherClick,this))}BX.bind(this.settingsBtn,"click",BX.delegate(this._onSettingsBtnClick,this));BX.bind(this.calendarYear,"change",this.onCalendarYearChange.bind(this));this._addDateClickListeners()},onCalendarYearChange:function(e){if(this.calendarYear.value!==this._currentYear){this._currentYear=this.calendarYear.value;this._onQuarterSwitcherClick(this.selectedQuarter)}},_addDateClickListeners:function(){var e=this.container.querySelectorAll(".bx-calendar-cell:not(.bx-calendar-date-hidden)");for(var t=0;t<e.length;t++){if(!e[t].dataset["hasTimemanDateClickHandler"]){BX.bind(e[t],"click",BX.delegate(this._onDateClick,this));e[t].dataset["hasTimemanDateClickHandler"]=true}}var a=this.container.querySelectorAll(".bx-calendar-top-year, .bx-calendar-date-hidden");for(var t=0;t<a.length;t++){if(!a[t].dataset["hasTimemanClickHandler"]){BX.bind(a[t],"click",BX.delegate(this._disableHandler,this));BX.bind(a[t],"dblclick",BX.delegate(this._disableHandler,this));a[t].dataset["hasTimemanClickHandler"]=true}}},_disableHandler:function(e){e.stopPropagation();e.preventDefault()},_removeAllIconsFromSettingsPopup:function(){if(this._settingsPopup&&this._settingsPopup.layout){var e=this._settingsPopup.layout.menuContainer.querySelectorAll('[class*="js-id-"]');this.removeTakeIcons(e);for(var t=0;t<this._settingsPopup.getMenuItems().length;t++){var a=this._settingsPopup.getMenuItems()[t];this.setDefaultClassOptions(a);if(a.getSubMenu()&&a.getSubMenu().layout.menuContainer){for(var s=0;s<a.getSubMenu().getMenuItems().length;s++){this.setDefaultClassOptions(a.getSubMenu().getMenuItems()[s])}var n=a.getSubMenu().layout.menuContainer.querySelectorAll('[class*="js-id-"]');this.removeTakeIcons(n)}}}},setDefaultClassOptions:function(e){if(e&&e.options&&e.options.className){e.options.className="js-id-"+e.id+" menu-popup-no-icon"}},removeTakeIcons:function(e){for(var t=0;t<e.length;t++){e[t].classList.remove("menu-popup-item-take");e[t].classList.add("menu-popup-no-icon")}},_onClearHolidaysClick:function(e){this._removeAllIconsFromSettingsPopup();this._settingsPopup.close();this.exclusionsData=this._getDefaultExclusionsData();this.calendarParentId.value="";this._onQuarterSwitcherClick(this.selectedQuarter)},_markSelectedItemInMenuPopup:function(e){this._removeAllIconsFromSettingsPopup();if(this.calendarParentId.value!=e.id&&this._settingsPopup&&this._settingsPopup.layout){var t=this.getMenuItemSelected(e.id);if(t){if(t.layout.item){t.layout.item.classList.add("menu-popup-item-take");t.layout.item.classList.remove("menu-popup-no-icon")}if(t.options&&t.options.className){t.options.className="js-id-"+e.id+" menu-popup-item-take"}}}this._settingsPopup.close()},getMenuItemSelected:function(e){var t=this._settingsPopup.getMenuItem(e);if(!t){for(var a=0;a<this._settingsPopup.getMenuItems().length;a++){var s=this._settingsPopup.getMenuItems()[a];if(s.getSubMenu()&&s.getSubMenu().getMenuItems&&s.getSubMenu().getMenuItems().length>0){if(s.getSubMenu().getMenuItem(e)){t=s.getSubMenu().getMenuItem(e);break}}}}return t},_onUseCalendarTemplateClick:function(e){this._markSelectedItemInMenuPopup(e);if(this.calendarParentId.value!=e.id){this.calendarParentId.value=BX.util.htmlspecialchars(e.id)}else{this.calendarParentId.value=""}this._settingsPopup.close();this.exclusionsData=Object.assign({},this.exclusionsData,e.exclusions);this._onQuarterSwitcherClick(this.selectedQuarter)},_onSettingsBtnClick:function(e){if(!this._settingsPopup){var t={};var a=[];var s=[];for(var n=0;n<this.calendarTemplates.length;n++){var i=this.calendarParentId.value==this.calendarTemplates[n].id?"menu-popup-item-take":"menu-popup-no-icon";var r={text:BX.util.htmlspecialchars(this.calendarTemplates[n].name),id:BX.util.htmlspecialchars(this.calendarTemplates[n].id),className:i+" js-id-"+BX.util.htmlspecialchars(this.calendarTemplates[n].id),onclick:this._onUseCalendarTemplateClick.bind(this,this.calendarTemplates[n])};if(this.calendarTemplates[n].title){r.title=this.calendarTemplates[n].title}if(this.calendarTemplates[n].systemCode.length>0){r.text=BX.util.htmlspecialchars(this.calendarTemplates[n].nameList);if(this.calendarTemplates[n].isCurrentCountry){r.text=BX.util.htmlspecialchars(this.calendarTemplates[n].nameSingle);t=r}else{s.push(r)}}else{a.push(r)}}if(s.length>0){var l=BX.util.htmlspecialchars(BX.message("TIMEMAN_SCHEDULE_EDIT_SYSTEM_CALENDAR_HOLIDAYS_OF_COUNTRIES_TITLE"));if(Object.keys(t).length>0){l=BX.util.htmlspecialchars(BX.message("TIMEMAN_SCHEDULE_EDIT_SYSTEM_CALENDAR_HOLIDAYS_OTHER_TITLE"))}a.unshift({text:l,id:"other_countries",items:s})}if(Object.keys(t).length>0){a.unshift(t)}if(a.length>0||s.length>0){a.unshift({text:BX.message("TIMEMAN_SCHEDULE_EDIT_CALENDAR_TEMPLATES"),delimiter:true,id:"templates_title"})}a.push({text:BX.message("TIMEMAN_SCHEDULE_EDIT_CALENDAR_MANAGE"),delimiter:true,id:"manage"});a.push({text:BX.message("TIMEMAN_SCHEDULE_EDIT_CALENDAR_CLEAR_HOLIDAYS"),id:"clear_holidays",onclick:this._onClearHolidaysClick.bind(this)});this._settingsPopup=BX.PopupMenu.create("timeman-schedule-calendars-settings",this.settingsBtn,a,{angle:true,maxHeight:350,closeByEsc:true,autoHide:true})}this._settingsPopup.show()},_createCalendars:function(){this._calendars=[];var e=document.querySelectorAll('[data-role="calendars-wrap"] [data-role="calendar"]');for(var t=0;t<e.length;t++){var a=new BX.JCCalendar;a.Show({node:e[t],bTime:false});e[t].appendChild(a.DIV);a.popup.close();this._calendars.push(a)}var s=(new Date).getMonth();for(var n=1;n<=4;n++){for(var i=0;i<this._months[n].length;i++){if(this._months[n][i]===s){this.container.querySelector("#quarter-"+n).checked="checked";this._onQuarterSwitcherClick(n)}}}},_initCalendar:function(e,t){e.__month=t;e.SetMonth(t);e.SetYear(this._currentYear);this._redrawExclusions(e,t)},_redrawExclusions:function(e,t){var a=e.DIV.querySelectorAll(".bx-calendar-cell");for(var s=0;s<a.length;s++){var n=a[s];BX.removeClass(n,"bx-calendar-active");BX.removeClass(n,"bx-calendar-shortcut");BX.removeClass(n,"bx-calendar-holiday")}if(this.exclusionsData[this._currentYear]&&this.exclusionsData[this._currentYear][t]){for(var i in this.exclusionsData[this._currentYear][t]){this._drawOneMoreHoliday(e,i)}}},_drawOneMoreHoliday:function(e,t){var a=e.DIV.querySelectorAll(".bx-calendar-active");e.SetDay(t);for(var s=0;s<a.length;s++){a[s].classList.add("bx-calendar-active")}},_onQuarterSwitcherClick:function(e){var t=typeof e==="object"?e.currentTarget.dataset.quarter:e;this.selectedQuarter=t;for(var a=0;a<this._calendars.length;a++){var s=this._calendars[a];var n=this._months[t][a];this._initCalendar(s,n)}this._addDateClickListeners();this._updateCounters(t)},_onDateClick:function(e){e.preventDefault();e.stopPropagation();var t=new Date;t.setTime(e.currentTarget.dataset.date);var a=t.getMonth();this._toggleExclusion(t.getDate(),a);for(var s=0;s<this._calendars.length;s++){var n=this._calendars[s];if(n.__month==a){this._redrawExclusions(n,a)}}this._updateHolidays(this._getMonthInQuarterByMonth(a))},_toggleExclusion:function(e,t){if(this._hasExclusion(e,t)){this._removeExclusion(e,t)}else{this._addExclusion(e,t)}},_getMonthInQuarterByMonth:function(e){for(var t in this._months){var a=this._months[t];if(a.includes(e)){return a}}},_updateHolidays:function(e){var t={};var a=[this.exclusionsData];for(var s=0;s<e.length;s++){for(var n=0;n<a.length;n++){if(a[n]&&a[n][this._currentYear]&&a[n][this._currentYear][e[s]]){for(var i in a[n][this._currentYear][e[s]]){if(a[n][this._currentYear][e[s]].hasOwnProperty(i)){t[this._currentYear.toString()+e[s].toString()+i.toString()]=1}}}}}var r=0;for(i in t){if(t.hasOwnProperty(i)){r++}}this._holidays.textContent=r},_updateWeekends:function(e){var t=0;for(var a=0;a<e.length;a++){var s=new Date(this._currentYear,e[a]+1,0);var n=s.getDate();for(var i=1;i<=n;i++){var r=new Date(s.getFullYear(),s.getMonth(),i);if(r.getDay()===0||r.getDay()===6){t+=1}}}this._weekends.textContent=t},_updateCounters:function(e){var t=this._months[e];this._updateHolidays(t);this._updateWeekends(t)},_hasExclusion:function(e,t){return this.exclusionsData[this._currentYear]&&this.exclusionsData[this._currentYear][t]&&this.exclusionsData[this._currentYear][t][e]},_removeExclusion:function(e,t){delete this.exclusionsData[this._currentYear][t][e]},_addExclusion:function(e,t){this.exclusionsData[this._currentYear]=this.exclusionsData[this._currentYear]||{};this.exclusionsData[this._currentYear][t]=this.exclusionsData[this._currentYear][t]||{};this.exclusionsData[this._currentYear][t][e]=this.exclusionsData[this._currentYear][t][e]||"0"},_getDefaultExclusionsData:function(){var e={};e[this._currentYear]={};return e}}})();
//# sourceMappingURL=calendar-exclusions.map.js