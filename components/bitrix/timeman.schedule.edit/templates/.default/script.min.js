(function(){"use strict";BX.namespace("BX.Timeman.Component.Schedule.Edit");BX.Timeman.Component.Schedule.Edit=function(e){BX.Timeman.Component.BaseComponent.apply(this,arguments);this.calendarExclusionsFormName=e.calendarExclusionsFormName;this.scheduleIdFormName=e.scheduleIdFormName;this.scheduleId=e.scheduleId;this.isSlider=e.isSlider;this.options=e;this.defaultSelectedAssignmentCodesExcluded=e.selectedAssignmentCodesExcluded;this.defaultSelectedAssignmentCodes=e.selectedAssignmentCodes;var t=this.buildAssignmentsKey(this.defaultSelectedAssignmentCodes,this.defaultSelectedAssignmentCodesExcluded);this.assignmentsMap={};this.assignmentsMap[t]=this.prepareSchedulesAssignmentsMap(this.options.assignmentsMap);this.assignmentsLoading=false;this.scheduleFormName=e.scheduleFormName;this.scheduleNamePostfix=e.scheduleNamePostfix;this.addShiftBtn=this.selectOneByRole("timeman-schedule-form-shift-add");this.typeSelector=this.selectOneByRole("timeman-schedule-type-select");this.reportPeriodSelector=this.selectOneByRole("timeman-report-period-select");this.reportPeriodStartWeekDayBlock=this.selectOneByRole("timeman-report-period-start-week-day-block");this.cancelButton=this.selectOneByRole("timeman-schedule-btn-cancel");this.saveButton=this.selectOneByRole("timeman-schedule-btn-save");this.assignmentsWrapper=this.selectOneByRole("assignments-wrapper");this.scheduleForm=this.selectOneByRole("timeman-schedule-form");this.assignmentsErrorBlock=this.selectOneByRole("timeman-schedule-assignments-error-block");this.excludedUsersToggle=this.selectOneByRole("timeman-excluded-users-show-btn");this.excludedContainer=this.selectOneByRole("excluded-container");this.controlledActionsSelector=this.selectOneByRole("controlled-actions");this.errorBlock=this.selectOneByRole("timeman-schedule-edit-error-block");this.errorMsgTemplate=this.selectOneByRole("timeman-schedule-error-msg-block");this.shifts=[];this.scheduleNameInput=this.selectOneByRole("schedule-name");this.calendarExclusions=new BX.Timeman.Component.Schedule.Edit.Calendar.Exclusions(e);this.violations=new BX.Timeman.Component.Schedule.Edit.Violations(e);this.setScheduleNameFromTypeOption(0);new BX.Timeman.Component.Popup.DurationPicker({durationInput:this.selectOneByRole("max-shift-start-offset-input"),durationPopupToggle:this.selectOneByRole("max-shift-start-offset-link"),containerSelector:'[data-role="worktime-restrictions"]'});this.addEventHandlers(e);var s=document.querySelectorAll('[data-role^="timeman-schedule-shift-form-container"]');for(var i=0;i<s.length;i++){this.createShift('[data-role="'+s[i].dataset.role+'"]',{visible:i!==0})}this.redrawFormByScheduleType(this.typeSelector.value,this.controlledActionsSelector.value);BX.UI.Hint.init(this.container)};BX.Timeman.Component.Schedule.Edit.prototype={__proto__:BX.Timeman.Component.BaseComponent.prototype,constructor:BX.Timeman.Component.Schedule.Edit,addEventHandlers:function(){BX.bind(this.scheduleNameInput,"focus",BX.delegate(this.onScheduleInputFocus,this));BX.bind(this.excludedUsersToggle,"click",BX.delegate(this.onExcludedUsersToggleClick,this));BX.bind(this.addShiftBtn,"click",BX.delegate(this.onAddShiftBtnClick,this));BX.bind(this.typeSelector,"change",BX.delegate(this.onTypeSelectorChange,this));BX.bind(this.reportPeriodSelector,"change",BX.delegate(this.onReportPeriodChange,this));BX.bind(this.controlledActionsSelector,"change",BX.delegate(this.onControlledActionsChange,this));BX.bind(this.saveButton,"click",BX.delegate(this.onSaveClick,this));BX.bind(this.cancelButton,"click",BX.delegate(this.onCancelClick,this));BX.bind(this.cancelButton,"click",BX.delegate(this.onCancelClick,this));BX.addCustomEvent("BX.Main.User.SelectorController:select",BX.delegate(this.onAssignmentSelected,this));BX.addCustomEvent("BX.Main.User.SelectorController:unSelect",BX.delegate(this.onAssignmentUnselected,this));BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(function(e){if(e.getEventId()==="BX.Timeman.Schedule.Update::Success"){this.assignmentsMap={};this.updateAssignmentsWarnings()}}.bind(this)));var e=document.querySelectorAll('[data-role^="startTimeAllowedDevice"]');for(var t=0;t<e.length;t++){BX.bind(e[t],"click",BX.delegate(this.onAllowDeviceClick,this))}},getCurrentExcludedCodes:function(){var e=[];var t=this.excludedContainer.querySelectorAll('[data-role="tile-item"][data-bx-id]');for(var s=0;s<t.length;s++){if(!t[s].dataset.bxId){continue}e.push(t[s].dataset.bxId)}return e},getCurrentSelectedCodes:function(){var e=[];var t=this.assignmentsWrapper.querySelectorAll('[data-role="tile-item"][data-bx-id]');for(var s=0;s<t.length;s++){if(!t[s].dataset.bxId){continue}e.push(t[s].dataset.bxId)}return e},buildAssignmentsKey:function(e,t){if(e===undefined){e=this.getCurrentSelectedCodes()}if(t===undefined){t=this.getCurrentExcludedCodes()}var s=[];for(var i=0;i<e.length;i++){s.push(e[i])}var n=[];for(var i=0;i<t.length;i++){n.push(t[i])}if(s.length!==0){s.sort();n.sort();return JSON.stringify(s)+"|"+JSON.stringify(n)}return null},updateAssignmentsWarnings:function(){this.clearErrors(this.assignmentsErrorBlock);var e=this.buildAssignmentsKey();if(e===null){return}if(this.assignmentsMap[e]!==undefined){this.drawUserAssignmentsWarning(this.assignmentsMap[e])}else{if(this.assignmentsLoading){return}this.assignmentsLoading=true;this.disableSaveBtn();var t=[];var s=this.getCurrentSelectedCodes();var i=this.getCurrentExcludedCodes();for(var n=0;n<s.length;n++){t.push({code:s[n],excluded:false})}for(var n=0;n<i.length;n++){t.push({code:i[n],excluded:true})}BX.ajax.runAction("timeman.schedule.getSchedulesForScheduleForm",{data:{exceptScheduleAssignmentCodes:t,exceptScheduleId:this.scheduleId,checkNestedEntities:true}}).then(function(e,t){this.assignmentsLoading=false;this.enableSaveBtn();this.assignmentsMap[e]=this.prepareSchedulesAssignmentsMap(t.data.schedules);this.drawUserAssignmentsWarning(this.assignmentsMap[e])}.bind(this,e),function(e){this.assignmentsLoading=false;this.showErrors(e.errors);this.enableSaveBtn()}.bind(this))}},drawUserAssignmentsWarning:function(e){if(e&&e.length>0){for(var t=0;t<e.length;t++){var s=e[t];var i=s.id+s.entityCode;if(this.assignmentsErrorBlock.querySelector('[data-role="timeman-schedule-error-msg-block"][data-unique-id="'+i+'"]')){continue}var n=this.errorMsgTemplate.cloneNode(true);n.dataset.uniqueId=i;var l='&nbsp;<a class="timeman-schedule-form-error-link" data-role="schedule-link" data-id="'+parseInt(s.id)+'"'+'" href="'+s.link+'">'+BX.util.htmlspecialchars(s.name)+"</a>";if(s.entityCode.substr(0,2)==="DR"){n.dataset.department=true;n.dataset.name=s.entityName;n.dataset.scheduleName=s.name;this.selectOneByRole("timeman-schedule-error-msg",n).innerHTML=BX.message("TIMEMAN_SCHEDULE_EDIT_ALREADY_ASSIGNED_DEPARTMENT_WARNING").replace("#SCHEDULE_NAME#",l).replace("#ASSIGNMENT_NAME#",BX.util.htmlspecialchars(s.entityName))+". "+BX.message("TIMEMAN_SCHEDULE_EDIT_DEPARTMENT_WILL_BE_EXCLUDED")}else if(s["forAllUsers"]&&s.entityCode==="UA"){this.selectOneByRole("timeman-schedule-error-msg",n).innerHTML=BX.message("TIMEMAN_SCHEDULE_FOR_ALL_USERS_WARNING").replace("#SCHEDULE_NAME#",l+"&nbsp;")}else{var a="TIMEMAN_SCHEDULE_EDIT_ALREADY_ASSIGNED_MALE_WARNING";if(s.entityGender==="F"){a="TIMEMAN_SCHEDULE_EDIT_ALREADY_ASSIGNED_FEMALE_WARNING"}this.selectOneByRole("timeman-schedule-error-msg",n).innerHTML=BX.message(a).replace("#SCHEDULE_NAME#",l).replace("#ASSIGNMENT_NAME#",BX.util.htmlspecialchars(s.entityName));n.classList.remove("ui-alert-danger");n.classList.add("ui-alert-success")}this.assignmentsErrorBlock.appendChild(n);this.showElement(n)}}},prepareSchedulesAssignmentsMap:function(e){var t=[];var s=Object.keys(e);for(var i=0;i<s.length;i++){var n=s[i];var l=Object.keys(e[n]);for(var a=0;a<l.length;a++){var r=e[n][l[a]];if(parseInt(this.scheduleId)!==parseInt(r.ID)){var o=r.entityName;if(!o){var d=this.container.querySelector('[data-role="tile-item"][data-bx-id="'+n+'"]');if(d&&d.querySelector('[data-role="tile-item-name"]')){o=d.querySelector('[data-role="tile-item-name"]').textContent}}var h={id:r.ID,name:r.NAME,link:r.LINKS.DETAIL,forAllUsers:r.IS_FOR_ALL_USERS,entityName:o,entityCode:n,entityGender:r.entityGender};t.push(h)}}}return t},onAssignmentUnselected:function(e){if(e.selectorId==="ScheduleForm-exclude-assignments-id"||e.selectorId==="ScheduleForm-assignments-id"){if(this.getCurrentSelectedCodes().length===0){this.enableSaveBtn()}this.updateAssignmentsWarnings()}},onAssignmentSelected:function(e){if(e.selectorId==="ScheduleForm-exclude-assignments-id"||e.selectorId==="ScheduleForm-assignments-id"){if(this.initedAssignments(e)){this.updateAssignmentsWarnings()}}},initedAssignments:function(e){if(e.selectorId==="ScheduleForm-exclude-assignments-id"){for(var t=0;t<this.defaultSelectedAssignmentCodesExcluded.length;t++){if(this.defaultSelectedAssignmentCodesExcluded[t]===e.item.id){this.defaultSelectedAssignmentCodesExcluded.splice(t,1);break}}}else if(e.selectorId==="ScheduleForm-assignments-id"){for(var t=0;t<this.defaultSelectedAssignmentCodes.length;t++){if(this.defaultSelectedAssignmentCodes[t]===e.item.id){this.defaultSelectedAssignmentCodes.splice(t,1);break}}}return this.defaultSelectedAssignmentCodes.length===0&&this.defaultSelectedAssignmentCodesExcluded.length===0},onExcludedUsersToggleClick:function(){this.toggleElementVisibility(this.excludedContainer)},onAllowDeviceClick:function(e){var t=document.querySelectorAll('[data-role^="startTimeAllowedDevice"]:checked');if(t.length===0){e.stopPropagation();e.preventDefault()}},onControlledActionsChange:function(){this.controlledActionsSelector.dataset.autoaction=false;this.violations.redrawFormByScheduleType(this.typeSelector.value,this.controlledActionsSelector.value)},onScheduleInputFocus:function(){this.scheduleNameInput.dataset.autoname=false},setScheduleNameFromTypeOption:function(e){if(this.scheduleNameInput.dataset.autoname==="false"){return}if(this.isFixedSchedule(this.typeSelector.value)){this.scheduleNameInput.value=BX.util.htmlspecialchars(BX.message("TIMEMAN_SCHEDULE_EDIT_NAME_DEFAULT_FIXED"))}else if(this.isShiftedSchedule(this.typeSelector.value)){this.scheduleNameInput.value=BX.util.htmlspecialchars(BX.message("TIMEMAN_SCHEDULE_EDIT_NAME_DEFAULT_SHIFT"))}else if(this.isFlextimeSchedule(this.typeSelector.value)){this.scheduleNameInput.value=BX.util.htmlspecialchars(BX.message("TIMEMAN_SCHEDULE_EDIT_NAME_DEFAULT_FLEXTIME"))}},onReportPeriodChange:function(e){var t=e.currentTarget.querySelectorAll("option")[e.currentTarget.selectedIndex];if(t.value==="WEEK"||t.value==="TWO_WEEKS"){this.showElement(this.reportPeriodStartWeekDayBlock)}else{this.hideElement(this.reportPeriodStartWeekDayBlock)}},onTypeSelectorChange:function(e){this.setScheduleNameFromTypeOption(e.currentTarget.selectedIndex);var t=e.currentTarget.querySelectorAll("option")[e.currentTarget.selectedIndex];this.redrawFormByScheduleType(t.value)},redrawFormByScheduleType:function(e){this.showElement(this.selectOneByRole("timeman-schedule-calendars-container"));this.showElement(this.selectOneByRole("work-time-block"));this.violations.redrawFormByScheduleType(e,this.controlledActionsSelector.value);this.hideElement(this.selectOneByRole("max-shift-start-offset-block"));if(this.isShiftedSchedule(e)){this.showElement(this.selectOneByRole("max-shift-start-offset-block"));this.addShiftBtn.textContent=BX.message("TIMEMAN_SCHEDULE_EDIT_ADD_WORK_SHIFT_TITLE");this.hideElement(this.selectOneByRole("timeman-schedule-calendars-container"));if(this.controlledActionsSelector.dataset.autoaction==="true"){this.controlledActionsSelector.value=this.options.controlledStart}}else if(this.isFlextimeSchedule(e)){this.hideElement(this.selectOneByRole("timeman-schedule-calendars-container"));this.hideElement(this.selectOneByRole("work-time-block"))}else{this.addShiftBtn.textContent=BX.message("TIMEMAN_SCHEDULE_EDIT_ADD_WORK_TIME_TITLE");if(this.isFixedSchedule(e)&&this.controlledActionsSelector.dataset.autoaction==="true"){this.controlledActionsSelector.value=this.options.controlledStartEnd}}for(var t=0;t<this.shifts.length;t++){this.shifts[t].onScheduleTypeSelected(e)}},createShift:function(e,t){var s=new BX.Timeman.Component.Schedule.ShiftEdit.Multiple(Object.assign({},this.options,{isScheduleShifted:this.isShiftedSchedule(this.typeSelector.value),containerSelector:e,uniqueIndex:t&&t.uniqueIndex!==undefined?t.uniqueIndex:undefined,defaultName:t&&t.defaultName!==undefined?t.defaultName:undefined,visible:t&&t.visible!==undefined?t.visible:undefined,prevShiftEnd:t&&t.prevShiftEnd!==undefined?t.prevShiftEnd:undefined,prevShiftStart:t&&t.prevShiftStart!==undefined?t.prevShiftStart:undefined,isSlider:this.isSlider}));s.attachOnDeleteEvent(this);this.addDaysEventHandlers(s.container);this.shifts.push(s)},addDaysEventHandlers:function(e){var t=this.selectAllByRole("timeman-schedule-shift-work-day-item",e);for(var s=0;s<t.length;s++){BX.bind(t[s],"click",BX.delegate(this.onWorkDayClick,this))}},onWorkDayClick:function(e){var t=this.selectAllByRole("timeman-schedule-shift-work-day-item",this.container);for(var s=0;s<t.length;s++){if(t[s].checked===true){if(t[s]!==e.currentTarget&&t[s].value===e.currentTarget.value){e.preventDefault();e.stopPropagation()}}}},updateOnShiftEvent:function(e){for(var t=0;t<this.shifts.length;t++){if(this.shifts[t]===e.shift){this.shifts.splice(t,1)}}},isFixedSchedule:function(e){return e===this.options.fixedScheduleTypeName},isFlextimeSchedule:function(e){return e===this.options.flextimeScheduleTypeName},isShiftedSchedule:function(e){return e===this.options.shiftedScheduleTypeName},buildShiftUniqueName:function(){var e=BX.message("TIMEMAN_SHIFT_EDIT_DEFAULT_NAME");var t=false;var s=1;do{t=false;for(var i=0;i<this.shifts.length;i++){if(this.shifts[i].nameInput.value===e){t=true;s++;e=BX.message("TIMEMAN_SHIFT_EDIT_DEFAULT_NAME")+" "+s}}}while(t);return e},buildShiftUniqueIndex:function(){var e=document.querySelectorAll('[data-role^="timeman-schedule-shift-form-container"]').length;var t=true;while(t){t=false;e++;for(var s=0;s<this.shifts.length;s++){if(parseInt(this.shifts[s].uniqueIndex)===parseInt(e)){t=true}}}return e},onAddShiftBtnClick:function(){var e=document.querySelector('[data-role^="timeman-schedule-shift-form-container"]');var t=e.cloneNode(true);var s=this.buildShiftUniqueIndex();var i=null;var n=null;if(this.isShiftedSchedule(this.typeSelector.value)&&this.shifts.length>1){i=this.shifts[this.shifts.length-1].workTimeEndLink.textContent;n=this.shifts[this.shifts.length-1].workTimeStartLink.textContent}t.dataset.role="timeman-schedule-shift-form-container-"+s;this.selectOneByRole("timeman-shifts-wrapper").appendChild(t);this.createShift('[data-role="'+t.dataset.role+'"]',{uniqueIndex:s,visible:true,defaultName:this.buildShiftUniqueName(),prevShiftEnd:i,prevShiftStart:n})},disableSaveBtn:function(){this.saveButtonDisabled=true;if(this.saveButton){this.saveButton.classList.add("timeman-schedule-disabled")}},enableSaveBtn:function(){this.saveButtonDisabled=false;if(this.saveButton){this.saveButton.classList.remove("timeman-schedule-disabled")}},onCancelClick:function(e){e.preventDefault();this.closeSlider()},onSaveClick:function(e){e.stopPropagation();e.preventDefault();if(this.saveButtonDisabled){return}this.disableSaveBtn();this.clearErrors(this.errorBlock);for(var t=0;t<this.shifts.length;t++){this.shifts[t].processBeforeCollectFormData()}var s=new FormData(this.scheduleForm);s.append(this.calendarExclusionsFormName,JSON.stringify(this.calendarExclusions.exclusionsData));var i=s.get(this.scheduleIdFormName)?"timeman.schedule.update":"timeman.schedule.add";this.lastActionName=i;this.processSave(i,s)},processSave:function(e,t){if(e==="timeman.schedule.add"&&this.isShiftedSchedule(this.typeSelector.value)){var s=new BX.Loader({size:250,target:this.container});s.show()}BX.ajax.runAction(e,{data:t,analyticsLabel:{type:t.get("ScheduleForm[type]")}}).then(function(e){this.onSuccess(e,this.lastActionName)}.bind(this),function(e){this.showErrors(e.errors);this.enableSaveBtn()}.bind(this))},onSuccess:function(e,t){if(this.isSlider&&this.getSlider()){this.getSlider().postMessageAll(window,t==="timeman.schedule.add"?"BX.Timeman.Schedule.Add::Success":"BX.Timeman.Schedule.Update::Success",{schedule:e.data.schedule})}if(t==="timeman.schedule.add"&&e.data.schedule.links&&e.data.schedule.links.shiftPlan){var s=BX.util.add_url_param(e.data.schedule.links.shiftPlan,{IFRAME:this.isSlider?"Y":"N"});document.location.href=s}else{if(this.isSlider){this.closeSlider()}else{document.location.reload()}}},getSlider:function(){if(window.top.BX.SidePanel&&window.top.BX.SidePanel.Instance){return window.top.BX.SidePanel.Instance}return null},closeSlider:function(){if(this.isSlider&&this.getSlider()){this.getSlider().getTopSlider().close()}},clearErrors:function(e){if(e.childNodes){for(var t=e.childNodes.length-1;t>=0;t--){e.childNodes[t].remove()}}},showErrors:function(e){for(var t=0;t<e.length;t++){var s=this.errorMsgTemplate.cloneNode(true);s.textContent=e[t].message;this.errorBlock.appendChild(s);this.showElement(s)}if(e.length>0){window.scrollTo(0,0)}}}})();
//# sourceMappingURL=script.map.js