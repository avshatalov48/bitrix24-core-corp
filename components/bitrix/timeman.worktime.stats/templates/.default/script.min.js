(function(){BX.namespace("BX.Timeman.Component.Worktime");BX.Timeman.Component.Worktime.Stats=function(e){this.isSlider=e.isSlider;this.gridId=e.gridId;e.container=this.container=document.querySelector(this.isSlider?"body":"#content-table");BX.Timeman.Component.BaseComponent.apply(this,arguments);this.editSchedulesPopupToggle=this.selectOneByRole("worktime-grid-config-btn");this.gridOptionsToggle=this.selectOneByRole("grid-options");this.gridSettings=e.gridSettings;this.schedulesData=e.schedulesData;this.canDeleteSchedule=e.canDeleteSchedule;this.canUpdateSchedule=e.canUpdateSchedule;this.shiftedSchedules=e.shiftedSchedules;this.shiftplansBtn=this.selectOneByRole("shift-plans-btn");this.gridOptions=e.gridOptions;this.showViolationsCommonName=e.showViolationsCommonName;this.showViolationsPersonalName=e.showViolationsPersonalName;this.showStatsColumnsName=e.showStatsColumnsName;this.showStartFinishName=e.showStartFinishName;this.saveSelectedOption(this.showStartFinishName);this.saveSelectedOption(this.showStatsColumnsName);this.saveSelectedOption(this.showViolationsPersonalName);this.saveSelectedOption(this.showViolationsCommonName);this.applyGridOptions();this.addEventHandlers()};BX.Timeman.Component.Worktime.Stats.prototype={__proto__:BX.Timeman.Component.BaseComponent.prototype,constructor:BX.Timeman.Component.Worktime.Stats,addEventHandlers:function(){this.onGridUpdated();BX.bind(this.shiftplansBtn,"click",BX.delegate(this.onShiftPlansClick,this));BX.bind(this.gridOptionsToggle,"click",BX.delegate(this.onGridOptionsToggleClick,this));BX.bind(this.editSchedulesPopupToggle,"click",BX.delegate(this.onEditSchedulesToggleClick,this));BX.addCustomEvent("Grid::updated",this.onGridUpdated.bind(this));BX.addCustomEvent("Grid::beforeRequest",BX.delegate(function(e,t){if(t.url===""){t.url=window.location.toString();return}var i=window.location.href.match(new RegExp(this.showStatsColumnsName+"=([YN])"));if(i!==null&&(i[1]==="Y"||i[1]==="N")&&t.url.match(new RegExp(this.showStatsColumnsName+"=([YN])"))!==null){t.url=t.url.replace(this.showStatsColumnsName+"="+"=([YN])",this.showStatsColumnsName+"="+i[1])}var s=window.location.href.match(new RegExp(this.showStartFinishName+"=([YN])"));if(s!==null&&(s[1]==="Y"||s[1]==="N")&&t.url.match(new RegExp(this.showStartFinishName+"=([YN])"))!==null){t.url=t.url.replace(this.showStartFinishName+"="+"=([YN])",this.showStartFinishName+"="+s[1])}}.bind(this)));BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(function(e){if(e.getEventId()==="BX.Timeman.Schedule.Update::Success"){var t=e.getData()["schedule"];if(!t){return}for(var i=0;i<this.schedulesData.length;i++){if(parseInt(this.schedulesData[i].id)===parseInt(t.id)){if(this.schedulesPopup&&this.schedulesPopup.getMenuItem(t.id.toString())&&this.schedulesPopup.getMenuItem(t.id.toString()).setText&&typeof this.schedulesPopup.getMenuItem(t.id.toString()).setText==="function"){this.schedulesPopup.getMenuItem(t.id.toString()).setText(BX.util.htmlspecialchars(t.name))}this.schedulesData[i].name=t.name;break}}}else if(e.getEventId()==="BX.Timeman.Record.Approve::Success"){var s=e.getData()["record"];if(!s||!this.selectOneByRole("shift-records-container")){return}var n=this.selectOneByRole("shift-records-container").querySelector('[data-role="worktime-record-cell"][data-id="'+s.id+'"]');if(!n){return}var o=document.createElement("div");o.innerHTML=s.recordCellHtml;var a=n.querySelector('[data-shift-block="true"]').parentNode;if(a&&o.querySelector('[data-shift-block="true"]')){a.replaceChild(o.querySelector('[data-shift-block="true"]'),n.querySelector('[data-shift-block="true"]'))}this.initHints();this.applyGridOptions()}else if(e.getEventId()==="BX.Timeman.Schedule.Add::Success"){var h=e.getData()["schedule"];if(h){if(this.schedulesPopup){this.schedulesPopup.addMenuItem(this.createScheduleMenuItem(h))}if(!this.schedulesData){this.schedulesData=[]}this.schedulesData.push({id:h["id"].toString(),name:h["name"]})}}}.bind(this)))},setCookie:function(e,t,i){i=i||{path:window.location.pathname};var s=i.expires;if(typeof s=="number"&&s){var n=new Date;n.setTime(n.getTime()+s*1e3);s=i.expires=n}if(s&&s.toUTCString){i.expires=s.toUTCString()}t=encodeURIComponent(t);var o=e+"="+t;for(var a in i){if(!i.hasOwnProperty(a)){continue}o+="; "+a;var h=i[a];if(h!==true){o+="="+h}}document.cookie=o;return true},onShiftPlansClick:function(e){if(!this.shiftPlansPopup){var t=[];for(var i=0;i<this.shiftedSchedules.length;i++){var s=this.shiftedSchedules[i];t.push({text:BX.util.htmlspecialchars(s.NAME),id:BX.util.htmlspecialchars(s.ID),onclick:function(e){if(this.shiftPlansPopup){this.shiftPlansPopup.close()}var t=BX.util.add_url_param("/bitrix/components/bitrix/timeman.schedule.shiftplan/slider.php",{SCHEDULE_ID:e.ID});BX.SidePanel.Instance.open(t,{width:1400})}.bind(this,s)})}this.shiftPlansPopup=new BX.PopupMenuWindow({id:"tmWorktimeStatsShiftedSchedulesPopup",bindElement:e.currentTarget,items:t})}this.shiftPlansPopup.show()},onGridUpdated:function(){this.initHints();this.applyGridOptions()},initHints:function(){BX.UI.Hint.init(this.container)},createScheduleMenuItem:function(e){var t=[];var i=e.id.toString();var s=BX.message("TM_SCHEDULE_LIST_ACTION_READ");if(this.canUpdateSchedule){s=BX.message("TM_SCHEDULE_LIST_ACTION_EDIT")}t.push({text:BX.util.htmlspecialchars(s),onclick:function(e){this.onEditScheduleClick(e)}.bind(this,i)});if(this.canDeleteSchedule){t.push({text:BX.util.htmlspecialchars(BX.message("TM_SCHEDULE_LIST_ACTION_DELETE")),onclick:function(e){this.onDeleteScheduleClick(e)}.bind(this,e)})}return{text:BX.util.htmlspecialchars(e.name),id:BX.util.htmlspecialchars(i),onclick:function(e){this.onEditScheduleClick(e)}.bind(this,i),items:t}},buildEditSchedulesPopup:function(e){var t=[];for(var i=0;i<this.schedulesData.length;i++){var s=this.schedulesData[i];t.push(this.createScheduleMenuItem(s))}return BX.PopupMenu.create({items:t,maxHeight:450,id:"tmWorktimeGridOptionsEditSchedulesMenu",bindElement:e.currentTarget,angle:true,closeByEsc:true,autoHide:true})},onEditScheduleClick:function(e){this.schedulesPopup.close();var t=BX.util.add_url_param("/bitrix/components/bitrix/timeman.schedule.edit/slider.php",{SCHEDULE_ID:e});window.top.BX.SidePanel.Instance.open(t,{width:1200,cacheable:false})},onDeleteScheduleClick:function(e){this.schedulesPopup.close();if(!this.deleteSchedulePopup){this.deleteSchedulePopup={}}this.deleteSchedulePopup[e.id]=new BX.PopupWindow({id:"tm-menu-confirm-delete-schedule-"+BX.util.htmlspecialchars(e.id),autoHide:true,draggable:true,closeByEsc:true,titleBar:BX.message("TM_SCHEDULE_DELETE_CONFIRM_TITLE"),content:BX.util.htmlspecialchars(BX.message("TM_SCHEDULE_DELETE_CONFIRM").replace("#SCHEDULE_NAME#",e.name)),buttons:[new BX.PopupWindowButtonLink({text:BX.message("TM_SCHEDULE_DELETE_CONFIRM_NO"),className:"ui-btn ui-btn-danger",events:{click:function(e){this.deleteSchedulePopup[e.id].close()}.bind(this,e)}}),new BX.PopupWindowButton({text:BX.message("TM_SCHEDULE_DELETE_CONFIRM_YES"),className:"ui-btn ui-btn-success",events:{click:function(e){this.deleteSchedulePopup[e.id].close();BX.ajax.runAction("timeman.schedule.delete",{data:{id:e.id}}).then(function(e){this.onAfterScheduleDelete(e);if(!this.schedulesPopup){return}this.schedulesPopup.removeMenuItem(e.id.toString());for(var t=0;t<this.schedulesData.length;t++){if(this.schedulesData[t].id==e.id.toString()){this.schedulesData.splice(t,1);break}}}.bind(this,e),function(e){}.bind(this))}.bind(this,e)}})]});this.deleteSchedulePopup[e.id].show()},onAfterScheduleDelete:function(e){if(!e||!e.id){return}for(var t=0;t<this.shiftedSchedules.length;t++){if(parseInt(this.shiftedSchedules[t].ID)===parseInt(e.id)){this.shiftedSchedules.splice(t,1)}}for(var t=0;t<this.schedulesData.length;t++){if(parseInt(this.schedulesData[t].id)===parseInt(e.id)){this.schedulesData.splice(t,1)}}if(this.shiftedSchedules.length===0){this.hideElement(this.shiftplansBtn)}if(this.schedulesData.length===0){this.hideElement(this.editSchedulesPopupToggle)}},onEditSchedulesToggleClick:function(e){e.stopPropagation();e.preventDefault();if(!this.schedulesData.length){return}if(!this.schedulesPopup){this.schedulesPopup=this.buildEditSchedulesPopup(e)}this.schedulesPopup.show()},onGridOptionsToggleClick:function(e){this._settingsPopup=this.buildSettingsPopup(e);this._settingsPopup.show()},toggleSelectedItemInMenuPopup:function(e){if(this._settingsPopup&&this._settingsPopup.layout){var t=this.getMenuItemSelected(e.id);if(t){t.classList.toggle("menu-popup-item-take");t.classList.toggle("menu-popup-no-icon")}}},getMenuItemSelected:function(e){var t=this._settingsPopup.layout.menuContainer.querySelector(".js-id-"+e);if(!t){var i=this._settingsPopup.getMenuItems();for(var s=0;s<i.length;s++){if(this._settingsPopup.getMenuItem(i[s].id)&&this._settingsPopup.getMenuItem(i[s].id).getSubMenu()&&this._settingsPopup.getMenuItem(i[s].id).getSubMenu().getMenuItem(e)&&this._settingsPopup.getMenuItem(i[s].id).getSubMenu().getMenuItem(e).menuWindow){return this._settingsPopup.getMenuItem(i[s].id).getSubMenu().getMenuItem(e).menuWindow.layout.menuContainer.querySelector(".js-id-"+e)}}}},applyGridOptions:function(){var e=this.selectAllByRole("start-end");for(var t=0;t<e.length;t++){if(this.getGridOptions()[this.showStartFinishName]){this.showElement(e[t])}else{this.hideElement(e[t])}}var i=this.selectAllByRole("violation-icon");for(var t=0;t<i.length;t++){if(i[t].dataset.type==="common"&&this.gridOptions[this.showViolationsCommonName]||i[t].dataset.type==="personal"&&this.gridOptions[this.showViolationsPersonalName]){this.showElement(i[t])}else{this.hideElement(i[t])}}var s=this.selectAllByRole("violation-percentage-stat");for(var n=0;n<s.length;n++){if(this.gridOptions[this.showViolationsPersonalName]&&s[n].dataset.type==="personal"||this.gridOptions[this.showViolationsCommonName]&&s[n].dataset.type==="common"){this.showElement(s[n])}else{this.hideElement(s[n])}}var o=this.selectAllByRole("worktime-record-cell");var a=this.gridOptions[this.showViolationsPersonalName]?"Y":"N";for(var h=0;h<o.length;h++){o[h].href=this.addParamsToUrl(o[h].dataset.individualParam,a,o[h].href)}},_onGridOptionsMenuItemClick:function(e){this.toggleSelectedItemInMenuPopup(e);this.gridOptions[e.id]=!this.gridOptions[e.id];this.saveSelectedOption(e.id);this.updateNavigationHref(this.selectOneByRole("tm-navigation-today"));var t=this.selectAllByRole("navigation-period");for(var i=0;i<t.length;i++){this.updateNavigationHref(t[i])}if(e.id===this.showStatsColumnsName){this.reloadGrid()}else{this.applyGridOptions()}},updateNavigationHref:function(e){if(!e){return}var t=null;if(window.location.href.match(new RegExp(this.showStartFinishName+"=([YN])"))!==null){t=window.location.href.match(new RegExp(this.showStartFinishName+"=([YN])"))[1]}var i=null;if(window.location.href.match(new RegExp(this.showStatsColumnsName+"=([YN])"))!==null){i=window.location.href.match(new RegExp(this.showStatsColumnsName+"=([YN])"))[1]}e.href=e.href.replace(this.showStartFinishName+"="+(t==="Y"?"N":"Y"),this.showStartFinishName+"="+t);e.href=e.href.replace(this.sst+"="+(i==="Y"?"N":"Y"),this.showStatsColumnsName+"="+i)},getGridOptions:function(e){return e?this.gridOptions[e]:this.gridOptions},saveSelectedOption:function(e){var t=this.gridOptions[e];var i=this.addParamsToUrl(e,t?"Y":"N");if(i!==location.href){window.history.replaceState({},"",i)}this.saveLocalGridOptions(e,t)},addParamsToUrl:function(e,t,i){var s=e+"="+t;if(!i){i=location.href}if(i.includes(e)){i=i.replace(new RegExp(e+"=[^&]*(&*)","gi"),s+"$1")}else{i=i.includes("?")?i+"&"+s:i+"?"+s}return i},getCookie:function(e){var t=document.cookie.match(new RegExp("(?:^|; )"+e.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));return t?decodeURIComponent(t[1]):null},saveLocalGridOptions:function(e,t){var i=this.getCookie(e);if(i===t){return}this.setCookie(e,t)},buildSettingsMenuItem:function(e){var t=this.getGridOptions(e.id)?"menu-popup-item-take":"menu-popup-no-icon";return{text:BX.util.htmlspecialchars(e.name),id:BX.util.htmlspecialchars(e.id),className:t+" js-id-"+BX.util.htmlspecialchars(e.id),onclick:function(e){this._settingsPopup.close();this._onGridOptionsMenuItemClick.bind(this,e)();if(this.getGridOptions(this.showViolationsPersonalName)&&this.getGridOptions(this.showViolationsCommonName)){var t=e.id===this.showViolationsPersonalName?this.showViolationsCommonName:this.showViolationsPersonalName;for(var i=0;i<this.gridSettings.length;i++){if(this.gridSettings[i].items&&this.gridSettings[i].items.length){for(var s=0;s<this.gridSettings[i].items.length;s++){if(this.gridSettings[i].items[s].id===t){this._onGridOptionsMenuItemClick.bind(this,this.gridSettings[i].items[s])();break}}}}}}.bind(this,e)}},buildSettingsPopup:function(e){return BX.PopupMenu.create({items:this.buildItems(),id:"tmWorktimeGridOptionsSettings"+BX.util.getRandomString(20),bindElement:e.currentTarget,offsetLeft:-60,angle:false,closeByEsc:true,autoHide:true})},buildItems:function(){var e=[];for(var t=0;t<this.gridSettings.length;t++){var i=this.gridSettings[t];var s={};if(!i.items){s=this.buildSettingsMenuItem(i)}else{s={text:BX.util.htmlspecialchars(i.name),id:BX.util.htmlspecialchars(i.id),className:"menu-popup-no-icon"+" js-id-"+BX.util.htmlspecialchars(i.id),items:[]};for(var n=0;n<i.items.length;n++){s.items.push(this.buildSettingsMenuItem(i.items[n]))}}e.push(s)}return e},reloadGrid:function(){BX.Main.gridManager.reload(this.gridId,location.href)}}})();
//# sourceMappingURL=script.map.js