if(typeof BX.CrmEntityCounterPanel==="undefined"){BX.CrmEntityCounterPanel=function(){this._id="";this._settings={};this._userId=0;this._userName="";this._entityTypeId=0;this._extras=null;this._codes=null;this._data=null;this._totalInfo=null;this._items=null;this._counterManager=null;this._container=null;this._valueContainer=null;this._stubContainer=null};BX.CrmEntityCounterPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._userId=BX.prop.getInteger(this._settings,"userId",0);this._userName=BX.prop.getString(this._settings,"userName",this._userId);this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",0);this._extras=BX.prop.getObject(this._settings,"extras",{});this._codes=BX.prop.getArray(this._settings,"codes",[]);if(BX.CrmEntityType.isDefined(this._entityTypeId)){this._counterManager=BX.Crm.EntityCounterManager.create(this._id,{entityTypeId:this._entityTypeId,codes:this._codes,extras:this._extras,serviceUrl:BX.prop.getString(this._settings,"serviceUrl","")})}this._data=BX.prop.getObject(this._settings,"data",{});this._totalInfo=BX.prop.getObject(this._settings,"totalInfo",{});this._container=BX(this.getSetting("containerId",""));if(!BX.type.isElementNode(this._container)){throw"BX.CrmEntityCounterPanel: Could not find container."}this._valueContainer=BX(BX.prop.getString(this._settings,"valueContainerId"));if(!BX.type.isElementNode(this._valueContainer)){throw"BX.CrmEntityCounterPanel: Could not find valueContainer."}this._stubContainer=BX(BX.prop.getString(this._settings,"stubContainerId"));if(!BX.type.isElementNode(this._stubContainer)){throw"BX.CrmEntityCounterPanel: Could not find stubContainer."}this._items=[];var n=this._valueContainer.querySelectorAll("a.crm-counter-container");for(var i=0,r=n.length;i<r;i++){var s=n[i];var a=s.getAttribute("data-entity-counter-code");if(!BX.type.isNotEmptyString(a)){continue}var o=BX.prop.getObject(this._data,a,null);if(!o){continue}this._items.push(BX.CrmEntityCounterPanelItem.create(a,{parent:this,data:o,container:s}))}BX.addCustomEvent("onPullEvent-main",BX.delegate(this.onPullEvent,this))},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},processItemSelection:function(t){var e=t.getTypeId();if(e>0){var n={userId:this._userId.toString(),userName:this._userName,counterTypeId:e.toString(),cancel:false};BX.onCustomEvent(window,"BX.CrmEntityCounterPanel:applyFilter",[this,n]);if(n.cancel){return false}}return true},onPullEvent:function(t,e){if(t!=="user_counter"){return}var n=false;var i=BX.prop.getObject(e,BX.message("SITE_ID"),{});for(var r in i){if(!i.hasOwnProperty(r)){continue}if(!(r.indexOf("crm")===0&&i[r]>=0)){continue}if(!this._data.hasOwnProperty(r)){continue}if(this._data[r].hasOwnProperty("VALUE")&&BX.convert.toNumber(this._data[r]["VALUE"])===BX.convert.toNumber(i[r])){continue}this._data[r]["VALUE"]=i[r];if(!n){n=true}}if(n){this.prepareTotalInfo();this.refreshLayout()}},prepareTotalInfo:function(){var t=0;for(var e=0,n=this._items.length;e<n;e++){t+=this._items[e].getValue()}var i=BX.CrmMessageHelper.getCurrent().prepareEntityNumberDeclension(t,BX.prop.getObject(this._settings,"entityNumberDeclensions",{}));this._totalInfo={value:t,caption:i}},refreshLayout:function(){var t=BX.prop.getInteger(this._totalInfo,"value",0);if(t>0){if(this._stubContainer.style.display!=="none"){this._stubContainer.style.display="none"}if(this._valueContainer.style.display!==""){this._valueContainer.style.display=""}for(var e=0,n=this._items.length;e<n;e++){this._items[e].refreshLayout()}}else{if(this._valueContainer.style.display!=="none"){this._valueContainer.style.display="none"}if(this._stubContainer.style.display!==""){this._stubContainer.style.display=""}}}};BX.CrmEntityCounterPanel.create=function(t,e){var n=new BX.CrmEntityCounterPanel;n.initialize(t,e);return n}}if(typeof BX.CrmEntityCounterPanelItem==="undefined"){BX.CrmEntityCounterPanelItem=function(){this._id="";this._settings={};this._parent=null;this._container=null;this._data=null;this._clickHandler=BX.delegate(this.onClick,this)};BX.CrmEntityCounterPanelItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._parent=BX.prop.get(this._settings,"parent");if(!this._parent){throw"BX.CrmEntityCounterPanelItem: Could not find parent."}this._data=BX.prop.getObject(this._settings,"data",{});this._container=BX.prop.getElementNode(this._settings,"container");if(!this._container){throw"BX.CrmEntityCounterPanelItem: Could not find container."}BX.bind(this._container,"click",this._clickHandler)},getId:function(){return this._id},getTypeId:function(){return BX.prop.getInteger(this._data,"TYPE_ID",0)},getValue:function(){return BX.prop.getInteger(this._data,"VALUE",0)},refreshLayout:function(){var t=this.getValue();var e=this._container.querySelector(".crm-counter-number");if(e){e.innerHTML=t}this._container.style.display=t>0?"":"none"},onClick:function(t){if(!this._parent.processItemSelection(this)){return BX.PreventDefault(t)}}};BX.CrmEntityCounterPanelItem.create=function(t,e){var n=new BX.CrmEntityCounterPanelItem;n.initialize(t,e);return n}}