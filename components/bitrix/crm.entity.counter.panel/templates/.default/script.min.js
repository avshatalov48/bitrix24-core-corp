this.BX=this.BX||{};(function(e,t,i,a){"use strict";function s(e,t){l(e,t);t.add(e)}function r(e,t,i){l(e,t);t.set(e,i)}function l(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function n(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var b=new WeakMap;var p=new WeakMap;var c=new WeakMap;var d=new WeakMap;var v=new WeakMap;var u=new WeakMap;var o=new WeakMap;var h=new WeakMap;var E=new WeakSet;var f=new WeakSet;var H=new WeakSet;var P=new WeakSet;var T=function(){function e(t){babelHelpers.classCallCheck(this,e);s(this,P);s(this,H);s(this,f);s(this,E);r(this,b,{writable:true,value:void 0});r(this,p,{writable:true,value:void 0});r(this,c,{writable:true,value:void 0});r(this,d,{writable:true,value:void 0});r(this,v,{writable:true,value:void 0});r(this,u,{writable:true,value:void 0});r(this,o,{writable:true,value:void 0});r(this,h,{writable:true,value:void 0});if(!i.Type.isPlainObject(t)){throw'BX.Crm.EntityCounterManager: The "options" argument must be object.'}babelHelpers.classPrivateFieldSet(this,b,i.Type.isString(t.id)?t.id:"");if(babelHelpers.classPrivateFieldGet(this,b)===""){throw'BX.Crm.EntityCounterManager: The "id" argument must be specified.'}babelHelpers.classPrivateFieldSet(this,d,i.Type.isString(t.serviceUrl)?t.serviceUrl:"");if(babelHelpers.classPrivateFieldGet(this,d)===""){throw'BX.Crm.EntityCounterManager: The "serviceUrl" argument must be specified.'}babelHelpers.classPrivateFieldSet(this,p,t.entityTypeId?i.Text.toInteger(t.entityTypeId):0);babelHelpers.classPrivateFieldSet(this,c,BX.CrmEntityType.resolveName(babelHelpers.classPrivateFieldGet(this,p)));babelHelpers.classPrivateFieldSet(this,v,i.Type.isArray(t.codes)?t.codes:[]);babelHelpers.classPrivateFieldSet(this,u,i.Type.isObject(t.extras)?t.extras:{});babelHelpers.classPrivateFieldSet(this,o,{});n(this,E,F).call(this);this.constructor.lastInstance=this}babelHelpers.createClass(e,[{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,b)}},{key:"getCounterData",value:function e(){return babelHelpers.classPrivateFieldGet(this,o)}},{key:"setCounterData",value:function e(t){babelHelpers.classPrivateFieldSet(this,o,t)}}],[{key:"getLastInstance",value:function e(){return this.lastInstance}}]);return e}();function F(){a.EventEmitter.subscribe("onPullEvent-main",n(this,f,I).bind(this))}function I(e){var t=e.getData(),s=babelHelpers.slicedToArray(t,2),r=s[0],l=s[1];if(r!=="user_counter"){return}var b=false;var p=false;var c=i.Loc.getMessage("SITE_ID");var d=i.Type.isPlainObject(l[c])?l[c]:{};for(var u in d){if(!d.hasOwnProperty(u)||babelHelpers.classPrivateFieldGet(this,v).indexOf(u)<0){continue}var h=BX.prop.getInteger(d,u,0);if(h<0){p=true;break}var E=BX.prop.getInteger(babelHelpers.classPrivateFieldGet(this,o),u,0);if(E!==h){b=true;babelHelpers.classPrivateFieldGet(this,o)[u]=h}}if(p){n(this,H,y).call(this)}if(b){a.EventEmitter.emit("BX.Crm.EntityCounterManager:onRecalculate",this)}}function y(){if(babelHelpers.classPrivateFieldGet(this,h)){return}babelHelpers.classPrivateFieldSet(this,h,true);i.ajax({url:babelHelpers.classPrivateFieldGet(this,d),method:"POST",dataType:"json",data:{ACTION:"RECALCULATE",ENTITY_TYPES:[babelHelpers.classPrivateFieldGet(this,c)],EXTRAS:babelHelpers.classPrivateFieldGet(this,u)},onsuccess:BX.delegate(n(this,P,C),this)})}function C(e){babelHelpers.classPrivateFieldSet(this,h,false);var t=i.Type.isPlainObject(e["DATA"])?e["DATA"]:null;if(t===null){return}this.setCounterData(i.Type.isPlainObject(t[babelHelpers.classPrivateFieldGet(this,c)])?t[babelHelpers.classPrivateFieldGet(this,c)]:{});a.EventEmitter.emit("BX.Crm.EntityCounterManager:onRecalculate",this)}babelHelpers.defineProperty(T,"lastInstance",null);var w=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(w,"UNDEFINED",0);babelHelpers.defineProperty(w,"IDLE",1);babelHelpers.defineProperty(w,"PENDING",2);babelHelpers.defineProperty(w,"OVERDUE",4);babelHelpers.defineProperty(w,"CURRENT",6);babelHelpers.defineProperty(w,"ALL_DEADLINE_BASED",7);babelHelpers.defineProperty(w,"INCOMING_CHANNEL",8);babelHelpers.defineProperty(w,"ALL",15);babelHelpers.defineProperty(w,"IDLE_NAME","IDLE");babelHelpers.defineProperty(w,"PENDING_NAME","PENDING");babelHelpers.defineProperty(w,"OVERDUE_NAME","OVERDUE");babelHelpers.defineProperty(w,"CURRENT_NAME","CURRENT");babelHelpers.defineProperty(w,"INCOMING_CHANNEL_NAME","INCOMINGCHANNEL");babelHelpers.defineProperty(w,"ALL_DEADLINE_BASED_NAME","ALLDEADLINEBASED");babelHelpers.defineProperty(w,"ALL_NAME","ALL");function N(e,t){G(e,t);t.add(e)}function m(e,t,i){G(e,t);t.set(e,i)}function G(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function g(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var S=new WeakMap;var D=new WeakMap;var _=new WeakMap;var A=new WeakSet;var M=new WeakSet;var k=new WeakSet;var O=function(){function e(){babelHelpers.classCallCheck(this,e);N(this,k);N(this,M);N(this,A);m(this,S,{writable:true,value:void 0});m(this,D,{writable:true,value:void 0});m(this,_,{writable:true,value:true});var t=i.Type.isObject(BX.Main.filterManager)&&BX.Main.filterManager.hasOwnProperty("getList")?BX.Main.filterManager.getList():Object.values(BX.Main.filterManager.data);if(t.length===0){console.warn("BX.Crm.EntityCounterFilter: Unable to define filter.");babelHelpers.classPrivateFieldSet(this,_,false)}else{babelHelpers.classPrivateFieldSet(this,S,t[0]);g(this,A,L).call(this);this.updateFields()}}babelHelpers.createClass(e,[{key:"getManager",value:function e(){return babelHelpers.classPrivateFieldGet(this,S)}},{key:"isActive",value:function e(){return babelHelpers.classPrivateFieldGet(this,_)}},{key:"getFields",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(i){var a=Object.entries(babelHelpers.classPrivateFieldGet(this,D)).filter((function(e){var i=babelHelpers.slicedToArray(e,2),a=i[0],s=i[1];return g(t,k,R).call(t,a)}));return Object.fromEntries(a)}return babelHelpers.classPrivateFieldGet(this,D)}},{key:"getApi",value:function e(){return babelHelpers.classPrivateFieldGet(this,S).getApi()}},{key:"updateFields",value:function e(){babelHelpers.classPrivateFieldSet(this,D,babelHelpers.classPrivateFieldGet(this,S).getFilterFieldsValues())}},{key:"isFilteredByFieldEx",value:function e(t){if(!Object.keys(babelHelpers.classPrivateFieldGet(this,D)).includes(t)||t.endsWith("_datesel")||t.endsWith("_numsel")||t.endsWith("_label")){return false}return g(this,k,R).call(this,t)}},{key:"isFiltered",value:function t(a,s,r){var l=this;if(a===0||s===w.UNDEFINED){return false}var n=r===BX.CrmEntityType.enumeration.order?true:this.isFilteredByFieldEx(e.COUNTER_USER_FIELD)&&i.Type.isArray(babelHelpers.classPrivateFieldGet(this,D)[e.COUNTER_USER_FIELD])&&babelHelpers.classPrivateFieldGet(this,D)[e.COUNTER_USER_FIELD].length===1&&parseInt(babelHelpers.classPrivateFieldGet(this,D)[e.COUNTER_USER_FIELD][0],10)===a;var b=this.isFilteredByFieldEx(e.COUNTER_TYPE_FIELD)&&i.Type.isObject(babelHelpers.classPrivateFieldGet(this,D)[e.COUNTER_TYPE_FIELD]);var p=b?Object.values(babelHelpers.classPrivateFieldGet(this,D)[e.COUNTER_TYPE_FIELD]).map((function(e){return parseInt(e,10)})).sort():[];var c=p.length===1&&p[0]===s||p.length===2&&s===w.CURRENT&&p[0]===w.PENDING&&p[1]===w.OVERDUE;var d=[e.COUNTER_USER_FIELD,e.COUNTER_TYPE_FIELD].concat(babelHelpers.toConsumableArray(e.EXCLUDED_FIELDS));var v=Object.keys(babelHelpers.classPrivateFieldGet(this,D));var u=d.filter((function(e){return!v.includes(e)})).concat(v.filter((function(e){return!d.includes(e)})));var o=u.some((function(e){return l.isFilteredByFieldEx(e)}));return n&&c&&!o}}]);return e}();function L(){a.EventEmitter.subscribe("BX.Main.Filter:apply",g(this,M,U).bind(this))}function U(){this.updateFields()}function R(e){if(i.Type.isArray(babelHelpers.classPrivateFieldGet(this,D)[e])){return babelHelpers.classPrivateFieldGet(this,D)[e].length>0}if(i.Type.isObject(babelHelpers.classPrivateFieldGet(this,D)[e])){return Object.values(babelHelpers.classPrivateFieldGet(this,D)[e]).length>0}return babelHelpers.classPrivateFieldGet(this,D)[e]!==""}babelHelpers.defineProperty(O,"COUNTER_TYPE_FIELD","ACTIVITY_COUNTER");babelHelpers.defineProperty(O,"COUNTER_USER_FIELD","ASSIGNED_BY_ID");babelHelpers.defineProperty(O,"EXCLUDED_FIELDS",["FIND"]);function B(e,t){X(e,t);t.add(e)}function W(e,t,i){X(e,t);t.set(e,i)}function X(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function z(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var j=i.Reflection.namespace("BX.Crm");var x=new WeakMap;var Y=new WeakMap;var V=new WeakMap;var J=new WeakMap;var q=new WeakMap;var K=new WeakMap;var Q=new WeakMap;var Z=new WeakMap;var $=new WeakMap;var ee=new WeakSet;var te=new WeakSet;var ie=new WeakSet;var ae=new WeakSet;var se=new WeakSet;var re=new WeakSet;var le=new WeakSet;var ne=new WeakSet;var be=new WeakSet;var pe=function(e){babelHelpers.inherits(t,e);function t(e){var a;babelHelpers.classCallCheck(this,t);if(!i.Type.isPlainObject(e)){throw'BX.Crm.EntityCounterPanel: The "options" argument must be object.'}var s=i.Type.isPlainObject(e.data)?e.data:{};a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{target:BX(e.id),items:t.getCounterItems(s),multiselect:false}));B(babelHelpers.assertThisInitialized(a),be);B(babelHelpers.assertThisInitialized(a),ne);B(babelHelpers.assertThisInitialized(a),le);B(babelHelpers.assertThisInitialized(a),re);B(babelHelpers.assertThisInitialized(a),se);B(babelHelpers.assertThisInitialized(a),ae);B(babelHelpers.assertThisInitialized(a),ie);B(babelHelpers.assertThisInitialized(a),te);B(babelHelpers.assertThisInitialized(a),ee);W(babelHelpers.assertThisInitialized(a),x,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),Y,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),V,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),J,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),q,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),K,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),Q,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),Z,{writable:true,value:void 0});W(babelHelpers.assertThisInitialized(a),$,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),x,e.id);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),Y,e.entityTypeId?i.Text.toInteger(e.entityTypeId):0);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),V,e.userId?i.Text.toInteger(e.userId):0);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),J,i.Type.isStringFilled(e.userName)?e.userName:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),V));babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),q,s);if(BX.CrmEntityType.isDefined(babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),Y))){babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),K,new T({id:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),x),entityTypeId:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),Y),serviceUrl:i.Type.isString(e.serviceUrl)?e.serviceUrl:"",codes:i.Type.isArray(e.codes)?e.codes:[],extras:i.Type.isObject(e.extras)?e.extras:{}}))}babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),Q,new O);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),Z,e.filterLastPresetId);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),$,i.Type.isArray(e.filterLastPresetData)?JSON.parse(e.filterLastPresetData[0]):{presetId:null});z(babelHelpers.assertThisInitialized(a),ee,ce).call(babelHelpers.assertThisInitialized(a));return a}babelHelpers.createClass(t,[{key:"init",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"init",this).call(this);z(this,ne,fe).call(this)}},{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,x)}}],[{key:"getCounterItems",value:function e(a){return Object.entries(a).map((function(e){var a=babelHelpers.slicedToArray(e,2),s=a[0],r=a[1];var l=parseInt(r.VALUE,10);return{id:s,title:i.Loc.getMessage("NEW_CRM_COUNTER_TYPE_"+r.TYPE_NAME),value:l,color:t.detectCounterItemColor(r.TYPE_NAME,l)}}),this)}},{key:"detectCounterItemColor",value:function e(t,i){var a=[w.IDLE_NAME,w.OVERDUE_NAME,w.CURRENT_NAME].includes(t);var s=[w.INCOMING_CHANNEL_NAME].includes(t);return i>0?a?"DANGER":s?"SUCCESS":"THEME":"THEME"}}]);return t}(t.CounterPanel);function ce(){a.EventEmitter.subscribe("BX.UI.CounterPanel.Item:activate",z(this,te,de).bind(this));a.EventEmitter.subscribe("BX.UI.CounterPanel.Item:deactivate",z(this,ie,ve).bind(this));a.EventEmitter.subscribe("BX.Main.Filter:apply",z(this,ae,ue).bind(this));a.EventEmitter.subscribe("BX.Crm.EntityCounterManager:onRecalculate",z(this,se,oe).bind(this))}function de(e){var t=e.getData();if(!z(this,re,he).call(this,t)){return BX.PreventDefault(e)}}function ve(){if(z(this,be,He).call(this)&&babelHelpers.classPrivateFieldGet(this,Q).isActive()){var e=babelHelpers.classPrivateFieldGet(this,Q).getApi();if(babelHelpers.classPrivateFieldGet(this,$).presetId==="tmp_filter"){e.setFields(babelHelpers.classPrivateFieldGet(this,$).fields);e.apply()}else{e.setFilter({preset_id:babelHelpers.classPrivateFieldGet(this,$).presetId})}}}function ue(){if(babelHelpers.classPrivateFieldGet(this,Q).isActive()){babelHelpers.classPrivateFieldGet(this,Q).updateFields()}z(this,ne,fe).call(this)}function oe(){var e=babelHelpers.classPrivateFieldGet(this,K).getCounterData();for(var t in e){if(!e.hasOwnProperty(t)||!(t.indexOf("crm")===0&&e[t]>=0)||!babelHelpers.classPrivateFieldGet(this,q).hasOwnProperty(t)||i.Text.toNumber(babelHelpers.classPrivateFieldGet(this,q)[t].VALUE)===i.Text.toNumber(e[t])){continue}babelHelpers.classPrivateFieldGet(this,q)[t].VALUE=e[t];var a=this.getItemById(t);a.updateValue(i.Text.toNumber(e[t]));a.updateColor(pe.detectCounterItemColor(babelHelpers.classPrivateFieldGet(this,q)[t].TYPE_NAME,i.Text.toNumber(e[t])))}}function he(e){var t=parseInt(babelHelpers.classPrivateFieldGet(this,q)[e.id].TYPE_ID,10);if(t>0){var i={userId:babelHelpers.classPrivateFieldGet(this,V).toString(),userName:babelHelpers.classPrivateFieldGet(this,J),counterTypeId:z(this,le,Ee).call(this,t),cancel:false};if(babelHelpers.classPrivateFieldGet(this,Q).isActive()){var a=babelHelpers.classPrivateFieldGet(this,Q).getFields(true);if(typeof a[O.COUNTER_TYPE_FIELD]==="undefined"){babelHelpers.classPrivateFieldGet(this,$).presetId=babelHelpers.classPrivateFieldGet(this,Q).getApi().parent.getPreset().getCurrentPresetId();if(babelHelpers.classPrivateFieldGet(this,$).presetId==="tmp_filter"){babelHelpers.classPrivateFieldGet(this,$).fields=a}BX.userOptions.save("crm",babelHelpers.classPrivateFieldGet(this,Z),"",JSON.stringify(babelHelpers.classPrivateFieldGet(this,$)))}BX.onCustomEvent(window,"BX.CrmEntityCounterPanel:applyFilter",[this,i]);if(i.cancel){return false}}else{return false}}return true}function Ee(e){if(e===w.CURRENT){return{0:w.OVERDUE.toString(),1:w.PENDING.toString()}}return e.toString()}function fe(){var e=this;if(!babelHelpers.classPrivateFieldGet(this,Q).isActive()){return}Object.entries(babelHelpers.classPrivateFieldGet(this,q)).forEach((function(t){var i=babelHelpers.slicedToArray(t,2),a=i[0],s=i[1];var r=e.getItemById(a);babelHelpers.classPrivateFieldGet(e,Q).isFiltered(babelHelpers.classPrivateFieldGet(e,V),parseInt(s.TYPE_ID,10),babelHelpers.classPrivateFieldGet(e,Y))?r.activate(false):r.deactivate(false);if(r.value!==r.counter.getValue()){r.updateValue(r.value)}}))}function He(){return this.getItems().every((function(e){return!e.isActive}))}j.EntityCounterPanel=pe})(this.BX.Crm=this.BX.Crm||{},BX.UI,BX,BX.Event);
//# sourceMappingURL=script.map.js