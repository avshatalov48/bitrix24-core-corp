BX.ready(function(){BX.PULL.extendWatch("IMOL_STATISTICS");BX.addCustomEvent("onPullEvent-imopenlines",function(e,t){if(e=="voteHead"){if(typeof t.voteValue!=="undefined"){var n=BX("ol-vote-head-placeholder-"+t.sessionId);if(n){BX.cleanNode(n);n.appendChild(BX.MessengerCommon.linesVoteHeadNodes(t.sessionId,t.voteValue,true))}}if(typeof t.commentValue!=="undefined"){var i=BX("ol-comment-head-placeholder-"+t.sessionId);if(i){BX.cleanNode(i);i.appendChild(BX.MessengerCommon.linesCommentHeadNodes(t.sessionId,t.commentValue,true,"statistics"))}}}});BX.namespace("BX.OpenLines");if(typeof BX.OpenLines.ExportManager==="undefined"){BX.OpenLines.ExportManager=function(){this._id="";this._settings={};this._processDialog=null;this._siteId="";this._sToken="";this._cToken="";this._token=""};BX.OpenLines.ExportManager.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=t?t:{};this._siteId=this.getSetting("siteId","");if(!BX.type.isNotEmptyString(this._siteId))throw"BX.OpenLines.ExportManager: parameter 'siteId' is not found.";this._sToken=this.getSetting("sToken","");if(!BX.type.isNotEmptyString(this._sToken))throw"BX.OpenLines.ExportManager: parameter 'sToken' is not found."},getId:function(){return this._id},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},callAction:function(e){this._processDialog.setAction(e);this._processDialog.start()},startExport:function(e){if(!BX.type.isNotEmptyString(e))throw"BX.OpenLines.ExportManager: parameter 'exportType' has invalid value.";this._cToken="c"+Date.now();this._token=this._sToken+this._cToken;var t={SITE_ID:this._siteId,PROCESS_TOKEN:this._token,EXPORT_TYPE:e,COMPONENT_NAME:"bitrix:imopenlines.statistics.detail",signedParameters:this.getSetting("componentParams",{})};var n=e.charAt(0).toUpperCase()+e.slice(1);this._processDialog=BX.OpenlinesLongRunningProcessDialog.create(this._id+"_LrpDlg",{componentName:"bitrix:imopenlines.statistics.detail",action:"dispatcher",params:t,title:this.getMessage("stExport"+n+"DlgTitle"),summary:this.getMessage("stExport"+n+"DlgSummary"),isSummaryHtml:false,requestHandler:function(e){if(BX.type.isNotEmptyString(e["STATUS"])&&e["STATUS"]=="COMPLETED"){if(BX.type.isNotEmptyString(e["DOWNLOAD_LINK"])){e["SUMMARY_HTML"]+="<br><br>"+'<a href="'+e["DOWNLOAD_LINK"]+'" class="ui-btn ui-btn-sm ui-btn-success ui-btn-icon-download">'+e["DOWNLOAD_LINK_NAME"]+"</a>"+'<button onclick="BX.OpenLines.ExportManager.currentInstance().callAction(\'clear\')" class="ui-btn ui-btn-sm ui-btn-default ui-btn-icon-remove">'+e["CLEAR_LINK_NAME"]+"</button>"}}}});this._processDialog.show()},destroy:function(){this._id="";this._settings={};this._processDialog=null;this._siteId="";this._sToken="";this._cToken="";this._token=""}};BX.OpenLines.ExportManager.prototype.getMessage=function(e){var t=e;var n=this.getSetting("messages",null);if(n!==null&&typeof n==="object"&&n.hasOwnProperty(e)){t=n[e]}else{n=BX.OpenLines.ExportManager.messages;if(n!==null&&typeof n==="object"&&n.hasOwnProperty(e)){t=n[e]}}return t};if(typeof BX.OpenLines.ExportManager.messages==="undefined"){BX.OpenLines.ExportManager.messages={}}if(typeof BX.OpenLines.ExportManager.items==="undefined"){BX.OpenLines.ExportManager.items={}}BX.OpenLines.ExportManager.create=function(e,t){var n=new BX.OpenLines.ExportManager;n.initialize(e,t);BX.OpenLines.ExportManager.items[e]=n;BX.OpenLines.ExportManager.currentId=e;return n};BX.OpenLines.ExportManager.delete=function(e){if(BX.OpenLines.ExportManager.items.hasOwnProperty(e)){BX.OpenLines.ExportManager.items[e].destroy();delete BX.OpenLines.ExportManager.items[e]}};BX.OpenLines.ExportManager.currentId="";BX.OpenLines.ExportManager.currentInstance=function(){return BX.OpenLines.ExportManager.items[BX.OpenLines.ExportManager.currentId]}}if(typeof BX.OpenLines.Actions==="undefined"){BX.OpenLines.Actions={actionController:"imopenlines.session.groupactions",gridId:null,transferDialog:null,transferItems:null,transferInputId:null,transferInputName:null,init:function(e,t){this.gridId=e;this.transferItems=t.transfer.items;this.transferInputId=t.transfer.inputId;this.transferInputName=t.transfer.inputName},initTransferDialogSelector:function(){if(!this.transferDialog){this.transferDialog=new BX.UI.EntitySelector.Dialog({targetNode:BX(this.transferInputId),context:this.getGridInstance(),multiple:false,entities:[{id:"user",dynamicLoad:true,dynamicSearch:true,options:{intranetUsersOnly:true,inviteEmployeeLink:false}},{id:"department",dynamicLoad:true,dynamicSearch:true,options:{inviteEmployeeLink:false,selectMode:"users"}}],tabs:[{id:"open-lines",title:BX.message("OL_COMPONENT_SESSION_GROUP_ACTION_OPEN_LINES_TITLE")}],items:this.transferItems,events:{"Item:onSelect":BX.proxy(function(){var e="";var t=this.getSelectedItemTransfer();if(t){e=t.title.text}this.setValueTransferInput(e)},this),"Item:onDeselect":BX.proxy(function(){this.setValueTransferInput("")},this)}})}BX(this.transferInputId).addEventListener("click",function(){BX.OpenLines.Actions.transferDialog.show()});BX.lastChild(BX(this.transferInputId)).addEventListener("input",function(){BX.OpenLines.Actions.transferDialog.show();BX.OpenLines.Actions.transferDialog.search(this.value)})},destroyTransferDialogSelector:function(){if(!!this.transferDialog){BX(this.transferInputId).removeEventListener("click",function(){BX.OpenLines.Actions.transferDialog.show()});BX(this.transferInputId).removeEventListener("input",function(){BX.OpenLines.Actions.transferDialog.show();BX.OpenLines.Actions.transferDialog.search(this.value)});this.transferDialog.destroy();delete this.transferDialog}},setValueTransferInput:function(e){if(!e){e=""}var t=BX.findChild(BX(this.transferInputId),{tag:"input",name:this.transferInputName});if(!!t){t.value=e}},getSelectedItemTransfer:function(){var e=null;if(!!this.transferDialog){this.transferDialog.getSelectedItems().forEach(BX.proxy(function(t){e=t},this))}return e},getGridInstance:function(){var e=this.gridId;if(e!==null){var t=BX.Main.gridManager.getById(e);return BX.type.isPlainObject(t)&&t["instance"]!=="undefined"?t["instance"]:null}return null},refreshGrid:function(){window.requestAnimationFrame(function(){var e=BX.Main.gridManager.getInstanceById(this.gridId);if(e){e.reload()}}.bind(this))},getPanelControl:function(e){return BX(e+"_"+this.gridId+"_control")},getCheckBoxValue:function(e){var t=this.getControl(e);return t&&t.checked},getControl:function(e){return BX(e+"_"+this.gridId)},applyAction:function(e){var t=null;var n=this.getGridInstance();if(n){var i=this.getCheckBoxValue("actallrows");var s=n.getRows().getSelectedIds();if(s.length!==0||i){var r={idsSession:s};if(i){r.forAll="Y"}if(e==="spam"){this.runCloseSpam(r)}else if(e==="close"){this.runClose(r)}else if(e==="transfer"){var o=null;if(this.getSelectedItemTransfer().entityId==="user"){o=this.getSelectedItemTransfer().id}else if(this.getSelectedItemTransfer().entityId==="open-line"){o="queue"+this.getSelectedItemTransfer().id}if(o!==null){r.transferId=o;this.runTransfer(r)}if(!!this.transferInputId){this.destroyTransferDialogSelector()}}}}},confirmGroupAction:function(e){if(this.gridId===null){this.gridId=e}this.applyAction(BX.data(this.getPanelControl("action_button"),"value"))},runAction:function(e,t){var n={data:null,errors:null};BX.ajax.runAction(e,{data:t}).then(function(e){n.data=e.data},function(e){n.errors=e.errors});return n},runStepProcess:function(e,t,n){var i=new BX.UI.StepProcessing.Process({id:"OpenLinesGroupActions",controller:this.actionController,messages:{DialogTitle:BX.message("LIST_GROUP_ACTION_TITLE"),DialogSummary:BX.message("LIST_GROUP_ACTION_SUMMARY")},showButtons:{start:true,stop:true,close:true},dialogMaxWidth:600});if("forAll"in t){delete t.idsSession;delete t.forAll;i.addQueueAction({title:n,action:"getdialog",handlers:{StepCompleted:function(e,t){if(e===BX.UI.StepProcessing.ProcessResultStatus.completed){var n=this.getParam("fields")||[];n.idsChat=[];n.idsSession=[];if(t.sessions){t.sessions.forEach(function(e){n.idsChat.push(e.chatId);n.idsSession.push(e.sessionId)})}if(t.TOTAL_ITEMS){n.totalItems=parseInt(t.TOTAL_ITEMS)}this.setParam("fields",n)}}}})}i.setHandler(BX.UI.StepProcessing.ProcessCallback.StateChanged,function(e,t){if(e===BX.UI.StepProcessing.ProcessResultStatus.completed){BX.OpenLines.Actions.refreshGrid();this.closeDialog()}}).setHandler(BX.UI.StepProcessing.ProcessCallback.RequestStop,function(e){setTimeout(BX.delegate(function(){BX.OpenLines.Actions.refreshGrid();this.closeDialog()},this),2e3)}).addQueueAction({title:n,action:e,handlers:{StepCompleted:function(e,t){if(e===BX.UI.StepProcessing.ProcessResultStatus.progress){var n=this.getParam("fields")||[];if(t.TOTAL_ITEMS){n.totalItems=parseInt(t.TOTAL_ITEMS)}if(t.PROCESSED_ITEMS){n.processedItems=parseInt(t.PROCESSED_ITEMS)}this.setParam("fields",n)}}}}).setParam("fields",t).showDialog();return i},runClose:function(e){this.runStepProcess("close",e,BX.message("LIST_GROUP_ACTION_CLOSE"))},runCloseSpam:function(e){this.runStepProcess("closespam",e,BX.message("LIST_GROUP_ACTION_SPAM"))},runTransfer:function(e){this.runStepProcess("transfer",e,BX.message("LIST_GROUP_ACTION_TRANSFER"))},close:function(e){this.runAction(this.actionController+".close",{fields:{idsChat:[e]}});this.refreshGrid()},closeSpam:function(e){this.runAction(this.actionController+".closespam",{fields:{idsChat:[e]}});this.refreshGrid()},getChatSessionForAll:function(){var e=[];BX.ajax.runAction(this.actionController+".getdialog",{data:{}}).then(function(t){if(t.data){t.data.forEach(function(t){e.push(t.chatId)})}e=t.data},function(e){});return e}}}if(typeof BX.OpenLines.GridActions==="undefined"){BX.OpenLines.GridActions={gridId:null,groupSelector:null,registeredTimerNodes:{},defaultPresetId:"",initPopupBaloon:function(e,t,n){this.groupSelector=null;BX.bind(BX(t+"_control"),"click",BX.delegate(function(){if(!this.groupSelector){this.groupSelector.bindEvent("item-selected",BX.delegate(function(e){BX(t+"_control").value=BX.util.htmlspecialcharsback(e.nameFormatted)||"";BX(n+"_control").value=e.id||"";this.groupSelector.close()},this))}this.groupSelector.open()},this))},applyAction:function(e){var t=this.getGrid();if(t){var n=this.getCheckBoxValue("actallrows");var i=t.getRows().getSelectedIds();console.log(i);if(i.length!==0||n){if(e==="close"){this.refreshGrid()}else if(e==="spam"){}}}},confirmGroupAction:function(e){if(this.gridId===null){this.gridId=e}this.applyAction(BX.data(this.getPanelControl("action_button"),"value"))},getPanelControl:function(e){return BX(e+"_"+this.gridId+"_control")},getGrid:function(){var e=this.gridId;if(e!==null){var t=BX.Main.gridManager.getById(e);return BX.type.isPlainObject(t)&&t["instance"]!=="undefined"?t["instance"]:null}return null},getCheckBoxValue:function(e){var t=this.getControl(e);return t&&t.checked},getControl:function(e){return BX(e+"_"+this.gridId)},refreshGrid:function(){window.requestAnimationFrame(function(){var e=BX.Main.gridManager.getInstanceById(this.gridId);if(e){e.reload()}}.bind(this))}}}});
//# sourceMappingURL=script.map.js