if(typeof BX.CrmActivityTodo==="undefined"){BX.CrmActivityTodo=function(t){this._ccontainer=t.ccontainer||"crm-activity-todo-items";this._citem=t.citem||"crm-activity-todo-item";this._clink=t.clink||"crm-activity-todo-link";this._ccheck=t.ccheck||"crm-activity-todo-check";this._cbuttoncancel=t.cbuttoncancel||"popup-window-button-link-cancel";this._ccheckprefix=t.ccheckprefix||"check";this._ajaxPath=t.ajax_path||"/bitrix/components/bitrix/crm.activity.todo/ajax.php";this._ajaxPlannerPath=t.ajax_planner_path||"/bitrix/components/bitrix/crm.activity.planner/ajax.php?site_id="+BX.message("SITE_ID");this._dialogId="activity_todo_dialog";this._popup=null;this._activityId=0;var e=BX.findChild(BX(this._ccontainer),{class:this._clink,tag:"a"},true,true);if(e){for(i=0;i<e.length;i++){BX.bind(e[i],"click",BX.delegate(this._clickTitleHandler,this))}}var o=BX.findChild(BX(this._ccontainer),{class:this._ccheck},true,true);if(o){for(i=0;i<o.length;i++){BX.bind(o[i],"click",BX.delegate(this._clickCheckHandler,this))}}};BX.CrmActivityTodo.prototype={_getParent:function(t){return BX.findParent(t,{class:this._citem})},_showPopup:function(t,i){if(this._popup===null){this._popup=new BX.PopupWindow(this._dialogId,window.body,{offsetLeft:0,lightShadow:true,closeIcon:true,titleBar:{content:BX.create("span",{html:""})},draggable:true,closeByEsc:true,contentColor:"white",events:i,overlay:{backgroundColor:"#cdcdcd",opacity:"80"}})}this._popup.setContent("...");this._popup.setTitleBar(t);this._popup.show()},_loadActivity:function(){var t=this;BX.ajax.post(this._ajaxPlannerPath,{sessid:BX.bitrix_sessid(),ajax_action:"ACTIVITY_VIEW",activity_id:this._activityId},function(i){t._popup.setContent(i);t._popup.adjustPosition();var e=t._getNodeByRole(BX(t._dialogId),"additional-switcher");var o=t._getNodeByRole(BX(t._dialogId),"additional-fields");var a=t._getNodeByRole(BX(t._dialogId),"field-completed");if(e&&o){BX.bind(e,"click",function(){BX.toggleClass(o,"active")})}if(a){BX.remove(BX.findParent(a,{tag:"label"}))}t._popup.setButtons([new BX.PopupWindowButtonLink({text:BX.message("CRM_ACTIVITY_TODO_CLOSE"),className:t._cbuttoncancel,events:{click:function(){this.popupWindow.close()}}})])})},_getNodeByRole:function(t,i){return t.querySelector('[data-role="'+i+'"]')},_clickTitleHandler:function(t){this._activityId=BX.data(this._getParent(BX.proxy_context),"id");if(BX.data(this._getParent(BX.proxy_context),"icon")==="tasks"&&typeof window["taskIFramePopup"]!=="undefined"){window["taskIFramePopup"].view(BX.data(this._getParent(BX.proxy_context),"associatedid"),window["tasksIFrameList"])}else if(BX.CrmActivityEditor&&BX.CrmActivityEditor.items["kanban_activity_editor"]){BX.CrmActivityEditor.items["kanban_activity_editor"].viewActivity(this._activityId)}else{this._showPopup(BX.message("CRM_ACTIVITY_TODO_VIEW_TITLE"),{onAfterPopupShow:BX.delegate(this._loadActivity,this),onPopupClose:BX.delegate(function(){this._popup.destroy();this._popup=null},this)})}BX.PreventDefault(t)},_clickCheckHandler:function(t){if(BX.proxy_context.checked){var i=BX.proxy_context;var e=this._getParent(i);BX.ajax.loadJSON(this._ajaxPath,{action:"complete",id:BX.data(e,"id"),ownerid:BX.data(e,"ownerid"),ownertypeid:BX.data(e,"ownertypeid"),completed:1},function(t){if(0&&t.error){alert(t.error);i.checked=false}else{BX.onCustomEvent("onCrmActivityTodoChecked",[BX.data(e,"id"),BX.data(e,"ownerid"),BX.data(e,"ownertypeid"),parseInt(BX.data(e,"deadlined"))===1]);i.disabled=true;BX.addClass(e,"crm-activity-todo-item-completed")}})}}};BX.CrmActivityTodo._self=null;BX.CrmActivityTodo.create=function(t){this._self=new BX.CrmActivityTodo(t||{});return this._self}}