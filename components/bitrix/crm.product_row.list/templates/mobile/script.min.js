BX.namespace("BX.Mobile.Crm.ProductEditor");BX.Mobile.Crm.ProductEditor={products:[],productsContainerNode:"",isEditMode:false,onProductSelectEventName:"",ajaxUrl:"",_settings:{},_currencyId:"",_currencyFormat:"# ?",_locationID:0,init:function(t){BX.CrmDiscountType={undefined:0,monetary:1,percentage:2};if(typeof t==="object"){this.products=t.products||[];this.productsContainerNode=t.productsContainerNode||"";this.onProductSelectEventName=t.onProductSelectEventName||"";this.ajaxUrl=t.ajaxUrl||"";this._settings=t.settings||{};this.isEditMode=t.isEditMode=="Y"?true:false;this._currencyId=this.getSetting("currencyID","");this._currencyFormat=this.getSetting("currencyFormat","# ?")}this._locationID=this.isLDTaxAllowed()?this.getSetting("locationID",0):0;if(this.isLDTaxAllowed())BX.addCustomEvent("CrmProductRowSetLocation",BX.delegate(this._handleChangeLocation,this));this._clientTypeName=this.getSetting("clientTypeName","");BX.addCustomEvent("CrmEntitySelectorChangeValue",BX.delegate(this._handleEntitySelectorChangeValue,this));if(this.products){for(var e=0;e<this.products.length;e++){if(!this.products[e].DATA_ROLE)this.products[e].DATA_ROLE=this.products[e].ID;this.products[e].FORMATTED_PRICE=this._currencyFormat.replace(/#/g,this.products[e].PRICE);this.generateProductHtml(this.products[e])}}if(this.isEditMode){BXMobileApp.addCustomEvent(this.onProductSelectEventName,BX.proxy(function(t){this.addProduct(t)},this))}},addProduct:function(t){if(typeof t!=="object")return;if(t.PRODUCT_ID){t.QUANTITY=1;t.DATA_ROLE=t.ID+"_"+Math.random();this.products.push(t);this.generateProductHtml(t);this.calculateTotals()}},generateProductHtml:function(t){var e=[];if(this.isEditMode){e.push(BX.create("i",{attrs:{className:"crm-mobile-product-view-block-menu-container"},children:[BX.create("span",{attrs:{className:"crm-mobile-product-view-block-menu"}})],events:{click:function(){BX.Mobile.Crm.ProductEditor.showProductActionMenu(this)}}}))}if(t.hasOwnProperty("PRICE_NETTO")||t.hasOwnProperty("PRICE_BRUTTO")){var i=this.isTaxAllowed();var r=this.isTaxIncluded();var n=i&&!r?t.PRICE_NETTO:t.PRICE_BRUTTO;t.FORMATTED_PRICE=this._currencyFormat.replace(/#/g,n);var a=typeof(t.QUANTITY*n)!="undefined"?parseFloat(t.QUANTITY*n).toFixed(2):"0.00"}else{var a=typeof(t.QUANTITY*t.PRICE)!="undefined"?parseFloat(t.QUANTITY*t.PRICE).toFixed(2):"0.00"}var s=this._currencyFormat.replace(/#/g,a);e.push(BX.create("span",{attrs:{className:"crm-mobile-product-view-block-photo"},children:[BX.create("img",{attrs:{src:"/bitrix/components/bitrix/crm.product_row.list/templates/mobile/images/icon-product.png"}})]}),BX.create("span",{html:BX.util.htmlspecialchars(t.PRODUCT_NAME),attrs:{className:"crm-mobile-product-view-block-name-title"}}),BX.create("span",{html:"<span data-role='productPrice'>"+t.FORMATTED_PRICE+"</span> * "+"<span data-role='productQuantity'>"+t.QUANTITY+"</span> "+t.MEASURE_NAME,attrs:{className:"crm-mobile-product-view-block-col-price"}}));var o=[];o.push(BX.create("div",{attrs:{className:"crm-mobile-product-view-block-container"},children:e}));if(this.isEditMode){var c=[];c.push(BX.create("span",{attrs:{"data-role":"sumWithQuantity",className:"crm-mobile-product-view-block-price"},html:s}),BX.create("span",{attrs:{className:"crm-mobile-product-view-block-icon-minus"},events:{click:BX.proxy(function(){this.changeProductQuantity(t.DATA_ROLE,"decrement")},this)}}),BX.create("input",{attrs:{"data-role":"productQuantityInput",className:"crm-mobile-product-view-block-item-col",value:t.QUANTITY,name:"productQuantityInput",type:"number",pattern:"[0-9]*",style:"width: 30px; text-align: center;"},events:{keyup:function(){this.changeProductQuantity(t.DATA_ROLE,"value")}.bind(this)}}),BX.create("span",{attrs:{className:"crm-mobile-product-view-block-icon-plus"},events:{click:BX.proxy(function(){this.changeProductQuantity(t.DATA_ROLE,"increment")},this)}}));o.push(BX.create("div",{attrs:{className:"crm-mobile-product-view-block-controls"},children:c}))}var l=BX.create("div",{attrs:{className:"crm-mobile-product-view-block","data-role":t.DATA_ROLE},children:o});if(this.productsContainerNode){this.productsContainerNode.appendChild(l);if(this.productsContainerNode.style.display=="none"){this.productsContainerNode.style.display="block"}}},changeProductQuantity:function(t,e){if(e!=="increment"&&e!=="decrement"&&e!=="value")return;var r=this.productsContainerNode.querySelector("[data-role='"+t+"']");var n=r.querySelector("[data-role='productQuantityInput']");if(typeof n==="object"){var a=n.value;if(e=="decrement"&&a>1)a--;else if(e=="increment")a++;else if(e=="value"&&a==0)return;var s=r.querySelector("[data-role='productQuantity']");if(typeof s==="object")s.innerHTML=a;n.value=a;for(i=0;i<this.products.length;i++){if(this.products[i].DATA_ROLE==t){this.products[i].QUANTITY=a;if(this.products[i].PRICE){var o=r.querySelector("[data-role='sumWithQuantity']");if(o){var c=typeof(a*this.products[i].PRICE)!="undefined"?parseFloat(a*this.products[i].PRICE).toFixed(2):"0.00";var l=this._currencyFormat.replace(/#/g,c);o.innerHTML=l}}break}}this.calculateTotals()}},showProductActionMenu:function(t){new BXMobileApp.UI.ActionSheet({buttons:[{title:BX.message("CRM_JS_DELETE"),callback:function(){BX.Mobile.Crm.ProductEditor.deleteProduct(t.parentNode.parentNode)}}]},"actionSheetStatus").show()},deleteProduct:function(t){var e=t.getAttribute("data-role");for(var i=0;i<this.products.length;i++){if(this.products[i].DATA_ROLE==e){this.products.splice(i,1);break}}if(this.products.length==0){this.productsContainerNode.style.display="none"}BX.remove(t);this.calculateTotals()},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},calculateTotals:function(){BX.ajax({url:this.ajaxUrl,method:"POST",dataType:"json",data:{MODE:"CALCULATE_TOTALS",OWNER_TYPE:this.getSetting("ownerType",""),OWNER_ID:this.getSetting("ownerID",0),PRODUCTS:this.products,CURRENCY_ID:this._currencyId,CLIENT_TYPE_NAME:this.getClientTypeName(),SITE_ID:this.getSetting("siteId",""),LOCATION_ID:this._locationID,ALLOW_LD_TAX:this.isLDTaxAllowed()?"Y":"N",LD_TAX_PRECISION:this.getSetting("taxListPercentPrecision",2)},onsuccess:BX.delegate(this._onCalculateTotalsRequestSuccess,this),onfailure:BX.delegate(this._onCalculateTotalsRequestFailure,this)})},calculateTotalsDelayed:function(){if(this._calculateTotalsTimer)clearTimeout(this._calculateTotalsTimer);this._calculateTotalsTimer=setTimeout(BX.delegate(this._handleCalculateTotalsTimer,this),1e3)},_handleChangeLocation:function(t){var e=0,i=document.getElementsByName(t)[0];if(i&&BX.type.isElementNode(i)){e=i.value;this._locationID=e;this.calculateTotalsDelayed()}},_handleEntitySelectorChangeValue:function(t,e){if(t!=="COMPANY"&&t!=="CONTACT")return;var i=this.getClientTypeName();var r=i;if(i==="COMPANY"){if(t==="COMPANY"&&e==0)r="CONTACT"}else{if(t==="COMPANY"&&e>0)r="COMPANY";else r="CONTACT"}if(i!==r){this.setClientTypeName(r);if(this.isLDTaxAllowed())this.calculateTotalsDelayed()}},_handleCalculateTotalsTimer:function(){this.calculateTotals()},_onCalculateTotalsRequestSuccess:function(t){if(!typeof t==="object")return;if(typeof t["TOTALS"]!="undefined"){this.refreshTotals(t["TOTALS"])}if(typeof t["LD_TAXES"]!="undefined"){this.setSetting("LDTaxes",t["LD_TAXES"]);this.refreshTaxList(t["LD_TAXES"])}},refreshTotals:function(t){var e,i,r;r=BX(this.getSetting("TOTAL_BEFORE_DISCOUNT_ID","total_before_discount"));if(r){i=BX.type.isNotEmptyString(t["TOTAL_BEFORE_DISCOUNT_FORMATTED"])?t["TOTAL_BEFORE_DISCOUNT_FORMATTED"]:"";e=typeof t["TOTAL_BEFORE_DISCOUNT"]!="undefined"?parseFloat(t["TOTAL_BEFORE_DISCOUNT"]).toFixed(2):"0.00";r.innerHTML=i!==""?i:this._currencyFormat.replace(/#/g,e)}r=BX(this.getSetting("TOTAL_DISCOUNT_ID","total_discount"));if(r){i=BX.type.isNotEmptyString(t["TOTAL_DISCOUNT_FORMATTED"])?t["TOTAL_DISCOUNT_FORMATTED"]:"";e=typeof t["TOTAL_DISCOUNT"]!="undefined"?parseFloat(t["TOTAL_DISCOUNT"]).toFixed(2):"0.00";this._discountExists=parseFloat(e)!==0;r.innerHTML=i!==""?i:this._currencyFormat.replace(/#/g,e)}r=BX(this.getSetting("TOTAL_BEFORE_TAX_ID","total_before_tax"));if(r){i=BX.type.isNotEmptyString(t["TOTAL_BEFORE_TAX_FORMATTED"])?t["TOTAL_BEFORE_TAX_FORMATTED"]:"";e=typeof t["TOTAL_BEFORE_TAX"]!="undefined"?parseFloat(t["TOTAL_BEFORE_TAX"]).toFixed(2):"0.00";r.innerHTML=i!==""?i:this._currencyFormat.replace(/#/g,e)}r=BX(this.getSetting("taxValueID","total_tax"));if(r){i=BX.type.isNotEmptyString(t["TOTAL_TAX_FORMATTED"])?t["TOTAL_TAX_FORMATTED"]:"";e=typeof t["TOTAL_TAX"]!="undefined"?parseFloat(t["TOTAL_TAX"]).toFixed(2):"0.00";this._taxExists=parseFloat(e)!==0;r.innerHTML=i!==""?i:this._currencyFormat.replace(/#/g,e)}r=BX(this.getSetting("SUM_TOTAL_ID","sum_total"));if(r){i=BX.type.isNotEmptyString(t["TOTAL_SUM_FORMATTED"])?t["TOTAL_SUM_FORMATTED"]:"";e=typeof t["TOTAL_SUM"]!="undefined"?parseFloat(t["TOTAL_SUM"]).toFixed(2):"0.00";r.innerHTML=i!==""?i:this._currencyFormat.replace(/#/g,e);BX.onCustomEvent(this,"sumTotalChange",[e])}this.switchTotalElements()},refreshTaxList:function(t){var t=t;var e=this.getSetting("taxValueID","total_tax");if(e){var i=BX(e);i=i&&i.parentNode?i.parentNode:null;i=i&&i.parentNode?i.parentNode:null;if(i){var r;var n=i.parentNode;if(n){if(t&&typeof t==="object"&&t.length>0){while(r=BX.findNextSibling(i,{tag:"tr",class:"crm-tax-value"})){a=r.sibling;n.removeChild(r)}var a=i.nextSibling;i.style.display="none";var s,o,c=!this.getSetting("hideAllTaxes",false)&&(this.isLDTaxAllowed()||this.isTaxAllowed()&&this.isTaxEnabled())?"":"none";for(var l=0;l<t.length;l++){s=BX.create("TR",{attrs:{class:"crm-view-table-total-value crm-tax-value"},children:[BX.create("TD",{children:[BX.create("NOBR",{text:BX.util.htmlspecialchars(t[l]["TAX_NAME"]+":")})]}),BX.create("TD",{children:[o=BX.create("STRONG",{attrs:{class:"crm-view-table-total-value"},html:t[l]["TAX_VALUE"]})]})]});if(s){if(c!=="")s.style.display=c;if(l===0){n.removeChild(i);o.setAttribute("id",e)}if(a)n.insertBefore(s,a);else n.appendChild(s)}}}}}}},switchTotalElements:function(){if(BX(this.getSetting("productTotalContainerID",""))){if(this.products.length>0)BX(this.getSetting("productTotalContainerID","")).style.display="block";else BX(this.getSetting("productTotalContainerID","")).style.display="none"}var t=this._discountExists,e=this._taxExists,i="crm-tax-value",r,n,a,s=this.isDiscountEnabled()||t?"":"none",o=e||!this.getSetting("hideAllTaxes",false)&&(this.isLDTaxAllowed()||this.isTaxAllowed()&&this.isTaxEnabled())?"":"none";var c=[{id:"TOTAL_BEFORE_DISCOUNT_ID",type:"discount"},{id:"TOTAL_DISCOUNT_ID",type:"discount"},{id:"TOTAL_BEFORE_TAX_ID",type:"tax"},{id:"taxValueID",type:"tax"}];for(r=0;r<c.length;r++){n=BX(this.getSetting(c[r]["id"],""));if(BX.type.isElementNode(n)){n=n.parentNode.parentNode;if(BX.type.isElementNode(n)){switch(c[r]["type"]){case"discount":n.style.display=s;break;case"tax":n.style.display=o;if(c[r]["id"]==="taxValueID"){a=n;while(a){a.style.display=o;a=BX.findNextSibling(a,{class:i})}}break}}}}},_onCalculateTotalsRequestFailure:function(t){BX.Mobile.Crm.showErrorAlert(BX.message("CRM_INVALID_REQUEST_ERROR"))},isTaxAllowed:function(){return this.getSetting("allowTax",false)},isLDTaxAllowed:function(){return this.getSetting("allowLDTax",false)},isTaxEnabled:function(){return this.getSetting("enableTax",false)},isDiscountEnabled:function(){return this.getSetting("enableDiscount",false)},getTaxes:function(){return this.getSetting("taxes",[])},getClientTypeName:function(){return this._clientTypeName},getProductId:function(){return this.getSetting("PRODUCT_ID",0)},getProductName:function(){return this.getSetting("PRODUCT_NAME","")},getQuantity:function(){return this.getSetting("QUANTITY",0)},getMeasureCode:function(){return this.getSetting("MEASURE_CODE",0)},getMeasureName:function(){return this.getSetting("MEASURE_NAME","")},getPrice:function(){return this.getSetting("PRICE",0)},getExclusivePrice:function(){return this.getSetting("PRICE_EXCLUSIVE",0)},getPriceNetto:function(){return this.getSetting("PRICE_NETTO",0)},getPriceBrutto:function(){return this.getSetting("PRICE_BRUTTO",0)},getDiscountTypeId:function(){var t=parseInt(this.getSetting("DISCOUNT_TYPE_ID",BX.CrmDiscountType.percentage));if(t!==BX.CrmDiscountType.percentage&&t!==BX.CrmDiscountType.monetary){t=BX.CrmDiscountType.percentage}return t},getDiscountRate:function(){return this.getSetting("DISCOUNT_RATE",0)},getDiscountSum:function(){return this.getSetting("DISCOUNT_SUM",0)},getDiscountSubtotal:function(){return this.getSetting("DISCOUNT_SUBTOTAL",0)},getTaxRate:function(){return this.getSetting("TAX_RATE",0)},isTaxIncluded:function(){return this.getSetting("TAX_INCLUDED",false)},isCustomized:function(){return this.getSetting("CUSTOMIZED",false)},getSort:function(){return this.getSetting("SORT",0)},setSort:function(t){return this.setSetting("SORT",t)},setClientTypeName:function(t){if(this._clientTypeName===t){return}this._clientTypeName=t},getCurrencyId:function(){return this._currencyId},setCurrencyId:function(t){if(this._currencyId===t){return}this.calculateProductPrices(t)},setCurrencyFormat:function(t){if(typeof t!=="string"||t.length<=0)t="# ?";this._currencyFormat=t},getForm:function(){var t=this.getSetting("formID","");return BX.type.isNotEmptyString(t)?BX("form_"+t):null},getExchRateElement:function(){var t=this.getForm();return t?BX.findChild(t,{tag:"input",attr:{name:"EXCH_RATE"}},true,false):null},calculateProductPrices:function(t){var e=this._currencyId;this._currencyId=t;var i=this.getExchRateElement();var r=[];var n=this.isTaxAllowed();var a=this.isTaxIncluded();var s;for(var o=0;o<this.products.length;o++){this.products[o].PRICE=n&&!a?this.products[o].PRICE_NETTO:this.products[o].PRICE_BRUTTO}var c=this;BX.ajax({url:this.ajaxUrl,method:"POST",dataType:"json",data:{MODE:"CALC_PRODUCT_PRICES",OWNER_TYPE:this.getSetting("ownerType",""),OWNER_ID:this.getSetting("ownerID",0),DATA:{SRC_CURRENCY_ID:e,SRC_EXCH_RATE:i?parseFloat(i.value):0,DST_CURRENCY_ID:t,PRODUCTS:this.products},SITE_ID:this.getSetting("siteId","")},onsuccess:BX.proxy(function(t){if(typeof t!=="object")return;if(t["PRODUCTS"]){var e=this.isTaxAllowed();var i=this.isTaxIncluded();var r;this.setCurrencyFormat(t["CURRENCY_FORMAT"]?t["CURRENCY_FORMAT"]:"# ?");for(var n=0;n<t["PRODUCTS"].length;n++){var a=t["PRODUCTS"][n];var s=this.productsContainerNode.querySelector("[data-role='"+t["PRODUCTS"][n].DATA_ROLE+"']");if(!s)break;var o=s.querySelector("[data-role='productPrice']");if(o){var c=parseFloat(a.PRICE).toFixed(2);t["PRODUCTS"][n][e&&!i?"PRICE_NETTO":"PRICE_BRUTTO"]=c;t["PRODUCTS"][n]["PRICE_EXCLUSIVE"]=c;var l=e&&!i?a.PRICE_NETTO:a.PRICE_BRUTTO;var u=typeof l!="undefined"?parseFloat(l).toFixed(2):"0.00";o.innerHTML=this._currencyFormat.replace(/#/g,u);var T=s.querySelector("[data-role='sumWithQuantity']");if(T){var u=typeof(a.QUANTITY*l)!="undefined"?parseFloat(a.QUANTITY*l).toFixed(2):"0.00";var d=this._currencyFormat.replace(/#/g,u);T.innerHTML=d}}}this.products=t["PRODUCTS"];this.calculateTotals()}},this),onfailure:function(t){}})}};
//# sourceMappingURL=script.map.js