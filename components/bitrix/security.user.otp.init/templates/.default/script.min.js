BX.namespace("BX.Security.UserOtp.Init");BX.Security.UserOtp.Init=function t(e){"use strict";var o=function(t){var o={actionUrl:location.href,successfulUrl:"/",data:{secret:null,provisionUri:null},ui:{containerId:"user-otp-container",qrcode:{width:164,height:164,colorDark:"#000000",colorLight:"#ffffff"}}};t=t||{};this._options=r(o,t);this.signedParameters=this._options.signedParameters;this.componentName=this._options.componentName;this._secret=this._options.data.secret;this._container=e(this._options.ui.containerId);this._actionUrl=this._options.actionUrl;this._successfulUrl=this._options.successfulUrl;this.needRedirectAfterConnection=this._options.needRedirectAfterConnection==="Y";this._completeCallback=e.proxy(this.onComplete,this);this._errorContainer=null;this.initializeInterface(this._options.data)};o.prototype.initializeInterface=function(t){this.drawQrCode(this._container.querySelector('[data-role="qr-code-block"]'),t.provisionUri,this._options.ui.qrcode);var o=this._container.querySelectorAll('input[data-role="check-code"]');e.bind(document.querySelector('[data-role="check-button"]'),"click",e.proxy(function t(){this.onCheck(o[0],o[1]||null)},this));this._errorContainer=this._container.querySelector('[data-role="error-container"]')};o.prototype.onCheck=function(t,e){this.clearErrors();this.activate(t.value,e?e.value:null)};o.prototype.activate=function(t,e){var o={secret:this._secret,sync1:t,sync2:e};this.sendRequest("otp_check_activate",o,this._completeCallback)};o.prototype.drawQrCode=function(t,o,r){new QRCode(e(t),{text:o,width:r.width,height:r.height,colorDark:r.colorDark,colorLight:r.colorLight,correctLevel:QRCode.CorrectLevel.H})};o.prototype.sendRequest=function(t,o,r,i){e.addClass(document.querySelector('[data-role="check-button"]'),"wait");o=o||{};o.otpAction=t||"check";e.ajax.runComponentAction(this.componentName,"setOtp",{signedParameters:this.signedParameters,mode:"ajax",data:o}).then(function(t){return this.onRequestSuccess(r,t.data)}.bind(this),function(t){return this.onRequestFailed(i,t)}.bind(this))};o.prototype.onRequestSuccess=function(t,o){e.removeClass(document.querySelector('[data-role="check-button"]'),"wait");if(!o["status"]){this.onRequestFailed(null,o)}else if(o["status"]!=="ok"){this.onRequestFailed(null,o)}else{t(o)}};o.prototype.onRequestFailed=function(t,o){e.closeWait();if(!t){if(o["error"])this.showError(o["error"]);else this.showError(e.message("SECURITY_OTP_UNKNOWN_ERROR"))}else{t(o)}};o.prototype.showError=function(t){if(!this._errorContainer)return;var o=e.create("div",{children:[e.create("div",{text:e.message("SECURITY_OTP_ERROR_TITLE")}),e.create("div",{html:t})],attrs:{className:"bx-notice error"}});this._errorContainer.appendChild(o)};o.prototype.clearErrors=function(){if(!this._errorContainer)return;e.cleanNode(this._errorContainer)};o.prototype.onComplete=function(){e.onCustomEvent(window,"BX.Security.UserOtpInit:afterOtpSetup",[this]);if(this.needRedirectAfterConnection){location.href=this._successfulUrl}};function r(t,e){for(var o in e){if(!e.hasOwnProperty(o))continue;if(e[o]&&e[o].constructor===Object){if(t[o]&&t[o].constructor===Object){t[o]=r(t[o],e[o])}else{t[o]=i(e[o])}}else{t[o]=e[o]}}return t}function i(t){return JSON.parse(JSON.stringify(t))}return o}(BX);
//# sourceMappingURL=script.map.js