if(!BX.getClass("BX.Bizproc.Automation.Component"))(function(t){"use strict";t.namespace("BX.Bizproc.Automation");var e=function(e){if(!t.type.isDomNode(e))throw"baseNode must be Dom Node Element";this.node=e;g.getInstance().component=this;h.component=this;m.component=this};e.ViewMode={None:0,View:1,Edit:2,Manage:3};var i=function(e){e=e||"/bitrix/components/bitrix/bizproc.automation/ajax.php";return t.util.add_url_param(e,{site_id:t.message("SITE_ID"),sessid:t.bitrix_sessid()})};var n=function(e){var i;if(t.type.isArray(e)){var n,a;for(n=0;n<e.length;++n){a=e[n];if(a["Id"]==="ASSIGNED_BY_ID"||a["Id"]==="RESPONSIBLE_ID"){i="{{"+a["Name"]+"}}";break}}}return i};e.prototype={init:function(i,n){var a=this;this.viewMode=n||e.ViewMode.Edit;if(typeof i==="undefined")i={};this.data=i;this.initData();this.initTracker();this.initContext();this.initActionPanel();this.initSearch();this.initTriggerManager();this.initTemplateManager();this.initButtons();this.initButtonsPosition();this.initHelpTips();this.fixTitleColors();if(!this.embeddedMode){window.onbeforeunload=function(){if(a.templateManager.needSave()||a.triggerManager.needSave()){return t.message("BIZPROC_AUTOMATION_CMP_NEED_SAVE")}}}},initData:function(){this.document=new t.Bizproc.Document({rawDocumentType:this.data.DOCUMENT_TYPE,documentId:this.data.DOCUMENT_ID,categoryId:this.data.DOCUMENT_CATEGORY_ID,statusList:this.data.DOCUMENT_STATUS_LIST,documentFields:this.data.DOCUMENT_FIELDS,title:this.data["ENTITY_NAME"]});this.documentSigned=this.data.DOCUMENT_SIGNED;this.bizprocEditorUrl=this.data.WORKFLOW_EDIT_URL;this.constantsEditorUrl=this.data.CONSTANTS_EDIT_URL||null;this.parametersEditorUrl=this.data.PARAMETERS_EDIT_URL||null;this.setDocumentStatus(this.data.DOCUMENT_STATUS);var e={};if(t.type.isPlainObject(this.data.USER_OPTIONS)){e=this.data.USER_OPTIONS}this.userOptions=new t.Bizproc.UserOptions(e);this.frameMode=t.type.isBoolean(this.data.FRAME_MODE)?this.data.FRAME_MODE:false;this.embeddedMode=this.data.IS_EMBEDDED===true},initContext:function(){var e=new t.Bizproc.AutomationContext({document:this.document,signedDocument:this.documentSigned,ajaxUrl:this.getAjaxUrl(),availableRobots:t.type.isArray(this.data["AVAILABLE_ROBOTS"])?this.data["AVAILABLE_ROBOTS"]:[],availableTriggers:t.Type.isArray(this.data["AVAILABLE_TRIGGERS"])?this.data["AVAILABLE_TRIGGERS"]:[],canManage:this.data["IS_TEMPLATES_SCHEME_SUPPORTED"],canEdit:this.canEdit(),userOptions:this.userOptions,tracker:this.tracker,bizprocEditorUrl:this.bizprocEditorUrl,constantsEditorUrl:this.constantsEditorUrl,parametersEditorUrl:this.parametersEditorUrl,isFrameMode:this.isFrameMode,marketplaceRobotCategory:this.data["MARKETPLACE_ROBOT_CATEGORY"]});e.set("TRIGGER_CAN_SET_EXECUTE_BY",this.data["TRIGGER_CAN_SET_EXECUTE_BY"]);t.Bizproc.setGlobalContext(e)},setDocumentStatus:function(t){this.document.setStatus(t);return this},isPreviousStatus:function(t){var e=this.document.getPreviousStatusIdList();for(var i=0;i<e.length;++i){if(t===e[i]){return true}}return false},isCurrentStatus:function(t){return t===this.document.getCurrentStatusId()},isNextStatus:function(t){var e=this.document.getNextStatusIdList();for(var i=0;i<e.length;++i){if(t===e[i]){return true}}return false},initActionPanel:function(){var e=document.querySelector('[data-role="automation-actionpanel"]');if(!e){return}this.actionPanel=new t.UI.ActionPanel({renderTo:e,removeLeftPosition:true,maxHeight:58,parentPosition:"bottom",autoHide:false});this.actionPanel.draw();var i="/bitrix/components/bitrix/bizproc.automation/templates/.default/image/";this.actionPanel.appendItem({id:"automation_choose_all",text:t.message("BIZPROC_AUTOMATION_CMP_ACTIONPANEL_CHOOSE_ALL"),icon:i+"bizproc-automation--panel-icon-choose-all.svg",onclick:function(){var t=this.templateManager.targetManageModeStatus;var e=this.templateManager.getTemplateByStatusId(t);if(e){e.robots.forEach((function(t){t.selectNode()}))}}.bind(this)});this.actionPanel.appendItem({id:"automation_copy_to",text:t.message("BIZPROC_AUTOMATION_CMP_ACTIONPANEL_COPY"),icon:i+"bizproc-automation--panel-icon-copy.svg",onclick:this.onCopyMoveButtonClick.bind(this,"copy")});this.actionPanel.appendItem({id:"automation_move_to",text:t.message("BIZPROC_AUTOMATION_CMP_ACTIONPANEL_MOVE"),icon:i+"bizproc-automation--panel-icon-move.svg",onclick:this.onCopyMoveButtonClick.bind(this,"move")});this.actionPanel.appendItem({id:"automation_delete",text:t.message("BIZPROC_AUTOMATION_CMP_ACTIONPANEL_DELETE"),icon:i+"bizproc-automation--panel-icon-delete.svg",onclick:this.onDeleteButtonClick.bind(this)});t.addCustomEvent("BX.UI.ActionPanel:hidePanel",function(){if(this.templateManager.isManageModeEnabled()){this.disableManageMode()}}.bind(this))},onCopyMoveButtonClick:function(i){this.viewMode=e.ViewMode.Edit;var n=this.templateManager.targetManageModeStatus;var a=this.templateManager.getTemplateByStatusId(n);var o=a.getSelectedRobotNames();if(o.length===0){t.UI.Notification.Center.notify({content:t.message("BIZPOC_AUTOMATION_NO_ROBOT_SELECTED"),autoHideDelay:4e3});return}t.SidePanel.Instance.open("/bitrix/components/bitrix/bizproc.automation.scheme/index.php",{width:569,cacheable:false,requestMethod:"post",requestParams:{documentSigned:this.documentSigned,templateStatus:this.templateManager.targetManageModeStatus,action:i,selectedRobots:o},events:{onDestroy:function(e){var n=e.slider;if(n){var a=n.getData();var o=a.get("restoreData");var s=a.get("targetScope");var r=i==="copy"?a.get("copied"):a.get("moved");var l=a.get("denied");if(!t.type.isArray(r)||!t.type.isArray(l)){return}var c="BIZPROC_AUTOMATION_CMP_ROBOTS_"+(i==="copy"?"COPIED":"MOVED");var d=t.message(c);d=d.replace("#ACCEPTED_COUNT#",r.length);d=d.replace("#TOTAL_COUNT#",r.length+l.length);t.UI.Notification.Center.notify({content:d,actions:[{title:t.message("JS_CORE_WINDOW_CANCEL"),events:{click:function(e,i){e.preventDefault();if(t.type.isArray(o)){this.saveTemplates(o);i.close()}}.bind(this)}}]});var p=[];var u=this.templateManager.targetManageModeStatus;if(i==="move"){p.push(u)}if(s&&this.data.DOCUMENT_TYPE_SIGNED===s.documentType.Type&&this.templateManager.getTemplateByStatusId(s.status.Id)){p.push(s.status.Id)}this.templateManager.updateTemplates(p).onload=function(){var e=this.templateManager.getTemplateByStatusId(u);l.forEach(function(i){var n=e.getRobotById(i);if(n){t.Dom.addClass(n.node,"--denied");setTimeout(t.Dom.removeClass.bind(null,n.node,"--denied"),10*1e3)}}.bind(this))}.bind(this)}this.disableManageMode()}.bind(this)}})},onDeleteButtonClick:function(){this.viewMode=e.ViewMode.Edit;var i=this.templateManager.targetManageModeStatus;var n=this.templateManager.getTemplateByStatusId(i);if(!n){return}var a=this.templateManager.templatesData.findIndex((function(t){return t.ID===n.getId()}));var o=n.getSelectedRobotNames();if(o.length===0){t.UI.Notification.Center.notify({content:t.message("BIZPOC_AUTOMATION_NO_ROBOT_SELECTED"),autoHideDelay:4e3});return}t.ajax({method:"POST",dataType:"json",url:this.getAjaxUrl(),data:{ajax_action:"delete_robots",document_signed:this.documentSigned,selected_status:n.getStatusId(),robot_names:b.toJsonString(o)},onsuccess:function(e){var i=t.message("BIZPROC_AUTOMATION_CMP_ROBOTS_DELETED");i=i.replace("#TOTAL_COUNT#",o.length);if(e.SUCCESS){n.reInit(e.DATA.template,this.viewMode);this.templateManager.templatesData[a]=e.DATA.template;this.disableManageMode();i=i.replace("#ACCEPTED_COUNT#",o.length);var s=e.DATA.restoreData}else{i=i.replace("#ACCEPTED_COUNT#",0)}t.UI.Notification.Center.notify({content:i,actions:[{title:t.message("JS_CORE_WINDOW_CANCEL"),events:{click:function(e,i){e.preventDefault();if(t.type.isArray(s)){this.saveTemplates(s);i.close()}}.bind(this)}}]})}.bind(this)})},initTriggerManager:function(){this.triggerManager=new E(this.node);this.subscribeTriggerManagerEvents();this.triggerManager.init(this.data,t.Bizproc.ViewMode.fromRaw(this.viewMode));this.triggerManager.subscribe("TriggerManager:onHelpClick",function(t){this.onGlobalHelpClick.call(this,t.data)}.bind(this));t.Event.EventEmitter.subscribe(this,"BX.Bizproc.Automation.Component:onSearch",this.triggerManager.onSearch.bind(this.triggerManager))},subscribeTriggerManagerEvents:function(){const t=this;this.triggerManager.subscribe("TriggerManager:dataModified",(function(){t.markModified()}))},reInitTriggerManager:function(e){if(t.type.isArray(e)){this.data.TRIGGERS=e}this.triggerManager.reInit(this.data,t.Bizproc.ViewMode.fromRaw(this.viewMode))},initTemplateManager:function(){this.templateManager=new a(this);this.templateManager.init(this.data,this.viewMode)},reInitTemplateManager:function(e){if(t.type.isArray(e))this.data.TEMPLATES=e;this.templateManager.reInit(this.data,this.viewMode)},initButtons:function(){var t=this.node.querySelector('[data-role="automation-buttons"]');if(t){this.bindSaveButton();this.bindCancelButton()}this.bindCreationButton()},initButtonsPosition:function(){var e=this.node.querySelector('[data-role="automation-buttons"]');if(e){if(this.frameMode){t.addClass(e,"bizproc-automation-buttons-fixed-slider")}}},initSearch:function(){var e=this.node.querySelector('[data-role="automation-search"]');if(e){t.bind(e,"input",t.debounce(this.onSearch.bind(this,e),255));t.Event.EventEmitter.setMaxListeners(this,"BX.Bizproc.Automation.Component:onSearch",500);var i=this.node.querySelector('[data-role="automation-search-clear"]');if(i){t.bind(i,"click",this.onClearSearch.bind(this,e))}}},reInitSearch:function(){var t=this.node.querySelector('[data-role="automation-search"]');if(t){this.onSearch(t)}},onSearch:function(e){t.Event.EventEmitter.emit(this,"BX.Bizproc.Automation.Component:onSearch",{queryString:e.value.toLowerCase()})},onClearSearch:function(t){if(t.value!==""){t.value="";this.onSearch(t)}},initHelpTips:function(){t.UI.Hint.init(this.node)},reInitButtons:function(){var t=this.node.querySelector('[data-role="automation-btn-change-view"]');if(t){t.innerHTML=t.getAttribute("data-label-"+(this.viewMode===e.ViewMode.View?"edit":"view"))}},enableDragAndDrop:function(){this.templateManager.enableDragAndDrop();this.triggerManager.enableDragAndDrop()},disableDragAndDrop:function(){this.templateManager.disableDragAndDrop();this.triggerManager.disableDragAndDrop()},fixTitleColors:function(){var t,e,i=this.node.querySelectorAll('[data-role="automation-status-title"]');for(t=0;t<i.length;++t){e=i[t].getAttribute("data-bgcolor");if(e){var n=parseInt(e,16);var a=n>>16&255;var o=n>>8&255;var s=n&255;var r=.21*a+.72*o+.07*s;if(r<145){i[t].style.color="white"}}}},initTracker:function(){this.tracker=new I(this.document,this.getAjaxUrl());this.tracker.init(this.data.LOG)},bindSaveButton:function(){var e=this,i=t("ui-button-panel-save");if(i){t.bind(i,"click",(function(t){t.preventDefault();e.saveAutomation();i.classList.remove("ui-btn-wait")}))}},bindCancelButton:function(){var e=this,i=this.node.querySelector('[data-role="automation-btn-cancel"]');if(i){t.bind(i,"click",(function(t){t.preventDefault();e.reInitTriggerManager();e.reInitTemplateManager();e.reInitSearch();e.markModified(false)}))}},bindCreationButton:function(){var i=this,n=this.node.querySelector('[data-role="automation-btn-create"]');if(n){if(i.canEdit()){t.bind(n,"click",(function(a){a.preventDefault();if(i.viewMode===e.ViewMode.View){i.changeViewMode(e.ViewMode.Edit)}var o=[{text:t.message("BIZPROC_AUTOMATION_CMP_CREATE_ROBOT"),onclick:function(e){this.popupWindow.close();var n=t.clone(i.templateManager.getRobotDescription("SocNetMessageActivity"));if(n["ROBOT_SETTINGS"]&&n["ROBOT_SETTINGS"]["TITLE"]){n["NAME"]=n["ROBOT_SETTINGS"]["TITLE"]}var a=i.templateManager.templates[0];a.addRobot(n,(function(t){this.openRobotSettingsDialog(t)}))}}];if(t.type.isArray(i.data.AVAILABLE_TRIGGERS)&&i.data.AVAILABLE_TRIGGERS.length){o.push({text:t.message("BIZPROC_AUTOMATION_CMP_CREATE_TRIGGER"),onclick:function(t){this.popupWindow.close();i.triggerManager.addTrigger({DOCUMENT_STATUS:i.document.getSortedStatusId(0),CODE:i.data.AVAILABLE_TRIGGERS[0].CODE},(function(t){this.openTriggerSettingsDialog(t)}))}})}t.PopupMenu.show(t.Bizproc.Helper.generateUniqueId(),n,o,{autoHide:true,offsetLeft:t.pos(n)["width"]/2,angle:true})}))}}},getAjaxUrl:function(){return i(this.data.AJAX_URL)},getLimits:function(){var t=this.data["ROBOTS_LIMIT"];if(t<=0){return false}var e=this.triggerManager.countAllTriggers();var i=this.templateManager.countAllRobots();return e+i>t?[t,e,i]:false},saveAutomation:function(e){if(this.savingAutomation){return}var i=this.getLimits();if(i){if(top.BX.UI&&top.BX.UI.InfoHelper){top.BX.UI.InfoHelper.show("limit_crm_robots");return}t.UI.Dialogs.MessageBox.show({title:t.message("BIZPROC_AUTOMATION_ROBOTS_LIMIT_ALERT_TITLE"),message:t.message("BIZPROC_AUTOMATION_ROBOTS_LIMIT_SAVE_ALERT").replace("#LIMIT#",i[0]).replace("#SUM#",i[1]+i[2]).replace("#TRIGGERS#",i[1]).replace("#ROBOTS#",i[2]),modal:true,buttons:t.UI.Dialogs.MessageBoxButtons.OK,okCaption:t.message("BIZPROC_AUTOMATION_CLOSE_CAPTION")});return}var n=this,a={ajax_action:"save_automation",document_signed:this.documentSigned,triggers_json:b.toJsonString(this.triggerManager.serialize()),templates_json:b.toJsonString(this.templateManager.serializeModified())};this.savingAutomation=true;return t.ajax({method:"POST",dataType:"json",url:this.getAjaxUrl(),data:a,onsuccess:function(t){n.savingAutomation=null;t.DATA.templates.forEach((function(t){var e=n.data.TEMPLATES.findIndex((function(e){return e.ID===t.ID}));n.data.TEMPLATES[e]=t}));if(t.SUCCESS){n.reInitTriggerManager(t.DATA.triggers);n.reInitTemplateManager();n.reInitSearch();n.markModified(false);if(e){e(t.DATA)}}else{alert(t.ERRORS[0])}}})},saveTemplates:function(e){if(this.savingAutomation){return}var i={ajax_action:"save_automation",document_signed:this.documentSigned,templates_json:b.toJsonString(e)};this.savingAutomation=true;var n=this;return t.ajax({method:"POST",dataType:"json",url:this.getAjaxUrl(),data:i,onsuccess:function(t){n.savingAutomation=null;if(t.SUCCESS){e.forEach((function(t){var e=n.templateManager.getTemplateById(t.ID);if(e){e.reInit(t,n.viewMode)}}))}else{alert(t.ERRORS[0])}}})},changeViewMode:function(i,n){if(!n&&(this.templateManager.needSave()||this.triggerManager.needSave())){alert(t.message("BIZPROC_AUTOMATION_CMP_NEED_SAVE"));return}if(i!==e.ViewMode.View&&i!==e.ViewMode.Edit)throw"Unknown view mode";this.viewMode=i;this.reInitTriggerManager();this.reInitTemplateManager();this.reInitButtons()},enableManageMode:function(t){if(!this.templateManager.needSave()&&!this.triggerManager.needSave()){this.viewMode=e.ViewMode.Manage;this.templateManager.enableManageMode(t);this.triggerManager.enableManageMode()}},disableManageMode:function(){this.viewMode=e.ViewMode.Edit;this.templateManager.disableManageMode();this.triggerManager.disableManageMode()},markModified:function(i){i=i!==false;var n=this.node.querySelector('[data-role="automation-buttons"]');if(!n){return}if(i&&this.canEdit()&&this.viewMode===e.ViewMode.Edit){t.show(n)}else{t.hide(n)}},canEdit:function(){return this.data["CAN_EDIT"]},updateTracker:function(){this.tracker.update(this.documentSigned).onload=function(){if(this.viewMode===e.ViewMode.View){this.templateManager.reInit()}}.bind(this)},onGlobalHelpClick:function(t){t.preventDefault();const e=t.target.closest('[name="bizproc_automation_robot_dialog"]')?"#after":"";if(top.BX.Helper){top.BX.Helper.show("redirect=detail&code=14889274"+e)}},getUserOption:function(t,e,i){return this.userOptions.get(t,e,i)},setUserOption:function(t,e,i){this.userOptions.set(t,e,i);return this},getConstants:function(){if(!this.data["GLOBAL_CONSTANTS"]){return[]}var e=[];var i=this.data["G_CONSTANTS_VISIBILITY"];Object.keys(this.data["GLOBAL_CONSTANTS"]).forEach((function(n){var a=t.clone(this.data["GLOBAL_CONSTANTS"][n]);a.Id=n;a.ObjectId="GlobalConst";a.SystemExpression="{=GlobalConst:"+n+"}";a.Expression="{=GlobalConst:"+n+"}";var o=String(a.Visibility).toUpperCase();var s=i[o];if(s){a.Expression="{{"+s+": "+a.Name+"}}";a.supertitle=s}e.push(a)}),this);return e},getConstant:function(t){var e=this.getConstants();for(var i=0;i<e.length;++i){if(e[i].Id===t){return e[i]}}return null},getGVariables:function(){if(!this.data["GLOBAL_VARIABLES"]){return[]}var e=[];var i=this.data["G_VARIABLES_VISIBILITY"];t.util.object_keys(this.data["GLOBAL_VARIABLES"]).forEach((function(n){var a=t.clone(this.data["GLOBAL_VARIABLES"][n]);a.Id=n;a.ObjectId="GlobalVar";a.SystemExpression="{=GlobalVar:"+n+"}";a.Expression="{=GlobalVar:"+n+"}";var o=String(a.Visibility).toUpperCase();var s=i[o];if(s){a.Expression="{{"+s+": "+a.Name+"}}";a.supertitle=s}e.push(a)}),this);return e},getGVariable:function(t){var e=this.getGVariables();for(var i=0;i<e.length;i++){if(e[i].Id===t){return e[i]}}return null},getDocumentFields:function(){return this.document.getFields()}};var a=function(t){this.component=t};a.prototype={init:function(i,n){if(!t.type.isPlainObject(i))i={};this.viewMode=n||e.ViewMode.Edit;this.availableRobots=t.type.isArray(i.AVAILABLE_ROBOTS)?i.AVAILABLE_ROBOTS:[];this.templatesData=t.type.isArray(i.TEMPLATES)?i.TEMPLATES:[];this.initTemplates()},reInit:function(i,n){if(!t.type.isPlainObject(i))i={};this.viewMode=n||e.ViewMode.Edit;if(t.type.isArray(i.TEMPLATES)){this.templatesData=i.TEMPLATES}if(this.viewMode!==e.ViewMode.Edit){this.targetManageModeStatus=""}this.reInitTemplates(this.templatesData);if(this.isManageModeEnabled()){this.enableManageMode(this.targetManageModeStatus)}else{this.disableManageMode()}},isManageModeSupported:function(){return this.component.data.IS_TEMPLATES_SCHEME_SUPPORTED},isManageModeEnabled:function(){return t.type.isString(this.targetManageModeStatus)&&this.targetManageModeStatus!==""},enableManageMode:function(t){this.viewMode=e.ViewMode.Manage;this.targetManageModeStatus=t;this.templates.forEach(function(e){if(e.getStatusId()===t){e.enableManageMode(true)}else{e.enableManageMode(false)}}.bind(this));this.component.disableDragAndDrop();this.component.actionPanel.showPanel()},disableManageMode:function(){this.viewMode=e.ViewMode.Edit;this.targetManageModeStatus="";this.component.actionPanel.hidePanel();this.templates.forEach((function(t){t.disableManageMode()}));this.component.enableDragAndDrop()},enableDragAndDrop:function(){this.templates.forEach((function(t){t.enableDragAndDrop()}))},disableDragAndDrop:function(){this.templates.forEach((function(t){t.disableDragAndDrop()}))},initTemplates:function(){this.templates=[];this.templatesMap={};for(var t=0;t<this.templatesData.length;++t){var e=this.createTemplate(this.templatesData[t]);this.templates.push(e);this.templatesMap[e.getStatusId()]=e}},createTemplate:function(e){var i=new t.Bizproc.Template({constants:{},globalConstants:this.component.getConstants(),variables:{},globalVariables:this.component.getGVariables(),templateContainerNode:this.component.node,selectors:{userSelector:l,fileSelector:o,inlineSelector:s,inlineSelectorHtml:c,timeSelector:d,saveStateCheckbox:p},delayMinLimitM:this.component.data["DELAY_MIN_LIMIT_M"],userOptions:this.component.userOptions});i.init(e,this.viewMode);t.Event.EventEmitter.subscribe(this.component,"BX.Bizproc.Automation.Component:onSearch",i.onSearch.bind(i));this.subscribeTemplateEvents(i);this.subscribeRobotEvents(i);return i},subscribeTemplateEvents:function(t){this.getTemplateEventListeners(t).forEach((function(e){t.subscribe(e.eventName,e.listener)}))},subscribeRobotEvents:function(t){this.getRobotEventListeners(t).forEach((function(e){t.subscribeRobotEvents(e.eventName,e.listener)}))},getTemplateEventListeners:function(i){return[{eventName:"Template:help:show",listener:function(t){this.component.onGlobalHelpClick(t.data)}.bind(this)},{eventName:"Template:robot:showSettings",listener:function(){t.Dom.addClass(this.component.node,"automation-base-blocked")}.bind(this)},{eventName:"Template:robot:closeSettings",listener:function(){t.Dom.removeClass(this.component.node,"automation-base-blocked")}.bind(this)},{eventName:"Template:robot:add",listener:function(t){var e=t.getData().robot;this.getRobotEventListeners(i).forEach((function(t){e.subscribe(t.eventName,t.listener)}))}.bind(this)},{eventName:"Template:modified",listener:function(){this.component.markModified()}.bind(this)},{eventName:"Template:enableManageMode",listener:function(t){if(this.viewMode===e.ViewMode.Edit){this.component.enableManageMode(t.getData().documentStatus)}}.bind(this)}]},getRobotEventListeners:function(e){return[{eventName:"Robot:selected",listener:function(){this.component.actionPanel.setTotalSelectedItems(e.getSelectedRobotNames().length)}.bind(this)},{eventName:"Robot:unselected",listener:function(){this.component.actionPanel.setTotalSelectedItems(e.getSelectedRobotNames().length)}.bind(this)},{eventName:"Robot:title:editStart",listener:function(){t.addClass(this.component.node,"automation-base-blocked")}.bind(this)},{eventName:"Robot:title:editCompleted",listener:function(){t.removeClass(this.component.node,"automation-base-blocked")}.bind(this)},{eventName:"Robot:manage",listener:function(i){var n=this.getTemplateByColumnNode(i.getData().templateNode);var a=i.getData().droppableItem;var o=i.getData().robot;var s=undefined;if(!t.Type.isNil(a)){s=n.getRobotById(a.getAttribute("data-id"))}if(e){if(i.getData().isCopy){A.copyRobotTo(n,o,s)}else if(o!==s){o.moveTo(n,s)}}}.bind(this)}]},reInitTemplates:function(t){for(var e=0;e<this.templates.length;++e){if(t[e]){this.templates[e].reInit(t[e],this.viewMode);this.subscribeRobotEvents(this.templates[e])}}},updateTemplates:function(e){return t.ajax({method:"POST",dataType:"json",url:this.component.getAjaxUrl(),data:{ajax_action:"update_templates",document_signed:this.component.documentSigned,statuses:e},onsuccess:function(t){if(t.SUCCESS){var e=t.DATA.templates;for(var i in e){if(e.hasOwnProperty(i)){var n=this.getTemplateByStatusId(i);var a=this.templatesData.findIndex((function(t){return t.ID===n.getId()}));n.reInit(e[i],this.viewMode);this.templatesData[a]=e[i]}}}}.bind(this)})},getAvailableRobots:function(){return this.availableRobots},getRobotDescription:function(t){return this.availableRobots.find((function(e){return e["CLASS"]===t}))},serialize:function(){var t=[];for(var e=0;e<this.templates.length;++e){t.push(this.templates[e].serialize())}return t},serializeModified:function(){var t=[];this.templates.forEach((function(e){if(e.isModified()){t.push(e.serialize())}}));return t},countAllRobots:function(){var t=0;this.templates.forEach((function(e){t+=e.robots.length}));return t},getTemplateByColumnNode:function(t){var e=t.getAttribute("data-status-id");return this.getTemplateByStatusId(e)},getTemplateById:function(t){return this.templates.find((function(e){return e.getId()===t}))},getTemplateByStatusId:function(t){return this.templatesMap[t]||null},canEdit:function(){return this.component&&this.component.canEdit()},needSave:function(){var t=false;for(var e=0;e<this.templates.length;++e){if(this.templates[e].isModified()){t=true;break}}return t},updateGVariables:function(){this.templates.forEach((t=>{t.setGlobalVariables(this.component.getGVariables())}))},updateGConstants:function(){this.templates.forEach((t=>{t.setGlobalConstants(this.component.getConstants())}))}};var o=function(e,i){var n,a=i.getAttribute("data-config");if(a){n=t.parseJSON(a)}if(!t.type.isPlainObject(n))n={};this.container=i;this.type=n.type||o.Type.File;if(n.selected&&!n.selected.length){this.type=o.Type.None}this.multiple=n.multiple||false;this.required=n.required||false;this.valueInputName=n.valueInputName||"";this.typeInputName=n.typeInputName||"";this.useDisk=n.useDisk||false;this.label=n.label||"Attachment";this.labelFile=n.labelFile||"File";this.labelDisk=n.labelDisk||"Disk";var s=e.template?e.template.robots:[];this.setFileFields(e.getDocument().getFields(),s);this.createDom();if(n.selected&&n.selected.length>0){this.addItems(t.clone(n.selected))}};o.Type={None:"",Disk:"disk",File:"file"};o.prototype={setFileFields:function(e,i){var n=[];var a={};for(var o=0;o<e.length;++o){if(e[o]["Type"]==="file"){n.push(e[o])}}if(t.type.isArray(i)){i.forEach((function(t){t.getReturnFieldsDescription().forEach((function(e){if(e["Type"]==="file"){var i="{{~"+t.getId()+":"+e["Id"]+"}}";n.push({Id:i,Name:t.getTitle()+": "+e["Name"],Type:"file",Expression:i});a[i]=t.getTitle()+": "+e["Name"]}}))}))}this.fileFields=n;this.fileLabels=a;return this},createDom:function(){this.container.appendChild(this.createBaseNode());this.showTypeControllerLayout(this.type)},createBaseNode:function(){var e=t.Bizproc.Helper.generateUniqueId();var i=null;if(this.fileFields.length>0){i=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",type:"radio",id:"type-1"+e,name:this.typeInputName,value:o.Type.File}});if(this.type===o.Type.File){i.setAttribute("checked","checked")}}var n=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",type:"radio",id:"type-2"+e,name:this.typeInputName,value:o.Type.Disk}});if(this.type===o.Type.Disk){n.setAttribute("checked","checked")}var a=[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:this.label+":"})];if(i){a.push(i,t.create("label",{attrs:{className:"bizproc-automation-popup-settings-link",for:"type-1"+e},text:this.labelFile,events:{click:this.onTypeChange.bind(this,o.Type.File)}}))}a.push(n,t.create("label",{attrs:{className:"bizproc-automation-popup-settings-link",for:"type-2"+e},text:this.labelDisk,events:{click:this.onTypeChange.bind(this,o.Type.Disk)}}));return t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("div",{attrs:{className:"bizproc-automation-popup-settings-block"},children:a})]})},showTypeControllerLayout:function(t){if(t===o.Type.Disk){this.hideFileControllerLayout();this.showDiskControllerLayout()}else if(t===o.Type.File){this.hideDiskControllerLayout();this.showFileControllerLayout()}else{this.hideFileControllerLayout();this.hideDiskControllerLayout()}},showDiskControllerLayout:function(){if(!this.diskControllerNode){this.diskControllerNode=t.create("div");this.container.appendChild(this.diskControllerNode);var e=this.getDiskUploader();e.layout(this.diskControllerNode);e.show(true)}else{t.show(this.diskControllerNode)}},hideDiskControllerLayout:function(){if(this.diskControllerNode){t.hide(this.diskControllerNode)}},showFileControllerLayout:function(){if(!this.fileControllerNode){this.fileItemsNode=t.create("span");this.fileControllerNode=t.create("div",{children:[this.fileItemsNode]});this.container.appendChild(this.fileControllerNode);var e=t.create("a",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-popup-settings-link-thin"},text:t.message("BIZPROC_AUTOMATION_CMP_ADD")});this.fileControllerNode.appendChild(e);t.bind(e,"click",this.onFileFieldAddClick.bind(this,e))}else{t.show(this.fileControllerNode)}},hideFileControllerLayout:function(){if(this.fileControllerNode){t.hide(this.fileControllerNode)}},getDiskUploader:function(){if(!this.diskUploader){this.diskUploader=t.Bizproc.Automation.DiskUploader.create("",{msg:{diskAttachFiles:t.message("BIZPROC_AUTOMATION_CMP_DISK_ATTACH_FILE"),diskAttachedFiles:t.message("BIZPROC_AUTOMATION_CMP_DISK_ATTACHED_FILES"),diskSelectFile:t.message("BIZPROC_AUTOMATION_CMP_DISK_SELECT_FILE"),diskSelectFileLegend:t.message("BIZPROC_AUTOMATION_CMP_DISK_SELECT_FILE_LEGEND"),diskUploadFile:t.message("BIZPROC_AUTOMATION_CMP_DISK_UPLOAD_FILE"),diskUploadFileLegend:t.message("BIZPROC_AUTOMATION_CMP_DISK_UPLOAD_FILE_LEGEND")}});this.diskUploader.setMode(1)}return this.diskUploader},onTypeChange:function(t){if(this.type!==t){this.type=t;this.showTypeControllerLayout(this.type)}},isFileItemSelected:function(t){var e=this.fileItemsNode.querySelector('[data-file-id="'+t.id+'"]');return!!e},addFileItem:function(e){if(this.isFileItemSelected(e)){return false}var i=this.createFileItemNode(e);if(!this.multiple){t.cleanNode(this.fileItemsNode)}this.fileItemsNode.appendChild(i)},addItems:function(t){if(this.type===o.Type.File){for(var e=0;e<t.length;++e){this.addFileItem(t[e])}}else{this.getDiskUploader().setValues(this.convertToDiskItems(t))}},convertToDiskItems:function(t){var e=[];for(var i=0;i<t.length;++i){var n=t[i];e.push({ID:n["id"],NAME:n["name"],SIZE:n["size"],VIEW_URL:""})}return e},removeFileItem:function(t){var e=this.fileItemsNode.querySelector('[data-file-id="'+t.id+'"]');if(e){this.fileItemsNode.removeChild(e)}},onFileFieldAddClick:function(e,i){var n=this,a,o=[];var s=this.fileFields;for(a=0;a<s.length;++a){o.push({text:t.util.htmlspecialchars(s[a]["Name"]),field:s[a],onclick:function(t,e){this.popupWindow.close();n.onFieldSelect(e.field)}})}if(!this.menuId){this.menuId=t.Bizproc.Helper.generateUniqueId()}t.PopupMenu.show(this.menuId,e,o,{autoHide:true,offsetLeft:t.pos(e)["width"]/2,angle:{position:"top",offset:0}});this.menu=t.PopupMenu.currentItem;i.preventDefault()},onFieldSelect:function(t){this.addFileItem({id:t.Id,expression:t.Expression,name:t.Name,type:o.Type.File})},destroy:function(){if(this.menu){this.menu.popupWindow.close()}},createFileItemNode:function(e){var i=e.name||"";if(this.fileLabels[i]){i=this.fileLabels[i]}return t.create("span",{attrs:{className:"bizproc-automation-popup-autocomplete-item","data-file-id":e.id,"data-file-expression":e.expression},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-autocomplete-name"},text:i}),t.create("span",{attrs:{className:"bizproc-automation-popup-autocomplete-delete"},events:{click:this.removeFileItem.bind(this,e)}})]})},onBeforeSave:function(){var e=[];if(this.type===o.Type.Disk){e=this.getDiskUploader().getValues()}else if(this.type===o.Type.File){this.fileItemsNode.childNodes.forEach((function(t){var i=t.getAttribute("data-file-expression");if(i!==""){e.push(i)}}))}for(var i=0;i<e.length;++i){this.container.appendChild(t.create("input",{props:{type:"hidden",name:this.valueInputName+(this.multiple?"[]":""),value:e[i]}}))}}};var s=function(e,i,n){var a=this;this.robot=e;this.component=g.getInstance().component;this.documentFields=this.component?this.component.document.getFields():n["DOCUMENT_FIELDS"];this.showTemplatePropertiesMenuOnSelecting=this.component?this.component.data["SHOW_TEMPLATE_PROPERTIES_MENU_ON_SELECTING"]===true:false;this.targetInput=t.clone(i);this.menuButton=t.create("span",{attrs:{className:"bizproc-automation-popup-select-dotted"},events:{click:t.delegate(a.openMenu,this)}});this.appendPropertyMods=true;var o=t.create("div",{attrs:{className:"bizproc-automation-popup-select"},children:[this.targetInput,this.menuButton]});i.parentNode.replaceChild(o,i);t.bind(this.targetInput,"keydown",(function(t){a.onKeyDown(this,t)}));this.targetInput.setAttribute("autocomplete","off");this.fieldProperty=JSON.parse(this.targetInput.getAttribute("data-property"));if(this.fieldProperty){delete this.fieldProperty.Default}if(!this.fieldProperty||!this.robot){this.showTemplatePropertiesMenuOnSelecting=false}this.fieldType=this.targetInput.getAttribute("data-selector-type");if(this.fieldType==="date"||this.fieldType==="datetime"){this.initDateTimeControl()}else if(this.fieldType==="file"){this.initFileControl()}if(this.targetInput.getAttribute("data-select-mode")==="replace"){this.replaceOnWrite=true}this.selectCallback=function(t){a.onFieldSelect(t.getCustomData().get("property"))}};s.prototype={onKeyDown:function(t,e){if(e.keyCode==45&&e.altKey===false&&e.ctrlKey===false&&e.shiftKey===false){this.openMenu(e);e.preventDefault()}},openMenu:function(e,i){if(!i&&this.showTemplatePropertiesMenuOnSelecting&&!this.targetInput.value){return this.openPropertiesSwitcherMenu()}if(this.dialog){this.dialog.show();return}var n=this,a,o,s=this.getFields();var r=t.Bizproc.tryGetGlobalContext();var l=[],c=[],d={ROOT:{title:r&&r.document.title?r.document.title:u.documentName,entityId:"bp",tabs:"recents",id:"ROOT",children:[]}};for(a=0;a<s.length;++a){o=s[a];var p,h=o["Id"].indexOf(".")<0?"ROOT":o["Id"].split(".")[0];var m=o["Name"];var f="";if(m&&h!=="ROOT"&&m.indexOf(": ")>=0){p=m.split(": ");f=p.shift();m=p.join(": ")}if(o["Id"].indexOf("ASSIGNED_BY_")===0&&o["Id"]!=="ASSIGNED_BY_ID"&&o["Id"]!=="ASSIGNED_BY_PRINTABLE"){h="ASSIGNED_BY";p=m.split(" ");f=p.shift();m=p.join(" ").replace("(","").replace(")","")}if(!d[h]){d[h]={title:f,entityId:"bp",tabs:"recents",tabId:"bp",id:f,children:[]}}if(o["Type"]==="file"){c.push(o)}d[h]["children"].push({title:m||o["Id"],customData:{property:o},entityId:"bp",tabs:"recents",id:o["SystemExpression"]})}if(!this.fieldsOnly){if(this.robot){var g=this.robot.getId();var T=[];var I=this.robot.template;var b=I?I.robots:[];b.forEach((function(t){if(t.getId()!==g){var e=[];t.getReturnFieldsDescription().forEach((function(t){if(t["Type"]==="file"){c.push(t)}e.push({title:t["Name"]||t["Id"],customData:{property:t},entityId:"bp",tabs:"recents",id:t["SystemExpression"]})}));if(e.length){T.push({title:t.getTitle(),entityId:"bp",tabs:"recents",id:t.getId(),children:e})}}}));if(T.length){d["__RESULT"]={title:t.message("BIZPROC_AUTOMATION_CMP_ROBOT_LIST"),entityId:"bp",tabs:"recents",id:"__RESULT",children:T}}}var v=this.getTriggerProperties().map((function(t){return{title:t["Name"]||t["Id"],subtitle:t["ObjectName"]||t["ObjectId"],customData:{property:t},entityId:"bp",tabs:"recents",id:t["SystemExpression"]}}));if(v.length){d["__TRESULT"]={title:t.message("BIZPROC_AUTOMATION_CMP_TRIGGER_LIST"),entityId:"bp",tabs:"recents",id:"__TRESULT",children:v}}if(c.length&&this.appendPropertyMods){d["__FILES"]={title:t.message("BIZPROC_AUTOMATION_CMP_FILES_LINKS"),entityId:"bp",tabs:"recents",id:"__FILES",children:this.prepareFilesMenu(c)}}var S=[];if(I&&!this.showTemplatePropertiesMenuOnSelecting){I.getConstants().forEach((function(e){S.push({title:e["Name"],customData:{property:e},entityId:"bp",tabs:"recents",id:e.SystemExpression,supertitle:t.message("BIZPROC_AUTOMATION_CMP_TEMPLATE_CONSTANTS_LIST")})}))}if(this.component&&this.component.data["GLOBAL_CONSTANTS"]){this.component.getConstants().forEach((function(t){S.push({title:t["Name"],customData:{property:t},entityId:"bp",tabs:"recents",id:t.SystemExpression,supertitle:t.supertitle})}),this)}if(S.length){d["__CONSTANTS"]={title:t.message("BIZPROC_AUTOMATION_CMP_CONSTANTS_LIST"),entityId:"bp",tabs:"recents",id:"__CONSTANTS",children:S}}if(this.component&&this.component.data["GLOBAL_VARIABLES"]){var E=[];this.component.getGVariables().forEach((function(t){E.push({title:t["Name"],customData:{property:t},entityId:"bp",tabs:"recents",id:t.SystemExpression,supertitle:t.supertitle})}),this);if(E.length>0){d["__GLOB_VARIABLES"]={title:t.message("BIZPROC_AUTOMATION_CMP_GLOB_VARIABLES_LIST_1"),entityId:"bp",tabs:"recents",id:"__GLOB_VARIABLES",children:E}}}}if(Object.keys(d).length<2){if(d["ROOT"]["children"].length>0){l=d["ROOT"]["children"]}}else{if(d["ROOT"]["children"].length>0){l.push(d["ROOT"])}delete d["ROOT"];for(h in d){if(d.hasOwnProperty(h)&&d[h]["children"].length>0){l.push(d[h])}}}var M=this.menuButton.getAttribute("data-selector-id");if(!M){M=t.Bizproc.Helper.generateUniqueId();this.menuButton.setAttribute("data-selector-id",M)}this.dialog=new t.UI.EntitySelector.Dialog({targetNode:this.menuButton,width:500,height:300,multiple:false,dropdownMode:true,enableSearch:true,items:this.injectDialogMenuTitles(l),showAvatars:false,events:{"Item:onBeforeSelect":function(t){t.preventDefault();n.selectCallback(t.getData().item)}},compactView:true});this.dialog.show()},openPropertiesSwitcherMenu:function(){var e=this;t.PopupMenu.show(t.Bizproc.Helper.generateUniqueId(),this.menuButton,[{text:t.message("BIZPROC_AUTOMATION_ASK_CONSTANT"),onclick:function(t){this.popupWindow.close();e.onFieldSelect(e.robot.template.addConstant(e.fieldProperty))}},{text:t.message("BIZPROC_AUTOMATION_ASK_PARAMETER"),onclick:function(t){this.popupWindow.close();e.onFieldSelect(e.robot.template.addParameter(e.fieldProperty))}},{text:t.message("BIZPROC_AUTOMATION_ASK_MANUAL"),onclick:function(t){this.popupWindow.close();e.openMenu(t,true)}}],{autoHide:true,offsetLeft:20,angle:{position:"top"},events:{onPopupClose:function(){this.destroy()}}});this.switcherDialog=t.PopupMenu.currentItem;return true},injectDialogMenuTitles:function(e){e.forEach((function(e){if(t.type.isArray(e.children)){e.searchable=false;this.injectDialogMenuSupertitles(e.title,e.children)}}),this);return e},injectDialogMenuSupertitles:function(e,i){i.forEach((function(i){if(!i.supertitle){i.supertitle=e}if(t.type.isArray(i.children)){i.searchable=false;this.injectDialogMenuSupertitles(i.title,i.children)}}),this)},prepareFilesMenu:function(t){var e=[];t.forEach((function(t){var i=t["ObjectId"]==="Document"?"{{"+t["Name"]+" > shortlink}}":"{{~"+t["ObjectId"]+":"+t["Id"]+" > shortlink}}";var n=t["Name"]||t["Id"];if(t.ObjectName){n=t.ObjectName+": "+n}e.push({title:n,customData:{property:{Id:t["Id"]+"_shortlink",ObjectId:t["ObjectId"],Name:t["Name"],Type:"string",Expression:i,SystemExpression:"{="+t["ObjectId"]+":"+t["Id"]+" > shortlink}"}},entityId:"bp",tabs:"recents",id:i})}));return e},onFieldSelect:function(e){if(!e){return}var i=this.targetInput.tagName.toLowerCase();if(i==="select"){var n=this.targetInput.querySelector('[data-role="expression"]');if(!n){n=this.targetInput.appendChild(t.create("option",{attrs:{"data-role":"expression"}}))}n.setAttribute("value",e["Expression"]);n.textContent=e["Expression"];n.selected=true}else if(i==="label"){this.targetInput.textContent=e["Expression"];var a=document.getElementById(this.targetInput.getAttribute("for"));if(a){a.value=e["Expression"]}}else{if(this.replaceOnWrite){this.targetInput.value=e["Expression"];this.targetInput.selectionEnd=this.targetInput.value.length}else{var o=this.targetInput.value.substr(0,this.targetInput.selectionEnd),s=e["Expression"],r=this.targetInput.value.substr(this.targetInput.selectionEnd);this.targetInput.value=o+s+r;this.targetInput.selectionEnd=o.length+s.length}}t.fireEvent(this.targetInput,"change")},destroy:function(){if(this.dialog){this.dialog.destroy()}if(this.switcherDialog){this.switcherDialog.destroy()}},initDateTimeControl:function(){var e=[];var i=this.documentFields;if(t.type.isArray(this.documentFields)){var a,o;for(a=0;a<this.documentFields.length;++a){o=this.documentFields[a];if(o["Type"]==="date"||o["Type"]==="datetime"){e.push(o)}}}this.documentFields=e;this.replaceOnWrite=true;var s=new t.Bizproc.DelayIntervalSelector({labelNode:this.targetInput,basisFields:e,useAfterBasis:true,onchange:function(t){this.targetInput.value=t.toExpression(e,n(i))}.bind(this)});s.init(t.Bizproc.DelayInterval.fromString(this.targetInput.value,e))},initFileControl:function(){var t=this.component.document.getFields();var e=[];var i,n;for(i=0;i<t.length;++i){n=t[i];if(n["Type"]==="file"){e.push(n)}}this.documentFields=e;this.replaceOnWrite=true},getFields:function(){var e=t.message("BIZPROC_AUTOMATION_CMP_MOD_PRINTABLE_PREFIX");var i=[];this.documentFields.forEach((function(t){i.push(t["Name"])}));var n=i.join("\n");var a=[];var o=this.fieldType;this.documentFields.forEach((function(i){i.ObjectId="Document";var o=i["BaseType"]==="string"&&i["Type"]!=="string";if(!o||!this.appendPropertyMods){a.push(i)}if(!this.appendPropertyMods){return}if(i["Type"]==="user"||i["Type"]==="bool"||i["Type"]==="file"||o){var s=i["Name"]+" "+e;if(n.indexOf(s)<0){var r=t.clone(i);var l=i["Type"]==="user"?"friendly":"printable";r["Name"]=s;r["Type"]="string";r["SystemExpression"]="{=Document:"+r["Id"]+" > "+l+"}";r["Expression"]="{{"+i["Name"]+" > "+l+"}}";a.push(r)}}if(i["BaseType"]==="date"||i["BaseType"]==="datetime"){var c=t.clone(i);c["Name"]+=" "+t.message("BIZPROC_AUTOMATION_CMP_MOD_DATE_BY_SERVER");c["Type"]="string";c["SystemExpression"]="{=Document:"+c["Id"]+" > server}";c["Expression"]="{{"+i["Name"]+" > server}}";a.push(c);var d=t.clone(i);d["Name"]+=" "+t.message("BIZPROC_AUTOMATION_CMP_MOD_DATE_BY_RESPONSIBLE");d["Type"]="string";d["SystemExpression"]="{=Document:"+c["Id"]+" > responsible}";d["Expression"]="{{"+i["Name"]+" > responsible}}";a.push(d)}}),this);return a},getTriggerProperties:function(){var t=[];if(this.robot&&this.robot.template&&this.component&&this.component.triggerManager){t=this.component.triggerManager.getReturnProperties(this.robot.template.getStatusId())}return t}};var r=function(e,i,n,a){this.component=t.Bizproc.Automation.Designer.component;this.robot=t.Bizproc.Automation.Designer.robot;this.documentFields=i;this.menuButton=e;this.appendPropertyMods=false;this.selectCallback=function(t){n(t.getCustomData().get("property"))};this.fieldsOnly=!(a&&a.parentGroup&&a.parentGroup.type===f.CONDITION_TYPE.Mixed)};t.extend(r,s);var l=function(e,i,n){this.robot=e;this.component=g.getInstance().component;this.documentFields=this.component?this.component.document.getFields():n["DOCUMENT_FIELDS"];this.showTemplatePropertiesMenuOnSelecting=this.component?this.component.data["SHOW_TEMPLATE_PROPERTIES_MENU_ON_SELECTING"]===true:false;this.fieldProperty=JSON.parse(i.getAttribute("data-property"));if(this.fieldProperty){delete this.fieldProperty.Default}if(!this.fieldProperty||!this.robot){this.showTemplatePropertiesMenuOnSelecting=false}this.targetInput=this.menuButton=i;this.userSelector=t.Bizproc.UserSelector.decorateNode(i,this.getSelectorConfig(e))};t.extend(l,s);l.prototype.destroy=function(){if(this.userSelector){this.userSelector.destroy();this.userSelector=null}if(this.switcherDialog){this.switcherDialog.destroy()}};l.prototype.getSelectorConfig=function(e){var i=e.template?e.template.robots:[];var n=[];if(t.type.isArray(i)){i.forEach((function(t){t.getReturnFieldsDescription().forEach((function(e){if(e["Type"]==="user"){n.push({id:"{{~"+t.getId()+":"+e["Id"]+"}}",title:t.getTitle()+": "+e["Name"]})}}))}))}if(this.showTemplatePropertiesMenuOnSelecting){const i=e.template.addConstant(t.clone(this.fieldProperty));n.push({id:i.Expression,title:t.message("BIZPROC_AUTOMATION_ASK_CONSTANT"),tabs:["recents","bpuserroles"],sort:1});const a=e.template.addParameter(t.clone(this.fieldProperty));n.push({id:a.Expression,title:t.message("BIZPROC_AUTOMATION_ASK_PARAMETER"),tabs:["recents","bpuserroles"],sort:2})}return{additionalFields:n}};var c=function(e,i){var n=this;this.robot=e;this.component=g.getInstance().component;this.documentFields=this.component.document.getFields();this.editorNode=i.firstElementChild.firstElementChild;this.menuButton=t.create("span",{attrs:{className:"bizproc-automation-popup-select-dotted"},events:{click:t.delegate(n.openMenu,this)}});i.firstElementChild.appendChild(this.menuButton);this.bindEvents();this.selectCallback=function(t){n.onFieldSelect(t.getCustomData().get("property"))};this.appendPropertyMods=true};t.extend(c,s);c.prototype.getEditor=function(){var t;if(this.editorNode){var e=this.editorNode.id.split("-");t=BXHtmlEditor.Get(e[e.length-1])}return t};c.prototype.bindEvents=function(){this.editorInitFunction=this.bindEditorHooks.bind(this);t.addCustomEvent("OnEditorInitedAfter",this.editorInitFunction)};c.prototype.unBindEvents=function(){t.removeCustomEvent("OnEditorInitedAfter",this.editorInitFunction)};c.prototype.bindEditorHooks=function(e){var i="",n="";if(e.dom.cont!==this.editorNode){return false}t.addCustomEvent(e,"OnParse",(function(t){if(!t){var e=this.content;e=e.replace(/(^[\s\S]*?)(<body.*?>)/i,(function(t){i=t;return""}));e=e.replace(/(<\/body>[\s\S]*?$)/i,(function(t){n=t;return""}));this.content=e}}));t.addCustomEvent(e,"OnAfterParse",(function(t){if(t){var e=this.content;e=e.replace(/^[\s\S]*?<body.*?>/i,"");e=e.replace(/<\/body>[\s\S]*?$/i,"");if(i!==""&&n!==""){e=i+e+n}this.content=e}}))};c.prototype.onFieldSelect=function(t){var e=t["Expression"];var i=this.getEditor();if(i&&i.InsertHtml){if(i.synchro.IsFocusedOnTextarea()){i.textareaView.Focus();i.textareaView.WrapWith("","",e)}else{i.InsertHtml(e)}i.synchro.Sync()}};c.prototype.destroy=function(){if(this.menu)this.menu.popupWindow.close();this.unBindEvents()};c.prototype.onBeforeSave=function(){var t=this.getEditor();if(t&&t.SaveContent){t.SaveContent()}};c.prototype.onPopupResize=function(){var t=this.getEditor();if(t&&t.ResizeSceleton){t.ResizeSceleton()}};var d=function(e){this.targetInput=e;var i=new Date,n=this.unFormatTime(e.value);i.setHours(0,0,0,0);i.setTime(i.getTime()+n*1e3);e.value=this.formatTime(i);t.bind(e,"click",t.delegate(this.showClock,this))};d.prototype={showClock:function(e){if(!this.clockInstance){this.clockInstance=new t.CClockSelector({start_time:this.unFormatTime(this.targetInput.value),node:this.targetInput,callback:t.delegate(this.onTimeSelect,this)})}this.clockInstance.Show()},onTimeSelect:function(e){this.targetInput.value=e;t.fireEvent(this.targetInput,"change");this.clockInstance.closeWnd()},unFormatTime:function(t){var e=t.split(/[\s:]+/);if(e.length==3){var i=e[2];if(i=="pm"&&e[0]<12)e[0]=parseInt(e[0],10)+12;if(i=="am"&&e[0]==12)e[0]=0}return parseInt(e[0],10)*3600+parseInt(e[1],10)*60},formatTime:function(e){var i=t.date.convertBitrixFormat(t.message("FORMAT_DATE")).replace(/:?\s*s/,""),n=t.date.convertBitrixFormat(t.message("FORMAT_DATETIME")).replace(/:?\s*s/,""),a=t.date.format(i,e),o=t.date.format(n,e);return t.util.trim(o.replace(a,""))},destroy:function(){if(this.clockInstance)this.clockInstance.closeWnd()}};var p=function(t,e){this.checkbox=t;this.robot=e;this.needSync=e.draft;if(this.needSync){var i=this.getKey();var n=e.template.userOptions.get("save_state_checkboxes",i,"N");if(n==="Y"){t.checked=true}}};p.prototype={getKey:function(){return this.checkbox.getAttribute("data-save-state-key")},destroy:function(){if(this.needSync){var t=this.getKey();var e=this.checkbox.checked?"Y":"N";this.robot.template.userOptions.set("save_state_checkboxes",t,e)}}};var u={documentName:null,documentType:null,documentFields:null,documentSigned:null,showRobotSettings:function(n,a,r,u){var h=new t.Bizproc.Document({rawDocumentType:a,statusId:r,documentFields:this.documentFields});var m=new M({document:h,isFrameMode:false});m.init(n,t.Bizproc.ViewMode.none());t.Bizproc.setGlobalContext(new t.Bizproc.AutomationContext({document:h,signedDocument:this.documentSigned,ajaxUrl:i()}));var f={document:h,documentSigned:this.documentSigned,ajaxUrl:i()};var g=new A({config:f,selectors:{userSelector:l,fileSelector:o,inlineSelector:s,inlineSelectorHtml:c,timeSelector:d,saveStateCheckbox:p}});g.init({DOCUMENT_FIELDS:this.documentFields},e.ViewMode.None);g.subscribe("Template:help:show",(t=>{t.preventDefault();if(top.BX.Helper){top.BX.Helper.show("redirect=detail&code=14889274")}}));g.openRobotSettingsDialog(m,null,u)}};var h={showVariables:function(e){var i=this;t.Bizproc.Globals.Manager.Instance.showGlobals(t.Bizproc.Globals.Manager.Instance.mode.variable,e).then((function(t){i.onAfterSliderClose(t,"GLOBAL_VARIABLES")}))},showConstants:function(e){var i=this;t.Bizproc.Globals.Manager.Instance.showGlobals(t.Bizproc.Globals.Manager.Instance.mode.constant,e).then((function(t){i.onAfterSliderClose(t,"GLOBAL_CONSTANTS")}))},onAfterSliderClose:function(t,e){var i=t.getData();if(i.get("upsert")){var n=i.get("upsert");for(var a in n){this.component.data[e][a]=n[a]}}if(i.get("delete")){var o=i.get("delete");for(var s in o){delete this.component.data[e][o[s]]}}if(e==="GLOBAL_VARIABLES"){this.component.templateManager.updateGVariables()}else if(e==="GLOBAL_CONSTANTS"){this.component.templateManager.updateGConstants()}}};const m={showStartPage:function(){t.Bizproc.Debugger.Manager.Instance.openDebuggerStartPage(this.component.documentSigned).then()},showDebugSessions:function(){var t={documentSigned:this.component.documentSigned};this.openSlider("bizproc.debugger.session.list",t,{width:1150})},openSlider(e,i,n){const a={width:850,cacheable:false};const o=t.Type.isPlainObject(n)?Object.assign(a,n):a;const s=t.Uri.addParam("/bitrix/components/bitrix/"+e,t.Type.isPlainObject(i)?i:{});t.SidePanel.Instance.open(s,o)}};var f=t.Bizproc.ConditionGroup;var g=t.Bizproc.Designer;var T=t.Bizproc.ConditionGroupSelector;var I=t.Bizproc.Tracker;var b=t.Bizproc.Helper;var v=t.Bizproc.HelpHint;var S=t.Bizproc.Trigger;var E=t.Bizproc.TriggerManager;var M=t.Bizproc.Robot;var A=t.Bizproc.Template;t.Bizproc.Automation.Trigger=S;t.Bizproc.Automation.TriggerManager=E;t.Bizproc.Automation.Robot=M;t.Bizproc.Automation.Template=A;t.Bizproc.Automation.Component=e;t.Bizproc.Automation.Designer=g.getInstance();t.Bizproc.Automation.API=u;t.Bizproc.Automation.ConditionGroup=f;t.Bizproc.Automation.ConditionGroupSelector=T;t.Bizproc.Automation.showGlobals=h;t.Bizproc.Automation.Debugger=m;t.namespace("BX.Bizproc.Automation.Selector");t.Bizproc.Automation.Selector.InlineSelectorCondition=r})(window.BX||window.top.BX);
//# sourceMappingURL=script.map.js