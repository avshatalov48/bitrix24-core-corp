BX.namespace("BX.Disk");BX.Disk.FileViewClass=function(){var e=false;var t=false;var n=function(e){this.componentName=e.componentName;this.signedParameters=e.signedParameters;this.selectorId=e.selectorId;this.object=e.object||{};this.uf=e.uf||{};this.canDelete=!!e.canDelete;if(e.externalLinkInfo){this.buildExternalLinkByState(e.externalLinkInfo)}this.layout=e.layout;this.urls=e.urls;this.gridId=e.gridId;this.grid=this.gridId?BX.Main.gridManager.getById(this.gridId):null;this.ajaxUrl="/bitrix/components/bitrix/disk.file.view/ajax.php";this.ajaxCurrentPageUrl=document.location.href;this.popupOuterLink=null;this.selectorInitialized=false;if(!e.withoutEventBinding)this.setEvents();this.render();BX.ajax.runAction("disk.api.file.showSharingEntities",{data:{fileId:this.object.id}}).then(function(e){if(BX.type.isArray(e.data)){e.data.forEach(function(e){var t=new BX.Disk.Model.SharingItem({state:{entity:e.entity,sharing:e.sharing,object:{id:this.object.id}}});t.render();document.querySelector(".disk-detail-sidebar-user-access-section").appendChild(t.getContainer());var n=BX.UI.SelectorManager.instances[this.selectorId];if(n){n.itemsSelected[e.entity.id]=BX.UI.SelectorManager.convertEntityType(e.entity.type)}BX.onCustomEvent("Disk.FileView:onShowSharingEntities",[{id:this.selectorId,openDialogWhenInit:false}]);this.selectorInitialized=true}.bind(this))}}.bind(this))};n.prototype.buildExternalLinkByState=function(e){this.externalLink=new BX.Disk.Model.ExternalLink.Input({templateId:"external-link-setting-input-prop",state:e,data:{objectId:this.object.id},models:{externalLinkSettings:new BX.Disk.Model.ExternalLink.Settings({templateId:"external-link-setting-popup-prop",state:e}),externalLinkDescription:new BX.Disk.Model.ExternalLink.Description({templateId:"external-link-setting-info-prop",state:e})}})};n.prototype.setUrlToAjaxCurrentPage=function(e){this.ajaxCurrentPageUrl=e};n.prototype.getUrlToAjaxCurrentPage=function(){return this.ajaxCurrentPageUrl.replace(document.location.hash,"")};n.prototype.render=function(){if(this.externalLink&&this.layout.externalLink){this.externalLink.render();this.layout.externalLink.parentNode.replaceChild(this.externalLink.getContainer(),this.layout.externalLink);this.adjustExternalLinkBlockHeight()}};n.prototype.setEvents=function(){BX.bind(BX("disk-detail-sidebar-public-link-copy-link"),"click",this.copyInternalLink.bind(this));if(this.layout.deleteButton){BX.bind(this.layout.deleteButton,"click",this.openDeleteConfirm.bind(this))}if(this.layout.restoreButton){BX.bind(this.layout.restoreButton,"click",this.openConfirmRestoreFromTrash.bind(this))}if(this.layout.addSharingButton){BX.bind(this.layout.addSharingButton,"click",this.openSelector.bind(this))}if(this.layout.editUf){BX.bind(this.layout.editUf,"click",this.editUf.bind(this))}BX.bind(this.layout.moreActionsButton,"click",this.openFileActions.bind(this));BX.bind(window,"popstate",this.onPopState.bind(this));BX.addCustomEvent("onIframeElementLoadDataToView",BX.proxy(this.onIframeElementLoadDataToView,this));BX.addCustomEvent("onIframeElementConverted",BX.proxy(this.onIframeElementConverted,this));BX.addCustomEvent("onBeforeElementShow",BX.proxy(this.onBeforeElementShow,this));BX.addCustomEvent(this.externalLink.externalLinkDescription,"Disk.Model.Item:afterRender",this.handleAfterRenderExternalLinkSettings.bind(this));BX.addCustomEvent("SidePanel.Slider:onMessage",this.onSliderMessage.bind(this));if(!!this.uf){BX.bind(this.uf.editButton,"click",BX.delegate(this.onClickEditUfButton,this))}};n.prototype.onSliderMessage=function(e){var t=e.getData();if(e.getEventId()==="Disk.File:onRestoredFromVersion"||e.getEventId()==="Disk.Version:onDeleted"){window.location.reload()}if(e.getEventId()==="Disk.File.Uf:onUpdated"){this.reloadUf()}};n.prototype.onBeforeElementShow=function(e,t,n){if(t.hasOwnProperty("image")||!BX.message("disk_restriction")){return}n.prevent=true;BX.PopupWindowManager.create("bx-disk-business-tools-info",null,{content:BX("bx-bitrix24-business-tools-info"),closeIcon:true,onPopupClose:function(){this.destroy()},autoHide:true,zIndex:11e3}).show()};n.prototype.handleAfterRenderExternalLinkSettings=function(){this.adjustExternalLinkBlockHeight()};n.prototype.onIframeElementConverted=function(e,t,n){this.setUrlToAjaxCurrentPage(this.ajaxCurrentPageUrl.replace(encodeURIComponent(n),encodeURIComponent(t)))};n.prototype.onIframeElementLoadDataToView=function(e,t){if(t&&t.status==="restriction"&&BX("bx-bitrix24-business-tools-info")){setTimeout(function(){if(BX.CViewer&&BX.CViewer.objNowInShow){if(e.currentModalWindow){e.currentModalWindow.close()}BX.CViewer.objNowInShow.close()}},100);BX.PopupWindowManager.create("bx-disk-business-tools-info",null,{content:BX("bx-bitrix24-business-tools-info"),closeIcon:true,onPopupClose:function(){this.destroy()},autoHide:true,zIndex:11e3}).show()}};n.prototype.onClickEditUfButton=function(e){BX.PreventDefault(e);BX.Disk.ajax({url:BX.Disk.addToLinkParam(document.location.href.replace(document.location.hash,""),"action","editUserField"),method:"POST",dataType:"html",data:{},onsuccess:BX.delegate(function(e){var t=BX.findChild(this.uf.contentContainer,{className:"bx-disk-uf-show-content"});var n=BX.findChild(this.uf.contentContainer,{className:"bx-disk-uf-edit-content"});if(t){BX.hide(t)}BX.adjust(n,{html:e})},this)})};n.prototype.openConfirmRestoreFromTrash=function(){var e=this.object.name;var t=this.object.id;var n=BX.message("DISK_FILE_TRASH_RESTORE_FILE_CONFIRM");var i=[new BX.PopupWindowButton({text:BX.message("DISK_FILE_VIEW_FILE_RESTORE"),className:"popup-window-button-accept",events:{click:function(e){this.addClassName("popup-window-button-wait");BX.ajax.runAction("disk.api.file.restore",{data:{fileId:t}}).then(function(e){BX.PopupWindowManager.getCurrentPopup().close();var n=BX.SidePanel.Instance.getSliderByWindow(window);if(n){n.close();BX.SidePanel.Instance.postMessageAll(window,"Disk.File:onRestore",{objectId:t})}else if(e.data.file.id){document.location.href=BX.Disk.getUrlToShowObjectInGrid(e.data.ID)}})}}}),new BX.PopupWindowButton({text:BX.message("DISK_FILE_VIEW_VERSION_CANCEL_BUTTON"),events:{click:function(e){BX.PopupWindowManager.getCurrentPopup().close()}}})];BX.Disk.modalWindow({modalId:"bx-link-unlink-confirm",title:BX.message("DISK_FILE_TRASHCAN_TRASH_RESTORE_TITLE"),contentClassName:"tac",contentStyle:{paddingTop:"70px",paddingBottom:"70px"},content:n.replace("#NAME#",e),buttons:i})};n.prototype.openConfirmRestore=function(e){var t=e.object.name;var n=e.object.id;var i=e.version.id;var o=BX.message("DISK_FILE_VIEW_VERSION_RESTORE_CONFIRM");var s=[new BX.PopupWindowButton({text:BX.message("DISK_FILE_VIEW_VERSION_RESTORE_BUTTON"),className:"popup-window-button-accept",events:{click:BX.delegate(function(e){BX.PopupWindowManager.getCurrentPopup().close();BX.PreventDefault(e);BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","restoreFromVersion"),data:{objectId:n,versionId:i},onsuccess:BX.delegate(function(e){if(!e){return}this.grid.instance.reload();BX.Disk.showModalWithStatusAction(e)},this)});return false},this)}}),new BX.PopupWindowButton({text:BX.message("DISK_FILE_VIEW_VERSION_CANCEL_BUTTON"),events:{click:function(e){BX.PopupWindowManager.getCurrentPopup().close();BX.PreventDefault(e);return false}}})];BX.Disk.modalWindow({modalId:"bx-link-unlink-confirm",title:BX.message("DISK_FILE_VIEW_VERSION_RESTORE_TITLE"),contentClassName:"tac",contentStyle:{paddingTop:"70px",paddingBottom:"70px"},content:o.replace("#NAME#",t),buttons:s})};n.prototype.openDeleteConfirm=function(){var e=this.object.name;var t=this.object.id;var n=this.canDelete?BX.message("DISK_FILE_VIEW_TRASH_DELETE_DESTROY_FILE_CONFIRM"):BX.message("DISK_FILE_VIEW_TRASH_DELETE_FILE_CONFIRM");if(this.object.isDeleted){n=BX.message("DISK_FILE_VIEW_TRASH_DELETE_DESTROY_DELETED_FILE_CONFIRM")}var i=[];if(!this.object.isDeleted){i.push(new BX.PopupWindowCustomButton({text:BX.message("DISK_FILE_VIEW_TRASH_DELETE_BUTTON"),className:"ui-btn ui-btn-success",events:{click:function(e){this.addClassName("ui-btn-clock");BX.ajax.runAction("disk.api.file.markDeleted",{data:{fileId:t}}).then(function(e){BX.PopupWindowManager.getCurrentPopup().close();var n=BX.SidePanel.Instance.getSliderByWindow(window);if(n){n.close();BX.SidePanel.Instance.postMessageAll(window,"Disk.File:onMarkDeleted",{objectId:t})}})}}}))}if(this.canDelete){var o=this;i.push(new BX.PopupWindowCustomButton({text:BX.message("DISK_FILE_VIEW_TRASH_DESTROY_BUTTON"),className:"ui-btn ui-btn-light-border",events:{click:function(e){this.addClassName("ui-btn-clock");BX.ajax.runAction("disk.api.file.delete",{data:{fileId:t}}).then(function(e){BX.PopupWindowManager.getCurrentPopup().close();var n=BX.SidePanel.Instance.getSliderByWindow(window);if(n){n.close();BX.SidePanel.Instance.postMessageAll(window,"Disk.File:onDelete",{objectId:t})}else{document.location.href=o.urls.trashcanList}})}}}))}i.push(new BX.PopupWindowCustomButton({text:BX.message("DISK_FILE_VIEW_VERSION_CANCEL_BUTTON"),className:"ui-btn ui-btn-link",events:{click:function(e){BX.PopupWindowManager.getCurrentPopup().close()}}}));BX.Disk.modalWindow({modalId:"bx-link-unlink-confirm",title:BX.message("DISK_FILE_VIEW_VERSION_DELETE_TITLE"),contentClassName:"disk-popup-text-content",content:n.replace("#NAME#",e),buttons:i})};n.prototype.openConfirmDeleteVersion=function(e){var t=e.object.name;var n=e.object.id;var i=e.version.id;var o=BX.message("DISK_FILE_VIEW_VERSION_DELETE_VERSION_CONFIRM");var s=[new BX.PopupWindowButton({text:BX.message("DISK_FILE_VIEW_VERSION_DELETE_VERSION_BUTTON"),className:"popup-window-button-accept",events:{click:BX.delegate(function(e){BX.PopupWindowManager.getCurrentPopup().close();BX.PreventDefault(e);BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","deleteVersion"),data:{objectId:n,versionId:i},onsuccess:BX.delegate(function(e){if(!e){return}this.grid.instance.removeRow(i);BX.Disk.showModalWithStatusAction(e)},this)});return false},this)}}),new BX.PopupWindowButton({text:BX.message("DISK_FILE_VIEW_VERSION_CANCEL_BUTTON"),events:{click:function(e){BX.PopupWindowManager.getCurrentPopup().close();BX.PreventDefault(e);return false}}})];BX.Disk.modalWindow({modalId:"bx-link-unlink-confirm",title:BX.message("DISK_FILE_VIEW_VERSION_DELETE_VERSION_TITLE"),contentClassName:"tac",contentStyle:{paddingTop:"70px",paddingBottom:"70px"},content:o.replace("#NAME#",t),buttons:s})};n.prototype.deleteBizProc=function(e){BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","deleteBizProc"),data:{idBizProc:e,fileId:this.object.id},onsuccess:BX.delegate(function(t){if(t){BX.remove(BX(e))}},this)})};n.prototype.stopBizProc=function(e){BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","stopBizProc"),data:{idBizProc:e,fileId:this.object.id},onsuccess:BX.delegate(function(e){if(e.status=="success"){var t=document.location.href.replace("#tab-bp","");t+="#tab-bp";document.location.href=t;location.reload()}else{e.errors=e.errors||[{}];BX.Disk.showModalWithStatusAction({status:"error",message:e.errors.pop().message})}},this)})};n.prototype.openSlider=function(e){BX.SidePanel.Instance.open(e,{allowChangeHistory:false})};n.prototype.showLogBizProc=function(e){this.openSlider(BX.Disk.addToLinkParam(this.urls.fileShowBp,"log_workflow",e))};n.prototype.sortBizProcLog=function(){var e=BX.findChildByClassName(BX("workarea-content"),"bx-sortable").getAttribute("onclick").replace("log_sort=1&","");e=e.replace("?log_workflow","?log_sort=1&log_workflow");e=e.replace("&action=showBp","");BX.findChildByClassName(BX("workarea-content"),"bx-sortable").setAttribute("onclick",e)};n.prototype.fixUrlForSort=function(){var e=document.location.href.replace("&log_sort=1","");e+="#tab-bp";document.location.href=e};n.prototype.copyInternalLink=function(){var e=BX("disk-detail-sidebar-public-link-copy-link");var t=e.getAttribute("for");var n=document.getElementById(t);n.select();document.execCommand("copy");this.popupOuterLink?null:this.showCopyLinkPopup(e,BX.message("DISK_FILE_VIEW_INTERNAL_LINK_COPIED"))};n.prototype.showCopyLinkPopup=function(e,t){this.popupOuterLink=new BX.PopupWindow("disk-popup-copy-link",e,{className:"disk-popup-copy-link",bindPosition:{position:"top"},offsetLeft:-10,darkMode:true,angle:true,content:t});this.popupOuterLink.show();setTimeout(function(){BX.addClass(BX(this.popupOuterLink.uniquePopupId),"disk-popup-copy-link-hide")}.bind(this),2e3);setTimeout(function(){this.popupOuterLink.destroy();this.popupOuterLink=null}.bind(this),2200)};n.prototype.adjustExternalLinkBlockHeight=function(){this.externalLink.adjustHeight()};n.prototype.onPopState=function(e){var t=e.state;if(t&&t.disk){window.location.reload()}};n.prototype.openFileActions=function(e){var t=BX.getEventTarget(e);var n=this;var i=[{text:BX.message("DISK_FILE_VIEW_FILE_GO_TO_HISTORY"),onclick:function(){BX.SidePanel.Instance.open(n.urls.fileHistory);this.close()}}];if(this.object.hasUf){i.push({text:BX.message("DISK_FILE_VIEW_FILE_GO_TO_SHOW_USERFIELDS"),onclick:function(){BX.SidePanel.Instance.open(n.urls.fileShowUf,{allowChangeHistory:false});this.close()}})}if(this.object.hasBp){i.push({text:BX.message("DISK_FILE_VIEW_FILE_GO_TO_SHOW_BP"),onclick:function(){BX.SidePanel.Instance.open(n.urls.fileShowBp,{allowChangeHistory:false});this.close()}})}BX.PopupMenu.show("disk-file-view-actions",BX(t),i,{className:"disk-file-view-actions-popup",angle:true,autoHide:true,offsetLeft:20,overlay:{opacity:.01},events:{onPopupClose:function(){BX.PopupMenu.destroy("disk-file-view-actions")}}})};n.prototype.editUf=function(){BX.SidePanel.Instance.open(this.urls.fileEditUf,{allowChangeHistory:false})};n.prototype.reloadUf=function(){BX.ajax.runComponentAction("bitrix:disk.file.view","showUfSidebar",{mode:"class",data:{fileId:this.object.id}}).then(function(e){BX.cleanNode(this.layout.sidebarUfValuesSection);this.layout.sidebarUfValuesSection.innerHTML=e.data.html}.bind(this))};n.prototype.onOpenSelector=function(){var e=BX.UI.SelectorManager.instances[this.selectorId];if(e&&e.popups.container&&BX.SidePanel.Instance.isOpen()){e.popups.container.adjustPosition()}};n.prototype.openSelector=function(){if(!this.selectorInitialized){BX.onCustomEvent("Disk.FileView:onShowSharingEntities",[{id:this.selectorId,openDialogWhenInit:true}]);this.selectorInitialized=true}else{BX.onCustomEvent("Disk.FileView:openSelector",[{id:this.selectorId}])}};n.prototype.onUnSelectSelectorItem=function(e){BX.onCustomEvent("Disk.FileView:onUnSelectSelectorItem",[e])};n.prototype.onSelectSelectorItem=function(e){if(e.state!=="select")return;BX.Main.selectorManagerV2.getById(this.selectorId).closeDialog();var t=new BX.Disk.Model.DraftSharingItem({state:{entity:{id:e.item.id,name:e.item.name,link:e.item.link,avatar:e.item.avatar},object:{id:this.object.id}}});t.render();t.save();document.querySelector(".disk-detail-sidebar-user-access-section").appendChild(t.getContainer())};return n}();
//# sourceMappingURL=script.map.js