if(!BX.Tasks)BX.Tasks={};if(!BX.Tasks.componentIframe)BX.Tasks.componentIframe={};if(!BX.Tasks.componentIframe.objTemplate){BX.Tasks.componentIframe.objTemplate=function(e){var s=BX.Tasks.lwPopup.createForm;var t="task-responsible-employee";var a=null;var l=null;var o=null;var r=null;var n=null;var p=null;var c=null;var d=false;var u=false;this.buttonsLocked=false;this.initialTaskData=null;this.html=null;var m=function(e,s){var i="";var p="";var d=1;var m="";var k=[];var f=0;var b="...";var v=false;var _=[];var w="Y";var B="N";var h=0;var T=0;var X=0;if(BX.message("TASKS_META_OPTION_TASK_CONTROL")==="Y")w="Y";else w="N";if(BX.message("TASKS_META_OPTION_TIME_TRACKING")==="Y")B="Y";else B="N";if(e){c=e;if(e.TITLE)i=e.TITLE;if(e.DESCRIPTION)p=e.DESCRIPTION;if(e.PRIORITY)d=e.PRIORITY;if(e.DEADLINE)m=e.DEADLINE;if(e.ACCOMPLICES)k=e.ACCOMPLICES;if(e.GROUP_ID){v=true;f=e.GROUP_ID;if(e["META:GROUP_NAME"]){b=e["META:GROUP_NAME"];v=false}}if(e.UF_CRM_TASK){_=e.UF_CRM_TASK;u=true}if(e.ALLOW_TIME_TRACKING)B=e.ALLOW_TIME_TRACKING;if(e.TASK_CONTROL)w=e.TASK_CONTROL;if(e.TIME_ESTIMATE){h=e.TIME_ESTIMATE;T=Math.floor(h/3600);X=Math.round((h-T*3600)/60)}}BX.cleanNode(BX("webform-field-upload-list"));var S=e.RESPONSIBLE_ID;var E=false;BX("lwPopup-task-title").value=i;BX("lwPopup-task-responsible-id").value=S;BX("lwPopup-task-accomplices-id").value=k.join(",");BX.cleanNode(BX("task-accomplices-list"));if(S==BX.Tasks.lwPopup.loggedInUserId){w="N";BX("lwPopup-task-control").checked=false;BX.addClass(BX("lwPopup-task-control").parentNode,"webform-field-checkbox-option-disabled");BX("lwPopup-task-control").disabled=true}else{BX.removeClass(BX("lwPopup-task-control").parentNode,"webform-field-checkbox-option-disabled");BX("lwPopup-task-control").disabled=false;if(w==="Y")BX("lwPopup-task-control").checked=true;else BX("lwPopup-task-control").checked=false}if(B==="Y"){BX.addClass(BX("lwPopup-task-time-tracking-container"),"task-edit-allowed-time-tracking");BX("lwPopup-task-allow-time-tracking").checked=true}else{BX.removeClass(BX("lwPopup-task-time-tracking-container"),"task-edit-allowed-time-tracking");BX("lwPopup-task-allow-time-tracking").checked=false}if(T==0&&X==0){BX("lwPopup-task-time-tracking-hours").value="";BX("lwPopup-task-time-tracking-minutes").value=""}else{BX("lwPopup-task-time-tracking-hours").value=T;if(X>=10)BX("lwPopup-task-time-tracking-minutes").value=X;else BX("lwPopup-task-time-tracking-minutes").value="0"+X.toString()}r.setContent(p);n.setValue(_);this._togglePriority(d);this._setDeadline(m);o.setSelected({id:f,title:b});this._onGroupSelect([{id:f,title:b}]);if(v){BX.CJSTask.getGroupsData([f],{callback:function(e,s){return function(t){var a=t[e]["~NAME"];if(typeof a!="undefined"){a=a.toString();if(a.length>0){o.setSelected({id:e,title:a});s._onGroupSelect([{id:e,title:a}])}}}}(f,this)})}var P=false;if(e["META:RESPONSIBLE_FORMATTED_NAME"])E=e["META:RESPONSIBLE_FORMATTED_NAME"];else if(e.RESPONSIBLE_LAST_NAME&&e.RESPONSIBLE_NAME)E=e.RESPONSIBLE_NAME+" "+e.RESPONSIBLE_LAST_NAME;else{var P=true;E="..."}BX(t).value=E;a.setSelectedUsers([{id:S,name:E}]);var g=[];for(var A=0;A<k.length;A++){g.push({id:k[A],name:"..."})}l.setSelectedUsers(g);this._onAccomplicesSelect(g);if(P||k.length>0){var N=[];N.push.apply(N,k);if(P)N.push(S);BX.CJSTask.formatUsersNames(N,{callback:function(e,s,i,o){return function(r){if(e){BX(t).value=r["u"+s];a.setSelectedUsers([{id:s,name:r["u"+s]}])}var n=[];for(var p=0;p<i.length;p++){n.push({id:i[p],name:r["u"+i[p]]})}l.setSelectedUsers(n);o._onAccomplicesSelect(n)}}(P,S,k.slice(),this)})}};s.callbacks.onAfterPopupCreated=function(e){var s="Shift+Enter";var i="Ctrl+Enter";var c=[];if(e.hasOwnProperty("UF_CRM_TASK"))c.push.apply(c,e.UF_CRM_TASK);var d=[];if(e.hasOwnProperty("UF_TASK_WEBDAV_FILES"))d.push.apply(d,e.UF_TASK_WEBDAV_FILES);var u=[];if(e.hasOwnProperty("ACCOMPLICES"))u.push.apply(u,e.ACCOMPLICES);var m=BX.Tasks.lwPopup.__initSelectors([{requestedObject:"intranet.user.selector.new",selectedUsersIds:[e.RESPONSIBLE_ID],anchorId:t,bindClickTo:BX(t).parentNode,userInputId:t,multiple:"N",callbackOnSelect:function(e){return function(s){e._onResponsibleSelect(s)}}(this)},{requestedObject:"intranet.user.selector.new",selectedUsersIds:u,anchorId:"task-accomplices-link",multiple:"Y",btnSelectText:BX.message("TASKS_BTN_SELECT"),btnCancelText:BX.message("TASKS_BTN_CANCEL"),callbackOnSelect:function(e){return function(s){e._onAccomplicesSelect(s)}}(this)},{requestedObject:"socialnetwork.group.selector",bindElement:"task-sonet-group-selector",callbackOnSelect:function(e){return function(s,t){e._onGroupSelect(s,t)}}(this)},{requestedObject:"LHEditor",attachTo:"lwPopup-task-description-area"},{requestedObject:"system.field.edit::CRM",userFieldName:"UF_CRM_TASK",taskId:0,value:c,callbackOnRedraw:function(e){return function(s,t){e.__onCrmFieldRedraw(s,t)}}(this)},{requestedObject:"system.field.edit::WEBDAV",userFieldName:"UF_TASK_WEBDAV_FILES",taskId:0,value:d,callbackOnRedraw:function(e){return function(s,t){e.__onWebdavFieldRedraw(s,t)}}(this)}]);a=m[0];l=m[1];o=m[2];r=m[3];n=m[4];p=m[5];if(BX.message("TASKS_META_OPTION_OPENED_DESCRIPTION")==="Y"){BX.removeClass("lwPopup-task-description-label-icon","task-description-label-icon-right");BX.addClass("lwPopup-task-description-label-icon","task-description-label-icon-bottom");BX("lwPopup-task-description-area-container").style.display="block"}else{BX.removeClass("lwPopup-task-description-label-icon","task-description-label-icon-bottom");BX.addClass("lwPopup-task-description-label-icon","task-description-label-icon-right");BX("lwPopup-task-description-area-container").style.display="none"}if(BX.browser.IsMac()){var k=document.createElement("div");k.innerHTML="&#8984;";var f=k.childNodes.length===0?"":k.childNodes[0].nodeValue;i=f+"+Enter"}BX("task-submit-button-text").innerHTML=BX.message("TASKS_BTN_CREATE_TASK")+" ("+i+")";BX("task-submit-and-create-new-when-back-to-form-button-text").innerHTML=BX.message("TASKS_BTN_CREATE_TASK_AND_ONCE_MORE")+" ("+s+")";BX("task-cancel-button-text").innerHTML=BX.message("TASKS_BTN_CANCEL")};s.callbacks.onBeforePopupShow=function(e,s){var t=[];var a=false;s=s||{};if(s.hasOwnProperty(a))a=s.isPopupJustCreated;this.initialTaskData=JSON.parse(JSON.stringify(e));m.call(this,e,a);this.__checkWarnings();if(!a)this.__cleanErrorsArea();if(BX.browser.IsSafari())BX("task-upload").multiple=false;if(p)t=p.getValue();if(t.length>0&&(!e.hasOwnProperty("UF_TASK_WEBDAV_FILES")||typeof e.UF_TASK_WEBDAV_FILES!=="object"||!e.UF_TASK_WEBDAV_FILES.hasOwnProperty("length")||e.UF_TASK_WEBDAV_FILES.length==0)){p.setValue([0])}};s.callbacks.onAfterPopupShow=function(){if(d){if((BX.browser.IsChrome()||BX.browser.IsIE11()||BX.browser.IsIE())&&typeof r!="undefined"&&typeof r["editor"]!="undefined"){r["editor"].Focus(false)}BX("lwPopup-task-title").focus()}BX.bind(document,"keydown",BX.Tasks.lwPopup.createForm.objTemplate._processKeyDown)};s.callbacks.onPopupClose=function(){BX.unbind(document,"keydown",BX.Tasks.lwPopup.createForm.objTemplate._processKeyDown)};s.handleMagicKeyCombos=function(e){e=e||window.event;if(e.shiftKey&&e.keyCode==13){s.objTemplate._submitAndCreateOnceMore();return false}if(e.ctrlKey&&e.keyCode==13){s.objTemplate._submitAndClosePopup();return false}};s.callbacks.onAfterEditorInited=function(){if((BX.browser.IsChrome()||BX.browser.IsIE11()||BX.browser.IsIE())&&typeof r!="undefined"&&typeof r["editor"]!="undefined"&&"Focus"in r["editor"]){r["editor"].Focus(false)}BX.addCustomEvent(r["editor"],"OnIframeKeyup",s.handleMagicKeyCombos);BX.addCustomEvent(r["editor"],"OnTextareaKeyup",s.handleMagicKeyCombos);BX("lwPopup-task-title").focus();d=true};this.prepareTitleBar=function(){var e='<span class="task-detail-popup-title">'+BX.message("TASKS_TIT_CREATE_TASK_2")+"</span>"+'<span class="task-detail-popup-btn" onclick="BX.Tasks.lwPopup.createForm.objTemplate._runFullEditForm();">'+BX.message("TASKS_LINK_SHOW_FULL_CREATE_FORM")+"</span>";return{content:BX.create("span",{html:e})}};this._processKeyDown=function(e){if(e.keyCode==27){bClose=true;var t=s.objTemplate.gatherTaskDataFromForm();if(t.hasOwnProperty("TITLE")&&t.TITLE.length||t.hasOwnProperty("DESCRIPTION")&&t.DESCRIPTION.length){bClose=confirm(BX.message("TASKS_CONFIRM_CLOSE_CREATE_DIALOG"))}if(bClose)s.objPopup.close()}var a=e.keyCode==10||e.keyCode==13;if(!a)return;if(e.ctrlKey||e.metaKey)s.objTemplate._submitAndClosePopup();else if(e.shiftKey)s.objTemplate._submitAndCreateOnceMore()};this._runFullEditForm=function(){var e=BX.Tasks.lwPopup.createForm.objTemplate.gatherTaskDataFromForm();if(e.hasOwnProperty("ACCOMPLICES")){e.ACCOMPLICES_IDS=e.ACCOMPLICES.slice();delete e.ACCOMPLICES}if(e.hasOwnProperty("RESPONSIBLE_SECOND_NAME"))delete e.RESPONSIBLE_SECOND_NAME;if(e.hasOwnProperty("RESPONSIBLE_LAST_NAME"))delete e.RESPONSIBLE_LAST_NAME;if(e.hasOwnProperty("RESPONSIBLE_NAME"))delete e.RESPONSIBLE_NAME;if(e.hasOwnProperty("META:RESPONSIBLE_FORMATTED_NAME"))delete e["META:RESPONSIBLE_FORMATTED_NAME"];if(e.hasOwnProperty("META:GROUP_NAME"))delete e["META:GROUP_NAME"];taskIFramePopup.add(e);BX.Tasks.lwPopup.createForm.objPopup.close()};this.prepareContent=function(){if(this.html==null){this.html='<div class="webform task-webform">					<div id="lwPopup-task-errorsArea" class="webform-round-corners webform-error-block" style="display: none;">						<div class="webform-corners-top"><div class="webform-left-corner"></div><div class="webform-right-corner"></div></div>						<div class="webform-content">							<ul id="lwPopup-task-errorsArea-list" class="webform-error-list">							</ul>						</div>						<div class="webform-corners-bottom"><div class="webform-left-corner"></div><div class="webform-right-corner"></div></div>					</div>					<div class="webform-round-corners webform-main-fields task-main-fields">						<div class="webform-corners-top">							<div class="webform-left-corner"></div>							<div class="webform-right-corner"></div>						</div>						<div class="webform-content">							<div class="webform-row task-title-row">								<div class="webform-field-label"><label for="task-title">									'+BX.message("TASKS_TITLE")+'								</label></div>								<div class="webform-field webform-field-textbox-double task-title">									<div class="webform-field-textbox-inner"										><input type="text" name="TITLE" id="lwPopup-task-title" 											placeholder="'+BX.message("TASKS_TITLE_PLACEHOLDER")+'"											style="height:23px;" class="webform-field-textbox"											value=""									/></div>								</div>							</div>														<div class="webform-row task-quick-responsible-employee-row">								<table cellspacing="0" class="task-responsible-employee-layout">									<tr>										<td class="task-responsible-employee-layout-left">											<div class="webform-field-label"												><label for="task-responsible-employee" 													id="task-responsible-employee-label">														'+BX.message("TASKS_RESPONSIBLE")+'												</label></div>																						<div class="webform-field webform-field-combobox task-responsible-employee" 												id="task-responsible-employee-block">												<div class="webform-field-combobox-inner">													<input type="text" autocomplete="off" id="task-responsible-employee" 														class="webform-field-combobox" value="" 													/><a href="javascript:void(0);" class="webform-field-combobox-arrow">&nbsp;</a>													<input type="hidden" id="lwPopup-task-responsible-id" value="" />												</div>											</div>																						<div class="webform-field task-quick-assistants" id="task-accomplices-block">												<div class="task-assistants-label"													><a href="javascript:void(0);" class="task-quick-assistants-link" 														id="task-accomplices-link"														onclick="BX.Tasks.lwPopup.createForm.objTemplate._showAccomplicesSelector(event);"														>														'+BX.message("TASKS_TASK_ACCOMPLICES")+'												</a></div>												<div class="task-assistants-list" id="task-accomplices-list">												</div>												<input type="hidden" id="lwPopup-task-accomplices-id" value="" />											</div>										</td>										<td class="task-responsible-employee-layout-right">											<div class="webform-field task-priority" id="task-priority">												<label>'+BX.message("TASKS_PRIORITY")+':</label>													<a href="javascript:void(0);" class="task-priority-low"														id="lwPopup-task-priority-0" 														onclick="BX.Tasks.lwPopup.createForm.objTemplate._togglePriority(0);"														><i></i><span>														'+BX.message("TASKS_PRIORITY_LOW")+'													</span><b></b></a>													<a href="javascript:void(0);" class="task-priority-middle"														id="lwPopup-task-priority-1" 														onclick="BX.Tasks.lwPopup.createForm.objTemplate._togglePriority(1);"														><i></i><span>														'+BX.message("TASKS_PRIORITY_NORMAL")+'													</span><b></b></a>													<a href="javascript:void(0);" class="task-priority-high"														id="lwPopup-task-priority-2" 														onclick="BX.Tasks.lwPopup.createForm.objTemplate._togglePriority(2);"														><i></i><span>														'+BX.message("TASKS_PRIORITY_HIGH")+'													</span><b></b></a>												<input type="hidden" id="lwPopup-task-priority" value="" />											</div>										</td>									</tr>								</table>							</div>														<div class="webform-row task-quick-dates-row">								<div class="webform-field">									<div class="webform-field task-quick-deadline-settings"										><label for="task-deadline-date">											'+BX.message("TASKS_DEADLINE")+':</label										>&nbsp;&nbsp;<span style="display:inline; line-height:20px;" id="task-quick-detail-deadline"											onclick="												BX.Tasks.lwPopup._showCalendar(													BX(\'task-quick-detail-deadline\'),													BX(\'lwPopup-task-deadline\'),													{														callback_after : function(value) {															var field = BX(\'lwPopup-task-deadline\');															var defaultTime = BX.CJSTask.ui.extractDefaultTimeFromDataAttribute(field);															field.value = BX.CJSTask.addTimeToDateTime(field.value, defaultTime);															BX.Tasks.lwPopup.createForm.objTemplate._setDeadline(field.value);														}													}												);												"											class="webform-field-action-link">												'+BX.message("TASKS_THERE_IS_NO_DEADLINE")+'											</span									><input type="text" value="" id="lwPopup-task-deadline" data-default-hour="'+BX.message("TASKS_COMPANY_WORKTIME_H")+'" data-default-minute="'+BX.message("TASKS_COMPANY_WORKTIME_M")+'" 										style="display:none;"><span id="task-detail-deadline-remove"										onclick="BX.Tasks.lwPopup.createForm.objTemplate._clearDeadline();" 										class="task-deadline-delete"										style="display:none;"></span>									</div>								</div>							</div>							<div class="webform-row task-options-row">								<div class="webform-field webform-field-checkbox-options task-options">									<div class="webform-field-checkbox-option" style="margin-top: 13px;"><input type="checkbox" value="Y" 										onclick="											if (this.checked)												BX.userOptions.save(\'tasks\', \'popup_options\', \'task_control\', \'Y\');											else												BX.userOptions.save(\'tasks\', \'popup_options\', \'task_control\', \'N\');"										onchange="											if (this.checked)												BX.userOptions.save(\'tasks\', \'popup_options\', \'task_control\', \'Y\');											else												BX.userOptions.save(\'tasks\', \'popup_options\', \'task_control\', \'N\');"										id="lwPopup-task-control" class="webform-field-checkbox"><label for="lwPopup-task-control">'+BX.message("TASKS_CONTROL_CHECKBOX")+"</label></div>									<div id=\"lwPopup-task-time-tracking-container\" class=\"webform-field-checkbox-option\" 										><input type=\"checkbox\" value=\"Y\" id=\"lwPopup-task-allow-time-tracking\" 											onclick=\"												if (this.checked)												{													BX.addClass(this.parentNode, 'task-edit-allowed-time-tracking');													BX.userOptions.save('tasks', 'popup_options', 'time_tracking', 'Y');												}												else												{													BX.removeClass(this.parentNode, 'task-edit-allowed-time-tracking');													BX.userOptions.save('tasks', 'popup_options', 'time_tracking', 'N');												}\"											onchange=\"												if (this.checked)												{													BX.addClass(this.parentNode, 'task-edit-allowed-time-tracking');													BX.userOptions.save('tasks', 'popup_options', 'time_tracking', 'Y');												}												else												{													BX.removeClass(this.parentNode, 'task-edit-allowed-time-tracking');													BX.userOptions.save('tasks', 'popup_options', 'time_tracking', 'N');												}\"											class=\"webform-field-checkbox\" /><label for=\"lwPopup-task-allow-time-tracking\" class=\"task-edit-allowed-time-tracking-hide\">"+BX.message("TASKS_TASK_ALLOW_TIME_TRACKING")+'</label><label for="lwPopup-task-allow-time-tracking" class="task-edit-allowed-time-tracking-show">'+BX.message("TASKS_TASK_ALLOW_TIME_TRACKING_DETAILS")+'</label>											<span style="display:inline;"><span style="display:inline-block;"><span style="height:18px; display:inline-block; border:1px;"></span></span></span>											<span class="task-edit-allowed-time-tracking-show">												<span class="webform-field webform-field-textbox task-time-tracking-hours"><span class="webform-field-textbox-inner"><input type="text" id="lwPopup-task-time-tracking-hours" value="" maxlength="4" class="webform-field-textbox task-time-tracking-hours-input"></span></span><span>'+BX.message("TASKS_TASK_TIME_TRACKING_HOURS")+'</span><span class="webform-field webform-field-textbox task-time-tracking-minutes"><span class="webform-field-textbox-inner"><input type="text" id="lwPopup-task-time-tracking-minutes" value="" maxlength="2" class="webform-field-textbox task-time-tracking-minutes-input"></span></span><span>'+BX.message("TASKS_TASK_TIME_TRACKING_MINUTES")+"</span><span class=\"task-deadline-delete\" style=\"\" onclick=\"BX('lwPopup-task-time-tracking-hours').value = ''; BX('lwPopup-task-time-tracking-minutes').value = ''; \"></span>											</span>									</div>								</div>							</div>						</div>					</div>										<div class=\"webform-round-corners webform-additional-fields\">						<div id=\"lwPopup-task-grey-area\" class=\"webform-content\">							<div class=\"webform-row task-description-row\">								<div class=\"webform-field-label task-description-label-container\"									><a href=\"javascript:void(0);\" class=\"task-description-label\"										onclick=\"										this.blur();										if (BX('lwPopup-task-description-area-container').style.display === 'none')										{											BX.removeClass('lwPopup-task-description-label-icon', 'task-description-label-icon-right');											BX.addClass('lwPopup-task-description-label-icon', 'task-description-label-icon-bottom');											BX('lwPopup-task-description-area-container').style.display = 'block';											BX.userOptions.save('tasks', 'popup_options', 'opened_description', 'Y');										}										else										{											BX.removeClass('lwPopup-task-description-label-icon', 'task-description-label-icon-bottom');											BX.addClass('lwPopup-task-description-label-icon', 'task-description-label-icon-right');											BX('lwPopup-task-description-area-container').style.display = 'none';											BX.userOptions.save('tasks', 'popup_options', 'opened_description', 'N');										}										\"										>"+BX.message("TASKS_DESCRIPTION")+'</a><span 									id="lwPopup-task-description-label-icon"									class="task-description-label-icon task-description-label-icon-right">&nbsp;</span></div>								<div class="webform-field webform-field-textarea task-description-textarea" id="lwPopup-task-description-area-container" style="display:none;">									<div class="webform-field-textarea-inner" id="lwPopup-task-description-area">										<textarea readonly="readonly"></textarea>									</div>								</div>							</div>														<div class="webform-row task-group-row">								<a href="javascript:void(0);" id="task-sonet-group-selector"									class="task-quick-popup-group-selector-link"									>'+BX.message("TASKS_GROUP")+'</a>							</div>														<div class="webform-row task-attachments-row" style="display:none;">								<div class="webform-field webform-field-attachments">									<ol class="webform-field-upload-list" id="webform-field-upload-list"></ol>									<div class="webform-field-upload">										<span class="webform-button webform-button-upload"											><span class="webform-button-left"></span											><span class="webform-button-text">'+BX.message("TASKS_UPLOAD_FILES")+'</span											><span class="webform-button-right"></span										></span>										<input type="file" name="task-attachments[]" size="1" 											multiple="multiple" id="task-upload"											onChange="BX.Tasks.lwPopup.createForm.objTemplate._onFilesChange.call(this, event);" />									</div>								</div>							</div>						</div>												<div class="webform-corners-bottom">							<div class="webform-left-corner"></div>							<div class="webform-right-corner"></div>						</div>					</div>										<div id="task-edit-warnings-area"						class="webform-round-corners webform-warning-block"						style="display: none; margin:10px 0;">						<div class="webform-corners-top">							<div class="webform-left-corner"></div>							<div class="webform-right-corner"></div>						</div>						<div class="webform-content">							<div id="task-edit-warnings-area-message"></div>						</div>						<div class="webform-corners-bottom">							<div class="webform-left-corner"></div>							<div class="webform-right-corner"></div>						</div>					</div>										<div class="webform-buttons task-buttons">						<a id="task-submit-button" class="webform-button webform-button-create" 							onclick="BX.Tasks.lwPopup.createForm.objTemplate._submitAndClosePopup();" 							href="javascript: void(0);"><span class="webform-button-left"></span							><span class="webform-button-text" 								id="task-submit-button-text"></span							><span class="webform-button-right"></span></a>						<a id="task-submit-and-create-new-when-back-to-form-button-text" 							href="javascript: void(0);"							class="webform-button-link task-button-create-link" 							onclick="BX.Tasks.lwPopup.createForm.objTemplate._submitAndCreateOnceMore();" 						></a>						<a class="webform-button-link webform-button-link-cancel" 							href="javascript:void(0);" 							id="task-cancel-button-text" 							onclick="BX.Tasks.lwPopup.createForm.objPopup.close();" 						></a>					</div>				</div>'}return BX.create("div",{props:{className:"task-quick-create-popup"},html:this.html})};this.gatherTaskDataFromForm=function(){var e=c;var s=[];var t=document.getElementsByName("FILES[]");var a=[];if(t){var i=t.length;for(var l=0;l<i;l++)a.push(t[l].value)}if(BX("lwPopup-task-accomplices-id").value.length>0)s=BX("lwPopup-task-accomplices-id").value.split(",");var o=0;if(BX("lwPopup-task-group-id"))o=BX("lwPopup-task-group-id").value;var d="N";var u=0;if(BX("lwPopup-task-allow-time-tracking").checked){d="Y";if(BX("lwPopup-task-time-tracking-hours")&&BX("lwPopup-task-time-tracking-minutes")){var m=parseInt(BX("lwPopup-task-time-tracking-hours").value);var k=parseInt(BX("lwPopup-task-time-tracking-minutes").value);if(isNaN(m))m=0;if(isNaN(k))k=0;u=m*3600+k*60}}if(BX("lwPopup-task-control").checked)taskControl="Y";else taskControl="N";e.TITLE=BX("lwPopup-task-title").value;e.DESCRIPTION=r.getContent();e.DEADLINE=BX("lwPopup-task-deadline").value;e.PRIORITY=BX("lwPopup-task-priority").value;e.RESPONSIBLE_ID=BX("lwPopup-task-responsible-id").value;e.ACCOMPLICES=s;e.FILES=a;e.GROUP_ID=o;e.TASK_CONTROL=taskControl;e.UF_CRM_TASK=n.getValue();e.UF_TASK_WEBDAV_FILES=p.getValue();e.ALLOW_TIME_TRACKING=d;var f=BX("diskuf-edit-rigths-doc");if(BX.type.isElementNode(f)&&"value"in f){e.DISK_ATTACHED_OBJECT_ALLOW_EDIT=f.value;e.TASKS_TASK_DISK_ATTACHED_OBJECT_ALLOW_EDIT=f.value}if(d==="Y")e.TIME_ESTIMATE=u;e["META:GROUP_NAME"]=null;e["META:RESPONSIBLE_FORMATTED_NAME"]=null;e.RESPONSIBLE_NAME=null;e.RESPONSIBLE_LAST_NAME=null;e.RESPONSIBLE_SECOND_NAME=null;if(!e.hasOwnProperty("ALLOW_CHANGE_DEADLINE"))e["ALLOW_CHANGE_DEADLINE"]="Y";return e};this.__lockButtons=function(){this.buttonsLocked=true};this.__releaseButtons=function(){this.buttonsLocked=false};this._submitAndClosePopup=function(){var e=null;if(this.buttonsLocked)return;this.__lockButtons();if(typeof tasksListNS!=="undefined"&&tasksListNS.getColumnsOrder)e=tasksListNS.getColumnsOrder();this.__cleanErrorsArea();var t=s.objTemplate.gatherTaskDataFromForm();BX.Tasks.lwPopup._createTask({taskData:t,onceMore:false,columnsIds:e,callbackOnSuccess:function(e){return function(){s.objPopup.close();e.__releaseButtons()}}(this),callbackOnFailure:function(e){return function(s){e.__fillErrorsArea(s.errMessages);e.__releaseButtons()}}(this)})};this._submitAndCreateOnceMore=function(){var e=null;if(this.buttonsLocked)return;this.__lockButtons();if(typeof tasksListNS!=="undefined"&&tasksListNS.getColumnsOrder)e=tasksListNS.getColumnsOrder();this.__cleanErrorsArea();var t=s.objTemplate.gatherTaskDataFromForm();BX.Tasks.lwPopup._createTask({taskData:t,onceMore:true,columnsIds:e,callbackOnSuccess:function(e){return function(){s.objPopup.close();e.__releaseButtons();e.initialTaskData.TITLE="";e.initialTaskData.DESCRIPTION="";e.initialTaskData.ACCOMPLICES=[];BX.Tasks.lwPopup.showCreateForm(e.initialTaskData)}}(this),callbackOnFailure:function(e){return function(s){e.__fillErrorsArea(s.errMessages);e.__releaseButtons()}}(this)})};this.prepareButtons=function(){return[]};this._togglePriority=function(e){BX.removeClass("lwPopup-task-priority-0","selected");BX.removeClass("lwPopup-task-priority-1","selected");BX.removeClass("lwPopup-task-priority-2","selected");BX("lwPopup-task-priority").value=e;BX.addClass("lwPopup-task-priority-"+e,"selected")};this._clearDeadline=function(){BX("task-detail-deadline-remove").style.display="none";BX("lwPopup-task-deadline").value="";var e=BX("task-quick-detail-deadline");BX.cleanNode(e);var s=document.createElement("span");s.innerHTML=BX.message("TASKS_THERE_IS_NO_DEADLINE");e.appendChild(s);e.className="webform-field-action-link"};this._setDeadline=function(e){if(e===null||e===false||e===""){this._clearDeadline();return}BX("lwPopup-task-deadline").value=e;var s=BX("task-quick-detail-deadline");s.innerHTML=e;s.className="task-detail-deadline webform-field-action-link";BX("task-detail-deadline-remove").style.display=""};this._onGroupSelect=function(e,s){if(!e[0])return;if(e[0]["id"]==0){this._clearGroup();return}BX.adjust(BX("task-sonet-group-selector"),{text:BX.message("TASKS_GROUP")+": "+e[0].title});var t=BX.findNextSibling(BX("task-sonet-group-selector"),{tag:"span",className:"task-group-delete"});if(t){BX.adjust(t,{events:{click:function(s){if(!s)s=window.event;BX.Tasks.lwPopup.createForm.objTemplate._clearGroup(e[0].id)}}})}else{BX("task-sonet-group-selector").parentNode.appendChild(BX.create("span",{props:{className:"task-group-delete"},events:{click:function(s){if(!s)s=window.event;BX.Tasks.lwPopup.createForm.objTemplate._clearGroup(e[0].id)}}}))}var a=BX.findNextSibling(BX("task-sonet-group-selector"),{tag:"input",className:"tasks-notclass-GROUP_ID"});if(a){BX.adjust(a,{props:{value:e[0].id}});var i=BX.findNextSibling(BX("task-sonet-group-selector"),{tag:"input",className:"tasks-notclass-GROUP_NAME"});BX.adjust(i,{props:{value:e[0].title}})}else{BX("task-sonet-group-selector").parentNode.appendChild(BX.create("input",{props:{id:"lwPopup-task-group-id",name:"GROUP_ID",className:"tasks-notclass-GROUP_ID",type:"hidden",value:e[0].id}}));BX("task-sonet-group-selector").parentNode.appendChild(BX.create("input",{props:{name:"GROUP_NAME",className:"tasks-notclass-GROUP_NAME",type:"hidden",value:e[0].title}}))}this.__checkWarnings()};this._clearGroup=function(e){this.__checkWarnings();BX.adjust(BX("task-sonet-group-selector"),{text:BX.message("TASKS_GROUP")});var s=BX.findNextSibling(BX("task-sonet-group-selector"),{tag:"span",className:"task-group-delete"});if(s){BX.cleanNode(s,true)}var t=BX.findNextSibling(BX("task-sonet-group-selector"),{tag:"input",className:"tasks-notclass-GROUP_ID"});if(t){t.value=0}var t=BX.findNextSibling(BX("task-sonet-group-selector"),{tag:"input",className:"tasks-notclass-GROUP_NAME"});if(t){t.value=""}if(e)o.deselect(e)};this._showAccomplicesSelector=function(e){l.showUserSelector(e)};this._onAccomplicesSelect=function(e){var s=[];BX.cleanNode(BX("task-accomplices-list"));var t=BX("task-accomplices-link");var a=e.length;for(i=0;i<a;i++){BX("task-accomplices-list").appendChild(BX.create("div",{props:{className:"task-assistant-item"},children:[BX.create("span",{props:{className:"task-assistant-link",href:BX.Tasks.lwPopup.pathToUser.replace("#user_id#",e[i].id),target:"_blank",title:e[i].name},text:e[i].name})]}));s.push(e[i].id)}if(s.length>0){if(t.innerHTML.substr(t.innerHTML.length-1)!=":")t.innerHTML=t.innerHTML+":"}else{if(t.innerHTML.substr(t.innerHTML.length-1)==":")t.innerHTML=t.innerHTML.substr(0,t.innerHTML.length-1)}BX("lwPopup-task-accomplices-id").value=s.join(",")};this._onResponsibleSelect=function(e){BX("lwPopup-task-responsible-id").value=e.id;if(e.id==BX.Tasks.lwPopup.loggedInUserId){BX("lwPopup-task-control").checked=false;BX.addClass(BX("lwPopup-task-control").parentNode,"webform-field-checkbox-option-disabled");BX("lwPopup-task-control").disabled=true}else{BX("lwPopup-task-control").disabled=false;BX.removeClass(BX("lwPopup-task-control").parentNode,"webform-field-checkbox-option-disabled");if(BX.message("TASKS_META_OPTION_TASK_CONTROL")==="Y")BX("lwPopup-task-control").checked=true;else BX("lwPopup-task-control").checked=false}this.__checkWarnings()};this._onFilesUploaded=function(e,s){for(i=0;i<e.length;i++){var t=BX("file-"+i+"-"+s);if(e[i].fileID){BX.removeClass(t,"uploading");BX.adjust(t.firstChild,{props:{href:e[i].fileULR}});BX.unbindAll(t.firstChild);BX.unbindAll(t.lastChild);BX.bind(t.lastChild,"click",BX.Tasks.lwPopup.createForm.objTemplate._deleteFile);t.appendChild(BX.create("input",{props:{type:"hidden",name:"FILES[]",value:e[i].fileID}}))}else{BX.cleanNode(t,true)}}BX.cleanNode(BX("iframe-"+s),true)};this._deleteFile=function(e){if(!e)e=window.event;if(confirm(BX.message("TASKS_DELETE_CONFIRM"))){if(!BX.hasClass(this.parentNode,"saved")){var s={fileID:this.nextSibling.value,sessid:BX.message("bitrix_sessid"),mode:"delete"};var t="/bitrix/components/bitrix/tasks.task.edit/upload.php";BX.ajax.post(t,s)}BX.remove(this.parentNode)}BX.PreventDefault(e)};this._onFilesChange=function(){var e=[];if(this.files&&this.files.length>0){e=this.files}else{var s=this.value;var t=s.replace(/.*\\(.*)/,"$1");t=t.replace(/.*\/(.*)/,"$1");e=[{fileName:t}]}var a;do{a=Math.floor(Math.random()*99999)}while(BX("iframe-"+a));var i=BX("webform-field-upload-list");var l=[];var o="";for(var r=0;r<e.length;r++){if(!e[r].fileName&&e[r].name){e[r].fileName=e[r].name}o=e[r].fileName;if(o.length>=95)o=o.substr(0,91)+"...";var n=BX.create("li",{props:{className:"uploading",id:"file-"+r+"-"+a},children:[BX.create("a",{props:{href:"",target:"_blank",className:"upload-file-name",title:e[r].fileName},text:o,events:{click:function(e){BX.PreventDefault(e)}}}),BX.create("i",{}),BX.create("a",{props:{href:"",className:"delete-file"},events:{click:function(e){BX.PreventDefault(e)}}})]});i.appendChild(n);l.push(n)}var p="iframe-"+a;var c=BX.create("iframe",{props:{name:p,id:p},style:{display:"none"}});document.body.appendChild(c);var d=this.parentNode;var u=BX.create("form",{props:{method:"post",action:"/bitrix/components/bitrix/tasks.task.edit/upload.php",enctype:"multipart/form-data",encoding:"multipart/form-data",
target:p},style:{display:"none"},children:[this,BX.create("input",{props:{type:"hidden",name:"sessid",value:BX.message("bitrix_sessid")}}),BX.create("input",{props:{type:"hidden",name:"callbackFunctionName",value:"window.parent.window.BX.Tasks.lwPopup.createForm.objTemplate._onFilesUploaded"}}),BX.create("input",{props:{type:"hidden",name:"uniqueID",value:a}}),BX.create("input",{props:{type:"hidden",name:"mode",value:"upload"}})]});document.body.appendChild(u);BX.submit(u);window.setTimeout(BX.delegate(function(){d.appendChild(this);BX.cleanNode(u,true)},this),15)};this.__onWebdavFieldRedraw=function(e,s){var t=true;var a=true;this.__redrawUserField(e,s,t,a)};this.__onCrmFieldRedraw=function(e,s){var t=u;var a=false;this.__redrawUserField(e,s,t,a)};this.__redrawUserField=function(e,s,t,a){var i=null;var l=null;var o="lwPopup-task-UF_USER_FIELDS"+s;if(BX(o))BX.remove(BX(o));var r=[];if(!a){r.push(BX.create("td",{props:{className:"task-property-name"},html:BX.util.htmlspecialchars(e)}))}r.push(i=BX.create("td",{props:{className:"task-property-value"},html:""}));BX("lwPopup-task-grey-area").appendChild(l=BX.create("div",{props:{id:o,className:"webform-row task-additional-properties-row"},children:[BX.create("div",{html:"&nbsp;"}),BX.create("table",{attrs:{cellspacing:"0"},style:{width:"100%"},children:[BX.create("tr",{children:r})]})]}));if(!t)l.style.display="none";else l.style.display="block";i.appendChild(BX(s))};this.__cleanErrorsArea=function(){BX("lwPopup-task-errorsArea").style.display="none";BX("lwPopup-task-errorsArea-list").innerHTML=""};this.__fillErrorsArea=function(e){var s=0;var t=0;BX("lwPopup-task-errorsArea-list").innerHTML="";s=e.length;for(t=0;t<s;t++){BX("lwPopup-task-errorsArea-list").appendChild(BX.create("li",{html:BX.util.htmlspecialchars(e[t])}))}BX("lwPopup-task-errorsArea").style.display="block"};this.__checkWarnings=function(){var e=this;if(this.checkWarningsId)window.clearTimeout(this.checkWarningsId);this.checkWarningsId=window.setTimeout(function(){if(!BX("task-edit-warnings-area"))return;var e=s.objTemplate.gatherTaskDataFromForm();var t={sessid:BX.message("bitrix_sessid"),TASK:{RESPONSIBLE_ID:e.RESPONSIBLE_ID,GROUP_ID:e.GROUP_ID},action:"getWarnings"};var a=BX.ajax({method:"POST",dataType:"html",url:"/bitrix/components/bitrix/tasks.task.edit/ajax.php",data:t,async:false});if(a.responseText.length){BX("task-edit-warnings-area-message").innerHTML=a.responseText;BX("task-edit-warnings-area").style.display="block"}else{BX("task-edit-warnings-area").style.display="none";BX("task-edit-warnings-area-message").innerHTML=""}},250)}}}
//# sourceMappingURL=script.map.js