(function(e,t,i,r,n,a){"use strict";var o,d,s,l;function c(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function u(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?c(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):c(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var p="template_0";var g=function(){function e(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"grid",null);babelHelpers.defineProperty(this,"isNew",false);babelHelpers.defineProperty(this,"propertiesWithMenu",[]);this.createPropertyId=i.createPropertyId;this.createPropertyHintId=i.createPropertyHintId;this.gridId=i.gridId;this.isNew=i.isNew;this.isSimple=i.isSimple;this.isReadOnly=i.isReadOnly;this.hiddenProperties=i.hiddenProperties;this.modifyPropertyLink=i.modifyPropertyLink;this.productCopyLink=i.productCopyLink;this.gridEditData=i.gridEditData;this.canHaveSku=false;this.storeAmount=[];this.isShowedStoreReserve=false;this.reservedDealsSliderLink=i.reservedDealsSliderLink;if(i.copyItemsMap){this.getGrid().arParams.COPY_ITEMS_MAP=i.copyItemsMap}if(i.supportedAjaxFields){this.getGrid().arParams.SUPPORTED_AJAX_FIELDS=i.supportedAjaxFields}if(this.isReadOnly){return}var r=i.isGridReload||false;if(!r){this.addCustomClassToGrid();this.clearGridSettingsPopupStuff()}var n=i.gridEditData||null;if(n){this.setGridEditData(n)}if(this.isNew){this.enableEdit();this.prepareNewNodes();this.getGrid().updateCounterSelected();this.getGrid().disableCheckAllCheckboxes()}else{this.bindInlineEdit();this.bindSliderToReservedQuantityNodes()}t.Event.bind(this.getGrid().getScrollContainer(),"scroll",t.Runtime.throttle(this.onScrollHandler.bind(this),50));t.Event.bind(this.getGridSettingsButton(),"click",this.showGridSettingsWindowHandler.bind(this));this.subscribeCustomEvents()}babelHelpers.createClass(e,[{key:"subscribeCustomEvents",value:function e(){this.onGridUpdatedHandler=this.onGridUpdated.bind(this);i.EventEmitter.subscribe("Grid::updated",this.onGridUpdatedHandler);this.onPropertySaveHandler=this.onPropertySave.bind(this);i.EventEmitter.subscribe("SidePanel.Slider:onMessage",this.onPropertySaveHandler);this.onAllRowsSelectHandler=this.enableEdit.bind(this);i.EventEmitter.subscribe("Grid::allRowsSelected",this.onAllRowsSelectHandler);this.onAllRowsUnselectHandler=this.disableEdit.bind(this);i.EventEmitter.subscribe("Grid::allRowsUnselected",this.onAllRowsUnselectHandler);this.showPropertySettingsSliderHandler=this.showPropertySettingsSlider.bind(this);i.EventEmitter.subscribe("ServiceGrid::propertyModify",this.showPropertySettingsSliderHandler);this.onPrepareDropDownItemsHandler=this.onPrepareDropDownItems.bind(this);i.EventEmitter.subscribe("Dropdown::onPrepareItems",this.onPrepareDropDownItemsHandler);this.onCreatePopupHandler=this.onCreatePopup.bind(this);i.EventEmitter.subscribe("UiSelect::onCreatePopup",this.onCreatePopupHandler)}},{key:"destroy",value:function e(){this.unsubscribeCustomEvents()}},{key:"unsubscribeCustomEvents",value:function e(){if(this.onGridUpdatedHandler){i.EventEmitter.unsubscribe("Grid::updated",this.onGridUpdatedHandler);this.onGridUpdatedHandler=null}if(this.onPropertySaveHandler){i.EventEmitter.unsubscribe("SidePanel.Slider:onMessage",this.onPropertySaveHandler);this.onPropertySaveHandler=null}if(this.showPropertySettingsSliderHandler){i.EventEmitter.unsubscribe("ServiceGrid::propertyModify",this.showPropertySettingsSliderHandler);this.showPropertySettingsSliderHandler=null}if(this.onPrepareDropDownItemsHandler){i.EventEmitter.unsubscribe("Dropdown::onPrepareItems",this.onPrepareDropDownItemsHandler);this.onPrepareDropDownItemsHandler=null}if(this.onAllRowsSelectHandler){i.EventEmitter.unsubscribe("Grid::allRowsSelected",this.onAllRowsSelectHandler);this.onAllRowsSelectHandler=null}if(this.onAllRowsUnselectHandler){i.EventEmitter.unsubscribe("Grid::allRowsUnselected",this.onAllRowsUnselectHandler);this.onAllRowsUnselectHandler=null}if(this.onCreatePopupHandler){i.EventEmitter.unsubscribe("UiSelect::onCreatePopup",this.onCreatePopupHandler);this.onCreatePopupHandler=null}}},{key:"getGridSettingsButton",value:function e(){return this.getGrid().getContainer().querySelector("."+this.getGrid().settings.get("classSettingsButton"))}},{key:"showGridSettingsWindowHandler",value:function e(t){t.preventDefault();t.stopPropagation();this.getGrid().getSettingsWindow()._onSettingsButtonClick()}},{key:"onScrollHandler",value:function e(t){var i=r.PopupManager.getCurrentPopup();if(i){i.close()}this.propertiesWithMenu.forEach((function(e){var t=r.MenuManager.getMenuById(e+"_menu");if(t){t.close()}}))}},{key:"onPrepareDropDownItems",value:function e(i){var r=i.getData(),n=babelHelpers.slicedToArray(r,3),a=n[0],o=n[1],d=n[2];if(!t.Type.isStringFilled(a)){return}this.propertiesWithMenu.push(a);if(a.indexOf("SKU_GRID_PROPERTY_")===-1){return}if(!t.Type.isArray(d)){return}var s=d.filter((function(e){return e.action==="create-new"}));if(s.length>0){return}var l=a.replace("SKU_GRID_PROPERTY_","").replace("_control","");d.push({action:"create-new",html:'\n\t\t\t\t<li data-role="createItem" class="catalog-productcard-popup-select-item catalog-productcard-popup-select-item-new">\n\t\t\t\t\t<label class="catalog-productcard-popup-select-label main-dropdown-item" data-pseudo="true">\n\t\t\t\t\t\t<span class="catalog-productcard-popup-select-add"></span>\n\t\t\t\t\t\t<span class="catalog-productcard-popup-select-text">\n\t\t\t\t\t\t\t'.concat(t.Loc.getMessage("C_PVG_ADD_NEW_PROPERTY_VALUE_BUTTON"),"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</label>\n\t\t\t\t</li>"),onclick:function e(){return BX.Catalog.ServiceGrid.firePropertyModification(l,o)}});requestAnimationFrame((function(){var e=document.getElementById("menu-popup-"+o);t.Dom.addClass(e,"catalog-productcard-popup-list")}))}},{key:"onCreatePopup",value:function e(i){var r;var n=i.getData(),a=babelHelpers.slicedToArray(n,1),d=a[0];var s=d===null||d===void 0?void 0:(r=d.bindElement)===null||r===void 0?void 0:r.id;if(!t.Type.isStringFilled(s)){return}if(s.indexOf("SKU_GRID_PROPERTY_")===-1){return}var l=s.replace("SKU_GRID_PROPERTY_","").replace("_control","");var c=t.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="catalog-productcard-popup-select-item catalog-productcard-popup-multi-select-item-new">\n\t\t\t\t<label\n\t\t\t\t\tclass="catalog-productcard-popup-select-label main-dropdown-item">\n\t\t\t\t\t<span class="catalog-productcard-popup-select-add"></span>\n\t\t\t\t\t<span class="catalog-productcard-popup-select-text">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t"])),t.Loc.getMessage("C_PVG_ADD_NEW_PROPERTY_VALUE_BUTTON"));t.Event.bind(c,"mousedown",BX.Catalog.ServiceGrid.firePropertyModification.bind(this,l));d.contentContainer.appendChild(c)}},{key:"clearGridSettingsPopupStuff",value:function e(){t.Dom.remove(document.getElementById(this.gridId+"-grid-settings-window"))}},{key:"addCustomClassToGrid",value:function e(){t.Dom.addClass(this.getGrid().getContainer(),"catalog-product-variation-grid")}},{key:"getGrid",value:function e(){if(this.grid===null){if(!t.Reflection.getClass("BX.Main.gridManager.getInstanceById")){throw Error("Cannot find grid with '".concat(this.gridId,"' id."))}this.grid=BX.Main.gridManager.getInstanceById(this.gridId)}return this.grid}},{key:"bindSliderToReservedQuantityNodes",value:function e(){var i=this;var r=this.getGrid().getRows().getRows();r.forEach((function(e){if(e.isBodyChild()&&!e.isTemplate()){var r=e.getNode().querySelector(".main-grid-cell-content-catalog-reserved-quantity");if(t.Type.isDomNode(r)){t.Event.bind(r,"click",i.openDealsWithReservedProductSlider.bind(i,e.getId()))}}}))}},{key:"openDealsWithReservedProductSlider",value:function e(i){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;if(!this.reservedDealsSliderLink){return}var n=new t.Uri(this.reservedDealsSliderLink);n.setQueryParam("productId",i);if(r>0){n.setQueryParam("storeId",r)}BX.SidePanel.Instance.open(n.toString(),{allowChangeHistory:false,cacheable:false})}},{key:"addCellToTable",value:function e(i,r,n){var a=arguments.length>3&&arguments[3]!==undefined?arguments[3]:"right";var o=n?"main-grid-cell-head main-grid-col-no-sortable main-grid-cell-":"main-grid-cell main-grid-cell-";var s=n?"main-grid-cell-head-container":"main-grid-cell-content";var l=i.insertCell();l.className=o+a;l.appendChild(t.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="main-grid-cell-inner">\n\t\t\t\t<span class="','">\n\t\t\t\t\t',"\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t"])),s,r))}},{key:"emitEditedRowsEvent",value:function e(){if(this.getGrid().getRows().isSelected()){i.EventEmitter.emit("Grid::thereEditedRows",[])}else{i.EventEmitter.emit("Grid::noEditedRows",[])}}},{key:"disableEdit",value:function e(){if(this.isNew){return}this.getGrid().getRows().getRows().forEach((function(e){if(!t.Dom.hasClass(e.getNode(),"main-grid-row-new")){e.editCancel();e.unselect()}}));this.emitEditedRowsEvent()}},{key:"enableEdit",value:function e(){this.getGrid().getRows().selectAll();this.getGrid().getRows().editSelected()}},{key:"prepareNewNodes",value:function e(){var t=this;this.getGrid().getRows().getBodyChild().map((function(e){var i=e.getNode();t.markNodeAsNew(i);t.addSkuListCreationItem(i);t.modifyCustomSkuProperties(i);t.disableCheckbox(e)}))}},{key:"disableCheckbox",value:function e(i){var r=i.getCheckbox();if(t.Type.isDomNode(r)){r.setAttribute("disabled","disabled")}}},{key:"markNodeAsNew",value:function e(i){t.Dom.addClass(i,"main-grid-row-new")}},{key:"bindInlineEdit",value:function e(){var i=this;this.getGrid().getRows().getBodyChild().forEach((function(e){return t.Event.bind(e.node,"click",(function(t){return i.toggleInlineEdit(e,t)}))}))}},{key:"getEditorInstance",value:function e(){if(t.Reflection.getClass("BX.UI.EntityEditor")){return BX.UI.EntityEditor.getDefault()}return null}},{key:"toggleInlineEdit",value:function e(i,r){var n=this;var a=false;if(i.isEdit()){if(this.hasClickedOnCheckboxArea(i,r.target)){a=true;this.deactivateInlineEdit(i)}}else{if(r.target.nodeName!=="A"){a=true;this.activateInlineEdit(i)}if(this.isSimple){var o,d;(o=i.getNode())===null||o===void 0?void 0:o.querySelectorAll(".main-grid-editor.main-dropdown.main-grid-editor-dropdown").forEach((function(e){var i=e.id;if(t.Type.isNil(i)||i.indexOf("SKU_GRID_PROPERTY_")===-1){return}t.Event.unbindAll(e);t.Event.bind(e,"click",n.openSimpleProductRestrictionPopup.bind(n))}));(d=i.getNode())===null||d===void 0?void 0:d.querySelectorAll(".catalog-productcard-select-container .catalog-productcard-select-block").forEach((function(e){e.onclick=null;t.Event.unbindAll(e);t.Event.bind(e,"click",n.openSimpleProductRestrictionPopup.bind(n))}))}}if(a){this.emitEditedRowsEvent();this.getGrid().adjustRows();this.getGrid().updateCounterSelected();this.getGrid().updateCounterDisplayed();this.getGrid().adjustCheckAllCheckboxes()}}},{key:"hasClickedOnCheckboxArea",value:function e(i,r){if(!t.Type.isDomNode(r)){return}var n=i.getCells();for(var a in n){if(n.hasOwnProperty(a)&&n[a].contains(i.getCheckbox())&&(n[a]===r||n[a].contains(r))){return true}}return false}},{key:"activateInlineEdit",value:function e(t){t.select();t.edit();this.addSkuListCreationItem(t.getNode())}},{key:"deactivateInlineEdit",value:function e(t){var i=this;t.editCancel();t.unselect();this.getGrid().clickPrevent=true;setTimeout((function(){i.getGrid().clickPrevent=false}),100)}},{key:"modifyCustomSkuProperties",value:function e(t){var i="_"+t.getAttribute("data-id");t.querySelectorAll('input[type="radio"]').forEach((function(e){e.id+=i;e.setAttribute("name",e.getAttribute("name")+i)}));t.querySelectorAll("label[data-role]").forEach((function(e){e.setAttribute("for",e.getAttribute("for")+i)}))}},{key:"addSkuListCreationItem",value:function e(i){i.querySelectorAll('[data-role="dropdownContent"] ul').forEach((function(e){if(!e.querySelector('[data-role="createItem"]')){var i=e.getAttribute("data-propertyId");var r=t.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<li data-role="createItem"\n\t\t\t\t\t\t class="catalog-productcard-popup-select-item catalog-productcard-popup-select-item-new"\n\t\t\t\t\t\t onclick="BX.Catalog.ServiceGrid.firePropertyModification(',')">\n\t\t\t\t\t\t<label class="catalog-productcard-popup-select-label">\n\t\t\t\t\t\t\t<span class="catalog-productcard-popup-select-add"></span>\n\t\t\t\t\t\t\t<span class="catalog-productcard-popup-select-text">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</li>"])),i,t.Loc.getMessage("C_PVG_ADD_NEW_PROPERTY_VALUE_BUTTON"));e.appendChild(r)}}))}},{key:"updateCounterTotal",value:function e(){var t=this.getGrid();var i=t.getCounterTotal().querySelector(".main-grid-panel-content-text");i.textContent=t.getRows().getCountDisplayed()}},{key:"setDeleteButton",value:function e(i){var r;var n=i.querySelector(".main-grid-cell-action .main-grid-cell-content");var a=i===null||i===void 0?void 0:(r=i.dataset)===null||r===void 0?void 0:r.id;if(a){var o=t.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span\n\t\t\t\t\tclass="main-grid-delete-button"\n\t\t\t\t\tonclick="','"\n\t\t\t\t></span>\n\t\t\t'])),this.removeNewRowFromGrid.bind(this,a));t.Dom.append(o,n)}}},{key:"getGridEditData",value:function e(){return this.getGrid().arParams.EDITABLE_DATA}},{key:"setGridEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA=t}},{key:"setOriginalTemplateEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA[p]=t}},{key:"redefineTemplateEditData",value:function e(){var t=this.getEditDataFromSelectedValues();if(!t){t=this.getEditDataFromNotSelectedValues()}if(t){t=u({},t);this.prepareNewRowData(t);var i=this.getGridEditData();var r=i[p];var n=this.prepareCustomEditData(r);this.setOriginalTemplateEditData(u(u(u({},r),t),n));return r}return null}},{key:"getEditDataFromSelectedValues",value:function e(){var t=this.getGrid().getRows().getSelected();return t.length?t[0].editGetValues():null}},{key:"getEditDataFromNotSelectedValues",value:function e(){var i=this.getGrid().arParams.EDITABLE_DATA;var r=Object.keys(i).reverse().find((function(e){return e!==p&&t.Type.isPlainObject(i[e])}));return r?i[r]:null}},{key:"prepareNewRowData",value:function e(t){for(var i in t){if(t.hasOwnProperty(i)&&(i.includes("[VIEW_HTML]")||i.includes("[EDIT_HTML]"))){delete t[i]}}t["SKU_GRID_BARCODE"]='<div data-role="barcode-selector"></div>'}},{key:"prepareCustomEditData",value:function e(t){var i={};for(var r in t){if(t.hasOwnProperty(r)&&r.includes("[EDIT_HTML]")){if(t[r].indexOf("new BX.UI.ImageInput")>=0){var n="bx_file_"+r.replace("[EDIT_HTML]","").toLowerCase()+"_";var a=t[r].match(new RegExp("'("+n+"[A-Za-z0-9_]+)'"));if(a[1]){i[r]=t[r].replace(new RegExp(a[1],"g"),n+this.getRandomInt())}}}}return i}},{key:"getRandomInt",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1e5;return Math.floor(Math.random()*Math.floor(t))}},{key:"getHeaderNames",value:function e(){var t=[];var i=this.getGrid().getRows().getHeadFirstChild().getCells();Array.from(i).forEach((function(e){if("name"in e.dataset){t.push(e.dataset.name)}}));return t}},{key:"addPropertyToGridHeader",value:function e(t){var i=this;BX.ajax.runComponentAction("bitrix:catalog.productcard.service.grid","addPropertyHeader",{mode:"ajax",data:{gridId:this.getGrid().getId(),propertyCode:t.id,anchor:t.anchor||null,currentHeaders:this.getHeaderNames()}}).then((function(e){i.reloadGrid()}))}},{key:"reloadGrid",value:function e(){this.getGrid().reload()}},{key:"onGridUpdated",value:function e(t){var i=this;this.getGrid().getSettingsWindow().getItems().forEach((function(e){if(i.getHeaderNames().indexOf(e.node.dataset.name)!==-1){e.state.selected=true;e.checkbox.checked=true}else{e.state.selected=false;e.checkbox.checked=false}}))}},{key:"onPropertySave",value:function e(t){var i=t.getCompatData(),r=babelHelpers.slicedToArray(i,1),n=r[0];if(n.getEventId()==="PropertyCreationForm:onAdd"){var a=n.getData();this.addPropertyToGridHeader({id:a.fields.CODE})}if(n.getEventId()==="PropertyCreationForm:onModify"){this.reloadGrid()}}},{key:"showPropertySettingsSlider",value:function e(t){var i=t.getData(),r=babelHelpers.slicedToArray(i,1),n=r[0];var a=this.modifyPropertyLink.replace("#PROPERTY_ID#",n);BX.SidePanel.Instance.open(a,{width:550,allowChangeHistory:false,cacheable:false})}},{key:"isGridInEditMode",value:function e(){return this.getGrid().getRows().getBodyChild().filter((function(e){return e.isShown()&&e.isEdit()})).length>0}}],[{key:"firePropertyModification",value:function e(t,n){if(n){var a=r.MenuManager.getMenuById(n);if(a){a.close();a.destroy()}}else{var o=r.PopupManager.getCurrentPopup();if(o){o.close()}}i.EventEmitter.emit("ServiceGrid::propertyModify",[t])}}]);return e}();t.Reflection.namespace("BX.Catalog").ProductServiceGrid=g})(this.window=this.window||{},BX,BX.Event,BX.Main,BX.UI.Dialogs,BX.UI.EntitySelector);
//# sourceMappingURL=script.map.js