if(typeof BX.CrmOrderCheckDetails==="undefined"){BX.CrmOrderCheckDetails=function(){};BX.CrmOrderCheckDetails.Edit=function(){this._ajaxUrl=null;this._isMultiple=false;this._data={MAIN:{},ADDITION:[],TYPE:null,ORDER_ID:null};this._typeList=[];this._mainOptionList=[];this._additionOptionList=[]};BX.CrmOrderCheckDetails.Edit.prototype.initialize=function(t){if(BX.type.isPlainObject(t.DATA)){if(BX.type.isPlainObject(t.DATA.MAIN)){this.setData("MAIN",t.DATA.MAIN)}if(BX.type.isArray(t.DATA.ADDITION)){this.setData("ADDITION",t.DATA.ADDITION)}this.setData("TYPE",t.DATA.TYPE);this.setData("ORDER_ID",t.DATA.ORDER_ID)}this._ajaxUrl=t.AJAX_URL||"";this._showUrl=t.SHOW_URL||"";this._typeOptionList=BX.type.isArray(t.TYPE_LIST)?t.TYPE_LIST:[];this._mainOptionList=BX.type.isArray(t.MAIN_LIST)?t.MAIN_LIST:[];this.initAdditionList(t.ADDITION_LIST);this._isMultiple=t.IS_MULTIPLE==="Y";this._typeBlock=BX("crm-order-check-add-type");this._mainBlock=BX("crm-order-check-add-main-entity");this._additionBlock=BX("crm-order-check-add-addition-entity");this._addCheckButton=BX("add_check_button");this._cancelCheckButton=BX("cancel_check_button");this._isSaving=false;this.layout()};BX.CrmOrderCheckDetails.Edit.prototype.initAdditionList=function(t){var e=typeof{additions:1}==="object";var i=0;this._additionOptionList=e?t:[];if(e){i=Object.keys(this._additionOptionList).length}else{i=this._additionOptionList.length}this._paymentTypeMap={};for(var a=0;a<i;a++){if(this._additionOptionList[a]&&this._additionOptionList[a]["PAYMENT_SELECTED_TYPE"]){var s=this._additionOptionList[a]["VALUE"];this.setPaymentTypeForItem(s,this._additionOptionList[a]["PAYMENT_SELECTED_TYPE"]["CODE"])}}};BX.CrmOrderCheckDetails.Edit.prototype.layout=function(){BX.bind(this._addCheckButton,"click",BX.delegate(this.save,this));BX.bind(this._cancelCheckButton,"click",BX.delegate(this.cancel,this));this.bindMainBlockSelect();this.bindTypeBlockSelect();this.layoutAdditionBlock()};BX.CrmOrderCheckDetails.Edit.prototype.bindMainBlockSelect=function(){BX.bind(this._mainBlock,"click",BX.delegate(function(t){var e=this._mainBlock.id+"_selector";var i=t.target;var a=[];for(var s=0;s<this._mainOptionList.length;s++){var n=this._mainOptionList[s];if(BX.type.isNotEmptyString(n["NAME"])&&BX.type.isNotEmptyString(n["VALUE"])&&BX.type.isNotEmptyString(n["TYPE"])){a.push({text:n["NAME"],value:n["VALUE"],type:n["TYPE"],onclick:BX.delegate(function(t,a){var s={VALUE:a.value,TYPE:a.type};this.setData("MAIN",s);this.onChangeData();i.innerHTML=a.text;this.onMenuClose(i,e)},this)})}}BX.addClass(i,"active");BX.PopupMenu.show(e,i,a,{angle:false,width:i.offsetWidth+"px",events:{onPopupClose:BX.delegate(function(){this.onMenuClose(i,e)},this)}})},this))};BX.CrmOrderCheckDetails.Edit.prototype.bindTypeBlockSelect=function(){BX.bind(this._typeBlock,"click",BX.delegate(function(t){var e=this._typeBlock.id+"_selector";var i=t.target;var a=[];for(var s=0;s<this._typeOptionList.length;s++){var n=this._typeOptionList[s];if(BX.type.isNotEmptyString(n["NAME"])&&BX.type.isNotEmptyString(n["VALUE"])){a.push({text:n["NAME"],value:n["VALUE"],onclick:BX.delegate(function(t,a){this.setData("TYPE",a.value);this.onChangeData();i.innerHTML=BX.util.htmlspecialchars(a.text);this.onMenuClose(i,e)},this)})}}BX.addClass(i,"active");BX.PopupMenu.show(e,i,a,{angle:false,width:i.offsetWidth+"px",events:{onPopupClose:BX.delegate(function(){this.onMenuClose(i,e)},this)}})},this))};BX.CrmOrderCheckDetails.Edit.prototype.layoutAdditionBlock=function(){this._additionBlock.innerHTML="";var t=typeof{additions:1}==="object";var e=0;if(t){e=Object.keys(this._additionOptionList).length}else{e=this._additionOptionList.length}for(var i=0;i<=e;i++){if(!this._additionOptionList[i]){continue}var a=this._additionOptionList[i];var s=BX.create("label",{children:[BX.create("input",{attrs:{className:"fields boolean",type:"checkbox","bx-type":a["TYPE"],value:a["VALUE"]}}),BX.create("span",{html:a["NAME"]})],events:{click:BX.delegate(this.onAdditionSelect,this)}});var n=BX.create("DIV",{attrs:{className:"fields boolean field-wrap"},children:[BX.create("span",{attrs:{className:"fields boolean field-item"},children:[s]})]});if(BX.type.isArray(a["PAYMENT_TYPES"])){var r=BX.create("span",{attrs:{className:"crm-entity-widget-content-select","bx-value":i.toString()},text:this._additionOptionList[i]["PAYMENT_TYPES"][0]["NAME"],events:{click:BX.delegate(function(t){var e="check_addition_payment_type_selector";var i=t.target;var a=i.getAttribute("bx-value");var s=this._additionOptionList[a]["PAYMENT_TYPES"];var n=[];for(var r=0;r<s.length;r++){var o=s[r];if(BX.type.isNotEmptyString(o["NAME"])&&BX.type.isNotEmptyString(o["CODE"])){n.push({text:o["NAME"],value:o["CODE"],element:o["ENTITY_ID"],onclick:BX.delegate(function(t,a){this.setPaymentTypeForItem(a.element,a.value);i.innerHTML=BX.util.htmlspecialchars(a.text);this.refreshAdditionList();this.onMenuClose(i,e)},this)})}}BX.addClass(i,"active");BX.PopupMenu.show(e,i,n,{angle:false,width:i.offsetWidth+"px",events:{onPopupClose:BX.delegate(function(){this.onMenuClose(i,e)},this)}})},this)}});var o=BX.create("label",{children:[r]});n.appendChild(o)}this._additionBlock.appendChild(n)}if(e>0&&BX.hasClass(BX("crm-order-check-add-addition-title"),"crm-entity-widget-content-block-hidden-title")){BX.removeClass(BX("crm-order-check-add-addition-title"),"crm-entity-widget-content-block-hidden-title")}if(e===0){BX.addClass(BX("crm-order-check-add-addition-title"),"crm-entity-widget-content-block-hidden-title")}};BX.CrmOrderCheckDetails.Edit.prototype.setData=function(t,e){this._data[t]=e};BX.CrmOrderCheckDetails.Edit.prototype.getPaymentTypeFromMap=function(t){return this._paymentTypeMap[t]||null};BX.CrmOrderCheckDetails.Edit.prototype.setPaymentTypeForItem=function(t,e){this._paymentTypeMap[t]=e};BX.CrmOrderCheckDetails.Edit.prototype.onChangeData=function(){var t="GET_CHECK_DATA";var e=BX.delegate(this.refreshLayout,this);this.sendData(t,e)};BX.CrmOrderCheckDetails.Edit.prototype.save=function(){if(this._isSaving){return}this._isSaving=true;BX.addClass(this._addCheckButton,"ui-btn-wait");var t="SAVE_CHECK";var e=BX.delegate(this.onSave,this);this.sendData(t,e)};BX.CrmOrderCheckDetails.Edit.prototype.cancel=function(){window.top.BX.SidePanel.Instance.close()};BX.CrmOrderCheckDetails.Edit.prototype.sendData=function(t,e){var i=this._data;i.ACTION=t;BX.ajax({url:this._ajaxUrl,method:"POST",dataType:"json",data:i,onsuccess:e,onfailure:BX.delegate(this.showError,this)})};BX.CrmOrderCheckDetails.Edit.prototype.onMenuClose=function(t,e){BX.removeClass(t,"active");BX.PopupMenu.destroy(e)};BX.CrmOrderCheckDetails.Edit.prototype.onAdditionSelect=function(t){var e=[];if(!BX.type.isNotEmptyString(t.target.value)){return}var i=this._additionBlock.querySelectorAll("input:checked");for(var a=0;a<i.length;a++){var s=i[a];s.checked="";if(s.value&&(this._isMultiple||s.value===t.target.value)){s.checked="checked"}}this.setData("ADDITION",e);this.refreshAdditionList()};BX.CrmOrderCheckDetails.Edit.prototype.refreshAdditionList=function(){var t=[];var e=this._additionBlock.querySelectorAll("input:checked");for(var i=0;i<e.length;i++){var a=e[i];if(a.value){var s=null;if(BX.type.isNotEmptyString(this.getPaymentTypeFromMap(a.value))){s=this.getPaymentTypeFromMap(a.value)}t.push({TYPE:a.getAttribute("bx-type"),VALUE:a.value,PAYMENT_TYPE:s})}}this.setData("ADDITION",t)};BX.CrmOrderCheckDetails.Edit.prototype.getMessage=function(t){var e=BX.CrmOrderCheckDetails.Edit.messages;return e.hasOwnProperty(t)?e[t]:t};BX.CrmOrderCheckDetails.Edit.prototype.refreshLayout=function(t){if(BX.type.isPlainObject(t.DATA)){this._typeOptionList=t.DATA.CHECK_TYPES;this.initAdditionList(t.DATA.ADDITION_LIST);this.setData("ADDITION",[]);this.setData("TYPE",t.DATA.CURRENT_TYPE);if(BX.type.isNotEmptyString(t.DATA.CURRENT_TYPE_NAME)){this._typeBlock.innerHTML="";this._typeBlock.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-select"},text:BX.util.htmlspecialchars(t.DATA.CURRENT_TYPE_NAME)}))}this.layoutAdditionBlock()}else if(BX.type.isNotEmptyString(t.ERROR)){this.showError(t.ERROR)}};BX.CrmOrderCheckDetails.Edit.prototype.showError=function(t){this.clearError();BX("check_form_error_block").appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-error-text"},text:BX.util.htmlspecialchars(t)}))};BX.CrmOrderCheckDetails.Edit.prototype.clearError=function(){BX("check_form_error_block").innerHTML=""};BX.CrmOrderCheckDetails.Edit.prototype.onSave=function(t){if(BX.type.isNotEmptyString(t.ERROR)){this._isSaving=false;BX.removeClass(this._addCheckButton,"ui-btn-wait");this.showError(t.ERROR);return}var e=t.ID;var i={check_id:e};window.top.BX.SidePanel.Instance.postMessage(window,"CrmOrderPaymentCheck::Update",i);this.cancel()};BX.CrmOrderCheckDetails.Edit.create=function(t){var e=new BX.CrmOrderCheckDetails.Edit;e.initialize(t);return e}}
//# sourceMappingURL=script.map.js