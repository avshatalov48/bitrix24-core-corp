{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { Reflection, Uri, Text, ajax as Ajax } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport 'ui.alerts';\nimport 'ui.forms';\n\ntype Props = {\n\tgridId: ?string,\n};\n\n/**\n * @namespace BX.BIConnector\n */\nclass ExternalSourceManager\n{\n\t#grid: BX.Main.grid;\n\t#filter: BX.Main.Filter;\n\n\tconstructor(props: Props)\n\t{\n\t\tthis.#grid = BX.Main.gridManager.getById(props.gridId)?.instance;\n\t\tthis.#filter = BX.Main.filterManager.getById(props.gridId);\n\t\tthis.#initHints();\n\t\tthis.#subscribeToEvents();\n\t}\n\n\t#subscribeToEvents()\n\t{\n\t\tEventEmitter.subscribe('Grid::updated', () => {\n\t\t\tthis.#initHints();\n\t\t});\n\n\t\tEventEmitter.subscribe('SidePanel.Slider:onMessage', (event) => {\n\t\t\tconst [messageEvent] = event.getData();\n\t\t\tconst eventId = messageEvent.getEventId();\n\t\t\tif (\n\t\t\t\teventId === 'BIConnector:ExternalConnectionGrid:reload'\n\t\t\t\t|| eventId === 'BIConnector:ExternalConnection:onConnectionCreated'\n\t\t\t)\n\t\t\t{\n\t\t\t\tthis.#grid.reload();\n\t\t\t}\n\t\t});\n\t}\n\n\t#initHints(): void\n\t{\n\t\tconst manager = BX.UI.Hint.createInstance({\n\t\t\tpopupParameters: {\n\t\t\t\tautoHide: true,\n\t\t\t},\n\t\t});\n\t\tmanager.init(this.#grid.getContainer());\n\t}\n\n\tgetGrid(): BX.Main.grid\n\t{\n\t\treturn this.#grid;\n\t}\n\n\tgetFilter(): BX.Main.Filter\n\t{\n\t\treturn this.#filter;\n\t}\n\n\thandleCreatedByClick(ownerData: Object)\n\t{\n\t\tthis.handleDatasetFilterChange({\n\t\t\tfieldId: 'CREATED_BY_ID',\n\t\t\t...ownerData,\n\t\t});\n\t}\n\n\thandleDatasetFilterChange(fieldData: Object)\n\t{\n\t\tconst filterFieldsValues = this.getFilter().getFilterFieldsValues();\n\t\tlet currentFilteredField = filterFieldsValues[fieldData.fieldId] ?? [];\n\t\tlet currentFilteredFieldLabel = filterFieldsValues[`${fieldData.fieldId}_label`] ?? [];\n\n\t\tif (fieldData.IS_FILTERED)\n\t\t{\n\t\t\tcurrentFilteredField = currentFilteredField.filter((value) => parseInt(value, 10) !== fieldData.ID);\n\t\t\tcurrentFilteredFieldLabel = currentFilteredFieldLabel.filter((value) => value !== fieldData.TITLE);\n\t\t}\n\t\telse if (!currentFilteredField.includes(fieldData.ID))\n\t\t{\n\t\t\tcurrentFilteredField.push(fieldData.ID);\n\t\t\tcurrentFilteredFieldLabel.push(fieldData.TITLE);\n\t\t}\n\n\t\tconst filterApi = this.getFilter().getApi();\n\t\tconst filterToExtend = {};\n\t\tfilterToExtend[fieldData.fieldId] = currentFilteredField;\n\t\tfilterToExtend[`${fieldData.fieldId}_label`] = currentFilteredFieldLabel;\n\n\t\tfilterApi.extendFilter(filterToExtend);\n\t\tfilterApi.apply();\n\t}\n\n\topenSourceDetail(id: number, moduleId: string): void\n\t{\n\t\tlet sliderLink = '';\n\t\tlet sliderWidth = 0;\n\t\tlet isCacheable = false;\n\n\t\tif (moduleId === 'BI')\n\t\t{\n\t\t\tsliderLink = new Uri(`/bitrix/components/bitrix/biconnector.externalconnection/slider.php?sourceId=${id}`);\n\t\t\tsliderWidth = 564;\n\t\t\tisCacheable = false;\n\t\t}\n\t\telse if (moduleId === 'CRM')\n\t\t{\n\t\t\tsliderLink = new Uri(`/crm/tracking/source/edit/${id}/`);\n\t\t\tsliderWidth = 900;\n\t\t\tisCacheable = true;\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tBX.SidePanel.Instance.open(\n\t\t\tsliderLink.toString(),\n\t\t\t{\n\t\t\t\twidth: sliderWidth,\n\t\t\t\tallowChangeHistory: false,\n\t\t\t\tcacheable: isCacheable,\n\t\t\t},\n\t\t);\n\t}\n\n\topenCreateSourceSlider()\n\t{\n\t\tconst sliderLink = new Uri('/bitrix/components/bitrix/biconnector.apachesuperset.source.connect.list/slider.php');\n\n\t\tBX.SidePanel.Instance.open(\n\t\t\tsliderLink.toString(),\n\t\t\t{\n\t\t\t\twidth: 900,\n\t\t\t\tallowChangeHistory: false,\n\t\t\t\tcacheable: false,\n\t\t\t},\n\t\t);\n\t}\n\n\tchangeActivitySource(id: number, moduleId: string)\n\t{\n\t\tAjax.runAction('biconnector.externalsource.source.changeActivity', {\n\t\t\tdata: {\n\t\t\t\tid,\n\t\t\t\tmoduleId,\n\t\t\t},\n\t\t})\n\t\t\t.then(() => {\n\t\t\t\tthis.getGrid().reload();\n\t\t\t})\n\t\t\t.catch((response) => {\n\t\t\t\tif (response.errors)\n\t\t\t\t{\n\t\t\t\t\tthis.#notifyErrors(response.errors);\n\t\t\t\t}\n\t\t\t})\n\t\t;\n\t}\n\n\tdeleteSource(id: number, moduleId: string)\n\t{\n\t\tAjax.runAction('biconnector.externalsource.source.delete', {\n\t\t\tdata: {\n\t\t\t\tid,\n\t\t\t\tmoduleId,\n\t\t\t},\n\t\t})\n\t\t\t.then(() => {\n\t\t\t\tthis.getGrid().reload();\n\t\t\t})\n\t\t\t.catch((response) => {\n\t\t\t\tif (response.errors)\n\t\t\t\t{\n\t\t\t\t\tthis.#notifyErrors(response.errors);\n\t\t\t\t}\n\t\t\t})\n\t\t;\n\t}\n\n\t#notifyErrors(errors: Array): void\n\t{\n\t\tif (errors[0] && errors[0].message)\n\t\t{\n\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\tcontent: Text.encode(errors[0].message),\n\t\t\t});\n\t\t}\n\t}\n}\n\nReflection.namespace('BX.BIConnector').ExternalSourceManager = ExternalSourceManager;\n"],"names":["ExternalSourceManager","props","BX","Main","gridManager","getById","gridId","instance","filterManager","ownerData","handleDatasetFilterChange","fieldId","fieldData","filterFieldsValues","getFilter","getFilterFieldsValues","currentFilteredField","currentFilteredFieldLabel","IS_FILTERED","filter","value","parseInt","ID","TITLE","includes","push","filterApi","getApi","filterToExtend","extendFilter","apply","id","moduleId","sliderLink","sliderWidth","isCacheable","Uri","SidePanel","Instance","open","toString","width","allowChangeHistory","cacheable","Ajax","runAction","data","then","getGrid","reload","response","errors","EventEmitter","subscribe","event","getData","messageEvent","eventId","getEventId","manager","UI","Hint","createInstance","popupParameters","autoHide","init","getContainer","message","Notification","Center","notify","content","Text","encode","Reflection","namespace"],"mappings":"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"}