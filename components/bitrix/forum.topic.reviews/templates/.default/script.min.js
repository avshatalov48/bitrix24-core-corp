this.BX=this.BX||{};this.BX.Forum=this.BX.Forum||{};(function(e,t,i){"use strict";var n=function(){babelHelpers.createClass(e,null,[{key:"makeQuote",value:function t(i,n){var r=n.entity,a=n.messageId,o=n.text;if(e.instances[i]){e.instances[i].quote({entity:r,messageId:a,text:o})}}},{key:"makeReply",value:function t(i,n){var r=n.entity,a=n.messageId,o=n.text;if(e.instances[i]){e.instances[i].reply({entity:r,messageId:a,text:o})}}},{key:"create",value:function t(i){var n=i.formId,r=i.editorId,a=i.formNode,o=i.useAjax;if(!e.instances[n]){e.instances[n]=new e({formId:n,editorId:r,formNode:a,useAjax:o})}return e.instances[n]}}]);function e(t){var n=t.formId,r=t.editorId,a=t.formNode,o=t.useAjax;babelHelpers.classCallCheck(this,e);this.formId=n;this.editorId=r;this.currentEntity={entity:null,messageId:null};this.init=this.init.bind(this);i.EventEmitter.subscribe("OnEditorInitedAfter",this.init);this.useAjax=o===true;this.formNode=a;this.formNode.addEventListener("submit",this.submit.bind(this));this.container=this.formNode.parentNode;this.onSuccess=this.onSuccess.bind(this);this.onFailure=this.onFailure.bind(this)}babelHelpers.createClass(e,[{key:"init",value:function e(t){var n=t.target;if(n.id!==this.editorId){return}this.editor=n;n.insertImageAfterUpload=true;i.EventEmitter.unsubscribe("OnEditorInitedAfter",this.init);BX.bind(BX("post_message_hidden"),"focus",function(){n.Focus()})}},{key:"submit",value:function i(n){var r="";if(this.getLHE().editorIsLoaded){this.getLHE().oEditor.SaveContent();r=this.getLHE().oEditor.GetContent()}var a=[];if(r.length<=0){a.push(t.Loc.getMessage("JERROR_NO_MESSAGE"))}else if(r.length>e.maxMessageLength){a.push(t.Loc.getMessage("JERROR_MAX_LEN").replace(/#MAX_LENGTH#/gi,e.maxMessageLength).replace(/#LENGTH#/gi,r.length))}else if(this.isOccupied()){a.push("Occupied")}if(a.length<=0){this.occupy();if(!this.useAjax){return true}this.send()}else{alert(a.join(""))}n.stopPropagation();n.preventDefault();return false}},{key:"isOccupied",value:function e(){return this.busy===true}},{key:"occupy",value:function e(){this.busy=true;this.formNode.querySelectorAll("input[type=submit]").forEach(function(e){e.disabled=true})}},{key:"release",value:function e(){this.busy=false;this.formNode.querySelectorAll("input[type=submit]").forEach(function(e){e.disabled=false})}},{key:"send",value:function e(){var t=document.createElement("input");t.type="hidden";t.name="dataType";t.value="json";this.formNode.appendChild(t);BX.ajax.submitAjax(this.formNode,{method:"POST",url:this.formNode.action,dataType:"json",onsuccess:this.onSuccess,onfailure:this.onFailure});this.formNode.removeChild(t)}},{key:"onSuccess",value:function e(t){var n=t.status,r=t.action,a=t.data,o=t.errors;this.release();if(n!=="success"){return this.showError(a.errorHtml,o)}else if(r==="preview"){return this.showPreview(a.previewHtml)}else if(r==="add"){i.EventEmitter.emit("onForumCommentAJAXPost",[a,this.formNode]);i.EventEmitter.emit(this.currentEntity.entity,"onForumCommentAdded",a);return this.clear()}this.showError("There is nothing")}},{key:"onFailure",value:function e(){this.release();this.showError('<b class="error">Some error with response</b>')}},{key:"showError",value:function e(t){var i=this.container.querySelector("div[data-bx-role=error]");i.innerHTML=t;this.container.setAttribute("data-bx-status","errored");i.style.display="block"}},{key:"hideError",value:function e(){var t=this.container.querySelector("div[data-bx-role=error]");t.innerHTML="";this.container.removeAttribute("data-bx-status","errored");t.style.display="none"}},{key:"showPreview",value:function e(t){var i=this.container.querySelector("div[data-bx-role=preview]");i.innerHTML=t;this.container.setAttribute("data-bx-status","preview");i.style.display="block"}},{key:"hidePreview",value:function e(){var t=this.container.querySelector("div[data-bx-role=preview]");t.innerHTML="";this.container.setAttribute("data-bx-status","preview");t.style.display="none"}},{key:"isFormReady",value:function e(t){var i=t.entity,n=t.messageId;if(this.currentEntity.entity===null||this.currentEntity.entity===i){return true}return window.confirm("Do you want to miss all changes?")}},{key:"parseText",value:function e(i){var n=this.getLHE().oEditor;var r=i;if(r.length>0&&n.GetViewMode()==="wysiwyg"){var a=/^\[USER\=(\d+)\](.+?)\[\/USER\]/i;if(a.test(r)){r=r.replace(a,function(){var e=parseInt(arguments[1]);var i=t.Text.encode(arguments[2]);var r="<span>".concat(i,"</span>");if(e>0){var a=n.SetBxTag(false,{tag:"postuser",params:{value:e}});r='<span id="'.concat(a,'" class="bxhtmled-metion">').concat(i,"</span>")}return r}.bind(this))}}return r}},{key:"reply",value:function e(t){var i=this;var n=t.entity,r=t.messageId,a=t.text;this.show({entity:n,messageId:r}).then(function(){if(a!==""){var e=i.getLHE().oEditor;var t=i.parseText(a);e.action.Exec("insertHTML",t)}})}},{key:"quote",value:function e(t){var i=this;var n=t.entity,r=t.messageId,a=t.text;this.show({entity:n,messageId:r}).then(function(){var e=i.getLHE().oEditor;if(!e.toolbar.controls.Quote){return}var t=i.parseText(a);if(e.action.actions.quote.setExternalSelectionFromRange){e.action.actions.quote.setExternalSelection(t)}e.action.Exec("quote")})}},{key:"clear",value:function e(){this.hideError();this.hidePreview();this.editor.CheckAndReInit("");if(this.editor.fAutosave&&this.editor.pEditorDocument){this.editor.pEditorDocument.addEventListener("keydown",this.editor.fAutosave.Init.bind(this.editor.fAutosave))}this.formNode.querySelectorAll(".reviews-preview").forEach(function(e){e.parentNode.removeChild(e)});this.formNode.querySelectorAll('input[type="file"]').forEach(function(e){var t=e.cloneNode();t.value="";e.parentNode.replaceChild(t,e)});var t=this.formNode.querySelector('[data-bx-role="attach-visibility"]');if(t){t.checked=false}var i=this.formNode.querySelector('input[name="captcha_word"]');if(i){i.value="";var n=this.formNode.querySelector('input[name="captcha_code"]');var r=this.formNode.querySelector('img[name="captcha_image"]');BX.ajax.getCaptcha(function(e){n.value=e["captcha_sid"];r.src="/bitrix/tools/captcha.php?captcha_code="+e["captcha_sid"]})}var a=this.formNode.querySelector('input[name="TOPIC_SUBSCRIBE"]');if(a&&a.checked){a.disabled=true}}},{key:"show",value:function e(t){var n=this;var r=t.entity,a=t.messageId;return new Promise(function(e,t){if(!n.isFormReady({entity:r,messageId:a})){return t()}var o=!!n.getLHE()&&!!n.getLHE().editorIsLoaded;if(o&&n.currentEntity.entity===r&&n.currentEntity.messageId===a){n.getLHE().oEditor.Focus();return e()}n.currentEntity.entity=r;n.currentEntity.messageId=a;n.container.style.display="block";i.EventEmitter.emit(n.currentEntity.entity,"onForumCommentFormShow",[]);i.EventEmitter.emit(n.getLHEEventNode(),"OnShowLHE",["show"]);if(o!==true){n.getLHE().exec(function(){n.show({entity:r,messageId:a}).then(e,t)})}else{e()}})}},{key:"getLHE",value:function e(){return LHEPostForm.getHandlerByFormId(this.formId)}},{key:"getLHEEventNode",value:function e(){if(!this.handlerEventNode&&this.getLHE()){this.handlerEventNode=this.getLHE().eventNode}return this.handlerEventNode}}]);return e}();babelHelpers.defineProperty(n,"maxMessageLength",64e3);babelHelpers.defineProperty(n,"instances",{});var r=function(){function e(t){var i=t.formId,n=t.container,r=t.preorder,a=t.ajaxPost;babelHelpers.classCallCheck(this,e);this.formId=i;this.container=n;this.preorder=r===true;this.ajaxPost=a===true;this.reply=this.reply.bind(this);this.quote=this.quote.bind(this);this.parseResponse=this.parseResponse.bind(this);this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){var t=this;this.container.querySelectorAll("[data-bx-role=add-new-message]").forEach(function(e){e.addEventListener("click",function(){t.reply({node:null})})});this.bindMessages();this.bindNavigation();i.EventEmitter.subscribe(this,"onForumCommentAdded",this.parseResponse);i.EventEmitter.subscribeOnce(this,"onForumCommentFormShow",function(){this.container.querySelectorAll("[data-bx-role=add-new-message]").forEach(function(e){e.parentNode.removeChild(e)})}.bind(this))}},{key:"bindMessages",value:function e(){var i=this;this.container.querySelectorAll("table").forEach(function(e){e.querySelectorAll("a[data-bx-act]").forEach(function(n){var r=n.dataset.bxAct;if(r==="reply"){t.Event.bind(n,"click",function(t){i.reply({node:e})})}else if(r==="quote"){t.Event.bind(n,"click",function(t){i.quote({node:e})})}else if(r==="hide"||r==="show"){t.Event.bind(n,"click",function(t){i.moderate({node:e,action:r,actNode:n});t.stopPropagation();t.preventDefault()})}else if(r==="del"){t.Event.bind(n,"click",function(t){i.delete({node:e});t.stopPropagation();t.preventDefault()})}})})}},{key:"bindNavigation",value:function e(){var i=this;if(!this.ajaxPost){return}this.container.querySelector("div[data-bx-role=navigation-container-top]").querySelectorAll("a").forEach(function(e){t.Event.bindOnce(e,"click",function(t){i.navigate({node:e});t.stopPropagation();t.preventDefault()})});this.container.querySelector("div[data-bx-role=navigation-container-bottom]").querySelectorAll("a").forEach(function(e){t.Event.bind(e,"click",function(t){i.navigate({node:e});t.stopPropagation();t.preventDefault()})})}},{key:"parseResponse",value:function e(i){var n=i.data;t.Runtime.html(this.container.querySelector("div[data-bx-role=messages-container]"),n.messages);t.Runtime.html(this.container.querySelector("div[data-bx-role=navigation-container-top]"),n.navigationTop);t.Runtime.html(this.container.querySelector("div[data-bx-role=navigation-container-bottom]"),n.navigationBottom);setTimeout(function(e){this.bindMessages();this.bindNavigation();if(e>0){BX.scrollToNode(this.container.querySelector("table[id=message"+e+"]"))}}.bind(this),0,n.messageId)}},{key:"getPlaceholder",value:function e(){return this.container.querySelector("[data-bx-role=placeholder]")}},{key:"navigate",value:function e(i){var n=i.node;return BX.ajax({method:"GET",dataType:"json",url:t.Uri.addParam(n.href,{ajax:"y"}),onsuccess:this.parseResponse})}},{key:"reply",value:function e(t){var i=t.node;var r=i!==null?"[USER=".concat(i.dataset.bxAuthorId,"]").concat(i.dataset.bxAuthorName,"[/USER],&nbsp;"):"";n.makeReply(this.formId,{entity:this,messageId:0,text:r})}},{key:"quote",value:function e(t){var i=t.node;var r=["[USER=".concat(i.dataset.bxAuthorId,"]").concat(i.dataset.bxAuthorName,"[/USER]<br>"),i.querySelector("div[data-bx-role=text]").innerHTML].join("");n.makeQuote(this.formId,{entity:this,messageId:0,text:r})}},{key:"moderate",value:function e(i){var n=i.node,r=i.actNode;t.ajax.runComponentAction("bitrix:forum.topic.reviews",r.dataset.bxAct+"Message",{mode:"class",data:{id:n.dataset.bxMessageId}}).then(function(e){var t=e.data;r.dataset.bxAct=t.APPROVED==="Y"?"hide":"show";if(t.APPROVED==="Y"){n.classList.remove("reviews-post-hidden")}else{n.classList.add("reviews-post-hidden")}})}},{key:"delete",value:function e(i){var n=i.node;t.ajax.runComponentAction("bitrix:forum.topic.reviews","deleteMessage",{mode:"class",data:{id:n.dataset.bxMessageId}}).then(function(){n.parentNode.removeChild(n)})}}]);return e}();e.Entity=r;e.Form=n})(this.BX.Forum.Reviews=this.BX.Forum.Reviews||{},BX,BX.Event);
//# sourceMappingURL=script.map.js