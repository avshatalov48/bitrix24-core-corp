BX.namespace("BX.Mobile.Crm.Contact.Edit");BX.Mobile.Crm.Contact.Edit={ajaxPath:"",formActionUrl:"",formId:"",contactViewPath:"",mode:"",companyInfo:"",isRestrictedMode:false,onSelectCompanyEventName:"",photoFile:"",photoDel:"",init:function(t){if(t&&typeof t==="object"){this.ajaxPath=t.ajaxPath||"";this.formActionUrl=t.formActionUrl||"";this.formId=t.formId||"";this.contactViewPath=t.contactViewPath||"";this.mode=t.mode||"";this.isRestrictedMode=t.isRestrictedMode||false;this.leadId=t.leadId||"";this.companyInfo=t.companyInfo||"";this.companyContainerNode=document.querySelector("[data-role='mobile-crm-contact-edit-company']")||"";this.onSelectCompanyEventName=t.onSelectCompanyEventName||""}if(this.mode=="EDIT"){BXMobileApp.addCustomEvent("onCrmContactEditUpdate",BX.proxy(function(t){if(t.formId==this.formId){BXMobileApp.UI.Page.reload()}},this))}if(this.mode=="VIEW"){BXMobileApp.addCustomEvent("onCrmContactViewUpdate",BX.proxy(function(t){if(t.formId==this.formId){BXMobileApp.UI.Page.reload()}},this));BX.addCustomEvent("onSubmitAjaxSuccess",BX.proxy(function(t){if(t.formId==this.formId)BXMobileApp.onCustomEvent("onCrmContactEditUpdate",{formId:this.formId},true)},this))}if(this.mode=="CREATE"||this.mode=="CONVERT"){var e=function(){BX.removeCustomEvent("onOpenPageAfter",e);app.closeModalDialog()};BX.addCustomEvent("onCrmContactClose",function(){if(!(window.isCurrentPage&&window.isCurrentPage=="Y")){BX.addCustomEvent("onOpenPageAfter",e)}else{window.isCurrentPage=""}})}var o={entityContainerNode:this.companyContainerNode,entityInfo:this.companyInfo,isRestrictedMode:this.isRestrictedMode,isMultiEntity:true,onSelectEventName:this.onSelectCompanyEventName};this.companyEditor=new BX.Mobile.Crm.EntityEditor(o);BX.addCustomEvent("onCrmContactDetailDelete",function(){BXMobileApp.onCustomEvent("onCrmContactListUpdate",{},true);BXMobileApp.UI.Page.close({drop:true})});if(this.mode=="VIEW"){BXMobileApp.addCustomEvent("onSubmitForm",BX.proxy(function(t,e,o){if(t.formId==this.formId){if(o.checked==false||!o.hasAttribute("checked")){var i=BX.create("INPUT",{attrs:{type:"hidden",name:o.name,value:""}});o.parentNode.insertBefore(i,o)}}},this));BX.addCustomEvent("onSubmitAjaxSuccess",BX.proxy(function(t){if(t.hasOwnProperty("formId")&&t.formId==this.formId){BXMobileApp.onCustomEvent("onCrmContactListUpdate",{},true)}},this))}if(this.mode=="EDIT"||this.mode=="CREATE"){var i=BX.delegate(function(t,e,o){if(t==this.formId&&o){BX.addCustomEvent(o,"onChange",BX.proxy(this.onChangePhoto,this))}},this);BX.addCustomEvent("onInitialized",i);var a=BX.Mobile.Grid.Form.getByFormId(this.formId);i(this.formId,"",a)}},onChangePhoto:function(t,e,o,i){if(!(typeof i==="object"&&i))return;if(i.action=="add"){this.photoFile=i.file}else if(i.action=="delete"){this.photoDel="Y";this.photoFile=""}},submit:function(){BXMobileApp.UI.Page.LoadingScreen.show();var t=BX(this.formId);if(t){var e={sessid:BX.bitrix_sessid()};if(this.leadId){e["lead_id"]=this.leadId;e["continue"]="Y"}else{e["save"]="Y"}if(this.companyEditor){e["COMPANY_IDS"]=this.companyEditor.curEntityId;for(var o in this.companyEditor.curEntityId){if(this.companyEditor.curEntityId[o]==0){e["NEW_COMPANY_TITLE"]=this.companyEditor.entityInfo[o]["name"];break}}}BX.Mobile.Crm.Detail.collectInterfaceFormData(t,e);var i=new FormData;for(var a in e){if(e.hasOwnProperty(a)){i.append(a,e[a])}}if(this.photoFile){i.append("PHOTO",this.photoFile,this.photoFile.name)}else if(this.photoDel=="Y"){i.append("PHOTO_del","Y");i.append("PHOTO",BX.UploaderUtils.dataURLToBlob("data:image/jpg;base64"),"")}BX.ajax({method:"POST",dataType:"json",url:this.formActionUrl,data:i,preparePost:false,onsuccess:BX.proxy(function(t){if(t.error){BX.Mobile.Crm.showErrorAlert(t.error)}else{if(this.mode=="EDIT"){BXMobileApp.onCustomEvent("onCrmContactListUpdate",{},true);BXMobileApp.onCustomEvent("onCrmContactViewUpdate",{formId:this.formId},true);app.closeModalDialog({cache:false})}if(this.mode=="CREATE"){var e=this.contactViewPath.replace("#contact_id#",t.itemId);BXMobileApp.onCustomEvent("onCrmContactLoadPageBlank",{path:e},true);app.closeModalDialog({cache:false})}if(this.mode=="CONVERT"&&t.url){if(t.url.indexOf("page=edit")>0){BXMobileApp.PageManager.loadPageModal({url:t.url})}else{BXMobileApp.onCustomEvent("onCrmContactLoadPageBlank",{path:t.url,type:"convert"},true)}app.closeModalDialog({cache:false})}}BXMobileApp.UI.Page.LoadingScreen.hide()},this)})}}};