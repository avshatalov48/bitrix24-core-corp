this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(a,e,t){"use strict";var n=function(){function a(e){babelHelpers.classCallCheck(this,a);this.filterId=e.filterId;this.defaultPresetId=e.defaultPresetId;this.ajaxComponentPath=e.ajaxComponentPath;this.ajaxComponentParams=e.ajaxComponentParams}babelHelpers.createClass(a,[{key:"onClickSort",value:function a(e,n){if(!t.Dom.hasClass(e,"menu-popup-item-accept")){this.refreshIcons(e);this.saveSelection(n)}}},{key:"refreshIcons",value:function a(e){e.parentElement.childNodes.forEach(function(a){t.Dom.removeClass(a,"menu-popup-item-accept")});t.Dom.addClass(e,"menu-popup-item-accept")}},{key:"saveSelection",value:function a(e){t.ajax({method:"POST",dataType:"json",url:this.ajaxComponentPath,data:{action:"setNewTaskOrder",order:e?e:"desc",params:this.ajaxComponentParams,sessid:BX.bitrix_sessid()},onsuccess:function a(e){BX.onCustomEvent(this,"onTaskSortChanged",[e])}})}}]);return a}();function s(){var a=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-parent-task-kanban">\n\t\t\t\t<div class="tasks-scrum-kanban-group-header" style="background-color: #eaeaea;">\n\t\t\t\t\t<div class="tasks-scrum-kanban-group-header-tick">\n\t\t\t\t\t\t<div class="ui-btn ui-btn-sm ui-btn-light ui-btn-icon-angle-up"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-kanban-group-header-name">\n\t\t\t\t\t\t<a href="','">','</a>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-kanban-group-header-story-points" title="Story Points">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-kanban-container"></div>\n\t\t\t</div>\n\t\t']);s=function e(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-kanban-start">\n\t\t\t\t<div class="tasks-kanban-start-title-sm">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);r=function e(){return a};return a}var i=function(){function a(t){var s=this;babelHelpers.classCallCheck(this,a);this.filterId=t.filterId;this.siteTemplateId=t.siteTemplateId;this.ajaxComponentPath=t.ajaxComponentPath;this.ajaxComponentParams=t.ajaxComponentParams;this.sprintSelected=t.sprintSelected;this.kanbanHeader=null;this.kanban=null;this.kanbanGroupedByParentTasks=new Map;this.parentTasks=t.parentTasks;this.kanbanComponent=new n({filterId:t.filterId,defaultPresetId:t.defaultPresetId,ajaxComponentPath:t.ajaxComponentPath,ajaxComponentParams:t.ajaxComponentParams});e.EventEmitter.subscribe("BX.Main.Filter:apply",function(a){var e=a.getCompatData(),t=babelHelpers.slicedToArray(e,5),n=t[0],r=t[1],i=t[2],o=t[3],u=t[4];s.onApplyFilter(n,r,i,o,u)})}babelHelpers.createClass(a,[{key:"drawKanban",value:function a(t,n){var s=this;if(!this.sprintSelected){this.showNotSprintMessage(t);return}this.inputRenderTo=t;this.inputKanbanParams=n;this.drawKanbanHeader(t,n);this.drawKanbanWithoutGrouping(t,n);this.drawKanbanInGroupingMode(t,n);this.fillNeighborKanbans();this.adjustGroupHeadersWidth();e.EventEmitter.subscribe(this.kanban,"Kanban.Grid:onColumnAddedAsync",function(){s.adjustGroupHeadersWidth()});e.EventEmitter.subscribe(this.kanban,"Kanban.Grid:onColumnRemovedAsync",function(){setTimeout(function(){s.adjustGroupHeadersWidth()},200)})}},{key:"getKanbanHeader",value:function a(){return this.kanbanHeader}},{key:"getKanban",value:function a(){return this.kanban}},{key:"getKanbansGroupedByParentTasks",value:function a(){return this.kanbanGroupedByParentTasks}},{key:"drawKanbanInGroupingMode",value:function a(e,n){var s=this;t.Dom.addClass(e,"tasks-scrum-kanban");if(this.isParentTaskGrouping()){var r=function a(r){var i=s.createParentTaskKanbanNode(s.parentTasks[r]);var o=s.parentTasks[r]["completed"]==="Y";if(o){s.setTextDecorationToParentTaskName(i)}t.Dom.append(i,e);var u=i.querySelector(".tasks-scrum-kanban-group-header-tick");t.Event.bind(u,"click",function(){s.toggleGroupingVisibility(i)});var d=i.querySelector(".tasks-scrum-kanban-container");s.drawKanbanGroupedByParentTasks(r,d,n)};for(var i in this.parentTasks){r(i)}}}},{key:"drawKanbanHeader",value:function a(e,n){var s=t.Runtime.clone(n);s.kanbanHeader=true;s.items=[];this.kanbanHeader=new BX.Tasks.Kanban.Grid(this.getKanbanParams(e,s));this.kanbanHeader.draw()}},{key:"drawKanbanWithoutGrouping",value:function a(e,t){this.kanban=new BX.Tasks.Kanban.Grid(this.getKanbanParams(e,t));this.kanban.draw()}},{key:"drawKanbanGroupedByParentTasks",value:function a(n,s,r){var i=this;n=parseInt(n,10);var o=t.Runtime.clone(r);o.columns=this.parentTasks[n]["columns"];o.items=this.parentTasks[n]["items"];o.parentTaskId=n;o.parentTaskCompleted=this.parentTasks[n]["completed"]==="Y";var u=new BX.Tasks.Kanban.Grid(this.getKanbanParams(s,o));u.draw();if(o.parentTaskCompleted){var d=u.getRenderToContainer().closest(".tasks-scrum-parent-task-kanban");this.downGroupingVisibility(d)}e.EventEmitter.subscribe(u,"Kanban.Grid:onCompleteParentTask",function(){i.onCompleteParentTask(u)});e.EventEmitter.subscribe(u,"Kanban.Grid:onRenewParentTask",function(){i.onRenewParentTask(u)});this.kanbanGroupedByParentTasks.set(n,u)}},{key:"fillNeighborKanbans",value:function a(){var e=this;this.addNeighborKanban(this.kanbanHeader);this.addNeighborKanban(this.kanban);this.kanbanGroupedByParentTasks.forEach(function(a){e.addNeighborKanban(a)})}},{key:"addNeighborKanban",value:function a(e){this.kanbanHeader.addNeighborGrid(e);this.kanban.addNeighborGrid(e);this.kanbanGroupedByParentTasks.forEach(function(a){a.addNeighborGrid(e)})}},{key:"getKanbanParams",value:function a(e,n){return{isGroupingMode:true,gridHeader:n.kanbanHeader,parentTaskId:n.parentTaskId?n.parentTaskId:0,parentTaskCompleted:n.parentTaskCompleted?n.parentTaskCompleted:false,renderTo:e,itemType:"BX.Tasks.Kanban.Item",columnType:"BX.Tasks.Kanban.Column",canAddColumn:true,canEditColumn:true,canRemoveColumn:true,canSortColumn:true,canAddItem:true,canSortItem:true,bgColor:this.siteTemplateId,columns:n.columns,items:n.items,data:{kanbanType:"K",ajaxHandlerPath:this.ajaxComponentPath,pathToTask:n.pathToTask,pathToTaskCreate:n.pathToTaskCreate,pathToUser:n.pathToUser,addItemInSlider:n.addItemInSlider,params:this.ajaxComponentParams,gridId:this.filterId,newTaskOrder:n.newTaskOrder,setClientDate:n.setClientDate,clientDate:BX.date.format(BX.date.convertBitrixFormat(t.Loc.getMessage("FORMAT_DATE"))),clientTime:BX.date.format(BX.date.convertBitrixFormat(t.Loc.getMessage("FORMAT_DATETIME"))),rights:{canAddColumn:true,canEditColumn:true,canRemoveColumn:true,canSortColumn:true,canAddItem:true,canSortItem:true},admins:n.admins},messages:{ITEM_TITLE_PLACEHOLDER:t.Loc.getMessage("KANBAN_ITEM_TITLE_PLACEHOLDER"),COLUMN_TITLE_PLACEHOLDER:t.Loc.getMessage("KANBAN_COLUMN_TITLE_PLACEHOLDER")},ownerId:n.ownerId,groupId:n.groupId,isSprintView:"Y"}}},{key:"onClickGroup",value:function a(e,t){this.kanbanComponent.onClickGroup(e,t)}},{key:"onClickSort",value:function a(e,t){this.kanbanComponent.onClickSort(e,t)}},{key:"onApplyFilter",value:function a(e,t,n,s,r){var i=this;this.fadeOutKanbans();this.kanban.ajax({action:"applyFilter"},function(a){i.refreshKanban(i.kanban,a);if(i.existsTasksGroupedBySubTasks(a)){i.refreshParentTasksKanbans(a)}else{i.kanbanGroupedByParentTasks.forEach(function(a){i.hideParentTaskKanban(a)})}i.adjustGroupHeadersWidth();i.fadeInKanbans()},function(a){i.fadeInKanbans()})}},{key:"refreshKanban",value:function a(e,t){e.removeItems();e.loadData(t)}},{key:"refreshParentTasksKanbans",value:function a(e){var t=this;var n=[];var s=[];Object.entries(e.parentTasks).forEach(function(a){var e=babelHelpers.slicedToArray(a,2),r=e[0],i=e[1];if(t.kanbanGroupedByParentTasks.has(parseInt(r,10))){n.push(i)}else{s.push(i)}});this.kanbanGroupedByParentTasks.forEach(function(a,n){if(!e.parentTasks[n]){t.hideParentTaskKanban(a)}});n.forEach(function(a){var e=t.kanbanGroupedByParentTasks.get(parseInt(a.id,10));t.refreshParentTaskKanban(e,a)});s.forEach(function(a){t.createParentTaskKanban(a)})}},{key:"refreshParentTaskKanban",value:function a(e,t){e.removeItems();var n=e.getInnerContainer().closest(".tasks-scrum-parent-task-kanban");this.showElement(n);this.upGroupingVisibility(n);e.loadData(t);if(t["completed"]==="Y"){this.downGroupingVisibility(n)}}},{key:"createParentTaskKanban",value:function a(e){var n=this;this.parentTasks[e.id]=e;var s=this.createParentTaskKanbanNode(e);var r=e["completed"]==="Y";if(r){this.setTextDecorationToParentTaskName(s)}t.Dom.append(s,this.inputRenderTo);var i=s.querySelector(".tasks-scrum-kanban-group-header-tick");t.Event.bind(i,"click",function(){n.toggleGroupingVisibility(s)});var o=s.querySelector(".tasks-scrum-kanban-container");this.drawKanbanGroupedByParentTasks(e.id,o,this.inputKanbanParams)}},{key:"hideParentTaskKanban",value:function a(e){e.removeItems();var t=e.getInnerContainer().closest(".tasks-scrum-parent-task-kanban");this.hideElement(t)}},{key:"fadeOutKanbans",value:function a(){this.kanban.fadeOut();this.kanbanGroupedByParentTasks.forEach(function(a){a.fadeOut()})}},{key:"fadeInKanbans",value:function a(){this.kanban.fadeIn();this.kanbanGroupedByParentTasks.forEach(function(a){a.fadeIn()})}},{key:"showNotSprintMessage",value:function a(e){t.Dom.append(t.Tag.render(r(),t.Loc.getMessage("KANBAN_NO_ACTIVE_SPRINT")),e)}},{key:"isParentTaskGrouping",value:function a(){return!t.Type.isArray(this.parentTasks)}},{key:"existsTasksGroupedBySubTasks",value:function a(e){return!t.Type.isArray(e.parentTasks)}},{key:"showElement",value:function a(e){e.style.display="block"}},{key:"hideElement",value:function a(e){e.style.display="none"}},{key:"createParentTaskKanbanNode",value:function a(e){return t.Tag.render(s(),this.getTaskUrl(e.id),t.Text.encode(e.name),t.Text.encode(e.storyPoints))}},{key:"adjustGroupHeadersWidth",value:function a(){var e=this;var t=this.inputRenderTo.querySelectorAll(".tasks-scrum-kanban-group-header");t.forEach(function(a){a.style.width=e.kanban.getColumnsWidth()})}},{key:"upGroupingVisibility",value:function a(e){var n=e.querySelector(".tasks-scrum-kanban-group-header-tick");var s=e.querySelector(".tasks-scrum-kanban-container");t.Dom.removeClass(n.firstElementChild,"ui-btn-icon-angle-down");t.Dom.addClass(n.firstElementChild,"ui-btn-icon-angle-up");this.showElement(s)}},{key:"downGroupingVisibility",value:function a(e){var n=e.querySelector(".tasks-scrum-kanban-group-header-tick");var s=e.querySelector(".tasks-scrum-kanban-container");t.Dom.removeClass(n.firstElementChild,"ui-btn-icon-angle-up");t.Dom.addClass(n.firstElementChild,"ui-btn-icon-angle-down");this.hideElement(s)}},{key:"toggleGroupingVisibility",value:function a(e){var t=e.querySelector(".tasks-scrum-kanban-group-header-tick");var n=e.querySelector(".tasks-scrum-kanban-container");t.firstElementChild.classList.toggle("ui-btn-icon-angle-up");t.firstElementChild.classList.toggle("ui-btn-icon-angle-down");if(n.style.display!=="none"){this.hideElement(n)}else{this.showElement(n)}var s=e.querySelector(".main-kanban-grid");s.scrollLeft=this.kanban.getGridContainer().scrollLeft}},{key:"onCompleteParentTask",value:function a(e){var t=e.getRenderToContainer().closest(".tasks-scrum-parent-task-kanban");this.setTextDecorationToParentTaskName(t)}},{key:"onRenewParentTask",value:function a(e){var t=e.getRenderToContainer().closest(".tasks-scrum-parent-task-kanban");this.unsetTextDecorationToParentTaskName(t)}},{key:"setTextDecorationToParentTaskName",value:function a(e){var n=e.querySelector(".tasks-scrum-kanban-group-header-name");t.Dom.style(n,"text-decoration","line-through")}},{key:"unsetTextDecorationToParentTaskName",value:function a(e){var n=e.querySelector(".tasks-scrum-kanban-group-header-name");t.Dom.style(n,"text-decoration",null)}},{key:"getTaskUrl",value:function a(e){return this.inputKanbanParams.pathToTask.replace("#task_id#",e)}}]);return a}();a.KanbanManager=i})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX.Event,BX);
//# sourceMappingURL=script.map.js