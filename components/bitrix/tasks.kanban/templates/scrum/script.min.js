this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(a,e,t,n){"use strict";var s=function(a){babelHelpers.inherits(e,a);function e(){var a;babelHelpers.classCallCheck(this,e);a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));a.setEventNamespace("BX.Tasks.Scrum.KanbanManager.PullItem");return a}babelHelpers.createClass(e,[{key:"getModuleId",value:function a(){return"tasks"}},{key:"getMap",value:function a(){return{itemUpdated:this.onItemUpdated.bind(this)}}},{key:"onItemUpdated",value:function a(e){this.emit("itemUpdated",e)}}]);return e}(t.EventEmitter);var r=function(){function a(e){babelHelpers.classCallCheck(this,a);this.filterId=e.filterId;this.defaultPresetId=e.defaultPresetId;this.ajaxComponentPath=e.ajaxComponentPath;this.ajaxComponentParams=e.ajaxComponentParams}babelHelpers.createClass(a,[{key:"onClickSort",value:function a(e,t){if(!n.Dom.hasClass(e,"menu-popup-item-accept")){this.refreshIcons(e);this.saveSelection(t)}}},{key:"refreshIcons",value:function a(e){e.parentElement.childNodes.forEach((function(a){n.Dom.removeClass(a,"menu-popup-item-accept")}));n.Dom.addClass(e,"menu-popup-item-accept")}},{key:"saveSelection",value:function a(e){n.ajax({method:"POST",dataType:"json",url:this.ajaxComponentPath,data:{action:"setNewTaskOrder",order:e?e:"desc",params:this.ajaxComponentParams,sessid:BX.bitrix_sessid()},onsuccess:function a(e){BX.onCustomEvent(this,"onTaskSortChanged",[e])}})}}]);return a}();var i,o;var u=function(){function a(n){var i=this;babelHelpers.classCallCheck(this,a);this.groupId=parseInt(n.groupId,10);this.filterId=n.filterId;this.siteTemplateId=n.siteTemplateId;this.ajaxComponentPath=n.ajaxComponentPath;this.ajaxComponentParams=n.ajaxComponentParams;this.sprintSelected=n.sprintSelected;this.isActiveSprint=n.isActiveSprint;this.kanbanHeader=null;this.kanban=null;this.kanbanGroupedByParentTasks=new Map;this.parentTasks=n.parentTasks;this.kanbanComponent=new r({filterId:n.filterId,defaultPresetId:n.defaultPresetId,ajaxComponentPath:n.ajaxComponentPath,ajaxComponentParams:n.ajaxComponentParams});this.pullItem=new s({groupId:this.groupId});this.pullItem.subscribe("itemUpdated",this.onItemUpdated.bind(this));t.EventEmitter.subscribe("BX.Main.Filter:apply",(function(a){var e=a.getCompatData(),t=babelHelpers.slicedToArray(e,5),n=t[0],s=t[1],r=t[2],o=t[3],u=t[4];i.onApplyFilter(n,s,r,o,u)}));t.EventEmitter.subscribe("onTasksGroupSelectorChange",this.onChangeSprint.bind(this));e.PULL.subscribe(this.pullItem)}babelHelpers.createClass(a,[{key:"drawKanban",value:function a(e,n){var s=this;if(!this.sprintSelected){this.showNotSprintMessage(e);return}this.inputRenderTo=e;this.inputKanbanParams=n;this.drawKanbanHeader(e,n);this.drawKanbanWithoutGrouping(e,n);this.drawKanbanInGroupingMode(e,n);this.fillNeighborKanbans();this.updateHeaderColumns();this.adjustGroupHeadersWidth();t.EventEmitter.subscribe(this.kanbanHeader,"Kanban.Grid:onColumnAddedAsync",(function(){s.adjustGroupHeadersWidth()}));t.EventEmitter.subscribe(this.kanbanHeader,"Kanban.Grid:onColumnRemovedAsync",(function(){setTimeout((function(){s.adjustGroupHeadersWidth()}),200)}))}},{key:"getKanbanHeader",value:function a(){return this.kanbanHeader}},{key:"getKanban",value:function a(){return this.kanban}},{key:"getKanbansGroupedByParentTasks",value:function a(){return this.kanbanGroupedByParentTasks}},{key:"drawKanbanInGroupingMode",value:function a(e,t){var s=this;n.Dom.addClass(e,"tasks-scrum-kanban");if(this.isParentTaskGrouping()){var r=function a(r){if(s.parentTasks[r]["isVisibilitySubtasks"]==="N"){delete s.parentTasks[r];if(!s.kanban.getItem(r)){s.kanban.refreshTask(r)}return"continue"}var i=s.createParentTaskKanbanNode(s.parentTasks[r]);var o=s.parentTasks[r]["completed"]==="Y";if(o){s.setTextDecorationToParentTaskName(i)}n.Dom.append(i,e);var u=i.querySelector(".tasks-scrum-kanban-group-header-tick");n.Event.bind(u,"click",(function(){s.toggleGroupingVisibility(i)}));var d=i.querySelector(".tasks-scrum-kanban-container");s.drawKanbanGroupedByParentTasks(s.parentTasks[r],d,t)};for(var i in this.parentTasks){var o=r(i);if(o==="continue")continue}}}},{key:"drawKanbanHeader",value:function a(e,t){var s=n.Runtime.clone(t);s.kanbanHeader=true;s.items=[];this.kanbanHeader=new BX.Tasks.Kanban.Grid(this.getKanbanParams(e,s));this.kanbanHeader.draw()}},{key:"drawKanbanWithoutGrouping",value:function a(e,n){var s=this;this.kanban=new BX.Tasks.Kanban.Grid(this.getKanbanParams(e,n));t.EventEmitter.subscribe(this.kanban,"Kanban.Grid:onAddParentTask",(function(a){var e=a.getData();s.createParentTaskKanban(e);s.fillNeighborKanbans();s.adjustGroupHeadersWidth();s.kanban.addItemsFromQueue()}));this.kanban.draw()}},{key:"drawKanbanGroupedByParentTasks",value:function a(e,s,r){var i=this;var o=parseInt(e.id,10);var u=n.Runtime.clone(r);u.columns=e.columns;u.items=e.items;u.parentTaskId=o;u.parentTaskName=e.name;u.parentTaskCompleted=e.completed==="Y";var d=new BX.Tasks.Kanban.Grid(this.getKanbanParams(s,u));d.draw();if(u.parentTaskCompleted&&!d.hasItemInProgress()){var l=d.getRenderToContainer().closest(".tasks-scrum-parent-task-kanban");this.downGroupingVisibility(l)}t.EventEmitter.subscribe(d,"Kanban.Grid:onCompleteParentTask",(function(){i.onCompleteParentTask(d)}));t.EventEmitter.subscribe(d,"Kanban.Grid:onRenewParentTask",(function(){i.onRenewParentTask(d)}));t.EventEmitter.subscribe(d,"Kanban.Grid:onProceedParentTask",(function(){i.onProceedParentTask(d)}));t.EventEmitter.subscribe(d,"Kanban.Grid:onAddItemInProgress",(function(a){var e=d.getRenderToContainer().closest(".tasks-scrum-parent-task-kanban");i.upGroupingVisibility(e)}));this.kanbanGroupedByParentTasks.set(o,d)}},{key:"fillNeighborKanbans",value:function a(){var e=this;this.addNeighborKanban(this.kanbanHeader);this.addNeighborKanban(this.kanban);this.kanbanGroupedByParentTasks.forEach((function(a){e.addNeighborKanban(a)}))}},{key:"cleanNeighborKanbans",value:function a(){var e=this;this.kanbanHeader.cleanNeighborGrids();this.kanban.cleanNeighborGrids();this.kanbanGroupedByParentTasks.forEach((function(a){e.removeParentTaskKanban(a);a.cleanNeighborGrids()}));this.kanbanGroupedByParentTasks.clear()}},{key:"updateHeaderColumns",value:function a(){this.kanbanHeader.updateTotals()}},{key:"addNeighborKanban",value:function a(e){this.kanbanHeader.addNeighborGrid(e);this.kanban.addNeighborGrid(e);this.kanbanGroupedByParentTasks.forEach((function(a){a.addNeighborGrid(e)}))}},{key:"getKanbanParams",value:function a(e,t){return{isGroupingMode:true,gridHeader:t.kanbanHeader,parentTaskId:t.parentTaskId?t.parentTaskId:0,parentTaskName:t.parentTaskName?t.parentTaskName:"",parentTaskCompleted:t.parentTaskCompleted?t.parentTaskCompleted:false,renderTo:e,itemType:"BX.Tasks.Kanban.Item",columnType:"BX.Tasks.Kanban.Column",canAddColumn:this.isActiveSprint,canEditColumn:this.isActiveSprint,canRemoveColumn:this.isActiveSprint,canSortColumn:this.isActiveSprint,canAddItem:!t.addItemInSlider&&this.isActiveSprint,canSortItem:this.isActiveSprint,bgColor:this.siteTemplateId,columns:t.columns,items:t.items,addItemTitleText:n.Loc.getMessage("KANBAN_QUICK_TASK"),addDraftItemInfo:n.Loc.getMessage("KANBAN_QUICK_TASK_ITEM_INFO"),data:{kanbanType:"K",ajaxHandlerPath:this.ajaxComponentPath,pathToTask:t.pathToTask,pathToTaskCreate:t.pathToTaskCreate,pathToUser:t.pathToUser,addItemInSlider:t.addItemInSlider,params:this.ajaxComponentParams,gridId:this.filterId,newTaskOrder:t.newTaskOrder,setClientDate:t.setClientDate,clientDate:BX.date.format(BX.date.convertBitrixFormat(n.Loc.getMessage("FORMAT_DATE"))),clientTime:BX.date.format(BX.date.convertBitrixFormat(n.Loc.getMessage("FORMAT_DATETIME"))),rights:{canAddColumn:this.isActiveSprint,canEditColumn:this.isActiveSprint,canRemoveColumn:this.isActiveSprint,canSortColumn:this.isActiveSprint,canAddItem:this.isActiveSprint,canSortItem:this.isActiveSprint},admins:t.admins},messages:{ITEM_TITLE_PLACEHOLDER:n.Loc.getMessage("KANBAN_ITEM_TITLE_PLACEHOLDER"),COLUMN_TITLE_PLACEHOLDER:n.Loc.getMessage("KANBAN_COLUMN_TITLE_PLACEHOLDER")},ownerId:t.ownerId,groupId:t.groupId,isSprintView:"Y"}}},{key:"onClickSort",value:function a(e,t){this.kanbanComponent.onClickSort(e,t)}},{key:"onApplyFilter",value:function a(e,t,n,s,r){var i=this;this.fadeOutKanbans();this.kanban.ajax({action:"applyFilter"},(function(a){i.refreshKanban(i.kanban,a);i.cleanNeighborKanbans();if(i.existsTasksGroupedBySubTasks(a)){Object.entries(a.parentTasks).forEach((function(a){var e=babelHelpers.slicedToArray(a,2),t=e[1];i.createParentTaskKanban(t)}))}i.fillNeighborKanbans();i.adjustGroupHeadersWidth();i.fadeInKanbans()}),(function(a){i.fadeInKanbans()}))}},{key:"onChangeSprint",value:function a(e){var t=this;var n=e.getCompatData(),s=babelHelpers.slicedToArray(n,1),r=s[0];var i=this.kanban.getData();i.params.SPRINT_ID=r.sprintId;this.kanban.setData(i);this.kanban.ajax({action:"changeSprint"},(function(a){t.cleanNeighborKanbans();t.kanbanHeader.getColumns().forEach((function(a){return t.kanbanHeader.removeColumn(a)}));t.kanban.getColumns().forEach((function(a){return t.kanban.removeColumn(a)}));t.refreshKanban(t.kanbanHeader,a);t.refreshKanban(t.kanban,a);if(t.existsTasksGroupedBySubTasks(a)){Object.entries(a.parentTasks).forEach((function(a){var e=babelHelpers.slicedToArray(a,2),n=e[1];t.createParentTaskKanban(n)}))}t.fillNeighborKanbans();t.adjustGroupHeadersWidth()}),(function(a){}))}},{key:"onItemUpdated",value:function a(e){var t=e.getData();if(this.groupId!==t.groupId){return}var n=t.sourceId;if(this.kanban.hasItem(n)){this.kanban.refreshTask(n)}else{this.kanbanGroupedByParentTasks.forEach((function(a){if(a.hasItem(n)){a.refreshTask(n)}}))}}},{key:"refreshKanban",value:function a(e,t){e.resetPaginationPage();e.removeItems();e.loadData(t)}},{key:"refreshParentTasksKanbans",value:function a(e){var t=this;var n=[];var s=[];Object.entries(e.parentTasks).forEach((function(a){var e=babelHelpers.slicedToArray(a,2),r=e[0],i=e[1];if(t.kanbanGroupedByParentTasks.has(parseInt(r,10))){n.push(i)}else{s.push(i)}}));this.kanbanGroupedByParentTasks.forEach((function(a,n){if(!e.parentTasks[n]){t.hideParentTaskKanban(a)}}));n.forEach((function(a){var e=t.kanbanGroupedByParentTasks.get(parseInt(a.id,10));t.refreshParentTaskKanban(e,a)}));s.forEach((function(a){t.createParentTaskKanban(a)}))}},{key:"refreshParentTaskKanban",value:function a(e,t){e.resetPaginationPage();e.removeItems();var n=e.getInnerContainer().closest(".tasks-scrum-parent-task-kanban");this.showElement(n);this.upGroupingVisibility(n);e.loadData(t);if(t["completed"]==="Y"){this.downGroupingVisibility(n)}}},{key:"createParentTaskKanban",value:function a(e){var t=this;if(e.isVisibilitySubtasks==="N"){if(!this.kanban.getItem(e.id)){this.kanban.refreshTask(e.id)}return}this.parentTasks[e.id]=e;var s=this.createParentTaskKanbanNode(e);var r=e["completed"]==="Y";if(r){this.setTextDecorationToParentTaskName(s)}n.Dom.append(s,this.inputRenderTo);var i=s.querySelector(".tasks-scrum-kanban-group-header-tick");n.Event.bind(i,"click",(function(){t.toggleGroupingVisibility(s)}));var o=s.querySelector(".tasks-scrum-kanban-container");this.drawKanbanGroupedByParentTasks(e,o,this.inputKanbanParams)}},{key:"hideParentTaskKanban",value:function a(e){e.removeItems();var t=e.getInnerContainer().closest(".tasks-scrum-parent-task-kanban");this.hideElement(t)}},{key:"removeParentTaskKanban",value:function a(e){n.Dom.remove(e.getInnerContainer().closest(".tasks-scrum-parent-task-kanban"))}},{key:"fadeOutKanbans",value:function a(){this.kanban.fadeOut();this.kanbanGroupedByParentTasks.forEach((function(a){a.fadeOut()}))}},{key:"fadeInKanbans",value:function a(){this.kanban.fadeIn();this.kanbanGroupedByParentTasks.forEach((function(a){a.fadeIn()}))}},{key:"showNotSprintMessage",value:function a(e){var t=this.isActiveSprint?n.Loc.getMessage("KANBAN_NO_ACTIVE_SPRINT"):n.Loc.getMessage("KANBAN_NO_COMPLETED_SPRINT");n.Dom.append(n.Tag.render(i||(i=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-kanban__start">\n\t\t\t\t\t',"\n\t\t\t</div>\n\t\t"])),t),e)}},{key:"isParentTaskGrouping",value:function a(){return!n.Type.isArray(this.parentTasks)}},{key:"existsTasksGroupedBySubTasks",value:function a(e){return!n.Type.isArray(e.parentTasks)}},{key:"showElement",value:function a(e){n.Dom.style(e,"display","block")}},{key:"hideElement",value:function a(e){n.Dom.style(e,"display","none")}},{key:"createParentTaskKanbanNode",value:function a(e){return n.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-parent-task-kanban">\n\t\t\t\t<div class="tasks-scrum-kanban-group-header" style="background-color: #eaeaea;">\n\t\t\t\t\t<div class="tasks-scrum-kanban-group-header-tick">\n\t\t\t\t\t\t<div class="ui-btn ui-btn-sm ui-btn-light ui-btn-icon-angle-up"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-kanban-group-header-name">\n\t\t\t\t\t\t<a href="','">','</a>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-kanban-group-header-story-points" title="Story Points">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-kanban-container"></div>\n\t\t\t</div>\n\t\t'])),this.getTaskUrl(e.id),n.Text.encode(e.name),n.Text.encode(e.storyPoints))}},{key:"adjustGroupHeadersWidth",value:function a(){var e=this;var t=this.inputRenderTo.querySelectorAll(".tasks-scrum-kanban-group-header");t.forEach((function(a){n.Dom.style(a,"width",e.kanbanHeader.getColumnsWidth())}))}},{key:"upGroupingVisibility",value:function a(e){var t=e.querySelector(".tasks-scrum-kanban-group-header-tick");var s=e.querySelector(".tasks-scrum-kanban-container");n.Dom.removeClass(t.firstElementChild,"ui-btn-icon-angle-down");n.Dom.addClass(t.firstElementChild,"ui-btn-icon-angle-up");this.showElement(s)}},{key:"downGroupingVisibility",value:function a(e){var t=e.querySelector(".tasks-scrum-kanban-group-header-tick");var s=e.querySelector(".tasks-scrum-kanban-container");n.Dom.removeClass(t.firstElementChild,"ui-btn-icon-angle-up");n.Dom.addClass(t.firstElementChild,"ui-btn-icon-angle-down");this.hideElement(s)}},{key:"toggleGroupingVisibility",value:function a(e){var t=e.querySelector(".tasks-scrum-kanban-group-header-tick");var s=e.querySelector(".tasks-scrum-kanban-container");n.Dom.toggleClass(t.firstElementChild,"ui-btn-icon-angle-up");n.Dom.toggleClass(t.firstElementChild,"ui-btn-icon-angle-down");if(n.Dom.style(s,"display")!=="none"){this.hideElement(s)}else{this.showElement(s)}var r=e.querySelector(".main-kanban-grid");r.scrollLeft=this.kanban.getGridContainer().scrollLeft}},{key:"onCompleteParentTask",value:function a(e){var t=e.getRenderToContainer().closest(".tasks-scrum-parent-task-kanban");this.setTextDecorationToParentTaskName(t)}},{key:"onRenewParentTask",value:function a(e){var t=e.getRenderToContainer().closest(".tasks-scrum-parent-task-kanban");this.unsetTextDecorationToParentTaskName(t)}},{key:"onProceedParentTask",value:function a(e){if(this.kanbanGroupedByParentTasks.has(e.getParentTaskId())){this.removeParentTaskKanban(e);this.kanbanGroupedByParentTasks["delete"](e.getParentTaskId())}}},{key:"setTextDecorationToParentTaskName",value:function a(e){var t=e.querySelector(".tasks-scrum-kanban-group-header-name");n.Dom.style(t,"text-decoration","line-through")}},{key:"unsetTextDecorationToParentTaskName",value:function a(e){var t=e.querySelector(".tasks-scrum-kanban-group-header-name");n.Dom.style(t,"text-decoration",null)}},{key:"getTaskUrl",value:function a(e){return this.inputKanbanParams.pathToTask.replace("#task_id#",e)}}]);return a}();a.KanbanManager=u})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX,BX.Event,BX);
//# sourceMappingURL=script.map.js