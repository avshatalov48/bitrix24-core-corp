(function(){"use strict";if(BX.SalecenterPaySystem)return;BX.SalecenterPaySystem={init:function(e){this.slider=null;this.paySystemHandler=e.paySystemHandler;this.paySystemMode=e.paySystemMode;this.paySystemId=e.paySystemId;this.containerNode=BX(e.containerId);this.buttonSaveNode=BX(e.buttonSaveId);this.formId=e.formId;this.auth=e.auth;this.errorMessageNode=BX(e.errorMessageId);this.paySystemFormData=[];this.checkedAuthStatus=false;this.uiNodes={name:this.containerNode.querySelector("[data-bx-salescenter-auth-name]"),link:this.containerNode.querySelector("[data-bx-salescenter-auth-link]"),logout:this.containerNode.querySelector("[data-bx-salescenter-auth-logout]")};this.showBlockByAuth();this.bindEvents();var t=top.BX.adminSidePanel||BX.adminSidePanel;if(t){if(!top.window["adminSidePanel"]||!BX.is_subclass_of(top.window["adminSidePanel"],t)){top.window["adminSidePanel"]=new t({publicMode:true})}}},bindEvents:function(){BX.bind(BX("bx-salescenter-add-button"),"click",BX.proxy(this.openSlider,this));BX.bind(BX("bx-salescenter-connect-button"),"click",BX.proxy(this.openPopup,this));BX.bind(BX("LOGOTIP"),"bxchange",BX.proxy(this.showLogotip,this));BX.bind(this.buttonSaveNode,"click",BX.proxy(this.savePaySystemAction,this));BX.bind(this.uiNodes.logout,"click",BX.proxy(this.logoutAction,this));BX.addCustomEvent(window,"seo-client-auth-result",BX.proxy(this.checkAuthStatusAction,this));BX.addCustomEvent("onPopupOpen",BX.proxy(this.onPopupOpenHandler,this));BX.addCustomEvent("SidePanel.Slider:onLoad",BX.proxy(this.onLoadSlider,this));BX.addCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.onCloseSlider,this));BX.addCustomEvent("SidePanel.Slider:onMessage",BX.proxy(this.onMessageSlider,this))},onLoadSlider:function(e){this.slider=e.slider;top.BX.addCustomEvent("AdminSidePanel:onSendRequest",BX.proxy(this.onSendAdminSidePanelRequest.bind(this,this.slider)));var t=this.getSliderDocument(this.slider);this.formData=this.getAllFormDataJson(t)},onCloseSlider:function(e){this.onCloseSliderPopup(e)},openPopup:function(e){var t;if(this.auth&&this.auth.URL){t=BX.util.popup(this.auth.URL,800,600);if(t){BX.onCustomEvent("onPopupOpen",[t])}}},onPopupOpenHandler:function(e){var t=this,i=setInterval(function(){if(e.closed){clearInterval(i);if(t.checkedAuthStatus===false){t.checkAuthStatusAction()}}},1e3)},logoutAction:function(){BX.ajax.runComponentAction("bitrix:salescenter.paysystem","logoutProfile",{mode:"ajax",data:{type:this.auth.TYPE}}).then(function(e){this.toggleLogoutBlock()}.bind(this),function(e){this.showErrorPopup(e.errors)}.bind(this))},checkAuthStatusAction:function(e){e.reload=false;this.checkedAuthStatus=true;BX.ajax.runComponentAction("bitrix:salescenter.paysystem","getProfileStatus",{mode:"ajax",data:{type:this.auth.TYPE}}).then(function(e){this.toggleAuthBlock(e.data.profile)}.bind(this),function(e){this.showErrorPopup(e.errors)}.bind(this))},toggleAuthBlock:function(e){if(e){this.setProfileData(e);this.showBlock(["profile","settings","form"])}else{this.showBlock(["settings","form"])}},toggleLogoutBlock:function(){this.showBlock(["auth"]);if(this.slider){this.slider.reload()}},setProfileData:function(e){if(this.uiNodes.name&&e.NAME){if(this.auth.TYPE==="yookassa"){this.uiNodes.name.innerText="Shop ID "+e.NAME}else{this.uiNodes.name.innerText=e.NAME}}if(this.uiNodes.link){if(e.LINK){this.uiNodes.link.setAttribute("href",e.LINK)}else{this.uiNodes.link.removeAttribute("href")}}},showBlock:function(e){e=BX.type.isArray(e)?e:[e];var t="data-bx-salescenter-block";var i=this.containerNode.querySelectorAll("["+t+"]");i=BX.convert.nodeListToArray(i);i.forEach(function(i){var s=i.getAttribute(t);var n=BX.util.in_array(s,e);i.style.display=n?"block":"none"},this)},showBlockByAuth:function(){if(this.auth.HAS_AUTH){this.setProfileData(this.auth.PROFILE);if(this.auth.PROFILE){this.showBlock(["profile","settings","form"])}else{this.showBlock(["profile"])}}else{if(this.auth.PROFILE){this.setProfileData(this.auth.PROFILE);this.showBlock(["profile","settings","form"])}else{if(this.auth.CAN_AUTH){this.showBlock(["auth"])}else{this.showBlock(["settings","form"])}}}},openSlider:function(){var e=true;var t={allowChangeHistory:false,events:{onLoad:function(t){if(e){var i=t.getSlider();this.updatePaySystemForm(i);e=false}}.bind(this),onClose:function(e){var t=e.getSlider(),i;i=this.getPaySystemFormData(t);if(i.hasOwnProperty("ID")&&i.ID>0){this.paySystemId=i.ID;this.updateCommonSettingsForm(i);this.savePaySystem().then(function(e){t.destroy();this.slider.url=BX.util.add_url_param(this.slider.url,{ID:this.paySystemId});this.slider.setFrameSrc();this.slider.reload()}.bind(this))}else{this.updateCommonSettingsForm(i)}}.bind(this)}};BX.SidePanel.Instance.open(this.getConnectPath(),t)},onMessageSlider:function(e){if(e.getEventId()==="save"){if(this.paySystemId>0){this.slider.reload()}else{this.closeSlider()}}},closeSlider:function(){var e=BX("salescenter-form-is-saved");if(e){e.value="y"}if(this.slider){this.slider.close()}},getConnectPath:function(){var e="/shop/settings/sale_pay_system_edit/?publicSidePanel=Y";if(this.paySystemId>0){e+="&ID="+this.paySystemId}else if(this.paySystemHandler){e+="&ACTION_FILE="+this.paySystemHandler;if(this.paySystemMode){e+="&PS_MODE="+this.paySystemMode}}return e},savePaySystemAction:function(e){e.preventDefault();this.savePaySystem().then(function(e){BX.removeClass(this.buttonSaveNode,"ui-btn-wait");this.hideError();this.closeSlider()}.bind(this),function(e){BX.removeClass(this.buttonSaveNode,"ui-btn-wait");this.showError(e.errors);if(e.data.hasOwnProperty("ID")){this.paySystemId=e.data.ID;BX("ID").value=this.paySystemId}window.scrollTo(0,0)}.bind(this))},savePaySystem:function(){var e,t;if(this.paySystemId>0){e="salescenterUpdatePaymentSystem"}else{e="salescenterAddPaymentSystem"}t=this.paySystemHandler;if(this.paySystemMode){t=t+":"+this.paySystemMode}return BX.ajax.runComponentAction("bitrix:salescenter.paysystem","savePaySystem",{mode:"ajax",data:this.getSaveData(),analyticsLabel:{analyticsLabel:e,type:t}})},getSaveData:function(){var e=this.getAllFormData(document);for(var t in this.paySystemFormData){if(this.paySystemFormData.hasOwnProperty(t)){if(this.isObject(this.paySystemFormData[t])){e.append(t,JSON.stringify(this.paySystemFormData[t]))}else{e.append(t,this.paySystemFormData[t])}}}if(this.paySystemFormData.hasOwnProperty("NAME")){e.append("NAME",e.get("NAME"));e.append("DESCRIPTION",e.get("DESCRIPTION"));e.append("IS_CASH",e.get("IS_CASH"));e.append("CAN_PRINT_CHECK",e.get("CAN_PRINT_CHECK"))}return e},updatePaySystemForm:function(e){var t,i,s,n,o;t=this.getSliderDocument(e);o=this.getCommonSettingsFormData();if(this.paySystemId>0){this.setPaySystemFormFields(t,o)}else{s=t.getElementById("LOGOTIP").closest("span").firstChild;n=this.elementObserver(s,function(e){this.setPaySystemFormFields(t,o);n.disconnect()}.bind(this));var a=t.getElementById("ACTION_FILE");if(a){i=new Event("change");a.dispatchEvent(i)}}},setPaySystemFormFields:function(e,t){var i,s,n,o,a,r,l;n=e.getElementById("PSA_NAME");if(n&&t.NAME){n.value=t.NAME}o=e.getElementById("NAME");if(o&&t.NAME){o.value=t.NAME}a=e.getElementsByName("IS_CASH");if(a&&t.IS_CASH){a[0].value=t.IS_CASH}i=e.getElementById("ACTION_FILE");if(i){i.closest("tr").style.display="none"}s=e.getElementById("PS_MODE");if(s){s.closest("tr").style.display="none"}if(t.CAN_PRINT_CHECK_SELF&&t.CAN_PRINT_CHECK_SELF==="Y"){r=e.getElementById("CAN_PRINT_CHECK");if(r){r.closest("tr").style.display="none"}}else{r=e.getElementById("CAN_PRINT_CHECK");if(r&&t.CAN_PRINT_CHECK){r.checked=t.CAN_PRINT_CHECK==="Y"}}l=e.getElementById("tab_cont_cashbox_edit");if(l){l.style.display="none";e.getElementById("cashbox_edit").style.display="none"}try{var c=this.lookupDescriptionEditor(e);if(c){c.SetEditorContent(t.DESCRIPTION);c.SaveContent();if(c.pEditorDocument){BX.bind(c.pEditorDocument,"click",BX.proxy(c.OnClick,c));BX.bind(c.pEditorDocument,"mousedown",BX.proxy(c.OnMousedown,c))}}}catch(e){}},getPaySystemFormData:function(e){var t,i;t=this.getSliderDocument(e);i=this.getAllFormDataList(t);try{var s=this.lookupDescriptionEditor(t);if(s){s.SaveContent();i.DESCRIPTION=s.GetContent()}}catch(e){}return i},updateCommonSettingsForm:function(e){var t,i,s,n,o;var a=this.getCommonSettingsFormData();t=BX("ID");i=BX("NAME");s=BX("DESCRIPTION");n=BX("IS_CASH");o=BX("CAN_PRINT_CHECK");if(t&&e.ID){t.value=e.ID}if(i&&e.NAME){i.value=e.NAME}if(s&&e.DESCRIPTION){s.value=e.DESCRIPTION}if(n&&e.IS_CASH){n.value=e.IS_CASH}if(o){if(a.CAN_PRINT_CHECK_SELF&&a.CAN_PRINT_CHECK_SELF==="Y"){o.checked=true}else{o.checked=!!(e.CAN_PRINT_CHECK&&e.CAN_PRINT_CHECK==="Y")}}this.paySystemFormData=e},getCommonSettingsFormData:function(){var e;e=this.getAllFormDataList(document);return e},onSendAdminSidePanelRequest:function(e,t){if(t.indexOf("action=delete")!==-1){e.close()}},elementObserver:function(e,t){if(!window.MutationObserver){return}var i={attributes:true,childList:true,characterData:true};var s=new MutationObserver(function(e){e.forEach(function(e){t(e)})});s.observe(e,i);return s},getAllFormDataJson:function(e){var t=this.getAllFormDataList(e);return t?JSON.stringify(t):""},getAllFormData:function(e){var t=new FormData,i=this.getAllFormDataList(e);for(var s in i){if(i.hasOwnProperty(s)){if(this.isObject(i[s])){t.append(s,JSON.stringify(i[s]))}else{t.append(s,i[s])}}}return t},getAllFormDataList:function(e){var t={},i,s,n;if(!e){return t}n=e.getElementsByTagName("form");for(i=0;i<n.length;i++){var o=this.getFormData(n[i]);for(s in o){if(o.hasOwnProperty(s)){t[s]=o[s]}}}return t},getFormData:function(e){var t=BX.ajax.prepareForm(e),i;for(i in t.data){if(t.data.hasOwnProperty(i)&&i===""){delete t.data[i]}}return!!t&&t.data?t.data:{}},showErrorPopup:function(e){var t,i=[];e.forEach(function(e){i.push(BX.create("p",{text:e.message}))});if(!i.length){return}t=BX.create("div",{children:i});var s=new BX.PopupWindow("paysystem_error_popup_"+BX.util.getRandomString(),null,{autoHide:false,draggable:false,closeByEsc:true,offsetLeft:0,offsetTop:0,zIndex:1e4,bindOptions:{forceBindPosition:true},titleBar:BX.message("SALESCENTER_SP_ERROR_POPUP_TITLE"),content:t,buttons:[new BX.PopupWindowButton({id:"close",text:BX.message("SALESCENTER_SP_BUTTON_CLOSE"),events:{click:function(){s.close()}}})],events:{onPopupClose:function(){this.destroy()},onPopupDestroy:function(){s=null}}});s.show()},showError:function(e){var t="";e.forEach(function(e){t+=e.message+"<br>"});if(this.errorMessageNode&&t){this.errorMessageNode.parentNode.style.display="block";this.errorMessageNode.innerHTML=t}},hideError:function(){if(this.errorMessageNode){this.errorMessageNode.innerHTML="";this.errorMessageNode.parentNode.style.display="none"}},getSliderDocument:function(e){var t,i;t=e.iframe;i=t.contentDocument||t.contentWindow.document;return i},lookupDescriptionEditor:function(e){try{var t=e.defaultView||e.parentWindow;var i="LightHTMLEditorhndl_dscr_0";if(this.paySystemId&&this.paySystemId>0){i="LightHTMLEditorhndl_dscr_"+this.paySystemId}return t[i]}catch(e){}},showLogotip:function(e){if(e.currentTarget.files&&e.currentTarget.files[0]){var t=new FileReader;t.onload=function(e){BX("salescenter-img-preload").src=e.target.result};t.readAsDataURL(e.currentTarget.files[0])}},onCloseSliderPopup:function(e){var t=this.getSliderDocument(e.slider);var i=t.getElementById("salescenter-form-is-saved");if(i&&i.value==="y"){return true}var s=this.getAllFormDataJson(t);if(this.formData===s||this.isClose===true){this.isClose=false;return false}e.action=false;this.popup=new BX.PopupWindow("salescenter_sp_slider_close_confirmation",null,{autoHide:false,draggable:false,closeByEsc:false,offsetLeft:0,offsetTop:0,zIndex:e.slider.zIndex+100,bindOptions:{forceBindPosition:true},titleBar:BX.message("SALESCENTER_SP_POPUP_TITLE"),content:BX.message("SALESCENTER_SP_POPUP_CONTENT"),buttons:[new BX.PopupWindowButton({text:BX.message("SALESCENTER_SP_POPUP_BUTTON_CLOSE"),className:"ui-btn ui-btn-success",events:{click:BX.delegate(this.onCloseConfirmButtonClick.bind(this,"close"))}}),new BX.PopupWindowButtonLink({text:BX.message("SALESCENTER_SP_POPUP_BUTTON_CANCEL"),className:"ui-btn ui-btn-link",events:{click:BX.delegate(this.onCloseConfirmButtonClick.bind(this,"cancel"))}})],events:{onPopupClose:function(){this.destroy()}}});this.popup.show();return false},onCloseConfirmButtonClick:function(e){this.popup.close();if(BX.SidePanel.Instance.getTopSlider()){BX.SidePanel.Instance.getTopSlider().focus()}if(e==="close"){this.isClose=true;BX.SidePanel.Instance.getTopSlider().close()}},isObject:function(e){return e&&typeof e==="object"&&e.constructor===Object},remove:function(e){var t=e.target;e.preventDefault();if(this.paySystemId>0&&confirm(BX.message("SALESCENTER_SP_PAYSYSTEM_DELETE_CONFIRM"))){var i=this.paySystemHandler;if(this.paySystemMode){i=i+":"+this.paySystemMode}BX.ajax.runComponentAction("bitrix:salescenter.paysystem","deletePaySystem",{mode:"ajax",data:{paySystemId:this.paySystemId},analyticsLabel:{analyticsLabel:"salescenterDeletePaymentSystem",type:i}}).then(function(){BX.removeClass(t,"ui-btn-wait");this.closeSlider()}.bind(this),function(e){BX.removeClass(t,"ui-btn-wait");this.showError(e.errors)}.bind(this))}else{setTimeout(function(){BX.removeClass(t,"ui-btn-wait")},100)}}};if(BX.SalecenterPaySystemCashbox)return;BX.SalecenterPaySystemCashbox={init:function(e){this.paySystemId=e.paySystemId;this.formNode=BX(e.formId);this.cashboxContainerInfoNode=BX(e.cashboxContainerInfoId);this.cashboxContainerNode=BX(e.cashboxContainerId);this.canPrintCheckNode=BX(e.canPrintCheckId);this.cashboxSwitchet=null;this.containerNodeList={settings:BX(e.containerList.settings),cashboxSettings:BX(e.containerList.cashboxSettings)};this.section=e.section;this.fields=e.fields;this.initSwitcher();this.renderSettings(this.cashboxContainerNode)},renderSettings:function(e){Object.keys(this.section).forEach(function(t){if(this.fields[t]){var i=this.section[t];var s=i.type;if(this.containerNodeList[s]){this.containerNodeList[s].appendChild(this.renderSection(i,this.fields[t]))}else{e.appendChild(this.renderSection(i,this.fields[t]))}}}.bind(this))},renderSection:function(e,t){var i=BX.create("div",{props:{className:"salescenter-editor-section-content"}});var s=BX.create("div",{props:{className:"salescenter-paysystem-section-title salescenter-paysystem-angle-icon-after"},children:[BX.create("div",{props:{className:"ui-title-6"},text:e.title}),BX.create("div",{props:{className:"salescenter-paysystem-angle-icon"}})]});i.appendChild(s);i.appendChild(BX.create("div",{props:{className:"ui-hr"}}));var n=BX.create("div");i.appendChild(n);if(e.warning){n.appendChild(BX.create("div",{props:{className:"ui-alert ui-alert-warning"},text:e.warning}))}t.forEach(function(e){var t=BX.create("div",{props:{className:"salescenter-editor-content-block"}});this.renderField(e).forEach(function(e){t.appendChild(e)});n.appendChild(t)}.bind(this));s.addEventListener("click",function(){BX.toggle(n)});return i},renderField:function(e){if(e.type==="checkbox"){return this.renderCheckbox(e)}if(e.type==="select"){return this.renderSelect(e)}return this.renderString(e)},renderString:function(e){var t=[];t.push(BX.create("div",{props:{className:"ui-ctl-label-text"+(e.required?" salescenter-paysystem-control-required":"")},text:e.label}));t.push(BX.create("div",{props:{className:"ui-ctl ui-ctl-textbox ui-ctl-w100"},html:e.input}));if(e.hint){t.push(BX.create("div",{props:{className:"ui-ctl-label-text"},style:{marginTop:"5px"},children:[BX.create("span",{props:{className:"salescenter-editor-content-logo-hint"},text:e.hint})]}))}return t},renderSelect:function(e){var t=[];t.push(BX.create("div",{props:{className:"ui-ctl-label-text"+(e.required?" salescenter-paysystem-control-required":"")},text:e.label}));var i=BX.create("div",{props:{className:"ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100"},children:[BX.create("div",{props:{className:"ui-ctl-after ui-ctl-icon-angle"}})]});i.insertAdjacentHTML("beforeend",e.input);t.push(i);return t},renderCheckbox:function(e){var t=[];var i=BX.create("label",{props:{className:"ui-ctl ui-ctl-checkbox ui-ctl-w100"},html:e.input});i.appendChild(BX.create("div",{props:{className:"ui-ctl-label-text"+(e.required?" salescenter-paysystem-control-required":"")},text:e.label}));t.push(i);return t},initSwitcher:function(){var e=this.formNode.getElementsByClassName("js-cashbox-ui-switcher");e=BX.convert.nodeListToArray(e);e.forEach(function(e){if(e.getAttribute("data-switcher-init")){return}var t=new BX.UI.Switcher({node:e});this.cashboxSwitchet=t;BX.addCustomEvent(t,"unchecked",BX.proxy(this.onToggleCashboxSwitcher.bind(this,t)));BX.addCustomEvent(t,"checked",BX.proxy(this.onToggleCashboxSwitcher.bind(this,t)))}.bind(this))},onToggleCashboxSwitcher:function(e){if(e.checked){this.canPrintCheckNode.checked=true;this.canPrintCheckNode.setAttribute("disabled","true");this.cashboxContainerInfoNode.classList.remove("salescenter-paysystem-cashbox-block--disabled");this.showCashboxSettings()}else{this.canPrintCheckNode.removeAttribute("disabled");this.cashboxContainerInfoNode.classList.add("salescenter-paysystem-cashbox-block--disabled");this.hideCashboxSettings()}},showCashboxSettings:function(){BX("salescenter-paysystem-cashbox").style.display="block"},hideCashboxSettings:function(){BX("salescenter-paysystem-cashbox").style.display="none"},reloadCashboxSettings:function(e){var t=this;BX.ajax.runComponentAction("bitrix:salescenter.paysystem","reloadCashboxSettings",{mode:"class",data:{paySystemId:this.paySystemId,kkmId:e.value}}).then(function(e){if(e.data.hasOwnProperty("IS_FISCALIZATION_ENABLE")){var i=e.data.IS_FISCALIZATION_ENABLE;t.cashboxSwitchet.check(i)}t.section=e.data.CASHBOX.section;t.fields=e.data.CASHBOX.fields;t.resetAllSection();if(t.section){t.renderSettings(t.cashboxContainerNode)}})},resetSection:function(e){e.forEach(function(e){var t=this.section[e].type;if(this.containerNodeList[t]){this.containerNodeList[t].innerHTML=""}}.bind(this))},resetAllSection:function(){Object.keys(this.containerNodeList).forEach(function(e){this.containerNodeList[e].innerHTML=""}.bind(this))}}})(window);
//# sourceMappingURL=script.map.js