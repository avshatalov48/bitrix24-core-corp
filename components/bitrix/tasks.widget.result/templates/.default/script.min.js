this.BX=this.BX||{};(function(e,t,s){"use strict";var i=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"taskId",null);babelHelpers.defineProperty(this,"itemsContentNode",null);babelHelpers.defineProperty(this,"targetBtnDown",null);babelHelpers.defineProperty(this,"targetBtnUp",null);babelHelpers.defineProperty(this,"itemsNodes",null);babelHelpers.defineProperty(this,"itemsWrapperNode",null);this.init(t);this.setHeightAutoFunction=this.setHeightAuto.bind(this)}babelHelpers.createClass(e,[{key:"init",value:function e(t){this.taskId=t;this.initExpand();s.EventEmitter.subscribe("onPullEvent-tasks",this.onPushResult.bind(this));s.EventEmitter.subscribe("BX.Livefeed:recalculateComments",this.onRecalculateLivefeedComments.bind(this));s.EventEmitter.subscribe("SidePanel.Slider:onLoad",this.onSidePanelLoad.bind(this))}},{key:"scrollToResult",value:function s(){var i=e.getResultIdFromRequest();if(i){var n=this.contentNode.querySelector('[data-id="'.concat(i,'"]'));if(n){var o=function s(){e.activateBlinking(n);var i=t.Dom.getPosition(n).top;window.scrollTo({top:i,behavior:"smooth"})};if(t.Dom.hasClass(n.parentElement,"tasks-widget-result__item-more")){t.Event.bindOnce(this.itemsWrapperNode,"transitionend",o);this.showResults()}else{o()}}}if(i===0){var r=document.getElementById("record-TASK_".concat(this.taskId,"-0-placeholder")).parentElement;if(r){e.showCommentInput(r);window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"})}}}},{key:"blockResize",value:function e(){this.contentNode.style.height="".concat(this.containerNode.scrollHeight,"px")}},{key:"onSidePanelLoad",value:function e(){this.blockResize();this.scrollToResult()}},{key:"initExpand",value:function e(){var t=this;this.initExpandButton();if(this.contentNode){this.blockResize()}this.targetBtnDown&&this.targetBtnDown.addEventListener("click",this.showResults.bind(this));this.targetBtnUp&&this.targetBtnUp.addEventListener("click",(function(){t.targetBtnUp.classList.remove("--visible");t.targetBtnDown.classList.add("--visible");t.itemsContentNode.classList.remove("--open");t.itemsWrapperNode.style.height="".concat(t.itemsWrapperNode.scrollHeight,"px");t.itemsWrapperNode.clientHeight;t.itemsWrapperNode.style.height=0;if(t.contentNode){t.contentNode.style.height="".concat(t.itemsNodes[0].offsetHeight+35,"px")}}))}},{key:"setHeightAuto",value:function e(){this.itemsWrapperNode.style.height="auto";this.itemsWrapperNode.removeEventListener("transitionend",this.setHeightAutoFunction)}},{key:"initExpandButton",value:function e(){s.EventEmitter.subscribe("BX.Forum.Spoiler:toggle",this.onSpoilerToggle.bind(this));this.contentNode=document.getElementById("tasks-result-list-container-".concat(this.taskId));this.containerNode=document.getElementById("tasks-result-list-wrapper-".concat(this.taskId));if(!this.containerNode){return}this.itemsContentNode=this.containerNode.querySelector('[data-role="tasks-widget--content"]');this.targetBtnDown=this.containerNode.querySelector('[data-role="tasks-widget--btn-down"]');this.targetBtnUp=this.containerNode.querySelector('[data-role="tasks-widget--btn-up"]');this.itemsNodes=this.containerNode.querySelectorAll('[data-role="tasks-widget--result-item"]');this.itemsWrapperNode=this.containerNode.querySelector('[data-role="tasks-widget--wrapper"]');if(!this.itemsWrapperNode||this.itemsNodes.length<=1){return}this.targetBtnDown.classList.add("--visible");this.itemsNodes.length===2?this.itemsContentNode.classList.add("--two-results"):this.itemsContentNode.classList.add("--many-results")}},{key:"onSpoilerToggle",value:function e(t){var s=t.getCompatData(),i=babelHelpers.slicedToArray(s,1),n=i[0];if(!n.node){return}var o=n.node.closest(".tasks-result-list-container");if(!o||!this.contentNode||o.id!==this.contentNode.id){return}this.blockResize()}},{key:"onPushResult",value:function e(t){var s=t.getData(),i=babelHelpers.slicedToArray(s,2),n=i[0],o=i[1];if(n!=="task_result_create"&&n!=="task_result_update"&&n!=="task_result_delete"){return}if(!o.result||!o.result.taskId||o.result.taskId!=this.taskId){return}this.reloadResults()}},{key:"onRecalculateLivefeedComments",value:function e(s){var i=s.getCompatData(),n=babelHelpers.slicedToArray(i,1),o=n[0];if(!t.Type.isDomNode(o.rootNode)){return}var r=o.rootNode.querySelector(".tasks-result-list-container");if(!r||r.id!==this.contentNode.id){return}this.blockResize()}},{key:"showResults",value:function e(){this.targetBtnDown.classList.remove("--visible");this.targetBtnUp.classList.add("--visible");this.itemsContentNode.classList.add("--open");this.itemsWrapperNode.style.height="".concat(this.itemsWrapperNode.scrollHeight,"px");this.itemsWrapperNode.addEventListener("transitionend",this.setHeightAutoFunction);if(this.contentNode){this.contentNode.style.height="".concat(this.itemsWrapperNode.scrollHeight+this.containerNode.scrollHeight,"px")}}},{key:"reloadResults",value:function e(){var s=this;t.ajax.runComponentAction("bitrix:tasks.widget.result","getResults",{mode:"class",data:{taskId:this.taskId}}).then((function(e){if(!e.data){return}s.containerNode.innerHTML=e.data;t.Runtime.html(s.containerNode,e.data).then((function(){s.initExpand()}))}))}}],[{key:"getResultIdFromRequest",value:function e(){var s=new t.Uri(window.location.href);var i=s.getQueryParam("RID");return i?parseInt(i,10):null}},{key:"activateBlinking",value:function e(s){if(t.Type.isUndefined(IntersectionObserver)){return}var i=new IntersectionObserver((function(e){if(e[0].isIntersecting===true){t.Dom.addClass(s,"--blink");setTimeout((function(){t.Dom.removeClass(s,"--blink")}),300);i.disconnect()}}),{threshold:[0]});i.observe(s)}},{key:"showCommentInput",value:function e(s){if(t.Type.isUndefined(IntersectionObserver)){return}var i=new IntersectionObserver((function(e){if(e[0].isIntersecting===true){var t=s.querySelector(".feed-com-footer");if(t){BX.fireEvent(t,"click");setTimeout((function(){window.scrollTo({top:document.body.scrollHeight,behavior:"smooth"});var e=document.getElementById("IS_TASK_RESULT");e.checked=true}),300)}i.disconnect()}}),{threshold:[0]});i.observe(s)}}]);return e}();e.TaskResult=i})(this.BX.Tasks=this.BX.Tasks||{},BX,BX.Event);
//# sourceMappingURL=script.map.js