{"version":3,"file":"script.js","sources":["src/index.js"],"sourcesContent":["import { ajax as Ajax, Runtime, Type } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\n\nclass TaskResult\n{\n\ttaskId = null;\n\titemsContentNode = null;\n\ttargetBtnDown = null;\n\ttargetBtnUp = null;\n\titemsNodes = null;\n\titemsWrapperNode = null;\n\n\tconstructor(taskId)\n\t{\n\t\tthis.init(taskId);\n\t\tthis.setHeightAutoFunction = this.setHeightAuto.bind(this);\n\t}\n\n\tinit(taskId)\n\t{\n\t\tthis.taskId = taskId;\n\n\t\tthis.initExpand();\n\n\t\tEventEmitter.subscribe('onPullEvent-tasks', this.onPushResult.bind(this));\n\t\tEventEmitter.subscribe('BX.Livefeed:recalculateComments', this.onRecalculateLivefeedComments.bind(this));\n\t\tEventEmitter.subscribe('SidePanel.Slider:onOpenComplete', this.blockResize.bind(this));\n\t};\n\n\tblockResize()\n\t{\n\t\tthis.contentNode.style.height = `${this.containerNode.scrollHeight}px`;\n\t}\n\n\tinitExpand()\n\t{\n\t\tthis.initExpandButton();\n\n\t\tif (this.contentNode)\n\t\t{\n\t\t\tthis.blockResize();\n\t\t}\n\n\t\tthis.targetBtnDown && this.targetBtnDown.addEventListener('click', () => {\n\t\t\tthis.targetBtnDown.classList.remove('--visible');\n\t\t\tthis.targetBtnUp.classList.add('--visible');\n\n\t\t\tthis.itemsContentNode.classList.add('--open');\n\t\t\tthis.itemsWrapperNode.style.height = `${this.itemsWrapperNode.scrollHeight}px`;\n\t\t\tthis.itemsWrapperNode.addEventListener('transitionend', this.setHeightAutoFunction);\n\n\t\t\tif (this.contentNode)\n\t\t\t{\n\t\t\t\tthis.contentNode.style.height = `${this.itemsWrapperNode.scrollHeight + this.containerNode.scrollHeight}px`;\n\t\t\t}\n\t\t});\n\n\t\tthis.targetBtnUp && this.targetBtnUp.addEventListener('click', () => {\n\t\t\tthis.targetBtnUp.classList.remove('--visible');\n\t\t\tthis.targetBtnDown.classList.add('--visible');\n\n\t\t\tthis.itemsContentNode.classList.remove('--open');\n\t\t\tthis.itemsWrapperNode.style.height = `${this.itemsWrapperNode.scrollHeight}px`;\n\t\t\tthis.itemsWrapperNode.clientHeight; // it's needed, P.Rafeev magic\n\t\t\tthis.itemsWrapperNode.style.height = 0;\n\n\t\t\tif (this.contentNode)\n\t\t\t{\n\t\t\t\tthis.contentNode.style.height = `${this.itemsNodes[0].offsetHeight + 35}px`;\n\t\t\t}\n\t\t});\n\t}\n\n\tsetHeightAuto()\n\t{\n\t\tthis.itemsWrapperNode.style.height = 'auto';\n\t\tthis.itemsWrapperNode.removeEventListener('transitionend', this.setHeightAutoFunction);\n\t}\n\n\tinitExpandButton()\n\t{\n\t\tthis.contentNode = document.getElementById(`tasks-result-list-container-${this.taskId}`);\n\t\tthis.containerNode = document.getElementById(`tasks-result-list-wrapper-${this.taskId}`);\n\n\t\tif (!this.containerNode)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.itemsContentNode = this.containerNode.querySelector('[data-role=\"tasks-widget--content\"]');\n\t\tthis.targetBtnDown = this.containerNode.querySelector('[data-role=\"tasks-widget--btn-down\"]');\n\t\tthis.targetBtnUp = this.containerNode.querySelector('[data-role=\"tasks-widget--btn-up\"]');\n\t\tthis.itemsNodes = this.containerNode.querySelectorAll('[data-role=\"tasks-widget--result-item\"]');\n\t\tthis.itemsWrapperNode = this.containerNode.querySelector('[data-role=\"tasks-widget--wrapper\"]');\n\n\t\tif (\n\t\t\t!this.itemsWrapperNode\n\t\t\t|| this.itemsNodes.length <= 1\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.targetBtnDown.classList.add('--visible');\n\n\t\tthis.itemsNodes.length === 2\n\t\t\t? this.itemsContentNode.classList.add('--two-results')\n\t\t\t: this.itemsContentNode.classList.add('--many-results');\n\n\t\tEventEmitter.subscribe('BX.Forum.Spoiler:toggle', this.onSpoilerToggle.bind(this));\n\t}\n\n\tonSpoilerToggle(event)\n\t{\n\t\tconst [ eventData ] = event.getCompatData();\n\n\t\tif (!eventData.node)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst targetContentNode = eventData.node.closest('.tasks-result-list-container');\n\t\tif (\n\t\t\t!targetContentNode\n\t\t\t|| !this.contentNode\n\t\t\t|| targetContentNode.id !== this.contentNode.id\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.blockResize();\n\t}\n\n\tonPushResult(event: BaseEvent)\n\t{\n\t\tconst [ command, params ] = event.getData();\n\n\t\tif (\n\t\t\tcommand !== 'task_result_create'\n\t\t\t&& command !== 'task_result_update'\n\t\t\t&& command !== 'task_result_delete'\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (\n\t\t\t!params.result\n\t\t\t|| !params.result.taskId\n\t\t\t|| params.result.taskId != this.taskId\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.reloadResults();\n\t}\n\n\tonRecalculateLivefeedComments(event: BaseEvent)\n\t{\n\t\tconst [ data ] = event.getCompatData();\n\t\tif (!Type.isDomNode(data.rootNode))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst taskResultContainer = data.rootNode.querySelector('.tasks-result-list-container');\n\t\tif (\n\t\t\t!taskResultContainer\n\t\t\t|| taskResultContainer.id !== this.contentNode.id\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.blockResize();\n\t}\n\n\treloadResults()\n\t{\n\t\tAjax.runComponentAction('bitrix:tasks.widget.result', 'getResults', {\n\t\t\tmode: 'class',\n\t\t\tdata: {\n\t\t\t\ttaskId: this.taskId,\n\t\t\t}\n\t\t}).then(\n\t\t(response) => {\n\t\t\tif (!response.data)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.containerNode.innerHTML = response.data;\n\t\t\tRuntime.html(this.containerNode, response.data).then(() => {\n\t\t\t\tthis.initExpand();\n\t\t\t});\n\t\t});\n\t}\n\n}\n\nexport {\n\tTaskResult,\n}\n"],"names":["TaskResult","taskId","init","setHeightAutoFunction","setHeightAuto","bind","initExpand","EventEmitter","subscribe","onPushResult","onRecalculateLivefeedComments","blockResize","contentNode","style","height","containerNode","scrollHeight","initExpandButton","targetBtnDown","addEventListener","classList","remove","targetBtnUp","add","itemsContentNode","itemsWrapperNode","clientHeight","itemsNodes","offsetHeight","removeEventListener","document","getElementById","querySelector","querySelectorAll","length","onSpoilerToggle","event","getCompatData","eventData","node","targetContentNode","closest","id","getData","command","params","result","reloadResults","data","Type","isDomNode","rootNode","taskResultContainer","Ajax","runComponentAction","mode","then","response","innerHTML","Runtime","html"],"mappings":"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"}