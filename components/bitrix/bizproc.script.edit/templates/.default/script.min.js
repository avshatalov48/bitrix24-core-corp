(function(e,t,n,i){"use strict";function r(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input value="" type="text" class="ui-ctl-element">\n\t\t']);r=function t(){return e};return e}function a(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="bizproc-script-edit-item">\n\t\t\t\t<div class="bizproc-script-edit-subtitle">','</div>\n\t\t\t\t<div class="bizproc-script-edit-text">','</div>\n\t\t\t\t<a onclick="','" class="ui-link ui-link-secondary ui-link-dashed">','</a>\n\t\t\t\t<div class="bizproc-script-edit-field">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>"]);a=function t(){return e};return e}function o(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-slider-section">\n\t\t\t\t<div class="ui-slider-heading-4 ui-slider-heading-4--bizproc-icon">',"</div>\n\t\t\t\t","\n\t\t\t</div>"]);o=function t(){return e};return e}function s(){var e=babelHelpers.taggedTemplateLiteral(['<div class="bizproc-script-edit-item">\n\t\t\t\t<div class="bizproc-script-edit-title">','</div>\n\t\t\t\t<div class="bizproc-script-edit-text">',"</div>\n\t\t\t</div>"]);s=function t(){return e};return e}function c(){var e=babelHelpers.taggedTemplateLiteral(['<div class="bizproc-script-edit-item">\n\t\t\t\t<div class="bizproc-script-edit-title">','</div>\n\t\t\t\t<div class="bizproc-script-edit-text">',"</div>\n\t\t\t</div>"]);c=function t(){return e};return e}function l(){var e=babelHelpers.taggedTemplateLiteral(['<div class="ui-alert ui-alert-default ui-alert-xs ui-alert-icon-info">\n\t\t\t\t\t<span class="ui-alert-message">',"</span>\n\t\t\t\t</div>"]);l=function t(){return e};return e}function u(){var e=babelHelpers.taggedTemplateLiteral(['<form data-role="constant-list" onsubmit="return false;">',"</form>"]);u=function t(){return e};return e}function d(e,t){var n;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(n=f(e))||t&&e&&typeof e.length==="number"){if(n)e=n;var i=0;var r=function e(){};return{s:r,n:function t(){if(i>=e.length)return{done:true};return{done:false,value:e[i++]}},e:function e(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,o=false,s;return{s:function t(){n=e[Symbol.iterator]()},n:function e(){var t=n.next();a=t.done;return t},e:function e(t){o=true;s=t},f:function e(){try{if(!a&&n.return!=null)n.return()}finally{if(o)throw s}}}}function f(e,t){if(!e)return;if(typeof e==="string")return p(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor)n=e.constructor.name;if(n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return p(e,t)}function p(e,t){if(t==null||t>e.length)t=e.length;for(var n=0,i=new Array(t);n<t;n++){i[n]=e[n]}return i}function v(e,t,n){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return n}var m=t.Reflection.namespace("BX.Bizproc");var h=function e(t){return JSON.stringify(t,function(e,t){if(typeof t==="boolean"){return t?"1":"0"}return t})};var g=new WeakSet;var b=new WeakSet;var T=new WeakSet;var I=new WeakSet;var y=function(){function e(n){babelHelpers.classCallCheck(this,e);I.add(this);T.add(this);b.add(this);g.add(this);babelHelpers.defineProperty(this,"constantPrefix","Constant__");babelHelpers.defineProperty(this,"parameterPrefix","Parameter__");if(t.Type.isPlainObject(n)){this.baseNode=n.baseNode;this.leftMenuNode=n.leftMenuNode;this.saveButtonNode=n.saveButtonNode;this.formNode=n.formNode;this.documentType=n.documentType;this.signedParameters=n.signedParameters;this.saveCallback=n.saveCallback}this.automationDesigner=BX.Bizproc.Automation.Designer.component}babelHelpers.createClass(e,[{key:"init",value:function e(){var i=this;if(this.saveButtonNode){t.Event.bind(this.saveButtonNode,"click",this.saveHandler.bind(this))}if(this.baseNode&&this.leftMenuNode){this.initMenu()}if(this.formNode){this.scriptNameNode=this.formNode.elements.NAME;t.Event.bind(this.scriptNameNode,"blur",function(){if(!t.Type.isStringFilled(i.scriptNameNode.value)){t.Dom.addClass(i.scriptNameNode.closest(".ui-ctl"),"ui-ctl-danger")}else{t.Dom.removeClass(i.scriptNameNode.closest(".ui-ctl"),"ui-ctl-danger")}})}if(this.automationDesigner){n.EventEmitter.subscribe(this.automationDesigner,"onTemplateConstantAdd",function(){if(i.configsMenuItem){i.configsMenuItem.addNoticeIcon()}})}}},{key:"saveHandler",value:function e(){var n=this;var i=new FormData(this.formNode);var r={};var a=d(i.entries()),o;try{for(a.s();!(o=a.n()).done;){var s=o.value;r[s[0]]=s[1]}}catch(e){a.e(e)}finally{a.f()}if(!v(this,T,P).call(this,r.NAME)){t.Dom.removeClass(this.saveButtonNode,"ui-btn-wait");return false}var c=v(this,g,C).call(this);this.setTemplateValues(c);if(!v(this,I,D).call(this,c.getConstants(),c.collectUsages().Constant)){t.Dom.removeClass(this.saveButtonNode,"ui-btn-wait");return false}BX.ajax.runComponentAction("bitrix:bizproc.script.edit","saveScript",{analyticsLabel:r.ID>0?"bizprocScriptUpdate":"bizprocScriptAdd",data:{signedParameters:this.signedParameters,documentType:this.documentType,script:r,robotsTemplate:h(c.serialize())}}).then(function(e){if(t.Type.isFunction(n.saveCallback)){n.saveCallback(e)}})}},{key:"initMenu",value:function e(){var n=this;Array.from(this.leftMenuNode.querySelectorAll('[data-role="menu-item"]')).forEach(function(e){t.Event.bind(e,"click",n.menuActivateHandler.bind(n,e.getAttribute("data-page")));if(e.getAttribute("data-page")==="configs"&&BX.UI.DropdownMenuItem.getItemByNode){n.configsMenuItem=BX.UI.DropdownMenuItem.getItemByNode(e)}})}},{key:"menuActivateHandler",value:function e(n){var i=this;Array.from(this.baseNode.querySelectorAll("[data-section]")).forEach(function(e){if(e.getAttribute("data-section")===n){if(n==="configs"&&t.Dom.hasClass(e,"bizproc-script-edit-block-hidden")){i.showConfigsHandler(e)}else{i.setTemplateValues(v(i,g,C).call(i))}t.Dom.removeClass(e,"bizproc-script-edit-block-hidden")}else{t.Dom.addClass(e,"bizproc-script-edit-block-hidden")}})}},{key:"showConfigsHandler",value:function e(n){var i=this;t.Dom.clean(n);var r=v(this,g,C).call(this);var a=r.getConstants();var o=r.getParameters();var s=[];r.robots.forEach(function(e){var t=i.renderRobotConfigBlock(e,a,o);if(t){s.push(t)}});if(s.length){t.Dom.append(t.Tag.render(u(),s),n)}else{return t.Dom.append(t.Tag.render(l(),t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_SECTION_CONFIGS_EMPTY")),n)}}},{key:"renderRobotConfigBlock",value:function e(n,i,r){var a=this;var l=n.collectUsages();var u=[];if(!l.Constant.size&&!l.Parameter.size){return null}if(l.Constant.size){u.push(t.Tag.render(c(),t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_CONSTANT_LABEL"),t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_CONSTANT_DESCRIPTION")));l.Constant.forEach(function(e){var t=i.find(function(t){return t.Id===e});if(t){u.push(a.renderPropertyBlock(t,a.constantPrefix))}})}if(l.Parameter.size){u.push(t.Tag.render(s(),t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_PARAMETER_LABEL"),t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_PARAMETER_DESCRIPTION")));l.Parameter.forEach(function(e){var t=r.find(function(t){return t.Id===e});if(t){u.push(a.renderPropertyBlock(t,a.parameterPrefix))}})}return t.Tag.render(o(),t.Text.encode(n.getTitle()),u)}},{key:"renderPropertyBlock",value:function e(n,i){var r=BX.Bizproc.FieldType.renderControl(this.automationDesigner.documentType,n,i+n.Id,n.Default);return t.Tag.render(a(),t.Text.encode(n.Name),t.Text.encode(n.Description),this.changePropertyDescription.bind(this,i,n),t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_BTN_CHANGE"),r)}},{key:"changePropertyDescription",value:function e(n,i,a){var o=this;var s=a.currentTarget;var c=s.previousElementSibling;t.Dom.hide(s);var l=t.Tag.render(r());l.value=i.Description||"";t.Dom.clean(c);t.Dom.append(l,c);l.focus();var u=function e(){var r=l.value.trim();i.Description=r;t.Dom.clean(c);c.textContent=r;t.Dom.show(s);var a=v(o,g,C).call(o);if(n===o.constantPrefix){a.updateConstant(i.Id,i)}else{a.updateParameter(i.Id,i)}};t.Event.bind(l,"blur",u);t.Event.bind(l,"keydown",function(e){if(e.keyCode===13){t.Event.unbind(l,"blur",u);u()}})}},{key:"setTemplateValues",value:function e(t){var n=this;var i=this.baseNode?this.baseNode.querySelector('[data-role="constant-list"]'):null;if(!i){return}var r=new FormData(i);t.getConstants().forEach(function(e){t.setConstantValue(e.Id,r.get(n.constantPrefix+e.Id))});t.getParameters().forEach(function(e){t.setParameterValue(e.Id,r.get(n.parameterPrefix+e.Id))})}}]);return e}();var C=function e(){return this.automationDesigner.templateManager.templates[0]};var N=function e(t){if(BX.UI.DropdownMenuItem.getItemByNode){var n=BX.UI.DropdownMenuItem.getItemByNode(this.leftMenuNode.querySelector('[data-page="'.concat(t,'"]')));this.menuActivateHandler(t);n&&n.setActiveHandler()}if(t==="general"){this.scriptNameNode.focus()}if(t!=="configs"){this.setTemplateValues(v(this,g,C).call(this))}};var P=function e(n){if(!t.Type.isStringFilled(n)){i.UI.Notification.Center.notify({content:t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_VALIDATION_EMPTY_NAME")});v(this,b,N).call(this,"general");return false}return true};var D=function e(n,r){var a=true;n.forEach(function(e){if(r.has(e.Id)&&!t.Type.isStringFilled(e.Default)){a=false}});if(!a){i.UI.Notification.Center.notify({content:t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_VALIDATION_EMPTY_CONFIGS")});v(this,b,N).call(this,"configs")}return a};m.ScriptEditComponent=y})(this.window=this.window||{},BX,BX.Event,BX);
//# sourceMappingURL=script.map.js