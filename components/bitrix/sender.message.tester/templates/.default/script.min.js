(function(t){t.BX.namespace("BX.Sender.Message");if(BX.Sender.Message.Tester){return}var e=BX.Sender.Helper;function s(){}s.prototype.classNameBtnWait="ui-btn-wait";s.prototype.eventNameSend="sender-message-test-send";s.prototype.init=function(t){this.context=BX(t.containerId);this.id=t.id;this.actionUri=t.actionUri;this.mess=t.mess||{};this.ajaxAction=new BX.AjaxAction(this.actionUri);this.messageCode=t.messageCode;this.lastRecipients=t.lastRecipients;this.type=t.type;this.types=t.types;this.button=e.getNode("test-button",this.context);this.result=e.getNode("test-result",this.context);this.buttonValidation=e.getNode("test-validation-button",this.context);this.initSelector();if(this.button&&this.result){BX.bind(this.button,"click",this.send.bind(this,"test",this.result,this.button))}if(this.buttonValidation&&this.result){BX.bind(this.buttonValidation,"click",this.send.bind(this,"consent",this.result,this.buttonValidation))}};s.prototype.validate=function(t){switch(this.type){case this.types.mail:return this.validateEmail(t);break;case this.types.phone:return this.validatePhone(t);break}return true};s.prototype.initSelector=function(){this.selector=BX.Sender.UI.TileSelector.getById(this.id);if(!this.selector){throw new Error("Tile selector `"+this.id+"` not found.")}BX.addCustomEvent(this.selector,this.selector.events.search,this.onSearch.bind(this));BX.addCustomEvent(this.selector,this.selector.events.buttonSelect,this.onButtonSelect.bind(this));BX.addCustomEvent(this.selector,this.selector.events.buttonSelectFirst,this.onButtonSelectFirst.bind(this))};s.prototype.onButtonSelect=function(){var t="";switch(this.type){case this.types.mail:t=this.mess.searchTitleMail;break;case this.types.phone:t=this.mess.searchTitlePhone;break}this.selector.showSearcher(t)};s.prototype.onButtonSelectFirst=function(){var t=[{id:"last",name:this.mess.categoryLast,items:this.lastRecipients.map(function(t){return{id:t,name:t,data:{}}})}];this.selector.setSearcherData(t)};s.prototype.onSearch=function(t){(t||"").split(",").forEach(function(t){t=t.trim();if(!t||!this.validate(t)){return}this.selector.addTile(t,{},t)},this)};s.prototype.validateEmail=function(t){return null!==t.match(/^[\w\.\d-_]+@[\w\.\d-_]+\.\w{2,15}$/i)};s.prototype.validatePhone=function(t){return null!==t.match(/^[\+]?[\d]{4,25}$/i)};s.prototype.printResult=function(t,e,s,i){i=i||{isSuccess:null};var n;if(i.isSuccess===null){n=""}else if(!i.isSuccess){if(i.errorCode){n="";var o=this;var r=new BX.Sender.ErrorHandler;r.onError(i.errorCode,{text:i.resultErrors.join("\n")},function(){o.send()},function(){})}else{n=i.resultErrors?i.resultErrors.join("\n"):""}}else if(this.messageCode==="mail"){n=t?this.mess.consentSuccess:this.mess.testSuccess}else{n=this.mess.testSuccessPhone}e.textContent=n;this.removeWaitingIndicator(s)};s.prototype.removeWaitingIndicator=function(t){BX.removeClass(t,this.classNameBtnWait)};s.prototype.addWaitingIndicator=function(t){BX.addClass(t,this.classNameBtnWait)};s.prototype.convertDataFromPostToJson=function(t){for(var e in t){if(!t.hasOwnProperty(e)){continue}if(!/[\[]+/.test(e)){continue}var s=e.split("[").map(function(t){return t.replace("]","")});s.reduce(function(t,e){if(!t[e]||!BX.type.isPlainObject(t[e])){t[e]={}}return t[e]},t);s.reduce(function(s,i){if(!BX.type.isPlainObject(s[i])){return}if(!BX.type.isNotEmptyObject(s[i])){s[i]=t[e];return}return s[i]},t);t[e]=null}return t};s.prototype.send=function(t,e,s){var i=this.selector.getTilesId().map(function(t){return t.trim()}).filter(function(t){return t.length>0});if(i.length===0){this.printResult(null,e,s,{isSuccess:false,resultErrors:[this.mess.testEmpty]});return}var n={id:null,data:{}},o=t==="consent";BX.onCustomEvent(this,this.eventNameSend,[n]);this.printResult(o,e,s,null);this.addWaitingIndicator(s);this.ajaxAction.request({action:t,onsuccess:this.printResult.bind(this,o,e,s),onfailure:this.removeWaitingIndicator.bind(this,s),data:{list:i,messageCode:this.messageCode,messageId:n.id,messageData:this.convertDataFromPostToJson(n.data)}})};BX.Sender.Message.Tester=new s})(window);
//# sourceMappingURL=script.map.js