(function(t){t.BX.namespace("BX.Sender.Message");if(BX.Sender.Message.Tester){return}var e=BX.Sender.Helper;function s(){}s.prototype.classNameBtnWait="ui-btn-wait";s.prototype.eventNameSend="sender-message-test-send";s.prototype.init=function(t){this.context=BX(t.containerId);this.id=t.id;this.actionUri=t.actionUri;this.mess=t.mess||{};this.ajaxAction=new BX.AjaxAction(this.actionUri);this.messageCode=t.messageCode;this.lastRecipients=t.lastRecipients;this.type=t.type;this.types=t.types;this.button=e.getNode("test-button",this.context);this.result=e.getNode("test-result",this.context);this.initSelector();BX.bind(this.button,"click",this.send.bind(this))};s.prototype.validate=function(t){switch(this.type){case this.types.mail:return this.validateEmail(t);break;case this.types.phone:return this.validatePhone(t);break}return true};s.prototype.initSelector=function(){this.selector=BX.Sender.UI.TileSelector.getById(this.id);if(!this.selector){throw new Error("Tile selector `"+this.id+"` not found.")}BX.addCustomEvent(this.selector,this.selector.events.search,this.onSearch.bind(this));BX.addCustomEvent(this.selector,this.selector.events.buttonSelect,this.onButtonSelect.bind(this));BX.addCustomEvent(this.selector,this.selector.events.buttonSelectFirst,this.onButtonSelectFirst.bind(this))};s.prototype.onButtonSelect=function(){var t="";switch(this.type){case this.types.mail:t=this.mess.searchTitleMail;break;case this.types.phone:t=this.mess.searchTitlePhone;break}this.selector.showSearcher(t)};s.prototype.onButtonSelectFirst=function(){var t=[{id:"last",name:this.mess.categoryLast,items:this.lastRecipients.map(function(t){return{id:t,name:t,data:{}}})}];this.selector.setSearcherData(t)};s.prototype.onSearch=function(t){(t||"").split(",").forEach(function(t){t=t.trim();if(!t||!this.validate(t)){return}this.selector.addTile(t,{},t)},this)};s.prototype.validateEmail=function(t){return null!==t.match(/^[\w\.\d-_]+@[\w\.\d-_]+\.\w{2,15}$/i)};s.prototype.validatePhone=function(t){return null!==t.match(/^[\+]?[\d]{4,25}$/i)};s.prototype.printResult=function(t){t=t||{isSuccess:null};var e;if(t.isSuccess===null){e=""}else if(!t.isSuccess){if(t.errorCode){e="";var s=this;var i=new BX.Sender.ErrorHandler;i.onError(t.errorCode,{text:t.resultErrors.join("\n")},function(){s.send()},function(){})}else{e=t.resultErrors.join("\n")}}else if(this.messageCode==="mail"){e=this.mess.testSuccess}else{e=this.mess.testSuccessPhone}this.result.textContent=e;this.removeWaitingIndicator()};s.prototype.removeWaitingIndicator=function(){BX.removeClass(this.button,this.classNameBtnWait)};s.prototype.addWaitingIndicator=function(){BX.addClass(this.button,this.classNameBtnWait)};s.prototype.convertDataFromPostToJson=function(t){for(var e in t){if(!t.hasOwnProperty(e)){continue}if(!/[\[]+/.test(e)){continue}var s=e.split("[").map(function(t){return t.replace("]","")});s.reduce(function(t,e){if(!t[e]||!BX.type.isPlainObject(t[e])){t[e]={}}return t[e]},t);s.reduce(function(s,i){if(!BX.type.isPlainObject(s[i])){return}if(!BX.type.isNotEmptyObject(s[i])){s[i]=t[e];return}return s[i]},t);t[e]=null}return t};s.prototype.send=function(){var t=this.selector.getTilesId().map(function(t){return t.trim()}).filter(function(t){return t.length>0});if(t.length===0){this.printResult({isSuccess:false,resultErrors:[this.mess.testEmpty]});return}var e={id:null,data:{}};BX.onCustomEvent(this,this.eventNameSend,[e]);this.printResult();this.addWaitingIndicator(this.button,this.classNameBtnWait);this.ajaxAction.request({action:"test",onsuccess:this.printResult.bind(this),onfailure:this.removeWaitingIndicator.bind(this),data:{list:t,messageCode:this.messageCode,messageId:e.id,messageData:this.convertDataFromPostToJson(e.data)}})};BX.Sender.Message.Tester=new s})(window);
//# sourceMappingURL=script.map.js