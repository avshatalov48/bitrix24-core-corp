(function(e,t,r,n,a,i){"use strict";var o,s;function l(e,t){var r=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=u(e))||t&&e&&typeof e.length==="number"){if(r)e=r;var n=0;var a=function e(){};return{s:a,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i=true,o=false,s;return{s:function t(){r=r.call(e)},n:function e(){var t=r.next();i=t.done;return t},e:function e(t){o=true;s=t},f:function e(){try{if(!i&&r["return"]!=null)r["return"]()}finally{if(o)throw s}}}}function u(e,t){if(!e)return;if(typeof e==="string")return c(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return c(e,t)}function c(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var d=t.Reflection.namespace("BX.Bizproc.Component");var f=function(){function e(r){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"delegateToUserId",0);babelHelpers.defineProperty(this,"workflowTasks",{});babelHelpers.defineProperty(this,"tasksWorkflowsMap",{});if(t.Type.isPlainObject(r)){this.gridId=r.gridId;if(t.Type.isArray(r.errors)){this.showErrors(r.errors)}this.actionPanel={wrapperElementId:r.actionPanelUserWrapperId,actionButtonName:"".concat(this.gridId,"_action_button")};this.currentUserId=r.currentUserId}this.bindAnchors();this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){this.actionPanel.userWrapperElement=document.getElementById(this.actionPanel.wrapperElementId);var r=l(document.querySelectorAll('[data-role="workflow-tasks-data"]')),n;try{for(r.s();!(n=r.n()).done;){var a=n.value;var i=a.dataset.workflowId;var o=JSON.parse(a.dataset.tasks);if(t.Type.isStringFilled(i)&&t.Type.isArray(o)){this.workflowTasks[i]=o;var s=l(o),u;try{for(s.s();!(u=s.n()).done;){var c=u.value;this.tasksWorkflowsMap[c.id]=i}}catch(e){s.e(e)}finally{s.f()}}}}catch(e){r.e(e)}finally{r.f()}this.initUserSelector();this.initTasksColumn();this.onActionPanelChanged()}},{key:"bindAnchors",value:function e(){var t=this;BX.SidePanel.Instance.bindAnchors({rules:[{condition:["/rpa/task/"],options:{width:580,cacheable:false,allowChangeHistory:false,events:{onClose:function e(){return t.reloadGrid()}}}}]})}},{key:"initTasksColumn",value:function e(){var t=document.querySelectorAll(".bp-task-container");var r=l(t),n;try{for(r.s();!(n=r.n()).done;){var a=n.value;this.renderParallelTasksTo(a)}}catch(e){r.e(e)}finally{r.f()}}},{key:"renderParallelTasksTo",value:function e(r){var n=parseInt(r.dataset.taskId,10);var a=this.tasksWorkflowsMap[n];if(t.Type.isNumber(n)&&t.Type.isStringFilled(a)){var i;var o=(i=this.workflowTasks[a])!==null&&i!==void 0?i:[];if(o.length>1){var s=this;var l=o.filter((function(e){return e.id!==n})).map((function(e){return{id:e.id,text:e.name,onclick:function r(){this.close();var n=this.getPopupWindow().bindElement;var a=n.parentElement.parentElement.parentElement;var i=a.parentElement;t.Dom.clean(i);t.Runtime.html(i,e.renderedName)["catch"]((function(e){return console.error(e)}));var o=i.querySelector(".bp-task-container");if(o){s.renderParallelTasksTo(o)}}}}));if(!t.Type.isNil(r.lastElementChild)){var u=o.filter((function(e){return e.canComplete}));if(u.length>0){t.Dom.prepend(this.renderParallelTasksCounter(u.length),r)}t.Dom.append(this.renderParallelTasksLabel(a,n,l),r.lastElementChild)}}}}},{key:"renderParallelTasksCounter",value:function e(r){var a=new n.Counter({value:r,color:n.CounterColor.DANGER});return t.Dom.create("div",{style:{paddingRight:"5px"},children:[a.createContainer()]})}},{key:"renderParallelTasksLabel",value:function e(r,n,a){var s=t.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<span class="bp-task-label-container">\n\t\t\t\t<a ref="label" class="bp-task-label">\n\t\t\t\t\t',"\n\t\t\t\t</a>\n\t\t\t</span>\n\t\t"])),t.Loc.getMessage("BIZPROC_USER_PROCESSES_TEMPLATE_TASKS_LABEL",{"#COUNT#":a.length})),l=s.label,u=s.root;l.onclick=function(e){e.preventDefault();var t="bp-workflow-".concat(r,"-parallel-tasks-with-task-id-").concat(n);var o=i.MenuManager.create({id:t,angle:true,items:a});o.getPopupWindow().setBindElement(l);o.show()};return u}},{key:"initStartWorkflowButton",value:function e(r){var n=t.Type.isStringFilled(r)&&document.getElementById(r);var a=t.Type.isStringFilled(n===null||n===void 0?void 0:n.dataset.lists)&&JSON.parse(n.dataset.lists);if(a){var o=new i.Menu({angle:true,offsetLeft:t.Dom.getPosition(n).width/2,autoHide:true,bindElement:n,closeByEsc:true,items:Object.values(a).map((function(e){return{text:e.name,href:e.url,className:"feed-add-post-form-link-lists",dataset:{iconUrl:e.icon}}}))});var u=o.getMenuContainer();var c=l(u.querySelectorAll(".menu-popup-item-icon")),d;try{for(c.s();!(d=c.n()).done;){var f=d.value;t.Dom.append(t.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t<img src = "','" alt="" width = "19" height = "16"/>\n\t\t\t\t\t'])),f.parentElement.dataset.iconUrl),f)}}catch(e){c.e(e)}finally{c.f()}n.onclick=function(e){e.preventDefault();o.show()}}}},{key:"initUserSelector",value:function e(){var r=this;this.delegateToSelector=new a.TagSelector({multiple:false,tagMaxWidth:180,events:{onTagAdd:function e(n){r.delegateToUserId=parseInt(n.getData().tag.getId(),10);if(!t.Type.isInteger(r.delegateToUserId)){r.delegateToUserId=0}},onTagRemove:function e(){r.delegateToUserId=0}},dialogOptions:{entities:[{id:"user",options:{intranetUsersOnly:true,inviteEmployeeLink:false}}]}});if(t.Type.isDomNode(this.actionPanel.userWrapperElement)){this.delegateToSelector.renderTo(this.actionPanel.userWrapperElement)}}},{key:"showErrors",value:function e(n){var a=document.getElementById("bp-user-processes-errors-container");if(a){var i=0;var o=function e(){if(i>0){t.Dom.style(a,{margin:"10px"})}else{t.Dom.style(a,{margin:"0px"})}};var s=l(n),u;try{for(s.s();!(u=s.n()).done;){var c=u.value;i+=1;var d=new r.Alert({text:t.Text.encode(c.message),color:r.AlertColor.DANGER,closeBtn:true,animated:true});d.renderTo(a);if(d.getCloseBtn()){d.getCloseBtn().onclick=function(){i-=1;o()}}}}catch(e){s.e(e)}finally{s.f()}o()}}},{key:"onActionPanelChanged",value:function e(){var r=this.getGrid();var n=r===null||r===void 0?void 0:r.getActionsPanel();if(n){var a=n.getValues()[this.actionPanel.actionButtonName];if(!t.Type.isString(a)||a.includes("set_status")){t.Dom.hide(this.actionPanel.userWrapperElement)}else{t.Dom.show(this.actionPanel.userWrapperElement)}}}},{key:"applyActionPanelValues",value:function e(){var r=this.getGrid();var n=r===null||r===void 0?void 0:r.getActionsPanel();if(r&&n){var a;var i=((a=n.getForAllCheckbox())===null||a===void 0?void 0:a.checked)===true;if(i){this.showErrors([{message:"Not implemented currently"}])}var o=n.getValues()[this.actionPanel.actionButtonName];if(t.Type.isString(o)){var s=this.getSelectedTaskIds(r.getRows().getSelectedIds());if(o.includes("set_status_")){var l=parseInt(o.split("_").pop(),10);if(t.Type.isNumber(l)){this.setTasksStatuses(s,l)}}else if(o.startsWith("delegate_to")){this.delegateTasks(s,this.delegateToUserId)}}}}},{key:"getSelectedTaskIds",value:function e(r){var n=this;return r.map((function(e){var t;return(t=n.workflowTasks[e][0])===null||t===void 0?void 0:t.id})).filter((function(e){return t.Type.isNumber(e)}))}},{key:"setTasksStatuses",value:function e(r,n){var a=this;t.ajax.runAction("bizproc.task.doInlineTasks",{data:{taskIds:r,newStatus:n}})["catch"]((function(e){a.showErrors(e.errors);a.reloadGrid()})).then((function(){return a.reloadGrid()}))}},{key:"delegateTasks",value:function e(r,n){var a=this;t.ajax.runComponentAction("bitrix:bizproc.user.processes","delegateTasks",{mode:"class",data:{taskIds:r,toUserId:n}})["catch"]((function(e){a.showErrors(e.errors);a.reloadGrid()})).then((function(){return a.reloadGrid()}))}},{key:"reloadGrid",value:function e(){var t=this.getGrid();if(t){t.reload()}else{console.warn("Grid not found")}}},{key:"updateTaskData",value:function e(t){location.reload()}},{key:"getGrid",value:function e(){if(this.gridId){var t;return(t=BX.Main.gridManager)===null||t===void 0?void 0:t.getInstanceById(this.gridId)}return null}}]);return e}();d.UserProcesses=f})(this.window=this.window||{},BX,BX.UI,BX.UI,BX.UI.EntitySelector,BX.Main);
//# sourceMappingURL=script.map.js