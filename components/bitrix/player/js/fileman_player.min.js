(function(){BX.namespace("BX.Fileman");if(window.BX.Fileman.PlayerManager){return}BX.Fileman.PlayerManager={isStarted:false,players:[],playing:false,slider:null,addPlayer:function(t){this.players.push(t);this.bindPlayerEvents(t);if(t.autostart||t.lazyload){this.init()}},init:function(){if(this.isStarted){return}this.isStarted=true;BX.ready(BX.proxy(function(){BX.bind(window,"scroll",BX.throttle(BX.Fileman.PlayerManager.onScroll,300,BX.Fileman.PlayerManager));setTimeout(BX.delegate(BX.Fileman.PlayerManager.onScroll,BX.Fileman.PlayerManager),50);if(window!==window.top){if(BX.getClass("top.BX.SidePanel.Instance")){var t=top.BX.SidePanel.Instance.getSliderByWindow(window);if(t){this.slider=t;BX.addCustomEvent("SidePanel.Slider:onCloseComplete",BX.proxy(function(t){if(t.getSlider()===this.slider){for(var e in this.players){this.players[e].pause()}}},this))}}}},this))},bindPlayerEvents:function(t){var e=t.getEventList();if(e){for(var i=0;i<e.length;i++){BX.addCustomEvent(t,e[i],BX.proxy(function(t,e){BX.onCustomEvent(BX.Fileman.PlayerManager,"PlayerManager."+e,[t])},this))}}},onScroll:function(){if(this.players.length==0){return}var t=false;var e=false;for(var i in this.players){var a=this.players[i];if(!BX(a.id)){this.players.splice(i,1);continue}if(a.lazyload&&!a.inited){if(this.isVisibleOnScreen(a.id,2)){a.init()}}if(!a.autostart){continue}if(a.active){continue}if(a.isEnded()){continue}if(this.isVisibleOnScreen(a.id,1)){if(t===false){t=a}}else{if(a.isPlaying()){a.pause()}}if(a.isPlaying()){e=true}}if(e){return}if(t!==false){if(!t.inited){t.autostart=true}else if(t.isReady()&&!t.isEnded()){t.mute(true);BX.addCustomEvent(t,"Player:onClick",BX.proxy(t.disableMute,t));t.play()}}},getElementCoords:function(t){var e=.25;var i=BX(t).getBoundingClientRect();var a=i.bottom-i.top;var r=i.top+e*a;var s=i.bottom-e*a;var n=i.right-i.left;var o=i.left+e*n;var l=i.right-e*n;coords={top:r+window.pageYOffset,bottom:s+window.pageYOffset,left:o+window.pageXOffset,right:l+window.pageXOffset,originTop:r,originLeft:o,originBottom:s,originRight:l};return coords},isVisibleOnScreen:function(t,e){var i,a=false;var r=this.getElementCoords(t);var s=document.documentElement.clientHeight;var n=window.pageYOffset||document.documentElement.scrollTop;var o=n+s;if(e){e=parseInt(e)}if(e>1){n-=s*(e-1);o+=s*(e-1)}var l=r.top>n&&r.top<o;var h=r.bottom<o&&r.bottom>n;i=l||h;if(i&&e>1){return true}if(!i){return false}var y=BX(t);var f=r.originLeft+(r.originRight-r.originLeft)/2;var p=r.originTop+(r.originBottom-r.originTop)/2+20;var u=document.elementFromPoint(f,p);if(!!u){if(u===y||u.parentNode===y||u.parentNode.parentNode===y){a=true}}return i&&a},getPlayerById:function(t){if(!t){return null}for(var e in this.players){if(this.players[e].id===t){return this.players[e]}}return null}};BX.Fileman.Player=function(t,e){this.inited=false;this.id=t;this.fillParameters(e);BX.Fileman.PlayerManager.addPlayer(this);this.fireEvent("onCreate");BX.bind(BX(this.id),"click",BX.proxy(this.onClick,this));BX.bind(BX(this.id),"keydown",BX.proxy(this.onKeyDown,this))};BX.Fileman.Player.prototype.onClick=function(){var t=BX.findChildByClassName(this.getElement(),"vjs-play-control");if(t){t.focus()}this.active=true;this.fireEvent("onClick")};BX.Fileman.Player.prototype.isPlaying=function(){if(this.vjsPlayer){return this.vjsPlayer.isReady_&&!this.vjsPlayer.paused()}return false};BX.Fileman.Player.prototype.pause=function(){try{this.vjsPlayer.pause()}catch(t){}this.fireEvent("onPause")};BX.Fileman.Player.prototype.isEnded=function(){if(this.vjsPlayer){return this.vjsPlayer.ended()}return false};BX.Fileman.Player.prototype.isReady=function(){return this.vjsPlayer.isReady_};BX.Fileman.Player.prototype.play=function(){this.setPlayedState();try{this.vjsPlayer.play()}catch(t){}this.fireEvent("onPlay")};BX.Fileman.Player.prototype.setPlayedState=function(){var t=this.__getStorageHash();if(BX.localStorage){BX.localStorage.set(t,"played",1209600)}};BX.Fileman.Player.prototype.isPlayed=function(){var t=this.__getStorageHash();if(BX.localStorage){return BX.localStorage.get(t)==="played"}return true};BX.Fileman.Player.prototype.__getStorageHash=function(){var t=this.id;if(this.params.sources&&BX.type.isArray(this.params.sources)&&this.params.sources[0].src){t=this.params.sources[0].src}return"player_"+t};BX.Fileman.Player.prototype.getElement=function(){return BX(this.id)};BX.Fileman.Player.prototype.createElement=function(){var t=this.getElement();if(t){return t}if(!this.id){return null}var e="video";if(this.isAudio){e="audio"}var i="video-js vjs-big-play-centered";if(this.skin){i+=" "+this.skin}var a={id:this.id,className:i,width:this.width,height:this.height,controls:true};if(this.muted){a["muted"]=true}t=BX.create(e,{attrs:a});if(this.params.sources){if(BX.type.isArray(this.params.sources)){for(var r in this.params.sources){if(!this.params.sources[r].src||!this.params.sources[r].type){continue}var s=BX.create("source",{attrs:{src:this.params.sources[r].src,type:this.params.sources[r].type}});BX.append(s,t)}}}return t};BX.Fileman.Player.prototype.fillParameters=function(t){this.autostart=t.autostart||false;this.width=t.width||400;this.height=t.height||300;this.hasFlash=t.hasFlash||false;if(t.playbackRate&&!t.hasFlash){t.playbackRate=parseInt(t.playbackRate);if(t.playbackRate!=1){if(t.playbackRate<=0){t.playbackRate=1}if(t.playbackRate>3){t.playbackRate=3}}if(t.playbackRate!=1){this.playbackRate=t.playbackRate}}this.volume=t.volume||.8;this.playlistParams=t.playlistParams||false;this.startTime=t.startTime||0;this.wmvConfig=t.wmvConfig||false;this.onInit=t.onInit;this.lazyload=t.lazyload;this.skin=t.skin||"";this.params=t;this.active=this.isPlayed()};BX.Fileman.Player.prototype.onKeyDown=function(t){if(t.which==32){this.onClick();if(this.isPlaying()){this.pause()}else{this.play()}t.preventDefault();t.stopPropagation();return false}this.fireEvent("onKeyDown")};BX.Fileman.Player.prototype.setSource=function(t){if(!t){return false}this.vjsPlayer.src(t);this.fireEvent("onSetSource")};BX.Fileman.Player.prototype.getSource=function(){return this.vjsPlayer.src()};BX.Fileman.Player.prototype.init=function(){this.fireEvent("onBeforeInit");if(videojs.players[this.id]){delete videojs.players[this.id]}this.vjsPlayer=videojs(this.id,this.params);this.vjsPlayer.on("error",BX.proxy(function(){this.fireEvent("onError");if(!this.isFlashErrrorShown&&this.hasFlash){this.isFlashErrrorShown=true;var t=this.vjsPlayer.error();if(t&&t.code===4){t.message=t.message+". "+BX.message("PLAYER_FLASH_CHECK");this.vjsPlayer.errorDisplay.content(t.message)}}},this));if(this.hasFlash){setTimeout(BX.proxy(function(){if(!this.inited){this.vjsPlayer.error(BX.message("PLAYER_FLASH_REQUIRED"));this.inited=true}},this),3e3)}this.vjsPlayer.ready(BX.proxy(function(){var t=BX.findChildByClassName(BX(this.id),"vjs-play-control");if(t){t.addEventListener("click",BX.proxy(this.onClick,this))}this.vjsPlayer.volume(this.volume);this.vjsPlayer.one("play",BX.proxy(function(){if(this.playbackRate!=1){this.vjsPlayer.playbackRate(this.playbackRate)}if(this.volume){this.vjsPlayer.volume(this.volume)}if(this.startTime>0){try{this.vjsPlayer.currentTime(this.startTime);var t=BX.findChild(BX(this.id),{class:"vjs-loading-spinner"},false);if(t){t.remove()}}catch(t){}}},this));if(this.playlistParams){this.vjsPlayer.playlist(this.playlistParams)}if(this.wmvConfig){this.vjsPlayer.wmvConfig=this.wmvConfig}this.inited=true;if(BX.type.isFunction(this.onInit)){this.onInit(this)}this.fireEvent("onAfterInit");this.proxyEvents()},this))};BX.Fileman.Player.prototype.getEventList=function(){return["Player:onBeforeInit","Player:onAfterInit","Player:onCreate","Player:onSetSource","Player:onKeyDown","Player:onPlay","Player:onPause","Player:onClick","Player:onError","Player:onEnded"]};BX.Fileman.Player.prototype.fireEvent=function(t){if(BX.type.isNotEmptyString(t)){t="Player:"+t;BX.onCustomEvent(this,t,[this,t])}};BX.Fileman.Player.prototype.mute=function(t){return this.vjsPlayer.muted(t)};BX.Fileman.Player.prototype.disableMute=function(){BX.removeCustomEvent(this,"Player:onClick",BX.proxy(this.disableMute,this));setTimeout(BX.proxy(function(){this.mute(false)},this),100)};BX.Fileman.Player.prototype.proxyEvents=function(){if(!this.inited){return}this.vjsPlayer.on("play",BX.proxy(function(){this.fireEvent("onPlay")},this));this.vjsPlayer.on("pause",BX.proxy(function(){this.fireEvent("onPause")},this));this.vjsPlayer.on("ended",BX.proxy(function(){this.fireEvent("onEnded")},this))}})(window);