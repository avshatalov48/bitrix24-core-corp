{"version":3,"file":"mobile.js","sources":["src/mobile.js"],"sourcesContent":["import {Loc} from 'main.core';\n\nlet\n\tBX = window.BX,\n\tBXMobileApp = window.BXMobileApp;\n\nlet nodeElementCrm = (function ()\n{\n\tlet nodeElementCrm = function (node, container, useOnChangeEvent, availableTypes)\n\t{\n\t\tthis.node = node;\n\t\tthis.container = container;\n\t\tthis.click = BX.delegate(this.click, this);\n\t\tthis.callback = BX.delegate(this.callback, this);\n\t\tthis.multiple = this.container.hasAttribute('multiple');\n\t\tthis.useOnChangeEvent = useOnChangeEvent || false;\n\t\tthis.availableTypes = availableTypes || [];\n\n\t\tBX.bind(this.node, \"click\", this.click);\n\n\t\tthis.urls = this.getUrls();\n\t};\n\n\tnodeElementCrm.prototype = {\n\t\tgetUrls()\n\t\t{\n\t\t\tlet listUrl = BX.message('SITE_DIR')\n\t\t\t\t+ 'mobile/index.php?mobile_action=get_element_crm_list&'\n\t\t\t\t+ this.encodeQueryData(this.availableTypes);\n\n\t\t\treturn {\n\t\t\t\t\"list\":listUrl,\n\t\t\t\t\"profile\": BX.message(\"interface_form_user_url\")\n\t\t\t}\n\t\t},\n\t\tencodeQueryData(data)\n\t\t{\n\t\t\tconst ret = [];\n\t\t\tfor (let d in data)\n\t\t\t{\n\t\t\t\tret.push(encodeURIComponent(d) + '=' + encodeURIComponent(data[d]));\n\t\t\t}\n\t\t\treturn ret.join('&');\n\t\t},\n\t\tclick(e)\n\t\t{\n\t\t\tthis.show();\n\t\t\treturn BX.PreventDefault(e);\n\t\t},\n\t\tshow()\n\t\t{\n\t\t\t(new BXMobileApp.UI.Table({\n\t\t\t\turl: this.urls.list,\n\t\t\t\ttable_settings: {\n\t\t\t\t\tcallback: this.callback,\n\n\n\t\t\t\t\t//use_sections:true,\n\t\t\t\t\tmultiple: this.multiple,\n\t\t\t\t\tsearchField: true,\n\t\t\t\t\tselected: this.getSelectedItems(), //({company: ['CO_6']})\n\n\n\t\t\t\t\tshowtitle: true,\n\t\t\t\t\t//name: \"List\",\n\t\t\t\t\tmarkmode: true,\n\t\t\t\t\t// multiple: this.multiple,\n\t\t\t\t\t// return_full_mode: true,\n\t\t\t\t\tskipSpecialChars: true,\n\t\t\t\t\t//\tuse_sections:true,\n\t\t\t\t\tmodal: true,\n\t\t\t\t\talphabet_index: true,\n\t\t\t\t\t// outsection: false,\n\t\t\t\t\tokname: BX.message(\"interface_form_select\"),\n\t\t\t\t\tcancelname: BX.message(\"interface_form_cancel\"),\n\t\t\t\t\tcache: false\n\t\t\t\t}\n\t\t\t}, \"users\")).show();\n\t\t},\n\t\tcallback(data)\n\t\t{\n\t\t\tthis.container.length = 0;\n\t\t\tlet div = this.container.nextElementSibling;\n\t\t\twhile (div.firstChild)\n\t\t\t{\n\t\t\t\tdiv.removeChild(div.firstChild);\n\t\t\t}\n\n\t\t\tlet sections = [];\n\n\t\t\tfor (let key in data)\n\t\t\t{\n\t\t\t\tif (data.hasOwnProperty(key))\n\t\t\t\t{\n\n\t\t\t\t\tif (!(key in sections))\n\t\t\t\t\t{\n\t\t\t\t\t\tsections.push(key);\n\t\t\t\t\t\tlet span = document.createElement('span');\n\t\t\t\t\t\tspan.setAttribute('class', 'mobile-grid-data-span mobile-grid-crm-element-category-title');\n\t\t\t\t\t\tspan.innerHTML = Loc.getMessage('CRM_ENTITY_TYPE_' + key.toUpperCase());\n\t\t\t\t\t\tdiv.appendChild(span);\n\t\t\t\t\t}\n\n\t\t\t\t\tlet section = data[key];\n\t\t\t\t\tsection.forEach((item, i, arr) =>\n\t\t\t\t\t{\n\t\t\t\t\t\tlet option = new Option(item.NAME, item.ID, true, true);\n\t\t\t\t\t\tthis.container.add(option);\n\n\t\t\t\t\t\tlet link = document.createElement('a');\n\t\t\t\t\t\tlink.href = item.LINK;\n\t\t\t\t\t\tlink.text = item.NAME;\n\n\t\t\t\t\t\tlet span = document.createElement('span');\n\t\t\t\t\t\tspan.setAttribute('class', 'mobile-grid-data-span');\n\t\t\t\t\t\tspan.appendChild(link);\n\n\t\t\t\t\t\tdiv.appendChild(span);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.useOnChangeEvent)\n\t\t\t{\n\t\t\t\tBX.onCustomEvent(this,'BX.Mobile.Field:onChangeUserField', [this, this.node]);\n\t\t\t}\n\t\t},\n\t\tgetSelectedItems()\n\t\t{\n\t\t\tlet options = this.container.options;\n\t\t\tlet selectedItems = {};\n\n\t\t\tfor (let key in options)\n\t\t\t{\n\t\t\t\tif (options.hasOwnProperty(key))\n\t\t\t\t{\n\t\t\t\t\tif (selectedItems[options[key].getAttribute('data-category')] === undefined)\n\t\t\t\t\t{\n\t\t\t\t\t\tselectedItems[options[key].getAttribute('data-category')] = [];\n\t\t\t\t\t}\n\t\t\t\t\tselectedItems[options[key].getAttribute('data-category')].push(options[key].value);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn selectedItems;\n\t\t}\n\t};\n\treturn nodeElementCrm;\n})();\n\nwindow.app.exec('enableCaptureKeyboard', true);\n\nBX.Mobile.Field.ElementCrm = function (params)\n{\n\tthis.availableTypes = params['availableTypes'] || [];\n\tthis.useOnChangeEvent = params['useOnChangeEvent'] || false;\n\tthis.init(params);\n};\n\nBX.Mobile.Field.ElementCrm.prototype = {\n\t__proto__: BX.Mobile.Field.prototype,\n\tbindElement: function (node)\n\t{\n\t\tlet result = null;\n\t\tif (BX(node))\n\t\t{\n\t\t\tresult = new nodeElementCrm(\n\t\t\t\tnode,\n\t\t\t\tBX(`${node.id}_select`),\n\t\t\t\tthis.useOnChangeEvent,\n\t\t\t\tthis.availableTypes\n\t\t\t);\n\t\t}\n\t\treturn result;\n\t}\n};"],"names":["BX","window","BXMobileApp","nodeElementCrm","node","container","useOnChangeEvent","availableTypes","click","delegate","callback","multiple","hasAttribute","bind","urls","getUrls","prototype","listUrl","message","encodeQueryData","data","ret","d","push","encodeURIComponent","join","e","show","PreventDefault","UI","Table","url","list","table_settings","searchField","selected","getSelectedItems","showtitle","markmode","skipSpecialChars","modal","alphabet_index","okname","cancelname","cache","length","div","nextElementSibling","firstChild","removeChild","sections","key","hasOwnProperty","span","document","createElement","setAttribute","innerHTML","Loc","getMessage","toUpperCase","appendChild","section","forEach","item","i","arr","option","Option","NAME","ID","add","link","href","LINK","text","onCustomEvent","options","selectedItems","getAttribute","undefined","value","app","exec","Mobile","Field","ElementCrm","params","init","__proto__","bindElement","result","id"],"mappings":"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"}