var loadedTasks={};var newTaskParent=0;var newTaskDepth=0;var newTaskGroup=0;var newTaskGroupObj;var tasksMenuPopup={};var quickInfoData={};var preOrder={};var TaskListFilterPopup={popup:null,init:function(e){if(this.popup!=null)return;this.popup=new BX.PopupWindow("task-list-filter",e,{content:BX("task-list-filter"),offsetLeft:-263+e.offsetWidth-10,offsetTop:3,className:"task-filter-popup-window",zIndex:-120,closeByEsc:true,events:{onPopupClose:function(e){if(tasksTagsPopUp!=null){tasksTagsPopUp.popupWindow.close()}}}});BX.bind(BX("task-list-filter"),"click",BX.delegate(this.onFilterSwitch,this))},show:function(e){if(!this.popup)this.init(e);if(BX.hasClass(e,"task-title-button-filter-pressed")){this.popup.close();BX.removeClass(e,"task-title-button-filter-pressed");this.adjustListHeight()}else{this.popup.show();BX.addClass(e,"task-title-button-filter-pressed");this.adjustListHeight();BX.bind(BX("task-list-filter"),"click",BX.proxy(this.onFilterClick,this));window.setTimeout(function(e,t){return function(){t.bindElement=e;BX.bind(document,"click",BX.proxy(t.onDocumentClick,t))}}(e,this),100)}},onFilterClick:function(e){if(!e)e=event;if(e.stopPropagation)e.stopPropagation();else e.cancelBubble=true},onDocumentClick:function(){this.popup.close();BX.removeClass(this.bindElement,"task-title-button-filter-pressed");BX.removeClass(this.bindElement,"webform-small-button-active");this.adjustListHeight();BX.unbind(document,"click",BX.proxy(this.onDocumentClick,this));BX.unbind(BX("task-list-filter"),"click",BX.proxy(this.onFilterClick,this))},adjustListHeight:function(){var e=BX("task-list-container",true);if(!e)return;var t=e.offsetHeight-(parseInt(e.style.paddingBottom)||0);var s=this.popup?this.popup.popupContainer.offsetHeight:0;if(s>t)BX("task-list-container",true).style.paddingBottom=s-t+"px";else BX("task-list-container",true).style.paddingBottom="0px"},onFilterSwitch:function(e){e=e||window.event;var t=e.target||e.srcElement;if(BX.hasClass(t,"task-filter-mode-selected"))this.adjustListHeight()}};var tasksListTemplateDefaultInit=function(){if(BX("task-title-button-search-input",true)){BX.bind(BX("task-title-button-search-input",true),"click",function(e){if(!e)e=window.event;BX.addClass(this.parentNode.parentNode.parentNode,"task-title-button-search-full")});BX.bind(BX("task-title-button-search-input",true),"blur",function(e){if(!e)e=window.event;if(this.value==""){BX.removeClass(this.parentNode.parentNode.parentNode,"task-title-button-search-full")}});BX.bind(BX("task-title-button-search-input",true),"keyup",function(e){if(!e)e=window.event;if(e.keyCode==13){BX.submit(document.forms["task-filter-title-form"])}});BX.bind(BX("task-title-button-search-icon"),"click",function(e){if(!e)e=window.event;BX.submit(document.forms["task-filter-title-form"])})}};function showAjaxErrorPopup(){var e=new BX.PopupWindow("gantt-ajax-error-popup",null,{lightShadow:true,overlay:true,buttons:[new BX.PopupWindowButton({text:BX.message("JS_CORE_WINDOW_CLOSE"),className:"",events:{click:function(){BX.reload();this.popupWindow.close()}}})]});var t=[];for(var s=0;s<arguments.length;s++){var a=arguments[s];if(BX.type.isArray(a)){t=BX.util.array_merge(t,a)}else if(BX.type.isString(a)){t.push(a)}}var i="";for(s=0;s<t.length;s++){i+=(typeof t[s].MESSAGE!=="undefined"?t[s].MESSAGE:t[s])+"<br>"}e.setContent("<div class='task-new-item-error-popup'>"+i+"</div>");e.show()}function isLeftClick(e){if(!e.which&&e.button!==undefined){if(e.button&1)e.which=1;else if(e.button&4)e.which=2;else if(e.button&2)e.which=3;else e.which=0}return e.which==1||e.which==0&&BX.browser.IsIE()}function ShowPopupTask(e,t){if(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i))return false;if(!t)t=window.event;if(isLeftClick(t)){if(typeof tasksIFrameList=="undefined")tasksIFrameList=[];taskIFramePopup.view(e,tasksIFrameList);BX.PreventDefault(t)}}function AddQuickPopupTask(e,t){t=t||{};if(!e)e=window.event;if(!isLeftClick(e))return;BX.PreventDefault(e);if(typeof taskIFramePopup!="undefined"){taskIFramePopup.edit(0,t)}}function AddPopupTask(e,t){t=t||0;if(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i))return false;if(!e)e=window.event;if(isLeftClick(e)){var s=null;if(t>0)s={GROUP_ID:t};taskIFramePopup.add(s);BX.PreventDefault(e)}}function EditPopupTask(e,t){if(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i))return false;if(!t)t=window.event;if(isLeftClick(t)){taskIFramePopup.edit(e);BX.PreventDefault(t)}}function AddPopupSubtask(e,t){if(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i))return false;if(!t)t=window.event;if(isLeftClick(t)){taskIFramePopup.add({PARENT_ID:e});BX.PreventDefault(t)}}function CopyPopupTask(e,t){debugger;if(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i))return false;if(!t)t=window.event;if(isLeftClick(t)){taskIFramePopup.add({COPY:e});BX.PreventDefault(t)}}function AddPopupTemplateTask(e,t){if(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i))return false;if(!t)t=window.event;taskIFramePopup.add({TEMPLATE:e});BX.PreventDefault(t)}function AddPopupTemplateSubtask(e,t,s){if(!s)s=window.event;taskIFramePopup.add({TEMPLATE:e,PARENT_ID:t});BX.PreventDefault(s)}function AddPopupGroupTask(e,t){if(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i))return false;if(!t)t=window.event;taskIFramePopup.add({GROUP_ID:e});BX.PreventDefault(t)}function SetCSSStatus(e,t,s){BX.removeClass(e,s+"overdue");BX.removeClass(e,s+"new");BX.removeClass(e,s+"accepted");BX.removeClass(e,s+"in-progress");BX.removeClass(e,s+"delayed");BX.removeClass(e,s+"waiting");BX.removeClass(e,s+"completed");var a=e.getElementsByTagName("TD");var i=BX.findChild(a[0],{tagName:"a"},true);BX.style(i,"text-decoration","none");BX.addClass(e,s+t)}function SetServerStatus(e,t,s){var a=null;var i={mode:t,sessid:BX.message("bitrix_sessid"),path_to_task:BX.message("TASKS_PATH_TO_TASK"),id:e};if(typeof tasksListNS!=="undefined"&&tasksListNS.getColumnsOrder){a=tasksListNS.getColumnsOrder();i["columnsOrder"]=a}if(s){for(var n in s){i[n]=s[n]}}BX.ajax({method:"POST",dataType:"json",url:tasksListAjaxUrl+"&_CODE="+t+"&viewType=VIEW_MODE_GANTT",data:i,processData:true,onsuccess:function(e){return function(t){if(t.status!="success")return;var s=BX.parseJSON(t.tasksRenderJSON);quickInfoData[e].menuItems=s.menuItems;quickInfoData[e].realStatus=s.realStatus;tasksMenuPopup[e]=s.menuItems;if(typeof ganttChart!="undefined"){ganttChart.getTaskById(e).setMenuItems(__FilterMenuByStatus(quickInfoData[e]));var a=ganttChart.getTaskById(e);if(a){ganttChart.updateTask(a.id,s)}}if(BX.TasksTimerManager)BX.TasksTimerManager.reLoadInitTimerDataFromServer();if(window.BX.TasksIFrameInst)window.BX.TasksIFrameInst.onTaskChanged(s,null,null,null,s.html)}}(e)});__InvalidateMenus([e,"c"+e])}function ShowMenuPopup(e,t){if(tasksMenuPopup[e])BX.PopupMenu.show(e,t,__FilterMenuByStatus(quickInfoData[e]),{events:{onPopupClose:__onMenuPopupClose}});BX.addClass(t,"task-menu-button-selected");return false}function __onMenuPopupClose(){BX.removeClass(this.bindElement,"task-menu-button-selected")}function ShowMenuPopupContext(e,t){var s=t.target||t.srcElement;if(s&&s.tagName.toUpperCase()=="A")return true;if(tasksMenuPopup[e]){BX.PopupMenu.show("c"+e,t,__FilterMenuByStatus(quickInfoData[e]),{});BX.PopupMenu.getCurrentMenu().popupWindow.setBindElement(t);BX.PopupMenu.getCurrentMenu().popupWindow.adjustPosition()}BX.PreventDefault(t)}function __InvalidateMenus(e){for(var t=0,s=e.length;t<s;t++){BX.PopupMenu.destroy(e[t])}}function __FilterMenuByStatus(e){var t=[];for(var s=0,a=e.menuItems.length;s<a;s++){if(typeof e.menuItems[s].status=="undefined"||BX.util.in_array(e.realStatus,e.menuItems[s].status)){t.push(e.menuItems[s])}}return t}var titleBuffer="";function ShowTaskQuickInfo(e,t){if(quickInfoData[e]){titleBuffer=BX("task-"+e).title;BX("task-"+e).title="";BX.fixEventPageXY(t);var s={left:t.pageX,top:t.pageY,bottom:t.pageY};BX.TaskQuickInfo.show(s,quickInfoData[e],{offsetTop:10,dateFormat:"DD.MM.YYYY",onDetailClick:TaskQuickInfoDetail,userProfileUrl:"/company/personal/user/#user_id#/"})}}function HideTaskQuickInfo(e,t){BX("task-"+e).title=titleBuffer;BX.TaskQuickInfo.hide()}function TaskQuickInfoDetail(e,t,s){t.close()}function ShowTemplatesPopup(e){var t=BX("task-popup-templates-popup-content",true);BX.PopupWindowManager.create("task-templates-popup",e,{autoHide:true,offsetTop:1,events:{onPopupClose:__onTemplatesPopupClose},content:t}).show();BX.addClass(e,"webform-button-active");return false}function __onTemplatesPopupClose(){BX.removeClass(this.bindElement,"webform-button-active")}function SwitchTaskFilter(e){if(BX.hasClass(e,"task-filter-mode-selected"))return false;BX.toggleClass(e.parentNode.parentNode.parentNode,"task-filter-advanced-mode");var t=e.parentNode.getElementsByTagName("a");for(var s=0;s<t.length;s++)BX.toggleClass(t[s],"task-filter-mode-selected");return false}function Add2Timeman(e,t){var s=false;var a=BX.findChild(e.popupWindow.contentContainer,{tagName:"a",className:"menu-popup-item-add-to-tm"},true);BX.remove(BX.findPreviousSibling(a));BX.remove(a);e.popupWindow.close();if(BX.addTaskToPlanner)BX.addTaskToPlanner(t);else if(window.top.BX.addTaskToPlanner)window.top.BX.addTaskToPlanner(t)}function ShowQuickTask(e,t){if(t){if(t.parent){var s=BX("task-"+t.parent);if(s)e=BX.findParent(s,{tag:"table"})}else if(t.group){var a=BX("task-project-"+t.group.id);if(a)e=BX.findParent(a,{tag:"table"})}}if(!e)e=BX.findParent(BX("task-new-item-row",true),{tag:"table"});if(BX("task-detail-subtasks-block")&&BX("task-detail-subtasks-block").style.display=="none")BX("task-detail-subtasks-block").style.display="";var i=e.tBodies[0];if(!t){t={}}if(typeof newTaskGroup==="undefined"){newTaskDepth=newTaskParent=newTaskGroup=0;newTaskGroupObj=null}var n=i.rows[0];if(t.group||t.parent){if(t.group){var o=function(e,t,s){if(typeof window["groupsPopup"]==="undefined"){if(t>0){window.setTimeout(function(){o(e,t-e,s)},e)}}else{groupsPopup.select(s)}};o(100,15e3,t.group);if(t.group.id>0){newTaskGroup=t.group.id;if(BX("task-project-"+newTaskGroup)){n=BX.findNextSibling(BX("task-project-"+newTaskGroup),{tag:"tr"})}}}if(t.parent){newTaskParent=parseInt(t.parent)>0?parseInt(t.parent):0;if(BX("task-"+newTaskParent,true)){newTaskDepth=Depth(BX("task-"+newTaskParent,true))+1;n=BX.findNextSibling(BX("task-"+newTaskParent,true),{tag:"tr"})}}}if(!t.parent){newTaskDepth=0;newTaskParent=0}if(n!=BX("task-new-item-row",true)){if(n){i.insertBefore(BX("task-new-item-row",true),n)}else{i.appendChild(BX("task-new-item-row",true))}}BX.removeClass(BX("task-new-item-row",true),"task-list-item-hidden");BX("task-new-item-name").focus();var r=0;if(t.group&&t.group.id)r=t.group.id;var u=BX.message("USER_ID");if(t.user&&t.user.id)u=t.user.id;if(BX("task-new-item-responsible")){if(!window.groupsPopup){BX("task-new-item-responsible").disabled=true;BX("task-new-item-link-group").style.display="none";BX.Tasks.lwPopup.__initSelectors([{requestedObject:"intranet.user.selector.new",selectedUsersIds:u,anchorId:"task-new-item-responsible",bindClickTo:"task-new-item-responsible",userInputId:"task-new-item-responsible",multiple:"N",GROUP_ID_FOR_SITE:r,callbackOnSelect:function(e){BX("task-new-item-responsible-hidden").value=e.id},onLoadedViaAjax:function(){BX("task-new-item-responsible").disabled=false}},{requestedObject:"socialnetwork.group.selector",bindElement:"task-new-item-link-group",callbackOnSelect:function(e,t){onGroupSelect(e)},onLoadedViaAjax:function(e){var t=function(s,a){if(typeof window[e]==="undefined"){if(a>0)window.setTimeout(function(){t(s,a-s)},s)}else{window.groupsPopup=window[e];BX("task-new-item-link-group").style.display=""}};t(100,15e3)}}])}}}function ToggleSubtasks(e,t,s){if(!tasksListNS||!tasksListNS.isReady){window.setTimeout(function(e,t,s){return function(){ToggleSubtasks(e,t,s)}}(e,t,s),500);return}if(loadedTasks[s]){var a=BX.findNextSibling(e,{tagName:"tr"});while(a&&Depth(a)>t){if(BX.hasClass(e,"task-list-item-opened")){BX.addClass(a,"task-list-item-hidden");BX.removeClass(a,"task-list-item-opened")}else if(BX.hasClass(a,"task-depth-"+(t+1))){BX.removeClass(a,"task-list-item-hidden")}a=BX.findNextSibling(a,{tagName:"tr"})}BX.toggleClass(e,"task-list-item-opened")}else{var i={sessid:BX.message("bitrix_sessid"),id:s,depth:t,filter:tasksListNS.arFilter,order:arOrder,columnsOrder:tasksListNS.getColumnsOrder(),path_to_user:BX.message("TASKS_PATH_TO_USER_PROFILE"),path_to_task:BX.message("TASKS_PATH_TO_TASK"),mode:"load"};loadedTasks[s]=true;BX.ajax({method:"POST",dataType:"html",url:tasksListAjaxUrl,data:i,processData:false,onsuccess:function(){var a=function(a){var i=document.createElement("div");i.innerHTML="<table>"+a+"</table>";var n=i.firstChild.getElementsByTagName("TR");var o=i.firstChild.getElementsByTagName("SCRIPT");for(var r=n.length-1;r>=0;r--){if(!BX(n[r].id)){e.parentNode.insertBefore(n[r],e.nextSibling);if(!BX.browser.IsIE()||!!document.documentMode&&document.documentMode>=10){var u=BX.create("script",{props:{type:"text/javascript"},html:o[r].innerHTML})}else{var u=o[r]}e.parentNode.insertBefore(u,e.nextSibling)}}ToggleSubtasks(e,t,s)};return a}()})}}function Depth(e){var t=/task-depth-([0-9]+)/;var s=t.exec(e.className);if(s){return parseInt(s[1])}else{return 0}}function ShowGradePopup(e,t,s){BX.TaskGradePopup.show(e,t,s,{events:{onPopupClose:__onGradePopupClose,onPopupChange:__onGradePopupChange}});BX.addClass(t,"task-grade-and-report-selected");return false}function __onGradePopupClose(){BX.removeClass(this.bindElement,"task-grade-and-report-selected")}function __onGradePopupChange(){this.bindElement.className="task-grade-and-report"+(this.listValue!="NULL"?" task-grade-"+this.listItem.className:"")+(this.report?" task-in-report":"");this.bindElement.title=BX.message("TASKS_MARK")+": "+this.listItem.name;var e={mode:"mark",sessid:BX.message("bitrix_sessid"),id:this.id,mark:this.listValue,report:this.report};BX.ajax.post(tasksListAjaxUrl,e)}function ShowPriorityPopup(e,t,s){BX.TaskPriorityPopup.show(e,t,s,{events:{onPopupClose:__onPriorityPopupClose,onPopupChange:__onPriorityChange}});BX.addClass(t,"task-priority-box-selected");return false}function __onPriorityPopupClose(){BX.removeClass(this.bindElement,"task-priority-box-selected")}function __onPriorityChange(){BX.removeClass(this.bindElement,"task-priority-box-selected");this.bindElement.title=BX.message("TASKS_PRIORITY_V2")+": "+this.listItem.name;this.bindElement.childNodes[0].className="task-priority-icon task-priority-"+this.listValue;var e={mode:"priority",sessid:BX.message("bitrix_sessid"),id:this.id,path_to_user:BX.message("TASKS_PATH_TO_USER_PROFILE"),path_to_task:BX.message("TASKS_PATH_TO_TASK"),priority:this.listValue};BX.ajax.post(tasksListAjaxUrl,e)}function tasksFormatDate(e){return BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME")),e)}function onDetails(e){ShowPopupTask(this.id,e.event)}