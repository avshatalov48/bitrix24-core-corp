{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { Dom, Event, GetWindowInnerSize, GetWindowScrollPos, Reflection } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\n\nconst namespace = Reflection.namespace('BX.BizprocMobile');\nexport default class Comments\n{\n\tstatic get block(): Object\n\t{\n\t\treturn {\n\t\t\tcomments: 'comments',\n\t\t\tstub: 'stub',\n\t\t};\n\t}\n\n\tconstructor(options): void\n\t{\n\t\tthis.userId = options.userId;\n\t\tthis.workflowId = options.workflowId;\n\t\tthis.workflowIdInt = options.workflowIdInt;\n\t\tthis.guid = options.guid;\n\n\t\tthis.canReadCommentsOnInit = true;\n\n\t\tthis.timeout = 0;\n\t\tthis.timeoutSec = 2000;\n\t\tthis.commentsList = null;\n\t\tthis.unreadComments = new Map();\n\t\tthis.commentsToRead = new Map();\n\n\t\tthis.initTextField();\n\t\tthis.initCommentsBlock();\n\n\t\tthis.sendEvents(options);\n\t\tthis.bindEvents();\n\t}\n\n\tinitTextField(): void\n\t{\n\t\tif (BX.MobileUI.TextField.defaultParams)\n\t\t{\n\t\t\twindow.BX.MobileUI.TextField.show();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tEventEmitter.subscribe(\n\t\t\t\tBX.MobileUI.events.MOBILE_UI_TEXT_FIELD_SET_PARAMS,\n\t\t\t\t() => window.BX.MobileUI.TextField.show(),\n\t\t\t);\n\t\t}\n\t}\n\n\tinitCommentsBlock(): void\n\t{\n\t\tthis.stub = BX('commentsStub');\n\t\tthis.commentsBlock = BX('workflow-comments-block');\n\n\t\tconst firstComment = BX('post-comments-wrap').querySelector('.post-comment-block');\n\t\tthis.resolveVisibility(firstComment ? Comments.block.comments : Comments.block.stub);\n\t}\n\n\tresolveVisibility(visibleBlock = Comments.block.stub): void\n\t{\n\t\tconst hiddenClass = '--hidden';\n\n\t\tif (visibleBlock === Comments.block.stub)\n\t\t{\n\t\t\tif (Dom.hasClass(this.stub, hiddenClass))\n\t\t\t{\n\t\t\t\tDom.removeClass(this.stub, hiddenClass);\n\t\t\t}\n\n\t\t\tif (!Dom.hasClass(this.commentsBlock, hiddenClass))\n\t\t\t{\n\t\t\t\tDom.addClass(this.commentsBlock, hiddenClass);\n\t\t\t}\n\t\t}\n\t\telse if (visibleBlock === Comments.block.comments)\n\t\t{\n\t\t\tif (Dom.hasClass(this.commentsBlock, hiddenClass))\n\t\t\t{\n\t\t\t\tDom.removeClass(this.commentsBlock, hiddenClass);\n\t\t\t}\n\n\t\t\tif (!Dom.hasClass(this.stub, hiddenClass))\n\t\t\t{\n\t\t\t\tDom.addClass(this.stub, hiddenClass);\n\t\t\t}\n\t\t}\n\t}\n\n\tsendEvents(options): void\n\t{\n\t\tif (options.logId)\n\t\t{\n\t\t\tconst params = {\n\t\t\t\tlog_id: options.logId,\n\t\t\t\tts: options.currentTs,\n\t\t\t\tbPull: false,\n\t\t\t};\n\t\t\tBXMobileApp.onCustomEvent('onLogEntryRead', params, true);\n\t\t}\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('OnUCHasBeenInitialized', (event) => {\n\t\t\tconst [xmlId, list] = event.getData();\n\t\t\tif (xmlId === `WF_${this.workflowId}`)\n\t\t\t{\n\t\t\t\tthis.commentsList = list;\n\t\t\t\tthis.commentsList.canCheckVisibleComments = true;\n\t\t\t\tthis.unreadComments = new Map(this.commentsList.unreadComments);\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('onUCFormSubmit', () => this.resolveVisibility(Comments.block.comments));\n\n\t\tEventEmitter.subscribe('OnUCCommentWasPulled', (event) => {\n\t\t\tconst [id, data] = event.getData();\n\t\t\tif (id[0] === `WF_${this.workflowId}`)\n\t\t\t{\n\t\t\t\tconst author = data.messageFields.AUTHOR;\n\t\t\t\tif (Number(author.ID) !== Number(this.userId))\n\t\t\t\t{\n\t\t\t\t\tthis.unreadComments.set(id[1], new Date());\n\t\t\t\t}\n\t\t\t\tthis.resolveVisibility(Comments.block.comments);\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('OnUCommentWasDeleted', (event) => {\n\t\t\tconst [xmlId, id] = event.getData();\n\t\t\tconst commentId = id[1];\n\t\t\tif (xmlId === `WF_${this.workflowId}`)\n\t\t\t{\n\t\t\t\tif (this.commentsList.getCommentsCount() <= 0)\n\t\t\t\t{\n\t\t\t\t\tthis.resolveVisibility(Comments.block.stub);\n\t\t\t\t}\n\t\t\t\tthis.unreadComments.delete(commentId);\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('OnUCCommentWasRead', (event) => {\n\t\t\tconst [xmlId, id] = event.getData();\n\t\t\tconst commentId = id[1];\n\t\t\tif (xmlId === `WF_${this.workflowId}` && this.unreadComments.has(commentId))\n\t\t\t{\n\t\t\t\tthis.commentsToRead.set(commentId, this.unreadComments.get(commentId));\n\t\t\t\tthis.unreadComments.delete(commentId);\n\n\t\t\t\tthis.sendOnCommentsReadEvent(this.unreadComments.size);\n\n\t\t\t\tif (this.timeout <= 0)\n\t\t\t\t{\n\t\t\t\t\tthis.timeout = setTimeout(() => this.readComments(), this.timeoutSec);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// BXMobileApp.addCustomEvent('onPull-tasks', () => {});\n\n\t\tEvent.bind(document, 'visibilitychange', () => this.setCanCheckVisibleComments(!document.hidden));\n\t\tEvent.bind(window, 'pagehide', () => this.setCanCheckVisibleComments(false));\n\t\tEvent.bind(window, 'pageshow', () => this.setCanCheckVisibleComments(true));\n\n\t\tBX.MobileUI.addLivefeedLongTapHandler(this.commentsBlock, { likeNodeClass: 'post-comment-control-item-like' });\n\t}\n\n\tsetCanCheckVisibleComments(canCheck: boolean): void\n\t{\n\t\tif (canCheck && this.canReadCommentsOnInit)\n\t\t{\n\t\t\tthis.canReadCommentsOnInit = false;\n\t\t\tthis.readComments();\n\t\t}\n\n\t\tif (!this.commentsList)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.commentsList.canCheckVisibleComments = canCheck;\n\n\t\tif (canCheck)\n\t\t{\n\t\t\tconst scroll = GetWindowScrollPos();\n\t\t\tconst position = {\n\t\t\t\ttop: scroll.scrollTop,\n\t\t\t\tbottom: scroll.scrollTop + GetWindowInnerSize().innerHeight,\n\t\t\t};\n\t\t\tthis.commentsList.checkVisibleComments(position);\n\n\t\t\tif (this.canReadCommentsOnInit)\n\t\t\t{\n\t\t\t\tthis.canReadCommentsOnInit = false;\n\t\t\t\tthis.readComments();\n\t\t\t}\n\t\t}\n\t}\n\n\tsendOnCommentsReadEvent(newCommentsCount: number = 0): void\n\t{\n\t\t// const params = {\n\t\t// \tnewCommentsCount,\n\t\t// \tworkflowId: this.workflowId,\n\t\t// };\n\t\t// BXMobileApp.Events.postToComponent('tasks.task.comments:onCommentsRead', params);\n\t\t// BXMobileApp.Events.postToComponent('task.view.onCommentsRead', params, 'tasks.list');\n\t}\n\n\treadComments(): void\n\t{\n\t\tthis.timeout = 0;\n\t\tthis.commentsToRead.clear();\n\n\t\tvoid BX.ajax.runAction('bizproc.workflow.comment.markAsRead', {\n\t\t\tdata: {\n\t\t\t\tworkflowId: this.workflowId,\n\t\t\t\tuserId: this.userId,\n\t\t\t},\n\t\t});\n\t}\n}\n\nnamespace.Comments = Comments;\n"],"names":["namespace","Reflection","Comments","comments","stub","options","userId","workflowId","workflowIdInt","guid","canReadCommentsOnInit","timeout","timeoutSec","commentsList","unreadComments","Map","commentsToRead","initTextField","initCommentsBlock","sendEvents","bindEvents","BX","MobileUI","TextField","defaultParams","window","show","EventEmitter","subscribe","events","MOBILE_UI_TEXT_FIELD_SET_PARAMS","commentsBlock","firstComment","querySelector","resolveVisibility","block","visibleBlock","hiddenClass","Dom","hasClass","removeClass","addClass","logId","params","log_id","ts","currentTs","bPull","BXMobileApp","onCustomEvent","event","getData","xmlId","list","canCheckVisibleComments","id","data","author","messageFields","AUTHOR","Number","ID","set","Date","commentId","getCommentsCount","has","get","sendOnCommentsReadEvent","size","setTimeout","readComments","Event","bind","document","setCanCheckVisibleComments","hidden","addLivefeedLongTapHandler","likeNodeClass","canCheck","scroll","GetWindowScrollPos","position","top","scrollTop","bottom","GetWindowInnerSize","innerHeight","checkVisibleComments","clear","ajax","runAction"],"mappings":"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"}