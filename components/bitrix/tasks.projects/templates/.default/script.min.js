this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(t,e,s,n,r,i,a){"use strict";var o=function t(){babelHelpers.classCallCheck(this,t)};babelHelpers.defineProperty(o,"SHOW_BY_HOVER","main-grid-cell-content-action-by-hover");babelHelpers.defineProperty(o,"ACTIVE","main-grid-cell-content-action-active");var u=a.Reflection.namespace("BX.Grid");u.CellActionState=o;var c=function(){function t(){babelHelpers.classCallCheck(this,t)}babelHelpers.createClass(t,null,[{key:"setOptions",value:function e(s){t.options=s}},{key:"setActionsPanel",value:function e(s){t.actionsPanel=s}},{key:"doAction",value:function e(s,n){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];return new Promise((function(e,i){BX.ajax.runComponentAction("bitrix:tasks.projects","processAction",{mode:"class",data:{action:s,data:r,ids:t.getActionIds(n)||[]},signedParameters:t.options.signedParameters}).then((function(){return e()}),(function(){return i()}))["catch"]((function(){return i()}));t.hideActionsPanel();t.unselectRows()}))}},{key:"getActionIds",value:function e(s){if(s!==undefined){return[s]}var n=t.getSelectedRows();if(n.length===0){return[]}return n.map((function(t){return t.getDataset().id}))}},{key:"getSelectedRows",value:function e(){return t.getGridInstance().getRows().getSelected()}},{key:"sendJoinRequest",value:function e(s){if(a.Dom.hasClass(s,"ui-btn-clock")){return}a.Dom.addClass(s,"ui-btn-clock");BX.ajax({url:s.getAttribute("bx-request-url"),method:"POST",dataType:"json",data:{ajax_request:"Y",save:"Y",sessid:BX.bitrix_sessid()},onsuccess:function t(){return a.Dom.removeClass(s,"ui-btn-clock")},onfailure:function t(){return a.Dom.removeClass(s,"ui-btn-clock")}});t.hideActionsPanel();t.unselectRows()}},{key:"sendAcceptRequest",value:function e(s,n){BX.ajax({url:n,method:"POST",dataType:"json",data:{action:"accept",max_count:1,checked_0:"Y",type_0:"INVITE_GROUP",id_0:s,type:"in",ajax_request:"Y",sessid:BX.bitrix_sessid()},onsuccess:function t(e){},onfailure:function t(e){return console.log(e)}});t.hideActionsPanel();t.unselectRows()}},{key:"sendDenyRequest",value:function e(s,n){t.sendCancelRequest(s,n)}},{key:"sendCancelRequest",value:function e(s,n){BX.ajax({url:n,method:"POST",dataType:"json",data:{action:"reject",max_count:1,checked_0:"Y",type_0:"INVITE_GROUP",id_0:s,type:"out",ajax_request:"Y",sessid:BX.bitrix_sessid()},onsuccess:function t(e){},onfailure:function t(e){return console.log(e)}});t.hideActionsPanel();t.unselectRows()}},{key:"hideActionsPanel",value:function e(){t.options.actionsPanel.hidePanel()}},{key:"unselectRows",value:function e(){t.getGridInstance().getRows().unselectAll()}},{key:"getGridInstance",value:function e(){return BX.Main.gridManager.getById(t.options.gridId).instance}},{key:"changePin",value:function e(s,n){var r=n.getData(),i=r.button;if(a.Dom.hasClass(i,o.ACTIVE)){t.doAction("unpin",s).then((function(){a.Dom.removeClass(i,o.ACTIVE);a.Dom.addClass(i,o.SHOW_BY_HOVER)}))}else{t.doAction("pin",s).then((function(){a.Dom.addClass(i,o.ACTIVE);a.Dom.removeClass(i,o.SHOW_BY_HOVER)}))}}},{key:"onTagClick",value:function e(s){var n=t.options.filter;n.toggleByField(s)}},{key:"onTagAddClick",value:function e(s,n){a.Runtime.loadExtension("ui.entity-selector").then((function(e){var i=function e(n){var r=n.getData(),i=r.id;if(i===s){var a=t.getGridInstance().getRows().getById(i);var o=a.getCellById("TAGS").querySelector(".main-grid-tag-add");l.setTargetNode(o)}};var o=function t(e){var n=e.getData(),r=n.id;if(r===s){l.hide()}};var u=function e(n){var r=n.getTarget();var i=r.getSelectedItems().map((function(t){return t.getId()}));void t.doAction("update",s,{KEYWORDS:i.join(",")})};var c=e.Dialog;var l=new c({targetNode:n.getData().button,enableSearch:true,width:350,height:400,multiple:true,dropdownMode:true,compactView:true,context:"PROJECT_TAG",entities:[{id:"project-tag",options:{groupId:s}}],searchOptions:{allowCreateItem:true,footerOptions:{label:a.Loc.getMessage("TASKS_PROJECTS_ENTITY_SELECTOR_TAG_SEARCH_FOOTER_ADD")}},footer:BX.SocialNetwork.EntitySelector.Footer,footerOptions:{tagCreationLabel:true},events:{onShow:function t(){r.EventEmitter.subscribe("Tasks.Projects.Grid:RowUpdate",i);r.EventEmitter.subscribe("Tasks.Projects.Grid:RowRemove",o)},onHide:function t(){r.EventEmitter.unsubscribe("Tasks.Projects.Grid:RowUpdate",i);r.EventEmitter.unsubscribe("Tasks.Projects.Grid:RowRemove",o)},"Search:onItemCreateAsync":function t(e){return new Promise((function(t){var s=e.getData(),n=s.searchQuery;var r=n.getQuery().toLowerCase();var i=e.getTarget();setTimeout((function(){var e=i.addItem({id:r,entityId:"project-tag",title:r,tabs:"all"});if(e){e.select()}t()}),1e3)}))},"Item:onSelect":u,"Item:onDeselect":u}});l.show()}))}}]);return t}();var l=function(){function t(e){babelHelpers.classCallCheck(this,t);this.filter=BX.Main.filterManager.getById(e.filterId);this.init();this.bindEvents()}babelHelpers.createClass(t,[{key:"init",value:function t(){this.updateFields()}},{key:"bindEvents",value:function t(){r.EventEmitter.subscribe("BX.Main.Filter:apply",this.onFilterApply.bind(this));r.EventEmitter.subscribe("Tasks.Toolbar:onItem",this.onCounterClick.bind(this))}},{key:"onFilterApply",value:function t(){this.updateFields()}},{key:"updateFields",value:function t(){this.fields=this.filter.getFilterFieldsValues()}},{key:"onCounterClick",value:function t(e){var s=e.getData();if(s.counter&&s.counter.filter){this.toggleByField(babelHelpers.defineProperty({},s.counter.filterField,s.counter.filterValue))}}},{key:"isFilteredByField",value:function t(e){if(!Object.keys(this.fields).includes(e)){return false}if(a.Type.isArray(this.fields[e])){return this.fields[e].length>0}return this.fields[e]!==""}},{key:"isFilteredByFieldValue",value:function t(e,s){return this.isFilteredByField(e)&&this.fields[e]===s}},{key:"toggleByField",value:function t(e){var s=this;var n=Object.keys(e)[0];var r=e[n];if(!this.isFilteredByFieldValue(n,r)){this.filter.getApi().extendFilter(babelHelpers.defineProperty({},n,r));return}this.filter.getFilterFields().forEach((function(t){if(t.getAttribute("data-name")===n){s.filter.getFields().deleteField(t)}}));this.filter.getSearch().apply()}}]);return t}();var p,d,h,m,g,f,v,b,P,k;var y=function(){function t(e){babelHelpers.classCallCheck(this,t);this.signedParameters=e.signedParameters}babelHelpers.createClass(t,[{key:"show",value:function t(e,s){var r=this;var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"all";if(this.isPopupShown){this.popup.destroy()}this.groupId=e;this.resetPopupData();this.changeType(i,false);this.popup=n.PopupWindowManager.create({id:"projects-members-popup-menu",className:"tasks-projects-members-popup",bindElement:s,autoHide:true,closeByEsc:true,lightShadow:true,bindOptions:{position:"bottom"},animationOptions:{show:{type:"opacity-transform"},close:{type:"opacity"}},events:{onPopupDestroy:function t(){r.loader=null;r.isPopupShown=false},onPopupClose:function t(){r.popup.destroy()},onAfterPopupShow:function t(s){s.contentContainer.appendChild(r.renderContainer());r.showLoader();r.showUsers(e,i);r.isPopupShown=true}}});this.popupScroll(e,i);this.popup.show()}},{key:"renderContainer",value:function t(){return a.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<span class="tasks-projects-members-popup-container">\n\t\t\t\t<span class="tasks-projects-members-popup-head">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t\t",'\n\t\t\t\t</span>\n\t\t\t\t<span class="tasks-projects-members-popup-body">\n\t\t\t\t\t<div class="tasks-projects-members-popup-content">\n\t\t\t\t\t\t<div class="tasks-projects-members-popup-content-box">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</span>\n\t\t\t</span>\n\t\t"])),this.popupData.all.tab,this.popupData.heads.tab,this.popupData.members.tab,this.getCurrentPopupData().innerContainer)}},{key:"popupScroll",value:function t(e,s){var n=this;if(!BX.type.isDomNode(this.getCurrentPopupData().innerContainer)){return}a.Event.bind(this.getCurrentPopupData().innerContainer,"scroll",(function(t){var r=t.target;if(r.scrollTop>(r.scrollHeight-r.offsetHeight)/1.5){n.showUsers(e,s);a.Event.unbindAll(n.getCurrentPopupData().innerContainer)}}))}},{key:"showUsers",value:function t(e,s){var n=this;BX.ajax.runComponentAction("bitrix:tasks.projects","getPopupMembers",{mode:"class",data:{groupId:e,type:s,page:this.getCurrentPopupData().currentPage},signedParameters:this.signedParameters}).then((function(t){if(n.groupId!==e||n.currentType!==s){n.hideLoader();return}if(t.data.length>0){n.renderUsers(t.data);n.popupScroll(e,n.currentType)}else if(!n.getCurrentPopupData().innerContainer.hasChildNodes()){n.getCurrentPopupData().innerContainer.innerText=a.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_EMPTY")}n.getCurrentPopupData().currentPage++;n.hideLoader()}),(function(){return n.hideLoader()}))}},{key:"renderUsers",value:function t(e){var s=this;Object.values(e).forEach((function(t){if(s.getCurrentPopupData().renderedUsers.indexOf(t.ID)>=0){return}s.getCurrentPopupData().renderedUsers.push(t.ID);s.getCurrentPopupData().innerContainer.appendChild(a.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<a class="tasks-projects-members-popup-item" href="','" target="_blank">\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-avatar-new">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t<span class="tasks-projects-members-popup-avatar-status-icon"></span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-name">',"</span>\n\t\t\t\t\t</a>\n\t\t\t\t"])),t["HREF"],s.getAvatar(t),t["FORMATTED_NAME"]))}))}},{key:"getAvatar",value:function t(e){if(a.Type.isStringFilled(e["PHOTO"])){return a.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-icon ui-icon-common-user tasks-projects-members-popup-avatar-img">\n\t\t\t\t\t<i style="background-image: url(\'',"')\"></i>\n\t\t\t\t</div>\n\t\t\t"])),e["PHOTO"])}return a.Tag.render(m||(m=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-icon ui-icon-common-user tasks-projects-members-popup-avatar-img"><i></i></div>\n\t\t'])))}},{key:"showLoader",value:function t(){if(!this.loader){this.loader=new s.Loader({target:this.popup.getPopupContainer().querySelector(".tasks-projects-members-popup-content"),size:40})}void this.loader.show()}},{key:"hideLoader",value:function t(){if(this.loader){void this.loader.hide();this.loader=null}}},{key:"changeType",value:function t(e){var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var n=this.currentType;this.currentType=e;Object.values(this.popupData).forEach((function(t){a.Dom.removeClass(t.tab,"tasks-projects-members-popup-head-item-current")}));a.Dom.addClass(this.getCurrentPopupData().tab,"tasks-projects-members-popup-head-item-current");if(n){a.Dom.replace(this.popupData[n].innerContainer,this.getCurrentPopupData().innerContainer)}if(s&&this.getCurrentPopupData().currentPage===1){this.showLoader();this.showUsers(this.groupId,e)}}},{key:"resetPopupData",value:function t(){this.popupData={all:{currentPage:1,renderedUsers:[],tab:a.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span class="tasks-projects-members-popup-head-item" onclick="','">\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-head-text">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</span>\n\t\t\t\t"])),this.changeType.bind(this,"all"),a.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_TITLE_ALL")),innerContainer:a.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['<div class="tasks-projects-members-popup-inner"></div>'])))},heads:{currentPage:1,renderedUsers:[],tab:a.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span class="tasks-projects-members-popup-head-item" onclick="','">\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-head-text">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</span>\n\t\t\t\t"])),this.changeType.bind(this,"heads"),a.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_TITLE_HEADS")),innerContainer:a.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(['<div class="tasks-projects-members-popup-inner"></div>'])))},members:{currentPage:1,renderedUsers:[],tab:a.Tag.render(P||(P=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span class="tasks-projects-members-popup-head-item" onclick="','">\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-head-text">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</span>\n\t\t\t\t"])),this.changeType.bind(this,"members"),a.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_TITLE_MEMBERS")),innerContainer:a.Tag.render(k||(k=babelHelpers.taggedTemplateLiteral(['<div class="tasks-projects-members-popup-inner"></div>'])))}}}},{key:"getCurrentPopupData",value:function t(){return this.popupData[this.currentType]}}]);return t}();var C,T,w,E,R,j,S,A,I,D,_,B;var O=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).apply(this,arguments))}babelHelpers.createClass(e,[{key:"renderContainer",value:function t(){return a.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<span class="tasks-projects-members-popup-container">\n\t\t\t\t<span class="tasks-projects-members-popup-head">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t\t",'\n\t\t\t\t</span>\n\t\t\t\t<span class="tasks-projects-members-popup-body">\n\t\t\t\t\t<div class="tasks-projects-members-popup-content">\n\t\t\t\t\t\t<div class="tasks-projects-members-popup-content-box">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</span>\n\t\t\t</span>\n\t\t"])),this.popupData.all.tab,this.popupData.scrumTeam.tab,this.popupData.members.tab,this.getCurrentPopupData().innerContainer)}},{key:"resetPopupData",value:function t(){this.popupData={all:{currentPage:1,renderedUsers:[],tab:a.Tag.render(T||(T=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span\n\t\t\t\t\t\tclass="tasks-projects-members-popup-head-item"\n\t\t\t\t\t\tonclick="','"\n\t\t\t\t\t>\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-head-text">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</span>\n\t\t\t\t"])),this.changeType.bind(this,"all"),a.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_TITLE_ALL")),innerContainer:a.Tag.render(w||(w=babelHelpers.taggedTemplateLiteral(['<div class="tasks-projects-members-popup-inner"></div>'])))},scrumTeam:{currentPage:1,renderedUsers:[],tab:a.Tag.render(E||(E=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span\n\t\t\t\t\t\tclass="tasks-projects-members-popup-head-item"\n\t\t\t\t\t\tonclick="','"\n\t\t\t\t\t>\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-head-text">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</span>\n\t\t\t\t"])),this.changeType.bind(this,"scrumTeam"),a.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_TITLE_SCRUM_TEAM")),innerContainer:a.Tag.render(R||(R=babelHelpers.taggedTemplateLiteral(['<div class="tasks-projects-members-popup-inner"></div>'])))},members:{currentPage:1,renderedUsers:[],tab:a.Tag.render(j||(j=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span\n\t\t\t\t\t\tclass="tasks-projects-members-popup-head-item"\n\t\t\t\t\t\tonclick="','"\n\t\t\t\t\t>\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-head-text">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</span>\n\t\t\t\t"])),this.changeType.bind(this,"members"),a.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_TITLE_SCRUM_MEMBERS")),innerContainer:a.Tag.render(S||(S=babelHelpers.taggedTemplateLiteral(['<div class="tasks-projects-members-popup-inner"></div>'])))}}}},{key:"renderUsers",value:function t(e){var s=this;if(this.currentType==="scrumTeam"){this.renderLabels(e);Object.values(e).forEach((function(t){if(s.getCurrentPopupData().renderedUsers.indexOf(t.ID)>=0&&t.ROLE!=="M"){return}s.getCurrentPopupData().renderedUsers.push(t.ID);var e=new Map;e.set("A","tasks-scrum-members-popup-owner-container");e.set("M","tasks-scrum-members-popup-master-container");e.set("E","tasks-scrum-members-popup-team-container");if(a.Type.isUndefined(e.get(t.ROLE))){return}s.getCurrentPopupData().innerContainer.querySelector("."+e.get(t.ROLE)).appendChild(a.Tag.render(A||(A=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t<a class="tasks-projects-members-popup-item" href="','" target="_blank">\n\t\t\t\t\t\t\t\t<span class="tasks-projects-members-popup-avatar-new">\n\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t\t<span class="tasks-projects-members-popup-avatar-status-icon"></span>\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t<span class="tasks-scrum-members-popup-name">',"</span>\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t"])),t["HREF"],s.getAvatar(t),t["FORMATTED_NAME"]))}))}else{Object.values(e).forEach((function(t){if(s.getCurrentPopupData().renderedUsers.indexOf(t.ID)>=0){return}s.getCurrentPopupData().renderedUsers.push(t.ID);s.getCurrentPopupData().innerContainer.appendChild(a.Tag.render(I||(I=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<a class="tasks-projects-members-popup-item" href="','" target="_blank">\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-avatar-new">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t<span class="tasks-projects-members-popup-avatar-status-icon"></span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span class="tasks-scrum-members-popup-name">',"</span>\n\t\t\t\t\t</a>\n\t\t\t\t"])),t["HREF"],s.getAvatar(t),t["FORMATTED_NAME"]))}))}}},{key:"renderLabels",value:function t(e){var s=e.find((function(t){return t.ROLE==="A"}));var n=e.find((function(t){return t.ROLE==="M"}));var r=e.find((function(t){return t.ROLE==="E"}));if(s){this.getCurrentPopupData().innerContainer.appendChild(a.Tag.render(D||(D=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="tasks-scrum-members-popup-owner-container">\n\t\t\t\t\t\t<span class="tasks-scrum-members-popup-label">\n\t\t\t\t\t\t\t<span class="tasks-scrum-members-popup-label-text">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t"])),a.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_LABEL_SCRUM_OWNER")))}if(n){this.getCurrentPopupData().innerContainer.appendChild(a.Tag.render(_||(_=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="tasks-scrum-members-popup-master-container">\n\t\t\t\t\t\t<span class="tasks-scrum-members-popup-label">\n\t\t\t\t\t\t\t<span class="tasks-scrum-members-popup-label-text">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t"])),a.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_LABEL_SCRUM_MASTER")))}if(r){this.getCurrentPopupData().innerContainer.appendChild(a.Tag.render(B||(B=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="tasks-scrum-members-popup-team-container">\n\t\t\t\t\t\t<span class="tasks-scrum-members-popup-label">\n\t\t\t\t\t\t\t<span class="tasks-scrum-members-popup-label-text">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t"])),a.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_LABEL_SCRUM_TEAM")))}}}]);return e}(y);function L(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,n)}return s}function M(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?L(Object(s),!0).forEach((function(e){babelHelpers.defineProperty(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):L(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}var x=function(){babelHelpers.createClass(t,null,[{key:"classes",get:function t(){return{highlighted:"task-projects-item-highlighted",pinned:"tasks-projects-row-pinned"}}}]);function t(e){babelHelpers.classCallCheck(this,t);this.pageSize=10;this.grid=BX.Main.gridManager.getInstanceById(e.gridId);this.stub=e.gridStub;this.sort=e.sort;this.actionsPanel=e.actionsPanel;this.items=new Map;this.fillItems(e.items);this.bindEvents();this.colorPinnedRows()}babelHelpers.createClass(t,[{key:"bindEvents",value:function t(){r.EventEmitter.subscribe("BX.Main.grid:sort",this.onColumnSort.bind(this));r.EventEmitter.subscribe("BX.Main.grid:paramsUpdated",this.onParamsUpdated.bind(this))}},{key:"onColumnSort",value:function t(e){var s=e.getData();var n=s[1];var r=s[0];if(n===this.grid){this.sort={};this.sort[r.sort_by]=r.sort_order}}},{key:"onParamsUpdated",value:function t(){var e=this.getRows().map((function(t){return t.getId()})).filter((function(t){return t!=="template_0"}));var s=e.reduce((function(t,e){return M(M({},t),{},babelHelpers.defineProperty({},e,null))}),{});this.clearItems();this.fillItems(s);this.colorPinnedRows()}},{key:"addRow",value:function t(e,s,n){var i={id:e,columns:s.content,actions:s.actions,cellActions:s.cellActions,counters:s.counters};var o=n.moveParams||{};if(o.rowBefore){i.insertAfter=o.rowBefore}else if(o.rowAfter){i.insertBefore=o.rowAfter}else{i.append=true}if(this.items.size>this.getCurrentPage()*this.pageSize){var u=this.getLastRowId();this.removeItem(u);a.Dom.remove(this.getRowNodeById(u));this.showMoreButton()}this.hideStub();this.getRealtime().addRow(i);this.colorPinnedRows();r.EventEmitter.emit("Tasks.Projects.Grid:RowAdd",{id:e})}},{key:"updateRow",value:function t(e,s,n){var i=this;var a=this.getRowById(e);a.setCellsContent(s.content);a.setActions(s.actions);a.setCellActions(s.cellActions);a.setCounters(s.counters);this.resetRows();this.moveRow(e,n.moveParams||{});this.highlightRow(e,n.highlightParams||{}).then((function(){return i.colorPinnedRows()}),(function(){}));this.grid.bindOnRowEvents();r.EventEmitter.emit("Tasks.Projects.Grid:RowUpdate",{id:e})}},{key:"removeRow",value:function t(e){if(!this.isRowExist(e)){return}this.grid.removeRow(e);r.EventEmitter.emit("Tasks.Projects.Grid:RowRemove",{id:e})}},{key:"moveRow",value:function t(e,s){if(s.skip){return}var n=s.rowBefore||0;var r=s.rowAfter||0;if(n){this.grid.getRows().insertAfter(e,n)}else if(r){this.grid.getRows().insertBefore(e,r)}}},{key:"highlightRow",value:function e(s,n){var r=this;n=n||{};return new Promise((function(e,i){if(!r.isRowExist(s)){i();return}if(n.skip){e();return}var o=r.getRowNodeById(s);var u=a.Dom.hasClass(o,t.classes.pinned);if(u){a.Dom.removeClass(o,t.classes.pinned)}a.Dom.addClass(o,t.classes.highlighted);setTimeout((function(){a.Dom.removeClass(o,t.classes.highlighted);if(u){a.Dom.addClass(o,t.classes.pinned)}e()}),900)}))}},{key:"colorPinnedRows",value:function e(){var s=this;this.getRows().forEach((function(e){var n=e.getNode();s.getIsPinned(e.getId())?a.Dom.addClass(n,t.classes.pinned):a.Dom.removeClass(n,t.classes.pinned)}))}},{key:"resetRows",value:function t(){this.grid.getRows().reset()}},{key:"getRows",value:function t(){return this.grid.getRows().getBodyChild()}},{key:"getFirstRowId",value:function t(){var e=this.grid.getRows().getBodyFirstChild();return e?this.getRowProperty(e,"id"):0}},{key:"getLastRowId",value:function t(){var e=this.grid.getRows().getBodyLastChild();return e?this.getRowProperty(e,"id"):0}},{key:"getLastPinnedRowId",value:function t(){var e=this;var s=Object.values(this.getRows()).filter((function(t){return e.getIsPinned(t.getId())}));var n=Object.keys(s);if(n.length>0){return s[n[n.length-1]].getId()}return 0}},{key:"getIsPinned",value:function t(e){return this.isRowExist(e)&&a.Type.isDomNode(this.getRowNodeById(e).querySelector(".main-grid-cell-content-action-pin.main-grid-cell-content-action-active"))}},{key:"getRowProperty",value:function t(e,s){return BX.data(e.getNode(),s)}},{key:"getRowById",value:function t(e){return this.grid.getRows().getById(e)}},{key:"getRowNodeById",value:function t(e){return this.getRowById(e).getNode()}},{key:"isRowExist",value:function t(e){return this.getRowById(e)!==null}},{key:"getCurrentPage",value:function t(){var e=this.grid.getContainer().querySelector(".modern-page-current");return e?e.innerText:1}},{key:"isActivityRealtimeMode",value:function t(){return this.sort.ACTIVITY_DATE&&this.sort.ACTIVITY_DATE==="desc"}},{key:"getItems",value:function t(){return Array.from(this.items.keys())}},{key:"hasItem",value:function t(e){return this.items.has(parseInt(e,10))}},{key:"addItem",value:function t(e){this.items.set(parseInt(e,10))}},{key:"removeItem",value:function t(e){this.items["delete"](parseInt(e,10))}},{key:"fillItems",value:function t(e){var s=this;Object.keys(e).forEach((function(t){return s.addItem(t)}))}},{key:"clearItems",value:function t(){this.items.clear()}},{key:"getRealtime",value:function t(){return this.grid.getRealtime()}},{key:"showStub",value:function t(){if(this.stub){this.getRealtime().showStub({content:this.stub})}}},{key:"hideStub",value:function t(){this.grid.hideEmptyStub()}},{key:"showMoreButton",value:function t(){this.grid.getMoreButton().getNode().style.display="inline-block"}},{key:"hideMoreButton",value:function t(){this.grid.getMoreButton().getNode().style.display="none"}}]);return t}();var U=function(){babelHelpers.createClass(t,null,[{key:"events",get:function t(){return{add:"add",update:"update",remove:"remove",userAdd:"userAdd",userUpdate:"userUpdate",userRemove:"userRemove",pinChanged:"pinChanged"}}},{key:"counterEvents",get:function t(){return["onAfterTaskAdd","onAfterTaskDelete","onAfterTaskRestore","onAfterTaskView","onAfterTaskMute","onAfterCommentAdd","onAfterCommentDelete","onProjectPermUpdate"]}},{key:"movingProjectEvents",get:function t(){return["onAfterTaskAdd","onAfterCommentAdd"]}}]);function t(e){babelHelpers.classCallCheck(this,t);this.signedParameters=e.signedParameters;this.isScrumList=e.isScrumList==="Y";this.createProjectUrl=e.createProjectUrl;this.scrumLimitSidePanelId=e.scrumLimitSidePanelId;this.grid=new x(e);this.timer=null;this.counterData=new Map;this.userOptions=e.userOptions}babelHelpers.createClass(t,[{key:"getModuleId",value:function t(){return"tasks"}},{key:"getMap",value:function t(){return{project_add:this.onProjectAdd.bind(this),project_update:this.onProjectUpdate.bind(this),project_remove:this.onProjectRemove.bind(this),project_user_add:this.onProjectUserAdd.bind(this),project_user_update:this.onProjectUserUpdate.bind(this),project_user_remove:this.onProjectUserRemove.bind(this),project_user_option_changed:this.onProjectUserOptionChanged.bind(this),project_counter:this.onProjectCounter.bind(this),project_read_all:this.onProjectCommentsReadAll.bind(this),comment_read_all:this.onProjectCommentsReadAll.bind(this),scrum_read_all:this.onProjectCommentsReadAll.bind(this)}}},{key:"onProjectAdd",value:function e(s){var n=this;var r={event:t.events.add,moveParams:{rowBefore:this.grid.getLastPinnedRowId(),rowAfter:this.grid.getFirstRowId()}};this.checkExistence(s.ID).then((function(t){return n.onCheckExistenceSuccess(t,s.ID,r)}),(function(t){return console.error(t)}));if(this.isScrumList){this.checkScrumLimit().then((function(t){return n.onCheckScrumLimit(t)}),(function(t){return console.error(t)}))}}},{key:"onProjectUpdate",value:function e(s){var n=this;var r={event:t.events.update};this.checkExistence(s.ID).then((function(t){return n.onCheckExistenceSuccess(t,s.ID,r)}),(function(t){return console.error(t)}))}},{key:"onProjectRemove",value:function t(e){var s=this;this.removeRow(e.ID);if(this.isScrumList){this.checkScrumLimit().then((function(t){return s.onCheckScrumLimit(t)}),(function(t){return console.error(t)}))}}},{key:"onProjectUserAdd",value:function e(s){var n=this;var r={event:t.events.userAdd};this.checkExistence(s.GROUP_ID).then((function(t){return n.onCheckExistenceSuccess(t,s.GROUP_ID,r)}),(function(t){return console.error(t)}))}},{key:"onProjectUserUpdate",value:function e(s){var n=this;var r={event:t.events.userUpdate};this.checkExistence(s.GROUP_ID).then((function(t){return n.onCheckExistenceSuccess(t,s.GROUP_ID,r)}),(function(t){return console.error(t)}))}},{key:"onProjectUserRemove",value:function e(s){var n=this;var r={event:t.events.userRemove};this.checkExistence(s.GROUP_ID).then((function(t){return n.onCheckExistenceSuccess(t,s.GROUP_ID,r)}),(function(t){return console.error(t)}))}},{key:"onProjectUserOptionChanged",value:function t(e){switch(e.OPTION){case this.userOptions.pinned:this.onProjectPinChanged(e);break;default:break}}},{key:"onProjectPinChanged",value:function e(s){var n={event:t.events.pinChanged};this.moveToDirectPlace(s.PROJECT_ID,null,n)}},{key:"onProjectCounter",value:function e(s){var n=this;var r=s.GROUP_ID;var i=s.EVENT;if(!t.counterEvents.includes(i)){return}if(!this.timer){this.timer=setTimeout((function(){n.freeCounterQueue()}),1e3)}if(t.movingProjectEvents.includes(i)||!this.counterData.has(r)){this.counterData.set(r,i)}}},{key:"freeCounterQueue",value:function e(){var s=this;this.counterData.forEach((function(e,n){var r={event:e,highlightParams:{skip:true}};if(t.movingProjectEvents.includes(e)){r.moveParams={rowBefore:s.grid.getIsPinned(n)?0:s.grid.getLastPinnedRowId(),rowAfter:s.grid.getFirstRowId()};r.highlightParams={skip:false}}s.checkExistence(n).then((function(t){return s.onCheckExistenceSuccess(t,n,r)}),(function(t){return console.error(t)}))}));this.counterData.clear();this.timer=null}},{key:"onProjectCommentsReadAll",value:function t(e){var s=e.GROUP_ID;if(s){if(this.grid.isRowExist(s)){this.updateCounter([s])}}else{this.updateCounter(this.grid.getItems())}}},{key:"checkExistence",value:function t(e){var s=this;return new Promise((function(t,n){BX.ajax.runComponentAction("bitrix:tasks.projects","checkExistence",{mode:"class",data:{groupIds:[e]},signedParameters:s.signedParameters}).then((function(e){return t(e)}),(function(t){return n(t)}))}))}},{key:"checkScrumLimit",value:function t(){var e=this;return new Promise((function(t,s){a.ajax.runAction("bitrix:tasks.scrum.info.checkScrumLimit",{data:{},signedParameters:e.signedParameters}).then((function(e){return t(e.data)}),(function(t){return s(t)}))}))}},{key:"onCheckExistenceSuccess",value:function e(s,n,r){if(a.Type.isUndefined(s.data[n])){return}if(s.data[n]===false){this.removeRow(n);return}var i=s.data[n];if(this.grid.isRowExist(n)){this.grid.isActivityRealtimeMode()?this.updateRow(n,i,r):this.moveToDirectPlace(n,i,r)}else if(this.grid.isActivityRealtimeMode()&&(t.movingProjectEvents.includes(r.event)||r.event===t.events.add)){this.updateItem(n,i,r)}else{this.moveToDirectPlace(n,i,r)}}},{key:"onCheckScrumLimit",value:function t(e){this.projectAddButton=document.getElementById("projectAddButton");if(!a.Type.isDomNode(this.projectAddButton)){return}if(e){this.projectAddButton.href="javascript:BX.UI.InfoHelper.show('".concat(this.scrumLimitSidePanelId,"', {isLimit: true, limitAnalyticsLabels: {module: 'tasks', source: 'scrumList'}})")}else{this.projectAddButton.href=this.createProjectUrl}}},{key:"updateItem",value:function t(e,s,n){if(!this.grid.hasItem(e)){this.grid.addItem(e);this.addRow(e,s,n)}else{this.updateRow(e,s,n)}}},{key:"addRow",value:function t(e,s,n){var r=this;if(this.grid.isRowExist(e)){return}BX.ajax.runComponentAction("bitrix:tasks.projects","prepareGridRows",{mode:"class",data:{groupIds:[e],data:s?babelHelpers.defineProperty({},e,s):null},signedParameters:this.signedParameters}).then((function(t){if(!a.Type.isUndefined(t.data[e])){r.grid.addRow(e,t.data[e],n)}}))}},{key:"updateRow",value:function t(e,s,n){var r=this;if(!this.grid.isRowExist(e)){return}BX.ajax.runComponentAction("bitrix:tasks.projects","prepareGridRows",{mode:"class",data:{groupIds:[e],data:s?babelHelpers.defineProperty({},e,s):null},signedParameters:this.signedParameters}).then((function(t){if(!a.Type.isUndefined(t.data[e])){r.grid.updateRow(e,t.data[e],n)}}))}},{key:"removeRow",value:function t(e){this.grid.removeItem(e);this.grid.removeRow(e)}},{key:"moveToDirectPlace",value:function t(e,s,n){var r=this;n=n||{};BX.ajax.runComponentAction("bitrix:tasks.projects","findProjectPlace",{mode:"class",data:{groupId:e,currentPage:this.grid.getCurrentPage()},signedParameters:this.signedParameters}).then((function(t){if(t.data===null){return}var i=t.data,a=i.projectBefore,o=i.projectAfter;if(a===false&&o===false){r.removeRow(e)}else{if(a&&r.grid.isRowExist(a)||o&&r.grid.isRowExist(o)){n.moveParams={rowBefore:a,rowAfter:o}}else{n.moveParams={skip:true}}r.updateItem(e,s,n)}}))}},{key:"updateCounter",value:function t(e){var s=this;BX.ajax.runComponentAction("bitrix:tasks.projects","prepareGridRows",{mode:"class",data:{groupIds:e,data:null},signedParameters:this.signedParameters}).then((function(t){var e=t.data;if(e){Object.keys(e).forEach((function(t){if(s.grid.isRowExist(t)){s.grid.getRowById(t).setCounters(e[t].counters)}}))}}))}}]);return t}();var H=function(){function t(e){babelHelpers.classCallCheck(this,t);this.grid=new x(e);this.signedParameters=e.signedParameters;this.popupData=e.tours.firstProjectCreation.popupData;this.projectAddButton=BX("projectAddButton");this.guide=new i.Guide({steps:[{target:this.projectAddButton,title:this.popupData[0].title,text:this.popupData[0].text,article:this.popupData[0].article}],onEvents:true});this.bindEvents()}babelHelpers.createClass(t,[{key:"bindEvents",value:function t(){r.EventEmitter.subscribe("UI.Tour.Guide:onFinish",this.onGuideFinish.bind(this));r.EventEmitter.subscribe("SidePanel.Slider:onMessage",this.onProjectSliderMessage.bind(this))}},{key:"onGuideFinish",value:function t(e){var s=e.getData(),n=s.guide;if(n===this.guide){this.projectAddButton.href=a.Uri.removeParam(this.projectAddButton.href,["PROJECT_OPTIONS"])}}},{key:"onProjectSliderMessage",value:function t(e){var s=e.getData(),n=babelHelpers.slicedToArray(s,1),i=n[0];if(i.getEventId()!=="sonetGroupEvent"){return}var a=i.getData();if(a.code!=="afterCreate"||a.data.projectOptions.tourId!==this.guide.getId()){return}var o=a.data.group.ID;if(this.grid.isRowExist(o)){this.showFinalStep(o)}else{r.EventEmitter.subscribe("Tasks.Projects.Grid:RowAdd",this.onProjectRowAdded.bind(this,o))}}},{key:"onProjectRowAdded",value:function t(e,s){var n=s.getData(),r=n.id;if(Number(r)===Number(e)){this.showFinalStep(e)}}},{key:"showFinalStep",value:function t(e){var s=this;var n=this.grid.getRowNodeById(e).querySelector(".tasks-projects-text");this.guide.steps.push(new i.Step({target:n,cursorMode:true,targetEvent:function t(){BX.SidePanel.Instance.open(n.href);setTimeout((function(){return s.guide.close()}),1e3)}}));this.finish();this.showNextStep()}},{key:"start",value:function t(){this.projectAddButton.href=a.Uri.addParam(this.projectAddButton.href,{PROJECT_OPTIONS:{tourId:this.guide.getId()}});this.showNextStep()}},{key:"finish",value:function t(){BX.ajax.runAction("tasks.tourguide.firstprojectcreation.finish")}},{key:"showNextStep",value:function t(){var e=this;setTimeout((function(){return e.guide.showNextStep()}),1e3)}}]);return t}();var F=function(){function t(e){babelHelpers.classCallCheck(this,t);this.grid=new x(e);this.signedParameters=e.signedParameters;this.popupData=e.tours.firstScrumCreation.popupData;this.projectAddButton=BX("projectAddButton");this.guide=new i.Guide({steps:[{target:this.projectAddButton,title:this.popupData[0].title,text:this.popupData[0].text,article:null}],onEvents:true});this.bindEvents()}babelHelpers.createClass(t,[{key:"bindEvents",value:function t(){r.EventEmitter.subscribe("UI.Tour.Guide:onFinish",this.onGuideFinish.bind(this));r.EventEmitter.subscribe("SidePanel.Slider:onMessage",this.onProjectSliderMessage.bind(this))}},{key:"onGuideFinish",value:function t(e){var s=e.getData(),n=s.guide;if(n===this.guide){this.projectAddButton.href=a.Uri.removeParam(this.projectAddButton.href,["PROJECT_OPTIONS"])}}},{key:"onProjectSliderMessage",value:function t(e){var s=e.getData(),n=babelHelpers.slicedToArray(s,1),i=n[0];if(i.getEventId()!=="sonetGroupEvent"){return}var a=i.getData();if(a.code!=="afterCreate"||a.data.projectOptions.tourId!==this.guide.getId()){return}var o=a.data.group.ID;if(this.grid.isRowExist(o)){this.showFinalStep(o)}else{r.EventEmitter.subscribe("Tasks.Projects.Grid:RowAdd",this.onProjectRowAdded.bind(this,o))}}},{key:"onProjectRowAdded",value:function t(e,s){var n=s.getData(),r=n.id;if(Number(r)===Number(e)){this.showFinalStep(e)}}},{key:"showFinalStep",value:function t(e){var s=this;var n=this.grid.getRowNodeById(e).querySelector(".tasks-projects-text");this.guide.steps.push(new i.Step({target:n,cursorMode:true,targetEvent:function t(){BX.SidePanel.Instance.open(n.href);setTimeout((function(){return s.guide.close()}),1e3)}}));this.finish();this.showNextStep()}},{key:"start",value:function t(){this.projectAddButton.href=a.Uri.addParam(this.projectAddButton.href,{PROJECT_OPTIONS:{tourId:this.guide.getId()}});this.showNextStep()}},{key:"finish",value:function t(){BX.ajax.runAction("tasks.tourguide.firstscrumcreation.finish")}},{key:"showNextStep",value:function t(){var e=this;setTimeout((function(){return e.guide.showNextStep()}),1e3)}}]);return t}();var G=function(){function t(e){babelHelpers.classCallCheck(this,t);this.tours=e.tours;this.initGuides(e)}babelHelpers.createClass(t,[{key:"initGuides",value:function t(e){if(this.tours.firstProjectCreation&&this.tours.firstProjectCreation.show){this.firstProjectCreationTourGuide=new H(e);this.firstProjectCreationTourGuide.start()}if(this.tours.firstScrumCreation&&this.tours.firstScrumCreation.show){this.firstScrumCreationTourGuide=new F(e);this.firstScrumCreationTourGuide.start()}}}]);return t}();var N=function(){function t(e){babelHelpers.classCallCheck(this,t);this.membersPopup=new y(e);this.scrumMembersPopup=new O(e);this.filter=new l(e);this.tourGuideController=new G(e);e.filter=this.filter;c.setOptions(e);this.initPull(e)}babelHelpers.createClass(t,[{key:"initPull",value:function t(s){this.pullController=new U(s);this.pullClient=e.PULL;this.pullClient.subscribe(this.pullController)}},{key:"getMembersPopup",value:function t(){return this.membersPopup}},{key:"getScrumMembersPopup",value:function t(){return this.scrumMembersPopup}},{key:"getFilter",value:function t(){return this.filter}}]);return t}();t.Controller=N;t.ActionsController=c})(this.BX.Tasks.Projects=this.BX.Tasks.Projects||{},BX,BX,BX.Main,BX.Event,BX.UI.Tour,BX);
//# sourceMappingURL=script.map.js