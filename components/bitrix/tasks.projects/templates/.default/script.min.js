this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(e,t,n,s,i,r,o){"use strict";var a=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(a,"SHOW_BY_HOVER","main-grid-cell-content-action-by-hover");babelHelpers.defineProperty(a,"ACTIVE","main-grid-cell-content-action-active");var u=o.Reflection.namespace("BX.Grid");u.CellActionState=a;var c=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"setOptions",value:function t(n){e.options=n}},{key:"setActionsPanel",value:function t(n){e.actionsPanel=n}},{key:"doAction",value:function t(n,s){var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];return new Promise(function(t,r){BX.ajax.runComponentAction("bitrix:tasks.projects","processAction",{mode:"class",data:{action:n,data:i,ids:e.getActionIds(s)||[]},signedParameters:e.options.signedParameters}).then(function(){return t()},function(){return r()}).catch(function(){return r()});e.hideActionsPanel();e.unselectRows()})}},{key:"getActionIds",value:function t(n){if(n!==undefined){return[n]}var s=e.getSelectedRows();if(s.length===0){return[]}return s.map(function(e){return e.getDataset().id})}},{key:"getSelectedRows",value:function t(){return e.getGridInstance().getRows().getSelected()}},{key:"sendJoinRequest",value:function t(n){if(o.Dom.hasClass(n,"ui-btn-clock")){return}o.Dom.addClass(n,"ui-btn-clock");BX.ajax({url:n.getAttribute("bx-request-url"),method:"POST",dataType:"json",data:{ajax_request:"Y",save:"Y",sessid:BX.bitrix_sessid()},onsuccess:function e(){return o.Dom.removeClass(n,"ui-btn-clock")},onfailure:function e(){return o.Dom.removeClass(n,"ui-btn-clock")}});e.hideActionsPanel();e.unselectRows()}},{key:"sendAcceptRequest",value:function t(n,s){BX.ajax({url:s,method:"POST",dataType:"json",data:{action:"accept",max_count:1,checked_0:"Y",type_0:"INVITE_GROUP",id_0:n,type:"in",ajax_request:"Y",sessid:BX.bitrix_sessid()},onsuccess:function e(t){},onfailure:function e(t){return console.log(t)}});e.hideActionsPanel();e.unselectRows()}},{key:"sendDenyRequest",value:function t(n,s){e.sendCancelRequest(n,s)}},{key:"sendCancelRequest",value:function t(n,s){BX.ajax({url:s,method:"POST",dataType:"json",data:{action:"reject",max_count:1,checked_0:"Y",type_0:"INVITE_GROUP",id_0:n,type:"out",ajax_request:"Y",sessid:BX.bitrix_sessid()},onsuccess:function e(t){},onfailure:function e(t){return console.log(t)}});e.hideActionsPanel();e.unselectRows()}},{key:"hideActionsPanel",value:function t(){e.options.actionsPanel.hidePanel()}},{key:"unselectRows",value:function t(){e.getGridInstance().getRows().unselectAll()}},{key:"getGridInstance",value:function t(){return BX.Main.gridManager.getById(e.options.gridId).instance}},{key:"changePin",value:function t(n,s){var i=s.getData(),r=i.button;if(o.Dom.hasClass(r,a.ACTIVE)){e.doAction("unpin",n).then(function(){o.Dom.removeClass(r,a.ACTIVE);o.Dom.addClass(r,a.SHOW_BY_HOVER)})}else{e.doAction("pin",n).then(function(){o.Dom.addClass(r,a.ACTIVE);o.Dom.removeClass(r,a.SHOW_BY_HOVER)})}}},{key:"onTagClick",value:function t(n){var s=e.options.filter;s.toggleByField(n)}},{key:"onTagAddClick",value:function t(n,s){o.Runtime.loadExtension("ui.entity-selector").then(function(t){var r=function t(s){var i=s.getData(),r=i.id;if(r===n){var o=e.getGridInstance().getRows().getById(r);var a=o.getCellById("TAGS").querySelector(".main-grid-tag-add");l.setTargetNode(a)}};var a=function e(t){var s=t.getData(),i=s.id;if(i===n){l.hide()}};var u=function t(s){var i=s.getTarget();var r=i.getSelectedItems().map(function(e){return e.getId()});void e.doAction("update",n,{KEYWORDS:r.join(",")})};var c=t.Dialog;var l=new c({targetNode:s.getData().button,enableSearch:true,width:350,height:400,multiple:true,dropdownMode:true,compactView:true,context:"PROJECT_TAG",entities:[{id:"project-tag",options:{groupId:n}}],searchOptions:{allowCreateItem:true,footerOptions:{label:o.Loc.getMessage("TASKS_PROJECTS_ENTITY_SELECTOR_TAG_SEARCH_FOOTER_ADD")}},footer:BX.SocialNetwork.EntitySelector.Footer,footerOptions:{tagCreationLabel:true},events:{onShow:function e(){i.EventEmitter.subscribe("Tasks.Projects.Grid:RowUpdate",r);i.EventEmitter.subscribe("Tasks.Projects.Grid:RowRemove",a)},onHide:function e(){i.EventEmitter.unsubscribe("Tasks.Projects.Grid:RowUpdate",r);i.EventEmitter.unsubscribe("Tasks.Projects.Grid:RowRemove",a)},"Search:onItemCreateAsync":function e(t){return new Promise(function(e){var n=t.getData(),s=n.searchQuery;var i=s.getQuery().toLowerCase();var r=t.getTarget();setTimeout(function(){var t=r.addItem({id:i,entityId:"project-tag",title:i,tabs:"all"});if(t){t.select()}e()},1e3)})},"Item:onSelect":u,"Item:onDeselect":u}});l.show()})}}]);return e}();var l=function(){function e(t){babelHelpers.classCallCheck(this,e);this.filter=BX.Main.filterManager.getById(t.filterId);this.init();this.bindEvents()}babelHelpers.createClass(e,[{key:"init",value:function e(){this.updateFields()}},{key:"bindEvents",value:function e(){i.EventEmitter.subscribe("BX.Main.Filter:apply",this.onFilterApply.bind(this));i.EventEmitter.subscribe("Tasks.Toolbar:onItem",this.onCounterClick.bind(this))}},{key:"onFilterApply",value:function e(){this.updateFields()}},{key:"updateFields",value:function e(){this.fields=this.filter.getFilterFieldsValues()}},{key:"onCounterClick",value:function e(t){var n=t.getData();if(n.counter&&n.counter.filter){this.toggleByField(babelHelpers.defineProperty({},n.counter.filterField,n.counter.filterValue))}}},{key:"isFilteredByField",value:function e(t){if(!Object.keys(this.fields).includes(t)){return false}if(o.Type.isArray(this.fields[t])){return this.fields[t].length>0}return this.fields[t]!==""}},{key:"isFilteredByFieldValue",value:function e(t,n){return this.isFilteredByField(t)&&this.fields[t]===n}},{key:"toggleByField",value:function e(t){var n=this;var s=Object.keys(t)[0];var i=t[s];if(!this.isFilteredByFieldValue(s,i)){this.filter.getApi().extendFilter(babelHelpers.defineProperty({},s,i));return}this.filter.getFilterFields().forEach(function(e){if(e.getAttribute("data-name")===s){n.filter.getFields().deleteField(e)}});this.filter.getSearch().apply()}}]);return e}();var d,p,h,g,f,v,m,b,k,P;var y=function(){function e(t){babelHelpers.classCallCheck(this,e);this.signedParameters=t.signedParameters}babelHelpers.createClass(e,[{key:"show",value:function e(t,n){var i=this;var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"all";if(this.isPopupShown){this.popup.destroy()}this.groupId=t;this.resetPopupData();this.changeType(r,false);this.popup=s.PopupWindowManager.create({id:"projects-members-popup-menu",className:"tasks-projects-members-popup",bindElement:n,autoHide:true,closeByEsc:true,lightShadow:true,bindOptions:{position:"bottom"},animationOptions:{show:{type:"opacity-transform"},close:{type:"opacity"}},events:{onPopupDestroy:function e(){i.loader=null;i.isPopupShown=false},onPopupClose:function e(){i.popup.destroy()},onAfterPopupShow:function e(n){n.contentContainer.appendChild(i.renderContainer());i.showLoader();i.showUsers(t,r);i.isPopupShown=true}}});this.popupScroll(t,r);this.popup.show()}},{key:"renderContainer",value:function e(){return o.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<span class="tasks-projects-members-popup-container">\n\t\t\t\t<span class="tasks-projects-members-popup-head">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t\t",'\n\t\t\t\t</span>\n\t\t\t\t<span class="tasks-projects-members-popup-body">\n\t\t\t\t\t<div class="tasks-projects-members-popup-content">\n\t\t\t\t\t\t<div class="tasks-projects-members-popup-content-box">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</span>\n\t\t\t</span>\n\t\t"])),this.popupData.all.tab,this.popupData.heads.tab,this.popupData.members.tab,this.getCurrentPopupData().innerContainer)}},{key:"popupScroll",value:function e(t,n){var s=this;if(!BX.type.isDomNode(this.getCurrentPopupData().innerContainer)){return}o.Event.bind(this.getCurrentPopupData().innerContainer,"scroll",function(e){var i=e.target;if(i.scrollTop>(i.scrollHeight-i.offsetHeight)/1.5){s.showUsers(t,n);o.Event.unbindAll(s.getCurrentPopupData().innerContainer)}})}},{key:"showUsers",value:function e(t,n){var s=this;BX.ajax.runComponentAction("bitrix:tasks.projects","getPopupMembers",{mode:"class",data:{groupId:t,type:n,page:this.getCurrentPopupData().currentPage},signedParameters:this.signedParameters}).then(function(e){if(s.groupId!==t||s.currentType!==n){s.hideLoader();return}if(e.data.length>0){s.renderUsers(e.data);s.popupScroll(t,s.currentType)}else if(!s.getCurrentPopupData().innerContainer.hasChildNodes()){s.getCurrentPopupData().innerContainer.innerText=o.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_EMPTY")}s.getCurrentPopupData().currentPage++;s.hideLoader()},function(){return s.hideLoader()})}},{key:"renderUsers",value:function e(t){var n=this;Object.values(t).forEach(function(e){if(n.getCurrentPopupData().renderedUsers.indexOf(e.ID)>=0){return}n.getCurrentPopupData().renderedUsers.push(e.ID);n.getCurrentPopupData().innerContainer.appendChild(o.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<a class="tasks-projects-members-popup-item" href="','" target="_blank">\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-avatar-new">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t<span class="tasks-projects-members-popup-avatar-status-icon"></span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-name">',"</span>\n\t\t\t\t\t</a>\n\t\t\t\t"])),e["HREF"],n.getAvatar(e),e["FORMATTED_NAME"]))})}},{key:"getAvatar",value:function e(t){if(o.Type.isStringFilled(t["PHOTO"])){return o.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-icon ui-icon-common-user tasks-projects-members-popup-avatar-img">\n\t\t\t\t\t<i style="background-image: url(\'',"')\"></i>\n\t\t\t\t</div>\n\t\t\t"])),t["PHOTO"])}return o.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-icon ui-icon-common-user tasks-projects-members-popup-avatar-img"><i></i></div>\n\t\t'])))}},{key:"showLoader",value:function e(){if(!this.loader){this.loader=new n.Loader({target:this.popup.getPopupContainer().querySelector(".tasks-projects-members-popup-content"),size:40})}void this.loader.show()}},{key:"hideLoader",value:function e(){if(this.loader){void this.loader.hide();this.loader=null}}},{key:"changeType",value:function e(t){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var s=this.currentType;this.currentType=t;Object.values(this.popupData).forEach(function(e){o.Dom.removeClass(e.tab,"tasks-projects-members-popup-head-item-current")});o.Dom.addClass(this.getCurrentPopupData().tab,"tasks-projects-members-popup-head-item-current");if(s){o.Dom.replace(this.popupData[s].innerContainer,this.getCurrentPopupData().innerContainer)}if(n&&this.getCurrentPopupData().currentPage===1){this.showLoader();this.showUsers(this.groupId,t)}}},{key:"resetPopupData",value:function e(){this.popupData={all:{currentPage:1,renderedUsers:[],tab:o.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span class="tasks-projects-members-popup-head-item" onclick="','">\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-head-text">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</span>\n\t\t\t\t"])),this.changeType.bind(this,"all"),o.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_TITLE_ALL")),innerContainer:o.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['<div class="tasks-projects-members-popup-inner"></div>'])))},heads:{currentPage:1,renderedUsers:[],tab:o.Tag.render(m||(m=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span class="tasks-projects-members-popup-head-item" onclick="','">\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-head-text">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</span>\n\t\t\t\t"])),this.changeType.bind(this,"heads"),o.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_TITLE_HEADS")),innerContainer:o.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(['<div class="tasks-projects-members-popup-inner"></div>'])))},members:{currentPage:1,renderedUsers:[],tab:o.Tag.render(k||(k=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span class="tasks-projects-members-popup-head-item" onclick="','">\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-head-text">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</span>\n\t\t\t\t"])),this.changeType.bind(this,"members"),o.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_TITLE_MEMBERS")),innerContainer:o.Tag.render(P||(P=babelHelpers.taggedTemplateLiteral(['<div class="tasks-projects-members-popup-inner"></div>'])))}}}},{key:"getCurrentPopupData",value:function e(){return this.popupData[this.currentType]}}]);return e}();var C=function(){babelHelpers.createClass(e,null,[{key:"classes",get:function e(){return{highlighted:"task-projects-item-highlighted",pinned:"tasks-projects-row-pinned"}}}]);function e(t){babelHelpers.classCallCheck(this,e);this.pageSize=10;this.grid=BX.Main.gridManager.getInstanceById(t.gridId);this.stub=t.gridStub;this.sort=t.sort;this.actionsPanel=t.actionsPanel;this.items=new Map;this.fillItems(t.items);this.bindEvents();this.colorPinnedRows()}babelHelpers.createClass(e,[{key:"bindEvents",value:function e(){i.EventEmitter.subscribe("BX.Main.grid:sort",this.onColumnSort.bind(this));i.EventEmitter.subscribe("BX.Main.grid:paramsUpdated",this.onParamsUpdated.bind(this))}},{key:"onColumnSort",value:function e(t){var n=t.getData();var s=n[1];var i=n[0];if(s===this.grid){this.sort={};this.sort[i.sort_by]=i.sort_order}}},{key:"onParamsUpdated",value:function e(){var t=this.getRows().map(function(e){return e.getId()}).filter(function(e){return e!=="template_0"});var n=t.reduce(function(e,t){return babelHelpers.objectSpread({},e,babelHelpers.defineProperty({},t,null))},{});this.clearItems();this.fillItems(n);this.colorPinnedRows()}},{key:"addRow",value:function e(t,n,s){var r={id:t,columns:n.content,actions:n.actions,cellActions:n.cellActions,counters:n.counters};var a=s.moveParams||{};if(a.rowBefore){r.insertAfter=a.rowBefore}else if(a.rowAfter){r.insertBefore=a.rowAfter}else{r.append=true}if(this.items.size>this.getCurrentPage()*this.pageSize){var u=this.getLastRowId();this.removeItem(u);o.Dom.remove(this.getRowNodeById(u));this.showMoreButton()}this.hideStub();this.getRealtime().addRow(r);this.colorPinnedRows();i.EventEmitter.emit("Tasks.Projects.Grid:RowAdd",{id:t})}},{key:"updateRow",value:function e(t,n,s){var r=this;var o=this.getRowById(t);o.setCellsContent(n.content);o.setActions(n.actions);o.setCellActions(n.cellActions);o.setCounters(n.counters);this.resetRows();this.moveRow(t,s.moveParams||{});this.highlightRow(t,s.highlightParams||{}).then(function(){return r.colorPinnedRows()},function(){});this.grid.bindOnRowEvents();i.EventEmitter.emit("Tasks.Projects.Grid:RowUpdate",{id:t})}},{key:"removeRow",value:function e(t){if(!this.isRowExist(t)){return}this.grid.removeRow(t);i.EventEmitter.emit("Tasks.Projects.Grid:RowRemove",{id:t})}},{key:"moveRow",value:function e(t,n){if(n.skip){return}var s=n.rowBefore||0;var i=n.rowAfter||0;if(s){this.grid.getRows().insertAfter(t,s)}else if(i){this.grid.getRows().insertBefore(t,i)}}},{key:"highlightRow",value:function t(n,s){var i=this;s=s||{};return new Promise(function(t,r){if(!i.isRowExist(n)){r();return}if(s.skip){t();return}var a=i.getRowNodeById(n);var u=o.Dom.hasClass(a,e.classes.pinned);if(u){o.Dom.removeClass(a,e.classes.pinned)}o.Dom.addClass(a,e.classes.highlighted);setTimeout(function(){o.Dom.removeClass(a,e.classes.highlighted);if(u){o.Dom.addClass(a,e.classes.pinned)}t()},900)})}},{key:"colorPinnedRows",value:function t(){var n=this;this.getRows().forEach(function(t){var s=t.getNode();n.getIsPinned(t.getId())?o.Dom.addClass(s,e.classes.pinned):o.Dom.removeClass(s,e.classes.pinned)})}},{key:"resetRows",value:function e(){this.grid.getRows().reset()}},{key:"getRows",value:function e(){return this.grid.getRows().getBodyChild()}},{key:"getFirstRowId",value:function e(){var t=this.grid.getRows().getBodyFirstChild();return t?this.getRowProperty(t,"id"):0}},{key:"getLastRowId",value:function e(){var t=this.grid.getRows().getBodyLastChild();return t?this.getRowProperty(t,"id"):0}},{key:"getLastPinnedRowId",value:function e(){var t=this;var n=Object.values(this.getRows()).filter(function(e){return t.getIsPinned(e.getId())});var s=Object.keys(n);if(s.length>0){return n[s[s.length-1]].getId()}return 0}},{key:"getIsPinned",value:function e(t){return this.isRowExist(t)&&o.Type.isDomNode(this.getRowNodeById(t).querySelector(".main-grid-cell-content-action-pin.main-grid-cell-content-action-active"))}},{key:"getRowProperty",value:function e(t,n){return BX.data(t.getNode(),n)}},{key:"getRowById",value:function e(t){return this.grid.getRows().getById(t)}},{key:"getRowNodeById",value:function e(t){return this.getRowById(t).getNode()}},{key:"isRowExist",value:function e(t){return this.getRowById(t)!==null}},{key:"getCurrentPage",value:function e(){var t=this.grid.getContainer().querySelector(".modern-page-current");return t?t.innerText:1}},{key:"isActivityRealtimeMode",value:function e(){return this.sort.ACTIVITY_DATE&&this.sort.ACTIVITY_DATE==="desc"}},{key:"getItems",value:function e(){return Array.from(this.items.keys())}},{key:"hasItem",value:function e(t){return this.items.has(parseInt(t,10))}},{key:"addItem",value:function e(t){this.items.set(parseInt(t,10))}},{key:"removeItem",value:function e(t){this.items.delete(parseInt(t,10))}},{key:"fillItems",value:function e(t){var n=this;Object.keys(t).forEach(function(e){return n.addItem(e)})}},{key:"clearItems",value:function e(){this.items.clear()}},{key:"getRealtime",value:function e(){return this.grid.getRealtime()}},{key:"showStub",value:function e(){if(this.stub){this.getRealtime().showStub({content:this.stub})}}},{key:"hideStub",value:function e(){this.grid.hideEmptyStub()}},{key:"showMoreButton",value:function e(){this.grid.getMoreButton().getNode().style.display="inline-block"}},{key:"hideMoreButton",value:function e(){this.grid.getMoreButton().getNode().style.display="none"}}]);return e}();var w=function(){babelHelpers.createClass(e,null,[{key:"events",get:function e(){return{add:"add",update:"update",remove:"remove",userAdd:"userAdd",userUpdate:"userUpdate",userRemove:"userRemove",pinChanged:"pinChanged"}}},{key:"counterEvents",get:function e(){return["onAfterTaskAdd","onAfterTaskDelete","onAfterTaskRestore","onAfterTaskView","onAfterTaskMute","onAfterCommentAdd","onAfterCommentDelete","onProjectPermUpdate"]}},{key:"movingProjectEvents",get:function e(){return["onAfterTaskAdd","onAfterCommentAdd"]}}]);function e(t){babelHelpers.classCallCheck(this,e);this.signedParameters=t.signedParameters;this.grid=new C(t);this.timer=null;this.counterData=new Map;this.userOptions=t.userOptions}babelHelpers.createClass(e,[{key:"getModuleId",value:function e(){return"tasks"}},{key:"getMap",value:function e(){return{project_add:this.onProjectAdd.bind(this),project_update:this.onProjectUpdate.bind(this),project_remove:this.onProjectRemove.bind(this),project_user_add:this.onProjectUserAdd.bind(this),project_user_update:this.onProjectUserUpdate.bind(this),project_user_remove:this.onProjectUserRemove.bind(this),project_user_option_changed:this.onProjectUserOptionChanged.bind(this),project_counter:this.onProjectCounter.bind(this),project_read_all:this.onProjectCommentsReadAll.bind(this),comment_read_all:this.onProjectCommentsReadAll.bind(this)}}},{key:"onProjectAdd",value:function t(n){var s=this;var i={event:e.events.add,moveParams:{rowBefore:this.grid.getLastPinnedRowId(),rowAfter:this.grid.getFirstRowId()}};this.checkExistence(n.ID).then(function(e){return s.onCheckExistenceSuccess(e,n.ID,i)},function(e){return console.error(e)})}},{key:"onProjectUpdate",value:function t(n){var s=this;var i={event:e.events.update};this.checkExistence(n.ID).then(function(e){return s.onCheckExistenceSuccess(e,n.ID,i)},function(e){return console.error(e)})}},{key:"onProjectRemove",value:function e(t){this.removeRow(t.ID)}},{key:"onProjectUserAdd",value:function t(n){var s=this;var i={event:e.events.userAdd};this.checkExistence(n.GROUP_ID).then(function(e){return s.onCheckExistenceSuccess(e,n.GROUP_ID,i)},function(e){return console.error(e)})}},{key:"onProjectUserUpdate",value:function t(n){var s=this;var i={event:e.events.userUpdate};this.checkExistence(n.GROUP_ID).then(function(e){return s.onCheckExistenceSuccess(e,n.GROUP_ID,i)},function(e){return console.error(e)})}},{key:"onProjectUserRemove",value:function t(n){var s=this;var i={event:e.events.userRemove};this.checkExistence(n.GROUP_ID).then(function(e){return s.onCheckExistenceSuccess(e,n.GROUP_ID,i)},function(e){return console.error(e)})}},{key:"onProjectUserOptionChanged",value:function e(t){switch(t.OPTION){case this.userOptions.pinned:this.onProjectPinChanged(t);break;default:break}}},{key:"onProjectPinChanged",value:function t(n){var s={event:e.events.pinChanged};this.moveToDirectPlace(n.PROJECT_ID,null,s)}},{key:"onProjectCounter",value:function t(n){var s=this;var i=n.GROUP_ID;var r=n.EVENT;if(!e.counterEvents.includes(r)){return}if(!this.timer){this.timer=setTimeout(function(){s.freeCounterQueue()},1e3)}if(e.movingProjectEvents.includes(r)||!this.counterData.has(i)){this.counterData.set(i,r)}}},{key:"freeCounterQueue",value:function t(){var n=this;this.counterData.forEach(function(t,s){var i={event:t,highlightParams:{skip:true}};if(e.movingProjectEvents.includes(t)){i.moveParams={rowBefore:n.grid.getIsPinned(s)?0:n.grid.getLastPinnedRowId(),rowAfter:n.grid.getFirstRowId()};i.highlightParams={skip:false}}n.checkExistence(s).then(function(e){return n.onCheckExistenceSuccess(e,s,i)},function(e){return console.error(e)})});this.counterData.clear();this.timer=null}},{key:"onProjectCommentsReadAll",value:function e(t){var n=t.GROUP_ID;if(n){if(this.grid.isRowExist(n)){this.updateCounter([n])}}else{this.updateCounter(this.grid.getItems())}}},{key:"checkExistence",value:function e(t){var n=this;return new Promise(function(e,s){BX.ajax.runComponentAction("bitrix:tasks.projects","checkExistence",{mode:"class",data:{groupIds:[t]},signedParameters:n.signedParameters}).then(function(t){return e(t)},function(e){return s(e)})})}},{key:"onCheckExistenceSuccess",value:function t(n,s,i){if(n.data[s]===false){this.removeRow(s);return}var r=n.data[s];if(this.grid.isRowExist(s)){this.grid.isActivityRealtimeMode()?this.updateRow(s,r,i):this.moveToDirectPlace(s,r,i)}else if(this.grid.isActivityRealtimeMode()&&(e.movingProjectEvents.includes(i.event)||i.event===e.events.add)){this.updateItem(s,r,i)}else{this.moveToDirectPlace(s,r,i)}}},{key:"updateItem",value:function e(t,n,s){if(!this.grid.hasItem(t)){this.grid.addItem(t);this.addRow(t,n,s)}else{this.updateRow(t,n,s)}}},{key:"addRow",value:function e(t,n,s){var i=this;if(this.grid.isRowExist(t)){return}BX.ajax.runComponentAction("bitrix:tasks.projects","prepareGridRows",{mode:"class",data:{groupIds:[t],data:n?babelHelpers.defineProperty({},t,n):null},signedParameters:this.signedParameters}).then(function(e){return i.grid.addRow(t,e.data[t],s)})}},{key:"updateRow",value:function e(t,n,s){var i=this;if(!this.grid.isRowExist(t)){return}BX.ajax.runComponentAction("bitrix:tasks.projects","prepareGridRows",{mode:"class",data:{groupIds:[t],data:n?babelHelpers.defineProperty({},t,n):null},signedParameters:this.signedParameters}).then(function(e){return i.grid.updateRow(t,e.data[t],s)})}},{key:"removeRow",value:function e(t){this.grid.removeItem(t);this.grid.removeRow(t)}},{key:"moveToDirectPlace",value:function e(t,n,s){var i=this;s=s||{};BX.ajax.runComponentAction("bitrix:tasks.projects","findProjectPlace",{mode:"class",data:{groupId:t,currentPage:this.grid.getCurrentPage()},signedParameters:this.signedParameters}).then(function(e){var r=e.data,o=r.projectBefore,a=r.projectAfter;if(o===false&&a===false){i.removeRow(t)}else{if(o&&i.grid.isRowExist(o)||a&&i.grid.isRowExist(a)){s.moveParams={rowBefore:o,rowAfter:a}}else{s.moveParams={skip:true}}i.updateItem(t,n,s)}})}},{key:"updateCounter",value:function e(t){var n=this;BX.ajax.runComponentAction("bitrix:tasks.projects","prepareGridRows",{mode:"class",data:{groupIds:t,data:null},signedParameters:this.signedParameters}).then(function(e){var t=e.data;if(t){Object.keys(t).forEach(function(e){if(n.grid.isRowExist(e)){n.grid.getRowById(e).setCounters(t[e].counters)}})}})}}]);return e}();var R=function(){function e(t){babelHelpers.classCallCheck(this,e);this.grid=new C(t);this.signedParameters=t.signedParameters;this.popupData=t.tours.firstProjectCreation.popupData;this.projectAddButton=BX("projectAddButton");this.guide=new r.Guide({steps:[{target:this.projectAddButton,title:this.popupData[0].title,text:this.popupData[0].text,article:this.popupData[0].article}],onEvents:true});this.bindEvents()}babelHelpers.createClass(e,[{key:"bindEvents",value:function e(){i.EventEmitter.subscribe("UI.Tour.Guide:onFinish",this.onGuideFinish.bind(this));i.EventEmitter.subscribe("SidePanel.Slider:onMessage",this.onProjectSliderMessage.bind(this))}},{key:"onGuideFinish",value:function e(t){var n=t.getData(),s=n.guide;if(s===this.guide){this.projectAddButton.href=o.Uri.removeParam(this.projectAddButton.href,["PROJECT_OPTIONS"])}}},{key:"onProjectSliderMessage",value:function e(t){var n=t.getData(),s=babelHelpers.slicedToArray(n,1),r=s[0];if(r.getEventId()!=="sonetGroupEvent"){return}var o=r.getData();if(o.code!=="afterCreate"||o.data.projectOptions.tourId!==this.guide.getId()){return}var a=o.data.group.ID;if(this.grid.isRowExist(a)){this.showFinalStep(a)}else{i.EventEmitter.subscribe("Tasks.Projects.Grid:RowAdd",this.onProjectRowAdded.bind(this,a))}}},{key:"onProjectRowAdded",value:function e(t,n){var s=n.getData(),i=s.id;if(Number(i)===Number(t)){this.showFinalStep(t)}}},{key:"showFinalStep",value:function e(t){var n=this;var s=this.grid.getRowNodeById(t).querySelector(".tasks-projects-text");this.guide.steps.push(new r.Step({target:s,cursorMode:true,targetEvent:function e(){BX.SidePanel.Instance.open(s.href);setTimeout(function(){return n.guide.close()},1e3)}}));this.finish();this.showNextStep()}},{key:"start",value:function e(){this.projectAddButton.href=o.Uri.addParam(this.projectAddButton.href,{PROJECT_OPTIONS:{tourId:this.guide.getId()}});this.showNextStep()}},{key:"finish",value:function e(){BX.ajax.runAction("tasks.tourguide.firstprojectcreation.finish")}},{key:"showNextStep",value:function e(){var t=this;setTimeout(function(){return t.guide.showNextStep()},1e3)}}]);return e}();var E=function(){function e(t){babelHelpers.classCallCheck(this,e);this.tours=t.tours;this.initGuides(t)}babelHelpers.createClass(e,[{key:"initGuides",value:function e(t){if(this.tours.firstProjectCreation.show){this.firstProjectCreationTourGuide=new R(t);this.firstProjectCreationTourGuide.start()}}}]);return e}();var j=function(){function e(t){babelHelpers.classCallCheck(this,e);this.membersPopup=new y(t);this.filter=new l(t);this.tourGuideController=new E(t);t.filter=this.filter;c.setOptions(t);this.initPull(t)}babelHelpers.createClass(e,[{key:"initPull",value:function e(n){this.pullController=new w(n);this.pullClient=t.PULL;this.pullClient.subscribe(this.pullController)}},{key:"getMembersPopup",value:function e(){return this.membersPopup}},{key:"getFilter",value:function e(){return this.filter}}]);return e}();e.Controller=j;e.ActionsController=c})(this.BX.Tasks.Projects=this.BX.Tasks.Projects||{},BX,BX,BX.Main,BX.Event,BX.UI.Tour,BX);
//# sourceMappingURL=script.map.js