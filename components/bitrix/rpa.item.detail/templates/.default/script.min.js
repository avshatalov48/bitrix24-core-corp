(function(e,t,a,i,n,s,r,l,o,d){"use strict";var m=t.Reflection.namespace("BX.Rpa");var c=1e3;var u=function(){function e(a){babelHelpers.classCallCheck(this,e);this.eventIds=new Set;this.completedTasks=new Set;this.overlay=BX.create("div",{attrs:{className:"rpa-entity-overlay"}});this.currentUrl=new t.Uri(location.href);if(t.Type.isPlainObject(a)){this.id=t.Text.toInteger(a.id);this.typeId=t.Text.toInteger(a.typeId);if(t.Type.isString(a.containerId)){this.container=document.getElementById(a.containerId)}if(t.Type.isArray(a.stages)){this.stages=a.stages}if(t.Type.isPlainObject(a.item)){this.item=a.item}if(t.Type.isString(a.itemUpdatedPullTag)){this.itemUpdatedPullTag=a.itemUpdatedPullTag}if(t.Type.isString(a.timelinePullTag)){this.timelinePullTag=a.timelinePullTag}if(t.Type.isString(a.taskCountersPullTag)){this.taskCountersPullTag=a.taskCountersPullTag}if(t.Type.isString(a.editorId)){this.editorId=a.editorId;this.editor=BX.UI.EntityEditor.get(this.editorId)}if(a.stream instanceof l.Timeline.Stream){this.stream=a.stream}}}babelHelpers.createClass(e,[{key:"init",value:function e(){this.initStageFlow();this.initTabs();this.initPull();this.bindEvents();if(this.id<=0){this.container.appendChild(this.overlay)}}},{key:"initStageFlow",value:function e(){if(this.container&&this.stages&&this.item){var a=this.container.querySelector('[data-role="stageflow-wrap"]');if(a){this.stageflowChart=new n.StageFlow.Chart({backgroundColor:"d3d7dc",currentStage:this.item.stageId,isActive:this.item.id>0&&this.item.permissions.draggable,onStageChange:this.handleStageChange.bind(this),labels:{finalStageName:t.Loc.getMessage("RPA_ITEM_DETAIL_FINAL_STAGE_NAME"),finalStagePopupTitle:t.Loc.getMessage("RPA_ITEM_DETAIL_FINAL_STAGE_POPUP_TITLE"),finalStagePopupFail:t.Loc.getMessage("RPA_ITEM_DETAIL_FINAL_STAGE_POPUP_FAIL"),finalStageSelectorTitle:t.Loc.getMessage("RPA_ITEM_DETAIL_FINAL_STAGE_SELECTOR_TITLE")}},this.stages);a.appendChild(this.stageflowChart.render())}}}},{key:"initTabs",value:function e(){var a=this;if(this.container){var i=this.container.querySelector('[data-role="tab-menu"]');if(i){var n=i.querySelectorAll(".rpa-item-detail-tabs-item");if(n){n.forEach(function(e){t.Event.bind(e,"click",function(){a.handleTabClick(e)})})}}}}},{key:"initPull",value:function e(){var a=this;t.Event.ready(function(){var e=BX.PULL;if(!e){console.error("pull is not initialized");return}if(a.itemUpdatedPullTag){e.subscribe({moduleId:"rpa",command:a.itemUpdatedPullTag,callback:a.handlePullItemUpdated.bind(a)});e.extendWatch(a.itemUpdatedPullTag)}if(a.timelinePullTag){e.subscribe({moduleId:"rpa",command:a.timelinePullTag,callback:a.handlePullTimelineEvent.bind(a)});e.extendWatch(a.timelinePullTag)}if(a.taskCountersPullTag){e.subscribe({moduleId:"rpa",command:a.taskCountersPullTag,callback:a.handlePullTasksCounters.bind(a)});e.extendWatch(a.taskCountersPullTag)}})}},{key:"handlePullItemUpdated",value:function e(a){if(t.Type.isString(a.eventId)&&a.eventId.length>0&&this.eventIds.has(a.eventId)){return}if(t.Type.isPlainObject(a.item)){if(a.item.stageId!==this.item.stageId){this.item.stageId=a.item.stageId;this.stageflowChart.setCurrentStageId(this.item.stageId);this.reloadTasks()}}if(t.Type.isArray(a.itemChangedUserFieldNames)&&a.itemChangedUserFieldNames.length){this.handleItemExternalUpdate()}}},{key:"handleItemExternalUpdate",value:function e(){var a=BX.getClass("BX.SidePanel.Instance");if(!this.editor||!a){return}var i=a.getSliderByWindow(window);if(this.editor.getMode()===BX.UI.EntityEditorMode.edit){d.MessageBox.show({message:t.Loc.getMessage("RPA_ITEM_DETAIL_ITEM_EXTERNAL_UPDATE_NOTIFY"),modal:true,buttons:d.MessageBoxButtons.OK_CANCEL,onOk:function e(t){i.reload();t.close()}})}else{i.reload()}}},{key:"handleTabClick",value:function e(t){if(!t.classList.contains("rpa-item-detail-tabs-item-current")){var a=this.container.querySelectorAll(".rpa-item-detail-tabs-item");if(a){a.forEach(function(e){e.classList.remove("rpa-item-detail-tabs-item-current")})}t.classList.add("rpa-item-detail-tabs-item-current");var i=t.dataset.tabId;var n=this.container.querySelectorAll(".rpa-item-detail-tab-content");n.forEach(function(e){if(i&&e.dataset.tabContent&&e.dataset.tabContent===i){e.classList.remove("rpa-item-detail-tab-content-hidden")}else{e.classList.add("rpa-item-detail-tab-content-hidden")}})}}},{key:"handleStageChange",value:function e(a){var i=this;if(this.isProgress()){return}this.startProgress();this.progress=false;var n=t.Text.getRandom();this.eventIds.add(n);t.ajax.runAction("rpa.item.update",{analyticsLabel:"rpaItemDetailUpdateStage",data:{id:this.item.id,typeId:this.item.typeId,fields:{stageId:a.getId()},eventId:n}}).then(function(e){i.stopProgress();i.item=e.data.item;i.stageflowChart.setCurrentStageId(e.data.item.stageId);i.stageflowChart.render()}).catch(function(e){i.stopProgress();var t=false;e.errors.forEach(function(e){if(e.code&&e.code==="RPA_ITEM_USER_HAS_TASKS"){t=true}else{BX.UI.Notification.Center.notify({content:e.message})}});if(t){s.Manager.Instance.openTasks(i.item.typeId,i.item.id)}})}},{key:"getLoader",value:function e(){if(!this.loader){this.loader=new i.Loader({size:200})}return this.loader}},{key:"startProgress",value:function e(){this.progress=true;if(!this.getLoader().isShown()){this.getLoader().show(this.container)}}},{key:"stopProgress",value:function e(){this.progress=false;if(this.getLoader().isShown()){this.getLoader().hide()}}},{key:"isProgress",value:function e(){return this.progress===true}},{key:"showErrors",value:function e(t){}},{key:"handlePullTimelineEvent",value:function e(a){if(!t.Type.isPlainObject(a)){return}if(t.Type.isString(a.eventId)&&a.eventId.length>0&&this.eventIds.has(a.eventId)){return}if(a.command==="add"){this.handlePullTimelineAdd(a)}else if(a.command==="update"){this.handlePullTimelineUpdate(a)}else if(a.command==="pin"){this.handlePullTimelinePin(a)}else if(a.command==="delete"){this.handlePullTimelineDelete(a)}}},{key:"handlePullTimelineAdd",value:function e(a){var i=a.timeline;if(!i){i=a.comment}if(t.Type.isPlainObject(i)){this.stream.addUsers(i.users);var n=this.stream.createItem(i);if(n instanceof r.Timeline.TaskComplete){if(this.completedTasks.has(n.data.task.ID)){return}this.reloadTasks()}if(n){this.stream.insertItem(n)}}}},{key:"handlePullTimelinePin",value:function e(a){if(t.Type.isPlainObject(a.timeline)){var i=this.stream.getItem(a.timeline.id);i.isFixed=a.timeline.isFixed;i.renderPin();if(i.isFixed){this.stream.pinItem(i)}else{this.stream.unPinItem(i)}}}},{key:"handlePullTimelineDelete",value:function e(t){if(t&&t.timeline&&t.timeline.id>0){var a=this.stream.getItem(t.timeline.id);if(a){this.stream.deleteItem(a)}}}},{key:"handlePullTimelineUpdate",value:function e(t){if(t&&t.timeline&&t.timeline.id>0){var a=this.stream.getItem(t.timeline.id);if(a){a.update(t.timeline)}a=this.stream.getPinnedItem(t.timeline.id);if(a){a.update(t.timeline)}}}},{key:"handlePullTasksCounters",value:function e(t){if(t.typeId===this.typeId&&t.itemId===this.id){this.reloadTasks()}}},{key:"reloadTasks",value:function e(){var a=this;if(this.isProgress()){return}if(this.reloadTasksTimeoutId){return}this.reloadTasksTimeoutId=setTimeout(function(){a.startProgress();t.ajax.runAction("rpa.item.getTasks",{analyticsLabel:"rpaItemTimelineGetTasks",data:{typeId:a.typeId,id:a.id}}).then(function(e){a.stopProgress();a.reloadTasksTimeoutId=null;if(t.Type.isArray(e.data.tasks)){a.stream.updateTasks(e.data.tasks)}}).catch(function(){a.reloadTasksTimeoutId=null;a.stopProgress()})},c)}},{key:"bindEvents",value:function e(){var i=this;t.Event.ready(function(){a.EventEmitter.subscribe("BX.UI.EntityEditor:onSave",function(e){if(t.Type.isArray(e.getData())){var a=e.getData()[0];if(a._ajaxForm&&t.Type.isFunction(a._ajaxForm.addUrlParams)){var n=t.Text.getRandom();i.eventIds.add(n);a._ajaxForm.addUrlParams({eventId:n})}}});if(!i.item.id){a.EventEmitter.subscribe("BX.UI.EntityEditorAjax:onSubmit",function(e){var a=e.getData();if(t.Type.isArray(a)){var n=a[1];if(n&&n.data&&n.data.item){var r=s.Manager.Instance.getItemDetailUrl(i.typeId,n.data.item.id);if(r){var l=i.currentUrl.getQueryParams(),o=l.IFRAME,d=l.IFRAME_TYPE;var m=o==="Y"&&d==="SIDE_SLIDER";if(m){r.setQueryParams({IFRAME:"Y",IFRAME_TYPE:"SIDE_SLIDER"})}location.href=r.toString()}}}})}i.stream.subscribe("onScrollToTheBottom",i.loadItems.bind(i));i.stream.subscribe("onPinClick",i.handleItemPinClick.bind(i));a.EventEmitter.subscribe("BX.UI.Timeline.CommentEditor:onLoadVisualEditor",function(e){return new Promise(function(a,i){t.ajax.runAction("rpa.comment.getVisualEditor",{analyticsLabel:"rpaTimelineCommentLoadVisualEditor",data:{name:e.getData().name,commentId:e.getData().commentId}}).then(function(t){e.getData().html=t.data.html;a()}).catch(function(){i()})})});a.EventEmitter.subscribe("BX.UI.Timeline.CommentEditor:onSave",function(e){return new Promise(function(a,n){var s=t.Text.getRandom();i.eventIds.add(s);var r="rpaTimelineCommentAdd";var l="rpa.comment.add";var o={typeId:i.typeId,itemId:i.id,fields:{description:e.getData().description,files:e.getData().files},eventId:s};var d=t.Text.toInteger(e.getData().commentId);if(d>0){l="rpa.comment.update";o.id=d;r="rpaTimelineCommentUpdate"}t.ajax.runAction(l,{analyticsLabel:r,data:o}).then(function(t){e.getData().comment=t.data.comment;if(d<=0){if(t.data&&t.data.comment){i.stream.addUsers(t.data.comment.users);var n=i.stream.createItem(t.data.comment);if(n){i.stream.insertItem(n)}}}else{var s=i.stream.createItem(t.data.comment);var r=i.stream.getItem(s.getId());if(r){r.update(t.data.comment)}var l=i.stream.getPinnedItem(s.getId());if(l){l.update(t.data.comment)}}a()}).catch(function(t){e.getData().message=t.errors.map(function(e){var t=e.message;return t}).join("; ");n()})})});a.EventEmitter.subscribe("BX.UI.Timeline.Comment:onLoadContent",function(e){return new Promise(function(a,i){var n=t.Text.toInteger(e.getData().commentId);if(!n){i();return}t.ajax.runAction("rpa.comment.get",{analyticsLabel:"rpaTimelineCommentGetContent",data:{id:n}}).then(function(t){if(t.data&&t.data.comment){e.getData().comment=t.data.comment;a()}else{i()}}).catch(function(t){e.getData().message=t.errors.map(function(e){var t=e.message;return t}).join("; ");i()})})});a.EventEmitter.subscribe("BX.UI.Timeline.Comment:onLoadFilesContent",function(e){return new Promise(function(a,i){var n=t.Text.toInteger(e.getData().commentId);if(!n){i();return}t.ajax.runAction("rpa.comment.getFilesContent",{analyticsLabel:"rpaTimelineCommentGetFilesContent",data:{id:n}}).then(function(n){if(n.data&&t.Type.isString(n.data.html)&&n.data.html.length>0){e.getData().html=n.data.html;a()}else{i()}}).catch(function(t){e.getData().message=t.errors.map(function(e){var t=e.message;return t}).join("; ");i()})})});a.EventEmitter.subscribe("BX.UI.Timeline.Comment:onDelete",function(e){return new Promise(function(a,n){var s=t.Text.toInteger(e.getData().commentId);if(!s){n();return}var r=t.Text.getRandom();i.eventIds.add(r);t.ajax.runAction("rpa.comment.delete",{analyticsLabel:"rpaTimelineCommentDelete",data:{id:s,eventId:r}}).then(function(){a()}).catch(function(t){e.getData().message=t.errors.map(function(e){var t=e.message;return t}).join("; ");n()})})});a.EventEmitter.subscribe("BX.Rpa.Timeline.Task:onBeforeCompleteTask",function(e){i.completedTasks.add(e.getData().taskId)})})}},{key:"loadItems",value:function e(){var a=this;if(this.isProgress()){return}this.startProgress();this.stream.currentPage++;t.ajax.runAction("rpa.timeline.listForItem",{analyticsLabel:"rpaItemDetailTimelineLoadOnScroll",data:{typeId:this.typeId,itemId:this.id},navigation:{page:this.stream.currentPage,size:this.stream.pageSize}}).then(function(e){a.stopProgress();var i=e.data.timeline;if(t.Type.isArray(i)){if(i.length<=0){a.stream.disableLoadOnScroll()}else{i.forEach(function(e){var t=a.stream.createItem(e);if(t){a.stream.addItem(t)}});a.stream.renderItems()}}else{a.stream.disableLoadOnScroll()}}).catch(function(){a.stopProgress();a.stream.disableLoadOnScroll()})}},{key:"handleItemPinClick",value:function e(a){var i=a.getData().item;if(i instanceof l.Timeline.Item){t.ajax.runAction("rpa.timeline.updateIsFixed",{analyticsLabel:"rpaTimelinePinClick",data:{id:i.getId(),isFixed:i.isFixed?"y":"n",eventId:this.registerRandomEventId()}})}}},{key:"registerRandomEventId",value:function e(){var a=t.Text.getRandom();this.eventIds.add(a);return a}}]);return e}();m.ItemDetailComponent=u})(this.window=this.window||{},BX,BX.Event,BX,BX.UI,BX.Rpa,BX.Rpa,BX.UI,BX,BX.UI.Dialogs);
//# sourceMappingURL=script.map.js