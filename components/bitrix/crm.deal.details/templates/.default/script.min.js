this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,n,i){"use strict";function a(e,t){s(e,t);t.add(e)}function r(e,t,n){s(e,t);t.set(e,n)}function s(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function l(e,t,n){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return n}var o=new WeakMap;var c=new WeakMap;var u=new WeakMap;var v=new WeakMap;var b=new WeakMap;var d=new WeakSet;var E=new WeakSet;var h=new WeakSet;var g=new WeakSet;var p=new WeakSet;var f=new WeakSet;var T=new WeakSet;var m=new WeakSet;var _=new WeakSet;var M=new WeakSet;var w=function(){babelHelpers.createClass(e,null,[{key:"productsTabId",get:function e(){return"tab_products"}}]);function e(t){babelHelpers.classCallCheck(this,e);a(this,M);a(this,_);a(this,m);a(this,T);a(this,f);a(this,p);a(this,g);a(this,h);a(this,E);a(this,d);r(this,o,{writable:true,value:void 0});r(this,c,{writable:true,value:void 0});r(this,u,{writable:true,value:void 0});r(this,v,{writable:true,value:void 0});r(this,b,{writable:true,value:null});babelHelpers.classPrivateFieldSet(this,o,t.onboardingData);babelHelpers.classPrivateFieldSet(this,c,t.contentContainer);babelHelpers.classPrivateFieldSet(this,u,t.serviceUrl);babelHelpers.classPrivateFieldSet(this,v,t.dealDetailManager)}babelHelpers.createClass(e,[{key:"processOnboarding",value:function e(){var t=babelHelpers.classPrivateFieldGet(this,o).chain;var n=babelHelpers.classPrivateFieldGet(this,o).chainStep;var i=babelHelpers.classPrivateFieldGet(this,o).successDealGuideIsOver;if(t===0){if(n<1){l(this,h,D).call(this)}if(n<2){l(this,T,O).call(this)}}else if(t===1&&n===0){l(this,m,k).call(this)}if(!i){l(this,_,y).call(this)}}}]);return e}();function S(){return babelHelpers.classPrivateFieldGet(this,c)}function C(){return l(this,d,S).call(this).querySelector(".main-buttons")}function D(){var e={title:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_AUTOMATIC_RESERVATION_GUIDE_TITLE"),text:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_AUTOMATIC_RESERVATION_GUIDE_TEXT")};if(babelHelpers.classPrivateFieldGet(this,v).isTabButtonVisible(w.productsTabId)){l(this,p,A).call(this)}else{l(this,f,H).call(this)}}function I(e){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a={title:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_AUTOMATIC_RESERVATION_GUIDE_TITLE"),text:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_AUTOMATIC_RESERVATION_GUIDE_TEXT")};return new i.Guide({steps:[{target:e,title:a.title,text:a.text,position:"bottom",events:n}],onEvents:true})}function A(){var e=this;var n=babelHelpers.classPrivateFieldGet(this,v).getTabMenuItemContainer(w.productsTabId);var i=l(this,g,I).call(this,n,{onClose:function e(){t.userOptions.save("crm","warehouse-onboarding","firstChainStage",1)}});i.showNextStep();var a=babelHelpers.classPrivateFieldGet(this,v).getTabManager().getTabMenuContainer();var r=function n(){if(!babelHelpers.classPrivateFieldGet(e,v).isTabButtonVisible(w.productsTabId)){i.close();t.Event.unbind(window,"resize",n)}};t.Event.bind(window,"resize",r);t.Event.bindOnce(a,"mousedown",(function(){i.close();t.Event.unbind(window,"resize",r)}))}function H(){var e=this;var i=babelHelpers.classPrivateFieldGet(this,v).getTabManager().getMoreButton();var a=new BX.SpotLight({id:"".concat(w.productsTabId,"_spotlight"),targetElement:i,autoSave:true,targetVertex:"middle-center",zIndex:200});a.show();a.container.style.pointerEvents="none";var r=function i(r){var o=r.target.getMoreMenu();var c=babelHelpers.classPrivateFieldGet(e,v).getTabManager().getMoreMenu();if(o===c){a.close();var u=l(e,g,I).call(e,babelHelpers.classPrivateFieldGet(e,v).getTabFromMoreMenu(w.productsTabId));var b=o.getMenuContainer();var d=setTimeout((function(){u.showNextStep();BX.bindOnce(b,"click",h);var e=u.getPopup();n.EventEmitter.subscribeOnce(e,"onClose",E);var i=u.getPopup().getContentContainer().parentNode;BX.bind(i,"mouseenter",(function(){r.target.showMoreMenu()}));BX.bind(i,"mouseleave",(function(){var e=setTimeout((function(){r.target.closeMoreMenu()}),300);t.Event.bindOnce(c.getMenuContainer(),"mouseenter",(function(){clearTimeout(e)}))}))}),50);var E=function e(a){t.userOptions.save("crm","warehouse-onboarding","firstChainStage",1);t.Event.unbind(window,"resize",s);t.Event.unbind(b,"click",h);n.EventEmitter.unsubscribe("BX.Main.InterfaceButtons:onMoreMenuShow",i)};var h=function e(){t.userOptions.save("crm","warehouse-onboarding","firstChainStage",1);u.close()};t.Event.bind(c.getMenuContainer(),"click",E);n.EventEmitter.subscribeOnce("BX.Main.InterfaceButtons:onMoreMenuClose",(function(n){var i=n.target.getMoreMenu();var a=babelHelpers.classPrivateFieldGet(e,v).getTabManager().getMoreMenu();if(i===a){clearTimeout(d);t.Event.unbind(b,"click",h);u.close()}}))}};n.EventEmitter.subscribe("BX.Main.InterfaceButtons:onMoreMenuShow",r);var s=function i(){if(babelHelpers.classPrivateFieldGet(e,v).isTabButtonVisible(w.productsTabId)){a.close();l(e,p,A).call(e);t.Event.unbind(window,"resize",i);n.EventEmitter.unsubscribe("BX.Main.InterfaceButtons:onMoreMenuShow",r)}};t.Event.bind(window,"resize",s)}function O(){var e=this;var i=l(this,d,S).call(this).querySelector(".main-buttons");var a=function a(r){var s=babelHelpers.slicedToArray(r.data,1),l=s[0];var o=function e(){var n=l.getActiveHint();if(n!==null){n.close();t.Event.unbind(i,"click",e)}};t.Event.bind(i,"click",o);var c=l.products;var v="";if(c instanceof Array){var b=c.find((function(e){return!e.getModel().isService()}));if(b){v=b.getId()}}if(!v){return}l.showFieldTourHint("STORE_INFO",{title:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_PRODUCT_STORE_GUIDE_TITLE"),text:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_PRODUCT_STORE_GUIDE_TEXT")},(function(){t.userOptions.save("crm","warehouse-onboarding","firstChainStage",2);BX.ajax.post(babelHelpers.classPrivateFieldGet(e,u),{ACTION:"FIX_FIRST_ONBOARD_CHAIN_VIEW"});t.Event.unbind(i,"click",o);n.EventEmitter.unsubscribe("onDemandRecalculateWrapper",a)}),["RESERVE_INFO"],v)};n.EventEmitter.subscribe("onDemandRecalculateWrapper",a)}function k(){var e=this;var a=function a(r){if(babelHelpers.classPrivateFieldGet(e,b)!==null){babelHelpers.classPrivateFieldGet(e,b).close()}var s=l(e,E,C).call(e);var o=document.querySelector('[data-cid="OPPORTUNITY_WITH_CURRENCY"]');var c=o&&o.querySelector(".crm-entity-widget-payment-add-box");if(c!==null){var u=o.querySelector(".ui-entity-editor-block-context-menu");var v=o.querySelector(".ui-entity-editor-draggable-btn");var d={title:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_ADD_DOCUMENT_GUIDE_TITLE"),text:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_ADD_DOCUMENT_GUIDE_TEXT")};var h=new i.Guide({steps:[{target:c,title:d.title,text:d.text,events:{onClose:function e(){t.Event.unbind(s,"click",g);t.Event.unbind(u,"click",g);t.Event.unbind(v,"mousedown",g)}}}],onEvents:true});babelHelpers.classPrivateFieldSet(e,b,h);var g=function e(){t.Event.unbind(s,"click",e);n.EventEmitter.unsubscribe("PaymentDocuments.EntityEditor:changeDocuments",a);h.close();t.userOptions.save("crm","warehouse-onboarding","secondChainStage",1)};h.showNextStep();t.Event.bind(h.getPopup().closeIcon,"click",g);t.Event.bind(s,"click",g);t.Event.bind(c,"click",g);t.Event.bind(u,"click",g);t.Event.bind(v,"mousedown",g)}};n.EventEmitter.subscribe("PaymentDocuments.EntityEditor:changeDocuments",a)}function y(){var e=this;var i=function i(a){if(a.data[1].currentStepId==="WON"&&a.data[1].currentSemantics==="success"){n.EventEmitter.unsubscribe("Crm.EntityProgress.Saved",i);var r=function i(a){n.EventEmitter.unsubscribe("BX.Crm.Timeline.Items.FinalSummaryDocuments:onHistoryNodeAdded",i);BX.onCustomEvent(window,"OpenEntityDetailTab",["main"]);var r=babelHelpers.slicedToArray(a.data,1),s=r[0];var o={x:0,y:0};var c=setInterval((function(){var n=s.querySelector(".crm-entity-stream-content-document-description");if(n===null){return}var i=t.Dom.getPosition(n);if(i.x===0&&i.y===0){return}if(i.x!==o.x||i.y!==o.y){o.x=i.x;o.y=i.y;return}clearInterval(c);var a=l(e,M,P).call(e,n,{onClose:function e(){t.userOptions.save("crm","warehouse-onboarding","successDealGuideIsOver",true);v()}});var r=l(e,d,S).call(e);var u=l(e,E,C).call(e);var v=function e(){t.Event.unbind(r,"click",a.close.bind(a));t.Event.unbind(u,"click",a.close.bind(a))};window.scrollTo(0,i.y-250);a.showNextStep();t.Event.bind(u,"click",a.close.bind(a));setTimeout((function(){t.Event.bind(r,"click",a.close.bind(a))}),3e3)}),100)};n.EventEmitter.subscribe("BX.Crm.Timeline.Items.FinalSummaryDocuments:onHistoryNodeAdded",r)}};n.EventEmitter.subscribe("Crm.EntityProgress.Saved",i)}function P(e){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a={title:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_SUCCESS_DEAL_GUIDE_TITLE"),text:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_SUCCESS_DEAL_GUIDE_TEXT")};return new i.Guide({steps:[{target:e,title:a.title,text:a.text,position:"bottom",events:n}],onEvents:true})}function R(e,t,n){F(e,t);t.set(e,n)}function F(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var L=new WeakMap;var G=new WeakMap;var U=new WeakMap;var W=new WeakMap;var B=function(){function e(n){babelHelpers.classCallCheck(this,e);R(this,L,{writable:true,value:void 0});R(this,G,{writable:true,value:void 0});R(this,U,{writable:true,value:null});R(this,W,{writable:true,value:new t.Cache.MemoryCache});babelHelpers.classPrivateFieldSet(this,L,n.guid);babelHelpers.classPrivateFieldSet(this,G,BX.Crm.EntityDetailManager.get(babelHelpers.classPrivateFieldGet(this,L)))}babelHelpers.createClass(e,[{key:"getContainer",value:function e(){var t=this;return babelHelpers.classPrivateFieldGet(this,W).remember("container",(function(){return document.getElementById(babelHelpers.classPrivateFieldGet(t,L)+"_container")}))}},{key:"getDealDetailManager",value:function e(){return babelHelpers.classPrivateFieldGet(this,G)}},{key:"enableOnboardingChain",value:function e(t,n){if(babelHelpers.classPrivateFieldGet(this,U)===null&&this.getDealDetailManager()!==null){babelHelpers.classPrivateFieldSet(this,U,new w({onboardingData:t,contentContainer:this.getContainer(),serviceUrl:n,dealDetailManager:this.getDealDetailManager()}));babelHelpers.classPrivateFieldGet(this,U).processOnboarding()}}}]);return e}();e.DealManager=B})(this.BX.Crm.Deal=this.BX.Crm.Deal||{},BX,BX.Event,BX.UI.Tour);
//# sourceMappingURL=script.map.js