this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,n,i,a,r){"use strict";function s(e,t){o(e,t);t.add(e)}function l(e,t,n){o(e,t);t.set(e,n)}function o(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function c(e,t,n){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return n}var u=new WeakMap;var v=new WeakMap;var b=new WeakMap;var d=new WeakMap;var E=new WeakMap;var h=new WeakSet;var p=new WeakSet;var g=new WeakSet;var f=new WeakSet;var T=new WeakSet;var m=new WeakSet;var M=new WeakSet;var w=new WeakSet;var _=new WeakSet;var S=new WeakSet;var C=new WeakSet;var D=function(){babelHelpers.createClass(e,null,[{key:"productsTabId",get:function e(){return"tab_products"}}]);function e(t){babelHelpers.classCallCheck(this,e);s(this,C);s(this,S);s(this,_);s(this,w);s(this,M);s(this,m);s(this,T);s(this,f);s(this,g);s(this,p);s(this,h);l(this,u,{writable:true,value:void 0});l(this,v,{writable:true,value:void 0});l(this,b,{writable:true,value:void 0});l(this,d,{writable:true,value:void 0});l(this,E,{writable:true,value:null});babelHelpers.classPrivateFieldSet(this,u,t.onboardingData);babelHelpers.classPrivateFieldSet(this,v,t.contentContainer);babelHelpers.classPrivateFieldSet(this,b,t.serviceUrl);babelHelpers.classPrivateFieldSet(this,d,t.dealDetailManager)}babelHelpers.createClass(e,[{key:"processOnboarding",value:function e(){if(!c(this,g,H).call(this)){return}var t=babelHelpers.classPrivateFieldGet(this,u).chain;var n=babelHelpers.classPrivateFieldGet(this,u).chainStep;var i=babelHelpers.classPrivateFieldGet(this,u).successDealGuideIsOver;if(t===0){if(n<1){c(this,f,O).call(this)}if(n<2){c(this,w,R).call(this)}}else if(t===1&&n===0){c(this,_,F).call(this)}if(!i){c(this,S,L).call(this)}}}]);return e}();function I(){return babelHelpers.classPrivateFieldGet(this,v)}function A(){return c(this,h,I).call(this).querySelector(".main-buttons")}function H(){if(r.PopupWindowManager&&r.PopupWindowManager.isAnyPopupShown()){return false}return true}function O(){var e={title:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_AUTOMATIC_RESERVATION_GUIDE_TITLE"),text:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_AUTOMATIC_RESERVATION_GUIDE_TEXT")};if(babelHelpers.classPrivateFieldGet(this,d).isTabButtonVisible(D.productsTabId)){c(this,m,y).call(this)}else{c(this,M,P).call(this)}}function k(e){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a={title:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_AUTOMATIC_RESERVATION_GUIDE_TITLE"),text:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_AUTOMATIC_RESERVATION_GUIDE_TEXT")};return new i.Guide({steps:[{target:e,title:a.title,text:a.text,position:"bottom",events:n}],onEvents:true})}function y(){var e=this;var n=babelHelpers.classPrivateFieldGet(this,d).getTabMenuItemContainer(D.productsTabId);var i=c(this,T,k).call(this,n,{onClose:function e(){t.userOptions.save("crm","warehouse-onboarding","firstChainStage",1)}});i.showNextStep();var a=babelHelpers.classPrivateFieldGet(this,d).getTabManager().getTabMenuContainer();var r=function n(){if(!babelHelpers.classPrivateFieldGet(e,d).isTabButtonVisible(D.productsTabId)){i.close();t.Event.unbind(window,"resize",n)}};t.Event.bind(window,"resize",r);t.Event.bindOnce(a,"mousedown",(function(){i.close();t.Event.unbind(window,"resize",r)}))}function P(){var e=this;var i=babelHelpers.classPrivateFieldGet(this,d).getTabManager().getMoreButton();var a=new BX.SpotLight({id:"".concat(D.productsTabId,"_spotlight"),targetElement:i,autoSave:true,targetVertex:"middle-center",zIndex:200});a.show();a.container.style.pointerEvents="none";var r=function i(r){var l=r.target.getMoreMenu();var o=babelHelpers.classPrivateFieldGet(e,d).getTabManager().getMoreMenu();if(l===o){a.close();var u=c(e,T,k).call(e,babelHelpers.classPrivateFieldGet(e,d).getTabFromMoreMenu(D.productsTabId));var v=l.getMenuContainer();var b=setTimeout((function(){u.showNextStep();BX.bindOnce(v,"click",h);var e=u.getPopup();n.EventEmitter.subscribeOnce(e,"onClose",E);var i=u.getPopup().getContentContainer().parentNode;BX.bind(i,"mouseenter",(function(){r.target.showMoreMenu()}));BX.bind(i,"mouseleave",(function(){var e=setTimeout((function(){r.target.closeMoreMenu()}),300);t.Event.bindOnce(o.getMenuContainer(),"mouseenter",(function(){clearTimeout(e)}))}))}),50);var E=function e(a){t.userOptions.save("crm","warehouse-onboarding","firstChainStage",1);t.Event.unbind(window,"resize",s);t.Event.unbind(v,"click",h);n.EventEmitter.unsubscribe("BX.Main.InterfaceButtons:onMoreMenuShow",i)};var h=function e(){t.userOptions.save("crm","warehouse-onboarding","firstChainStage",1);u.close()};t.Event.bind(o.getMenuContainer(),"click",E);n.EventEmitter.subscribeOnce("BX.Main.InterfaceButtons:onMoreMenuClose",(function(n){var i=n.target.getMoreMenu();var a=babelHelpers.classPrivateFieldGet(e,d).getTabManager().getMoreMenu();if(i===a){clearTimeout(b);t.Event.unbind(v,"click",h);u.close()}}))}};n.EventEmitter.subscribe("BX.Main.InterfaceButtons:onMoreMenuShow",r);var s=function i(){if(babelHelpers.classPrivateFieldGet(e,d).isTabButtonVisible(D.productsTabId)){a.close();c(e,m,y).call(e);t.Event.unbind(window,"resize",i);n.EventEmitter.unsubscribe("BX.Main.InterfaceButtons:onMoreMenuShow",r)}};t.Event.bind(window,"resize",s)}function R(){var e=this;var i=c(this,h,I).call(this).querySelector(".main-buttons");var a=function a(r){var s=babelHelpers.slicedToArray(r.data,1),l=s[0];var o=function e(){var n=l.getActiveHint();if(n!==null){n.close();t.Event.unbind(i,"click",e)}};t.Event.bind(i,"click",o);var c=l.products;var u="";if(c instanceof Array){var v=c.find((function(e){return!e.getModel().isService()}));if(v){u=v.getId()}}if(!u){return}l.showFieldTourHint("STORE_INFO",{title:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_PRODUCT_STORE_GUIDE_TITLE"),text:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_PRODUCT_STORE_GUIDE_TEXT")},(function(){t.userOptions.save("crm","warehouse-onboarding","firstChainStage",2);BX.ajax.post(babelHelpers.classPrivateFieldGet(e,b),{ACTION:"FIX_FIRST_ONBOARD_CHAIN_VIEW"});t.Event.unbind(i,"click",o);n.EventEmitter.unsubscribe("onDemandRecalculateWrapper",a)}),["RESERVE_INFO"],u)};n.EventEmitter.subscribe("onDemandRecalculateWrapper",a)}function F(){var e=this;var a=function a(r){if(babelHelpers.classPrivateFieldGet(e,E)!==null){babelHelpers.classPrivateFieldGet(e,E).close()}var s=c(e,p,A).call(e);var l=document.querySelector('[data-cid="OPPORTUNITY_WITH_CURRENCY"]');var o=l&&l.querySelector(".crm-entity-widget-payment-add-box");if(o!==null){var u=l.querySelector(".ui-entity-editor-block-context-menu");var v=l.querySelector(".ui-entity-editor-draggable-btn");var b={title:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_ADD_DOCUMENT_GUIDE_TITLE"),text:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_ADD_DOCUMENT_GUIDE_TEXT")};var d=new i.Guide({steps:[{target:o,title:b.title,text:b.text,events:{onClose:function e(){t.Event.unbind(s,"click",h);t.Event.unbind(u,"click",h);t.Event.unbind(v,"mousedown",h)}}}],onEvents:true});babelHelpers.classPrivateFieldSet(e,E,d);var h=function e(){t.Event.unbind(s,"click",e);n.EventEmitter.unsubscribe("PaymentDocuments.EntityEditor:changeDocuments",a);d.close();t.userOptions.save("crm","warehouse-onboarding","secondChainStage",1)};d.showNextStep();t.Event.bind(d.getPopup().closeIcon,"click",h);t.Event.bind(s,"click",h);t.Event.bind(o,"click",h);t.Event.bind(u,"click",h);t.Event.bind(v,"mousedown",h)}};n.EventEmitter.subscribe("PaymentDocuments.EntityEditor:changeDocuments",a)}function L(){var e=this;var i=function i(a){if(a.data[1].currentStepId==="WON"&&a.data[1].currentSemantics==="success"){n.EventEmitter.unsubscribe("Crm.EntityProgress.Saved",i);var r=function i(a){n.EventEmitter.unsubscribe("BX.Crm.Timeline.Items.FinalSummaryDocuments:onHistoryNodeAdded",i);BX.onCustomEvent(window,"OpenEntityDetailTab",["main"]);var r=babelHelpers.slicedToArray(a.data,1),s=r[0];var l={x:0,y:0};var o=setInterval((function(){var n=s.querySelector(".crm-entity-stream-content-document-description");if(n===null){return}var i=t.Dom.getPosition(n);if(i.x===0&&i.y===0){return}if(i.x!==l.x||i.y!==l.y){l.x=i.x;l.y=i.y;return}clearInterval(o);var a=c(e,C,G).call(e,n,{onClose:function e(){t.userOptions.save("crm","warehouse-onboarding","successDealGuideIsOver",true);v()}});var r=c(e,h,I).call(e);var u=c(e,p,A).call(e);var v=function e(){t.Event.unbind(r,"click",a.close.bind(a));t.Event.unbind(u,"click",a.close.bind(a))};window.scrollTo(0,i.y-250);a.showNextStep();t.Event.bind(u,"click",a.close.bind(a));setTimeout((function(){t.Event.bind(r,"click",a.close.bind(a))}),3e3)}),100)};n.EventEmitter.subscribe("BX.Crm.Timeline.Items.FinalSummaryDocuments:onHistoryNodeAdded",r)}};n.EventEmitter.subscribe("Crm.EntityProgress.Saved",i)}function G(e){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a={title:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_SUCCESS_DEAL_GUIDE_TITLE"),text:t.Loc.getMessage("CRM_DEAL_DETAIL_WAREHOUSE_SUCCESS_DEAL_GUIDE_TEXT")};return new i.Guide({steps:[{target:e,title:a.title,text:a.text,position:"bottom",events:n}],onEvents:true})}function W(e,t,n){U(e,t);t.set(e,n)}function U(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var B=new WeakMap;var X=new WeakMap;var x=new WeakMap;var N=new WeakMap;var V=function(){function e(n){babelHelpers.classCallCheck(this,e);W(this,B,{writable:true,value:void 0});W(this,X,{writable:true,value:void 0});W(this,x,{writable:true,value:null});W(this,N,{writable:true,value:new t.Cache.MemoryCache});babelHelpers.classPrivateFieldSet(this,B,n.guid);babelHelpers.classPrivateFieldSet(this,X,BX.Crm.EntityDetailManager.get(babelHelpers.classPrivateFieldGet(this,B)))}babelHelpers.createClass(e,[{key:"getContainer",value:function e(){var t=this;return babelHelpers.classPrivateFieldGet(this,N).remember("container",(function(){return document.getElementById(babelHelpers.classPrivateFieldGet(t,B)+"_container")}))}},{key:"getDealDetailManager",value:function e(){return babelHelpers.classPrivateFieldGet(this,X)}},{key:"enableOnboardingChain",value:function e(t,n){if(babelHelpers.classPrivateFieldGet(this,x)===null&&this.getDealDetailManager()!==null){babelHelpers.classPrivateFieldSet(this,x,new D({onboardingData:t,contentContainer:this.getContainer(),serviceUrl:n,dealDetailManager:this.getDealDetailManager()}));babelHelpers.classPrivateFieldGet(this,x).processOnboarding()}}}]);return e}();e.DealManager=V})(this.BX.Crm.Deal=this.BX.Crm.Deal||{},BX,BX.Event,BX.UI.Tour,BX,BX.Main);
//# sourceMappingURL=script.map.js