this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(t,e,i,s,n,r,a,o,u,l,c,d){"use strict";var p=function(){function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,t);this.signedParameters=e.signedParameters?e.signedParameters:"";this.debugMode=e.debugMode}babelHelpers.createClass(t,[{key:"getSignedParameters",value:function t(){return this.signedParameters}},{key:"sendRequest",value:function t(e){var i=this;var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};return new Promise(function(t,n){c.ajax.runAction(e,{signedParameters:i.signedParameters,data:s}).then(t,n)})}},{key:"sendRequestToComponent",value:function t(){var e=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var s=arguments.length>1?arguments[1]:undefined;i.debugMode=this.debugMode;return new Promise(function(t,n){c.ajax.runComponentAction("bitrix:tasks.scrum",s,{mode:"class",signedParameters:e.signedParameters,data:i}).then(t,n)})}},{key:"batchUpdateItem",value:function t(e){return this.sendRequestToComponent(e,"batchUpdateItem")}},{key:"batchRemoveItem",value:function t(e){return this.sendRequestToComponent(e,"batchRemoveItem")}},{key:"updateItemSort",value:function t(e){return this.sendRequestToComponent(e,"updateItemSort")}},{key:"updateSprintSort",value:function t(e){return this.sendRequestToComponent(e,"updateSprintSort")}},{key:"createSprint",value:function t(e){return this.sendRequestToComponent(e,"createSprint")}},{key:"startSprint",value:function t(e){return this.sendRequestToComponent(e,"startSprint")}},{key:"completeSprint",value:function t(e){return this.sendRequestToComponent(e,"completeSprint")}},{key:"createTask",value:function t(e){return this.sendRequestToComponent(e,"createTask")}},{key:"updateItem",value:function t(e){return this.sendRequestToComponent(e,"updateItem")}},{key:"removeItem",value:function t(e){return this.sendRequestToComponent(e,"removeItem")}},{key:"changeTaskResponsible",value:function t(e){return this.sendRequestToComponent(e,"changeTaskResponsible")}},{key:"getCurrentState",value:function t(e){return this.sendRequestToComponent(e,"getCurrentState")}},{key:"hasTaskInFilter",value:function t(e){return this.sendRequestToComponent(e,"hasTaskInFilter")}},{key:"removeSprint",value:function t(e){return this.sendRequestToComponent(e,"removeSprint")}},{key:"changeSprintName",value:function t(e){return this.sendRequestToComponent(e,"changeSprintName")}},{key:"changeSprintDeadline",value:function t(e){return this.sendRequestToComponent(e,"changeSprintDeadline")}},{key:"getSprintCompletedItems",value:function t(e){return this.sendRequestToComponent(e,"getSprintCompletedItems")}},{key:"getCompletedSprints",value:function t(e){return this.sendRequestToComponent(e,"getCompletedSprints")}},{key:"getItems",value:function t(e){return this.sendRequestToComponent(e,"getItems")}},{key:"getEntityCounters",value:function t(e){return this.sendRequestToComponent(e,"getEntityCounters")}},{key:"getEpicDescriptionEditor",value:function t(e){return this.sendRequestToComponent(e,"getEpicDescriptionEditor")}},{key:"getEpicDescription",value:function t(e){return this.sendRequestToComponent(e,"getEpicDescription")}},{key:"getEpicFiles",value:function t(e){return this.sendRequestToComponent(e,"getEpicFiles")}},{key:"getAddEpicFormButtons",value:function t(e){return this.sendRequestToComponent(e,"getAddEpicFormButtons")}},{key:"getViewEpicFormButtonsAction",value:function t(e){return this.sendRequestToComponent(e,"getViewEpicFormButtons")}},{key:"createEpic",value:function t(e){return this.sendRequestToComponent(e,"createEpic")}},{key:"getEpicsList",value:function t(e){return this.sendRequestToComponent(e,"getEpicsList")}},{key:"getEpicListUrl",value:function t(){return"/bitrix/services/main/ajax.php?mode=class&c=bitrix:tasks.scrum&action=getEpicsList"}},{key:"attachFilesToTask",value:function t(e){return this.sendRequestToComponent(e,"attachFilesToTask")}},{key:"attachTagToTask",value:function t(e){return this.sendRequestToComponent(e,"attachTagToTask")}},{key:"batchAttachTagToTask",value:function t(e){return this.sendRequestToComponent(e,"batchAttachTagToTask")}},{key:"deAttachTagToTask",value:function t(e){return this.sendRequestToComponent(e,"deAttachTagToTask")}},{key:"batchDeattachTagToTask",value:function t(e){return this.sendRequestToComponent(e,"batchDeattachTagToTask")}},{key:"updateItemEpic",value:function t(e){return this.sendRequestToComponent(e,"updateItemEpic")}},{key:"batchUpdateItemEpic",value:function t(e){return this.sendRequestToComponent(e,"batchUpdateItemEpic")}},{key:"getEpic",value:function t(e){return this.sendRequestToComponent(e,"getEpic")}},{key:"editEpic",value:function t(e){return this.sendRequestToComponent(e,"editEpic")}},{key:"removeEpic",value:function t(e){return this.sendRequestToComponent(e,"removeEpic")}},{key:"applyFilter",value:function t(e){return this.sendRequestToComponent(e,"applyFilter")}},{key:"getSprintStartButtons",value:function t(e){return this.sendRequestToComponent(e,"getSprintStartButtons")}},{key:"getSprintCompleteButtons",value:function t(e){return this.sendRequestToComponent(e,"getSprintCompleteButtons")}},{key:"getBurnDownChartData",value:function t(e){return this.sendRequestToComponent(e,"getBurnDownChartData")}},{key:"getTeamSpeedChartData",value:function t(e){return this.sendRequestToComponent(e,"getTeamSpeedChartData")}},{key:"getDodSettings",value:function t(e){return this.sendRequestToComponent(e,"getDodSettings")}},{key:"getDodChecklist",value:function t(e){return this.sendRequestToComponent(e,"getDodChecklist")}},{key:"saveDodSettings",value:function t(e){return this.sendRequestToComponent(e,"saveDodSettings")}},{key:"updateBorderColorToLinkedItems",value:function t(e){return this.sendRequestToComponent(e,"updateBorderColorToLinkedItems")}},{key:"getAllUsedItemBorderColors",value:function t(e){return this.sendRequestToComponent(e,"getAllUsedItemBorderColors")}},{key:"getSubTaskItems",value:function t(e){return this.sendRequestToComponent(e,"getSubTaskItems")}},{key:"createType",value:function t(e){return this.sendRequestToComponent(e,"createType")}},{key:"changeTypeName",value:function t(e){return this.sendRequestToComponent(e,"changeTypeName")}},{key:"removeType",value:function t(e){return this.sendRequestToComponent(e,"removeType")}},{key:"showErrorAlert",value:function t(e,i){if(c.Type.isUndefined(e.errors)){console.log(e);return}if(e.errors.length){var s=e.errors.shift();if(s){var n=s.code?s.code:"";var r=s.message+" "+n;var a=i?i:c.Loc.getMessage("TASKS_SCRUM_ERROR_TITLE_POPUP");u.MessageBox.alert(r,a)}}}}]);return t}();var h=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.Filter");i.filterId=t.filterId;i.requestSender=t.requestSender;i.searchFieldApplied=false;i.initUiFilterManager();i.bindHandlers();return i}babelHelpers.createClass(e,[{key:"initUiFilterManager",value:function t(){this.filterManager=BX.Main.filterManager.getById(this.filterId)}},{key:"bindHandlers",value:function t(){d.EventEmitter.subscribe("BX.Main.Filter:apply",this.onApplyFilter.bind(this))}},{key:"isSearchFieldApplied",value:function t(){return this.searchFieldApplied}},{key:"getSearchContainer",value:function t(){return this.filterManager.getSearch().getContainer()}},{key:"getFilterManager",value:function t(){return this.filterManager}},{key:"scrollToSearchContainer",value:function t(){var e=this.getSearchContainer();if(!this.isNodeInViewport(e)){e.scrollIntoView(true)}}},{key:"onApplyFilter",value:function t(e){var i=e.getCompatData(),s=babelHelpers.slicedToArray(i,5),n=s[0],r=s[1],a=s[2],o=s[3],u=s[4];if(a.getSearch().getSearchString()){this.searchFieldApplied=true}else{this.searchFieldApplied=false}if(this.filterId!==n){return}u.autoResolve=false;this.emit("applyFilter",{promise:o})}},{key:"addItemToListTypeField",value:function t(e,i){var s=this.filterManager.getField(e);var n=this.filterManager.getFieldByName(e);if(!s||!n){return}s.options.ITEMS.push(i);n.ITEMS.push(i);var r=s.node.querySelector("[data-name="+e+"]");var a=c.Dom.attr(r,"data-items");a.push(i);c.Dom.attr(r,"data-items",a)}},{key:"setValueToField",value:function t(e){var i=this.filterManager.getApi();var s=this.filterManager.getFilterFieldsValues();s[e.name]=e.value;i.setFields(s);i.apply()}},{key:"setValuesToField",value:function t(e){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var s=this.filterManager.getApi();var n={};if(!i){n=this.filterManager.getFilterFieldsValues()}e.forEach(function(t){n[t.name]=t.value});s.setFields(n);s.apply()}},{key:"getValueFromField",value:function t(e){var i=this.filterManager.getFilterFieldsValues();return i[e.name]}},{key:"resetFilter",value:function t(){this.filterManager.resetFilter()}},{key:"applyFilter",value:function t(){this.filterManager.applyFilter()}},{key:"isNodeInViewport",value:function t(e){var i=e.getBoundingClientRect();return i.top>=0&&i.left>=0&&i.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&i.right<=(window.innerWidth||document.documentElement.clientWidth)}}]);return e}(d.EventEmitter);function m(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div id="files_chooser">\n\t\t\t<div id="diskuf-selectdialog-','" class="diskuf-files-entity diskuf-selectdialog bx-disk">\n\t\t\t\t<div class="diskuf-files-block">\n\t\t\t\t\t<div class="diskuf-placeholder">\n\t\t\t\t\t\t<table class="files-list">\n\t\t\t\t\t\t\t<tbody class="diskuf-placeholder-tbody"></tbody>\n\t\t\t\t\t\t</table>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="diskuf-extended" style="display: block">\n\t\t\t\t\t<input type="hidden" name="[','][]" value=""/>\n\t\t\t\t\t<div class="diskuf-extended-item">\n\t\t\t\t\t\t<label for="file_loader_','">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</label>\n\t\t\t\t\t\t<input class="diskuf-fileUploader" id="file_loader_','" type=\n\t\t\t\t\t\t\t"file" multiple="multiple" size="1" style="display: none"/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="diskuf-extended-item">\n\t\t\t\t\t\t<span class="diskuf-selector-link">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="diskuf-extended-item">\n\t\t\t\t\t\t<span class="diskuf-selector-link-cloud" data-bx-doc-handler="gdrive">\n\t\t\t\t\t\t\t<span>',"</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t</div>\n\t\t"]);m=function e(){return t};return t}var v=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t.setEventNamespace("BX.Tasks.Scrum.DiskManager");t.diskUrls={urlSelect:"/bitrix/tools/disk/uf.php?action=selectFile&SITE_ID="+c.Loc.getMessage("SITE_ID"),urlRenameFile:"/bitrix/tools/disk/uf.php?action=renameFile",urlDeleteFile:"/bitrix/tools/disk/uf.php?action=deleteFile",urlUpload:"/bitrix/tools/disk/uf.php?action=uploadFile&ncc=1"};t.attachedIds=[];return t}babelHelpers.createClass(e,[{key:"showAttachmentMenu",value:function t(e){var i=this;var s=c.Text.getRandom();this.popup=new l.Popup("disk-manager-attachment-menu-".concat(c.Text.getRandom()),e,{content:this.getAttachmentsLoaderContent(s),autoHide:true,closeByEsc:true,angle:false});this.popup.show();BX.Disk.UF.add({UID:s,controlName:"[".concat(s,"][]"),hideSelectDialog:false,urlSelect:this.diskUrls.urlSelect,urlRenameFile:this.diskUrls.urlRenameFile,urlDeleteFile:this.diskUrls.urlDeleteFile,urlUpload:this.diskUrls.urlUpload});BX.onCustomEvent(this.popup.contentContainer.querySelector("#files_chooser"),"DiskLoadFormController",["show"]);d.EventEmitter.subscribe("onFinish",function(){i.popup.close();i.emit("onFinish",i.attachedIds)})}},{key:"getAttachmentsLoaderContent",value:function t(e){var i=c.Tag.render(m(),e,e,e,c.Loc.getMessage("TASKS_SCRUM_FILES_LOADER_POPUP_FROM_COMPUTER"),e,c.Loc.getMessage("TASKS_SCRUM_FILES_LOADER_POPUP_FROM_B24"),c.Loc.getMessage("TASKS_SCRUM_FILES_LOADER_POPUP_FROM_CLOUD"));BX.addCustomEvent(i,"OnFileUploadSuccess",this.onFileUploadSuccess.bind(this));return i}},{key:"onFileUploadSuccess",value:function t(e,i,s,n){if(typeof s==="undefined"||typeof n==="undefined"){return}this.attachedIds.push(e.element_id.toString())}}]);return e}(d.EventEmitter);function g(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div id="','" class="tasks-scrum-actions-panel-container">\n\t\t\t\t<div class="tasks-scrum-actions-panel">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t\t","\n\t\t\t\t\t","\n\t\t\t\t\t","\n\t\t\t\t\t","\n\t\t\t\t\t","\n\t\t\t\t\t","\n\t\t\t\t\t","\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);g=function e(){return t};return t}function f(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div  id="','" class=\n\t\t\t\t\t"tasks-scrum-actions-panel-btn tasks-scrum-actions-panel-btn-remove">\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-icon"></span>\n\t\t\t\t</div>\n\t\t\t']);f=function e(){return t};return t}function b(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div  id="','" class=\n\t\t\t\t\t"tasks-scrum-actions-panel-btn tasks-scrum-actions-panel-btn-decomposition">\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-icon"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-actions-panel-separator"></div>\n\t\t\t']);b=function e(){return t};return t}function y(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div  id="','" class=\n\t\t\t\t\t"tasks-scrum-actions-panel-btn tasks-scrum-actions-panel-btn-tags">\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-icon"></span>\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-text">\n\t\t\t\t\t\t','\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-actions-panel-separator"></div>\n\t\t\t']);y=function e(){return t};return t}function k(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div  id="','" class=\n\t\t\t\t\t"tasks-scrum-actions-panel-btn tasks-scrum-actions-panel-btn-tags">\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-icon"></span>\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-text">\n\t\t\t\t\t\t','\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-actions-panel-separator"></div>\n\t\t\t']);k=function e(){return t};return t}function S(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div id="','" class=\n\t\t\t\t\t"tasks-scrum-actions-panel-btn tasks-scrum-actions-panel-btn-backlog">\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-icon"></span>\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-text">\n\t\t\t\t\t\t','\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-actions-panel-separator"></div>\n\t\t\t']);S=function e(){return t};return t}function T(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div id="','" class=\n\t\t\t\t\t"tasks-scrum-actions-panel-btn tasks-scrum-actions-panel-btn-sprint">\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-icon"></span>\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-text">\n\t\t\t\t\t\t','\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-actions-panel-separator"></div>\n\t\t\t']);T=function e(){return t};return t}function I(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div id="','" class=\n\t\t\t\t\t"tasks-scrum-actions-panel-btn tasks-scrum-actions-panel-btn-move">\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-icon"></span>\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-text">\n\t\t\t\t\t\t','\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-actions-panel-separator"></div>\n\t\t\t']);I=function e(){return t};return t}function C(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div id="','" class=\n\t\t\t\t\t"tasks-scrum-actions-panel-btn tasks-scrum-actions-panel-btn-dod">\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-icon"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-actions-panel-separator"></div>\n\t\t\t']);C=function e(){return t};return t}function E(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div id="','" class=\n\t\t\t\t\t"tasks-scrum-actions-panel-btn tasks-scrum-actions-panel-btn-attachment">\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-icon"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-actions-panel-separator"></div>\n\t\t\t']);E=function e(){return t};return t}function P(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div id="','" class=\n\t\t\t\t\t"tasks-scrum-actions-panel-btn tasks-scrum-actions-panel-btn-task">\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-icon"></span>\n\t\t\t\t\t<span class="tasks-scrum-actions-panel-text">\n\t\t\t\t\t\t','\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-actions-panel-separator"></div>\n\t\t\t']);P=function e(){return t};return t}var A=function(){function t(e){babelHelpers.classCallCheck(this,t);this.actionPanelNodeId="tasks-scrum-actions-panel";this.bindElement=e.bindElement;this.itemList=babelHelpers.objectSpread({},{task:{activity:false},attachment:{activity:false},dod:{activity:false},move:{activity:false},sprint:{activity:false},backlog:{activity:false},tags:{activity:false},epic:{activity:false},decomposition:{activity:false},remove:{activity:false}},e.itemList);this.listBlockBlurNodes=new Set}babelHelpers.createClass(t,[{key:"showPanel",value:function t(){var e=this;c.Dom.remove(document.getElementById(this.actionPanelNodeId));var i=this.calculatePanelPosition(this.createActionPanel());this.setBlockBlurNode(i);c.Dom.append(i,document.body);var s=function t(s){var n=false;e.listBlockBlurNodes.forEach(function(t){if(t.contains(s.target)){n=true}});if(!n){c.Dom.remove(i);c.Event.unbind(document,"click",t)}};c.Event.bind(document,"click",s);this.bindItems();var n=i.querySelector(".tasks-scrum-actions-panel");if(c.Dom.hasClass(n.lastElementChild,"tasks-scrum-actions-panel-separator")){c.Dom.remove(n.lastElementChild)}}},{key:"setBlockBlurNode",value:function t(e){this.listBlockBlurNodes.add(e)}},{key:"isShown",value:function t(){return Boolean(document.getElementById(this.actionPanelNodeId))}},{key:"createActionPanel",value:function t(){var e="";var i="";var s="";var n="";var r="";var a="";var o="";var u="";var l="";var d="";if(this.itemList.task.activity){this.showTaskActionButtonNodeId="tasks-scrum-actions-panel-btn-task";e=c.Tag.render(P(),this.showTaskActionButtonNodeId,c.Loc.getMessage("TASKS_SCRUM_ITEM_ACTIONS_TASK"))}if(this.itemList.attachment.activity){this.showAttachmentActionButtonNodeId="tasks-scrum-actions-panel-btn-attachment";i=c.Tag.render(E(),this.showAttachmentActionButtonNodeId)}if(this.itemList.dod.activity){this.showDodActionButtonNodeId="tasks-scrum-actions-panel-btn-dod";s=c.Tag.render(C(),this.showDodActionButtonNodeId)}if(this.itemList.move.activity){this.showMoveActionButtonNodeId="tasks-scrum-actions-panel-btn-move";n=c.Tag.render(I(),this.showMoveActionButtonNodeId,c.Loc.getMessage("TASKS_SCRUM_ITEM_ACTIONS_MOVE"))}if(this.itemList.sprint.activity){this.sprintActionButtonNodeId="tasks-scrum-actions-panel-btn-sprint";r=c.Tag.render(T(),this.sprintActionButtonNodeId,c.Loc.getMessage("TASKS_SCRUM_ITEM_ACTIONS_SPRINT"))}if(this.itemList.backlog.activity){this.backlogActionButtonNodeId="tasks-scrum-actions-panel-btn-backlog";a=c.Tag.render(S(),this.backlogActionButtonNodeId,c.Loc.getMessage("TASKS_SCRUM_ITEM_ACTIONS_BACKLOG"))}if(this.itemList.tags.activity){this.tagsActionButtonNodeId="tasks-scrum-actions-panel-btn-tags";o=c.Tag.render(k(),this.tagsActionButtonNodeId,c.Loc.getMessage("TASKS_SCRUM_ITEM_ACTIONS_TAGS"))}if(this.itemList.epic.activity){this.epicActionButtonNodeId="tasks-scrum-actions-panel-btn-epic";u=c.Tag.render(y(),this.epicActionButtonNodeId,c.Loc.getMessage("TASKS_SCRUM_ITEM_ACTIONS_EPIC"))}if(this.itemList.decomposition.activity){this.decompositionActionButtonNodeId="tasks-scrum-actions-panel-btn-decomposition";l=c.Tag.render(b(),this.decompositionActionButtonNodeId)}if(this.itemList.remove.activity){this.removeActionButtonNodeId="tasks-scrum-actions-panel-btn-remove";d=c.Tag.render(f(),this.removeActionButtonNodeId)}return c.Tag.render(g(),this.actionPanelNodeId,e,i,s,n,r,a,o,u,l,d)}},{key:"destroy",value:function t(){c.Dom.remove(document.getElementById(this.actionPanelNodeId))}},{key:"bindItems",value:function t(){if(this.itemList.task.activity){c.Event.bind(document.getElementById(this.showTaskActionButtonNodeId),"click",this.itemList.task.callback)}if(this.itemList.attachment.activity){c.Event.bind(document.getElementById(this.showAttachmentActionButtonNodeId),"click",this.itemList.attachment.callback)}if(this.itemList.dod.activity){c.Event.bind(document.getElementById(this.showDodActionButtonNodeId),"click",this.itemList.dod.callback)}if(this.itemList.move.activity){c.Event.bind(document.getElementById(this.showMoveActionButtonNodeId),"click",this.itemList.move.callback)}if(this.itemList.sprint.activity){c.Event.bind(document.getElementById(this.sprintActionButtonNodeId),"click",this.itemList.sprint.callback)}if(this.itemList.backlog.activity){c.Event.bind(document.getElementById(this.backlogActionButtonNodeId),"click",this.itemList.backlog.callback)}if(this.itemList.tags.activity){c.Event.bind(document.getElementById(this.tagsActionButtonNodeId),"click",this.itemList.tags.callback)}if(this.itemList.epic.activity){c.Event.bind(document.getElementById(this.epicActionButtonNodeId),"click",this.itemList.epic.callback)}if(this.itemList.remove.activity){c.Event.bind(document.getElementById(this.removeActionButtonNodeId),"click",this.itemList.remove.callback)}if(this.itemList.decomposition.activity){c.Event.bind(document.getElementById(this.decompositionActionButtonNodeId),"click",this.itemList.decomposition.callback)}}},{key:"calculatePanelPosition",value:function t(e){var i=c.Dom.getPosition(this.bindElement);var s="".concat(i.top,"px");var n="".concat(i.left,"px");var r=e.cloneNode(true);r.style.visibility="hidden";r.style.top="".concat(i.top,"px");r.style.left="".concat(i.left,"px");c.Dom.append(r,document.body);if(this.isPanelWiderThanViewport(r)){var a=r.getBoundingClientRect();var o=window.innerWidth||document.documentElement.clientWidth;n="".concat(a.left-(a.right-o+40),"px")}c.Dom.remove(r);e.style.top=s;e.style.left=n;e.style.zIndex=1100;return e}},{key:"isPanelWiderThanViewport",value:function t(e){var i=e.getBoundingClientRect();var s=window.innerWidth||document.documentElement.clientWidth;return i.right>s}}]);return t}();function D(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<span id="','" class="task-title-indicators">\n\t\t\t\t<div class="task-attachment-counter ui-label ui-label-sm ui-label-light">\n\t\t\t\t\t<span class="ui-label-inner">',"</span>\n\t\t\t\t</div>\n\t\t\t\t<div class='task-checklist-counter ui-label ui-label-sm ui-label-light'>\n\t\t\t\t\t<span class='ui-label-inner'>","/","</span>\n\t\t\t\t</div>\n\t\t\t\t<div class='task-comments-counter'>\n\t\t\t\t\t<div class='ui-counter ","'>\n\t\t\t\t\t\t<div class='ui-counter-inner'>","</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</span>\n\t\t"]);D=function e(){return t};return t}var w=function(){function t(e){babelHelpers.classCallCheck(this,t);this.setItemId(e.itemId);this.setAttachedFilesCount(e.attachedFilesCount);this.setCheckListComplete(e.checkListComplete);this.setCheckListAll(e.checkListAll);this.setTaskCounters(e.taskCounters)}babelHelpers.createClass(t,[{key:"setItemId",value:function t(e){this.itemId=c.Type.isInteger(e)?parseInt(e,10):c.Type.isString(e)&&e?e:c.Text.getRandom()}},{key:"setAttachedFilesCount",value:function t(e){this.attachedFilesCount=c.Type.isInteger(e)?parseInt(e,10):0}},{key:"getAttachedFilesCount",value:function t(){return this.attachedFilesCount}},{key:"setCheckListComplete",value:function t(e){this.checkListComplete=c.Type.isInteger(e)?parseInt(e,10):0}},{key:"getCheckListComplete",value:function t(){return this.checkListComplete}},{key:"setCheckListAll",value:function t(e){this.checkListAll=c.Type.isInteger(e)?parseInt(e,10):0}},{key:"getCheckListAll",value:function t(){return this.checkListAll}},{key:"setTaskCounters",value:function t(e){if(c.Type.isUndefined(e)){e={color:"",value:0}}this.taskCounter=e}},{key:"getTaskCounters",value:function t(){return this.taskCounter}},{key:"renderIndicators",value:function t(){this.indicatorsNodeId="tasks-scrum-item-indicators-"+this.itemId;return c.Tag.render(D(),this.indicatorsNodeId,this.attachedFilesCount,this.checkListComplete,this.checkListAll,this.taskCounter.color,this.taskCounter.value)}},{key:"onAfterAppend",value:function t(){this.indicatorsNode=document.getElementById(this.indicatorsNodeId);this.attachmentNode=this.indicatorsNode.querySelector(".task-attachment-counter");this.checklistNode=this.indicatorsNode.querySelector(".task-checklist-counter");this.commentsNode=this.indicatorsNode.querySelector(".task-comments-counter");this.updateVisibility()}},{key:"updateIndicators",value:function t(e){if(!this.indicatorsNode){return}if(e.attachedFilesCount){this.attachedFilesCount=parseInt(e.attachedFilesCount,10);this.attachmentNode.firstElementChild.textContent=this.attachedFilesCount}if(e.checkListComplete){this.checkListComplete=parseInt(e.checkListComplete,10);this.checklistNode.firstElementChild.textContent=this.checkListComplete+"/"+this.checkListAll}if(e.checkListAll){this.checkListAll=parseInt(e.checkListAll,10);this.checklistNode.firstElementChild.textContent=this.checkListComplete+"/"+this.checkListAll}if(e.taskCounter){this.setTaskCounters(e.taskCounter);var i=this.commentsNode.querySelector(".ui-counter");var s=this.commentsNode.querySelector(".ui-counter-inner");i.className="ui-counter ".concat(c.Text.encode(this.taskCounter.color));s.textContent=parseInt(this.taskCounter.value,10)}this.updateVisibility()}},{key:"updateVisibility",value:function t(){if(this.attachedFilesCount>0){this.showNode(this.attachmentNode)}else{this.hideNode(this.attachmentNode)}if(this.checkListAll>0){this.showNode(this.checklistNode)}else{this.hideNode(this.checklistNode)}if(this.taskCounter.value>0){this.showNode(this.commentsNode)}else{this.hideNode(this.commentsNode)}}},{key:"showNode",value:function t(e){c.Dom.style(e,"display","inline-flex")}},{key:"hideNode",value:function t(e){c.Dom.style(e,"display","none")}}]);return t}();var N=function(){function t(){babelHelpers.classCallCheck(this,t);this.clearPoints();this.differencePoints=0}babelHelpers.createClass(t,[{key:"setPoints",value:function t(e){if(c.Type.isUndefined(e)){return}this.saveDifferencePoints(this.storyPoints?this.storyPoints:0,e);this.storyPoints=String(e)}},{key:"getPoints",value:function t(){return String(this.storyPoints)}},{key:"addPoints",value:function t(e){if(c.Type.isUndefined(e)||isNaN(parseFloat(e))){return}var i=this.storyPoints!==""?parseFloat(this.storyPoints):0;var s=parseFloat(e);var n=i+s;if(c.Type.isFloat(n)){n=n.toFixed(1)}this.storyPoints=String(n)}},{key:"subtractPoints",value:function t(e){if(c.Type.isUndefined(e)||isNaN(parseFloat(e))){return}var i=this.storyPoints!==""?parseFloat(this.storyPoints):0;var s=parseFloat(e);var n=i-s;if(c.Type.isFloat(n)){n=n.toFixed(1)}this.storyPoints=String(n)}},{key:"clearPoints",value:function t(){this.storyPoints=""}},{key:"saveDifferencePoints",value:function t(e,i){this.differencePoints=0;if(c.Type.isUndefined(e)||isNaN(parseFloat(e))){return}if(c.Type.isUndefined(i)||isNaN(parseFloat(i))){return}e=parseFloat(e);i=parseFloat(i);this.differencePoints=i-e}},{key:"getDifferencePoints",value:function t(){return this.differencePoints}}]);return t}();function L(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-item-tags-container">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t</div>\n\t\t"]);L=function e(){return t};return t}function M(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-item-tags-container">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t</div>\n\t\t"]);M=function e(){return t};return t}function B(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-item-subtasks-tick">\n\t\t\t\t<div class="ui-btn ui-btn-sm ui-btn-light ui-btn-icon-angle-down"></div>\n\t\t\t</div>\n\t\t']);B=function e(){return t};return t}function _(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-item-subtasks-btn">\n\t\t\t\t<span class="tasks-scrum-item-subtasks-icon"></span>\n\t\t\t\t<span class="tasks-scrum-item-subtasks-count">\n\t\t\t\t\t',"\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t"]);_=function e(){return t};return t}function H(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-item-story-points">\n\t\t\t\t<div class="tasks-scrum-item-story-points-field ui-ctl ui-ctl-xs ui-ctl-textbox ui-ctl-auto ui-ctl-no-border">\n\t\t\t\t\t<div class="ui-ctl-element" contenteditable="false">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);H=function e(){return t};return t}function R(){var t=babelHelpers.taggedTemplateLiteral(['<div class="ui-icon ui-icon-common-user tasks-scrum-item-responsible"><i></i></div>']);R=function e(){return t};return t}function q(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-item-name-field ui-ctl ui-ctl-xs ui-ctl-textbox ui-ctl-no-border">\n\t\t\t\t<div class="ui-ctl-element" contenteditable="false">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);q=function e(){return t};return t}function F(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div data-item-id="','" data-sort=\n\t\t\t\t"','" class="','">\n\t\t\t\t<div class="tasks-scrum-item-inner">\n\t\t\t\t\t<div class="tasks-scrum-item-group-mode-container">\n\t\t\t\t\t\t<input type="checkbox">\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-item-name">\n\t\t\t\t\t\t',"\n\t\t\t\t\t\t",'\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-item-params">\n\t\t\t\t\t\t',"\n\t\t\t\t\t\t","\n\t\t\t\t\t\t","\n\t\t\t\t\t\t","\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t","\n\t\t\t</div>\n\t\t"]);F=function e(){return t};return t}var O=function(t){babelHelpers.inherits(i,t);function i(t){var e;babelHelpers.classCallCheck(this,i);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this,t));e.setEventNamespace("BX.Tasks.Scrum.Item");e.setItemParams(t);e.groupMode=false;e.previewMode=false;return e}babelHelpers.createClass(i,[{key:"setItemParams",value:function t(e){this.setItemNode();this.setItemId(e.itemId);this.setTmpId(e.tmpId);this.setName(e.name);this.setItemType(e.itemType);this.setSort(e.sort);this.setEntityId(e.entityId);this.setEntityType(e.entityType);this.setParentId(e.parentId);this.setSourceId(e.sourceId);this.setInfo(e.info);this.setParentTask(e.isParentTask);this.setSubTasksCount(e.subTasksCount);this.setLinkedTask(e.isLinkedTask);this.setParentTaskId(e.parentTaskId);this.setSubTask(e.isSubTask);this.setSubTasksInfo(e.subTasksInfo);this.setResponsible(e.responsible);this.setCompleted(e.completed);this.setDisableStatus(this.isCompleted());this.setAllowedActions(e.allowedActions);this.setEpic(e.epic);this.setTags(e.tags);this.setTaskCounts(e);this.setStoryPoints(e.storyPoints)}},{key:"setItemId",value:function t(e){this.itemId=c.Type.isInteger(e)?parseInt(e,10):c.Type.isString(e)&&e?e:c.Text.getRandom();if(this.isNodeCreated()){this.getItemNode().dataset.itemId=this.itemId}}},{key:"getItemId",value:function t(){return this.itemId}},{key:"setTmpId",value:function t(e){this.tmpId=c.Type.isString(e)?e:""}},{key:"getTmpId",value:function t(){return this.tmpId}},{key:"setName",value:function t(e){this.name=c.Type.isString(e)&&e?e:"";if(!this.name){throw new Error(c.Loc.getMessage("TASKS_SCRUM_TASK_ADD_NAME_ERROR"))}if(this.isNodeCreated()){var i=this.getItemNode().querySelector(".tasks-scrum-item-name-field");i.querySelector(".ui-ctl-element").textContent=c.Text.encode(this.name)}}},{key:"getName",value:function t(){return this.name}},{key:"setItemType",value:function t(e){this.itemType=c.Type.isString(e)?e:"task"}},{key:"getItemType",value:function t(){return this.itemType}},{key:"setSort",value:function t(e){this.setPreviousSort(this.sort);this.sort=c.Type.isInteger(e)?parseInt(e,10):0;if(this.isNodeCreated()){c.Dom.attr(this.getItemNode(),"data-sort",this.sort)}}},{key:"getSort",value:function t(){return this.sort}},{key:"setPreviousSort",value:function t(e){this.previousSort=c.Type.isInteger(e)?parseInt(e,10):0}},{key:"getPreviousSort",value:function t(){return this.previousSort}},{key:"setEntityId",value:function t(e){this.entityId=c.Type.isInteger(e)?parseInt(e,10):0}},{key:"getEntityId",value:function t(){return this.entityId}},{key:"setEntityType",value:function t(e){this.entityType=new Set(["backlog","sprint"]).has(e)?e:"backlog"}},{key:"getEntityType",value:function t(){return this.entityType}},{key:"setParentId",value:function t(e){this.parentId=c.Type.isInteger(e)?parseInt(e,10):0}},{key:"getParentId",value:function t(){return this.parentId}},{key:"setSourceId",value:function t(e){this.sourceId=c.Type.isInteger(e)?parseInt(e,10):0}},{key:"getSourceId",value:function t(){return this.sourceId}},{key:"setResponsible",value:function t(e){this.responsible=c.Type.isPlainObject(e)?e:null;if(this.responsible&&this.isNodeCreated()){this.updateResponsible()}}},{key:"getResponsible",value:function t(){return this.responsible}},{key:"setStoryPoints",value:function t(e){if(!this.storyPoints){this.storyPoints=new N}this.storyPoints.setPoints(e);this.updateStoryPointsNode()}},{key:"getStoryPoints",value:function t(){if(this.isParentTask()){var e=new N;Object.values(this.getSubTasksInfo()).map(function(t){if(t.storyPoints instanceof N){e.addPoints(t.storyPoints.getPoints())}});return e}else{return this.storyPoints}}},{key:"updateStoryPointsNode",value:function t(){if(this.isNodeCreated()){var e=this.getItemNode().querySelector(".tasks-scrum-item-story-points");e.querySelector(".ui-ctl-element").textContent=c.Text.encode(this.getStoryPoints().getPoints());this.sendEventToUpdateStoryPoints()}}},{key:"setSubTasksInfo",value:function t(e){if(c.Type.isUndefined(e)){this.subTasksInfo=[];return}Object.values(e).map(function(t){var e=new N;if(c.Type.isString(t.storyPoints)){e.setPoints(t.storyPoints)}t.storyPoints=e});this.subTasksInfo=e}},{key:"getSubTasksInfo",value:function t(){return this.subTasksInfo}},{key:"updateSubTasksPoints",value:function t(e,i){var s=this.getSubTasksInfo();if(c.Type.isArray(s)){s={};s[e]={sourceId:e,completed:"N",storyPoints:i.getPoints()};this.setSubTasksInfo(s);this.updateStoryPointsNode();return}var n=this.getSubTasksInfo();if(n.hasOwnProperty(e)){n[e].storyPoints=i}else{n[e]={sourceId:e,completed:"N",storyPoints:i}}this.updateStoryPointsNode()}},{key:"getCompletedSubTasksStoryPoints",value:function t(){var e=new N;if(this.isCompleted()){e.setPoints(this.storyPoints.getPoints())}Object.values(this.getSubTasksInfo()).map(function(t){if(t.completed==="Y"){if(t.storyPoints instanceof N){e.addPoints(t.storyPoints.getPoints())}}});return e}},{key:"getUncompletedSubTasksStoryPoints",value:function t(){var e=new N;if(!this.isCompleted()){e.setPoints(this.storyPoints.getPoints())}Object.values(this.getSubTasksInfo()).map(function(t){if(t.completed==="N"){if(t.storyPoints instanceof N){e.addPoints(t.storyPoints.getPoints())}}});return e}},{key:"setCompleted",value:function t(e){this.completed=e==="Y";if(this.isNodeCreated()){this.updateCompletedStatus()}}},{key:"setAllowedActions",value:function t(e){this.allowedActions=c.Type.isPlainObject(e)?e:{}}},{key:"setEpic",value:function t(e){this.epic=c.Type.isPlainObject(e)?e:null}},{key:"getEpic",value:function t(){return this.epic}},{key:"setTags",value:function t(e){this.tags=c.Type.isArray(e)?e:[]}},{key:"getTags",value:function t(){return this.tags}},{key:"setParentTask",value:function t(e){this.parentTask=e==="Y"}},{key:"isParentTask",value:function t(){return this.parentTask}},{key:"setSubTasksCount",value:function t(e){this.subTasksCount=c.Type.isInteger(e)?parseInt(e,10):0}},{key:"getSubTasksCount",value:function t(){return this.subTasksCount}},{key:"setLinkedTask",value:function t(e){this.linkedTask=e==="Y"}},{key:"isLinkedTask",value:function t(){return this.linkedTask}},{key:"setParentTaskId",value:function t(e){this.parentTaskId=c.Type.isInteger(e)?parseInt(e,10):0}},{key:"getParentTaskId",value:function t(){return this.parentTaskId}},{key:"setSubTask",value:function t(e){this.subTask=e==="Y"}},{key:"isSubTask",value:function t(){return this.subTask}},{key:"setTaskCounts",value:function t(e){this.taskCounts=this.itemType==="task"?new w(e):null}},{key:"getTaskCounts",value:function t(){return this.taskCounts}},{key:"cleanTaskCounts",value:function t(){this.taskCounts=null}},{key:"setInfo",value:function t(e){if(c.Type.isUndefined(e)){this.info={color:"",borderColor:""};return}this.info=e;this.setBorderColor(this.info.borderColor)}},{key:"getInfo",value:function t(){return this.info}},{key:"setBorderColor",value:function t(e){this.info.borderColor=c.Type.isString(e)?e:"";if(this.isNodeCreated()){if(this.getBorderColor()){c.Dom.style(this.getItemNode(),"border","2px solid "+this.getBorderColor())}else{c.Dom.style(this.getItemNode(),"border",null)}}}},{key:"getBorderColor",value:function t(){return c.Type.isString(this.info.borderColor)?this.info.borderColor:""}},{key:"isCompleted",value:function t(){return this.completed}},{key:"updateCompletedStatus",value:function t(){var e=this.getItemNode().querySelector(".tasks-scrum-item-name");var i=e.querySelector(".ui-ctl-element");if(this.isCompleted()){c.Dom.style(i,"textDecoration","line-through")}else{c.Dom.style(i,"textDecoration",null)}this.sendEventToUpdateStoryPoints()}},{key:"isDisabled",value:function t(){return this.disableStatus}},{key:"setMoveActivity",value:function t(e){this.moveActivity=Boolean(e)}},{key:"isMovable",value:function t(){return this.moveActivity}},{key:"setDisableStatus",value:function t(e){this.disableStatus=Boolean(e);if(!this.isNodeCreated()){return}if(e){this.hideNode(this.getItemNode().querySelector(".tasks-scrum-dragndrop"))}else{this.showNode(this.getItemNode().querySelector(".tasks-scrum-dragndrop"))}}},{key:"activateGroupMode",value:function t(){var e=this;this.groupMode=true;if(!this.isNodeCreated()){return}var i=this.getItemNode().querySelector(".tasks-scrum-item-group-mode-container");var s=i.querySelector("input");s.checked=false;c.Event.bind(s,"change",function(t){c.Dom.toggleClass(e.getItemNode(),"tasks-scrum-item-group-mode");if(e.getItemNode().classList.contains("tasks-scrum-item-group-mode")){e.emit("addItemToGroupMode")}else{e.emit("removeItemFromGroupMode")}e.showActionsPanel(t)});this.showNode(i);this.deactivateDragNDrop()}},{key:"deactivateGroupMode",value:function t(){if(!this.isNodeCreated()){return}c.Dom.removeClass(this.getItemNode(),"tasks-scrum-item-group-mode");var e=this.getItemNode().querySelector(".tasks-scrum-item-group-mode-container");this.hideNode(e);c.Event.unbindAll(e.querySelector("input"));this.groupMode=false;this.activateDragNDrop()}},{key:"isGroupMode",value:function t(){return this.groupMode}},{key:"activatePreviewMode",value:function t(){this.previewMode=true}},{key:"isPreviewMode",value:function t(){return this.previewMode}},{key:"getPreviewVersion",value:function t(){var e=c.Runtime.clone(this);e.setItemId();e.itemNode=null;e.activatePreviewMode();e.taskCounts=null;return e}},{key:"activateDecompositionMode",value:function t(e){this.decompositionMode=true;if(this.getBorderColor()===""){this.setBorderColor(e)}if(this.getBorderColor()){c.Dom.style(this.getItemNode(),"border","2px solid "+this.getBorderColor())}this.deactivateDragNDrop()}},{key:"deactivateDecompositionMode",value:function t(){this.decompositionMode=false;if(this.getBorderColor()===""){this.setBorderColor();c.Dom.style(this.getItemNode(),"border",null)}this.activateDragNDrop()}},{key:"activateDragNDrop",value:function t(){if(this.isNodeCreated()){if(!this.getItemNode().classList.contains("tasks-scrum-item-drag")){c.Dom.addClass(this.getItemNode(),"tasks-scrum-item-drag")}}}},{key:"deactivateDragNDrop",value:function t(){if(this.isNodeCreated()){c.Dom.removeClass(this.getItemNode(),"tasks-scrum-item-drag")}}},{key:"isDecompositionMode",value:function t(){return this.decompositionMode}},{key:"setItemNode",value:function t(e){try{this.itemNode=e instanceof HTMLElement?e:null}catch(t){this.itemNode=null}}},{key:"getItemNode",value:function t(){return this.itemNode}},{key:"isNodeCreated",value:function t(){return this.itemNode!==null}},{key:"setParentEntity",value:function t(e,i){this.setEntityId(e);this.setEntityType(i)}},{key:"isEditAllowed",value:function t(){return Boolean(this.allowedActions["task_edit"])}},{key:"isRemoveAllowed",value:function t(){return Boolean(this.allowedActions["task_remove"])}},{key:"updateYourself",value:function t(e){if(e.getName()!==this.getName()){this.setName(e.getName())}if(e.getEntityId()!==this.getEntityId()){this.setEntityId(e.getEntityId())}if(e.getResponsible().id!==this.getResponsible().id){this.setResponsible(e.getResponsible())}if(e.getStoryPoints().getPoints()!==this.getStoryPoints().getPoints()){this.setStoryPoints(e.getStoryPoints().getPoints())}if(this.getTaskCounts()&&e.getTaskCounts()){this.getTaskCounts().updateIndicators({attachedFilesCount:e.getTaskCounts().getAttachedFilesCount(),checkListComplete:e.getTaskCounts().getCheckListComplete(),checkListAll:e.getTaskCounts().getCheckListAll(),taskCounter:e.getTaskCounts().getTaskCounters()})}if(e.isCompleted()!==this.isCompleted()){this.setCompleted(e.isCompleted()?"Y":"N")}this.setParentId(e.getParentId());this.setEpicAndTags(e.getEpic(),e.getTags());this.setInfo(e.getInfo());this.setParentTask(e.isParentTask()?"Y":"N");this.setSubTasksCount(e.getSubTasksCount());this.setLinkedTask(e.isLinkedTask()?"Y":"N");this.setParentTaskId(e.getParentTaskId());this.setSubTask(e.isSubTask()?"Y":"N");this.setSubTasksInfo(e.getSubTasksInfo());if(this.isNodeCreated()){this.updateParentTaskNodes()}}},{key:"removeYourself",value:function t(){c.Dom.remove(this.getItemNode());this.setItemNode()}},{key:"render",value:function t(){var e="tasks-scrum-item";if(this.isSubTask()){e+=" tasks-scrum-subtask-item"}this.itemNode=c.Tag.render(F(),c.Text.encode(this.itemId),c.Text.encode(this.sort),e,this.renderName(),this.taskCounts&&this.itemType==="task"?this.taskCounts.renderIndicators():"",this.renderSubTasksCounter(),this.renderResponsible(),this.renderStoryPoints(),this.renderSubTasksTick(),this.renderTags());if(this.isNodeCreated()&&this.getBorderColor()){c.Dom.style(this.itemNode,"border","2px solid "+this.getBorderColor())}return this.itemNode}},{key:"renderName",value:function t(){return c.Tag.render(q(),c.Text.encode(this.name))}},{key:"renderResponsible",value:function t(){return c.Tag.render(R())}},{key:"renderStoryPoints",value:function t(){return c.Tag.render(H(),c.Text.encode(this.getStoryPoints().getPoints()))}},{key:"renderSubTasksCounter",value:function t(){var e=this;if(!this.isParentTask()){return""}var i=c.Tag.render(_(),this.getSubTasksCount());c.Event.bind(i,"click",function(){e.emit("showTask")});return i}},{key:"renderSubTasksTick",value:function t(){var e=this;if(!this.isParentTask()||this.isPreviewMode()){return""}if(this.getEntityType()==="backlog"){return""}var i=c.Tag.render(B());c.Event.bind(i,"click",function(){if(!e.isDecompositionMode()){e.emit("toggleSubTasks")}});return i}},{key:"toggleSubTasksTick",value:function t(){if(!this.isNodeCreated()){return}var e=this.getItemNode().querySelector(".tasks-scrum-item-subtasks-tick");if(e){e.firstElementChild.classList.toggle("ui-btn-icon-angle-up");e.firstElementChild.classList.toggle("ui-btn-icon-angle-down")}}},{key:"upSubTasksTick",value:function t(){if(!this.isNodeCreated()){return}var e=this.getItemNode().querySelector(".tasks-scrum-item-subtasks-tick");if(e){c.Dom.removeClass(e.firstElementChild,"ui-btn-icon-angle-down");c.Dom.addClass(e.firstElementChild,"ui-btn-icon-angle-up")}}},{key:"downSubTasksTick",value:function t(){if(!this.isNodeCreated()){return}var e=this.getItemNode().querySelector(".tasks-scrum-item-subtasks-tick");if(e){c.Dom.removeClass(e.firstElementChild,"ui-btn-icon-angle-up");c.Dom.addClass(e.firstElementChild,"ui-btn-icon-angle-down")}}},{key:"renderTags",value:function t(){if(this.epic===null&&this.tags.length===0){return""}return c.Tag.render(M(),this.getEpicTag(),this.getListTagNodes())}},{key:"getEpicTag",value:function t(){var e=this;if(this.epic===null){return""}var i=function t(e){if(!e){e=o.Label.Color.DEFAULT}e=e.replace("#","");var i=parseInt(e.substr(0,2),16);var s=parseInt(e.substr(2,2),16);var n=parseInt(e.substr(4,2),16);var r=(i*299+s*587+n*114)/1e3;return r>=128?"black":"white"};var s=new o.Label({text:this.epic.name,color:o.Label.Color.DEFAULT,size:o.Label.Size.MD,customClass:"tasks-scrum-item-epic-label"});var n=s.getContainer();var r=n.querySelector(".ui-label-inner");var a=i(this.epic.info.color);if(a==="white"){c.Dom.style(r,"color","#ffffff")}else{c.Dom.style(r,"color","#525c69")}c.Dom.style(n,"backgroundColor",this.epic.info.color);c.Event.bind(n,"click",function(t){if(e.isGroupMode()){e.clickToGroupModeCheckbox();e.showActionsPanel(t);return}e.emit("filterByEpic",e.epic.id)});return n}},{key:"getListTagNodes",value:function t(){var e=this;return this.tags.map(function(t){var i=new o.Label({text:t,color:o.Label.Color.TAG_LIGHT,fill:true,size:o.Label.Size.SM,customClass:""});var s=i.getContainer();c.Event.bind(s,"click",function(i){if(e.isGroupMode()){e.clickToGroupModeCheckbox();e.showActionsPanel(i);return}e.emit("filterByTag",t)});return s})}},{key:"onAfterAppend",value:function t(e){var i=this;this.setItemNode(e.querySelector('[data-item-id="'+this.itemId+'"]'));if(!this.isNodeCreated()){return}if(this.taskCounts){this.taskCounts.onAfterAppend()}this.updateResponsible();if(this.isPreviewMode()){c.Event.bind(this.getItemNode(),"click",function(){return i.emit("showTask")});return}if(!this.isDecompositionMode()){this.activateDragNDrop()}if(this.isSubTask()){this.deactivateDragNDrop()}c.Event.unbindAll(this.getItemNode());c.Event.bind(this.getItemNode(),"click",this.onItemClick.bind(this));var s=this.getItemNode().querySelector(".tasks-scrum-item-name");c.Event.unbindAll(s);c.Event.bind(s,"click",this.onNameClick.bind(this));var n=this.getItemNode().querySelector(".tasks-scrum-item-responsible");c.Event.unbindAll(n);c.Event.bind(n,"click",this.onResponsibleClick.bind(this));var r=this.getItemNode().querySelector(".tasks-scrum-item-story-points");c.Event.unbindAll(r);c.Event.bind(r,"click",this.onStoryPointsClick.bind(this));if(this.isCompleted()){var a=s.querySelector(".ui-ctl-element");c.Dom.style(a,"textDecoration","line-through")}this.updateParentTaskNodes()}},{key:"isShowIndicators",value:function t(){return Boolean(this.attachedFilesCount||this.checkListAll||this.newCommentsCount)}},{key:"updateParentTaskNodes",value:function t(){if(this.isParentTask()){var e=this.getItemNode().querySelector(".tasks-scrum-item-subtasks-btn");if(e){c.Dom.replace(e,this.renderSubTasksCounter())}else{var i=this.getItemNode().querySelector(".tasks-scrum-item-params");var s=this.renderSubTasksCounter();c.Dom.insertBefore(s,i.firstElementChild)}var n=this.getItemNode().querySelector(".tasks-scrum-item-subtasks-tick");if(n){var r=this.renderSubTasksTick();if(r){c.Dom.replace(n,r)}else{c.Dom.remove(n)}}else{var a=this.getItemNode().querySelector(".tasks-scrum-item-params");var o=this.renderSubTasksTick();c.Dom.append(o,a)}}else{var u=this.getItemNode().querySelector(".tasks-scrum-item-subtasks-btn");if(u){c.Dom.remove(u)}var l=this.getItemNode().querySelector(".tasks-scrum-item-subtasks-tick");if(l){c.Dom.remove(l)}}}},{key:"onItemClick",value:function t(e){if(this.isClickOnEditableName(e)&&!this.isGroupMode()){return}var i=new Set(["I","SPAN","INPUT"]);if(i.has(e.target.tagName)){return}if(e.target.closest(".tasks-scrum-item-subtasks-tick")){return}this.clickToGroupModeCheckbox();this.showActionsPanel(e)}},{key:"isClickOnEditableName",value:function t(e){return e.target.classList.contains("ui-ctl-element")}},{key:"onNameClick",value:function t(e){if(this.isClickOnEditableName(e)&&!this.isGroupMode()){this.emit("showTask")}}},{key:"clickToGroupModeCheckbox",value:function t(){if(this.isGroupMode()){var e=this.getItemNode().querySelector(".tasks-scrum-item-group-mode-container");var i=e.querySelector("input");i.click()}}},{key:"onResponsibleClick",value:function t(i){var s=this;if(this.isGroupMode()){this.clickToGroupModeCheckbox();this.showActionsPanel(i);return}if(this.isDisabled()){return}var n=i.currentTarget;var r=new e.Dialog({targetNode:n,enableSearch:true,context:"TASKS",events:{"Item:onSelect":function t(e){r.hide();var i=e.getData().item;s.responsible={id:i.getId(),name:i.getTitle(),photo:{src:i.getAvatar()}};s.updateResponsible();s.emit("changeTaskResponsible")}},entities:[{id:"user",options:{inviteEmployeeLink:false}},{id:"department"}]});r.show()}},{key:"onStoryPointsClick",value:function t(e){var i=this;if(this.isGroupMode()||this.isDisabled()||this.isCompleted()||this.isParentTask()){this.clickToGroupModeCheckbox();this.showActionsPanel(e);return}var s=e.currentTarget;var n=s.querySelector(".ui-ctl");var r=s.querySelector(".ui-ctl-element");r.textContent=r.textContent.trim();var a=r.textContent.trim();if(r.contentEditable==="true"){return}c.Dom.toggleClass(n,"ui-ctl-no-border");r.contentEditable="true";this.placeCursorAtEnd(r);c.Event.bind(r,"keydown",this.blockEnterInput.bind(r));c.Event.bindOnce(r,"blur",function(){c.Event.unbind(r,"keydown",i.blockEnterInput.bind(r));c.Dom.toggleClass(n,"ui-ctl-no-border");r.contentEditable="false";var t=r.textContent.trim();if(t&&a===t){r.textContent=a;return}i.emit("updateItem",{itemId:i.getItemId(),entityId:i.getEntityId(),itemType:i.getItemType(),storyPoints:t});i.setStoryPoints(t)},true)}},{key:"sendEventToUpdateStoryPoints",value:function t(){this.emit("updateStoryPoints")}},{key:"blockEnterInput",value:function t(e){if(e.isComposing||e.keyCode===13){this.blur();return}}},{key:"showActionsPanel",value:function t(e){var i=this;if(this.actionsPanel&&this.actionsPanel.isShown()&&!this.isGroupMode()){return}if(e){e.stopPropagation()}this.actionsPanel=new A({bindElement:this.getItemNode(),itemList:{task:{activity:this.itemType==="task"&&!this.isGroupMode(),callback:function t(){i.emit("showTask");i.actionsPanel.destroy()}},attachment:{activity:!this.isDisabled()&&this.isEditAllowed()&&!this.isGroupMode(),callback:function t(e){var s=new v({ufDiskFilesFieldName:"UF_TASK_WEBDAV_FILES"});s.subscribeOnce("onFinish",function(t){i.emit("attachFilesToTask",t.getData());i.actionsPanel.destroy()});s.showAttachmentMenu(e.currentTarget)}},dod:{activity:!this.decompositionMode&&!this.isGroupMode(),callback:function t(){i.emit("dod");i.actionsPanel.destroy()}},move:{activity:!this.decompositionMode&&this.isMovable()&&!this.isSubTask(),callback:function t(e){i.emit("move",e.currentTarget)}},sprint:{activity:!this.isDisabled()&&!this.decompositionMode&&!this.isSubTask(),callback:function t(e){i.emit("moveToSprint",e.currentTarget)}},backlog:{activity:this.entityType==="sprint"&&!this.decompositionMode&&!this.isSubTask(),callback:function t(){i.emit("moveToBacklog");i.actionsPanel.destroy()}},tags:{activity:true,callback:function t(e){i.emit("showTagSearcher",e.currentTarget)}},epic:{activity:true,callback:function t(e){i.emit("showEpicSearcher",e.currentTarget)}},decomposition:{activity:!this.isDisabled()&&!this.decompositionMode&&!this.isGroupMode()&&!this.isSubTask(),callback:function t(e){i.emit("startDecomposition");i.actionsPanel.destroy()}},remove:{activity:this.isRemoveAllowed(),callback:function t(){var e=i.isGroupMode()?c.Loc.getMessage("TASKS_SCRUM_CONFIRM_TEXT_REMOVE_TASKS"):c.Loc.getMessage("TASKS_SCRUM_CONFIRM_TEXT_REMOVE_TASK");u.MessageBox.confirm(e,function(t){i.emit("remove");t.close();i.actionsPanel.destroy()},c.Loc.getMessage("TASKS_SCRUM_BUTTON_TEXT_REMOVE"))}}}});this.actionsPanel.showPanel()}},{key:"getCurrentActionsPanel",value:function t(){if(this.actionsPanel&&this.actionsPanel.isShown()){return this.actionsPanel}else{return null}}},{key:"setEpicAndTags",value:function t(e,i){this.epic=c.Type.isPlainObject(e)||e===null?e:this.epic;this.tags=c.Type.isArray(i)?i:this.tags;if(this.epic===null&&this.tags.length===0){return}this.updateTagsContainer()}},{key:"updateTagsContainer",value:function t(){if(!this.getItemNode()){return}var e=c.Tag.render(L(),this.getEpicTag(),this.getListTagNodes());var i=this.getItemNode().querySelector(".tasks-scrum-item-tags-container");if(i){c.Dom.replace(i,e)}else{c.Dom.append(e,this.getItemNode())}}},{key:"updateResponsible",value:function t(){if(!this.getItemNode()){return}var e=this.getItemNode().querySelector(".tasks-scrum-item-responsible");if(!e){return}c.Dom.attr(e,"title",this.responsible.name);if(this.responsible.photo&&this.responsible.photo.src){c.Dom.style(e.firstElementChild,"backgroundImage",'url("'+this.responsible.photo.src+'")')}else{c.Dom.style(e.firstElementChild,"backgroundImage",null)}}},{key:"placeCursorAtEnd",value:function t(e){e.focus();var i=window.getSelection();var s=document.createRange();s.selectNodeContents(e);s.collapse(false);i.removeAllRanges();i.addRange(s)}},{key:"updateIndicators",value:function t(e){if(this.taskCounts){this.taskCounts.updateIndicators(e)}}},{key:"showNode",value:function t(e){c.Dom.style(e,"display","block")}},{key:"hideNode",value:function t(e){c.Dom.style(e,"display","none")}}],[{key:"buildItem",value:function t(e){return new i(e)}}]);return i}(d.EventEmitter);function U(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<a class="ui-link ui-link-dashed ui-link-secondary tasks-scrum-group-actions">\n\t\t\t\t',"\n\t\t\t</a>\n\t\t"]);U=function e(){return t};return t}var x=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t.setEventNamespace("BX.Tasks.Scrum.GroupActionsButton");t.element=null;return t}babelHelpers.createClass(e,[{key:"render",value:function t(){this.element=c.Tag.render(U(),c.Loc.getMessage("TASKS_SCRUM_BACKLOG_LIST_ACTIONS_GROUP"));c.Event.bind(this.element,"click",this.onClick.bind(this,this.element));return this.element}},{key:"deactivateGroupMode",value:function t(){if(this.element&&this.element.classList.contains("tasks-scrum-group-actions-active")){c.Dom.toggleClass(this.element,"tasks-scrum-group-actions");c.Dom.toggleClass(this.element,"tasks-scrum-group-actions-active");c.Dom.toggleClass(this.element,"ui-link-secondary");c.Dom.toggleClass(this.element,"ui-link-dashed");this.emit("deactivateGroupMode")}}},{key:"onClick",value:function t(e){c.Dom.toggleClass(e,"tasks-scrum-group-actions");c.Dom.toggleClass(e,"tasks-scrum-group-actions-active");c.Dom.toggleClass(e,"ui-link-secondary");c.Dom.toggleClass(e,"ui-link-dashed");if(e.classList.contains("tasks-scrum-group-actions-active")){this.emit("activateGroupMode")}else{this.emit("deactivateGroupMode")}}},{key:"removeYourself",value:function t(){c.Dom.remove(this.element);this.element=null}}]);return e}(d.EventEmitter);function G(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-items-list" data-entity-id="','">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t</div>\n\t\t"]);G=function e(){return t};return t}var K=function(){function t(e){babelHelpers.classCallCheck(this,t);this.entity=e;this.node=null}babelHelpers.createClass(t,[{key:"render",value:function t(){var e=this;this.node=c.Tag.render(G(),this.entity.getId(),this.entity.isCompleted()?"":this.entity.getInput().render(),babelHelpers.toConsumableArray(this.entity.getItems().values()).map(function(t){t.setEntityType(e.entity.getEntityType());return t.render()}));return this.node}},{key:"getNode",value:function t(){return this.node}},{key:"setEntityId",value:function t(e){this.node.dataset.entityId=parseInt(e,10)}}]);return t}();function V(){var t=babelHelpers.taggedTemplateLiteral(['<span class="ui-selector-footer-conjunction"></span>']);V=function e(){return t};return t}function X(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span onclick="','" class="ui-selector-footer-link ui-selector-footer-link-add">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>\n\t\t\t\t"]);X=function e(){return t};return t}var Y=function(t){babelHelpers.inherits(i,t);function i(){var t;babelHelpers.classCallCheck(this,i);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this));t.setEventNamespace("BX.Tasks.Scrum.TagSearcher");t.allTags=new Map;return t}babelHelpers.createClass(i,[{key:"addTagToSearcher",value:function t(e){e=e.trim();this.allTags.set("tag_"+e,{id:e,entityId:"tag",tabs:"recents",title:e,avatar:"/bitrix/components/bitrix/tasks.scrum/templates/.default/images/search-hashtag.svg"})}},{key:"addEpicToSearcher",value:function t(e){var i=e.name.trim();this.allTags.set("epic_"+i,{id:e.id,entityId:"epic",tabs:"recents",title:i.trim(),avatar:"/bitrix/components/bitrix/tasks.scrum/templates/.default/images/search-hashtag-green.svg",name:i.trim(),description:e.description,info:e.info})}},{key:"getTagFromSearcher",value:function t(e){return this.allTags.get(e)}},{key:"removeEpicFromSearcher",value:function t(e){this.allTags.delete("epic_"+e.name)}},{key:"getAllList",value:function t(){return babelHelpers.toConsumableArray(this.allTags.values())}},{key:"getTagsList",value:function t(){var e=[];babelHelpers.toConsumableArray(this.allTags.values()).forEach(function(t){if(t.entityId==="tag"){e.push(t)}});return e}},{key:"getEpicList",value:function t(){var e=[];babelHelpers.toConsumableArray(this.allTags.values()).forEach(function(t){if(t.entityId==="epic"){e.push(t)}});return e}},{key:"getEpicByName",value:function t(e){var i=null;babelHelpers.toConsumableArray(this.allTags.values()).forEach(function(t){if(t.entityId==="epic"&&t.name===e){i=t}});return i}},{key:"showTagsDialog",value:function t(i,s){var n=this;var r=i.getCurrentActionsPanel();var a=i.getTags();var o=[];a.forEach(function(t){var e=n.allTags.get(("tag_"+t).trim());if(e){o.push(e)}});var u=function t(){var e=n.tagDialog.getTagSelector().getTextBoxValue();if(!e){n.tagDialog.focusSearch();return}n.addTagToSearcher(e);var i=n.getTagFromSearcher("tag_"+e);var s=n.tagDialog.addItem(i);s.select();n.tagDialog.getTagSelector().clearTextBox();n.tagDialog.focusSearch();n.tagDialog.selectFirstTab();var r=n.tagDialog.getContainer().querySelector(".ui-selector-footer-conjunction");r.textContent=""};var l=false;this.tagDialog=new e.Dialog({id:i.getItemId(),targetNode:s,width:400,height:300,multiple:true,dropdownMode:true,enableSearch:true,selectedItems:o,items:this.getTagsList(),events:{"Item:onSelect":function t(e){l=true;var i=e.getData().item;var s=i.getTitle();n.emit("attachTagToTask",s)},"Item:onDeselect":function t(e){l=true;var i=e.getData().item;var s=i.getTitle();n.emit("deAttachTagToTask",s)}},tagSelectorOptions:{events:{onInput:function t(e){var i=e.getData().selector;if(i){var s=i.getDialog();var n=s.getContainer().querySelector(".ui-selector-footer-conjunction");n.textContent=c.Text.encode(i.getTextBoxValue())}}}},footer:[c.Tag.render(X(),u,c.Loc.getMessage("TASKS_SCRUM_SEARCHER_ACTIONS_TAG_ADD")),c.Tag.render(V())]});r.setBlockBlurNode(this.tagDialog.getContainer());this.tagDialog.subscribe("onHide",function(){if(l){r.destroy();n.emit("hideTagDialog")}});this.tagDialog.show()}},{key:"showEpicDialog",value:function t(i,s){var n=this;var r=i.getCurrentActionsPanel();var a=i.getEpic();var o=[];if(a){var u=this.allTags.get(("epic_"+a.name).trim());if(u){o.push(u)}}var l=false;var d=new e.Dialog({id:i.getItemId(),targetNode:s,width:400,height:300,multiple:false,dropdownMode:true,enableSearch:true,selectedItems:o,items:this.getEpicList(),events:{"Item:onSelect":function t(e){l=true;var i=e.getData().item;var s=i.getId();n.emit("updateItemEpic",s)},"Item:onDeselect":function t(e){setTimeout(function(){l=true;if(d.getSelectedItems().length===0){n.emit("updateItemEpic",0);d.hide()}},50)}},tagSelectorOptions:{placeholder:c.Loc.getMessage("TASKS_SCRUM_ITEM_EPIC_SEARCHER_PLACEHOLDER")}});r.setBlockBlurNode(d.getContainer());d.subscribe("onHide",function(){if(l){r.destroy()}});d.show()}},{key:"showTagsSearchDialog",value:function t(s,n){var r=s.getInputNode();if(this.tagsDialog&&this.tagsDialog.getId()!==s.getNodeId()){this.tagsDialog=null}if(!this.tagsDialog){this.tagsDialog=new e.Dialog({id:s.getNodeId(),targetNode:s.getNode(),width:s.getNode().offsetWidth,height:210,multiple:false,dropdownMode:true,items:this.getTagsList(),events:{"Item:onSelect":function t(e){var s=e.getData().item;var n="#"+s.getTitle();var a=i.getHashTagNamesFromText(r.value);var o=a.length>0?a.pop():"";r.value=r.value.replace(new RegExp("#"+o,"g"),n);r.focus();s.deselect()}}});this.tagsDialog.subscribe("onHide",function(){s.setTagsSearchMode(false)})}s.setTagsSearchMode(true);this.tagsDialog.show();this.tagsDialog.search(n)}},{key:"closeTagsSearchDialog",value:function t(){if(this.tagsDialog){this.tagsDialog.hide()}}},{key:"showEpicSearchDialog",value:function t(s,n){var r=s.getInputNode();if(this.epicDialog&&this.epicDialog.getId()!==s.getNodeId()){this.epicDialog=null}if(!this.epicDialog){this.epicDialog=new e.Dialog({id:s.getNodeId(),targetNode:s.getNode(),width:s.getNode().offsetWidth,height:210,multiple:false,dropdownMode:true,items:this.getEpicList(),events:{"Item:onSelect":function t(e){var n=e.getData().item;var a="@"+n.getTitle();r.value=r.value.replace(new RegExp(i.epicRegExp,"g"),"");r.value=r.value+" "+a;r.focus();n.deselect();s.setEpicId(n.getId())}}});this.epicDialog.subscribe("onHide",function(){s.setEpicSearchMode(false)})}s.setEpicSearchMode(true);this.epicDialog.show();this.epicDialog.search(n)}},{key:"closeEpicSearchDialog",value:function t(){if(this.epicDialog){this.epicDialog.hide()}}}],[{key:"getHashTagNamesFromText",value:function t(e){var s=new RegExp(i.tagRegExp,"g");var n=[];var r;while(r=s.exec(e)){n.push(r[0].substring(1))}return n}},{key:"getHashEpicNamesFromText",value:function t(e){var s=new RegExp(i.epicRegExp,"g");var n=[];var r;while(r=s.exec(e)){n.push(r[0].substring(1))}return n}}]);return i}(d.EventEmitter);babelHelpers.defineProperty(Y,"tagRegExp","#[^#@](?:[^#@]*[^s#@])?");babelHelpers.defineProperty(Y,"epicRegExp","@[^#@](?:[^#@]*[^s#@])?");function j(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div id="','" class="tasks-scrum-input">\n\t\t\t\t<div class="ui-ctl ui-ctl-w100 ui-ctl-textbox">\n\t\t\t\t\t<input type="text" class="ui-ctl-element" placeholder=\n\t\t\t\t\t\t"','" autocomplete="off">\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t']);j=function e(){return t};return t}var W=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.Input");i.nodeId=c.Text.getRandom();i.placeholder=c.Loc.getMessage("TASKS_SCRUM_TASK_ADD_INPUT_TASK_PLACEHOLDER");i.epicId=0;return i}babelHelpers.createClass(e,[{key:"render",value:function t(){return c.Tag.render(j(),c.Text.encode(this.nodeId),c.Text.encode(this.placeholder))}},{key:"disable",value:function t(){this.node.querySelector("input").disabled=true}},{key:"unDisable",value:function t(){this.node.querySelector("input").disabled=false}},{key:"onAfterAppend",value:function t(){var e=this;this.setNode();c.Event.bind(this.getInputNode(),"input",function(t){e.onTagSearch(t);e.onEpicSearch(t)});c.Event.bind(this.getInputNode(),"keydown",this.onKeydown.bind(this))}},{key:"setNode",value:function t(){this.node=document.getElementById(this.nodeId)}},{key:"setPlaceholder",value:function t(e){this.placeholder=e}},{key:"setEpicId",value:function t(e){this.epicId=parseInt(e,10)}},{key:"getNode",value:function t(){return this.node}},{key:"getNodeId",value:function t(){return this.nodeId}},{key:"getInputNode",value:function t(){return this.node.querySelector("input")}},{key:"getEpicId",value:function t(){return this.epicId}},{key:"removeYourself",value:function t(){c.Dom.remove(this.node)}},{key:"setTagsSearchMode",value:function t(e){c.Dom.attr(this.getInputNode(),"data-tag-disabled",e)}},{key:"isTagsSearchMode",value:function t(){return c.Dom.attr(this.getInputNode(),"data-tag-disabled")}},{key:"setEpicSearchMode",value:function t(e){c.Dom.attr(this.getInputNode(),"data-epic-disabled",e)}},{key:"isEpicSearchMode",value:function t(){return c.Dom.attr(this.getInputNode(),"data-epic-disabled")}},{key:"onTagSearch",value:function t(e){var i=e.target;var s=Y.getHashTagNamesFromText(i.value);if(e.data==="#"){this.setEpicSearchMode(false);this.setTagsSearchMode(true)}if(s.length>0&&this.isTagsSearchMode()){var n=s.pop();this.emit("tagsSearchOpen",n)}else{this.emit("tagsSearchClose")}}},{key:"onEpicSearch",value:function t(e){var i=e.target;var s=Y.getHashEpicNamesFromText(i.value);if(e.data==="@"){this.setTagsSearchMode(false);this.setEpicSearchMode(true)}if(s.length>0&&this.isEpicSearchMode()){var n=s.pop();this.emit("epicSearchOpen",n)}else{this.emit("epicSearchClose")}}},{key:"onCreateTaskItem",value:function t(){if(!this.isTagsSearchMode()&&!this.isEpicSearchMode()){var e=this.getInputNode();if(e.value){this.emit("createTaskItem",e.value);e.value="";e.focus()}}}},{key:"onKeydown",value:function t(e){if(e.isComposing||e.keyCode===13){this.onCreateTaskItem()}}}]);return e}(d.EventEmitter);var z=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.Entity");i.setEntityParams(t);i.items=new Map;i.groupMode=false;i.groupModeItems=new Map;i.node=null;i.groupActionsButton=null;i.listItems=null;i.input=new W;return i}babelHelpers.createClass(e,[{key:"setEntityParams",value:function t(e){this.setId(e.id);this.setViews(e.views);this.setNumberTasks(e.numberTasks);this.setStoryPoints(e.storyPoints);this.exactSearchApplied=e.isExactSearchApplied==="Y";this.pageNumberItems=parseInt(e.pageNumberItems,10)}},{key:"addGroupActionsButton",value:function t(e){this.groupActionsButton=e;this.groupActionsButton.subscribe("activateGroupMode",this.onActivateGroupMode.bind(this));this.groupActionsButton.subscribe("deactivateGroupMode",this.onDeactivateGroupMode.bind(this))}},{key:"addListItems",value:function t(e){this.listItems=e}},{key:"getListItems",value:function t(){return this.listItems}},{key:"getNode",value:function t(){return this.node}},{key:"setId",value:function t(e){this.id=c.Type.isInteger(e)?parseInt(e,10):0;if(this.listItems){this.listItems.setEntityId(this.id)}}},{key:"getId",value:function t(){return this.id}},{key:"setViews",value:function t(e){this.views=c.Type.isPlainObject(e)?e:{}}},{key:"getViews",value:function t(){return this.views}},{key:"getEntityType",value:function t(){return"entity"}},{key:"isActive",value:function t(){return false}},{key:"isCompleted",value:function t(){return false}},{key:"getListItemsNode",value:function t(){return this.listItems?this.listItems.getNode():null}},{key:"isEmpty",value:function t(){return this.items.size===0}},{key:"getItems",value:function t(){return this.items}},{key:"getPageNumberItems",value:function t(){return this.pageNumberItems}},{key:"incrementPageNumberItems",value:function t(){this.pageNumberItems++}},{key:"recalculateItemsSort",value:function t(){var e=this;var i=this.getListItemsNode();if(!i){return}var s=1;i.querySelectorAll(".tasks-scrum-item").forEach(function(t){var i=e.getItems().get(parseInt(t.dataset.itemId,10));if(i){i.setSort(s);s++}})}},{key:"getInput",value:function t(){return this.input}},{key:"setItem",value:function t(e){var i=this;this.items.set(e.getItemId(),e);this.subscribeToItem(e);babelHelpers.toConsumableArray(this.items.values()).map(function(t){i.setItemMoveActivity(t)})}},{key:"setItemMoveActivity",value:function t(e){e.setMoveActivity(this.items.size>2)}},{key:"removeItem",value:function t(e){var i=this;if(this.items.has(e.getItemId())){this.items.delete(e.getItemId());e.unsubscribeAll();babelHelpers.toConsumableArray(this.items.values()).map(function(t){i.setItemMoveActivity(t)})}}},{key:"isNodeCreated",value:function t(){return this.node!==null}},{key:"setNumberTasks",value:function t(e){this.numberTasks=c.Type.isInteger(e)?parseInt(e,10):0}},{key:"getNumberTasks",value:function t(){return this.numberTasks?this.numberTasks:this.getItems().size}},{key:"hasInput",value:function t(){return true}},{key:"setExactSearchApplied",value:function t(e){this.exactSearchApplied=Boolean(e)}},{key:"isExactSearchApplied",value:function t(){return this.exactSearchApplied}},{key:"onAfterAppend",value:function t(){var e=this;babelHelpers.toConsumableArray(this.items.values()).map(function(t){e.subscribeToItem(t);e.setItemMoveActivity(t)});if(!this.isCompleted()){this.input.onAfterAppend();this.input.subscribe("tagsSearchOpen",function(t){e.emit("tagsSearchOpen",{inputObject:t.getTarget(),enteredHashTagName:t.getData()})});this.input.subscribe("tagsSearchClose",function(){return e.emit("tagsSearchClose")});this.input.subscribe("epicSearchOpen",function(t){e.emit("epicSearchOpen",{inputObject:t.getTarget(),enteredHashEpicName:t.getData()})});this.input.subscribe("epicSearchClose",function(){return e.emit("epicSearchClose")});this.input.subscribe("createTaskItem",function(t){e.emit("createTaskItem",{inputObject:t.getTarget(),value:t.getData()})})}this.updateStoryPointsNode()}},{key:"subscribeToItem",value:function t(e){var i=this;if(!this.getListItemsNode()){return}e.onAfterAppend(this.getListItemsNode());e.setEntityType(this.getEntityType());e.subscribe("updateItem",function(t){i.emit("updateItem",t.getData())});e.subscribe("updateStoryPoints",function(){if(e.isSubTask()){var t=i.getItemBySourceId(e.getParentTaskId());if(t){t.updateSubTasksPoints(e.getSourceId(),e.getStoryPoints())}}});e.subscribe("showTask",function(t){return i.emit("showTask",t.getTarget())});e.subscribe("move",function(t){i.emit("moveItem",{item:t.getTarget(),button:t.getData()})});e.subscribe("moveToSprint",function(t){i.emit("moveToSprint",{item:t.getTarget(),button:t.getData()})});e.subscribe("attachFilesToTask",function(t){i.emit("attachFilesToTask",{item:t.getTarget(),attachedIds:t.getData()})});e.subscribe("dod",function(t){i.emit("showDod",t.getTarget())});e.subscribe("showTagSearcher",function(t){i.emit("showTagSearcher",{item:t.getTarget(),button:t.getData()})});e.subscribe("showEpicSearcher",function(t){i.emit("showEpicSearcher",{item:t.getTarget(),button:t.getData()})});e.subscribe("startDecomposition",function(t){i.emit("startDecomposition",t.getTarget())});e.subscribe("remove",function(t){if(i.isGroupMode()){i.getGroupModeItems().forEach(function(t){i.removeItem(t);t.removeYourself()})}else{var s=t.getTarget();i.removeItem(s);s.removeYourself()}i.emit("removeItem",e)});e.subscribe("changeTaskResponsible",function(t){var e=t.getTarget();i.emit("changeTaskResponsible",e)});e.subscribe("filterByEpic",function(t){i.emit("filterByEpic",t.getData())});e.subscribe("filterByTag",function(t){i.emit("filterByTag",t.getData())});e.subscribe("addItemToGroupMode",function(t){i.addItemToGroupMode(t.getTarget())});e.subscribe("removeItemFromGroupMode",function(t){i.removeItemFromGroupMode(t.getTarget())})}},{key:"getItemByItemId",value:function t(e){return this.items.get(c.Type.isInteger(e)?parseInt(e,10):e)}},{key:"getItemBySourceId",value:function t(e){return babelHelpers.toConsumableArray(this.items.values()).find(function(t){return t.getSourceId()===e})}},{key:"getItemsByParentTaskId",value:function t(e){var i=new Map;babelHelpers.toConsumableArray(this.items.values()).map(function(t){if(t.getParentTaskId()===e){i.set(t.getItemId(),t)}});return i}},{key:"setStoryPoints",value:function t(e){this.storyPoints=new N;this.storyPoints.addPoints(e);this.updateStoryPointsNode()}},{key:"getStoryPoints",value:function t(){return this.storyPoints}},{key:"isFirstItem",value:function t(e){var i=this.getListItemsNode();var s=e.getItemNode();var n=this.hasInput()?i.firstElementChild.nextElementSibling:i.firstElementChild;return n.isEqualNode(s)}},{key:"isLastItem",value:function t(e){var i=this.getListItemsNode();var s=e.getItemNode();return i.lastElementChild.isEqualNode(s)}},{key:"fadeOut",value:function t(){this.getListItemsNode().classList.add("tasks-scrum-entity-items-faded")}},{key:"fadeIn",value:function t(){this.getListItemsNode().classList.remove("tasks-scrum-entity-items-faded")}},{key:"deactivateGroupMode",value:function t(){this.groupActionsButton.deactivateGroupMode()}},{key:"onActivateGroupMode",value:function t(e){this.groupMode=true;this.input.disable();this.emit("activateGroupMode")}},{key:"onDeactivateGroupMode",value:function t(e){this.groupMode=false;this.input.unDisable();this.groupModeItems.forEach(function(t){t.deactivateGroupMode()});this.groupModeItems.clear();this.emit("deactivateGroupMode")}},{key:"isGroupMode",value:function t(){return this.groupMode}},{key:"addItemToGroupMode",value:function t(e){this.groupModeItems.set(e.getItemId(),e)}},{key:"getGroupModeItems",value:function t(){return this.groupModeItems}},{key:"removeItemFromGroupMode",value:function t(e){this.groupModeItems.delete(e.getItemId())}},{key:"bindItemsLoader",value:function t(e){var i=this;this.setActiveLoadItems(false);if(typeof IntersectionObserver==="undefined"){return}var s=new IntersectionObserver(function(t){if(t[0].isIntersecting===true){if(!i.isActiveLoadItems()){i.emit("loadItems")}}},{threshold:[0]});s.observe(e)}},{key:"setActiveLoadItems",value:function t(e){this.activeLoadItems=Boolean(e)}},{key:"isActiveLoadItems",value:function t(){return this.activeLoadItems}},{key:"showItemsLoader",value:function t(){var e=c.Dom.getPosition(this.itemsLoaderNode);var i=new r.Loader({target:this.itemsLoaderNode,size:60,mode:"inline",color:"rgba(82, 92, 105, 0.9)",offset:{left:"".concat(e.width/2-30,"px")}});i.show();return i}},{key:"updateStoryPointsNode",value:function t(){}}]);return e}(d.EventEmitter);function Z(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-backlog-title">\n\t\t\t\t','\n\t\t\t</div>\n\t\t\t<div class="tasks-scrum-backlog-epics-title ui-btn ui-btn-xs ui-btn-secondary">\n\t\t\t\t','\n\t\t\t</div>\n\t\t\t<div title="Definition of Done" class="tasks-scrum-entity-title-btn tasks-scrum-entity-title-btn-dod">\n\t\t\t\t<span class="tasks-scrum-entity-dod-icon"></span>\n\t\t\t</div>\n\t\t\t<div class="tasks-scrum-backlog-title-spacer"></div>\n\t\t\t<div class="tasks-scrum-entity-title-btn tasks-scrum-entity-title-btn-task">\n\t\t\t\t<span class="tasks-scrum-entity-tasks-icon"></span>\n\t\t\t\t<span class="tasks-scrum-entity-tasks-title">\n\t\t\t\t\t','\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t\t<div class="tasks-scrum-backlog-story-point-title">\n\t\t\t\t','\n\t\t\t</div>\n\t\t\t<div class="tasks-scrum-backlog-story-point">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"]);Z=function e(){return t};return t}var Q=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.BacklogHeader");i.entity=t;i.element=null;return i}babelHelpers.createClass(e,[{key:"render",value:function t(){var e=this;this.element=c.Tag.render(Z(),c.Loc.getMessage("TASKS_SCRUM_BACKLOG_TITLE"),c.Loc.getMessage("TASKS_SCRUM_BACKLOG_EPICS_TITLE"),this.entity.getNumberTasks(),c.Loc.getMessage("TASKS_SCRUM_BACKLOG_TITLE_STORY_POINTS"),c.Text.encode(this.entity.getStoryPoints().getPoints()));c.Event.bind(this.getElementByClassName(this.element,"tasks-scrum-backlog-epics-title"),"click",function(){e.emit("openListEpicGrid")});c.Event.bind(this.getElementByClassName(this.element,"tasks-scrum-entity-title-btn-dod"),"click",function(){e.emit("openDefinitionOfDone")});return this.element}},{key:"setStoryPoints",value:function t(e){this.getElementByClassName(this.element,"tasks-scrum-backlog-story-point").textContent=c.Text.encode(e)}},{key:"updateNumberTasks",value:function t(){var e=this.getElementByClassName(this.element,"tasks-scrum-entity-title-btn-task");e.querySelector(".tasks-scrum-entity-tasks-title").textContent=this.entity.getNumberTasks()}},{key:"getElementByClassName",value:function t(e,i){var s=null;e.forEach(function(t){if(t.classList.contains(i)){s=t}});return s}}]);return e}(d.EventEmitter);function J(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<a class="ui-link ui-link-dashed ui-link-secondary tasks-scrum-action-epic">\n\t\t\t\t',"\n\t\t\t</a>\n\t\t"]);J=function e(){return t};return t}var $=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t.setEventNamespace("BX.Tasks.Scrum.EpicCreationButton");return t}babelHelpers.createClass(e,[{key:"render",value:function t(){var e=c.Tag.render(J(),c.Loc.getMessage("TASKS_SCRUM_BACKLOG_LIST_ACTIONS_EPIC_ADD"));c.Event.bind(e,"click",this.onClick.bind(this));return e}},{key:"onClick",value:function t(){this.emit("openAddEpicForm")}}]);return e}(d.EventEmitter);function tt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-backlog">\n\t\t\t\t<div class="tasks-scrum-backlog-header">\n\t\t\t\t\t','\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-backlog-actions">\n\t\t\t\t\t',"\n\t\t\t\t\t",'\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-backlog-items">\n\t\t\t\t\t','\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-entity-items-loader"></div>\n\t\t\t</div>\n\t\t']);tt=function e(){return t};return t}var et=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.Backlog");i.setBacklogParams(t);i.header=null;i.epicCreationButton=null;return i}babelHelpers.createClass(e,[{key:"setBacklogParams",value:function t(e){var i=this;e.items.forEach(function(t){var e=new O(t);i.items.set(e.itemId,e)})}},{key:"addHeader",value:function t(e){var i=this;this.header=e;this.header.subscribe("openListEpicGrid",function(){return i.emit("openListEpicGrid")});this.header.subscribe("openDefinitionOfDone",function(){return i.emit("openDefinitionOfDone")})}},{key:"addEpicCreationButton",value:function t(e){var i=this;this.epicCreationButton=e;this.epicCreationButton.subscribe("openAddEpicForm",function(){return i.emit("openAddEpicForm")})}},{key:"getEntityType",value:function t(){return"backlog"}},{key:"isDisabled",value:function t(){return false}},{key:"render",value:function t(){this.node=c.Tag.render(tt(),this.header?this.header.render():"",this.epicCreationButton?this.epicCreationButton.render():"",this.groupActionsButton?this.groupActionsButton.render():"",this.listItems?this.listItems.render():"");this.itemsLoaderNode=this.node.querySelector(".tasks-scrum-entity-items-loader");this.bindItemsLoader(this.itemsLoaderNode);return this.node}},{key:"setNumberTasks",value:function t(i){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"setNumberTasks",this).call(this,i);if(this.header){this.header.updateNumberTasks()}}},{key:"onActivateGroupMode",value:function t(i){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"onActivateGroupMode",this).call(this,i);c.Dom.addClass(this.node.querySelector(".tasks-scrum-backlog-items"),"tasks-scrum-backlog-items-group-mode")}},{key:"onDeactivateGroupMode",value:function t(i){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"onDeactivateGroupMode",this).call(this,i);c.Dom.removeClass(this.node.querySelector(".tasks-scrum-backlog-items"),"tasks-scrum-backlog-items-group-mode")}},{key:"updateStoryPointsNode",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"updateStoryPointsNode",this).call(this);if(this.header){this.header.setStoryPoints(this.getStoryPoints().getPoints())}}}],[{key:"buildBacklog",value:function t(i){var s=new e(i);s.addHeader(new Q(s));s.addEpicCreationButton(new $);s.addGroupActionsButton(new x);s.addListItems(new K(s));return s}}]);return e}(z);function it(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div id="','" class="tasks-scrum-sprint-date">\n\t\t\t\t<div class="tasks-scrum-sprint-date-start">','</div>\n\t\t\t\t<div class="tasks-scrum-sprint-date-separator">-</div>\n\t\t\t\t<div class="tasks-scrum-sprint-date-end">','</div>\n\t\t\t\t<input type="hidden" name="dateStart">\n\t\t\t\t<input type="hidden" name="dateEnd">\n\t\t\t</div>\n\t\t']);it=function e(){return t};return t}var st=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.SprintDate");i.sprint=t;i.nodeId="tasks-scrum-sprint-header-date-"+c.Text.getRandom();i.defaultSprintDuration=t.getDefaultSprintDuration();return i}babelHelpers.createClass(e,[{key:"createDate",value:function t(){if(this.sprint.isActive()||this.sprint.isCompleted()){return""}return this.renderNode(this.nodeId,this.getFormattedDateStart(),this.getFormattedDateEnd())}},{key:"renderNode",value:function t(e,i,s){return c.Tag.render(it(),e,i,s)}},{key:"updateDateStartNode",value:function t(e){if(this.node){var i=this.node.querySelector(".tasks-scrum-sprint-date-start");i.textContent=BX.date.format("j F",e)}}},{key:"updateDateEndNode",value:function t(e){if(this.node){var i=this.node.querySelector(".tasks-scrum-sprint-date-end");i.textContent=BX.date.format("j F",e)}}},{key:"onAfterAppend",value:function t(){var e=this;if(this.sprint.isActive()||this.sprint.isCompleted()){return}this.node=document.getElementById(this.nodeId);var i=this.node.closest(".popup-window");var s=function t(){BX.calendar.get().popup.close()};var n=function t(e,n){BX.calendar({node:e,field:n,bTime:false,bSetFocus:false,bHideTime:false});if(i){c.Event.bindOnce(i,"click",s)}};var r=function t(e,i){e.textContent=BX.date.format("j F",Math.floor(BX.parseDate(i).getTime()/1e3))};var a=function t(i){e.emit("changeSprintDeadline",i)};var o=this.node.querySelector(".tasks-scrum-sprint-date-start");var u=this.node.querySelector(".tasks-scrum-sprint-date-end");var l=this.node.querySelector('input[name="dateStart"]');var d=this.node.querySelector('input[name="dateEnd"]');c.Event.bind(this.node,"click",function(t){var e=t.target;if(e.classList.contains("tasks-scrum-sprint-date-start")){n(e,l)}else if(e.classList.contains("tasks-scrum-sprint-date-end")){n(e,d)}t.stopPropagation()});c.Event.bind(l,"change",function(t){var n=t.target.value;r(o,n);a({sprintId:e.sprint.getId(),dateStart:Math.floor(BX.parseDate(n).getTime()/1e3)});if(i){c.Event.unbind(i,"click",s)}});c.Event.bind(d,"change",function(t){var n=t.target.value;r(u,n);a({sprintId:e.sprint.getId(),dateEnd:Math.floor(BX.parseDate(n).getTime()/1e3)});if(i){c.Event.unbind(i,"click",s)}})}},{key:"getWeeks",value:function t(){var e=parseInt(this.defaultSprintDuration,10)/604800;if(e>5){return e+" "+c.Loc.getMessage("TASKS_SCRUM_DATE_WEEK_NAME_3")}else if(e===1){return e+" "+c.Loc.getMessage("TASKS_SCRUM_DATE_WEEK_NAME_1")}else{return e+" "+c.Loc.getMessage("TASKS_SCRUM_DATE_WEEK_NAME_2")}}},{key:"getFormattedTitleDatePeriod",value:function t(){return this.getFormattedDateStart()+" - "+this.getFormattedDateEnd()}},{key:"getFormattedDateStart",value:function t(){return BX.date.format("j F",this.sprint.getDateStart())}},{key:"getFormattedDateEnd",value:function t(){return BX.date.format("j F",this.sprint.getDateEnd())}}]);return e}(d.EventEmitter);var nt=function(){function t(){babelHelpers.classCallCheck(this,t)}babelHelpers.createClass(t,[{key:"calculatePercentage",value:function t(e,i){if(e===0){return 0}var s=Math.round(i*100/e);return isNaN(s)?0:s}}]);return t}();var rt=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.StatsHeader");i.setSprintData(t);i.statsCalculator=new nt;i.weekendDaysTime=t.getWeekendDaysTime();i.headerNode=null;i.headerClass="tasks-scrum-sprint-header-stats";i.kanbanMode=false;return i}babelHelpers.createClass(e,[{key:"setKanbanStyle",value:function t(){this.kanbanMode=true;this.headerClass="tasks-scrum-sprint-header-stats-kanban"}},{key:"isKanbanMode",value:function t(){return this.kanbanMode}},{key:"render",value:function t(){return""}},{key:"updateStats",value:function t(e){this.setSprintData(e);c.Dom.replace(this.headerNode,this.render())}},{key:"setSprintData",value:function t(e){this.setSprintDate(e);this.setStoryPoints(e.getStoryPoints().getPoints());this.setCompletedStoryPoints(e.getCompletedStoryPoints().getPoints());this.setUncompletedStoryPoints(e.getUncompletedStoryPoints().getPoints());this.setEndDate(e.getDateEnd())}},{key:"setSprintDate",value:function t(e){this.sprintDate=new st(e)}},{key:"getSprintDate",value:function t(){return this.sprintDate}},{key:"setStoryPoints",value:function t(e){if(c.Type.isUndefined(e)||isNaN(parseFloat(e))){this.storyPoints=0}else{this.storyPoints=parseFloat(e)}}},{key:"getStoryPoints",value:function t(){return this.storyPoints}},{key:"setCompletedStoryPoints",value:function t(e){if(c.Type.isUndefined(e)||isNaN(parseFloat(e))){this.completedStoryPoints=0}else{this.completedStoryPoints=parseFloat(e)}}},{key:"getCompletedStoryPoints",value:function t(){return this.completedStoryPoints}},{key:"setUncompletedStoryPoints",value:function t(e){if(c.Type.isUndefined(e)||isNaN(parseFloat(e))){this.uncompletedStoryPoints=0}else{this.uncompletedStoryPoints=parseFloat(e)}}},{key:"getUncompletedStoryPoints",value:function t(){return this.completedStoryPoints}},{key:"setEndDate",value:function t(e){if(c.Type.isUndefined(e)||isNaN(parseInt(e,10))){this.endDate=Date.now()/1e3}else{this.endDate=parseInt(e,10)}}},{key:"getEndDate",value:function t(){return this.endDate}}]);return e}(d.EventEmitter);function at(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="','" title="','">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"]);at=function e(){return t};return t}var ot=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).apply(this,arguments))}babelHelpers.createClass(e,[{key:"render",value:function t(){var e=this.statsCalculator.calculatePercentage(this.getStoryPoints(),this.getCompletedStoryPoints());var i=this.getCompletedDate(this.getEndDate());var s=c.Loc.getMessage("TASKS_SCRUM_SPRINT_STATS_COMPLETED_LABEL").replace("#percent#",e).replace("#date#",i);var n=this.getSprintDate().getFormattedTitleDatePeriod();this.headerNode=c.Tag.render(at(),this.headerClass,n,s);return this.headerNode}},{key:"getCompletedDate",value:function t(e){return BX.date.format("j F Y",e)}}]);return e}(rt);function ut(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="','" title="','">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"]);ut=function e(){return t};return t}var lt=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).apply(this,arguments))}babelHelpers.createClass(e,[{key:"render",value:function t(){var e=this.statsCalculator.calculatePercentage(this.getStoryPoints(),this.getCompletedStoryPoints());var i=this.getExpiredDay(this.getEndDate());var s=c.Loc.getMessage("TASKS_SCRUM_SPRINT_STATS_EXPIRED_LABEL").replace("#percent#",e).replace("#date#",i);var n=this.getSprintDate().getFormattedTitleDatePeriod();this.headerNode=c.Tag.render(ut(),this.headerClass,n,s);return this.headerNode}},{key:"getExpiredDay",value:function t(e){return BX.date.format("j F Y",e)}}]);return e}(rt);function ct(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="','" title="','">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"]);ct=function e(){return t};return t}var dt=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).apply(this,arguments))}babelHelpers.createClass(e,[{key:"render",value:function t(){var e=this.getRemainingDays(this.getEndDate());var i=this.statsCalculator.calculatePercentage(this.getStoryPoints(),this.getCompletedStoryPoints());var s="";if(c.Type.isInteger(e)&&e<=1){s=c.Loc.getMessage("TASKS_SCRUM_SPRINT_STATS_ACTIVE_LAST_LABEL").replace("#percent#",i)}else{s=c.Loc.getMessage("TASKS_SCRUM_SPRINT_STATS_ACTIVE_LABEL").replace("#days#",e).replace("#percent#",i)}var n=this.getSprintDate().getFormattedTitleDatePeriod();this.headerNode=c.Tag.render(ct(),this.headerClass,n,s);return this.headerNode}},{key:"getRemainingDays",value:function t(e){var i=new Date;i.setSeconds(i.getSeconds()+this.weekendDaysTime);i.setHours(0,0,0,0);var s=new Date(e*1e3);var n=60*1e3;var r=n*60;var a=r*24;var o=Math.round((s-i)/a);if(o<=1){return o}else{return BX.date.format("ddiff",i,s)}}}]);return e}(rt);var pt=function(){function t(){babelHelpers.classCallCheck(this,t)}babelHelpers.createClass(t,null,[{key:"build",value:function t(e){if(e.isCompleted()){return new ot(e)}else if(e.isExpired()){return new lt(e)}else if(e.isActive()){return new dt(e)}else{return new rt(e)}}}]);return t}();function ht(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div id="','" class="tasks-scrum-sprint-header-button">\n\t\t\t\t\t<button class="','">',"</button>\n\t\t\t\t</div>\n\t\t\t"]);ht=function e(){return t};return t}function mt(){var t=babelHelpers.taggedTemplateLiteral(['<div class="tasks-scrum-sprint-header-remove"></div>']);mt=function e(){return t};return t}function vt(){var t=babelHelpers.taggedTemplateLiteral(['<div class="tasks-scrum-sprint-header-empty"></div>']);vt=function e(){return t};return t}function gt(){var t=babelHelpers.taggedTemplateLiteral(['<div class="tasks-scrum-sprint-dragndrop"></div>']);gt=function e(){return t};return t}function ft(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-sprint-header-params">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t\t",'\n\t\t\t\t<div class="tasks-scrum-sprint-header-tick">\n\t\t\t\t\t<div class="ui-btn ui-btn-sm ui-btn-light ','"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t']);ft=function e(){return t};return t}function bt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-sprint-header ','">\n\t\t\t\t','\n\t\t\t\t<div class="tasks-scrum-sprint-header-name-container">\n\t\t\t\t\t<div class="tasks-scrum-sprint-header-name">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-sprint-header-edit"></div>\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t</div>\n\t\t"]);bt=function e(){return t};return t}var yt=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.SprintHeader");i.sprint=t;i.node=null;i.statsHeader=null;i.sprintDate=null;return i}babelHelpers.createClass(e,[{key:"addHeaderStats",value:function t(e){this.statsHeader=e}},{key:"addHeaderDate",value:function t(e){var i=this;this.sprintDate=e;this.sprintDate.subscribe("changeSprintDeadline",function(t){i.emit("changeSprintDeadline",t.getData())})}},{key:"initStyle",value:function t(e){this.sprint=e;if(this.sprint.isActive()){this.headerClass="tasks-scrum-sprint-header-active";this.buttonClass="ui-btn ui-btn-success ui-btn-xs";this.buttonText=c.Loc.getMessage("TASKS_SCRUM_SPRINT_TITLE_COMPLETE_BUTTON")}else if(this.sprint.isCompleted()){this.headerClass="tasks-scrum-sprint-header-completed";c.Dom.remove(this.buttonNode);this.sprint.hideContent()}else if(this.sprint.isPlanned()){this.headerClass="tasks-scrum-sprint-header-planned";this.buttonClass="ui-btn ui-btn-primary ui-btn-xs";this.buttonText=c.Loc.getMessage("TASKS_SCRUM_SPRINT_TITLE_START_BUTTON")}if(this.node){this.addHeaderStats(pt.build(this.sprint));this.addHeaderDate(new st(this.sprint));if(this.sprint.isDisabled()){c.Dom.remove(this.node.querySelector(".tasks-scrum-sprint-header-remove"))}this.node.className="";c.Dom.addClass(this.node,"tasks-scrum-sprint-header "+this.headerClass);var i=this.buttonNode.querySelector("button");i.className="";c.Dom.addClass(i,this.buttonClass);i.firstChild.replaceWith(this.buttonText);c.Dom.replace(this.node.querySelector(".tasks-scrum-sprint-header-params"),this.renderParams())}}},{key:"render",value:function t(){this.node=c.Tag.render(bt(),this.headerClass,this.renderDragnDrop(),c.Text.encode(this.sprint.getName()),this.renderRemove(),this.renderParams());return this.node}},{key:"renderParams",value:function t(){var e=this.sprint.isCompleted()?"ui-btn-icon-angle-down":"ui-btn-icon-angle-up";return c.Tag.render(ft(),this.renderStatsHeader(),this.sprintDate?this.sprintDate.createDate():"",this.createButton(),e)}},{key:"getStatsHeader",value:function t(){return this.statsHeader}},{key:"renderDragnDrop",value:function t(){if(this.sprint.isPlanned()){return c.Tag.render(gt())}else{return c.Tag.render(vt())}}},{key:"renderRemove",value:function t(){if(this.sprint.isPlanned()){return c.Tag.render(mt())}else{return""}}},{key:"renderStatsHeader",value:function t(){return this.statsHeader?this.statsHeader.render():""}},{key:"updateNameNode",value:function t(e){if(this.node){this.node.querySelector(".tasks-scrum-sprint-header-name").textContent=c.Text.encode(e)}}},{key:"updateStatsHeader",value:function t(){this.statsHeader.updateStats(this.sprint)}},{key:"updateDateStartNode",value:function t(e){if(this.sprintDate){this.sprintDate.updateDateStartNode(e)}}},{key:"updateDateEndNode",value:function t(e){if(this.sprintDate){this.sprintDate.updateDateEndNode(e)}}},{key:"createButton",value:function t(){if(this.sprint.isCompleted()){return""}else{this.buttonNodeId="tasks-scrum-sprint-header-button-"+this.sprint.getId();return c.Tag.render(ht(),this.buttonNodeId,this.buttonClass,this.buttonText)}}},{key:"onAfterAppend",value:function t(){var e=this;if(!this.sprint.isCompleted()){this.buttonNode=document.getElementById(this.buttonNodeId);c.Event.bind(this.buttonNode,"click",this.onButtonClick.bind(this))}var i=this.node.querySelector(".tasks-scrum-sprint-header-name-container");var s=this.node.querySelector(".tasks-scrum-sprint-header-edit");c.Event.bind(s,"click",function(){return e.emit("changeName",i)});if(this.sprint.isPlanned()){var n=this.node.querySelector(".tasks-scrum-sprint-header-remove");c.Event.bind(n,"click",function(){u.MessageBox.confirm(c.Loc.getMessage("TASKS_SCRUM_CONFIRM_TEXT_REMOVE_SPRINT"),function(t){e.emit("removeSprint");t.close()},c.Loc.getMessage("TASKS_SCRUM_BUTTON_TEXT_REMOVE"))})}var r=this.node.querySelector(".tasks-scrum-sprint-header-tick");c.Event.bind(r,"click",function(){r.firstElementChild.classList.toggle("ui-btn-icon-angle-up");r.firstElementChild.classList.toggle("ui-btn-icon-angle-down");e.emit("toggleVisibilityContent")});if(this.sprintDate){this.sprintDate.onAfterAppend()}}},{key:"upTick",value:function t(){if(!this.node){return}var e=this.node.querySelector(".tasks-scrum-sprint-header-tick");c.Dom.removeClass(e.firstElementChild,"ui-btn-icon-angle-down");c.Dom.addClass(e.firstElementChild,"ui-btn-icon-angle-up")}},{key:"downTick",value:function t(){if(!this.node){return}var e=this.node.querySelector(".tasks-scrum-sprint-header-tick");c.Dom.removeClass(e.firstElementChild,"ui-btn-icon-angle-up");c.Dom.addClass(e.firstElementChild,"ui-btn-icon-angle-down")}},{key:"onButtonClick",value:function t(){if(this.sprint.isActive()){this.emit("completeSprint")}else if(this.sprint.isPlanned()){this.emit("startSprint")}}}],[{key:"buildHeader",value:function t(i){var s=new e(i);s.addHeaderStats(pt.build(i));s.addHeaderDate(new st(i));return s}}]);return e}(d.EventEmitter);function kt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<a class="ui-link">\n\t\t\t\t',"\n\t\t\t</a>\n\t\t"]);kt=function e(){return t};return t}var St=function(){function t(){babelHelpers.classCallCheck(this,t);this.element=null}babelHelpers.createClass(t,[{key:"render",value:function t(){this.element=c.Tag.render(kt(),c.Loc.getMessage("TASKS_SCRUM_SPRINT_TITLE_EVENT"));return this.element}}]);return t}();function Tt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-entity-title-btn tasks-scrum-entity-title-btn-burn-down-chart">\n\t\t\t\t<span class="tasks-scrum-entity-burn-down-chart-icon"></span>\n\t\t\t</div>\n\t\t']);Tt=function e(){return t};return t}function It(){var t=babelHelpers.taggedTemplateLiteral(["\n\t\t\t",'\n\t\t\t<div class="tasks-scrum-entity-title-btn tasks-scrum-entity-title-btn-task">\n\t\t\t\t<span class="tasks-scrum-entity-tasks-icon"></span>\n\t\t\t\t<span class="tasks-scrum-entity-tasks-title">\n\t\t\t\t\t',"\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t\t","\n\t\t\t","\n\t\t\t","\n\t\t"]);It=function e(){return t};return t}function Ct(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-sprint-story-point-done-title">\n\t\t\t\t','\n\t\t\t</div>\n\t\t\t<div class="tasks-scrum-sprint-story-point tasks-scrum-sprint-story-point-done">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"]);Ct=function e(){return t};return t}function Et(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-sprint-story-point-in-work-title">\n\t\t\t\t','\n\t\t\t</div>\n\t\t\t<div class="tasks-scrum-sprint-story-point tasks-scrum-sprint-story-point-in-work">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"]);Et=function e(){return t};return t}function Pt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-sprint-story-point-title">\n\t\t\t\t','\n\t\t\t</div>\n\t\t\t<div class="tasks-scrum-sprint-story-point">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"]);Pt=function e(){return t};return t}var At=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.StoryPointsHeader");i.sprint=t;i.element=null;return i}babelHelpers.createClass(e,[{key:"render",value:function t(){var e=this;this.storyPointsNode=c.Tag.render(Pt(),c.Loc.getMessage("TASKS_SCRUM_SPRINT_TITLE_STORY_POINTS"),this.sprint.getStoryPoints().getPoints());this.inWorkStoryPointsNode=this.sprint.isActive()?c.Tag.render(Et(),c.Loc.getMessage("TASKS_SCRUM_SPRINT_TITLE_STORY_POINTS_IN_WORK"),this.sprint.getUncompletedStoryPoints().getPoints()):"";this.doneStoryPointsNode=this.sprint.isPlanned()?"":c.Tag.render(Ct(),c.Loc.getMessage("TASKS_SCRUM_SPRINT_TITLE_STORY_POINTS_DONE"),this.sprint.getCompletedStoryPoints().getPoints());this.element=c.Tag.render(It(),this.renderBurnDownChartIcon(),this.sprint.getNumberTasks(),this.storyPointsNode,this.inWorkStoryPointsNode,this.doneStoryPointsNode);c.Event.bind(this.getElementByClassName(this.element,"tasks-scrum-entity-title-btn-burn-down-chart"),"click",function(){return e.emit("showSprintBurnDownChart")});return this.element}},{key:"renderBurnDownChartIcon",value:function t(){if(this.sprint.isPlanned()){return""}return c.Tag.render(Tt())}},{key:"updateNumberTasks",value:function t(){var e=this.getElementByClassName(this.element,"tasks-scrum-entity-title-btn-task");e.querySelector(".tasks-scrum-entity-tasks-title").textContent=this.sprint.getNumberTasks()}},{key:"setStoryPoints",value:function t(e){if(!this.storyPointsNode){return}this.getElementByClassName(this.storyPointsNode,"tasks-scrum-sprint-story-point").textContent=c.Text.encode(e)}},{key:"setCompletedStoryPoints",value:function t(e){if(!this.doneStoryPointsNode){return}this.getElementByClassName(this.doneStoryPointsNode,"tasks-scrum-sprint-story-point-done").textContent=c.Text.encode(e)}},{key:"setUncompletedStoryPoints",value:function t(e){if(!this.inWorkStoryPointsNode){return}this.getElementByClassName(this.inWorkStoryPointsNode,"tasks-scrum-sprint-story-point-in-work").textContent=c.Text.encode(e)}},{key:"getElementByClassName",value:function t(e,i){var s=null;e.forEach(function(t){if(t.classList.contains(i)){s=t}});return s}}]);return e}(d.EventEmitter);function Dt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input type="text" class="tasks-scrum-sprint-header-name" value="','">\n\t\t\t']);Dt=function e(){return t};return t}function wt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<a href="','">\n\t\t\t\t',"\n\t\t\t</a>\n\t\t"]);wt=function e(){return t};return t}function Nt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-sprint-header-event-params">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"]);Nt=function e(){return t};return t}function Lt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-sprint" data-sprint-sort="','" data-sprint-id="','">\n\t\t\t\t','\n\t\t\t\t<div class="tasks-scrum-sprint-content">\n\t\t\t\t\t<div class="tasks-scrum-sprint-sub-header">\n\t\t\t\t\t\t<div class="tasks-scrum-sprint-header-event">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t","\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t",'\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-sprint-actions">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-sprint-items">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-entity-items-loader"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t']);Lt=function e(){return t};return t}var Mt=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.Sprint");i.setSprintParams(t);i.sprintHeader=null;i.eventsHeader=null;i.storyPointsHeader=null;return i}babelHelpers.createClass(e,[{key:"setSprintParams",value:function t(e){this.setTmpId(e.tmpId);this.setName(e.name);this.setSort(e.sort);this.setDateStart(e.dateStart);this.setDateEnd(e.dateEnd);this.setWeekendDaysTime(e.weekendDaysTime);this.setDefaultSprintDuration(e.defaultSprintDuration);this.setStatus(e.status);this.setCompletedStoryPoints(e.completedStoryPoints);this.setUncompletedStoryPoints(e.uncompletedStoryPoints);this.setCompletedTasks(e.completedTasks);this.setUncompletedTasks(e.uncompletedTasks);this.setItems(e.items);this.setInfo(e.info)}},{key:"addSprintHeader",value:function t(e){var i=this;this.sprintHeader=e;this.sprintHeader.initStyle(this);this.sprintHeader.subscribe("changeName",this.onChangeName.bind(this));this.sprintHeader.subscribe("removeSprint",this.onRemoveSprint.bind(this));this.sprintHeader.subscribe("completeSprint",function(){return i.emit("completeSprint")});this.sprintHeader.subscribe("startSprint",function(){return i.emit("startSprint")});this.sprintHeader.subscribe("changeSprintDeadline",this.onChangeSprintDeadline.bind(this));this.sprintHeader.subscribe("toggleVisibilityContent",this.toggleVisibilityContent.bind(this))}},{key:"addStoryPointsHeader",value:function t(e){var i=this;this.storyPointsHeader=e;this.storyPointsHeader.subscribe("showSprintBurnDownChart",function(){return i.emit("showSprintBurnDownChart")})}},{key:"addEventsHeader",value:function t(e){this.eventsHeader=e}},{key:"initStyle",value:function t(){if(this.sprintHeader){this.sprintHeader.initStyle(this)}}},{key:"isActive",value:function t(){return this.getStatus()==="active"}},{key:"isPlanned",value:function t(){return this.getStatus()==="planned"}},{key:"isCompleted",value:function t(){return this.getStatus()==="completed"}},{key:"isDisabled",value:function t(){return this.isCompleted()}},{key:"isExpired",value:function t(){var e=new Date(this.dateEnd*1e3);return this.isActive()&&e.getTime()<(new Date).getTime()}},{key:"hasInput",value:function t(){return!this.isDisabled()}},{key:"getEntityType",value:function t(){return"sprint"}},{key:"setItem",value:function t(i){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"setItem",this).call(this,i);i.setDisableStatus(this.isDisabled())}},{key:"setName",value:function t(e){this.name=c.Type.isString(e)?e:"";if(this.isNodeCreated()&&this.sprintHeader){this.sprintHeader.updateNameNode(this.name)}}},{key:"getName",value:function t(){return this.name}},{key:"setTmpId",value:function t(e){this.tmpId=c.Type.isString(e)?e:""}},{key:"getTmpId",value:function t(){return this.tmpId}},{key:"setSort",value:function t(e){this.sort=c.Type.isInteger(e)?parseInt(e,10):1}},{key:"getSort",value:function t(){return this.sort}},{key:"setDateStart",value:function t(e){this.dateStart=c.Type.isInteger(e)?parseInt(e,10):0;if(this.isNodeCreated()&&this.sprintHeader){this.sprintHeader.updateDateStartNode(this.dateStart)}}},{key:"getDateStart",value:function t(){return parseInt(this.dateStart,10)}},{key:"setDateEnd",value:function t(e){this.dateEnd=c.Type.isInteger(e)?parseInt(e,10):0;if(this.isNodeCreated()&&this.sprintHeader){this.sprintHeader.updateDateEndNode(this.dateEnd)}}},{key:"getDateEnd",value:function t(){return parseInt(this.dateEnd,10)}},{key:"setWeekendDaysTime",value:function t(e){this.weekendDaysTime=c.Type.isInteger(e)?parseInt(e,10):0}},{key:"getWeekendDaysTime",value:function t(){return this.weekendDaysTime}},{key:"setCompletedStoryPoints",value:function t(e){this.completedStoryPoints=new N;this.completedStoryPoints.addPoints(e);this.updateStoryPointsNode()}},{key:"getCompletedStoryPoints",value:function t(){return this.completedStoryPoints}},{key:"setUncompletedStoryPoints",value:function t(e){this.uncompletedStoryPoints=new N;this.uncompletedStoryPoints.addPoints(e);this.updateStoryPointsNode()}},{key:"getUncompletedStoryPoints",value:function t(){return this.uncompletedStoryPoints}},{key:"setItems",value:function t(e){var i=this;if(!c.Type.isArray(e)){return}e.forEach(function(t){var e=new O(t);e.setDisableStatus(i.isDisabled());i.items.set(e.itemId,e)})}},{key:"setInfo",value:function t(e){this.info=c.Type.isPlainObject(e)?e:{sprintGoal:""}}},{key:"setNumberTasks",value:function t(i){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"setNumberTasks",this).call(this,i);if(this.storyPointsHeader){this.storyPointsHeader.updateNumberTasks()}}},{key:"setCompletedTasks",value:function t(e){this.completedTasks=c.Type.isInteger(e)?parseInt(e,10):0}},{key:"getCompletedTasks",value:function t(){return this.completedTasks}},{key:"setUncompletedTasks",value:function t(e){this.uncompletedTasks=c.Type.isInteger(e)?parseInt(e,10):0}},{key:"getUncompletedTasks",value:function t(){return this.uncompletedTasks}},{key:"setDefaultSprintDuration",value:function t(e){this.defaultSprintDuration=c.Type.isInteger(e)?parseInt(e,10):0}},{key:"getDefaultSprintDuration",value:function t(){return this.defaultSprintDuration}},{key:"getInfo",value:function t(){return this.info}},{key:"getEpics",value:function t(){var e=new Map;this.items.forEach(function(t){if(t.getEpic()){e.set(t.getEpic().id,t.getEpic())}});return e}},{key:"getUncompletedItems",value:function t(){var e=new Map;this.items.forEach(function(t){if(!t.isCompleted()){e.set(t.getItemId(),t)}});return e}},{key:"setStatus",value:function t(e){var i=this;var s=new Set(["planned","active","completed"]);this.status=s.has(e)?e:"planned";this.initStyle();this.items.forEach(function(t){t.setDisableStatus(i.isDisabled())});if(this.isDisabled()){if(this.input){this.input.removeYourself()}if(this.groupActionsButton){this.groupActionsButton.removeYourself()}}}},{key:"getStatus",value:function t(){return this.status}},{key:"updateYourself",value:function t(e){if(e.getName()!==this.getName()){this.setName(e.getName())}if(e.getDateStart()!==this.getDateStart()){this.setDateStart(e.getDateStart())}if(e.getDateEnd()!==this.getDateEnd()){this.setDateEnd(e.getDateEnd())}this.setStoryPoints(e.getStoryPoints().getPoints());this.setCompletedStoryPoints(e.getCompletedStoryPoints().getPoints());this.setUncompletedStoryPoints(e.getUncompletedStoryPoints().getPoints());if(e.getStatus()!==this.getStatus()){this.setStatus(e.getStatus())}if(this.node){this.addStoryPointsHeader(new At(this));c.Dom.replace(this.node.querySelector(".tasks-scrum-sprint-header-event-params"),this.renderParams())}}},{key:"removeYourself",value:function t(){c.Dom.remove(this.node);this.node=null;this.emit("removeSprint")}},{key:"render",value:function t(){this.node=c.Tag.render(Lt(),this.sort,this.getId(),this.sprintHeader?this.sprintHeader.render():"",this.eventsHeader?"":"",this.isCompleted()?this.renderLinkToCompletedSprint():"",this.renderParams(),this.groupActionsButton&&!this.isDisabled()?this.groupActionsButton.render():"",this.listItems?this.listItems.render():"");this.itemsLoaderNode=this.node.querySelector(".tasks-scrum-entity-items-loader");this.bindItemsLoader(this.itemsLoaderNode);return this.node}},{key:"renderParams",value:function t(){return c.Tag.render(Nt(),this.storyPointsHeader?this.storyPointsHeader.render():"")}},{key:"renderLinkToCompletedSprint",value:function t(){return c.Tag.render(wt(),c.Text.encode(this.getViews().completedSprint.url),c.Loc.getMessage("TASKS_SCRUM_COMPLETED_SPRINT_LINK"))}},{key:"onAfterAppend",value:function t(){this.updateVisibility();if(this.sprintHeader){this.sprintHeader.onAfterAppend()}babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"onAfterAppend",this).call(this)}},{key:"subscribeToItem",value:function t(i){var s=this;babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"subscribeToItem",this).call(this,i);i.subscribe("moveToBacklog",function(t){s.emit("moveToBacklog",{sprint:s,item:t.getTarget()})});i.subscribe("updateCompletedStatus",function(t){babelHelpers.toConsumableArray(s.getItems().values()).map(function(t){if(t.isCompleted()){s.setCompletedTasks(s.getCompletedTasks()+1)}else{s.setUncompletedTasks(s.getUncompletedTasks()-1)}})});i.subscribe("toggleSubTasks",function(t){s.emit("toggleSubTasks",t.getTarget())})}},{key:"onChangeName",value:function t(e){var i=this;var s=function t(e){return c.Tag.render(Dt(),c.Text.encode(e))};var n=s(this.name);var r=e.getData().querySelector(".tasks-scrum-sprint-header-name");c.Event.bind(n,"change",function(t){var e=t.target["value"];i.emit("changeSprintName",{sprintId:i.getId(),name:e});i.name=e;n.blur()},true);var a=function t(e){if(e.isComposing||e.keyCode===13)n.blur()};c.Event.bind(n,"keydown",a);c.Event.bindOnce(n,"blur",function(){c.Event.unbind(n,"keydown",a);r.textContent=c.Text.encode(i.name);c.Dom.replace(n,r)},true);c.Dom.replace(r,n);n.focus();n.setSelectionRange(this.name.length,this.name.length)}},{key:"onRemoveSprint",value:function t(){var e=this;babelHelpers.toConsumableArray(this.items.values()).map(function(t){e.emit("moveToBacklog",{sprint:e,item:t})});this.removeYourself()}},{key:"removeSprint",value:function t(){var e=this;babelHelpers.toConsumableArray(this.items.values()).map(function(t){e.emit("moveToBacklog",{sprint:e,item:t})});c.Dom.remove(this.node);this.node=null}},{key:"onChangeSprintDeadline",value:function t(e){var i=e.getData();this.emit("changeSprintDeadline",i);if(i.hasOwnProperty("dateStart")){this.dateStart=parseInt(i.dateStart,10)}else if(i.hasOwnProperty("dateEnd")){this.dateEnd=parseInt(i.dateEnd,10)}}},{key:"updateDateStartNode",value:function t(e){if(this.sprintHeader){this.sprintHeader.updateDateStartNode(e)}}},{key:"updateDateEndNode",value:function t(e){if(this.sprintHeader){this.sprintHeader.updateDateEndNode(e)}}},{key:"toggleVisibilityContent",value:function t(){if(this.getContentNode().style.display==="block"){this.hideContent()}else{this.showContent();if(this.isCompleted()&&this.getItems().size===0){this.emit("getSprintCompletedItems")}}}},{key:"showContent",value:function t(){if(this.getContentNode()){this.getContentNode().style.display="block"}if(this.sprintHeader){this.sprintHeader.upTick()}}},{key:"hideContent",value:function t(){if(this.getContentNode()){this.getContentNode().style.display="none"}if(this.sprintHeader){this.sprintHeader.downTick()}}},{key:"updateVisibility",value:function t(){if(this.isCompleted()){if(this.isEmpty()){this.hideContent()}else{this.showContent()}this.showSprint();if(this.isExactSearchApplied()){if(this.isEmpty()){this.hideSprint()}}}else{this.showContent();if(this.isExactSearchApplied()){if(this.isEmpty()){this.hideSprint()}else{this.showSprint()}}else{this.showSprint()}}}},{key:"showSprint",value:function t(){this.node.style.display="block"}},{key:"hideSprint",value:function t(){this.node.style.display="none"}},{key:"onActivateGroupMode",value:function t(i){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"onActivateGroupMode",this).call(this,i);c.Dom.addClass(this.node.querySelector(".tasks-scrum-sprint-items"),"tasks-scrum-sprint-items-group-mode")}},{key:"onDeactivateGroupMode",value:function t(i){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"onDeactivateGroupMode",this).call(this,i);c.Dom.removeClass(this.node.querySelector(".tasks-scrum-sprint-items"),"tasks-scrum-sprint-items-group-mode")}},{key:"getContentNode",value:function t(){if(this.node){return this.node.querySelector(".tasks-scrum-sprint-content")}}},{key:"updateStoryPointsNode",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"updateStoryPointsNode",this).call(this);if(this.storyPointsHeader){this.storyPointsHeader.setStoryPoints(this.getStoryPoints().getPoints());this.storyPointsHeader.setCompletedStoryPoints(this.getCompletedStoryPoints().getPoints());this.storyPointsHeader.setUncompletedStoryPoints(this.getUncompletedStoryPoints().getPoints())}if(this.sprintHeader){this.sprintHeader.updateStatsHeader()}}}],[{key:"buildSprint",value:function t(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var s=new e(i);s.addSprintHeader(yt.buildHeader(s));s.addEventsHeader(new St);s.addStoryPointsHeader(new At(s));s.addGroupActionsButton(new x);s.addListItems(new K(s));return s}}]);return e}(z);var Bt=function(){function t(){babelHelpers.classCallCheck(this,t);this.backlog=null;this.sprints=new Map}babelHelpers.createClass(t,[{key:"addBacklog",value:function t(e){if(!(e instanceof et)){throw new Error("EntityStorage: Backlog is in wrong format")}this.backlog=e}},{key:"addSprint",value:function t(e){this.sprints.set(e.getId(),e)}},{key:"removeSprint",value:function t(e){this.sprints.delete(e)}},{key:"getBacklog",value:function t(){if(this.backlog===null){throw new Error("EntityStorage: Backlog not found")}return this.backlog}},{key:"getSprints",value:function t(){return this.sprints}},{key:"getSprintsAvailableForFilling",value:function t(e){var i=new Set;this.sprints.forEach(function(t){if(!t.isCompleted()&&e.getId()!==t.getId()){i.add(t)}});return i}},{key:"getAllEntities",value:function t(){var e=new Map;e.set(this.backlog.getId(),this.backlog);babelHelpers.toConsumableArray(this.sprints.values()).map(function(t){return e.set(t.getId(),t)});return e}},{key:"getAllItems",value:function t(){var e=new Map(this.backlog.getItems());babelHelpers.toConsumableArray(this.sprints.values()).map(function(t){return e=new Map([].concat(babelHelpers.toConsumableArray(e),babelHelpers.toConsumableArray(t.getItems())))});return e}},{key:"recalculateItemsSort",value:function t(){this.backlog.recalculateItemsSort();this.sprints.forEach(function(t){return t.recalculateItemsSort()})}},{key:"findEntityByEntityId",value:function t(e){e=parseInt(e,10);if(this.backlog.getId()===e){return this.backlog}return babelHelpers.toConsumableArray(this.sprints.values()).find(function(t){return t.getId()===e})}},{key:"findItemByItemId",value:function t(e){e=parseInt(e,10);var i=this.backlog.getItems();if(i.has(e)){return i.get(e)}var s=babelHelpers.toConsumableArray(this.sprints.values()).find(function(t){return t.getItems().has(e)});if(s){return s.getItems().get(e)}return null}},{key:"findItemBySourceId",value:function t(e){e=parseInt(e,10);var i=new Map(this.backlog.getItems());babelHelpers.toConsumableArray(this.sprints.values()).map(function(t){return i=new Map([].concat(babelHelpers.toConsumableArray(i),babelHelpers.toConsumableArray(t.getItems())))});return babelHelpers.toConsumableArray(i.values()).find(function(t){return t.getSourceId()===e})}},{key:"findEntityByItemId",value:function t(e){e=parseInt(e,10);var i=this.backlog.getItems();if(i.has(e)){return this.backlog}return babelHelpers.toConsumableArray(this.sprints.values()).find(function(t){return t.getItems().has(e)})}}]);return t}();var _t=function(){function t(e){babelHelpers.classCallCheck(this,t);this.requestSender=e.requestSender;this.entityStorage=e.entityStorage;this.filterService=e.filterService;this.userId=e.userId;this.groupId=e.groupId}babelHelpers.createClass(t,[{key:"getModuleId",value:function t(){return"tasks"}},{key:"getMap",value:function t(){return{task_view:this.onTaskView.bind(this),project_read_all:this.onCommentsReadAll.bind(this)}}},{key:"onTaskView",value:function t(e){var i=this;var s=parseInt(e.TASK_ID,10);var n=parseInt(e.USER_ID,10);if(n!==this.userId){return}var r=this.entityStorage.findItemBySourceId(s);if(r){this.requestSender.getCurrentState({taskId:r.getSourceId()}).then(function(t){r.updateYourself(new O(t.data.itemData))}).catch(function(t){i.requestSender.showErrorAlert(t)})}}},{key:"onCommentsReadAll",value:function t(e){var i=e.GROUP_ID;if(i&&i===this.groupId){this.filterService.applyFilter()}}}]);return t}();var Ht=function(){function t(e){babelHelpers.classCallCheck(this,t);this.requestSender=e.requestSender;this.entityStorage=e.entityStorage;this.filterService=e.filter;this.isOwnerCurrentUser=e.isOwnerCurrentUser;this.userId=parseInt(e.userId,10);this.groupId=parseInt(e.groupId,10);this.filter=this.filterService.getFilterManager();this.updateFields();this.bindEvents();this.subscribeToPull()}babelHelpers.createClass(t,[{key:"bindEvents",value:function t(){d.EventEmitter.subscribe("BX.Main.Filter:apply",this.onFilterApply.bind(this));d.EventEmitter.subscribe("Tasks.Toolbar:onItem",this.onCounterClick.bind(this))}},{key:"subscribeToPull",value:function t(){a.PULL.subscribe(new _t({requestSender:this.requestSender,entityStorage:this.entityStorage,filterService:this.filterService,userId:this.userId,groupId:this.groupId}))}},{key:"onFilterApply",value:function t(){this.updateFields()}},{key:"updateFields",value:function t(){this.fields=this.filter.getFilterFieldsValues()}},{key:"onCounterClick",value:function t(e){var i=e.getData();if(i.counter&&i.counter.filter){this.toggleByField(babelHelpers.defineProperty({},i.counter.filterField,i.counter.filterValue))}}},{key:"isFilteredByField",value:function t(e){if(!Object.keys(this.fields).includes(e)){return false}if(c.Type.isArray(this.fields[e])){return this.fields[e].length>0}return this.fields[e]!==""}},{key:"isFilteredByFieldValue",value:function t(e,i){return this.isFilteredByField(e)&&this.fields[e]===i}},{key:"toggleByField",value:function t(e){var i=this;var s=Object.keys(e)[0];var n=e[s];if(!this.isFilteredByFieldValue(s,n)){this.filter.getApi().extendFilter(babelHelpers.defineProperty({},s,n));return}this.filter.getFilterFields().forEach(function(t){if(t.getAttribute("data-name")===s){i.filter.getFields().deleteField(t)}});this.filter.getSearch().apply()}}]);return t}();var Rt=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t.setEventNamespace("BX.Tasks.Scrum.SidePanel");t.sidePanelManager=BX.SidePanel.Instance;t.contentSidePanelManager=new BX.SidePanel.Manager({});t.contentSidePanels=new Set;t.bindEvents();return t}babelHelpers.createClass(e,[{key:"bindEvents",value:function t(){var e=this;d.EventEmitter.subscribe("SidePanel.Slider:onLoad",function(t){var i=t.getCompatData(),s=babelHelpers.slicedToArray(i,1),n=s[0];var r=n.getSlider();r.setCacheable(false);e.emit("onLoadSidePanel",r)});d.EventEmitter.subscribe("SidePanel.Slider:onClose",function(t){var i=t.getCompatData(),s=babelHelpers.slicedToArray(i,1),n=s[0];var r=n.getSlider();e.emit("onCloseSidePanel",r)});d.EventEmitter.subscribe("SidePanel.Slider:onCloseComplete",function(t){var i=t.getCompatData(),s=babelHelpers.slicedToArray(i,1),n=s[0];var r=n.getSlider();if(e.contentSidePanels.has(r.getUrl())){e.contentSidePanels.delete(r.getUrl());if(!e.contentSidePanels.size){e.resetBodyWidthHack();e.addEscapePressHandler()}}})}},{key:"isPreviousSidePanelExist",value:function t(e){var i=this.contentSidePanels.has(e.getUrl())?this.contentSidePanelManager:this.sidePanelManager;return Boolean(i.getPreviousSlider(e))}},{key:"getTopSidePanel",value:function t(){var e=this.sidePanelManager.getTopSlider();return e?e:null}},{key:"reloadTopSidePanel",value:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var i=e?this.contentSidePanelManager:this.sidePanelManager;if(i.getTopSlider()){i.getTopSlider().reload()}}},{key:"closeTopSidePanel",value:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var i=e?this.contentSidePanelManager:this.sidePanelManager;if(i.getTopSlider()){i.getTopSlider().close()}}},{key:"reloadPreviousSidePanel",value:function t(e){var i=this.contentSidePanels.has(e.getUrl())?this.contentSidePanelManager:this.sidePanelManager;var s=i.getPreviousSlider(e);s.reload()}},{key:"openSidePanelByUrl",value:function t(e){this.sidePanelManager.open(e)}},{key:"openSidePanel",value:function t(e,i){this.applyBodyWidthHack();this.removeEscapePressHandler();this.contentSidePanelManager.open(e,i);this.contentSidePanels.add(e)}},{key:"existFrameTopSlider",value:function t(){return Boolean(this.sidePanelManager.getTopSlider())}},{key:"addEscapePressHandler",value:function t(){var e=this.sidePanelManager.getTopSlider();if(e){var i=e.getFrameWindow();i.addEventListener("keydown",e.handleFrameKeyDown)}}},{key:"removeEscapePressHandler",value:function t(){var e=this.sidePanelManager.getTopSlider();if(e){var i=e.getFrameWindow();i.removeEventListener("keydown",e.handleFrameKeyDown)}}},{key:"applyBodyWidthHack",value:function t(){if(this.existFrameTopSlider()){c.Dom.addClass(document.body,"tasks-scrum-side-panel-padding")}}},{key:"resetBodyWidthHack",value:function t(){if(this.existFrameTopSlider()){c.Dom.removeClass(document.body,"tasks-scrum-side-panel-padding")}}}]);return e}(d.EventEmitter);function qt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-view-switcher">\n\t\t\t\t<a\n\t\t\t\t\thref="','"\n\t\t\t\t\tclass="tasks-view-switcher--item ','"\n\t\t\t\t>','</a>\n\t\t\t\t<a\n\t\t\t\t\thref="','"\n\t\t\t\t\tclass="tasks-view-switcher--item ','"\n\t\t\t\t>','</a>\n\t\t\t\t<a\n\t\t\t\t\thref="','"\n\t\t\t\t\tclass="tasks-view-switcher--item ','"\n\t\t\t\t>',"</a>\n\t\t\t</div>\n\t\t"]);qt=function e(){return t};return t}var Ft=function(){function t(e){babelHelpers.classCallCheck(this,t);this.sidePanel=e.sidePanel;this.views=e.views;this.node=null}babelHelpers.createClass(t,[{key:"render",value:function t(){var e=this;var i=this.views["plan"].active?"tasks-view-switcher--item --active":"";var s=this.views["activeSprint"].active?"tasks-view-switcher--item --active":"";var n=this.views["completedSprint"].active?"tasks-view-switcher--item --active":"";this.node=c.Tag.render(qt(),this.views["plan"].url,i,c.Text.encode(this.views["plan"].name),this.views["activeSprint"].url,s,c.Text.encode(this.views["activeSprint"].name),this.views["completedSprint"].url,n,c.Text.encode(this.views["completedSprint"].name));this.node.querySelectorAll("a").forEach(function(t){c.Event.bind(t,"click",function(){var t=e.sidePanel.getTopSidePanel();if(t!==null){t.showLoader()}})});return this.node}}]);return t}();var Ot=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.View");i.isOwnerCurrentUser=t.isOwnerCurrentUser==="Y";i.sidePanel=new Rt;i.requestSender=new p({signedParameters:t.signedParameters,debugMode:t.debugMode});i.filter=new h({filterId:t.filterId,scrumManager:babelHelpers.assertThisInitialized(i),requestSender:i.requestSender});i.userId=parseInt(t.userId,10);i.groupId=parseInt(t.groupId,10);return i}babelHelpers.createClass(e,[{key:"renderTo",value:function t(e){if(!c.Type.isDomNode(e)){throw new Error("Scrum: HTMLElement for scrum not found")}}},{key:"renderTabsTo",value:function t(e){if(!c.Type.isDomNode(e)){throw new Error("Scrum: HTMLElement for tabs not found")}var i=new Ft({sidePanel:this.sidePanel,views:this.views});c.Dom.append(i.render(),e)}},{key:"renderSprintStatsTo",value:function t(e){if(!c.Type.isDomNode(e)){throw new Error("Scrum: HTMLElement for Sprint stats not found")}}},{key:"renderButtonsTo",value:function t(e){if(!c.Type.isDomNode(e)){throw new Error("Scrum: HTMLElement for buttons not found")}}},{key:"getCurrentUserId",value:function t(){return this.userId}},{key:"getCurrentGroupId",value:function t(){return this.groupId}}]);return e}(d.EventEmitter);function Ut(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<button class="ui-btn ui-btn-light-border ui-btn-themes ui-btn-round ui-btn-xs">\n\t\t\t\t',"\n\t\t\t</button>\n\t\t"]);Ut=function e(){return t};return t}var xt=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t.setEventNamespace("BX.Tasks.Scrum.TeamSpeedButton");return t}babelHelpers.createClass(e,[{key:"render",value:function t(){var e=c.Tag.render(Ut(),c.Loc.getMessage("TASKS_SCRUM_TEAM_SPEED_BUTTON"));c.Event.bind(e,"click",this.onClick.bind(this));return e}},{key:"onClick",value:function t(){this.emit("click")}}]);return e}(d.EventEmitter);var Gt=function(){function t(e){babelHelpers.classCallCheck(this,t);this.data=e}babelHelpers.createClass(t,[{key:"createChart",value:function t(e){am4core.useTheme(am4themes_animated);this.chart=am4core.create(e,am4charts.XYChart);this.chart.data=this.data;this.chart.paddingRight=40;this.createAxises();this.createIdealLine();this.createRemainLine();this.createLegend()}},{key:"createAxises",value:function t(){var e=this.chart.xAxes.push(new am4charts.CategoryAxis);e.renderer.grid.template.location=0;e.dataFields.category="day";e.renderer.minGridDistance=60;var i=this.chart.yAxes.push(new am4charts.ValueAxis);i.min=-.1}},{key:"createIdealLine",value:function t(){var e=this.chart.series.push(new am4charts.LineSeries);e.name=c.Loc.getMessage("TASKS_SCRUM_SPRINT_IDEAL_BURN_DOWN_CHART_LINE_TITLE");e.stroke=am4core.color("#2882b3");e.strokeWidth=2;e.dataFields.categoryX="day";e.dataFields.valueY="idealValue";var i="#2882b3";var s=new am4charts.CircleBullet;s.circle.radius=4;s.circle.fill=am4core.color(i);s.circle.stroke=am4core.color(i);e.bullets.push(s);var n=e.segments.template;var r=n.states.create("hover");r.properties.strokeWidth=4}},{key:"createRemainLine",value:function t(){var e=this.chart.series.push(new am4charts.LineSeries);e.name=c.Loc.getMessage("TASKS_SCRUM_SPRINT_REMAIN_BURN_DOWN_CHART_LINE_TITLE");e.stroke=am4core.color("#9c1f1f");e.strokeWidth=2;e.dataFields.categoryX="day";e.dataFields.valueY="remainValue";var i="#9c1f1f";var s=new am4charts.CircleBullet;s.circle.radius=4;s.circle.fill=am4core.color(i);s.circle.stroke=am4core.color(i);e.bullets.push(s);var n=e.segments.template;var r=n.states.create("hover");r.properties.strokeWidth=4}},{key:"createLegend",value:function t(){var e=this;this.chart.legend=new am4charts.Legend;this.chart.legend.itemContainers.template.clickable=false;this.chart.legend.position="bottom";this.chart.legend.itemContainers.template.events.on("over",function(t){e.processOver(t.target.dataItem.dataContext)});this.chart.legend.itemContainers.template.events.on("out",function(){return e.processOut()})}},{key:"processOver",value:function t(e){e.toFront();e.segments.each(function(t){return t.setState("hover")})}},{key:"processOut",value:function t(){this.chart.series.each(function(t){t.segments.each(function(t){return t.setState("default")});t.bulletsContainer.setState("default")})}},{key:"destroyBurnDownChart",value:function t(){this.chart.dispose()}}]);return t}();function Kt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-sprint-sidepanel-block">\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-title">\n\t\t\t\t\t','\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-content">\n\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-info-box tasks-scrum-sprint-sidepanel-info-box-w100">\n\t\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-info-title">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-info-content">\n\t\t\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-info-value">\n\t\t\t\t\t\t\t\t','%\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-info-dif ','">\n\t\t\t\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-info-dif-arrow"></span>\n\t\t\t\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-info-dif-block">\n\t\t\t\t\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-info-dif-val">','</span>\n\t\t\t\t\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-info-dif-icon">%</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);Kt=function e(){return t};return t}function Vt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-speed">\n\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-subtitle">\n\t\t\t\t\t\t','\n\t\t\t\t\t</span>\n\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-result">','</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-graph"></div>\n\t\t\t']);Vt=function e(){return t};return t}function Xt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-sprint-sidepanel-block">\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-title tasks-scrum-sprint-sidepanel-title-icon">\n\t\t\t\t\t','\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-content">\n\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-field">\n\t\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-label">\n\t\t\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-text">\n\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100">\n\t\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t\t<select class="ui-ctl-element">\n\t\t\t\t\t\t\t\t<option value="backlog">\n\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t\t\t<option value="0">\n\t\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t\t\t",'\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-uncompleted">\n\t\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-subtitle">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-uncompleted-list">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);Xt=function e(){return t};return t}function Yt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-sprint-sidepanel-block">\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-title">\n\t\t\t\t\t','\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-content">\n\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-text">\n\t\t\t\t\t\t',"\n\t\t\t\t\t </div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);Yt=function e(){return t};return t}function jt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-sprint-sidepanel">\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-header">\n\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-header-title">\n\t\t\t\t\t\t','\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-chart"></div>\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-buttons"></div>\n\t\t\t</div>\n\t\t']);jt=function e(){return t};return t}function Wt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-sprint-sidepanel">\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-header">\n\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-header-title">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t","\n\t\t\t\t","\n\t\t\t\t",'\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-buttons"></div>\n\t\t\t</div>\n\t\t']);Wt=function e(){return t};return t}function zt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-epic-item" style="background: ',';">\n\t\t\t\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t"]);zt=function e(){return t};return t}function Zt(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-sprint-sidepanel">\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-header">\n\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-header-title">\n\t\t\t\t\t\t','\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-block">\n\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-title">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-content">\n\t\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-info">\n\t\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-info-box">\n\t\t\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-info-title">\n\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-info-content">\n\t\t\t\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-info-value">\n\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-info-box tasks-scrum-sprint-sidepanel-info-box-story">\n\t\t\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-info-title">\n\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-info-content">\n\t\t\t\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-info-value">\n\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t<span class="tasks-scrum-sprint-sidepanel-info-extra">\n\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-epic">\n\t\t\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-epic-title">\n\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-epic-list">\n\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-block">\n\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-title">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-content">\n\t\t\t\t\t\t<div class="ui-ctl ui-ctl-textarea ui-ctl-resize-y">\n\t\t\t\t\t\t\t<textarea class="ui-ctl-element"></textarea>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-sprint-sidepanel-buttons"></div>\n\t\t\t</div>\n\t\t']);Zt=function e(){return t};return t}var Qt=function(){function t(e){babelHelpers.classCallCheck(this,t);this.sprints=e.sprints?e.sprints:new Map;this.sidePanel=e.sidePanel;this.requestSender=e.requestSender;this.views=e.views;this.currentSprint=null;this.uncompletedItems=new Map;this.lastCompletedSprint=this.getLastCompletedSprint(this.sprints)}babelHelpers.createClass(t,[{key:"showStartSidePanel",value:function t(e){var i=this;this.sidePanelId="tasks-scrum-sprint-start-side-panel";this.currentSprint=e;this.sidePanel.unsubscribeAll("onLoadSidePanel");this.sidePanel.subscribeOnce("onLoadSidePanel",this.onLoadStartPanel.bind(this));this.sidePanel.openSidePanel(this.sidePanelId,{contentCallback:function t(){return new Promise(function(t,e){t(i.buildStartPanel())})},zIndex:1e3,width:600})}},{key:"showCompleteSidePanel",value:function t(e){var i=this;this.sidePanelId="tasks-scrum-sprint-complete-side-panel";this.currentSprint=e;this.sidePanel.unsubscribeAll("onLoadSidePanel");this.sidePanel.subscribeOnce("onLoadSidePanel",this.onLoadCompletePanel.bind(this));this.sidePanel.openSidePanel(this.sidePanelId,{contentCallback:function t(){return new Promise(function(t,e){t(i.buildCompletePanel())})},zIndex:1e3,width:600})}},{key:"showBurnDownChart",value:function t(e){var i=this;this.sidePanelId="tasks-scrum-sprint-burn-down-chart";this.currentSprint=e;this.sidePanel.unsubscribeAll("onLoadSidePanel");this.sidePanel.subscribeOnce("onLoadSidePanel",this.onLoadSprintBurnDownPanel.bind(this));this.sidePanel.subscribe("onCloseSidePanel",this.onCloseBurnDownChart.bind(this));this.sidePanel.openSidePanel(this.sidePanelId,{contentCallback:function t(){return new Promise(function(t,e){t(i.buildBurnDownPanel())})},zIndex:1e3})}},{key:"buildStartPanel",value:function t(){var e=this.currentSprint.getStoryPoints().getPoints();e=e>0?"+"+e:e;if(this.lastCompletedSprint){e=this.getDifferenceStoryPointsBetweenSprints(this.currentSprint,this.lastCompletedSprint)}return c.Tag.render(Zt(),c.Loc.getMessage("TASKS_SCRUM_SPRINT_START_HEADER"),c.Loc.getMessage("TASKS_SCRUM_SPRINT_START_TITLE"),c.Loc.getMessage("TASKS_SCRUM_SPRINT_START_TASK_COUNT_TITLE"),parseInt(this.currentSprint.getNumberTasks()),c.Loc.getMessage("TASKS_SCRUM_SPRINT_START_STORY_POINTS_COUNT_TITLE"),c.Text.encode(this.currentSprint.getStoryPoints().getPoints()),e,c.Loc.getMessage("TASKS_SCRUM_SPRINT_START_EPICS_TITLE"),babelHelpers.toConsumableArray(this.currentSprint.getEpics().values()).map(function(t){return c.Tag.render(zt(),c.Text.encode(t.info.color),c.Text.encode(t.name))}),c.Loc.getMessage("TASKS_SCRUM_SPRINT_GOAL_TITLE"))}},{key:"onLoadStartPanel",value:function t(e){var i=this;var s=e.getData();this.form=s.getContainer().querySelector(".tasks-scrum-sprint-sidepanel");this.onLoadStartButtons().then(function(t){c.Event.bind(t.querySelector("[name=save]"),"click",i.onStartSprint.bind(i));c.Event.bind(t.querySelector("[name=cancel]"),"click",function(){return s.close()})})}},{key:"buildCompletePanel",value:function t(){return c.Tag.render(Wt(),c.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETE_HEADER"),this.buildSprintGoal(),this.buildSprintActions(),this.buildSprintPlan())}},{key:"buildBurnDownPanel",value:function t(){return c.Tag.render(jt(),c.Loc.getMessage("TASKS_SCRUM_SPRINT_IDEAL_BURN_DOWN_CHART_HEADER"))}},{key:"buildSprintGoal",value:function t(){var e=this.currentSprint.getInfo();var i=e.sprintGoal;if(!i){return""}return c.Tag.render(Yt(),c.Loc.getMessage("TASKS_SCRUM_SPRINT_GOAL_TITLE"),c.Text.encode(i))}},{key:"buildSprintActions",value:function t(){var e=this;var i=this.currentSprint.getUncompletedTasks();if(i===0){return""}var s="";this.sprints.forEach(function(t){if(t.isPlanned()){s+='<option value="'.concat(t.getId(),'">').concat(c.Text.encode(t.getName()),"</option>")}});return c.Tag.render(Xt(),c.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETE_ACTIONS_TITLE"),c.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETE_ACTIONS_SELECT"),c.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETE_POPUP_MOVE_SELECTOR_BACKLOG"),c.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETE_POPUP_NEW_SPRINT"),s,c.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETE_ACTIONS_ITEM_LIST"),babelHelpers.toConsumableArray(this.currentSprint.getUncompletedItems().values()).map(function(t){if(!t.isSubTask()){var i=t.getPreviewVersion();e.uncompletedItems.set(i.getItemId(),i);return i.render()}}))}},{key:"buildSprintPlan",value:function t(){var e=new nt;var i=e.calculatePercentage(this.currentSprint.getStoryPoints().getPoints(),this.currentSprint.getCompletedStoryPoints().getPoints());var s=e.calculatePercentage(this.currentSprint.getStoryPoints().getPoints(),this.currentSprint.getCompletedStoryPoints().getPoints());if(this.lastCompletedSprint){s=this.getDifferencePercentageBetweenSprints(this.currentSprint,this.lastCompletedSprint)}var n=s>0?"":"tasks-scrum-sprint-sidepanel-info-dif-min";var r=Math.abs(s);var a=s>0?c.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETE_TEAM_SPEED_UP").replace("#value#",r):c.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETE_TEAM_SPEED_DOWN").replace("#value#",r);var o=function t(e){return"";return c.Tag.render(Vt(),c.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETE_TEAM_SPEED"),e)};return c.Tag.render(Kt(),c.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETE_PLAN_TITLE"),c.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETE_PLAN_DONE"),i,n,r,o())}},{key:"onLoadCompletePanel",value:function t(e){var i=this;var s=e.getData();this.form=s.getContainer().querySelector(".tasks-scrum-sprint-sidepanel");var n=this.form.querySelector(".tasks-scrum-sprint-sidepanel-uncompleted-list");babelHelpers.toConsumableArray(this.uncompletedItems.values()).map(function(t){t.onAfterAppend(n);t.subscribe("showTask",function(){i.currentSprint.emit("showTask",t)})});this.onLoadCompleteButtons().then(function(t){c.Event.bind(t.querySelector("[name=save]"),"click",i.onCompleteSprint.bind(i,s));c.Event.bind(t.querySelector("[name=cancel]"),"click",function(){return s.close()})})}},{key:"onLoadSprintBurnDownPanel",value:function t(e){var i=this;var s=e.getData();s.showLoader();this.form=s.getContainer().querySelector(".tasks-scrum-sprint-sidepanel");this.getBurnDownChartData().then(function(t){s.closeLoader();setTimeout(function(){i.burnDownChart=new Gt(t);i.burnDownChart.createChart(i.form.querySelector(".tasks-scrum-sprint-sidepanel-chart"))},300)})}},{key:"onCloseBurnDownChart",value:function t(e){var i=this;var s=e.getData();if(this.sidePanelId===s.getUrl()){setTimeout(function(){if(i.burnDownChart){i.burnDownChart.destroyBurnDownChart();i.burnDownChart=null}},300)}}},{key:"getTasksCountLabel",value:function t(e){if(e>5){return e+" "+c.Loc.getMessage("TASKS_SCRUM_TASK_LABEL_3")}else if(e===1){return e+" "+c.Loc.getMessage("TASKS_SCRUM_TASK_LABEL_1")}else{return e+" "+c.Loc.getMessage("TASKS_SCRUM_TASK_LABEL_2")}}},{key:"getLastCompletedSprint",value:function t(e){return babelHelpers.toConsumableArray(e.values()).find(function(t){return t.isCompleted()===true})}},{key:"getDifferenceStoryPointsBetweenSprints",value:function t(e,i){var s=parseFloat(e.getStoryPoints().getPoints()-i.getStoryPoints().getPoints());if(c.Type.isFloat(s)){s=s.toFixed(1)}if(s===0){return""}else{return s>0?"+"+s:s}}},{key:"getDifferencePercentageBetweenSprints",value:function t(e,i){var s=new nt;var n=s.calculatePercentage(e.getStoryPoints().getPoints(),e.getCompletedStoryPoints().getPoints());var r=s.calculatePercentage(i.getStoryPoints().getPoints(),i.getCompletedStoryPoints().getPoints());return parseFloat(n)-parseFloat(r)}},{key:"getStartButtons",value:function t(){var e=this;return new Promise(function(t,i){e.requestSender.getSprintStartButtons().then(function(e){t(e.data.html)})})}},{key:"getCompleteButtons",value:function t(){var e=this;return new Promise(function(t,i){e.requestSender.getSprintCompleteButtons().then(function(e){t(e.data.html)})})}},{key:"getBurnDownChartData",value:function t(){var e=this;return new Promise(function(t,i){e.requestSender.getBurnDownChartData(e.getRequestDataToGetBurnDownChartData()).then(function(e){t(e.data)})})}},{key:"onLoadStartButtons",value:function t(){var e=this;return this.getStartButtons().then(function(t){var i=e.form.querySelector(".tasks-scrum-sprint-sidepanel-buttons");return c.Runtime.html(i,t).then(function(){return i})})}},{key:"onLoadCompleteButtons",value:function t(){var e=this;return this.getCompleteButtons().then(function(t){var i=e.form.querySelector(".tasks-scrum-sprint-sidepanel-buttons");return c.Runtime.html(i,t).then(function(){return i})})}},{key:"onStartSprint",value:function t(){var e=this;this.requestSender.startSprint(this.getRequestDataToStartSprint()).then(function(t){e.currentSprint.setStatus("active");location.href=e.views["activeSprint"].url}).catch(function(t){e.removeClockIconFromButton();e.requestSender.showErrorAlert(t,c.Loc.getMessage("TASKS_SCRUM_SPRINT_START_ERROR_TITLE_POPUP"))})}},{key:"onCompleteSprint",value:function t(e){var i=this;this.requestSender.completeSprint(this.getRequestDataToCompleteSprint()).then(function(t){if(s.Confetti){s.Confetti.fire({particleCount:400,spread:80,origin:{x:.7,y:.2},zIndex:e.getZindex()+1}).then(function(){location.href=i.views["plan"].url})}else{location.href=i.views["plan"].url}}).catch(function(t){i.removeClockIconFromButton();i.requestSender.showErrorAlert(t,c.Loc.getMessage("TASKS_SCRUM_SPRINT_START_ERROR_TITLE_POPUP"))})}},{key:"getRequestDataToStartSprint",value:function t(){var e={};e.sprintId=this.currentSprint.getId();e.sprintGoal=this.form.querySelector("textarea").value;return e}},{key:"getRequestDataToCompleteSprint",value:function t(){var e={};e.sprintId=this.currentSprint.getId();var i=this.form.querySelector("select");e.direction=i?i.value:"backlog";return e}},{key:"getRequestDataToGetBurnDownChartData",value:function t(){var e={};e.sprintId=this.currentSprint.getId();return e}},{key:"removeClockIconFromButton",value:function t(){var e=this.form.querySelector(".tasks-scrum-sprint-sidepanel-buttons");if(e){c.Dom.removeClass(e.querySelector("[name=save]"),"ui-btn-wait")}}}]);return t}();var Jt=function(){function t(e){babelHelpers.classCallCheck(this,t);this.requestSender=e.requestSender;this.entityStorage=e.entityStorage;this.listAllUsedColors=new Set;this.updateBorderColorForLinkedItems()}babelHelpers.createClass(t,[{key:"updateBorderColorForLinkedItems",value:function t(){var e=this;var i=new Set;this.entityStorage.getAllItems().forEach(function(t){if(t.isLinkedTask()&&!t.getBorderColor()){i.add(t.getItemId())}});if(i.size){this.getAllUsedColors().then(function(){var t=new Map;i.forEach(function(i){t.set(i,e.getRandomColor(e.getAllColors()))});e.requestSender.updateBorderColorToLinkedItems({items:Object.fromEntries(t)}).then(function(t){var i=t.data;Object.keys(i).forEach(function(t){var s=i[t];var n=e.entityStorage.findItemByItemId(t);n.setBorderColor(s)})}).catch(function(t){e.requestSender.showErrorAlert(t)})})}}},{key:"getRandomColorForItemBorder",value:function t(){var e=this;return this.getAllUsedColors().then(function(){return e.getRandomColor(e.getAllColors())})}},{key:"getAllColors",value:function t(){var e=this.getColorPicker();var i=[];e.getDefaultColors().forEach(function(t){i=[].concat(babelHelpers.toConsumableArray(i),babelHelpers.toConsumableArray(t))});return i}},{key:"getRandomColor",value:function t(e){var i=e[Math.floor(Math.random()*e.length)];if(this.isThisBorderColorAlreadyUse(i)){return this.getRandomColor(e)}else{return i}}},{key:"isThisBorderColorAlreadyUse",value:function t(e){var i=false;this.listAllUsedColors.forEach(function(t){if(t===e){i=true}});return i}},{key:"getAllUsedColors",value:function t(){var e=this;var i=new Set;this.entityStorage.getAllEntities().forEach(function(t){if(!t.isCompleted()){i.add(t.getId())}});return this.requestSender.getAllUsedItemBorderColors({entityIds:babelHelpers.toConsumableArray(i.values())}).then(function(t){e.listAllUsedColors=new Set([t.data])}).catch(function(t){e.requestSender.showErrorAlert(t)})}},{key:"getColorPicker",value:function t(){return new BX.ColorPicker}}]);return t}();function $t(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-sprints">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t\t","\n\t\t\t</div>\n\t\t"]);$t=function e(){return t};return t}function te(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div id="','" class="tasks-scrum-sprint-list">\n\t\t\t\t\t<div class="tasks-scrum-sprint-active-list">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-sprint-planned-list">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-sprint-completed-list">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-sprint-completed-loader"></div>\n\t\t\t\t</div>\n\t\t\t']);te=function e(){return t};return t}function ee(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div id="','" class="','">\n\t\t\t\t\t<label class="ui-ctl ui-ctl-file-drop tasks-scrum-sprint-sprint-add-drop">\n\t\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t<small>',"</small>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</label>\n\t\t\t\t</div>\n\t\t\t"]);ee=function e(){return t};return t}function ie(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div id="','" class=\n\t\t\t\t\t"tasks-scrum-sprint-create ui-btn ui-btn-md ui-btn-themes ui-btn-light-border ui-btn-icon-add">\n\t\t\t\t\t<span>',"</span>\n\t\t\t\t</div>\n\t\t\t"]);ie=function e(){return t};return t}var se=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.DomBuilder");i.requestSender=t.requestSender;i.entityStorage=t.entityStorage;i.defaultSprintDuration=t.defaultSprintDuration;i.pageNumberToCompletedSprints=parseInt(t.pageNumberToCompletedSprints,10);return i}babelHelpers.createClass(e,[{key:"renderTo",value:function t(e){this.scrumContainer=e;this.append(this.entityStorage.getBacklog().render(),this.scrumContainer);this.entityStorage.getBacklog().onAfterAppend();this.append(this.renderSprintsContainer(),this.scrumContainer);this.entityStorage.getSprints().forEach(function(t){t.onAfterAppend()});this.sprintCreatingButtonNode=document.getElementById(this.sprintCreatingButtonNodeId);this.sprintCreatingDropZoneNode=document.getElementById(this.sprintCreatingDropZoneNodeId);this.sprintListNode=document.getElementById(this.sprintListNodeId);c.Event.bind(this.sprintCreatingButtonNode,"click",this.createSprint.bind(this));this.setDraggable()}},{key:"getSprintCreatingDropZoneNode",value:function t(){return this.sprintCreatingDropZoneNode}},{key:"getSprintPlannedListNode",value:function t(){return this.sprintListNode.querySelector(".tasks-scrum-sprint-planned-list")}},{key:"setDraggable",value:function t(){var e=this;var i=[];i.push(this.entityStorage.getBacklog().getListItemsNode());if(this.sprintCreatingDropZoneNode){i.push(this.sprintCreatingDropZoneNode)}this.entityStorage.getSprints().forEach(function(t){if(!t.isDisabled()){i.push(t.getListItemsNode())}});this.draggableItems=new n.Draggable({container:i,draggable:".tasks-scrum-item-drag",dragElement:".tasks-scrum-item",type:n.Draggable.DROP_PREVIEW,delay:260});this.draggableItems.subscribe("start",function(t){var i=t.getData();e.emit("itemMoveStart",i);e.showDropZoneForSprintCreating(i)});this.draggableItems.subscribe("end",function(t){var i=t.getData();e.emit("itemMoveEnd",i);e.hideDropZoneForSprintCreating(i)});this.draggableSprints=new n.Draggable({container:this.sprintListNode.querySelector(".tasks-scrum-sprint-planned-list"),draggable:".tasks-scrum-sprint",dragElement:".tasks-scrum-sprint-dragndrop",type:n.Draggable.DROP_PREVIEW});this.draggableSprints.subscribe("end",function(t){var i=t.getData();e.emit("sprintMove",i)})}},{key:"renderSprintsContainer",value:function t(){var e=this;var i=function t(){e.sprintCreatingButtonNodeId="tasks-scrum-sprint-creating-button";return c.Tag.render(ie(),e.sprintCreatingButtonNodeId,c.Loc.getMessage("TASKS_SCRUM_SPRINT_ADD"))};var s=function t(){e.sprintCreatingDropZoneNodeId="tasks-scrum-sprint-creating-drop-zone";var i=e.entityStorage.getSprints().size?"tasks-scrum-sprint-sprint-drop-hide":"tasks-scrum-sprint-sprint-drop";return c.Tag.render(ee(),e.sprintCreatingDropZoneNodeId,i,c.Loc.getMessage("TASKS_SCRUM_SPRINT_ADD_DROP"))};var n=function t(){e.sprintListNodeId="tasks-scrum-sprint-list";return c.Tag.render(te(),e.sprintListNodeId,babelHelpers.toConsumableArray(e.entityStorage.getSprints().values()).map(function(t){if(t.isActive()){return t.render()}else{return""}}),babelHelpers.toConsumableArray(e.entityStorage.getSprints().values()).map(function(t){if(t.isPlanned()){return t.render()}else{return""}}),babelHelpers.toConsumableArray(e.entityStorage.getSprints().values()).map(function(t){if(t.isCompleted()){return t.render()}else{return""}}))};var r=c.Tag.render($t(),i(),s(),n());this.completedSprintLoader=r.querySelector(".tasks-scrum-sprint-completed-loader");this.bindLoadCompletedSprints(this.completedSprintLoader);return r}},{key:"showDropZoneForSprintCreating",value:function t(e){if(this.isSprintSourceEntity(e)){return}var i=this.getSprintCreatingDropZoneNode();if(!i){return}i.className="tasks-scrum-sprint-sprint-drop"}},{key:"hideDropZoneForSprintCreating",value:function t(e){if(this.isSprintSourceEntity(e)){return}var i=this.getSprintCreatingDropZoneNode();if(!i){return}i.className="tasks-scrum-sprint-sprint-drop-hide"}},{key:"isSprintSourceEntity",value:function t(e){if(e&&e.sourceContainer){var i=e.sourceContainer;var s=parseInt(i.dataset.entityId,10);var n=this.entityStorage.findEntityByEntityId(s);if(n&&n.getEntityType()==="sprint"){return true}}return false}},{key:"bindLoadCompletedSprints",value:function t(e){var i=this;var s=new IntersectionObserver(function(t){if(t[0].isIntersecting===true){if(!i.isActiveLoadCompletedSprints){i.onLoadCompletedSprints()}}},{threshold:[0]});s.observe(e)}},{key:"onLoadCompletedSprints",value:function t(){var e=this;this.isActiveLoadCompletedSprints=true;var i=this.showLoader(this.completedSprintLoader);var s={pageNumber:this.pageNumberToCompletedSprints+1};this.requestSender.getCompletedSprints(s).then(function(t){var s=t.data;if(c.Type.isArray(s)&&s.length){e.pageNumberToCompletedSprints++;e.isActiveLoadCompletedSprints=false;e.createSprints(s)}i.hide()}).catch(function(t){i.hide();e.isActiveLoadCompletedSprints=false;e.requestSender.showErrorAlert(t)})}},{key:"createSprints",value:function t(e){var i=this;var s=this.sprintListNode.querySelector(".tasks-scrum-sprint-completed-list");e.forEach(function(t){var e=Mt.buildSprint(t);if(!i.entityStorage.findEntityByEntityId(e.getId())){i.entityStorage.addSprint(e);i.append(e.render(),s);e.onAfterAppend();i.emit("createSprint",e)}})}},{key:"showLoader",value:function t(e){var i=this.getPosition(e);var s=new r.Loader({target:e,size:60,mode:"inline",color:"rgba(82, 92, 105, 0.9)",offset:{left:"".concat(i.width/2-30,"px")}});s.show();return s}},{key:"createSprint",value:function t(){var e=this;this.hideDropZoneForSprintCreating();var i=this.entityStorage.getSprints().size;var s=c.Loc.getMessage("TASKS_SCRUM_SPRINT_NAME").replace("%s",i+1);var n=0;var r=Math.floor(Date.now()/1e3);var a=Math.floor(Date.now()/1e3)+parseInt(this.defaultSprintDuration,10);var o=this.sprintListNode.querySelector(".tasks-scrum-sprint-planned-list");var u=o.children.length?o.children.length+1:1;var l=Mt.buildSprint({name:s,sort:u,dateStart:r,dateEnd:a,storyPoints:n});this.append(l.render(),o);var d={tmpId:c.Text.getRandom(),name:s,sort:u,dateStart:r,dateEnd:a};this.emit("beforeCreateSprint",d);return this.requestSender.createSprint(d).then(function(t){l.setId(t.data.sprintId);l.onAfterAppend();l.getNode().scrollIntoView(true);e.entityStorage.addSprint(l);e.draggableItems.addContainer(l.getListItemsNode());e.emit("createSprint",l);return l}).catch(function(t){e.requestSender.showErrorAlert(t)})}},{key:"createSprintNode",value:function t(e){this.remove(this.sprintCreatingDropZoneNode);var i=this.sprintListNode.querySelector(".tasks-scrum-sprint-planned-list");this.append(e.render(),i);e.onAfterAppend();this.entityStorage.addSprint(e);this.draggableItems.addContainer(e.getListItemsNode());this.emit("createSprintNode",e)}},{key:"moveSprintToActiveListNode",value:function t(e){var i=this.sprintListNode.querySelector(".tasks-scrum-sprint-active-list");this.append(e.getNode(),i)}},{key:"moveSprintToCompletedListNode",value:function t(e){var i=this.sprintListNode.querySelector(".tasks-scrum-sprint-completed-list");if(i.firstElementChild){this.insertBefore(e.getNode(),i.firstElementChild)}else{this.append(e.getNode(),i)}}},{key:"append",value:function t(e,i){c.Dom.append(e,i)}},{key:"insertBefore",value:function t(e,i){c.Dom.insertBefore(e,i)}},{key:"remove",value:function t(e){c.Dom.remove(e)}},{key:"getPosition",value:function t(e){return c.Dom.getPosition(e)}},{key:"appendItemAfterItem",value:function t(e,i){if(i.nextElementSibling){c.Dom.insertBefore(e,i.nextElementSibling)}else{c.Dom.append(e,i.parentElement)}}}]);return e}(d.EventEmitter);var ne=function(){function t(e){babelHelpers.classCallCheck(this,t);this.requestSender=e.requestSender;this.domBuilder=e.domBuilder;this.listSubTasks=new Map;this.visibilityList=new Set}babelHelpers.createClass(t,[{key:"toggleSubTasks",value:function t(e,i){var s=this;if(this.listSubTasks.has(i.getItemId())){if(this.isShown(i)){this.hideSubTaskItems(e,i)}else{this.showSubTaskItems(e,i)}i.toggleSubTasksTick();return Promise.resolve()}else{return this.requestSender.getSubTaskItems({entityId:e.getId(),taskId:i.getSourceId()}).then(function(t){var n=t.data;var r=new Map;n.forEach(function(t){var e=s.buildSubTaskItem(t);r.set(e.getItemId(),e)});s.listSubTasks.set(i.getItemId(),r);if(s.isShown(i)){s.hideSubTaskItems(e,i)}else{s.showSubTaskItems(e,i)}i.toggleSubTasksTick()}).catch(function(t){s.requestSender.showErrorAlert(t)})}}},{key:"buildSubTaskItem",value:function t(e){return new O(e)}},{key:"showSubTaskItems",value:function t(e,i){var s=this;var n=i.getItemNode();var r=this.listSubTasks.get(i.getItemId());if(!r){return}r.forEach(function(t){e.setItem(t);s.domBuilder.appendItemAfterItem(t.render(),n);t.onAfterAppend(e.getListItemsNode())});this.setVisibility(i)}},{key:"hideSubTaskItems",value:function t(e,i){var s=this;var n=this.listSubTasks.get(i.getItemId());if(!n){return}n.forEach(function(t){if(t.isParentTask()){s.hideSubTaskItems(e,t)}e.removeItem(t);t.removeYourself()});this.cleanVisibility(i)}},{key:"addSubTask",value:function t(e,i){if(this.listSubTasks.has(e.getItemId())){var s=this.listSubTasks.get(e.getItemId());s.set(i.getItemId(),i);this.listSubTasks.set(e.getItemId(),s)}else{var n=new Map;n.set(i.getItemId(),i);return this.listSubTasks.set(e.getItemId(),n)}}},{key:"getSubTasks",value:function t(e){return this.listSubTasks.get(e.getItemId())}},{key:"isShown",value:function t(e){return this.visibilityList.has(e.getItemId())}},{key:"setVisibility",value:function t(e){this.visibilityList.add(e.getItemId())}},{key:"cleanVisibility",value:function t(e){this.visibilityList.delete(e.getItemId())}},{key:"cleanSubTasks",value:function t(e){this.listSubTasks.delete(e.getItemId())}}]);return t}();function re(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-decomposition-structure">\n\t\t\t\t<button class="ui-btn ui-btn-sm ui-btn-primary">\n\t\t\t\t\t',"\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t"]);re=function e(){return t};return t}var ae=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.entity=t.entity;i.itemStyleDesigner=t.itemStyleDesigner;i.subTasksCreator=t.subTasksCreator;i.setEventNamespace("BX.Tasks.Scrum.Decomposition");i.items=new Set;i.input=new W;i.input.setPlaceholder(c.Loc.getMessage("TASKS_SCRUM_TASK_ADD_DECOMPOSITION_INPUT_PLACEHOLDER"));i.input.subscribe("tagsSearchOpen",function(t){i.emit("tagsSearchOpen",{inputObject:t.getTarget(),enteredHashTagName:t.getData()})});i.input.subscribe("tagsSearchClose",function(){return i.emit("tagsSearchClose")});return i}babelHelpers.createClass(e,[{key:"decomposeItem",value:function t(e){var i=this;this.addDecomposedItem(e);if(this.isBacklogDecomposition()){this.onDecomposeItem(e,e.getItemNode())}else{if(!this.subTasksCreator.isShown(e)){this.subTasksCreator.toggleSubTasks(this.entity,e).then(function(){var t=i.getSubTasks(e)[0];var s=t?t.getItemNode():e.getItemNode();i.onDecomposeItem(e,s)})}else{var s=this.getSubTasks(e)[0];this.onDecomposeItem(e,s.getItemNode())}}}},{key:"onDecomposeItem",value:function t(e,i){var s=this;c.Dom.insertAfter(this.input.render(),i);this.input.setNode();var n=this.input.getInputNode();c.Event.bind(n,"input",this.input.onTagSearch.bind(this.input));c.Event.bind(n,"keydown",this.onCreateItem.bind(this));n.focus();var r=this.createButton();c.Dom.insertAfter(r,this.input.getNode());c.Event.bind(r.querySelector("button"),"click",function(){if(s.isBacklogDecomposition()&&s.isFirstDecomposition()&&!e.isLinkedTask()){e.setBorderColor()}if(!s.isBacklogDecomposition()){if(s.subTasksCreator.isShown(e)){s.subTasksCreator.hideSubTaskItems(s.entity,e)}s.subTasksCreator.cleanSubTasks(e)}s.deactivateDecompositionMode();s.input.removeYourself();c.Dom.remove(r)});this.setResponsible(e.getResponsible())}},{key:"getSubTasks",value:function t(e){return Array.from(this.subTasksCreator.getSubTasks(e).values())}},{key:"getLastDecomposedItemNode",value:function t(e){if(this.isBacklogDecomposition()){var i=this.getDecomposedItems();var s=Array.from(i).pop();return s.getItemNode()}else{var n=this.getSubTasks(e);if(n.length){var r=this.isFirstDecomposition()?n[0]:n.pop();return r.getItemNode()}else{return e.getItemNode()}}}},{key:"isBacklogDecomposition",value:function t(){return this.entity.getEntityType()==="backlog"}},{key:"addDecomposedItem",value:function t(e){this.activateDecompositionMode(e);e.subscribe("changeTaskResponsible",this.saveSelectedResponsible.bind(this));this.items.add(e)}},{key:"getDecomposedItems",value:function t(){return this.items}},{key:"activateDecompositionMode",value:function t(e){var i=this;if(this.isBacklogDecomposition()){this.itemStyleDesigner.getRandomColorForItemBorder().then(function(t){e.activateDecompositionMode(t);i.setBorderColor(e.getBorderColor())})}else{e.activateDecompositionMode()}}},{key:"deactivateDecompositionMode",value:function t(){this.items.forEach(function(t){t.deactivateDecompositionMode()});this.items.clear()}},{key:"createButton",value:function t(){return c.Tag.render(re(),c.Loc.getMessage("TASKS_SCRUM_DECOMPOSITION_BUTTON"))}},{key:"onCreateItem",value:function t(e){if(e.isComposing||e.keyCode===13){if(!this.input.isTagsSearchMode()){var i=e.target;if(i.value){var s=this.getParentItem();if(this.isBacklogDecomposition()){if(this.isFirstDecomposition()&&!s.isLinkedTask()){this.emit("updateParentItem",{itemId:s.getItemId(),entityId:s.getEntityId(),itemType:s.getItemType(),info:s.getInfo()})}}this.emit("createItem",i.value);i.value="";i.focus()}}}}},{key:"isFirstDecomposition",value:function t(){return this.items.size===1}},{key:"getParentItem",value:function t(){var e=this.items.values();return e.next().value}},{key:"saveSelectedResponsible",value:function t(e){var i=e.getTarget();this.setResponsible(i.getResponsible())}},{key:"getResponsible",value:function t(){return this.responsible}},{key:"setResponsible",value:function t(e){this.responsible=e}},{key:"setBorderColor",value:function t(e){this.borderColor=c.Type.isString(e)?e:""}},{key:"getBorderColor",value:function t(){return this.borderColor}}]);return e}(d.EventEmitter);var oe=function(){function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,t);this.setId(e.id);this.setName(e.name);this.setSort(e.sort);this.setDodRequired(e.dodRequired)}babelHelpers.createClass(t,[{key:"setId",value:function t(e){this.id=c.Type.isInteger(e)?parseInt(e,10):c.Type.isString(e)&&e?e:c.Text.getRandom()}},{key:"getId",value:function t(){return this.id}},{key:"setName",value:function t(e){this.name=c.Type.isString(e)?e:""}},{key:"getName",value:function t(){return this.name}},{key:"setSort",value:function t(e){this.sort=c.Type.isInteger(e)?parseInt(e,10):0}},{key:"getSort",value:function t(){return this.sort}},{key:"setDodRequired",value:function t(e){this.dodRequired=e==="Y"}},{key:"isDodRequired",value:function t(){return this.dodRequired}}]);return t}();var ue=function(){function t(e){babelHelpers.classCallCheck(this,t);this.types=e.types}babelHelpers.createClass(t,[{key:"getNextType",value:function t(){return this.types.values().next().value}},{key:"getTypes",value:function t(){return this.types}},{key:"addType",value:function t(e){this.types.set(e.getId(),e)}},{key:"removeType",value:function t(e){this.types.delete(e.getId())}}]);return t}();function le(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="text" class="tasks-scrum-dod-settings-type-name-input" value="','">\n\t\t']);le=function e(){return t};return t}function ce(){var t=babelHelpers.taggedTemplateLiteral(['<div class="tasks-scrum-dod-settings-type-name"></div>']);ce=function e(){return t};return t}function de(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="sidebar-tab sidebar-tab-active">\n\t\t\t\t<input type="text" class="tasks-scrum-dod-settings-type-name-input">\n\t\t\t</div>\n\t\t']);de=function e(){return t};return t}function pe(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="','">\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-type-name">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-type-edit"></div>\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-type-remove"></div>\n\t\t\t\t</div>\n\t\t\t']);pe=function e(){return t};return t}function he(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="sidebar-tab-link">\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-type-name">\n\t\t\t\t\t\t+ ',"\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"]);he=function e(){return t};return t}function me(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="','">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"]);me=function e(){return t};return t}var ve=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.Dod.Tabs");i.typeStorage=t.typeStorage;i.tabNodes=new Map;i.activeType=null;i.previousType=null;i.setActiveType(i.typeStorage.getNextType());return i}babelHelpers.createClass(e,[{key:"render",value:function t(){var e=this;var i="tasks-scrum-dod-settings-container-sidebar"+" tasks-scrum-dod-settings-container-sidebar-settings";this.node=c.Tag.render(me(),i,babelHelpers.toConsumableArray(this.typeStorage.getTypes().values()).map(function(t){return e.renderTab(t)}));return this.node}},{key:"isEmpty",value:function t(){return this.tabNodes.size===0}},{key:"renderTab",value:function t(e){var i=this;if(this.isEmptyType(e)){var s=c.Tag.render(he(),c.Loc.getMessage("TASKS_SCRUM_CREATE_TYPE"));c.Event.bind(s,"click",this.createType.bind(this));return s}else{var n=this.isActiveType(e)?"sidebar-tab sidebar-tab-active":"sidebar-tab";var r=c.Tag.render(pe(),n,c.Text.encode(e.getName()));this.tabNodes.set(e.getId(),r);c.Event.bind(r,"click",function(t){var s=t.target.classList.contains("tasks-scrum-dod-settings-type-edit");var n=t.target.classList.contains("tasks-scrum-dod-settings-type-remove");if(!i.isActiveType(e)){i.switchType(e,r)}if(s){i.changeTypeName(e,r)}if(n){i.removeType(e,r)}});return r}}},{key:"addType",value:function t(e,i){if(i){c.Dom.remove(this.tabNodes.get(i.getId()));this.tabNodes.delete(i.getId())}var s=this.renderTab(e);c.Dom.insertBefore(s,this.node.lastElementChild);this.switchType(e,s)}},{key:"switchType",value:function t(e,i){var s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;this.tabNodes.forEach(function(t){c.Dom.removeClass(t,"sidebar-tab-active")});c.Dom.addClass(i,"sidebar-tab-active");if(s&&!this.isEmpty()){this.setPreviousType(this.getActiveType())}else{this.setPreviousType(null)}this.setActiveType(e);this.emit("switchType",e)}},{key:"createType",value:function t(){var e=this;var i=new oe;i.setSort(this.typeStorage.getTypes().size);this.tabNodes.forEach(function(t){c.Dom.removeClass(t,"sidebar-tab-active")});var s=c.Tag.render(de());var n=c.Tag.render(ce());c.Dom.insertBefore(s,this.node.lastElementChild);var r=s.querySelector("input");c.Event.bind(r,"change",function(t){i.setName(t.target["value"]);e.emit("createType",i);n.textContent=c.Text.encode(i.getName());c.Dom.replace(r,n)},true);c.Event.bind(r,"blur",function(t){if(t.target["value"].trim()===""){c.Dom.remove(s)}},true);c.Event.bind(r,"keydown",function(t){if(t.isComposing||t.keyCode===13){r.blur()}});r.focus();this.tabNodes.set(i.getId(),s)}},{key:"changeTypeName",value:function t(e,i){var s=this;var n=c.Tag.render(le(),c.Text.encode(e.getName()));var r=i.querySelector(".tasks-scrum-dod-settings-type-name");c.Event.bind(n,"change",function(t){e.setName(t.target["value"]);s.emit("changeTypeName",e);n.blur()},true);c.Event.bind(n,"blur",function(){r.textContent=c.Text.encode(e.getName());c.Dom.replace(n,r)},true);c.Event.bind(n,"keydown",function(t){if(t.isComposing||t.keyCode===13){n.blur()}});c.Dom.replace(r,n);n.focus();n.setSelectionRange(e.getName().length,e.getName().length)}},{key:"removeType",value:function t(e,i){var s=this;u.MessageBox.confirm(c.Loc.getMessage("TASKS_SCRUM_CONFIRM_TEXT_REMOVE_TYPE"),function(t){s.tabNodes.delete(e.getId());if(s.isActiveType(e)){s.setActiveType(null)}s.setPreviousType(null);c.Dom.remove(i);s.emit("removeType",e);t.close()},c.Loc.getMessage("TASKS_SCRUM_BUTTON_TEXT_REMOVE"))}},{key:"setActiveType",value:function t(e){this.activeType=e}},{key:"getActiveType",value:function t(){return this.activeType}},{key:"setPreviousType",value:function t(e){this.previousType=e}},{key:"getPreviousType",value:function t(){return this.previousType}},{key:"isActiveType",value:function t(e){return this.activeType&&this.activeType.getId()===e.getId()}},{key:"setEmptyType",value:function t(e){this.emptyType=e}},{key:"isEmptyType",value:function t(e){return e.getId()===this.emptyType.getId()}},{key:"switchToType",value:function t(e){this.switchType(e,this.tabNodes.get(e.getId()),false)}}]);return e}(d.EventEmitter);function ge(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form-row">\n\t\t\t\t<label class="ui-ctl ui-ctl-checkbox">\n\t\t\t\t\t<input type="checkbox" class="ui-ctl-element ui-form-content-required-option">\n\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t"]);ge=function e(){return t};return t}function fe(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form">\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);fe=function e(){return t};return t}function be(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form">\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content ui-form-content-dod-list"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t']);be=function e(){return t};return t}function ye(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-dod-settings">\n\t\t\t\t<div class="tasks-scrum-dod-settings-container">\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-container-wrap">\n\t\t\t\t\t\t<div class="tasks-scrum-dod-settings-container-shell">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t<div class="tasks-scrum-dod-settings-container-sidebar-wrapper"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t']);ye=function e(){return t};return t}var ke=function(){function t(e){babelHelpers.classCallCheck(this,t);this.requestSender=e.requestSender;this.entityId=e.entityId;this.types=e.types;this.typeStorage=new ue({types:this.types});this.tabs=new ve({typeStorage:this.typeStorage});this.tabs.subscribe("switchType",this.onSwitchType.bind(this));this.tabs.subscribe("createType",this.onCreateType.bind(this));this.tabs.subscribe("changeTypeName",this.onChangeTypeName.bind(this));this.tabs.subscribe("removeType",this.onRemoveType.bind(this));this.addEmptyCreationType()}babelHelpers.createClass(t,[{key:"renderTo",value:function t(e){if(!c.Type.isDomNode(e)){throw new Error("DoD Settings: HTMLElement for dod settings not found")}c.Dom.append(this.render(),e);if(this.tabs.isEmpty()){this.buildEmptyForm()}else{this.buildEditingForm(this.typeStorage.getNextType())}}},{key:"render",value:function t(){this.node=c.Tag.render(ye(),this.tabs.render());return this.node}},{key:"renderEditingForm",value:function t(e){return c.Tag.render(be(),this.renderRequiredOption(e))}},{key:"renderEmptyForm",value:function t(){return c.Tag.render(fe(),c.Loc.getMessage("TASKS_SCRUM_CREATE_TYPE_PROMPT"))}},{key:"renderRequiredOption",value:function t(e){var i=this;var s=c.Tag.render(ge(),c.Loc.getMessage("TASKS_SCRUM_DOD_OPTIONS_REQUIRED_LABEL"));var n=s.querySelector(".ui-form-content-required-option");n.checked=e.isDodRequired();c.Event.bind(n,"click",function(){i.updateActiveType()});return s}},{key:"buildEditingForm",value:function t(e){var i=this;var s=this.cleanTypeForm();c.Dom.append(this.renderEditingForm(e),s);var n=this.node.querySelector(".ui-form-content-dod-list");var r=this.showLoader(n);this.requestSender.getDodChecklist({entityId:e.getId()}).then(function(t){r.hide();c.Runtime.html(n,t.data.html)}).catch(function(t){r.hide();i.requestSender.showErrorAlert(t)})}},{key:"buildEmptyForm",value:function t(){var e=this.cleanTypeForm();c.Dom.append(this.renderEmptyForm(),e)}},{key:"onSwitchType",value:function t(e){var i=this;var s=e.getData();var n=this.tabs.getPreviousType();if(n){this.saveSettings(n).then(function(){i.buildEditingForm(s)})}else{this.buildEditingForm(s)}}},{key:"onCreateType",value:function t(e){var i=this;var s=this.node.querySelector(".tasks-scrum-dod-settings-container-sidebar-wrapper");var n=this.showLoader(s);var r=e.getData();this.requestSender.createType({entityId:this.entityId,name:r.getName(),sort:r.getSort()}).then(function(t){n.hide();var e=new oe(t.data);i.typeStorage.addType(e);i.tabs.addType(e,r)}).catch(function(t){n.hide();i.requestSender.showErrorAlert(t)})}},{key:"onChangeTypeName",value:function t(e){var i=this;var s=e.getData();this.requestSender.changeTypeName({id:s.getId(),name:s.getName()}).catch(function(t){i.requestSender.showErrorAlert(t)})}},{key:"onRemoveType",value:function t(e){var i=this;var s=e.getData();this.requestSender.removeType({id:s.getId()}).then(function(){i.typeStorage.removeType(s);if(i.tabs.isEmpty()){i.buildEmptyForm()}else{var t=babelHelpers.toConsumableArray(i.typeStorage.getTypes().values()).find(function(t){return!i.tabs.isEmptyType(t)});i.tabs.switchToType(t)}}).catch(function(t){i.requestSender.showErrorAlert(t)})}},{key:"saveSettings",value:function t(e){var i=this;if(this.tabs.isEmpty()){return Promise.resolve()}var s=e?e:this.tabs.getActiveType();if(!(s instanceof oe)){return Promise.resolve()}return this.requestSender.saveDodSettings({entityId:s.getId(),requiredOption:this.getRequiredOptionValue(),items:this.getChecklistItems()}).catch(function(t){i.requestSender.showErrorAlert(t)})}},{key:"getChecklistItems",value:function t(){if(typeof BX.Tasks.CheckListInstance==="undefined"){return[]}var e=BX.Tasks.CheckListInstance.getTreeStructure();return e.getRequestData()}},{key:"getRequiredOptionValue",value:function t(){var e=this.node.querySelector(".ui-form-content-required-option");return e.checked===true?"Y":"N"}},{key:"showLoader",value:function t(e){var i=c.Dom.getPosition(e);var s=new r.Loader({target:e,size:60,mode:"inline",color:"rgba(82, 92, 105, 0.9)",offset:{left:"".concat(i.width/2-30,"px")}});s.show();return s}},{key:"updateActiveType",value:function t(){var e=this.tabs.getActiveType();e.setDodRequired(this.getRequiredOptionValue())}},{key:"cleanTypeForm",value:function t(){var e=this.node.querySelector(".tasks-scrum-dod-settings-container-sidebar-wrapper");c.Dom.clean(e);return e}},{key:"addEmptyCreationType",value:function t(){var e=new oe;this.tabs.setEmptyType(e);this.typeStorage.addType(e)}}]);return t}();function Se(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-dod-side-panel">\n\t\t\t\t<div class="tasks-scrum-dod-side-panel-header">\n\t\t\t\t\t<span class="tasks-scrum-dod-side-panel-header-title">\n\t\t\t\t\t\t','\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-dod-side-panel-container"></div>\n\t\t\t</div>\n\t\t']);Se=function e(){return t};return t}var Te=function(){function t(e){babelHelpers.classCallCheck(this,t);this.sidePanel=e.sidePanel;this.requestSender=e.requestSender}babelHelpers.createClass(t,[{key:"showSettingsPanel",value:function t(e){var i=this;this.sidePanelId="tasks-scrum-dod-side-panel";this.entity=e;this.sidePanel.unsubscribeAll("onLoadSidePanel");this.sidePanel.subscribeOnce("onLoadSidePanel",this.onLoadSettingsPanel.bind(this));this.sidePanel.subscribeOnce("onCloseSidePanel",this.onCloseSettingsPanel.bind(this));this.sidePanel.openSidePanel(this.sidePanelId,{contentCallback:function t(){return new Promise(function(t,e){t(i.buildSettingsPanel())})},zIndex:1e3})}},{key:"buildSettingsPanel",value:function t(){return c.Tag.render(Se(),c.Loc.getMessage("TASKS_SCRUM_DOD_HEADER"))}},{key:"onLoadSettingsPanel",value:function t(e){var i=this;var s=e.getData();s.showLoader();var n=s.getContainer().querySelector(".tasks-scrum-dod-side-panel-container");var r={entityId:this.entity.getId()};this.requestSender.getDodSettings(r).then(function(t){s.closeLoader();var e=c.Type.isArray(t.data.types)?t.data.types:[];var r=new Map;e.forEach(function(t){var e=new oe(t);r.set(e.getId(),e)});i.settings=new ke({requestSender:i.requestSender,entityId:i.entity.getId(),types:r});i.settings.renderTo(n)}).catch(function(t){i.requestSender.showErrorAlert(t,c.Loc.getMessage("TASKS_SCRUM_ERROR_TITLE_POPUP"))})}},{key:"onCloseSettingsPanel",value:function t(e){if(this.settings){this.settings.saveSettings().then(function(){}).catch(function(){})}}}]);return t}();var Ie=function(){function t(e){babelHelpers.classCallCheck(this,t);this.data=e;this.chart=null}babelHelpers.createClass(t,[{key:"createChart",value:function t(e){am4core.useTheme(am4themes_animated);this.chart=am4core.create(e,am4charts.XYChart);this.chart.data=this.data;this.chart.paddingRight=40;this.chart.scrollbarX=new am4core.Scrollbar;this.chart.scrollbarX.parent=this.chart.bottomAxesContainer;this.createAxises();this.createColumn("plan",c.Loc.getMessage("TASKS_SCRUM_TEAM_SPEED_CHART_PLAN_COLUMN"),"#2882b3");this.createColumn("done",c.Loc.getMessage("TASKS_SCRUM_TEAM_SPEED_CHART_DONE_COLUMN"),"#9c1f1f");this.createLegend()}},{key:"createAxises",value:function t(){var e=this.chart.xAxes.push(new am4charts.CategoryAxis);e.dataFields.category="sprintName";e.renderer.grid.template.location=0;var i=e.renderer.labels.template;i.wrap=true;i.maxWidth=120;var s=this.chart.yAxes.push(new am4charts.ValueAxis);s.min=0}},{key:"createColumn",value:function t(e,i,s){var n=this.chart.series.push(new am4charts.ColumnSeries);n.dataFields.valueY=e;n.dataFields.categoryX="sprintName";n.name=i;n.stroke=am4core.color(s);n.fill=am4core.color(s);return n}},{key:"createLegend",value:function t(){this.chart.legend=new am4charts.Legend;this.chart.legend.position="bottom";this.chart.legend.paddingBottom=20;this.chart.legend.itemContainers.template.clickable=false}},{key:"destroyChart",value:function t(){this.chart.dispose()}}]);return t}();function Ce(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-project-side-panel">\n\t\t\t\t<div class="tasks-scrum-project-side-panel-header">\n\t\t\t\t\t<span class="tasks-scrum-project-side-panel-header-title">\n\t\t\t\t\t\t','\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-project-side-panel-chart"></div>\n\t\t\t\t<div class="tasks-scrum-project-side-panel-buttons"></div>\n\t\t\t</div>\n\t\t']);Ce=function e(){return t};return t}var Ee=function(){function t(e){babelHelpers.classCallCheck(this,t);this.sidePanel=e.sidePanel;this.requestSender=e.requestSender}babelHelpers.createClass(t,[{key:"showTeamSpeedChart",value:function t(){var e=this;this.sidePanelId="tasks-scrum-team-speed-chart";this.sidePanel.unsubscribeAll("onLoadSidePanel");this.sidePanel.subscribeOnce("onLoadSidePanel",this.onLoadTeamSpeedChartPanel.bind(this));this.sidePanel.subscribe("onCloseSidePanel",this.onCloseTeamSpeedChart.bind(this));this.sidePanel.openSidePanel(this.sidePanelId,{contentCallback:function t(){return new Promise(function(t,i){t(e.buildTeamSpeedPanel())})},zIndex:1e3})}},{key:"buildTeamSpeedPanel",value:function t(){return c.Tag.render(Ce(),c.Loc.getMessage("TASKS_SCRUM_TEAM_SPEED_CHART_HEADER"))}},{key:"onLoadTeamSpeedChartPanel",value:function t(e){var i=this;var s=e.getData();s.showLoader();this.form=s.getContainer().querySelector(".tasks-scrum-project-side-panel");this.getTeamSpeedChartData().then(function(t){s.closeLoader();setTimeout(function(){i.teamSpeedChart=new Ie(t);i.teamSpeedChart.createChart(i.form.querySelector(".tasks-scrum-project-side-panel-chart"))},300)})}},{key:"onCloseTeamSpeedChart",value:function t(e){var i=this;var s=e.getData();if(this.sidePanelId===s.getUrl()){setTimeout(function(){if(i.teamSpeedChart){i.teamSpeedChart.destroyChart();i.teamSpeedChart=null}},300)}}},{key:"getTeamSpeedChartData",value:function t(){var e=this;return new Promise(function(t,i){e.requestSender.getTeamSpeedChartData().then(function(e){t(e.data)})})}}]);return t}();var Pe=function(){function t(e){babelHelpers.classCallCheck(this,t);this.requestSender=e.requestSender;this.entityStorage=e.entityStorage}babelHelpers.createClass(t,[{key:"updateCounters",value:function t(e){var i=this;var s={entityIds:babelHelpers.toConsumableArray(e.keys())};this.requestSender.getEntityCounters(s).then(function(t){Object.keys(t.data).forEach(function(i){i=parseInt(i,10);var s=e.get(i);var n=t.data[i];s.setStoryPoints(n.storyPoints);s.setNumberTasks(n.numberTasks);if(s.isActive()){s.setCompletedStoryPoints(n.completedStoryPoints);s.setUncompletedStoryPoints(n.uncompletedStoryPoints)}})}).catch(function(t){i.requestSender.showErrorAlert(t)})}}]);return t}();var Ae=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.filter=t.filter;i.requestSender=t.requestSender;i.entityStorage=t.entityStorage;i.subTasksCreator=t.subTasksCreator;i.filter.subscribe("applyFilter",i.onApplyFilter.bind(babelHelpers.assertThisInitialized(i)));return i}babelHelpers.createClass(e,[{key:"onApplyFilter",value:function t(e){var i=this;this.fadeOutAll();var s=e.getData();this.updateExactSearchStatusToEntities();this.requestSender.applyFilter().then(function(t){s.promise.fulfill();var e=t.data;i.entityStorage.getAllItems().forEach(function(t){var e=i.entityStorage.findEntityByEntityId(t.getEntityId());if(t.isParentTask()){i.subTasksCreator.cleanVisibility(t);i.subTasksCreator.cleanSubTasks(t)}e.removeItem(t);t.removeYourself()});e.forEach(function(t){var e=O.buildItem(t);var s=i.entityStorage.findEntityByEntityId(e.getEntityId());c.Dom.append(e.render(),s.getListItemsNode());s.setItem(e);e.onAfterAppend(s.getListItemsNode());if(e.isParentTask()){e.downSubTasksTick()}});i.updateVisibilityToEntities();i.fadeInAll()}).catch(function(t){s.promise.reject();i.fadeInAll();i.requestSender.showErrorAlert(t)})}},{key:"updateExactSearchStatusToEntities",value:function t(){var e=this;this.entityStorage.getSprints().forEach(function(t){t.setExactSearchApplied(e.filter.isSearchFieldApplied())})}},{key:"updateVisibilityToEntities",value:function t(){this.entityStorage.getSprints().forEach(function(t){t.updateVisibility()})}},{key:"fadeOutAll",value:function t(){this.entityStorage.getBacklog().fadeOut();this.entityStorage.getSprints().forEach(function(t){t.fadeOut()})}},{key:"fadeInAll",value:function t(){this.entityStorage.getBacklog().fadeIn();this.entityStorage.getSprints().forEach(function(t){t.fadeIn()})}}]);return e}(d.EventEmitter);function De(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-epic-form-header">\n\t\t\t\t<div class="tasks-scrum-epic-form-header-title">\n\t\t\t\t\t<input type="text" name="name" value="','" class=\n\t\t\t\t\t\t"tasks-scrum-epic-form-header-title-control" placeholder=\n\t\t\t\t\t\t"','">\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-epic-form-header-separate"></div>\n\t\t\t\t<div class="tasks-scrum-epic-header-color">\n\t\t\t\t\t<div class="tasks-scrum-epic-header-color-current" style=\n\t\t\t\t\t\t"background-color: ',';">\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-epic-header-color-btn-angle">\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t']);De=function e(){return t};return t}function we(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-epic-header">\n\t\t\t\t<div class="tasks-scrum-epic-header-title">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);we=function e(){return t};return t}function Ne(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-epics-empty">\n\t\t\t\t<div class="tasks-scrum-epics-empty-first-title">\n\t\t\t\t\t','\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-epics-empty-image">\n\t\t\t\t\t<svg width="124px" height="123px" viewBox="0 0 124 123" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n\t\t\t\t\t\t<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" opacity="0.28">\n\t\t\t\t\t\t\t<path d="M83,105 L83,81.4375 L105,81.4375 L105,18 L17,18 L17,81.4375 L39,81.4375 L39,105 L83,105 Z M10.9411765,0 L113.058824,0 C119.101468,0 124,4.85902727 124,10.8529412 L124,112.147059 C124,118.140973 119.101468,123 113.058824,123 L10.9411765,123 C4.89853156,123 0,118.140973 0,112.147059 L0,10.8529412 C0,4.85902727 4.89853156,0 10.9411765,0 Z M44.0142862,47.0500004 L54.2142857,57.4416671 L79.7142857,32 L87,42.75 L54.2142857,75 L36,57.0833333 L44.0142862,47.0500004 Z" fill="#A8ADB4" />\n\t\t\t\t\t\t</g>\n\t\t\t\t\t</svg>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-epics-empty-second-title">\n\t\t\t\t\t','\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-epics-empty-button">\n\t\t\t\t\t<button class="ui-btn ui-btn-primary ui-btn-lg">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);Ne=function e(){return t};return t}function Le(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-epic-form">\n\t\t\t\t','\n\t\t\t\t<div class="tasks-scrum-epic-form-container">\n\t\t\t\t\t','\n\t\t\t\t\t<div class="tasks-scrum-epic-form-body">\n\t\t\t\t\t\t<div class="tasks-scrum-epic-form-description"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-epic-form-buttons"></div>\n\t\t\t</div>\n\t\t']);Le=function e(){return t};return t}function Me(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-epic-form">\n\t\t\t\t','\n\t\t\t\t<div class="tasks-scrum-epic-form-container">\n\t\t\t\t\t<div class="tasks-scrum-epic-form-header">\n\t\t\t\t\t\t<div class="tasks-scrum-epic-form-header-title">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="tasks-scrum-epic-form-header-separate"></div>\n\t\t\t\t\t\t<div class="tasks-scrum-epic-header-color">\n\t\t\t\t\t\t\t<div class="tasks-scrum-epic-header-color-current" style=\n\t\t\t\t\t\t\t\t"background-color: ',';">\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="tasks-scrum-epic-header-color-btn-angle">\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-epic-form-body">\n\t\t\t\t\t\t<div class="tasks-scrum-epic-form-description" style="padding: 15px 10px 15px 10px;"></div>\n\t\t\t\t\t\t<div class="tasks-scrum-epic-form-files"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-epic-form-buttons"></div>\n\t\t\t</div>\n\t\t']);Me=function e(){return t};return t}function Be(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-epic-form">\n\t\t\t\t','\n\t\t\t\t<div class="tasks-scrum-epic-form-container">\n\t\t\t\t\t','\n\t\t\t\t\t<div class="tasks-scrum-epic-form-body">\n\t\t\t\t\t\t<div class="tasks-scrum-epic-form-description"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-epic-form-buttons"></div>\n\t\t\t</div>\n\t\t']);Be=function e(){return t};return t}function _e(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="tasks-scrum-epics-list">\n\t\t\t\t\t\t<div class="tasks-scrum-epic-header">\n\t\t\t\t\t\t\t<div class="tasks-scrum-epic-header-title">\n\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="tasks-scrum-epic-header-add-button">\n\t\t\t\t\t\t\t\t<button class="ui-btn ui-btn-primary ui-btn-sm">\n\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="tasks-scrum-epics-list-grid"></div>\n\t\t\t\t\t</div>\n\t\t\t\t']);_e=function e(){return t};return t}var He=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.Epic");i.requestSender=t.requestSender;i.entityStorage=t.entityStorage;i.sidePanel=t.sidePanel;i.entity=t.entity;i.filter=t.filter;i.tagSearcher=t.tagSearcher;i.form=null;i.defaultColor="#69dafc";i.selectedColor="";i.currentEpic=null;return i}babelHelpers.createClass(e,[{key:"getCurrentEpic",value:function t(){return this.currentEpic}},{key:"openAddForm",value:function t(){var e=this;this.id=c.Text.getRandom();this.sidePanelId="tasks-scrum-epic-"+this.id;this.sidePanel.unsubscribeAll("onLoadSidePanel");this.sidePanel.subscribeOnce("onLoadSidePanel",this.onLoadAddForm.bind(this));this.sidePanel.openSidePanel(this.sidePanelId,{contentCallback:function t(){return new Promise(function(t,i){t(e.buildAddForm())})},zIndex:1e3})}},{key:"openEditForm",value:function t(e){var i=this;this.id=c.Text.getRandom();this.sidePanelId="tasks-scrum-epic-"+this.id;this.sidePanel.unsubscribeAll("onLoadSidePanel");this.sidePanel.subscribeOnce("onLoadSidePanel",this.onLoadEditForm.bind(this));this.sidePanel.openSidePanel(this.sidePanelId,{contentCallback:function t(){return new Promise(function(t,s){i.getEpic(e).then(function(e){i.currentEpic=e.data;t(i.buildEditForm())})})},zIndex:1e3})}},{key:"openViewForm",value:function t(e){var i=this;this.id=c.Text.getRandom();this.sidePanelId="tasks-scrum-epic-"+this.id;this.sidePanel.unsubscribeAll("onLoadSidePanel");this.sidePanel.subscribeOnce("onLoadSidePanel",this.onLoadViewForm.bind(this));this.sidePanel.openSidePanel(this.sidePanelId,{contentCallback:function t(){return new Promise(function(t,s){i.getEpic(e).then(function(e){i.currentEpic=e.data;t(i.buildViewForm())})})},zIndex:1e3})}},{key:"openEpicsList",value:function t(){var e=this;this.id=c.Text.getRandom();this.sidePanelId="tasks-scrum-epic-"+this.id;d.EventEmitter.subscribe("Grid::beforeRequest",this.onBeforeGridRequest.bind(this));this.sidePanel.openSidePanel(this.sidePanelId,{contentCallback:function t(){e.sidePanel.unsubscribeAll("onLoadSidePanel");e.sidePanel.subscribeOnce("onLoadSidePanel",e.onLoadListGrid.bind(e));e.sidePanel.subscribeOnce("onCloseSidePanel",e.destroyGrid.bind(e));return new Promise(function(t,e){t(c.Tag.render(_e(),c.Loc.getMessage("TASKS_SCRUM_SPRINT_ADD_EPIC_LIST_TITLE"),c.Loc.getMessage("TASKS_SCRUM_BACKLOG_LIST_ACTIONS_EPIC_ADD")))})},zIndex:1e3})}},{key:"onLoadAddForm",value:function t(e){var i=this;var s=e.getData();s.showLoader();this.form=s.getContainer().querySelector(".tasks-scrum-epic-form");this.currentEpic=null;this.onLoadEditor();this.onLoadColorPicker();this.onLoadAddButtons().then(function(t){s.closeLoader();c.Event.bind(t.querySelector("[name=save]"),"click",function(){i.requestSender.createEpic(i.getRequestData()).then(function(t){i.onAfterCreateEpic(t.data);if(i.sidePanel.isPreviousSidePanelExist(s)){i.sidePanel.reloadPreviousSidePanel(s);s.close()}else{s.close(false,function(){i.openEpicsList()})}}).catch(function(t){i.requestSender.showErrorAlert(t,c.Loc.getMessage("TASKS_SCRUM_EPIC_CREATE_ERROR_TITLE_POPUP"));s.close()})});c.Event.bind(t.querySelector("[name=cancel]"),"click",function(){return s.close()})})}},{key:"onLoadViewForm",value:function t(e){var i=this;var s=e.getData();s.showLoader();this.form=s.getContainer().querySelector(".tasks-scrum-epic-form");this.onLoadDescription();this.onLoadFiles();this.onLoadViewButtons().then(function(t){s.closeLoader();c.Event.bind(t.querySelector("[name=save]"),"click",function(){s.close(false,function(){i.openEditForm(i.currentEpic.id)})});c.Event.bind(t.querySelector("[name=cancel]"),"click",function(){return s.close()})})}},{key:"onLoadEditForm",value:function t(e){var i=this;var s=e.getData();s.showLoader();this.form=s.getContainer().querySelector(".tasks-scrum-epic-form");this.onLoadEditor();this.onLoadColorPicker();this.onLoadEditButtons().then(function(t){s.closeLoader();c.Event.bind(t.querySelector("[name=save]"),"click",function(){i.requestSender.editEpic(i.getRequestData()).then(function(t){i.emit("onAfterEditEpic",t);s.close(false,function(){i.reloadGrid()})}).catch(function(t){i.removeClockIconFromButton();i.requestSender.showErrorAlert(t,c.Loc.getMessage("TASKS_SCRUM_EPIC_UPDATE_ERROR_TITLE_POPUP"))})});c.Event.bind(t.querySelector("[name=cancel]"),"click",function(){return s.close()})})}},{key:"reloadGrid",value:function t(){if(BX&&BX.Main&&BX.Main.gridManager){var e=BX.Main.gridManager.getById(this.gridId);if(e){e.instance.reload()}}}},{key:"destroyGrid",value:function t(){if(BX&&BX.Main&&BX.Main.gridManager){var e=BX.Main.gridManager.getById(this.gridId);if(e){e.instance.destroy()}}}},{key:"onLoadEditor",value:function t(){var e=this;this.getDescriptionEditor().then(function(t){var i=e.form.querySelector(".tasks-scrum-epic-form-description");c.Runtime.html(i,t).then(function(){e.editor=window.LHEPostForm.getHandler(e.id);window.BXHtmlEditor.Get(e.id);d.EventEmitter.emit(e.editor.eventNode,"OnShowLHE",[true]);setTimeout(function(){e.form.querySelector(".tasks-scrum-epic-form-header-title-control").focus()},100)})})}},{key:"onLoadDescription",value:function t(){var e=this;var i=this.form.querySelector(".tasks-scrum-epic-form-description");this.requestSender.getEpicDescription({epicId:this.currentEpic.id,text:this.currentEpic.description}).then(function(t){c.Runtime.html(i,t.data)}).catch(function(t){e.requestSender.showErrorAlert(t)})}},{key:"onLoadFiles",value:function t(){var e=this.form.querySelector(".tasks-scrum-epic-form-files");this.requestSender.getEpicFiles({epicId:this.currentEpic.id}).then(function(t){c.Runtime.html(e,t.data.html)})}},{key:"onLoadColorPicker",value:function t(){var e=this;this.selectedColor=this.currentEpic?this.currentEpic.info.color:this.defaultColor;var i=this.form.querySelector(".tasks-scrum-epic-header-color");c.Event.bind(i,"click",function(){var t=i.querySelector(".tasks-scrum-epic-header-color-current");var s=e.getColorPicker(t);s.open()})}},{key:"onLoadAddButtons",value:function t(){var e=this;return this.getAddEpicFormButtons().then(function(t){var i=e.form.querySelector(".tasks-scrum-epic-form-buttons");return c.Runtime.html(i,t).then(function(){return i})})}},{key:"onLoadViewButtons",value:function t(){var e=this;return this.getViewEpicFormButtons().then(function(t){var i=e.form.querySelector(".tasks-scrum-epic-form-buttons");return c.Runtime.html(i,t).then(function(){return i})})}},{key:"onLoadEditButtons",value:function t(){var e=this;return this.getAddEpicFormButtons().then(function(t){var i=e.form.querySelector(".tasks-scrum-epic-form-buttons");return c.Runtime.html(i,t).then(function(){return i})})}},{key:"onLoadListGrid",value:function t(e){var i=this;var s=e.getData();var n=s.getContainer().querySelector(".tasks-scrum-epics-list");var r=s.getContainer().querySelector(".tasks-scrum-epics-list-grid");s.showLoader();this.getEpicsList().then(function(t){s.closeLoader();if(t.html){c.Runtime.html(r,t.html);i.prepareTagsList(r);var e=n.querySelector(".tasks-scrum-epic-header-add-button");c.Event.bind(e,"click",function(){i.openAddForm()})}else{c.Dom.remove(n.querySelector(".tasks-scrum-epic-header-add-button"));c.Dom.append(i.getEmptyEpicListForm(),r);var a=r.querySelector(".tasks-scrum-epics-empty-button");c.Event.bind(a,"click",function(){i.openAddForm()})}})}},{key:"onBeforeGridRequest",value:function t(e){var i=e.getCompatData(),s=babelHelpers.slicedToArray(i,2),n=s[1];n.sessid=BX.bitrix_sessid();n.method="POST";if(!n.url){n.url=this.requestSender.getEpicListUrl()}n.data=babelHelpers.objectSpread({},n.data,{entityId:this.entity.getId(),gridId:this.gridId,signedParameters:this.requestSender.getSignedParameters()})}},{key:"getEpicsList",value:function t(){var e=this;this.gridId="EntityEpicsGrid_"+this.entity.getId();return new Promise(function(t,i){e.requestSender.getEpicsList({entityId:e.entity.getId(),gridId:e.gridId}).then(function(e){t(e.data)}).catch(function(t){e.requestSender.showErrorAlert(t)})})}},{key:"getEpic",value:function t(e){return this.requestSender.getEpic({id:e})}},{key:"buildAddForm",value:function t(){return c.Tag.render(Be(),this.buildFormHeader(c.Loc.getMessage("TASKS_SCRUM_SPRINT_ADD_EPIC_FORM_TITLE")),this.buildFormContainerHeader("","#69dafc"))}},{key:"buildViewForm",value:function t(){return c.Tag.render(Me(),this.buildFormHeader(c.Loc.getMessage("TASKS_SCRUM_SPRINT_VIEW_EPIC_FORM_TITLE")),c.Text.encode(this.currentEpic.name),c.Text.encode(this.currentEpic.info.color))}},{key:"buildEditForm",value:function t(){return c.Tag.render(Le(),this.buildFormHeader(c.Loc.getMessage("TASKS_SCRUM_SPRINT_EDIT_EPIC_FORM_TITLE")),this.buildFormContainerHeader(this.currentEpic.name,this.currentEpic.info.color))}},{key:"getEmptyEpicListForm",value:function t(){return c.Tag.render(Ne(),c.Loc.getMessage("TASKS_SCRUM_EPICS_EMPTY_FIRST_TITLE"),c.Loc.getMessage("TASKS_SCRUM_EPICS_EMPTY_SECOND_TITLE"),c.Loc.getMessage("TASKS_SCRUM_BACKLOG_LIST_ACTIONS_EPIC_ADD"))}},{key:"buildFormHeader",value:function t(e){return c.Tag.render(we(),e)}},{key:"buildFormContainerHeader",value:function t(e,i){return c.Tag.render(De(),c.Text.encode(e),c.Loc.getMessage("TASKS_SCRUM_SPRINT_ADD_EPIC_NAME_PLACEHOLDER"),c.Text.encode(i))}},{key:"getDescriptionEditor",value:function t(){var e=this;var i={editorId:this.id};if(this.currentEpic){i.epicId=this.currentEpic.id;i.text=this.currentEpic.description}return new Promise(function(t,s){e.requestSender.getEpicDescriptionEditor(i).then(function(e){t(e.data.html)})})}},{key:"getAddEpicFormButtons",value:function t(){var e=this;return new Promise(function(t,i){e.requestSender.getAddEpicFormButtons().then(function(e){t(e.data.html)})})}},{key:"getViewEpicFormButtons",value:function t(){var e=this;return new Promise(function(t,i){e.requestSender.getViewEpicFormButtonsAction().then(function(e){t(e.data.html)})})}},{key:"getColorPicker",value:function t(e){var i=this;return new BX.ColorPicker({bindElement:e,defaultColor:this.selectedColor,onColorSelected:function t(s,n){i.selectedColor=s;e.style.backgroundColor=s},popupOptions:{zIndex:1100,className:"tasks-scrum-epic-color-popup"},colors:[["#aae9fc","#bbecf1","#98e1dc","#e3f299","#ffee95","#ffdd93","#dfd3b6","#e3c6bb"],["#ffad97","#ffbdbb","#ffcbd8","#ffc4e4","#c4baed","#dbdde0","#bfc5cd","#a2a8b0"]]})}},{key:"getRequestData",value:function t(){var e={};if(this.currentEpic){e.epicId=this.currentEpic.id}e.entityId=this.entity.getId();e.name=this.form.querySelector("[name=name]").value.trim();e.description=this.editor.oEditor.GetContent();e.color=this.selectedColor;e.files=this.getAttachmentsFiles();return e}},{key:"getAttachmentsFiles",value:function t(){var e=this;var i=[];if(!this.editor||!c.Type.isPlainObject(this.editor.arFiles)||!c.Type.isPlainObject(this.editor.controllers)){return i}var s=[];Object.values(this.editor.arFiles).forEach(function(t){if(!s.includes(t)){s.push(t)}});s.forEach(function(t){if(e.editor.controllers[t]&&c.Type.isPlainObject(e.editor.controllers[t].values)){Object.keys(e.editor.controllers[t].values).forEach(function(t){if(!i.includes(t)){i.push(t)}})}});return i}},{key:"prepareTagsList",value:function t(e){var i=this;var s=e.querySelectorAll(".tasks-scrum-epic-grid-tags");s.forEach(function(t){var e=i.getTagsFromNode(t);c.Dom.clean(t);e.forEach(function(e){c.Dom.append(i.getTagNode(e),t)})})}},{key:"getTagsFromNode",value:function t(e){var i=[];e.childNodes.forEach(function(t){i.push(t.textContent.trim())});return i}},{key:"getTagNode",value:function t(e){var i=this;var s=new o.Label({text:e,color:o.Label.Color.TAG_LIGHT,fill:true,size:o.Label.Size.SM,customClass:""});var n=s.getContainer();c.Event.bind(n,"click",function(){i.emit("filterByTag",e);i.sidePanel.closeTopSidePanel(true)});return n}},{key:"removeClockIconFromButton",value:function t(){var e=this.form.querySelector(".tasks-scrum-epic-form-buttons");if(e){c.Dom.removeClass(e.querySelector("[name=save]"),"ui-btn-wait")}}},{key:"onAfterCreateEpic",value:function t(e){this.tagSearcher.addEpicToSearcher(e);this.filter.addItemToListTypeField("EPIC",{NAME:e.name.trim(),VALUE:String(e.id)})}},{key:"onAfterUpdateEpic",value:function t(e){this.entityStorage.getAllItems().forEach(function(t){var i=t.getEpic();if(i&&i.id===e.id){t.setEpicAndTags(e)}});var i=this.getCurrentEpic();if(i){this.tagSearcher.removeEpicFromSearcher(i)}this.tagSearcher.addEpicToSearcher(e)}},{key:"onAfterRemoveEpic",value:function t(e){this.entityStorage.getAllItems().forEach(function(t){var i=t.getEpic();if(i&&i.id===e.id){t.setEpicAndTags(null)}});this.tagSearcher.removeEpicFromSearcher(e);this.sidePanel.reloadTopSidePanel(true)}}]);return e}(d.EventEmitter);var Re=function(){function t(e){babelHelpers.classCallCheck(this,t);this.requestSender=e.requestSender;this.domBuilder=e.domBuilder;this.entityStorage=e.entityStorage;this.groupId=e.groupId;this.listIdsToSkipAdding=new Set;this.listIdsToSkipUpdating=new Set;this.listIdsToSkipRemoving=new Set}babelHelpers.createClass(t,[{key:"getModuleId",value:function t(){return"tasks"}},{key:"getMap",value:function t(){return{sprintAdded:this.onSprintAdded.bind(this),sprintUpdated:this.onSprintUpdated.bind(this),sprintRemoved:this.onSprintRemoved.bind(this)}}},{key:"onSprintAdded",value:function t(e){if(this.groupId!==e.groupId){return}var i=Mt.buildSprint(e);if(this.needSkipAdd(i)){this.cleanSkipAdd(i);return}this.domBuilder.createSprintNode(i)}},{key:"onSprintUpdated",value:function t(e){var i=Mt.buildSprint(e);if(this.needSkipUpdate(i)){this.cleanSkipUpdate(i);return}var s=this.entityStorage.findEntityByEntityId(i.getId());if(s){if(i.getStatus()!==s.getStatus()){if(i.getStatus()==="active"){this.domBuilder.moveSprintToActiveListNode(s)}else{this.domBuilder.moveSprintToCompletedListNode(s)}}s.updateYourself(i)}}},{key:"onSprintRemoved",value:function t(e){if(this.needSkipRemove(e.sprintId)){this.cleanSkipRemove(e.sprintId);return}var i=this.entityStorage.findEntityByEntityId(e.sprintId);if(i){i.removeSprint();this.entityStorage.removeSprint(i.getId())}}},{key:"addTmpIdToSkipAdding",value:function t(e){this.listIdsToSkipAdding.add(e)}},{key:"addIdToSkipUpdating",value:function t(e){this.listIdsToSkipUpdating.add(e)}},{key:"addIdToSkipRemoving",value:function t(e){this.listIdsToSkipRemoving.add(e)}},{key:"needSkipAdd",value:function t(e){return this.listIdsToSkipAdding.has(e.getTmpId())}},{key:"cleanSkipAdd",value:function t(e){this.listIdsToSkipAdding.delete(e.getTmpId())}},{key:"needSkipUpdate",value:function t(e){return this.listIdsToSkipUpdating.has(e.getId())}},{key:"cleanSkipUpdate",value:function t(e){this.listIdsToSkipUpdating.delete(e.getId())}},{key:"needSkipRemove",value:function t(e){return this.listIdsToSkipRemoving.has(e)}},{key:"cleanSkipRemove",value:function t(e){this.listIdsToSkipRemoving.delete(e)}}]);return t}();var qe=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.ItemMover");i.requestSender=t.requestSender;i.domBuilder=t.domBuilder;i.entityStorage=t.entityStorage;i.entityCounters=t.entityCounters;i.subTasksCreator=t.subTasksCreator;i.bindHandlers();return i}babelHelpers.createClass(e,[{key:"bindHandlers",value:function t(){var e=this;this.domBuilder.subscribe("itemMoveStart",function(t){var i=t.getData();var s=i.source;var n=s.dataset.itemId;var r=e.entityStorage.findItemByItemId(n);var a=i.sourceContainer;var o=parseInt(a.dataset.entityId,10);var u=e.entityStorage.findEntityByEntityId(o);e.hideSubTasks(u,r);var l=r.getCurrentActionsPanel();if(l){l.destroy()}});this.domBuilder.subscribe("itemMoveEnd",function(t){var i=t.getData();var s=i.endContainer;if(!s){return}var n=i.sourceContainer;var r=parseInt(n.dataset.entityId,10);var a=parseInt(s.dataset.entityId,10);var o=e.entityStorage.findEntityByEntityId(r);if(r===a){e.onItemMove(i)}else{var u=c.Loc.getMessage("TASKS_SCRUM_CONFIRM_TEXT_MOVE_TASK_FROM_ACTIVE");e.onMoveConfirm(o,u).then(function(){e.onItemMove(i)}).catch(function(){var t=i.source;var s=t.dataset.itemId;var n=e.entityStorage.findItemByItemId(s);var r=o.getListItemsNode().children[n.getSort()];e.domBuilder.insertBefore(t,r)})}})}},{key:"moveItem",value:function t(e,i){var s=this;var n=this.entityStorage.findEntityByItemId(e.getItemId());var r=[];if(!n.isFirstItem(e)){r.push({text:c.Loc.getMessage("TASKS_SCRUM_ITEM_ACTIONS_MOVE_UP"),onclick:function t(i,r){if(n.isGroupMode()){var a=n.getGroupModeItems();var o=babelHelpers.toConsumableArray(a.values()).sort(function(t,e){if(t.getSort()<e.getSort())return 1;if(t.getSort()>e.getSort())return-1});var u=new Set;o.forEach(function(t){u.add(t.getItemId());s.hideSubTasks(n,t);s.moveItemToUp(t,n.getListItemsNode(),n.hasInput(),false)});s.requestSender.updateItemSort({sortInfo:s.calculateSort(n.getListItemsNode(),u)}).catch(function(t){s.requestSender.showErrorAlert(t)});n.deactivateGroupMode()}else{s.hideSubTasks(n,e);s.moveItemToUp(e,n.getListItemsNode(),n.hasInput())}r.getMenuWindow().close()}})}if(!n.isLastItem(e)){r.push({text:c.Loc.getMessage("TASKS_SCRUM_ITEM_ACTIONS_MOVE_DOWN"),onclick:function t(i,r){if(n.isGroupMode()){var a=n.getGroupModeItems();var o=babelHelpers.toConsumableArray(a.values()).sort(function(t,e){if(t.getSort()>e.getSort())return 1;if(t.getSort()<e.getSort())return-1});var u=new Set;o.forEach(function(t){u.add(t.getItemId());s.hideSubTasks(n,t);s.moveItemToDown(t,n.getListItemsNode(),false)});s.requestSender.updateItemSort({sortInfo:s.calculateSort(n.getListItemsNode(),u)}).catch(function(t){s.requestSender.showErrorAlert(t)});n.deactivateGroupMode()}else{s.hideSubTasks(n,e);s.moveItemToDown(e,n.getListItemsNode())}r.getMenuWindow().close()}})}this.showMoveItemMenu(e,i,r)}},{key:"moveItemToUp",value:function t(e,i){var s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;var n=arguments.length>3&&arguments[3]!==undefined?arguments[3]:true;if(s){this.domBuilder.appendItemAfterItem(e.getItemNode(),i.firstElementChild)}else{this.domBuilder.insertBefore(e.getItemNode(),i.firstElementChild)}if(n){this.updateItemsSort(e,i)}}},{key:"moveItemToDown",value:function t(e,i){var s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;this.domBuilder.append(e.getItemNode(),i);if(s){this.updateItemsSort(e,i)}}},{key:"updateItemsSort",value:function t(e,i){var s=this;this.requestSender.updateItem({itemId:e.getItemId(),sortInfo:babelHelpers.objectSpread({},this.calculateSort(i,new Set([e.getItemId()])))}).catch(function(t){s.requestSender.showErrorAlert(t)})}},{key:"onItemMove",value:function t(e){var i=this;if(!e.endContainer){return}var s=e.sourceContainer;var n=e.endContainer;if(n===this.domBuilder.getSprintCreatingDropZoneNode()){var r=function t(){i.domBuilder.createSprint().then(function(t){var s=e.source;var n=s.dataset.itemId;var r=i.entityStorage.findItemByItemId(n);i.moveTo(i.entityStorage.getBacklog(),t,r)})};r();return}var a=parseInt(s.dataset.entityId,10);var o=parseInt(n.dataset.entityId,10);if(a===o){var u=function t(){var n=e.source;var r=parseInt(n.dataset.itemId,10);i.requestSender.updateItemSort({sortInfo:i.calculateSort(s,new Set([r]))}).catch(function(t){i.requestSender.showErrorAlert(t)})};u()}else{var l=function t(){var s=e.source;var r=s.dataset.itemId;var u=i.entityStorage.findItemByItemId(r);var l=i.entityStorage.findEntityByEntityId(a);var c=i.entityStorage.findEntityByEntityId(o);i.moveItemFromEntityToEntity(u,l,c);i.requestSender.updateItemSort({entityId:c.getId(),itemId:u.getItemId(),itemType:u.getItemType(),sourceEntityId:l.getId(),fromActiveSprint:l.getEntityType()==="sprint"&&l.isActive()?"Y":"N",toActiveSprint:c.getEntityType()==="sprint"&&c.isActive()?"Y":"N",sortInfo:i.calculateSort(n,new Set([u.getItemId()]),true)}).then(function(){i.updateEntityCounters(l,c)}).catch(function(t){i.requestSender.showErrorAlert(t)})};l()}}},{key:"updateEntityCounters",value:function t(e,i){var s=new Map;s.set(e.getId(),e);if(i){s.set(i.getId(),i)}this.entityCounters.updateCounters(s)}},{key:"calculateSort",value:function t(e,i){var s=this;var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var r={};var a=babelHelpers.toConsumableArray(e.querySelectorAll("[data-sort]"));var o=1;a.forEach(function(t){var a=parseInt(t.dataset.itemId,10);var u=s.entityStorage.findItemByItemId(a);if(u&&!u.isSubTask()){var l=c.Text.getRandom();var d=o!==u.getSort();u.setSort(o);r[a]={sort:o};if(n){r[a].entityId=e.dataset.entityId;d=true}if(d&&i&&i.has(a)){r[a].tmpId=l;r[a].updatedItemId=a}t.dataset.sort=o}o++});this.emit("calculateSort",r);return r}},{key:"moveToAnotherEntity",value:function t(e,i,s,n){var r=this;var a=c.Type.isNull(s);var o=a?this.entityStorage.getSprintsAvailableForFilling(e):null;if(e.isGroupMode()){if(a){if(o.size>1){this.showListSprintsToMove(e,i,n)}else{if(o.size===0){this.domBuilder.createSprint().then(function(t){r.moveToWithGroupMode(e,t,i,true,false)})}else{o.forEach(function(t){r.moveToWithGroupMode(e,t,i,true,false)})}}}else{var u=c.Loc.getMessage("TASKS_SCRUM_CONFIRM_TEXT_MOVE_TASKS_FROM_ACTIVE");this.onMoveConfirm(e,u).then(function(){r.moveToWithGroupMode(e,s,i,false,false)}).catch(function(){})}}else{if(a){if(o.size>1){this.showListSprintsToMove(e,i,n)}else{var l=c.Loc.getMessage("TASKS_SCRUM_CONFIRM_TEXT_MOVE_TASK_FROM_ACTIVE");this.onMoveConfirm(e,l).then(function(){if(o.size===0){r.domBuilder.createSprint().then(function(t){r.moveTo(e,t,i)})}else{o.forEach(function(t){r.moveTo(e,t,i)})}}).catch(function(){})}}else{var d=c.Loc.getMessage("TASKS_SCRUM_CONFIRM_TEXT_MOVE_TASK_FROM_ACTIVE");this.onMoveConfirm(e,d).then(function(){r.moveTo(e,s,i,false)}).catch(function(){})}}}},{key:"moveToWithGroupMode",value:function t(e,i,s){var n=this;var r=arguments.length>3&&arguments[3]!==undefined?arguments[3]:true;var a=arguments.length>4&&arguments[4]!==undefined?arguments[4]:true;var o=e.getGroupModeItems();var u=babelHelpers.toConsumableArray(o.values()).sort(function(t,e){if(r){if(t.getSort()>e.getSort())return 1;if(t.getSort()<e.getSort())return-1}else{if(t.getSort()<e.getSort())return 1;if(t.getSort()>e.getSort())return-1}});var l=new Set;var c=[];u.forEach(function(t){n.moveTo(e,i,t,r,a);l.add(t.getItemId());c.push({itemId:t.getItemId(),itemType:t.getItemType(),entityId:i.getId(),sourceEntityId:e.getId(),fromActiveSprint:e.getEntityType()==="sprint"&&e.isActive()?"Y":"N",toActiveSprint:i.getEntityType()==="sprint"&&i.isActive()?"Y":"N"})});this.requestSender.batchUpdateItem({items:c,sortInfo:babelHelpers.objectSpread({},this.calculateSort(i.getListItemsNode(),l,true),this.calculateSort(e.getListItemsNode(),new Set,true))}).then(function(){n.updateEntityCounters(e,i)}).catch(function(t){n.requestSender.showErrorAlert(t)});e.deactivateGroupMode()}},{key:"hideSubTasks",value:function t(e,i){if(i&&i.isParentTask()){if(this.subTasksCreator.isShown(i)){this.subTasksCreator.toggleSubTasks(e,i)}}}},{key:"moveTo",value:function t(e,i,s){var n=arguments.length>3&&arguments[3]!==undefined?arguments[3]:true;var r=arguments.length>4&&arguments[4]!==undefined?arguments[4]:true;this.hideSubTasks(e,s);var a=s.getItemNode();var o=i.getListItemsNode();if(n){this.domBuilder.append(a,o)}else{this.domBuilder.appendItemAfterItem(a,o.firstElementChild)}this.moveItemFromEntityToEntity(s,e,i);if(r){this.onMoveItemUpdate(e,i,s)}}},{key:"moveToPosition",value:function t(e,i,s){this.hideSubTasks(e,s);var n=s.getItemNode();var r=i.getListItemsNode();var a=r.children[s.getSort()];if(c.Type.isUndefined(a)){this.domBuilder.append(n,r)}else{var o=parseInt(a.dataset.sort,10);var u=e.getId()!==i.getId();if(o>=s.getPreviousSort()){if(u){this.domBuilder.insertBefore(n,a)}else{this.domBuilder.appendItemAfterItem(n,a)}}else{this.domBuilder.insertBefore(n,a)}}this.moveItemFromEntityToEntity(s,e,i);this.updateEntityCounters(e,i)}},{key:"onMoveItemUpdate",value:function t(e,i,s){var n=this;this.requestSender.updateItem({itemId:s.getItemId(),itemType:s.getItemType(),entityId:i.getId(),sourceEntityId:e.getId(),fromActiveSprint:e.getEntityType()==="sprint"&&e.isActive()?"Y":"N",toActiveSprint:i.getEntityType()==="sprint"&&i.isActive()?"Y":"N",sortInfo:babelHelpers.objectSpread({},this.calculateSort(i.getListItemsNode(),new Set([s.getItemId()]),true),this.calculateSort(e.getListItemsNode(),new Set,true))}).then(function(){n.updateEntityCounters(e,i)}).catch(function(t){n.requestSender.showErrorAlert(t)})}},{key:"moveItemFromEntityToEntity",value:function t(e,i,s){i.removeItem(e);e.setParentEntity(s.getId(),s.getEntityType());e.setDisableStatus(false);s.setItem(e)}},{key:"showListSprintsToMove",value:function t(e,i,s){var n=this;var r="item-sprint-action-".concat(e.getEntityType()+e.getId()+i.itemId);if(this.moveToSprintMenu){if(this.moveToSprintMenu.getPopupWindow().getId()===r){this.moveToSprintMenu.getPopupWindow().setBindElement(s);this.moveToSprintMenu.show();return}this.moveToSprintMenu.getPopupWindow().destroy()}this.moveToSprintMenu=new l.Menu({id:r,bindElement:s});this.entityStorage.getSprints().forEach(function(t){if(!t.isCompleted()&&!n.isSameSprint(e,t)){n.moveToSprintMenu.addMenuItem({text:t.getName(),onclick:function s(r,a){var o=c.Loc.getMessage("TASKS_SCRUM_CONFIRM_TEXT_MOVE_TASK_FROM_ACTIVE");if(e.isGroupMode()){o=c.Loc.getMessage("TASKS_SCRUM_CONFIRM_TEXT_MOVE_TASKS_FROM_ACTIVE")}n.onMoveConfirm(e,o).then(function(){if(e.isGroupMode()){n.moveToWithGroupMode(e,t,i,true,false)}else{n.moveTo(e,t,i)}}).catch(function(){});a.getMenuWindow().close()}})}});this.moveToSprintMenu.show()}},{key:"isSameSprint",value:function t(e,i){return e.getEntityType()==="sprint"&&e.getId()===i.getId()}},{key:"onMoveConfirm",value:function t(e,i){return new Promise(function(t,s){if(e.isActive()){u.MessageBox.confirm(i,function(e){e.close();t()},c.Loc.getMessage("TASKS_SCRUM_BUTTON_TEXT_MOVE"),function(t){t.close();s()})}else{t()}})}},{key:"showMoveItemMenu",value:function t(e,i,s){var n=this;var r="item-move-".concat(e.itemId);if(this.moveItemMenu){this.moveItemMenu.getPopupWindow().destroy()}this.moveItemMenu=new l.Menu({id:r,bindElement:i});s.forEach(function(t){n.moveItemMenu.addMenuItem(t)});this.moveItemMenu.show()}}]);return e}(d.EventEmitter);var Fe=function(){function t(e){babelHelpers.classCallCheck(this,t);this.requestSender=e.requestSender;this.domBuilder=e.domBuilder;this.entityStorage=e.entityStorage;this.entityCounters=e.entityCounters;this.tagSearcher=e.tagSearcher;this.itemMover=e.itemMover;this.subTasksCreator=e.subTasksCreator;this.currentUserId=e.currentUserId;this.listToAddAfterUpdate=new Map;this.listIdsToSkipAdding=new Set;this.listIdsToSkipUpdating=new Set;this.listIdsToSkipRemoving=new Set;this.listIdsToSkipSorting=new Set;this.itemMover.subscribe("calculateSort",this.onCalculateSort.bind(this))}babelHelpers.createClass(t,[{key:"getModuleId",value:function t(){return"tasks"}},{key:"getMap",value:function t(){return{itemAdded:this.onItemAdded.bind(this),itemUpdated:this.onItemUpdated.bind(this),itemRemoved:this.onItemRemoved.bind(this),itemSortUpdated:this.onItemSortUpdated.bind(this),comment_add:this.onCommentAdd.bind(this)}}},{key:"onItemAdded",value:function t(e){var i=this;var s=new O(e);s.cleanTaskCounts();this.setDelayedAdd(s);this.externalAdd(s).finally(function(){return i.cleanDelayedAdd(s)}).then(function(){return i.addItemToEntity(s)}).catch(function(){})}},{key:"onItemUpdated",value:function t(e){var i=new O(e);i.cleanTaskCounts();if(this.isDelayedAdd(i)){this.cleanDelayedAdd(i);if(this.needSkipAdd(i)){this.cleanSkipAdd(i);return}this.addItemToEntity(i);return}if(this.needSkipUpdate(i)){this.cleanSkipUpdate(i);return}this.updateItem(i)}},{key:"onItemRemoved",value:function t(e){if(this.needSkipRemove(e.itemId)){this.cleanSkipRemove(e.itemId);return}var i=this.entityStorage.findItemByItemId(e.itemId);if(i){var s=this.entityStorage.findEntityByItemId(i.getItemId());s.removeItem(i);i.removeYourself()}}},{key:"onItemSortUpdated",value:function t(e){var i=this;var s=new Map;var n=new Map;Object.entries(e).forEach(function(t){var e=babelHelpers.slicedToArray(t,2),r=e[0],a=e[1];var o=i.entityStorage.findItemByItemId(r);if(o){if(!i.needSkipSort(a.tmpId)){s.set(o.getItemId(),o);n.set(o.getItemId(),a)}i.cleanSkipRemove(a.tmpId)}});s.forEach(function(t){var e=n.get(t.getItemId());t.setSort(e.sort);var s=i.entityStorage.findEntityByEntityId(t.getEntityId());if(s){var r=c.Type.isUndefined(e.entityId)?t.getEntityId():e.entityId;var a=i.entityStorage.findEntityByEntityId(r);if(!a||s.getId()===a.getId()){a=s}i.itemMover.moveToPosition(s,a,t);i.entityStorage.recalculateItemsSort()}})}},{key:"onCommentAdd",value:function t(e){var i=this;var s=c.Type.isArray(e.participants)?e.participants:[];if(s.includes(this.currentUserId.toString())){var n=e.entityXmlId.split("_");if(n){var r=n[0];var a=n[1];var o=this.entityStorage.findItemBySourceId(a);if(r==="TASK"&&o){this.requestSender.getCurrentState({taskId:o.getSourceId()}).then(function(t){var e=new O(t.data.itemData);i.updateItem(e,o)}).catch(function(t){i.requestSender.showErrorAlert(t)})}}}}},{key:"addItemToEntity",value:function t(e){var i=this;if(e.isSubTask()){this.updateParentItem(e);return}this.requestSender.hasTaskInFilter({taskId:e.getSourceId()}).then(function(t){if(!t.data.has){return}var s=i.entityStorage.findEntityByEntityId(e.getEntityId());if(!s){return}var n=s.getListItemsNode().children[e.getSort()];if(n){i.domBuilder.insertBefore(e.render(),n)}else{i.domBuilder.append(e.render(),s.getListItemsNode())}s.setItem(e);i.updateEntityCounters(s);e.getTags().forEach(function(t){i.tagSearcher.addTagToSearcher(t)})}).catch(function(t){i.requestSender.showErrorAlert(t)})}},{key:"updateItem",value:function t(e,i){if(!i){i=this.entityStorage.findItemByItemId(e.getItemId())}if(i){if(i.isParentTask()){if(this.subTasksCreator.isShown(i)){var s=this.entityStorage.findEntityByEntityId(i.getEntityId());this.subTasksCreator.hideSubTaskItems(s,i)}this.subTasksCreator.cleanSubTasks(i)}var n=e.isSubTask()!==i.isSubTask();if(n){if(e.isSubTask()){var r=this.entityStorage.findEntityByItemId(i.getItemId());r.removeItem(i);i.removeYourself()}return}var a=e.getEntityId();var o=i.getEntityId();var u=this.entityStorage.findEntityByEntityId(a);var l=this.entityStorage.findEntityByEntityId(o);if(e.getEntityId()!==i.getEntityId()){if(u&&l){this.itemMover.moveToPosition(l,u,i);this.entityStorage.recalculateItemsSort()}}else{this.updateEntityCounters(u)}i.updateYourself(e)}else{if(e.isSubTask()){this.updateParentItem(e);var c=e.getEntityId();var d=this.entityStorage.findEntityByEntityId(c);this.updateEntityCounters(d)}else{this.addItemToEntity(e)}}}},{key:"updateParentItem",value:function t(e){var i=this.entityStorage.findItemBySourceId(e.getParentTaskId());if(i){i.updateSubTasksPoints(e.getSourceId(),e.getStoryPoints())}}},{key:"updateEntityCounters",value:function t(e,i){var s=new Map;s.set(e.getId(),e);if(i){s.set(i.getId(),i)}this.entityCounters.updateCounters(s)}},{key:"onCalculateSort",value:function t(e){var i=this;var s=e.getData();Object.entries(s).forEach(function(t){var e=babelHelpers.slicedToArray(t,2),s=e[0],n=e[1];if(Object.prototype.hasOwnProperty.call(n,"tmpId")){i.addTmpIdToSkipSorting(n.tmpId)}})}},{key:"addTmpIdsToSkipAdding",value:function t(e){this.listIdsToSkipAdding.add(e)}},{key:"addIdToSkipUpdating",value:function t(e){this.listIdsToSkipUpdating.add(e)}},{key:"addIdToSkipRemoving",value:function t(e){this.listIdsToSkipRemoving.add(e)}},{key:"addTmpIdToSkipSorting",value:function t(e){this.listIdsToSkipSorting.add(e)}},{key:"externalAdd",value:function t(e){var i=this;return new Promise(function(t,s){setTimeout(function(){return i.isDelayedAdd(e)?t():s()},3e3)})}},{key:"isDelayedAdd",value:function t(e){return this.listToAddAfterUpdate.has(e.getItemId())}},{key:"setDelayedAdd",value:function t(e){this.listToAddAfterUpdate.set(e.getItemId(),e)}},{key:"cleanDelayedAdd",value:function t(e){this.listToAddAfterUpdate.delete(e.getItemId())}},{key:"needSkipAdd",value:function t(e){return this.listIdsToSkipAdding.has(e.getTmpId())}},{key:"cleanSkipAdd",value:function t(e){this.listIdsToSkipAdding.delete(e.getTmpId())}},{key:"needSkipUpdate",value:function t(e){return this.listIdsToSkipUpdating.has(e.getItemId())}},{key:"cleanSkipUpdate",value:function t(e){this.listIdsToSkipUpdating.delete(e.getItemId())}},{key:"needSkipRemove",value:function t(e){return this.listIdsToSkipRemoving.has(e)}},{key:"cleanSkipRemove",value:function t(e){this.listIdsToSkipRemoving.delete(e)}},{key:"needSkipSort",value:function t(e){return this.listIdsToSkipSorting.has(e)}},{key:"cleanSkipSort",value:function t(e){this.listIdsToSkipSorting.delete(e)}}]);return t}();var Oe=function(){function t(e){babelHelpers.classCallCheck(this,t);this.requestSender=e.requestSender;this.domBuilder=e.domBuilder;this.entityStorage=e.entityStorage;this.epic=e.epic;this.listIdsToSkipAdding=new Set;this.listIdsToSkipUpdating=new Set;this.listIdsToSkipRemoving=new Set}babelHelpers.createClass(t,[{key:"getModuleId",value:function t(){return"tasks"}},{key:"getMap",value:function t(){return{epicAdded:this.onEpicAdded.bind(this),epicUpdated:this.onEpicUpdated.bind(this),epicRemoved:this.onEpicRemoved.bind(this)}}},{key:"onEpicAdded",value:function t(e){this.epic.onAfterCreateEpic(e)}},{key:"onEpicUpdated",value:function t(e){this.epic.onAfterUpdateEpic(e)}},{key:"onEpicRemoved",value:function t(e){this.epic.onAfterRemoveEpic(e)}}]);return t}();var Ue=function(){function t(e){babelHelpers.classCallCheck(this,t);this.requestSender=e.requestSender;this.domBuilder=e.domBuilder;this.entityStorage=e.entityStorage;this.bindHandlers()}babelHelpers.createClass(t,[{key:"bindHandlers",value:function t(){this.domBuilder.subscribe("sprintMove",this.onSprintMove.bind(this))}},{key:"onSprintMove",value:function t(e){var i=this;var s=e.getData();if(!s.endContainer){return}this.requestSender.updateSprintSort({sortInfo:this.calculateSprintSort()}).catch(function(t){i.requestSender.showErrorAlert(t)})}},{key:"calculateSprintSort",value:function t(){var e=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var s={};var n=this.domBuilder.getSprintPlannedListNode();var r=babelHelpers.toConsumableArray(n.querySelectorAll("[data-sprint-sort]"));var a=1+i;r.forEach(function(t){var i=t.dataset.sprintId;var n=e.entityStorage.findEntityByEntityId(i);if(n){n.setSort(a);s[i]={sort:a};t.dataset.sprintSort=a;a++}});return s}}]);return t}();var xe=function(t){babelHelpers.inherits(e,t);function e(t){var s;babelHelpers.classCallCheck(this,e);s=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));s.setEventNamespace("BX.Tasks.Scrum.Plan");s.pathToTask=t.pathToTask;s.defaultResponsible=t.defaultResponsible;s.activeSprintId=parseInt(t.activeSprintId,10);s.views=t.views;s.entityStorage=new Bt;s.entityStorage.addBacklog(et.buildBacklog(t.backlog));t.sprints.forEach(function(e){e.defaultSprintDuration=t.defaultSprintDuration;var i=Mt.buildSprint(e);s.entityStorage.addSprint(i)});s.entityCounters=new Pe({requestSender:s.requestSender,entityStorage:s.entityStorage});s.counters=new Ht({requestSender:s.requestSender,entityStorage:s.entityStorage,filter:s.filter,userId:t.userId,groupId:t.groupId,isOwnerCurrentUser:t.isOwnerCurrentUser});s.tagSearcher=new Y;Object.values(t.tags.epic).forEach(function(t){s.tagSearcher.addEpicToSearcher(t)});Object.values(t.tags.task).forEach(function(t){s.tagSearcher.addTagToSearcher(t)});s.domBuilder=new se({requestSender:s.requestSender,entityStorage:s.entityStorage,defaultSprintDuration:t.defaultSprintDuration,pageNumberToCompletedSprints:t.pageNumberToCompletedSprints});s.domBuilder.subscribe("beforeCreateSprint",function(t){var e=t.getData();s.pullSprint.addTmpIdToSkipAdding(e.tmpId)});s.domBuilder.subscribe("createSprint",function(t){return s.subscribeToSprint(t.getData())});s.domBuilder.subscribe("createSprintNode",function(t){return s.subscribeToSprint(t.getData())});s.sprintMover=new Ue({requestSender:s.requestSender,domBuilder:s.domBuilder,entityStorage:s.entityStorage});s.subTasksCreator=new ne({requestSender:s.requestSender,domBuilder:s.domBuilder});s.filterHandler=new Ae({filter:s.filter,requestSender:s.requestSender,entityStorage:s.entityStorage,subTasksCreator:s.subTasksCreator});s.itemMover=new qe({requestSender:s.requestSender,domBuilder:s.domBuilder,entityStorage:s.entityStorage,entityCounters:s.entityCounters,subTasksCreator:s.subTasksCreator});s.itemStyleDesigner=new Jt({requestSender:s.requestSender,entityStorage:s.entityStorage});s.epic=new He({entity:s.entityStorage.getBacklog(),requestSender:s.requestSender,entityStorage:s.entityStorage,sidePanel:s.sidePanel,filter:s.filter,tagSearcher:s.tagSearcher});s.pullSprint=new Re({requestSender:s.requestSender,domBuilder:s.domBuilder,entityStorage:s.entityStorage,groupId:s.getCurrentGroupId()});s.pullItem=new Fe({requestSender:s.requestSender,domBuilder:s.domBuilder,entityStorage:s.entityStorage,entityCounters:s.entityCounters,tagSearcher:s.tagSearcher,itemMover:s.itemMover,subTasksCreator:s.subTasksCreator,counters:s.counters,currentUserId:s.getCurrentUserId()});s.pullEpic=new Oe({requestSender:s.requestSender,domBuilder:s.domBuilder,entityStorage:s.entityStorage,epic:s.epic});s.itemDod=new i.ScrumDod({groupId:s.groupId});s.bindHandlers();s.subscribeToPull();return s}babelHelpers.createClass(e,[{key:"renderTo",value:function t(i){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"renderTo",this).call(this,i);this.domBuilder.renderTo(i)}},{key:"renderButtonsTo",value:function t(i){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"renderButtonsTo",this).call(this,i);var s=new xt;s.subscribe("click",this.onShowTeamSpeedChart.bind(this));c.Dom.append(s.render(),i)}},{key:"subscribeToPull",value:function t(){a.PULL.subscribe(this.pullSprint);a.PULL.subscribe(this.pullItem);a.PULL.subscribe(this.pullEpic)}},{key:"bindHandlers",value:function t(){var e=this;this.entityStorage.getBacklog().subscribe("createTaskItem",this.onCreateTaskItem.bind(this));this.entityStorage.getBacklog().subscribe("updateItem",this.onUpdateItem.bind(this));this.entityStorage.getBacklog().subscribe("showTask",this.onShowTask.bind(this));this.entityStorage.getBacklog().subscribe("moveItem",this.onMoveItem.bind(this));this.entityStorage.getBacklog().subscribe("moveToSprint",this.onMoveToSprint.bind(this));this.entityStorage.getBacklog().subscribe("removeItem",this.onRemoveItem.bind(this));this.entityStorage.getBacklog().subscribe("changeTaskResponsible",this.onChangeTaskResponsible.bind(this));this.entityStorage.getBacklog().subscribe("openAddEpicForm",this.onOpenAddEpicForm.bind(this));this.entityStorage.getBacklog().subscribe("openListEpicGrid",this.onOpenListEpicGrid.bind(this));this.entityStorage.getBacklog().subscribe("openDefinitionOfDone",this.onOpenDefinitionOfDone.bind(this));this.entityStorage.getBacklog().subscribe("attachFilesToTask",this.onAttachFilesToTask.bind(this));this.entityStorage.getBacklog().subscribe("showDod",this.onShowDod.bind(this));this.entityStorage.getBacklog().subscribe("showTagSearcher",this.onShowTagSearcher.bind(this));this.entityStorage.getBacklog().subscribe("showEpicSearcher",this.onShowEpicSearcher.bind(this));this.entityStorage.getBacklog().subscribe("startDecomposition",this.onStartDecomposition.bind(this));this.entityStorage.getBacklog().subscribe("tagsSearchOpen",this.onTagsSearchOpen.bind(this));this.entityStorage.getBacklog().subscribe("tagsSearchClose",this.onTagsSearchClose.bind(this));this.entityStorage.getBacklog().subscribe("epicSearchOpen",this.onEpicSearchOpen.bind(this));this.entityStorage.getBacklog().subscribe("epicSearchClose",this.onEpicSearchClose.bind(this));this.entityStorage.getBacklog().subscribe("filterByEpic",this.onFilterByEpic.bind(this));this.entityStorage.getBacklog().subscribe("filterByTag",this.onFilterByTag.bind(this));this.entityStorage.getBacklog().subscribe("activateGroupMode",this.onActivateGroupMode.bind(this));this.entityStorage.getBacklog().subscribe("deactivateGroupMode",this.onDeactivateGroupMode.bind(this));this.entityStorage.getBacklog().subscribe("loadItems",this.onLoadItems.bind(this));this.entityStorage.getSprints().forEach(function(t){return e.subscribeToSprint(t)});this.epic.subscribe("filterByTag",this.onFilterByTag.bind(this))}},{key:"subscribeToSprint",value:function t(e){e.subscribe("createTaskItem",this.onCreateTaskItem.bind(this));e.subscribe("updateItem",this.onUpdateItem.bind(this));e.subscribe("showTask",this.onShowTask.bind(this));e.subscribe("moveItem",this.onMoveItem.bind(this));e.subscribe("moveToSprint",this.onMoveToSprint.bind(this));e.subscribe("moveToBacklog",this.onMoveToBacklog.bind(this));e.subscribe("removeItem",this.onRemoveItem.bind(this));e.subscribe("startSprint",this.onStartSprint.bind(this));e.subscribe("completeSprint",this.onCompleteSprint.bind(this));e.subscribe("changeTaskResponsible",this.onChangeTaskResponsible.bind(this));e.subscribe("removeSprint",this.onRemoveSprint.bind(this));e.subscribe("changeSprintName",this.onChangeSprintName.bind(this));e.subscribe("changeSprintDeadline",this.onChangeSprintDeadline.bind(this));e.subscribe("attachFilesToTask",this.onAttachFilesToTask.bind(this));e.subscribe("showDod",this.onShowDod.bind(this));e.subscribe("showTagSearcher",this.onShowTagSearcher.bind(this));e.subscribe("showEpicSearcher",this.onShowEpicSearcher.bind(this));e.subscribe("startDecomposition",this.onStartDecomposition.bind(this));e.subscribe("tagsSearchOpen",this.onTagsSearchOpen.bind(this));e.subscribe("tagsSearchClose",this.onTagsSearchClose.bind(this));e.subscribe("epicSearchOpen",this.onEpicSearchOpen.bind(this));e.subscribe("epicSearchClose",this.onEpicSearchClose.bind(this));e.subscribe("filterByEpic",this.onFilterByEpic.bind(this));e.subscribe("filterByTag",this.onFilterByTag.bind(this));e.subscribe("activateGroupMode",this.onActivateGroupMode.bind(this));e.subscribe("deactivateGroupMode",this.onDeactivateGroupMode.bind(this));e.subscribe("getSprintCompletedItems",this.onGetSprintCompletedItems.bind(this));e.subscribe("showSprintBurnDownChart",this.onShowSprintBurnDownChart.bind(this));e.subscribe("toggleSubTasks",this.onToggleSubTasks.bind(this));e.subscribe("loadItems",this.onLoadItems.bind(this))}},{key:"showErrorAlert",value:function t(e){u.MessageBox.alert(e,c.Loc.getMessage("TASKS_SCRUM_ERROR_TITLE_POPUP"))}},{key:"onCreateTaskItem",value:function t(e){var i=this;var s=e.getData();var n=e.getTarget();var r=s.inputObject;var a=s.value;var o=null;try{o=this.createItem("task",a)}catch(t){this.showErrorAlert(t.message);return}this.pullItem.addTmpIdsToSkipAdding(o.getItemId());this.fillItemBeforeCreation(n,o,a);this.domBuilder.appendItemAfterItem(o.render(),r.getNode());o.onAfterAppend(n.getListItemsNode());o.setParentId(r.getEpicId());r.setEpicId(0);this.sendRequestToCreateTask(n,o).then(function(t){i.fillItemAfterCreation(o,t.data);t.data.tags.forEach(function(t){i.tagSearcher.addTagToSearcher(t)});n.setItem(o);i.updateEntityCounters(n)}).catch(function(t){i.requestSender.showErrorAlert(t)})}},{key:"onUpdateItem",value:function t(e){var i=this;var s=e.getTarget();var n=e.getData();this.pullItem.addIdToSkipUpdating(n.itemId);this.requestSender.updateItem(e.getData()).then(function(){var t=!c.Type.isUndefined(n.storyPoints);if(t){i.updateEntityCounters(s)}}).catch(function(t){i.requestSender.showErrorAlert(t)})}},{key:"onRemoveItem",value:function t(e){var i=this;var s=e.getTarget();if(s.isGroupMode()){var n=[];s.getGroupModeItems().forEach(function(t){n.push({itemId:t.getItemId(),entityId:t.getEntityId(),itemType:t.getItemType(),sourceId:t.getSourceId()});i.pullItem.addIdToSkipRemoving(t.getItemId())});this.requestSender.batchRemoveItem({items:n,sortInfo:this.itemMover.calculateSort(s.getListItemsNode())}).catch(function(t){i.requestSender.showErrorAlert(t)});s.deactivateGroupMode()}else{this.pullItem.addIdToSkipRemoving(e.getData().getItemId());this.requestSender.removeItem({itemId:e.getData().getItemId(),entityId:e.getData().getEntityId(),itemType:e.getData().getItemType(),sourceId:e.getData().getSourceId(),sortInfo:this.itemMover.calculateSort(s.getListItemsNode())}).catch(function(t){i.requestSender.showErrorAlert(t)})}}},{key:"onMoveItem",value:function t(e){var i=e.getData();this.itemMover.moveItem(i.item,i.button)}},{key:"onMoveToSprint",value:function t(e){var i=e.getData();var s=e.getTarget();this.itemMover.moveToAnotherEntity(s,i.item,null,i.button);if(this.entityStorage.getSprintsAvailableForFilling(s).size<=1){this.domBuilder.remove(i.button.parentNode)}}},{key:"onMoveToBacklog",value:function t(e){var i=e.getData();this.itemMover.moveToAnotherEntity(i.sprint,i.item,this.entityStorage.getBacklog())}},{key:"onChangeTaskResponsible",value:function t(e){var i=this;this.pullItem.addIdToSkipUpdating(e.getData().getItemId());this.requestSender.changeTaskResponsible({itemId:e.getData().getItemId(),itemType:e.getData().getItemType(),sourceId:e.getData().getSourceId(),responsible:e.getData().getResponsible()}).catch(function(t){i.requestSender.showErrorAlert(t)})}},{key:"onStartSprint",value:function t(e){var i=e.getTarget();var s=new Qt({sprints:this.entityStorage.getSprints(),sidePanel:this.sidePanel,requestSender:this.requestSender,views:this.views});s.showStartSidePanel(i)}},{key:"onCompleteSprint",value:function t(e){var i=e.getTarget();var s=new Qt({sprints:this.entityStorage.getSprints(),sidePanel:this.sidePanel,requestSender:this.requestSender,views:this.views});s.showCompleteSidePanel(i)}},{key:"onRemoveSprint",value:function t(e){var i=this;var s=e.getTarget();this.pullSprint.addIdToSkipRemoving(s.getId());this.requestSender.removeSprint({sprintId:s.getId(),sortInfo:this.sprintMover.calculateSprintSort()}).then(function(t){i.entityStorage.removeSprint(s.getId())}).catch(function(t){i.requestSender.showErrorAlert(t)})}},{key:"onChangeSprintName",value:function t(e){var i=this;var s=e.getData();this.pullSprint.addIdToSkipUpdating(s.sprintId);this.requestSender.changeSprintName(s).catch(function(t){i.requestSender.showErrorAlert(t)})}},{key:"onChangeSprintDeadline",value:function t(e){var i=this;var s=e.getData();this.pullSprint.addIdToSkipUpdating(s.sprintId);this.requestSender.changeSprintDeadline(s).catch(function(t){i.requestSender.showErrorAlert(t)})}},{key:"onGetSprintCompletedItems",value:function t(e){var i=this;var s=e.getTarget();var n=s.getListItemsNode();var a=this.domBuilder.getPosition(n);var o=new r.Loader({target:n,size:60,mode:"inline",color:"#eaeaea",offset:{left:"".concat(a.width/2-30,"px")}});o.show();this.requestSender.getSprintCompletedItems({sprintId:s.getId()}).then(function(t){var e=t.data;e.forEach(function(t){var e=new O(t);e.setDisableStatus(s.isDisabled());i.domBuilder.append(e.render(),n);s.setItem(e)});o.hide()}).catch(function(t){o.hide();i.requestSender.showErrorAlert(t)})}},{key:"onShowSprintBurnDownChart",value:function t(e){var i=e.getTarget();var s=new Qt({sprints:this.entityStorage.getSprints(),sidePanel:this.sidePanel,requestSender:this.requestSender,views:this.views});s.showBurnDownChart(i)}},{key:"onShowTask",value:function t(e){var i=e.getData();this.sidePanel.openSidePanelByUrl(this.pathToTask.replace("#task_id#",i.getSourceId()))}},{key:"onAttachFilesToTask",value:function t(e){var i=this;var s=e.getData();this.pullItem.addIdToSkipUpdating(s.item.getItemId());this.requestSender.attachFilesToTask({taskId:s.item.getSourceId(),itemId:s.item.getItemId(),entityId:s.item.getEntityId(),attachedIds:s.attachedIds}).then(function(t){s.item.updateIndicators(t.data)}).catch(function(t){i.requestSender.showErrorAlert(t)})}},{key:"onShowDod",value:function t(e){var i=e.getData();this.itemDod.skipNotificationPopups();this.itemDod.showList(i.getSourceId()).then(function(){}).catch(function(){})}},{key:"onToggleSubTasks",value:function t(e){var i=e.getTarget();var s=e.getData();this.subTasksCreator.toggleSubTasks(i,s)}},{key:"onShowTagSearcher",value:function t(e){var i=this;var s=e.getTarget();var n=e.getData();var r=n.item;var a=n.button;this.tagSearcher.showTagsDialog(r,a);this.tagSearcher.unsubscribeAll("attachTagToTask");this.tagSearcher.subscribe("attachTagToTask",function(t){var e=t.getData();if(s.isGroupMode()){var n=[];s.getGroupModeItems().forEach(function(t){n.push({taskId:t.getSourceId(),itemId:t.getItemId()})});i.requestSender.batchAttachTagToTask({tasks:n,entityId:s.getId(),tag:e}).then(function(t){s.getGroupModeItems().forEach(function(t){var i=t.getTags();i.push(e);t.setEpicAndTags(t.getEpic(),i)})}).catch(function(t){i.requestSender.showErrorAlert(t)})}else{var a=r.getTags();i.requestSender.attachTagToTask({taskId:r.getSourceId(),itemId:r.getItemId(),entityId:s.getId(),tag:e}).then(function(t){a.push(e);r.setEpicAndTags(r.getEpic(),a)}).catch(function(t){i.requestSender.showErrorAlert(t)})}});this.tagSearcher.unsubscribeAll("deAttachTagToTask");this.tagSearcher.subscribe("deAttachTagToTask",function(t){var e=t.getData();if(s.isGroupMode()){var n=[];s.getGroupModeItems().forEach(function(t){n.push({taskId:t.getSourceId(),itemId:t.getItemId()})});i.requestSender.batchDeattachTagToTask({tasks:n,entityId:s.getId(),tag:e}).then(function(t){s.getGroupModeItems().forEach(function(t){var i=t.getTags();i.splice(i.indexOf(e),1);t.setEpicAndTags(t.getEpic(),i)})}).catch(function(t){i.requestSender.showErrorAlert(t)})}else{var a=r.getTags();i.requestSender.deAttachTagToTask({taskId:r.getSourceId(),itemId:r.getItemId(),entityId:s.getId(),tag:e}).then(function(t){a.splice(a.indexOf(e),1);r.setEpicAndTags(r.getEpic(),a)}).catch(function(t){i.requestSender.showErrorAlert(t)})}});this.tagSearcher.unsubscribeAll("hideTagDialog");this.tagSearcher.subscribe("hideTagDialog",function(t){if(s.isGroupMode()){s.deactivateGroupMode()}})}},{key:"onShowEpicSearcher",value:function t(e){var i=this;var s=e.getTarget();var n=e.getData();var r=n.item;var a=n.button;this.tagSearcher.showEpicDialog(r,a);this.tagSearcher.unsubscribeAll("updateItemEpic");this.tagSearcher.subscribe("updateItemEpic",function(t){if(s.isGroupMode()){var e=[];s.getGroupModeItems().forEach(function(t){e.push({itemId:t.getItemId()});i.pullItem.addIdToSkipUpdating(t.getItemId())});i.requestSender.batchUpdateItemEpic({items:e,entityId:s.getId(),epicId:t.getData()}).then(function(t){s.getGroupModeItems().forEach(function(e){if(c.Type.isArray(t.data.epic)){e.setParentId(0);e.setEpicAndTags(null,null)}else{e.setParentId(t.data.epic.id);e.setEpicAndTags(t.data.epic,e.getTags())}});s.deactivateGroupMode()}).catch(function(t){i.requestSender.showErrorAlert(t)})}else{i.pullItem.addIdToSkipUpdating(r.getItemId());i.requestSender.updateItemEpic({itemId:r.getItemId(),entityId:s.getId(),epicId:t.getData()}).then(function(t){if(c.Type.isArray(t.data.epic)){r.setParentId(0);r.setEpicAndTags(null,null)}else{r.setParentId(t.data.epic.id);r.setEpicAndTags(t.data.epic,r.getTags())}}).catch(function(t){i.requestSender.showErrorAlert(t)})}})}},{key:"onStartDecomposition",value:function t(e){var i=this;var s=e.getTarget();var n=e.getData();var r=new ae({entity:s,itemStyleDesigner:this.itemStyleDesigner,subTasksCreator:this.subTasksCreator});r.subscribe("tagsSearchOpen",this.onTagsSearchOpen.bind(this));r.subscribe("tagsSearchClose",this.onTagsSearchClose.bind(this));r.subscribe("createItem",function(t){var e=t.getData();var a=r.getDecomposedItems();var o=Array.from(a).pop();var u=null;try{u=i.createItem(n.getItemType(),e)}catch(t){i.showErrorAlert(t.message);return}i.pullItem.addTmpIdsToSkipAdding(u.getItemId());i.pullItem.addIdToSkipUpdating(n.getItemId());u.setParentEntity(s.getId(),s.getEntityType());u.setParentId(n.getParentId());u.setParentTaskId(n.getSourceId());u.setEpic(n.getEpic());u.setTags(n.getTags());u.setResponsible(r.getResponsible());if(r.isBacklogDecomposition()){n.setLinkedTask("Y");u.setSort(o.getSort()+1);u.setInfo({borderColor:r.getBorderColor()});u.setLinkedTask("Y")}else{u.setSort(r.getSubTasks(n).length+1);u.setSubTask("Y");u.setParentTaskId(n.getSourceId());u.setParentTask("N");if(r.isFirstDecomposition()){u.setStoryPoints(n.getStoryPoints().getPoints())}n.setParentTask("Y");n.setSubTasksCount(n.getSubTasksCount()+1);n.updateParentTaskNodes()}i.domBuilder.appendItemAfterItem(u.render(),r.getLastDecomposedItemNode(n));u.onAfterAppend(s.getListItemsNode());r.addDecomposedItem(u);i.sendRequestToCreateTask(s,u).then(function(t){i.fillItemAfterCreation(u,t.data);t.data.tags.forEach(function(t){i.tagSearcher.addTagToSearcher(t)});s.setItem(u);i.updateEntityCounters(s);if(!r.isBacklogDecomposition()){if(o.getItemId()===n.getItemId()){n.updateSubTasksPoints(u.getSourceId(),u.getStoryPoints());n.setStoryPoints("")}i.subTasksCreator.addSubTask(n,u)}})});r.subscribe("updateParentItem",this.onUpdateItem.bind(this));r.decomposeItem(n)}},{key:"onTagsSearchOpen",value:function t(e){var i=e.getData();var s=i.inputObject;var n=i.enteredHashTagName;this.tagSearcher.showTagsSearchDialog(s,n)}},{key:"onTagsSearchClose",value:function t(){this.tagSearcher.closeTagsSearchDialog()}},{key:"onFilterByTag",value:function t(e){var i=e.getData();var s=this.filter.getValueFromField({name:"TAG",value:""});if(String(i)===String(s)){this.filter.setValueToField({name:"TAG",value:""})}else{this.filter.setValueToField({name:"TAG",value:String(i)})}this.filter.scrollToSearchContainer()}},{key:"onEpicSearchOpen",value:function t(e){var i=e.getData();var s=i.inputObject;var n=i.enteredHashEpicName;this.tagSearcher.showEpicSearchDialog(s,n)}},{key:"onEpicSearchClose",value:function t(){this.tagSearcher.closeEpicSearchDialog()}},{key:"onFilterByEpic",value:function t(e){var i=e.getData();var s=this.filter.getValueFromField({name:"EPIC",value:""});if(String(i)===String(s)){this.filter.setValueToField({name:"EPIC",value:""})}else{this.filter.setValueToField({name:"EPIC",value:String(i)})}this.filter.scrollToSearchContainer()}},{key:"onActivateGroupMode",value:function t(e){var i=e.getTarget();if(i.getId()!==this.entityStorage.getBacklog().getId()){this.entityStorage.getBacklog().deactivateGroupMode()}this.entityStorage.getSprints().forEach(function(t){if(i.getId()!==t.getId()){t.deactivateGroupMode()}});i.getItems().forEach(function(t){t.activateGroupMode()})}},{key:"onDeactivateGroupMode",value:function t(e){var i=e.getTarget();i.getItems().forEach(function(t){t.deactivateGroupMode()})}},{key:"onLoadItems",value:function t(e){var i=this;var s=e.getTarget();s.setActiveLoadItems(true);var n=s.showItemsLoader();var r={entityId:s.getId(),pageNumber:s.getPageNumberItems()+1};this.requestSender.getItems(r).then(function(t){var e=t.data;if(c.Type.isArray(e)&&e.length){s.incrementPageNumberItems();s.setActiveLoadItems(false);i.createItemsInEntity(s,e)}n.hide()}).catch(function(t){n.hide();s.setActiveLoadItems(false);i.requestSender.showErrorAlert(t)})}},{key:"createItemsInEntity",value:function t(e,i){var s=this;i.forEach(function(t){var i=new O(t);i.setEntityType(e.getEntityType());if(!s.entityStorage.findItemByItemId(i.getItemId())){s.domBuilder.append(i.render(),e.getListItemsNode());i.onAfterAppend(e.getListItemsNode());e.setItem(i)}})}},{key:"onShowTeamSpeedChart",value:function t(e){var i=new Ee({sidePanel:this.sidePanel,requestSender:this.requestSender});i.showTeamSpeedChart()}},{key:"onOpenAddEpicForm",value:function t(e){this.epic.openAddForm()}},{key:"onOpenListEpicGrid",value:function t(e){var i=this;this.epic.openEpicsList();this.epic.subscribe("onAfterEditEpic",function(t){var e=t.getData();var s=e.data;i.epic.onAfterUpdateEpic(s)})}},{key:"onOpenDefinitionOfDone",value:function t(e){var i=e.getTarget();var s=new Te({sidePanel:this.sidePanel,requestSender:this.requestSender});s.showSettingsPanel(i)}},{key:"createItem",value:function t(e,i){var s=i.replace(new RegExp(Y.tagRegExp,"g"),"").replace(new RegExp(Y.epicRegExp,"g"),"");return new O({itemId:"",itemType:e,name:s})}},{key:"sendRequestToCreateTask",value:function t(e,i){var s={tmpId:i.getItemId(),itemType:i.getItemType(),name:i.getName(),entityId:i.getEntityId(),entityType:e.getEntityType(),parentId:i.getParentId(),sort:i.getSort(),storyPoints:i.getStoryPoints().getPoints(),tags:i.getTags(),epic:i.getEpic(),parentTaskId:i.getParentTaskId(),responsible:i.getResponsible(),info:i.getInfo(),sortInfo:this.itemMover.calculateSort(e.getListItemsNode()),isActiveSprint:e.getEntityType()==="sprint"&&e.isActive()?"Y":"N"};return this.requestSender.createTask(s)}},{key:"fillItemBeforeCreation",value:function t(e,i,s){i.setParentEntity(e.getId(),e.getEntityType());i.setSort(1);i.setResponsible(this.defaultResponsible);var n=Y.getHashTagNamesFromText(s);var r=Y.getHashEpicNamesFromText(s).pop();var a=null;if(r){a=this.tagSearcher.getEpicByName(r.trim())}if(a||n.length>0){i.setEpicAndTags(a,n)}}},{key:"fillItemAfterCreation",value:function t(e,i){e.setItemId(i.itemId);if(!c.Type.isArray(i.epic)||i.tags.length>0){e.setEpicAndTags(i.epic,i.tags)}e.setResponsible(i.responsible);e.setSourceId(i.sourceId);e.setAllowedActions(i.allowedActions)}},{key:"openEpicEditForm",value:function t(e){this.epic.openEditForm(e)}},{key:"openEpicViewForm",value:function t(e){this.epic.openViewForm(e)}},{key:"removeEpic",value:function t(e){var i=this;this.requestSender.removeItem({itemId:e,itemType:"epic"}).then(function(t){var e=t.data;i.epic.onAfterRemoveEpic(e)}).catch(function(t){i.requestSender.showErrorAlert(t)})}},{key:"updateEntityCounters",value:function t(e,i){var s=new Map;s.set(e.getId(),e);if(i){s.set(i.getId(),i)}this.entityCounters.updateCounters(s)}}]);return e}(Ot);function Ge(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-btn-split ui-btn-primary ui-btn-xs"> \n\t\t\t\t<button class="ui-btn-main">\n\t\t\t\t\t','\n\t\t\t\t</button> \n\t\t\t\t<button class="ui-btn-menu"></button> \n\t\t\t</div>\n\t\t']);Ge=function e(){return t};return t}var Ke=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t.setEventNamespace("BX.Tasks.Scrum.ActiveSprintButton");return t}babelHelpers.createClass(e,[{key:"render",value:function t(){var e=c.Tag.render(Ge(),c.Loc.getMessage("TASKS_SCRUM_ACTIONS_COMPLETE_SPRINT"));var i=e.querySelector(".ui-btn-main");var s=e.querySelector(".ui-btn-menu");c.Event.bind(i,"click",this.onCompleteSprintClick.bind(this));c.Event.bind(s,"click",this.onMenuClick.bind(this,i));return e}},{key:"onCompleteSprintClick",value:function t(){this.emit("completeSprint")}},{key:"onMenuClick",value:function t(e){var i=this;var s=new l.Menu({id:"active-sprint-actions-menu-".concat(c.Text.getRandom()),bindElement:e});s.addMenuItem({text:c.Loc.getMessage("TASKS_SCRUM_ACTIVE_SPRINT_BUTTON"),onclick:function t(e,s){s.getMenuWindow().close();i.emit("showBurnDownChart")}});s.show()}}]);return e}(d.EventEmitter);function Ve(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<button class="','">\n\t\t\t\t',"\n\t\t\t</button>\n\t\t"]);Ve=function e(){return t};return t}var Xe=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.sidePanel=t.sidePanel;i.isTaskLimitsExceeded=t.isTaskLimitsExceeded;i.canUseAutomation=t.canUseAutomation;i.groupId=t.groupId;i.setEventNamespace("BX.Tasks.Scrum.RobotButton");return i}babelHelpers.createClass(e,[{key:"render",value:function t(){var e="tasks-scrum-robot-btn ui-btn ui-btn-light-border ui-btn-no-caps ui-btn-themes ui-btn-round";if(this.isShowLimitSidePanel()){e+=" ui-btn-icon-lock"}var i=c.Tag.render(Ve(),e,c.Loc.getMessage("TASKS_SCRUM_ROBOTS_BUTTON"));c.Event.bind(i,"click",this.onClick.bind(this));return i}},{key:"onClick",value:function t(){if(this.isShowLimitSidePanel()){BX.UI.InfoHelper.show("limit_tasks_robots")}else{var e="/bitrix/components/bitrix/tasks.automation/slider.php?site_id="+c.Loc.getMessage("SITE_ID")+"&project_id="+this.groupId;this.sidePanel.openSidePanelByUrl(e)}}},{key:"isShowLimitSidePanel",value:function t(){return this.isTaskLimitsExceeded&&!this.canUseAutomation}}]);return e}(d.EventEmitter);var Ye=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.ActiveSprint");i.setParams(t);if(i.existActiveSprint()){i.finishStatus=i.getActiveSprintParams().finishStatus;i.sprint=new Mt(i.getActiveSprintParams());i.itemsInFinishStage=new Map;i.bindHandlers()}i.sidePanel=new Rt;return i}babelHelpers.createClass(e,[{key:"renderSprintStatsTo",value:function t(i){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"renderSprintStatsTo",this).call(this,i);if(this.sprint){this.statsHeader=pt.build(this.sprint);this.statsHeader.setKanbanStyle();c.Dom.append(this.statsHeader.render(),i)}}},{key:"renderButtonsTo",value:function t(i){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"renderButtonsTo",this).call(this,i);if(!this.existActiveSprint()){return}var s=new Xe({sidePanel:this.sidePanel,groupId:this.getCurrentGroupId(),isTaskLimitsExceeded:this.isTaskLimitsExceeded(),canUseAutomation:this.isCanUseAutomation()});var n=new Ke;n.subscribe("completeSprint",this.onCompleteSprint.bind(this));n.subscribe("showBurnDownChart",this.onShowSprintBurnDownChart.bind(this));c.Dom.append(s.render(),i);c.Dom.append(n.render(),i)}},{key:"setParams",value:function t(e){var i=this;this.setPathToTask(e.pathToTask);this.setActiveSprintParams(e.activeSprint);this.setTaskLimitsExceeded(e.taskLimitExceeded);this.setCanUseAutomation(e.canUseAutomation);this.sprints=new Map;e.sprints.forEach(function(t){var e=new Mt(t);i.sprints.set(e.getId(),e)});this.views=e.views}},{key:"setPathToTask",value:function t(e){this.pathToTask=c.Type.isString(e)?e:""}},{key:"getPathToTask",value:function t(){return this.pathToTask}},{key:"setActiveSprintParams",value:function t(e){this.activeSprint=c.Type.isPlainObject(e)?e:null}},{key:"getActiveSprintParams",value:function t(){return this.activeSprint}},{key:"setTaskLimitsExceeded",value:function t(e){this.limitExceeded=e==="Y"}},{key:"isTaskLimitsExceeded",value:function t(){return this.limitExceeded}},{key:"setCanUseAutomation",value:function t(e){this.canUseAutomation=e==="Y"}},{key:"isCanUseAutomation",value:function t(){return this.canUseAutomation}},{key:"existActiveSprint",value:function t(){return this.activeSprint!==null}},{key:"bindHandlers",value:function t(){var e=this;var i=BX.Tasks.Scrum.Kanban;if(i){this.bindKanbanHandlers(i.getKanban());i.getKanbansGroupedByParentTasks().forEach(function(t){e.bindKanbanHandlers(t)})}}},{key:"bindKanbanHandlers",value:function t(e){var i=this;this.onKanbanRender(e);d.EventEmitter.subscribe(e,"Kanban.Grid:onItemMoved",function(t){var e=t.getCompatData(),s=babelHelpers.slicedToArray(e,3),n=s[0],r=s[1],a=s[2];i.onItemMoved(n,r,a)})}},{key:"onCompleteSprint",value:function t(e){var i=this;var s=new Qt({sprints:this.sprints,sidePanel:this.sidePanel,requestSender:this.requestSender,views:this.views});s.showCompleteSidePanel(this.sprint);this.sprint.subscribe("showTask",function(t){var e=t.getData();i.sidePanel.openSidePanelByUrl(i.getPathToTask().replace("#task_id#",e.getSourceId()))})}},{key:"onKanbanRender",value:function t(e){var i=e.getItems();var s=Object.prototype.hasOwnProperty;for(var n in e.getItems()){if(s.call(i,n)){var r=i[n];if(r.getColumn().getType()===this.finishStatus){this.itemsInFinishStage.set(n,"")}}}}},{key:"onItemMoved",value:function t(e,i,s){if(i.type===this.finishStatus){if(!this.itemsInFinishStage.has(e.getId())){this.updateStatsAfterMovedToFinish(e,this.sprint)}}else{if(this.itemsInFinishStage.has(e.getId())){this.updateStatsAfterMovedFromFinish(e,this.sprint)}}this.statsHeader.updateStats(this.sprint)}},{key:"updateStatsAfterMovedToFinish",value:function t(e,i){this.itemsInFinishStage.set(e.getId(),e.getStoryPoints());i.getCompletedStoryPoints().addPoints(e.getStoryPoints());i.getUncompletedStoryPoints().subtractPoints(e.getStoryPoints());i.setCompletedTasks(i.getCompletedTasks()+1);i.setUncompletedTasks(i.getUncompletedTasks()-1);i.getItems().forEach(function(t){if(t.getSourceId()===parseInt(e.getId(),10)){t.setCompleted("Y");if(t.isSubTask()){var s=i.getItemBySourceId(t.getParentTaskId());if(s){var n=i.getItemsByParentTaskId(s.getSourceId());var r=babelHelpers.toConsumableArray(n.values()).find(function(t){return!t.isCompleted()});if(!r){s.setCompleted("Y")}}}}})}},{key:"updateStatsAfterMovedFromFinish",value:function t(e,i){this.itemsInFinishStage.delete(e.getId());i.getCompletedStoryPoints().subtractPoints(e.getStoryPoints());i.getUncompletedStoryPoints().addPoints(e.getStoryPoints());i.setCompletedTasks(i.getCompletedTasks()-1);i.setUncompletedTasks(i.getUncompletedTasks()+1);i.getItems().forEach(function(t){if(t.getSourceId()===parseInt(e.getId(),10)){t.setCompleted("N");if(t.isSubTask()){var s=i.getItemBySourceId(t.getParentTaskId());if(s){var n=i.getItemsByParentTaskId(s.getSourceId());var r=babelHelpers.toConsumableArray(n.values()).find(function(t){return!t.isCompleted()});if(r){s.setCompleted("N")}}}}})}},{key:"onShowSprintBurnDownChart",value:function t(e){var i=new Qt({sidePanel:this.sidePanel,requestSender:this.requestSender,views:this.views});i.showBurnDownChart(this.sprint)}}]);return e}(Ot);function je(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<button class="ui-btn ui-btn-primary ui-btn-xs">\n\t\t\t\t',"\n\t\t\t</button>\n\t\t"]);je=function e(){return t};return t}var We=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t.setEventNamespace("BX.Tasks.Scrum.BurnDownButton");return t}babelHelpers.createClass(e,[{key:"render",value:function t(){var e=c.Tag.render(je(),c.Loc.getMessage("TASKS_SCRUM_ACTIVE_SPRINT_BUTTON"));c.Event.bind(e,"click",this.onClick.bind(this));return e}},{key:"onClick",value:function t(){this.emit("click")}}]);return e}(d.EventEmitter);var ze=function(t){babelHelpers.inherits(e,t);function e(t){var i;babelHelpers.classCallCheck(this,e);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));i.setEventNamespace("BX.Tasks.Scrum.CompletedSprint");i.setParams(t);i.bindHandlers();return i}babelHelpers.createClass(e,[{key:"renderSprintStatsTo",value:function t(i){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"renderSprintStatsTo",this).call(this,i);this.titleContainer=i;this.titleContainer.textContent=c.Text.encode(this.completedSprint.getName())}},{key:"renderButtonsTo",value:function t(i){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"renderButtonsTo",this).call(this,i);var s=new We;s.subscribe("click",this.onShowSprintBurnDownChart.bind(this));c.Dom.append(s.render(),i)}},{key:"setParams",value:function t(e){var i=this;this.completedSprint=new Mt(e.completedSprint);this.sidePanel=new Rt;this.sprints=new Map;e.sprints.forEach(function(t){var e=Mt.buildSprint(t);i.sprints.set(e.getId(),e)});this.views=e.views}},{key:"bindHandlers",value:function t(){d.EventEmitter.subscribe("onTasksGroupSelectorChange",this.onSprintSelectorChange.bind(this))}},{key:"onSprintSelectorChange",value:function t(e){var i=e.getCompatData(),s=babelHelpers.slicedToArray(i,1),n=s[0];this.completedSprint=this.findSprintBySprintId(n.sprintId);this.titleContainer.textContent=c.Text.encode(n.name)}},{key:"onShowSprintBurnDownChart",value:function t(e){var i=new Qt({sidePanel:this.sidePanel,requestSender:this.requestSender,views:this.views});i.showBurnDownChart(this.completedSprint)}},{key:"findSprintBySprintId",value:function t(e){return babelHelpers.toConsumableArray(this.sprints.values()).find(function(t){return t.getId()===parseInt(e,10)})}}]);return e}(Ot);var Ze=function(){function t(e){babelHelpers.classCallCheck(this,t);this.setParams(e);this.buildView(e)}babelHelpers.createClass(t,[{key:"setParams",value:function t(e){this.setViewName(e.viewName)}},{key:"setViewName",value:function t(e){var i=new Set(["plan","activeSprint","completedSprint"]);if(!i.has(e)){throw Error("Invalid value to activeView parameter")}this.viewName=e}},{key:"getViewName",value:function t(){return this.viewName}},{key:"setView",value:function t(e){if(e instanceof Ot){this.view=e}else{this.view=null}}},{key:"getView",value:function t(){return this.view}},{key:"buildView",value:function t(e){var i=this.getViewName();if(i==="plan"){this.setView(new xe(e))}else if(i==="activeSprint"){this.setView(new Ye(e))}else if(i==="completedSprint"){this.setView(new ze(e))}}},{key:"renderTo",value:function t(e){var i=this.getView();if(i instanceof Ot){this.getView().renderTo(e)}}},{key:"renderTabsTo",value:function t(e){var i=this.getView();if(i instanceof Ot){this.getView().renderTabsTo(e)}}},{key:"renderCountersTo",value:function t(e){var i=this.getView();if(i instanceof Ot){this.getView().renderCountersTo(e)}}},{key:"renderSprintStatsTo",value:function t(e){var i=this.getView();if(i instanceof Ot){this.getView().renderSprintStatsTo(e)}}},{key:"renderButtonsTo",value:function t(e){var i=this.getView();if(i instanceof Ot){this.getView().renderButtonsTo(e)}}},{key:"openEpicEditForm",value:function t(e){var i=this.getView();if(i instanceof xe){i.openEpicEditForm(e)}}},{key:"openEpicViewForm",value:function t(e){var i=this.getView();if(i instanceof xe){i.openEpicViewForm(e)}}},{key:"removeEpic",value:function t(e){var i=this.getView();if(i instanceof xe){i.removeEpic(e)}}}]);return t}();t.Entry=Ze})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX.UI.EntitySelector,BX.Tasks.Scrum,BX.UI,BX.UI.DragAndDrop,BX,BX,BX.UI,BX.UI.Dialogs,BX.Main,BX,BX.Event);
//# sourceMappingURL=script.map.js