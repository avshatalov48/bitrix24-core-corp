(function(){BX.namespace("BX.Sender.Letter");if(BX.Sender.Letter.Chain){return}var t=BX.Sender.Page;var e=BX.Sender.Helper;function i(){this.context=null;this.editor=null}i.prototype.init=function(i){this.isFrame=i.isFrame||false;this.isSaved=i.isSaved||false;this.prettyDateFormat=i.prettyDateFormat;this.campaignId=i.campaignId||"";this.pathToLetterEdit=i.pathToLetterEdit||"";this.actionUri=i.actionUri||"";this.mess=i.mess||{};this.campaignTile=i.campaignTile||{};this.dictionaryTimeList=i.dictionaryTimeList||[];this.context=BX(i.containerId);this.lettersNode=e.getNode("letters",this.context);this.popup=[];this.timer=new n({manager:this,dictionary:this.dictionaryTimeList});this.ajaxAction=new BX.AjaxAction(this.actionUri);this.drawNumbers();this.initUi();t.initButtons()};i.prototype.initUi=function(){top.BX.addCustomEvent(top,"sender-letter-edit-change",this.onLetterEditChange.bind(this));e.getNodes("letter",this.context).forEach(this.initLetterNode.bind(this))};i.prototype.onLetterEditChange=function(t){var e=this.getLetterNode(t.id);if(e){this.updateLetterNode(e,t.data)}else{this.addLetter(t.id,t.data)}};i.prototype.drawNumbers=function(){e.getNodes("letter",this.context).forEach(function(t,i){e.getNode("letter-num",t).textContent=i+1})};i.prototype.initLetterNode=function(t){var i=parseInt(t.getAttribute("data-letter-id"));var n=e.getNode("letter-menu",t);BX.bind(n,"click",this.showMenu.bind(this,n,i));var o=e.getNode("letter-time",t);var r=e.getNode("letter-time-btn",t);BX.bind(r,"click",this.timer.show.bind(this.timer,o,r));this.timer.setText(o)};i.prototype.addLetter=function(i,n){var o=e.getTemplatedNode(e.getNode("template-letter",this.context),{},true);o.setAttribute("data-letter-id",i);BX.bind(e.getNode("letter-btn-edit",o),"click",t.open.bind(t,this.pathToLetterEdit.replace("#id#",i).replace("#campaign_id#",this.campaignId)));this.updateLetterNode(o,n);this.initLetterNode(o);this.lettersNode.appendChild(o);this.drawNumbers();if(top.BX.Sender.Page){top.BX.Sender.Page.reloadGrid()}};i.prototype.updateLetterNode=function(t,i){if(!t){return}e.getNode("letter-title",t).textContent=i.title;e.getNode("letter-date",t).textContent=i.dateInsert;e.getNode("letter-user",t).textContent=i.userName;e.getNode("letter-time",t).setAttribute("data-time-value",i.timeShift);e.getNode("letter-user",t).href=""};i.prototype.getLetterNode=function(t){t=parseInt(t);var i=e.getNodes("letter",this.context).filter(function(e){return t===parseInt(e.getAttribute("data-letter-id"))});return i.length>0?i[0]:null};i.prototype.showMenu=function(t,e){if(!this.popup[e]){this.popup[e]=new BX.PopupMenuWindow("sender-trigger-letter-menu-"+e,t,[{id:"sender-move-up-"+e,text:this.mess.moveUp,onclick:this.moveUp.bind(this,e)},{id:"sender-move-down-"+e,text:this.mess.moveDown,onclick:this.moveDown.bind(this,e)},{id:"sender-remove-"+e,text:this.mess.remove,onclick:this.remove.bind(this,e)}],{autoHide:true,autoClose:true},{events:{onclick:function(){}}})}this.popup[e].bindElement=t;this.popup[e].show()};i.prototype.shiftTime=function(t,e){this.doAction("shiftTime",t,null,{timeShift:e})};i.prototype.moveDown=function(t){var i=this.getLetterNode(t);if(!i.nextElementSibling){if(this.popup[t]){this.popup[t].close()}return}i.parentNode.insertBefore(i.nextElementSibling,i);e.display.animateShowing(i,true);this.doAction("moveDown",t,this.drawNumbers.bind(this))};i.prototype.moveUp=function(t){var i=this.getLetterNode(t);if(!i.previousElementSibling){if(this.popup[t]){this.popup[t].close()}return}i.parentNode.insertBefore(i,i.previousElementSibling);e.display.animateShowing(i,true);this.doAction("moveUp",t,this.drawNumbers.bind(this))};i.prototype.remove=function(t){var i=this.getLetterNode(t);e.display.animateHiding(i,true,function(){BX.remove(i)});this.doAction("remove",t,this.drawNumbers.bind(this))};i.prototype.doAction=function(t,e,i,n){if(this.popup[e]){this.popup[e].close()}n=n||{};n.id=this.campaignId;n.letterId=e;var o=this;this.ajaxAction.request({action:t,onsuccess:function(t){if(i){i.apply(o,[t])}if(top.BX.Sender.Page){top.BX.Sender.Page.reloadGrid()}},onfailure:function(){},data:n})};function n(t){this.manager=t.manager;this.dictionary=t.dictionary;this.container=BX("SENDER_TIME_DIALOG");this.typeNode=BX("SENDER_TIME_DIALOG_TYPE");this.valueNode=BX("SENDER_TIME_DIALOG_VALUE")}n.prototype.getLetterId=function(t){return t.closest('[data-role="letter"]').getAttribute("data-letter-id")};n.prototype.show=function(t,e){var i=BX.PopupWindowManager.create("sender-trigger-chain-time-dialog",e,{darkMode:false,closeIcon:true,content:this.container});i.close();i.setBindElement(e);var n=BX("SENDER_TIME_DIALOG_BTN_CANCEL");var o=BX("SENDER_TIME_DIALOG_BTN_SAVE");i.close();BX.unbindAll(n);BX.bind(n,"click",function(){i.close()});BX.unbindAll(o);BX.bind(o,"click",BX.delegate(function(){this.setTimeFromDialog(t);this.setText(t);i.close()},this));this.setTimeToDialog(t);i.show()};n.prototype.getValue=function(t){return parseInt(t.getAttribute("data-time-value"))};n.prototype.setValue=function(t,e){e=parseInt(e);t.setAttribute("data-time-value",e);this.manager.shiftTime(this.getLetterId(t),e)};n.prototype.setText=function(t){if(!t){return}var e=this.convertTime(this.getValue(t));t.textContent=e.VALUE+" "+e.TEXT};n.prototype.setTimeToDialog=function(t){if(!t){return}var e=this.convertTime(this.getValue(t));this.typeNode.value=e.TYPE;this.valueNode.value=e.VALUE};n.prototype.setTimeFromDialog=function(t){var e=this.convertTime(null,{TYPE:this.typeNode.value,VALUE:this.valueNode.value});this.setValue(t,e)};n.prototype.convertTime=function(t,e){if(t!==null){t=parseInt(t);if(isNaN(t)){t=0}if(t>0){var i=this.dictionary.filter(function(e){return t%e.VALUE===0}).map(function(e){return{TYPE:e.TYPE,VALUE:t/e.VALUE,TEXT:e.TEXT}});if(i.length>0){return i[i.length-1]}}var n=this.dictionary[0];return{TYPE:n.TYPE,VALUE:0,TEXT:n.TEXT}}else{var o=parseInt(e.VALUE);if(isNaN(o)){o=0}var r=this.dictionary.filter(function(t){if(!t.VALUE){return false}return t.TYPE===e.TYPE});if(r.length>0){return o*parseInt(r[0].VALUE)}return 0}};BX.Sender.Letter.Chain=new i})(window);