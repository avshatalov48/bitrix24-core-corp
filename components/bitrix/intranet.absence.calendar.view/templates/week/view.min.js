function JCCalendarViewWeek(e){this.ID="week";this._parent=null;this.SETTINGS={};this.ENTRIES=[];if(!window._WEEK_STYLE_LOADED){BX.loadCSS("/bitrix/components/bitrix/intranet.absence.calendar.view/templates/week/view.css");window._WEEK_STYLE_LOADED=true}BX.bind(window,"resize",BX.proxy(this.__onresize,this))}JCCalendarViewWeek.prototype.__onresize=function(){this.UnloadData(true);this.__drawData()};JCCalendarViewWeek.prototype.Load=function(){this._parent.FILTER.SHORT_EVENTS="Y";if(null!=this.ENTRIES&&this.ENTRIES.length>0)this.UnloadData();this.__drawLayout();this.TYPE_BGCOLORS=this._parent.TYPE_BGCOLORS;this._parent.LoadData(this.SETTINGS.DATE_START,this.SETTINGS.DATE_FINISH)};JCCalendarViewWeek.prototype.LoadData=function(e){this.ENTRIES=e;if(BX.browser.IsIE())setTimeout(BX.proxy(this.__drawData,this),10);else this.__drawData()};JCCalendarViewWeek.prototype.UnloadData=function(e){if(null==this.ENTRIES)return;if(null==e)e=false;for(var t=0;t<this.ENTRIES.length;t++){if(null!=this.ENTRIES[t].DATA){for(var a=0;a<this.ENTRIES[t].DATA.length;a++){if(null==this.ENTRIES[t].DATA[a].VISUAL)continue;this._parent.UnRegisterEntry(this.ENTRIES[t].DATA[a]);BX.cleanNode(this.ENTRIES[t].DATA[a].VISUAL,true);this.ENTRIES[t].DATA[a].VISUAL=null}}var T=document.getElementById("bx_calendar_user_"+this.ENTRIES[t]["ID"]);if(null!=T){T.parentNode.removeChild(T);delete T}}if(!e)this.ENTRIES=null};JCCalendarViewWeek.prototype.SetSettings=function(e){this.SETTINGS=e;var t=new Date;if(null==this.SETTINGS.DATE_START||t>=this.SETTINGS.DATE_START&&t<=this.SETTINGS.DATE_FINISH)this.SETTINGS.DATE_START=t;var a=this.SETTINGS.DATE_START.getDay()>=this.SETTINGS.FIRST_DAY?0:-7;this.SETTINGS.DATE_START.setDate(this.SETTINGS.DATE_START.getDate()-this.SETTINGS.DATE_START.getDay()+this.SETTINGS.FIRST_DAY+a);this.SETTINGS.DATE_START.setHours(0);this.SETTINGS.DATE_START.setMinutes(0);this.SETTINGS.DATE_START.setSeconds(0);this.SETTINGS.DATE_START.setMilliseconds(0);this.SETTINGS.DATE_FINISH=new Date(this.SETTINGS.DATE_START.valueOf());this.SETTINGS.DATE_FINISH.setDate(this.SETTINGS.DATE_FINISH.getDate()+7)};JCCalendarViewWeek.prototype.Unload=function(){BX.unbind(window,"resize",BX.proxy(this.__onresize,this));this.UnloadData()};JCCalendarViewWeek.prototype.changeWeek=function(e){if(e!=-1)e=1;this.SETTINGS.DATE_START.setDate(this.SETTINGS.DATE_START.getDate()+e*7);this.SETTINGS.DATE_FINISH=new Date(this.SETTINGS.DATE_START);this.SETTINGS.DATE_FINISH.setDate(this.SETTINGS.DATE_FINISH.getDate()+7);this.Load()};JCCalendarViewWeek.prototype.__drawLayout=function(){var e=this;var t=new Date;t.setHours(0);t.setMinutes(0);t.setSeconds(0);t.setMilliseconds(0);this._parent.CONTROLS.CALENDAR.innerHTML="";this.obTable=document.createElement("TABLE");this.obTable.className="bx-calendar-week-main-table";this.obTable.setAttribute("cellSpacing","0");this._parent.CONTROLS.CALENDAR.appendChild(this.obTable);this.obTable.appendChild(document.createElement("TBODY"));var a=this.obTable.tBodies[0].insertRow(-1);a.insertCell(-1);a.cells[0].className="bx-calendar-week-empty";a.cells[0].innerHTML="&nbsp;";var T=new Date(this.SETTINGS.DATE_FINISH.valueOf());T.setDate(T.getDate()-1);var i=this.SETTINGS.DATE_START.getDate();if(this.SETTINGS.DATE_START.getMonth()!=T.getMonth()){i+=" "+this._parent.MONTHS_R[this.SETTINGS.DATE_START.getMonth()]}if(this.SETTINGS.DATE_START.getFullYear()!=T.getFullYear()){i+=" "+this.SETTINGS.DATE_START.getFullYear()}i+=" - "+T.getDate()+" "+this._parent.MONTHS_R[T.getMonth()]+" "+T.getFullYear();this._parent.CONTROLS.DATEROW.innerHTML='<table class="bx-calendar-week-control-table" align="center"><tr>'+'<td><a href="javascript:void(0)" class="bx-calendar-week-icon bx-calendar-week-back"></a></td>'+"<td>"+i+"</td>"+'<td><a href="javascript:void(0)" class="bx-calendar-week-icon bx-calendar-week-fwd"></a></td>'+"</tr></table>";var s=this._parent.CONTROLS.DATEROW.getElementsByTagName("A");s[0].onclick=function(){e.changeWeek(-1)};s[1].onclick=function(){e.changeWeek(1)};var E=new Date(this.SETTINGS.DATE_START.valueOf());var n=this._parent.isViewRegistered("day");for(var S=0;S<7;S++){var r=a.insertCell(-1);r.className="bx-calendar-week-day";if(E.valueOf()==t.valueOf())r.className+=" bx-calendar-week-today";if(E.getDay()==0||E.getDay()==6)r.className+=" bx-calendar-week-holiday";var h=E.getDate();if(h<10)h="0"+h;if(n){var A=r.appendChild(document.createElement("A"));A.href="javascript:void(0)";A.BX_DAY=new Date(E.valueOf());A.onclick=function(){e.SETTINGS.DATE_START=this.BX_DAY;e.SETTINGS.DATE_FINISH=this.BX_DAY;e._parent.SetView("day")};A.innerHTML=this._parent.DAYS[E.getDay()]+", "+h}else{r.innerHTML=this._parent.DAYS[E.getDay()]+", "+h}E.setDate(E.getDate()+1)}this._parent.CONTROLS.CALENDAR.appendChild(document.createElement("BR"));this._parent.CONTROLS.CALENDAR.appendChild(document.createElement("BR"));this.obPageBar=document.createElement("DIV");this.obPageBar.style.padding="10px 10px 3px";this.obPageBar.style.fontSize="0.95em";this._parent.CONTROLS.CALENDAR.appendChild(this.obPageBar);this._parent.CONTROLS.CALENDAR.appendChild(document.createElement("BR"));this._parent.CONTROLS.CALENDAR.appendChild(document.createElement("BR"))};JCCalendarViewWeek.prototype.__drawData=function(){var e=this;var t=new Date;t.setHours(0);t.setMinutes(0);t.setSeconds(0);t.setMilliseconds(0);var a=this.SETTINGS.DATE_START;date_finish=new Date(a);date_finish.setDate(date_finish.getDate()+7);date_finish.setSeconds(date_finish.getSeconds()-1);for(var T=0;T<(null==this.ENTRIES?0:this.ENTRIES.length);T++){for(var i=0;i<this.ENTRIES[T]["DATA"].length;i++){var s=this.ENTRIES[T]["DATA"][i]["DATE_ACTIVE_FROM"];var E=this.ENTRIES[T]["DATA"][i]["DATE_ACTIVE_TO"];if(a.valueOf()>E.valueOf()||date_finish.valueOf()<s.valueOf()){this.ENTRIES[T]["DATA"].splice(i,1);i--}}if(this.ENTRIES[T]["DATA"].length==0&&!this._parent.FILTER.USERS_ALL){continue}var n=this.obTable.tBodies[0].insertRow(-1);n.insertCell(-1);n.cells[0].className="bx-calendar-week-first-col";n.id="bx_calendar_user_"+this.ENTRIES[T]["ID"];var S=n.cells[0].appendChild(document.createElement("DIV"));var r=this._parent.FormatName(this.SETTINGS.NAME_TEMPLATE,this.ENTRIES[T]);S.title=r;if(this.ENTRIES[T]["DETAIL_URL"]){var h=document.createElement("A");h.appendChild(document.createTextNode(r));h.href=this.ENTRIES[T]["DETAIL_URL"]}else{var h=document.createTextNode(r)}S.appendChild(h);var A=new Date(this.SETTINGS.DATE_START.valueOf());for(var i=0;i<7;i++){var l=n.insertCell(-1);l.className="bx-calendar-week-day";if(A.valueOf()==t.valueOf())l.className+=" bx-calendar-week-today";if(A.getDay()==0||A.getDay()==6)l.className+=" bx-calendar-week-holiday";if(BX.browser.IsIE())l.innerHTML="&nbsp;";A.setDate(A.getDate()+1)}}var I=2;for(var T=0;T<(null==this.ENTRIES?0:this.ENTRIES.length);T++){var N=BX("bx_calendar_user_"+this.ENTRIES[T]["ID"]);if(N&&this.ENTRIES[T]["DATA"]){var o=BX.pos(N,true);for(var i=0;i<this.ENTRIES[T]["DATA"].length;i++){var s=this.ENTRIES[T]["DATA"][i]["DATE_ACTIVE_FROM"],E=this.ENTRIES[T]["DATA"][i]["DATE_ACTIVE_TO"];this.ENTRIES[T]["DATA"][i].VISUAL=document.createElement("DIV");this.ENTRIES[T]["DATA"][i].VISUAL.bx_color_variant=this.ENTRIES[T]["DATA"][i]["TYPE"].length?this.ENTRIES[T]["DATA"][i]["TYPE"]:"OTHER";this.ENTRIES[T]["DATA"][i].VISUAL.className="bx-calendar-entry bx-calendar-color-"+this.ENTRIES[T]["DATA"][i].VISUAL.bx_color_variant;this.ENTRIES[T]["DATA"][i].VISUAL.style.background=this.TYPE_BGCOLORS[this.ENTRIES[T]["DATA"][i]["TYPE"].length?this.ENTRIES[T]["DATA"][i]["TYPE"]:"OTHER"];this.ENTRIES[T]["DATA"][i].VISUAL.style.top=o.top+"px";if(a.valueOf()>s.valueOf())s=a;if(date_finish.valueOf()<E.valueOf())E=date_finish;var D=s.getDay()-a.getDay()+1,d=E.getDay()-date_finish.getDay();var _=N.cells[D>0?D:D+7],c=N.cells[d>0?d:d+7];var R=BX.pos(_,true),p=R.left;var f=s.getHours();if(f>this.SETTINGS.DAY_START){var u=R.right-R.left;if(f<this.SETTINGS.DAY_FINISH){p+=Math.round((f-this.SETTINGS.DAY_START)*u/(this.SETTINGS.DAY_FINISH-this.SETTINGS.DAY_START))}else{p+=u-5}}if(_!=c)R=BX.pos(c,true);var v=R.right;var G=E.getHours();if(G<this.SETTINGS.DAY_FINISH){var g=R.right-R.left;if(G>this.SETTINGS.DAY_START){v-=Math.round((this.SETTINGS.DAY_FINISH-G)*g/(this.SETTINGS.DAY_FINISH-this.SETTINGS.DAY_START))}else{v-=g-5}}var C=parseInt(v-p-I*2);if(isNaN(C)||C<5)C=5;this.ENTRIES[T]["DATA"][i].VISUAL.style.left=parseInt(p)+"px";this.ENTRIES[T]["DATA"][i].VISUAL.style.width=C+"px";this.ENTRIES[T]["DATA"][i].VISUAL.style.height=parseInt(R.height-2*I)+"px";this.ENTRIES[T]["DATA"][i].VISUAL.innerHTML="<nobr>"+BX.util.htmlspecialchars(this.ENTRIES[T]["DATA"][i]["NAME"])+" ("+this.ENTRIES[T]["DATA"][i]["DATE_FROM"]+" - "+this.ENTRIES[T]["DATA"][i]["DATE_TO"]+")"+"</nobr>";this.ENTRIES[T]["DATA"][i].VISUAL.__bx_user_id=this.ENTRIES[T]["ID"];this._parent.MAIN_LAYOUT.appendChild(this.ENTRIES[T]["DATA"][i].VISUAL);this._parent.RegisterEntry(this.ENTRIES[T].DATA[i])}}}if(this.SETTINGS.PAGE_COUNT>1||this.SETTINGS.PAGE_NUMBER>0){this.obPageBar.innerHTML=this._parent.MESSAGES.INTR_ABSC_TPL_PAGE_BAR+": ";for(var T=0;T<=this.SETTINGS.PAGE_NUMBER;T++){if(T==this.SETTINGS.PAGE_NUMBER){var L=document.createTextNode(T+1)}else{var L=document.createElement("A");L.href="javascript:void(0);";L.innerHTML=T+1;L.onclick=function(t){return function(){e.SETTINGS.PAGE_NUMBER=t;e.Load()}}(T)}this.obPageBar.appendChild(L);this.obPageBar.appendChild(document.createTextNode(" "));if(T==0&&this.SETTINGS.PAGE_NUMBER>=6){var L=document.createTextNode("...");this.obPageBar.appendChild(L);this.obPageBar.appendChild(document.createTextNode(" "));T=this.SETTINGS.PAGE_NUMBER-4}}if(this.SETTINGS.PAGE_COUNT-1>this.SETTINGS.PAGE_NUMBER){var L=document.createElement("A");L.href="javascript:void(0);";L.innerHTML=this._parent.MESSAGES.INTR_ABSC_TPL_PAGE_NEXT;L.onclick=function(){e.SETTINGS.PAGE_NUMBER+=1;e.Load()};this.obPageBar.appendChild(L)}}};