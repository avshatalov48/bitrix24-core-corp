(function(){BX.namespace("BX.Timeman.Component.Schedule.ShiftPlan");BX.Timeman.Component.Schedule.ShiftPlan.Table=function(e){BX.Timeman.Component.BaseComponent.apply(this,[{containerSelector:'[data-role="shift-records-container"]'}]);this.isSlider=e.isSlider;this.scheduleId=e.scheduleId;this.gridId=e.gridId;this.useEmployeesTimezoneName="useEmployeesTimezone";this.errorCodeOverlappingPlans=e.errorCodeOverlappingPlans;this.addEventHandlers()};BX.Timeman.Component.Schedule.ShiftPlan.Table.prototype={__proto__:BX.Timeman.Component.BaseComponent.prototype,constructor:BX.Timeman.Component.Schedule.ShiftPlan.Table,addEventHandlers:function(){this.addEventHandlersInsideGrid();BX.addCustomEvent("Grid::updated",this.addEventHandlersInsideGrid.bind(this));document.querySelector('[data-role="shift-records-container"]').addEventListener("TimemanWorktimeGridCellHtmlUpdated",function(e){if(!e.detail.dayCellNodes){return}for(var t=0;t<e.detail.dayCellNodes.length;t++){var n=e.detail.dayCellNodes[t].querySelectorAll('[data-shift-block="true"]');if(n.length===0){continue}for(var i=0;i<n.length;i++){BX.bind(this.selectOneByRole("shiftplan-menu-toggle",n[i]),"click",BX.delegate(this.onShiftplanMenuToggleClick,this));BX.bind(this.selectOneByRole("add-shiftplan-btn",n[i]),"click",BX.delegate(this.onAddShiftPlanClick,this))}}}.bind(this),false)},addEventHandlersInsideGrid:function(){var e=this.selectAllByRole("add-shiftplan-btn");for(var t=0;t<e.length;t++){BX.bind(e[t],"click",BX.delegate(this.onAddShiftPlanClick,this))}var n=this.selectAllByRole("shiftplan-menu-toggle");for(var t=0;t<n.length;t++){BX.bind(n[t],"click",BX.delegate(this.onShiftplanMenuToggleClick,this))}var i=this.selectAllByRole("delete-user-btn");for(var t=0;t<i.length;t++){BX.bind(i[t],"click",BX.delegate(this.onDeleteUserClick,this))}},useEmployeesTimezone:function(){return this.getCookie(this.useEmployeesTimezoneName)==="Y"},onDeleteUserClick:function(e){if(this.popupDeleteUser){this.popupDeleteUser.close()}var t=e.currentTarget.dataset.userId;this.popupDeleteUser=new BX.PopupWindow({id:"tm-shiftplan-delete-schedule-user-"+e.currentTarget.dataset.userId,autoHide:true,draggable:true,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{top:"10px",right:"15px"},zIndex:0,titleBar:BX.message("TM_SCHEDULE_PLAN_DELETE_USER_CONFIRM_TITLE"),content:BX.message("TM_SCHEDULE_PLAN_DELETE_USER_CONFIRM").replace("#USER_NAME#",e.currentTarget.dataset.userName),buttons:[new BX.PopupWindowButton({text:BX.message("TM_SCHEDULE_PLAN_DELETE_USER_CONFIRM_NO"),className:"ui-btn ui-btn-danger",events:{click:function(){this.popupDeleteUser.close()}.bind(this)}}),new BX.PopupWindowButton({text:BX.message("TM_SCHEDULE_PLAN_DELETE_USER_CONFIRM_YES"),className:"ui-btn ui-btn-success",events:{click:function(e){this.popupDeleteUser.close();BX.Main.gridManager.getInstanceById(this.gridId).tableFade();BX.ajax.runAction("timeman.schedule.deleteUser",{data:{id:this.scheduleId,userId:e}}).then(function(e){this.reloadGrid()}.bind(this),function(e){}.bind(this))}.bind(this,t)}})]});this.popupDeleteUser.show()},reloadGrid:function(){BX.Main.gridManager.reload(this.gridId)},onShiftplanMenuToggleClick:function(e){e.stopPropagation();e.preventDefault();this.planMenuPopup=this.buildPlanMenuPopup(e);if(this.planMenuPopup){this.planMenuPopup.show()}},buildPlanMenuPopup:function(e){var t=this.buildPlanMenuItems(e);if(t.length>0){var n="tmShiftPlanMenu";for(var i=0;i<t.length;i++){n=n+t[i].id}return BX.PopupMenu.create({items:t,maxHeight:450,id:n,bindElement:e.currentTarget,angle:true,closeByEsc:true,autoHide:true})}return null},buildPlanMenuItems:function(e){var t=e.currentTarget.dataset;var n=[];if(t.itemDelete==="1"){n.push({id:"deletePlan"+BX.util.getRandomString(20),text:BX.util.htmlspecialchars(BX.message("TM_SHIFT_PLAN_MENU_DELETE_SHIFT_TITLE")),onclick:function(e){this.planMenuPopup.close();BX.ajax.runAction("timeman.shiftplan.delete",{data:this.createFormDataForShiftPlan(e)}).then(function(e,t){this.onSuccessShiftPlanDeleted(t.data.shiftPlan)}.bind(this,e),function(e){}.bind(this))}.bind(this,e.currentTarget)})}if(t.itemAdd==="1"){n.push({id:"addPlan"+BX.util.getRandomString(20),text:BX.util.htmlspecialchars(BX.message("TM_SHIFT_PLAN_MENU_ADD_SHIFT_TITLE")),onclick:function(e){this.planMenuPopup.close();this.onAddShiftPlanClick(e)}.bind(this,e.currentTarget)})}return n},createFormDataForShiftPlan:function(e){var t=new FormData;var n=e.querySelectorAll('input[type="hidden"]');for(var i=0;i<n.length;i++){t.append(n[i].name,n[i].value)}t.append("useEmployeesTimezone",this.useEmployeesTimezone()?"Y":"N");var a=this.selectOneByRole("absence",BX.findParent(e,{tag:"td"}));if(a&&a.dataset){t.append("drawAbsenceTitle",a.dataset.title)}return t},onAddShiftPlanClick:function(e,t){var n=e;if(e.stopPropagation){e.stopPropagation();e.preventDefault();n=e.currentTarget}if(n.isDisabled){return}n.isDisabled=true;var i=this.createFormDataForShiftPlan(n);if(t===true){i.append("createShiftPlanForced","Y")}BX.ajax.runAction("timeman.shiftplan.add",{data:i}).then(function(e){n.isDisabled=false;this.onSuccessShiftPlanAdded(e.data.shiftPlan)}.bind(this),function(e){if(e.errors&&e.errors.length>0&&e.errors[0].code===this.errorCodeOverlappingPlans){BX.UI.Dialogs.MessageBox.show({message:BX.util.htmlspecialchars(e.errors[0].message),modal:true,buttons:BX.UI.Dialogs.MessageBoxButtons.YES_NO,popupOptions:{autoHide:true},onYes:function(e,t){t.close();this.onAddShiftPlanClick(e,true)}.bind(this,n),onNo:function(e){e.close()}})}n.isDisabled=false}.bind(this))},onSuccessShiftPlanDeleted:function(e){this.dispatchCellHtmlRedraw(e)},onSuccessShiftPlanAdded:function(e){this.dispatchCellHtmlRedraw(e)},dispatchCellHtmlRedraw:function(e){if(!this.getEventContainer()){return}var t=new CustomEvent("TimemanWorktimeGridCellHtmlRedraw",{detail:{html:[e.cellHtml]}});this.getEventContainer().dispatchEvent(t)},getEventContainer:function(){return document.querySelector('[data-role="shift-records-container"]')}}})();
//# sourceMappingURL=table.map.js