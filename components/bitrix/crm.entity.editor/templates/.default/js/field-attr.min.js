BX.namespace("BX.Crm");if(typeof BX.Crm.EntityFieldAttributeType==="undefined"){BX.Crm.EntityFieldAttributeType={undefined:0,hidden:1,readonly:2,required:3}}if(typeof BX.Crm.EntityFieldAttributePhaseGroupType==="undefined"){BX.Crm.EntityFieldAttributePhaseGroupType={undefined:0,general:1,pipeline:2,junk:3}}if(typeof BX.Crm.EntityFieldAttributeManager==="undefined"){BX.Crm.EntityFieldAttributeManager=function(){this._id="";this._settings=null;this._entityTypeId=BX.CrmEntityType.enumeration.undefined;this._entityScope=""};BX.Crm.EntityFieldAttributeManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",BX.CrmEntityType.enumeration.undefined);this._entityScope=BX.prop.getString(this._settings,"entityScope","")},isPermitted:function(){return BX.prop.getBoolean(this._settings,"isPermitted",true)},getEntityPhases:function(){var t=BX.CrmProgressManager.current.resolve(this._entityTypeId);return t?t.getInfos(this._entityScope):[]},areMultiTypePhasesEnabled:function(){return BX.CrmProgressManager.current.isMultiType(this._entityTypeId)},createFieldConfigurator:function(t,e){return BX.Crm.EntityFieldAttributeConfigurator.create(this._id,{typeId:e,phases:this.getEntityPhases(),areMultiTypePhasesEnabled:this.areMultiTypePhasesEnabled(),captions:BX.prop.getObject(this._settings,"captions",{}),config:t?t.getAttributeConfiguration(e):null,isPermitted:BX.prop.getBoolean(this._settings,"isPermitted",true),lockScript:BX.prop.getString(this._settings,"lockScript","")})},saveConfiguration:function(t,e){if(!this.isPermitted()){return}BX.ajax.runAction("crm.api.fieldAttribute.saveConfiguration",{data:{config:t,fieldName:e,entityTypeName:BX.CrmEntityType.resolveName(this._entityTypeId),entityScope:this._entityScope}})},removeConfiguration:function(t,e){if(!this.isPermitted()){return}BX.ajax.runAction("crm.api.fieldAttribute.removeConfiguration",{data:{type:t,fieldName:e,entityTypeName:BX.CrmEntityType.resolveName(this._entityTypeId),entityScope:this._entityScope}})}};BX.Crm.EntityFieldAttributeManager.create=function(t,e){var i=new BX.Crm.EntityFieldAttributeManager;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityFieldAttributeConfigurator==="undefined"){BX.Crm.EntityFieldAttributeConfigurator=function(){this._id="";this._settings=null;this._typeId=BX.Crm.EntityFieldAttributeType.undefined;this._fieldName="";this._config=null;this._captions=null;this._phases=null;this._groups=null;this._button=null;this._wrapper=null;this._popup=null;this._label=null;this._switchCheckBox=null;this._switchCheckBoxHandler=BX.delegate(this.onSwitchCheckBoxClick,this);this._areMultiTypePhasesEnabled=false;this._isPermitted=true;this._isEnabled=true;this._isOpened=false;this._isChanged=false;this._closingNotifier=BX.CrmNotifier.create(this)};BX.Crm.EntityFieldAttributeConfigurator.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._isPermitted=BX.prop.getBoolean(this._settings,"isPermitted",true);this._typeId=BX.prop.getInteger(this._settings,"type",BX.Crm.EntityFieldAttributeType.required);this._fieldName=BX.prop.getString(this._settings,"fieldName","");this._captions=BX.prop.getObject(this._settings,"captions",{});this._config=BX.prop.getObject(this._settings,"config",{});var i=BX.prop.getInteger(this._config,"typeId",BX.Crm.EntityFieldAttributeType.undefined);if(i===BX.Crm.EntityFieldAttributeType.undefined){this._config.typeId=this._typeId}else if(i!==this._typeId){throw"EntityFieldAttributeConfigurator. Configuration type mismatch."}this._areMultiTypePhasesEnabled=BX.prop.getBoolean(this._settings,"areMultiTypePhasesEnabled",false);this._phases=BX.prop.getArray(this._settings,"phases",[]);var s=[];var r=[];for(var n=0,o=this._phases.length;n<o;n++){var p=this._phases[n];var a=p["semantics"];if(a==="process"||a==="success"){s.push(p)}else{r.push(p)}}this._groups={};this.createGroup("general","",[{id:"GENERAL",name:this.getCaption("GROUP_TYPE_GENERAL")}],{phaseGroupTypeId:BX.Crm.EntityFieldAttributePhaseGroupType.general});if(s.length>0){this.createGroup("pipeline",this.getCaption("GROUP_TYPE_PIPELINE"),s,{phaseGroupTypeId:BX.Crm.EntityFieldAttributePhaseGroupType.pipeline})}if(r.length>0){this.createGroup("junk",this.getCaption("GROUP_TYPE_JUNK"),r,{phaseGroupTypeId:BX.Crm.EntityFieldAttributePhaseGroupType.junk})}this._isEnabled=!this.isEmpty()},getId:function(){return this._id},getTypeId:function(){return this._typeId},getCaption:function(t){return BX.prop.getString(this._captions,t,t)},getTitle:function(){if(this._typeId===BX.Crm.EntityFieldAttributeType.required){return this.getCaption("REQUIRED_FULL")+":"}return""},getPhaseIndexById:function(t){for(var e=0,i=this._phases.length;e<i;e++){if(this._phases[e]["id"]===t){return e}}return-1},getPhaseInfoById:function(t){var e=this.getPhaseIndexById(t);return e>=0?this._phases[e]:null},resolvePhaseName:function(t){if(t===""){return""}var e=this.getPhaseInfoById(t);return e?BX.prop.getString(e,"name",t):t},resolvePhaseGroupType:function(t){if(t===""){return BX.Crm.EntityFieldAttributePhaseGroupType.undefined}var e=this.getPhaseInfoById(t);if(!e){return BX.Crm.EntityFieldAttributePhaseGroupType.undefined}var i=BX.prop.getString(e,"semantics","");return i==="process"||i==="success"?BX.Crm.EntityFieldAttributePhaseGroupType.pipeline:BX.Crm.EntityFieldAttributePhaseGroupType.junk},prepareLegendData:function(){var t=BX.Crm.EntityPhaseLayout.getCurrent();var e=BX.prop.getArray(this._config,"groups",[]);for(var i=0,s=e.length;i<s;i++){var r=e[i];var n=BX.prop.getArray(r,"items",[]);if(n.length>0){var o=BX.prop.getString(n[0],"startPhaseId","");var p=this.getPhaseInfoById(o);if(p){var a=BX.prop.getString(p,"color","");if(a===""){var h=BX.prop.getString(p,"semantics","");if(h!==""){a=t.getBackgroundColor(h)}}var u=BX.Crm.EntityDetailProgressStep.calculateTextColor(a);return{text:BX.prop.getString(p,"name",o),backgroundColor:a,color:u}}}}return{text:this.getCaption("GROUP_TYPE_GENERAL"),backgroundColor:"#CED4DC",color:"#333"}},adjust:function(){var t=this.isEnabled();var e=this.isEmpty();if(t&&e){this._config=this.getDefaultConfiguration()}else if(!t&&!e){this._config=this.getEmptyConfiguration()}if(this._label){this._label.innerHTML=BX.util.htmlspecialchars(this.getTitle())}if(this._button){this._button.adjust()}},setEnabled:function(t){this._isEnabled=!!t},isEnabled:function(){return this._isEnabled},isChanged:function(){return this._isChanged},isEmpty:function(){return BX.prop.getArray(this._config,"groups",[]).length===0},isCustomized:function(){var t=BX.prop.getArray(this._config,"groups",[]);for(var e=0,i=t.length;e<i;e++){var s=BX.prop.getInteger(t[e],"phaseGroupTypeId",BX.Crm.EntityFieldAttributePhaseGroupType.undefined);if(s===BX.Crm.EntityFieldAttributePhaseGroupType.undefined){continue}if(s!==BX.Crm.EntityFieldAttributePhaseGroupType.general){return true}}return false},isPermitted:function(){return this._isPermitted},runLockScript:function(){var lockScript=BX.prop.getString(this._settings,"lockScript","");if(lockScript!==""){eval(lockScript)}},getDefaultConfiguration:function(){return{typeId:this._typeId,groups:[{phaseGroupTypeId:BX.Crm.EntityFieldAttributePhaseGroupType.general}]}},getEmptyConfiguration:function(){return{typeId:this._typeId,groups:[]}},getConfiguration:function(){return this._config},acceptChanges:function(){if(!(this._isPermitted&&this._isChanged)){return}this._config=this.getEmptyConfiguration();if(this._groups["general"].isSelected()||this._groups["pipeline"].isFullySelected()&&!this._groups["junk"].isSelected()&&!this._areMultiTypePhasesEnabled){this._config["groups"].push({phaseGroupTypeId:BX.Crm.EntityFieldAttributePhaseGroupType.general})}else{this._groups["pipeline"].acceptChanges(this._config);this._groups["junk"].acceptChanges(this._config)}this._isChanged=false},applyConfiguration:function(){for(var t in this._groups){if(!this._groups.hasOwnProperty(t)){continue}this._groups[t].applyConfiguration(this._config)}},createGroup:function(t,e,i,s){if(!this._groups){this._groups={}}this._groups[t]=BX.Crm.EntityFieldAttributePhaseGroup.create(t,{title:e,configurator:this,isReadOnly:!this._isPermitted,phases:i,phaseGroupTypeId:BX.prop.getInteger(s,"phaseGroupTypeId",BX.Crm.EntityFieldAttributePhaseGroupType.undefined)});return this._groups[t]},hasSelectedGroup:function(){for(var t in this._groups){if(!this._groups.hasOwnProperty(t)){continue}if(this._groups[t].isSelected()){return true}}return false},processGroupChange:function(t){if(!this._isPermitted){this.runLockScript();return}var e=t.getId();if(e==="general"){if(t.isSelected()){this._groups["pipeline"].setSelected(true);this._groups["junk"].setSelected(false)}else if(!this._areMultiTypePhasesEnabled){this._groups["pipeline"].setSelected(false)}}else if(e==="pipeline"){if(!this._areMultiTypePhasesEnabled){this._groups["general"].setSelected(t.isFullySelected()&&!this._groups["junk"].isSelected())}else if(!t.isFullySelected()){this._groups["general"].setSelected(false)}}else if(e==="junk"){if(t.isSelected()&&this._groups["general"].isSelected()){this._groups["general"].setSelected(false)}else if(!t.isSelected()&&this._groups["pipeline"].isFullySelected()&&!this._areMultiTypePhasesEnabled){this._groups["general"].setSelected(true)}}this.setEnabled(this.hasSelectedGroup());if(!this._isChanged){this._isChanged=true}},addClosingListener:function(t){this._closingNotifier.addListener(t)},removeClosingListener:function(t){this._closingNotifier.removeListener(t)},open:function(t){if(this._isOpened){return}this._popup=new BX.PopupWindow(this._id,t,{autoHide:true,draggable:false,closeByEsc:true,offsetLeft:0,offsetTop:0,zIndex:BX.prop.getInteger(this._settings,"zIndex",0),bindOptions:{forceBindPosition:true},content:this.prepareContent(),events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}});this._popup.show()},close:function(){if(!this._isOpened){return}if(this._popup){this._popup.close()}},prepareContent:function(){this._wrapper=BX.create("div",{props:{className:"crm-entity-popup-field-addiction-step"}});var t=BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-container"}});this._wrapper.appendChild(t);for(var e in this._groups){if(!this._groups.hasOwnProperty(e)){continue}var i=this._groups[e];i.setContainer(t);i.layout()}return this._wrapper},onPopupShow:function(){this._isOpened=true;this.applyConfiguration()},onPopupClose:function(){if(this._isPermitted){this.acceptChanges();if(this._switchCheckBox){this._switchCheckBox.checked=this._isEnabled}this.adjust()}if(this._popup){this._popup.destroy()}this._closingNotifier.notify([{config:this._config}])},onPopupDestroy:function(){this._isOpened=false;this._wrapper=null;this._innerWrapper=null;this._popup=null},getButton:function(){if(!this._button){this._button=BX.Crm.EntityFieldAttributeConfigButton.create(this._id,{configurator:this})}return this._button},getSwitchCheckBox:function(){return this._switchCheckBox},setSwitchCheckBox:function(t){if(this._switchCheckBox){BX.unbind(this._switchCheckBox,"click",this._switchCheckBoxHandler)}this._switchCheckBox=t;if(this._switchCheckBox){BX.bind(this._switchCheckBox,"click",this._switchCheckBoxHandler)}},getLabel:function(){return this._label},setLabel:function(t){this._label=t},onSwitchCheckBoxClick:function(t){this.setEnabled(this._switchCheckBox.checked);this.adjust()}};BX.Crm.EntityFieldAttributeConfigurator.create=function(t,e){var i=new BX.Crm.EntityFieldAttributeConfigurator;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityFieldAttributePhaseGroup==="undefined"){BX.Crm.EntityFieldAttributePhaseGroup=function(){this._id="";this._settings=null;this._phases=null;this._phaseGroupTypeId=BX.Crm.EntityFieldAttributePhaseGroupType.undefined;this._title="";this._isReadOnly=false;this._configurator=null;this._container=null;this._phaseCheckBoxes=null};BX.Crm.EntityFieldAttributePhaseGroup.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._phases=BX.prop.getArray(this._settings,"phases",[]);this._phaseGroupTypeId=BX.prop.getInteger(this._settings,"phaseGroupTypeId",BX.Crm.EntityFieldAttributePhaseGroupType.undefined);this._isReadOnly=BX.prop.getBoolean(this._settings,"isReadOnly",false);this._title=BX.prop.getString(this._settings,"title",this._id);this._configurator=BX.prop.get(this._settings,"configurator",null);this._container=BX.prop.getElementNode(this._settings,"container",null)},getId:function(){return this._id},getPhaseGroupTypeId:function(){return this._phaseGroupTypeId},isReadOnly:function(){return this._isReadOnly},isSelected:function(){for(var t=0,e=this._phaseCheckBoxes.length;t<e;t++){if(this._phaseCheckBoxes[t].checked){return true}}return false},isFullySelected:function(){for(var t=0,e=this._phaseCheckBoxes.length;t<e;t++){if(!this._phaseCheckBoxes[t].checked){return false}}return true},setSelected:function(t){t=!!t;for(var e=0,i=this._phaseCheckBoxes.length;e<i;e++){this._phaseCheckBoxes[e].checked=t}},applyConfiguration:function(t){this.setSelected(false);var e=BX.prop.getArray(t,"groups",[]);for(var i=0,s=e.length;i<s;i++){var r=e[i];var n=BX.prop.getArray(r,"items",[]);var o=BX.prop.getInteger(r,"phaseGroupTypeId",BX.Crm.EntityFieldAttributePhaseGroupType.undefined);if(o===BX.Crm.EntityFieldAttributePhaseGroupType.undefined&&n.length>0){o=this._configurator.resolvePhaseGroupType(BX.prop.getString(n[0],"startPhaseId",""))}if(o===BX.Crm.EntityFieldAttributePhaseGroupType.general){if(this._phaseGroupTypeId!==BX.Crm.EntityFieldAttributePhaseGroupType.junk){this.setSelected(true)}}else if(o===this._phaseGroupTypeId&&n.length>0){if(this._phaseGroupTypeId===BX.Crm.EntityFieldAttributePhaseGroupType.pipeline){this.selectPhaseCheckBox(BX.prop.getString(n[0],"startPhaseId",""))}else if(this._phaseGroupTypeId===BX.Crm.EntityFieldAttributePhaseGroupType.junk){for(var p=0,a=n.length;p<a;p++){this.selectPhaseCheckBox(BX.prop.getString(n[p],"startPhaseId",""))}}}}},acceptChanges:function(t){var e,i,s;var r=[];if(this._phaseGroupTypeId===BX.Crm.EntityFieldAttributePhaseGroupType.pipeline){var n=-1;for(e=0,i=this._phaseCheckBoxes.length;e<i;e++){s=this._phaseCheckBoxes[e];if(s.checked){n=e;break}}if(n>=0){r.push({startPhaseId:this._phaseCheckBoxes[n]["id"],finishPhaseId:this._phaseCheckBoxes[this._phaseCheckBoxes.length-1]["id"]})}}else if(this._phaseGroupTypeId===BX.Crm.EntityFieldAttributePhaseGroupType.junk){for(e=0,i=this._phaseCheckBoxes.length;e<i;e++){s=this._phaseCheckBoxes[e];if(!s.checked){continue}r.push({startPhaseId:s["id"],finishPhaseId:s["id"]})}}if(r.length>0){t["groups"].push({phaseGroupTypeId:this._phaseGroupTypeId,items:r})}},getContainer:function(){return this._container},setContainer:function(t){this._container=t},createPhaseCheckBox:function(t){if(!this._phaseCheckBoxes){this._phaseCheckBoxes=[]}var e=BX.create("input",{props:{id:t,type:"checkbox"},events:{click:BX.delegate(this.onCheckBoxClick,this)}});this._phaseCheckBoxes.push(e);return e},findCheckBox:function(t){for(var e=0,i=this._phaseCheckBoxes.length;e<i;e++){var s=this._phaseCheckBoxes[e];if(s["id"]===t){return s}}return null},selectPhaseCheckBox:function(t){var e=this.findCheckBox(t);if(!e){return}e.checked=true;this.processCheckBoxChange(e,false)},layout:function(){if(!this._container){return}this._phaseCheckBoxes=[];if(this._title!==""){this._container.appendChild(BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-title"},children:[BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-title-line"}}),BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-title-text"},text:this._title}),BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-title-line"}})]}))}var t=BX.Crm.EntityPhaseLayout.getCurrent();var e=BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list"}});for(var i=0,s=this._phases.length;i<s;i++){var r=this._phases[i];var n=BX.create("label",{props:{className:"crm-entity-popup-field-addiction-step-item"},children:[this.createPhaseCheckBox(r["id"]),BX.create("span",{props:{className:"crm-entity-popup-field-addiction-step-item-text"},text:r["name"]})]});var o=BX.prop.getString(r,"color","");if(o===""){var p=BX.prop.getString(r,"semantics","");if(p!==""){o=t.getBackgroundColor(p)}}if(o!==""){n.style.backgroundColor=o;n.style.color=t.calculateTextColor(o)}else{BX.addClass(n,"crm-entity-popup-field-addiction-step-item-default")}e.appendChild(n)}this._container.appendChild(e)},onCheckBoxClick:function(t){this.processCheckBoxChange(BX.getEventTarget(t),true)},processCheckBoxChange:function(t,e){if(this._isReadOnly){t.checked=!t.checked}else{if(this._phaseGroupTypeId===BX.Crm.EntityFieldAttributePhaseGroupType.pipeline){var i=false,s=false;for(var r=0,n=this._phaseCheckBoxes.length;r<n;r++){var o=this._phaseCheckBoxes[r];if(!i){i=t===o;if(i){if(s&&!o.checked){o.checked=true}continue}}if(o.checked!==i){o.checked=i;if(!i&&!s){s=true}}}}}if(e){this._configurator.processGroupChange(this)}}};BX.Crm.EntityFieldAttributePhaseGroup.create=function(t,e){var i=new BX.Crm.EntityFieldAttributePhaseGroup;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityFieldAttributeConfigButton==="undefined"){BX.Crm.EntityFieldAttributeConfigButton=function(){this._id="";this._settings=null;this._configurator=null;this._wrapper=null;this._icon=null};BX.Crm.EntityFieldAttributeConfigButton.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._configurator=BX.prop.get(this._settings,"configurator",null)},onClick:function(t){if(this._configurator.isEnabled()){this._configurator.open(this._wrapper)}},adjust:function(){var t=this._configurator.prepareLegendData();if(this._configurator.isEnabled()){BX.removeClass(this._wrapper,"crm-entity-new-field-addiction-step-disabled")}else{BX.addClass(this._wrapper,"crm-entity-new-field-addiction-step-disabled")}this._wrapper.style.backgroundColor=BX.prop.getString(t,"backgroundColor","#CED4DC");this._wrapper.style.color=BX.prop.getString(t,"color","#333");var e=this._wrapper.querySelector("span.crm-entity-new-field-addiction-step-arrow");if(e){e.style.color=BX.prop.getString(t,"color","#333")}var i=this._wrapper.querySelector("span.crm-entity-new-field-addiction-step-name");if(i){i.innerHTML=BX.util.htmlspecialchars(BX.prop.getString(t,"text","..."))}},prepareLayout:function(){var t=this._configurator.prepareLegendData();this._wrapper=BX.create("span",{props:{className:"crm-entity-new-field-addiction-step"},style:{backgroundColor:BX.prop.getString(t,"backgroundColor","#CED4DC"),color:BX.prop.getString(t,"color","#333")},children:[BX.create("span",{props:{className:"crm-entity-new-field-addiction-step-name"},text:BX.prop.getString(t,"text","")}),BX.create("span",{props:{className:"crm-entity-new-field-addiction-step-arrow"},children:[BX.create("span",{props:{className:"crm-entity-new-field-addiction-step-arrow-inner"}})]})]});BX.bind(this._wrapper,"click",BX.delegate(this.onClick,this));return[this._wrapper]}};BX.Crm.EntityFieldAttributeConfigButton.create=function(t,e){var i=new BX.Crm.EntityFieldAttributeConfigButton;i.initialize(t,e);return i}}