(function(e,t,i,s,n){"use strict";var o,r;var a=t.Reflection.namespace("BX.Crm.WhatsNew");var p=function(){function e(i){var s=i.slides,n=i.steps,o=i.options,r=i.closeOptionCategory,a=i.closeOptionName;babelHelpers.classCallCheck(this,e);this.popup=null;this.slides=[];this.steps=[];this.options=o;this.slideClassName="crm-whats-new-slides-wrapper";this.closeOptionCategory=t.Type.isString(r)?r:"";this.closeOptionName=t.Type.isString(a)?a:"";this.onClickClose=this.onClickCloseHandler.bind(this);this.whatNewPromise=null;this.tourPromise=null;this.prepareSlides(s);this.prepareSteps(n)}babelHelpers.createClass(e,[{key:"prepareSlides",value:function e(i){var s=this;if(i.length){this.whatNewPromise=t.Runtime.loadExtension("ui.dialogs.whats-new")}this.slides=i.map((function(e){return{className:s.slideClassName,title:e.title,html:s.getPreparedSlideHtml(e)}}),this)}},{key:"getPreparedSlideHtml",value:function e(i){var s=t.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-whats-new-slide">\n\t\t\t\t<img src="','" alt="">\n\t\t\t\t<div class="crm-whats-new-slide-inner-title"> '," </div>\n\t\t\t\t<p>","</p>\n\t\t\t</div>\n\t\t"])),i.innerImage,i.innerTitle,i.innerDescription);var n=this.getPrepareSlideButtons(i);if(n.length){var a=t.Tag.render(r||(r=babelHelpers.taggedTemplateLiteral(['<div class="crm-whats-new-slide-buttons"></div>'])));t.Dom.append(a,s);n.forEach((function(e){t.Dom.append(e.getContainer(),a)}))}return s}},{key:"getPrepareSlideButtons",value:function e(t){var i=this;var n=[];if(t.buttons){var o="ui-btn ui-btn-primary ui-btn-hover ui-btn-round ";n=t.buttons.map((function(e){var t;var n={className:o+((t=e.className)!==null&&t!==void 0?t:""),text:e.text};if(e.onClickClose){n.onclick=function(){return i.onClickClose()}}else if(e.helpDeskCode){n.onclick=function(){return i.showHelpDesk(e.helpDeskCode)}}return new s.Button(n)}),this)}return n}},{key:"prepareSteps",value:function e(i){var s=this;if(i.length){this.tourPromise=t.Runtime.loadExtension("ui.tour")}this.steps=i.map((function(e){var t={id:e.id,title:e.title,text:e.text,position:e.position,article:e.article};if(e.useDynamicTarget){var i;var o=(i=e.eventName)!==null&&i!==void 0?i:s.getDefaultStepEventName(t.id);n.EventEmitter.subscribeOnce(o,s.showStepByEvent.bind(s))}else{t.target=e.target}return t}),this)}},{key:"showStepByEvent",value:function e(t){var i=this;this.tourPromise.then((function(e){var s=t.data,n=s.stepId,o=s.target,r=s.delay;var a=i.steps.find((function(e){return e.id===n}));if(!a){console.error("step not found");return}setTimeout((function(){a.target=o;var t=e.Guide;var s=i.createGuideInstance(t,[a],true);i.setStepPopupOptions(s.getPopup());s.showNextStep();i.save()}),r||0)}))}},{key:"getDefaultStepEventName",value:function e(t){return"Crm.WhatsNew::onTargetSetted::".concat(t)}},{key:"onClickCloseHandler",value:function e(){var t=this.popup.getLastPosition();var i=this.popup.getPositionBySlide(this.popup.getCurrentSlide());if(i>=t){this.popup.destroy()}else{this.popup.selectNextSlide()}}},{key:"showHelpDesk",value:function e(t){if(top.BX.Helper){top.BX.Helper.show("redirect=detail&code=".concat(t));event.preventDefault()}}},{key:"show",value:function e(){if(this.slides.length){this.executeWhatsNew()}else if(this.steps.length){this.executeGuide()}}},{key:"executeWhatsNew",value:function t(){var s=this;if(i.PopupManager&&i.PopupManager.isAnyPopupShown()){return}this.whatNewPromise.then((function(t){var i=t.WhatsNew;s.popup=new i({slides:s.slides,popupOptions:{height:440},events:{onDestroy:function e(){s.save();s.executeGuide()}}});s.popup.show();e.whatsNewInstances.push(s.popup)}),this)}},{key:"executeGuide",value:function i(){var s=this;var n=t.clone(this.steps);n=n.filter((function(e){return Boolean(e.target)}));if(!n.length){return}this.tourPromise.then((function(t){var i=t.Guide;var o=s.createGuideInstance(i,n,s.steps.length<=1);if(e.tourInstances.find((function(e){var t;return(t=e.getPopup())===null||t===void 0?void 0:t.isShown()}))){return}e.tourInstances.push(o);s.setStepPopupOptions(o.getPopup());if(o.steps.length>1||s.options.showOverlayFromFirstStep){o.start()}else{o.showNextStep()}s.save()}))}},{key:"createGuideInstance",value:function e(t,i,s){var n=this;return new t({onEvents:s,steps:i,events:{onFinish:function e(){if(!n.slides.length){n.save()}}}})}},{key:"setStepPopupOptions",value:function e(t){var i=this.options,s=i.steps,n=i.hideTourOnMissClick,o=n===void 0?false:n;t.setAutoHide(o);if(s&&s.popup){if(s.popup.width){t.setWidth(s.popup.width)}}}},{key:"save",value:function e(){BX.userOptions.save(this.closeOptionCategory,this.closeOptionName,"closed","Y")}}]);return e}();babelHelpers.defineProperty(p,"tourInstances",[]);babelHelpers.defineProperty(p,"whatsNewInstances",[]);a.ActionViewMode=p})(this.window=this.window||{},BX,BX.Main,BX.UI,BX.Event);
//# sourceMappingURL=script.map.js