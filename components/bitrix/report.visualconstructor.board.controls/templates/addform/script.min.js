(function(){"use strict";BX.namespace("BX.Report.VisualConstructor.Board");BX.Report.VisualConstructor.Board.AddFormElementHandler=function(t){BX.Report.VisualConstructor.Field.BaseHandler.apply(this,arguments)};BX.Report.VisualConstructor.Board.AddFormElementHandler.prototype={__proto__:BX.Report.VisualConstructor.Field.BaseHandler.prototype,constructor:BX.Report.VisualConstructor.Board.AddFormElementHandler,process:function(){switch(this.action){case"reloadReportHandlerList":this.reloadReportHandlerList();break;case"onViewTypeSelect":this.onViewTypeSelect();break}},reloadReportHandlerList:function(){},onViewTypeSelect:function(){}};BX.Report.VisualConstructor.Board.AddForm=function(){this.addForm=document.querySelector("#report_visual_constructor_add_form");this.minatureContainers=this.addForm.querySelectorAll('[data-type="miniature-container"]');this.miniatureRemoveButtons=this.addForm.querySelectorAll('[data-role="miniature-remove-button"]');this.boardIdField=this.addForm.querySelector('[data-type="board-id"]');this.showAllButtons=this.addForm.querySelectorAll('[data-type="show-all-button"]');this.createWidgetByButtons=document.querySelectorAll('[data-type="create-widget-by-category"]');this.init()};BX.Report.VisualConstructor.Board.AddForm.prototype={init:function(){for(var t=0;t<this.showAllButtons.length;t++){this.showAllButtons[t].addEventListener("click",this.showAllCategory.bind(this,this.showAllButtons[t]))}for(var e=0;e<this.createWidgetByButtons.length;e++){this.createWidgetByButtons[e].addEventListener("click",this.openCreateWidgetSlider.bind(this,this.createWidgetByButtons[e]))}for(var i=0;i<this.minatureContainers.length;i++){BX.bind(this.minatureContainers[i],"click",this.miniatureContainerClickHandler.bind(this,this.minatureContainers[i]))}for(var r=0;r<this.miniatureRemoveButtons.length;r++){BX.bind(this.miniatureRemoveButtons[r],"click",this.miniatureCloseClickHandler.bind(this,this.miniatureRemoveButtons[r]))}},showAllCategory:function(t){var e=t.getAttribute("data-toggle-button-category-key");var i=this.addForm.querySelector("[data-container-category-key="+e+"]");var r=i.querySelector(".report-visualconstructor-view-miniatures-container");if(i.classList.contains("report-visualconstructor-view-miniatures-wrapper-collapsed")){t.innerHTML=BX.message("REPORT_ADD_FORM_HIDDEN_BUTTON_TITLE");i.classList.remove("report-visualconstructor-view-miniatures-wrapper-collapsed");i.style.height=r.offsetHeight+"px";i.style.transition="height 500ms"}else{t.innerHTML=BX.message("REPORT_ADD_FORM_SHOW_ALL_BUTTON_TITLE");i.classList.add("report-visualconstructor-view-miniatures-wrapper-collapsed");i.style.height="199px";i.style.transition="height 500ms";i.style.overflow="hidden"}},openCreateWidgetSlider:function(t){this.createWidgetPanel=BX.SidePanel.Instance;this.createWidgetPanel.open("widget:create",{cacheable:false,contentCallback:BX.delegate(function e(i){var r=new BX.Promise;BX.Report.VC.Core.ajaxPost("widget.buildForm",{data:{params:{viewType:"linearGraph",widgetId:"pseudo_widget_for_add",boardId:this.getBoardId(),categoryKey:t.getAttribute("data-category-key"),mode:"create"}},onFullSuccess:BX.delegate(function(t){i.getData().set("reportContent",t.data);r.fulfill(t.data)},this)});return r},this),animationDuration:100,width:900,events:{onLoad:function(t){var e=t.getSlider();BX.html(e.layout.content,e.getData().get("reportContent"))},onClose:function(){BX.Report.VC.PopupWindowManager.closeAllPopups()}}})},miniatureContainerClickHandler:function(t,e){var i=t.querySelector("img");var r=e.target.getAttribute("data-role");if(r==="miniature-remove-button"){return}if(e.target!==i){BX.fireEvent(i,"click")}else{BX.Report.VC.Core.ajaxSubmit(this.addForm,{onsuccess:BX.delegate(function(t){BX.onCustomEvent("BX.Report.VisualConstructor.afterWidgetAdd",[t.data])},this)})}},miniatureCloseClickHandler:function(t){var e=t.parentNode;if(this.confirmationPopup){this.confirmationPopup.destroy()}this.confirmationPopup=new BX.PopupWindow("visualconstructor-dashboard-remove-pattern-widget",t,{closeByEsc:true,autoHide:true,zIndex:9999,width:310,angle:true,content:this.getPatternRemoveConfirmDialogContent(),buttons:[new BX.PopupWindowCustomButton({text:BX.message("REPORT_PATTERN_WIDGET_REMOVE_DIALOG_CONFIRM_TEXT"),className:"ui-btn ui-btn-lg ui-btn-primary",events:{click:this.removePatternWidget.bind(this,e)}}),new BX.PopupWindowCustomButton({text:BX.message("REPORT_PATTERN_WIDGET_REMOVE_DIALOG_CANCEL_TEXT"),className:"ui-btn ui-btn-lg ui-btn-link",events:{click:function(){this.confirmationPopup.close()}.bind(this)}})]});this.confirmationPopup.show()},getPatternRemoveConfirmDialogContent:function(){return BX.create("div",{attrs:{className:"report-pattern-widget-remove-confirm-dialog-content-container"},text:BX.message("REPORT_PATTERN_WIDGET_REMOVE_DIALOG_CONTENT")})},removePatternWidget:function(t){if(this.confirmationPopup){this.confirmationPopup.close()}var e=t.getAttribute("data-widget-id");BX.Report.VC.Core.ajaxPost("widget.removePattern",{data:{widgetId:e},onFullSuccess:function(){BX.remove(t)}})},getBoardId:function(){return this.boardIdField.value}};BX.Report.VisualConstructor.Board.ClipText=function(t){this.node=t.node;this.nodeHeight=null;this.text=null;this.wrapper=null};BX.Report.VisualConstructor.Board.ClipText.prototype={getTextNode:function(){this.text=this.node.innerHTML;return this.text},getHeightNode:function(){this.nodeHeight=this.node.offsetHeight;return this.nodeHeight},getHeightWrapper:function(){this.wrapperHeight=this.wrapper.offsetHeight;return this.wrapperHeight},cleanNode:function(){this.node.innerHTML=""},createTextWrapper:function(){this.wrapper=document.createElement("span");this.wrapper.innerHTML=this.getTextNode();this.cleanNode();return this.wrapper},clipText:function(){var t=this.text.length;var e;for(var i=0;i<t;i++){e=this.text.slice(0,-i)}return e},appendClipText:function(){for(var t=this.nodeHeight,e=0;t<=this.getHeightWrapper();e++){e++;this.wrapper.innerHTML=this.text.slice(0,-e)+"..."}},create:function(){this.node.appendChild(this.createTextWrapper());this.getHeightNode()<this.getHeightWrapper()?this.appendClipText():null}};BX.Report.VisualConstructor.Board.ClipText.createFabric=function(t){for(var e=0;e<t.length;e++){var i=new BX.Report.VisualConstructor.Board.ClipText({node:t[e]});i.create()}}})();