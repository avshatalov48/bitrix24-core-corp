if(typeof BX.FilesFieldContainer=="undefined"){BX.CrmQuoteStorageType={undefined:0,file:1,webdav:2,diskfiles:3};BX.CrmQuoteMode={edit:1,view:2};BX.FilesFieldContainer=function(e){this.random=Math.random().toString().substring(2);this.settings=e;this.controlMode=e["controlMode"]==="edit"?BX.CrmQuoteMode.edit:BX.CrmQuoteMode.view;this.container=BX(this.settings["containerId"]);var t=parseInt(this.getSetting("storageTypeId",BX.CrmQuoteStorageType.undefined));if(isNaN(t)||t===BX.CrmQuoteStorageType.undefined){t=this.getDefaultStorageTypeId()}this.storageTypeId=t;var i=this.getSetting("uploaderName","files_field_uploader_"+this.random);this.setSetting("uploaderName",i);if(this.storageTypeId===BX.CrmQuoteStorageType.webdav){this.prepareWebDavUploader(i,this.controlMode,this.getSetting("webdavelements",[]))}else if(this.storageTypeId===BX.CrmQuoteStorageType.diskfiles){this.prepareDiskUploader(i,this.controlMode,this.getSetting("diskfiles",[]))}else{this.prepareFileUploader(i,this.getSetting("files",[]))}};BX.FilesFieldContainer.prototype={getSetting:function(e,t){return typeof this.settings[e]!="undefined"?this.settings[e]:t},setSetting:function(e,t){this.settings[e]=t},getMessage:function(e,t){return typeof this.settings["messages"]!=="undefined"&&this.settings["messages"][e]?this.settings["messages"][e]:t},getDialogElements:function(e){var t=document.forms["form_"+this.settings["formId"]];if(!t||!t.elements[e]){return[]}return t.elements[e]},prepareWebDavUploader:function(e,t,i){e=BX.type.isNotEmptyString(e)?e:"files_field_uploader_"+this.random;var s=typeof BX.CrmWebDavUploader.items[e]!=="undefined"?BX.CrmWebDavUploader.items[e]:null;if(s){s.cleanLayout()}else{s=BX.CrmWebDavUploader.create(e,{urlSelect:this.getSetting("webDavSelectUrl",""),urlUpload:this.getSetting("webDavUploadUrl",""),urlShow:this.getSetting("webDavShowUrl",""),elementInfoLoader:BX.delegate(this.getWebDavElementInfo,this),msg:{loading:this.getMessage("webdavFileLoading","Loading..."),file_exists:this.getMessage("webdavFileAlreadyExists","File already exists!"),access_denied:'<p style="margin-top:0;">'+this.getMessage("webdavFileAccessDenied","Access denied!")+"</p>",title:this.getMessage("webdavTitle","Files"),attachFile:this.getMessage("webdavAttachFile","Attach file"),dragFile:this.getMessage("webdavDragFile","Drag a files to this area"),selectFile:this.getMessage("webdavSelectFile","or select a file in your computer"),selectFromLib:this.getMessage("webdavSelectFromLib","Select from library"),loadFiles:this.getMessage("webdavLoadFiles","Load files")}})}s.setMode(t);s.setValues(i);if(this.container)s.layout(this.container);return this.container},prepareDiskUploader:function(e,t,i){e=BX.type.isNotEmptyString(e)?e:"files_field_uploader_";var s=typeof BX.CrmDiskUploader.items[e]!=="undefined"?BX.CrmDiskUploader.items[e]:null;if(s){s.cleanLayout()}else{s=BX.CrmDiskUploader.create(e,{msg:{diskAttachFiles:this.getMessage("diskAttachFiles"),diskAttachedFiles:this.getMessage("diskAttachedFiles"),diskSelectFile:this.getMessage("diskSelectFile"),diskSelectFileLegend:this.getMessage("diskSelectFileLegend"),diskUploadFile:this.getMessage("diskUploadFile"),diskUploadFileLegend:this.getMessage("diskUploadFileLegend")}})}s.setMode(t);s.setValues(i);if(this.container)s.layout(this.container);return this.container},prepareFileUploader:function(e,t){if(BX.CFileInput.Items[e]){BX.CFileInput.Items[e].setFiles(t)}if(this.container)this.container.style.display="";return this.container},getDefaultStorageTypeId:function(){return parseInt(this.getSetting("defaultStorageTypeId",BX.CrmQuoteStorageType.file))},getWebDavElementInfo:function(e,t){BX.ajax({url:this.getSetting("serviceUrl",""),method:"POST",dataType:"json",data:{ACTION:"GET_WEBDAV_ELEMENT_INFO",ELEMENT_ID:e},onsuccess:function(e){var i=e["DATA"]?e["DATA"]:{};if(BX.type.isFunction(t)){try{t(i["INFO"]?i["INFO"]:{})}catch(e){}}},onfailure:function(e){}})},getWebDavUploaderValues:function(e){var t=[];var i=BX.CrmWebDavUploader.items[e];var s=i?i.getValues():[];for(var r=0;r<s.length;r++){t.push(s[r]["ID"])}return t},getDiskUploaderValues:function(e){var t=BX.CrmDiskUploader.items[e];return t?t.getFileIds():[]},getFileUploaderValues:function(e){var t=[];if(BX.type.isElementNode(e)){t.push(e.value)}else if(BX.type.isArray(e)||typeof e.length!=="undefined"){for(var i=0;i<e.length;i++){t.push(e[i].value)}}return t},onSaveHandler:function(e){var t={};if(this.storageTypeId===BX.CrmQuoteStorageType.webdav){t["webdavelements"]=this.getWebDavUploaderValues(this.getSetting("uploaderName",""))}else if(this.storageTypeId===BX.CrmQuoteStorageType.diskfiles){t["diskfiles"]=this.getDiskUploaderValues(this.getSetting("uploaderName",""))}else{t["files"]=this.getFileUploaderValues(this.getDialogElements(this.getSetting("uploadInputID","")+"[]"));var i=this.getSetting("uploadControlID","");if(typeof BX.CFileInput!=="undefined"&&typeof BX.CFileInput.Items[i]!=="undefined"){t["uploadControlCID"]=BX.CFileInput.Items[i].CID}}if(this.container){var s,r;s=BX.findChildren(this.container,{tag:"input",attr:{type:"hidden"}});if(s instanceof Array&&s.length>0){for(var n in s){r=s[n].name;if(r.match(/^(webdavelements|diskfiles|files|uploadcontrolcid|storagetypeid)(\[\d*\])*/i))BX.remove(s[n])}}if(this.storageTypeId===BX.CrmQuoteStorageType.webdav){s=t["webdavelements"];if(s instanceof Array&&s.length>0){for(var n=0;n<s.length;n++){this.container.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:"webdavelements[]",value:s[n]}}))}}}else if(this.storageTypeId===BX.CrmQuoteStorageType.diskfiles){s=t["diskfiles"];if(s instanceof Array&&s.length>0){for(var n=0;n<s.length;n++){this.container.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:"diskfiles[]",value:s[n]}}))}}}else{s=t["files"];if(s instanceof Array&&s.length>0){for(var n=0;n<s.length;n++){this.container.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:"files[]",value:s[n]}}))}}if(t["uploadControlCID"]){this.container.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:"uploadControlCID",value:t["uploadControlCID"]}}))}}this.container.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:"storageTypeId",value:this.storageTypeId}}))}}}}if(typeof BX.CrmQuoteEditor==="undefined"){BX.CrmQuoteEditor=function(){this._id="";this._settings={};this._formId="";this._formManager=null;this._productRowEditorId="";this._productEditor=null;this._currencyElement=null;this._opportunityElement=null;this._filesFieldContainer=null};BX.CrmQuoteEditor.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(8);this._settings=t?t:{};this._formId=this.getSetting("formId","");var i=BX("form_"+this._formId);this._currencyElement=BX.findChild(i,{tag:"select",attr:{name:"CURRENCY_ID"}},true,false);this._opportunityElement=BX.findChild(i,{tag:"input",attr:{name:"OPPORTUNITY"}},true,false);this._productEditor=BX.CrmProductEditor.getDefault();if(this._opportunityElement){this._opportunityElement.disabled=this._productEditor.getProductCount()>0;BX.addCustomEvent(this._productEditor,"productAdd",BX.delegate(this._handleProductAddRemove,this));BX.addCustomEvent(this._productEditor,"productRemove",BX.delegate(this._handleProductAddRemove,this));BX.addCustomEvent(this._productEditor,"sumTotalChange",BX.delegate(this._handleSumTotalChange,this));if(this._currencyElement){BX.bind(this._currencyElement,"change",BX.delegate(this._handleCurrencyChange,this))}}var s=BX("LOC_CITY_val");if(s){if(BX.hasClass(s,"search-suggest")){BX.removeClass(s,"search-suggest")}BX.addClass(s,"crm-offer-item-inp");s.setAttribute("size","255")}t["filesFieldSettings"]["formId"]=this._formId;this._filesFieldContainer=new BX.FilesFieldContainer(t["filesFieldSettings"]);var r=["saveAndView","saveAndAdd","apply","save","continue"];for(var n=0;n<r.length;n++){var o=this._formId+"_"+r[n];BX.bind(BX(o),"click",BX.delegate(this._onSaveHandler,this._filesFieldContainer))}if(typeof BX.CrmEditFormManager!=="undefined"){this._formManager=BX.CrmEditFormManager.items[(BX.type.isNotEmptyString(this._formId)?this._formId:e).toLowerCase()]}this._productRowEditorId=this.getSetting("productRowEditorId","");if(BX.type.isNotEmptyString(this._productRowEditorId)){BX.addCustomEvent("onProductEditorFocusChange",BX.delegate(this._onProductEditorFocusChange,this))}},_handleProductAddRemove:function(e){if(e&&typeof e==="object"&&e.hasOwnProperty("product")&&this._opportunityElement){var t=e["product"];if(t&&typeof t==="object"&&t.hasOwnProperty("_editor")){var i=t._editor;if(i&&typeof i==="object")this._opportunityElement.disabled=i.getProductCount()>0}}},_handleSumTotalChange:function(e){if(this._opportunityElement){this._opportunityElement.value=e}},_handleCurrencyChange:function(){if(this._currencyElement&&this._productEditor){var e=this._currencyElement.value;var t=this._productEditor.getCurrencyId();this._productEditor.setCurrencyId(e);var i=this._opportunityElement.value.length>0?parseFloat(this._opportunityElement.value):0;if(isNaN(i)){i=0}if(this._productEditor.getProductCount()==0&&i!==0){this._productEditor.convertMoney(parseFloat(this._opportunityElement.value),t,e,BX.delegate(this._callbackAfterProductEditorConvertMoney,this))}}},_callbackAfterProductEditorConvertMoney:function(e){if(this._opportunityElement)this._opportunityElement.value=e},_onSaveHandler:function(e){this.onSaveHandler()},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getId:function(){return this._id},_onProductEditorFocusChange:function(e,t){if(e.getId()!==this._productRowEditorId){return}}};BX.CrmQuoteEditor.items={};BX.CrmQuoteEditor.create=function(e,t){var i=new BX.CrmQuoteEditor;i.initialize(e,t);this.items[i.getId()]=i;return i}}
//# sourceMappingURL=script.map.js