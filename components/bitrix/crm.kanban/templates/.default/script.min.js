BX.namespace("Crm.KanbanComponent");BX.Crm.KanbanComponent.currentPopupItem=null;BX.Crm.KanbanComponent.currentPopup=null;BX.Crm.KanbanComponent.currentData=null;BX.Crm.KanbanComponent.successClosePopup=false;BX.Crm.KanbanComponent.dropConfirmed=false;BX.Crm.KanbanComponent.activePopups={};BX.Crm.KanbanComponent.returnItem=function(e){var t=e.getLastPosition();var n=e.getData();var o=e.getGrid();var r=parseFloat(n.price);n.columnId=t.columnId;n.targetId=t.targetId;this.successClosePopup=true;e.getColumn().decPrice(r);o.getColumn(n.columnId).incPrice(r);o.updateItem(e.getId(),n);o.unhideItem(e)};BX.Crm.KanbanComponent.clearPopup=function(e){var t=BX(e).querySelectorAll("[data-field]");if(t&&t.length>0){for(var n=0,o=t.length;n<o;n++){var r=BX.data(t[n],"default");t[n].value=r?r:""}}};BX.Crm.KanbanComponent.collectFieldsPopup=function(e){var t=BX(e).querySelectorAll("[data-field]");var n={};if(t&&t.length>0){for(var o=0,r=t.length;o<r;o++){var i=BX.data(t[o],"field");if(i){n[i]=t[o].value}}}return n};BX.Crm.KanbanComponent.showPopup=function(e,t,n){if(BX.Crm.KanbanComponent.activePopups[e]){return}this.successClosePopup=false;if(e==="crm_kanban_lead_win"){var o=t.item.getData();var r=BX.findChildren(BX(e),{className:"kanban-converttype"},true,true);for(var i=0,a=r.length;i<a;i++){if(o.return){r[i].style.display=BX.data(r[i],"type")==="deal"?"block":"none"}else{r[i].style.display="block"}}}BX.Crm.KanbanComponent.currentPopupItem=t.item;this.currentPopup=new BX.PopupWindow("kanban_column_popup",window.body,{closeIcon:true,offsetLeft:0,lightShadow:true,overlay:true,titleBar:{content:BX.create("span",{html:""})},draggable:true,contentColor:"white",closeByEsc:true,events:{onPopupClose:function(){if(!this.successClosePopup){this.returnItem(t.item)}BX.Crm.KanbanComponent.activePopups[e]=false;this.dropConfirmed=false}.bind(this)},buttons:[e!=="crm_kanban_lead_win"?new BX.PopupWindowButton({text:BX.data(BX(e),"deletetitle")?BX.data(BX(e),"deletetitle"):BX.message("CRM_KANBAN_POPUP_PARAMS_SAVE"),className:"popup-window-button-accept",events:{click:function(){if(n.toLowerCase()==="column"){var o=t.item.getGrid();o.setAjaxParams(this.collectFieldsPopup(e));o.onItemMoved(t.item,t.targetColumn,t.beforeItem,true);this.successClosePopup=true}else if(n.toLowerCase()==="dropzone"){var r=t.getItem();var o=r.getGrid();var i=t.getDropZone();o.setAjaxParams(this.collectFieldsPopup(e));o.unhideItem(r);i.captureItem(r);this.successClosePopup=true}this.currentPopup.close()}.bind(this)}}):null,new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_POPUP_PARAMS_CANCEL"),className:"popup-window-button-decline",events:{click:function(){this.returnItem(t.item);this.currentPopup.close()}.bind(this)}})]});BX.Crm.KanbanComponent.activePopups[e]=true;this.clearPopup(e);this.currentPopup.setContent(BX(e));this.currentPopup.setTitleBar(BX.data(BX(e),"title"));this.currentPopup.show()};BX.Crm.KanbanComponent.leadConvert=function(e){const t=this.currentData;if(!t||!t.item){return}if(!t.grid||!t.grid.data||!t.grid.data.converterId){console.error("Converter id not found in data",t);return}const n=t.item.getId();this.successClosePopup=true;this.currentPopup.close();const o=BX.Crm.Conversion.Manager.Instance.getConverter(t.grid.data.converterId);if(!o){console.error("Converter with given id not found",t.grid.data.converterId,BX.Crm.Conversion.Manager.Instance);return}o.setAnalyticsElement(BX.Crm.Integration.Analytics.Dictionary.ELEMENT_DRAG_N_DROP);if(e==="SELECT"){const e=BX.Crm.Conversion.Manager.Instance.createEntitySelector(o.getId(),[BX.CrmEntityType.enumeration.contact,BX.CrmEntityType.enumeration.company],n);void e.show()}else{o.convertBySchemeItemId(e,n)}};BX.Crm.KanbanComponent.columnPopup=function(e){var t=e.grid;var n=t.getData();var o=e.item;var r=o.getData();var i=e.targetColumn;var a=i?i.getId():0;BX.Crm.KanbanComponent.currentData=e;if(i&&a!==r.columnId){var s=i.getData();if(s.type==="WIN"&&n.entityType==="LEAD"){BX.Crm.KanbanComponent.showPopup("crm_kanban_lead_win",e,"column");e.skip=true}else if(n.entityType==="INVOICE"){if(s.type==="WIN"){BX.Crm.KanbanComponent.showPopup("crm_kanban_invoice_win",e,"column");e.skip=true}else if(s.type==="LOOSE"){BX.Crm.KanbanComponent.showPopup("crm_kanban_invoice_loose",e,"column");e.skip=true}}}};BX.Crm.KanbanComponent.dropPopup=function(e,t){var n=e.getData();var o=t.getDropZone();var r=o.getData();var i=t.getItem();if(BX.Crm.KanbanComponent.dropConfirmed!==false){return}else{BX.Crm.KanbanComponent.dropConfirmed=true}if(n.entityType==="LEAD"){if(r.type==="WIN"){e.hideItem(i);BX.Crm.KanbanComponent.currentData={grid:e,item:i,targetColumn:null,beforeItem:null};BX.Crm.KanbanComponent.showPopup("crm_kanban_lead_win",t,"dropzone");t.denyAction()}}else if(n.entityType==="INVOICE"){e.hideItem(i);BX.Crm.KanbanComponent.currentData={grid:e,item:i,targetColumn:null,beforeItem:null};if(r.type==="WIN"){BX.Crm.KanbanComponent.showPopup("crm_kanban_invoice_win",t,"dropzone")}else{BX.Crm.KanbanComponent.showPopup("crm_kanban_invoice_loose",t,"dropzone")}t.denyAction()}};BX.Crm.KanbanComponent.onPopupClose=function(e){BX.Crm.KanbanComponent.activePopups[e.uniquePopupId]=false;if(e&&typeof e.uniquePopupId!=="undefined"&&e.uniquePopupId==="CRM-lead_converter-popup"&&BX.Crm.KanbanComponent.currentPopupItem!==null){setTimeout((function(){if(BX.Crm.KanbanComponent.currentPopupItem!==null){BX.Crm.KanbanComponent.returnItem(BX.Crm.KanbanComponent.currentPopupItem)}}),300)}};BX.Crm.KanbanComponent.onSpecialItemDraw=function(e,t){[].slice.call(t.querySelectorAll(".crm-kanban-sidepanel")).forEach((function(t){BX.bind(t,"click",BX.delegate((function(t){var n=e.getGrid().getData();var o=BX.data(this,"url").toString().toLowerCase();if(typeof n.linksPath[o]!=="undefined"){if(["rest_demo","contact_center","marketplace"].includes(o)){e.getGrid().registerAnalyticsSpecialItemLinkClick(e,o)}var r=BX.data(this,"skipslider")||n.linksPath[o].skipslider;if(parseInt(r)==1){window.location.href=n.linksPath[o].url}else{BX.SidePanel.Instance.open(n.linksPath[o].url,n.linksPath[o].params||{})}}t.preventDefault()})))}))};if(typeof BX.Crm.EntityEditorUserSelector==="undefined"&&typeof BX.SocNetLogDestination!=="undefined"){BX.Crm.EntityEditorUserSelector=function(){this._id="";this._settings={}};BX.Crm.EntityEditorUserSelector.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._isInitialized=false},getId:function(){return this._id},open:function(e){if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){return}if(!this._isInitialized){BX.SocNetLogDestination.init({name:this._id,groupCode:"users",extranetUser:false,bindMainPopup:{node:e,offsetTop:"5px",offsetLeft:"15px"},callback:{select:BX.delegate(this.onSelect,this)},showSearchInput:true,departmentSelectDisable:true,items:{users:BX.Crm.EntityEditorUserSelector.users,groups:{},sonetgroups:{},department:BX.Crm.EntityEditorUserSelector.department,departmentRelation:BX.SocNetLogDestination.buildDepartmentRelation(BX.Crm.EntityEditorUserSelector.department)},itemsLast:BX.Crm.EntityEditorUserSelector.last,itemsSelected:{},isCrmFeed:false,useClientDatabase:false,destSort:{},allowAddUser:false,allowSearchCrmEmailUsers:false,allowUserSearch:true});this._isInitialized=true}BX.SocNetLogDestination.openDialog(this._id,{bindNode:e});this._mainWindow=BX.SocNetLogDestination.containerWindow},close:function(){if(this._mainWindow&&this._mainWindow===BX.SocNetLogDestination.containerWindow){BX.SocNetLogDestination.closeDialog();this._mainWindow=null;this._isInitialized=false}},onSelect:function(e,t,n,o){if(t!=="users"){return}var r=BX.prop.getFunction(this._settings,"callback",null);if(r){r(this,e)}}};BX.Crm.EntityEditorUserSelector.items={};BX.Crm.EntityEditorUserSelector.create=function(e,t){var n=new BX.Crm.EntityEditorUserSelector(e,t);n.initialize(e,t);this.items[n.getId()]=n;return n}}
//# sourceMappingURL=script.map.js