{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {Event, Reflection, Type, Uri} from 'main.core';\nimport {EventEmitter} from 'main.core.events'\nimport {Slider} from 'catalog.store-use'\n\nclass ProductStoreGridManager\n{\n\tgrid = null;\n\ttotalWrapper = null;\n\n\tconstructor(settings = {})\n\t{\n\t\tthis.gridId = settings.gridId;\n\t\tthis.grid = BX.Main.gridManager.getInstanceById(this.gridId);\n\t\tthis.signedParameters = settings.signedParameters;\n\t\tthis.totalWrapperId = settings.totalWrapperId || null;\n\t\tthis.inventoryManagementLink = settings.inventoryManagementLink || null;\n\t\tthis.productId = settings.productId;\n\t\tthis.reservedDealsSliderLink = settings.reservedDealsSliderLink;\n\n\t\tif (this.totalWrapperId)\n\t\t{\n\t\t\tthis.totalWrapper = BX(this.totalWrapperId);\n\t\t\tthis.refreshTotalWrapper();\n\t\t}\n\n\t\tthis.subscribeEvents();\n\t\tthis.bindSliderToReservedQuantityNodes();\n\t}\n\n\tsubscribeEvents()\n\t{\n\t\tthis.onGridUpdatedHandler = this.onGridUpdated.bind(this);\n\t\tEventEmitter.subscribe('Grid::updated', this.onGridUpdatedHandler);\n\t}\n\n\tbindSliderToReservedQuantityNodes()\n\t{\n\t\tconst rows = this.grid.getRows().getRows();\n\t\trows.forEach((row) => {\n\t\t\tif (row.isBodyChild() && !row.isTemplate())\n\t\t\t{\n\t\t\t\tconst reservedQuantityNode = row.getNode().querySelector(\n\t\t\t\t\t'.main-grid-cell-content-store-amount-reserved-quantity'\n\t\t\t\t);\n\t\t\t\tif (Type.isDomNode(reservedQuantityNode))\n\t\t\t\t{\n\t\t\t\t\tEvent.bind(\n\t\t\t\t\t\treservedQuantityNode,\n\t\t\t\t\t\t'click',\n\t\t\t\t\t\tthis.openDealsWithReservedProductSlider.bind(this, this.productId, row.getId())\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\topenDealsWithReservedProductSlider(rowId, storeId = 0)\n\t{\n\t\tif (!this.reservedDealsSliderLink)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst sliderLink = new Uri(this.reservedDealsSliderLink);\n\t\tsliderLink.setQueryParam('productId', rowId);\n\t\tif (storeId > 0)\n\t\t{\n\t\t\tsliderLink.setQueryParam('storeId', storeId);\n\t\t}\n\t\tBX.SidePanel.Instance.open(sliderLink.toString(), {\n\t\t\tallowChangeHistory: false,\n\t\t\tcacheable: false\n\t\t});\n\t}\n\n\tonGridUpdated(event: BaseEvent)\n\t{\n\t\tconst [grid, eventArgs] = event.getCompatData();\n\n\t\tif (!grid || grid.getId() !== this.getGridId())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.refreshTotalWrapper();\n\t}\n\n\tgetGridId()\n\t{\n\t\treturn this.gridId;\n\t}\n\n\treloadGrid()\n\t{\n\t\tif (this.grid)\n\t\t{\n\t\t\tthis.grid.reload();\n\t\t}\n\t}\n\n\tsetTotalData(totalData)\n\t{\n\t\tfor (var propertyId in totalData)\n\t\t{\n\t\t\tif (totalData.hasOwnProperty(propertyId))\n\t\t\t{\n\t\t\t\tthis.setTotalDataBySelector(`#${propertyId}`, totalData[propertyId]);\n\t\t\t}\n\t\t}\n\t}\n\n\tsetTotalDataBySelector(selector, data)\n\t{\n\t\tif (this.totalWrapper)\n\t\t{\n\t\t\tvar totalWrapperItem = this.totalWrapper.querySelector(selector);\n\n\t\t\tif (totalWrapperItem)\n\t\t\t{\n\t\t\t\ttotalWrapperItem.innerHTML = data;\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\thideTotalData()\n\t{\n\t\tBX.hide(this.totalWrapper);\n\t}\n\n\tshowTotalData()\n\t{\n\t\tBX.show(this.totalWrapper);\n\t}\n\n\trefreshTotalWrapper()\n\t{\n\t\tif (this.totalWrapper)\n\t\t{\n\t\t\t//this.grid.tableFade();\n\t\t\tBX.ajax.runComponentAction(\n\t\t\t\t'bitrix:catalog.productcard.store.amount',\n\t\t\t\t'getStoreAmountTotal',\n\t\t\t\t{\n\t\t\t\t\tmode: 'ajax',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tsignedParameters: this.signedParameters,\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t).then(response => {\n\t\t\t\tconst amount = response.data.AMOUNT || '';\n\t\t\t\tconst quantity = response.data.QUANTITY || '';\n\t\t\t\tconst quantityReserved = response.data.QUANTITY_RESERVED || '';\n\t\t\t\tconst quantityCommon = response.data.QUANTITY_COMMON || '';\n\n\t\t\t\tif (amount || quantity || quantityCommon || quantityReserved)\n\t\t\t\t{\n\t\t\t\t\tvar totalData = {\n\t\t\t\t\t\t'total_amount': amount,\n\t\t\t\t\t\t'total_quantity': quantity,\n\t\t\t\t\t\t'total_quantity_common': quantityCommon,\n\t\t\t\t\t\t'total_quantity_reserved': quantityReserved,\n\t\t\t\t\t};\n\n\t\t\t\t\tthis.setTotalData(totalData);\n\n\t\t\t\t\tif (BX.isNodeHidden(this.totalWrapper))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.showTotalData();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.hideTotalData();\n\t\t\t\t}\n\t\t\t\t//this.grid.tableUnfade();\n\t\t\t});\n\t\t}\n\t}\n\n\topenInventoryManagementSlider()\n\t{\n\t\tif (this.inventoryManagementLink)\n\t\t{\n\t\t\tnew Slider().open(this.inventoryManagementLink,\n\t\t\t\t{\n\t\t\t\t\tdata: {\n\t\t\t\t\t\topenGridOnDone: false,\n\t\t\t\t\t},\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tonCloseComplete: function(event) {\n\t\t\t\t\t\t\tlet slider = event.getSlider();\n\t\t\t\t\t\t\tif (!slider)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (slider.getData().get('isInventoryManagementEnabled'))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\twindow.top.location.reload();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\t}\n}\n\nReflection.namespace('BX.Catalog').ProductStoreGridManager = ProductStoreGridManager;"],"names":["ProductStoreGridManager","settings","gridId","grid","BX","Main","gridManager","getInstanceById","signedParameters","totalWrapperId","inventoryManagementLink","productId","reservedDealsSliderLink","totalWrapper","refreshTotalWrapper","subscribeEvents","bindSliderToReservedQuantityNodes","onGridUpdatedHandler","onGridUpdated","bind","EventEmitter","subscribe","rows","getRows","forEach","row","isBodyChild","isTemplate","reservedQuantityNode","getNode","querySelector","Type","isDomNode","Event","openDealsWithReservedProductSlider","getId","rowId","storeId","sliderLink","Uri","setQueryParam","SidePanel","Instance","open","toString","allowChangeHistory","cacheable","event","getCompatData","eventArgs","getGridId","reload","totalData","propertyId","hasOwnProperty","setTotalDataBySelector","selector","data","totalWrapperItem","innerHTML","hide","show","ajax","runComponentAction","mode","then","response","amount","AMOUNT","quantity","QUANTITY","quantityReserved","QUANTITY_RESERVED","quantityCommon","QUANTITY_COMMON","setTotalData","isNodeHidden","showTotalData","hideTotalData","Slider","openGridOnDone","events","onCloseComplete","slider","getSlider","getData","get","window","top","location","Reflection","namespace"],"mappings":"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"}