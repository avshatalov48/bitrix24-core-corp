(function(){BX.namespace("BX.Sender.Segment");if(BX.Sender.Segment.Selector){return}var t=BX.Sender.Helper;function e(t){this.init(t)}e.prototype.init=function(e){this.manager=e.manager;this.id=e.id;this.pathToAdd=e.pathToAdd;this.pathToEdit=e.pathToEdit;this.context=BX(e.containerId);this.actionUri=e.actionUri;this.include=e.include;this.messageCode=e.messageCode;this.mess=e.mess||{searchTitle:""};this.popupContent=t.getNode("popup-content",this.context);this.ajaxAction=new BX.AjaxAction(this.actionUri);this.initSelector();t.hint.init(this.context)};e.prototype.initSelector=function(){this.selector=BX.Sender.UI.TileSelector.getById(this.id);if(!this.selector){throw new Error("Tile selector `"+this.id+"` not found.")}BX.addCustomEvent(this.selector,this.selector.events.buttonSelect,this.onButtonSelect.bind(this));BX.addCustomEvent(this.selector,this.selector.events.buttonSelectFirst,this.onButtonSelectFirst.bind(this));BX.addCustomEvent(this.selector,this.selector.events.buttonAdd,this.onButtonAdd.bind(this));BX.addCustomEvent(this.selector,this.selector.events.tileClick,this.onTileClick.bind(this));BX.addCustomEvent(this.selector,this.selector.events.tileRemove,this.fireChangeCount.bind(this));BX.addCustomEvent(this.selector,this.selector.events.tileEdit,this.fireChangeCount.bind(this));BX.addCustomEvent(this.selector,this.selector.events.tileAdd,this.fireChangeCount.bind(this));BX.addCustomEvent(this.selector,this.selector.events.input,this.onInput.bind(this));BX.addCustomEvent(this.selector,this.selector.events.search,this.onSearch.bind(this))};e.prototype.onButtonSelect=function(){this.selector.showSearcher(this.mess.searchTitle)};e.prototype.onButtonSelectFirst=function(){var t=this.selector;this.ajaxAction.request({action:"getSegments",onsuccess:function(e){t.setSearcherData(e.list||[])},onfailure:t.hideSearcher.bind(t),data:{include:this.include?"Y":"N",messageCode:this.messageCode}})};e.prototype.onButtonAdd=function(){this.manager.currentAddSelector=this;BX.Sender.Page.open(BX.util.add_url_param(this.pathToAdd,{hidden:"Y"}))};e.prototype.onTileClick=function(t){BX.Sender.Page.open(this.pathToEdit.replace("#id#",t.id))};e.prototype.onInput=function(t){};e.prototype.onSearch=function(t){};e.prototype.getCount=function(t){return this.selector.getTilesData().reduce(function(e,i){return e+(i&&i.count&&i.count[t]?parseInt(i.count[t]):0)},0)};e.prototype.getDuration=function(){return this.selector.getTilesData().reduce(function(t,e){return t+(e&&e.duration?parseInt(e.duration):0)},0)};e.prototype.fireChangeCount=function(){this.fire("change-count")};e.prototype.fire=function(t,e){e=e||{};BX.onCustomEvent(this,t,e)};e.prototype.actualizeTiles=function(t,e){var i=this.selector.getTile(t.id);if(i){this.selector.updateTile(i,t.name,t.data,t.bgcolor,t.color)}else if(e){this.selector.addTile(t.name,t.data,t.id,t.bgcolor,t.color)}};e.prototype.actualize=function(t,e){this.selector.clearSearcher();this.actualizeTiles(t,e)};function i(t){this.init(t)}i.prototype.classNameExcludeBtnActive="sender-segment-selector-link-active";i.prototype.init=function(e){this.id=e.id;this.pathToAdd=e.pathToAdd;this.pathToEdit=e.pathToEdit;this.context=BX(e.containerId);this.actionUri=e.actionUri;this.messageCode=e.messageCode;this.recipientCount=e.recipientCount;this.recipientTypes=e.recipientTypes||[];this.mess=e.mess;this.duration=e.duration||{};this.duration.node=t.getNode("duration",this.context);this.duration.nodeText=t.getNode("duration-text",this.duration.node);this.counter=t.getNode("counter",this.context);this.excludeAddButton=t.getNode("exclude-add-button",this.context);this.excludeRemoveButton=t.getNode("exclude-remove-button",this.context);this.excludeContainer=t.getNode("exclude-container",this.context);this.ajaxAction=new BX.AjaxAction(this.actionUri);this.initSelectors(e);this.initExcludeButtons();if(this.recipientCount===null){this.calculate()}top.BX.addCustomEvent(top,"sender-segment-edit-change",this.onSegmentChange.bind(this));if(BX.Sender.Template&&BX.Sender.Template.Selector){var i=BX.Sender.Template.Selector;BX.addCustomEvent(i,i.events.templateSelect,this.onTemplateSelect.bind(this))}};i.prototype.onTemplateSelect=function(t){if(!t.segments||t.segments.length===0){return}this.selectorInclude.selector.removeTiles();t.segments.forEach(function(t){this.selectorInclude.selector.addTile(t.name,t.data,t.id)},this)};i.prototype.onSegmentChange=function(t){var e=this.currentAddSelector;var i=e===this.selectorInclude;this.selectorInclude.actualize(t,i&&e);this.selectorExclude.actualize(t,!i&&e);this.currentAddSelector=null};i.prototype.initExcludeButtons=function(){BX.bind(this.excludeAddButton,"click",this.onExcludeAddButtonClick.bind(this));BX.bind(this.excludeRemoveButton,"click",this.onExcludeRemoveButtonClick.bind(this))};i.prototype.onExcludeAddButtonClick=function(){t.display.change(this.excludeContainer,true);t.changeClass(this.excludeAddButton,this.classNameExcludeBtnActive,false)};i.prototype.onExcludeRemoveButtonClick=function(){t.display.change(this.excludeContainer,false);t.changeClass(this.excludeAddButton,this.classNameExcludeBtnActive,true);this.selectorExclude.selector.removeTiles()};i.prototype.initSelectors=function(t){this.currentAddSelector=null;var i=BX.clone(t);i.manager=this;i.include=true;i.id="segment-include";this.selectorInclude=new e(i);BX.addCustomEvent(this.selectorInclude,"change-count",this.calculate.bind(this));var n=BX.clone(t);n.manager=this;n.include=false;n.id="segment-exclude";this.selectorExclude=new e(n)};i.prototype.calculate=function(){this.calculateCount();this.calculateDuration()};i.prototype.calculateCount=function(){var e=this.recipientTypes.map(function(t){return this.selectorInclude.getCount(t)},this).reduce(function(t,e){return t+e},0);t.animate.numbers(this.counter,e)};i.prototype.calculateDuration=function(){var e=this.duration.minimalInterval;var i=this.duration.maximalInterval;var n=this.duration.warnInterval;var o;var s=this.selectorInclude.getDuration();if(s<e){o=this.duration.formattedMinimalInterval}else if(s>i){o=this.duration.formattedMaximalInterval}else{s=Math.round(s/e)*e;var c=new Date(Date.now()-s*1e3);o=BX.date.format("Hdiff",c)}this.duration.nodeText.textContent=o;t.changeClass(this.duration.node,"sender-segment-selector-duration-active",true);t.changeClass(this.duration.nodeText,"sender-segment-selector-duration-warn",s>n)};BX.Sender.Segment.SelectorManager=i})(window);