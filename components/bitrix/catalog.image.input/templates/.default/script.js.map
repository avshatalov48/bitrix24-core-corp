{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {ajax, Dom, Event, Reflection, Runtime, Tag, Text, Type} from 'main.core';\nimport {type BaseEvent, EventEmitter} from 'main.core.events';\nimport {Loader} from 'main.loader';\n\nclass ImageInput\n{\n\tonUploaderIsInitedHandler = this.handleOnUploaderIsInited.bind(this);\n\n\tvalues = new Map();\n\n\tconstructor(id, options = {})\n\t{\n\t\tthis.id = id;\n\t\tthis.wrapper = BX(id);\n\t\tthis.productId = options.productId;\n\t\tthis.skuId = options.skuId;\n\t\tthis.iblockId = options.iblockId;\n\t\tthis.saveable = options.saveable;\n\t\tthis.inputId = options.inputId;\n\n\t\tif (Type.isObject(options.values))\n\t\t{\n\t\t\tfor (const key in options.values)\n\t\t\t{\n\t\t\t\tif (!options.values.hasOwnProperty(key))\n\t\t\t\t{\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tthis.values.set(key, options.values[key]);\n\t\t\t}\n\t\t}\n\n\t\tif (this.isSaveable())\n\t\t{\n\t\t\tEventEmitter.subscribe('onUploaderIsInited', this.onUploaderIsInitedHandler);\n\t\t}\n\t}\n\n\tisSaveable()\n\t{\n\t\treturn (this.saveable === true);\n\t}\n\n\thandleOnUploaderIsInited(event)\n\t{\n\t\tconst [id, uploader] = event.getCompatData();\n\t\tif (Type.isStringFilled(this.inputId) && this.inputId === id)\n\t\t{\n\t\t\tthis.uploaderFieldMap = new Map();\n\t\t\tEventEmitter.subscribe(uploader, 'onFileIsDeleted', this.onFileDelete.bind(this));\n\t\t\tEventEmitter.subscribe(uploader, 'onFileIsUploaded', this.onFileUpload.bind(this));\n\t\t\tEventEmitter.subscribe(uploader, 'onQueueIsChanged', this.onQueueIsChanged.bind(this));\n\t\t}\n\t}\n\n\tunsubscribeEvents()\n\t{\n\t\tif (this.isSaveable())\n\t\t{\n\t\t\tEventEmitter.unsubscribe('onUploaderIsInited', this.onUploaderIsInitedHandler);\n\t\t}\n\t}\n\n\tunsubscribeImageInputEvents()\n\t{\n\t\tif (Reflection.getClass('BX.UI.ImageInput'))\n\t\t{\n\t\t\tconst imageInput = BX.UI.ImageInput.getById(this.inputId);\n\t\t\tif (imageInput)\n\t\t\t{\n\t\t\t\timageInput.unsubscribeEvents();\n\t\t\t}\n\t\t}\n\t}\n\n\tgetId()\n\t{\n\t\treturn this.id;\n\t}\n\n\tsetId(id)\n\t{\n\t\tthis.id = id;\n\t}\n\n\tonFileDelete(event: BaseEvent)\n\t{\n\t\tconst [, , , file] = event.getCompatData();\n\t\tconst inputName = file.input_name;\n\n\t\tif (Type.isNil(inputName))\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tthis.values.delete(inputName);\n\t\tif (this.isSaveable())\n\t\t{\n\t\t\tthis.save();\n\t\t}\n\t}\n\n\tonQueueIsChanged(event: BaseEvent)\n\t{\n\t\tconst [, type, itemId, uploaderItem] = event.getCompatData();\n\t\tconst image = uploaderItem.file;\n\n\t\tif (\n\t\t\ttype === 'add'\n\t\t\t&& 'input_name' in image\n\t\t\t&& Type.isNil(this.uploaderFieldMap.get(itemId))\n\t\t)\n\t\t{\n\t\t\tthis.uploaderFieldMap.set(itemId, image['input_name']);\n\t\t}\n\t}\n\n\tonFileUpload(event: BaseEvent)\n\t{\n\t\tconst [itemId, , params] = event.getCompatData();\n\n\t\tif (\n\t\t\t!this.isSaveable()\n\t\t\t|| !Type.isObject(params)\n\t\t\t|| !('file' in params)\n\t\t\t|| !('files' in params.file)\n\t\t\t|| !('default' in params.file.files)\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst currentUploadedFile = params['file']['files']['default'];\n\t\tconst photoItem = {\n\t\t\tfileId: itemId,\n\t\t\tdata: {\n\t\t\t\tname: currentUploadedFile.name,\n\t\t\t\ttype: currentUploadedFile.type,\n\t\t\t\ttmp_name: currentUploadedFile.path,\n\t\t\t\tsize: currentUploadedFile.size,\n\t\t\t\terror: null\n\t\t\t}\n\t\t};\n\t\tconst fileFieldName = this.uploaderFieldMap.get(itemId) || itemId;\n\t\tthis.values.set(fileFieldName, photoItem);\n\n\t\tif (this.isSaveable())\n\t\t{\n\t\t\tthis.save();\n\t\t}\n\t}\n\n\tsave()\n\t{\n\t\tif (this.submitFileTimeOut)\n\t\t{\n\t\t\tclearTimeout(this.submitFileTimeOut);\n\t\t}\n\n\t\tconst values = {};\n\t\tthis.values.forEach((file, id) => {\n\t\t\tvalues[id] = file;\n\t\t});\n\n\t\tconst requestId = Text.getRandom(20);\n\t\tthis.refreshImageSelectorId = requestId;\n\t\tthis.submitFileTimeOut = setTimeout(() => {\n\t\t\tajax.runAction(\n\t\t\t\t'catalog.productSelector.saveMorePhoto',\n\t\t\t\t{\n\t\t\t\t\tjson: {\n\t\t\t\t\t\tproductId: this.productId,\n\t\t\t\t\t\tvariationId: this.skuId,\n\t\t\t\t\t\tiblockId: this.iblockId,\n\t\t\t\t\t\timageValues: values,\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t).then((response) => {\n\t\t\t\tif (!this.refreshImageSelectorId === requestId)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tRuntime.html(this.wrapper, response.data.input);\n\t\t\t\tEventEmitter.emit( 'Catalog.ImageInput::save', [\n\t\t\t\t\tthis.id,\n\t\t\t\t\tthis.inputId,\n\t\t\t\t\tresponse,\n\t\t\t\t]);\n\t\t\t});\n\t\t}, 500);\n\t}\n}\n\nReflection.namespace('BX.Catalog').ImageInput = ImageInput;"],"names":["ImageInput","id","options","handleOnUploaderIsInited","bind","Map","wrapper","BX","productId","skuId","iblockId","saveable","inputId","Type","isObject","values","key","hasOwnProperty","set","isSaveable","EventEmitter","subscribe","onUploaderIsInitedHandler","event","getCompatData","uploader","isStringFilled","uploaderFieldMap","onFileDelete","onFileUpload","onQueueIsChanged","unsubscribe","Reflection","getClass","imageInput","UI","getById","unsubscribeEvents","file","inputName","input_name","isNil","delete","save","type","itemId","uploaderItem","image","get","params","files","currentUploadedFile","photoItem","fileId","data","name","tmp_name","path","size","error","fileFieldName","submitFileTimeOut","clearTimeout","forEach","requestId","Text","getRandom","refreshImageSelectorId","setTimeout","ajax","runAction","json","variationId","imageValues","then","response","Runtime","html","input","emit","namespace"],"mappings":"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"}