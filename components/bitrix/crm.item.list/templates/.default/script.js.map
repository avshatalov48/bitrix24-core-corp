{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { ajax as Ajax, Loc, Reflection, Text, Type } from \"main.core\";\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { MessageBox, MessageBoxButtons } from \"ui.dialogs.messagebox\";\nimport { Router } from \"crm.router\";\n\nconst namespace = Reflection.namespace('BX.Crm');\n\nlet instance;\n\nclass ItemListComponent\n{\n\tentityTypeId: number;\n\tcategoryId: number;\n\tgridId: string;\n\tgrid: BX.Main.grid;\n\terrorTextContainer: Element;\n\titemCreateUrl: ?string;\n\n\tconstructor(params): void\n\t{\n\t\tif(Type.isPlainObject(params))\n\t\t{\n\t\t\tthis.entityTypeId = Text.toInteger(params.entityTypeId);\n\t\t\tthis.categoryId = Text.toInteger(params.categoryId);\n\n\t\t\tif (Type.isString(params.gridId))\n\t\t\t{\n\t\t\t\tthis.gridId = params.gridId;\n\t\t\t}\n\t\t\tif(this.gridId && BX.Main.grid && BX.Main.gridManager)\n\t\t\t{\n\t\t\t\tthis.grid = BX.Main.gridManager.getInstanceById(this.gridId);\n\t\t\t}\n\t\t\tif (Type.isElementNode(params.errorTextContainer))\n\t\t\t{\n\t\t\t\tthis.errorTextContainer = params.errorTextContainer;\n\t\t\t}\n\t\t\tthis.itemCreateUrl = params.itemCreateUrl;\n\t\t}\n\n\t\tinstance = this;\n\t}\n\n\tinit(): void\n\t{\n\t\tthis.bindEvents();\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('BX.Crm.ItemListComponent:onClickDelete', this.handleItemDelete.bind(this));\n\n\t\tconst toolbarComponent = Reflection.getClass('BX.Crm.ToolbarComponent')\n\t\t\t? Reflection.getClass('BX.Crm.ToolbarComponent').Instance\n\t\t\t: null;\n\n\t\tif (toolbarComponent)\n\t\t{\n\t\t\ttoolbarComponent.subscribeTypeUpdatedEvent(() => {\n\n\t\t\t\tconst newUrl = Router.Instance.getItemListUrl(this.entityTypeId, this.categoryId);\n\t\t\t\tif (newUrl)\n\t\t\t\t{\n\t\t\t\t\twindow.location.href = newUrl;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\twindow.location.reload();\n\t\t\t});\n\t\t\tif (this.grid)\n\t\t\t{\n\t\t\t\ttoolbarComponent.subscribeCategoriesUpdatedEvent(() => {\n\t\t\t\t\tthis.grid.reload();\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\tshowErrors(errors: []): void\n\t{\n\t\tlet text = '';\n\t\terrors.forEach((message) => {\n\t\t\ttext = text + message + ' ';\n\t\t});\n\n\t\tif (Type.isElementNode(this.errorTextContainer))\n\t\t{\n\t\t\tthis.errorTextContainer.innerText = text;\n\t\t\tthis.errorTextContainer.parentElement.style.display = 'block';\n\t\t}\n\t\telse\n\t\t{\n\t\t\tconsole.error(text);\n\t\t}\n\t}\n\n\thideErrors(): void\n\t{\n\t\tif (Type.isElementNode(this.errorTextContainer))\n\t\t{\n\t\t\tthis.errorTextContainer.innerText = '';\n\t\t\tthis.errorTextContainer.parentElement.style.display = 'none';\n\t\t}\n\t}\n\n\tshowErrorsFromResponse({errors}): void\n\t{\n\t\tconst messages = [];\n\t\terrors.forEach(({message}) => messages.push(message));\n\t\tthis.showErrors(messages);\n\t}\n\n\t// region EventHandlers\n\thandleItemDelete(event: BaseEvent): void\n\t{\n\t\tconst entityTypeId = Text.toInteger(event.data.entityTypeId);\n\t\tconst id = Text.toInteger(event.data.id);\n\n\t\tif (!entityTypeId)\n\t\t{\n\t\t\tthis.showErrors([Loc.getMessage('CRM_TYPE_TYPE_NOT_FOUND')]);\n\t\t\treturn;\n\t\t}\n\t\tif (!id)\n\t\t{\n\t\t\tthis.showErrors([Loc.getMessage('CRM_TYPE_ITEM_NOT_FOUND')]);\n\t\t\treturn;\n\t\t}\n\n\t\tMessageBox.show({\n\t\t\ttitle: Loc.getMessage('CRM_TYPE_ITEM_DELETE_CONFIRMATION_TITLE'),\n\t\t\tmessage: Loc.getMessage('CRM_TYPE_ITEM_DELETE_CONFIRMATION_MESSAGE'),\n\t\t\tmodal: true,\n\t\t\tbuttons: MessageBoxButtons.YES_CANCEL,\n\t\t\tonYes: (messageBox) => {\n\t\t\t\tAjax.runAction(\n\t\t\t\t\t'crm.controller.item.delete', {\n\t\t\t\t\t\tanalyticsLabel: 'crmItemListDeleteItem',\n\t\t\t\t\t\tdata:\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tentityTypeId,\n\t\t\t\t\t\t\t\tid,\n\t\t\t\t\t\t\t}\n\t\t\t\t}).then(() => {\n\t\t\t\t\tthis.grid.reloadTable();\n\t\t\t\t}).catch(this.showErrorsFromResponse.bind(this));\n\n\t\t\t\tmessageBox.close();\n\t\t\t}\n\t\t});\n\t}\n\t//endregion\n\n\tstatic handleAddButtonClick()\n\t{\n\t\tif (instance && instance.itemCreateUrl)\n\t\t{\n\t\t\tRouter.openSlider(instance.itemCreateUrl).then(() => {\n\t\t\t\tif (instance.grid)\n\t\t\t\t{\n\t\t\t\t\tinstance.grid.reload();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n}\n\nnamespace.ItemListComponent = ItemListComponent;\n"],"names":["namespace","Reflection","instance","ItemListComponent","params","Type","isPlainObject","entityTypeId","Text","toInteger","categoryId","isString","gridId","BX","Main","grid","gridManager","getInstanceById","isElementNode","errorTextContainer","itemCreateUrl","bindEvents","EventEmitter","subscribe","handleItemDelete","bind","toolbarComponent","getClass","Instance","subscribeTypeUpdatedEvent","newUrl","Router","getItemListUrl","window","location","href","reload","subscribeCategoriesUpdatedEvent","errors","text","forEach","message","innerText","parentElement","style","display","console","error","messages","push","showErrors","event","data","id","Loc","getMessage","MessageBox","show","title","modal","buttons","MessageBoxButtons","YES_CANCEL","onYes","messageBox","Ajax","runAction","analyticsLabel","then","reloadTable","catch","showErrorsFromResponse","close","openSlider"],"mappings":"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"}