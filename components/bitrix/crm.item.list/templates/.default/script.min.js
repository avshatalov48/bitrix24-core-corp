(function(e,t,r,i,n,o,s){"use strict";function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach((function(t){babelHelpers.defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function d(e,t){u(e,t);t.add(e)}function c(e,t,r){u(e,t);t.set(e,r)}function u(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function p(e,t,r){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return r}var h=n.Reflection.namespace("BX.Crm");var f=new WeakMap;var m=new WeakMap;var g=new WeakMap;var E=new WeakSet;var T=new WeakSet;var y=new WeakSet;var v=function(){function e(t){var r=this;babelHelpers.classCallCheck(this,e);d(this,y);d(this,T);d(this,E);c(this,f,{writable:true,value:false});c(this,m,{writable:true,value:false});c(this,g,{writable:true,value:void 0});this.exportPopups={};if(n.Type.isPlainObject(t)){this.entityTypeId=n.Text.toInteger(t.entityTypeId);this.entityTypeName=t.entityTypeName;this.categoryId=n.Text.toInteger(t.categoryId);if(n.Type.isString(t.gridId)){this.gridId=t.gridId}this.progressBarContainerId=String(t.progressBarContainerId);if(this.gridId&&BX.Main.grid&&BX.Main.gridManager){this.grid=BX.Main.gridManager.getInstanceById(this.gridId);if(this.grid&&t.backendUrl){BX.addCustomEvent(window,"Grid::beforeRequest",(function(e,i){if(!e.parent||e.parent!==r.grid){return}var o=new n.Uri(i.url);var s=new n.Uri(t.backendUrl);if(o.getPath()!==s.getPath()){o.setPath(s.getPath());o.setQueryParams(l(l({},o.getQueryParams()),s.getQueryParams()))}i.url=o.toString()}))}}if(n.Type.isElementNode(t.errorTextContainer)){this.errorTextContainer=t.errorTextContainer}if(n.Type.isBoolean(t.isIframe)){babelHelpers.classPrivateFieldSet(this,f,t.isIframe)}if(n.Type.isBoolean(t.isEmbedded)){babelHelpers.classPrivateFieldSet(this,m,t.isEmbedded)}if(n.Type.isPlainObject(t.settingsButtonExtenderParams)){babelHelpers.classPrivateFieldSet(this,g,t.settingsButtonExtenderParams)}}this.reloadGridTimeoutId=0}babelHelpers.createClass(e,[{key:"init",value:function e(){this.bindEvents();p(this,T,I).call(this);p(this,y,C).call(this)}},{key:"bindEvents",value:function e(){var t=this;o.EventEmitter.subscribe("BX.Crm.ItemListComponent:onClickDelete",this.handleItemDelete.bind(this));o.EventEmitter.subscribe("BX.Crm.ItemListComponent:onStartExportCsv",(function(e){t.handleStartExport(e,"csv")}));o.EventEmitter.subscribe("BX.Crm.ItemListComponent:onStartExportExcel",(function(e){t.handleStartExport(e,"excel")}));var i=p(this,E,b).call(this);if(i){i.subscribeTypeUpdatedEvent((function(){var e=r.Router.Instance.getItemListUrl(t.entityTypeId,t.categoryId);if(e){window.location.href=e;return}window.location.reload()}));if(this.grid){i.subscribeCategoriesUpdatedEvent((function(){t.reloadGridAfterTimeout()}))}}o.EventEmitter.subscribe("Crm.EntityConverter.Converted",(function(e){var r=e.data;if(!n.Type.isArray(r)||!r[1]){return}var i=r[1];if(!t.entityTypeName||!i.entityTypeName){return}t.reloadGridAfterTimeout()}));BX.Crm.EntityEvent.subscribeToEntityType(this.entityTypeId,(function(){return t.reloadGridAfterTimeout()}));var s=document.querySelector('[data-role="add-new-item-button-'+this.gridId+'"]');if(s){var a=s.href;s.href="javascript: void(0);";n.Event.bind(s,"click",(function(e){e.preventDefault();e.stopPropagation();o.EventEmitter.emit("BX.Crm.ItemListComponent:onAddNewItemButtonClick",{detailUrl:a,entityTypeId:t.entityTypeId})}))}}},{key:"reloadGridAfterTimeout",value:function e(){var t=this;if(!this.grid){return}if(this.reloadGridTimeoutId>0){clearTimeout(this.reloadGridTimeoutId);this.reloadGridTimeoutId=0}this.reloadGridTimeoutId=setTimeout((function(){t.grid.reload()}),1e3)}},{key:"showErrors",value:function e(t){var r="";t.forEach((function(e){r=r+e+" "}));if(n.Type.isElementNode(this.errorTextContainer)){this.errorTextContainer.innerText=r;this.errorTextContainer.parentElement.style.display="block"}else{console.error(r)}}},{key:"hideErrors",value:function e(){if(n.Type.isElementNode(this.errorTextContainer)){this.errorTextContainer.innerText="";this.errorTextContainer.parentElement.style.display="none"}}},{key:"showErrorsFromResponse",value:function e(t){var r=t.errors;var i=[];r.forEach((function(e){var t=e.message;return i.push(t)}));this.showErrors(i)}},{key:"handleItemDelete",value:function e(t){var r=this;var i=n.Text.toInteger(t.data.entityTypeId);var o=n.Text.toInteger(t.data.id);if(!i){this.showErrors([n.Loc.getMessage("CRM_TYPE_TYPE_NOT_FOUND")]);return}if(!o){this.showErrors([n.Loc.getMessage("CRM_TYPE_ITEM_NOT_FOUND")]);return}s.MessageBox.show({title:n.Loc.getMessage("CRM_TYPE_ITEM_DELETE_CONFIRMATION_TITLE"),message:n.Loc.getMessage("CRM_TYPE_ITEM_DELETE_CONFIRMATION_MESSAGE"),modal:true,buttons:s.MessageBoxButtons.YES_CANCEL,onYes:function e(t){n.ajax.runAction("crm.controller.item.delete",{analyticsLabel:"crmItemListDeleteItem",data:{entityTypeId:i,id:o}}).then((function(){BX.UI.Notification.Center.notify({content:n.Loc.getMessage("CRM_TYPE_ITEM_DELETE_NOTIFICATION")});r.reloadGridAfterTimeout()}))["catch"](r.showErrorsFromResponse.bind(r));t.close()}})}},{key:"handleStartExport",value:function e(t,r){this.getExportPopup(r).then((function(e){return e.showDialog()}))}},{key:"getExportPopup",value:function e(t){var r=this;if(this.exportPopups[t]){return Promise.resolve(this.exportPopups[t])}return n.Runtime.loadExtension("ui.stepprocessing").then((function(e){r.exportPopups[t]=e.ProcessManager.create({id:"crm.item.list.export."+t,controller:"bitrix:crm.api.itemExport",queue:[{action:"dispatcher"}],params:{SITE_ID:n.Loc.getMessage("SITE_ID"),entityTypeId:r.entityTypeId,categoryId:r.categoryId,EXPORT_TYPE:t,COMPONENT_NAME:"bitrix:crm.item.list"},messages:{DialogTitle:n.Loc.getMessage("CRM_ITEM_EXPORT_"+t.toUpperCase()+"_TITLE"),DialogSummary:n.Loc.getMessage("CRM_ITEM_EXPORT_"+t.toUpperCase()+"_SUMMARY")},dialogMaxWidth:"650"});r.exportPopups[t].setHandler(BX.UI.StepProcessing.ProcessCallback.StepCompleted,function(e){return function(){delete r.exportPopups[e]}}(t));return r.exportPopups[t]}))}}]);return e}();function b(){var e=n.Reflection.getClass("BX.Crm.ToolbarComponent");return e?e.Instance:null}function I(){var e;if(babelHelpers.classPrivateFieldGet(this,f)||babelHelpers.classPrivateFieldGet(this,m)||!babelHelpers.classPrivateFieldGet(this,g)){return}var t=p(this,E,b).call(this);if(!t){console.error("BX.Crm.ToolbarComponent not found");return}var r=(e=t.getSettingsButton())===null||e===void 0?void 0:e.getMenuWindow();if(r){babelHelpers.classPrivateFieldGet(this,g).grid=this.grid;babelHelpers.classPrivateFieldGet(this,g).rootMenu=r;new i.SettingsButtonExtender(babelHelpers.classPrivateFieldGet(this,g))}}function C(){t.init({gridId:this.gridId,progressBarContainerId:this.progressBarContainerId})}h.ItemListComponent=v})(this.window=this.window||{},BX.Crm.EntityList.Panel,BX.Crm,BX.Crm,BX,BX.Event,BX.UI.Dialogs);
//# sourceMappingURL=script.map.js