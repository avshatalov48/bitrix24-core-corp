BX.namespace("BX.Sale.CrmSiteMasterComponent");(function(){"use strict";BX.Sale.CrmSiteMasterComponent={init:function(e){this.wizardSteps=e.wizardSteps;this.formId=e.formId||"";this.formNode=BX(e.formId);this.documentRoot=e.documentRoot||"";this.siteNameNode=BX(e.siteNameId);this.docRootNode=BX(e.docRootId);this.docRootLinkNode=BX(e.docRootLinkId);this.createSiteNode=BX(e.createSiteId);this.keyNode=BX(e.keyId);this.keyButtonNode=BX(e.keyButtonId);this.keyInputBlockNode=BX(e.keyInputBlockId);this.confirmationCheckboxNode=BX(e.confirmationCheckboxId);this.nextButtonNode=document.forms[this.formId].elements[e.nextButtonId];this.prevButtonNode=document.forms[this.formId].elements[e.prevButtonId];this.cancelButtonNode=document.forms[this.formId].elements[e.cancelButtonId];this.finishButtonNode=document.forms[this.formId].elements[e.finishButtonId];this.currentStepId=e.currentStepId;this.licenseKeyRegExp=/^([A-Z0-9]{3}-[A-Z0-9]{2}-[A-Z0-9]{12,16})$/gm;if(this.currentStepId!==undefined){if(this.wizardSteps.includes(this.currentStepId)&&this.currentStepId==="Bitrix\\Sale\\CrmSiteMaster\\Steps\\SiteStep"){this.bindSiteEvents();if(this.siteNameNode){this.saleNewSiteForm(this.siteNameNode);BX.bind(this.siteNameNode,"change",BX.proxy(this.saleNewSiteForm.bind(this,this.siteNameNode),this))}}if(this.wizardSteps.includes(this.currentStepId)&&this.currentStepId==="Bitrix\\Sale\\CrmSiteMaster\\Steps\\ActivationKeyStep"){this.bindKeyEvents()}if(this.wizardSteps.includes(this.currentStepId)&&(this.currentStepId==="Bitrix\\Sale\\CrmSiteMaster\\Steps\\SiteInstructionStep"||this.currentStepId==="Bitrix\\Sale\\CrmSiteMaster\\Steps\\BackupStep")){this.bindConfirmationCheckboxEvents()}}},bindSiteEvents:function(){BX.bind(this.docRootLinkNode,"click",BX.proxy(this.setDocumentRoot,this))},bindKeyEvents:function(){BX.bind(this.keyButtonNode,"click",BX.proxy(this.applyKey,this));BX.bind(this.keyNode,"click",BX.proxy(this.inputKeyClick,this))},bindConfirmationCheckboxEvents:function(){BX.bind(this.confirmationCheckboxNode,"change",BX.proxy(this.onConfirmationCheckbox,this))},saleNewSiteForm:function(e){var t=e.value==="new";this.createSiteNode.style.display=t?"block":"none"},setDocumentRoot:function(){if(this.documentRoot.length>=0){this.docRootNode.value=this.documentRoot;BX.fireEvent(this.docRootNode,"change")}},applyKey:function(e){var t=this.keyNode.value;e.preventDefault();this.keyButtonNode.disabled=true;BX.addClass(this.keyButtonNode,"ui-btn-disabled");if(t.match(this.licenseKeyRegExp)){this.changeLicenseKey(t)}else{this.activateCoupon(t)}},changeLicenseKey:function(e){var t=this;BX.ajax.runComponentAction("bitrix:sale.crm.site.master","updateLicenseKey",{mode:"ajax",data:{key:e}}).then(function(e){t.checkUpdateSystem()},function(e){t.keyButtonNode.disabled=false;BX.removeClass(t.keyButtonNode,"ui-btn-disabled");var i="";for(var o in e.errors){if(e.errors.hasOwnProperty(o)){i+=e.errors[o].message+"<br>"}}if(i.length>0){t.addKeyError(i)}})},activateCoupon:function(e){var t=this;CHttpRequest.Action=function(e){e=t.prepareResponse(e);if(e==="Y"){t.autoSubmit()}else{t.addKeyError(BX.message("SALE_CSM_TEMPLATE_COUPON_ERROR"));t.keyButtonNode.disabled=false;BX.removeClass(t.keyButtonNode,"ui-btn-disabled")}};CHttpRequest.Send("/bitrix/admin/update_system_act.php?query_type=coupon"+"&sessid="+BX.bitrix_sessid()+"&COUPON="+escape(e)+"&updRand="+Math.random())},inputKeyClick:function(){this.removeKeyError()},prepareResponse:function(e){e=e.replace(/^\s+|\s+$/,"");while(e.length>0&&e.charCodeAt(0)==65279)e=e.substring(1);return e},checkUpdateSystem:function(){var e=this;BX.ajax.runComponentAction("bitrix:sale.crm.site.master","checkUpdateSystem",{mode:"ajax"}).then(function(t){e.autoSubmit()},function(e){console.log(e)})},autoSubmit:function(){if(this.nextButtonNode){this.formNode.submit()}},addKeyError:function(e){var t=BX(this.keyInputBlockNode.querySelector(".ui-ctl.ui-ctl-textbox"));if(BX.hasClass(t,"ui-ctl-active")){BX.removeClass(t,"ui-ctl-active");BX.addClass(t,"ui-ctl-danger");t.insertAdjacentHTML("afterend",'<div class="adm-crm-site-master-errors">'+e+"</div>")}},removeKeyError:function(){var e=BX(this.keyInputBlockNode.querySelector(".ui-ctl.ui-ctl-textbox"));if(BX.hasClass(e,"ui-ctl-danger")){BX.removeClass(e,"ui-ctl-danger");BX.addClass(e,"ui-ctl-active");var t=BX(this.keyInputBlockNode.querySelector(".adm-crm-site-master-errors"));if(t!==undefined){BX.remove(t)}}},onConfirmationCheckbox:function(e){if(!this.nextButtonNode)return;if(e.target.checked){this.nextButtonNode.disabled=false;BX.removeClass(this.nextButtonNode,"ui-btn-disabled")}else{this.nextButtonNode.disabled=true;BX.addClass(this.nextButtonNode,"ui-btn-disabled")}}}})();
//# sourceMappingURL=script.map.js