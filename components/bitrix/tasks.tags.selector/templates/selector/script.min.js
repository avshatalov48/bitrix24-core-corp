"use strict";BX.namespace("BX.Tasks");BX.Tasks.TagsSelector=function(t){this.tagsAreConverting=t.tagsAreConverting;this.groupId=t.groupId||0;this.taskId=t.taskId||0;this.isScrumTask=t.isScrumTask==="Y";this.templateId=t.templateId||0;this.tags=t.tags;this.userId=t.userId||0;this.entity={id:"task-tag"};if(this.taskId){this.entity.options={taskId:this.taskId};this.tags=[]}if(this.groupId){this.entity.options.groupId=this.groupId}this.bindEvents()};BX.Tasks.TagsSelector.prototype={constructor:BX.Tasks.TagsSelector,show:function(){this.getSelector()&&this.getSelector().show()},bindEvents:function(){var t=function(){this.dialog.hide();this.dialog=null};var e=function(t){this.dialog=null;this.groupId=0;if(t){this.groupId=t.data}};BX.addCustomEvent("onProjectChanged",e.bind(this));BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"tasks",command:"tag_changed",callback:t.bind(this)})},getSelector:function(){if(!this.dialog){var t={status:false};var e=function(){var t=BX.UI.EntitySelector.Dialog.getById("tasks-selector-task-tag-widget");t.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=false;t.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=false};var a=function(){var t=BX.UI.EntitySelector.Dialog.getById("tasks-selector-task-tag-widget");t.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=true;t.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=true};var s=function(t){var s=t.getData().query;if(s.trim()!==""){e()}else{a()}};var i=function(t,e){var a=BX.UI.EntitySelector.Dialog.getById("tasks-selector-task-tag-widget");if(a.getContainer().querySelector(`div.${t}`)){return}var s=document.createElement("div");s.className=t;s.innerHTML=`\n\t\t\t\t<div class='ui-alert ui-alert-xs ui-alert-danger'  \n\t\t\t\t\t<span class='ui-alert-message'>\n\t\t\t\t\t\t${e}\n\t\t\t\t\t</span> \n\t\t\t\t</div>\n\t\t\t\t`;a.getFooterContainer().before(s)};var n=function(e){var a=e.getTarget();var s=["click","keydown"];var n=function(e){if(e.type==="keydown"){if(!((e.ctrlKey||e.metaKey)&&e.keyCode===13)){return}}var s=a.getSelectedItems().map((function(t){return t.getTitle()}));var n=a.getTagSelectorQuery();if(n.trim()===""){return}BX.ajax.runComponentAction("bitrix:tasks.tags.selector","updateTags",{mode:"class",data:{taskId:o,tagIds:s,newTag:n}}).then((function(e){if(e.data.success){t.status=true;var s=a.addItem({id:n,entityId:"task-tag",title:n,tabs:"all"});var o={title:e.data.owner};s.setBadges([o]);s.select()}else{var r="tasks-selector-tag-already-exists-alert";i(r,e.data.error);var d=function(){var t=a.getContainer().querySelector(`div.${r}`);t&&t.remove()};setTimeout(d,2e3)}}))};s.forEach((function(t){if(t==="click"){a.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").addEventListener(t,n)}else{a.getContainer().addEventListener(t,n)}}))};var o=this.taskId;var r=this.groupId;var d=this.templateId;if(o!==0){if(this.tagsAreConverting){var l=new top.BX.UI.Dialogs.MessageBox({title:BX.message("TASKS_TAG_SELECTOR_TAGS_ARE_CONVERTING_TITLE"),message:BX.message("TASKS_TAG_SELECTOR_TAGS_ARE_CONVERTING_TEXT"),buttons:top.BX.UI.Dialogs.MessageBoxButtons.OK,okCaption:BX.message("TASKS_TAG_SELECTOR_TAGS_ARE_CONVERTING_COME_BACK_LATER"),onOk:function(){l.close()}});l.show();return}this.dialog=new BX.UI.EntitySelector.Dialog({id:"tasks-selector-task-tag-widget",targetNode:BX("task-tags-link"),enableSearch:true,width:350,height:400,multiple:true,dropdownMode:true,compactView:true,entities:[{id:"task-tag",options:{taskId:this.taskId,groupId:r}}],selectedItems:this.tags.map((function(t){return{id:BX.util.htmlspecialcharsback(t),entityId:"task-tag",title:BX.util.htmlspecialcharsback(t),tabs:"all"}})),searchOptions:{allowCreateItem:false},footer:BX.Tasks.EntitySelector.Footer,footerOptions:{userId:this.userId,taskId:this.taskId,groupId:r},clearUnavailableItems:true,events:{onLoad:function(t){t.getTarget().getFooterContainer().style.zIndex=1;n(t)}.bind(this),"Item:onSelect":function(){this.onTagsChange(t)}.bind(this),onSearch:function(t){s(t)}.bind(this),"Item:onDeselect":function(){this.onTagsChange(t)}.bind(this)}})}if(d!==0){this.dialog=new BX.UI.EntitySelector.Dialog({id:"tasks-widget-tag-selector-template-detail",targetNode:BX("task-tags-link"),enableSearch:true,width:350,height:400,multiple:true,dropdownMode:true,compactView:true,context:"TEMPLATE_TAG",entities:[{id:"template-tag",options:{},dynamicLoad:true,dynamicSearch:true}],selectedItems:this.tags.map((function(t){return{id:BX.util.htmlspecialcharsback(t),entityId:"template-tag",title:BX.util.htmlspecialcharsback(t),tabs:"all"}})),searchOptions:{allowCreateItem:true},events:{"Search:onItemCreateAsync":function(t){var e=new BX.Promise;var a=t.getData().searchQuery;var s=t.getTarget();setTimeout((function(){var t=s.addItem({id:a.getQuery(),entityId:"template-tag",title:a.getQuery(),tabs:"all"});if(t){t.select()}e.fulfill()}),1e3);return e},"Item:onSelect":function(){this.onTagsChange()}.bind(this),"Item:onDeselect":function(){this.onTagsChange()}.bind(this)}})}}return this.dialog},onTagsChange:function(t){var e=this.getSelector().getSelectedItems();var a=e.map((function(t){return t.getTitle()}));var s=a.join(", ");this.updateNode(s);var i=a.map((function(t){return{name:t}}));BX.onCustomEvent("onTaskTagSelect",[i]);if(typeof t!=="undefined"&&t.status){t.status=false;this.dialog.clearSearch();this.dialog.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=true;this.dialog.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=true;return}if(this.taskId){this.updateTask(a)}},updateNode:function(t){var e=BX("task-tags-line");var a=BX("task-tags-link");BX.cleanNode(e);BX.adjust(e,{text:t});if(t.length>0){e.innerHTML+="&nbsp;&nbsp;";a.innerHTML=BX.message("TAGS_BUTTON_CHANGE")}else{a.innerHTML=BX.message("TAGS_BUTTON_ADD")}},updateTask:function(t){BX.ajax.runComponentAction("bitrix:tasks.tags.selector","updateTags",{mode:"class",data:{taskId:this.taskId,tagIds:t}}).catch((function(t){if(t.errors){BX.Tasks.alert(t.errors)}}))}};
//# sourceMappingURL=script.map.js