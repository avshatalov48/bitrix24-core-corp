(function(){"use strict";BX.namespace("BX.Bizproc.DocumentComponent");var t=function(t,o){this.node=t;this.config=o};t.prototype={getNodes:function(t,o){var e=o||this.node;return e.querySelectorAll('[data-role="'+t+'"]')},getNode:function(t,o){return this.getNodes(t,o)[0]},createNodeFromTemplate:function(t){var o=this.getNode("templates");var e=o.querySelector('[data-template="'+t+'"]');if(e){var i=BX.clone(e);i.removeAttribute("data-template");return i}throw"Template not found"},init:function(){this.initEventsApplyButton();this.initStartButton();this.initCompletedListButton()},renderWorkflows:function(t){var o=this.getNode("workflows-list");BX.cleanNode(o);var e=false;for(var i=0;i<t.length;++i){o.appendChild(this.renderWorkflow(t[i]));if(!e&&t[i]["EVENTS"]&&t[i]["EVENTS"].length>0){e=true}}var n=this.getNode("events-apply-container");BX[e?"show":"hide"](n);var r=this.getNode("workflows-list-empty");BX[t.length<1?"show":"hide"](r)},renderCompletedWorkflows:function(t){var o=this.getNode("workflows-list-completed");for(var e=0;e<t.length;++e){o.appendChild(this.renderWorkflow(t[e]))}},prependCompletedWorkflows:function(t){var o=this.getNode("workflows-list-completed");t.forEach((function(t){BX.prepend(this.renderWorkflow(t),o)}),this)},renderWorkflow:function(t){var o,e=this.createNodeFromTemplate("workflow");e.setAttribute("data-workflow-id",t["ID"]);if(!t["WORKFLOW_STATUS"]){BX.addClass(e,e.getAttribute("data-class-finished"))}if(!t["WORKFLOW_STATUS"]||!this.config.canTerminate){var i=this.getNode("terminate-container",e);BX.remove(i)}if(!this.config.canKill||t["WORKFLOW_STATUS"]){var n=this.getNode("kill-container",e);BX.remove(n)}if(t["TASKS"]&&t["TASKS"].length>0){BX.addClass(e,e.getAttribute("data-class-tasks"));var r=this.getNode("tasks-container",e);for(o=0;o<t["TASKS"].length;++o){var s=t["TASKS"][o],l=BX.create("a",{props:{href:"#"},text:BX.util.htmlspecialcharsback(s["NAME"])});BX.bind(l,"click",this.onTaskLinkClick.bind(this,s));r.appendChild(BX.create("li",{children:[l]}))}}else{BX.remove(this.getNode("tasks-row",e))}if(t["EVENTS"]&&t["EVENTS"].length>0){var a=this.getNode("events-select",e);a.setAttribute("workflow-id",t["ID"]);for(o=0;o<t["EVENTS"].length;++o){a.appendChild(BX.create("option",{props:{value:t["EVENTS"][o]["NAME"]},text:t["EVENTS"][o]["TITLE"]}))}}else{BX.remove(this.getNode("events-row",e))}var d=this.getNode("workflow-name",e);d.textContent=t["TEMPLATE_NAME"];var f=this.getNode("workflow-modified",e);f.textContent=t["STATE_MODIFIED_FORMATTED"];var c=this.getNode("workflow-state",e);c.textContent=t["STATE_TITLE"]?t["STATE_TITLE"]:t["STATE_NAME"];this.initWorkflowNode(e);return e},initEventsApplyButton:function(){var t=this.getNode("events-apply-button");BX.bind(t,"click",this.onApplyEventsClick.bind(this))},initStartButton:function(){var t=this.getNode("start-button");if(t){var o=new BX.Bizproc.Starter({moduleId:this.config.moduleId,entity:this.config.entity,documentType:this.config.documentType,documentId:this.config.documentId});BX.addCustomEvent(o,"onAfterStartWorkflow",this.onAfterStartWorkflow.bind(this));BX.bind(t,"click",this.onStartClick.bind(this,t,o))}},onAfterStartWorkflow:function(t){this.reloadWorkflows();this.callAction("get_completed_workflow",{offset:0,workflowId:t.getData().workflow_id},function(t){if(t.workflow){this.prependCompletedWorkflows([t.workflow])}}.bind(this))},initCompletedListButton:function(){var t=this.getNode("btn-load-completed");if(t){BX.bind(t,"click",this.onLoadCompletedClick.bind(this,t))}},initWorkflowNode:function(t){var o=t.getAttribute("data-workflow-id");var e=this.getNode("kill",t);if(e){BX.bind(e,"click",this.onKillWorkflowClick.bind(this,o,t))}var i=this.getNode("terminate",t);if(i){BX.bind(i,"click",this.onTerminateWorkflowClick.bind(this,o,t))}var n=this.getNode("log",t);if(n){BX.bind(n,"click",this.onLogClick.bind(this,o))}},onKillWorkflowClick:function(t,o,e){e.preventDefault();var i=this;this.callAction("kill_workflow",{workflow_id:t},(function(t){BX.remove(o);if(t.workflows){i.renderWorkflows(t.workflows)}}))},onTerminateWorkflowClick:function(t,o,e){e.preventDefault();var i=this;this.callAction("terminate_workflow",{workflow_id:t},(function(t){if(t.workflows){i.renderWorkflows(t.workflows)}if(t.completedWorkflows){i.prependCompletedWorkflows(t.completedWorkflows)}}))},onApplyEventsClick:function(t){var o=this.getNode("form");var e=this.getNodes("events-select",o);var i=false,n={};for(var r=0;r<e.length;++r){var s=e[r].value;if(s!==""){n[e[r].getAttribute("workflow-id")]=s;i=true}}if(i){var l=this;this.callAction("send_events",{events:n},(function(t){if(t.workflows){l.renderWorkflows(t.workflows)}if(t.completedWorkflows){l.prependCompletedWorkflows(t.completedWorkflows)}}))}},onStartClick:function(t,o,e){o.showTemplatesMenu(t)},onLoadCompletedClick:function(t,o){var e=this.getNode("workflows-list-completed");var i=e.children.length;this.callAction("get_completed_workflows",{offset:i},function(o){if(o.workflows&&o.workflows.length){t.textContent=t.getAttribute("data-label-more");this.renderCompletedWorkflows(o.workflows)}else{BX.UI.Dialogs.MessageBox.alert(BX.message("IBEL_BIZPROC_COMPLETED_WORKFLOWS_EMPTY"))}}.bind(this))},onTaskLinkClick:function(t,o){o.preventDefault();if(BX.Bizproc&&BX.Bizproc.showTaskPopup){BX.Bizproc.showTaskPopup(t["ID"],this.reloadWorkflows.bind(this))}},onLogClick:function(t,o){o.preventDefault();if(top.BX.Bitrix24&&top.BX.Bitrix24.Slider){top.BX.Bitrix24.Slider.open("/bitrix/components/bitrix/bizproc.log/slider.php?site_id="+BX.message("SITE_ID")+"&WORKFLOW_ID="+t)}else if(BX.Bizproc&&BX.Bizproc.showWorkflowLogPopup){BX.Bizproc.showWorkflowLogPopup(t,{title:BX.message("IBEL_BIZPROC_LOG_TITLE")})}},reloadWorkflows:function(){var t=this;this.callAction("get_workflows",{},(function(o){if(o.workflows){t.renderWorkflows(o.workflows)}}))},callAction:function(t,o,e){this.showWait();o["sessid"]=BX.bitrix_sessid();o["site"]=BX.message("SITE_ID");o["ajax_action"]=t;o["module_id"]=this.config.moduleId;o["entity"]=this.config.entity;o["document_type"]=this.config.documentType;o["document_id"]=this.config.documentId;var i=this;BX.ajax({method:"POST",dataType:"json",url:this.config.serviceUrl,data:o,onsuccess:function(t){if(t.success){e(t.data,t)}else{BX.UI.Dialogs.MessageBox.alert(t.errors.join("\n"))}i.hideWait()},onfailure:function(){i.hideWait()}})},showWait:function(){BX.addClass(this.node,"bizproc-document-wait")},hideWait:function(){BX.removeClass(this.node,"bizproc-document-wait")}};BX.Bizproc.DocumentComponent=t})();
//# sourceMappingURL=script.map.js