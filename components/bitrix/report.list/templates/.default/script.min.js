BX.namespace("BX.Report");BX.Report.ReportListClass=function(){var e=function(e){this.ajaxUrl="/bitrix/components/bitrix/report.list/ajax.php";this.jsClass=e.jsClass;this.containerId=e.containerId;this.editUrl=e.editUrl;this.deleteUrl=e.deleteUrl;this.copyUrl=e.copyUrl;this.deleteConfirmUrl=e.deleteConfirmUrl;this.ownerId=e.ownerId;this.sessionError=Boolean(e.sessionError);this.destFormName=e.destFormName||"report-list-destFormName";this.init()};e.prototype.init=function(){var e=BX.findChildren(BX(this.containerId),{tagName:"a",className:"reports-menu-button"},true);for(var t=0;t<e.length;t++){BX.bind(e[t],"click",BX.delegate((function(e){this.showMenu(e)}),this))}if(this.sessionError){BX.Report.showModalWithStatusAction({status:"error",message:BX("report-list-error").innerHTML})}};e.prototype.showMenu=function(e){BX.PreventDefault(e);var t=0;var o=BX.proxy_context;var s=o.id.substr(4);var a=s.indexOf("d");var r=a<0?0:parseInt(s.substr(a+1));var i=parseInt(a>0?s.substr(0,a):s);var n=this.editUrl.replace("REPORT_ID",i);var p=this.deleteUrl.replace("REPORT_ID",i);var l=this.copyUrl.replace("REPORT_ID",i);var d=[];var c=false,m="",u=["r","e","f"];for(var h=0;u.length>h;h++){var B=s.indexOf(u[h]);if(B>0){m=s.slice(B);c=true;break}}d[t++]={text:BX.message("REPORT_COPY_SHORT"),title:BX.message("REPORT_COPY_FULL"),className:"reports-menu-popup-item-copy",href:l};d[t++]={text:BX.message("REPORT_EXPORT_SHORT"),title:BX.message("REPORT_EXPORT_FULL"),className:"reports-menu-popup-item-export",onclick:'BX.Report["'+this.jsClass+'"].export("'+i+'");'};if(c){switch(m){case"r":break;case"e":d[t++]={text:BX.message("REPORT_EDIT_SHORT"),title:BX.message("REPORT_EDIT_FULL"),className:"reports-menu-popup-item-edit",href:n};break;case"f":d[t++]={text:BX.message("REPORT_EDIT_SHORT"),title:BX.message("REPORT_EDIT_FULL"),className:"reports-menu-popup-item-edit",href:n};d[t++]={text:BX.message("REPORT_DELETE_SHORT"),title:BX.message("REPORT_DELETE_FULL"),className:"reports-menu-popup-item-delete",href:p,onclick:BX.delegate((function(e){this.confirmReportDelete(i);BX.PreventDefault(e)}),this)};break}}else{if(r===0){d[t++]={text:BX.message("REPORT_EDIT_SHORT"),title:BX.message("REPORT_EDIT_FULL"),className:"reports-menu-popup-item-edit",href:n};d[t++]={text:BX.message("REPORT_SHARING_SHORT"),title:BX.message("REPORT_SHARING_FULL"),className:"reports-menu-popup-item-sharing",onclick:'BX.Report["'+this.jsClass+'"].sharing("'+i+'");'}}d[t++]={text:BX.message("REPORT_DELETE_SHORT"),title:BX.message("REPORT_DELETE_FULL"),className:"reports-menu-popup-item-delete",href:p,onclick:BX.delegate((function(e){this.confirmReportDelete(i);BX.PreventDefault(e)}),this)}}BX.PopupMenu.show(i,o,d,{})};e.prototype.confirmReportDelete=function(e){var t=this.deleteConfirmUrl.replace("REPORT_ID",e);if(confirm(BX.message("REPORT_DELETE_CONFIRM"))){var o=BX.create("form",{attrs:{method:"post"}});o.action=t;o.appendChild(BX.create("input",{attrs:{type:"hidden",name:"csrf_token",value:BX.message("bitrix_sessid")}}));document.body.appendChild(o);BX.submit(o)}};var t={};var o={};var s="";e.prototype.sharing=function(e){t={};o={};BX.PopupMenu.destroy(e);BX.Report.modalWindowLoader(BX.Report.addToLinkParam(this.ajaxUrl,"action","showSharing"),{id:"report_show_sharing_"+e,responseType:"json",postData:{reportId:e},afterSuccessLoad:BX.delegate((function(o){if(o.status!="success"){o.errors=o.errors||[{}];BX.Report.showModalWithStatusAction({status:"error",message:o.errors.pop().message})}var a={name:o.owner.name,avatar:o.owner.avatar,link:o.owner.link};s=o.owner.access;BX.Report.modalWindow({modalId:"bx-report-sharing-"+e,title:BX.message("REPORT_LIST_SHARING_TITLE_POPUP"),contentClassName:"",contentStyle:{},events:{onAfterPopupShow:BX.delegate((function(){BX.addCustomEvent("onChangeRightOfSharing",BX.proxy(this.onChangeRightOfSharing,this));for(var e in o.members){if(!o.members.hasOwnProperty(e)){continue}t[o.members[e].entityId]={item:{id:o.members[e].entityId,name:o.members[e].name,avatar:o.members[e].avatar},type:o.members[e].type,right:o.members[e].right}}BX.SocNetLogDestination.init({name:this.destFormName,searchInput:BX("feed-add-post-destination-input"),bindMainPopup:{node:BX("feed-add-post-destination-container"),offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:BX("feed-add-post-destination-container"),offsetTop:"5px",offsetLeft:"15px"},callback:{select:BX.proxy(this.onSelectDestination,this),unSelect:BX.proxy(this.onUnSelectDestination,this),openDialog:BX.proxy(this.onOpenDialogDestination,this),closeDialog:BX.proxy(this.onCloseDialogDestination,this),openSearch:BX.proxy(this.onOpenSearchDestination,this),closeSearch:BX.proxy(this.onCloseSearchDestination,this)},items:o.destination.items,itemsLast:o.destination.itemsLast,itemsSelected:o.destination.itemsSelected});var s=this.destFormName;BX.bind(BX("feed-add-post-destination-container"),"click",(function(e){BX.SocNetLogDestination.openDialog(s);BX.PreventDefault(e)}));BX.bind(BX("feed-add-post-destination-input"),"keyup",BX.proxy(this.onKeyUpDestination,this));BX.bind(BX("feed-add-post-destination-input"),"keydown",BX.proxy(this.onKeyDownDestination,this))}),this),onPopupClose:BX.delegate((function(){if(BX.SocNetLogDestination&&BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.closeDialog()}BX.removeCustomEvent("onChangeRightOfSharing",BX.proxy(this.onChangeRightOfSharing,this));BX.proxy_context.destroy()}),this)},content:[BX.create("div",{props:{className:"bx-report-popup-content"},children:[BX.create("table",{props:{className:"bx-report-popup-shared-people-list"},children:[BX.create("thead",{html:"<tr>"+'<td class="bx-report-popup-shared-people-list-head-col1">'+BX.message("REPORT_LIST_SHARING_OWNER")+"</td></tr>"}),BX.create("tr",{html:"<tr>"+'<td class="bx-report-popup-shared-people-list-col1" '+'style="border-bottom: none;">'+'<a class="bx-report-filepage-used-people-link" href="'+a.link+'">'+'<span class="bx-report-filepage-used-people-avatar" '+'style="background-image: url('+a.avatar+');">'+"</span>"+BX.util.htmlspecialchars(a.name)+"</a></td></tr>"})]}),BX.create("table",{props:{id:"bx-report-popup-shared-people-list",className:"bx-report-popup-shared-people-list",style:"display:none;"},children:[BX.create("thead",{html:"<tr>"+'<td class="bx-report-popup-shared-people-list-head-col1">'+BX.message("REPORT_LIST_SHARING_NAME_RIGHTS_USER")+"</td>"+'<td class="bx-report-popup-shared-people-list-head-col2">'+BX.message("REPORT_LIST_SHARING_NAME_RIGHTS")+'</td><td class="bx-report-popup-shared-people-list-head-col3">'+"</td></tr>"})]}),BX.create("div",{props:{id:"feed-add-post-destination-container",className:"feed-add-post-destination-wrap"},children:[BX.create("span",{props:{className:"feed-add-post-destination-item"}}),BX.create("span",{props:{id:"feed-add-post-destination-input-box",className:"feed-add-destination-input-box"},style:{background:"transparent"},children:[BX.create("input",{props:{type:"text",value:"",id:"feed-add-post-destination-input",className:"feed-add-destination-inp"}})]}),BX.create("a",{props:{href:"#",id:"bx-destination-tag",className:"feed-add-destination-link"},style:{background:"transparent"},text:BX.message("REPORT_LIST_SHARING_NAME_ADD_RIGHTS_USER"),events:{click:BX.delegate((function(){}),this)}})]})]})],buttons:[BX.create("a",{text:BX.message("REPORT_LIST_BTN_SAVE"),props:{className:"bx-report-btn bx-report-btn-big bx-report-btn-green"},events:{click:BX.delegate((function(){BX.Report.ajax({method:"POST",dataType:"json",url:BX.Report.addToLinkParam(this.ajaxUrl,"action","changeSharing"),data:{reportId:e,entityToNewShared:t},onsuccess:BX.delegate((function(e){if(!e)return;BX.Report.showModalWithStatusAction(e)}),this)});BX.PopupWindowManager.getCurrentPopup().close()}),this)}}),BX.create("a",{text:BX.message("REPORT_LIST_BTN_CLOSE"),props:{className:"bx-report-btn bx-report-btn-big bx-report-btn-transparent"},events:{click:function(){BX.PopupWindowManager.getCurrentPopup().close()}}})]})}),this)})};e.prototype.onSelectDestination=function(e,a,r){t[e.id]=t[e.id]||{};BX.Report.appendNewShared({maxAccessName:s,readOnly:!!o[e.id],destFormName:this.destFormName,item:e,type:a,right:t[e.id].right});t[e.id]={item:e,type:a,right:t[e.id].right||"access_read"};BX.Report.show(BX("bx-report-popup-shared-people-list"))};e.prototype.onUnSelectDestination=function(e,s,a){var r=e.id;if(!!o[r]){return false}delete t[r];var i=BX.findChild(BX("bx-report-popup-shared-people-list"),{attribute:{"data-dest-id":""+r+""}},true);if(i){BX.remove(i)}if(BX.Report.isEmptyObject(t)){BX.Report.hide(BX("bx-report-popup-shared-people-list"))}};e.prototype.onOpenDialogDestination=function(){BX.style(BX("feed-add-post-destination-input-box"),"display","inline-block");BX.style(BX("bx-destination-tag"),"display","none");BX.focus(BX("feed-add-post-destination-input"));if(BX.SocNetLogDestination.popupWindow)BX.SocNetLogDestination.popupWindow.adjustPosition({forceTop:true})};e.prototype.onCloseDialogDestination=function(){var e=BX("feed-add-post-destination-input");if(!BX.SocNetLogDestination.isOpenSearch()&&e&&e.value.length<=0){BX.style(BX("feed-add-post-destination-input-box"),"display","none");BX.style(BX("bx-destination-tag"),"display","inline-block")}};e.prototype.onOpenSearchDestination=function(){if(BX.SocNetLogDestination.popupSearchWindow)BX.SocNetLogDestination.popupSearchWindow.adjustPosition({forceTop:true})};e.prototype.onCloseSearchDestination=function(){var e=BX("feed-add-post-destination-input");if(!BX.SocNetLogDestination.isOpenSearch()&&e&&e.value.length>0){BX.style(BX("feed-add-post-destination-input-box"),"display","none");BX.style(BX("bx-destination-tag"),"display","inline-block");BX("feed-add-post-destination-input").value=""}};e.prototype.onKeyUpDestination=function(e){var t=this.destFormName;if(e.keyCode==16||e.keyCode==17||e.keyCode==18||e.keyCode==20||e.keyCode==244||e.keyCode==224||e.keyCode==91)return false;if(e.keyCode==13){BX.SocNetLogDestination.selectFirstSearchItem(t);return BX.PreventDefault(e)}if(e.keyCode==27){BX("feed-add-post-destination-input").value=""}else{BX.SocNetLogDestination.search(BX("feed-add-post-destination-input").value,true,t)}if(BX.SocNetLogDestination.sendEvent&&BX.SocNetLogDestination.isOpenDialog())BX.SocNetLogDestination.closeDialog();if(e.keyCode==8){BX.SocNetLogDestination.sendEvent=true}return BX.PreventDefault(e)};e.prototype.onKeyDownDestination=function(e){var t=this.destFormName;if(e.keyCode==8&&BX("feed-add-post-destination-input").value.length<=0){BX.SocNetLogDestination.sendEvent=false;BX.SocNetLogDestination.deleteLastItem(t)}return true};e.prototype.onChangeRightOfSharing=function(e,o){if(t[e]){t[e].right=o}};e.prototype.filterUser=function(e,t){if(!e)return;var o=t.searchInput.getAttribute("id").replace("filter_search_","");var s=document.querySelector("#reports-company-"+o),a=s.querySelectorAll("tr:nth-child(n+2)"),r=Object.keys(e);this.showAllItem(o);for(var i=0;i<a.length;i++){var n=a[i].getAttribute("data-item");if(n!==r[0]){BX.Report.hide(a[i])}}BX("filter-delete-user-"+o).style.visibility="visible"};e.prototype.showAllItem=function(e){var t=document.querySelector("#reports-company-"+e),o=t.querySelectorAll("tr:nth-child(n+2)");for(var s=0;s<o.length;s++){BX.Report.show(o[s])}};e.prototype.clearSelectUser=function(e){BX("filter_search_"+e).value="";BX("filter_data_"+e).value="";var t="filter_"+e;BX.ReportUserSearchPopup.items[t]._currentUser="";BX("filter-delete-user-"+e).style.visibility="";this.showAllItem(e)};e.prototype.export=function(e){var t=BX.create("form",{props:{method:"POST"},children:[BX.create("input",{props:{type:"hidden",name:"sessid",value:BX.bitrix_sessid()}}),BX.create("input",{props:{type:"text",name:"EXPORT_REPORT",value:BX.util.htmlspecialchars(e)}})]});BX.PopupMenu.currentItem.popupWindow.close();document.body.appendChild(t);BX.submit(t)};e.prototype.import=function(){var e=BX.create("div",{props:{className:"bx-report-popup-content bx-report-popup-content-import"},children:[BX.create("form",{props:{id:"report-import-form",method:"POST",enctype:"multipart/form-data"},children:[BX.create("input",{props:{type:"hidden",name:"sessid",value:BX.bitrix_sessid()}}),BX.create("input",{props:{type:"hidden",name:"IMPORT_REPORT",value:"1"}}),BX.create("span",{props:{className:"bx-report-description-import"},text:BX.message("REPORT_IMPORT_DESCRIPTION")}),BX.create("span",{props:{className:"file-wrapper"},children:[BX.create("span",{props:{className:"bx-report-input-file"},children:[BX.create("span",{props:{className:"webform-small-button bx-report-small-button"},text:BX.message("REPORT_IMPORT_BUTTON_TEXT")}),BX.create("input",{props:{type:"file",name:"IMPORT_REPORT_FILE"}})]}),BX.create("span",{props:{className:"fileformlabel bx-report-input-file-name"}})]})]})]});var t=false,o=true;BX.Report.modalWindow({modalId:"bx-report-popup",contentClassName:"bx-report-popup-content-import",title:BX.message("REPORT_IMPORT_TITLE"),overlay:false,autoHide:true,contentStyle:{width:"420px"},content:[e],events:{onAfterPopupShow:function(){var e=document.getElementsByClassName("bx-report-input-file");for(var s=0;s<e.length;s++){var a=e[s].getElementsByTagName("input");for(var r=0;r<a.length;r++){a[r].onchange=i}}function i(){o=true;t=true;var e=this.value,s;if(e.lastIndexOf("\\"))s=e.lastIndexOf("\\")+1;else s=e.lastIndexOf("/")+1;e=e.slice(s);if(this.value.split(".").pop()!=="csv")o=false;this.parentNode.parentNode.getElementsByClassName("fileformlabel")[0].style.color="";var a=this.parentNode.parentNode.getElementsByClassName("fileformlabel")[0];a.innerHTML=e}}},buttons:[BX.create("a",{text:BX.message("REPORT_LIST_BTN_SAVE"),props:{className:"webform-small-button webform-small-button-accept"},events:{click:BX.delegate((function(e){var s=BX("bx-report-popup").getElementsByClassName("fileformlabel")[0];if(t&&o)BX("report-import-form").submit();else s.style.color="red";if(!t)s.innerHTML=BX.message("REPORT_IMPORT_ERROR_UPLOADED_FILE");if(!o)s.innerHTML=BX.message("REPORT_IMPORT_ERROR_FILE_EXT")}),this)}}),BX.create("a",{text:BX.message("REPORT_LIST_BTN_CLOSE"),props:{className:"webform-small-button webform-button-cancel"},events:{click:BX.delegate((function(e){BX.PopupWindowManager.getCurrentPopup().close()}),this)}})]})};return e}();
//# sourceMappingURL=script.map.js