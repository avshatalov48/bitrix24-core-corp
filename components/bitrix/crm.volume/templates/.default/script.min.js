BX.namespace("BX.Crm.volume");BX.Crm.MeasureClass=function(){var e;var t=function(e){e=e||{};if(typeof e.relUrl==="undefined"||e.relUrl===""){throw new Error("BX.Crm.Measure: 'relUrl' parameter missing.")}this.amount={};this.ajaxUrl=e.ajaxUrl||"/bitrix/components/bitrix/crm.volume/ajax.php";this.relUrl=e.relUrl;this.gridId=e.gridId;this.filterId=e.filterId;this.sefMode=e.sefMode||"N";this.progressBar=BX("bx-crm-volume-loader-progress-bar");this.hasWorkerInProcess=e.hasWorkerInProcess||false;this.stepper=BX("bx-crm-volume-stepper");this.suppressStepperAlert=e.suppressStepperAlert||false;this.stepperAlert=BX("bx-crm-volume-message-alert");BX.Event.EventEmitter.subscribe("onStepperHasBeenFinished",BX.proxy(this.stepperFinished,this));setTimeout(BX.proxy(this.initStepperHints,this),100);setTimeout(BX.proxy(this.stepperAddCancelButton,this),110);setTimeout(BX.proxy(this.initLocalLinks,this),120);setTimeout(BX.proxy(this.initGridLinks,this),120);BX.bind(window,"beforeunload",BX.proxy(this.onUnload,this));BX.addCustomEvent("Grid::updated",BX.proxy(this.initGridLinks,this))};t.prototype.onUnload=function(e){if(typeof e==="undefined"){e=window.event}if(this.hasWorkerInProcess&&this.suppressStepperAlert!==true){var t=BX.message("CRM_VOLUME_CLOSE_WARNING");if(e){e.returnValue=t}this.stepperAlertShow();return t}};t.prototype.suppressUnload=function(){this.suppressStepperAlert=true};t.prototype.initLocalLinks=function(e){e=e||BX("content-table");var t=BX.findChildrenByClassName(e,"crm-volume-reload-link");for(var r=0;r<t.length;r++){BX.bind(t[r],"click",BX.proxy(this.repeatMeasure,this))}var s=BX.findChildren(e,{tagName:"a",attribute:{href:/\/volume\//i}},true);for(var r=0;r<s.length;r++){BX.bind(s[r],"click",BX.proxy(this.suppressUnload,this))}};t.prototype.initGridLinks=function(){var e=this.getGrid();if(e){var t=BX.findChildrenByClassName(this.getGrid().container,"crm-volume-link-grid");for(var r=0;r<t.length;r++){BX.bind(t[r],"click",function(e){BX.PreventDefault(e)});BX.bind(t[r],"mousedown",BX.proxy(this.resetEntityListGrid,this));BX.bind(t[r],"touchstart",BX.proxy(this.resetEntityListGrid,this))}}};t.prototype.callAction=function(t){t=t||{};if(typeof t.action==="undefined"||t.action===""){throw new Error("BX.Crm.Measure: 'action' parameter missing.")}if(!!t.before){if(typeof this[t.before]==="function"){this[t.before].apply(this,[t])}else if(typeof t.before==="function"){t.before.apply(this,[t])}delete t.before}var r=BX.clone(t);delete r.before;delete r.after;var s=this.ajaxUrl+"?action="+t.action;e=BX.ajax({method:"POST",dataType:"json",url:s,data:BX.merge(this.ajaxAuxParams(),r),onsuccess:BX.proxy(function(e){this.actionComplete(e,t)},this)})};t.prototype.ajaxAuxParams=function(){var e={relUrl:this.relUrl,sefMode:this.sefMode,AJAX_CALL:"Y",SITE_ID:BX.message("SITE_ID"),sessid:BX.bitrix_sessid()};return e};t.prototype.actionComplete=function(e,t){e=e||{};t=t||{};var r;this.hideModal();if(!!e.status&&e.status==="success"){if(typeof e.subTask!=="undefined"&&e.subTask.length>0){o=e.subTask}if(typeof e.subStep!=="undefined"&&parseInt(e.subStep)>0){i=parseInt(e.subStep)}if(i>0){t.subStep=i;t.subTask=o}if(e.queueStep&&e.timeout){if(this.progressBar){r=Math.round((n+i)*100/this.lengthQueue());this.progressBarShow(r)}this.callAction(BX.merge({queueStep:n+1,queueLength:a.length,subTask:o,subStep:i},a[n]));return}else if(e.timeout){if(this.progressBar){r=Math.round((n+i)*100/this.lengthQueue());this.progressBarShow(r)}this.callAction(t);return}else if(e.queueStep){n++;if(n<a.length&&a[n]){if(this.progressBar){r=Math.round((n+i)*100/this.lengthQueue());this.progressBarShow(r)}else{this.modalWindow({content:e.message,showLoaderIcon:true,autoHide:false})}this.callAction(BX.merge({queueStep:n+1,queueLength:a.length},a[n]));return}else{n=-1;this.progressBarShow(100)}}if(!!t.after){if(typeof this[t.after]==="function"){this[t.after].apply(this,[e,t])}else if(typeof t.after==="function"){t.after.apply(this,[e,t])}delete t.after}if(typeof e.stepper!="undefined"){if(e.stepper!==""){this.stepperShow(e.stepper)}else{this.stepperHide()}}if(typeof t.doNotShowModalAlert==="undefined"&&!!e.message){this.modalWindow(e)}else{var s=BX.PopupWindowManager.getCurrentPopup();if(s){if(!s.isShown()||s.uniquePopupId==="bx-crm-status-action"){s.destroy()}}}}else if(!!e.status&&!!e.status){this.modalWindow(e)}if(typeof t.doNotFollowRedirect==="undefined"){if(!!e.url){this.suppressUnload();window.location.href=e.url}}};var r=null;var s=null;t.prototype.modalWindow=function(e){e=e||{};e.title=e.title||false;e.bindElement=e.bindElement||null;e.overlay=typeof e.overlay=="undefined"?true:e.overlay;e.closeIcon=typeof e.closeIcon=="undefined"?true:e.closeIcon;e.modalId=e.modalId||"crm_volume_modal_window_"+(Math.random()*(2e5-100)+100);e.withoutContentWrap=typeof e.withoutContentWrap=="undefined"?false:e.withoutContentWrap;e.contentClassName=e.contentClassName||"";e.contentStyle=e.contentStyle||{};e.content=e.content||[];e.buttons=e.buttons||false;e.events=e.events||{};e.autoHide=e.autoHide||false;e.autoHideTimeout=e.autoHideTimeout||3e3;if(!!e.status&&e.status==="error"&&e.errors.length>0){e.content.push(e.errors.shift().message);e.withoutContentWrap=false;e.title=BX.message("CRM_VOLUME_ERROR")}var t=[];if(e.withoutContentWrap){t=t.concat(e.content)}else{t.push(BX.create("div",{props:{className:"crm-volume-popup-container "+e.contentClassName},style:e.contentStyle,children:e.content}))}if(e.htmlButtons){var i=[];for(var o in e.htmlButtons){if(!e.htmlButtons.hasOwnProperty(o)){continue}if(o>0){i.push(BX.create("SPAN",{html:"&nbsp;"}))}i.push(e.htmlButtons[o])}t.push(BX.create("div",{props:{className:"crm-volume-popup-buttons"},children:i}))}var n=BX.create("div",{props:{className:"crm-volume-popup-container"},children:t});var a=e.events.onPopupClose;e.events.onPopupClose=BX.delegate(function(){firstButtonInModalWindow=null;try{BX.unbind(document,"keydown",BX.proxy(this._keypress,this))}catch(e){}if(a){BX.delegate(a,BX.proxy_context)()}BX.proxy_context.destroy()},this);var l=BX.PopupWindowManager.create(e.modalId,e.bindElement,{titleBar:e.title,content:n,closeByEsc:true,closeIcon:e.closeIcon,overlay:e.overlay,events:e.events,buttons:e.buttons,zIndex:isNaN(e["zIndex"])?0:e.zIndex});l.show();r=e.modalId;if(e.autoHide&&e.autoHideTimeout>0){s=setTimeout(BX.proxy(this.hideModal,this),e.autoHideTimeout)}return l};t.prototype.hideModal=function(){if(!!r){var e=BX.PopupWindowManager.getCurrentPopup();if(!e||e.uniquePopupId!=r){return}e.close();e.destroy();r=null;if(s>0){clearTimeout(s);s=null}}};var i=-1;var o=null;var n=-1;var a=[];var l=0;t.prototype.addQueueItem=function(e){a.push(e);l++;if(typeof e.subTaskCount!=="undefined"&&parseInt(e.subTaskCount)>0){l+=parseInt(e.subTaskCount)}};t.prototype.runQueue=function(e,t){e=e||1;t=t||{};if(this.lengthQueue()>0){i=0;o=null;n=0;if(e>0){n=e-1}this.callAction(BX.merge({queueStep:n+1,queueLength:a.length},a[n],t))}};t.prototype.stopQueue=function(){i=-1;o=null;n=-1;try{e.abort()}catch(e){}};t.prototype.lengthQueue=function(){return l};t.prototype.openConfirm=function(e){var t=e.payload;var r,s="",i="";if(!!e.messageConfirmId){s=BX.message(e.messageConfirmId)}else{s=e.messageConfirm}if(!!e.messageConfirmAllId){i=BX.message(e.messageConfirmAllId)}else if(!!e.messageConfirmAll){i=e.messageConfirmAll}var o="";var n=BX.Main.filterManager.getById(this.filterId);if(!!n&&n instanceof BX.Main.Filter){var a=n.getSearch();var l=a.getSquares();for(var p in l){if(!l.hasOwnProperty(p))continue;var u=BX.clone(l[p]);o+=u.innerHTML}}if(o!=""){r=s+"<div>"+BX.message("CRM_VOLUME_CONFIRM_FILTER")+": "+o+"</div>"}else if(i!=""){r=i}else{r=s}var d=e.acceptButton||BX.message("CRM_VOLUME_DELETE");var f=e.cancelButton||BX.message("CRM_VOLUME_CANCEL");var h=e.title||BX.message("CRM_VOLUME_CONFIRM");delete e.payload;delete e.messageConfirm;delete e.messageConfirmId;delete e.messageConfirmAll;delete e.messageConfirmAllId;delete e.name;delete e.acceptButton;delete e.cancelButton;delete e.title;var c=[new BX.PopupWindowButton({text:d,className:"popup-window-button-accept",events:{click:BX.delegate(function(r){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(r);if(!!t){if(typeof this[t]==="function"){this[t].apply(this,[e])}else if(typeof t==="function"){t.apply(this,[e])}}return false},this)}})];c.push(new BX.PopupWindowButton({text:f,events:{click:function(e){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(e);return false}}}));this.modalWindow({modalId:"bx-link-unlink-confirm",title:h,withoutContentWrap:true,content:r,buttons:c})};t.prototype.showAlertSetupProcess=function(){this.modalWindow({content:BX.message("CRM_VOLUME_SETUP_CLEANER"),closeIcon:false,overlay:true,showLoaderIcon:true})};t.prototype.updateTotalSize=function(e){BX.adjust(BX("bx-crm-volume-total-size"),{html:e.format})};t.prototype.updateFileSize=function(e){var t=BX("bx-crm-volume-file-size");BX.adjust(t,{html:e.format,style:{display:e.size>0?"inline-block":"none"}})};t.prototype.progressBarShow=function(e){if(this.progressBar){var t=BX.findChildByClassName(this.progressBar,"crm-volume-loader-progress-bar-number",true);var r=BX.findChildByClassName(this.progressBar,"crm-volume-loader-progress-bar-line-active",true);if(e>100)e=100;if(e<0)e=0;t.innerHTML=e+"%";r.style.width=e+"%";BX.addClass(BX("bx-crm-volume-main-block"),"crm-volume-running")}};t.prototype.progressBarHide=function(){BX.removeClass(BX("bx-crm-volume-main-block"),"crm-volume-running")};var p;t.prototype.getGrid=function(){if(typeof p!=="object"||typeof p.instance!=="object"||!p.instance instanceof BX.Main.grid){if(this.gridId!==""&&BX(this.gridId)&&typeof BX.Main.gridManager!=="undefined"){p=BX.Main.gridManager.getById(this.gridId)}}if(typeof p==="object"&&typeof p.instance==="object"&&p.instance instanceof BX.Main.grid){return p.instance}return null};t.prototype.reloadGrid=function(){if(this.getGrid()){this.getGrid().reload()}};t.prototype.getGridRow=function(e){return this.getGrid().getRows().getById(""+e)};t.prototype.markGridRowWait=function(e){for(var t,r=0;r<e.length;r++){t=this.getGridRow(e[r]);if(t){t.getNode().style.opacity=.5}}};t.prototype.markGridRowNormal=function(e){for(var t,r=0;r<e.length;r++){t=this.getGridRow(e[r]);if(t){t.getNode().style.opacity=1}}};t.prototype.removeGridRow=function(e){for(var t,r=0;r<e.length;r++){t=this.getGridRow(e[r]);if(t){t.getNode().remove()}}};t.prototype.stepperShow=function(e){if(!!this.stepper){this.hasWorkerInProcess=true;var t=BX.processHTML(e,false);this.stepper.innerHTML=t.HTML;BX.ajax.processScripts(t.SCRIPT);setTimeout(BX.proxy(this.stepperAddCancelButton,this),100);BX.show(this.stepper);BX.hide(BX("bx-crm-volume-reload-warning"))}};t.prototype.stepperHide=function(){this.hasWorkerInProcess=false;if(this.stepper){BX.hide(this.stepper);this.stepper.innerHTML=""}};t.prototype.stepperFinished=function(){this.stepperHide();BX.onCustomEvent(window,"OnCrmVolumeStepperFinished",[this]);BX.show(BX("bx-crm-volume-reload-warning"));if(this.getGrid()){this.reloadGrid()}else{this.suppressUnload();window.location.href=this.relUrl}};t.prototype.stepperAddCancelButton=function(){if(!!this.stepper){var e=BX.findChildByClassName(this.stepper,"main-stepper");if(!!e){BX.append(BX.create("span",{attrs:{id:"bx-crm-volume-cancel-workers",className:"crm-volume-header-link",title:BX.message("CRM_VOLUME_CANCEL_WORKERS")},text:BX.message("CRM_VOLUME_CANCEL")}),e);BX.bind(BX("bx-crm-volume-cancel-workers"),"click",BX.proxy(function(){this.modalWindow({content:BX.message("CRM_VOLUME_PERFORMING_CANCEL_WORKERS"),overlay:true,showLoaderIcon:true,autoHide:false});this.callAction({action:"CANCEL_TASKS",after:"stepperHide",doNotShowModalAlert:true})},this))}}};t.prototype.stepperAlertShow=function(){if(this.stepperAlert&&this.suppressStepperAlert!==true){BX.show(this.stepperAlert)}};t.prototype.resetEntityListGrid=function(e){BX.PreventDefault(e);var t=BX.getEventButton(e)===BX.MSLEFT;var r=BX(e.target),s=r.href,i=BX.data(r,"gridId"),o=BX.data(r,"filterId"),n=BX.data(r,"fields"),a=BX.data(r,"filter");a=JSON.parse(a);a.FIND="";var l={FILTER_ID:o,GRID_ID:i,action:"setFilter",forAll:"false",apply_filter:"Y",clear_filter:"Y",with_preset:"N",save:"Y"};var p={fields:a,rows:n,preset_id:"tmp_filter"};BX.ajax.runComponentAction("bitrix:main.ui.filter","setFilter",{mode:"ajax",data:{params:l,data:p}}).then(function(e){if(t){window.location.href=s}});return!t};t.prototype.repeatMeasure=function(e){BX.PreventDefault(e);var t=BX(e.target);var r=BX("bx-crm-volume-link-measure");if(!!r){r.disabled=true;BX.addClass(r,"ui-btn-disabled ui-btn-wait");this.progressBarShow(0);this.runQueue(1)}else{var s=t.href;if(this.hasWorkerInProcess){this.openConfirm({title:BX.message("CRM_VOLUME_MEASURE_DATA_REPEAT"),messageConfirm:BX.message("CRM_VOLUME_MEASURE_CONFIRM")+"\n\n"+BX.message("CRM_VOLUME_MEASURE_CONFIRM_QUESTION"),acceptButton:BX.message("CRM_VOLUME_MEASURE_ACCEPT"),payload:function(){BX.addClass(t,"ui-btn-wait ui-btn-disabled");window.location.href=s}})}else{BX.addClass(t,"ui-btn-wait ui-btn-disabled");window.location.href=s}}return true};t.prototype.alertShow=function(e){e=e||{};if(!e.message){if(e.status==="success"){e.message=BX.message("CRM_VOLUME_SUCCESS")}else{e.message=BX.message("CRM_VOLUME_ERROR");if(e.error){e.message+=". "+e.error}}}if(this.stepperAlert){var t=BX.findChildByClassName(this.stepperAlert,"ui-btn-message");BX.adjust(t,{text:BX.util.htmlspecialchars(e.message)});BX.removeClass(this.stepperAlert,"ui-alert-danger");BX.removeClass(this.stepperAlert,"ui-alert-success");BX.removeClass(this.stepperAlert,"ui-alert-warning");if(e.status==="success"){BX.addClass(this.stepperAlert,"ui-alert-success")}else if(e.status==="warning"){BX.addClass(this.stepperAlert,"ui-alert-warning")}else{BX.addClass(this.stepperAlert,"ui-alert-danger")}BX.show(this.stepperAlert)}};t.prototype.alertHide=function(){if(this.stepperAlert){BX.hide(this.stepperAlert)}};return t}();
//# sourceMappingURL=script.map.js