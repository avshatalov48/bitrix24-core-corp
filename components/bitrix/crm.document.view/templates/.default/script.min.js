(function(){BX.namespace("BX.Crm.DocumentViewComponent");BX.Crm.DocumentView=function(){this.pdfUrl="";this.printUrl="";this.downloadUrl="";this.editTemplateUrl="";this.editDocumentUrl="";this.title="";this.values={};this.documentId=null;this.progress=false;this.loader=null;this.changeStampsEnabled=false;this.changeStampsDisabledReason="";this.changeQrCodeEnabled=false;this.changeQrCodeEnabledDisabledReason="";this.myCompanyEditUrl="";this.isTransformationError=false;this.transformationErrorMessage="";this.transformationErrorCode=0;this.isDisplayTransformationErrors=true;this.viewer=null;this.publicUrl=null;this.sendedToSign=false;this.signingInfoHelperSliderCode=null};BX.Crm.DocumentView.init=function(e){this.transformationErrorNode=document.getElementById("crm__document-view--transform-error");this.previewNode=document.getElementById("crm__document-view--node");this.documentId=e.id;this.publicUrl=e.publicUrl;if(BX.type.isBoolean(e.isDisplayTransformationErrors)){this.isDisplayTransformationErrors=e.isDisplayTransformationErrors}delete e.isDisplayTransformationErrors;e.previewNode=this.previewNode;e.transformationErrorNode=this.transformationErrorNode;e.onReady=BX.proxy((function(e){this.showError(false);this.applyOptions(e);this.showPdf()}),this);this.preview=new BX.DocumentGenerator.DocumentPreview(e);this.applyOptions(e);this.initButtons();this.initEvents();if(!e.pdfUrl&&!this.isTransformationError){this.initPreviewMessage(2)}if(e.pdfUrl){var t=this.getViewer();if(t){t.setPdfSource(e.pdfUrl)}this.showPdf()}if(e.documentUrl){window.history.replaceState({},"",e.documentUrl)}BX.Crm.DocumentView.saveDocumentToSliderData()};BX.Crm.DocumentView.applyOptions=function(e){if(e.pdfUrl){this.pdfUrl=e.pdfUrl}if(e.printUrl){this.printUrl=e.printUrl}if(e.downloadUrl){this.downloadUrl=e.downloadUrl}if(e.editTemplateUrl){this.editTemplateUrl=e.editTemplateUrl}if(e.editDocumentUrl){this.editDocumentUrl=e.editDocumentUrl}if(e.values){this.values=e.values}if(e.emailDiskFile){var t=this.getChannelSelector();if(t){t.setFiles([e.emailDiskFile])}}if(e.storageTypeID){this.storageTypeID=e.storageTypeID}if(e.title){this.title=e.title}if(BX.type.isBoolean(e.isTransformationError)){this.isTransformationError=e.isTransformationError}if(BX.type.isBoolean(e.changeStampsEnabled)){this.changeStampsEnabled=e.changeStampsEnabled}if(e.changeStampsDisabledReason){this.changeStampsDisabledReason=e.changeStampsDisabledReason}if(BX.type.isBoolean(e.changeQrCodeEnabled)){this.changeQrCodeEnabled=e.changeQrCodeEnabled}if(e.changeQrCodeDisabledReason){this.changeQrCodeDisabledReason=e.changeQrCodeDisabledReason}if(e.myCompanyEditUrl){this.myCompanyEditUrl=e.myCompanyEditUrl}if(BX.type.isString(e.transformationErrorMessage)){this.transformationErrorMessage=e.transformationErrorMessage}else{this.transformationErrorMessage=""}if(BX.type.isNumber(e.transformationErrorCode)){this.transformationErrorCode=e.transformationErrorCode}if(BX.type.isBoolean(e.isSigningEnabledInCurrentTariff)){this.isSigningEnabledInCurrentTariff=e.isSigningEnabledInCurrentTariff}if(BX.type.isString(e.signingInfoHelperSliderCode)){this.signingInfoHelperSliderCode=e.signingInfoHelperSliderCode.length>0?e.signingInfoHelperSliderCode:null}this.preview.applyOptions(e)};BX.Crm.DocumentView.closeSlider=function(){var e=BX.SidePanel.Instance.getTopSlider();if(e){e.close()}if(BX.PopupMenu.getCurrentMenu()){BX.PopupMenu.getCurrentMenu().popupWindow.close()}};BX.Crm.DocumentView.saveDocumentToSliderData=function(){var e=BX.SidePanel.Instance.getTopSlider();if(e){e.getData().set("document",{id:Number(this.documentId),title:document.getElementById("pagetitle")?document.getElementById("pagetitle").innerText:"",detailUrl:BX.Uri.removeParam(this.editDocumentUrl||"",["mode"]),isWithStamps:document.getElementById("crm-document-stamp").checked})}};BX.Crm.DocumentView.initButtons=function(){const e=document.getElementById("crm-document-stamp");if(e){if(e.parentNode){BX.bind(e.parentNode,"click",BX.proxy(this.showChangeStampsDisabledMessage,this))}BX.bind(document.getElementById("crm-document-stamp"),"change",BX.proxy(this.onChangeStamps,this))}var t=document.getElementById("crm-document-qr");if(t){if(t.parentNode){BX.Event.bind(t.parentNode,"click",this.handleQrCodeInputClick.bind(this))}BX.Event.bind(t,"change",this.handleQrCodeInputChange.bind(this))}BX.bind(document.getElementById("crm-document-edit-template"),"click",BX.proxy((function(e){if(this.editTemplateUrl){if(BX.SidePanel){BX.SidePanel.Instance.open(this.editTemplateUrl,{width:845})}else{top.location.href=this.editTemplateUrl}}e.preventDefault()}),this));BX.bind(document.getElementById("crm-document-print"),"click",BX.proxy((function(){if(this.printUrl){window.open(this.printUrl,"_blank")}else{this.showError(BX.message("CRM_DOCUMENT_VIEW_TRANSFORMATION_PROGRESS"))}}),this));var n=BX.UI.ButtonManager.createFromNode(document.getElementById("crm-document-download"));if(n){n.getMenuButton().bindEvent("click",(function(){var e=n.menuWindow.popupWindow;if(e){e.setWidth(BX.pos(n.getContainer()).width);e.setOffset({offsetLeft:BX.pos(e.bindElement).width-20})}}));BX.Crm.DocumentView.rebindDownloadButtonClick(n);n.setMenu({closeByEsc:true,angle:true,autoHide:true,items:[{text:"PDF",onclick:function(){BX.Crm.DocumentView.downloadPdf(n);BX.userOptions.save("crm.document.view","download_button","format","pdf",false)}},{text:"DOCX",onclick:function(){BX.Crm.DocumentView.downloadDoc(n);BX.userOptions.save("crm.document.view","download_button","format","doc",false)}}]})}BX.bind(document.getElementById("crm-document-edit-document"),"click",BX.proxy((function(){if(BX.SidePanel){var e="";var t=BX.SidePanel.Instance.getSliderByWindow(window);if(t){e=t.getUrl()}BX.SidePanel.Instance.open(this.editDocumentUrl,{width:500,mode:"edit",sliderUrl:e})}else{top.location.href=this.editDocumentUrl}}),this));BX.bind(document.getElementById("crm-document-sign"),"click",BX.proxy((function(e){if(this.sendedToSign){this.showError(BX.message("CRM_DOCUMENT_VIEW_SIGN_CLICKED"));return}if(!this.isSigningEnabledInCurrentTariff){BX.UI.InfoHelper.show(this.signingInfoHelperSliderCode);return}this.sendedToSign=true;if(!this.rightPanelLoader){this.rightPanelLoader=new BX.Loader({size:100,offset:{left:"33%",top:"-10%"}})}this.rightPanelLoader.show(e.currentTarget.closest(".--company-information"));return new Promise(function(e,t){var n=function(e){BX.ajax.runAction("crm.api.integration.sign.convertDeal",{data:{documentId:Number(this.documentId),usePrevious:!e?0:1}}).then(BX.proxy((function(e){if(typeof e.data.SMART_DOCUMENT!=="undefined"){BX.SidePanel.Instance.open("/sign/doc/0/?docId="+e.data.SMART_DOCUMENT+"&stepId=changePartner&noRedirect=Y");this.sendedToSign=false;this.rightPanelLoader.hide();return}this.closeSlider()}),this),BX.proxy((function(e){this.sendedToSign=false;this.rightPanelLoader.hide();this.showError(e.errors.pop().message)}),this))}.bind(this);BX.ajax.runAction("crm.api.integration.sign.getLinkedBlank",{data:{documentId:Number(this.documentId)}}).then(function(e){if(e.data.ID>0){this.showMessage(BX.Loc.getMessage("CRM_DOCUMENT_VIEW_SIGN_DO_USE_PREVIOUS_MSG_MSGVER_3",{"%TITLE%":"<b>"+BX.util.htmlspecialchars(e.data.TITLE||"")+"</b>","%INITIATOR%":"<b>"+BX.util.htmlspecialchars(e.data.INITIATOR||"")+"</b>"}),[new BX.PopupWindowButton({text:BX.message("CRM_DOCUMENT_VIEW_SIGN_OLD_BUTTON_MSGVER_2"),className:"ui-btn ui-btn-md ui-btn-primary",events:{click:function(){n(true);this.popupWindow.destroy()}}}),new BX.PopupWindowButton({text:BX.message("CRM_DOCUMENT_VIEW_SIGN_NEW_BUTTON_MSGVER_3"),className:"ui-btn ui-btn-md ui-btn-info",events:{click:function(){n(false);this.popupWindow.destroy()}}})],BX.message("CRM_DOCUMENT_VIEW_SIGN_POPUP_TITLE_MSGVER_2"),function(){this.sendedToSign=false;this.rightPanelLoader.hide()}.bind(this))}else{n(false)}}.bind(this)).catch((function(){}))}.bind(this))}),this));BX.Event.EventEmitter.subscribe("BX.Crm.ChannelSelector.List:getLink",function(){if(this.publicUrl){return Promise.resolve(this.publicUrl)}else{return new Promise(function(e,t){BX.ajax.runAction("crm.documentgenerator.document.enablePublicUrl",{data:{status:1,id:Number(this.documentId)}}).then(BX.proxy((function(t){this.publicUrl=t.data.publicUrl;e(t.data.publicUrl)}),this),BX.proxy((function(e){t(e.errors.pop().message)}),this))}.bind(this))}}.bind(this))};BX.Crm.DocumentView.showMessage=function(e,t,n,i){n=n||"";if(typeof t==="undefined"||typeof t==="object"&&t.length<=0){t=[new BX.PopupWindowButton({text:BX.message("CRM_DOCUMENT_VIEW_SIGN_POPUP_CLOSE"),className:"ui-btn ui-btn-md ui-btn-default",events:{click:function(e){this.popupWindow.close();BX.PreventDefault(e)}}})]}if(this.popupConfirm!=null){this.popupConfirm.destroy()}if(!BX.type.isDomNode(e)){var o=document.createElement("div");o.innerHTML=e;e=o}if(!BX.type.isArray(e)){e=[e]}this.popupConfirm=new BX.PopupWindow("bx-popup-documentgenerator-popup",null,{zIndex:200,autoHide:true,closeByEsc:true,buttons:t,closeIcon:true,overlay:true,events:{onPopupClose:function(){if(BX.type.isFunction(i)){i()}this.destroy()},onPopupDestroy:BX.delegate((function(){this.popupConfirm=null}),this)},content:BX.create("div",{attrs:{className:"bx-popup-documentgenerator-popup-content-text"},children:e}),titleBar:n,className:"bx-popup-documentgenerator-popup",maxWidth:470});this.popupConfirm.show()};BX.Crm.DocumentView.showError=function(e){if(e===false){if(this.transformationErrorMessage.length>0){this.transformationErrorMessage=e}}var t=document.getElementById("crm-document-view-error");if(e===false&&t){BX.hide(t)}if(!e){return}var n="";if(BX.Type.isArray(e)){n=e.map((function(e){return e.message})).join("\n")}else{n=e}if(t){document.getElementById("crm-document-view-error-message").innerText=n;BX.show(t)}};BX.Crm.DocumentView.showChangeStampsDisabledMessage=function(e){if(this.changeStampsEnabled){return}e.preventDefault();if(this.changeStampsDisabledReason){BX.Crm.DocumentView.showPopupNotice(this.changeStampsDisabledReason)}};BX.Crm.DocumentView.showPopupNotice=function(e){BX.UI.Notification.Center.notify({content:e})};BX.Crm.DocumentView.getChannelSelector=function(){var e=BX.Reflection.getClass("BX.Crm.ChannelSelector.List");if(e){return e.getById("document-channel-selector")}return null};BX.Crm.DocumentView.onChangeStamps=function(){if(this.changeStampsEnabled){this.updateDocument()}};BX.Crm.DocumentView.updateDocument=function(){if(this.progress){return}if(!this.editTemplateUrl){return}this.progress=true;this.pdfUrl="";document.getElementById("crm-document-stamp").disabled=true;var e=0;if(document.getElementById("crm-document-stamp").checked){e=1}var t=document.getElementById("crm-document-qr");if(t&&!t.checked){this.values["PaymentQrCode"]=""}else{this.values["PaymentQrCode"]="this.SOURCE.PAYMENT_QR_CODE"}if(BX.type.isDomNode(this.preview.imageNode)){BX.hide(this.preview.imageNode)}BX.hide(document.getElementById("crm-document-pdf"));BX.hide(this.transformationErrorNode);this.initPreviewMessage(1);this.preview.imageUrl=null;BX.ajax.runAction("crm.documentgenerator.document.update",{data:{stampsEnabled:e,id:this.documentId,values:this.values}}).then(BX.proxy((function(e){this.initPreviewMessage(2);this.progress=false;document.getElementById("crm-document-stamp").disabled=false;this.applyOptions(e.data.document);var t=document.getElementById("pagetitle");if(t&&e.data.document&&e.data.document.title){t.innerText=e.data.document.title}BX.Crm.DocumentView.saveDocumentToSliderData()}),this),BX.proxy((function(e){if(e.data&&e.data.document){this.applyOptions(e.data.document)}this.progress=false;document.getElementById("crm-document-stamp").disabled=false;if(e.data&&e.data.document&&e.data.document.isTransformationError){BX.hide(this.previewNode);BX.show(this.transformationErrorNode)}else{this.initPreviewMessage(0)}this.showError(e.errors.pop().message)}),this))};BX.Crm.DocumentView.initEvents=function(){BX.addCustomEvent("SidePanel.Slider:onMessage",BX.proxy((function(e){if(e.getEventId()==="crm-document-edit"){this.applyOptions(e.getData());this.updateDocument()}}),this))};BX.Crm.DocumentView.initPreviewMessage=function(e){if(e!==2&&e!==0){e=1}BX.show(this.previewNode);if(e===0){BX.hide(document.getElementById("crm__document-view--node-message"));BX.hide(document.getElementById("crm__document-view--node-detail"))}else if(e===1){document.getElementById("crm__document-view--node-message").innerText=BX.message("CRM_DOCUMENT_VIEW_PREVIEW_GENERATION_MESSAGE");BX.show(document.getElementById("crm__document-view--node-message"));BX.hide(document.getElementById("crm__document-view--node-detail"));this.startProgressBar()}else{document.getElementById("crm__document-view--node-message").innerText=BX.message("CRM_DOCUMENT_VIEW_PREVIEW_MESSAGE_PREPARE");document.getElementById("crm__document-view--node-detail").innerText=BX.message("CRM_DOCUMENT_VIEW_PREVIEW_MESSAGE_READY");BX.show(document.getElementById("crm__document-view--node-message"));BX.show(document.getElementById("crm__document-view--node-detail"));this.startProgressBar()}};BX.Crm.DocumentView.startProgressBar=function(){if(!this.loader){this.loader=new BX.Loader({color:"#2fc6f6"})}this.loader.show(document.getElementById("docs-progress-bar"))};BX.Crm.DocumentView.getViewer=function(){if(!this.viewer){const e=document.getElementById("crm-document-pdf");if(!e){return null}this.viewer=new BX.UI.Viewer.SingleDocumentController({baseContainer:e,stretch:true});this.viewer.setItems([BX.UI.Viewer.buildItemByNode(e)])}return this.viewer};BX.Crm.DocumentView.showPdf=function(){BX.show(document.getElementById("crm-document-pdf"));if(this.pdfUrl){var e=BX.Crm.DocumentView.getViewer();if(e){e.setPdfSource(this.pdfUrl);e.setScale(1.2).open(0)}}else if(this.isDisplayTransformationErrors){let e;if(this.transformationErrorMessage){e=this.transformationErrorMessage}else{e=BX.Loc.getMessage("CRM_DOCUMENT_VIEW_COMPONENT_PROCESSED_NO_PDF_ERROR")}this.showError(e)}};BX.Crm.DocumentView.handleQrCodeInputClick=function(e){if(this.changeQrCodeEnabled){return}if(this.changeQrCodeDisabledReason){BX.Crm.DocumentView.showPopupNotice(this.changeQrCodeDisabledReason)}};BX.Crm.DocumentView.handleQrCodeInputChange=function(e){if(this.changeQrCodeEnabled){this.updateDocument()}};BX.Crm.DocumentEdit={};BX.Crm.DocumentEdit.init=function(){BX.bind(document.getElementById("crm-document-edit-spoiler"),"click",(function(){BX.show(document.getElementById("crm-document-edit-all"));BX.hide(document.getElementById("crm-document-edit-spoiler"))}));this.initForm()};BX.Crm.DocumentEdit.initForm=function(){BX.bind(document.getElementById("crm-document-edit-form"),"submit",BX.proxy(this.sendForm,this));BX.bind(document.getElementById("crm-document-edit-save"),"click",BX.proxy(this.sendForm,this));BX.bind(document.getElementById("crm-document-edit-cancel"),"click",BX.proxy(this.closeSlider,this));BX.bindDelegate(document.getElementById("crm-document-edit-form"),"change",{className:"crm-document-edit-select"},BX.proxy(this.refillValues,this))};BX.Crm.DocumentEdit.sendForm=function(e){var t=document.getElementById("crm-document-edit-form");var n="";var i={};for(var o=0;o<t.length;o++){if(t.elements[o].name.indexOf("values")!==0){continue}if(t.elements[o].required&&t.elements[o].value.length<=0){n+="<br />"+BX.message("CRM_DOCUMENT_VIEW_COMPONENT_EDIT_FIELD_ERROR").replace("#FIELD#",t.elements[o].previousSibling.innerText)}var r=t.elements[o].name.slice(7,-1);i[r]=t.elements[o].value}if(n.length<=0){if(BX.SidePanel){e.preventDefault();var s=false;var a=BX.SidePanel.Instance.getSliderByWindow(window);if(a.options.mode==="edit"&&BX.type.isNotEmptyString(a.options.sliderUrl)){s=BX.SidePanel.Instance.getSlider(a.options.sliderUrl)}if(s){BX.SidePanel.Instance.postMessage(a,"crm-document-edit",{values:i});this.closeSlider()}else{var d=a.getUrl();d=BX.util.add_url_param(d,this.collectFormData());a.close();BX.SidePanel.Instance.open(d,{width:980,requestMethod:"post"})}}else{}}else{this.showError(n);e.preventDefault()}};BX.Crm.DocumentEdit.collectFormData=function(){var e=document.getElementById("crm-document-edit-form");var t={};for(var n=0;n<e.length;n++){if(e.elements[n].getAttribute("bx-default")===e.elements[n].value){continue}t[e.elements[n].name]=e.elements[n].value}if(t.documentId&&t.documentId>0){t.id=t.documentId}else if(t.templateId&&t.templateId>0){t.id=t.templateId}return t};BX.Crm.DocumentEdit.closeSlider=function(){if(BX.SidePanel){var e=BX.SidePanel.Instance.getSliderByWindow(window);if(e){e.close()}}};BX.Crm.DocumentEdit.showError=function(e){document.getElementById("crm-document-edit-error").innerHTML=e;BX.show(document.getElementById("crm-document-edit-error"))};BX.Crm.DocumentEdit.refillValues=function(){var e="";var t=this.collectFormData();if(t.documentId>0){e="document"}else{e="template"}BX.ajax.runAction("crm.documentgenerator."+e+".getFields",{data:t}).then((function(t){var n=document.getElementById("crm-document-edit-form");var i=t.data[e+"Fields"];for(var o in i){if(i.hasOwnProperty(o)){if(typeof i[o].value==="object"&&BX.type.isNotEmptyObject(i[o].value)){var r=document.getElementById("field-"+o);if(!r){var s=i[o].group;if(BX.type.isArray(i[o].group)){s=i[o].group[i[o].group.length-1]}var a=document.getElementById("crm-document-edit-group-"+s);if(a){var d=BX.findChild(a,{tag:"h3"});if(d){BX.prepend(BX.create("div",{props:{className:"crm-document-edit-item"},children:[BX.create("label",{props:{className:"crm-document-edit-label"},attrs:{for:"field-"+o},text:i[o].title}),BX.create("select",{props:{className:"crm-document-edit-select"},attrs:{name:"values["+o+"]",id:"field-"+o}})]}),BX.nextSibling(d))}}}}}}for(var m=0;m<n.length;m++){var l=n.elements[m].name;var c=n.elements[m];if(n.elements[m].name.indexOf("values")!==0){if(c.tagName!=="SELECT"){continue}}else{l=n.elements[m].name.slice(7,-1)}c.value="";if(c.tagName==="SELECT"){BX.cleanNode(c);BX.hide(c.parentNode)}if(i.hasOwnProperty(l)){if((BX.type.isString(i[l].value)||BX.type.isNumber(i[l].value)||BX.type.isNull(i[l].value))&&c.tagName==="INPUT"||c.tagName==="TEXTAREA"){c.value=i[l].value;if(i[l].hasOwnProperty("default")){c.setAttribute("bx-default",i[l].default?i[l].default:"")}}else if(typeof i[o].value==="object"&&BX.type.isNotEmptyObject(i[l].value)&&c.tagName==="SELECT"){var u,h;for(u in i[l].value){if(i[l].value.hasOwnProperty(u)){h={value:i[l]["value"][u]["value"]};if(i[l]["value"][u]["selected"]===true){h["selected"]="selected"}c.appendChild(BX.create("option",{attrs:h,text:i[l]["value"][u]["title"]}))}}if(h){BX.show(c.parentNode)}}}}}),BX.proxy((function(e){this.showError(e.errors.pop().message)}),this))};BX.Crm.DocumentView.downloadPdf=function(e){if(this.pdfUrl){window.open(this.pdfUrl,"_blank");BX.addClass(e.getContainer(),"crm__document-view--btn-icon-pdf");BX.removeClass(e.getContainer(),"crm__document-view--btn-icon-doc");BX.Crm.DocumentView.rebindDownloadButtonClick(e)}else if(this.preview.imageUrl){this.showError(BX.message("CRM_DOCUMENT_VIEW_TRANSFORMATION_NO_PDF_ERROR"))}else{this.showError(BX.message("CRM_DOCUMENT_VIEW_TRANSFORMATION_PROGRESS"))}};BX.Crm.DocumentView.downloadDoc=function(e){if(this.downloadUrl&&!this.progress){window.open(this.downloadUrl,"_blank");BX.addClass(e.getContainer(),"crm__document-view--btn-icon-doc");BX.removeClass(e.getContainer(),"crm__document-view--btn-icon-pdf");BX.Crm.DocumentView.rebindDownloadButtonClick(e)}};BX.Crm.DocumentView.rebindDownloadButtonClick=function(e){var t=BX.hasClass(e.getContainer(),"crm__document-view--btn-icon-pdf");e.getMainButton().bindEvent("click",(function(){if(t){BX.Crm.DocumentView.downloadPdf(e)}else{BX.Crm.DocumentView.downloadDoc(e)}}))}})(window);
//# sourceMappingURL=script.map.js