(function(){BX.namespace("BX.Crm.DocumentViewComponent");BX.Crm.DocumentView=function(){this.pdfUrl="";this.printUrl="";this.downloadUrl="";this.editTemplateUrl="";this.editDocumentUrl="";this.title="";this.values={};this.documentId=null;this.progress=false;this.loader=null;this.changeStampsEnabled=false;this.changeStampsDisabledReason="";this.changeQrCodeEnabled=false;this.changeQrCodeEnabledDisabledReason="";this.myCompanyEditUrl="";this.isTransformationError=false;this.transformationErrorMessage="";this.transformationErrorCode=0;this.viewer=null;this.publicUrl=null};BX.Crm.DocumentView.init=function(e){this.transformationErrorNode=document.getElementById("crm__document-view--transform-error");this.previewNode=document.getElementById("crm__document-view--node");this.documentId=e.id;this.publicUrl=e.publicUrl;e.previewNode=this.previewNode;e.transformationErrorNode=this.transformationErrorNode;e.onReady=BX.proxy((function(e){this.applyOptions(e);this.showError(false);this.showPdf()}),this);this.preview=new BX.DocumentGenerator.DocumentPreview(e);this.applyOptions(e);this.initButtons();this.initEvents();if(!e.pdfUrl&&!this.isTransformationError){this.initPreviewMessage(2)}if(e.pdfUrl){var t=this.getViewer();if(t){t.setPdfSource(e.pdfUrl)}this.showPdf()}if(e.documentUrl){window.history.replaceState({},"",e.documentUrl)}BX.Crm.DocumentView.saveDocumentToSliderData()};BX.Crm.DocumentView.applyOptions=function(e){if(e.pdfUrl){this.pdfUrl=e.pdfUrl}if(e.printUrl){this.printUrl=e.printUrl}if(e.downloadUrl){this.downloadUrl=e.downloadUrl}if(e.editTemplateUrl){this.editTemplateUrl=e.editTemplateUrl}if(e.editDocumentUrl){this.editDocumentUrl=e.editDocumentUrl}if(e.values){this.values=e.values}if(e.emailDiskFile){var t=this.getChannelSelector();if(t){t.setFiles([e.emailDiskFile])}}if(e.storageTypeID){this.storageTypeID=e.storageTypeID}if(e.title){this.title=e.title}if(BX.type.isBoolean(e.isTransformationError)){this.isTransformationError=e.isTransformationError}if(BX.type.isBoolean(e.changeStampsEnabled)){this.changeStampsEnabled=e.changeStampsEnabled}if(e.changeStampsDisabledReason){this.changeStampsDisabledReason=e.changeStampsDisabledReason}if(BX.type.isBoolean(e.changeQrCodeEnabled)){this.changeQrCodeEnabled=e.changeQrCodeEnabled}if(e.changeQrCodeDisabledReason){this.changeQrCodeDisabledReason=e.changeQrCodeDisabledReason}if(e.myCompanyEditUrl){this.myCompanyEditUrl=e.myCompanyEditUrl}if(BX.type.isString(e.transformationErrorMessage)){this.transformationErrorMessage=e.transformationErrorMessage}else{this.transformationErrorMessage=""}if(BX.type.isNumber(e.transformationErrorCode)){this.transformationErrorCode=e.transformationErrorCode}this.preview.applyOptions(e)};BX.Crm.DocumentView.closeSlider=function(){var e=BX.SidePanel.Instance.getTopSlider();if(e){e.close()}if(BX.PopupMenu.getCurrentMenu()){BX.PopupMenu.getCurrentMenu().popupWindow.close()}};BX.Crm.DocumentView.saveDocumentToSliderData=function(){var e=BX.SidePanel.Instance.getTopSlider();if(e){e.getData().set("document",{id:Number(this.documentId),title:document.getElementById("pagetitle")?document.getElementById("pagetitle").innerText:"",detailUrl:BX.Uri.removeParam(this.editDocumentUrl||"",["mode"]),isWithStamps:document.getElementById("crm-document-stamp").checked})}};BX.Crm.DocumentView.initButtons=function(){BX.bind(document.getElementById("crm-document-stamp"),"click",BX.proxy(this.showChangeStampsDisabledMessage,this));BX.bind(document.getElementById("crm-document-stamp"),"change",BX.proxy(this.onChangeStamps,this));var e=document.getElementById("crm-document-qr");if(e){BX.Event.bind(e,"click",this.handleQrCodeInputClick.bind(this));BX.Event.bind(e,"change",this.handleQrCodeInputChange.bind(this))}BX.bind(document.getElementById("crm-document-edit-template"),"click",BX.proxy((function(e){if(this.editTemplateUrl){if(BX.SidePanel){BX.SidePanel.Instance.open(this.editTemplateUrl,{width:845})}else{top.location.href=this.editTemplateUrl}}e.preventDefault()}),this));BX.bind(document.getElementById("crm-document-print"),"click",BX.proxy((function(){if(this.printUrl){window.open(this.printUrl,"_blank")}else{this.showError(BX.message("CRM_DOCUMENT_VIEW_TRANSFORMATION_PROGRESS"))}}),this));var t=BX.UI.ButtonManager.createFromNode(document.getElementById("crm-document-download"));if(t){t.setMenu({items:[{text:"PDF",onclick:function(){if(this.pdfUrl){window.open(this.pdfUrl,"_blank")}else if(this.preview.imageUrl){this.showError(BX.message("CRM_DOCUMENT_VIEW_TRANSFORMATION_NO_PDF_ERROR"))}else{this.showError(BX.message("CRM_DOCUMENT_VIEW_TRANSFORMATION_PROGRESS"))}}.bind(this)},{text:"DOCX",onclick:function(){if(this.downloadUrl&&!this.progress){window.open(this.downloadUrl,"_blank")}}.bind(this)}]})}BX.bind(document.getElementById("crm-document-edit-document"),"click",BX.proxy((function(){if(BX.SidePanel){var e="";var t=BX.SidePanel.Instance.getSliderByWindow(window);if(t){e=t.getUrl()}BX.SidePanel.Instance.open(this.editDocumentUrl,{width:500,mode:"edit",sliderUrl:e})}else{top.location.href=this.editDocumentUrl}}),this));BX.Event.EventEmitter.subscribe("BX.Crm.ChannelSelector.List:getLink",function(){if(this.publicUrl){return Promise.resolve(this.publicUrl)}else{return new Promise(function(e,t){BX.ajax.runAction("crm.documentgenerator.document.enablePublicUrl",{data:{status:1,id:Number(this.documentId)}}).then(BX.proxy((function(t){this.publicUrl=t.data.publicUrl;e(t.data.publicUrl)}),this),BX.proxy((function(e){t(e.errors.pop().message)}),this))}.bind(this))}}.bind(this))};BX.Crm.DocumentView.showError=function(e){if(e===false){if(this.transformationErrorMessage.length>0){this.transformationErrorMessage=e}}var t=document.getElementById("crm-document-view-error");if(e===false&&t){BX.hide(t)}if(!e){return}var i="";if(BX.Type.isArray(e)){i=e.map((function(e){return e.message})).join("\n")}else{i=e}if(t){document.getElementById("crm-document-view-error-message").innerText=i;BX.show(t)}};BX.Crm.DocumentView.showChangeStampsDisabledMessage=function(e){if(this.changeStampsEnabled){return}e.preventDefault();if(this.changeStampsDisabledReason){BX.Crm.DocumentView.showPopupNotice(this.changeStampsDisabledReason)}};BX.Crm.DocumentView.showPopupNotice=function(e){BX.UI.Notification.Center.notify({content:e})};BX.Crm.DocumentView.getChannelSelector=function(){var e=BX.Reflection.getClass("BX.Crm.ChannelSelector.List");if(e){return e.getById("document-channel-selector")}return null};BX.Crm.DocumentView.onChangeStamps=function(){if(this.changeStampsEnabled){this.updateDocument()}};BX.Crm.DocumentView.updateDocument=function(){if(this.progress){return}if(!this.editTemplateUrl){return}this.progress=true;this.pdfUrl="";document.getElementById("crm-document-stamp").disabled=true;var e=0;if(document.getElementById("crm-document-stamp").checked){e=1}var t=document.getElementById("crm-document-qr");if(t&&!t.checked){this.values["PaymentQrCode"]=""}else{this.values["PaymentQrCode"]="this.SOURCE.PAYMENT_QR_CODE"}if(BX.type.isDomNode(this.preview.imageNode)){BX.hide(this.preview.imageNode)}BX.hide(document.getElementById("crm-document-pdf"));BX.hide(this.transformationErrorNode);this.initPreviewMessage(1);this.preview.imageUrl=null;BX.ajax.runAction("crm.documentgenerator.document.update",{data:{stampsEnabled:e,id:this.documentId,values:this.values}}).then(BX.proxy((function(e){this.initPreviewMessage(2);this.progress=false;document.getElementById("crm-document-stamp").disabled=false;this.applyOptions(e.data.document);var t=document.getElementById("pagetitle");if(t&&e.data.document&&e.data.document.title){t.innerText=e.data.document.title}BX.Crm.DocumentView.saveDocumentToSliderData()}),this),BX.proxy((function(e){if(e.data&&e.data.document){this.applyOptions(e.data.document)}this.progress=false;document.getElementById("crm-document-stamp").disabled=false;if(e.data&&e.data.document&&e.data.document.isTransformationError){BX.hide(this.previewNode);BX.show(this.transformationErrorNode)}else{this.initPreviewMessage(0)}this.showError(e.errors.pop().message)}),this))};BX.Crm.DocumentView.initEvents=function(){BX.addCustomEvent("SidePanel.Slider:onMessage",BX.proxy((function(e){if(e.getEventId()==="crm-document-edit"){this.applyOptions(e.getData());this.updateDocument()}}),this))};BX.Crm.DocumentView.initPreviewMessage=function(e){if(e!==2&&e!==0){e=1}BX.show(this.previewNode);if(e===0){BX.hide(document.getElementById("crm__document-view--node-message"));BX.hide(document.getElementById("crm__document-view--node-detail"))}else if(e===1){document.getElementById("crm__document-view--node-message").innerText=BX.message("CRM_DOCUMENT_VIEW_PREVIEW_GENERATION_MESSAGE");BX.show(document.getElementById("crm__document-view--node-message"));BX.hide(document.getElementById("crm__document-view--node-detail"));this.startProgressBar()}else{document.getElementById("crm__document-view--node-message").innerText=BX.message("CRM_DOCUMENT_VIEW_PREVIEW_MESSAGE_PREPARE");document.getElementById("crm__document-view--node-detail").innerText=BX.message("CRM_DOCUMENT_VIEW_PREVIEW_MESSAGE_READY");BX.show(document.getElementById("crm__document-view--node-message"));BX.show(document.getElementById("crm__document-view--node-detail"));this.startProgressBar()}};BX.Crm.DocumentView.startProgressBar=function(){if(!this.loader){this.loader=new BX.Loader({color:"#2fc6f6"})}this.loader.show(document.getElementById("docs-progress-bar"))};BX.Crm.DocumentView.getViewer=function(){if(!this.viewer){const e=document.getElementById("crm-document-pdf");if(!e){return null}this.viewer=new BX.UI.Viewer.SingleDocumentController({baseContainer:e,stretch:true});this.viewer.setItems([BX.UI.Viewer.buildItemByNode(e)])}return this.viewer};BX.Crm.DocumentView.showPdf=function(){BX.show(document.getElementById("crm-document-pdf"));if(this.pdfUrl){var e=BX.Crm.DocumentView.getViewer();if(e){e.setPdfSource(this.pdfUrl);e.setScale(1.2).open(0)}}else{this.showError(BX.message("CRM_DOCUMENT_VIEW_COMPONENT_PROCESSED_NO_PDF_ERROR"))}};BX.Crm.DocumentView.handleQrCodeInputClick=function(e){if(this.changeQrCodeEnabled){return}if(this.changeQrCodeDisabledReason){BX.Crm.DocumentView.showPopupNotice(this.this.changeQrCodeDisabledReason)}};BX.Crm.DocumentView.handleQrCodeInputChange=function(e){if(this.changeQrCodeEnabled){this.updateDocument()}};BX.Crm.DocumentEdit={};BX.Crm.DocumentEdit.init=function(){BX.bind(document.getElementById("crm-document-edit-spoiler"),"click",(function(){BX.show(document.getElementById("crm-document-edit-all"));BX.hide(document.getElementById("crm-document-edit-spoiler"))}));this.initForm()};BX.Crm.DocumentEdit.initForm=function(){BX.bind(document.getElementById("crm-document-edit-form"),"submit",BX.proxy(this.sendForm,this));BX.bind(document.getElementById("crm-document-edit-save"),"click",BX.proxy(this.sendForm,this));BX.bind(document.getElementById("crm-document-edit-cancel"),"click",BX.proxy(this.closeSlider,this));BX.bindDelegate(document.getElementById("crm-document-edit-form"),"change",{className:"crm-document-edit-select"},BX.proxy(this.refillValues,this))};BX.Crm.DocumentEdit.sendForm=function(e){var t=document.getElementById("crm-document-edit-form");var i="";var n={};for(var r=0;r<t.length;r++){if(t.elements[r].name.indexOf("values")!==0){continue}if(t.elements[r].required&&t.elements[r].value.length<=0){i+="<br />"+BX.message("CRM_DOCUMENT_VIEW_COMPONENT_EDIT_FIELD_ERROR").replace("#FIELD#",t.elements[r].previousSibling.innerText)}var o=t.elements[r].name.slice(7,-1);n[o]=t.elements[r].value}if(i.length<=0){if(BX.SidePanel){e.preventDefault();var s=false;var a=BX.SidePanel.Instance.getSliderByWindow(window);if(a.options.mode==="edit"&&BX.type.isNotEmptyString(a.options.sliderUrl)){s=BX.SidePanel.Instance.getSlider(a.options.sliderUrl)}if(s){BX.SidePanel.Instance.postMessage(a,"crm-document-edit",{values:n});this.closeSlider()}else{var d=a.getUrl();d=BX.util.add_url_param(d,this.collectFormData());a.close();BX.SidePanel.Instance.open(d,{width:980,requestMethod:"post"})}}else{}}else{this.showError(i);e.preventDefault()}};BX.Crm.DocumentEdit.collectFormData=function(){var e=document.getElementById("crm-document-edit-form");var t={};for(var i=0;i<e.length;i++){if(e.elements[i].getAttribute("bx-default")===e.elements[i].value){continue}t[e.elements[i].name]=e.elements[i].value}if(t.documentId&&t.documentId>0){t.id=t.documentId}else if(t.templateId&&t.templateId>0){t.id=t.templateId}return t};BX.Crm.DocumentEdit.closeSlider=function(){if(BX.SidePanel){var e=BX.SidePanel.Instance.getSliderByWindow(window);if(e){e.close()}}};BX.Crm.DocumentEdit.showError=function(e){document.getElementById("crm-document-edit-error").innerHTML=e;BX.show(document.getElementById("crm-document-edit-error"))};BX.Crm.DocumentEdit.refillValues=function(){var e="";var t=this.collectFormData();if(t.documentId>0){e="document"}else{e="template"}BX.ajax.runAction("crm.documentgenerator."+e+".getFields",{data:t}).then((function(t){var i=document.getElementById("crm-document-edit-form");var n=t.data[e+"Fields"];for(var r in n){if(n.hasOwnProperty(r)){if(typeof n[r].value==="object"&&BX.type.isNotEmptyObject(n[r].value)){var o=document.getElementById("field-"+r);if(!o){var s=n[r].group;if(BX.type.isArray(n[r].group)){s=n[r].group[n[r].group.length-1]}var a=document.getElementById("crm-document-edit-group-"+s);if(a){var d=BX.findChild(a,{tag:"h3"});if(d){BX.prepend(BX.create("div",{props:{className:"crm-document-edit-item"},children:[BX.create("label",{props:{className:"crm-document-edit-label"},attrs:{for:"field-"+r},text:n[r].title}),BX.create("select",{props:{className:"crm-document-edit-select"},attrs:{name:"values["+r+"]",id:"field-"+r}})]}),BX.nextSibling(d))}}}}}}for(var m=0;m<i.length;m++){var l=i.elements[m].name;var c=i.elements[m];if(i.elements[m].name.indexOf("values")!==0){if(c.tagName!=="SELECT"){continue}}else{l=i.elements[m].name.slice(7,-1)}c.value="";if(c.tagName==="SELECT"){BX.cleanNode(c);BX.hide(c.parentNode)}if(n.hasOwnProperty(l)){if((BX.type.isString(n[l].value)||BX.type.isNumber(n[l].value)||BX.type.isNull(n[l].value))&&c.tagName==="INPUT"||c.tagName==="TEXTAREA"){c.value=n[l].value;if(n[l].hasOwnProperty("default")){c.setAttribute("bx-default",n[l].default?n[l].default:"")}}else if(typeof n[r].value==="object"&&BX.type.isNotEmptyObject(n[l].value)&&c.tagName==="SELECT"){var u,h;for(u in n[l].value){if(n[l].value.hasOwnProperty(u)){h={value:n[l]["value"][u]["value"]};if(n[l]["value"][u]["selected"]===true){h["selected"]="selected"}c.appendChild(BX.create("option",{attrs:h,text:n[l]["value"][u]["title"]}))}}if(h){BX.show(c.parentNode)}}}}}),BX.proxy((function(e){this.showError(e.errors.pop().message)}),this))}})(window);
//# sourceMappingURL=script.map.js