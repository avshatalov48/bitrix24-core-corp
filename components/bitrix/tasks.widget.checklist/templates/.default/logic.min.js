"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetCheckList!="undefined"){return}BX.Tasks.Component.TasksWidgetCheckList=BX.Tasks.Component.extend({sys:{code:"checklist"},options:{confirmDelete:false},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);this.getManager()},getManager:function(){return this.subInstance("manager",function(){var t=new this.constructor.ItemManager({scope:this.scope(),data:this.option("data"),preRendered:true,confirmDelete:this.option("confirmDelete"),enableSync:this.option("enableSync"),entityRoute:this.option("entityRoute"),entityId:this.option("entityId")});t.bindEvent("change",this.onManagerChange.bind(this));return t})},bindEvents:function(){this.bindControl("toggle-complete","click",this.onCompleteTogglerClick.bind(this))},onCompleteTogglerClick:function(){var t=this.control("is-items-complete");this.toggleCompleted(BX.hasClass(t,"invisible"))},onManagerChange:function(t){var e=0;var i=0;var n=1;var o=1;this.getManager().each(function(t){if(!t.isSeparator()){if(t.isChecked()){i++}e++;t.data().NUMBER=o++}t.data().SORT=t.data().SORT_INDEX=n++;t.sort(t.data().NUMBER)});this.control("total-counter").innerHTML=e;BX.Tasks.each(this.controlAll("complete-counter"),function(t){t.innerHTML=i});this.showHideCompleted(!i);if(!i){this.toggleCompleted(false)}BX[i?"removeClass":"addClass"](this.control("top-counter-set"),"invisible")},showHideCompleted:function(t){this.changeCSSFlag("hidden",t,this.control("complete-block"))},toggleCompleted:function(t){var e=this.control("is-items-complete");BX.Tasks.Util.fadeSlideToggleByClass(e);this.changeCSSFlag("down",t,this.control("toggle-complete"))},count:function(){return this.getManager().count()},openForm:function(){this.getManager().openAddForm()}}});BX.Tasks.Component.TasksWidgetCheckList.ItemManager=BX.Tasks.Util.ItemSet.extend({sys:{code:"checklist-is"},options:{controlBind:"class",itemFx:"vertical",confirmDelete:false,useDragNDrop:true,enableSync:false},methods:{bindEvents:function(){this.callMethod(BX.Tasks.Util.ItemSet,"bindEvents");this.bindControl("add-separator","click",this.onAddSeparatorClick.bind(this));this.vars.formInitialized=false},bindItemActions:function(){this.callMethod(BX.Tasks.Util.ItemSet,"bindItemActions");this.bindOnItemEx("i-toggle","mouseup",this.onItemToggleClick);this.bindOnItemEx("i-toggle","change",this.onItemToggleChange);this.bindOnItemEx("i-edit","click",this.onItemEditClick);this.bindOnItemEx("i-apply","click",this.onItemApplyClick);this.bindOnItemEx("i-new-title","keypress",this.onItemNewTitleKeyPress)},bindDNDDropZones:function(t){this.callMethod(BX.Tasks.Util.ItemSet,"bindDNDDropZones",arguments);t.bindDropZone(this.control("items-complete"))},onDragNDropItemRelocatedAfter:function(t,e,i){var n=this.getItemByNode(e);if(n){var o=[];var s=n.isChecked();var r=i.zone==this.control("items-complete");if(r!=s){n.isChecked(r);o.push([r?"complete":"renew",{id:n.value()}])}var a=null;if(i.after!==null){a=this.getItemByNode(i.after)}if(r&&a===null){a=this.findLastUnCheckedItem()}if(!a||a.value()!=n.value()){o.push(["moveAfter",{id:n.value(),afterId:a?a.value():0}])}this.getSyncer().perform(o);this.callMethod(BX.Tasks.Util.ItemSet,"onDragNDropItemRelocatedAfter",arguments)}},onItemDeleteByCross:function(t){if(t.isEditMode()){this.toggleItemMode(false,t)}else{var e=arguments;if(this.option("confirmDelete")){BX.Tasks.confirmDelete(BX.message("TASKS_TTDP_CHECKLIST_ENTITY_NAME")).then(function(){this.deleteItemRemote.apply(this,e)}.bind(this))}else{this.deleteItemRemote.apply(this,e)}}},deleteItemRemote:function(t){var e=arguments;this.getSyncer().perform([["delete",{id:t.value()}]]).then(function(){this.callMethod(BX.Tasks.Util.ItemSet,"onItemDeleteByCross",e)}.bind(this))},onItemEditClick:function(t){this.toggleItemMode(false,t)},onItemApplyClick:function(t){this.toggleItemMode(true,t)},onItemToggleClick:function(t,e,i){if(t.isLockedCheck()){BX.eventReturnFalse(i||Window.event)}},onItemToggleChange:function(t){var e=function(t){this.getSyncer().perform([[t.isChecked()?"complete":"renew",{id:t.value()}]])}.bind(this);this.getStriker().toggle(t.control("title"),function(){t.isChecked(true);e(t);this.insertItemBefore(t,this.findItemBefore(t,true),true)}.bind(this),function(){t.isChecked(false);e(t);this.insertItemBefore(t,this.findItemBefore(t,false),false)}.bind(this))},onItemNewTitleKeyPress:function(t,e,i){i=i||Window.event;if(BX.Tasks.Util.isEnter(i)){this.toggleItemMode(true,t);BX.eventReturnFalse(i)}},insertItemBefore:function(t,e,i){var n=new BX.Promise;var o=this.control(i?"items-complete":"items");if(o){t.isLockedCheck(true);t.disappear().then(function(){if(e===null){BX.append(t.scope(),o)}else{o.insertBefore(t.scope(),e.scope())}t.appear().then(function(){t.isLockedCheck(false);n.resolve();this.fireEvent("change",[this.vars.order])}.bind(this),function(){t.isLockedCheck(false)})}.bind(this),function(){t.isLockedCheck(false)})}else{n.reject()}return n},findItemBefore:function(t,e){var i=t.data().SORT;var n=null;var o=this.first();this.each(function(t){if(!(e&&!t.isChecked())&&!(!e&&t.isChecked())){o=t}if(o.data().SORT>i){n=t;return false}});return n},findLastUnCheckedItem:function(){var t=0;var e=false;this.each(function(i){if(i.sort()>t&&!i.isChecked()){t=i.sort();e=i.value()}});return e===null?null:this.get(e)},openAddForm:function(){var t=this.control("add-item-form");if(t){if(!this.vars.formInitialized){this.bindControl("form-close","click",this.onFormCloseClick.bind(this));this.bindControl("form-submit","click",this.onFormSubmitClick.bind(this));this.bindControl("form-title","keypress",this.onFormTitleKeyPress.bind(this));this.vars.formInitialized=true}this.addItemByForm();this.clearForm();this.toggleForm(true).then(function(){if(!BX.hasClass(this.control("add-item-form"),"invisible")){this.focusForm()}}.bind(this))}},onAddSeparatorClick:function(){this.addItemRemote(this.makeItemData("==="))},onFormCloseClick:function(){this.toggleForm();this.clearForm()},onFormSubmitClick:function(){this.addItemByForm()},onFormTitleKeyPress:function(t){t=t||Window.event;if(BX.Tasks.Util.isEnter(t)){this.addItemByForm();BX.eventReturnFalse(t)}},addItemByForm:function(){var t=this.control("form-title").value;if(!t.length){return false}if(!this.opts.enableSync){t=BX.util.htmlspecialchars(t)}this.addItemRemote(this.makeItemData(t));return true},addItemRemote:function(t){this.lockInput();this.getSyncer().perform([["add",{data:{_OWNER_ENTITY_ID_:this.option("entityId"),TITLE:t.TITLE}},{code:"item-add"}]]).then(function(e){if(e){var i=e.getData()["item-add"].RESULT;var n=0;if("DATA"in i){n=i.DATA.ID}else{n=i.ID}t.VALUE=parseInt(n);t.DISPLAY=i.DATA.DISPLAY;t.TITLE=i.DATA.TITLE}this.addItem(t);this.clearForm();this.unLockInput();this.focusForm()}.bind(this),function(){this.unLockInput()}.bind(this))},clearForm:function(){this.control("form-title").value=""},toggleForm:function(t){var e=this.control("add-item-form");if(t&&!BX.hasClass(e,"invisible")){var i=new BX.Promise;i.resolve();return i}return BX.Tasks.Util.fadeSlideToggleByClass(this.control("add-item-form"))},focusForm:function(){this.control("form-title").focus()},lockInput:function(){BX.Tasks.Util.disable(this.control("form-title"))},unLockInput:function(){BX.Tasks.Util.enable(this.control("form-title"))},toggleItemMode:function(t,e){if(e.isEditMode()){if(t){var i=e.control("new-title").value;if(!i.length){return}e.lockInput();this.getSyncer().perform([["update",{id:e.value(),data:{TITLE:i}},{code:"item-update"}]]).then(function(t){if(t){var n=t.getData()["item-update"].RESULT;e.title(n.DATA.TITLE,n.DATA.DISPLAY)}else{e.title(i,BX.util.htmlspecialchars(i))}e.toggleMode();e.unLockInput()},function(){e.unLockInput()})}else{e.toggleMode()}}else{e.control("new-title").value=BX.util.htmlspecialcharsback(e.data().TITLE);e.toggleMode()}},makeItemData:function(t){var e=this.getGreatestSort();return{CHECKED:0,SORT:e["sort"]+1,SORT_INDEX:e["sort"]+1,NUMBER:e["number"]+1,TITLE:t,ACTION_UPDATE:true,ACTION_DELETE:true,ACTION_TOGGLE:true}},getGreatestSort:function(){var t={sort:0,number:0};this.each(function(e){var i=e.data().SORT;var n=e.data().NUMBER;if(i>t.sort){t.sort=i}if(!e.isSeparator()&&n>t.number){t.number=n}});return t},getItemClass:function(){return this.constructor.Item},getStriker:function(){return this.subInstance("striker",function(){return new t({duration:500,postTimeout:100})})},getSyncer:function(){return this.subInstance("sync",function(){return new e({enabled:this.option("enableSync"),routePrefix:this.option("entityRoute")})})},getItemDeleteControlId:function(){return"i-delete"}}});BX.Tasks.Component.TasksWidgetCheckList.ItemManager.Item=BX.Tasks.Util.ItemSet.Item.extend({sys:{code:"checklist-is-i"},options:{controlBind:"class"},methods:{isEditMode:function(){return!!this.vars.modeEdit},lockInput:function(){BX.Tasks.Util.disable(this.control("new-title"))},unLockInput:function(){BX.Tasks.Util.enable(this.control("new-title"))},toggleMode:function(){this.setCSSMode("mode",this.vars.modeEdit?"read":"edit");this.vars.modeEdit=!this.vars.modeEdit},title:function(t,e){if(typeof t!="undefined"){this.data().TITLE=t;this.data().DISPLAY=e;this.control("title").innerHTML=this.data().DISPLAY;this.control("title-field").value=this.data().TITLE;if(this.constructor.isSeparatorValue(t)){this.data().APPEARANCE="a-separator";this.setCSSMode("a","separator")}return}return this.data().TITLE},sort:function(t){if(typeof t!="undefined"){t=parseInt(t);this.control("number").innerHTML=t;this.control("sort-fld").value=this.data().SORT;return}return this.data().SORT},isChecked:function(t){if(typeof t!="undefined"){t=!!t;this.data().CHECKED=t?"1":"0";this.data().IS_COMPLETE=t?"Y":"N";this.control("toggle").checked=t;var e=t?"1":"0";if(this.parent().parent().option("compatibilityMode")){e=t?"Y":"N"}this.control("complete-fld").value=e;if(t){this.changeCSSFlag("stroke-out",true,this.control("title"))}else{this.parent().getStriker().unStrike(this.control("title"))}}return this.data().CHECKED=="1"},isLockedCheck:function(t){if(typeof t!=="undefined"){this.vars.checkLocked=!!t;return}return this.vars.checkLocked},isSeparator:function(){return this.constructor.isSeparatorValue(this.data().TITLE)}},methodsStatic:{extractValue:function(t){if("VALUE"in t){return t.VALUE}t.VALUE="n"+Math.abs(BX.util.hashCode(Math.random().toString()+Math.random().toString()));if(!("ID"in t)){t.ID=""}return t.VALUE},prepareDataSt:function(t){t.DISPLAY=t.DISPLAY||t.TITLE;t.APPEARANCE=this.isSeparatorValue(t.TITLE)?"a-separator":"a-generic";var e=t.CHECKED=="1";t.READONLY=t.ACTION_UPDATE?"":"noedit";t.CHECKED_ATTRIBUTE=e?"checked":"";t.DISABLED_ATTRIBUTE="";t.IS_COMPLETE=e?"Y":"N";t.STROKE_CSS=e?"stroke-out":"";if(this.isSeparatorValue(t.TITLE)){t.NUMBER=0}t.SORT_INDEX=t.SORT;t.ITEM_SET_INVISIBLE="invisible";return t},isSeparatorValue:function(t){t=t.toString().replace(/^\s+/,"").replace(/\s+$/,"");return!!t.match(/^(-|=|_|\*|\+){3,}$/)}}});var t=function(t){this.duration=t.duration||500;this.postTimeout=t.postTimeout||1;this.textChunkSize=t.textChunkSize||20;this.animations={}};t.prototype={addAnimation:function(t){var e=BX.util.hashCode(Math.random().toString()+Math.random().toString());this.animations[e]=t;return e},getAnimation:function(t){return this.animations[t]},removeAnimation:function(t,e){var i=this.getAnimation(t);if(i){clearTimeout(i.timer);var n=i.pr;delete this.animations[t];if(e){n.fulfill()}else{n.reject()}return n}return null},getAnimationKeyByBlock:function(t){var e=null;BX.Tasks.each(this.animations,function(i,n){if(i.block===t){e=n;return false}});return e},toggle:function(t,e,i){var n=this.getAnimationKeyByBlock(t);if(!n){if(BX.hasClass(t,"stroke-out")){this.unStrike(t).then(i)}else{this.strike(t).then(e)}}else{this.cancelStrikeAnimation(t,n)}},strike:function(t){var e=new BX.Promise;var i=t.childNodes.length;if(!i){e.resolve();return}var n=[];var o,s;for(o=0;o<t.childNodes.length;){var r=t.childNodes[o];if(r.nodeType==Node.TEXT_NODE){n=this.strSplit(r.textContent,this.textChunkSize);for(s=0;s<n.length;s++){t.insertBefore(BX.create("span",{text:n[s]}),r)}t.removeChild(r);o+=n.length}else{o++}}var a=t.childNodes.length;var l=this.addAnimation({block:t,tmOut:Math.floor(this.duration/a),k:0,length:a,pr:e,timer:null});var c=this.getAnimation(l);var h=function(){c.timer=setTimeout(function(){BX.addClass(c.block.childNodes[c.k],"chunk-stroke-out");c.k++;if(c.k<c.length){h()}else{c.timer=setTimeout(function(){this.removeAnimation(l,true);BX.addClass(c.block,"stroke-out")}.bind(this),this.postTimeout)}}.bind(this),c.tmOut)}.bind(this);h();return e},unStrike:function(t){this.clearStrike(t);var e=new BX.Promise;e.fulfill();return e},clearStrike:function(t){for(k=0;k<t.childNodes.length;k++){BX.removeClass(t.childNodes[k],"chunk-stroke-out")}BX.removeClass(t,"stroke-out")},cancelStrikeAnimation:function(t,e){if(!e){e=this.getAnimationKeyByBlock(t)}if(e){this.clearStrike(t);return this.removeAnimation(e,false)}return null},strSplit:function(t,e){var i=[];var n="";var o=0;while(t.length){if(o>100){break}n=t.substr(0,e);t=t.slice(e);if(!t.length&&n.length<4&&i.length>0){i[i.length-1]+=n}else{i.push(n)}o++}return i}};var e=function(t){this.enabled=!!t.enabled;this.prefix=t.routePrefix||"";this.sLock=false;this.query=null};e.prototype={getQuery:function(){if(this.query===null){this.query=new BX.Tasks.Util.Query}return this.query},perform:function(t){var e=new BX.Promise;if(!this.enabled){e.resolve();return e}if(this.sLock){e.reject();return e}var i=this.getQuery();this.sLock=true;var n=[];for(var o=0;o<t.length;o++){n.push({m:this.prefix+".checklist."+t[o][0],args:t[o][1],rp:t[o][2]})}i.load(n).execute().then(function(t){this.sLock=false;e.resolve(t)}.bind(this),function(t){this.sLock=false;e.reject(t)}.bind(this));return e}}}).call(this);
//# sourceMappingURL=logic.map.js