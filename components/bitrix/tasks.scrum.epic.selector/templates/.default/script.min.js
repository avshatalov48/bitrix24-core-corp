this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(e,t,i,r){"use strict";var s,a,n;var o=function(){function e(t){babelHelpers.classCallCheck(this,e);this.groupId=t.groupId;this.taskId=t.taskId;this.epic=t.epic;this.canEdit=t.canEdit;this.dialog=null;this.node=null;this.nameNode=null;this.selectorNode=null;i.EventEmitter.subscribe("onChangeProjectLink",this.onChangeTaskProject.bind(this))}babelHelpers.createClass(e,[{key:"renderTo",value:function e(i){t.Dom.append(this.render(),i)}},{key:"render",value:function e(){this.node=t.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div>\n\t\t\t\t","\n\t\t\t\t","\n\t\t\t</div>\n\t\t"])),this.renderName(),this.renderSelector());return this.node}},{key:"onChangeTaskProject",value:function e(t){var i=t.getCompatData(),r=babelHelpers.slicedToArray(i,2),s=r[0],a=r[1];this.groupId=parseInt(s,10);this.taskId=parseInt(a,10);this.epic=null;this.dialog=null;this.updateSelector(null)}},{key:"renderName",value:function e(){if(t.Type.isNull(this.epic)){return""}var i=this.convertHexToRGBA(this.epic.color,.7);var r=this.convertHexToRGBA(this.epic.color,.3);this.nameNode=t.Tag.render(a||(a=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div\n\t\t\t\tclass="tasks-scrum__epic-selector--epic"\n\t\t\t\tstyle="background: ',"; border-color: ",';"\n\t\t\t>\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"])),r,i,t.Text.encode(this.epic.name));return this.nameNode}},{key:"renderSelector",value:function e(){this.selectorNode=t.Tag.render(n||(n=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div>\n\t\t\t\t<div class="ui-btn-link tasks-scrum__epic-selector--link">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),this.getButtonText());var i=this.selectorNode.firstElementChild;t.Event.bind(i,"click",this.onClick.bind(this,i));return this.selectorNode}},{key:"onClick",value:function e(i){var s=this;if(this.dialog){if(this.dialog.isOpen()){this.dialog.hide()}else{this.dialog.show()}return}this.dialog=new r.Dialog({id:t.Text.getRandom(),targetNode:this.selectorNode,width:350,height:300,multiple:false,dropdownMode:true,enableSearch:true,compactView:true,hideOnDeselect:true,selectedItems:[],items:[],searchOptions:{allowCreateItem:true,footerOptions:{label:t.Loc.getMessage("TSE_SELECTOR_SEARCHER_EPIC_ADD")}},events:{"Search:onItemCreateAsync":function e(t){return new Promise((function(e){var i=t.getData(),r=i.searchQuery;s.createEpic(r.getQuery()).then((function(t){var i=s.getEpicDialogItem(t);i.selected=true;i.sort=1;s.dialog.addItem(i);s.dialog.hide();e()}))}))}},tagSelectorOptions:{textBoxWidth:300}});this.dialog.subscribe("onHide",(function(){var e=s.dialog.getSelectedItems();var t=e.length?e[0].getId():0;s.changeTaskEpic(t).then((function(e){return s.updateSelector(e)}))}));this.dialog.showLoader();this.dialog.show();this.getEpics().then((function(e){if(!t.Type.isNull(s.epic)){var i=s.getEpicDialogItem(s.epic);i.selected=true;i.sort=1;s.dialog.addItem(i)}e.forEach((function(e){s.dialog.addItem(e)}));s.dialog.hideLoader()}))["catch"]((function(e){s.showErrorAlert(e);s.dialog.hideLoader()}))}},{key:"updateSelector",value:function e(i){this.epic=i;this.selectorNode.firstElementChild.textContent=this.getButtonText();if(t.Type.isNull(i)){t.Dom.remove(this.nameNode);this.nameNode=null}else{if(t.Type.isNull(this.nameNode)){t.Dom.insertBefore(this.renderName(),this.selectorNode)}else{t.Dom.replace(this.nameNode,this.renderName())}}}},{key:"getEpics",value:function e(){var i=this;return t.ajax.runComponentAction("bitrix:tasks.scrum.epic.selector","getEpics",{mode:"class",data:{groupId:this.groupId}}).then((function(e){var r=e.data;if(t.Type.isNull(r)){return[]}var s=[];r.forEach((function(e){s.push(i.getEpicDialogItem(e))}));return s}))["catch"]((function(e){return i.showErrorAlert(e)}))}},{key:"getEpicDialogItem",value:function e(t){var i="/bitrix/components/bitrix/tasks.scrum.epic.selector/templates/.default"+"/images/search-hashtag-green.svg";return{id:t.id,entityId:"epic",title:t.name,tabs:"recents",avatar:i}}},{key:"changeTaskEpic",value:function e(i){var r=this;return t.ajax.runComponentAction("bitrix:tasks.scrum.epic.selector","changeTaskEpic",{mode:"class",data:{taskId:this.taskId,epicId:i}}).then((function(e){return e.data}))["catch"]((function(e){return r.showErrorAlert(e)}))}},{key:"createEpic",value:function e(i){var r=this;return t.ajax.runAction("bitrix:tasks.scrum.epic.createEpic",{data:{groupId:this.groupId,name:i}}).then((function(e){return e.data}))["catch"]((function(e){return r.showErrorAlert(e)}))}},{key:"getButtonText",value:function e(){if(t.Type.isNull(this.epic)){return t.Loc.getMessage("TSE_SELECTOR_ADD")}else{return t.Loc.getMessage("TSE_SELECTOR_EDIT")}}},{key:"convertHexToRGBA",value:function e(t,i){var r=t.replace("#","");if(r.length===3){r="".concat(r[0]).concat(r[0]).concat(r[1]).concat(r[1]).concat(r[2]).concat(r[2])}var s=parseInt(r.substring(0,2),16);var a=parseInt(r.substring(2,4),16);var n=parseInt(r.substring(4,6),16);return"rgba(".concat(s,",").concat(a,",").concat(n,",").concat(i,")")}},{key:"showErrorAlert",value:function e(i,r){if(t.Type.isUndefined(i.errors)){return}if(i.errors.length){var s=i.errors.shift();if(s){var a=s.code?s.code:"";var n=s.message+" "+a;var o=r?r:t.Loc.getMessage("TSE_SELECTOR_ERROR_POPUP_TITLE");top.BX.UI.Dialogs.MessageBox.alert(n,o)}}}}]);return e}();var c;var l=function(){function e(t){babelHelpers.classCallCheck(this,e);this.groupId=t.groupId;this.taskId=t.taskId;this.savedEpic=t.epic;this.inputName=t.inputName;this.selector=null;this.listEpics=new Map;this.node=null;this.inputNode=null;i.EventEmitter.subscribe("BX.Tasks.MemberSelector:projectSelected",this.onProjectSelected.bind(this));i.EventEmitter.subscribe("BX.Tasks.Component.Task:projectPreselected",this.onProjectPreselected.bind(this))}babelHelpers.createClass(e,[{key:"renderTo",value:function e(i){this.node=i;t.Dom.addClass(this.node,"tasks-scrum-epic-edit-selector");if(this.inputName){t.Dom.append(this.renderInput(),this.node)}this.buildSelector().renderTo(this.node)}},{key:"renderInput",value:function e(){var i=this.savedEpic?parseInt(this.savedEpic.id,10):0;this.inputNode=t.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="hidden" name="','" value="','">\n\t\t'])),t.Text.encode(this.inputName),i);return this.inputNode}},{key:"buildSelector",value:function e(){var i=this;this.selector=new r.TagSelector({multiple:false,textBoxWidth:200,dialogOptions:{width:350,height:240,dropdownMode:true,compactView:true,multiple:false,hideOnDeselect:true,searchOptions:{allowCreateItem:true,footerOptions:{label:t.Loc.getMessage("TSE_SELECTOR_SEARCHER_EPIC_ADD")}},items:[],events:{"Search:onItemCreateAsync":function e(t){return new Promise((function(e){var r=t.getData(),s=r.searchQuery;var a=t.getTarget();i.createEpic(s.getQuery()).then((function(t){var r=i.getEpicDialogItem(t);r.selected=true;r.sort=1;a.addItem(r);i.updateInputValue(r.id);e()}))}))},"Item:onSelect":function e(t){var r=t.getData().item;i.updateInputValue(r.getId())},"Item:onDeselect":function e(t){var r=t.getTarget();setTimeout((function(){if(r.getSelectedItems().length===0){i.updateInputValue(0)}}),50)}}}});this.selector.subscribe("onMetaEnter",(function(e){var t=e.getTarget();if(t.getDialog().isOpen()){var i=e.getData(),r=i.event;r.stopPropagation()}}));this.selector.getDialog().subscribe("onShow",(function(){i.updateSelectorItems()}));if(this.savedEpic){this.updateSelectorItems()}return this.selector}},{key:"onProjectSelected",value:function e(t){var i=t.getData();this.groupId=parseInt(i.ID,10);this.listEpics.clear();this.selector.getDialog().removeItems();this.updateInputValue(0)}},{key:"onProjectPreselected",value:function e(t){var i=t.getData();this.groupId=parseInt(i.groupId,10);this.listEpics.clear();this.selector.getDialog().removeItems();this.updateInputValue(0)}},{key:"updateSelectorItems",value:function e(){var t=this;if(this.groupId===0||this.listEpics.has(this.groupId)){return}this.selector.getDialog().removeItems();this.selector.getDialog().showLoader();this.getEpics().then((function(e){e.forEach((function(e){if(t.savedEpic&&t.savedEpic.id===e.id){e.selected=true;e.sort=1;t.selector.addTag(e);t.updateInputValue(e.id)}t.selector.getDialog().addItem(e)}));t.selector.getDialog().hideLoader();return true}))["catch"]((function(e){return t.showErrorAlert(e)}))}},{key:"updateInputValue",value:function e(t){this.inputNode.value=parseInt(t,10)}},{key:"getEpics",value:function e(){var i=this;return t.ajax.runComponentAction("bitrix:tasks.scrum.epic.selector","getEpics",{mode:"class",data:{groupId:this.groupId}}).then((function(e){var r=e.data;if(t.Type.isNull(r)){return[]}var s=[];r.forEach((function(e){s.push(i.getEpicDialogItem(e))}));i.listEpics.set(i.groupId,s);return s}))["catch"]((function(e){return i.showErrorAlert(e)}))}},{key:"getEpicDialogItem",value:function e(t){var i="/bitrix/components/bitrix/tasks.scrum.epic.selector/templates/.default"+"/images/search-hashtag-green.svg";return{id:t.id,entityId:"epic",title:t.name,tabs:"recents",avatar:i}}},{key:"createEpic",value:function e(i){var r=this;return t.ajax.runAction("bitrix:tasks.scrum.epic.createEpic",{data:{groupId:this.groupId,name:i}}).then((function(e){return e.data}))["catch"]((function(e){return r.showErrorAlert(e)}))}},{key:"showErrorAlert",value:function e(i,r){if(t.Type.isUndefined(i.errors)){return}if(i.errors.length){var s=i.errors.shift();if(s){var a=s.code?s.code:"";var n=s.message+" "+a;var o=r?r:t.Loc.getMessage("TSE_SELECTOR_ERROR_POPUP_TITLE");top.BX.UI.Dialogs.MessageBox.alert(n,o)}}}}]);return e}();var u=function(){function e(i){babelHelpers.classCallCheck(this,e);this.groupId=parseInt(i.groupId,10);this.taskId=parseInt(i.taskId,10);this.epic=t.Type.isPlainObject(i.epic)?i.epic:null;this.canEdit=i.canEdit==="Y";this.mode=i.mode==="edit"?"edit":"view";this.inputName=i.inputName}babelHelpers.createClass(e,[{key:"renderTo",value:function e(t){if(this.mode==="view"){new o({groupId:this.groupId,taskId:this.taskId,epic:this.epic,canEdit:this.canEdit}).renderTo(t)}else{new l({groupId:this.groupId,taskId:this.taskId,epic:this.epic,inputName:this.inputName}).renderTo(t)}}}]);return e}();e.EpicSelector=u})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX,BX.Event,BX.UI.EntitySelector);
//# sourceMappingURL=script.map.js