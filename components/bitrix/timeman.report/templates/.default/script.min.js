(function(){var t={};function e(t,e){this.DIV=t;this.SETTINGS={DATE_START:e.date_start||new Date,MONTHS:e.MONTHS,DAYS:e.DAYS,LANG:e.LANG,SITE_ID:e.SITE_ID,DEPARTMENTS:e.DEPARTMENTS,FILTER:e.FILTER,DATESELECTOR:e.DATESELECTOR};this.FILTER={DEPARTMENT:this.SETTINGS.START_DEPARTMENT||"",SHOW_ALL:this.SETTINGS.START_SHOW_ALL||"Y"};this.__nullifyDate(this.SETTINGS.DATE_START,true);this.PARTS={DATESELECTOR:null,LAYOUT:null,LAYOUT_COLS:{NAME:null,DATA:null},SCROLLERS:{LEFT:null,RIGHT:null},TODAY_CELL:null,NAV:null};this.DATA={DEPARTMENTS:[],USERS:[]};this.DRAGDATA={startx:null,lastx:null,startscroll:null,mode:1,scrollTimer:null,dxscroll:0};this.TOTALS={};this.arCellObjects=[];this.today=this.__nullifyDate();this.DATA_SETTINGS=null;this.HINTS=[];this.arViews=["arrival","departure"];this.page=0;BX.ready(BX.delegate(this.Init,this));BX.addCustomEvent(this,"onEntryReloaded",BX.delegate(this.onEntryReloaded,this))}e.prototype.Init=function(){this.DIV=BX(this.DIV);if(this.SETTINGS.FILTER&&BX.type.isString(this.SETTINGS.FILTER))this.SETTINGS.FILTER=document.forms[this.SETTINGS.FILTER];this.loadFilterHash();this.CreateLayout();this.PARTS.NAV=this.DIV.appendChild(BX.create("DIV"))};e.prototype.CreateLayout=function(){this._createLayoutRow();setTimeout(BX.delegate(this.loadData,this),50)};e.prototype._createLayoutRow=function(){if(this.PARTS.LAYOUT)BX.cleanNode(this.PARTS.LAYOUT,true);var t="tm-report";if(this.SETTINGS.FILTER.additional&&!this.SETTINGS.FILTER.additional.checked)t+=" bx-tm-additions-disabled";if(this.SETTINGS.FILTER.stats&&!this.SETTINGS.FILTER.stats.checked)t+=" bx-tm-wide-mode";this.PARTS.LAYOUT=this.DIV.appendChild(BX.create("DIV",{props:{className:t},events:{scroll:function(){this.scrollLeft=0;this.scrollTop=0}}}))};e.prototype._createLayout=function(){this.PARTS.LAYOUT_COLS.NAME=this.PARTS.LAYOUT.appendChild(BX.create("DIV",{props:{className:"tm-report-col-name"}}));this.PARTS.LAYOUT_COLS.DATA=this.PARTS.LAYOUT.appendChild(BX.create("DIV",{props:{className:"tm-report-col-data"}}));var t=this.PARTS.LAYOUT_COLS.NAME.appendChild(BX.create("TABLE",{props:{className:"tm-report-table-name bx-tm-data-table"},attrs:{cellSpacing:"0"},children:[document.createElement("THEAD"),document.createElement("TBODY")]}));var e=t.tHead.insertRow(-1);BX.adjust(e.insertCell(-1),{props:{className:"bx-name-col"},html:'<div class="tm-inner">'+this.SETTINGS.LANG.EMPLOYEE+"</div>"});BX.adjust(e.insertCell(-1),{props:{className:"bx-stats-col bx-total-days"},html:'<div class="tm-inner">'+this.SETTINGS.LANG.OVERALL_DAYS+"</div>"});BX.adjust(e.insertCell(-1),{props:{className:"bx-stats-col bx-total-time"},html:'<div class="tm-inner">'+this.SETTINGS.LANG.OVERALL+"</div>"});BX.adjust(e.insertCell(-1),{props:{className:"bx-stats-col bx-total-viol"},html:'<div class="tm-inner">'+this.SETTINGS.LANG.OVERALL_VIOL+"</div>"});BX.adjust(e.insertCell(-1),{props:{className:"bx-tm-scroller-cell"},children:[BX.create("DIV",{style:{position:"absolute"},children:[this.PARTS.SCROLLERS.LEFT=BX.create("DIV",{props:{className:"tm-report-scroller-left",id:"tm_report_scroller_left"},html:'<div class="tm-report-scroller-arrow"></div>'})]}),BX.create("SPAN",{html:"&nbsp;"})]});var s=this.PARTS.LAYOUT_COLS.DATA.appendChild(BX.create("TABLE",{props:{className:"tm-report-table-data bx-tm-data-table"},attrs:{cellSpacing:"0"},children:[document.createElement("THEAD"),document.createElement("TBODY")]}));var a=s.tHead.insertRow(-1);var T=this.SETTINGS.DATE_START.getMonth();var n=this.__nullifyDate(new Date(this.SETTINGS.DATE_START.valueOf()),true);var r=0;while(n.getMonth()==T){var l=a.insertCell(-1);l.className="bx-tm-month-day";if(n.valueOf()==this.today.valueOf()){l.className+=" bx-tm-month-today";this.PARTS.TODAY_CELL=l}if(n.getDay()==0||n.getDay()==6)l.className+=" bx-tm-month-holiday";var o=n.getDate();l.innerHTML='<div class="bx-tm-day-title">'+o+'</div><div class="bx-tm-day-weekday">'+this.SETTINGS.DAYS[n.getDay()]+"</div>";n.setDate(n.getDate()+1);r++}var h=this.DATA.USERS.length,p=this.DATA.DEPARTMENTS.length;if(p>0){s=s.tBodies[0];t=t.tBodies[0];for(var A=0;A<p;A++){var S,E;var c=t.insertRow(-1).insertCell(-1);c.colSpan=5;c.className="bx-tm-departments-cell";var _='<div class="bx-tm-spacer"><div class="bx-tm-departments-chain">';ldd=this.DATA.DEPARTMENTS[A].CHAIN.length;for(S=0;S<ldd;S++){_+=(S>0?'<span class="bx-tm-departments-delimiter">&mdash;</span>':"")+'<a href="'+this.DATA.DEPARTMENTS[A].CHAIN[S].URL+'">'+BX.util.htmlspecialchars(this.DATA.DEPARTMENTS[A].CHAIN[S].NAME)+"</a>"}_+="</div>&nbsp;</div>";c.innerHTML=_;E=BX.create("SPAN",{props:{BXDPTID:this.DATA.DEPARTMENTS[A].ID,className:"bx-tm-user-settings-info"}});c.firstChild.firstChild.appendChild(E);this.HINTS.push(E);var d=s.insertRow(-1).insertCell(-1);d.className="bx-tm-departments-cell";d.innerHTML='<div class="bx-tm-spacer">&nbsp;</div>';d.colSpan=r;for(S=0;S<h;S++){if(this.DATA.USERS[S].DEPARTMENT!=this.DATA.DEPARTMENTS[A].ID)continue;e=t.insertRow(-1),E=null;BX.adjust(e.insertCell(-1),{props:{className:"bx-name-col"+(this.DATA.USERS[S].HEAD?" bx-head":"")},children:[BX.create("DIV",{props:{className:"tm-inner"},children:[E=BX.create("SPAN",{props:{BXUSERID:this.DATA.USERS[S].ID,className:"bx-tm-user-settings-info"}}),BX.create("A",{attrs:{href:this.DATA.USERS[S].URL},props:{className:"tm-user-link",title:this.DATA.USERS[S].HEAD?this.SETTINGS.LANG.HEAD:""},html:this.DATA.USERS[S].NAME}),BX.create("DIV",{props:{className:"bx-tm-view-arrival bx-tm-view-caption"},text:""}),BX.create("DIV",{props:{className:"bx-tm-view-departure bx-tm-view-caption"},text:""})]})]});this.HINTS.push(E);this._createHint(E,this.DATA.USERS[S].SETTINGS);var I={TOTAL:null,TOTAL_DAYS:null,TOTAL_VIOLATIONS:null};I.TOTAL_DAYS=BX.adjust(e.insertCell(-1),{props:{className:"bx-stats-col bx-total-days"},html:'<span class="bx-days">'+this.DATA.USERS[S].TOTAL_DAYS+"</span>"+(this.DATA.USERS[S].TOTAL_INACTIVE>0?'<span class="bx-days-inactive">('+this.DATA.USERS[S].TOTAL_INACTIVE+")</span>":"")});I.TOTAL=BX.adjust(e.insertCell(-1),{props:{className:"bx-stats-col bx-total-time"},text:BX.timeman.formatWorkTime(this.DATA.USERS[S].TOTAL)});var m=Math.round(this.DATA.USERS[S].TOTAL_DAYS>0?100*this.DATA.USERS[S].TOTAL_VIOLATIONS/this.DATA.USERS[S].TOTAL_DAYS:0)+"%";I.TOTAL_VIOLATIONS=BX.adjust(e.insertCell(-1),{props:{className:"bx-stats-col bx-total-viol",title:this.DATA.USERS[S].TOTAL_VIOLATIONS+" / "+this.DATA.USERS[S].TOTAL_DAYS},text:m});if(!this.TOTALS["USER_"+this.DATA.USERS[S].ID])this.TOTALS["USER_"+this.DATA.USERS[S].ID]=[];this.TOTALS["USER_"+this.DATA.USERS[S].ID].push(I);var N=BX.clone(a,true);N.BXUSERID=this.DATA.USERS[S].ID;s.appendChild(N);for(var D=0,u=N.cells.length;D<u;D++)N.cells[D].innerHTML='<div class="bx-tm-view-worktime">&nbsp;</div><div class="bx-tm-view-arrival">&nbsp;</div><div class="bx-tm-view-departure">&nbsp;</div>';e.onmouseover=function(){s.rows[this.sectionRowIndex].className=t.rows[this.sectionRowIndex].className="bx-over"};e.onmouseout=function(){s.rows[this.sectionRowIndex].className=t.rows[this.sectionRowIndex].className=""};for(D=0,u=this.DATA.USERS[S]["ENTRIES"].length;D<u;D++){var R=parseInt(this.DATA.USERS[S]["ENTRIES"][D].DAY,10)-1;this.arCellObjects[this.arCellObjects.length]=N.cells[R].bxentry=new i(this,N.cells[R],this.DATA.USERS[S]["ENTRIES"][D],this.DATA.USERS[S].SETTINGS)}}}}this.PARTS.SCROLLERS.RIGHT=this.PARTS.LAYOUT.appendChild(BX.create("DIV",{props:{className:"tm-report-scroller-right",id:"tm_report_scroller_right"},html:'<div class="tm-report-scroller-arrow"></div>'}));this.PARTS.LAYOUT.appendChild(BX.create("DIV",{props:{className:"tm-report-right-border"}}));this.PARTS.LAYOUT.appendChild(BX.create("DIV",{props:{className:"tm-report-bottom-border"}}));this._createScrollers()};e.prototype._createHint=function(t,e){t.BXHINT=new BX.CHint({parent:t,title:this.SETTINGS.LANG.HINT_TITLE,hint:e.UF_TM_MAX_START?!!e.UF_TM_FREE?'<div class="bx-tm-user-hint">'+this.SETTINGS.LANG.HINT_FREE+"</div>":'<div class="bx-tm-user-hint"><div>'+this.SETTINGS.LANG.HINT_MAX_START+": <b>"+BX.timeman.formatTime(e.UF_TM_MAX_START)+"</b></div><div>"+this.SETTINGS.LANG.HINT_MIN_FINISH+": <b>"+BX.timeman.formatTime(e.UF_TM_MIN_FINISH)+"</b></div><div>"+this.SETTINGS.LANG.HINT_MIN_DURATION+": <b>"+BX.timeman.formatWorkTime(e.UF_TM_MIN_DURATION)+"</b></div></div>":'<div class="bx-tm-user-hint">'+this.SETTINGS.LANG.HINT_DISABLED+"</div>",show_timeout:10,hide_timeout:9})};e.prototype._setScrollersPosScroll=function(){this.PARTS.LAYOUT_COLS.DATA.scrollLeft=0;if(this.PARTS.TODAY_CELL){var t=this.PARTS.TODAY_CELL.offsetLeft-this.PARTS.LAYOUT_COLS.DATA.offsetWidth+Math.ceil(this.PARTS.TODAY_CELL.offsetWidth*1.6);this.PARTS.LAYOUT_COLS.DATA.scrollLeft=t>0?t:0}};e.prototype.setToday=function(){if(this.PARTS.TODAY_CELL){this._setScrollersPosScroll()}else{this.SETTINGS.DATE_START.setMonth(this.today.getMonth());this.SETTINGS.DATE_START.setYear(this.today.getFullYear());BX("tm_datefilter_title",true).innerHTML=this.SETTINGS.MONTHS[this.SETTINGS.DATE_START.getMonth()]+" "+this.SETTINGS.DATE_START.getFullYear();this.Page(1)}};e.prototype._createScrollers=function(){this.PARTS.LAYOUT.onmousedown=BX.proxy(this.startDrag,this);var t=BX.proxy(this.stopScrollData,this);this.PARTS.SCROLLERS.LEFT.onmousedown=BX.delegate(function(t){if(this.PARTS.LAYOUT_COLS.DATA.scrollLeft<=0){this.changeMonth(-1)}else{this.scrollData(-75,this);return BX.eventCancelBubble(t||window.event)}},this);this.PARTS.SCROLLERS.RIGHT.onmousedown=BX.delegate(function(t){if(this.PARTS.LAYOUT_COLS.DATA.scrollWidth-this.PARTS.LAYOUT_COLS.DATA.scrollLeft-this.PARTS.LAYOUT_COLS.DATA.offsetWidth<=0){this.changeMonth(1)}else{this.scrollData(75,this);return BX.eventCancelBubble(t||window.event)}},this);this.PARTS.SCROLLERS.LEFT.onmouseup=this.PARTS.SCROLLERS.RIGHT.onmouseup=function(){t(this)};BX.bind(this.PARTS.LAYOUT_COLS.DATA,"mousewheel",BX.proxy(this._wheelScroll,this));setTimeout(BX.delegate(this._setScrollersPosScroll,this),50)};e.prototype._wheelScroll=function(t){this.scrollData(-Math.ceil(75*BX.getWheelData(t)/3));return BX.PreventDefault(t)};e.prototype.scrollData=function(t,e){var s=this.DRAGDATA.startscroll===null?this.PARTS.LAYOUT_COLS.DATA.scrollLeft:this.DRAGDATA.startscroll;this.PARTS.LAYOUT_COLS.DATA.scrollLeft=s+t;if(e)this.startScrollData(t,e)};e.prototype.startScrollData=function(t,e){if(null!=this.DRAGDATA.scrollTimer)this.stopScrollData(e);this.DRAGDATA.startscroll=this.PARTS.LAYOUT_COLS.DATA.scrollLeft;this.DRAGDATA.scrollTimer=setTimeout(BX.delegate(function(){this.moveScrollData(t,e)},this),500)};e.prototype.moveScrollData=function(t,e){this.DRAGDATA.dxscroll+=t;this.scrollData(this.DRAGDATA.dxscroll);var s=BX.proxy(this.moveScrollData,this);this.DRAGDATA.scrollTimer=setTimeout(function(){s(t,e)},50)};e.prototype.stopScrollData=function(t){if(this.DRAGDATA.scrollTimer){clearTimeout(this.DRAGDATA.scrollTimer);this.DRAGDATA.scrollTimer=null}this.DRAGDATA.dxscroll=0;this.DRAGDATA.startscroll=null};e.prototype.startDrag=function(t){t=t||window.event;this.DRAGDATA.lastx=this.DRAGDATA.startx=t.clientX;this.DRAGDATA.startscroll=this.PARTS.LAYOUT_COLS.DATA.scrollLeft;document.onmousemove=BX.proxy(this.moveDrag,this);document.onmouseup=BX.proxy(this.stopDrag,this)};e.prototype.moveDrag=function(t){t=t||window.event;var e=t.clientX;this.PARTS.LAYOUT.style.cursor=e>this.DRAGDATA.lastx?"e-resize":"w-resize";this.scrollData(this.DRAGDATA.startx-e);this.DRAGDATA.lastx=e};e.prototype.stopDrag=function(){this.DRAGDATA.startscroll=null;this.PARTS.LAYOUT.style.cursor="";document.onmousemove=null;document.onmouseup=null};e.prototype.changeMonth=function(t,e){this.SETTINGS.DATE_START.setMonth(this.SETTINGS.DATE_START.getMonth()+t);BX("bx_goto_date").value=BX.message("FORMAT_DATE").replace("YYYY",this.SETTINGS.DATE_START.getFullYear()).replace("MM",this.SETTINGS.DATE_START.getMonth()+1).replace("DD",this.SETTINGS.DATE_START.getDate());BX("tm_datefilter_title",true).innerHTML=this.SETTINGS.MONTHS[this.SETTINGS.DATE_START.getMonth()]+" "+this.SETTINGS.DATE_START.getFullYear();if(!e)this.Page(1)};e.prototype.Filter=function(t){var e="",s="Y";if(this.SETTINGS.FILTER.department){if(!t){e=this.SETTINGS.FILTER.department.value;s=this.SETTINGS.FILTER.show_all.value}if(e!=this.FILTER.DEPARTMENT||s!=this.FILTER.SHOW_ALL){this.FILTER.DEPARTMENT=e;this.FILTER.SHOW_ALL=s;this.Page(1)}}if(this.SETTINGS.FILTER.department.value)BX.removeClass(this.SETTINGS.FILTER.department.parentNode,"inactive");else BX.addClass(this.SETTINGS.FILTER.department.parentNode,"inactive");if(this.SETTINGS.FILTER.show_all.value=="N")BX.removeClass(this.SETTINGS.FILTER.show_all.parentNode,"inactive");else BX.addClass(this.SETTINGS.FILTER.show_all.parentNode,"inactive")};e.prototype.Page=function(t){t=t||this.page;if(t<0)t=1;this.page=t;this.loadData()};e.prototype.loadData=function(){BX.timeman.showWait(this.DIV);var t={ts:parseInt(this.SETTINGS.DATE_START.valueOf()/1e3),show_all:this.FILTER.SHOW_ALL,department:this.FILTER.DEPARTMENT,page:this.page};this.setFilterHash(t);BX.timeman_query("admin_data",t,BX.proxy(this.setData,this))};e.prototype.setFilterHash=function(t){var e="!/",s=[];if(t.ts)s.push("ts:"+t.ts);if(t.show_all&&t.show_all=="N")s.push("show_all:"+t.show_all);if(t.department&&t.department>0)s.push("department:"+t.department);if(t.page&&t.page>1)s.push("page:"+t.page);if(!this.SETTINGS.FILTER.stats.checked)s.push("stats:0");if(this.SETTINGS.FILTER.additional.checked)s.push("additional:1");e+=s.join("|");window.location.hash=e};e.prototype.setFilterHashParam=function(t,e){var s=window.location.hash,i=s.indexOf(t+":");if(i>=0)s=s.replace(new RegExp(t+":[^|]*[|]{0,1}"),"");var a=s.substring(s.length-1,s.length);s+=a=="/"||a=="|"?"":"|";s+=t+":"+e;window.location.hash=s};e.prototype.loadFilterHash=function(){var t=window.location.hash;if(t.substring(0,1)=="#")t=t.substring(1,t.length);if(t.length>0&&t.substring(0,2)=="!/"){var e=t.substring(2,t.length).split("|"),s,i;for(s=0;s<e.length;s++){i=e[s].split(":");switch(i[0]){case"ts":var a=new Date(i[1]*1e3),T=0;T+=a.getMonth()-this.SETTINGS.DATE_START.getMonth();T+=12*(a.getYear()-this.SETTINGS.DATE_START.getYear());this.changeMonth(T,true);break;case"show_all":this.SETTINGS.FILTER.show_all.value=this.FILTER.SHOW_ALL=i[1]=="N"?"N":"Y";BX.removeClass(this.SETTINGS.FILTER.show_all.parentNode,"inactive");break;case"department":this.SETTINGS.FILTER.department.value=this.FILTER.DEPARTMENT=parseInt(i[1]);BX.removeClass(this.SETTINGS.FILTER.department.parentNode,"inactive");break;case"page":this.page=parseInt(i[1]);break;case"stats":var n=!!parseInt(i[1]);this.SETTINGS.FILTER.stats.checked=n;this.toggleStats(n);break;case"additional":var n=!!parseInt(i[1]);this.SETTINGS.FILTER.additional.checked=n;this.toggleAdditions(n);break}}}};e.prototype.clearData=function(){if(this.SETTINGS_ENABLED){this.InitSettingMode();this.DATA_SETTINGS=null}for(var t=0,e=this.arCellObjects.length;t<e;t++)this.arCellObjects[t].Clear();this.PARTS.LAYOUT_COLS={NAME:null,DATA:null};this.PARTS.SCROLLERS={LEFT:null,RIGHT:null};this.PARTS.TODAY_CELL=null;BX.cleanNode(this.PARTS.LAYOUT)};e.prototype.setData=function(t){this.clearData();this.HINTS=[];this.DATA_SETTINGS=null;this.DATA=t;this._createLayout();BX.setUnselectable(this.PARTS.LAYOUT);BX.setUnselectable(this.PARTS.LAYOUT_COLS.DATA);BX.timeman.closeWait(this.DIV);setTimeout(BX.proxy(this.loadAbsence,this),10);this.PARTS.NAV.innerHTML=this.DATA.NAV};e.prototype.onEntryReloaded=function(t){if(this.TOTALS["USER_"+t.USER_ID]){var e={TOTAL:0,TOTAL_DAYS:0,TOTAL_VIOLATIONS:0,TOTAL_INACTIVE:0};BX.onCustomEvent(this,"onRecountTotals",[t.USER_ID,e,t.ROW]);for(var s=0;s<this.TOTALS["USER_"+t.USER_ID].length;s++){var i=this.TOTALS["USER_"+t.USER_ID][s];i.TOTAL.innerHTML=BX.timeman.formatWorkTime(e.TOTAL);i.TOTAL_DAYS.innerHTML='<span class="bx-days">'+parseInt(e.TOTAL_DAYS)+"</span>"+(e.TOTAL_INACTIVE>0?'<span class="bx-days-inactive">('+parseInt(e.TOTAL_INACTIVE)+")</span>":"");i.TOTAL_VIOLATIONS.innerHTML=Math.round(e.TOTAL_DAYS>0?100*e.TOTAL_VIOLATIONS/e.TOTAL_DAYS:0)+"%";i.TOTAL_VIOLATIONS.title=e.TOTAL_VIOLATIONS+" / "+e.TOTAL_DAYS}}};e.prototype.__nullifyDate=function(t,e){t=t||new Date;t.setHours(0);t.setMinutes(0);t.setSeconds(0);t.setMilliseconds(0);if(!!e)t.setDate(1);return t};e.prototype.loadAbsence=function(){var t=this.__nullifyDate(this.SETTINGS.DATE_START,true).valueOf();var e=new Date(t);e.setMonth(e.getMonth()+1);var s="/bitrix/components/bitrix/intranet.absence.calendar/ajax.php?MODE=GET&TS_START="+parseInt(t.valueOf()/1e3)+"&TS_FINISH="+(parseInt(e.valueOf()/1e3)-1)+"&SHORT_EVENTS=N&USERS_ALL=N&current_data_id=1111&site_id="+this.SETTINGS.SITE_ID+"&sessid="+BX.bitrix_sessid()+"&rnd="+Math.random();BX.timeman.showWait(this.DIV);window.jsBXAC={SetData:BX.proxy(this.setAbsenceData,this)};BX.loadScript(s)};e.prototype.setAbsenceData=function(t){if(!this.PARTS.LAYOUT_COLS.DATA.firstChild)return;for(var e=0;e<t.length;e++){var s=BX.findChildren(this.PARTS.LAYOUT_COLS.DATA.firstChild.tBodies[0],{tag:"TR",property:{BXUSERID:t[e].ID}}),i=null;if(!!s&&s.length>0){for(var a=0,T=s.length;a<T;a++){i=s[a];var n=0,r=this.SETTINGS.DATE_START.getMonth(),l=[],o=[],h,p;for(h=0;h<t[e].DATA.length;h++){var A=false;for(p=0;p<o.length;p++){if(o[p].DATE_ACTIVE_FROM>=t[e].DATA[h].DATE_ACTIVE_FROM&&o[p].DATE_ACTIVE_TO<=t[e].DATA[h].DATE_ACTIVE_TO){A=true;o[p]=t[e].DATA[h]}else if(o[p].DATE_ACTIVE_FROM<=t[e].DATA[h].DATE_ACTIVE_FROM&&o[p].DATE_ACTIVE_TO>=t[e].DATA[h].DATE_ACTIVE_TO){A=true}else if(o[p].DATE_ACTIVE_FROM>t[e].DATA[h].DATE_ACTIVE_FROM&&o[p].DATE_ACTIVE_FROM<=t[e].DATA[h].DATE_ACTIVE_TO){t[e].DATA[h].DATE_ACTIVE_TO=o[p].DATE_ACTIVE_FROM-86400}else if(o[p].DATE_ACTIVE_TO>=t[e].DATA[h].DATE_ACTIVE_FROM&&o[p].DATE_ACTIVE_TO<t[e].DATA[h].DATE_ACTIVE_TO){t[e].DATA[h].DATE_ACTIVE_FROM=parseInt(o[p].DATE_ACTIVE_TO)+86400}if(t[e].DATA[h].DATE_ACTIVE_FROM>t[e].DATA[h].DATE_ACTIVE_TO)A=true}if(!A)o.push(t[e].DATA[h])}for(h=0;h<o.length-1;h++){for(p=h+1;p<o.length;p++){if(o[p].DATE_ACTIVE_FROM<o[h].DATE_ACTIVE_FROM){var S=o[p];o[p]=o[h];o[h]=S}}}t[e].DATA=o;for(h=0;h<t[e].DATA.length;h++){var E=new Date((t[e].DATA[h].DATE_ACTIVE_FROM-BX.message("USER_TZ_OFFSET"))*1e3),c=new Date((t[e].DATA[h].DATE_ACTIVE_TO-BX.message("USER_TZ_OFFSET"))*1e3);if(E.getMonth()<this.SETTINGS.DATE_START.getMonth()||E.getFullYear()<this.SETTINGS.DATE_START.getFullYear())E=new Date(this.SETTINGS.DATE_START.valueOf());l.push([t[e].DATA[h].DATE_ACTIVE_FROM,t[e].DATA[h].DATE_ACTIVE_TO]);var _=null,d=0;while(E.getMonth()==r&&E.valueOf()<=c.valueOf()){var I=E.getDate(),p;if(!_&&!i.cells[I-1-n].bxentry){_=i.cells[I-1-n]}if(!i.cells[I-1-n].bxentry){d++}else if(_){BX.addClass(i.cells[I-1-n],"bx-tm-absent bx-tm-absent-"+t[e].DATA[h].TYPE);_.colSpan=d;_.innerHTML='<span style="width: '+(75*d-10)+'px; display: block; white-space: nowrap; overflow: hidden; ">'+BX.util.htmlspecialchars(t[e].DATA[h].NAME)+"</span>";_.style.textAlign="left";_.style.paddingRight="0px";n+=d-1;BX.addClass(_,"bx-tm-absent bx-tm-absent-"+t[e].DATA[h].TYPE);for(p=1;p<d;p++){i.deleteCell(_.cellIndex+1)}_=null;d=0}else{BX.addClass(i.cells[I-1-n],"bx-tm-absent bx-tm-absent-"+t[e].DATA[h].TYPE)}E.setDate(I+1)}if(_){_.colSpan=d;_.innerHTML='<span style="width: '+(75*d-10)+'px; display: block; white-space: nowrap; overflow: hidden; ">'+BX.util.htmlspecialchars(t[e].DATA[h].NAME)+'</span><div class="bx-tm-view-arrival">&nbsp;</div><div class="bx-tm-view-departure">&nbsp;</div>';_.style.textAlign="left";_.style.paddingRight="0px";n+=d-1;BX.addClass(_,"bx-tm-absent bx-tm-absent-"+t[e].DATA[h].TYPE);for(p=1;p<d;p++){i.deleteCell(_.cellIndex+1)}_=null;d=0}}}}}BX.timeman.closeWait(this.DIV)};e.prototype.toggleStats=function(t){var e=this.PARTS.LAYOUT_COLS.DATA,s=!!e?e.scrollLeft+e.offsetWidth:0;BX[t?"removeClass":"addClass"](this.PARTS.LAYOUT,"bx-tm-wide-mode");if(!!e)e.scrollLeft=s-e.offsetWidth};e.prototype.toggleAdditions=function(t){var e=this.PARTS.LAYOUT_COLS.DATA,s=!!e?e.scrollLeft:0;BX[t?"removeClass":"addClass"](this.PARTS.LAYOUT,"bx-tm-additions-disabled");if(!!e)e.scrollLeft=s};e.prototype.InitSettingMode=function(t){this.SETTINGS_BUTTON=t||this.SETTINGS_BUTTON;BX.toggleClass(this.SETTINGS_BUTTON,"tm-settings-item-active");this.SETTINGS_ENABLED=BX.hasClass(this.SETTINGS_BUTTON,"tm-settings-item-active");if(this.SETTINGS_ENABLED){BX.addClass(this.DIV,"tm-settings-enabled");if(this.DATA_SETTINGS===null){var e;query_data={DEPARTMENTS:[],USERS:[]};for(e=0;e<this.DATA.USERS.length;e++)query_data["USERS"].push(this.DATA.USERS[e].ID);for(e=0;e<this.DATA.DEPARTMENTS.length;e++)query_data["DEPARTMENTS"].push(this.DATA.DEPARTMENTS[e].ID);BX.timeman_query("admin_data_settings",query_data,BX.proxy(this._InitSettingMode,this))}else{this._InitSettingMode()}}else{BX.removeClass(this.DIV,"tm-settings-enabled");for(var s=0;s<this.HINTS.length;s++){this.HINTS[s].style.display="";BX.unbind(this.HINTS[s],"click",BX.proxy(this.Settings,this));if(this.HINTS[s].BXHINT)this.HINTS[s].BXHINT.enable();BX.removeClass(this.HINTS[s],"bx-no-settings-light");BX.removeClass(this.HINTS[s],"bx-has-settings-light")}}};e.prototype._InitSettingMode=function(t){var e,s,i;this.DATA_SETTINGS=t||this.DATA_SETTINGS;for(e=0;e<this.DATA_SETTINGS.USERS.length;e++){for(s=0;s<this.HINTS.length;s++){if(this.DATA_SETTINGS.USERS[e].ID==this.HINTS[s].BXUSERID){this.HINTS[s].style.display="inline-block";BX.bind(this.HINTS[s],"click",BX.proxy(this.Settings,this));if(this.HINTS[s].BXHINT)this.HINTS[s].BXHINT.disable();var a="bx-no-settings-light";if(this.HINTS[s].BXSETTINGSFORM)this.DATA_SETTINGS.USERS[e].SETTINGS=this.HINTS[s].BXSETTINGSFORM.data.SETTINGS;for(i in this.DATA_SETTINGS.USERS[e].SETTINGS){if(this.DATA_SETTINGS.USERS[e].SETTINGS[i]!==""){a="bx-has-settings-light";break}}BX.addClass(this.HINTS[s],a)}}}for(e=0;e<this.DATA_SETTINGS.DEPARTMENTS.length;e++){for(s=0;s<this.HINTS.length;s++){if(this.DATA_SETTINGS.DEPARTMENTS[e].ID==this.HINTS[s].BXDPTID){this.HINTS[s].style.display="inline-block";BX.bind(this.HINTS[s],"click",BX.proxy(this.SettingsDpt,this));var a="bx-no-settings-light";if(this.HINTS[s].BXSETTINGSFORM)this.DATA_SETTINGS.DEPARTMENTS[e].SETTINGS=this.HINTS[s].BXSETTINGSFORM.data.SETTINGS;for(i in this.DATA_SETTINGS.DEPARTMENTS[e].SETTINGS){if(this.DATA_SETTINGS.DEPARTMENTS[e].SETTINGS[i]!==""){a="bx-has-settings-light";break}}BX.addClass(this.HINTS[s],a)}}}};e.prototype.Settings=function(t){var e=BX.proxy_context.BXUSERID;if(e>0){for(var i=0;i<this.DATA_SETTINGS.USERS.length;i++){if(this.DATA_SETTINGS.USERS[i].ID==e){if(!BX.proxy_context.BXSETTINGSFORM){BX.proxy_context.BXSETTINGSFORM=new s({parent:this,node:BX.proxy_context,data:this.DATA_SETTINGS.USERS[i],data_default:this.DATA_SETTINGS.DEFAULTS,source:"user"})}BX.proxy_context.BXSETTINGSFORM.Show();break}}}};e.prototype.SettingsDpt=function(t){var e=BX.proxy_context.BXDPTID;if(e>0){for(var i=0;i<this.DATA_SETTINGS.DEPARTMENTS.length;i++){if(this.DATA_SETTINGS.DEPARTMENTS[i].ID==e){if(!BX.proxy_context.BXSETTINGSFORM){this.DATA_SETTINGS.DEPARTMENTS[i].TOP_SECTION=false;for(var a=0;a<this.DATA.DEPARTMENTS.length;a++){if(this.DATA.DEPARTMENTS[a].ID==e){this.DATA_SETTINGS.DEPARTMENTS[i].TOP_SECTION=!!this.DATA.DEPARTMENTS[a].TOP_SECTION;break}}BX.proxy_context.BXSETTINGSFORM=new s({parent:this,node:BX.proxy_context,data:this.DATA_SETTINGS.DEPARTMENTS[i],data_default:this.DATA_SETTINGS.DEFAULTS,source:"department"})}BX.proxy_context.BXSETTINGSFORM.Show();break}}}};function s(t){this.data=t.data;this.data_default=t.data_default;this.icon=t.node;this.source=t.source||"user";this.parent=t.parent;this.uniqid=parseInt(Math.random()*1e5);this._checkData();this.popup=BX.PopupWindowManager.create("setting_form_"+this.uniqid,this.icon,{autoHide:true,lightShadow:true,angle:{position:"left",offset:20},offsetTop:-35,offsetLeft:20,closeIcon:{right:"12px",top:"10px"},bindOptions:{forceTop:true,forceLeft:true}});this.popup.setContent(this.Content());this.popup.setButtons(this.Buttons());this.bChanged=false}s.prototype._checkData=function(){if(this.data.SETTINGS_ALL.UF_TIMEMAN==="Y")this.data.SETTINGS_ALL.UF_TIMEMAN=true;else if(this.data.SETTINGS_ALL.UF_TIMEMAN==="N")this.data.SETTINGS_ALL.UF_TIMEMAN=false;if(this.data.SETTINGS_ALL.UF_TM_FREE==="Y")this.data.SETTINGS_ALL.UF_TM_FREE=true;else if(this.data.SETTINGS_ALL.UF_TM_FREE==="N")this.data.SETTINGS_ALL.UF_TM_FREE=false;if(this.data.SETTINGS.UF_TIMEMAN==="Y")this.data.SETTINGS.UF_TIMEMAN=true;else if(this.data.SETTINGS.UF_TIMEMAN==="N")this.data.SETTINGS.UF_TIMEMAN=false;if(this.data.SETTINGS.UF_TM_FREE==="Y")this.data.SETTINGS.UF_TM_FREE=true;else if(this.data.SETTINGS.UF_TM_FREE==="N")this.data.SETTINGS.UF_TM_FREE=false;if(this.data.TOP_SECTION){for(var t in this.data_default){if(this.data.SETTINGS[t]==="")this.data.SETTINGS[t]=this.data_default[t]}}};s.prototype.Content=function(){this.DIV=BX.create("DIV",{props:{className:"period-setting-main"},children:[BX.create("FORM")]});var t,e;this.needParamsHint=false;this.DIV.firstChild.appendChild(this._Control({name:"UF_TIMEMAN",label:BX.message("JS_CORE_TM"),input_type:"select",value_type:"boolean",input_values:{Y:BX.message("JS_CORE_TMR_ON"),N:BX.message("JS_CORE_TMR_OFF")},callback:BX.delegate(function(){var e=BX.proxy_context;if(e.value=="N"||e.value==""&&!this.data.SETTINGS_ALL.UF_TIMEMAN)BX.hide(t);else BX.show(t)},this)}));t=this.DIV.firstChild.appendChild(BX.create("DIV",{children:[this._Control({name:"UF_TM_FREE",label:this.parent.SETTINGS.LANG.HINT_FREE,input_type:"select",value_type:"boolean",input_values:{Y:BX.message("JS_CORE_TMR_ON"),N:BX.message("JS_CORE_TMR_OFF")},callback:BX.delegate(function(){var t=BX.proxy_context;if(t.value=="Y"||t.value==""&&this.data.SETTINGS_ALL.UF_TM_FREE)BX.hide(e);else BX.show(e)},this)}),e=BX.create("DIV",{children:[this._Control({name:"UF_TM_MAX_START",label:this.parent.SETTINGS.LANG.HINT_MAX_START,input_type:"clock",value_type:"time"}),this._Control({name:"UF_TM_MIN_FINISH",label:this.parent.SETTINGS.LANG.HINT_MIN_FINISH,input_type:"clock",value_type:"time"}),this._Control({name:"UF_TM_MIN_DURATION",label:this.parent.SETTINGS.LANG.HINT_MIN_DURATION,input_type:"text",value_type:"time"}),this._Control({name:"UF_TM_ALLOWED_DELTA",label:this.parent.SETTINGS.LANG.HINT_ALLOWED_DELTA,input_type:"text",value_type:"time"}),this._Control({name:"UF_TM_REPORT_REQ",label:this.parent.SETTINGS.LANG.HINT_REPORT_REQ,input_type:"select",value_type:"enum",input_values:{Y:this.parent.SETTINGS.LANG.HINT_REPORT_REQ_Y,N:this.parent.SETTINGS.LANG.HINT_REPORT_REQ_N,A:this.parent.SETTINGS.LANG.HINT_REPORT_REQ_A}})]})]}));if(this.needParamsHint){t.appendChild(BX.create("SPAN",{html:"<sup>*</sup> "+BX.message("JS_CORE_TMR_SN")}))}if(!this.data.SETTINGS_ALL["UF_TIMEMAN"])BX.hide(t);if(this.data.SETTINGS_ALL["UF_TM_FREE"])BX.hide(e);return this.DIV};s.prototype.Buttons=function(){var t=[];this.SAVEBUTTON=new BX.PopupWindowButton({text:BX.message("JS_CORE_WINDOW_SAVE"),events:{click:BX.proxy(this.Save,this)}});window.SAVEBUTTON=this.SAVEBUTTON;t.push(this.SAVEBUTTON);t.push(new BX.PopupWindowButtonLink({text:BX.message("JS_CORE_WINDOW_CLOSE"),className:"popup-window-button-link-cancel",events:{click:BX.proxy(this.popup.close,this.popup)}}));return t};s.prototype.Show=function(){this.popup.show()};s.prototype.Save=function(){if(this.bChanged){var t=this.DIV.firstChild,e=["UF_TIMEMAN","UF_TM_FREE","UF_TM_ALLOWED_DELTA","UF_TM_MAX_START","UF_TM_MIN_DURATION","UF_TM_MIN_FINISH","UF_TM_REPORT_REQ"];var s={ID:this.data.ID,source:this.source};for(var i=0;i<e.length;i++){s[e[i]]=t[e[i]]?t[e[i]].type=="checkbox"?t[e[i]].checked?"Y":"N":e[i]=="UF_TM_ALLOWED_DELTA"?BX.timeman.unFormatTime(t[e[i]].value):t[e[i]].value:""}BX.timeman_query("admin_data_settings",s,BX.delegate(this._Save,this));this.bChanged=false;this.SAVEBUTTON.setClassName("")}};s.prototype._Save=function(t){t.TOP_SECTION=this.data.TOP_SECTION;this.data=t;this._checkData();var e="bx-no-settings-light";for(k in this.data.SETTINGS){if(this.data.SETTINGS[k]!==""){e="bx-has-settings-light";break}}BX.removeClass(this.icon,"bx-no-settings-light");BX.removeClass(this.icon,"bx-has-settings-light");BX.addClass(this.icon,e);if(this.icon.BXHINT)this.icon.BXHINT.Destroy();this.parent._createHint(this.icon,t.SETTINGS_ALL);if(this.icon.BXHINT)this.icon.BXHINT.disable();this.popup.setContent(this.Content())};s.prototype._Control=function(t,e){var s=BX.create("DIV"),i=this.data.SETTINGS[t.name],a=!!e,T=parseInt(Math.random()*1e5);if(!!t.label){s.appendChild(BX.create("LABEL",{props:{className:"period-setting-label"},style:{display:"block"},text:t.label}))}if(t.input_type==="select"){var n=s.appendChild(BX.create("SELECT",{props:{name:t.name,className:"period-setting-select"},events:{change:BX.delegate(function(e){this._OnChange();if(t.callback)return t.callback.apply(BX.proxy_context,arguments)},this)}}));if(!this.data.TOP_SECTION){try{n.add(new Option(BX.message("JS_CORE_TMR_INHERIT"),""),null)}catch(r){n.add(new Option(BX.message("JS_CORE_TMR_INHERIT"),""),-1)}}for(var l in t.input_values){var o=new Option(t.input_values[l],l);o.selected=t.value_type=="boolean"?l=="Y"&&i===true||l=="N"&&i===false:i==l;try{n.add(o,null)}catch(r){n.add(o,-1)}}}else{if(i===""||e===false){a=true;i=this.data.SETTINGS_ALL[t.name];if(i==="")i=this.data_default[t.name]}if(e===true)a=false;if(a){var h="",p=false;switch(t.value_type){case"boolean":h=!!i?BX.message("JS_CORE_TMR_ON"):BX.message("JS_CORE_TMR_OFF");break;case"time":if(typeof i=="undefined"){p=this.needParamsHint=true;h="- - - <sup>*</sup>"}else{h=/^\d{1,2}:\d\d\s*(am|pm){0,1}$/gi.test(i)?i:BX.timeman.formatTime(i,false,t.input_type!="clock")}break;case"enum":h=t.input_values[i];break;default:h=i}s.appendChild(BX.create("DIV",{children:[BX.create("SPAN",p?{html:"<i>"+h+"</i>"}:{props:{className:"period-setting-value"},text:h,events:{click:BX.delegate(function(){s.parentNode.replaceChild(this._Control(t,true),s)},this)}})]}))}else{var A=[];switch(t.input_type){case"checkbox":A=[BX.create("INPUT",{props:{type:"checkbox",name:t.name,id:"tm_setting_"+t.name+"_"+this.uniqid,value:"Y",defaultChecked:!!i,checked:!!i},events:{click:BX.delegate(function(e){this._OnChange();if(t.callback)return t.callback.apply(BX.proxy_context,arguments)},this)}}),BX.create("LABEL",{props:{htmlFor:"tm_setting_"+t.name+"_"+this.uniqid},text:BX.message("JS_CORE_TMR_ON")})];break;case"clock":A=[BX.create("SPAN",{props:{className:"tm-clock-area"},children:[BX.create("SPAN",{props:{className:"tm-dashboard-clock tm-icon-clock"}}),BX.create("INPUT",{props:{className:"tm-clock-select"+(BX.isAmPmMode()?" tm-clock-select-ampm":""),name:t.name,value:t.value_type=="time"?BX.timeman.formatTime(i):i,readOnly:true,BXUNIQID:T},events:{click:BX.proxy(this.ShowClock,this)}})]})];break;case"select":var S=BX.create("SELECT",{props:{className:"period-setting-select"}});for(var l in t.input_values){var E=new Option(t.input_values[l],l);E.selected=l==i;try{S.add(E,null)}catch(r){S.add(E,-1)}}A=[S];break;default:A=[BX.create("INPUT",{props:{type:"text",name:t.name,value:t.value_type=="time"?BX.timeman.formatTime(i,false,true):i},events:{change:BX.delegate(function(e){this._OnChange();if(t.callback)return t.callback.apply(BX.proxy_context,arguments)},this)}})]}if(!this.data.TOP_SECTION){A.push(BX.create("A",{props:{className:"settings-restore",title:BX.message("JS_CORE_TMR_INHERIT_T")},attrs:{href:"javascript:void(0)"},events:{click:BX.delegate(function(){s.parentNode.replaceChild(this._Control(t,false),s);try{delete this.DIV.firstChild[t.name]}catch(e){}},this)}}))}BX.adjust(s,{children:A})}}if(typeof e!="undefined")this._OnChange();return s};s.prototype.ShowClock=function(t){var e=BX.proxy_context;if(!e.BXCLOCK){e.BXCLOCK=new BX.CTimeManClock({DIV:e},{node:e,start_time:BX.timeman.unFormatTime(e.value),popup_id:"tm_edit_d_"+e.name+"_"+e.BXUNIQID,clock_id:"tm_edit_d_"+e.name+"_"+e.BXUNIQID,zIndex:960,callback:BX.delegate(function(t){e.value=t;e.BXCLOCK.closeWnd();this._OnChange()},this)})}e.BXCLOCK.Show()};s.prototype._OnChange=function(t){
this.bChanged=true;this.SAVEBUTTON.setClassName("popup-window-button-accept")};function i(t,e,s,i){this.parent=t;this.cell=e;this.entry=s;this.settings=i;this.lang=this.parent.SETTINGS.LANG;BX.cleanNode(this.cell);this.DIV=this.cell.appendChild(BX.create("DIV",{props:{className:"bx-tm-entry"}}));this.bFinished=false;this.bExpired=false;this.bDataLoaded=false;this.TIMER={};this.WND=null;this.SAVEBUTTON=null;this.DATA_FOR_SAVE=[];this.arViews=BX.util.array_merge(["worktime"],this.parent.arViews);this.checkEntry();this.Redraw(true);BX.bind(this.cell,"click",BX.proxy(this.Click,this));BX.addCustomEvent(this.parent,"onRecountTotals",BX.proxy(this.onRecountTotals,this));BX.addCustomEvent("onEntryNeedReload",BX.proxy(this.onEntryNeedReload,this));this.bInit=false}i.prototype.onRecountTotals=function(t,e,s){if(this.entry.USER_ID==t&&!!this.entry.TIME_FINISH&&s==this.cell.parentNode.rowIndex){if(this.entry.ACTIVE){e.TOTAL+=parseInt(this.entry.DURATION);e.TOTAL_DAYS++;if(this.settings.UF_TM_MAX_START<this.entry.TIME_START||this.settings.UF_TM_MIN_FINISH>this.entry.TIME_FINISH||this.settings.UF_TM_MIN_DURATION>this.entry.DURATION){e.TOTAL_VIOLATIONS++}}else{e.TOTAL_INACTIVE++}}};i.prototype.checkEntry=function(){this.entry.TIME_START=parseInt(this.entry.TIME_START);this.entry.TIME_FINISH=parseInt(this.entry.TIME_FINISH);this.entry.DURATION=parseInt(this.entry.DURATION);this.date_start=new Date(this.entry.DATE_START*1e3);this.timezone_diff=(this.date_start.getHours()-Math.floor(this.entry.TIME_START/3600))*36e5;this.today=new Date(this.parent.today.valueOf());this.entry.DAY=new Date(this.date_start.valueOf());this.bFinished=!!this.entry.TIME_FINISH&&!this.entry.PAUSED;this.bExpired=!this.bFinished&&(this.entry.DAY.getDate()!=this.today.getDate()||this.entry.DAY.getMonth()!=this.today.getMonth()||this.entry.DAY.getYear()!=this.today.getYear())};i.prototype.onEntryNeedReload=function(t){if(this!=BX.proxy_context&&this.entry.ID==(BX.proxy_context.entry||t).ID){this.entry=t;this.bDataLoaded=true;this.checkEntry();this.Redraw(true)}};i.prototype.Redraw=function(t){var e;BX.cleanNode(this.DIV);for(var s=0,i=this.arViews.length;s<i;s++){var a=this.arViews[s];if(this.TIMER[a]){this.TIMER[a].Finish();this.TIMER[a]=null}switch(a){case"worktime":if(this.bFinished){this.DIV.appendChild(BX.create("DIV",{props:{className:"bx-tm-view-"+a},text:BX.timeman.formatWorkTime(this.entry.DURATION)}))}else if(this.bExpired){this.DIV.appendChild(BX.create("DIV",{props:{className:"bx-tm-report-expired bx-tm-view-"+a},text:this.lang.EXP}))}else if(this.entry.PAUSED){this.DIV.appendChild(BX.create("DIV",{props:{className:"bx-tm-view-"+a},text:BX.timeman.formatWorkTime(this.entry.TIME_FINISH-this.entry.TIME_START-this.entry.TIME_LEAKS)}))}else{e=this.DIV.appendChild(BX.create("DIV",{props:{className:"bx-tm-view-"+a}}));this.TIMER[a]=BX.timer(e,{dt:-this.entry.TIME_LEAKS*1e3,from:this.date_start,display:"worktime"})}break;case"arrival":this.DIV.appendChild(BX.create("DIV",{props:{className:"bx-tm-view-"+a},text:BX.timeman.formatTime(this.entry.TIME_START)}));break;case"departure":if(this.bFinished)this.DIV.appendChild(BX.create("DIV",{props:{className:"bx-tm-view-"+a},text:BX.timeman.formatTime(this.entry.TIME_FINISH)}));else if(this.bExpired)this.DIV.appendChild(BX.create("DIV",{props:{className:"bx-tm-report-expired bx-tm-view-"+a},text:BX.isAmPmMode()?"11:59 pm":"23:59"}));else{e=this.DIV.appendChild(BX.create("DIV",{props:{className:"bx-tm-view-"+a}}));this.TIMER[a]=BX.timer(e,{dt:-this.timezone_diff})}break}}if(!this.entry.ACTIVE)BX.addClass(this.cell,"bx-tm-report-inactive");else BX.removeClass(this.cell,"bx-tm-report-inactive");if(this.entry.ACTIVATED)BX.addClass(this.cell,"bx-tm-report-activated");else BX.removeClass(this.cell,"bx-tm-report-activated");if(!t){BX.onCustomEvent(this,"onEntryNeedReload",[this.entry])}BX.onCustomEvent(this,"onTimeManEntryDraw",[this.entry])};i.prototype.Click=function(){BX.StartNotifySlider(this.entry.USER_ID,this.entry.ID,0)};i.prototype.Reset=function(t){if(!t||!t.ID)return;this.Show(t);this.Redraw();BX.onCustomEvent(this.parent,"onEntryReloaded",[{ID:t.ID,USER_ID:t.USER_ID,ROW:this.cell.parentNode.rowIndex}])};i.prototype.Show=function(t){if(null==this.WND||!!this.WND.bCleared){this.WND=null;this.WND=new BX.CTimeManReportForm(window.BXTIMEMAN||{},{bind:this.cell.firstChild,node:this.cell.firstChild,mode:"admin",data:t,offsetLeft:-100,parent_object:this})}this.WND.Show();if(t){if(t.INFO){var e=BX.clone(t.INFO.INFO,true);e.ACTIVE=e.ACTIVE=="Y";e.PAUSED=e.PAUSED=="Y";e.ACTIVATED=e.ACTIVATED=="Y";e.CAN_EDIT=t.INFO.CAN_EDIT=="Y"?"Y":"N";t=e}this.bDataLoaded=true;this.entry=t;this.checkEntry();this.Redraw()}};i.prototype.Approve=function(){this.DATA_FOR_SAVE[this.DATA_FOR_SAVE.length]={fld:"approve",val:true};if(this.TIMEOUT_SAVE)clearTimeout(this.TIMEOUT_SAVE);this.saveData();BX.addClass(this.cell,"bx-tm-report-activated")};i.prototype.getPopupContent=function(){var t={},e=null;this.DIV_CONTENT=BX.create("DIV",{props:{className:"bx-tm-report-popup"},children:[BX.create("DIV",{props:{className:"bx-tm-report-popup-title"},text:this.entry.DAY_START+" "+this.entry.NAME}),BX.create("DIV")]});var s=new BX.CTimeManTabControl(this.DIV_CONTENT.lastChild);s.addTab({id:"time",title:BX.message("JS_CORE_TM_WD"),content:BX.create("DIV",{props:{className:"bx-tm-report-worktime"},children:[t.TIME_START=BX.create("DIV",{children:[BX.create("SPAN",{props:{className:"bx-tm-report-caption"},text:this.lang.CAPTION_ARRIVAL+": "}),BX.create("SPAN",{props:{className:"bx-tm-report-field",bx_tm_tag:"TIME_START"},text:BX.timeman.formatTime(this.entry.TIME_START),events:{click:BX.proxy(this.Edit,this)}})]}),t.TIME_FINISH=BX.create("DIV",{children:[BX.create("SPAN",{props:{className:"bx-tm-report-caption"},text:this.lang.CAPTION_DEPARTURE+": "}),BX.create("SPAN",{props:{className:"bx-tm-report-field"+(this.bExpired?" bx-tm-report-field-expired":""),bx_tm_tag:"TIME_FINISH"},html:this.entry.TIME_FINISH?BX.timeman.formatTime(this.entry.TIME_FINISH):this.bExpired?BX.isAmPmMode()?"11:59 pm":"23:59":"&nbsp;",events:{click:BX.proxy(this.Edit,this)}})]})]})});if(!this.bExpired){t.TIME_FINISH.parentNode.appendChild(t.DURATION=BX.create("DIV",{children:[BX.create("SPAN",{props:{className:"bx-tm-report-caption"},text:this.lang.CAPTION_DURATION+": "}),BX.create("SPAN",{props:{className:"bx-tm-report-field",bx_tm_tag:"DURATION"},html:this.entry.DURATION>0?BX.timeman.formatWorkTime(this.entry.DURATION):this.entry.PAUSED?BX.timeman.formatWorkTime(this.entry.TIME_FINISH-this.entry.TIME_START-this.entry.TIME_LEAKS):BX.timeman.formatWorkTime(0),events:this.entry.TIME_FINISH?{click:BX.proxy(this.EditWorkTime,this)}:null})]}));if(!this.entry.TIME_FINISH&&this.entry.CAN_EDIT){new BX.CHint({parent:t.DURATION,hint:this.lang.DAY_NOT_FINISHED,show_timeout:10,hide_timeout:10})}}if(this.entry.REPORT||this.entry.TASKS&&this.entry.TASKS.length>0||this.entry.EVENTS&&this.entry.EVENTS.length>0){var i=null,a=null,T=null,n,r;s.addTab({id:"plan",title:BX.message("JS_CORE_TM_PLAN"),content:BX.create("DIV",{children:[this.entry.REPORT?BX.create("DIV",{props:{className:"bx-tm-section"},children:[BX.create("DIV",{props:{className:"tm-popup-section"},html:'<span class="tm-popup-section-left"></span><span class="tm-popup-section-text">'+BX.message("JS_CORE_TM_REPORT")+'</span><span class="tm-popup-section-right"></span>'}),T=BX.create("DIV",{props:{className:"bx-tm-popup-report"},html:"<p>"+(this.entry.REPORT?BX.util.trim(this.entry.REPORT).replace(/[\n]{2}/g,"</p><p>").replace(/\n/g,"<br />"):"&nbsp;")+"</p>"})]}):null,this.entry.TASKS&&this.entry.TASKS.length>0?BX.create("DIV",{props:{className:"bx-tm-section bx-tm-popup-tasks"},children:[BX.create("DIV",{props:{className:"tm-popup-section"},html:'<span class="tm-popup-section-left"></span><span class="tm-popup-section-text">'+BX.message("JS_CORE_TM_TASKS")+'</span><span class="tm-popup-section-right"></span>'}),i=BX.create("OL",{props:{className:"tm-popup-task-list"}})]}):null,this.entry.EVENTS&&this.entry.EVENTS.length>0?BX.create("DIV",{props:{className:"bx-tm-section bx-tm-popup-events"},children:[BX.create("DIV",{props:{className:"tm-popup-section"},html:'<span class="tm-popup-section-left"></span><span class="tm-popup-section-text">'+BX.message("JS_CORE_TM_EVENTS")+'</span><span class="tm-popup-section-right"></span>'}),a=BX.create("DIV",{props:{className:"tm-popup-event-list tm-popup-events"}})]}):null]})});if(this.entry.REPORT_FULL){new BX.CHint({parent:T,hint:"<p>"+BX.util.trim(BX.util.htmlspecialchars(this.entry.REPORT_FULL)).replace(/[\n]{2}/g,"</p><p>").replace(/\n/g,"<br />")+"</p>",show_timeout:100,hide_timeout:90})}if(i){for(n=0,r=this.entry.TASKS.length;n<r;n++){i.appendChild(BX.create("LI",{props:{className:"tm-popup-task tm-popup-task-status-"+BX.timeman.TASK_SUFFIXES[this.entry.TASKS[n].STATUS],bx_task_id:this.entry.TASKS[n].ID},html:'<span class="tm-popup-task-icon"></span><a href="'+this.entry.TASKS[n].URL+'" target="_blank" class="tm-popup-task-name">'+BX.util.htmlspecialchars(this.entry.TASKS[n].TITLE)+"</a>"}))}}if(a){for(n=0,r=this.entry.EVENTS.length;n<r;n++){a.appendChild(BX.create("DIV",{props:{className:"tm-popup-event",bx_event_id:this.entry.EVENTS[n].ID},html:'<div class="tm-popup-event-datetime"><span class="tm-popup-event-time-start'+(this.entry.EVENTS[n].DATE_FROM_TODAY?"":" tm-popup-event-time-passed")+'">'+BX.timeman.formatTime(this.entry.EVENTS[n].TIME_FROM)+'</span><span class="tm-popup-event-separator">-</span><span class="tm-popup-event-time-end'+(this.entry.EVENTS[n].DATE_TO_TODAY?"":" tm-popup-event-time-passed")+'">'+BX.timeman.formatTime(this.entry.EVENTS[n].TIME_TO)+'</span></div><div class="tm-popup-event-name"><a href="'+this.entry.EVENTS[n].URL+'" target="_blank" class="tm-popup-event-text">'+this.entry.EVENTS[n].NAME+"</span></div>"}))}}if(!this.bInit&&this.entry.ACTIVE&&!this.bExpired)s.selectTab("plan")}if(!this.entry.TIME_FINISH&&!this.bExpired){this.TIMER["WND_TIME_FINISH"]=BX.timer(t.TIME_FINISH.lastChild,{dt:-this.timezone_diff});if(!this.entry.DURATION){this.TIMER["WND_DURATION"]=BX.timer(t.DURATION.lastChild,{dt:-this.entry.TIME_LEAKS*1e3,from:this.date_start,display:"worktime"})}}var l=["TIME_START","TIME_FINISH","DURATION"];for(var o=0,h=l.length;o<h;o++){var p=l[o];if(this.entry.REPORTS[p]){n=0;if(this.entry.REPORTS[p][n].ACTIVE)BX.addClass(t[p],"bx-tm-report-warning");else BX.addClass(t[p],"bx-tm-report-approve");var A=new Date(this.entry.REPORTS[p][n].TIME*1e3),S="";if(A.getDate()!=this.date_start.getDate()){S=this.lang.FIXED+" "+this.entry.REPORTS[p][n].DATE_TIME}else{S=this.lang.FIXED_AT+" "+BX.timeman.formatTime(A.getHours()*3600+A.getMinutes()*60)}var E=BX.create("SPAN",{props:{className:"bx-tm-report-warning-info"},children:[BX.create("SPAN",{props:{className:"bx-tm-report-warning-info-time"},text:"("+S+")"})]});t[p].appendChild(E);e=BX.create("DIV",{props:{className:"bx-tm-report-warn-info"},children:[BX.create("DIV",{children:[BX.create("SPAN",{props:{className:"bx-tm-report-caption"},text:this.lang.FIXED_CAPTION+": "}),BX.create("SPAN",{props:{className:"bx-tm-report-field"},html:this.entry.REPORTS[p][n].REPORT||" "})]}),this.entry.REPORTS[p][n].ACTIVE?null:BX.create("DIV",{children:[BX.create("SPAN",{props:{className:"bx-tm-report-caption"},text:this.lang.FIXED_APPROVER+": "}),BX.create("SPAN",{props:{className:"bx-tm-report-field"},html:this.entry.REPORTS[p][n].USER_NAME||" "})]})]});if(this.entry.REPORTS[p][n].REPORT_FULL){new BX.CHint({parent:e.firstChild.lastChild,hint:"<p>"+BX.util.trim(this.entry.REPORTS[p][n].REPORT_FULL).replace(/[\n]{2}/g,"</p><p>").replace(/\n/g,"<br />")+"</p>",show_timeout:100,hide_timeout:90})}if(t[p].nextSibling)t[p].parentNode.insertBefore(e,t[p].nextSibling);else t[p].parentNode.appendChild(e)}}if(Math.abs(this.entry.TIME_LEAKS)>=60){e=BX.create("DIV",{props:{className:"bx-tm-report-warn-info"},children:[BX.create("DIV",{children:[BX.create("SPAN",{props:{className:"bx-tm-report-caption"},text:this.lang.LEAKS_CAPTION+": "}),BX.create("SPAN",{props:{className:"bx-tm-report-field"},text:BX.timeman.formatWorkTime(this.entry.TIME_LEAKS)})]})]});t.DURATION.parentNode.appendChild(e)}this.bInit=true;return this.DIV_CONTENT};i.prototype.getPopupButtons=function(){var t=[];if(this.entry.CAN_EDIT){this.SAVEBUTTON=new BX.PopupWindowButton({text:this.entry.ACTIVE?this.lang.SAVE:this.lang.APPROVE,className:this.entry.ACTIVE?"":"popup-window-button-accept",events:{click:BX.proxy(this.saveData,this)}});t.push(this.SAVEBUTTON)}t.push(new BX.PopupWindowButtonLink({text:this.lang.CLOSE,className:"popup-window-button-link-cancel",events:{click:BX.proxy(this.closeWnd,this)}}));return t};i.prototype.closeWnd=function(t){this.WND.close();return BX.PreventDefault(t)};i.prototype._Edit=function(t,e){this.DATA_FOR_SAVE[this.DATA_FOR_SAVE.length]={fld:t,val:e};this.SAVEBUTTON.setClassName("popup-window-button-accept")};i.prototype.Edit=function(){if(!this.entry.CAN_EDIT)return false;var t=BX.proxy_context,e=t.bx_tm_tag,s=t.innerText||t.textContent,i=BX.delegate(function(i){this.parent.CLOCK.closeWnd();i=BX.timeman.unFormatTime(i);if(!isNaN(i)&&i!=BX.timeman.unFormatTime(s)){t.innerHTML=BX.timeman.formatTime(i);this._Edit(e,i)}},this);if(!this.parent.CLOCK){this.parent.CLOCK=new BX.CTimeManClock({DIV:this.DIV_CONTENT},{node:t,popup_id:"tm_report_edit",clock_id:"tm_repopt_edit_clock",zIndex:1,callback:i})}else{this.parent.CLOCK.setNode(t);this.parent.CLOCK.setCallback(i)}this.parent.CLOCK.setTime(BX.timeman.unFormatTime(s));this.parent.CLOCK.Show();return true};i.prototype.EditWorkTime=function(){if(!this.entry.CAN_EDIT||!this.entry.TIME_FINISH)return false;var t=BX.proxy_context,e=t.bx_tm_tag,s=BX.timeman.unFormatTime(t.innerText||t.textContent),i=BX.delegate(function(i){i=BX.timeman.unFormatTime(i);if(!isNaN(i)&&i!=s){t.innerHTML=BX.timeman.formatWorkTime(i);this._Edit(e,i)}},this);var a=BX.create("INPUT",{props:{type:"text",value:BX.timeman.formatTime(s)},style:{height:t.offsetHeight-5+"px",width:t.offsetWidth+"px",marginLeft:"10px",position:"absolute"},events:{blur:function(){i(this.value);this.parentNode.removeChild(this)}}});t.parentNode.insertBefore(a,t);a.focus();return true};i.prototype.saveData=function(){if(!this.entry.CAN_EDIT)return false;if(!this.entry.ACTIVE)this.DATA_FOR_SAVE[this.DATA_FOR_SAVE.length]={fld:"approve",val:true};var t=0,e=this.DATA_FOR_SAVE.length,s={ID:this.entry.ID};if(e>0){for(;t<e;t++){s[this.DATA_FOR_SAVE[t].fld]=this.DATA_FOR_SAVE[t].val}BX.timeman.showWait(this.DIV_CONTENT);BX.timeman_query("admin_save",s,BX.proxy(this.Reset,this))}this.DATA_FOR_SAVE=[];return true};i.prototype.Clear=function(){for(var t in this.TIMER){if(this.TIMER[t].Finish)this.TIMER[t].Finish()}this.WND=null;BX.removeCustomEvent(this.parent,"onRecountTotals",BX.proxy(this.onRecountTotals,this));BX.removeCustomEvent("onEntryNeedReload",BX.proxy(this.onEntryNeedReload,this));BX.unbind(this.cell,"click",BX.proxy(this.Click,this));BX.cleanNode(this.cell)};window.JCTimeManReport=e;window.JCTimeManReportEntry=i})();
//# sourceMappingURL=script.map.js