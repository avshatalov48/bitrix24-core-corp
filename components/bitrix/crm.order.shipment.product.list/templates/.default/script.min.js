BX.namespace("BX.Crm.Order.Shipment.Product");if(typeof BX.Crm.Order.Shipment.Product.List==="undefined"){BX.Crm.Order.Shipment.Product.List=function(){this._controller=null;this._id=null;this._settings=null;this._formName="";this._form=null};BX.Crm.Order.Shipment.Product.List.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(this.dispatchSliderMessages,this))},dispatchSliderMessages:function(e){switch(e.getEventId()){case"CrmOrderShipmentProductList::productAdd":this.onProductAdd(e);break;case"CrmOrderShipmentProductListBarcodes::Save":this.onBarcodeSliderSaveData(e);break;case"CrmOrderShipmentProductListBarcodes::Init":this.onBarcodeSliderInit(e);break}},setController:function(e){this._controller=e;this._controller.setProductList(this)},getForm:function(){if(this._form===null&&this._formName){this._form=document.getElementsByName(this._formName)[0]}return this._form},setFormId:function(e){this._formName=e},getFormData:function(){var e=this.getForm();if(!e){return{}}var t=BX.ajax.prepareForm(e);if(t&&t.data&&t.data.ID){delete t.data.ID}var r=this._settings.storeBarcodeInfo;for(var o in r){if(!r.hasOwnProperty(o))continue;var n=false;if(t.data["PRODUCT"][o]["AMOUNT"]===undefined){n=true;t.data["PRODUCT"][o]["AMOUNT"]=0}for(var i in r[o]){if(!r[o].hasOwnProperty(i))continue;if(r[o][i].IS_USED==="N")continue;if(!r[o][i].BARCODES)continue;var s=r[o][i].BARCODES;var a=this.getProductStoreQuantityValue(o,i);a=a||r[o][i].QUANTITY||0;if(n&&a>0){t.data["PRODUCT"][o]["AMOUNT"]+=parseFloat(a)}if(s.length>0){var d=s.length>a?a:s.length;for(var c=0;c<d;c++){t.data=this.createBarcodeBranch(t.data,[i,"BARCODE_INFO",o,"PRODUCT"]);t.data["PRODUCT"][o]["BARCODE_INFO"][i]["BARCODE"].push(s[c])}t.data["PRODUCT"][o]["BARCODE_INFO"][i]["QUANTITY"]=a;t.data["PRODUCT"][o]["BARCODE_INFO"][i]["STORE_ID"]=i}}}return!!t&&t.data?t.data:{}},createBarcodeBranch:function(e,t){if(t.length===0){if(typeof e["BARCODE"]==="undefined")e["BARCODE"]=[];return e}var r=t.pop();if(typeof e[r]==="undefined")e[r]={};e[r]=this.createBarcodeBranch(e[r],t);return e},setFormData:function(e){if(e&&e.PRODUCT_COMPONENT_RESULT){var t=BX.processHTML(e.PRODUCT_COMPONENT_RESULT);BX("crm-product-list-container").parentNode.innerHTML=t["HTML"];if(BX.type.isDomNode(BX(this._id+"-grid-settings-window")))BX.remove(BX(this._id+"-grid-settings-window"));setTimeout(function(){for(var e in t["SCRIPT"]){if(!t["SCRIPT"].hasOwnProperty(e))continue;BX.evalGlobal(t["SCRIPT"][e]["JS"]);delete t["SCRIPT"][e]}},1)}},onDataChanged:function(){this._controller.onDataChanged()},markAsChanged:function(){this._controller.markAsChangedItem()},onProductAdd:function(e){if(e.getEventId()==="CrmOrderShipmentProductList::productAdd"){var t=e.getData();if(t.entityTypeId===BX.CrmEntityType.enumeration.ordershipment){this._controller.onProductAdd(t.basketId)}}},onProductDelete:function(e){this._controller.onProductDelete(e)},showAddProductDialog:function(){var e=this.getSetting("addProductUrl",""),t=this.getFormData();if(t&&t.PRODUCT){for(var r in t.PRODUCT){if(t.PRODUCT.hasOwnProperty(r)){e+="&BID[]="+parseInt(r)}}}BX.SidePanel.Instance.open(e+"&"+Math.floor(Math.random()*99999))},getSetting:function(e,t){return typeof this._settings[e]!=="undefined"?this._settings[e]:t},setSetting:function(e,t){this._settings[e]=t},onBarcodeClick:function(e,t,r,o){var n=BX.util.add_url_param(this.getSetting("barcodesDialogUrl"),{basketId:t,storeId:r,additionalCssPath:o});BX.Crm.Page.openSlider(n,{width:500,cacheable:false})},onProductStoreQuantityChange:function(e,t,r){r=parseFloat(r);if(r>0){this.enableBarcodesButton(e,t)}else{if(r<0||isNaN(r)){this.getProductStoreQuantity(e,t).value=0}this.disableBarcodesButton(e,t)}this.markAsChanged()},enableBarcodesButton:function(e,t){var r=BX("barcode_button_"+e+"_"+t);if(r&&r.disabled){r.disabled=false;BX.removeClass(r,"ui-btn-disabled")}},disableBarcodesButton:function(e,t){var r=BX("barcode_button_"+e+"_"+t);if(r&&!r.disabled){r.disabled=true;BX.addClass(r,"ui-btn-disabled")}},getProductStoreQuantity:function(e,t){return document.getElementsByName("PRODUCT["+e+"][BARCODE_INFO]["+t+"][QUANTITY]")[0]},getProductAmount:function(e){return document.getElementById("crm-product-amount-"+e)},getProductStoreQuantityValue:function(e,t){if(t>0){var r=this.getProductStoreQuantity(e,t);if(r!==undefined){return r.value||0}else{return null}}else{var o=this.getProductAmount(e,t);if(o!==null){return o.value||0}else{return null}}},getProductAmout:function(e){return document.getElementsByName("PRODUCT["+e+"][AMOUNT]")[0]},onAddStoreClick:function(e){this.showStoreDialog(e)},createBarcodeWidgetHead:function(e){var t={};if(e.STORE_ID>0){t["barcode"]={title:BX.message("CRM_ORDER_SPLT_BARCODE")}}if(this.isSupportedMarkingCode(e)){t["markingCode"]={title:BX.message("CRM_ORDER_SPLT_MARKING_CODE")}}return t},isBarcodeMulti:function(e){return e.BARCODE_MULTI==="Y"},isSupportedMarkingCode:function(e){return e.IS_SUPPORTED_MARKING_CODE==="Y"},createBarcodeWidgetRows:function(e,t,r,o){if(o===undefined){o=Infinity}var n=[];var i=0;e.forEach(function(e){if(i>=o){return n}var t={id:e.ID};t.barcode=e.VALUE;if(r){t.markingCode=e.MARKING_CODE}n.push(t);i++});return n},createBarcodeWidget:function(e,t){var r=this.getStoreBarcode(e);var o=r[t];var n=this.getProductStoreQuantityValue(e,t);n=n||o.QUANTITY||0;if(n<=0){return null}if(!r||!r[t]||!r[t].BARCODES){return null}return new BX.Sale.Barcode.Widget({rowData:this.createBarcodeWidgetRows(o.BARCODES,this.isBarcodeMulti(o),this.isSupportedMarkingCode(o),n),headData:this.createBarcodeWidgetHead(o),rowsCount:n,orderId:this._settings.params.ORDER_ID,basketId:e,storeId:t,isBarcodeMulti:this.isBarcodeMulti(o)})},onBarcodeSliderInit:function(e){if(e.getEventId()==="CrmOrderShipmentProductListBarcodes::Init"){var t=e.getData(),r=t.barcodeSlider;if(!this.isStoreBarcodeInfoExists(t.basketId)){return}var o=this.createBarcodeWidget(t.basketId,t.storeId);if(o){r.setWidget(o);r.setContent(BX.create("div",{attrs:{className:"crm-order-shipment-product-list-barcode-content"},children:[o.render()]}))}else{BX.debug("Can't initialize barcode widget")}}},onBarcodeSliderSaveData:function(e){if(e.getEventId()==="CrmOrderShipmentProductListBarcodes::Save"){var t=e.getData();if(t.widget){if(!this.isStoreBarcodeInfoExists(t.widget.basketId)){return}var r=t.widget,o=[];r.getItemsData().forEach(function(e){o.push({ID:e.id,VALUE:e.barcode.value,MARKING_CODE:e.markingCode.value})});this.setStoreBarcode(r.basketId,r.storeId,o);this.markAsChanged()}}},checkBarcode:function(e,t,r,o,n){BX.ajax.runComponentAction("bitrix:crm.order.shipment.product.list","checkProductBarcode",{mode:"ajax",data:{barcode:e,orderId:this._settings.params.ORDER_ID,basketId:t,storeId:r}}).then(function(e){if(e.status&&e.status==="success"){var t=null;if(e.data==="OK")t=true;else if(e.data==="ERROR")t=false;if(typeof o==="function"){o.apply(null,[t])}if(e.errors.length>0&&typeof n==="function"){n.apply(null,[e.errors])}}},function(e){{if(typeof n==="function"){n.apply(null,[e.errors])}}})},getStoreMarkingCode:function(e){if(typeof this._settings.storeMarkingCodeInfo[e]!=="undefined"){return this._settings.storeMarkingCodeInfo[e]}else{BX.debug("Can't find storeMarkingCodeInfo")}return null},isStoreBarcodeInfoExists:function(e){return typeof this._settings.storeBarcodeInfo[e]!=="undefined"},getStoreBarcode:function(e){if(this.isStoreBarcodeInfoExists(e)){return this._settings.storeBarcodeInfo[e]}else{BX.debug("Can't find storeBarcodeInfo")}return null},setStoreBarcode:function(e,t,r){if(typeof this._settings.storeBarcodeInfo[e][t].BARCODES!=="undefined"){return this._settings.storeBarcodeInfo[e][t].BARCODES=r}else{BX.debug("Can't find storeBarcodeInfo")}},setStoreUsed:function(e,t,r){if(typeof this._settings.storeBarcodeInfo[e][t]!=="undefined"){this._settings.storeBarcodeInfo[e][t]["IS_USED"]=r}else{BX.debug("Can' find storeInfo")}},getStoresBarcodeByUsing:function(e,t){var r={},o=this.getStoreBarcode(e);if(o){if(!t){r=o}else{for(var n in o){if(o.hasOwnProperty(n)&&o[n]["IS_USED"]===t){r[n]=o[n]}}}}else{BX.debug("Can' find storeInfo")}return r},getStoresBarcodeCountByUsing:function(e,t){return Object.keys(this.getStoresBarcodeByUsing(e,t)).length},createStoresList:function(e){var t=BX.create("select"),r=this.getStoresBarcodeByUsing(e,"N");if(!r){return null}for(var o in r){if(r.hasOwnProperty(o)){if(!r[o].STORE_ID){continue}t.options.add(new Option(r[o].STORE_NAME,r[o].STORE_ID))}}return t},showStoreDialog:function(e){var t=this.createStoresList(e);var r=BX.create("form",{children:[BX.create("span",{props:{className:"fields enumeration field-wrap"},style:{width:"100%",marginBottom:"0px"},children:[BX.create("span",{props:{className:"fields enumeration field-item"},style:{paddingBottom:"10px"},children:[t]})]})]});var o=BX.PopupWindowManager.create("crm_order_shipment_product_stores",null,{content:r,titleBar:BX.message("CRM_ORDER_SPLT_CHOOSE_STORE"),autoHide:false,lightShadow:true,closeByEsc:true,width:400,overlay:{backgroundColor:"black",opacity:500}});o.setButtons([new BX.PopupWindowButton({text:BX.message("CRM_ORDER_SPLT_CHOOSE"),className:"popup-window-button-accept",events:{click:BX.proxy(function(){this.addStoreRow(e,t.value);o.close();o.destroy()},this)}}),new BX.PopupWindowButtonLink({text:BX.message("CRM_ORDER_SPLT_CLOSE"),className:"popup-window-button-link-cancel",events:{click:BX.proxy(function(){o.close();o.destroy()},this)}})]);o.show();o.resizeOverlay()},addStoreRow:function(e,t){var r=this.getStoreBarcode(e);if(!r){BX.debug("Can't find stores info");return}if(typeof r[t]==="undefined"){BX.debug("Can't find store");return}var o=this._settings.storeTmpl,n=this._settings.storeQuantityTmpl,i=this._settings.storeRemainingQuantityTmpl;if(r[t].BARCODE_MULTI==="Y"||r[t].IS_SUPPORTED_MARKING_CODE==="Y"){var s=this._settings.storeBarcodeTmplB}else{s=this._settings.storeBarcodeTmplI}var a=0;if(r[t].hasOwnProperty("QUANTITY")){a=Number(r[t].QUANTITY)||0}for(var d in r[t]){if(!r[t].hasOwnProperty(d)){continue}var c=new RegExp("#"+d+"#","g"),u=BX.util.htmlspecialchars(r[t][d]);if(typeof u==="object"){continue}o=o.replace(c,u);n=n.replace(c,u);s=s.replace(c,u);i=i.replace(c,u)}var l=this.createElement(o);BX.addClass(l,"crm-order-product-store-row-hidden");var f=BX("crm-shipment-product-store-"+e);if(f!==null){f.insertBefore(l,BX("crm-shipment-product-storeadd-"+e))}var h=this.createElement(n);BX.addClass(h,"crm-order-product-store-row-hidden");this.addChildElementToNode("crm-shipment-product-quantity-"+e,h);var B=this.createElement(i);BX.addClass(B,"crm-order-product-store-row-hidden");this.addChildElementToNode("crm-shipment-product-rquantity-"+e,B);var m=this.createElement(s);BX.addClass(m,"crm-order-product-store-row-hidden");this.addChildElementToNode("crm-shipment-product-barcode-"+e,m);if(a===0){this.disableBarcodesButton(e,t)}setTimeout(function(){BX.removeClass(l,"crm-order-product-store-row-hidden");BX.removeClass(h,"crm-order-product-store-row-hidden");BX.removeClass(B,"crm-order-product-store-row-hidden");BX.removeClass(m,"crm-order-product-store-row-hidden")},100);this.setStoreUsed(e,t,"Y");if(this.getStoresBarcodeCountByUsing(e,"N")<=0){this.hideStoreAdder(e)}this.markAsChanged();this.onStoreListChange(e)},createElement:function(e){return BX.create("div",{html:e}).firstChild},getProductStoreAmountValue:function(e,t){return this._settings.storeBarcodeInfo[e][t].AMOUNT},onStoreDeleteClick:function(e,t){var r=BX.findChildren(this.getForm(),{attribute:{"data-ps-basketcode":e,"data-ps-store-id":t}},true);for(var o in r){if(r.hasOwnProperty(o)){BX.addClass(r[o],"crm-order-product-store-row-hidden");(function(t,o){setTimeout(function(){r[t].parentNode.removeChild(r[t]);o.showStoreAdder(e)},400)})(o,this)}}this.setStoreUsed(e,t,"N");this.onStoreListChange(e);this.markAsChanged()},onStoreListChange:function(e){var t=BX("crm-shipment-product-store-"+e);if(t!==null){var r=t.querySelectorAll(".crm-order-product-store-container");var o=this.getStoresBarcodeCountByUsing(e,"Y");if(o>1){for(var n=0;n<r.length;n++){this.showStoreDeleteButton(r[n])}}else{for(var n=0;n<r.length;n++){this.hideStoreDeleteButton(r[n])}}}},showStoreDeleteButton:function(e){var t=e.querySelector(".crm-order-product-store-del-container");if(t!==null){BX.show(t,"inline-block")}},hideStoreDeleteButton:function(e){var t=e.querySelector(".crm-order-product-store-del-container");if(t!==null){BX.hide(t)}},onBarcodeChange:function(e){this.checkBarcode(e.value,e.parentNode.getAttribute("data-ps-basketcode"),0,BX.proxy(function(t){this.showBarcodeCheckResult(e,t)},this),BX.proxy(function(e){BX.debug(e)},this));this.markAsChanged()},showBarcodeCheckResult:function(e,t){if(t===false){BX.addClass(e,"barcode-error");BX.removeClass(e,"barcode-ok")}else if(t===true){BX.addClass(e,"barcode-ok");BX.removeClass(e,"barcode-error")}else{BX.removeClass(e,"barcode-error");BX.removeClass(e,"barcode-ok")}},showStoreAdder:function(e){BX.removeClass(BX("crm-shipment-product-storeadd-"+e),"crm-order-product-store-storeadder-hidden")},hideStoreAdder:function(e){BX.addClass(BX("crm-shipment-product-storeadd-"+e),"crm-order-product-store-storeadder-hidden")},addChildElementToNode:function(e,t){var r=BX(e);if(r!==null){r.appendChild(t);return true}return false}};BX.Crm.Order.Shipment.Product.List.create=function(e,t){var r=new BX.Crm.Order.Shipment.Product.List;r.initialize(e,t);return r}}
//# sourceMappingURL=script.map.js