var CrmWebFormList=function(t){this.init=function(t){this.context=BX(t.context);this.canEdit=t.canEdit;this.nodeHead=this.context.querySelector(".crm-webform-list-header");this.headHideClass="crm-webform-title-close";this.formAttribute="data-bx-crm-webform-item";this.formAttributeIsSystem="data-bx-crm-webform-item-is-system";this.forms=[];this.mess=t.mess||{};this.viewList=t.viewList||{};this.actionList=t.actionList||[];var e=this.context.querySelectorAll("["+this.formAttribute+"]");for(var i=0;i<e.length;i++){var s=e.item(i);var o=s.getAttribute("data-bx-crm-webform-item");var n=s.getAttribute(this.formAttributeIsSystem)=="Y";this.initForm({caller:this,id:o,node:s,isSystem:n,viewUserOptionName:t.viewUserOptionName,detailPageUrlTemplate:t.detailPageUrlTemplate,actionRequestUrl:t.actionRequestUrl,canUseVoteClient:t.canUseVoteClient})}var r=BX("CRM_LIST_DESC_BTN_HIDE");if(r){BX.bind(r,"click",function(){BX.addClass(BX("CRM_LIST_DESC_CONT"),"crm-webform-list-info-hide");BX.userOptions.delay=0;BX.userOptions.save("imopenlines",t.viewUserOptionName,"hide-desc","Y")})}};this.onBeforeDeleteForm=function(t){var e=this.forms.filter(function(t){return t.isSystem==false});if(e.length>1){return}BX.addClass(this.nodeHead,this.headHideClass)};this.onAfterDeleteForm=function(t){var e=BX.util.array_search(t,this.forms);if(e>-1){delete this.forms[e]}};this.onRevertDeleteForm=function(t){BX.removeClass(this.nodeHead,this.headHideClass)};this.initForm=function(t){var e=new CrmWebFormListItem(t);this.forms.push(e)};this.init(t)};function CrmWebFormListItem(t){this.caller=t.caller;this.id=t.id;this.node=t.node;this.isSystem=t.isSystem;this.actionRequestUrl=t.actionRequestUrl;this.canUseVoteClient=t.canUseVoteClient;this.viewUserOptionName=t.viewUserOptionName;this.detailPageUrlTemplate=t.detailPageUrlTemplate;this.nodeDelete=this.node.querySelector(".copy-to-buffer-button");this.nodeCopyToClipboard=this.node.querySelector(".copy-to-clipboard-node");this.nodeCopyToClipboardButton=this.node.querySelector(".copy-to-clipboard-button");this.nodeDelete=this.node.querySelector("[data-bx-crm-webform-item-delete]");this.nodeSettings=this.node.querySelector("[data-bx-crm-webform-item-settings]");this.nodeViewSettings=this.node.querySelector("[data-bx-crm-webform-item-view-settings]");this.nodeView=this.node.querySelector("[data-bx-crm-webform-item-view]");this.isActiveControlLocked=false;this.popupSettings=null;this.popupViewSettings=null;this.activeController=new CrmWebFormListItemActiveDateController({caller:this});this.bindControls(t)}CrmWebFormListItem.prototype={showViewSettings:function(){var t=[];var e=this.getCurrentViewType();for(var i in this.caller.viewList){if(!this.caller.viewList.hasOwnProperty(i))continue;var s=this.caller.viewList[i];t.push({id:i,text:s["NAME"],className:e==i?"view-settings-menu-sort-item-checked":"view-settings-menu-sort-item-checked-no",onclick:BX.proxy(this.onClickViewSettingsItem,this)})}if(!this.popupViewSettings){this.popupViewSettings=this.createPopup("crm_webform_list_view_settings_"+this.id,this.nodeViewSettings,t)}else{t.forEach(function(t){var e=this.popupViewSettings.getMenuItem(t.id);e.className=t.className;BX.removeClass(e.layout.item,"view-settings-menu-sort-item-checked");BX.addClass(e.layout.item,e.className)},this)}this.popupViewSettings.popupWindow.show()},showSettings:function(){if(!this.popupSettings){var t=[];var e=this.caller.actionList[this.isSystem?"SYSTEM":"USER"];for(var i in e){if(!e.hasOwnProperty(i))continue;var s=e[i];var o={id:s.id,text:s.text,link:s.url};switch(o.id){case"view":case"edit":o.onclick=BX.proxy(function(){this.redirectToDetailPage(this.id)},this);break;case"copy":o.onclick=BX.proxy(this.copy,this);break;case"reset_counters":o.onclick=BX.proxy(this.resetCounters,this);break}t.push(o)}this.popupSettings=this.createPopup("crm_webform_list_settings_"+this.id,this.nodeSettings,t,{offsetLeft:-30,offsetTop:10})}this.popupSettings.popupWindow.show()},onClickViewSettingsItem:function(t,e){var i=this.caller.viewList[e.id];i.id=e.id;this.closePopup(this.popupViewSettings);this.changeViewType(i)},getCurrentViewType:function(){var t=null;for(var e in this.caller.viewList){if(!this.caller.viewList.hasOwnProperty(e))continue;if(!t)t=e;var i=this.caller.viewList[e]["CLASS_NAME"];if(BX.hasClass(this.nodeView,i)){return e}}return t},changeViewType:function(t){for(var e in this.caller.viewList){if(!this.caller.viewList.hasOwnProperty(e))continue;var i=this.caller.viewList[e]["CLASS_NAME"];var s=this.nodeView.querySelector('[data-bx-crm-webform-view-info="'+e+'"]');var o=t.id==e;this.changeClass(this.nodeView,i,o);this.changeClass(s,"crm-webform-list-widget-content-item-show",o)}BX.userOptions.save("imopenlines",this.viewUserOptionName,this.id,t.id)},showErrorPopup:function(t){t=t||{};var e=t.text||this.caller.mess.errorAction;var i=BX.PopupWindowManager.create("crm_webform_list_error",null,{autoHide:true,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500}});i.setButtons([new BX.PopupWindowButton({text:this.caller.mess.dlgBtnClose,events:{click:function(){this.popupWindow.close()}}})]);i.setContent('<span class="crm-webform-edit-warning-popup-alert">'+e+"</span>");i.show()},showConfirmPopup:function(t){t=t||{};var e=t.text||this.caller.mess.confirmAction;var i=BX.PopupWindowManager.create("crm_webform_list_confirm",null,{autoHide:true,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500}});i.setButtons([new BX.PopupWindowButton({text:this.caller.mess.dlgBtnApply,className:"popup-window-button-accept",events:{click:function(){this.popupWindow.close();t.action.apply(this,[])}}}),new BX.PopupWindowButton({text:this.caller.mess.dlgBtnCancel,events:{click:function(){this.popupWindow.close()}}})]);i.setContent('<span class="crm-webform-edit-warning-popup-confirm">'+e+"</span>");i.show()},changeActive:function(t,e){if(!this.caller.canEdit){return}e=e||false;if(this.isActiveControlLocked){return}var i=this.activeController.isActive();if(i){this.activeController.deactivate()}else{this.activeController.activate()}if(e){return}this.isActiveControlLocked=true;this.sendActionRequest(i?"deactivate":"activate",function(t){this.isActiveControlLocked=false},function(t){t=t||{error:true,text:""};this.isActiveControlLocked=false;this.activeController.revert();if(t.limited){if(!B24||!B24["licenseInfoPopup"]){return}BX.UI.InfoHelper.show(this.caller.mess.limitInfoHelper)}else{this.showErrorPopup(t)}})},createLine:function(t,e){if(!this.caller.canEdit){return}e=e||false;if(this.isActiveControlLocked){return}if(e){return}this.isActiveControlLocked=true;this.sendActionRequest("create",function(t){location.href=this.detailPageUrlTemplate.replace("#ID#",t.config_id)},function(t){t=t||{error:true,text:""};this.isActiveControlLocked=false;if(t.limited){if(!B24||!B24["licenseInfoPopup"]){return}BX.UI.InfoHelper.show(this.caller.mess.limitInfoHelper)}else{this.showErrorPopup(t)}})},redirectToDetailPage:function(t){window.location=this.detailPageUrlTemplate.replace("#ID#",t).replace("#CONFIG_ID#",t)},delete:function(){this.showConfirmPopup({text:this.caller.mess.deleteConfirmation,action:BX.proxy(function(){var t="crm-webform-row-close";BX.addClass(this.node,t);this.caller.onBeforeDeleteForm(this);this.sendActionRequest("delete",function(t){this.caller.onAfterDeleteForm(this)},function(e){BX.removeClass(this.node,t);this.caller.onRevertDeleteForm(this);this.showErrorPopup(e)})},this)})},sendActionRequest:function(t,e,i){e=e||null;i=i||BX.proxy(this.showErrorPopup,this);BX.ajax({url:this.getActionRequestUrlWithParams(t),method:"POST",data:{action:t,config_id:this.id,sessid:BX.bitrix_sessid()},timeout:30,dataType:"json",processData:true,onsuccess:BX.proxy(function(t){t=t||{};if(t.error){i.apply(this,[t])}else if(e){e.apply(this,[t])}},this),onfailure:BX.proxy(function(){var t={error:true,text:""};i.apply(this,[t])},this)})},getActionRequestUrlWithParams:function(t){var e=this.actionRequestUrl;if(e.charAt(0)==="/"){e=window.location.protocol+"//"+window.location.host+e}var i=new URL(e);switch(t){case"create":var s=this.canUseVoteClient?"Y":"N";i.searchParams.set("rating-request",s);break}i.searchParams.set("action-line",t);return i.href},bindControls:function(){BX.clipboard.bindCopyClick(this.nodeCopyToClipboardButton,{text:this.nodeCopyToClipboard});BX.bind(this.nodeDelete,"click",BX.proxy(this.delete,this));BX.bind(this.activeController.nodeActiveControl,"click",BX.proxy(this.changeActive,this));BX.bind(this.activeController.nodeButton,"click",BX.proxy(this.changeActive,this));if(!this.caller.isBindCreate){this.caller.isBindCreate=true;BX.bind(this.activeController.nodeCreateControl,"click",BX.proxy(this.createLine,this))}BX.bind(this.nodeSettings,"click",BX.proxy(this.showSettings,this));BX.bind(this.nodeViewSettings,"click",BX.proxy(this.showViewSettings,this));BX.bind(this.nodeBtnGetScript,"click",BX.proxy(this.showScriptPopup,this))},changeClass:function(t,e,i){i=i||false;if(!t){return}if(i){BX.addClass(t,e)}else{BX.removeClass(t,e)}},styleDisplay:function(t,e,i){e=e||false;i=i||"";if(!t){return}t.style.display=e?i:"none"},createPopup:function(t,e,i,s){s=s||{};return BX.PopupMenu.create(t,e,i,{autoHide:true,offsetLeft:s.offsetLeft?s.offsetLeft:-21,offsetTop:s.offsetTop?s.offsetTop:-3,angle:{position:"top",offset:42},events:{onPopupClose:BX.delegate(this.onPopupClose,this)}})},closePopup:function(t){if(t&&t.popupWindow){t.popupWindow.close()}},onPopupClose:function(){}};function CrmWebFormListItemActiveDateController(t){this.caller=t.caller;this.nodeActiveControl=this.caller.node.querySelector("[data-bx-crm-webform-item-active]");this.nodeCreateControl=BX("crm-webform-list-create");this.nodeDate=this.caller.node.querySelector("[data-bx-crm-webform-item-active-date]");this.classDateNow="user-container-show-now";this.classDateNowState="user-container-show-now-deact";this.classOn="crm-webform-list-on";this.classOff="crm-webform-list-off";this.nodeButton=this.caller.node.querySelector("[data-bx-crm-webform-item-active-btn]");this.classBtnOn="webform-small-button-transparent";this.classBtnOff="webform-small-button-accept";this.classViewInactive="crm-webform-list-widget-inactive";this.isNowShowedCounter=0;this.isRevert=false}CrmWebFormListItemActiveDateController.prototype={isActive:function(){return BX.hasClass(this.nodeButton,this.classBtnOn)},revert:function(){this.isRevert=true;this.toggle();if(this.isNowShowedCounter<2){this.isNowShowedCounter=0}this.isRevert=false},toggle:function(){if(this.isActive()){this.deactivate()}else{this.activate()}},activate:function(){BX.addClass(this.nodeActiveControl,this.classOn);BX.removeClass(this.nodeActiveControl,this.classOff);this.actualizeButton();this.actualizeDate()},deactivate:function(){BX.removeClass(this.nodeActiveControl,this.classOn);BX.addClass(this.nodeActiveControl,this.classOff);this.actualizeButton();this.actualizeDate()},actualizeButton:function(){var t=this.isActive();this.caller.changeClass(this.caller.nodeView,this.classViewInactive,t);this.caller.changeClass(this.nodeButton,this.classBtnOn,!t);this.caller.changeClass(this.nodeButton,this.classBtnOff,t);this.nodeButton.innerText=t?this.nodeButton.getAttribute("data-bx-text-on"):this.nodeButton.getAttribute("data-bx-text-off")},actualizeDate:function(){this.caller.changeClass(this.nodeDate,this.classDateNowState,!this.isActive());var t=!this.isRevert||this.isNowShowedCounter>1;this.caller.changeClass(this.nodeDate,this.classDateNow,t);this.isNowShowedCounter++}};
//# sourceMappingURL=script.map.js