{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {Event, Loc, Reflection} from 'main.core';\nimport {EntityCard} from 'catalog.entity-card';\nimport {type BaseEvent, EventEmitter} from 'main.core.events';\nimport { Popup } from \"main.popup\";\nimport {Button} from \"ui.buttons\";\n\nclass ProductCard extends EntityCard\n{\n\t#isQuantityTraceNoticeShown = false;\n\n\tconstructor(id, settings = {})\n\t{\n\t\tsuper(id, settings);\n\t}\n\n\tgetEntityType()\n\t{\n\t\treturn 'Product';\n\t}\n\n\tonSectionLayout(event: BaseEvent)\n\t{\n\t\tconst [section, eventData] = event.getCompatData();\n\n\t\tif (eventData.id === 'catalog_parameters')\n\t\t{\n\t\t\teventData.visible = this.isSimpleProduct && this.isCardSettingEnabled('CATALOG_PARAMETERS');\n\t\t}\n\n\t\tEventEmitter.subscribe('BX.UI.EntityEditorList:onItemSelect', (event) => {\n\t\t\tconst isQuantityTraceRestricted = !(this.isWithOrdersMode && !this.isInventoryManagementUsed);\n\t\t\tif (this.#isQuantityTraceNoticeShown || !isQuantityTraceRestricted)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst field = event.getData()[1]?.field;\n\t\t\tif (!field)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (field.getId() !== 'QUANTITY_TRACE' || field._selectedValue !== 'N')\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst popup = new Popup({\n\t\t\t\tcontent: Loc.getMessage('CPD_QUANTITY_TRACE_NOTICE'),\n\t\t\t\toverlay: true,\n\t\t\t\ttitleBar: Loc.getMessage('CPD_QUANTITY_TRACE_NOTICE_TITLE'),\n\t\t\t\tcloseByEsc: true,\n\t\t\t\tcloseIcon: true,\n\t\t\t\tbuttons: [\n\t\t\t\t\tnew Button({\n\t\t\t\t\t\ttext: Loc.getMessage('CPD_QUANTITY_TRACE_ACCEPT'),\n\t\t\t\t\t\tclassName: 'ui-btn ui-btn-md ui-btn-primary',\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\tclick: (function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.#isQuantityTraceNoticeShown = false;\n\t\t\t\t\t\t\t\tpopup.destroy();\n\t\t\t\t\t\t\t}).bind(this),\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t],\n\t\t\t\tevents: {\n\t\t\t\t\tonAfterClose: (function () {\n\t\t\t\t\t\tthis.#isQuantityTraceNoticeShown = false;\n\t\t\t\t\t}).bind(this),\n\t\t\t\t}\n\t\t\t});\n\t\t\tpopup.show();\n\n\t\t\tthis.#isQuantityTraceNoticeShown = true;\n\t\t});\n\n\t\tsection?.getChildren().forEach((field) => {\n\t\t\tif (this.hiddenFields.includes(field?.getId()))\n\t\t\t{\n\t\t\t\tfield.setVisible(false);\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('onEntityUpdate', (event) => {\n\t\t\tconst editor = event.getData()[0]?.sender;\n\t\t\tif (!editor)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst quantityTraceValue = editor._model.getField('QUANTITY_TRACE', 'D');\n\t\t\tconst isQuantityTraceRestricted = !(this.isWithOrdersMode && !this.isInventoryManagementUsed);\n\t\t\tif (quantityTraceValue !== 'N' && isQuantityTraceRestricted)\n\t\t\t{\n\t\t\t\teditor.getControlById('QUANTITY_TRACE')?.setVisible(false);\n\t\t\t}\n\t\t});\n\t}\n\n\tonGridUpdatedHandler(event: BaseEvent)\n\t{\n\t\tsuper.onGridUpdatedHandler(event);\n\n\t\tconst [grid] = event.getCompatData();\n\t\tif ((grid && grid.getId() === this.getVariationGridId()) && (grid.getRows().getCountDisplayed() <= 0))\n\t\t{\n\t\t\tdocument.location.reload();\n\t\t}\n\t}\n\n\tonEditorAjaxSubmit(event: BaseEvent)\n\t{\n\t\tsuper.onEditorAjaxSubmit(event);\n\n\t\tconst [, response] = event.getCompatData();\n\n\t\tif (response.data)\n\t\t{\n\t\t\tif (response.data.NOTIFY_ABOUT_NEW_VARIATION)\n\t\t\t{\n\t\t\t\tthis.showNotification(Loc.getMessage('CPD_NEW_VARIATION_ADDED'));\n\t\t\t}\n\t\t}\n\t}\n}\n\nReflection.namespace('BX.Catalog').ProductCard = ProductCard;"],"names":["ProductCard","id","settings","event","getCompatData","section","eventData","visible","isSimpleProduct","isCardSettingEnabled","EventEmitter","subscribe","isQuantityTraceRestricted","isWithOrdersMode","isInventoryManagementUsed","field","getData","getId","_selectedValue","popup","Popup","content","Loc","getMessage","overlay","titleBar","closeByEsc","closeIcon","buttons","Button","text","className","events","click","destroy","bind","onAfterClose","show","getChildren","forEach","hiddenFields","includes","setVisible","editor","sender","quantityTraceValue","_model","getField","getControlById","grid","getVariationGridId","getRows","getCountDisplayed","document","location","reload","response","data","NOTIFY_ABOUT_NEW_VARIATION","showNotification","EntityCard","Reflection","namespace"],"mappings":";;;;;;;;;KAMMA;;;GAIL,qBAAYC,EAAZ,EACA;KAAA;;KAAA,IADgBC,QAChB,uEAD2B,EAC3B;KAAA;KACC,yGAAMD,EAAN,EAAUC,QAAV;;KADD;OAAA;OAAA,OAH8B;;;KAG9B;;;;;qCAKA;OACC,OAAO,SAAP;;;;qCAGeC,OAChB;OAAA;;OACC,2BAA6BA,KAAK,CAACC,aAAN,EAA7B;;WAAOC,OAAP;WAAgBC,SAAhB;;OAEA,IAAIA,SAAS,CAACL,EAAV,KAAiB,oBAArB,EACA;SACCK,SAAS,CAACC,OAAV,GAAoB,KAAKC,eAAL,IAAwB,KAAKC,oBAAL,CAA0B,oBAA1B,CAA5C;;;OAGDC,6BAAY,CAACC,SAAb,CAAuB,qCAAvB,EAA8D,UAACR,KAAD,EAAW;SAAA;;SACxE,IAAMS,yBAAyB,GAAG,EAAE,MAAI,CAACC,gBAAL,IAAyB,CAAC,MAAI,CAACC,yBAAjC,CAAlC;;SACA,IAAI,wCAAI,8BAAJ,IAAoC,CAACF,yBAAzC,EACA;WACC;;;SAGD,IAAMG,KAAK,sBAAGZ,KAAK,CAACa,OAAN,GAAgB,CAAhB,CAAH,oDAAG,gBAAoBD,KAAlC;;SACA,IAAI,CAACA,KAAL,EACA;WACC;;;SAGD,IAAIA,KAAK,CAACE,KAAN,OAAkB,gBAAlB,IAAsCF,KAAK,CAACG,cAAN,KAAyB,GAAnE,EACA;WACC;;;SAGD,IAAMC,KAAK,GAAG,IAAIC,gBAAJ,CAAU;WACvBC,OAAO,EAAEC,aAAG,CAACC,UAAJ,CAAe,2BAAf,CADc;WAEvBC,OAAO,EAAE,IAFc;WAGvBC,QAAQ,EAAEH,aAAG,CAACC,UAAJ,CAAe,iCAAf,CAHa;WAIvBG,UAAU,EAAE,IAJW;WAKvBC,SAAS,EAAE,IALY;WAMvBC,OAAO,EAAE,CACR,IAAIC,iBAAJ,CAAW;aACVC,IAAI,EAAER,aAAG,CAACC,UAAJ,CAAe,2BAAf,CADI;aAEVQ,SAAS,EAAE,iCAFD;aAGVC,MAAM,EAAE;eACPC,KAAK,EAAG,YACR;iBACC,qEAAmC,KAAnC;iBACAd,KAAK,CAACe,OAAN;gBAHM,CAIJC,IAJI,CAIC,MAJD;;YAJT,CADQ,CANc;WAmBvBH,MAAM,EAAE;aACPI,YAAY,EAAG,YAAY;eAC1B,qEAAmC,KAAnC;cADa,CAEXD,IAFW,CAEN,MAFM;;UApBF,CAAd;SAyBAhB,KAAK,CAACkB,IAAN;SAEA,wCAAI,+BAA+B,IAA/B,CAAJ;QA7CD;OAgDAhC,OAAO,SAAP,IAAAA,OAAO,WAAP,YAAAA,OAAO,CAAEiC,WAAT,GAAuBC,OAAvB,CAA+B,UAACxB,KAAD,EAAW;SACzC,IAAI,MAAI,CAACyB,YAAL,CAAkBC,QAAlB,CAA2B1B,KAA3B,aAA2BA,KAA3B,uBAA2BA,KAAK,CAAEE,KAAP,EAA3B,CAAJ,EACA;WACCF,KAAK,CAAC2B,UAAN,CAAiB,KAAjB;;QAHF;OAOAhC,6BAAY,CAACC,SAAb,CAAuB,gBAAvB,EAAyC,UAACR,KAAD,EAAW;SAAA;;SACnD,IAAMwC,MAAM,uBAAGxC,KAAK,CAACa,OAAN,GAAgB,CAAhB,CAAH,qDAAG,iBAAoB4B,MAAnC;;SACA,IAAI,CAACD,MAAL,EACA;WACC;;;SAGD,IAAME,kBAAkB,GAAGF,MAAM,CAACG,MAAP,CAAcC,QAAd,CAAuB,gBAAvB,EAAyC,GAAzC,CAA3B;;SACA,IAAMnC,yBAAyB,GAAG,EAAE,MAAI,CAACC,gBAAL,IAAyB,CAAC,MAAI,CAACC,yBAAjC,CAAlC;;SACA,IAAI+B,kBAAkB,KAAK,GAAvB,IAA8BjC,yBAAlC,EACA;WAAA;;WACC,yBAAA+B,MAAM,CAACK,cAAP,CAAsB,gBAAtB,iFAAyCN,UAAzC,CAAoD,KAApD;;QAXF;;;;0CAgBoBvC,OACrB;OACC,8GAA2BA,KAA3B;;OAEA,4BAAeA,KAAK,CAACC,aAAN,EAAf;;WAAO6C,IAAP;;OACA,IAAKA,IAAI,IAAIA,IAAI,CAAChC,KAAL,OAAiB,KAAKiC,kBAAL,EAA1B,IAAyDD,IAAI,CAACE,OAAL,GAAeC,iBAAf,MAAsC,CAAnG,EACA;SACCC,QAAQ,CAACC,QAAT,CAAkBC,MAAlB;;;;;wCAIiBpD,OACnB;OACC,4GAAyBA,KAAzB;;OAEA,4BAAqBA,KAAK,CAACC,aAAN,EAArB;;WAASoD,QAAT;;OAEA,IAAIA,QAAQ,CAACC,IAAb,EACA;SACC,IAAID,QAAQ,CAACC,IAAT,CAAcC,0BAAlB,EACA;WACC,KAAKC,gBAAL,CAAsBrC,aAAG,CAACC,UAAJ,CAAe,yBAAf,CAAtB;;;;;;GAnHsBqC;;AAyH1BC,qBAAU,CAACC,SAAX,CAAqB,YAArB,EAAmC9D,WAAnC,GAAiDA,WAAjD;;;;"}