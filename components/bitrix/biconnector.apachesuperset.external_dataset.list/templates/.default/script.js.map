{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { MessageBox } from 'ui.dialogs.messagebox';\nimport { Reflection, Loc, Text, ajax as Ajax } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport 'spotlight';\nimport 'ui.alerts';\nimport 'ui.forms';\n\ntype Props = {\n\tgridId: ?string,\n\tisNeedShowTopMenuGuide: boolean,\n\tisNeedShowDraftGuide: boolean,\n};\n\n/**\n * @namespace BX.BIConnector\n */\nclass ExternalDatasetManager\n{\n\t#grid: BX.Main.grid;\n\t#filter: BX.Main.Filter;\n\n\tconstructor(props: Props)\n\t{\n\t\tthis.#grid = BX.Main.gridManager.getById(props.gridId)?.instance;\n\t\tthis.#filter = BX.Main.filterManager.getById(props.gridId);\n\t\tthis.#subscribeToEvents();\n\t\tthis.#initHints();\n\t}\n\n\t#initHints(): void\n\t{\n\t\tconst manager = BX.UI.Hint.createInstance({\n\t\t\tpopupParameters: {\n\t\t\t\tautoHide: true,\n\t\t\t},\n\t\t});\n\t\tmanager.init(this.#grid.getContainer());\n\t}\n\n\t#subscribeToEvents()\n\t{\n\t\tEventEmitter.subscribe('SidePanel.Slider:onMessage', (event) => {\n\t\t\tconst [messageEvent] = event.getData();\n\t\t\tif (messageEvent.getEventId() === 'BIConnector.dataset-import:onDatasetCreated')\n\t\t\t{\n\t\t\t\tthis.#grid.reload();\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('Grid::updated', () => {\n\t\t\tthis.#initHints();\n\t\t});\n\t}\n\n\tgetGrid(): BX.Main.grid\n\t{\n\t\treturn this.#grid;\n\t}\n\n\tgetFilter(): BX.Main.Filter\n\t{\n\t\treturn this.#filter;\n\t}\n\n\thandleCreatedByClick(ownerData: Object)\n\t{\n\t\tthis.handleDatasetFilterChange({\n\t\t\tfieldId: 'CREATED_BY_ID',\n\t\t\t...ownerData,\n\t\t});\n\t}\n\n\thandleUpdatedByClick(ownerData: Object)\n\t{\n\t\tthis.handleDatasetFilterChange({\n\t\t\tfieldId: 'UPDATED_BY_ID',\n\t\t\t...ownerData,\n\t\t});\n\t}\n\n\thandleSourceClick(sourceData: Object)\n\t{\n\t\tthis.handleDatasetFilterChange({\n\t\t\tfieldId: 'SOURCE.ID',\n\t\t\t...sourceData,\n\t\t});\n\t}\n\n\thandleDatasetFilterChange(fieldData: Object)\n\t{\n\t\tconst filterFieldsValues = this.getFilter().getFilterFieldsValues();\n\t\tlet currentFilteredField = filterFieldsValues[fieldData.fieldId] ?? [];\n\t\tlet currentFilteredFieldLabel = filterFieldsValues[`${fieldData.fieldId}_label`] ?? [];\n\n\t\tif (fieldData.IS_FILTERED)\n\t\t{\n\t\t\tcurrentFilteredField = currentFilteredField.filter((value) => parseInt(value, 10) !== fieldData.ID);\n\t\t\tcurrentFilteredFieldLabel = currentFilteredFieldLabel.filter((value) => value !== fieldData.TITLE);\n\t\t}\n\t\telse if (!currentFilteredField.includes(fieldData.ID))\n\t\t{\n\t\t\tcurrentFilteredField.push(fieldData.ID);\n\t\t\tcurrentFilteredFieldLabel.push(fieldData.TITLE);\n\t\t}\n\n\t\tconst filterApi = this.getFilter().getApi();\n\t\tconst filterToExtend = {};\n\t\tfilterToExtend[fieldData.fieldId] = currentFilteredField;\n\t\tfilterToExtend[`${fieldData.fieldId}_label`] = currentFilteredFieldLabel;\n\n\t\tfilterApi.extendFilter(filterToExtend);\n\t\tfilterApi.apply();\n\t}\n\n\tdeleteDataset(id) {\n\t\tconst messageBox = new BX.UI.Dialogs.MessageBox({\n\t\t\tmessage: Loc.getMessage('BICONNECTOR_SUPERSET_EXTERNAL_DATASET_GRID_DELETE_POPUP_DESCRIPTION'),\n\t\t\ttitle: Loc.getMessage('BICONNECTOR_SUPERSET_EXTERNAL_DATASET_GRID_DELETE_POPUP_TITLE'),\n\t\t\tbuttons: [\n\t\t\t\tnew BX.UI.Button({\n\t\t\t\t\tcolor: BX.UI.Button.Color.DANGER,\n\t\t\t\t\ttext: Loc.getMessage('BICONNECTOR_SUPERSET_EXTERNAL_DATASET_GRID_DELETE_POPUP_CAPTION_YES'),\n\t\t\t\t\tonclick: (button) => {\n\t\t\t\t\t\tbutton.setWaiting();\n\t\t\t\t\t\tthis.deleteDatasetAjaxAction(id)\n\t\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\t\tthis.getGrid().reload();\n\t\t\t\t\t\t\t\tmessageBox.close();\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.catch((response) => {\n\t\t\t\t\t\t\t\tmessageBox.close();\n\t\t\t\t\t\t\t\tif (response.errors)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.#notifyErrors(response.errors);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tnew BX.UI.CancelButton({\n\t\t\t\t\ttext: Loc.getMessage('BICONNECTOR_SUPERSET_EXTERNAL_DATASET_GRID_DELETE_POPUP_CAPTION_NO'),\n\t\t\t\t\tonclick: (button) => messageBox.close(),\n\t\t\t\t}),\n\t\t\t],\n\t\t});\n\n\t\tmessageBox.show();\n\t}\n\n\tdeleteDatasetAjaxAction(datasetId: int): Promise\n\t{\n\t\treturn Ajax.runAction('biconnector.externalsource.dataset.delete', {\n\t\t\tdata: {\n\t\t\t\tid: datasetId,\n\t\t\t},\n\t\t});\n\t}\n\n\tshowSupersetError(): void\n\t{\n\t\tBX.UI.Notification.Center.notify({\n\t\t\tcontent: Text.encode(Loc.getMessage('BICONNECTOR_SUPERSET_EXTERNAL_DATASET_GRID_ERROR_SUPERSET')),\n\t\t});\n\t}\n\n\t#notifyErrors(errors: Array): void\n\t{\n\t\tif (errors[0] && errors[0].message)\n\t\t{\n\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\tcontent: Text.encode(errors[0].message),\n\t\t\t});\n\t\t}\n\t}\n}\n\nReflection.namespace('BX.BIConnector').ExternalDatasetManager = ExternalDatasetManager;\n"],"names":["ExternalDatasetManager","props","BX","Main","gridManager","getById","gridId","instance","filterManager","ownerData","handleDatasetFilterChange","fieldId","sourceData","fieldData","filterFieldsValues","getFilter","getFilterFieldsValues","currentFilteredField","currentFilteredFieldLabel","IS_FILTERED","filter","value","parseInt","ID","TITLE","includes","push","filterApi","getApi","filterToExtend","extendFilter","apply","id","messageBox","UI","Dialogs","MessageBox","message","Loc","getMessage","title","buttons","Button","color","Color","DANGER","text","onclick","button","setWaiting","deleteDatasetAjaxAction","then","getGrid","reload","close","response","errors","CancelButton","show","datasetId","Ajax","runAction","data","Notification","Center","notify","content","Text","encode","manager","Hint","createInstance","popupParameters","autoHide","init","getContainer","EventEmitter","subscribe","event","getData","messageEvent","getEventId","Reflection","namespace"],"mappings":"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"}