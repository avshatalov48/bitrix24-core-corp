this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};this.BX.Crm.Entity=this.BX.Crm.Entity||{};(function(e,t,i,n,a,r,s,l,o,d,u,c,h,g,v,f){"use strict";var p;var E=function(){function e(t){babelHelpers.classCallCheck(this,e);this.editor=t}babelHelpers.createClass(e,[{key:"load",value:function e(t,i){if(!this.hintPopup){this.hintPopup=new s.Popup("ui-hint-popup-"+this.editor.getId(),null,{darkMode:true,closeIcon:true,animation:"fading-slide"})}this.hintPopup.setBindElement(t);this.hintPopup.adjustPosition();this.hintPopup.setContent(g.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div class='ui-hint-content'>","</div>\n\t\t"])),g.Text.encode(i)));return this.hintPopup}},{key:"show",value:function e(){if(this.hintPopup){this.hintPopup.show()}}},{key:"close",value:function e(){if(this.hintPopup){this.hintPopup.close()}}}]);return e}();var y,T,b,C,I;function S(e,t,i){m(e,t);return i}function m(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function P(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var R=new WeakMap;var D=new WeakMap;var N=new WeakSet;var A=new WeakSet;var F=new WeakSet;var _=function(){function e(t){babelHelpers.classCallCheck(this,e);F.add(this);A.add(this);N.add(this);R.set(this,{writable:true,value:null});D.set(this,{writable:true,value:new g.Cache.MemoryCache});babelHelpers.defineProperty(this,"isReserveEqualProductQuantity",true);babelHelpers.classPrivateFieldSet(this,R,t.model);this.inputFieldName=t.inputName||e.INPUT_NAME;this.dateFieldName=t.dateFieldName||e.DATE_NAME;this.quantityFieldName=t.quantityFieldName||e.QUANTITY_NAME;this.deductedQuantityFieldName=t.deductedQuantityFieldName||e.DEDUCTED_QUANTITY_NAME;this.defaultDateReservation=t.defaultDateReservation||null;this.isBlocked=t.isBlocked||false;this.isReserveEqualProductQuantity=t.isReserveEqualProductQuantity&&(this.getReservedQuantity()===this.getQuantity()||babelHelpers.classPrivateFieldGet(this,R).getOption("id")===null)}babelHelpers.createClass(e,[{key:"renderTo",value:function t(i){i.appendChild(g.Tag.render(y||(y=babelHelpers.taggedTemplateLiteral(["<div>","</div>"])),P(this,A,w).call(this)));g.Event.bind(P(this,A,w).call(this).querySelector("input"),"input",g.Runtime.debounce(this.onReserveInputChange,800,this));if(this.getReservedQuantity()>0||this.isReserveEqualProductQuantity){P(this,F,O).call(this,this.getDateReservation())}i.appendChild(P(this,N,U).call(this));g.Event.bind(P(this,N,U).call(this),"click",S(e,e,k).bind(this));g.Event.bind(P(this,N,U).call(this).querySelector("input"),"change",this.onDateChange.bind(this))}},{key:"setReservedQuantity",value:function e(t,i){var n=P(this,A,w).call(this).querySelector("input");if(n){n.value=t;if(i){n.dispatchEvent(new window.Event("input"))}}}},{key:"getReservedQuantity",value:function e(){return g.Text.toNumber(babelHelpers.classPrivateFieldGet(this,R).getField(this.inputFieldName))}},{key:"getDateReservation",value:function e(){return babelHelpers.classPrivateFieldGet(this,R).getField(this.dateFieldName)||null}},{key:"getQuantity",value:function e(){return g.Text.toNumber(babelHelpers.classPrivateFieldGet(this,R).getField(this.quantityFieldName))}},{key:"getDeductedQuantity",value:function e(){return g.Text.toNumber(babelHelpers.classPrivateFieldGet(this,R).getField(this.deductedQuantityFieldName))}},{key:"getAvailableQuantity",value:function e(){return this.getQuantity()-this.getDeductedQuantity()}},{key:"onReserveInputChange",value:function e(t){var i=g.Text.toNumber(t.target.value);this.changeInputValue(i)}},{key:"changeInputValue",value:function e(t){if(t>this.getAvailableQuantity()){var i="reserveCountError";var n=BX.UI.Notification.Center.getBalloonById(i);if(!n){var a={id:i,closeButton:true,autoHideDelay:3e3,content:g.Tag.render(T||(T=babelHelpers.taggedTemplateLiteral(["<div>","</div>"])),g.Loc.getMessage("CRM_ENTITY_PL_IS_LESS_QUANTITY_WITH_DEDUCTED_THEN_RESERVED"))};n=BX.UI.Notification.Center.notify(a)}n.show();t=this.getAvailableQuantity();this.setReservedQuantity(t)}if(t>0){if(this.getDateReservation()===null){this.changeDateReservation(this.defaultDateReservation)}else{P(this,F,O).call(this,babelHelpers.classPrivateFieldGet(this,R).getField(this.dateFieldName))}}else if(t<=0){this.changeDateReservation()}babelHelpers.classPrivateFieldGet(this,R).setField(this.inputFieldName,t);l.EventEmitter.emit(this,"onChange",{NAME:this.inputFieldName,VALUE:t})}},{key:"clearCache",value:function e(){babelHelpers.classPrivateFieldGet(this,D).delete("dateInput");babelHelpers.classPrivateFieldGet(this,D).delete("reserveInput")}},{key:"isInputDisabled",value:function e(){return this.isBlocked||babelHelpers.classPrivateFieldGet(this,R).isSimple()||babelHelpers.classPrivateFieldGet(this,R).isEmpty()}},{key:"onDateChange",value:function e(t){var i=t.target.value;var n=BX.parseDate(i);var a=new Date;a.setHours(0,0,0,0);if(n>=a){this.changeDateReservation(i)}else{var r="reserveDateError";var s=BX.UI.Notification.Center.getBalloonById(r);if(!s){var l={id:r,closeButton:true,autoHideDelay:3e3,content:g.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(["<div>","</div>"])),g.Loc.getMessage("CRM_ENTITY_PL_DATE_IN_PAST"))};s=BX.UI.Notification.Center.notify(l)}s.show();this.changeDateReservation(this.defaultDateReservation)}}},{key:"changeDateReservation",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;l.EventEmitter.emit(this,"onChange",{NAME:this.dateFieldName,VALUE:t});babelHelpers.classPrivateFieldGet(this,R).setField(this.dateFieldName,t);P(this,F,O).call(this,t)}}]);return e}();function k(e){BX.calendar({node:e.target,field:e.target.parentNode.querySelector("input"),bTime:false})}function U(){var e=this;return babelHelpers.classPrivateFieldGet(this,D).remember("dateInput",(function(){return g.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div>\n\t\t\t\t\t<a class="crm-entity-product-list-reserve-date"></a>\n\t\t\t\t\t<input\n\t\t\t\t\t\tdata-name="','"\n\t\t\t\t\t\tname="','"\n\t\t\t\t\t\ttype="hidden"\n\t\t\t\t\t\tvalue="','"\n\t\t\t\t\t>\n\t\t\t\t</div>\n\t\t\t'])),e.dateFieldName,e.dateFieldName,e.getDateReservation())}))}function w(){var e=this;return babelHelpers.classPrivateFieldGet(this,D).remember("reserveInput",(function(){var t=g.Tag.render(I||(I=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div>\n\t\t\t\t\t<input type="text"\n\t\t\t\t\t\tdata-name="','"\n\t\t\t\t\t\tname="','"\n\t\t\t\t\t\tclass="ui-ctl-element ui-ctl-textbox ','"\n\t\t\t\t\t\tautoComplete="off"\n\t\t\t\t\t\tvalue="','"\n\t\t\t\t\t\tplaceholder="0"\n\t\t\t\t\t\ttitle="','"\n\t\t\t\t\t\t',"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t"])),e.inputFieldName,e.inputFieldName,e.isInputDisabled()?"crm-entity-product-list-locked-field":"",e.getReservedQuantity(),e.getReservedQuantity(),e.isInputDisabled()?"disabled":"");if(e.isBlocked){t.onclick=function(){return l.EventEmitter.emit(e,"onNodeClick")}}return t}))}function O(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var t=e===null?"":g.Loc.getMessage("CRM_ENTITY_PL_RESERVED_DATE",{"#FINAL_RESERVATION_DATE#":e});var i=P(this,N,U).call(this).querySelector("a");if(i){i.innerText=t}var n=P(this,N,U).call(this).querySelector("input");if(n){n.value=e}}babelHelpers.defineProperty(_,"INPUT_NAME","INPUT_RESERVE_QUANTITY");babelHelpers.defineProperty(_,"DATE_NAME","DATE_RESERVE_END");babelHelpers.defineProperty(_,"QUANTITY_NAME","QUANTITY");babelHelpers.defineProperty(_,"DEDUCTED_QUANTITY_NAME","DEDUCTED_QUANTITY");var M;function H(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var B=new WeakMap;var L=new WeakMap;var x=new WeakMap;var G=new WeakMap;var V=new WeakSet;var Y=function(){function e(t){babelHelpers.classCallCheck(this,e);V.add(this);B.set(this,{writable:true,value:void 0});L.set(this,{writable:true,value:void 0});x.set(this,{writable:true,value:void 0});G.set(this,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,B,t.rowId);babelHelpers.classPrivateFieldSet(this,L,t.model);this.setNode(t.node)}babelHelpers.createClass(e,[{key:"setNode",value:function e(t){babelHelpers.classPrivateFieldSet(this,x,t);babelHelpers.classPrivateFieldGet(this,x).classList.add("store-available-popup-link");g.Event.bind(babelHelpers.classPrivateFieldGet(this,x),"click",this.togglePopup.bind(this))}},{key:"refreshStoreInfo",value:function e(){babelHelpers.classPrivateFieldGet(this,L).getStoreCollection().refresh()}},{key:"getPopupContent",value:function e(){var t=this;var i=babelHelpers.classPrivateFieldGet(this,L).getField("STORE_ID");var n=babelHelpers.classPrivateFieldGet(this,L).getStoreCollection();var a=n.getStoreAmount(i);var r=n.getStoreReserved(i);var s=n.getStoreAvailableAmount(i);var l=function e(t){return'<td class="main-grid-cell-head main-grid-col-no-sortable main-grid-cell-right">\n\t\t\t\t<div class="main-grid-cell-inner">\n\t\t\t\t\t<span class="main-grid-cell-head-container">'.concat(t,"</span>\n\t\t\t\t</div>\n\t\t\t</td>")};var o=function e(t){return'<td class="main-grid-cell main-grid-cell-right">\n\t\t\t\t<div class="main-grid-cell-inner">\n\t\t\t\t\t<span class="main-grid-cell-content">'.concat(t,"</span>\n\t\t\t\t</div>\n\t\t\t</td>")};var d=r>0?'<a href="#" class="store-available-popup-reserves-slider-link">'.concat(r,"</a>"):r;var u=g.Tag.render(M||(M=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="store-available-popup-container">\n\t\t\t\t<table class="main-grid-table">\n\t\t\t\t\t<thead class="main-grid-header">\n\t\t\t\t\t\t<tr class="main-grid-row-head">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t","\n\t\t\t\t\t\t\t",'\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</thead>\n\t\t\t\t\t<tbody>\n\t\t\t\t\t\t<tr class="main-grid-row main-grid-row-body">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t","\n\t\t\t\t\t\t\t","\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</tbody>\n\t\t\t\t</table>\n\t\t\t</div>\n\t\t"])),l(g.Loc.getMessage("CRM_ENTITY_PL_STORE_AVAILABLE_POPUP_QUANTITY_COMMON")),l(g.Loc.getMessage("CRM_ENTITY_PL_STORE_AVAILABLE_POPUP_QUANTITY_RESERVED")),l(g.Loc.getMessage("CRM_ENTITY_PL_STORE_AVAILABLE_POPUP_QUANTITY_AVAILABLE")),o(a),o(d),o(s));if(r>0){d=u.querySelector(".store-available-popup-reserves-slider-link");g.Event.bind(d,"click",(function(e){e.preventDefault();t.openDealsWithReservedProductSlider()}))}return u}},{key:"openDealsWithReservedProductSlider",value:function e(){var t="/bitrix/components/bitrix/catalog.productcard.reserved.deal.list/slider.php";var i=babelHelpers.classPrivateFieldGet(this,L).getField("STORE_ID");var n=babelHelpers.classPrivateFieldGet(this,L).getField("PRODUCT_ID");var a=new g.Uri(t);a.setQueryParam("productId",n);a.setQueryParam("storeId",i);BX.SidePanel.Instance.open(a.toString(),{allowChangeHistory:false,cacheable:false})}},{key:"togglePopup",value:function e(){if(babelHelpers.classPrivateFieldGet(this,G)){if(babelHelpers.classPrivateFieldGet(this,G).isShown()){babelHelpers.classPrivateFieldGet(this,G).close()}else{babelHelpers.classPrivateFieldGet(this,G).setContent(this.getPopupContent());babelHelpers.classPrivateFieldGet(this,G).show()}}else{H(this,V,X).call(this);babelHelpers.classPrivateFieldGet(this,G).show()}}}]);return e}();function X(){var e="store-available-popup-row-".concat(babelHelpers.classPrivateFieldGet(this,B));var t=s.PopupManager.getPopupById(e);if(t){babelHelpers.classPrivateFieldSet(this,G,t);babelHelpers.classPrivateFieldGet(this,G).setBindElement(babelHelpers.classPrivateFieldGet(this,x));babelHelpers.classPrivateFieldGet(this,G).setContent(this.getPopupContent())}else{babelHelpers.classPrivateFieldSet(this,G,s.PopupManager.create({id:e,bindElement:babelHelpers.classPrivateFieldGet(this,x),autoHide:true,draggable:false,offsetLeft:-218,offsetTop:0,angle:{position:"top",offset:250},noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,content:this.getPopupContent()}))}}var W,Q,q,j,K,z,Z,J;function $(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=ee(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var a=function e(){};return{s:a,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,s=false,l;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){s=true;l=t},f:function e(){try{if(!r&&i.return!=null)i.return()}finally{if(s)throw l}}}}function ee(e,t){if(!e)return;if(typeof e==="string")return te(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return te(e,t)}function te(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++){n[i]=e[i]}return n}function ie(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var ne="EDIT";var ae="SET";var re=new WeakSet;var se=new WeakSet;var le=new WeakSet;var oe=new WeakSet;var de=new WeakSet;var ue=new WeakSet;var ce=new WeakSet;var he=new WeakSet;var ge=new WeakSet;var ve=new WeakSet;var fe=new WeakSet;var pe=new WeakSet;var Ee=new WeakSet;var ye=new WeakSet;var Te=new WeakSet;var be=new WeakSet;var Ce=new WeakSet;var Ie=new WeakSet;var Se=new WeakSet;var me=new WeakSet;var Pe=function(){function e(t,i,n,a){babelHelpers.classCallCheck(this,e);me.add(this);Se.add(this);Ie.add(this);Ce.add(this);be.add(this);Te.add(this);ye.add(this);Ee.add(this);pe.add(this);fe.add(this);ve.add(this);ge.add(this);he.add(this);ce.add(this);ue.add(this);de.add(this);oe.add(this);le.add(this);se.add(this);re.add(this);babelHelpers.defineProperty(this,"fields",{});babelHelpers.defineProperty(this,"externalActions",[]);babelHelpers.defineProperty(this,"handleFocusUnchangeablePrice",ie(this,se,De).bind(this));babelHelpers.defineProperty(this,"handleChangeStoreData",ie(this,ye,Le).bind(this));babelHelpers.defineProperty(this,"handleProductErrorsChange",g.Runtime.debounce(ie(this,Te,xe),500,this));babelHelpers.defineProperty(this,"handleMainSelectorClear",g.Runtime.debounce(ie(this,ue,_e).bind(this),500,this));babelHelpers.defineProperty(this,"handleStoreFieldChange",g.Runtime.debounce(ie(this,fe,Me).bind(this),500,this));babelHelpers.defineProperty(this,"handleStoreFieldClear",g.Runtime.debounce(ie(this,pe,He).bind(this),500,this));babelHelpers.defineProperty(this,"handleOnGridUpdated",ie(this,me,We).bind(this));babelHelpers.defineProperty(this,"cache",new g.Cache.MemoryCache);babelHelpers.defineProperty(this,"modeChanges",{EDIT:ne,SET:ae});this.setId(t);this.setSettings(n);this.setEditor(a);this.setModel(i,n);this.setFields(i);ie(this,re,Re).call(this);ie(this,de,Fe).call(this);ie(this,ce,ke).call(this);ie(this,he,Ue).call(this);ie(this,ve,Oe).call(this);this.modifyBasePriceInput();this.refreshFieldsLayout();requestAnimationFrame(this.initHandlers.bind(this))}babelHelpers.createClass(e,[{key:"getNode",value:function e(){var t=this;return this.cache.remember("node",(function(){var e=t.getField("ID",0);return t.getEditorContainer().querySelector('[data-id="'+e+'"]')}))}},{key:"getSelector",value:function e(){return this.mainSelector}},{key:"clearChanges",value:function e(){this.getModel().clearChangedList()}},{key:"isNewRow",value:function e(){return isNaN(+this.getField("ID"))}},{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"getSettings",value:function e(){return this.settings}},{key:"setSettings",value:function e(t){this.settings=g.Type.isPlainObject(t)?t:{}}},{key:"getSettingValue",value:function e(t,i){return this.settings.hasOwnProperty(t)?this.settings[t]:i}},{key:"setSettingValue",value:function e(t,i){this.settings[t]=i}},{key:"setEditor",value:function e(t){this.editor=t}},{key:"getEditor",value:function e(){return this.editor}},{key:"getEditorContainer",value:function e(){return this.getEditor().getContainer()}},{key:"getHintPopup",value:function e(){return this.getEditor().getHintPopup()}},{key:"initHandlers",value:function e(){var t=this.getEditor();this.getNode().querySelectorAll("input").forEach((function(e){g.Event.bind(e,"input",t.changeProductFieldHandler);g.Event.bind(e,"change",t.changeProductFieldHandler);g.Event.bind(e,"mousedown",(function(e){return e.stopPropagation()}))}));this.getNode().querySelectorAll("select").forEach((function(e){g.Event.bind(e,"change",t.changeProductFieldHandler);g.Event.bind(e,"mousedown",(function(e){return e.stopPropagation()}))}))}},{key:"initHandlersForSelectors",value:function e(){var t=this;var i=this.getEditor();var n=["MAIN_INFO","STORE_INFO","RESERVE_INFO"];n.forEach((function(e){t.getNode().querySelectorAll('[data-name="'+e+'"] input[type="text"]').forEach((function(e){g.Event.bind(e,"input",i.changeProductFieldHandler);g.Event.bind(e,"change",i.changeProductFieldHandler);g.Event.bind(e,"mousedown",(function(e){return e.stopPropagation()}))}))}))}},{key:"unsubscribeCustomEvents",value:function e(){if(this.mainSelector){this.mainSelector.unsubscribeEvents();l.EventEmitter.unsubscribe(this.mainSelector,"onClear",this.handleMainSelectorClear)}if(this.storeSelector){this.storeSelector.unsubscribeEvents();l.EventEmitter.unsubscribe(this.storeSelector,"onChange",this.handleStoreFieldChange);l.EventEmitter.unsubscribe(this.storeSelector,"onClear",this.handleStoreFieldClear)}if(this.reserveControl){l.EventEmitter.unsubscribeAll(this.reserveControl,"onChange")}l.EventEmitter.unsubscribe(this.model,"onChangeStoreData",this.handleChangeStoreData);l.EventEmitter.unsubscribe(this.model,"onErrorsChange",this.handleProductErrorsChange)}},{key:"modifyBasePriceInput",value:function e(){var t=ie(this,Se,Xe).call(this,"PRICE");if(!t){return}if(!ie(this,le,Ne).call(this)){var i;t.setAttribute("disabled",true);g.Dom.addClass(t,"ui-ctl-element");(i=t.querySelector(".main-grid-editor-money-price"))===null||i===void 0?void 0:i.setAttribute("disabled","true");if(!this.editor.getSettingValue("disableNotifyChangingPrice")){g.Event.bind(t,"mouseenter",this.handleFocusUnchangeablePrice)}}else{var n;t.removeAttribute("disabled");g.Dom.removeClass(t,"ui-ctl-element");(n=t.querySelector(".main-grid-editor-money-price"))===null||n===void 0?void 0:n.removeAttribute("disabled");g.Event.unbind(t,"mouseenter",this.handleFocusUnchangeablePrice)}}},{key:"layoutReserveControl",value:function e(){var t=ie(this,Se,Xe).call(this,"RESERVE_INFO");if(t&&this.reserveControl){t.innerHTML="";this.reserveControl.clearCache();this.reserveControl.renderTo(t)}}},{key:"setRowNumber",value:function e(t){this.getNode().querySelectorAll(".main-grid-row-number").forEach((function(e){e.textContent=t+"."}))}},{key:"getFields",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var i;if(!g.Type.isArrayFilled(t)){i=g.Runtime.clone(this.fields)}else{i={};var n=$(t),a;try{for(n.s();!(a=n.n()).done;){var r=a.value;i[r]=this.getField(r)}}catch(e){n.e(e)}finally{n.f()}}if("PRODUCT_NAME"in i){var s=this.getField("FIXED_PRODUCT_NAME","");if(g.Type.isStringFilled(s)){i["PRODUCT_NAME"]=s}}return i}},{key:"getCatalogFields",value:function e(){var t=this.getFields(["CURRENCY","QUANTITY","MEASURE_CODE"]);t["PRICE"]=this.getBasePrice();t["VAT_INCLUDED"]=this.getTaxIncluded();t["VAT_ID"]=this.getTaxId();return t}},{key:"getCalculateFields",value:function e(){return{PRICE:this.getPrice(),BASE_PRICE:this.getBasePrice(),PRICE_EXCLUSIVE:this.getPriceExclusive(),PRICE_NETTO:this.getPriceNetto(),PRICE_BRUTTO:this.getPriceBrutto(),QUANTITY:this.getQuantity(),DISCOUNT_TYPE_ID:this.getDiscountType(),DISCOUNT_RATE:this.getDiscountRate(),DISCOUNT_SUM:this.getDiscountSum(),DISCOUNT_ROW:this.getDiscountRow(),TAX_INCLUDED:this.getTaxIncluded(),TAX_RATE:this.getTaxRate()}}},{key:"setFields",value:function e(t){for(var i in t){if(t.hasOwnProperty(i)){this.setField(i,t[i]);this.getModel().setField(i,t[i])}}}},{key:"getField",value:function e(t,i){return this.fields.hasOwnProperty(t)?this.fields[t]:i}},{key:"setField",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;this.fields[t]=i;if(n){this.getModel().setField(t,i)}}},{key:"getUiFieldId",value:function e(t){return this.getId()+"_"+t}},{key:"getBasePrice",value:function e(){return this.getField("BASE_PRICE",0)}},{key:"getEnteredPrice",value:function e(){return this.getField("ENTERED_PRICE",this.getBasePrice())}},{key:"getCatalogPrice",value:function e(){return this.getField("CATALOG_PRICE",this.getBasePrice())}},{key:"isPriceNetto",value:function e(){return this.getEditor().isTaxAllowed()&&!this.isTaxIncluded()}},{key:"getPrice",value:function e(){return this.getField("PRICE",0)}},{key:"getPriceExclusive",value:function e(){return this.getField("PRICE_EXCLUSIVE",0)}},{key:"getPriceNetto",value:function e(){return this.getField("PRICE_NETTO",0)}},{key:"getPriceBrutto",value:function e(){return this.getField("PRICE_BRUTTO",0)}},{key:"getQuantity",value:function e(){return this.getField("QUANTITY",1)}},{key:"getDiscountType",value:function e(){return this.getField("DISCOUNT_TYPE_ID",r.DiscountType.UNDEFINED)}},{key:"isDiscountUndefined",value:function e(){return this.getDiscountType()===r.DiscountType.UNDEFINED}},{key:"isDiscountPercentage",value:function e(){return this.getDiscountType()===r.DiscountType.PERCENTAGE}},{key:"isDiscountMonetary",value:function e(){return this.getDiscountType()===r.DiscountType.MONETARY}},{key:"isDiscountHandmade",value:function e(){return this.isDiscountPercentage()||this.isDiscountMonetary()}},{key:"getDiscountRate",value:function e(){return this.getField("DISCOUNT_RATE",0)}},{key:"getDiscountSum",value:function e(){return this.getField("DISCOUNT_SUM",0)}},{key:"getDiscountRow",value:function e(){return this.getField("DISCOUNT_ROW",0)}},{key:"isEmptyDiscount",value:function e(){if(this.isDiscountPercentage()){return this.getDiscountRate()===0}else if(this.isDiscountMonetary()){return this.getDiscountSum()===0}else if(this.isDiscountUndefined()){return true}return false}},{key:"getTaxIncluded",value:function e(){return this.getField("TAX_INCLUDED","N")}},{key:"isTaxIncluded",value:function e(){return this.getTaxIncluded()==="Y"}},{key:"getTaxRate",value:function e(){return this.getField("TAX_RATE",0)}},{key:"getTaxSum",value:function e(){return this.isTaxIncluded()?this.getPrice()*this.getQuantity()*(1-1/(1+this.getTaxRate()/100)):this.getPriceExclusive()*this.getQuantity()*this.getTaxRate()/100}},{key:"getTaxNode",value:function e(){return this.getNode().querySelector('select[data-field-code="TAX_RATE"]')}},{key:"getTaxId",value:function e(){var t=this.getTaxNode();if(g.Type.isDomNode(t)&&t.options[t.selectedIndex]){return g.Text.toNumber(t.options[t.selectedIndex].getAttribute("data-tax-id"))}return 0}},{key:"updateFieldByEvent",value:function e(t,i){var n=i.target;var a=n.type==="checkbox"?n.checked:n.value;var r=i.type==="input"||i.type==="change"?ne:ae;this.updateField(t,a,r)}},{key:"updateField",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:ae;this.resetExternalActions();this.updateFieldValue(t,i,n);this.executeExternalActions()}},{key:"updateFieldValue",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:ae;switch(t){case"ID":case"OFFER_ID":this.changeProductId(i);break;case"ENTERED_PRICE":case"PRICE":this.changeEnteredPrice(i,n);break;case"CATALOG_PRICE":this.changeCatalogPrice(i,n);break;case"QUANTITY":this.changeQuantity(i,n);break;case"MEASURE_CODE":this.changeMeasureCode(i,n);break;case"DISCOUNT":case"DISCOUNT_PRICE":this.changeDiscount(i,n);break;case"DISCOUNT_TYPE_ID":this.changeDiscountType(i);break;case"DISCOUNT_ROW":this.changeRowDiscount(i,n);break;case"VAT_ID":case"TAX_ID":this.changeTaxId(i);break;case"TAX_RATE":this.changeTaxRate(i);break;case"VAT_INCLUDED":case"TAX_INCLUDED":this.changeTaxIncluded(i);break;case"SUM":this.changeRowSum(i,n);break;case"NAME":case"PRODUCT_NAME":case"MAIN_INFO":this.changeProductName(i);break;case"SORT":this.changeSort(i,n);break;case"STORE_ID":this.changeStore(i);break;case"STORE_TITLE":this.changeStoreName(i);break;case"INPUT_RESERVE_QUANTITY":this.changeReserveQuantity(i);break;case"DATE_RESERVE_END":this.changeDateReserveEnd(i);break;case"BASE_PRICE":this.setBasePrice(i);break;case"DEDUCTED_QUANTITY":this.setDeductedQuantity(i);break;case"ROW_RESERVED":this.setRowReserved(i);break;case"SKU_TREE":case"DETAIL_URL":case"IMAGE_INFO":case"COMMON_STORE_AMOUNT":this.setField(t,i);break}}},{key:"updateFieldByName",value:function e(t,i){switch(t){case"TAX_INCLUDED":this.setTaxIncluded(i);break}}},{key:"handleCopyAction",value:function e(t,i){var n;(n=this.getEditor())===null||n===void 0?void 0:n.copyRow(this);var a=i.getMenuWindow();if(a){a.destroy()}}},{key:"handleDeleteAction",value:function e(t,i){var n;(n=this.getEditor())===null||n===void 0?void 0:n.deleteRow(this.getField("ID"));var a=i.getMenuWindow();if(a){a.destroy()}}},{key:"changeProductId",value:function e(t){var i=this.parseInt(t);this.setProductId(i)}},{key:"changeEnteredPrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ae;var n=t;t=Math.max(t,0);var a=this.parseFloat(t,this.getPricePrecision());this.setField("ENTERED_PRICE",a);if(i===ne&&n>=0){if(!ie(this,le,Ne)){return}if(this.getModel().isCatalogExisted()&&ie(this,oe,Ae).call(this)){ie(this,Ee,Be).call(this,a)}else{this.setBasePrice(a,i)}this.addActionProductChange();this.addActionUpdateTotal();this.addActionDisableSaveButton()}else{this.refreshFieldsLayout()}ie(this,Ce,Ve).call(this,n<0&&n!==t)}},{key:"changeCatalogPrice",value:function e(t){var i=this.parseFloat(t,this.getPricePrecision());this.setField("CATALOG_PRICE",i);this.refreshFieldsLayout()}},{key:"changeQuantity",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ae;var n=this.parseFloat(t,this.getQuantityPrecision());this.setQuantity(n,i)}},{key:"changeMeasureCode",value:function e(t){var i=this;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ae;this.getEditor().getMeasures().filter((function(e){return e.CODE===t})).forEach((function(e){return i.setMeasure(e,n)}))}},{key:"changeDiscount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ae;var n;if(this.isDiscountPercentage()){n=this.parseFloat(t,this.getCommonPrecision())}else{n=this.parseFloat(t,this.getPricePrecision()).toFixed(this.getPricePrecision())}this.setDiscount(n,i)}},{key:"changeDiscountType",value:function e(t){var i=this.parseInt(t,r.DiscountType.UNDEFINED);this.setDiscountType(i)}},{key:"changeRowDiscount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ae;var n=this.parseFloat(t,this.getPricePrecision());this.setRowDiscount(n,i)}},{key:"changeTaxId",value:function e(t){var i=this.getEditor().getTaxList();if(g.Type.isArrayFilled(i)){var n=i.find((function(e){return parseInt(e.ID)===parseInt(t)}));if(!n){n=i.find((function(e){return g.Type.isNil(e.VALUE)}))}if(n){this.changeTaxRate(n.VALUE)}}}},{key:"changeTaxRate",value:function e(t){var i=g.Type.isNil(t)||t===""?null:this.parseFloat(t,this.getCommonPrecision());this.setTaxRate(i)}},{key:"changeTaxIncluded",value:function e(t){if(g.Type.isBoolean(t)){t=t?"Y":"N"}this.setTaxIncluded(t)}},{key:"changeRowSum",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ae;var n=this.parseFloat(t,this.getPricePrecision());this.setRowSum(n,i)}},{key:"changeProductName",value:function e(t){var i=t.toString();var n=this.getField("PRODUCT_NAME")!==i;if(n){this.setField("PRODUCT_NAME",i);this.setField("NAME",i);this.addActionProductChange()}}},{key:"changeSort",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ae;var n=this.parseInt(t);if(i===ae){this.setField("SORT",n)}var a=this.getField("SORT")!==n;if(a){this.addActionProductChange()}}},{key:"changeStore",value:function e(t){if(this.isReserveBlocked()){return}var i=g.Text.toNumber(t);if(this.getField("STORE_ID")===i){return}this.setField("STORE_ID",i);this.setField("STORE_AVAILABLE",this.model.getStoreCollection().getStoreAvailableAmount(t));this.updateUiStoreAmountData();this.addActionProductChange()}},{key:"updateUiStoreAmountData",value:function e(){var t;var i=ie(this,Se,Xe).call(this,"STORE_AVAILABLE");if(!g.Type.isDomNode(i)){return}var n=this.getField("STORE_ID");var a=this.model.getStoreCollection().getStoreAvailableAmount(n);var r=g.Type.isStringFilled(this.model.getField("MEASURE_NAME"))?this.model.getField("MEASURE_NAME"):((t=this.editor.getDefaultMeasure())===null||t===void 0?void 0:t.SYMBOL)||"";if(!this.getModel().isCatalogExisted()){i.innerHTML=""}else{i.innerHTML=g.Text.toNumber(a)+" "+g.Text.encode(r)}}},{key:"setRowReserved",value:function e(t){var i;this.setField("ROW_RESERVED",t);var n=ie(this,Se,Xe).call(this,"ROW_RESERVED");if(!g.Type.isDomNode(n)){return}if(!this.getModel().isCatalogExisted()){n.innerHTML="";return}var a=g.Type.isStringFilled(this.model.getField("MEASURE_NAME"))?this.model.getField("MEASURE_NAME"):((i=this.editor.getDefaultMeasure())===null||i===void 0?void 0:i.SYMBOL)||"";n.innerHTML=g.Text.toNumber(this.getField("ROW_RESERVED"))+" "+g.Text.encode(a)}},{key:"setDeductedQuantity",value:function e(t){var i;this.setField("DEDUCTED_QUANTITY",t);var n=ie(this,Se,Xe).call(this,"DEDUCTED_QUANTITY");if(!g.Type.isDomNode(n)){return}if(!this.getModel().isCatalogExisted()){n.innerHTML="";return}var a=g.Type.isStringFilled(this.model.getField("MEASURE_NAME"))?this.model.getField("MEASURE_NAME"):((i=this.editor.getDefaultMeasure())===null||i===void 0?void 0:i.SYMBOL)||"";n.innerHTML=g.Text.toNumber(this.getField("DEDUCTED_QUANTITY"))+" "+g.Text.encode(a)}},{key:"changeStoreName",value:function e(t){var i=t.toString();this.setField("STORE_TITLE",i);this.addActionProductChange()}},{key:"changeDateReserveEnd",value:function e(t){var i=g.Type.isNil(t)?"":t.toString();this.setField("DATE_RESERVE_END",i);this.addActionProductChange()}},{key:"changeReserveQuantity",value:function e(t){var i=g.Text.toNumber(t);var n=i-this.getField("INPUT_RESERVE_QUANTITY");if(n==0||isNaN(n)){return}var a=this.getField("ROW_RESERVED")+n;this.setField("ROW_RESERVED",a);this.setField("RESERVE_QUANTITY",Math.max(a,0));this.setField("INPUT_RESERVE_QUANTITY",i);this.addActionProductChange()}},{key:"resetReserveFields",value:function e(){this.setField("ROW_RESERVED",null);this.setField("RESERVE_QUANTITY",null);this.setField("INPUT_RESERVE_QUANTITY",null)}},{key:"refreshFieldsLayout",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];for(var i in this.fields){if(this.fields.hasOwnProperty(i)&&!t.includes(i)){this.updateUiField(i,this.fields[i])}}}},{key:"getCalculator",value:function e(){return this.getModel().getCalculator().setFields(this.getCalculateFields()).setSettings(this.getEditor().getSettings())}},{key:"setModel",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=i.selectorId;if(n){var a=c.ProductModel.getById(n);if(a){this.model=a}}if(!this.model){this.model=new c.ProductModel({id:n,currency:this.getEditor().getCurrencyId(),iblockId:t["IBLOCK_ID"],basePriceId:t["BASE_PRICE_ID"],isSimpleModel:g.Text.toInteger(t["PRODUCT_ID"])<=0&&g.Type.isStringFilled(t["NAME"]),skuTree:g.Type.isStringFilled(t["SKU_TREE"])?JSON.parse(t["SKU_TREE"]):null,fields:t});var r=g.Type.isStringFilled(t["IMAGE_INFO"])?JSON.parse(t["IMAGE_INFO"]):null;if(g.Type.isObject(r)){this.model.getImageCollection().setPreview(r["preview"]);this.model.getImageCollection().setEditInput(r["input"]);this.model.getImageCollection().setMorePhotoValues(r["values"])}if(!g.Type.isNil(t["DETAIL_URL"])){this.model.setDetailPath(t["DETAIL_URL"])}}if(ie(this,Ie,Ye).call(this)){if(!this.getModel().getField("DATE_RESERVE_END")){this.setField("DATE_RESERVE_END",this.editor.getSettingValue("defaultDateReservation"))}}l.EventEmitter.subscribe(this.model,"onErrorsChange",this.handleProductErrorsChange);l.EventEmitter.subscribe(this.model,"onChangeStoreData",this.handleChangeStoreData)}},{key:"getModel",value:function e(){return this.model}},{key:"setProductId",value:function e(t){var i=this;var n=this.getField("PRODUCT_ID")!==t;if(n){var a;this.getModel().setOption("isSimpleModel",t<=0&&g.Type.isStringFilled(this.getField("NAME")));this.setField("PRODUCT_ID",t,false);this.setField("OFFER_ID",t,false);(a=this.storeSelector)===null||a===void 0?void 0:a.setProductId(t);this.addActionProductChange();this.addActionUpdateTotal();if(ie(this,Ie,Ye).call(this)){if(!this.getModel().getField("DATE_RESERVE_END")){this.setField("DATE_RESERVE_END",this.editor.getSettingValue("defaultDateReservation"))}this.resetReserveFields();this.onAfterExecuteExternalActions=function(){var e;(e=i.reserveControl)===null||e===void 0?void 0:e.setReservedQuantity(i.getField("QUANTITY"),true)}}}}},{key:"setPrice",value:function e(t){var i=t;t=Math.max(t,0);var n=this.getCalculator().setFields(this.getCalculator().calculateBasePrice(this.getBasePrice())).calculatePrice(t);delete n["BASE_PRICE"];this.setFields(n);this.refreshFieldsLayout(["PRICE_NETTO","PRICE_BRUTTO"]);this.addActionProductChange();this.addActionUpdateTotal();this.executeExternalActions();ie(this,Ce,Ve).call(this,i<0&&i!==t)}},{key:"setBasePrice",value:function e(t){var i=t;t=Math.max(t,0);var n=this.getCalculator().setFields(this.getCalculator().calculateBasePrice(this.getCatalogPrice())).calculatePrice(t);this.setFields(n);this.refreshFieldsLayout(["PRICE_NETTO","PRICE_BRUTTO"]);this.addActionProductChange();this.addActionUpdateTotal();ie(this,Ce,Ve).call(this,i!==t)}},{key:"setBasePrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ae;var n=t;t=Math.max(t,0);if(i===ae){this.updateUiInputField("PRICE",t.toFixed(this.getPricePrecision()))}var a=this.getBasePrice()!==t;if(a){var r=this.getCalculator().calculateBasePrice(t);this.setFields(r);var s=i===ne?["BASE_PRICE","PRICE","ENTERED_PRICE"]:[];this.refreshFieldsLayout(s);this.addActionProductChange();this.addActionUpdateTotal()}ie(this,Ce,Ve).call(this,n<0&&n!==t)}},{key:"setQuantity",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ae;if(i===ae){this.updateUiInputField("QUANTITY",t)}var n=this.getField("QUANTITY")!==t;if(n){var a="quantityReservedCountError";var r=BX.UI.Notification.Center.getBalloonById(a);if(r){r.close()}var s=this.getCalculator().calculateQuantity(t);this.setFields(s);this.refreshFieldsLayout(["QUANTITY"]);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setReserveQuantity",value:function e(t){var i=ie(this,Se,Xe).call(this,"RESERVE_INFO");var n=i===null||i===void 0?void 0:i.querySelector('input[name="INPUT_RESERVE_QUANTITY"]');if(g.Type.isElementNode(n)){var a;n.value=t;(a=this.reserveControl)===null||a===void 0?void 0:a.changeInputValue(t)}else{this.changeReserveQuantity(t)}}},{key:"setMeasure",value:function e(t){var i=this;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ae;this.setField("MEASURE_CODE",t.CODE);this.setField("MEASURE_NAME",t.SYMBOL);this.updateUiMoneyField("MEASURE_CODE",t.CODE,g.Text.encode(t.SYMBOL));if(this.getModel().isNew()){this.getModel().save(["MEASURE_CODE"])}else if(n===ne){this.getModel().showSaveNotifier("measureChanger_"+this.getId(),{title:g.Loc.getMessage("CATALOG_PRODUCT_MODEL_SAVING_NOTIFICATION_MEASURE_CHANGED_QUERY"),events:{onSave:function e(){i.getModel().save(["MEASURE_CODE","MEASURE_NAME"])}}})}this.addActionProductChange()}},{key:"setDiscount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ae;if(!this.isDiscountHandmade()){return}var n=this.isDiscountPercentage()?"DISCOUNT_RATE":"DISCOUNT_SUM";var a=this.getField(n)!==t;if(a){var r=this.getCalculator().calculateDiscount(t);this.setFields(r);var s=i===ne?["DISCOUNT_RATE","DISCOUNT_SUM","DISCOUNT"]:[];this.refreshFieldsLayout(s);this.addActionProductChange();this.addActionUpdateTotal()}ie(this,Ce,Ve).call(this)}},{key:"setDiscountType",value:function e(t){var i=t!==r.DiscountType.UNDEFINED&&this.getField("DISCOUNT_TYPE_ID")!==t;if(i){var n=this.getCalculator().calculateDiscountType(t);this.setFields(n);this.refreshFieldsLayout();this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setRowDiscount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ae;var n=this.getField("DISCOUNT_ROW")!==t;if(n){var a=this.getCalculator().calculateRowDiscount(t);this.setFields(a);var r=i===ne?["DISCOUNT_ROW"]:[];this.refreshFieldsLayout(r);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setTaxRate",value:function e(t){if(!this.getEditor().isTaxAllowed()){return}var i=this.getTaxRate()!==t;if(i){var n=this.getCalculator().calculateTax(t);this.setFields(n);this.refreshFieldsLayout();this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setTaxIncluded",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ae;if(!this.getEditor().isTaxAllowed()){return}if(i===ae){this.updateUiCheckboxField("TAX_INCLUDED",t)}var n=this.getTaxIncluded()!==t;if(n){var a=this.getCalculator().calculateTaxIncluded(t);this.setFields(a);this.refreshFieldsLayout();this.addActionUpdateFieldList("TAX_INCLUDED",t);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setRowSum",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ae;var n=this.getField("SUM")!==t;if(n){var a=this.getCalculator().calculateRowSum(t);this.setFields(a);var r=i===ne?["SUM"]:[];this.refreshFieldsLayout(r);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"getInputByFieldName",value:function e(t){var i=this.getUiFieldId(t);var n=document.getElementById(i);if(!g.Type.isElementNode(n)){n=this.getNode().querySelector('[name="'+i+'"]')}return n}},{key:"updateUiInputField",value:function e(t,i){var n=this.getInputByFieldName(t);if(g.Type.isElementNode(n)){n.value=i}}},{key:"updateUiCheckboxField",value:function e(t,i){var n=this.getInputByFieldName(t);if(g.Type.isElementNode(n)){n.checked=i==="Y"}}},{key:"updateUiDiscountTypeField",value:function e(t,i){var n=i===r.DiscountType.MONETARY?this.getEditor().getCurrencyText():"%";this.updateUiMoneyField(t,i,n)}},{key:"getMoneyFieldDropdownApi",value:function e(t){if(!g.Reflection.getClass("BX.Main.dropdownManager")){return null}return BX.Main.dropdownManager.getById(this.getId()+"_"+t+"_control")}},{key:"updateMoneyFieldUiWithDropdownApi",value:function e(t,i){if(t.getValue()===i){return}var n=t.menu.itemsContainer.querySelector('[data-value="'+i+'"]');var a=n&&t.getMenuItem(n);if(a){t.refresh(a);t.selectItem(a)}}},{key:"updateMoneyFieldUiManually",value:function e(t,i,n){var a=this.getInputByFieldName(t);if(!g.Type.isElementNode(a)){return}a.dataset.value=i;var r=a.querySelector("span.main-dropdown-inner");if(!g.Type.isElementNode(r)){return}r.innerHTML=n}},{key:"updateUiMoneyField",value:function e(t,i,n){var a=this.getMoneyFieldDropdownApi(t);if(a){this.updateMoneyFieldUiWithDropdownApi(a,i)}else{this.updateMoneyFieldUiManually(t,i,n)}}},{key:"updateUiMeasure",value:function e(t,i){this.updateUiMoneyField("MEASURE_CODE",t,i);this.updateUiStoreAmountData()}},{key:"updateUiHtmlField",value:function e(t,i){var n=this.getNode().querySelector('[data-name="'+t+'"]');if(g.Type.isElementNode(n)){n.innerHTML=i}}},{key:"updateUiCurrencyFields",value:function e(){var t=this;var i=this.getEditor().getCurrencyText();var n=""+this.getEditor().getCurrencyId();var a=["PRICE_CURRENCY","SUM_CURRENCY","DISCOUNT_TYPE_ID","DISCOUNT_ROW_CURRENCY"];a.forEach((function(e){var a=[];if(e==="DISCOUNT_TYPE_ID"){a.push({NAME:"%",VALUE:""+r.DiscountType.PERCENTAGE});a.push({NAME:i,VALUE:""+r.DiscountType.MONETARY});if(t.getDiscountType()===r.DiscountType.MONETARY){t.updateMoneyFieldUiManually(e,r.DiscountType.MONETARY,i)}}else{a.push({NAME:i,VALUE:n});t.updateUiMoneyField(e,n,i)}g.Dom.attr(t.getInputByFieldName(e),"data-items",a)}));this.updateUiField("TAX_SUM",this.getField("TAX_SUM"))}},{key:"updateUiField",value:function e(t,i){var n=this.getUiFieldName(t);if(!n){return}var a=this.getUiFieldType(t);if(!a){return}if(!this.allowUpdateUiField(t)){return}switch(a){case"input":if(t==="QUANTITY"){i=this.parseFloat(i,this.getQuantityPrecision())}else if(t==="DISCOUNT_RATE"){i=this.parseFloat(i,this.getCommonPrecision())}else if(t==="TAX_RATE"){i=g.Type.isNil(i)||i===""?"":this.parseFloat(i,this.getCommonPrecision())}else if(i===0){i=""}else if(g.Type.isNumber(i)){i=this.parseFloat(i,this.getPricePrecision()).toFixed(this.getPricePrecision())}this.updateUiInputField(n,i);break;case"checkbox":this.updateUiCheckboxField(n,i);break;case"discount_type_field":this.updateUiDiscountTypeField(n,i);break;case"html":this.updateUiHtmlField(n,i);break;case"money_html":i=d.CurrencyCore.currencyFormat(i,this.getEditor().getCurrencyId(),true);this.updateUiHtmlField(n,i);break}}},{key:"getUiFieldName",value:function e(t){var i=null;switch(t){case"QUANTITY":case"MEASURE_CODE":case"DISCOUNT_ROW":case"DISCOUNT_TYPE_ID":case"TAX_RATE":case"TAX_INCLUDED":case"TAX_SUM":case"SUM":case"PRODUCT_NAME":case"SORT":i=t;break;case"PRICE_NETTO":case"PRICE_BRUTTO":i="PRICE";break;case"DISCOUNT_RATE":case"DISCOUNT_SUM":i="DISCOUNT_PRICE";break}return i}},{key:"getUiFieldType",value:function e(t){var i=null;switch(t){case"PRICE":case"ENTERED_PRICE":case"QUANTITY":case"TAX_RATE":case"DISCOUNT_RATE":case"DISCOUNT_SUM":case"DISCOUNT_ROW":case"SUM":case"PRODUCT_NAME":case"SORT":i="input";break;case"DISCOUNT_TYPE_ID":i="discount_type_field";break;case"TAX_INCLUDED":i="checkbox";break;case"TAX_SUM":i="money_html";break}return i}},{key:"allowUpdateUiField",value:function e(t){var i=true;switch(t){case"PRICE_NETTO":i=this.isPriceNetto();break;case"PRICE_BRUTTO":i=!this.isPriceNetto();break;case"DISCOUNT_RATE":i=this.isDiscountPercentage();break;case"DISCOUNT_SUM":i=this.isDiscountMonetary();break}return i}},{key:"parseInt",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;return this.getEditor().parseInt(t,i)}},{key:"parseFloat",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;return this.getEditor().parseFloat(t,i,n)}},{key:"getPricePrecision",value:function e(){return this.getEditor().getPricePrecision()}},{key:"getQuantityPrecision",value:function e(){return this.getEditor().getQuantityPrecision()}},{key:"getCommonPrecision",value:function e(){return this.getEditor().getCommonPrecision()}},{key:"resetExternalActions",value:function e(){this.externalActions.length=0}},{key:"addExternalAction",value:function e(t){this.externalActions.push(t)}},{key:"addActionProductChange",value:function e(){this.addExternalAction({type:this.getEditor().actions.productChange,id:this.getId()})}},{key:"addActionDisableSaveButton",value:function e(){this.addExternalAction({type:this.getEditor().actions.disableSaveButton,id:this.getId()})}},{key:"addActionUpdateFieldList",value:function e(t,i){this.addExternalAction({type:this.getEditor().actions.updateListField,field:t,value:i})}},{key:"addActionStateChanged",value:function e(){this.addExternalAction({type:this.getEditor().actions.stateChanged,value:true})}},{key:"addActionStateReset",value:function e(){this.addExternalAction({type:this.getEditor().actions.stateChanged,value:false})}},{key:"addActionUpdateTotal",value:function e(){this.addExternalAction({type:this.getEditor().actions.updateTotal})}},{key:"executeExternalActions",value:function e(){if(this.externalActions.length===0){return}this.getEditor().executeActions(this.externalActions);this.resetExternalActions();if(this.onAfterExecuteExternalActions){this.onAfterExecuteExternalActions.call();this.onAfterExecuteExternalActions=null}}},{key:"isEmpty",value:function e(){return!g.Type.isStringFilled(this.getField("PRODUCT_NAME","").trim())&&this.getField("PRODUCT_ID",0)<=0&&this.getPrice()<=0}},{key:"isReserveBlocked",value:function e(){return this.getSettingValue("isReserveBlocked",false)}}]);return e}();function Re(){var e=this;if(this.getEditor().isReadOnly()){return}var t=this.getNode().querySelector(".main-grid-cell-action .main-grid-cell-content");if(g.Type.isDomNode(t)){var i=g.Tag.render(W||(W=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<a\n\t\t\t\t\thref="#"\n\t\t\t\t\tclass="main-grid-row-action-button"\n\t\t\t\t></a>\n\t\t\t'])));g.Event.bind(i,"click",(function(t){var n=[{text:g.Loc.getMessage("CRM_ENTITY_PL_COPY"),onclick:e.handleCopyAction.bind(e)},{text:g.Loc.getMessage("CRM_ENTITY_PL_DELETE"),onclick:e.handleDeleteAction.bind(e),disabled:e.getModel().isEmpty()&&e.getEditor().products.length<=1}];s.PopupMenu.show({id:e.getId()+"_actions_popup",bindElement:i,items:n,cacheable:false});t.preventDefault();t.stopPropagation()}));g.Dom.append(i,t)}}function De(){var e=this;if(this.editor.getSettingValue("disableNotifyChangingPrice")){return}var t=g.Text.encode(this.editor.getSettingValue("catalogPriceEditArticleHint"));var i="disabled-crm-changing-price";var n=BX.UI.Notification.Center.getBalloonById(i);if(!n){var a=g.Tag.render(Q||(Q=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div>\n\t\t\t\t\t<div style="padding: 9px">',"</div>\n\t\t\t\t</div>\n\t\t\t"])),t);var r=g.Tag.render(q||(q=babelHelpers.taggedTemplateLiteral(["<div></div>"])));a.appendChild(r);var s=this.editor.getSettingValue("catalogPriceEditArticleCode");if(s){var l=g.Tag.render(j||(j=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span class="ui-notification-balloon-action">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>\n\t\t\t\t"])),g.Loc.getMessage("CRM_ENTITY_MORE_LINK"));g.Event.bind(l,"click",(function(){top.BX.Helper.show("redirect=detail&code="+s);n.close()}));r.appendChild(l)}var o=g.Tag.render(K||(K=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span class="ui-notification-balloon-action">\n\t\t\t\t\t',"\n\t\t\t\t</span>\n\t\t\t"])),g.Loc.getMessage("CRM_ENTITY_DISABLE_NOTIFICATION"));g.Event.bind(o,"click",(function(){n.close();e.editor.setSettingValue("disableNotifyChangingPrice",true);g.ajax.runComponentAction(e.editor.getComponentName(),"setGridSetting",{mode:"class",data:{signedParameters:e.editor.getSignedParameters(),settingId:"DISABLE_NOTIFY_CHANGING_PRICE",selected:true}})}));r.appendChild(o);var d={id:i,closeButton:true,category:Pe.CATALOG_PRICE_CHANGING_DISABLED,autoHideDelay:1e4,content:a};n=BX.UI.Notification.Center.notify(d)}n.show()}function Ne(){return this.editor.canEditCatalogPrice()||!this.getModel().isCatalogExisted()||this.getModel().isNew()}function Ae(){return this.editor.canSaveCatalogPrice()||this.getModel().isCatalogExisted()&&this.getModel().isNew()}function Fe(){var e="crm_grid_"+this.getId();this.mainSelector=u.ProductSelector.getById(e);if(!this.mainSelector){var t={iblockId:this.model.getIblockId(),basePriceId:this.model.getBasePriceId(),currency:this.model.getCurrency(),model:this.model,config:{ENABLE_SEARCH:true,IS_ALLOWED_CREATION_PRODUCT:true,ENABLE_IMAGE_INPUT:true,ROLLBACK_INPUT_AFTER_CANCEL:true,ENABLE_INPUT_DETAIL_LINK:true,ROW_ID:this.getId(),ENABLE_SKU_SELECTION:true,URL_BUILDER_CONTEXT:this.editor.getSettingValue("productUrlBuilderContext")},mode:u.ProductSelector.MODE_EDIT};this.mainSelector=new u.ProductSelector("crm_grid_"+this.getId(),t)}var i=ie(this,Se,Xe).call(this,"MAIN_INFO");if(i){var n=i.querySelector(".main-grid-row-number");if(!g.Type.isDomNode(n)){i.appendChild(g.Tag.render(z||(z=babelHelpers.taggedTemplateLiteral(['<div class="main-grid-row-number"></div>']))))}var a=i.querySelector(".main-grid-row-product-selector");if(!g.Type.isDomNode(a)){a=g.Tag.render(Z||(Z=babelHelpers.taggedTemplateLiteral(['<div class="main-grid-row-product-selector"></div>'])));i.appendChild(a)}this.mainSelector.skuTreeInstance=null;this.mainSelector.renderTo(a)}l.EventEmitter.subscribe(this.mainSelector,"onClear",this.handleMainSelectorClear)}function _e(){this.updateField("OFFER_ID",0);this.updateField("PRODUCT_NAME","");this.updateUiStoreAmountData();this.updateField("DEDUCTED_QUANTITY",0);this.updateField("ROW_RESERVED",0)}function ke(){this.storeSelector=new a.StoreSelector(this.getId(),{inputFieldId:"STORE_ID",inputFieldTitle:"STORE_TITLE",config:{ENABLE_SEARCH:true,ENABLE_INPUT_DETAIL_LINK:false,ROW_ID:this.getId()},mode:a.StoreSelector.MODE_EDIT,model:this.model});var e=ie(this,Se,Xe).call(this,"STORE_INFO");if(this.storeSelector&&e){e.innerHTML="";this.storeSelector.renderTo(e);if(this.isReserveBlocked()){ie(this,ge,we).call(this)}}l.EventEmitter.subscribe(this.storeSelector,"onChange",this.handleStoreFieldChange);l.EventEmitter.subscribe(this.storeSelector,"onClear",this.handleStoreFieldClear)}function Ue(){var e=ie(this,Se,Xe).call(this,"STORE_AVAILABLE");if(!e){return}this.storeAvailablePopup=new Y({rowId:this.id,model:this.getModel(),node:e});l.EventEmitter.subscribeOnce("Grid::updated",this.handleOnGridUpdated)}function we(){var e=this;var t=this.storeSelector.searchInput;if(!t||!t.getNameInput()){return}t.toggleIcon(this.storeSelector.searchInput.getSearchIcon(),"none");t.getNameInput().disabled=true;t.getNameInput().classList.add("crm-entity-product-list-locked-field");if(this.storeSelector.getWrapper()){this.storeSelector.getWrapper().onclick=function(){return e.editor.openIntegrationLimitSlider()}}}function Oe(){var e=this;var t=ie(this,Se,Xe).call(this,"RESERVE_INFO");if(t){this.reserveControl=new _({model:this.getModel(),isReserveEqualProductQuantity:ie(this,Ie,Ye).call(this),defaultDateReservation:this.editor.getSettingValue("defaultDateReservation"),isBlocked:this.isReserveBlocked()});l.EventEmitter.subscribe(this.reserveControl,"onChange",(function(t){var i=t.getData();e.updateField(i.NAME,i.VALUE)}));l.EventEmitter.subscribe(this.reserveControl,"onNodeClick",(function(){e.editor.openIntegrationLimitSlider()}));this.layoutReserveControl()}var i=this.getNode().querySelector('div[data-name="QUANTITY"] input');if(i){g.Event.bind(i,"change",(function(t){var i;var n=ie(e,Ie,Ye).call(e)&&((i=e.reserveControl)===null||i===void 0?void 0:i.isReserveEqualProductQuantity);if(n){e.setReserveQuantity(e.getField("QUANTITY"));return}var a=g.Text.toNumber(t.target.value);var r="quantityReservedCountError";var s=BX.UI.Notification.Center.getBalloonById(r);if(a<e.getField("INPUT_RESERVE_QUANTITY")){if(!s){var l={id:r,closeButton:true,autoHideDelay:3e3,content:g.Tag.render(J||(J=babelHelpers.taggedTemplateLiteral(["<div>","</div>"])),g.Loc.getMessage("CRM_ENTITY_PL_IS_LESS_QUANTITY_THEN_RESERVED"))};s=BX.UI.Notification.Center.notify(l)}e.setReserveQuantity(e.getField("QUANTITY"));s.show()}}))}}function Me(e){var t=this;var i=e.getData();i.fields.forEach((function(e){t.updateField(e.NAME,e.VALUE)}));this.initHandlersForSelectors()}function He(e){this.initHandlersForSelectors()}function Be(e){var t=this;var i=BX.UI.Notification.Center.getBalloonByCategory(Pe.CATALOG_PRICE_CHANGING_DISABLED);if(i){i.close()}this.getModel().showSaveNotifier("priceChanger_"+this.getId(),{title:g.Loc.getMessage("CATALOG_PRODUCT_MODEL_SAVING_NOTIFICATION_PRICE_CHANGED_QUERY"),events:{onCancel:function i(){if(t.getBasePrice()>t.getEnteredPrice()){t.setField("ENTERED_PRICE",t.getBasePrice());t.updateUiInputField("PRICE",t.getBasePrice())}t.setPrice(e);if(t.getField("DISCOUNT_SUM")>0){var n=t.getEditor().getSettingsPopup();var a=n===null||n===void 0?void 0:n.getSetting("DISCOUNTS");if(a&&a.checked===false){n.requestGridSettings(a,true)}}},onSave:function i(){t.setField("ENTERED_PRICE",e);t.setField("PRICE",e);t.changeCatalogPrice("CATALOG_PRICE",e);t.setBasePrice(e);t.getModel().save(["BASE_PRICE","CURRENCY"]);t.refreshFieldsLayout();t.addActionUpdateTotal();t.executeExternalActions()}}})}function Le(){var e=this.getField("STORE_ID");if(!this.isReserveBlocked()&&this.isNewRow()){var t=this.getModel().getStoreCollection().getStoreAmount(e);if(t<=0&&this.getModel().isChanged()){var i=this.getModel().getStoreCollection().getMaxFilledStore();if(i.AMOUNT>t&&this.storeSelector){this.storeSelector.onStoreSelect(i.STORE_ID,g.Text.decode(i.STORE_TITLE))}}}this.setField("STORE_AVAILABLE",this.model.getStoreCollection().getStoreAvailableAmount(e));this.updateUiStoreAmountData()}function xe(){this.getEditor().handleProductErrorsChange()}function Ge(){return g.Text.toNumber(this.getField("PRICE"))>0&&g.Text.toNumber(this.getField("PRICE"))<1&&this.isDiscountPercentage()&&(g.Text.toNumber(this.getField("DISCOUNT_SUM"))>0||g.Text.toNumber(this.getField("DISCOUNT_RATE"))>0||g.Text.toNumber(this.getField("DISCOUNT_ROW"))>0)}function Ve(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(ie(this,be,Ge).call(this)){this.getHintPopup().load(this.getInputByFieldName("PRICE"),g.Loc.getMessage("CRM_ENTITY_PL_SMALL_PRICE_NOTICE")).show()}else if(e){this.getHintPopup().load(this.getInputByFieldName("PRICE"),g.Loc.getMessage("CRM_ENTITY_PL_NEGATIVE_PRICE_NOTICE")).show()}else{this.getHintPopup().close()}}function Ye(){return this.editor.getSettingValue("isReserveEqualProductQuantity",false)}function Xe(e){return this.getNode().querySelector('[data-name="'.concat(e,'"]'))}function We(){if(this.storeAvailablePopup){this.storeAvailablePopup.refreshStoreInfo()}}babelHelpers.defineProperty(Pe,"CATALOG_PRICE_CHANGING_DISABLED","CATALOG_PRICE_CHANGING_DISABLED");var Qe=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"_settings",{});this._settings=t?t:{};this.eventHandlers={}}babelHelpers.createClass(e,[{key:"registerEventHandler",value:function e(t,i){if(!this.eventHandlers[t])this.eventHandlers[t]=[];this.eventHandlers[t].push(i);BX.addCustomEvent(this,t,i)}},{key:"fireEvent",value:function e(t,i){BX.onCustomEvent(this,t,i)}},{key:"unregisterEventHandlers",value:function e(t){if(this.eventHandlers[t]){for(var i=0;i<this.eventHandlers[t].length;i++){BX.removeCustomEvent(this,t,this.eventHandlers[t][i])}delete this.eventHandlers[t]}}}]);return e}();var qe,je,Ke,ze,Ze;function Je(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var $e=new WeakMap;var et=new WeakMap;var tt=new WeakMap;var it=new WeakMap;var nt=new WeakSet;var at=new WeakSet;var rt=new WeakSet;var st=new WeakSet;var lt=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var n=arguments.length>2?arguments[2]:undefined;babelHelpers.classCallCheck(this,e);st.add(this);rt.add(this);at.add(this);nt.add(this);$e.set(this,{writable:true,value:void 0});et.set(this,{writable:true,value:void 0});tt.set(this,{writable:true,value:void 0});it.set(this,{writable:true,value:new g.Cache.MemoryCache});babelHelpers.classPrivateFieldSet(this,$e,t);babelHelpers.classPrivateFieldSet(this,et,i);babelHelpers.classPrivateFieldSet(this,tt,n)}babelHelpers.createClass(e,[{key:"show",value:function e(){this.getPopup().show()}},{key:"getPopup",value:function e(){var t=this;return babelHelpers.classPrivateFieldGet(this,it).remember("settings-popup",(function(){return new s.Popup(babelHelpers.classPrivateFieldGet(t,tt).getId()+"_"+Math.random()*100,babelHelpers.classPrivateFieldGet(t,$e),{autoHide:true,draggable:false,offsetLeft:0,offsetTop:0,angle:{position:"top",offset:43},noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,content:Je(t,nt,ot).call(t)})}))}},{key:"getSetting",value:function e(t){return babelHelpers.classPrivateFieldGet(this,et).filter((function(e){return e.id===t}))[0]}},{key:"requestGridSettings",value:function e(t,i){var n=this;var a=[];var r=babelHelpers.classPrivateFieldGet(this,tt).getGrid().getRows().getHeadFirstChild().getCells();Array.from(r).forEach((function(e){if("name"in e.dataset){a.push(e.dataset.name)}}));g.ajax.runComponentAction(babelHelpers.classPrivateFieldGet(this,tt).getComponentName(),"setGridSetting",{mode:"class",data:{signedParameters:babelHelpers.classPrivateFieldGet(this,tt).getSignedParameters(),settingId:t.id,selected:i,currentHeaders:a}}).then((function(){var e;t.checked=i;if(t.id==="ADD_NEW_ROW_TOP"){var a=i?"top":"bottom";babelHelpers.classPrivateFieldGet(n,tt).setSettingValue("newRowPosition",a);var r=babelHelpers.classPrivateFieldGet(n,tt).changeActivePanelButtons(a);var s=r.querySelector('[data-role="product-list-settings-button"]');n.getPopup().setBindElement(s);e=i?g.Loc.getMessage("CRM_ENTITY_PL_SETTING_ENABLED"):g.Loc.getMessage("CRM_ENTITY_PL_SETTING_DISABLED");e=e.replace("#NAME#",t.title)}else if(t.id==="WAREHOUSE"){babelHelpers.classPrivateFieldGet(n,tt).reloadGrid(false);e=i?g.Loc.getMessage("CRM_ENTITY_CARD_WAREHOUSE_ENABLED"):g.Loc.getMessage("CRM_ENTITY_CARD_WAREHOUSE_DISABLED")}else{babelHelpers.classPrivateFieldGet(n,tt).reloadGrid();e=i?g.Loc.getMessage("CRM_ENTITY_PL_SETTING_ENABLED"):g.Loc.getMessage("CRM_ENTITY_PL_SETTING_DISABLED");e=e.replace("#NAME#",t.title)}n.getPopup().close();Je(n,st,ct).call(n,e,{category:"popup-settings"})}))}},{key:"updateCheckboxState",value:function e(){var t=this;var i=this.getPopup().getContentContainer();babelHelpers.classPrivateFieldGet(this,et).filter((function(e){return e.action==="grid"&&g.Type.isArray(e.columns)})).forEach((function(e){var n=true;e.columns.forEach((function(e){if(!babelHelpers.classPrivateFieldGet(t,tt).getGrid().getColumnHeaderCellByName(e)){n=false}}));var a=i.querySelector('input[data-setting-id="'+e.id+'"]');if(g.Type.isDomNode(a)){a.checked=n}}))}}]);return e}();function ot(){var e=this;var t=g.Tag.render(qe||(qe=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div class='ui-entity-editor-popup-create-field-list'></div>\n\t\t"])));babelHelpers.classPrivateFieldGet(this,et).forEach((function(i){t.append(Je(e,at,dt).call(e,i))}));return t}function dt(e){var t,i=this;var n=g.Tag.render(je||(je=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="checkbox">\n\t\t'])));n.checked=e.checked;n.disabled=(t=e.disabled)!==null&&t!==void 0?t:false;n.dataset.settingId=e.id;var a=g.Type.isStringFilled(e.desc)?g.Tag.render(Ke||(Ke=babelHelpers.taggedTemplateLiteral(['<span class="ui-entity-editor-popup-create-field-item-desc">',"</span>"])),e.desc):"";var r=g.Type.isStringFilled(e.hint)?g.Tag.render(ze||(ze=babelHelpers.taggedTemplateLiteral(['<span class="crm-entity-product-list-setting-hint" data-hint="','"></span>'])),e.hint):"";var s=g.Tag.render(Ze||(Ze=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<label class="ui-ctl-block ui-entity-editor-popup-create-field-item ui-ctl-w100">\n\t\t\t\t<div class="ui-ctl-w10" style="text-align: center">','</div>\n\t\t\t\t<div class="ui-ctl-w75">\n\t\t\t\t\t<span class="ui-entity-editor-popup-create-field-item-title ','">',"","</span>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</label>\n\t\t"])),n,e.disabled?"crm-entity-product-list-disabled-setting":"",e.title,r,a);BX.UI.Hint.init(s);if(e.id==="SLIDER"){g.Event.bind(s,"change",(function(t){(new o.Slider).open(e.url,{}).then((function(){return babelHelpers.classPrivateFieldGet(i,tt).reloadGrid(false)}))}))}else{g.Event.bind(s,"change",Je(this,rt,ut).bind(this))}return s}function ut(e){var t=this.getSetting(e.target.dataset.settingId);if(!t){return}var i=e.target.checked;this.requestGridSettings(t,i)}function ct(e,t){t=t||{};BX.UI.Notification.Center.notify({content:e,stack:t.stack||null,position:"top-right",width:"auto",category:t.category||null,autoHideDelay:t.autoHideDelay||3e3})}function ht(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var gt=new WeakMap;var vt=new WeakMap;var ft=new WeakSet;var pt=new WeakSet;var Et=new WeakSet;var yt=new WeakSet;var Tt=new WeakSet;var bt=new WeakSet;var Ct=function(){function e(t,i){babelHelpers.classCallCheck(this,e);bt.add(this);Tt.add(this);yt.add(this);Et.add(this);pt.add(this);ft.add(this);babelHelpers.defineProperty(this,"fieldHintIsBusy",false);babelHelpers.defineProperty(this,"activeHintGuide",null);gt.set(this,{writable:true,value:void 0});vt.set(this,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,vt,t);babelHelpers.classPrivateFieldSet(this,gt,i)}babelHelpers.createClass(e,[{key:"processFieldTour",value:function e(t,i,n){var a=this;var r=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];if(this.fieldHintIsBusy){return}this.fieldHintIsBusy=true;i.events={onClose:function e(){n();a.fieldHintIsBusy=false;a.activeHintGuide=null}};if(ht(this,Et,mt).call(this,t)){var s=ht(this,bt,Dt).call(this,t,i);ht(this,Tt,Rt).call(this,(function(){s.close()}))}else{var l=babelHelpers.classPrivateFieldGet(this,gt).call(this).getContainer();var o=l.querySelector(".main-grid-ear-left");var d=l.querySelector(".main-grid-ear-right");var u=t.getClientRects()[0].x;var c=l.getClientRects()[0].x;var h=null;if(u>c){h=ht(this,yt,Pt).call(this,d)}else{h=ht(this,yt,Pt).call(this,o)}ht(this,ft,It).call(this,t,(function(){h.close();var e=ht(a,bt,Dt).call(a,t,i);ht(a,Tt,Rt).call(a,(function(){e.close()}))}),[],r)}}},{key:"getActiveHint",value:function e(){if(!this.fieldHintIsBusy){return null}else if(this.activeHintGuide instanceof f.Guide){return this.activeHintGuide}return null}}]);return e}();function It(e,t){var i,n=this;var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];var r=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];var s=(i=ht(this,pt,St)).call.apply(i,[this,e].concat(babelHelpers.toConsumableArray(r)));var l=function e(i){var r;if((r=ht(n,Et,mt)).call.apply(r,[n].concat(babelHelpers.toConsumableArray(s)))){g.Event.unbind(babelHelpers.classPrivateFieldGet(n,gt).call(n).getScrollContainer(),"scroll",e);g.Event.unbind(window,"resize",e);t.apply(void 0,babelHelpers.toConsumableArray(a))}};g.Event.bind(babelHelpers.classPrivateFieldGet(this,gt).call(this).getScrollContainer(),"scroll",l);g.Event.bind(window,"resize",l)}function St(e){var t,i;var n=[];for(var a=arguments.length,r=new Array(a>1?a-1:0),s=1;s<a;s++){r[s-1]=arguments[s]}for(var l=0,o=r;l<o.length;l++){var d=o[l];n.push({node:d,nodeRect:d.getClientRects()[0]})}var u={node:e,nodeRect:e.getClientRects()[0]};n.push(u);n.sort((function(e,t){var i=e.nodeRect.x;var n=t.nodeRect.x;if(i<n){return-1}else if(i>n){return 1}else{return 0}}));var c=(t=babelHelpers.classPrivateFieldGet(this,gt).call(this))===null||t===void 0?void 0:(i=t.getContainer().getClientRects())===null||i===void 0?void 0:i[0];function h(e,t){return Math.abs(e-t)<c.width}while(n.length>1&&!h(n[0].nodeRect.x,n[n.length-1].nodeRect.x)){var g=n[0];var v=n[n.length-1];if(g===u){n.pop()}else if(v===u){n.shift()}else{var f=u.nodeRect.x-g.nodeRect.x;var p=v.nodeRect.x-u.nodeRect.x;if(f>=p){n.shift()}else{n.pop()}}}return n.map((function(e){return e.node}))}function mt(){var e,t;var i=(e=babelHelpers.classPrivateFieldGet(this,gt).call(this))===null||e===void 0?void 0:(t=e.getContainer().getClientRects())===null||t===void 0?void 0:t[0];if(i===undefined){return false}var n=i.x;var a=i.x+i.width;for(var r=arguments.length,s=new Array(r),l=0;l<r;l++){s[l]=arguments[l]}for(var o=0,d=s;o<d.length;o++){var u;var c=d[o];var h=(u=c.getClientRects())===null||u===void 0?void 0:u[0];if(h===undefined){return false}var g=h.x;var v=h.x+h.width;if(g<n||v>a){return false}}return true}function Pt(e){var t=new BX.SpotLight({id:"arrow_spotlight",targetElement:e,autoSave:true,targetVertex:"middle-center",zIndex:200});t.show();t.container.style.pointerEvents="none";return t}function Rt(e){var t=this;var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var n=babelHelpers.classPrivateFieldGet(this,gt).call(this).getContainer();var a=n.querySelector(".main-grid-ear-left");var r=n.querySelector(".main-grid-ear-right");n.style.pointerEvents="none";a.style.pointerEvents="none";r.style.pointerEvents="none";var s=function s(l){n.style.pointerEvents="auto";a.style.pointerEvents="auto";r.style.pointerEvents="auto";g.Event.unbind(babelHelpers.classPrivateFieldGet(t,vt),"click",s);e.apply(void 0,babelHelpers.toConsumableArray(i))};setTimeout((function(){g.Event.bind(babelHelpers.classPrivateFieldGet(t,vt),"click",s)}),500)}function Dt(e,t){var i=new f.Guide({steps:[Object.assign({target:e},t)],onEvents:true});this.activeHintGuide=i;i.showNextStep();return i}var Nt;function At(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=Ft(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var a=function e(){};return{s:a,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,s=false,l;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){s=true;l=t},f:function e(){try{if(!r&&i.return!=null)i.return()}finally{if(s)throw l}}}}function Ft(e,t){if(!e)return;if(typeof e==="string")return _t(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return _t(e,t)}function _t(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++){n[i]=e[i]}return n}function kt(e,t,i){Ut(e,t);return i}function Ut(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function wt(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var Ot="template_0";var Mt=2;var Ht=new WeakMap;var Bt=new WeakSet;var Lt=new WeakSet;var xt=new WeakSet;var Gt=function(){function e(t){babelHelpers.classCallCheck(this,e);xt.add(this);Lt.add(this);Bt.add(this);babelHelpers.defineProperty(this,"ajaxPool",new Map);babelHelpers.defineProperty(this,"products",[]);babelHelpers.defineProperty(this,"productsWasInitiated",false);babelHelpers.defineProperty(this,"isChangedGrid",false);babelHelpers.defineProperty(this,"cache",new g.Cache.MemoryCache);Ht.set(this,{writable:true,value:void 0});babelHelpers.defineProperty(this,"actions",{disableSaveButton:"disableSaveButton",productChange:"productChange",productListChanged:"productListChanged",updateListField:"listField",stateChanged:"stateChange",updateTotal:"total"});babelHelpers.defineProperty(this,"stateChange",{changed:false,sended:false});babelHelpers.defineProperty(this,"updateFieldForList",null);babelHelpers.defineProperty(this,"totalData",{inProgress:false});babelHelpers.defineProperty(this,"productSelectionPopupHandler",this.handleProductSelectionPopup.bind(this));babelHelpers.defineProperty(this,"productRowAddHandler",this.handleProductRowAdd.bind(this));babelHelpers.defineProperty(this,"showSettingsPopupHandler",this.handleShowSettingsPopup.bind(this));babelHelpers.defineProperty(this,"onDialogSelectProductHandler",this.handleOnDialogSelectProduct.bind(this));babelHelpers.defineProperty(this,"onSaveHandler",this.handleOnSave.bind(this));babelHelpers.defineProperty(this,"onEntityUpdateHandler",this.handleOnEntityUpdate.bind(this));babelHelpers.defineProperty(this,"onEditorSubmit",this.handleEditorSubmit.bind(this));babelHelpers.defineProperty(this,"onInnerCancelHandler",this.handleOnInnerCancel.bind(this));babelHelpers.defineProperty(this,"onBeforeGridRequestHandler",this.handleOnBeforeGridRequest.bind(this));babelHelpers.defineProperty(this,"onGridUpdatedHandler",this.handleOnGridUpdated.bind(this));babelHelpers.defineProperty(this,"onGridRowMovedHandler",this.handleOnGridRowMoved.bind(this));babelHelpers.defineProperty(this,"onBeforeProductChangeHandler",this.handleOnBeforeProductChange.bind(this));babelHelpers.defineProperty(this,"onProductChangeHandler",this.handleOnProductChange.bind(this));babelHelpers.defineProperty(this,"onProductClearHandler",this.handleOnProductClear.bind(this));babelHelpers.defineProperty(this,"dropdownChangeHandler",this.handleDropdownChange.bind(this));babelHelpers.defineProperty(this,"pullReloadGrid",null);babelHelpers.defineProperty(this,"changeProductFieldHandler",this.handleFieldChange.bind(this));babelHelpers.defineProperty(this,"updateTotalDataDelayedHandler",g.Runtime.debounce(this.updateTotalDataDelayed,1e3,this));this.setId(t)}babelHelpers.createClass(e,[{key:"init",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.setSettings(i);if(this.canEdit()){this.addFirstRowIfEmpty();this.enableEdit()}this.initForm();this.initProducts();this.initGridData();babelHelpers.classPrivateFieldSet(this,Ht,new Ct(this.getContainer(),this.getGrid.bind(this)));l.EventEmitter.emit(window,"EntityProductListController",[this]);wt(this,Bt,Vt).call(this);this.subscribeDomEvents();this.subscribeCustomEvents();if(this.getSettingValue("isReserveBlocked",false)){var n=["STORE_INFO","RESERVE_INFO"];var a=this.getContainer();n.forEach((function(e){var i=a===null||a===void 0?void 0:a.querySelector('.main-grid-cell-head[data-name="'.concat(e,'"] .main-grid-cell-head-container'));if(i){g.Dom.addClass(i,"main-grid-cell-head-locked");i.onclick=function(e){if(g.Dom.hasClass(e.target,"ui-hint-icon")){return}t.openIntegrationLimitSlider()};var n=g.Tag.render(Nt||(Nt=babelHelpers.taggedTemplateLiteral(['<span class="crm-entity-product-list-locked-header"></span>'])));i.insertBefore(n,i.firstChild)}}))}}},{key:"subscribeDomEvents",value:function e(){var t=this;this.unsubscribeDomEvents();var i=this.getContainer();if(g.Type.isElementNode(i)){i.querySelectorAll('[data-role="product-list-select-button"]').forEach((function(e){g.Event.bind(e,"click",t.productSelectionPopupHandler)}));i.querySelectorAll('[data-role="product-list-add-button"]').forEach((function(e){g.Event.bind(e,"click",t.productRowAddHandler)}));i.querySelectorAll('[data-role="product-list-settings-button"]').forEach((function(e){g.Event.bind(e,"click",t.showSettingsPopupHandler)}))}}},{key:"unsubscribeDomEvents",value:function e(){var t=this;var i=this.getContainer();if(g.Type.isElementNode(i)){i.querySelectorAll('[data-role="product-list-select-button"]').forEach((function(e){g.Event.unbind(e,"click",t.productSelectionPopupHandler)}));i.querySelectorAll('[data-role="product-list-add-button"]').forEach((function(e){g.Event.unbind(e,"click",t.productRowAddHandler)}));i.querySelectorAll('[data-role="product-list-settings-button"]').forEach((function(e){g.Event.unbind(e,"click",t.showSettingsPopupHandler)}))}}},{key:"subscribeCustomEvents",value:function e(){var t=this;this.unsubscribeCustomEvents();l.EventEmitter.subscribe("CrmProductSearchDialog_SelectProduct",this.onDialogSelectProductHandler);l.EventEmitter.subscribe("BX.Crm.EntityEditor:onSave",this.onSaveHandler);l.EventEmitter.subscribe("onCrmEntityUpdate",this.onEntityUpdateHandler);l.EventEmitter.subscribe("BX.Crm.EntityEditorAjax:onSubmit",this.onEditorSubmit);l.EventEmitter.subscribe("EntityProductListController:onInnerCancel",this.onInnerCancelHandler);l.EventEmitter.subscribe("Grid::beforeRequest",this.onBeforeGridRequestHandler);l.EventEmitter.subscribe("Grid::updated",this.onGridUpdatedHandler);l.EventEmitter.subscribe("Grid::rowMoved",this.onGridRowMovedHandler);l.EventEmitter.subscribe("BX.Catalog.ProductSelector:onBeforeChange",this.onBeforeProductChangeHandler);l.EventEmitter.subscribe("BX.Catalog.ProductSelector:onChange",this.onProductChangeHandler);l.EventEmitter.subscribe("BX.Catalog.ProductSelector:onClear",this.onProductClearHandler);l.EventEmitter.subscribe("Dropdown::change",this.dropdownChangeHandler);if(h.PULL){this.pullReloadGrid=h.PULL.subscribe({moduleId:"crm",callback:function e(i){if(i.command==="onCatalogInventoryManagementEnabled"||i.command==="onCatalogInventoryManagementDisabled"){t.reloadGrid(false)}}}).bind(this)}}},{key:"unsubscribeCustomEvents",value:function e(){l.EventEmitter.unsubscribe("CrmProductSearchDialog_SelectProduct",this.onDialogSelectProductHandler);l.EventEmitter.unsubscribe("BX.Crm.EntityEditor:onSave",this.onSaveHandler);l.EventEmitter.unsubscribe("onCrmEntityUpdate",this.onEntityUpdateHandler);l.EventEmitter.unsubscribe("BX.Crm.EntityEditorAjax:onSubmit",this.onEditorSubmit);l.EventEmitter.unsubscribe("EntityProductListController:onInnerCancel",this.onInnerCancelHandler);l.EventEmitter.unsubscribe("Grid::beforeRequest",this.onBeforeGridRequestHandler);l.EventEmitter.unsubscribe("Grid::updated",this.onGridUpdatedHandler);l.EventEmitter.unsubscribe("Grid::rowMoved",this.onGridRowMovedHandler);l.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onBeforeChange",this.onBeforeProductChangeHandler);l.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onChange",this.onProductChangeHandler);l.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onClear",this.onProductClearHandler);l.EventEmitter.unsubscribe("Dropdown::change",this.dropdownChangeHandler);if(!g.Type.isNil(this.pullReloadGrid)){this.pullReloadGrid()}}},{key:"handleOnDialogSelectProduct",value:function e(t){var i;var n=t.getCompatData(),a=babelHelpers.slicedToArray(n,1),r=a[0];var s;if(this.getProductCount()>0||((i=this.products[0])===null||i===void 0?void 0:i.getField("ID"))<=0){s=this.addProductRow()}else{var l;s=(l=this.products[0])===null||l===void 0?void 0:l.getField("ID")}this.selectProductInRow(s,r)}},{key:"selectProductInRow",value:function e(t,i){var n=this;if(!g.Type.isStringFilled(t)||g.Text.toNumber(i)<=0){return}requestAnimationFrame((function(){var e;(e=n.getProductSelector(t))===null||e===void 0?void 0:e.onProductSelect(i)}))}},{key:"handleOnSave",value:function e(t){var i=[];this.products.forEach((function(e){var t={fields:babelHelpers.objectSpread({},e.fields),rowId:e.fields.ROW_ID};i.push(t)}));this.setSettingValue("items",i)}},{key:"handleOnEntityUpdate",value:function e(t){var i=t.getData(),n=babelHelpers.slicedToArray(i,1),a=n[0];if(this.isChanged()&&a.entityId===this.getSettingValue("entityId")&&a.entityTypeId===this.getSettingValue("entityTypeId")){this.setGridChanged(false);this.reloadGrid(false)}}},{key:"handleEditorSubmit",value:function e(t){if(!this.isLocationDependantTaxesEnabled()){return}var i=t.getData()[0];if(!i||!i.hasOwnProperty("LOCATION_ID")){return}if(i["LOCATION_ID"]!==this.getLocationId()){this.setLocationId(i["LOCATION_ID"]);this.reloadGrid(false)}}},{key:"handleOnInnerCancel",value:function e(t){var i=this;if(this.controller){this.controller.rollback()}this.setGridChanged(false);l.EventEmitter.subscribeOnce(this,"onGridReloaded",(function(){return i.actionUpdateTotalData({isInternalChanging:true})}));this.reloadGrid(false)}},{key:"changeActivePanelButtons",value:function e(t){var i=this.getContainer();var n=i.querySelector(".crm-entity-product-list-add-block-"+t);if(g.Type.isDomNode(n)){g.Dom.removeClass(n,"crm-entity-product-list-add-block-hidden");g.Dom.addClass(n,"crm-entity-product-list-add-block-active")}var a=t==="top"?"bottom":"top";var r=i.querySelector(".crm-entity-product-list-add-block-"+a);if(g.Type.isDomNode(r)){g.Dom.addClass(r,"crm-entity-product-list-add-block-hidden");g.Dom.removeClass(r,"crm-entity-product-list-add-block-active")}return n}},{key:"reloadGrid",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.getGrid().reloadTable("POST",{useProductsFromRequest:i},(function(){return l.EventEmitter.emit(t,"onGridReloaded")}))}},{key:"handleOnBeforeGridRequest",value:function t(i){var n=this;var a=i.getCompatData(),r=babelHelpers.slicedToArray(a,2),s=r[0],o=r[1];if(!s||!s.parent||s.parent.getId()!==this.getGridId()){return}var d=!("useProductsFromRequest"in o.data);var u=d?true:o.data.useProductsFromRequest;o.url=this.getReloadUrl();o.method="POST";o.sessid=BX.bitrix_sessid();o.data=babelHelpers.objectSpread({},o.data,{signedParameters:this.getSignedParameters(),products:u?this.getProductsFields(kt(e,e,Wt).call(e)):null,locationId:this.getLocationId(),currencyId:this.getCurrencyId()});this.clearEditor();if(d&&this.isChanged()){l.EventEmitter.subscribeOnce("Grid::updated",(function(){return n.actionUpdateTotalData({isInternalChanging:false})}))}}},{key:"handleOnGridUpdated",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,1),a=n[0];if(!a||a.getId()!==this.getGridId()){return}this.getSettingsPopup().updateCheckboxState()}},{key:"handleOnGridRowMoved",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,3),a=n[0],r=n[2];if(!r||r.getId()!==this.getGridId()){return}var s=this.resortProductsByIds(a);if(s){this.refreshSortFields();this.numerateRows();this.executeActions([{type:this.actions.productListChanged}])}}},{key:"initPageEventsManager",value:function e(){var t=this.getSettingValue("componentId");this.pageEventsManager=new Qe({id:t})}},{key:"getPageEventsManager",value:function e(){if(!this.pageEventsManager){this.initPageEventsManager()}return this.pageEventsManager}},{key:"canEdit",value:function e(){return this.getSettingValue("allowEdit",false)===true}},{key:"canEditCatalogPrice",value:function e(){return this.getSettingValue("allowCatalogPriceEdit",false)===true}},{key:"canSaveCatalogPrice",value:function e(){return this.getSettingValue("allowCatalogPriceSave",false)===true}},{key:"enableEdit",value:function e(){var t=this.getGrid().getRows().getRows();t.forEach((function(e){if(!e.isHeadChild()&&!e.isTemplate()){e.edit()}}))}},{key:"addFirstRowIfEmpty",value:function e(){var t=this;if(this.getGrid().getRows().getCountDisplayed()===0){requestAnimationFrame((function(){return t.addProductRow()}))}}},{key:"clearEditor",value:function e(){this.unsubscribeProductsEvents();this.products=[];this.productsWasInitiated=false;this.destroySettingsPopup();this.unsubscribeDomEvents();this.unsubscribeCustomEvents();g.Event.unbindAll(this.container)}},{key:"wasProductsInitiated",value:function e(){return this.productsWasInitiated}},{key:"unsubscribeProductsEvents",value:function e(){this.products.forEach((function(e){e.unsubscribeCustomEvents()}))}},{key:"destroy",value:function e(){this.setForm(null);this.clearController();this.clearEditor()}},{key:"setController",value:function e(t){if(this.controller===t){return}if(this.controller){this.controller.clearProductList()}this.controller=t}},{key:"clearController",value:function e(){this.controller=null}},{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"getSettings",value:function e(){return this.settings}},{key:"setSettings",value:function e(t){this.settings=t?t:{}}},{key:"getSettingValue",value:function e(t,i){return this.settings.hasOwnProperty(t)?this.settings[t]:i}},{key:"setSettingValue",value:function e(t,i){this.settings[t]=i}},{key:"getComponentName",value:function e(){return this.getSettingValue("componentName","")}},{key:"getReloadUrl",value:function e(){return this.getSettingValue("reloadUrl","")}},{key:"getSignedParameters",value:function e(){return this.getSettingValue("signedParameters","")}},{key:"getContainerId",value:function e(){return this.getSettingValue("containerId","")}},{key:"getGridId",value:function e(){return this.getSettingValue("gridId","")}},{key:"getLanguageId",value:function e(){return this.getSettingValue("languageId","")}},{key:"getSiteId",value:function e(){return this.getSettingValue("siteId","")}},{key:"getCatalogId",value:function e(){return this.getSettingValue("catalogId",0)}},{key:"isReadOnly",value:function e(){return this.getSettingValue("readOnly",true)}},{key:"setReadOnly",value:function e(t){this.setSettingValue("readOnly",t)}},{key:"getCurrencyId",value:function e(){return this.getSettingValue("currencyId","")}},{key:"setCurrencyId",value:function e(t){this.setSettingValue("currencyId",t);this.products.forEach((function(e){var i;return(i=e.getModel())===null||i===void 0?void 0:i.setOption("currency",t)}))}},{key:"isLocationDependantTaxesEnabled",value:function e(){return this.getSettingValue("isLocationDependantTaxesEnabled",false)}},{key:"getLocationId",value:function e(){return this.getSettingValue("locationId")}},{key:"setLocationId",value:function e(t){this.setSettingValue("locationId",t)}},{key:"changeCurrencyId",value:function e(t){var i=this;this.setCurrencyId(t);var n=[];this.products.forEach((function(e){var t={};wt(i,Lt,Yt).call(i).forEach((function(i){t[i]=e.getField(i)}));n.push({fields:t,id:e.getId()})}));if(n.length>0){this.ajaxRequest("calculateProductPrices",{products:n,currencyId:t})}var a=this.getGridEditData();var r=a[Ot];r["CURRENCY"]=this.getCurrencyId();var s=["DISCOUNT_ROW","SUM","PRICE"];s.forEach((function(e){r[e]["CURRENCY"]["VALUE"]=i.getCurrencyId()}));this.setGridEditData(a)}},{key:"onCalculatePricesResponse",value:function e(t){this.products.forEach((function(e){if(g.Type.isObject(t[e.getId()])){e.updateUiCurrencyFields();["BASE_PRICE","ENTERED_PRICE","DISCOUNT_ROW","DISCOUNT_SUM","CURRENCY_ID"].forEach((function(i){e.updateField(i,g.Text.toNumber(t[e.getId()][i]))}));e.setField("CURRENCY",t[e.getId()]["CURRENCY_ID"])}}));this.updateTotalUiCurrency()}},{key:"updateTotalUiCurrency",value:function e(){var t=this;var i=BX(this.getSettingValue("totalBlockContainerId",null));if(g.Type.isElementNode(i)){i.querySelectorAll('[data-role="currency-wrapper"]').forEach((function(e){e.innerHTML=t.getCurrencyText()}))}}},{key:"getCurrencyText",value:function e(){var t=this.getCurrencyId();if(!g.Type.isStringFilled(t)){return""}var i=d.CurrencyCore.getCurrencyFormat(t);return i&&i.FORMAT_STRING.replace(/(^|[^&])#/,"$1").trim()||""}},{key:"getDataFieldName",value:function e(){return this.getSettingValue("dataFieldName","")}},{key:"getDataSettingsFieldName",value:function e(){var t=this.getDataFieldName();return g.Type.isStringFilled(t)?t+"_SETTINGS":""}},{key:"getDiscountEnabled",value:function e(){return this.getSettingValue("enableDiscount","N")}},{key:"getPricePrecision",value:function e(){return this.getSettingValue("pricePrecision",Mt)}},{key:"getQuantityPrecision",value:function e(){return this.getSettingValue("quantityPrecision",Mt)}},{key:"getCommonPrecision",value:function e(){return this.getSettingValue("commonPrecision",Mt)}},{key:"getTaxList",value:function e(){return this.getSettingValue("taxList",[])}},{key:"getTaxAllowed",value:function e(){return this.getSettingValue("allowTax","N")}},{key:"isTaxAllowed",value:function e(){return this.getTaxAllowed()==="Y"}},{key:"getTaxEnabled",value:function e(){return this.getSettingValue("enableTax","N")}},{key:"isTaxEnabled",value:function e(){return this.getTaxEnabled()==="Y"}},{key:"isTaxUniform",value:function e(){return this.getSettingValue("taxUniform",true)}},{key:"getMeasures",value:function e(){return this.getSettingValue("measures",[])}},{key:"getDefaultMeasure",value:function e(){return this.getSettingValue("defaultMeasure",{})}},{key:"getRowIdPrefix",value:function e(){return this.getSettingValue("rowIdPrefix","crm_entity_product_list_")}},{key:"parseInt",value:function(e){function t(t){return e.apply(this,arguments)}t.toString=function(){return e.toString()};return t}((function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var i;var n=g.Type.isNumber(e);var a=g.Type.isStringFilled(e);if(!n&&!a){return t}if(a){e=e.replace(/^\s+|\s+$/g,"");var r=e.indexOf("-")===0;i=parseInt(e.replace(/[^\d]/g,""),10);if(isNaN(i)){i=t}else{if(r){i=-i}}}else{i=parseInt(e,10);if(isNaN(i)){i=t}}return i}))},{key:"parseFloat",value:function(e){function t(t){return e.apply(this,arguments)}t.toString=function(){return e.toString()};return t}((function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:Mt;var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var n;var a=g.Type.isNumber(e);var r=g.Type.isStringFilled(e);if(!a&&!r){return i}if(r){e=e.replace(/^\s+|\s+$/g,"");var s=e.indexOf(".");var l=e.indexOf(",");var o=e.indexOf("-")===0;if(s<0&&l>=0){var d=e.substr(0,l);var u=e.length-l-1;if(u>0){d+="."+e.substr(l+1,u)}e=d}e=e.replace(/[^\d.]+/g,"");n=parseFloat(e);if(isNaN(n)){n=i}if(o){n=-n}}else{n=parseFloat(e)}if(t>=0){n=this.round(n,t)}return n}))},{key:"round",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:Mt;var n=Math.pow(10,i);return Math.round(t*n)/n}},{key:"calculatePriceWithoutDiscount",value:function e(t,i,n){var a=0;switch(n){case r.DiscountType.PERCENTAGE:a=t-t*i/100;break;case r.DiscountType.MONETARY:a=t-i;break}return a}},{key:"calculateDiscountRate",value:function e(t,i){if(t===0){return 0}if(i===0){return t>0?100:-100}return 100*(t-i)/t}},{key:"calculateDiscount",value:function e(t,i){return t*i/100}},{key:"calculatePriceWithoutTax",value:function e(t,i){return t/(1+i/100)}},{key:"calculatePriceWithTax",value:function e(t,i){return t*(1+i/100)}},{key:"getContainer",value:function e(){var t=this;return this.cache.remember("container",(function(){return document.getElementById(t.getContainerId())}))}},{key:"initForm",value:function e(){var t=this.getSettingValue("formId","");var i=g.Type.isStringFilled(t)?BX("form_"+t):null;if(g.Type.isElementNode(i)){this.setForm(i)}}},{key:"isExistForm",value:function e(){return g.Type.isElementNode(this.getForm())}},{key:"getForm",value:function e(){return this.form}},{key:"setForm",value:function e(t){this.form=t}},{key:"initFormFields",value:function e(){var t=this.getForm();if(g.Type.isElementNode(t)){var i=this.getDataField();if(!g.Type.isElementNode(i)){this.initDataField()}var n=this.getDataSettingsField();if(!g.Type.isElementNode(n)){this.initDataSettingsField()}}}},{key:"initFormField",value:function e(t){var i=this.getForm();if(g.Type.isElementNode(i)&&g.Type.isStringFilled(t)){g.Dom.append(g.Dom.create("input",{attrs:{type:"hidden",name:t}}),i)}}},{key:"removeFormFields",value:function e(){var t=this.getDataField();if(g.Type.isElementNode(t)){g.Dom.remove(t)}var i=this.getDataSettingsField();if(g.Type.isElementNode(i)){g.Dom.remove(i)}}},{key:"initDataField",value:function e(){this.initFormField(this.getDataFieldName())}},{key:"initDataSettingsField",value:function e(){this.initFormField(this.getDataSettingsFieldName())}},{key:"getFormField",value:function e(t){var i=this.getForm();if(g.Type.isElementNode(i)&&g.Type.isStringFilled(t)){return i.querySelector('input[name="'+t+'"]')}return null}},{key:"getDataField",value:function e(){return this.getFormField(this.getDataFieldName())}},{key:"getDataSettingsField",value:function e(){return this.getFormField(this.getDataSettingsFieldName())}},{key:"getProductCount",value:function e(){return this.products.filter((function(e){return!e.isEmpty()})).length}},{key:"initProducts",value:function e(){var t=this.getSettingValue("items",[]);var i=this.getSettingValue("isReserveBlocked",false);var n=At(t),a;try{for(n.s();!(a=n.n()).done;){var r=a.value;var s=babelHelpers.objectSpread({},r.fields);var l={selectorId:r.selectorId,isReserveBlocked:i};this.products.push(new Pe(r.rowId,s,l,this))}}catch(e){n.e(e)}finally{n.f()}this.numerateRows();this.productsWasInitiated=true}},{key:"numerateRows",value:function e(){this.products.forEach((function(e,t){e.setRowNumber(t+1)}))}},{key:"getGrid",value:function e(){var t=this;return this.cache.remember("grid",(function(){var e=t.getGridId();if(!g.Reflection.getClass("BX.Main.gridManager.getInstanceById")){throw Error("Cannot find grid with '".concat(e,"' id."))}return BX.Main.gridManager.getInstanceById(e)}))}},{key:"initGridData",value:function e(){var t=this.getSettingValue("templateGridEditData",null);if(t){this.setGridEditData(t)}}},{key:"getGridEditData",value:function e(){return this.getGrid().arParams.EDITABLE_DATA}},{key:"setGridEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA=t}},{key:"setOriginalTemplateEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA[Ot]=t}},{key:"handleProductErrorsChange",value:function e(){if(wt(this,xt,Xt).call(this)){this.controller.disableSaveButton()}}},{key:"handleFieldChange",value:function e(t){var i=t.target.closest("tr");if(i&&i.hasAttribute("data-id")){var n=this.getProductById(i.getAttribute("data-id"));if(n){var a=t.target.closest("td");var r=this.getFieldCodeByGridCell(i,a);if(r){n.updateFieldByEvent(r,t)}}}}},{key:"handleDropdownChange",value:function e(t){var i=t.getData(),n=babelHelpers.slicedToArray(i,5),a=n[0],r=n[4];var s=new RegExp(this.getRowIdPrefix()+"([A-Za-z0-9]+)_(\\w+)_control","i");var l=a.match(s);if(l){var o=babelHelpers.slicedToArray(l,3),d=o[1],u=o[2];var c=this.getProductById(d);if(c){c.updateField(u,r,c.modeChanges.EDIT)}}}},{key:"getProductById",value:function e(t){var i=this.getRowIdPrefix()+t;return this.getProductByRowId(i)}},{key:"getProductByRowId",value:function e(t){return this.products.find((function(e){return e.getId()===t}))}},{key:"getFieldCodeByGridCell",value:function e(t,i){if(!g.Type.isDomNode(t)||!g.Type.isDomNode(i)){return null}var n=this.getGrid();if(n){var a=n.getRows().getHeadFirstChild();var r=babelHelpers.toConsumableArray(t.cells).indexOf(i);return a.getCellNameByCellIndex(r)}return null}},{key:"handleProductSelectionPopup",value:function e(t){var i="crm_entity_product_list";var n=this.getSettingValue("jsEventsManagerId","");var a=new BX.CDialog({content_url:"/bitrix/components/bitrix/crm.product_row.list/product_choice_dialog.php?"+"caller="+i+"&JS_EVENTS_MANAGER_ID="+BX.util.urlencode(n)+"&sessid="+BX.bitrix_sessid(),height:Math.max(500,window.innerHeight-400),width:Math.max(800,window.innerWidth-400),draggable:true,resizable:true,min_height:500,min_width:800,zIndex:800});l.EventEmitter.subscribeOnce(a,"onWindowRegister",BX.defer((function(){a.Get().style.position="fixed";a.Get().style.top=parseInt(a.Get().style.top)-BX.GetWindowScrollPos().scrollTop+"px"})));l.EventEmitter.subscribeOnce(window,"EntityProductListController:onInnerCancel",BX.defer((function(){a.Close()})));if(!g.Type.isUndefined(BX.Crm.EntityEvent)){l.EventEmitter.subscribeOnce(window,BX.Crm.EntityEvent.names.update,BX.defer((function(){requestAnimationFrame((function(){a.Close()}),0)})))}a.Show()}},{key:"addProductRow",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var i=this.createGridProductRow();var n=i.getId();if(t){var a;var r=(a=this.getGrid().getRows().getById(t.getField("ID")))===null||a===void 0?void 0:a.getNode();if(r){r.parentNode.insertBefore(i.getNode(),r.nextSibling)}}this.initializeNewProductRow(n,t);this.getGrid().bindOnRowEvents();return n}},{key:"handleProductRowAdd",value:function e(){var t=this.addProductRow();this.focusProductSelector(t)}},{key:"handleShowSettingsPopup",value:function e(){this.getSettingsPopup().show()}},{key:"destroySettingsPopup",value:function e(){if(this.cache.has("settings-popup")){this.cache.get("settings-popup").getPopup().destroy();this.cache.delete("settings-popup")}}},{key:"getSettingsPopup",value:function e(){var t=this;return this.cache.remember("settings-popup",(function(){return new lt(t.getContainer().querySelector('.crm-entity-product-list-add-block-active [data-role="product-list-settings-button"]'),t.getSettingValue("popupSettings",[]),t)}))}},{key:"getHintPopup",value:function e(){var t=this;return this.cache.remember("hint-popup",(function(){return new E(t)}))}},{key:"createGridProductRow",value:function e(){var t=g.Text.getRandom();var i=this.redefineTemplateEditData(t);var n=this.getGrid();var a;if(this.getSettingValue("newRowPosition")==="bottom"){a=n.appendRowEditor()}else{a=n.prependRowEditor()}var r=a.getNode();if(g.Type.isDomNode(r)){r.setAttribute("data-id",t);a.makeCountable()}if(i){this.setOriginalTemplateEditData(i)}l.EventEmitter.emit("Grid::thereEditedRows",[]);n.adjustRows();n.updateCounterDisplayed();n.updateCounterSelected();return a}},{key:"handleDeleteRow",value:function e(t,i){i.preventDefault();this.deleteRow(t)}},{key:"redefineTemplateEditData",value:function e(t){var i=this.getGridEditData();var n=i[Ot];var a=this.prepareCustomEditData(n,t);this.setOriginalTemplateEditData(babelHelpers.objectSpread({},n,a));return n}},{key:"prepareCustomEditData",value:function e(t,i){var n={};var a=this.getSettingValue("templateIdMask","");for(var r in t){if(t.hasOwnProperty(r)){if(g.Type.isStringFilled(t[r])&&t[r].indexOf(a)>=0){n[r]=t[r].replace(new RegExp(a,"g"),i)}else if(g.Type.isPlainObject(t[r])){n[r]=this.prepareCustomEditData(t[r],i)}else{n[r]=t[r]}}}return n}},{key:"initializeNewProductRow",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var n=i===null||i===void 0?void 0:i.getFields();if(g.Type.isNil(n)){n=babelHelpers.objectSpread({},this.getSettingValue("templateItemFields",{}),{CURRENCY:this.getCurrencyId()});var a=this.products[this.products.length-1];if(a){n.TAX_INCLUDED=a.getField("TAX_INCLUDED")}}var r=this.getRowIdPrefix()+t;n.ID=t;if(g.Type.isObject(n.IMAGE_INFO)){delete n.IMAGE_INFO.input}delete n.RESERVE_ID;var s=this.getSettingValue("isReserveBlocked",false);var l=new Pe(r,n,{isReserveBlocked:s},this);l.refreshFieldsLayout();if(i instanceof Pe){var o,d;this.products.splice(1+this.products.indexOf(i),0,l);(o=l.getSelector())===null||o===void 0?void 0:o.reloadFileInput();(d=l.getSelector())===null||d===void 0?void 0:d.layout();l.updateUiMeasure(l.getField("MEASURE_CODE"),g.Text.encode(l.getField("MEASURE_NAME")))}else if(this.getSettingValue("newRowPosition")==="bottom"){this.products.push(l)}else{this.products.unshift(l)}this.refreshSortFields();this.numerateRows();l.updateUiCurrencyFields();this.updateTotalUiCurrency();return l}},{key:"isTaxIncludedActive",value:function e(){return this.products.filter((function(e){return e.isTaxIncluded()})).length>0}},{key:"getProductSelector",value:function e(t){return u.ProductSelector.getById("crm_grid_"+this.getRowIdPrefix()+t)}},{key:"focusProductSelector",value:function e(t){var i=this;requestAnimationFrame((function(){var e;(e=i.getProductSelector(t))===null||e===void 0?void 0:e.searchInDialog().focusName()}))}},{key:"handleOnBeforeProductChange",value:function e(t){var i=t.getData();var n=this.getProductByRowId(i.rowId);if(n){this.getGrid().tableFade();n.resetExternalActions()}}},{key:"handleOnProductChange",value:function e(t){var i=this;var n=t.getData();var a=this.getProductByRowId(n.rowId);if(a&&n.fields){var r=new Promise((function(e,t){var r=n.fields;if(!g.Type.isNil(r["IMAGE_INFO"])){r["IMAGE_INFO"]=JSON.stringify(r["IMAGE_INFO"])}if(i.getCurrencyId()!==r["CURRENCY_ID"]){r["CURRENCY"]=r["CURRENCY_ID"];var s={};wt(i,Lt,Yt).call(i).forEach((function(e){s[e]=n.fields[e]}));var l=[{fields:s,id:a.getId()}];g.ajax.runComponentAction(i.getComponentName(),"calculateProductPrices",{mode:"class",signedParameters:i.getSignedParameters(),data:{products:l,currencyId:i.getCurrencyId(),options:{ACTION:"calculateProductPrices"}}}).then((function(t){var i=t.data.result[a.getId()];if(i){i["CUSTOMIZED"]="Y";e(Object.assign(r,i))}else{e(r)}}))}else{e(r)}}));r.then((function(e){if(i.products.length>1){var t=e["VAT_ID"]||e["TAX_ID"];var r=e["VAT_INCLUDED"]||e["TAX_INCLUDED"];if(t>0&&r!==a.getTaxIncluded()){var s;var l=(s=i.getTaxList())===null||s===void 0?void 0:s.find((function(e){return parseInt(e.ID)===t}));if((l===null||l===void 0?void 0:l.VALUE)>0&&r==="Y"){e["BASE_PRICE"]=e["BASE_PRICE"]/(1+l.VALUE/100)}}["TAX_INCLUDED","VAT_INCLUDED"].forEach((function(t){return delete e[t]}))}e["CATALOG_PRICE"]=e["BASE_PRICE"];e["ENTERED_PRICE"]=e["BASE_PRICE"];if(a.getField("OFFER_ID")!==e.ID){e["ROW_RESERVED"]=0;e["DEDUCTED_QUANTITY"]=0}Object.keys(e).forEach((function(t){a.updateFieldValue(t,e[t])}));if(!g.Type.isStringFilled(e["CUSTOMIZED"])){a.setField("CUSTOMIZED","N")}a.setField("IS_NEW",n.isNew?"Y":"N");a.layoutReserveControl();a.initHandlersForSelectors();a.updateUiStoreAmountData();a.modifyBasePriceInput();a.executeExternalActions();i.getGrid().tableUnfade()}))}else{this.getGrid().tableUnfade()}}},{key:"handleOnProductClear",value:function e(t){var i=t.getData(),n=i.rowId;var a=this.getProductByRowId(n);if(a){a.layoutReserveControl();a.initHandlersForSelectors();a.changeEnteredPrice(0);a.modifyBasePriceInput();a.executeExternalActions()}}},{key:"compileProductData",value:function e(){if(!this.isExistForm()){return}this.initFormFields();var t=this.getDataField();var i=this.getDataSettingsField();this.cleanProductRows();if(g.Type.isElementNode(t)&&g.Type.isElementNode(i)){t.value=this.prepareProductDataValue();i.value=JSON.stringify({ENABLE_DISCOUNT:this.getDiscountEnabled(),ENABLE_TAX:this.getTaxEnabled()})}this.addFirstRowIfEmpty()}},{key:"prepareProductDataValue",value:function t(){var i="";if(this.getProductCount()){var n=[];this.products.forEach((function(t){var i=t.getFields(kt(e,e,Wt).call(e));if(!/^[0-9]+$/.test(i["ID"])){i["ID"]=0}i["CUSTOMIZED"]="Y";n.push(i)}));i=JSON.stringify(n)}return i}},{key:"executeActions",value:function e(t){var i=this;if(!g.Type.isArrayFilled(t)){return}var n=t.filter((function(e){return e.type===i.actions.updateTotal||e.type===i.actions.disableSaveButton})).length>0;var a=At(t),r;try{for(a.s();!(r=a.n()).done;){var s=r.value;if(!g.Type.isPlainObject(s)||!g.Type.isStringFilled(s.type)){continue}switch(s.type){case this.actions.productChange:this.actionSendProductChange(s,n);break;case this.actions.productListChanged:this.actionSendProductListChanged(n);break;case this.actions.updateListField:this.actionUpdateListField(s);break;case this.actions.updateTotal:this.actionUpdateTotalData();break;case this.actions.stateChanged:this.actionSendStatusChange(s);break}}}catch(e){a.e(e)}finally{a.f()}}},{key:"actionSendProductChange",value:function e(t,i){if(!g.Type.isStringFilled(t.id)){return}var n=this.getProductByRowId(t.id);if(!n){return}l.EventEmitter.emit(this,"ProductList::onChangeFields",{rowId:t.id,productId:n.getField("PRODUCT_ID"),fields:this.getProductByRowId(t.id).getCatalogFields()});if(this.controller){this.controller.productChange(i);this.setGridChanged(true)}}},{key:"actionSendProductListChanged",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(this.controller){this.controller.productChange(t);this.setGridChanged(true)}}},{key:"actionUpdateListField",value:function e(t){if(!g.Type.isStringFilled(t.field)||!("value"in t)){return}if(!this.allowUpdateListField(t.field)){return}this.updateFieldForList=t.field;var i=At(this.products),n;try{for(i.s();!(n=i.n()).done;){var a=n.value;a.updateFieldByName(t.field,t.value)}}catch(e){i.e(e)}finally{i.f()}this.updateFieldForList=null}},{key:"actionUpdateTotalData",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(this.totalData.inProgress){return}this.updateTotalDataDelayedHandler(t)}},{key:"actionSendStatusChange",value:function e(t){if(!("value"in t)){return}if(this.stateChange.changed===t.value){return}this.stateChange.changed=t.value;if(this.stateChange.sended){return}this.stateChange.sended=true}},{key:"allowUpdateListField",value:function e(t){if(this.updateFieldForList!==null){return false}var i=true;switch(t){case"TAX_INCLUDED":i=this.isTaxUniform()&&this.isTaxAllowed();break}return i}},{key:"setGridChanged",value:function e(t){this.isChangedGrid=t}},{key:"isChanged",value:function e(){return this.isChangedGrid}},{key:"updateTotalDataDelayed",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(this.totalData.inProgress){return}this.totalData.inProgress=true;var i=this.getProductsFields(this.getProductFieldListForTotalData());i.forEach((function(e){return e["CUSTOMIZED"]="Y"}));this.ajaxRequest("calculateTotalData",{options:t,products:i,currencyId:this.getCurrencyId()})}},{key:"getProductsFields",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var i=[];var n=At(this.products),a;try{for(n.s();!(a=n.n()).done;){var r=a.value;i.push(r.getFields(t))}}catch(e){n.e(e)}finally{n.f()}return i}},{key:"getProductFieldListForTotalData",value:function e(){return["PRODUCT_ID","PRODUCT_NAME","QUANTITY","DISCOUNT_TYPE_ID","DISCOUNT_RATE","DISCOUNT_SUM","TAX_RATE","TAX_INCLUDED","PRICE_EXCLUSIVE","PRICE","CUSTOMIZED"]}},{key:"setTotalData",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=BX(this.getSettingValue("totalBlockContainerId",null));if(g.Type.isElementNode(n)){var a=this.getCurrencyId();var r=["totalCost","totalDelivery","totalTax","totalWithoutTax","totalDiscount","totalWithoutDiscount"];for(var s=0,l=r;s<l.length;s++){var o=l[s];var u=n.querySelector('[data-total="'+o+'"]');if(g.Type.isElementNode(u)&&o in t){u.innerHTML=d.CurrencyCore.currencyFormat(t[o],a,false)}}}this.sendTotalData(t,i);this.totalData.inProgress=false}},{key:"sendTotalData",value:function e(t,i){var n=this;if(this.controller){var a=true;if(g.Type.isObject(i)&&(i.isInternalChanging===true||i.isInternalChanging==="true")){a=false}setTimeout((function(){n.controller.changeSumTotal(t,a,!wt(n,xt,Xt).call(n))}),500)}}},{key:"ajaxRequest",value:function e(t,i){var n=this;var a=g.Text.getRandom();this.ajaxPool.set(t,a);if(!g.Type.isPlainObject(i.options)){i.options={}}i.options.ACTION=t;i.options.REQUEST_KEY=a;g.ajax.runComponentAction(this.getComponentName(),t,{mode:"class",signedParameters:this.getSignedParameters(),data:i}).then((function(e){return n.ajaxResultSuccess(e,i.options)}),(function(e){return n.ajaxResultFailure(e,i.options)}))}},{key:"ajaxResultSuccess",value:function e(t,i){if(!this.ajaxResultCommonCheck(t)||this.ajaxPool.get(t.data.action)!==i.REQUEST_KEY){return}this.ajaxPool.delete(t.data.action);l.EventEmitter.emit(this,"onAjaxSuccess",t.data.action);switch(t.data.action){case"calculateTotalData":if(g.Type.isPlainObject(t.data.result)){this.setTotalData(t.data.result,i)}break;case"calculateProductPrices":if(g.Type.isPlainObject(t.data.result)){this.onCalculatePricesResponse(t.data.result)}break}}},{key:"validateSubmit",value:function e(){return new Promise((function(e,t){var i=BX.UI.Notification.Center.getBalloonByCategory(c.ProductModel.SAVE_NOTIFICATION_CATEGORY);if(i){l.EventEmitter.subscribeOnce(i,BX.UI.Notification.Event.getFullName("onClose"),(function(){setTimeout(e,500)}));i.close()}else{setTimeout(e(),50)}}))}},{key:"ajaxResultFailure",value:function e(t,i){this.ajaxPool.delete(i.ACTION)}},{key:"ajaxResultCommonCheck",value:function e(t){if(!g.Type.isPlainObject(t)){return false}if(!g.Type.isStringFilled(t.status)){return false}if(t.status!=="success"){return false}if(!g.Type.isPlainObject(t.data)){return false}if(!g.Type.isStringFilled(t.data.action)){return false}if(!("result"in t.data)){return false}return true}},{key:"deleteRow",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!g.Type.isStringFilled(t)){return}var n=this.getGrid().getRows().getById(t);if(n){g.Dom.remove(n.getNode());this.getGrid().getRows().reset()}var a=this.getProductById(t);if(a){var r=this.products.indexOf(a);if(r>-1){this.products.splice(r,1);this.refreshSortFields();this.numerateRows()}}l.EventEmitter.emit("Grid::thereEditedRows",[]);if(!i){this.addFirstRowIfEmpty();this.executeActions([{type:this.actions.productListChanged},{type:this.actions.updateTotal}])}}},{key:"copyRow",value:function e(t){this.addProductRow(t);this.refreshSortFields();this.numerateRows();l.EventEmitter.emit("Grid::thereEditedRows",[]);this.executeActions([{type:this.actions.productListChanged},{type:this.actions.updateTotal}])}},{key:"cleanProductRows",value:function e(){var t=this;this.products.filter((function(e){return e.isEmpty()})).forEach((function(e){return t.deleteRow(e.getField("ID"),true)}))}},{key:"resortProductsByIds",value:function e(t){var i=false;if(g.Type.isArrayFilled(t)){this.products.sort((function(e,n){if(t.indexOf(e.getField("ID"))>t.indexOf(n.getField("ID"))){return 1}i=true;return-1}))}return i}},{key:"refreshSortFields",value:function e(){this.products.forEach((function(e,t){return e.setField("SORT",(t+1)*10)}))}},{key:"handleOnTabShow",value:function e(){l.EventEmitter.emit("onDemandRecalculateWrapper",[this])}},{key:"showFieldTourHint",value:function e(t,i,n){var a=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];if(this.products.length>0){var r=this.products[0].getNode();var s=[];var l=At(a),o;try{for(l.s();!(o=l.n()).done;){var d=o.value;var u=r.querySelector('[data-name="'.concat(d,'"]'));if(u!==null){s.push(u)}}}catch(e){l.e(e)}finally{l.f()}var c=r.querySelector('[data-name="'.concat(t,'"]'));if(c!==null){babelHelpers.classPrivateFieldGet(this,Ht).processFieldTour(c,i,n,s)}}}},{key:"getActiveHint",value:function e(){return babelHelpers.classPrivateFieldGet(this,Ht).getActiveHint()}},{key:"openIntegrationLimitSlider",value:function e(){top.BX.UI.InfoHelper.show("limit_store_crm_integration");var t=top.BX.UI.InfoHelper.getSlider();top.BX.Event.EventEmitter.subscribeOnce("SidePanel.Slider:onCloseComplete",(function(e){var i;var n=(i=e.getData()[0])===null||i===void 0?void 0:i.getSlider();if(n!==t){return}window.location.search+="&active_tab=tab_products"}))}}]);return e}();function Vt(){this.getGrid()._clickOnRowActionsButton=function(){}}function Yt(){return["BASE_PRICE","ENTERED_PRICE","TAX_INCLUDED","PRICE_NETTO","PRICE_BRUTTO","DISCOUNT_ROW","DISCOUNT_SUM","CURRENCY"]}function Xt(){return this.products.filter((function(e){return e.getModel().getErrorCollection().hasErrors()})).length>0}function Wt(){return["ID","PRODUCT_ID","PRODUCT_NAME","QUANTITY","TAX_RATE","TAX_INCLUDED","PRICE_EXCLUSIVE","PRICE_NETTO","PRICE_BRUTTO","PRICE","CUSTOMIZED","BASE_PRICE","ENTERED_PRICE","DISCOUNT_ROW","DISCOUNT_SUM","DISCOUNT_TYPE_ID","DISCOUNT_RATE","CURRENCY","STORE_ID","INPUT_RESERVE_QUANTITY","RESERVE_QUANTITY","DATE_RESERVE_END","SORT","MEASURE_CODE","MEASURE_NAME"]}e.Editor=Gt;e.PageEventsManager=Qe})(this.BX.Crm.Entity.ProductList=this.BX.Crm.Entity.ProductList||{},BX,BX,BX,BX.Catalog,BX.Catalog,BX.Main,BX.Event,BX.Catalog.StoreUse,BX.Currency,BX.Catalog,BX.Catalog,BX,BX,BX,BX.UI.Tour);
//# sourceMappingURL=script.map.js