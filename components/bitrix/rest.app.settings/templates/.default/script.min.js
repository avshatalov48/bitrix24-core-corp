this.BX=this.BX||{};(function(e,s,t,a,l){"use strict";var i;function r(e,s,t){n(e,s);s.set(e,t)}function n(e,s){if(s.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var o=new WeakMap;var b=new WeakMap;var c=new WeakMap;var d=new WeakMap;var v=new WeakMap;var u=new WeakMap;var p=new WeakMap;var h=function(e){babelHelpers.inherits(n,e);function n(e){var a;babelHelpers.classCallCheck(this,n);a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this));r(babelHelpers.assertThisInitialized(a),o,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(a),b,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(a),c,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(a),d,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(a),v,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(a),u,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(a),p,{writable:true,value:void 0});if(!(e.formConstructor instanceof l.FormConstructor)){throw new Error('"formConstructor" is required parameters')}babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),c,null);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),v,s.Type.isElementNode(e.wrapper)?e.wrapper:null);a.setFormConstructor(e.formConstructor);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),b,s.Type.isStringFilled(e.handler)?e.handler:null);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),d,s.Type.isStringFilled(e.clientId)?e.clientId:null);a.setRedirect(e.redirect);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),u,new t.Loader({target:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),v)}));babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),p,s.Tag.render(i||(i=babelHelpers.taggedTemplateLiteral(['<div class="rest-app-settings-overlay"></div>']))));return a}babelHelpers.createClass(n,[{key:"setRedirect",value:function e(t){var a=new RegExp("^(?:/|https?://"+location.host+")","g");if(s.Type.isStringFilled(t)&&!!t.match(a)){babelHelpers.classPrivateFieldSet(this,c,t)}}},{key:"show",value:function e(){if(s.Type.isNil(babelHelpers.classPrivateFieldGet(this,v))){throw new Error('Property "wrapper" is undefined')}babelHelpers.classPrivateFieldGet(this,o).renderTo(babelHelpers.classPrivateFieldGet(this,v))}},{key:"subscribeEvents",value:function e(){var s=this;if(!(babelHelpers.classPrivateFieldGet(this,o)instanceof l.FormConstructor)){return}a.EventEmitter.subscribe(a.EventEmitter.GLOBAL_TARGET,"button-click",(function(e){var t=babelHelpers.slicedToArray(e.data,1),a=t[0];if(a.TYPE==="save"){var l={clientId:babelHelpers.classPrivateFieldGet(s,d),settings:babelHelpers.classPrivateFieldGet(s,o).getFormData(),handler:babelHelpers.classPrivateFieldGet(s,b)};s.save(l)}}));babelHelpers.classPrivateFieldGet(this,o).subscribe("onReadySave",(function(){if(s.isReadySave()){BX.UI.ButtonPanel.show()}else{BX.UI.ButtonPanel.hide()}}));babelHelpers.classPrivateFieldGet(this,o).subscribe("onUnreadySave",(function(){BX.UI.ButtonPanel.hide()}));babelHelpers.classPrivateFieldGet(this,o).subscribe("onFieldChange",(function(){s.reload()}))}},{key:"unsubscribeEvents",value:function e(){if(!(babelHelpers.classPrivateFieldGet(this,o)instanceof l.FormConstructor)){return}a.EventEmitter.unsubscribeAll(a.EventEmitter.GLOBAL_TARGET,"button-click");babelHelpers.classPrivateFieldGet(this,o).unsubscribeAll("onSave");babelHelpers.classPrivateFieldGet(this,o).unsubscribeAll("onReadySave");babelHelpers.classPrivateFieldGet(this,o).unsubscribeAll("onUnreadySave");babelHelpers.classPrivateFieldGet(this,o).unsubscribeAll("onFieldChange")}},{key:"setFormConstructor",value:function e(s){this.unsubscribeEvents();babelHelpers.classPrivateFieldSet(this,o,s);this.subscribeEvents()}},{key:"reload",value:function e(){var t=this;s.Dom.append(babelHelpers.classPrivateFieldGet(this,p),babelHelpers.classPrivateFieldGet(this,v));babelHelpers.classPrivateFieldGet(this,u).show();if(s.Type.isNil(babelHelpers.classPrivateFieldGet(this,d))){console.log('Property "clientId" is undefined');return}s.ajax.runComponentAction("bitrix:rest.app.settings","reload",{mode:"class",data:{clientId:babelHelpers.classPrivateFieldGet(this,d),settings:babelHelpers.classPrivateFieldGet(this,o).getFormData()}}).then((function(e){var a=e.data;t.setFormConstructor(new l.FormConstructor({steps:a.STEPS}));babelHelpers.classPrivateFieldSet(t,b,s.Type.isStringFilled(a.HANDLER)?a.HANDLER:babelHelpers.classPrivateFieldGet(t,b));babelHelpers.classPrivateFieldSet(t,d,s.Type.isStringFilled(a.CLIENT_ID)?a.CLIENT_ID:babelHelpers.classPrivateFieldGet(t,d));t.setRedirect(a.REDIRECT);t.show();babelHelpers.classPrivateFieldGet(t,u).hide();s.Dom.remove(babelHelpers.classPrivateFieldGet(t,p))}))["catch"]((function(e){console.log(e.errors);babelHelpers.classPrivateFieldGet(t,o).showTextInBalloon(s.Loc.getMessage("REST_APP_SETTINGS_ERROR"))}))}},{key:"isReadySave",value:function e(){var s=true;babelHelpers.classPrivateFieldGet(this,o).getFields().forEach((function(e){if(!e.isReadySave()){s=false}}));return s}},{key:"save",value:function e(t){var a=this;s.ajax.runAction("rest.einvoice.save",{mode:"class",data:t}).then((function(){if(s.Type.isNil(babelHelpers.classPrivateFieldGet(a,c))){top.BX.SidePanel.Instance.close()}else{top.document.location.href=babelHelpers.classPrivateFieldGet(a,c)}var e=BX.UI.ButtonPanel.getContainer().querySelector(".ui-btn-wait");s.Dom.removeClass(e,"ui-btn-wait")}))["catch"]((function(e){var t=e.errors;var l=n.formatErrors(t),i=l.fieldErrors,r=l.otherErrors;babelHelpers.classPrivateFieldGet(a,o).showFieldErrors(i);if(s.Type.isArrayFilled(r)){babelHelpers.classPrivateFieldGet(a,o).showTextInBalloon(s.Loc.getMessage("REST_APP_SETTINGS_ERROR"))}var b=BX.UI.ButtonPanel.getContainer().querySelector(".ui-btn-wait");if(b){s.Dom.removeClass(b,"ui-btn-wait")}BX.UI.ButtonPanel.hide()}))}}],[{key:"formatErrors",value:function e(t){var a={};var l=[];t.forEach((function(e){var t;if(s.Type.isStringFilled((t=e.customData)===null||t===void 0?void 0:t.fieldName)){var i,r,n;Array.isArray(a[(i=e.customData)===null||i===void 0?void 0:i.fieldName])?a[(r=e.customData)===null||r===void 0?void 0:r.fieldName].push(e.message):a[(n=e.customData)===null||n===void 0?void 0:n.fieldName]=[e.message]}else{l.push(e.message)}}));return{fieldErrors:a,otherErrors:l}}}]);return n}(a.EventEmitter);e.AppSettings=h})(this.BX.Rest=this.BX.Rest||{},BX,BX,BX.Event,BX.Rest);
//# sourceMappingURL=script.map.js