this.BX=this.BX||{};this.BX.Disk=this.BX.Disk||{};(function(e,t,n,i,s,o,r,a,u){"use strict";function d(e,t,n){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return n}var l=3;var c=25;var h=new WeakSet;var f=function(){function e(t){babelHelpers.classCallCheck(this,e);h.add(this);babelHelpers.defineProperty(this,"userBoxNode",null);babelHelpers.defineProperty(this,"context",null);babelHelpers.defineProperty(this,"alreadySaidHi",false);this.users=new BX.Disk.Users([]);this.badAttempts=new Map;this.context=t.context;this.userBoxNode=t.userBoxNode;this.alreadySaidHi=false;this.add(this.context.currentUser);this.bindEvents()}babelHelpers.createClass(e,[{key:"bindEvents",value:function e(){var t=this;s.EventEmitter.subscribe("onPullStatus",function(e){if(e.getData()[0]==="online"){t.handleWhenPullConnected()}})}},{key:"handleWhenPullConnected",value:function e(){if(!this.sentGreetings()){this.sendHiToUsers();setInterval(this.actualizeOnline.bind(this),1e3*c)}}},{key:"actualizeOnline",value:function e(){this.refineUsersByOnline();if(!this.sentGreetings()){this.sendHiToUsers()}else{this.sendPingToUsers()}}},{key:"sentGreetings",value:function e(){return this.alreadySaidHi}},{key:"sendHiToUsers",value:function e(){if(!a.PULL.isConnected()){return}a.PULL.sendMessage([-1],"disk","hiToDocument",{user:{id:this.context.currentUser.id,name:this.context.currentUser.name,avatar:d(this,h,b).call(this,this.context.currentUser.avatar)}});this.alreadySaidHi=true}},{key:"sendWelcomeToUser",value:function e(){if(!a.PULL.isConnected()){return}a.PULL.sendMessage([-1],"disk","welcomeToDocument",{user:{id:this.context.currentUser.id,name:this.context.currentUser.name,avatar:d(this,h,b).call(this,this.context.currentUser.avatar)}})}},{key:"sendPingToUsers",value:function e(){if(!a.PULL.isConnected()){return}a.PULL.sendMessage([-1],"disk","pingDocument",{fromUserId:this.context.currentUser.id,infoToken:this.context.currentUser.infoToken})}},{key:"add",value:function e(t){if(!this.users.hasUser(t.id)){this.users.addUser(t);console.log("Hi new user!",t.id)}this.updateOnline(t.id);this.renderBox()}},{key:"updateOnline",value:function e(t){if(this.users.hasUser(t)){this.users.getUser(t).onlineAt=Date.now()}}},{key:"getUserInfo",value:function e(t,n){var i=this;if(this.badAttempts.get(t)>=l){return new Promise(function(e,t){t({status:"blocked"})})}return new Promise(function(e,s){u.ajax.runComponentAction("bitrix:disk.file.editor-onlyoffice","getUserInfo",{mode:"ajax",json:{documentSessionId:i.context.documentSession.id,documentSessionHash:i.context.documentSession.hash,userId:t,infoToken:n}}).then(function(n){if(n.status==="success"){i.badAttempts.delete(t);e(n.data.user)}},function(e){var n=i.badAttempts.get(t)||0;i.badAttempts.set(t,n+1);console.log(i.badAttempts);s(e)})})}},{key:"has",value:function e(t){return this.users.hasUser(t)}},{key:"remove",value:function e(t){if(t===this.context.currentUser.id){return}this.users.deleteUser(t);this.renderBox()}},{key:"refineUsersByOnline",value:function e(){var t=this;var n=1e3*(c+1)*2;var i=Date.now();this.users.forEach(function(e){if(i-e.onlineAt>n){t.remove(e.id)}})}},{key:"renderBox",value:function e(){if(!this.userBoxNode.childElementCount){this.userBoxNode.appendChild(this.users.getContainer())}}}]);return e}();function b(e){if(e.includes("http://")||e.includes("https://")){return e}return document.location.origin+e}var m=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"options",null);babelHelpers.defineProperty(this,"userManager",null);this.options=t;this.userManager=t.userManager;this.context=t.context}babelHelpers.createClass(e,[{key:"getModuleId",value:function e(){return"disk"}},{key:"getSubscriptionType",value:function e(){return a.PullClient.SubscriptionType.Server}},{key:"filterCurrentObject",value:function e(t){var n=this;return function(e){if(n.context.object.id!==e.object.id){return}return t(e)}}},{key:"isCurrentUser",value:function e(t){return this.context.currentUser.id===t}}]);return e}();var p=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getSubscriptionType",value:function e(){return a.PullClient.SubscriptionType.Client}},{key:"getMap",value:function e(){return{exitDocument:this.handleExitDocument.bind(this),pingDocument:this.handlePingDocument.bind(this),hiToDocument:this.handleHiToDocument.bind(this),welcomeToDocument:this.handleWelcomeToDocument.bind(this)}}},{key:"handleExitDocument",value:function e(t){console.log("exitDocument",t);var n=t.fromUserId;if(!this.isCurrentUser(n)){this.userManager.remove(n)}}},{key:"handleWelcomeToDocument",value:function e(t){console.log("handleWelcomeToDocument",t);this.processNewbieInDocument(t)}},{key:"handleHiToDocument",value:function e(t){console.log("handleHiToDocument",t);var n=this.processNewbieInDocument(t);if(n){this.userManager.sendWelcomeToUser()}}},{key:"processNewbieInDocument",value:function e(t){var n=t.user.id;if(this.isCurrentUser(n)){return false}if(this.userManager.has(n)){this.userManager.updateOnline(n);return false}this.userManager.add(t.user);return true}},{key:"handlePingDocument",value:function e(t){var n=this;console.log("handlePingDocument",t);var i=t.fromUserId;if(this.isCurrentUser(i)){return}if(this.userManager.has(i)){this.userManager.updateOnline(i)}else{if(this.userManager.sentGreetings()){this.userManager.getUserInfo(t.fromUserId,t.infoToken).then(function(e){n.userManager.add(e)},function(){})}}}}]);return t}(m);var v=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"editor",null);babelHelpers.defineProperty(this,"editorJson",null);babelHelpers.defineProperty(this,"userBoxNode",null);babelHelpers.defineProperty(this,"editorNode",null);babelHelpers.defineProperty(this,"editorWrapperNode",null);babelHelpers.defineProperty(this,"targetNode",null);babelHelpers.defineProperty(this,"documentSession",null);babelHelpers.defineProperty(this,"linkToEdit",null);babelHelpers.defineProperty(this,"pullConfig",null);babelHelpers.defineProperty(this,"editButton",null);babelHelpers.defineProperty(this,"setupSharingButton",null);babelHelpers.defineProperty(this,"documentWasChanged",false);babelHelpers.defineProperty(this,"dontEndCurrentDocumentSession",false);babelHelpers.defineProperty(this,"context",null);babelHelpers.defineProperty(this,"usersInDocument",null);babelHelpers.defineProperty(this,"sharingControlType",null);var i=u.Type.isPlainObject(t)?t:{};this.pullConfig=i.pullConfig;this.documentSession=i.documentSession;this.linkToEdit=i.linkToEdit;this.targetNode=i.targetNode;this.userBoxNode=i.userBoxNode;this.editorNode=i.editorNode;this.editorWrapperNode=i.editorWrapperNode;this.editButton=n.ButtonManager.createByUniqId(t.panelButtonUniqIds.edit);this.setupSharingButton=n.ButtonManager.createByUniqId(t.panelButtonUniqIds.setupSharing);this.sharingControlType=t.sharingControlType;this.context={currentUser:i.currentUser,documentSession:this.documentSession,object:i.object,attachedObject:i.attachedObject};this.usersInDocument=new f({context:this.context,userBoxNode:this.userBoxNode});this.sendTelemetryEvent("load");this.initializeEditor(i.editorJson);var s=BX.SidePanel.Instance.getSliderByWindow(window);if(s){s.getData().set("documentSession",this.documentSession);this.loadDiskExtensionInTopWindow()}this.initPull();this.bindEvents()}babelHelpers.createClass(e,[{key:"initPull",value:function e(){if(this.pullConfig){BX.PULL=new a.PullClient({skipStorageInit:true});BX.PULL.start(this.pullConfig)}}},{key:"sendTelemetryEvent",value:function e(t,n){n=n||{};var i=BX.SidePanel.Instance.getSliderByWindow(window);if(!i){return}var s=i.getData();n.action=t;n.uid=s.get("uid");n.documentSessionId=this.context.documentSession.id;n.documentSessionHash=this.context.documentSession.hash;n.fileSize=this.context.object.size;BX.Disk.sendTelemetryEvent(n)}},{key:"bindEvents",value:function e(){s.EventEmitter.subscribe("SidePanel.Slider:onClose",this.handleClose.bind(this));window.addEventListener("beforeunload",this.handleClose.bind(this));if(this.editorJson.document.permissions.edit===true&&this.editButton){if(this.editButton.hasOwnProperty("mainButton")){this.editButton.getMainButton().bindEvent("click",this.handleClickEditButton.bind(this));var t=this.editButton.getMenuWindow();var n=u.Runtime.clone(t.getMenuItems());for(var i=0;i<n.length;i++){var o=n[i];var r=u.Runtime.clone(o.options);r.onclick=this.handleClickEditSubItems.bind(this);t.removeMenuItem(o.getId());t.addMenuItem(r)}}else{this.editButton.bindEvent("click",this.handleClickEditButton.bind(this))}}if(this.setupSharingButton){var d=this.setupSharingButton.getMenuWindow();var l=d.getMenuItem("ext-link").options;l.onclick=this.handleClickSharingByExternalLink.bind(this);d.removeMenuItem("ext-link");d.addMenuItem(l);var c=d.getMenuItem("sharing").options;c.onclick=this.handleClickSharing.bind(this);d.removeMenuItem("sharing");d.addMenuItem(c)}a.PULL.subscribe(new p({context:this.context,userManager:this.usersInDocument}))}},{key:"initializeEditor",value:function e(t){this.adjustEditorHeight(t);t.events={onDocumentStateChange:this.handleDocumentStateChange.bind(this),onDocumentReady:this.handleDocumentReady.bind(this),onMetaChange:this.handleMetaChange.bind(this),onInfo:this.handleInfo.bind(this)};if(t.document.permissions.rename){t.events.onRequestRename=this.handleRequestRename.bind(this)}this.editorJson=t;this.editor=new DocsAPI.DocEditor(this.editorNode.id,t)}},{key:"adjustEditorHeight",value:function e(t){t.height=document.body.clientHeight-70+"px"}},{key:"loadDiskExtensionInTopWindow",value:function e(){if(window.top!==window&&!BX.getClass("window.top.BX.Disk.endEditSession")){top.BX.loadExt("disk")}}},{key:"emitEventOnSaved",value:function e(){var t=BX.SidePanel.Instance.getSliderByWindow(window);if(t){BX.SidePanel.Instance.postMessageAll(window,"Disk.OnlyOffice:onSaved",{documentSession:this.documentSession,object:this.context.object})}s.EventEmitter.emit("Disk.OnlyOffice:onSaved",{documentSession:this.documentSession,object:this.context.object})}},{key:"emitEventOnClosed",value:function e(){var t=BX.SidePanel.Instance.getSliderByWindow(window);var n="edit";if(t){n=t.getData().get("process")||"edit";BX.SidePanel.Instance.postMessageAll(window,"Disk.OnlyOffice:onClosed",{documentSession:this.documentSession,object:this.context.object,process:n})}s.EventEmitter.emit("Disk.OnlyOffice:onClosed",{documentSession:this.documentSession,object:this.context.object,process:n})}},{key:"handleClickEditButton",value:function e(){this.handleRequestEditRights()}},{key:"handleClickSharing",value:function e(){switch(this.sharingControlType){case o.SharingControlType.WITH_CHANGE_RIGHTS:(new o.LegacyPopup).showSharingDetailWithChangeRights({object:this.context.object});break;case o.SharingControlType.WITH_SHARING:(new o.LegacyPopup).showSharingDetailWithChangeRights({object:this.context.object});break;case o.SharingControlType.WITHOUT_EDIT:(new o.LegacyPopup).showSharingDetailWithoutEdit({object:this.context.object});break}}},{key:"handleClickSharingByExternalLink",value:function e(){r.ExternalLink.showPopup(this.context.object.id)}},{key:"handleClickEditSubItems",value:function e(t,n){var i=n.getId();if(i==="onlyoffice"){this.handleClickEditButton();return}BX.Disk.Viewer.Actions.runActionEdit({objectId:this.context.object.id,attachedObjectId:this.context.attachedObject.id,serviceCode:i})}},{key:"handleSaveButtonClick",value:function e(){var t=this;a.PULL.subscribe({moduleId:"disk",command:"onlyoffice",callback:function e(n){if(n.hash===t.documentSession.hash){t.emitEventOnSaved();window.BX.Disk.showModalWithStatusAction();BX.SidePanel.Instance.close()}}})}},{key:"handleClose",value:function e(){a.PULL.sendMessage([-1],"disk","exitDocument",{fromUserId:this.context.currentUser.id});this.sendTelemetryEvent("exit");this.emitEventOnClosed();if(this.dontEndCurrentDocumentSession){return}top.BX.Disk.endEditSession({id:this.documentSession.id,hash:this.documentSession.hash,documentWasChanged:this.documentWasChanged})}},{key:"handleDocumentStateChange",value:function e(t){if(!this.caughtDocumentReady||!this.caughtInfoEvent){return}if(Date.now()-Math.max(this.caughtDocumentReady,this.caughtInfoEvent)<500){return}this.documentWasChanged=true}},{key:"handleInfo",value:function e(){this.caughtInfoEvent=Date.now()}},{key:"handleRequestRename",value:function e(t){var n=t.data;u.ajax.runAction("disk.api.onlyoffice.renameDocument",{mode:"ajax",json:{documentSessionId:this.context.documentSession.id,documentSessionHash:this.context.documentSession.hash,newName:n}})}},{key:"handleMetaChange",value:function e(t){}},{key:"handleDocumentReady",value:function e(){this.sendTelemetryEvent("ready");this.caughtDocumentReady=Date.now()}},{key:"handleRequestEditRights",value:function e(){this.dontEndCurrentDocumentSession=true;var t=BX.util.add_url_param("/bitrix/services/main/ajax.php",{action:"disk.api.documentService.goToEdit",serviceCode:"onlyoffice",documentSessionId:this.documentSession.id,documentSessionHash:this.documentSession.hash});if(this.linkToEdit){t=this.linkToEdit}var n=BX.SidePanel.Instance.getSliderByWindow(window);if(!n){window.location=t;return}var i=n.getCustomLeftBoundary();n.close();BX.SidePanel.Instance.open(t,{width:"100%",customLeftBoundary:i,cacheable:false,allowChangeHistory:false,data:{documentEditor:true}})}},{key:"getEditor",value:function e(){return this.editor}},{key:"getEditorNode",value:function e(){return this.editorNode}},{key:"getEditorWrapperNode",value:function e(){return this.editorWrapperNode}},{key:"getContainer",value:function e(){return this.targetNode}}]);return e}();var g=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getMap",value:function e(){return{onlyoffice:this.filterCurrentObject(this.handleSavedDocument.bind(this))}}},{key:"handleSavedDocument",value:function e(t){console.log("handleSavedDocument",t);u.ajax.runAction("disk.api.onlyoffice.continueWithNewSession",{mode:"ajax",json:{sessionId:this.context.documentSession.id,documentSessionHash:this.context.documentSession.hash}}).then(function(e){if(e.status==="success"){document.location.href=e.data.documentSession.link}})}}]);return t}(m);var y=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"documentSession",null);babelHelpers.defineProperty(this,"object",null);var n=u.Type.isPlainObject(t)?t:{};this.documentSession=n.documentSession;this.object=n.object;var i=new BX.Loader({target:document.querySelector("#test")});i.show();this.bindEvents()}babelHelpers.createClass(e,[{key:"bindEvents",value:function e(){a.PULL.subscribe(new g({context:{object:this.object,documentSession:this.documentSession},userManager:null}))}}]);return e}();e.OnlyOffice=v;e.Waiting=y})(this.BX.Disk.Editor=this.BX.Disk.Editor||{},BX.Main,BX.UI,BX.Disk,BX.Event,BX.Disk.Sharing,BX.Disk,BX,BX);
//# sourceMappingURL=script.map.js