{"version":3,"file":"script.js","sources":["src/user-manager.js","src/base-command-handler.js","src/client-command-handler.js","src/onlyoffice.js","src/server-command-handler.js","src/waiting.js"],"sourcesContent":["import type {Attempt, Context, User, UserManagerOptions} from \"./types\";\nimport {PULL} from \"pull.client\";\nimport {ajax as Ajax} from \"main.core\";\nimport {Users} from \"disk.users\";\nimport {BaseEvent, EventEmitter} from \"main.core.events\";\n\nconst ALLOWED_ATTEMPTS_TO_GET_USER_INFO = 3;\nconst SECONDS_TO_ACTUALIZE_ONLINE = 25;\n\nexport default class UserManager\n{\n\tuserBoxNode: HTMLElement = null;\n\tcontext: Context = null\n\tusers: Users;\n\tbadAttempts: Map<number>;\n\talreadySaidHi: boolean = false;\n\n\tconstructor(options: UserManagerOptions)\n\t{\n\t\tthis.users = new BX.Disk.Users([]);\n\t\tthis.badAttempts = new Map();\n\t\tthis.context = options.context;\n\t\tthis.userBoxNode = options.userBoxNode;\n\t\tthis.alreadySaidHi = false;\n\t\tthis.add(this.context.currentUser);\n\n\t\tthis.bindEvents();\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('onPullStatus', (event: BaseEvent) => {\n\t\t\tif (event.getData()[0] === 'online')\n\t\t\t{\n\t\t\t\tthis.handleWhenPullConnected();\n\t\t\t}\n\t\t});\n\t}\n\n\thandleWhenPullConnected(): void\n\t{\n\t\tif (!this.sentGreetings())\n\t\t{\n\t\t\tthis.sendHiToUsers();\n\t\t\tsetInterval(this.actualizeOnline.bind(this), 1000*SECONDS_TO_ACTUALIZE_ONLINE);\n\t\t}\n\t}\n\n\tactualizeOnline(): void\n\t{\n\t\tthis.refineUsersByOnline();\n\t\tif (!this.sentGreetings())\n\t\t{\n\t\t\tthis.sendHiToUsers();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.sendPingToUsers();\n\t\t}\n\t}\n\n\tsentGreetings(): boolean\n\t{\n\t\treturn this.alreadySaidHi;\n\t}\n\n\tsendHiToUsers(): void\n\t{\n\t\tif (!PULL.isConnected())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tPULL.sendMessage([-1], 'disk', 'hiToDocument', {\n\t\t\tuser: {\n\t\t\t\tid: this.context.currentUser.id,\n\t\t\t\tname: this.context.currentUser.name,\n\t\t\t\tavatar: this.#makeLinkAbsolute(this.context.currentUser.avatar),\n\t\t\t},\n\t\t});\n\n\t\tthis.alreadySaidHi = true;\n\t}\n\n\t#makeLinkAbsolute(link: string): string\n\t{\n\t\tif (link.includes('http://') || link.includes('https://'))\n\t\t{\n\t\t\treturn link;\n\t\t}\n\n\t\treturn document.location.origin + link;\n\t}\n\n\tsendWelcomeToUser(): void\n\t{\n\t\tif (!PULL.isConnected())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tPULL.sendMessage([-1], 'disk', 'welcomeToDocument', {\n\t\t\tuser: {\n\t\t\t\tid: this.context.currentUser.id,\n\t\t\t\tname: this.context.currentUser.name,\n\t\t\t\tavatar: this.#makeLinkAbsolute(this.context.currentUser.avatar),\n\t\t\t},\n\t\t});\n\t}\n\n\tsendPingToUsers(): void\n\t{\n\t\tif (!PULL.isConnected())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tPULL.sendMessage([-1], 'disk', 'pingDocument', {\n\t\t\tfromUserId: this.context.currentUser.id,\n\t\t\tinfoToken: this.context.currentUser.infoToken,\n\t\t});\n\t}\n\n\tadd(user: User): void\n\t{\n\t\tif (!this.users.hasUser(user.id))\n\t\t{\n\t\t\tthis.users.addUser(user);\n\n\t\t\tconsole.log('Hi new user!', user.id);\n\t\t}\n\n\t\tthis.updateOnline(user.id);\n\t\tthis.renderBox();\n\t}\n\n\tupdateOnline(userId: number): void\n\t{\n\t\tif (this.users.hasUser(userId))\n\t\t{\n\t\t\tthis.users.getUser(userId).onlineAt = Date.now();\n\t\t}\n\t}\n\n\tgetUserInfo(userId: number, infoToken: string): Promise\n\t{\n\t\tif (this.badAttempts.get(userId) >= ALLOWED_ATTEMPTS_TO_GET_USER_INFO)\n\t\t{\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\treject({\n\t\t\t\t\tstatus: 'blocked',\n\t\t\t\t})\n\t\t\t});\n\t\t}\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tAjax.runComponentAction('bitrix:disk.file.editor-onlyoffice', 'getUserInfo', {\n\t\t\t\tmode: 'ajax',\n\t\t\t\tjson: {\n\t\t\t\t\tdocumentSessionId: this.context.documentSession.id,\n\t\t\t\t\tdocumentSessionHash: this.context.documentSession.hash,\n\t\t\t\t\tuserId: userId,\n\t\t\t\t\tinfoToken: infoToken,\n\t\t\t\t}\n\t\t\t}).then((response) => {\n\t\t\t\tif (response.status === 'success')\n\t\t\t\t{\n\t\t\t\t\tthis.badAttempts.delete(userId);\n\t\t\t\t\tresolve(response.data.user);\n\t\t\t\t}\n\t\t\t}, (response) => {\n\t\t\t\tconst attempts = this.badAttempts.get(userId) || 0;\n\t\t\t\tthis.badAttempts.set(userId, attempts + 1);\n\t\t\t\tconsole.log(this.badAttempts)\n\n\t\t\t\treject(response);\n\t\t\t});\n\t\t});\n\t}\n\n\thas(userId: number): boolean\n\t{\n\t\treturn this.users.hasUser(userId);\n\t}\n\n\tremove(userId: number): void\n\t{\n\t\tif (userId === this.context.currentUser.id)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.users.deleteUser(userId);\n\t\tthis.renderBox();\n\t}\n\n\trefineUsersByOnline(): void\n\t{\n\t\tconst secondsToOffline = 1000*(SECONDS_TO_ACTUALIZE_ONLINE+1)*2;\n\t\tconst now = Date.now();\n\n\t\tthis.users.forEach((user: User) => {\n\t\t\tif (now - user.onlineAt > secondsToOffline)\n\t\t\t{\n\t\t\t\tthis.remove(user.id);\n\t\t\t}\n\t\t})\n\t}\n\n\trenderBox(): void\n\t{\n\t\tif (!this.userBoxNode.childElementCount)\n\t\t{\n\t\t\tthis.userBoxNode.appendChild(this.users.getContainer());\n\t\t}\n\t}\n};","import {PullClient} from \"pull.client\";\nimport type {CommandOptions} from \"./types\";\nimport UserManager from \"./user-manager\";\n\nexport default class BaseCommandHandler\n{\n\toptions: CommandOptions = null;\n\tuserManager: UserManager = null;\n\n\tconstructor(commandOptions: CommandOptions)\n\t{\n\t\tthis.options = commandOptions;\n\t\tthis.userManager = commandOptions.userManager;\n\t\tthis.context = commandOptions.context;\n\t}\n\n\tgetModuleId(): string\n\t{\n\t\treturn 'disk';\n\t}\n\n\tgetSubscriptionType(): string\n\t{\n\t\treturn PullClient.SubscriptionType.Server;\n\t}\n\n\tfilterCurrentObject(handler: Function): any\n\t{\n\t\treturn (data) => {\n\t\t\tif (this.context.object.id !== data.object.id)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\treturn handler(data);\n\t\t};\n\t}\n\n\tisCurrentUser(userId: number): boolean\n\t{\n\t\treturn this.context.currentUser.id === userId;\n\t}\n}","import BaseCommandHandler from \"./base-command-handler\";\nimport {PullClient} from \"pull.client\";\nimport type {ExitDocumentMessage, HiDocumentMessage, PingDocumentMessage, WelcomeDocumentMessage} from \"./types\";\n\nexport default class ClientCommandHandler extends BaseCommandHandler\n{\n\tgetSubscriptionType(): string\n\t{\n\t\treturn PullClient.SubscriptionType.Client;\n\t}\n\n\tgetMap(): Object\n\t{\n\t\treturn {\n\t\t\texitDocument: this.handleExitDocument.bind(this),\n\t\t\tpingDocument: this.handlePingDocument.bind(this),\n\t\t\thiToDocument: this.handleHiToDocument.bind(this),\n\t\t\twelcomeToDocument: this.handleWelcomeToDocument.bind(this),\n\t\t};\n\t}\n\n\thandleExitDocument(data: ExitDocumentMessage): void\n\t{\n\t\tconsole.log('exitDocument', data);\n\n\t\tconst fromUserId = data.fromUserId;\n\t\tif (!this.isCurrentUser(fromUserId))\n\t\t{\n\t\t\tthis.userManager.remove(fromUserId);\n\t\t}\n\t}\n\n\thandleWelcomeToDocument(data: WelcomeDocumentMessage): void\n\t{\n\t\tconsole.log('handleWelcomeToDocument', data);\n\n\t\tthis.processNewbieInDocument(data);\n\t}\n\n\thandleHiToDocument(data: HiDocumentMessage): void\n\t{\n\t\tconsole.log('handleHiToDocument', data);\n\n\t\tconst newbieAdded = this.processNewbieInDocument(data);\n\t\tif (newbieAdded)\n\t\t{\n\t\t\t//immediately send welcome to add actual online information for new user.\n\t\t\tthis.userManager.sendWelcomeToUser();\n\t\t}\n\t}\n\n\tprocessNewbieInDocument(data: HiDocumentMessage|WelcomeDocumentMessage): boolean\n\t{\n\t\tconst fromUserId = data.user.id;\n\t\tif (this.isCurrentUser(fromUserId))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.userManager.has(fromUserId))\n\t\t{\n\t\t\tthis.userManager.updateOnline(fromUserId);\n\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.userManager.add(data.user);\n\n\t\treturn true;\n\t}\n\n\thandlePingDocument(data: PingDocumentMessage): void\n\t{\n\t\tconsole.log('handlePingDocument', data);\n\n\t\tconst fromUserId = data.fromUserId;\n\t\tif (this.isCurrentUser(fromUserId))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.userManager.has(fromUserId))\n\t\t{\n\t\t\tthis.userManager.updateOnline(fromUserId);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif (this.userManager.sentGreetings())\n\t\t\t{\n\t\t\t\tthis.userManager.getUserInfo(data.fromUserId, data.infoToken).then(userData => {\n\t\t\t\t\tthis.userManager.add(userData);\n\t\t\t\t}, () => {});\n\t\t\t}\n\t\t}\n\t}\n}","import {ajax as Ajax, Runtime, Type} from \"main.core\";\nimport { EventEmitter } from \"main.core.events\";\nimport { MenuItem } from 'main.popup';\nimport {PULL, PullClient} from \"pull.client\";\nimport type {EditorOptions, DocumentSession, Context, BaseObject} from \"./types\";\nimport {ButtonManager, Button, SplitButton, SaveButton, CloseButton} from \"ui.buttons\";\nimport ClientCommandHandler from \"./client-command-handler\";\nimport UserManager from \"./user-manager\";\nimport {LegacyPopup, SharingControlType} from \"disk.sharing-legacy-popup\";\nimport {ExternalLink} from 'disk.external-link';\n\nexport default class OnlyOffice\n{\n\teditor: any = null;\n\teditorJson: any = null;\n\tuserBoxNode: HTMLElement = null;\n\teditorNode: HTMLElement = null;\n\teditorWrapperNode: HTMLElement = null;\n\ttargetNode: HTMLElement = null;\n\tdocumentSession: DocumentSession = null;\n\tlinkToEdit: string = null;\n\tpullConfig: any = null;\n\teditButton: SplitButton = null;\n\tsetupSharingButton: Button = null;\n\tdocumentWasChanged: boolean = false;\n\tdontEndCurrentDocumentSession: boolean = false;\n\tcontext: Context = null;\n\tusersInDocument: UserManager = null;\n\tsharingControlType: ?SharingControlType = null;\n\n\tconstructor(editorOptions: EditorOptions)\n\t{\n\t\tconst options = Type.isPlainObject(editorOptions) ? editorOptions : {};\n\n\t\tthis.pullConfig = options.pullConfig;\n\t\tthis.documentSession = options.documentSession;\n\t\tthis.linkToEdit = options.linkToEdit;\n\t\tthis.targetNode = options.targetNode;\n\t\tthis.userBoxNode = options.userBoxNode;\n\t\tthis.editorNode = options.editorNode;\n\t\tthis.editorWrapperNode = options.editorWrapperNode;\n\t\tthis.editButton = ButtonManager.createByUniqId(editorOptions.panelButtonUniqIds.edit);\n\t\tthis.setupSharingButton = ButtonManager.createByUniqId(editorOptions.panelButtonUniqIds.setupSharing);\n\t\tthis.sharingControlType = editorOptions.sharingControlType;\n\t\tthis.context = {\n\t\t\tcurrentUser: options.currentUser,\n\t\t\tdocumentSession: this.documentSession,\n\t\t\tobject: options.object,\n\t\t\tattachedObject: options.attachedObject,\n\t\t};\n\t\tthis.usersInDocument = new UserManager({\n\t\t\tcontext: this.context,\n\t\t\tuserBoxNode: this.userBoxNode,\n\t\t});\n\n\t\tthis.sendTelemetryEvent('load');\n\t\tthis.initializeEditor(options.editorJson);\n\n\t\tconst currentSlider = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tif (currentSlider)\n\t\t{\n\t\t\tcurrentSlider.getData().set('documentSession', this.documentSession);\n\t\t\tthis.loadDiskExtensionInTopWindow();\n\t\t}\n\n\t\tthis.initPull();\n\t\tthis.bindEvents();\n\t}\n\n\tinitPull(): void\n\t{\n\t\tif (this.pullConfig)\n\t\t{\n\t\t\tBX.PULL = new PullClient({\n\t\t\t\tskipStorageInit: true\n\t\t\t});\n\t\t\tBX.PULL.start(this.pullConfig);\n\t\t}\n\t}\n\n\tsendTelemetryEvent(action, data): void\n\t{\n\t\tdata = data || {};\n\n\t\tconst currentSlider = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tif (!currentSlider)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst currentSliderData = currentSlider.getData();\n\t\tdata.action = action;\n\t\tdata.uid = currentSliderData.get('uid');\n\t\tdata.documentSessionId = this.context.documentSession.id;\n\n\t\tBX.Disk.sendTelemetryEvent(data);\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tEventEmitter.subscribe(\"SidePanel.Slider:onClose\", this.handleClose.bind(this));\n\t\twindow.addEventListener(\"beforeunload\", this.handleClose.bind(this));\n\n\t\tif (this.editorJson.document.permissions.edit === true && this.editButton)\n\t\t{\n\t\t\tif (this.editButton.hasOwnProperty('mainButton'))\n\t\t\t{\n\t\t\t\tthis.editButton.getMainButton().bindEvent('click', this.handleClickEditButton.bind(this));\n\n\t\t\t\tlet menuWindow = this.editButton.getMenuWindow();\n\t\t\t\tlet menuItems = Runtime.clone(menuWindow.getMenuItems());\n\n\t\t\t\tfor (let i = 0; i < menuItems.length; i++)\n\t\t\t\t{\n\t\t\t\t\tlet menuItem = menuItems[i];\n\t\t\t\t\tlet menuItemOptions = Runtime.clone(menuItem.options);\n\t\t\t\t\tmenuItemOptions.onclick = this.handleClickEditSubItems.bind(this);\n\n\t\t\t\t\tmenuWindow.removeMenuItem(menuItem.getId());\n\t\t\t\t\tmenuWindow.addMenuItem(menuItemOptions);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.editButton.bindEvent('click', this.handleClickEditButton.bind(this));\n\t\t\t}\n\t\t}\n\t\tif (this.setupSharingButton)\n\t\t{\n\t\t\tlet menuWindow = this.setupSharingButton.getMenuWindow();\n\t\t\tlet extLinkOptions = menuWindow.getMenuItem('ext-link').options;\n\t\t\textLinkOptions.onclick = this.handleClickSharingByExternalLink.bind(this);\n\n\t\t\tmenuWindow.removeMenuItem('ext-link');\n\t\t\tmenuWindow.addMenuItem(extLinkOptions);\n\n\t\t\tlet sharingOptions = menuWindow.getMenuItem('sharing').options;\n\t\t\tsharingOptions.onclick = this.handleClickSharing.bind(this);\n\n\t\t\tmenuWindow.removeMenuItem('sharing');\n\t\t\tmenuWindow.addMenuItem(sharingOptions);\n\t\t}\n\n\t\tPULL.subscribe(new ClientCommandHandler({\n\t\t\tcontext: this.context,\n\t\t\tuserManager: this.usersInDocument,\n\t\t}));\n\t}\n\n\tinitializeEditor(options): void\n\t{\n\t\tthis.adjustEditorHeight(options);\n\t\toptions.events = {\n\t\t\tonDocumentStateChange: this.handleDocumentStateChange.bind(this),\n\t\t\tonDocumentReady: this.handleDocumentReady.bind(this),\n\t\t\tonMetaChange: this.handleMetaChange.bind(this),\n\t\t\tonInfo: this.handleInfo.bind(this),\n\t\t\t// onRequestClose: this.handleClose.bind(this),\n\t\t}\n\n\t\tif (options.document.permissions.rename)\n\t\t{\n\t\t\toptions.events.onRequestRename = this.handleRequestRename.bind(this);\n\t\t}\n\n\t\tthis.editorJson = options;\n\t\tthis.editor = new DocsAPI.DocEditor(this.editorNode.id, options);\n\t}\n\n\tadjustEditorHeight(options): void\n\t{\n\t\toptions.height = (document.body.clientHeight - 70) + 'px';\n\t}\n\n\tloadDiskExtensionInTopWindow(): void\n\t{\n\t\tif (window.top !== window && !BX.getClass('window.top.BX.Disk.endEditSession'))\n\t\t{\n\t\t\ttop.BX.loadExt('disk');\n\t\t}\n\t}\n\n\temitEventOnSaved(): void\n\t{\n\t\tconst sliderByWindow = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tif (sliderByWindow)\n\t\t{\n\t\t\tBX.SidePanel.Instance.postMessageAll(window, 'Disk.OnlyOffice:onSaved', {\n\t\t\t\tdocumentSession: this.documentSession,\n\t\t\t\tobject: this.context.object,\n\t\t\t});\n\t\t}\n\n\t\tEventEmitter.emit('Disk.OnlyOffice:onSaved', {\n\t\t\tdocumentSession: this.documentSession,\n\t\t\tobject: this.context.object,\n\t\t});\n\t}\n\n\temitEventOnClosed(): void\n\t{\n\t\tconst sliderByWindow = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tlet process = 'edit';\n\t\tif (sliderByWindow)\n\t\t{\n\t\t\tprocess = sliderByWindow.getData().get('process') || 'edit';\n\n\t\t\tBX.SidePanel.Instance.postMessageAll(window, 'Disk.OnlyOffice:onClosed', {\n\t\t\t\tdocumentSession: this.documentSession,\n\t\t\t\tobject: this.context.object,\n\t\t\t\tprocess: process,\n\t\t\t});\n\t\t}\n\n\t\tEventEmitter.emit('Disk.OnlyOffice:onClosed', {\n\t\t\tdocumentSession: this.documentSession,\n\t\t\tobject: this.context.object,\n\t\t\tprocess: process,\n\t\t});\n\t}\n\n\thandleClickEditButton(): void\n\t{\n\t\tthis.handleRequestEditRights();\n\t}\n\n\thandleClickSharing(): void\n\t{\n\t\tswitch (this.sharingControlType)\n\t\t{\n\t\t\tcase SharingControlType.WITH_CHANGE_RIGHTS:\n\t\t\t\t(new LegacyPopup()).showSharingDetailWithChangeRights({\n\t\t\t\t\tobject: this.context.object\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\tcase SharingControlType.WITH_SHARING:\n\t\t\t\t(new LegacyPopup()).showSharingDetailWithChangeRights({\n\t\t\t\t\tobject: this.context.object\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\tcase SharingControlType.WITHOUT_EDIT:\n\t\t\t\t(new LegacyPopup()).showSharingDetailWithoutEdit({\n\t\t\t\t\tobject: this.context.object\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\thandleClickSharingByExternalLink(): void\n\t{\n\t\tExternalLink.showPopup(this.context.object.id);\n\t}\n\n\thandleClickEditSubItems(event, menuItem: MenuItem): void\n\t{\n\t\tlet serviceCode = menuItem.getId();\n\t\tif(serviceCode === 'onlyoffice')\n\t\t{\n\t\t\tthis.handleClickEditButton();\n\n\t\t\treturn;\n\t\t}\n\n\t\tBX.Disk.Viewer.Actions.runActionEdit({\n\t\t\tobjectId: this.context.object.id,\n\t\t\tattachedObjectId: this.context.attachedObject.id,\n\t\t\tserviceCode: serviceCode,\n\t\t});\n\t}\n\n\thandleSaveButtonClick(): void\n\t{\n\t\tPULL.subscribe({\n\t\t\tmoduleId: 'disk',\n\t\t\tcommand: 'onlyoffice',\n\t\t\tcallback: (data) => {\n\t\t\t\tif (data.hash === this.documentSession.hash)\n\t\t\t\t{\n\t\t\t\t\tthis.emitEventOnSaved();\n\n\t\t\t\t\twindow.BX.Disk.showModalWithStatusAction();\n\t\t\t\t\tBX.SidePanel.Instance.close();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\thandleClose(): void\n\t{\n\t\tPULL.sendMessage([-1], 'disk', 'exitDocument', {\n\t\t\tfromUserId: this.context.currentUser.id,\n\t\t});\n\n\t\tthis.sendTelemetryEvent('exit');\n\n\t\tthis.emitEventOnClosed();\n\n\t\tif (this.dontEndCurrentDocumentSession)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\ttop.BX.Disk.endEditSession({\n\t\t\tid: this.documentSession.id,\n\t\t\thash: this.documentSession.hash,\n\t\t\tdocumentWasChanged: this.documentWasChanged,\n\t\t});\n\t}\n\n\thandleDocumentStateChange(event): void\n\t{\n\t\tif (!this.caughtDocumentReady || !this.caughtInfoEvent)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (Date.now() - Math.max(this.caughtDocumentReady, this.caughtInfoEvent) < 500)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.documentWasChanged = true;\n\t}\n\n\thandleInfo(): void\n\t{\n\t\tthis.caughtInfoEvent = Date.now();\n\t}\n\n\thandleRequestRename(event): void\n\t{\n\t\tconst newName = event.data;\n\t\tAjax.runAction('disk.api.onlyoffice.renameDocument', {\n\t\t\tmode: 'ajax',\n\t\t\tjson: {\n\t\t\t\tdocumentSessionId: this.context.documentSession.id,\n\t\t\t\tdocumentSessionHash: this.context.documentSession.hash,\n\t\t\t\tnewName: newName,\n\t\t\t}\n\t\t});\n\t}\n\n\thandleMetaChange(event): void\n\t{\n\t}\n\n\thandleDocumentReady(): void\n\t{\n\t\tthis.sendTelemetryEvent('ready');\n\n\t\tthis.caughtDocumentReady = Date.now();\n\t}\n\n\thandleRequestEditRights(): void\n\t{\n\t\tthis.dontEndCurrentDocumentSession = true;\n\n\t\tlet linkToEdit = BX.util.add_url_param(\n\t\t\t'/bitrix/services/main/ajax.php',\n\t\t\t{\n\t\t\t\taction: 'disk.api.documentService.goToEdit',\n\t\t\t\tserviceCode: 'onlyoffice',\n\t\t\t\tdocumentSessionId: this.documentSession.id,\n\t\t\t\tdocumentSessionHash: this.documentSession.hash,\n\t\t\t}\n\t\t);\n\n\t\tif (this.linkToEdit)\n\t\t{\n\t\t\tlinkToEdit = this.linkToEdit;\n\t\t}\n\n\t\tconst currentSlider = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tif (!currentSlider)\n\t\t{\n\t\t\twindow.location = linkToEdit;\n\n\t\t\treturn;\n\t\t}\n\n\t\tlet customLeftBoundary = currentSlider.getCustomLeftBoundary();\n\t\tcurrentSlider.close();\n\n\t\tBX.SidePanel.Instance.open(\n\t\t\tlinkToEdit, {\n\t\t\twidth: '100%',\n\t\t\tcustomLeftBoundary: customLeftBoundary,\n\t\t\tcacheable: false,\n\t\t\tallowChangeHistory: false,\n\t\t\tdata: {\n\t\t\t\tdocumentEditor: true\n\t\t\t}\n\t\t});\n\t}\n\n\tgetEditor()\n\t{\n\t\treturn this.editor;\n\t}\n\n\tgetEditorNode(): HTMLElement\n\t{\n\t\treturn this.editorNode;\n\t}\n\n\tgetEditorWrapperNode(): HTMLElement\n\t{\n\t\treturn this.editorWrapperNode;\n\t}\n\n\tgetContainer(): HTMLElement\n\t{\n\t\treturn this.targetNode;\n\t}\n}\n","import BaseCommandHandler from \"./base-command-handler\";\nimport {ajax as Ajax} from \"main.core\";\n\nexport default class ServerCommandHandler extends BaseCommandHandler\n{\n\tgetMap(): Object\n\t{\n\t\treturn {\n\t\t\tonlyoffice: this.filterCurrentObject(this.handleSavedDocument.bind(this)),\n\t\t};\n\t}\n\n\thandleSavedDocument(data): void\n\t{\n\t\tconsole.log('handleSavedDocument', data);\n\n\t\tAjax.runAction('disk.api.onlyoffice.continueWithNewSession', {\n\t\t\tmode: 'ajax',\n\t\t\tjson: {\n\t\t\t\tsessionId: this.context.documentSession.id,\n\t\t\t\tdocumentSessionHash: this.context.documentSession.hash,\n\t\t\t}\n\t\t}).then((response) => {\n\t\t\tif (response.status === 'success')\n\t\t\t{\n\t\t\t\tdocument.location.href = response.data.documentSession.link;\n\t\t\t}\n\t\t});\n\t}\n}","import {Type} from \"main.core\";\nimport {PULL} from \"pull.client\";\nimport type {EditorOptions, DocumentSession, BaseObject} from \"./types\";\nimport ServerCommandHandler from \"./server-command-handler\";\n\nexport default class Waiting\n{\n\tdocumentSession: DocumentSession = null;\n\tobject: BaseObject = null;\n\n\tconstructor(editorOptions: EditorOptions)\n\t{\n\t\tconst options = Type.isPlainObject(editorOptions) ? editorOptions : {};\n\n\t\tthis.documentSession = options.documentSession;\n\t\tthis.object = options.object;\n\n\t\tconst loader = new BX.Loader({\n\t\t\ttarget: document.querySelector('#test'),\n\t\t});\n\t\tloader.show();\n\n\t\tthis.bindEvents();\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tPULL.subscribe(new ServerCommandHandler({\n\t\t\tcontext: {\n\t\t\t\tobject: this.object,\n\t\t\t\tdocumentSession: this.documentSession,\n\t\t\t},\n\t\t\tuserManager: null,\n\t\t}));\n\t}\n}"],"names":["ALLOWED_ATTEMPTS_TO_GET_USER_INFO","SECONDS_TO_ACTUALIZE_ONLINE","UserManager","options","users","BX","Disk","Users","badAttempts","Map","context","userBoxNode","alreadySaidHi","add","currentUser","bindEvents","EventEmitter","subscribe","event","getData","handleWhenPullConnected","sentGreetings","sendHiToUsers","setInterval","actualizeOnline","bind","refineUsersByOnline","sendPingToUsers","PULL","isConnected","sendMessage","user","id","name","avatar","fromUserId","infoToken","hasUser","addUser","console","log","updateOnline","renderBox","userId","getUser","onlineAt","Date","now","get","Promise","resolve","reject","status","Ajax","runComponentAction","mode","json","documentSessionId","documentSession","documentSessionHash","hash","then","response","delete","data","attempts","set","deleteUser","secondsToOffline","forEach","remove","childElementCount","appendChild","getContainer","link","includes","document","location","origin","BaseCommandHandler","commandOptions","userManager","PullClient","SubscriptionType","Server","handler","object","ClientCommandHandler","Client","exitDocument","handleExitDocument","pingDocument","handlePingDocument","hiToDocument","handleHiToDocument","welcomeToDocument","handleWelcomeToDocument","isCurrentUser","processNewbieInDocument","newbieAdded","sendWelcomeToUser","has","getUserInfo","userData","OnlyOffice","editorOptions","Type","isPlainObject","pullConfig","linkToEdit","targetNode","editorNode","editorWrapperNode","editButton","ButtonManager","createByUniqId","panelButtonUniqIds","edit","setupSharingButton","setupSharing","sharingControlType","attachedObject","usersInDocument","sendTelemetryEvent","initializeEditor","editorJson","currentSlider","SidePanel","Instance","getSliderByWindow","window","loadDiskExtensionInTopWindow","initPull","skipStorageInit","start","action","currentSliderData","uid","handleClose","addEventListener","permissions","hasOwnProperty","getMainButton","bindEvent","handleClickEditButton","menuWindow","getMenuWindow","menuItems","Runtime","clone","getMenuItems","i","length","menuItem","menuItemOptions","onclick","handleClickEditSubItems","removeMenuItem","getId","addMenuItem","extLinkOptions","getMenuItem","handleClickSharingByExternalLink","sharingOptions","handleClickSharing","adjustEditorHeight","events","onDocumentStateChange","handleDocumentStateChange","onDocumentReady","handleDocumentReady","onMetaChange","handleMetaChange","onInfo","handleInfo","rename","onRequestRename","handleRequestRename","editor","DocsAPI","DocEditor","height","body","clientHeight","top","getClass","loadExt","sliderByWindow","postMessageAll","emit","process","handleRequestEditRights","SharingControlType","WITH_CHANGE_RIGHTS","LegacyPopup","showSharingDetailWithChangeRights","WITH_SHARING","WITHOUT_EDIT","showSharingDetailWithoutEdit","ExternalLink","showPopup","serviceCode","Viewer","Actions","runActionEdit","objectId","attachedObjectId","moduleId","command","callback","emitEventOnSaved","showModalWithStatusAction","close","emitEventOnClosed","dontEndCurrentDocumentSession","endEditSession","documentWasChanged","caughtDocumentReady","caughtInfoEvent","Math","max","newName","runAction","util","add_url_param","customLeftBoundary","getCustomLeftBoundary","open","width","cacheable","allowChangeHistory","documentEditor","ServerCommandHandler","onlyoffice","filterCurrentObject","handleSavedDocument","sessionId","href","Waiting","loader","Loader","target","querySelector","show"],"mappings":";;;;;;CAMA,IAAMA,iCAAiC,GAAG,CAA1C;CACA,IAAMC,2BAA2B,GAAG,EAApC;;;;KAEqBC;CAQpB,uBAAYC,OAAZ,EACA;CAAA;;CAAA;;CAAA,qDAP2B,IAO3B;CAAA,iDANmB,IAMnB;CAAA,uDAHyB,KAGzB;CACC,SAAKC,KAAL,GAAa,IAAIC,EAAE,CAACC,IAAH,CAAQC,KAAZ,CAAkB,EAAlB,CAAb;CACA,SAAKC,WAAL,GAAmB,IAAIC,GAAJ,EAAnB;CACA,SAAKC,OAAL,GAAeP,OAAO,CAACO,OAAvB;CACA,SAAKC,WAAL,GAAmBR,OAAO,CAACQ,WAA3B;CACA,SAAKC,aAAL,GAAqB,KAArB;CACA,SAAKC,GAAL,CAAS,KAAKH,OAAL,CAAaI,WAAtB;CAEA,SAAKC,UAAL;CACA;;;;kCAGD;CAAA;;CACCC,MAAAA,6BAAY,CAACC,SAAb,CAAuB,cAAvB,EAAuC,UAACC,KAAD,EAAsB;CAC5D,YAAIA,KAAK,CAACC,OAAN,GAAgB,CAAhB,MAAuB,QAA3B,EACA;CACC,UAAA,KAAI,CAACC,uBAAL;CACA;CACD,OALD;CAMA;;;+CAGD;CACC,UAAI,CAAC,KAAKC,aAAL,EAAL,EACA;CACC,aAAKC,aAAL;CACAC,QAAAA,WAAW,CAAC,KAAKC,eAAL,CAAqBC,IAArB,CAA0B,IAA1B,CAAD,EAAkC,OAAKxB,2BAAvC,CAAX;CACA;CACD;;;uCAGD;CACC,WAAKyB,mBAAL;;CACA,UAAI,CAAC,KAAKL,aAAL,EAAL,EACA;CACC,aAAKC,aAAL;CACA,OAHD,MAKA;CACC,aAAKK,eAAL;CACA;CACD;;;qCAGD;CACC,aAAO,KAAKf,aAAZ;CACA;;;qCAGD;CACC,UAAI,CAACgB,gBAAI,CAACC,WAAL,EAAL,EACA;CACC;CACA;;CAEDD,MAAAA,gBAAI,CAACE,WAAL,CAAiB,CAAC,CAAC,CAAF,CAAjB,EAAuB,MAAvB,EAA+B,cAA/B,EAA+C;CAC9CC,QAAAA,IAAI,EAAE;CACLC,UAAAA,EAAE,EAAE,KAAKtB,OAAL,CAAaI,WAAb,CAAyBkB,EADxB;CAELC,UAAAA,IAAI,EAAE,KAAKvB,OAAL,CAAaI,WAAb,CAAyBmB,IAF1B;CAGLC,UAAAA,MAAM,yBAAE,IAAF,8CAAE,IAAF,EAAyB,KAAKxB,OAAL,CAAaI,WAAb,CAAyBoB,MAAlD;CAHD;CADwC,OAA/C;CAQA,WAAKtB,aAAL,GAAqB,IAArB;CACA;;;yCAaD;CACC,UAAI,CAACgB,gBAAI,CAACC,WAAL,EAAL,EACA;CACC;CACA;;CAEDD,MAAAA,gBAAI,CAACE,WAAL,CAAiB,CAAC,CAAC,CAAF,CAAjB,EAAuB,MAAvB,EAA+B,mBAA/B,EAAoD;CACnDC,QAAAA,IAAI,EAAE;CACLC,UAAAA,EAAE,EAAE,KAAKtB,OAAL,CAAaI,WAAb,CAAyBkB,EADxB;CAELC,UAAAA,IAAI,EAAE,KAAKvB,OAAL,CAAaI,WAAb,CAAyBmB,IAF1B;CAGLC,UAAAA,MAAM,yBAAE,IAAF,8CAAE,IAAF,EAAyB,KAAKxB,OAAL,CAAaI,WAAb,CAAyBoB,MAAlD;CAHD;CAD6C,OAApD;CAOA;;;uCAGD;CACC,UAAI,CAACN,gBAAI,CAACC,WAAL,EAAL,EACA;CACC;CACA;;CAEDD,MAAAA,gBAAI,CAACE,WAAL,CAAiB,CAAC,CAAC,CAAF,CAAjB,EAAuB,MAAvB,EAA+B,cAA/B,EAA+C;CAC9CK,QAAAA,UAAU,EAAE,KAAKzB,OAAL,CAAaI,WAAb,CAAyBkB,EADS;CAE9CI,QAAAA,SAAS,EAAE,KAAK1B,OAAL,CAAaI,WAAb,CAAyBsB;CAFU,OAA/C;CAIA;;;yBAEGL,MACJ;CACC,UAAI,CAAC,KAAK3B,KAAL,CAAWiC,OAAX,CAAmBN,IAAI,CAACC,EAAxB,CAAL,EACA;CACC,aAAK5B,KAAL,CAAWkC,OAAX,CAAmBP,IAAnB;CAEAQ,QAAAA,OAAO,CAACC,GAAR,CAAY,cAAZ,EAA4BT,IAAI,CAACC,EAAjC;CACA;;CAED,WAAKS,YAAL,CAAkBV,IAAI,CAACC,EAAvB;CACA,WAAKU,SAAL;CACA;;;kCAEYC,QACb;CACC,UAAI,KAAKvC,KAAL,CAAWiC,OAAX,CAAmBM,MAAnB,CAAJ,EACA;CACC,aAAKvC,KAAL,CAAWwC,OAAX,CAAmBD,MAAnB,EAA2BE,QAA3B,GAAsCC,IAAI,CAACC,GAAL,EAAtC;CACA;CACD;;;iCAEWJ,QAAgBP,WAC5B;CAAA;;CACC,UAAI,KAAK5B,WAAL,CAAiBwC,GAAjB,CAAqBL,MAArB,KAAgC3C,iCAApC,EACA;CACC,eAAO,IAAIiD,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;CACvCA,UAAAA,MAAM,CAAC;CACNC,YAAAA,MAAM,EAAE;CADF,WAAD,CAAN;CAGA,SAJM,CAAP;CAKA;;CAED,aAAO,IAAIH,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;CACvCE,QAAAA,cAAI,CAACC,kBAAL,CAAwB,oCAAxB,EAA8D,aAA9D,EAA6E;CAC5EC,UAAAA,IAAI,EAAE,MADsE;CAE5EC,UAAAA,IAAI,EAAE;CACLC,YAAAA,iBAAiB,EAAE,MAAI,CAAC/C,OAAL,CAAagD,eAAb,CAA6B1B,EAD3C;CAEL2B,YAAAA,mBAAmB,EAAE,MAAI,CAACjD,OAAL,CAAagD,eAAb,CAA6BE,IAF7C;CAGLjB,YAAAA,MAAM,EAAEA,MAHH;CAILP,YAAAA,SAAS,EAAEA;CAJN;CAFsE,SAA7E,EAQGyB,IARH,CAQQ,UAACC,QAAD,EAAc;CACrB,cAAIA,QAAQ,CAACV,MAAT,KAAoB,SAAxB,EACA;CACC,YAAA,MAAI,CAAC5C,WAAL,CAAiBuD,MAAjB,CAAwBpB,MAAxB;;CACAO,YAAAA,OAAO,CAACY,QAAQ,CAACE,IAAT,CAAcjC,IAAf,CAAP;CACA;CACD,SAdD,EAcG,UAAC+B,QAAD,EAAc;CAChB,cAAMG,QAAQ,GAAG,MAAI,CAACzD,WAAL,CAAiBwC,GAAjB,CAAqBL,MAArB,KAAgC,CAAjD;;CACA,UAAA,MAAI,CAACnC,WAAL,CAAiB0D,GAAjB,CAAqBvB,MAArB,EAA6BsB,QAAQ,GAAG,CAAxC;;CACA1B,UAAAA,OAAO,CAACC,GAAR,CAAY,MAAI,CAAChC,WAAjB;CAEA2C,UAAAA,MAAM,CAACW,QAAD,CAAN;CACA,SApBD;CAqBA,OAtBM,CAAP;CAuBA;;;yBAEGnB,QACJ;CACC,aAAO,KAAKvC,KAAL,CAAWiC,OAAX,CAAmBM,MAAnB,CAAP;CACA;;;4BAEMA,QACP;CACC,UAAIA,MAAM,KAAK,KAAKjC,OAAL,CAAaI,WAAb,CAAyBkB,EAAxC,EACA;CACC;CACA;;CAED,WAAK5B,KAAL,CAAW+D,UAAX,CAAsBxB,MAAtB;CACA,WAAKD,SAAL;CACA;;;2CAGD;CAAA;;CACC,UAAM0B,gBAAgB,GAAG,QAAMnE,2BAA2B,GAAC,CAAlC,IAAqC,CAA9D;CACA,UAAM8C,GAAG,GAAGD,IAAI,CAACC,GAAL,EAAZ;CAEA,WAAK3C,KAAL,CAAWiE,OAAX,CAAmB,UAACtC,IAAD,EAAgB;CAClC,YAAIgB,GAAG,GAAGhB,IAAI,CAACc,QAAX,GAAsBuB,gBAA1B,EACA;CACC,UAAA,MAAI,CAACE,MAAL,CAAYvC,IAAI,CAACC,EAAjB;CACA;CACD,OALD;CAMA;;;iCAGD;CACC,UAAI,CAAC,KAAKrB,WAAL,CAAiB4D,iBAAtB,EACA;CACC,aAAK5D,WAAL,CAAiB6D,WAAjB,CAA6B,KAAKpE,KAAL,CAAWqE,YAAX,EAA7B;CACA;CACD;;;;;sDAnIiBC,MAClB;CACC,MAAIA,IAAI,CAACC,QAAL,CAAc,SAAd,KAA4BD,IAAI,CAACC,QAAL,CAAc,UAAd,CAAhC,EACA;CACC,WAAOD,IAAP;CACA;;CAED,SAAOE,QAAQ,CAACC,QAAT,CAAkBC,MAAlB,GAA2BJ,IAAlC;CACA;;KCxFmBK;CAKpB,8BAAYC,cAAZ,EACA;CAAA;CAAA,iDAJ0B,IAI1B;CAAA,qDAH2B,IAG3B;CACC,SAAK7E,OAAL,GAAe6E,cAAf;CACA,SAAKC,WAAL,GAAmBD,cAAc,CAACC,WAAlC;CACA,SAAKvE,OAAL,GAAesE,cAAc,CAACtE,OAA9B;CACA;;;;mCAGD;CACC,aAAO,MAAP;CACA;;;2CAGD;CACC,aAAOwE,sBAAU,CAACC,gBAAX,CAA4BC,MAAnC;CACA;;;yCAEmBC,SACpB;CAAA;;CACC,aAAO,UAACrB,IAAD,EAAU;CAChB,YAAI,KAAI,CAACtD,OAAL,CAAa4E,MAAb,CAAoBtD,EAApB,KAA2BgC,IAAI,CAACsB,MAAL,CAAYtD,EAA3C,EACA;CACC;CACA;;CAED,eAAOqD,OAAO,CAACrB,IAAD,CAAd;CACA,OAPD;CAQA;;;mCAEarB,QACd;CACC,aAAO,KAAKjC,OAAL,CAAaI,WAAb,CAAyBkB,EAAzB,KAAgCW,MAAvC;CACA;;;;;KCrCmB4C;;;;;;;;;;2CAGpB;CACC,aAAOL,sBAAU,CAACC,gBAAX,CAA4BK,MAAnC;CACA;;;8BAGD;CACC,aAAO;CACNC,QAAAA,YAAY,EAAE,KAAKC,kBAAL,CAAwBjE,IAAxB,CAA6B,IAA7B,CADR;CAENkE,QAAAA,YAAY,EAAE,KAAKC,kBAAL,CAAwBnE,IAAxB,CAA6B,IAA7B,CAFR;CAGNoE,QAAAA,YAAY,EAAE,KAAKC,kBAAL,CAAwBrE,IAAxB,CAA6B,IAA7B,CAHR;CAINsE,QAAAA,iBAAiB,EAAE,KAAKC,uBAAL,CAA6BvE,IAA7B,CAAkC,IAAlC;CAJb,OAAP;CAMA;;;wCAEkBuC,MACnB;CACCzB,MAAAA,OAAO,CAACC,GAAR,CAAY,cAAZ,EAA4BwB,IAA5B;CAEA,UAAM7B,UAAU,GAAG6B,IAAI,CAAC7B,UAAxB;;CACA,UAAI,CAAC,KAAK8D,aAAL,CAAmB9D,UAAnB,CAAL,EACA;CACC,aAAK8C,WAAL,CAAiBX,MAAjB,CAAwBnC,UAAxB;CACA;CACD;;;6CAEuB6B,MACxB;CACCzB,MAAAA,OAAO,CAACC,GAAR,CAAY,yBAAZ,EAAuCwB,IAAvC;CAEA,WAAKkC,uBAAL,CAA6BlC,IAA7B;CACA;;;wCAEkBA,MACnB;CACCzB,MAAAA,OAAO,CAACC,GAAR,CAAY,oBAAZ,EAAkCwB,IAAlC;CAEA,UAAMmC,WAAW,GAAG,KAAKD,uBAAL,CAA6BlC,IAA7B,CAApB;;CACA,UAAImC,WAAJ,EACA;CACC;CACA,aAAKlB,WAAL,CAAiBmB,iBAAjB;CACA;CACD;;;6CAEuBpC,MACxB;CACC,UAAM7B,UAAU,GAAG6B,IAAI,CAACjC,IAAL,CAAUC,EAA7B;;CACA,UAAI,KAAKiE,aAAL,CAAmB9D,UAAnB,CAAJ,EACA;CACC,eAAO,KAAP;CACA;;CAED,UAAI,KAAK8C,WAAL,CAAiBoB,GAAjB,CAAqBlE,UAArB,CAAJ,EACA;CACC,aAAK8C,WAAL,CAAiBxC,YAAjB,CAA8BN,UAA9B;CAEA,eAAO,KAAP;CACA;;CAED,WAAK8C,WAAL,CAAiBpE,GAAjB,CAAqBmD,IAAI,CAACjC,IAA1B;CAEA,aAAO,IAAP;CACA;;;wCAEkBiC,MACnB;CAAA;;CACCzB,MAAAA,OAAO,CAACC,GAAR,CAAY,oBAAZ,EAAkCwB,IAAlC;CAEA,UAAM7B,UAAU,GAAG6B,IAAI,CAAC7B,UAAxB;;CACA,UAAI,KAAK8D,aAAL,CAAmB9D,UAAnB,CAAJ,EACA;CACC;CACA;;CAED,UAAI,KAAK8C,WAAL,CAAiBoB,GAAjB,CAAqBlE,UAArB,CAAJ,EACA;CACC,aAAK8C,WAAL,CAAiBxC,YAAjB,CAA8BN,UAA9B;CACA,OAHD,MAKA;CACC,YAAI,KAAK8C,WAAL,CAAiB5D,aAAjB,EAAJ,EACA;CACC,eAAK4D,WAAL,CAAiBqB,WAAjB,CAA6BtC,IAAI,CAAC7B,UAAlC,EAA8C6B,IAAI,CAAC5B,SAAnD,EAA8DyB,IAA9D,CAAmE,UAAA0C,QAAQ,EAAI;CAC9E,YAAA,KAAI,CAACtB,WAAL,CAAiBpE,GAAjB,CAAqB0F,QAArB;CACA,WAFD,EAEG,YAAM,EAFT;CAGA;CACD;CACD;;;GA1FgDxB;;KCO7ByB;CAmBpB,sBAAYC,aAAZ,EACA;CAAA;CAAA,gDAlBc,IAkBd;CAAA,oDAjBkB,IAiBlB;CAAA,qDAhB2B,IAgB3B;CAAA,oDAf0B,IAe1B;CAAA,2DAdiC,IAcjC;CAAA,oDAb0B,IAa1B;CAAA,yDAZmC,IAYnC;CAAA,oDAXqB,IAWrB;CAAA,oDAVkB,IAUlB;CAAA,oDAT0B,IAS1B;CAAA,4DAR6B,IAQ7B;CAAA,4DAP8B,KAO9B;CAAA,uEANyC,KAMzC;CAAA,iDALmB,IAKnB;CAAA,yDAJ+B,IAI/B;CAAA,4DAH0C,IAG1C;CACC,QAAMtG,OAAO,GAAGuG,cAAI,CAACC,aAAL,CAAmBF,aAAnB,IAAoCA,aAApC,GAAoD,EAApE;CAEA,SAAKG,UAAL,GAAkBzG,OAAO,CAACyG,UAA1B;CACA,SAAKlD,eAAL,GAAuBvD,OAAO,CAACuD,eAA/B;CACA,SAAKmD,UAAL,GAAkB1G,OAAO,CAAC0G,UAA1B;CACA,SAAKC,UAAL,GAAkB3G,OAAO,CAAC2G,UAA1B;CACA,SAAKnG,WAAL,GAAmBR,OAAO,CAACQ,WAA3B;CACA,SAAKoG,UAAL,GAAkB5G,OAAO,CAAC4G,UAA1B;CACA,SAAKC,iBAAL,GAAyB7G,OAAO,CAAC6G,iBAAjC;CACA,SAAKC,UAAL,GAAkBC,wBAAa,CAACC,cAAd,CAA6BV,aAAa,CAACW,kBAAd,CAAiCC,IAA9D,CAAlB;CACA,SAAKC,kBAAL,GAA0BJ,wBAAa,CAACC,cAAd,CAA6BV,aAAa,CAACW,kBAAd,CAAiCG,YAA9D,CAA1B;CACA,SAAKC,kBAAL,GAA0Bf,aAAa,CAACe,kBAAxC;CACA,SAAK9G,OAAL,GAAe;CACdI,MAAAA,WAAW,EAAEX,OAAO,CAACW,WADP;CAEd4C,MAAAA,eAAe,EAAE,KAAKA,eAFR;CAGd4B,MAAAA,MAAM,EAAEnF,OAAO,CAACmF,MAHF;CAIdmC,MAAAA,cAAc,EAAEtH,OAAO,CAACsH;CAJV,KAAf;CAMA,SAAKC,eAAL,GAAuB,IAAIxH,WAAJ,CAAgB;CACtCQ,MAAAA,OAAO,EAAE,KAAKA,OADwB;CAEtCC,MAAAA,WAAW,EAAE,KAAKA;CAFoB,KAAhB,CAAvB;CAKA,SAAKgH,kBAAL,CAAwB,MAAxB;CACA,SAAKC,gBAAL,CAAsBzH,OAAO,CAAC0H,UAA9B;CAEA,QAAMC,aAAa,GAAGzH,EAAE,CAAC0H,SAAH,CAAaC,QAAb,CAAsBC,iBAAtB,CAAwCC,MAAxC,CAAtB;;CACA,QAAIJ,aAAJ,EACA;CACCA,MAAAA,aAAa,CAAC3G,OAAd,GAAwB+C,GAAxB,CAA4B,iBAA5B,EAA+C,KAAKR,eAApD;CACA,WAAKyE,4BAAL;CACA;;CAED,SAAKC,QAAL;CACA,SAAKrH,UAAL;CACA;;;;gCAGD;CACC,UAAI,KAAK6F,UAAT,EACA;CACCvG,QAAAA,EAAE,CAACuB,IAAH,GAAU,IAAIsD,sBAAJ,CAAe;CACxBmD,UAAAA,eAAe,EAAE;CADO,SAAf,CAAV;CAGAhI,QAAAA,EAAE,CAACuB,IAAH,CAAQ0G,KAAR,CAAc,KAAK1B,UAAnB;CACA;CACD;;;wCAEkB2B,QAAQvE,MAC3B;CACCA,MAAAA,IAAI,GAAGA,IAAI,IAAI,EAAf;CAEA,UAAM8D,aAAa,GAAGzH,EAAE,CAAC0H,SAAH,CAAaC,QAAb,CAAsBC,iBAAtB,CAAwCC,MAAxC,CAAtB;;CACA,UAAI,CAACJ,aAAL,EACA;CACC;CACA;;CAED,UAAMU,iBAAiB,GAAGV,aAAa,CAAC3G,OAAd,EAA1B;CACA6C,MAAAA,IAAI,CAACuE,MAAL,GAAcA,MAAd;CACAvE,MAAAA,IAAI,CAACyE,GAAL,GAAWD,iBAAiB,CAACxF,GAAlB,CAAsB,KAAtB,CAAX;CACAgB,MAAAA,IAAI,CAACP,iBAAL,GAAyB,KAAK/C,OAAL,CAAagD,eAAb,CAA6B1B,EAAtD;CAEA3B,MAAAA,EAAE,CAACC,IAAH,CAAQqH,kBAAR,CAA2B3D,IAA3B;CACA;;;kCAGD;CACChD,MAAAA,6BAAY,CAACC,SAAb,CAAuB,0BAAvB,EAAmD,KAAKyH,WAAL,CAAiBjH,IAAjB,CAAsB,IAAtB,CAAnD;CACAyG,MAAAA,MAAM,CAACS,gBAAP,CAAwB,cAAxB,EAAwC,KAAKD,WAAL,CAAiBjH,IAAjB,CAAsB,IAAtB,CAAxC;;CAEA,UAAI,KAAKoG,UAAL,CAAgBjD,QAAhB,CAAyBgE,WAAzB,CAAqCvB,IAArC,KAA8C,IAA9C,IAAsD,KAAKJ,UAA/D,EACA;CACC,YAAI,KAAKA,UAAL,CAAgB4B,cAAhB,CAA+B,YAA/B,CAAJ,EACA;CACC,eAAK5B,UAAL,CAAgB6B,aAAhB,GAAgCC,SAAhC,CAA0C,OAA1C,EAAmD,KAAKC,qBAAL,CAA2BvH,IAA3B,CAAgC,IAAhC,CAAnD;CAEA,cAAIwH,UAAU,GAAG,KAAKhC,UAAL,CAAgBiC,aAAhB,EAAjB;CACA,cAAIC,SAAS,GAAGC,iBAAO,CAACC,KAAR,CAAcJ,UAAU,CAACK,YAAX,EAAd,CAAhB;;CAEA,eAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGJ,SAAS,CAACK,MAA9B,EAAsCD,CAAC,EAAvC,EACA;CACC,gBAAIE,QAAQ,GAAGN,SAAS,CAACI,CAAD,CAAxB;CACA,gBAAIG,eAAe,GAAGN,iBAAO,CAACC,KAAR,CAAcI,QAAQ,CAACtJ,OAAvB,CAAtB;CACAuJ,YAAAA,eAAe,CAACC,OAAhB,GAA0B,KAAKC,uBAAL,CAA6BnI,IAA7B,CAAkC,IAAlC,CAA1B;CAEAwH,YAAAA,UAAU,CAACY,cAAX,CAA0BJ,QAAQ,CAACK,KAAT,EAA1B;CACAb,YAAAA,UAAU,CAACc,WAAX,CAAuBL,eAAvB;CACA;CACD,SAhBD,MAkBA;CACC,eAAKzC,UAAL,CAAgB8B,SAAhB,CAA0B,OAA1B,EAAmC,KAAKC,qBAAL,CAA2BvH,IAA3B,CAAgC,IAAhC,CAAnC;CACA;CACD;;CACD,UAAI,KAAK6F,kBAAT,EACA;CACC,YAAI2B,WAAU,GAAG,KAAK3B,kBAAL,CAAwB4B,aAAxB,EAAjB;;CACA,YAAIc,cAAc,GAAGf,WAAU,CAACgB,WAAX,CAAuB,UAAvB,EAAmC9J,OAAxD;;CACA6J,QAAAA,cAAc,CAACL,OAAf,GAAyB,KAAKO,gCAAL,CAAsCzI,IAAtC,CAA2C,IAA3C,CAAzB;;CAEAwH,QAAAA,WAAU,CAACY,cAAX,CAA0B,UAA1B;;CACAZ,QAAAA,WAAU,CAACc,WAAX,CAAuBC,cAAvB;;CAEA,YAAIG,cAAc,GAAGlB,WAAU,CAACgB,WAAX,CAAuB,SAAvB,EAAkC9J,OAAvD;;CACAgK,QAAAA,cAAc,CAACR,OAAf,GAAyB,KAAKS,kBAAL,CAAwB3I,IAAxB,CAA6B,IAA7B,CAAzB;;CAEAwH,QAAAA,WAAU,CAACY,cAAX,CAA0B,SAA1B;;CACAZ,QAAAA,WAAU,CAACc,WAAX,CAAuBI,cAAvB;CACA;;CAEDvI,MAAAA,gBAAI,CAACX,SAAL,CAAe,IAAIsE,oBAAJ,CAAyB;CACvC7E,QAAAA,OAAO,EAAE,KAAKA,OADyB;CAEvCuE,QAAAA,WAAW,EAAE,KAAKyC;CAFqB,OAAzB,CAAf;CAIA;;;sCAEgBvH,SACjB;CACC,WAAKkK,kBAAL,CAAwBlK,OAAxB;CACAA,MAAAA,OAAO,CAACmK,MAAR,GAAiB;CAChBC,QAAAA,qBAAqB,EAAE,KAAKC,yBAAL,CAA+B/I,IAA/B,CAAoC,IAApC,CADP;CAEhBgJ,QAAAA,eAAe,EAAE,KAAKC,mBAAL,CAAyBjJ,IAAzB,CAA8B,IAA9B,CAFD;CAGhBkJ,QAAAA,YAAY,EAAE,KAAKC,gBAAL,CAAsBnJ,IAAtB,CAA2B,IAA3B,CAHE;CAIhBoJ,QAAAA,MAAM,EAAE,KAAKC,UAAL,CAAgBrJ,IAAhB,CAAqB,IAArB,CAJQ;;CAAA,OAAjB;;CAQA,UAAItB,OAAO,CAACyE,QAAR,CAAiBgE,WAAjB,CAA6BmC,MAAjC,EACA;CACC5K,QAAAA,OAAO,CAACmK,MAAR,CAAeU,eAAf,GAAiC,KAAKC,mBAAL,CAAyBxJ,IAAzB,CAA8B,IAA9B,CAAjC;CACA;;CAED,WAAKoG,UAAL,GAAkB1H,OAAlB;CACA,WAAK+K,MAAL,GAAc,IAAIC,OAAO,CAACC,SAAZ,CAAsB,KAAKrE,UAAL,CAAgB/E,EAAtC,EAA0C7B,OAA1C,CAAd;CACA;;;wCAEkBA,SACnB;CACCA,MAAAA,OAAO,CAACkL,MAAR,GAAkBzG,QAAQ,CAAC0G,IAAT,CAAcC,YAAd,GAA6B,EAA9B,GAAoC,IAArD;CACA;;;oDAGD;CACC,UAAIrD,MAAM,CAACsD,GAAP,KAAetD,MAAf,IAAyB,CAAC7H,EAAE,CAACoL,QAAH,CAAY,mCAAZ,CAA9B,EACA;CACCD,QAAAA,GAAG,CAACnL,EAAJ,CAAOqL,OAAP,CAAe,MAAf;CACA;CACD;;;wCAGD;CACC,UAAMC,cAAc,GAAGtL,EAAE,CAAC0H,SAAH,CAAaC,QAAb,CAAsBC,iBAAtB,CAAwCC,MAAxC,CAAvB;;CACA,UAAIyD,cAAJ,EACA;CACCtL,QAAAA,EAAE,CAAC0H,SAAH,CAAaC,QAAb,CAAsB4D,cAAtB,CAAqC1D,MAArC,EAA6C,yBAA7C,EAAwE;CACvExE,UAAAA,eAAe,EAAE,KAAKA,eADiD;CAEvE4B,UAAAA,MAAM,EAAE,KAAK5E,OAAL,CAAa4E;CAFkD,SAAxE;CAIA;;CAEDtE,MAAAA,6BAAY,CAAC6K,IAAb,CAAkB,yBAAlB,EAA6C;CAC5CnI,QAAAA,eAAe,EAAE,KAAKA,eADsB;CAE5C4B,QAAAA,MAAM,EAAE,KAAK5E,OAAL,CAAa4E;CAFuB,OAA7C;CAIA;;;yCAGD;CACC,UAAMqG,cAAc,GAAGtL,EAAE,CAAC0H,SAAH,CAAaC,QAAb,CAAsBC,iBAAtB,CAAwCC,MAAxC,CAAvB;CACA,UAAI4D,OAAO,GAAG,MAAd;;CACA,UAAIH,cAAJ,EACA;CACCG,QAAAA,OAAO,GAAGH,cAAc,CAACxK,OAAf,GAAyB6B,GAAzB,CAA6B,SAA7B,KAA2C,MAArD;CAEA3C,QAAAA,EAAE,CAAC0H,SAAH,CAAaC,QAAb,CAAsB4D,cAAtB,CAAqC1D,MAArC,EAA6C,0BAA7C,EAAyE;CACxExE,UAAAA,eAAe,EAAE,KAAKA,eADkD;CAExE4B,UAAAA,MAAM,EAAE,KAAK5E,OAAL,CAAa4E,MAFmD;CAGxEwG,UAAAA,OAAO,EAAEA;CAH+D,SAAzE;CAKA;;CAED9K,MAAAA,6BAAY,CAAC6K,IAAb,CAAkB,0BAAlB,EAA8C;CAC7CnI,QAAAA,eAAe,EAAE,KAAKA,eADuB;CAE7C4B,QAAAA,MAAM,EAAE,KAAK5E,OAAL,CAAa4E,MAFwB;CAG7CwG,QAAAA,OAAO,EAAEA;CAHoC,OAA9C;CAKA;;;6CAGD;CACC,WAAKC,uBAAL;CACA;;;0CAGD;CACC,cAAQ,KAAKvE,kBAAb;CAEC,aAAKwE,0CAAkB,CAACC,kBAAxB;CACE,cAAIC,mCAAJ,EAAD,CAAoBC,iCAApB,CAAsD;CACrD7G,YAAAA,MAAM,EAAE,KAAK5E,OAAL,CAAa4E;CADgC,WAAtD;CAGA;;CACD,aAAK0G,0CAAkB,CAACI,YAAxB;CACE,cAAIF,mCAAJ,EAAD,CAAoBC,iCAApB,CAAsD;CACrD7G,YAAAA,MAAM,EAAE,KAAK5E,OAAL,CAAa4E;CADgC,WAAtD;CAGA;;CACD,aAAK0G,0CAAkB,CAACK,YAAxB;CACE,cAAIH,mCAAJ,EAAD,CAAoBI,4BAApB,CAAiD;CAChDhH,YAAAA,MAAM,EAAE,KAAK5E,OAAL,CAAa4E;CAD2B,WAAjD;CAGA;CAhBF;CAkBA;;;wDAGD;CACCiH,MAAAA,8BAAY,CAACC,SAAb,CAAuB,KAAK9L,OAAL,CAAa4E,MAAb,CAAoBtD,EAA3C;CACA;;;6CAEuBd,OAAOuI,UAC/B;CACC,UAAIgD,WAAW,GAAGhD,QAAQ,CAACK,KAAT,EAAlB;;CACA,UAAG2C,WAAW,KAAK,YAAnB,EACA;CACC,aAAKzD,qBAAL;CAEA;CACA;;CAED3I,MAAAA,EAAE,CAACC,IAAH,CAAQoM,MAAR,CAAeC,OAAf,CAAuBC,aAAvB,CAAqC;CACpCC,QAAAA,QAAQ,EAAE,KAAKnM,OAAL,CAAa4E,MAAb,CAAoBtD,EADM;CAEpC8K,QAAAA,gBAAgB,EAAE,KAAKpM,OAAL,CAAa+G,cAAb,CAA4BzF,EAFV;CAGpCyK,QAAAA,WAAW,EAAEA;CAHuB,OAArC;CAKA;;;6CAGD;CAAA;;CACC7K,MAAAA,gBAAI,CAACX,SAAL,CAAe;CACd8L,QAAAA,QAAQ,EAAE,MADI;CAEdC,QAAAA,OAAO,EAAE,YAFK;CAGdC,QAAAA,QAAQ,EAAE,kBAACjJ,IAAD,EAAU;CACnB,cAAIA,IAAI,CAACJ,IAAL,KAAc,KAAI,CAACF,eAAL,CAAqBE,IAAvC,EACA;CACC,YAAA,KAAI,CAACsJ,gBAAL;;CAEAhF,YAAAA,MAAM,CAAC7H,EAAP,CAAUC,IAAV,CAAe6M,yBAAf;CACA9M,YAAAA,EAAE,CAAC0H,SAAH,CAAaC,QAAb,CAAsBoF,KAAtB;CACA;CACD;CAXa,OAAf;CAaA;;;mCAGD;CACCxL,MAAAA,gBAAI,CAACE,WAAL,CAAiB,CAAC,CAAC,CAAF,CAAjB,EAAuB,MAAvB,EAA+B,cAA/B,EAA+C;CAC9CK,QAAAA,UAAU,EAAE,KAAKzB,OAAL,CAAaI,WAAb,CAAyBkB;CADS,OAA/C;CAIA,WAAK2F,kBAAL,CAAwB,MAAxB;CAEA,WAAK0F,iBAAL;;CAEA,UAAI,KAAKC,6BAAT,EACA;CACC;CACA;;CAED9B,MAAAA,GAAG,CAACnL,EAAJ,CAAOC,IAAP,CAAYiN,cAAZ,CAA2B;CAC1BvL,QAAAA,EAAE,EAAE,KAAK0B,eAAL,CAAqB1B,EADC;CAE1B4B,QAAAA,IAAI,EAAE,KAAKF,eAAL,CAAqBE,IAFD;CAG1B4J,QAAAA,kBAAkB,EAAE,KAAKA;CAHC,OAA3B;CAKA;;;+CAEyBtM,OAC1B;CACC,UAAI,CAAC,KAAKuM,mBAAN,IAA6B,CAAC,KAAKC,eAAvC,EACA;CACC;CACA;;CAED,UAAI5K,IAAI,CAACC,GAAL,KAAa4K,IAAI,CAACC,GAAL,CAAS,KAAKH,mBAAd,EAAmC,KAAKC,eAAxC,CAAb,GAAwE,GAA5E,EACA;CACC;CACA;;CAED,WAAKF,kBAAL,GAA0B,IAA1B;CACA;;;kCAGD;CACC,WAAKE,eAAL,GAAuB5K,IAAI,CAACC,GAAL,EAAvB;CACA;;;yCAEmB7B,OACpB;CACC,UAAM2M,OAAO,GAAG3M,KAAK,CAAC8C,IAAtB;CACAX,MAAAA,cAAI,CAACyK,SAAL,CAAe,oCAAf,EAAqD;CACpDvK,QAAAA,IAAI,EAAE,MAD8C;CAEpDC,QAAAA,IAAI,EAAE;CACLC,UAAAA,iBAAiB,EAAE,KAAK/C,OAAL,CAAagD,eAAb,CAA6B1B,EAD3C;CAEL2B,UAAAA,mBAAmB,EAAE,KAAKjD,OAAL,CAAagD,eAAb,CAA6BE,IAF7C;CAGLiK,UAAAA,OAAO,EAAEA;CAHJ;CAF8C,OAArD;CAQA;;;sCAEgB3M,OACjB;;;2CAIA;CACC,WAAKyG,kBAAL,CAAwB,OAAxB;CAEA,WAAK8F,mBAAL,GAA2B3K,IAAI,CAACC,GAAL,EAA3B;CACA;;;+CAGD;CACC,WAAKuK,6BAAL,GAAqC,IAArC;CAEA,UAAIzG,UAAU,GAAGxG,EAAE,CAAC0N,IAAH,CAAQC,aAAR,CAChB,gCADgB,EAEhB;CACCzF,QAAAA,MAAM,EAAE,mCADT;CAECkE,QAAAA,WAAW,EAAE,YAFd;CAGChJ,QAAAA,iBAAiB,EAAE,KAAKC,eAAL,CAAqB1B,EAHzC;CAIC2B,QAAAA,mBAAmB,EAAE,KAAKD,eAAL,CAAqBE;CAJ3C,OAFgB,CAAjB;;CAUA,UAAI,KAAKiD,UAAT,EACA;CACCA,QAAAA,UAAU,GAAG,KAAKA,UAAlB;CACA;;CAED,UAAMiB,aAAa,GAAGzH,EAAE,CAAC0H,SAAH,CAAaC,QAAb,CAAsBC,iBAAtB,CAAwCC,MAAxC,CAAtB;;CACA,UAAI,CAACJ,aAAL,EACA;CACCI,QAAAA,MAAM,CAACrD,QAAP,GAAkBgC,UAAlB;CAEA;CACA;;CAED,UAAIoH,kBAAkB,GAAGnG,aAAa,CAACoG,qBAAd,EAAzB;CACApG,MAAAA,aAAa,CAACsF,KAAd;CAEA/M,MAAAA,EAAE,CAAC0H,SAAH,CAAaC,QAAb,CAAsBmG,IAAtB,CACCtH,UADD,EACa;CACZuH,QAAAA,KAAK,EAAE,MADK;CAEZH,QAAAA,kBAAkB,EAAEA,kBAFR;CAGZI,QAAAA,SAAS,EAAE,KAHC;CAIZC,QAAAA,kBAAkB,EAAE,KAJR;CAKZtK,QAAAA,IAAI,EAAE;CACLuK,UAAAA,cAAc,EAAE;CADX;CALM,OADb;CAUA;;;iCAGD;CACC,aAAO,KAAKrD,MAAZ;CACA;;;qCAGD;CACC,aAAO,KAAKnE,UAAZ;CACA;;;4CAGD;CACC,aAAO,KAAKC,iBAAZ;CACA;;;oCAGD;CACC,aAAO,KAAKF,UAAZ;CACA;;;;;KC1ZmB0H;;;;;;;;;;8BAGpB;CACC,aAAO;CACNC,QAAAA,UAAU,EAAE,KAAKC,mBAAL,CAAyB,KAAKC,mBAAL,CAAyBlN,IAAzB,CAA8B,IAA9B,CAAzB;CADN,OAAP;CAGA;;;yCAEmBuC,MACpB;CACCzB,MAAAA,OAAO,CAACC,GAAR,CAAY,qBAAZ,EAAmCwB,IAAnC;CAEAX,MAAAA,cAAI,CAACyK,SAAL,CAAe,4CAAf,EAA6D;CAC5DvK,QAAAA,IAAI,EAAE,MADsD;CAE5DC,QAAAA,IAAI,EAAE;CACLoL,UAAAA,SAAS,EAAE,KAAKlO,OAAL,CAAagD,eAAb,CAA6B1B,EADnC;CAEL2B,UAAAA,mBAAmB,EAAE,KAAKjD,OAAL,CAAagD,eAAb,CAA6BE;CAF7C;CAFsD,OAA7D,EAMGC,IANH,CAMQ,UAACC,QAAD,EAAc;CACrB,YAAIA,QAAQ,CAACV,MAAT,KAAoB,SAAxB,EACA;CACCwB,UAAAA,QAAQ,CAACC,QAAT,CAAkBgK,IAAlB,GAAyB/K,QAAQ,CAACE,IAAT,CAAcN,eAAd,CAA8BgB,IAAvD;CACA;CACD,OAXD;CAYA;;;GAzBgDK;;KCE7B+J;CAKpB,mBAAYrI,aAAZ,EACA;CAAA;CAAA,yDAJmC,IAInC;CAAA,gDAHqB,IAGrB;CACC,QAAMtG,OAAO,GAAGuG,cAAI,CAACC,aAAL,CAAmBF,aAAnB,IAAoCA,aAApC,GAAoD,EAApE;CAEA,SAAK/C,eAAL,GAAuBvD,OAAO,CAACuD,eAA/B;CACA,SAAK4B,MAAL,GAAcnF,OAAO,CAACmF,MAAtB;CAEA,QAAMyJ,MAAM,GAAG,IAAI1O,EAAE,CAAC2O,MAAP,CAAc;CAC5BC,MAAAA,MAAM,EAAErK,QAAQ,CAACsK,aAAT,CAAuB,OAAvB;CADoB,KAAd,CAAf;CAGAH,IAAAA,MAAM,CAACI,IAAP;CAEA,SAAKpO,UAAL;CACA;;;;kCAGD;CACCa,MAAAA,gBAAI,CAACX,SAAL,CAAe,IAAIuN,oBAAJ,CAAyB;CACvC9N,QAAAA,OAAO,EAAE;CACR4E,UAAAA,MAAM,EAAE,KAAKA,MADL;CAER5B,UAAAA,eAAe,EAAE,KAAKA;CAFd,SAD8B;CAKvCuB,QAAAA,WAAW,EAAE;CAL0B,OAAzB,CAAf;CAOA;;;;;;;;;;;;"}