{"version":3,"file":"script.js","sources":["src/user-manager.js","src/base-command-handler.js","src/client-command-handler.js","src/sharing-control-type.js","src/server-command-handler.js","src/onlyoffice.js","src/waiting.js"],"sourcesContent":["import type {Context, User, UserManagerOptions} from \"./types\";\nimport {PULL} from \"pull.client\";\nimport {ajax as Ajax} from \"main.core\";\nimport {Users} from \"disk.users\";\nimport {BaseEvent, EventEmitter} from \"main.core.events\";\n\nconst ALLOWED_ATTEMPTS_TO_GET_USER_INFO = 3;\nconst SECONDS_TO_ACTUALIZE_ONLINE = 25;\n\nexport default class UserManager\n{\n\tuserBoxNode: HTMLElement = null;\n\tcontext: Context = null\n\tusers: Users;\n\tbadAttempts: Map<number>;\n\talreadySaidHi: boolean = false;\n\n\tconstructor(options: UserManagerOptions)\n\t{\n\t\tthis.users = new BX.Disk.Users([]);\n\t\tthis.badAttempts = new Map();\n\t\tthis.context = options.context;\n\t\tthis.userBoxNode = options.userBoxNode;\n\t\tthis.alreadySaidHi = false;\n\t\tthis.add(this.context.currentUser);\n\n\t\tthis.bindEvents();\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('onPullStatus', (event: BaseEvent) => {\n\t\t\tif (event.getData()[0] === 'online')\n\t\t\t{\n\t\t\t\tthis.handleWhenPullConnected();\n\t\t\t}\n\t\t});\n\t}\n\n\thandleWhenPullConnected(): void\n\t{\n\t\tif (!this.sentGreetings())\n\t\t{\n\t\t\tthis.sendHiToUsers();\n\t\t\tsetInterval(this.actualizeOnline.bind(this), 1000*SECONDS_TO_ACTUALIZE_ONLINE);\n\t\t}\n\t}\n\n\tactualizeOnline(): void\n\t{\n\t\tthis.refineUsersByOnline();\n\t\tif (!this.sentGreetings())\n\t\t{\n\t\t\tthis.sendHiToUsers();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.sendPingToUsers();\n\t\t}\n\t}\n\n\tsentGreetings(): boolean\n\t{\n\t\treturn this.alreadySaidHi;\n\t}\n\n\tsendHiToUsers(): void\n\t{\n\t\tif (!PULL.isConnected())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tPULL.sendMessageToChannels([this.context.object.publicChannel], 'disk', 'hiToDocument', {\n\t\t\tuser: {\n\t\t\t\tid: this.context.currentUser.id,\n\t\t\t\tname: this.context.currentUser.name,\n\t\t\t\tavatar: this.#makeLinkAbsolute(this.context.currentUser.avatar),\n\t\t\t},\n\t\t});\n\n\t\tthis.alreadySaidHi = true;\n\t}\n\n\t#makeLinkAbsolute(link: string): string\n\t{\n\t\tif (link.includes('http://') || link.includes('https://'))\n\t\t{\n\t\t\treturn link;\n\t\t}\n\n\t\treturn document.location.origin + link;\n\t}\n\n\tsendWelcomeToUser(): void\n\t{\n\t\tif (!PULL.isConnected())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tPULL.sendMessageToChannels([this.context.object.publicChannel], 'disk', 'welcomeToDocument', {\n\t\t\tuser: {\n\t\t\t\tid: this.context.currentUser.id,\n\t\t\t\tname: this.context.currentUser.name,\n\t\t\t\tavatar: this.#makeLinkAbsolute(this.context.currentUser.avatar),\n\t\t\t},\n\t\t});\n\t}\n\n\tsendPingToUsers(): void\n\t{\n\t\tif (!PULL.isConnected())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tPULL.sendMessageToChannels([this.context.object.publicChannel], 'disk', 'pingDocument', {\n\t\t\tfromUserId: this.context.currentUser.id,\n\t\t\tinfoToken: this.context.currentUser.infoToken,\n\t\t});\n\t}\n\n\tadd(user: User): void\n\t{\n\t\tif (!this.users.hasUser(user.id))\n\t\t{\n\t\t\tthis.users.addUser(user);\n\n\t\t\tconsole.log('Hi new user!', user.id);\n\t\t}\n\n\t\tthis.updateOnline(user.id);\n\t\tthis.renderBox();\n\t}\n\n\tupdateOnline(userId: number): void\n\t{\n\t\tif (this.users.hasUser(userId))\n\t\t{\n\t\t\tthis.users.getUser(userId).onlineAt = Date.now();\n\t\t}\n\t}\n\n\tgetUserInfo(userId: number, infoToken: string): Promise\n\t{\n\t\tif (this.badAttempts.get(userId) >= ALLOWED_ATTEMPTS_TO_GET_USER_INFO)\n\t\t{\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\treject({\n\t\t\t\t\tstatus: 'blocked',\n\t\t\t\t})\n\t\t\t});\n\t\t}\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tAjax.runComponentAction('bitrix:disk.file.editor-onlyoffice', 'getUserInfo', {\n\t\t\t\tmode: 'ajax',\n\t\t\t\tjson: {\n\t\t\t\t\tdocumentSessionId: this.context.documentSession.id,\n\t\t\t\t\tdocumentSessionHash: this.context.documentSession.hash,\n\t\t\t\t\tuserId: userId,\n\t\t\t\t\tinfoToken: infoToken,\n\t\t\t\t}\n\t\t\t}).then((response) => {\n\t\t\t\tif (response.status === 'success')\n\t\t\t\t{\n\t\t\t\t\tthis.badAttempts.delete(userId);\n\t\t\t\t\tresolve(response.data.user);\n\t\t\t\t}\n\t\t\t}, (response) => {\n\t\t\t\tconst attempts = this.badAttempts.get(userId) || 0;\n\t\t\t\tthis.badAttempts.set(userId, attempts + 1);\n\t\t\t\tconsole.log(this.badAttempts)\n\n\t\t\t\treject(response);\n\t\t\t});\n\t\t});\n\t}\n\n\thas(userId: number): boolean\n\t{\n\t\treturn this.users.hasUser(userId);\n\t}\n\n\tremove(userId: number): void\n\t{\n\t\tif (userId === this.context.currentUser.id)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.users.deleteUser(userId);\n\t\tthis.renderBox();\n\t}\n\n\trefineUsersByOnline(): void\n\t{\n\t\tconst secondsToOffline = 1000*(SECONDS_TO_ACTUALIZE_ONLINE+1)*2;\n\t\tconst now = Date.now();\n\n\t\tthis.users.forEach((user: User) => {\n\t\t\tif (now - user.onlineAt > secondsToOffline)\n\t\t\t{\n\t\t\t\tthis.remove(user.id);\n\t\t\t}\n\t\t})\n\t}\n\n\trenderBox(): void\n\t{\n\t\tif (!this.userBoxNode.childElementCount)\n\t\t{\n\t\t\tthis.userBoxNode.appendChild(this.users.getContainer());\n\t\t}\n\t}\n};","import {PullClient} from \"pull.client\";\nimport type {CommandOptions} from \"./types\";\nimport UserManager from \"./user-manager\";\nimport OnlyOffice from \"./onlyoffice\";\n\nexport default class BaseCommandHandler\n{\n\toptions: CommandOptions = null;\n\tonlyOffice: OnlyOffice = null;\n\tuserManager: UserManager = null;\n\n\tconstructor(commandOptions: CommandOptions)\n\t{\n\t\tthis.options = commandOptions;\n\t\tthis.userManager = commandOptions.userManager;\n\t\tthis.context = commandOptions.context;\n\t\tthis.onlyOffice = commandOptions.onlyOffice;\n\t}\n\n\tgetModuleId(): string\n\t{\n\t\treturn 'disk';\n\t}\n\n\tgetSubscriptionType(): string\n\t{\n\t\treturn PullClient.SubscriptionType.Server;\n\t}\n\n\tfilterCurrentObject(handler: Function): any\n\t{\n\t\treturn (data) => {\n\t\t\tif (this.context.object.id !== data.object.id)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\treturn handler(data);\n\t\t};\n\t}\n\n\tisCurrentUser(userId: number): boolean\n\t{\n\t\treturn this.context.currentUser.id === userId;\n\t}\n}","import BaseCommandHandler from \"./base-command-handler\";\nimport {PullClient} from \"pull.client\";\nimport type {ExitDocumentMessage, HiDocumentMessage, PingDocumentMessage, WelcomeDocumentMessage} from \"./types\";\n\nexport default class ClientCommandHandler extends BaseCommandHandler\n{\n\tgetSubscriptionType(): string\n\t{\n\t\treturn PullClient.SubscriptionType.Client;\n\t}\n\n\tgetMap(): Object\n\t{\n\t\treturn {\n\t\t\texitDocument: this.handleExitDocument.bind(this),\n\t\t\tpingDocument: this.handlePingDocument.bind(this),\n\t\t\thiToDocument: this.handleHiToDocument.bind(this),\n\t\t\twelcomeToDocument: this.handleWelcomeToDocument.bind(this),\n\t\t};\n\t}\n\n\thandleExitDocument(data: ExitDocumentMessage): void\n\t{\n\t\tconsole.log('exitDocument', data);\n\n\t\tconst fromUserId = data.fromUserId;\n\t\tif (!this.isCurrentUser(fromUserId))\n\t\t{\n\t\t\tthis.userManager.remove(fromUserId);\n\t\t}\n\t}\n\n\thandleWelcomeToDocument(data: WelcomeDocumentMessage): void\n\t{\n\t\tconsole.log('handleWelcomeToDocument', data);\n\n\t\tthis.processNewbieInDocument(data);\n\t}\n\n\thandleHiToDocument(data: HiDocumentMessage): void\n\t{\n\t\tconsole.log('handleHiToDocument', data);\n\n\t\tconst newbieAdded = this.processNewbieInDocument(data);\n\t\tif (newbieAdded)\n\t\t{\n\t\t\t//immediately send welcome to add actual online information for new user.\n\t\t\tthis.userManager.sendWelcomeToUser();\n\t\t}\n\t}\n\n\tprocessNewbieInDocument(data: HiDocumentMessage|WelcomeDocumentMessage): boolean\n\t{\n\t\tconst fromUserId = data.user.id;\n\t\tif (this.isCurrentUser(fromUserId))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.userManager.has(fromUserId))\n\t\t{\n\t\t\tthis.userManager.updateOnline(fromUserId);\n\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.userManager.add(data.user);\n\n\t\treturn true;\n\t}\n\n\thandlePingDocument(data: PingDocumentMessage): void\n\t{\n\t\tconsole.log('handlePingDocument', data);\n\n\t\tconst fromUserId = data.fromUserId;\n\t\tif (this.isCurrentUser(fromUserId))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.userManager.has(fromUserId))\n\t\t{\n\t\t\tthis.userManager.updateOnline(fromUserId);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif (this.userManager.sentGreetings())\n\t\t\t{\n\t\t\t\tthis.userManager.getUserInfo(data.fromUserId, data.infoToken).then(userData => {\n\t\t\t\t\tthis.userManager.add(userData);\n\t\t\t\t}, () => {});\n\t\t\t}\n\t\t}\n\t}\n}","export default class SharingControlType\n{\n\tstatic WITHOUT_EDIT = 'without-edit';\n\tstatic WITH_CHANGE_RIGHTS = 'with-change-rights';\n\tstatic WITH_SHARING = 'with-sharing';\n}","import BaseCommandHandler from \"./base-command-handler\";\nimport type {DocumentSavedMessage} from \"./types\";\nimport {ContentUpdatedMessage} from \"./types\";\nimport {Loc, Tag} from \"main.core\";\n\nexport default class ServerCommandHandler extends BaseCommandHandler\n{\n\tgetMap(): Object\n\t{\n\t\treturn {\n\t\t\tonlyoffice: this.filterCurrentObject(this.handleSavedDocument.bind(this)),\n\t\t\tcontentUpdated: this.filterCurrentObject(this.handleContentUpdated.bind(this)),\n\t\t};\n\t}\n\n\thandleSavedDocument(data: DocumentSavedMessage): void\n\t{\n\t\tconsole.log('handleSavedDocument', data);\n\n\t\tif (data.documentSessionInfo.wasFinallySaved)\n\t\t{\n\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\tautoHide: false,\n\t\t\t\tcontent: Loc.getMessage('DISK_FILE_EDITOR_ONLYOFFICE_SAVED_AFTER_IDLE'),\n\t\t\t});\n\t\t}\n\t}\n\n\thandleContentUpdated(data: ContentUpdatedMessage): void\n\t{\n\t\tconsole.log('handleContentUpdated', data);\n\n\t\tif (!data.object.updatedBy)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.onlyOffice.wasDocumentChanged())\n\t\t{\n\t\t\tthis.userManager.getUserInfo(data.object.updatedBy, data.updatedBy.infoToken).then(userData => {\n\t\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\t\tcontent: Loc.getMessage('DISK_FILE_EDITOR_ONLYOFFICE_SAVED_WHILE_EDITING', {\n\t\t\t\t\t\t'#NAME#': data.object.name,\n\t\t\t\t\t\t'#USER_NAME#': userData.name,\n\t\t\t\t\t}),\n\t\t\t\t});\n\t\t\t}, () => {});\n\t\t}\n\t\telse if (this.onlyOffice.isViewMode())\n\t\t{\n\t\t\tthis.userManager.getUserInfo(data.object.updatedBy, data.updatedBy.infoToken).then(userData => {\n\t\t\t\tlet content = Loc.getMessage('DISK_FILE_EDITOR_ONLYOFFICE_VIEW_NON_ACTUAL_VERSION', {\n\t\t\t\t\t'#NAME#': data.object.name,\n\t\t\t\t\t'#USER_NAME#': userData.name,\n\t\t\t\t});\n\t\t\t\tcontent = Tag.render`<span>${content}</span>`;\n\n\t\t\t\tconst refreshButton = content.querySelector('[data-refresh-btn]');\n\t\t\t\tif (refreshButton)\n\t\t\t\t{\n\t\t\t\t\tTag.style(refreshButton)`\n\t\t\t\t\t\tcursor: pointer;\n\t\t\t\t\t`;\n\t\t\t\t\trefreshButton.addEventListener('click', this.#handleClickToRefreshEditor.bind(this));\n\t\t\t\t}\n\n\t\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\t\tcontent: content,\n\t\t\t\t});\n\t\t\t}, () => {});\n\t\t}\n\t}\n\n\t#handleClickToRefreshEditor(): void\n\t{\n\t\tthis.onlyOffice.reloadView();\n\t}\n}","import {ajax as Ajax, Runtime, Type} from \"main.core\";\nimport { EventEmitter } from \"main.core.events\";\nimport { MenuItem } from 'main.popup';\nimport {PULL, PullClient} from \"pull.client\";\nimport type {EditorOptions, DocumentSession, Context} from \"./types\";\nimport {ButtonManager, Button, SplitButton} from \"ui.buttons\";\nimport ClientCommandHandler from \"./client-command-handler\";\nimport ServerCommandHandler from \"./server-command-handler\";\nimport UserManager from \"./user-manager\";\nimport {LegacyPopup, SharingControlType} from \"disk.sharing-legacy-popup\";\nimport {ExternalLink} from 'disk.external-link';\n\nconst SECONDS_TO_MARK_AS_STILL_WORKING = 60;\n\nexport default class OnlyOffice\n{\n\teditor: any = null;\n\teditorJson: any = null;\n\tuserBoxNode: HTMLElement = null;\n\teditorNode: HTMLElement = null;\n\teditorWrapperNode: HTMLElement = null;\n\ttargetNode: HTMLElement = null;\n\tdocumentSession: DocumentSession = null;\n\tlinkToEdit: string = null;\n\tlinkToView: string = null;\n\tpullConfig: any = null;\n\teditButton: SplitButton = null;\n\tsetupSharingButton: Button = null;\n\tdocumentWasChanged: boolean = false;\n\tdontEndCurrentDocumentSession: boolean = false;\n\tcontext: Context = null;\n\tusersInDocument: UserManager = null;\n\tsharingControlType: ?SharingControlType = null;\n\n\tconstructor(editorOptions: EditorOptions)\n\t{\n\t\tconst options = Type.isPlainObject(editorOptions) ? editorOptions : {};\n\n\t\tthis.pullConfig = options.pullConfig;\n\t\tthis.documentSession = options.documentSession;\n\t\tthis.linkToEdit = options.linkToEdit;\n\t\tthis.linkToView = options.linkToView;\n\t\tthis.targetNode = options.targetNode;\n\t\tthis.userBoxNode = options.userBoxNode;\n\t\tthis.editorNode = options.editorNode;\n\t\tthis.editorWrapperNode = options.editorWrapperNode;\n\t\tthis.editButton = ButtonManager.createByUniqId(editorOptions.panelButtonUniqIds.edit);\n\t\tthis.setupSharingButton = ButtonManager.createByUniqId(editorOptions.panelButtonUniqIds.setupSharing);\n\t\tthis.sharingControlType = editorOptions.sharingControlType;\n\t\tthis.context = {\n\t\t\tcurrentUser: options.currentUser,\n\t\t\tdocumentSession: this.documentSession,\n\t\t\tobject: options.object,\n\t\t\tattachedObject: options.attachedObject,\n\t\t};\n\t\tthis.context.object.publicChannel = options.publicChannel;\n\t\tthis.usersInDocument = new UserManager({\n\t\t\tcontext: this.context,\n\t\t\tuserBoxNode: this.userBoxNode,\n\t\t});\n\n\t\tthis.sendTelemetryEvent('load');\n\t\tthis.initializeEditor(options.editorJson);\n\n\t\tconst currentSlider = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tif (currentSlider)\n\t\t{\n\t\t\tcurrentSlider.getData().set('documentSession', this.documentSession);\n\t\t\tthis.loadDiskExtensionInTopWindow();\n\t\t}\n\n\t\tthis.initPull();\n\t\tthis.bindEvents();\n\t\tif (this.isEditMode())\n\t\t{\n\t\t\tthis.registerTimerToTrackWork();\n\t\t}\n\t}\n\n\tregisterTimerToTrackWork(): void\n\t{\n\t\tsetInterval(this.#trackWork.bind(this), SECONDS_TO_MARK_AS_STILL_WORKING*1000);\n\t}\n\n\t#trackWork(): void\n\t{\n\t\t\tAjax.runComponentAction('bitrix:disk.file.editor-onlyoffice', 'markAsStillWorkingSession', {\n\t\t\t\tmode: 'ajax',\n\t\t\t\tjson: {\n\t\t\t\t\tdocumentSessionId: this.context.documentSession.id,\n\t\t\t\t\tdocumentSessionHash: this.context.documentSession.hash,\n\t\t\t\t}\n\t\t\t});\n\t}\n\n\tinitPull(): void\n\t{\n\t\tif (this.pullConfig)\n\t\t{\n\t\t\tBX.PULL = new PullClient({\n\t\t\t\tskipStorageInit: true\n\t\t\t});\n\t\t\tBX.PULL.start(this.pullConfig);\n\t\t}\n\t}\n\n\tsendTelemetryEvent(action, data): void\n\t{\n\t\tdata = data || {};\n\n\t\tconst currentSlider = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tif (!currentSlider)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst currentSliderData = currentSlider.getData();\n\t\tdata.action = action;\n\t\tdata.uid = currentSliderData.get('uid');\n\t\tdata.documentSessionId = this.context.documentSession.id;\n\t\tdata.documentSessionHash = this.context.documentSession.hash;\n\t\tdata.fileSize = this.context.object.size;\n\n\t\tBX.Disk.sendTelemetryEvent(data);\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tEventEmitter.subscribe(\"SidePanel.Slider:onClose\", this.handleClose.bind(this));\n\t\twindow.addEventListener(\"beforeunload\", this.handleClose.bind(this));\n\n\t\tif (this.editorJson.document.permissions.edit === true && this.editButton)\n\t\t{\n\t\t\tif (this.editButton.hasOwnProperty('mainButton'))\n\t\t\t{\n\t\t\t\tthis.editButton.getMainButton().bindEvent('click', this.handleClickEditButton.bind(this));\n\n\t\t\t\tlet menuWindow = this.editButton.getMenuWindow();\n\t\t\t\tlet menuItems = Runtime.clone(menuWindow.getMenuItems());\n\n\t\t\t\tfor (let i = 0; i < menuItems.length; i++)\n\t\t\t\t{\n\t\t\t\t\tlet menuItem = menuItems[i];\n\t\t\t\t\tlet menuItemOptions = Runtime.clone(menuItem.options);\n\t\t\t\t\tmenuItemOptions.onclick = this.handleClickEditSubItems.bind(this);\n\n\t\t\t\t\tmenuWindow.removeMenuItem(menuItem.getId());\n\t\t\t\t\tmenuWindow.addMenuItem(menuItemOptions);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.editButton.bindEvent('click', this.handleClickEditButton.bind(this));\n\t\t\t}\n\t\t}\n\t\tif (this.setupSharingButton)\n\t\t{\n\t\t\tlet menuWindow = this.setupSharingButton.getMenuWindow();\n\t\t\tlet extLinkOptions = menuWindow.getMenuItem('ext-link').options;\n\t\t\textLinkOptions.onclick = this.handleClickSharingByExternalLink.bind(this);\n\n\t\t\tmenuWindow.removeMenuItem('ext-link');\n\t\t\tmenuWindow.addMenuItem(extLinkOptions);\n\n\t\t\tlet sharingOptions = menuWindow.getMenuItem('sharing').options;\n\t\t\tsharingOptions.onclick = this.handleClickSharing.bind(this);\n\n\t\t\tmenuWindow.removeMenuItem('sharing');\n\t\t\tmenuWindow.addMenuItem(sharingOptions);\n\t\t}\n\n\t\tPULL.subscribe(new ClientCommandHandler({\n\t\t\tonlyOffice: this,\n\t\t\tcontext: this.context,\n\t\t\tuserManager: this.usersInDocument,\n\t\t}));\n\t\tPULL.subscribe(new ServerCommandHandler({\n\t\t\tonlyOffice: this,\n\t\t\tcontext: this.context,\n\t\t\tuserManager: this.usersInDocument,\n\t\t}));\n\t}\n\n\tinitializeEditor(options): void\n\t{\n\t\tthis.adjustEditorHeight(options);\n\t\toptions.events = {\n\t\t\tonDocumentStateChange: this.handleDocumentStateChange.bind(this),\n\t\t\tonDocumentReady: this.handleDocumentReady.bind(this),\n\t\t\tonMetaChange: this.handleMetaChange.bind(this),\n\t\t\tonInfo: this.handleInfo.bind(this),\n\t\t\tonError: this.handleError.bind(this),\n\t\t\t// onRequestClose: this.handleClose.bind(this),\n\t\t}\n\n\t\tif (options.document.permissions.rename)\n\t\t{\n\t\t\toptions.events.onRequestRename = this.handleRequestRename.bind(this);\n\t\t}\n\n\t\tthis.editorJson = options;\n\t\tthis.editor = new DocsAPI.DocEditor(this.editorNode.id, options);\n\t}\n\n\tadjustEditorHeight(options): void\n\t{\n\t\toptions.height = (document.body.clientHeight - 70) + 'px';\n\t}\n\n\tloadDiskExtensionInTopWindow(): void\n\t{\n\t\tif (window.top !== window && !BX.getClass('window.top.BX.Disk.endEditSession'))\n\t\t{\n\t\t\ttop.BX.loadExt('disk');\n\t\t}\n\t}\n\n\temitEventOnSaved(): void\n\t{\n\t\tconst sliderByWindow = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tif (sliderByWindow)\n\t\t{\n\t\t\tBX.SidePanel.Instance.postMessageAll(window, 'Disk.OnlyOffice:onSaved', {\n\t\t\t\tdocumentSession: this.documentSession,\n\t\t\t\tobject: this.context.object,\n\t\t\t});\n\t\t}\n\n\t\tEventEmitter.emit('Disk.OnlyOffice:onSaved', {\n\t\t\tdocumentSession: this.documentSession,\n\t\t\tobject: this.context.object,\n\t\t});\n\t}\n\n\temitEventOnClosed(): void\n\t{\n\t\tconst sliderByWindow = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tlet process = 'edit';\n\t\tif (sliderByWindow)\n\t\t{\n\t\t\tprocess = sliderByWindow.getData().get('process') || 'edit';\n\n\t\t\tBX.SidePanel.Instance.postMessageAll(window, 'Disk.OnlyOffice:onClosed', {\n\t\t\t\tdocumentSession: this.documentSession,\n\t\t\t\tobject: this.context.object,\n\t\t\t\tprocess: process,\n\t\t\t});\n\t\t}\n\n\t\tEventEmitter.emit('Disk.OnlyOffice:onClosed', {\n\t\t\tdocumentSession: this.documentSession,\n\t\t\tobject: this.context.object,\n\t\t\tprocess: process,\n\t\t});\n\t}\n\n\thandleClickEditButton(): void\n\t{\n\t\tthis.handleRequestEditRights();\n\t}\n\n\thandleClickSharing(): void\n\t{\n\t\tswitch (this.sharingControlType)\n\t\t{\n\t\t\tcase SharingControlType.WITH_CHANGE_RIGHTS:\n\t\t\t\t(new LegacyPopup()).showSharingDetailWithChangeRights({\n\t\t\t\t\tobject: this.context.object\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\tcase SharingControlType.WITH_SHARING:\n\t\t\t\t(new LegacyPopup()).showSharingDetailWithChangeRights({\n\t\t\t\t\tobject: this.context.object\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t\tcase SharingControlType.WITHOUT_EDIT:\n\t\t\t\t(new LegacyPopup()).showSharingDetailWithoutEdit({\n\t\t\t\t\tobject: this.context.object\n\t\t\t\t});\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\thandleClickSharingByExternalLink(event, menuItem: MenuItem): void\n\t{\n\t\tif (menuItem.dataset.shouldBlockExternalLinkFeature)\n\t\t{\n\t\t\teval(menuItem.dataset.blockerExternalLinkFeature);\n\n\t\t\treturn;\n\t\t}\n\n\t\tExternalLink.showPopup(this.context.object.id);\n\t}\n\n\thandleClickEditSubItems(event, menuItem: MenuItem): void\n\t{\n\t\tlet serviceCode = menuItem.getId();\n\t\tif(serviceCode === 'onlyoffice')\n\t\t{\n\t\t\tthis.handleClickEditButton();\n\n\t\t\treturn;\n\t\t}\n\n\t\tBX.Disk.Viewer.Actions.runActionEdit({\n\t\t\tobjectId: this.context.object.id,\n\t\t\tattachedObjectId: this.context.attachedObject.id,\n\t\t\tserviceCode: serviceCode,\n\t\t});\n\t}\n\n\thandleSaveButtonClick(): void\n\t{\n\t\tPULL.subscribe({\n\t\t\tmoduleId: 'disk',\n\t\t\tcommand: 'onlyoffice',\n\t\t\tcallback: (data) => {\n\t\t\t\tif (data.hash === this.documentSession.hash)\n\t\t\t\t{\n\t\t\t\t\tthis.emitEventOnSaved();\n\n\t\t\t\t\twindow.BX.Disk.showModalWithStatusAction();\n\t\t\t\t\tBX.SidePanel.Instance.close();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\thandleClose(): void\n\t{\n\t\tPULL.sendMessageToChannels([this.context.object.publicChannel], 'disk', 'exitDocument', {\n\t\t\tfromUserId: this.context.currentUser.id,\n\t\t});\n\n\t\tthis.sendTelemetryEvent('exit');\n\n\t\tthis.emitEventOnClosed();\n\n\t\tif (this.dontEndCurrentDocumentSession)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\ttop.BX.Disk.endEditSession({\n\t\t\tid: this.documentSession.id,\n\t\t\thash: this.documentSession.hash,\n\t\t\tdocumentWasChanged: this.documentWasChanged,\n\t\t});\n\t}\n\n\thandleDocumentStateChange(event): void\n\t{\n\t\tif (!this.caughtDocumentReady || !this.caughtInfoEvent)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (Date.now() - Math.max(this.caughtDocumentReady, this.caughtInfoEvent) < 500)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.documentWasChanged = true;\n\t}\n\n\twasDocumentChanged(): boolean\n\t{\n\t\treturn this.documentWasChanged;\n\t}\n\n\tisEditMode(): boolean\n\t{\n\t\treturn this.editorJson.editorConfig.mode === 'edit';\n\t}\n\n\tisViewMode(): boolean\n\t{\n\t\treturn !this.isEditMode();\n\t}\n\n\treloadView(): void\n\t{\n\t\tif (this.isViewMode())\n\t\t{\n\t\t\tdocument.location = this.linkToView;\n\t\t}\n\t}\n\n\thandleInfo(): void\n\t{\n\t\tthis.caughtInfoEvent = Date.now();\n\t}\n\n\thandleError(d): void\n\t{\n\t\tconsole.log('onlyoffice error:', d.data);\n\t}\n\n\thandleRequestRename(event): void\n\t{\n\t\tconst newName = event.data;\n\t\tAjax.runAction('disk.api.onlyoffice.renameDocument', {\n\t\t\tmode: 'ajax',\n\t\t\tjson: {\n\t\t\t\tdocumentSessionId: this.context.documentSession.id,\n\t\t\t\tdocumentSessionHash: this.context.documentSession.hash,\n\t\t\t\tnewName: newName,\n\t\t\t}\n\t\t});\n\t}\n\n\thandleMetaChange(event): void\n\t{\n\t}\n\n\thandleDocumentReady(): void\n\t{\n\t\tthis.sendTelemetryEvent('ready');\n\n\t\tthis.caughtDocumentReady = Date.now();\n\t}\n\n\thandleRequestEditRights(): void\n\t{\n\t\tthis.dontEndCurrentDocumentSession = true;\n\n\t\tlet linkToEdit = BX.util.add_url_param(\n\t\t\t'/bitrix/services/main/ajax.php',\n\t\t\t{\n\t\t\t\taction: 'disk.api.documentService.goToEdit',\n\t\t\t\tserviceCode: 'onlyoffice',\n\t\t\t\tdocumentSessionId: this.documentSession.id,\n\t\t\t\tdocumentSessionHash: this.documentSession.hash,\n\t\t\t}\n\t\t);\n\n\t\tif (this.linkToEdit)\n\t\t{\n\t\t\tlinkToEdit = this.linkToEdit;\n\t\t}\n\n\t\tconst currentSlider = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\tif (!currentSlider)\n\t\t{\n\t\t\twindow.location = linkToEdit;\n\n\t\t\treturn;\n\t\t}\n\n\t\tlet customLeftBoundary = currentSlider.getCustomLeftBoundary();\n\t\tcurrentSlider.close();\n\n\t\tBX.SidePanel.Instance.open(\n\t\t\tlinkToEdit, {\n\t\t\twidth: '100%',\n\t\t\tcustomLeftBoundary: customLeftBoundary,\n\t\t\tcacheable: false,\n\t\t\tallowChangeHistory: false,\n\t\t\tdata: {\n\t\t\t\tdocumentEditor: true\n\t\t\t}\n\t\t});\n\t}\n\n\tgetEditor()\n\t{\n\t\treturn this.editor;\n\t}\n\n\tgetEditorNode(): HTMLElement\n\t{\n\t\treturn this.editorNode;\n\t}\n\n\tgetEditorWrapperNode(): HTMLElement\n\t{\n\t\treturn this.editorWrapperNode;\n\t}\n\n\tgetContainer(): HTMLElement\n\t{\n\t\treturn this.targetNode;\n\t}\n}\n","import {ajax as Ajax, Type} from \"main.core\";\nimport {PULL} from \"pull.client\";\nimport type {WaitingOptions, DocumentSession, BaseObject} from \"./types\";\n\nexport default class Waiting\n{\n\tdocumentSession: DocumentSession = null;\n\tobject: BaseObject = null;\n\n\tconstructor(waitingOptions: WaitingOptions)\n\t{\n\t\tconst options = Type.isPlainObject(waitingOptions) ? waitingOptions : {};\n\n\t\tthis.documentSession = options.documentSession;\n\t\tthis.object = options.object;\n\n\t\tconst loader = new BX.Loader({\n\t\t\ttarget: options.targetNode,\n\t\t});\n\t\tloader.show();\n\n\t\tthis.bindEvents();\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tPULL.subscribe({\n\t\t\ttype: BX.PullClient.SubscriptionType.Server,\n\t\t\tmoduleId: 'disk',\n\t\t\tcommand: 'onlyoffice',\n\t\t\tcallback: this.handleSavedDocument.bind(this),\n\t\t});\n\t}\n\n\thandleSavedDocument(data): void\n\t{\n\t\tconsole.log('handleSavedDocument', data);\n\n\t\tAjax.runAction('disk.api.onlyoffice.continueWithNewSession', {\n\t\t\tmode: 'ajax',\n\t\t\tjson: {\n\t\t\t\tsessionId: this.documentSession.id,\n\t\t\t\tdocumentSessionHash: this.documentSession.hash,\n\t\t\t}\n\t\t}).then((response) => {\n\t\t\tif (response.status === 'success')\n\t\t\t{\n\t\t\t\tdocument.location.href = response.data.documentSession.link;\n\t\t\t}\n\t\t});\n\t}\n}"],"names":["ALLOWED_ATTEMPTS_TO_GET_USER_INFO","SECONDS_TO_ACTUALIZE_ONLINE","UserManager","options","users","BX","Disk","Users","badAttempts","Map","context","userBoxNode","alreadySaidHi","add","currentUser","bindEvents","EventEmitter","subscribe","event","getData","handleWhenPullConnected","sentGreetings","sendHiToUsers","setInterval","actualizeOnline","bind","refineUsersByOnline","sendPingToUsers","PULL","isConnected","sendMessageToChannels","object","publicChannel","user","id","name","avatar","fromUserId","infoToken","hasUser","addUser","console","log","updateOnline","renderBox","userId","getUser","onlineAt","Date","now","get","Promise","resolve","reject","status","Ajax","runComponentAction","mode","json","documentSessionId","documentSession","documentSessionHash","hash","then","response","delete","data","attempts","set","deleteUser","secondsToOffline","forEach","remove","childElementCount","appendChild","getContainer","link","includes","document","location","origin","BaseCommandHandler","commandOptions","userManager","onlyOffice","PullClient","SubscriptionType","Server","handler","ClientCommandHandler","Client","exitDocument","handleExitDocument","pingDocument","handlePingDocument","hiToDocument","handleHiToDocument","welcomeToDocument","handleWelcomeToDocument","isCurrentUser","processNewbieInDocument","newbieAdded","sendWelcomeToUser","has","getUserInfo","userData","SharingControlType","ServerCommandHandler","onlyoffice","filterCurrentObject","handleSavedDocument","contentUpdated","handleContentUpdated","documentSessionInfo","wasFinallySaved","UI","Notification","Center","notify","autoHide","content","Loc","getMessage","updatedBy","wasDocumentChanged","isViewMode","Tag","render","refreshButton","querySelector","style","addEventListener","_classPrivateMethodGet","reloadView","SECONDS_TO_MARK_AS_STILL_WORKING","OnlyOffice","editorOptions","Type","isPlainObject","pullConfig","linkToEdit","linkToView","targetNode","editorNode","editorWrapperNode","editButton","ButtonManager","createByUniqId","panelButtonUniqIds","edit","setupSharingButton","setupSharing","sharingControlType","attachedObject","usersInDocument","sendTelemetryEvent","initializeEditor","editorJson","currentSlider","SidePanel","Instance","getSliderByWindow","window","loadDiskExtensionInTopWindow","initPull","isEditMode","registerTimerToTrackWork","skipStorageInit","start","action","currentSliderData","uid","fileSize","size","handleClose","permissions","hasOwnProperty","getMainButton","bindEvent","handleClickEditButton","menuWindow","getMenuWindow","menuItems","Runtime","clone","getMenuItems","i","length","menuItem","menuItemOptions","onclick","handleClickEditSubItems","removeMenuItem","getId","addMenuItem","extLinkOptions","getMenuItem","handleClickSharingByExternalLink","sharingOptions","handleClickSharing","adjustEditorHeight","events","onDocumentStateChange","handleDocumentStateChange","onDocumentReady","handleDocumentReady","onMetaChange","handleMetaChange","onInfo","handleInfo","onError","handleError","rename","onRequestRename","handleRequestRename","editor","DocsAPI","DocEditor","height","body","clientHeight","top","getClass","loadExt","sliderByWindow","postMessageAll","emit","process","handleRequestEditRights","WITH_CHANGE_RIGHTS","LegacyPopup","showSharingDetailWithChangeRights","WITH_SHARING","WITHOUT_EDIT","showSharingDetailWithoutEdit","dataset","shouldBlockExternalLinkFeature","eval","blockerExternalLinkFeature","ExternalLink","showPopup","serviceCode","Viewer","Actions","runActionEdit","objectId","attachedObjectId","moduleId","command","callback","emitEventOnSaved","showModalWithStatusAction","close","emitEventOnClosed","dontEndCurrentDocumentSession","endEditSession","documentWasChanged","caughtDocumentReady","caughtInfoEvent","Math","max","editorConfig","d","newName","runAction","util","add_url_param","customLeftBoundary","getCustomLeftBoundary","open","width","cacheable","allowChangeHistory","documentEditor","Waiting","waitingOptions","loader","Loader","target","show","type","sessionId","href"],"mappings":"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"}