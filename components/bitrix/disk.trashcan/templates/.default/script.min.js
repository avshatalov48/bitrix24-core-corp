BX.namespace("BX.Disk");BX.Disk.TrashCanClass=function(){var t=function(t){this.gridId=t.gridId;this.filterId=t.filterId;this.trashcan=t.trashcan;this.grid=BX.Main.gridManager.getById(this.gridId);this.filter=BX.Main.filterManager.getById(this.filterId);this.rootObject=t.rootObject||{};this.ajaxUrl="/bitrix/components/bitrix/disk.trashcan/ajax.php";this.setEvents();this.workWithLocationHash()};t.prototype.setEvents=function(){BX.bind(BX("delete_button_"+this.grid.table_id),"click",BX.proxy(this.onClickDeleteGroup,this));BX.addCustomEvent("onEmptyTrashCan",BX.proxy(this.openConfirmEmpty,this));BX.bind(window,"hashchange",BX.proxy(this.onHashChange,this));BX.bindDelegate(this.grid.instance.container,"click",{className:"js-disk-grid-open-folder"},this.openGridFolder.bind(this));BX.bind(window,"popstate",this.onPopState.bind(this));BX.addCustomEvent("BX.Main.Filter:apply",this.onFilterApply.bind(this));BX.addCustomEvent("Disk.Page:onChangeFolder",this.onChangeFolder.bind(this));if(typeof BX.Bitrix24!=="undefined"&&typeof BX.Bitrix24.PageSlider!=="undefined"){BX.Bitrix24.PageSlider.bindAnchors({rules:[{condition:[this.trashcan.link],handler:function(t,e){if(BX.hasClass(e.anchor,"main-ui-pagination-page")||BX.hasClass(e.anchor,"main-ui-pagination-arrow")){return}if(this.onOpenFolder(e.anchor)){t.preventDefault()}}.bind(this)}]})}};t.prototype.workWithLocationHash=function(){setTimeout(BX.delegate(function(){this.onHashChange()},this),350)};t.prototype.onHashChange=function(){var t=document.location.hash.match(/hl-([0-9]+)/g);if(t){var e=(document.location.hash.match(/!([a-zA-Z]+)/g)||[]).pop();for(var n in t){if(!t.hasOwnProperty(n)){continue}var o=t[n];var i=o.match(/hl-([0-9]+)/);if(i&&i[1]){var s=this.getRow(i[1]);if(s){this.scrollToRow(s);s.select();this.runCommandOnObjectId(e,i[1])}else if(e){if(window.BXIM&&BXIM.isOpenNotify()){document.location.reload();BXIM.closeMessenger()}}}}if(window.BXIM&&BXIM.isOpenNotify()){BXIM.closeMessenger()}}};t.prototype.onFilterApply=function(t,e,n,o){if(t!==this.filterId){return}this.runAfterFilterOpenFolder=this.resetFilter.bind(this)};t.prototype.resetFilter=function(){this.isFiltetedFolderList=false;this.filter.getApi().setFields({});this.filter.getSearch().clearForm();this.filter.getSearch().adjustPlaceholder()};t.prototype.onOpenFolder=function(t){var e={id:t.dataset.objectId,link:t.getAttribute("href"),name:t.textContent.trim(),node:t};if(!e.id){return false}BX.onCustomEvent("Disk.TrashCanClass:onFolderBeforeOpen",[e]);window.history.pushState({disk:true,folder:{id:e.id,name:e.name}},null,e.link);this.openFolder(e.id,e);return true};t.prototype.openFolder=function(t,e){this.grid.instance.reloadTable("POST",{resetFilter:1},function(){BX.onCustomEvent("Disk.TrashCanClass:onFolderOpen",[e,this.isFiltetedFolderList]);BX.Disk.Page.changeFolder({id:e.id,name:e.name})}.bind(this),e.link)};t.prototype.openGridFolder=function(t){if(t.shiftKey||t.ctrlKey){return}var e=t.target||t.srcElement;if(!e.dataset.objectId){return}var n=this.getRow(e.dataset.objectId);var o=BX.findChildByClassName(n.node,"js-disk-grid-folder");BX.fireEvent(o,"click")};t.prototype.onPopState=function(t){var e=t.state;if(!e||!e.disk||!e.folder){window.location.reload();return}if(!e.folder.link){e.folder.link=window.location.pathname.toString()}BX.onCustomEvent("Disk.TrashCanClass:onPopState",[e.folder,true]);this.openFolder(e.folder.id,e.folder)};t.prototype.onChangeFolder=function(t,e){if(BX.type.isFunction(this.runAfterFilterOpenFolder)){this.runAfterFilterOpenFolder();this.runAfterFilterOpenFolder=null;var n=history.state.folder;n.link=window.location.pathname.toString();BX.onCustomEvent("Disk.TrashCanClass:openFolderAfterFilter",[n,true])}};t.prototype.removeRow=function(t){this.grid.instance.removeRow(t)};t.prototype.getRow=function(t){return this.grid.instance.getRows().getById(t)};t.prototype.openConfirmDelete=function(t){var e=t.object.name;var n=t.object.id;var o=t.object.isFolder;var i="";if(o){i=BX.message("DISK_TRASHCAN_TRASH_DELETE_DESTROY_FOLDER_CONFIRM")}else{i=BX.message("DISK_TRASHCAN_TRASH_DELETE_DESTROY_FILE_CONFIRM")}var s=[new BX.PopupWindowButton({text:BX.message("DISK_TRASHCAN_TRASH_DESTROY_BUTTON"),className:"popup-window-button-accept",events:{click:BX.delegate(function(t){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(t);BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","destroy"),data:{objectId:n},onsuccess:BX.delegate(function(t){if(!t){return}if(t.status=="success"){this.removeRow(n);BX.Disk.showModalWithStatusAction(t);return}BX.Disk.showModalWithStatusAction(t)},this)});return false},this)}}),new BX.PopupWindowButton({text:BX.message("DISK_TRASHCAN_TRASH_CANCEL_DELETE_BUTTON"),events:{click:function(t){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(t);return false}}})];BX.Disk.modalWindow({modalId:"bx-link-unlink-confirm",title:BX.message("DISK_TRASHCAN_TRASH_DELETE_TITLE"),contentClassName:"tac",contentStyle:{paddingTop:"70px",paddingBottom:"70px"},content:i.replace("#NAME#",e),buttons:s})};t.prototype.openConfirmRestore=function(t){var e=t.object.name;var n=t.object.id;var o=t.object.isFolder;var i="";if(o){i=BX.message("DISK_TRASHCAN_TRASH_RESTORE_FOLDER_CONFIRM")}else{i=BX.message("DISK_TRASHCAN_TRASH_RESTORE_FILE_CONFIRM")}var s=[new BX.PopupWindowButton({text:BX.message("DISK_TRASHCAN_TRASH_RESTORE_BUTTON"),className:"popup-window-button-accept",events:{click:BX.delegate(function(t){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(t);BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","restore"),data:{objectId:n},onsuccess:BX.delegate(function(t){if(!t){return}if(t.status=="success"){this.removeRow(n);BX.Disk.showModalWithStatusAction(t);return}BX.Disk.showModalWithStatusAction(t)},this)});return false},this)}}),new BX.PopupWindowButton({text:BX.message("DISK_TRASHCAN_TRASH_CANCEL_DELETE_BUTTON"),events:{click:function(t){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(t);return false}}})];BX.Disk.modalWindow({modalId:"bx-link-unlink-confirm",title:BX.message("DISK_TRASHCAN_TRASH_RESTORE_TITLE"),contentClassName:"tac",contentStyle:{paddingTop:"70px",paddingBottom:"70px"},content:i.replace("#NAME#",e),buttons:s})};var e=false;var n=0;function o(){BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","destroyPortion"),data:{objectId:this.rootObject.id},onsuccess:BX.delegate(function(t){if(!t||t.status!="success")BX.Disk.showModalWithStatusAction(t);n-=t.countItems;if(n<0){n=0}var i=BX("bx-elements-to-destroy");BX.adjust(i,{text:n});if(n&&!e){BX.delegate(o,this)()}else{BX.reload()}},this)})}t.prototype.openConfirmEmpty=function(){var t=BX.message("DISK_TRASHCAN_TRASH_EMPTY_FOLDER_CONFIRM");var i=[new BX.PopupWindowButton({text:BX.message("DISK_TRASHCAN_TRASH_EMPTY_BUTTON"),id:"bx-disk-btn-start-trashcan",className:"popup-window-button-accept",events:{click:BX.delegate(function(t){BX.PreventDefault(t);BX.remove(BX("bx-disk-btn-start-trashcan"));BX.remove(BX("bx-disk-btn-cancel-trashcan"));BX.show(BX("bx-disk-btn-stop-empty-trashcan"),"inline-block");BX.Disk.ajax({method:"POST",dataType:"json",url:BX.Disk.addToLinkParam(this.ajaxUrl,"action","calculate"),data:{objectId:this.rootObject.id},onsuccess:BX.delegate(function(t){if(!t||t.status!="success")BX.Disk.showModalWithStatusAction(t);var e=BX("bx-empty-trashcan-container");BX.cleanNode(e);n=t.countItems;BX.adjust(e,{children:[BX.create("span",{text:BX.message("DISK_TRASHCAN_TRASH_COUNT_ELEMENTS")}),BX.create("span",{props:{id:"bx-elements-to-destroy"},text:t.countItems}),BX.create("span",{style:{margin:"0 auto",backgroundColor:"transparent",border:"none",position:"relative"},props:{id:"wd_progress",className:"bx-core-waitwindow"}})]});BX.delegate(o,this)()},this)})},this)}}),new BX.PopupWindowButton({id:"bx-disk-btn-cancel-trashcan",text:BX.message("DISK_TRASHCAN_TRASH_CANCEL_DELETE_BUTTON"),events:{click:function(t){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(t);return false}}}),new BX.PopupWindowButton({id:"bx-disk-btn-stop-empty-trashcan",text:BX.message("DISK_TRASHCAN_TRASH_CANCEL_STOP_BUTTON"),events:{click:function(t){e=true;BX.PreventDefault(t);return false}}})];BX.Disk.modalWindow({modalId:"bx-empty-trashcan-modal",title:BX.message("DISK_TRASHCAN_TRASH_EMPTY_TITLE"),contentClassName:"tac",contentStyle:{paddingTop:"70px",paddingBottom:"70px"},events:{onPopupShow:function(){BX.hide(BX("bx-disk-btn-stop-empty-trashcan"))}},content:[BX.create("div",{props:{id:"bx-empty-trashcan-container"},text:t})],buttons:i})};t.prototype.openConfirmDeleteGroup=function(t){var e=BX.message("DISK_TRASHCAN_TRASH_DELETE_GROUP_CONFIRM");var n=[new BX.PopupWindowButton({text:BX.message("DISK_TRASHCAN_TRASH_DESTROY_BUTTON"),className:"popup-window-button-accept",events:{click:BX.delegate(function(t){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(t);this.grid.ActionDelete();return false},this)}}),new BX.PopupWindowButton({text:BX.message("DISK_TRASHCAN_TRASH_CANCEL_DELETE_BUTTON"),events:{click:function(t){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(t);return false}}})];BX.Disk.modalWindow({modalId:"bx-link-unlink-confirm",title:BX.message("DISK_TRASHCAN_TRASH_DELETE_TITLE"),contentClassName:"tac",contentStyle:{paddingTop:"70px",paddingBottom:"70px"},content:e,buttons:n})};t.prototype.openConfirmRestoreGroup=function(t){var e=BX.message("DISK_TRASHCAN_TRASH_RESTORE_GROUP_CONFIRM");var n=[new BX.PopupWindowButton({text:BX.message("DISK_TRASHCAN_TRASH_RESTORE_BUTTON"),className:"popup-window-button-accept",events:{click:BX.delegate(function(t){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(t);this.grid.SetActionName("restore");this.actionGroupButton="restore";this.grid.SetActionName("restore");BX.submit(this.grid.GetForm());return false},this)}}),new BX.PopupWindowButton({text:BX.message("DISK_TRASHCAN_TRASH_CANCEL_DELETE_BUTTON"),events:{click:function(t){BX.PopupWindowManager.getCurrentPopup().destroy();BX.PreventDefault(t);return false}}})];BX.Disk.modalWindow({modalId:"bx-link-unlink-confirm",title:BX.message("DISK_TRASHCAN_TRASH_RESTORE_TITLE"),contentClassName:"tac",contentStyle:{paddingTop:"70px",paddingBottom:"70px"},content:e,buttons:n})};return t}();