"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.Task!="undefined"){return}BX.Tasks.Component.Task=BX.Tasks.Util.Widget.extend({options:{removeTemplates:false,registerDispatcher:true,data:{}},constants:{PRIORITY_AVERAGE:1,PRIORITY_HIGH:2},sys:{code:"task-edit"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);this.instances.calendar=false;this.instances.helpWindow=false;this.analyticsData={};this.isFlowForm=this.option("isFlowForm")===true;this.isFeatureEnabled=this.option("isFeatureEnabled")===true;this.isFeatureTrialable=this.option("isFeatureTrialable")===true;this.flowId=parseInt(this.option("flowId"),10);this.flowLimitCode=this.option("flowLimitCode");this.flowSelectedItem=null;this.isProjectLimitExceeded=this.option("isProjectLimitExceeded")===true;this.projectLimitCode=this.option("projectLimitCode");this.taskStatusSummaryEnabled=this.option("taskStatusSummaryEnabled")===true;this.relatedSubTaskDeadlinesEnabled=this.option("relatedSubTaskDeadlinesEnabled")===true;this.taskRecurringEnabled=this.option("taskRecurringEnabled")===true;this.fireTaskEvent();if(this.option("doInit")){this.bindEvents();this.initParentTask();this.initRelatedTask();this.initReminder();this.initProjectDependence();this.initProjectPlan();this.initState();this.clearNewAnalyticsParams();this.doSomeTricks()}this.onTitleChange();this.onResponsibleChange();this.checkNoWorkDays(this.getTaskData().MATCH_WORK_TIME==="Y");this.calendarSettings=this.option("calendarSettings");this.aiCommandExecutor=null;this.changingFlow=false},getUser:function(){return this.option("auxData").USER},restrictMemberSelectors:function(){if(this.getUser().IS_SUPER_USER){return}this.vars.responsible=null;this.vars.originator=null;BX.Tasks.Util.Dispatcher.find(this.option("id")+"-responsible").then(function(t){this.vars.responsible=t;return BX.Tasks.Util.Dispatcher.find(this.option("id")+"-originator")}.bind(this)).then(function(t){this.vars.originator=t;var e=this.vars.responsible;this.vars.responsibleRestrLock=false;this.vars.originatorRestrLock=false;t.bindEvent("change",this.restrictResponsible.bind(this));e.bindEvent("change",this.restrictOriginator.bind(this))}.bind(this))},restrictResponsible:function(){if(this.vars.responsibleRestrLock){return}this.vars.originatorRestrLock=true;var t=this.vars.responsible;var e=this.vars.originator;var s=this.getUser().DATA;var i=e.value();var n=false;if(typeof i!="undefined"&&typeof i[0]!="undefined"){n=i[0]}if(n){i=t.value();var o=false;if(typeof i!="undefined"&&typeof i[0]!="undefined"){o=i[0]}if(n!="U"+s.ID){if(o!=s.ID){t.replaceItem(o,s)}t.readOnly(true)}else{t.readOnly(false)}}this.vars.originatorRestrLock=false},restrictOriginator:function(){if(this.vars.originatorRestrLock){return}this.vars.responsibleRestrLock=true;var t=this.vars.originator;var e=this.vars.responsible;if(t){if(e.count()>1){var s=this.getUser().DATA;var i=t.value();var n=false;if(typeof i!="undefined"&&typeof i[0]!="undefined"){n=i[0]}if(n){t.replaceItem(n,s);if(BX.hasClass(this.control("originator"),"invisible")){this.toggleBlock("originator")}}t.readOnly(true)}else{t.readOnly(false)}}this.vars.responsibleRestrLock=false},disableHints:function(){BX.Tasks.Util.hintManager.disableSeveral(this.option("auxData").HINT_STATE)},fireTaskEvent:function(){const t=this.option("componentData").EVENT_TYPE.toString().toUpperCase();const e=this.option("data").EVENT_TASK;const s=this.option("data").EVENT_TASK_UGLY;const i=this.option("componentData").EVENT_OPTIONS;if(t&&(e||s)){if(t==="ADD"){var n=window.top;n.BX.UI.Notification.Center.notify({content:BX.message("TASKS_NOTIFY_TASK_CREATED"),actions:[{title:BX.message("TASKS_NOTIFY_TASK_DO_VIEW"),events:{click:function(t,e,i){e.close();n.BX.SidePanel.Instance.open(s.url)}}}]});const t={action:"taskAdding",source:"addButton"};if(i.FIRST_GRID_TASK_CREATION_TOUR_GUIDE){t.tourGuide="firstGridTaskCreation"}if(i.SCOPE){t.scope=i.SCOPE}BX.ajax.runAction("tasks.analytics.hit",{analyticsLabel:t})}BX.Tasks.Util.fireGlobalTaskEvent(t,e,i,s)}},doSomeTricks:function(){this.disableHints();this.replaceCmdBtn();var t=this.control("flag-replication");if(t.checked){BX.removeClass(this.control("replication-panel"),"invisible")}},replaceCmdBtn:function(){if(BX.browser.IsMac()){var t=this.control("cmd");if(t){t.innerHTML="&#8984;"}}},bindEditorEvents:function(t,e){BX.addCustomEvent(t,"OnIframeKeyup",e);BX.addCustomEvent(t,"OnTextareaKeyup",e)},setFocusOnTitle:function(t){setTimeout(function(){var e=this.control("title");if(e){t.Focus(false);e.focus();e.selectionStart=e.value.length;BX.focus()}}.bind(this),500)},isEditMode:function(){return this.option("template").EDIT_MODE},bindEvents:function(){this.bindAIEvents();if(!this.isEditMode()){BX.ready(BX.delegate((function(){var t=BX.delegate(this.onFormKeyDown,this);BX.bind(document,"keydown",t);var e=this.option("template").ID;var s=BXHtmlEditor.Get(e);if(s){this.bindEditorEvents(s,t);this.setFocusOnTitle(s,t);this.setEditorTextFromHash()}else{BX.addCustomEvent(window,"OnEditorInitedAfter",BX.delegate((function(i){if(i!=null&&i.id==e){this.bindEditorEvents(i,t);this.setFocusOnTitle(s,t);this.setEditorTextFromHash()}}),this))}}),this))}const t=document.getElementById("tasks-flow-selector");if(t){BX.bind(t,"click",this.showFlowSelector.bind(this,t))}this.bindDelegateControl("toggler","click",this.passCtx(this.onToggleBlock));this.bindDelegateControl("flag","click",this.passCtx(this.onToggleFlag));this.bindDelegateControl("chooser","click",this.passCtx(this.onChooseBlock));this.bindDelegateControl("additional-header","click",this.passCtx(this.onToggleAdditionalBlock));this.bindDelegateControl("priority-cb","change",this.passCtx(this.onPriorityChange));this.bindDelegateControl("pin-footer","click",BX.delegate(this.onPinFooterClick,this));this.bindControl("cancel-button","click",BX.delegate(this.onCancelButtonClick,this));this.bindControl("title","keyup",BX.delegate(this.onTitleChange,this));this.bindControl("to-checklist","click",BX.delegate(this.onToCheckListClick,this));this.bindControl("ai-checklist","click",BX.delegate(this.onAiCheckListClick,this));const e=this.scope().getElementsByClassName("js-id-wg-optbar-flag-match-work-time");if(e.length){BX.bind(e[0],"change",this.passCtx(this.onWorktimeChange))}this.bindControl("form","submit",BX.delegate(this.onFormSubmit,this));this.bindDelegateControl("submit","click",this.passCtx(this.onSubmitClick));this.bindNestedControls();this.bindSliderEvents();BX.Event.EventEmitter.subscribe("BX.Tasks.CheckListItem:CheckListChanged",(t=>{const e=t.data.action;const s=["addAccomplice","fileUpload","tabIn"];if(BX.util.in_array(e,s)){this.analyticsData[e]="Y"}BX("checklistAnalyticsData").value=Object.keys(this.analyticsData).join(",")}));BX.Tasks.Util.hintManager.bindHelp(this.control("options"));BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:projectSelected",BX.delegate(this.onProjectSelected,this));BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:projectDeselected",BX.delegate(this.onProjectDeselected,this));BX.Event.EventEmitter.subscribe("BX.Main.User.SelectorController:itemRendered",BX.delegate(this.onItemRendered,this));var s=BX.Tasks.Component.TasksWidgetMemberSelector.getInstance(this.sys.id+"-project");var i=s.getSelector().getDialog().getPreselectedItems();if(i.length){var n=parseInt(i[0][1],10);this.showScrumFields(n);BX.Event.EventEmitter.emit("BX.Tasks.Component.Task:projectPreselected",{groupId:n})}},bindAIEvents:function(){BX.addCustomEvent("AI.Copilot:save",function(t){if(t.data.code==="create_checklist"){this.onToCheckListClick(t.data.result)}}.bind(this));BX.addCustomEvent("AI.Copilot:add_below",function(t){if(t.data.code==="create_checklist"){this.onToCheckListClick(t.data.result)}}.bind(this))},bindNestedControls:function(){BX.Tasks.Util.Dispatcher.bindEvent(this.option("id")+"-responsible","change",this.onResponsibleChange.bind(this));BX.Tasks.Util.Dispatcher.bindEvent(this.option("id")+"-originator","change",this.onOriginatorChange.bind(this));this.restrictMemberSelectors();this.getDispatcher().bindEvent("options-"+this.option("id"),"toggle",this.processToggleFlag.bind(this))},bindSliderEvents:function(){BX.addCustomEvent("SidePanel.Slider:onLoad",this.setEditorBeforeUnloadEvent.bind(this,true));BX.addCustomEvent("SidePanel.Slider:onClose",this.setEditorBeforeUnloadEvent.bind(this,false));BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate((function(t){if(t.getEventId()==="sonetGroupEvent"){var e=t.getData();if(BX.type.isNotEmptyString(e.code)&&e.code==="afterCreate"&&typeof e.data!="undefined"&&typeof e.data.group!="undefined"){var s=e.data.group;var i=BX.Tasks.Component.TasksWidgetMemberSelector.getInstance(this.sys.id+"-project");i.getSelector().onSelectorItemSelected({id:s.ID,entityType:"SG",networkId:"",DISPLAY:BX.util.htmlspecialcharsback(s.FIELDS.NAME)})}}}),this));BX.addCustomEvent("SidePanel.Slider:onCloseByEsc",(function(t){t.denyAction()}))},setEditorBeforeUnloadEvent:function(t){var e=this.option("template").ID;var s=BXHtmlEditor.Get(e);if(s){t?s.AllowBeforeUnloadHandler():s.DenyBeforeUnloadHandler()}},getTaskData:function(){return this.option("data").TASK},getTaskActions:function(){return this.getTaskData().ACTION},getTaskId:function(){return this.getTaskData().ID??0},getTaskDescription:function(){return(this.option("data").TASK.DESCRIPTION??"").trim()},initProjectDependence:function(){var t=BX.Tasks.Util.Dispatcher.get("projectdependence-"+this.id());t.assignCalendar(this.getCalendar());t.option("task",{data:this.getTaskData()});t.load(this.getTaskData().SE_PROJECTDEPENDENCE,this.getTaskActions().SE_PROJECTDEPENDENCE)},initProjectPlan:function(){this.instances.projectPlan=new BX.Tasks.Shared.Form.ProjectPlan({scope:this.control("date-plan-manager"),parent:this,matchWorkTime:this.getTaskData().MATCH_WORK_TIME==="Y"});this.instances.projectPlan.bindEvent("change-deadline",BX.delegate((function(t,e){if(!this.isEditMode()&&t){this.showExpiredDeadlineHint(e.getTime())}BX.Tasks.Util.Dispatcher.fireEvent("reminder-"+this.id(),"setTaskDeadLine",[t])}),this));if(!this.isEditMode()&&this.getTaskData().DEADLINE_ISO){this.showExpiredDeadlineHint(new Date(this.getTaskData().DEADLINE_ISO).getTime())}},showExpiredDeadlineHint:function(t){if(t<Date.now()){BX.Tasks.Util.hintManager.show(this.instances.projectPlan.getDeadlinePicker().control("display"),BX.message("TASKS_TASK_COMPONENT_TEMPLATE_HINT_DEADLINE_EXPIRED"),null,null,{autoHide:true})}},initParentTask:function(){var t="parenttask";var e=new BX.Tasks.Component.Task.TaskItemSet({id:t+"-"+this.id(),max:1,selectorCode:t,itemFx:"horizontal",itemFxHoverDelete:true,parent:this});e.bindEvent("change",BX.delegate((function(t){this.control("parent-input").value=t.length>0?parseInt(t[0]):""}),this));if(this.getTaskData().SE_PARENTTASK){e.load([this.getTaskData().SE_PARENTTASK])}this.instances[t]=e},initRelatedTask:function(){this.instances["dependson"]=new BX.Tasks.Component.Task.TaskItemSet({id:"dependson-"+this.id(),selectorCode:"dependson",itemFx:"horizontal",itemFxHoverDelete:true,parent:this});if(typeof this.getTaskData().SE_RELATEDTASK!="undefined"){this.instances["dependson"].load(this.getTaskData().SE_RELATEDTASK)}},initReminder:function(){var t=BX.Tasks.Util.Dispatcher.get("reminder-"+this.id());if(t!==null){t.load(this.getTaskData().SE_REMINDER,this.getTaskActions().SE_REMINDER);t.setTaskId(this.getTaskData().ID);t.setTaskDeadLine(this.getTaskData().DEADLINE)}},initState:function(){this.vars.state=BX.clone(this.option("state"));this.redrawState()},onPinFooterClick:function(){var t=!this.vars.state.FLAGS.FORM_FOOTER_PIN;var e=this.control("footer");if(e){BX[t?"addClass":"removeClass"](e,"pinned")}this.setState("FLAGS","FORM_FOOTER_PIN",false,t)},onPriorityChange:function(t){var e=this.control("priority");if(BX.type.isElementNode(e)){e.value=t.checked?this.PRIORITY_HIGH:this.PRIORITY_AVERAGE}},onFormSubmit:function(){var t=this.control("csrf");if(t){t.value=BX.bitrix_sessid()}this.vars.submitting=true},onSubmitClick:function(t,e){if(this.vars.submitting){BX.PreventDefault(e);return}BX.addClass(t,"ui-btn-clock");this.vars.submitting=true},onProjectSelected:function(t){this.showScrumFields(t.data.ID)},onItemRendered:function(t){const e=document.querySelector("input.tasks-task-temporary-crm-input");e&&e.remove()},onProjectDeselected:function(t){var e=this.control("unchosen-blocks");if(!BX.type.isElementNode(e)){return}var s=["EPIC"];s.forEach((function(s){var i=e.querySelector("[data-block-name="+s+"]");setTimeout((function(){if(parseInt(i.dataset.groupId,10)===parseInt(t.data.ID,10)){i.dataset.groupId=0;BX.addClass(i,"hidden")}}),100)}))},showScrumFields:function(t){BX.ajax.runComponentAction("bitrix:tasks.task","needShowEpicField",{mode:"class",data:{groupId:t}}).then(function(e){var s=e.data;var i=this.control("unchosen-blocks");if(!BX.type.isElementNode(i)){return}var n=["EPIC"];if(s){n.forEach((function(e){var s=i.querySelector("[data-block-name="+e+"]");s.dataset.groupId=t;BX.removeClass(s,"hidden")}))}else{n.forEach((function(e){var s=i.querySelector("[data-block-name="+e+"]");s.dataset.groupId=t;BX.addClass(s,"hidden")}))}}.bind(this)).catch(function(t){}.bind(this))},showFlowSelector(t){if(!this.isFeatureEnabled){BX.UI.InfoHelper.show(this.flowLimitCode);return}if(!this.flowSelectorDialog){this.flowSelectorDialog=new BX.UI.EntitySelector.Dialog({targetNode:t,width:350,height:400,multiple:false,dropdownMode:true,enableSearch:true,cacheable:true,preselectedItems:[["flow",this.flowId]],entities:[{id:"flow",options:{onlyActive:true},dynamicLoad:true,dynamicSearch:true}],events:{"Item:onBeforeSelect":t=>{const e=t.getTarget();this.flowSelectedItem=e.getSelectedItems()[0]},"Item:onBeforeDeselect":t=>{const e=t.getTarget();this.flowSelectedItem=e.getSelectedItems()[0]},"Item:onSelect":this.changeFlow.bind(this),"Item:onDeselect":BX.Runtime.debounce(this.unChangeFlow,100,this),"Search:onItemCreateAsync":t=>new Promise((e=>{const{searchQuery:s}=t.getData();const i=t.getTarget();this.createFlow(s.getQuery()).then((t=>{if(t){const s=i.addItem({tabs:"recents",id:t.id,entityId:"flow",title:t.name,customData:{groupId:t.groupId,templateId:t.templateId}});s.select();e()}else{e()}}))}))},searchOptions:{allowCreateItem:true,footerOptions:{label:BX.message("TASKS_TASK_FLOW_SELECTOR_CREATE_BUTTON")}}})}this.flowSelectorDialog.show()},changeFlow(t){const e=t.getTarget();this.changingFlow=true;const s=t.getData().item;const i=parseInt(s.id,10);const n=parseInt(s.customData.get("groupId"),10);const o=parseInt(s.customData.get("templateId"),10);const a=this.shouldShowConfirmChangeFlow(o);window.onbeforeunload=()=>{};const r=()=>{const t=new BX.Uri(decodeURI(location.href));t.setQueryParam("FLOW_ID",i);t.setQueryParam("GROUP_ID",n);if(o){t.setQueryParam("TEMPLATE",o)}else{t.removeQueryParam("TEMPLATE")}t.removeQueryParam("EVENT_TYPE");t.removeQueryParam("EVENT_TASK_ID");t.removeQueryParam("EVENT_OPTIONS");t.removeQueryParam("NO_FLOW");const e=this.option("immutable");Object.entries(e).forEach((([e,s])=>{t.setQueryParam(e,s)}));const s=this.isFeatureTrialable?"Y":"N";t.setQueryParams({ta_cat:"task_operations",ta_sec:"flows",ta_sub:"flows_grid",ta_el:"flow_selector",p1:`isDemo_${s}`});location.href=t.getPath()+t.getQuery()};const l=()=>{e.getItem(this.flowSelectedItem).select(true)};if(a){this.showConfirmChangeFlow(r,l)}else{r()}},unChangeFlow(t){if(this.changingFlow){return}const e=t.getTarget();const s=this.shouldShowConfirmChangeFlow();window.onbeforeunload=()=>{};const i=()=>{const t=new BX.Uri(decodeURI(location.href));t.removeQueryParam("FLOW_ID","GROUP_ID","TEMPLATE");t.removeQueryParam("EVENT_TYPE");t.removeQueryParam("EVENT_TASK_ID");t.removeQueryParam("EVENT_OPTIONS");t.setQueryParam("NO_FLOW",1);const e=this.option("immutable");Object.entries(e).forEach((([e,s])=>{t.setQueryParam(e,s)}));location.href=t.getPath()+t.getQuery()};const n=()=>{e.getItem(this.flowSelectedItem).select(true)};if(s){this.showConfirmChangeFlow(i,n)}else{i()}},showConfirmChangeFlow(t,e){BX.UI.Dialogs.MessageBox.show({message:BX.message("TASKS_TASK_FLOW_CHANGE_MESSAGE"),title:BX.message("TASKS_TASK_FLOW_CHANGE_TITLE"),onOk:()=>{t()},okCaption:BX.message("TASKS_TASK_FLOW_CHANGE_OK_CAPTION"),cancelCallback:t=>{e();t.close()},cancelCaption:BX.message("TASKS_TASK_FLOW_CHANGE_CANCEL_CAPTION"),buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,popupOptions:{events:{onPopupClose:()=>{e()}}}})},shouldShowConfirmChangeFlow(t=0){const e=this.getEditorText().trim();const s=e.length>0;if(!s){return false}if(t>0){return true}return e!==this.getTaskDescription()},createFlow(t){return new Promise(((e,s)=>{top.BX.Runtime.loadExtension("tasks.flow.edit-form").then((s=>{const i=s.EditForm.createInstance({flowName:t});i.subscribe("afterSave",(t=>{e(t.getData())}));i.subscribe("afterClose",(t=>{e()}))}))}))},submit:function(){BX.Tasks.CheckListInstance.getTreeStructure().appendRequestLayout();this.control("form").submit()},onFormKeyDown:function(t){t=t||window.event;var e=false;if(BX.Tasks.Util.isEnter(t)){if((t.ctrlKey||t.metaKey)&&t.type==="keydown"){var s=BX.UI.EntitySelector.Dialog.getById("tasksTagSelector");if(s&&s.isOpen()){return}this.submit();e=true}}if(e){BX.PreventDefault(t)}},onChooseBlock:function(t){var e=this.control("chosen-blocks");var s=this.control("unchosen-blocks");if(!BX.type.isElementNode(e)||!BX.type.isElementNode(s)){return}var i=BX.data(t,"target");if(typeof i!="undefined"&&BX.type.isNotEmptyString(i)){var t=this.control(i);var n=BX.data(t,"block-name");if(BX.type.isNotEmptyString(n)&&BX.type.isElementNode(t)){var o=this.vars.state["BLOCKS"][n];if(typeof o.C!="undefined"){var a=!o.C;var r=this.control(i+"-place",a?e:s);var l=this.control(i+"-place",a?s:e);if(r){if(!a){var c=this.control("additional");if(BX.hasClass(c,"hidden")){BX.removeClass(c,"hidden")}}BX.Tasks.Util.fadeSlideToggleByClass(l,200,(function(){BX.addClass(r,"invisible");BX.append(t,r);BX.Tasks.Util.fadeSlideToggleByClass(r,200);BX.removeClass(l,"invisible")}))}else{BX.toggleClass(t,"pinned")}this.setState("BLOCKS",n,"C",!o.C)}}}},onToggleAdditionalBlock:function(t){var e=BX.hasClass(t,"opened");BX.toggleClass(t,"opened");this.toggleBlock("unchosen-blocks")},onToggleBlock:function(t){const e=BX.data(t,"target");if(typeof e!="undefined"&&BX.type.isNotEmptyString(e)){if(e==="checklist"){var s=this;this.toggleBlock(e).then((function(){if(!BX.hasClass(s.control(e),"invisible")){var t=BX.Tasks.CheckListInstance.getTreeStructure();if(t.getDescendantsCount()===0){BX.Tasks.CheckListInstance.addCheckList().then((function(t){t.addCheckListItem()}))}}}))}else{this.toggleBlock(e)}}},toggleBlock:function(t,e){return BX.Tasks.Util.fadeSlideToggleByClass(this.control(t),e||100)},toggleOption:function(t,e){var s=this.getOptionNode(t);if(s){s.checked=!!e;this.onToggleFlag(s)}},switchOption:function(t,e){var s=this.getOptionNode(t);if(s){s.disabled=!!e}},getOptionNode:function(t){t=t.toLowerCase().replace(/_/g,"-");return this.control("flag-"+t)},onToggleFlag:function(t){var e=BX.data(t,"target");if(typeof e!="undefined"&&BX.type.isNotEmptyString(e)){var s=this.control(e);var i=BX.data(t,"flag-name");if(BX.type.isElementNode(s)){s.value=t.checked?"Y":"N"}const n=this.isLimitExceeded(i);if(n){this.performExceededActions(i,s,t);this.showLimitDialog(this.getFeatureId(i),null,{module:"tasks",source:"taskEdit"})}else{this.processToggleFlag(i,s.value==="Y")}}},isLimitExceeded(t){switch(t){case"REPLICATE":case"SAVE_AS_TEMPLATE":return Boolean(this.option("auxData").TASK_LIMIT_EXCEEDED||this.option("auxData").TASK_RECURRENT_RESTRICT);case"TASK_PARAM_1":case"TASK_PARAM_2":return!this.relatedSubTaskDeadlinesEnabled;case"TASK_PARAM_3":return!this.taskStatusSummaryEnabled;default:return false}},performExceededActions(t,e,s){switch(t){case"REPLICATE":case"SAVE_AS_TEMPLATE":case"TASK_PARAM_1":case"TASK_PARAM_2":case"TASK_PARAM_3":if(e.value==="Y"){e.value="N";s.checked=false}}},getFeatureId(t){switch(t){case"REPLICATE":return"tasks_recurring_tasks";case"SAVE_AS_TEMPLATE":return"tasks_template";case"TASK_PARAM_1":case"TASK_PARAM_2":return"tasks_related_subtask_deadlines";case"TASK_PARAM_3":return"tasks_status_summary";default:return""}},showLimitDialog(t,e,s){return new Promise(((i,n)=>{BX.Runtime.loadExtension("tasks.limit").then((n=>{const{Limit:o}=n;o.showInstance({featureId:t,bindElement:e,limitAnalyticsLabels:s});i()}))}))},processToggleFlag:function(t,e){if(t=="REPLICATE"){var s=this.option("auxData").TASK_LIMIT_EXCEEDED;var i=this.option("auxData").TASK_RECURRENT_RESTRICT;if(!s||s&&!e||(!i||i&&!e)){BX.Tasks.Util.fadeSlideToggleByClass(this.control("replication-panel"));this.toggleOption("SAVE_AS_TEMPLATE",e);this.switchOption("SAVE_AS_TEMPLATE",e)}}else if(t==="REGULAR"){BX.Tasks.Util.fadeSlideToggleByClass(this.control("regular-panel"))}else if(t=="TASK_PARAM_1"){this.toggleDateParameters(e)}this.setState("FLAGS",t,false,e)},toggleDateParameters:function(t){BX[t?"addClass":"removeClass"](this.control("date-plan"),"disabled-block");BX.Tasks.Util.Dispatcher.find("options-"+this.option("id")).then(function(e){e.switchOption("MATCH_WORK_TIME",!t)}.bind(this))},onOriginatorChange:function(){BX.Tasks.Util.Dispatcher.find(this.option("id")+"-originator").then(function(t){if(t.count()&&t.value()){var e="U"+this.getUser().DATA.ID.toString()==t.value()[0].toString();BX.Tasks.Util.Dispatcher.find("options-"+this.option("id")).then(function(t){t.switchOption("ADD_TO_TIMEMAN",e)}.bind(this))}}.bind(this))},onResponsibleChange:function(){BX.Tasks.Util.Dispatcher.find(this.option("id")+"-responsible").then(function(t){if(t.count()>1){BX.Tasks.Util.hintManager.showDisposable(t.scope(),BX.message("TASKS_TASK_COMPONENT_TEMPLATE_MULTIPLE_ASSIGNEE_NOTICE"),"TASK_EDIT_MULTIPLE_RESPONSIBLES")}else{BX.Tasks.Util.hintManager.hide("TASK_EDIT_MULTIPLE_RESPONSIBLES")}if(t.count()>0&&!this.isFlowForm){var e=this.control("absence-message");e.style.display="none";while(e.lastChild){e.removeChild(e.lastChild)}BX.ajax.runComponentAction("bitrix:tasks.widget.member.selector","isAbsence",{mode:"class",data:{userIds:t.value().map((function(t){return t.substring(1)}))}}).then(function(t){if(!t.status||t.status!=="success"){return}if(!t.data.length){return}var s=t.data.reduce((function(t,e){return t+"<br />"+e}));var i=new BX.UI.Alert({icon:BX.UI.Alert.Icon.INFO,color:BX.UI.Alert.Color.WARNING,text:s});e.appendChild(i.getContainer());e.style.display="block"}.bind(this),function(t){}.bind(this))}}.bind(this))},onCancelButtonClick:function(t){if(this.option("cancelActionIsEvent")){BX.Tasks.Util.fireGlobalTaskEvent("NOOP",{},{STAY_AT_PAGE:false});BX.PreventDefault(t)}},onWorktimeChange:function(t){this.checkNoWorkDays(t.checked);this.instances.projectPlan.setMatchWorkTime(t.checked)},checkNoWorkDays:function(t){if(!t){if(BX.type.isElementNode(BX("date-plan-alert"))){BX("date-plan-alert").remove()}return false}var e=true;var s=this.getCalendar();var i=s.weekends;var n=[0,1,2,3,4,5,6];n.forEach((function(t){if(!(t in i)){e=false}}));if(e&&!BX.type.isElementNode(BX("date-plan-alert"))){var o=BX.create("div",{props:{id:"date-plan-alert",className:"ui-alert ui-alert-danger"},attrs:{style:"margin-top: 10px"},children:[BX.create("span",{props:{className:"ui-alert-message"},text:BX.message("TASKS_TASK_COMPONENT_TEMPLATE_NO_WORK_DAYS_ERROR")})]});this.control("date-plan-manager").appendChild(o)}return e},onTitleChange:function(){var t=this.control("title");if(t.value.length>250){BX.addClass(t,"task-field-error")}else{BX.removeClass(t,"task-field-error")}},showToCheckListHintNoItems:function(){var t=new BX.PopupWindow({bindElement:this.control("to-checklist"),content:BX.message("TASKS_TASK_COMPONENT_TEMPLATE_TO_CHECKLIST_HINT"),className:"tasks-to-checklist-popup",darkMode:true,autoHide:true,closeByEsc:true,angle:true,offsetLeft:this.control("to-checklist").offsetWidth/2,events:{onPopupClose:function(){this.destroy()}}});t.show();setTimeout((function(){t.close()}),2e3)},showToCheckListHintCreated:function(){var t=new BX.PopupWindow({bindElement:this.control("to-checklist"),content:BX.message("TASKS_TASK_COMPONENT_TEMPLATE_TO_CHECKLIST_HINT_CREATED"),className:"tasks-to-checklist-popup",darkMode:true,autoHide:true,closeByEsc:true,angle:true,offsetLeft:this.control("to-checklist").offsetWidth/2,events:{onPopupClose:function(){this.destroy()}}});t.show();setTimeout((function(){t.close()}),2e3)},setEditorTextFromHash:function(){const t=decodeURIComponent(location.hash.slice(1));history.replaceState(null,null," ");this.setEditorText(t.trim())},setEditorText:function(t){const e=this.option("template").ID;const s=BXHtmlEditor.Get(e);if(BX.Type.isStringFilled(t)){s.SetContent(t)}},getEditorSelectedText:function(){var t="";var e=this.control("editor-container");var s=e.querySelector(".bxhtmled-iframe-cnt").style.display==="none";if(s){var i=e.querySelector(".bxhtmled-textarea");var n=i.selectionStart;var o=i.selectionEnd;t=i.value.substring(n,o)}else{var a=e.querySelector(".bx-editor-iframe").contentDocument;if(a.getSelection){t=a.getSelection().toString()}else if(a.selection){t=a.selection.createRange().text}}return t},getEditorText:function(){const t=this.control("editor-container");const e=t.querySelector(".bxhtmled-iframe-cnt").style.display==="none";if(e){const e=t.querySelector(".bxhtmled-textarea");return e.value}const s=t.querySelector(".bx-editor-iframe").contentDocument;return s.body.innerText},getTitlesFromText:function(t){if(t===""){return[]}return t.split(/\r\n|\r|\n/g)},onToCheckListClick:function(t=""){if(typeof t!=="string"||typeof t==="string"&&t===""){t=this.getEditorSelectedText()}var e=this.getTitlesFromText(t);if(e.length<=0){this.showToCheckListHintNoItems();return}var s=BX.Tasks.CheckListInstance.getTreeStructure();if(s.getDescendantsCount()===0){var i=this.getCheckListItemsFromTitles(e);BX.Tasks.CheckListInstance.addCheckList().then(function(t){i.forEach((function(e){t.addCheckListItem(e)}));t.handleTaskOptions();BX("checklistFromDescription").value="fromDescription";this.showToCheckListHintCreated()}.bind(this));if(BX.hasClass(this.control("checklist"),"invisible")){this.toggleBlock("checklist")}}else{var n=new BX.PopupMenuWindow({bindElement:this.control("to-checklist"),items:this.getToCheckListPopupMenuItems(e)});n.show()}},onAiCheckListClick:async function(t){if(this.option("canUseAIChecklistButton")){this.getAiCommandExecutorPromise??=this.getAiCommandExecutor();const e=await this.getAiCommandExecutorPromise;if(e.isProcessing){return}const s=t.target.parentElement;BX.Dom.addClass(s,"tasks-btn-ai-checklist-wait");e.isProcessing=true;e.makeChecklistFromText(this.getEditorText()||"empty").then((t=>{const e=this.getTitlesFromText(t);const s=this.getCheckListItemsFromTitles(e);BX.Tasks.CheckListInstance.addCheckList().then((t=>{s.forEach((e=>t.addCheckListItem(e)));t.handleTaskOptions()}));this.openCheckLists()})).catch((async t=>{const{AjaxErrorHandler:e}=await BX.Runtime.loadExtension("ai.ajax-error-handler");e?.handleTextGenerateError({baasOptions:{bindElement:s,context:"tasks_field_checklist",useAngle:false},errorCode:t?.errors?.[0]?.code??"undefined_error"})})).finally((()=>{BX.Dom.removeClass(s,"tasks-btn-ai-checklist-wait");e.isProcessing=false}))}else{BX.UI.InfoHelper.show("limit_copilot_off",{isLimit:true})}},getAiCommandExecutor:async function(){if(!this.aiCommandExecutor){const{CommandExecutor:t}=await BX.Runtime.loadExtension("ai.command-executor");this.aiCommandExecutor=new t({moduleId:"tasks",contextId:"tasks_field_checklist"})}return this.aiCommandExecutor},openCheckLists:function(){if(BX.hasClass(this.control("checklist"),"invisible")){this.toggleBlock("checklist")}},getToCheckListPopupMenuItems:function(t){var e=this;var s=BX.Tasks.CheckListInstance.getTreeStructure();var i=[{text:"+ "+BX.message("TASKS_TASK_COMPONENT_TEMPLATE_TO_CHECKLIST_ADD_NEW_CHECKLIST"),onclick:function(s,i){i.getMenuWindow().close();var n=e.getCheckListItemsFromTitles(t);BX.Tasks.CheckListInstance.addCheckList().then((function(t){n.forEach((function(e){t.addCheckListItem(e)}));t.handleTaskOptions();BX("checklistFromDescription").value="fromDescription";e.showToCheckListHintCreated()}));if(BX.hasClass(e.control("checklist"),"invisible")){e.toggleBlock("checklist")}}},{delimiter:true}];s.getDescendants().forEach((function(s){i.push({text:s.fields.getTitle(),onclick:function(i,n){n.getMenuWindow().close();var o=e.getCheckListItemsFromTitles(t);o.forEach((function(t){s.addCheckListItem(t)}));o[0].handleTaskOptions();BX("checklistFromDescription").value="fromDescription";e.showToCheckListHintCreated();if(BX.hasClass(e.control("checklist"),"invisible")){e.toggleBlock("checklist")}}})}));return i},getCheckListItemsFromTitles:function(t){var e=[];t.forEach((function(t){t=t.trim().substring(0,255).trim();if(t.length>0){var s=new BX.Tasks.CheckListItem({TITLE:t});e.push(s)}}));return e},getCalendar:function(){if(this.instances.calendar==false){this.instances.calendar=new BX.Tasks.Calendar(BX.Tasks.Calendar.adaptSettings(this.option("auxData").COMPANY_WORKTIME))}return this.instances.calendar},getState:function(t,e,s){if(t=="BLOCKS"){return this.vars.state[t][e][s]}if(t=="FLAGS"){return this.vars.state[t][e]}},setState:function(t,e,s,i){if(!BX.type.isNotEmptyString(e)){return}if(t=="FLAGS"){var n={ALLOW_TIME_TRACKING:true,TASK_CONTROL:true,ALLOW_CHANGE_DEADLINE:true,MATCH_WORK_TIME:true,FORM_FOOTER_PIN:true,REQUIRE_RESULT:true,TASK_PARAM_3:true};if(!(e in n)){return}}if(typeof this.vars.state[t]=="undefined"){this.vars.state[t]={}}if(typeof this.vars.state[t][e]=="undefined"){this.vars.state[t][e]={}}if(t=="BLOCKS"){this.vars.state[t][e][s]=i}if(t=="FLAGS"){this.vars.state[t][e]=i}this.submitState();this.redrawState()},submitState:function(){var t=BX.clone(this.vars.state);var e=t.FLAGS.FORM_FOOTER_PIN;delete t.FLAGS;t.FLAGS={FORM_FOOTER_PIN:e};BX.ajax.runComponentAction("bitrix:tasks.task","setState",{mode:"class",data:{state:t,isFlowForm:this.isFlowForm}}).then(function(t){}.bind(this)).catch(function(t){}.bind(this))},redrawState:function(){var t=this.control("state");if(BX.type.isElementNode(t)){var e="";if(typeof this.vars.state["BLOCKS"]!="undefined"){for(var s in this.vars.state["BLOCKS"]){var i=this.vars.state["BLOCKS"][s]["O"];var n=this.vars.state["BLOCKS"][s]["C"];if(typeof i!="undefined"){e+=this.getHTMLByTemplate("state-block",{NAME:s,TYPE:"O",VALUE:i===true||i==="true"?"1":"0"})}if(typeof n!="undefined"){e+=this.getHTMLByTemplate("state-block",{NAME:s,TYPE:"C",VALUE:n===true||n==="true"?"1":"0"})}}}if(typeof this.vars.state["FLAGS"]!="undefined"){for(var o in this.vars.state["FLAGS"]){var a=this.vars.state["FLAGS"][o];e+=this.getHTMLByTemplate("state-flag",{NAME:o,VALUE:a===true||a==="true"?"1":"0"})}}t.innerHTML=e}},clearNewAnalyticsParams:function(){const t=new URL(window.location.href);const e=t.searchParams.get("ta_sec");if(e){t.searchParams.delete("ta_cat");t.searchParams.delete("ta_sec");t.searchParams.delete("ta_sub");t.searchParams.delete("ta_el");t.searchParams.delete("p1");t.searchParams.delete("p2");t.searchParams.delete("p3");t.searchParams.delete("p4");t.searchParams.delete("p5");window.history.replaceState(null,null,t.toString())}}}});BX.Tasks.Component.Task.UserItemSet=BX.Tasks.UserItemSet.extend({methods:{onSearchBlurred:function(){if(this.callMethod(BX.Tasks.UserItemSet,"onSearchBlurred")){this.restoreKept()}},restoreKept:function(){if(this.vars.toDelete){this.addItem(this.vars.toDelete,{checkRestrictions:false});this.vars.toDelete=false}},onSelectorItemSelected:function(t){var e=this.extractItemValue(t);if(!this.hasItem(e)){var s=this.option("max");this.addItem(t);this.vars.toDelete=false;if(s==1){this.instances.selector.close();this.onSearchBlurred()}}this.resetInput()},openAddForm:function(t,e,s){var i=this.option("min");var n=this.option("max");if(s||n==1&&(i==0||i==1)){var o=this.getItemFirst();if(o){this.vars.toDelete=o.data();this.callMethod(BX.Tasks.UserItemSet,"deleteItem",[o.value(),{checkRestrictions:false}])}}this.callMethod(BX.Tasks.UserItemSet,"openAddForm")},deleteItem:function(t){if(!this.callMethod(BX.Tasks.UserItemSet,"deleteItem",arguments)){this.openAddForm(false,false,true);return false}return true}}});BX.Tasks.Component.Task.GroupItemSet=BX.Tasks.Component.Task.UserItemSet.extend({sys:{code:"group-item-set"},methods:{extractItemDisplay:function(t){return t.NAME||BX.util.htmlspecialcharsback(t.nameFormatted)},getNSMode:function(){return"group"}}});BX.Tasks.Component.Task.TaskItemSet=BX.Tasks.PopupItemSet.extend({sys:{code:"task-item-set"},options:{itemFx:"horizontal"},methods:{construct:function(){this.callConstruct(BX.Tasks.PopupItemSet);this.instances.selector=window["O_"+this.option("selectorCode")]},extractItemDisplay:function(t){if(typeof t.DISPLAY!="undefined"){return t.DISPLAY}if(typeof t.name!="undefined"){return t.name}return t.TITLE+" ["+t.ID+"]"},extractItemValue:function(t){return typeof t.ID=="undefined"?t.id:t.ID},bindFormEvents:function(){if(typeof this.instances.selector!="undefined"&&this.instances.selector!=null&&this.instances.selector!=false){BX.addCustomEvent(this.instances.selector,"on-change",BX.delegate(this.itemsChanged,this));if(typeof this.instances.window!="undefined"){var t=this.instances.selector;BX.addCustomEvent(this.instances.window,"onAfterPopupShow",(function(){setTimeout((function(){t.searchInput.focus()}),100)}))}}},deleteItem:function(t,e){var s=BX.type.isNumber(t)||BX.type.isString(t)?t:t.value();if(this.callMethod(BX.Tasks.PopupItemSet,"deleteItem",arguments)){this.instances.selector.unselect(s)}}}})}).call(this);
//# sourceMappingURL=logic.map.js