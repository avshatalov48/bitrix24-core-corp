"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TaskView!="undefined"){return}BX.Tasks.Component.TaskView=function(t){this.parameters=t||{};this.taskId=this.parameters.taskId;this.userId=this.parameters.userId;this.layout={favorite:BX("task-detail-favorite"),switcher:BX("task-switcher"),switcherTabs:[],elapsedTime:BX("task-switcher-elapsed-time"),effective:BX("task-switcher-effective"),createButton:BX("task-detail-create-button"),importantButton:BX("task-detail-important-button"),saveButton:BX("saveButton"),cancelButton:BX("cancelButton")};this.openTime=this.parameters.componentData.OPEN_TIME;this.analyticsData={};this.timeout=0;this.timeoutSec=2e3;this.paramsToLazyLoadTabs=t.paramsToLazyLoadTabs||{};this.listTabIdUploadedContent={};this.messages=this.parameters.messages||{};for(var e in this.messages){BX.message[e]=this.messages[e]}this.paths=this.parameters.paths||{};this.createButtonMenu=[];this.checkListChanged=false;this.showCloseConfirmation=false;this.isTemplatesAvailable=t.isTemplatesAvailable;this.isCopilotEnabled=t.isCopilotEnabled;this.copilotParams=t.copilotParams;this.taskTimeElapsedEnabled=t.taskTimeElapsedEnabled;this.taskTimeElapsedFeatureId=t.taskTimeElapsedFeatureId;this.flowParams=t.flowParams;this.toggleFlowParams=t.toggleFlowParams;this.isExtranetUser=t.isExtranetUser;this.canEditTask=t.canEditTask;BX.addCustomEvent(window,"tasksTaskEvent",this.onTaskEvent.bind(this));BX.addCustomEvent("SidePanel.Slider:onClose",this.onSliderClose.bind(this,false));BX.addCustomEvent("SidePanel.Slider:onCloseByEsc",this.onSliderClose.bind(this,true));BX.addCustomEvent(window,"OnUCCommentWasRead",this.onCommentRead.bind(this));BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"tasks",command:"tag_changed",callback:function(){BX.ajax.runComponentAction("bitrix:tasks.tag.list","getTaskTags",{mode:"class",data:{taskId:this.taskId}}).then((function(t){var e=BX("task-tags-line");BX.cleanNode(e);var s=t.data;var a=s.join(", ");BX.adjust(e,{text:a})}))}.bind(this)});BX.Event.EventEmitter.subscribe("BX.Tasks.CheckListItem:CheckListChanged",function(t){var e=t.data.action;var s=["addAccomplice","fileUpload","tabIn"];if(BX.util.in_array(e,s)){this.analyticsData[e]="Y"}this.toggleFooterWrap(true)}.bind(this));this.initFlowSelector();this.initFavorite();this.initCreateButton();this.initSwitcher();this.initViewer();this.initAjaxErrorHandler();this.initImportantButton();this.initFooterButtons();this.initCommentActionController();this.extendWatch();this.handleEvent();this.clearNewAnalyticsParams();this.temporalCommentFix();if(!!window.mplCheckForQuote&&BX("task-detail-author-info")){BX.bind(BX("task-detail-content"),"mouseup",(t=>{const e=`TASK_${this.taskId}`;const s="task-detail-author-info";const a=this.isCopilotEnabled?this.copilotParams:null;window.mplCheckForQuote(t,t.currentTarget,e,s,{copilotParams:a})}))}};BX.Tasks.Component.TaskView.prototype.initFlowSelector=function(){const t=document.getElementById("tasks-flow-selector-container");if(!t){return}const e={taskId:this.taskId,canEditTask:this.canEditTask,isExtranet:this.isExtranetUser,toggleFlowParams:this.toggleFlowParams,flowParams:this.flowParams};this.flowSelector=new BX.Tasks.Flow.EntitySelector(e);this.flowSelector.show(t)};BX.Tasks.Component.TaskView.prototype.extendWatch=function(){BX.PULL.extendWatch("TASK_VIEW_"+this.taskId,true);setTimeout(function(){this.extendWatch()}.bind(this),29*60*1e3)};BX.Tasks.Component.TaskView.prototype.onSliderClose=function(t,e){if(!this.checkListChanged||typeof BX.Tasks.CheckListInstance==="undefined"){return}var s=BX.Tasks.CheckListInstance.optionManager.slider;if(!s||s!==e.getSlider()||!this.isChecklistSidePanel(s.getUrl())){return}if(t){var a=BX.Tasks.CheckListInstance.getTreeStructure();if(a&&a.checkActiveUpdateExist()){e.denyAction();return}}if(!this.showCloseConfirmation){this.showCloseConfirmation=true;return}e.denyAction();this.showChecklistCloseSliderPopup(s)};BX.Tasks.Component.TaskView.prototype.isChecklistSidePanel=function(t){var e=false;var s=[new RegExp("/company/personal/user/(\\d+)/tasks/task/view/(\\d+)/","i"),new RegExp("/workgroups/group/(\\d+)/tasks/task/view/(\\d+)/","i"),new RegExp("/extranet/contacts/personal/user/(\\d+)/tasks/task/view/(\\d+)/","i")];s.forEach((function(s){if(t.match(s)){e=true}}));return e};BX.Tasks.Component.TaskView.prototype.showChecklistCloseSliderPopup=function(t){if(!this.checklistCloseSliderPopup){this.checklistCloseSliderPopup=new BX.PopupWindow({titleBar:BX.message("TASKS_CLOSE_SLIDER_CONFIRMATION_POPUP_HEADER"),content:BX.message("TASKS_CLOSE_SLIDER_CONFIRMATION_POPUP_CONTENT"),closeIcon:false,buttons:[new BX.PopupWindowButton({text:BX.message("TASKS_CLOSE_SLIDER_CONFIRMATION_POPUP_BUTTON_CLOSE"),className:"popup-window-button-accept",events:{click:function(){this.showCloseConfirmation=false;this.checklistCloseSliderPopup.close();t.close()}.bind(this)}}),new BX.PopupWindowButton({className:"popup-window-button popup-window-button-link",text:BX.message("TASKS_CLOSE_SLIDER_CONFIRMATION_POPUP_BUTTON_CANCEL"),events:{click:function(){this.checklistCloseSliderPopup.close()}.bind(this)}})]})}this.checklistCloseSliderPopup.show()};BX.Tasks.Component.TaskView.prototype.onCommentRead=function(t,e){if(t==="TASK_"+this.taskId&&this.timeout<=0){this.timeout=setTimeout(this.readComments.bind(this),this.timeoutSec)}};BX.Tasks.Component.TaskView.prototype.readComments=function(){this.timeout=0;BX.ajax.runAction("tasks.task.view.update",{data:{taskId:this.taskId}})};BX.Tasks.Component.TaskView.prototype.temporalCommentFix=function(){BX.addCustomEvent(window,"OnUCFormResponse",(function(t,e,s){if(BX.type.isNotEmptyString(t)&&t.indexOf("TASK_")===0&&BX.proxy_context&&BX.proxy_context.jsonFailure===true){if(s&&s["handler"]&&s.handler["oEditor"]&&s.handler.oEditor["DenyBeforeUnloadHandler"]){s.handler.oEditor.DenyBeforeUnloadHandler()}BX.reload()}}))};BX.Tasks.Component.TaskView.prototype.handleEvent=function(){var t=this.parameters.componentData.EVENT_TYPE;var e=this.parameters.componentData.EVENT_OPTIONS;if(t==="ADD"){var s={action:"taskAdding",source:"addButton"};if(e.FIRST_GRID_TASK_CREATION_TOUR_GUIDE){s.tourGuide="firstGridTaskCreation"}if(e.SCOPE){s.scope=e.SCOPE}BX.ajax.runAction("tasks.analytics.hit",{analyticsLabel:s})}this.fireTaskEvent(t,e)};BX.Tasks.Component.TaskView.prototype.fireTaskEvent=function(t,e){var s=this;if(this.parameters.eventTaskUgly!=null){if(t==="ADD"){var a=window.top;a.BX.UI.Notification.Center.notify({content:BX.message("TASKS_NOTIFY_TASK_CREATED"),actions:[{title:BX.message("TASKS_NOTIFY_TASK_DO_VIEW"),events:{click:function(t,e,i){e.close();a.BX.SidePanel.Instance.open(s.parameters.eventTaskUgly.url)}}}]})}BX.Tasks.Util.fireGlobalTaskEvent(t,{ID:this.parameters.eventTaskUgly.id},{STAY_AT_PAGE:e.STAY_AT_PAGE!=false},this.parameters.eventTaskUgly)}};BX.Tasks.Component.TaskView.prototype.initImportantButton=function(){if(this.parameters.can.TASK.ACTION.EDIT){BX.bind(this.layout.importantButton,"click",BX.Tasks.passCtx(this.onImportantButtonClick,this))}};BX.Tasks.Component.TaskView.prototype.initCreateButton=function(){BX.bind(this.layout.createButton,"click",this.onCreateButtonClick.bind(this));const t=this.paths;const e=this.parameters.groupId;const s=this.messages;const a=BX.Uri.addParam(t.newTask,{ta_sec:"tasks",ta_sub:"task_card",ta_el:"create_button"});const i=BX.Uri.addParam(t.newSubTask,{ta_sec:"tasks",ta_sub:"task_card",ta_el:"create_button"});this.createButtonMenu=[{text:s.addTask,className:"menu-popup-item menu-popup-no-icon",href:a}];if(this.isTemplatesAvailable){this.createButtonMenu.push({text:s.addTaskByTemplate,className:"menu-popup-item menu-popup-no-icon menu-popup-item-submenu",cacheable:true,items:[{id:"loading",text:s.tasksAjaxLoadTemplates}],events:{onSubMenuShow:function(){if(this.isSubMenuLoaded){return}BX.ajax.runComponentAction("bitrix:tasks.templates.list","getList",{mode:"class",data:{select:["ID","TITLE"],order:{ID:"DESC"},filter:{ZOMBIE:"N"}}}).then(function(t){this.isSubMenuLoaded=true;this.getSubMenu().removeMenuItem("loading");const i=[];if(t.data.length>0){const s=a+(a.indexOf("?")!==-1?"&":"?")+(e>0?"GROUP_ID="+e+"&":"")+"TEMPLATE=";BX.Tasks.each(t.data,(function(t,e){i.push({text:BX.util.htmlspecialchars(t.TITLE),href:s+t.ID})}))}else{i.push({text:s.tasksAjaxEmpty})}this.addSubMenu(i);this.showSubMenu()}.bind(this),function(){this.isSubMenuLoaded=true;this.getSubMenu().removeMenuItem("loading");this.addSubMenu([{text:s.tasksAjaxErrorLoad}]);this.showSubMenu()}.bind(this))}}})}this.createButtonMenu.push({delimiter:true},{text:s.addSubTask,className:"menu-popup-item menu-popup-no-icon",href:i});if(this.isTemplatesAvailable){this.createButtonMenu.push({delimiter:true},{text:s.listTaskTemplates,className:"menu-popup-item menu-popup-no-icon",href:t.taskTemplates,target:"_top"})}};BX.Tasks.Component.TaskView.prototype.initFooterButtons=function(){BX.bind(this.layout.saveButton,"click",this.onSaveButtonClick.bind(this));BX.bind(this.layout.cancelButton,"click",this.onCancelButtonClick.bind(this))};BX.Tasks.Component.TaskView.prototype.onSaveButtonClick=function(){if(this.isSaving){return}this.isSaving=true;BX.Tasks.CheckListInstance.activateLoading();BX.Tasks.CheckListInstance.onSave();this.saveCheckList()};BX.Tasks.Component.TaskView.prototype.saveCheckList=function(){var t=this;var e=BX.Tasks.CheckListInstance.getTreeStructure();BX.ajax.runComponentAction("bitrix:tasks.widget.checklist.new","saveChecklist",{mode:"class",data:{taskId:this.taskId,items:e.getRequestData(),params:{analyticsData:Object.assign(this.analyticsData,{checklistCount:e.getDescendantsCount()})}}}).then(function(e){var s=e.data;var a=s.PREVENT_CHECKLIST_SAVE;if(a){var i=new BX.PopupWindow({titleBar:"Warning",content:a,closeIcon:false,buttons:[new BX.PopupWindowButton({className:"popup-window-button",text:"OK",events:{click:function(){i.close();BX.Tasks.CheckListInstance.deactivateLoading();BX.removeClass(BX("saveButton"),"ui-btn-wait")}}})],events:{onPopupClose:function(){this.destroy()}}});i.show()}else{var n=s.OPEN_TIME;var o=s.TRAVERSED_ITEMS;if(o){var r=BX.Tasks.CheckListInstance.getTreeStructure();Object.keys(o).forEach((function(t){var e=r.findChild(t);if(e!=="undefined"&&e.fields.getId()===null){e.fields.setId(o[t].ID)}}))}if(n){this.openTime=n}this.analyticsData={};BX.Tasks.CheckListInstance.saveStableTreeStructure();BX.Tasks.CheckListInstance.deactivateLoading();t.toggleFooterWrap(false);this.isSaving=false}}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors);this.isSaving=false;BX.Tasks.CheckListInstance.deactivateLoading()}}.bind(this))};BX.Tasks.Component.TaskView.prototype.onCancelButtonClick=function(t){if(this.isSaving){return}var e=this;var s=new BX.PopupWindow({titleBar:BX.message("TASKS_DISABLE_CHANGES_CONFIRMATION_POPUP_HEADER"),content:BX.message("TASKS_DISABLE_CHANGES_CONFIRMATION_POPUP_CONTENT"),closeIcon:false,buttons:[new BX.PopupWindowButton({text:BX.message("TASKS_DISABLE_CHANGES_CONFIRMATION_POPUP_BUTTON_YES"),className:"popup-window-button-accept",events:{click:function(){s.close();if(BX.Tasks.CheckListInstance!=="undefined"){BX.Tasks.CheckListInstance.rerender()}e.toggleFooterWrap(false)}}}),new BX.PopupWindowButton({className:"popup-window-button popup-window-button-link",text:BX.message("TASKS_DISABLE_CHANGES_CONFIRMATION_POPUP_BUTTON_NO"),events:{click:function(){s.close()}}})],events:{onPopupClose:function(){this.destroy()}}});s.show()};BX.Tasks.Component.TaskView.prototype.onImportantButtonClick=function(t){const e=parseInt(BX.data(t,"priority"));const s=e===2?1:2;BX.ajax.runComponentAction("bitrix:tasks.task","setPriority",{mode:"class",data:{taskId:this.taskId,priority:s}}).then(function(e){BX.data(t,"priority",s);BX.toggleClass(t,"no")}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors)}}.bind(this))};BX.Tasks.Component.TaskView.prototype.onCreateButtonClick=function(){BX.PopupMenu.show("task-detail-create-button",this.layout.createButton,this.createButtonMenu,{angle:{position:"top",offset:40}})};BX.Tasks.Component.TaskView.prototype.onTaskEvent=function(t,e){e=e||{};var s=e.task||{};if(t==="UPDATE"&&s.ID==this.parameters.taskId){if(BX.type.isNotEmptyString(s.REAL_STATUS)){this.setStatus(s.REAL_STATUS)}}if(t==="ADD"){if(this.taskId===e.taskUgly.parentTaskId){window.location.href=this.paths.taskView}}};BX.Tasks.Component.TaskView.prototype.setStatus=function(t){var e=BX("task-detail-status-below-name");if(e){var s=BX.Loc.hasMessage("TASKS_STATUS_"+t+"_MSGVER_1")?BX.message("TASKS_STATUS_"+t+"_MSGVER_1"):BX.message("TASKS_STATUS_"+t);e.innerHTML=s.substr(0,1).toLowerCase()+s.substr(1)}};BX.Tasks.Component.TaskView.prototype.initFavorite=function(){BX.bind(this.layout.favorite,"click",BX.proxy(this.onFavoriteClick,this))};BX.Tasks.Component.TaskView.prototype.onFavoriteClick=function(){var t=BX.hasClass(this.layout.favorite,"task-detail-favorite-active")?"deleteFavorite":"addFavorite";BX.ajax.runComponentAction("bitrix:tasks.task",t,{mode:"class",data:{taskId:this.taskId}}).then(function(t){BX.toggleClass(this.layout.favorite,"task-detail-favorite-active")}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors)}}.bind(this))};BX.Tasks.Component.TaskView.prototype.initSwitcher=function(){BX.Event.EventEmitter.emit("BX.Tasks.TaskView:onBeforeInitSwitcher",{taskId:this.taskId,projectId:this.parameters.project.ID?Number(this.parameters.project.ID):0,taskSwitcherTabs:document.getElementById("task-switcher"),taskSwitcherBlocks:document.getElementsByClassName("task-comments-and-log")[0]});if(!this.layout.switcher){return}var t=this.layout.switcher.getElementsByClassName("task-switcher");var e=this.layout.switcher.parentNode.getElementsByClassName("task-switcher-block");for(var s=0;s<t.length;s++){var a=t[s],i=a.dataset.id;var n=e[s];BX.bind(a,"click",BX.proxy(this.onSwitch,this));this.layout.switcherTabs.push({title:a,block:n});this.listTabIdUploadedContent[i]=false;switch(i){case"files":BX.addCustomEvent("OnUCAfterRecordAdd",BX.proxy(this.onUCAfterRecordAdd,this));break}}BX.addCustomEvent("TaskElapsedTimeUpdated",BX.proxy((function(t,e,s,a){this.layout.elapsedTime.innerText=BX.Tasks.Util.formatTimeAmount(a.time)}),this))};BX.Tasks.Component.TaskView.prototype.onSwitch=function(){var t=BX.proxy_context;if(BX.hasClass(t,"task-switcher-selected")){return false}if(this.isTabLimitExceeded(t.dataset.id)){this.showTabLimit(t.dataset.id);return false}switch(t.dataset.id){default:this.switchTabStyle(t);break;case"files":this.getTabContent(t);break}return false};BX.Tasks.Component.TaskView.prototype.isTabLimitExceeded=function(t){switch(t){case"time":return!this.taskTimeElapsedEnabled;default:return false}};BX.Tasks.Component.TaskView.prototype.showTabLimit=function(t){switch(t){case"time":BX.Runtime.loadExtension("tasks.limit").then((t=>{const{Limit:e}=t;e.showInstance({featureId:this.taskTimeElapsedFeatureId,limitAnalyticsLabels:{module:"tasks",source:"taskViewTabs"}})}));break}};BX.Tasks.Component.TaskView.prototype.getTabContent=function(t){var e=t.dataset.id;if(!this.paramsToLazyLoadTabs.hasOwnProperty(e)){return}if(this.listTabIdUploadedContent[e]){this.switchTabStyle(t)}else if(e==="files"){BX.ajax.runComponentAction("bitrix:tasks.task","getFiles",{mode:"class",data:{taskId:this.parameters.taskId}}).then(function(s){var a=s.data;if(a.asset&&a.html&&BX.type.isNotEmptyString(a.html)){BX.html(null,a.asset.join(" ")).then(function(){this.listTabIdUploadedContent[e]=true;BX("task-"+e+"-block").innerHTML=a.html;BX.ajax.processScripts(BX.processHTML(a.html).SCRIPT);this.switchTabStyle(t)}.bind(this))}}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors)}}.bind(this))}};BX.Tasks.Component.TaskView.prototype.switchTabStyle=function(t){for(var e=0;e<this.layout.switcherTabs.length;e++){var s=this.layout.switcherTabs[e].title;var a=this.layout.switcherTabs[e].block;if(s===t){BX.addClass(s,"task-switcher-selected");BX.addClass(a,"task-switcher-block-selected")}else{BX.removeClass(s,"task-switcher-selected");BX.removeClass(a,"task-switcher-block-selected")}}};BX.Tasks.Component.TaskView.prototype.onUCAfterRecordAdd=function(t,e){if(e.hasOwnProperty("messageFields")){var s=e.messageFields.UF,a;if(s&&s["UF_FORUM_MESSAGE_DOC"]){a=s["UF_FORUM_MESSAGE_DOC"];if(BX.type.isArray(a.VALUE)&&a.VALUE.length){this.listTabIdUploadedContent["files"]=false;this.setFileCount()}}}};BX.Tasks.Component.TaskView.prototype.setFileCount=function(){BX.ajax.runComponentAction("bitrix:tasks.task","getFileCount",{mode:"class",data:{taskId:this.taskId}}).then(function(t){if(t.data.fileCount){BX.findChildByClassName(BX("task-files-switcher"),"task-switcher-text-counter").innerHTML=parseInt(t.data.fileCount)}}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors)}}.bind(this))};BX.Tasks.Component.TaskView.prototype.initViewer=function(){var t=["task-detail-description","task-detail-files","task-comments-block","task-files-block"];t.forEach((function(t){var e=BX(t);if(e){var s=typeof top.BX.viewElementBind==="function"?top.BX:BX;s.viewElementBind(e,{},(function(t){return BX.type.isElementNode(t)&&(t.getAttribute("data-bx-viewer")||t.getAttribute("data-bx-image"))}))}}))};BX.Tasks.Component.TaskView.prototype.initAjaxErrorHandler=function(){BX.addCustomEvent("TaskAjaxError",(function(t){BX.Tasks.alert(t).then((function(){BX.reload()}))}))};BX.Tasks.Component.TaskView.prototype.toggleFooterWrap=function(t){var e=BX("footerWrap");var s=BX("saveButton");var a="ui-btn-wait";var i="task-footer-wrap-active";if(t){if(!BX.hasClass(e,i)){BX.addClass(e,i)}this.checkListChanged=true;this.showCloseConfirmation=true}else{if(BX.hasClass(e,i)){BX.removeClass(e,i)}BX.removeClass(s,a);this.checkListChanged=false;this.showCloseConfirmation=false}};BX.Tasks.Component.TaskView.prototype.initCommentActionController=function(){if(window.top!==window&&window.BX.Tasks.CommentActionController){window.top.BX.Tasks.CommentActionController=window.BX.Tasks.CommentActionController}if(BX.Tasks.CommentActionController){void BX.Tasks.CommentActionController.init({workHours:this.parameters.workHours,workSettings:this.parameters.workSettings})}};BX.Tasks.Component.TaskView.prototype.clearNewAnalyticsParams=function(){const t=new URL(window.location.href);const e=t.searchParams.get("ta_sec");if(e){t.searchParams.delete("ta_sec");t.searchParams.delete("ta_sub");t.searchParams.delete("ta_el");window.history.replaceState(null,null,t.toString())}}}).call(this);
//# sourceMappingURL=logic.map.js