{"version":3,"file":"script.js","sources":["src/task-copilot-readonly.js"],"sourcesContent":["import { Dom, Event, Loc, Runtime, Tag } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\n\ntype Params = {\n\tcontainer: HTMLElement,\n\tdescription: string,\n\tenabledBySettings: boolean,\n\tcopilotParams: {\n\t\tmoduleId: string,\n\t\tcontextId: string,\n\t\tcategory: string,\n\t},\n\ttaskId: string,\n\tpathToPostCreate: string,\n};\n\nexport class TaskCopilotReadonly\n{\n\t#params: Params;\n\n\t#layout: {\n\t\tbutton: HTMLElement,\n\t};\n\n\t#copilotLoaded: boolean;\n\t#copilotContextMenu: any;\n\t#copilotShown: boolean;\n\n\tconstructor(params: Params)\n\t{\n\t\tthis.#params = params;\n\t\tthis.#layout = {};\n\n\t\tif (this.#params.enabledBySettings)\n\t\t{\n\t\t\tvoid this.#createCopilot();\n\t\t}\n\n\t\tDom.append(this.#render(), this.#params.container);\n\t}\n\n\t#render(): HTMLElement\n\t{\n\t\tthis.#layout.button = Tag.render`\n\t\t\t<span class=\"task-detail-extra-copilot-readonly\">\n\t\t\t\t<a>${Loc.getMessage('TASKS_TASK_BUTTON_COPILOT')}</a>\n\t\t\t</span>\n\t\t`;\n\n\t\tEvent.bind(this.#layout.button, 'mousedown', this.#onButtonMouseDown.bind(this));\n\t\tEvent.bind(this.#layout.button, 'click', this.#onButtonClick.bind(this));\n\n\t\treturn this.#layout.button;\n\t}\n\n\tasync #createCopilot(): Promise\n\t{\n\t\tconst { CopilotContextMenu } = await Runtime.loadExtension('ai.copilot');\n\n\t\tconst options = {\n\t\t\tmoduleId: this.#params.copilotParams.moduleId,\n\t\t\tcontextId: this.#params.copilotParams.contextId,\n\t\t\tcategory: this.#params.copilotParams.category,\n\t\t\tbindElement: this.#getBindElement(),\n\t\t\tangle: true,\n\t\t\textraResultMenuItems: [\n\t\t\t\t{\n\t\t\t\t\tcode: 'insert-into-comment',\n\t\t\t\t\ttext: Loc.getMessage('TASKS_TASK_BUTTON_COPILOT_COPY_INTO_COMMENT'),\n\t\t\t\t\tcommand: () => {\n\t\t\t\t\t\tconst resultText = this.#copilotContextMenu.getResultText();\n\t\t\t\t\t\tthis.#copilotContextMenu.hide();\n\n\t\t\t\t\t\tthis.#copyIntoComment(resultText);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tcode: 'insert-into-new-task',\n\t\t\t\t\ttext: Loc.getMessage('TASKS_TASK_BUTTON_COPILOT_COPY_INTO_NEW_TASK'),\n\t\t\t\t\tcommand: () => {\n\t\t\t\t\t\tconst resultText = this.#copilotContextMenu.getResultText();\n\t\t\t\t\t\tthis.#copilotContextMenu.hide();\n\n\t\t\t\t\t\tthis.#copyIntoNewTask(resultText);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t],\n\t\t};\n\n\t\tthis.#copilotContextMenu = new CopilotContextMenu(options);\n\n\t\ttry\n\t\t{\n\t\t\tawait this.#copilotContextMenu.init();\n\t\t\tthis.#copilotLoaded = true;\n\t\t}\n\t\tcatch (e)\n\t\t{\n\t\t\tconsole.error('Failed to init copilot', e);\n\t\t}\n\t}\n\n\t#onButtonMouseDown(): void\n\t{\n\t\tif (!this.#params.enabledBySettings)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#copilotShown = this.#copilotContextMenu?.isShown();\n\t}\n\n\t#onButtonClick(): void\n\t{\n\t\tif (!this.#params.enabledBySettings)\n\t\t{\n\t\t\tBX.UI.InfoHelper.show('limit_copilot_off');\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#copilotShown)\n\t\t{\n\t\t\tthis.#hide();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#show();\n\t\t}\n\t}\n\n\t#show(): void\n\t{\n\t\tif (this.#copilotLoaded)\n\t\t{\n\t\t\tthis.#copilotContextMenu.setContext(this.#params.description);\n\t\t\tthis.#copilotContextMenu.show({ bindElement: this.#getBindElement() });\n\t\t}\n\t}\n\n\t#getBindElement(): HTMLElement\n\t{\n\t\treturn this.#layout.button;\n\t}\n\n\t#hide(): void\n\t{\n\t\tthis.#copilotContextMenu.hide();\n\t}\n\n\t#copyIntoComment(text: string): void\n\t{\n\t\tconst list = FCList.getInstance({ ENTITY_XML_ID: this.#params.taskId });\n\t\tconst form = list.form;\n\t\tconst lhe = LHEPostForm.getHandlerByFormId(list.form.formId);\n\n\t\tif (lhe.oEditor?.IsShown())\n\t\t{\n\t\t\tlhe.oEditor.action.Exec('insertHTML', text);\n\t\t}\n\n\t\tconst iframeInitHandler = () => {\n\t\t\tlhe.oEditor.action.Exec('insertHTML', text);\n\t\t\tBX.removeCustomEvent(lhe.oEditor, 'OnAfterIframeInit', iframeInitHandler);\n\t\t};\n\t\tlhe.exec(() => {\n\t\t\tBX.addCustomEvent(lhe.oEditor, 'OnAfterIframeInit', iframeInitHandler);\n\t\t});\n\n\t\tform.show(list);\n\t}\n\n\t#copyIntoNewTask(text: string): void\n\t{\n\t\tBX.SidePanel.Instance.open(`${this.#params.pathToTaskCreate}#${encodeURIComponent(text)}`);\n\t}\n}"],"names":["TaskCopilotReadonly","constructor","params","enabledBySettings","Dom","append","container","button","Tag","render","Loc","getMessage","Event","bind","CopilotContextMenu","Runtime","loadExtension","options","moduleId","copilotParams","contextId","category","bindElement","angle","extraResultMenuItems","code","text","command","resultText","getResultText","hide","init","e","console","error","isShown","BX","UI","InfoHelper","show","setContext","description","list","FCList","getInstance","ENTITY_XML_ID","taskId","form","lhe","LHEPostForm","getHandlerByFormId","formId","oEditor","IsShown","action","Exec","iframeInitHandler","removeCustomEvent","exec","addCustomEvent","SidePanel","Instance","open","pathToTaskCreate","encodeURIComponent"],"mappings":"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"}