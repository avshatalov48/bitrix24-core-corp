if(typeof BX.CrmDedupeList==="undefined"){BX.CrmDedupeList=function(){this._id="";this._settings={};this._table=null;this._buildIndexBtn=null;this._entityTypeName="";this._typeData={};this._colData={};this._enableLayout=false;this._layoutName="";this._serviceUrl=null;this._manager=null;this._entityLoader=null;this._items={};this._expandedItem=null;this._typeCheckBoxes=[];this._headers={};this._processDialog=null;this._deferredFilter=[];this._scopeSelector=null;this._defaultScope="";this._currentScope="";this._typeContainer=null};BX.CrmDedupeList.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=t?t:{};this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"CrmDedupeList: parameter 'serviceUrl' is not found."}this._entityTypeName=this.getSetting("entityTypeName","");if(!BX.type.isNotEmptyString(this._entityTypeName)){throw"CrmDedupeList: parameter 'entityTypeName' is not found."}this._typeData=this.getSetting("typeData",{});var i=BX(this._id+"_type");if(i){this._typeCheckBoxes=BX.findChildren(i,{tagName:"INPUT",className:"crm-double-set-checkbox"},true)}this._colData=this.getSetting("colData",{});var s=this.getSetting("tableId");if(!BX.type.isNotEmptyString(s)){throw"CrmDedupeList: parameter 'tableId' is not found."}this._table=BX(s);if(!this._table){throw"CrmDedupeList: Could not find table."}var n=this.getSetting("itemData",{});var r=this._table.rows;for(var a=0;a<r.length;a++){var o=r[a];if(o.className==="bx-grid-head"){var l=BX.findChildren(o,{tagName:"TD",className:"bx-grid-sortable"},false);for(var h=0;h<l.length;h++){var u=l[h];var c=u.getAttribute("data-column-id");if(BX.type.isNotEmptyString(c)){this._headers[c]=BX.CrmDedupeListHeader.create(c,{cell:u,list:this})}}continue}var d=o.getAttribute("data-dupe-id");if(BX.type.isNotEmptyString(d)){this._items[d]=BX.CrmDedupeItem.create(d,{row:o,list:this,data:n.hasOwnProperty(d)?n[d]:{}})}}this._layoutName=this.getSetting("layoutName","");this._enableLayout=this.getSetting("enableLayout",false);if(this._enableLayout){for(var p=0;p<this._typeCheckBoxes.length;p++){BX.bind(this._typeCheckBoxes[p],"change",BX.delegate(this.onTypeCheckBoxChange,this))}}this._findBtn=BX(this._id+"_find");if(this._findBtn){BX.bind(this._findBtn,"click",BX.delegate(this.onFindButtonClick,this))}this._buildIndexBtn=BX(this._id+"_build_index");if(this._buildIndexBtn){BX.bind(this._buildIndexBtn,"click",BX.delegate(this.onBuildIndexButtonClick,this))}var _=this.getSetting("scopeSelectorId","");this._scopeSelector=BX(_);if(this._scopeSelector){BX.bind(this._scopeSelector,"change",BX.delegate(this.onScopeSelectorChange,this))}var f=this.getSetting("currentScope","");if(BX.type.isString(f))this._currentScope=f;var g=this.getSetting("typeContainerId","");this._typeContainer=BX(g)},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getEntityTypeName:function(){return this._entityTypeName},getLoader:function(){if(!this._entityLoader){this._entityLoader=BX.CrmDedupeEntityLoader.create(this._serviceUrl,this._entityTypeName,this._layoutName)}return this._entityLoader},getManager:function(){if(!this._manager){this._manager=BX.CrmDedupeManager.create(this._serviceUrl,this._entityTypeName)}return this._manager},getMessage:function(e){var t=BX.CrmDedupeList.messages;return t.hasOwnProperty(e)?t[e]:""},getLayoutName:function(){return this._layoutName},getUserId:function(){return parseInt(this.getSetting("userId",0))},getSortColumnId:function(){return this.getSetting("sortColumnId","")},getSortOrder:function(){return this.getSetting("sortOrder","asc")},getTypeInfo:function(e,t){var i=e.toString();if(BX.type.isNotEmptyString(t))i+="|"+t;var s=this._typeData.hasOwnProperty(i)?this._typeData[i]:null;return s},getColumnList:function(){var e,t=[];var i=this.getSetting("colData",[]);if(BX.type.isArray(i)){for(e=0;e<i.length;e++){var s="";var n=""+i[e]["TYPE_ID"];if(BX.type.isNotEmptyString(i[e]["SCOPE"])){n+="|"+i[e]["SCOPE"]}if(this._typeData.hasOwnProperty(n)){s=this._typeData[n]["GROUP_NAME"]}if(BX.type.isNotEmptyString(s)){t.push({NAME:i[e]["NAME"],TYPE_ID:i[e]["TYPE_ID"],SCOPE:i[e]["SCOPE"],GROUP_NAME:s})}}}return t},getTypeInfoByName:function(e,t){for(var i in this._typeData){if(!this._typeData.hasOwnProperty(i)){continue}var s=this._typeData[i];if(s["NAME"]===e&&s["SCOPE"]===t){return s}}return null},getCurrentScope:function(){return this._currentScope},insertRow:function(e){return this._table.insertRow(e)},removeRow:function(e){this._table.deleteRow(e.rowIndex)},interlace:function(e){e=parseInt(e);if(isNaN(e)||e<0){e=0}var t=e;for(var i in this._items){if(!this._items.hasOwnProperty(i)){continue}var s=this._items[i];var n=s.getContainer();if(++t%2>0){BX.removeClass(n,"bx-even bx-over");BX.addClass(n,"bx-odd")}else{BX.removeClass(n,"bx-odd");BX.addClass(n,"bx-even bx-over")}}return t},processItemFolding:function(e){if(this._expandedItem===e){this._expandedItem=null}},processItemExpansion:function(e){var t=this._expandedItem;this._expandedItem=e;if(t){t.fold()}},processItemEntityMerge:function(e,t,i){for(var s in this._items){if(this._items.hasOwnProperty(s)){var n=this._items[s];if(n!==e){n.processExternalMerge(e,t,i)}}}},rebuildIndex:function(e,t){if(this._processDialog){return false}var i=BX.util.getRandomString(8);var s="rebuild_"+this._entityTypeName.toLowerCase()+"_dedupe_index"+"_"+i;this.setScopeSelectorState(false);this._processDialog=BX.CrmLongRunningProcessDialog.create(s,{serviceUrl:this._serviceUrl,action:"REBUILD_DEDUPE_INDEX",params:{CONTEXT_ID:i,ENTITY_TYPE_NAME:this._entityTypeName,INDEX_TYPE_NAMES:e,INDEX_TYPE_SCOPES:t,CURRENT_SCOPE:this._currentScope},title:this.getMessage("rebuildIndexDlgTitle"),summary:this.getMessage("rebuildIndexDlgSummary")});BX.addCustomEvent(this._processDialog,"ON_STATE_CHANGE",BX.delegate(this.onRebuildIndexProcessStateChange,this));BX.addCustomEvent(this._processDialog,"ON_CLOSE",BX.delegate(this.onRebuildIndexDialogClose,this));this._processDialog.show();return true},removeItem:function(e){var t=e.getId();if(typeof this._items[t]==="undefined"){return}e.uninitialize();this.removeRow(e.getContainer());delete this._items[t]},prepareUrl:function(e,t){var i=window.location.href;var s="";for(var n in e){if(!e.hasOwnProperty(n)){continue}t.push(n);if(s!==""){s+="&"}s+=n+"="+e[n]}if(t.length>0){i=BX.util.remove_url_param(i,t)}var r=i.indexOf("?");if(r<0){i+="?"+s}else if(r===i.length-1){i+=s}else{i+=(i.charAt(i.length-1)!=="&"?"&":"")+s}return i},parseExtTypeId:function(e){var t={typeId:0,scope:""};if(!BX.type.isNotEmptyString(e))throw"CrmDedupeList.parseExtTypeId: argument 'extTypeId' must be not empty string.";var i=e.split("|",2);if(i.length>0){var s;if(i[0].length>0)s=parseInt(i[0]);if(s>0&&isFinite(s))t.typeId=s}if(i.length>1){if(i[1].length>0)t.scope=i[1]}return t},getSelectedTypeIds:function(){var e=[];for(var t=0;t<this._typeCheckBoxes.length;t++){var i=this._typeCheckBoxes[t];if(!i.checked)continue;var s=i.value;var n=this.parseExtTypeId(s);if(n.scope===this._currentScope){var r=this.getTypeInfo(n.typeId,n.scope);if(r)e.push(s)}}return e},applyFilter:function(e,t){var i=0;var s=BX.type.isString(t)?t:this._currentScope;for(var n=0;n<e.length;n++){i|=e[n]}window.location.href=this.prepareUrl({typeId:i,scope:s},["sortBy","sortOrder","pageNum"])},applySort:function(e,t){window.location.href=this.prepareUrl({sortBy:e.toLowerCase(),sortOrder:t},["pageNum"])},onRebuildIndexProcessStateChange:function(e){if(e!==this._processDialog||this._processDialog.getState()!==BX.CrmLongRunningProcessState.completed){return}var t=this._processDialog.getParams();if(BX.type.isArray(t["INDEX_TYPE_NAMES"])&&t.hasOwnProperty("SCOPE")&&BX.type.isString(t["SCOPE"])){var i=t["SCOPE"];var s=t["INDEX_TYPE_NAMES"];for(var n=0;n<s.length;n++){var r=this.getTypeInfoByName(s[n],i);if(r){r["IS_INDEXED"]=true}}}if(this._deferredFilter.length>0){this._processDialog.close();this.applyFilter(this._deferredFilter)}},onRebuildIndexDialogClose:function(e){this._processDialog=null;this.setScopeSelectorState(true)},onBuildIndexButtonClick:function(e){var t=[];var i=[];for(var s=0;s<this._typeCheckBoxes.length;s++){var n=this._typeCheckBoxes[s];if(!n.checked){continue}var r=this.parseExtTypeId(n.value);if(r.scope===this._currentScope){var a=this.getTypeInfo(r.typeId,r.scope);if(a){t.push(a["NAME"]);i.push(r.scope)}}}if(t.length===0){window.alert(this.getMessage("typeNotSelectedError"));return}this.rebuildIndex(t,i)},onFindButtonClick:function(e){var t=this.getSelectedTypeIds();if(t.length===0){window.alert(this.getMessage("typeNotSelectedError"));return}var i=[];var s=[];var n=[];for(var r=0;r<t.length;r++){var a=t[r];var o=this.parseExtTypeId(a);var l=this.getTypeInfo(o.typeId,o.scope);if(l){i.push(o.typeId);if(!l["IS_INDEXED"]){s.push(l["NAME"]);n.push(o.scope)}}}if(s.length>0){this._deferredFilter=i;this.rebuildIndex(s,n);return}this.applyFilter(i,this._currentScope)},onTypeCheckBoxChange:function(e){if(!this._enableLayout){return}var t=BX.getEventTarget(e);if(!t){return}var i=this.parseExtTypeId(t.value);var s=null;if(i.scope===this._currentScope)s=this.getTypeInfo(i.typeId,i.scope);if(!s){return}var n=s["LAYOUT_NAME"];var r=s["GROUP_NAME"];if(n===""||r===""){return}var a=null;var o=null;var l="";var h="";if(t.checked){BX.findNextSibling(t,{tagName:"LABEL",className:"crm-double-set-label"}).removeAttribute("disabled");for(var u=0;u<this._typeCheckBoxes.length;u++){a=this._typeCheckBoxes[u];i=this.parseExtTypeId(a.value);var o=null;if(i.scope===this._currentScope)o=this.getTypeInfo(i.typeId,i.scope);if(!o){continue}l=o["LAYOUT_NAME"];h=o["GROUP_NAME"];if(h===r&&l!==""&&l!==n){a.checked=false;BX.findNextSibling(a,{tagName:"LABEL",className:"crm-double-set-label"}).setAttribute("disabled","disabled")}}}else{for(var c=0;c<this._typeCheckBoxes.length;c++){a=this._typeCheckBoxes[c];i=this.parseExtTypeId(a.value);var o=null;if(i.scope===this._currentScope)o=this.getTypeInfo(i.typeId,i.scope);if(!o){continue}h=o["GROUP_NAME"];if(h===r){BX.findNextSibling(a,{tagName:"LABEL",className:"crm-double-set-label"}).removeAttribute("disabled")}}}},onScopeSelectorChange:function(e){var t=BX.getEventTarget(e);if(t){var i=this._currentScope;var s=t.value;if(BX.type.isString(s)&&i!==s){this._currentScope=s;if(this._typeContainer){var n=!BX.type.isNotEmptyString(s)?"none":"";var r=this._typeContainer.querySelectorAll(".bx-sl-crm-input-container-requisite, .bx-sl-crm-input-container-bank_detail");for(u=0;u<r.length;u++)r[u].style.display=n}var a,o,l,h,u;var c=this.getSetting("controlsByScope",{});for(a in c){if(a!==i&&a!==s)continue;if(c.hasOwnProperty(a)&&BX.type.isString(a)){o=c[a];if(BX.type.isArray(o)){for(u=0;u<o.length;u++){h=BX(o[u]);if(h){h.style.display=s===a?"":"none";l=BX.nextSibling(h);if(l&&o[u]===l.getAttribute("for"))l.style.display=h.style.display}}}}}}}},setScopeSelectorState:function(e){var t=!!e;if(this._scopeSelector){if(t)this._scopeSelector.removeAttribute("disabled");else this._scopeSelector.setAttribute("disabled","disabled")}}};if(typeof BX.CrmDedupeList.messages==="undefined"){BX.CrmDedupeList.messages={}}BX.CrmDedupeList.create=function(e,t){var i=new BX.CrmDedupeList;i.initialize(e,t);return i}}if(typeof BX.CrmDedupeListHeader==="undefined"){BX.CrmDedupeListHeader=function(){this._id="";this._settings={};this._list=null;this._cell=null};BX.CrmDedupeListHeader.prototype={initialize:function(e,t){if(!BX.type.isNotEmptyString(e)){throw"CrmDedupeListHeader: argument 'id' must be not empty string."}this._id=e;this._settings=t?t:{};this._list=this.getSetting("list");if(!this._list){throw"CrmDedupeListHeader: parameter 'list' is not found."}this._cell=this.getSetting("cell");if(!this._cell){throw"CrmDedupeListHeader: parameter 'row' is not found."}BX.bind(this._cell,"click",BX.delegate(this.onCellClick,this))},onCellClick:function(e){var t=this._list.getSortColumnId();var i=this._id===t?this._list.getSortOrder()==="asc"?"desc":"asc":"asc";this._list.applySort(this._id,i)},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t}};BX.CrmDedupeListHeader.create=function(e,t){var i=new BX.CrmDedupeListHeader;i.initialize(e,t);return i}}if(typeof BX.CrmDedupeItem==="undefined"){BX.CrmDedupeItem=function(){this._id="";this._settings={};this._isInitialized=false;this._data=null;this._entities={};this._list=null;this._row=null;this._buttonRow=null;this._mergeButton=null;this._skipButton=null;this._folder=null;this._folderClickHandler=BX.delegate(this.onFolderClick,this);this._callToUserLinkClickHandler=BX.delegate(this.onCallToUserLinkClick,this);this._mailToUserLinkClickHandler=BX.delegate(this.onMailToUserLinkClick,this);this._checkBoxClickHandler=BX.delegate(this.onCheckBoxClick,this);this._mergeButtonClickHandler=BX.delegate(this.onMergeButtonClick,this);this._skipButtonClickHandler=BX.delegate(this.onSkipButtonClick,this);this._checkBx=null;this._callToUserLink=null;this._mailToUserLink=null;this._summaryContainer=null;this._entitiesLoaded=false;this._expanded=false;this._selected=false;this._selectedEntityCount=0;this._fieldViewers={};this._action=null};BX.CrmDedupeItem.prototype={initialize:function(e,t){if(!BX.type.isNotEmptyString(e)){throw"CrmDedupeItem: argument 'id' must be not empty string."}this._id=e;this._settings=t?t:{};this._list=this.getSetting("list");if(!this._list){throw"CrmDedupeItem: parameter 'list' is not found."}this._data=this.getSetting("data",{});this._row=this.getSetting("row");if(!this._row){throw"CrmDedupeItem: parameter 'row' is not found."}this._buttonRow=BX(e+"_btn_wrapper");if(!this._buttonRow){throw"CrmDedupeItem: Could not find button row."}this._mergeButton=BX(e+"_merge_btn");if(!this._mergeButton){throw"CrmDedupeItem: Could not find 'Merge' button."}BX.bind(this._mergeButton,"click",this._mergeButtonClickHandler);this._skipButton=BX(e+"_skip_btn");if(!this._skipButton){throw"CrmDedupeItem: Could not find 'Skip' button."}BX.bind(this._skipButton,"click",this._skipButtonClickHandler);this._folder=BX.findChild(this._row,{className:"bx-scroller-control"},true,false);if(this._folder){BX.bind(this._folder,"click",this._folderClickHandler)}this._checkBx=BX(e+"_chkbx");if(this._checkBx){BX.bind(this._checkBx,"click",this._checkBoxClickHandler)}this._summaryContainer=BX(e+"_summary");if(!this._summaryContainer){throw"CrmDedupeItem: Could not found summary container."}this._callToUserLink=BX(e+"_call_to_user");if(this._callToUserLink){if(this._list.getUserId()===this.getResponsibleId()){this._callToUserLinkClickHandler=null;this._callToUserLink.style.display="none"}else{BX.bind(this._callToUserLink,"click",this._callToUserLinkClickHandler)}}this._mailToUserLink=BX(e+"_mail_to_user");if(this._mailToUserLink){if(this._list.getUserId()===this.getResponsibleId()){this._mailToUserLinkClickHandler=null;this._mailToUserLink.style.display="none"}else{BX.bind(this._mailToUserLink,"click",this._mailToUserLinkClickHandler)}}this._initializeFieldViewer("PHONE");this._initializeFieldViewer("EMAIL");var i=this._list.getColumnList();for(var s=0;s<i.length;s++){if(i[s]["GROUP_NAME"]==="requisite"||i[s]["GROUP_NAME"]==="bank_detail"){this._initializeRequisiteFieldViewer(i[s]["NAME"])}}this._isInitialized=true},_initializeFieldViewer:function(e){e=e.toUpperCase();var t=BX(this._id+"_show_"+e.toLowerCase());if(t){this._fieldViewers[e]=BX.CrmDedupeMultiFieldViewer.create(this._id+"_"+e.toLowerCase(),{owner:this,typeName:e,anchor:t,ignoredValue:this.getDataParam(e,"")})}},_initializeRequisiteFieldViewer:function(e){e=e.toUpperCase();var t=BX(this._id+"_show_"+e.toLowerCase());if(t){this._fieldViewers[e]=BX.CrmDedupeRequisiteFieldViewer.create(this._id+"_"+e.toLowerCase(),{owner:this,fieldName:e,anchor:t,ignoredValue:this.getDataParam(e,"")})}},uninitialize:function(){this.cleanEntities();if(this._folder){BX.unbind(this._folder,"click",this._folderClickHandler)}if(this._checkBx){BX.unbind(this._checkBx,"click",this._checkBoxClickHandler)}if(this._callToUserLink&&this._callToUserLinkClickHandler){BX.unbind(this._callToUserLink,"click",this._callToUserLinkClickHandler)}if(this._mailToUserLink&&this._mailToUserLinkClickHandler){BX.unbind(this._mailToUserLink,"click",this._mailToUserLinkClickHandler)}for(var e in this._fieldViewers){if(this._fieldViewers.hasOwnProperty(e)){this._fieldViewers[e].uninitialize()}}this._fieldViewers={};this._isInitialized=false},getUserId:function(){return this._list.getUserId()},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getDataParam:function(e,t){return this._data.hasOwnProperty(e)?this._data[e]:t},getMessage:function(e){var t=BX.CrmDedupeItem.messages;return t.hasOwnProperty(e)?t[e]:""},getId:function(){return this._id},getEntityTypeName:function(){return this._list.getEntityTypeName()},getRootEntityId:function(){return parseInt(this.getDataParam("ROOT_ENTITY_ID",0))},getTitle:function(){return this.getDataParam("TITLE","")},getResponsibleId:function(){return parseInt(this.getDataParam("RESPONSIBLE_ID",0))},getResponsibleName:function(){return this.getDataParam("RESPONSIBLE_FULL_NAME","")},getEntityCount:function(){var e=0;for(var t in this._entities){if(this._entities.hasOwnProperty(t)){e++}}return e},hasEntities:function(){for(var e in this._entities){if(this._entities.hasOwnProperty(e)){return true}}return false},getIndexTypeName:function(){return this.getDataParam("INDEX_TYPE_NAME","")},getIndexMatches:function(){return this._data.hasOwnProperty("INDEX_MATCHES")?this._data["INDEX_MATCHES"]:{}},getContainer:function(){return this._row},getSelectedEntities:function(){var e=[];for(var t in this._entities){if(!this._entities.hasOwnProperty(t)){continue}var i=this._entities[t];if(i.isSelected()){e.push(i)}}return e},isExpanded:function(){return this._expanded},expand:function(){if(!this._isInitialized){throw"CrmDedupeItem: Is not initialized."}if(this._expanded){return}if(!this._entitiesLoaded){var e=[];var t=this._list.getColumnList();for(var i=0;i<t.length;i++){if(t[i]["GROUP_NAME"]==="requisite"||t[i]["GROUP_NAME"]==="bank_detail"){e.push(t[i])}}t=null;this._list.getLoader().loadEntities({rootEntityId:this.getRootEntityId(),indexTypeName:this.getIndexTypeName(),indexMatches:this.getIndexMatches(),anchor:this._row,callback:BX.delegate(this.processDataLoaded,this),columns:e});return}for(var s in this._entities){if(this._entities.hasOwnProperty(s)){var n=this._entities[s];this._entities[s].setVisible(true)}}this._summaryContainer.style.visibility="visible";this._buttonRow.style.display=this.hasEntities()?"":"none";BX.addClass(this._row,"bx-double-open");BX.removeClass(this._folder,"plus");BX.addClass(this._folder,"minus");this._expanded=true;this._list.processItemExpansion(this)},fold:function(){if(!this._isInitialized){throw"CrmDedupeItem: Is not initialized."}if(!this._expanded){return}for(var e in this._entities){if(this._entities.hasOwnProperty(e)){this._entities[e].setVisible(false)}}this._summaryContainer.style.visibility="hidden";this._buttonRow.style.display="none";BX.removeClass(this._row,"bx-double-open");BX.removeClass(this._folder,"minus");BX.addClass(this._folder,"plus");this._expanded=false;this._list.processItemFolding(this)},isSelected:function(){return this._selected},setSelected:function(e,t){if(!this._isInitialized){throw"CrmDedupeItem: Is not initialized."}e=!!e;if(this._selected===e){return}this._selected=e;if(this._checkBx.checked!==e){this._checkBx.checked=e}if(e){BX.addClass(this._row,"bx-green")}else{BX.removeClass(this._row,"bx-green")}t=!!t;if(t){for(var i in this._entities){if(this._entities.hasOwnProperty(i)){this._entities[i].setSelected(e)}}}},interlace:function(e){if(!this._isInitialized){throw"CrmDedupeItem: Is not initialized."}e=parseInt(e);if(isNaN(e)||e<0){e=0}var t=e;for(var i in this._entities){if(!this._entities.hasOwnProperty(i)){continue}var s=this._entities[i].getContainer();if(++t%2>0){BX.removeClass(s,"bx-even bx-over");BX.addClass(s,"bx-odd")}else{BX.removeClass(s,"bx-odd");BX.addClass(s,"bx-even bx-over")}}return t},loadMultiFields:function(){if(!this._isInitialized){return}this._list.getLoader().loadEntityMultiFields({callback:BX.delegate(this.processDataLoaded,this),anchor:this._row,entityId:this.getRootEntityId()})},loadRequisiteFields:function(){if(!this._isInitialized){return}var e=[];var t=this._list.getColumnList();for(var i=0;i<t.length;i++){if(t[i]["GROUP_NAME"]==="requisite"||t[i]["GROUP_NAME"]==="bank_detail"){e.push(t[i])}}t=null;this._list.getLoader().loadEntityRequisiteFields({callback:BX.delegate(this.processDataLoaded,this),anchor:this._row,entityId:this.getRootEntityId(),columns:e})},processDataLoaded:function(e){if(!this._isInitialized){return}var t=this.getRootEntityId();if(typeof e["ENTITY_INFOS"]!=="undefined"){var i=e["ENTITY_INFOS"];var s=this._row.rowIndex;for(var n=0;n<i.length;n++){var r=i[n];var a=r["ID"];if(t===parseInt(a)){continue}var o=this._list.insertRow(++s);var l=BX.CrmDedupeEntity.create(a,{data:r,row:o,item:this});this._entities[a]=l;l.setVisible(false);l.layout()}this._entitiesLoaded=true;this.setSummaryText(BX.type.isNotEmptyString(e["TEXT_TOTALS"])?e["TEXT_TOTALS"]:"");this.expand();for(var h in this._entities){if(this._entities.hasOwnProperty(h)){this._entities[h].setSelected(this._selected)}}}else if(typeof e["MULTI_FIELDS"]!=="undefined"){var u=e["MULTI_FIELDS"];if(typeof this._fieldViewers["PHONE"]!=="undefined"){this._fieldViewers["PHONE"].setValues(BX.type.isArray(u["PHONE"])?u["PHONE"]:[])}if(typeof this._fieldViewers["EMAIL"]!=="undefined"){this._fieldViewers["EMAIL"].setValues(BX.type.isArray(u["EMAIL"])?u["EMAIL"]:[])}}var c=this._list.getColumnList();for(var n=0;n<c.length;n++){var d=c[n]["GROUP_NAME"]==="requisite";var p=c[n]["GROUP_NAME"]==="bank_detail";if(d||p){var _=d?"REQUISITES":"BANK_DETAILS";var f=c[n]["NAME"];var g=c[n]["SCOPE"];if(typeof this._fieldViewers[f]!=="undefined"&&e!==null&&typeof e==="object"&&e.hasOwnProperty(_)&&e[_]!==null&&typeof e[_]==="object"&&e[_].hasOwnProperty(f)&&e[_][f]!==null&&typeof e[_][f]==="object"&&e[_][f].hasOwnProperty(g)&&BX.type.isArray(e[_][f][g])){this._fieldViewers[f].setValues(e[_][f][g])}}}},processExternalMerge:function(e,t,i){if(!this._isInitialized){return}if(this===e){return}if(t===this.getRootEntityId()){this._list.removeItem(this)}else{var s=t.toString();if(typeof this._entities[s]!=="undefined"){this.cleanEntities()}}},getLoader:function(){return this._list.getLoader()},processEntitySelection:function(e){if(!this._isInitialized){return}var t=e.isSelected();if(t){this._selectedEntityCount++}else if(this._selectedEntityCount>0){this._selectedEntityCount--}this.setSelected(this._selectedEntityCount>0,false)},setSummaryText:function(e){this._summaryContainer.innerHTML=BX.util.htmlspecialchars(e)},cleanEntities:function(){if(this.isExpanded()){this.fold()}for(var e in this._entities){if(this._entities.hasOwnProperty(e)){if(this._entities[e].isSelected()){this._entities[e].setSelected(false)}this._entities[e].uninitialize();this._list.removeRow(this._entities[e].getContainer())}}this._entities={};this._entitiesLoaded=false;this.setSummaryText("")},deleteEntity:function(e){var t=e.toString();if(typeof this._entities[t]==="undefined"){return}if(this._entities[t].isSelected()){this._entities[t].setSelected(false)}this._entities[t].uninitialize();this._list.removeRow(this._entities[t].getContainer());delete this._entities[t]},merge:function(){if(!this._isInitialized){throw"CrmDedupeItem: Is not initialized."}if(this._action&&this._action.isRun()){return}var e=this.getSelectedEntities();if(e.length===0){return}var t=[];for(var i=0;i<e.length;i++){var s=e[i];var n=s.isAuthorizedUpdate();var r=s.isAuthorizedDelete();if(n&&r){t.push({seedEntityId:s.getEntityId(),seedTitle:s.getTitle(),seedResponsibleId:s.getResponsibleId().toString(),seedResponsibleName:s.getResponsibleName(),targEntityId:this.getRootEntityId(),targTitle:this.getTitle(),targResponsibleId:this.getResponsibleId().toString(),targResponsibleName:this.getResponsibleName(),indexTypeName:this.getIndexTypeName(),indexMatches:this.getIndexMatches(),anchor:this._row});continue}var a=this.getMessage("entityMergeDeniedError");var o=s.getTitle();if(o.length>20){o=o.substr(0,17)+"..."}a=a.replace("#TITLE#",o).replace("#ID#",s.getEntityId());if(!n){a+="\r\n"+this.getMessage("entityUpdateDeniedError")}if(!r){a+="\r\n"+this.getMessage("entityDeleteDeniedError")}window.alert(a);s.setSelected(false)}if(t.length===0){return}this._action=BX.CrmDedupeMergeAction.create("merge",{manager:this._list.getManager(),anchor:this._row,queue:t,iterationCompleteCallback:BX.delegate(this.onMergeIterationCompleted,this),queueCompleteCallback:BX.delegate(this.onMergeQueueCompleted,this)});this._action.run()},onMergeIterationCompleted:function(e){if(!this._isInitialized||e!==this._action){return}if(this._action.isIterationSkipped()){return}var t=this._action.getIterationResult();var i=BX.type.isNotEmptyString(t["SEED_ENTITY_ID"])?parseInt(t["SEED_ENTITY_ID"]):0;if(i<=0){return}this.deleteEntity(i);this.setSummaryText(BX.type.isNotEmptyString(t["TEXT_TOTALS"])?t["TEXT_TOTALS"]:"");this._list.processItemEntityMerge(this,i,this.getRootEntityId());if(!this.hasEntities()){this._list.removeItem(this)}},onMergeQueueCompleted:function(e){if(e===this._action){this._action=null}},skip:function(){if(!this._isInitialized){throw"CrmDedupeItem: Is not initialized."}if(this._action&&this._action.isRun()){return}var e=this.getSelectedEntities();if(e.length===0){return}var t=[];for(var i=0;i<e.length;i++){var s=e[i];var n=s.getIndexMatches();t.push({leftEntityId:this.getRootEntityId(),rightEntityId:s.getEntityId(),indexTypeName:this.getIndexTypeName(),leftEntityIndexMatches:this.getIndexMatches(),rightEntityIndexMatches:n!==null?n:[],anchor:this._row})}if(t.length===0){return}this._action=BX.CrmDedupeSkipAction.create("skip",{manager:this._list.getManager(),anchor:this._row,queue:t,iterationCompleteCallback:BX.delegate(this.onSkipIterationCompleted,this),queueCompleteCallback:BX.delegate(this.onSkipQueueCompleted,this)});this._action.run()},onSkipIterationCompleted:function(e){if(!this._isInitialized||e!==this._action){return}if(this._action.isIterationSkipped()){return}var t=this._action.getIterationResult();var i=BX.type.isNotEmptyString(t["RIGHT_ENTITY_ID"])?parseInt(t["RIGHT_ENTITY_ID"]):0;if(i<=0){return}this.deleteEntity(i);this.setSummaryText(BX.type.isNotEmptyString(t["TEXT_TOTALS"])?t["TEXT_TOTALS"]:"");if(!this.hasEntities()){this._list.removeItem(this)}},onSkipQueueCompleted:function(e){if(e===this._action){this._action=null}},onMergeButtonClick:function(e){if(!this._isInitialized){return}if(this._selectedEntityCount>0){this.merge()}else{alert(this.getMessage("noEntitySelectedError"))}},onSkipButtonClick:function(e){if(!this._isInitialized){return}if(this._selectedEntityCount>0){this.skip()}else{alert(this.getMessage("noEntitySelectedError"))}},onFolderClick:function(){if(!this._isInitialized){return}if(this._expanded){this.fold()}else{this.expand()}},onCallToUserLinkClick:function(e){if(!this._isInitialized){return BX.PreventDefault(e)}if(typeof window["BXIM"]==="undefined"){return true}var t=this.getDataParam("RESPONSIBLE_PHONE","");if(t===""){return true}window["BXIM"].phoneTo(t);return BX.PreventDefault(e)},onMailToUserLinkClick:function(e){if(!this._isInitialized){return BX.PreventDefault(e)}if(typeof window["BXIM"]==="undefined"){return true}var t=parseInt(this.getDataParam("RESPONSIBLE_ID",0));if(t<=0){return true}window["BXIM"].openMessengerSlider(t,{RECENT:"N",MENU:"N"});return BX.PreventDefault(e)},onCheckBoxClick:function(e){if(!this._isInitialized){return}this.setSelected(this._checkBx.checked,true)}};if(typeof BX.CrmDedupeItem.messages==="undefined"){BX.CrmDedupeItem.messages={}}BX.CrmDedupeItem.create=function(e,t){var i=new BX.CrmDedupeItem;i.initialize(e,t);return i}}if(typeof BX.CrmDedupeEntity==="undefined"){BX.CrmDedupeEntity=function(){this._id="";this._settings={};this._isInitialized=false;this.hasLayout=false;this._item=null;this._data=null;this._visible=false;this._selected=false;this._row=null;this._checkBx=null;this._callToLink=null;this._mailToLink=null;this._fieldViewers={};this._checkBoxClickHandler=BX.delegate(this.onCheckBoxClick,this);this._callToUserLinkClickHandler=BX.delegate(this.onCallToUserLinkClick,this);this._mailToUserLinkClickHandler=BX.delegate(this.onMailToUserLinkClick,this)};BX.CrmDedupeEntity.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._item=this.getSetting("item");this._data=this.getSetting("data",{});this._row=this.getSetting("row");this._visible=this._row.style.display!=="none";this._isInitialized=true},uninitialize:function(){if(this.hasLayout){if(this.isSelected()){this.setSelected(false)}BX.unbind(this._checkBx,"click",this._checkBoxClickHandler);if(this._callToLink){BX.bind(this._callToLink,"click",this._callToUserLinkClickHandler)}if(this._mailToLink){BX.bind(this._mailToLink,"click",this._mailToUserLinkClickHandler)}for(var e in this._fieldViewers){if(this._fieldViewers.hasOwnProperty(e)){this._fieldViewers[e].uninitialize()}}this._fieldViewers={}}this._isInitialized=false},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getEntityTypeName:function(){return this._item.getEntityTypeName()},getEntityId:function(){return parseInt(this.getDataParam("ID",0))},getContainer:function(){return this._row},getDataParam:function(e,t){return this._data.hasOwnProperty(e)?this._data[e]:t},getTitle:function(){return this.getDataParam("TITLE","")},getResponsibleId:function(){return parseInt(this.getDataParam("RESPONSIBLE_ID",0))},getResponsibleName:function(){return this.getDataParam("RESPONSIBLE_FULL_NAME","")},isAuthorizedUpdate:function(){return this.getDataParam("CAN_UPDATE",false)},isAuthorizedDelete:function(){return this.getDataParam("CAN_DELETE",false)},isMergable:function(){return this.getDataParam("CAN_UPDATE",false)&&this.getDataParam("CAN_DELETE",false)},getIndexMatches:function(){return this.getDataParam("INDEX_MATCHES",null)},getMessage:function(e){var t=BX.CrmDedupeEntity.messages;return t.hasOwnProperty(e)?t[e]:""},isVisible:function(){return this._visible},setVisible:function(e){if(!this._isInitialized){throw"CrmDedupeEntity: Is not initialized."}e=!!e;if(this._visible===e){return}this._visible=e;this._row.style.display=e?"":"none"},isSelected:function(){return this._selected},setSelected:function(e){if(!this._isInitialized){throw"CrmDedupeEntity: Is not initialized."}e=!!e;if(this._selected===e){return}this._selected=e;if(this._checkBx.checked!==e){this._checkBx.checked=e}if(e){BX.addClass(this._row,"bx-green")}else{BX.removeClass(this._row,"bx-green")}this._item.processEntitySelection(this)},layout:function(){if(!this._isInitialized){throw"CrmDedupeEntity: Is not initialized."}BX.addClass(this._row,"bx-double-children");this._row.insertCell(-1);this._row.insertCell(-1);var e=this._row.insertCell(-1);e.className="bx-checkbox-col bx-left";e.style.width="10px";e.style.padding="0 !important";this._checkBx=BX.create("INPUT",{props:{type:"checkbox",title:this.getMessage("select")}});BX.bind(this._checkBx,"click",this._checkBoxClickHandler);e.appendChild(this._checkBx);e=this._row.insertCell(-1);var t=BX.create("DIV",{props:{className:"crm-client-summary-wrapper"}});e.appendChild(t);var i=BX.create("DIV",{props:{className:"crm-client-photo-wrapper"}});t.appendChild(i);var s=this.getDataParam("IMAGE_URL","");if(s!==""){i.appendChild(BX.create("IMG",{props:{src:s,width:50,height:50,border:0}}))}else{i.appendChild(BX.create("DIV",{props:{className:"ui-icon ui-icon-common-user crm-avatar crm-avatar-user"},children:[BX.create("i",{})]}))}var n=BX.create("DIV",{props:{className:"crm-client-info-wrapper"}});t.appendChild(n);var r=this.getDataParam("SHOW_URL","#");var a=this.getDataParam("TITLE","");if(a===""){a=this.getMessage("untitled")}var o=this.getDataParam("LEGEND","");n.appendChild(BX.create("DIV",{props:{className:"crm-client-title-wrapper"},children:[BX.create("A",{props:{href:r,target:"_blank"},text:a})]}));if(o!==""){n.appendChild(BX.create("DIV",{props:{className:"crm-client-description-wrapper"},text:o}))}var l=this.isMergable();if(!l){n.appendChild(BX.create("DIV",{props:{className:"bx-double-access-denied"},text:this.getMessage("entityAccessDenied")}))}t.appendChild(BX.create("DIV",{style:{clear:"both"}}));e=this._row.insertCell(-1);var h=this.getDataParam("PHONE",null);if(h&&BX.type.isNotEmptyString(h["FIRST_VALUE"])){this.renderMultifield("PHONE",e,h["FIRST_VALUE"],BX.type.isNotEmptyString(h["TOTAL"])?parseInt(h["TOTAL"]):1)}e=this._row.insertCell(-1);var u=this.getDataParam("EMAIL",null);if(u&&BX.type.isNotEmptyString(u["FIRST_VALUE"])){this.renderMultifield("EMAIL",e,u["FIRST_VALUE"],BX.type.isNotEmptyString(u["TOTAL"])?parseInt(u["TOTAL"]):1)}var c=this._item._list.getColumnList();for(var d=0;d<c.length;d++){if(c[d]["GROUP_NAME"]==="requisite"||c[d]["GROUP_NAME"]==="bank_detail"){e=this._row.insertCell(-1);var p=this.getDataParam(c[d]["NAME"],null);if(p&&BX.type.isNotEmptyString(p["FIRST_VALUE"])){this.renderRequisiteField(c[d]["NAME"],e,p["FIRST_VALUE"],BX.type.isNotEmptyString(p["TOTAL"])?parseInt(p["TOTAL"]):1)}}}e=this._row.insertCell(-1);var _=this.getDataParam("RESPONSIBLE_FULL_NAME","");if(_!==""){e.appendChild(document.createTextNode(_));e.appendChild(BX.create("BR"))}var f=parseInt(this.getDataParam("RESPONSIBLE_ID",0));if(f!==this._item.getUserId()){var g=this.getDataParam("RESPONSIBLE_EMAIL","");this._mailToLink=BX.create("A",{props:{href:"mailto:"+g},text:this.getMessage("mailTo")});e.appendChild(this._mailToLink);BX.bind(this._mailToLink,"click",this._mailToUserLinkClickHandler);var m=this.getDataParam("RESPONSIBLE_PHONE","");if(m!==""){this._callToLink=BX.create("A",{props:{href:"callto:"+m},style:{marginLeft:"20px"},text:this.getMessage("callTo")});e.appendChild(this._callToLink);BX.bind(this._callToLink,"click",this._callToUserLinkClickHandler)}}this.hasLayout=true},renderMultifield:function(e,t,i,s){var n=BX.create("DIV",{props:{className:"bx-crm-multi-field-wrapper"},children:[BX.create("DIV",{props:{className:"crm-client-contacts-block-text"},text:i})]});if(s>1){var r=BX.create("SPAN",{props:{className:"crm-multi-field-popup-button"},text:this.getMessage("showMoreMultiFieldValues")+" "+(s-1).toString()});n.appendChild(BX.create("DIV",{props:{className:"crm-multi-field-popup-wrapper"},children:[r]}));this._fieldViewers[e]=BX.CrmDedupeMultiFieldViewer.create(this._id+"_"+e.toLowerCase(),{owner:this,typeName:e,anchor:r,ignoredValue:i})}t.appendChild(n)},renderRequisiteField:function(e,t,i,s){var n=BX.create("DIV",{props:{className:"bx-crm-multi-field-wrapper"},children:[BX.create("DIV",{props:{className:"crm-client-contacts-block-text"},text:i})]});if(s>1){var r=BX.create("SPAN",{props:{className:"crm-multi-field-popup-button"},text:this.getMessage("showMoreMultiFieldValues")+" "+(s-1).toString()});n.appendChild(BX.create("DIV",{props:{className:"crm-multi-field-popup-wrapper"},children:[r]}));this._fieldViewers[e]=BX.CrmDedupeRequisiteFieldViewer.create(this._id+"_"+e.toLowerCase(),{owner:this,fieldName:e,anchor:r,ignoredValue:i})}t.appendChild(n)},onCheckBoxClick:function(e){if(!this._isInitialized){return}this.setSelected(this._checkBx.checked)},onCallToUserLinkClick:function(e){if(!this._isInitialized){BX.PreventDefault(e)}if(typeof window["BXIM"]==="undefined"){return true}var t=this.getDataParam("RESPONSIBLE_PHONE","");if(t===""){return true}window["BXIM"].phoneTo(t);return BX.PreventDefault(e)},onMailToUserLinkClick:function(e){if(!this._isInitialized){return BX.PreventDefault(e)}if(typeof window["BXIM"]==="undefined"){return true}var t=parseInt(this.getDataParam("RESPONSIBLE_ID",0));if(t<=0){return true}window["BXIM"].openMessengerSlider(t,{RECENT:"N",MENU:"N"});return BX.PreventDefault(e)},loadMultiFields:function(){if(!this._isInitialized){return}this._item.getLoader().loadEntityMultiFields({callback:BX.delegate(this.processDataLoaded,this),anchor:this._row,entityId:this.getEntityId()})},loadRequisiteFields:function(){if(!this._isInitialized){return}var e=[];var t=this._item._list.getColumnList();for(var i=0;i<t.length;i++){if(t[i]["GROUP_NAME"]==="requisite"||t[i]["GROUP_NAME"]==="bank_detail"){e.push(t[i])}}t=null;this._item.getLoader().loadEntityRequisiteFields({callback:BX.delegate(this.processDataLoaded,this),anchor:this._row,entityId:this.getEntityId(),columns:e})},processDataLoaded:function(e){if(!this._isInitialized){return}if(typeof e["MULTI_FIELDS"]!=="undefined"){var t=e["MULTI_FIELDS"];if(typeof this._fieldViewers["PHONE"]!=="undefined"){this._fieldViewers["PHONE"].setValues(BX.type.isArray(t["PHONE"])?t["PHONE"]:[])}if(typeof this._fieldViewers["EMAIL"]!=="undefined"){this._fieldViewers["EMAIL"].setValues(BX.type.isArray(t["EMAIL"])?t["EMAIL"]:[])}}var i=this._item._list.getColumnList();for(var s=0;s<i.length;s++){var n=i[s]["GROUP_NAME"]==="requisite";var r=i[s]["GROUP_NAME"]==="bank_detail";if(n||r){var a=n?"REQUISITES":"BANK_DETAILS";var o=i[s]["NAME"];var l=i[s]["SCOPE"];if(typeof this._fieldViewers[o]!=="undefined"&&e!==null&&typeof e==="object"&&e.hasOwnProperty(a)&&e[a]!==null&&typeof e[a]==="object"&&e[a].hasOwnProperty(o)&&e[a][o]!==null&&typeof e[a][o]==="object"&&e[a][o].hasOwnProperty(l)&&BX.type.isArray(e[a][o][l])){this._fieldViewers[o].setValues(e[a][o][l])}}}}};if(typeof BX.CrmDedupeEntity.messages==="undefined"){BX.CrmDedupeEntity.messages={}}BX.CrmDedupeEntity.create=function(e,t){var i=new BX.CrmDedupeEntity;i.initialize(e,t);return i}}if(typeof BX.CrmDedupeEntityLoader==="undefined"){BX.CrmDedupeEntityLoader=function(){this._serviceUrl=null;this._entityTypeName="";this._layoutName="";this._callback=null;this._anchor=null;this._waiter=null;this._isRequestRunning=false};BX.CrmDedupeEntityLoader.prototype={initialize:function(e,t,i){this._serviceUrl=e;this._entityTypeName=t;this._layoutName=i},loadEntities:function(e){return this.startEntiesRequest(e)},startEntiesRequest:function(e){if(this._isRequestRunning){return false}this._isRequestRunning=true;this._anchor=BX.type.isDomNode(e["anchor"])?e["anchor"]:null;if(this._anchor){this._waiter=BX.showWait(this._anchor)}this._callback=BX.type.isFunction(e["callback"])?e["callback"]:null;var t=BX.util.add_url_param(this._serviceUrl,BX.mergeEx({TYPE_NAME:BX.type.isNotEmptyString(e["indexTypeName"])?e["indexTypeName"]:""},typeof e["indexMatches"]!=="undefined"?e["indexMatches"]:{}));BX.ajax({url:t,method:"POST",dataType:"json",data:{ACTION:"GET_DUPLICATE_ENTITIES",ENTITY_TYPE_NAME:this._entityTypeName,ROOT_ENTITY_ID:parseInt(e["rootEntityId"]),LAYOUT_NAME:this._layoutName,COLUMNS:e.hasOwnProperty("columns")?e["columns"]:[],INDEX_TYPE_NAME:BX.type.isNotEmptyString(e["indexTypeName"])?e["indexTypeName"]:"",INDEX_MATCHES:typeof e["indexMatches"]!=="undefined"?e["indexMatches"]:{}},onsuccess:BX.delegate(this.onRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)});return true},loadEntityMultiFields:function(e){return this.startEntityMultiFieldsRequest(e)},startEntityMultiFieldsRequest:function(e){if(this._isRequestRunning){return false}this._isRequestRunning=true;this._anchor=BX.type.isDomNode(e["anchor"])?e["anchor"]:null;if(this._anchor){this._waiter=BX.showWait(this._anchor)}this._callback=BX.type.isFunction(e["callback"])?e["callback"]:null;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"GET_DUPLICATE_ENTITY_MULTI_FIELDS",ENTITY_TYPE_NAME:this._entityTypeName,ENTITY_ID:BX.type.isNumber(e["entityId"])?e["entityId"]:0},onsuccess:BX.delegate(this.onRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)});return true},onRequestSuccess:function(e){this._isRequestRunning=false;if(this._waiter){BX.closeWait(this._anchor,this._waiter);this._waiter=this._anchor=null}if(this._callback){this._callback(e);this._callback=null}},onRequestFailure:function(e){this._isRequestRunning=false;if(this._waiter){BX.closeWait(this._anchor,this._waiter);this._waiter=this._anchor=null}},loadEntityRequisiteFields:function(e){return this.startEntityRequisiteFieldsRequest(e)},startEntityRequisiteFieldsRequest:function(e){if(this._isRequestRunning){return false}this._isRequestRunning=true;this._anchor=BX.type.isDomNode(e["anchor"])?e["anchor"]:null;if(this._anchor){this._waiter=BX.showWait(this._anchor)}this._callback=BX.type.isFunction(e["callback"])?e["callback"]:null;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"GET_DUPLICATE_ENTITY_REQUISITE_FIELDS",ENTITY_TYPE_NAME:this._entityTypeName,ENTITY_ID:BX.type.isNumber(e["entityId"])?e["entityId"]:0,COLUMNS:e.hasOwnProperty("columns")?e["columns"]:[]},onsuccess:BX.delegate(this.onRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)});return true}};BX.CrmDedupeEntityLoader.create=function(e,t,i){var s=new BX.CrmDedupeEntityLoader;s.initialize(e,t,i);return s}}if(typeof BX.CrmDedupeAction==="undefined"){BX.CrmDedupeAction=function(){this._id="";this._settings={};this._manager=null;this._anchor=null;this._queue=[];this._current=null;this._iterationCompleteCallback=null;this._queueCompleteCallback=null;this._iterationResult=null;this._isIterationSkipped=false;this._isRun=false};BX.CrmDedupeAction.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._manager=this.getSetting("manager",null);this._anchor=this.getSetting("anchor",null);this._queue=this.getSetting("queue",[]);this._iterationCompleteCallback=this.getSetting("iterationCompleteCallback",null);this._queueCompleteCallback=this.getSetting("queueCompleteCallback",null)},getId:function(){return this._id},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getQueue:function(){return this._queue},setQueue:function(e){this._queue=e},moveNext:function(){if(this._current!==null&&this._iterationCompleteCallback){this._iterationCompleteCallback(this)}this._iterationResult=null;this._isIterationSkipped=false;var e=this._queue.shift();this._current=e?e:null;if(!this._current&&this._queueCompleteCallback){this._queueCompleteCallback(this)}return this._current!==null},run:function(){window.setTimeout(BX.delegate(this.internalRun,this),300)},internalRun:function(){this._isRun=this.moveNext();if(!this._isRun){return}try{this.iterate()}catch(e){this._isRun=false;BX.debug(e)}},iterate:function(){BX.debug("CrmDedupeAction: iterate must be overridden");this.stop()},skip:function(){this.setIterationSkipped(true);this.run()},runNext:function(e){this.setIterationResult(e);this.run()},stop:function(e){this._isRun=false;this._current=null;if(BX.type.isNotEmptyString(e)){window.alert(e)}},isRun:function(){return this._isRun},isIterationSkipped:function(){return this._isIterationSkipped},setIterationSkipped:function(e){this._isIterationSkipped=!!e},getIterationResult:function(){return this._iterationResult},setIterationResult:function(e){this._iterationResult=e}}}if(typeof BX.CrmDedupeMergeAction==="undefined"){BX.CrmDedupeMergeAction=function(){BX.CrmDedupeMergeAction.superclass.constructor.apply(this);this._warningDlg=null};BX.extend(BX.CrmDedupeMergeAction,BX.CrmDedupeAction);BX.CrmDedupeMergeAction.prototype.iterate=function(){this.receiveCollisions()};BX.CrmDedupeMergeAction.prototype.receiveCollisions=function(){this._manager.getMergeCollisions({seedEntityId:this._current["seedEntityId"],targEntityId:this._current["targEntityId"],anchor:this._anchor,callback:BX.delegate(this.onCollisionsReceived,this)})};BX.CrmDedupeMergeAction.prototype.onCollisionsReceived=function(e){var t=BX.type.isNotEmptyString(e["ERROR"])?e["ERROR"]:"";if(t!==""){this.stop(t);return}var i=BX.CrmDedupeCollisionData.create(BX.type.isArray(e["COLLISION_TYPES"])?e["COLLISION_TYPES"]:[],this._manager.getEntityTypeName());if(!i.hasCollisions()){this.merge();return}this._warningDlg=BX.CrmDedupeCollisionDialog.create("warn",{collisionData:i,contextData:this._current,onCancel:BX.delegate(this.onWarningDialogCancel,this),onIgnore:BX.delegate(this.onWarningDialogIgnore,this),onClose:BX.delegate(this.onWarningDialogClose,this)});this._warningDlg.show()};BX.CrmDedupeMergeAction.prototype.onWarningDialogCancel=function(e){if(this._warningDlg!==e){return}this._warningDlg=null;e.close();this.skip()};BX.CrmDedupeMergeAction.prototype.onWarningDialogClose=function(e){if(this._warningDlg!==e){return}this._warningDlg=null;e.close();this.skip()};BX.CrmDedupeMergeAction.prototype.onWarningDialogIgnore=function(e){if(this._warningDlg!==e){return}this._warningDlg=null;e.close();this.merge()};BX.CrmDedupeMergeAction.prototype.merge=function(){this._manager.merge({seedEntityId:this._current["seedEntityId"],targEntityId:this._current["targEntityId"],indexTypeName:this._current["indexTypeName"],indexMatches:this._current["indexMatches"],anchor:this._anchor,callback:BX.delegate(this.onMergeCompleted,this)})};BX.CrmDedupeMergeAction.prototype.onMergeCompleted=function(e){var t=BX.type.isNotEmptyString(e["ERROR"])?e["ERROR"]:"";if(t!==""){this.stop(t)}else{this.runNext(e)}};BX.CrmDedupeMergeAction.prototype.getMessage=function(e){var t=BX.CrmDedupeMergeAction.messages;return t.hasOwnProperty(e)?t[e]:""};if(typeof BX.CrmDedupeMergeAction.messages==="undefined"){BX.CrmDedupeMergeAction.messages={}}BX.CrmDedupeMergeAction.create=function(e,t){var i=new BX.CrmDedupeMergeAction;i.initialize(e,t);return i}}if(typeof BX.CrmDedupeSkipAction==="undefined"){BX.CrmDedupeSkipAction=function(){BX.CrmDedupeSkipAction.superclass.constructor.apply(this);this._warningDlg=null};BX.extend(BX.CrmDedupeSkipAction,BX.CrmDedupeAction);BX.CrmDedupeSkipAction.prototype.iterate=function(){this.exec()};BX.CrmDedupeSkipAction.prototype.exec=function(){this._manager.skip({leftEntityId:this._current["leftEntityId"],rightEntityId:this._current["rightEntityId"],indexTypeName:this._current["indexTypeName"],leftEntityIndexMatches:this._current["leftEntityIndexMatches"],rightEntityIndexMatches:this._current["rightEntityIndexMatches"],anchor:this._anchor,callback:BX.delegate(this.onSkipCompleted,this)})};BX.CrmDedupeSkipAction.prototype.onSkipCompleted=function(e){var t=BX.type.isNotEmptyString(e["ERROR"])?e["ERROR"]:"";if(t!==""){this.stop(t)}else{this.runNext(e)}};BX.CrmDedupeSkipAction.create=function(e,t){var i=new BX.CrmDedupeSkipAction;i.initialize(e,t);return i}}if(typeof BX.CrmDedupeManager==="undefined"){BX.CrmDedupeManager=function(){this._serviceUrl=null;this._entityTypeName="";this._isRequestRunning=false;this._waiter=null;this._callback=null};BX.CrmDedupeManager.prototype={initialize:function(e,t){this._serviceUrl=e;this._entityTypeName=t},getEntityTypeName:function(){return this._entityTypeName},getMergeCollisions:function(e){this.startMergeCollisionsRequest(e)},startMergeCollisionsRequest:function(e){if(this._isRequestRunning){return false}this._isRequestRunning=true;this._anchor=BX.type.isDomNode(e["anchor"])?e["anchor"]:null;if(this._anchor){this._waiter=BX.showWait(this._anchor)}this._callback=BX.type.isFunction(e["callback"])?e["callback"]:null;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"GET_MERGE_COLLISIONS",ENTITY_TYPE_NAME:this._entityTypeName,SEED_ENTITY_ID:parseInt(e["seedEntityId"]),TARG_ENTITY_ID:parseInt(e["targEntityId"])},onsuccess:BX.delegate(this.onRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)});return true},merge:function(e){this.startMergeRequest(e)},startMergeRequest:function(e){if(this._isRequestRunning){return false}this._isRequestRunning=true;this._anchor=BX.type.isDomNode(e["anchor"])?e["anchor"]:null;if(this._anchor){this._waiter=BX.showWait(this._anchor)}this._callback=BX.type.isFunction(e["callback"])?e["callback"]:null;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"MERGE",ENTITY_TYPE_NAME:this._entityTypeName,SEED_ENTITY_ID:parseInt(e["seedEntityId"]),TARG_ENTITY_ID:parseInt(e["targEntityId"]),INDEX_TYPE_NAME:BX.type.isNotEmptyString(e["indexTypeName"])?e["indexTypeName"]:"",INDEX_MATCHES:typeof e["indexMatches"]!=="undefined"?e["indexMatches"]:{}},onsuccess:BX.delegate(this.onRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)});return true},skip:function(e){this.startSkipRequest(e)},startSkipRequest:function(e){if(this._isRequestRunning){return false}this._isRequestRunning=true;this._anchor=BX.type.isDomNode(e["anchor"])?e["anchor"]:null;if(this._anchor){this._waiter=BX.showWait(this._anchor)}this._callback=BX.type.isFunction(e["callback"])?e["callback"]:null;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"REGISTER_MISMATCH",ENTITY_TYPE_NAME:this._entityTypeName,LEFT_ENTITY_ID:parseInt(e["leftEntityId"]),RIGHT_ENTITY_ID:parseInt(e["rightEntityId"]),INDEX_TYPE_NAME:BX.type.isNotEmptyString(e["indexTypeName"])?e["indexTypeName"]:"",LEFT_ENTITY_INDEX_MATCHES:typeof e["leftEntityIndexMatches"]!=="undefined"?e["leftEntityIndexMatches"]:{},RIGHT_ENTITY_INDEX_MATCHES:typeof e["rightEntityIndexMatches"]!=="undefined"?e["rightEntityIndexMatches"]:{}},onsuccess:BX.delegate(this.onRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)});return true},onRequestSuccess:function(e){this._isRequestRunning=false;if(this._waiter){BX.closeWait(this._anchor,this._waiter);this._waiter=this._anchor=null}this.execCallback(e)},onRequestFailure:function(e){this._isRequestRunning=false;if(this._waiter){BX.closeWait(this._anchor,this._waiter);this._waiter=this._anchor=null}},execCallback:function(e){if(!this._callback){return}var t=this._callback;this._callback=null;window.setTimeout(function(){t(e)},0)}};BX.CrmDedupeManager.create=function(e,t){var i=new BX.CrmDedupeManager;i.initialize(e,t);return i}}if(typeof BX.CrmDedupeCollisionData==="undefined"){BX.CrmDedupeCollisionData=function(){this.readPermissionLack=false;this.updatePermissionLack=false;this.seedExternalOwnership=false;this.entityType="";this.info={}};BX.CrmDedupeCollisionData.prototype={initialize:function(e,t){if(BX.type.isArray(e)){for(var i=0;i<e.length;i++){var s=e[i].toUpperCase();if(s==="READ_PERMISSION_LACK"){this.readPermissionLack=true}else if(s==="UPDATE_PERMISSION_LACK"){this.updatePermissionLack=true}else if(s==="SEED_EXTERNAL_OWNERSHIP"){this.seedExternalOwnership=true}else if(s!=="NONE"){throw"CrmDedupeCollisionData: collision type '"+s+"' is not supported in current context"}}}this.entityType=t.charAt(0).toUpperCase()+t.substring(1).toLowerCase()},hasCollisions:function(){return this.readPermissionLack||this.updatePermissionLack||this.seedExternalOwnership},getMessage:function(e){var t=BX.CrmDedupeCollisionData.messages;return t.hasOwnProperty(e)?t[e]:""},getWarnings:function(e){if(!this.hasCollisions()){return[]}var t=[];if(this.seedExternalOwnership){t.push(this.getMessage(this.entityType.toLowerCase()+"SeedExternalOwnershipCollision"))}if(this.readPermissionLack&&this.updatePermissionLack){t.push(this.getMessage(this.entityType.toLowerCase()+"ReadUpdateCollision"))}else if(this.readPermissionLack){t.push(this.getMessage(this.entityType.toLowerCase()+"ReadCollision"))}else if(this.updatePermissionLack){t.push(this.getMessage(this.entityType.toLowerCase()+"UpdateCollision"))}for(var i=0;i<t.length;i++){t[i]=t[i].replace(/#SEED_ID#/gi,e["seedEntityId"]).replace(/#SEED_TITLE#/gi,e["seedTitle"]).replace(/#TARG_ID#/gi,e["targEntityId"]).replace(/#TARG_TITLE#/gi,e["targTitle"]).replace(/#RESPONSIBLE_NAME#/gi,e["seedResponsibleName"]).replace(/#RESPONSIBLE_ID#/gi,e["seedResponsibleId"])}return t}};if(typeof BX.CrmDedupeCollisionData.messages!=="undefined"){BX.CrmDedupeCollisionData.messages={}}BX.CrmDedupeCollisionData.create=function(e,t){var i=new BX.CrmDedupeCollisionData;i.initialize(e,t);return i}}if(typeof BX.CrmDedupeCollisionDialog=="undefined"){BX.CrmDedupeCollisionDialog=function(){this._id="";this._settings={};this._collisionData=null;this._contextData=null;this._popup=null;this._contentWrapper=null};BX.CrmDedupeCollisionDialog.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._collisionData=this.getSetting("collisionData",null);if(!this._collisionData){throw"BX.CrmDedupeCollisionDialog. Parameter 'collisionData' is not found."}this._contextData=this.getSetting("contextData",null);if(!this._contextData){throw"BX.CrmDedupeCollisionDialog. Parameter 'contextData' is not found."}},getSetting:function(e,t){return typeof this._settings[e]!="undefined"?this._settings[e]:t},setSetting:function(e,t){this._settings[e]=t},getId:function(){return this._id},show:function(){if(this.isShown()){return}var e=this.getId();if(BX.CrmDedupeCollisionDialog.windows[e]){BX.CrmDedupeCollisionDialog.windows[e].destroy()}var t=this.getSetting("anchor",null);this._popup=new BX.PopupWindow(e,t,{autoHide:false,draggable:true,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{marginRight:"4px",marginTop:"9px"},titleBar:this.getMessage("title"),events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},content:this.prepareContent(),className:"crm-tip-popup",lightShadow:true,buttons:[new BX.PopupWindowButton({text:this.getMessage("cancelButtonTitle"),className:"popup-window-button-create",events:{click:BX.delegate(this.onCancelButtonClick,this)}}),new BX.PopupWindowButtonLink({text:this.getMessage("ignoreButtonTitle"),className:"webform-button-link-cancel",events:{click:BX.delegate(this.onIgnoreButtonClick,this)}})]});BX.CrmDedupeCollisionDialog.windows[e]=this._popup;this._popup.show();this._contentWrapper.tabIndex="1";this._contentWrapper.focus()},close:function(){if(!(this._popup&&this._popup.isShown())){return}this._popup.close()},isShown:function(){return this._popup&&this._popup.isShown()},getMessage:function(e){return BX.CrmDedupeCollisionDialog.messages&&BX.CrmDedupeCollisionDialog.messages.hasOwnProperty(e)?BX.CrmDedupeCollisionDialog.messages[e]:""},prepareContent:function(){this._contentWrapper=BX.create("DIV",{attrs:{className:"crm-cont-info-popup"}});var e=this._collisionData.getWarnings(this._contextData);for(var t=0;t<e.length;t++){this._contentWrapper.appendChild(BX.create("DIV",{text:e[t]}))}this._contentWrapper.appendChild(BX.create("DIV",{text:this.getMessage("cancellationRecomendation")}));return this._contentWrapper},onCancelButtonClick:function(){this.execCallback("onCancel")},onIgnoreButtonClick:function(){this.execCallback("onIgnore")},onPopupShow:function(){if(!this._contentWrapper){return}BX.bind(this._contentWrapper,"keyup",BX.delegate(this.onKeyUp,this))},onPopupClose:function(){this.execCallback("onClose");if(this._popup){this._popup.destroy()}},onPopupDestroy:function(){if(this._popup){this._popup=null}},onKeyUp:function(e){var t=e.keyCode;if(t===13){this.execCallback("onCancel")}},execCallback:function(e){var t=this.getSetting(e,null);if(!t){return}var i=this;window.setTimeout(function(){t(i)},0)}};BX.CrmDedupeCollisionDialog.windows={};if(typeof BX.CrmDedupeCollisionDialog.messages==="undefined"){BX.CrmDedupeCollisionDialog.messages={}}BX.CrmDedupeCollisionDialog.create=function(e,t){var i=new BX.CrmDedupeCollisionDialog;i.initialize(e,t);return i}}if(typeof BX.CrmDedupeMultiFieldViewer==="undefined"){BX.CrmDedupeMultiFieldViewer=function(){this._id="";this._settings={};this._isInitialized=false;this._typeName="";this._owner=null;this._ignoredValue="";this._anchor=null;this._requestToShow=false;this._values=null;this._viewer=null};BX.CrmDedupeMultiFieldViewer.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._owner=this.getSetting("owner",null);this._typeName=this.getSetting("typeName","");this.setValues(this.getSetting("values",null));this.setIgnoredValue(this.getSetting("ignoredValue",""));this.setAnchor(this.getSetting("anchor",null));this._isInitialized=true},uninitialize:function(){if(this._viewer){this._viewer.close()}if(this._anchor){BX.unbind(this._anchor,"click",BX.delegate(this._onAnchorClick,this))}this._isInitialized=false},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getOwner:function(){return this._owner},getTypeName:function(){return this._typeName},getAnchor:function(){return this._anchor},setAnchor:function(e){this._anchor=BX.type.isElementNode(e)?e:null;if(this._anchor){BX.bind(this._anchor,"click",BX.delegate(this._onAnchorClick,this))}},getIgnoredValue:function(){return this._ignoredValue},setIgnoredValue:function(e){this._ignoredValue=e},getValues:function(){return this.values},setValues:function(e){this._values=e;if(this._isInitialized&&this._requestToShow&&this._values!==null){this.showPopup()}},showPopup:function(){if(!this._isInitialized){throw"CrmDedupeListMultiFieldViewer: Is not initialized"}if(this._values.length===0){return}var e=[];for(var t=0;t<this._values.length;t++){var i=this._values[t];if(this._ignoredValue!==i){e.push({value:i})}}if(e.length===0){return}if(!this._viewer){this._viewer=BX.CrmMultiFieldViewer.create(this._id,{typeName:this._typeName,items:e,anchorId:this._anchor})}this._viewer.show();this._requestToShow=false},_onAnchorClick:function(e){if(!this._isInitialized){return}if(this._values!==null){this.showPopup()}else{this._requestToShow=true;this._owner.loadMultiFields()}}};BX.CrmDedupeMultiFieldViewer.create=function(e,t){var i=new BX.CrmDedupeMultiFieldViewer;i.initialize(e,t);return i}}if(typeof BX.CrmDedupeRequisiteFieldViewer==="undefined"){BX.CrmDedupeRequisiteFieldViewer=function(){this._id="";this._settings={};this._isInitialized=false;this._fieldName="";this._owner=null;this._ignoredValue="";this._anchor=null;this._requestToShow=false;this._values=null;this._viewer=null};BX.CrmDedupeRequisiteFieldViewer.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._owner=this.getSetting("owner",null);this._fieldName=this.getSetting("fieldName","");this.setValues(this.getSetting("values",null));this.setIgnoredValue(this.getSetting("ignoredValue",""));this.setAnchor(this.getSetting("anchor",null));this._isInitialized=true},uninitialize:function(){if(this._viewer){this._viewer.close()}if(this._anchor){BX.unbind(this._anchor,"click",BX.delegate(this._onAnchorClick,this))}this._isInitialized=false},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getOwner:function(){return this._owner},getFieldName:function(){return this._fieldName},getAnchor:function(){return this._anchor},setAnchor:function(e){this._anchor=BX.type.isElementNode(e)?e:null;if(this._anchor){BX.bind(this._anchor,"click",BX.delegate(this._onAnchorClick,this))}},getIgnoredValue:function(){return this._ignoredValue},setIgnoredValue:function(e){this._ignoredValue=e},getValues:function(){return this.values},setValues:function(e){this._values=e;if(this._isInitialized&&this._requestToShow&&this._values!==null){this.showPopup()}},showPopup:function(){if(!this._isInitialized){throw"CrmDedupeRequisiteFieldViewer: Is not initialized"}if(this._values.length===0){return}var e=[];for(var t=0;t<this._values.length;t++){var i=this._values[t];if(this._ignoredValue!==i){e.push({value:i})}}if(e.length===0){return}if(!this._viewer){this._viewer=BX.CrmMultiFieldViewer.create(this._id,{typeName:this._fieldName,items:e,anchorId:this._anchor})}this._viewer.show();this._requestToShow=false},_onAnchorClick:function(e){if(!this._isInitialized){return}if(this._values!==null){this.showPopup()}else{this._requestToShow=true;this._owner.loadRequisiteFields()}}};BX.CrmDedupeRequisiteFieldViewer.create=function(e,t){var i=new BX.CrmDedupeRequisiteFieldViewer;i.initialize(e,t);return i}}
//# sourceMappingURL=script.map.js