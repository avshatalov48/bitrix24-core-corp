{"version":3,"file":"script.js","sources":["src/index.js"],"sourcesContent":["import {Loc, Text, Type, ajax} from 'main.core';\nimport {BaseEvent} from 'main.core.events';\n\nimport {Dialog} from 'ui.entity-selector';\nimport {Button} from 'ui.buttons';\n\nimport '../css/base.css';\n\ntype Params = {\n\tgroupId: number,\n\tselectorContainer?: HTMLElement,\n\tinfoContainer?: HTMLElement,\n\tcurrentSprint: Sprint,\n}\n\ntype Sprint = {\n\tid: number,\n\tname: string,\n\tdateStartFormatted: string,\n\tdateEndFormatted: string\n}\n\ntype ChartData = {\n\tday: number,\n\tidealValue: number,\n\tremainValue: number\n}\n\nexport class BurnDownChart\n{\n\tconstructor(params: Params)\n\t{\n\t\tthis.groupId = Type.isNumber(params.groupId) ? parseInt(params.groupId, 10) : 0;\n\t\tthis.selectorContainer = params.selectorContainer;\n\t\tthis.infoContainer = params.infoContainer;\n\t\tthis.currentSprint = params.currentSprint;\n\n\t\t/* eslint-disable */\n\t\tthis.sidePanelManager = BX.SidePanel.Instance;\n\t\t/* eslint-enable */\n\n\t\tthis.chart = null;\n\t}\n\n\trender(chartDiv: HTMLElement, data: ChartData)\n\t{\n\t\tthis.renderSelectorTo(this.selectorContainer);\n\n\t\tsetTimeout(() => this.create(chartDiv, data), 300);\n\t}\n\n\trenderSelectorTo(selectorContainer: HTMLElement)\n\t{\n\t\tif (!Type.isElementNode(selectorContainer))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.selectorButton = new Button({\n\t\t\ttext: this.currentSprint.dateStartFormatted + ' - ' + this.currentSprint.dateEndFormatted,\n\t\t\tcolor: Button.Color.LIGHT_BORDER,\n\t\t\tdropdown: true,\n\t\t\tclassName: 'ui-btn-themes',\n\t\t\tonclick: () => {\n\t\t\t\tconst dialog = this.createSelectorDialog(this.selectorButton.getContainer(), this.currentSprint);\n\t\t\t\tdialog.show();\n\t\t\t},\n\t\t});\n\n\t\tthis.selectorButton.renderTo(selectorContainer);\n\t}\n\n\tcreateSelectorDialog(targetNode: HTMLElement, currentSprint: Sprint): Dialog\n\t{\n\t\treturn new Dialog({\n\t\t\ttargetNode: targetNode,\n\t\t\twidth: 400,\n\t\t\theight: 300,\n\t\t\tmultiple: false,\n\t\t\tdropdownMode: true,\n\t\t\tenableSearch: true,\n\t\t\tcompactView: true,\n\t\t\tshowAvatars: false,\n\t\t\tcacheable: false,\n\t\t\tpreselectedItems: [['sprint-selector' , currentSprint.id]],\n\t\t\tentities: [\n\t\t\t\t{\n\t\t\t\t\tid: 'sprint-selector',\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tgroupId: this.groupId\n\t\t\t\t\t},\n\t\t\t\t\tdynamicLoad: true,\n\t\t\t\t\tdynamicSearch: true\n\t\t\t\t}\n\t\t\t],\n\t\t\tevents: {\n\t\t\t\t'Item:onSelect': (event: BaseEvent) => {\n\t\t\t\t\tconst { item: selectedItem } = event.getData();\n\n\t\t\t\t\tthis.selectorButton.setText(selectedItem.customData.get('label'));\n\n\t\t\t\t\tthis.changeChart(selectedItem.getId());\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t}\n\n\tchangeChart(sprintId: number)\n\t{\n\t\tajax.runComponentAction(\n\t\t\t'bitrix:tasks.scrum.burn.down',\n\t\t\t'changeChart',\n\t\t\t{\n\t\t\t\tmode: 'class',\n\t\t\t\tdata: {\n\t\t\t\t\tgroupId: this.groupId,\n\t\t\t\t\tsprintId: sprintId\n\t\t\t\t}\n\t\t\t}\n\t\t)\n\t\t\t.then((response) => {\n\t\t\t\tthis.chart.data = response.data.chart;\n\t\t\t\tthis.currentSprint = response.data.sprint;\n\n\t\t\t\tthis.infoContainer\n\t\t\t\t\t.querySelector('.tasks-scrum-sprint-burn-down-info-name')\n\t\t\t\t\t.textContent = Text.encode(this.currentSprint.name)\n\t\t\t\t;\n\t\t\t})\n\t\t;\n\t}\n\n\tcreate(chartDiv: HTMLElement, data: ChartData)\n\t{\n\t\twindow.am4core.useTheme(am4themes_animated);\n\n\t\tthis.chart = window.am4core.create(chartDiv, am4charts.XYChart);\n\t\tthis.chart.data = data;\n\t\tthis.chart.paddingRight = 40;\n\n\t\tthis.createAxises();\n\n\t\tthis.createIdealLine();\n\t\tthis.createRemainLine();\n\n\t\tthis.createLegend();\n\t}\n\n\tcreateAxises()\n\t{\n\t\tconst categoryAxis = this.chart.xAxes.push(new am4charts.CategoryAxis());\n\t\tcategoryAxis.renderer.grid.template.location = 0;\n\t\tcategoryAxis.dataFields.category = 'day';\n\t\tcategoryAxis.renderer.minGridDistance = 60;\n\n\t\tconst valueAxis = this.chart.yAxes.push(new am4charts.ValueAxis());\n\t\tvalueAxis.min = -0.1;\n\t}\n\n\tcreateIdealLine()\n\t{\n\t\tconst lineSeries = this.chart.series.push(new am4charts.LineSeries());\n\t\tlineSeries.name = Loc.getMessage('TASKS_SCRUM_SPRINT_IDEAL_BURN_DOWN_CHART_LINE_LABEL');\n\t\tlineSeries.stroke = window.am4core.color('#2882b3');\n\t\tlineSeries.strokeWidth = 2;\n\n\t\tlineSeries.dataFields.categoryX = 'day';\n\t\tlineSeries.dataFields.valueY = 'idealValue';\n\n\t\tconst circleColor = '#2882b3';\n\t\tconst circleBullet = new am4charts.CircleBullet();\n\t\tcircleBullet.circle.radius = 4;\n\t\tcircleBullet.circle.fill = window.am4core.color(circleColor);\n\t\tcircleBullet.circle.stroke = window.am4core.color(circleColor);\n\n\t\tlineSeries.bullets.push(circleBullet);\n\n\t\tconst segment = lineSeries.segments.template;\n\t\tconst hoverState = segment.states.create('hover');\n\t\thoverState.properties.strokeWidth = 4;\n\t}\n\n\tcreateRemainLine()\n\t{\n\t\tconst lineSeries = this.chart.series.push(new am4charts.LineSeries());\n\t\tlineSeries.name = Loc.getMessage('TASKS_SCRUM_SPRINT_REMAIN_BURN_DOWN_CHART_LINE_LABEL');\n\t\tlineSeries.stroke = window.am4core.color('#9c1f1f');\n\t\tlineSeries.strokeWidth = 2;\n\n\t\tlineSeries.dataFields.categoryX = 'day';\n\t\tlineSeries.dataFields.valueY = 'remainValue';\n\n\t\tconst circleColor = '#9c1f1f';\n\t\tconst circleBullet = new am4charts.CircleBullet();\n\t\tcircleBullet.circle.radius = 4;\n\t\tcircleBullet.circle.fill = window.am4core.color(circleColor);\n\t\tcircleBullet.circle.stroke = window.am4core.color(circleColor);\n\n\t\tlineSeries.bullets.push(circleBullet);\n\n\t\tconst segment = lineSeries.segments.template;\n\t\tconst hoverState = segment.states.create('hover');\n\t\thoverState.properties.strokeWidth = 4;\n\t}\n\n\tcreateLegend()\n\t{\n\t\tthis.chart.legend = new am4charts.Legend();\n\t\tthis.chart.legend.itemContainers.template.clickable = false;\n\t\tthis.chart.legend.position = 'bottom';\n\t\tthis.chart.legend.itemContainers.template.events.on('over', (event) => {\n\t\t\tthis.processOver(event.target.dataItem.dataContext);\n\t\t});\n\t\tthis.chart.legend.itemContainers.template.events.on('out', () => this.processOut());\n\t}\n\n\tprocessOver(hoveredLine)\n\t{\n\t\thoveredLine.toFront();\n\t\thoveredLine.segments.each((segment) => segment.setState('hover'));\n\t};\n\n\tprocessOut()\n\t{\n\t\tthis.chart.series.each((series) => {\n\t\t\tseries.segments.each((segment) => segment.setState('default'));\n\t\t\tseries.bulletsContainer.setState('default');\n\t\t});\n\t};\n}"],"names":["BurnDownChart","params","groupId","Type","isNumber","parseInt","selectorContainer","infoContainer","currentSprint","sidePanelManager","BX","SidePanel","Instance","chart","chartDiv","data","renderSelectorTo","setTimeout","create","isElementNode","selectorButton","Button","text","dateStartFormatted","dateEndFormatted","color","Color","LIGHT_BORDER","dropdown","className","onclick","dialog","createSelectorDialog","getContainer","show","renderTo","targetNode","Dialog","width","height","multiple","dropdownMode","enableSearch","compactView","showAvatars","cacheable","preselectedItems","id","entities","options","dynamicLoad","dynamicSearch","events","event","getData","selectedItem","item","setText","customData","get","changeChart","getId","sprintId","ajax","runComponentAction","mode","then","response","sprint","querySelector","textContent","Text","encode","name","window","am4core","useTheme","am4themes_animated","am4charts","XYChart","paddingRight","createAxises","createIdealLine","createRemainLine","createLegend","categoryAxis","xAxes","push","CategoryAxis","renderer","grid","template","location","dataFields","category","minGridDistance","valueAxis","yAxes","ValueAxis","min","lineSeries","series","LineSeries","Loc","getMessage","stroke","strokeWidth","categoryX","valueY","circleColor","circleBullet","CircleBullet","circle","radius","fill","bullets","segment","segments","hoverState","states","properties","legend","Legend","itemContainers","clickable","position","on","processOver","target","dataItem","dataContext","processOut","hoveredLine","toFront","each","setState","bulletsContainer"],"mappings":"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"}