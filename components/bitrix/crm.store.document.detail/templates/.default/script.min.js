this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};this.BX.Crm.Store=this.BX.Crm.Store||{};(function(e,t,n,o,a,i){"use strict";function r(e,t){l(e,t);t.add(e)}function s(e,t,n){l(e,t);t.set(e,n)}function l(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function c(e,t,n){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return n}var d=new WeakMap;var u=new WeakMap;var v=new WeakSet;var f=function(){function e(t){babelHelpers.classCallCheck(this,e);r(this,v);s(this,d,{writable:true,value:void 0});s(this,u,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,d,t.onboardingData);babelHelpers.classPrivateFieldSet(this,u,t.documentGuid)}babelHelpers.createClass(e,[{key:"processOnboarding",value:function e(){var t=babelHelpers.classPrivateFieldGet(this,d).chain;var n=babelHelpers.classPrivateFieldGet(this,d).chainStep;if(t===1&&n===1){c(this,v,E).call(this)}}}]);return e}();function E(){var e=document.querySelector("#".concat(babelHelpers.classPrivateFieldGet(this,u),"_TABS_MENU"));var t=new BX.SpotLight({id:"arrow_spotlight",targetElement:document.querySelector("[data-tab-id=tab_products]"),autoSave:true,targetVertex:"middle-center",zIndex:200});t.show();t.container.style.pointerEvents="none";var n=function n(o){t.close();var r=babelHelpers.slicedToArray(o.data,1),s=r[0];var l=function t(){var n=s.getActiveHint();if(n!==null){n.close();a.Event.unbind(e,"click",t)}};a.Event.bind(e,"click",l);s.showFieldTourHint("AMOUNT",{title:a.Loc.getMessage("CRM_STORE_DOCUMENT_WAREHOUSE_PRODUCT_AMOUNT_GUIDE_TITLE"),text:a.Loc.getMessage("CRM_STORE_DOCUMENT_WAREHOUSE_PRODUCT_AMOUNT_GUIDE_TEXT")},(function(){a.userOptions.save("crm","warehouse-onboarding","secondChainStage",2);a.userOptions.save("crm","warehouse-onboarding","chainStage",2);a.Event.unbind(e,"click",l);i.EventEmitter.unsubscribe("onDemandRecalculateWrapper",n)}))};i.EventEmitter.subscribe("onDemandRecalculateWrapper",n)}var b;function m(e,t,n){C(e,t);t.set(e,n)}function C(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function h(e,t,n){g(e,t);B(n,"get");return p(e,n)}function p(e,t){if(t.get){return t.get.call(e)}return t.value}function _(e,t,n,o){g(e,t);B(n,"set");y(e,n,o);return o}function B(e,t){if(e===undefined){throw new TypeError("attempted to "+t+" private static field before its declaration")}}function g(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function y(e,t,n){if(t.set){t.set.call(e,n)}else{if(!t.writable){throw new TypeError("attempted to set read only private field")}t.value=n}}var S=new WeakMap;var T=function(e){babelHelpers.inherits(t,e);function t(e,n){var o;babelHelpers.classCallCheck(this,t);o=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e,n));m(babelHelpers.assertThisInitialized(o),S,{writable:true,value:null});o.isDocumentDeducted=n.documentStatus==="Y";o.isDeductLocked=n.isDeductLocked;o.masterSliderUrl=n.masterSliderUrl;o.addCopyLinkPopup();i.EventEmitter.subscribe("BX.Crm.EntityEditor:onFailedValidation",(function(e){i.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"main"})}));i.EventEmitter.subscribe("onProductsCheckFailed",(function(e){i.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"tab_products"})}));i.EventEmitter.subscribe("BX.Crm.EntityEditor:onSave",(function(e){var n=e.data[0];if(n&&n._ajaxForm){var a,i;var r=((a=n._ajaxForm)===null||a===void 0?void 0:a._actionName)==="SAVE"?"save":(i=n._ajaxForm)===null||i===void 0?void 0:i._config.data.ACTION;if(r===t.saveAndDeductAction){var s=o.getControllersIssues(n.getControllers());if(s.length>0){var l,c;e.data[1].cancel=true;(l=n._toolPanel)===null||l===void 0?void 0:l.setLocked(false);(c=n._toolPanel)===null||c===void 0?void 0:c.addError(s[0]);return}}if(r==="SAVE"){r="save"}var d={isNewDocument:o.entityId<=0?"Y":"N"};if(r){d.action=r}n._ajaxForm.addUrlParams(d)}}));i.EventEmitter.subscribe("BX.Catalog.EntityCard.TabManager:onSelectItem",(function(e){var t=e.data.tabId;if(t==="tab_products"&&!o.isTabAnalyticsSent){o.sendAnalyticsData({tab:"products",isNewDocument:o.entityId<=0?"Y":"N",documentType:"W"});o.isTabAnalyticsSent=true}}));_(t,t,D,babelHelpers.assertThisInitialized(o));BX.UI.SidePanel.Wrapper.setParam("closeAfterSave",true);o.showNotificationOnClose=false;return o}babelHelpers.createClass(t,[{key:"getControllersIssues",value:function e(t){var n=[];if(t instanceof Array){t.forEach((function(e){if(e instanceof BX.Crm.EntityStoreDocumentProductListController){n.push.apply(n,babelHelpers.toConsumableArray(e.getErrorCollection()))}}))}return n}},{key:"openMasterSlider",value:function e(){var t=this;BX.SidePanel.Instance.open(this.masterSliderUrl,{cacheable:false,data:{openGridOnDone:false},events:{onCloseComplete:function e(n){var o=n.getSlider();if(!o){return}if(o.getData().get("isInventoryManagementEnabled")){t.isDeductLocked=false;var a=BX.SidePanel.Instance.getOpenSliders();a.forEach((function(e){var t,n;if((t=e.getWindow())!==null&&t!==void 0&&(n=t.BX.Catalog)!==null&&n!==void 0&&n.DocumentGridManager){e.allowChangeHistory=false;e.getWindow().location.reload()}}))}}}})}},{key:"adjustToolPanel",value:function e(){var n=this;var r=this.getEditorInstance();if(!r){return}var s=r._toolPanel;var l=r._toolPanel._editButton;this.defaultSaveActionName=r._ajaxForm._config.data.ACTION;this.defaultOnSuccessCallback=r._ajaxForm._config.onsuccess;l.onclick=function(e){n.showNotificationOnClose=false;r._ajaxForm._config.data.ACTION=n.defaultSaveActionName;r._ajaxForm._config.onsuccess=n.defaultOnSuccessCallback;s.onSaveButtonClick(e)};var c=a.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(['<button class="ui-btn ui-btn-light-border">',"</button>"])),a.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_SAVE_AND_DEDUCT_BUTTON"));c.onclick=function(e){if(n.isDeductLocked){n.openMasterSlider();return}r._ajaxForm._config.data.ACTION=t.saveAndDeductAction;r._ajaxForm._config.onsuccess=function(e){n.showNotificationOnClose=true;var t=BX.prop.getString(e,"ERROR","");if(!t){n.setViewModeButtons(r)}r.onSaveSuccess(e)};s.onSaveButtonClick(e)};l.after(c);this.deductAndSaveButton=c;var d=new o.Button({text:this.isDocumentDeducted?a.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_CANCEL_DEDUCT_BUTTON"):a.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_DEDUCT_BUTTON"),color:o.ButtonColor.LIGHT_BORDER,onclick:function e(a,i){if(s.isLocked()){return}if(n.isDeductLocked){n.openMasterSlider();return}a.setState(o.ButtonState.CLOCKING);s.setLocked(true);var l=n.isDocumentDeducted?t.cancelDeductAction:t.deductAction;if(l===t.deductAction){var c=r.getControllers();var d=[];c.forEach((function(e){if(e instanceof BX.Crm.EntityStoreDocumentProductListController){if(!e.validateProductList()){d.push.apply(d,babelHelpers.toConsumableArray(e.getErrorCollection()))}}}));if(d.length>0){s.clearErrors();s.addError(d[0]);s.setLocked(false);a.setActive(true);return}}var u={};if(window.EntityEditorDocumentOrderShipmentController){u=window.EntityEditorDocumentOrderShipmentController.demandFormData()}var v=r.createAjaxForm({actionName:l,enableRequiredUserFieldCheck:false,formData:u},{onSuccess:function e(t){if(!n.isDocumentDeducted){n.showNotificationOnClose=true}a.setState(o.ButtonState.ACTIVE);r.onSaveSuccess(t)},onFailure:function e(t){a.setState(o.ButtonState.ACTIVE);r.onSaveFailure(t)}});v.addUrlParams({action:l,documentType:"W"});v.submit()}}).render();l.after(d);this.deductButton=d;i.EventEmitter.subscribe("BX.Crm.EntityEditor:onControlModeChange",(function(e){var t=e.data[0];var o=e.data[1].control;if(o.getMode()===BX.Crm.EntityEditorMode.edit){n.setEditModeButtons(t)}else{n.setViewModeButtons(t)}}));i.EventEmitter.subscribe("BX.Crm.EntityEditor:onControlChange",(function(e){var t=e.data[0];n.setEditModeButtons(t)}));i.EventEmitter.subscribe("BX.Crm.EntityEditor:onControllerChange",(function(e){var t=e.data[0];n.setEditModeButtons(t)}));i.EventEmitter.subscribe("BX.Crm.EntityEditor:onSwitchToViewMode",(function(e){var t=e.data[0];n.setViewModeButtons(t)}));i.EventEmitter.subscribe("BX.Crm.EntityEditor:onNothingChanged",(function(e){var t=e.data[0];n.setViewModeButtons(t)}));i.EventEmitter.subscribe("onEntityCreate",(function(e){var t;var n=e===null||e===void 0?void 0:(t=e.data[0])===null||t===void 0?void 0:t.sender;if(n){n._toolPanel.disableSaveButton();n.hideToolPanel()}}));i.EventEmitter.subscribe("beforeCrmEntityRedirect",(function(e){var t;var o=e===null||e===void 0?void 0:(t=e.data[0])===null||t===void 0?void 0:t.sender;if(o){o._toolPanel.disableSaveButton();o.hideToolPanel();if(n.showNotificationOnClose){var i=e.data[0].redirectUrl;if(!i){return}i=BX.Uri.removeParam(i,"closeOnSave");window.top.BX.UI.Notification.Center.notify({content:a.Loc.getMessage("CRM_STORE_DOCUMENT_SAVE_AND_CONDUCT_NOTIFICATION"),actions:[{title:a.Loc.getMessage("CRM_STORE_DOCUMENT_OPEN_DOCUMENT"),href:i,events:{click:function e(t,n,o){n.close()}}}]})}}}));if(r.isNew()){this.setEditModeButtons(r)}else{this.setViewModeButtons(r)}}},{key:"setViewModeButtons",value:function e(t){if(t._toolPanel&&t._toolPanel.hasOwnProperty("_cancelButton")){BX.hide(t._toolPanel._cancelButton)}if(t._toolPanel&&t._toolPanel.hasOwnProperty("_editButton")){BX.hide(t._toolPanel._editButton)}if(this.deductAndSaveButton){BX.hide(this.deductAndSaveButton)}if(this.deductButton){BX.show(this.deductButton)}}},{key:"setEditModeButtons",value:function e(t){if(t._toolPanel&&t._toolPanel.hasOwnProperty("_cancelButton")){BX.show(t._toolPanel._cancelButton)}if(t._toolPanel&&t._toolPanel.hasOwnProperty("_editButton")){BX.show(t._toolPanel._editButton)}if(this.deductAndSaveButton&&!this.isDocumentDeducted){BX.show(this.deductAndSaveButton)}if(this.deductButton&&!this.isDocumentDeducted){BX.hide(this.deductButton)}}},{key:"getEditorInstance",value:function e(){if(a.Reflection.getClass("BX.Crm.EntityEditor")){return BX.Crm.EntityEditor.getDefault()}return null}},{key:"addCopyLinkPopup",value:function e(){var t=this;var n=document.getElementById(this.settings.copyLinkButtonId);if(!n){return}n.onclick=function(){t.copyDocumentLinkToClipboard()}}},{key:"copyDocumentLinkToClipboard",value:function e(){var t=BX.util.remove_url_param(window.location.href,["IFRAME","IFRAME_TYPE"]);if(!BX.clipboard.copy(t)){return}var n=new BX.PopupWindow("catalog_copy_document_url_to_clipboard",document.getElementById(this.settings.copyLinkButtonId),{content:a.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_LINK_COPIED"),darkMode:true,autoHide:true,zIndex:1e3,angle:true,bindOptions:{position:"top"}});n.show();setTimeout((function(){n.close()}),1500)}},{key:"sendAnalyticsData",value:function e(t){BX.ajax.runComponentAction("bitrix:crm.store.document.detail","sendAnalytics",{mode:"class",analyticsLabel:t})}},{key:"enableOnboardingChain",value:function e(t){if(babelHelpers.classPrivateFieldGet(this,S)===null){babelHelpers.classPrivateFieldSet(this,S,new f({onboardingData:t,documentGuid:this.id}));babelHelpers.classPrivateFieldGet(this,S).processOnboarding()}}}],[{key:"getInstance",value:function e(){return h(t,t,D)}}]);return t}(n.BaseCard);var D={writable:true,value:void 0};babelHelpers.defineProperty(T,"saveAndDeductAction","saveAndDeduct");babelHelpers.defineProperty(T,"deductAction","deduct");babelHelpers.defineProperty(T,"cancelDeductAction","cancelDeduct");e.Document=T})(this.BX.Crm.Store.DocumentCard=this.BX.Crm.Store.DocumentCard||{},BX,BX.Catalog.EntityCard,BX.UI,BX,BX.Event);
//# sourceMappingURL=script.map.js