this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};this.BX.Crm.Store=this.BX.Crm.Store||{};(function(t,e,n,o,i){"use strict";var a;function r(t,e,n){l(t,e);d(n,"get");return s(t,n)}function s(t,e){if(e.get){return e.get.call(t)}return e.value}function c(t,e,n,o){l(t,e);d(n,"set");u(t,n,o);return o}function d(t,e){if(t===undefined){throw new TypeError("attempted to "+e+" private static field before its declaration")}}function l(t,e){if(t!==e){throw new TypeError("Private static access of wrong provenance")}}function u(t,e,n){if(e.set){e.set.call(t,n)}else{if(!e.writable){throw new TypeError("attempted to set read only private field")}e.value=n}}var f=function(t){babelHelpers.inherits(n,t);function n(t,e){var i;babelHelpers.classCallCheck(this,n);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this,t,e));i.isDocumentDeducted=e.documentStatus==="Y";i.isDeductLocked=e.isDeductLocked;i.masterSliderUrl=e.masterSliderUrl;i.addCopyLinkPopup();o.EventEmitter.subscribe("BX.Crm.EntityEditor:onFailedValidation",(function(t){o.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"main"})}));o.EventEmitter.subscribe("onProductsCheckFailed",(function(t){o.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"tab_products"})}));o.EventEmitter.subscribe("BX.Crm.EntityEditor:onSave",(function(t){var e=t.data[0];if(e&&e._ajaxForm){var o,a;var r=((o=e._ajaxForm)===null||o===void 0?void 0:o._actionName)==="SAVE"?"save":(a=e._ajaxForm)===null||a===void 0?void 0:a._config.data.ACTION;if(r===n.saveAndDeductAction){var s=i.getControllersIssues(e.getControllers());if(s.length>0){var c,d;t.data[1].cancel=true;(c=e._toolPanel)===null||c===void 0?void 0:c.setLocked(false);(d=e._toolPanel)===null||d===void 0?void 0:d.addError(s[0]);return}}var l={isNewDocument:i.entityId<=0?"Y":"N"};if(r){l.action=r}e._ajaxForm.addUrlParams(l)}}));o.EventEmitter.subscribe("BX.Catalog.EntityCard.TabManager:onSelectItem",(function(t){var e=t.data.tabId;if(e==="tab_products"&&!i.isTabAnalyticsSent){i.sendAnalyticsData({tab:"products",isNewDocument:i.entityId<=0?"Y":"N",documentType:"W"});i.isTabAnalyticsSent=true}}));c(n,n,v,babelHelpers.assertThisInitialized(i));BX.UI.SidePanel.Wrapper.setParam("closeAfterSave",true);i.showNotificationOnClose=false;return i}babelHelpers.createClass(n,[{key:"getControllersIssues",value:function t(e){var n=[];if(e instanceof Array){e.forEach((function(t){if(t instanceof BX.Crm.EntityStoreDocumentProductListController){n.push.apply(n,babelHelpers.toConsumableArray(t.getErrorCollection()))}}))}return n}},{key:"openMasterSlider",value:function t(){var e=this;BX.SidePanel.Instance.open(this.masterSliderUrl,{cacheable:false,data:{openGridOnDone:false},events:{onCloseComplete:function t(n){var o=n.getSlider();if(!o){return}if(o.getData().get("isInventoryManagementEnabled")){e.isDeductLocked=false;var i=BX.SidePanel.Instance.getOpenSliders();i.forEach((function(t){var e,n;if((e=t.getWindow())!==null&&e!==void 0&&(n=e.BX.Catalog)!==null&&n!==void 0&&n.DocumentGridManager){t.allowChangeHistory=false;t.getWindow().location.reload()}}))}}}})}},{key:"adjustToolPanel",value:function t(){var r=this;var s=this.getEditorInstance();if(!s){return}var c=s._toolPanel;var d=s._toolPanel._editButton;this.defaultSaveActionName=s._ajaxForm._config.data.ACTION;this.defaultOnSuccessCallback=s._ajaxForm._config.onsuccess;d.onclick=function(t){r.showNotificationOnClose=false;s._ajaxForm._config.data.ACTION=r.defaultSaveActionName;s._ajaxForm._config.onsuccess=r.defaultOnSuccessCallback;c.onSaveButtonClick(t)};var l=e.Tag.render(a||(a=babelHelpers.taggedTemplateLiteral(['<button class="ui-btn ui-btn-light-border">',"</button>"])),e.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_SAVE_AND_DEDUCT_BUTTON"));l.onclick=function(t){if(r.isDeductLocked){r.openMasterSlider();return}s._ajaxForm._config.data.ACTION=n.saveAndDeductAction;s._ajaxForm._config.onsuccess=function(t){r.showNotificationOnClose=true;var e=BX.prop.getString(t,"ERROR","");if(!e){r.setViewModeButtons(s)}s.onSaveSuccess(t)};c.onSaveButtonClick(t)};d.after(l);this.deductAndSaveButton=l;var u=new i.Button({text:this.isDocumentDeducted?e.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_CANCEL_DEDUCT_BUTTON"):e.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_DEDUCT_BUTTON"),color:i.ButtonColor.LIGHT_BORDER,onclick:function t(e,o){if(c.isLocked()){return}if(r.isDeductLocked){r.openMasterSlider();return}e.setState(i.ButtonState.CLOCKING);c.setLocked(true);var a=r.isDocumentDeducted?n.cancelDeductAction:n.deductAction;if(a===n.deductAction){var d=s.getControllers();var l=[];d.forEach((function(t){if(t instanceof BX.Crm.EntityStoreDocumentProductListController){if(!t.validateProductList()){l.push.apply(l,babelHelpers.toConsumableArray(t.getErrorCollection()))}}}));if(l.length>0){c.clearErrors();c.addError(l[0]);c.setLocked(false);e.setActive(true);return}}var u={};if(window.EntityEditorDocumentOrderShipmentController){u=window.EntityEditorDocumentOrderShipmentController.demandFormData()}var f=s.createAjaxForm({actionName:a,enableRequiredUserFieldCheck:false,formData:u},{onSuccess:function t(n){if(!r.isDocumentDeducted){r.showNotificationOnClose=true}e.setState(i.ButtonState.ACTIVE);s.onSaveSuccess(n)},onFailure:function t(n){e.setState(i.ButtonState.ACTIVE);s.onSaveFailure(n)}});f.addUrlParams({action:a});f.submit()}}).render();d.after(u);this.deductButton=u;o.EventEmitter.subscribe("BX.Crm.EntityEditor:onControlModeChange",(function(t){var e=t.data[0];var n=t.data[1].control;if(n.getMode()===BX.Crm.EntityEditorMode.edit){r.setEditModeButtons(e)}else{r.setViewModeButtons(e)}}));o.EventEmitter.subscribe("BX.Crm.EntityEditor:onControlChange",(function(t){var e=t.data[0];r.setEditModeButtons(e)}));o.EventEmitter.subscribe("BX.Crm.EntityEditor:onControllerChange",(function(t){var e=t.data[0];r.setEditModeButtons(e)}));o.EventEmitter.subscribe("BX.Crm.EntityEditor:onSwitchToViewMode",(function(t){var e=t.data[0];r.setViewModeButtons(e)}));o.EventEmitter.subscribe("BX.Crm.EntityEditor:onNothingChanged",(function(t){var e=t.data[0];r.setViewModeButtons(e)}));o.EventEmitter.subscribe("onEntityCreate",(function(t){var e;var n=t===null||t===void 0?void 0:(e=t.data[0])===null||e===void 0?void 0:e.sender;if(n){n._toolPanel.disableSaveButton();n.hideToolPanel()}}));o.EventEmitter.subscribe("beforeCrmEntityRedirect",(function(t){var n;var o=t===null||t===void 0?void 0:(n=t.data[0])===null||n===void 0?void 0:n.sender;if(o){o._toolPanel.disableSaveButton();o.hideToolPanel();if(r.showNotificationOnClose){var i=t.data[0].redirectUrl;if(!i){return}i=BX.Uri.removeParam(i,"closeOnSave");window.top.BX.UI.Notification.Center.notify({content:e.Loc.getMessage("CRM_STORE_DOCUMENT_SAVE_AND_CONDUCT_NOTIFICATION"),actions:[{title:e.Loc.getMessage("CRM_STORE_DOCUMENT_OPEN_DOCUMENT"),href:i,events:{click:function t(e,n,o){n.close()}}}]})}}}));if(s.isNew()){this.setEditModeButtons(s)}else{this.setViewModeButtons(s)}}},{key:"setViewModeButtons",value:function t(e){if(e._toolPanel&&e._toolPanel.hasOwnProperty("_cancelButton")){BX.hide(e._toolPanel._cancelButton)}if(e._toolPanel&&e._toolPanel.hasOwnProperty("_editButton")){BX.hide(e._toolPanel._editButton)}if(this.deductAndSaveButton){BX.hide(this.deductAndSaveButton)}if(this.deductButton){BX.show(this.deductButton)}}},{key:"setEditModeButtons",value:function t(e){if(e._toolPanel&&e._toolPanel.hasOwnProperty("_cancelButton")){BX.show(e._toolPanel._cancelButton)}if(e._toolPanel&&e._toolPanel.hasOwnProperty("_editButton")){BX.show(e._toolPanel._editButton)}if(this.deductAndSaveButton&&!this.isDocumentDeducted){BX.show(this.deductAndSaveButton)}if(this.deductButton&&!this.isDocumentDeducted){BX.hide(this.deductButton)}}},{key:"getEditorInstance",value:function t(){if(e.Reflection.getClass("BX.Crm.EntityEditor")){return BX.Crm.EntityEditor.getDefault()}return null}},{key:"addCopyLinkPopup",value:function t(){var e=this;var n=document.getElementById(this.settings.copyLinkButtonId);if(!n){return}n.onclick=function(){e.copyDocumentLinkToClipboard()}}},{key:"copyDocumentLinkToClipboard",value:function t(){var n=BX.util.remove_url_param(window.location.href,["IFRAME","IFRAME_TYPE"]);if(!BX.clipboard.copy(n)){return}var o=new BX.PopupWindow("catalog_copy_document_url_to_clipboard",document.getElementById(this.settings.copyLinkButtonId),{content:e.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_LINK_COPIED"),darkMode:true,autoHide:true,zIndex:1e3,angle:true,bindOptions:{position:"top"}});o.show();setTimeout((function(){o.close()}),1500)}},{key:"sendAnalyticsData",value:function t(e){BX.ajax.runComponentAction("bitrix:crm.store.document.detail","sendAnalytics",{mode:"class",analyticsLabel:e})}}],[{key:"getInstance",value:function t(){return r(n,n,v)}}]);return n}(n.BaseCard);var v={writable:true,value:void 0};babelHelpers.defineProperty(f,"saveAndDeductAction","saveAndDeduct");babelHelpers.defineProperty(f,"deductAction","deduct");babelHelpers.defineProperty(f,"cancelDeductAction","cancelDeduct");t.Document=f})(this.BX.Crm.Store.DocumentCard=this.BX.Crm.Store.DocumentCard||{},BX,BX.Catalog.EntityCard,BX.Event,BX.UI);
//# sourceMappingURL=script.map.js