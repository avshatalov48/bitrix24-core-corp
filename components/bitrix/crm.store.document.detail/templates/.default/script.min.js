this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};this.BX.Crm.Store=this.BX.Crm.Store||{};(function(e,t,n,r,o,a){"use strict";function i(e,t){var n=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=s(e))||t&&e&&typeof e.length==="number"){if(n)e=n;var r=0;var o=function e(){};return{s:o,n:function t(){if(r>=e.length)return{done:true};return{done:false,value:e[r++]}},e:function e(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,i=false,l;return{s:function t(){n=n.call(e)},n:function e(){var t=n.next();a=t.done;return t},e:function e(t){i=true;l=t},f:function e(){try{if(!a&&n["return"]!=null)n["return"]()}finally{if(i)throw l}}}}function s(e,t){if(!e)return;if(typeof e==="string")return l(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor)n=e.constructor.name;if(n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return l(e,t)}function l(e,t){if(t==null||t>e.length)t=e.length;for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function u(e,t){d(e,t);t.add(e)}function c(e,t,n){d(e,t);t.set(e,n)}function d(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function f(e,t,n){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return n}var v=new WeakMap;var m=new WeakMap;var b=new WeakMap;var p=new WeakSet;var E=new WeakSet;var h=new WeakSet;var C=function(){function e(t){babelHelpers.classCallCheck(this,e);u(this,h);u(this,E);u(this,p);c(this,v,{writable:true,value:void 0});c(this,m,{writable:true,value:void 0});c(this,b,{writable:true,value:null});babelHelpers.classPrivateFieldSet(this,v,t.onboardingData);babelHelpers.classPrivateFieldSet(this,m,t.documentGuid);if(t.productListController){babelHelpers.classPrivateFieldSet(this,b,t.productListController)}}babelHelpers.createClass(e,[{key:"processOnboarding",value:function e(){var t=babelHelpers.classPrivateFieldGet(this,v).chain;var n=babelHelpers.classPrivateFieldGet(this,v).chainStep;if(t===1&&n===1){var r=f(this,E,g).call(this);if(r){f(this,p,y).call(this,r)}}}}]);return e}();function y(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var t=document.querySelector("#".concat(babelHelpers.classPrivateFieldGet(this,m),"_TABS_MENU"));var n=new BX.SpotLight({id:"arrow_spotlight",targetElement:document.querySelector("[data-tab-id=tab_products]"),autoSave:true,targetVertex:"middle-center",zIndex:200});n.show();n.container.style.pointerEvents="none";var r=function r(i){n.close();var s=babelHelpers.slicedToArray(i.data,1),l=s[0];var u=function e(){var n=l.getActiveHint();if(n!==null){n.close();o.Event.unbind(t,"click",e)}};o.Event.bind(t,"click",u);var c=function e(t){var n,r;if((t===null||t===void 0?void 0:(n=t.data)===null||n===void 0?void 0:n.tabId)==="tab_products"){return}(r=l.getActiveHint())===null||r===void 0?void 0:r.close()};l.showFieldTourHint("AMOUNT",{title:o.Loc.getMessage("CRM_STORE_DOCUMENT_WAREHOUSE_PRODUCT_AMOUNT_GUIDE_TITLE_2"),text:o.Loc.getMessage("CRM_STORE_DOCUMENT_WAREHOUSE_PRODUCT_AMOUNT_GUIDE_TEXT")},(function(){o.userOptions.save("crm","warehouse-onboarding","secondChainStage",2);o.userOptions.save("crm","warehouse-onboarding","chainStage",2);o.Event.unbind(t,"click",u);a.EventEmitter.unsubscribe("onDemandRecalculateWrapper",r);a.EventEmitter.unsubscribe("BX.Catalog.EntityCard.TabManager:onOpenTab",c)}),[],e);a.EventEmitter.subscribe("BX.Catalog.EntityCard.TabManager:onOpenTab",c)};a.EventEmitter.subscribe("onDemandRecalculateWrapper",r)}function g(){var e=f(this,h,S).call(this);var t=i(e),n;try{for(t.s();!(n=t.n()).done;){var r=n.value;if(!r.getModel().isService()){return r.getId()}}}catch(e){t.e(e)}finally{t.f()}return""}function S(){if(babelHelpers.classPrivateFieldGet(this,b)&&babelHelpers.classPrivateFieldGet(this,b).productList){if(babelHelpers.classPrivateFieldGet(this,b).productList.products instanceof Array){return babelHelpers.classPrivateFieldGet(this,b).productList.products}}return[]}var B;function _(e,t){var n=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=T(e))||t&&e&&typeof e.length==="number"){if(n)e=n;var r=0;var o=function e(){};return{s:o,n:function t(){if(r>=e.length)return{done:true};return{done:false,value:e[r++]}},e:function e(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,i=false,s;return{s:function t(){n=n.call(e)},n:function e(){var t=n.next();a=t.done;return t},e:function e(t){i=true;s=t},f:function e(){try{if(!a&&n["return"]!=null)n["return"]()}finally{if(i)throw s}}}}function T(e,t){if(!e)return;if(typeof e==="string")return w(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor)n=e.constructor.name;if(n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return w(e,t)}function w(e,t){if(t==null||t>e.length)t=e.length;for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function M(e,t){I(e,t);t.add(e)}function D(e,t,n){I(e,t);t.set(e,n)}function I(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function O(e,t,n){X(e,t);k(n,"get");return A(e,n)}function A(e,t){if(t.get){return t.get.call(e)}return t.value}function P(e,t,n,r){X(e,t);k(n,"set");L(e,n,r);return r}function k(e,t){if(e===undefined){throw new TypeError("attempted to "+t+" private static field before its declaration")}}function X(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function L(e,t,n){if(t.set){t.set.call(e,n)}else{if(!t.writable){throw new TypeError("attempted to set read only private field")}t.value=n}}function F(e,t,n){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return n}var N=new WeakMap;var U=new WeakSet;var H=function(e){babelHelpers.inherits(t,e);function t(e,n){var r;babelHelpers.classCallCheck(this,t);r=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e,n));M(babelHelpers.assertThisInitialized(r),U);D(babelHelpers.assertThisInitialized(r),N,{writable:true,value:null});r.isDocumentDeducted=n.documentStatus==="Y";r.isDeductLocked=n.isDeductLocked;r.masterSliderUrl=n.masterSliderUrl;r.inventoryManagementSource=n.inventoryManagementSource;r.permissions=n.permissions;r.isInventoryManagementDisabled=n.isInventoryManagementDisabled;r.inventoryManagementFeatureCode=n.inventoryManagementFeatureCode;r.addCopyLinkPopup();a.EventEmitter.subscribe("BX.Crm.EntityEditor:onFailedValidation",(function(e){a.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"main"})}));a.EventEmitter.subscribe("onProductsCheckFailed",(function(e){a.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"tab_products"})}));a.EventEmitter.subscribe("BX.Crm.EntityEditor:onSave",(function(e){var n=e.data[0];if(n&&n._ajaxForm){var o,a;if(r.isInventoryManagementDisabled){var i;e.data[1].cancel=true;(i=n._toolPanel)===null||i===void 0?void 0:i.setLocked(false);return}var s=((o=n._ajaxForm)===null||o===void 0?void 0:o._actionName)==="SAVE"?"save":(a=n._ajaxForm)===null||a===void 0?void 0:a._config.data.ACTION;if(s===t.saveAndDeductAction){var l=r.getControllersIssues(n.getControllers());if(l.length>0){var u,c;e.data[1].cancel=true;(u=n._toolPanel)===null||u===void 0?void 0:u.setLocked(false);(c=n._toolPanel)===null||c===void 0?void 0:c.addError(l[0]);return}}if(s==="SAVE"){s="save"}var d={isNewDocument:r.entityId<=0?"Y":"N",inventoryManagementSource:r.inventoryManagementSource};if(s){d.action=s}n._ajaxForm.addUrlParams(d)}}));a.EventEmitter.subscribe("BX.Catalog.EntityCard.TabManager:onSelectItem",(function(e){var t=e.data.tabId;if(t==="tab_products"&&!r.isTabAnalyticsSent){r.sendAnalyticsData({tab:"products",isNewDocument:r.entityId<=0?"Y":"N",documentType:"W",inventoryManagementSource:r.inventoryManagementSource});r.isTabAnalyticsSent=true}}));F(babelHelpers.assertThisInitialized(r),U,R).call(babelHelpers.assertThisInitialized(r));P(t,t,j,babelHelpers.assertThisInitialized(r));BX.UI.SidePanel.Wrapper.setParam("closeAfterSave",true);r.showNotificationOnClose=false;return r}babelHelpers.createClass(t,[{key:"focusOnTab",value:function e(t){a.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:t})}},{key:"getControllersIssues",value:function e(t){var n=[];if(Array.isArray(t)){t.forEach((function(e){if(e instanceof BX.Crm.EntityStoreDocumentProductListController){n.push.apply(n,babelHelpers.toConsumableArray(e.getErrorCollection()))}}))}return n}},{key:"openMasterSlider",value:function e(){var t=this;BX.SidePanel.Instance.open(this.masterSliderUrl,{cacheable:false,data:{openGridOnDone:false},events:{onCloseComplete:function e(n){var r=n.getSlider();if(!r){return}if(r.getData().get("isInventoryManagementEnabled")){t.isDeductLocked=false;var o=BX.SidePanel.Instance.getOpenSliders();o.forEach((function(e){var t,n;if((t=e.getWindow())!==null&&t!==void 0&&(n=t.BX.Catalog)!==null&&n!==void 0&&n.DocumentGridManager){e.allowChangeHistory=false;e.getWindow().location.reload()}}))}}}})}},{key:"adjustToolPanel",value:function e(){var n=this;var i=this.getEditorInstance();if(!i){return}var s=i._toolPanel;var l=i._toolPanel._editButton;this.defaultSaveActionName=i._ajaxForm._config.data.ACTION;this.defaultOnSuccessCallback=i._ajaxForm._config.onsuccess;l.onclick=function(e){if(n.isInventoryManagementDisabled&&n.inventoryManagementFeatureCode){top.BX.UI.InfoHelper.show(n.inventoryManagementFeatureCode);return}n.showNotificationOnClose=false;i._ajaxForm._config.data.ACTION=n.defaultSaveActionName;i._ajaxForm._config.onsuccess=n.defaultOnSuccessCallback;s.onSaveButtonClick(e)};if(this.permissions.conduct&&!this.isDocumentDeducted){var u=o.Tag.render(B||(B=babelHelpers.taggedTemplateLiteral(['<button class="ui-btn ui-btn-light-border">',"</button>"])),o.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_SAVE_AND_DEDUCT_BUTTON"));u.onclick=function(e){if(n.isInventoryManagementDisabled&&n.inventoryManagementFeatureCode){top.BX.UI.InfoHelper.show(n.inventoryManagementFeatureCode);return}if(n.isDeductLocked){n.openMasterSlider();return}i._ajaxForm._config.data.ACTION=t.saveAndDeductAction;i._ajaxForm._config.onsuccess=function(e){n.showNotificationOnClose=true;var t=BX.prop.getString(e,"ERROR","");if(!t){n.setViewModeButtons(i)}i.onSaveSuccess(e)};s.onSaveButtonClick(e)};l.after(u);this.deductAndSaveButton=u;var c=new r.Button({text:o.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_DEDUCT_BUTTON"),color:r.ButtonColor.LIGHT_BORDER,onclick:function e(o,a){if(s.isLocked()){return}if(n.isInventoryManagementDisabled&&n.inventoryManagementFeatureCode){top.BX.UI.InfoHelper.show(n.inventoryManagementFeatureCode);return}if(n.isDeductLocked){n.openMasterSlider();return}o.setState(r.ButtonState.CLOCKING);s.setLocked(true);var l=t.deductAction;var u=i.getControllers();var c=[];u.forEach((function(e){if(e instanceof BX.Crm.EntityStoreDocumentProductListController&&!e.validateProductList()){c.push.apply(c,babelHelpers.toConsumableArray(e.getErrorCollection()))}}));if(c.length>0){s.clearErrors();s.addError(c[0]);s.setLocked(false);o.setActive(true);return}var d={};if(window.EntityEditorDocumentOrderShipmentController){d=window.EntityEditorDocumentOrderShipmentController.demandFormData()}var f=i.createAjaxForm({actionName:l,enableRequiredUserFieldCheck:false,formData:d},{onSuccess:function e(t){if(!n.isDocumentDeducted){n.showNotificationOnClose=true}o.setState(r.ButtonState.ACTIVE);i.onSaveSuccess(t)},onFailure:function e(t){o.setState(r.ButtonState.ACTIVE);i.onSaveFailure(t)}});f.addUrlParams({action:l,documentType:"W"});f.submit()}}).render();l.after(c);this.deductButton=c}else if(this.permissions.cancel){var d=new r.Button({text:o.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_CANCEL_DEDUCT_BUTTON"),color:r.ButtonColor.LIGHT_BORDER,onclick:function e(o,a){if(s.isLocked()){return}if(n.isInventoryManagementDisabled&&n.inventoryManagementFeatureCode){top.BX.UI.InfoHelper.show(n.inventoryManagementFeatureCode);return}if(n.isDeductLocked){n.openMasterSlider();return}o.setState(r.ButtonState.CLOCKING);s.setLocked(true);var l=t.cancelDeductAction;var u={};if(window.EntityEditorDocumentOrderShipmentController){u=window.EntityEditorDocumentOrderShipmentController.demandFormData()}var c=i.createAjaxForm({actionName:l,enableRequiredUserFieldCheck:false,formData:u},{onSuccess:function e(t){if(!n.isDocumentDeducted){n.showNotificationOnClose=true}o.setState(r.ButtonState.ACTIVE);i.onSaveSuccess(t)},onFailure:function e(t){o.setState(r.ButtonState.ACTIVE);i.onSaveFailure(t)}});c.addUrlParams({action:l,documentType:"W",inventoryManagementSource:n.inventoryManagementSource});c.submit()}}).render();l.after(d);this.deductButton=d}a.EventEmitter.subscribe("BX.Crm.EntityEditor:onControlModeChange",(function(e){var t=e.data[0];var r=e.data[1].control;if(r.getMode()===BX.Crm.EntityEditorMode.edit){n.setEditModeButtons(t)}else{n.setViewModeButtons(t)}}));a.EventEmitter.subscribe("BX.Crm.EntityEditor:onControlChange",(function(e){var t=e.data[0];n.setEditModeButtons(t)}));a.EventEmitter.subscribe("BX.Crm.EntityEditor:onControllerChange",(function(e){var t=e.data[0];n.setEditModeButtons(t)}));a.EventEmitter.subscribe("BX.Crm.EntityEditor:onSwitchToViewMode",(function(e){var t=e.data[0];n.setViewModeButtons(t)}));a.EventEmitter.subscribe("BX.Crm.EntityEditor:onNothingChanged",(function(e){var t=e.data[0];n.setViewModeButtons(t)}));a.EventEmitter.subscribe("onEntityCreate",(function(e){var t;var n=e===null||e===void 0?void 0:(t=e.data[0])===null||t===void 0?void 0:t.sender;if(n){n._toolPanel.disableSaveButton();n.hideToolPanel()}}));a.EventEmitter.subscribe("beforeCrmEntityRedirect",(function(e){var t;var r=e===null||e===void 0?void 0:(t=e.data[0])===null||t===void 0?void 0:t.sender;if(r){r._toolPanel.disableSaveButton();r.hideToolPanel();if(n.showNotificationOnClose){var a=e.data[0].redirectUrl;if(!a){return}a=BX.Uri.removeParam(a,"closeOnSave");window.top.BX.UI.Notification.Center.notify({content:o.Loc.getMessage("CRM_STORE_DOCUMENT_SAVE_AND_CONDUCT_NOTIFICATION"),actions:[{title:o.Loc.getMessage("CRM_STORE_DOCUMENT_OPEN_DOCUMENT"),href:a,events:{click:function e(t,n,r){n.close()}}}]})}}}));if(i.isNew()){this.setEditModeButtons(i)}else{this.setViewModeButtons(i)}}},{key:"setViewModeButtons",value:function e(t){if(t._toolPanel&&t._toolPanel.hasOwnProperty("_cancelButton")){BX.hide(t._toolPanel._cancelButton)}if(t._toolPanel&&t._toolPanel.hasOwnProperty("_editButton")){BX.hide(t._toolPanel._editButton)}if(this.deductAndSaveButton){BX.hide(this.deductAndSaveButton)}if(this.deductButton){BX.show(this.deductButton)}}},{key:"setEditModeButtons",value:function e(t){if(t._toolPanel&&t._toolPanel.hasOwnProperty("_cancelButton")){BX.show(t._toolPanel._cancelButton)}if(t._toolPanel&&t._toolPanel.hasOwnProperty("_editButton")){BX.show(t._toolPanel._editButton)}if(this.deductAndSaveButton&&!this.isDocumentDeducted){BX.show(this.deductAndSaveButton)}if(this.deductButton&&!this.isDocumentDeducted){BX.hide(this.deductButton)}}},{key:"getEditorInstance",value:function e(){if(o.Reflection.getClass("BX.Crm.EntityEditor")){return BX.Crm.EntityEditor.getDefault()}return null}},{key:"addCopyLinkPopup",value:function e(){var t=this;var n=document.getElementById(this.settings.copyLinkButtonId);if(!n){return}n.onclick=function(){t.copyDocumentLinkToClipboard()}}},{key:"copyDocumentLinkToClipboard",value:function e(){var t=BX.util.remove_url_param(window.location.href,["IFRAME","IFRAME_TYPE"]);if(!BX.clipboard.copy(t)){return}var n=new BX.PopupWindow("catalog_copy_document_url_to_clipboard",document.getElementById(this.settings.copyLinkButtonId),{content:o.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_LINK_COPIED"),darkMode:true,autoHide:true,zIndex:1e3,angle:true,bindOptions:{position:"top"}});n.show();setTimeout((function(){n.close()}),1500)}},{key:"sendAnalyticsData",value:function e(t){BX.ajax.runComponentAction("bitrix:crm.store.document.detail","sendAnalytics",{mode:"class",analyticsLabel:t})}},{key:"enableOnboardingChain",value:function e(t){if(babelHelpers.classPrivateFieldGet(this,N)===null){babelHelpers.classPrivateFieldSet(this,N,new C({onboardingData:t,documentGuid:this.id,productListController:this.getProductListController()}));babelHelpers.classPrivateFieldGet(this,N).processOnboarding()}}},{key:"getProductListController",value:function e(){var t=this.getEditorInstance();var n=t.getControllers();var r=_(n),o;try{for(r.s();!(o=r.n()).done;){var a=o.value;if(a instanceof BX.Crm.EntityStoreDocumentProductListController){return a}}}catch(e){r.e(e)}finally{r.f()}return null}}],[{key:"getInstance",value:function e(){return O(t,t,j)}}]);return t}(n.BaseCard);function R(){a.EventEmitter.subscribe("BX.UI.EntityEditorProductRowSummary:onDetailProductListLinkClick",(function(){a.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"tab_products"})}));a.EventEmitter.subscribe("BX.UI.EntityEditorProductRowSummary:onAddNewRowInProductList",(function(){a.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"tab_products"});setTimeout((function(){a.EventEmitter.emit("onFocusToProductList")}),500)}))}var j={writable:true,value:void 0};babelHelpers.defineProperty(H,"saveAndDeductAction","saveAndDeduct");babelHelpers.defineProperty(H,"deductAction","deduct");babelHelpers.defineProperty(H,"cancelDeductAction","cancelDeduct");e.Document=H})(this.BX.Crm.Store.DocumentCard=this.BX.Crm.Store.DocumentCard||{},BX,BX.Catalog.EntityCard,BX.UI,BX,BX.Event);
//# sourceMappingURL=script.map.js