{"version":3,"file":"script.js","sources":["src/js/document.onboarding.manager.js","src/js/document.js"],"sourcesContent":["//@flow\nimport {userOptions, Loc, Event} from 'main.core';\nimport {EventEmitter} from 'main.core.events';\nimport 'spotlight';\n\n\nexport type OnboardingData = {\n\tchain: number;\n\tchainStep: number;\n};\n\ntype Params = {\n\tonboardingData: OnboardingData;\n\tdocumentGuid: string;\n\tproductListController?: BX.Crm.EntityStoreDocumentProductListController;\n};\n\nexport class DocumentOnboardingManager\n{\n\t#onboardingData: OnboardingData;\n\t#documentGuid: string;\n\t#productListController: BX.Crm.EntityStoreDocumentProductListController = null;\n\n\tconstructor(params: Params)\n\t{\n\t\tthis.#onboardingData = params.onboardingData;\n\t\tthis.#documentGuid = params.documentGuid;\n\t\tif (params.productListController)\n\t\t{\n\t\t\tthis.#productListController = params.productListController;\n\t\t}\n\t}\n\n\tprocessOnboarding(): void\n\t{\n\t\tconst chain = this.#onboardingData.chain;\n\t\tconst step = this.#onboardingData.chainStep;\n\n\t\tif (chain === 1 && step === 1)\n\t\t{\n\t\t\tconst rowId = this.#getFirstProductRow();\n\t\t\tif (rowId)\n\t\t\t{\n\t\t\t\tthis.#hintProductListField(rowId);\n\t\t\t}\n\t\t}\n\t}\n\n\t#hintProductListField(rowId: string = ''): void\n\t{\n\t\tconst buttonsContainer = document.querySelector(`#${this.#documentGuid}_TABS_MENU`);\n\t\tconst spotlight = new BX.SpotLight(\n\t\t\t{\n\t\t\t\tid: 'arrow_spotlight',\n\t\t\t\ttargetElement: document.querySelector('[data-tab-id=tab_products]'),\n\t\t\t\tautoSave: true,\n\t\t\t\ttargetVertex: \"middle-center\",\n\t\t\t\tzIndex: 200,\n\t\t\t}\n\t\t);\n\t\tspotlight.show();\n\t\tspotlight.container.style.pointerEvents = \"none\";\n\n\t\tconst productListTabListener = (event) => {\n\t\t\tspotlight.close();\n\t\t\tconst [productListEditor] = event.data;\n\n\t\t\tconst buttonsPanelListener = () => {\n\t\t\t\tconst activeHint = productListEditor.getActiveHint();\n\t\t\t\tif (activeHint !== null)\n\t\t\t\t{\n\t\t\t\t\tactiveHint.close();\n\t\t\t\t\tEvent.unbind(buttonsContainer, 'click', buttonsPanelListener);\n\t\t\t\t}\n\t\t\t}\n\t\t\tEvent.bind(buttonsContainer, 'click', buttonsPanelListener);\n\n\t\t\tconst tabChangeListener = (event) => {\n\t\t\t\tif (event?.data?.tabId === 'tab_products')\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tproductListEditor.getActiveHint()?.close();\n\t\t\t}\n\n\t\t\tproductListEditor.showFieldTourHint(\n\t\t\t\t'AMOUNT',\n\t\t\t\t{\n\t\t\t\t\ttitle: Loc.getMessage('CRM_STORE_DOCUMENT_WAREHOUSE_PRODUCT_AMOUNT_GUIDE_TITLE_2'),\n\t\t\t\t\ttext: Loc.getMessage('CRM_STORE_DOCUMENT_WAREHOUSE_PRODUCT_AMOUNT_GUIDE_TEXT'),\n\t\t\t\t},\n\t\t\t\t() => {\n\t\t\t\t\tuserOptions.save('crm', 'warehouse-onboarding', 'secondChainStage', 2);\n\t\t\t\t\tuserOptions.save('crm', 'warehouse-onboarding', 'chainStage', 2);\n\n\t\t\t\t\tEvent.unbind(buttonsContainer, 'click', buttonsPanelListener);\n\n\t\t\t\t\tEventEmitter.unsubscribe(\n\t\t\t\t\t\t'onDemandRecalculateWrapper',\n\t\t\t\t\t\tproductListTabListener\n\t\t\t\t\t);\n\n\t\t\t\t\tEventEmitter.unsubscribe(\n\t\t\t\t\t\t'BX.Catalog.EntityCard.TabManager:onOpenTab',\n\t\t\t\t\t\ttabChangeListener\n\t\t\t\t\t);\n\t\t\t\t},\n\t\t\t\t[],\n\t\t\t\trowId\n\t\t\t);\n\n\t\t\tEventEmitter.subscribe('BX.Catalog.EntityCard.TabManager:onOpenTab', tabChangeListener);\n\t\t};\n\n\t\tEventEmitter.subscribe(\n\t\t\t'onDemandRecalculateWrapper',\n\t\t\tproductListTabListener\n\t\t);\n\t}\n\n\t#getFirstProductRow(): string\n\t{\n\t\tconst productList = this.#getProductList();\n\t\tfor (const product of productList)\n\t\t{\n\t\t\tif (!product.getModel().isService())\n\t\t\t{\n\t\t\t\treturn product.getId();\n\t\t\t}\n\t\t}\n\n\t\treturn '';\n\t}\n\n\t#getProductList(): Array\n\t{\n\t\tif (this.#productListController && this.#productListController.productList)\n\t\t{\n\t\t\tif (this.#productListController.productList.products instanceof Array)\n\t\t\t{\n\t\t\t\treturn this.#productListController.productList.products;\n\t\t\t}\n\t\t}\n\n\t\treturn [];\n\t}\n}","import {Loc, Reflection, Tag} from \"main.core\";\nimport {BaseCard} from \"catalog.entity-card\";\nimport {EventEmitter} from \"main.core.events\";\nimport {Button, ButtonColor, ButtonState} from \"ui.buttons\";\nimport {DocumentOnboardingManager, OnboardingData} from \"./document.onboarding.manager\";\n\nexport class Document extends BaseCard\n{\n\tstatic #instance;\n\n\tstatic saveAndDeductAction = 'saveAndDeduct';\n\tstatic deductAction = 'deduct';\n\tstatic cancelDeductAction = 'cancelDeduct';\n\n\t#documentOnboardingManager: DocumentOnboardingManager|null = null;\n\n\tconstructor(id, settings)\n\t{\n\t\tsuper(id, settings);\n\t\tthis.isDocumentDeducted = settings.documentStatus === 'Y';\n\t\tthis.isDeductLocked = settings.isDeductLocked;\n\t\tthis.masterSliderUrl = settings.masterSliderUrl;\n\t\tthis.inventoryManagementSource = settings.inventoryManagementSource;\n\t\tthis.permissions = settings.permissions;\n\n\t\tthis.addCopyLinkPopup();\n\n\t\tEventEmitter.subscribe('BX.Crm.EntityEditor:onFailedValidation', (event) => {\n\t\t\tEventEmitter.emit('BX.Catalog.EntityCard.TabManager:onOpenTab', {tabId: 'main'});\n\t\t});\n\t\tEventEmitter.subscribe('onProductsCheckFailed', (event) => {\n\t\t\tEventEmitter.emit('BX.Catalog.EntityCard.TabManager:onOpenTab', {tabId: 'tab_products'});\n\t\t});\n\n\t\tEventEmitter.subscribe('BX.Crm.EntityEditor:onSave', (event) => {\n\t\t\tconst eventEditor = event.data[0];\n\t\t\tif (eventEditor && eventEditor._ajaxForm)\n\t\t\t{\n\t\t\t\tlet action = eventEditor._ajaxForm?._actionName === 'SAVE' ? 'save' : eventEditor._ajaxForm?._config.data.ACTION;\n\t\t\t\tif (action === Document.saveAndDeductAction)\n\t\t\t\t{\n\t\t\t\t\tconst controllersErrorCollection = this.getControllersIssues(eventEditor.getControllers());\n\t\t\t\t\tif (controllersErrorCollection.length > 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tevent.data[1].cancel = true;\n\t\t\t\t\t\teventEditor._toolPanel?.setLocked(false);\n\t\t\t\t\t\teventEditor._toolPanel?.addError(controllersErrorCollection[0]);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (action === 'SAVE')\n\t\t\t\t{\n\t\t\t\t\t// for consistency in analytics tags\n\t\t\t\t\taction = 'save';\n\t\t\t\t}\n\n\t\t\t\tlet urlParams = {\n\t\t\t\t\tisNewDocument: this.entityId <= 0 ? 'Y' : 'N',\n\t\t\t\t\tinventoryManagementSource: this.inventoryManagementSource,\n\t\t\t\t};\n\n\t\t\t\tif (action)\n\t\t\t\t{\n\t\t\t\t\turlParams.action = action;\n\t\t\t\t}\n\n\t\t\t\teventEditor._ajaxForm.addUrlParams(urlParams);\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('BX.Catalog.EntityCard.TabManager:onSelectItem', (event) => {\n\t\t\tconst tabId = event.data.tabId;\n\t\t\tif (tabId === 'tab_products' && !this.isTabAnalyticsSent)\n\t\t\t{\n\t\t\t\tthis.sendAnalyticsData({\n\t\t\t\t\ttab: 'products',\n\t\t\t\t\tisNewDocument: this.entityId <= 0 ? 'Y' : 'N',\n\t\t\t\t\tdocumentType: 'W',\n\t\t\t\t\tinventoryManagementSource: this.inventoryManagementSource,\n\t\t\t\t});\n\t\t\t\tthis.isTabAnalyticsSent = true;\n\t\t\t}\n\t\t});\n\n\t\tthis.#subscribeToProductRowSummaryEvents();\n\n\t\tDocument.#instance = this;\n\n\t\tBX.UI.SidePanel.Wrapper.setParam(\"closeAfterSave\", true);\n\t\tthis.showNotificationOnClose = false;\n\t}\n\n\t#subscribeToProductRowSummaryEvents()\n\t{\n\t\tEventEmitter.subscribe('BX.UI.EntityEditorProductRowSummary:onDetailProductListLinkClick', () => {\n\t\t\tEventEmitter.emit('BX.Catalog.EntityCard.TabManager:onOpenTab', {tabId: 'tab_products'});\n\t\t});\n\n\t\tEventEmitter.subscribe('BX.UI.EntityEditorProductRowSummary:onAddNewRowInProductList', () => {\n\t\t\tEventEmitter.emit('BX.Catalog.EntityCard.TabManager:onOpenTab', {tabId: 'tab_products'});\n\t\t\tsetTimeout(() => {\n\t\t\t\tEventEmitter.emit('onFocusToProductList');\n\t\t\t}, 500);\n\t\t});\n\t}\n\n\tfocusOnTab(tabId)\n\t{\n\t\tEventEmitter.emit('BX.Catalog.EntityCard.TabManager:onOpenTab', {tabId: tabId});\n\t}\n\n\tgetControllersIssues(controllers)\n\t{\n\t\tlet validateErrorCollection = [];\n\t\tif (controllers instanceof Array)\n\t\t{\n\t\t\tcontrollers.forEach((controller) => {\n\t\t\t\tif (controller instanceof BX.Crm.EntityStoreDocumentProductListController)\n\t\t\t\t{\n\t\t\t\t\tvalidateErrorCollection.push(...controller.getErrorCollection());\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn validateErrorCollection;\n\t}\n\n\tstatic getInstance()\n\t{\n\t\treturn Document.#instance;\n\t}\n\n\topenMasterSlider()\n\t{\n\t\tlet card = this;\n\n\t\tBX.SidePanel.Instance.open(\n\t\t\tthis.masterSliderUrl,\n\t\t\t{\n\t\t\t\tcacheable: false,\n\t\t\t\tdata: {\n\t\t\t\t\topenGridOnDone: false,\n\t\t\t\t},\n\t\t\t\tevents: {\n\t\t\t\t\tonCloseComplete: function(event) {\n\t\t\t\t\t\tlet slider = event.getSlider();\n\t\t\t\t\t\tif (!slider)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (slider.getData().get('isInventoryManagementEnabled'))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcard.isDeductLocked = false;\n\n\t\t\t\t\t\t\tlet sliders = BX.SidePanel.Instance.getOpenSliders();\n\t\t\t\t\t\t\tsliders.forEach((slider) => {\n\t\t\t\t\t\t\t\tif (slider.getWindow()?.BX.Catalog?.DocumentGridManager)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tslider.allowChangeHistory = false;\n\t\t\t\t\t\t\t\t\tslider.getWindow().location.reload();\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\t}\n\n\t/**\n\t * adds the \"deduct\" and \"save and deduct\" buttons to the tool panel\n\t * using entity-editor's api to preserve the logic\n\t */\n\tadjustToolPanel()\n\t{\n\t\tconst editor = this.getEditorInstance();\n\t\tif (!editor)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst savePanel = editor._toolPanel;\n\t\tconst saveButton = editor._toolPanel._editButton;\n\n\t\tthis.defaultSaveActionName = editor._ajaxForm._config.data.ACTION;\n\t\tthis.defaultOnSuccessCallback = editor._ajaxForm._config.onsuccess;\n\n\t\tsaveButton.onclick = (event) => {\n\t\t\tthis.showNotificationOnClose = false;\n\t\t\teditor._ajaxForm._config.data.ACTION = this.defaultSaveActionName;\n\t\t\teditor._ajaxForm._config.onsuccess = this.defaultOnSuccessCallback;\n\t\t\tsavePanel.onSaveButtonClick(event);\n\t\t};\n\n\t\tif (this.permissions.conduct && !this.isDocumentDeducted)\n\t\t{\n\t\t\tconst deductAndSaveButton = Tag.render`<button class=\"ui-btn ui-btn-light-border\">${Loc.getMessage('CRM_STORE_DOCUMENT_DETAIL_SAVE_AND_DEDUCT_BUTTON')}</button>`;\n\t\t\tdeductAndSaveButton.onclick = (event) => {\n\t\t\t\tif (this.isDeductLocked)\n\t\t\t\t{\n\t\t\t\t\tthis.openMasterSlider();\n\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\teditor._ajaxForm._config.data.ACTION = Document.saveAndDeductAction;\n\t\t\t\teditor._ajaxForm._config.onsuccess = (result) => {\n\t\t\t\t\tthis.showNotificationOnClose = true;\n\t\t\t\t\tconst error = BX.prop.getString(result, 'ERROR', '');\n\t\t\t\t\tif (!error)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.setViewModeButtons(editor);\n\t\t\t\t\t}\n\n\t\t\t\t\teditor.onSaveSuccess(result);\n\t\t\t\t};\n\n\t\t\t\tsavePanel.onSaveButtonClick(event);\n\t\t\t};\n\t\t\tsaveButton.after(deductAndSaveButton);\n\t\t\tthis.deductAndSaveButton = deductAndSaveButton;\n\n\t\t\tconst deductButton = new Button({\n\t\t\t\ttext: Loc.getMessage('CRM_STORE_DOCUMENT_DETAIL_DEDUCT_BUTTON'),\n\t\t\t\tcolor: ButtonColor.LIGHT_BORDER,\n\t\t\t\tonclick: (button, event) => {\n\t\t\t\t\tif (savePanel.isLocked())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tif (this.isDeductLocked)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.openMasterSlider();\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tbutton.setState(ButtonState.CLOCKING);\n\t\t\t\t\tsavePanel.setLocked(true);\n\n\t\t\t\t\tconst actionName = Document.deductAction;\n\t\t\t\t\tconst controllers = editor.getControllers();\n\t\t\t\t\tconst errorCollection = [];\n\t\t\t\t\tcontrollers.forEach((controller) => {\n\t\t\t\t\t\tif (controller instanceof BX.Crm.EntityStoreDocumentProductListController)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (!controller.validateProductList())\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\terrorCollection.push(...controller.getErrorCollection());\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\n\t\t\t\t\tif (errorCollection.length > 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tsavePanel.clearErrors();\n\t\t\t\t\t\tsavePanel.addError(errorCollection[0]);\n\t\t\t\t\t\tsavePanel.setLocked(false);\n\t\t\t\t\t\tbutton.setActive(true);\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tlet formData = {};\n\t\t\t\t\tif (window.EntityEditorDocumentOrderShipmentController)\n\t\t\t\t\t{\n\t\t\t\t\t\tformData = window.EntityEditorDocumentOrderShipmentController.demandFormData();\n\t\t\t\t\t}\n\n\t\t\t\t\tconst deductDocumentAjaxForm = editor.createAjaxForm(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tactionName: actionName,\n\t\t\t\t\t\t\tenableRequiredUserFieldCheck: false,\n\t\t\t\t\t\t\tformData: formData,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tonSuccess: (result) => {\n\t\t\t\t\t\t\t\tif (!this.isDocumentDeducted)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.showNotificationOnClose = true;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tbutton.setState(ButtonState.ACTIVE);\n\t\t\t\t\t\t\t\teditor.onSaveSuccess(result);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonFailure: (result) => {\n\t\t\t\t\t\t\t\tbutton.setState(ButtonState.ACTIVE);\n\t\t\t\t\t\t\t\teditor.onSaveFailure(result);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\n\t\t\t\t\tdeductDocumentAjaxForm.addUrlParams({\n\t\t\t\t\t\taction: actionName,\n\t\t\t\t\t\tdocumentType: 'W',\n\t\t\t\t\t});\n\n\t\t\t\t\tdeductDocumentAjaxForm.submit();\n\t\t\t\t},\n\t\t\t}).render();\n\t\t\tsaveButton.after(deductButton);\n\t\t\tthis.deductButton = deductButton;\n\t\t}\n\t\telse if (this.permissions.cancel)\n\t\t{\n\t\t\tconst deductButton = new Button({\n\t\t\t\ttext:  Loc.getMessage('CRM_STORE_DOCUMENT_DETAIL_CANCEL_DEDUCT_BUTTON'),\n\t\t\t\tcolor: ButtonColor.LIGHT_BORDER,\n\t\t\t\tonclick: (button, event) => {\n\t\t\t\t\tif (savePanel.isLocked())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tif (this.isDeductLocked)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.openMasterSlider();\n\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tbutton.setState(ButtonState.CLOCKING);\n\t\t\t\t\tsavePanel.setLocked(true);\n\n\t\t\t\t\tconst actionName = Document.cancelDeductAction;\n\t\t\t\t\tlet formData = {};\n\t\t\t\t\tif (window.EntityEditorDocumentOrderShipmentController)\n\t\t\t\t\t{\n\t\t\t\t\t\tformData = window.EntityEditorDocumentOrderShipmentController.demandFormData();\n\t\t\t\t\t}\n\n\t\t\t\t\tconst deductDocumentAjaxForm = editor.createAjaxForm(\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tactionName: actionName,\n\t\t\t\t\t\t\tenableRequiredUserFieldCheck: false,\n\t\t\t\t\t\t\tformData: formData,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tonSuccess: (result) => {\n\t\t\t\t\t\t\t\tif (!this.isDocumentDeducted)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.showNotificationOnClose = true;\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tbutton.setState(ButtonState.ACTIVE);\n\t\t\t\t\t\t\t\teditor.onSaveSuccess(result);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonFailure: (result) => {\n\t\t\t\t\t\t\t\tbutton.setState(ButtonState.ACTIVE);\n\t\t\t\t\t\t\t\teditor.onSaveFailure(result);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}\n\t\t\t\t\t);\n\n\t\t\t\t\tdeductDocumentAjaxForm.addUrlParams({\n\t\t\t\t\t\taction: actionName,\n\t\t\t\t\t\tdocumentType: 'W',\n\t\t\t\t\tinventoryManagementSource: this.inventoryManagementSource,\n\t\t\t\t\t});\n\n\t\t\t\t\tdeductDocumentAjaxForm.submit();\n\t\t\t\t},\n\t\t\t}).render();\n\t\t\tsaveButton.after(deductButton);\n\t\t\tthis.deductButton = deductButton;\n\t\t}\n\n\t\tEventEmitter.subscribe('BX.Crm.EntityEditor:onControlModeChange', (event) => {\n\t\t\tconst eventEditor = event.data[0];\n\t\t\tconst control = event.data[1].control;\n\t\t\tif(control.getMode() === BX.Crm.EntityEditorMode.edit)\n\t\t\t{\n\t\t\t\tthis.setEditModeButtons(eventEditor);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.setViewModeButtons(eventEditor);\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('BX.Crm.EntityEditor:onControlChange', (event) => {\n\t\t\tconst eventEditor = event.data[0];\n\t\t\tthis.setEditModeButtons(eventEditor);\n\t\t});\n\n\t\tEventEmitter.subscribe('BX.Crm.EntityEditor:onControllerChange', (event) => {\n\t\t\tconst eventEditor = event.data[0];\n\t\t\tthis.setEditModeButtons(eventEditor);\n\t\t});\n\n\t\tEventEmitter.subscribe('BX.Crm.EntityEditor:onSwitchToViewMode', (event) => {\n\t\t\tconst eventEditor = event.data[0];\n\t\t\tthis.setViewModeButtons(eventEditor);\n\t\t});\n\n\t\tEventEmitter.subscribe('BX.Crm.EntityEditor:onNothingChanged', (event) => {\n\t\t\tconst eventEditor = event.data[0];\n\t\t\tthis.setViewModeButtons(eventEditor);\n\t\t});\n\n\t\tEventEmitter.subscribe('onEntityCreate', (event) => {\n\t\t\tconst editor = event?.data[0]?.sender;\n\t\t\tif (editor)\n\t\t\t{\n\t\t\t\teditor._toolPanel.disableSaveButton();\n\t\t\t\teditor.hideToolPanel();\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('beforeCrmEntityRedirect', (event) => {\n\t\t\tconst editor = event?.data[0]?.sender;\n\t\t\tif (editor)\n\t\t\t{\n\t\t\t\teditor._toolPanel.disableSaveButton();\n\t\t\t\teditor.hideToolPanel();\n\n\t\t\t\tif (this.showNotificationOnClose)\n\t\t\t\t{\n\t\t\t\t\tlet url = event.data[0].redirectUrl;\n\t\t\t\t\tif (!url)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\turl = BX.Uri.removeParam(url, 'closeOnSave');\n\n\t\t\t\t\twindow.top.BX.UI.Notification.Center.notify({\n\t\t\t\t\t\tcontent: Loc.getMessage('CRM_STORE_DOCUMENT_SAVE_AND_CONDUCT_NOTIFICATION'),\n\t\t\t\t\t\tactions: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttitle: Loc.getMessage('CRM_STORE_DOCUMENT_OPEN_DOCUMENT'),\n\t\t\t\t\t\t\t\thref: url,\n\t\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\t\tclick: function(event, balloon, action) {\n\t\t\t\t\t\t\t\t\t\tballoon.close();\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (editor.isNew())\n\t\t{\n\t\t\tthis.setEditModeButtons(editor);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.setViewModeButtons(editor);\n\t\t}\n\t}\n\n\tsetViewModeButtons(editor)\n\t{\n\t\tif (editor._toolPanel && editor._toolPanel.hasOwnProperty('_cancelButton'))\n\t\t{\n\t\t\tBX.hide(editor._toolPanel._cancelButton);\n\t\t}\n\n\t\tif (editor._toolPanel && editor._toolPanel.hasOwnProperty('_editButton'))\n\t\t{\n\t\t\tBX.hide(editor._toolPanel._editButton);\n\t\t}\n\n\t\tif (this.deductAndSaveButton)\n\t\t{\n\t\t\tBX.hide(this.deductAndSaveButton);\n\t\t}\n\t\tif (this.deductButton)\n\t\t{\n\t\t\tBX.show(this.deductButton);\n\t\t}\n\t}\n\n\tsetEditModeButtons(editor)\n\t{\n\t\tif (editor._toolPanel && editor._toolPanel.hasOwnProperty('_cancelButton'))\n\t\t{\n\t\t\tBX.show(editor._toolPanel._cancelButton);\n\t\t}\n\n\t\tif (editor._toolPanel && editor._toolPanel.hasOwnProperty('_editButton'))\n\t\t{\n\t\t\tBX.show(editor._toolPanel._editButton);\n\t\t}\n\n\t\tif (this.deductAndSaveButton && !this.isDocumentDeducted)\n\t\t{\n\t\t\tBX.show(this.deductAndSaveButton);\n\t\t}\n\t\tif (this.deductButton && !this.isDocumentDeducted)\n\t\t{\n\t\t\tBX.hide(this.deductButton);\n\t\t}\n\t}\n\n\tgetEditorInstance()\n\t{\n\t\tif (Reflection.getClass('BX.Crm.EntityEditor'))\n\t\t{\n\t\t\treturn BX.Crm.EntityEditor.getDefault();\n\t\t}\n\n\t\treturn null;\n\t}\n\n\taddCopyLinkPopup()\n\t{\n\t\tlet copyLinkButton = document.getElementById(this.settings.copyLinkButtonId);\n\t\tif (!copyLinkButton)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tcopyLinkButton.onclick = () => {\n\t\t\tthis.copyDocumentLinkToClipboard();\n\t\t}\n\t}\n\n\tcopyDocumentLinkToClipboard()\n\t{\n\t\tlet url = BX.util.remove_url_param(window.location.href, [\"IFRAME\", \"IFRAME_TYPE\"]);\n\t\tif(!BX.clipboard.copy(url))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tvar popup = new BX.PopupWindow(\n\t\t\t'catalog_copy_document_url_to_clipboard',\n\t\t\tdocument.getElementById(this.settings.copyLinkButtonId),\n\t\t\t{\n\t\t\t\tcontent: Loc.getMessage('CRM_STORE_DOCUMENT_DETAIL_LINK_COPIED'),\n\t\t\t\tdarkMode: true,\n\t\t\t\tautoHide: true,\n\t\t\t\tzIndex: 1000,\n\t\t\t\tangle: true,\n\t\t\t\tbindOptions: { position: \"top\" }\n\t\t\t}\n\t\t);\n\t\tpopup.show();\n\n\t\tsetTimeout(function(){ popup.close(); }, 1500);\n\t}\n\n\tsendAnalyticsData(data)\n\t{\n\t\tBX.ajax.runComponentAction(\n\t\t\t'bitrix:crm.store.document.detail',\n\t\t\t'sendAnalytics',\n\t\t\t{\n\t\t\t\tmode: 'class',\n\t\t\t\tanalyticsLabel: data,\n\t\t\t}\n\t\t);\n\t}\n\n\tenableOnboardingChain(onboardingData: OnboardingData)\n\t{\n\t\tif (this.#documentOnboardingManager === null)\n\t\t{\n\t\t\tthis.#documentOnboardingManager  = new DocumentOnboardingManager({\n\t\t\t\tonboardingData: onboardingData,\n\t\t\t\tdocumentGuid: this.id,\n\t\t\t\tproductListController: this.getProductListController(),\n\t\t\t});\n\t\t\tthis.#documentOnboardingManager.processOnboarding();\n\t\t}\n\t}\n\n\tgetProductListController(): BX.Crm.EntityStoreDocumentProductListController|null\n\t{\n\t\tconst editor = this.getEditorInstance();\n\t\tconst controllers = editor.getControllers();\n\t\tfor (const controller of controllers)\n\t\t{\n\t\t\tif (controller instanceof BX.Crm.EntityStoreDocumentProductListController)\n\t\t\t{\n\t\t\t\treturn controller;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n}\n"],"names":["DocumentOnboardingManager","params","onboardingData","documentGuid","productListController","chain","step","chainStep","rowId","buttonsContainer","document","querySelector","spotlight","BX","SpotLight","id","targetElement","autoSave","targetVertex","zIndex","show","container","style","pointerEvents","productListTabListener","event","close","data","productListEditor","buttonsPanelListener","activeHint","getActiveHint","Event","unbind","bind","tabChangeListener","tabId","showFieldTourHint","title","Loc","getMessage","text","userOptions","save","EventEmitter","unsubscribe","subscribe","productList","product","getModel","isService","getId","products","Array","Document","settings","_classPrivateMethodInitSpec","_classPrivateFieldInitSpec","isDocumentDeducted","documentStatus","isDeductLocked","masterSliderUrl","inventoryManagementSource","permissions","addCopyLinkPopup","emit","eventEditor","_ajaxForm","action","_actionName","_config","ACTION","saveAndDeductAction","controllersErrorCollection","getControllersIssues","getControllers","length","cancel","_toolPanel","setLocked","addError","urlParams","isNewDocument","entityId","addUrlParams","isTabAnalyticsSent","sendAnalyticsData","tab","documentType","_classPrivateMethodGet","UI","SidePanel","Wrapper","setParam","showNotificationOnClose","controllers","validateErrorCollection","forEach","controller","Crm","EntityStoreDocumentProductListController","push","getErrorCollection","card","Instance","open","cacheable","openGridOnDone","events","onCloseComplete","slider","getSlider","getData","get","sliders","getOpenSliders","getWindow","Catalog","DocumentGridManager","allowChangeHistory","location","reload","editor","getEditorInstance","savePanel","saveButton","_editButton","defaultSaveActionName","defaultOnSuccessCallback","onsuccess","onclick","onSaveButtonClick","conduct","deductAndSaveButton","Tag","render","openMasterSlider","result","error","prop","getString","setViewModeButtons","onSaveSuccess","after","deductButton","Button","color","ButtonColor","LIGHT_BORDER","button","isLocked","setState","ButtonState","CLOCKING","actionName","deductAction","errorCollection","validateProductList","clearErrors","setActive","formData","window","EntityEditorDocumentOrderShipmentController","demandFormData","deductDocumentAjaxForm","createAjaxForm","enableRequiredUserFieldCheck","onSuccess","ACTIVE","onFailure","onSaveFailure","submit","cancelDeductAction","control","getMode","EntityEditorMode","edit","setEditModeButtons","sender","disableSaveButton","hideToolPanel","url","redirectUrl","Uri","removeParam","top","Notification","Center","notify","content","actions","href","click","balloon","isNew","hasOwnProperty","hide","_cancelButton","Reflection","getClass","EntityEditor","getDefault","copyLinkButton","getElementById","copyLinkButtonId","copyDocumentLinkToClipboard","util","remove_url_param","clipboard","copy","popup","PopupWindow","darkMode","autoHide","angle","bindOptions","position","setTimeout","ajax","runComponentAction","mode","analyticsLabel","getProductListController","processOnboarding","BaseCard"],"mappings":"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"}