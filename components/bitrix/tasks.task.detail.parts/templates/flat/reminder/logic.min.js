BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TaskDetailPartsReminder!="undefined"){return}BX.Tasks.Component.TaskDetailPartsReminder=BX.Tasks.Util.ItemSet.extend({sys:{code:"reminder"},constants:{UNIT_DAY:"D",UNIT_HOUR:"H"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.ItemSet);this.vars.editItemValue=0;this.instances.windows={};this.instances.form=new e({scope:this.control("form"),id:this.id()+"-form",parent:this});this.setTaskId(this.option("taskId"));this.setTaskDeadLine(this.option("taskDeadline"));this.instances.form.bindEvent("save",BX.delegate(this.onItemApply,this));this.bindEvent("setTaskDeadLine",BX.delegate(this.setTaskDeadLine,this));BX.addCustomEvent(window,"tasksTaskEventChangeDeadline",BX.delegate(this.onTaskDeadLineChange,this));BX.addCustomEvent(window,"tasksTaskEventAddReminder",BX.delegate(this.openAddForm,this))},extractItemValue:function(){return this.vars.idOffset++},extractItemDisplay:function(){return"1"},openUpdateForm:function(t){var e=this.vars.items[t];this.vars.editItemValue=t;this.instances.form.open(e.scope(),e.vars.data)},createItem:function(e){e=t.prepareData(e);var i=this.getNodeByTemplate("item",e)[0];BX.append(i,this.control("items"));var s=new t({scope:i,data:e,auxData:this.option("auxData"),parent:this});return s},setTaskId:function(t){this.vars.taskId=t?t:0},setTaskDeadLine:function(t){var e=0;if(BX.type.isNotEmptyString(t)){e=this.dateStringToStamp(t)}this.instances.form.setDeadLineStamp(e)},openAddForm:function(t){this.vars.editItemValue=0;this.instances.form.open(t)},onTaskDeadLineChange:function(t,e){if(t==this.vars.taskId){this.setTaskDeadLine(e)}},onItemApply:function(t){if(this.vars.editItemValue!=0){this.vars.items[this.vars.editItemValue].update(t);this.syncAllIfCan()}else{this.addItem(t)}},fireChangeEvent:function(t){this.callMethod(BX.Tasks.Util.ItemSet,"fireChangeEvent",arguments);if(!t.load){this.syncAllIfCan()}},getDateDiff:function(t,e){if(!BX.type.isNumber(t)){t=this.dateStringToStamp(t)}if(!BX.type.isNumber(e)){e=this.dateStringToStamp(e)}var i=e-t;var s=this.UNIT_HOUR;if(i%86400==0){s=this.UNIT_DAY;i=Math.floor(i/86400)}else{i=Math.floor(i/3600)}return{diff:i,unit:s}},dateStampToString:function(t,e){var i=new Date(t*1e3);return BX.date.format(e,i,false,true)},dateStringToStamp:function(t){var e=BX.parseDate(t,true);if(e!=null){return Math.floor(parseInt(e.getTime())/1e3)}return 0},syncAll:function(){var t=this.getQuery();if(t&&parseInt(this.option("taskId"))){var e=[];for(var i in this.vars.items){e.push(this.vars.items[i].data())}t.add("task.update",{id:parseInt(this.option("taskId")),data:{SE_REMINDER:e}},{code:"update_reminder"})}}}});var t=BX.Tasks.Util.ItemSet.Item.extend({sys:{code:"item"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.ItemSet.Item);this.vars.data=this.option("data");this.vars.randomTag=Math.round(Math.random()*1e5);this.bindEvents()},bindEvents:function(){this.bindDelegateControl("edit","click",BX.delegate(this.onEditClick,this))},data:function(){return{TRANSPORT:this.vars.data.TRANSPORT,TYPE:this.vars.data.TYPE,REMIND_DATE:this.vars.data.REMIND_DATE,RECEPIENT_TYPE:this.vars.data.RECEPIENT_TYPE}},value:function(){return this.vars.data.VALUE},display:function(){return this.vars.data.DISPLAY},update:function(e){e=t.prepareData(e);this.control("transport").value=e.TRANSPORT;this.control("type").value=e.TYPE;this.control("remind-date").value=e.REMIND_DATE;this.control("recipient-type").value=e.RECEPIENT_TYPE;this.control("edit").innerHTML=e.REMINDER_TEXT;BX[e.TRANSPORT=="J"?"addClass":"removeClass"](this.control("info"),"transport-j");this.vars.data=BX.mergeEx(this.vars.data,e)},"delete":function(){var t=this.value();BX.remove(this.sys.scope);this.sys.scope=null;this.ctrls=null;this.vars.data=null;return t},onEditClick:function(t){this.parent().openUpdateForm(this.value());BX.PreventDefault(t)},onDeleteClick:function(t){this.parent().deleteItem(this.value());BX.PreventDefault(t)}}});t.prepareData=function(t){var e="";if(t.RECEPIENT_TYPE=="R"||t.RECEPIENT_TYPE=="O"||t.RECEPIENT_TYPE=="S"){e=BX.message("TASKS_TTDP_TEMPLATE_REMINDER_RECEPIENT_TYPE_"+t.RECEPIENT_TYPE)}t.REMINDER_TEXT=t.REMIND_DATE+" "+e;t.TRANSPORT_CLASS=t.TRANSPORT=="J"?"transport-j":"";return t};var e=BX.Tasks.Util.Widget.extend({sys:{code:"form"},constants:{REMINDER_TYPE_DEADLINE:"D",REMINDER_TYPE_COMMON:"A"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);this.vars.data={TYPE:"A",RECEPIENT_TYPE:"R",REMIND_DATE:"",TRANSPORT:"J"};this.vars.deadLine=0;this.vars.formatValue=BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME"))},load:function(t){if(!BX.type.isNotEmptyString(t.REMIND_DATE)){return}this.setType(t.TYPE);this.setRecipientType(t.RECEPIENT_TYPE);this.setTransportType(t.TRANSPORT);if(t.TYPE==this.REMINDER_TYPE_DEADLINE){var e=this.parent().getDateDiff(t.REMIND_DATE,this.vars.deadLine);this.setUnit(e.unit);this.setMultiplier(e.diff)}else{this.setDate(t.REMIND_DATE,true)}},reset:function(){this.setType("A");this.setRecipientType("R");this.setDate("",true);this.setTransportType("J");this.setMultiplier(1);this.setUnit(this.parent().UNIT_DAY)},open:function(t,e){var i=this.getWindow(t);if(typeof e!="undefined"){this.load(e)}else{this.reset()}this.changeCSSFlag("mode-update",typeof e!="undefined");i.show()},close:function(){this.getWindow().close();this.reset()},getWindow:function(t){if(typeof this.instances.window=="undefined"){this.instances.window=new BX.PopupWindow(this.id(),t,{autoHide:true,closeByEsc:true,content:this.scope(),overlay:false,lightShadow:true,closeIcon:true,draggable:false,titleBar:false,angle:{position:"top"},offsetTop:12,offsetLeft:45,events:{onPopupClose:BX.delegate(this.onFormClose,this)}});this.bindControl("change-type","click",this.passCtx(this.onChangeType));this.bindControl("change-recipient","change",this.passCtx(this.onChangeRecipientType));this.bindDelegateControl("change-transport","click",this.passCtx(this.onChangeTransportType));this.bindControl("submit","click",BX.delegate(this.onSubmit,this))}if(typeof this.instances.datepicker=="undefined"){var e=this.control("date");if(BX.type.isElementNode(e)){var i=new BX.Tasks.Util.DatePicker({scope:e,defaultTime:this.optionP("auxData").COMPANY_WORKTIME.HOURS.START});i.bindEvent("change",BX.delegate(this.onChangeRemindDate,this));i.bindEvent("open",BX.delegate(this.closeTypeSubWindow,this));this.instances.datepicker=i}}if(BX.type.isElementNode(t)){this.instances.window.setBindElement(t)}return this.instances.window},setDeadLineStamp:function(t){this.vars.deadLine=t;this.toggleDeadLineMode()},onChangeRemindDate:function(t,e){this.setDate(e,false)},setMultiplier:function(t){this.control("time-multiplier").value=t},setUnit:function(t){this.control("time-unit").value=t},setDate:function(t,e){if(typeof t=="undefined"){return}this.vars.data.REMIND_DATE=t;if(e){this.instances.datepicker.setValue(t)}},setType:function(t){if(!t){return}this.vars.data.TYPE=t;this.setCSSMode("type",t.toLowerCase())},setRecipientType:function(t){if(!t){return}this.vars.data.RECEPIENT_TYPE=t;this.control("change-recipient").value=t},setTransportType:function(t){if(!t){return}this.vars.data.TRANSPORT=t;this.setCSSMode("transport",t.toLowerCase())},toggleDeadLineMode:function(){var t=this.vars.deadLine<=0;if(t){if(this.vars.data.TYPE==this.REMINDER_TYPE_DEADLINE){this.setType(this.REMINDER_TYPE_COMMON);this.setDate(0,"")}}this.changeCSSFlag("no-deadline",t)},getDeadLineOffset:function(){var t=parseInt(this.control("time-multiplier").value);if(isNaN(t)){t=0}var e=this.control("time-unit").value=="D"?86400:3600;return this.parent().dateStampToString(this.vars.deadLine-t*e,this.vars.formatValue)},onSubmit:function(){if(this.vars.data.TYPE==this.REMINDER_TYPE_DEADLINE){this.vars.data.REMIND_DATE=this.getDeadLineOffset()}if(this.vars.data.REMIND_DATE.length==""){return}this.fireEvent("save",[BX.clone(this.vars.data)]);this.close()},onFormClose:function(){this.closeTypeSubWindow();this.closeCalendarSubWindow()},closeTypeSubWindow:function(){if(typeof this.instances.typeWindow!="undefined"&&this.instances.typeWindow!=null){this.instances.typeWindow.popupWindow.close()}},closeCalendarSubWindow:function(){if(typeof this.instances.datepicker!="undefined"&&this.instances.datepicker!=null){this.instances.datepicker.closeCalendar()}},onChangeTransportType:function(t){var e=BX.data(t,"transport");if(typeof e!="undefined"&&e!=null){this.setTransportType(e)}},onChangeRecipientType:function(t){this.setRecipientType(t.value)},onChangeType:function(t){var e=this;var i=[{text:BX.message("TASKS_TTDP_TEMPLATE_REMINDER_TYPE_A"),title:BX.message("TASKS_TTDP_TEMPLATE_REMINDER_TYPE_A_EX"),className:"menu-popup-no-icon",onclick:function(){e.setType("A");this.popupWindow.close()}},{text:BX.message("TASKS_TTDP_TEMPLATE_REMINDER_TYPE_D"),title:BX.message("TASKS_TTDP_TEMPLATE_REMINDER_TYPE_D_EX"),className:"menu-popup-no-icon",onclick:function(){e.setType("D");this.popupWindow.close()}}];var s=this.id()+"-form-transport";BX.PopupMenu.show(s,t,i,{offsetTop:0,events:{onPopupShow:BX.delegate(this.closeCalendarSubWindow,this)}});this.instances.typeWindow=BX.PopupMenu.getMenuById(s)}}})})();
//# sourceMappingURL=logic.map.js