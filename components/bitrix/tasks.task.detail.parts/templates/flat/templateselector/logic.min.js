BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TaskDetailPartsTemplateSelector!="undefined"){return}BX.Tasks.Component.TaskDetailPartsTemplateSelector=BX.Tasks.Util.Widget.extend({sys:{code:"templateselector"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);BX.bind(this.control("open"),"click",this.onPopupOpen.bind(this));this.menu=null;this.menuItems=null},onPopupOpen:function(t){t=t||window.event;var e=t.currentTarget;this.getMenuItems().then(function(t){this.menuItems=t;this.showMenu(e)}.bind(this))},showMenu:function(t){if(!this.menu){this.menu=this.createMenu(t)}this.menu.popupWindow.show();BX.addClass(t,"webform-button-active")},getMenuItems:function(){var t=new BX.Promise;if(this.option("menuItems").length){t.fulfill(this.option("menuItems"))}else if(this.menuItems){t.fulfill(this.menuItems)}else{BX.Tasks.Util.Query.runOnce("task.template.find",{parameters:{select:["ID","TITLE"],order:{ID:"desc"},filter:{ZOMBIE:"N"}}}).then(function(e){t.fulfill(this.makeItemsFromResult(e))}.bind(this),function(){t.reject()})}return t},makeItemsFromResult:function(t){var e=[];var n=this.option("commonUrl");if(t.isSuccess()){var s=t.getData();if(s.DATA){var i=n+(n.indexOf("?")<0?"?":"&");var o=window.location.href;var r=window.location.pathname;var a=o.split(r)[1];var u=a.substr(1,a.length-1);var l=u.split("&");Object.keys(l).forEach(function(t){if(l[t].indexOf("IFRAME")===0||l[t].indexOf("TEMPLATE")===0){delete l[t]}});l=l.filter(function(t){return t!==undefined});if(l.length){i+=l.join("&")+"&"}BX.Tasks.each(s.DATA,function(t){e.push({ID:parseInt(t.ID),TITLE:t.TITLE,URL:i+"TEMPLATE="+parseInt(t.ID)})})}}return e},createMenu:function(t){var e=[];var n=function(){this.popupWindow.close()};BX.Tasks.each(this.menuItems||[],function(t){e.push({text:BX.util.htmlspecialchars(t.TITLE),title:t.TITLE,href:t.URL,onclick:n})});e.push({delimiter:true});e.push({text:BX.util.htmlspecialchars(BX.message("TASKS_TTDP_TEMPLATESELECTOR_TO_LIST")),title:BX.util.htmlspecialchars(BX.message("TASKS_TTDP_TEMPLATESELECTOR_TO_LIST")),href:this.option("toTemplates"),target:"_top",onclick:n});var s=this.id()+"-form-transport";var i=new BX.PopupMenuWindow(s,t,e,{offsetLeft:20,closeByEsc:true,angle:{position:"top"},events:{onPopupClose:this.onPopupClose.bind(this)}});if(!this.option("useSlider")){var o=i.menuItems;for(var r=0;r<o.length;r++){var a=o[r].layout;if(a&&a.item){a.item.dataset.sliderIgnoreAutobinding=true}}}return i},onPopupClose:function(){BX.removeClass(this.control("open"),"webform-button-active")}}})}).call(this);