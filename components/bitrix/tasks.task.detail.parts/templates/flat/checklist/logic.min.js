BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TaskDetailPartsChecklist!="undefined"){return}var t=function(t,e){this.vars={};this.ctrls={};this.data(t.data);this.can(t.can||{MODIFY:true,REMOVE:true,TOGGLE:true});var i=BX.clone(this.data());i.CHECKED=this.isComplete()?"checked":"";i.READONLY=this.vars.can.MODIFY?"":"noedit";i.APPEARANCE=this.isSeparatorValue(i.TITLE)?"a-separator":"a-generic";this.mode="read";this.parent=e;this.scope=e.getNodeByTemplate("item",i)[0]};BX.mergeEx(t.prototype,{data:function(t){if(typeof t!=="undefined"){this.vars.data=t;this.blockRedraw=true;this.title(t.TITLE,false);this.blockRedraw=false;return}return this.vars.data},can:function(t){if(typeof t!=="undefined"){this.vars.can=t;return}return this.vars.can},isComplete:function(t){if(typeof t!=="undefined"){this.vars.data.IS_COMPLETE=t?"Y":"N";this.redraw();return}return this.data().IS_COMPLETE=="Y"},sortIndex:function(t){if(typeof t!=="undefined"){this.vars.data.SORT_INDEX=parseInt(t);this.redraw();return}return parseInt(this.data().SORT_INDEX)},id:function(){return this.data().ID},number:function(t){t=parseInt(t);if(!isNaN(t)){this.control("number").innerHTML=t}},title:function(t,e){if(typeof t!="undefined"){this.vars.data.TITLE=t;if(typeof this.vars.data.TITLE_HTML=="undefined"||e!==false){this.vars.data.TITLE_HTML=BX.util.htmlspecialchars(this.data().TITLE)}this.redraw();return}return this.data().TITLE},titleTmp:function(){return this.control("title-edit").value.toString()},destruct:function(){BX.remove(this.scope);this.scope=null;this.vars.data=null},isSeparator:function(){return this.isSeparatorValue(this.data().TITLE)},setAppearance:function(t){t=t=="separator"?"a-separator":"a-generic";this.parent.dropCSSFlags("a-*",this.scope);this.parent.setCSSFlag(t,this.scope)},setEditMode:function(){if(this.mode=="edit"){return}this.mode="edit";this.control("title-edit").value=this.data().TITLE;this.redraw()},setReadMode:function(){if(this.mode=="read"){return}this.mode="read";this.redraw()},applyTitleChange:function(){this.setReadMode();this.title(this.titleTmp())},handleDelete:function(){if(this.mode=="edit"){this.control("title-edit").value=this.data().TITLE;this.setReadMode();return false}else{return true}},isSeparatorValue:function(t){t=t.toString().replace(/^\s+/,"").replace(/\s+$/,"");return!!t.match(/^(-|=|_|\*|\+){3,}$/)},control:function(t){t="item-"+t;if(typeof this.ctrls[t]=="undefined"){this.ctrls[t]=this.parent.control(t,this.scope)}return this.ctrls[t]},redraw:function(){if(this.blockRedraw){return}if(this.mode=="edit"){this.parent.setCSSMode("mode","edit",this.scope)}else{this.parent.setCSSMode("mode","read",this.scope)}try{this.control("title").innerHTML=this.data().TITLE_HTML}catch(t){}try{this.control("btn-check").checked=this.isComplete()}catch(t){}try{this.control("is-complete-fld").value=this.isComplete()?"Y":"N"}catch(t){}try{this.control("sort-index-fld").value=parseInt(this.sortIndex())}catch(t){}if(this.isSeparator()){this.setAppearance("separator")}}});BX.Tasks.Component.TaskDetailPartsChecklist=BX.Tasks.Util.Widget.extend({sys:{code:"checklist"},options:{data:false,autoSync:false,taskId:false,taskCanEdit:false},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);BX.mergeEx(this.vars,{items:{},newIncrement:0,syncLock:false});var t=new BX.Tasks.Util.DragAndDrop({createFlying:BX.delegate(function(t){var e=BX.data(t,"item-id");var i=this.vars.items[e];return this.getNodeByTemplate((i.isSeparator()?"separator":"item")+"-flying",{TITLE_HTML:i.data().TITLE_HTML,CHECKED:i.isComplete()?"checked":"",ID:i.id()})[0]},this),autoMarkItemAfter:true,autoMarkZoneTopBottom:true});t.bindDropZone(this.control("items-ongoing"));t.bindDropZone(this.control("items-complete"));if(typeof this.instances=="undefined"){this.instances={}}this.instances.dragNDrop=t;this.instances.query=false;this.bindEvents();this.load(this.option("data"))},bindEvents:function(){this.bindDelegateControl("item-btn-edit","click",this.passCtx(this.setItemEdit));this.bindDelegateControl("item-btn-delete","click",this.passCtx(this.setItemCancel));this.bindDelegateControl("item-btn-apply","click",this.passCtx(this.setItemApply));this.bindDelegateControl("item-btn-check","change",this.passCtx(this.setItemToggle));this.bindDelegateControl("item-title-edit","keydown",this.passCtx(this.setItemApplyOnKeydown));this.bindDelegateControl("add-item-form-open","click",this.passCtx(this.newItemOpenForm));this.bindDelegateControl("add-item-form-close","click",this.passCtx(this.newItemCloseForm));this.bindDelegateControl("add-item","click",this.passCtx(this.newItemAdd));this.bindDelegateControl("add-item-title","keydown",this.passCtx(this.newItemTitleKeydown));this.bindDelegateControl("toggle-complete","click",BX.delegate(this.onCompleteToggle,this));this.bindDelegateControl("add-separator","click",BX.delegate(this.newSeparatorAdd,this));this.instances.dragNDrop.bindEvent("item-relocated",BX.delegate(this.itemRelocated,this))},itemRelocated:function(t,e,i){var s=BX.data(t,"item-id");var n=this.vars.items[s];var a=[];var r=e==this.control("items-complete");if(n.isComplete()!=r){n.isComplete(r);a.push([r?"complete":"renew",{id:s}])}var o=false;if(i.after!==null){o=BX.data(i.after,"item-id")}if(r&&o===false){o=this.getOngoingItemByGreatestSortIndex()}if(o!=s){a.push(["moveAfter",{id:n.id(),afterId:o}]);this.sync(a);this.shiftSortIndexes(s,o)}this.redraw()},shiftSortIndexes:function(t,e){var i=this.getSortedItemList();var s=[];if(e===false){s.push(t)}for(var n=0;n<i.length;n++){if(i[n].id==t){continue}s.push(i[n].id);if(e!==false&&i[n].id==e){s.push(t)}}var a=0;for(var n=0;n<s.length;n++){this.vars.items[s[n]].sortIndex(a);a++}},setItemEdit:function(t){this.newItemCloseForm();var e=this.getInstanceByNode(t);if(e){e.setEditMode()}},setItemCancel:function(t){var e=this.getInstanceByNode(t);if(e){if(e.handleDelete()){var i=e.id();if(!this.getQuery()){this.deleteItem(i)}else{BX.Tasks.confirm(BX.message("TASKS_COMMON_CONFIRM_DELETE").replace("#ENTITY_NAME#",BX.message("TASKS_TTDP_CHECKLIST_ENTITY_NAME")),function(t){if(t){this.deleteItem(i)}},{ctx:this})}}}},setItemApply:function(t){var e=this.getInstanceByNode(t);if(e){var i=e.titleTmp();if(i.length>0){this.sync([["update",{id:e.id(),data:{TITLE:i}}]],function(){e.applyTitleChange();this.redraw()})}}},setItemApplyOnKeydown:function(t,e){if(BX.Tasks.Util.isEnter(e)){this.setItemApply(t);BX.PreventDefault(e)}},setItemToggle:function(t){var e=this.getInstanceByNode(t);if(e){if(!e.can().TOGGLE){t.checked=!t.checked;return}this.sync([[t.checked?"complete":"renew",{id:e.id()}]]);e.isComplete(t.checked);this.redraw()}},getInstanceByNode:function(t){var e=this.controlP("item-appearance",t);if(BX.type.isElementNode(e)){var i=BX.data(e,"item-id");if(typeof i!="undefined"&&i!==null){return this.vars.items[i]}}},getQuery:function(){if(!this.option("autoSync")||!parseInt(this.option("taskId"))){return null}if(!this.instances.query){this.instances.query=new BX.Tasks.Util.Query}return this.instances.query},addItem:function(e,i){i=i||{};if(e.data.TITLE.toString().length==0){return false}if(typeof e.data.ID=="undefined"){e.data.ID="n"+this.vars.newIncrement++}var s=new t(e,this);this.vars.items[s.id()]=s;if(this.option("taskCan")["CHECKLIST.REORDER"]){this.instances.dragNDrop.bindNode(s.scope,{handle:this.controlAll("item-drag",s.scope)})}if(!i.load){this.redraw()}return s.id()},deleteItem:function(t){if(typeof this.vars.items[t]=="undefined"){return}this.sync([["delete",{id:t}]],function(){var e=this.vars.items[t];this.instances.dragNDrop.unBindNode(e.scope);e.destruct();this.vars.items[t]=null;delete this.vars.items[t];this.redraw()})},syncAddItem:function(t,e,i){this.sync([["add",{data:{TASK_ID:parseInt(this.option("taskId")),TITLE:t.data.TITLE,IS_COMPLETE:t.data.IS_COMPLETE}},{code:"task_chl_add"}]],e,i)},sync:function(t,e,i){if(this.vars.syncLock){return}e=BX.type.isFunction(e)?e:BX.DoNothing;var s=this.getQuery();if(s){var n=this;i=BX.type.isFunction(i)?i:BX.DoNothing;n.vars.syncLock=true;i.apply(n,[true]);var a=[];for(var r=0;r<t.length;r++){a.push({m:"task.checklist."+t[r][0],args:t[r][1],rp:t[r][2]})}s.load(a).execute({done:function(t,s){n.vars.syncLock=false;i.apply(n,[false]);if(!t.length){e.apply(n,[s])}}})}else{this.vars.syncLock=false;e.call(this)}},getSortedItemList:function(){var t=[];for(var e in this.vars.items){t.push({ix:this.vars.items[e].sortIndex(),id:this.vars.items[e].id()})}return t.sort(function(t,e){if(t.ix<e.ix){return-1}else if(t.ix>e.ix){return 1}return 0})},redrawControls:function(){var t=0;var e=0;var i=this.getSortedItemList();for(var s=0;s<i.length;s++){if(!this.vars.items[i[s].id].isSeparator()){e++;if(this.vars.items[i[s].id].isComplete()){t++}}}this.showControlIf("complete-block",t>0);this.showControlIf("counterset",t>0);try{this.control("total-counter").innerHTML=e}catch(n){}try{this.control("ongoing-counter").innerHTML=e-t}catch(n){}var a=this.controlAll("complete-counter");for(var s in a){a[s].innerHTML=t}},redrawPool:function(){var t=this.getSortedItemList();var e=BX.create("div");var i=BX.create("div");var s=1;for(var n=0;n<t.length;n++){var a=this.vars.items[t[n].id];if(!a.isSeparator()){a.number(s++)}BX.append(a.scope,a.isComplete()?i:e)}this.moveNodePool(i,this.control("items-complete"));this.moveNodePool(e,this.control("items-ongoing"))},redraw:function(){this.redrawPool();this.redrawControls()},moveNodePool:function(t,e){while(t.childNodes.length>0){BX.append(t.childNodes[0],e)}},load:function(t){if(BX.type.isPlainObject(t)){var e=0;for(var i in t){var s={data:BX.clone(t[i]),can:t[i].ACTION};this.addItem(s,{load:true});e++}this.vars.newIncrement=e;this.redraw()}},getOngoingItemByGreatestSortIndex:function(){var t=0;var e=false;for(var i in this.vars.items){var s=this.vars.items[i].sortIndex();if(s>t&&!this.vars.items[i].isComplete()){t=s;e=i}}return e},getGreatestSortIndex:function(){var t=0;for(var e in this.vars.items){var i=this.vars.items[e].sortIndex();if(i>t){t=i}}return t},newItemOpenForm:function(){this.switchControl(this.control("add-item-form"),"on");this.control("add-item-title").focus()},newItemCloseForm:function(){this.switchControl(this.control("add-item-form"),"off")},newItemTitleKeydown:function(t,e){if(BX.Tasks.Util.isEnter(e)){this.newItemAdd();BX.PreventDefault(e)}},newSeparatorAdd:function(){var t=this.makeItemData("===");this.syncAddItem({data:t},function(e){try{t.ID=parseInt(e.data["task_chl_add"].RESULT.DATA.ID)}catch(i){}this.addItem({data:t})})},newItemAdd:function(){if(this.control("add-item-title").value.toString().length<1){return}var t=this.makeItemData(this.control("add-item-title").value);this.syncAddItem({data:t},function(e){try{t.ID=parseInt(e.data["task_chl_add"].RESULT.DATA.ID)}catch(i){}this.control("add-item-title").value="";this.control("add-item-title").focus();this.addItem({data:t})},function(t){if(t){BX.Tasks.Util.disable(this.control("add-item-title"))}else{BX.Tasks.Util.enable(this.control("add-item-title"))}})},makeItemData:function(t){return{IS_COMPLETE:"N",SORT_INDEX:this.getGreatestSortIndex()+1,TITLE:t}},onCompleteToggle:function(){BX.toggleClass(this.control("complete-block"),"open")},showControlIf:function(t,e){BX[e?"removeClass":"addClass"](this.control(t),"hidden")},switchControl:function(t,e){e=e=="on";if(e){BX.addClass(t,"on");BX.removeClass(t,"off")}else{BX.removeClass(t,"on");BX.addClass(t,"off")}},count:function(){var t=0;for(var e in this.vars.items){t++}return t}}})})();
//# sourceMappingURL=logic.map.js