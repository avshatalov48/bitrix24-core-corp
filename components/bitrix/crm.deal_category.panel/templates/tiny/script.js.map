{"version":3,"file":"script.js","sources":["src/panel.js"],"sourcesContent":["import {Event, Loc, Type, Dom, Runtime, ajax, Text} from 'main.core';\nimport {PopupMenuWindow} from 'main.popup';\n\ntype PanelItem = {\n\tID: number | string,\n\tNAME: string,\n\tIS_ACTIVE: boolean,\n\tCOUNTER: number,\n\tCOUNTER_CODE: string,\n\tURL: string,\n\tCREATE_URL: string,\n\tENABLED: string,\n};\n\ntype PanelOptions = {\n\tcounter: HTMLSpanElement,\n\tbutton: HTMLButtonElement,\n\tcontainer: HTMLDivElement,\n\titems: Array<PanelItem>,\n\ttunnelsUrl: string,\n\tcomponentParams: Object,\n};\n\nexport class Panel extends Event.EventEmitter\n{\n\tstatic createMenuItem(options: PanelItem)\n\t{\n\t\tconst item = {\n\t\t\tid: options.ID,\n\t\t\thtml: Text.encode(options.NAME),\n\t\t\thref: options.URL,\n\t\t};\n\n\t\tconst count = Number.parseInt(options.COUNTER, 10);\n\n\t\tif (Type.isNumber(count) && count > 0)\n\t\t{\n\t\t\tconst counter = `<span class=\"main-buttons-item-counter\">${options.COUNTER}</span>`;\n\t\t\titem.html = `${item.html} ${counter}`;\n\t\t}\n\n\t\treturn item;\n\t}\n\n\tconstructor(options: PanelOptions)\n\t{\n\t\tsuper();\n\n\t\tthis.button = options.button;\n\t\tthis.counter = options.counter;\n\t\tthis.container = options.container;\n\t\tthis.items = options.items;\n\t\tthis.tunnelsUrl = options.tunnelsUrl;\n\t\tthis.componentParams = options.componentParams;\n\t\tthis.onButtonClick = this.onButtonClick.bind(this);\n\n\t\tEvent.bind(this.button, 'click', this.onButtonClick);\n\t}\n\n\tisDropdown()\n\t{\n\t\treturn Dom.hasClass(this.button, 'ui-btn-dropdown');\n\t}\n\n\treload()\n\t{\n\t\treturn ajax\n\t\t\t.runComponentAction(\n\t\t\t\t'bitrix:crm.deal_category.panel',\n\t\t\t\t'getComponent',\n\t\t\t\t{\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tparams: this.componentParams,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t)\n\t\t\t.then((response) => {\n\t\t\t\tconst newContainer = Runtime.html(null, response.data.html);\n\n\t\t\t\tDom.replace(this.container, newContainer);\n\t\t\t\tthis.getMenu().destroy();\n\t\t\t});\n\t}\n\n\tonButtonClick(event)\n\t{\n\t\tevent.preventDefault();\n\n\t\tif (this.isDropdown())\n\t\t{\n\t\t\tthis.getMenu().show();\n\t\t\treturn;\n\t\t}\n\n\t\tthis.showTunnelSlider();\n\t}\n\n\tshowTunnelSlider()\n\t{\n\t\t// eslint-disable-next-line\n\t\tBX.SidePanel.Instance.open(\n\t\t\tthis.tunnelsUrl,\n\t\t\t{\n\t\t\t\tcacheable: false,\n\t\t\t\tcustomLeftBoundary: 40,\n\t\t\t\tallowChangeHistory: false,\n\t\t\t\tevents: {\n\t\t\t\t\tonClose: () => {\n\t\t\t\t\t\tthis.reload();\n\t\t\t\t\t\tif (window.top.BX.Main && window.top.BX.Main.filterManager)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tconst {data} = window.top.BX.Main.filterManager;\n\t\t\t\t\t\t\t// eslint-disable-next-line\n\t\t\t\t\t\t\tObject.values(data).forEach(filter => filter._onFindButtonClick());\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\t}\n\n\tgetMenu()\n\t{\n\t\tif (!this.menu)\n\t\t{\n\t\t\tconst menuItems = this.items\n\t\t\t\t.map(item => Panel.createMenuItem(item));\n\n\t\t\tmenuItems.push({\n\t\t\t\tdelimiter: true,\n\t\t\t});\n\n\t\t\tmenuItems.push({\n\t\t\t\tid: 'tunnels',\n\t\t\t\ttext: Loc.getMessage('CRM_DEAL_CATEGORY_PANEL_TUNNELS2'),\n\t\t\t\tonclick: this.showTunnelSlider.bind(this),\n\t\t\t});\n\n\t\t\tthis.menu = new PopupMenuWindow({\n\t\t\t\tbindElement: this.button,\n\t\t\t\titems: menuItems,\n\t\t\t});\n\t\t}\n\n\t\treturn this.menu;\n\t}\n}\n"],"names":["Panel","options","item","id","ID","html","Text","encode","NAME","href","URL","count","Number","parseInt","COUNTER","Type","isNumber","counter","button","container","items","tunnelsUrl","componentParams","onButtonClick","bind","Event","Dom","hasClass","ajax","runComponentAction","data","params","then","response","newContainer","Runtime","replace","getMenu","destroy","event","preventDefault","isDropdown","show","showTunnelSlider","BX","SidePanel","Instance","open","cacheable","customLeftBoundary","allowChangeHistory","events","onClose","reload","window","top","Main","filterManager","Object","values","forEach","filter","_onFindButtonClick","menu","menuItems","map","createMenuItem","push","delimiter","text","Loc","getMessage","onclick","PopupMenuWindow","bindElement","EventEmitter"],"mappings":"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"}