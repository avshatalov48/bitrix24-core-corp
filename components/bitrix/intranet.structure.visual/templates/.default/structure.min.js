(function(){if(BX.IntranetVS)return;var t=null,e=[],i={},s=function(){this.style.width="0px";this.offsetWidth;var t=BX.GetWindowScrollSize();this.style.width=t.scrollWidth+"px"};BX.IntranetVS=function(e,i){if(!!t)t.Clear();t=this;this.node=e;this.config=i;if(!!this.config.EDIT)jsDD.Reset();this.mirror=null;this.lastDragPos=[0,0];this.reloadCallback=BX.proxy(this._reloadCallback,this);BX.ready(BX.proxy(this.Init,this))};BX.IntranetVS.get=function(){return t};BX.IntranetVS.prototype.Init=function(){this.node=BX(this.node);if(!!this.config.EDIT)jsDD.setScrollWindow(this.node);if(!!this.config.UNDO)this.setUndo()};BX.IntranetVS.prototype._reloadCallback=function(t){BX.closeWait();jsDD.Enable();if(BX.util.trim(t).substring(0,1)=="{"){t=BX.parseJSON(t);if(t.error){alert(t.error)}}else{var s=[];while(e.length>0){current_sect=e.pop();s.push(current_sect.section_id);current_sect.closeNext(true)}this.node.innerHTML=t;if(s.length>0){var o=function(){var t=s.pop();if(t>0&&i[t]){setTimeout(function(){i[t].showNext(o)},50)}};o()}}};BX.IntranetVS.prototype.setUndo=function(){this.config.UNDO.CONT=BX(this.config.UNDO.CONT);this.config.UNDO.CONT_POS=BX.pos(this.config.UNDO.CONT);if(this.config.UNDO.CONT){this._undoCheckScroll();BX.bind(window,"scroll",BX.proxy(this._undoCheckScroll,this))}};BX.IntranetVS.prototype._undoCheckScroll=function(){var t=BX.GetWindowScrollPos(),e=BX.pos(this.node);if(t.scrollTop>e.top-10)BX.addClass(this.config.UNDO.CONT,"structure-undo-scroll");else BX.removeClass(this.config.UNDO.CONT,"structure-undo-scroll")};BX.IntranetVS.prototype.ondragstart=function(t){if(this.mirror&&this.mirror.parentNode)this.mirror.parentNode.removeChild(this.mirror);if(this.employeesPopup)this.employeesPopup.close();this.mirror=t};BX.IntranetVS.prototype.ondrag=function(t,e){this.lastDragPos=[t,e]};BX.IntranetVS.prototype.Undo=function(t){jsDD.Disable();BX.showWait(this.config.UNDO.CONT);BX.ajax.get(this.config.URL,{sessid:BX.bitrix_sessid(),action:"undo",undo:t},this.reloadCallback)};BX.IntranetVS.prototype.CloseUndo=function(t){if(this.config.UNDO&&this.config.UNDO.CONT){BX.cleanNode(this.config.UNDO.CONT,true)}BX.unbind(window,"scroll",BX.proxy(this._undoCheckScroll,this))};BX.IntranetVS.prototype.Reload=function(){jsDD.Disable();BX.showWait(this.node);BX.ajax.get(this.config.URL,{sessid:BX.bitrix_sessid(),mode:"reload"},this.reloadCallback)};BX.IntranetVS.prototype.Clear=function(){this.CloseUndo()};BX.IntranetVSBlock=function(t){this.bEdit=!!t.bEdit;this.section_id=t.section_id;this.section_level=t.section_level;this.section_parent=t.section_parent;this.node=t.node;this.head=t.head;this.employees=t.employees;this.hasChildren=t.hasChildren;this.disableDrag=t.disableDrag;this.disableDragDest=t.disableDragDest;this.baseZindex=1e3;this.tplParts={};this.employees_index={};for(var e=0;e<this.employees.length;e++){this.employees_index[this.employees[e].ID]=this.employees[e]}i[this.section_id]=this;BX.template(this.node,BX.proxy(this.Init,this),false)};BX.IntranetVSBlock.prototype.Init=function(t){var e;this.node=BX.proxy_context;this.tplParts=t;this.node.__bxdepartment=this;this.config=BX.IntranetVS.get().config;this.bEdit=!!this.config.EDIT;if(this.bEdit){this.DDRegister()}if(t.department_employee_images){e=t.department_employee_images.firstChild;while(!!e){if(BX.type.isElementNode(e)){if(this.bEdit){BX.IntranetVSUser.register(e,this.employees_index[e.getAttribute("data-user")])}}e=e.nextSibling}}if(!!t.department_head&&!!this.head){if(this.bEdit){BX.IntranetVSUser.register(t.department_head,this.employees_index[this.head])}}if(this.bEdit){if(t.department_edit)BX.bind(t.department_edit,"click",BX.delegate(this.editDepartment,this));if(t.department_delete)BX.bind(t.department_delete,"click",BX.delegate(this.deleteDepartment,this));if(t.department_add)BX.bind(t.department_add,"click",BX.delegate(this.addDepartment,this))}if(this.hasChildren&&this.tplParts.department_next_link){BX.bind(this.tplParts.department_next_link,"click",BX.proxy(this.showNext,this));BX.hoverEvents(this.tplParts.department_next_link)}if(this.tplParts.department_employee_count){BX.bind(this.tplParts.department_employee_count,"click",BX.proxy(this.showEmployees,this))}};BX.IntranetVSBlock.prototype.showEmployees=function(){if(!this.employeesPopup){var t=BX.create("DIV",{props:{className:"structure-dept-emp-popup"}});for(var e=0;e<this.employees.length;e++){var i=BX.create("DIV",{props:{className:"structure-boss-block"},attrs:{title:BX.util.htmlspecialcharsback(this.employees[e].NAME),"data-user":this.employees[e].ID,"data-dpt":this.section_id,"bx-tooltip-user-id":!!this.config.USE_USER_LINK?this.employees[e].ID:"","bx-tooltip-classname":"intrantet-user-selector-tooltip"},html:'<a class="ui-icon ui-icon-common-user structure-avatar" href="'+this.employees[e].PROFILE+'"><i '+(this.employees[e].PHOTO?" style=\"background: url('"+this.employees[e].PHOTO+"') no-repeat scroll center center transparent; background-size: cover;\"":"")+'></i></a><div class="structure-employee-name"><a href="'+this.employees[e].PROFILE+'">'+this.employees[e].NAME+"</a></div>"+(this.employees[e].POSITION?'<div class="structure-employee-post">'+BX.util.htmlspecialchars(this.employees[e].POSITION)+"</div>":"")});if(this.bEdit){BX.IntranetVSUser.register(i,this.employees[e])}if(this.employees[e].ID==this.head){i.className+=" bx-popup-head";if(t.firstChild){t.insertBefore(i,t.firstChild);continue}}t.appendChild(i)}this.employeesPopup=new BX.PopupWindow("vis_emp_"+Math.random(),BX.proxy_context,{closeByEsc:true,autoHide:true,lightShadow:true,zIndex:this.baseZindex,content:t,offsetLeft:50,angle:true})}BX.IntranetVS.get().employeesPopup=this.employeesPopup;this.employeesPopup.show()};BX.IntranetVSBlock.prototype.editDepartment=function(t){BX.IntranetStructure.ShowForm({UF_DEPARTMENT_ID:this.section_id});return t.preventDefault()};BX.IntranetVSBlock.prototype.addDepartment=function(t){BX.IntranetStructure.ShowForm({IBLOCK_SECTION_ID:this.section_id});return t.preventDefault()};BX.IntranetVSBlock.prototype.deleteDepartment=function(t){if(confirm(BX.message("confirm_delete_department"))){jsDD.Disable();BX.showWait(this.node);BX.ajax.get(this.config.URL,{sessid:BX.bitrix_sessid(),action:"delete_department",dpt_id:this.section_id},BX.IntranetVS.get().reloadCallback)}return t.preventDefault()};BX.IntranetVSBlock.prototype.showNext=function(t){if(!!this.tplParts.department_next_link){var e={mode:"subtree",section:this.section_id,level:this.section_level};if(this.config.HAS_MULTIPLE_ROOTS)e.mr="Y";BX.showWait(this.node);if(BX.type.isFunction(t))this._showNextCallback=t;BX.ajax.get(this.config.URL,e,BX.proxy(this._showNext,this))}};BX.IntranetVSBlock.prototype._showNext=function(t){BX.closeWait(this.node);var i=BX.pos(this.node);if(this.clone||i.left==0)return;this.clone=BX.create("DIV",{style:{height:i.height+"px",width:i.width+"px"}});this.node.parentNode.replaceChild(this.clone,this.node);BX.addClass(this.node,"bx-current");BX.removeClass(this.node,"structure-dept-nesting");this.node.style.zIndex=this.baseZindex+30*this.section_level;this.node.style.top=i.top+"px";this.node.style.left=i.left+"px";document.body.appendChild(this.node);var o=BX.GetWindowScrollSize();this.overlay=document.body.appendChild(BX.create("DIV",{style:{position:"absolute",top:"0px",left:"0px",width:o.scrollWidth+"px",height:o.scrollHeight+"px",zIndex:this.baseZindex+25*this.section_level}}));BX.bind(window,"resize",BX.proxy(s,this.overlay));this.shadow=document.body.appendChild(BX.create("DIV",{props:{className:"bx-str-result"},style:{position:"absolute",top:i.top-20+"px",zIndex:this.baseZindex+28*this.section_level,padding:i.height+30+"px 100px 20px 20px"},html:t}));setTimeout(BX.proxy(s,this.overlay),0);var r=BX.pos(this.shadow);var n=parseInt(i.left+(i.right-i.left)/2-(r.right-r.left)/2);if(n<0)n=20;if(n>i.left)n=i.left-30;this.shadow.style.left=n+"px";this.stick=document.body.appendChild(BX.create("DIV",{props:{className:"bx-str-stick"},style:{zIndex:this.baseZindex+29*this.section_level,top:i.bottom-3+"px",left:parseInt((i.right+i.left)/2)+"px"}}));r=BX.pos(this.shadow);if(r.right<i.right+10){this.shadow.style.width=i.right+10-n+"px"}this.shadow.innerHTML+='<div class="bx-dark"><div class="bx-dark-close"></div></div>';e.push(this);this.shadow.lastChild.onclick=this.overlay.onclick=BX.proxy(this.closeNext,this);BX.bind(this.overlay,"mouseover",BX.delegate(function(t){if(this.bEdit&&jsDD.bStarted){this.HIDE_TIMEOUT=setTimeout(BX.proxy(this.closeNext,this),500)}return BX.PreventDefault(t)},this));BX.bind(this.shadow,"mouseover",BX.delegate(function(t){if(this.HIDE_TIMEOUT){clearTimeout(this.HIDE_TIMEOUT);this.HIDE_TIMEOUT=null}return BX.PreventDefault(t)},this));if(BX.type.isFunction(this._showNextCallback))this._showNextCallback.apply(this)};BX.IntranetVSBlock.prototype.closeNext=function(t){if(t!==true)e.pop();BX.removeClass(this.node,"bx-current");BX.addClass(this.node,"structure-dept-nesting");this.node.style.zIndex="";this.node.style.top="";this.node.style.left="";if(this.clone&&this.clone.parentNode)this.clone.parentNode.replaceChild(this.node,this.clone);BX.cleanNode(this.shadow,true);BX.cleanNode(this.clone,true);if(null!=this.overlay){BX.unbind(window,"resize",BX.proxy(s,this.overlay));BX.cleanNode(this.overlay,true)}if(null!=this.stick)BX.cleanNode(this.stick,true);this.clone=null;if(this.bEdit)setTimeout(function(){jsDD.refreshDestArea()},100)};BX.IntranetVSBlock.prototype.DDRegister=function(){if(this.bEdit&&this.node){jsDD.registerDest(this.node,1e3-this.section_level*30);this.node.onbxdestdragfinish=BX.proxy(this.ddAction,this);this.node.onbxdestdraghover=BX.proxy(this.ddHover,this);this.node.onbxdestdraghout=BX.proxy(this.ddHout,this);if(!this.disableDrag){jsDD.registerObject(this.node);this.node.onbxdrag=BX.delegate(this.ddDrag,this);this.node.onbxdragstart=BX.delegate(this.ddStart,this);this.node.onbxdragstop=BX.delegate(this.ddFinish,this)}}};BX.IntranetVSBlock.prototype.ddAction=function(t,e,i,s){s=s||window.event;BX.proxy_context.onbxdestdraghout();if(!!t.__bxemployee)BX.proxy(this._ddActionEmployee,this).apply(BX.proxy_context,arguments);else BX.proxy(this._ddActionDepartment,this).apply(BX.proxy_context,arguments);return true};BX.IntranetVSBlock.prototype._ddActionEmployee=function(t,e,i,s){if(!this.bEdit)return false;var o=t.getAttribute("data-user"),r=t.getAttribute("data-dpt");if(this.section_id!=r||this.bxheadareaover||o==this.head){var n=(s||window.event).shiftKey?1:0;if(this.bxheadareaover){if(!!this.config.SKIP_CONFIRM||confirm(BX.message("confirm_set_head").replace("#EMP_NAME#",t.__bxemployee.NAME).replace("#DPT_NAME#",BX.util.trim(this.tplParts.department_name.innerText||this.tplParts.department_name.textContent)))){jsDD.Disable();BX.showWait(this.node);BX.ajax.get(this.config.URL,{sessid:BX.bitrix_sessid(),action:"set_department_head",user_id:o,dpt_id:this.section_id,dpt_from:r,type:n},BX.IntranetVS.get().reloadCallback)}}else{if(this.config.SKIP_CONFIRM||confirm(BX.message("confirm_change_department_"+n).replace("#EMP_NAME#",BX.util.trim(t.__bxemployee.NAME)).replace("#DPT_NAME#",BX.util.trim(this.tplParts.department_name.innerText||this.tplParts.department_name.textContent)))){jsDD.Disable();BX.showWait(this.node);BX.ajax.get(this.config.URL,{sessid:BX.bitrix_sessid(),action:"change_department",user_id:o,dpt_id:this.section_id,dpt_from:r,type:n},BX.IntranetVS.get().reloadCallback)}}}};BX.IntranetVSBlock.prototype._ddActionDepartment=function(t,e,i,s){if(!this.bEdit||this.disableDragDest)return false;var o=t.__bxdepartment,r=o.tplParts.department_name,n=this.tplParts.department_name;if(o!=this){if(!!this.config.SKIP_CONFIRM||confirm(BX.message("confirm_move_department").replace("#DPT_NAME#",BX.util.trim(r.innerText||r.textContent)).replace("#DPT_NAME_TO#",BX.util.trim(n.innerText||n.textContent)))){jsDD.Disable();BX.showWait(this.node);BX.ajax.get(this.config.URL,{sessid:BX.bitrix_sessid(),action:"move_department",dpt_id:o.section_id,dpt_to:this.section_id},BX.IntranetVS.get().reloadCallback)}}};BX.IntranetVSBlock.prototype.ddHover=function(t){if(!!t.__bxemployee){if(t.getAttribute("data-dpt")!=this.section_id||t.getAttribute("data-user")==this.head){BX.addClass(this.node,"structure-add-employee")}}else if(t!=this.node){BX.addClass(this.node,"structure-add-dept")}if(BX.browser.IsIE()||BX.browser.IsIE11()){this.nextLinkPos=null;this.headAreaPos=null;if(!!this.tplParts.department_next_link){this.nextLinkPos=BX.pos(this.tplParts.department_next_link)}if(!!this.tplParts.department_head&&!!t.__bxemployee&&t.getAttribute("data-user")!=this.head){this.headAreaPos=BX.pos(this.tplParts.department_head)}if(this.headAreaPos||this.nextLinkPos){BX.bind(document,"mousemove",BX.proxy(this.__ie_mouseover_check,this))}}else{if(!!this.tplParts.department_next_link){BX.bind(this.tplParts.department_next_link,"mouseout",BX.proxy(this.__nextlink_hout,this));BX.bind(this.tplParts.department_next_link,"mouseover",BX.proxy(this.__nextlink_hover,this))}if(!!this.tplParts.department_head&&!!t.__bxemployee&&t.getAttribute("data-user")!=this.head){BX.bind(this.tplParts.department_head,"mouseover",BX.proxy(this.__headarea_hover,this));BX.bind(this.tplParts.department_head,"mouseout",BX.proxy(this.__headarea_hout,this))}}};BX.IntranetVSBlock.prototype.ddHout=function(){BX.removeClass(this.node,"structure-add-employee");BX.removeClass(this.node,"structure-add-dept");BX.removeClass(this.node,"structure-designate-boss");if(!!this.tplParts.department_next_link){setTimeout(BX.delegate(function(){BX.unbind(this.tplParts.department_next_link,"mouseover",BX.proxy(this.__nextlink_hover,this));BX.unbind(this.tplParts.department_next_link,"mouseout",BX.proxy(this.__nextlink_hout,this))},this),10)}if(!!this.tplParts.department_head){BX.unbind(this.tplParts.department_head,"mouseover",BX.proxy(this.__headarea_hover,this));BX.unbind(this.tplParts.department_head,"mouseout",BX.proxy(this.__headarea_hout,this))}BX.unbind(document,"mousemove",BX.proxy(this.__ie_mouseover_check,this))};BX.IntranetVSBlock.prototype.ddStart=function(){BX.UI.Tooltip&&BX.UI.Tooltip.disable();var t=BX.pos(this.node);BX.addClass(this.node,"structure-move-dept");this.mirror=document.body.appendChild(BX.clone(this.node));BX.adjust(this.mirror,{style:{position:"absolute",top:t.top+"px",left:t.left+"px",zIndex:2500}});BX.IntranetVS.get().ondragstart(this.mirror);if(this.employeesPopup)this.employeesPopup.close()};BX.IntranetVSBlock.prototype.ddDrag=function(t,e){if(!!this.mirror){this.mirror.style.left=Math.min(t+5,jsDD.wndSize.scrollWidth-this.mirror.offsetWidth-5)+"px";this.mirror.style.top=Math.min(e+5,jsDD.wndSize.scrollHeight-this.mirror.offsetHeight-5)+"px"}};BX.IntranetVSBlock.prototype.ddFinish=function(){if(!!this.mirror&&!!this.mirror.parentNode)this.mirror.parentNode.removeChild(this.mirror);this.mirror=null;BX.removeClass(this.node,"structure-move-dept");BX.UI.Tooltip&&BX.UI.Tooltip.enable()};BX.IntranetVSBlock.prototype.__nextlink_hover=function(){this.nextlinkover=true;if(this.BXHOVERTIMER)clearTimeout(this.BXHOVERTIMER);this.BXHOVERTIMER=setTimeout(BX.proxy(this.showNext,this),500)};BX.IntranetVSBlock.prototype.__nextlink_hout=function(){this.nextlinkover=false;if(this.BXHOVERTIMER){clearTimeout(this.BXHOVERTIMER);this.BXHOVERTIMER=null}};BX.IntranetVSBlock.prototype.__headarea_hover=function(){this.bxheadareaover=true;BX.addClass(this.node,"structure-designate-boss");BX.removeClass(this.node,"structure-add-employee")};BX.IntranetVSBlock.prototype.__headarea_hout=function(){this.bxheadareaover=false;BX.removeClass(this.node,"structure-designate-boss");if(jsDD.current_node.getAttribute("data-dpt")!=this.section_id){BX.addClass(this.node,"structure-add-employee")}};BX.IntranetVSBlock.prototype.__pos_check=function(t){return BX.IntranetVS.get().lastDragPos[0]>=t.left&&BX.IntranetVS.get().lastDragPos[0]<=t.right&&BX.IntranetVS.get().lastDragPos[1]>=t.top&&BX.IntranetVS.get().lastDragPos[1]<=t.bottom};BX.IntranetVSBlock.prototype.__ie_mouseover_check=function(){if(!!this.headAreaPos&&this.__pos_check(this.headAreaPos)){if(!this.bxheadareaover)this.__headarea_hover()}else{if(this.bxheadareaover)this.__headarea_hout()}if(!!this.nextLinkPos&&this.__pos_check(this.nextLinkPos)){if(!this.nextlinkover)this.__nextlink_hover()}else{if(this.nextlinkover)this.__nextlink_hout()}};BX.IntranetVSSorter=function(t){this.node=t.node;this.params=t;this.config=BX.IntranetVS.get().config;this.action=false;BX.ready(BX.delegate(this.Init,this))};BX.IntranetVSSorter.prototype.Init=function(){this.node=BX(this.node);if(this.node){this.node.onbxdestdraghover=BX.delegate(this.onbxdestdraghover,this);this.node.onbxdestdraghout=BX.delegate(this.onbxdestdraghout,this);this.node.onbxdestdragfinish=BX.delegate(this.Action,this);jsDD.registerDest(this.node)}};BX.IntranetVSSorter.prototype.Action=function(t,e,i,s){if(this.action){if(this.params.parentSection!=t.__bxdepartment.section_parent){jsDD.Disable();BX.showWait(this.node);BX.ajax.get(this.config.URL,{sessid:BX.bitrix_sessid(),action:"move_department",dpt_id:t.__bxdepartment.section_id,dpt_to:this.params.parentSection,dpt_before:this.params.beforeId,dpt_after:this.params.afterId,dpt_parent:this.params.parentSection},BX.IntranetVS.get().reloadCallback)}else{jsDD.Disable();BX.showWait(this.node);BX.ajax.get(this.config.URL,{sessid:BX.bitrix_sessid(),action:"sort_department",dpt_id:t.__bxdepartment.section_id,dpt_before:this.params.beforeId,dpt_after:this.params.afterId,dpt_parent:this.params.parentSection},BX.IntranetVS.get().reloadCallback)}}this.onbxdestdraghout()};BX.IntranetVSSorter.prototype.onbxdestdraghover=function(t){if(!!t.__bxdepartment&&t.__bxdepartment.section_id!=this.params.beforeId&&t.__bxdepartment.section_id!=this.params.afterId){this.action=true;BX.addClass(this.node,"structure-sorter-visible");if(this.params.parentSection!=t.__bxdepartment.section_parent){var e=this.section_block||BX("bx_str_"+this.params.parentSection);if(e){this.section_block=e;this.section_block.onbxdestdraghover.apply(this.section_block,arguments)}}}};BX.IntranetVSSorter.prototype.onbxdestdraghout=function(t){BX.removeClass(this.node,"structure-sorter-visible");if(this.section_block)this.section_block.onbxdestdraghout.apply(this.section_block,arguments);this.action=false};BX.IntranetVSUser={mirror:null,register:function(t,e){if(!!t){t.onbxdragstart=BX.IntranetVSUser.onbxdragstart;t.onbxdrag=BX.IntranetVSUser.onbxdrag;t.onbxdragstop=BX.IntranetVSUser.onbxdragfinish;t.__bxemployee=e;jsDD.registerObject(t)}},onbxdragstart:function(){if(!this.__bxemployee)return;BX.UI.Tooltip&&BX.UI.Tooltip.disable();var t=BX.pos(this);BX.IntranetVSUser.mirror=document.body.appendChild(BX.create("DIV",{props:{className:"structure-move-employee"},style:{top:t.top+"px",left:t.left+"px",zIndex:2500},html:"<span"+(this.__bxemployee.PHOTO?" style=\"background: url('"+this.__bxemployee.PHOTO+"') no-repeat scroll center center transparent; background-size: cover;\"":"")+' class="structure-avatar"></span><div class="structure-employee-name">'+this.__bxemployee.NAME+'</div><div class="structure-employee-post">'+BX.util.htmlspecialchars(this.__bxemployee.POSITION)+"</div>"}));BX.IntranetVS.get().ondragstart(BX.IntranetVSUser.mirror)},onbxdrag:function(t,e){BX.IntranetVS.get().ondrag(t,e);if(BX.IntranetVSUser.mirror){BX.IntranetVSUser.mirror.style.left=Math.min(t+5,jsDD.wndSize.scrollWidth-BX.IntranetVSUser.mirror.offsetWidth-5)+"px";BX.IntranetVSUser.mirror.style.top=Math.min(e+5,jsDD.wndSize.scrollHeight-BX.IntranetVSUser.mirror.offsetHeight-5)+"px"}},onbxdragfinish:function(){if(BX.IntranetVSUser.mirror&&BX.IntranetVSUser.mirror.parentNode)BX.IntranetVSUser.mirror.parentNode.removeChild(BX.IntranetVSUser.mirror);BX.IntranetVSUser.mirror=null;BX.UI.Tooltip&&BX.UI.Tooltip.enable()}}})();
//# sourceMappingURL=structure.map.js