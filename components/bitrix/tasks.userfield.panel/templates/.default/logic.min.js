"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.UserFieldPanel!="undefined"){return}BX.Tasks.Component.UserFieldPanel=BX.Tasks.Component.extend({sys:{code:"uf-panel"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);this.instances.items=new BX.Tasks.Component.UserFieldPanel.ItemSet({scope:this.scope(),data:this.option("scheme"),itemFx:"vertical",parent:this});this.instances.items.bindEvent("item-save",BX.delegate(this.onItemSave,this));this.instances.items.bindEvent("item-hide",BX.delegate(this.onItemHide,this));this.instances.items.bindEvent("item-delete",BX.delegate(this.onItemDelete,this));this.saveState=BX.debounce(this.saveStateInstant,1200,this);this.redrawButtons()},bindEvents:function(){this.bindControlPassCtx("add-field","click",this.showAddPopup);this.bindControlPassCtx("action","click",this.showActionPopup);this.bindControlPassCtx("un-hide-field","click",this.showUnHideFieldPopup);this.bindDelegateControl("item-label-edit","keypress",this.jamEnter,this.control("new-item-place"))},jamEnter:function(t){if(BX.Tasks.Util.isEnter(t)){BX.eventReturnFalse(t)}},redrawButtons:function(){var t=false;var e=true;this.instances.items.each((function(i){if(!i.data().STATE.D){t=true}else{e=false}}));this.changeCSSFlag("invisible",!t,this.control("un-hide-field"));this.changeCSSFlag("not-empty",!e,this.control("items"))},openAddForm:function(t,e,i){t.popupWindow.close();i.options=i.options||{};this.instances.items.openAddForm(i.options.code||i.code)},onItemSave:function(t,e,i){i.ENTITY_CODE=this.option("entityCode");BX.ajax.runComponentAction("bitrix:tasks.userfield.panel","saveField",{mode:"class",data:{id:e,data:i,parameters:{INPUT_PREFIX:this.option("inputPrefix"),RELATED_ENTITIES:this.option("relatedEntities")}}}).then(function(e){if(!e.status||e.status!=="success"){return}t.fulfill(e.data)}.bind(this),function(e){t.reject(e.errors)}.bind(this))},onItemHide:function(t,e){var i=this.option("user");var s=i.IS_SUPER;var n=BX.message(s?"TASKS_TUFP_FIELD_HIDE_DELETE_CONFIRM":"TASKS_TUFP_FIELD_HIDE_CONFIRM");var a={id:this.code()+"-fh-confirm-v2",ctx:this,isDisposable:!s,buttonSet:s?[{text:BX.message("TASKS_COMMON_DELETE"),type:"red",code:"delete"},{text:BX.message("TASKS_COMMON_HIDE"),type:"green",code:"continue",default:true}]:false};BX.Tasks.confirm(n,null,a).then(function(i){if(i==="continue"){this.setItemStateDisplay(e,false);t.fulfill("hide")}else if(i==="delete"){BX.ajax.runComponentAction("bitrix:tasks.userfield.panel","deleteField",{mode:"class",data:{id:e,parameters:{RELATED_ENTITIES:this.option("relatedEntities")}}}).then(function(e){if(!e.status||e.status!=="success"){t.reject();return}t.fulfill("delete")}.bind(this),function(e){BX.Tasks.alert(e.errors);t.reject()}.bind(this))}}.bind(this))},onItemDelete:function(t){this.redrawButtons()},setItemStateDisplay:function(t,e,i){this.instances.items.get(t).data().STATE.D=e;this.redrawButtons();if(i){this.saveStateInstant()}else{this.saveState()}},setItemSortBefore:function(t,e){var i=[];this.instances.items.each((function(t){i.push({value:parseInt(t.value()),sort:t.data().STATE.S})}));i=i.sort((function(t,e){if(t.sort>e.sort){return 1}else if(t.sort<e.sort){return-1}return 0}));var s=parseInt(t.value());var n=e?parseInt(e.value()):-1;var a=1;for(var o in i){if(i.hasOwnProperty(o)){if(i[o].value!=s){if(i[o].value==n){this.instances.items.get(s).data().STATE.S=a;a=a+1}this.instances.items.get(i[o].value).data().STATE.S=a;a=a+1}}}if(n<0){this.instances.items.get(s).data().STATE.S=a}this.saveState()},saveStateInstant:function(t){BX.ajax.runComponentAction("bitrix:tasks.userfield.panel","setState",{mode:"class",data:{state:this.packState(),dropAll:!!t,entityCode:this.option("entityCode")}}).then(function(t){}.bind(this),function(t){}.bind(this))},packState:function(){var t={};this.instances.items.each((function(e){t[e.value()]=e.data().STATE}));return t},initDragNDrop:function(){if(!this.instances.dragNDrop){var t=new BX.Tasks.Util.DragAndDrop({createFlying:BX.delegate((function(t){var e=this.getItemByNode(t);return this.getNodeByTemplate("item-flying",e.data())[0]}),this),autoMarkItemAfter:true,autoMarkZoneTopBottom:true});t.bindDropZone(this.control("items"));t.bindEvent("item-relocation-before",this.onDragNDropItemRelocatedBefore,this);t.bindEvent("item-relocation-after",this.onDragNDropItemRelocatedAfter,this);this.instances.dragNDrop=t;this.instances.items.each(BX.delegate(this.bindDragNDropNode,this))}},onDragNDropItemRelocatedBefore:function(t,e,i){var s=this.getItemByNode(e);if(s){t.cancelAutoResolve();s.disappear().then((function(){t.fulfill()}))}},onDragNDropItemRelocatedAfter:function(t,e,i){var s=this.getItemByNode(e);if(s){t.cancelAutoResolve();s.appear().then((function(){t.fulfill()}));this.setItemSortBefore(s,this.getItemByNode(i.before))}},getItemByNode:function(t){var e=null;if(t){var i=BX.data(t,"item-value");if(i){e=this.instances.items.get(i)}}return e},bindDragNDropNode:function(t){if(this.instances.dragNDrop){this.instances.dragNDrop.bindNode(t.scope(),{handle:this.controlAll("item-drag",t.scope())})}},registerItem:function(t){this.bindDragNDropNode(t);this.saveStateInstant()},doMenuAction:function(t,e,i){t.popupWindow.close();var s=i.action;if(s=="dragToggle"){i.layout.text.innerHTML=BX.message("TASKS_TUFP_DRAG_N_DROP_"+(i.enabled?"ON":"OFF"));i.enabled=!i.enabled;if(i.enabled){this.initDragNDrop()}this.changeCSSFlag("drag-mode-on",i.enabled,this.scope())}else if(s=="saveToAll"){BX.Tasks.confirm(BX.message("TASKS_TUFP_SAVE_TO_ALL_CONFIRM"),null,{isDisposable:true,id:this.code()+"-savetoall-confirm",ctx:this}).then((function(){this.saveState(true)}))}},getItem:function(t){var e=new BX.Promise(null,this);var i=this.instances.items.get(t);if(i.data().NO_FIELD_HTML){BX.ajax.runComponentAction("bitrix:tasks.userfield.panel","getFieldHtml",{mode:"class",data:{id:t,entityCode:this.option("entityCode"),entityId:this.option("entityId"),parameters:{INPUT_PREFIX:this.option("inputPrefix"),RELATED_ENTITIES:this.option("relatedEntities")}}}).then(function(t){var s="";if(t.status&&t.status==="success"){s=t.data}else{var n=[];for(var a=0;a<t.errors.length;a++){n.push(t.errors[a].message)}s='<div class="task-message-label error">'+n.join("<br />")+"</div>"}i.setFieldHtml(s);e.fulfill(i)}.bind(this),function(t){var s=[];for(var n=0;n<t.errors.length;n++){s.push(t.errors[n].message)}var a='<div class="task-message-label error">'+s.join("<br />")+"</div>";i.setFieldHtml(a);e.fulfill(i)}.bind(this));i.data().NO_FIELD_HTML=false}else{e.fulfill(i)}return e},unHideField:function(t){var e=BX.data(t,"id");if(BX.type.isNotEmptyString(e)){this.setItemStateDisplay(e,true,true);this.getItem(e).then((function(t){this.instances.items.showItem(t)}))}if(this.instances.unHideMenu){this.instances.unHideMenu.hide()}},showActionPopup:function(t){var e=this.option("user");var i=[{action:"dragToggle",enabled:false,text:BX.message("TASKS_TUFP_DRAG_N_DROP_ON"),onclick:this.passCtx(this.doMenuAction)}];if(e.IS_SUPER){i.unshift({action:"saveToAll",text:BX.message("TASKS_TUFP_SAVE_SCHEME_TO_EVERYONE"),onclick:this.passCtx(this.doMenuAction)})}BX.PopupMenu.show(this.id()+"action",t,i,{angle:true,position:"right",offsetLeft:18,offsetTop:0})},canManage:function(){var t=this.option("restriction");if(!t.MANAGE){if(t.TASK_LIMIT_EXCEEDED){BX.UI.InfoHelper.show("limit_tasks_custom_fields",{isLimit:true,limitAnalyticsLabels:{module:"tasks",source:"taskEdit"}});return false}return true}return true},showAddPopup:function(t){if(!this.canManage()){return}var e=[];var i=this.option("typesToCreate");if(BX.type.isPlainObject(i)){for(var s in i){if(i.hasOwnProperty(s)){e.push({code:s,text:i[s],title:i[s],onclick:this.passCtx(this.openAddForm)})}}}BX.PopupMenu.show(this.id()+"add",t,e,{angle:true,closeByEsc:true,position:"top",offsetLeft:40,offsetTop:5})},showUnHideFieldPopup:function(t){var e="";var i=this.subInstance("items").exportItemData();if(!i.count()){return}i.sort([["STATE.S","asc"]]).each(BX.delegate((function(t){if(!t.STATE.D){e+=this.getHTMLByTemplate("menu-item",{LABEL:t.LABEL,ID:t.ID,LABEL_EXT:t.LABEL+(t.MANDATORY?" ("+BX.message("TASKS_TUFP_FIELD_MANDATORY")+")":""),STAR_INVISIBLE:t.MANDATORY?"":"invisible"})}}),this));this.control("uhmenu").innerHTML=e;if(!this.instances.unHideMenu){this.instances.unHideMenu=new BX.Tasks.Util.ScrollPanePopup({scope:this.control("un-hide-menu"),maxHeight:300,popupParameters:{angle:true,position:"top",offsetLeft:40,offsetTop:5,noAllPaddings:true}});this.instances.unHideMenu.bindDelegateControl("item","click",this.passCtx(this.unHideField))}this.instances.unHideMenu.show(t)}}});BX.Tasks.Component.UserFieldPanel.ItemSet=BX.Tasks.Util.ItemSet.extend({options:{controlBind:"class",preRendered:true,itemAppearFxSpeed:300,itemDisappearFxSpeed:300},methods:{getItemClass:function(){return BX.Tasks.Component.UserFieldPanel.ItemSet.Item},bindItemActions:function(){this.bindDelegateControl("item-hide","click",this.bindOnItem(this.hideItem));this.bindDelegateControl("item-edit","click",this.bindOnItem(this.enterEditItem));this.bindDelegateControl("item-cancel","click",this.bindOnItem(this.leaveEditItem,this.leaveEditItemNew));this.bindDelegateControl("item-save","click",this.bindOnItem(this.saveItem,this.saveItemNew));this.bindDelegateControl("item-label-edit","keypress",this.bindOnItem(this.itemLabelChanged))},hideItem:function(t){var e=new BX.Promise(null,this);this.fireEvent("item-hide",[e,t.value()]);e.then((function(e){if(e=="hide"){t.disappear()}else if(e=="delete"){this.deleteItem(t.value())}}))},showItem:function(t){t.appear()},enterEditItem:function(t){if(this.parent()&&!this.parent().canManage()){return}t.toggleEditMode(true);t.initForm()},leaveEditItem:function(t){t.toggleEditMode(false)},leaveEditItemNew:function(){if(this.instances.newItem){this.instances.newItem.disappear()}},itemLabelChanged:function(t,e){if(BX.Tasks.Util.isEnter(e)){this.saveItem(t);BX.eventReturnFalse(e)}},saveItem:function(t){if(t.isLoading()){return}t.setLoading(true);t.hideErrors();var e=new BX.Promise(null,this);this.fireEvent("item-save",[e,t.value(),t.getFormData()]);e.then((function(e){t.setLoading(false);t.update({LABEL:e.LABEL,MANDATORY:e.MANDATORY!="0"});t.toggleEditMode(false)}),(function(e){t.setLoading(false);t.showErrors(e)}))},saveItemNew:function(){if(this.instances.newItem){var t=this.instances.newItem;if(t.isLoading()){return}t.setLoading(true);t.hideErrors();var e=new BX.Promise(null,this);this.fireEvent("item-save",[e,0,t.getFormData()]);e.then((function(e){t.setLoading(false);t.update({ID:e.ID,FIELD_HTML:e.FIELD_HTML,LABEL:e.LABEL,MULTIPLE:e.MULTIPLE!="0",MANDATORY:e.MANDATORY!="0",STATE:{D:true,S:999999}});t.toggleEditMode(false).then(BX.delegate((function(){this.registerItem(t,{useAppear:false});if(this.parent()){this.parent().registerItem(t)}this.instances.newItem=null}),this))}),(function(e){t.setLoading(false);t.showErrors(e)}))}},openAddForm:function(t){var e=BX.message("TASKS_TUFP_NEW_FIELD_"+t.toUpperCase());if(this.instances.newItem){this.instances.newItem.update({USER_TYPE_ID:t,LABEL:e,DISPLAY:e})}else{this.instances.newItem=this.createItem({VALUE:"new",DISPLAY:e,LABEL:e,USER_TYPE_ID:t,MANDATORY:false,MULTIPLE:false,FIELD_HTML:this.getHTMLByTemplate("item-field-stub"),REQUIRED:"",EDIT:"edit",INVISIBLE:"invisible",DEFACEABLE:"defaceable",DISPLAY_MULTIPLE:"0"});BX.append(this.instances.newItem.scope(),this.control("new-item-place"));this.instances.newItem.toggleEditMode(true,true)}this.instances.newItem.initForm();if(!this.instances.newItem.isShown()){this.instances.newItem.appear()}}}});BX.Tasks.Component.UserFieldPanel.ItemSet.Item=BX.Tasks.Util.ItemSet.Item.extend({options:{controlBind:"class"},methods:{toggleEditMode:function(t,e){this.changeCSSFlag("edit",t);var i=new BX.Promise(null,this);var s=this.control("form-place");if(e){this.changeCSSFlag("invisible",!t,s);i.fulfill()}else{BX.Tasks.Util.fadeSlideToggleByClass(s).then((function(){i.fulfill()}))}if(t){this.initForm()}return i},initForm:function(){var t=this.data();var e=this.control("multiple-edit");this.control("label-edit").value=t.DISPLAY;this.control("required-edit").checked=t.MANDATORY;e.checked=t.MULTIPLE;var i=parseInt(t.VALUE)||t.USER_TYPE_ID=="boolean";e.disabled=i;BX[i?"addClass":"removeClass"](e.parentNode,"disabled");if(t.USER_TYPE_ID=="boolean"){e.checked=false}this.control("label-edit").focus();this.hideErrors()},getFormData:function(){var t=BX.clone(this.data());t.DISPLAY=t.LABEL=this.control("label-edit").value;t.MANDATORY=this.control("required-edit").checked;t.MULTIPLE=this.control("multiple-edit").checked;return t},update:function(t){var e=this.data();if("LABEL"in t){e.LABEL=e.DISPLAY=t.LABEL}if("MANDATORY"in t){e.MANDATORY=t.MANDATORY}if("MULTIPLE"in t){e.MULTIPLE=t.MULTIPLE}if("FIELD_HTML"in t){e.FIELD_HTML=t.FIELD_HTML}if("USER_TYPE_ID"in t){e.USER_TYPE_ID=t.USER_TYPE_ID}if("STATE"in t){e.STATE=t.STATE}if("ID"in t){this.value(t.ID)}this.redraw()},redraw:function(){this.control("label").innerHTML=BX.util.htmlspecialchars(this.data().LABEL);BX[this.data().MANDATORY?"addClass":"removeClass"](this.scope(),"required");this.scope().setAttribute("data-type",this.data().USER_TYPE_ID);this.scope().setAttribute("data-multiple",this.data().MULTIPLE?"1":"0");this.scope().setAttribute("data-item-value",this.data().VALUE);this.setFieldHtml(this.data().FIELD_HTML);delete this.data().FIELD_HTML},value:function(t){if(t){this.data().ID=t}return this.callMethod(BX.Tasks.Util.ItemSet.Item,"value",arguments)},isLoading:function(){return!!this.vars.actionInProgress},setLoading:function(t){this.vars.actionInProgress=t;if(!this.vars.loading){this.vars.loading=BX.Tasks.Util.delay((function(){BX.addClass(this.control("save"),"ui-btn-clock")}),(function(){BX.removeClass(this.control("save"),"ui-btn-clock")}),100,this)}if(t){this.vars.loading.call(this)}else{this.vars.loading.cancel()}},setFieldHtml:function(t){if(!t){return}t=t.replace(new RegExp("/bitrix/js/main/core/images/calendar-icon.gif","g"),"/bitrix/js/tasks/css/images/calendar.png");BX.html(this.control("field-html"),t)},hideErrors:function(){BX.Tasks.Util.hideByClass(this.control("error"))},showErrors:function(t){if(Object.prototype.toString.call(t)==="[object Array]"){var e=[];for(var i=0;i<t.length;i++){e.push(t[i].message)}this.control("error").innerHTML=e.join("<br />");BX.Tasks.Util.showByClass(this.control("error"));return}this.control("error").innerHTML=t.getMessages(true).join("<br />");BX.Tasks.Util.showByClass(this.control("error"))}}});BX.Tasks.Component.UserFieldPanel.ItemSet.Item.prepareData=function(t){t.VALUE=t.ID;t.DISPLAY=t.LABEL;return t}}).call(this);
//# sourceMappingURL=logic.map.js