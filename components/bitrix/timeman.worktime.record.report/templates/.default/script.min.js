(function(){BX.namespace("BX.Timeman.Component.Worktime.Record");BX.Timeman.Component.Worktime.Record.Report=function(e){BX.Timeman.Component.BaseComponent.apply(this,arguments);this.isSlider=e.isSlider;this.isShiftplan=e.isShiftplan;this.useEmployeesTimezone=e.useEmployeesTimezone;this.editWorktimeBtn=this.selectOneByRole("edit-worktime-btn");this.workTimePickerContent=this.selectOneByRole("timeman-time-picker-content");this.saveButton=this.selectOneByRole("tm-record-btn-save");this.cancelBtn=this.selectOneByRole("tm-record-btn-cancel");this.recordForm=this.selectOneByRole("worktime-record-form");this.formEndInput=this.container.querySelector('[name="'+e.endTimeFormHiddenInputName+'"]');this.formStartInput=this.container.querySelector('[name="'+e.startTimeFormHiddenInputName+'"]');this.formBreakInput=this.container.querySelector('[name="'+e.breakLengthTimeFormHiddenInputName+'"]');this.timeEndClockHiddenInput=this.container.querySelector('[name="endTime"]');this.timeStartClockHiddenInput=this.container.querySelector('[name="startTime"]');this.breakLengthClockHiddenInput=this.container.querySelector('[name="breakLength"]');this.startTimeSpan=this.selectOneByRole("start-time");this.endTimeSpan=this.selectOneByRole("end-time");this.breakTimeSpan=this.selectOneByRole("break-time");this.errorsBlock=this.selectOneByRole("timeman-record-report-errors-block");this.errorBlockTemplate=this.selectOneByRole("timeman-error-msg");this.breakTimeContainer=this.selectOneByRole("break-time-container");this.durationTimeSpan=this.selectOneByRole("duration-time");this.edited=false;BX.UI.Hint.init(this.container);this.addEventHandlers()};BX.Timeman.Component.Worktime.Record.Report.prototype={__proto__:BX.Timeman.Component.BaseComponent.prototype,constructor:BX.Timeman.Component.Worktime.Record.Report,addEventHandlers:function(){BX.bind(this.editWorktimeBtn,"click",BX.delegate(this.onEditWorktimeClick,this));BX.bind(this.saveButton,"click",BX.delegate(this.onSaveClick,this));BX.bind(this.cancelBtn,"click",BX.delegate(this.closeSlider,this));BX.bind(document,"keydown",BX.proxy(this.onKeyDown,this));var e=this.selectAllByRole("navigation-record",document);for(var t=0;t<e.length;t++){BX.bind(e[t],"click",BX.delegate(this.onRecordNavigationClick,this))}var i=this.selectAllByRole("show-more",document);for(var t=0;t<i.length;t++){BX.bind(i[t],"click",BX.delegate(this.onShowMoreActivityClick,this))}},onShowMoreActivityClick:function(e){if(!(e.currentTarget.dataset&&e.currentTarget.dataset.showId)){return}var t=this.selectAllByRole(e.currentTarget.dataset.showId);if(e.currentTarget.dataExpanded){e.currentTarget.innerText=e.currentTarget.dataOldTitle;for(var i=0;i<t.length;i++){this.hideElement(t[i])}}else{for(var i=0;i<t.length;i++){this.showElement(t[i])}if(!e.currentTarget.dataOldTitle){e.currentTarget.dataOldTitle=e.currentTarget.innerText}e.currentTarget.innerText=BX.util.htmlspecialchars(BX.message("TM_RECORD_REPORT_ROLL_UP_TITLE"))}e.currentTarget.dataExpanded=!e.currentTarget.dataExpanded},onRecordNavigationClick:function(e){event.stopPropagation();event.preventDefault();if(e.currentTarget.dataset.url){document.location.href=e.currentTarget.dataset.url}},onKeyDown:function(e){if(e.keyCode===27){this.closeSlider()}},onEditWorktimeClick:function(e){if(!this._workTimePickerPopup){this._workTimePickerPopup=this.buildWorkTimePopup(e);this._workTimePickerPopup.setContent(this.workTimePickerContent)}this._workTimePickerPopup.show()},onSaveClick:function(e){e.stopPropagation();e.preventDefault();this.clearErrors();if(e.currentTarget.dataset&&e.currentTarget.dataset.action==="save"&&!this.edited){return}if(this.saving===true){return}this.saving=true;this.saveButton.classList.add("ui-btn-wait");var t=new FormData(this.recordForm);t.append("isShiftplan",this.isShiftplan);t.append("useEmployeesTimezone",this.useEmployeesTimezone);BX.ajax.runAction("timeman.worktime.approveRecord",{data:t}).then(function(e){this.saving=false;if(this.isSlider){if(this.getSlider()){this.getSlider().postMessageAll(window,"BX.Timeman.Record.Approve::Success",{record:e.data.record})}this.closeSlider()}else{BX.reload()}}.bind(this),function(e){this.saving=false;this.saveButton.classList.remove("ui-btn-wait");this.showErrors(e.errors)}.bind(this))},getSlider:function(){if(window.top.BX.SidePanel&&window.top.BX.SidePanel.Instance){return window.top.BX.SidePanel.Instance}return null},clearErrors:function(){if(this.errorsBlock.childNodes){for(var e=0;e<this.errorsBlock.childNodes.length;e++){this.errorsBlock.removeChild(this.errorsBlock.childNodes[e])}}},showErrors:function(e){for(var t=0;t<e.length;t++){var i=this.errorBlockTemplate.cloneNode(true);this.showElement(i);i.textContent=e[t].message;this.errorsBlock.appendChild(i)}},closeSlider:function(){if(this.isSlider&&window.top.BX.SidePanel&&window.top.BX.SidePanel.Instance){var e=window.top.BX.SidePanel.Instance.getTopSlider();if(e){e.close()}}},onRecordedTimeUpdated:function(){this.startTimeSpan.textContent=this.timeStartClockHiddenInput.value;this.formStartInput.value=this.timeStartClockHiddenInput.value;this.endTimeSpan.textContent=this.timeEndClockHiddenInput.value;this.formEndInput.value=this.timeEndClockHiddenInput.value;if(this.convertFormattedTimeToSecs(this.breakLengthClockHiddenInput.value)>0){this.showElement(this.breakTimeContainer)}this.breakTimeSpan.textContent=this.breakLengthClockHiddenInput.value;this.formBreakInput.value=this.breakLengthClockHiddenInput.value;this.durationTimeSpan.textContent=this.selectOneByRole("timeman-work-time-start-end-delta",this.workTimePickerContent).textContent},buildWorkTimePopup:function(e){return new BX.PopupWindow({bindElement:e.currentTarget,titleBar:BX.message("TIMEMAN_POPUP_WORK_TIME_TITLE"),autoHide:false,closeIcon:true,closeByEsc:true,angle:true,contentColor:"white",contentNoPaddings:true,buttons:[new BX.PopupWindowButton({text:BX.message("TIMEMAN_BTN_SAVE_TITLE"),className:"popup-window-button-accept",events:{click:BX.delegate(function(){this.edited=true;this.saveButton.classList.remove("ui-btn-disabled");this._workTimePickerPopup.close();this.onRecordedTimeUpdated()},this)}}),new BX.PopupWindowButton({text:BX.message("TIMEMAN_BTN_CANCEL_TITLE"),events:{click:BX.delegate(function(){this._workTimePickerPopup.close()},this)}})]})},convertFormattedTimeToSecs:function(e){var t=e.split(/[\s:]+/);if(t.length===3){var i=t[2];if(i==="pm"&&t[0]<12){t[0]=parseInt(t[0],10)+12}if(i==="am"&&t[0]===12){t[0]=0}}return parseInt(t[0],10)*3600+parseInt(t[1],10)*60}}})();
//# sourceMappingURL=script.map.js