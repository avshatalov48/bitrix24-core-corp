BX.namespace("BX.Crm.Widget.Custom.SaleTarget");BX.Crm.Widget.Custom.SaleTarget.ConfigPopup=function(e){"use strict";var t=e.Crm.Widget.Custom.SaleTarget.Template;var i=e.Crm.Widget.Custom.SaleTarget.Period;var o=e.Crm.Widget.Custom.SaleTarget.Target;var n=e.Crm.Widget.Custom.SaleTarget.Label;var r=e.Crm.Widget.Custom.SaleTarget.UserSelector;var s=function(e){this.id="saletarget-selector-"+Math.random();this.controlNode=e.controlNode;this.displayNode=e.displayNode;this.parentPopup=e.parentPopup;this.menuPopup=null;this.listeners=e.events||{};this.values=e.values||[];this.createInput(e);if(e.value){this.setValue(e.value,true)}this.bind()};s.prototype={createInput:function(t){this.input=null;if(t.form&&t.name){this.input=e.create("input",{attrs:{type:"hidden",name:t.name}});t.form.appendChild(this.input)}},bind:function(){e.bind(this.controlNode,"click",this.onControlClick.bind(this));if(this.parentPopup){e.addCustomEvent(this.parentPopup,"onPopupClose",this.onParentPopupClose.bind(this))}},onControlClick:function(){var t=this,i,o=[];for(i=0;i<this.values.length;++i){o.push({text:this.values[i]["name"],valueId:this.values[i]["id"],onclick:function(e,i){this.popupWindow.close();t.setValue(i.valueId)}})}e.PopupMenu.show(this.id,this.controlNode,o,{autoHide:true,offsetLeft:40,angle:{position:"top"}});this.menuPopup=e.PopupMenu.currentItem},setValues:function(e){this.values=e;return this},getValueById:function(e){var t=null;for(var i=0;i<this.values.length;++i){if(this.values[i]["id"]===e){t=this.values[i];break}}return t},setValue:function(e,t){if(this.value!==e){var i=this.value;var o=this.getValueById(e);if(o!==null){if(t||this.fire("beforeChange",[e,i])){this.value=e;this.displayNode.textContent=o["shortName"]||o["name"];if(this.input){this.input.value=e}if(!t){this.fire("change",[e,i])}}}}return this},getValue:function(){return this.value},onParentPopupClose:function(){if(this.menuPopup){this.menuPopup.close();this.menuPopup.destroy();this.menuPopup=null}},show:function(){e.show(this.controlNode);return this},hide:function(){e.hide(this.controlNode);return this},fire:function(e,t){var i=true;if(this.listeners&&this.listeners[e]){if(this.listeners[e].apply(this,t)===false){i=false}}return i}};var a=function(t){this.isDirty=false;this.type=t.type;this.period=e.type.isPlainObject(t.period)?new i(t.period):t.period;this.target=t.target;this.users=e.type.isArray(t.users)?t.users:[]};a.prototype={dirty:function(){this.isDirty=true},getId:function(){return new i(this.period).getId()},setType:function(e){if(this.type!==e){this.type=e;this.clearGoal();this.dirty()}},setTargetType:function(e){if(this.target.type!==e){this.target.type=e;this.dirty()}},setGoal:function(t,i){if(typeof i==="undefined"&&e.type.isPlainObject(t)){this.target.goal=e.clone(t);this.dirty();return this}i=parseInt(i);if(isNaN(i)||i<0)i=0;if(this.target.goal[t]!==i){this.target.goal[t]=i;this.dirty()}return this},getGoal:function(e){var t=parseInt(this.target.goal[e]);return t>0?t:0},clearGoal:function(t){if(typeof t==="undefined"){this.target.goal={};this.dirty()}else if(e.type.isPlainObject(this.target.goal)){delete this.target.goal[t];this.dirty()}return this},addUser:function(e){this.users.push(e);if(this.type==="USER"){this.setGoal(e.id,0)}return this},removeUser:function(e){for(var t=0;t<this.users.length;++t){if(this.users[t]["id"]===e){if(this.type==="USER"){this.clearGoal(this.users[t]["id"])}this.users.splice(t,1);break}}},serialize:function(){return{type:this.type,period_type:this.period.type,period_year:this.period.year,period_half:this.period.half,period_quarter:this.period.quarter,period_month:this.period.month,target_type:this.target.type,target_goal:this.target.goal}}};var u=function(t,o,n){this.id="saletarget-config-popup-"+e.util.getRandomString(7);this.widget=t;if(o.configuration.id>0){this.initConfigurationPeriod=new i(o.configuration.period)}else{this.initConfigurationPeriod=new i({type:i.Type.Month,year:(new Date).getFullYear(),month:(new Date).getMonth()+1}).next()}this.configurations=[];this.users=[];this.categories=n.categories||[]};u.prototype={loadData:function(t){if(this.loading){return}if(this.loaded){if(t)t();return}this.loading=true;var i=this;e.ajax({url:this.ajaxUrl||"/bitrix/components/bitrix/crm.widget.custom.saletarget/ajax.php",method:"POST",dataType:"json",data:{sessid:e.bitrix_sessid(),site:e.message("SITE_ID"),action:"GET_CONFIGURATIONS"},onsuccess:function(e){i.loading=false;if(e.success){i.loaded=true;i.users=e.users;i.setConfigurations(e.configurations);i.setCurrentConfiguration(i.initConfigurationPeriod);if(t)t()}else{i.showAccessDeniedDialog(e)}},onfailure:function(){i.loading=false;window.alert(e.message("CRM_WIDGET_SALETARGET_CONFIG_DENIED"))}})},showAccessDeniedDialog:function(t){if(t.admins.length>0&&e.getClass("BX.Intranet.NotifyDialog")){var i=this.ajaxUrl||"/bitrix/components/bitrix/crm.widget.custom.saletarget/ajax.php";i=e.util.add_url_param(i,{action:"notify_admin",site:e.message("SITE_ID")});var o=new e.Intranet.NotifyDialog({listUserData:t.admins,notificationHandlerUrl:i,popupTexts:{title:e.message("CRM_WIDGET_SALETARGET_CONFIG_DENIED_TITLE"),header:e.message("CRM_WIDGET_SALETARGET_CONFIG_DENIED_HEADER"),description:e.message("CRM_WIDGET_SALETARGET_CONFIG_DENIED_DESCRIPTION"),sendButton:e.message("CRM_WIDGET_SALETARGET_CONFIG_DENIED_NOTIFY")}});o.show();return}window.alert(e.message("CRM_WIDGET_SALETARGET_CONFIG_DENIED"))},setConfigurations:function(e){for(var t=0;t<e.length;++t){this.configurations.push(new a(e[t]))}},setCurrentConfiguration:function(e){var t=this.findConfiguration(e);if(!t){var i=this.findPreviousConfiguration(e);t=new a({type:"USER",period:e,target:{type:o.Type.Sum,goal:{}},users:i&&i.users.length?i.users:[]});this.configurations.push(t)}this.configuration=t},findConfiguration:function(e){var t=e.getId();for(var i=0;i<this.configurations.length;++i){if(this.configurations[i].getId()===t){return this.configurations[i]}}return null},findPreviousConfiguration:function(e){var t=e.type,i=e.getLeftBorder(),o=0,n=null;for(var r=0;r<this.configurations.length;++r){if(this.configurations[r].period.type!==t)continue;var s=this.configurations[r].period.getLeftBorder();if(s>=i)continue;if(s>o){o=s;n=this.configurations[r]}}return n},show:function(){this.loadData(this.showPopup.bind(this))},showPopup:function(){var n=this;var r=new t("widget-saletarget-config");this.template=r;var a=function(){return this.saveConfigurations().then(function(e){if(e.success){n.widget.onAfterConfigSave()}else if(e.errors){window.alert(e.errors[0])}return e},function(e){if(e.errors){window.alert(e.errors[0])}return e})}.bind(this);var u=new e.PopupWindow("crm-start-config",null,{closeIcon:true,draggable:true,titleBar:e.message("CRM_WIDGET_SALETARGET_CONFIG_TITLE"),closeByEsc:true,content:r.get(),width:530,buttons:[new e.PopupWindowCustomButton({className:"webform-small-button webform-small-button-accept",text:e.message("JS_CORE_WINDOW_SAVE"),events:{click:function(){var t=this.popupWindow,i=this.buttonNode;e.addClass(i,"webform-small-button-wait");a().then(function(o){if(o.success){t.close()}e.removeClass(i,"webform-small-button-wait")},function(){e.removeClass(i,"webform-small-button-wait")})}}}),new e.PopupWindowButtonLink({className:"popup-window-button-link-cancel",text:e.message("JS_CORE_WINDOW_CANCEL"),events:{click:function(){this.popupWindow.close()}}})],events:{onPopupClose:function(e){e.destroy()}}});var l=true;this.periodTypeSelector=new s({controlNode:r.get("period-type"),displayNode:r.get("period-type"),parentPopup:u,values:i.getTypeList(),events:{beforeChange:function(t){if(l&&n.configuration.period.type!==t&&n.configurations.length>1){if(!window.confirm(e.message("CRM_WIDGET_SALETARGET_CONFIG_PERIOD_CHANGE_CONFIRMATION"))){return false}l=false}n.onPeriodTypeChange(t)},change:this.onAfterPeriodChange.bind(this)},value:this.configuration.period.type});this.periodYearSelector=new s({controlNode:r.get("period-year"),displayNode:r.get("period-year-value"),parentPopup:u,values:i.getYearList(),value:parseInt(this.configuration.period.year),events:{change:this.onAfterPeriodChange.bind(this)}});this.periodHalfSelector=new s({controlNode:r.get("period-half"),displayNode:r.get("period-half-value"),parentPopup:u,values:i.getHalfList(),value:parseInt(this.configuration.period.half)||1,events:{change:this.onAfterPeriodChange.bind(this)}});this.periodQuarterSelector=new s({controlNode:r.get("period-quarter"),displayNode:r.get("period-quarter-value"),parentPopup:u,values:i.getQuarterList(),value:parseInt(this.configuration.period.quarter)||1,events:{change:this.onAfterPeriodChange.bind(this)}});this.periodMonthSelector=new s({controlNode:r.get("period-month"),displayNode:r.get("period-month-value"),parentPopup:u,values:i.getMonthList(),value:parseInt(this.configuration.period.month)||1,events:{change:this.onAfterPeriodChange.bind(this)}});this.targetTypeSelector=new s({controlNode:r.get("target-type"),displayNode:r.get("target-type-value"),parentPopup:u,values:o.getTypeList(),value:this.configuration.target.type,events:{change:function(e){n.configuration.setTargetType(e)}}});this.viewTypeSelector=new s({controlNode:r.get("view-type"),displayNode:r.get("view-type-value"),parentPopup:u,values:[{id:"USER",name:e.message("CRM_WIDGET_SALETARGET_CONFIG_VIEW_TYPE_USER")},{id:"CATEGORY",name:e.message("CRM_WIDGET_SALETARGET_CONFIG_VIEW_TYPE_CATEGORY")},{id:"COMPANY",name:e.message("CRM_WIDGET_SALETARGET_CONFIG_VIEW_TYPE_COMPANY")}],events:{change:function(e){n.configuration.setType(e);n.refreshConfigurationView()}}});this.onPeriodTypeChange(this.configuration.period.type);this.viewTypeSelector.setValue(this.configuration.type);var h=r.get("copy-configuration");e.bind(h,"click",this.onCopyConfiguration.bind(this));this.configPopup=u;this.configTemplate=r;u.show();return true},onPeriodTypeChange:function(e){switch(e){case i.Type.Year:this.periodHalfSelector.hide();this.periodQuarterSelector.hide();this.periodMonthSelector.hide();break;case i.Type.Half:this.periodHalfSelector.show();this.periodQuarterSelector.hide();this.periodMonthSelector.hide();break;case i.Type.Quarter:this.periodHalfSelector.hide();this.periodQuarterSelector.show();this.periodMonthSelector.hide();break;case i.Type.Month:this.periodHalfSelector.hide();this.periodQuarterSelector.hide();this.periodMonthSelector.show();break}},refreshConfigViewType:function(t){var i=this.template.get("view-type-content");i.innerHTML="";var o;if(t==="COMPANY"){o=this.getConfigCompanyTemplate()}else if(t==="CATEGORY"){o=this.getConfigCategoryTemplate()}else if(t==="USER"){o=this.getConfigUserTemplate()}i.appendChild(o.get());e[t==="CATEGORY"?"show":"hide"](this.template.get("categories-link"))},onAfterPeriodChange:function(){var e=new i({type:this.periodTypeSelector.getValue(),year:this.periodYearSelector.getValue(),half:this.periodHalfSelector.getValue(),quarter:this.periodQuarterSelector.getValue(),month:this.periodMonthSelector.getValue()});this.setCurrentConfiguration(e);this.refreshConfigurationView();var t=this.template.get("copy-configuration");t.textContent=" ";var o=this.findPreviousConfiguration(e);if(o){t.textContent=n.copyPeriod(e.type)}},refreshConfigurationView:function(){this.targetTypeSelector.setValue(this.configuration.target.type);this.viewTypeSelector.setValue(this.configuration.type,true);this.refreshConfigViewType(this.configuration.type)},onCopyConfiguration:function(){var e=this.findPreviousConfiguration(this.configuration.period);if(e){this.configuration.setType(e.type);this.configuration.setTargetType(e.target.type);this.configuration.setGoal(e.target.goal);if(e.type==="USER"){this.configuration.users=e.users}this.refreshConfigurationView()}},getConfigCompanyTemplate:function(){var e=new t("widget-saletarget-config-company");var i=this.configuration.getGoal("COMPANY");this.decorateGoalInput(e.get("company-target"),"COMPANY",i);return e},getConfigCategoryTemplate:function(){var e=this,i=new t("widget-saletarget-config-category");i.loop("categories",this.categories,function(t,i){t.get("category-name").textContent=i.name;var o=e.configuration.getGoal(i.id);e.decorateGoalInput(t.get("category-target"),i.id,o)});return i},getConfigUserTemplate:function(){var i=this,o=new t("widget-saletarget-config-user");var n=this.configuration.users;if(!n.length&&this.users.length>0){n=this.users}o.loop("users",n,function(t,o,n){var r=i.configuration.getGoal(o.id);t.get("user-name").textContent=o.name;t.get("user-title").textContent=o.title;if(o.photo){t.get("user-photo").style.background='url("'+o.photo+'")'}if(!o.active){e.addClass(t.get(),t.get().getAttribute("data-inactive-class"))}i.decorateGoalInput(t.get("user-target"),o.id,r);e.bind(t.get("user-remove"),"click",function(){i.configuration.removeUser(o.id);e.addClass(t.get(),t.get().getAttribute("data-remove-class"));setTimeout(function(){e.remove(t.get())},250)});if(n){var s=t.get();e.addClass(s,s.getAttribute("data-new-class"))}});new r({bindTo:o.get("user-add"),selected:n,addCallback:function(e){for(var t=0;t<n.length;++t){if(parseInt(n[t]["id"])===e["id"]){return}}i.configuration.addUser(e);o.loopAppend("users",e)},parentPopup:this.configPopup});return o},decorateGoalInput:function(t,i,o){t.setAttribute("name","target_goal["+i+"]");t.value=o>0?n.number(o):"";e.bind(t,"bxchange",this.onGoalInputChange.bind(this,t,i))},onGoalInputChange:function(e,t){var i=parseInt(e.value.replace(/[^0-9]+/g,""));if(isNaN(i)||i<0)i=0;e.value=i>0?n.number(i):"";this.configuration.setGoal(t,i)},saveConfigurations:function(){var t=[];for(var i=0;i<this.configurations.length;++i){if(this.configurations[i].isDirty){t.push(this.configurations[i].serialize())}}var o=new e.Promise;if(!t.length){o.fulfill({success:true});return o}e.ajax({url:this.ajaxUrl||"/bitrix/components/bitrix/crm.widget.custom.saletarget/ajax.php",method:"POST",dataType:"json",data:{sessid:e.bitrix_sessid(),site:e.message("SITE_ID"),action:"save_configurations",configurations:t,period_type:this.periodTypeSelector.getValue()},onsuccess:function(e){o.fulfill(e)},onfailure:function(){o.fulfill({success:false,errors:[e.message("CRM_WIDGET_SALETARGET_CONFIG_SAVE_ERROR")]})}});return o}};return u}(window.BX||window.top.BX);
//# sourceMappingURL=config_popup.map.js