BX.namespace("BX.Tasks.Grid");BX.Tasks.GridActions={gridId:null,groupSelector:null,registeredTimerNodes:{},defaultPresetId:"",getTotalCountProceed:false,currentGroupAction:null,checkCanMove:function(){return!BX.Tasks.GridInstance||BX.Tasks.GridInstance.checkCanMove()},initPopupBalloon:function(t,e,i){this.groupSelector=null;BX.bind(BX(e+"_control"),"click",BX.delegate((function(){if(!this.groupSelector){this.groupSelector=new BX.Tasks.Integration.Socialnetwork.NetworkSelector({scope:BX(e+"_control"),id:"group-selector-"+this.gridId,mode:t,query:false,useSearch:true,useAdd:false,parent:this,popupOffsetTop:5,popupOffsetLeft:40});this.groupSelector.bindEvent("item-selected",BX.delegate((function(t){BX(e+"_control").value=BX.util.htmlspecialcharsback(t.nameFormatted)||"";BX(i+"_control").value=t.id||"";this.groupSelector.close()}),this))}this.groupSelector.open()}),this))},onTagUpdateClick:function(t,e,i){var s=function(e){var i=e.getData().id;if(Number(i)===Number(t)){var s=BX.Main.gridManager.getById(this.gridId).instance.getRows().getById(i);var r=s.getCellById("TAG").querySelector(".main-grid-tag-add");p.setTargetNode(r)}};var r=function(e){var i=e.getData().id;if(Number(i)===Number(t)){p.hide()}};var a=false;var n=function(e){const i=e.getTarget();const s=e.getData().item;s.setSort(1);i.getTab("all").getRootNode().addItem(s);if(a){i.clearSearch();BX.Tasks.GridActions.reloadRow(t);a=false;u();return}var r=i.getSelectedItems().map((function(t){return t.getTitle()}));u();BX.Tasks.GridActions.action("setTags",t,{tags:r})};var o=function(t){var e=t.getTarget();var i=t.getData().query;if(i.trim()!==""){d()}else{u()}};var d=function(){p.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=false;p.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=false};var u=function(){p.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=true;p.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=true};var l=function(t,e){if(p.getContainer().querySelector(`div.${t}`)){return}var i=document.createElement("div");i.className=t;i.innerHTML=`\n\t\t\t\t<div class='ui-alert ui-alert-xs ui-alert-danger'  \n\t\t\t\t\t<span class='ui-alert-message'>\n\t\t\t\t\t\t${e}\n\t\t\t\t\t</span> \n\t\t\t\t</div>\n\t\t\t`;p.getFooterContainer().before(i)};var c=function(){var e=["click","keydown"];var i=function(e){if(e.type==="keydown"){if(!((e.ctrlKey||e.metaKey)&&e.keyCode===13)){return}}var i=p.getSelectedItems().map((function(t){return t.getTitle()}));var s=p.getTagSelectorQuery();if(s.trim()===""){return}BX.ajax.runComponentAction("bitrix:tasks.task","setTags",{mode:"class",data:{taskId:t,tags:i,newTag:s}}).then((function(t){if(t.data.success){a=true;const e=p.addItem({id:s,entityId:"task-tag",title:s,sort:1,badges:[{title:t.data.owner}]});p.getTab("all").getRootNode().addItem(e);e.select()}else{const e="tasks-list-tag-already-exists-alert";l(e,t.data.error);const i=function(){const t=p.getContainer().querySelector(`div.${e}`);t&&t.remove()};setTimeout(i,2e3)}}))};e.forEach((function(t){if(t==="click"){p.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").addEventListener(t,i)}else{p.getContainer().addEventListener(t,i)}}))};var h=i.getData();if(BX.Tasks.GridActions.tagsAreConverting){var f=new top.BX.UI.Dialogs.MessageBox({title:BX.message("TASKS_TASK_LIST_TAGS_ARE_CONVERTING_TITLE"),message:BX.message("TASKS_TASK_LIST_TAGS_ARE_CONVERTING_TEXT"),buttons:top.BX.UI.Dialogs.MessageBoxButtons.OK,okCaption:BX.message("TASKS_TASK_LIST_TAGS_ARE_CONVERTING_COME_BACK_LATER"),onOk:function(){f.close()}});f.show();return}var g=function(){var t=document.querySelectorAll("td.main-grid-cell.main-grid-cell-left");var e=h.button;t.forEach((function(t){if(t.contains(e)){e=t}}));return e};var p=new BX.UI.EntitySelector.Dialog({id:"tasks-task-list-tag-widget",targetNode:g(),enableSearch:true,width:350,height:400,multiple:true,dropdownMode:true,compactView:true,entities:[{id:"task-tag",options:{taskId:t,groupId:e}}],searchOptions:{allowCreateItem:false},footer:BX.Tasks.EntitySelector.Footer,footerOptions:{userId:BX.Tasks.GridInstance.userId,taskId:t,groupId:e},clearUnavailableItems:true,events:{onLoad:function(){p.getFooterContainer().style.zIndex=1;BX.addCustomEvent("Tasks.Tasks.Grid:RowRemove",BX.proxy(r,this));c()}.bind(this),onHide:function(){BX.removeCustomEvent("Tasks.Tasks.Grid:RowRemove",BX.proxy(r,this))}.bind(this),onSearch:function(t){o(t)}.bind(this),"Item:onSelect":function(t){n(t)}.bind(this),"Item:onDeselect":function(t){n(t)}.bind(this)}});p.show()},onProjectAddClick:function(t,e){var i=new BX.UI.EntitySelector.Dialog({targetNode:e,enableSearch:true,context:"TASKS_PROJECT",entities:[{id:"project"}],events:{"Item:onSelect":function(e){var i=e.getData().item;BX.Tasks.GridActions.action("setGroup",t,{groupId:i.getId()});e.getTarget().hide()}}});i.show()},toggleFilter:function(t,e,i){var s=BX.Main.filterManager.getById(this.gridId);if(!s){console.log("BX.Main.filterManager not initialised");return}if(e){this.reduceFilter(s,t,i)}else{this.extendFilter(s,t,i)}},extendFilter:function(t,e,i){if(i){e=this.extendCurrentFieldsValues(t,e)}t.getApi().extendFilter(e)},reduceFilter:function(t,e,i){var s=!i;if(i){e=this.reduceCurrentFieldsValues(t,e);Object.values(e).forEach((function(t){if(BX.Type.isArray(t)&&t.length<=0){s=true}}))}if(!s){t.getApi().extendFilter(e);return}var r=t.getFilterFields();Object.keys(e).forEach((function(e){r.forEach((function(i){if(i.getAttribute("data-name")===e){t.getFields().deleteField(i)}}))}));t.getSearch().apply()},extendCurrentFieldsValues:function(t,e){var i=e;var s=t.getFilterFieldsValues();Object.entries(e).forEach((function([t,e]){var r=s[t];if(BX.Type.isArray(r)&&BX.Type.isArray(e)){e.forEach((function(e){if(!r.includes(e)){r.push(e);i[t]=r}}))}}));return i},reduceCurrentFieldsValues:function(t,e){var i=e;var s=t.getFilterFieldsValues();Object.entries(e).forEach((function([t,e]){var r=s[t];if(BX.Type.isArray(r)&&BX.Type.isArray(e)){e.forEach((function(e){if(r.includes(e)){r.splice(r.indexOf(e),1);i[t]=r}}))}}));return i},filter:function(t){var e=BX.Main.filterManager.getById(this.gridId);if(!e){console.log("BX.Main.filterManager not initialised");return}var i=e.getFilterFieldsValues();var s=e.getApi();Object.keys(t).forEach((function(e){i[e]=t[e]}));s.setFields(i);s.apply()},changePin:function(t,e,i){var s=i.getData();var r=s.button;if(BX.Dom.hasClass(r,BX.Grid.CellActionState.ACTIVE)){BX.Tasks.GridActions.action("unpin",t,{groupId:e});BX.Dom.removeClass(r,BX.Grid.CellActionState.ACTIVE);BX.Dom.addClass(r,BX.Grid.CellActionState.SHOW_BY_HOVER)}else{BX.Tasks.GridActions.action("pin",t,{groupId:e});BX.Dom.addClass(r,BX.Grid.CellActionState.ACTIVE);BX.Dom.removeClass(r,BX.Grid.CellActionState.SHOW_BY_HOVER)}},changeMute:function(t,e){var i=e.getData();var s=i.button;if(BX.Dom.hasClass(s,BX.Grid.CellActionState.ACTIVE)){BX.Tasks.GridActions.action("unmute",t);BX.Dom.removeClass(s,BX.Grid.CellActionState.ACTIVE);BX.Dom.addClass(s,BX.Grid.CellActionState.SHOW_BY_HOVER)}else{BX.Tasks.GridActions.action("mute",t);BX.Dom.addClass(s,BX.Grid.CellActionState.ACTIVE);BX.Dom.removeClass(s,BX.Grid.CellActionState.SHOW_BY_HOVER)}},action:function(t,e,i){if(t==="add2Timeman"){if(BX.addTaskToPlanner){BX.addTaskToPlanner(e)}else if(window.top.BX.addTaskToPlanner){window.top.BX.addTaskToPlanner(e)}}else if(t==="copyLink"){if(BX.clipboard.copy(i.copyLink)){BX.UI.Notification.Center.notify({content:BX.message("TASKS_LIST_ACTION_COPY_LINK_NOTIFICATION")})}}else if(t==="complete"||t==="renew"){BX.ajax.runAction("bitrix:tasks.scrum.task.isScrumTask",{mode:"class",data:{taskId:e}}).then(function(s){if(s.data===true){this.doScrumAction(t,e,i)}else{this.doAction(t,e,i)}}.bind(this))}else{this.doAction(t,e,i)}},doAction:function(t,e,i){i=i||{};i["taskId"]=e;var s="bitrix:tasks.task";if(t==="pin"||t==="unpin"){s="bitrix:tasks.task.list"}if(t==="ping"){BX.UI.Notification.Center.notify({content:BX.message("TASKS_LIST_ACTION_PING_NOTIFICATION")})}return BX.ajax.runComponentAction(s,t,{mode:"class",data:i}).then(function(i){if(t==="delete"){BX.Tasks.Util.fireGlobalTaskEvent("DELETE",{ID:e});BX.UI.Notification.Center.notify({content:BX.message("TASKS_DELETE_SUCCESS")})}if(!this.gridId){window.location.href=window.location.href;return false}if(!this.checkCanMove()){this.reloadRow(e)}return true}.bind(this)).catch(function(t){if(t.errors){var e=t.errors[0].message||t.errors[0].MESSAGE;BX.UI.Notification.Center.notify({content:e})}}.bind(this))},doScrumAction(t,e,i){var s=new BX.Promise;var r=null;var a=false;top.BX.loadExt("tasks.scrum.task-status").then(function(){if(!BX.type.isUndefined(top.BX.Tasks.Scrum)&&!BX.type.isUndefined(top.BX.Tasks.Scrum.TaskStatus)){r=new top.BX.Tasks.Scrum.TaskStatus({taskId:e,action:t,performActionOnParentTask:true});r.updateState().then(function(){r.isParentScrumTask().then(function(i){a=i;if(a){s.fulfill()}else{if(t==="complete"){return r.showDod(e).then(function(){s.fulfill()}.bind(this)).catch(function(){s.reject()}.bind(this))}else{s.fulfill()}}}.bind(this))}.bind(this))}else{s.fulfill()}}.bind(this));s.then(function(){this.doAction(t,e,i).then(function(){if(r&&a){r.update()}}.bind(this))}.bind(this))},getTotalCount:function(t,e,i,s){if(this.getTotalCountProceed){return}this.getTotalCountProceed=true;var r=document.getElementById(t+"_row_count_wrapper");this.showCountLoader(r);BX.ajax.runComponentAction("bitrix:tasks.task.list","getTotalCount",{mode:"class",data:{userId:e,groupId:i,parameters:JSON.stringify(s)}}).then(function(t){this.hideCountLoader(r);if(t.data){t.data=typeof t.data=="number"?t.data:0;var e=r.querySelector("a");if(e){e.remove()}r.append(t.data)}this.getTotalCountProceed=false}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors)}this.getTotalCountProceed=false}.bind(this))},showCountLoader:function(t){var e=t.querySelector("a");if(e){e.style.display="none"}var i=t.querySelector(".tasks-circle-loader-circular");if(i){i.style.display="inline"}},hideCountLoader:function(t){var e=t.querySelector(".tasks-circle-loader-circular");if(e){e.style.display="none"}},reloadRow:function(t){var e=BX.Main.gridManager.getById(this.gridId);if(e&&e.hasOwnProperty("instance")){e.instance.updateRow(t.toString())}},reloadGrid:function(){if(BX.SidePanel&&BX.SidePanel.Instance&&BX.SidePanel.Instance.getLastOpenSlider()){BX.SidePanel.Instance.destroy(BX.SidePanel.Instance.getLastOpenSlider().getUrl())}var t=BX.Main.filterManager.getById(this.gridId);if(!t){console.log("BX.Main.filterManager not initialised");return}t.getSearch().apply()},setCurrentGroupAction:function(t){this.currentGroupAction=t},processBeforeGroupActionSent:function(){if(this.currentGroupAction==="ping"){BX.UI.Notification.Center.notify({content:BX.message("TASKS_LIST_GROUP_ACTION_PING_NOTIFICATION")})}this.currentGroupAction=null},confirmGroupAction:function(t){BX.Tasks.confirm(BX.message("TASKS_CONFIRM_GROUP_ACTION")).then(function(){this.processBeforeGroupActionSent();BX.Main.gridManager.getById(t).instance.sendSelected()}.bind(this))},onDeadlineChangeClick:function(t,e,i,s){i=i||(new Date).getDate();e=e||s.getData().button;var r=BX.calendar({node:e,value:i,form:"",bTime:true,currentTime:Math.round(new Date/1e3)-(new Date).getTimezoneOffset()*60,bHideTimebar:true,bCompatibility:true,bCategoryTimeVisibilityOption:"tasks.bx.calendar.deadline",bTimeVisibility:BX.Tasks.GridInstance?BX.Tasks.GridInstance.calendarSettings.deadlineTimeVisibility==="Y":false,callback_after:function(t,e){return function(i){var s=new Date;if(i.getTime()>s.getTime()){BX.onCustomEvent("Tasks.Tour.ExpiredTasksDeadlineChange:saveDeadline",[])}var r=BX.CJSTask.ajaxUrl;BX.CJSTask.ajaxUrl=BX.CJSTask.ajaxUrl+"&_CODE=CHANGE_DEADLINE&viewType=VIEW_MODE_LIST";BX.CJSTask.batchOperations([{operation:"CTaskItem::update()",taskData:{ID:e,DEADLINE:BX.calendar.ValueToString(i,true)}}],{callbackOnSuccess:function(t,e,i){return function(t){}}(t,e,i)});BX.CJSTask.ajaxUrl=r;if(!BX.Tasks.GridActions.checkCanMove()){BX.Tasks.GridActions.reloadRow(e)}}}(e,t)});var a=BX.Tasks.TourGuideController.getGuide();if(a&&a.setCalendarPopup&&a.isCorrectRow(t)&&!a.getIsStopped()){a.setCalendarPopup(r.popup)}},onMarkChangeClick:function(t,e,i){BX.TaskGradePopup.show(t,e,i,{events:{onPopupClose:this.__onGradePopupClose,onPopupChange:this.__onGradePopupChange}});BX.addClass(e,"task-grade-and-report-selected");return false},__onGradePopupClose:function(){BX.removeClass(this.bindElement,"task-grade-and-report-selected")},__onGradePopupChange:function(){this.bindElement.className="task-grade-and-report"+(this.listValue!=="NULL"?" task-grade-"+this.listItem.className:"")+(this.report?" task-in-report":"");this.bindElement.title=BX.message("TASKS_MARK")+": "+this.listItem.name;BX.Tasks.GridActions.action("legacyUpdate",this.id,{data:{MARK:this.listValue==="NULL"?"":this.listValue}})},renderTimerItem:function(t,e,i,s,r,a){a=a||false;var n="task-timer-inner";var o=e+r;if(s){n=n+" task-timer-play"}else if(a){n=n+" task-timer-pause"}else{n=n+" task-timer-clock"}if(i>0&&o>i){n=n+" task-timer-overdue"}return BX.create("span",{props:{id:"task-timer-block-"+t,className:"task-timer-block"},events:{click:function(t,e){return function(){if(BX.hasClass(BX("task-timer-block-inner-"+t),"task-timer-play")){BX.TasksTimerManager.stop(t)}else if(e){BX.TasksTimerManager.start(t)}}}(t,a)},children:[BX.create("span",{props:{id:"task-timer-block-inner-"+t,className:n},children:[BX.create("span",{props:{className:"task-timer-icon"}}),BX.create("span",{props:{id:"task-timer-block-value-"+t,className:"task-timer-time"},text:BX.Tasks.GridActions.renderTimerTimes(o,i,s)})]})]})},renderTimerTimes:function(t,e,i){var s="";var r=!!i;s=BX.Tasks.GridActions.renderSecondsToHHMMSS(t,r);if(e>0){s=s+" / "+BX.Tasks.GridActions.renderSecondsToHHMMSS(e,false)}return s},renderSecondsToHHMMSS:function(t,e){var i="00";var s="";var r="";var a=0;if(t>0){s+=Math.floor(t/3600);r+=Math.floor(t/60)%60}else{s+=Math.ceil(t/3600);r+=Math.ceil(t/60)%60}var n=i.substring(0,2-s.length)+s+":"+i.substring(0,2-r.length)+r;if(e){a=""+t%60;n=n+":"+i.substring(0,2-a.length)+a}return n},redrawTimerNode:function(t,e,i,s,r,a){var n=BX("task-timer-block-"+t);var o=BX.Tasks.GridActions.renderTimerItem(t,e,i,s,r,a);if(n){n.parentNode.replaceChild(o,n)}else{var d=BX("task-timer-block-container-"+t);if(d){if(this.registeredTimerNodes[t]){BX.removeCustomEvent(window,"onTaskTimerChange",this.registeredTimerNodes[t])}d.appendChild(o);if(BX("task-timer-block-"+t)){this.registeredTimerNodes[t]=this.__getTimerChangeCallback(t);BX.addCustomEvent(window,"onTaskTimerChange",this.registeredTimerNodes[t])}}}},removeTimerNode:function(t){if(this.registeredTimerNodes[t]){BX.removeCustomEvent(window,"onTaskTimerChange",this.registeredTimerNodes[t])}var e=BX("task-timer-block-"+t);if(e){e.parentNode.removeChild(e)}},__getTimerChangeCallback:function(t){var e=null;return function(i){var s=null;var r=null;if(i.action==="refresh_daemon_event"){if(Number(i.taskId)!==Number(t)){if(e==="paused"){return}s="paused"}else{if(e!=="playing"){s="playing"}BX.Tasks.GridActions.redrawTimerNode(i.taskId,i.data.TASK.TIME_SPENT_IN_LOGS,i.data.TASK.TIME_ESTIMATE,true,i.data.TIMER.RUN_TIME,true)}}else if(i.action==="start_timer"){if(Number(t)===Number(i.taskId)&&i.timerData&&Number(t)===Number(i.timerData.TASK_ID)){s="playing"}else{s="paused"}}else if(i.action==="stop_timer"){if(Number(t)==Number(i.taskId)){s="paused"}}else if(i.action==="init_timer_data"){if(i.data.TIMER){if(Number(i.data.TIMER.TASK_ID)===Number(t)){s=i.data.TIMER.TIMER_STARTED_AT>0?"playing":"paused"}else if(i.data.TIMER.TASK_ID>0){s="paused"}}}if(s!==null){r=BX("task-timer-block-inner-"+t);if(r&&!BX.hasClass(r,"task-timer-clock")){if(s==="paused"){BX.removeClass(r,"task-timer-play");BX.addClass(r,"task-timer-pause")}else if(s==="playing"){BX.removeClass(r,"task-timer-pause");BX.addClass(r,"task-timer-play")}}e=s}}}};BX((function(){"use strict";BX.Tasks.Grid=function(t){this.grid=BX.Main.gridManager.getInstanceById(t.gridId);this.userId=Number(t.userId);this.ownerId=Number(t.ownerId);this.groupId=Number(t.groupId);this.lastGroupId=Number(t.lastGroupId);this.sorting=t.sorting;this.groupByGroups=t.groupByGroups==="true";this.groupBySubTasks=t.groupBySubTasks==="true";this.arParams=t.arParams;this.migrationBarOptions=t.migrationBarOptions;this.calendarSettings=t.calendarSettings?t.calendarSettings:{};this.taskList=new Map;this.comments=new Map;this.queue={pull:new BX.Tasks.Runtime.DebouncedQueue({timeout:1e3,events:{onCommitAsync:t=>BX.Tasks.ControllerTask.getRepositoryByCollectionPushEventsAsync(t.getData().poolItems,this)}}),event:new BX.Tasks.Runtime.DebouncedQueue({timeout:10,events:{onCommitAsync:t=>BX.Tasks.ControllerTask.emitByCollectionEventImitterEventsAsync(t.getData().poolItems)}})};this.actions={taskAdd:"taskAdd",taskUpdate:"taskUpdate",taskRemove:"taskRemove",commentAdd:"commentAdd",pinChanged:"pinChanged"};this.classes={highlighted:"task-list-item-highlighted",pinned:"tasks-list-item-pinned"};this.isMyList=this.userId===this.ownerId;this.canPin=this.isMyList;this.updateCanMove();this.init(t)};BX.Tasks.Grid.prototype={init:function(t){this.bindEvents();this.fillTaskListItems(t.taskList);this.colorPinnedRows();this.showStub();if(t.arParams&&t.arParams["LAZY_LOAD"]){this.grid.reload()}},bindEvents:function(){var t={comment_read_all:this.onPullCommentReadAll,project_read_all:this.onPullProjectReadAll,tag_changed:this.onPullTagChanged};var e={comment_add:this.onPullCommentAdd,task_add:this.onPullTaskAdd,task_update:this.onPullTaskUpdate,task_view:this.onPullTaskView,task_remove:this.onPullTaskRemove,user_option_changed:this.onUserOptionChanged};BX.Event.EventEmitter.subscribe("BX.Tasks.ControllerTask:onGetRepository",function(t){this.queue.event.push(t.getData())}.bind(this));BX.Event.EventEmitter.subscribe("BX.Tasks.Event:onEmit",function(t){var i=t.getData().params;var s=t.getData().command;var r=t.getData().repository;if(e[s]){e[s].apply(this,[i,r])}}.bind(this));BX.addCustomEvent("onPullEvent-tasks",function(e,i){if(t[e]){t[e].apply(this,[i])}else{var s=(new BX.Tasks.ControllerTaskEvent).resolveIdByParam(e,i);if(s>0){this.queue.pull.push({id:s,params:i},e)}}}.bind(this));BX.addCustomEvent("BX.Main.grid:sort",function(t,e){if(e===this.grid){this.sorting.sort={};this.sorting.sort[t.sort_by]=t.sort_order}}.bind(this));BX.addCustomEvent("BX.Main.grid:paramsUpdated",function(){this.updateCanMove();this.colorPinnedRows();this.clearTaskListItems();this.clearLastGroupId();this.getRows().map((function(t){return t.getId()})).filter((function(t){return t!=="template_0"})).forEach(function(t){this.addTaskListItem(t);this.updateLastGroupId(t)}.bind(this));this.showStub()}.bind(this));BX.addCustomEvent("BX.Tasks.Filter.group",function(t,e,i){if(this.getGrid()===t){this[e]=i}}.bind(this))},updateCanMove:function(){this.canMove=this.isMyList&&this.sorting.sort.ACTIVITY_DATE&&this.sorting.sort.ACTIVITY_DATE==="desc"&&!this.groupByGroups&&!this.groupBySubTasks},checkCanMove:function(){return this.canMove},colorPinnedRows:function(){this.getRows().forEach(function(t){var e=t.getNode();this.getIsPinned(t.getId())?BX.addClass(e,this.classes.pinned):BX.removeClass(e,this.classes.pinned)}.bind(this))},getIsPinned:function(t){return this.isRowExist(t)&&this.getRowNodeById(t).querySelector(".main-grid-cell-content-action-pin.main-grid-cell-content-action-active")instanceof HTMLElement},onPullTaskView:function(t,e){if(this.userId!==Number(t.USER_ID)||!this.isRowExist(t.TASK_ID.toString())){return}this.updateActivityDateCellForTask(t.TASK_ID,{},{},e)},onPullCommentReadAll:function(t){this.onReadAll(t)},onPullProjectReadAll:function(t){this.onReadAll(t)},onReadAll:function(t){if(this.userId!==Number(t.USER_ID)){return}this.updateActivityDateCellForTasksFromLocalStorage()},updateActivityDateCellForTasksHandler:function(t,e,i){Object.keys(t.data).forEach(function(e){if(this.isRowExist(e)){var s=this.getRowById(e);var r=t.data[e];if(s.getCellById("ACTIVITY_DATE")){s.setCellsContent({ACTIVITY_DATE:r.content.ACTIVITY_DATE})}s.setActions(r.actions);s.setCellActions(r.cellActions);s.setCounters(r.counters);if(i.highlightRow===true){this.highlightGridRow(e)}}}.bind(this))},updateActivityDateCellForTasksFromLocalStorage:function(){var t={};var e=this.getTaskListItems();var i={taskIds:e,arParams:this.arParams};BX.ajax.runComponentAction("bitrix:tasks.task.list","getGridRows",{mode:"class",data:i}).then(function(t){this.updateActivityDateCellForTasksHandler(t,{},{})}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors)}}.bind(this))},updateActivityDateCellForTask:function(t,e,i,s){i=i||{};var r=s.collectionGrid.get(BX.Text.toNumber(t));if(r[t]){this.updateActivityDateCellForTasksHandler({data:r},e,i)}else{BX.Tasks.alert("grid.id is empty"+t)}},onPullCommentAdd:function(t,e){if(this.checkComment(t)){var i=t.entityXmlId.split("_");if(i){this.checkTask(i[1],{action:this.actions.commentAdd,userId:Number(t.ownerId),isCompleteComment:t.isCompleteComment},e)}}},onPullTagChanged:function(t){if(this.groupId===0){this.getGrid().reload()}if(this.groupId!==0&&t.groupId===this.groupId){this.getGrid().reload()}var e=BX.UI.EntitySelector.Dialog.getById("tasks-task-list-tag-widget");e&&e.hide()},onPullTaskAdd:function(t,e){if(t.params.addCommentExists===false){this.checkTask(t.TASK_ID.toString(),{action:this.actions.taskAdd,userId:this.ownerId},e)}},onPullTaskUpdate:function(t,e){var i=BX.UI.EntitySelector.Dialog.getById("tasks-task-list-tag-widget");if(i){if("GROUP_ID"in t.AFTER&&t.AFTER.GROUP_ID!==t.BEFORE.GROUP_ID){i.hide()}}if(t.params.updateCommentExists===false){this.checkTask(t.TASK_ID.toString(),{action:this.actions.taskUpdate,userId:this.ownerId},e)}else if(t.params.removedParticipants.includes(this.ownerId.toString())&&(!this.groupId||this.groupId!==Number(t.AFTER.GROUP_ID))){this.removeItem(t.TASK_ID.toString())}},onPullTaskRemove:function(t,e){if(this.checkCanMove()){this.removeItem(t.TASK_ID.toString())}},onUserOptionChanged:function(t,e){if(!this.checkCanMove()||this.userId!==Number(t.USER_ID)){return}var i=t.TASK_ID.toString();switch(Number(t.OPTION)){case 1:this.updateActivityDateCellForTask(i,{},{},e);break;case 2:case 3:if(this.canPin){this.placeToNearTasks(i,null,{action:this.actions.pinChanged},e)}break;default:break}},placeToNearTasks:function(t,e,i,s){var r={taskId:t,navigation:{pageNumber:this.getPageNumber(),pageSize:this.getPageSize()},arParams:this.arParams};BX.ajax.runComponentAction("bitrix:tasks.task.list","getNearTasks",{mode:"class",data:r}).then(function(r){if(r.data){var a=r.data.before;var n=r.data.after;if(a&&this.isRowExist(a)||n&&this.isRowExist(n)){var o={before:a,after:n};Object.keys(i).forEach((function(t){o[t]=i[t]}));this.updateItem(t,e,o,s)}else{this.removeItem(t)}}}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors)}}.bind(this))},checkComment:function(t){var e=t.entityXmlId.split("_");if(!e){return false}var i=e[0];var s=e[1];if(i!=="TASK"){return false}if(!this.comments.has(s)){this.comments.set(s,new Set)}var r=this.comments.get(s);var a=t.messageId;var n=t.participants.map((function(t){return t.toString()}));if(r.has(a)){return false}r.add(a);return n.includes(this.userId.toString())||this.groupId===t.groupId},checkTask:function(t,e,i){e=e||{};var s=null;var r=i.collection;var a=i.collectionSiftThroughFilter;if(e.isCompleteComment===false||e.userId===this.userId){s=a.getById(t)}else{s=r.getById(t)}this.onCheckTaskSuccess(s,t,e,i)},onCheckTaskSuccess:function(t,e,i,s){if(BX.Type.isNil(t)){this.removeItem(e);return}var r=t.getFields();if(this.isRowExist(e)){if(this.checkCanMove()){i.canMoveRow=i.action!==this.actions.taskUpdate;this.updateGridRow(e,r,i,s)}else{if(i.action===this.actions.commentAdd){if(i.isCompleteComment===true){this.getGrid().updateRow(e)}else{var a={};a[e]=r;this.updateActivityDateCellForTask(e,a,{highlightRow:true},s)}}else if(i.action===this.actions.taskUpdate){this.getGrid().updateRow(e)}}}else if(this.checkCanMove()){if(i.action===this.actions.taskUpdate){this.placeToNearTasks(e,r,i)}else{this.updateItem(e,r,i,s)}}},updateItem:function(t,e,i,s){e=e||null;i=i||{};if(!this.hasTaskListItem(t)){this.addTaskListItem(t);this.addGridRow(t,e,i,s)}else{this.updateGridRow(t,e,i,s)}},addGridRow:function(t,e,i,s){var r=s.collectionGrid.get(BX.Text.toNumber(t));if(r[t]){var e=r[t];var a={id:t,columns:e.content,actions:e.actions,cellActions:e.cellActions,counters:e.counters};var n=this.getGridMoveRows(t,i);if(n.rowAfter){a.insertAfter=n.rowAfter}else if(n.rowBefore){a.insertBefore=n.rowBefore}else{a.append=true}if(this.taskList.size>this.getPageNumber()*this.getPageSize()){var o=this.getLastRowId();this.removeTaskListItem(o);BX.remove(this.getRowNodeById(o));this.showMoreButton()}this.hideStub();this.getRealtime().addRow(a);this.colorPinnedRows()}else{BX.Tasks.alert("grid.id is empty"+t)}},updateGridRow:function(t,e,i,s){if(!this.isRowExist(t)){return}var r=s.collectionGrid.get(BX.Text.toNumber(t));if(r[t]){var e=r[t];var a=this.getRowById(t);a.setCellsContent(e.content);a.setActions(e.actions);a.setCellActions(e.cellActions);a.setCounters(e.counters);if(i.canMoveRow!==false){this.getGrid().getRows().reset();var n=this.getGridMoveRows(t,i);this.moveRow(t,n.rowAfter,n.rowBefore)}this.highlightGridRow(t).then(function(){this.colorPinnedRows()}.bind(this));this.getGrid().bindOnRowEvents();BX.onCustomEvent("Tasks.Tasks.Grid:RowUpdate",{id:t})}else{BX.Tasks.alert("grid.id is empty"+t)}},removeItem:function(t){if(!this.isRowExist(t)){return}this.removeTaskListItem(t);this.getGrid().removeRow(t);BX.onCustomEvent("Tasks.Tasks.Grid:RowRemove",{id:t})},getGridMoveRows:function(t,e){var i;var s;switch(e.action){case this.actions.pinChanged:case this.actions.taskUpdate:i=e.before;s=e.after;break;default:i=this.getFirstRowId();s=this.getIsPinned(t)?0:this.getLastPinnedRowId();break}return{rowBefore:i,rowAfter:s}},moveRow:function(t,e,i){if(e){this.getGrid().getRows().insertAfter(t,e)}else if(i){this.getGrid().getRows().insertBefore(t,i)}},getLastPinnedRowId:function(){var t=Object.values(this.getRows()).filter(function(t){return this.getIsPinned(t.getId())}.bind(this));var e=Object.keys(t);if(e.length>0){return t[e[e.length-1]].getId()}return 0},getFirstRowId:function(){var t=this.getRows();return t.length?this.getRowProp(t[0],"id"):0},getLastRowId:function(){var t=this.getGrid().getRows().getBodyLastChild();return t?this.getRowProp(t,"id"):0},highlightGridRow:function(t){var e=new BX.Promise;if(!this.isRowExist(t)){e.reject();return e}var i=this.getRowNodeById(t);var s=BX.hasClass(i,this.classes.pinned);if(s){BX.removeClass(i,this.classes.pinned)}BX.addClass(i,this.classes.highlighted);setTimeout(function(){BX.removeClass(i,this.classes.highlighted);if(s){BX.addClass(i,this.classes.pinned)}e.fulfill()}.bind(this),900);return e},getGrid:function(){return this.grid},getRows:function(){return this.getGrid().getRows().getBodyChild()},isRowExist:function(t){return this.getRowById(t)!==null},getRowById:function(t){return this.getGrid().getRows().getById(t)},getRowNodeById:function(t){return this.getRowById(t).getNode()},getRowProp:function(t,e){return BX.data(t.getNode(),e)},setRowProp:function(t,e,i){t.getNode().setAttribute("data-"+e,i)},getPageNumber:function(){var t=1;var e=this.getGrid().getContainer().querySelector(".main-grid-nav-panel");if(e){var i=e.querySelector(".main-ui-pagination");if(i){var s=i.querySelector(".main-ui-pagination-active");if(s){t=s.innerText}}}return t},getPageSize:function(){var t=50;var e=BX(this.getGrid().getContainerId()+"_"+this.getGrid().settings.get("pageSizeId"));if(e){t=BX.data(e,"value")}return t},getRealtime:function(){return this.getGrid().getRealtime()},showStub:function(){},hideStub:function(){this.getGrid().hideEmptyStub()},showMigrationBar:function(){if(this.taskList.size>0||this.groupId){return}var t=BX.Main.filterManager.getById(BX.Tasks.GridActions.gridId);if(!t||!BX.Dom.hasClass(t.getSearch().getContainer(),"main-ui-filter-default-applied")){return}if(!this.migrationContainer){var e=new BX.UI.MigrationBar({title:this.migrationBarOptions.title,minWidth:600,minHeight:200,cross:false,items:this.migrationBarOptions.items.map((function(t){return{src:t}})),buttons:[{text:this.migrationBarOptions.buttonMigrate,color:BX.UI.ButtonColor.PRIMARY,round:true,link:"/marketplace/?tag[]=migrator&tag[]=tasks"}],link:{text:this.migrationBarOptions.other}});e.show();this.migrationContainer=e.getContainer();BX.Dom.style(this.migrationContainer,"marginTop","50px")}BX.Dom.append(this.migrationContainer,document.querySelector(".main-grid-empty-inner"))},showMoreButton:function(){this.getGrid().getMoreButton().getNode().style.display="inline-block"},hideMoreButton:function(){this.getGrid().getMoreButton().getNode().style.display="none"},getTaskListItems:function(){return Array.from(this.taskList.keys())},hasTaskListItem:function(t){return this.taskList.has(parseInt(t,10))},addTaskListItem:function(t){this.taskList.set(parseInt(t,10))},removeTaskListItem:function(t){this.taskList.delete(parseInt(t,10))},fillTaskListItems:function(t){Object.keys(t).forEach(function(t){this.addTaskListItem(t)}.bind(this))},clearTaskListItems:function(){this.taskList.clear()},updateLastGroupId:function(t){if(t.indexOf("group_")===0){this.lastGroupId=Number(t.replace("group_",""))}},clearLastGroupId:function(){this.lastGroupId=0}};BX.addCustomEvent("tasksTaskEvent",BX.delegate((function(t,e){if(!BX.Tasks.GridActions.checkCanMove()){BX.Tasks.GridActions.reloadGrid()}}),this));BX.addCustomEvent("SidePanel.Slider:onCloseByEsc",(function(t){var e=/tasks\/task\/edit/;var i=t.getSlider().getUrl();if(e.test(i)&&!confirm(BX.message("TASKS_CLOSE_PAGE_CONFIRM"))){t.denyAction()}}));BX.addCustomEvent("BX.Main.Filter:apply",function(t,e,i){var s=window.location.href;var r=new URL(s);var a=r.searchParams.get("F_STATE");var n=a==="sR"?s.replace("&F_STATE=sR",""):s;window.history.replaceState(null,null,n)}.bind(this));BX.addCustomEvent("Tasks.TopMenu:onItem",(function(t,e){var i=BX.Main.filterManager.getById(BX.Tasks.GridActions.gridId);if(!i){console.log("BX.Main.filterManager not initialised");return}var s={preset_id:BX.Tasks.GridActions.defaultPresetId,additional:{ROLEID:t==="view_all"?0:t}};var r=i.getApi();r.setFilter(s,{ROLE_TYPE:"TASKS_ROLE_TYPE_"+(t===""?"view_all":t)});window.history.pushState(null,null,e)}));BX.addCustomEvent("Tasks.Toolbar:onItem",(function(t){var e=t.getData();if(e.counter&&e.counter.filter){e.counter.filter.toggleByField({PROBLEM:e.counter.filterValue})}}));BX.Tasks.Grid.Sorting=function(t){this.grid=BX.Main.gridManager.getInstanceById(t.gridId);this.currentGroupId=t.currentGroupId;this.treeMode=t.treeMode;BX.message(t.messages);this.init();BX.addCustomEvent("BX.Main.grid:rowDragStart",this.handleRowDragStart.bind(this));BX.addCustomEvent("BX.Main.grid:rowDragMove",this.handleRowDragMove.bind(this));BX.addCustomEvent("BX.Main.grid:rowDragEnd",this.handleRowDragEnd.bind(this))};BX.Tasks.Grid.Sorting.prototype={init:function(){this.dragRow=null;this.targetRow=null;this.error=false;this.targetTask=null;this.before=true;this.newGroup=null;this.newParentId=null},getGrid:function(){return this.grid},getRow:function(t){return this.getGrid().getRows().get(t)},getRowById:function(t){return this.getGrid().getRows().getById(t)},getRows:function(){return this.getGrid().getRows().getBodyChild()},getRowProp:function(t,e){return t.getNode().dataset[e]},getRowType:function(t){return this.getRowProp(t,"type")},getRowGroupId:function(t){return this.getRowProp(t,"groupId")},handleRowDragStart:function(t,e){this.dragRow=this.getRow(t.getDragItem())},handleRowDragMove:function(t,e){this.targetRow=this.getRow(t.getTargetItem());var i=this.targetRow?this.getRowType(this.targetRow):null;this.newParentId=null;this.error=false;var s=null;if(i==="task"){var r=this.targetRow.getParentId();if(r!==this.dragRow.getParentId()){this.newParentId=r}s=this.getGroupByRow(this.targetRow);this.targetTask=this.targetRow;this.before=true}else{if(i==="group"){s=this.getPreviousGroup(this.targetRow)}else{s=this.getLastGroup()}var a=this.getClosestTask(this.targetRow);this.targetTask=a.task;this.before=a.before}this.newGroup=s.id!==this.getGroupByRow(this.dragRow).id?s:null;if(i==="task"&&this.isChildOf(this.targetTask,this.dragRow)){this.error=true}else if(this.newGroup&&this.newGroup.id>0&&(this.getRowProp(this.dragRow,"canEdit")==="false"||!this.newGroup.canCreateTasks)){this.error=true}else if(this.newParentId!==null&&this.getRowProp(this.dragRow,"canEdit")==="false"){this.error=true}this.error?t.disallowMove(BX.message("TASKS_ACCESS_DENIED")):t.allowMove()},handleRowDragEnd:function(t,e){if(!this.error){this.save()}this.init()},save:function(){var t=this.dragRow.getId();var e=this.targetTask?this.targetTask.getId():null;if(t===e){return}var i={sourceId:t,targetId:e,before:this.before?1:0,currentGroupId:this.currentGroupId};if(this.newGroup!==null){i.newGroupId=this.newGroup.id;this.setGroupId(this.dragRow,i.newGroupId)}if(this.newParentId!==null&&this.treeMode){i.newParentId=this.newParentId}BX.ajax.runComponentAction("bitrix:tasks.task.list","sortTask",{mode:"class",data:{data:i}}).then(function(t){}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors)}}.bind(this))},getParentRow:function(t){return this.getRowById(t.getParentId())},isChildOf:function(t,e){var i=this.getParentRow(t);while(i!==null){if(i===e){return true}i=this.getParentRow(i)}return false},getGroupById:function(t){var e=this.getRows();for(var i=0;i<e.length;i++){var s=e[i];if(this.getRowType(s)==="group"&&this.getRowGroupId(s)===String(t)){return this.getGroupByRow(s)}}return this.getDefaultProject()},setGroupId:function(t,e){t.getDataset().groupId=e;var i=t.getChildren();for(var s=0;s<i.length;s++){this.setGroupId(i[s],e)}},getDefaultProject:function(){return{id:"0",canCreateTasks:true}},getGroupByRow:function(t){if(this.getRowType(t)==="group"){return{id:this.getRowGroupId(t),canCreateTasks:this.getRowProp(t,"canCreateTasks")==="true"}}else{return this.getGroupById(this.getRowGroupId(t))}},getLastGroup:function(){var t=null;var e=this.getRows();for(var i=e.length-1;i>=0;i--){var s=e[i];if(this.getRowType(s)==="group"){return this.getGroupByRow(s)}}return this.getDefaultProject()},getPreviousGroup:function(t){var e=null;var i=this.getRows();var s=false;for(var r=i.length-1;r>=0;r--){var a=i[r];if(t===a){s=true;continue}if(s&&this.getRowType(a)==="group"){return this.getGroupByRow(a)}}return this.getDefaultProject()},getClosestTask:function(t){var e=this.getRows();var i=t?t.getIndex()-1:e.length;for(var s=i-1;s>=0;s--){if(this.getRowType(e[s])==="task"&&e[s].getDepth()==="0"){return{task:e[s],before:false}}}for(s=i+1;s<e.length;s++){if(this.getRowType(e[s])==="task"&&e[s].getDepth()==="0"){return{task:e[s],before:true}}}return{task:null,before:true}}};BX.Tasks.TourGuideController=function(t){this.tours=t.tours;this.guide=null;this.initGuides(t)};BX.Tasks.TourGuideController.prototype={initGuides:function(t){var e=this.tours.firstGridTaskCreation;var i=this.tours.expiredTasksDeadlineChange;if(e.show){this.guide=new BX.Tasks.TourGuideController.FirstGridTaskCreationTourGuide(t)}else if(i.show||i.backgroundCheck){this.guide=new BX.Tasks.TourGuideController.ExpiredTasksDeadlineChangeTourGuide(t)}},getGuide:function(){return this.guide}};BX.Tasks.TourGuideController.FirstGridTaskCreationTourGuide=function(t){this.tour=t.tours.firstGridTaskCreation;this.popupData=this.tour.popupData;this.start()};BX.Tasks.TourGuideController.FirstGridTaskCreationTourGuide.prototype={start:function(){var t=BX("tasks-buttonAdd");if(!t){return}t.href=BX.Uri.addParam(t.href,{FIRST_GRID_TASK_CREATION_TOUR_GUIDE:"Y"});this.guide=new BX.UI.Tour.Guide({steps:[{target:t,title:this.popupData[0].title,text:this.popupData[0].text}],onEvents:true});BX.addCustomEvent("UI.Tour.Guide:onFinish",function(e){if(e.getData().guide===this.guide){t.href=BX.Uri.removeParam(t.href,["FIRST_GRID_TASK_CREATION_TOUR_GUIDE"])}}.bind(this));this.showNextStep()},showNextStep:function(){setTimeout(function(){this.guide.showNextStep()}.bind(this),500)}};BX.Tasks.TourGuideController.ExpiredTasksDeadlineChangeTourGuide=function(t){this.userId=t.userId;this.tour=t.tours.expiredTasksDeadlineChange;this.popupData=this.tour.popupData;this.counterToCheck=this.tour.counterToCheck;this.rowId=0;this.calendarPopup=0;this.isStopped=false;this.viewMode="grid";this.ajaxActionPrefix="tasks.tourguide.expiredtasksdeadlinechange.";this.grid=BX.Main.gridManager.getInstanceById(t.gridId);if(this.tour.show){this.start()}else if(this.tour.backgroundCheck){this.isPullListening=true}this.bindEvents()};BX.Tasks.TourGuideController.ExpiredTasksDeadlineChangeTourGuide.prototype={bindEvents:function(){var t={user_counter:this.onUserCounter.bind(this)};BX.addCustomEvent("onPullEvent-tasks",function(e,i){if(t[e]){t[e].apply(this,[i])}}.bind(this));BX.addCustomEvent("UI.Tour.Guide:onPopupClose",function(){this.stop()}.bind(this));BX.addCustomEvent("UI.Tour.Guide:onFinish",function(t){if(t.getData().guide===this.guide&&this.getCurrentStepIndex()===0){BX.addCustomEvent("BX.Main.grid:paramsUpdated",BX.proxy(this.onExpiredCounterGridReloaded,this))}}.bind(this))},onUserCounter:function(t){if(!this.isPullListening||this.userId!==Number(t.userId)){return}var e=Number(t[0].view_role_originator.expired)+Number(t[0].view_role_responsible.expired);if(e>=Number(this.counterToCheck)){this.isPullListening=false;BX.ajax.runAction(this.ajaxActionPrefix+"proceed",{analyticsLabel:{viewMode:this.viewMode}}).then(function(t){if(t.data){this.start()}}.bind(this))}},start:function(){this.guide=new BX.UI.Tour.Guide({steps:[{target:document.querySelector(".tasks-counters--item-counter"),title:this.popupData[0].title,text:this.popupData[0].text}],onEvents:true});this.showNextStep()},markShowedStep:function(t){BX.ajax.runAction(this.ajaxActionPrefix+"markShowedStep",{analyticsLabel:{viewMode:this.viewMode,step:t}})},onExpiredCounterGridReloaded:function(){BX.removeCustomEvent("BX.Main.grid:paramsUpdated",BX.proxy(this.onExpiredCounterGridReloaded,this));var t=null;Object.values(this.grid.getRows().getBodyChild()).forEach(function(e){if(!this.rowId&&e.getNode().querySelector(".ui-label.ui-label-danger.ui-label-fill.ui-label-link")){this.rowId=e.getId();t=e.getNode().querySelector(".ui-label.ui-label-danger.ui-label-fill.ui-label-link")}}.bind(this));if(this.rowId>0&&t){this.guide.steps.push(new BX.UI.Tour.Step({target:t,title:this.popupData[1].title,text:this.popupData[1].text}));this.showNextStep()}},setCalendarPopup:function(t){if(!this.calendarPopup&&this.getCurrentStepIndex()===1){this.calendarPopup=t;BX.addCustomEvent(this.calendarPopup,"onPopupAfterClose",BX.proxy(this.onCalendarPopupClose,this))}},onCalendarPopupClose:function(){BX.removeCustomEvent(this.calendarPopup,"onPopupAfterClose",BX.proxy(this.onCalendarPopupClose,this));setTimeout(function(){BX.removeCustomEvent("Tasks.Tour.ExpiredTasksDeadlineChange:saveDeadline",BX.proxy(this.onDeadlineSave,this))}.bind(this),500);BX.addCustomEvent("Tasks.Tour.ExpiredTasksDeadlineChange:saveDeadline",BX.proxy(this.onDeadlineSave,this))},onDeadlineSave:function(){BX.addCustomEvent("BX.Main.grid:paramsUpdated",BX.proxy(this.onGridReloaded,this))},onGridReloaded:function(){BX.removeCustomEvent("BX.Main.grid:paramsUpdated",BX.proxy(this.onGridReloaded,this));if(this.grid.getRows().getById(this.rowId)===null){this.guide.steps.push(new BX.UI.Tour.Step({title:this.popupData[2].title,text:this.popupData[2].text,buttons:[{text:this.popupData[2].buttons[0],event:function(){this.stop()}.bind(this)}]}));this.showNextStep()}},showNextStep:function(){if(this.isStopped){return}setTimeout(function(){this.guide.showNextStep();this.markShowedStep(this.getCurrentStepIndex())}.bind(this),500)},getCurrentStepIndex:function(){return this.guide.currentStepIndex},isCorrectRow:function(t){return Number(this.rowId)===Number(t)},getIsStopped:function(){return this.isStopped},stop:function(){this.isStopped=true;this.guide.close()}}}));this.BX=this.BX||{};(function(t,e,i,s){"use strict";var r=Object.freeze({COMMENT_ADD:"comment_add",TASK_ADD:"task_add",TASK_UPDATE:"task_update",TASK_VIEW:"task_view",TASK_REMOVE:"task_remove",USER_OPTION_CHANGED:"user_option_changed"});function a(t,e){o(t,e);e.add(t)}function n(t,e,i){o(t,e);e.set(t,i)}function o(t,e){if(e.has(t)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function d(t,e,i){if(!e.has(t)){throw new TypeError("attempted to get private field on non-instance")}return i}var u=new WeakMap;var l=new WeakSet;var c=new WeakSet;var h=new WeakSet;var f=function(){function t(){var e;var s=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,t);a(this,h);a(this,c);a(this,l);n(this,u,{writable:true,value:0});s=i.Type.isPlainObject(s)?s:{};babelHelpers.classPrivateFieldSet(this,u,(e=s.timeout)!==null&&e!==void 0?e:100)}babelHelpers.createClass(t,[{key:"resolveIdByParam",value:function t(e,i){if(d(this,c,p).call(this,e)){var s=d(this,l,g).call(this,e,i);if(s>0){return s}else{throw new Error("Index is not resolved for command: "+e)}}}},{key:"intervalEmitByParams",value:function t(e){var i=this;return new Promise((function(t,s){var r=Object.values(e);var a=setInterval((function(){if(r.length===0){clearTimeout(a);t();return}var e=r.shift();var s=e.poolItem,n=e.repository;d(i,h,m).call(i,s,n)}),babelHelpers.classPrivateFieldGet(i,u))}))}},{key:"batchEmitByParams",value:function t(e){var i=this;return new Promise((function(t,s){var r=Object.values(e);for(var a in r){if(!r.hasOwnProperty(a)){continue}var n=r[a];var o=n.poolItem,u=n.repository;d(i,h,m).call(i,o,u)}t()}))}}]);return t}();function g(t,e){var i="";if([r.TASK_ADD,r.TASK_UPDATE,r.TASK_REMOVE,r.TASK_VIEW,r.USER_OPTION_CHANGED].includes(t)){i=e.TASK_ID}else{i=e.taskId}return i}function p(t){var e=Object.values(r);return e.includes(t)}function m(t,i){var s=Object.values(t),r=babelHelpers.slicedToArray(s,1),a=r[0];var n=Object.keys(t),o=babelHelpers.slicedToArray(n,1),d=o[0];var u=a.fields.params;e.EventEmitter.emit("BX.Tasks.Event:onEmit",{command:d,params:u,repository:i})}function T(t,e){k(t,e);e.add(t)}function v(t,e,i){k(t,e);e.set(t,i)}function k(t,e){if(e.has(t)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function B(t,e,i){if(!e.has(t)){throw new TypeError("attempted to get private field on non-instance")}return i}var I=new WeakMap;var w=new WeakSet;var C=new WeakSet;var X=new WeakSet;var b=function(){function t(){babelHelpers.classCallCheck(this,t);T(this,X);T(this,C);T(this,w);v(this,I,{writable:true,value:{collectionGrid:new Map,collection:new s.TaskCollection,collectionSiftThroughFilter:new s.TaskCollection}})}babelHelpers.createClass(t,[{key:"callByFilter",value:function t(e,s){var r=this;return new Promise((function(t,a){var n=B(r,w,y).call(r,e,s);var o=B(r,C,S).call(r,n);if(Object.keys(o).length>0){BX.rest.callBatch(o,(function(e){Object.keys(o).forEach((function(t){var s;var a=(s=e[t])!==null&&s!==void 0?s:null;if(i.Type.isNull(a)===false){var n=a.answer.result;B(r,X,A).call(r,t,n)}}));t(r.get())}))}}))}},{key:"get",value:function t(){return babelHelpers.classPrivateFieldGet(this,I)}}]);return t}();function y(t,e){var r={};var a={collectionSiftThroughFilter:{cmd:"tasks.task.list",filter:{id:t.id,returnAccess:t.returnAccess,siftThroughFilter:{userId:t.siftThroughFilter.userId,groupId:t.siftThroughFilter.groupId}}},collection:{cmd:"tasks.task.list",filter:{id:t.id,returnAccess:t.returnAccess}},collectionGrid:{cmd:"tasks.task.getGridRows",filter:{id:t.id},params:e.arParams}};Object.keys(a).forEach((function(t){var e=a[t];switch(t){case"collection":case"collectionSiftThroughFilter":r[t]={cmd:e.cmd,param:s.TaskCollection.internalize(e.filter)};break;case"collectionGrid":r[t]={cmd:e.cmd,param:{taskIds:i.Type.isArrayFilled(e.filter.id)?e.filter.id:[e.filter.id],arParams:e.params}};break}}));return r}function S(t){var e={};Object.keys(t).forEach((function(i){var s=t[i];e[i]=[s.cmd,s.param]}));return e}function A(t,e){var s=this;if(Object.keys(babelHelpers.classPrivateFieldGet(this,I)).includes(t)){switch(t){case"collection":case"collectionSiftThroughFilter":babelHelpers.classPrivateFieldGet(this,I)[t].init(e.tasks);break;case"collectionGrid":Object.keys(e).forEach((function(r){if(r>0){var a={};a[r]=e[r];babelHelpers.classPrivateFieldGet(s,I)[t].set(i.Text.toNumber(r),a)}}));break}}}var R=function(){function t(){babelHelpers.classCallCheck(this,t)}babelHelpers.createClass(t,null,[{key:"getRepositoryByCollectionPushEventsAsync",value:function i(s,r){var a=new b;var n=t.getValuesId(s);return new Promise((function(t,i){a.callByFilter({id:n,returnAccess:"Y",siftThroughFilter:{userId:r.ownerId,groupId:r.groupId}},{arParams:r.arParams}).then((function(){var i=a.get();e.EventEmitter.emit("BX.Tasks.ControllerTask:onGetRepository",{params:{items:s,repository:i}});t()}))}))}},{key:"emitByCollectionEventImitterEventsAsync",value:function e(i){var s=new f;var r=t.prepareByPoolToEmit(i);return new Promise((function(t,e){s.batchEmitByParams(r).then((function(){return t()}))}))}},{key:"getValuesId",value:function t(e){var i=[];try{for(var s in e){if(!e.hasOwnProperty(s)){continue}var r=Object.keys(e[s]),a=babelHelpers.slicedToArray(r,1),n=a[0];var o=Object.values(e[s]),d=babelHelpers.slicedToArray(o,1),u=d[0];var l=u.fields.id;if(i.includes(l)===false){i.push(l)}}}catch(t){}return i}},{key:"prepareByPoolToEmit",value:function t(e){var i=[];Object.keys(e).forEach((function(t){var s=e[t];var r=s["default"].fields.params.items;var a=s["default"].fields.params.repository;Object.keys(r).forEach((function(t){var e=r[t];i.push({poolItem:e,repository:a})}))}));return i}}]);return t}();t.Action=r;t.ControllerTask=R;t.ControllerTaskEvent=f;t.ControllerTaskRepository=b})(this.BX.Tasks=this.BX.Tasks||{},BX.Event,BX,BX.Tasks.TaskModel);
//# sourceMappingURL=script.map.js