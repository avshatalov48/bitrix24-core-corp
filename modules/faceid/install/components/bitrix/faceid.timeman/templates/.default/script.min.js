var domNode=BX.create("script",{attrs:{src:"/bitrix/js/main/webrtc/adapter.js",type:"text/javascript"}});document.head.insertBefore(domNode,document.head.firstChild);var Module,isModuleInitialized,isBxFaceIdInitialized;if(typeof Module==="undefined"){Module={}}Module.onRuntimeInitialized=function(){isModuleInitialized=true;_BXFaceIdStart()};function BXFaceIdStart(){isBxFaceIdInitialized=true;_BXFaceIdStart()}function _BXFaceIdStart(){if(!isModuleInitialized||!isBxFaceIdInitialized){return}var t=false;var e=false;var a=null;var r=null;var c=null;var n=null;var s=BX.localStorage.get("faceid-default-camera");var d=null;var o={cameraRatio:0,screenRatio:window.screen.width/window.screen.height,cameraSmallWidth:340,cameraSmallHeight:0,cameraFullWidth:0,cameraFullHeight:0,snapshotWidth:640,snapshotHeight:0,trackingSmallRatio:0,trackingFullRatio:0,cameraWidth:0,cameraHeight:0,trackingRatio:0};var l=null;var f=null;var u=[];var m={};var h=new Module.WebPhotoMakerM;h.setStopAfterBestShot(true);h.setMovementThreshold(.03);h.setBestShotScoreThreshold(.05);h.setRotationThreshold(50);h.setMinFaceScaleFactor(.15);h.setMaxNumberOfFramesWithoutDetection(8);var v=o.snapshotWidth*o.snapshotWidth*4;var p=Module._malloc(v);var g=new Uint8ClampedArray(Module.HEAPU8.buffer,p,v);var k=[-1,-1,-1,-1,-1,-1];var B=["","","","","",""];var X=null;var _=false;var b=false;function C(){navigator.mediaDevices.enumerateDevices().then(function(t){var e=document.getElementById("faceid-cameralist");var a="faceid-tracker-sidebar-photo-settings-checked";t.forEach(function(t){if(t.kind=="videoinput"){if(s==null){s=t.deviceId;BX.localStorage.set("faceid-default-camera",s,3600*24*360)}var i="faceid-tracker-sidebar-photo-settings-inner-list-item";var r=t.label.replace(/\(\w{4}:\w{4}\)/g,"");if(!r.length){r=BX.message("FACEID_TRACKERWD_CMP_JS_CAMERA_DEFAULT")}if(t.deviceId==s){i+=" "+a}var c=BX.create("div",{text:r,attrs:{class:i,"data-camera-id":t.deviceId}});e.appendChild(c);BX.bind(c,"click",function(){if(BX.hasClass(BX(this),a)){return}var t,i=BX.findChildren(e);for(t in i){BX.removeClass(i[t],a)}BX.addClass(BX(this),a);s=this.getAttribute("data-camera-id");BX.localStorage.set("faceid-default-camera",s,3600*24*360);w();BX.toggle(BX("faceid-settings-container"))})}});S()}).catch(function(t){console.log(t.name+": "+t.message);I(BX.message("FACEID_TRACKERWD_CMP_JS_CAMERA_ERROR"))})}if(window.FACEID_AGREEMENT){C()}BX.bind(BX("faceid-settings-button"),"click",function(){BX.toggle(BX("faceid-settings-container"))});function w(){navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;navigator.getMedia({video:{deviceId:{exact:s}},audio:false},function(t){if(navigator.mozGetUserMedia){a.mozSrcObject=t}else{try{a.srcObject=t}catch(i){var e=window.URL||window.webkitURL;a.src=e.createObjectURL(t)}}a.play()},function(t){console.log("An error occured! "+t);BX.localStorage.remove("faceid-default-camera");var e;if(t.toString().indexOf("DevicesNotFound")>=0){e=BX.message("FACEID_TRACKERWD_CMP_JS_CAMERA_NOT_FOUND")}else{e=BX.message("FACEID_TRACKERWD_CMP_JS_CAMERA_NO_SUPPORT")}I(e)})}function S(){a=document.getElementById("faceid-video");r=document.getElementById("faceid-canvas");n=document.getElementById("faceid-startbutton");w();l=document.getElementById("faceid-overlay-face-border");f=l.getContext("2d");a.addEventListener("canplay",function(t){if(!e){{}o.cameraRatio=a.videoWidth/a.videoHeight;o.cameraSmallHeight=a.videoHeight/(a.videoWidth/o.cameraSmallWidth);if(o.screenRatio>=o.cameraRatio){o.cameraFullWidth=window.screen.width;o.cameraFullHeight=a.videoHeight/(a.videoWidth/o.cameraFullWidth)}else{o.cameraFullHeight=window.screen.height;o.cameraFullWidth=a.videoWidth/(a.videoHeight/o.cameraFullHeight)}o.snapshotHeight=a.videoHeight/(a.videoWidth/o.snapshotWidth);o.trackingSmallRatio=o.cameraSmallWidth/o.snapshotWidth;o.trackingFullRatio=o.cameraFullWidth/o.snapshotWidth;o.cameraWidth=o.cameraSmallWidth;o.cameraHeight=o.cameraSmallHeight;o.trackingRatio=o.trackingSmallRatio;a.setAttribute("width",o.cameraWidth);a.setAttribute("height",o.cameraHeight);r.setAttribute("width",o.snapshotWidth);r.setAttribute("height",o.snapshotHeight);l.setAttribute("width",o.cameraWidth);l.setAttribute("height",o.cameraHeight);e=true;A()}},false);n.addEventListener("click",function(t){t.preventDefault()},false);if(window.FACEID_LAST_VISITORS){for(i in window.FACEID_LAST_VISITORS){H(window.FACEID_LAST_VISITORS[i],false)}}}function I(t){BX("faceid-camera-error").innerHTML=t;BX.show(BX("faceid-camera-error"))}function A(){requestAnimationFrame(A);if(!BX("faceid-auto-identify").checked){return}if(t){return}if(u.length){}t=true;var e=r.getContext("2d");e.drawImage(a,0,0,o.snapshotWidth,o.snapshotHeight);var i=r.toDataURL("image/jpeg",1);var c=new Image;c.onload=function(){var e=E(r,true);if(e.length>0){var a=[];for(var i in e){if(!m[e[i].frameId]&&h.getBestShotFrameNumber(e[i].frameId)>=0&&h.getCurrentFrameNumber()>=h.getBestShotFrameNumber(e[i].frameId)){a.push(e[i])}}if(a.length){D(a,c)}}t=false};c.onerror=function(){t=false};c.src=i;requestAnimationFrame(A)}function R(t){for(var e=0;e<k.length;e++){var a=0;for(var i=0;i<t.length;i++){if(t[i]!=k[e])a++;else break}if(a==t.length){k[e]=-1;B[e]=""}}for(var i=0;i<t.length;i++){var r=true;for(var e=0;e<k.length;e++){if(t[i]==k[e]){r=false;break}}if(r){for(var e=0;e<k.length;e++){if(k[e]==-1){k[e]=t[i];break}}}}}function T(t,e,a,i,r){t.save();t.strokeStyle="rgba("+i[0]+", "+i[1]+", "+i[2]+", "+i[3]+")";t.lineWidth=3;try{var c=e.x;var n=e.y;var s=e.x+e.width;var d=e.y+e.height;var l=a;var f=Math.PI/180;if(s-c-2*l<0){l=(s-c)/2}if(d-n-2*l<0){l=(d-n)/2}t.beginPath();t.moveTo(c+l,n);t.lineTo(s-l,n);t.arc(s-l,n+l,l,f*270,f*360,false);t.lineTo(s,d-l);t.arc(s-l,d-l,l,f*0,f*90,false);t.lineTo(c+l,d);t.arc(c+l,d-l,l,f*90,f*180,false);t.lineTo(c,n+l);t.arc(c+l,n+l,l,f*180,f*270,false);t.closePath();if(o.cameraWidth==o.cameraFullWidth){t.font="bold 24px opensans"}else{t.font="bold 11px opensans"}t.fillStyle="#91ff4f";var u="";if(m[r]){u=m[r].name}t.fillText(u.toUpperCase(),c,n-5);t.stroke();t.restore()}catch(t){console.log("BAD VALUE OF DETECTION");console.log(t)}}function x(t){if(!t){var e=r.getContext("2d");e.drawImage(a,0,0,o.snapshotWidth,o.snapshotHeight);t=r.toDataURL("image/jpeg",1)}var i=new Image;i.onload=function(){var t=true;if(t){var e=E(r);D(e,i)}else{W(i.getAttribute("src"))}};i.src=t}function E(t,e){var i=[];var r=[];var c=[];_=false;var n=t.getContext("2d");n.drawImage(a,0,0,o.snapshotWidth,o.snapshotHeight);var s=t;var d=s.getContext("2d");var l=d.getImageData(0,0,o.snapshotWidth,o.snapshotHeight);g.set(l.data,0);h.submitRawImage(p,o.snapshotWidth,o.snapshotHeight);h.update();var f=h.getIds();var v=JSON.parse(f);var k=v["ids"];R(k);if(k.length){for(var B=0;B<k.length;B++){var X=k[B];var C=h.getSmoothedFaceDetection(X);var w=h.faceDetectionIsPredicted(X);var S=[145,255,79,255];var I="";var A=h.isSlowMovement(X);if(!A)I="TOO FAST!!!";if(w)I="PREDICT";if(w||!A){S=[255,0,0,255]}var T=JSON.parse(JSON.stringify(C));T.x=C.x*o.trackingRatio;T.y=C.y*o.trackingRatio;T.width=C.width*o.trackingRatio;T.height=C.height*o.trackingRatio;i.push({frameId:X,width:C.width,height:C.height,positionX:C.x,positionY:C.y})}var x=true;for(var E in i){if(u.indexOf(i[E].frameId)>-1){r.push(i[E]);_=true;if(x){break}}if(m[i[E].frameId]){r.push(i[E]);_=true;if(x){break}}}if(!x||x&&r.length==0){for(var E in i){if(!m[i[E].frameId]&&h.getBestShotFrameNumber(i[E].frameId)>=0&&h.getCurrentFrameNumber()>=h.getBestShotFrameNumber(i[E].frameId)){c.push(i[E]);r.push(i[E]);if(x){break}}}}}y(r);if(!_&&b){F()}b=_;if(!e){M()}return c}function F(){BX.hide(BX("faceid-tracker-workday-started"));BX.hide(BX("faceid-tracker-workday-opened"));BX.hide(BX("faceid-tracker-workday-paused"));BX.hide(BX("faceid-tracker-workday-ended"));X=null}function y(t){f.clearRect(0,0,l.width,l.height);var e,a,i;for(var r in t){var c=t[r];var n={};i=h.faceDetectionIsPredicted(c.frameId);e=[145,255,79,255];a=h.isSlowMovement(c.frameId);if(i||!a){e=[255,0,0,255]}n.x=c.positionX*o.trackingRatio;n.y=c.positionY*o.trackingRatio;n.width=c.width*o.trackingRatio;n.height=c.height*o.trackingRatio;T(f,n,10,e,c.frameId)}}function M(){requestAnimationFrame(function(){requestAnimationFrame(function(){h.reset();f.clearRect(0,0,l.width,l.height)})})}function D(t,e){var a=false;if(t.length>0){for(i=0;i<t.length;i++){{var r=t[i];var c=document.createElement("canvas");c.setAttribute("width",100);c.setAttribute("height",100);var n=c.getContext("2d");var s=.6;var d=Math.max(0,r.positionX-r.width*s/2);var o=Math.max(0,r.positionY-r.height*s/2);var l=r.width+r.width*s;var f=r.height+r.height*s;var u=100;var m=100;var h=0;var v=0;n.drawImage(e,d,o,l,f,h,v,u,m);var p=c.toDataURL("image/jpeg");W(p,r.frameId);a=true}}}if(!a){W(e.src,false,true)}}function W(t,e,a){BX.addClass(BX("faceid-tracker-main-user-start-block"),"faceid-tracker-animate-hidden");var i=BX.create("div",{attrs:{class:"faceid-tracker-main-user-item faceid-tracker-first-item"}});i.innerHTML='<div class="faceid-tracker-main-user-photo"> \t\t\t\t\t<div class="faceid-tracker-main-user-photo-platform"> \t\t\t\t\t\t<span class="faceid-tracker-main-user-photo-platform-item">CRM</span> \t\t\t\t\t</div> \t\t\t\t\t<div class="faceid-tracker-main-user-photo-item"> \t\t\t\t\t\t<img width="100" height="100"> \t\t\t\t\t</div> \t\t\t\t\t<div class="faceid-tracker-main-user-photo-count"> \t\t\t\t\t\t<span class="faceid-tracker-main-user-photo-count-item">58%</span> \t\t\t\t\t\t<div class="faceid-tracker-main-user-photo-count-info"> \t\t\t\t\t\t\t<div class="faceid-tracker-main-user-photo-count-info-desc"></div> \t\t\t\t\t\t\t<div class="faceid-tracker-main-user-photo-item"></div> \t\t\t\t\t\t</div> \t\t\t\t\t</div> \t\t\t\t</div> \t\t\t\t<div class="faceid-tracker-main-user-info"> \t\t\t\t\t<div class="faceid-tracker-user-loader"> \t\t\t\t\t\t<div class="faceid-tracker-user-loader-item"> \t\t\t\t\t\t\t<div class="faceid-tracker-loader"> \t\t\t\t\t\t\t\t<svg class="faceid-tracker-circular" viewBox="25 25 50 50"> \t\t\t\t\t\t\t\t\t<circle class="faceid-tracker-path" cx="50" cy="50" r="20" fill="none" stroke-width="1" stroke-miterlimit="10"/> \t\t\t\t\t\t\t\t</svg> \t\t\t\t\t\t\t</div> \t\t\t\t\t\t</div> \t\t\t\t\t</div> \t\t\t\t</div>';BX.prepend(i,BX("faceid-tracker-main-user-container"));var r=20;var c=BX.findChildren(BX("faceid-tracker-main-user-container"),{class:"faceid-tracker-main-user-item"});if(c.length>r){d=c[c.length-2].getAttribute("data-last-visit-ts");var n=c[c.length-1];n.remove()}var s=BX.findChild(i,{class:"faceid-tracker-main-user-photo-item"},true);var o=BX.findChild(s,{tag:"img"});o.setAttribute("src",t);if(a){BX.addClass(i,"faceid-tracker-user-warning");var l=BX.findChild(i,{class:"faceid-tracker-main-user-info"},true);l.innerHTML='<div class="faceid-tracker-main-user-info-name"> \t\t\t\t<div class="faceid-tracker-main-user-info-name-warning">'+BX.message("FACEID_TRACKERWD_CMP_JS_FACE_NOT_FOUND")+"</div> \t\t\t</div>"}else{var f=e>=0?e:"faceid-ajax-unique-"+Math.random();O(f);X={trackingFrameId:e};BX.ajax({url:"/bitrix/components/bitrix/faceid.timeman/ajax.php",method:"POST",data:{action:"identify",image:t,autoOpen:1},dataType:"json",processData:false,start:true,onsuccess:function(t){N(f);var a=false;var i=BX.message("FACEID_TRACKERWD_CMP_JS_FACE_NOT_FOUND");if(t.length&&X!==null&&X.trackingFrameId==e){var r=JSON.parse(t);if(r.visitor&&!K(r.visitor)){a=true;var c=r.visitor;X=c;if(r.action=="OPENED"){BX.show(BX("faceid-tracker-workday-started"))}else if(c.workday_status=="OPENED"){BX.show(BX("faceid-tracker-workday-opened"))}else if(c.workday_status=="PAUSED"){BX.show(BX("faceid-tracker-workday-paused"))}if(e>=0){m[e]={name:c.full_name}}}else if(r.error&&r.error.msg){if(e>=0&&r.error.code=="OK_UNKNOWN_PERSON"){m[e]={name:"UNKNOWN PERSON"}}i=r.error.msg}}if(!a){h.discardBestShot(e)}},onfailure:function(){N(f);h.discardBestShot(e)}})}}function O(t){u.push(t)}function N(t){var e=u.indexOf(t);if(e>-1){u.splice(e,1)}}function H(t,e){BX.addClass(BX("faceid-tracker-main-user-start-block"),"faceid-tracker-animate-hidden");var a=BX.create("div",{attrs:{class:"faceid-tracker-main-user-item faceid-tracker-first-item"}});var i=j(a,t);BX.prepend(a,BX("faceid-tracker-main-user-container"));if(t.last_visit_ts<d||d==null){d=t.last_visit_ts}if(i){L(t,e)}}function P(t,e){BX.addClass(BX("faceid-tracker-main-user-start-block"),"faceid-tracker-animate-hidden");var a=BX.create("div",{attrs:{class:"faceid-tracker-main-user-item faceid-tracker-first-item"}});var i=j(a,t);if(BX("faceid-tracker-main-user-more")){BX("faceid-tracker-main-user-container").insertBefore(a,BX("faceid-tracker-main-user-more"))}else{BX.append(a,BX("faceid-tracker-main-user-container"))}if(t.last_visit_ts<d||d==null){d=t.last_visit_ts}if(i){L(t,e)}}function L(t,e){e=typeof e!=="undefined"?e:true;BX("faceid-stats-current-count").innerText=parseInt(BX("faceid-stats-current-count").innerText)+1;if(e){if(t.visits_count<=1){BX("faceid-stats-new-count").innerText=parseInt(BX("faceid-stats-new-count").innerText)+1}else{BX("faceid-stats-old-count").innerText=parseInt(BX("faceid-stats-old-count").innerText)+1}BX("faceid-stats-total-count").innerText=parseInt(BX("faceid-stats-total-count").innerText)+1;if(t.crm_url.length){BX("faceid-stats-crm-count").innerText=parseInt(BX("faceid-stats-crm-count").innerText)+1}}}function j(t,e){var a=true;var i=typeof e=="string"?JSON.parse(e):e;t.setAttribute("data-visitor-id",i.visitor_id);var r=BX.findChildren(BX("faceid-tracker-main-user-container"),{attr:{"data-visitor-id":i.visitor_id}});if(r){var c;for(c in r){if(r[c]!=t){r[c].remove();a=false}}}if(i.confidence>0){BX.addClass(t,"faceid-tracker-photo")}if(i.crm_url.length>0){BX.addClass(t,"faceid-tracker-platform")}if(i.vk_id.length>0){BX.addClass(t,"faceid-tracker-social-state")}t.setAttribute("data-last-visit-ts",i.last_visit_ts);var n='<div class="faceid-tracker-main-user-photo"> \t\t\t\t\t\t<div class="faceid-tracker-main-user-photo-platform"> \t\t\t\t\t\t\t<span class="faceid-tracker-main-user-photo-platform-item">CRM</span> \t\t\t\t\t\t</div> \t\t\t\t\t\t<div class="faceid-tracker-main-user-photo-item"> \t\t\t\t\t\t\t<img width="100" height="100"> \t\t\t\t\t\t</div> \t\t\t\t\t\t<div class="faceid-tracker-main-user-photo-count"> \t\t\t\t\t\t\t<span class="faceid-tracker-main-user-photo-count-item">'+i.confidence+'%</span> \t\t\t\t\t\t\t<div class="faceid-tracker-main-user-photo-count-info"> \t\t\t\t\t\t\t\t<div class="faceid-tracker-main-user-photo-count-info-desc">'+BX.message("FACEID_TRACKERWD_CMP_JS_FACE_ORIGINAL")+'</div> \t\t\t\t\t\t\t\t<div class="faceid-tracker-main-user-photo-item" style="background-image: url('+i.image_src+')"></div> \t\t\t\t\t\t\t</div> \t\t\t\t\t\t</div> \t\t\t\t\t</div> \t\t\t\t\t<div class="faceid-tracker-main-user-info"> \t\t\t\t\t\t<div class="faceid-tracker-main-user-info-description"> \t\t\t\t\t\t\t<span class="faceid-tracker-main-user-info-description-item">'+i.visit_info+'</span> \t\t\t\t\t\t</div> \t\t\t\t\t\t<div class="faceid-tracker-main-user-info-name">';if(i.crm_url.length)n+='<a href="'+i.crm_url+'" class="faceid-tracker-main-user-info-name-item">'+i.name+"</a>";else n+='<div class="faceid-tracker-main-user-info-name-item">'+i.name+"</div>";n+='\t\t\t\t\t\t</div> \t\t\t\t\t\t<div class="faceid-tracker-main-user-info-control">';if(!i.crm_url.length)n+='\t\t\t\t\t\t\t<div class="faceid-tracker-main-user-info-control-block'+(i.crm_url.length?" faceid-tracker-button-state":"")+'"> \t\t\t\t\t\t\t\t<div class="webform-small-button webform-small-button-blue faceid-tracker-main-user-info-control-button">'+BX.message("FACEID_TRACKERWD_CMP_JS_SAVE_CRM")+' \t\t\t\t\t\t\t\t\t<div class="faceid-tracker-user-loader"> \t\t\t\t\t\t\t\t\t\t<div class="faceid-tracker-user-loader-item"> \t\t\t\t\t\t\t\t\t\t\t<div class="faceid-tracker-loader"> \t\t\t\t\t\t\t\t\t\t\t\t<svg class="faceid-tracker-circular" viewBox="25 25 50 50"> \t\t\t\t\t\t\t\t\t\t\t\t\t<circle class="faceid-tracker-path" cx="50" cy="50" r="20" fill="none" stroke-width="1" stroke-miterlimit="10"/> \t\t\t\t\t\t\t\t\t\t\t\t</svg> \t\t\t\t\t\t\t\t\t\t\t</div> \t\t\t\t\t\t\t\t\t\t</div> \t\t\t\t\t\t\t\t\t</div> \t\t\t\t\t\t\t\t</div> \t\t\t\t\t\t\t\t<div class="webform-small-button webform-small-button-transparent faceid-tracker-main-user-info-control-button">'+BX.message("FACEID_TRACKERWD_CMP_JS_SAVE_CRM_DONE")+"</div> \t\t\t\t\t\t\t</div>";n+='\t\t\t\t\t\t\t<div class="faceid-tracker-main-user-info-control-social"> \t\t\t\t\t\t\t\t<span class="faceid-tracker-main-user-info-control-social-name">'+BX.message("FACEID_TRACKERWD_CMP_JS_VK_LINK")+"</span>";if(i.vk_id.length)n+='\t\t\t\t\t\t\t\t\t<a href="http://vk.com/'+BX.util.htmlspecialchars(i.vk_id)+'" class="faceid-tracker-main-user-info-control-social-item">'+"VK.com/"+BX.util.htmlspecialchars(i.vk_id)+"</a>";else n+='\t\t\t\t\t\t\t\t\t<span class="faceid-tracker-main-user-info-control-social-item"><span>'+BX.message("FACEID_TRACKERWD_CMP_JS_VK_LINK_ACTION")+"</span></span>";n+="\t\t\t\t\t\t\t</div> \t\t\t\t\t\t</div> \t\t\t\t\t</div>";t.innerHTML=n;var s=BX.findChild(t,{class:"faceid-tracker-main-user-photo-item"},true);var d=BX.findChild(s,{tag:"img"});d.setAttribute("src",i.shot_src);if(!i.vk_id.length){var o=BX.clone(BX("faceid-tracker-profile-search-example"));o.id="";o.style.top=document.body.scrollTop+596+30+"px";var l=BX.findChild(t,{class:"faceid-tracker-main-user-info-control-social-item"},true);var f=BX.findChild(o,{class:"faceid-tracker-profile-search-header"},true);var u=0;var m=0;var h=function(t){var e=u-t.clientX;var a=m-t.clientY;o.style.left=parseInt(o.style.left)-e+"px";o.style.top=parseInt(o.style.top)-a+"px";u=t.clientX;m=t.clientY};var v=function(){BX.unbind(document,"mousemove",h);BX.unbind(document,"mouseup",v)};BX.bind(f,"mousedown",function(t){var e=BX.pos(o);o.style.left=e.left+"px";o.style.top=e.top+"px";u=t.clientX;m=t.clientY;o.style.transform="translate(0)";BX.bind(document,"mousemove",h);BX.bind(document,"mouseup",v)});document.body.appendChild(o);var p=BX.findChild(l,{tag:"span"});BX.bind(p,"click",function(){BX.show(o);if(o.getAttribute("data-in-progress")){return}o.setAttribute("data-in-progress","1");BX.ajax({url:"/bitrix/components/bitrix/faceid.tracker/ajax_vk.php",method:"POST",data:{action:"identify",image:i.shot_src,visitor_id:i.visitor_id},dataType:"json",processData:false,start:true,onsuccess:function(e){var a=JSON.parse(e);var r=a.items;if(a.status&&a.status.balance>=0){BX("faceid-credits-balance").innerText=a.status.balance}if(r.length){var c,n="";n=J(r[0],true);var s=BX.findChild(o,{class:"faceid-tracker-profile-search-main"},true);s.innerHTML=n+s.innerHTML;n="";r.splice(0,1);for(c in r){n+=J(r[c])}s=BX.findChild(o,{class:"faceid-tracker-profile-search-found-container"},true);s.innerHTML=n;var d=BX.findChild(o,{class:"faceid-tracker-profile-search-found-more-count"},true);d.innerHTML=r.length+" "+BX.message("FACEID_TRACKERWD_CMP_JS_VK_FOUND_PEOPLE");var f=BX.findChild(o,{class:"faceid-tracker-profile-search-loading"},true);BX.addClass(f,"faceid-tracker-animate-hidden");var u=BX.findChildren(o,{class:"faceid-tracker-main-user-info-control-button"},true);for(c in u){BX.bind(u[c],"click",function(){var e=BX(this).parentNode.parentNode;var a=BX.findChild(e,{class:"faceid-tracker-main-user-social-link-item"},true).innerText;var r=l.parentNode;l.remove();r.innerHTML+='<a href="http://'+a+'" class="faceid-tracker-main-user-info-control-social-item">'+a.replace("vk.com","VK.com")+"</a>";BX.addClass(t,"faceid-tracker-social-state");BX.hide(o);BX.ajax({url:"/bitrix/components/bitrix/faceid.tracker/ajax_vk.php",method:"POST",data:{action:"save",vk_id:a.replace("vk.com/",""),visitor_id:i.visitor_id},dataType:"json",processData:false,start:true,onsuccess:function(e){var a=JSON.parse(e);var r=BX.findChild(t,{class:"faceid-tracker-main-user-info-name"},true);r.innerHTML='<a href="'+a.url+'" class="faceid-tracker-main-user-info-name-item">'+i.name+"</a>"}})})}}else if(a.error&&a.error.msg){var f=BX.findChild(o,{class:"faceid-tracker-loader"},true);BX.hide(f);var m=BX.findChild(o,{class:"faceid-tracker-profile-search-loading-desc"},true);BX.hide(m);var h=BX.findChild(o,{class:"faceid-tracker-error"},true);h.innerHTML=a.error.msg;BX.show(h)}}})});var g=BX.findChild(o,{class:"faceid-tracker-header-description-close-item"},true);BX.bind(g,"click",function(){BX.hide(o)})}var k=BX.findChild(t,{class:"webform-small-button-blue"},true);BX.bind(k,"click",function(){var e=BX(this).parentNode;if(!BX.hasClass(e,"faceid-tracker-button-state")&&!BX.hasClass(e,"faceid-control-loader-state")){BX.addClass(e,"faceid-control-loader-state");BX.ajax({url:"/bitrix/components/bitrix/faceid.tracker/ajax_crm.php",method:"POST",data:{action:"addLead",lead_title:i.name,visitor_id:i.visitor_id},dataType:"json",processData:false,start:true,onsuccess:function(a){var r=JSON.parse(a);var c=BX.findChild(t,{class:"faceid-tracker-main-user-info-name"},true);c.innerHTML='<a href="'+r.url+'" class="faceid-tracker-main-user-info-name-item">'+i.name+"</a>";BX.removeClass(e,".faceid-control-loader-state");BX.addClass(e,"faceid-tracker-button-state")}})}});return a}function J(t,e){var a='<div class="faceid-tracker-main-user-item faceid-tracker-profile-search-found faceid-tracker-photo'+(e?" faceid-tracker-found-user":"")+'"> \t\t\t\t\t<div class="faceid-tracker-main-user-photo"> \t\t\t\t\t\t<div class="faceid-tracker-main-user-photo-platform"> \t\t\t\t\t\t\t<span class="faceid-tracker-main-user-photo-platform-item">CRM</span> \t\t\t\t\t\t</div> \t\t\t\t\t\t<div class="faceid-tracker-main-user-photo-item" style="background-image: url('+BX.util.htmlspecialchars(t.photo)+')"></div> \t\t\t\t\t\t<div class="faceid-tracker-main-user-photo-count"> \t\t\t\t\t\t\t<span class="faceid-tracker-main-user-photo-count-item">'+Math.round(t.confidence*100)+'%</span> \t\t\t\t\t\t</div> \t\t\t\t\t</div> \t\t\t\t\t<div class="faceid-tracker-main-user-info"> \t\t\t\t\t\t<div class="faceid-tracker-main-user-info-name"> \t\t\t\t\t\t\t<div class="faceid-tracker-main-user-info-name-item">'+BX.util.htmlspecialchars(t.name)+'</div> \t\t\t\t\t\t\t<div class="faceid-tracker-main-user-date"> \t\t\t\t\t\t\t\t<span class="faceid-tracker-main-user-date-item">'+BX.util.htmlspecialchars(t.personal)+'</span> \t\t\t\t\t\t\t</div> \t\t\t\t\t\t\t<div class="faceid-tracker-main-user-social-link"> \t\t\t\t\t\t\t\t<a href="http://vk.com/'+BX.util.htmlspecialchars(t.id)+'" class="faceid-tracker-main-user-social-link-item">vk.com/'+BX.util.htmlspecialchars(t.id)+'</a> \t\t\t\t\t\t\t</div> \t\t\t\t\t\t</div> \t\t\t\t\t\t<div class="faceid-tracker-main-user-info-control"> \t\t\t\t\t\t\t<div class="webform-small-button webform-small-button-blue faceid-tracker-main-user-info-control-button '+(e?"":"faceid-tracker-search-button")+'">'+BX.message("FACEID_TRACKERWD_CMP_JS_VK_SELECT")+"</div> \t\t\t\t\t\t</div> \t\t\t\t\t</div> \t\t\t\t</div>";return a}BX.ready(function(){BX.bind(BX("faceid-tracker-main-user-more"),"click",function(){if(!d){return}BX.ajax({url:"/bitrix/components/bitrix/faceid.tracker/ajax_more.php",method:"POST",data:{last:d},dataType:"json",processData:false,start:true,onsuccess:function(t){var e,a=JSON.parse(t);if(a.items.length){for(e in a.items){P(a.items[e],false)}}if(a.more==0){BX("faceid-tracker-main-user-more").remove()}}})});BX.bind(BX("faceid-tracker-header-description-close"),"click",function(){BX.localStorage.set("faceid-description-read","1",3600*24*360);BX(this).parentNode.remove()});if(!BX.localStorage.get("faceid-description-read")){BX.show(BX("faceid-tracker-header-description-close").parentNode)}BX.bind(BX("faceid-auto-identify"),"change",function(){if(!BX(this).checked){M()}})});function K(t){if(t.hasOwnProperty("length"))return t.length==0;for(var e in t){if(t.hasOwnProperty(e))return false}return JSON.stringify(t)===JSON.stringify({})}BX.bind(BX("faceid-fullscreen-button"),"click",function(){var t=a;var e=BX.findParent(t,{class:"faceid-tracker-wrapper"});var i=BX("faceid-video").parentNode;if(document.webkitFullscreenElement){document.webkitCancelFullScreen()}else{i.webkitRequestFullscreen()}});BX.bind(document,"webkitfullscreenchange",function(){var t=BX.findParent(a,{class:"faceid-tracker-wrapper"});var e=BX("faceid-fullscreen-button");BX.toggleClass(t,"faceid-tracker-full-mode");BX.toggle(e);BX.bind(t,"contextmenu",function(t){t.preventDefault()});if(!document.webkitFullscreenElement){o.cameraWidth=o.cameraSmallWidth;o.cameraHeight=o.cameraSmallHeight;o.trackingRatio=o.trackingSmallRatio}else{o.cameraWidth=o.cameraFullWidth;o.cameraHeight=o.cameraFullHeight;o.trackingRatio=o.trackingFullRatio}a.setAttribute("width",o.cameraWidth);a.setAttribute("height",o.cameraHeight);l.setAttribute("width",o.cameraWidth);l.setAttribute("height",o.cameraHeight)});BX.bind(BX("faceid-tracker-workday-action-end"),"click",function(){var t=X.id;U(t)});function U(t){BX.hide(BX("faceid-tracker-workday-opened"));BX.ajax({url:"/bitrix/components/bitrix/faceid.timeman/ajax.php",method:"POST",data:{action:"close",id:t},dataType:"json",processData:false,start:true,onsuccess:function(e){if(X&&X.id==t){BX.show(BX("faceid-tracker-workday-ended"))}}})}}
//# sourceMappingURL=script.map.js