this.BX=this.BX||{};this.BX.Humanresources=this.BX.Humanresources||{};(function(t,e,s,n,r,i,a,d,o,l,c,p){"use strict";const h={name:"headUsers",props:{users:{type:Array,required:true},showPlaceholder:{type:Boolean,default:true},userType:String},created(){this.headItemsCount=2;this.userTypes={head:"head",deputy:"deputy"}},computed:{defaultAvatar(){return"/bitrix/js/humanresources/company-structure/org-chart/src/images/default-user.svg"},placeholderAvatar(){return"/bitrix/js/humanresources/company-structure/chart-wizard/src/components/tree-preview/images/placeholder-avatar.svg"}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)}},template:`\n\t\t<div\n\t\t\tclass="chart-wizard-tree-preview__node_head"\n\t\t\tv-for="(user, index) in users.slice(0, headItemsCount)"\n\t\t>\n\t\t\t<img\n\t\t\t\t:src="user.avatar || defaultAvatar"\n\t\t\t\tclass="chart-wizard-tree-preview__node_head-avatar --placeholder"\n\t\t\t\t:class="{ '--deputy': userType === userTypes.deputy }"\n\t\t\t/>\n\t\t\t<div class="chart-wizard-tree-preview__node_head-text">\n\t\t\t\t<span class="chart-wizard-tree-preview__node_head-name --crop">\n\t\t\t\t\t{{user.name}}\n\t\t\t\t</span>\n\t\t\t\t<span v-if="userType !== userTypes.deputy" class="chart-wizard-tree-preview__node_head-position --crop">\n\t\t\t\t\t{{user.workPosition || loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_HEAD_POSITION')}}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t\t<span\n\t\t\t\tv-if="index === 1 && users.length > 2"\n\t\t\t\tclass="chart-wizard-tree-preview__node_head-rest"\n\t\t\t\t>\n\t\t\t\t\t{{'+' + String(users.length - 2)}}\n\t\t\t</span>\n\t\t</div>\n\t\t<div\n\t\t\tv-if="users.length === 0 && showPlaceholder"\n\t\t\tclass="chart-wizard-tree-preview__node_head"\n\t\t>\n\t\t\t<img\n\t\t\t\t:src="placeholderAvatar"\n\t\t\t\tclass="chart-wizard-tree-preview__node_head-avatar --placeholder"\n\t\t\t\t:class="{'--deputy': userType === userTypes.deputy }"\n\t\t\t/>\n\t\t\t<div class="chart-wizard-tree-preview__node_head-text">\n\t\t\t\t<span class="chart-wizard-tree-preview__placeholder_name"></span>\n\t\t\t\t<span\n\t\t\t\t\tv-if="userType !== userTypes.deputy"\n\t\t\t\t\tclass="chart-wizard-tree-preview__node_head-position --crop"\n\t\t\t\t>\n\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_HEAD_POSITION')}}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t</div>\n\t`};const _={name:"treeNode",components:{HeadUsers:h},props:{department:Object,name:String,heads:Array,userCount:Number,nodeId:Number},computed:{departmentData(){if(this.isExistingDepartment){return this.department}return{name:this.name,heads:this.heads,userCount:this.userCount}},isExistingDepartment(){return Boolean(this.nodeId)},employeesCount(){var t;return(this.userCount||0)-(((t=this.heads)==null?void 0:t.length)||0)},headUsers(){return this.departmentData.heads.filter((t=>t.role===o.memberRoles.head))},deputyUsers(){return this.departmentData.heads.filter((t=>t.role===o.memberRoles.deputyHead))},showInfo(){return this.nodeId?s.PermissionChecker.getInstance().hasPermission(s.PermissionActions.structureView,this.nodeId):true}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},locPlural(t,e){return i.Loc.getMessagePlural(t,e,{"#COUNT#":e})}},template:`\n\t\t<div\n\t\t\tclass="chart-wizard-tree-preview__node"\n\t\t\t:class="{ '--new': !isExistingDepartment }"\n\t\t>\n\t\t\t<div class="chart-wizard-tree-preview__node_summary">\n\t\t\t\t<p class="chart-wizard-tree-preview__node_name --crop">\n\t\t\t\t\t{{departmentData.name}}\n\t\t\t\t</p>\n\t\t\t\t<HeadUsers\n\t\t\t\t\tv-if="showInfo"\n\t\t\t\t\t:users="headUsers"\n\t\t\t\t\t:showPlaceholder="!isExistingDepartment"\n\t\t\t\t/>\n\t\t\t\t<div\n\t\t\t\t\tv-if="showInfo && !isExistingDepartment"\n\t\t\t\t\tclass="chart-wizard-tree-preview__node_employees"\n\t\t\t\t>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<p class="chart-wizard-tree-preview__node_employees-title">\n\t\t\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TREE_PREVIEW_EMPLOYEES_TITLE')}}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<span class="chart-wizard-tree-preview__node_employees_count">\n\t\t\t\t\t\t\t{{locPlural('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TREE_PREVIEW_EMPLOYEES_COUNT', employeesCount)}}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="chart-wizard-tree-preview__node_deputies">\n\t\t\t\t\t\t<p class="chart-wizard-tree-preview__node_employees-title">\n\t\t\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TREE_PREVIEW_DEPUTIES_TITLE')}}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<HeadUsers\n\t\t\t\t\t\t\t:users="deputyUsers"\n\t\t\t\t\t\t\tuserType="deputy"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<slot v-if="isExistingDepartment"></slot>\n\t\t</div>\n\t`};const m={name:"treePreview",components:{TreeNode:_},props:{parentId:{type:[Number,null],required:true},name:{type:String,required:true},heads:{type:Array,required:true},userCount:{type:Number,required:true}},computed:{rootId(){const t=this.departments.get(this.parentId);if(t){var e;return(e=t.parentId)!=null?e:0}return 0},companyName(){const{name:t}=[...this.departments.values()].find((t=>t.parentId===0));return t},...c.mapState(e.useChartStore,["departments"])},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)}},template:`\n\t\t<div class="chart-wizard-tree-preview">\n\t\t\t<div class="chart-wizard-tree-preview__header">\n\t\t\t\t<span class="chart-wizard-tree-preview__header_text">\n\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_TREE_PREVIEW_DEPARTMENT_TITLE')}}\n\t\t\t\t</span>\n\t\t\t\t<span class="chart-wizard-tree-preview__header_name">\n\t\t\t\t\t{{companyName}}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t\t<TreeNode\n\t\t\t\tv-if="rootId"\n\t\t\t\t:nodeId="rootId"\n\t\t\t\t:department="departments.get(rootId)"\n\t\t\t>\n\t\t\t\t<TreeNode\n\t\t\t\t\t:nodeId="parentId"\n\t\t\t\t\t:department="departments.get(parentId)"\n\t\t\t\t>\n\t\t\t\t\t<TreeNode\n\t\t\t\t\t\t:name="name"\n\t\t\t\t\t\t:heads="heads"\n\t\t\t\t\t\t:userCount="userCount"\n\t\t\t\t\t></TreeNode>\n\t\t\t\t</TreeNode>\n\t\t\t</TreeNode>\n\t\t\t<TreeNode\n\t\t\t\tv-else-if="parentId"\n\t\t\t\t:nodeId="parentId"\n\t\t\t\t:department="departments.get(parentId)"\n\t\t\t>\n\t\t\t\t<TreeNode\n\t\t\t\t\t:name="name"\n\t\t\t\t\t:heads="heads"\n\t\t\t\t\t:userCount="userCount"\n\t\t\t\t></TreeNode>\n\t\t\t</TreeNode>\n\t\t\t<TreeNode\n\t\t\t\tv-else\n\t\t\t\t:name="name"\n\t\t\t\t:heads="heads"\n\t\t\t\t:userCount="userCount"\n\t\t\t></TreeNode>\n\t\t</div>\n\t`};const u={name:"department",emits:["applyData"],props:{parentId:{type:[Number,null],required:true},name:{type:String,required:true},description:{type:String,required:true},shouldErrorHighlight:{type:Boolean,required:true},isEditMode:{type:Boolean}},data(){return{deniedError:false}},created(){this.selectedParentDepartment=this.parentId;this.departmentName=this.name;this.departmentDescription=this.description;this.departmentsSelector=this.getTagSelector()},mounted(){this.departmentsSelector.renderTo(this.$refs["tag-selector"])},activated(){this.applyData();this.$refs.title.focus()},methods:{getTagSelector(){return new d.TagSelector({events:{onTagAdd:t=>{const{tag:e}=t.data;this.selectedParentDepartment=e.id},onTagRemove:()=>{this.selectedParentDepartment=null;this.applyData()}},multiple:false,locked:this.parentId===0,dialogOptions:{width:425,height:350,dropdownMode:true,hideOnDeselect:true,entities:[{id:"structure-node",options:{selectMode:"departmentsOnly"}}],preselectedItems:this.parentId?[["structure-node",this.parentId]]:[],events:{onLoad:t=>{var e,n,r;if(this.isEditMode){return}const i=s.PermissionChecker.getInstance();if(!i){return}const a=t.target;const d=(e=a.selectedItems)==null?void 0:(n=e.values())==null?void 0:(r=n.next())==null?void 0:r.value;const o=a.items.get("structure-node");for(const[,t]of o){if(i.hasPermission(s.PermissionActions.departmentCreate,t.id)&&!i.hasPermission(s.PermissionActions.departmentCreate,d==null?void 0:d.id)){t.select();break}}},onLoadError:()=>{this.selectedParentDepartment=null;this.applyData()},"Item:onSelect":t=>{var e,n,r;this.deniedError=false;const i=t.target;const a=(e=i.selectedItems)==null?void 0:(n=e.values())==null?void 0:(r=n.next())==null?void 0:r.value;const d=s.PermissionChecker.getInstance();if(!d){return}if(!d.hasPermission(s.PermissionActions.departmentCreate,a.id)){this.deniedError=true}this.applyData()}}},tagBgColor:"#ade7e4",tagTextColor:"#207976",tagFontWeight:"700",tagAvatar:"/bitrix/js/humanresources/entity-selector/src/images/department.svg"})},loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},applyData(){this.$emit("applyData",{name:this.departmentName,description:this.departmentDescription,parentId:this.selectedParentDepartment,isValid:this.departmentName!==""&&this.selectedParentDepartment!==null&&!this.deniedError})}},template:`\n\t\t<div class="chart-wizard__department">\n\t\t\t<div class="chart-wizard__form">\n\t\t\t\t<div class="chart-wizard__department_item">\n\t\t\t\t\t<span class="chart-wizard__department_item-label">\n\t\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_HIGHER_LABEL')}}\n\t\t\t\t\t</span>\n\t\t\t\t\t<div\n\t\t\t\t\t\t:class="{ 'ui-ctl-warning': deniedError || (selectedParentDepartment === null && shouldErrorHighlight) }"\n\t\t\t\t\t\tref="tag-selector"></div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="deniedError || (selectedParentDepartment === null && shouldErrorHighlight)"\n\t\t\t\t\t\tclass="chart-wizard__department_item-error"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="ui-icon-set --warning"></div>\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tv-if="deniedError"\n\t\t\t\t\t\t\tclass="chart-wizard__department_item-error-message"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ADD_TO_DEPARTMENT_DENIED_MSG_VER_1')}}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tv-else\n\t\t\t\t\t\t\tclass="chart-wizard__department_item-error-message"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_PARENT_ERROR')}}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__department_item">\n\t\t\t\t\t<span class="chart-wizard__department_item-label">\n\t\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_NAME_LABEL')}}\n\t\t\t\t\t</span>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="ui-ctl ui-ctl-textbox"\n\t\t\t\t\t\t:class="{ 'ui-ctl-warning': shouldErrorHighlight && departmentName === '' }"\n\t\t\t\t\t>\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\tv-model="departmentName"\n\t\t\t\t\t\t\ttype="text"\n\t\t\t\t\t\t\tmaxlength="255"\n\t\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t\tref="title"\n\t\t\t\t\t\t\t:placeholder="loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_NAME_PLACEHOLDER')"\n\t\t\t\t\t\t\t@input="applyData()"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="shouldErrorHighlight && departmentName === ''"\n\t\t\t\t\t\tclass="chart-wizard__department_item-error"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="ui-icon-set --warning"></div>\n\t\t\t\t\t\t<span class="chart-wizard__department_item-error-message">\n\t\t\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_NAME_ERROR')}}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__department_item">\n\t\t\t\t\t<span class="chart-wizard__department_item-label">\n\t\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_DESCR_LABEL')}}\n\t\t\t\t\t</span>\n\t\t\t\t\t<div class="ui-ctl ui-ctl-textarea ui-ctl-no-resize">\n\t\t\t\t\t\t<textarea\n\t\t\t\t\t\t\tv-model="departmentDescription"\n\t\t\t\t\t\t\tmaxlength="255"\n\t\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t\t:placeholder="loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_DESCR_PLACEHOLDER')"\n\t\t\t\t\t\t\t@change="applyData()"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t</textarea>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const E=Object.freeze({moveUsers:"moveUsers",addUsers:"addUsers"});const R={name:"changeSaveModeControl",emits:["saveModeChanged"],components:{RouteActionMenu:n.RouteActionMenu},created(){this.menuItems=this.getMenuItems()},data(){return{menuVisible:false,actionId:E.moveUsers}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onActionMenuItemClick(t){this.actionId=t;this.$emit("saveModeChanged",t)},getMenuItems(){return[{id:E.moveUsers,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_SAVE_MODE_MOVE_USERS_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_SAVE_MODE_MOVE_USERS_DESCRIPTION"),bIcon:{name:r.Main.PERSON_ARROW_LEFT_1,size:20,color:p.getColorCode("paletteBlue50")}},{id:E.addUsers,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_SAVE_MODE_ADD_USERS_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_SAVE_MODE_ADD_USERS_DESCRIPTION"),bIcon:{name:r.CRM.PERSON_PLUS_2,size:20,color:p.getColorCode("paletteBlue50")}}]}},computed:{getControlButtonText(){const t=this.actionId===E.moveUsers?"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_SAVE_MODE_MOVE_USERS_TITLE":"HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_SAVE_MODE_ADD_USERS_TITLE";return this.loc(t)}},template:`\n\t\t<div \n\t\t\tclass="chart-wizard__change-save-mode-control-container"\n\t\t>\n\t\t\t<span>{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_SAVE_MODE_CONTROL_TEXT') }}</span>\n\t\t\t<a\n\t\t\t\tclass="chart-wizard__change-save-mode-control-button"\n\t\t\t\t:class="{ '--focused': menuVisible }"\n\t\t\t\tref='changeSaveModeButton'\n\t\t\t\t@click="menuVisible = true"\n\t\t\t>\n\t\t\t\t{{ getControlButtonText }}\n\t\t\t</a>\n\t\t</div>\n\t\t<RouteActionMenu\n\t\t\tv-if="menuVisible"\n\t\t\t:id="'hr-wizard-save-mode-menu'"\n\t\t\t:items="menuItems"\n\t\t\t:width="302"\n\t\t\t:bindElement="$refs.changeSaveModeButton"\n\t\t\t@action="onActionMenuItemClick"\n\t\t\t@close="menuVisible = false"\n\t\t/>\n\t`};const v={name:"employees",components:{ChangeSaveModeControl:R},emits:["applyData","saveModeChanged"],props:{heads:{type:Array,required:true},employeesIds:{type:Array,required:true},isEditMode:{type:Boolean,required:true}},created(){this.selectedUsers=new Set;this.departmentHeads=[];this.departmentEmployees=[];this.removedUsers=[];this.headSelector=this.getUserSelector(o.memberRoles.head);this.deputySelector=this.getUserSelector(o.memberRoles.deputyHead);this.employeesSelector=this.getUserSelector(o.memberRoles.employee);this.userCount=0},mounted(){this.headSelector.renderTo(this.$refs["head-selector"]);this.deputySelector.renderTo(this.$refs["deputy-selector"]);this.employeesSelector.renderTo(this.$refs["employees-selector"])},watch:{employeesIds:{handler(t){const e=t.map((t=>["user",t]));const{dialog:s}=this.employeesSelector;s.setPreselectedItems(e);s.load()}}},methods:{getPreselectedItems(t){if(o.memberRoles.employee===t){return this.employeesIds.map((t=>["user",t]))}return this.heads.filter((e=>e.role===t)).map((t=>["user",t.id]))},getUserSelector(t){const e=new d.TagSelector({events:{onTagAdd:e=>{const{tag:s}=e.getData();this.selectedUsers.add(s.id);this.processTag(s,t);this.applyData()},onTagRemove:e=>{const{tag:s}=e.getData();this.selectedUsers.delete(s.id);this.processTag(s,t);this.applyData()}},multiple:true,dialogOptions:{preselectedItems:this.getPreselectedItems(t),popupOptions:{events:{onBeforeShow:()=>{s.setHeight(250);if(s.isLoaded()){this.toggleUsers(s)}}}},events:{onShow:()=>{const{dialog:t}=e;const s=t.getContainer();const{top:n}=s.getBoundingClientRect();const r=n+s.offsetHeight-document.body.offsetHeight;if(r>0){const e=5;t.setHeight(s.offsetHeight-r-e)}},onLoad:t=>{this.toggleUsers(s);const e=t.target.items.get("user");e.forEach((t=>{t.setLink("")}))},"SearchTab:onLoad":()=>{this.toggleUsers(s)}},height:250,width:380,entities:[{id:"user",options:{intranetUsersOnly:true,showInvitationFooter:false}}],dropdownMode:true,hideOnDeselect:false}});const s=e.getDialog();return e},loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},toggleUsers(t){const e=t.getItems();e.forEach((e=>{const s=this.selectedUsers.has(e.id)&&!t.selectedItems.has(e);e.setHidden(s)}))},processTag(t,e){const s={MEMBER_HEAD:()=>this.onHeadToggle(t,e),MEMBER_DEPUTY_HEAD:()=>this.onHeadToggle(t,e),MEMBER_EMPLOYEE:()=>this.onEmployeeToggle(t)};s[e]()},getUserData(t){var e;const{id:s,avatar:n,title:r,selector:i,link:a}=t;const d=i.dialog.getItems();const{customData:o}=d.find((t=>t.id===s));const l=(e=o.get("position"))!=null?e:"";return{id:s,avatar:n,name:r.text,url:a,workPosition:l}},onHeadToggle(t,e){const s=this.getUserData(t);if(t.rendered){if(!this.removedUsers.includes(s)){this.removedUsers=[...this.removedUsers,{...s,role:o.memberRoles.employee}]}this.departmentHeads=this.departmentHeads.filter((e=>e.id!==t.id));this.userCount-=1;return}this.departmentHeads=[...this.departmentHeads,{...s,role:e}];this.userCount+=1},onEmployeeToggle(t){const e=this.getUserData(t);if(t.rendered){if(!this.removedUsers.includes(e)){this.removedUsers=[...this.removedUsers,{...e,role:o.memberRoles.employee}]}this.departmentEmployees=this.departmentEmployees.filter((e=>e.id!==t.id));this.userCount-=1;return}this.departmentEmployees=[...this.departmentEmployees,{...e,role:o.memberRoles.employee}];this.userCount+=1},applyData(){this.$emit("applyData",{heads:this.departmentHeads,employees:this.departmentEmployees,removedUsers:this.removedUsers,userCount:this.userCount})},handleSaveModeChangedChanged(t){this.$emit("saveModeChanged",t)}},template:`\n\t\t<div class="chart-wizard__employee">\n\t\t\t<div class="chart-wizard__form">\n\t\t\t\t<div class="chart-wizard__employee_item">\n\t\t\t\t\t<span class="chart-wizard__employee_item-label">\n\t\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_HEAD_TITLE')}}\n\t\t\t\t\t</span>\n\t\t\t\t\t<div class="chart-wizard__employee_selector" ref="head-selector"></div>\n\t\t\t\t\t<span class="chart-wizard__employee_item-description">\n\t\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_HEAD_DESCR')}}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__employee_item">\n\t\t\t\t\t<span class="chart-wizard__employee_item-label">\n\t\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_DEPUTY_TITLE')}}\n\t\t\t\t\t</span>\n\t\t\t\t\t<div class="chart-wizard__employee_selector" ref="deputy-selector"></div>\n\t\t\t\t\t<span class="chart-wizard__employee_item-description">\n\t\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_DEPUTY_DESCR')}}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__employee_item">\n\t\t\t\t\t<span class="chart-wizard__employee_item-label">\n\t\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_EMPLOYEES_TITLE')}}\n\t\t\t\t\t</span>\n\t\t\t\t\t<div class="chart-wizard__employee_selector" ref="employees-selector"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__employee_item --change-save-mode-control">\n\t\t\t\t\t<ChangeSaveModeControl v-if="!isEditMode" @saveModeChanged="handleSaveModeChangedChanged"/>\n\t\t\t\t\t<div class="chart-wizard__change-save-mode-control-container" v-else>\n\t\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_EDIT_WIZARD_EMPLOYEE_SAVE_MODE_TEXT')}}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const S={name:"bindChat",created(){this.hints=[this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_HINT_1"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_HINT_2")];this.chatSelector=this.getChatSelector()},mounted(){this.chatSelector.renderTo(this.$refs["chat-selector"])},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},getChatSelector(){const t=new d.TagSelector({events:{},multiple:true,locked:true,dialogOptions:{height:250,width:380,dropdownMode:true,hideOnDeselect:true}});t.getDialog().freeze();return t}},template:`\n\t\t<div class="chart-wizard__bind-chat">\n\t\t\t<div class="chart-wizard__bind-chat__item">\n\t\t\t\t<div class="chart-wizard__bind-chat__item-hint">\n\t\t\t\t\t<div class="chart-wizard__bind-chat__item-hint__logo"></div>\n\t\t\t\t\t<div class="chart-wizard__bind-chat__item-hint__text">\n\t\t\t\t\t\t<div v-for="hint in hints"\n\t\t\t\t\t\t\t class="chart-wizard__bind-chat__item-hint__text-item"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<div class="chart-wizard__bind-chat__item-hint__text-item__icon"></div>\n\t\t\t\t\t\t\t<span>{{ hint }}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__bind-chat__item-options">\n\t\t\t\t\t<div class="chart-wizard__bind-chat__item-options__item-content__title">\n\t\t\t\t\t\t<div class="chart-wizard__bind-chat__item-options__item-content__title-text">\n\t\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT') }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<span class="chart-wizard__bind-chat__item-options__item-content__title-not-available">\n\t\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_OPTION_NOT_AVAILABLE') }}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="chart-wizard__chat_selector" ref="chat-selector" disabled="disabled"></div>\n\t\t\t\t\t<span class="chart-wizard__employee_item-description">\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_SELECT_CHAT_DESCRIPTION') }}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const U={data(){return{selectedId:"department"}},emits:["applyData"],created(){this.entities=[{id:"department",title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_DEPARTMENT_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_DEPARTMENT_DESCR")},{id:"group",title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_FUNCTIONAL_GROUP_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_FUNCTIONAL_GROUP_DESCR")},{id:"company",title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_COMPANY_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_COMPANY_DESCR")}]},activated(){this.applyData()},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},applyData(){this.$emit("applyData",{isValid:true})}},template:`\n\t\t<div\n\t\t\tv-for="entity in entities"\n\t\t\tclass="chart-wizard__entity"\n\t\t\t:class="{ ['--' + entity.id]: true, '--selected': entity.id === selectedId }"\n\t\t>\n\t\t\t<div class="chart-wizard__entity_summary" @click="applyData">\n\t\t\t\t<h2\n\t\t\t\t\tclass="chart-wizard__entity_title"\n\t\t\t\t\t:data-title="entity.id !== 'department' ? loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_ENTITY_ACCESS_TITLE') : null"\n\t\t\t\t\t:class="{ '--disabled': entity.id !== 'department' }"\n\t\t\t\t>\n\t\t\t\t\t{{entity.title}}\n\t\t\t\t</h2>\n\t\t\t\t<p class="chart-wizard__entity_description" :class="{ '--disabled': entity.id !== 'department'}">\n\t\t\t\t\t{{entity.description}}\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t</div>\n\t`};const T={addDepartment:(t,e,s)=>o.postData("humanresources.api.Structure.Node.add",{name:t,parentId:e,description:s}),getEmployees:t=>o.postData("humanresources.api.Structure.Node.Member.Employee.getIds",{nodeId:t}),updateDepartment:(t,e,s,n)=>o.postData("humanresources.api.Structure.Node.update",{nodeId:t,name:s,parentId:e,description:n}),saveUsers:(t,e,s)=>o.postData("humanresources.api.Structure.Node.Member.saveUserList",{nodeId:t,userIds:e,parentId:s}),moveUsers:(t,e,s)=>o.postData("humanresources.api.Structure.Node.Member.moveUserListToDepartment",{nodeId:t,userIds:e,parentId:s})};const C=Object.freeze({moveUsers:"moveUsers",addUsers:"addUsers"});const I={name:"chartWizard",emits:["modifyTree","close"],components:{Department:u,Employees:v,BindChat:S,TreePreview:m,Entities:U},props:{nodeId:{type:Number,required:true},isEditMode:{type:Boolean,required:true},showEntitySelector:{type:Boolean,required:false},entity:{type:String},source:{type:String}},data(){return{stepIndex:0,waiting:false,isValidStep:false,departmentData:{id:0,parentId:0,name:"",description:"",heads:[],employees:[],userCount:0},removedUsers:[],employeesIds:[],shouldErrorHighlight:false,visibleSteps:[],saveMode:C.moveUsers}},created(){this.steps=[{id:"entities",title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_SELECT_ENTITY_TITLE")},{id:"department",title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DEPARTMENT_TITLE")},{id:"employees",title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEES_TITLE")},{id:"bindChat",title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BINDCHAT_TITLE")}];this.init()},beforeUnmount(){i.Event.unbind(window,"beforeunload",this.handleBeforeUnload)},computed:{stepTitle(){if(this.isFirstStep&&!this.isEditMode){return this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_CREATE")}const t=this.visibleSteps[0]==="entities"?this.stepIndex:this.stepIndex+1;return this.isEditMode?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EDIT_TITLE"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_STEP_PROGRESS",{"#CURRENT_STEP#":t,"#MAX_STEP#":this.steps.length-1})},currentStep(){const t=this.visibleSteps[this.stepIndex];return this.steps.find((e=>t===e.id))},componentInfo(){const{parentId:t,name:e,description:s,heads:n}=this.departmentData;const r={department:{name:"Department",params:{parentId:t,name:e,description:s,shouldErrorHighlight:this.shouldErrorHighlight,isEditMode:this.isEditMode},hasData:true},employees:{name:"Employees",params:{heads:n,employeesIds:this.employeesIds,isEditMode:this.isEditMode},hasData:true},bindChat:{name:"BindChat"},entities:{name:"Entities",hasData:true}};const{id:i}=this.currentStep;return r[i]},isFirstStep(){return this.currentStep.id==="entities"},filteredSteps(){return this.visibleSteps.filter((t=>t!=="entities"))},...c.mapWritableState(e.useChartStore,["departments"])},methods:{handleBeforeUnload(t){t.preventDefault()},loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},async init(){i.Event.bind(window,"beforeunload",this.handleBeforeUnload);this.createVisibleSteps();if(this.isEditMode){const{id:t,name:e,description:s,parentId:n,heads:r,userCount:i,children:a,employees:d=[]}=this.departments.get(this.nodeId);this.departmentData={...this.departmentData,id:t,parentId:n,name:e,description:s,heads:r,userCount:i,children:a,employees:d};this.employeesIds=await T.getEmployees(this.nodeId);return}if(this.nodeId){this.departmentData.parentId=this.nodeId;return}const{id:t}=[...this.departments.values()].find((t=>t.parentId===0));this.departmentData.parentId=t;l.sendData({tool:"structure",category:"structure",event:"create_wizard",c_element:this.source})},createVisibleSteps(){switch(this.entity){case"department":this.visibleSteps=["department"];break;case"employees":this.visibleSteps=["employees"];break;default:this.visibleSteps=this.showEntitySelector?this.steps.map((t=>t.id)):this.steps.filter((t=>t.id!=="entities")).map((t=>t.id));break}},move(t="next"){if(t==="next"&&!this.isValidStep){this.shouldErrorHighlight=true;return}this.stepIndex=t==="back"?this.stepIndex-1:this.stepIndex+1;switch(this.currentStep.id){case"department":l.sendData({tool:"structure",category:"structure",event:"create_dept_step1",c_element:this.source});break;case"employees":l.sendData({tool:"structure",category:"structure",event:"create_dept_step2",c_element:this.source});break;case"bindChat":l.sendData({tool:"structure",category:"structure",event:"create_dept_step3",c_element:this.source});break}},close(t=false){this.$emit("close");if(t){l.sendData({tool:"structure",category:"structure",event:"cancel_wizard",c_element:this.source})}},onApplyData(t){const{isValid:e=true,removedUsers:s,...n}=t;this.isValidStep=e;if(n){this.departmentData={...this.departmentData,...n}}if((s==null?void 0:s.length)>0){this.removedUsers=s}if(e){this.shouldErrorHighlight=false}},getUsersPromise(t){const e=this.calculateEmployeeIds();const{headsIds:s,deputiesIds:n,employeesIds:r}=e;const i={[o.memberRoles.head]:s,[o.memberRoles.deputyHead]:n,[o.memberRoles.employee]:r};return this.getUserMemberPromise(t,i)},calculateEmployeeIds(){const{heads:t,employees:e=[]}=this.departmentData;return[...t,...e].reduce(((t,e)=>{const{headsIds:s,deputiesIds:n,employeesIds:r}=t;if(e.role===o.memberRoles.head){s.push(e.id)}else if(e.role===o.memberRoles.deputyHead){n.push(e.id)}else{r.push(e.id)}return t}),{headsIds:[],deputiesIds:[],employeesIds:[]})},getUserMemberPromise(t,e,s){var n;if(this.isEditMode){return T.saveUsers(t,e)}const r=Object.values(e).some((t=>t.length>0));if(!r){return Promise.resolve()}const i=(n=this.departmentData.parentId)!=null?n:null;if(this.saveMode===C.moveUsers){return T.moveUsers(t,e,i)}return T.saveUsers(t,e,i)},async create(){var t;const{name:e,parentId:s,description:n}=this.departmentData;let r=0;let i="";this.waiting=true;try{const[t]=await T.addDepartment(e,s,n);r=t.id;i=t.accessCode;const a=await this.getUsersPromise(r);if(a!=null&&a.updatedDepartmentIds){void p.refreshDepartments(a.updatedDepartmentIds)}}finally{this.waiting=false}const a=this.departments.get(s);a.children=[...(t=a.children)!=null?t:[],r];this.departments.set(r,{...this.departmentData,id:r,accessCode:i});this.$emit("modifyTree",{id:r,parentId:s,showConfetti:true});const{headsIds:d,deputiesIds:o,employeesIds:c}=this.calculateEmployeeIds();l.sendData({tool:"structure",category:"structure",event:"create_dept",c_element:this.source,p2:`headAmount_${d.length}`,p3:`secondHeadAmount_${o.length}`,p4:`employeeAmount_${c.length}`});this.close()},async save(){if(!this.isValidStep){this.shouldErrorHighlight=true;return}const{id:t,parentId:e,name:s,description:n}=this.departmentData;const r=this.departments.get(t);const i=(r==null?void 0:r.parentId)===e?null:e;this.waiting=true;const a=this.entity==="employees"?this.getUsersPromise(t):Promise.resolve();const d=this.entity==="department"?T.updateDepartment(t,i,s,n):Promise.resolve();switch(this.entity){case"department":l.sendData({tool:"structure",category:"structure",event:"edit_dept_name",c_element:this.source,p1:(r==null?void 0:r.parentId)===e?"editHead_N":"editHeadDept_Y",p2:(r==null?void 0:r.name)===s?"editName_N":"editName_Y"});break;case"employees":const{headsIds:t,deputiesIds:n,employeesIds:i}=this.calculateEmployeeIds();l.sendData({tool:"structure",category:"structure",event:"edit_dept_employee",c_element:this.source,p2:`headAmount_${t.length}`,p3:`secondHeadAmount_${n.length}`,p4:`employeeAmount_${i.length}`});break}try{var o;const[s]=await Promise.all([a,d]);const n=(o=s==null?void 0:s.userMovedToRootIds)!=null?o:0;if((n==null?void 0:n.length)>0&&this.removedUsers.length>0){const t=this.removedUsers.filter((t=>n.includes(t.id)));const e=[...this.departments.values()].find((t=>t.parentId===0));e.employees=[...e.employees||[],...t];e.userCount+=t.length}this.departments.set(t,{...this.departmentData});const r=[...this.departments.values()].find((e=>{var s;return(s=e.children)==null?void 0:s.includes(t)}));if(e!==0&&r.id!==e){var c;r.children=r.children.filter((e=>e!==t));const s=this.departments.get(e);s.children=[...(c=s.children)!=null?c:[],t];this.departments.set(t,{...this.departmentData,prevParentId:r.id})}}catch(t){console.error(t);return}finally{this.waiting=false}this.$emit("modifyTree",{id:t,parentId:e});this.close()},handleSaveModeChanged(t){this.saveMode=t}},template:`\n\t\t<div class="chart-wizard">\n\t\t\t<div class="chart-wizard__dialog" :style="{ 'max-width': !isEditMode && isFirstStep ? '643px' : '883px' }">\n\t\t\t\t<div class="chart-wizard__head">\n\t\t\t\t\t<div class="chart-wizard__head_close" @click="close(true)"></div>\n\t\t\t\t\t<p class="chart-wizard__head_title">{{ stepTitle }}</p>\n\t\t\t\t\t<p class="chart-wizard__head_descr">{{ currentStep.title }}</p>\n\t\t\t\t\t<div class="chart-wizard__head_stages" v-if="!isFirstStep && !isEditMode">\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-for="n in filteredSteps.length"\n\t\t\t\t\t\t\tclass="chart-wizard__head_stage"\n\t\t\t\t\t\t\t:class="{ '--completed': stepIndex >= (this.showEntitySelector ? n : n - 1) }"\n\t\t\t\t\t\t></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__content" :style="{ display: !isEditMode && isFirstStep ? 'block' : 'flex' }">\n\t\t\t\t\t<KeepAlive>\n\t\t\t\t\t\t<component\n\t\t\t\t\t\t\t:is="componentInfo.name"\n\t\t\t\t\t\t\tv-bind="componentInfo.params"\n\t\t\t\t\t\t\tv-on="{\n\t\t\t\t\t\t\t\tapplyData: componentInfo.hasData ? onApplyData : undefined,\n\t\t\t\t\t\t\t\tsaveModeChanged: componentInfo.name === 'Employees' ? handleSaveModeChanged : undefined\n\t\t\t\t\t\t\t}"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t</component>\n\t\t\t\t\t</KeepAlive>\n\t\t\t\t\t<TreePreview\n\t\t\t\t\t\tv-if="isEditMode || !isFirstStep"\n\t\t\t\t\t\t:parentId="departmentData.parentId"\n\t\t\t\t\t\t:name="departmentData.name"\n\t\t\t\t\t\t:heads="departmentData.heads"\n\t\t\t\t\t\t:userCount="departmentData.userCount"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div class="chart-wizard__footer">\n\t\t\t\t\t<button\n\t\t\t\t\t\tv-if="stepIndex > 0"\n\t\t\t\t\t\tclass="ui-btn ui-btn-light --back"\n\t\t\t\t\t\t@click="move('back')"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div class="ui-icon-set --chevron-left"></div>\n\t\t\t\t\t\t<span>{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_BACK_BTN') }}</span>\n\t\t\t\t\t</button>\n\t\t\t\t\t<button\n\t\t\t\t\t\tv-show="stepIndex < visibleSteps.length - 1 && !isEditMode"\n\t\t\t\t\t\tclass="ui-btn ui-btn-primary ui-btn-round --next"\n\t\t\t\t\t\t:class="{ 'ui-btn-disabled': !isValidStep, 'ui-btn-light-border': isEditMode }"\n\t\t\t\t\t\t@click="move()"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_NEXT_BTN') }}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button\n\t\t\t\t\t\tv-show="isEditMode"\n\t\t\t\t\t\tclass="ui-btn ui-btn-primary ui-btn-round --next"\n\t\t\t\t\t\t:class="{ 'ui-btn-light-border': isEditMode }"\n\t\t\t\t\t\t@click="close(true)"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_DISCARD_BTN') }}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button\n\t\t\t\t\t\tv-show="!isEditMode && stepIndex === visibleSteps.length - 1"\n\t\t\t\t\t\tclass="ui-btn ui-btn-primary ui-btn-round"\n\t\t\t\t\t\t:class="{ 'ui-btn-wait': waiting }"\n\t\t\t\t\t\t@click="create"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_CREATE_BTN') }}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button\n\t\t\t\t\t\tv-show="isEditMode"\n\t\t\t\t\t\tclass="ui-btn ui-btn-primary ui-btn-round --save"\n\t\t\t\t\t\t:class="{ 'ui-btn-wait': waiting, 'ui-btn-disabled': !isValidStep, }"\n\t\t\t\t\t\t@click="save"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_SAVE_BTN') }}\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="chart-wizard__overlay"></div>\n\t\t</div>\n\t`};t.ChartWizard=I})(this.BX.Humanresources.CompanyStructure=this.BX.Humanresources.CompanyStructure||{},BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX.UI.IconSet,BX,BX,BX.UI.EntitySelector,BX.Humanresources.CompanyStructure,BX.UI.Analytics,BX.Vue3.Pinia,BX.Humanresources.CompanyStructure);
//# sourceMappingURL=chart-wizard.bundle.map.js