this.BX=this.BX||{};this.BX.Humanresources=this.BX.Humanresources||{};(function(t,e,n,s,o,i,r,a,d,c,l,h,u,m,p,E,_,T,R,C,v,S,f,D,I,A,M){"use strict";const N=Object.freeze({HR_DEPARTMENT_CONNECT:"hr-department-connect",HR_DEPARTMENT_DISCONNECT:"hr-department-disconnect",HR_DEPARTMENT_ADAPT_SIBLINGS:"hr-department-adapt-siblings",HR_DEPARTMENT_ADAPT_CONNECTOR_HEIGHT:"hr-department-adapt-connector-height",HR_DEPARTMENT_FOCUS:"hr-department-focus",HR_DEPARTMENT_CONTROL:"hr-department-control",HR_DEPARTMENT_MENU_CLOSE:"hr-department-menu-close",HR_ORG_CHART_CLOSE_BY_ESC:"SidePanel.Slider:onCloseByEsc",HR_ORG_CHART_CLOSE:"SidePanel.Slider:onClose",HR_FIRST_POPUP_SHOW:"HR.company-structure:first-popup-showed",HR_DEPARTMENT_SLIDER_ON_MESSAGE:"SidePanel.Slider:onMessage"});const U=Object.freeze({addDepartment:"add-department",addEmployee:"add-employee"});const g={name:"AddButton",emits:["addDepartment"],data(){return{actionMenu:{visible:false}}},components:{RouteActionMenu:m.RouteActionMenu},mounted(){const t=M.PermissionChecker.getInstance();if(!t){return}this.dropdownItems=[{id:U.addDepartment,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_ADD_BUTTON_MENU_ADD_DEPARTMENT_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_ADD_BUTTON_MENU_ADD_DEPARTMENT_DESCR"),bIcon:{name:p.Main.CUBE_PLUS,size:20,color:D.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.departmentCreate}},{id:U.addEmployee,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_ADD_BUTTON_MENU_ADD_EMPLOYEE_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_ADD_BUTTON_MENU_ADD_EMPLOYEE_DESCR"),bIcon:{name:p.CRM.PERSON_PLUS_2,size:20,color:D.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.employeeAddToDepartment}}];this.dropdownItems=this.dropdownItems.filter((e=>{if(!e.permission){return false}return t.hasPermissionOfAction(e.permission.action)}))},computed:{MenuOption(){return U}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},addDepartment(){this.$emit("addDepartment")},actionMenuItemClickHandler(t){if(t===U.addDepartment){this.$emit("addDepartment")}}},template:`\n\t\t<div class="ui-btn ui-btn-success ui-btn-round ui-btn-sm" @click="addDepartment">\n\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_ADD_BUTTON') }}\n\t\t</div>\n\t`};const P={applyData:(t,e,n)=>{const s=S.useChartStore();s.$patch({departments:t,currentDepartments:e,userId:n,searchedUserId:n})},focusDepartment:t=>{const e=S.useChartStore();e.focusedNode=t},searchUserInDepartment:t=>{const e=S.useChartStore();e.searchedUserId=t},moveSubordinatesToParent:t=>{const e=S.useChartStore();const{departments:n,currentDepartments:s}=e;const o=n.get(t);const{parentId:i,children:r=[],userCount:a,heads:d,employees:c=[]}=o;r.forEach((t=>{const e=n.get(t);e.parentId=i}));const h=n.get(i);if(a>0){var u,m;const t=new Set([...h.heads,...(u=h.employees)!=null?u:[]].map((t=>t.id)));const e=[...d,...c];const n=e.filter((e=>!t.has(e.id)));for(const t of n){t.role=l.memberRoles.employee}h.userCount+=n.length;h.employees=[...(m=h.employees)!=null?m:[],...n]}h.children=[...h.children,...r];if(s.includes(t)){e.changeCurrentDepartment(t,i)}},markDepartmentAsRemoved:t=>{const{departments:e}=S.useChartStore();const n=e.get(t);const{parentId:s}=n;const o=e.get(s);o.children=o.children.filter((e=>e!==t));delete n.parentId;e.set(t,{...n,prevParentId:s})},removeDepartment:t=>{const{departments:e}=S.useChartStore();e.delete(t)},inviteUser:t=>{const{nodeId:e,...n}=t;const{departments:s}=S.useChartStore();const o=s.get(e);if(o.employees){s.set(e,{...o,employees:[...o.employees,{...n}],userCount:o.userCount+1})}}};const O={components:{BIcon:v.BIcon},directives:{focus:{mounted(t){t.focus()}}},data(){return{canEditPermissions:false,showSearchBar:false}},created(){this.searchDialog=this.getSearchDialog()},name:"search-bar",emits:["locate"],computed:{set(){return v.Set},...E.mapState(S.useChartStore,["departments"])},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},showSearchbar(){if(this.showSearchBar){this.showSearchBar=false;return}I.sendData({tool:"structure",category:"structure",event:"search"});this.showSearchBar=true},hideSearchbar(){this.showSearchBar=false},getSearchDialog(){const t=new o.Dialog({width:425,height:320,multiple:false,entities:[{id:"user",searchFields:[{name:"supertitle",type:"string",system:true,searchable:true},{name:"position",type:"string"}],options:{intranetUsersOnly:true,emailUsers:false,inviteEmployeeLink:false}},{id:"structure-node",options:{selectMode:"onlyDepartments",flatMode:true,fillRecentTab:true}}],recentTabOptions:{id:"recents",visible:true},dropdownMode:true,enableSearch:false,hideOnDeselect:false,context:"HR_STRUCTURE",events:{"Item:onSelect":e=>{const n=e.getData().item;if(n.entityType==="employee"){this.$emit("locate",n.customData.get("nodeId"));P.searchUserInDepartment(n.id);t.recentItemsToSave.push(n);t.saveRecentItems();return}t.recentItemsToSave.push(n);t.saveRecentItems();this.$emit("locate",n.id)},onLoad:t=>{t.target.items.get("user").forEach((t=>{if(!t.getSubtitle()){t.setSubtitle(t.customData.get("position"))}}))},"SearchTab:onLoad":t=>{t.target.items.get("user").forEach((t=>{if(!t.getSubtitle()){t.setSubtitle(t.customData.get("position"))}}))},onDestroy:()=>{this.searchDialog=this.getSearchDialog()}}});return t},onEnter(){if(this.$refs.searchName){this.searchDialog.setTargetNode(this.$refs.searchName);if(!this.searchDialog.isOpen()){this.searchDialog.show()}a.Event.bind(window,"mousedown",this.handleClickOutside)}},handleClickOutside(t){if(this.$refs.searchName&&!this.$refs.searchName.parentElement.contains(t.target)&&!this.searchDialog.isOpen()){this.clearSearch();this.hideSearchbar();a.Event.unbind(window,"mousedown",this.handleClickOutside)}},search(t){if(!this.searchDialog.isOpen()){this.searchDialog.show()}this.searchDialog.search(t)},clearSearch(){this.searchDialog.getSearchTab().clearResults();this.searchDialog.selectTab("recents");if(this.$refs.searchName){this.$refs.searchName.value="";this.$refs.searchName.focus()}}},watch:{departments:{handler(){this.searchDialog.destroy()},deep:true}},template:`\n\t\t<div\n\t\t    class="humanresources-title-panel-search-bar-container"\n\t\t    :class="{'--opened': showSearchBar}"\n\t\t>\n\t\t  <div\n\t\t      class="humanresources-title-panel-search-bar-block__search"\n\t\t      @click="showSearchbar"\n\t\t  >\n\t\t    <BIcon :name="set.SEARCH_2" :size="24" class="hr-title-search-icon"></BIcon>\n\t\t  </div>\n\t\t  <transition name="humanresources-title-panel-search-bar-fade" mode="in-out" @after-enter="onEnter">\n\t\t    <div v-if="showSearchBar"\n\t\t         class="humanresources-title-panel-search-bar-block__search-bar"\n\t\t    >\n\t\t      <input\n\t\t          ref="searchName"\n\t\t          key="searchInput"\n\t\t          type="text"\n\t\t          :placeholder="loc('HUMANRESOURCES_SEARCH_PLACEHOLDER')"\n\t\t          v-focus\n\t\t          class="humanresources-title-panel-search-bar-block__search-input"\n\t\t          @click="onEnter"\n\t\t          @input="search($event.target.value)"\n\t\t      >\n\t\t      <div\n\t\t          key="searchReset"\n\t\t          @click="clearSearch"\n\t\t          class="humanresources-title-panel-search-bar-block__search-reset"\n\t\t      >\n\t\t        <div class="humanresources-title-panel-search-bar-block__search-cursor"></div>\n\t\t        <BIcon\n\t\t            :name="set.CROSS_CIRCLE_50"\n\t\t            :size="24"\n\t\t            color="#2FC6F6"\n\t\t        ></BIcon>\n\t\t      </div>\n\t\t    </div>\n\t\t  </transition>\n\t\t</div>\n\t`};const y=Object.freeze({accessRights:"access-rights"});const b={name:"BurgerMenuButton",data(){return{actionMenu:{visible:false}}},components:{RouteActionMenu:m.RouteActionMenu},mounted(){this.dropdownItems=[{id:y.accessRights,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIG_PERMISSION_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIG_PERMISSION_DESCR"),bIcon:{name:p.Main.SHIELD,size:20,color:D.getColorCode("paletteBlue50")}}]},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},actionMenuItemClickHandler(t){if(t===y.accessRights){I.sendData({tool:"structure",category:"structure",event:"open_roles"});BX.SidePanel.Instance.open("/hr/config/permission/",{usePadding:true})}}},template:`\n\t\t<span\n\t\t\tref="burgerMenuButton"\n\t\t\t@click="actionMenu.visible = true"\n\t\t>\n\t\t\t<svg\n\t\t\t\tviewBox="0 0 24 24"\n\t\t\t\tfill="none"\n\t\t\t\tclass="humanresources-title-panel__icon"\n\t\t\t\t:class="{'--selected': actionMenu.visible }"\n\t\t\t\t>\n\t\t\t\t\t<path fill-rule="evenodd" clip-rule="evenodd" d="M18.7067 15.5577C18.8172 15.5577 18.9067 15.6473 18.9067 15.7577L18.9067 17.2424C18.9067 17.3528 18.8172 17.4424 18.7067 17.4424H5.29375C5.1833 17.4424 5.09375 17.3528 5.09375 17.2424L5.09379 15.7577C5.09379 15.6473 5.18333 15.5577 5.29379 15.5577H18.7067ZM18.7067 11.5577C18.8172 11.5577 18.9067 11.6473 18.9067 11.7577L18.9067 13.2424C18.9067 13.3528 18.8172 13.4424 18.7067 13.4424H5.29375C5.1833 13.4424 5.09375 13.3528 5.09375 13.2424L5.09379 11.7577C5.09379 11.6473 5.18333 11.5577 5.29379 11.5577H18.7067ZM18.7067 7.55774C18.8172 7.55774 18.9067 7.64729 18.9067 7.75774L18.9067 9.24238C18.9067 9.35284 18.8172 9.44238 18.7067 9.44238H5.29375C5.1833 9.44238 5.09375 9.35283 5.09375 9.24237L5.09379 7.75773C5.09379 7.64728 5.18333 7.55774 5.29379 7.55774H18.7067Z" fill="#525C69"/>\n\t\t\t</svg>\n\t\t </span>\n\t\t<RouteActionMenu\n\t\t\tv-if="actionMenu.visible"\n\t\t\tid="title-panel-burger-menu"\n\t\t\t:items="dropdownItems"\n\t\t\t:bindElement="this.$refs.burgerMenuButton"\n\t\t\t@action="actionMenuItemClickHandler($event)"\n\t\t\t@close="this.actionMenu.visible = false"\n\t\t/>\n\t`};const H={components:{AddButton:g,BurgerMenuButton:b,SearchBar:O,BIcon:v.BIcon,Set:v.Set},data(){return{canEditPermissions:false,canAddNode:false,toolbarStarActive:false,isHovered:false}},created(){this.toolbarStarElement=document.getElementById("uiToolbarStar")},mounted(){try{const t=M.PermissionChecker.getInstance();this.canEditPermissions=t&&t.hasPermissionOfAction(M.PermissionActions.accessEdit);this.canAddNode=t&&t.hasPermissionOfAction(M.PermissionActions.departmentCreate)}catch(t){console.error("Failed to fetch data:",t)}const t=new MutationObserver((()=>{this.toolbarStarActive=a.Dom.hasClass(this.toolbarStarElement,"ui-toolbar-star-active")}));t.observe(this.toolbarStarElement,{attributes:true,attributeFilter:["class"]});this.toolbarStarActive=a.Dom.hasClass(this.toolbarStarElement,"ui-toolbar-star-active")},name:"title-panel",emits:["showWizard","locate"],computed:{set(){return v.Set},toolbarStarIcon(){return this.toolbarStarActive?this.set.FAVORITE_1:this.set.FAVORITE_0}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},addDepartment(){this.$emit("showWizard",{source:l.AnalyticsSourceType.HEADER})},onLocate(t){this.$emit("locate",t)},triggerFavoriteStar(){this.toolbarStarElement.click();r.UI.Notification.Center.notify({content:this.toolbarStarActive?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_LEFT_MENU_UN_SAVED"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_LEFT_MENU_SAVED"),autoHideDelay:2e3})}},template:`\n\t\t<div class="humanresources-title-panel">\n\t\t  <p class="humanresources-title-panel__title">\n\t\t    {{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_TITLE') }}\n\t\t  </p>\n\t\t  <BIcon :name="isHovered ? set.FAVORITE_1 : toolbarStarIcon" :size="24" class="humanresources-title-panel__star"\n\t\t               @mouseover="isHovered = true"\n\t\t               @mouseleave="isHovered = false" @click="triggerFavoriteStar"\n\t\t  ></BIcon>\n\t\t  <div class="humanresources-title-panel__separator"></div>\n\t\t  <AddButton\n\t\t\t  v-if="canAddNode"\n\t\t      @addDepartment="addDepartment"\n\t\t  />\n\t\t  <div class="humanresources-title-panel__separator" v-if="canAddNode"></div>\n\t\t  <BurgerMenuButton v-if="canEditPermissions"/>\n\t\t  <div class="humanresources-title-panel__separator" v-if="canEditPermissions"></div>\n\t\t  <SearchBar @locate="onLocate"/>\n\t\t</div>\n\t`};const L={name:"headList",components:{UserListActionMenu:m.UserListActionMenu},props:{items:{type:Array,required:false,default:()=>[]},title:{type:String,required:false,default:""},collapsed:{type:Boolean,required:false,default:false},type:{type:String,required:false,default:"head"}},data(){return{isCollapsed:false,isUpdating:true,headsVisible:false}},created(){this.userTypes={head:"head",deputy:"deputy"}},computed:{defaultAvatar(){return"/bitrix/js/humanresources/company-structure/org-chart/src/images/default-user.svg"},dropdownItems(){return this.items.map((t=>{const e=t.workPosition||this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_HEAD_POSITION");return{...t,workPosition:e}}))},titleBar(){return this.type===this.userTypes.deputy?this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_DEPUTY_TITLE"):this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_WIZARD_EMPLOYEE_HEAD_TITLE")}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},handleUserClick(t){d.SidePanel.Instance.open(t,{cacheable:false})},closeHeadList(){this.headsVisible=false;c.EventEmitter.unsubscribe(N.HR_DEPARTMENT_MENU_CLOSE,this.closeHeadList)},openHeadList(){this.headsVisible=true;c.EventEmitter.subscribe(N.HR_DEPARTMENT_MENU_CLOSE,this.closeHeadList)}},template:`\n\t\t<div v-if="items.length">\n\t\t\t<p v-if="title" class="humanresources-tree__node_employees-title">\n\t\t\t\t{{ title }}\n\t\t\t</p>\n\t\t\t<div\n\t\t\t\tclass="humanresources-tree__node_head"\n\t\t\t\t:class="{ '--collapsed': collapsed }"\n\t\t\t\tv-for="(item, index) in items.slice(0, 2)"\n\t\t\t>\n\t\t\t\t<img\n\t\t\t\t\t:src="item.avatar ? encodeURI(item.avatar) : defaultAvatar"\n\t\t\t\t\tclass="humanresources-tree__node_avatar --head"\n\t\t\t\t\t:class="{ '--collapsed': collapsed }"\n\t\t\t\t\t@click.stop="handleUserClick(item.url)"\n\t\t\t\t/>\n\t\t\t\t<div class="humanresources-tree__node_head-text">\n\t\t\t\t\t<span\n\t\t\t\t\t\t:bx-tooltip-user-id="item.id"\n\t\t\t\t\t\tclass="humanresources-tree__node_head-name"\n\t\t\t\t\t\t@click.stop="handleUserClick(item.url)"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ item.name }}\n\t\t\t\t\t</span>\n\t\t\t\t\t<span v-if="!collapsed" class="humanresources-tree__node_head-position">\n\t\t\t\t\t\t{{ item.workPosition || loc('HUMANRESOURCES_COMPANY_STRUCTURE_HEAD_POSITION') }}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<span\n\t\t\t\t\tv-if="index === 1 && items.length > 2"\n\t\t\t\t\tclass="humanresources-tree__node_head-rest"\n\t\t\t\t\t:class="{ '--active': headsVisible }"\n\t\t\t\t\t:data-test-id="'hr-company-structure_org-chart-tree__node-' + type + '-rest'"\n\t\t\t\t\tref="showMoreHeadList"\n\t\t\t\t\t@click.stop="openHeadList"\n\t\t\t\t>\n\t\t\t\t\t{{ '+' + String(items.length - 2) }}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t</div>\n\t\t<UserListActionMenu\n\t\t\tv-if="headsVisible"\n\t\t\t:id="type === userTypes.head ? 'head-list-popup-head' : 'head-list-popup-deputy'"\n\t\t\t:items="dropdownItems"\n\t\t\t:width="228"\n\t\t\t:bindElement="$refs.showMoreHeadList[0]"\n\t\t\t@close="closeHeadList"\n\t\t\t:titleBar="titleBar"\n\t\t/>\n\t`};const w=Object.freeze({editDepartment:"editDepartment",addDepartment:"addDepartment",editEmployee:"editEmployee",moveEmployee:"moveEmployee",addEmployee:"addEmployee",userInvite:"userInvite",removeDepartment:"removeDepartment"});const B={name:"DepartmentMenuButton",emits:["addDepartment","editDepartment","moveEmployee","addEmployee","removeDepartment","editEmployee","userInvite"],props:{departmentId:{type:Number,required:true}},components:{RouteActionMenu:m.RouteActionMenu},created(){this.menuItems=[];this.permissionChecker=M.PermissionChecker.getInstance();if(!this.permissionChecker){return}this.menuItems=[{id:w.editDepartment,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_DEPARTMENT_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_DEPARTMENT_SUBTITLE"),bIcon:{name:p.Main.EDIT_PENCIL,size:20,color:D.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.departmentEdit}},{id:w.addDepartment,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_DEPARTMENT_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_DEPARTMENT_SUBTITLE"),bIcon:{name:p.Main.CUBE_PLUS,size:20,color:D.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.departmentCreate}},{id:w.editEmployee,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_EMPLOYEE_LIST_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_EMPLOYEE_LIST_SUBTITLE"),imageClass:"-hr-department-org-chart-menu-edit-list",bIcon:{name:p.Main.EDIT_MENU,size:20,color:D.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.employeeAddToDepartment}},{id:w.moveEmployee,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_MOVE_EMPLOYEE_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_MOVE_EMPLOYEE_SUBTITLE"),bIcon:{name:p.Main.PERSON_ARROW_LEFT_1,size:20,color:D.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.employeeAddToDepartment}},{id:w.userInvite,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_USER_INVITE_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_USER_INVITE_SUBTITLE"),bIcon:{name:p.Main.PERSON_LETTER,size:20,color:D.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.inviteToDepartment}},{id:w.addEmployee,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_EMPLOYEE_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_EMPLOYEE_SUBTITLE"),bIcon:{name:p.CRM.PERSON_PLUS_2,size:20,color:D.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.employeeAddToDepartment}},{id:w.removeDepartment,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_REMOVE_DEPARTMENT_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_REMOVE_DEPARTMENT_SUBTITLE"),bIcon:{name:p.Main.TRASH_BIN,size:20,color:D.getColorCode("paletteRed40")},permission:{action:M.PermissionActions.departmentDelete}}];this.menuItems=this.menuItems.filter((t=>{if(!t.permission){return false}return this.permissionChecker.hasPermission(t.permission.action,this.departmentId)}))},data(){return{menu:{visible:false}}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onActionMenuItemClick(t){this.$emit(t,t)},closeMenu(){this.menu.visible=false;c.EventEmitter.unsubscribe(N.HR_DEPARTMENT_MENU_CLOSE,this.closeMenu)},openMenu(){this.menu.visible=true;c.EventEmitter.subscribe(N.HR_DEPARTMENT_MENU_CLOSE,this.closeMenu)}},template:`\n\t\t<div\n\t\t\tv-if="menuItems.length"\n\t\t\tclass="ui-icon-set --more humanresources-tree__node_department-menu-button"\n\t\t\t:class="{ '--focused': this.menu.visible }"\n\t\t\tref="departmentMenuButton"\n\t\t\t@click.stop="openMenu"\n\t\t>\n\t\t</div>\n\n\t\t<RouteActionMenu\n\t\t\tv-if="menu.visible"\n\t\t\t:id="'tree-node-department-menu-' + departmentId"\n\t\t\t:width="302"\n\t\t\t:items="menuItems"\n\t\t\t:bindElement="this.$refs.departmentMenuButton"\n\t\t\t@action="onActionMenuItemClick"\n\t\t\t@close="closeMenu"\n\t\t/>\n\t`};const x={name:"SubdivisionAddButton",emits:["addDepartment"],props:{departmentId:{type:Number,required:true}},components:{BIcon:v.BIcon},created(){const t=M.PermissionChecker.getInstance();this.canShow=t&&t.hasPermission(M.PermissionActions.departmentCreate,this.departmentId)},computed:{set(){return v.Set}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},addSubdivision(t){this.$emit("addDepartment")}},template:`\n\t\t<div class="humanresources-tree__node_add-subdivision" v-if="canShow">\n\t\t  <button class="humanresources-tree__node_add-button" @click="addSubdivision">\n\t\t    <BIcon :name="set.PLUS_20" :size="32" class="humanresources-tree__node_add-icon"></BIcon>\n\t\t  </button>\n\t\t</div>\n\t`};const $={name:"treeNode",inject:["getTreeBounds"],props:{nodeId:{type:Number,required:true},expandedNodes:{type:Array,required:true},zoom:{type:Number,required:true},currentDepartment:{type:Number,required:true}},emits:["calculatePosition"],components:{DepartmentMenuButton:B,HeadList:L,SubdivisionAddButton:x},directives:{hint:m.Hint},data(){return{childrenOffset:0,childrenMounted:false,showInfo:true}},created(){this.width=278;this.gap=20;this.prevChildrenOffset=0;this.prevHeight=0},watch:{async head(){await this.$nextTick();c.EventEmitter.emit(N.HR_DEPARTMENT_ADAPT_CONNECTOR_HEIGHT,{nodeId:this.nodeId,shift:this.$el.offsetHeight-this.prevHeight});this.prevHeight=this.$el.offsetHeight}},async mounted(){this.showInfo=M.PermissionChecker.getInstance().hasPermission(M.PermissionActions.structureView,this.nodeId);this.$emit("calculatePosition",this.nodeId);await this.$nextTick();this.prevHeight=this.$el.offsetHeight;c.EventEmitter.emit(N.HR_DEPARTMENT_CONNECT,{id:this.nodeId,parentId:this.nodeData.parentId,html:this.$el,parentsPath:this.getParentsPath(this.nodeData.parentId),...this.calculateNodePoints()})},unmounted(){a.Dom.remove(this.$el);const{prevParentId:t}=this.nodeData;if(!t){return}this.$emit("calculatePosition",this.nodeId);c.EventEmitter.emit(N.HR_DEPARTMENT_DISCONNECT,{id:this.nodeId,parentId:t})},computed:{nodeData(){return this.departments.get(this.nodeId)},nodeClass(){return{"--expanded":this.expandedNodes.includes(this.nodeId),"--current-department":this.isCurrentDepartment,"--focused":this.focusedNode===this.nodeId,"--with-restricted-access-rights":!this.showInfo}},subdivisionsClass(){return{"humanresources-tree__node_arrow":this.hasChildren,"--up":this.hasChildren&&this.isExpanded,"--down":this.hasChildren&&!this.isExpanded,"--transparent":!this.hasChildren}},hasChildren(){var t;return((t=this.nodeData.children)==null?void 0:t.length)>0},isExpanded(){const t=this.expandedNodes.includes(this.nodeId);if(t){this.childrenMounted=true}return t},isCurrentDepartment(){return this.currentDepartment===this.nodeId},head(){var t;return(t=this.nodeData.heads)==null?void 0:t.filter((t=>t.role===l.memberRoles.head))},deputy(){var t;return(t=this.nodeData.heads)==null?void 0:t.filter((t=>t.role===l.memberRoles.deputyHead))},employeeCount(){return this.nodeData.userCount-this.nodeData.heads.length},childNodeStyle(){return{left:`${this.childrenOffset}px`}},showSubdivisionAddButton(){return this.expandedNodes.includes(this.nodeId)||this.focusedNode===this.nodeId},...E.mapState(S.useChartStore,["departments","focusedNode"])},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onDepartmentClick(t){if(!this.showInfo){return}c.EventEmitter.emit(N.HR_DEPARTMENT_FOCUS,{nodeId:this.nodeId,showEmployees:t==="employees",subdivisionsSelected:t==="subdivisions"})},calculatePosition(t){const e=this.departments.get(this.nodeId);if(e.children.length===0){this.childrenOffset=0}else{const t=this.gap*(e.children.length-1);this.prevChildrenOffset=this.childrenOffset;this.childrenOffset=(this.width-(this.width*e.children.length+t))/2}const n=this.childrenOffset-this.prevChildrenOffset;if(n!==0){c.EventEmitter.emit(N.HR_DEPARTMENT_ADAPT_SIBLINGS,{parentId:this.nodeId,nodeId:t,offset:n})}},controlDepartment(t,e=l.AnalyticsSourceType.CARD){c.EventEmitter.emit(N.HR_DEPARTMENT_CONTROL,{nodeId:this.nodeId,action:t,source:e})},addEmployee(){u.UserManagementDialog.openDialog({nodeId:this.nodeId,type:"add"})},userInvite(){const t=this.departments.get(this.nodeId).accessCode.slice(1);BX.SidePanel.Instance.open("/bitrix/services/main/ajax.php?action=getSliderContent"+"&c=bitrix%3Aintranet.invitation&mode=ajax"+`&departments[]=${t}&firstInvitationBlock=invite-with-group-dp`,{cacheable:false,allowChangeHistory:false,width:1100})},moveEmployee(){u.UserManagementDialog.openDialog({nodeId:this.nodeId,type:"move"})},locPlural(t,e){return a.Loc.getMessagePlural(t,e,{"#COUNT#":e})},calculateNodePoints(){const{left:t,top:e,width:n}=this.$el.getBoundingClientRect();const{$el:s}=this.$parent.$parent;const{left:o,top:i,width:r,height:a}=s.getBoundingClientRect();const{x:d,y:c}=this.getTreeBounds();return{startPoint:{x:(o-d+r/2)/this.zoom,y:(i-c+a)/this.zoom},endPoint:{x:(t-d+n/2)/this.zoom,y:(e-c)/this.zoom}}},getParentsPath(t){let e=t;const n=[t];while(e){const t=this.departments.get(e);e=t.parentId;if(e){n.push(e)}}return n}},template:`\n\t\t<div\n\t\t\t:data-id="nodeId"\n\t\t\t:class="nodeClass"\n\t\t\t:data-title="isCurrentDepartment ? loc('HUMANRESOURCES_COMPANY_CURRENT_DEPARTMENT') : null"\n\t\t\tclass="humanresources-tree__node"\n\t\t>\n\t\t\t<div\n\t\t\t\tclass="humanresources-tree__node_summary"\n\t\t\t\t@click.stop="onDepartmentClick('department')"\n\t\t\t>\n\t\t\t\t<div class="humanresources-tree__node_description">\n\t\t\t\t\t<div class="humanresources-tree__node_department">\n\t\t\t\t\t\t<span class="humanresources-tree__node_department-title">\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tv-hint\n\t\t\t\t\t\t\t\tclass="humanresources-tree__node_department-title_text"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{{nodeData.name}}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<DepartmentMenuButton\n\t\t\t\t\t\t\tv-if="showInfo && head && deputy"\n\t\t\t\t\t\t\t:department-id="nodeId"\n\t\t\t\t\t\t\t@addDepartment="controlDepartment"\n\t\t\t\t\t\t\t@editDepartment="controlDepartment"\n\t\t\t\t\t\t\t@editEmployee="controlDepartment"\n\t\t\t\t\t\t\t@removeDepartment="controlDepartment"\n\t\t\t\t\t\t\t@addEmployee="addEmployee"\n\t\t\t\t\t\t\t@userInvite="userInvite"\n\t\t\t\t\t\t\t@moveEmployee="moveEmployee"\n\t\t\t\t\t\t></DepartmentMenuButton>\n\t\t\t\t\t</div>\n\t\t\t\t  \t<HeadList v-if="head && showInfo" :items="head"></HeadList>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-else-if="showInfo"\n\t\t\t\t\t\tclass="humanresources-tree__node_load-skeleton --heads"\n\t\t\t\t\t></div>\n\t\t\t\t\t<div v-if="deputy && showInfo" class="humanresources-tree__node_employees">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<p class="humanresources-tree__node_employees-title">\n\t\t\t\t\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_TREE_EMPLOYEES_TITLE')}}\n\t\t\t\t\t\t\t</p>\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tclass="humanresources-tree__node_employees-count"\n\t\t\t\t\t\t\t\t@click.stop="onDepartmentClick('employees')"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t{{locPlural('HUMANRESOURCES_COMPANY_STRUCTURE_TREE_EMPLOYEES_COUNT', employeeCount)}}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div v-if="!deputy.length"></div>\n\t\t\t\t\t\t<HeadList :items="deputy"\n\t\t\t\t\t\t\t\t  :title="loc('HUMANRESOURCES_COMPANY_STRUCTURE_TREE_DEPUTY_TITLE')" \n\t\t\t\t\t\t\t\t  :collapsed="true"\n\t\t\t\t\t\t\t\t  :type="'deputy'">\n\t\t\t\t\t\t</HeadList>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-else-if="showInfo"\n\t\t\t\t\t\tclass="humanresources-tree__node_load-skeleton --deputies"\n\t\t\t\t\t></div>\n\t\t\t\t</div>\n\t\t\t\t<div\n\t\t\t\t\tclass="humanresources-tree__node_subdivisions"\n\t\t\t\t\t:class="subdivisionsClass"\n\t\t\t\t\tv-if="showInfo"\n\t\t\t\t\t@click.stop="onDepartmentClick('subdivisions')"\n\t\t\t\t>\n\t\t\t\t\t<span>\n\t\t\t\t\t\t{{\n\t\t\t\t\t\t\tnodeData.children?.length ?\n\t\t\t\t\t\t\t\tlocPlural('HUMANRESOURCES_COMPANY_DEPARTMENT_CHILDREN_COUNT', nodeData.children.length) :\n\t\t\t\t\t\t\t\tloc('HUMANRESOURCES_COMPANY_STRUCTURE_TREE_NO_SUBDEPARTMENTS')\n\t\t\t\t\t\t}}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t  \t<SubdivisionAddButton\n\t\t\t\t\tv-if="showSubdivisionAddButton"\n\t\t\t\t\t@addDepartment="controlDepartment('addDepartment', 'plus')"\n\t\t\t\t\t:department-id="nodeId"\n\t\t\t\t\t@click.stop\n\t\t\t\t></SubdivisionAddButton>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-if="nodeData.parentId === 0 && !hasChildren"\n\t\t\t\tclass="humanresources-tree__node_empty-skeleton"\n\t\t\t></div>\n\t\t\t<div\n\t\t\t\tv-if="hasChildren"\n\t\t\t\tref="childrenNode"\n\t\t\t\tclass="humanresources-tree__node_children"\n\t\t\t\t:style="childNodeStyle"\n\t\t\t>\n\t\t\t\t<TransitionGroup>\n\t\t\t\t\t<treeNode\n\t\t\t\t\t\tv-for="id in nodeData.children"\n\t\t\t\t\t\tv-if="isExpanded || childrenMounted"\n\t\t\t\t\t\tv-show="isExpanded"\n\t\t\t\t\t\t:ref="'node-' + id"\n\t\t\t\t\t\t:key="id"\n\t\t\t\t\t\t:nodeId="id"\n\t\t\t\t\t\t:expandedNodes="expandedNodes"\n\t\t\t\t\t\t:zoom="zoom"\n\t\t\t\t\t\t:currentDepartment="currentDepartment"\n\t\t\t\t\t\t@calculatePosition="calculatePosition"\n\t\t\t\t\t/>\n\t\t\t\t</TransitionGroup>\n\t\t\t</div>\n\t\t</div>\n\t`};const z=t=>{const e=new Map;t.forEach((t=>{var n,s,o;const{id:i,parentId:r}=t;const a=(n=e.get(i))!=null?n:{};e.set(i,{...a,...t});if(r===0){return}const d=(s=e.get(r))!=null?s:{};const c=(o=d.children)!=null?o:[];e.set(r,{...d,children:[...c,i]})}));return e};const k={removeDepartment:t=>l.getData("humanresources.api.Structure.Node.delete",{nodeId:t}),getDepartmentsData:()=>l.getData("humanresources.api.Structure.get",{},{tool:"structure",category:"structure",event:"open_structure"}),getCurrentDepartments:()=>l.getData("humanresources.api.Structure.Node.current"),getDictionary:()=>l.getData("humanresources.api.Structure.dictionary"),getUserId:()=>l.getData("humanresources.api.User.getCurrentId"),firstTimeOpened:()=>l.postData("humanresources.api.User.firstTimeOpen"),createTreeDataStore:z};const Y={name:"tree",components:{TreeNode:$},props:{zoom:{type:Number,required:true}},emits:["moveTo","showWizard","controlDetail"],data(){return{connectors:{},expandedNodes:[]}},created(){this.treeNodes=new Map;this.subscribeOnEvents();this.loadHeads([this.rootId]);this.prevWindowWidth=window.innerWidth;const[t]=this.currentDepartments;if(!t){return}if(t!==this.rootId){this.expandDepartmentParents(t);this.focus(t,{expandAfterFocus:true});return}this.expandLowerDepartments();this.focus(t)},beforeUnmount(){this.unsubscribeOnEvents()},provide(){return{getTreeBounds:()=>this.getTreeBounds()}},computed:{rootId(){const{id:t}=[...this.departments.values()].find((t=>t.parentId===0));return t},...E.mapState(S.useChartStore,["currentDepartments","userId","focusedNode","departments"])},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},getTreeBounds(){return this.$el.getBoundingClientRect()},getPath(t){const e=this.connectors[t];const{startPoint:n,endPoint:s}=e;if(!n||!s){return""}const o=90;const i=1;const r=n.y-i;const a=this.focusedNode===e.id?9:0;const d={start:"",end:""};let c=0;if(Math.round(n.x)>Math.round(s.x)){c=15;d.start="a15,15 0 0 1 -15,15";d.end="a15,15 0 0 0 -15,15"}else if(Math.round(n.x)<Math.round(s.x)){c=-15;d.start="a15,15 0 0 0 15,15";d.end="a15,15 0 0 1 15,15"}const l=s.y-a;return[`M${n.x} ${r}`,`V${r+o}`,`${String(d.start)}`,`H${s.x+c}`,`${String(d.end)}`,`V${l}`].join("")},onConnectDepartment({data:t}){var e;const{id:n,parentId:s,html:o}=t;this.treeNodes.set(n,o);const[i]=this.currentDepartments;if(n===i){setTimeout((()=>{this.moveTo(i)}),1800)}if(!s){return}const r=(e=this.connectors[`${s}-${n}`])!=null?e:{};Object.assign(r,t);if(r.highlighted){delete this.connectors[`${s}-${n}`]}this.connectors[`${s}-${n}`]={show:true,highlighted:false,...r}},onDisconnectDepartment({data:t}){const{id:e,parentId:n}=t;delete this.connectors[`${n}-${e}`];const s=this.departments.get(e);delete s.prevParentId;if(!s.parentId){P.removeDepartment(e)}},onAdaptSiblings({data:t}){const{nodeId:e,parentId:n,offset:s}=t;const o=this.departments.get(n);if(o.children.includes(e)){this.adaptConnectorsAfterMount(n,e,s);return}this.adaptConnectorsAfterUnmount(n,e,s)},adaptConnectorsAfterMount(t,e,n){Object.entries(this.connectors).forEach((([e,s])=>{if(!s.id){return}if(s.parentId===t){const{x:t}=s.endPoint;Object.assign(s.endPoint,{x:t+n});return}if(s.parentsPath.includes(t)){const{startPoint:t,endPoint:e}=s;Object.assign(t,{x:t.x+n});Object.assign(e,{x:e.x+n})}}))},adaptConnectorsAfterUnmount(t,e,n){const s=Object.entries(this.connectors);const{endPoint:o}=this.connectors[`${t}-${e}`];const i=s.reduce(((n,[s,i])=>{const{endPoint:r,id:a,parentId:d}=i;if(d!==t||a===e){return n}const c=o.x>r.x?1:-1;return{...n,[a]:c}}),{});s.forEach((([s,o])=>{const{id:r,parentId:a,parentsPath:d,endPoint:c,startPoint:l}=o;if(r===e){return}if(a===t){const{x:t}=c;const e=i[r];Object.assign(c,{x:t+n*e});return}const h=d==null?void 0:d.find((t=>Boolean(i[t])));if(h){const t=i[h];Object.assign(l,{x:l.x+n*t});Object.assign(c,{x:c.x+n*t})}}))},onAdaptConnectorHeight({data:t}){const{shift:e,nodeId:n}=t;Object.entries(this.connectors).forEach((([t,s])=>{if(s.parentId===n){Object.assign(s.startPoint,{y:s.startPoint.y+e})}}))},collapse(t){this.expandedNodes=this.expandedNodes.filter((e=>e!==t));this.toggleConnectorsVisibility(t,false);this.toggleConnectorHighlighting(t,false)},collapseRecursively(t){const e=t=>{var n;this.collapse(t);const s=this.departments.get(t);(n=s.children)==null?void 0:n.forEach((t=>{if(this.expandedNodes.includes(t)){e(t)}}))};const{parentId:n}=this.departments.get(t);const s=this.expandedNodes.find((t=>{const e=this.departments.get(t);return e.parentId===n}));if(s){e(s)}},expand(t){this.collapseRecursively(t);this.expandedNodes=[...this.expandedNodes,t];this.toggleConnectorsVisibility(t,true);this.toggleConnectorHighlighting(t,true);const e=this.departments.get(t);const n=e.children.filter((t=>!this.departments.get(t).heads));if(n.length>0){this.loadHeads(n)}I.sendData({tool:"structure",category:"structure",event:"expand_department"})},focus(t,e={}){var n;const{expandAfterFocus:s=false,showEmployees:o=false,subdivisionsSelected:i=false}=e;const r=((n=this.departments.get(t).children)==null?void 0:n.length)>0;let a=s||!this.expandedNodes.includes(t);if(o){a=this.expandedNodes.includes(t)}if(i||!r){this.collapseRecursively(t)}if(r&&a){this.expand(t)}if(this.focusedNode&&!this.expandedNodes.includes(this.focusedNode)){this.toggleConnectorHighlighting(this.focusedNode,false)}P.focusDepartment(t);this.toggleConnectorHighlighting(this.focusedNode,true)},onFocusDepartment({data:t}){const{nodeId:e,showEmployees:n,subdivisionsSelected:s}=t;this.focus(e,{showEmployees:n,subdivisionsSelected:s});this.$emit("controlDetail",{showEmployees:n,preventSwitch:s})},onControlDepartment({data:t}){const{action:e,nodeId:n,source:s}=t;const o=e===w.editDepartment||e===w.editEmployee;if(o){const t=e===w.editDepartment?"department":"employees";this.$emit("showWizard",{nodeId:n,isEditMode:true,type:t,source:s});return}if(e===w.addDepartment){this.$emit("showWizard",{nodeId:n,isEditMode:false,showEntitySelector:false,source:s});return}this.tryRemoveDepartment(n)},tryRemoveDepartment(t){const e=i.MessageBox.create({title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_DEPARTMENT_TITLE"),message:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_DEPARTMENT_MESSAGE"),buttons:i.MessageBoxButtons.OK_CANCEL,onOk:async e=>{try{await this.removeDepartment(t);r.UI.Notification.Center.notify({content:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_DEPARTMENT_REMOVED"),autoHideDelay:2e3});e.close()}catch{r.UI.Notification.Center.notify({content:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_DEPARTMENT_ERROR"),autoHideDelay:2e3})}},onCancel:t=>t.close(),minWidth:250,maxWidth:320,minHeight:175,okCaption:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_CONFIRM_REMOVE_DEPARTMENT_OK_CAPTION"),popupOptions:{className:"humanresources-tree__message-box",overlay:{opacity:40}}});const n=e.getOkButton();const s=e.getCancelButton();n.setRound(true);s.setRound(true);n.setColor(R.ButtonColor.DANGER);s.setColor(R.ButtonColor.LIGHT_BORDER);e.show()},async removeDepartment(t){await k.removeDepartment(t);const e=this.departments.get(t);const{parentId:n,children:s=[]}=e;if(s.length>0){this.collapse(t)}P.moveSubordinatesToParent(t);await this.$nextTick();P.markDepartmentAsRemoved(t);this.focus(n,{expandAfterFocus:true});this.moveTo(n)},toggleConnectorsVisibility(t,e){const{children:n}=this.departments.get(t);n.forEach((n=>{var s;const o=(s=this.connectors[`${t}-${n}`])!=null?s:{};this.connectors={...this.connectors,[`${t}-${n}`]:{...o,show:e}};if(this.expandedNodes.includes(n)){this.toggleConnectorsVisibility(n,e)}}))},toggleConnectorHighlighting(t,e){var n;const{parentId:s}=this.departments.get(t);if(!s){return}if(!e){this.connectors[`${s}-${t}`]={...this.connectors[`${s}-${t}`],highlighted:false};return}const o=(n=this.connectors[`${s}-${t}`])!=null?n:{};delete this.connectors[`${s}-${t}`];this.connectors={...this.connectors,[`${s}-${t}`]:{...o,highlighted:true}}},expandDepartmentParents(t){let{parentId:e}=this.departments.get(t);while(e){if(!this.expandedNodes.includes(e)){this.expand(e)}e=this.departments.get(e).parentId}},expandLowerDepartments(){let t=0;const e=s=>{var o;const{children:i=[]}=this.departments.get(s);if(t===4||i.length===0){return}this.expand(s);t+=1;const r=Math.trunc(i.length/2);const a=i[r];if(((o=this.departments.get(a).children)==null?void 0:o.length)>0){e(a);return}for(let t=r-1;t>=0;t--){if(n(i[t])){return}}for(let t=r+1;t<i.length;t++){if(n(i[t])){return}}};const n=t=>{const{children:n=[]}=this.departments.get(t);if(n.length>0){e(t);return true}return false};e(this.rootId)},locateToCurrentDepartment(){const[t]=this.currentDepartments;if(!t){return}this.expandDepartmentParents(t);this.focus(t,{expandAfterFocus:true});this.moveTo(t);P.searchUserInDepartment(this.userId)},async locateToDepartment(t){await this.expandDepartmentParents(t);await this.focus(t,{expandAfterFocus:true});await this.moveTo(t)},async moveTo(t){await this.$nextTick();const e=this.getTreeBounds();const n=e.x+e.width/2;const s=e.y+e.height/2;const o=this.treeNodes.get(t);const i=o.getBoundingClientRect();this.$emit("moveTo",{x:n-i.x-i.width/2,y:s-i.y-i.height/2,nodeId:t})},loadHeads(t){const e=S.useChartStore();e.loadHeads(t)},subscribeOnEvents(){this.events={[N.HR_DEPARTMENT_CONNECT]:this.onConnectDepartment,[N.HR_DEPARTMENT_DISCONNECT]:this.onDisconnectDepartment,[N.HR_DEPARTMENT_FOCUS]:this.onFocusDepartment,[N.HR_DEPARTMENT_CONTROL]:this.onControlDepartment,[N.HR_DEPARTMENT_ADAPT_SIBLINGS]:this.onAdaptSiblings,[N.HR_DEPARTMENT_ADAPT_CONNECTOR_HEIGHT]:this.onAdaptConnectorHeight};Object.entries(this.events).forEach((([t,e])=>{c.EventEmitter.subscribe(t,e)}));a.Event.bind(window,"resize",this.onResizeWindow)},unsubscribeOnEvents(){Object.entries(this.events).forEach((([t,e])=>{c.EventEmitter.unsubscribe(t,e)}));a.Event.unbind(window,"resize",this.onResizeWindow)},onResizeWindow(){const t=(window.innerWidth-this.prevWindowWidth)/2;this.prevWindowWidth=window.innerWidth;if(t===0){return}Object.keys(this.connectors).forEach((e=>{const n=this.connectors[e];if(n.startPoint&&n.endPoint){const e=n.startPoint.x;const s=n.endPoint.x;Object.assign(n.startPoint,{x:e+t});Object.assign(n.endPoint,{x:s+t})}}))}},template:`\n\t\t<div\n\t\t\tclass="humanresources-tree"\n\t\t\tv-if="departments.size > 0"\n\t\t>\n\t\t\t<TreeNode\n\t\t\t\tclass="--root"\n\t\t\t\t:key="rootId"\n\t\t\t\t:nodeId="rootId"\n\t\t\t\t:expandedNodes="[...expandedNodes]"\n\t\t\t\t:zoom="zoom"\n\t\t\t\t:currentDepartment="currentDepartments[0]"\n\t\t\t/>\n\t\t\t<svg class="humanresources-tree__connectors" fill="none">\n\t\t\t\t<marker\n\t\t\t\t\tid='arrow'\n\t\t\t\t\tmarkerUnits='userSpaceOnUse'\n\t\t\t\t\tmarkerWidth='20'\n\t\t\t\t\tmarkerHeight='12'\n\t\t\t\t\trefX='10'\n\t\t\t\t\trefY='10.5'\n\t\t\t\t>\n\t\t\t\t\t<path d="M1 1L10 10L19 1" class="--highlighted" />\n\t\t\t\t</marker>\n\t\t\t\t<path\n\t\t\t\t\tv-for="(connector, id) in connectors"\n\t\t\t\t\tv-show="connector.show"\n\t\t\t\t\t:ref="id"\n\t\t\t\t\t:marker-end="connector.highlighted ? 'url(#arrow)' : null"\n\t\t\t\t\t:class="{ '--highlighted': connector.highlighted }"\n\t\t\t\t\t:id="id"\n\t\t\t\t\t:d="getPath(id)"\n\t\t\t\t></path>\n\t\t\t</svg>\n\t\t</div>\n\t`};const V={name:"transform-panel",props:{modelValue:{type:Object,required:true}},emits:["locate","update:modelValue"],data(){return{selectedId:""}},created(){this.actions=Object.freeze({zoomIn:"zoomIn",zoomOut:"zoomOut",locate:"locate",navigate:"navigate"})},computed:{zoomInPercent(){const t='<span class="humanresources-transform-panel__zoom_percent">%</span>';return`${(this.modelValue.zoom*100).toFixed(0)}${t}`}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onZoom(t){const e=.2;const n=3;let s=-1;if(t){s=1;this.selectedId=this.actions.zoomIn}else{this.selectedId=this.actions.zoomOut}const o=Number((this.modelValue.zoom+e*s).toFixed(1));if(o<e||o>n){return}this.$emit("update:modelValue",{...this.modelValue,zoom:o})},onLocate(){const{locate:t}=this.actions;this.$emit(t);this.selectedId=t},onfocusout(){this.selectedId=""}},template:`\n\t\t<div class="humanresources-transform-panel" @focusout="onfocusout" tabindex="-1">\n\t\t\t<div\n\t\t\t\tclass="humanresources-transform-panel__locate"\n\t\t\t\t:class="{ '--selected': selectedId === actions.locate }"\n\t\t\t\t@click="onLocate"\n\t\t\t>\n\t\t\t\t{{loc('HUMANRESOURCES_COMPANY_STRUCTURE_TREE_LOCATE')}}\n\t\t\t</div>\n\t\t\t<div class="humanresources-transform-panel__separator"></div>\n\t\t\t<div class="humanresources-transform-panel__zoom">\n\t\t\t\t<svg\n\t\t\t\t\tviewBox="0 0 16 16"\n\t\t\t\t\tfill="none"\n\t\t\t\t\tclass="humanresources-transform-panel__icon --zoom-out"\n\t\t\t\t\t:class="{ '--selected': selectedId === actions.zoomOut }"\n\t\t\t\t\t@click="onZoom(false)"\n\t\t\t\t>\n\t\t\t\t\t<path fill-rule="evenodd" clip-rule="evenodd" d="M4 8.66671V7.33337H7.33333H8.66667H12V8.66671H8.66667H7.33333H4Z" fill="#6A737F"/>\n\t\t\t\t</svg>\n\t\t\t\t<span v-html="zoomInPercent"></span>\n\t\t\t\t<svg\n\t\t\t\t\tviewBox="0 0 16 16"\n\t\t\t\t\tfill="none"\n\t\t\t\t\tclass="humanresources-transform-panel__icon --zoom-in"\n\t\t\t\t\t:class="{ '--selected': selectedId === actions.zoomIn }"\n\t\t\t\t\t@click="onZoom(true)"\n\t\t\t\t>\n\t\t\t\t\t<path fill-rule="evenodd" clip-rule="evenodd" d="M7.83333 4H9.16667V7.33333H12.5V8.66667H9.16667V12H7.83333V8.66667H4.5V7.33333H7.83333V4Z" fill="#6A737F"/>\n\t\t\t\t</svg>\n\t\t\t</div>\n\t\t</div>\n\t`};const F={name:"detailPanelCollapsedTitle",props:{title:{type:String,required:true},avatars:{type:Array,required:true}},computed:{maxVisibleAvatarsCount(){return 2},additionalCount(){return this.avatars.length>this.maxVisibleAvatarsCount?this.avatars.length-this.maxVisibleAvatarsCount:0}},template:`\n\t\t<div class="humanresources-detail-panel__collapsed-title">\n\t\t\t<template v-for="(avatar, index) in avatars">\n\t\t\t\t<img\n\t\t\t\t\tv-if="index < this.maxVisibleAvatarsCount"\n\t\t\t\t\t:key="index"\n\t\t\t\t\t:src="encodeURI(avatar)"\n\t\t\t\t\tclass="humanresources-detail-panel__collapsed-title-avatar"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<div\n\t\t\t\tv-if="avatars.length > maxVisibleAvatarsCount"\n\t\t\t\tclass="humanresources-detail-panel__collapsed-title-avatar --additional"\n\t\t\t>\n\t\t\t +{{ additionalCount }}\t\n\t\t\t</div>\n\t\t\t<div class="humanresources-detail-panel__title">{{ title }}</div>\n\t\t</div>\n\t`};const W=Object.freeze({editDepartment:"editDepartment",addDepartment:"addDepartment",editEmployee:"editEmployee",moveEmployee:"moveEmployee",userInvite:"userInvite",addEmployee:"addEmployee",removeDepartment:"removeDepartment"});const X={name:"detailPanelEditButton",emits:["editDepartment","addDepartment","editEmployee","addEmployee","removeDepartment","moveEmployee","userInvite"],components:{RouteActionMenu:m.RouteActionMenu,BIcon:v.BIcon},created(){this.permissionChecker=M.PermissionChecker.getInstance()},data(){return{menuVisible:false}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)},onActionMenuItemClick(t){this.$emit(t,{role:this.role,bindElement:this.$refs.detailPanelEditButton})}},computed:{...E.mapState(S.useChartStore,["focusedNode"]),set(){return v.Set},menuItems(){if(!this.permissionChecker){return[]}return[{id:W.editDepartment,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_DEPARTMENT_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_DEPARTMENT_SUBTITLE"),bIcon:{name:p.Main.EDIT_PENCIL,size:20,color:D.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.departmentEdit}},{id:W.addDepartment,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_DEPARTMENT_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_DEPARTMENT_SUBTITLE"),bIcon:{name:p.Main.CUBE_PLUS,size:20,color:D.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.departmentCreate}},{id:W.editEmployee,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_EMPLOYEE_LIST_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_EDIT_EMPLOYEE_LIST_SUBTITLE"),bIcon:{name:p.Main.EDIT_MENU,size:20,color:D.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.employeeAddToDepartment}},{id:W.moveEmployee,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_MOVE_EMPLOYEE_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_MOVE_EMPLOYEE_SUBTITLE"),bIcon:{name:p.Main.PERSON_ARROW_LEFT_1,size:20,color:D.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.employeeAddToDepartment}},{id:W.userInvite,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_USER_INVITE_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_USER_INVITE_SUBTITLE"),bIcon:{name:p.Main.PERSON_LETTER,size:20,color:D.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.inviteToDepartment}},{id:W.addEmployee,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_EMPLOYEE_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_ADD_EMPLOYEE_SUBTITLE"),bIcon:{name:p.CRM.PERSON_PLUS_2,size:20,color:D.getColorCode("paletteBlue50")},permission:{action:M.PermissionActions.employeeAddToDepartment}},{id:W.removeDepartment,title:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_REMOVE_DEPARTMENT_TITLE"),description:this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_DEPARTMENT_DETAIL_EDIT_MENU_REMOVE_DEPARTMENT_SUBTITLE"),bIcon:{name:p.Main.TRASH_BIN,size:20,color:D.getColorCode("paletteRed40")},permission:{action:M.PermissionActions.departmentDelete}}].filter((t=>{if(!t.permission){return false}return this.permissionChecker.hasPermission(t.permission.action,this.focusedNode)}))}},template:`\n\t\t<div\n\t\t\tv-if="menuItems.length"\n\t\t\tclass="humanresources-detail-panel__edit-button"\n\t\t\t:class="{ '--focused': menuVisible }"\n\t\t\t:ref="'detailPanelEditButton'"\n\t\t\tdata-id="hr-department-detail-panel__edit-menu-button"\n\t\t\t@click.stop="menuVisible = true"\n\t\t>\n\t\t\t<BIcon\n\t\t\t\tclass="humanresources-detail-panel__edit-button-icon"\n\t\t\t\t:name="set.MORE"\n\t\t\t\t:size="20"\n\t\t\t/>\n\t\t</div>\n\t\t<RouteActionMenu\n\t\t\tv-if="menuVisible"\n\t\t\tid="department-detail-content-edit-menu"\n\t\t\t:items="menuItems"\n\t\t\t:width="302"\n\t\t\t:bindElement="$refs.detailPanelEditButton"\n\t\t\t@action="onActionMenuItemClick"\n\t\t\t@close="menuVisible = false"\n\t\t/>\n\t`};const j={name:"detailPanel",emits:["showWizard","removeDepartment","update:modelValue"],components:{DepartmentContent:h.DepartmentContent,DetailPanelCollapsedTitle:F,DetailPanelEditButton:X},directives:{hint:m.Hint},props:{preventPanelSwitch:Boolean,modelValue:Boolean},data(){return{title:"",isCollapsed:true,isLoading:true,needToShowLoader:false}},computed:{...E.mapState(S.useChartStore,["focusedNode","departments"]),defaultAvatar(){return"/bitrix/js/humanresources/company-structure/org-chart/src/images/default-user.svg"},headAvatarsArray(){var t,e,n;const s=(t=this.departments.get(this.focusedNode).heads)!=null?t:[];return(e=s==null?void 0:(n=s.filter((t=>t.role===l.memberRoles.head)))==null?void 0:n.map((t=>t.avatar||this.defaultAvatar)))!=null?e:[]}},methods:{toggleCollapse(){this.$emit("update:modelValue",!this.isCollapsed)},updateDetailPageHandler(t,e){var n;if(!this.preventPanelSwitch&&e!==0){this.$emit("update:modelValue",false)}this.isLoading=true;const s=this.departments.get(t);this.title=(n=s.name)!=null?n:"";this.isLoading=false},addEmployee(){const t=this.focusedNode;u.UserManagementDialog.openDialog({nodeId:t,type:"add"})},userInvite(){const t=this.departments.get(this.focusedNode).accessCode.slice(1);BX.SidePanel.Instance.open("/bitrix/services/main/ajax.php?action=getSliderContent"+"&c=bitrix%3Aintranet.invitation&mode=ajax"+`&departments[]=${t}&firstInvitationBlock=invite-with-group-dp`,{cacheable:false,allowChangeHistory:false,width:1100})},moveEmployee(){const t=this.focusedNode;u.UserManagementDialog.openDialog({nodeId:t,type:"move"})},editEmployee(){this.$emit("showWizard",{nodeId:this.focusedNode,isEditMode:true,type:"employees",source:l.AnalyticsSourceType.DETAIL})},editDepartment(){this.$emit("showWizard",{nodeId:this.focusedNode,isEditMode:true,type:"department",source:l.AnalyticsSourceType.DETAIL})},addDepartment(){this.$emit("showWizard",{nodeId:this.focusedNode,isEditMode:false,showEntitySelector:false,source:l.AnalyticsSourceType.DETAIL})},removeDepartment(){this.$emit("removeDepartment",this.focusedNode)},showLoader(){this.needToShowLoader=true},hideLoader(){this.needToShowLoader=false}},watch:{focusedNode(t,e){this.updateDetailPageHandler(t,e)},modelValue(t){this.isCollapsed=t},departments:{handler(t){const e=t.get(this.focusedNode);if(e){var n;this.title=(n=e.name)!=null?n:""}},deep:true}},template:`\n\t\t<div\n\t\t\t:class="['humanresources-detail-panel', { '--collapsed': isCollapsed }]"\n\t\t\tv-on="isCollapsed ? { click: toggleCollapse } : {}"\n\t\t\tdata-id="hr-department-detail-panel__container"\n\t\t>\n\t\t\t<div\n\t\t\t\tv-if="!isLoading"\n\t\t\t\tclass="humanresources-detail-panel-container"\n\t\t\t\t:class="{ '--hide': needToShowLoader && !isCollapsed }"\n\t\t\t>\n\t\t\t\t<div class="humanresources-detail-panel__head">\n\t\t\t\t\t<span\n\t\t\t\t\t\tv-if="!isCollapsed"\n\t\t\t\t\t\tv-hint\n\t\t\t\t\t\tclass="humanresources-detail-panel__title"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ title }}\n\t\t\t\t\t</span>\n\t\t\t\t\t<DetailPanelCollapsedTitle\n\t\t\t\t\t\tv-else\n\t\t\t\t\t\t:title="title"\n\t\t\t\t\t\t:avatars="headAvatarsArray"\n\t\t\t\t\t>\n\t\t\t\t\t</DetailPanelCollapsedTitle>\n\t\t\t\t\t<div class="humanresources-detail-panel__header_buttons_container">\n\t\t\t\t\t\t<DetailPanelEditButton\n\t\t\t\t\t\t\tv-if="!isCollapsed"\n\t\t\t\t\t\t\t@addEmployee="addEmployee"\n\t\t\t\t\t\t\t@editEmployee="editEmployee"\n\t\t\t\t\t\t\t@editDepartment="editDepartment"\n\t\t\t\t\t\t\t@addDepartment="addDepartment"\n\t\t\t\t\t\t\t@moveEmployee="moveEmployee"\n\t\t\t\t\t\t\t@removeDepartment="removeDepartment"\n\t\t\t\t\t\t\t@userInvite="userInvite"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tclass="humanresources-detail-panel__collapse_button --icon"\n\t\t\t\t\t\t\t@click="toggleCollapse"\n\t\t\t\t\t\t\t:class="{ '--collapsed': isCollapsed }"\n\t\t\t\t\t\t\tdata-id="hr-department-detail-panel__collapse-button"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="humanresources-detail-panel__content" v-show="!isCollapsed">\n\t\t\t\t\t<DepartmentContent\n\t\t\t\t\t\t@editEmployee="editEmployee"\n\t\t\t\t\t\t@showDetailLoader="showLoader"\n\t\t\t\t\t\t@hideDetailLoader="hideLoader"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div v-if="needToShowLoader && !isCollapsed" class="humanresources-detail-panel-loader-container"/>\n\t\t</div>\n\t`};const G={name:"FirstPopup",components:{BIcon:v.BIcon},data(){return{show:false,title:"",description:"",subDescription:"",features:[]}},async mounted(){this.title=this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_TITLE");this.description=this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_DESCRIPTION");this.subDescription=this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_SUB_DESCRIPTION");this.features=[this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_1"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_2"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_3"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_4"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_5"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_6"),this.loc("HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_FEATURE_7")];const{firstTimeOpened:t}=await k.getDictionary();this.show=t==="N"&&this.title.length>0},methods:{closePopup(){k.firstTimeOpened();this.show=false;top.BX.Event.EventEmitter.emit(N.HR_FIRST_POPUP_SHOW)},loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)}},computed:{set(){return v.Set}},template:`\n\t\t<div v-if="show" class="first-popup">\n\t\t\t<div class="first-popup-overlay" @click="closePopup"></div>\n\t\t\t<div class="first-popup-content">\n\t\t\t\t<div class="title">{{ title }}</div>\n\t\t\t\t<div class="first-popup-left">\n\t\t\t\t\t<p class="description">{{ description }}</p>\n\t\t\t\t\t<p class="sub-description">{{ subDescription }}</p>\n\t\t\t\t\t<div class="first-popup-list">\n\t\t\t\t\t\t<div class="first-popup-list-item" v-for="(feature, index) in features" :key="index">\n\t\t\t\t\t\t\t<div class="first-popup-list-item-point">\u2022</div>\n\t\t\t\t\t\t\t<div class="first-popup-list-item-feature">{{ feature }}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<button class="ui-btn ui-btn-success first-popup-ui-btn" @click="closePopup">\n\t\t\t\t\t\t{{ loc('HUMANRESOURCES_COMPANY_STRUCTURE_FIRST_OPEN_BUTTON_START') }}\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t\t<div class="first-popup-right">\n\t\t\t\t\t<video\n\t\t\t\t\t\tsrc="/bitrix/js/humanresources/company-structure/org-chart/src/components/first-popup/images/preview.webm"\n\t\t\t\t\t\tautoplay\n\t\t\t\t\t\tloop\n\t\t\t\t\t\tmuted\n\t\t\t\t\t\tplaysinline\n\t\t\t\t\t\tclass="first-popup-animation"\n\t\t\t\t\t></video>\n\t\t\t\t</div>\n\t\t\t\t<BIcon :name="set.CROSS_25" :size="24" class="first-popup-close" @click="closePopup"></BIcon>\n\t\t\t</div>\n\t\t</div>\n\t`};const q={components:{TransformCanvas:s.TransformCanvas,Tree:Y,TransformPanel:V,ChartWizard:f.ChartWizard,FirstPopup:G,DetailPanel:j,TitlePanel:H},data(){return{canvas:{shown:false,moving:false,modelTransform:{x:0,y:0,zoom:.3}},wizard:{shown:false,isEditMode:false,showEntitySelector:true,entity:"",nodeId:0,source:""},detailPanel:{collapsed:true,preventSwitch:false}}},async created(){const t=BX.SidePanel.Instance.getTopSlider();t==null?void 0:t.showLoader();const[e,n,s]=await Promise.all([k.getDepartmentsData(),k.getCurrentDepartments(),k.getUserId()]);t==null?void 0:t.closeLoader();const o=k.createTreeDataStore(e);P.applyData(o,n,s);this.rootOffset=100;this.transformCanvas();this.canvas.shown=true;this.showConfetti=false;c.EventEmitter.subscribe(N.HR_DEPARTMENT_SLIDER_ON_MESSAGE,this.handleInviteSliderMessage)},unmounted(){c.EventEmitter.unsubscribe(N.HR_DEPARTMENT_SLIDER_ON_MESSAGE,this.handleInviteSliderMessage)},computed:{rootId(){const{id:t}=[...this.departments.values()].find((t=>t.parentId===0));return t},...E.mapState(S.useChartStore,["departments","currentDepartments"])},methods:{onMoveTo({x:t,y:e,nodeId:n}){const{x:s,y:o,zoom:i}=this.canvas.modelTransform;const r=364*i;const a=t-r/2;const d=n===this.rootId?this.rootOffset:e/i;const c=Math.round(a)!==Math.round(s)||Math.round(e)!==Math.round(o);const l=c&&!this.canvas.moving;this.detailPanel={...this.detailPanel,collapsed:false};if(!l){return}this.canvas={...this.canvas,moving:true,modelTransform:{...this.canvas.modelTransform,x:a/i,y:d,zoom:1}}},onLocate(t){if(t){this.$refs.tree.locateToDepartment(t);return}this.$refs.tree.locateToCurrentDepartment()},onShowWizard({nodeId:t=0,isEditMode:e=false,type:n,showEntitySelector:s=true,source:o=""}={}){this.wizard={...this.wizard,shown:true,isEditMode:e,showEntitySelector:s,entity:n,nodeId:t,source:o};if(!e&&o!==l.AnalyticsSourceType.HEADER){I.sendData({tool:"structure",category:"structure",event:"create_dept_step1",c_element:o})}switch(n){case"department":I.sendData({tool:"structure",category:"structure",event:"create_dept_step1",c_element:o});break;case"employees":I.sendData({tool:"structure",category:"structure",event:"create_dept_step2",c_element:o});break;case"bindChat":I.sendData({tool:"structure",category:"structure",event:"create_dept_step3",c_element:o});break}},async onModifyTree({id:t,parentId:e,showConfetti:n}){this.showConfetti=n!=null?n:false;const{tree:s}=this.$refs;s.expandDepartmentParents(t);s.focus(t,{expandAfterFocus:true});await this.$nextTick();s.moveTo(t)},onWizardClose(){this.wizard.shown=false},onRemoveDepartment(t){const{tree:e}=this.$refs;e.tryRemoveDepartment(t)},onTransitionEnd(){this.canvas.moving=false;if(this.showConfetti){n.Confetti.fire({particleCount:300,startVelocity:10,spread:400,ticks:100,origin:{y:.4,x:.37}});this.showConfetti=false}},onControlDetail({showEmployees:t,preventSwitch:e}){this.detailPanel={...this.detailPanel,preventSwitch:e};if(!t){return}this.detailPanel={...this.detailPanel,collapsed:false}},transformCanvas(){const{zoom:t}=this.canvas.modelTransform;const{offsetWidth:e,offsetHeight:n}=this.$el;const[s]=this.currentDepartments;const o=s===this.rootId?this.rootOffset:n/2-n*t/2;this.canvas.modelTransform={...this.canvas.modelTransform,x:e/2-e*t/2,y:o}},onUpdateTransform(){c.EventEmitter.emit(N.HR_DEPARTMENT_MENU_CLOSE)},handleInviteSliderMessage(t){const[e]=t.getData();const n=e.getEventId();if(n!=="BX.Intranet.Invitation:onAdd"){return}const{users:s}=e.getData();s.forEach((t=>{const e=D.getInvitedUserData(t);P.inviteUser(e)}))}},template:`\n\t\t<div class="humanresources-chart">\n\t\t\t<TitlePanel @showWizard="onShowWizard" @locate="onLocate"></TitlePanel>\n\t\t\t<TransformCanvas\n\t\t\t\tv-if="canvas.shown"\n\t\t\t\tv-slot="{transform}"\n\t\t\t\tv-model="canvas.modelTransform"\n\t\t\t\t@update:modelValue="onUpdateTransform"\n\t\t\t\t:class="{ '--moving': canvas.moving }"\n\t\t\t\t@transitionend="onTransitionEnd"\n\t\t\t>\n\t\t\t\t<Tree\n\t\t\t\t\t:zoom="transform.zoom"\n\t\t\t\t\tref="tree"\n\t\t\t\t\t@moveTo="onMoveTo"\n\t\t\t\t\t@showWizard="onShowWizard"\n\t\t\t\t\t@controlDetail="onControlDetail"\n\t\t\t\t/>\n\t\t\t</TransformCanvas>\n\t\t\t<DetailPanel\n\t\t\t\t@showWizard="onShowWizard"\n\t\t\t\t@removeDepartment="onRemoveDepartment"\n\t\t\t\tv-model="detailPanel.collapsed"\n\t\t\t\t:preventPanelSwitch="detailPanel.preventSwitch"\n\t\t\t></DetailPanel>\n\t\t\t<TransformPanel\n\t\t\t\tv-model="canvas.modelTransform"\n\t\t\t\t@locate="onLocate"\n\t\t\t></TransformPanel>\n\t\t\t<ChartWizard\n\t\t\t\tv-if="wizard.shown"\n\t\t\t\t:nodeId="wizard.nodeId"\n\t\t\t\t:isEditMode="wizard.isEditMode"\n\t\t\t\t:showEntitySelector="wizard.showEntitySelector"\n\t\t\t\t:entity="wizard.entity"\n\t\t\t\t:source="wizard.source"\n\t\t\t\t@modifyTree="onModifyTree"\n\t\t\t\t@close="onWizardClose"\n\t\t\t></ChartWizard>\n\t\t\t<FirstPopup/>\n\t\t\t<div class="humanresources-chart__back"></div>\n\t\t</div>\n\t`};var Z=babelHelpers.classPrivateFieldLooseKey("subscribeOnEvents");class K{static async mount(t){const n=document.getElementById(t);const s=e.BitrixVue.createApp(q);const o=E.createPinia();s.use(o);babelHelpers.classPrivateFieldLooseBase(K,Z)[Z](s);const i=BX.SidePanel.Instance.getTopSlider();if(i){i.showLoader()}a.Dom.addClass(n,"humanresources-chart__back");await M.PermissionChecker.init();if(i){i.closeLoader()}a.Dom.removeClass(n,"humanresources-chart__back");s.mount(n)}}function J(t){const e=t=>{const[e]=t.data;e.denyAction()};const n=()=>{c.EventEmitter.unsubscribe(N.HR_ORG_CHART_CLOSE_BY_ESC,e);c.EventEmitter.unsubscribe(N.HR_ORG_CHART_CLOSE,n);t.unmount()};c.EventEmitter.subscribe(N.HR_ORG_CHART_CLOSE_BY_ESC,e);c.EventEmitter.subscribe(N.HR_ORG_CHART_CLOSE,n)}Object.defineProperty(K,Z,{value:J});t.App=K})(this.BX.Humanresources.CompanyStructure=this.BX.Humanresources.CompanyStructure||{},BX.Vue3,BX.UI,BX.Humanresources.CompanyStructure,BX.UI.EntitySelector,BX.UI.Dialogs,BX,BX,BX,BX.Event,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX.UI.IconSet,BX.Vue3.Pinia,BX,BX,BX.UI,BX,BX.UI.IconSet,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX.Humanresources.CompanyStructure,BX.UI.Analytics,BX,BX.Humanresources.CompanyStructure);
//# sourceMappingURL=org-chart.bundle.map.js