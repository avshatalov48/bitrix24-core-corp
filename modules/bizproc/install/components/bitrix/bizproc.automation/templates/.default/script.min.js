if(!BX.getClass("BX.Bizproc.Automation.Component"))(function(t){"use strict";t.namespace("BX.Bizproc.Automation");var e=function(e){if(!t.type.isDomNode(e))throw"baseNode must be Dom Node Element";this.node=e;I.component=this;R.component=this};e.ViewMode={None:0,View:1,Edit:2};e.LogStatus={Waiting:0,Running:1,Completed:2,AutoCompleted:3};e.idIncrement=0;e.generateUniqueId=function(){++e.idIncrement;return"bizproc-automation-cmp-"+e.idIncrement};var i=function(e){e=e||"/bitrix/components/bitrix/bizproc.automation/ajax.php";return t.util.add_url_param(e,{site_id:t.message("SITE_ID"),sessid:t.bitrix_sessid()})};var a=function(t){return JSON.stringify(t,(function(t,e){if(typeof e=="boolean"){return e?"1":"0"}return e}))};var o=function(e){var i;if(t.type.isArray(e)){var a,o;for(a=0;a<e.length;++a){o=e[a];if(o["Id"]==="ASSIGNED_BY_ID"||o["Id"]==="RESPONSIBLE_ID"){i="{{"+o["Name"]+"}}";break}}}return i};var s="\\{=\\s*(?<object>[a-z0-9_]+)\\s*\\:\\s*(?<field>[a-z0-9_\\.]+)(\\s*>\\s*(?<mod1>[a-z0-9_\\:]+)(\\s*,\\s*(?<mod2>[a-z0-9_]+))?)?\\s*\\}";e.prototype={init:function(i,a){var o=this;this.viewMode=a||e.ViewMode.Edit;if(typeof i==="undefined")i={};this.data=i;this.initData();this.initActionPanel();this.initTracker();this.initSearch();this.initTriggerManager();this.initTemplateManager();this.initButtons();this.initButtonsPosition();this.initHelpTips();this.fixTitleColors();if(!this.embeddedMode){window.onbeforeunload=function(){if(o.templateManager.needSave()||o.triggerManager.needSave()){return t.message("BIZPROC_AUTOMATION_CMP_NEED_SAVE")}}}},initData:function(){this.documentType=this.data.DOCUMENT_TYPE;this.documentId=this.data.DOCUMENT_ID;this.documentCategoryId=this.data.DOCUMENT_CATEGORY_ID;this.documentSigned=this.data.DOCUMENT_SIGNED;this.bizprocEditorUrl=this.data.WORKFLOW_EDIT_URL;this.constantsEditorUrl=this.data.CONSTANTS_EDIT_URL||null;this.parametersEditorUrl=this.data.PARAMETERS_EDIT_URL||null;this.documentStatuses=this.data.DOCUMENT_STATUS_LIST;this.statusesSort=[];for(var e=0;e<this.documentStatuses.length;++e){this.statusesSort.push(this.documentStatuses[e]["STATUS_ID"])}this.setDocumentStatus(this.data.DOCUMENT_STATUS);this.userOptions={};if(t.type.isPlainObject(this.data.USER_OPTIONS)){this.userOptions=this.data.USER_OPTIONS}this.frameMode=t.type.isBoolean(this.data.FRAME_MODE)?this.data.FRAME_MODE:false;this.embeddedMode=this.data.IS_EMBEDDED===true},setDocumentStatus:function(t){this.documentStatus=t;this.currentStatusIndex=-1;for(var e=0;e<this.statusesSort.length;++e){if(this.statusesSort[e]==t){this.currentStatusIndex=e;break}}return this},isPreviousStatus:function(t){var e=0;for(var i=0;i<this.statusesSort.length;++i){if(t==this.statusesSort[i])e=i}return this.currentStatusIndex>-1&&e<this.currentStatusIndex},isCurrentStatus:function(t){return t==this.documentStatus},isNextStatus:function(t){var e=0;for(var i=0;i<this.statusesSort.length;++i){if(t==this.statusesSort[i])e=i}return this.currentStatusIndex>-1&&e>this.currentStatusIndex},initActionPanel:function(){var e=document.querySelector('[data-role="automation-actionpanel"]');if(!e){return}this.actionPanel=new t.UI.ActionPanel({renderTo:e,removeLeftPosition:true,maxHeight:58,parentPosition:"bottom",autoHide:false});this.actionPanel.draw();var i="/bitrix/components/bitrix/bizproc.automation/templates/.default/image/";this.actionPanel.appendItem({id:"automation_choose_all",text:t.message("BIZPROC_AUTOMATION_CMP_ACTIONPANEL_CHOOSE_ALL"),icon:i+"bizproc-automation--panel-icon-choose-all.svg",onclick:function(){var t=this.templateManager.targetManageModeStatus;var e=this.templateManager.getTemplateByStatusId(t);if(e){e.robots.forEach((function(t){t.selectNode()}))}}.bind(this)});this.actionPanel.appendItem({id:"automation_copy_to",text:t.message("BIZPROC_AUTOMATION_CMP_ACTIONPANEL_COPY"),icon:i+"bizproc-automation--panel-icon-copy.svg",onclick:this.onCopyMoveButtonClick.bind(this,"copy")});this.actionPanel.appendItem({id:"automation_move_to",text:t.message("BIZPROC_AUTOMATION_CMP_ACTIONPANEL_MOVE"),icon:i+"bizproc-automation--panel-icon-move.svg",onclick:this.onCopyMoveButtonClick.bind(this,"move")});this.actionPanel.appendItem({id:"automation_delete",text:t.message("BIZPROC_AUTOMATION_CMP_ACTIONPANEL_DELETE"),icon:i+"bizproc-automation--panel-icon-delete.svg",onclick:this.onDeleteButtonClick.bind(this)});t.addCustomEvent("BX.UI.ActionPanel:hidePanel",function(){if(this.templateManager.isManageModeEnabled()){this.disableManageMode()}}.bind(this))},onCopyMoveButtonClick:function(e){var i=this.templateManager.targetManageModeStatus;var a=this.templateManager.getTemplateByStatusId(i);var o=a.getSelectedRobotNames();if(o.length===0){t.UI.Notification.Center.notify({content:t.message("BIZPOC_AUTOMATION_NO_ROBOT_SELECTED"),autoHideDelay:4e3});return}t.SidePanel.Instance.open("/bitrix/components/bitrix/bizproc.automation.scheme/index.php",{width:569,cacheable:false,requestMethod:"post",requestParams:{documentSigned:this.documentSigned,templateStatus:this.templateManager.targetManageModeStatus,action:e,selectedRobots:o},events:{onDestroy:function(i){var a=i.slider;if(a){var o=a.getData();var s=o.get("restoreData");var n=o.get("targetScope");var r=e==="copy"?o.get("copied"):o.get("moved");var l=o.get("denied");if(!t.type.isArray(r)||!t.type.isArray(l)){return}var d="BIZPROC_AUTOMATION_CMP_ROBOTS_"+(e==="copy"?"COPIED":"MOVED");var p=t.message(d);p=p.replace("#ACCEPTED_COUNT#",r.length);p=p.replace("#TOTAL_COUNT#",r.length+l.length);t.UI.Notification.Center.notify({content:p,actions:[{title:t.message("JS_CORE_WINDOW_CANCEL"),events:{click:function(e,i){e.preventDefault();if(t.type.isArray(s)){this.saveTemplates(s);i.close()}}.bind(this)}}]});var c=[];var u=this.templateManager.targetManageModeStatus;if(e==="move"){c.push(u)}if(n&&this.data.DOCUMENT_TYPE_SIGNED===n.documentType.Type&&this.templateManager.getTemplateByStatusId(n.status.Id)){c.push(n.status.Id)}this.templateManager.updateTemplates(c).onload=function(){var e=this.templateManager.getTemplateByStatusId(u);l.forEach(function(i){var a=e.getRobotByName(i);if(a){t.Dom.addClass(a.node,"--denied");setTimeout(t.Dom.removeClass.bind(null,a.node,"--denied"),10*1e3)}}.bind(this))}.bind(this)}this.disableManageMode()}.bind(this)}})},onDeleteButtonClick:function(){var e=this.templateManager.targetManageModeStatus;var i=this.templateManager.getTemplateByStatusId(e);if(!i){return}var o=this.templateManager.templatesData.findIndex((function(t){return t.ID===i.data.ID}));var s=i.getSelectedRobotNames();if(s.length===0){t.UI.Notification.Center.notify({content:t.message("BIZPOC_AUTOMATION_NO_ROBOT_SELECTED"),autoHideDelay:4e3});return}t.ajax({method:"POST",dataType:"json",url:this.getAjaxUrl(),data:{ajax_action:"delete_robots",document_signed:this.documentSigned,selected_status:i.data.DOCUMENT_STATUS,robot_names:a(s)},onsuccess:function(e){var a=t.message("BIZPROC_AUTOMATION_CMP_ROBOTS_DELETED");a=a.replace("#TOTAL_COUNT#",s.length);if(e.SUCCESS){i.reInit(e.DATA.template,this.viewMode);this.templateManager.templatesData[o]=e.DATA.template;this.disableManageMode();a=a.replace("#ACCEPTED_COUNT#",s.length);var n=e.DATA.restoreData}else{a=a.replace("#ACCEPTED_COUNT#",0)}t.UI.Notification.Center.notify({content:a,actions:[{title:t.message("JS_CORE_WINDOW_CANCEL"),events:{click:function(e,i){e.preventDefault();if(t.type.isArray(n)){this.saveTemplates(n);i.close()}}.bind(this)}}]})}.bind(this)})},initTriggerManager:function(){this.triggerManager=new d(this);this.triggerManager.init(this.data,this.viewMode)},reInitTriggerManager:function(e){if(t.type.isArray(e))this.data.TRIGGERS=e;this.triggerManager.reInit(this.data,this.viewMode)},initTemplateManager:function(){this.templateManager=new n(this);this.templateManager.init(this.data,this.viewMode)},reInitTemplateManager:function(e){if(t.type.isArray(e))this.data.TEMPLATES=e;this.templateManager.reInit(this.data,this.viewMode)},initButtons:function(){var t=this.node.querySelector('[data-role="automation-buttons"]');if(t){this.bindSaveButton();this.bindCancelButton()}this.bindCreationButton()},initButtonsPosition:function(){var e=this.node.querySelector('[data-role="automation-buttons"]');if(e){if(this.frameMode){t.addClass(e,"bizproc-automation-buttons-fixed-slider")}}},initSearch:function(){var e=this.node.querySelector('[data-role="automation-search"]');if(e){t.bind(e,"input",t.debounce(this.onSearch.bind(this,e),255));t.Event.EventEmitter.setMaxListeners(this,"BX.Bizproc.Automation.Component:onSearch",500);var i=this.node.querySelector('[data-role="automation-search-clear"]');if(i){t.bind(i,"click",this.onClearSearch.bind(this,e))}}},reInitSearch:function(){var t=this.node.querySelector('[data-role="automation-search"]');if(t){this.onSearch(t)}},onSearch:function(e){t.Event.EventEmitter.emit(this,"BX.Bizproc.Automation.Component:onSearch",{queryString:e.value.toLowerCase()})},onClearSearch:function(t){if(t.value!==""){t.value="";this.onSearch(t)}},initHelpTips:function(){t.UI.Hint.init(this.node)},enableDragAndDrop:function(){this.templateManager.enableDragAndDrop();this.triggerManager.enableDragAndDrop()},disableDragAndDrop:function(){this.templateManager.disableDragAndDrop();this.triggerManager.disableDragAndDrop()},fixTitleColors:function(){var t,e,i=this.node.querySelectorAll('[data-role="automation-status-title"]');for(t=0;t<i.length;++t){e=i[t].getAttribute("data-bgcolor");if(e){var a=parseInt(e,16);var o=a>>16&255;var s=a>>8&255;var n=a&255;var r=.21*o+.72*s+.07*n;if(r<145){i[t].style.color="white"}}}},initTracker:function(){this.tracker=new c(this);this.tracker.init(this.data.LOG)},bindSaveButton:function(){var e=this,i=t("ui-button-panel-save");if(i){t.bind(i,"click",(function(t){t.preventDefault();e.saveAutomation();i.classList.remove("ui-btn-wait")}))}},bindCancelButton:function(){var e=this,i=this.node.querySelector('[data-role="automation-btn-cancel"]');if(i){t.bind(i,"click",(function(t){t.preventDefault();e.reInitTriggerManager();e.reInitTemplateManager();e.reInitSearch();e.markModified(false)}))}},bindCreationButton:function(){var i=this,a=this.node.querySelector('[data-role="automation-btn-create"]');if(a){if(i.canEdit()){t.bind(a,"click",(function(o){o.preventDefault();if(i.viewMode===e.ViewMode.View){i.changeViewMode(e.ViewMode.Edit)}var s=[{text:t.message("BIZPROC_AUTOMATION_CMP_CREATE_ROBOT"),onclick:function(e){this.popupWindow.close();var a=t.clone(i.templateManager.getRobotDescription("SocNetMessageActivity"));if(a["ROBOT_SETTINGS"]&&a["ROBOT_SETTINGS"]["TITLE"]){a["NAME"]=a["ROBOT_SETTINGS"]["TITLE"]}var o=i.templateManager.templates[0];o.addRobot(a,(function(t){this.openRobotSettingsDialog(t)}))}}];if(t.type.isArray(i.data.AVAILABLE_TRIGGERS)&&i.data.AVAILABLE_TRIGGERS.length){s.push({text:t.message("BIZPROC_AUTOMATION_CMP_CREATE_TRIGGER"),onclick:function(t){this.popupWindow.close();i.triggerManager.addTrigger({DOCUMENT_STATUS:i.statusesSort[0],CODE:i.data.AVAILABLE_TRIGGERS[0].CODE},(function(t){this.openTriggerSettingsDialog(t)}))}})}t.PopupMenu.show(e.generateUniqueId(),a,s,{autoHide:true,offsetLeft:t.pos(a)["width"]/2,angle:true})}))}}},getAjaxUrl:function(){return i(this.data.AJAX_URL)},getLimits:function(){var t=this.data["ROBOTS_LIMIT"];if(t<=0){return false}var e=this.triggerManager.countAllTriggers();var i=this.templateManager.countAllRobots();return e+i>t?[t,e,i]:false},saveAutomation:function(e){if(this.savingAutomation){return}var i=this.getLimits();if(i){if(top.BX.UI&&top.BX.UI.InfoHelper){top.BX.UI.InfoHelper.show("limit_crm_robots");return}t.UI.Dialogs.MessageBox.show({title:t.message("BIZPROC_AUTOMATION_ROBOTS_LIMIT_ALERT_TITLE"),message:t.message("BIZPROC_AUTOMATION_ROBOTS_LIMIT_SAVE_ALERT").replace("#LIMIT#",i[0]).replace("#SUM#",i[1]+i[2]).replace("#TRIGGERS#",i[1]).replace("#ROBOTS#",i[2]),modal:true,buttons:t.UI.Dialogs.MessageBoxButtons.OK,okCaption:t.message("BIZPROC_AUTOMATION_CLOSE_CAPTION")});return}var o=this,s={ajax_action:"save_automation",document_signed:this.documentSigned,triggers_json:a(this.triggerManager.serialize()),templates_json:a(this.templateManager.serializeModified())};this.savingAutomation=true;return t.ajax({method:"POST",dataType:"json",url:this.getAjaxUrl(),data:s,onsuccess:function(t){o.savingAutomation=null;t.DATA.templates.forEach((function(t){var e=o.data.TEMPLATES.findIndex((function(e){return e.ID===t.ID}));o.data.TEMPLATES[e]=t}));if(t.SUCCESS){o.reInitTriggerManager(t.DATA.triggers);o.reInitTemplateManager();o.reInitSearch();o.markModified(false);if(e){e(t.DATA)}}else{alert(t.ERRORS[0])}}})},saveTemplates:function(e){if(this.savingAutomation){return}var i={ajax_action:"save_automation",document_signed:this.documentSigned,templates_json:a(e)};this.savingAutomation=true;var o=this;return t.ajax({method:"POST",dataType:"json",url:this.getAjaxUrl(),data:i,onsuccess:function(t){o.savingAutomation=null;if(t.SUCCESS){e.forEach((function(t){var e=o.templateManager.getTemplateById(t.ID);if(e){e.reInit(t,o.viewMode)}}))}else{alert(t.ERRORS[0])}}})},changeViewMode:function(i,a){if(!a&&(this.templateManager.needSave()||this.triggerManager.needSave())){alert(t.message("BIZPROC_AUTOMATION_CMP_NEED_SAVE"));return}if(i!==e.ViewMode.View&&i!==e.ViewMode.Edit)throw"Unknown view mode";this.viewMode=i;this.reInitTriggerManager();this.reInitTemplateManager()},enableManageMode:function(t){this.templateManager.enableManageMode(t);this.triggerManager.enableManageMode()},disableManageMode:function(){this.templateManager.disableManageMode();this.triggerManager.disableManageMode()},markModified:function(i){i=i!==false;var a=this.node.querySelector('[data-role="automation-buttons"]');if(!a){return}if(i&&this.canEdit()&&this.viewMode===e.ViewMode.Edit){t.show(a)}else{t.hide(a)}},canEdit:function(){return this.data["CAN_EDIT"]},updateTracker:function(){var i=this;t.ajax({method:"POST",dataType:"json",url:this.getAjaxUrl(),data:{ajax_action:"get_log",document_signed:this.documentSigned},onsuccess:function(t){if(t.DATA&&t.DATA.LOG){i.tracker.reInit(t.DATA.LOG);if(i.viewMode===e.ViewMode.View){i.templateManager.reInit()}}}})},onGlobalHelpClick:function(t){t.preventDefault();if(top.BX.Helper){top.BX.Helper.show("redirect=detail&code=14889274#after")}},getUserOption:function(t,e,i){var a=i;if(this.userOptions[t]&&this.userOptions[t][e]){a=this.userOptions[t][e]}return a},setUserOption:function(e,i,a){if(!t.type.isPlainObject(this.userOptions[e])){this.userOptions[e]={}}var o=this.userOptions[e][i];if(o!==a){this.userOptions[e][i]=a;t.userOptions.save("bizproc.automation",e,i,a,false)}return this},getConstants:function(){if(!this.data["GLOBAL_CONSTANTS"]){return[]}var e=[];var i=this.data["G_CONSTANTS_VISIBILITY"];Object.keys(this.data["GLOBAL_CONSTANTS"]).forEach((function(a){var o=t.clone(this.data["GLOBAL_CONSTANTS"][a]);o.Id=a;o.ObjectId="GlobalConst";o.SystemExpression="{=GlobalConst:"+a+"}";o.Expression="{=GlobalConst:"+a+"}";var s=String(o.Visibility).toUpperCase();var n=i[s];if(n){o.Expression="{{"+n+": "+o.Name+"}}";o.supertitle=n}e.push(o)}),this);return e},getConstant:function(t){var e=this.getConstants();for(var i=0;i<e.length;++i){if(e[i].Id===t){return e[i]}}return null},getGVariables:function(){if(!this.data["GLOBAL_VARIABLES"]){return[]}var e=[];var i=this.data["G_VARIABLES_VISIBILITY"];t.util.object_keys(this.data["GLOBAL_VARIABLES"]).forEach((function(a){var o=t.clone(this.data["GLOBAL_VARIABLES"][a]);o.Id=a;o.ObjectId="GlobalVar";o.SystemExpression="{=GlobalVar:"+a+"}";o.Expression="{=GlobalVar:"+a+"}";var s=String(o.Visibility).toUpperCase();var n=i[s];if(n){o.Expression="{{"+n+": "+o.Name+"}}";o.supertitle=n}e.push(o)}),this);return e},getGVariable:function(t){var e=this.getGVariables();for(var i=0;i<e.length;i++){if(e[i].Id===t){return e[i]}}return null},getDocumentFields:function(){if(!this.data["DOCUMENT_FIELDS"]){return[]}if(t.type.isArray(this.data["DOCUMENT_FIELDS"])){return this.data["DOCUMENT_FIELDS"]}return[]}};var n=function(t){this.component=t};n.prototype={init:function(i,a){if(!t.type.isPlainObject(i))i={};this.viewMode=a||e.ViewMode.Edit;this.availableRobots=t.type.isArray(i.AVAILABLE_ROBOTS)?i.AVAILABLE_ROBOTS:[];this.templatesData=t.type.isArray(i.TEMPLATES)?i.TEMPLATES:[];this.initTemplates()},reInit:function(i,a){if(!t.type.isPlainObject(i))i={};this.viewMode=a||e.ViewMode.Edit;if(t.type.isArray(i.TEMPLATES)){this.templatesData=i.TEMPLATES}if(this.viewMode!==e.ViewMode.Edit){this.targetManageModeStatus=""}this.reInitTemplates(this.templatesData);if(this.isManageModeEnabled()){this.enableManageMode(this.targetManageModeStatus)}else{this.disableManageMode()}},isManageModeSupported:function(){return this.component.data.IS_TEMPLATES_SCHEME_SUPPORTED},isManageModeEnabled:function(){return t.type.isString(this.targetManageModeStatus)&&this.targetManageModeStatus!==""},enableManageMode:function(e){this.targetManageModeStatus=e;var i=document.querySelectorAll(".bizproc-automation-robot-btn-delete");i.forEach((function(e){t.Dom.hide(e)}));this.templates.forEach(function(i){if(i.data.DOCUMENT_STATUS===e){i.enableManageMode()}else{i.disableManageMode();if(i.isExternalModified()){t.Dom.addClass(i.listNode.firstChild,"--locked-node")}else{i.robots.forEach((function(e){t.Dom.addClass(e.node,"--locked-node")}))}}}.bind(this));this.component.disableDragAndDrop();this.component.actionPanel.showPanel()},disableManageMode:function(){this.targetManageModeStatus="";this.component.actionPanel.hidePanel();this.templates.forEach((function(e){e.disableManageMode();if(e.isExternalModified()){t.Dom.removeClass(e.listNode.firstChild,"--locked-node")}else{e.robots.forEach((function(e){t.Dom.removeClass(e.node,"--locked-node")}))}}));this.component.enableDragAndDrop();var e=document.querySelectorAll(".bizproc-automation-robot-btn-delete");e.forEach((function(e){t.Dom.show(e)}))},enableDragAndDrop:function(){this.templates.forEach((function(t){t.enableDragAndDrop()}))},disableDragAndDrop:function(){this.templates.forEach((function(t){t.disableDragAndDrop()}))},initTemplates:function(){this.templates=[];this.templatesMap={};for(var t=0;t<this.templatesData.length;++t){var e=new r(this);e.init(this.templatesData[t],this.viewMode);this.templates.push(e);this.templatesMap[e.getStatusId()]=e}},reInitTemplates:function(t){for(var e=0;e<this.templates.length;++e){if(t[e]){this.templates[e].reInit(t[e],this.viewMode)}}},updateTemplates:function(e){return t.ajax({method:"POST",dataType:"json",url:this.component.getAjaxUrl(),data:{ajax_action:"update_templates",document_signed:this.component.documentSigned,statuses:e},onsuccess:function(t){if(t.SUCCESS){var e=t.DATA.templates;for(var i in e){if(e.hasOwnProperty(i)){var a=this.getTemplateByStatusId(i);var o=this.templatesData.findIndex((function(t){return t.ID===a.data.ID}));a.reInit(e[i],this.viewMode);this.templatesData[o]=e[i]}}}}.bind(this)})},getAvailableRobots:function(){return this.availableRobots},getRobotDescription:function(t){return this.availableRobots.find((function(e){return e["CLASS"]===t}))},serialize:function(){var t=[];for(var e=0;e<this.templates.length;++e){t.push(this.templates[e].serialize())}return t},serializeModified:function(){var t=[];this.templates.forEach((function(e){if(e.isModified()){t.push(e.serialize())}}));return t},countAllRobots:function(){var t=0;this.templates.forEach((function(e){t+=e.robots.length}));return t},getTemplateByColumnNode:function(t){var e=t.getAttribute("data-status-id");return this.getTemplateByStatusId(e)},getTemplateById:function(t){return this.templates.find((function(e){return e.data.ID===t}))},getTemplateByStatusId:function(t){return this.templatesMap[t]||null},canEdit:function(){return this.component&&this.component.canEdit()},needSave:function(){var t=false;for(var e=0;e<this.templates.length;++e){if(this.templates[e].isModified()){t=true;break}}return t}};var r=function(t){if(t){this.manager=t;this.component=t.component}this.data={}};r.prototype={init:function(i,a){if(t.type.isPlainObject(i)){this.data=i;if(!t.type.isPlainObject(this.data.CONSTANTS)){this.data.CONSTANTS={}}if(!t.type.isPlainObject(this.data.PARAMETERS)){this.data.PARAMETERS={}}if(!t.type.isPlainObject(this.data.VARIABLES)){this.data.VARIABLES={}}this.markExternalModified(this.data["IS_EXTERNAL_MODIFIED"]);this.markModified(false)}this.viewMode=a===undefined?e.ViewMode.Edit:a;if(this.viewMode!==e.ViewMode.None){this.node=this.component.node.querySelector('[data-role="automation-template"][data-status-id="'+this.getStatusId()+'"]');this.listNode=this.node.querySelector('[data-role="robot-list"]');this.buttonsNode=this.node.querySelector('[data-role="buttons"]');this.topButtonsNode=this.node.querySelector('[data-role="top-buttons"]');this.initRobots();this.initButtons();this.updateTopButtonsVisibility();if(!this.isExternalModified()&&this.canEdit()){jsDD.registerDest(this.node,10)}else{jsDD.unregisterDest(this.node)}}},reInit:function(e,i){t.cleanNode(this.listNode);t.cleanNode(this.buttonsNode);t.cleanNode(this.topButtonsNode);if(this.robots){this.robots.forEach((function(t){t.destroy()}))}this.init(e,i)},isManageMode:function(){return t.hasClass(this.listNode,"--multiselect-mode")},canEnableManageMode:function(){return!this.manager.targetManageModeStatus&&this.component.viewMode===e.ViewMode.Edit&&!this.manager.needSave()},canEdit:function(){return this.manager.canEdit()},initRobots:function(){this.robots=[];if(t.type.isArray(this.data.ROBOTS)){for(var e=0;e<this.data.ROBOTS.length;++e){var i=new l(this);i.init(this.data.ROBOTS[e],this.viewMode);this.insertRobotNode(i.node);this.robots.push(i)}}},getSelectedRobotNames:function(){var t=[];this.robots.forEach((function(e){if(e.isSelected()){t.push(e.data.Name)}}));return t},getSerializedRobots:function(){var t=[];this.robots.forEach((function(e){t.push(e.serialize())}));return t},getStatusId:function(){return this.data.DOCUMENT_STATUS},getTemplateId:function(){var t=parseInt(this.data.ID);return!isNaN(t)?t:0},initButtons:function(){if(this.isExternalModified()){this.createExternalLocker()}else{this.createAddButton();if(this.getTemplateId()>0){this.createConstantsEditButton();this.createParametersEditButton();this.createExternalEditTemplateButton();this.createManageModeButton()}}},enableManageMode:function(){if(this.listNode){t.addClass(this.listNode,"--multiselect-mode");this.robots.forEach((function(t){t.enableManageMode()}))}},disableManageMode:function(){if(this.listNode){t.removeClass(this.listNode,"--multiselect-mode");this.robots.forEach((function(t){t.disableManageMode()}));this.node.querySelectorAll(".bizproc-automation-robot-container-wrapper").forEach((function(e){t.Dom.addClass(e,"bizproc-automation-robot-container-wrapper-draggable")}))}},enableDragAndDrop:function(){this.robots.forEach((function(t){t.registerItem(t.node)}));this.node.querySelectorAll(".bizproc-automation-robot-container-wrapper").forEach((function(e){t.Dom.addClass(e,"bizproc-automation-robot-container-wrapper-draggable")}))},disableDragAndDrop:function(){this.robots.forEach((function(t){t.unregisterItem(t.node)}));this.node.querySelectorAll(".bizproc-automation-robot-container-wrapper").forEach((function(e){t.Dom.removeClass(e,"bizproc-automation-robot-container-wrapper-draggable")}))},createAddButton:function(){var e=function(e){return t.create("span",{events:{click:function(t){if(!this.canEdit()){M.showNoPermissionsHint(t.target)}else if(!this.manager.isManageModeEnabled()){this.onAddButtonClick(t.target)}}.bind(e)},attrs:{className:"bizproc-automation-robot-btn-add"},children:[t.create("span",{attrs:{className:"bizproc-automation-btn-add-text"},text:t.message("BIZPROC_AUTOMATION_CMP_ADD")})]})};if(this.topButtonsNode){this.topButtonsNode.appendChild(e(this))}this.buttonsNode.appendChild(e(this))},updateTopButtonsVisibility:function(){if(this.topButtonsNode){var e=this.robots&&this.robots.length<1?"hide":"show";if(this.isExternalModified()){e="show"}t[e](this.topButtonsNode)}},createExternalEditTemplateButton:function(){if(this.manager.component.bizprocEditorUrl===null){return false}var e=this,i=t.create("a",{text:t.message("BIZPROC_AUTOMATION_CMP_EXTERNAL_EDIT"),props:{href:"#"},events:{click:function(t){t.preventDefault();if(!e.manager.isManageModeEnabled()){e.onExternalEditTemplateButtonClick(this)}}},attrs:{className:"bizproc-automation-robot-btn-set",target:"_top"}});if(!this.manager.component.bizprocEditorUrl.length){t.addClass(i,"bizproc-automation-robot-btn-set-locked")}this.buttonsNode.appendChild(i)},createManageModeButton:function(){if(!this.manager.isManageModeSupported()){return}var e=this.component;var i=t.create("a",{text:t.message("BIZPROC_AUTOMATION_CMP_MANAGE_ROBOTS"),attrs:{className:"bizproc-automation-robot-btn-set",target:"_top"},style:{cursor:"pointer"},events:{click:function(t){t.preventDefault();if(!e.canEdit()){M.showNoPermissionsHint(i)}else if(this.canEnableManageMode()){this.component.enableManageMode(this.data.DOCUMENT_STATUS)}}.bind(this)}});this.buttonsNode.appendChild(i)},createConstantsEditButton:function(){if(this.manager.component.constantsEditorUrl===null){return false}var e=!this.manager.isManageModeEnabled()?this.manager.component.constantsEditorUrl.replace("#ID#",this.getTemplateId()):"#";if(!e.length){return false}var i=this,a=t.create("a",{text:t.message("BIZPROC_AUTOMATION_CMP_CONSTANTS_EDIT"),props:{href:e},attrs:{className:"bizproc-automation-robot-btn-set"}});this.buttonsNode.appendChild(a)},createParametersEditButton:function(){if(this.manager.component.parametersEditorUrl===null){return false}var e=this.manager.component.parametersEditorUrl.replace("#ID#",this.getTemplateId());if(!e.length||this.manager.isManageModeEnabled()){return false}var i=this,a=t.create("a",{text:t.message("BIZPROC_AUTOMATION_CMP_PARAMETERS_EDIT"),props:{href:e},attrs:{className:"bizproc-automation-robot-btn-set"}});this.buttonsNode.appendChild(a)},createExternalLocker:function(){if(this.topButtonsNode){this.topButtonsNode.appendChild(t.create("span",{attrs:{className:"bizproc-automation-robot-btn-prohibit"}}))}var i=this,a=t.create("div",{attrs:{className:"bizproc-automation-robot-container"},children:[t.create("div",{attrs:{className:"bizproc-automation-robot-container-wrapper bizproc-automation-robot-container-wrapper-lock"},children:[t.create("div",{attrs:{className:"bizproc-automation-robot-deadline"}}),t.create("div",{attrs:{className:"bizproc-automation-robot-title"},text:t.message("BIZPROC_AUTOMATION_CMP_EXTERNAL_EDIT_TEXT")})]})]});if(this.viewMode===e.ViewMode.Edit){var o=t.create("div",{attrs:{className:"bizproc-automation-robot-btn-settings"},text:t.message("BIZPROC_AUTOMATION_CMP_EDIT")});t.bind(a,"click",(function(t){t.stopPropagation();if(!i.manager.isManageModeEnabled()){i.onExternalEditTemplateButtonClick(this)}}));a.appendChild(o);var s=t.create("SPAN",{attrs:{className:"bizproc-automation-robot-btn-delete"}});t.bind(s,"click",(function(t){t.stopPropagation();if(!i.manager.isManageModeEnabled()){i.onUnsetExternalModifiedClick(this)}}));a.lastChild.appendChild(s)}this.listNode.appendChild(a);this.node=a;if(this.component){this.searchHandler=this.onSearch.bind(this);t.Event.EventEmitter.subscribe(this.component,"BX.Bizproc.Automation.Component:onSearch",this.searchHandler)}},onSearch:function(e){if(this.node){var i=e.getData().queryString;t[!i?"removeClass":"addClass"](this.node,"--search-mismatch")}},onAddButtonClick:function(i,a){var o=this,s,n,r={employee:[],client:[],ads:[],other:[]};var l,d,p,c=this.manager.getAvailableRobots();if(!t.Type.isPlainObject(a)){a={}}var u=function(e,i){var s=t.clone(i.robotData);if(s["ROBOT_SETTINGS"]&&s["ROBOT_SETTINGS"]["TITLE_CATEGORY"]&&s["ROBOT_SETTINGS"]["TITLE_CATEGORY"][i.category]){s["NAME"]=s["ROBOT_SETTINGS"]["TITLE_CATEGORY"][i.category]}else if(s["ROBOT_SETTINGS"]&&s["ROBOT_SETTINGS"]["TITLE"]){s["NAME"]=s["ROBOT_SETTINGS"]["TITLE"]}o.addRobot(s,(function(t){a.ADD_MENU_CATEGORY=i.category;this.openRobotSettingsDialog(t,a)}));this.getRootMenuWindow().close()};for(s=0;s<c.length;++s){if(c[s]["EXCLUDED"]){continue}d=t.type.isPlainObject(c[s]["ROBOT_SETTINGS"])?c[s]["ROBOT_SETTINGS"]:{};l=c[s].NAME;if(d["TITLE"])l=d["TITLE"];p=[];if(d["CATEGORY"]){p=t.type.isArray(d["CATEGORY"])?d["CATEGORY"]:[d["CATEGORY"]]}if(!p.length){p.push("other")}for(n=0;n<p.length;++n){if(!r[p[n]])continue;r[p[n]].push({text:l,robotData:c[s],category:p[n],onclick:u})}}if(r["other"].length>0){r["other"].push({delimiter:true})}if(t.getClass("BX.rest.Marketplace")){r["other"].push({text:t.message("BIZPROC_AUTOMATION_ROBOT_CATEGORY_OTHER_MARKETPLACE_2"),onclick:function(){t.rest.Marketplace.open({},o.component.data["MARKETPLACE_ROBOT_CATEGORY"]);this.getRootMenuWindow().close()}})}else{r["other"].push({text:t.message("BIZPROC_AUTOMATION_ROBOT_CATEGORY_OTHER_MARKETPLACE_2"),href:"/marketplace/category/%category%/".replace("%category%",this.component.data["MARKETPLACE_ROBOT_CATEGORY"]),target:"_blank"})}var h=i.getAttribute("data-menu-id");if(!h){h=e.generateUniqueId();i.setAttribute("data-menu-id",h)}var m=[];if(r["employee"].length>0){m.push({text:t.message("BIZPROC_AUTOMATION_ROBOT_CATEGORY_EMPLOYEE"),items:r["employee"]})}if(r["client"].length>0){m.push({text:t.message("BIZPROC_AUTOMATION_ROBOT_CATEGORY_CLIENT"),items:r["client"]})}if(r["ads"].length>0){m.push({text:t.message("BIZPROC_AUTOMATION_ROBOT_CATEGORY_ADS"),items:r["ads"]})}m.push({text:t.message("BIZPROC_AUTOMATION_ROBOT_CATEGORY_OTHER"),items:r["other"]});t.PopupMenu.show(h,i,m,{autoHide:true,offsetLeft:t.pos(i)["width"]/2,angle:{position:"top",offset:0},maxHeight:550})},onChangeRobotClick:function(t){this.onAddButtonClick(t.target,{changeRobot:true})},onExternalEditTemplateButtonClick:function(t){if(!this.manager.component.bizprocEditorUrl.length){if(top.BX.UI&&top.BX.UI.InfoHelper){top.BX.UI.InfoHelper.show("limit_office_bp_designer")}return}var e=this.getTemplateId();if(e>0)this.openBizprocEditor(e)},onUnsetExternalModifiedClick:function(e){this.node=null;if(this.searchHandler){t.Event.EventEmitter.unsubscribe(this.component,"BX.Bizproc.Automation.Component:onSearch",this.searchHandler)}this.markExternalModified(false);this.markModified();this.reInit(null,this.viewMode)},openBizprocEditor:function(t){var e=this.manager.component.bizprocEditorUrl.replace("#ID#",t);top.window.location.href=e},addRobot:function(t,e){var i=new l(this);var a={Type:t["CLASS"],Properties:{Title:t["NAME"]}};if(this.robots.length>0){var o=this.robots[this.robots.length-1];if(!o.delay.isNow()||o.isExecuteAfterPrevious()){a["Delay"]=o.delay.serialize();a["ExecuteAfterPrevious"]=1}}i.init(a,this.viewMode);i.draft=true;if(e){e.call(this,i)}},insertRobot:function(t,e){if(e){for(var i=0;i<this.robots.length;++i){if(this.robots[i]!==e)continue;this.robots.splice(i,0,t);break}}else{this.robots.push(t)}this.markModified()},getNextRobot:function(t){for(var e=0;e<this.robots.length;++e){if(this.robots[e]===t){return this.robots[e+1]||null}}return null},deleteRobot:function(t,e){t.destroy();for(var i=0;i<this.robots.length;++i){if(this.robots[i]===t){this.robots.splice(i,1);break}}if(e)e(t);this.markModified();this.updateTopButtonsVisibility()},insertRobotNode:function(t,e){if(e){this.listNode.insertBefore(t,e)}else{this.listNode.appendChild(t)}this.updateTopButtonsVisibility()},openRobotSettingsDialog:function(e,o,s){if(!t.type.isPlainObject(o)){o={}}if(I.getRobotSettingsDialog()){if(o.changeRobot){I.getRobotSettingsDialog().popup.close()}else{return}}var n=this,r="bizproc_automation_robot_dialog";var l=t.create("form",{props:{name:r}});I.setRobotSettingsDialog({template:this,context:o,robot:e,form:l});l.appendChild(n.renderDelaySettings(e));l.appendChild(n.renderConditionSettings(e));if(e.hasBrokenLink()){l.appendChild(n.renderBrokenLinkAlert())}if(this.component){var d=t.create("div",{attrs:{className:"bizproc-automation-robot-help"},events:{click:t.delegate(this.component.onGlobalHelpClick,this.component)}});l.appendChild(d);o["DOCUMENT_CATEGORY_ID"]=this.component.documentCategoryId}t.ajax({method:"POST",dataType:"html",url:this.component?this.component.getAjaxUrl():i(),data:{ajax_action:"get_robot_dialog",document_signed:this.component?this.component.documentSigned:this.data["DOCUMENT_SIGNED"],document_status:this.component?this.component.documentStatus:this.data["DOCUMENT_STATUS"],context:o,robot_json:a(e.serialize()),form_name:r},onsuccess:function(i){if(i){var a=t.create("div",{html:i});l.appendChild(a)}n.showRobotSettingsPopup(e,l,s)}})},showRobotSettingsPopup:function(i,a,o){var s=this;var n=580;var r=n;if(this.component){t.addClass(this.component.node,"automation-base-blocked");r=parseInt(this.component.getUserOption("defaults","robot_settings_popup_width",580))}this.initRobotSettingsControls(i,a);if(i.data.Type==="CrmSendEmailActivity"||i.data.Type==="MailActivity"||i.data.Type==="RpaApproveActivity"){n+=170;if(r<n){r=n}}var l;var d=i.component?i.getTitle():t.message("BIZPROC_AUTOMATION_ROBOT_SETTINGS_TITLE");if(i.draft){l=this.createChangeRobotTitleBar(d)}var p=new t.PopupWindow(e.generateUniqueId(),null,{titleBar:l||d,content:a,closeIcon:true,width:r,resizable:{minWidth:n,minHeight:100},offsetLeft:0,offsetTop:0,closeByEsc:true,draggable:{restrict:false},events:{onPopupClose:function(e){s.currentRobot=null;I.setRobotSettingsDialog(null);s.destroyRobotSettingsControls();e.destroy();if(s.component){t.removeClass(s.component.node,"automation-base-blocked")}if(i.draft){i.destroy()}},onPopupResize:function(){s.onResizeRobotSettings()},onPopupResizeEnd:function(){if(s.component){s.component.setUserOption("defaults","robot_settings_popup_width",this.getWidth())}}},buttons:[new t.PopupWindowButton({text:t.message("JS_CORE_WINDOW_SAVE"),className:"popup-window-button-accept",events:{click:function(){s.saveRobotSettings(a,i,t.delegate((function(){this.popupWindow.close();if(o){o(i)}}),this),this.buttonNode)}}}),new t.PopupWindowButtonLink({text:t.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});this.currentRobot=i;I.getRobotSettingsDialog().popup=p;p.show()},createChangeRobotTitleBar:function(e){return{content:t.Dom.create("div",{props:{className:"popup-window-titlebar-text bizproc-automation-popup-titlebar-with-link"},children:[document.createTextNode(e),t.Dom.create("span",{props:{className:"bizproc-automation-popup-titlebar-link"},text:t.message("BIZPROC_AUTOMATION_CMP_CHANGE_ROBOT"),events:{click:this.onChangeRobotClick.bind(this)}})]})}},initRobotSettingsControls:function(e,i){if(!t.type.isArray(this.robotSettingsControls)){this.robotSettingsControls=[]}var a=i.querySelectorAll("[data-role]");for(var o=0;o<a.length;++o){this.initRobotSettingsControl(e,a[o])}},initRobotSettingsControl:function(e,i){if(!t.type.isArray(this.robotSettingsControls)){this.robotSettingsControls=[]}var a=null;var o=i.getAttribute("data-role");if(o==="user-selector"){a=new f(e,i,this.data)}else if(o==="file-selector"){a=new u(e,i)}else if(o==="inline-selector-target"){a=new h(e,i,this.data)}else if(o==="inline-selector-html"){a=new g(e,i)}else if(o==="time-selector"){a=new T(i)}else if(o==="save-state-checkbox"){a=new b(i,e)}t.UI.Hint.init(i);if(a){this.robotSettingsControls.push(a)}},destroyRobotSettingsControls:function(){if(this.conditionSelector){this.conditionSelector.destroy();this.conditionSelector=null}if(t.type.isArray(this.robotSettingsControls)){for(var e=0;e<this.robotSettingsControls.length;++e){if(t.type.isFunction(this.robotSettingsControls[e].destroy))this.robotSettingsControls[e].destroy()}}this.robotSettingsControls=null},onBeforeSaveRobotSettings:function(){if(t.type.isArray(this.robotSettingsControls)){for(var e=0;e<this.robotSettingsControls.length;++e){if(t.type.isFunction(this.robotSettingsControls[e].onBeforeSave))this.robotSettingsControls[e].onBeforeSave()}}},onResizeRobotSettings:function(){if(t.type.isArray(this.robotSettingsControls)){for(var e=0;e<this.robotSettingsControls.length;++e){if(t.type.isFunction(this.robotSettingsControls[e].onPopupResize))this.robotSettingsControls[e].onPopupResize()}}},renderDelaySettings:function(i){var a=t.clone(i.getDelayInterval());var o=e.generateUniqueId();var s=t.create("input",{attrs:{type:"hidden",name:"delay_type",value:a.type}});var n=t.create("input",{attrs:{type:"hidden",name:"delay_value",value:a.value}});var r=t.create("input",{attrs:{type:"hidden",name:"delay_value_type",value:a.valueType}});var l=t.create("input",{attrs:{type:"hidden",name:"delay_basis",value:a.basis}});var d=t.create("input",{attrs:{type:"hidden",name:"delay_worktime",value:a.workTime?1:0}});var p=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-delay-interval-basis"}});var c=[];var u=this.component?this.component.data["DOCUMENT_FIELDS"]:this.data["DOCUMENT_FIELDS"];var h=this.component?this.component.data["DELAY_MIN_LIMIT_M"]:this.data["DELAY_MIN_LIMIT_M"];if(t.type.isArray(u)){var m,f;for(m=0;m<u.length;++m){f=u[m];if(f["Type"]=="date"||f["Type"]=="datetime"){c.push(f)}}}var g=new O({labelNode:p,onchange:function(t){s.value=t.type;n.value=t.value;r.value=t.valueType;l.value=t.basis;d.value=t.workTime?1:0},basisFields:c,minLimitM:h,useAfterBasis:true});var T=null;if(i.component){var b=t.create("input",{attrs:{type:"checkbox",id:"param-group-3-1"+o,name:"execute_after_previous",value:"1",style:"vertical-align: middle"}});if(i.isExecuteAfterPrevious()){b.setAttribute("checked","checked")}T=t.create("div",{attrs:{className:"bizproc-automation-popup-settings-block"},children:[b,t.create("label",{attrs:{for:"param-group-3-1"+o,style:"color: #535C69"},text:t.message("BIZPROC_AUTOMATION_CMP_AFTER_PREVIOUS_WIDE")})]})}var I=t.create("div",{attrs:{className:"bizproc-automation-popup-settings bizproc-automation-popup-settings-flex"},children:[t.create("div",{attrs:{className:"bizproc-automation-popup-settings-block bizproc-automation-popup-settings-block-flex"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title-wrapper"},children:[s,n,r,l,d,t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-left"},text:t.message("BIZPROC_AUTOMATION_CMP_TO_EXECUTE")+":"}),p]})]}),T]});g.init(a);return I},setDelaySettingsFromForm:function(t,e){var i=new v;i.setType(t["delay_type"]);i.setValue(t["delay_value"]);i.setValueType(t["delay_value_type"]);i.setBasis(t["delay_basis"]);i.setWorkTime(t["delay_worktime"]==="1");e.setDelayInterval(i);if(e.component){e.setExecuteAfterPrevious(t["execute_after_previous"]&&t["execute_after_previous"]==="1")}return this},renderConditionSettings:function(e){var i=e.getCondition();var a=this.conditionSelector=new N(i,{fields:this.component?this.component.data["DOCUMENT_FIELDS"]:this.data["DOCUMENT_FIELDS"]});return t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("div",{attrs:{className:"bizproc-automation-popup-settings-block"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION")+":"}),a.createNode()]})]})},setConditionSettingsFromForm:function(t,e){e.setCondition(A.createFromForm(t));return this},renderBrokenLinkAlert:function(){var e=t.create("div",{attrs:{className:"ui-alert ui-alert-warning ui-alert-icon-info ui-alert-xs"}});var i=t.create("span",{attrs:{className:"ui-alert-message"},text:t.message("BIZPROC_AUTOMATION_BROKEN_LINK_MESSAGE_ERROR")});e.appendChild(i);e.appendChild(t.create("span",{attrs:{className:"ui-alert-close-btn"},events:{click:function(){e.style.display="none"}}}));return e},saveRobotSettings:function(e,o,s,n){if(n){n.classList.add("popup-window-button-wait")}this.onBeforeSaveRobotSettings();var r=this,l=t.ajax.prepareForm(e);var d=this.component?this.component.getAjaxUrl():i();var p=this.component?this.component.documentSigned:P.documentSigned;t.ajax({method:"POST",dataType:"json",url:d,data:{ajax_action:"save_robot_settings",document_signed:p,robot_json:a(o.serialize()),form_data_json:a(l["data"]),form_data:l["data"]},onsuccess:function(t){if(n){n.classList.remove("popup-window-button-wait")}if(t.SUCCESS){o.updateData(t.DATA.robot);r.setDelaySettingsFromForm(l["data"],o);r.setConditionSettingsFromForm(l["data"],o);if(o.draft){r.robots.push(o);r.insertRobotNode(o.node)}delete o.draft;o.reInit();r.markModified();if(s){s(t.DATA)}}else alert(t.ERRORS[0])}})},serialize:function(){var e=t.clone(this.data);e["IS_EXTERNAL_MODIFIED"]=this.isExternalModified()?1:0;e["ROBOTS"]=[];for(var i=0;i<this.robots.length;++i){e["ROBOTS"].push(this.robots[i].serialize())}return e},isExternalModified:function(){return this.externalModified===true},markExternalModified:function(t){this.externalModified=t!==false},getRobotByName:function(t){return this.robots.find((function(e){return e.data.Name===t}))},getRobotById:function(t){return this.robots.find((function(e){return e.getId()===t}))},isModified:function(){return this.modified},markModified:function(t){this.modified=t!==false;if(this.modified&&this.component){this.component.markModified()}},getConstants:function(){var e=[];Object.keys(this.data.CONSTANTS).forEach((function(i){var a=t.clone(this.data.CONSTANTS[i]);a.Id=i;a.ObjectId="Constant";a.SystemExpression="{=Constant:"+i+"}";a.Expression="{{~&:"+i+"}}";e.push(a)}),this);return e},getConstant:function(t){var e=this.getConstants();for(var i=0;i<e.length;++i){if(e[i].Id===t){return e[i]}}return null},addConstant:function(e){var i=e.Id||this.generatePropertyId("Constant",this.data.CONSTANTS);if(this.data.CONSTANTS[i]){throw'Constant with id "'+i+'" is already exists'}this.data.CONSTANTS[i]=e;if(this.component){t.onCustomEvent(this.component,"onTemplateConstantAdd",[this,this.getConstant(i)])}return this.getConstant(i)},updateConstant:function(e,i){if(!this.data.CONSTANTS[e]){throw'Constant with id "'+e+'" does not exists'}this.data.CONSTANTS[e].Description=i.Description;if(this.component){t.onCustomEvent(this.component,"onTemplateConstantUpdate",[this,this.getConstant(e)])}return this.getConstant(e)},deleteConstant:function(t){delete this.data.CONSTANTS[t];return true},setConstantValue:function(t,e){if(this.data.CONSTANTS[t]){this.data.CONSTANTS[t]["Default"]=e;return true}return false},getParameters:function(){var e=[];Object.keys(this.data.PARAMETERS).forEach((function(i){var a=t.clone(this.data.PARAMETERS[i]);a.Id=i;a.ObjectId="Template";a.SystemExpression="{=Template:"+i+"}";a.Expression="{{~*:"+i+"}}";e.push(a)}),this);return e},getParameter:function(t){var e=this.getParameters();for(var i=0;i<e.length;++i){if(e[i].Id===t){return e[i]}}return null},addParameter:function(e){var i=e.Id||this.generatePropertyId("Parameter",this.data.PARAMETERS);if(this.data.PARAMETERS[i]){throw'Parameter with id "'+i+'" is already exists'}this.data.PARAMETERS[i]=e;if(this.component){t.onCustomEvent(this.component,"onTemplateParameterAdd",[this,this.getParameter(i)])}return this.getParameter(i)},updateParameter:function(e,i){if(!this.data.PARAMETERS[e]){throw'Parameter with id "'+e+'" does not exists'}this.data.PARAMETERS[e].Description=i.Description;if(this.component){t.onCustomEvent(this.component,"onTemplateParameterUpdate",[this,this.getParameter(e)])}return this.getParameter(e)},deleteParameter:function(t){delete this.data.PARAMETERS[t];return true},setParameterValue:function(t,e){if(this.data.PARAMETERS[t]){this.data.PARAMETERS[t]["Default"]=e;return true}return false},getVariables:function(){var e=[];Object.keys(this.data.VARIABLES).forEach((function(i){var a=t.clone(this.data.VARIABLES[i]);a.Id=i;a.ObjectId="Variable";a.SystemExpression="{=Variable:"+i+"}";a.Expression="{=Variable:"+i+"}";e.push(a)}),this);return e},generatePropertyId:function(t,e){for(var i=1;i<=1e3;++i){if(!e[t+i]){break}}return t+i},collectUsages:function(){var t={Document:new Set,Constant:new Set,Variable:new Set,Parameter:new Set,GlobalConstant:new Set,GlobalVariable:new Set,Activity:new Set};this.robots.forEach((function(e){var i=e.collectUsages();Object.keys(t).forEach((function(e){i[e].forEach((function(i){if(!t[e].has(i)){t[e].add(i)}}),this)}),this)}),this);return t}};var l=function(e){if(e){this.template=e;this.templateManager=e.manager;this.component=this.templateManager.component;this.tracker=e.manager.component.tracker;if(this.component){this.searchHandler=this.onSearch.bind(this);t.Event.EventEmitter.subscribe(this.component,"BX.Bizproc.Automation.Component:onSearch",this.searchHandler)}}};l.generateName=function(){return"A"+parseInt(Math.random()*1e5)+"_"+parseInt(Math.random()*1e5)+"_"+parseInt(Math.random()*1e5)+"_"+parseInt(Math.random()*1e5)};l.prototype={init:function(t,i){if(t)this.data=t;if(!this.data.Name){this.data.Name=l.generateName()}this.delay=new v(this.data.Delay);this.condition=new A(this.data.Condition);if(!this.data.Condition){this.condition.type=A.Type.Mixed}this.viewMode=i===undefined?e.ViewMode.Edit:i;if(this.viewMode!==e.ViewMode.None){this.node=this.createNode()}},reInit:function(t,i){if(i===undefined&&this.viewMode===e.ViewMode.None){return}var a=this.node;this.node=this.createNode();if(a.parentNode){a.parentNode.replaceChild(this.node,a)}},destroy:function(){if(this.searchHandler){t.Event.EventEmitter.unsubscribe(this.component,"BX.Bizproc.Automation.Component:onSearch",this.searchHandler)}},canEdit:function(){return this.template.canEdit()},getProperties:function(){if(this.data&&t.Type.isPlainObject(this.data.Properties)){return this.data.Properties}return{}},getProperty:function(t){return this.getProperties()[t]||null},setProperty:function(t,e){this.data.Properties[t]=e;return this},getId:function(){return this.data.Name||null},getLogStatus:function(){var t=e.LogStatus.Waiting;var i=this.tracker.getRobotLog(this.getId());if(i){t=parseInt(i["STATUS"])}else if(this.data.DelayName){i=this.tracker.getRobotLog(this.data.DelayName);if(i&&parseInt(i["STATUS"])===e.LogStatus.Running){t=e.LogStatus.Running}}return t},getLogErrors:function(){var t=[],e=this.tracker.getRobotLog(this.getId());if(e&&e.ERRORS){t=e.ERRORS}return t},getDelayNotes:function(){if(this.data.DelayName){var t=this.tracker.getRobotLog(this.data.DelayName);if(t&&parseInt(t["STATUS"])===e.LogStatus.Running){return t["NOTES"]}}return[]},selectNode:function(){if(this.node){t.addClass(this.node,"--selected");this.component.actionPanel.setTotalSelectedItems(this.template.getSelectedRobotNames().length)}},unselectNode:function(){if(this.node){t.removeClass(this.node,"--selected");this.component.actionPanel.setTotalSelectedItems(this.template.getSelectedRobotNames().length)}},isSelected:function(){return this.node&&t.hasClass(this.node,"--selected")},enableManageMode:function(){this.node.onclick=function(){if(!this.isSelected()){this.selectNode()}else{this.unselectNode()}}.bind(this)},disableManageMode:function(){this.unselectNode();this.node.onclick=undefined},createNode:function(){var i="bizproc-automation-robot-container-wrapper";var a="bizproc-automation-robot-container";if(this.canEdit()){i+=" bizproc-automation-robot-container-wrapper-draggable"}var o=t.message("BIZPROC_AUTOMATION_CMP_TO");var s=t.create("a",{attrs:{className:"bizproc-automation-robot-settings-name",title:t.message("BIZPROC_AUTOMATION_CMP_AUTOMATICALLY")},text:t.message("BIZPROC_AUTOMATION_CMP_AUTOMATICALLY")});if(t.type.isPlainObject(this.data.viewData)&&this.data.viewData.responsibleLabel){var n=this.data.viewData.responsibleLabel.replace("{=Document:ASSIGNED_BY_ID}",t.message("BIZPROC_AUTOMATION_CMP_RESPONSIBLE")).replace("author",t.message("BIZPROC_AUTOMATION_CMP_RESPONSIBLE")).replace(/\{=Constant\:Constant[0-9]+\}/,t.message("BIZPROC_AUTOMATION_ASK_CONSTANT")).replace(/\{\{~&\:Constant[0-9]+\}\}/,t.message("BIZPROC_AUTOMATION_ASK_CONSTANT")).replace(/\{=Template\:Parameter[0-9]+\}/,t.message("BIZPROC_AUTOMATION_ASK_PARAMETER")).replace(/\{\{~&:\:Parameter[0-9]+\}\}/,t.message("BIZPROC_AUTOMATION_ASK_PARAMETER"));if(n.indexOf("{=Document")>=0&&t.type.isArray(this.component.data["DOCUMENT_FIELDS"])){var r,l;for(r=0;r<this.component.data["DOCUMENT_FIELDS"].length;++r){l=this.component.data["DOCUMENT_FIELDS"][r];n=n.replace(l["SystemExpression"],l["Name"])}}if(n.indexOf("{=A")>=0){this.template.robots.forEach((function(t){t.getReturnFieldsDescription().forEach((function(e){if(e["Type"]==="user"){n=n.replace(e["SystemExpression"],t.getTitle()+": "+e["Name"])}}))}))}s.textContent=n;s.setAttribute("title",n);if(this.data.viewData.responsibleUrl){s.href=this.data.viewData.responsibleUrl;if(this.component.frameMode){s.setAttribute("target","_blank")}}if(parseInt(this.data.viewData.responsibleId)>0){s.setAttribute("bx-tooltip-user-id",this.data.viewData.responsibleId)}}var d=E(this.getDelayInterval(),t.message("BIZPROC_AUTOMATION_CMP_AT_ONCE"),this.component.data["DOCUMENT_FIELDS"]);if(this.isExecuteAfterPrevious()){d=d!==t.message("BIZPROC_AUTOMATION_CMP_AT_ONCE")?d+", ":"";d+=t.message("BIZPROC_AUTOMATION_CMP_AFTER_PREVIOUS")}if(this.getCondition().items.length>0){d+=", "+t.message("BIZPROC_AUTOMATION_CMP_BY_CONDITION")}var p=t.create("a",{attrs:{className:"bizproc-automation-robot-link",title:d},text:d});var c=t.create("div",{attrs:{className:"bizproc-automation-robot-information"}});switch(this.getLogStatus()){case e.LogStatus.Running:if(this.component.isCurrentStatus(this.template.getStatusId())){c.classList.add("--loader");var u=this.getDelayNotes();if(u.length){c.setAttribute("data-text",u.join("\n"));M.bindToNode(c)}}break;case e.LogStatus.Completed:case e.LogStatus.AutoCompleted:a+=" --complete";c.classList.add("--complete");break}var h=this.getLogErrors();if(h.length>0){c.classList.add("--errors");c.setAttribute("data-text",h.join("\n"));M.bindToNode(c)}var m="bizproc-automation-robot-title-text";if(this.canEdit()){m+=" bizproc-automation-robot-title-text-editable"}var f=t.create("div",{attrs:{className:a,"data-role":"robot-container","data-type":"item-robot","data-id":this.getId()},children:[t.create("div",{props:{className:"bizproc-automation-robot-container-checkbox"}}),t.create("div",{attrs:{className:i},children:[t.create("div",{attrs:{className:"bizproc-automation-robot-deadline"},children:[p]}),t.create("div",{attrs:{className:"bizproc-automation-robot-title"},children:[t.create("div",{attrs:{className:m},html:this.clipTitle(this.getTitle()),events:{click:function(t){if(this.canEdit()&&!this.templateManager.isManageModeEnabled()){this.onTitleEditClick(t)}}.bind(this)}})]}),t.create("div",{attrs:{className:"bizproc-automation-robot-settings"},children:[t.create("div",{attrs:{className:"bizproc-automation-robot-settings-title"},text:o+":"}),s]}),c]})]});if(this.canEdit()){this.registerItem(f)}var g=t.create("SPAN",{attrs:{className:"bizproc-automation-robot-btn-delete"}});t.bind(g,"click",this.onDeleteButtonClick.bind(this,g));f.lastChild.appendChild(g);var T=t.create("div",{attrs:{className:"bizproc-automation-robot-btn-copy"},text:t.message("BIZPROC_AUTOMATION_CMP_COPY")||"copy"});t.bind(T,"click",this.onCopyButtonClick.bind(this,T));f.appendChild(T);var b=t.create("div",{attrs:{className:"bizproc-automation-robot-btn-settings"},text:t.message("BIZPROC_AUTOMATION_CMP_EDIT")});t.bind(f,"click",this.onSettingsButtonClick.bind(this,f));f.appendChild(b);return f},onDeleteButtonClick:function(e,i){i.stopPropagation();if(!this.canEdit()){M.showNoPermissionsHint(e)}else if(!this.templateManager.isManageModeEnabled()){t.remove(this.node);this.template.deleteRobot(this)}},onSettingsButtonClick:function(t){if(!this.canEdit()){M.showNoPermissionsHint(t)}else if(!this.templateManager.isManageModeEnabled()){this.template.openRobotSettingsDialog(this)}},onCopyButtonClick:function(e,i){i.stopPropagation();if(!this.canEdit()){M.showNoPermissionsHint(e)}else if(!this.templateManager.isManageModeEnabled()){var a=new l(this.template);var o=this.template.getNextRobot(this);var s=this.serialize();delete s["Name"];delete s["DelayName"];if(s["Properties"]&&s["Properties"]["Title"]){s["Properties"]["Title"]+=" "+t.message("BIZPROC_AUTOMATION_CMP_COPY_CAPTION")}a.init(s,this.viewMode);this.template.insertRobot(a,o);this.template.insertRobotNode(a.node,o?o.node:null)}},onTitleEditClick:function(i){i.preventDefault();i.stopPropagation();var a="bizproc_automation_robot_title_dialog";var o=t.create("form",{props:{name:a},style:{"min-width":"540px"}});const s=()=>{this.setProperty("Title",o.elements.name.value);this.reInit();this.template.markModified()};t.bind(o,"submit",(t=>{t.preventDefault();s();n.close()}));o.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:t.message("BIZPROC_AUTOMATION_CMP_ROBOT_NAME")+":"}));o.appendChild(t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("input",{attrs:{className:"bizproc-automation-popup-input",type:"text",name:"name",value:this.getTitle()}})]}));t.addClass(this.component.node,"automation-base-blocked");var n=new t.PopupWindow(e.generateUniqueId(),null,{titleBar:t.message("BIZPROC_AUTOMATION_CMP_ROBOT_NAME"),content:o,closeIcon:true,offsetLeft:0,offsetTop:0,closeByEsc:true,draggable:{restrict:false},overlay:false,events:{onPopupClose:e=>{e.destroy();t.removeClass(this.component.node,"automation-base-blocked")}},buttons:[new t.PopupWindowButton({text:t.message("JS_CORE_WINDOW_SAVE"),className:"popup-window-button-accept",events:{click:function(){s();this.popupWindow.close()}}}),new t.PopupWindowButtonLink({text:t.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});n.show()},onSearch:function(e){if(!this.node){return}var i=e.getData().queryString;var a=!i||this.getTitle().toLowerCase().indexOf(i)>=0;t[a?"removeClass":"addClass"](this.node,"--search-mismatch")},clipTitle:function(e){var i=t.util.htmlspecialchars(e);var a=i.split(" ");var o="<span>"+a[a.length-1]+"</span>";a.splice(a.length-1);i=a.join(" ")+" "+o;return i},updateData:function(e){if(t.type.isPlainObject(e)){this.data=e}else throw"Invalid data"},serialize:function(){var e=t.clone(this.data);delete e["viewData"];e.Delay=this.delay.serialize();e.Condition=this.condition.serialize();return e},getDelayInterval:function(){return this.delay},setDelayInterval:function(t){this.delay=t;return this},getCondition:function(){return this.condition},setCondition:function(t){this.condition=t;return this},setExecuteAfterPrevious:function(t){this.data.ExecuteAfterPrevious=t?1:0;return this},isExecuteAfterPrevious:function(){return this.data.ExecuteAfterPrevious===1||this.data.ExecuteAfterPrevious==="1"},registerItem:function(e){if(t.Type.isNil(e["__bxddid"])){e.onbxdragstart=t.proxy(this.dragStart,this);e.onbxdrag=t.proxy(this.dragMove,this);e.onbxdragstop=t.proxy(this.dragStop,this);e.onbxdraghover=t.proxy(this.dragOver,this);jsDD.registerObject(e);jsDD.registerDest(e,1)}},unregisterItem:function(t){t.onbxdragstart=undefined;t.onbxdrag=undefined;t.onbxdragstop=undefined;t.onbxdraghover=undefined;jsDD.unregisterObject(t);jsDD.unregisterDest(t)},dragStart:function(){this.draggableItem=t.proxy_context;if(!this.draggableItem){jsDD.stopCurrentDrag();return}if(!this.stub){var e=this.draggableItem.offsetWidth;this.stub=this.draggableItem.cloneNode(true);this.stub.style.position="absolute";this.stub.classList.add("bizproc-automation-robot-container-drag");this.stub.style.width=e+"px";document.body.appendChild(this.stub)}},dragMove:function(t,e){this.stub.style.left=t+"px";this.stub.style.top=e+"px"},dragOver:function(t,e,i){if(this.droppableItem){this.droppableItem.classList.remove("bizproc-automation-robot-container-pre")}if(this.droppableColumn){this.droppableColumn.classList.remove("bizproc-automation-robot-list-pre")}var a=t.getAttribute("data-type");if(a==="item-robot"){this.droppableItem=t;this.droppableColumn=null}if(a==="column-robot"){this.droppableColumn=t.querySelector('[data-role="robot-list"]');this.droppableItem=null}if(this.droppableItem){this.droppableItem.classList.add("bizproc-automation-robot-container-pre")}if(this.droppableColumn){this.droppableColumn.classList.add("bizproc-automation-robot-list-pre")}},dragStop:function(t,e,i){i=i||window.event;var a=i&&(i.ctrlKey||i.metaKey);var o,s;if(this.draggableItem){if(this.droppableItem){this.droppableItem.classList.remove("bizproc-automation-robot-container-pre");o=this.templateManager.getTemplateByColumnNode(this.droppableItem.parentNode);if(o){s=o.getRobotById(this.droppableItem.getAttribute("data-id"));if(a){this.copyTo(o,s)}else if(this!==s)this.moveTo(o,s)}}else if(this.droppableColumn){this.droppableColumn.classList.remove("bizproc-automation-robot-list-pre");o=this.templateManager.getTemplateByColumnNode(this.droppableColumn);if(o){a?this.copyTo(o):this.moveTo(o)}}}this.stub.parentNode.removeChild(this.stub);this.stub=null;this.draggableItem=null;this.droppableItem=null},moveTo:function(e,i){t.remove(this.node);this.template.deleteRobot(this);this.template=e;this.template.insertRobot(this,i);this.node=this.createNode();this.template.insertRobotNode(this.node,i?i.node:null)},copyTo:function(t,e){var i=new l(t);var a=this.serialize();delete a["Name"];delete a["DelayName"];i.init(a,this.viewMode);t.insertRobot(i,e);t.insertRobotNode(i.node,e?e.node:null)},getDescriptionSettings:function(){var t={};var e=this.templateManager.getRobotDescription(this.data["Type"]);if(e&&e["ROBOT_SETTINGS"]){t=e["ROBOT_SETTINGS"]}return t},getTitle:function(){return this.getProperty("Title")||this.getDescriptionTitle()},getDescriptionTitle:function(){var t="untitled";var e=this.templateManager.getRobotDescription(this.data["Type"]);if(e["NAME"]){t=e["NAME"]}if(e["ROBOT_SETTINGS"]&&e["ROBOT_SETTINGS"]["TITLE"]){t=e["ROBOT_SETTINGS"]["TITLE"]}return t},getReturnFieldsDescription:function(){var e=[];var i=this.templateManager.getRobotDescription(this.data["Type"]);if(i&&i["RETURN"]){for(var a in i["RETURN"]){if(i["RETURN"].hasOwnProperty(a)){var o=i["RETURN"][a];e.push({Id:a,ObjectId:this.getId(),ObjectName:this.getTitle(),Name:o["NAME"],Type:o["TYPE"],Expression:"{{~"+this.getId()+":"+a+" # "+this.getTitle()+": "+o["NAME"]+"}}",SystemExpression:"{="+this.getId()+":"+a+"}"});if(!this.appendPropertyMods){continue}if(o["TYPE"]==="user"||o["TYPE"]==="bool"||o["TYPE"]==="file"){var s=o["TYPE"]==="user"?"friendly":"printable";e.push({Id:a+"_printable",ObjectId:this.getId(),Name:o["NAME"]+" "+t.message("BIZPROC_AUTOMATION_CMP_MOD_PRINTABLE_PREFIX"),Type:"string",Expression:"{{~"+this.getId()+":"+a+" > "+s+" # "+this.getTitle()+": "+o["NAME"]+"}}",SystemExpression:"{="+this.getId()+":"+a+">"+s+"}"})}}}}if(i&&t.type.isArray(i["ADDITIONAL_RESULT"])){var n=this.data["Properties"];i["ADDITIONAL_RESULT"].forEach((function(i){if(n[i]){for(var a in n[i]){if(n[i].hasOwnProperty(a)){var o=n[i][a];e.push({Id:a,ObjectId:this.getId(),Name:o["Name"],Type:o["Type"],Options:o["Options"]||null,Expression:"{{~"+this.getId()+":"+a+" # "+this.getTitle()+": "+o["Name"]+"}}",SystemExpression:"{="+this.getId()+":"+a+"}"});if(o["Type"]==="user"||o["Type"]==="bool"||o["Type"]==="file"){var s=o["Type"]==="user"?"friendly":"printable";e.push({Id:a+"_printable",ObjectId:this.getId(),Name:o["Name"]+" "+t.message("BIZPROC_AUTOMATION_CMP_MOD_PRINTABLE_PREFIX"),Type:"string",Expression:"{{~"+this.getId()+":"+a+" > "+s+" # "+this.getTitle()+": "+o["Name"]+"}}",SystemExpression:"{="+this.getId()+":"+a+">"+s+"}"})}}}}}),this)}return e},getReturnProperty:function(t){var e=this.getReturnFieldsDescription();for(var i=0;i<e.length;++i){if(e[i]["Id"]===t){return e[i]}}return null},collectUsages:function(){var t=this.getProperties();var e={Document:new Set,Constant:new Set,Variable:new Set,Parameter:new Set,GlobalConstant:new Set,GlobalVariable:new Set,Activity:new Set};Object.keys(t).forEach((function(i){var a=t[i];this.collectExpressions(a,e)}),this);var i=this.getCondition().serialize();i.items.forEach((function(t){this.collectParsedExpressions(t[0],e)}),this);return e},collectExpressions:function(e,i){if(t.Type.isArray(e)){e.forEach((function(t){this.collectExpressions(t,i)}),this)}else if(t.Type.isPlainObject(e)){Object.keys(e).forEach((function(t){this.collectExpressions(e[t],i)}),this)}else if(t.Type.isStringFilled(e)){var a,o=new RegExp(s,"ig");while((a=o.exec(e))!==null){this.collectParsedExpressions(a.groups,i)}}},collectParsedExpressions:function(e,i){if(t.Type.isPlainObject(e)&&e["object"]&&e["field"]){switch(e["object"]){case"Document":i.Document.add(e["field"]);return;case"Constant":i.Constant.add(e["field"]);return;case"Variable":i.Variable.add(e["field"]);return;case"Template":i.Parameter.add(e["field"]);return;case"GlobalConst":i.GlobalConstant.add(e["field"]);return;case"GlobalVar":i.GlobalVariable.add(e["field"]);return}var a=new RegExp(/^A[_0-9]+$/,"ig");if(a.exec(e["object"])){i.Activity.add([e["object"],e["field"]])}}},hasBrokenLink:function(){var e=t.clone(this.collectUsages());if(!this.component||!this.template){return false}var i={Document:this.component.getDocumentFields(),Constant:this.template.getConstants(),Variable:this.template.getVariables(),GlobalConstant:this.component.getConstants(),GlobalVariable:this.component.getGVariables(),Parameter:this.template.getParameters(),Activity:this.template.getSerializedRobots()};for(var a in e){if(e[a].size>0){var o=new Set;for(var s in i[a]){if(i[a][s]["Id"]){o.add(i[a][s]["Id"])}else if(i[a][s]["Name"]){o.add(i[a][s]["Name"])}}for(var n of e[a].values()){var r=n;var l=n;if(t.Type.isArray(r)){r=n[0];l=n[1]}if(!o.has(r)){return true}if(a==="Activity"){var d=this.template.getRobotById(r);if(!d.getReturnProperty(l)){return true}}}}}return false}};var d=function(t){this.component=t};d.prototype={init:function(i,a){if(!t.type.isPlainObject(i))i={};this.viewMode=a||e.ViewMode.Edit;this.availableTriggers=t.type.isArray(i.AVAILABLE_TRIGGERS)?i.AVAILABLE_TRIGGERS:[];this.triggersData=t.type.isArray(i.TRIGGERS)?i.TRIGGERS:[];this.columnNodes=document.querySelectorAll('[data-type="column-trigger"]');this.listNodes=this.component.node.querySelectorAll('[data-role="trigger-list"]');this.buttonsNodes=this.component.node.querySelectorAll('[data-role="trigger-buttons"]');this.initButtons();this.initTriggers();this.markModified(false);for(var o=0;o<this.columnNodes.length;o++){jsDD.registerDest(this.columnNodes[o],10)}top.BX.addCustomEvent(top,"Rest:AppLayout:ApplicationInstall",this.onRestAppInstall.bind(this))},reInit:function(i,a){if(!t.type.isPlainObject(i))i={};var o;this.viewMode=a||e.ViewMode.Edit;for(o=0;o<this.listNodes.length;++o){t.cleanNode(this.listNodes[o])}for(o=0;o<this.buttonsNodes.length;++o){t.cleanNode(this.buttonsNodes[o])}if(this.triggers){this.triggers.forEach((function(t){t.destroy()}))}this.triggersData=t.type.isArray(i.TRIGGERS)?i.TRIGGERS:[];this.initTriggers();this.initButtons();this.markModified(false)},initTriggers:function(){this.triggers=[];for(var t=0;t<this.triggersData.length;++t){var e=new p(this);e.init(this.triggersData[t],this.viewMode);this.insertTriggerNode(e.getStatusId(),e.node);this.triggers.push(e)}},initButtons:function(){if(this.viewMode===e.ViewMode.Edit){for(var t=0;t<this.buttonsNodes.length;++t){this.createAddButton(this.buttonsNodes[t])}}},enableManageMode:function(){var e=document.querySelectorAll('[data-role="btn-delete-trigger"]');e.forEach((function(e){t.Dom.hide(e)}));this.triggers.forEach((function(e){t.Dom.addClass(e.node,"--locked-node")}))},disableManageMode:function(){var e=document.querySelectorAll('[data-role="btn-delete-trigger"]');e.forEach((function(e){t.Dom.show(e)}));this.triggers.forEach((function(e){t.Dom.removeClass(e.node,"--locked-node")}))},createAddButton:function(e){var i=this,a=t.create("span",{events:{click:function(t){if(!i.canEdit()){M.showNoPermissionsHint(this)}else if(!i.component.templateManager.isManageModeEnabled()){i.onAddButtonClick(this)}}},attrs:{className:"bizproc-automation-btn-add","data-status-id":e.getAttribute("data-status-id")},children:[t.create("span",{attrs:{className:"bizproc-automation-btn-add-text"},text:t.message("BIZPROC_AUTOMATION_CMP_ADD")})]});e.appendChild(a)},onAddButtonClick:function(i,a){var o=this,s,n=[];var r=function(t,e){o.addTrigger(e.triggerData,(function(t){this.openTriggerSettingsDialog(t,a)}));this.popupWindow.close()};for(s=0;s<this.availableTriggers.length;++s){if(this.availableTriggers[s].CODE==="APP"){n.push(this.createAppTriggerMenuItem(i.getAttribute("data-status-id"),this.availableTriggers[s]));continue}n.push({text:this.availableTriggers[s].NAME,triggerData:{DOCUMENT_STATUS:i.getAttribute("data-status-id")||a.statusId,CODE:this.availableTriggers[s].CODE},onclick:r})}t.PopupMenu.show(e.generateUniqueId(),i,n,{autoHide:true,offsetLeft:t.pos(i)["width"]/2,angle:{position:"top",offset:0},events:{onPopupClose:function(){this.destroy()}}})},onChangeTriggerClick:function(t,e){this.onAddButtonClick(e.target,{changeTrigger:true,statusId:t})},createAppTriggerMenuItem:function(e,i){var a=this,o=[];var s=function(t,e){a.addTrigger(e.triggerData,(function(t){this.openTriggerSettingsDialog(t)}));this.getRootMenuWindow().close()};for(var n=0;n<i["APP_LIST"].length;++n){var r=i["APP_LIST"][n];var l="["+r["APP_NAME"]+"] "+r["NAME"];o.push({text:t.util.htmlspecialchars(l),triggerData:{DOCUMENT_STATUS:e,NAME:l,CODE:i.CODE,APPLY_RULES:{APP_ID:r["APP_ID"],CODE:r["CODE"]}},onclick:s})}if(t.getClass("BX.rest.Marketplace")){if(o.length)o.push({delimiter:true});o.push({text:t.message("BIZPROC_AUTOMATION_ROBOT_CATEGORY_OTHER_MARKETPLACE_2"),onclick:function(){t.rest.Marketplace.open({PLACEMENT:a.component.data["MARKETPLACE_TRIGGER_PLACEMENT"]});this.getRootMenuWindow().close()}})}return{text:i.NAME,items:o}},addTrigger:function(t,e){var i=new p(this);i.init(t,this.viewMode);i.draft=true;if(e){e.call(this,i)}},deleteTrigger:function(t,e){t.destroy();if(t.getId()>0){t.markDeleted()}else{for(var i=0;i<this.triggers.length;++i){if(this.triggers[i]===t)this.triggers.splice(i,1)}}if(e)e(t);this.markModified()},enableDragAndDrop:function(){this.triggers.forEach((function(t){t.registerItem(t.node)}));this.component.node.querySelectorAll(".bizproc-automation-trigger-item-wrapper").forEach((function(e){t.Dom.addClass(e,"bizproc-automation-trigger-item-wrapper-draggable")}))},disableDragAndDrop:function(){this.triggers.forEach((function(t){t.unregisterItem(t.node)}));this.component.node.querySelectorAll(".bizproc-automation-trigger-item-wrapper").forEach((function(e){t.Dom.removeClass(e,"bizproc-automation-trigger-item-wrapper-draggable")}))},insertTriggerNode:function(t,e){var i=this.component.node.querySelector('[data-role="trigger-list"][data-status-id="'+t+'"]');if(i){i.appendChild(e)}},serialize:function(){var t=[];for(var e=0;e<this.triggers.length;++e){t.push(this.triggers[e].serialize())}return t},countAllTriggers:function(){var t=0;this.triggers.forEach((function(e){if(!e.deleted){++t}}));return t},getTriggerName:function(t){for(var e=0;e<this.availableTriggers.length;++e){if(t==this.availableTriggers[e]["CODE"])return this.availableTriggers[e]["NAME"]}return t},getAvailableTrigger:function(t){for(var e=0;e<this.availableTriggers.length;++e){if(t==this.availableTriggers[e]["CODE"])return this.availableTriggers[e]}return null},canEdit:function(){return this.component&&this.component.canEdit()},canSetExecuteBy(){return this.component.data["TRIGGER_CAN_SET_EXECUTE_BY"]},needSave:function(){return this.modified},markModified:function(t){this.modified=t!==false;if(this.modified&&this.component){this.component.markModified()}},openTriggerSettingsDialog:function(i,a){if(I.getTriggerSettingsDialog()){if(a&&a.changeTrigger){I.getTriggerSettingsDialog().popup.close()}else{return}}var o=this,s="bizproc_automation_trigger_dialog";var n=t.create("form",{props:{name:s},style:{"min-width":"540px"}});n.appendChild(o.renderConditionSettings(i));var r=t.create("div",{attrs:{className:"bizproc-automation-robot-help"},events:{click:t.delegate(this.component.onGlobalHelpClick,this.component)}});n.appendChild(r);var l=this.getTriggerName(i.data["CODE"]);n.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:t.message("BIZPROC_AUTOMATION_CMP_TRIGGER_NAME")+":"}));n.appendChild(t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("input",{attrs:{className:"bizproc-automation-popup-input",type:"text",name:"name",value:i.data["NAME"]||l}})]}));var d=this.getAvailableTrigger(i.data["CODE"]);if(i.data["CODE"]==="WEBHOOK"){if(!i.data["APPLY_RULES"]["code"])i.data["APPLY_RULES"]["code"]=t.util.getRandomString(5);n.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:"URL:"}));n.appendChild(t.create("input",{props:{type:"hidden",value:i.data["APPLY_RULES"]["code"],name:"code"}}));var p=t.create("textarea",{attrs:{className:"bizproc-automation-popup-textarea",placeholder:"...",readonly:"readonly",name:"webhook_handler"},events:{click:function(t){this.select()}}});n.appendChild(t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[p]}));n.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:t.message("BIZPROC_AUTOMATION_CMP_WEBHOOK_ID")}));if(d&&d["HANDLER"]){var c=window.location.protocol+"//"+window.location.host+d["HANDLER"];c=t.util.add_url_param(c,{code:i.data["APPLY_RULES"]["code"]});c=c.replace("{{DOCUMENT_TYPE}}",this.component.documentType[2]);p.value=c}}else if(i.data["CODE"]==="EMAIL_LINK"){n.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:t.message("BIZPROC_AUTOMATION_TRIGGER_EMAIL_LINK_URL")+":"}));n.appendChild(t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("textarea",{attrs:{className:"bizproc-automation-popup-textarea",placeholder:"https://example.com"},props:{name:"url"},text:i.data["APPLY_RULES"]["url"]||""})]}))}else if(i.data["CODE"]=="WEBFORM"){if(d&&d["WEBFORM_LIST"]){var u=t.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"},props:{name:"form_id",value:""},children:[t.create("option",{props:{value:""},text:t.message("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_ANY")})]});for(var h=0;h<d["WEBFORM_LIST"].length;++h){var m=d["WEBFORM_LIST"][h];u.appendChild(t.create("option",{props:{value:m["ID"]},text:m["NAME"]}))}if(t.type.isPlainObject(i.data["APPLY_RULES"])&&i.data["APPLY_RULES"]["form_id"]){u.value=i.data["APPLY_RULES"]["form_id"]}var f=t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_LABEL")+":"}),u]});n.appendChild(f)}}else if(i.data["CODE"]=="CALLBACK"){if(d&&d["WEBFORM_LIST"]){var u=t.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"},props:{name:"form_id",value:""},children:[t.create("option",{props:{value:""},text:t.message("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_ANY")})]});for(var h=0;h<d["WEBFORM_LIST"].length;++h){var m=d["WEBFORM_LIST"][h];u.appendChild(t.create("option",{props:{value:m["ID"]},text:m["NAME"]}))}if(t.type.isPlainObject(i.data["APPLY_RULES"])&&i.data["APPLY_RULES"]["form_id"]){u.value=i.data["APPLY_RULES"]["form_id"]}var f=t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_LABEL")+":"}),u]});n.appendChild(f)}}else if(i.data["CODE"]=="STATUS"){if(d&&d["STATUS_LIST"]){var u=t.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"},props:{name:"STATUS",value:""},children:[t.create("option",{props:{value:""},text:t.message("BIZPROC_AUTOMATION_TRIGGER_STATUS_ANY")})]});for(var h=0;h<d["STATUS_LIST"].length;++h){var m=d["STATUS_LIST"][h];u.appendChild(t.create("option",{props:{value:m["ID"]},text:m["NAME"]}))}if(t.type.isPlainObject(i.data["APPLY_RULES"])&&i.data["APPLY_RULES"]["STATUS"]){u.value=i.data["APPLY_RULES"]["STATUS"]}var f=t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:d["STATUS_LABEL"]+":"}),u]});n.appendChild(f)}}else if(i.data["CODE"]=="CALL"){if(d&&d["LINES"]){var u=t.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"},props:{name:"LINE_NUMBER",value:""},children:[t.create("option",{props:{value:""},text:t.message("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_ANY")})]});for(var h=0;h<d["LINES"].length;++h){var m=d["LINES"][h];u.appendChild(t.create("option",{props:{value:m["LINE_NUMBER"]},text:m["SHORT_NAME"]}))}if(i.data["APPLY_RULES"]["LINE_NUMBER"]){u.value=i.data["APPLY_RULES"]["LINE_NUMBER"]}var f=t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_TRIGGER_CALL_LABEL")+":"}),u]});n.appendChild(f)}}else if(i.data["CODE"]=="OPENLINE"||i.data["CODE"]=="OPENLINE_MSG"){if(d&&d["CONFIG_LIST"]){var u=t.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"},props:{name:"config_id",value:""},children:[t.create("option",{props:{value:""},text:t.message("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_ANY")})]});for(var h=0;h<d["CONFIG_LIST"].length;++h){var m=d["CONFIG_LIST"][h];u.appendChild(t.create("option",{props:{value:m["ID"]},text:m["NAME"]}))}if(t.type.isPlainObject(i.data["APPLY_RULES"])&&i.data["APPLY_RULES"]["config_id"]){u.value=i.data["APPLY_RULES"]["config_id"]}var f=t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_TRIGGER_OPENLINE_LABEL")+":"}),u]});n.appendChild(f)}}t.onCustomEvent("BX.Bizproc.Automation.TriggerManager:onOpenSettingsDialog-"+i.data["CODE"],[i,n]);if(this.canSetExecuteBy()){this.renderExecuteByControl(i,n)}this.renderAllowBackwardsControl(i,n);t.addClass(this.component.node,"automation-base-blocked");I.component=this.component;I.setTriggerSettingsDialog({component:this.component,trigger:i,form:n});var g=i.draft?this.createChangeTriggerTitleBar(l,i.data["DOCUMENT_STATUS"]):null;var T=new t.PopupWindow(e.generateUniqueId(),null,{titleBar:g||l,content:n,closeIcon:true,offsetLeft:0,offsetTop:0,closeByEsc:true,draggable:{restrict:false},overlay:false,events:{onPopupClose:function(e){I.setTriggerSettingsDialog(null);o.destroySettingsDialogControls();e.destroy();t.removeClass(o.component.node,"automation-base-blocked");if(i.draft){i.destroy()}}},buttons:[new t.PopupWindowButton({text:t.message("JS_CORE_WINDOW_SAVE"),className:"popup-window-button-accept",events:{click:function(){var e=t.ajax.prepareForm(n);i.data["NAME"]=e["data"]["name"];if(i.data["CODE"]==="WEBFORM"){i.data["APPLY_RULES"]={form_id:e["data"]["form_id"]}}if(i.data["CODE"]==="CALLBACK"){i.data["APPLY_RULES"]={form_id:e["data"]["form_id"]}}if(i.data["CODE"]==="STATUS"){i.data["APPLY_RULES"]={STATUS:e["data"]["STATUS"]}}if(i.data["CODE"]==="CALL"&&"LINE_NUMBER"in e["data"]){i.data["APPLY_RULES"]={LINE_NUMBER:e["data"]["LINE_NUMBER"]}}if(i.data["CODE"]==="OPENLINE"||i.data["CODE"]==="OPENLINE_MSG"){i.data["APPLY_RULES"]={config_id:e["data"]["config_id"]}}if(i.data["CODE"]==="WEBHOOK"){i.data["APPLY_RULES"]={code:e["data"]["code"]}}if(i.data["CODE"]==="EMAIL_LINK"){i.data["APPLY_RULES"]={url:e["data"]["url"]}}t.onCustomEvent("BX.Bizproc.Automation.TriggerManager:onSaveSettings-"+i.data["CODE"],[i,e]);o.setConditionSettingsFromForm(e["data"],i);i.setAllowBackwards(e["data"]["allow_backwards"]==="Y");if(o.canSetExecuteBy()){i.setExecuteBy(e["data"]["execute_by"])}if(i.draft){o.triggers.push(i);o.insertTriggerNode(i.getStatusId(),i.node)}delete i.draft;i.reInit();o.markModified();this.popupWindow.close()}}}),new t.PopupWindowButtonLink({text:t.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});I.getTriggerSettingsDialog().popup=T;T.show()},createChangeTriggerTitleBar:function(e,i){return{content:t.Dom.create("div",{props:{className:"popup-window-titlebar-text bizproc-automation-popup-titlebar-with-link"},children:[document.createTextNode(e),t.Dom.create("span",{props:{className:"bizproc-automation-popup-titlebar-link"},text:t.message("BIZPROC_AUTOMATION_CMP_CHANGE_TRIGGER"),events:{click:this.onChangeTriggerClick.bind(this,i)}})]})}},renderConditionSettings:function(e){var i=t.clone(e.getCondition());var a=this.conditionSelector=new N(i,{fields:this.component.data["DOCUMENT_FIELDS"]});return t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("div",{attrs:{className:"bizproc-automation-popup-settings-block"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION")+":"}),a.createNode()]})]})},renderExecuteByControl:function(e,i){i.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:t.message("BIZPROC_AUTOMATION_CMP_TRIGGER_EXECUTE_BY")+":"}));i.appendChild(t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.Bizproc.FieldType.renderControl(this.component.documentType,{Type:"user"},"execute_by",e.draft?o(this.component.data["DOCUMENT_FIELDS"]):e.getExecuteBy())]}))},renderAllowBackwardsControl:function(e,i){i.appendChild(t.create("div",{attrs:{className:"bizproc-automation-popup-checkbox"},children:[t.create("div",{attrs:{className:"bizproc-automation-popup-checkbox-item"},children:[t.create("label",{attrs:{className:"bizproc-automation-popup-chk-label"},children:[t.create("input",{attrs:{className:"bizproc-automation-popup-chk",type:"checkbox",name:"allow_backwards",value:"Y"},props:{checked:e.isBackwardsAllowed()}}),document.createTextNode(t.message("BIZPROC_AUTOMATION_CMP_TRIGGER_ALLOW_REVERSE"))]})]})]}))},setConditionSettingsFromForm:function(t,e){e.setCondition(A.createFromForm(t));return this},onRestAppInstall:function(e,i){i.redirect=false;var a=this;setTimeout((function(){t.ajax({method:"POST",dataType:"json",url:a.component.getAjaxUrl(),data:{ajax_action:"get_available_triggers",document_signed:a.component.documentSigned},onsuccess:function(e){if(t.type.isArray(e["DATA"])){a.availableTriggers=e["DATA"]}}})}),1500)},initSettingsDialogControls:function(e){if(!t.type.isArray(this.settingsDialogControls)){this.settingsDialogControls=[]}var i=e.querySelectorAll("[data-role]");for(var a=0;a<i.length;++a){var o=null;var s=i[a].getAttribute("data-role");if(s==="user-selector"){o=t.Bizproc.UserSelector.decorateNode(i[a])}t.UI.Hint.init(i[a]);if(o){this.settingsDialogControls.push(o)}}},destroySettingsDialogControls:function(){if(this.conditionSelector){this.conditionSelector.destroy();this.conditionSelector=null}if(t.type.isArray(this.settingsDialogControls)){for(var e=0;e<this.settingsDialogControls.length;++e){if(t.type.isFunction(this.settingsDialogControls[e].destroy)){this.settingsDialogControls[e].destroy()}}}this.settingsDialogControls=null},getListByDocumentStatus:function(t){var e=[];this.triggers.forEach((function(i){if(i.getStatusId()===t){e.push(i)}}));return e},getReturnProperties:function(t){var e=[];var i={};var a=this.getListByDocumentStatus(t);a.forEach((function(t){var a=t.deleted?[]:t.getReturnProperties();if(a.length){a.forEach((function(a){if(!i[a.Id]){e.push({Id:a.Id,ObjectId:"Template",Name:a.Name,ObjectName:t.getName(),Type:a.Type,Expression:"{{~*:"+a.Id+"}}",SystemExpression:"{=Template:"+a.Id+"}"});i[a.Id]=true}}))}}));return e},getReturnProperty:function(t,e){var i=this.getReturnProperties(t);for(var a=0;a<i.length;++a){if(i[a].Id===e){return i[a]}}return null}};var p=function(e){this.manager=e;this.component=e.component;this.tracker=e.component.tracker;this.data={};this.deleted=false;this.draggableItem=null;this.droppableItem=null;this.droppableColumn=null;this.stub=null;this.column=null;if(this.component){this.searchHandler=this.onSearch.bind(this);t.Event.EventEmitter.subscribe(this.component,"BX.Bizproc.Automation.Component:onSearch",this.searchHandler)}};p.prototype={init:function(i,a){this.data=t.clone(i)||{};if(!t.type.isPlainObject(this.data["APPLY_RULES"])){this.data["APPLY_RULES"]={}}if(this.data.APPLY_RULES.Condition){this.condition=new A(this.data.APPLY_RULES.Condition)}else{this.condition=new A}this.viewMode=a||e.ViewMode.Edit;this.node=this.createNode()},reInit:function(t,e){var i=this.node;this.node=this.createNode();if(i.parentNode)i.parentNode.replaceChild(this.node,i)},destroy:function(){if(this.searchHandler){t.Event.EventEmitter.unsubscribe(this.component,"BX.Bizproc.Automation.Component:onSearch",this.searchHandler)}},canEdit:function(){return this.manager.canEdit()},getId:function(){return this.data["ID"]||0},getStatusId:function(){return this.data["DOCUMENT_STATUS"]||""},getCode:function(){return this.data["CODE"]},getName:function(){var t=this.data["NAME"];if(!t){t=this.manager.getTriggerName(this.data["CODE"])}return t},getLogStatus:function(){var t=this.tracker.getTriggerLog(this.getId());return t?parseInt(t["STATUS"]):null},getCondition:function(){return this.condition},setCondition:function(t){this.condition=t;return this},isBackwardsAllowed:function(){return this.data["APPLY_RULES"]["ALLOW_BACKWARDS"]==="Y"},setAllowBackwards:function(t){this.data["APPLY_RULES"]["ALLOW_BACKWARDS"]=t?"Y":"N";return this},getExecuteBy:function(){return this.data["APPLY_RULES"]["ExecuteBy"]||""},setExecuteBy:function(t){this.data["APPLY_RULES"]["ExecuteBy"]=t;return this},createNode:function(){var i="bizproc-automation-trigger-item-wrapper";if(this.canEdit()){i+=" bizproc-automation-trigger-item-wrapper-draggable"}var a=t.create("div",{attrs:{className:"bizproc-automation-trigger-item-wrapper-edit"},text:t.message("BIZPROC_AUTOMATION_CMP_EDIT")});var o=t.create("div",{attrs:{className:"bizproc-automation-trigger-btn-copy"},text:t.message("BIZPROC_AUTOMATION_CMP_COPY")||"copy"});t.bind(o,"click",this.onCopyButtonClick.bind(this,o));if(this.getLogStatus()===e.LogStatus.Completed){i+=" bizproc-automation-trigger-item-wrapper-complete"}else if(this.component.isPreviousStatus(this.getStatusId())){i+=" bizproc-automation-trigger-item-wrapper-complete-light"}var s=this.getName();var n="bizproc-automation-trigger-item";if(this.getLogStatus()===e.LogStatus.Completed){n+=" --complete"}var r=t.create("DIV",{attrs:{"data-role":"trigger-container",className:n,"data-type":"item-trigger"},children:[t.create("div",{attrs:{className:i},children:[t.create("div",{attrs:{className:"bizproc-automation-trigger-item-wrapper-text"},text:s})]}),o,a]});if(this.canEdit()){this.registerItem(r)}var l=t.create("SPAN",{attrs:{"data-role":"btn-delete-trigger",className:"bizproc-automation-trigger-btn-delete"}});t.bind(l,"click",this.onDeleteButtonClick.bind(this,l));r.appendChild(l);t.bind(r,"click",this.onSettingsButtonClick.bind(this,r));return r},onSettingsButtonClick:function(t){if(!this.canEdit()){M.showNoPermissionsHint(t)}else if(!this.component.templateManager.isManageModeEnabled()){this.manager.openTriggerSettingsDialog(this)}},onCopyButtonClick:function(t,e){e.stopPropagation();if(!this.canEdit()){M.showNoPermissionsHint(t)}else if(!this.component.templateManager.isManageModeEnabled()){var i=new p(this.manager);var a=this.serialize();delete a["ID"];if(a["CODE"]==="WEBHOOK"){a["APPLY_RULES"]={}}i.init(a,this.viewMode);this.manager.triggers.push(i);this.manager.insertTriggerNode(i.getStatusId(),i.node);this.manager.markModified()}},onSearch:function(e){if(!this.node){return}var i=e.getData().queryString;var a=!i||this.getName().toLowerCase().indexOf(i)>=0;t[a?"removeClass":"addClass"](this.node,"--search-mismatch")},registerItem:function(e){if(t.Type.isNil(e["__bxddid"])){e.onbxdragstart=t.proxy(this.dragStart,this);e.onbxdrag=t.proxy(this.dragMove,this);e.onbxdragstop=t.proxy(this.dragStop,this);e.onbxdraghover=t.proxy(this.dragOver,this);jsDD.registerObject(e);jsDD.registerDest(e,1)}},unregisterItem:function(t){t.onbxdragstart=undefined;t.onbxdrag=undefined;t.onbxdragstop=undefined;t.onbxdraghover=undefined;jsDD.unregisterObject(t);jsDD.unregisterDest(t)},dragStart:function(){this.draggableItem=t.proxy_context;if(!this.draggableItem){jsDD.stopCurrentDrag();return}if(!this.stub){var e=this.draggableItem.offsetWidth;this.stub=this.draggableItem.cloneNode(true);this.stub.style.position="absolute";this.stub.classList.add("bizproc-automation-trigger-item-drag");this.stub.style.width=e+"px";document.body.appendChild(this.stub)}},dragMove:function(t,e){this.stub.style.left=t+"px";this.stub.style.top=e+"px"},dragOver:function(t,e,i){if(this.droppableItem){this.droppableItem.classList.remove("bizproc-automation-trigger-item-pre")}if(this.droppableColumn){this.droppableColumn.classList.remove("bizproc-automation-trigger-list-pre")}var a=t.getAttribute("data-type");if(a==="item-trigger"){this.droppableItem=t;this.droppableColumn=null}if(a==="column-trigger"){this.droppableColumn=t.querySelector('[data-role="trigger-list"]');this.droppableItem=null}if(this.droppableItem){this.droppableItem.classList.add("bizproc-automation-trigger-item-pre")}if(this.droppableColumn){this.droppableColumn.classList.add("bizproc-automation-trigger-list-pre")}},dragStop:function(t,e,i){i=i||window.event;var a,o=i&&(i.ctrlKey||i.metaKey);var s=function(t,e){var i=new p(t.manager);var a=t.serialize();delete a["ID"];if(a["CODE"]==="WEBHOOK"){a["APPLY_RULES"]={}}a["DOCUMENT_STATUS"]=e;i.init(a,t.viewMode);return i};if(this.draggableItem){if(this.droppableItem){this.droppableItem.classList.remove("bizproc-automation-trigger-item-pre");var n=this.droppableItem.parentNode;if(!o){n.insertBefore(this.draggableItem,this.droppableItem);this.moveTo(n.getAttribute("data-status-id"))}else{a=s(this,n.getAttribute("data-status-id"));n.insertBefore(a.node,this.droppableItem)}}else if(this.droppableColumn){this.droppableColumn.classList.remove("bizproc-automation-trigger-list-pre");if(!o){this.droppableColumn.appendChild(this.draggableItem);this.moveTo(this.droppableColumn.getAttribute("data-status-id"))}else{a=s(this,this.droppableColumn.getAttribute("data-status-id"));this.droppableColumn.appendChild(a.node)}}if(a){this.manager.triggers.push(a);this.manager.markModified()}}this.stub.parentNode.removeChild(this.stub);this.stub=null;this.draggableItem=null;this.droppableItem=null},onDeleteButtonClick:function(e,i){i.stopPropagation();if(!this.canEdit()){M.showNoPermissionsHint(e)}else if(!this.component.templateManager.isManageModeEnabled()){t.remove(e.parentNode);this.manager.deleteTrigger(this)}},updateData:function(e){if(t.type.isPlainObject(e)){this.data=e}else throw"Invalid data"},markDeleted:function(){this.deleted=true;return this},serialize:function(){var e=t.clone(this.data);if(this.deleted){e["DELETED"]="Y"}if(!t.type.isPlainObject(e.APPLY_RULES)){e.APPLY_RULES={}}if(!this.condition.items.length){delete e.APPLY_RULES.Condition}else{e.APPLY_RULES.Condition=this.condition.serialize()}return e},moveTo:function(t){this.data["DOCUMENT_STATUS"]=t;this.manager.markModified()},getReturnProperties:function(){var e=this.manager.getAvailableTrigger(this.getCode());return e&&t.type.isArray(e.RETURN)?e.RETURN:[]}};var c=function(t){this.component=t};c.prototype={init:function(e){if(!t.type.isPlainObject(e))e={};this.log=e;this.triggers={};this.robots={};for(var i in e){if(!e.hasOwnProperty(i))continue;if(e[i]["trigger"]){this.triggers[e[i]["trigger"]["ID"]]=e[i]["trigger"]}if(e[i]["robots"]){for(var a in e[i]["robots"]){if(!e[i]["robots"].hasOwnProperty(a))continue;this.robots[a]=e[i]["robots"][a]}}}},reInit:function(t){this.init(t)},getRobotLog:function(t){return this.robots[t]||null},getTriggerLog:function(t){return this.triggers[t]||null}};var u=function(e,i){var a,o=i.getAttribute("data-config");if(o){a=t.parseJSON(o)}if(!t.type.isPlainObject(a))a={};this.container=i;this.type=a.type||u.Type.File;if(a.selected&&!a.selected.length){this.type=u.Type.None}this.multiple=a.multiple||false;this.required=a.required||false;this.valueInputName=a.valueInputName||"";this.typeInputName=a.typeInputName||"";this.useDisk=a.useDisk||false;this.label=a.label||"Attachment";this.labelFile=a.labelFile||"File";this.labelDisk=a.labelDisk||"Disk";var s=e.template?e.template.robots:[];this.setFileFields(e.component.data["DOCUMENT_FIELDS"],s);this.createDom();if(a.selected&&a.selected.length>0){this.addItems(t.clone(a.selected))}};u.Type={None:"",Disk:"disk",File:"file"};u.prototype={setFileFields:function(e,i){var a=[];var o={};for(var s=0;s<e.length;++s){if(e[s]["Type"]==="file"){a.push(e[s])}}if(t.type.isArray(i)){i.forEach((function(t){t.getReturnFieldsDescription().forEach((function(e){if(e["Type"]==="file"){var i="{{~"+t.getId()+":"+e["Id"]+"}}";a.push({Id:i,Name:t.getTitle()+": "+e["Name"],Type:"file",Expression:i});o[i]=t.getTitle()+": "+e["Name"]}}))}))}this.fileFields=a;this.fileLabels=o;return this},createDom:function(){this.container.appendChild(this.createBaseNode());this.showTypeControllerLayout(this.type)},createBaseNode:function(){var i=e.generateUniqueId();var a=null;if(this.fileFields.length>0){a=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",type:"radio",id:"type-1"+i,name:this.typeInputName,value:u.Type.File}});if(this.type===u.Type.File){a.setAttribute("checked","checked")}}var o=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",type:"radio",id:"type-2"+i,name:this.typeInputName,value:u.Type.Disk}});if(this.type===u.Type.Disk){o.setAttribute("checked","checked")}var s=[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:this.label+":"})];if(a){s.push(a,t.create("label",{attrs:{className:"bizproc-automation-popup-settings-link",for:"type-1"+i},text:this.labelFile,events:{click:this.onTypeChange.bind(this,u.Type.File)}}))}s.push(o,t.create("label",{attrs:{className:"bizproc-automation-popup-settings-link",for:"type-2"+i},text:this.labelDisk,events:{click:this.onTypeChange.bind(this,u.Type.Disk)}}));return t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[t.create("div",{attrs:{className:"bizproc-automation-popup-settings-block"},children:s})]})},showTypeControllerLayout:function(t){if(t===u.Type.Disk){this.hideFileControllerLayout();this.showDiskControllerLayout()}else if(t===u.Type.File){this.hideDiskControllerLayout();this.showFileControllerLayout()}else{this.hideFileControllerLayout();this.hideDiskControllerLayout()}},showDiskControllerLayout:function(){if(!this.diskControllerNode){this.diskControllerNode=t.create("div");this.container.appendChild(this.diskControllerNode);var e=this.getDiskUploader();e.layout(this.diskControllerNode);e.show(true)}else{t.show(this.diskControllerNode)}},hideDiskControllerLayout:function(){if(this.diskControllerNode){t.hide(this.diskControllerNode)}},showFileControllerLayout:function(){if(!this.fileControllerNode){this.fileItemsNode=t.create("span");this.fileControllerNode=t.create("div",{children:[this.fileItemsNode]});this.container.appendChild(this.fileControllerNode);var e=t.create("a",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-popup-settings-link-thin"},text:t.message("BIZPROC_AUTOMATION_CMP_ADD")});this.fileControllerNode.appendChild(e);t.bind(e,"click",this.onFileFieldAddClick.bind(this,e))}else{t.show(this.fileControllerNode)}},hideFileControllerLayout:function(){if(this.fileControllerNode){t.hide(this.fileControllerNode)}},getDiskUploader:function(){if(!this.diskUploader){this.diskUploader=t.Bizproc.Automation.DiskUploader.create("",{msg:{diskAttachFiles:t.message("BIZPROC_AUTOMATION_CMP_DISK_ATTACH_FILE"),diskAttachedFiles:t.message("BIZPROC_AUTOMATION_CMP_DISK_ATTACHED_FILES"),diskSelectFile:t.message("BIZPROC_AUTOMATION_CMP_DISK_SELECT_FILE"),diskSelectFileLegend:t.message("BIZPROC_AUTOMATION_CMP_DISK_SELECT_FILE_LEGEND"),diskUploadFile:t.message("BIZPROC_AUTOMATION_CMP_DISK_UPLOAD_FILE"),diskUploadFileLegend:t.message("BIZPROC_AUTOMATION_CMP_DISK_UPLOAD_FILE_LEGEND")}});this.diskUploader.setMode(1)}return this.diskUploader},onTypeChange:function(t){if(this.type!==t){this.type=t;this.showTypeControllerLayout(this.type)}},isFileItemSelected:function(t){var e=this.fileItemsNode.querySelector('[data-file-id="'+t.id+'"]');return!!e},addFileItem:function(e){if(this.isFileItemSelected(e)){return false}var i=this.createFileItemNode(e);if(!this.multiple){t.cleanNode(this.fileItemsNode)}this.fileItemsNode.appendChild(i)},addItems:function(t){if(this.type===u.Type.File){for(var e=0;e<t.length;++e){this.addFileItem(t[e])}}else{this.getDiskUploader().setValues(this.convertToDiskItems(t))}},convertToDiskItems:function(t){var e=[];for(var i=0;i<t.length;++i){var a=t[i];e.push({ID:a["id"],NAME:a["name"],SIZE:a["size"],VIEW_URL:""})}return e},removeFileItem:function(t){var e=this.fileItemsNode.querySelector('[data-file-id="'+t.id+'"]');if(e){this.fileItemsNode.removeChild(e)}},onFileFieldAddClick:function(i,a){var o=this,s,n=[];var r=this.fileFields;for(s=0;s<r.length;++s){n.push({text:t.util.htmlspecialchars(r[s]["Name"]),field:r[s],onclick:function(t,e){this.popupWindow.close();o.onFieldSelect(e.field)}})}if(!this.menuId){this.menuId=e.generateUniqueId()}t.PopupMenu.show(this.menuId,i,n,{autoHide:true,offsetLeft:t.pos(i)["width"]/2,angle:{position:"top",offset:0}});this.menu=t.PopupMenu.currentItem;a.preventDefault()},onFieldSelect:function(t){this.addFileItem({id:t.Id,expression:t.Expression,name:t.Name,type:u.Type.File})},destroy:function(){if(this.menu){this.menu.popupWindow.close()}},createFileItemNode:function(e){var i=e.name||"";if(this.fileLabels[i]){i=this.fileLabels[i]}return t.create("span",{attrs:{className:"bizproc-automation-popup-autocomplete-item","data-file-id":e.id,"data-file-expression":e.expression},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-autocomplete-name"},text:i}),t.create("span",{attrs:{className:"bizproc-automation-popup-autocomplete-delete"},events:{click:this.removeFileItem.bind(this,e)}})]})},onBeforeSave:function(){var e=[];if(this.type===u.Type.Disk){e=this.getDiskUploader().getValues()}else if(this.type===u.Type.File){this.fileItemsNode.childNodes.forEach((function(t){var i=t.getAttribute("data-file-expression");if(i!==""){e.push(i)}}))}for(var i=0;i<e.length;++i){this.container.appendChild(t.create("input",{props:{type:"hidden",name:this.valueInputName+(this.multiple?"[]":""),value:e[i]}}))}}};var h=function(e,i,a){var o=this;this.robot=e;this.component=e.component;this.documentFields=this.component?this.component.data["DOCUMENT_FIELDS"]:a["DOCUMENT_FIELDS"];this.showTemplatePropertiesMenuOnSelecting=this.component?this.component.data["SHOW_TEMPLATE_PROPERTIES_MENU_ON_SELECTING"]===true:false;this.targetInput=t.clone(i);this.menuButton=t.create("span",{attrs:{className:"bizproc-automation-popup-select-dotted"},events:{click:t.delegate(o.openMenu,this)}});this.appendPropertyMods=true;var s=t.create("div",{attrs:{className:"bizproc-automation-popup-select"},children:[this.targetInput,this.menuButton]});i.parentNode.replaceChild(s,i);t.bind(this.targetInput,"keydown",(function(t){o.onKeyDown(this,t)}));this.targetInput.setAttribute("autocomplete","off");this.fieldProperty=JSON.parse(this.targetInput.getAttribute("data-property"));if(this.fieldProperty){delete this.fieldProperty.Default}if(!this.fieldProperty||!this.robot){this.showTemplatePropertiesMenuOnSelecting=false}this.fieldType=this.targetInput.getAttribute("data-selector-type");if(this.fieldType==="date"||this.fieldType==="datetime"){this.initDateTimeControl()}else if(this.fieldType==="file"){this.initFileControl()}if(this.targetInput.getAttribute("data-select-mode")==="replace"){this.replaceOnWrite=true}this.selectCallback=function(t){o.onFieldSelect(t.getCustomData().get("property"))}};h.prototype={onKeyDown:function(t,e){if(e.keyCode==45&&e.altKey===false&&e.ctrlKey===false&&e.shiftKey===false){this.openMenu(e);e.preventDefault()}},openMenu:function(i,a){if(!a&&this.showTemplatePropertiesMenuOnSelecting&&!this.targetInput.value){return this.openPropertiesSwitcherMenu()}if(this.dialog){this.dialog.show();return}var o=this,s,n,r=this.getFields();var l=[],d=[],p={ROOT:{title:this.component?this.component.data["ENTITY_NAME"]:P.documentName,entityId:"bp",tabs:"recents",id:"ROOT",children:[]}};for(s=0;s<r.length;++s){n=r[s];var c,u=n["Id"].indexOf(".")<0?"ROOT":n["Id"].split(".")[0];var h=n["Name"];var m="";if(h&&u!=="ROOT"&&h.indexOf(": ")>=0){c=h.split(": ");m=c.shift();h=c.join(": ")}if(n["Id"].indexOf("ASSIGNED_BY_")===0&&n["Id"]!=="ASSIGNED_BY_ID"&&n["Id"]!=="ASSIGNED_BY_PRINTABLE"){u="ASSIGNED_BY";c=h.split(" ");m=c.shift();h=c.join(" ").replace("(","").replace(")","")}if(!p[u]){p[u]={title:m,entityId:"bp",tabs:"recents",tabId:"bp",id:m,children:[]}}if(n["Type"]==="file"){d.push(n)}p[u]["children"].push({title:h||n["Id"],customData:{property:n},entityId:"bp",tabs:"recents",id:n["SystemExpression"]})}if(!this.fieldsOnly){if(this.robot){var f=this.robot.getId();var g=[];var T=this.robot.template;var b=T?T.robots:[];b.forEach((function(t){if(t.getId()!==f){var e=[];t.getReturnFieldsDescription().forEach((function(t){if(t["Type"]==="file"){d.push(t)}e.push({title:t["Name"]||t["Id"],customData:{property:t},entityId:"bp",tabs:"recents",id:t["SystemExpression"]})}));if(e.length){g.push({title:t.getTitle(),entityId:"bp",tabs:"recents",id:t.getId(),children:e})}}}));if(g.length){p["__RESULT"]={title:t.message("BIZPROC_AUTOMATION_CMP_ROBOT_LIST"),entityId:"bp",tabs:"recents",id:"__RESULT",children:g}}}var O=this.getTriggerProperties().map((function(t){return{title:t["Name"]||t["Id"],subtitle:t["ObjectName"]||t["ObjectId"],customData:{property:t},entityId:"bp",tabs:"recents",id:t["SystemExpression"]}}));if(O.length){p["__TRESULT"]={title:t.message("BIZPROC_AUTOMATION_CMP_TRIGGER_LIST"),entityId:"bp",tabs:"recents",id:"__TRESULT",children:O}}if(d.length&&this.appendPropertyMods){p["__FILES"]={title:t.message("BIZPROC_AUTOMATION_CMP_FILES_LINKS"),entityId:"bp",tabs:"recents",id:"__FILES",children:this.prepareFilesMenu(d)}}var I=[];if(T&&T.data.CONSTANTS&&!this.showTemplatePropertiesMenuOnSelecting){T.getConstants().forEach((function(e){I.push({title:e["Name"],customData:{property:e},entityId:"bp",tabs:"recents",id:e.SystemExpression,supertitle:t.message("BIZPROC_AUTOMATION_CMP_TEMPLATE_CONSTANTS_LIST")})}))}if(this.component&&this.component.data["GLOBAL_CONSTANTS"]){this.component.getConstants().forEach((function(t){I.push({title:t["Name"],customData:{property:t},entityId:"bp",tabs:"recents",id:t.SystemExpression,supertitle:t.supertitle})}),this)}if(I.length){p["__CONSTANTS"]={title:t.message("BIZPROC_AUTOMATION_CMP_CONSTANTS_LIST"),entityId:"bp",tabs:"recents",id:"__CONSTANTS",children:I}}if(this.component&&this.component.data["GLOBAL_VARIABLES"]){var v=[];this.component.getGVariables().forEach((function(t){v.push({title:t["Name"],customData:{property:t},entityId:"bp",tabs:"recents",id:t.SystemExpression,supertitle:t.supertitle})}),this);if(v.length>0){p["__GLOB_VARIABLES"]={title:t.message("BIZPROC_AUTOMATION_CMP_GLOB_VARIABLES_LIST_1"),entityId:"bp",tabs:"recents",id:"__GLOB_VARIABLES",children:v}}}}if(Object.keys(p).length<2){if(p["ROOT"]["children"].length>0){l=p["ROOT"]["children"]}}else{if(p["ROOT"]["children"].length>0){l.push(p["ROOT"])}delete p["ROOT"];for(u in p){if(p.hasOwnProperty(u)&&p[u]["children"].length>0){l.push(p[u])}}}var _=this.menuButton.getAttribute("data-selector-id");if(!_){_=e.generateUniqueId();this.menuButton.setAttribute("data-selector-id",_)}this.dialog=new t.UI.EntitySelector.Dialog({targetNode:this.menuButton,width:500,height:300,multiple:false,dropdownMode:true,enableSearch:true,items:this.injectDialogMenuTitles(l),showAvatars:false,events:{"Item:onBeforeSelect":function(t){t.preventDefault();o.selectCallback(t.getData().item)}},compactView:true});this.dialog.show()},openPropertiesSwitcherMenu:function(){var i=this;t.PopupMenu.show(e.generateUniqueId(),this.menuButton,[{text:t.message("BIZPROC_AUTOMATION_ASK_CONSTANT"),onclick:function(t){this.popupWindow.close();i.onFieldSelect(i.robot.template.addConstant(i.fieldProperty))}},{text:t.message("BIZPROC_AUTOMATION_ASK_PARAMETER"),onclick:function(t){this.popupWindow.close();i.onFieldSelect(i.robot.template.addParameter(i.fieldProperty))}},{text:t.message("BIZPROC_AUTOMATION_ASK_MANUAL"),onclick:function(t){this.popupWindow.close();i.openMenu(t,true)}}],{autoHide:true,offsetLeft:20,angle:{position:"top"},events:{onPopupClose:function(){this.destroy()}}});this.switcherDialog=t.PopupMenu.currentItem;return true},injectDialogMenuTitles:function(e){e.forEach((function(e){if(t.type.isArray(e.children)){e.searchable=false;this.injectDialogMenuSupertitles(e.title,e.children)}}),this);return e},injectDialogMenuSupertitles:function(e,i){i.forEach((function(i){if(!i.supertitle){i.supertitle=e}if(t.type.isArray(i.children)){i.searchable=false;this.injectDialogMenuSupertitles(i.title,i.children)}}),this)},prepareFilesMenu:function(t){var e=[];t.forEach((function(t){var i=t["ObjectId"]==="Document"?"{{"+t["Name"]+" > shortlink}}":"{{~"+t["ObjectId"]+":"+t["Id"]+" > shortlink}}";var a=t["Name"]||t["Id"];if(t.ObjectName){a=t.ObjectName+": "+a}e.push({title:a,customData:{property:{Id:t["Id"]+"_shortlink",ObjectId:t["ObjectId"],Name:t["Name"],Type:"string",Expression:i,SystemExpression:"{="+t["ObjectId"]+":"+t["Id"]+" > shortlink}"}},entityId:"bp",tabs:"recents",id:i})}));return e},onFieldSelect:function(e){if(!e){return}var i=this.targetInput.tagName.toLowerCase();if(i==="select"){var a=this.targetInput.querySelector('[data-role="expression"]');if(!a){a=this.targetInput.appendChild(t.create("option",{attrs:{"data-role":"expression"}}))}a.setAttribute("value",e["Expression"]);a.textContent=e["Expression"];a.selected=true}else if(i==="label"){this.targetInput.textContent=e["Expression"];var o=document.getElementById(this.targetInput.getAttribute("for"));if(o){o.value=e["Expression"]}}else{if(this.replaceOnWrite){this.targetInput.value=e["Expression"];this.targetInput.selectionEnd=this.targetInput.value.length}else{var s=this.targetInput.value.substr(0,this.targetInput.selectionEnd),n=e["Expression"],r=this.targetInput.value.substr(this.targetInput.selectionEnd);this.targetInput.value=s+n+r;this.targetInput.selectionEnd=s.length+n.length}}t.fireEvent(this.targetInput,"change")},destroy:function(){if(this.dialog){this.dialog.destroy()}if(this.switcherDialog){this.switcherDialog.destroy()}},initDateTimeControl:function(){var e=[];var i=this.documentFields;if(t.type.isArray(this.documentFields)){var a,s;for(a=0;a<this.documentFields.length;++a){s=this.documentFields[a];if(s["Type"]==="date"||s["Type"]==="datetime"){e.push(s)}}}this.documentFields=e;this.replaceOnWrite=true;var n=new O({labelNode:this.targetInput,basisFields:e,useAfterBasis:true,onchange:function(t){this.targetInput.value=t.toExpression(e,o(i))}.bind(this)});n.init(v.fromString(this.targetInput.value,e))},initFileControl:function(){var e=[];if(t.type.isArray(this.component.data["DOCUMENT_FIELDS"])){var i,a;for(i=0;i<this.component.data["DOCUMENT_FIELDS"].length;++i){a=this.component.data["DOCUMENT_FIELDS"][i];if(a["Type"]==="file"){e.push(a)}}}this.documentFields=e;this.replaceOnWrite=true},getFields:function(){var e=t.message("BIZPROC_AUTOMATION_CMP_MOD_PRINTABLE_PREFIX");var i=[];this.documentFields.forEach((function(t){i.push(t["Name"])}));var a=i.join("\n");var o=[];var s=this.fieldType;this.documentFields.forEach((function(i){i.ObjectId="Document";var s=i["BaseType"]==="string"&&i["Type"]!=="string";if(!s||!this.appendPropertyMods){o.push(i)}if(!this.appendPropertyMods){return}if(i["Type"]==="user"||i["Type"]==="bool"||i["Type"]==="file"||s){var n=i["Name"]+" "+e;if(a.indexOf(n)<0){var r=t.clone(i);var l=i["Type"]==="user"?"friendly":"printable";r["Name"]=n;r["Type"]="string";r["SystemExpression"]="{=Document:"+r["Id"]+" > "+l+"}";r["Expression"]="{{"+i["Name"]+" > "+l+"}}";o.push(r)}}if(i["BaseType"]==="date"||i["BaseType"]==="datetime"){var d=t.clone(i);d["Name"]+=" "+t.message("BIZPROC_AUTOMATION_CMP_MOD_DATE_BY_SERVER");d["Type"]="string";d["SystemExpression"]="{=Document:"+d["Id"]+" > server}";d["Expression"]="{{"+i["Name"]+" > server}}";o.push(d);var p=t.clone(i);p["Name"]+=" "+t.message("BIZPROC_AUTOMATION_CMP_MOD_DATE_BY_RESPONSIBLE");p["Type"]="string";p["SystemExpression"]="{=Document:"+d["Id"]+" > responsible}";p["Expression"]="{{"+i["Name"]+" > responsible}}";o.push(p)}}),this);return o},getTriggerProperties:function(){var t=[];if(this.robot&&this.robot.template&&this.component&&this.component.triggerManager){t=this.component.triggerManager.getReturnProperties(this.robot.template.getStatusId())}return t}};var m=function(e,i,a,o){this.component=t.Bizproc.Automation.Designer.component;this.robot=t.Bizproc.Automation.Designer.robot;this.documentFields=i;this.menuButton=e;this.appendPropertyMods=false;this.selectCallback=function(t){a(t.getCustomData().get("property"))};this.fieldsOnly=!(o&&o.parentGroup&&o.parentGroup.type===A.Type.Mixed)};t.extend(m,h);var f=function(e,i,a){this.robot=e;this.component=e.component;this.documentFields=this.component?this.component.data["DOCUMENT_FIELDS"]:a["DOCUMENT_FIELDS"];this.showTemplatePropertiesMenuOnSelecting=this.component?this.component.data["SHOW_TEMPLATE_PROPERTIES_MENU_ON_SELECTING"]===true:false;this.fieldProperty=JSON.parse(i.getAttribute("data-property"));if(this.fieldProperty){delete this.fieldProperty.Default}if(!this.fieldProperty||!this.robot){this.showTemplatePropertiesMenuOnSelecting=false}this.targetInput=this.menuButton=i;this.userSelector=t.Bizproc.UserSelector.decorateNode(i,this.getSelectorConfig(e))};t.extend(f,h);f.prototype.destroy=function(){if(this.userSelector){this.userSelector.destroy();this.userSelector=null}if(this.switcherDialog){this.switcherDialog.destroy()}};f.prototype.getSelectorConfig=function(e){var i=e.template?e.template.robots:[];var a=[];if(t.type.isArray(i)){i.forEach((function(t){t.getReturnFieldsDescription().forEach((function(e){if(e["Type"]==="user"){a.push({id:"{{~"+t.getId()+":"+e["Id"]+"}}",title:t.getTitle()+": "+e["Name"]})}}))}))}if(this.showTemplatePropertiesMenuOnSelecting){const i=e.template.addConstant(t.clone(this.fieldProperty));a.push({id:i.Expression,title:t.message("BIZPROC_AUTOMATION_ASK_CONSTANT"),tabs:["recents","bpuserroles"],sort:1});const o=e.template.addParameter(t.clone(this.fieldProperty));a.push({id:o.Expression,title:t.message("BIZPROC_AUTOMATION_ASK_PARAMETER"),tabs:["recents","bpuserroles"],sort:2})}return{additionalFields:a}};var g=function(e,i){var a=this;this.robot=e;this.component=e.component;this.documentFields=this.component.data["DOCUMENT_FIELDS"];this.editorNode=i.firstElementChild.firstElementChild;this.menuButton=t.create("span",{attrs:{className:"bizproc-automation-popup-select-dotted"},events:{click:t.delegate(a.openMenu,this)}});i.firstElementChild.appendChild(this.menuButton);this.bindEvents();this.selectCallback=function(t){a.onFieldSelect(t.getCustomData().get("property"))};this.appendPropertyMods=true};t.extend(g,h);g.prototype.getEditor=function(){var t;if(this.editorNode){var e=this.editorNode.id.split("-");t=BXHtmlEditor.Get(e[e.length-1])}return t};g.prototype.bindEvents=function(){this.editorInitFunction=this.bindEditorHooks.bind(this);t.addCustomEvent("OnEditorInitedAfter",this.editorInitFunction)};g.prototype.unBindEvents=function(){t.removeCustomEvent("OnEditorInitedAfter",this.editorInitFunction)};g.prototype.bindEditorHooks=function(e){var i="",a="";if(e.dom.cont!==this.editorNode){return false}t.addCustomEvent(e,"OnParse",(function(t){if(!t){var e=this.content;e=e.replace(/(^[\s\S]*?)(<body.*?>)/i,(function(t){i=t;return""}));e=e.replace(/(<\/body>[\s\S]*?$)/i,(function(t){a=t;return""}));this.content=e}}));t.addCustomEvent(e,"OnAfterParse",(function(t){if(t){var e=this.content;e=e.replace(/^[\s\S]*?<body.*?>/i,"");e=e.replace(/<\/body>[\s\S]*?$/i,"");if(i!==""&&a!==""){e=i+e+a}this.content=e}}))};g.prototype.onFieldSelect=function(t){var e=t["Expression"];var i=this.getEditor();if(i&&i.InsertHtml){i.InsertHtml(e)}};g.prototype.destroy=function(){if(this.menu)this.menu.popupWindow.close();this.unBindEvents()};g.prototype.onBeforeSave=function(){var t=this.getEditor();if(t&&t.SaveContent){t.SaveContent()}};g.prototype.onPopupResize=function(){var t=this.getEditor();if(t&&t.ResizeSceleton){t.ResizeSceleton()}};var T=function(e){this.targetInput=e;var i=new Date,a=this.unFormatTime(e.value);i.setHours(0,0,0,0);i.setTime(i.getTime()+a*1e3);e.value=this.formatTime(i);t.bind(e,"click",t.delegate(this.showClock,this))};T.prototype={showClock:function(e){if(!this.clockInstance){this.clockInstance=new t.CClockSelector({start_time:this.unFormatTime(this.targetInput.value),node:this.targetInput,callback:t.delegate(this.onTimeSelect,this)})}this.clockInstance.Show()},onTimeSelect:function(e){this.targetInput.value=e;t.fireEvent(this.targetInput,"change");this.clockInstance.closeWnd()},unFormatTime:function(t){var e=t.split(/[\s:]+/);if(e.length==3){var i=e[2];if(i=="pm"&&e[0]<12)e[0]=parseInt(e[0],10)+12;if(i=="am"&&e[0]==12)e[0]=0}return parseInt(e[0],10)*3600+parseInt(e[1],10)*60},formatTime:function(e){var i=t.date.convertBitrixFormat(t.message("FORMAT_DATE")).replace(/:?\s*s/,""),a=t.date.convertBitrixFormat(t.message("FORMAT_DATETIME")).replace(/:?\s*s/,""),o=t.date.format(i,e),s=t.date.format(a,e);return t.util.trim(s.replace(o,""))},destroy:function(){if(this.clockInstance)this.clockInstance.closeWnd()}};var b=function(t,e){this.checkbox=t;this.robot=e;this.needSync=e.draft;if(this.needSync){var i=this.getKey();var a=e.component.getUserOption("save_state_checkboxes",i,"N");if(a==="Y"){t.checked=true}}};b.prototype={getKey:function(){return this.checkbox.getAttribute("data-save-state-key")},destroy:function(){if(this.needSync){var t=this.getKey();var e=this.checkbox.checked?"Y":"N";this.robot.component.setUserOption("save_state_checkboxes",t,e)}}};var O=function(e){this.basisFields=[];this.onchange=null;if(t.type.isPlainObject(e)){this.labelNode=e.labelNode;this.useAfterBasis=e.useAfterBasis;if(t.type.isArray(e.basisFields))this.basisFields=e.basisFields;this.onchange=e.onchange;this.minLimitM=e.minLimitM}};O.prototype={init:function(t){this.delay=t;this.setLabelText();this.bindLabelNode();this.prepareBasisFields()},setLabelText:function(){if(this.delay&&this.labelNode){this.labelNode.textContent=E(this.delay,t.message("BIZPROC_AUTOMATION_CMP_AT_ONCE"),this.basisFields)}},bindLabelNode:function(){if(this.labelNode){t.bind(this.labelNode,"click",t.delegate(this.onLabelClick,this))}},onLabelClick:function(t){this.showDelayIntervalPopup();t.preventDefault()},showDelayIntervalPopup:function(){var i=this,a=this.delay;var o=e.generateUniqueId();var s=t.create("form",{attrs:{className:"bizproc-automation-popup-select-block"}});var n=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",id:o+"now",type:"radio",value:"now",name:"type"}});if(a.isNow())n.setAttribute("checked","checked");var r=t.create("label",{attrs:{className:"bizproc-automation-popup-select-wrapper",for:o+"now"},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message(this.useAfterBasis?"BIZPROC_AUTOMATION_CMP_BASIS_NOW":"BIZPROC_AUTOMATION_CMP_AT_ONCE_2")})]});var l=t.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":t.message(this.useAfterBasis?"BIZPROC_AUTOMATION_CMP_DELAY_NOW_HELP_2":"BIZPROC_AUTOMATION_CMP_DELAY_NOW_HELP")}});r.appendChild(l);s.appendChild(t.create("div",{attrs:{className:"bizproc-automation-popup-select-item"},children:[n,r]}));s.appendChild(this.createAfterControlNode());if(this.basisFields.length>0){s.appendChild(this.createBeforeControlNode());s.appendChild(this.createInControlNode())}var d=t.create("input",{attrs:{type:"checkbox",id:o+"worktime",name:"worktime",value:"1",style:"vertical-align: middle"},props:{checked:a.workTime}});var p=t.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":t.message("BIZPROC_AUTOMATION_CMP_DELAY_WORKTIME_HELP_2")}});s.appendChild(t.create("div",{attrs:{className:"bizproc-automation-popup-settings-title"},children:[d,t.create("label",{attrs:{className:"bizproc-automation-popup-settings-lbl",for:o+"worktime"},text:t.message("BIZPROC_AUTOMATION_CMP_WORK_TIME")}),p]}));t.UI.Hint.init(s);var c=new t.PopupWindow(e.generateUniqueId(),this.labelNode,{autoHide:true,closeByEsc:true,closeIcon:false,titleBar:false,angle:true,offsetLeft:20,content:s,buttons:[new t.PopupWindowButton({text:t.message("BIZPROC_AUTOMATION_CMP_CHOOSE"),className:"webform-button webform-button-create bizproc-automation-button-left",events:{click:function(){var e=t.ajax.prepareForm(s);i.saveFormData(e["data"]);this.popupWindow.close()}}})],events:{onPopupClose:function(){if(i.fieldsMenu){i.fieldsMenu.popupWindow.close()}if(i.valueTypeMenu){i.valueTypeMenu.popupWindow.close()}this.destroy()}},overlay:{backgroundColor:"transparent"}});c.show()},saveFormData:function(e){if(e["type"]==="now"){this.delay.setNow()}else if(e["type"]===v.Type.In){this.delay.setType(v.Type.In);this.delay.setValue(0);this.delay.setValueType("i");this.delay.setBasis(e["basis_in"])}else{this.delay.setType(e["type"]);this.delay.setValue(e["value_"+e["type"]]);this.delay.setValueType(e["value_type_"+e["type"]]);if(e["type"]===v.Type.After){if(this.useAfterBasis){this.delay.setBasis(e["basis_after"])}else{this.delay.setBasis(v.Basis.CurrentDateTime)}if(this.minLimitM>0&&this.delay.basis===v.Basis.CurrentDateTime&&this.delay.valueType==="i"&&this.delay.value<this.minLimitM){t.UI.Notification.Center.notify({content:t.message("BIZPROC_AUTOMATION_DELAY_MIN_LIMIT_LABEL")});this.delay.setValue(this.minLimitM)}}else{this.delay.setBasis(e["basis_before"])}}this.delay.setWorkTime(e["worktime"]);this.setLabelText();if(this.onchange){this.onchange(this.delay)}},createAfterControlNode:function(){var i=this,a=this.delay;var o=e.generateUniqueId();var s=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",id:o,type:"radio",value:v.Type.After,name:"type"}});if(a.type===v.Type.After&&a.value>0)s.setAttribute("checked","checked");var n=t.create("input",{attrs:{type:"text",name:"value_after",className:"bizproc-automation-popup-settings-input"},props:{value:a.type===v.Type.After&&a.value?a.value:this.minLimitM||5}});var r=t.create("label",{attrs:{className:"bizproc-automation-popup-select-wrapper",for:o},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_CMP_THROUGH_3")}),n,this.createValueTypeSelector("value_type_after")]});if(this.useAfterBasis){r.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-auto-width"},text:t.message("BIZPROC_AUTOMATION_CMP_AFTER")}));var l=this.getBasisField(a.basis,true);var d=a.basis;if(!l){l=this.getBasisField(v.Basis.CurrentDateTime,true);d=l.SystemExpression}var p=t.create("input",{attrs:{type:"hidden",name:"basis_after",value:d}});var c=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-delay-interval-basis"},text:l?l.Name:t.message("BIZPROC_AUTOMATION_CMP_CHOOSE_DATE_FIELD"),events:{click:function(t){i.onBasisClick(t,this,(function(t){c.textContent=t.Name;p.value=t.SystemExpression}),v.Type.After)}}});r.appendChild(p);r.appendChild(c)}if(!this.useAfterBasis){var u=t.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":t.message("BIZPROC_AUTOMATION_CMP_DELAY_AFTER_HELP")}});r.appendChild(u)}return t.create("div",{attrs:{className:"bizproc-automation-popup-select-item"},children:[s,r]})},createBeforeControlNode:function(){var i=this,a=this.delay;var o=e.generateUniqueId();var s=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",id:o,type:"radio",value:v.Type.Before,name:"type"}});if(a.type===v.Type.Before)s.setAttribute("checked","checked");var n=t.create("input",{attrs:{type:"text",name:"value_before",className:"bizproc-automation-popup-settings-input"},props:{value:a.type===v.Type.Before&&a.value?a.value:this.minLimitM||5}});var r=t.create("label",{attrs:{className:"bizproc-automation-popup-select-wrapper",for:o},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_CMP_FOR_TIME_3")}),n,this.createValueTypeSelector("value_type_before"),t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-auto-width"},text:t.message("BIZPROC_AUTOMATION_CMP_BEFORE_1")})]});var l=this.getBasisField(a.basis);var d=a.basis;if(!l){l=this.basisFields[0];d=l.SystemExpression}var p=t.create("input",{attrs:{type:"hidden",name:"basis_before",value:d}});var c=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-delay-interval-basis"},text:l?l.Name:t.message("BIZPROC_AUTOMATION_CMP_CHOOSE_DATE_FIELD"),events:{click:function(t){i.onBasisClick(t,this,(function(t){c.textContent=t.Name;p.value=t.SystemExpression}),v.Type.Before)}}});r.appendChild(p);r.appendChild(c);if(!this.useAfterBasis){var u=t.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":t.message("BIZPROC_AUTOMATION_CMP_DELAY_BEFORE_HELP")}});r.appendChild(u)}return t.create("div",{attrs:{className:"bizproc-automation-popup-select-item"},children:[s,r]})},createInControlNode:function(){var i=this,a=this.delay;var o=e.generateUniqueId();var s=t.create("input",{attrs:{className:"bizproc-automation-popup-select-input",id:o,type:"radio",value:v.Type.In,name:"type"}});if(a.type===v.Type.In)s.setAttribute("checked","checked");var n=t.create("label",{attrs:{className:"bizproc-automation-popup-select-wrapper",for:o},children:[t.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:t.message("BIZPROC_AUTOMATION_CMP_IN_TIME_2")})]});var r=this.getBasisField(a.basis);var l=a.basis;if(!r){r=this.basisFields[0];l=r.SystemExpression}var d=t.create("input",{attrs:{type:"hidden",name:"basis_in",value:l}});var p=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-delay-interval-basis"},text:r?r.Name:t.message("BIZPROC_AUTOMATION_CMP_CHOOSE_DATE_FIELD"),events:{click:function(t){i.onBasisClick(t,this,(function(t){p.textContent=t.Name;d.value=t.SystemExpression}))}}});n.appendChild(d);n.appendChild(p);if(!this.useAfterBasis){var c=t.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":t.message("BIZPROC_AUTOMATION_CMP_DELAY_IN_HELP")}});n.appendChild(c)}return t.create("div",{attrs:{className:"bizproc-automation-popup-select-item"},children:[s,n]})},createValueTypeSelector:function(e){var i=this.delay;var a={i:t.message("BIZPROC_AUTOMATION_CMP_INTERVAL_M"),h:t.message("BIZPROC_AUTOMATION_CMP_INTERVAL_H"),d:t.message("BIZPROC_AUTOMATION_CMP_INTERVAL_D")};var o=t.create("label",{attrs:{className:"bizproc-automation-popup-settings-link"},text:a[i.valueType]});var s=t.create("input",{attrs:{type:"hidden",name:e},props:{value:i.valueType}});t.bind(o,"click",this.onValueTypeSelectorClick.bind(this,o,s));return t.create("span",{children:[o,s]})},onValueTypeSelectorClick:function(i,a){var o=e.generateUniqueId();var s=function(t,e){this.popupWindow.close();a.value=e.valueId;i.textContent=e.text};var n=[{text:t.message("BIZPROC_AUTOMATION_CMP_INTERVAL_M"),valueId:"i",onclick:s},{text:t.message("BIZPROC_AUTOMATION_CMP_INTERVAL_H"),valueId:"h",onclick:s},{text:t.message("BIZPROC_AUTOMATION_CMP_INTERVAL_D"),valueId:"d",onclick:s}];t.PopupMenu.show(o,i,n,{autoHide:true,offsetLeft:25,angle:{position:"top"},events:{onPopupClose:function(){this.destroy()}},overlay:{backgroundColor:"transparent"}});this.valueTypeMenu=t.PopupMenu.currentItem},onBasisClick:function(i,a,o,s){var n=this,r,l=[];if(s===v.Type.After){l.push({text:t.message("BIZPROC_AUTOMATION_CMP_BASIS_NOW"),field:{Name:t.message("BIZPROC_AUTOMATION_CMP_BASIS_NOW"),SystemExpression:v.Basis.CurrentDateTime},onclick:function(t,e){if(o)o(e.field);this.popupWindow.close()}},{text:t.message("BIZPROC_AUTOMATION_CMP_BASIS_DATE"),field:{Name:t.message("BIZPROC_AUTOMATION_CMP_BASIS_DATE"),SystemExpression:v.Basis.CurrentDate},onclick:function(t,e){if(o)o(e.field);this.popupWindow.close()}},{delimiter:true})}for(r=0;r<this.basisFields.length;++r){if(s!==v.Type.After&&this.basisFields[r]["Id"].indexOf("DATE_CREATE")>-1){continue}l.push({text:t.util.htmlspecialchars(this.basisFields[r].Name),field:this.basisFields[r],onclick:function(t,e){if(o)o(e.field||e.options.field);this.popupWindow.close()}})}var d=a.getAttribute("data-menu-id");if(!d){d=e.generateUniqueId();a.setAttribute("data-menu-id",d)}t.PopupMenu.show(d,a,l,{autoHide:true,offsetLeft:t.pos(a)["width"]/2,angle:{position:"top",offset:0},overlay:{backgroundColor:"transparent"}});this.fieldsMenu=t.PopupMenu.currentItem},getBasisField:function(e,i){if(i&&(e===v.Basis.CurrentDateTime||e===v.Basis.CurrentDateTimeLocal)){return{Name:t.message("BIZPROC_AUTOMATION_CMP_BASIS_NOW"),SystemExpression:v.Basis.CurrentDateTime}}if(i&&e===v.Basis.CurrentDate){return{Name:t.message("BIZPROC_AUTOMATION_CMP_BASIS_DATE"),SystemExpression:v.Basis.CurrentDate}}var a=null;for(var o=0;o<this.basisFields.length;++o){if(e===this.basisFields[o].SystemExpression)a=this.basisFields[o]}return a},prepareBasisFields:function(){var t,e,i=[];for(t=0;t<this.basisFields.length;++t){e=this.basisFields[t];if(e["Id"].indexOf("DATE_MODIFY")<0&&e["Id"].indexOf("EVENT_DATE")<0&&e["Id"].indexOf("BIRTHDATE")<0)i.push(e)}this.basisFields=i}};var I={setRobotSettingsDialog:function(t){this.robotSettingsDialog=t;this.component=t?t.robot.component:null;this.robot=t?t.robot:null},getRobotSettingsDialog:function(){return this.robotSettingsDialog},setTriggerSettingsDialog:function(t){this.triggerSettingsDialog=t;this.component=t?t.component:null},getTriggerSettingsDialog:function(){return this.triggerSettingsDialog}};var v=function(e){this.basis=v.Basis.CurrentDateTime;this.type=v.Type.After;this.value=0;this.valueType="i";this.workTime=false;this.localTime=false;if(t.type.isPlainObject(e)){if(e["type"])this.setType(e["type"]);if(e["value"])this.setValue(e["value"]);if(e["valueType"])this.setValueType(e["valueType"]);if(e["basis"])this.setBasis(e["basis"]);if(e["workTime"])this.setWorkTime(e["workTime"]);if(e["localTime"])this.setLocalTime(e["localTime"])}};v.Type={After:"after",Before:"before",In:"in"};v.Basis={CurrentDate:"{=System:Date}",CurrentDateTime:"{=System:Now}",CurrentDateTimeLocal:"{=System:NowLocal}"};v.isSystemBasis=function(t){return t===this.Basis.CurrentDate||t===this.Basis.CurrentDateTime||t===this.Basis.CurrentDateTimeLocal};v.fromString=function(e,i){e=e.toString();var a={basis:v.Basis.CurrentDateTime,i:0,h:0,d:0,workTime:false,localTime:false};if(e.indexOf("=dateadd(")===0||e.indexOf("=workdateadd(")===0){if(e.indexOf("=workdateadd(")===0){e=e.substr(13);a["workTime"]=true}else{e=e.substr(9)}var o=e.split(",");a["basis"]=o[0].trim();o[1]=o[1].replace(/['")]+/g,"");a["type"]=o[1].indexOf("-")===0?v.Type.Before:v.Type.After;var s,n=/s*([\d]+)\s*(i|h|d)\s*/gi;while(s=n.exec(o[1])){a[s[2]]=parseInt(s[1])}}else{a["basis"]=e}if(!v.isSystemBasis(a["basis"])&&t.type.isArray(i)){var r=false;for(var l=0,d=i.length;l<d;++l){if(a["basis"]===i[l].SystemExpression||a["basis"]===i[l].Expression){a["basis"]=i[l].SystemExpression;r=true;break}}if(!r){a["basis"]=v.Basis.CurrentDateTime}}var p=a["i"]+a["h"]*60+a["d"]*60*24;if(p%1440===0){a["value"]=p/1440;a["valueType"]="d"}else if(p%60===0){a["value"]=p/60;a["valueType"]="h"}else{a["value"]=p;a["valueType"]="i"}if(!a["value"]&&a["basis"]!==v.Basis.CurrentDateTime&&a["basis"]){a["type"]=v.Type.In}return new v(a)};v.fromMinutes=function(t){var e,i;if(t%1440===0){e=t/1440;i="d"}else if(t%60===0){e=t/60;i="h"}else{e=t;i="i"}return[e,i]};v.toMinutes=function(t,e){var i=0;switch(e){case"i":i=t;break;case"h":i=t*60;break;case"d":i=t*60*24;break}return i};v.prototype={setType:function(t){if(t!==v.Type.After&&t!==v.Type.Before&&t!==v.Type.In){t=v.Type.After}this.type=t},setValue:function(t){t=parseInt(t);this.value=t>=0?t:0},setValueType:function(t){if(t!=="i"&&t!=="h"&&t!=="d")t="i";this.valueType=t},setBasis:function(e){if(t.type.isNotEmptyString(e))this.basis=e},setWorkTime:function(t){this.workTime=!!t},setLocalTime:function(t){this.localTime=!!t},isNow:function(){return this.type===v.Type.After&&this.basis===v.Basis.CurrentDateTime&&!this.value},setNow:function(){this.setType(v.Type.After);this.setValue(0);this.setValueType("i");this.setBasis(v.Basis.CurrentDateTime)},serialize:function(){return{type:this.type,value:this.value,valueType:this.valueType,basis:this.basis,workTime:this.workTime?1:0}},toExpression:function(e,i){var a=this.basis?this.basis:v.Basis.CurrentDate;if(!v.isSystemBasis(a)&&t.type.isArray(e)){for(var o=0,s=e.length;o<s;++o){if(a===e[o].SystemExpression){a=e[o].Expression;break}}}if(!this.workTime&&(this.type===v.Type.In||this.isNow())){return a}var n=0,r=0,l=0;switch(this.valueType){case"i":l=this.value;break;case"h":r=this.value;break;case"d":n=this.value;break}var d="";if(this.type===v.Type.Before)d="-";if(n>0)d+=n+"d";if(r>0)d+=r+"h";if(l>0)d+=l+"i";var p=this.workTime?"workdateadd":"dateadd";if(p==="workdateadd"&&d===""){d="0d"}var c="";if(p==="workdateadd"&&i){c=i}return"="+p+"("+a+',"'+d+'"'+(c?","+c:"")+")"}};var _=function(e,i){this.object="Document";this.field="";this.operator="!empty";this.value="";this.parentGroup=null;if(t.type.isPlainObject(e)){if(e["object"]){this.setObject(e["object"])}if(e["field"]){this.setField(e["field"])}if(e["operator"]){this.setOperator(e["operator"])}if("value"in e){this.setValue(e["value"])}}if(i){this.parentGroup=i}};_.prototype={setObject:function(e){if(t.type.isNotEmptyString(e)){this.object=e}},setField:function(e){if(t.type.isNotEmptyString(e)){this.field=e}},setOperator:function(t){if(!t){t="="}this.operator=t},setValue:function(t){this.value=t;if(this.operator==="="&&this.value===""){this.operator="empty"}else if(this.operator==="!="&&this.value===""){this.operator="!empty"}},serialize:function(){return{object:this.object,field:this.field,operator:this.operator,value:this.value}}};var A=function(e){this.type=A.Type.Field;this.items=[];if(t.type.isPlainObject(e)){if(e["type"]){this.type=e["type"]}if(t.type.isArray(e["items"])){var i=this;e["items"].forEach((function(t){var e=new _(t[0],i);i.addItem(e,t[1])}))}}};A.Type={Field:"field",Mixed:"mixed"};A.Joiner={And:"AND",Or:"OR",message:function(e){if(e===this.Or){return t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_OR")}return t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_AND")}};A.createFromForm=function(e,i){var a,o=new A;if(!i){i="condition_"}if(t.type.isArray(e[i+"field"])){for(a=0;a<e[i+"field"].length;++a){if(e[i+"field"][a]===""){continue}var s=new _({},o);s.setObject(e[i+"object"][a]);s.setField(e[i+"field"][a]);s.setOperator(e[i+"operator"][a]);s.setValue(e[i+"value"][a]);var n=A.Joiner.And;if(e[i+"joiner"]&&e[i+"joiner"][a]===A.Joiner.Or){n=A.Joiner.Or}o.addItem(s,n)}}return o};A.prototype={addItem:function(t,e){this.items.push([t,e])},serialize:function(){var t=[];this.items.forEach((function(e){if(e.field!==""){t.push([e[0].serialize(),e[1]])}}));return{type:this.type,items:t}}};var N=function(e,i){this.conditionGroup=e;this.fields=[];this.fieldPrefix="condition_";this.itemSelectors=[];if(t.type.isPlainObject(i)){if(t.type.isArray(i.fields)){this.fields=i.fields}if(i.fieldPrefix){this.fieldPrefix=i.fieldPrefix}}};N.prototype={createNode:function(){var e=this,i=[],a=this.fields;this.conditionGroup.items.forEach((function(t){var o=new C(t[0],{fields:a,joiner:t[1],fieldPrefix:e.fieldPrefix});this.itemSelectors.push(o);i.push(o.createNode())}),this);i.push(t.create("a",{attrs:{className:"bizproc-automation-popup-settings-link"},text:"[+]",events:{click:function(){e.addItem(this)}}}));var o=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link-wrapper"},children:i});return o},addItem:function(t){var e=new C(new _({},this.conditionGroup),{fields:this.fields,fieldPrefix:this.fieldPrefix});this.itemSelectors.push(e);t.parentNode.insertBefore(e.createNode(),t)},destroy:function(){this.itemSelectors.forEach((function(t){t.destroy()}));this.itemSelectors=[]}};var C=function(e,i){this.condition=e;this.fields=[];this.joiner=A.Joiner.And;this.fieldPrefix="condition_";if(t.type.isPlainObject(i)){if(t.type.isArray(i.fields)){this.fields=i.fields.map((function(t){t.ObjectId="Document";return t}))}if(i.joiner&&i.joiner===A.Joiner.Or){this.joiner=A.Joiner.Or}if(i.fieldPrefix){this.fieldPrefix=i.fieldPrefix}}};C.prototype={createNode:function(){var e=this.objectNode=t.create("input",{attrs:{type:"hidden",name:this.fieldPrefix+"object[]",value:this.condition.object}});var i=this.fieldNode=t.create("input",{attrs:{type:"hidden",name:this.fieldPrefix+"field[]",value:this.condition.field}});var a=this.operatorNode=t.create("input",{attrs:{type:"hidden",name:this.fieldPrefix+"operator[]",value:this.condition.operator}});var o=this.valueNode=t.create("input",{attrs:{type:"hidden",name:this.fieldPrefix+"value[]",value:this.condition.value}});var s=this.joinerNode=t.create("input",{attrs:{type:"hidden",name:this.fieldPrefix+"joiner[]",value:this.joiner}});var n=this.labelNode=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link-wrapper"}});this.setLabelText();this.bindLabelNode();var r=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link-remove"},events:{click:this.removeCondition.bind(this)}});var l=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-condition-joiner"},text:A.Joiner.message(this.joiner)});t.bind(l,"click",this.changeJoiner.bind(this,l));this.node=t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link-wrapper bizproc-automation-condition-wrapper"},children:[e,i,a,o,s,n,r,l]});return this.node},init:function(t){this.condition=t;this.setLabelText();this.bindLabelNode()},setLabelText:function(){if(!this.labelNode||!this.condition)return;t.cleanNode(this.labelNode);if(this.condition.field!==""){var e=this.getField(this.condition.object,this.condition.field)||"?";var i=this.condition.operator.indexOf("empty")<0?t.Bizproc.FieldType.formatValuePrintable(e,this.condition.value):null;this.labelNode.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link"},text:e.Name}));this.labelNode.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link"},text:this.getOperatorLabel(this.condition.operator)}));if(i){this.labelNode.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link"},text:i}))}}else{this.labelNode.appendChild(t.create("span",{attrs:{className:"bizproc-automation-popup-settings-link"},text:t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_EMPTY")}))}},bindLabelNode:function(){if(this.labelNode){t.bind(this.labelNode,"click",t.delegate(this.onLabelClick,this))}},onLabelClick:function(t){this.showPopup()},showPopup:function(){if(this.popup){this.popup.show();return}var e=this,i=this.filterFields();var a=t.create("input",{attrs:{type:"hidden",className:"bizproc-automation-popup-settings-dropdown"}});var o=t.create("input",{attrs:{type:"hidden",className:"bizproc-automation-popup-settings-dropdown"}});var s=t.create("div",{attrs:{className:"bizproc-automation-popup-settings-dropdown",readonly:"readonly"},children:[o]});t.bind(s,"click",this.onFieldSelectorClick.bind(this,s,o,i,a));var n=this.getField(this.condition.object,this.condition.field);if(!this.condition.field){n=i[0]}o.value=n.Id;a.value=n.ObjectId;s.textContent=n.Name;var r=this.condition.operator.indexOf("empty")<0?this.createValueNode(n,this.condition.value):null;var l=t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[r]});var d=this.createOperatorNode(n,l);var p=t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[d]});if(this.condition.field!==""){d.value=this.condition.operator}var c=t.create("form",{attrs:{className:"bizproc-automation-popup-select-block"},children:[t.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[s]}),p,l]});t.bind(o,"change",this.onFieldChange.bind(this,o,p,l,a));var u=this.popup=new t.PopupWindow("bizproc-automation-popup-set",this.labelNode,{className:"bizproc-automation-popup-set",autoHide:false,closeByEsc:true,closeIcon:false,titleBar:false,angle:true,offsetLeft:45,overlay:{backgroundColor:"transparent"},content:c,buttons:[new t.PopupWindowButton({text:t.message("BIZPROC_AUTOMATION_CMP_CHOOSE"),className:"webform-button webform-button-create",events:{click:function(){e.condition.setObject(a.value);e.condition.setField(o.value);e.condition.setOperator(p.firstChild.value);var t=l.querySelector('[name^="'+e.fieldPrefix+'value"]');if(t){e.condition.setValue(t.value)}else{e.condition.setValue("")}e.setLabelText();e.updateValueNodes();this.popupWindow.close()}}}),new t.PopupWindowButtonLink({text:t.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})],events:{onPopupClose:function(){this.destroy();if(e.fieldDialog){e.fieldDialog.destroy();delete e.fieldDialog}delete e.popup}}});u.show()},onFieldSelectorClick:function(e,i,a,o,s){if(!this.fieldDialog){this.fieldDialog=new m(e,a,(function(a){e.textContent=a.Name;i.value=a.Id;o.value=a.ObjectId;t.fireEvent(i,"change")}),this.condition)}this.fieldDialog.openMenu(s)},updateValueNodes:function(){if(this.condition){if(this.objectNode){this.objectNode.value=this.condition.object}if(this.fieldNode){this.fieldNode.value=this.condition.field}if(this.operatorNode){this.operatorNode.value=this.condition.operator}if(this.valueNode){this.valueNode.value=this.condition.value}}},onFieldChange:function(t,e,i,a){var o=this.getField(a.value,t.value);var s=this.createOperatorNode(o,i);e.replaceChild(s,e.firstChild);this.onOperatorChange(s,o,i)},onOperatorChange:function(e,i,a){t.cleanNode(a);if(e.value.indexOf("empty")<0){var o=this.createValueNode(i);a.appendChild(o)}},getField:function(t,e){var i;var a=I.robot;var o=I.component;var s=a?a.template:null;switch(t){case"Document":for(var n=0;n<this.fields.length;++n){if(e===this.fields[n].Id){i=this.fields[n]}}break;case"Template":if(s&&o&&o.triggerManager){i=o.triggerManager.getReturnProperty(s.getStatusId(),e)}break;case"Constant":if(s){i=s.getConstant(e)}break;case"GlobalConst":if(o){i=o.getConstant(e)}break;default:var r=s?s.getRobotById(t):null;if(r){i=r.getReturnProperty(e)}break}return i||{Id:e,ObjectId:t,Name:e,Type:"string",Expression:e,SystemExpression:"{="+t+":"+e+"}"}},getOperators:function(e,i){var a={"!empty":t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_EMPTY"),empty:t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_EMPTY"),"=":t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_EQ"),"!=":t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_NE")};switch(e){case"file":case"UF:crm":case"UF:resourcebooking":a={"!empty":t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_EMPTY"),empty:t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_EMPTY")};break;case"bool":case"select":if(i){a["contain"]=t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_CONTAIN");a["!contain"]=t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_CONTAIN")}else{}break;case"user":a["in"]=t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_IN");a["!in"]=t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_IN");a["contain"]=t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_CONTAIN");a["!contain"]=t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_CONTAIN");break;default:a["in"]=t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_IN");a["!in"]=t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_IN");a["contain"]=t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_CONTAIN");a["!contain"]=t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_CONTAIN");a[">"]=t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_GT");a[">="]=t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_GTE");a["<"]=t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_LT");a["<="]=t.message("BIZPROC_AUTOMATION_ROBOT_CONDITION_LTE")}return a},getOperatorLabel:function(t){return this.getOperators()[t]},filterFields:function(){var t,e,i=[];for(t=0;t<this.fields.length;++t){e=this.fields[t]["Type"];if(e=="bool"||e=="date"||e=="datetime"||e=="double"||e=="file"||e=="int"||e=="select"||e=="string"||e=="text"||e=="user"||e=="UF:money"||e=="UF:crm"||e=="UF:resourcebooking"||e=="UF:url"){i.push(this.fields[t])}else{}}return i},createValueNode:function(e,i){var a=I.component?I.component.documentType:P.documentType;var o=t.clone(e);o.Multiple=false;return t.Bizproc.FieldType.renderControl(a,o,this.fieldPrefix+"value",i)},createOperatorNode:function(e,i){var a=t.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"}});var o=this.getOperators(e["Type"],e["Multiple"]);for(var s in o){if(!o.hasOwnProperty(s))continue;a.appendChild(t.create("option",{props:{value:s},text:o[s]}))}t.bind(a,"change",this.onOperatorChange.bind(this,a,e,i));return a},removeCondition:function(e){this.condition=null;t.remove(this.node);this.labelNode=this.fieldNode=this.operatorNode=this.valueNode=this.node=null;e.stopPropagation()},changeJoiner:function(t,e){this.joiner=this.joiner===A.Joiner.Or?A.Joiner.And:A.Joiner.Or;t.textContent=A.Joiner.message(this.joiner);if(this.joinerNode){this.joinerNode.value=this.joiner}e.preventDefault()},destroy:function(){if(this.popup){this.popup.close()}}};var E=function(e,i,a){var o=i,s;if(e.type==v.Type.In){o=t.message("BIZPROC_AUTOMATION_CMP_IN_TIME");if(t.type.isArray(a)){for(var n=0;n<a.length;++n){if(e.basis==a[n].SystemExpression){o+=" "+a[n].Name;break}}}}else if(e.value){s=e.type==v.Type.After?t.message("BIZPROC_AUTOMATION_CMP_THROUGH"):t.message("BIZPROC_AUTOMATION_CMP_FOR_TIME_1");o=s+" "+S(e.value,e.valueType);if(t.type.isArray(a)){var r=e.type==v.Type.After?t.message("BIZPROC_AUTOMATION_CMP_AFTER"):t.message("BIZPROC_AUTOMATION_CMP_BEFORE_1");for(var n=0;n<a.length;++n){if(e.basis==a[n].SystemExpression){o+=" "+r+" "+a[n].Name;break}}}}if(e.workTime){o+=", "+t.message("BIZPROC_AUTOMATION_CMP_IN_WORKTIME")}return o};var y=function(e){var i=[];if(e==="i")i=[t.message("BIZPROC_AUTOMATION_CMP_MIN1"),t.message("BIZPROC_AUTOMATION_CMP_MIN2"),t.message("BIZPROC_AUTOMATION_CMP_MIN3")];else if(e==="h")i=[t.message("BIZPROC_AUTOMATION_CMP_HOUR1"),t.message("BIZPROC_AUTOMATION_CMP_HOUR2"),t.message("BIZPROC_AUTOMATION_CMP_HOUR3")];else if(e==="d")i=[t.message("BIZPROC_AUTOMATION_CMP_DAY1"),t.message("BIZPROC_AUTOMATION_CMP_DAY2"),t.message("BIZPROC_AUTOMATION_CMP_DAY3")];return i};var S=function(t,e){var i=t+" ";var a=0;if(t>20)t=t%10;if(t==1)a=0;else if(t>1&&t<5)a=1;else a=2;var o=y(e);return i+(o?o[a]:"")};var M={popupHint:null,timeout:null,bindToNode:function(e){t.bind(e,"mouseover",t.proxy((function(){this.showHint(t.proxy_context)}),this));t.bind(e,"mouseout",t.delegate(this.hideHint,this))},showHint:function(e){var i=e.getAttribute("data-text");if(!i)return;var a=t.util.htmlspecialchars(i);a=t.util.nl2br(a);if(!t.type.isNotEmptyString(a))return;this.popupHint=new t.PopupWindow("bizproc-automation-help-tip",e,{lightShadow:true,autoHide:false,darkMode:true,offsetLeft:0,offsetTop:2,bindOptions:{position:"top"},events:{onPopupClose:function(){this.destroy()}},content:t.create("div",{attrs:{style:"padding-right: 5px; width: 250px;"},html:a})});this.popupHint.setAngle({offset:32,position:"bottom"});this.popupHint.show();return true},showNoPermissionsHint:function(e){this.showAngleHint(e,t.message("BIZPROC_AUTOMATION_RIGHTS_ERROR"))},showAngleHint:function(e,i){if(this.timeout){clearTimeout(this.timeout)}this.popupHint=t.UI.Hint.createInstance({popupParameters:{width:334,height:104,closeByEsc:true,autoHide:true,angle:{offset:t.Dom.getPosition(e).width/2},bindOptions:{position:"top"}}});this.popupHint.close=function(){this.hide()};this.popupHint.show(e,i);this.timeout=setTimeout(this.hideHint.bind(this),5e3)},hideHint:function(){if(this.popupHint)this.popupHint.close();this.popupHint=null}};var P={documentName:null,documentType:null,documentFields:null,documentSigned:null,showRobotSettings:function(t,i,a,o){var s=new l;s.init(t,e.ViewMode.None);var n=new r;n.init({DOCUMENT_STATUS:a,DOCUMENT_SIGNED:this.documentSigned,DOCUMENT_FIELDS:this.documentFields},e.ViewMode.None);n.openRobotSettingsDialog(s,null,o)}};var R={showVariables:function(e){var i=this;t.Bizproc.Globals.Manager.Instance.showGlobals(t.Bizproc.Globals.Manager.Instance.mode.variable,e).then((function(t){i.onAfterSliderClose(t,"GLOBAL_VARIABLES")}))},showConstants:function(e){var i=this;t.Bizproc.Globals.Manager.Instance.showGlobals(t.Bizproc.Globals.Manager.Instance.mode.constant,e).then((function(t){i.onAfterSliderClose(t,"GLOBAL_CONSTANTS")}))},onAfterSliderClose:function(t,e){var i=t.getData();if(i.get("upsert")){var a=i.get("upsert");for(var o in a){this.component.data[e][o]=a[o]}}if(i.get("delete")){var s=i.get("delete");for(var n in s){delete this.component.data[e][s[n]]}}}};t.Bizproc.Automation.Component=e;t.Bizproc.Automation.Designer=I;t.Bizproc.Automation.API=P;t.Bizproc.Automation.ConditionGroup=A;t.Bizproc.Automation.ConditionGroupSelector=N;t.Bizproc.Automation.showGlobals=R})(window.BX||window.top.BX);
//# sourceMappingURL=script.map.js