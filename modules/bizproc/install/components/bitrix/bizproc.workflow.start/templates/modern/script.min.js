(function(){"use strict";BX.namespace("BX.Bizproc.WorkflowStartComponent");var e=function(e,t){this.node=e;this.config=t||{}};e.prototype={init:function(){this.replaceControls()},replaceControls:function(){var e=this.node.querySelectorAll(".bizproc-modern-type-control-wrapper-user");for(var t=0;t<e.length;++t){this.replaceUserControl(e[t])}var a=this.node.querySelectorAll(".bizproc-modern-type-control-wrapper-file");for(t=0;t<a.length;++t){this.replaceFileControl(a[t])}},replaceUserControl:function(e){var a={};var i=e.querySelector(".bizproc-modern-type-control");a.valueInputName=i.name;a.multiple=BX.hasClass(i,"bizproc-modern-type-control-multiple");a.required=BX.hasClass(i,"bizproc-modern-type-control-required");BX.cleanNode(e);new t(this,e,a)},replaceFileControl:function(e){var t=e.querySelector(".bizproc-modern-type-control");var a=BX.hasClass(t,"bizproc-modern-type-control-multiple");var i=a?t.name.replace("[n0]","[]"):t.name;BX.cleanNode(e);e.appendChild(this.createFileControlNode(i));if(a){var n=BX.create("span",{attrs:{className:"webform-small-button webform-small-button-accept bizproc-modern-type-control-file-clone-button"},text:BX.message("BP_WS_CONTROL_CLONE"),events:{click:this.cloneFileControl.bind(this,e,i)}});e.appendChild(n)}},createFileControlNode:function(e){var t=BX.create("input",{props:{type:"file",name:e}});var a=BX.create("span",{attrs:{className:"bizproc-modern-type-control-button"},children:[BX.create("span",{attrs:{className:"webform-small-button"},text:BX.message("BP_WS_FILE_CHOOSE")}),t]});var i=BX.create("span",{attrs:{className:"bizproc-modern-type-control-file-value-name"}});BX.bind(t,"change",function(){i.textContent=this.parseFileLabel(t.value)}.bind(this));return BX.create("div",{children:[a,i],attrs:{className:"bizproc-modern-type-control-file-replaced"}})},cloneFileControl:function(e,t){e.insertBefore(this.createFileControlNode(t),e.lastChild)},parseFileLabel:function(e){var t;if(e.lastIndexOf("\\")){t=e.lastIndexOf("\\")+1}else{t=e.lastIndexOf("/")+1}return e.slice(t)},getAjaxUrl:function(){return this.config.ajaxUrl||"/bitrix/components/bitrix/bizproc.workflow.start/ajax.php"}};var t=function(e,t,a){var i=this;this.container=t;this.itemsNode=BX.create("span");this.inputBoxNode=BX.create("span",{attrs:{className:"feed-add-destination-input-box"}});this.inputNode=BX.create("input",{props:{type:"text"},attrs:{className:"feed-add-destination-inp"}});this.inputBoxNode.appendChild(this.inputNode);this.tagNode=BX.create("a",{attrs:{className:"feed-add-destination-link"}});BX.addClass(t,"bizproc-modern-destination");t.appendChild(this.itemsNode);t.appendChild(this.inputBoxNode);t.appendChild(this.tagNode);this.component=e;this.data=null;this.dialogId=BX.util.getRandomString(7);this.createValueNode(a.valueInputName||"");this.selected=a.selected?BX.clone(a.selected):[];this.selectOne=!a.multiple;this.required=a.required||false;BX.bind(this.tagNode,"focus",function(e){i.openDialog({bByFocusEvent:true});return BX.PreventDefault(e)});BX.bind(this.container,"click",function(e){i.openDialog();return BX.PreventDefault(e)});this.addItems(this.selected);this.tagNode.innerHTML=this.selected.length<=0?BX.message("BP_WS_DESTINATION_CHOOSE"):BX.message("BP_WS_DESTINATION_EDIT")};t.prototype={getData:function(e){var t=this;if(t.ajaxProgress)return;t.ajaxProgress=true;BX.ajax({method:"POST",dataType:"json",url:t.component.getAjaxUrl(),data:{ajax_action:"get_destination_data",sessid:BX.bitrix_sessid(),site:BX.message("SITE_ID")},onsuccess:function(a){t.data=a.data||{};t.ajaxProgress=false;t.initDialog(e)}})},initDialog:function(e){var t,a=this,i=this.data;if(!i){a.getData(e);return}var n={};for(t=0;t<a.selected.length;++t){n[a.selected[t].id]=a.selected[t].entityType}var o={users:i.USERS||{},department:i.DEPARTMENT||{},departmentRelation:i.DEPARTMENT_RELATION||{}};var s={users:i.LAST.USERS||{}};if(!o["departmentRelation"]){o["departmentRelation"]=BX.SocNetLogDestination.buildDepartmentRelation(o["department"])}if(!a.inited){a.inited=true;var l=a.inputNode;l.id=a.dialogId+"input";var r=a.inputBoxNode;r.id=a.dialogId+"input-box";var d=this.tagNode;d.id=this.dialogId+"tag";var c=a.itemsNode;BX.SocNetLogDestination.init({name:a.dialogId,searchInput:l,extranetUser:false,bindMainPopup:{node:a.container,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:a.container,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:true,sendAjaxSearch:true,callback:{select:function(e,t,i,n){a.addItem(e,t);if(a.selectOne)BX.SocNetLogDestination.closeDialog()},unSelect:function(e){if(a.selectOne)return;a.unsetValue(e.entityId);BX.SocNetLogDestination.BXfpUnSelectCallback.call({formName:a.dialogId,inputContainerName:c,inputName:l.id,tagInputName:d.id,tagLink1:BX.message("BP_WS_DESTINATION_CHOOSE"),tagLink2:BX.message("BP_WS_DESTINATION_EDIT")},e)},openDialog:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:r.id,inputName:l.id,tagInputName:d.id}),closeDialog:BX.delegate(BX.SocNetLogDestination.BXfpCloseDialogCallback,{inputBoxName:r.id,inputName:l.id,tagInputName:d.id}),openSearch:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:r.id,inputName:l.id,tagInputName:d.id}),closeSearch:BX.delegate(BX.SocNetLogDestination.BXfpCloseSearchCallback,{inputBoxName:r.id,inputName:l.id,tagInputName:d.id})},items:o,itemsLast:s,itemsSelected:n,useClientDatabase:false,destSort:i.DEST_SORT||{},allowAddUser:false});BX.bind(l,"keyup",BX.delegate(BX.SocNetLogDestination.BXfpSearch,{formName:a.dialogId,inputName:l.id,tagInputName:d.id}));BX.bind(l,"keydown",BX.delegate(BX.SocNetLogDestination.BXfpSearchBefore,{formName:a.dialogId,inputName:l.id}));BX.SocNetLogDestination.BXfpSetLinkName({formName:a.dialogId,tagInputName:d.id,tagLink1:BX.message("BP_WS_DESTINATION_CHOOSE"),tagLink2:BX.message("BP_WS_DESTINATION_EDIT")})}e()},addItem:function(e,t){var a=this;var i=this.inputNode;var n=this.tagNode;var o=this.itemsNode;if(!BX.findChild(o,{attr:{"data-id":e.id}},false,false)){if(a.selectOne&&a.inited){var s=[];for(var l=0;l<o.childNodes.length;++l){s.push({itemId:o.childNodes[l].getAttribute("data-id"),itemType:o.childNodes[l].getAttribute("data-type")})}a.initDialog(function(){for(var e=0;e<s.length;++e){BX.SocNetLogDestination.deleteItem(s[e].itemId,s[e].itemType,a.dialogId)}});BX.cleanNode(o);a.cleanValue()}var r=this.createItemNode({text:e.name,deleteEvents:{click:function(i){if(a.selectOne&&a.required){a.openDialog()}else{a.initDialog(function(){BX.SocNetLogDestination.deleteItem(e.id,t,a.dialogId);BX.remove(r);a.unsetValue(e.entityId)})}BX.PreventDefault(i)}}});this.setValue(e.entityId);r.setAttribute("data-id",e.id);r.setAttribute("data-type",t);o.appendChild(r);if(!e.entityType)e.entityType=t}i.value="";n.innerHTML=BX.message("BP_WS_DESTINATION_EDIT")},addItems:function(e){for(var t=0;t<e.length;++t){this.addItem(e[t],e[t].entityType)}},openDialog:function(e){var t=this;this.initDialog(function(){BX.SocNetLogDestination.openDialog(t.dialogId,e)})},destroy:function(){if(this.inited){if(BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.closeDialog()}BX.SocNetLogDestination.closeSearch()}},createItemNode:function(e){return BX.create("span",{attrs:{className:"bizproc-modern-destination-item"},children:[BX.create("span",{attrs:{className:"bizproc-modern-destination-name"},html:e.text||""}),BX.create("span",{attrs:{className:"bizproc-modern-destination-delete"},events:e.deleteEvents})]})},createValueNode:function(e){this.valueNode=BX.create("input",{props:{type:"hidden",name:e}});this.container.appendChild(this.valueNode)},setValue:function(e){if(/^\d+$/.test(e))e="["+e+"]";if(this.selectOne)this.valueNode.value=e;else{var t,a=[],i=this.valueNode.value.split(";");for(t=0;t<i.length;++t){if(!i[t]||e==i[t])continue;a.push(i[t])}a.push(e);this.valueNode.value=a.join(";")}},unsetValue:function(e){if(/^\d+$/.test(e))e="["+e+"]";if(this.selectOne)this.valueNode.value="";else{var t,a=[],i=this.valueNode.value.split(";");for(t=0;t<i.length;++t){if(!i[t]||e==i[t])continue;a.push(i[t])}this.valueNode.value=a.join(";")}},cleanValue:function(){this.valueNode.value=""}};BX.Bizproc.WorkflowStartComponent=e})();
//# sourceMappingURL=script.map.js