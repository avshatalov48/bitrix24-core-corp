{"version":3,"file":"script.js","sources":["src/index.js"],"sourcesContent":["import {Reflection, Type, Text, Loc, ajax} from 'main.core';\nimport {TagSelector} from \"ui.entity-selector\";\nimport {Designer} from 'bizproc.automation';\n\nconst namespace = Reflection.namespace('BX.Bizproc.Activity');\n\nclass StartWorkflowActivity\n{\n\t#templateNode: HTMLElement;\n\t#templateInput: HTMLInputElement;\n\t#templateId: number = null;\n\t#parametersNode: HTMLElement;\n\t#documentType: [];\n\t#formName: string;\n\t#propertiesDialog: {};\n\t#isRobot: boolean = false;\n\tconstructor(options: {\n\t\ttemplateNode: HTMLElement,\n\t\ttemplateInput: HTMLInputElement,\n\t\ttemplateId: number,\n\t\tparametersNode: HTMLElement,\n\t\tdocumentType: [],\n\t\tformName: string,\n\t\tisRobot: boolean,\n\t\tpropertiesDialog?: {},\n\t})\n\t{\n\t\tif (!Type.isElementNode(options.templateNode))\n\t\t{\n\t\t\tthrow 'templateNode must be HTML Element';\n\t\t}\n\t\tthis.#templateNode = options.templateNode;\n\n\t\tif (!Type.isElementNode(options.templateInput))\n\t\t{\n\t\t\tthrow 'templateInput must be HTML Input Element';\n\t\t}\n\t\tthis.#templateInput = options.templateInput;\n\n\t\tif (!Type.isElementNode(options.parametersNode))\n\t\t{\n\t\t\tthrow 'parametersNode must be HTML Element';\n\t\t}\n\t\tthis.#parametersNode = options.parametersNode;\n\n\t\tconst templateId = Text.toInteger(options.templateId);\n\t\tif (templateId > 0)\n\t\t{\n\t\t\tthis.#templateId = templateId;\n\t\t}\n\n\t\tthis.#documentType = Type.isArrayFilled(options.documentType) ? options.documentType : [];\n\t\tthis.#formName = Type.isStringFilled(options.formName) ? options.formName : '';\n\t\tthis.#propertiesDialog = Type.isPlainObject(options.propertiesDialog) ? options.propertiesDialog : {};\n\t\tthis.#isRobot = Type.isBoolean(options.isRobot) ? options.isRobot: false;\n\t}\n\n\tinit()\n\t{\n\t\tthis.#initTemplateSelector();\n\t}\n\n\t#initTemplateSelector()\n\t{\n\t\tconst preselectedItems = [];\n\t\tif (this.#templateId)\n\t\t{\n\t\t\tpreselectedItems.push(['bizproc-template', this.#templateId]);\n\t\t}\n\n\t\tconst selector = new TagSelector({\n\t\t\tdialogOptions: {\n\t\t\t\tentities: [\n\t\t\t\t\t{\n\t\t\t\t\t\tid: 'bizproc-template',\n\t\t\t\t\t}\n\t\t\t\t],\n\t\t\t\tmultiple: false,\n\t\t\t\tdropdownMode: true,\n\t\t\t\tenableSearch: true,\n\t\t\t\thideOnSelect: true,\n\t\t\t\thideOnDeselect: false,\n\t\t\t\tclearSearchOnSelect: true,\n\t\t\t\tshowAvatars: false,\n\t\t\t\tcompactView: true,\n\t\t\t\theight: 300,\n\t\t\t\tpreselectedItems: preselectedItems,\n\t\t\t\tevents: {\n\t\t\t\t\t'Item:onSelect': (event) => {\n\t\t\t\t\t\tconst { item: selectedItem } = event.getData();\n\t\t\t\t\t\tthis.#getTemplateParameters(selectedItem.getId());\n\n\t\t\t\t\t\tthis.#templateInput.value = selectedItem.getId();\n\t\t\t\t\t},\n\t\t\t\t\t'Item:onDeselect': (event) => {\n\t\t\t\t\t\tthis.#getTemplateParameters(-1);\n\t\t\t\t\t\tthis.#templateInput.value = '';\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\tmultiple: false,\n\t\t});\n\n\t\tselector.renderTo(this.#templateNode);\n\t}\n\n\t#getTemplateParameters(templateId: number)\n\t{\n\t\tthis.#parametersNode.innerHTML = '';\n\n\t\ttemplateId = Text.toInteger(templateId);\n\n\t\tif (templateId <= 0)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst requestData = {\n\t\t\tsite_id: Loc.getMessage('SITE_ID'),\n\t\t\tsessid: BX.bitrix_sessid(),\n\t\t\tdocument_type: this.#documentType,\n\t\t\tactivity: 'StartWorkflowActivity',\n\t\t\ttemplate_id: templateId,\n\t\t\tform_name: this.#formName,\n\t\t\tcontent_type: 'html',\n\t\t};\n\n\t\tif (this.#isRobot === true)\n\t\t{\n\t\t\trequestData['properties_dialog'] = this.#propertiesDialog;\n\t\t\trequestData['isRobot'] = 'y';\n\t\t}\n\n\t\tajax.post(\n\t\t\t'/bitrix/tools/bizproc_activity_ajax.php',\n\t\t\trequestData,\n\t\t\t(response) => {\n\t\t\t\tif (response)\n\t\t\t\t{\n\t\t\t\t\tthis.#parametersNode.innerHTML = response;\n\t\t\t\t}\n\n\t\t\t\tif (this.#isRobot && Reflection.getClass('BX.Bizproc.Automation.Designer'))\n\t\t\t\t{\n\t\t\t\t\tconst dlg = Designer.getInstance().getRobotSettingsDialog();\n\t\t\t\t\tif (dlg && dlg.template)\n\t\t\t\t\t{\n\t\t\t\t\t\tdlg.template.initRobotSettingsControls(dlg.robot, this.#parametersNode);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\t}\n}\n\nnamespace.StartWorkflowActivity = StartWorkflowActivity;"],"names":["namespace","Reflection","StartWorkflowActivity","options","Type","isElementNode","templateNode","templateInput","parametersNode","templateId","Text","toInteger","isArrayFilled","documentType","isStringFilled","formName","isPlainObject","propertiesDialog","isBoolean","isRobot","preselectedItems","push","selector","TagSelector","dialogOptions","entities","id","multiple","dropdownMode","enableSearch","hideOnSelect","hideOnDeselect","clearSearchOnSelect","showAvatars","compactView","height","events","event","getData","selectedItem","item","getId","value","renderTo","innerHTML","requestData","site_id","Loc","getMessage","sessid","BX","bitrix_sessid","document_type","activity","template_id","form_name","content_type","ajax","post","response","getClass","dlg","Designer","getInstance","getRobotSettingsDialog","template","initRobotSettingsControls","robot"],"mappings":"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"}