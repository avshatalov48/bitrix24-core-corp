(function(e,t,a,i){"use strict";var n,r,s,l,o,p,u,d,c,h,m,v,b,g,f,T,O,B,N,y,I,C,A,_,X,k,x;var w=t.Reflection.namespace("BX.Bizproc.Activity");var S=function(){function e(a){babelHelpers.classCallCheck(this,e);if(t.Type.isPlainObject(a)){this.isRobot=a.isRobot;this.signedDocumentType=a.signedDocumentType;this.variables=a.variables;this.constants=a.constants;this.documentFields=a.documentFields;this.operations=a.operations;this.currentValues=a.currentValues;this.visibilityMessages=a.visibilityMessages;this.addRowTable=a.addRowTable}}babelHelpers.createClass(e,[{key:"init",value:function e(){this.initObjectNames();this.initNodeAttributeNames();this.initNodeIdNames();this.initAvailableOptions();this.availableTypes=["int","integer","double"];this.rowIndex=-1;var t=this.isRobot?"addConditionRobot":"addConditionDesigner";if(Object.keys(this.currentValues).length<=0){this[t]("variable",["parameter","+","parameter"])}for(var a in this.currentValues){this[t](a,this.currentValues[a])}}},{key:"initObjectNames",value:function e(){this.gVarObjectName="GlobalVar";this.gConstObjectName="GlobalConst";this.documentObjectName="Document";this.operationObjectName="Operation";this.helperObjectName="Default"}},{key:"isGVariable",value:function e(t){return t.startsWith(this.gVarObjectName)}},{key:"isGConstant",value:function e(t){return t.startsWith(this.gConstObjectName)}},{key:"isDocument",value:function e(t){return t.startsWith(this.documentObjectName)}},{key:"initNodeAttributeNames",value:function e(){this.indexAttributeName="bp_moa_index"}},{key:"initNodeIdNames",value:function e(){this.variableIdName="bp_moa_variable_";this.parameter1IdName="bp_moa_common1_";this.operationIdName="bp_moa_operation_";this.parameter2IdName="bp_moa_common2_";this.resultIdName="bp_moa_results_";this.operationMenuIdName="bp_moa_operations_menu_"}},{key:"initAvailableOptions",value:function e(){this.options=this.getAvailableOptions();this.optionsByGroup=this.getAvailableOptionsByGroup()}},{key:"getAvailableOptions",value:function e(){var t=new Map;this.fillOptions(this.variables,t);this.fillOptions(this.constants,t);this.fillOptions(this.documentFields,t);var a=this.operations;for(var i in a){t.set(a[i],{title:a[i],groupId:this.operationObjectName,value:a[i]})}t.set("variable",{title:BX.message("BPMOA_CHOOSE_VARIABLE"),groupId:this.helperObjectName,value:""});t.set("parameter",{title:BX.message("BPMOA_CHOOSE_PARAMETER"),groupId:this.helperObjectName,value:""});t.set("operation",{title:"+",groupId:this.helperObjectName,value:"+"});return t}},{key:"fillOptions",value:function e(t,a){var i,n;for(var r in t){n=t[r];if(n["children"]){n=n["children"]}for(var s in n){i=n[s]["id"];a.set(i,this.createShortOptionProperty(i,n[s]))}}}},{key:"createShortOptionProperty",value:function e(t,a){return{title:a["customData"]["title"],groupId:a["customData"]["groupId"],value:t}}},{key:"getAvailableOptionsByGroup",value:function e(){var t=new Map;var a;this.fillOptionsByGroupWithGlobals(this.variables,t,this.gVarObjectName);this.fillOptionsByGroupWithGlobals(this.constants,t,this.gConstObjectName);a=[];for(var i in this.documentFields){a.push(this.documentFields[i])}t.set(this.documentObjectName+":"+this.documentObjectName,a);t.set(this.operationObjectName,this.getOperationGroupOptions());return t}},{key:"fillOptionsByGroupWithGlobals",value:function e(t,a,i){var n;for(var r in t){n=i+":"+r;a.set(n,t[r])}}},{key:"getOperationGroupOptions",value:function e(){var t=[];var a=this.operations;var i=this;for(var n in a){t.push({text:a[n],onclick:function e(t,a){var n=this.bindElement;if(n){n.innerText=a.text;i.resolveHiddenInput(n,a.text,document.getElementById(i.resultIdName+n.getAttribute(i.indexAttributeName)));this.popupWindow.close()}}})}return t}},{key:"addConditionRobot",value:function e(t,a){var i=this.getPropertiesInfo(t,a);var u=this;var d=this.addRowTable;this.rowIndex++;var c=BX.Tag.render(n||(n=babelHelpers.taggedTemplateLiteral(['<div class="bizproc-automation-popup-settings"></div>'])));var h=BX.Tag.render(r||(r=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="bizproc-automation-popup-settings bizproc-automation-popup-settings-text"></div>\n\t\t'])));var m=BX.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(['<div id="','"></div>'])),this.resultIdName+this.rowIndex);var v=BX.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<span class="bizproc-automation-popup-settings-link" id="','"></span>\n\t\t'])),this.variableIdName+this.rowIndex);v.setAttribute(this.indexAttributeName,this.rowIndex);this.replaceTitleSelector(v,i["variable"].title,m);BX.bind(v,"click",function(e){u.onFieldSelectClick(e,"variable",u)});h.appendChild(v);h.appendChild(BX.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(["<span> = </span>"]))));var b=this.getParameterSpan(this.parameter1IdName+this.rowIndex,i["parameter1"].title,m);h.appendChild(b);var g=BX.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<span \n\t\t\t\tclass="bizproc-automation-popup-settings-link bizproc-automation-condition-joiner" \n\t\t\t\tid="','"\n\t\t\t></span>\n\t\t'])),this.operationIdName+this.rowIndex);g.setAttribute(this.indexAttributeName,this.rowIndex);this.replaceTitleSelector(g,i["operation"].title,m);BX.bind(g,"click",function(e){u.onOperationSelectClick(e,u)});h.appendChild(g);var f=this.getParameterSpan(this.parameter2IdName+this.rowIndex,i["parameter2"].title,m);h.appendChild(f);c.appendChild(h);c.appendChild(m);d.appendChild(c)}},{key:"getPropertiesInfo",value:function e(t,a){var i={variable:{value:t,defaultValue:"variable"},parameter1:{value:a[0],defaultValue:"parameter"},operation:{value:a[1],defaultValue:"+"},parameter2:{value:a[2],defaultValue:"parameter"}};var n={};for(var r in i){n[r]=this.getPropertyInfo(i[r].value,i[r].defaultValue)}return n}},{key:"getPropertyInfo",value:function e(t,a){if(this.options.get(t)===undefined){t=Number(t);if(isNaN(t)){return{title:a}}}return{title:t}}},{key:"getParameterSpan",value:function e(t,a,i){var n=BX.Tag.render(u||(u=babelHelpers.taggedTemplateLiteral(['<span class="bizproc-automation-popup-settings-link" id="','"></span>'])),t);n.setAttribute(this.indexAttributeName,this.rowIndex);this.replaceTitleSelector(n,a,i);var r=this;BX.bind(n,"click",function(e){r.onFieldSelectClick(e,"all",r)});return n}},{key:"onFieldSelectClick",value:function e(t,a,i){var n=t.target;var r=n.id;var s=document.getElementById(r+"_input").value;var l=i.createFormForMenu(a,s);var o=new BX.PopupWindow(r+"_popup",n,{className:"bizproc-automation-popup-set",autoHide:true,closeByEsc:true,offsetTop:5,overlay:{backgroundColor:"transparent"},content:l,buttons:[new BX.PopupWindowButton({text:BX.message("BIZPROC_AUTOMATION_CMP_CHOOSE"),className:"webform-button webform-button-create",events:{click:function e(){var t=l.getElementsByTagName("input")[0];var a=document.getElementById(i.resultIdName+n.getAttribute(i.indexAttributeName));i.replaceTitleSelector(n,t.value,a);o.close()}}}),new BX.PopupWindowButtonLink({text:BX.message("BIZPROC_AUTOMATION_CMP_CANCEL"),className:"popup-window-button-link",events:{click:function e(){o.close()}}})],events:{onPopupClose:function e(){this.destroy()}}});o.show()}},{key:"onOperationSelectClick",value:function e(t,a){var i;var n=t.target;BX.Main.MenuManager.show(a.operationMenuIdName+Math.random(),n,(i=a.optionsByGroup.get(a.operationObjectName))!==null&&i!==void 0?i:[],{autoHide:true,className:"bizproc-automation-inline-selector-menu",overlay:{backgroundColor:"transparent"},minHeight:50,minWidth:40,events:{onPopupClose:function e(){this.destroy()}}})}},{key:"replaceTitleSelector",value:function e(t,a,i){var n=this.options.get(a);var r;if(t&&n!==undefined){t.innerText=n["title"];r=n["value"]}else if(t&&!isNaN(Number(a))){r=Number(a);if(String(t.id).startsWith(this.variableIdName)&&r===0){return}t.innerText=r}else{return}if(i){this.resolveHiddenInput(t,r,i)}}},{key:"resolveHiddenInput",value:function e(t,a,i){var n=document.getElementById(t.id+"_input");if(n){n.name=t.id;n.value=a;return}var r=t.id;var s=r+"_input";i.appendChild(BX.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['<input type="hidden" id="','" name="','" value="','">'])),s,r,a))}},{key:"createFormForMenu",value:function e(i,n){var r=this;var s=t.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['<form class="bizproc-automation-popup-select-block"></form>'])));var l=t.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['<div class="bizproc-automation-popup-settings"></div>'])));var o=t.Tag.render(m||(m=babelHelpers.taggedTemplateLiteral(['<div class="bizproc-automation-robot-settings-title"></div>'])));o.innerText=BX.message("BPMOA_LIST_OF_VALUES");var p=t.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['<input class="bizproc-automation-popup-input" type="hidden" style="width: 280px;">'])));var u=t.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(['<div class="bizproc-automation-popup-settings-dropdown" readonly="readonly"></div>'])));BX.bind(u,"click",function(){var e;var t=(e=r.optionsByGroup.get(B.value))!==null&&e!==void 0?e:[];var i=r.getVisibilityInfoForDialog(B.value);var n=r.getDialogOptions(t,i);n["targetNode"]=this;n["events"]={"Item:onBeforeSelect":function e(t){var a=t.data.item;u.innerText=a.customData.get("title");p.value=a.id},onHide:function e(t){t.target.destroy()},"Search:onItemCreateAsync":function e(t){return new Promise(function(e){var a=t.getData().searchQuery.query;var n=t.getTarget();r.onCreateGlobalsClick(n,i,a,r,e)})}};var s=new a.Dialog(n);if(t.length<=0){s.setFooter(r.getFooter(i,s))}s.show()});var d=t.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(['<div class="bizproc-automation-popup-settings"></div>'])));var B=t.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['<select class="bizproc-automation-popup-settings-dropdown"></select>'])));BX.bind(B,"change",function(){r.changeSelectForField(this.value,u,o,p)});var N=this.getVisibilityNamesForSelect(i);for(var y in N){var I=t.Tag.render(T||(T=babelHelpers.taggedTemplateLiteral(['<option value="','"></option>'])),BX.util.htmlspecialchars(y));I.innerText=N[y];B.appendChild(I)}var C=this.options.get(n);B.value=C?C["groupId"]:this.helperObjectName+":number";if(B.selectedIndex===-1){B.selectedIndex=0}this.changeSelectForField(B.value,u,o,p);if(C&&C["groupId"]!==this.helperObjectName){u.innerText=C["title"];p.value=n}else{u.innerText=BX.message("BPMOA_EMPTY");p.value=n}d.appendChild(t.Tag.render(O||(O=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="bizproc-automation-robot-settings-title">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"])),BX.util.htmlspecialchars(BX.message("BPMOA_TYPE_OF_PARAMETER"))));d.appendChild(B);l.appendChild(o);l.appendChild(u);l.append(p);s.appendChild(d);s.appendChild(l);return s}},{key:"getVisibilityInfoForDialog",value:function e(t){var a={};var n={};var r={};var s="";var l="";if(this.isGVariable(t)){a={title:BX.message("BPMOA_GVARIABLE_NO_EXIST"),subtitle:BX.message("BPMOA_CREATE_GVARIABLE_QUESTION"),arrow:true};n={title:BX.message("BPMOA_GVARIABLE_NOT_FOUND"),subtitle:BX.message("BPMOA_CREATE_GVARIABLE_QUESTION"),arrow:true};r={label:BX.message("BPMOA_CREATE_GVARIABLE")};s=i.Globals.Manager.Instance.mode.variable;l=this.gVarObjectName}else if(this.isGConstant(t)){a={title:BX.message("BPMOA_GCONSTANT_NO_EXIST"),subtitle:BX.message("BPMOA_CREATE_GCONSTANT_QUESTION"),arrow:true};n={title:BX.message("BPMOA_GCONSTANT_NOT_FOUND"),subtitle:BX.message("BPMOA_CREATE_GCONSTANT_QUESTION"),arrow:true};r={label:BX.message("BPMOA_CREATE_GCONSTANT")};s=i.Globals.Manager.Instance.mode.constant;l=this.gConstObjectName}else if(this.isDocument(t)){l=this.documentObjectName}return{recentStubOptions:a,searchStubOptions:n,searchFooterOptions:r,mode:s,objectName:l,visibility:t}}},{key:"getDialogOptions",value:function e(t,a){var i={width:480,height:300,multiple:false,dropdownMode:true,enableSearch:true,showAvatars:false,compactView:true,items:t,tagSelectorOptions:{textBoxWidth:400}};var n={recentTabOptions:{stub:true,icon:"",stubOptions:a.recentStubOptions},searchTabOptions:{stub:true,stubOptions:a.searchStubOptions},searchOptions:{allowCreateItem:true,footerOptions:a.searchFooterOptions}};if(a.objectName===this.gVarObjectName||a.objectName===this.gConstObjectName){return Object.assign(i,n)}return i}},{key:"getFooter",value:function e(a,i){var n=this;var r=t.Tag.render(B||(B=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<span class="ui-selector-footer-link ui-selector-footer-link-add" style="border: none">\n\t\t\t\t',"\n\t\t\t</span>\n\t\t"])),BX.util.htmlspecialchars(a.searchFooterOptions.label));BX.bind(r,"click",function(){n.onCreateGlobalsClick(i,a,"",n)});return r}},{key:"onCreateGlobalsClick",value:function e(t,a,n,r,s){var l=a.visibility;var o={visibility:l.slice(l.indexOf(":")+1),availableTypes:r.availableTypes};i.Globals.Manager.Instance.createGlobals(a.mode,r.signedDocumentType,n,o).then(function(e){var i={objectName:a.objectName,visibility:a.visibility};r.onAfterCreateGlobals(t,e,i);if(s){s()}})}},{key:"onAfterCreateGlobals",value:function e(t,a,i){var n;var r=a.getData().entries();var s=Object.keys(r);if(s.length<=0){return}var l=s[0];var o=r[s[0]];if(!this.availableTypes.includes(o["Type"])){return}var p={entityId:"bp",tabs:"recents",title:o["Name"],id:"{="+i.objectName+":"+l+"}",customData:{groupId:i.objectName+":"+o["Visibility"],property:o,title:o["Name"]}};if(p.customData.groupId===i.visibility){t.setFooter(null);t.addItem(p)}this.options.set(p.id,this.createShortOptionProperty(p.id,p));var u=(n=this.optionsByGroup.get(p.customData.groupId))!==null&&n!==void 0?n:[];u.push(p);this.optionsByGroup.set(p.customData.groupId,u)}},{key:"changeSelectForField",value:function e(t,a,i,n){if(t!==this.helperObjectName+":number"){a.style.display="";i.innerText=BX.message("BPMOA_LIST_OF_VALUES");a.innerText=BX.message("BPMOA_EMPTY");n.type="hidden";n.value="";return}i.innerText=BX.message("BPMOA_INPUT_NUMBER");a.style.display="none";n.type="text";n.value="0"}},{key:"getVisibilityNamesForSelect",value:function e(t){var a={};var i={};i[this.helperObjectName]={number:BX.message("BPMOA_NUMBER")};var n=Object.assign({},this.visibilityMessages,i);for(var r in n){if(t==="variable"&&r!==this.gVarObjectName){continue}for(var s in n[r]){a[r+":"+s]=n[r][s]}}return a}},{key:"addConditionDesigner",value:function e(t,a){var i=this.addRowTable;this.rowIndex++;var n;var r,s;if(!a){a=[NaN,null,NaN]}n=i.insertRow(-1);r=n.insertCell(-1);r.style.minWidth="50px";s=BX.Tag.render(N||(N=babelHelpers.taggedTemplateLiteral(['<select name="','" style="width: 100%;"></select>'])),this.variableIdName+this.rowIndex);this.appendChildToSelectDesigner(s,"variable");s.value=t;if(s.selectedIndex===-1){s.selectedIndex=0}r.appendChild(s);r=n.insertCell(-1);r.innerText="=";this.appendParameterSelectDesigner(n,this.parameter1IdName+this.rowIndex,a[0]);r=n.insertCell(-1);r.style.minWidth="45px";s=BX.Tag.render(y||(y=babelHelpers.taggedTemplateLiteral(['<select name="','" style="width: 100%"></select>'])),this.operationIdName+this.rowIndex);for(var l in this.operations){s.appendChild(BX.Tag.render(I||(I=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<option value="','">\n\t\t\t\t\t',"\n\t\t\t\t</option>\n\t\t\t"])),BX.util.htmlspecialchars(this.operations[l]),BX.util.htmlspecialchars(this.operations[l])))}s.value=a[1];if(s.selectedIndex===-1){s.selectedIndex=0}r.appendChild(s);this.appendParameterSelectDesigner(n,this.parameter2IdName+this.rowIndex,a[2])}},{key:"appendChildToSelectDesigner",value:function e(t,a){for(var i in this.visibilityMessages){if(a==="variable"&&i!==this.gVarObjectName){continue}var n=this.visibilityMessages[i];for(var r in n){var s=n[r];var l=BX.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(['<optgroup label="','"></optgroup>'])),BX.util.htmlspecialchars(s));var o=this.optionsByGroup.get(i+":"+r);if(!o){continue}var p=void 0,u=void 0,d=void 0;for(var c in o){var h=o[c];if(h["children"]){for(var m in h["children"]){u=h["children"][m].id;d=h["children"][m].customData.title;p=BX.Tag.render(A||(A=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t\t<option value="','">\n\t\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t\t"])),BX.util.htmlspecialchars(u),BX.util.htmlspecialchars(d));l.appendChild(p)}}else{u=h["id"];d=h["customData"]["title"];p=BX.Tag.render(_||(_=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t<option value="','">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t"])),BX.util.htmlspecialchars(u),BX.util.htmlspecialchars(d));l.appendChild(p)}}t.appendChild(l)}}}},{key:"changeInputDesigner",value:function e(t,a){if(t.options[t.selectedIndex].value===""){t.after(BX.Tag.render(X||(X=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input \n\t\t\t\t\ttype="text"\n\t\t\t\t\tname="','"\n\t\t\t\t\tstyle="width: 100px; height: 27px;" \n\t\t\t\t\tvalue="','"\n\t\t\t\t>\n\t\t\t'])),t.name,isFinite(a)?a:0))}else{var i=document.getElementsByName(t.name)[1];if(i){i.remove()}}}},{key:"appendParameterSelectDesigner",value:function e(t,a,i){var n=this;var r=t.insertCell(-1);var s=BX.Tag.render(k||(k=babelHelpers.taggedTemplateLiteral(['<select name="','" style="width: 100%"></select>'])),BX.util.htmlspecialchars(a));BX.bind(s,"change",function(){n.changeInputDesigner(this,i)});s.appendChild(BX.Tag.render(x||(x=babelHelpers.taggedTemplateLiteral(['<option value="">',"</option>"])),BX.util.htmlspecialchars(BX.message("BPMOA_NUMBER"))));this.appendChildToSelectDesigner(s);s.value=i;if(s.selectedIndex===-1){s.selectedIndex=0}r.appendChild(s);this.changeInputDesigner(s,i)}}]);return e}();w.MathOperationActivity=S})(this.window=this.window||{},BX,BX.UI.EntitySelector,BX.Bizproc);
//# sourceMappingURL=script.map.js