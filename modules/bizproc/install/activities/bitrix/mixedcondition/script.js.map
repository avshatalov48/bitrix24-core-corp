{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { Reflection, Type, Tag, Event, Dom, Loc, Text } from 'main.core';\nimport { BpMixedSelector } from 'bizproc.mixed-selector';\nimport { BpCondition, Operator } from \"bizproc.condition\";\n\nimport 'bp_selector';\n\nconst namespace = Reflection.namespace('BX.Bizproc.Activity');\n\nclass MixedCondition\n{\n\tconditions: Array;\n\ttable: HTMLTableElement;\n\tobjectTabs;\n\ttemplate: Array;\n\t#documentType: any;\n\n\tindex: number = 0;\n\tselector: BpMixedSelector;\n\taddConditionNode: HTMLElement;\n\n\tconstructor(options) {\n\t\tif (Type.isPlainObject(options))\n\t\t{\n\t\t\tthis.conditions = options.conditions;\n\t\t\tthis.table = options.table;\n\t\t\tthis.objectTabs = options.objectTabs;\n\t\t\tthis.template = options.template;\n\t\t\tthis.#documentType = options.documentType;\n\t\t}\n\t}\n\n\tinit()\n\t{\n\t\tthis.addConditionNode = this.#createAddConditionNode();\n\t\tDom.append(this.addConditionNode, this.table);\n\n\t\tfor (const i in this.conditions)\n\t\t{\n\t\t\tthis.addCondition(this.conditions[i]);\n\t\t}\n\t}\n\n\t#createAddConditionNode(): HTMLElement\n\t{\n\t\tconst me = this;\n\n\t\tconst addButton = Tag.render`<a href=\"#\">${Loc.getMessage('BPMC_PD_ADD')}</a>`;\n\t\tEvent.bind(addButton, 'click', (event) => {\n\t\t\tevent.preventDefault();\n\t\t\tme.addCondition();\n\t\t});\n\n\t\treturn Tag.render`\n\t\t\t<tbody>\n\t\t\t\t<tr>\n\t\t\t\t\t<td class=\"adm-detail-content-cell-l\"></td>\n\t\t\t\t\t<td class=\"adm-detail-content-cell-r\">\n\t\t\t\t\t\t${addButton}\n\t\t\t\t\t</td>\n\t\t\t\t</tr>\n\t\t\t</tbody>\n\t\t`;\n\t}\n\n\taddCondition(condition = {\n\t\tobject: null,\n\t\tfield: null,\n\t\tvalue: null,\n\t\tjoiner: '0',\n\t\toperator: Operator.NOT_EMPTY\n\t})\n\t{\n\t\tcondition.object = condition.object === 'Template' ? 'Parameter' : condition.object;\n\n\t\tconst bpCondition: BpCondition = new BpCondition({\n\t\t\toperator: condition.operator,\n\t\t\tvalue: condition.value,\n\t\t\tselectName: 'mixed_condition[' + Text.toInteger(this.index) + '][operator]',\n\t\t\tinputName: 'mixed_condition_value_' + Text.toInteger(this.index),\n\t\t\tuseOperatorModified: false,\n\t\t\tdocumentType: this.#documentType,\n\t\t});\n\t\tconst property = this.getProperty(condition.object, condition.field) ?? {Type: 'string'};\n\n\t\tconst joiner = this.index > 0 ? this.#createJoiner(condition.joiner) : '';\n\t\tconst tbody = Tag.render`\n\t\t\t<tbody \n\t\t\t\tdata-index=\"${Text.toInteger(this.index)}\"\n\t\t\t\tdata-object=\"${Text.encode(condition.object ?? '')}\"\n\t\t\t\tdata-field=\"${Text.encode(condition.field ?? '')}\"\n\t\t\t>\n\t\t\t\t${joiner}\n\t\t\t\t${this.#createSource(condition.object, condition.field)}\n\t\t\t\t${bpCondition.renderOperator(property.Type)}\n\t\t\t\t${bpCondition.renderValue(property)}\n\t\t\t</tbody>\n\t\t`;\n\n\t\tif (this.selector)\n\t\t{\n\t\t\tthis.selector.subscribe('onSelect', function (event) {\n\t\t\t\tconst object = event.data.item.object;\n\t\t\t\tconst field = event.data.item.field;\n\t\t\t\tconst property = this.getProperty(object, field) ?? {Type: 'string'};\n\n\t\t\t\ttbody.setAttribute('data-object', object);\n\t\t\t\ttbody.setAttribute('data-field', field);\n\t\t\t\tbpCondition.rerenderOperator(property.Type);\n\t\t\t\tbpCondition.rerenderValue(property);\n\t\t\t}.bind(this));\n\t\t}\n\n\t\tDom.insertBefore(tbody, this.addConditionNode);\n\t\tthis.index++;\n\t}\n\n\t#createJoiner(joiner): HTMLElement\n\t{\n\t\tconst deleteNode = Tag.render`<a href=\"#\">${Loc.getMessage('BPMC_PD_DELETE')}</a>`;\n\t\tEvent.bind(deleteNode, 'click', this.#deleteCondition.bind(this));\n\n\t\treturn Tag.render`\n\t\t\t<tr>\n\t\t\t\t<td align=\"right\" width=\"40%\" class=\"adm-detail-content-cell-l\">\n\t\t\t\t\t<select name=\"mixed_condition[${Text.toInteger(this.index)}][joiner]\">\n\t\t\t\t\t\t<option value=\"0\">${Loc.getMessage('BPMC_PD_AND')}</option>\n\t\t\t\t\t\t<option value=\"1\"${Text.toInteger(joiner) === 1 ? ' selected' : ''}>\n\t\t\t\t\t\t\t${Loc.getMessage('BPMC_PD_OR')}\n\t\t\t\t\t\t</option>\n\t\t\t\t\t</select>\n\t\t\t\t</td>\n\t\t\t\t<td align=\"right\" width=\"60%\" class=\"adm-detail-content-cell-r\">\n\t\t\t\t\t${deleteNode}\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t`;\n\t}\n\n\t#createSource(object, field): HTMLElement\n\t{\n\t\tconst source = Tag.render`<td width=\"60%\" class=\"adm-detail-content-cell-r\"></td>`;\n\n\t\tthis.selector = new BpMixedSelector({\n\t\t\ttargetNode: source,\n\t\t\ttemplate: this.template,\n\t\t\tobjectTabs: this.objectTabs,\n\t\t\tinputNames: {\n\t\t\t\tobject: 'mixed_condition[' + String(Text.toInteger(this.index)) + '][object]',\n\t\t\t\tfield: 'mixed_condition[' + String(Text.toInteger(this.index)) + '][field]',\n\t\t\t}\n\t\t});\n\t\tthis.selector.renderMixedSelector();\n\t\tif (object && field && this.objectTabs[object] && this.objectTabs[object][field])\n\t\t{\n\t\t\tthis.selector.setSelectedObjectAndField(object, field, this.objectTabs[object][field]['Name']);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tconst sourceName = this.#findActivityTitle(object, field);\n\t\t\tif (sourceName)\n\t\t\t{\n\t\t\t\tthis.selector.setSelectedObjectAndField(object, field, sourceName);\n\t\t\t}\n\t\t}\n\n\t\treturn Tag.render`\n\t\t\t<tr>\n\t\t\t\t<td align=\"right\" width=\"40%\" class=\"adm-detail-content-cell-l\">\n\t\t\t\t\t${Loc.getMessage('BPMC_PD_FIELD') + ':'}\n\t\t\t\t</td>\n\t\t\t\t${source}\n\t\t\t</tr>\n\t\t`;\n\t}\n\n\t#findActivityTitle(object, field): string | null\n\t{\n\t\tconst activityTabItems = this.selector.getMenuItemsByTabName('Activity');\n\n\t\tfor (const i in activityTabItems)\n\t\t{\n\t\t\tconst activityInfo = activityTabItems[i];\n\t\t\tif (activityInfo.object === object)\n\t\t\t{\n\t\t\t\tconst activityItems = activityInfo.items;\n\t\t\t\tfor (const j in activityItems)\n\t\t\t\t{\n\t\t\t\t\tconst itemInfo = activityItems[j];\n\t\t\t\t\tif (itemInfo.field === field)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn itemInfo.text;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t#deleteCondition(event)\n\t{\n\t\tconst target = event.target.closest('tbody');\n\t\tif (target)\n\t\t{\n\t\t\tDom.remove(target);\n\t\t}\n\t\tevent.preventDefault();\n\t}\n\n\tgetProperty(object, field): Object | null\n\t{\n\t\tif (object && this.objectTabs[object])\n\t\t{\n\t\t\treturn this.objectTabs[object][field];\n\t\t}\n\n\t\tconst results = BX.Bizproc.Selector.getActivitiesItems();\n\t\tfor (let i = 0; i < results.length; ++i)\n\t\t{\n\t\t\tif (results[i].propertyObject === object && results[i].propertyField === field)\n\t\t\t{\n\t\t\t\treturn results[i].property;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n}\n\nnamespace.MixedCondition = MixedCondition;"],"names":["namespace","Reflection","MixedCondition","options","Type","isPlainObject","conditions","table","objectTabs","template","documentType","addConditionNode","Dom","append","i","addCondition","condition","object","field","value","joiner","operator","Operator","NOT_EMPTY","bpCondition","BpCondition","selectName","Text","toInteger","index","inputName","useOperatorModified","property","getProperty","tbody","Tag","render","encode","renderOperator","renderValue","selector","subscribe","event","data","item","setAttribute","rerenderOperator","rerenderValue","bind","insertBefore","results","BX","Bizproc","Selector","getActivitiesItems","length","propertyObject","propertyField","me","addButton","Loc","getMessage","Event","preventDefault","deleteNode","source","BpMixedSelector","targetNode","inputNames","String","renderMixedSelector","setSelectedObjectAndField","sourceName","activityTabItems","getMenuItemsByTabName","activityInfo","activityItems","items","j","itemInfo","text","target","closest","remove"],"mappings":"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"}