this.BX=this.BX||{};(function(e,t,a,i,s,r){"use strict";function l(e,t,a){n(e,t);t.set(e,a)}function n(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var o=new WeakMap;var c=new WeakMap;var p=new WeakMap;var u=function(){function e(t){babelHelpers.classCallCheck(this,e);l(this,o,{writable:true,value:void 0});l(this,c,{writable:true,value:void 0});l(this,p,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,o,t.DocumentType);babelHelpers.classPrivateFieldSet(this,c,!r.Type.isNil(t.Category.Id)?t.Category:null);babelHelpers.classPrivateFieldSet(this,p,t.Status)}babelHelpers.createClass(e,[{key:"getId",value:function e(){if(this.hasCategory()){return"".concat(babelHelpers.classPrivateFieldGet(this,o).Type,"_").concat(babelHelpers.classPrivateFieldGet(this,c).Id,"_").concat(babelHelpers.classPrivateFieldGet(this,p).Id)}return"".concat(babelHelpers.classPrivateFieldGet(this,o).Type,"_").concat(babelHelpers.classPrivateFieldGet(this,p).Id)}},{key:"getDocumentType",value:function e(){return babelHelpers.classPrivateFieldGet(this,o)}},{key:"getDocumentCategory",value:function e(){return babelHelpers.classPrivateFieldGet(this,c)}},{key:"getDocumentStatus",value:function e(){return babelHelpers.classPrivateFieldGet(this,p)}},{key:"hasCategory",value:function e(){return!r.Type.isNull(babelHelpers.classPrivateFieldGet(this,c))}}]);return e}();function b(e,t){var a=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=d(e))||t&&e&&typeof e.length==="number"){if(a)e=a;var i=0;var s=function e(){};return{s:s,n:function t(){if(i>=e.length)return{done:true};return{done:false,value:e[i++]}},e:function e(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,l=false,n;return{s:function t(){a=a.call(e)},n:function e(){var t=a.next();r=t.done;return t},e:function e(t){l=true;n=t},f:function e(){try{if(!r&&a["return"]!=null)a["return"]()}finally{if(l)throw n}}}}function d(e,t){if(!e)return;if(typeof e==="string")return v(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);if(a==="Object"&&e.constructor)a=e.constructor.name;if(a==="Map"||a==="Set")return Array.from(e);if(a==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return v(e,t)}function v(e,t){if(t==null||t>e.length)t=e.length;for(var a=0,i=new Array(t);a<t;a++){i[a]=e[a]}return i}function h(e,t){g(e,t);t.add(e)}function f(e,t,a){g(e,t);t.set(e,a)}function g(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function m(e,t,a){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return a}var T=new WeakMap;var P=new WeakSet;var y=function(){function e(t){var a=this;babelHelpers.classCallCheck(this,e);h(this,P);f(this,T,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,T,[]);if(r.Type.isArray(t)){t.forEach((function(e){var t=new u(e);babelHelpers.classPrivateFieldGet(a,T).push(t)}))}}babelHelpers.createClass(e,[{key:"getDocumentTypes",value:function e(){var t=new Map;var a=b(babelHelpers.classPrivateFieldGet(this,T)),i;try{for(a.s();!(i=a.n()).done;){var s=i.value;t.set(s.getDocumentType().Type,s.getDocumentType())}}catch(e){a.e(e)}finally{a.f()}return Array.from(t.values())}},{key:"getTypeCategories",value:function e(t){var a=new Map;var i=b(babelHelpers.classPrivateFieldGet(this,T)),s;try{for(i.s();!(s=i.n()).done;){var r=s.value;if(r.hasCategory()&&r.getDocumentType().Type===t.Type){var l=r.getDocumentCategory();a.set(l.Id,l)}}}catch(e){i.e(e)}finally{i.f()}return Array.from(a.values())}},{key:"getTypeStatuses",value:function e(t,a){var i=new Set;if(r.Type.isNil(a)){a={Id:null}}var s=function e(s){var r=s.getDocumentType().Type===t.Type&&(s.hasCategory()?s.getDocumentCategory().Id===a.Id:true)&&!i.has(s.getDocumentStatus().Id);if(r){i.add(s.getDocumentStatus().Id)}return r};return Array.from(m(this,P,C).call(this,s)).map((function(e){return e.getDocumentStatus()}))}}]);return e}();function C(e){var t=regeneratorRuntime.mark((function t(a){var i,s,r;return regeneratorRuntime.wrap((function t(l){while(1){switch(l.prev=l.next){case 0:i=b(a);l.prev=1;i.s();case 3:if((s=i.n()).done){l.next=10;break}r=s.value;if(!e(r)){l.next=8;break}l.next=8;return r;case 8:l.next=3;break;case 10:l.next=15;break;case 12:l.prev=12;l.t0=l["catch"](1);i.e(l.t0);case 15:l.prev=15;i.f();return l.finish(15);case 18:case"end":return l.stop()}}}),t,null,[[1,12,15,18]])}));return t(babelHelpers.classPrivateFieldGet(this,T))}function O(e,t,a){I(e,t);t.set(e,a)}function I(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function H(e,t,a){A(e,t);E(a,"get");return _(e,a)}function E(e,t){if(e===undefined){throw new TypeError("attempted to "+t+" private static field before its declaration")}}function A(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function _(e,t){if(t.get){return t.get.call(e)}return t.value}var F=new WeakMap;var N=new WeakMap;var S=function(){function e(t){babelHelpers.classCallCheck(this,e);O(this,F,{writable:true,value:void 0});O(this,N,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,F,t);babelHelpers.classPrivateFieldSet(this,N,{})}babelHelpers.createClass(e,[{key:"isNone",value:function t(){return babelHelpers.classPrivateFieldGet(this,F)===H(e,e,k)}},{key:"isView",value:function t(){return babelHelpers.classPrivateFieldGet(this,F)===H(e,e,G)}},{key:"isEdit",value:function t(){return babelHelpers.classPrivateFieldGet(this,F)===H(e,e,M)}},{key:"isManage",value:function t(){return babelHelpers.classPrivateFieldGet(this,F)===H(e,e,D)}},{key:"setProperty",value:function e(t,a){babelHelpers.classPrivateFieldGet(this,N)[t]=a;return this}},{key:"getProperty",value:function e(t){var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(babelHelpers.classPrivateFieldGet(this,N).hasOwnProperty(t)){return babelHelpers.classPrivateFieldGet(this,N)[t]}return a}},{key:"intoRaw",value:function e(){return babelHelpers.classPrivateFieldGet(this,F)}}],[{key:"none",value:function t(){return new e(H(e,e,k))}},{key:"view",value:function t(){return new e(H(e,e,G))}},{key:"edit",value:function t(){return new e(H(e,e,M))}},{key:"manage",value:function t(){return new e(H(e,e,D))}},{key:"fromRaw",value:function t(a){if(e.getAll().includes(a)){return new e(a)}return e.none()}},{key:"getAll",value:function t(){return[H(this,e,k),H(this,e,G),H(this,e,M),H(this,e,D)]}}]);return e}();var k={writable:true,value:0};var G={writable:true,value:1};var M={writable:true,value:2};var D={writable:true,value:3};function w(e,t,a){R(e,t);t.set(e,a)}function R(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var B=new WeakMap;var L=new WeakMap;var x=new WeakMap;var z=new WeakMap;var U=new WeakMap;var Y=new WeakMap;var W=new WeakMap;var j=new WeakMap;var Z=new WeakMap;var X=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));w(babelHelpers.assertThisInitialized(e),B,{writable:true,value:void 0});w(babelHelpers.assertThisInitialized(e),L,{writable:true,value:void 0});w(babelHelpers.assertThisInitialized(e),x,{writable:true,value:void 0});w(babelHelpers.assertThisInitialized(e),z,{writable:true,value:void 0});w(babelHelpers.assertThisInitialized(e),U,{writable:true,value:void 0});w(babelHelpers.assertThisInitialized(e),Y,{writable:true,value:void 0});w(babelHelpers.assertThisInitialized(e),W,{writable:true,value:void 0});w(babelHelpers.assertThisInitialized(e),j,{writable:true,value:void 0});w(babelHelpers.assertThisInitialized(e),Z,{writable:true,value:void 0});e.setEventNamespace("BX.Bizproc.Automation");e.draft=false;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(e),B,{});babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(e),L,false);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(e),x,S.none());babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(e),z,new i.ConditionGroup);return e}babelHelpers.createClass(t,[{key:"init",value:function e(t,a){babelHelpers.classPrivateFieldSet(this,B,r.clone(t));if(!r.Type.isPlainObject(babelHelpers.classPrivateFieldGet(this,B)["APPLY_RULES"])){babelHelpers.classPrivateFieldGet(this,B)["APPLY_RULES"]={}}if(babelHelpers.classPrivateFieldGet(this,B)["APPLY_RULES"].Condition){babelHelpers.classPrivateFieldSet(this,z,new i.ConditionGroup(babelHelpers.classPrivateFieldGet(this,B)["APPLY_RULES"].Condition))}else{babelHelpers.classPrivateFieldSet(this,z,new i.ConditionGroup)}babelHelpers.classPrivateFieldSet(this,x,r.Type.isNil(a)?S.edit():a);babelHelpers.classPrivateFieldSet(this,U,this.createNode())}},{key:"reInit",value:function e(t,a){var i=babelHelpers.classPrivateFieldGet(this,U);babelHelpers.classPrivateFieldSet(this,U,this.createNode());if(i.parentNode){i.parentNode.replaceChild(babelHelpers.classPrivateFieldGet(this,U),i)}}},{key:"canEdit",value:function e(){return i.getGlobalContext().canEdit}},{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,B)["ID"]||0}},{key:"getStatusId",value:function e(){return babelHelpers.classPrivateFieldGet(this,B)["DOCUMENT_STATUS"]||""}},{key:"getCode",value:function e(){var t;return(t=babelHelpers.classPrivateFieldGet(this,B)["CODE"])!==null&&t!==void 0?t:""}},{key:"getName",value:function e(){var t=babelHelpers.classPrivateFieldGet(this,B)["NAME"];if(!t){var a;var s=this.getCode();var r=i.getGlobalContext().availableTriggers.find((function(e){return s===e["CODE"]}));t=(a=r===null||r===void 0?void 0:r.NAME)!==null&&a!==void 0?a:s}return t}},{key:"setName",value:function e(t){if(r.Type.isString(t)){babelHelpers.classPrivateFieldGet(this,B)["NAME"]=t}return this}},{key:"getApplyRules",value:function e(){return babelHelpers.classPrivateFieldGet(this,B)["APPLY_RULES"]}},{key:"setApplyRules",value:function e(t){babelHelpers.classPrivateFieldGet(this,B)["APPLY_RULES"]=t;return this}},{key:"getLogStatus",value:function e(){var t=i.getGlobalContext().tracker.getTriggerLog(this.getId());return t?t.status:null}},{key:"getCondition",value:function e(){return babelHelpers.classPrivateFieldGet(this,z)}},{key:"setCondition",value:function e(t){babelHelpers.classPrivateFieldSet(this,z,t);return this}},{key:"isBackwardsAllowed",value:function e(){return babelHelpers.classPrivateFieldGet(this,B)["APPLY_RULES"]["ALLOW_BACKWARDS"]==="Y"}},{key:"setAllowBackwards",value:function e(t){babelHelpers.classPrivateFieldGet(this,B)["APPLY_RULES"]["ALLOW_BACKWARDS"]=t?"Y":"N";return this}},{key:"getExecuteBy",value:function e(){return babelHelpers.classPrivateFieldGet(this,B)["APPLY_RULES"]["ExecuteBy"]||""}},{key:"setExecuteBy",value:function e(t){babelHelpers.classPrivateFieldGet(this,B)["APPLY_RULES"]["ExecuteBy"]=t;return this}},{key:"createNode",value:function e(){var t="bizproc-automation-trigger-item-wrapper";if(babelHelpers.classPrivateFieldGet(this,x).isEdit()&&this.canEdit()){t+=" bizproc-automation-trigger-item-wrapper-draggable"}var a=null;var s=null;if(babelHelpers.classPrivateFieldGet(this,x).isEdit()){a=r.Dom.create("div",{attrs:{className:"bizproc-automation-trigger-item-wrapper-edit"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_EDIT")});s=r.Dom.create("div",{attrs:{className:"bizproc-automation-trigger-btn-copy"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_COPY")||"copy"});r.Event.bind(s,"click",this.onCopyButtonClick.bind(this,s))}if(this.getLogStatus()===i.TrackingStatus.COMPLETED){t+=" bizproc-automation-trigger-item-wrapper-complete"}else if(i.getGlobalContext().document.getPreviousStatusIdList().includes(this.getStatusId())){t+=" bizproc-automation-trigger-item-wrapper-complete-light"}var l=this.getName();var n="bizproc-automation-trigger-item";if(this.getLogStatus()===i.TrackingStatus.COMPLETED){n+=" --complete"}var o=r.Dom.create("DIV",{attrs:{"data-role":"trigger-container",className:n,"data-type":"item-trigger"},children:[r.Dom.create("div",{attrs:{className:t},children:[r.Dom.create("div",{attrs:{className:"bizproc-automation-trigger-item-wrapper-text"},text:l})]}),s,a]});if(!babelHelpers.classPrivateFieldGet(this,x).isEdit()){return o}if(this.canEdit()){this.registerItem(o)}var c=r.Dom.create("SPAN",{attrs:{"data-role":"btn-delete-trigger",className:"bizproc-automation-trigger-btn-delete"}});r.Event.bind(c,"click",this.onDeleteButtonClick.bind(this,c));o.appendChild(c);if(babelHelpers.classPrivateFieldGet(this,x).isEdit()){r.Event.bind(o,"click",this.onSettingsButtonClick.bind(this,o))}return o}},{key:"onSettingsButtonClick",value:function e(t){if(!this.canEdit()){i.HelpHint.showNoPermissionsHint(t)}else if(!babelHelpers.classPrivateFieldGet(this,x).isManage()){this.emit("Trigger:onSettingsOpen",{trigger:this})}}},{key:"onCopyButtonClick",value:function e(a,s){s.stopPropagation();if(!this.canEdit()){i.HelpHint.showNoPermissionsHint(a)}else if(!babelHelpers.classPrivateFieldGet(this,x).isManage()){var r=new t;var l=this.serialize();delete l["ID"];if(l["CODE"]==="WEBHOOK"){l["APPLY_RULES"]={}}r.init(l,babelHelpers.classPrivateFieldGet(this,x));this.emit("Trigger:copied",{trigger:r})}}},{key:"onSearch",value:function e(t){if(!babelHelpers.classPrivateFieldGet(this,U)){return}var a=t.getData().queryString;var i=!a||this.getName().toLowerCase().indexOf(a)>=0;r.Dom[i?"removeClass":"addClass"](babelHelpers.classPrivateFieldGet(this,U),"--search-mismatch")}},{key:"registerItem",value:function e(t){if(r.Type.isNil(t["__bxddid"])){t.onbxdragstart=BX.proxy(this.dragStart,this);t.onbxdrag=BX.proxy(this.dragMove,this);t.onbxdragstop=BX.proxy(this.dragStop,this);t.onbxdraghover=BX.proxy(this.dragOver,this);jsDD.registerObject(t);jsDD.registerDest(t,1)}}},{key:"unregisterItem",value:function e(t){t.onbxdragstart=undefined;t.onbxdrag=undefined;t.onbxdragstop=undefined;t.onbxdraghover=undefined;jsDD.unregisterObject(t);jsDD.unregisterDest(t)}},{key:"dragStart",value:function e(){babelHelpers.classPrivateFieldSet(this,Y,BX.proxy_context);if(!babelHelpers.classPrivateFieldGet(this,Y)){jsDD.stopCurrentDrag();return}if(!babelHelpers.classPrivateFieldGet(this,Z)){var t=babelHelpers.classPrivateFieldGet(this,Y).offsetWidth;babelHelpers.classPrivateFieldSet(this,Z,babelHelpers.classPrivateFieldGet(this,Y).cloneNode(true));babelHelpers.classPrivateFieldGet(this,Z).style.position="absolute";babelHelpers.classPrivateFieldGet(this,Z).classList.add("bizproc-automation-trigger-item-drag");babelHelpers.classPrivateFieldGet(this,Z).style.width=t+"px";document.body.appendChild(babelHelpers.classPrivateFieldGet(this,Z))}}},{key:"dragMove",value:function e(t,a){babelHelpers.classPrivateFieldGet(this,Z).style.left=t+"px";babelHelpers.classPrivateFieldGet(this,Z).style.top=a+"px"}},{key:"dragOver",value:function e(t,a,i){if(babelHelpers.classPrivateFieldGet(this,W)){babelHelpers.classPrivateFieldGet(this,W).classList.remove("bizproc-automation-trigger-item-pre")}if(babelHelpers.classPrivateFieldGet(this,j)){babelHelpers.classPrivateFieldGet(this,j).classList.remove("bizproc-automation-trigger-list-pre")}var s=t.getAttribute("data-type");if(s==="item-trigger"){babelHelpers.classPrivateFieldSet(this,W,t);babelHelpers.classPrivateFieldSet(this,j,null)}if(s==="column-trigger"){babelHelpers.classPrivateFieldSet(this,j,t.querySelector('[data-role="trigger-list"]'));babelHelpers.classPrivateFieldSet(this,W,null)}if(babelHelpers.classPrivateFieldGet(this,W)){babelHelpers.classPrivateFieldGet(this,W).classList.add("bizproc-automation-trigger-item-pre")}if(babelHelpers.classPrivateFieldGet(this,j)){babelHelpers.classPrivateFieldGet(this,j).classList.add("bizproc-automation-trigger-list-pre")}}},{key:"dragStop",value:function e(a,i,s){s=s||window.event;var r=null;var l=s&&(s.ctrlKey||s.metaKey);var n=function e(a,i){var s=new t;var r=a.serialize();delete r["ID"];if(r["CODE"]==="WEBHOOK"){r["APPLY_RULES"]={}}r["DOCUMENT_STATUS"]=i;s.init(r,babelHelpers.classPrivateFieldGet(a,x));return s};if(babelHelpers.classPrivateFieldGet(this,Y)){if(babelHelpers.classPrivateFieldGet(this,W)){babelHelpers.classPrivateFieldGet(this,W).classList.remove("bizproc-automation-trigger-item-pre");var o=babelHelpers.classPrivateFieldGet(this,W).parentNode;if(!l){o.insertBefore(babelHelpers.classPrivateFieldGet(this,Y),babelHelpers.classPrivateFieldGet(this,W));this.moveTo(o.getAttribute("data-status-id"))}else{r=n(this,o.getAttribute("data-status-id"));o.insertBefore(babelHelpers.classPrivateFieldGet(r,U),babelHelpers.classPrivateFieldGet(this,W))}}else if(babelHelpers.classPrivateFieldGet(this,j)){babelHelpers.classPrivateFieldGet(this,j).classList.remove("bizproc-automation-trigger-list-pre");if(!l){babelHelpers.classPrivateFieldGet(this,j).appendChild(babelHelpers.classPrivateFieldGet(this,Y));this.moveTo(babelHelpers.classPrivateFieldGet(this,j).getAttribute("data-status-id"))}else{r=n(this,babelHelpers.classPrivateFieldGet(this,j).getAttribute("data-status-id"));babelHelpers.classPrivateFieldGet(this,j).appendChild(babelHelpers.classPrivateFieldGet(r,U))}}if(r){this.emit("Trigger:copied",{trigger:r,skipInsert:true})}}babelHelpers.classPrivateFieldGet(this,Z).parentNode.removeChild(babelHelpers.classPrivateFieldGet(this,Z));babelHelpers.classPrivateFieldSet(this,Z,null);babelHelpers.classPrivateFieldSet(this,Y,null);babelHelpers.classPrivateFieldSet(this,W,null)}},{key:"onDeleteButtonClick",value:function e(t,a){a.stopPropagation();if(!this.canEdit()){i.HelpHint.showNoPermissionsHint(t)}else if(!babelHelpers.classPrivateFieldGet(this,x).isManage()){r.Dom.remove(t.parentNode);this.emit("Trigger:deleted",{trigger:this})}}},{key:"updateData",value:function e(t){if(r.Type.isPlainObject(t)){babelHelpers.classPrivateFieldSet(this,B,t)}else{throw"Invalid data"}}},{key:"markDeleted",value:function e(){babelHelpers.classPrivateFieldSet(this,L,true);return this}},{key:"serialize",value:function e(){var t=r.clone(babelHelpers.classPrivateFieldGet(this,B));if(babelHelpers.classPrivateFieldGet(this,L)){t["DELETED"]="Y"}if(!r.Type.isPlainObject(t.APPLY_RULES)){t.APPLY_RULES={}}if(!babelHelpers.classPrivateFieldGet(this,z).items.length){delete t.APPLY_RULES.Condition}else{t.APPLY_RULES.Condition=babelHelpers.classPrivateFieldGet(this,z).serialize()}return t}},{key:"moveTo",value:function e(t){babelHelpers.classPrivateFieldGet(this,B)["DOCUMENT_STATUS"]=t;this.emit("Trigger:modified",{trigger:this})}},{key:"getReturnProperties",value:function e(){var t=this;var a=i.getGlobalContext().availableTriggers.find((function(e){return e["CODE"]===t.getCode()}));return a&&r.Type.isArray(a.RETURN)?a.RETURN:[]}},{key:"node",get:function e(){return babelHelpers.classPrivateFieldGet(this,U)}},{key:"deleted",get:function e(){return babelHelpers.classPrivateFieldGet(this,L)}},{key:"documentStatus",get:function e(){var t;return(t=babelHelpers.classPrivateFieldGet(this,B)["DOCUMENT_STATUS"])!==null&&t!==void 0?t:""}}]);return t}(a.EventEmitter);var V=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"bindAll",value:function t(a){a.querySelectorAll("[data-text]").forEach((function(t){return e.bindToNode(t)}))}},{key:"bindToNode",value:function e(t){r.Event.bind(t,"mouseover",this.showHint.bind(this,t));r.Event.bind(t,"mouseout",this.hideHint.bind(this))}},{key:"isBindedToNode",value:function e(t){var a,i;return!!((a=this.popupHint)!==null&&a!==void 0&&(i=a.bindElement)!==null&&i!==void 0&&i.isSameNode(t))}},{key:"showHint",value:function e(t){var a=t.getAttribute("data-text");if(!a){return}var i=r.Text.encode(a);i=BX.util.nl2br(i);if(!r.Type.isStringFilled(i)){return}this.hideHint();this.popupHint=new BX.PopupWindow("bizproc-automation-help-tip",t,{lightShadow:true,autoHide:false,darkMode:true,offsetLeft:0,offsetTop:2,bindOptions:{position:"top"},events:{onPopupClose:function e(){this.destroy()}},content:r.Dom.create("div",{attrs:{style:"padding-right: 5px; width: 250px;"},html:i})});this.popupHint.setAngle({offset:32,position:"bottom"});this.popupHint.show();return true}},{key:"showNoPermissionsHint",value:function e(t){this.showAngleHint(t,r.Loc.getMessage("BIZPROC_AUTOMATION_RIGHTS_ERROR"))}},{key:"showAngleHint",value:function e(t,a){if(this.timeout){clearTimeout(this.timeout)}this.popupHint=BX.UI.Hint.createInstance({popupParameters:{width:334,height:104,closeByEsc:true,autoHide:true,angle:{offset:r.Dom.getPosition(t).width/2},bindOptions:{position:"top"}}});this.popupHint.close=function(){this.hide()};this.popupHint.show(t,a);this.timeout=setTimeout(this.hideHint.bind(this),5e3)}},{key:"hideHint",value:function e(){if(this.popupHint){this.popupHint.close()}this.popupHint=null}}]);return e}();function K(e,t){var a=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=q(e))||t&&e&&typeof e.length==="number"){if(a)e=a;var i=0;var s=function e(){};return{s:s,n:function t(){if(i>=e.length)return{done:true};return{done:false,value:e[i++]}},e:function e(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,l=false,n;return{s:function t(){a=a.call(e)},n:function e(){var t=a.next();r=t.done;return t},e:function e(t){l=true;n=t},f:function e(){try{if(!r&&a["return"]!=null)a["return"]()}finally{if(l)throw n}}}}function q(e,t){if(!e)return;if(typeof e==="string")return J(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);if(a==="Object"&&e.constructor)a=e.constructor.name;if(a==="Map"||a==="Set")return Array.from(e);if(a==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return J(e,t)}function J(e,t){if(t==null||t>e.length)t=e.length;for(var a=0,i=new Array(t);a<t;a++){i[a]=e[a]}return i}function $(e,t,a,i){ae(e,t);te(a,"set");Q(e,a,i);return i}function Q(e,t,a){if(t.set){t.set.call(e,a)}else{if(!t.writable){throw new TypeError("attempted to set read only private field")}t.value=a}}function ee(e,t,a){ae(e,t);te(a,"get");return ie(e,a)}function te(e,t){if(e===undefined){throw new TypeError("attempted to "+t+" private static field before its declaration")}}function ae(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function ie(e,t){if(t.get){return t.get.call(e)}return t.value}var se=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"generateUniqueId",value:function t(){$(e,e,re,+ee(e,e,re)+1);return"bizproc-automation-cmp-"+ee(e,e,re)}},{key:"toJsonString",value:function e(t){return JSON.stringify(t,(function(e,t){if(typeof t=="boolean"){return t?"1":"0"}return t}))}},{key:"getResponsibleUserExpression",value:function e(t){if(r.Type.isArray(t)){var a=K(t),i;try{for(a.s();!(i=a.n()).done;){var s=i.value;if(s["Id"]==="ASSIGNED_BY_ID"||s["Id"]==="RESPONSIBLE_ID"){return"{{"+s["Name"]+"}}"}}}catch(e){a.e(e)}finally{a.f()}}return null}}]);return e}();var re={writable:true,value:0};function le(e,t,a,i){pe(e,t);ce(a,"set");ne(e,a,i);return i}function ne(e,t,a){if(t.set){t.set.call(e,a)}else{if(!t.writable){throw new TypeError("attempted to set read only private field")}t.value=a}}function oe(e,t,a){pe(e,t);ce(a,"get");return ue(e,a)}function ce(e,t){if(e===undefined){throw new TypeError("attempted to "+t+" private static field before its declaration")}}function pe(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function ue(e,t){if(t.get){return t.get.call(e)}return t.value}var be=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"setRobotSettingsDialog",value:function e(t){this.robotSettingsDialog=t;this.robot=t?t.robot:null}},{key:"getRobotSettingsDialog",value:function e(){return this.robotSettingsDialog}},{key:"setTriggerSettingsDialog",value:function e(t){this.triggerSettingsDialog=t}},{key:"getTriggerSettingsDialog",value:function e(){return this.triggerSettingsDialog}}],[{key:"getInstance",value:function t(){if(!oe(e,e,de)){le(e,e,de,new e)}return oe(e,e,de)}}]);return e}();var de={writable:true,value:void 0};function ve(e,t,a){he(e,t);t.set(e,a)}function he(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var fe=new WeakMap;var ge=new WeakMap;var me=new WeakMap;var Te=new WeakMap;var Pe=new WeakMap;var ye=new WeakMap;var Ce=new WeakMap;var Oe=new WeakMap;var Ie=function(e){babelHelpers.inherits(a,e);function a(e){var t;babelHelpers.classCallCheck(this,a);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(a).call(this));ve(babelHelpers.assertThisInitialized(t),fe,{writable:true,value:void 0});ve(babelHelpers.assertThisInitialized(t),ge,{writable:true,value:void 0});ve(babelHelpers.assertThisInitialized(t),me,{writable:true,value:void 0});ve(babelHelpers.assertThisInitialized(t),Te,{writable:true,value:void 0});ve(babelHelpers.assertThisInitialized(t),Pe,{writable:true,value:void 0});ve(babelHelpers.assertThisInitialized(t),ye,{writable:true,value:void 0});ve(babelHelpers.assertThisInitialized(t),Ce,{writable:true,value:void 0});ve(babelHelpers.assertThisInitialized(t),Oe,{writable:true,value:void 0});t.setEventNamespace("BX.Bizproc.Automation");babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),fe,e);return t}babelHelpers.createClass(a,[{key:"init",value:function e(t,a){if(!r.Type.isPlainObject(t)){t={}}babelHelpers.classPrivateFieldSet(this,ge,a.isNone()?S.edit():a);babelHelpers.classPrivateFieldSet(this,Te,r.Type.isArray(t.TRIGGERS)?t.TRIGGERS:[]);babelHelpers.classPrivateFieldSet(this,Pe,document.querySelectorAll('[data-type="column-trigger"]'));babelHelpers.classPrivateFieldSet(this,ye,babelHelpers.classPrivateFieldGet(this,fe).querySelectorAll('[data-role="trigger-list"]'));babelHelpers.classPrivateFieldSet(this,Ce,babelHelpers.classPrivateFieldGet(this,fe).querySelectorAll('[data-role="trigger-buttons"]'));babelHelpers.classPrivateFieldSet(this,Oe,false);this.initButtons();this.initTriggers();this.markModified(false);babelHelpers.classPrivateFieldGet(this,Pe).forEach((function(e){return jsDD.registerDest(e,10)}));top.BX.addCustomEvent(top,"Rest:AppLayout:ApplicationInstall",this.onRestAppInstall.bind(this))}},{key:"reInit",value:function e(t,a){if(!r.Type.isPlainObject(t)){t={}}babelHelpers.classPrivateFieldSet(this,ge,a||S.none());babelHelpers.classPrivateFieldGet(this,ye).forEach((function(e){return r.Dom.clean(e)}));babelHelpers.classPrivateFieldGet(this,Ce).forEach((function(e){return r.Dom.clean(e)}));babelHelpers.classPrivateFieldSet(this,Te,r.Type.isArray(t.TRIGGERS)?t.TRIGGERS:[]);this.initTriggers();this.initButtons();this.markModified(false)}},{key:"initTriggers",value:function e(){var t=this;babelHelpers.classPrivateFieldSet(this,me,[]);babelHelpers.classPrivateFieldGet(this,Te).forEach((function(e){var a=new X;a.init(e,babelHelpers.classPrivateFieldGet(t,ge));t.subscribeTriggerEvents(a);t.insertTriggerNode(a.getStatusId(),a.node);babelHelpers.classPrivateFieldGet(t,me).push(a)}))}},{key:"subscribeTriggerEvents",value:function e(t){var a=this;t.subscribe("Trigger:copied",(function(e){var t=e.data.trigger;babelHelpers.classPrivateFieldGet(a,me).push(t);if(!e.data.skipInsert){a.insertTriggerNode(t.getStatusId(),t.node)}a.subscribeTriggerEvents(t);a.markModified()}));t.subscribe("Trigger:modified",(function(){return a.markModified()}));t.subscribe("Trigger:onSettingsOpen",(function(e){a.openTriggerSettingsDialog(e.data.trigger)}));t.subscribe("Trigger:deleted",(function(e){return a.deleteTrigger(e.data.trigger)}))}},{key:"onSearch",value:function e(t){babelHelpers.classPrivateFieldGet(this,me).forEach((function(e){return e.onSearch(t)}))}},{key:"initButtons",value:function e(){var t=this;if(babelHelpers.classPrivateFieldGet(this,ge).isEdit()){babelHelpers.classPrivateFieldGet(this,Ce).forEach((function(e){return t.createAddButton(e)}))}}},{key:"enableManageMode",value:function e(){babelHelpers.classPrivateFieldSet(this,ge,S.manage());var t=document.querySelectorAll('[data-role="btn-delete-trigger"]');t.forEach((function(e){return r.Dom.hide(e)}));babelHelpers.classPrivateFieldGet(this,me).forEach((function(e){return r.Dom.addClass(e.node,"--locked-node")}))}},{key:"disableManageMode",value:function e(){babelHelpers.classPrivateFieldSet(this,ge,S.edit());var t=document.querySelectorAll('[data-role="btn-delete-trigger"]');t.forEach((function(e){return r.Dom.show(e)}));babelHelpers.classPrivateFieldGet(this,me).forEach((function(e){return r.Dom.removeClass(e.node,"--locked-node")}))}},{key:"createAddButton",value:function e(t){var a=this;var i=r.Dom.create("span",{events:{click:function e(t){if(!a.canEdit()){V.showNoPermissionsHint(this)}else if(!babelHelpers.classPrivateFieldGet(a,ge).isManage()){a.onAddButtonClick(this)}}},attrs:{className:"bizproc-automation-btn-add","data-status-id":t.getAttribute("data-status-id")},children:[r.Dom.create("span",{attrs:{className:"bizproc-automation-btn-add-text"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_ADD")})]});t.appendChild(i)}},{key:"onAddButtonClick",value:function e(a,s){var l=this;var n=this;var o=function e(t,a){n.addTrigger(a.triggerData,(function(e){this.openTriggerSettingsDialog(e,s)}));this.popupWindow.close()};var c=[];i.getGlobalContext().availableTriggers.forEach((function(e){if(e.CODE==="APP"){c.push(l.createAppTriggerMenuItem(a.getAttribute("data-status-id"),e))}else{c.push({text:e.NAME,triggerData:{DOCUMENT_STATUS:a.getAttribute("data-status-id")||s.statusId,CODE:e.CODE},onclick:o})}}));t.MenuManager.show(se.generateUniqueId(),a,c,{autoHide:true,offsetLeft:r.Dom.getPosition(a)["width"]/2,angle:{position:"top",offset:0},events:{onPopupClose:function e(){this.destroy()}}})}},{key:"onChangeTriggerClick",value:function e(t,a){this.onAddButtonClick(a.target,{changeTrigger:true,statusId:t})}},{key:"createAppTriggerMenuItem",value:function e(t,a){var s=this;var l=function e(t,a){s.addTrigger(a.triggerData,(function(e){this.openTriggerSettingsDialog(e)}));this.getRootMenuWindow().close()};var n=[];for(var o=0;o<a["APP_LIST"].length;++o){var c=a["APP_LIST"][o];var p="["+c["APP_NAME"]+"] "+c["NAME"];n.push({text:r.Text.encode(p),triggerData:{DOCUMENT_STATUS:t,NAME:p,CODE:a.CODE,APPLY_RULES:{APP_ID:c["APP_ID"],CODE:c["CODE"]}},onclick:l})}if(r.Reflection.getClass("BX.rest.Marketplace")){if(n.length){n.push({delimiter:true})}n.push({text:r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CATEGORY_OTHER_MARKETPLACE_2"),onclick:function e(){BX.rest.Marketplace.open({PLACEMENT:i.getGlobalContext().get("marketplaceRobotCategory")});this.getRootMenuWindow().close()}})}return{text:a.NAME,items:n}}},{key:"addTrigger",value:function e(t,a){var i=new X;i.init(t,babelHelpers.classPrivateFieldGet(this,ge));this.subscribeTriggerEvents(i);i.draft=true;if(a){a.call(this,i)}}},{key:"deleteTrigger",value:function e(t,a){if(t.getId()>0){t.markDeleted()}else{for(var i=0;i<babelHelpers.classPrivateFieldGet(this,me).length;++i){if(babelHelpers.classPrivateFieldGet(this,me)[i]===t){babelHelpers.classPrivateFieldGet(this,me).splice(i,1)}}}if(a){a(t)}this.markModified()}},{key:"enableDragAndDrop",value:function e(){babelHelpers.classPrivateFieldGet(this,me).forEach((function(e){return e.registerItem(e.node)}));babelHelpers.classPrivateFieldGet(this,fe).querySelectorAll(".bizproc-automation-trigger-item-wrapper").forEach((function(e){r.Dom.addClass(e,"bizproc-automation-trigger-item-wrapper-draggable")}))}},{key:"disableDragAndDrop",value:function e(){babelHelpers.classPrivateFieldGet(this,me).forEach((function(e){return e.unregisterItem(e.node)}));babelHelpers.classPrivateFieldGet(this,fe).querySelectorAll(".bizproc-automation-trigger-item-wrapper").forEach((function(e){r.Dom.removeClass(e,"bizproc-automation-trigger-item-wrapper-draggable")}))}},{key:"insertTriggerNode",value:function e(t,a){var i=babelHelpers.classPrivateFieldGet(this,fe).querySelector('[data-role="trigger-list"][data-status-id="'+t+'"]');if(i){i.appendChild(a)}}},{key:"serialize",value:function e(){return babelHelpers.classPrivateFieldGet(this,me).map((function(e){return e.serialize()}))}},{key:"countAllTriggers",value:function e(){return babelHelpers.classPrivateFieldGet(this,me).filter((function(e){return!e.deleted})).length}},{key:"getTriggerName",value:function e(t){var a,s;return(a=(s=i.getGlobalContext().availableTriggers.find((function(e){return t===e["CODE"]})))===null||s===void 0?void 0:s.NAME)!==null&&a!==void 0?a:t}},{key:"getAvailableTrigger",value:function e(t){var a=i.getGlobalContext().availableTriggers;for(var s=0;s<a.length;++s){if(t===a[s]["CODE"]){return a[s]}}return null}},{key:"canEdit",value:function e(){return i.getGlobalContext().canEdit}},{key:"canSetExecuteBy",value:function e(){var t;return(t=i.getGlobalContext().get("TRIGGER_CAN_SET_EXECUTE_BY"))!==null&&t!==void 0?t:false}},{key:"needSave",value:function e(){return babelHelpers.classPrivateFieldGet(this,Oe)}},{key:"markModified",value:function e(t){babelHelpers.classPrivateFieldSet(this,Oe,t!==false);if(babelHelpers.classPrivateFieldGet(this,Oe)){this.emit("TriggerManager:dataModified")}}},{key:"openTriggerSettingsDialog",value:function e(t,a){var s=this;if(be.getInstance().getTriggerSettingsDialog()){if(a&&a.changeTrigger){be.getInstance().getTriggerSettingsDialog().popup.close()}else{return}}var l="bizproc_automation_trigger_dialog";var n=r.Dom.create("form",{props:{name:l},style:{"min-width":"540px"}});n.appendChild(this.renderConditionSettings(t));var o=r.Dom.create("div",{attrs:{className:"bizproc-automation-robot-help"},events:{click:function e(t){return s.emit("TriggerManager:onHelpClick",t)}}});n.appendChild(o);var c=this.getTriggerName(t.getCode());n.appendChild(r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_TRIGGER_NAME")+":"}));n.appendChild(r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[r.Dom.create("input",{attrs:{className:"bizproc-automation-popup-input",type:"text",name:"name",value:t.getName()||c}})]}));var p=this.getAvailableTrigger(t.getCode());if(t.getCode()==="WEBHOOK"){if(!t.getApplyRules()["code"]){t.getApplyRules()["code"]=r.Text.getRandom(5)}n.appendChild(r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:"URL:"}));n.appendChild(r.Dom.create("input",{props:{type:"hidden",value:t.getApplyRules()["code"],name:"code"}}));var u=r.Dom.create("textarea",{attrs:{className:"bizproc-automation-popup-textarea",placeholder:"...",readonly:"readonly",name:"webhook_handler"},events:{click:function e(t){this.select()}}});n.appendChild(r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[u]}));n.appendChild(r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_WEBHOOK_ID")}));if(p&&p["HANDLER"]){var b=window.location.protocol+"//"+window.location.host+p["HANDLER"];b=r.Uri.addParam(b,{code:t.getApplyRules()["code"]});b=b.replace("{{DOCUMENT_TYPE}}",i.getGlobalContext().document.getRawType()[2]);u.value=b}}else if(t.getCode()==="EMAIL_LINK"){n.appendChild(r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_TRIGGER_EMAIL_LINK_URL")+":"}));n.appendChild(r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[r.Dom.create("textarea",{attrs:{className:"bizproc-automation-popup-textarea",placeholder:"https://example.com"},props:{name:"url"},text:t.getApplyRules()["url"]||""})]}))}else if(t.getCode()==="WEBFORM"){if(p&&p["WEBFORM_LIST"]){var d=r.Dom.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"},props:{name:"form_id",value:""},children:[r.Dom.create("option",{props:{value:""},text:r.Loc.getMessage("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_ANY")})]});for(var v=0;v<p["WEBFORM_LIST"].length;++v){var h=p["WEBFORM_LIST"][v];d.appendChild(r.Dom.create("option",{props:{value:h["ID"]},text:h["NAME"]}))}if(r.Type.isPlainObject(t.getApplyRules())&&t.getApplyRules()["form_id"]){d.value=t.getApplyRules()["form_id"]}var f=r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_LABEL")+":"}),d]});n.appendChild(f)}}else if(t.getCode()==="CALLBACK"){if(p&&p["WEBFORM_LIST"]){var g=r.Dom.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"},props:{name:"form_id",value:""},children:[r.Dom.create("option",{props:{value:""},text:r.Loc.getMessage("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_ANY")})]});for(var m=0;m<p["WEBFORM_LIST"].length;++m){var T=p["WEBFORM_LIST"][m];g.appendChild(r.Dom.create("option",{props:{value:T["ID"]},text:T["NAME"]}))}if(r.Type.isPlainObject(t.getApplyRules())&&t.getApplyRules()["form_id"]){g.value=t.getApplyRules()["form_id"]}var P=r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_LABEL")+":"}),g]});n.appendChild(P)}}else if(t.getCode()==="STATUS"){if(p&&p["STATUS_LIST"]){var y=r.Dom.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"},props:{name:"STATUS",value:""},children:[r.Dom.create("option",{props:{value:""},text:r.Loc.getMessage("BIZPROC_AUTOMATION_TRIGGER_STATUS_ANY")})]});for(var C=0;C<p["STATUS_LIST"].length;++C){var O=p["STATUS_LIST"][C];y.appendChild(r.Dom.create("option",{props:{value:O["ID"]},text:O["NAME"]}))}if(r.Type.isPlainObject(t.getApplyRules())&&t.getApplyRules()["STATUS"]){y.value=t.getApplyRules()["STATUS"]}var I=r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:p["STATUS_LABEL"]+":"}),y]});n.appendChild(I)}}else if(t.getCode()=="CALL"){if(p&&p["LINES"]){var H=r.Dom.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"},props:{name:"LINE_NUMBER",value:""},children:[r.Dom.create("option",{props:{value:""},text:r.Loc.getMessage("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_ANY")})]});for(var E=0;E<p["LINES"].length;++E){var A=p["LINES"][E];H.appendChild(r.Dom.create("option",{props:{value:A["LINE_NUMBER"]},text:A["SHORT_NAME"]}))}if(t.getApplyRules()["LINE_NUMBER"]){H.value=t.getApplyRules()["LINE_NUMBER"]}var _=r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_TRIGGER_CALL_LABEL")+":"}),H]});n.appendChild(_)}}else if(t.getCode()=="OPENLINE"||t.getCode()=="OPENLINE_MSG"){if(p&&p["CONFIG_LIST"]){var F=r.Dom.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"},props:{name:"config_id",value:""},children:[r.Dom.create("option",{props:{value:""},text:r.Loc.getMessage("BIZPROC_AUTOMATION_TRIGGER_WEBFORM_ANY")})]});for(var N=0;N<p["CONFIG_LIST"].length;++N){var S=p["CONFIG_LIST"][N];F.appendChild(r.Dom.create("option",{props:{value:S["ID"]},text:S["NAME"]}))}if(r.Type.isPlainObject(t.getApplyRules())&&t.getApplyRules()["config_id"]){F.value=t.getApplyRules()["config_id"]}var k=r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_TRIGGER_OPENLINE_LABEL")+":"}),F]});n.appendChild(k)}}BX.onCustomEvent("BX.Bizproc.Automation.TriggerManager:onOpenSettingsDialog-"+t.getCode(),[t,n]);if(this.canSetExecuteBy()){this.renderExecuteByControl(t,n)}this.renderAllowBackwardsControl(t,n);r.Dom.addClass(babelHelpers.classPrivateFieldGet(this,fe),"automation-base-blocked");be.getInstance().setTriggerSettingsDialog({triggerManager:this,trigger:t,form:n});var G=t.draft?this.createChangeTriggerTitleBar(c,t.documentStatus):null;var M=this;var D=new BX.PopupWindow(BX.Bizproc.Helper.generateUniqueId(),null,{titleBar:G||c,content:n,closeIcon:true,offsetLeft:0,offsetTop:0,closeByEsc:true,draggable:{restrict:false},overlay:false,events:{onPopupClose:function e(t){be.getInstance().setTriggerSettingsDialog(null);M.destroySettingsDialogControls();t.destroy();r.Dom.removeClass(babelHelpers.classPrivateFieldGet(M,fe),"automation-base-blocked")}},buttons:[new BX.PopupWindowButton({text:r.Loc.getMessage("JS_CORE_WINDOW_SAVE"),className:"popup-window-button-accept",events:{click:function e(){var a=BX.ajax.prepareForm(n);t.setName(a["data"]["name"]);if(t.getCode()==="WEBFORM"){t.setApplyRules({form_id:a["data"]["form_id"]})}if(t.getCode()==="CALLBACK"){t.setApplyRules({form_id:a["data"]["form_id"]})}if(t.getCode()==="STATUS"){t.setApplyRules({STATUS:a["data"]["STATUS"]})}if(t.getCode()==="CALL"&&"LINE_NUMBER"in a["data"]){t.setApplyRules({LINE_NUMBER:a["data"]["LINE_NUMBER"]})}if(t.getCode()==="OPENLINE"||t.getCode()==="OPENLINE_MSG"){t.setApplyRules({config_id:a["data"]["config_id"]})}if(t.getCode()==="WEBHOOK"){t.setApplyRules({code:a["data"]["code"]})}if(t.getCode()==="EMAIL_LINK"){t.setApplyRules({url:a["data"]["url"]})}BX.onCustomEvent("BX.Bizproc.Automation.TriggerManager:onSaveSettings-"+t.getCode(),[t,a]);M.setConditionSettingsFromForm(a["data"],t);t.setAllowBackwards(a["data"]["allow_backwards"]==="Y");if(M.canSetExecuteBy()){t.setExecuteBy(a["data"]["execute_by"])}if(t.draft){babelHelpers.classPrivateFieldGet(M,me).push(t);M.insertTriggerNode(t.getStatusId(),t.node)}delete t.draft;t.reInit();M.markModified();this.popupWindow.close()}}}),new BX.PopupWindowButtonLink({text:r.Loc.getMessage("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function e(){this.popupWindow.close()}}})]});be.getInstance().getTriggerSettingsDialog().popup=D;D.show()}},{key:"createChangeTriggerTitleBar",value:function e(t,a){return{content:r.Dom.create("div",{props:{className:"popup-window-titlebar-text bizproc-automation-popup-titlebar-with-link"},children:[document.createTextNode(t),r.Dom.create("span",{props:{className:"bizproc-automation-popup-titlebar-link"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_CHANGE_TRIGGER"),events:{click:this.onChangeTriggerClick.bind(this,a)}})]})}}},{key:"renderConditionSettings",value:function e(t){var a=t.getCondition().clone();this.conditionSelector=new i.ConditionGroupSelector(a,{fields:i.getGlobalContext().document.getFields()});var s=this.conditionSelector;return r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings-block"},children:[r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION")+":"}),s.createNode()]})]})}},{key:"renderExecuteByControl",value:function e(t,a){a.appendChild(r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-top bizproc-automation-popup-settings-title-autocomplete"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_TRIGGER_EXECUTE_BY")+":"}));a.appendChild(r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[BX.Bizproc.FieldType.renderControl(i.getGlobalContext().document.getRawType(),{Type:"user"},"execute_by",t.draft?se.getResponsibleUserExpression(i.getGlobalContext().document.getFields()):t.getExecuteBy())]}))}},{key:"renderAllowBackwardsControl",value:function e(t,a){a.appendChild(r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-checkbox"},children:[r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-checkbox-item"},children:[r.Dom.create("label",{attrs:{className:"bizproc-automation-popup-chk-label"},children:[r.Dom.create("input",{attrs:{className:"bizproc-automation-popup-chk",type:"checkbox",name:"allow_backwards",value:"Y"},props:{checked:t.isBackwardsAllowed()}}),document.createTextNode(r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_TRIGGER_ALLOW_REVERSE"))]})]})]}))}},{key:"setConditionSettingsFromForm",value:function e(t,a){a.setCondition(i.ConditionGroup.createFromForm(t));return this}},{key:"onRestAppInstall",value:function e(t,a){a.redirect=false;setTimeout((function(){BX.ajax({method:"POST",dataType:"json",url:i.getGlobalContext().ajaxUrl,data:{ajax_action:"get_available_triggers",document_signed:i.getGlobalContext().signedDocument},onsuccess:function e(t){if(r.Type.isArray(t["DATA"])){i.getGlobalContext().set("availableTriggers",t["DATA"])}}})}),1500)}},{key:"initSettingsDialogControls",value:function e(t){if(!r.Type.isArray(this.settingsDialogControls)){this.settingsDialogControls=[]}var a=t.querySelectorAll("[data-role]");for(var i=0;i<a.length;++i){var s=null;var l=a[i].getAttribute("data-role");if(l==="user-selector"){s=BX.Bizproc.UserSelector.decorateNode(a[i])}BX.UI.Hint.init(a[i]);if(s){this.settingsDialogControls.push(s)}}}},{key:"destroySettingsDialogControls",value:function e(){if(this.conditionSelector){this.conditionSelector.destroy();this.conditionSelector=null}if(r.Type.isArray(this.settingsDialogControls)){for(var t=0;t<this.settingsDialogControls.length;++t){if(r.Type.isFunction(this.settingsDialogControls[t].destroy)){this.settingsDialogControls[t].destroy()}}}this.settingsDialogControls=null}},{key:"getListByDocumentStatus",value:function e(t){var a=[];babelHelpers.classPrivateFieldGet(this,me).forEach((function(e){if(e.getStatusId()===t){a.push(e)}}));return a}},{key:"getReturnProperties",value:function e(t){var a=[];var i={};var s=this.getListByDocumentStatus(t);s.forEach((function(e){var t=e.deleted?[]:e.getReturnProperties();if(t.length){t.forEach((function(t){if(!i[t.Id]){a.push({Id:t.Id,ObjectId:"Template",Name:t.Name,ObjectName:e.getName(),Type:t.Type,Expression:"{{~*:"+t.Id+"}}",SystemExpression:"{=Template:"+t.Id+"}"});i[t.Id]=true}}))}}));return a}},{key:"getReturnProperty",value:function e(t,a){var i=this.getReturnProperties(t);for(var s=0;s<i.length;++s){if(i[s].Id===a){return i[s]}}return null}}]);return a}(a.EventEmitter);function He(e,t,a){Ee(e,t);t.set(e,a)}function Ee(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var Ae=new WeakMap;var _e=new WeakMap;var Fe=new WeakMap;var Ne=new WeakMap;var Se=new WeakMap;var ke=new WeakMap;var Ge=new WeakMap;var Me=function(){function e(t){babelHelpers.classCallCheck(this,e);He(this,Ae,{writable:true,value:void 0});He(this,_e,{writable:true,value:void 0});He(this,Fe,{writable:true,value:void 0});He(this,Ne,{writable:true,value:void 0});He(this,Se,{writable:true,value:void 0});He(this,ke,{writable:true,value:void 0});He(this,Ge,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,Ae,t.rawDocumentType);babelHelpers.classPrivateFieldSet(this,_e,t.documentId);babelHelpers.classPrivateFieldSet(this,Fe,t.title);babelHelpers.classPrivateFieldSet(this,Ne,t.categoryId);babelHelpers.classPrivateFieldSet(this,Se,[]);babelHelpers.classPrivateFieldSet(this,ke,0);if(r.Type.isArray(t.statusList)){babelHelpers.classPrivateFieldSet(this,Se,t.statusList);babelHelpers.classPrivateFieldSet(this,ke,babelHelpers.classPrivateFieldGet(this,Se).findIndex((function(e){return e.STATUS_ID===t.statusId})))}else if(r.Type.isStringFilled(t.statusId)){babelHelpers.classPrivateFieldGet(this,Se).push(t.statusId)}if(babelHelpers.classPrivateFieldGet(this,ke)<0){babelHelpers.classPrivateFieldSet(this,ke,0)}babelHelpers.classPrivateFieldSet(this,Ge,r.Type.isArray(t.documentFields)?t.documentFields:[])}babelHelpers.createClass(e,[{key:"getRawType",value:function e(){return babelHelpers.classPrivateFieldGet(this,Ae)}},{key:"getCategoryId",value:function e(){return babelHelpers.classPrivateFieldGet(this,Ne)}},{key:"getCurrentStatusId",value:function e(){var t;return(t=babelHelpers.classPrivateFieldGet(this,Se)[babelHelpers.classPrivateFieldGet(this,ke)])===null||t===void 0?void 0:t.STATUS_ID}},{key:"getSortedStatusId",value:function e(t){if(t>=0&&t<babelHelpers.classPrivateFieldGet(this,Se).length){return babelHelpers.classPrivateFieldGet(this,Se)[t].STATUS_ID}return null}},{key:"getNextStatusIdList",value:function e(){return babelHelpers.classPrivateFieldGet(this,Se).slice(babelHelpers.classPrivateFieldGet(this,ke)+1).map((function(e){return e.STATUS_ID}))}},{key:"getPreviousStatusIdList",value:function e(){return babelHelpers.classPrivateFieldGet(this,Se).slice(0,babelHelpers.classPrivateFieldGet(this,ke)).map((function(e){return e.STATUS_ID}))}},{key:"setStatus",value:function e(t){var a=babelHelpers.classPrivateFieldGet(this,Se).findIndex((function(e){return e.STATUS_ID===t}));if(a>=0){babelHelpers.classPrivateFieldSet(this,ke,a)}return this}},{key:"getFields",value:function e(){return babelHelpers.classPrivateFieldGet(this,Ge)}},{key:"setFields",value:function e(t){babelHelpers.classPrivateFieldSet(this,Ge,t);return this}},{key:"setStatusList",value:function e(t){if(r.Type.isArrayFilled(t)){babelHelpers.classPrivateFieldSet(this,Se,t)}return this}},{key:"title",get:function e(){return babelHelpers.classPrivateFieldGet(this,Fe)}}]);return e}();function De(e,t,a){we(e,t);t.set(e,a)}function we(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var Re=new WeakMap;var Be=new WeakMap;var Le=new WeakMap;var xe=new WeakMap;var ze=new WeakMap;var Ue=new WeakMap;var Ye=function(){function e(t){babelHelpers.classCallCheck(this,e);De(this,Re,{writable:true,value:void 0});De(this,Be,{writable:true,value:void 0});De(this,Le,{writable:true,value:void 0});De(this,xe,{writable:true,value:void 0});De(this,ze,{writable:true,value:void 0});De(this,Ue,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,Re,e.BASIS_TYPE.CurrentDateTime);babelHelpers.classPrivateFieldSet(this,Be,e.DELAY_TYPE.After);babelHelpers.classPrivateFieldSet(this,Le,0);babelHelpers.classPrivateFieldSet(this,xe,"i");babelHelpers.classPrivateFieldSet(this,ze,false);babelHelpers.classPrivateFieldSet(this,Ue,false);if(r.Type.isPlainObject(t)){if(t["type"]){this.setType(t["type"])}if(t["value"]){this.setValue(t["value"])}if(t["valueType"]){this.setValueType(t["valueType"])}if(t["basis"]){this.setBasis(t["basis"])}if(t["workTime"]){this.setWorkTime(t["workTime"])}if(t["localTime"]){this.setLocalTime(t["localTime"])}}}babelHelpers.createClass(e,[{key:"clone",value:function t(){return new e({type:babelHelpers.classPrivateFieldGet(this,Be),value:babelHelpers.classPrivateFieldGet(this,Le),valueType:babelHelpers.classPrivateFieldGet(this,xe),basis:babelHelpers.classPrivateFieldGet(this,Re),workTime:babelHelpers.classPrivateFieldGet(this,ze),localTime:babelHelpers.classPrivateFieldGet(this,Ue)})}},{key:"setType",value:function t(a){if(a!==e.DELAY_TYPE.After&&a!==e.DELAY_TYPE.Before&&a!==e.DELAY_TYPE.In){a=e.DELAY_TYPE.After}babelHelpers.classPrivateFieldSet(this,Be,a);return this}},{key:"setValue",value:function e(t){t=parseInt(t);babelHelpers.classPrivateFieldSet(this,Le,t>=0?t:0);return this}},{key:"setValueType",value:function e(t){if(t!=="i"&&t!=="h"&&t!=="d"){t="i"}babelHelpers.classPrivateFieldSet(this,xe,t);return this}},{key:"setBasis",value:function e(t){if(r.Type.isString(t)&&t!==""){babelHelpers.classPrivateFieldSet(this,Re,t)}return this}},{key:"setWorkTime",value:function e(t){babelHelpers.classPrivateFieldSet(this,ze,!!t);return this}},{key:"setLocalTime",value:function e(t){babelHelpers.classPrivateFieldSet(this,Ue,!!t);return this}},{key:"isNow",value:function t(){return babelHelpers.classPrivateFieldGet(this,Be)===e.DELAY_TYPE.After&&babelHelpers.classPrivateFieldGet(this,Re)===e.BASIS_TYPE.CurrentDateTime&&!babelHelpers.classPrivateFieldGet(this,Le)}},{key:"setNow",value:function t(){this.setType(e.DELAY_TYPE.After);this.setValue(0);this.setValueType("i");this.setBasis(e.BASIS_TYPE.CurrentDateTime)}},{key:"serialize",value:function e(){return{type:babelHelpers.classPrivateFieldGet(this,Be),value:babelHelpers.classPrivateFieldGet(this,Le),valueType:babelHelpers.classPrivateFieldGet(this,xe),basis:babelHelpers.classPrivateFieldGet(this,Re),workTime:babelHelpers.classPrivateFieldGet(this,ze)?1:0}}},{key:"toExpression",value:function t(a,i){var s=babelHelpers.classPrivateFieldGet(this,Re)?babelHelpers.classPrivateFieldGet(this,Re):e.BASIS_TYPE.CurrentDate;if(!e.isSystemBasis(s)&&r.Type.isArray(a)){for(var l=0,n=a.length;l<n;++l){if(s===a[l].SystemExpression){s=a[l].Expression;break}}}if(!babelHelpers.classPrivateFieldGet(this,ze)&&(babelHelpers.classPrivateFieldGet(this,Be)===e.DELAY_TYPE.In||this.isNow())){return s}var o=0;var c=0;var p=0;switch(babelHelpers.classPrivateFieldGet(this,xe)){case"i":p=babelHelpers.classPrivateFieldGet(this,Le);break;case"h":c=babelHelpers.classPrivateFieldGet(this,Le);break;case"d":o=babelHelpers.classPrivateFieldGet(this,Le);break}var u="";if(babelHelpers.classPrivateFieldGet(this,Be)===e.DELAY_TYPE.Before){u="-"}if(o>0){u+=o+"d"}if(c>0){u+=c+"h"}if(p>0){u+=p+"i"}var b=babelHelpers.classPrivateFieldGet(this,ze)?"workdateadd":"dateadd";if(b==="workdateadd"&&u===""){u="0d"}var d="";if(b==="workdateadd"&&i){d=i}return"="+b+"("+s+',"'+u+'"'+(d?","+d:"")+")"}},{key:"format",value:function t(a,i){var s=a;if(babelHelpers.classPrivateFieldGet(this,Be)===e.DELAY_TYPE.In){s=r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_IN_TIME");if(r.Type.isArray(i)){for(var l=0;l<i.length;++l){if(babelHelpers.classPrivateFieldGet(this,Re)===i[l].SystemExpression){s+=" "+i[l].Name;break}}}}else if(babelHelpers.classPrivateFieldGet(this,Le)){var n=babelHelpers.classPrivateFieldGet(this,Be)===e.DELAY_TYPE.After?r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_THROUGH"):r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_FOR_TIME_1");s=n+" "+this.getFormattedPeriodLabel(babelHelpers.classPrivateFieldGet(this,Le),babelHelpers.classPrivateFieldGet(this,xe));if(r.Type.isArray(i)){var o=babelHelpers.classPrivateFieldGet(this,Be)===e.DELAY_TYPE.After?r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_AFTER"):r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_BEFORE_1");for(var c=0;c<i.length;++c){if(babelHelpers.classPrivateFieldGet(this,Re)===i[c].SystemExpression){s+=" "+o+" "+i[c].Name;break}}}}if(babelHelpers.classPrivateFieldGet(this,ze)){s+=", "+r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_IN_WORKTIME")}return s}},{key:"getFormattedPeriodLabel",value:function t(a,i){var s=a+" ";var r=0;if(a>20){a=a%10}if(a===1){r=0}else if(a>1&&a<5){r=1}else{r=2}var l=e.getPeriodLabels(i);return s+(l?l[r]:"")}},{key:"basis",get:function e(){return babelHelpers.classPrivateFieldGet(this,Re)}},{key:"type",get:function e(){return babelHelpers.classPrivateFieldGet(this,Be)}},{key:"value",get:function e(){return babelHelpers.classPrivateFieldGet(this,Le)}},{key:"valueType",get:function e(){return babelHelpers.classPrivateFieldGet(this,xe)}},{key:"workTime",get:function e(){return babelHelpers.classPrivateFieldGet(this,ze)}},{key:"localTime",get:function e(){return babelHelpers.classPrivateFieldGet(this,Ue)}}],[{key:"isSystemBasis",value:function e(t){return t===this.BASIS_TYPE.CurrentDate||t===this.BASIS_TYPE.CurrentDateTime||t===this.BASIS_TYPE.CurrentDateTimeLocal}},{key:"fromString",value:function t(a,i){a=a.toString();var s={basis:e.BASIS_TYPE.CurrentDateTime,i:0,h:0,d:0,workTime:false,localTime:false};if(a.indexOf("=dateadd(")===0||a.indexOf("=workdateadd(")===0){if(a.indexOf("=workdateadd(")===0){a=a.substring(13);s["workTime"]=true}else{a=a.substring(9)}var r=a.split(",");s["basis"]=r[0].trim();r[1]=r[1].replace(/['")]+/g,"");s["type"]=r[1].indexOf("-")===0?e.DELAY_TYPE.Before:e.DELAY_TYPE.After;var l;var n=/s*([\d]+)\s*(i|h|d)\s*/gi;while(l=n.exec(r[1])){s[l[2]]=parseInt(l[1])}}else{s["basis"]=a}if(!e.isSystemBasis(s["basis"])&&BX.type.isArray(i)){var o=false;for(var c=0,p=i.length;c<p;++c){if(s["basis"]===i[c].SystemExpression||s["basis"]===i[c].Expression){s["basis"]=i[c].SystemExpression;o=true;break}}if(!o){s["basis"]=e.BASIS_TYPE.CurrentDateTime}}var u=s["i"]+s["h"]*60+s["d"]*60*24;if(u%1440===0){s["value"]=u/1440;s["valueType"]="d"}else if(u%60===0){s["value"]=u/60;s["valueType"]="h"}else{s["value"]=u;s["valueType"]="i"}if(!s["value"]&&s["basis"]!==e.BASIS_TYPE.CurrentDateTime&&s["basis"]){s["type"]=e.DELAY_TYPE.In}return new e(s)}},{key:"fromMinutes",value:function e(t){var a;var i;if(t%1440===0){a=t/1440;i="d"}else if(t%60===0){a=t/60;i="h"}else{a=t;i="i"}return[a,i]}},{key:"toMinutes",value:function e(t,a){var i=0;switch(a){case"i":i=t;break;case"h":i=t*60;break;case"d":i=t*60*24;break}return i}},{key:"getPeriodLabels",value:function e(t){var a=[];if(t==="i"){a=[r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_MIN1"),r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_MIN2"),r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_MIN3")]}else if(t==="h"){a=[r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_HOUR1"),r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_HOUR2"),r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_HOUR3")]}else if(t==="d"){a=[r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_DAY1"),r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_DAY2"),r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_DAY3")]}return a}}]);return e}();babelHelpers.defineProperty(Ye,"BASIS_TYPE",{CurrentDate:"{=System:Date}",CurrentDateTime:"{=System:Now}",CurrentDateTimeLocal:"{=System:NowLocal}"});babelHelpers.defineProperty(Ye,"DELAY_TYPE",{After:"after",Before:"before",In:"in"});var We=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(We,"CREATED_WORKFLOW_STATUS",0);babelHelpers.defineProperty(We,"RUNNING_WORKFLOW_STATUS",1);babelHelpers.defineProperty(We,"COMPLETED_WORKFLOW_STATUS",2);babelHelpers.defineProperty(We,"SUSPENDED_WORKFLOW_STATUS",3);babelHelpers.defineProperty(We,"TERMINATED_WORKFLOW_STATUS",4);function je(e,t,a){Ze(e,t);t.set(e,a)}function Ze(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var Xe=new WeakMap;var Ve=new WeakMap;var Ke=function(){function e(){babelHelpers.classCallCheck(this,e);je(this,Xe,{writable:true,value:void 0});je(this,Ve,{writable:true,value:void 0})}babelHelpers.createClass(e,[{key:"isTriggerEntry",value:function t(){return this.type===e.TRIGGER_ACTIVITY_TYPE}},{key:"type",get:function e(){return babelHelpers.classPrivateFieldGet(this,Xe)},set:function t(a){if(e.getAllActivityTypes().includes(a)){babelHelpers.classPrivateFieldSet(this,Xe,a)}}},{key:"workflowStatus",get:function e(){return babelHelpers.classPrivateFieldGet(this,Ve)},set:function t(a){if(e.getAllWorkflowStatuses().includes(a)){babelHelpers.classPrivateFieldSet(this,Ve,a)}}}],[{key:"getAllActivityTypes",value:function t(){return[e.UNKNOWN_ACTIVITY_TYPE,e.EXECUTE_ACTIVITY_TYPE,e.CLOSE_ACTIVITY_TYPE,e.CANCEL_ACTIVITY_TYPE,e.FAULT_ACTIVITY_TYPE,e.CUSTOM_ACTIVITY_TYPE,e.REPORT_ACTIVITY_TYPE,e.ATTACHED_ENTITY_TYPE,e.TRIGGER_ACTIVITY_TYPE,e.ERROR_ACTIVITY_TYPE,e.DEBUG_ACTIVITY_TYPE,e.DEBUG_AUTOMATION_TYPE,e.DEBUG_DESIGNER_TYPE,e.DEBUG_LINK_TYPE]}},{key:"isKnownActivityType",value:function t(a){return e.getAllActivityTypes().includes(a)}},{key:"getAllWorkflowStatuses",value:function e(){return[We.CREATED_WORKFLOW_STATUS,We.RUNNING_WORKFLOW_STATUS,We.COMPLETED_WORKFLOW_STATUS,We.SUSPENDED_WORKFLOW_STATUS,We.TERMINATED_WORKFLOW_STATUS]}},{key:"isKnownWorkflowStatus",value:function t(a){return e.getAllWorkflowStatuses().includes(a)}}]);return e}();babelHelpers.defineProperty(Ke,"UNKNOWN_ACTIVITY_TYPE",0);babelHelpers.defineProperty(Ke,"EXECUTE_ACTIVITY_TYPE",1);babelHelpers.defineProperty(Ke,"CLOSE_ACTIVITY_TYPE",2);babelHelpers.defineProperty(Ke,"CANCEL_ACTIVITY_TYPE",3);babelHelpers.defineProperty(Ke,"FAULT_ACTIVITY_TYPE",4);babelHelpers.defineProperty(Ke,"CUSTOM_ACTIVITY_TYPE",5);babelHelpers.defineProperty(Ke,"REPORT_ACTIVITY_TYPE",6);babelHelpers.defineProperty(Ke,"ATTACHED_ENTITY_TYPE",7);babelHelpers.defineProperty(Ke,"TRIGGER_ACTIVITY_TYPE",8);babelHelpers.defineProperty(Ke,"ERROR_ACTIVITY_TYPE",9);babelHelpers.defineProperty(Ke,"DEBUG_ACTIVITY_TYPE",10);babelHelpers.defineProperty(Ke,"DEBUG_AUTOMATION_TYPE",11);babelHelpers.defineProperty(Ke,"DEBUG_DESIGNER_TYPE",12);babelHelpers.defineProperty(Ke,"DEBUG_LINK_TYPE",13);var qe=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(qe,"WAITING",0);babelHelpers.defineProperty(qe,"RUNNING",1);babelHelpers.defineProperty(qe,"COMPLETED",2);babelHelpers.defineProperty(qe,"AUTOCOMPLETED",3);function Je(e,t){var a=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=$e(e))||t&&e&&typeof e.length==="number"){if(a)e=a;var i=0;var s=function e(){};return{s:s,n:function t(){if(i>=e.length)return{done:true};return{done:false,value:e[i++]}},e:function e(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,l=false,n;return{s:function t(){a=a.call(e)},n:function e(){var t=a.next();r=t.done;return t},e:function e(t){l=true;n=t},f:function e(){try{if(!r&&a["return"]!=null)a["return"]()}finally{if(l)throw n}}}}function $e(e,t){if(!e)return;if(typeof e==="string")return Qe(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);if(a==="Object"&&e.constructor)a=e.constructor.name;if(a==="Map"||a==="Set")return Array.from(e);if(a==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Qe(e,t)}function Qe(e,t){if(t==null||t>e.length)t=e.length;for(var a=0,i=new Array(t);a<t;a++){i[a]=e[a]}return i}function et(e,t,a){tt(e,t);t.set(e,a)}function tt(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var at=new WeakMap;var it=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"id","");babelHelpers.defineProperty(this,"status",qe.WAITING);babelHelpers.defineProperty(this,"modified",undefined);babelHelpers.defineProperty(this,"notes",[]);babelHelpers.defineProperty(this,"errors",[]);et(this,at,{writable:true,value:-1});babelHelpers.defineProperty(this,"workflowStatus",We.CREATED_WORKFLOW_STATUS);if(r.Type.isArray(t)){var a=Je(t),i;try{for(a.s();!(i=a.n()).done;){var s=i.value;this.addEntry(s)}}catch(e){a.e(e)}finally{a.f()}}}babelHelpers.createClass(e,[{key:"addEntry",value:function e(t){this.id=t.name;if(babelHelpers.classPrivateFieldGet(this,at)<t.id){babelHelpers.classPrivateFieldSet(this,at,t.id);this.modified=t.datetime;this.workflowStatus=t.workflowStatus;if(t.type===i.TrackingEntry.CLOSE_ACTIVITY_TYPE){this.status=qe.COMPLETED}else{this.status=qe.RUNNING}}if(t.type===i.TrackingEntry.ERROR_ACTIVITY_TYPE){this.errors.push(t.note)}else if(t.type===i.TrackingEntry.CUSTOM_ACTIVITY_TYPE){this.notes.push(t.note)}}}]);return e}();var st=function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"id","");babelHelpers.defineProperty(this,"status",qe.COMPLETED);babelHelpers.defineProperty(this,"modified",undefined);if(t.isTriggerEntry()){this.id=t.note;this.modified=t.datetime}};function rt(e,t,a){lt(e,t);t.set(e,a)}function lt(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var nt=new WeakMap;var ot=new WeakMap;var ct=function(){function e(){babelHelpers.classCallCheck(this,e);rt(this,nt,{writable:true,value:{id:Ke.UNKNOWN_ACTIVITY_TYPE,workflowId:"",type:Ke.EXECUTE_ACTIVITY_TYPE,name:"",title:"",datetime:"",note:"",workflowStatus:We.CREATED_WORKFLOW_STATUS}});rt(this,ot,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,ot,babelHelpers.classPrivateFieldGet(this,nt))}babelHelpers.createClass(e,[{key:"setLogEntry",value:function e(t){babelHelpers.classPrivateFieldSet(this,ot,Object.assign({},babelHelpers.classPrivateFieldGet(this,nt)));t=Object.assign({},t);if(r.Type.isStringFilled(t["ID"])){t["ID"]=parseInt(t["ID"])}if(r.Type.isStringFilled(t["TYPE"])){t["TYPE"]=parseInt(t["TYPE"])}if(r.Type.isNumber(t["ID"])){babelHelpers.classPrivateFieldGet(this,ot).id=t["ID"]}if(r.Type.isStringFilled(t["WORKFLOW_ID"])){babelHelpers.classPrivateFieldGet(this,ot).workflowId=t["WORKFLOW_ID"]}if(r.Type.isNumber(t["TYPE"])&&Ke.isKnownActivityType(t["TYPE"])){babelHelpers.classPrivateFieldGet(this,ot).type=t["TYPE"]}if(r.Type.isStringFilled(t["MODIFIED"])){babelHelpers.classPrivateFieldGet(this,ot).datetime=t["MODIFIED"]}if(r.Type.isNumber(t["WORKFLOW_STATUS"])&&Ke.isKnownWorkflowStatus(t["WORKFLOW_STATUS"])){babelHelpers.classPrivateFieldGet(this,ot).workflowStatus=t["WORKFLOW_STATUS"]}babelHelpers.classPrivateFieldGet(this,ot).name=String(t["ACTION_NAME"]);babelHelpers.classPrivateFieldGet(this,ot).title=String(t["ACTION_TITLE"]);babelHelpers.classPrivateFieldGet(this,ot).note=String(t["ACTION_NOTE"]);return this}},{key:"setStatus",value:function e(t){babelHelpers.classPrivateFieldGet(this,ot).status=t;return this}},{key:"build",value:function e(){var t=new Ke;t.id=babelHelpers.classPrivateFieldGet(this,ot).id;t.workflowId=babelHelpers.classPrivateFieldGet(this,ot).workflowId;t.type=babelHelpers.classPrivateFieldGet(this,ot).type;t.name=babelHelpers.classPrivateFieldGet(this,ot).name;t.title=babelHelpers.classPrivateFieldGet(this,ot).title;t.note=babelHelpers.classPrivateFieldGet(this,ot).note;t.datetime=babelHelpers.classPrivateFieldGet(this,ot).datetime;t.workflowStatus=babelHelpers.classPrivateFieldGet(this,ot).workflowStatus;return t}}]);return e}();function pt(e,t){var a=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=ut(e))||t&&e&&typeof e.length==="number"){if(a)e=a;var i=0;var s=function e(){};return{s:s,n:function t(){if(i>=e.length)return{done:true};return{done:false,value:e[i++]}},e:function e(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,l=false,n;return{s:function t(){a=a.call(e)},n:function e(){var t=a.next();r=t.done;return t},e:function e(t){l=true;n=t},f:function e(){try{if(!r&&a["return"]!=null)a["return"]()}finally{if(l)throw n}}}}function ut(e,t){if(!e)return;if(typeof e==="string")return bt(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);if(a==="Object"&&e.constructor)a=e.constructor.name;if(a==="Map"||a==="Set")return Array.from(e);if(a==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return bt(e,t)}function bt(e,t){if(t==null||t>e.length)t=e.length;for(var a=0,i=new Array(t);a<t;a++){i[a]=e[a]}return i}function dt(e,t,a){vt(e,t);t.set(e,a)}function vt(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var ht=new WeakMap;var ft=new WeakMap;var gt=new WeakMap;var mt=new WeakMap;var Tt=function(){function e(t,a){babelHelpers.classCallCheck(this,e);dt(this,ht,{writable:true,value:void 0});dt(this,ft,{writable:true,value:void 0});dt(this,gt,{writable:true,value:void 0});dt(this,mt,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,ht,a);babelHelpers.classPrivateFieldSet(this,ft,t)}babelHelpers.createClass(e,[{key:"init",value:function e(t){babelHelpers.classPrivateFieldSet(this,gt,{});babelHelpers.classPrivateFieldSet(this,mt,{});this.addLogs(t)}},{key:"reInit",value:function e(t){this.init(t)}},{key:"addLogs",value:function e(t){if(!r.Type.isPlainObject(t)){t={}}var a=new ct;for(var i=0,s=Object.entries(t);i<s.length;i++){var l=babelHelpers.slicedToArray(s[i],2),n=l[0],o=l[1];if(!r.Type.isArray(o)){continue}var c=pt(o),p;try{for(c.s();!(p=c.n()).done;){var u=p.value;var b=a.setLogEntry(u).build();if(b.isTriggerEntry()){this.addTriggerEntry(b)}else{this.addRobotEntry(b);var d=babelHelpers.classPrivateFieldGet(this,mt)[b.name];if(!r.Type.isNil(babelHelpers.classPrivateFieldGet(this,ft))){var v=d.status===qe.RUNNING;var h=d.workflowStatus===We.COMPLETED_WORKFLOW_STATUS;var f=babelHelpers.classPrivateFieldGet(this,ft).getCurrentStatusId()===n;var g=v&&!f;var m=v&&h&&f;if(g||m){d.status=qe.COMPLETED}}}}}catch(e){c.e(e)}finally{c.f()}}}},{key:"addTriggerEntry",value:function e(t){if(t.isTriggerEntry()){babelHelpers.classPrivateFieldGet(this,gt)[t.note]=new st(t)}}},{key:"addRobotEntry",value:function e(t){if(t.isTriggerEntry()){return}if(!babelHelpers.classPrivateFieldGet(this,mt)[t.name]){babelHelpers.classPrivateFieldGet(this,mt)[t.name]=new it([t])}else{babelHelpers.classPrivateFieldGet(this,mt)[t.name].addEntry(t)}}},{key:"getRobotLog",value:function e(t){return babelHelpers.classPrivateFieldGet(this,mt)[t]||null}},{key:"getTriggerLog",value:function e(t){return babelHelpers.classPrivateFieldGet(this,gt)[t]||null}},{key:"update",value:function e(t){var a=this;return BX.ajax({method:"POST",dataType:"json",url:babelHelpers.classPrivateFieldGet(this,ht),data:{ajax_action:"get_log",document_signed:t},onsuccess:function e(t){if(t.DATA&&t.DATA.LOG){a.reInit(t.DATA.LOG)}}})}}]);return e}();function Pt(e,t){var a=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=yt(e))||t&&e&&typeof e.length==="number"){if(a)e=a;var i=0;var s=function e(){};return{s:s,n:function t(){if(i>=e.length)return{done:true};return{done:false,value:e[i++]}},e:function e(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,l=false,n;return{s:function t(){a=a.call(e)},n:function e(){var t=a.next();r=t.done;return t},e:function e(t){l=true;n=t},f:function e(){try{if(!r&&a["return"]!=null)a["return"]()}finally{if(l)throw n}}}}function yt(e,t){if(!e)return;if(typeof e==="string")return Ct(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);if(a==="Object"&&e.constructor)a=e.constructor.name;if(a==="Map"||a==="Set")return Array.from(e);if(a==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return Ct(e,t)}function Ct(e,t){if(t==null||t>e.length)t=e.length;for(var a=0,i=new Array(t);a<t;a++){i[a]=e[a]}return i}function Ot(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,i)}return a}function It(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?Ot(Object(a),!0).forEach((function(t){babelHelpers.defineProperty(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):Ot(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function Ht(e,t,a){Et(e,t);t.set(e,a)}function Et(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var At=new WeakMap;var _t=new WeakMap;var Ft=new WeakMap;var Nt=new WeakMap;var St=new WeakMap;var kt=new WeakMap;var Gt=new WeakMap;var Mt=new WeakMap;var Dt=new WeakMap;var wt=new WeakMap;var Rt=function(e){babelHelpers.inherits(t,e);function t(e){var a;babelHelpers.classCallCheck(this,t);a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"SYSTEM_EXPRESSION_PATTERN","\\{=\\s*(?<object>[a-z0-9_]+)\\s*\\:\\s*(?<field>[a-z0-9_\\.]+)(\\s*>\\s*(?<mod1>[a-z0-9_\\:]+)(\\s*,\\s*(?<mod2>[a-z0-9_]+))?)?\\s*\\}");Ht(babelHelpers.assertThisInitialized(a),At,{writable:true,value:void 0});Ht(babelHelpers.assertThisInitialized(a),_t,{writable:true,value:void 0});Ht(babelHelpers.assertThisInitialized(a),Ft,{writable:true,value:void 0});Ht(babelHelpers.assertThisInitialized(a),Nt,{writable:true,value:void 0});Ht(babelHelpers.assertThisInitialized(a),St,{writable:true,value:void 0});Ht(babelHelpers.assertThisInitialized(a),kt,{writable:true,value:void 0});Ht(babelHelpers.assertThisInitialized(a),Gt,{writable:true,value:void 0});Ht(babelHelpers.assertThisInitialized(a),Mt,{writable:true,value:void 0});Ht(babelHelpers.assertThisInitialized(a),Dt,{writable:true,value:void 0});Ht(babelHelpers.assertThisInitialized(a),wt,{writable:true,value:void 0});a.setEventNamespace("BX.Bizproc.Automation");babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),_t,e.document);if(!r.Type.isNil(e.template)){babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),Ft,e.template)}babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),Dt,e.isFrameMode);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),wt,S.none());babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),Nt,e.tracker);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),Mt,false);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),St,new Ye);return a}babelHelpers.createClass(t,[{key:"hasTemplate",value:function e(){return!r.Type.isNil(babelHelpers.classPrivateFieldGet(this,Ft))}},{key:"getTemplate",value:function e(){return babelHelpers.classPrivateFieldGet(this,Ft)}},{key:"getDocument",value:function e(){return babelHelpers.classPrivateFieldGet(this,_t)}},{key:"clone",value:function e(){var a=new t({document:babelHelpers.classPrivateFieldGet(this,_t),template:babelHelpers.classPrivateFieldGet(this,Ft),isFrameMode:babelHelpers.classPrivateFieldGet(this,Dt),tracker:babelHelpers.classPrivateFieldGet(this,Nt)});var i=It({Name:t.generateName(),Delay:this.getDelayInterval().clone(),Condition:this.getCondition().clone()},BX.clone(babelHelpers.classPrivateFieldGet(this,At)));a.init(i,babelHelpers.classPrivateFieldGet(this,wt));return a}},{key:"isEqual",value:function e(t){return babelHelpers.classPrivateFieldGet(this,At).Name===babelHelpers.classPrivateFieldGet(t,At).Name}},{key:"init",value:function e(a,s){if(r.Type.isPlainObject(a)){babelHelpers.classPrivateFieldSet(this,At,a)}if(!babelHelpers.classPrivateFieldGet(this,At).Name){babelHelpers.classPrivateFieldGet(this,At).Name=t.generateName()}babelHelpers.classPrivateFieldSet(this,St,new Ye(babelHelpers.classPrivateFieldGet(this,At).Delay));babelHelpers.classPrivateFieldSet(this,Gt,new i.ConditionGroup(babelHelpers.classPrivateFieldGet(this,At).Condition));if(!babelHelpers.classPrivateFieldGet(this,At).Condition){babelHelpers.classPrivateFieldGet(this,Gt).type=i.ConditionGroup.CONDITION_TYPE.Mixed}babelHelpers.classPrivateFieldSet(this,wt,r.Type.isNil(s)?S.edit():s);if(!babelHelpers.classPrivateFieldGet(this,wt).isNone()){babelHelpers.classPrivateFieldSet(this,kt,this.createNode())}}},{key:"reInit",value:function e(t,a){if(r.Type.isNil(a)&&babelHelpers.classPrivateFieldGet(this,wt).isNone()){return}var i=babelHelpers.classPrivateFieldGet(this,kt);babelHelpers.classPrivateFieldSet(this,kt,this.createNode());if(i.parentNode){i.parentNode.replaceChild(babelHelpers.classPrivateFieldGet(this,kt),i)}}},{key:"destroy",value:function e(){this.emit("Robot:destroyed")}},{key:"canEdit",value:function e(){return babelHelpers.classPrivateFieldGet(this,Ft).canEdit()}},{key:"getProperties",value:function e(){if(babelHelpers.classPrivateFieldGet(this,At)&&r.Type.isPlainObject(babelHelpers.classPrivateFieldGet(this,At).Properties)){return babelHelpers.classPrivateFieldGet(this,At).Properties}return{}}},{key:"getProperty",value:function e(t){return this.getProperties()[t]||null}},{key:"hasProperty",value:function e(t){return this.getProperties().hasOwnProperty(t)}},{key:"setProperty",value:function e(t,a){babelHelpers.classPrivateFieldGet(this,At).Properties[t]=a;return this}},{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,At).Name||null}},{key:"getLogStatus",value:function e(){var t=qe.WAITING;var a=babelHelpers.classPrivateFieldGet(this,Nt).getRobotLog(this.getId());if(a){t=a.status}else if(babelHelpers.classPrivateFieldGet(this,At).DelayName){a=babelHelpers.classPrivateFieldGet(this,Nt).getRobotLog(babelHelpers.classPrivateFieldGet(this,At).DelayName);if(a&&a.status===qe.RUNNING){t=qe.RUNNING}}return t}},{key:"getLogErrors",value:function e(){var t=[];var a=babelHelpers.classPrivateFieldGet(this,Nt).getRobotLog(this.getId());if(a&&a.errors){t=a.errors}return t}},{key:"getDelayNotes",value:function e(){if(babelHelpers.classPrivateFieldGet(this,At).DelayName){var t=babelHelpers.classPrivateFieldGet(this,Nt).getRobotLog(babelHelpers.classPrivateFieldGet(this,At).DelayName);if(t&&t.status===qe.RUNNING){return t.notes}}return[]}},{key:"selectNode",value:function e(){if(babelHelpers.classPrivateFieldGet(this,kt)){r.Dom.addClass(babelHelpers.classPrivateFieldGet(this,kt),"--selected");this.emit("Robot:selected")}}},{key:"unselectNode",value:function e(){if(babelHelpers.classPrivateFieldGet(this,kt)){r.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,kt),"--selected");this.emit("Robot:unselected")}}},{key:"isSelected",value:function e(){return babelHelpers.classPrivateFieldGet(this,kt)&&r.Dom.hasClass(babelHelpers.classPrivateFieldGet(this,kt),"--selected")}},{key:"enableManageMode",value:function e(t){var a=this;babelHelpers.classPrivateFieldSet(this,wt,S.manage().setProperty("isActive",t));if(!t){r.Dom.addClass(babelHelpers.classPrivateFieldGet(this,kt),"--locked-node")}var i=babelHelpers.classPrivateFieldGet(this,kt).querySelector(".bizproc-automation-robot-btn-delete");r.Dom.hide(i);babelHelpers.classPrivateFieldGet(this,kt).onclick=function(){if(!babelHelpers.classPrivateFieldGet(a,wt).isManage()||!babelHelpers.classPrivateFieldGet(a,wt).getProperty("isActive",false)){return}if(!a.isSelected()){a.selectNode()}else{a.unselectNode()}}}},{key:"disableManageMode",value:function e(){babelHelpers.classPrivateFieldSet(this,wt,S.edit());this.unselectNode();r.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,kt),"--locked-node");var t=babelHelpers.classPrivateFieldGet(this,kt).querySelector(".bizproc-automation-robot-btn-delete");r.Dom.show(t);babelHelpers.classPrivateFieldGet(this,kt).onclick=undefined}},{key:"createNode",value:function e(){var t=this;var a="bizproc-automation-robot-container-wrapper";var i="bizproc-automation-robot-container";if(babelHelpers.classPrivateFieldGet(this,wt).isEdit()&&this.canEdit()){a+=" bizproc-automation-robot-container-wrapper-draggable"}var s=r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_TO");var l=r.Dom.create("a",{attrs:{className:"bizproc-automation-robot-settings-name",title:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_AUTOMATICALLY")},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_AUTOMATICALLY")});if(r.Type.isPlainObject(babelHelpers.classPrivateFieldGet(this,At).viewData)&&babelHelpers.classPrivateFieldGet(this,At).viewData.responsibleLabel){var n=babelHelpers.classPrivateFieldGet(this,At).viewData.responsibleLabel.replace("{=Document:ASSIGNED_BY_ID}",r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_RESPONSIBLE")).replace("author",r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_RESPONSIBLE")).replace(/\{=Constant\:Constant[0-9]+\}/,r.Loc.getMessage("BIZPROC_AUTOMATION_ASK_CONSTANT")).replace(/\{\{~&\:Constant[0-9]+\}\}/,r.Loc.getMessage("BIZPROC_AUTOMATION_ASK_CONSTANT")).replace(/\{=Template\:Parameter[0-9]+\}/,r.Loc.getMessage("BIZPROC_AUTOMATION_ASK_PARAMETER")).replace(/\{\{~&:\:Parameter[0-9]+\}\}/,r.Loc.getMessage("BIZPROC_AUTOMATION_ASK_PARAMETER"));if(n.indexOf("{=Document")>=0){babelHelpers.classPrivateFieldGet(this,_t).getFields().forEach((function(e){n=n.replace(e["SystemExpression"],e["Name"])}))}if(n.indexOf("{=A")>=0){babelHelpers.classPrivateFieldGet(this,Ft).robots.forEach((function(e){e.getReturnFieldsDescription().forEach((function(t){if(t["Type"]==="user"){n=n.replace(t["SystemExpression"],e.getTitle()+": "+t["Name"])}}))}))}l.textContent=n;l.setAttribute("title",n);if(babelHelpers.classPrivateFieldGet(this,At).viewData.responsibleUrl){l.href=babelHelpers.classPrivateFieldGet(this,At).viewData.responsibleUrl;if(babelHelpers.classPrivateFieldGet(this,Dt)){l.setAttribute("target","_blank")}}if(parseInt(babelHelpers.classPrivateFieldGet(this,At).viewData.responsibleId)>0){l.setAttribute("bx-tooltip-user-id",babelHelpers.classPrivateFieldGet(this,At).viewData.responsibleId)}}var o=this.getDelayInterval().format(r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_AT_ONCE"),babelHelpers.classPrivateFieldGet(this,_t).getFields());if(this.isExecuteAfterPrevious()){o=o!==r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_AT_ONCE")?o+", ":"";o+=r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_AFTER_PREVIOUS")}if(this.getCondition().items.length>0){o+=", "+r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_BY_CONDITION")}var c=r.Dom.create(babelHelpers.classPrivateFieldGet(this,wt).isEdit()?"a":"span",{attrs:{className:babelHelpers.classPrivateFieldGet(this,wt).isEdit()?"bizproc-automation-robot-link":"bizproc-automation-robot-text",title:o},text:o});var p=r.Dom.create("div",{attrs:{className:"bizproc-automation-robot-information"}});this.subscribeOnce("Robot:destroyed",(function(){if(V.isBindedToNode(p)){V.hideHint()}}));switch(this.getLogStatus()){case qe.RUNNING:if(babelHelpers.classPrivateFieldGet(this,_t).getCurrentStatusId()===babelHelpers.classPrivateFieldGet(this,Ft).getStatusId()){p.classList.add("--loader");var u=this.getDelayNotes();if(u.length){p.setAttribute("data-text",u.join("\n"));V.bindToNode(p)}}break;case qe.COMPLETED:case qe.AUTOCOMPLETED:i+=" --complete";p.classList.add("--complete");break}var b=this.getLogErrors();if(b.length>0){p.classList.add("--errors");p.setAttribute("data-text",b.join("\n"));V.bindToNode(p)}var d="bizproc-automation-robot-title-text";if(babelHelpers.classPrivateFieldGet(this,wt).isEdit()&&this.canEdit()){d+=" bizproc-automation-robot-title-text-editable"}var v=r.Dom.create("div",{attrs:{className:i,"data-role":"robot-container","data-type":"item-robot","data-id":this.getId()},children:[r.Dom.create("div",{props:{className:"bizproc-automation-robot-container-checkbox"}}),r.Dom.create("div",{attrs:{className:a},children:[r.Dom.create("div",{attrs:{className:"bizproc-automation-robot-deadline"},children:[c]}),r.Dom.create("div",{attrs:{className:"bizproc-automation-robot-title"},children:[r.Dom.create("div",{attrs:{className:d},html:this.clipTitle(this.getTitle()),events:{click:function e(a){if(babelHelpers.classPrivateFieldGet(t,wt).isEdit()&&t.canEdit()&&!babelHelpers.classPrivateFieldGet(t,wt).isManage()){t.onTitleEditClick(a)}}}})]}),r.Dom.create("div",{attrs:{className:"bizproc-automation-robot-settings"},children:[r.Dom.create("div",{attrs:{className:"bizproc-automation-robot-settings-title"},text:s+":"}),l]}),p]})]});if(this.canEdit()){this.registerItem(v)}if(babelHelpers.classPrivateFieldGet(this,wt).isEdit()){var h=r.Dom.create("SPAN",{attrs:{className:"bizproc-automation-robot-btn-delete"}});r.Event.bind(h,"click",this.onDeleteButtonClick.bind(this,h));v.lastChild.appendChild(h);var f=r.Dom.create("div",{attrs:{className:"bizproc-automation-robot-btn-copy"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_COPY")||"copy"});r.Event.bind(f,"click",this.onCopyButtonClick.bind(this,f));v.appendChild(f);var g=r.Dom.create("div",{attrs:{className:"bizproc-automation-robot-btn-settings"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_EDIT")});r.Event.bind(v,"click",this.onSettingsButtonClick.bind(this,v));v.appendChild(g)}return v}},{key:"onDeleteButtonClick",value:function e(t,a){a.stopPropagation();if(!this.canEdit()){V.showNoPermissionsHint(t)}else if(!babelHelpers.classPrivateFieldGet(this,wt).isManage()){r.Dom.remove(babelHelpers.classPrivateFieldGet(this,kt));babelHelpers.classPrivateFieldGet(this,Ft).deleteRobot(this)}}},{key:"onSettingsButtonClick",value:function e(t){if(!this.canEdit()){V.showNoPermissionsHint(t)}else if(!babelHelpers.classPrivateFieldGet(this,wt).isManage()){babelHelpers.classPrivateFieldGet(this,Ft).openRobotSettingsDialog(this)}}},{key:"onCopyButtonClick",value:function e(t,a){a.stopPropagation();if(!this.canEdit()){V.showNoPermissionsHint(t)}else if(!babelHelpers.classPrivateFieldGet(this,wt).isManage()){var i=this.clone();var s=i.getProperty("Title");if(!r.Type.isNil(s)){var l=s+" "+" "+r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_COPY_CAPTION");i.setProperty("Title",l);i.reInit()}aa.copyRobotTo(babelHelpers.classPrivateFieldGet(this,Ft),i,babelHelpers.classPrivateFieldGet(this,Ft).getNextRobot(this))}}},{key:"onTitleEditClick",value:function e(t){t.preventDefault();t.stopPropagation();var a="bizproc_automation_robot_title_dialog";var i=r.Dom.create("form",{props:{name:a},style:{"min-width":"540px"}});i.appendChild(r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_ROBOT_NAME")+":"}));i.appendChild(r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[BX.create("input",{attrs:{className:"bizproc-automation-popup-input",type:"text",name:"name",value:this.getTitle()}})]}));this.emit("Robot:title:editStart");var s=this;var l=new BX.PopupWindow(BX.Bizproc.Helper.generateUniqueId(),null,{titleBar:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_ROBOT_NAME"),content:i,closeIcon:true,offsetLeft:0,offsetTop:0,closeByEsc:true,draggable:{restrict:false},overlay:false,events:{onPopupClose:function e(t){t.destroy();s.emit("Robot:title:editCompleted")}},buttons:[new BX.PopupWindowButton({text:r.Loc.getMessage("JS_CORE_WINDOW_SAVE"),className:"popup-window-button-accept",events:{click:function e(){var t=i.elements.name;s.setProperty("Title",t.value);s.reInit();babelHelpers.classPrivateFieldGet(s,Ft).markModified();this.popupWindow.close()}}}),new BX.PopupWindowButtonLink({text:r.Loc.getMessage("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function e(){this.popupWindow.close()}}})]});l.show()}},{key:"onSearch",value:function e(t){if(!babelHelpers.classPrivateFieldGet(this,kt)){return}var a=t.getData().queryString;var i=!a||this.getTitle().toLowerCase().indexOf(a)>=0;if(i){r.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,kt),"--search-mismatch")}else{r.Dom.addClass(babelHelpers.classPrivateFieldGet(this,kt),"--search-mismatch")}}},{key:"clipTitle",value:function e(t){var a=r.Text.encode(t);var i=a.split(" ");var s="<span>"+i[i.length-1]+"</span>";i.splice(i.length-1);a=i.join(" ")+" "+s;return a}},{key:"updateData",value:function e(t){if(r.Type.isPlainObject(t)){babelHelpers.classPrivateFieldSet(this,At,t)}else{throw"Invalid data"}}},{key:"serialize",value:function e(){var t=BX.clone(babelHelpers.classPrivateFieldGet(this,At));delete t["viewData"];t.Delay=babelHelpers.classPrivateFieldGet(this,St).serialize();t.Condition=babelHelpers.classPrivateFieldGet(this,Gt).serialize();return t}},{key:"getDelayInterval",value:function e(){return babelHelpers.classPrivateFieldGet(this,St)}},{key:"setDelayInterval",value:function e(t){babelHelpers.classPrivateFieldSet(this,St,t);return this}},{key:"getCondition",value:function e(){return babelHelpers.classPrivateFieldGet(this,Gt)}},{key:"setCondition",value:function e(t){babelHelpers.classPrivateFieldSet(this,Gt,t);return this}},{key:"setExecuteAfterPrevious",value:function e(t){babelHelpers.classPrivateFieldGet(this,At).ExecuteAfterPrevious=t?1:0;return this}},{key:"isExecuteAfterPrevious",value:function e(){return babelHelpers.classPrivateFieldGet(this,At).ExecuteAfterPrevious===1||babelHelpers.classPrivateFieldGet(this,At).ExecuteAfterPrevious==="1"}},{key:"registerItem",value:function e(t){if(r.Type.isNil(t["__bxddid"])){t.onbxdragstart=BX.proxy(this.dragStart,this);t.onbxdrag=BX.proxy(this.dragMove,this);t.onbxdragstop=BX.proxy(this.dragStop,this);t.onbxdraghover=BX.proxy(this.dragOver,this);jsDD.registerObject(t);jsDD.registerDest(t,1)}}},{key:"unregisterItem",value:function e(t){t.onbxdragstart=undefined;t.onbxdrag=undefined;t.onbxdragstop=undefined;t.onbxdraghover=undefined;jsDD.unregisterObject(t);jsDD.unregisterDest(t)}},{key:"dragStart",value:function e(){this.draggableItem=BX.proxy_context;if(!this.draggableItem){jsDD.stopCurrentDrag();return}if(!this.stub){var t=this.draggableItem.offsetWidth;this.stub=this.draggableItem.cloneNode(true);this.stub.style.position="absolute";this.stub.classList.add("bizproc-automation-robot-container-drag");this.stub.style.width=t+"px";document.body.appendChild(this.stub)}}},{key:"dragMove",value:function e(t,a){this.stub.style.left=t+"px";this.stub.style.top=a+"px"}},{key:"dragOver",value:function e(t,a,i){if(this.droppableItem){this.droppableItem.classList.remove("bizproc-automation-robot-container-pre")}if(this.droppableColumn){this.droppableColumn.classList.remove("bizproc-automation-robot-list-pre")}var s=t.getAttribute("data-type");if(s==="item-robot"){this.droppableItem=t;this.droppableColumn=null}if(s==="column-robot"){this.droppableColumn=t.querySelector('[data-role="robot-list"]');this.droppableItem=null}if(this.droppableItem){this.droppableItem.classList.add("bizproc-automation-robot-container-pre")}if(this.droppableColumn){this.droppableColumn.classList.add("bizproc-automation-robot-list-pre")}}},{key:"dragStop",value:function e(t,a,i){i=i||window.event;var s=i&&(i.ctrlKey||i.metaKey);if(this.draggableItem){if(this.droppableItem){this.droppableItem.classList.remove("bizproc-automation-robot-container-pre");this.emit("Robot:manage",{templateNode:this.droppableItem.parentNode,isCopy:s,droppableItem:this.droppableItem,robot:this})}else if(this.droppableColumn){this.droppableColumn.classList.remove("bizproc-automation-robot-list-pre");this.emit("Robot:manage",{templateNode:this.droppableColumn,isCopy:s,robot:this})}}this.stub.parentNode.removeChild(this.stub);this.stub=null;this.draggableItem=null;this.droppableItem=null}},{key:"moveTo",value:function e(t,a){r.Dom.remove(babelHelpers.classPrivateFieldGet(this,kt));babelHelpers.classPrivateFieldGet(this,Ft).deleteRobot(this);babelHelpers.classPrivateFieldSet(this,Ft,t);babelHelpers.classPrivateFieldGet(this,Ft).insertRobot(this,a);babelHelpers.classPrivateFieldSet(this,kt,this.createNode());babelHelpers.classPrivateFieldGet(this,Ft).insertRobotNode(babelHelpers.classPrivateFieldGet(this,kt),a?a.node:null)}},{key:"copyTo",value:function e(a,i){var s=new t({document:babelHelpers.classPrivateFieldGet(this,_t),template:a,isFrameMode:babelHelpers.classPrivateFieldGet(this,Dt),tracker:babelHelpers.classPrivateFieldGet(this,Nt)});var r=this.serialize();delete r["Name"];delete r["DelayName"];s.init(r,babelHelpers.classPrivateFieldGet(this,wt));a.insertRobot(s,i);a.insertRobotNode(s.node,i?i.node:null);return s}},{key:"getTitle",value:function e(){return this.getProperty("Title")||this.getDescriptionTitle()}},{key:"getDescriptionTitle",value:function e(){var t="untitled";var a=this.template.getRobotDescription(babelHelpers.classPrivateFieldGet(this,At)["Type"]);if(a["NAME"]){t=a["NAME"]}if(a["ROBOT_SETTINGS"]&&a["ROBOT_SETTINGS"]["TITLE"]){t=a["ROBOT_SETTINGS"]["TITLE"]}return t}},{key:"hasTitle",value:function e(){return this.getTitle()!=="untitled"}},{key:"getReturnFieldsDescription",value:function e(){var t=this;var a=[];var i=this.template.getRobotDescription(babelHelpers.classPrivateFieldGet(this,At)["Type"]);if(i&&i["RETURN"]){for(var s in i["RETURN"]){if(i["RETURN"].hasOwnProperty(s)){var l=i["RETURN"][s];a.push({Id:s,ObjectId:this.getId(),ObjectName:this.getTitle(),Name:l["NAME"],Type:l["TYPE"],Expression:"{{~"+this.getId()+":"+s+" # "+this.getTitle()+": "+l["NAME"]+"}}",SystemExpression:"{="+this.getId()+":"+s+"}"});if(!this.appendPropertyMods){continue}if(l["TYPE"]==="user"||l["TYPE"]==="bool"||l["TYPE"]==="file"){var n=l["TYPE"]==="user"?"friendly":"printable";a.push({Id:s+"_printable",ObjectId:this.getId(),Name:l["NAME"]+" "+r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_MOD_PRINTABLE_PREFIX"),Type:"string",Expression:"{{~".concat(this.getId(),":").concat(s," > ").concat(n," # ").concat(this.getTitle(),": ").concat(l["NAME"],"}}"),SystemExpression:"{=".concat(this.getId(),":").concat(s,">").concat(n,"}")})}}}}if(i&&r.Type.isArray(i["ADDITIONAL_RESULT"])){var o=babelHelpers.classPrivateFieldGet(this,At)["Properties"];i["ADDITIONAL_RESULT"].forEach((function(e){if(o[e]){for(var i in o[e]){if(o[e].hasOwnProperty(i)){var s=o[e][i];a.push({Id:i,ObjectId:t.getId(),Name:s["Name"],Type:s["Type"],Options:s["Options"]||null,Expression:"{{~".concat(t.getId(),":").concat(i," # ").concat(t.getTitle(),": ").concat(s["Name"],"}}"),SystemExpression:"{="+t.getId()+":"+i+"}"});if(s["Type"]==="user"||s["Type"]==="bool"||s["Type"]==="file"){var l=s["Type"]==="user"?"friendly":"printable";var n="{{~".concat(t.getId(),":").concat(i," > ").concat(l," # ").concat(t.getTitle(),": ").concat(s["Name"],"}}");a.push({Id:i+"_printable",ObjectId:t.getId(),Name:s["Name"]+" "+r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_MOD_PRINTABLE_PREFIX"),Type:"string",Expression:n,SystemExpression:"{="+t.getId()+":"+i+">"+l+"}"})}}}}}))}return a}},{key:"getReturnProperty",value:function e(t){var a=this.getReturnFieldsDescription();for(var i=0;i<a.length;++i){if(a[i]["Id"]===t){return a[i]}}return null}},{key:"collectUsages",value:function e(){var t=this;var a=this.getProperties();var i={Document:new Set,Constant:new Set,Variable:new Set,Parameter:new Set,GlobalConstant:new Set,GlobalVariable:new Set,Activity:new Set};Object.values(a).forEach((function(e){return t.collectExpressions(e,i)}));var s=this.getCondition().serialize();s.items.forEach((function(e){return t.collectParsedExpressions(e[0],i)}));return i}},{key:"collectExpressions",value:function e(t,a){var i=this;if(r.Type.isArray(t)){t.forEach((function(e){return i.collectExpressions(e,a)}))}else if(r.Type.isPlainObject(t)){Object.values(t).forEach((function(e){return i.collectExpressions(e,a)}))}else if(r.Type.isStringFilled(t)){var s;var l=new RegExp(this.SYSTEM_EXPRESSION_PATTERN,"ig");while((s=l.exec(t))!==null){this.collectParsedExpressions(s.groups,a)}}}},{key:"collectParsedExpressions",value:function e(t,a){if(r.Type.isPlainObject(t)&&t["object"]&&t["field"]){switch(t["object"]){case"Document":a.Document.add(t["field"]);return;case"Constant":a.Constant.add(t["field"]);return;case"Variable":a.Variable.add(t["field"]);return;case"Template":a.Parameter.add(t["field"]);return;case"GlobalConst":a.GlobalConstant.add(t["field"]);return;case"GlobalVar":a.GlobalVariable.add(t["field"]);return}var i=new RegExp(/^A[_0-9]+$/,"ig");if(i.exec(t["object"])){a.Activity.add([t["object"],t["field"]])}}}},{key:"hasBrokenLink",value:function e(){var t=BX.clone(this.collectUsages());if(!this.template){return false}var a={Document:babelHelpers.classPrivateFieldGet(this,_t).getFields(),Constant:babelHelpers.classPrivateFieldGet(this,Ft).getConstants(),Variable:babelHelpers.classPrivateFieldGet(this,Ft).getVariables(),GlobalConstant:babelHelpers.classPrivateFieldGet(this,Ft).globalConstants,GlobalVariable:babelHelpers.classPrivateFieldGet(this,Ft).globalVariables,Parameter:babelHelpers.classPrivateFieldGet(this,Ft).getParameters(),Activity:babelHelpers.classPrivateFieldGet(this,Ft).getSerializedRobots()};for(var i in t){if(t[i].size>0){var s=new Set;for(var l in a[i]){if(a[i][l]["Id"]){s.add(a[i][l]["Id"])}else if(a[i][l]["Name"]){s.add(a[i][l]["Name"])}}var n=Pt(t[i].values()),o;try{for(n.s();!(o=n.n()).done;){var c=o.value;var p=c;var u=c;if(r.Type.isArray(p)){p=c[0];u=c[1]}if(!s.has(p)){return true}if(i==="Activity"){var b=babelHelpers.classPrivateFieldGet(this,Ft).getRobotById(p);if(!b.getReturnProperty(u)){return true}}}}catch(e){n.e(e)}finally{n.f()}}}return false}},{key:"node",get:function e(){return babelHelpers.classPrivateFieldGet(this,kt)}},{key:"data",get:function e(){return babelHelpers.classPrivateFieldGet(this,At)}},{key:"draft",get:function e(){return babelHelpers.classPrivateFieldGet(this,Mt)},set:function e(t){babelHelpers.classPrivateFieldSet(this,Mt,t)}},{key:"template",get:function e(){return babelHelpers.classPrivateFieldGet(this,Ft)}}],[{key:"generateName",value:function e(){return"A"+parseInt(Math.random()*1e5)+"_"+parseInt(Math.random()*1e5)+"_"+parseInt(Math.random()*1e5)+"_"+parseInt(Math.random()*1e5)}}]);return t}(a.EventEmitter);function Bt(e,t,a){Lt(e,t);t.set(e,a)}function Lt(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var xt=new WeakMap;var zt=function(){function e(t){babelHelpers.classCallCheck(this,e);Bt(this,xt,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,xt,t)}babelHelpers.createClass(e,[{key:"set",value:function e(t,a,i){if(!r.Type.isPlainObject(babelHelpers.classPrivateFieldGet(this,xt)[t])){babelHelpers.classPrivateFieldGet(this,xt)[t]={}}var s=babelHelpers.classPrivateFieldGet(this,xt)[t][a];if(s!==i){BX.userOptions.save("bizproc.automation",t,a,i,false)}return this}},{key:"get",value:function e(t,a,i){var s=i;if(this.has(t,a)){s=babelHelpers.classPrivateFieldGet(this,xt)[t][a]}return s}},{key:"has",value:function e(t,a){return r.Type.isPlainObject(babelHelpers.classPrivateFieldGet(this,xt)[t])&&r.Type.isPlainObject(babelHelpers.classPrivateFieldGet(this,xt)[t][a])}}]);return e}();function Ut(e,t,a){Yt(e,t);t.set(e,a)}function Yt(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var Wt=new WeakMap;var jt=new WeakMap;var Zt=new WeakMap;var Xt=new WeakMap;var Vt=new WeakMap;var Kt=new WeakMap;var qt=new WeakMap;var Jt=new WeakMap;var $t=new WeakMap;var Qt=new WeakMap;var ea=new WeakMap;var ta=new WeakMap;var aa=function(e){babelHelpers.inherits(a,e);function a(e){var t;babelHelpers.classCallCheck(this,a);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(a).call(this));Ut(babelHelpers.assertThisInitialized(t),Wt,{writable:true,value:void 0});Ut(babelHelpers.assertThisInitialized(t),jt,{writable:true,value:void 0});Ut(babelHelpers.assertThisInitialized(t),Zt,{writable:true,value:void 0});Ut(babelHelpers.assertThisInitialized(t),Xt,{writable:true,value:void 0});Ut(babelHelpers.assertThisInitialized(t),Vt,{writable:true,value:void 0});Ut(babelHelpers.assertThisInitialized(t),Kt,{writable:true,value:void 0});Ut(babelHelpers.assertThisInitialized(t),qt,{writable:true,value:void 0});Ut(babelHelpers.assertThisInitialized(t),Jt,{writable:true,value:void 0});Ut(babelHelpers.assertThisInitialized(t),$t,{writable:true,value:void 0});Ut(babelHelpers.assertThisInitialized(t),Qt,{writable:true,value:void 0});Ut(babelHelpers.assertThisInitialized(t),ea,{writable:true,value:void 0});Ut(babelHelpers.assertThisInitialized(t),ta,{writable:true,value:void 0});t.setEventNamespace("BX.Bizproc.Automation");t.constants=e.constants;t.globalConstants=e.globalConstants;t.variables=e.variables;t.globalVariables=e.globalVariables;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),Kt,e.templateContainerNode);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),Wt,e.selectors);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),jt,e.delayMinLimitM);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),Zt,e.userOptions);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),Xt,i.getGlobalContext().tracker);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),ta,{});babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),ea,[]);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),Vt,S.none());return t}babelHelpers.createClass(a,[{key:"init",value:function e(t,a){if(r.Type.isPlainObject(t)){babelHelpers.classPrivateFieldSet(this,ta,t);if(!r.Type.isPlainObject(babelHelpers.classPrivateFieldGet(this,ta).CONSTANTS)){babelHelpers.classPrivateFieldGet(this,ta).CONSTANTS={}}if(!r.Type.isPlainObject(babelHelpers.classPrivateFieldGet(this,ta).PARAMETERS)){babelHelpers.classPrivateFieldGet(this,ta).PARAMETERS={}}if(!r.Type.isPlainObject(babelHelpers.classPrivateFieldGet(this,ta).VARIABLES)){babelHelpers.classPrivateFieldGet(this,ta).VARIABLES={}}this.markExternalModified(babelHelpers.classPrivateFieldGet(this,ta)["IS_EXTERNAL_MODIFIED"]);this.markModified(false)}babelHelpers.classPrivateFieldSet(this,Vt,S.fromRaw(a));if(!babelHelpers.classPrivateFieldGet(this,Vt).isNone()){babelHelpers.classPrivateFieldSet(this,qt,babelHelpers.classPrivateFieldGet(this,Kt).querySelector('[data-role="automation-template"][data-status-id="'+babelHelpers.classPrivateFieldGet(this,ta).DOCUMENT_STATUS+'"]'));babelHelpers.classPrivateFieldSet(this,Jt,babelHelpers.classPrivateFieldGet(this,qt).querySelector('[data-role="robot-list"]'));babelHelpers.classPrivateFieldSet(this,$t,babelHelpers.classPrivateFieldGet(this,qt).querySelector('[data-role="buttons"]'));babelHelpers.classPrivateFieldSet(this,Qt,babelHelpers.classPrivateFieldGet(this,qt).querySelector('[data-role="top-buttons"]'));this.initRobots();this.initButtons();this.updateTopButtonsVisibility();if(!this.isExternalModified()&&this.canEdit()){jsDD.registerDest(babelHelpers.classPrivateFieldGet(this,qt),10)}else{jsDD.unregisterDest(babelHelpers.classPrivateFieldGet(this,qt))}}}},{key:"reInit",value:function e(t,a){r.Dom.clean(babelHelpers.classPrivateFieldGet(this,Jt));r.Dom.clean(babelHelpers.classPrivateFieldGet(this,$t));r.Dom.clean(babelHelpers.classPrivateFieldGet(this,Qt));this.destroy();this.init(t,a)}},{key:"destroy",value:function e(){babelHelpers.classPrivateFieldGet(this,ea).forEach((function(e){return e.destroy()}))}},{key:"canEdit",value:function e(){return i.getGlobalContext().canEdit}},{key:"initRobots",value:function e(){babelHelpers.classPrivateFieldSet(this,ea,[]);if(r.Type.isArray(babelHelpers.classPrivateFieldGet(this,ta).ROBOTS)){for(var t=0;t<babelHelpers.classPrivateFieldGet(this,ta).ROBOTS.length;++t){var a=new Rt({document:i.getGlobalContext().document,template:this,isFrameMode:i.getGlobalContext().get("isFrameMode"),tracker:babelHelpers.classPrivateFieldGet(this,Xt)});a.init(babelHelpers.classPrivateFieldGet(this,ta).ROBOTS[t],babelHelpers.classPrivateFieldGet(this,Vt));this.insertRobotNode(a.node);babelHelpers.classPrivateFieldGet(this,ea).push(a)}}}},{key:"getSelectedRobotNames",value:function e(){var t=[];babelHelpers.classPrivateFieldGet(this,ea).forEach((function(e){if(e.isSelected()){t.push(e.data.Name)}}));return t}},{key:"getSerializedRobots",value:function e(){var t=[];babelHelpers.classPrivateFieldGet(this,ea).forEach((function(e){return t.push(e.serialize())}));return t}},{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,ta).ID}},{key:"getStatusId",value:function e(){return babelHelpers.classPrivateFieldGet(this,ta).DOCUMENT_STATUS}},{key:"getTemplateId",value:function e(){var t=parseInt(babelHelpers.classPrivateFieldGet(this,ta).ID);return!isNaN(t)?t:0}},{key:"initButtons",value:function e(){if(this.isExternalModified()){this.createExternalLocker()}else if(babelHelpers.classPrivateFieldGet(this,Vt).isEdit()){this.createAddButton();if(this.getTemplateId()>0){this.createConstantsEditButton();this.createParametersEditButton();this.createExternalEditTemplateButton();this.createManageModeButton()}}}},{key:"enableManageMode",value:function e(t){if(babelHelpers.classPrivateFieldGet(this,Jt)){babelHelpers.classPrivateFieldSet(this,Vt,S.manage().setProperty("isActive",t));if(t){r.Dom.addClass(babelHelpers.classPrivateFieldGet(this,Jt),"--multiselect-mode")}if(this.isExternalModified()){r.Dom.addClass(babelHelpers.classPrivateFieldGet(this,Jt),"--locked-node")}else{babelHelpers.classPrivateFieldGet(this,ea).forEach((function(e){return e.enableManageMode(t)}))}}}},{key:"disableManageMode",value:function e(){if(babelHelpers.classPrivateFieldGet(this,Jt)){babelHelpers.classPrivateFieldSet(this,Vt,S.edit());r.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,Jt),"--multiselect-mode");if(this.isExternalModified()){r.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,Jt),"--locked-node")}else{babelHelpers.classPrivateFieldGet(this,ea).forEach((function(e){return e.disableManageMode()}))}babelHelpers.classPrivateFieldGet(this,qt).querySelectorAll(".bizproc-automation-robot-container-wrapper").forEach((function(e){r.Dom.addClass(e,"bizproc-automation-robot-container-wrapper-draggable")}))}}},{key:"enableDragAndDrop",value:function e(){babelHelpers.classPrivateFieldGet(this,ea).forEach((function(e){return e.registerItem(e.node)}));babelHelpers.classPrivateFieldGet(this,qt).querySelectorAll(".bizproc-automation-robot-container-wrapper").forEach((function(e){r.Dom.addClass(e,"bizproc-automation-robot-container-wrapper-draggable")}))}},{key:"disableDragAndDrop",value:function e(){babelHelpers.classPrivateFieldGet(this,ea).forEach((function(e){return e.unregisterItem(e.node)}));babelHelpers.classPrivateFieldGet(this,qt).querySelectorAll(".bizproc-automation-robot-container-wrapper").forEach((function(e){r.Dom.removeClass(e,"bizproc-automation-robot-container-wrapper-draggable")}))}},{key:"createAddButton",value:function e(){var t=this;var a=function e(){return r.Dom.create("span",{events:{click:function e(a){if(!t.canEdit()){V.showNoPermissionsHint(a.target)}else if(!babelHelpers.classPrivateFieldGet(t,Vt).isManage()){t.onAddButtonClick(a.target)}}},attrs:{className:"bizproc-automation-robot-btn-add"},children:[r.Dom.create("span",{attrs:{className:"bizproc-automation-btn-add-text"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_ADD")})]})};if(babelHelpers.classPrivateFieldGet(this,Qt)){babelHelpers.classPrivateFieldGet(this,Qt).appendChild(a())}if(babelHelpers.classPrivateFieldGet(this,$t)){babelHelpers.classPrivateFieldGet(this,$t).appendChild(a())}}},{key:"updateTopButtonsVisibility",value:function e(){if(babelHelpers.classPrivateFieldGet(this,Qt)){var t=babelHelpers.classPrivateFieldGet(this,ea)&&babelHelpers.classPrivateFieldGet(this,ea).length<1?"hide":"show";if(this.isExternalModified()){t="show"}BX[t](babelHelpers.classPrivateFieldGet(this,Qt))}}},{key:"createExternalEditTemplateButton",value:function e(){if(r.Type.isNil(i.getGlobalContext().bizprocEditorUrl)){return false}var t=this;var a=r.Dom.create("a",{text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_EXTERNAL_EDIT"),props:{href:"#"},events:{click:function e(a){a.preventDefault();if(!babelHelpers.classPrivateFieldGet(t,Vt).isManage()){t.onExternalEditTemplateButtonClick(this)}}},attrs:{className:"bizproc-automation-robot-btn-set",target:"_top"}});if(!i.getGlobalContext().bizprocEditorUrl.length){r.Dom.addClass(a,"bizproc-automation-robot-btn-set-locked")}babelHelpers.classPrivateFieldGet(this,$t).appendChild(a)}},{key:"createManageModeButton",value:function e(){var t=this;if(!i.getGlobalContext().canManage){return}var a=r.Dom.create("a",{text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_MANAGE_ROBOTS"),attrs:{className:"bizproc-automation-robot-btn-set",target:"_top"},style:{cursor:"pointer"},events:{click:function e(i){i.preventDefault();t.onManageModeButtonClick(a)}}});babelHelpers.classPrivateFieldGet(this,$t).appendChild(a)}},{key:"onManageModeButtonClick",value:function e(t){if(!this.canEdit()){V.showNoPermissionsHint(t)}else{this.emit("Template:enableManageMode",{documentStatus:babelHelpers.classPrivateFieldGet(this,ta).DOCUMENT_STATUS})}}},{key:"createConstantsEditButton",value:function e(){if(r.Type.isNil(i.getGlobalContext().constantsEditorUrl)){return false}var t=!babelHelpers.classPrivateFieldGet(this,Vt).isManage()?i.getGlobalContext().constantsEditorUrl.replace("#ID#",this.getTemplateId()):"#";if(!t.length){return false}var a=r.Dom.create("a",{text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_CONSTANTS_EDIT"),props:{href:t},attrs:{className:"bizproc-automation-robot-btn-set"}});babelHelpers.classPrivateFieldGet(this,$t).appendChild(a)}},{key:"createParametersEditButton",value:function e(){if(r.Type.isNil(i.getGlobalContext().parametersEditorUrl)){return false}var t=i.getGlobalContext().parametersEditorUrl.replace("#ID#",this.getTemplateId());if(!t.length||babelHelpers.classPrivateFieldGet(this,Vt).isManage()){return false}var a=r.Dom.create("a",{text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_PARAMETERS_EDIT"),props:{href:t},attrs:{className:"bizproc-automation-robot-btn-set"}});babelHelpers.classPrivateFieldGet(this,$t).appendChild(a)}},{key:"createExternalLocker",value:function e(){if(babelHelpers.classPrivateFieldGet(this,Qt)){babelHelpers.classPrivateFieldGet(this,Qt).appendChild(r.Dom.create("span",{attrs:{className:"bizproc-automation-robot-btn-prohibit"}}))}var t=r.Dom.create("div",{attrs:{className:"bizproc-automation-robot-container"},children:[r.Dom.create("div",{attrs:{className:"bizproc-automation-robot-container-wrapper bizproc-automation-robot-container-wrapper-lock"},children:[r.Dom.create("div",{attrs:{className:"bizproc-automation-robot-deadline"}}),r.Dom.create("div",{attrs:{className:"bizproc-automation-robot-title"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_EXTERNAL_EDIT_TEXT")})]})]});if(babelHelpers.classPrivateFieldGet(this,Vt).isEdit()){var a=r.Dom.create("div",{attrs:{className:"bizproc-automation-robot-btn-settings"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_EDIT")});var i=this;r.Event.bind(t,"click",(function(e){e.stopPropagation();if(!babelHelpers.classPrivateFieldGet(i,Vt).isManage()){i.onExternalEditTemplateButtonClick(this)}}));t.appendChild(a);var s=r.Dom.create("SPAN",{attrs:{className:"bizproc-automation-robot-btn-delete"}});r.Event.bind(s,"click",(function(e){e.stopPropagation();if(!babelHelpers.classPrivateFieldGet(i,Vt).isManage()){i.onUnsetExternalModifiedClick(this)}}));t.lastChild.appendChild(s)}babelHelpers.classPrivateFieldGet(this,Jt).appendChild(t);babelHelpers.classPrivateFieldSet(this,qt,t)}},{key:"onSearch",value:function e(t){if(this.isExternalModified()){this.onExternalModifiedSearch(t)}else{babelHelpers.classPrivateFieldGet(this,ea).forEach((function(e){return e.onSearch(t)}))}}},{key:"onExternalModifiedSearch",value:function e(t){if(babelHelpers.classPrivateFieldGet(this,qt)){var a=t.getData().queryString;BX[!a?"removeClass":"addClass"](babelHelpers.classPrivateFieldGet(this,qt),"--search-mismatch")}}},{key:"onAddButtonClick",value:function e(a,s){var l={employee:[],client:[],ads:[],other:[]};var n=i.getGlobalContext().availableRobots;if(!r.Type.isPlainObject(s)){s={}}var o=this;var c=function e(t,a){var i=BX.clone(a.robotData);if(i["ROBOT_SETTINGS"]&&i["ROBOT_SETTINGS"]["TITLE_CATEGORY"]&&i["ROBOT_SETTINGS"]["TITLE_CATEGORY"][a.category]){i["NAME"]=i["ROBOT_SETTINGS"]["TITLE_CATEGORY"][a.category]}else if(i["ROBOT_SETTINGS"]&&i["ROBOT_SETTINGS"]["TITLE"]){i["NAME"]=i["ROBOT_SETTINGS"]["TITLE"]}o.addRobot(i,(function(e){s.ADD_MENU_CATEGORY=a.category;this.openRobotSettingsDialog(e,s)}));this.getRootMenuWindow().close()};for(var p=0;p<n.length;++p){if(n[p]["EXCLUDED"]){continue}var u=r.Type.isPlainObject(n[p]["ROBOT_SETTINGS"])?n[p]["ROBOT_SETTINGS"]:{};var b=n[p].NAME;if(u["TITLE"]){b=u["TITLE"]}var d=[];if(u["CATEGORY"]){d=r.Type.isArray(u["CATEGORY"])?u["CATEGORY"]:[u["CATEGORY"]]}if(!d.length){d.push("other")}for(var v=0;v<d.length;++v){if(!l[d[v]]){continue}l[d[v]].push({text:b,robotData:n[p],category:d[v],onclick:c})}}if(l["other"].length>0){l["other"].push({delimiter:true})}if(r.Reflection.getClass("BX.rest.Marketplace")){l["other"].push({text:r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CATEGORY_OTHER_MARKETPLACE_2"),onclick:function e(){BX.rest.Marketplace.open({},i.getGlobalContext().get("marketplaceRobotCategory"));this.getRootMenuWindow().close()}})}else{l["other"].push({text:r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CATEGORY_OTHER_MARKETPLACE_2"),href:"/marketplace/category/%category%/".replace("%category%",i.getGlobalContext().get("marketplaceRobotCategory")),target:"_blank"})}var h=a.getAttribute("data-menu-id");if(!h){h=se.generateUniqueId();a.setAttribute("data-menu-id",h)}var f=[];if(l["employee"].length>0){f.push({text:r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CATEGORY_EMPLOYEE"),items:l["employee"]})}if(l["client"].length>0){f.push({text:r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CATEGORY_CLIENT"),items:l["client"]})}if(l["ads"].length>0){f.push({text:r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CATEGORY_ADS"),items:l["ads"]})}f.push({text:r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CATEGORY_OTHER"),items:l["other"]});t.MenuManager.show(h,a,f,{autoHide:true,offsetLeft:BX.pos(a)["width"]/2,angle:{position:"top",offset:0},maxHeight:550})}},{key:"onChangeRobotClick",value:function e(t){this.onAddButtonClick(t.target,{changeRobot:true})}},{key:"onExternalEditTemplateButtonClick",value:function e(t){if(!this.canEdit()){V.showNoPermissionsHint(t);return}if(!i.getGlobalContext().bizprocEditorUrl.length){if(top.BX.UI&&top.BX.UI.InfoHelper){top.BX.UI.InfoHelper.show("limit_office_bp_designer")}return}var a=this.getTemplateId();if(a>0){this.openBizprocEditor(a)}}},{key:"onUnsetExternalModifiedClick",value:function e(t){babelHelpers.classPrivateFieldSet(this,qt,null);this.markExternalModified(false);this.markModified();this.reInit(null,babelHelpers.classPrivateFieldGet(this,Vt).intoRaw())}},{key:"openBizprocEditor",value:function e(t){top.window.location.href=i.getGlobalContext().bizprocEditorUrl.replace("#ID#",t)}},{key:"addRobot",value:function e(t,a){var s=new Rt({document:i.getGlobalContext().document,template:this,isFrameMode:i.getGlobalContext().get("isFrameMode"),tracker:babelHelpers.classPrivateFieldGet(this,Xt)});var r={Type:t["CLASS"],Properties:{Title:t["NAME"]}};if(babelHelpers.classPrivateFieldGet(this,ea).length>0){var l=babelHelpers.classPrivateFieldGet(this,ea)[babelHelpers.classPrivateFieldGet(this,ea).length-1];if(!l.getDelayInterval().isNow()||l.isExecuteAfterPrevious()){r["Delay"]=l.getDelayInterval().serialize();r["ExecuteAfterPrevious"]=1}}s.init(r,babelHelpers.classPrivateFieldGet(this,Vt));s.draft=true;if(a){a.call(this,s)}}},{key:"insertRobot",value:function e(t,a){if(a){for(var i=0;i<babelHelpers.classPrivateFieldGet(this,ea).length;++i){if(babelHelpers.classPrivateFieldGet(this,ea)[i]!==a){continue}babelHelpers.classPrivateFieldGet(this,ea).splice(i,0,t);break}}else{babelHelpers.classPrivateFieldGet(this,ea).push(t)}this.markModified()}},{key:"getNextRobot",value:function e(t){for(var a=0;a<babelHelpers.classPrivateFieldGet(this,ea).length;++a){if(babelHelpers.classPrivateFieldGet(this,ea)[a]===t){return babelHelpers.classPrivateFieldGet(this,ea)[a+1]||null}}return null}},{key:"deleteRobot",value:function e(t,a){for(var i=0;i<babelHelpers.classPrivateFieldGet(this,ea).length;++i){if(babelHelpers.classPrivateFieldGet(this,ea)[i].isEqual(t)){babelHelpers.classPrivateFieldGet(this,ea).splice(i,1);break}}if(a){a(t)}this.markModified();this.updateTopButtonsVisibility()}},{key:"insertRobotNode",value:function e(t,a){if(a){babelHelpers.classPrivateFieldGet(this,Jt).insertBefore(t,a)}else{babelHelpers.classPrivateFieldGet(this,Jt).appendChild(t)}this.updateTopButtonsVisibility()}},{key:"openRobotSettingsDialog",value:function e(t,a,s){var l=this;if(!r.Type.isPlainObject(a)){a={}}if(i.Designer.getInstance().getRobotSettingsDialog()){if(a.changeRobot){i.Designer.getInstance().getRobotSettingsDialog().popup.close()}else{return}}var n="bizproc_automation_robot_dialog";var o=r.Dom.create("form",{props:{name:n}});i.Designer.getInstance().setRobotSettingsDialog({template:this,context:a,robot:t,form:o});o.appendChild(this.renderDelaySettings(t));o.appendChild(this.renderConditionSettings(t));if(t.hasBrokenLink()){o.appendChild(this.renderBrokenLinkAlert())}var c=r.Dom.create("div",{attrs:{className:"bizproc-automation-robot-help"},events:{click:function e(t){return l.emit("Template:help:show",t)}}});o.appendChild(c);a["DOCUMENT_CATEGORY_ID"]=i.getGlobalContext().document.getCategoryId();BX.ajax({method:"POST",dataType:"html",url:i.getGlobalContext().ajaxUrl,data:{ajax_action:"get_robot_dialog",document_signed:i.getGlobalContext().signedDocument,document_status:i.getGlobalContext().document.getCurrentStatusId(),context:a,robot_json:se.toJsonString(t.serialize()),form_name:n},onsuccess:function e(a){if(a){var i=r.Dom.create("div",{html:a});o.appendChild(i)}l.showRobotSettingsPopup(t,o,s)}})}},{key:"showRobotSettingsPopup",value:function e(t,a,s){var l=this;var n=580;var o=n;if(babelHelpers.classPrivateFieldGet(this,Zt)){this.emit("Template:robot:showSettings");o=parseInt(babelHelpers.classPrivateFieldGet(this,Zt).get("defaults","robot_settings_popup_width",580))}this.initRobotSettingsControls(t,a);if(t.data.Type==="CrmSendEmailActivity"||t.data.Type==="MailActivity"||t.data.Type==="RpaApproveActivity"){n+=170;if(o<n){o=n}}var c;var p=t.hasTitle()?t.getTitle():r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_SETTINGS_TITLE");if(t.draft){c=this.createChangeRobotTitleBar(p)}var u=this;var b=new BX.PopupWindow(se.generateUniqueId(),null,{titleBar:c||p,content:a,closeIcon:true,width:o,resizable:{minWidth:n,minHeight:100},offsetLeft:0,offsetTop:0,closeByEsc:true,draggable:{restrict:false},events:{onPopupClose:function e(t){l.currentRobot=null;i.Designer.getInstance().setRobotSettingsDialog(null);l.destroyRobotSettingsControls();t.destroy();l.emit("Template:robot:closeSettings")},onPopupResize:function e(){l.onResizeRobotSettings()},onPopupResizeEnd:function e(){if(babelHelpers.classPrivateFieldGet(u,Zt)){babelHelpers.classPrivateFieldGet(u,Zt).set("defaults","robot_settings_popup_width",this.getWidth())}}},buttons:[new BX.PopupWindowButton({text:r.Loc.getMessage("JS_CORE_WINDOW_SAVE"),className:"popup-window-button-accept",events:{click:function e(){u.saveRobotSettings(a,t,BX.delegate((function(){this.popupWindow.close();u.emit("Template:robot:add",{robot:t});if(s){s(t)}}),this),this.buttonNode)}}}),new BX.PopupWindowButtonLink({text:r.Loc.getMessage("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function e(){this.popupWindow.close()}}})]});this.currentRobot=t;i.Designer.getInstance().getRobotSettingsDialog().popup=b;b.show()}},{key:"createChangeRobotTitleBar",value:function e(t){return{content:BX.Dom.create("div",{props:{className:"popup-window-titlebar-text bizproc-automation-popup-titlebar-with-link"},children:[document.createTextNode(t),r.Dom.create("span",{props:{className:"bizproc-automation-popup-titlebar-link"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_CHANGE_ROBOT"),events:{click:this.onChangeRobotClick.bind(this)}})]})}}},{key:"initRobotSettingsControls",value:function e(t,a){if(!r.Type.isArray(this.robotSettingsControls)){this.robotSettingsControls=[]}var i=a.querySelectorAll("[data-role]");for(var s=0;s<i.length;++s){this.initRobotSettingsControl(t,i[s])}}},{key:"initRobotSettingsControl",value:function e(t,a){if(!r.Type.isArray(this.robotSettingsControls)){this.robotSettingsControls=[]}var i=null;var s=a.getAttribute("data-role");if(s==="user-selector"){i=new(babelHelpers.classPrivateFieldGet(this,Wt).userSelector)(t,a,babelHelpers.classPrivateFieldGet(this,ta))}else if(s==="file-selector"){i=new(babelHelpers.classPrivateFieldGet(this,Wt).fileSelector)(t,a)}else if(s==="inline-selector-target"){i=new(babelHelpers.classPrivateFieldGet(this,Wt).inlineSelector)(t,a,babelHelpers.classPrivateFieldGet(this,ta))}else if(s==="inline-selector-html"){i=new(babelHelpers.classPrivateFieldGet(this,Wt).inlineSelectorHtml)(t,a)}else if(s==="time-selector"){i=new(babelHelpers.classPrivateFieldGet(this,Wt).timeSelector)(a)}else if(s==="save-state-checkbox"){i=new(babelHelpers.classPrivateFieldGet(this,Wt).saveStateCheckbox)(a,t)}BX.UI.Hint.init(a);if(i){this.robotSettingsControls.push(i)}}},{key:"destroyRobotSettingsControls",value:function e(){if(this.conditionSelector){this.conditionSelector.destroy();this.conditionSelector=null}if(r.Type.isArray(this.robotSettingsControls)){for(var t=0;t<this.robotSettingsControls.length;++t){if(r.Type.isFunction(this.robotSettingsControls[t].destroy)){this.robotSettingsControls[t].destroy()}}}this.robotSettingsControls=null}},{key:"onBeforeSaveRobotSettings",value:function e(){if(r.Type.isArray(this.robotSettingsControls)){for(var t=0;t<this.robotSettingsControls.length;++t){if(r.Type.isFunction(this.robotSettingsControls[t].onBeforeSave)){this.robotSettingsControls[t].onBeforeSave()}}}}},{key:"onResizeRobotSettings",value:function e(){if(r.Type.isArray(this.robotSettingsControls)){for(var t=0;t<this.robotSettingsControls.length;++t){if(r.Type.isFunction(this.robotSettingsControls[t].onPopupResize)){this.robotSettingsControls[t].onPopupResize()}}}}},{key:"renderDelaySettings",value:function e(t){var a=t.getDelayInterval().clone();var s=se.generateUniqueId();var l=r.Dom.create("input",{attrs:{type:"hidden",name:"delay_type",value:a.type}});var n=r.Dom.create("input",{attrs:{type:"hidden",name:"delay_value",value:a.value}});var o=r.Dom.create("input",{attrs:{type:"hidden",name:"delay_value_type",value:a.valueType}});var c=r.Dom.create("input",{attrs:{type:"hidden",name:"delay_basis",value:a.basis}});var p=r.Dom.create("input",{attrs:{type:"hidden",name:"delay_worktime",value:a.workTime?1:0}});var u=r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-delay-interval-basis"}});var b=[];var d=i.getGlobalContext().document.getFields();var v=babelHelpers.classPrivateFieldGet(this,jt);if(r.Type.isArray(d)){for(var h=0;h<d.length;++h){var f=d[h];if(f["Type"]=="date"||f["Type"]=="datetime"){b.push(f)}}}var g=new i.DelayIntervalSelector({labelNode:u,onchange:function e(t){l.value=t.type;n.value=t.value;o.value=t.valueType;c.value=t.basis;p.value=t.workTime?1:0},basisFields:b,minLimitM:v,useAfterBasis:true});var m=null;if(t.hasTemplate()){var T=r.Dom.create("input",{attrs:{type:"checkbox",id:"param-group-3-1"+s,name:"execute_after_previous",value:"1",style:"vertical-align: middle"}});if(t.isExecuteAfterPrevious()){T.setAttribute("checked","checked")}m=r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings-block"},children:[T,r.Dom.create("label",{attrs:{for:"param-group-3-1"+s,style:"color: #535C69"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_AFTER_PREVIOUS_WIDE")})]})}var P=r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings bizproc-automation-popup-settings-flex"},children:[r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings-block bizproc-automation-popup-settings-block-flex"},children:[r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title-wrapper"},children:[l,n,o,c,p,r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-left"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_TO_EXECUTE")+":"}),u]})]}),m]});g.init(a);return P}},{key:"setDelaySettingsFromForm",value:function e(t,a){var i=new Ye;i.setType(t["delay_type"]);i.setValue(t["delay_value"]);i.setValueType(t["delay_value_type"]);i.setBasis(t["delay_basis"]);i.setWorkTime(t["delay_worktime"]==="1");a.setDelayInterval(i);if(a.hasTemplate()){a.setExecuteAfterPrevious(t["execute_after_previous"]&&t["execute_after_previous"]==="1")}return this}},{key:"renderConditionSettings",value:function e(t){var a=t.getCondition();var s=this.conditionSelector=new i.ConditionGroupSelector(a,{fields:i.getGlobalContext().document.getFields()});return r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings-block"},children:[r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION")+":"}),s.createNode()]})]})}},{key:"setConditionSettingsFromForm",value:function e(t,a){a.setCondition(i.ConditionGroup.createFromForm(t));return this}},{key:"renderBrokenLinkAlert",value:function e(){var t=r.Dom.create("div",{attrs:{className:"ui-alert ui-alert-warning ui-alert-icon-info ui-alert-xs"}});var a=r.Dom.create("span",{attrs:{className:"ui-alert-message"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_BROKEN_LINK_MESSAGE_ERROR")});t.appendChild(a);t.appendChild(r.Dom.create("span",{attrs:{className:"ui-alert-close-btn"},events:{click:function e(){t.style.display="none"}}}));return t}},{key:"saveRobotSettings",value:function e(t,a,s,r){var l=this;if(r){r.classList.add("popup-window-button-wait")}this.onBeforeSaveRobotSettings();var n=BX.ajax.prepareForm(t);var o=i.getGlobalContext().ajaxUrl;var c=i.getGlobalContext().signedDocument;BX.ajax({method:"POST",dataType:"json",url:o,data:{ajax_action:"save_robot_settings",document_signed:c,robot_json:se.toJsonString(a.serialize()),form_data_json:se.toJsonString(n["data"]),form_data:n["data"]},onsuccess:function e(t){if(r){r.classList.remove("popup-window-button-wait")}if(t.SUCCESS){a.updateData(t.DATA.robot);l.setDelaySettingsFromForm(n["data"],a);l.setConditionSettingsFromForm(n["data"],a);if(a.draft){babelHelpers.classPrivateFieldGet(l,ea).push(a);l.insertRobotNode(a.node)}a.draft=false;a.reInit();l.markModified();if(s){s(t.DATA)}}else{alert(t.ERRORS[0])}}})}},{key:"serialize",value:function e(){var t=BX.clone(babelHelpers.classPrivateFieldGet(this,ta));t["IS_EXTERNAL_MODIFIED"]=this.isExternalModified()?1:0;t["ROBOTS"]=[];for(var a=0;a<babelHelpers.classPrivateFieldGet(this,ea).length;++a){t["ROBOTS"].push(babelHelpers.classPrivateFieldGet(this,ea)[a].serialize())}return t}},{key:"isExternalModified",value:function e(){return this.externalModified===true}},{key:"markExternalModified",value:function e(t){this.externalModified=t!==false}},{key:"getRobotById",value:function e(t){return babelHelpers.classPrivateFieldGet(this,ea).find((function(e){return e.getId()===t}))}},{key:"isModified",value:function e(){return this.modified}},{key:"markModified",value:function e(t){this.modified=t!==false;if(this.modified){this.emit("Template:modified")}}},{key:"getConstants",value:function e(){var t=this;var a=[];Object.keys(babelHelpers.classPrivateFieldGet(this,ta).CONSTANTS).forEach((function(e){var i=BX.clone(babelHelpers.classPrivateFieldGet(t,ta).CONSTANTS[e]);i.Id=e;i.ObjectId="Constant";i.SystemExpression="{=Constant:"+e+"}";i.Expression="{{~&:"+e+"}}";a.push(i)}));return a}},{key:"getConstant",value:function e(t){var a=this.getConstants();for(var i=0;i<a.length;++i){if(a[i].Id===t){return a[i]}}return null}},{key:"addConstant",value:function e(t){var a=t.Id||this.generatePropertyId("Constant",babelHelpers.classPrivateFieldGet(this,ta).CONSTANTS);if(babelHelpers.classPrivateFieldGet(this,ta).CONSTANTS[a]){throw'Constant with id "'.concat(a,'" is already exists')}babelHelpers.classPrivateFieldGet(this,ta).CONSTANTS[a]=t;this.emit("Template:constant:add");return this.getConstant(a)}},{key:"updateConstant",value:function e(t,a){if(!babelHelpers.classPrivateFieldGet(this,ta).CONSTANTS[t]){throw'Constant with id "'.concat(t,'" does not exists')}babelHelpers.classPrivateFieldGet(this,ta).CONSTANTS[t].Description=a.Description;this.emit("Template:constant:update",{constant:this.getConstant(t)});return this.getConstant(t)}},{key:"deleteConstant",value:function e(t){delete babelHelpers.classPrivateFieldGet(this,ta).CONSTANTS[t];return true}},{key:"setConstantValue",value:function e(t,a){if(babelHelpers.classPrivateFieldGet(this,ta).CONSTANTS[t]){babelHelpers.classPrivateFieldGet(this,ta).CONSTANTS[t]["Default"]=a;return true}return false}},{key:"getParameters",value:function e(){var t=this;var a=[];Object.keys(babelHelpers.classPrivateFieldGet(this,ta).PARAMETERS).forEach((function(e){var i=BX.clone(babelHelpers.classPrivateFieldGet(t,ta).PARAMETERS[e]);i.Id=e;i.ObjectId="Template";i.SystemExpression="{=Template:"+e+"}";i.Expression="{{~*:"+e+"}}";a.push(i)}));return a}},{key:"getParameter",value:function e(t){var a=this.getParameters();for(var i=0;i<a.length;++i){if(a[i].Id===t){return a[i]}}return null}},{key:"addParameter",value:function e(t){var a=t.Id||this.generatePropertyId("Parameter",babelHelpers.classPrivateFieldGet(this,ta).PARAMETERS);if(babelHelpers.classPrivateFieldGet(this,ta).PARAMETERS[a]){throw'Parameter with id "'.concat(a,'" is already exists')}babelHelpers.classPrivateFieldGet(this,ta).PARAMETERS[a]=t;this.emit("Template:parameter:add",{parameter:this.getParameter(a)});return this.getParameter(a)}},{key:"updateParameter",value:function e(t,a){if(!babelHelpers.classPrivateFieldGet(this,ta).PARAMETERS[t]){throw'Parameter with id "'.concat(t,'" does not exists')}babelHelpers.classPrivateFieldGet(this,ta).PARAMETERS[t].Description=a.Description;this.emit("Template:parameter:update",{parameter:this.getParameter(t)});return this.getParameter(t)}},{key:"deleteParameter",value:function e(t){delete babelHelpers.classPrivateFieldGet(this,ta).PARAMETERS[t];return true}},{key:"setParameterValue",value:function e(t,a){if(babelHelpers.classPrivateFieldGet(this,ta).PARAMETERS[t]){babelHelpers.classPrivateFieldGet(this,ta).PARAMETERS[t]["Default"]=a;return true}return false}},{key:"getVariables",value:function e(){var t=this;var a=[];Object.keys(babelHelpers.classPrivateFieldGet(this,ta).VARIABLES).forEach((function(e){var i=BX.clone(babelHelpers.classPrivateFieldGet(t,ta).VARIABLES[e]);i.Id=e;i.ObjectId="Variable";i.SystemExpression="{=Variable:"+e+"}";i.Expression="{=Variable:"+e+"}";a.push(i)}));return a}},{key:"generatePropertyId",value:function e(t,a){var i;for(i=1;i<=1e3;++i){if(!a[t+i]){break}}return t+i}},{key:"collectUsages",value:function e(){var t={Document:new Set,Constant:new Set,Variable:new Set,Parameter:new Set,GlobalConstant:new Set,GlobalVariable:new Set,Activity:new Set};babelHelpers.classPrivateFieldGet(this,ea).forEach((function(e){var a=e.collectUsages();Object.keys(t).forEach((function(e){a[e].forEach((function(a){if(!t[e].has(a)){t[e].add(a)}}))}))}));return t}},{key:"subscribeRobotEvents",value:function e(t,a){babelHelpers.classPrivateFieldGet(this,ea).forEach((function(e){return e.subscribe(t,a)}));return this}},{key:"unsubscribeRobotEvents",value:function e(t,a){babelHelpers.classPrivateFieldGet(this,ea).forEach((function(e){return e.unsubscribe(t,a)}));return this}},{key:"getRobotDescription",value:function e(t){return i.getGlobalContext().availableRobots.find((function(e){return e["CLASS"]===t}))}},{key:"setGlobalVariables",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];this.globalVariables=t;return this}},{key:"setGlobalConstants",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];this.globalConstants=t;return this}},{key:"robots",get:function e(){return babelHelpers.classPrivateFieldGet(this,ea)}},{key:"userOptions",get:function e(){return babelHelpers.classPrivateFieldGet(this,Zt)}}],[{key:"copyRobotTo",value:function e(t,a,i){var s=a.copyTo(t,i);t.emit("Template:robot:add",{robot:s})}}]);return a}(a.EventEmitter);function ia(e,t,a){sa(e,t);t.set(e,a)}function sa(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var ra=new WeakMap;var la=new WeakMap;var na=new WeakMap;var oa=new WeakMap;var ca=function(){function e(t,a){babelHelpers.classCallCheck(this,e);ia(this,ra,{writable:true,value:void 0});ia(this,la,{writable:true,value:void 0});ia(this,na,{writable:true,value:void 0});ia(this,oa,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,ra,"Document");babelHelpers.classPrivateFieldSet(this,la,"");babelHelpers.classPrivateFieldSet(this,na,"!empty");babelHelpers.classPrivateFieldSet(this,oa,"");this.parentGroup=null;if(r.Type.isPlainObject(t)){if(t["object"]){this.setObject(t["object"])}if(t["field"]){this.setField(t["field"])}if(t["operator"]){this.setOperator(t["operator"])}if("value"in t){this.setValue(t["value"])}}if(a){this.parentGroup=a}}babelHelpers.createClass(e,[{key:"clone",value:function t(){return new e({object:babelHelpers.classPrivateFieldGet(this,ra),field:babelHelpers.classPrivateFieldGet(this,la),operator:babelHelpers.classPrivateFieldGet(this,na),value:babelHelpers.classPrivateFieldGet(this,oa)},this.parentGroup)}},{key:"setObject",value:function e(t){if(r.Type.isStringFilled(t)){babelHelpers.classPrivateFieldSet(this,ra,t)}}},{key:"setField",value:function e(t){if(r.Type.isStringFilled(t)){babelHelpers.classPrivateFieldSet(this,la,t)}}},{key:"setOperator",value:function e(t){if(!t){t="="}babelHelpers.classPrivateFieldSet(this,na,t)}},{key:"setValue",value:function e(t){babelHelpers.classPrivateFieldSet(this,oa,t);if(babelHelpers.classPrivateFieldGet(this,na)==="="&&babelHelpers.classPrivateFieldGet(this,oa)===""){babelHelpers.classPrivateFieldSet(this,na,"empty")}else if(babelHelpers.classPrivateFieldGet(this,na)==="!="&&babelHelpers.classPrivateFieldGet(this,oa)===""){babelHelpers.classPrivateFieldSet(this,na,"!empty")}}},{key:"serialize",value:function e(){return{object:babelHelpers.classPrivateFieldGet(this,ra),field:babelHelpers.classPrivateFieldGet(this,la),operator:babelHelpers.classPrivateFieldGet(this,na),value:babelHelpers.classPrivateFieldGet(this,oa)}}},{key:"object",get:function e(){return babelHelpers.classPrivateFieldGet(this,ra)}},{key:"field",get:function e(){return babelHelpers.classPrivateFieldGet(this,la)}},{key:"operator",get:function e(){return babelHelpers.classPrivateFieldGet(this,na)}},{key:"value",get:function e(){return babelHelpers.classPrivateFieldGet(this,oa)}}]);return e}();function pa(e,t,a){ua(e,t);t.set(e,a)}function ua(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var ba=new WeakMap;var da=new WeakMap;var va=function(){function e(t){var a=this;babelHelpers.classCallCheck(this,e);pa(this,ba,{writable:true,value:void 0});pa(this,da,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,ba,e.CONDITION_TYPE.field);babelHelpers.classPrivateFieldSet(this,da,[]);if(r.Type.isPlainObject(t)){if(t["type"]){babelHelpers.classPrivateFieldSet(this,ba,t["type"])}if(r.Type.isArray(t["items"])){t["items"].forEach((function(e){var t=new ca(e[0],a);a.addItem(t,e[1])}))}}}babelHelpers.createClass(e,[{key:"clone",value:function t(){var a=new e({type:babelHelpers.classPrivateFieldGet(this,ba)});babelHelpers.classPrivateFieldGet(this,da).forEach((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],s=t[1];var r=i.clone();r.parentGroup=a;a.addItem(r,s)}));return a}},{key:"addItem",value:function e(t,a){babelHelpers.classPrivateFieldGet(this,da).push([t,a])}},{key:"getItems",value:function e(){return babelHelpers.classPrivateFieldGet(this,da)}},{key:"serialize",value:function e(){var t=[];babelHelpers.classPrivateFieldGet(this,da).forEach((function(e){if(e.field!==""){t.push([e[0].serialize(),e[1]])}}));return{type:babelHelpers.classPrivateFieldGet(this,ba),items:t}}},{key:"type",get:function e(){return babelHelpers.classPrivateFieldGet(this,ba)},set:function t(a){if(Object.values(e.CONDITION_TYPE).includes(a)){babelHelpers.classPrivateFieldSet(this,ba,a)}return this}},{key:"items",get:function e(){return babelHelpers.classPrivateFieldGet(this,da)}}],[{key:"createFromForm",value:function t(a,i){var s=new e;if(!i){i="condition_"}if(r.Type.isArray(a[i+"field"])){for(var l=0;l<a[i+"field"].length;++l){if(a[i+"field"][l]===""){continue}var n=new ca({},s);n.setObject(a[i+"object"][l]);n.setField(a[i+"field"][l]);n.setOperator(a[i+"operator"][l]);n.setValue(a[i+"value"][l]);var o=e.JOINER.And;if(a[i+"joiner"]&&a[i+"joiner"][l]===e.JOINER.Or){o=e.JOINER.Or}s.addItem(n,o)}}return s}}]);return e}();babelHelpers.defineProperty(va,"CONDITION_TYPE",{Field:"field",Mixed:"mixed"});babelHelpers.defineProperty(va,"JOINER",{And:"AND",Or:"OR",message:function e(t){if(t===this.Or){return r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_OR")}return r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_AND")}});function ha(e,t,a){fa(e,t);t.set(e,a)}function fa(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var ga=new WeakMap;var ma=new WeakMap;var Ta=new WeakMap;var Pa=new WeakMap;var ya=new WeakMap;var Ca=function(){function e(t,a){babelHelpers.classCallCheck(this,e);ha(this,ga,{writable:true,value:void 0});ha(this,ma,{writable:true,value:void 0});ha(this,Ta,{writable:true,value:void 0});ha(this,Pa,{writable:true,value:void 0});ha(this,ya,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,ga,t);babelHelpers.classPrivateFieldSet(this,ma,[]);babelHelpers.classPrivateFieldSet(this,Ta,i.ConditionGroup.JOINER.And);babelHelpers.classPrivateFieldSet(this,Pa,"condition_");if(r.Type.isPlainObject(a)){if(r.Type.isArray(a.fields)){babelHelpers.classPrivateFieldSet(this,ma,a.fields.map((function(e){e.ObjectId="Document";return e})))}if(a.joiner&&a.joiner===i.ConditionGroup.JOINER.Or){babelHelpers.classPrivateFieldSet(this,Ta,i.ConditionGroup.JOINER.Or)}if(a.fieldPrefix){babelHelpers.classPrivateFieldSet(this,Pa,a.fieldPrefix)}}}babelHelpers.createClass(e,[{key:"createNode",value:function e(){var t=this.objectNode=r.Dom.create("input",{attrs:{type:"hidden",name:babelHelpers.classPrivateFieldGet(this,Pa)+"object[]",value:babelHelpers.classPrivateFieldGet(this,ga).object}});var a=this.fieldNode=r.Dom.create("input",{attrs:{type:"hidden",name:babelHelpers.classPrivateFieldGet(this,Pa)+"field[]",value:babelHelpers.classPrivateFieldGet(this,ga).field}});var s=this.operatorNode=r.Dom.create("input",{attrs:{type:"hidden",name:babelHelpers.classPrivateFieldGet(this,Pa)+"operator[]",value:babelHelpers.classPrivateFieldGet(this,ga).operator}});var l=this.valueNode=r.Dom.create("input",{attrs:{type:"hidden",name:babelHelpers.classPrivateFieldGet(this,Pa)+"value[]",value:babelHelpers.classPrivateFieldGet(this,ga).value}});var n=this.joinerNode=r.Dom.create("input",{attrs:{type:"hidden",name:babelHelpers.classPrivateFieldGet(this,Pa)+"joiner[]",value:babelHelpers.classPrivateFieldGet(this,Ta)}});var o=this.labelNode=r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-link-wrapper"}});this.setLabelText();this.bindLabelNode();var c=r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-link-remove"},events:{click:this.removeCondition.bind(this)}});var p=r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-condition-joiner"},text:i.ConditionGroup.JOINER.message(babelHelpers.classPrivateFieldGet(this,Ta))});r.Event.bind(p,"click",this.changeJoiner.bind(this,p));this.node=r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-link-wrapper bizproc-automation-condition-wrapper"},children:[t,a,s,l,n,o,c,p]});return this.node}},{key:"init",value:function e(t){babelHelpers.classPrivateFieldSet(this,ga,t);this.setLabelText();this.bindLabelNode()}},{key:"setLabelText",value:function e(){if(!this.labelNode||!babelHelpers.classPrivateFieldGet(this,ga)){return}r.Dom.clean(this.labelNode);if(babelHelpers.classPrivateFieldGet(this,ga).field!==""){var t=this.getField(babelHelpers.classPrivateFieldGet(this,ga).object,babelHelpers.classPrivateFieldGet(this,ga).field)||"?";var a=babelHelpers.classPrivateFieldGet(this,ga).operator.indexOf("empty")<0?BX.Bizproc.FieldType.formatValuePrintable(t,babelHelpers.classPrivateFieldGet(this,ga).value):null;this.labelNode.appendChild(r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-link"},text:t.Name}));this.labelNode.appendChild(r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-link"},text:this.getOperatorLabel(babelHelpers.classPrivateFieldGet(this,ga).operator)}));if(a){this.labelNode.appendChild(r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-link"},text:a}))}}else{this.labelNode.appendChild(r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-link"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_EMPTY")}))}}},{key:"bindLabelNode",value:function e(){if(this.labelNode){r.Event.bind(this.labelNode,"click",this.onLabelClick.bind(this))}}},{key:"onLabelClick",value:function e(){this.showPopup()}},{key:"showPopup",value:function e(){if(this.popup){this.popup.show();return}var t=this.filterFields();var a=r.Dom.create("input",{attrs:{type:"hidden",className:"bizproc-automation-popup-settings-dropdown"}});var i=r.Dom.create("input",{attrs:{type:"hidden",className:"bizproc-automation-popup-settings-dropdown"}});var s=r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings-dropdown",readonly:"readonly"},children:[i]});r.Event.bind(s,"click",this.onFieldSelectorClick.bind(this,s,i,t,a));var l=this.getField(babelHelpers.classPrivateFieldGet(this,ga).object,babelHelpers.classPrivateFieldGet(this,ga).field);if(!babelHelpers.classPrivateFieldGet(this,ga).field){l=t[0]}i.value=l.Id;a.value=l.ObjectId;s.textContent=l.Name;var n=babelHelpers.classPrivateFieldGet(this,ga).operator.indexOf("empty")<0?this.createValueNode(l,babelHelpers.classPrivateFieldGet(this,ga).value):null;var o=r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[n]});var c=this.createOperatorNode(l,o);var p=r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[c]});if(babelHelpers.classPrivateFieldGet(this,ga).field!==""){c.value=babelHelpers.classPrivateFieldGet(this,ga).operator}var u=r.Dom.create("form",{attrs:{className:"bizproc-automation-popup-select-block"},children:[r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},children:[s]}),p,o]});r.Event.bind(i,"change",this.onFieldChange.bind(this,i,p,o,a));var b=this;this.popup=new BX.PopupWindow("bizproc-automation-popup-set",this.labelNode,{className:"bizproc-automation-popup-set",autoHide:false,closeByEsc:true,closeIcon:false,titleBar:false,angle:true,offsetLeft:45,overlay:{backgroundColor:"transparent"},content:u,buttons:[new BX.PopupWindowButton({text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_CHOOSE"),className:"webform-button webform-button-create",events:{click:function e(){babelHelpers.classPrivateFieldGet(b,ga).setObject(a.value);babelHelpers.classPrivateFieldGet(b,ga).setField(i.value);babelHelpers.classPrivateFieldGet(b,ga).setOperator(p.firstChild.value);var t=o.querySelector('[name^="'+babelHelpers.classPrivateFieldGet(b,Pa)+'value"]');if(t){babelHelpers.classPrivateFieldGet(b,ga).setValue(t.value)}else{babelHelpers.classPrivateFieldGet(b,ga).setValue("")}b.setLabelText();b.updateValueNode();this.popupWindow.close()}}}),new BX.PopupWindowButtonLink({text:r.Loc.getMessage("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function e(){this.popupWindow.close()}}})],events:{onPopupClose:function e(){this.destroy();if(b.fieldDialog){b.fieldDialog.destroy();delete b.fieldDialog}delete b.popup}}});this.popup.show()}},{key:"onFieldSelectorClick",value:function e(t,a,i,s,r){if(!this.fieldDialog){this.fieldDialog=new BX.Bizproc.Automation.Selector.InlineSelectorCondition(t,i,(function(e){t.textContent=e.Name;a.value=e.Id;s.value=e.ObjectId;BX.fireEvent(a,"change")}),babelHelpers.classPrivateFieldGet(this,ga))}this.fieldDialog.openMenu(r)}},{key:"updateValueNode",value:function e(){if(babelHelpers.classPrivateFieldGet(this,ga)){if(this.objectNode){this.objectNode.value=babelHelpers.classPrivateFieldGet(this,ga).object}if(this.fieldNode){this.fieldNode.value=babelHelpers.classPrivateFieldGet(this,ga).field}if(this.operatorNode){this.operatorNode.value=babelHelpers.classPrivateFieldGet(this,ga).operator}if(this.valueNode){this.valueNode.value=babelHelpers.classPrivateFieldGet(this,ga).value}}}},{key:"onFieldChange",value:function e(t,a,i,s){var r=this.getField(s.value,t.value);var l=this.createOperatorNode(r,i);a.replaceChild(l,a.firstChild);this.onOperatorChange(l,r,i)}},{key:"onOperatorChange",value:function e(t,a,i){r.Dom.clean(i);if(t.value.indexOf("empty")<0){var s=this.createValueNode(a);i.appendChild(s)}}},{key:"getField",value:function e(t,a){var s;var r=i.Designer.getInstance().robot;var l=i.Designer.getInstance().component;var n=r?r.getTemplate():null;switch(t){case"Document":for(var o=0;o<babelHelpers.classPrivateFieldGet(this,ma).length;++o){if(a===babelHelpers.classPrivateFieldGet(this,ma)[o].Id){s=babelHelpers.classPrivateFieldGet(this,ma)[o]}}break;case"Template":if(n&&l&&l.triggerManager){s=l.triggerManager.getReturnProperty(n.getStatusId(),a)}break;case"Constant":if(n){s=n.getConstant(a)}break;case"GlobalConst":if(l){s=l.getConstant(a)}break;case"GlobalVar":if(l){s=l.getGVariable(a)}break;default:var c=n?n.getRobotById(t):null;if(c){s=c.getReturnProperty(a)}break}return s||{Id:a,ObjectId:t,Name:a,Type:"string",Expression:a,SystemExpression:"{="+t+":"+a+"}"}}},{key:"getOperators",value:function e(t,a){var i={"!empty":r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_EMPTY"),empty:r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_EMPTY"),"=":r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_EQ"),"!=":r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_NE")};switch(t){case"file":case"UF:crm":case"UF:resourcebooking":i={"!empty":r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_EMPTY"),empty:r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_EMPTY")};break;case"bool":case"select":if(a){i["contain"]=r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_CONTAIN");i["!contain"]=r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_CONTAIN")}break;case"user":i["in"]=r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_IN");i["!in"]=r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_IN");i["contain"]=r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_CONTAIN");i["!contain"]=r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_CONTAIN");break;default:i["in"]=r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_IN");i["!in"]=r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_IN");i["contain"]=r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_CONTAIN");i["!contain"]=r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_NOT_CONTAIN");i[">"]=r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_GT");i[">="]=r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_GTE");i["<"]=r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_LT");i["<="]=r.Loc.getMessage("BIZPROC_AUTOMATION_ROBOT_CONDITION_LTE")}return i}},{key:"getOperatorLabel",value:function e(t){return this.getOperators()[t]}},{key:"filterFields",value:function e(){var t=[];for(var a=0;a<babelHelpers.classPrivateFieldGet(this,ma).length;++a){var i=babelHelpers.classPrivateFieldGet(this,ma)[a]["Type"];if(i==="bool"||i==="date"||i==="datetime"||i==="double"||i==="file"||i==="int"||i==="select"||i==="string"||i==="text"||i==="user"||i==="UF:money"||i==="UF:crm"||i==="UF:resourcebooking"||i==="UF:url"){t.push(babelHelpers.classPrivateFieldGet(this,ma)[a])}}return t}},{key:"createValueNode",value:function e(t,a){var s=i.Designer.getInstance().component?i.Designer.getInstance().component.document.getRawType():BX.Bizproc.Automation.API.documentType;var r=BX.clone(t);r.Multiple=false;return BX.Bizproc.FieldType.renderControl(s,r,babelHelpers.classPrivateFieldGet(this,Pa)+"value",a)}},{key:"createOperatorNode",value:function e(t,a){var i=r.Dom.create("select",{attrs:{className:"bizproc-automation-popup-settings-dropdown"}});var s=this.getOperators(t["Type"],t["Multiple"]);for(var l in s){if(!s.hasOwnProperty(l)){continue}i.appendChild(r.Dom.create("option",{props:{value:l},text:s[l]}))}r.Event.bind(i,"change",this.onOperatorChange.bind(this,i,t,a));return i}},{key:"removeCondition",value:function e(t){babelHelpers.classPrivateFieldSet(this,ga,null);r.Dom.remove(this.node);this.labelNode=this.fieldNode=this.operatorNode=this.valueNode=this.node=null;t.stopPropagation()}},{key:"changeJoiner",value:function e(t,a){babelHelpers.classPrivateFieldSet(this,Ta,babelHelpers.classPrivateFieldGet(this,Ta)===i.ConditionGroup.JOINER.Or?i.ConditionGroup.JOINER.And:i.ConditionGroup.JOINER.Or);t.textContent=i.ConditionGroup.JOINER.message(babelHelpers.classPrivateFieldGet(this,Ta));if(this.joinerNode){this.joinerNode.value=babelHelpers.classPrivateFieldGet(this,Ta)}a.preventDefault()}},{key:"destroy",value:function e(){if(this.popup){this.popup.close()}}}]);return e}();function Oa(e,t,a){Ia(e,t);t.set(e,a)}function Ia(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var Ha=new WeakMap;var Ea=new WeakMap;var Aa=new WeakMap;var _a=new WeakMap;var Fa=function(){function e(t,a){babelHelpers.classCallCheck(this,e);Oa(this,Ha,{writable:true,value:void 0});Oa(this,Ea,{writable:true,value:void 0});Oa(this,Aa,{writable:true,value:void 0});Oa(this,_a,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,Ha,t);babelHelpers.classPrivateFieldSet(this,Ea,[]);babelHelpers.classPrivateFieldSet(this,Aa,"condition_");babelHelpers.classPrivateFieldSet(this,_a,[]);if(r.Type.isPlainObject(a)){if(r.Type.isArray(a.fields)){babelHelpers.classPrivateFieldSet(this,Ea,a.fields)}if(a.fieldPrefix){babelHelpers.classPrivateFieldSet(this,Aa,a.fieldPrefix)}}}babelHelpers.createClass(e,[{key:"createNode",value:function e(){var t=this;var a=[];var i=babelHelpers.classPrivateFieldGet(this,Ea);babelHelpers.classPrivateFieldGet(this,Ha).getItems().forEach((function(e){var s=new Ca(e[0],{fields:i,joiner:e[1],fieldPrefix:babelHelpers.classPrivateFieldGet(t,Aa)});babelHelpers.classPrivateFieldGet(this,_a).push(s);a.push(s.createNode())}),this);a.push(r.Dom.create("a",{attrs:{className:"bizproc-automation-popup-settings-link"},text:"[+]",events:{click:function e(){t.addItem(this)}}}));return r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-link-wrapper"},children:a})}},{key:"addItem",value:function e(t){var a=new Ca(new i.Condition({},babelHelpers.classPrivateFieldGet(this,Ha)),{fields:babelHelpers.classPrivateFieldGet(this,Ea),fieldPrefix:babelHelpers.classPrivateFieldGet(this,Aa)});babelHelpers.classPrivateFieldGet(this,_a).push(a);t.parentNode.insertBefore(a.createNode(),t)}},{key:"destroy",value:function e(){babelHelpers.classPrivateFieldGet(this,_a).forEach((function(e){return e.destroy()}));babelHelpers.classPrivateFieldSet(this,_a,[])}}]);return e}();var Na=function(){function e(t){babelHelpers.classCallCheck(this,e);this.basisFields=[];this.onchange=null;if(r.Type.isPlainObject(t)){this.labelNode=t.labelNode;this.useAfterBasis=t.useAfterBasis;if(r.Type.isArray(t.basisFields)){this.basisFields=t.basisFields}this.onchange=t.onchange;this.minLimitM=t.minLimitM}}babelHelpers.createClass(e,[{key:"init",value:function e(t){this.delay=t;this.setLabelText();this.bindLabelNode();this.prepareBasisFields()}},{key:"setLabelText",value:function e(){if(this.delay&&this.labelNode){this.labelNode.textContent=this.delay.format(r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_AT_ONCE"),this.basisFields)}}},{key:"bindLabelNode",value:function e(){if(this.labelNode){r.Event.bind(this.labelNode,"click",BX.delegate(this.onLabelClick,this))}}},{key:"onLabelClick",value:function e(t){this.showDelayIntervalPopup();t.preventDefault()}},{key:"showDelayIntervalPopup",value:function e(){var t=this.delay;var a=se.generateUniqueId();var i=r.Dom.create("form",{attrs:{className:"bizproc-automation-popup-select-block"}});var s=r.Dom.create("input",{attrs:{className:"bizproc-automation-popup-select-input",id:a+"now",type:"radio",value:"now",name:"type"}});if(t.isNow()){s.setAttribute("checked","checked")}var l=r.Dom.create("label",{attrs:{className:"bizproc-automation-popup-select-wrapper",for:a+"now"},children:[r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:r.Loc.getMessage(this.useAfterBasis?"BIZPROC_AUTOMATION_CMP_BASIS_NOW":"BIZPROC_AUTOMATION_CMP_AT_ONCE_2")})]});var n=r.Dom.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":r.Loc.getMessage(this.useAfterBasis?"BIZPROC_AUTOMATION_CMP_DELAY_NOW_HELP_2":"BIZPROC_AUTOMATION_CMP_DELAY_NOW_HELP")}});l.appendChild(n);i.appendChild(r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-select-item"},children:[s,l]}));i.appendChild(this.createAfterControlNode());if(this.basisFields.length>0){i.appendChild(this.createBeforeControlNode());i.appendChild(this.createInControlNode())}var o=r.Dom.create("input",{attrs:{type:"checkbox",id:a+"worktime",name:"worktime",value:"1",style:"vertical-align: middle"},props:{checked:t.workTime}});var c=r.Dom.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_DELAY_WORKTIME_HELP_2")}});i.appendChild(r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings-title"},children:[o,r.Dom.create("label",{attrs:{className:"bizproc-automation-popup-settings-lbl",for:a+"worktime"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_WORK_TIME")}),c]}));var p=this;BX.UI.Hint.init(i);var u=new BX.PopupWindow(se.generateUniqueId(),this.labelNode,{autoHide:true,closeByEsc:true,closeIcon:false,titleBar:false,angle:true,offsetLeft:20,content:i,buttons:[new BX.PopupWindowButton({text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_CHOOSE"),className:"webform-button webform-button-create bizproc-automation-button-left",events:{click:function e(){var t=BX.ajax.prepareForm(i);p.saveFormData(t["data"]);this.popupWindow.close()}}})],events:{onPopupClose:function e(){if(p.fieldsMenu){p.fieldsMenu.popupWindow.close()}if(p.valueTypeMenu){p.valueTypeMenu.popupWindow.close()}this.destroy()}},overlay:{backgroundColor:"transparent"}});u.show()}},{key:"saveFormData",value:function e(t){if(t["type"]==="now"){this.delay.setNow()}else if(t["type"]===Ye.DELAY_TYPE.In){this.delay.setType(Ye.DELAY_TYPE.In);this.delay.setValue(0);this.delay.setValueType("i");this.delay.setBasis(t["basis_in"])}else{this.delay.setType(t["type"]);this.delay.setValue(t["value_"+t["type"]]);this.delay.setValueType(t["value_type_"+t["type"]]);if(t["type"]===Ye.DELAY_TYPE.After){if(this.useAfterBasis){this.delay.setBasis(t["basis_after"])}else{this.delay.setBasis(Ye.BASIS_TYPE.CurrentDateTime)}if(this.minLimitM>0&&this.delay.basis===Ye.BASIS_TYPE.CurrentDateTime&&this.delay.valueType==="i"&&this.delay.value<this.minLimitM){BX.UI.Notification.Center.notify({content:r.Loc.getMessage("BIZPROC_AUTOMATION_DELAY_MIN_LIMIT_LABEL")});this.delay.setValue(this.minLimitM)}}else{this.delay.setBasis(t["basis_before"])}}this.delay.setWorkTime(t["worktime"]);this.setLabelText();if(this.onchange){this.onchange(this.delay)}}},{key:"createAfterControlNode",value:function e(){var t=this.delay;var a=se.generateUniqueId();var i=r.Dom.create("input",{attrs:{className:"bizproc-automation-popup-select-input",id:a,type:"radio",value:Ye.DELAY_TYPE.After,name:"type"}});if(t.type===Ye.DELAY_TYPE.After&&t.value>0){i.setAttribute("checked","checked")}var s=r.Dom.create("input",{attrs:{type:"text",name:"value_after",className:"bizproc-automation-popup-settings-input"},props:{value:t.type===Ye.DELAY_TYPE.After&&t.value?t.value:this.minLimitM||5}});var l=r.Dom.create("label",{attrs:{className:"bizproc-automation-popup-select-wrapper",for:a},children:[r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_THROUGH_3")}),s,this.createValueTypeSelector("value_type_after")]});if(this.useAfterBasis){l.appendChild(r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-auto-width"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_AFTER")}));var n=this.getBasisField(t.basis,true);var o=t.basis;if(!n){n=this.getBasisField(Ye.BASIS_TYPE.CurrentDateTime,true);o=n.SystemExpression}var c=r.Dom.create("input",{attrs:{type:"hidden",name:"basis_after",value:o}});var p=this;var u=r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-delay-interval-basis"},text:n?n.Name:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_CHOOSE_DATE_FIELD"),events:{click:function e(t){p.onBasisClick(t,this,(function(e){u.textContent=e.Name;c.value=e.SystemExpression}),Ye.DELAY_TYPE.After)}}});l.appendChild(c);l.appendChild(u)}if(!this.useAfterBasis){var b=r.Dom.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_DELAY_AFTER_HELP")}});l.appendChild(b)}return r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-select-item"},children:[i,l]})}},{key:"createBeforeControlNode",value:function e(){var t=this.delay;var a=se.generateUniqueId();var i=r.Dom.create("input",{attrs:{className:"bizproc-automation-popup-select-input",id:a,type:"radio",value:Ye.DELAY_TYPE.Before,name:"type"}});if(t.type===Ye.DELAY_TYPE.Before){i.setAttribute("checked","checked")}var s=r.Dom.create("input",{attrs:{type:"text",name:"value_before",className:"bizproc-automation-popup-settings-input"},props:{value:t.type===Ye.DELAY_TYPE.Before&&t.value?t.value:this.minLimitM||5}});var l=r.Dom.create("label",{attrs:{className:"bizproc-automation-popup-select-wrapper",for:a},children:[r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_FOR_TIME_3")}),s,this.createValueTypeSelector("value_type_before"),r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-auto-width"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_BEFORE_1")})]});var n=this.getBasisField(t.basis);var o=t.basis;if(!n){n=this.basisFields[0];o=n.SystemExpression}var c=r.Dom.create("input",{attrs:{type:"hidden",name:"basis_before",value:o}});var p=this;var u=r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-delay-interval-basis"},text:n?n.Name:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_CHOOSE_DATE_FIELD"),events:{click:function e(t){p.onBasisClick(t,this,(function(e){u.textContent=e.Name;c.value=e.SystemExpression}),Ye.DELAY_TYPE.Before)}}});l.appendChild(c);l.appendChild(u);if(!this.useAfterBasis){var b=r.Dom.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_DELAY_BEFORE_HELP")}});l.appendChild(b)}return r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-select-item"},children:[i,l]})}},{key:"createInControlNode",value:function e(){var t=this.delay;var a=se.generateUniqueId();var i=r.Dom.create("input",{attrs:{className:"bizproc-automation-popup-select-input",id:a,type:"radio",value:Ye.DELAY_TYPE.In,name:"type"}});if(t.type===Ye.DELAY_TYPE.In){i.setAttribute("checked","checked")}var s=r.Dom.create("label",{attrs:{className:"bizproc-automation-popup-select-wrapper",for:a},children:[r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title"},text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_IN_TIME_2")})]});var l=this.getBasisField(t.basis);var n=t.basis;if(!l){l=this.basisFields[0];n=l.SystemExpression}var o=r.Dom.create("input",{attrs:{type:"hidden",name:"basis_in",value:n}});var c=this;var p=r.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-link bizproc-automation-delay-interval-basis"},text:l?l.Name:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_CHOOSE_DATE_FIELD"),events:{click:function e(t){c.onBasisClick(t,this,(function(e){p.textContent=e.Name;o.value=e.SystemExpression}))}}});s.appendChild(o);s.appendChild(p);if(!this.useAfterBasis){var u=r.Dom.create("span",{attrs:{className:"bizproc-automation-status-help bizproc-automation-status-help-right","data-hint":r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_DELAY_IN_HELP")}});s.appendChild(u)}return r.Dom.create("div",{attrs:{className:"bizproc-automation-popup-select-item"},children:[i,s]})}},{key:"createValueTypeSelector",value:function e(t){var a=this.delay;var i={i:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_INTERVAL_M"),h:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_INTERVAL_H"),d:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_INTERVAL_D")};var s=r.Dom.create("label",{attrs:{className:"bizproc-automation-popup-settings-link"},text:i[a.valueType]});var l=r.Dom.create("input",{attrs:{type:"hidden",name:t},props:{value:a.valueType}});r.Event.bind(s,"click",this.onValueTypeSelectorClick.bind(this,s,l));return r.Dom.create("span",{children:[s,l]})}},{key:"onValueTypeSelectorClick",value:function e(a,i){var s=se.generateUniqueId();var l=function e(t,s){this.popupWindow.close();i.value=s.valueId;a.textContent=s.text};var n=[{text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_INTERVAL_M"),valueId:"i",onclick:l},{text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_INTERVAL_H"),valueId:"h",onclick:l},{text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_INTERVAL_D"),valueId:"d",onclick:l}];t.MenuManager.show(s,a,n,{autoHide:true,offsetLeft:25,angle:{position:"top"},events:{onPopupClose:function e(){this.destroy()}},overlay:{backgroundColor:"transparent"}});this.valueTypeMenu=t.MenuManager.currentItem}},{key:"onBasisClick",value:function e(a,i,s,l){var n=[];if(l===Ye.DELAY_TYPE.After){n.push({text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_BASIS_NOW"),field:{Name:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_BASIS_NOW"),SystemExpression:Ye.BASIS_TYPE.CurrentDateTime},onclick:function e(t,a){if(s){s(a.field)}this.popupWindow.close()}},{text:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_BASIS_DATE"),field:{Name:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_BASIS_DATE"),SystemExpression:Ye.BASIS_TYPE.CurrentDate},onclick:function e(t,a){if(s){s(a.field)}this.popupWindow.close()}},{delimiter:true})}for(var o=0;o<this.basisFields.length;++o){if(l!==Ye.DELAY_TYPE.After&&this.basisFields[o]["Id"].indexOf("DATE_CREATE")>-1){continue}n.push({text:r.Text.encode(this.basisFields[o].Name),field:this.basisFields[o],onclick:function e(t,a){if(s){s(a.field||a.options.field)}this.popupWindow.close()}})}var c=i.getAttribute("data-menu-id");if(!c){c=se.generateUniqueId();i.setAttribute("data-menu-id",c)}t.MenuManager.show(c,i,n,{autoHide:true,offsetLeft:BX.pos(i)["width"]/2,angle:{position:"top",offset:0},overlay:{backgroundColor:"transparent"}});this.fieldsMenu=t.MenuManager.currentItem}},{key:"getBasisField",value:function e(t,a){if(a&&(t===Ye.BASIS_TYPE.CurrentDateTime||t===Ye.BASIS_TYPE.CurrentDateTimeLocal)){return{Name:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_BASIS_NOW"),SystemExpression:Ye.BASIS_TYPE.CurrentDateTime}}if(a&&t===Ye.BASIS_TYPE.CurrentDate){return{Name:r.Loc.getMessage("BIZPROC_AUTOMATION_CMP_BASIS_DATE"),SystemExpression:Ye.BASIS_TYPE.CurrentDate}}var i=null;for(var s=0;s<this.basisFields.length;++s){if(t===this.basisFields[s].SystemExpression){i=this.basisFields[s]}}return i}},{key:"prepareBasisFields",value:function e(){var t=[];for(var a=0;a<this.basisFields.length;++a){var i=this.basisFields[a];if(i["Id"].indexOf("DATE_MODIFY")<0&&i["Id"].indexOf("EVENT_DATE")<0&&i["Id"].indexOf("BIRTHDATE")<0){t.push(i)}}this.basisFields=t}}]);return e}();function Sa(e,t,a){ka(e,t);t.set(e,a)}function ka(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var Ga=new WeakMap;var Ma=function(e){babelHelpers.inherits(t,e);function t(e){var a;babelHelpers.classCallCheck(this,t);a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));Sa(babelHelpers.assertThisInitialized(a),Ga,{writable:true,value:void 0});a.setEventNamespace("BX.Bizproc.Automation.Context");if(r.Type.isPlainObject(e)){babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),Ga,e)}return a}babelHelpers.createClass(t,[{key:"set",value:function e(t,a){var i=this.has(t);babelHelpers.classPrivateFieldGet(this,Ga)[t]=a;this.emit(i?"valueChanged":"valueAdded",{name:t,value:a});return this}},{key:"get",value:function e(t){return babelHelpers.classPrivateFieldGet(this,Ga)[t]}},{key:"has",value:function e(t){return babelHelpers.classPrivateFieldGet(this,Ga).hasOwnProperty(t)}},{key:"subsribeValueChanges",value:function e(t,a){this.subscribe("valueChanged",(function(e){if(e.data.name===t){a(e)}}));return this}}]);return t}(a.EventEmitter);var Da=function(e){babelHelpers.inherits(t,e);function t(e){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e))}babelHelpers.createClass(t,[{key:"getAvailableTrigger",value:function e(t){return this.availableTriggers.find((function(e){return e["CODE"]===t}))}},{key:"document",get:function e(){return this.get("document")}},{key:"signedDocument",get:function e(){var t;return(t=this.get("signedDocument"))!==null&&t!==void 0?t:""}},{key:"ajaxUrl",get:function e(){var t;return(t=this.get("ajaxUrl"))!==null&&t!==void 0?t:""}},{key:"availableRobots",get:function e(){var t=this.get("availableRobots");if(r.Type.isArray(t)){return t}return[]}},{key:"availableTriggers",get:function e(){var t=this.get("availableTriggers");if(r.Type.isArray(t)){return t}return[]}},{key:"canManage",get:function e(){var t=this.get("canManage");return r.Type.isBoolean(t)&&t}},{key:"canEdit",get:function e(){var t=this.get("canEdit");return r.Type.isBoolean(t)&&t}},{key:"userOptions",get:function e(){return this.get("userOptions")}},{key:"tracker",get:function e(){return this.get("tracker")},set:function e(t){this.set("tracker",t)}},{key:"bizprocEditorUrl",get:function e(){return this.get("bizprocEditorUrl")}},{key:"constantsEditorUrl",get:function e(){return this.get("constantsEditorUrl")}},{key:"parametersEditorUrl",get:function e(){return this.get("parametersEditorUrl")}}]);return t}(Ma);function wa(){r.Reflection.namespace("BX.Bizproc.Automation");var e=BX.Bizproc.Automation.Context;if(e instanceof Da){return e}throw new Error("Context is not initialized yet")}function Ra(){try{return wa()}catch(e){return null}}function Ba(e){r.Reflection.namespace("BX.Bizproc.Automation");BX.Bizproc.Automation.Context=e;return e}e.TemplatesScheme=y;e.AutomationContext=Da;e.getGlobalContext=wa;e.tryGetGlobalContext=Ra;e.setGlobalContext=Ba;e.TemplateScope=u;e.TriggerManager=Ie;e.Trigger=X;e.Template=aa;e.Robot=Rt;e.UserOptions=zt;e.Document=Me;e.ViewMode=S;e.ConditionGroup=va;e.ConditionGroupSelector=Fa;e.Condition=ca;e.Designer=be;e.DelayInterval=Ye;e.DelayIntervalSelector=Na;e.HelpHint=V;e.Helper=se;e.RobotEntry=it;e.TriggerEntry=st;e.TrackingEntryBuilder=ct;e.TrackingEntry=Ke;e.TrackingStatus=qe;e.Tracker=Tt})(this.BX.Bizproc=this.BX.Bizproc||{},BX.Main,BX.Event,BX.Bizproc,BX,BX);
//# sourceMappingURL=automation.bundle.map.js