this.BX=this.BX||{};(function(e,t,r,a,n,i){"use strict";var c;function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,a)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(Object(r),!0).forEach((function(t){babelHelpers.defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){u(e,t);t.add(e)}function u(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function p(e,t,r){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return r}var d=null;var f=new WeakSet;var b=new WeakSet;var h=new WeakSet;var g=new WeakSet;var m=function(){function e(){babelHelpers.classCallCheck(this,e);l(this,g);l(this,h);l(this,b);l(this,f);babelHelpers.defineProperty(this,"scriptEditUrl","/bitrix/components/bitrix/bizproc.script.edit/");babelHelpers.defineProperty(this,"scriptListUrl","/bitrix/components/bitrix/bizproc.script.list/");babelHelpers.defineProperty(this,"scriptQueueListUrl","/bitrix/components/bitrix/bizproc.script.queue.list/");babelHelpers.defineProperty(this,"scriptQueueDocumentListUrl","/bitrix/components/bitrix/bizproc.script.queue.document.list/")}babelHelpers.createClass(e,[{key:"startScript",value:function e(a,n){var i=this;var c=this.getDocumentIds.apply(this,babelHelpers.toConsumableArray(n.split(":")));if(!c.length){r.MessageBox.alert(t.Loc.getMessage("BIZPROC_SCRIPT_MANAGER_START_NOTHING_SELECTED"));return}var s=function e(){p(i,f,v).call(i,a,c);return true};if(c.length>1){r.MessageBox.confirm(t.Loc.getMessage("BIZPROC_SCRIPT_MANAGER_START_TEXT_START").replace("#CNT#",c.length),s,t.Loc.getMessage("BIZPROC_SCRIPT_MANAGER_START_BUTTON_START"))}else{s()}}},{key:"renderParametersPopupContent",value:function e(r,a){var n=t.Dom.create("form",{attrs:{className:"bp-script-start-form"}});r.forEach((function(e){var r=BX.Bizproc.FieldType.renderControl(a,e,e.Id,e.Default||"");var i=e.Description?t.Dom.create("span",{text:e.Description,attrs:{className:"bp-script-start-form-row-desc"}}):"";t.Dom.append(t.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="bp-script-start-form-row">\n\t\t\t\t\t\t<span class="bp-script-start-form-row-title">',"</span>\n\t\t\t\t\t\t",'\n\t\t\t\t\t\t<div class="bp-script-start-form-row-field">',"</div>\n\t\t\t\t\t</div>\n\t\t\t\t"])),t.Text.encode(e.Name),i,r),n)}));return n}},{key:"getDocumentIds",value:function e(r,a){var n=[];if(r==="crm_switcher"){var i=p(this,g,I).call(this,a);if(i){n=i.getRows().getSelectedIds()}else if(BX.CRM&&BX.CRM.Kanban&&BX.CRM.Kanban.Grid&&BX.CRM.Kanban.Grid.Instance){n=BX.CRM.Kanban.Grid.Instance.getCheckedId()}}else if(r==="crm_detail"){n=[BX.Crm.EntityEditor.getDefault().getEntityId()]}if(t.Type.isArrayFilled(n)){n=n.map((function(e){return"".concat(a.toUpperCase(),"_").concat(e)}))}return n}},{key:"createScript",value:function r(a,n){return e.openSlider(t.Uri.addParam(this.scriptEditUrl,{documentType:a,placement:n}),{width:930,cacheable:false,allowChangeHistory:false})}},{key:"showScriptList",value:function r(a,n){e.openSlider(t.Uri.addParam(this.scriptListUrl,{documentType:a,placement:n}),{cacheable:false,allowChangeHistory:false}).then((function(e){if(e.isLoaded());}))}},{key:"showScriptQueueList",value:function r(a){e.openSlider(t.Uri.addParam(this.scriptQueueListUrl,{scriptId:a}),{cacheable:false,allowChangeHistory:false})}},{key:"showScriptQueueDocumentList",value:function r(a){e.openSlider(t.Uri.addParam(this.scriptQueueDocumentListUrl,{queueId:a}),{cacheable:false,allowChangeHistory:false})}},{key:"editScript",value:function r(a,n){return e.openSlider(t.Uri.addParam(this.scriptEditUrl,{scriptId:a,placement:n}),{width:930,cacheable:false,allowChangeHistory:false})}},{key:"deleteScript",value:function e(r){return t.ajax.runAction("bizproc.script.delete",{analyticsLabel:"bizprocScriptDelete",data:{scriptId:r}})}},{key:"activateScript",value:function e(r){return t.ajax.runAction("bizproc.script.activate",{analyticsLabel:"bizprocScriptActivate",data:{scriptId:r}})}},{key:"deactivateScript",value:function e(r){return t.ajax.runAction("bizproc.script.deactivate",{analyticsLabel:"bizprocScriptDeactivate",data:{scriptId:r}})}},{key:"terminateScriptQueue",value:function e(a){t.ajax.runAction("bizproc.script.terminateQueue",{analyticsLabel:"bizprocScriptTerminateQueue",data:{queueId:a}}).then((function(e){if(e.data.error){r.MessageBox.alert(e.data.error)}}))}},{key:"deleteScriptQueue",value:function e(a){t.ajax.runAction("bizproc.script.deleteQueue",{analyticsLabel:"bizprocScriptDeleteQueue",data:{queueId:a}}).then((function(e){if(e.data.error){r.MessageBox.alert(e.data.error)}}))}}],[{key:"openSlider",value:function e(r,a){if(!t.Type.isPlainObject(a)){a={}}a=o(o({},{cacheable:false,allowChangeHistory:true,events:{}}),a);return new Promise((function(e){if(t.Type.isString(r)&&r.length>1){a.events.onClose=function(t){e(t.getSlider())};BX.SidePanel.Instance.open(r,a)}else{e()}}))}},{key:"Instance",get:function t(){if(d===null){d=new e}return d}}]);return e}();function v(e,n){var i=this;var c=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var s=arguments.length>3?arguments[3]:undefined;var o={scriptId:e,documentIds:n,parameters:c};if(c instanceof FormData){o=c;o.set("scriptId",e);n.forEach((function(e){return o.append("documentIds[]",e)}))}t.ajax.runAction("bizproc.script.start",{analyticsLabel:"bizprocScriptStart",data:o}).then((function(c){if(c.data.error){r.MessageBox.alert(c.data.error)}if(c.data.status==="FILL_PARAMETERS"){p(i,h,y).call(i,e,n,c.data)}else if(c.data.status==="INVALID_PARAMETERS");else if(c.data.status==="QUEUED"){if(s){s.close()}a.UI.Notification.Center.notify({content:t.Loc.getMessage("BIZPROC_SCRIPT_MANAGER_START_QUEUED")});p(i,b,S).call(i,c.data.queueId)}}))["catch"]((function(e){return r.MessageBox.alert(e.errors.pop().message)}))}function S(e){var r=this;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:500;setTimeout((function(){t.ajax.runAction("bizproc.script.execQueue",{data:{queueId:e}}).then((function(i){if(!i.data.finished){p(r,b,S).call(r,e,n)}else{a.UI.Notification.Center.notify({content:t.Loc.getMessage("BIZPROC_SCRIPT_MANAGER_START_FINISHED")})}}))}),n)}function y(e,r,a){var c=this;var s=a.parameters,o=a.documentType,l=a.scriptName;var u=this.renderParametersPopupContent(s,o);var d=new n.Popup(null,null,{events:{onPopupClose:function e(){d.destroy()}},titleBar:l||t.Loc.getMessage("BIZPROC_SCRIPT_MANAGER_START_PARAMS_POPUP_TITLE"),content:u,width:595,contentNoPaddings:true,buttons:[new i.Button({text:t.Loc.getMessage("BIZPROC_SCRIPT_MANAGER_START_BUTTON_SEND_PARAMS"),color:i.Button.Color.SUCCESS,onclick:function t(){p(c,f,v).call(c,e,r,new FormData(u),d)}}),new BX.UI.Button({text:t.Loc.getMessage("UI_MESSAGE_BOX_CANCEL_CAPTION"),color:BX.UI.Button.Color.LINK,onclick:function e(){d.close()}})]});d.show()}function I(e){if(!BX.Main.gridManager){return null}var t="CRM_".concat(e.toUpperCase(),"_LIST");var r=BX.Main.gridManager.data.find((function(e){return e.id.indexOf(t)===0||e.id.indexOf("crm-type-item-list")===0}));return r?r.instance:null}var C=null;var T=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"showForPlacement",value:function e(t){if(BX.rest&&BX.rest.Marketplace){BX.rest.Marketplace.open({PLACEMENT:t})}}}],[{key:"Instance",get:function t(){if(C===null){C=new e}return C}}]);return e}();var P={Market:T,Manager:m};e.Script=P})(this.BX.Bizproc=this.BX.Bizproc||{},BX,BX.UI.Dialogs,BX,BX.Main,BX.UI);
//# sourceMappingURL=script.bundle.map.js