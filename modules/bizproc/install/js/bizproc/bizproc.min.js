if(!DragNDrop){in_array=function(e,t){var i;for(i=0;i<e.length;i++)if(e[i]===t)return true;return false};function CreateActivity(oActivity){if(!oActivity.Type)oActivity={Type:oActivity};var t=oActivity.Type,a;if(arAllActivities[t.toLowerCase()]&&arAllActivities[t.toLowerCase()]["JSCLASS"]){a=eval("new "+arAllActivities[t.toLowerCase()]["JSCLASS"]+"()");if(!oActivity.Properties)oActivity.Properties={};else if(oActivity.Properties instanceof Array){var k,properties=BX.clone(oActivity.Properties);oActivity.Properties={};for(k in properties)if(properties.hasOwnProperty(k))oActivity.Properties[k]=properties[k]}if(!oActivity.Properties["Title"])oActivity.Properties["Title"]=arAllActivities[t.toLowerCase()]["NAME"];if(!oActivity.Icon&&arAllActivities[t.toLowerCase()]["ICON"])oActivity.Icon=arAllActivities[t.toLowerCase()]["ICON"]}else if(typeof window[t]!=="undefined")a=eval("new "+t+"()");else a=new UnknownBizProcActivity;a.Init(oActivity);return a}function JSToPHPHidd(e,t,i){if(typeof BPDesignerUseJson!=="undefined"&&BPDesignerUseJson){e[i]=JSON.stringify(t,function(e,t){if(typeof t=="boolean"){return t?"1":"0"}return t});return true}var r,n,o;if(typeof t=="object"){r=[];var l=false;if(t instanceof Array){l=true;for(n in t){if(parseInt(n)!=n){l=false;break}}}if(l){for(n=0;n<t.length;n++)JSToPHPHidd(e,t[n],i+"["+n+"]")}else{for(o in t)JSToPHPHidd(e,t[o],i+"["+o+"]")}return true}if(typeof t=="boolean"){if(t)e[i]="1";else e[i]="0";return true}e[i]=t;return true}function JSToPHP(e,t){if(typeof BPDesignerUseJson!=="undefined"&&BPDesignerUseJson){return t+"="+encodeURIComponent(JSON.stringify(e,function(e,t){if(typeof t=="boolean"){return t?"1":"0"}return t}))}var i,r,n;if(typeof e=="object"){i=[];var o=false;if(e instanceof Array){o=true;for(r in e){if(parseInt(r)!=r){o=false;break}}}if(o){for(r=0;r<e.length;r++)i.push(JSToPHP(e[r],t+"["+r+"]"))}else{for(n in e)i.push(JSToPHP(e[n],t+"["+n+"]"))}return i.join("&",i)}if(typeof e=="boolean"){if(e)return t+"=1";return t+"=0"}return t+"="+encodeURIComponent(e)}function ActGetRealPos(e){if(!e||!e.offsetParent)return false;return BX.pos(e,true)}function XMLEncode(e){if(!(typeof e=="string"||e instanceof String))return e;e=e.replace(/&/g,"&amp;");e=e.replace(/"/g,"&quot;");e=e.replace(/'/g,"&apos;");e=e.replace(/</g,"&lt;");e=e.replace(/>/g,"&gt;");return e}function HTMLEncode(e){if(!(typeof e=="string"||e instanceof String))return e;e=e.replace(/&/g,"&amp;");e=e.replace(/"/g,"&quot;");e=e.replace(/</g,"&lt;");e=e.replace(/>/g,"&gt;");return e}function GenUniqId(){return parseInt(Math.random()*1e5)+"_"+parseInt(Math.random()*1e5)+"_"+parseInt(Math.random()*1e5)+"_"+parseInt(Math.random()*1e5)}function FindActivityById(e,t){if(e.Name==t)return e;var i=false;if(e.Children){for(var r=0;r<e.Children.length;r++){i=FindActivityById(e.Children[r],t);if(i)return i}}return i}function _crt(e,t){e=e||1;t=t||1;var i,r,n,o,l=document.createElement("TABLE");l.width="100%";l.cellSpacing="0";l.cellPadding="0";l.border="0";for(i=0;i<e;i++){n=l.insertRow(-1);for(r=0;r<t;r++){o=n.insertCell(-1);o.align="center";o.vAlign="center"}}return l}BizProcActivity=function(){var e=this;e.childActivities=[];e.parentActivity=null;e.Name="A"+GenUniqId();e.Type="Activity";e.Properties={Title:""};arAllId[e.Name]=true;this.Init=function(e){if(e.Name){if(!arAllId[e.Name]){delete arAllId[this.Name];this.Name=e.Name;arAllId[this.Name]=true}}if(e["Properties"])this.Properties=BX.clone(e["Properties"]);if(e["Icon"])this.Icon=e["Icon"];if(e.Type)this.Type=e.Type;this.height=0;this.width=0;var t;this.childActivities=[];if(!e.Children&&e.childActivities)e.Children=e.childActivities;for(var i in e.Children){if(!e.Children.hasOwnProperty(i))continue;t=CreateActivity(e.Children[i]);t.parentActivity=this;this.childActivities[this.childActivities.length]=t}};e.SerializeToXML=function(t){if(e.childActivities){var i='<activity class="'+XMLEncode(e.Type)+'" name="'+XMLEncode(e["Properties"].Title)+'" id="'+XMLEncode(e.Name)+'" params="" >';for(var r=0;r<e.childActivities.length;r++)i=i+e.childActivities[r].SerializeToXML();return i+"</activity>"}else return'<activity class="'+XMLEncode(e.Type)+'" name="'+XMLEncode(e["Properties"].Title)+'" id="'+XMLEncode(e.Name)+'" params="" />'};e.Serialize=function(){var t={Type:e.Type,Name:e.Name,Properties:e.Properties,Children:[]};if(e.childActivities){for(var i=0;i<e.childActivities.length;i++)t["Children"].push(e.childActivities[i].Serialize())}return t};e.OnRemoveClick=function(t){e.parentActivity.RemoveChild(e)};e.OnSettingsClick=function(t){e.Settings()};e.Settings=function(t){new BX.CDialog({content_url:"/bitrix/admin/"+MODULE_ID+"_bizproc_activity_settings.php?mode=public&bxpublic=Y&lang="+BX.message("LANGUAGE_ID")+"&entity="+ENTITY,content_post:"id="+encodeURIComponent(e.Name)+"&"+"decode=Y&"+"document_type="+encodeURIComponent(document_type)+"&"+"activity="+encodeURIComponent(e.Type)+"&"+JSToPHP(arWorkflowParameters,"arWorkflowParameters")+"&"+JSToPHP(arWorkflowVariables,"arWorkflowVariables")+"&"+JSToPHP(Array(rootActivity.Serialize()),"arWorkflowTemplate")+"&"+"current_site_id="+encodeURIComponent(CURRENT_SITE_ID)+"&"+"sessid="+BX.bitrix_sessid(),height:500,width:800}).Show()};e.RemoveResources=function(t){if(e.div&&e.div.parentNode){e.div.parentNode.removeChild(e.div);e.div=null}};e.RemoveChild=function(t){var i,r;for(i=0;i<e.childActivities.length;i++){if(e.childActivities[i].Name==t.Name){while(t.childActivities.length>0){t.childActivities[0].parentActivity.RemoveChild(t.childActivities[0])}t.childActivities=[];t.RemoveResources();e.childActivities[i].parentActivity=null;delete e.childActivities[i];for(r=i;r<e.childActivities.length-1;r++)e.childActivities[r]=e.childActivities[r+1];e.childActivities.pop();delete arAllId[t.Name];break}}BPTemplateIsModified=true};e.SetError=function(t,i){if(!e.div){return false}if(t===false)e.div.className="activity";else e.div.className="activityerr";if(i===true&&t!==false){BX.scrollToNode(e.div)}};e.Draw=function(t){e.div=t.appendChild(document.createElement("DIV"));e.div.className="activity";var i=e.div.appendChild(document.createElement("DIV"));i.className="activityhead";var r=i.appendChild(document.createElement("DIV"));r.className="activityheadr";var n=r.appendChild(document.createElement("DIV"));n.className="activityheadl";var o=n.appendChild(document.createElement("A"));o.className="activitydel";o.onclick=this.OnRemoveClick;var l=n.appendChild(document.createElement("A"));l.className="activityset";l.onclick=this.OnSettingsClick;if(this.OnHideClick){var a=n.appendChild(document.createElement("A"));a.className="activitymin";a.onclick=this.OnHideClick}var c=n.appendChild(document.createElement("DIV"));c.style.padding="5px";c.style.cursor="move";c.onmousedown=function(t){if(!t)t=window.event;var i=DragNDrop.StartDrag(t,e);i.innerHTML=this.parentNode.parentNode.parentNode.parentNode.parentNode.innerHTML;i.style.width=this.parentNode.parentNode.parentNode.parentNode.offsetWidth+"px"};var s=e.div.appendChild(document.createElement("DIV"));s.style.backgroundColor="#ffffff";s.style.borderLeft="2px #bebabb solid";s.style.borderRight="2px #bebabb solid";s.style.overflowX="hidden";s.style.overflowY="hidden";s.style.height=e.activityHeight?e.activityHeight:"30px";s.ondblclick=e.OnSettingsClick;if(e.activityContent){s.appendChild(e.activityContent)}else{var d=s.appendChild(document.createElement("DIV"));if(e.Icon)d.style.background="url("+e.Icon+") left center no-repeat";else d.style.background="url(/bitrix/images/bizproc/act_icon.gif) left center no-repeat";d.style.height="30px";d.style.margin="2px";d.style.paddingLeft="24px";d.style.textAlign="left";d.innerHTML=HTMLEncode(e["Properties"]["Title"]);d.setAttribute("title",e["Properties"]["Title"])}var p=e.div.appendChild(document.createElement("DIV"));p.style.background="url(/bitrix/images/bizproc/act_b.gif)";p.style.height="4px";p.style.overflowY="hidden";var f=p.appendChild(document.createElement("DIV"));f.style.background="url(/bitrix/images/bizproc/act_br.gif) right top no-repeat";var v=f.appendChild(document.createElement("DIV"));v.style.background="url(/bitrix/images/bizproc/act_bl.gif) left top no-repeat";v.style.height="4px";e.div.style.margin="0 auto";e.div.style.width=e.activityWidth?e.activityWidth:"170px";if(e.CheckFields&&e.CheckFields()===false)e.SetError(true)};this.SetHeight=function(e){this.height=e};e.findChildById=function(t){if(e.childActivities){for(var i=0;i<e.childActivities.length;i++){if(t===e.childActivities[i]["Name"]){return e.childActivities[i]}else{var r=e.childActivities[i].findChildById(t);if(r){return r}}}}return null}};function _DragNDrop(){var e=this;var t,i;var r=true;e.GetDrDr=function(){if(e.drdrop)return;e.drdrop=document.body.appendChild(document.createElement("DIV"));e.drdrop.style.display="none";e.drdrop.style.position="absolute";e.drdrop.style.zIndex="50000";e.drdrop.style.MozOpacity=.6;e.drdrop.style.opacity=.6;e.drdrop.style.filter="gray() alpha(opacity=60)";e.drdrop.style.border="1px solid #CCCCCC";e.drdrop.style.fontSize="12px";e.antiselect=document.body.appendChild(document.createElement("DIV"));e.antiselect.id="antiselect";e.antiselect.style.left="0";e.antiselect.style.top="0";e.antiselect.style.position="absolute";e.antiselect.style.MozUserSelect="none !important";e.antiselect.style.display="none";e.antiselect.style.backgroundColor="#FFFFFF";e.antiselect.style.MozOpacity=.01;e.antiselect.style.zIndex="100000";jsUtils.addEvent(document.body,"mousemove",e.Dragging);jsUtils.addEvent(document.body,"mouseup",e.Drop)};e.obj=null;e.StartDrag=function(t,i){e.obj=i;e.GetDrDr();if(!t)t=window.event;e.antiselect.style.display="block";var r=jsUtils.GetWindowScrollSize();e.antiselect.style.width=r.scrollWidth+"px";e.antiselect.style.height=r.scrollHeight+"px";e.antiselect.style.opacity=.01;e.antiselect.style.filter="gray() alpha(opacity=01)";e.dragging=true;e.drdrop.style.display="block";e.scrollPos=jsUtils.GetWindowScrollPos();e.drdrop.style.top=t.clientY+e.scrollPos.scrollTop+1+"px";e.drdrop.style.left=t.clientX+e.scrollPos.scrollLeft+1+"px";return e.drdrop};e.Handlers={};e.AddHandler=function(t,i){e.Handlers[t]=e.Handlers[t]||[];var r="i"+Math.random();e.Handlers[t][r]=i;return r};e.RemoveHandler=function(t,i){if(e.Handlers[t][i])delete e.Handlers[t][i]};e.Dragging=function(t){if(!e.dragging)return;if(!t)t=window.event;BX.fixEventPageXY(t);var i=t.pageX;var r=t.pageY;e.drdrop.style.left=i+1+"px";e.drdrop.style.top=r+1+"px";var n=BX.GetWindowInnerSize();var o=BX.GetWindowScrollPos();if(n.innerHeight-30<t.clientY)window.scrollBy(0,20);if(n.innerWidth-30<t.clientX)window.scrollBy(20,0);if(o.scrollTop>0&&t.clientY<30)window.scrollBy(0,-20);if(o.scrollLeft>0&&t.clientX<30)window.scrollBy(-20,0);if(document.selection&&document.selection.empty)document.selection.empty();else window.getSelection().removeAllRanges();for(var l in e.Handlers["ondragging"]){if(!e.Handlers["ondragging"].hasOwnProperty(l))continue;if(e.Handlers["ondragging"][l])e.Handlers["ondragging"][l](t,i,r)}};e._UnS=function(){if(e.antiselect)e.antiselect.style.display="none"};e.Drop=function(t){if(!e.dragging)return;if(!t)t=window.event;var i=jsUtils.GetWindowScrollPos();var r=t.clientX+i.scrollLeft+1+"px";var n=t.clientY+i.scrollTop+1+"px";for(var o in e.Handlers["ondrop"]){if(!e.Handlers["ondrop"].hasOwnProperty(o))continue;if(e.Handlers["ondrop"][o])e.Handlers["ondrop"][o](r,n,t)}e.dragging=false;e.drdrop.style.display="none";setTimeout(e._UnS,0)}}UnknownBizProcActivity=function(){var e=new BizProcActivity;e.Draw=function(t){e.div=t.appendChild(document.createElement("DIV"));e.div.className="activityerr";var i=e.div.appendChild(document.createElement("DIV"));i.className="activityhead";var r=i.appendChild(document.createElement("DIV"));r.className="activityheadr";var n=r.appendChild(document.createElement("DIV"));n.className="activityheadl";var o=n.appendChild(document.createElement("A"));o.className="activitydel";o.onclick=this.OnRemoveClick;var l=n.appendChild(document.createElement("DIV"));l.style.padding="5px";l.style.cursor="not-allowed";var a=e.div.appendChild(document.createElement("DIV"));a.style.backgroundColor="#E6E6E6";a.style.borderLeft="2px #bebabb solid";a.style.borderRight="2px #bebabb solid";a.style.overflowX="hidden";a.style.overflowY="hidden";a.style.height=e.activityHeight?e.activityHeight:"30px";var c=a.appendChild(document.createElement("DIV"));c.style.background="url(/bitrix/images/bizproc/act_icon.gif) left center no-repeat";c.style.height="30px";c.style.margin="2px";c.style.paddingLeft="24px";c.style.textAlign="left";c.innerHTML=HTMLEncode(e["Properties"]["Title"]);c.setAttribute("title",e["Properties"]["Title"]);var s=e.div.appendChild(document.createElement("DIV"));s.style.background="url(/bitrix/images/bizproc/act_bt.gif)";s.style.backgroundColor="#E6E6E6";s.style.height="4px";s.style.overflowY="hidden";var d=s.appendChild(document.createElement("DIV"));d.style.background="url(/bitrix/images/bizproc/act_br.gif) right top no-repeat";var p=d.appendChild(document.createElement("DIV"));p.style.background="url(/bitrix/images/bizproc/act_bl.gif) left top no-repeat";p.style.height="4px";e.div.style.margin="0 auto";e.div.style.width=e.activityWidth?e.activityWidth:"170px"};return e};BX.namespace("BX.Bizproc");BX.Bizproc.cloneTypeControl=function(e){var t=document.getElementById(e);var i=t.rows.length;var r=t.insertRow(i);var n=r.insertCell(0);var o=t.rows[i-1].cells[0].innerHTML;var l=0,a,c,s;while(true){a=o.indexOf("[n",l);if(a<0)break;c=o.indexOf("]",a);if(c<0)break;s=parseInt(o.substr(a+2,c-a));o=o.substr(0,a)+"[n"+ ++s+"]"+o.substr(c+1);l=a+1}l=0;while(true){a=o.indexOf("__n",l);if(a<0)break;c=o.indexOf("_",a+2);if(c<0)break;s=parseInt(o.substr(a+3,c-a));o=o.substr(0,a)+"__n"+ ++s+"_"+o.substr(c+1);l=c+1}n.innerHTML=o;var d=new RegExp("<"+"script"+">[^\0]*?<"+"/"+"script"+">","ig");var p=o.match(d);if(p){for(var f=0;f<p.length;f++){if(p[f]!=""){a=p[f].substring(8,p[f].length-9);jsUtils.EvalGlobal(a)}}}};BX.Bizproc.cloneTypeControlHtml=function(e,t){var i=document.getElementById(e);var r=i.rows.length;var n=i.insertRow(r);var o=n.insertCell(0);var l=i.rows[r-1].cells[0].innerHTML;var a=0,c,s,d=0;c=l.indexOf("[n",a);if(c>-1){s=l.indexOf("]",c);if(s>-1){d=parseInt(l.substr(c+2,s-c));++d}}BX.ajax({method:"GET",dataType:"html",url:"/bitrix/tools/bizproc_get_html_editor.php?site_id="+BX.message("SITE_ID")+"&editor_id="+t+"__n"+d+"_&field_name="+t+"[n"+d+"]",onsuccess:function(e){o.innerHTML=e}})};var DragNDrop=new _DragNDrop}