if(!BX.getClass("BX.Bizproc.UserSelector"))(function(e){"use strict";e.namespace("BX.Bizproc");var t=new WeakMap;var i=function(t,i){var a=this;if(!i){var n=t.getAttribute("data-config");i=n?e.parseJSON(n):null;t.removeAttribute("data-config")}if(!e.type.isPlainObject(i)){i={}}this.config=i;this.container=t||e.create("div");this.itemsNode=e.create("span");this.inputBoxNode=e.create("span",{attrs:{className:"feed-add-destination-input-box"}});this.inputNode=e.create("input",{props:{type:"text"},attrs:{className:"feed-add-destination-inp"}});this.inputBoxNode.appendChild(this.inputNode);this.tagNode=e.create("a",{attrs:{className:"feed-add-destination-link"}});this.container.appendChild(this.itemsNode);this.container.appendChild(this.inputBoxNode);this.container.appendChild(this.tagNode);this.data=null;this.dialogId="bp-user-selector-"+e.util.getRandomString(7);this.createValueNode(i.valueInputName||"");this.selected=i.selected?e.clone(i.selected):[];this.selectOne=!i.multiple;this.required=i.required||false;this.additionalFields=e.type.isArray(i.additionalFields)?i.additionalFields:[];e.bind(this.tagNode,"focus",function(e){e.preventDefault();a.openDialog({bByFocusEvent:true})});e.bind(this.container,"click",function(e){e.preventDefault();a.openDialog()});this.prepareRoles();if(i.value){this.selected=this.parseValue(i.value)}this.addItems(this.selected);this.tagNode.innerHTML=this.selected.length<=0?e.message("BIZPROC_JS_USER_SELECTOR_CHOOSE"):e.message("BIZPROC_JS_USER_SELECTOR_EDIT")};i.canUse=function(){return!!e.SocNetLogDestination};i.decorateNode=function(e,a){var n=t.get(e);if(!n){n=new i(e,a);t.set(e,n)}return n};i.prototype={getData:function(t){if(i.ajaxSent){return}i.ajaxSent=true;e.ajax({method:"POST",dataType:"json",url:"/bitrix/tools/bizproc/user_selector.php",data:{ajax_action:"get_destination_data",sessid:e.bitrix_sessid(),site:e.message("SITE_ID")},onsuccess:function(e){i.data=e.data||{};i.ajaxSent=false;this.initDialog(t)}.bind(this)})},initDialog:function(t){var a,n=this,s=i.data;if(!s){n.getData(t);return}var o={};for(a=0;a<n.selected.length;++a){o[n.selected[a].id]=n.selected[a].entityType}var d={users:s.users||{},department:s.department||{},departmentRelation:s.departmentRelation||{},bpuserroles:this.roles||{}};var r={users:s.last.USERS||{}};if(!d["departmentRelation"]){d["departmentRelation"]=e.SocNetLogDestination.buildDepartmentRelation(d["department"])}if(!n.inited){n.inited=true;var l=n.inputNode;l.id=n.dialogId+"input";var u=n.inputBoxNode;u.id=n.dialogId+"input-box";var p=this.tagNode;p.id=this.dialogId+"tag";var c=n.itemsNode;e.SocNetLogDestination.init({name:n.dialogId,searchInput:l,extranetUser:false,bindMainPopup:{node:n.container,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:n.container,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:false,sendAjaxSearch:true,callback:{select:function(t,i){n.addItem(t,i);if(n.selectOne)e.SocNetLogDestination.closeDialog()},unSelect:function(t,i){if(n.selectOne){return}n.unsetValue(t,i);e.SocNetLogDestination.BXfpUnSelectCallback.call({formName:n.dialogId,inputContainerName:c,inputName:l.id,tagInputName:p.id,tagLink1:e.message("BIZPROC_JS_USER_SELECTOR_CHOOSE"),tagLink2:e.message("BIZPROC_JS_USER_SELECTOR_EDIT")},t)},openDialog:e.delegate(e.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:u.id,inputName:l.id,tagInputName:p.id}),closeDialog:e.delegate(e.SocNetLogDestination.BXfpCloseDialogCallback,{inputBoxName:u.id,inputName:l.id,tagInputName:p.id}),openSearch:e.delegate(e.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:u.id,inputName:l.id,tagInputName:p.id}),closeSearch:e.delegate(e.SocNetLogDestination.BXfpCloseSearchCallback,{inputBoxName:u.id,inputName:l.id,tagInputName:p.id})},items:d,itemsLast:r,itemsSelected:o,useClientDatabase:false,destSort:s.DEST_SORT||{},allowAddUser:false});if(Object.keys(this.roles).length>0){e.onCustomEvent(e.SocNetLogDestination,"onTabsAdd",[n.dialogId,{id:"bpuserrole",name:e.message("BIZPROC_JS_USER_SELECTOR_ROLE_TAB"),itemType:"bpuserroles",dialogGroup:{groupCode:"bpuserroles",title:e.message("BIZPROC_JS_USER_SELECTOR_ROLE_TAB")}}])}e.bind(l,"keyup",e.delegate(e.SocNetLogDestination.BXfpSearch,{formName:n.dialogId,inputName:l.id,tagInputName:p.id}));e.bind(l,"keydown",e.delegate(e.SocNetLogDestination.BXfpSearchBefore,{formName:n.dialogId,inputName:l.id}));e.SocNetLogDestination.BXfpSetLinkName({formName:n.dialogId,tagInputName:p.id,tagLink1:e.message("BIZPROC_JS_USER_SELECTOR_CHOOSE"),tagLink2:e.message("BIZPROC_JS_USER_SELECTOR_EDIT")})}t()},addItem:function(t,i){var a=this;var n=this.inputNode;var s=this.tagNode;var o=this.itemsNode;if(!e.findChild(o,{attr:{"data-id":t.id}},false,false)){if(a.selectOne&&a.inited){var d=[];for(var r=0;r<o.childNodes.length;++r){d.push({itemId:o.childNodes[r].getAttribute("data-id"),itemType:o.childNodes[r].getAttribute("data-type")})}a.initDialog(function(){for(var t=0;t<d.length;++t){e.SocNetLogDestination.deleteItem(d[t].itemId,d[t].itemType,a.dialogId)}});e.cleanNode(o);a.cleanValue()}var l=this.createItemNode({text:t.name,deleteEvents:{click:function(n){if(a.selectOne&&a.required){a.openDialog()}else{a.initDialog(function(){e.SocNetLogDestination.deleteItem(t.id,i,a.dialogId);e.remove(l);a.unsetValue(t,i)})}n.preventDefault()}}});this.setValue(t,i);l.setAttribute("data-id",t.id);l.setAttribute("data-type",i);o.appendChild(l);if(!t.entityType){t.entityType=i}}n.value="";s.innerHTML=e.message("BIZPROC_JS_USER_SELECTOR_EDIT")},addItems:function(e){for(var t=0;t<e.length;++t){this.addItem(e[t],e[t].entityType)}},openDialog:function(t){var i=this;this.initDialog(function(){e.SocNetLogDestination.openDialog(i.dialogId,t)})},destroy:function(){if(this.inited){if(e.SocNetLogDestination.isOpenDialog()){e.SocNetLogDestination.closeDialog()}e.SocNetLogDestination.closeSearch()}},createItemNode:function(t){return e.create("span",{attrs:{className:"bizproc-type-control-user-item"},children:[e.create("span",{attrs:{className:"bizproc-type-control-user-name"},html:t.text||""}),e.create("span",{attrs:{className:"bizproc-type-control-user-delete"},events:t.deleteEvents})]})},createValueNode:function(t){this.valueNode=e.create("input",{props:{type:"hidden",name:t}});this.container.appendChild(this.valueNode)},setValue:function(t,i){var a=this.getValueId(t,i);var n=e.util.htmlspecialcharsback(t["name"]);n=n.replace(/,/g,"");var s=a;if(i==="users"){s=[n,a].join(" ")}else if(i==="department"){s=[n,a].join(" ")}if(this.selectOne){this.valueNode.value=s}else{var o,d=[],r=this.valueNode.value.split(",");for(o=0;o<r.length;++o){if(!r[o]||r[o].indexOf(a)>=0){continue}d.push(r[o])}d.push(s);this.valueNode.value=d.join(",")}},unsetValue:function(e,t){var i=this.getValueId(e,t);if(this.selectOne){this.valueNode.value=""}else{var a,n=[],s=this.valueNode.value.split(",");for(a=0;a<s.length;++a){if(!s[a]||s[a].indexOf(i)>=0){continue}n.push(s[a])}this.valueNode.value=n.join(",")}},getValueId:function(e,t){var i=e["id"].toString();if(t==="users"){i="["+e.entityId+"]"}else if(t==="department"||t==="bpuserroles"&&i.indexOf("G")===0){i="["+i+"]"}return i},cleanValue:function(){this.valueNode.value=""},parseValue:function(t){t=this.prepareValueString(t);var i,a,n,s,o,d=[],r,l=t.split(","),u,p;for(i=0;i<l.length;++i){r=e.util.trim(l[i]);if(u=r.match(/(.*)\[([A-Z]{0,2})(\d+)\]/)){a=e.util.trim(u[1]);s=u[3];n=u[2]+s;o=u[2]===""?"users":"bpuserroles";if(u[2]==="DR"){o="department"}d.push({id:n,entityId:parseInt(s),name:a,entityType:o})}else{p=false;if(this.roles[r]){p=true;d.push(this.roles[r])}if(!p&&this.config.groups){this.config.groups.forEach(function(e){if(r===e["name"]){p=true;d.push({id:e["id"],entityId:e["id"],name:e["name"],entityType:"bpuserroles"})}})}if(!p){d.push({id:r,entityId:r,name:r,entityType:"bpuserroles"})}}}return d},prepareValueString:function(t){t=t.toString();if(t.indexOf("{{")>=0){var i=e.Bizproc.FieldType.getDocumentFields();i.forEach(function(e){if(e["Type"]==="user"){t=t.replace(e["Expression"],e["SystemExpression"])}})}return t},prepareRoles:function(){var t=e.Bizproc.FieldType.getDocumentFields();var i={};if(this.config.groups){this.config.groups.forEach(function(e){i[e["id"]]={id:e["id"],entityId:e["id"],name:e["name"],entityType:"bpuserroles"}})}t.forEach(function(e){if(e["Type"]==="user"){i[e["SystemExpression"]]={id:e["SystemExpression"],entityId:e["SystemExpression"],name:e["Name"],entityType:"bpuserroles"}}});this.additionalFields.forEach(function(e){e.entityType="bpuserroles";i[e["id"]]=e});this.roles=i}};e.Bizproc.UserSelector=i})(window.BX||window.top.BX);
//# sourceMappingURL=user_selector.map.js