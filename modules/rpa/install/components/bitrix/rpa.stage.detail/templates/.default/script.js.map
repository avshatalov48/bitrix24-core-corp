{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {Reflection, Event, Type, Loc, Uri, ajax as Ajax} from 'main.core';\nimport {Component} from 'rpa.component';\nimport {FieldsPopup} from 'rpa.fieldspopup';\n\nconst namespace = Reflection.namespace('BX.Rpa');\n\nclass StageComponent extends Component\n{\n\tgetPermissionSelectors()\n\t{\n\t\treturn [\n\t\t\t{action: 'VIEW', selector: '[data-role=\"permission-setting-view\"]'},\n\t\t\t{action: 'MODIFY', selector: '[data-role=\"permission-setting-create\"]'},\n\t\t\t{action: 'MODIFY', selector: '[data-role=\"permission-setting-modify\"]'},\n\t\t\t{action: 'MOVE', selector: '[data-role=\"permission-setting-move\"]'},\n\t\t];\n\t}\n\n\tconstructor(...args)\n\t{\n\t\tsuper(...args);\n\n\t\tthis.popups = {};\n\t\tif(args[1].fields && Type.isPlainObject(args[1].fields))\n\t\t{\n\t\t\tfor(let [visibility, settings] of Object.entries(args[1].fields))\n\t\t\t{\n\t\t\t\tthis.popups[visibility] = new FieldsPopup('stage-' + visibility + '-fields', settings.fields, settings.title);\n\t\t\t\tthis.bindFieldButton(document.getElementById(settings.id), this.popups[visibility]);\n\t\t\t}\n\t\t}\n\t}\n\n\tinit()\n\t{\n\t\tsuper.init();\n\n\t\tthis.adjustDeleteButtonVisibility();\n\t}\n\n\tadjustDeleteButtonVisibility()\n\t{\n\t\tlet data = this.prepareData();\n\t\tif(data.id && data.id > 0)\n\t\t{\n\t\t\tthis.deleteButton.style.display = 'block';\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.deleteButton.style.display = 'none';\n\t\t}\n\t}\n\n\tbindFieldButton(node, popup)\n\t{\n\t\tEvent.bind(node, 'click', (event) =>\n\t\t{\n\t\t\tevent.preventDefault();\n\t\t\tpopup.show();\n\t\t});\n\t}\n\n\tprepareData()\n\t{\n\t\tlet data = {};\n\t\tlet fields = {};\n\t\tfields.typeId = this.form.querySelector('[name=\"typeId\"]').value;\n\t\tlet id = this.form.querySelector('[name=\"id\"]').value;\n\t\tif(id > 0)\n\t\t{\n\t\t\tdata.id = id;\n\t\t}\n\t\tfields.name = this.form.querySelector('[name=\"name\"]').value;\n\t\tfields.code = this.form.querySelector('[name=\"code\"]').value;\n\t\tfields.permissions = this.getPermissions();\n\n\t\tfields.fields = {};\n\t\tfor(let [visibility, popup] of Object.entries(this.popups))\n\t\t{\n\t\t\tfields.fields[visibility] = Array.from(popup.getSelectedFields());\n\t\t}\n\n\t\tfields.possibleNextStages = this.getPossibleNextStages();\n\n\t\tdata.fields = fields;\n\n\t\treturn data;\n\t}\n\n\tgetPossibleNextStages()\n\t{\n\t\tlet stages = [];\n\t\tlet select = this.form.querySelector('[name=\"possibleNextStages[]\"]');\n\t\tlet options = select.querySelectorAll('option');\n\t\toptions.forEach((option) =>\n\t\t{\n\t\t\tif(option.selected)\n\t\t\t{\n\t\t\t\tstages.push(option.value);\n\t\t\t}\n\t\t});\n\n\t\treturn stages;\n\t}\n\n\tafterSave(result)\n\t{\n\t\tsuper.afterSave(result);\n\t\tlet slider = this.getSlider();\n\t\tif(slider)\n\t\t{\n\t\t\tslider.close();\n\t\t\treturn;\n\t\t}\n\t\tlet title = Loc.getMessage('RPA_STAGE_DETAIL_TITLE').replace('#TITLE#', result.data.stage.name);\n\t\tif(this.method === 'rpa.stage.add')\n\t\t{\n\t\t\tlet stageId = result.data.stage.id;\n\t\t\tlet url = new Uri(location.href);\n\t\t\turl.setQueryParam('id', result.data.stage.id);\n\t\t\twindow.history.pushState({}, title, url.toString());\n\t\t\tthis.form.querySelector('[name=\"id\"]').value = stageId;\n\t\t\tthis.method = 'rpa.stage.update';\n\t\t\tthis.analyticsLabel = 'rpaStageUpdate';\n\t\t}\n\t\tthis.adjustDeleteButtonVisibility();\n\t\tdocument.getElementById('pagetitle').innerText = title;\n\t}\n\n\tdelete(event)\n\t{\n\t\tevent.preventDefault();\n\t\tif(this.isProgress)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet data = this.prepareData();\n\t\tif(data.id > 0)\n\t\t{\n\t\t\tdata = {id: data.id};\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif(confirm(Loc.getMessage('RPA_STAGE_DELETE_CONFIRM')))\n\t\t{\n\t\t\tthis.startProgress();\n\t\t\tAjax.runAction('rpa.stage.delete', {\n\t\t\t\tanalyticsLabel: 'rpaStageDelete',\n\t\t\t\tdata: data,\n\t\t\t}).then((result) =>\n\t\t\t{\n\t\t\t\tthis.afterDelete(result);\n\t\t\t\tthis.stopProgress();\n\t\t\t}).catch((result) =>\n\t\t\t{\n\t\t\t\tthis.showErrors(result.errors);\n\t\t\t\tthis.stopProgress();\n\t\t\t});\n\t\t}\n\t}\n\n\tafterDelete()\n\t{\n\t\tthis.cancelButton.click();\n\t}\n}\n\nnamespace.StageComponent = StageComponent;"],"names":["namespace","Reflection","StageComponent","action","selector","args","popups","fields","Type","isPlainObject","Object","entries","visibility","settings","FieldsPopup","title","bindFieldButton","document","getElementById","id","adjustDeleteButtonVisibility","data","prepareData","deleteButton","style","display","node","popup","Event","bind","event","preventDefault","show","typeId","form","querySelector","value","name","code","permissions","getPermissions","Array","from","getSelectedFields","possibleNextStages","getPossibleNextStages","stages","select","options","querySelectorAll","forEach","option","selected","push","result","slider","getSlider","close","Loc","getMessage","replace","stage","method","stageId","url","Uri","location","href","setQueryParam","window","history","pushState","toString","analyticsLabel","innerText","isProgress","confirm","startProgress","Ajax","runAction","then","afterDelete","stopProgress","catch","showErrors","errors","cancelButton","click","Component"],"mappings":"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"}