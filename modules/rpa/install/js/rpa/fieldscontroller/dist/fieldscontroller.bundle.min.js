this.BX=this.BX||{};(function(e,t,i,r,n,l,s,a){"use strict";var d,o,u,c,f,h,g,p,v,y,F,T,C,m;var S=function(){function e(r){var n=this;babelHelpers.classCallCheck(this,e);l.EventEmitter.makeObservable(this,"BX.Rpa.FieldsController");this.fields=new Map;this.hiddenFields=new Map;this.layout={};this.fieldSubTitle=t.Loc.getMessage("RPA_FIELDS_SELECTOR_FIELD_DEFAULT_SUBTITLE");this.errorContainer=null;this.progress=false;if(t.Type.isPlainObject(r)){if(r.factory instanceof i.Factory){this.factory=r.factory}if(t.Type.isPlainObject(r.fields)){this.setFields(r.fields)}if(t.Type.isPlainObject(r.hiddenFields)){this.setHiddenFields(r.hiddenFields)}if(t.Type.isString(r.fieldSubTitle)){this.fieldSubTitle=r.fieldSubTitle}if(t.Type.isDomNode(r.errorContainer)){this.errorContainer=r.errorContainer}if(t.Type.isPlainObject(r.settings)){this.settings=r.settings;if(!t.Type.isString(this.settings.inputName)){this.settings.inputName=""}if(!t.Type.isPlainObject(this.settings.values)){this.settings.values={}}}this.typeId=t.Text.toInteger(r.typeId);this.languageId=r.languageId||t.Loc.getMessage("LANGUAGE_ID");if(this.factory){this.factory.setCustomTypesUrl(a.Manager.Instance.getFieldDetailUrl(this.typeId,0));this.factory.subscribe("onCreateCustomUserField",(function(e){var t=e.getData().userField;n.addField(t).renderFields()}))}}}babelHelpers.createClass(e,[{key:"getFields",value:function e(){return this.fields}},{key:"setFields",value:function e(t){var i=this;Object.keys(t).forEach((function(e){i.addField(new r.UserField(t[e],{languageId:i.languageId,moduleId:i.factory?i.factory.moduleId:null}))}));return this}},{key:"addField",value:function e(t){this.fields.set(t.getName(),t);return this}},{key:"removeField",value:function e(t){this.fields["delete"](t.getName());return this}},{key:"setHiddenFields",value:function e(t){var i=this;Object.keys(t).forEach((function(e){i.addHiddenField(new r.UserField(t[e],{languageId:i.languageId,moduleId:i.factory?i.factory.moduleId:null}))}));return this}},{key:"addHiddenField",value:function e(t){this.hiddenFields.set(t.getName(),t);return this}},{key:"removeHiddenField",value:function e(t){this.hiddenFields["delete"](t.getName());return this}},{key:"render",value:function e(){var i=this.renderContainer();i.appendChild(this.renderFields());if(this.factory){this.layout.configurator=t.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(["<div></div>"])));i.appendChild(this.layout.configurator);i.appendChild(this.renderFooter())}return i}},{key:"renderContainer",value:function e(){this.layout.container=t.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-container"></div>'])));return this.getContainer()}},{key:"getContainer",value:function e(){return this.layout.container}},{key:"renderFields",value:function e(){var i=this;if(this.layout.fieldsContainer){t.Dom.clean(this.layout.fieldsContainer);if(this.settings){this.settings.values=this.getSettings()}}else{this.layout.fieldsContainer=t.Tag.render(u||(u=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-fields"></div>'])))}Array.from(this.fields.values()).forEach((function(e){i.layout.fieldsContainer.appendChild(i.renderField(e))}));return this.layout.fieldsContainer}},{key:"getFieldRow",value:function e(t){if(!this.layout.fieldsContainer){return null}return this.layout.fieldsContainer.querySelector('[data-role="field-row-'.concat(t.getName(),'"]'))}},{key:"renderField",value:function e(i){var r=this;var n=t.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-field-row" data-role="field-row-','"></div>'])),i.getName());var l=t.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-field-container"></div>'])));if(this.fieldSubTitle){l.appendChild(t.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-field-subtitle">',"</div>"])),t.Text.encode(this.fieldSubTitle)))}l.appendChild(t.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-field-title">',"</div>"])),t.Text.encode(i.getTitle())));var s=t.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-field-wrapper"></div>'])));s.appendChild(l);if(this.settings){s.appendChild(this.renderSwitcher(i))}else{var a=t.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-field-wrapper-gear"></div>'])));this.getSettingsMenu(a,i).destroy();t.Event.bind(a,"click",(function(){r.getSettingsMenu(a,i).show()}));s.appendChild(a)}n.appendChild(s);n.appendChild(t.Tag.render(y||(y=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-field-settings"></div>']))));return n}},{key:"renderSwitcher",value:function i(r){var n={id:e.getSwitcherId(this.settings.inputName,r.getName()),checked:this.settings.values[r.getName()]===true,inputName:this.settings.inputName+"["+r.getName()+"]"};var l=t.Tag.render(F||(F=babelHelpers.taggedTemplateLiteral(["<span data-switcher='",'\' class="ui-switcher rpa-fields-controller-switcher"></span>'])),JSON.stringify(n));new BX.UI.Switcher({node:l});return l}},{key:"renderFooter",value:function e(){if(!this.layout.footer){this.layout.footer=t.Tag.render(T||(T=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-footer">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t</div>"])),this.getSelectButton(),this.getCreateButton())}this.updateSelectButtonAppearance();return this.layout.footer}},{key:"updateSelectButtonAppearance",value:function e(){if(this.hiddenFields.size<=0){this.getSelectButton().style.display="none"}else{this.getSelectButton().style.display="inline-block"}return this}},{key:"getCreateButton",value:function e(){if(!this.layout.createButton){this.layout.createButton=t.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-create-field-button" onclick="','">',"</div>"])),this.handleCreateButtonClick.bind(this),t.Loc.getMessage("RPA_FIELDS_SELECTOR_FILED_CREATE_BUTTON"))}return this.layout.createButton}},{key:"handleCreateButtonClick",value:function e(){if(this.factory){this.factory.getMenu({bindElement:this.getCreateButton()}).open(this.handleUserFieldTypeClick.bind(this))}}},{key:"getSelectButton",value:function e(){if(!this.layout.selectButton){this.layout.selectButton=t.Tag.render(m||(m=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-select-field-button" onclick="','">',"</div>"])),this.handleSelectButtonClick.bind(this),t.Loc.getMessage("RPA_FIELDS_SELECTOR_FIELD_SELECT_BUTTON"))}return this.layout.selectButton}},{key:"handleSelectButtonClick",value:function e(){this.getSelectFieldsMenu().show()}},{key:"handleUserFieldTypeClick",value:function e(t){if(!this.factory){return}var i=this.factory.createUserField(t);if(!i){return}this.showFieldConfigurator(i)}},{key:"showFieldConfigurator",value:function e(i){var r=this;if(i.isSaved()){var n=this.getFieldRow(i);if(n){var l=n.querySelector(".rpa-fields-controller-field-settings");if(l){n.classList.add("rpa-fields-controller-edit");t.Dom.clean(l);l.appendChild(this.factory.getConfigurator({userField:i,onSave:this.handleFieldSave.bind(this),onCancel:function e(){r.hideFieldConfigurator(i)}}).render())}}}else{t.Dom.clean(this.layout.configurator);this.layout.configurator.appendChild(this.factory.getConfigurator({userField:i,onSave:this.handleFieldSave.bind(this)}).render())}}},{key:"hideFieldConfigurator",value:function e(i){var r=this.getFieldRow(i);if(r){r.classList.remove("rpa-fields-controller-edit");var n=r.querySelector(".rpa-fields-controller-field-settings");if(n){t.Dom.clean(n)}}}},{key:"handleFieldSave",value:function e(i){var r=this;if(!this.factory){return}if(this.isProgress()){return}this.startProgress();i.save().then((function(){r.stopProgress().addField(i).renderFields();t.Dom.clean(r.layout.configurator);r.emit("onFieldSave",{userField:i})}))["catch"]((function(e){r.stopProgress();r.showError(e)}))}},{key:"isProgress",value:function e(){return this.progress}},{key:"startProgress",value:function e(){this.progress=true;if(!this.getLoader().isShown()){this.getLoader().show(this.getContainer())}return this}},{key:"stopProgress",value:function e(){this.progress=false;this.getLoader().hide();return this}},{key:"getLoader",value:function e(){if(!this.loader){this.loader=new n.Loader({size:150})}return this.loader}},{key:"showError",value:function e(i,r){if(!r){r=this.errorContainer}var n="";if(t.Type.isArray(i)){n=i.join(", ")}else if(t.Type.isString(i)){n=i}if(n){if(t.Type.isDomNode(r)){r.innerHTML=n;r.parentNode.style.display="block";window.scrollTo(0,t.Dom.getPosition(r).top)}else{console.error(n)}}}},{key:"getSettings",value:function t(){var i=this;var r={};if(!this.settings){return r}Array.from(this.fields.values()).forEach((function(t){var n=BX.UI.Switcher.getById(e.getSwitcherId(i.settings.inputName,t.getName()));if(n){r[t.getName()]=n.isChecked()}}));return r}},{key:"getSelectFieldsMenuId",value:function e(){return"rpa-fieldscontorller-select-field-menu"}},{key:"getSelectFieldsMenuItems",value:function e(){var i=this;var r=[];Array.from(this.hiddenFields.values()).forEach((function(e){r.push({text:t.Text.encode(e.getTitle()),onclick:function t(){i.handleHiddenUserFieldClick(e)}})}));return r}},{key:"getSelectFieldsMenu",value:function e(){var t=this;if(!this.getSelectButton()){return}return s.MenuManager.create({id:this.getSelectFieldsMenuId(),bindElement:this.getSelectButton(),items:this.getSelectFieldsMenuItems(),offsetTop:0,offsetLeft:16,angle:{position:"top",offset:0},events:{onPopupClose:function e(){t.getSelectFieldsMenu().destroy()}}})}},{key:"handleHiddenUserFieldClick",value:function e(t){this.addField(t).removeHiddenField(t).updateSelectButtonAppearance().renderFields();this.getSelectFieldsMenu().close()}},{key:"getSettingsMenu",value:function e(i,n){var l=this;return s.MenuManager.create({id:"rpa-fieldscontroller-field-settings-"+n.getId(),bindElement:i,items:[{text:t.Loc.getMessage("RPA_FIELDS_SELECTOR_CONFIGURATOR_ACTION_HIDE"),onclick:function e(t,i){l.removeField(n).addHiddenField(n).updateSelectButtonAppearance().renderFields();if(i&&i.menuWindow){i.menuWindow.close()}}},{text:t.Loc.getMessage("RPA_FIELDS_SELECTOR_CONFIGURATOR_ACTION_EDIT"),onclick:function e(t,i){l.showFieldConfigurator(n);if(i&&i.menuWindow){i.menuWindow.close()}}},{text:t.Loc.getMessage("RPA_FIELDS_SELECTOR_CONFIGURATOR_ACTION_ADJUST"),onclick:function e(t,i){a.Manager.Instance.openFieldDetail(l.typeId,n.getId(),{width:900,cacheable:false}).then((function(e){var t=e.getData().get("userFieldData");if(t){n=r.UserField.unserialize(t);if(n.isDeleted()){l.removeField(n).renderFields()}else{l.addField(n);l.renderFields()}}}));if(i&&i.menuWindow){i.menuWindow.close()}}}]})}}],[{key:"getSwitcherId",value:function e(t,i){return"rpa-fields-controller-"+t+"-"+i}}]);return e}();e.FieldsController=S})(this.BX.Rpa=this.BX.Rpa||{},BX,BX.UI.UserFieldFactory,BX.UI.UserField,BX,BX.Event,BX.Main,BX.Rpa);
//# sourceMappingURL=fieldscontroller.bundle.map.js