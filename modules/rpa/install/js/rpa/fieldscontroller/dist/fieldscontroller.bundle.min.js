this.BX=this.BX||{};(function(e,t,i,n,r,l,s,a){"use strict";function o(){var e=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-select-field-button" onclick="','">',"</div>"]);o=function t(){return e};return e}function d(){var e=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-create-field-button" onclick="','">',"</div>"]);d=function t(){return e};return e}function u(){var e=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-footer">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t</div>"]);u=function t(){return e};return e}function c(){var e=babelHelpers.taggedTemplateLiteral(["<span data-switcher='",'\' class="ui-switcher rpa-fields-controller-switcher"></span>']);c=function t(){return e};return e}function f(){var e=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-field-settings"></div>']);f=function t(){return e};return e}function h(){var e=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-field-wrapper-gear"></div>']);h=function t(){return e};return e}function g(){var e=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-field-wrapper"></div>']);g=function t(){return e};return e}function p(){var e=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-field-title">',"</div>"]);p=function t(){return e};return e}function v(){var e=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-field-subtitle">',"</div>"]);v=function t(){return e};return e}function y(){var e=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-field-container"></div>']);y=function t(){return e};return e}function F(){var e=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-field-row" data-role="field-row-','"></div>']);F=function t(){return e};return e}function T(){var e=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-fields"></div>']);T=function t(){return e};return e}function C(){var e=babelHelpers.taggedTemplateLiteral(['<div class="rpa-fields-controller-container"></div>']);C=function t(){return e};return e}function m(){var e=babelHelpers.taggedTemplateLiteral(["<div></div>"]);m=function t(){return e};return e}var S=function(){function e(n){var r=this;babelHelpers.classCallCheck(this,e);l.EventEmitter.makeObservable(this,"BX.Rpa.FieldsController");this.fields=new Map;this.hiddenFields=new Map;this.layout={};this.fieldSubTitle=t.Loc.getMessage("RPA_FIELDS_SELECTOR_FIELD_DEFAULT_SUBTITLE");this.errorContainer=null;this.progress=false;if(t.Type.isPlainObject(n)){if(n.factory instanceof i.Factory){this.factory=n.factory}if(t.Type.isPlainObject(n.fields)){this.setFields(n.fields)}if(t.Type.isPlainObject(n.hiddenFields)){this.setHiddenFields(n.hiddenFields)}if(t.Type.isString(n.fieldSubTitle)){this.fieldSubTitle=n.fieldSubTitle}if(t.Type.isDomNode(n.errorContainer)){this.errorContainer=n.errorContainer}if(t.Type.isPlainObject(n.settings)){this.settings=n.settings;if(!t.Type.isString(this.settings.inputName)){this.settings.inputName=""}if(!t.Type.isPlainObject(this.settings.values)){this.settings.values={}}}this.typeId=t.Text.toInteger(n.typeId);this.languageId=n.languageId||t.Loc.getMessage("LANGUAGE_ID");if(this.factory){this.factory.setCustomTypesUrl(a.Manager.Instance.getFieldDetailUrl(this.typeId,0));this.factory.subscribe("onCreateCustomUserField",function(e){var t=e.getData().userField;r.addField(t).renderFields()})}}}babelHelpers.createClass(e,[{key:"getFields",value:function e(){return this.fields}},{key:"setFields",value:function e(t){var i=this;Object.keys(t).forEach(function(e){i.addField(new n.UserField(t[e],{languageId:i.languageId,moduleId:i.factory?i.factory.moduleId:null}))});return this}},{key:"addField",value:function e(t){this.fields.set(t.getName(),t);return this}},{key:"removeField",value:function e(t){this.fields.delete(t.getName());return this}},{key:"setHiddenFields",value:function e(t){var i=this;Object.keys(t).forEach(function(e){i.addHiddenField(new n.UserField(t[e],{languageId:i.languageId,moduleId:i.factory?i.factory.moduleId:null}))});return this}},{key:"addHiddenField",value:function e(t){this.hiddenFields.set(t.getName(),t);return this}},{key:"removeHiddenField",value:function e(t){this.hiddenFields.delete(t.getName());return this}},{key:"render",value:function e(){var i=this.renderContainer();i.appendChild(this.renderFields());if(this.factory){this.layout.configurator=t.Tag.render(m());i.appendChild(this.layout.configurator);i.appendChild(this.renderFooter())}return i}},{key:"renderContainer",value:function e(){this.layout.container=t.Tag.render(C());return this.getContainer()}},{key:"getContainer",value:function e(){return this.layout.container}},{key:"renderFields",value:function e(){var i=this;if(this.layout.fieldsContainer){t.Dom.clean(this.layout.fieldsContainer);if(this.settings){this.settings.values=this.getSettings()}}else{this.layout.fieldsContainer=t.Tag.render(T())}Array.from(this.fields.values()).forEach(function(e){i.layout.fieldsContainer.appendChild(i.renderField(e))});return this.layout.fieldsContainer}},{key:"getFieldRow",value:function e(t){if(!this.layout.fieldsContainer){return null}return this.layout.fieldsContainer.querySelector('[data-role="field-row-'.concat(t.getName(),'"]'))}},{key:"renderField",value:function e(i){var n=this;var r=t.Tag.render(F(),i.getName());var l=t.Tag.render(y());if(this.fieldSubTitle){l.appendChild(t.Tag.render(v(),t.Text.encode(this.fieldSubTitle)))}l.appendChild(t.Tag.render(p(),t.Text.encode(i.getTitle())));var s=t.Tag.render(g());s.appendChild(l);if(this.settings){s.appendChild(this.renderSwitcher(i))}else{var a=t.Tag.render(h());this.getSettingsMenu(a,i).destroy();t.Event.bind(a,"click",function(){n.getSettingsMenu(a,i).show()});s.appendChild(a)}r.appendChild(s);r.appendChild(t.Tag.render(f()));return r}},{key:"renderSwitcher",value:function i(n){var r={id:e.getSwitcherId(this.settings.inputName,n.getName()),checked:this.settings.values[n.getName()]===true,inputName:this.settings.inputName+"["+n.getName()+"]"};var l=t.Tag.render(c(),JSON.stringify(r));new BX.UI.Switcher({node:l});return l}},{key:"renderFooter",value:function e(){if(!this.layout.footer){this.layout.footer=t.Tag.render(u(),this.getSelectButton(),this.getCreateButton())}this.updateSelectButtonAppearance();return this.layout.footer}},{key:"updateSelectButtonAppearance",value:function e(){if(this.hiddenFields.size<=0){this.getSelectButton().style.display="none"}else{this.getSelectButton().style.display="inline-block"}return this}},{key:"getCreateButton",value:function e(){if(!this.layout.createButton){this.layout.createButton=t.Tag.render(d(),this.handleCreateButtonClick.bind(this),t.Loc.getMessage("RPA_FIELDS_SELECTOR_FILED_CREATE_BUTTON"))}return this.layout.createButton}},{key:"handleCreateButtonClick",value:function e(){if(this.factory){this.factory.getMenu({bindElement:this.getCreateButton()}).open(this.handleUserFieldTypeClick.bind(this))}}},{key:"getSelectButton",value:function e(){if(!this.layout.selectButton){this.layout.selectButton=t.Tag.render(o(),this.handleSelectButtonClick.bind(this),t.Loc.getMessage("RPA_FIELDS_SELECTOR_FIELD_SELECT_BUTTON"))}return this.layout.selectButton}},{key:"handleSelectButtonClick",value:function e(){this.getSelectFieldsMenu().show()}},{key:"handleUserFieldTypeClick",value:function e(t){if(!this.factory){return}var i=this.factory.createUserField(t);if(!i){return}this.showFieldConfigurator(i)}},{key:"showFieldConfigurator",value:function e(i){var n=this;if(i.isSaved()){var r=this.getFieldRow(i);if(r){var l=r.querySelector(".rpa-fields-controller-field-settings");if(l){r.classList.add("rpa-fields-controller-edit");t.Dom.clean(l);l.appendChild(this.factory.getConfigurator({userField:i,onSave:this.handleFieldSave.bind(this),onCancel:function e(){n.hideFieldConfigurator(i)}}).render())}}}else{t.Dom.clean(this.layout.configurator);this.layout.configurator.appendChild(this.factory.getConfigurator({userField:i,onSave:this.handleFieldSave.bind(this)}).render())}}},{key:"hideFieldConfigurator",value:function e(i){var n=this.getFieldRow(i);if(n){n.classList.remove("rpa-fields-controller-edit");var r=n.querySelector(".rpa-fields-controller-field-settings");if(r){t.Dom.clean(r)}}}},{key:"handleFieldSave",value:function e(i){var n=this;if(!this.factory){return}if(this.isProgress()){return}this.startProgress();i.save().then(function(){n.stopProgress().addField(i).renderFields();t.Dom.clean(n.layout.configurator);n.emit("onFieldSave",{userField:i})}).catch(function(e){n.stopProgress();n.showError(e)})}},{key:"isProgress",value:function e(){return this.progress}},{key:"startProgress",value:function e(){this.progress=true;if(!this.getLoader().isShown()){this.getLoader().show(this.getContainer())}return this}},{key:"stopProgress",value:function e(){this.progress=false;this.getLoader().hide();return this}},{key:"getLoader",value:function e(){if(!this.loader){this.loader=new r.Loader({size:150})}return this.loader}},{key:"showError",value:function e(i,n){if(!n){n=this.errorContainer}var r="";if(t.Type.isArray(i)){r=i.join(", ")}else if(t.Type.isString(i)){r=i}if(r){if(t.Type.isDomNode(n)){n.innerHTML=r;n.parentNode.style.display="block";window.scrollTo(0,t.Dom.getPosition(n).top)}else{console.error(r)}}}},{key:"getSettings",value:function t(){var i=this;var n={};if(!this.settings){return n}Array.from(this.fields.values()).forEach(function(t){var r=BX.UI.Switcher.getById(e.getSwitcherId(i.settings.inputName,t.getName()));if(r){n[t.getName()]=r.isChecked()}});return n}},{key:"getSelectFieldsMenuId",value:function e(){return"rpa-fieldscontorller-select-field-menu"}},{key:"getSelectFieldsMenuItems",value:function e(){var t=this;var i=[];Array.from(this.hiddenFields.values()).forEach(function(e){i.push({text:e.getTitle(),onclick:function i(){t.handleHiddenUserFieldClick(e)}})});return i}},{key:"getSelectFieldsMenu",value:function e(){var t=this;if(!this.getSelectButton()){return}return s.MenuManager.create({id:this.getSelectFieldsMenuId(),bindElement:this.getSelectButton(),items:this.getSelectFieldsMenuItems(),offsetTop:0,offsetLeft:16,angle:{position:"top",offset:0},events:{onPopupClose:function e(){t.getSelectFieldsMenu().destroy()}}})}},{key:"handleHiddenUserFieldClick",value:function e(t){this.addField(t).removeHiddenField(t).updateSelectButtonAppearance().renderFields();this.getSelectFieldsMenu().close()}},{key:"getSettingsMenu",value:function e(i,r){var l=this;return s.MenuManager.create({id:"rpa-fieldscontroller-field-settings-"+r.getId(),bindElement:i,items:[{text:t.Loc.getMessage("RPA_FIELDS_SELECTOR_CONFIGURATOR_ACTION_HIDE"),onclick:function e(t,i){l.removeField(r).addHiddenField(r).updateSelectButtonAppearance().renderFields();if(i&&i.menuWindow){i.menuWindow.close()}}},{text:t.Loc.getMessage("RPA_FIELDS_SELECTOR_CONFIGURATOR_ACTION_EDIT"),onclick:function e(t,i){l.showFieldConfigurator(r);if(i&&i.menuWindow){i.menuWindow.close()}}},{text:t.Loc.getMessage("RPA_FIELDS_SELECTOR_CONFIGURATOR_ACTION_ADJUST"),onclick:function e(t,i){a.Manager.Instance.openFieldDetail(l.typeId,r.getId(),{width:900,cacheable:false}).then(function(e){var t=e.getData().get("userFieldData");if(t){r=n.UserField.unserialize(t);if(r.isDeleted()){l.removeField(r).renderFields()}else{l.addField(r);l.renderFields()}}});if(i&&i.menuWindow){i.menuWindow.close()}}}]})}}],[{key:"getSwitcherId",value:function e(t,i){return"rpa-fields-controller-"+t+"-"+i}}]);return e}();e.FieldsController=S})(this.BX.Rpa=this.BX.Rpa||{},BX,BX.UI.UserFieldFactory,BX.UI.UserField,BX,BX.Event,BX.Main,BX.Rpa);
//# sourceMappingURL=fieldscontroller.bundle.map.js