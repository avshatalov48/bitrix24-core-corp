this.BX=this.BX||{};(function(t,e,n,i,a,s,r,o,l,u,d,c){"use strict";var g=function(){function t(e){var n=this;babelHelpers.classCallCheck(this,t);this.eventIds=new Set;if(e instanceof r.Kanban.Grid){this.grid=e;if(o.Type.isArray(this.grid.getData().eventIds)){this.grid.getData().eventIds.forEach((function(t){n.eventIds.add(t)}))}if(o.Type.isString(e.getData().pullTag)&&o.Type.isString(e.getData().moduleId)&&e.getData().userId>0){this.init()}}}babelHelpers.createClass(t,[{key:"registerEventId",value:function t(e){this.eventIds.add(e)}},{key:"registerRandomEventId",value:function t(){var e=o.Text.getRandom();this.registerEventId(e);return e}},{key:"init",value:function t(){var e=this;o.Event.ready((function(){var t=BX.PULL;if(!t){console.error("pull is not initialized");return}if(o.Type.isString(e.grid.getData().pullTag)){t.subscribe({moduleId:e.grid.getData().moduleId,command:e.grid.getData().pullTag,callback:function t(n){if(o.Type.isString(n.eventName)){if(o.Type.isString(n.eventId)){if(e.eventIds.has(n.eventId)){return}}if(n.eventName.indexOf("ITEMUPDATED"+e.grid.getTypeId())===0&&o.Type.isPlainObject(n.item)){e.onPullItemUpdated(n)}else if(n.eventName==="ITEMADDED"+e.grid.getTypeId()&&o.Type.isPlainObject(n.item)){e.onPullItemAdded(n)}else if(n.eventName.indexOf("ITEMDELETED"+e.grid.getTypeId())===0&&o.Type.isPlainObject(n.item)){e.onPullItemDeleted(n)}else if(n.eventName==="STAGEADDED"+e.grid.getTypeId()&&o.Type.isPlainObject(n.stage)){e.onPullStageAdded(n)}else if(n.eventName.indexOf("STAGEUPDATED"+e.grid.getTypeId())===0&&o.Type.isPlainObject(n.stage)){e.onPullStageUpdated(n)}else if(n.eventName.indexOf("STAGEDELETED"+e.grid.getTypeId())===0&&o.Type.isPlainObject(n.stage)){e.onPullStageDeleted(n)}else if(n.eventName==="ROBOTADDED"+e.grid.getTypeId()&&o.Type.isPlainObject(n.robot)){e.onPullRobotAdded(n)}else if(n.eventName.indexOf("ROBOTUPDATED"+e.grid.getTypeId())===0&&o.Type.isPlainObject(n.robot)){e.onPullRobotUpdated(n)}else if(n.eventName.indexOf("ROBOTDELETED"+e.grid.getTypeId())===0&&o.Type.isPlainObject(n.robot)){e.onPullRobotDeleted(n)}else if(n.eventName.indexOf("TYPEUPDATED"+e.grid.getTypeId())===0){e.onPullTypeUpdated()}}}});t.extendWatch(e.grid.getData().pullTag)}if(o.Type.isString(e.grid.getData().taskCountersPullTag)){t.subscribe({moduleId:e.grid.getData().moduleId,command:e.grid.getData().taskCountersPullTag,callback:function t(n){if(o.Type.isString(n.eventId)){if(e.eventIds.has(n.eventId)){return}}if(e.grid.getTypeId()===o.Text.toInteger(n.typeId)){e.onPullCounters(n)}}});t.extendWatch(e.grid.getData().taskCountersPullTag)}}))}},{key:"onPullItemUpdated",value:function t(e){this.grid.addUsers(e.item.users);var n=this.grid.getItem(e.item.id);if(n){n.setData(e.item);this.grid.insertItem(n)}else{var i=this.grid.getColumn(e.item.stageId);if(i&&(i.isCanMoveFrom()||i.canAddItems())){this.onPullItemAdded(e)}}}},{key:"onPullItemAdded",value:function t(e){var n=e.item;this.grid.addUsers(n.users);var i=this.grid.getItem(n.id);if(i){return}var a=new r.Kanban.Item({id:n.id,columnId:n.stageId,name:n.name,data:n});a.setGrid(this.grid);this.grid.items[a.getId()]=a;var s=this.grid.getColumn(a.getStageId());if(s&&(s.isCanMoveFrom()||s.canAddItems())){s.addItem(a,s.getFirstItem())}}},{key:"onPullItemDeleted",value:function t(e){if(!o.Type.isPlainObject(e.item)){return}this.grid.removeItem(e.item.id)}},{key:"onPullStageAdded",value:function t(e){this.grid.onApplyFilter()}},{key:"onPullStageUpdated",value:function t(e){var n=this.grid.getColumn(e.stage.id);if(n){n.update(e)}}},{key:"onPullStageDeleted",value:function t(e){this.grid.removeColumn(e.stage.id)}},{key:"onPullRobotAdded",value:function t(e){this.onPullRobotChanged(e.robot.stageId)}},{key:"onPullRobotUpdated",value:function t(e){this.onPullRobotChanged(e.robot.stageId)}},{key:"onPullRobotDeleted",value:function t(e){if(o.Type.isPlainObject(e.robot)&&o.Type.isString(e.robot.robotName)){var n=this.grid.getColumn(e.robot.stageId);if(n){n.setTasks(n.getTasks().filter((function(t){return t.robotName!==e.robot.robotName})));n.rerenderSubtitle()}}}},{key:"onPullRobotChanged",value:function t(e){var n=this.grid.getColumn(e);if(n){n.loadTasks().then((function(){n.rerenderSubtitle()}))["catch"]((function(){}))}}},{key:"onPullCounters",value:function t(e){var n=o.Text.toInteger(e.typeId);var i=o.Text.toInteger(e.itemId);if(n!==this.grid.getTypeId()){return}var a=this.grid.getItem(i);if(a){var s=a.getTasksCounter();if(e.counter==="+1"){s++}else if(e.counter==="-1"){s--}a.setTasksCounter(s);if(o.Type.isPlainObject(e.tasksFaces)){a.setTasksParticipants(e.tasksFaces)}a.render()}}},{key:"onPullTypeUpdated",value:function t(){this.grid.onApplyFilter()}}]);return t}();var h,p,m,f,v,b,y,k,I,T,C,E,P,S,A;var B=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).apply(this,arguments))}babelHelpers.createClass(e,[{key:"getId",value:function t(){return parseInt(babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"getId",this).call(this))}},{key:"setOptions",value:function t(n){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"setOptions",this).call(this,n);this.canMoveFrom=!!n.canMoveFrom;this.setPermissionProperties()}},{key:"isDroppable",value:function t(){return babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"isDroppable",this).call(this)||this.canMoveTo()}},{key:"isFirstColumn",value:function t(){return this.data.isFirst===true}},{key:"setIsFirstColumn",value:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this.data.isFirst=e;return this}},{key:"onAfterRender",value:function t(){if(!this.isDroppable()){this.getContainer().style.backgroundColor="rgba(204, 204, 204, 0.2)"}else{this.getContainer().style.backgroundColor="transparent"}}},{key:"rerenderSubtitle",value:function t(){var e=this;var n=["responsible","subTitleTasksButton","subTitleTasks","subTitleAddTaskButton","subTitleSettingsButton","subTitleAddButton"];n.forEach((function(t){o.Dom.clean(e.layout[t]);e.layout[t]=null}));o.Dom.clean(this.layout.subtitleNode);if(this.tasksPopup){this.tasksPopup.destroy()}this.renderSubTitle()}},{key:"renderSubTitle",value:function t(){var e=this.getSubTitleNode();if(this.isEditable()){var n=this.getTasks();var i=this.getData()["robotsCount"];if(n&&n.length>0){e.appendChild(this.renderSubTitleTasks(n))}else{if(!this.isFirstColumn()||this.isFirstColumn()&&!i){e.appendChild(this.renderSubTitleAddTaskButton())}}}if(this.isFirstColumn()&&this.canAddItems()){e.appendChild(this.renderSubTitleAddButton())}else{if(this.layout.subTitleAddButton){o.Dom.remove(this.layout.subTitleAddButton);this.layout.subTitleAddButton=null}}return e}},{key:"getSubTitleNode",value:function t(){if(!this.layout.subtitleNode){this.layout.subtitleNode=o.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['<div class="main-kanban-column-subtitle-box"></div>'])))}return this.layout.subtitleNode}},{key:"getContainer",value:function t(){var n=babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"getContainer",this).call(this);if(this.isFirstColumn()&&this.canAddItems()){var i=this.renderQuickFormContainer();var a=this.getItemsContainer();if(i&&a){if(i.parentNode!==a){o.Dom.prepend(i,a)}}}return n}},{key:"renderSubTitleAddButton",value:function t(){if(!this.layout.subTitleAddButton){this.layout.subTitleAddButton=o.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['<div class="main-kanban-column-add-item-button" onclick="','"></div>'])),this.handleAddItemButtonClick.bind(this))}return this.layout.subTitleAddButton}},{key:"renderQuickFormContainer",value:function t(){if(!this.layout.quickFormContainer){var e="rpa-kanban-form";if(this.getGrid().canAddColumns()){e+=" rpa-kanban-form-with-settings"}this.layout.quickFormContainer=o.Tag.render(m||(m=babelHelpers.taggedTemplateLiteral(['<div class="','"></div>'])),e)}return this.layout.quickFormContainer}},{key:"renderQuickFormButtons",value:function t(){if(!this.layout.quickFormButtons){this.layout.quickFormButtons=o.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['<div class="rpa-kanban-form-buttons">\n\t\t\t\t<button class="ui-btn ui-btn-sm ui-btn-primary" onclick="','">','</button>\n\t\t\t\t<button class="ui-btn ui-btn-sm ui-btn-link" onclick="','">',"</button>\n\t\t\t</div>"])),this.handleFormSaveButtonClick.bind(this),o.Loc.getMessage("RPA_KANBAN_QUICK_FORM_SAVE_BUTTON"),this.handleFormCancelButtonClick.bind(this),o.Loc.getMessage("RPA_KANBAN_QUICK_FORM_CANCEL_BUTTON"))}return this.layout.quickFormButtons}},{key:"handleAddItemButtonClick",value:function t(){var e=this;if(this.getGrid().isProgress()){return}if(this.getGrid().isCreateItemRestricted()){l.Manager.Instance.showFeatureSlider();return}if(this.isFormVisible()){return}this.getGrid().startProgress();o.ajax.runAction("rpa.item.getEditor",{analyticsLabel:"rpaItemOpenQuickForm",data:{typeId:this.getGrid().getTypeId(),id:0,stageId:this.getId(),eventId:this.getGrid().pullManager.registerRandomEventId()}}).then((function(t){e.getGrid().stopProgress();o.Runtime.html(e.layout.quickFormContainer,t.data.html).then((function(){e.addSelectButtonToEditor();o.Dom.append(e.renderQuickFormButtons(),e.layout.quickFormContainer);e.showForm();e.bindKeyDownEvents()}))}))["catch"]((function(t){e.getGrid().stopProgress();e.getGrid().showErrorFromResponse(t)}))}},{key:"showForm",value:function t(){this.getBody().scrollTop=0;this.layout.quickFormContainer.style.display="block";this.layout.quickFormButtons.style.display="block"}},{key:"hideForm",value:function t(){this.layout.quickFormContainer.style.display="none";this.layout.quickFormButtons.style.display="none"}},{key:"isFormVisible",value:function t(){return this.layout.quickFormContainer.style.display==="block"&&this.layout.quickFormButtons.style.display==="block"}},{key:"getEditor",value:function t(){return l.Manager.getEditor(this.getGrid().getTypeId(),0)}},{key:"handleFormCancelButtonClick",value:function t(){var e=this.getEditor();if(e){e.rollback();e.refreshLayout()}this.hideForm()}},{key:"handleFormSaveButtonClick",value:function t(){var e=this.getEditor();if(e){e.save();this.bindEditorEvents()}else{this.hideForm()}}},{key:"onEditorSubmit",value:function t(e,n){if(this.isFormVisible()){this.hideForm();var i=n.data.item;this.getGrid().addUsers(n.data.item.users);var a=this.getGrid().getItem(i.id);if(a){return}var s=new r.Kanban.Item({id:i.id,columnId:i.stageId,name:i.name,data:i});s.setGrid(this.getGrid());this.getGrid().items[s.getId()]=s;var o=this.getGrid().getColumn(s.getStageId());if(o){o.addItem(s,o.getFirstItem())}}}},{key:"onEditorErrors",value:function t(e){if(this.isFormVisible()){this.hideForm();this.getGrid().showErrorFromResponse(e)}}},{key:"bindEditorEvents",value:function t(){if(!this.isEditorEventsBinded){this.isEditorEventsBinded=true;BX.addCustomEvent(window,"BX.UI.EntityEditorAjax:onSubmitFailure",this.onEditorErrors.bind(this));BX.addCustomEvent(window,"BX.UI.EntityEditorAjax:onSubmit",this.onEditorSubmit.bind(this))}}},{key:"bindKeyDownEvents",value:function t(){var e=this;if(!this.isKeyDownEventsBinded){this.isKeyDownEventsBinded=true;var n=function t(n){if((n.code==="Enter"||n.code==="NumpadEnter")&&e.isFormVisible()){e.handleFormSaveButtonClick()}};var i=function t(e){return e==="MetaRight"||e==="MetaLeft"||e==="ControlRight"||e==="ControlLeft"};o.Event.bind(window,"keydown",(function(t){if(i(t.code)){o.Event.bind(window,"keydown",n)}else if(t.code==="Escape"){e.handleFormCancelButtonClick()}}));o.Event.bind(window,"keyup",(function(t){if(i(t.code)){o.Event.unbind(window,"keydown",n)}}))}}},{key:"renderSubTitleSettingsButton",value:function t(){if(!this.layout.subTitleSettingsButton){this.layout.subTitleSettingsButton=o.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="main-kanban-column-settings-button" onclick="','">\n\t\t\t\t<button class="ui-btn ui-btn-xs ui-btn-link ui-btn-icon-setting"></button>\n\t\t\t</div>'])),this.openSettings.bind(this))}return this.layout.subTitleSettingsButton}},{key:"openSettings",value:function t(){var e=this;var n=this.data.settingsUrl;if(n){l.Manager.openSlider(n).then((function(t){var n=t.getData().get("response");if(n){e.update(n.data)}}))}}},{key:"renderSubTitleAddTaskButton",value:function t(){if(!this.layout.subTitleAddTaskButton){var e=this.buildAddRobotUrl();this.layout.subTitleAddTaskButton=o.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="main-kanban-column-settings-button">\n\t\t\t\t\t\t<a class="ui-btn ui-btn-xs ui-btn-light-border ui-btn-no-caps ui-btn-round ui-btn-themes main-kanban-column-settings-button-rpa" href="','">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t"])),e,o.Loc.getMessage("RPA_KANBAN_COLUMN_ADD_TASK_BTN"))}return this.layout.subTitleAddTaskButton}},{key:"renderSubTitleTasks",value:function t(e){if(!this.layout.subTitleTasks){this.layout.subTitleTasks=o.Tag.render(y||(y=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="rpa-kanban-column-task-block">\n\t\t\t\t\t\t<div class="rpa-kanban-column-task-inner">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t","\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t"])),this.renderSubTitleResponsible(e,true),this.renderSubTitleTasksButton(e))}return this.layout.subTitleTasks}},{key:"renderSubTitleTasksButton",value:function t(e){if(!this.layout.subTitleTasksButton){this.layout.subTitleTasksButton=o.Tag.render(k||(k=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="rpa-kanban-column-task-btn" onclick="','">\n\t\t\t\t\t\t<span class="rpa-kanban-column-task-btn-title">','</span>\n\t\t\t\t\t\t<span class="rpa-kanban-column-task-btn-counter">',"</span>\n\t\t\t\t\t</div>\n\t\t\t\t"])),this.showTasks.bind(this,e),o.Loc.getMessage("RPA_KANBAN_TASKS"),e.length)}return this.layout.subTitleTasksButton}},{key:"renderSubTitleResponsible",value:function t(e,n){var i=this;var a=[];var s=this.showTasks.bind(this,e);e.forEach((function(t){t.users.forEach((function(t){var e="border-color: #"+i.getColor()+";";if(t.photoSrc){e+=" background-image: url("+o.Text.encode(t.photoSrc)+");"}else{e+=" background-size: 60%;"}a.push(o.Tag.render(I||(I=babelHelpers.taggedTemplateLiteral(['<span class="rpa-kanban-column-task-responsible-item" title="','">\n\t\t\t\t\t<span class="rpa-kanban-column-task-responsible-img" style="','">\n\t\t\t\t\t</span>\n\t\t\t\t</span>'])),t.name,e))}))}));a=this.sliceResponsibleListElements(a);var r=o.Tag.render(T||(T=babelHelpers.taggedTemplateLiteral(['<span class="rpa-kanban-column-task-responsible-add"></span>'])));if(n){BX.bind(r,"click",s)}else{var l=e[0];if(l.canAppendResponsibles){BX.Bizproc.UserSelector.decorateNode(r,{isOnlyDialogMode:true,callbacks:{select:this.addTaskUserHandler.bind(this,l)}})}else{r=o.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(['<a href="','" class="rpa-kanban-column-task-responsible-add"></a>'])),this.buildEditRobotUrl(l["robotName"]))}}return o.Tag.render(E||(E=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="rpa-kanban-column-task-responsible">\n\t\t\t\t\t<div class="rpa-kanban-column-task-responsible-list" style="background-color: ','" onclick="','">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"])),"#"+this.getColor(),s,a,r)}},{key:"sliceResponsibleListElements",value:function t(e){if(e.length>4){var n=e.length-4;e=e.slice(0,4);e.push(o.Tag.render(P||(P=babelHelpers.taggedTemplateLiteral(['<span class="rpa-kanban-column-task-responsible-item rpa-kanban-column-task-responsible-item-other">\n\t\t\t\t\t\t<span class="rpa-kanban-column-task-responsible-other-text">+',"</span>\n\t\t\t\t\t</span>"])),n))}return e}},{key:"showTasks",value:function t(e){this.getTasksPopup(e).show()}},{key:"addTaskUserHandler",value:function t(e,n,i){o.ajax.runAction("rpa.task.addUser",{analyticsLabel:"rpaTaskAddUser",data:{typeId:this.getGrid().getData().typeId,stageId:this.getId(),robotName:e.robotName,userValue:n},getParameters:{context:"kanban"}}).then((function(t){}))}},{key:"getTasksPopup",value:function t(e){var n=this;if(!this.tasksPopup){var i=this.layout.subTitleTasksButton;if(!i){i=this.renderSubTitleTasksButton(this.getTasks())}this.tasksPopup=new d.Popup("rpa-tasks-"+this.getId(),i,{autoHide:true,draggable:false,offsetTop:-5,offsetLeft:30,noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,cacheable:false,angle:{offset:81,position:"top"},events:{onPopupDestroy:function t(){n.tasksPopup=null}},overlay:{backgroundColor:"transparent"},content:this.renderTasksPopup(e)})}return this.tasksPopup}},{key:"renderTasksPopup",value:function t(e){var n=this;var i=e.map((function(t){return o.Tag.render(S||(S=babelHelpers.taggedTemplateLiteral(['<div class="rpa-kanban-tasks-popup-item">\n\t\t\t\t\t\t<a href="','" class="rpa-kanban-tasks-popup-name">','</a>\n\t\t\t\t\t\t<div class="rpa-kanban-tasks-popup-desc">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t<span class="rpa-kanban-tasks-popup-delete" onclick="','">',"</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>"])),n.buildEditRobotUrl(t["robotName"]),o.Text.encode(t["title"]),n.renderSubTitleResponsible([t]),n.deleteTaskHandler.bind(n,t),o.Loc.getMessage("RPA_KANBAN_COLUMN_DELETE_TASK_BTN"))}));return o.Tag.render(A||(A=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="rpa-kanban-tasks-popup-inner" data-role="rpa-kanban-column-tasks-item">\n\t\t\t\t<div class="rpa-kanban-tasks-popup-list">\n\t\t\t\t\t','\n\t\t\t\t</div>\n\t\t\t\t<a href="','" class="rpa-kanban-tasks-popup-add">',"</a>\n\t\t\t</div>"])),i,this.buildAddRobotUrl(),o.Loc.getMessage("RPA_KANBAN_COLUMN_ADD_TASK_BTN"))}},{key:"deleteTaskHandler",value:function t(e,n){var i=this;u.MessageBox.show({message:o.Loc.getMessage("RPA_KANBAN_COLUMN_DELETE_TASK_CONFIRM"),buttons:u.MessageBoxButtons.OK_CANCEL,onOk:function t(){if(i.getGrid().isProgress()){return}i.getGrid().startProgress();var n=new BX.Promise;o.ajax.runAction("rpa.task.delete",{analyticsLabel:"rpaKanbanTaskDelete",data:{typeId:i.getGrid().getData().typeId,stageId:i.getId(),robotName:e["robotName"],eventId:i.getGrid().pullManager.registerRandomEventId()},getParameters:{context:"kanban"}}).then((function(){if(i.tasksPopup){i.tasksPopup.destroy()}i.setTasks(i.getTasks().filter((function(t){return t.robotName!==e.robotName})));i.rerenderSubtitle();i.getGrid().stopProgress();n.fulfill()}))["catch"]((function(t){i.getGrid().stopProgress();n.reject()}));return n},popupOptions:{zIndexAbsolute:1200}})}},{key:"buildAddRobotUrl",value:function t(){var e=this.getGrid().getData().typeId;var n=new o.Uri("/rpa/automation/".concat(e,"/addrobot/"));n.setQueryParams({stage:this.getId()});return n}},{key:"buildEditRobotUrl",value:function t(e){var n=this.getGrid().getData().typeId;var i=new o.Uri("/rpa/automation/".concat(n,"/editrobot/"));i.setQueryParams({stage:this.getId(),robotName:e});return i}},{key:"getFields",value:function t(){var e=this.getData().userFields;if(!e||!o.Type.isPlainObject(e)){e=this.getGrid().getFields()}if(!e||!o.Type.isPlainObject(e)){e={}}return e}},{key:"getPossibleNextStages",value:function t(){return this.getData().possibleNextStages}},{key:"getSort",value:function t(){return parseInt(this.getData().sort)}},{key:"isCanMoveFrom",value:function t(){return!!this.canMoveFrom}},{key:"canMoveTo",value:function t(){var e=this;var n=false;this.getGrid().getColumns().forEach((function(t){if(t.isCanMoveFrom()&&t.getPossibleNextStages().includes(e.getId())){n=true}}));return n}},{key:"update",value:function t(e){var n=this;if(o.Type.isPlainObject(e)&&e.stage&&o.Type.isPlainObject(e.stage)&&parseInt(e.stage.id)===this.getId()){var i=e.stage;this.setName(i.name);this.setColor(i.color);this.setData(i);this.processPermissions(i);this.getGrid().moveColumn(this,this.getTargetColumn());this.render();this.getGrid().getColumns().forEach((function(t){if(t!==n){t.processPermissions();t.onAfterRender()}}))}}},{key:"getTargetColumn",value:function t(){var e=this;var n=this.getGrid().getColumns();var i=null;n.forEach((function(t){if(t.getId()!==e.getId()&&t.getSort()>=e.getSort()&&(!i||i.getSort()>t.getSort())){i=t}}));return i}},{key:"processPermissions",value:function t(){this.setPermissionProperties();this.processDraggingOptions()}},{key:"setPermissionProperties",value:function t(){var e=this;var n=this.getData();var i={};if(n.permissions&&o.Type.isPlainObject(n.permissions)){i=n.permissions}Object.keys(i).forEach((function(t){e[t]=i[t]}))}},{key:"processDraggingOptions",value:function t(){if(this.isDraggable()){this.makeDraggable()}else{this.disableDragging()}if(this.isDroppable()){this.makeDroppable()}else{this.disableDropping()}this.getItems().forEach((function(t){t.processPermissions()}))}},{key:"loadTasks",value:function t(){var e=this;return new Promise((function(t,n){e.getGrid().startProgress();o.ajax.runAction("rpa.stage.getTasks",{data:{id:e.getId()}}).then((function(n){e.getGrid().stopProgress();e.setTasks(n.data.tasks);t()}))["catch"]((function(t){e.getGrid().stopProgress().showErrorFromResponse(t);n()}))}))}},{key:"getTasks",value:function t(){if(!this.data){this.data={}}if(!this.data.tasks||!o.Type.isArray(this.data.tasks)){this.data.tasks=[]}return Array.from(this.data.tasks)}},{key:"setTasks",value:function t(e){if(!o.Type.isArray(e)){e=[]}this.data.tasks=e;return this}},{key:"addSelectButtonToEditor",value:function t(){var e=this.getEditor();if(!e){return}var n=this.getGrid().getEditorMainSection(e);if(!n){return}if(n._addChildButton){return}n.ensureButtonPanelCreated();n._addChildButton=BX.create("span",{props:{className:"ui-entity-editor-content-add-lnk"},text:BX.message("UI_ENTITY_EDITOR_SELECT_FIELD"),events:{click:BX.delegate(n.onAddChildBtnClick,n)}});n.addButtonElement(n._addChildButton,{position:"left"})}}]);return e}(s.Kanban.Column);var D,F,N,M,R,w,O,L,_,x,U,G,H,j;var K=function(t){babelHelpers.inherits(e,t);function e(){var t;var n;babelHelpers.classCallCheck(this,e);for(var i=arguments.length,a=new Array(i),s=0;s<i;s++){a[s]=arguments[s]}n=babelHelpers.possibleConstructorReturn(this,(t=babelHelpers.getPrototypeOf(e)).call.apply(t,[this].concat(a)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"currentState",{});return n}babelHelpers.createClass(e,[{key:"setOptions",value:function t(n){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"setOptions",this).call(this,n);this.setPermissionProperties()}},{key:"render",value:function t(){var e=this;this.layout.title=null;this.renderDescription();this.renderFieldsList();this.renderShadow();if(!this.layout.content){this.layout.content=o.Tag.render(D||(D=babelHelpers.taggedTemplateLiteral(['<div ondblclick="','" class="rpa-kanban-item"></div>'])),this.onDoubleClick.bind(this))}else{o.Dom.clean(this.layout.content)}if(this.layout.title){this.layout.content.appendChild(this.layout.title)}if(this.layout.fieldList){this.layout.content.appendChild(this.layout.fieldList)}if(this.layout.description){this.layout.content.appendChild(this.layout.description)}this.layout.content.appendChild(this.renderShadow());this.layout.description.appendChild(this.renderTasksParticipants());this.layout.description.appendChild(this.renderTasksCounter());this.layout.content.appendChild(BX.Tag.render(F||(F=babelHelpers.taggedTemplateLiteral(['<div class="rpa-kanban-item-line"></div>']))));this.layout.content.style.setProperty("--rpa-kanban-item-color","#"+this.getColumn().getColor());if(this.isDraggable()){this.layout.content.style.backgroundColor="#fff"}else{this.layout.content.style.backgroundColor="#aaa"}o.Event.bindOnce(this.layout.content,"animationend",(function(){BX.removeClass(e.layout.container,"main-kanban-item-new")}));return this.layout.content}},{key:"setTasksParticipants",value:function t(e){this.data.tasksFaces=e;return this}},{key:"getTasksCounter",value:function t(){return o.Text.toInteger(this.data.tasksCounter)}},{key:"getTasksParticipants",value:function t(){var e=o.Text.toInteger(this.getData()["createdBy"]);var n=this.getGrid().getUserId();var i=this.getGrid().getUser(e);var a=this.data.tasksFaces;var s=a.completed[0];var r=a.running.includes(n)?n:a.running[0];var l=a.completed.length;var u=a.running.length;var d=null;var c=null;if(s){d=this.getGrid().getUser(o.Text.toInteger(s))}if(r){c=this.getGrid().getUser(o.Text.toInteger(r))}return{startedBy:i,completedBy:d,waitingFor:c,completedCnt:l,waitingForCnt:u}}},{key:"setTasksCounter",value:function t(e){this.data.tasksCounter=e;return this}},{key:"bindEditorEvents",value:function t(){if(!this.isEditorEventsBinded){this.isEditorEventsBinded=true;BX.addCustomEvent(window,"BX.UI.EntityEditorAjax:onSubmitFailure",this.onEditorErrors.bind(this));BX.addCustomEvent(window,"BX.UI.EntityEditorAjax:onSubmit",this.onEditorSubmit.bind(this))}}},{key:"showEditor",value:function t(e){var n=this;o.Dom.addClass(this.layout.container,"main-kanban-item-waiting");this.bindEditorEvents();return new Promise((function(t,i){o.ajax.runAction("rpa.item.getEditor",{analyticsLabel:"rpaItemMovedMandatoryFieldsPopupOpen",data:{typeId:n.getTypeId(),id:n.getId(),stageId:e>0?e:null,eventId:n.getGrid().pullManager.registerRandomEventId()}}).then((function(e){var a=n.getPopup();if(a){o.Runtime.html(a.getContentContainer(),e.data.html).then((function(){a.show();n.editorResolve=t;n.editorReject=i}))}}))["catch"]((function(t){o.Dom.removeClass(n.layout.container,"main-kanban-item-waiting");i(t.errors)}))}))}},{key:"onEditorSaveClick",value:function t(){var e=this.getEditor();if(!e){this.getPopup().close();if(o.Type.isFunction(this.editorReject)){this.editorReject("Editor not found");this.editorResolve=null;this.editorReject=null}}else{e.save()}}},{key:"onEditorCancelClick",value:function t(){o.Dom.removeClass(this.layout.container,"main-kanban-item-waiting");this.getPopup().close();if(o.Type.isFunction(this.editorResolve)){this.editorResolve({cancel:true});this.editorResolve=null;this.editorReject=null}}},{key:"onEditorSubmit",value:function t(e,n){if(this.getPopup().isShown()){o.Dom.removeClass(this.layout.container,"main-kanban-item-waiting");this.getPopup().close();this.setData(n.data.item);this.saveCurrentState();this.render()}}},{key:"onEditorErrors",value:function t(e){if(this.getPopup().isShown()){o.Dom.removeClass(this.layout.container,"main-kanban-item-waiting");this.getPopup().close();if(o.Type.isFunction(this.editorReject)){this.editorReject({errors:e},false);this.editorResolve=null;this.editorReject=null}}}},{key:"getPopup",value:function t(){var e="rpa-kanban-item-popup-"+this.getId();var n=d.PopupWindowManager.getPopupById(e);if(!n){n=new d.PopupWindow(e,null,{zIndex:200,className:"",autoHide:false,closeByEsc:false,closeIcon:false,width:600,overlay:true,lightShadow:false,buttons:this.getItemPopupButtons()})}return n}},{key:"getEditor",value:function t(){return l.Manager.getEditor(this.getTypeId(),parseInt(this.getId()))}},{key:"getItemPopupButtons",value:function t(){return[new BX.PopupWindowButton({text:o.Loc.getMessage("RPA_KANBAN_POPUP_SAVE"),className:"ui-btn ui-btn-md ui-btn-primary",events:{click:this.onEditorSaveClick.bind(this)}}),new BX.PopupWindowButton({text:o.Loc.getMessage("RPA_KANBAN_POPUP_CANCEL"),className:"ui-btn ui-btn-md",events:{click:this.onEditorCancelClick.bind(this)}})]}},{key:"showTasks",value:function t(){var e=this;o.Dom.addClass(this.layout.container,"main-kanban-item-waiting");return new Promise((function(t){l.Manager.Instance.openTasks(e.getTypeId(),e.getId()).then((function(n){t(n);o.Dom.removeClass(e.layout.container,"main-kanban-item-waiting")}))}))}},{key:"getStageId",value:function t(){return o.Text.toInteger(this.getData().stageId)}},{key:"setStageId",value:function t(e){this.data.stageId=e;return this}},{key:"getTypeId",value:function t(){return o.Text.toInteger(this.getData().typeId)}},{key:"saveCurrentState",value:function t(){var e=this.getColumn();var n=e.getNextItemSibling(this);var i=e.getPreviousItemSibling(this);this.data.stageId=this.getColumnId();this.currentState.nextItemId=n?n.getId():0;this.currentState.previousItemId=i?i.getId():0;this.currentState.stageId=this.data.stageId;return this}},{key:"savePosition",value:function t(){var e=this;var n={id:this.getId(),typeId:this.getTypeId(),fields:{stageId:this.getStageId(),previousItemId:this.currentState.previousItemId||null},eventId:this.getGrid().pullManager.registerRandomEventId()};o.Dom.addClass(this.layout.container,"main-kanban-item-waiting");return new Promise((function(t,i){o.ajax.runAction("rpa.item.update",{analyticsLabel:"rpaItemMoved",data:n}).then((function(n){e.data=n.data.item;if(!e.moveToActualColumn()){e.render()}o.Dom.removeClass(e.layout.container,"main-kanban-item-waiting");t(n)}))["catch"]((function(t){i(t);o.Dom.removeClass(e.layout.container,"main-kanban-item-waiting")}))}))}},{key:"moveToActualColumn",value:function t(){if(this.getStageId()!==this.getColumn().getId()){var e=this.getGrid().getColumn(this.getStageId());if(e){this.getGrid().moveItem(this,e,e.getFirstItem())}else{this.getGrid().moveItem(this,this.getStageId())}return true}return false}},{key:"saveSort",value:function t(){var e=this;var n={id:this.getId(),typeId:this.getTypeId(),previousItemId:this.currentState.previousItemId};o.Dom.addClass(this.layout.container,"main-kanban-item-waiting");return new Promise((function(t,i){o.ajax.runAction("rpa.item.sort",{analyticsLabel:"rpaItemSorted",data:n}).then((function(n){o.Dom.removeClass(e.layout.container,"main-kanban-item-waiting");t(n)}))["catch"]((function(t){i(t);o.Dom.removeClass(e.layout.container,"main-kanban-item-waiting")}))}))}},{key:"getCurrentState",value:function t(){return Object.assign({},this.currentState)}},{key:"restoreState",value:function t(e){this.currentState=e;this.data.stageId=this.currentState.stageId;return this}},{key:"onDoubleClick",value:function t(){if(this.data.detailUrl){l.Manager.openSlider(this.data.detailUrl)}}},{key:"getMovedBy",value:function t(){return o.Text.toInteger(this.getData().movedBy)}},{key:"getUpdatedBy",value:function t(){return o.Text.toInteger(this.getData().updatedBy)}},{key:"getCreatedBy",value:function t(){return o.Text.toInteger(this.getData().createdBy)}},{key:"getName",value:function t(){return this.data.name}},{key:"renderTitle",value:function t(e){if(o.Type.isArray(e)){e=e[0]}e=o.Text.encode(e);var n="javascript:void(0);";if(this.data.detailUrl){n=this.data.detailUrl}if(!this.layout.title){this.layout.title=o.Tag.render(N||(N=babelHelpers.taggedTemplateLiteral(['<a class="rpa-kanban-item-title" href="','">',"</a>"])),n,e)}else{this.layout.title.innerText=e}return this.layout.title}},{key:"renderFieldsList",value:function t(){var e=this;if(!this.layout.fieldList){this.layout.fieldList=o.Tag.render(M||(M=babelHelpers.taggedTemplateLiteral(['<div class="rpa-kanban-item-field-list"></div>'])))}this.layout.fieldList.innerHTML="";var n=this.getGrid().getFields();Object.keys(n).forEach((function(t){if(n[t]["isVisibleOnKanban"]&&!e.isEmptyValue(e.getData()[t])){if(n[t]["isTitle"]){e.renderTitle(e.getData()[t])}else if(t==="createdBy"||t==="updatedBy"||t==="movedBy"){var i=e.renderUser(t);if(i){e.layout.fieldList.appendChild(o.Tag.render(R||(R=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t<div class="rpa-kanban-item-field-item">\n\t\t\t\t\t\t\t\t<span class="rpa-kanban-item-field-item-name">',"</span>\n\t\t\t\t\t\t\t\t","\n\t\t\t\t\t\t\t</div>"])),o.Text.encode(n[t].title),i))}}else{e.layout.fieldList.appendChild(o.Tag.render(w||(w=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t<div class="rpa-kanban-item-field-item">\n\t\t\t\t\t\t\t<span class="rpa-kanban-item-field-item-name">','</span>\n\t\t\t\t\t\t\t<span class="rpa-kanban-item-field-item-value">',"</span>\n\t\t\t\t\t\t</div>"])),o.Text.encode(n[t].title),e.getDisplayableValue(t)))}}}));return this.layout.fieldList}},{key:"renderShadow",value:function t(){return o.Tag.render(O||(O=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="rpa-kanban-item-shadow"></div>\n\t\t'])))}},{key:"renderDescription",value:function t(){this.layout.description=o.Tag.render(L||(L=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="rpa-kanban-item-description"></div>\n\t\t'])))}},{key:"renderUserPhoto",value:function t(e){var n=e.link,i=e.photo;if(o.Type.isString(n)&&o.Type.isString(i)){return o.Tag.render(_||(_=babelHelpers.taggedTemplateLiteral(['<a class="rpa-kanban-item-user-photo" href="','" style="background-image: url(',')"></a>'])),o.Text.encode(n),o.Text.encode(i))}return null}},{key:"renderUser",value:function t(e){var n=o.Text.toInteger(this.getData()[e]);var i=this.getGrid().getUser(n);if(i){var a=this.renderUserPhoto(i);return o.Tag.render(x||(x=babelHelpers.taggedTemplateLiteral(['<div class="rpa-kanban-item-user">\n\t\t\t\t','\n\t\t\t\t<a class="rpa-kanban-item-user-name rpa-kanban-item-field-item-value" href="','">',"</a>\n\t\t\t</div>"])),a?a:"",o.Text.encode(i.link),o.Text.encode(i.fullName))}return null}},{key:"renderContact",value:function t(){return o.Tag.render(U||(U=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="rpa-kanban-item-contact">\n\t\t\t\t\t<span class="rpa-kanban-item-contact-im"></span>\n\t\t\t\t</div>\n\t\t'])))}},{key:"renderTasksParticipants",value:function t(){var e=this.getTasksParticipants(),n=e.startedBy,i=e.completedBy,a=e.waitingFor,s=e.completedCnt,r=e.waitingForCnt;var l=[];if(n){l.push(this.renderTaskParticipant(n))}if(i){l.push(this.renderTaskParticipant(i,s>1))}if(a){l.push(this.renderTaskParticipant(a,r>1))}return o.Tag.render(G||(G=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="rpa-kanban-column-task-responsible-list">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t"])),l)}},{key:"renderTaskParticipant",value:function t(e,n){var i=e.link,a=e.photo,s=e.fullName;return o.Tag.render(H||(H=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<a class="rpa-kanban-column-task-responsible-item ','" \n\t\t\t href="','" title="','">\n\t\t\t\t<span class="rpa-kanban-column-task-responsible-img" ',">\t\n\t\t\t\t</span>\n\t\t\t</a>\n\t\t"])),n?"rpa-kanban-column-task-responsible-item-more":"",o.Text.encode(i),o.Text.encode(s),a?'style="background-image: url('+o.Text.encode(a)+'"':"")}},{key:"renderTasksCounter",value:function t(){return o.Tag.render(j||(j=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="rpa-kanban-item-counter" onclick="','" ','>\n\t\t\t\t\t<div class="rpa-kanban-item-counter-text">','</div>\n\t\t\t\t\t<div class="rpa-kanban-item-counter-value">',"</div>\n\t\t\t\t</div>\n\t\t"])),this.showTasks.bind(this),this.getTasksCounter()<=0?'style="display: none;"':"",o.Loc.getMessage("RPA_KANBAN_TASKS"),this.getTasksCounter())}},{key:"hasEmptyMandatoryFields",value:function t(e){var n=this;var i=false;if(!e){e=this.getStageId()}e=this.getGrid().getColumn(e);if(!e){throw new Error("Column not found")}var a=e.getFields();Object.keys(a).forEach((function(t){if(a[t].mandatory&&n.isEmptyValue(n.getData()[t])){i=true}}));return i}},{key:"isEmptyValue",value:function t(e){return o.Type.isNil(e)||e===false||(o.Type.isString(e)||o.Type.isArray(e))&&e.length<=0||o.Type.isNumber(e)&&e===0}},{key:"update",value:function t(e){if(o.Type.isPlainObject(e)&&e.item&&o.Type.isPlainObject(e.item)&&parseInt(e.item.id)===this.getId()){this.data=e.item;this.processPermissions();this.render()}return this}},{key:"processPermissions",value:function t(){this.setPermissionProperties();this.processDraggingOptions();return this}},{key:"setPermissionProperties",value:function t(){var e=this;var n=this.getData();var i={};if(n.permissions&&o.Type.isPlainObject(n.permissions)){i=n.permissions}Object.keys(i).forEach((function(t){e[t]=i[t]}));return this}},{key:"processDraggingOptions",value:function t(){if(this.isDraggable()){this.makeDraggable()}else{this.disableDragging()}this.render();return this}},{key:"getDisplayableValue",value:function t(e){var n=null;if(this.data.display&&this.data.display[e]){n=this.data.display[e]}else if(this.data[e]){n=this.data[e]}if(o.Type.isArray(n)){n=n.join(", ")}return n}},{key:"isDeletable",value:function t(){return this.canDelete!==false}}]);return e}(s.Kanban.Item);var X=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).apply(this,arguments))}babelHelpers.createClass(e,[{key:"getTypeId",value:function t(){return o.Text.toInteger(this.getData().typeId)}},{key:"getUserId",value:function t(){return o.Text.toInteger(this.getData().userId)}},{key:"isCreateItemRestricted",value:function t(){return this.getData().isCreateItemRestricted===true}},{key:"bindEvents",value:function t(){var e=this;BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemCaptured",this.onBeforeItemCaptured.bind(this));BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemRestored",this.onBeforeItemRestored.bind(this));BX.addCustomEvent("Kanban.Column:render",(function(t){if(t.getGrid()===e&&t instanceof B){t.onAfterRender.apply(t)}}));BX.addCustomEvent("BX.Main.Filter:apply",this.onApplyFilter.bind(this));BX.addCustomEvent(this,"Kanban.Grid:onColumnLoadAsync",(function(t){t.push((function(t){return e.getColumnItems(t)}))}));BX.addCustomEvent(this,"Kanban.Grid:onBeforeItemMoved",this.saveItemState);BX.addCustomEvent(this,"Kanban.Grid:onItemMoved",this.onItemMoved);BX.addCustomEvent(this,"Kanban.Grid:onColumnUpdated",this.onColumnUpdated);BX.addCustomEvent(this,"Kanban.Grid:onColumnMoved",this.onColumnMoved);BX.addCustomEvent(this,"Kanban.Grid:onColumnAddedAsync",(function(t){t.push((function(t){return e.addStage(t)}))}));BX.addCustomEvent(this,"Kanban.Grid:onColumnRemovedAsync",(function(t){t.push((function(t){return e.removeStage(t)}))}));BX.addCustomEvent(window,"BX.UI.EntityEditorSection:onOpenChildMenu",this.onOpenSelectFieldMenu.bind(this));BX.addCustomEvent("SidePanel.Slider:onMessage",(function(t){if(t.getEventId()==="userfield-list-update"){e.onApplyFilter()}}));this.pullManager=new g(this)}},{key:"onBeforeItemCaptured",value:function t(e){var n=this;o.Event.EventEmitter.emit("BX.Rpa.Kanban.Grid:onBeforeItemCapturedStart",[this,e]);var i=e.getItem();if(!(i instanceof K)){return}if(!e.isActionAllowed()){return}var a=e.getDropZone();if(a.getId()==="delete"){if(!i.isDeletable()){e.denyAction();return}if(this.deleteCommand&&!this.deleteCommand.isCompleted()){this.deleteCommand.run()}this.deleteCommand=new V(i,(function(t){n.deleteItem(t)}),(function(t){n.unhideItem(t)}));this.deleteCommand.start(a.getDropZoneArea().getDropZoneTimeout())}else if(a.getData().isColumn===true){e.denyAction();var s=this.getColumn(a.getId());if(!s){i.saveCurrentState();this.hideItem(i)}else{this.moveItem(i,s)}this.moveItemToStage(i,a.getId(),i.getColumn())}}},{key:"onBeforeItemRestored",value:function t(e){var n=e.getItem();if(!(n instanceof K)){return}var i=e.getDropZone();if(i.getId()==="delete"){if(this.deleteCommand){this.deleteCommand.cancel();this.deleteCommand=null}}}},{key:"saveItemState",value:function t(e){e.getItem().saveCurrentState()}},{key:"getFirstColumn",value:function t(){var e=this.getColumns();if(e.length>0){return e[0]}return null}},{key:"onItemMoved",value:function t(e,n,i,a){var s=this;var r=e.getCurrentState();if(parseInt(e.getStageId())===parseInt(n.getId())){if(!i&&e.getCurrentState().nextItemId===0||i&&parseInt(i.getId())===parseInt(e.getCurrentState().nextItemId)){this.moveItem(e,e.getStageId(),e.getCurrentState().nextItemId);return}e.saveCurrentState().saveSort()["catch"]((function(t){s.onItemMoveError(e,t,r)}));return}var l=this.getColumn(e.getStageId());var u=true;if(l.isCanMoveFrom()&&u){this.moveItemToStage(e,n.getId(),l)}else if(!l.isCanMoveFrom()&&u){BX.UI.Notification.Center.notify({content:o.Loc.getMessage("RPA_KANBAN_MOVE_PERMISSION_NOTIFY").replace("#STAGE#",o.Text.encode(l.getName()))});this.moveItem(e,e.getStageId(),e.getCurrentState().nextItemId)}else if(l.isCanMoveFrom()&&!u){BX.UI.Notification.Center.notify({content:o.Loc.getMessage("RPA_KANBAN_MOVE_WRONG_STAGE_NOTIFY").replace("#STAGE_FROM#",o.Text.encode(l.getName())).replace("#STAGE_TO#",o.Text.encode(n.getName()))});this.moveItem(e,e.getStageId(),e.getCurrentState().nextItemId)}else{BX.UI.Notification.Center.notify({content:o.Loc.getMessage("RPA_KANBAN_MOVE_ITEM_PERMISSION_NOTIFY").replace("#ITEM#",o.Text.encode(e.getName())).replace("#STAGE#",o.Text.encode(l.getName()))});this.moveItem(e,e.getStageId(),e.getCurrentState().nextItemId)}}},{key:"moveItemToStage",value:function t(e,n,i){var a=this;var r=e.getCurrentState();if(e.hasEmptyMandatoryFields(i)){if(!i.canAddItems()){this.moveItem(e,e.getStageId(),e.getCurrentState().nextItemId);s.Kanban.Utils.showErrorDialog(o.Loc.getMessage("RPA_KANBAN_MOVE_EMPTY_MANDATORY_FIELDS_ERROR"),false);return}e.showEditor(n).then((function(t){a.onEditorSave(e,t)}))["catch"]((function(t){a.onItemMoveError(e,t,r)}))}else{var l=this.getColumn(n);if(l){e.saveCurrentState()}else{e.setStageId(n)}e.savePosition()["catch"]((function(t){var s=false;var l=false;var u=false;t.errors.forEach((function(t){if(t.code&&t.code==="RPA_MANDATORY_FIELD_EMPTY"){s=true}else if(t.code&&t.code==="RPA_ITEM_USER_HAS_TASKS"){l=true}else if(t.code&&t.code==="RPA_ITEM_TASKS_NOT_COMPLETED"){u=true}}));if(s){if(!i.canAddItems()){BX.UI.Notification.Center.notify({content:o.Loc.getMessage("RPA_KANBAN_MOVE_ITEM_PERMISSION_NOTIFY").replace("#ITEM#",o.Text.encode(e.getName())).replace("#STAGE#",o.Text.encode(i.getName()))});a.onItemMoveError(e,null,r);return}e.showEditor(n).then((function(t){if(t.cancel===true){a.onItemMoveError(e,null,r)}}))["catch"]((function(t){a.onItemMoveError(e,t,r)}))}else if(l){e.showTasks().then((function(t){if(t.isCompleted!==true){a.onItemMoveError(e,null,r)}else{e.update(t);if(!e.moveToActualColumn()){e.render()}}}))["catch"]((function(t){a.onItemMoveError(e,t,r)}))}else if(u){BX.UI.Notification.Center.notify({content:o.Loc.getMessage("RPA_KANBAN_MOVE_ITEM_HAS_TASKS_ERROR")});a.onItemMoveError(e,null,r)}else{a.onItemMoveError(e,t,r)}}))}}},{key:"onItemMoveError",value:function t(e){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(i){e.restoreState(i);if(!e.isVisible()){this.unhideItem(e)}this.moveItem(e,e.getStageId(),e.getCurrentState().nextItemId)}if(n){this.showErrorFromResponse(n)}}},{key:"onEditorSave",value:function t(e,n){if(n.cancel===true){this.moveItem(e,e.getStageId(),e.getCurrentState().nextItemId)}}},{key:"showErrorFromResponse",value:function t(e){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var i=null;if(o.Type.isPlainObject(e)&&e.errors&&o.Type.isArray(e.errors)){i=e.errors}else if(o.Type.isArray(e)){i=e}var a="";if(o.Type.isArray(i)){i.forEach((function(t){a+=o.Text.encode(t.message)+"\n"}))}else{a="Unknown error"}s.Kanban.Utils.showErrorDialog(a,n)}},{key:"onColumnUpdated",value:function t(e){var n=this;this.startProgress();o.ajax.runAction("rpa.stage.update",{analyticsLabel:"rpaKanbanStageUpdate",data:{id:e.getId(),fields:{name:e.getName(),color:e.getColor()},eventId:this.pullManager.registerRandomEventId()},getParameters:{context:"kanban"}}).then((function(t){n.stopProgress();e.update(t.data)}))["catch"]((function(t){n.stopProgress();n.showErrorFromResponse(t,true)}))}},{key:"addStage",value:function t(e){var n=this;this.startProgress();var i=this.getPreviousColumnSibling(e);var a=i?i.getId():0;var s=new BX.Promise;o.ajax.runAction("rpa.stage.add",{analyticsLabel:"rpaKanbanStageAdd",data:{fields:{name:e.getName(),color:e.getColor(),previousStageId:a,typeId:this.getTypeId()},eventId:this.pullManager.registerRandomEventId()},getParameters:{context:"kanban"}}).then((function(t){s.fulfill(n.transformColumnActionResponseToColumnOptions(t));n.stopProgress()}))["catch"]((function(t){var e=t.errors.pop().message;s.reject(e);n.stopProgress()}));return s}},{key:"removeStage",value:function t(e){var n=this;var i=new BX.Promise;this.startProgress();o.ajax.runAction("rpa.stage.delete",{analyticsLabel:"rpaKanbanStageDelete",data:{id:e.getId()},getParameters:{context:"kanban"}}).then((function(){n.stopProgress();i.fulfill()}))["catch"]((function(t){n.stopProgress();var a=t.errors.pop().message;e.enableDragging();e.getContainer().classList.remove("main-kanban-column-edit-mode");i.reject(a)}));return i}},{key:"onColumnMoved",value:function t(e){var n=this;var i=this.getPreviousColumnSibling(e);var a=i?i.getId():0;o.ajax.runAction("rpa.stage.update",{analyticsLabel:"rpaKanbanStageMove",data:{id:e.getId(),fields:{previousStageId:a},eventId:this.pullManager.registerRandomEventId()},getParameters:{context:"kanban"}}).then((function(t){var i=e.isFirstColumn();var a=true;e.update(t.data);if(e.isFirstColumn()&&i){return}if(e.isFirstColumn()||i){n.getColumns().forEach((function(t){if(t!==e){t.setIsFirstColumn(i&&a);a=false}t.rerenderSubtitle()}))}n.getFirstColumn().rerenderSubtitle()}))["catch"]((function(t){n.showErrorFromResponse(t,true)}))}},{key:"transformColumnActionResponseToColumnOptions",value:function t(e){return{id:e.data.stage.id,name:e.data.stage.name,color:e.data.stage.color,total:e.data.stage.total,data:e.data.stage}}},{key:"getColumnItems",value:function t(e){var n=e.getPagination().page+1;var i=this.getData().pageSize;var a=new BX.Promise;o.ajax.runComponentAction("bitrix:rpa.kanban","getColumn",{mode:"class",analyticsLabel:"rpaKanbanPagination",signedParameters:this.getData().signedParameters,data:{stageId:e.getId()},navigation:{page:n,size:i}}).then((function(t){var e=[];t.data.items.forEach((function(t){e.push({id:t.id,columnId:t.stageId,name:t.name,data:t})}));a.fulfill(e)}))["catch"]((function(t){var e=t.errors.pop().message;a.reject(e)}));return a}},{key:"insertItem",value:function t(e){if(!(e instanceof K)){return}var n=null;var i=this.getColumn(e.getStageId());if(i){n=i.getFirstItem();this.moveItem(e,e.getStageId(),n);e.processPermissions()}else{this.removeItem(e)}}},{key:"onApplyFilter",value:function t(e,n,i,a,s){var r=this;if(o.Type.isPlainObject(s)){s.autoResolve=false}this.startProgress();o.ajax.runComponentAction("bitrix:rpa.kanban","get",{analyticsLabel:"rpaKanbanApplyFilter",signedParameters:this.getData().signedParameters,mode:"class"}).then((function(t){r.stopProgress();r.getColumns().forEach((function(t){var e=t.getPagination();if(e){e.page=1}}));r.getColumns().forEach((function(t){r.removeColumn(t)}));r.removeItems();r.loadData(t.data.kanban);if(!o.Type.isNil(a)){a.fulfill()}}))["catch"]((function(t){r.stopProgress();r.showErrorFromResponse(t);if(!o.Type.isNil(a)){a.reject()}}))}},{key:"loadData",value:function t(n){if(o.Type.isPlainObject(n.data)){this.addUsers(n.data.users);this.data.fields=n.data.fields}babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"loadData",this).call(this,n)}},{key:"addUsers",value:function t(e){var n=this;if(o.Type.isPlainObject(e)){if(!this.users){this.users=new Map}Object.keys(e).forEach((function(t){t=o.Text.toInteger(t);if(t>0){n.users.set(t,e[t])}}))}}},{key:"getUser",value:function t(e){if(!this.users){this.users=new Map}return this.users.get(e)}},{key:"getFields",value:function t(){var e=this.getData().fields;if(!e||!o.Type.isPlainObject(e)){e={}}return e}},{key:"onOpenSelectFieldMenu",value:function t(e,n){n.cancel=true;var i="rpa-kanban-column-select-fields-menu-"+this.getTypeId();var a=d.PopupWindowManager.getPopupById(i);if(!a){a=new d.PopupMenuWindow({id:"rpa-kanban-column-select-fields-menu-"+this.getTypeId(),bindElement:n.button,items:[{text:o.Loc.getMessage("RPA_KANBAN_FIELDS_VIEW_SETTINGS"),onclick:this.onSelectFieldsViewSettingsClick.bind(this)},{text:o.Loc.getMessage("RPA_KANBAN_FIELDS_MODIFY_SETTINGS"),onclick:this.onSelectFieldsModifySettingsClick.bind(this)}],autoHide:true,closeByEsc:true,cacheable:false})}else{a.setBindElement(n.button)}a.show()}},{key:"onSelectFieldsViewSettingsClick",value:function t(){var e=this;if(!this.canAddColumns()){return}var n=this.getFields();var i=[];Object.keys(n).forEach((function(t){i.push({title:n[t].title,name:t,checked:n[t].isVisibleOnKanban})}));var a=new c.FieldsPopup("rpa-kanban-view-"+this.getTypeId(),i,o.Loc.getMessage("RPA_KANBAN_FIELDS_VIEW_SETTINGS"));a.show().then((function(t){if(t!==false){if(e.isProgress()){return}e.startProgress();o.ajax.runAction("rpa.fields.setVisibilitySettings",{analyticsLabel:"rpaKanbanSaveVisibleFields",data:{typeId:e.getTypeId(),fields:Array.from(t),visibility:"kanban"}}).then((function(n){e.stopProgress();Object.keys(e.getFields()).forEach((function(n){e.data.fields[n]["isVisibleOnKanban"]=t.has(n)}));e.getColumns().forEach((function(t){t.getItems().forEach((function(t){t.render()}))}))}))["catch"]((function(t){e.stopProgress();e.showErrorFromResponse(t)}))}}))}},{key:"onSelectFieldsModifySettingsClick",value:function t(){var e=this;if(!this.canAddColumns()){return}var n=this.getFirstColumn();if(!n){return}var i=n.getEditor();if(!i){return}var a=this.getFields();var s=[];Object.keys(a).forEach((function(t){if(a[t].canBeEdited){s.push({title:a[t].title,name:t,checked:!!i.getControlById(t)})}}));var r=new c.FieldsPopup("rpa-kanban-edit-"+this.getTypeId(),s,o.Loc.getMessage("RPA_KANBAN_FIELDS_MODIFY_SETTINGS"));r.show().then((function(t){if(!t){return}if(e.isProgress()){return}e.startProgress();o.ajax.runAction("rpa.fields.setVisibilitySettings",{data:{typeId:e.getTypeId(),fields:Array.from(t),visibility:"create"},analyticsLabel:"rpaKanbanSaveCreateFields"}).then((function(n){e.stopProgress();e.syncEditorFields(i,t)}))["catch"]((function(t){e.stopProgress();e.showErrorFromResponse(t)}))}))}},{key:"syncEditorFields",value:function t(e,n){var i=this.getFields();var a=this.getEditorMainSection(e);if(!a){return}Object.keys(i).forEach((function(t){var i=e.getControlById(t);if(i&&!n.has(t)){a.removeChild(i,{enableSaving:false})}else if(!i&&n.has(t)){var s=e.getAvailableSchemeElementByName(t);if(s){var r=e.createControl(s.getType(),s.getName(),{schemeElement:s,model:e._model,mode:e._mode});if(r){a.addChild(r,{layout:{forceDisplay:true},enableSaving:false})}}}}))}},{key:"getEditorMainSection",value:function t(e){var n=e.getControlById("main");if(n instanceof BX.UI.EntityEditorColumn){n=n.getChildById("main")}return n}},{key:"isProgress",value:function t(){return this.progress===true}},{key:"startProgress",value:function t(){this.progress=true;this.showLoader().fadeOut();return this}},{key:"stopProgress",value:function t(){this.progress=false;this.hideLoader().fadeIn();return this}},{key:"showLoader",value:function t(){this.getLoader().style.display="block";return this}},{key:"hideLoader",value:function t(){this.getLoader().style.display="none";return this}},{key:"deleteItem",value:function t(e){var n=this;if(this.isProgress()){return}this.startProgress();o.ajax.runAction("rpa.item.delete",{analyticsLabel:"rpaKanbanItemDelete",data:{typeId:this.getTypeId(),id:e.getId()}}).then((function(){if(n.getItem(e)){e.getColumn().removeItem(e)}n.stopProgress()}))["catch"]((function(t){n.stopProgress();n.showErrorFromResponse(t)}))}}]);return e}(s.Kanban.Grid);var V=function(){function t(e,n,i){babelHelpers.classCallCheck(this,t);this.item=e;this.action=n;this.restore=i;this.timeoutId=null}babelHelpers.createClass(t,[{key:"start",value:function t(e){this.timeoutId=setTimeout(this.run.bind(this),e)}},{key:"run",value:function t(){clearTimeout(this.timeoutId);this.timeoutId=null;if(o.Type.isFunction(this.action)){this.action(this.item)}}},{key:"cancel",value:function t(){clearTimeout(this.timeoutId);this.timeoutId=null;if(o.Type.isFunction(this.restore)){this.restore(this.item)}}},{key:"isCompleted",value:function t(){return!(this.timeoutId>0)}}]);return t}();var q={Grid:X,Item:K,Column:B};t.Kanban=q})(this.BX.Rpa=this.BX.Rpa||{},BX,BX.UI,BX,BX,BX,BX.Rpa,BX,BX.Rpa,BX.UI.Dialogs,BX.Main,BX.Rpa);
//# sourceMappingURL=kanban.bundle.map.js