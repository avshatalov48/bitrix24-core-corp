this.BX=this.BX||{};(function(t,e,n,i,a,s,r,o,l,u){"use strict";var d=function(){function t(e){var n=this;babelHelpers.classCallCheck(this,t);this.eventIds=new Set;if(e instanceof a.Kanban.Grid){this.grid=e;if(s.Type.isArray(this.grid.getData().eventIds)){this.grid.getData().eventIds.forEach(function(t){n.eventIds.add(t)})}if(s.Type.isString(e.getData().pullTag)&&s.Type.isString(e.getData().moduleId)&&e.getData().userId>0){this.init()}}}babelHelpers.createClass(t,[{key:"registerEventId",value:function t(e){this.eventIds.add(e)}},{key:"registerRandomEventId",value:function t(){var e=s.Text.getRandom();this.registerEventId(e);return e}},{key:"init",value:function t(){var e=this;s.Event.ready(function(){var t=BX.PULL;if(!t){console.error("pull is not initialized");return}if(s.Type.isString(e.grid.getData().pullTag)){t.subscribe({moduleId:e.grid.getData().moduleId,command:e.grid.getData().pullTag,callback:function t(n){if(s.Type.isString(n.eventName)){if(s.Type.isString(n.eventId)){if(e.eventIds.has(n.eventId)){return}}if(n.eventName.indexOf("ITEMUPDATED"+e.grid.getTypeId())===0&&s.Type.isPlainObject(n.item)){e.onPullItemUpdated(n)}else if(n.eventName==="ITEMADDED"+e.grid.getTypeId()&&s.Type.isPlainObject(n.item)){e.onPullItemAdded(n)}else if(n.eventName.indexOf("ITEMDELETED"+e.grid.getTypeId())===0&&s.Type.isPlainObject(n.item)){e.onPullItemDeleted(n)}else if(n.eventName==="STAGEADDED"+e.grid.getTypeId()&&s.Type.isPlainObject(n.stage)){e.onPullStageAdded(n)}else if(n.eventName.indexOf("STAGEUPDATED"+e.grid.getTypeId())===0&&s.Type.isPlainObject(n.stage)){e.onPullStageUpdated(n)}else if(n.eventName.indexOf("STAGEDELETED"+e.grid.getTypeId())===0&&s.Type.isPlainObject(n.stage)){e.onPullStageDeleted(n)}else if(n.eventName==="ROBOTADDED"+e.grid.getTypeId()&&s.Type.isPlainObject(n.robot)){e.onPullRobotAdded(n)}else if(n.eventName.indexOf("ROBOTUPDATED"+e.grid.getTypeId())===0&&s.Type.isPlainObject(n.robot)){e.onPullRobotUpdated(n)}else if(n.eventName.indexOf("ROBOTDELETED"+e.grid.getTypeId())===0&&s.Type.isPlainObject(n.robot)){e.onPullRobotDeleted(n)}else if(n.eventName.indexOf("TYPEUPDATED"+e.grid.getTypeId())===0){e.onPullTypeUpdated()}}}});t.extendWatch(e.grid.getData().pullTag)}if(s.Type.isString(e.grid.getData().taskCountersPullTag)){t.subscribe({moduleId:e.grid.getData().moduleId,command:e.grid.getData().taskCountersPullTag,callback:function t(n){if(s.Type.isString(n.eventId)){if(e.eventIds.has(n.eventId)){return}}if(e.grid.getTypeId()===s.Text.toInteger(n.typeId)){e.onPullCounters(n)}}});t.extendWatch(e.grid.getData().taskCountersPullTag)}})}},{key:"onPullItemUpdated",value:function t(e){this.grid.addUsers(e.item.users);var n=this.grid.getItem(e.item.id);if(n){n.setData(e.item);this.grid.insertItem(n)}else{var i=this.grid.getColumn(e.item.stageId);if(i&&(i.isCanMoveFrom()||i.canAddItems())){this.onPullItemAdded(e)}}}},{key:"onPullItemAdded",value:function t(e){var n=e.item;this.grid.addUsers(n.users);var i=this.grid.getItem(n.id);if(i){return}var s=new a.Kanban.Item({id:n.id,columnId:n.stageId,name:n.name,data:n});s.setGrid(this.grid);this.grid.items[s.getId()]=s;var r=this.grid.getColumn(s.getStageId());if(r&&(r.isCanMoveFrom()||r.canAddItems())){r.addItem(s,r.getFirstItem())}}},{key:"onPullItemDeleted",value:function t(e){if(!s.Type.isPlainObject(e.item)){return}this.grid.removeItem(e.item.id)}},{key:"onPullStageAdded",value:function t(e){this.grid.onApplyFilter()}},{key:"onPullStageUpdated",value:function t(e){var n=this.grid.getColumn(e.stage.id);if(n){n.update(e)}}},{key:"onPullStageDeleted",value:function t(e){this.grid.removeColumn(e.stage.id)}},{key:"onPullRobotAdded",value:function t(e){this.onPullRobotChanged(e.robot.stageId)}},{key:"onPullRobotUpdated",value:function t(e){this.onPullRobotChanged(e.robot.stageId)}},{key:"onPullRobotDeleted",value:function t(e){if(s.Type.isPlainObject(e.robot)&&s.Type.isString(e.robot.robotName)){var n=this.grid.getColumn(e.robot.stageId);if(n){n.setTasks(n.getTasks().filter(function(t){return t.robotName!==e.robot.robotName}));n.rerenderSubtitle()}}}},{key:"onPullRobotChanged",value:function t(e){var n=this.grid.getColumn(e);if(n){n.loadTasks().then(function(){n.rerenderSubtitle()}).catch(function(){})}}},{key:"onPullCounters",value:function t(e){var n=s.Text.toInteger(e.typeId);var i=s.Text.toInteger(e.itemId);if(n!==this.grid.getTypeId()){return}var a=this.grid.getItem(i);if(a){var r=a.getTasksCounter();if(e.counter==="+1"){r++}else if(e.counter==="-1"){r--}a.setTasksCounter(r);if(s.Type.isPlainObject(e.tasksFaces)){a.setTasksParticipants(e.tasksFaces)}a.render()}}},{key:"onPullTypeUpdated",value:function t(){this.grid.onApplyFilter()}}]);return t}();function c(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="rpa-kanban-tasks-popup-inner" data-role="rpa-kanban-column-tasks-item">\n\t\t\t\t<div class="rpa-kanban-tasks-popup-list">\n\t\t\t\t\t','\n\t\t\t\t</div>\n\t\t\t\t<a href="','" class="rpa-kanban-tasks-popup-add">',"</a>\n\t\t\t</div>"]);c=function e(){return t};return t}function g(){var t=babelHelpers.taggedTemplateLiteral(['<div class="rpa-kanban-tasks-popup-item">\n\t\t\t\t\t\t<a href="','" class="rpa-kanban-tasks-popup-name">','</a>\n\t\t\t\t\t\t<div class="rpa-kanban-tasks-popup-desc">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t<span class="rpa-kanban-tasks-popup-delete" onclick="','">',"</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>"]);g=function e(){return t};return t}function h(){var t=babelHelpers.taggedTemplateLiteral(['<span class="rpa-kanban-column-task-responsible-item rpa-kanban-column-task-responsible-item-other">\n\t\t\t\t\t\t<span class="rpa-kanban-column-task-responsible-other-text">+',"</span>\n\t\t\t\t\t</span>"]);h=function e(){return t};return t}function p(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="rpa-kanban-column-task-responsible">\n\t\t\t\t\t<div class="rpa-kanban-column-task-responsible-list" style="background-color: ','" onclick="','">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"]);p=function e(){return t};return t}function m(){var t=babelHelpers.taggedTemplateLiteral(['<a href="','" class="rpa-kanban-column-task-responsible-add"></a>']);m=function e(){return t};return t}function f(){var t=babelHelpers.taggedTemplateLiteral(['<span class="rpa-kanban-column-task-responsible-add"></span>']);f=function e(){return t};return t}function v(){var t=babelHelpers.taggedTemplateLiteral(['<span class="rpa-kanban-column-task-responsible-item" title="','">\n\t\t\t\t\t<span class="rpa-kanban-column-task-responsible-img" style="border-color: ','">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>\n\t\t\t\t</span>"]);v=function e(){return t};return t}function b(){var t=babelHelpers.taggedTemplateLiteral(['<img src="','" alt="">']);b=function e(){return t};return t}function y(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="rpa-kanban-column-task-btn" onclick="','">\n\t\t\t\t\t\t<span class="rpa-kanban-column-task-btn-title">','</span>\n\t\t\t\t\t\t<span class="rpa-kanban-column-task-btn-counter">',"</span>\n\t\t\t\t\t</div>\n\t\t\t\t"]);y=function e(){return t};return t}function k(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="rpa-kanban-column-task-block">\n\t\t\t\t\t\t<div class="rpa-kanban-column-task-inner">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t","\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t"]);k=function e(){return t};return t}function I(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="main-kanban-column-settings-button">\n\t\t\t\t\t\t<a class="ui-btn ui-btn-xs ui-btn-light-border ui-btn-no-caps ui-btn-round ui-btn-themes main-kanban-column-settings-button-rpa" href="','">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t"]);I=function e(){return t};return t}function T(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="main-kanban-column-settings-button" onclick="','">\n\t\t\t\t<button class="ui-btn ui-btn-xs ui-btn-link ui-btn-icon-setting"></button>\n\t\t\t</div>']);T=function e(){return t};return t}function C(){var t=babelHelpers.taggedTemplateLiteral(['<div class="rpa-kanban-form-buttons">\n\t\t\t\t<button class="ui-btn ui-btn-sm ui-btn-primary" onclick="','">','</button>\n\t\t\t\t<button class="ui-btn ui-btn-sm ui-btn-link" onclick="','">',"</button>\n\t\t\t</div>"]);C=function e(){return t};return t}function E(){var t=babelHelpers.taggedTemplateLiteral(['<div class="','"></div>']);E=function e(){return t};return t}function P(){var t=babelHelpers.taggedTemplateLiteral(['<div class="main-kanban-column-add-item-button" onclick="','"></div>']);P=function e(){return t};return t}function S(){var t=babelHelpers.taggedTemplateLiteral(['<div class="main-kanban-column-subtitle-box"></div>']);S=function e(){return t};return t}var A=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).apply(this,arguments))}babelHelpers.createClass(e,[{key:"getId",value:function t(){return parseInt(babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"getId",this).call(this))}},{key:"setOptions",value:function t(n){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"setOptions",this).call(this,n);this.canMoveFrom=!!n.canMoveFrom;this.setPermissionProperties()}},{key:"isDroppable",value:function t(){return babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"isDroppable",this).call(this)||this.canMoveTo()}},{key:"isFirstColumn",value:function t(){return this.data.isFirst===true}},{key:"setIsFirstColumn",value:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this.data.isFirst=e;return this}},{key:"onAfterRender",value:function t(){if(!this.isDroppable()){this.getContainer().style.backgroundColor="rgba(204, 204, 204, 0.2)"}else{this.getContainer().style.backgroundColor="transparent"}}},{key:"rerenderSubtitle",value:function t(){var e=this;var n=["responsible","subTitleTasksButton","subTitleTasks","subTitleAddTaskButton","subTitleSettingsButton","subTitleAddButton"];n.forEach(function(t){s.Dom.clean(e.layout[t]);e.layout[t]=null});s.Dom.clean(this.layout.subtitleNode);if(this.tasksPopup){this.tasksPopup.destroy()}this.renderSubTitle()}},{key:"renderSubTitle",value:function t(){var e=this.getSubTitleNode();if(this.isEditable()){var n=this.getTasks();var i=this.getData()["robotsCount"];if(n&&n.length>0){e.appendChild(this.renderSubTitleTasks(n))}else{if(!this.isFirstColumn()||this.isFirstColumn()&&!i){e.appendChild(this.renderSubTitleAddTaskButton())}}}if(this.isFirstColumn()&&this.canAddItems()){e.appendChild(this.renderSubTitleAddButton())}else{if(this.layout.subTitleAddButton){s.Dom.remove(this.layout.subTitleAddButton);this.layout.subTitleAddButton=null}}return e}},{key:"getSubTitleNode",value:function t(){if(!this.layout.subtitleNode){this.layout.subtitleNode=s.Tag.render(S())}return this.layout.subtitleNode}},{key:"getContainer",value:function t(){var n=babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"getContainer",this).call(this);if(this.isFirstColumn()&&this.canAddItems()){var i=this.renderQuickFormContainer();var a=this.getItemsContainer();if(i&&a){if(i.parentNode!==a){s.Dom.prepend(i,a)}}}return n}},{key:"renderSubTitleAddButton",value:function t(){if(!this.layout.subTitleAddButton){this.layout.subTitleAddButton=s.Tag.render(P(),this.handleAddItemButtonClick.bind(this))}return this.layout.subTitleAddButton}},{key:"renderQuickFormContainer",value:function t(){if(!this.layout.quickFormContainer){var e="rpa-kanban-form";if(this.getGrid().canAddColumns()){e+=" rpa-kanban-form-with-settings"}this.layout.quickFormContainer=s.Tag.render(E(),e)}return this.layout.quickFormContainer}},{key:"renderQuickFormButtons",value:function t(){if(!this.layout.quickFormButtons){this.layout.quickFormButtons=s.Tag.render(C(),this.handleFormSaveButtonClick.bind(this),s.Loc.getMessage("RPA_KANBAN_QUICK_FORM_SAVE_BUTTON"),this.handleFormCancelButtonClick.bind(this),s.Loc.getMessage("RPA_KANBAN_QUICK_FORM_CANCEL_BUTTON"))}return this.layout.quickFormButtons}},{key:"handleAddItemButtonClick",value:function t(){var e=this;if(this.getGrid().isProgress()){return}if(this.getGrid().isCreateItemRestricted()){r.Manager.Instance.showFeatureSlider();return}if(this.isFormVisible()){return}this.getGrid().startProgress();s.ajax.runAction("rpa.item.getEditor",{analyticsLabel:"rpaItemOpenQuickForm",data:{typeId:this.getGrid().getTypeId(),id:0,stageId:this.getId(),eventId:this.getGrid().pullManager.registerRandomEventId()}}).then(function(t){e.getGrid().stopProgress();s.Runtime.html(e.layout.quickFormContainer,t.data.html).then(function(){e.addSelectButtonToEditor();s.Dom.append(e.renderQuickFormButtons(),e.layout.quickFormContainer);e.showForm();e.bindKeyDownEvents()})}).catch(function(t){e.getGrid().stopProgress();e.getGrid().showErrorFromResponse(t)})}},{key:"showForm",value:function t(){this.getBody().scrollTop=0;this.layout.quickFormContainer.style.display="block";this.layout.quickFormButtons.style.display="block"}},{key:"hideForm",value:function t(){this.layout.quickFormContainer.style.display="none";this.layout.quickFormButtons.style.display="none"}},{key:"isFormVisible",value:function t(){return this.layout.quickFormContainer.style.display==="block"&&this.layout.quickFormButtons.style.display==="block"}},{key:"getEditor",value:function t(){return r.Manager.getEditor(this.getGrid().getTypeId(),0)}},{key:"handleFormCancelButtonClick",value:function t(){var e=this.getEditor();if(e){e.rollback();e.refreshLayout()}this.hideForm()}},{key:"handleFormSaveButtonClick",value:function t(){var e=this.getEditor();if(e){e.save();this.bindEditorEvents()}else{this.hideForm()}}},{key:"onEditorSubmit",value:function t(e,n){if(this.isFormVisible()){this.hideForm();var i=n.data.item;this.getGrid().addUsers(n.data.item.users);var s=this.getGrid().getItem(i.id);if(s){return}var r=new a.Kanban.Item({id:i.id,columnId:i.stageId,name:i.name,data:i});r.setGrid(this.getGrid());this.getGrid().items[r.getId()]=r;var o=this.getGrid().getColumn(r.getStageId());if(o){o.addItem(r,o.getFirstItem())}}}},{key:"onEditorErrors",value:function t(e){if(this.isFormVisible()){this.hideForm();this.getGrid().showErrorFromResponse(e)}}},{key:"bindEditorEvents",value:function t(){if(!this.isEditorEventsBinded){this.isEditorEventsBinded=true;BX.addCustomEvent(window,"BX.UI.EntityEditorAjax:onSubmitFailure",this.onEditorErrors.bind(this));BX.addCustomEvent(window,"BX.UI.EntityEditorAjax:onSubmit",this.onEditorSubmit.bind(this))}}},{key:"bindKeyDownEvents",value:function t(){var e=this;if(!this.isKeyDownEventsBinded){this.isKeyDownEventsBinded=true;var n=function t(n){if((n.code==="Enter"||n.code==="NumpadEnter")&&e.isFormVisible()){e.handleFormSaveButtonClick()}};var i=function t(e){return e==="MetaRight"||e==="MetaLeft"||e==="ControlRight"||e==="ControlLeft"};s.Event.bind(window,"keydown",function(t){if(i(t.code)){s.Event.bind(window,"keydown",n)}else if(t.code==="Escape"){e.handleFormCancelButtonClick()}});s.Event.bind(window,"keyup",function(t){if(i(t.code)){s.Event.unbind(window,"keydown",n)}})}}},{key:"renderSubTitleSettingsButton",value:function t(){if(!this.layout.subTitleSettingsButton){this.layout.subTitleSettingsButton=s.Tag.render(T(),this.openSettings.bind(this))}return this.layout.subTitleSettingsButton}},{key:"openSettings",value:function t(){var e=this;var n=this.data.settingsUrl;if(n){r.Manager.openSlider(n).then(function(t){var n=t.getData().get("response");if(n){e.update(n.data)}})}}},{key:"renderSubTitleAddTaskButton",value:function t(){if(!this.layout.subTitleAddTaskButton){var e=this.buildAddRobotUrl();this.layout.subTitleAddTaskButton=s.Tag.render(I(),e,s.Loc.getMessage("RPA_KANBAN_COLUMN_ADD_TASK_BTN"))}return this.layout.subTitleAddTaskButton}},{key:"renderSubTitleTasks",value:function t(e){if(!this.layout.subTitleTasks){this.layout.subTitleTasks=s.Tag.render(k(),this.renderSubTitleResponsible(e,true),this.renderSubTitleTasksButton(e))}return this.layout.subTitleTasks}},{key:"renderSubTitleTasksButton",value:function t(e){if(!this.layout.subTitleTasksButton){this.layout.subTitleTasksButton=s.Tag.render(y(),this.showTasks.bind(this,e),s.Loc.getMessage("RPA_KANBAN_TASKS"),e.length)}return this.layout.subTitleTasksButton}},{key:"renderSubTitleResponsible",value:function t(e,n){var i=this;var a=[];var r=this.showTasks.bind(this,e);e.forEach(function(t){t.users.forEach(function(t){var e=t.photoSrc?s.Tag.render(b(),t.photoSrc):null;a.push(s.Tag.render(v(),t.name,"#"+i.getColor(),e))})});a=this.sliceResponsibleListElements(a);var o=s.Tag.render(f());if(n){BX.bind(o,"click",r)}else{var l=e[0];if(l.canAppendResponsibles){BX.Bizproc.UserSelector.decorateNode(o,{isOnlyDialogMode:true,callbacks:{select:this.addTaskUserHandler.bind(this,l)}})}else{o=s.Tag.render(m(),this.buildEditRobotUrl(l["robotName"]))}}return s.Tag.render(p(),"#"+this.getColor(),r,a,o)}},{key:"sliceResponsibleListElements",value:function t(e){if(e.length>4){var n=e.length-4;e=e.slice(0,4);e.push(s.Tag.render(h(),n))}return e}},{key:"showTasks",value:function t(e){this.getTasksPopup(e).show()}},{key:"addTaskUserHandler",value:function t(e,n,i){s.ajax.runAction("rpa.task.addUser",{analyticsLabel:"rpaTaskAddUser",data:{typeId:this.getGrid().getData().typeId,stageId:this.getId(),robotName:e.robotName,userValue:n},getParameters:{context:"kanban"}}).then(function(t){})}},{key:"getTasksPopup",value:function t(e){var n=this;if(!this.tasksPopup){var i=this.layout.subTitleTasksButton;if(!i){i=this.renderSubTitleTasksButton(this.getTasks())}this.tasksPopup=new l.Popup("rpa-tasks-"+this.getId(),i,{autoHide:true,draggable:false,offsetTop:-5,offsetLeft:30,noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,cacheable:false,angle:{offset:81,position:"top"},events:{onPopupDestroy:function t(){n.tasksPopup=null}},overlay:{backgroundColor:"transparent"},content:this.renderTasksPopup(e)})}return this.tasksPopup}},{key:"renderTasksPopup",value:function t(e){var n=this;var i=e.map(function(t){return s.Tag.render(g(),n.buildEditRobotUrl(t["robotName"]),s.Text.encode(t["title"]),n.renderSubTitleResponsible([t]),n.deleteTaskHandler.bind(n,t),s.Loc.getMessage("RPA_KANBAN_COLUMN_DELETE_TASK_BTN"))});return s.Tag.render(c(),i,this.buildAddRobotUrl(),s.Loc.getMessage("RPA_KANBAN_COLUMN_ADD_TASK_BTN"))}},{key:"deleteTaskHandler",value:function t(e,n){var i=this;o.MessageBox.show({message:s.Loc.getMessage("RPA_KANBAN_COLUMN_DELETE_TASK_CONFIRM"),buttons:o.MessageBoxButtons.OK_CANCEL,onOk:function t(){if(i.getGrid().isProgress()){return}i.getGrid().startProgress();var n=new BX.Promise;s.ajax.runAction("rpa.task.delete",{analyticsLabel:"rpaKanbanTaskDelete",data:{typeId:i.getGrid().getData().typeId,stageId:i.getId(),robotName:e["robotName"],eventId:i.getGrid().pullManager.registerRandomEventId()},getParameters:{context:"kanban"}}).then(function(){if(i.tasksPopup){i.tasksPopup.destroy()}i.setTasks(i.getTasks().filter(function(t){return t.robotName!==e.robotName}));i.rerenderSubtitle();i.getGrid().stopProgress();n.fulfill()}).catch(function(t){i.getGrid().stopProgress();n.reject()});return n},popupOptions:{zIndexAbsolute:1200}})}},{key:"buildAddRobotUrl",value:function t(){var e=this.getGrid().getData().typeId;var n=new s.Uri("/rpa/automation/".concat(e,"/addrobot/"));n.setQueryParams({stage:this.getId()});return n}},{key:"buildEditRobotUrl",value:function t(e){var n=this.getGrid().getData().typeId;var i=new s.Uri("/rpa/automation/".concat(n,"/editrobot/"));i.setQueryParams({stage:this.getId(),robotName:e});return i}},{key:"getFields",value:function t(){var e=this.getData().userFields;if(!e||!s.Type.isPlainObject(e)){e=this.getGrid().getFields()}if(!e||!s.Type.isPlainObject(e)){e={}}return e}},{key:"getPossibleNextStages",value:function t(){return this.getData().possibleNextStages}},{key:"getSort",value:function t(){return parseInt(this.getData().sort)}},{key:"isCanMoveFrom",value:function t(){return!!this.canMoveFrom}},{key:"canMoveTo",value:function t(){var e=this;var n=false;this.getGrid().getColumns().forEach(function(t){if(t.isCanMoveFrom()&&t.getPossibleNextStages().includes(e.getId())){n=true}});return n}},{key:"update",value:function t(e){var n=this;if(s.Type.isPlainObject(e)&&e.stage&&s.Type.isPlainObject(e.stage)&&parseInt(e.stage.id)===this.getId()){var i=e.stage;this.setName(i.name);this.setColor(i.color);this.setData(i);this.processPermissions(i);this.getGrid().moveColumn(this,this.getTargetColumn());this.render();this.getGrid().getColumns().forEach(function(t){if(t!==n){t.processPermissions();t.onAfterRender()}})}}},{key:"getTargetColumn",value:function t(){var e=this;var n=this.getGrid().getColumns();var i=null;n.forEach(function(t){if(t.getId()!==e.getId()&&t.getSort()>=e.getSort()&&(!i||i.getSort()>t.getSort())){i=t}});return i}},{key:"processPermissions",value:function t(){this.setPermissionProperties();this.processDraggingOptions()}},{key:"setPermissionProperties",value:function t(){var e=this;var n=this.getData();var i={};if(n.permissions&&s.Type.isPlainObject(n.permissions)){i=n.permissions}Object.keys(i).forEach(function(t){e[t]=i[t]})}},{key:"processDraggingOptions",value:function t(){if(this.isDraggable()){this.makeDraggable()}else{this.disableDragging()}if(this.isDroppable()){this.makeDroppable()}else{this.disableDropping()}this.getItems().forEach(function(t){t.processPermissions()})}},{key:"loadTasks",value:function t(){var e=this;return new Promise(function(t,n){e.getGrid().startProgress();s.ajax.runAction("rpa.stage.getTasks",{data:{id:e.getId()}}).then(function(n){e.getGrid().stopProgress();e.setTasks(n.data.tasks);t()}).catch(function(t){e.getGrid().stopProgress().showErrorFromResponse(t);n()})})}},{key:"getTasks",value:function t(){if(!this.data){this.data={}}if(!this.data.tasks||!s.Type.isArray(this.data.tasks)){this.data.tasks=[]}return Array.from(this.data.tasks)}},{key:"setTasks",value:function t(e){if(!s.Type.isArray(e)){e=[]}this.data.tasks=e;return this}},{key:"addSelectButtonToEditor",value:function t(){var e=this.getEditor();if(!e){return}var n=this.getGrid().getEditorMainSection(e);if(!n){return}if(n._addChildButton){return}n.ensureButtonPanelCreated();n._addChildButton=BX.create("span",{props:{className:"ui-entity-editor-content-add-lnk"},text:BX.message("UI_ENTITY_EDITOR_SELECT_FIELD"),events:{click:BX.delegate(n.onAddChildBtnClick,n)}});n.addButtonElement(n._addChildButton,{position:"left"})}}]);return e}(i.Kanban.Column);function B(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="rpa-kanban-item-counter" onclick="','" ','>\n\t\t\t\t\t<div class="rpa-kanban-item-counter-text">','</div>\n\t\t\t\t\t<div class="rpa-kanban-item-counter-value">',"</div>\n\t\t\t\t</div>\n\t\t"]);B=function e(){return t};return t}function D(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<a class="rpa-kanban-column-task-responsible-item ','" \n\t\t\t href="','" title="','">\n\t\t\t\t<span class="rpa-kanban-column-task-responsible-img">\n\t\t\t\t\t',"\n\t\t\t\t</span>\n\t\t\t</a>\n\t\t"]);D=function e(){return t};return t}function F(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="rpa-kanban-column-task-responsible-list">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t"]);F=function e(){return t};return t}function N(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="rpa-kanban-item-contact">\n\t\t\t\t\t<span class="rpa-kanban-item-contact-im"></span>\n\t\t\t\t</div>\n\t\t']);N=function e(){return t};return t}function M(){var t=babelHelpers.taggedTemplateLiteral(['<div class="rpa-kanban-item-user">\n\t\t\t\t','\n\t\t\t\t<a class="rpa-kanban-item-user-name rpa-kanban-item-field-item-value" href="','">',"</a>\n\t\t\t</div>"]);M=function e(){return t};return t}function R(){var t=babelHelpers.taggedTemplateLiteral(['<a class="rpa-kanban-item-user-photo" href="','" style="background-image: url(',')"></a>']);R=function e(){return t};return t}function w(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="rpa-kanban-item-description"></div>\n\t\t']);w=function e(){return t};return t}function O(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="rpa-kanban-item-shadow"></div>\n\t\t']);O=function e(){return t};return t}function L(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t<div class="rpa-kanban-item-field-item">\n\t\t\t\t\t\t\t<span class="rpa-kanban-item-field-item-name">','</span>\n\t\t\t\t\t\t\t<span class="rpa-kanban-item-field-item-value">',"</span>\n\t\t\t\t\t\t</div>"]);L=function e(){return t};return t}function _(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t<div class="rpa-kanban-item-field-item">\n\t\t\t\t\t\t\t\t<span class="rpa-kanban-item-field-item-name">',"</span>\n\t\t\t\t\t\t\t\t","\n\t\t\t\t\t\t\t</div>"]);_=function e(){return t};return t}function x(){var t=babelHelpers.taggedTemplateLiteral(['<div class="rpa-kanban-item-field-list"></div>']);x=function e(){return t};return t}function U(){var t=babelHelpers.taggedTemplateLiteral(['<a class="rpa-kanban-item-title" href="','">',"</a>"]);U=function e(){return t};return t}function G(){var t=babelHelpers.taggedTemplateLiteral(['<div ondblclick="','" class="main-kanban-item-default rpa-kanban-item"></div>']);G=function e(){return t};return t}var H=function(t){babelHelpers.inherits(e,t);function e(){var t;var n;babelHelpers.classCallCheck(this,e);for(var i=arguments.length,a=new Array(i),s=0;s<i;s++){a[s]=arguments[s]}n=babelHelpers.possibleConstructorReturn(this,(t=babelHelpers.getPrototypeOf(e)).call.apply(t,[this].concat(a)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"currentState",{});return n}babelHelpers.createClass(e,[{key:"setOptions",value:function t(n){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"setOptions",this).call(this,n);this.setPermissionProperties()}},{key:"render",value:function t(){var e=this;this.layout.title=null;this.renderDescription();this.renderFieldsList();this.renderShadow();if(!this.layout.content){this.layout.content=s.Tag.render(G(),this.onDoubleClick.bind(this))}else{s.Dom.clean(this.layout.content)}if(this.layout.title){this.layout.content.appendChild(this.layout.title)}if(this.layout.fieldList){this.layout.content.appendChild(this.layout.fieldList)}if(this.layout.description){this.layout.content.appendChild(this.layout.description)}this.layout.content.appendChild(this.renderShadow());this.layout.description.appendChild(this.renderTasksParticipants());this.layout.description.appendChild(this.renderTasksCounter());this.layout.content.style.borderLeft="2px solid #"+this.getColumn().getColor();if(this.isDraggable()){this.layout.content.style.backgroundColor="#fff"}else{this.layout.content.style.backgroundColor="#aaa"}s.Event.bindOnce(this.layout.content,"animationend",function(){BX.removeClass(e.layout.container,"main-kanban-item-new")});return this.layout.content}},{key:"setTasksParticipants",value:function t(e){this.data.tasksFaces=e;return this}},{key:"getTasksCounter",value:function t(){return s.Text.toInteger(this.data.tasksCounter)}},{key:"getTasksParticipants",value:function t(){var e=s.Text.toInteger(this.getData()["createdBy"]);var n=this.getGrid().getUserId();var i=this.getGrid().getUser(e);var a=this.data.tasksFaces;var r=a.completed[0];var o=a.running.includes(n)?n:a.running[0];var l=a.completed.length;var u=a.running.length;var d=null;var c=null;if(r){d=this.getGrid().getUser(s.Text.toInteger(r))}if(o){c=this.getGrid().getUser(s.Text.toInteger(o))}return{startedBy:i,completedBy:d,waitingFor:c,completedCnt:l,waitingForCnt:u}}},{key:"setTasksCounter",value:function t(e){this.data.tasksCounter=e;return this}},{key:"bindEditorEvents",value:function t(){if(!this.isEditorEventsBinded){this.isEditorEventsBinded=true;BX.addCustomEvent(window,"BX.UI.EntityEditorAjax:onSubmitFailure",this.onEditorErrors.bind(this));BX.addCustomEvent(window,"BX.UI.EntityEditorAjax:onSubmit",this.onEditorSubmit.bind(this))}}},{key:"showEditor",value:function t(e){var n=this;s.Dom.addClass(this.layout.container,"main-kanban-item-waiting");this.bindEditorEvents();return new Promise(function(t,i){s.ajax.runAction("rpa.item.getEditor",{analyticsLabel:"rpaItemMovedMandatoryFieldsPopupOpen",data:{typeId:n.getTypeId(),id:n.getId(),stageId:e>0?e:null,eventId:n.getGrid().pullManager.registerRandomEventId()}}).then(function(e){var a=n.getPopup();if(a){s.Runtime.html(a.getContentContainer(),e.data.html).then(function(){a.show();n.editorResolve=t;n.editorReject=i})}}).catch(function(t){s.Dom.removeClass(n.layout.container,"main-kanban-item-waiting");i(t.errors)})})}},{key:"onEditorSaveClick",value:function t(){var e=this.getEditor();if(!e){this.getPopup().close();if(s.Type.isFunction(this.editorReject)){this.editorReject("Editor not found");this.editorResolve=null;this.editorReject=null}}else{e.save()}}},{key:"onEditorCancelClick",value:function t(){s.Dom.removeClass(this.layout.container,"main-kanban-item-waiting");this.getPopup().close();if(s.Type.isFunction(this.editorResolve)){this.editorResolve({cancel:true});this.editorResolve=null;this.editorReject=null}}},{key:"onEditorSubmit",value:function t(e,n){if(this.getPopup().isShown()){s.Dom.removeClass(this.layout.container,"main-kanban-item-waiting");this.getPopup().close();this.setData(n.data.item);this.saveCurrentState();this.render()}}},{key:"onEditorErrors",value:function t(e){if(this.getPopup().isShown()){s.Dom.removeClass(this.layout.container,"main-kanban-item-waiting");this.getPopup().close();if(s.Type.isFunction(this.editorReject)){this.editorReject({errors:e},false);this.editorResolve=null;this.editorReject=null}}}},{key:"getPopup",value:function t(){var e="rpa-kanban-item-popup-"+this.getId();var n=l.PopupWindowManager.getPopupById(e);if(!n){n=new l.PopupWindow(e,null,{zIndex:200,className:"",autoHide:false,closeByEsc:false,closeIcon:false,width:600,overlay:true,lightShadow:false,buttons:this.getItemPopupButtons()})}return n}},{key:"getEditor",value:function t(){return r.Manager.getEditor(this.getTypeId(),parseInt(this.getId()))}},{key:"getItemPopupButtons",value:function t(){return[new BX.PopupWindowButton({text:s.Loc.getMessage("RPA_KANBAN_POPUP_SAVE"),className:"ui-btn ui-btn-md ui-btn-primary",events:{click:this.onEditorSaveClick.bind(this)}}),new BX.PopupWindowButton({text:s.Loc.getMessage("RPA_KANBAN_POPUP_CANCEL"),className:"ui-btn ui-btn-md",events:{click:this.onEditorCancelClick.bind(this)}})]}},{key:"showTasks",value:function t(){var e=this;s.Dom.addClass(this.layout.container,"main-kanban-item-waiting");return new Promise(function(t){r.Manager.Instance.openTasks(e.getTypeId(),e.getId()).then(function(n){t(n);s.Dom.removeClass(e.layout.container,"main-kanban-item-waiting")})})}},{key:"getStageId",value:function t(){return s.Text.toInteger(this.getData().stageId)}},{key:"setStageId",value:function t(e){this.data.stageId=e;return this}},{key:"getTypeId",value:function t(){return s.Text.toInteger(this.getData().typeId)}},{key:"saveCurrentState",value:function t(){var e=this.getColumn();var n=e.getNextItemSibling(this);var i=e.getPreviousItemSibling(this);this.data.stageId=this.getColumnId();this.currentState.nextItemId=n?n.getId():0;this.currentState.previousItemId=i?i.getId():0;this.currentState.stageId=this.data.stageId;return this}},{key:"savePosition",value:function t(){var e=this;var n={id:this.getId(),typeId:this.getTypeId(),fields:{stageId:this.getStageId(),previousItemId:this.currentState.previousItemId||null},eventId:this.getGrid().pullManager.registerRandomEventId()};s.Dom.addClass(this.layout.container,"main-kanban-item-waiting");return new Promise(function(t,i){s.ajax.runAction("rpa.item.update",{analyticsLabel:"rpaItemMoved",data:n}).then(function(n){e.data=n.data.item;if(!e.moveToActualColumn()){e.render()}s.Dom.removeClass(e.layout.container,"main-kanban-item-waiting");t(n)}).catch(function(t){i(t);s.Dom.removeClass(e.layout.container,"main-kanban-item-waiting")})})}},{key:"moveToActualColumn",value:function t(){if(this.getStageId()!==this.getColumn().getId()){var e=this.getGrid().getColumn(this.getStageId());if(e){this.getGrid().moveItem(this,e,e.getFirstItem())}else{this.getGrid().moveItem(this,this.getStageId())}return true}return false}},{key:"saveSort",value:function t(){var e=this;var n={id:this.getId(),typeId:this.getTypeId(),previousItemId:this.currentState.previousItemId};s.Dom.addClass(this.layout.container,"main-kanban-item-waiting");return new Promise(function(t,i){s.ajax.runAction("rpa.item.sort",{analyticsLabel:"rpaItemSorted",data:n}).then(function(n){s.Dom.removeClass(e.layout.container,"main-kanban-item-waiting");t(n)}).catch(function(t){i(t);s.Dom.removeClass(e.layout.container,"main-kanban-item-waiting")})})}},{key:"getCurrentState",value:function t(){return Object.assign({},this.currentState)}},{key:"restoreState",value:function t(e){this.currentState=e;this.data.stageId=this.currentState.stageId;return this}},{key:"onDoubleClick",value:function t(){if(this.data.detailUrl){r.Manager.openSlider(this.data.detailUrl)}}},{key:"getMovedBy",value:function t(){return s.Text.toInteger(this.getData().movedBy)}},{key:"getUpdatedBy",value:function t(){return s.Text.toInteger(this.getData().updatedBy)}},{key:"getCreatedBy",value:function t(){return s.Text.toInteger(this.getData().createdBy)}},{key:"getName",value:function t(){return this.data.name}},{key:"renderTitle",value:function t(e){e=s.Text.encode(e);var n="javascript:void(0);";if(this.data.detailUrl){n=this.data.detailUrl}if(!this.layout.title){this.layout.title=s.Tag.render(U(),n,e)}else{this.layout.title.innerText=e}return this.layout.title}},{key:"renderFieldsList",value:function t(){var e=this;if(!this.layout.fieldList){this.layout.fieldList=s.Tag.render(x())}this.layout.fieldList.innerHTML="";var n=this.getGrid().getFields();Object.keys(n).forEach(function(t){if(n[t]["isVisibleOnKanban"]&&!e.isEmptyValue(e.getData()[t])){if(n[t]["isTitle"]){e.renderTitle(e.getData()[t])}else if(t==="createdBy"||t==="updatedBy"||t==="movedBy"){var i=e.renderUser(t);if(i){e.layout.fieldList.appendChild(s.Tag.render(_(),n[t].title,i))}}else{e.layout.fieldList.appendChild(s.Tag.render(L(),n[t].title,e.getDisplayableValue(t)))}}});return this.layout.fieldList}},{key:"renderShadow",value:function t(){return s.Tag.render(O())}},{key:"renderDescription",value:function t(){this.layout.description=s.Tag.render(w())}},{key:"renderUserPhoto",value:function t(e){var n=e.link,i=e.photo;if(s.Type.isString(n)&&s.Type.isString(i)){return s.Tag.render(R(),s.Text.encode(n),s.Text.encode(i))}return null}},{key:"renderUser",value:function t(e){var n=s.Text.toInteger(this.getData()[e]);var i=this.getGrid().getUser(n);if(i){var a=this.renderUserPhoto(i);return s.Tag.render(M(),a?a:"",s.Text.encode(i.link),s.Text.encode(i.fullName))}return null}},{key:"renderContact",value:function t(){return s.Tag.render(N())}},{key:"renderTasksParticipants",value:function t(){var e=this.getTasksParticipants(),n=e.startedBy,i=e.completedBy,a=e.waitingFor,r=e.completedCnt,o=e.waitingForCnt;var l=[];if(n){l.push(this.renderTaskParticipant(n))}if(i){l.push(this.renderTaskParticipant(i,r>1))}if(a){l.push(this.renderTaskParticipant(a,o>1))}return s.Tag.render(F(),l)}},{key:"renderTaskParticipant",value:function t(e,n){var i=e.link,a=e.photo,r=e.fullName;return s.Tag.render(D(),n?"rpa-kanban-column-task-responsible-item-more":"",s.Text.encode(i),s.Text.encode(r),a?'<img src="'.concat(s.Text.encode(a),'" alt="">'):"")}},{key:"renderTasksCounter",value:function t(){return s.Tag.render(B(),this.showTasks.bind(this),this.getTasksCounter()<=0?'style="display: none;"':"",s.Loc.getMessage("RPA_KANBAN_TASKS"),this.getTasksCounter())}},{key:"hasEmptyMandatoryFields",value:function t(e){var n=this;var i=false;if(!e){e=this.getStageId()}e=this.getGrid().getColumn(e);if(!e){throw new Error("Column not found")}var a=e.getFields();Object.keys(a).forEach(function(t){if(a[t].mandatory&&n.isEmptyValue(n.getData()[t])){i=true}});return i}},{key:"isEmptyValue",value:function t(e){return s.Type.isNil(e)||e===false||(s.Type.isString(e)||s.Type.isArray(e))&&e.length<=0||s.Type.isNumber(e)&&e===0}},{key:"update",value:function t(e){if(s.Type.isPlainObject(e)&&e.item&&s.Type.isPlainObject(e.item)&&parseInt(e.item.id)===this.getId()){this.data=e.item;this.processPermissions();this.render()}return this}},{key:"processPermissions",value:function t(){this.setPermissionProperties();this.processDraggingOptions();return this}},{key:"setPermissionProperties",value:function t(){var e=this;var n=this.getData();var i={};if(n.permissions&&s.Type.isPlainObject(n.permissions)){i=n.permissions}Object.keys(i).forEach(function(t){e[t]=i[t]});return this}},{key:"processDraggingOptions",value:function t(){if(this.isDraggable()){this.makeDraggable()}else{this.disableDragging()}this.render();return this}},{key:"getDisplayableValue",value:function t(e){var n=null;if(this.data.display&&this.data.display[e]){n=this.data.display[e]}else if(this.data[e]){n=this.data[e]}if(s.Type.isArray(n)){n=n.join(", ")}return n}},{key:"isDeletable",value:function t(){return this.canDelete!==false}}]);return e}(i.Kanban.Item);var j=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).apply(this,arguments))}babelHelpers.createClass(e,[{key:"getTypeId",value:function t(){return s.Text.toInteger(this.getData().typeId)}},{key:"getUserId",value:function t(){return s.Text.toInteger(this.getData().userId)}},{key:"isCreateItemRestricted",value:function t(){return this.getData().isCreateItemRestricted===true}},{key:"bindEvents",value:function t(){var e=this;BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemCaptured",this.onBeforeItemCaptured.bind(this));BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemRestored",this.onBeforeItemRestored.bind(this));BX.addCustomEvent("Kanban.Column:render",function(t){if(t.getGrid()===e&&t instanceof A){t.onAfterRender.apply(t)}});BX.addCustomEvent("BX.Main.Filter:apply",this.onApplyFilter.bind(this));BX.addCustomEvent(this,"Kanban.Grid:onColumnLoadAsync",function(t){t.push(function(t){return e.getColumnItems(t)})});BX.addCustomEvent(this,"Kanban.Grid:onBeforeItemMoved",this.saveItemState);BX.addCustomEvent(this,"Kanban.Grid:onItemMoved",this.onItemMoved);BX.addCustomEvent(this,"Kanban.Grid:onColumnUpdated",this.onColumnUpdated);BX.addCustomEvent(this,"Kanban.Grid:onColumnMoved",this.onColumnMoved);BX.addCustomEvent(this,"Kanban.Grid:onColumnAddedAsync",function(t){t.push(function(t){return e.addStage(t)})});BX.addCustomEvent(this,"Kanban.Grid:onColumnRemovedAsync",function(t){t.push(function(t){return e.removeStage(t)})});BX.addCustomEvent(window,"BX.UI.EntityEditorSection:onOpenChildMenu",this.onOpenSelectFieldMenu.bind(this));BX.addCustomEvent("SidePanel.Slider:onMessage",function(t){if(t.getEventId()==="userfield-list-update"){e.onApplyFilter()}});this.pullManager=new d(this)}},{key:"onBeforeItemCaptured",value:function t(e){var n=this;s.Event.EventEmitter.emit("BX.Rpa.Kanban.Grid:onBeforeItemCapturedStart",[this,e]);var i=e.getItem();if(!(i instanceof H)){return}if(!e.isActionAllowed()){return}var a=e.getDropZone();if(a.getId()==="delete"){if(!i.isDeletable()){e.denyAction();return}if(this.deleteCommand&&!this.deleteCommand.isCompleted()){this.deleteCommand.run()}this.deleteCommand=new K(i,function(t){n.deleteItem(t)},function(t){n.unhideItem(t)});this.deleteCommand.start(a.getDropZoneArea().getDropZoneTimeout())}else if(a.getData().isColumn===true){e.denyAction();var r=this.getColumn(a.getId());if(!r){i.saveCurrentState();this.hideItem(i)}else{this.moveItem(i,r)}this.moveItemToStage(i,a.getId(),i.getColumn())}}},{key:"onBeforeItemRestored",value:function t(e){var n=e.getItem();if(!(n instanceof H)){return}var i=e.getDropZone();if(i.getId()==="delete"){if(this.deleteCommand){this.deleteCommand.cancel();this.deleteCommand=null}}}},{key:"saveItemState",value:function t(e){e.getItem().saveCurrentState()}},{key:"getFirstColumn",value:function t(){var e=this.getColumns();if(e.length>0){return e[0]}return null}},{key:"onItemMoved",value:function t(e,n,i,a){var r=this;var o=e.getCurrentState();if(parseInt(e.getStageId())===parseInt(n.getId())){if(!i&&e.getCurrentState().nextItemId===0||i&&parseInt(i.getId())===parseInt(e.getCurrentState().nextItemId)){this.moveItem(e,e.getStageId(),e.getCurrentState().nextItemId);return}e.saveCurrentState().saveSort().catch(function(t){r.onItemMoveError(e,t,o)});return}var l=this.getColumn(e.getStageId());if(l.isCanMoveFrom()&&l.getPossibleNextStages().includes(n.getId())){this.moveItemToStage(e,n.getId(),l)}else if(!l.isCanMoveFrom()&&l.getPossibleNextStages().includes(n.getId())){BX.UI.Notification.Center.notify({content:s.Loc.getMessage("RPA_KANBAN_MOVE_PERMISSION_NOTIFY").replace("#STAGE#",l.getName())});this.moveItem(e,e.getStageId(),e.getCurrentState().nextItemId)}else if(l.isCanMoveFrom()&&!l.getPossibleNextStages().includes(n.getId())){BX.UI.Notification.Center.notify({content:s.Loc.getMessage("RPA_KANBAN_MOVE_WRONG_STAGE_NOTIFY").replace("#STAGE_FROM#",l.getName()).replace("#STAGE_TO#",n.getName())});this.moveItem(e,e.getStageId(),e.getCurrentState().nextItemId)}else{BX.UI.Notification.Center.notify({content:s.Loc.getMessage("RPA_KANBAN_MOVE_ITEM_PERMISSION_NOTIFY").replace("#ITEM#",e.getName()).replace("#STAGE#",l.getName())});this.moveItem(e,e.getStageId(),e.getCurrentState().nextItemId)}}},{key:"moveItemToStage",value:function t(e,n,a){var r=this;var o=e.getCurrentState();if(e.hasEmptyMandatoryFields(a)){if(!a.canAddItems()){this.moveItem(e,e.getStageId(),e.getCurrentState().nextItemId);i.Kanban.Utils.showErrorDialog(s.Loc.getMessage("RPA_KANBAN_MOVE_EMPTY_MANDATORY_FIELDS_ERROR"),false);return}e.showEditor(n).then(function(t){r.onEditorSave(e,t)}).catch(function(t){r.onItemMoveError(e,t,o)})}else{var l=this.getColumn(n);if(l){e.saveCurrentState()}else{e.setStageId(n)}e.savePosition().catch(function(t){var i=false;var l=false;var u=false;t.errors.forEach(function(t){if(t.code&&t.code==="RPA_MANDATORY_FIELD_EMPTY"){i=true}else if(t.code&&t.code==="RPA_ITEM_USER_HAS_TASKS"){l=true}else if(t.code&&t.code==="RPA_ITEM_TASKS_NOT_COMPLETED"){u=true}});if(i){if(!a.canAddItems()){BX.UI.Notification.Center.notify({content:s.Loc.getMessage("RPA_KANBAN_MOVE_ITEM_PERMISSION_NOTIFY").replace("#ITEM#",e.getName()).replace("#STAGE#",a.getName())});r.onItemMoveError(e,null,o);return}e.showEditor(n).then(function(t){if(t.cancel===true){r.onItemMoveError(e,null,o)}}).catch(function(t){r.onItemMoveError(e,t,o)})}else if(l){e.showTasks().then(function(t){if(t.isCompleted!==true){r.onItemMoveError(e,null,o)}else{e.update(t);if(!e.moveToActualColumn()){e.render()}}}).catch(function(t){r.onItemMoveError(e,t,o)})}else if(u){BX.UI.Notification.Center.notify({content:s.Loc.getMessage("RPA_KANBAN_MOVE_ITEM_HAS_TASKS_ERROR")});r.onItemMoveError(e,null,o)}else{r.onItemMoveError(e,t,o)}})}}},{key:"onItemMoveError",value:function t(e){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;if(i){e.restoreState(i);if(!e.isVisible()){this.unhideItem(e)}this.moveItem(e,e.getStageId(),e.getCurrentState().nextItemId)}if(n){this.showErrorFromResponse(n)}}},{key:"onEditorSave",value:function t(e,n){if(n.cancel===true){this.moveItem(e,e.getStageId(),e.getCurrentState().nextItemId)}}},{key:"showErrorFromResponse",value:function t(e){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var a=null;if(s.Type.isPlainObject(e)&&e.errors&&s.Type.isArray(e.errors)){a=e.errors}else if(s.Type.isArray(e)){a=e}var r="";if(s.Type.isArray(a)){a.forEach(function(t){r+=t.message+"\n"})}else{r="Unknown error"}i.Kanban.Utils.showErrorDialog(r,n)}},{key:"onColumnUpdated",value:function t(e){var n=this;this.startProgress();s.ajax.runAction("rpa.stage.update",{analyticsLabel:"rpaKanbanStageUpdate",data:{id:e.getId(),fields:{name:e.getName(),color:e.getColor()},eventId:this.pullManager.registerRandomEventId()},getParameters:{context:"kanban"}}).then(function(t){n.stopProgress();e.update(t.data)}).catch(function(t){n.stopProgress();n.showErrorFromResponse(t,true)})}},{key:"addStage",value:function t(e){var n=this;this.startProgress();var i=this.getPreviousColumnSibling(e);var a=i?i.getId():0;var r=new BX.Promise;s.ajax.runAction("rpa.stage.add",{analyticsLabel:"rpaKanbanStageAdd",data:{fields:{name:e.getName(),color:e.getColor(),previousStageId:a,typeId:this.getTypeId()},eventId:this.pullManager.registerRandomEventId()},getParameters:{context:"kanban"}}).then(function(t){r.fulfill(n.transformColumnActionResponseToColumnOptions(t));n.stopProgress()}).catch(function(t){var e=t.errors.pop().message;r.reject(e);n.stopProgress()});return r}},{key:"removeStage",value:function t(e){var n=this;var i=new BX.Promise;this.startProgress();s.ajax.runAction("rpa.stage.delete",{analyticsLabel:"rpaKanbanStageDelete",data:{id:e.getId()},getParameters:{context:"kanban"}}).then(function(){n.stopProgress();i.fulfill()}).catch(function(t){n.stopProgress();var a=t.errors.pop().message;e.enableDragging();e.getContainer().classList.remove("main-kanban-column-edit-mode");i.reject(a)});return i}},{key:"onColumnMoved",value:function t(e){var n=this;var i=this.getPreviousColumnSibling(e);var a=i?i.getId():0;s.ajax.runAction("rpa.stage.update",{analyticsLabel:"rpaKanbanStageMove",data:{id:e.getId(),fields:{previousStageId:a},eventId:this.pullManager.registerRandomEventId()},getParameters:{context:"kanban"}}).then(function(t){var i=e.isFirstColumn();var a=true;e.update(t.data);if(e.isFirstColumn()&&i){return}if(e.isFirstColumn()||i){n.getColumns().forEach(function(t){if(t!==e){t.setIsFirstColumn(i&&a);a=false}t.rerenderSubtitle()})}n.getFirstColumn().rerenderSubtitle()}).catch(function(t){n.showErrorFromResponse(t,true)})}},{key:"transformColumnActionResponseToColumnOptions",value:function t(e){return{id:e.data.stage.id,name:e.data.stage.name,color:e.data.stage.color,total:e.data.stage.total,data:e.data.stage}}},{key:"getColumnItems",value:function t(e){var n=e.getPagination().page+1;var i=this.getData().pageSize;var a=new BX.Promise;s.ajax.runComponentAction("bitrix:rpa.kanban","getColumn",{mode:"class",analyticsLabel:"rpaKanbanPagination",signedParameters:this.getData().signedParameters,data:{stageId:e.getId()},navigation:{page:n,size:i}}).then(function(t){var e=[];t.data.items.forEach(function(t){e.push({id:t.id,columnId:t.stageId,name:t.name,data:t})});a.fulfill(e)}).catch(function(t){var e=t.errors.pop().message;a.reject(e)});return a}},{key:"insertItem",value:function t(e){if(!(e instanceof H)){return}var n=null;var i=this.getColumn(e.getStageId());if(i){n=i.getFirstItem();this.moveItem(e,e.getStageId(),n);e.processPermissions()}else{this.removeItem(e)}}},{key:"onApplyFilter",value:function t(e,n,i,a,r){var o=this;if(s.Type.isPlainObject(r)){r.autoResolve=false}this.startProgress();s.ajax.runComponentAction("bitrix:rpa.kanban","get",{analyticsLabel:"rpaKanbanApplyFilter",signedParameters:this.getData().signedParameters,mode:"class"}).then(function(t){o.stopProgress();o.getColumns().forEach(function(t){var e=t.getPagination();if(e){e.page=1}});o.getColumns().forEach(function(t){o.removeColumn(t)});o.removeItems();o.loadData(t.data.kanban);if(!s.Type.isNil(a)){a.fulfill()}}).catch(function(t){o.stopProgress();o.showErrorFromResponse(t);if(!s.Type.isNil(a)){a.reject()}})}},{key:"loadData",value:function t(n){if(s.Type.isPlainObject(n.data)){this.addUsers(n.data.users);this.data.fields=n.data.fields}babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"loadData",this).call(this,n)}},{key:"addUsers",value:function t(e){var n=this;if(s.Type.isPlainObject(e)){if(!this.users){this.users=new Map}Object.keys(e).forEach(function(t){t=s.Text.toInteger(t);if(t>0){n.users.set(t,e[t])}})}}},{key:"getUser",value:function t(e){if(!this.users){this.users=new Map}return this.users.get(e)}},{key:"getFields",value:function t(){var e=this.getData().fields;if(!e||!s.Type.isPlainObject(e)){e={}}return e}},{key:"onOpenSelectFieldMenu",value:function t(e,n){n.cancel=true;var i="rpa-kanban-column-select-fields-menu-"+this.getTypeId();var a=l.PopupWindowManager.getPopupById(i);if(!a){a=new l.PopupMenuWindow({id:"rpa-kanban-column-select-fields-menu-"+this.getTypeId(),bindElement:n.button,items:[{text:s.Loc.getMessage("RPA_KANBAN_FIELDS_VIEW_SETTINGS"),onclick:this.onSelectFieldsViewSettingsClick.bind(this)},{text:s.Loc.getMessage("RPA_KANBAN_FIELDS_MODIFY_SETTINGS"),onclick:this.onSelectFieldsModifySettingsClick.bind(this)}],autoHide:true,closeByEsc:true,cacheable:false})}else{a.setBindElement(n.button)}a.show()}},{key:"onSelectFieldsViewSettingsClick",value:function t(){var e=this;if(!this.canAddColumns()){return}var n=this.getFields();var i=[];Object.keys(n).forEach(function(t){i.push({title:n[t].title,name:t,checked:n[t].isVisibleOnKanban})});var a=new u.FieldsPopup("rpa-kanban-view-"+this.getTypeId(),i,s.Loc.getMessage("RPA_KANBAN_FIELDS_VIEW_SETTINGS"));a.show().then(function(t){if(t!==false){if(e.isProgress()){return}e.startProgress();s.ajax.runAction("rpa.fields.setVisibilitySettings",{analyticsLabel:"rpaKanbanSaveVisibleFields",data:{typeId:e.getTypeId(),fields:Array.from(t),visibility:"kanban"}}).then(function(n){e.stopProgress();Object.keys(e.getFields()).forEach(function(n){e.data.fields[n]["isVisibleOnKanban"]=t.has(n)});e.getColumns().forEach(function(t){t.getItems().forEach(function(t){t.render()})})}).catch(function(t){e.stopProgress();e.showErrorFromResponse(t)})}})}},{key:"onSelectFieldsModifySettingsClick",value:function t(){var e=this;if(!this.canAddColumns()){return}var n=this.getFirstColumn();if(!n){return}var i=n.getEditor();if(!i){return}var a=this.getFields();var r=[];Object.keys(a).forEach(function(t){if(a[t].canBeEdited){r.push({title:a[t].title,name:t,checked:!!i.getControlById(t)})}});var o=new u.FieldsPopup("rpa-kanban-edit-"+this.getTypeId(),r,s.Loc.getMessage("RPA_KANBAN_FIELDS_MODIFY_SETTINGS"));o.show().then(function(t){if(!t){return}if(e.isProgress()){return}e.startProgress();s.ajax.runAction("rpa.fields.setVisibilitySettings",{data:{typeId:e.getTypeId(),fields:Array.from(t),visibility:"create"},analyticsLabel:"rpaKanbanSaveCreateFields"}).then(function(n){e.stopProgress();e.syncEditorFields(i,t)}).catch(function(t){e.stopProgress();e.showErrorFromResponse(t)})})}},{key:"syncEditorFields",value:function t(e,n){var i=this.getFields();var a=this.getEditorMainSection(e);if(!a){return}Object.keys(i).forEach(function(t){var i=e.getControlById(t);if(i&&!n.has(t)){a.removeChild(i,{enableSaving:false})}else if(!i&&n.has(t)){var s=e.getAvailableSchemeElementByName(t);if(s){var r=e.createControl(s.getType(),s.getName(),{schemeElement:s,model:e._model,mode:e._mode});if(r){a.addChild(r,{layout:{forceDisplay:true},enableSaving:false})}}}})}},{key:"getEditorMainSection",value:function t(e){var n=e.getControlById("main");if(n instanceof BX.UI.EntityEditorColumn){n=n.getChildById("main")}return n}},{key:"isProgress",value:function t(){return this.progress===true}},{key:"startProgress",value:function t(){this.progress=true;this.showLoader().fadeOut();return this}},{key:"stopProgress",value:function t(){this.progress=false;this.hideLoader().fadeIn();return this}},{key:"showLoader",value:function t(){this.getLoader().style.display="block";return this}},{key:"hideLoader",value:function t(){this.getLoader().style.display="none";return this}},{key:"deleteItem",value:function t(e){var n=this;if(this.isProgress()){return}this.startProgress();s.ajax.runAction("rpa.item.delete",{analyticsLabel:"rpaKanbanItemDelete",data:{typeId:this.getTypeId(),id:e.getId()}}).then(function(){if(n.getItem(e)){e.getColumn().removeItem(e)}n.stopProgress()}).catch(function(t){n.stopProgress();n.showErrorFromResponse(t)})}}]);return e}(i.Kanban.Grid);var K=function(){function t(e,n,i){babelHelpers.classCallCheck(this,t);this.item=e;this.action=n;this.restore=i;this.timeoutId=null}babelHelpers.createClass(t,[{key:"start",value:function t(e){this.timeoutId=setTimeout(this.run.bind(this),e)}},{key:"run",value:function t(){clearTimeout(this.timeoutId);this.timeoutId=null;if(s.Type.isFunction(this.action)){this.action(this.item)}}},{key:"cancel",value:function t(){clearTimeout(this.timeoutId);this.timeoutId=null;if(s.Type.isFunction(this.restore)){this.restore(this.item)}}},{key:"isCompleted",value:function t(){return!(this.timeoutId>0)}}]);return t}();var X={Grid:j,Item:H,Column:A};t.Kanban=X})(this.BX.Rpa=this.BX.Rpa||{},BX.UI,BX,BX,BX.Rpa,BX,BX.Rpa,BX.UI.Dialogs,BX.Main,BX.Rpa);
//# sourceMappingURL=kanban.bundle.map.js