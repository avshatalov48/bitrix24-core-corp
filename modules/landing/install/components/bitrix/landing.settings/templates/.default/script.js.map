{"version":3,"file":"script.js","sources":["src/js/index.js"],"sourcesContent":["import {Event, ajax as Ajax, Tag, Dom} from 'main.core';\nimport {Loader} from \"main.loader\";\n\ntype PageOption = {\n\tpage: string,\n\tname: string,\n\tlink: ?string,\n\tlinkToSave: ?string,\n\tcurrent: ?boolean,\n\tcontainer: ?HTMLDivElement,\n\tform: ?HTMLFormElement,\n}\n\nexport class LandingSettings\n{\n\tsiteId: number;\n\tlandingId: number;\n\tpages: {\n\t\t[code: string]: PageOption\n\t};\n\tcontainer: HTMLDivElement;\n\tlinks: [HTMLAnchorElement];\n\tsaveButton: HTMLButtonElement;\n\tloader: Loader;\n\tloadingPages: [string];\n\n\t/**\n\t * Constructor.\n\t */\n\tconstructor(options: {\n\t\tsiteId: number,\n\t\tlandingId: number,\n\t\tpages: {\n\t\t\t[code: string]: PageOption\n\t\t},\n\t\tmenuId: string,\n\t\tcontainerId: string,\n\t\tsaveButtonId: string,\n\t})\n\t{\n\t\tthis.siteId = options.siteId;\n\t\tthis.landingId = options.landingId;\n\n\t\t// pages\n\t\tthis.pages = options.pages;\n\t\tthis.container = document.getElementById(options.containerId);\n\t\tthis.loader = new Loader({target: this.container});\n\t\tfor (let page in this.pages)\n\t\t{\n\t\t\tthis.pages[page].container = Tag.render`<div class=\"landing-settings-page-container\"></div>`;\n\t\t\tDom.append(this.pages[page].container, this.container);\n\t\t}\n\t\tthis.loadingPages = [];\n\n\t\t// links\n\t\tthis.links = document.getElementById(options.menuId).querySelectorAll('li a');\n\t\tlet currentLink = this.links[0];\n\t\tthis.links.forEach(link =>\n\t\t{\n\t\t\tEvent.bind(link, 'click', (event) =>\n\t\t\t{\n\t\t\t\tevent.preventDefault();\n\t\t\t\tevent.stopPropagation();\n\t\t\t\tthis.onLinkClick(link)\n\t\t\t});\n\n\t\t\tif (\n\t\t\t\tlink.dataset.page\n\t\t\t\t&& this.pages[link.dataset.page]\n\t\t\t\t&& this.pages[link.dataset.page].current === true\n\t\t\t)\n\t\t\t{\n\t\t\t\tcurrentLink = link;\n\t\t\t}\n\t\t});\n\t\tif (currentLink)\n\t\t{\n\t\t\tthis.onLinkClick(currentLink);\n\t\t}\n\n\t\t// save\n\t\tthis.saveButton = document.getElementById(options.saveButtonId);\n\t\tthis.onSave = this.onSave.bind(this);\n\t\tEvent.bind(this.saveButton, 'click', this.onSave);\n\t}\n\n\tonLinkClick(link: HTMLAnchorElement)\n\t{\n\t\tif (link.dataset.page)\n\t\t{\n\t\t\tthis.onPageChange(link.dataset.page);\n\t\t}\n\t\telse if (link.dataset.placement)\n\t\t{\n\t\t\t// for open app pages in slider\n\t\t\tif (\n\t\t\t\ttypeof BX.rest !== 'undefined' &&\n\t\t\t\ttypeof BX.rest.Marketplace !== 'undefined'\n\t\t\t)\n\t\t\t{\n\t\t\t\tBX.rest.Marketplace.bindPageAnchors({});\n\t\t\t}\n\t\t\tBX.rest.AppLayout.openApplication(\n\t\t\t\tlink.dataset.appId,\n\t\t\t\t{\n\t\t\t\t\tSITE_ID: this.siteId,\n\t\t\t\t\tLID: this.landingId,\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tPLACEMENT: link.dataset.placement,\n\t\t\t\t\tPLACEMENT_ID: link.dataset.placementId,\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\t}\n\n\tonPageChange(page: string)\n\t{\n\t\tconst currPage = this.pages[page];\n\t\tif (currPage)\n\t\t{\n\t\t\tif (currPage.container.childNodes.length === 0)\n\t\t\t{\n\t\t\t\tthis.loader.show();\n\t\t\t\tthis.loadingPages.push(page);\n\t\t\t\tAjax.get(currPage.link, result =>\n\t\t\t\t{\n\t\t\t\t\tcurrPage.container.innerHTML = result;\n\t\t\t\t\tthis.loadingPages.splice(this.loadingPages.indexOf(page), 1);\n\t\t\t\t\tif (this.loadingPages.length === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.loader.hide();\n\t\t\t\t\t}\n\t\t\t\t\tconst form = currPage.container.querySelector('.ui-form');\n\t\t\t\t\tif (form)\n\t\t\t\t\t{\n\t\t\t\t\t\tcurrPage.form = form;\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tfor (let page in this.pages)\n\t\t\t{\n\t\t\t\tthis.pages[page].container.hidden = true;\n\t\t\t}\n\t\t\tcurrPage.container.hidden = false;\n\t\t}\n\t}\n\n\tonSave()\n\t{\n\t\tthis.loader.show()\n\n\t\tconst submits = [];\n\t\tfor (let page in this.pages)\n\t\t{\n\t\t\tconst currPage = this.pages[page];\n\t\t\tif (currPage.form)\n\t\t\t{\n\t\t\t\tsubmits.push(\n\t\t\t\t\tfetch(currPage.linkToSave, {\n\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\tbody: new FormData(currPage.form),\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t'Bx-ajax': true,\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t\tPromise.all(submits)\n\t\t\t.then((results: [Response]) =>\n\t\t\t{\n\t\t\t\tlet all = true;\n\t\t\t\tresults.forEach(result => {\n\t\t\t\t\tall = all && result.ok;\n\t\t\t\t});\n\t\t\t\tif (all)\n\t\t\t\t{\n\t\t\t\t\ttop.window['landingSettingsSaved'] = true;\n\t\t\t\t\ttop.BX.onCustomEvent('BX.Landing.Filter:apply');\n\t\t\t\t\tthis.loader.hide()\n\t\t\t\t\ttop.window.location.reload();\n\t\t\t\t\tBX.SidePanel.Instance.close();\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(err =>\n\t\t\t{\n\t\t\t\tconsole.error(err);\n\t\t\t});\n\t}\n}"],"names":["LandingSettings","options","siteId","landingId","pages","container","document","getElementById","containerId","loader","Loader","target","page","Tag","render","Dom","append","loadingPages","links","menuId","querySelectorAll","currentLink","forEach","link","Event","bind","event","preventDefault","stopPropagation","onLinkClick","dataset","current","saveButton","saveButtonId","onSave","onPageChange","placement","BX","rest","Marketplace","bindPageAnchors","AppLayout","openApplication","appId","SITE_ID","LID","PLACEMENT","PLACEMENT_ID","placementId","currPage","childNodes","length","show","push","Ajax","get","result","innerHTML","splice","indexOf","hide","form","querySelector","hidden","submits","fetch","linkToSave","method","body","FormData","headers","Promise","all","then","results","ok","top","window","onCustomEvent","location","reload","SidePanel","Instance","close","err","console","error"],"mappings":";;;;;;KAaaA,eAAb;CAaC;CACD;CACA;CACC,2BAAYC,OAAZ,EAUA;CAAA;;CAAA;CACC,SAAKC,MAAL,GAAcD,OAAO,CAACC,MAAtB;CACA,SAAKC,SAAL,GAAiBF,OAAO,CAACE,SAAzB,CAFD;;CAKC,SAAKC,KAAL,GAAaH,OAAO,CAACG,KAArB;CACA,SAAKC,SAAL,GAAiBC,QAAQ,CAACC,cAAT,CAAwBN,OAAO,CAACO,WAAhC,CAAjB;CACA,SAAKC,MAAL,GAAc,IAAIC,kBAAJ,CAAW;CAACC,MAAAA,MAAM,EAAE,KAAKN;CAAd,KAAX,CAAd;;CACA,SAAK,IAAIO,IAAT,IAAiB,KAAKR,KAAtB,EACA;CACC,WAAKA,KAAL,CAAWQ,IAAX,EAAiBP,SAAjB,GAA6BQ,aAAG,CAACC,MAAjC;CACAC,MAAAA,aAAG,CAACC,MAAJ,CAAW,KAAKZ,KAAL,CAAWQ,IAAX,EAAiBP,SAA5B,EAAuC,KAAKA,SAA5C;CACA;;CACD,SAAKY,YAAL,GAAoB,EAApB,CAbD;;CAgBC,SAAKC,KAAL,GAAaZ,QAAQ,CAACC,cAAT,CAAwBN,OAAO,CAACkB,MAAhC,EAAwCC,gBAAxC,CAAyD,MAAzD,CAAb;CACA,QAAIC,WAAW,GAAG,KAAKH,KAAL,CAAW,CAAX,CAAlB;CACA,SAAKA,KAAL,CAAWI,OAAX,CAAmB,UAAAC,IAAI,EACvB;CACCC,MAAAA,eAAK,CAACC,IAAN,CAAWF,IAAX,EAAiB,OAAjB,EAA0B,UAACG,KAAD,EAC1B;CACCA,QAAAA,KAAK,CAACC,cAAN;CACAD,QAAAA,KAAK,CAACE,eAAN;;CACA,QAAA,KAAI,CAACC,WAAL,CAAiBN,IAAjB;CACA,OALD;;CAOA,UACCA,IAAI,CAACO,OAAL,CAAalB,IAAb,IACG,KAAI,CAACR,KAAL,CAAWmB,IAAI,CAACO,OAAL,CAAalB,IAAxB,CADH,IAEG,KAAI,CAACR,KAAL,CAAWmB,IAAI,CAACO,OAAL,CAAalB,IAAxB,EAA8BmB,OAA9B,KAA0C,IAH9C,EAKA;CACCV,QAAAA,WAAW,GAAGE,IAAd;CACA;CACD,KAjBD;;CAkBA,QAAIF,WAAJ,EACA;CACC,WAAKQ,WAAL,CAAiBR,WAAjB;CACA,KAvCF;;;CA0CC,SAAKW,UAAL,GAAkB1B,QAAQ,CAACC,cAAT,CAAwBN,OAAO,CAACgC,YAAhC,CAAlB;CACA,SAAKC,MAAL,GAAc,KAAKA,MAAL,CAAYT,IAAZ,CAAiB,IAAjB,CAAd;CACAD,IAAAA,eAAK,CAACC,IAAN,CAAW,KAAKO,UAAhB,EAA4B,OAA5B,EAAqC,KAAKE,MAA1C;CACA;;CAvEF;CAAA;CAAA,gCAyEaX,IAzEb,EA0EC;CACC,UAAIA,IAAI,CAACO,OAAL,CAAalB,IAAjB,EACA;CACC,aAAKuB,YAAL,CAAkBZ,IAAI,CAACO,OAAL,CAAalB,IAA/B;CACA,OAHD,MAIK,IAAIW,IAAI,CAACO,OAAL,CAAaM,SAAjB,EACL;CACC;CACA,YACC,OAAOC,EAAE,CAACC,IAAV,KAAmB,WAAnB,IACA,OAAOD,EAAE,CAACC,IAAH,CAAQC,WAAf,KAA+B,WAFhC,EAIA;CACCF,UAAAA,EAAE,CAACC,IAAH,CAAQC,WAAR,CAAoBC,eAApB,CAAoC,EAApC;CACA;;CACDH,QAAAA,EAAE,CAACC,IAAH,CAAQG,SAAR,CAAkBC,eAAlB,CACCnB,IAAI,CAACO,OAAL,CAAaa,KADd,EAEC;CACCC,UAAAA,OAAO,EAAE,KAAK1C,MADf;CAEC2C,UAAAA,GAAG,EAAE,KAAK1C;CAFX,SAFD,EAMC;CACC2C,UAAAA,SAAS,EAAEvB,IAAI,CAACO,OAAL,CAAaM,SADzB;CAECW,UAAAA,YAAY,EAAExB,IAAI,CAACO,OAAL,CAAakB;CAF5B,SAND;CAWA;CACD;CArGF;CAAA;CAAA,iCAuGcpC,IAvGd,EAwGC;CAAA;;CACC,UAAMqC,QAAQ,GAAG,KAAK7C,KAAL,CAAWQ,IAAX,CAAjB;;CACA,UAAIqC,QAAJ,EACA;CACC,YAAIA,QAAQ,CAAC5C,SAAT,CAAmB6C,UAAnB,CAA8BC,MAA9B,KAAyC,CAA7C,EACA;CACC,eAAK1C,MAAL,CAAY2C,IAAZ;CACA,eAAKnC,YAAL,CAAkBoC,IAAlB,CAAuBzC,IAAvB;CACA0C,UAAAA,cAAI,CAACC,GAAL,CAASN,QAAQ,CAAC1B,IAAlB,EAAwB,UAAAiC,MAAM,EAC9B;CACCP,YAAAA,QAAQ,CAAC5C,SAAT,CAAmBoD,SAAnB,GAA+BD,MAA/B;;CACA,YAAA,MAAI,CAACvC,YAAL,CAAkByC,MAAlB,CAAyB,MAAI,CAACzC,YAAL,CAAkB0C,OAAlB,CAA0B/C,IAA1B,CAAzB,EAA0D,CAA1D;;CACA,gBAAI,MAAI,CAACK,YAAL,CAAkBkC,MAAlB,KAA6B,CAAjC,EACA;CACC,cAAA,MAAI,CAAC1C,MAAL,CAAYmD,IAAZ;CACA;;CACD,gBAAMC,IAAI,GAAGZ,QAAQ,CAAC5C,SAAT,CAAmByD,aAAnB,CAAiC,UAAjC,CAAb;;CACA,gBAAID,IAAJ,EACA;CACCZ,cAAAA,QAAQ,CAACY,IAAT,GAAgBA,IAAhB;CACA;CACD,WAbD;CAcA;;CAED,aAAK,IAAIjD,KAAT,IAAiB,KAAKR,KAAtB,EACA;CACC,eAAKA,KAAL,CAAWQ,KAAX,EAAiBP,SAAjB,CAA2B0D,MAA3B,GAAoC,IAApC;CACA;;CACDd,QAAAA,QAAQ,CAAC5C,SAAT,CAAmB0D,MAAnB,GAA4B,KAA5B;CACA;CACD;CAtIF;CAAA;CAAA,6BAyIC;CAAA;;CACC,WAAKtD,MAAL,CAAY2C,IAAZ;CAEA,UAAMY,OAAO,GAAG,EAAhB;;CACA,WAAK,IAAIpD,IAAT,IAAiB,KAAKR,KAAtB,EACA;CACC,YAAM6C,QAAQ,GAAG,KAAK7C,KAAL,CAAWQ,IAAX,CAAjB;;CACA,YAAIqC,QAAQ,CAACY,IAAb,EACA;CACCG,UAAAA,OAAO,CAACX,IAAR,CACCY,KAAK,CAAChB,QAAQ,CAACiB,UAAV,EAAsB;CAC1BC,YAAAA,MAAM,EAAE,MADkB;CAE1BC,YAAAA,IAAI,EAAE,IAAIC,QAAJ,CAAapB,QAAQ,CAACY,IAAtB,CAFoB;CAG1BS,YAAAA,OAAO,EAAE;CACR,yBAAW;CADH;CAHiB,WAAtB,CADN;CASA;CACD;;CACDC,MAAAA,OAAO,CAACC,GAAR,CAAYR,OAAZ,EACES,IADF,CACO,UAACC,OAAD,EACN;CACC,YAAIF,GAAG,GAAG,IAAV;CACAE,QAAAA,OAAO,CAACpD,OAAR,CAAgB,UAAAkC,MAAM,EAAI;CACzBgB,UAAAA,GAAG,GAAGA,GAAG,IAAIhB,MAAM,CAACmB,EAApB;CACA,SAFD;;CAGA,YAAIH,GAAJ,EACA;CACCI,UAAAA,GAAG,CAACC,MAAJ,CAAW,sBAAX,IAAqC,IAArC;CACAD,UAAAA,GAAG,CAACvC,EAAJ,CAAOyC,aAAP,CAAqB,yBAArB;;CACA,UAAA,MAAI,CAACrE,MAAL,CAAYmD,IAAZ;;CACAgB,UAAAA,GAAG,CAACC,MAAJ,CAAWE,QAAX,CAAoBC,MAApB;CACA3C,UAAAA,EAAE,CAAC4C,SAAH,CAAaC,QAAb,CAAsBC,KAAtB;CACA;CACD,OAfF,WAgBQ,UAAAC,GAAG,EACV;CACCC,QAAAA,OAAO,CAACC,KAAR,CAAcF,GAAd;CACA,OAnBF;CAoBA;CAjLF;CAAA;CAAA;;;;;;;;"}