this.BX=this.BX||{};(function(e,t){"use strict";var n=function(){function e(){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"cache",new t.Cache.MemoryCache)}babelHelpers.createClass(e,[{key:"getControllerUrl",value:function e(){return this.cache.remember("controllerUrl",function(){var e=new t.Uri("/bitrix/tools/landing/ajax.php");e.setQueryParam("site",t.Loc.getMessage("SITE_ID")||undefined);return e.toString()})}},{key:"getSiteId",value:function e(){return this.cache.remember("siteId",function(){var e=t.Reflection.getClass("BX.Landing.Main");if(e){var n=e.getInstance();if("options"in n&&"site_id"in n.options&&!t.Type.isUndefined(n.options.site_id)){return n.options.site_id}}return-1})}},{key:"getLandingId",value:function e(){return this.cache.remember("landingId",function(){var e=t.Reflection.getClass("BX.Landing.Main");if(e){return e.getInstance().id}return-1})}},{key:"getSitesType",value:function e(){return this.cache.remember("siteType",function(){var e=t.Reflection.getClass("BX.Landing.Main");if(e){var n=e.getInstance();if(t.Type.isPlainObject(n.options)&&t.Type.isPlainObject(n.options.params)&&t.Type.isString(n.options.params.type)){return n.options.params.type}}return"PAGE"})}},{key:"action",value:function n(r){var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var c=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};i.site_id=this.getSiteId();var o={sessid:t.Loc.getMessage("bitrix_sessid"),action:c.action||r.replace("Landing\\Block","Block"),data:babelHelpers.objectSpread({},a,{uploadParams:c,lid:a.lid||this.getLandingId()})};var s=new t.Uri(this.getControllerUrl());s.setQueryParams(babelHelpers.objectSpread({action:o.action},i));return e.request({url:s.toString(),data:o}).then(function(e){if(o.action==="Block::updateNodes"||o.action==="Block::removeCard"||o.action==="Block::cloneCard"||o.action==="Block::addCard"||o.action==="Block::updateStyles"){BX.Landing.UI.Panel.StatusPanel.getInstance().update()}return e.result}).catch(function(e){if(o.action!=="Block::getById"){var n=t.Type.isString(e)?{type:"error"}:e;e.action=o.action;BX.Landing.ErrorManager.getInstance().add(n)}return Promise.reject(e)})}},{key:"batch",value:function n(r){var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};i.site_id=this.getSiteId();var c={sessid:t.Loc.getMessage("bitrix_sessid"),action:r.replace("Landing\\Block","Block"),data:{lid:a.lid||this.getLandingId()},batch:a};var o=new t.Uri(this.getControllerUrl());o.setQueryParams(babelHelpers.objectSpread({action:c.action},i));return e.request({url:o.toString(),data:c}).then(function(e){BX.Landing.UI.Panel.StatusPanel.getInstance().update();return e}).catch(function(e){if(c.action!=="Block::getById"){var n=t.Type.isString(e)?{type:"error"}:e;n.action=c.action;BX.Landing.ErrorManager.getInstance().add(n)}return Promise.reject(e)})}},{key:"upload",value:function n(r){var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var i=new FormData;i.append("sessid",t.Loc.getMessage("bitrix_sessid"));i.append("picture",r,r.name);if("block"in a){i.append("action","Block::uploadFile");i.append("data[block]",a.block)}if("lid"in a){i.set("action","Landing::uploadFile");i.append("data[lid]",a.lid)}if("id"in a){i.set("action","Site::uploadFile");i.append("data[id]",a.id)}var c=new t.Uri(this.getControllerUrl());c.setQueryParams({action:i.get("action"),site_id:this.getSiteId()});if(a.context){c.setQueryParam("context",a.context)}return e.request({url:c.toString(),data:i}).then(function(e){return e.result}).catch(function(e){var n=t.Type.isString(e)?{type:"error"}:e;n.action="Block::uploadFile";BX.Landing.ErrorManager.getInstance().add(n);return Promise.reject(e)})}},{key:"getSites",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},r=n.filter,a=r===void 0?{}:r;return this.cache.remember("sites+".concat(JSON.stringify(a)),function(){return t.action("Site::getList",{params:{order:{ID:"DESC"},filter:babelHelpers.objectSpread({TYPE:t.getSitesType()},a)}}).then(function(e){return e})})}},{key:"getLandings",value:function e(){var n=this;var r=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},a=r.siteId,i=a===void 0?[]:a;var c=t.Type.isArray(i)?i:[i];var o=function e(t){return{action:"Landing::getList",data:{params:{filter:{SITE_ID:t},order:{ID:"DESC"},get_preview:true,check_area:1}}}};var s=function e(t){return t.reduce(function(e,t){return[].concat(babelHelpers.toConsumableArray(e),babelHelpers.toConsumableArray(t.result))},[])};return this.cache.remember("landings+".concat(JSON.stringify(c)),function(){if(c.filter(function(e){return!t.Type.isNil(e)}).length===0){return n.getSites().then(function(e){var t=e.map(function(e){return o(e.ID)});return n.batch("Landing::getList",t)}).then(function(e){return s(e)}).then(function(e){e.forEach(function(e){n.cache.set("landing+".concat(e.ID),Promise.resolve(e))})})}var e=c.map(function(e){return o(e)});return n.batch("Landing::getList",e).then(function(e){return s(e)}).then(function(e){e.forEach(function(e){n.cache.set("landing+".concat(e.ID),Promise.resolve(e))});return e})})}},{key:"getLanding",value:function e(n){var r=this;var a=n.landingId;return this.cache.remember("landing+".concat(a),function(){return r.action("Landing::getList",{params:{filter:{ID:a},get_preview:true}}).then(function(e){if(t.Type.isArray(e)&&e.length>0){return e[0]}return null})})}},{key:"getBlocks",value:function e(t){var n=this;var r=t.landingId;return this.cache.remember("blocks+".concat(r),function(){return n.action("Block::getList",{lid:r,params:{get_content:true,edit_mode:true}}).then(function(e){e.forEach(function(e){n.cache.set("block+".concat(e.id),Promise.resolve(e))});return e})})}},{key:"getBlock",value:function e(t){var n=this;var r=t.blockId;return this.cache.remember("blockId+".concat(r),function(){return n.action("Block::getById",{block:r,params:{edit_mode:true}})})}},{key:"getTemplates",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},r=n.type,a=r===void 0?"page":r,i=n.filter,c=i===void 0?{}:i;return this.cache.remember("templates+".concat(JSON.stringify(c)),function(){return t.action("Demos::getPageList",{type:a,filter:c}).then(function(e){return Object.values(e)})})}},{key:"getDynamicTemplates",value:function e(){var t=this;return this.cache.remember("dynamicTemplates",function(){return t.getTemplates({filter:{section:"dynamic"}})})}}],[{key:"getInstance",value:function t(){if(!e.instance){e.instance=new e}return e.instance}},{key:"request",value:function e(n){var r=n.url,a=n.data;return new Promise(function(e,n){var i=a instanceof FormData?a:t.Http.Data.convertObjectToFormData(a);var c=t.ajax({method:"POST",dataType:"json",url:r,data:i,start:false,preparePost:false,onsuccess:function r(a){if(t.Type.isPlainObject(a)&&a.type==="error"){n(a);return}e(a)},onfailure:n});c.send(i)})}}]);return e}();e.Backend=n})(this.BX.Landing=this.BX.Landing||{},BX);
//# sourceMappingURL=backend.bundle.map.js