this.BX=this.BX||{};(function(e,t,n){"use strict";var r=function(){function e(){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"cache",new t.Cache.MemoryCache)}babelHelpers.createClass(e,[{key:"getControllerUrl",value:function e(){var n=this;return this.cache.remember("controllerUrl",function(){var e=new t.Uri("/bitrix/tools/landing/ajax.php");e.setQueryParams({site:t.Loc.getMessage("SITE_ID")||undefined,type:n.getSitesType()});return e.toString()})}},{key:"getSiteId",value:function e(){return this.cache.remember("siteId",function(){var e=t.Reflection.getClass("BX.Landing.Main");if(e){var n=e.getInstance();if("options"in n&&"site_id"in n.options&&!t.Type.isUndefined(n.options.site_id)){return n.options.site_id}}return-1})}},{key:"getLandingId",value:function e(){return this.cache.remember("landingId",function(){var e=t.Reflection.getClass("BX.Landing.Main");if(e){return e.getInstance().id}return-1})}},{key:"getSitesType",value:function e(){return this.cache.remember("siteType",function(){return n.Env.getInstance().getType()})}},{key:"action",value:function n(r){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var c=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};a.site_id=this.getSiteId();var o={sessid:t.Loc.getMessage("bitrix_sessid"),action:c.action||r.replace("Landing\\Block","Block"),data:babelHelpers.objectSpread({},i,{uploadParams:c,lid:i.lid||this.getLandingId()})};var s=new t.Uri(this.getControllerUrl());s.setQueryParams(babelHelpers.objectSpread({action:o.action},a));return e.request({url:s.toString(),data:o}).then(function(e){if(o.action==="Block::updateNodes"||o.action==="Block::removeCard"||o.action==="Block::cloneCard"||o.action==="Block::addCard"||o.action==="Block::updateStyles"){BX.Landing.UI.Panel.StatusPanel.getInstance().update()}return e.result}).catch(function(e){if(o.action!=="Block::getById"){var n=t.Type.isString(e)?{type:"error"}:e;e.action=o.action;BX.Landing.ErrorManager.getInstance().add(n)}return Promise.reject(e)})}},{key:"batch",value:function n(r){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};a.site_id=this.getSiteId();var c={sessid:t.Loc.getMessage("bitrix_sessid"),action:r.replace("Landing\\Block","Block"),data:{lid:i.lid||this.getLandingId()},batch:i};var o=new t.Uri(this.getControllerUrl());o.setQueryParams(babelHelpers.objectSpread({action:c.action},a));return e.request({url:o.toString(),data:c}).then(function(e){BX.Landing.UI.Panel.StatusPanel.getInstance().update();return e}).catch(function(e){if(c.action!=="Block::getById"){var n=t.Type.isString(e)?{type:"error"}:e;n.action=c.action;BX.Landing.ErrorManager.getInstance().add(n)}return Promise.reject(e)})}},{key:"upload",value:function n(r){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a=new FormData;a.append("sessid",t.Loc.getMessage("bitrix_sessid"));a.append("picture",r,r.name);if("block"in i){a.append("action","Block::uploadFile");a.append("data[block]",i.block)}if("lid"in i){a.set("action","Landing::uploadFile");a.append("data[lid]",i.lid)}if("id"in i){a.set("action","Site::uploadFile");a.append("data[id]",i.id)}var c=new t.Uri(this.getControllerUrl());c.setQueryParams({action:a.get("action"),site_id:this.getSiteId()});if(i.context){c.setQueryParam("context",i.context)}return e.request({url:c.toString(),data:a}).then(function(e){return e.result}).catch(function(e){var n=t.Type.isString(e)?{type:"error"}:e;n.action="Block::uploadFile";BX.Landing.ErrorManager.getInstance().add(n);return Promise.reject(e)})}},{key:"getSites",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},r=n.filter,i=r===void 0?{}:r;return this.cache.remember("sites+".concat(JSON.stringify(i)),function(){return t.action("Site::getList",{params:{order:{ID:"DESC"},filter:babelHelpers.objectSpread({TYPE:t.getSitesType()},i)}}).then(function(e){return e})})}},{key:"getLandings",value:function e(){var n=this;var r=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},i=r.siteId,a=i===void 0?[]:i;var c=t.Type.isArray(a)?a:[a];var o=function e(t){return{action:"Landing::getList",data:{params:{filter:{SITE_ID:t},order:{ID:"DESC"},get_preview:true,check_area:1}}}};var s=function e(t){return t.reduce(function(e,t){return[].concat(babelHelpers.toConsumableArray(e),babelHelpers.toConsumableArray(t.result))},[])};return this.cache.remember("landings+".concat(JSON.stringify(c)),function(){if(c.filter(function(e){return!t.Type.isNil(e)}).length===0){return n.getSites().then(function(e){var t=e.map(function(e){return o(e.ID)});return n.batch("Landing::getList",t)}).then(function(e){return s(e)}).then(function(e){e.forEach(function(e){n.cache.set("landing+".concat(e.ID),Promise.resolve(e))})})}var e=c.map(function(e){return o(e)});return n.batch("Landing::getList",e).then(function(e){return s(e)}).then(function(e){e.forEach(function(e){n.cache.set("landing+".concat(e.ID),Promise.resolve(e))});return e})})}},{key:"getLanding",value:function e(n){var r=this;var i=n.landingId;return this.cache.remember("landing+".concat(i),function(){return r.action("Landing::getList",{params:{filter:{ID:i},get_preview:true}}).then(function(e){if(t.Type.isArray(e)&&e.length>0){return e[0]}return null})})}},{key:"getBlocks",value:function e(t){var n=this;var r=t.landingId;return this.cache.remember("blocks+".concat(r),function(){return n.action("Block::getList",{lid:r,params:{get_content:true,edit_mode:true}}).then(function(e){e.forEach(function(e){n.cache.set("block+".concat(e.id),Promise.resolve(e))});return e})})}},{key:"getBlock",value:function e(t){var n=this;var r=t.blockId;return this.cache.remember("blockId+".concat(r),function(){return n.action("Block::getById",{block:r,params:{edit_mode:true}})})}},{key:"getTemplates",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},r=n.type,i=r===void 0?"page":r,a=n.filter,c=a===void 0?{}:a;return this.cache.remember("templates+".concat(JSON.stringify(c)),function(){return t.action("Demos::getPageList",{type:i,filter:c}).then(function(e){return Object.values(e)})})}},{key:"getDynamicTemplates",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";return this.cache.remember("dynamicTemplates:".concat(n),function(){return t.getTemplates({filter:{section:"dynamic".concat(n?":".concat(n):"")}})})}},{key:"createPage",value:function e(){var r=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=r.title,a=r.siteId,c=a===void 0?n.Env.getInstance().getOptions().site_id:a,o=r.code,s=o===void 0?t.Text.getRandom(16):o,u=r.blockId,d=r.menuCode,l=r.folderId;var g={TITLE:i,SITE_ID:c,CODE:s};if(t.Type.isNumber(u)&&t.Type.isString(d)){g.BLOCK_ID=u;g.MENU_CODE=d}if(t.Type.isNumber(l)){g.FOLDER_ID=l}return this.action("Landing::add",{fields:g})}}],[{key:"getInstance",value:function t(){if(!e.instance){e.instance=new e}return e.instance}},{key:"request",value:function e(n){var r=n.url,i=n.data;return new Promise(function(e,n){var a=i instanceof FormData?i:t.Http.Data.convertObjectToFormData(i);var c=t.ajax({method:"POST",dataType:"json",url:r,data:a,start:false,preparePost:false,onsuccess:function r(i){if(t.Type.isPlainObject(i)&&i.type==="error"){n(i);return}e(i)},onfailure:n});c.send(a)})}}]);return e}();e.Backend=r})(this.BX.Landing=this.BX.Landing||{},BX,BX.Landing);
//# sourceMappingURL=backend.bundle.map.js