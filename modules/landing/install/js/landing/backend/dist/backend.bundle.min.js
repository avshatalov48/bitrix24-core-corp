this.BX=this.BX||{};(function(e,t,n){"use strict";var i=true;var r=function(){function e(){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"cache",new t.Cache.MemoryCache)}babelHelpers.createClass(e,[{key:"getControllerUrl",value:function e(){var n=this;return this.cache.remember("controllerUrl",function(){var e=new t.Uri("/bitrix/tools/landing/ajax.php");e.setQueryParams({site:t.Loc.getMessage("SITE_ID")||undefined,type:n.getSitesType()});return e.toString()})}},{key:"getSiteId",value:function e(){return this.cache.remember("siteId",function(){var e=t.Reflection.getClass("BX.Landing.Main");if(e){var n=e.getInstance();if("options"in n&&"site_id"in n.options&&!t.Type.isUndefined(n.options.site_id)){return n.options.site_id}}return-1})}},{key:"getLandingId",value:function e(){return this.cache.remember("landingId",function(){var e=t.Reflection.getClass("BX.Landing.Main");if(e){return e.getInstance().id}return-1})}},{key:"getSitesType",value:function e(){return this.cache.remember("siteType",function(){return n.Env.getInstance().getType()})}},{key:"action",value:function n(i){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var c=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};if(!a.site_id){a.site_id=this.getSiteId()}var o={sessid:t.Loc.getMessage("bitrix_sessid"),action:c.action||i.replace("Landing\\Block","Block"),data:babelHelpers.objectSpread({},r,{uploadParams:c,lid:r.lid||this.getLandingId()})};var s=new t.Uri(this.getControllerUrl());s.setQueryParams(babelHelpers.objectSpread({action:o.action},a));return e.request({url:s.toString(),data:o}).then(function(e){if(o.action==="Block::updateNodes"||o.action==="Block::removeCard"||o.action==="Block::cloneCard"||o.action==="Block::addCard"||o.action==="Block::updateStyles"){BX.Landing.UI.Panel.StatusPanel.getInstance().update()}return e.result}).catch(function(e){if(o.action!=="Landing::downBlock"&&o.action!=="Landing::upBlock"){if(o.action!=="Block::getById"&&o.action!=="Landing::move"&&o.action!=="Landing::copy"&&o.action!=="Site::moveFolder"){var n=t.Type.isString(e)?{type:"error"}:e;e.action=o.action;BX.Landing.ErrorManager.getInstance().add(n)}return Promise.reject(e)}})}},{key:"batch",value:function n(i){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};a.site_id=this.getSiteId();var c={sessid:t.Loc.getMessage("bitrix_sessid"),action:i.replace("Landing\\Block","Block"),data:{lid:r.lid||this.getLandingId()},batch:r};var o=new t.Uri(this.getControllerUrl());o.setQueryParams(babelHelpers.objectSpread({action:c.action},a));return e.request({url:o.toString(),data:c}).then(function(e){BX.Landing.UI.Panel.StatusPanel.getInstance().update();return e}).catch(function(e){if(c.action!=="Landing::downBlock"&&c.action!=="Landing::upBlock"){if(c.action!=="Block::getById"){var n=t.Type.isString(e)?{type:"error"}:e;n.action=c.action;BX.Landing.ErrorManager.getInstance().add(n)}return Promise.reject(e)}})}},{key:"upload",value:function n(i){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a=new FormData;a.append("sessid",t.Loc.getMessage("bitrix_sessid"));a.append("picture",i,i.name);if("block"in r){a.append("action","Block::uploadFile");a.append("data[block]",r.block)}if("lid"in r){a.set("action","Landing::uploadFile");a.append("data[lid]",r.lid)}if("id"in r){a.set("action","Site::uploadFile");a.append("data[id]",r.id)}var c=new t.Uri(this.getControllerUrl());c.setQueryParams({action:a.get("action"),site_id:this.getSiteId()});if(r.context){c.setQueryParam("context",r.context)}return e.request({url:c.toString(),data:a}).then(function(e){return e.result}).catch(function(e){var n=t.Type.isString(e)?{type:"error"}:e;n.action="Block::uploadFile";BX.Landing.ErrorManager.getInstance().add(n);return Promise.reject(e)})}},{key:"getSites",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},i=n.filter,r=i===void 0?{}:i;return this.cache.remember("sites+".concat(JSON.stringify(r)),function(){return t.action("Site::getList",{params:{order:{ID:"DESC"}}}).then(function(e){return e})})}},{key:"getLandings",value:function e(){var n=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},r=i.siteId,a=r===void 0?[]:r;var c=t.Type.isArray(a)?a:[a];var o=function e(t){return{action:"Landing::getList",data:{params:{filter:{SITE_ID:t},order:{ID:"DESC"},get_preview:true,check_area:1}}}};var s=function e(t){return t.reduce(function(e,t){return[].concat(babelHelpers.toConsumableArray(e),babelHelpers.toConsumableArray(t.result))},[])};return this.cache.remember("landings+".concat(JSON.stringify(c)),function(){if(c.filter(function(e){return!t.Type.isNil(e)}).length===0){return n.getSites().then(function(e){var t=e.map(function(e){return o(e.ID)});return n.batch("Landing::getList",t)}).then(function(e){return s(e)}).then(function(e){e.forEach(function(e){n.cache.set("landing+".concat(e.ID),Promise.resolve(e))})})}var e=c.map(function(e){return o(e)});return n.batch("Landing::getList",e).then(function(e){return s(e)}).then(function(e){e.forEach(function(e){n.cache.set("landing+".concat(e.ID),Promise.resolve(e))});return e})})}},{key:"getLanding",value:function e(n){var i=this;var r=n.landingId;return this.cache.remember("landing+".concat(r),function(){return i.action("Landing::getList",{params:{filter:{ID:r},get_preview:true}}).then(function(e){if(t.Type.isArray(e)&&e.length>0){return e[0]}return null})})}},{key:"getBlocks",value:function e(t){var n=this;var i=t.landingId;return this.cache.remember("blocks+".concat(i),function(){return n.action("Block::getList",{lid:i,params:{get_content:true,edit_mode:true}}).then(function(e){e.forEach(function(e){n.cache.set("block+".concat(e.id),Promise.resolve(e))});return e})})}},{key:"getBlock",value:function e(t){var n=this;var i=t.blockId;return this.cache.remember("blockId+".concat(i),function(){return n.action("Block::getById",{block:i,params:{edit_mode:true}})})}},{key:"getTemplates",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},i=n.type,r=i===void 0?"page":i,a=n.filter,c=a===void 0?{}:a;return this.cache.remember("templates+".concat(JSON.stringify(c)),function(){return t.action("Demos::getPageList",{type:r,filter:c}).then(function(e){return Object.values(e)})})}},{key:"getDynamicTemplates",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";return this.cache.remember("dynamicTemplates:".concat(n),function(){return t.getTemplates({filter:{section:"dynamic".concat(n?":".concat(n):"")}})})}},{key:"createPage",value:function e(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var r=n.Env.getInstance().getOptions();var a=i.title,c=i.siteId,o=c===void 0?r.site_id:c,s=i.siteType,u=s===void 0?r.params.type:s,d=i.code,l=d===void 0?t.Text.getRandom(16):d,g=i.blockId,f=i.menuCode,p=i.folderId;var h=function(){var e=r.theme;if(t.Type.isPlainObject(e)&&t.Type.isArray(e.newPageTemplate)&&t.Type.isStringFilled(e.newPageTemplate[0])){return e.newPageTemplate[0]}return"empty"}();var v={siteId:o,code:h,fields:{TITLE:a,CODE:l,ADD_IN_MENU:u==="KNOWLEDGE"||u==="GROUP"?"Y":"N"}};if(t.Type.isNumber(g)&&t.Type.isString(f)){v.fields.BLOCK_ID=g;v.fields.MENU_CODE=f}if(t.Type.isNumber(p)){v.fields.FOLDER_ID=p}return this.action("Landing::addByTemplate",v)}}],[{key:"getInstance",value:function t(){if(!e.instance){e.instance=new e}return e.instance}},{key:"makeResponse",value:function e(n){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var r=function(){if(t.Type.isStringFilled(i.type)){return i.type}if(t.Type.isPlainObject(i)&&Object.values(i).length>0){var e=Object.values(i).every(function(e){return e.type==="success"});if(e){return"success"}}if(t.Type.isArray(i)){return"other"}return"error"}();if(r==="other"){return i}return babelHelpers.objectSpread({result:null,type:r},i,{status:n.status,authorized:n.getResponseHeader("X-Bitrix-Ajax-Status")!=="Authorize"})}},{key:"request",value:function n(r){var a=r.url,c=r.data;return new Promise(function(n,r){var o=c instanceof FormData?c:t.Http.Data.convertObjectToFormData(c);var s=t.ajax({method:"POST",dataType:"json",url:a,data:o,start:false,preparePost:false,onsuccess:function o(u){var d=e.makeResponse(s,u);if(t.Type.isStringFilled(d.sessid)&&i){t.Loc.setMessage("bitrix_sessid",d.sessid);i=false;var l=babelHelpers.objectSpread({},c,{sessid:t.Loc.getMessage("bitrix_sessid")});e.request({url:a,data:l}).then(function(e){i=true;n(e)}).catch(function(e){i=true;r(e)});return}if(!t.Type.isPlainObject(d)){n(d);return}if(d.type==="error"||d.authorized===false){r(d);return}n(d)},onfailure:function t(n){if(n==="auth"){r(e.makeResponse(s))}else{r(e.makeResponse(s,n))}}});s.send(o)})}}]);return e}();e.Backend=r})(this.BX.Landing=this.BX.Landing||{},BX,BX.Landing);
//# sourceMappingURL=backend.bundle.map.js