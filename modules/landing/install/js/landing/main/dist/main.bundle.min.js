this.BX=this.BX||{};(function(e,t,n,o,a,i,r,s,l){"use strict";function c(e){return!!e&&!!e.querySelector(".block-wrapper")}function d(e){return!!e&&!!e.querySelector('button[data-id="insert_first_block"]')}function u(e,t){return new Promise(function(n){var o=function o(a){if(!t||a.animationName===t){n(a);s.Event.bind(e,"animationend",o)}};s.Event.bind(e,"animationend",o)})}function k(e){if(s.Type.isNil(e)){return true}if(s.Type.isArrayLike(e)){return!e.length}if(s.Type.isObject(e)){return Object.keys(e).length<=0}return true}function f(){var e=babelHelpers.taggedTemplateLiteral(["",""]);f=function t(){return e};return e}var g="ru";var h="by";var m="kz";var B="la";var b="de";var v="br";var p="ua";BX.Landing.getMode=function(){return"edit"};var y=function(e){babelHelpers.inherits(y,e);babelHelpers.createClass(y,null,[{key:"getMode",value:function e(){return"edit"}},{key:"createInstance",value:function e(t){var n=BX.Landing.PageObject.getRootWindow();n.BX.Landing.Main.instance=new BX.Landing.Main(t)}},{key:"getInstance",value:function e(){var t=BX.Landing.PageObject.getRootWindow();t.BX.Reflection.namespace("BX.Landing.Main");if(t.BX.Landing.Main.instance){return t.BX.Landing.Main.instance}t.BX.Landing.Main.instance=new y(-1);return t.BX.Landing.Main.instance}}]);function y(e){var n;babelHelpers.classCallCheck(this,y);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(y).call(this));n.setEventNamespace("BX.Landing.Main");var o=t.Env.getInstance().getOptions();n.id=e;n.options=Object.freeze(o);n.blocks=n.options.blocks;n.currentBlock=null;n.isDesignBlockModeFlag=n.options["design_block"]===true;n.loadedDeps={};n.cache=new s.Cache.MemoryCache;n.onSliderFormLoaded=n.onSliderFormLoaded.bind(babelHelpers.assertThisInitialized(n));n.onBlockDelete=n.onBlockDelete.bind(babelHelpers.assertThisInitialized(n));BX.addCustomEvent("Landing.Block:onAfterDelete",n.onBlockDelete);n.adjustEmptyAreas();BX.Landing.UI.Panel.StatusPanel.setLastModified(o.lastModified);if(!n.isDesignBlockModeFlag){BX.Landing.UI.Panel.StatusPanel.getInstance().show()}var a=t.Env.getInstance().getType();if(a==="KNOWLEDGE"||a==="GROUP"){var i=document.querySelector(".landing-main");if(s.Type.isDomNode(i)){s.Dom.addClass(i,"landing-ui-collapse")}}return n}babelHelpers.createClass(y,[{key:"isCrmFormPage",value:function e(){return t.Env.getInstance().getOptions().specialType==="crm_forms"}},{key:"isDesignBlockMode",value:function e(){return this.isDesignBlockModeFlag}},{key:"getSaveBlockPanel",value:function e(){var t=new a.SaveBlock("save_block_panel",{block:this.currentBlock});t.layout.hidden=true;t.content.hidden=false;s.Dom.append(t.layout,document.body);return t}},{key:"getBlocksPanel",value:function e(){var t=this;return this.cache.remember("blockPanel",function(){var e=t.createBlocksPanel();setTimeout(function(){if(e.sidebarButtons.get(t.options.default_section)){e.sidebarButtons.get(t.options.default_section).layout.click()}else{babelHelpers.toConsumableArray(e.sidebarButtons)[0].layout.click()}});e.layout.hidden=true;e.content.hidden=false;s.Dom.append(e.layout,document.body);return e})}},{key:"hideBlocksPanel",value:function e(){if(this.getBlocksPanel()){return this.getBlocksPanel().hide()}return Promise.resolve()}},{key:"getLayoutAreas",value:function e(){return this.cache.remember("layoutAreas",function(){return[].concat(babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-header")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-sidebar")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-main")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-footer")))})}},{key:"createInsertBlockButton",value:function e(t){var o=new BX.Landing.UI.Button.Plus("insert_first_block",{text:n.Loc.getMessage("ACTION_BUTTON_CREATE")});o.on("click",this.showBlocksPanel.bind(this,null,t,o));o.on("mouseover",this.onCreateButtonMouseover.bind(this,t,o));o.on("mouseout",this.onCreateButtonMouseout.bind(this,t,o));return o}},{key:"onCreateButtonMouseover",value:function e(t,o){if(s.Dom.hasClass(t,"landing-header")||s.Dom.hasClass(t,"landing-footer")){var a=this.getLayoutAreas();if(a.length>1){var i=n.Loc.getMessage("ACTION_BUTTON_CREATE");if(s.Dom.hasClass(t,"landing-main")){o.setText("".concat(i," ").concat(n.Loc.getMessage("LANDING_ADD_BLOCK_TO_MAIN")))}if(s.Dom.hasClass(t,"landing-header")){o.setText("".concat(i," ").concat(n.Loc.getMessage("LANDING_ADD_BLOCK_TO_HEADER")))}if(s.Dom.hasClass(t,"landing-sidebar")){o.setText("".concat(i," ").concat(n.Loc.getMessage("LANDING_ADD_BLOCK_TO_SIDEBAR")))}if(s.Dom.hasClass(t,"landing-footer")){o.setText("".concat(i," ").concat(n.Loc.getMessage("LANDING_ADD_BLOCK_TO_FOOTER")))}clearTimeout(this.fadeTimeout);this.fadeTimeout=setTimeout(function(){s.Dom.addClass(t,"landing-area-highlight");a.filter(function(e){return e!==t}).forEach(function(e){s.Dom.addClass(e,"landing-area-fade")})},400)}}}},{key:"onCreateButtonMouseout",value:function e(t,o){clearTimeout(this.fadeTimeout);if(s.Dom.hasClass(t,"landing-header")||s.Dom.hasClass(t,"landing-footer")){var a=this.getLayoutAreas();if(a.length>1){o.setText(n.Loc.getMessage("ACTION_BUTTON_CREATE"));a.forEach(function(e){s.Dom.removeClass(e,"landing-area-highlight");s.Dom.removeClass(e,"landing-area-fade")})}}}},{key:"initEmptyArea",value:function e(t){if(t){t.innerHTML="";s.Dom.append(this.createInsertBlockButton(t).layout,t);s.Dom.addClass(t,"landing-empty")}}},{key:"destroyEmptyArea",value:function e(t){if(t){var n=t.querySelector('button[data-id="insert_first_block"]');if(n){s.Dom.remove(n)}s.Dom.removeClass(t,"landing-empty")}}},{key:"adjustEmptyAreas",value:function e(){this.getLayoutAreas().filter(function(e){return c(e)&&d(e)}).forEach(this.destroyEmptyArea,this);this.getLayoutAreas().filter(function(e){return!c(e)&&!d(e)}).forEach(this.initEmptyArea,this);var t=document.body.querySelector("main.landing-edit-mode");var n=!this.getLayoutAreas().some(c);if(t){if(n){s.Dom.addClass(t,"landing-empty");return}s.Dom.removeClass(t,"landing-empty")}}},{key:"enableControls",value:function e(){s.Dom.removeClass(document.body,"landing-ui-hide-controls")}},{key:"disableControls",value:function e(){s.Dom.addClass(document.body,"landing-ui-hide-controls")}},{key:"isControlsEnabled",value:function e(){return!s.Dom.hasClass(document.body,"landing-ui-hide-controls")}},{key:"setTouchDevice",value:function e(){s.Dom.removeClass(document.documentElement,"bx-no-touch");s.Dom.addClass(document.documentElement,"bx-touch")}},{key:"setNoTouchDevice",value:function e(){s.Dom.removeClass(document.documentElement,"bx-touch");s.Dom.addClass(document.documentElement,"bx-no-touch")}},{key:"appendBlock",value:function e(t,n){var o=s.Tag.render(f(),t.content);o.id="block".concat(t.id);if(!n){s.Dom.addClass(o,"landing-ui-show");u(o,"showBlock").then(function(){s.Dom.removeClass(o,"landing-ui-show")})}this.insertToBlocksFlow(o);return o}},{key:"showBlocksPanel",value:function e(t,n,o,a){this.currentBlock=t;this.currentArea=n;this.insertBefore=a;BX.Landing.UI.Panel.EditorPanel.getInstance().hide();if(this.isCrmFormPage()){var i=r.PageObject.getRootWindow();s.Dom.append(this.getBlocksPanel().layout,i.document.body);s.Dom.append(this.getBlocksPanel().overlay,i.document.body)}this.getBlocksPanel().show();this.disableAddBlockButtons();if(!!n&&!!o){this.onCreateButtonMouseout(n,o)}}},{key:"showSaveBlock",value:function e(t){this.currentBlock=t;this.getSaveBlockPanel().show()}},{key:"disableAddBlockButtons",value:function e(){r.PageObject.getBlocks().forEach(function(e){var t=e.panels.get("create_action");if(t){var n=t.buttons.get("insert_after");if(n){n.disable()}}})}},{key:"enableAddBlockButtons",value:function e(){r.PageObject.getBlocks().forEach(function(e){var t=e.panels.get("create_action");if(t){var n=t.buttons.get("insert_after");if(n){n.enable()}}})}},{key:"createBlocksPanel",value:function e(){var t=this;var a=this.options.blocks;var i=Object.keys(a);var r=new o.Content("blocks_panel",{title:n.Loc.getMessage("LANDING_CONTENT_BLOCKS_TITLE"),className:"landing-ui-panel-block-list",scrollAnimation:true});r.subscribe("onCancel",function(){t.enableAddBlockButtons()});i.forEach(function(e){var n=!k(a[e].items);var o=e==="popular";var i=a[e].separator;if(n&&!o||i){r.appendSidebarButton(t.createBlockPanelSidebarButton(e,a[e]))}});r.appendSidebarButton(new BX.Landing.UI.Button.SidebarButton("feedback_button",{className:"landing-ui-button-sidebar-feedback",text:n.Loc.getMessage("LANDING_BLOCKS_LIST_FEEDBACK_BUTTON"),onClick:this.showFeedbackForm.bind(this)}));return r}},{key:"showSliderFeedbackForm",value:function e(){var t=this;var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=r.PageObject.getRootWindow();if(!this.sliderFeedbackInited){this.sliderFeedbackInited=true;this.sliderFeedback=new o.Content("slider_feedback",{title:n.Loc.getMessage("LANDING_PANEL_FEEDBACK_TITLE"),className:"landing-ui-panel-feedback"});s.Dom.append(this.sliderFeedback.overlay,i.document.body);s.Dom.style(this.sliderFeedback.overlay,"z-index",322);s.Dom.append(this.sliderFeedback.layout,i.document.body);this.sliderFormLoader=new BX.Loader({target:this.sliderFeedback.content});this.sliderFormLoader.show();this.initFeedbackForm()}a.bitrix24=this.options.server_name;a.siteId=this.options.site_id;a.siteUrl=this.options.url;a.siteTemplate=this.options.xml_id;a.productType=this.options.productType||"Undefined";a.typeproduct=function(){if(t.options.params.type==="GROUP"){return"KNOWLEDGE_GROUP"}return t.options.params.type}();var l=this.getFeedbackFormOptions();i.b24formFeedBack({id:l.id,lang:l.lang,sec:l.sec,type:"slider_inline",node:this.sliderFeedback.content,handlers:{load:this.onSliderFormLoaded.bind(this)},presets:s.Type.isPlainObject(a)?a:{}});this.sliderFeedback.show()}},{key:"getFeedbackFormOptions",value:function e(){var t=n.Loc.getMessage("LANGUAGE_ID");var o={id:"16",sec:"3h483y",lang:"en"};switch(t){case g:case h:case m:o={id:"8",sec:"x80yjw",lang:"ru"};break;case B:o={id:"14",sec:"wu561i",lang:"la"};break;case b:o={id:"10",sec:"eraz2q",lang:"de"};break;case v:o={id:"12",sec:"r6wvge",lang:"br"};break;case p:o={id:"18",sec:"d9e09o",lang:"ua"};break;default:break}return o}},{key:"onSliderFormLoaded",value:function e(){this.sliderFormLoader.hide()}},{key:"showFeedbackForm",value:function e(){this.showSliderFeedbackForm({target:"blocksList"})}},{key:"initFeedbackForm",value:function e(){var t=r.PageObject.getRootWindow();(function(e,t,n,o){e.Bitrix24FormObject=o;e[o]=e[o]||function(){arguments[0].ref=n;(e[o].forms=e[o].forms||[]).push(arguments[0])};if(e[o].forms)return;var a=t.createElement("script");var i=1*new Date;a.async=1;a.src="".concat(n,"?").concat(i);var r=t.getElementsByTagName("script")[0];r.parentNode.insertBefore(a,r)})(t,t.document,"https://landing.bitrix24.ru/bitrix/js/crm/form_loader.js","b24formFeedBack")}},{key:"createBlockPanelSidebarButton",value:function e(t,n){return new BX.Landing.UI.Button.SidebarButton(t,{text:n.name,child:!n.separator,className:n.new?"landing-ui-new-section":"",onClick:this.onBlocksListCategoryChange.bind(this,t)})}},{key:"addNewBlockToCategory",value:function e(t,n){if(this.blocks[t]){var o=n["codeOriginal"]||n["code"];if(t==="last"){if(!this.lastBlocks){this.lastBlocks=Object.keys(this.blocks.last.items)}this.lastBlocks.unshift(o)}else{this.blocks[t].items[o]=n}this.onBlocksListCategoryChange(t)}}},{key:"getTemplateCode",value:function e(){var n=t.Env.getInstance().getOptions(),o=n.tplCode;if(o.indexOf("@")>0){o=o.split("@")[1]}if(!o||o.length<=0){o=null}return o}},{key:"onBlocksListCategoryChange",value:function e(t){var n=this;var o=this.getTemplateCode();this.getBlocksPanel().content.hidden=false;this.getBlocksPanel().sidebarButtons.forEach(function(e){var n=e.id===t?"add":"remove";e.layout.classList[n]("landing-ui-active")});this.getBlocksPanel().content.innerHTML="";if(t==="last"){if(!this.lastBlocks){this.lastBlocks=Object.keys(this.blocks.last.items)}this.lastBlocks=babelHelpers.toConsumableArray(new Set(this.lastBlocks));this.lastBlocks.forEach(function(e){var t=n.getBlockFromRepository(e);n.getBlocksPanel().appendCard(n.createBlockCard(e,t))});return}Object.keys(this.blocks[t].items).forEach(function(e){var a=n.blocks[t].items[e];var i=a["tpl_code"]&&a["tpl_code"].length>0?a["tpl_code"]:null;if(!o||!i||i&&i===o){n.getBlocksPanel().appendCard(n.createBlockCard(e,a))}});if(this.getBlocksPanel().content.scrollTop){requestAnimationFrame(function(){n.getBlocksPanel().content.scrollTop=0})}}},{key:"getBlockFromRepository",value:function e(t){var n=this.options.blocks;var o=Object.keys(n);var a=o.find(function(e){return t in n[e].items});if(a){return n[a].items[t]}}},{key:"onCopyBlock",value:function e(t){window.localStorage.landingBlockId=t.id;window.localStorage.landingBlockName=t.manifest.block.name;window.localStorage.landingBlockAction="copy";try{window.localStorage.requiredUserAction=JSON.stringify(t.requiredUserActionOptions)}catch(e){window.localStorage.requiredUserAction=""}}},{key:"onCutBlock",value:function e(t){window.localStorage.landingBlockId=t.id;window.localStorage.landingBlockName=t.manifest.block.name;window.localStorage.landingBlockAction="cut";try{window.localStorage.requiredUserAction=JSON.stringify(t.requiredUserActionOptions)}catch(e){window.localStorage.requiredUserAction=""}BX.Landing.PageObject.getBlocks().remove(t);s.Dom.remove(t.node);BX.onCustomEvent("Landing.Block:onAfterDelete",[t])}},{key:"onPasteBlock",value:function e(t){var n=this;if(window.localStorage.landingBlockId){var o="Landing::copyBlock";if(window.localStorage.landingBlockAction==="cut"){o="Landing::moveBlock"}var a={};a[o]={action:o,data:{lid:t.lid||BX.Landing.Main.getInstance().id,block:window.localStorage.landingBlockId,params:{AFTER_ID:t.id,RETURN_CONTENT:"Y"}}};BX.Landing.Backend.getInstance().batch(o,a,{action:o}).then(function(e){n.currentBlock=t;return n.addBlock(e[o].result.content)})}}},{key:"addBlock",value:function e(t,n,o){if(this.lastBlocks){this.lastBlocks.unshift(t.manifest.codeOriginal||t.manifest.code)}var a=this;var i=this.appendBlock(t,o);return this.loadBlockDeps(t).then(function(e){if(!s.Type.isBoolean(n)||n===false){var o=null;var r=null;if(a.currentBlock){o=a.currentBlock.lid;r=a.currentBlock.id}if(a.currentArea){o=s.Dom.attr(a.currentArea,"data-landing");r=s.Dom.attr(a.currentArea,"data-site")}BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:e.id,selector:"#block".concat(e.id),command:"addBlock",undo:"",redo:{currentBlock:r,lid:o,code:e.manifest.code}}))}a.currentBlock=null;a.currentArea=null;var l=parseInt(t.id);var c=BX.Landing.PageObject.getBlocks().get(l);if(c){s.Dom.remove(c.node);BX.Landing.PageObject.getBlocks().remove(c)}void new BX.Landing.Block(i,{id:l,requiredUserAction:t.requiredUserAction,manifest:t.manifest,access:t.access,active:s.Text.toBoolean(t.active),php:t.php,designed:t.designed,anchor:t.anchor,dynamicParams:t.dynamicParams,repoId:t.repoId});return a.runBlockScripts(t).then(function(){return i})}).catch(function(e){console.warn(e)})}},{key:"onAddBlock",value:function e(t,n,o){var a=this;var i=s.Text.toNumber(n);this.hideBlocksPanel();return this.showBlockLoader().then(this.loadBlock(t,i)).then(function(e){return new Promise(function(t){setTimeout(function(){t(e)},500)})}).then(function(e){e.manifest.codeOriginal=t;var n=a.addBlock(e,o,false);a.insertBefore=false;a.adjustEmptyAreas();void a.hideBlockLoader();a.enableAddBlockButtons();return n})}},{key:"insertToBlocksFlow",value:function e(t){var n=this.currentBlock&&this.currentBlock.node&&this.currentBlock.node.parentNode;if(n&&!this.insertBefore){s.Dom.insertAfter(t,this.currentBlock.node);return}if(n&&this.insertBefore){s.Dom.insertBefore(t,this.currentBlock.node)}s.Dom.prepend(t,this.currentArea)}},{key:"getBlockLoader",value:function e(){if(!this.blockLoader){this.blockLoader=new BX.Loader({size:60});this.blockLoaderContainer=s.Dom.create("div",{props:{className:"landing-block-loader-container"},children:[this.blockLoader.layout]})}return this.blockLoaderContainer}},{key:"showBlockLoader",value:function e(){this.insertToBlocksFlow(this.getBlockLoader());this.blockLoader.show();return Promise.resolve()}},{key:"hideBlockLoader",value:function e(){s.Dom.remove(this.getBlockLoader());this.blockLoader=null;return Promise.resolve()}},{key:"loadBlockDeps",value:function e(t){var n=this;var o=BX.processHTML(t.content_ext);if(BX.type.isArray(o.SCRIPT)){o.SCRIPT=o.SCRIPT.filter(function(e){return!e.isInternal})}var a=0;var i=t.js.length+o.SCRIPT.length+o.STYLE.length+t.css.length;var r=null;if(!this.loadedDeps[t.manifest.code]&&i>0){r=new Promise(function(e){function r(){a+=1;if(a===i){e(t)}}if(i>a){o.SCRIPT.forEach(function(e){if(!e.isInternal){BX.loadScript(e.JS,r)}});o.STYLE.forEach(function(e){BX.loadScript(e,r)});t.css.forEach(function(e){BX.loadScript(e,r)});t.js.forEach(function(e){BX.loadScript(e,r)})}else{r()}n.loadedDeps[t.manifest.code]=true})}else{r=Promise.resolve(t)}return r}},{key:"runBlockScripts",value:function e(t){return new Promise(function(e){var n=BX.processHTML(t.content).SCRIPT;if(n.length){BX.ajax.processScripts(n,undefined,function(){e(t)})}else{e(t)}})}},{key:"loadBlock",value:function e(t,n){var o=this;return function(){var e=o.id;var a=o.options.site_id;if(o.currentBlock){e=o.currentBlock.lid;a=o.currentBlock.siteId}if(o.currentArea){e=s.Dom.attr(o.currentArea,"data-landing");a=s.Dom.attr(o.currentArea,"data-site")}var i={lid:e,siteId:a};var r={ACTIVE:"Y",CODE:t,AFTER_ID:o.currentBlock?o.currentBlock.id:0,RETURN_CONTENT:"Y"};if(!n){i.fields=r;return l.Backend.getInstance().action("Landing::addBlock",i,{code:t}).then(function(t){if(o.insertBefore){return l.Backend.getInstance().action("Landing::upBlock",{lid:e,siteId:a,block:t.id}).then(function(){return t})}return t})}i={undeleete:{action:"Landing::markUndeletedBlock",data:{lid:e,block:n}},getContent:{action:"Block::getContent",data:{block:n,lid:e,fields:r,editMode:1}}};return BX.Landing.Backend.getInstance().batch("Landing::addBlock",i,{code:t}).then(function(e){e.getContent.result.id=n;return e.getContent.result})}}},{key:"createBlockCard",value:function e(t,n,o){return new BX.Landing.UI.Card.BlockPreviewCard({title:n.name,image:n.preview,code:t,app_expired:n.app_expired,favorite:!!n.favorite,favoriteMy:!!n.favoriteMy,repo_id:n.repo_id,mode:o,isNew:n.new===true,onClick:this.onAddBlock.bind(this,t)})}},{key:"onBlockDelete",value:function e(t){if(!t.parent.querySelector(".block-wrapper")){this.adjustEmptyAreas()}}},{key:"showOverlay",value:function e(){var t=document.querySelector("main.landing-edit-mode");if(t){s.Dom.addClass(t,"landing-ui-overlay")}}},{key:"hideOverlay",value:function e(){var t=document.querySelector("main.landing-edit-mode");if(t){s.Dom.removeClass(t,"landing-ui-overlay")}}},{key:"reloadSlider",value:function e(t){return i.SliderHacks.reloadSlider(t,window.parent)}}]);return y}(s.Event.EventEmitter);babelHelpers.defineProperty(y,"TYPE_PAGE","PAGE");babelHelpers.defineProperty(y,"TYPE_STORE","STORE");babelHelpers.defineProperty(y,"TYPE_KNOWLEDGE","KNOWLEDGE");babelHelpers.defineProperty(y,"TYPE_GROUP","GROUP");e.Main=y})(this.BX.Landing=this.BX.Landing||{},BX.Landing,BX.Landing,BX.Landing.UI.Panel,BX.Landing.UI.Panel,BX.Landing,BX.Landing,BX,BX.Landing);
//# sourceMappingURL=main.bundle.map.js