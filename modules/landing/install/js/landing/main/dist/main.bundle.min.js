this.BX=this.BX||{};(function(e,n,t,o,a,i,r,l,s,c){"use strict";function d(e){return!!e&&!!e.querySelector(".block-wrapper")}function u(e){return!!e&&!!e.querySelector('button[data-id="insert_first_block"]')}function f(e,n){return new Promise((function(t){var o=function o(a){if(!n||a.animationName===n){t(a);s.Event.bind(e,"animationend",o)}};s.Event.bind(e,"animationend",o)}))}function k(e){if(s.Type.isNil(e)){return true}if(s.Type.isArrayLike(e)){return!e.length}if(s.Type.isObject(e)){return Object.keys(e).length<=0}return true}function g(){var e=babelHelpers.taggedTemplateLiteral(["",""]);g=function n(){return e};return e}BX.Landing.getMode=function(){return"edit"};var B=function(e){babelHelpers.inherits(n,e);babelHelpers.createClass(n,null,[{key:"getMode",value:function e(){return"edit"}},{key:"createInstance",value:function e(n){var t=BX.Landing.PageObject.getRootWindow();t.BX.Landing.Main.instance=new BX.Landing.Main(n)}},{key:"getInstance",value:function e(){var t=BX.Landing.PageObject.getRootWindow();t.BX.Reflection.namespace("BX.Landing.Main");if(t.BX.Landing.Main.instance){return t.BX.Landing.Main.instance}t.BX.Landing.Main.instance=new n(-1);return t.BX.Landing.Main.instance}}]);function n(e){var o;babelHelpers.classCallCheck(this,n);o=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this));o.setEventNamespace("BX.Landing.Main");var a=t.Env.getInstance().getOptions();o.id=e;o.options=Object.freeze(a);o.blocks=o.options.blocks;o.currentBlock=null;o.isDesignBlockModeFlag=o.options["design_block"]===true;o.loadedDeps={};o.cache=new s.Cache.MemoryCache;o.onSliderFormLoaded=o.onSliderFormLoaded.bind(babelHelpers.assertThisInitialized(o));o.onBlockDelete=o.onBlockDelete.bind(babelHelpers.assertThisInitialized(o));BX.addCustomEvent("Landing.Block:onAfterDelete",o.onBlockDelete);o.adjustEmptyAreas();BX.Landing.UI.Panel.StatusPanel.setLastModified(a.lastModified);if(!o.isDesignBlockModeFlag){BX.Landing.UI.Panel.StatusPanel.getInstance().show()}var i=t.Env.getInstance().getType();if(i===n.TYPE_KNOWLEDGE||i===n.TYPE_GROUP){var r=document.querySelector(".landing-main");if(s.Type.isDomNode(r)){s.Dom.addClass(r,"landing-ui-collapse")}}return o}babelHelpers.createClass(n,[{key:"isCrmFormPage",value:function e(){return t.Env.getInstance().getOptions().specialType==="crm_forms"}},{key:"isDesignBlockMode",value:function e(){return this.isDesignBlockModeFlag}},{key:"getSaveBlockPanel",value:function e(){var n=new i.SaveBlock("save_block_panel",{block:this.currentBlock});n.layout.hidden=true;n.content.hidden=false;s.Dom.append(n.layout,document.body);return n}},{key:"getBlocksPanel",value:function e(){var n=this;return this.cache.remember("blockPanel",(function(){var e=n.createBlocksPanel();setTimeout((function(){if(e.sidebarButtons.get(n.options.default_section)){e.sidebarButtons.get(n.options.default_section).layout.click()}else{babelHelpers.toConsumableArray(e.sidebarButtons)[0].layout.click()}}));e.layout.hidden=true;e.content.hidden=false;s.Dom.append(e.layout,document.body);return e}))}},{key:"hideBlocksPanel",value:function e(){if(this.getBlocksPanel()){return this.getBlocksPanel().hide()}return Promise.resolve()}},{key:"getLayoutAreas",value:function e(){return this.cache.remember("layoutAreas",(function(){return[].concat(babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-header")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-sidebar")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-main")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-footer")))}))}},{key:"createInsertBlockButton",value:function e(n){var t=new BX.Landing.UI.Button.Plus("insert_first_block",{text:o.Loc.getMessage("ACTION_BUTTON_CREATE")});t.on("click",this.showBlocksPanel.bind(this,null,n,t));t.on("mouseover",this.onCreateButtonMouseover.bind(this,n,t));t.on("mouseout",this.onCreateButtonMouseout.bind(this,n,t));return t}},{key:"onCreateButtonMouseover",value:function e(n,t){if(s.Dom.hasClass(n,"landing-header")||s.Dom.hasClass(n,"landing-footer")){var a=this.getLayoutAreas();if(a.length>1){var i=o.Loc.getMessage("ACTION_BUTTON_CREATE");if(s.Dom.hasClass(n,"landing-main")){t.setText("".concat(i," ").concat(o.Loc.getMessage("LANDING_ADD_BLOCK_TO_MAIN")))}if(s.Dom.hasClass(n,"landing-header")){t.setText("".concat(i," ").concat(o.Loc.getMessage("LANDING_ADD_BLOCK_TO_HEADER")))}if(s.Dom.hasClass(n,"landing-sidebar")){t.setText("".concat(i," ").concat(o.Loc.getMessage("LANDING_ADD_BLOCK_TO_SIDEBAR")))}if(s.Dom.hasClass(n,"landing-footer")){t.setText("".concat(i," ").concat(o.Loc.getMessage("LANDING_ADD_BLOCK_TO_FOOTER")))}clearTimeout(this.fadeTimeout);this.fadeTimeout=setTimeout((function(){s.Dom.addClass(n,"landing-area-highlight");a.filter((function(e){return e!==n})).forEach((function(e){s.Dom.addClass(e,"landing-area-fade")}))}),400)}}}},{key:"onCreateButtonMouseout",value:function e(n,t){clearTimeout(this.fadeTimeout);if(s.Dom.hasClass(n,"landing-header")||s.Dom.hasClass(n,"landing-footer")){var a=this.getLayoutAreas();if(a.length>1){t.setText(o.Loc.getMessage("ACTION_BUTTON_CREATE"));a.forEach((function(e){s.Dom.removeClass(e,"landing-area-highlight");s.Dom.removeClass(e,"landing-area-fade")}))}}}},{key:"initEmptyArea",value:function e(n){if(n){n.innerHTML="";s.Dom.append(this.createInsertBlockButton(n).layout,n);s.Dom.addClass(n,"landing-empty")}}},{key:"destroyEmptyArea",value:function e(n){if(n){var t=n.querySelector('button[data-id="insert_first_block"]');if(t){s.Dom.remove(t)}s.Dom.removeClass(n,"landing-empty")}}},{key:"adjustEmptyAreas",value:function e(){this.getLayoutAreas().filter((function(e){return d(e)&&u(e)})).forEach(this.destroyEmptyArea,this);this.getLayoutAreas().filter((function(e){return!d(e)&&!u(e)})).forEach(this.initEmptyArea,this);var n=document.body.querySelector("main.landing-edit-mode");var t=!this.getLayoutAreas().some(d);if(n){if(t){s.Dom.addClass(n,"landing-empty");return}s.Dom.removeClass(n,"landing-empty")}}},{key:"enableControls",value:function e(){s.Dom.removeClass(document.body,"landing-ui-hide-controls")}},{key:"disableControls",value:function e(){s.Dom.addClass(document.body,"landing-ui-hide-controls")}},{key:"isControlsEnabled",value:function e(){return!s.Dom.hasClass(document.body,"landing-ui-hide-controls")}},{key:"setTouchDevice",value:function e(){s.Dom.removeClass(document.documentElement,"bx-no-touch");s.Dom.addClass(document.documentElement,"bx-touch")}},{key:"setNoTouchDevice",value:function e(){s.Dom.removeClass(document.documentElement,"bx-touch");s.Dom.addClass(document.documentElement,"bx-no-touch")}},{key:"appendBlock",value:function e(n,t){var o=s.Tag.render(g(),n.content);o.id="block".concat(n.id);if(!t){s.Dom.addClass(o,"landing-ui-show");f(o,"showBlock").then((function(){s.Dom.removeClass(o,"landing-ui-show")}))}this.insertToBlocksFlow(o);return o}},{key:"showBlocksPanel",value:function e(n,t,o,a){this.currentBlock=n;this.currentArea=t;this.insertBefore=a;BX.Landing.UI.Panel.EditorPanel.getInstance().hide();if(this.isCrmFormPage()){var i=l.PageObject.getRootWindow();s.Dom.append(this.getBlocksPanel().layout,i.document.body);s.Dom.append(this.getBlocksPanel().overlay,i.document.body)}this.getBlocksPanel().show();this.disableAddBlockButtons();if(!!t&&!!o){this.onCreateButtonMouseout(t,o)}}},{key:"showSaveBlock",value:function e(n){this.currentBlock=n;this.getSaveBlockPanel().show()}},{key:"disableAddBlockButtons",value:function e(){l.PageObject.getBlocks().forEach((function(e){var n=e.panels.get("create_action");if(n){var t=n.buttons.get("insert_after");if(t){t.disable()}}}))}},{key:"enableAddBlockButtons",value:function e(){l.PageObject.getBlocks().forEach((function(e){var n=e.panels.get("create_action");if(n){var t=n.buttons.get("insert_after");if(t){t.enable()}}}))}},{key:"createBlocksPanel",value:function e(){var n=this;var t=this.options.blocks;var i=Object.keys(t);var r=new a.Content("blocks_panel",{title:o.Loc.getMessage("LANDING_CONTENT_BLOCKS_TITLE"),className:"landing-ui-panel-block-list",scrollAnimation:true});r.subscribe("onCancel",(function(){n.enableAddBlockButtons()}));i.forEach((function(e){var o=!k(t[e].items);var a=e==="popular";var i=t[e].separator;if(o&&!a||i){r.appendSidebarButton(n.createBlockPanelSidebarButton(e,t[e]))}}));r.appendSidebarButton(new BX.Landing.UI.Button.SidebarButton("feedback_button",{className:"landing-ui-button-sidebar-feedback",text:o.Loc.getMessage("LANDING_BLOCKS_LIST_FEEDBACK_BUTTON"),onClick:this.showFeedbackForm.bind(this)}));return r}},{key:"showSliderFeedbackForm",value:function e(){var t=this;s.Runtime.loadExtension("ui.feedback.form").then((function(){var e={};e.bitrix24=t.options.server_name;e.siteId=t.options.site_id;e.siteUrl=t.options.url;e.siteTemplate=t.options.xml_id;e.productType=t.options.productType||"Undefined";e.typeproduct=function(){if(t.options.params.type===n.TYPE_GROUP){return"KNOWLEDGE_GROUP"}return t.options.params.type}();BX.UI.Feedback.Form.open({id:Math.random()+"",forms:t.getFeedbackFormOptions(),presets:e})}))}},{key:"getFeedbackFormOptions",value:function e(){return[{zones:["en","eu","in","uk"],id:16,lang:"en",sec:"3h483y"},{zones:["ru","by","kz"],id:8,lang:"ru",sec:"x80yjw"},{zones:["ua"],id:18,lang:"ua",sec:"d9e09o"},{zones:["la","co","mx"],id:14,lang:"la",sec:"wu561i"},{zones:["de"],id:10,lang:"de",sec:"eraz2q"},{zones:["com.br","br"],id:12,lang:"br",sec:"r6wvge"}]}},{key:"onSliderFormLoaded",value:function e(){this.sliderFormLoader.hide()}},{key:"showFeedbackForm",value:function e(){this.showSliderFeedbackForm({target:"blocksList"})}},{key:"initFeedbackForm",value:function e(){var n=l.PageObject.getRootWindow();(function(e,n,t,o){e.Bitrix24FormObject=o;e[o]=e[o]||function(){arguments[0].ref=t;(e[o].forms=e[o].forms||[]).push(arguments[0])};if(e[o].forms)return;var a=n.createElement("script");var i=1*new Date;a.async=1;a.src="".concat(t,"?").concat(i);var r=n.getElementsByTagName("script")[0];r.parentNode.insertBefore(a,r)})(n,n.document,"https://landing.bitrix24.ru/bitrix/js/crm/form_loader.js","b24formFeedBack")}},{key:"createBlockPanelSidebarButton",value:function e(n,t){return new BX.Landing.UI.Button.SidebarButton(n,{text:t.name,child:!t.separator,className:t.new?"landing-ui-new-section":"",onClick:this.onBlocksListCategoryChange.bind(this,n)})}},{key:"addNewBlockToCategory",value:function e(n,t){if(this.blocks[n]){var o=t["codeOriginal"]||t["code"];if(n==="last"){if(!this.lastBlocks){this.lastBlocks=Object.keys(this.blocks.last.items)}this.lastBlocks.unshift(o)}else{this.blocks[n].items[o]=t}this.onBlocksListCategoryChange(n)}}},{key:"getTemplateCode",value:function e(){var n=t.Env.getInstance().getOptions(),o=n.tplCode;if(o.indexOf("@")>0){o=o.split("@")[1]}if(!o||o.length<=0){o=null}return o}},{key:"onBlocksListCategoryChange",value:function e(n){var t=this;var o=this.getTemplateCode();this.getBlocksPanel().content.hidden=false;this.getBlocksPanel().sidebarButtons.forEach((function(e){var t=e.id===n?"add":"remove";e.layout.classList[t]("landing-ui-active")}));this.getBlocksPanel().content.innerHTML="";if(n==="last"){if(!this.lastBlocks){this.lastBlocks=Object.keys(this.blocks.last.items)}this.lastBlocks=babelHelpers.toConsumableArray(new Set(this.lastBlocks));this.lastBlocks.forEach((function(e){var n=t.getBlockFromRepository(e);t.getBlocksPanel().appendCard(t.createBlockCard(e,n))}));return}Object.keys(this.blocks[n].items).forEach((function(e){var a=t.blocks[n].items[e];var i=a["tpl_code"]&&a["tpl_code"].length>0?a["tpl_code"]:null;if(!o||!i||i&&i===o){t.getBlocksPanel().appendCard(t.createBlockCard(e,a))}}));if(this.getBlocksPanel().content.scrollTop){requestAnimationFrame((function(){t.getBlocksPanel().content.scrollTop=0}))}}},{key:"getBlockFromRepository",value:function e(n){var t=this.options.blocks;var o=Object.keys(t);var a=o.find((function(e){return n in t[e].items}));if(a){return t[a].items[n]}}},{key:"onCopyBlock",value:function e(n){window.localStorage.landingBlockId=n.id;window.localStorage.landingBlockName=n.manifest.block.name;window.localStorage.landingBlockAction="copy";try{window.localStorage.requiredUserAction=JSON.stringify(n.requiredUserActionOptions)}catch(e){window.localStorage.requiredUserAction=""}}},{key:"onCutBlock",value:function e(n){window.localStorage.landingBlockId=n.id;window.localStorage.landingBlockName=n.manifest.block.name;window.localStorage.landingBlockAction="cut";try{window.localStorage.requiredUserAction=JSON.stringify(n.requiredUserActionOptions)}catch(e){window.localStorage.requiredUserAction=""}BX.Landing.PageObject.getBlocks().remove(n);s.Dom.remove(n.node);BX.onCustomEvent("Landing.Block:onAfterDelete",[n])}},{key:"onPasteBlock",value:function e(n){var t=this;if(window.localStorage.landingBlockId){var o="Landing::copyBlock";if(window.localStorage.landingBlockAction==="cut"){o="Landing::moveBlock"}var a={};a[o]={action:o,data:{lid:n.lid||BX.Landing.Main.getInstance().id,block:window.localStorage.landingBlockId,params:{AFTER_ID:n.id,RETURN_CONTENT:"Y"}}};BX.Landing.Backend.getInstance().batch(o,a,{action:o}).then((function(e){t.currentBlock=n;return t.addBlock(e[o].result.content)}))}}},{key:"addBlock",value:function e(n,t,o){if(this.lastBlocks){this.lastBlocks.unshift(n.manifest.codeOriginal||n.manifest.code)}var a=this;var i=this.appendBlock(n,o);return this.loadBlockDeps(n).then((function(e){if(!s.Type.isBoolean(t)||t===false){var o=null;var r=null;if(a.currentBlock){o=a.currentBlock.lid;r=a.currentBlock.id}if(a.currentArea){o=s.Dom.attr(a.currentArea,"data-landing");r=s.Dom.attr(a.currentArea,"data-site")}BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:e.id,selector:"#block".concat(e.id),command:"addBlock",undo:"",redo:{currentBlock:r,lid:o,code:e.manifest.code}}))}a.currentBlock=null;a.currentArea=null;var l=parseInt(n.id);var c=BX.Landing.PageObject.getBlocks().get(l);if(c){s.Dom.remove(c.node);BX.Landing.PageObject.getBlocks().remove(c)}void new BX.Landing.Block(i,{id:l,requiredUserAction:n.requiredUserAction,manifest:n.manifest,access:n.access,active:s.Text.toBoolean(n.active),php:n.php,designed:n.designed,anchor:n.anchor,dynamicParams:n.dynamicParams,repoId:n.repoId});return a.runBlockScripts(n).then((function(){return i}))})).catch((function(e){console.warn(e)}))}},{key:"onAddBlock",value:function e(n,t,o){var a=this;var i=s.Text.toNumber(t);this.hideBlocksPanel();return this.showBlockLoader().then(this.loadBlock(n,i)).then((function(e){return new Promise((function(n){setTimeout((function(){n(e)}),500)}))})).then((function(e){e.manifest.codeOriginal=n;var t=a.addBlock(e,o,false);a.insertBefore=false;a.adjustEmptyAreas();void a.hideBlockLoader();a.enableAddBlockButtons();return t}))}},{key:"insertToBlocksFlow",value:function e(n){var t=this.currentBlock&&this.currentBlock.node&&this.currentBlock.node.parentNode;if(t&&!this.insertBefore){s.Dom.insertAfter(n,this.currentBlock.node);return}if(t&&this.insertBefore){s.Dom.insertBefore(n,this.currentBlock.node)}s.Dom.prepend(n,this.currentArea)}},{key:"getBlockLoader",value:function e(){if(!this.blockLoader){this.blockLoader=new BX.Loader({size:60});this.blockLoaderContainer=s.Dom.create("div",{props:{className:"landing-block-loader-container"},children:[this.blockLoader.layout]})}return this.blockLoaderContainer}},{key:"showBlockLoader",value:function e(){this.insertToBlocksFlow(this.getBlockLoader());this.blockLoader.show();return Promise.resolve()}},{key:"hideBlockLoader",value:function e(){s.Dom.remove(this.getBlockLoader());this.blockLoader=null;return Promise.resolve()}},{key:"loadBlockDeps",value:function e(n){var t=this;var o=BX.processHTML(n.content_ext);if(BX.type.isArray(o.SCRIPT)){o.SCRIPT=o.SCRIPT.filter((function(e){return!e.isInternal}))}var a=0;var i=n.js.length+o.SCRIPT.length+o.STYLE.length+n.css.length;var r=null;if(!this.loadedDeps[n.manifest.code]&&i>0){r=new Promise((function(e){function r(){a+=1;if(a===i){e(n)}}if(i>a){o.SCRIPT.forEach((function(e){if(!e.isInternal){BX.loadScript(e.JS,r)}}));o.STYLE.forEach((function(e){BX.loadScript(e,r)}));n.css.forEach((function(e){BX.loadScript(e,r)}));n.js.forEach((function(e){BX.loadScript(e,r)}))}else{r()}t.loadedDeps[n.manifest.code]=true}))}else{r=Promise.resolve(n)}return r}},{key:"runBlockScripts",value:function e(n){return new Promise((function(e){var t=BX.processHTML(n.content).SCRIPT;if(t.length){BX.ajax.processScripts(t,undefined,(function(){e(n)}))}else{e(n)}}))}},{key:"loadBlock",value:function e(n,t){var o=this;return function(){var e=o.id;var a=o.options.site_id;if(o.currentBlock){e=o.currentBlock.lid;a=o.currentBlock.siteId}if(o.currentArea){e=s.Dom.attr(o.currentArea,"data-landing");a=s.Dom.attr(o.currentArea,"data-site")}var i={lid:e,siteId:a};var r={ACTIVE:"Y",CODE:n,AFTER_ID:o.currentBlock?o.currentBlock.id:0,RETURN_CONTENT:"Y"};if(!t){i.fields=r;return c.Backend.getInstance().action("Landing::addBlock",i,{code:n}).then((function(n){if(o.insertBefore){return c.Backend.getInstance().action("Landing::upBlock",{lid:e,siteId:a,block:n.id}).then((function(){return n}))}return n}))}i={undeleete:{action:"Landing::markUndeletedBlock",data:{lid:e,block:t}},getContent:{action:"Block::getContent",data:{block:t,lid:e,fields:r,editMode:1}}};return BX.Landing.Backend.getInstance().batch("Landing::addBlock",i,{code:n}).then((function(e){e.getContent.result.id=t;return e.getContent.result}))}}},{key:"createBlockCard",value:function e(n,t,o){return new BX.Landing.UI.Card.BlockPreviewCard({title:t.name,image:t.preview,code:n,app_expired:t.app_expired,favorite:!!t.favorite,favoriteMy:!!t.favoriteMy,repo_id:t.repo_id,mode:o,isNew:t.new===true,onClick:this.onAddBlock.bind(this,n)})}},{key:"onBlockDelete",value:function e(n){if(!n.parent.querySelector(".block-wrapper")){this.adjustEmptyAreas()}}},{key:"showOverlay",value:function e(){var n=document.querySelector("main.landing-edit-mode");if(n){s.Dom.addClass(n,"landing-ui-overlay")}}},{key:"hideOverlay",value:function e(){var n=document.querySelector("main.landing-edit-mode");if(n){s.Dom.removeClass(n,"landing-ui-overlay")}}},{key:"reloadSlider",value:function e(n){return r.SliderHacks.reloadSlider(n,window.parent)}}]);return n}(n.EventEmitter);babelHelpers.defineProperty(B,"TYPE_PAGE","PAGE");babelHelpers.defineProperty(B,"TYPE_STORE","STORE");babelHelpers.defineProperty(B,"TYPE_KNOWLEDGE","KNOWLEDGE");babelHelpers.defineProperty(B,"TYPE_GROUP","GROUP");e.Main=B})(this.BX.Landing=this.BX.Landing||{},BX.Event,BX.Landing,BX.Landing,BX.Landing.UI.Panel,BX.Landing.UI.Panel,BX.Landing,BX.Landing,BX,BX.Landing);
//# sourceMappingURL=main.bundle.map.js