this.BX=this.BX||{};(function(n,e,t,i,r){"use strict";var o="undo";var a="redo";var s="init";var c="resolved";var l="pending";var u=100;var d=BX.Landing.Utils,h=d.scrollTo,g=d.highlight;function f(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(t){var i=t.get(e.block);if(!i){return Promise.reject()}i.forceInit();var r=i.nodes.getBySelector(e.selector);if(!r){return Promise.reject()}return h(r.node).then(g.bind(null,r.node,true)).then(function(){return r.setValue(e[n],false,true)})})}var m=BX.Landing.Utils,b=m.scrollTo,v=m.highlight;function k(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(t){var i=t.get(e.block);if(!i){return Promise.reject()}i.forceInit();var r=i.nodes.getBySelector(e.selector);if(!r){return Promise.reject()}return b(r.node).then(v.bind(null,r.node,true)).then(function(){return r.setValue(e[n],false,true)})})}var B=BX.Landing.Utils,y=B.scrollTo,p=B.highlight;function P(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(t){var i=t.get(e.block);if(!i){return Promise.reject()}i.forceInit();var r=i.nodes.getBySelector(e.selector);if(!r){return Promise.reject()}return y(r.node).then(p.bind(null,r.node,true)).then(function(){return r.setValue(e[n],false,true)})})}var w=BX.Landing.Utils,L=w.scrollTo,X=w.highlight;function j(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(t){var i=t.get(e.block);if(!i){return Promise.reject()}i.forceInit();var r=i.nodes.getBySelector(e.selector);if(!r){return Promise.reject()}return L(r.node).then(X.bind(null,r.node)).then(function(){e[n].id=0;return r.setValue(e[n],false,true)})})}var I=j;var S=BX.Landing.Utils,C=S.scrollTo,H=S.highlight;function O(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(t){var i=t.get(e.block);if(!i){return Promise.reject()}i.forceInit();var r=i.nodes.getBySelector(e.selector);if(!r){return Promise.reject()}return C(r.node).then(H.bind(null,r.node)).then(function(){return r.setValue(e[n],false,true)})})}var T=BX.Landing.Utils,U=T.scrollTo,E=T.highlight;function M(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(t){var i=t.get(e.block);i.forceInit();return U(i.node).then(E.bind(null,i.node)).then(function(){return i[e[n]](true)})})}var x=BX.Landing.Utils,R=x.scrollTo,W=x.highlight;function V(n,e){return t.PageObject.getInstance().blocks().then(function(i){var r=i.get(e[n].currentBlock);return new Promise(function(n){if(r){r.forceInit();return R(r.node).then(W.bind(null,r.node,false,true)).then(n)}n()}).then(function(){var i=BX.Landing.Main.getInstance();i.currentBlock=r;return t.PageObject.getInstance().view().then(function(t){i.currentArea=t.contentDocument.body.querySelector('[data-landing="'.concat(e[n].lid,'"]'));return i.onAddBlock(e[n].code,e.block,true)})})})}var D=BX.Landing.Utils,F=D.scrollTo,N=D.highlight;function A(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(n){var t=n.get(e.block);t.forceInit();return F(t.node).then(function(){N(t.node);return t.deleteBlock(true)})})}var q=BX.Landing.Utils,z=q.scrollTo,G=q.highlight;function J(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(n){var t=n.get(e.block);if(t){t.forceInit()}if(!t){return Promise.reject()}return t}).then(function(t){return BX.Landing.PageObject.getInstance().view().then(function(i){return[t,i.contentDocument.querySelector(e[n].container)]})}).then(function(n){return z(n[1]).then(function(){return n})}).then(function(t){t[0].addCard({index:e[n].index,container:t[1],content:e[n].html,selector:e.selector});var i=t[0].cards.getBySelector(e.selector);if(!i){return Promise.reject()}return G(i.node)}).catch(function(){})}var K=BX.Landing.Utils,Q=K.scrollTo,Y=K.highlight;function Z(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(n){var t=n.get(e.block);t.forceInit();if(!t){return Promise.reject()}var i=t.cards.getBySelector(e.selector);if(!i){return Promise.reject()}return Q(i.node).then(Y.bind(null,i.node)).then(function(){return t.removeCard(e.selector,true)})})}var $=BX.Landing.Utils,_=$.scrollTo,nn=$.slice;function en(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(n){var t=n.get(e.block);if(!t){return Promise.reject()}t.forceInit();t.initStyles();return t}).then(function(n){return _(n.node).then(function(){return n})}).then(function(t){var i=nn(t.node.querySelectorAll(e.selector));if(t.selector===e.selector){i=[t.content]}i.forEach(function(t){t.className=e[n].className;t.style=e[n].style});return t}).then(function(n){var t=n.forms.find(function(n){return n.selector===e.selector||n.relativeSelector===e.selector});if(t){t.fields.forEach(function(n){n.reset();n.onFrameLoad()})}var i=n.styles.find(function(n){return n.selector===e.selector||n.relativeSelector===e.selector});if(i){n.onStyleInputWithDebounce({node:i.node,data:i.getValue()})}})}var tn=BX.Landing.Utils,rn=tn.scrollTo,on=tn.highlight;function an(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(t){var i=t.get(e.block);i.forceInit();return rn(i.node).then(function(){void on(i.node);i.updateBlockState(BX.clone(e[n]),true)})})}var sn=function n(t){babelHelpers.classCallCheck(this,n);this.id=e.Type.isStringFilled(t.id)?t.id:"#invalidCommand";this.undo=e.Type.isFunction(t.undo)?t.undo:function(){};this.redo=e.Type.isFunction(t.redo)?t.redo:function(){}};function cn(n){n.registerCommand(new sn({id:"editText",undo:f.bind(null,o),redo:f.bind(null,a)}));n.registerCommand(new sn({id:"editEmbed",undo:k.bind(null,o),redo:k.bind(null,a)}));n.registerCommand(new sn({id:"editMap",undo:P.bind(null,o),redo:P.bind(null,a)}));n.registerCommand(new sn({id:"editImage",undo:j.bind(null,o),redo:j.bind(null,a)}));n.registerCommand(new sn({id:"editIcon",undo:I.bind(null,o),redo:I.bind(null,a)}));n.registerCommand(new sn({id:"editLink",undo:O.bind(null,o),redo:O.bind(null,a)}));n.registerCommand(new sn({id:"sortBlock",undo:M.bind(null,o),redo:M.bind(null,a)}));n.registerCommand(new sn({id:"addBlock",undo:A.bind(null,o),redo:V.bind(null,a)}));n.registerCommand(new sn({id:"removeBlock",undo:V.bind(null,o),redo:A.bind(null,a)}));n.registerCommand(new sn({id:"updateStyle",undo:en.bind(null,o),redo:en.bind(null,a)}));n.registerCommand(new sn({id:"addCard",undo:Z.bind(null,o),redo:J.bind(null,a)}));n.registerCommand(new sn({id:"removeCard",undo:J.bind(null,o),redo:Z.bind(null,a)}));n.registerCommand(new sn({id:"updateBlockState",undo:an.bind(null,o),redo:an.bind(null,a)}));return Promise.resolve(n)}var ln=new Worker("/bitrix/js/landing/history/src/worker/json-parse-worker.js");function un(n){return new Promise(function(e){ln.postMessage(n);ln.addEventListener("message",function(n){e(n.data)})})}var dn=new Worker("/bitrix/js/landing/history/src/worker/json-stringify-worker.js");function hn(n){return new Promise(function(e){dn.postMessage(n);dn.addEventListener("message",function(n){e(n.data)})})}function gn(n,t){return un(window.localStorage.history).then(function(n){return e.Type.isPlainObject(n)?n:{}}).then(function(e){if(n in e){delete e[n]}return e}).then(hn).then(function(n){window.localStorage.history=n;return t})}function fn(n){var t;try{t=i.Main.getInstance().id}catch(n){t=-1}return un(window.localStorage.history).then(function(n){if(e.Type.isPlainObject(n)&&t in n){return n[t]}return Promise.reject()}).then(function(t){Object.keys(t.stack).forEach(function(e,i){n.stack.push(new BX.Landing.History.Entry(t.stack[e]));if(i>=u){n.stack.shift()}});n.position=Math.min(e.Text.toNumber(t.position),n.stack.length-1);n.state=t.state;return n}).catch(function(){return n})}function mn(n){var t;try{t=i.Main.getInstance().id}catch(n){t=-1}return un(window.localStorage.history).then(function(n){return e.Type.isPlainObject(n)?n:{}}).then(function(e){e[t]={};e[t].stack=n.stack;e[t].position=n.position;e[t].state=n.state;return e}).then(hn).then(function(e){window.localStorage.history=e;return n})}function bn(n){var e={blocks:[],images:[]};n.forEach(function(n){if(n.command==="addBlock"){e.blocks.push(n.block)}if(n.command==="editImage"){e.images.push({block:n.block,id:n.redo.id})}});return Promise.resolve(e)}function vn(n,e){return Promise.resolve(e)}function kn(n,e){if(n.commandState===l){return Promise.resolve(n)}var t=n.position+e;var i=n.state;if(e<0&&n.state!==o){t+=1;i=o}if(e>0&&n.state!==a){t-=1;i=a}if(t<=n.stack.length-1&&t>=0){n.position=t;n.state=i;var r=n.stack[t];if(r){var s=n.commands[r.command];if(s){n.commandState=l;return s[i](r).then(function(){n.commandState=c;return n}).catch(function(){n.commandState=c;return n[i===o?"undo":"redo"]()})}}}return Promise.resolve(n)}function Bn(n){n.stack=[];n.position=-1;n.state=s;n.commandState=c;return Promise.resolve(n)}function yn(n){var e=BX.Landing.PageObject.getRootWindow();BX.onCustomEvent(e.window,"BX.Landing.History:update",[n]);return Promise.resolve(n)}function pn(n){var e=BX.Landing.PageObject.getRootWindow();BX.onCustomEvent(e.window,"BX.Landing.History:init",[n]);return Promise.resolve(n)}var Pn=function n(t){babelHelpers.classCallCheck(this,n);this.block=t.block;this.selector=t.selector;this.command=e.Type.isStringFilled(t.command)?t.command:"#invalidCommand";this.undo=t.undo;this.redo=t.redo};var wn=function(n){babelHelpers.inherits(e,n);function e(){var n;babelHelpers.classCallCheck(this,e);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));n.layout.classList.add("landing-ui-highlight-animation");n.animationDuration=300;return n}babelHelpers.createClass(e,[{key:"show",value:function n(e,t){var i=this;BX.Landing.UI.Highlight.prototype.show.call(this,e,t);return new Promise(function(n){setTimeout(n,i.animationDuration);i.hide()})}}],[{key:"getInstance",value:function n(){var i=t.PageObject.getRootWindow();if(!i.BX.Landing.History.Highlight.instance){i.BX.Landing.History.Highlight.instance=new e}return i.BX.Landing.History.Highlight.instance}}]);return e}(r.Highlight);var Ln=function(){function n(){babelHelpers.classCallCheck(this,n);this.stack=[];this.commands={};this.position=-1;this.state=s;this.commandState=c;this.onStorage=this.onStorage.bind(this);e.Event.bind(window,"storage",this.onStorage);cn(this).then(fn).then(mn).then(pn)}babelHelpers.createClass(n,[{key:"undo",value:function n(){if(this.canUndo()){return kn(this,-1).then(mn).then(yn)}return Promise.resolve(this)}},{key:"redo",value:function n(){if(this.canRedo()){return kn(this,1).then(mn).then(yn)}return Promise.resolve(this)}},{key:"canUndo",value:function n(){return this.position>0&&this.state===a||this.position>0&&this.state===o||this.position===0&&this.state!==o}},{key:"canRedo",value:function n(){return this.position<this.stack.length-1&&this.state!==s||this.position!==-1&&this.position===this.stack.length-1&&this.state!==a}},{key:"push",value:function n(e){var t=this.position+1;var i=this.stack.length;if(this.state===o){t-=1}var r=this.stack.splice(t,i,e);if(this.stack.length>u){r.push(this.stack.shift())}if(r.length){void this.onNewBranch(r)}this.position=this.stack.length-1;this.state=a;mn(this).then(yn)}},{key:"registerCommand",value:function n(e){if(e instanceof sn){this.commands[e.id]=e}}},{key:"removePageHistory",value:function n(e){return gn(e,this).then(function(n){var t;try{t=BX.Landing.Main.getInstance().id}catch(n){t=-1}if(t===e){return Bn(n)}return Promise.reject()}).then(yn).catch(function(){})}},{key:"onStorage",value:function n(e){if(e.key===null){if(!window.localStorage.history){Bn(this).then(yn)}}}},{key:"onNewBranch",value:function n(e){var t=this;return bn(e).then(function(n){return vn(n,t)})}}],[{key:"getInstance",value:function n(){var e=t.PageObject.getRootWindow();if(!e.BX.Landing.History.instance){e.BX.Landing.History.instance=new BX.Landing.History}return e.BX.Landing.History.instance}}]);return n}();babelHelpers.defineProperty(Ln,"Command",sn);babelHelpers.defineProperty(Ln,"Entry",Pn);babelHelpers.defineProperty(Ln,"Highlight",wn);babelHelpers.defineProperty(Ln,"Action",{editText:f,editEmbed:k,editMap:P,editImage:j,editIcon:I,editLink:O,sortBlock:M,addBlock:V,removeBlock:A,addCard:J,removeCard:Z,editStyle:en,updateBlockState:an});n.History=Ln})(this.BX.Landing=this.BX.Landing||{},BX,BX.Landing,BX.Landing,BX.Landing.UI);
//# sourceMappingURL=history.bundle.map.js