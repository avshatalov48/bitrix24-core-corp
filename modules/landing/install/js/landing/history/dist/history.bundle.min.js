this.BX=this.BX||{};(function(e,n,t,r,i){"use strict";var o="resolved";var a="pending";var s=BX.Landing.Utils,c=s.scrollTo,d=s.highlight;var u=function e(n){return BX.Landing.PageObject.getInstance().blocks().then((function(t){var r=t.get(n.block);if(!r){return Promise.reject()}r.forceInit();var i=r.nodes.getBySelector(n.selector);if(!i){return Promise.reject()}return c(i.node).then(d.bind(null,i.node,e.useRangeRect)).then((function(){return i.setValue(n.params.value,false,true)}))}))};u.useRangeRect=true;var l=u;var m=u;var h=u;var g=u;g.useRangeRect=false;var f=g;var v=u;v.useRangeRect=false;var p=BX.Landing.Utils,k=p.scrollTo,b=p.highlight;function B(e){return BX.Landing.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);if(!t){return Promise.reject()}t.forceInit();var r=t.nodes.getBySelector(e.selector);if(!r){return Promise.reject()}return k(r.node).then((function(){return b(r.node)})).then((function(){if(r.onChangeTag){r.onChangeTag(e.params.value,true)}return true}))}))}var y=BX.Landing.Utils,P=y.scrollTo,C=y.highlight;function L(e){return BX.Landing.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);t.forceInit();return P(t.node).then(C.bind(null,t.node)).then((function(){return t[e.params.direction](true)}))}))}var w=BX.Landing.Utils,I=w.scrollTo,X=w.highlight;function H(e){return r.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.params.currentBlock);return new Promise((function(e){if(t){t.forceInit()}e()})).then((function(){var n=BX.Landing.Main.getInstance();n.currentBlock=t;return r.PageObject.getInstance().view().then((function(t){n.currentArea=t.contentDocument.body.querySelector('[data-landing="'.concat(e.params.lid,'"]'));n.insertBefore=e.params.insertBefore;return n.onAddBlock(e.params.code,e.block,true).then((function(e){return I(e).then(X.bind(null,e,false,false))}))}))}))}))}var S=BX.Landing.Utils,j=S.scrollTo,E=S.highlight;function T(e){return BX.Landing.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);t.forceInit();return j(t.node).then((function(){E(t.node);return t.deleteBlock(true)}))}))}var O=BX.Landing.Utils,N=O.scrollTo,R=O.highlight;function A(e){return BX.Landing.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);if(t){t.forceInit()}if(!t){return Promise.reject()}var r=t.node.querySelector(e.params.selector).parentNode;return N(r).then((function(){return t.addCard({index:e.params.position,container:r,content:e.params.content,selector:e.params.selector},true).then((function(){var n=e.params.selector+"@"+e.params.position;var r=t.cards.getBySelector(n);if(!r){return Promise.reject()}return R(r.node)}))}))}))["catch"]((function(e){console.log("Error in history action addCard",e)}))}var U=BX.Landing.Utils,D=U.scrollTo,_=U.highlight;function G(e){return BX.Landing.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);t.forceInit();if(!t){return Promise.reject()}var r=e.params.selector+"@"+(e.params.position+1);var i=t.cards.getBySelector(r);if(!i){return Promise.reject()}return D(i.node).then(_.bind(null,i.node)).then((function(){return t.removeCard(r,true)}))}))}function W(e){var n=this;return new Promise((function(t,r){var i=e.params.tags||{};top.BX.onCustomEvent(n,"Landing:onHistoryAddNode",[i]);t()}))}function Y(e){var n=this;return new Promise((function(t,r){var i=e.params.tags||{};top.BX.onCustomEvent(n,"Landing:onHistoryRemoveNode",[i]);t()}))}var x=BX.Landing.Utils,M=x.scrollTo,F=x.slice;function K(e){return BX.Landing.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);if(!t){return Promise.reject()}t.forceInit();t.initStyles();return t})).then((function(e){return M(e.node).then((function(){return e}))})).then((function(n){var t=F(n.node.querySelectorAll(e.selector));if(e.params.isWrapper){t=[n.content];e.selector+=" > :first-child"}t.forEach((function(n,t){if(e.params.position>=0&&e.params.position!==t){return}n.className=e.params.value.className;if(e.params.value.style&&e.params.value.style!==""){n.style=e.params.value.style}else{n.removeAttribute("style")}}));return n})).then((function(n){var t=n.forms.find((function(n){return n.selector===e.selector||n.relativeSelector===e.selector}));if(t){t.fields.forEach((function(e){e.reset();e.onFrameLoad()}))}var r=n.styles.find((function(n){return n.selector===e.selector||n.relativeSelector===e.selector}));if(r){if(e.params.affect&&e.params.affect.length>0){r.setAffects(e.params.affect)}n.onStyleInputWithDebounce({node:r.node,data:r.getValue()},true)}}))}var q=BX.Landing.Utils,V=q.scrollTo,z=q.highlight;function J(e){return r.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);return new Promise((function(e,n){if(t){t.forceInit();e(t)}else{n()}})).then((function(n){return V(n.node).then((function(){return n.applyAttributeChanges(babelHelpers.defineProperty({},e.params.selector,{attrs:babelHelpers.defineProperty({},e.params.attribute,e.params.value)}))})).then(z.bind(null,n.node,false,false))}))}))}var Q=BX.Landing.Utils,Z=Q.scrollTo,$=Q.highlight;function ee(e){return BX.Landing.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);t.forceInit();return Z(t.node).then((function(){void $(t.node);return t.updateContent(e.params.content,true)}))}))}var ne=BX.Landing.Utils,te=ne.scrollTo,re=ne.highlight;function ie(e){var n=null;var t={};e.params.forEach((function(e){if(!n&&e.params.block){n=e.params.block}if(e.command==="editText"||e.command==="editImage"||e.command==="editEmbed"||e.command==="editMap"||e.command==="editIcon"||e.command==="editLink"){t[e.params.selector]=e.params.value}if(e.command==="updateDynamic"){t.dynamicParams=e.params.dynamicParams;t.dynamicState=e.params.dynamicState}if(e.command==="changeAnchor"){t.settings={id:e.params.value}}}));return BX.Landing.PageObject.getInstance().blocks().then((function(e){var r=e.get(n);if(r){r.forceInit();return te(r.node).then((function(){void re(r.node);if(Object.keys(t).length>0){r.updateBlockState(t,true)}}))}}))}var oe=BX.Landing.Utils,ae=oe.scrollTo,se=oe.highlight;function ce(e){return new Promise((function(e,n){top.window.location.reload();e()}))}var de=BX.Landing.Utils,ue=de.scrollTo,le=de.highlight;function me(e){return r.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.params.currentBlock);return new Promise((function(e,n){if(t){t.forceInit();e(t)}else{n()}})).then((function(e){ue(e).then(le.bind(null,e,false,false))}))}))}var he=function e(n){babelHelpers.classCallCheck(this,e);this.id=t.Type.isStringFilled(n.id)?n.id:"#invalidCommand";this.command=t.Type.isFunction(n.command)?n.command:function(){};this.onBeforeCommand=t.Type.isFunction(n.onBeforeCommand)?n.onBeforeCommand:function(){return Promise.resolve()}};var ge;function fe(e){e.registerCommand(new he({id:"editText",command:l}));e.registerCommand(new he({id:"editImage",command:g}));e.registerCommand(new he({id:"editEmbed",command:m}));e.registerCommand(new he({id:"editMap",command:h}));e.registerCommand(new he({id:"editIcon",command:f}));e.registerCommand(new he({id:"editLink",command:v}));e.registerCommand(new he({id:"cnangeNodeName",command:B}));e.registerCommand(new he({id:"sortBlock",command:L}));e.registerCommand(new he({id:"addBlock",command:H}));e.registerCommand(new he({id:"removeBlock",command:T}));e.registerCommand(new he({id:"updateStyle",command:K}));e.registerCommand(new he({id:"addCard",command:A}));e.registerCommand(new he({id:"removeCard",command:G}));e.registerCommand(new he({id:"addNode",command:W}));e.registerCommand(new he({id:"removeNode",command:Y}));e.registerCommand(new he({id:"updateContent",command:ee}));e.registerCommand(new he({id:"replaceLanding",command:ce,onBeforeCommand:function e(){return t.Runtime.loadExtension("main.loader").then((function(){var e=BX.Landing.PageObject.getEditorWindow();if(e){var n=t.Tag.render(ge||(ge=babelHelpers.taggedTemplateLiteral(['<div class="landing-ui-modal"></div>'])));t.Dom.append(n,e.document.body);var r=new BX.Loader({target:n});r.show()}return Promise.resolve()}))}}));e.registerCommand(new he({id:"changeAnchor",command:me}));e.registerCommand(new he({id:"editAttributes",command:J}));e.registerCommand(new he({id:"multiply",command:ie}));return Promise.resolve(e)}var ve=new Worker("/bitrix/js/landing/history/src/worker/json-parse-worker.js");function pe(e){return new Promise((function(n){ve.postMessage(e);ve.addEventListener("message",(function(e){n(e.data)}))}))}var ke=new Worker("/bitrix/js/landing/history/src/worker/json-stringify-worker.js");function be(e){return new Promise((function(n){ke.postMessage(e);ke.addEventListener("message",(function(e){n(e.data)}))}))}function Be(e,n){return pe(window.localStorage.history).then((function(e){return t.Type.isPlainObject(e)?e:{}})).then((function(n){if(e in n){delete n[e]}return n})).then(be).then((function(e){window.localStorage.history=e;return n}))}function ye(e){return BX.Landing.Backend.getInstance().action(e.getLoadBackendActionName(),e.getLoadBackendParams()).then((function(n){e.stack=t.Type.isObject(n.stack)?n.stack:{};e.stackCount=t.Text.toNumber(n.stackCount);e.step=Math.min(t.Text.toNumber(n.step),e.stackCount);return e}))["catch"]((function(n){return e}))}function Pe(e){e.stack={};e.stackCount=0;e.step=0;e.commandState=o;return Promise.resolve(e)}function Ce(e){var n=BX.Landing.PageObject.getRootWindow();BX.onCustomEvent(n.window,"BX.Landing.History:update",[e]);return Promise.resolve(e)}function Le(e){var n=BX.Landing.PageObject.getRootWindow();BX.onCustomEvent(n.window,"BX.Landing.History:init",[e]);return Promise.resolve(e)}var we=function e(n){babelHelpers.classCallCheck(this,e);this.block=n.block;this.selector=n.selector;this.command=t.Type.isStringFilled(n.command)?n.command:"#invalidCommand";this.params=n.params};var Ie=function(e){babelHelpers.inherits(n,e);function n(){var e;babelHelpers.classCallCheck(this,n);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this));e.layout.classList.add("landing-ui-highlight-animation");e.animationDuration=300;return e}babelHelpers.createClass(n,[{key:"show",value:function e(n,t){var r=this;BX.Landing.UI.Highlight.prototype.show.call(this,n,t);return new Promise((function(e){setTimeout(e,r.animationDuration);r.hide()}))}}],[{key:"getInstance",value:function e(){var t=r.PageObject.getRootWindow();if(!t.BX.Landing.History.Highlight.instance){t.BX.Landing.History.Highlight.instance=new n}return t.BX.Landing.History.Highlight.instance}}]);return n}(i.Highlight);var Xe=function(){function e(){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"designerBlockId",null);this.type=e.TYPE_LANDING;this.stack={};this.stackCount=0;this.step=0;this.commands={};this.commandState=o;this.onStorage=this.onStorage.bind(this);try{this.landingId=n.Main.getInstance().id}catch(e){this.landingId=-1}t.Event.bind(window,"storage",this.onStorage);fe(this).then(ye).then(Le)}babelHelpers.createClass(e,[{key:"setTypeDesignerBlock",value:function n(t){this.type=e.TYPE_DESIGNER_BLOCK;this.designerBlockId=t;return ye(this)}},{key:"getLoadBackendActionName",value:function n(){if(this.type===e.TYPE_DESIGNER_BLOCK){return"History::getForDesignerBlock"}return"History::getForLanding"}},{key:"getLoadBackendParams",value:function n(){if(this.type===e.TYPE_DESIGNER_BLOCK){return{blockId:this.designerBlockId}}return{lid:this.landingId}}},{key:"getUndoBackendActionName",value:function n(){if(this.type===e.TYPE_DESIGNER_BLOCK){return"History::undoDesignerBlock"}return"History::undoLanding"}},{key:"beforeUndo",value:function e(){var n=this.step;if(this.stack[n]&&this.commands[this.stack[n]]){var t=this.commands[this.stack[n]];return t.onBeforeCommand()}return Promise.resolve()}},{key:"getRedoBackendActionName",value:function n(){if(this.type===e.TYPE_DESIGNER_BLOCK){return"History::redoDesignerBlock"}return"History::redoLanding"}},{key:"beforeRedo",value:function e(){var n=this.step+1;if(this.stack[n]&&this.commands[this.stack[n]]){var t=this.commands[this.stack[n]];return t.onBeforeCommand()}return Promise.resolve()}},{key:"getBackendActionParams",value:function n(){if(this.type===e.TYPE_DESIGNER_BLOCK&&this.designerBlockId){return{blockId:this.designerBlockId}}return{lid:this.landingId}}},{key:"undo",value:function e(){var n=this;if(this.canUndo()){this.commandState=a;return this.beforeUndo().then((function(){return BX.Landing.Backend.getInstance().action(n.getUndoBackendActionName(),n.getBackendActionParams())})).then((function(e){if(e){var t=e.params;var r=new we({block:t.block,selector:t.selector,command:e.command,params:t});return n.runCommand(r,-1)}return Promise.reject()})).then((function(e){return n.offset(-1).then(Ce)}))}return Promise.resolve(this)}},{key:"redo",value:function e(){var n=this;if(this.canRedo()){this.commandState=a;return this.beforeRedo().then((function(){return BX.Landing.Backend.getInstance().action(n.getRedoBackendActionName(),n.getBackendActionParams())})).then((function(e){if(e){var t=e.params;var r=new we({block:t.block,selector:t.selector,command:e.command,params:t});return n.runCommand(r,1)}return Promise.reject()})).then((function(e){return n.offset(1).then(Ce)}))}return Promise.resolve(this)}},{key:"runCommand",value:function e(n,t){var r=this;if(n){var i=this.commands[n.command];if(i){this.commandState=a;return i.command(n).then((function(){r.commandState=o;return r}))["catch"]((function(){r.commandState=o;return r}))}}}},{key:"offset",value:function e(n){if(this.commandState===a){return Promise.resolve(this)}var t=this.step+n;if(t>=0&&t<=this.stackCount){this.step=t}return Promise.resolve(this)}},{key:"canUndo",value:function e(){return this.commandState!==a&&this.step>0&&this.stackCount>0&&this.step<=this.stackCount}},{key:"canRedo",value:function e(){return this.commandState!==a&&this.step<this.stackCount&&this.step>=0}},{key:"push",value:function e(){var n=this;if(this.step<this.stackCount){this.stackCount=this.step}this.step++;this.stackCount++;return new Promise((function(e){setTimeout(e,400)})).then((function(){return ye(n)})).then(Ce)}},{key:"registerCommand",value:function e(n){if(n instanceof he){this.commands[n.id]=n}}},{key:"removePageHistory",value:function e(n){return Be(n,this).then((function(e){var t;try{t=BX.Landing.Main.getInstance().id}catch(e){t=-1}if(t===n){return Pe(e)}return Promise.reject()})).then(Ce)["catch"]((function(){}))}},{key:"onStorage",value:function e(n){if(n.key===null){if(!window.localStorage.history){Pe(this).then(Ce)}}}}],[{key:"getInstance",value:function e(){var n=r.PageObject.getRootWindow();if(!n.BX.Landing.History.instance){n.BX.Landing.History.instance=new BX.Landing.History}return n.BX.Landing.History.instance}}]);return e}();babelHelpers.defineProperty(Xe,"TYPE_LANDING","L");babelHelpers.defineProperty(Xe,"TYPE_DESIGNER_BLOCK","D");babelHelpers.defineProperty(Xe,"Command",he);babelHelpers.defineProperty(Xe,"Entry",we);babelHelpers.defineProperty(Xe,"Highlight",Ie);e.History=Xe})(this.BX.Landing=this.BX.Landing||{},BX.Landing,BX,BX.Landing,BX.Landing.UI);
//# sourceMappingURL=history.bundle.map.js