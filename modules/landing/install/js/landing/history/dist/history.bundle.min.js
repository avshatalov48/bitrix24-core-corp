this.BX=this.BX||{};(function(n,e,t,i,r){"use strict";var o="undo";var a="redo";var s="init";var c="resolved";var l="pending";var u=100;var d=BX.Landing.Utils,h=d.scrollTo,g=d.highlight;function f(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(t){var i=t.get(e.block);if(!i){return Promise.reject()}i.forceInit();var r=i.nodes.getBySelector(e.selector);if(!r){return Promise.reject()}return h(r.node).then(g.bind(null,r.node,true)).then(function(){return r.setValue(e[n],false,true)})})}var m=BX.Landing.Utils,b=m.scrollTo,v=m.highlight;function k(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(t){var i=t.get(e.block);if(!i){return Promise.reject()}i.forceInit();var r=i.nodes.getBySelector(e.selector);if(!r){return Promise.reject()}return b(r.node).then(v.bind(null,r.node,true)).then(function(){return r.setValue(e[n],false,true)})})}var B=BX.Landing.Utils,y=B.scrollTo,p=B.highlight;function P(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(t){var i=t.get(e.block);if(!i){return Promise.reject()}i.forceInit();var r=i.nodes.getBySelector(e.selector);if(!r){return Promise.reject()}return y(r.node).then(p.bind(null,r.node,true)).then(function(){return r.setValue(e[n],false,true)})})}var w=BX.Landing.Utils,L=w.scrollTo,X=w.highlight;function j(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(t){var i=t.get(e.block);if(!i){return Promise.reject()}i.forceInit();var r=i.nodes.getBySelector(e.selector);if(!r){return Promise.reject()}return L(r.node).then(X.bind(null,r.node)).then(function(){e[n].id=0;return r.setValue(e[n],false,true)})})}var C=j;var I=BX.Landing.Utils,S=I.scrollTo,H=I.highlight;function O(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(t){var i=t.get(e.block);if(!i){return Promise.reject()}i.forceInit();var r=i.nodes.getBySelector(e.selector);if(!r){return Promise.reject()}return S(r.node).then(H.bind(null,r.node)).then(function(){return r.setValue(e[n],false,true)})})}var T=BX.Landing.Utils,U=T.scrollTo,E=T.highlight;function N(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(t){var i=t.get(e.block);i.forceInit();return U(i.node).then(E.bind(null,i.node)).then(function(){return i[e[n]](true)})})}var M=BX.Landing.Utils,R=M.scrollTo,x=M.highlight;function W(n,e){return i.PageObject.getInstance().blocks().then(function(t){var r=t.get(e[n].currentBlock);return new Promise(function(n){if(r){r.forceInit();return R(r.node).then(x.bind(null,r.node,false,true)).then(n)}n()}).then(function(){var t=BX.Landing.Main.getInstance();t.currentBlock=r;return i.PageObject.getInstance().view().then(function(i){t.currentArea=i.contentDocument.body.querySelector('[data-landing="'.concat(e[n].lid,'"]'));return t.onAddBlock(e[n].code,e.block,true)})})})}var V=BX.Landing.Utils,A=V.scrollTo,D=V.highlight;function F(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(n){var t=n.get(e.block);t.forceInit();return A(t.node).then(function(){D(t.node);return t.deleteBlock(true)})})}var q=BX.Landing.Utils,z=q.scrollTo,G=q.highlight;function J(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(n){var t=n.get(e.block);if(t){t.forceInit()}if(!t){return Promise.reject()}return t}).then(function(t){return BX.Landing.PageObject.getInstance().view().then(function(i){return[t,i.contentDocument.querySelector(e[n].container)]})}).then(function(n){return z(n[1]).then(function(){return n})}).then(function(t){t[0].addCard({index:e[n].index,container:t[1],content:e[n].html,selector:e.selector});var i=t[0].cards.getBySelector(e.selector);if(!i){return Promise.reject()}return G(i.node)}).catch(function(){})}var K=BX.Landing.Utils,Q=K.scrollTo,Y=K.highlight;function Z(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(n){var t=n.get(e.block);t.forceInit();if(!t){return Promise.reject()}var i=t.cards.getBySelector(e.selector);if(!i){return Promise.reject()}return Q(i.node).then(Y.bind(null,i.node)).then(function(){return t.removeCard(e.selector,true)})})}function $(n,e){var t=this;return new Promise(function(n,i){var r=(e.redo||{}).tags||(e.undo||{}).tags||[];top.BX.onCustomEvent(t,"Landing:onHistoryAddNode",[r]);n()})}function _(n,e){var t=this;return new Promise(function(n,i){var r=(e.redo||{}).tags||(e.undo||{}).tags||[];top.BX.onCustomEvent(t,"Landing:onHistoryRemoveNode",[r]);n()})}var nn=BX.Landing.Utils,en=nn.scrollTo,tn=nn.slice;function rn(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(n){var t=n.get(e.block);if(!t){return Promise.reject()}t.forceInit();t.initStyles();return t}).then(function(n){return en(n.node).then(function(){return n})}).then(function(t){var i=tn(t.node.querySelectorAll(e.selector));if(t.selector===e.selector){i=[t.content]}i.forEach(function(t){t.className=e[n].className;t.style=e[n].style});return t}).then(function(n){var t=n.forms.find(function(n){return n.selector===e.selector||n.relativeSelector===e.selector});if(t){t.fields.forEach(function(n){n.reset();n.onFrameLoad()})}var i=n.styles.find(function(n){return n.selector===e.selector||n.relativeSelector===e.selector});if(i){n.onStyleInputWithDebounce({node:i.node,data:i.getValue()})}})}var on=BX.Landing.Utils,an=on.scrollTo,sn=on.highlight;function cn(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(t){var i=t.get(e.block);i.forceInit();return an(i.node).then(function(){void sn(i.node);i.updateBlockState(BX.clone(e[n]),true)})})}var ln=BX.Landing.Utils,un=ln.scrollTo,dn=ln.highlight;function hn(n,e){return BX.Landing.PageObject.getInstance().blocks().then(function(t){var i=t.get(e.block);i.forceInit();return un(i.node).then(function(){void dn(i.node);return i.updateContent(e[n])})})}var gn=function n(e){babelHelpers.classCallCheck(this,n);this.id=t.Type.isStringFilled(e.id)?e.id:"#invalidCommand";this.undo=t.Type.isFunction(e.undo)?e.undo:function(){};this.redo=t.Type.isFunction(e.redo)?e.redo:function(){}};function fn(n){n.registerCommand(new gn({id:"editText",undo:f.bind(null,o),redo:f.bind(null,a)}));n.registerCommand(new gn({id:"editEmbed",undo:k.bind(null,o),redo:k.bind(null,a)}));n.registerCommand(new gn({id:"editMap",undo:P.bind(null,o),redo:P.bind(null,a)}));n.registerCommand(new gn({id:"editImage",undo:j.bind(null,o),redo:j.bind(null,a)}));n.registerCommand(new gn({id:"editIcon",undo:C.bind(null,o),redo:C.bind(null,a)}));n.registerCommand(new gn({id:"editLink",undo:O.bind(null,o),redo:O.bind(null,a)}));n.registerCommand(new gn({id:"sortBlock",undo:N.bind(null,o),redo:N.bind(null,a)}));n.registerCommand(new gn({id:"addBlock",undo:F.bind(null,o),redo:W.bind(null,a)}));n.registerCommand(new gn({id:"removeBlock",undo:W.bind(null,o),redo:F.bind(null,a)}));n.registerCommand(new gn({id:"updateStyle",undo:rn.bind(null,o),redo:rn.bind(null,a)}));n.registerCommand(new gn({id:"addCard",undo:Z.bind(null,o),redo:J.bind(null,a)}));n.registerCommand(new gn({id:"removeCard",undo:J.bind(null,o),redo:Z.bind(null,a)}));n.registerCommand(new gn({id:"addNode",undo:_.bind(null,o),redo:$.bind(null,a)}));n.registerCommand(new gn({id:"removeNode",undo:$.bind(null,o),redo:_.bind(null,a)}));n.registerCommand(new gn({id:"updateBlockState",undo:cn.bind(null,o),redo:cn.bind(null,a)}));n.registerCommand(new gn({id:"updateContent",undo:hn.bind(null,o),redo:hn.bind(null,a)}));return Promise.resolve(n)}var mn=new Worker("/bitrix/js/landing/history/src/worker/json-parse-worker.js");function bn(n){return new Promise(function(e){mn.postMessage(n);mn.addEventListener("message",function(n){e(n.data)})})}var vn=new Worker("/bitrix/js/landing/history/src/worker/json-stringify-worker.js");function kn(n){return new Promise(function(e){vn.postMessage(n);vn.addEventListener("message",function(n){e(n.data)})})}function Bn(n,e){return bn(window.localStorage.history).then(function(n){return t.Type.isPlainObject(n)?n:{}}).then(function(e){if(n in e){delete e[n]}return e}).then(kn).then(function(n){window.localStorage.history=n;return e})}function yn(n){var i;try{i=e.Main.getInstance().id}catch(n){i=-1}return bn(window.localStorage.history).then(function(n){if(t.Type.isPlainObject(n)&&i in n){return n[i]}return Promise.reject()}).then(function(e){Object.keys(e.stack).forEach(function(t,i){n.stack.push(new BX.Landing.History.Entry(e.stack[t]));if(i>=u){n.stack.shift()}});n.position=Math.min(t.Text.toNumber(e.position),n.stack.length-1);n.state=e.state;return n}).catch(function(){return n})}function pn(n){var i;try{i=e.Main.getInstance().id}catch(n){i=-1}return bn(window.localStorage.history).then(function(n){return t.Type.isPlainObject(n)?n:{}}).then(function(e){e[i]={};e[i].stack=n.stack;e[i].position=n.position;e[i].state=n.state;return e}).then(kn).then(function(e){window.localStorage.history=e;return n})}function Pn(n){var e={blocks:[],images:[]};n.forEach(function(n){if(n.command==="addBlock"){e.blocks.push(n.block)}if(n.command==="editImage"){e.images.push({block:n.block,id:n.redo.id})}});return Promise.resolve(e)}function wn(n,e){return Promise.resolve(e)}function Ln(n,e){if(n.commandState===l){return Promise.resolve(n)}var t=n.position+e;var i=n.state;if(e<0&&n.state!==o){t+=1;i=o}if(e>0&&n.state!==a){t-=1;i=a}if(t<=n.stack.length-1&&t>=0){n.position=t;n.state=i;var r=n.stack[t];if(r){var s=n.commands[r.command];if(s){n.commandState=l;return s[i](r).then(function(){n.commandState=c;return n}).catch(function(){n.commandState=c;return Ln(n,e)})}}}return Promise.resolve(n)}function Xn(n){n.stack=[];n.position=-1;n.state=s;n.commandState=c;return Promise.resolve(n)}function jn(n){var e=BX.Landing.PageObject.getRootWindow();BX.onCustomEvent(e.window,"BX.Landing.History:update",[n]);return Promise.resolve(n)}function Cn(n){var e=BX.Landing.PageObject.getRootWindow();BX.onCustomEvent(e.window,"BX.Landing.History:init",[n]);return Promise.resolve(n)}var In=function n(e){babelHelpers.classCallCheck(this,n);this.block=e.block;this.selector=e.selector;this.command=t.Type.isStringFilled(e.command)?e.command:"#invalidCommand";this.undo=e.undo;this.redo=e.redo};var Sn=function(n){babelHelpers.inherits(e,n);function e(){var n;babelHelpers.classCallCheck(this,e);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));n.layout.classList.add("landing-ui-highlight-animation");n.animationDuration=300;return n}babelHelpers.createClass(e,[{key:"show",value:function n(e,t){var i=this;BX.Landing.UI.Highlight.prototype.show.call(this,e,t);return new Promise(function(n){setTimeout(n,i.animationDuration);i.hide()})}}],[{key:"getInstance",value:function n(){var t=i.PageObject.getRootWindow();if(!t.BX.Landing.History.Highlight.instance){t.BX.Landing.History.Highlight.instance=new e}return t.BX.Landing.History.Highlight.instance}}]);return e}(r.Highlight);var Hn=function(){function n(){babelHelpers.classCallCheck(this,n);this.stack=[];this.commands={};this.position=-1;this.state=s;this.commandState=c;this.onStorage=this.onStorage.bind(this);t.Event.bind(window,"storage",this.onStorage);fn(this).then(yn).then(pn).then(Cn)}babelHelpers.createClass(n,[{key:"undo",value:function n(){if(this.canUndo()){return Ln(this,-1).then(pn).then(jn)}return Promise.resolve(this)}},{key:"redo",value:function n(){if(this.canRedo()){return Ln(this,1).then(pn).then(jn)}return Promise.resolve(this)}},{key:"canUndo",value:function n(){return this.position>0&&this.state===a||this.position>0&&this.state===o||this.position===0&&this.state!==o}},{key:"canRedo",value:function n(){return this.position<this.stack.length-1&&this.state!==s||this.position!==-1&&this.position===this.stack.length-1&&this.state!==a}},{key:"push",value:function n(e){var t=this.position+1;var i=this.stack.length;if(this.state===o){t-=1}var r=this.stack.splice(t,i,e);if(this.stack.length>u){r.push(this.stack.shift())}if(r.length){void this.onNewBranch(r)}this.position=this.stack.length-1;this.state=a;pn(this).then(jn)}},{key:"registerCommand",value:function n(e){if(e instanceof gn){this.commands[e.id]=e}}},{key:"removePageHistory",value:function n(e){return Bn(e,this).then(function(n){var t;try{t=BX.Landing.Main.getInstance().id}catch(n){t=-1}if(t===e){return Xn(n)}return Promise.reject()}).then(jn).catch(function(){})}},{key:"onStorage",value:function n(e){if(e.key===null){if(!window.localStorage.history){Xn(this).then(jn)}}}},{key:"onNewBranch",value:function n(e){var t=this;return Pn(e,this).then(function(n){return wn(n,t)})}}],[{key:"getInstance",value:function n(){var e=i.PageObject.getRootWindow();if(!e.BX.Landing.History.instance){e.BX.Landing.History.instance=new BX.Landing.History}return e.BX.Landing.History.instance}}]);return n}();babelHelpers.defineProperty(Hn,"Command",gn);babelHelpers.defineProperty(Hn,"Entry",In);babelHelpers.defineProperty(Hn,"Highlight",Sn);babelHelpers.defineProperty(Hn,"Action",{editText:f,editEmbed:k,editMap:P,editImage:j,editIcon:C,editLink:O,sortBlock:N,addBlock:W,removeBlock:F,addCard:J,removeCard:Z,editStyle:rn,updateBlockState:cn,addNode:$,removeNode:_,updateContent:hn});n.History=Hn})(this.BX.Landing=this.BX.Landing||{},BX.Landing,BX,BX.Landing,BX.Landing.UI);
//# sourceMappingURL=history.bundle.map.js