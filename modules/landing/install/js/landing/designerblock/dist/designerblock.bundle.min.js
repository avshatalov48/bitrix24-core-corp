this.BX=this.BX||{};(function(e,t,n,r,i,a,o){"use strict";var l=function(){function e(t){babelHelpers.classCallCheck(this,e);this.element=t.element;this.selector=t.selector;this.cardSelector=t.cardSelector;this.onHover=t.onHover;this.pseudoElement=o.Dom.hasClass(this.element,"landing-designer-block-pseudo-last");o.Event.bind(this.element,"mouseover",this.onMouseOver.bind(this));if(t.className){o.Dom.addClass(this.element,t.className)}}babelHelpers.createClass(e,[{key:"isPseudoElement",value:function e(){return this.pseudoElement}},{key:"getSelector",value:function e(){return(this.cardSelector?this.cardSelector+" ":"")+this.selector}},{key:"getCardSelector",value:function e(){return this.cardSelector}},{key:"getOriginalSelector",value:function e(){return this.selector}},{key:"getElement",value:function e(){return this.element}},{key:"onMouseOver",value:function e(t){t.stopPropagation();this.onHover(this)}}]);return e}();function s(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="landing-designer-block-node-hover-add">\n\t\t\t\t<span class="landing-designer-block-node-hover-add-title">\n\t\t\t\t\t',"\n\t\t\t\t</span>\n\t\t\t</div>"]);s=function t(){return e};return e}function d(){var e=babelHelpers.taggedTemplateLiteral(['<div class="landing-designer-block-pseudo-last"></div>']);d=function t(){return e};return e}function c(){var e=babelHelpers.taggedTemplateLiteral(['<div class="landing-designer-block-node-hover"></div>']);c=function t(){return e};return e}var u=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"getHoverDiv",value:function e(){return o.Tag.render(c())}},{key:"getPseudoLast",value:function e(){return o.Tag.render(d())}},{key:"getAddNodeButton",value:function e(){return o.Tag.render(s(),i.Loc.getMessage("LANDING_DESIGN_BLOCK_REPO_BUTTON"))}}]);return e}();function h(){var e=babelHelpers.taggedTemplateLiteral(['<div class="landing-ui-field-layer-list-container"></div>']);h=function t(){return e};return e}var v=function(e){babelHelpers.inherits(t,e);function t(e){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,"design_repo",{title:i.Loc.getMessage("LANDING_DESIGN_BLOCK_REPO_TITLE"),scrollAnimation:true}));n.currentCategory=null;n.cache=new o.Cache.MemoryCache;n.onElementSelect=e.onElementSelect;n.renderTo(document.body);o.Dom.addClass(n.layout,"landing-ui-panel-repo");return n}babelHelpers.createClass(t,[{key:"addRepository",value:function e(t){var n=this;t.map(function(e){n.addElement(e)})}},{key:"makeElementUnique",value:function e(t){var n=this;var r={};Object.keys(t.manifest.nodes).map(function(e){var i="-"+n.randomNum(1e3,9999);var a=e.substr(1);t.html=t.html.replaceAll(new RegExp(a+'([\\s"]{1})',"g"),a+i+"$1");r[e+i]=t.manifest.nodes[e]});t.manifest.nodes=r;return t}},{key:"addElement",value:function e(t){var n=this;var r=new BX.Landing.UI.Card.BlockPreviewCard({title:t.name,image:"/bitrix/images/landing/designerblock/presets/"+t.code+".jpg",onClick:function e(){n.onElementSelect(n.makeElementUnique(t));void n.hide()}});this.appendCard(r)}},{key:"randomNum",value:function e(t,n){return parseInt(Math.random()*(n-t)+t)}},{key:"getListContainer",value:function e(){return this.cache.remember("listContainer",function(){return o.Tag.render(h())})}}]);return t}(a.Content);var m=function(){function e(t){babelHelpers.classCallCheck(this,e);this.panel=new v({onElementSelect:t.onElementSelect});this.panel.addRepository(t.repository)}babelHelpers.createClass(e,[{key:"showPanel",value:function e(){this.panel.show().then()}}]);return e}();function p(){var e=babelHelpers.taggedTemplateLiteral(["",""]);p=function t(){return e};return e}function g(){var e=babelHelpers.taggedTemplateLiteral(["<style>","{display: none !important;}</style>"]);g=function t(){return e};return e}function f(){var e=babelHelpers.taggedTemplateLiteral(["",""]);f=function t(){return e};return e}var b=function(){function e(t,i){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"hoverArea",null);babelHelpers.defineProperty(this,"activeNode",null);babelHelpers.defineProperty(this,"changed",false);babelHelpers.defineProperty(this,"saving",false);if(!t){return}this.originalNode=t;this.blockNode=t.children[0];this.blockCode=i.code;this.blockId=i.id;this.designed=i.designed;this.landingId=i.lid;this.nodes=i.manifest.nodes;this.highlight=new r.Highlight;this.cardSelectors=i.manifest.cards?Object.keys(i.manifest.cards):[];this.cardSelectors.push("");this.nodeMap=new WeakMap;this.metrika=new n.Metrika(true);this.repoManager=new m({repository:i.repository,onElementSelect:this.addElement.bind(this)});this.preventEvents();this.initHistoryEvents();this.initTopPanel();this.initNodes();this.initGrid();this.initSliders();this.initHoverArea()}babelHelpers.createClass(e,[{key:"clearHtml",value:function e(t){return t.replace(/<div class="[^"]*landing-designer-block-pseudo-last[^"]*"[^>]*>[\s]*<\/div>/g,"").replace(/\s*data-(landingwrapper)="[^"]+"\s*/g," ").replace(/\s*[\w-_]+--type-wrapper\s*/g," ").replace(/<div[\s]*>[\s]*<\/div>/g,"").replace(/\s*style=""/g,"")}},{key:"preventEvents",value:function e(){var t=this;var n={a:"click",form:"submit",input:"keydown"};Object.keys(n).map(function(e){babelHelpers.toConsumableArray(t.blockNode.querySelectorAll(e)).map(function(t){o.Event.bind(t,n[e],function(e){e.preventDefault()})})})}},{key:"initHistoryEvents",value:function e(){var t=this;var n=this.getDocumentBody();top.BX.addCustomEvent("Landing:onHistoryAddNode",function(e){var r=false;e.map(function(e){var t=e.insertAfterSelector||null;var i=e.parentNodeSelector||null;var a=o.Tag.render(f(),e.elementHtml);if(t){r=true;o.Dom.insertAfter(a,n.querySelector(t))}else if(i){r=true;o.Dom.prepend(a,n.querySelector(i))}});if(r){t.refreshManifest();setTimeout(function(){t.sendLabel("designerBlock","onHistoryAddNode")},0)}});top.BX.addCustomEvent("Landing:onHistoryRemoveNode",function(e){e.map(function(e){t.removeNode(n.querySelector(e.elementSelector))});t.refreshManifest();setTimeout(function(){t.sendLabel("designerBlock","onHistoryRemoveNode")},0)})}},{key:"initTopPanel",value:function e(){var n=this;top.BX.addCustomEvent("Landing:onDesignerBlockSave",function(e){n.highlight.hide();if(!n.changed){return}n.saving=true;setTimeout(function(){t.Backend.getInstance().action("Block::updateContent",{lid:n.landingId,block:n.blockId,content:n.clearHtml(n.originalNode.innerHTML).replaceAll(' style="',' bxstyle="'),designed:1}).then(function(){if(e){n.saving=false;e()}});n.sendLabel("designerBlock","save"+"&designed="+(n.designed?"Y":"N")+"&code="+n.blockCode)},300)})}},{key:"initNodes",value:function e(){var t=this;Object.keys(this.nodes).map(function(e){t.cardSelectors.map(function(n){babelHelpers.toConsumableArray(t.blockNode.querySelectorAll((n?n+" ":"")+e)).map(function(r){if(t.nodes[e]["useInDesigner"]===false){return}t.addNode({element:r,selector:e,cardSelector:n,type:t.nodes[e]["type"]})})})})}},{key:"initGrid",value:function e(){var t=this;Object.keys(this.nodes).map(function(e){t.cardSelectors.map(function(n){babelHelpers.toConsumableArray(t.blockNode.querySelectorAll((n?n+" ":"")+e)).map(function(r){if(t.nodes[e]["useInDesigner"]===false){return}var i=t.nodes[e]["type"]==="icon"?r.parentNode.parentNode:r.parentNode;if(o.Dom.attr(i,"data-landingWrapper")){return}var a=u.getPseudoLast();o.Dom.attr(i,"data-landingWrapper",true);o.Dom.append(a,i);t.addNode({cardSelector:n,element:a,className:e.substr(1)+"-last",selector:e+"-last"})})})})}},{key:"initSliders",value:function e(){var t=".js-carousel";babelHelpers.toConsumableArray(this.blockNode.querySelectorAll(t)).map(function(e){var t=(o.Text.toNumber(e.dataset.slidesShow)||1)*(o.Text.toNumber(e.dataset.rows)||1);var n=".".concat(babelHelpers.toConsumableArray(e.classList).join(".")," .js-slide:not(:nth-child(-n+").concat(t,"))");document.head.appendChild(o.Tag.render(g(),n))})}},{key:"initHoverArea",value:function e(){var t=this;if(this.hoverArea){return}this.hoverArea=u.getHoverDiv();var n=u.getAddNodeButton();var r=BX.Landing.UI.Button.CardAction;var i=BX.Landing.UI.Panel.BaseButtonPanel;var a=new i("nodeAction","landing-ui-panel-block-card-action");o.Event.bind(n,"click",function(){t.repoManager.showPanel();t.hideHoverArea()});a.addButton(new r("remove",{html:"&nbsp;",onClick:this.removeElement.bind(this)}));void a.show();o.Dom.append(n,this.hoverArea);o.Dom.append(a.layout,this.hoverArea);o.Dom.append(this.hoverArea,this.getDocumentBody());o.Event.bind(this.blockNode,"mouseover",function(){t.hideHoverArea()})}},{key:"adjustHoverArea",value:function e(){if(!this.hoverArea){return}this.showHoverArea();var t=this.activeNode.getElement().getBoundingClientRect();var n=this.hoverArea.querySelector(".landing-designer-block-node-hover-add");var r=this.hoverArea.querySelector('div[data-id="nodeAction"]');var i=BX.Landing.PageObject.getEditorWindow();if(r){if(this.activeNode.isPseudoElement()){o.Dom.hide(r)}else{o.Dom.show(r)}}if(n){o.Dom.style(n,{top:t.height-5+"px"})}o.Dom.style(this.hoverArea,{top:t.top+i.scrollY+"px",left:t.left+(t.width<30?30:0)+"px",width:t.width+"px",height:"35px"})}},{key:"showHoverArea",value:function e(){if(this.hoverArea){o.Dom.show(this.hoverArea)}}},{key:"hideHoverArea",value:function e(){var t=this;if(this.hoverArea){setTimeout(function(){o.Dom.hide(t.hoverArea)},0)}}},{key:"refreshManifest",value:function e(t){var n=this;if(t){Object.keys(t).map(function(e){n.nodes[e]=t[e]})}this.initNodes();this.initGrid()}},{key:"getDocumentBody",value:function e(){return document.body}},{key:"isInsideElement",value:function e(t){return t.parentElement.tagName==="A"}},{key:"sendLabel",value:function e(t,n){this.metrika.clearSendedLabel();this.metrika.sendLabel(null,t,n)}},{key:"addElement",value:function e(t){var n=this;var r=this.activeNode;var i=[];babelHelpers.toConsumableArray(document.body.querySelectorAll(r.getSelector())).map(function(e){var r=t.html;var a=o.Tag.render(p(),r);var l=n.isInsideElement(e)?e.parentNode:e;o.Dom.insertAfter(a,l);i.push({elementHtml:r,elementSelector:BX.Landing.Utils.getCSSSelector(a),insertAfterSelector:BX.Landing.Utils.getCSSSelector(l)})});this.sendLabel("designerBlock","addElement"+"&code="+this.blockCode+"&name="+t.code+"&preset="+(Object.keys(t.manifest.nodes).length===1?"N":"Y"));this.changed=true;this.refreshManifest(t.manifest.nodes);this.highlight.show(null);BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({command:"addNode",block:null,undo:null,redo:{tags:i}}))}},{key:"removeElement",value:function e(){var t=this;var n=[];this.hideHoverArea();this.highlight.hide();setTimeout(function(){t.sendLabel("designerBlock","removeElement"+"&tagName="+t.activeNode.getElement().tagName+"&code="+t.blockCode);babelHelpers.toConsumableArray(document.body.querySelectorAll(t.activeNode.getSelector())).map(function(e){n.push({elementHtml:t.clearHtml(e.outerHTML),elementSelector:BX.Landing.Utils.getCSSSelector(e),insertAfterSelector:e.previousElementSibling?BX.Landing.Utils.getCSSSelector(e.previousElementSibling):null,parentNodeSelector:BX.Landing.Utils.getCSSSelector(e.parentNode)});t.removeNode(e)});t.changed=true;t.refreshManifest();BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({selector:t.activeNode.getOriginalSelector(),command:"removeNode",block:null,undo:{tags:n},redo:null}))},0)}},{key:"typeWithWrapper",value:function e(t){return t==="icon"||t==="embed"}},{key:"addNode",value:function e(t){if(!this.nodeMap.get(t.element)){if(t.selector.match(/^\.[\w-_]+$/i)===null){return false}var n=this.typeWithWrapper(t.type);t.element=n?t.element.parentNode:t.element;if(n){t.selector=t.selector+"--type-wrapper";o.Dom.addClass(t.element,t.selector.substr(1))}t.onHover=this.onMouseOver.bind(this);this.nodeMap.set(t.element,new l(t));return true}return false}},{key:"removeNode",value:function e(t){if(t){o.Dom.remove(t);this.nodeMap.delete(t)}}},{key:"onMouseOver",value:function e(t){if(this.saving){return}this.activeNode=t;this.adjustHoverArea();if(!t.isPseudoElement()){this.highlight.show(t.getElement())}}}]);return e}();e.DesignerBlock=b})(this.BX.Landing=this.BX.Landing||{},BX.Landing,BX.Landing,BX.Landing.UI,BX.Landing,BX.Landing.UI.Panel,BX);
//# sourceMappingURL=designerblock.bundle.map.js