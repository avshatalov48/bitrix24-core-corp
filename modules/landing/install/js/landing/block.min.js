(function(){"use strict";BX.namespace("BX.Landing");var t=BX.Landing.Utils.deepFreeze;var e=BX.Landing.Utils.style;var n=BX.Landing.Utils.insertAfter;var i=BX.Landing.Utils.insertBefore;var a=BX.Landing.Utils.append;var s=BX.Landing.Utils.isPlainObject;var o=BX.Landing.Utils.isBoolean;var r=BX.Landing.Utils.isNumber;var c=BX.Landing.Utils.isString;var d=BX.Landing.Utils.isArray;var l=BX.Landing.Utils.isEmpty;var h=BX.Landing.Utils.addClass;var u=BX.Landing.Utils.removeClass;var g=BX.Landing.Utils.hasClass;var f=BX.Landing.Utils.toggleClass;var m=BX.Landing.Utils.create;var p=BX.Landing.Utils.debounce;var B=BX.Landing.Utils.throttle;var v=BX.Landing.Utils.fireCustomEvent;var L=BX.Landing.Utils.onCustomEvent;var y=BX.Landing.Utils.bind;var b=BX.Landing.Utils.unbind;var C=BX.Landing.Utils.getClass;var k=BX.Landing.Utils.rect;var I=BX.Landing.Utils.setTextContent;var X=BX.Landing.Utils.translateY;var E=BX.Landing.Utils.nextSibling;var _=BX.Landing.Utils.prevSibling;var A=BX.Landing.Utils.join;var T=BX.Landing.Utils.slice;var N=BX.Landing.Utils.decodeDataValue;var O=BX.Landing.Utils.encodeDataValue;var S=BX.Landing.Utils.data;var w=BX.Landing.Utils.attr;var M=BX.Landing.Utils.removePanels;var P=BX.Landing.Utils.getCSSSelector;var D=BX.Landing.Utils.remove;var F=BX.Landing.Utils.clone;var U=BX.Landing.Utils.trim;var j=BX.Landing.Utils.prepend;var x=BX.Landing.Utils.random;var R=BX.Landing.Utils.htmlToElement;var V=BX.Landing.Utils.proxy;var G=BX.Landing.Utils.escapeText;var K=BX.Landing.Utils.isValidElementId;var H=BX.Landing.Collection.BaseCollection;var q=BX.Landing.Collection.NodeCollection;var Y=BX.Landing.UI.Collection.FormCollection;var z=BX.Landing.Collection.CardCollection;var W=BX.Landing.UI.Collection.PanelCollection;var J=BX.Landing.UI.Panel.BaseButtonPanel;var Q=BX.Landing.UI.Panel.CardAction;var Z=BX.Landing.UI.Panel.ContentEdit;var $=BX.Landing.UI.Button.BaseButton;var tt=BX.Landing.UI.Button.Action;var et=BX.Landing.UI.Button.Plus;var nt=BX.Landing.UI.Button.CardAction;var it=BX.Landing.UI.Factory.StyleFactory;var at=BX.Landing.UI.Form.BaseForm;var st=BX.Landing.UI.Form.StyleForm;var ot=BX.Landing.UI.Form.CardForm;var rt=BX.Landing.UI.Form.CardsForm;var ct=BX.Landing.Group;var dt=BX.Landing.Event.Block;var lt=BX.Landing.UI.Card.TabCard;var ht=BX.Landing.UI.Tool.Menu;var ut=BX.Landing.UI.Card.DynamicFieldsGroup;var gt="D";var ft="V";var mt="W";var pt="X";function Bt(t){var e=BX.Landing.Main.getInstance();return e.options.style["bitrix"]["style"][t]}function vt(t){var e=BX.Landing.Main.getInstance();return t in e.options.style["bitrix"]["group"]}function Lt(t){var e=BX.Landing.Main.getInstance();return e.options.style["bitrix"]["group"][t]}function yt(t){if(!!t){if(!t.loader){t.loader=new BX.Loader({target:t.layout,size:16});void e(t.loader.layout.querySelector(".main-ui-loader-svg-circle"),{"stroke-width":"4px"})}t.loader.show();h(t.text,"landing-ui-hide-icon")}}function bt(t){if(!!t){if(t.loader){t.loader.hide();u(t.text,"landing-ui-hide-icon")}}}function Ct(t){return!!t&&t.includes("@")}BX.Landing.Block=function(e,n){this.node=e;this.parent=e.parentElement;this.content=e.firstElementChild;this.siteId=S(e.parentElement,"data-site");this.lid=S(e.parentElement,"data-landing");this.id=r(parseInt(n.id))?parseInt(n.id):0;this.selector=A("#block",r(n.id)?n.id:0," > :first-child");this.active=o(n.active)?n.active:true;this.manifest=s(n.manifest)?n.manifest:{};this.manifest.nodes=s(n.manifest.nodes)?n.manifest.nodes:{};this.manifest.cards=s(n.manifest.cards)?n.manifest.cards:{};this.manifest.attrs=s(n.manifest.attrs)?n.manifest.attrs:{};this.onStyleInputWithDebounce=p(this.onStyleInput,300,this);this.changeTimeout=null;this.access=n.access;this.anchor=n.anchor;this.requiredUserActionOptions=n.requiredUserAction;this.dynamicParams=n.dynamicParams||{};this.nodes=new q;this.cards=new z;this.panels=new W;this.groups=new H;this.changedNodes=new H;this.styles=new H;this.forms=new Y;if(s(this.requiredUserActionOptions)&&!l(this.requiredUserActionOptions)){this.showRequiredUserAction(this.requiredUserActionOptions);this.requiredUserActionIsShown=true}this.onEditorEnabled=this.onEditorEnabled.bind(this);this.onEditorDisabled=this.onEditorDisabled.bind(this);this.adjustPanelsPosition=this.adjustPanelsPosition.bind(this);this.onMouseMove=this.onMouseMove.bind(this);this.onStorage=this.onStorage.bind(this);this.onBlockRemove=this.onBlockRemove.bind(this);this.onBlockInit=this.onBlockInit.bind(this);t(this.manifest);this.node.classList[this.active?"remove":"add"]("landing-block-disabled");this.state="ready";this.initPanels();this.initStyles();this.adjustContextSensitivityStyles();top.BX.Landing.Block.storage.push(this);var i={};if(this.requiredUserActionIsShown){i.requiredUserActionIsShown=true;i.layout=this.node.firstElementChild;i.button=this.node.firstElementChild.querySelector(".ui-btn")}v(window,"BX.Landing.Block:init",[this.createEvent({data:i})]);L("BX.Landing.Editor:enable",this.onEditorEnabled);L("BX.Landing.Editor:disable",this.onEditorDisabled);L("BX.Landing.Block:afterRemove",this.onBlockRemove);L("BX.Landing.Block:init",this.onBlockInit);y(this.node,"mousemove",this.onMouseMove);y(this.node,"keydown",this.adjustPanelsPosition);y(top,"storage",this.onStorage)};BX.Landing.Block.storage=new BX.Landing.Collection.BlockCollection;BX.Landing.Block.prototype={onMouseMove:function(){if(this.state==="ready"){b(this.node,"mousemove",this.onMouseMove);this.initEntities();this.lazyInitPanels();this.state="complete"}},showRequiredUserAction:function(t){this.node.innerHTML='<div class="landing-block-user-action">'+'<div class="landing-block-user-action-inner">'+(t.header?"<h3>"+'<i class="fa fa-exclamation-triangle g-mr-15"></i>'+t.header+"</h3><hr>":"")+(t.description?"<p>"+t.description+"</p>":"")+((t.href||t.onClick||t.className)&&t.text?"<div>"+'<a href="'+t.href+'" class="ui-btn '+t.className+'" target="'+(t.target?t.target:"")+'">'+t.text+"</a>"+"</div>":"")+"</div>"+"</div>";if(t.onClick){var e=this.node.querySelector(".landing-block-user-action .ui-btn");y(e,"click",function(e){e.preventDefault();try{BX.evalGlobal(t.onClick)}catch(t){console.error(t)}})}},disableLinks:function(){var t="a:not([class*='landing-ui']):not(.landing-trusted-link), .btn:not([class*='landing-ui']):not(.landing-trusted-link), button:not([class*='landing-ui']):not(.landing-trusted-link), input:not([class*='landing-ui'])";var e=T(this.content.querySelectorAll(t));e.forEach(function(t){var e=this.nodes.some(function(e){return e.node.contains(t)});if(!this.nodes.getByNode(t)&&!e){t.style.pointerEvents="none"}},this)},adjustContextSensitivityStyles:function(){if(g(this.parent,"landing-sidebar")){if(!g(this.content,"landing-adjusted")){var t=Object.keys(this.manifest.style.nodes);var e=t.filter(function(t){return!!this.manifest.style.nodes[t].type&&this.manifest.style.nodes[t].type.indexOf("columns")!==-1},this);if(l(e)){return}var n=Bt("columns");e.forEach(function(t){var e=this.styles.get(t);if(e){e.setValue("col-lg-12",n.items)}},this);var i=this.styles.get(this.selector);if(i){i.setValue("landing-adjusted",["landing-adjusted"])}this.saveStyles()}}},forceInit:function(){this.onMouseMove()},createEvent:function(t){return new dt({block:this.node,node:!!t&&!!t.node?t.node:null,card:!!t&&!!t.card?t.card:null,data:!!t&&t.data||{},onForceInit:this.forceInit.bind(this)})},initEntities:function(){this.initCards();this.initNodes();this.initGroups();this.initCardsLabels();this.disableLinks()},initCardsLabels:function(){this.cards.forEach(function(t){t.label=this.createCardLabel(t.node,t.manifest)},this)},initGroups:function(){var t=[];var e=s(this.manifest.groups)?this.manifest.groups:{};this.nodes.forEach(function(e){if(c(e.manifest.group)&&!t.includes(e.manifest.group)){t.push(e.manifest.group)}});t.forEach(function(t){var n=this.nodes.filter(function(e){return e.manifest.group===t}).reduce(function(t,e){var n=parseInt(e.selector.split("@")[1]);if(!t[n]){t[n]=new q}t[n].push(e);return t},{});Object.keys(n).forEach(function(i){this.groups.add(new ct({id:t,name:e[t],nodes:n[i],onClick:this.onGroupClick.bind(this)}))},this)},this)},onGroupClick:function(t){if(!BX.Landing.UI.Panel.StylePanel.getInstance().isShown()){this.showContentPanel({name:t.name,nodes:t.nodes,compact:true,nodesOnly:true,showAll:true,hideCheckbox:true})}},initPanels:function(){if(!this.panels.get("create_action")){var t=new J("create_action","landing-ui-panel-create-action");t.addButton(new et("insert_after",{text:BX.Landing.Loc.getMessage("ACTION_BUTTON_CREATE"),onClick:B(this.addBlockAfterThis,600,this)}));t.show();this.addPanel(t);t.buttons[0].on("mouseover",this.onCreateButtonMouseover.bind(this));t.buttons[0].on("mouseout",this.onCreateButtonMouseout.bind(this))}},isLastChildInArea:function(){return this.parent.querySelector("[class*='block-wrapper']:last-of-type")===this.node},onCreateButtonMouseover:function(){if(this.isLastChildInArea()||g(this.parent,"landing-header")||g(this.parent,"landing-footer")){var t=BX.Landing.Main.getInstance().getLayoutAreas();if(t.length>1){var e=this.panels.get("create_action");var n=e.buttons.get("insert_after");switch(true){case g(this.parent,"landing-main"):n.setText([BX.Landing.Loc.getMessage("ACTION_BUTTON_CREATE"),BX.Landing.Loc.getMessage("LANDING_ADD_BLOCK_TO_MAIN")].join(" "));break;case g(this.parent,"landing-header"):n.setText([BX.Landing.Loc.getMessage("ACTION_BUTTON_CREATE"),BX.Landing.Loc.getMessage("LANDING_ADD_BLOCK_TO_HEADER")].join(" "));break;case g(this.parent,"landing-sidebar"):n.setText([BX.Landing.Loc.getMessage("ACTION_BUTTON_CREATE"),BX.Landing.Loc.getMessage("LANDING_ADD_BLOCK_TO_SIDEBAR")].join(" "));break;case g(this.parent,"landing-footer"):n.setText([BX.Landing.Loc.getMessage("ACTION_BUTTON_CREATE"),BX.Landing.Loc.getMessage("LANDING_ADD_BLOCK_TO_FOOTER")].join(" "));break}clearTimeout(this.fadeTimeout);this.fadeTimeout=setTimeout(function(){h(this.parent,"landing-area-highlight");t.forEach(function(t){if(t!==this.parent){h(t,"landing-area-fade")}},this)}.bind(this),400)}}},onCreateButtonMouseout:function(){clearTimeout(this.fadeTimeout);if(this.isLastChildInArea()||g(this.parent,"landing-header")||g(this.parent,"landing-footer")){var t=BX.Landing.Main.getInstance().getLayoutAreas();if(t.length>1){var e=this.panels.get("create_action").buttons[0];e.setText(BX.Landing.Loc.getMessage("ACTION_BUTTON_CREATE"));u(this.parent,"landing-area-highlight");t.forEach(function(t){u(t,"landing-area-fade")},this)}}},lazyInitPanels:function(){var t=BX.Landing.Main.getInstance().options.placements.blocks;if(!this.panels.contains("content_actions")&&!this.requiredUserActionIsShown&&(s(this.manifest.nodes)&&!l(this.manifest.nodes)||s(this.manifest.style)&&!l(this.manifest.style)||s(t)&&!l(t))){var e=new J("content_actions","landing-ui-panel-content-action");e.addButton(new tt("collapse",{html:"<span class='fa fa-caret-right'></span>",onClick:this.onCollapseActionPanel.bind(this),attrs:{title:BX.Landing.Loc.getMessage("LANDING_TITLE_OF_BLOCK_ACTION_COLLAPSE")}}));if(s(this.manifest.nodes)||s(this.manifest.attrs)){e.addButton(new tt("content",{text:BX.Landing.Loc.getMessage("ACTION_BUTTON_CONTENT"),onClick:this.onShowContentPanel.bind(this),attrs:{title:BX.Landing.Loc.getMessage("LANDING_TITLE_OF_BLOCK_EDIT")}}))}if(s(this.manifest.style)){e.addButton(new tt("style",{text:BX.Landing.Loc.getMessage("ACTION_BUTTON_STYLE"),onClick:this.onStyleShow.bind(this),disabled:this.access<ft||l(this.manifest.style),attrs:{title:BX.Landing.Loc.getMessage("LANDING_TITLE_OF_BLOCK_DESIGN")}}))}if(s(t)&&(this.manifest.code in t||t["*"])){var n=[];if(this.manifest.code in t){Object.keys(t[this.manifest.code]).forEach(function(e){n.push(t[this.manifest.code][e])},this)}if(t["*"]){Object.keys(t["*"]).forEach(function(e){n.push(t["*"][e])},this)}if(n.length){e.addButton(new tt("actions",{html:BX.Landing.Loc.getMessage("ACTION_BUTTON_CONTENT_MORE"),onClick:this.onPlacementButtonClick.bind(this,n)}));if(typeof top.BX.rest!=="undefined"&&typeof top.BX.rest.AppLayout!=="undefined"){var i=["*",this.manifest.code];for(var a=0,o=i.length;a<o;a++){var r=top.BX.rest.AppLayout.initializePlacement("LANDING_BLOCK_"+i[a]);if(r){r.prototype.refreshBlock=function(t,e){var n=top.BX.Landing.Block.storage.get(t.id);if(n){n.reload().then(e)}}}}}}h(e.buttons.get("style").layout,"landing-ui-no-rounded")}if(s(this.manifest.style)){var c=new tt("block_display_info",{html:"&nbsp;"});y(c.layout,"mouseenter",this.onBlockDisplayMouseenter.bind(this));y(c.layout,"mouseleave",this.onBlockDisplayMouseleave.bind(this));e.addButton(c)}e.show();this.addPanel(e)}if(!this.panels.get("block_action")){var d=new J("block_action","landing-ui-panel-block-action");var u=this.getBlockFromRepository(this.manifest.code);if(u&&u.restricted){var g=new tt("restricted",{html:"&nbsp;",className:"landing-ui-block-restricted-button",onClick:this.onRestrictedButtonClick.bind(this)});y(g.layout,"mouseenter",this.onRestrictedButtonMouseenter.bind(this));y(g.layout,"mouseleave",this.onRestrictedButtonMouseleave.bind(this));d.addButton(g)}d.addButton(new tt("down",{html:BX.Landing.Loc.getMessage("ACTION_BUTTON_DOWN"),onClick:this.moveDown.bind(this),attrs:{title:BX.Landing.Loc.getMessage("LANDING_TITLE_OF_BLOCK_ACTION_SORT_DOWN")}}));d.addButton(new tt("up",{html:BX.Landing.Loc.getMessage("ACTION_BUTTON_UP"),onClick:this.moveUp.bind(this),attrs:{title:BX.Landing.Loc.getMessage("LANDING_TITLE_OF_BLOCK_ACTION_SORT_UP")}}));d.addButton(new tt("actions",{html:BX.Landing.Loc.getMessage("ACTION_BUTTON_ACTIONS"),onClick:this.showBlockActionsMenu.bind(this),attrs:{title:BX.Landing.Loc.getMessage("LANDING_TITLE_OF_BLOCK_ACTION_ADDITIONAL_ACTIONS")}}));d.addButton(new tt("remove",{html:BX.Landing.Loc.getMessage("ACTION_BUTTON_REMOVE"),disabled:this.access<pt,onClick:this.deleteBlock.bind(this),attrs:{title:BX.Landing.Loc.getMessage("LANDING_TITLE_OF_BLOCK_ACTION_REMOVE")}}));d.addButton(new tt("collapse",{html:"<span class='fa fa-caret-right'></span>",onClick:this.onCollapseActionPanel.bind(this),attrs:{title:BX.Landing.Loc.getMessage("LANDING_TITLE_OF_BLOCK_ACTION_COLLAPSE")}}));d.show();this.addPanel(d)}this.adjustPanelsPosition();this.adjustSortButtonsState()},onCollapseActionPanel:function(){f(this.parent,"landing-ui-collapse")},getBlockFromRepository:function(t){var e=BX.Landing.Main.getInstance().options.blocks;var n=Object.keys(e);var i=n.find(function(n){return t in e[n].items});if(i){return e[i].items[t]}},onRestrictedButtonClick:function(t){t.preventDefault()},onPlacementClick:function(t){BX.rest.AppLayout.openApplication(t.app_id,{ID:this.id,CODE:this.manifest.code,LID:BX.Landing.Main.getInstance().id},{PLACEMENT:"LANDING_BLOCK_"+t.placement,PLACEMENT_ID:t.id});if(this.blockPlacementsActionsMenu){this.blockPlacementsActionsMenu.close()}},onPlacementButtonClick:function(t){this.panels.get("content_actions").buttons.get("actions").activate();if(!this.blockPlacementsActionsMenu){var e=this.panels.get("content_actions").buttons.get("actions");var n=A("block_",this.id,"content_placement_actions_",x());var i=t.map(function(t){return new BX.PopupMenuItem({id:"placement_"+t.id+"_"+x(),text:O(t.title),onclick:this.onPlacementClick.bind(this,t)})},this);this.blockPlacementsActionsMenu=new ht({id:n,bindElement:e.layout,items:i,angle:{position:"top",offset:80},offsetTop:-6,events:{onPopupClose:function(){this.panels.get("content_actions").buttons.get("actions").deactivate();u(this.node,"landing-ui-hover")}.bind(this)}})}h(this.node,"landing-ui-hover");this.blockPlacementsActionsMenu.show()},onRestrictedButtonMouseenter:function(t){clearTimeout(this.displayBlockTimer);this.displayBlockTimer=setTimeout(function(t){BX.Landing.UI.Tool.Suggest.getInstance().show(t,{description:BX.Landing.Loc.getMessage("LANDING_BLOCK_RESTRICTED_TEXT")})}.bind(this),200,t.currentTarget)},onRestrictedButtonMouseleave:function(){clearTimeout(this.displayBlockTimer);BX.Landing.UI.Tool.Suggest.getInstance().hide()},onBlockDisplayMouseenter:function(t){clearTimeout(this.displayBlockTimer);this.displayBlockTimer=setTimeout(function(t){BX.Landing.UI.Tool.Suggest.getInstance().show(t,{name:m("div",{props:{className:"landing-ui-block-display-message-header"},html:BX.Landing.Loc.getMessage("LANDING_BLOCK_DISABLED_ON_DESKTOP_NAME")}).outerHTML,description:this.getBlockDisplayItems()})}.bind(this),300,t.currentTarget)},onBlockDisplayMouseleave:function(){clearTimeout(this.displayBlockTimer);BX.Landing.UI.Tool.Suggest.getInstance().hide()},getBlockDisplayItems:function(){function t(t){return m("div",{props:{className:"landing-ui-block-display-message"},attrs:{"data-mod":t},children:[m("div",{props:{className:"landing-ui-block-display-message-left"},html:"&nbsp;"}),m("div",{props:{className:"landing-ui-block-display-message-right"},children:[m("p",{html:BX.Landing.Loc.getMessage("LANDING_BLOCK_HIDDEN_ON_"+(t?t.toUpperCase():""))})]})]})}var e=m("div");if(g(this.content,"l-d-lg-none")){e.appendChild(t("desktop"))}if(g(this.content,"l-d-md-none")){e.appendChild(t("tablet"))}if(g(this.content,"l-d-xs-none")){e.appendChild(t("mobile"))}return e.outerHTML},adjustPanelsPosition:function(){var t=k(this.node);var e=this.panels.get("content_actions");var n=this.panels.get("block_action");var i=t.height<80?h:u;if(e){i(e.layout,"landing-ui-panel-actions-compact")}if(n){i(n.layout,"landing-ui-panel-actions-compact")}},onEditorEnabled:function(t){if(this.node.contains(t)){h(this.node,"landing-ui-hover")}},onEditorDisabled:function(){u(this.node,"landing-ui-hover")},onStorage:function(){if(this.blockActionsMenu){var t=this.blockActionsMenu.getMenuItem("block_paste");if(t){if(window.localStorage.landingBlockId){t.layout.item.setAttribute("title",window.localStorage.landingBlockName);u(t.layout.item,"landing-ui-disabled");h(t.layout.item,"menu-popup-no-icon")}else{t.layout.item.setAttribute("title","");h(t.layout.item,"landing-ui-disabled")}}}},showBlockActionsMenu:function(){this.panels.get("block_action").buttons.get("actions").activate();if(!this.blockActionsMenu){var t=g(this.node.parentElement,"landing-sidebar");var e=this.panels.get("block_action").buttons.get("actions");var n=A("block_",this.id,"_actions_",x());var i=BX.Landing.Main.getInstance();this.blockActionsMenu=new ht({id:n,bindElement:e.layout,className:"landing-ui-block-actions-popup",angle:{position:"top",offset:t?70:146},offsetTop:-6,offsetLeft:-26,events:{onPopupClose:function(){this.panels.get("block_action").buttons.get("actions").deactivate();u(this.node,"landing-ui-hover")}.bind(this)},items:[new BX.PopupMenuItem({id:"show_hide",text:BX.Landing.Loc.getMessage(this.isEnabled()?"ACTION_BUTTON_HIDE":"ACTION_BUTTON_SHOW"),className:this.access<mt?"landing-ui-disabled":"",onclick:function(){this.onStateChange();this.blockActionsMenu.close()}.bind(this)}),new BX.PopupMenuItem({text:BX.Landing.Loc.getMessage("ACTION_BUTTON_ACTIONS_CUT"),className:this.access<pt?"landing-ui-disabled":"",onclick:function(){i.onCutBlock.bind(i,this)();this.blockActionsMenu.close()}.bind(this)}),new BX.PopupMenuItem({text:BX.Landing.Loc.getMessage("ACTION_BUTTON_ACTIONS_COPY"),onclick:function(){i.onCopyBlock.bind(i,this)();this.blockActionsMenu.close()}.bind(this)}),new BX.PopupMenuItem({id:"block_paste",text:BX.Landing.Loc.getMessage("ACTION_BUTTON_ACTIONS_PASTE"),title:window.localStorage.landingBlockName,className:window.localStorage.landingBlockId?"":"landing-ui-disabled",onclick:function(){i.onPasteBlock.bind(i,this)();this.blockActionsMenu.close()}.bind(this)}),new BX.PopupMenuItem({text:BX.Landing.Loc.getMessage("LANDING_BLOCKS_ACTIONS_FEEDBACK_BUTTON"),onclick:function(){BX.Landing.Main.getInstance().showSliderFeedbackForm({blockName:this.manifest.block.name,blockCode:this.manifest.code,blockSection:this.manifest.block.section,landingId:BX.Landing.Main.getInstance().id,target:"blockActions"});this.blockActionsMenu.close()}.bind(this)})]})}h(this.node,"landing-ui-hover");this.blockActionsMenu.show()},moveUp:function(t){var n=_(this.node,"block-wrapper");var a=this.node;if(n){var s=Promise.all([X(a,-k(n).height),X(n,k(a).height)]);s.then(function(){void e(a,{transform:null,transition:null});void e(n,{transform:null,transition:null});i(a,n);if(!t||typeof t==="object"){BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:this.id,selector:"#block"+this.id,command:"sortBlock",undo:"moveDown",redo:"moveUp"}))}}.bind(this));BX.Landing.Backend.getInstance().action("Landing::upBlock",{block:this.id,lid:this.lid,siteId:this.siteId},{code:this.manifest.code})}},moveDown:function(t){var i=E(this.node,"block-wrapper");var a=this.node;if(!!i){var s=Promise.all([X(a,k(i).height),X(i,-k(a).height)]);s.then(function(){void e(a,{transform:null,transition:null});void e(i,{transform:null,transition:null});n(a,i);if(!t||typeof t==="object"){BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:this.id,selector:"#block"+this.id,command:"sortBlock",undo:"moveUp",redo:"moveDown"}))}}.bind(this));BX.Landing.Backend.getInstance().action("Landing::downBlock",{block:this.id,lid:this.lid,siteId:this.siteId},{code:this.manifest.code})}},addPanel:function(t,e){if(!this.panels.contains(t)){this.panels.add(t);if(!e){a(t.layout,this.node)}else{i(t.layout,e)}}},onShowContentPanel:function(){this.showContentPanel();BX.Landing.UI.Panel.EditorPanel.getInstance().hide()},onStateChange:function(){if(this.isEnabled()){this.disable()}else{this.enable()}},isEnabled:function(){return this.active},enable:function(){this.active=true;u(this.node,"landing-block-disabled");I(this.blockActionsMenu.getMenuItem("show_hide").getLayout().text,BX.Landing.Loc.getMessage("ACTION_BUTTON_HIDE"));BX.Landing.Backend.getInstance().action("Landing::showBlock",{block:this.id,lid:this.lid,siteId:this.siteId},{code:this.manifest.code})},disable:function(){this.active=false;h(this.node,"landing-block-disabled");I(this.blockActionsMenu.getMenuItem("show_hide").getLayout().text,BX.Landing.Loc.getMessage("ACTION_BUTTON_SHOW"));BX.Landing.Backend.getInstance().action("Landing::hideBlock",{block:this.id,lid:this.lid,siteId:this.siteId},{code:this.manifest.code})},createCardLabel:function(t,e){var n=[];if(c(e.label)){n.push(e.label)}else if(d(e.label)){n=n.concat(e.label)}var i=this.nodes.filter(function(e){return t.contains(e.node)});var a=[];n.forEach(function(t){var e=i.find(function(e){return e.manifest.code===t});if(e){var n;if(e instanceof BX.Landing.Block.Node.Text){n=m("span",{props:{className:"landing-card-title-text"},html:G(m("div",{html:e.getValue()}).innerText)});a.push(n);L(e.getField(),"BX.Landing.UI.Field:change",function(t){n.innerHTML=G(m("div",{html:t}).innerText)});return}if(e instanceof BX.Landing.Block.Node.Link){n=m("span",{props:{className:"landing-card-title-link"},html:G(e.getValue().text)});a.push(n);L(e.getField(),"BX.Landing.UI.Field:change",function(t){n.innerHTML=G(t.text)});return}if(e instanceof BX.Landing.Block.Node.Icon){n=m("span",{props:{className:"landing-card-title-icon"},children:[m("span",{props:{className:e.getValue().classList.join(" ")}})]});a.push(n);L(e.getField(),"BX.Landing.UI.Field:change",function(t){n.firstChild.className="landing-card-title-icon "+t.classList.join(" ")});return}if(e instanceof BX.Landing.Block.Node.Img){n=m("span",{props:{className:"landing-card-title-img"},attrs:{style:"background-color: #fafafa"},children:[m("img",{props:{src:e.getValue().src}})]});a.push(n);L(e.getField(),"BX.Landing.UI.Field:change",function(t){n.innerHTML="";n.appendChild(m("img",{props:{src:t.src}}))})}}},this);return m("div",{props:{className:"landing-card-title"},children:!l(a)?a:e.name})},initCards:function(){if(this.access<mt){return}this.cards.clear();this.forEachCard(function(t,e,n){var i=BX.clone(this.manifest.cards[e]);var a=A(e,"@",n);if(this.isDynamicCards(e)){i.allowInlineEdit=false}M(t);var s=new BX.Landing.Block.Card(t,i,a);this.cards.add(s);if(i.allowInlineEdit!==false){var o=new Q("cardAction","landing-ui-panel-block-card-action");o.show();s.addPanel(o);o.addButton(new nt("clone",{html:"&nbsp;",onClick:function(t){t.stopPropagation();if(s.manifest.sync){var e=s.manifest.sync;if(c(s.manifest.sync)){e=[s.manifest.sync]}if(d(e)){e.forEach(function(t){this.cloneCard(A(t,"@",n))},this)}}this.cloneCard(a)}.bind(this),attrs:{title:BX.Landing.Loc.getMessage("LANDING_TITLE_OF_CARD_ACTION_CLONE")}}));o.addButton(new nt("remove",{html:"&nbsp;",onClick:function(t){t.stopPropagation();if(s.manifest.sync){var e=s.manifest.sync;if(c(s.manifest.sync)){e=[s.manifest.sync]}if(d(e)){e.forEach(function(t){this.removeCard(A(t,"@",n))},this)}}this.removeCard(a)}.bind(this),attrs:{title:BX.Landing.Loc.getMessage("LANDING_TITLE_OF_CARD_ACTION_REMOVE")}}))}s.selector=a;s.sortIndex=n;this.adjustCardRemoveButton(a)});this.cards.sort(function(t,e){return t.getIndex()>e.getIndex()})},cloneCard:function(t,e){var i=this.cards.getBySelector(t);var a=i.panels.get("cardAction").buttons.get("clone");var s={block:this.id,selector:t,lid:this.lid,siteId:this.siteId};var o={code:this.manifest.code};var r=this;yt(a);return BX.Landing.Backend.getInstance().action("Landing\\Block::cloneCard",s,o).then(function(){v("BX.Landing.Block:Card:beforeAdd",[r.createEvent({card:i.node})])}).then(function(){var t=BX.clone(i.node);M(t);n(t,i.node);return t}).then(function(t){bt(a);v("BX.Landing.Block:Card:add",[r.createEvent({card:t})]);r.initEntities();r.initStyles();if(!e){var n=P(t.parentNode);var s=r.cards.getByNode(t);BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:r.id,selector:s.selector,command:"addCard",undo:{container:n,selector:s.selector},redo:{container:n,index:i.getIndex(),html:t.outerHTML}}))}}).catch(function(){bt(a);return Promise.reject()})},removeCard:function(t,e){var n=this.cards.getBySelector(t);var i=n.panels.get("cardAction").buttons.get("remove");var a={block:this.id,selector:t,lid:this.lid,siteId:this.siteId};var s={code:this.manifest.code};var o=this;yt(i);return BX.Landing.Backend.getInstance().action("Landing\\Block::removeCard",a,s).then(function(){v("BX.Landing.Block:Card:beforeRemove",[o.createEvent({card:n.node})]);if(!e){var t=P(n.node.parentElement);M(n.node);BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:o.id,selector:n.selector,command:"removeCard",undo:{container:t,index:n.getIndex(),html:n.node.outerHTML},redo:{container:t,selector:n.selector}}))}}).then(function(){o.cards.remove(n);n.node.remove();o.initEntities();o.adjustCardRemoveButton(t)}).then(function(){var e=o.createEvent({data:{selector:t}});v("BX.Landing.Block:Card:remove",[e]);bt(i)}).catch(function(){bt(i);return Promise.reject()})},adjustCardRemoveButton:function(t){var e=this.cards.getBySelector(t);if(e){var n=e.node.parentElement.children.length===1;var i=e.panels.get("cardAction");if(n){if(i){i.buttons.get("remove").disable()}}else{if(i){i.buttons.get("remove").enable()}}}},addCard:function(t){var e=t.selector.split("@")[0]+(t.index>0?"@"+(t.index-1):"");var i={block:this.id,content:t.content,selector:e,lid:this.lid,siteId:this.siteId};var a={code:this.manifest.code};var s=t.container;var o=m("div",{html:t.content}).firstElementChild;var r=this;return BX.Landing.Backend.getInstance().action("Landing\\Block::addCard",i,a).then(function(){v("BX.Landing.Block:Card:beforeAdd",[r.createEvent({card:o})])}).then(function(){var i;if(t.index<=0){i=r.cards.find(function(t){return t.selector.includes(e.split("@")[0])});if(i){j(o,i.node.parentNode)}}else{i=r.cards.getBySelector(e.split("@")[0]+"@"+(t.index-1));if(i){n(o,i.node)}}M(s);r.initEntities();v("BX.Landing.Block:Card:add",[r.createEvent({card:o})])})},forEachCard:function(t){var e=Object.keys(this.manifest.cards);e.map(function(e){var n=T(this.node.querySelectorAll(e));n.forEach(function(n,i){t.apply(this,[n,e,i])},this)},this)},initNodes:function(){if(this.access<mt){return}var t=[];this.forEachNodeElements(function(e,n,i){var a=this.nodes.getByNode(e);var o=A(n,"@",i);if(!a){var r=C(this.manifest.nodes[n].handler);var c=e.closest("[data-card-preset]");var l=F(this.manifest.nodes[n]);var h=false;if(c){var u=c.dataset.cardPreset;Object.keys(this.manifest.cards).forEach(function(t){if(c.matches(t)){if(s(this.manifest.cards[t].presets)&&s(this.manifest.cards[t].presets[u])&&d(this.manifest.cards[t].presets[u].disallow)){var e=this.manifest.cards[t].presets[u].disallow.find(function(t){return n===t});if(e){l.allowInlineEdit=false;h=true}}}},this)}var g=this.cards.some(function(t){var n=t.selector.split("@")[0];return this.isDynamicCards(n)&&t.node.contains(e)},this);if(g){l.allowInlineEdit=false}else{var f=this.cards.some(function(t){return t.node.contains(e)});if(!f){if(this.isDynamic()){l.allowInlineEdit=false}}}a=new r({node:e,manifest:l,selector:o,onChange:this.onNodeChange.bind(this),onChangeOptions:this.onNodeOptionsChange.bind(this),onAttributeChange:this.onAttributeChange.bind(this),onDesignShow:this.showStylePanel.bind(this),uploadParams:{action:"Block::uploadFile",block:this.id}});if(h){a.getField().layout.hidden=true}this.nodes.add(a)}a.selector=o;t.push(a)});this.nodes.clear();t.forEach(function(t){this.nodes.add(t)},this);this.nodes.sort(function(t,e){return t.getIndex()>e.getIndex()})},onNodeOptionsChange:function(t){if(!l(t)){var e={code:this.manifest.code};var n={};n.data=t;n.block=this.id;n.siteId=this.siteId;return BX.Landing.Backend.getInstance().action("Block::changeNodeName",n,e)}},forEachNodeElements:function(t){Object.keys(this.manifest.nodes).forEach(function(e){try{T(this.node.querySelectorAll(e)).forEach(function(n,i){if(!n.matches('[data-id="content_edit"] *')){t.apply(this,[n,e,i])}},this)}catch(t){}},this)},showContentPanel:function(t){var e=!!t&&t.nodes?t.nodes:null;var n=!!t&&t.name?t.name:null;var i=!!t&&t.nodesOnly?t.nodesOnly:false;var o=!!t&&t.showAll?t.showAll:false;var r=!!t&&t.compact;var c=!!t&&t.hideCheckbox;var d=this.panels.get("content_edit");if(!d){d=new Z("content_edit",{title:BX.Landing.Loc.getMessage("LANDING_CONTENT_PANEL_TITLE"),subTitle:this.manifest.block.name,footer:[new $("save_block_content",{text:BX.Landing.Loc.getMessage("BLOCK_SAVE"),onClick:this.onContentSave.bind(this),className:"landing-ui-button-content-save",attrs:{title:BX.Landing.Loc.getMessage("LANDING_TITLE_OF_SLIDER_SAVE")}}),new $("cancel_block_content",{text:BX.Landing.Loc.getMessage("BLOCK_CANCEL"),onClick:this.onContentCancel.bind(this),className:"landing-ui-button-content-cancel",attrs:{title:BX.Landing.Loc.getMessage("LANDING_TITLE_OF_SLIDER_CANCEL")}})]});this.addPanel(d)}d.compact(r);d.clear();var l=this.getBlockFromRepository(this.manifest.code);if(l&&l.restricted){a(this.getRestrictedMessage(),d.content)}this.tmpContent=m("div",{props:{hidden:true}});this.content.appendChild(this.tmpContent);var h="";Object.keys(this.manifest.cards).forEach(function(t){var e=this.manifest.cards[t];if(s(e.presets)){Object.keys(e.presets).forEach(function(t){var n=e.presets[t];h+=n.html},this)}},this);this.tmpContent.innerHTML=h;this.initEntities();var u=this.getEditForms({nodes:e,formName:n,nodesOnly:i,showAll:o,hideCheckbox:c});u.forEach(function(t){d.appendForm(t)});this.tmpContent.innerHTML="";d.show();setTimeout(function(){this.lastBlockState=this.fetchRequestData(d,true)}.bind(this),300)},createHistoryEntry:function(t){Promise.all([this.lastBlockState,t]).then(function(t){var e=t[0];var n=t[1];BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:this.id,selector:"#block"+this.id,command:"updateBlockState",undo:e,redo:n}))}.bind(this));return Promise.resolve(F(t))},updateBlockState:function(t,e){if(BX.type.isPlainObject(t)&&BX.type.isPlainObject(t.dynamicParams)){this.dynamicParams=F(t.dynamicParams)}else{this.dynamicParams={}}Promise.resolve(t).then(function(t){return e?t:this.createHistoryEntry(t)}.bind(this)).then(this.applyContentChanges.bind(this)).then(this.applyCardsChanges.bind(this)).then(this.applyAttributeChanges.bind(this)).then(this.applySettingsChanges.bind(this)).then(this.saveChanges.bind(this)).then(this.reload.bind(this)).catch(console.warn);var n=this.panels.get("content_edit");if(n){var i=new Y;n.forms.forEach(function(t){if(t.type!=="attrs"){i.add(t)}});var a={};i.fetchFields().forEach(function(t){if(t.tag){a[t.selector]={tagName:t.tag}}},this);this.onNodeOptionsChange(a)}},getRestrictedMessage:function(){return m("div",{props:{className:"ui-alert ui-alert-warning"},html:BX.Landing.Loc.getMessage("LANDING_BLOCK_RESTRICTED_TEXT"),attrs:{style:"margin-bottom: 20px"}})},onStyleShow:function(){this.showStylePanel(this.selector);BX.Landing.UI.Panel.EditorPanel.getInstance().hide()},getPostfix:function(){return""},expandTypeGroups:function(t){var e=[];if(!BX.type.isArray(t)){t=[t]}t.forEach(function(t){if(vt(t)){Lt(t).forEach(function(t){e.push(t)})}else{e.push(t)}});return e},createStyleForm:function(t,e,n){var i=this.forms.get(t);if(i){this.forms.remove(i)}var a=!!e.props?e.props:!!e.type?e.type:null;var s=!!e.title?e.title:!!e.name?e.name:"";if(!!a&&!!s){var o=new it({frame:window,postfix:this.getPostfix()});i=new st({id:t,title:s,selector:t,iframe:window});a=this.expandTypeGroups(a).reduce(function(t,e){if(!t.includes(e)){t.push(e)}return t},[]);a.forEach(function(e){var a=Bt(e);var s=this.styles.get(t);var r=o.createField({selector:!n?this.makeRelativeSelector(t):t,property:a.property,multiple:a.multiple===true,style:e,pseudoElement:a["pseudo-element"],pseudoClass:a["pseudo-class"],type:a.type,title:a.name,items:a.items,onChange:function(e,o,r,c){var d=!!a.exclude?Bt(a.exclude):null;if(d){i.fields.forEach(function(t){if(t.style===a.exclude){t.reset()}})}var l={className:"",style:""};if(s.node[0]){l.className=s.node[0].className;l.style=s.node[0].style.cssText}var h=this.createEvent({data:{selector:t,value:e,items:o,postfix:r,affect:c,exclude:d}});v(window,"BX.Landing.Block:beforeApplyStyleChanges",[h]);s.setValue(e,o,r,c,d);var u={className:"",style:""};if(s.node[0]){u.className=s.node[0].className;u.style=s.node[0].style.cssText}try{if(JSON.stringify(l)!==JSON.stringify(u)){BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:this.id,command:"updateStyle",selector:!n?this.makeRelativeSelector(t):t,undo:l,redo:u}))}}catch(t){}v("BX.Landing.Block:updateStyleWithoutDebounce",[this.createEvent({node:s.getNode(),data:s.getValue()})]);this.onStyleInputWithDebounce({node:s.getNode(),data:s.getValue()})}.bind(this)});var c=true;s.getValue().classList.forEach(function(t){if(a.items.some(function(e){return e.value===t})){if(r.property!=="display"){r.setValue(t,c)}}});i.addField(r)},this);this.forms.add(i)}i.fields.forEach(function(t){if(t.popup){t.popup.close()}});return i},initStyles:function(){if(this.access<ft){return}this.styles.clear();var t=new BX.Landing.UI.Style({id:this.selector,iframe:window,selector:this.selector,relativeSelector:this.selector,onClick:this.onStyleClick.bind(this,this.selector)});this.styles.add(t);if(s(this.manifest.style)&&s(this.manifest.style.nodes)){Object.keys(this.manifest.style.nodes).forEach(function(t){var e=new BX.Landing.UI.Style({id:t,iframe:window,selector:t,relativeSelector:this.makeRelativeSelector(t),onClick:this.onStyleClick.bind(this,t)});this.styles.add(e)},this)}},onStyleClick:function(t){this.showStylePanel(t);var e=this.forms.get(t);if(e){BX.Landing.PageObject.getInstance().design().then(function(t){BX.Landing.UI.Panel.Content.scrollTo(t.content,null)})}},makeRelativeSelector:function(t){return A(this.selector," ",t)},makeAbsoluteSelector:function(t){t=t||this.selector;t=U(t);var e=t===this.selector?" > :first-child":this.selector;return U(t.replace(e,"").replace("!",""))},saveStyles:function(){var t=this.styles.fetchChanges();if(t.length){t.forEach(function(t){if(t.selector===this.selector){t.selector=t.selector.replace(" > :first-child","")}if(!t.isSelectGroup()&&t.selector!==this.makeAbsoluteSelector(this.selector)){t.selector=A(t.selector.split("@")[0],"@",t.getElementIndex(t.getNode()[0]))}if(t.isSelectGroup()){t.selector=t.selector.split("@")[0]}},this);var e=t.fetchValues();BX.Landing.Backend.getInstance().action("Landing\\Block::updateStyles",{block:this.id,data:e,lid:this.lid,siteId:this.siteId},{code:this.manifest.code})}},showStylePanel:function(t){BX.Landing.PageObject.getInstance().design().then(function(t){t.clearContent();return t.show()}).then(function(e){var n=this.isBlockSelector(t);var i=this.getStyleOptions(t);if(d(i.type)||c(i.type)){if(i.type.length){e.appendForm(this.createStyleForm(t,i,n))}}if(s(i.additional)){t=i.selector?i.selector:t;e.appendForm(this.createAdditionalForm({form:st,selector:t,group:i.additional,onChange:this.onAttributeChange.bind(this)}));return}if(d(i.additional)){i.additional.forEach(function(n){e.appendForm(this.createAdditionalForm({form:st,selector:t,group:n,onChange:this.onAttributeChange.bind(this)}))},this)}}.bind(this))},getStyleOptions:function(t){if(this.isBlockSelector(t)){return this.prepareBlockOptions(this.manifest.style.block)}return this.manifest.style.nodes[t]},createAdditionalForm:function(t){var e=new t.form({title:t.group.name,type:"attrs"});t.group.attrs.forEach(function(n){var i=n.selector||t.selector;var a;if(d(n.tabs)){var s=new lt({tabs:n.tabs.map(function(e){return{id:x(),name:e.name,active:e.active,fields:e.attrs.map(function(e){return this.createAttributeField(e,e.selector||t.selector,t.onChange)},this)}},this)});e.addCard(s);return}a=this.createAttributeField(n,i,t.onChange);e.addField(a)},this);return e},prepareBlockOptions:function(t){t=s(t)?t:{};t=F(t);t.name=BX.Landing.Loc.getMessage("BLOCK_STYLE_OPTIONS");if(!s(t.type)&&!c(t.type)&&!d(t.type)){t.type=["display","padding-top","padding-bottom","padding-left","padding-right","margin-top","background-color","background-gradient"]}return t},createAttributeField:function(t,e,n){var i=this.createFieldFactory(e,n);var a=this.getElementBySelector(e);if(!a&&e.includes("@")){var s=e.split("@");var o=this.getElementsBySelector(s[0]);if(o.length&&o[parseInt(s[1])]){a=o[parseInt(s[1])]}}var r=F(t);if(r.value===null||r.value===undefined){r.value=""}if(a){var d=S(a,r.attribute);if(d&&c(d)){d=w(a,r.attribute)}if(d!==null){r.value=d}}return i.create(r)},onAttributeChange:function(t){clearTimeout(this.attributeChangeTimeout);if(!this.requestData){this.requestData={}}this.appendAttrFieldValue(this.requestData,t);Promise.resolve(this.requestData).then(this.applyAttributeChanges.bind(this)).then(this.saveChanges.bind(this)).then(this.reload.bind(this)).then(function(){this.requestData=null}.bind(this))},appendSettingsFieldValue:function(t,e){t["settings"]=t["settings"]||{};t["settings"][e.attribute]=e.getValue();return t},appendAttrFieldValue:function(t,e){var n=this.makeAbsoluteSelector(e.selector);var i=e.getValue();try{i=O(i)}catch(t){i=e.getValue()}t[n]=t[n]||{};t[n]["attrs"]=t[n]["attrs"]||{};t[n]["attrs"][e.attribute]=i;return t},getElementBySelector:function(t){if(this.isBlockSelector(t)){return this.content}var e;try{e=this.node.querySelector(t)}catch(t){e=null}return e},getElementsBySelector:function(t){if(this.isBlockSelector(t)){return[this.content]}var e;try{e=T(this.node.querySelectorAll(t))}catch(t){e=[]}return e},isBlockSelector:function(t){return!t||t===this.selector||"#block"+this.id===t},createFieldFactory:function(t,e){return new BX.Landing.UI.Factory.FieldFactory({selector:!this.isBlockSelector(t)?this.makeRelativeSelector(t):t,uploadParams:{action:"Block::uploadFile",block:this.id,lid:BX.Landing.Main.getInstance().id,id:BX.Landing.Main.getInstance().options.site_id},linkOptions:{siteId:BX.Landing.Main.getInstance().options.site_id,landingId:BX.Landing.Main.getInstance().id,filter:{"=TYPE":BX.Landing.Main.getInstance().options.params.type}},onValueChange:e||function(){}})},deleteBlock:function(t){var n=this.panels.get("block_action").buttons.get("remove");n.loader=n.loader||new BX.Loader({target:n.layout,size:28});n.loader.show();h(n.text,"landing-ui-hide-icon");void e(n.loader.layout.querySelector(".main-ui-loader-svg-circle"),{"stroke-width":"4px"});void e(n.loader.layout.querySelector(".main-ui-loader-svg"),{"margin-top":"-10px"});BX.Landing.UI.Panel.EditorPanel.getInstance().hide();if(this.blockActionsMenu){BX.PopupMenu.destroy(this.blockActionsMenu.id)}window.localStorage.removeItem("landingBlockId");BX.Landing.Backend.getInstance().action("Landing::markDeletedBlock",{block:this.id,lid:this.lid,siteId:this.siteId},{code:this.manifest.code}).then(function(){n.loader.hide();u(n.text,"landing-ui-hide-icon");var e=this.createEvent();v("BX.Landing.Block:remove",[e]);T(this.node.querySelectorAll(".landing-ui-panel")).forEach(D);if(o(t)&&!t||!o(t)){var i=top.BX.Landing.Block.storage.getByNode(BX.findPreviousSibling(this.node,{className:"block-wrapper"}));BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:this.id,selector:"#block"+this.id,command:"removeBlock",undo:{currentBlock:i?i.id:null,lid:this.lid,code:this.manifest.code},redo:""}))}top.BX.Landing.Block.storage.remove(this);D(this.node);v("Landing.Block:onAfterDelete",[this]);v("BX.Landing.Block:afterRemove",[e])}.bind(this),function(){n.loader.hide();u(n.text,"landing-ui-hide-icon")})},addBlockAfterThis:function(){BX.Landing.Main.getInstance().showBlocksPanel(this)},onNodeChange:function(t){var e=this.createEvent({node:t.node});v("BX.Landing.Block:Node:update",[e]);if(!t.isSavePrevented()){clearTimeout(this.changeTimeout);this.changedNodes.add(t);this.changeTimeout=setTimeout(function(){BX.Landing.Backend.getInstance().action("Landing\\Block::updateNodes",{block:this.id,data:this.changedNodes.fetchValues(),additional:this.changedNodes.fetchAdditionalValues(),lid:this.lid,siteId:this.siteId},{code:this.manifest.code});this.changedNodes.clear()}.bind(this),100)}},containsPseudoSelector:function(t){return Object.keys(t).some(function(t){var e;if(t==="cards"){return false}if(t==="dynamicState"){return false}try{if(t!=="#block"+this.id&&t!==""){e=!this.node.querySelector(t)}else{e=false}}catch(n){e=!Ct(t)}return e},this)},applyContentChanges:function(t){if(!s(t)){return Promise.reject(new TypeError("BX.Landing.Block.applyContentChanges: data isn't object"))}var e=F(t);Object.keys(e).forEach(function(t){if(!Ct(t)){delete e[t]}});if(!l(e)){var n=this.createEvent({data:e});v(window,"BX.Landing.Block:beforeApplyContentChanges",[n])}Object.keys(t).forEach(function(e){if(Ct(e)){var n=this.nodes.getBySelector(e);if(n){n.setValue(t[e],true,true);t[e]=n.getValue()}}},this);return Promise.resolve(t)},applyCardsChanges:function(t){if(!s(t)){return Promise.reject(new TypeError("BX.Landing.Block.applyCardsChanges: data isn't object"))}if("cards"in t&&s(t.cards)){v("BX.Landing.Block:Cards:beforeUpdate",[this.createEvent()]);var e={};Object.keys(t.cards).forEach(function(n){var i=this.node.querySelector(n).parentElement;var o=this.node.querySelectorAll(n);var r=t.cards[n].values;var d=t.cards[n].presets;var h=t.cards[n].indexes;var u=t.cards[n].source;i.innerHTML="";Object.keys(r).forEach(function(t){u[t]={value:0,type:"card"};if(!l(d)&&!l(d[t])&&!o[h[t]]){u[t].type="preset";u[t].value=d[t];return}if(o[h[t]]){u[t].type="card";u[t].value=h[t]}},this);Object.keys(r).forEach(function(t){if(u[t].type==="preset"){var e=this.manifest.cards[n]["presets"][u[t].value]["html"];a(R(e),i);return}a(F(o[u[t].value]),i)},this);this.initNodes();this.initCards();this.initGroups();Object.keys(r).forEach(function(t){var n=r[t];Object.keys(n).forEach(function(t){e[t]=t in e?e[t]+1:0;var i=this.nodes.getBySelector(A(t,"@",e[t]));if(i){var a=n[t];var o=i.getValue();if(s(a)&&c(a.url)){a.url=N(a.url)}if(s(o)&&c(o.url)){o.url=N(o.url)}try{a=JSON.stringify(a)}catch(e){a=n[t]}try{o=JSON.stringify(o)}catch(t){o=i.getValue()}i.setValue(n[t],true,true);n[A(t,"@",e[t])]=i.getValue();if(i.manifest.type==="img"||i.manifest.type==="icon"){n[A(t,"@",e[t])]["url"]=O(n[t]["url"])}delete n[t]}},this)},this);this.initCardsLabels();this.initStyles();delete t.cards[n].presets;delete t.cards[n].indexes},this);v("BX.Landing.Block:Cards:update",[this.createEvent()])}return Promise.resolve(t)},applySettingsChanges:function(t){if(!s(t)){return Promise.reject(new TypeError("BX.Landing.Block.applyAttributeChanges: requestData isn't object"))}if(s(t.settings)&&!l(t.settings)){if(t.settings.id){this.content.id=t.settings.id}}return Promise.resolve(t)},applyAttributeChanges:function(t){if(!s(t)){return Promise.reject(new TypeError("BX.Landing.Block.applyAttributeChanges: requestData isn't object"))}var e=F(t);Object.keys(t).forEach(function(n){if(!(s(t[n])&&"attrs"in t[n])){delete e[n]}});if(!l(e)){var n=this.createEvent({data:e});v(window,"BX.Landing.Block:beforeApplyAttributesChanges",[n])}var i=this;Object.keys(t).forEach(function(e){if(s(t[e])&&"attrs"in t[e]){var n=i.getElementsBySelector(e);if(!n.length&&e.includes("@")){var a=e.split("@");n=i.getElementsBySelector(a[0]);if(n[parseInt(a[1])]){n=[n[parseInt(a[1])]]}}Object.keys(t[e].attrs).forEach(function(a){n.forEach(function(n){var s=N(t[e]["attrs"][a]);if(!a.includes("data-")){w(n,a,s)}else{S(n,a,s)}v("BX.Landing.Block:Node:updateAttr",[i.createEvent({node:n,data:t[e]["attrs"]})])})})}});return Promise.resolve(t)},saveChanges:function(t){if(!s(t)){return Promise.reject(new TypeError("BX.Landing.Block.saveChanges: data isn't object"))}if(Object.keys(t).length){var e={code:this.manifest.code};var n={block:this.id,data:t,lid:this.lid,siteId:this.siteId};var i={};if(s(t.settings)&&!l(t.settings)){if(t.settings.id){i.changeAnchor={action:"Block::changeAnchor",data:{block:this.id,lid:this.lid,data:t.settings.id}}}delete t.settings}if(!l(t)){var a=new q;Object.keys(n).forEach(function(t){a.add(this.nodes.getBySelector(t))},this);i.updateNodes={action:"Block::updateNodes",data:n,additional:a.fetchAdditionalValues()}}if(!l(t.cards)){var o=F(t.cards);delete t.cards;var r=BX.Landing.Utils.arrayUnique(Object.keys(o));r=r.length===1?r+" *":r.join(" *, ");var c=this.nodes.matches(r).fetchAdditionalValues();i.updateCards={action:"Block::updateCards",data:{block:this.id,lid:this.lid,siteId:this.siteId,data:o,additional:c}}}return BX.Landing.Backend.getInstance().batch("Landing\\Block::updateNodes",i,e).then(function(){return Promise.resolve(t)})}else{return Promise.resolve(t)}},fetchRequestData:function(t,e){var n={};var i={};var a=function(t,e){return e?t:t.fetchChanges()};i.attrs=new Y;i.cards=new Y;i.dynamicCards=new Y;i.dynamicBlock=new Y;i.content=new Y;i.settings=new Y;t.forms.forEach(function(t){i[t.type].push(t)});a(i.content.fetchFields(),e).reduce(V(this.appendContentFieldValue,this),n);var s=new H;i.cards.forEach(function(t){t.childForms.forEach(function(t){t.fields.forEach(function(t){if(t.type==="attr"){s.add(t)}})})});a(s,e).reduce(V(this.appendAttrFieldValue,this),n);i.cards.reduce(V(this.appendCardsFormValue,this),n);i.dynamicCards.reduce(V(this.appendDynamicCardsFormValue,this),n);i.dynamicBlock.reduce(V(this.appendDynamicBlockFormValue,this),n);a(i.attrs.fetchFields(),e).reduce(V(this.appendAttrFieldValue,this),n);a(i.settings.fetchFields(),e).reduce(V(this.appendSettingsFieldValue,this),n);n.dynamicState=Object.keys(this.manifest.cards).reduce(function(t,e){t[e]=BX.type.isPlainObject(n.dynamicParams)&&e in n.dynamicParams;return t},{});n.dynamicState.wrapper=!!n.dynamicParams&&"wrapper"in n.dynamicParams;return Promise.resolve(n)},appendContentFieldValue:function(t,e){return t[e.selector]=e.getValue(),t},appendCardsFormValue:function(t,e){t.cards=t.cards||{};t.cards[e.code]={};t.cards[e.code]["values"]=e.serialize();t.cards[e.code]["presets"]=e.getUsedPresets();t.cards[e.code]["indexes"]=e.getIndexesMap();t.cards[e.code]["source"]={};return t},appendDynamicCardsFormValue:function(t,e){t.dynamicParams=t.dynamicParams||{};t.dynamicParams[e.code]={};t.dynamicParams[e.code]=e.serialize();return t},appendDynamicBlockFormValue:function(t,e){t.dynamicParams=t.dynamicParams||{};t.dynamicParams.wrapper=e.serialize();return t},reload:function(t){if(BX.type.isPlainObject(t)&&!this.containsPseudoSelector(t)){return Promise.resolve(t)}var e=new BX.Loader({target:this.parent.parentElement,color:"rgba(255, 255, 255, .8)"});e.layout.style.position="fixed";e.layout.style.zIndex="999";e.show();BX.Landing.Main.getInstance().showOverlay();var n=this;return BX.Landing.Backend.getInstance().action("Block::getContent",{block:this.id,lid:this.lid,siteId:this.siteId,editMode:1}).then(function(t){var e=this.createEvent();v("BX.Landing.Block:remove",[e]);BX.Landing.Main.getInstance().currentBlock=n;BX.Landing.Main.getInstance().currentArea=n.parent;return BX.Landing.Main.getInstance().addBlock(t,true,true)}.bind(this)).then(function(e){n.node=e;return Promise.resolve(t)}).then(function(t){return new Promise(function(n){setTimeout(function(){n(t);e.hide();BX.Landing.Main.getInstance().hideOverlay()},800)})})},onContentSave:function(){var t=this.panels.get("content_edit");if(t){t.hide();this.fetchRequestData(t).then(this.updateBlockState.bind(this))}},onContentCancel:function(){this.panels.get("content_edit").hide();this.tmpContent.innerHTML=""},getCardsSelector:function(){var t=Object.keys(this.manifest.cards);var e=A(t.join(","),", ");var n=A(t.join(" *,")," *");return A(e,n)},onStyleInput:function(t){this.saveStyles();var e=this.createEvent(t);v("BX.Landing.Block:updateStyle",[e])},getBlockEditForm:function(t){var e={};if(BX.type.isPlainObject(t)){e=Object.assign({},t)}var n=e.nodes||this.nodes;if(this.cards.length>0&&!t.hideCheckbox){n=this.nodes.notMatches(this.getCardsSelector())}var i=Object.keys(this.manifest.nodes);n=i.reduce(function(t,e){n.matches(e).getVisible().filter(function(t){return t.manifest.allowFormEdit!==false}).forEach(function(e){t.push(e)});return t},new q);var a=this.onBlockFormTypeChange.bind(this);var s=!!(!t.skipBlockState&&BX.type.isPlainObject(this.dynamicParams)&&this.dynamicParams.wrapper);var o="";var r=BX.Landing.Main.getInstance().options.helps;if(BX.type.isPlainObject(r)){o=r.DYNAMIC_BLOCKS}var c={text:BX.Landing.Loc.getMessage("LANDING_BLOCK__MAKE_A_DYNAMIC"),onChange:a,state:s,help:o};var d=new at({title:t.formName||BX.Landing.Loc.getMessage("BLOCK_HEADER"),description:this.manifest.block.formDescription,type:"content",code:this.id,headerCheckbox:function(){if(!t.hideCheckbox&&this.manifest.block.dynamic!==false){return c}return undefined}.bind(this)()});if(s){setTimeout(function(){a({form:d,state:true})})}n.forEach(function(t){d.addField(t.getField())});return d},getAttrsEditForm:function(){var t=Object.keys(this.manifest.attrs);var e=[];t.forEach(function(t){var n=this.manifest.attrs[t];if(!n.hidden){n=!d(n)?[n]:n;n.forEach(function(n){if(!n.hidden&&c(n.type)){e.push(this.createAttributeField(n,n.selector||t))}},this)}},this);var n=new at({id:"attr",type:"attrs",title:BX.Landing.Loc.getMessage("BLOCK_SETTINGS"),description:this.manifest.block.attrsFormDescription});e.forEach(function(t){n.addField(t)});return n},getAttrsAdditionalEditForms:function(){var t=Object.keys(this.manifest.attrs);var e=[];t.forEach(function(t){var n=this.manifest.attrs[t];if(!n.hidden){n=!d(n)?[n]:n;n.forEach(function(n){if(!n.hidden&&c(n.type)){return}if(c(n.name)&&n.attrs){e.push(this.createAdditionalForm({form:at,selector:t,group:n,onChange:function(){}}))}},this)}},this);return e},getCardsEditForms:function(t){var e=Object.keys(this.manifest.cards);var n=Object.keys(this.manifest.nodes);var i=[];var a=e.reduce(function(t,e){var n=this.cards.filter(function(t){return t.selector.split("@")[0]===e});if(n.length>0){n.sort(function(t,e){return t.sortIndex-e.sortIndex});t.set(e,n)}return t}.bind(this),new Map);a.forEach(function(e,a){var o=BX.type.isPlainObject(this.dynamicParams)&&a in this.dynamicParams&&!t;var r=this.onCardsFormTypeChange.bind(this);var c=this.manifest.cards[a]["group_label"];var l="";var h=BX.Landing.Main.getInstance().options.helps;if(BX.type.isPlainObject(h)){l=h.DYNAMIC_BLOCKS}var u={text:BX.Landing.Loc.getMessage("LANDING_CARDS__MAKE_A_DYNAMIC"),onChange:r,state:o,help:l};var g=new rt({title:c||BX.Landing.Loc.getMessage("LANDING_CARDS_FROM_TITLE"),code:a.split("@")[0],presets:e[0].manifest.presets,sync:e[0].manifest.sync,description:e[0].manifest.formDescription,forms:i,headerCheckbox:function(){if(this.manifest.block.dynamic!==false){return u}return undefined}.bind(this)()});i.push(g);if(o){setTimeout(function(){r({form:g,state:true})})}e.forEach(function(t){var e=new ot({label:t.getLabel()||t.getName(),labelBindings:t.manifest.label,selector:t.selector,preset:t.preset});var i=new q;var o=this.nodes.filter(function(e){return t.node.contains(e.node)});if(o.length){n.forEach(function(t){var e=o.matches(t);e.forEach(i.add,i)},this);i.forEach(function(t){if(t.manifest.allowFormEdit!==false){e.addField(t.getField())}});var r=this.manifest.cards[a].additional;if(s(r)){if(d(r.attrs)){r.attrs.forEach(function(n){var i=this.createAttributeField(n,t.selector,function(){});i.type="attr";e.addField(i)},this)}}if(this.tmpContent.contains(t.node)){g.addPresetForm(e)}else{g.addChildForm(e)}}},this)},this);return i},getBlockSettingsForm:function(){var t=new at({title:BX.Landing.Loc.getMessage("BLOCK_SETTINGS"),type:"settings"});var e=this.createFieldFactory("!"+this.selector);var n=null;var i=BX.Landing.Main.getInstance().options.url;if(i[0]==="/"){i=top.location.origin+i}var s=A(i,"#",this.anchor||this.node.id);var o=e.create({type:"text",name:BX.Landing.Loc.getMessage("BLOCK_SETTINGS_ANCHOR_FIELD"),description:"<span class='landing-ui-anchor-preview'>"+s+"</span>",attribute:"id",value:this.anchor||this.node.id,onInput:function(){var t=o.layout.querySelector(".landing-ui-anchor-preview");if(t){t.innerHTML=A(i,"#",O(o.getValue()))}this.anchor=o.getValue();if(n){D(n)}if(this.node.id!==o.getValue()&&document.getElementById(o.getValue())){n=BX.Landing.UI.Field.BaseField.createDescription(BX.Landing.Loc.getMessage("BLOCK_SETTINGS_ANCHOR_FIELD_VALIDATE_ERROR"));h(n,"landing-ui-error");a(n,o.layout)}if(!K(o.getValue())){n=BX.Landing.UI.Field.BaseField.createDescription(BX.Landing.Loc.getMessage("BLOCK_SETTINGS_ANCHOR_FIELD_VALIDATE_INVALID_ID"));h(n,"landing-ui-error");a(n,o.layout)}}.bind(this)});t.addField(o);return t},getEditForms:function(t){var e={};if(BX.type.isPlainObject(t)){e=Object.assign({},t)}if(arguments.length>1){e.nodes=arguments[0];e.formName=arguments[1];e.nodesOnly=arguments[2];e.showAll=arguments[3];e.skipCardsState=arguments[4];e.skipBlockState=arguments[5]}var n=new Y;var i=!(this.access<mt||l(this.manifest.nodes)&&l(this.manifest.attrs));if(i){var a=this.getBlockEditForm(e);if(a.fields.length>0){n.add(a)}if(!e.nodesOnly){var s=this.getAttrsEditForm();if(s.fields.length>0){n.add(s)}var o=this.getAttrsAdditionalEditForms();if(o.length>0){o.forEach(function(t){n.add(t)})}var r=this.getCardsEditForms(e.skipCardsState);if(r.length>0){r.forEach(function(t){n.add(t)})}var c=this.getBlockSettingsForm();if(c.fields.length>0){n.push(c)}}}return n},isLastBlockInArea:function(){return this.parent.querySelectorAll(".block-wrapper").length<2},onBlockRemove:function(){this.adjustSortButtonsState()},onBlockInit:function(){this.adjustSortButtonsState()},adjustSortButtonsState:function(){var t=this.panels.get("block_action");if(t){if(this.isLastBlockInArea()){t.buttons.get("up").disable();t.buttons.get("down").disable()}else{t.buttons.get("up").enable();t.buttons.get("down").enable()}}},getFieldType:function(t){var e=this.nodes.getBySelector(t.selector);if(e){return e.type}return null},getTypeReferences:function(t,e){return t.filter(function(t){return t.type===e})},convertReferencesToDropdownItems:function(t){var e=t.map(function(t){return{name:t.name,value:t.id}});e.push({name:BX.Landing.Loc.getMessage("LANDING_BLOCK__DYNAMIC_REFERENCE_HIDE"),html:'<span class="landing-ui-field-dropdown-sep"></span>'+BX.Landing.Loc.getMessage("LANDING_BLOCK__DYNAMIC_REFERENCE_HIDE"),value:"@hide"});return e},getDefaultDropdownItems:function(){return[{name:BX.Landing.Loc.getMessage("LANDING_CARDS__DYNAMIC_FIELD_NOT_SET"),value:""}]},getDynamicFiledValue:function(t,e){var n=this.dynamicParams||{};if(BX.type.isPlainObject(n[t])&&BX.type.isPlainObject(n[t].references)){return n[t].references[e]}},convertToDynamicFields:function(t,e,n){return t.map(function(t){var i=this.getFieldType(t);if(i!=="text"&&i!=="img"&&i!=="link"){return t}var a=this.getTypeReferences(n,i);var s=this.convertReferencesToDropdownItems(a);var o=this.getDynamicFiledValue(e,t.selector);if(i==="link"){if(BX.type.isPlainObject(a[0])&&BX.type.isArray(a[0].actions)){return new BX.Landing.UI.Field.ClickAction({title:t.title,selector:t.selector,reference:a[0],linkField:t,value:o})}return t}if(s.length===0){s=this.getDefaultDropdownItems()}if(i==="img"){return new BX.Landing.UI.Field.DynamicImage({title:t.title,selector:t.selector,dropdownItems:s,value:BX.type.isString(o)?{id:o}:o,hideCheckbox:e==="wrapper"})}return new BX.Landing.UI.Field.Dropdown({title:t.title,selector:t.selector,items:s,content:BX.type.isPlainObject(o)?o.id:o})},this)},createDynamicCardsForm:function(t){var e="";var n=BX.Landing.Main.getInstance().options.helps;if(BX.type.isPlainObject(n)){e=n.DYNAMIC_BLOCKS}var i=new BX.Landing.UI.Form.DynamicCardsForm({title:t.title,code:t.code,type:"dynamicCards",dynamicParams:t.dynamicParams,headerCheckbox:{text:BX.Landing.Loc.getMessage("LANDING_CARDS__MAKE_A_DYNAMIC"),onChange:this.onCardsFormTypeChange.bind(this),state:true,help:e},onSourceChange:function(e){var n=this.convertToDynamicFields(t.form.childForms[0].fields,t.code,e.references);var a=new ut({id:"references",items:n});var s=i.cards.get("references");i.replaceCard(s,a)}.bind(this)});return i},onCardsFormTypeChange:function(t){var e=this.panels.get("content_edit");var n=!!t.state;if(n){var i={};if(BX.type.isPlainObject(this.dynamicParams)&&this.dynamicParams[t.form.code]){i=this.dynamicParams[t.form.code]}var a=Object.assign({},i);if(BX.type.isPlainObject(a.settings)){if(!("pagesCount"in a.settings)){a.settings.pagesCount=t.form.childForms.length}}else{a.settings={pagesCount:t.form.childForms.length}}var s=this.createDynamicCardsForm({title:t.form.title,code:t.form.code,form:t.form,dynamicParams:a});e.replaceForm(t.form,s);return}delete this.dynamicParams[t.form.code];var o=this.getCardsEditForms(true).find(function(e){return e.code===t.form.code});e.replaceForm(t.form,o)},isDynamicCards:function(t){return t in this.dynamicParams},onBlockFormTypeChange:function(t){var e=this.panels.get("content_edit");var n=!!t.state;if(n){var i=this.createDynamicBlockForm({title:t.form.title,code:t.form.code,form:t.form,dynamicParams:this.dynamicParams});e.replaceForm(t.form,i);return}delete this.dynamicParams.wrapper;var a=this.getBlockEditForm({skipBlockState:true});e.replaceForm(t.form,a)},createDynamicBlockForm:function(t){var e="";var n=BX.Landing.Main.getInstance().options.helps;if(BX.type.isPlainObject(n)){e=n.DYNAMIC_BLOCKS}var i=new BX.Landing.UI.Form.DynamicBlockForm({title:t.title,code:this.id,type:"dynamicBlock",dynamicParams:t.dynamicParams,headerCheckbox:{text:BX.Landing.Loc.getMessage("LANDING_BLOCK__MAKE_A_DYNAMIC"),onChange:this.onBlockFormTypeChange.bind(this),state:true,help:e},onSourceChange:function(e){var n=i.cards.get("references");if(BX.type.isPlainObject(e)){var a=this.convertToDynamicFields(t.form.fields,"wrapper",e.references);var s=new ut({id:"references",items:a});i.replaceCard(n,s);return}i.removeCard(n)}.bind(this)});return i},isDynamic:function(t){t=t||this.id;var e=this.panels.get("content_edit");if(e){var n=e.forms.toArray().find(function(e){return e.code===t});if(n){return n.isDynamicEnabled()}}t=t===this.id?"wrapper":t;return!!this.dynamicParams&&t in this.dynamicParams}}})();
//# sourceMappingURL=block.map.js