this.BX=this.BX||{};this.BX.Landing=this.BX.Landing||{};this.BX.Landing.UI=this.BX.Landing.UI||{};(function(e,t,n,i,r,a,s,o,u,l,d,c,g,m){"use strict";function h(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span class="landing-ui-field-agreements-list-actions-button" onclick="','">\n\t\t\t\t\t',"\n\t\t\t\t</span>\n\t\t\t"]);h=function t(){return e};return e}function f(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span class="landing-ui-field-agreements-list-actions-button" onclick="','">\n\t\t\t\t\t',"\n\t\t\t\t</span>\n\t\t\t"]);f=function t(){return e};return e}function p(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-field-agreements-list-actions-container">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"]);p=function t(){return e};return e}function v(){var e=babelHelpers.taggedTemplateLiteral(['<div class="landing-ui-field-agreements-list-container"></div>']);v=function t(){return e};return e}var L=function(e){babelHelpers.inherits(i,e);function i(e){var n;babelHelpers.classCallCheck(this,i);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this,e));n.setEventNamespace("BX.Landing.UI.Field.AgreementsList");n.onSelectAgreementClick=n.onSelectAgreementClick.bind(babelHelpers.assertThisInitialized(n));n.onCreateAgreementClick=n.onCreateAgreementClick.bind(babelHelpers.assertThisInitialized(n));n.onUserConsentEditSave=n.onUserConsentEditSave.bind(babelHelpers.assertThisInitialized(n));n.onUserConsentEditCancel=n.onUserConsentEditCancel.bind(babelHelpers.assertThisInitialized(n));n.onItemRemoveClick=n.onItemRemoveClick.bind(babelHelpers.assertThisInitialized(n));n.onDragEnd=n.onDragEnd.bind(babelHelpers.assertThisInitialized(n));n.items=[];t.Dom.replace(n.input,n.getListContainer());t.Dom.append(n.getActionsContainer(),n.layout);void n.showAgreementLoader();o.FormClient.getInstance().prepareOptions(n.options.formOptions,n.options.value).then(function(e){return e.data.agreements.map(function(e,i){return t.Runtime.merge(e,n.options.value[i])})}).then(function(e){void n.hideAgreementLoader();e.forEach(function(e){n.addItem(e)})});n.draggable=new r.Draggable({context:window.parent,container:n.getListContainer(),draggable:".landing-ui-component-list-item",dragElement:".landing-ui-button-icon-drag",type:r.Draggable.MOVE,offset:{y:-62}});n.draggable.subscribe("end",n.onDragEnd);var a=t.Reflection.getClass("top.BX.addCustomEvent");a(window.top,"main-user-consent-to-list",n.onUserConsentEditCancel);a(window.top,"main-user-consent-saved",n.onUserConsentEditSave);return n}babelHelpers.createClass(i,[{key:"getAgreementsList",value:function e(){var t=this;return this.cache.remember("agreementsList",function(){return t.options.agreementsList})}},{key:"setAgreementsList",value:function e(t){this.cache.set("agreementsList",t)}},{key:"loadAgreementsList",value:function e(){return g.Backend.getInstance().action("Form::getAgreements").then(function(e){return t.Runtime.orderBy(e,["id"],["asc"])})}},{key:"getAgreementById",value:function e(t){return this.getAgreementsList().find(function(e){return String(t)===String(e.id)})}},{key:"addItem",value:function e(t){var n=this.createItem(t);n.appendTo(this.getListContainer());this.items=this.items.filter(function(e){return String(e.options.id)!==String(n.options.id)});this.items.push(n)}},{key:"getListContainer",value:function e(){return this.cache.remember("listContainer",function(){return t.Tag.render(v())})}},{key:"getActionsContainer",value:function e(){var n=this;return this.cache.remember("actionsContainer",function(){return t.Tag.render(p(),n.getSelectAgreementButton(),n.getCreateAgreementButton())})}},{key:"getSelectAgreementButton",value:function e(){var n=this;return this.cache.remember("selectAgreementButton",function(){return t.Tag.render(f(),n.onSelectAgreementClick,t.Loc.getMessage("LANDING_AGREEMENT_LIST_SELECT_BUTTON_LABEL"))})}},{key:"getCreateAgreementButton",value:function e(){var n=this;return this.cache.remember("createAgreementButton",function(){return t.Tag.render(h(),n.onCreateAgreementClick,t.Loc.getMessage("LANDING_AGREEMENT_LIST_CREATE_BUTTON_LABEL"))})}},{key:"getSelectedAgreements",value:function e(){return babelHelpers.toConsumableArray(this.getListContainer().children).map(function(e){return t.Dom.attr(e,"data-value")})}},{key:"getAgreementsMenu",value:function e(){var i=this;return this.cache.remember("agreementsMenu",function(){var e=new n.Menu({bindElement:i.getSelectAgreementButton(),autoHide:true,maxWidth:400,maxHeight:205,events:{onPopupShow:function n(){setTimeout(function(){t.Dom.style(e.getMenuContainer(),{left:"0px",right:"auto",top:"30px"})})}}});i.getAgreementsList().filter(function(e){return!i.items.some(function(t){return String(t.options.id)===String(e.id)})}).forEach(function(t){e.addMenuItem({id:t.id,text:t.name,onclick:i.onAgreementsMenuItemClick.bind(i,t)})});t.Dom.append(e.getMenuContainer(),i.getActionsContainer());return e})}},{key:"refreshAgreementsMenu",value:function e(){var t=this.getAgreementsMenu();t.close();t.destroy();this.cache.delete("agreementsMenu")}},{key:"createItemForm",value:function e(n){var i=this;return new s.FormSettingsForm({id:n.id,title:t.Loc.getMessage("LANDING_AGREEMENT_FORM_TITLE"),onChange:function e(){i.emit("onChange",{skipPrepare:true})},serializeModifier:function e(t){if(t.type==="type1"){return{checked:true,required:true}}if(t.type==="type2"){return{checked:false,required:true}}if(t.type==="type3"){return{checked:true,required:false}}if(t.type==="type4"){return{checked:false,required:false}}},fields:[new a.RadioButtonField({selector:"type",value:function(){if(n.checked===true&&n.required===true){return"type1"}if(n.checked===false&&n.required===true){return"type2"}if(n.checked===true&&n.required===false){return"type3"}if(n.checked===false&&n.required===false){return"type4"}}(),items:[{id:"type1",title:t.Loc.getMessage("LANDING_AGREEMENT_FORM_TYPE_FIELD_ITEM_1"),icon:"landing-ui-agreement-type-1-icon"},{id:"type2",title:t.Loc.getMessage("LANDING_AGREEMENT_FORM_TYPE_FIELD_ITEM_2"),icon:"landing-ui-agreement-type-2-icon"},{id:"type3",title:t.Loc.getMessage("LANDING_AGREEMENT_FORM_TYPE_FIELD_ITEM_3"),icon:"landing-ui-agreement-type-3-icon"},{id:"type4",title:t.Loc.getMessage("LANDING_AGREEMENT_FORM_TYPE_FIELD_ITEM_4"),icon:"landing-ui-agreement-type-4-icon"}]}),new l.ActionPanel({left:[{id:"edit",text:t.Loc.getMessage("LANDING_AGREEMENT_EDIT_BUTTON_LABEL"),onClick:function e(){return i.editAgreement(n)}},{id:"list",text:t.Loc.getMessage("LANDING_AGREEMENT_CONSENTS_BUTTON_LABEL"),onClick:function e(){return i.openConsentsList(n)}}]})]})}},{key:"getAgreementLoader",value:function e(){return this.cache.remember("agreementLoader",function(){return new c.Loader({size:50,mode:"inline",offset:{top:"5px",left:"225px"}})})}},{key:"showAgreementLoader",value:function e(){var n=this.getAgreementLoader();var i=this.getListContainer();t.Dom.append(n.layout,i);return n.show(i)}},{key:"hideAgreementLoader",value:function e(){var n=this.getAgreementLoader();t.Dom.remove(n.layout);return n.hide()}},{key:"onAgreementsMenuItemClick",value:function e(t){var n=this;void this.showAgreementLoader();o.FormClient.getInstance().prepareOptions(this.options.formOptions,{agreements:[{id:t.id}]}).then(function(e){void n.hideAgreementLoader();n.addItem(e.data.agreements[0]);n.emit("onChange",{skipPrepare:true})});this.refreshAgreementsMenu()}},{key:"onSelectAgreementClick",value:function e(t){t.preventDefault();var n=this.getAgreementsMenu();if(!n.getPopupWindow().isShown()){n.show()}else{n.close()}}},{key:"onCreateAgreementClick",value:function e(t){t.preventDefault();this.editAgreement({id:0})}},{key:"onItemHeaderClick",value:function e(n,i){i.preventDefault();var r=i.currentTarget.parentElement;t.Dom.toggleClass(r,"landing-ui-field-agreements-list-item-active")}},{key:"createItem",value:function e(t){var n=this.getAgreementById(t.id);return new u.ListItem({id:t.id,title:n.name,description:n.labelText,sourceOptions:t,draggable:true,editable:true,removable:true,form:this.createItemForm(t),onRemove:this.onItemRemoveClick})}},{key:"setCurrentlyEdited",value:function e(t){this.cache.set("setCurrentlyEdited",t)}},{key:"getCurrentlyEdited",value:function e(){return this.cache.get("setCurrentlyEdited")||null}},{key:"buildEditPath",value:function e(t){return"/settings/configs/userconsent/edit/".concat(t,"/")}},{key:"buildConsentsListPath",value:function e(t){return"/settings/configs/userconsent/consents/".concat(t,"/")}},{key:"editAgreement",value:function e(t){this.setCurrentlyEdited(t);var n=this.buildEditPath(t.id);BX.SidePanel.Instance.open(n,{cacheable:false,allowChangeHistory:false})}},{key:"closeEditAgreementSlider",value:function e(){var n=this.getCurrentlyEdited();if(t.Type.isPlainObject(n)){var i=this.buildEditPath(n.id);var r=BX.SidePanel.Instance.getSlider(i);if(r){r.close()}}}},{key:"openConsentsList",value:function e(t){var n=this.buildConsentsListPath(t.id);BX.SidePanel.Instance.open(n,{cacheable:false,allowChangeHistory:false})}},{key:"onUserConsentEditCancel",value:function e(){this.closeEditAgreementSlider()}},{key:"onUserConsentEditSave",value:function e(){var n=this;this.closeEditAgreementSlider();void this.showAgreementLoader();var i=this.getValue();this.loadAgreementsList().then(function(e){n.setAgreementsList(e);m.FormSettingsPanel.getInstance().setAgreements(e);var r=n.getCurrentlyEdited();if(r&&r.id===0){var a=babelHelpers.toConsumableArray(e).pop();o.FormClient.getInstance().prepareOptions(n.options.formOptions,{agreements:[a]}).then(function(e){void n.hideAgreementLoader();n.addItem(e.data.agreements[0]);n.refreshAgreementsMenu();n.emit("onChange",{skipPrepare:true})})}else{t.Dom.clean(n.getListContainer());void n.showAgreementLoader();o.FormClient.getInstance().prepareOptions(n.options.formOptions,{agreements:i}).then(function(e){void n.hideAgreementLoader();n.items=[];i.forEach(function(t){var i=e.data.agreements.find(function(e){return String(e.id)===String(t.id)});if(i){n.addItem(babelHelpers.objectSpread({},i,{checked:t.checked,required:t.required}))}else{n.addItem(t)}});n.refreshAgreementsMenu();n.emit("onChange",{skipPrepare:true})})}})}},{key:"onItemRemoveClick",value:function e(t){var n=t.getTarget().getValue();this.items=this.items.filter(function(e){return String(e.options.id)!==String(n.id)});this.refreshAgreementsMenu();this.emit("onItemRemove",{item:n});this.emit("onChange",{skipPrepare:true})}},{key:"onDragEnd",value:function e(){var n=this;var i=this.items;this.items=[];babelHelpers.toConsumableArray(this.getListContainer().children).forEach(function(e){var r=t.Dom.attr(e,"data-id");var a=i.find(function(e){return String(e.options.id)===String(r)});if(a){n.items.push(a)}});this.emit("onChange",{skipPrepare:true})}},{key:"getValue",value:function e(){return this.items.map(function(e){return e.getValue()})}}]);return i}(i.BaseField);e.AgreementsList=L})(this.BX.Landing.UI.Field=this.BX.Landing.UI.Field||{},BX,BX.Main,BX.Landing.UI.Field,BX.UI.DragAndDrop,BX.Landing.UI.Field,BX.Landing.UI.Form,BX.Crm.Form,BX.Landing.UI.Component,BX.Landing.UI.Component,BX.Event,BX,BX.Landing,BX.Landing.UI.Panel);
//# sourceMappingURL=agreementslist.bundle.map.js