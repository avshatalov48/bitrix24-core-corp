this.BX=this.BX||{};this.BX.Landing=this.BX.Landing||{};this.BX.Landing.UI=this.BX.Landing.UI||{};(function(e,t,i,n,r,a,s,o,l,d,u,c,g,p,f,L,m){"use strict";function I(){var e=babelHelpers.taggedTemplateLiteral(['<div class="landing-ui-field-fields-list-container"></div>']);I=function t(){return e};return e}function h(){var e=babelHelpers.taggedTemplateLiteral(['<div><div class="crm-webform-resourcebooking-wrap"></div></div>']);h=function t(){return e};return e}var b=function(e){babelHelpers.inherits(t,e);function t(e){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));n.setEventNamespace("BX.Landing.UI.Field.FieldsListField");n.setLayoutClass("landing-ui-field-fields-list");n.onSelectFieldButtonClick=n.onSelectFieldButtonClick.bind(babelHelpers.assertThisInitialized(n));n.onSelectProductsButtonClick=n.onSelectProductsButtonClick.bind(babelHelpers.assertThisInitialized(n));n.onSelectSeparatorButtonClick=n.onSelectSeparatorButtonClick.bind(babelHelpers.assertThisInitialized(n));n.onItemRemove=n.onItemRemove.bind(babelHelpers.assertThisInitialized(n));n.onItemEdit=n.onItemEdit.bind(babelHelpers.assertThisInitialized(n));n.onDragEnd=n.onDragEnd.bind(babelHelpers.assertThisInitialized(n));n.onFormChange=n.onFormChange.bind(babelHelpers.assertThisInitialized(n));n.items=[];n.options.items.forEach(function(e){n.addItem(e)});n.actionPanel=new o.ActionPanel({renderTo:n.layout,left:[{id:"selectField",text:i.Loc.getMessage("LANDING_FIELDS_SELECT_FIELD_BUTTON_TITLE"),onClick:n.onSelectFieldButtonClick}],right:[{id:"addProducts",text:i.Loc.getMessage("LANDING_FIELDS_SELECT_PRODUCTS_BUTTON_TITLE"),onClick:n.onSelectProductsButtonClick},{id:"selectSeparator",text:i.Loc.getMessage("LANDING_FIELDS_SELECT_SEPARATOR_BUTTON_TITLE"),onClick:n.onSelectSeparatorButtonClick}]});n.draggable=new r.Draggable({context:window.parent,container:n.getListContainer(),draggable:".landing-ui-component-list-item",dragElement:".landing-ui-button-icon-drag",type:r.Draggable.MOVE,offset:{y:-62}});n.draggable.subscribe("end",n.onDragEnd);return n}babelHelpers.createClass(t,[{key:"createInput",value:function e(){return this.getListContainer()}},{key:"getCrmFieldById",value:function e(t){return Object.values(this.options.crmFields).reduce(function(e,t){return[].concat(babelHelpers.toConsumableArray(e),babelHelpers.toConsumableArray(t.FIELDS))},[]).find(function(e){return e.name===t})}},{key:"getCrmFieldCategoryById",value:function e(t){return this.options.crmFields[t]}},{key:"addItem",value:function e(t){var i=this;return this.createItem(t).then(function(e){i.items.push(e);n.Dom.append(e.getLayout(),i.getListContainer())})}},{key:"prependItem",value:function e(t){var i=this;return this.createItem(t).then(function(e){i.items.unshift(e);n.Dom.prepend(e.getLayout(),i.getListContainer())})}},{key:"insertItemAfterIndex",value:function e(t,i){var r=this;return this.createItem(t).then(function(e){r.items.splice(i+1,0,e);n.Dom.insertAfter(e.getLayout(),r.getListContainer().childNodes[i])})}},{key:"isFieldAvailable",value:function e(t){if(n.Type.isStringFilled(t)){if(t.startsWith("product_")){return true}return n.Type.isPlainObject(this.getCrmFieldById(t))}return false}},{key:"getFieldItemTitle",value:function e(t){if(this.isFieldAvailable(t)){if(t.startsWith("product_")){return i.Loc.getMessage("LANDING_FIELDS_LIST_FIELD_PRODUCTS_TITLE")}var n=this.getCrmFieldById(t);var r=this.getCrmFieldCategoryById(n.entity_name);return"".concat(n.caption," \xb7 ").concat(r.CAPTION)}return""}},{key:"createResourceBookingFieldController",value:function e(t){if(t.type==="resourcebooking"){var i=f.PageObject.getRootWindow();var r=this.getCrmFieldById(t.id);return i.BX.Calendar.ResourcebookingUserfield.initCrmFormFieldController({field:babelHelpers.objectSpread({},t,{dict:r,node:n.Tag.render(h())})})}return null}},{key:"createItem",value:function e(r){var a={id:r.id,type:r.type?r.type:"",content:r.content,sourceOptions:babelHelpers.objectSpread({},r),draggable:true,removable:true,onRemove:this.onItemRemove,onEdit:this.onItemEdit,onFormChange:this.onFormChange,form:this.createFieldSettingsForm(r)};if(!t.isSeparator(r.id)){if(this.isFieldAvailable(r.id)){a.title=this.getFieldItemTitle(r.id);var o=this.getCrmFieldById(r.id);a.description=r.label||o.caption;a.editable=true;a.isSeparator=false;a.fieldController=this.createResourceBookingFieldController(r);var l=new s.ListItem(a);if(a.fieldController){return new Promise(function(e){if(n.Type.isFunction(a.fieldController.subscribe)){a.fieldController.subscribe("afterInit",function(t){r.booking.settings_data=t.getData().settings.data;e(l)})}else{e(l)}})}return Promise.resolve(l)}a.editable=false;a.isSeparator=false;a.title="";a.description=i.Loc.getMessage("LANDING_FIELDS_ITEM_FIELD_UNAVAILABLE");a.error=true;var d=new s.ListItem(a);return Promise.resolve(d)}a.isSeparator=true;a.editable=!String(r.id).startsWith("hr_");a.title=t.getSeparatorTitle(r.id);if(n.Type.isString(r.label)){a.description=r.label}else if(String(r.id).startsWith("hr_")){a.description=t.getSeparatorTitle(r.id)}else{var u=this.getCrmFieldById(r.id);if(n.Type.isPlainObject(u)&&n.Type.isString(u.caption)){a.description=u.caption}else{a.description=""}}var c=new s.ListItem(a);return Promise.resolve(c)}},{key:"createFieldSettingsForm",value:function e(t){var r=[];if(t.type==="product"){r.push(new m.ProductField({title:i.Loc.getMessage("LANDING_FIELDS_LIST_FIELD_PRODUCTS_TITLE2"),selector:"products",items:t.editing.catalog||[],iblockId:this.options.dictionary.catalog.id}))}if(t.editing.hasLabel){r.push(new l.TextField({selector:"label",title:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_LABEL_FIELD_TITLE"),content:t.label,textOnly:true}))}if(t.editing.canBeRequired){r.push(new BX.Landing.UI.Field.Checkbox({selector:"required",compact:true,items:[{name:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_REQUIRED_FIELD_TITLE"),value:"required"}],value:t.required?["required"]:[]}))}if(t.editing.canBeMultiple){r.push(new BX.Landing.UI.Field.Checkbox({selector:"multiple",compact:true,items:[{name:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_MULTIPLE_FIELD_TITLE"),value:"multiple"}],value:t.multiple?["multiple"]:[]}))}if(t.editing.hasStringDefaultValue){r.push(new l.TextField({selector:"value",title:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_DEFAULT_VALUE_FIELD_TITLE"),content:t.value,textOnly:true}))}if(t.type==="product"){r.push(new BX.Landing.UI.Field.Checkbox({selector:"bigPic",compact:true,items:[{name:i.Loc.getMessage("LANDING_FIELDS_LIST_FIELD_PRODUCTS_SHOW_BIG_PICTURE"),value:"bigPic"}],value:t.bigPic?["bigPic"]:[]}))}if((t.type==="list"||t.type==="radio")&&t.editing.items.length>0){var a=new BX.Landing.UI.Field.Dropdown({selector:"value",title:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_LIST_DEFAULT_VALUE_TITLE"),content:t.value,items:[{value:i.Loc.getMessage("LANDING_FORM_DEFAULT_VALUE_NOT_SELECTED"),id:null}].concat(babelHelpers.toConsumableArray(t.editing.items)).map(function(e){return{name:e.value,value:e.id}})});r.push(new g.ListSettingsField({selector:"items",title:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_LIST_SETTINGS_TITLE"),items:function(){return t.editing.items.map(function(e){var i=t.items.find(function(t){return String(t.value)===String(e.id)});var n=!!i;return{name:n?i.label:e.value,value:e.id,checked:n}})}()}));r.push(a)}if(n.Type.isPlainObject(t.editing)&&n.Type.isArrayFilled(t.editing.valueTypes)){r.push(new BX.Landing.UI.Field.Dropdown({selector:"valueType",title:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_VALUE_TYPE"),content:t.editing.editable.valueType,items:t.editing.valueTypes.map(function(e){return{name:e.name,value:e.id}})}))}if(t.type==="file"&&n.Type.isArrayFilled(this.options.dictionary.contentTypes)){r.push(new BX.Landing.UI.Field.Checkbox({selector:"contentTypes",title:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_ALLOWED_FILE_TYPE"),value:t.contentTypes,items:this.options.dictionary.contentTypes.map(function(e){return{name:e.name,value:e.id}})}))}return new u.FormSettingsForm({fields:r,serializeModifier:function e(t){var i=babelHelpers.objectSpread({},t);if(Reflect.has(t,"label")){i.label=n.Text.decode(t.label)}if(Reflect.has(t,"required")){i.required=t.required.includes("required")}if(Reflect.has(t,"multiple")){i.multiple=t.multiple.includes("multiple")}if(Reflect.has(t,"bigPic")){i.bigPic=t.bigPic.includes("bigPic")}if(Reflect.has(t,"value")&&n.Type.isArrayFilled(t.items)){i.items=i.items.map(function(e){e.selected=t.value===e.value;return e})}if(Reflect.has(t,"products")){i.items=n.Runtime.clone(t.products);if(!n.Type.isPlainObject(i.editing)){i.editing={}}i.editing.catalog=n.Runtime.clone(t.products)}if(Reflect.has(t,"valueType")){if(!n.Type.isPlainObject(i.editing)){i.editing={}}if(!n.Type.isPlainObject(i.editing.editable)){i.editing.editable={}}i.editing.editable.valueType=t.valueType}return i}})}},{key:"getListContainer",value:function e(){return this.cache.remember("listContainer",function(){return n.Tag.render(I())})}},{key:"onSelectFieldButtonClick",value:function e(t){var i=this;t.preventDefault();a.FieldsPanel.getInstance({isLeadEnabled:this.options.isLeadEnabled}).show({disabledFields:this.items.map(function(e){return e.options.id})}).then(function(e){if(n.Type.isArrayFilled(e)){i.onFieldsSelect(e)}})}},{key:"onFieldsSelect",value:function e(t){var i=this;var n={fields:t.map(function(e){return{name:e}})};void this.showLoader();c.FormClient.getInstance().prepareOptions(this.options.formOptions,n).then(function(e){void i.hideLoader();return Promise.all(e.data.fields.map(function(e){return i.addItem(e)}))}).then(function(){i.emit("onChange",{skipPrepare:true})})}},{key:"getValue",value:function e(){return this.items.map(function(e){return e.getValue()})}},{key:"onSelectProductsButtonClick",value:function e(t){var i=this;t.preventDefault();var n={fields:[{type:"product"}]};void this.showLoader();c.FormClient.getInstance().prepareOptions(this.options.formOptions,n).then(function(e){void i.hideLoader();var t=e.data.fields.map(function(e){return i.addItem(e)});Promise.all(t).then(function(){i.emit("onChange",{skipPrepare:true})})})}},{key:"onSelectSeparatorButtonClick",value:function e(t){var n=this;t.preventDefault();p.SeparatorPanel.getInstance().show().then(function(e){var t=[e];if(e.type==="page"&&!n.items.find(function(e){return e.options.type==="page"})){t.push(babelHelpers.objectSpread({},t[0]))}void n.showLoader();c.FormClient.getInstance().prepareOptions(n.options.formOptions,{fields:t}).then(function(t){void n.hideLoader();var r=Promise.resolve();if(e.type==="page"&&!n.items.find(function(e){return e.options.type==="page"})){t.data.fields[0].label=i.Loc.getMessage("LANDING_FIELDS_ITEM_PAGE_TITLE").replace("#number#",1);t.data.fields[1].label=i.Loc.getMessage("LANDING_FIELDS_ITEM_PAGE_TITLE").replace("#number#",2);r=Promise.all([n.prependItem(t.data.fields[0]),n.insertItemAfterIndex(t.data.fields[1],1)])}else{t.data.fields.forEach(function(e){var t=e.id.split("_"),a=babelHelpers.slicedToArray(t,1),s=a[0];var o=n.items.filter(function(e){return e.options.id.startsWith(s)}).length;if(s==="page"){e.label=i.Loc.getMessage("LANDING_FIELDS_ITEM_PAGE_TITLE").replace("#number#",o+1)}if(s==="section"){e.label=i.Loc.getMessage("LANDING_FIELDS_ITEM_SECTION_TITLE").replace("#number#",o+1)}if(s==="hr"){e.label=i.Loc.getMessage("LANDING_FIELDS_ITEM_LINE_TITLE").replace("#number#",o+1)}r=n.addItem(e)})}r.then(function(){n.emit("onChange",{skipPrepare:true})})})})}},{key:"onItemRemove",value:function e(t){this.items=this.items.filter(function(e){return e!==t.getTarget()});this.emit("onChange",{skipPrepare:true})}},{key:"onItemEdit",value:function e(t){var i=this;var r=t.getTarget(),a=r.options;if(a.fieldController){t.preventDefault();a.fieldController.showSettingsPopup();setTimeout(function(){a.fieldController.settingsPopup.subscribeOnce("onClose",function(){a.sourceOptions.booking.settings_data=a.fieldController.getSettings().data;var e=a.sourceOptions.booking.settings_data;Object.keys(e).forEach(function(t){if(n.Type.isArray(e[t].value)){e[t].value=e[t].value.join("|")}});i.emit("onChange",{skipPrepare:true})})},1e3)}}},{key:"onFormChange",value:function e(t){this.emit("onChange",{skipPrepare:true});var i=t.getTarget();var n=i.getValue();i.setDescription(n.label)}},{key:"onDragEnd",value:function e(){var t=this;setTimeout(function(){t.items=babelHelpers.toConsumableArray(t.getListContainer().children).map(function(e){var i=n.Dom.attr(e,"data-id");return t.items.find(function(e){return e.options.id===i})});t.emit("onChange",{skipPrepare:true})})}},{key:"getLoader",value:function e(){return this.cache.remember("loader",function(){return new L.Loader({size:50,mode:"inline",offset:{top:"5px",left:"225px"}})})}},{key:"showLoader",value:function e(){var t=this.getLoader();var i=this.getListContainer();n.Dom.append(t.layout,i);return t.show(i)}},{key:"hideLoader",value:function e(){var t=this.getLoader();n.Dom.remove(t.layout);return t.hide()}}],[{key:"isSeparator",value:function e(t){if(n.Type.isStringFilled(t)){return t.startsWith("hr")||t.startsWith("section")||t.startsWith("page")}return false}},{key:"getSeparatorTitle",value:function e(t){if(n.Type.isStringFilled(t)){if(t.startsWith("hr")){return i.Loc.getMessage("LANDING_SEPARATOR_SOLID_LINE")}if(t.startsWith("section")){return i.Loc.getMessage("LANDING_SEPARATOR_HEADER")}if(t.startsWith("page")){return i.Loc.getMessage("LANDING_SEPARATOR_PAGE")}}return i.Loc.getMessage("LANDING_FIELDS_LIST_FIELD_SEPARATOR_TITLE")}}]);return t}(t.BaseField);e.FieldsListField=b})(this.BX.Landing.UI.Field=this.BX.Landing.UI.Field||{},BX.Landing.UI.Field,BX.Landing,BX,BX.UI.DragAndDrop,BX.Landing.UI.Panel,BX.Landing.UI.Component,BX.Landing.UI.Component,BX.Landing.UI.Field,BX.Event,BX.Landing.UI.Form,BX.Crm.Form,BX.Landing.UI.Field,BX.Landing.UI.Panel,BX.Landing,BX,BX.Landing.Ui.Field);
//# sourceMappingURL=fieldslistfield.bundle.map.js