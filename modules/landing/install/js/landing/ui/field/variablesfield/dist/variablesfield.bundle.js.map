{"version":3,"file":"variablesfield.bundle.js","sources":["../src/variablesfield.js"],"sourcesContent":["import {TextField} from 'landing.ui.field.textfield';\nimport {Dom, Tag, Event} from 'main.core';\nimport {BaseButton} from 'landing.ui.button.basebutton';\nimport {Menu} from 'main.popup';\nimport {PageObject} from 'landing.pageobject';\n\nimport './css/style.css';\n\nconst instances = Symbol('instances');\n\n/**\n * @memberOf BX.Landing.UI.Field\n */\nexport class VariablesField extends TextField\n{\n\tstatic [instances] = [];\n\n\tconstructor(options)\n\t{\n\t\tsuper({...options, textOnly: true});\n\t\tthis.setEventNamespace('BX.Landing.UI.Field.VariablesField');\n\t\tthis.onButtonClick = this.onButtonClick.bind(this);\n\t\tthis.onTopDocumentClick = this.onTopDocumentClick.bind(this);\n\n\t\tEvent.bind(window.top.document, 'click', this.onTopDocumentClick);\n\n\t\tDom.append(this.getLayout(), this.layout);\n\n\t\tVariablesField[instances].push(this);\n\t}\n\n\tonTopDocumentClick()\n\t{\n\t\t// const rootWindowDocument = PageObject.getRootWindow().document;\n\t\t// if (rootWindowDocument !== this.input.ownerDocument)\n\t\t// {\n\t\t// \tthis.getMenu().close();\n\t\t// \tsuper.onDocumentClick();\n\t\t// }\n\t}\n\n\tonInputClick(event)\n\t{\n\t\t// event.preventDefault();\n\n\t\tthis.lastRange = this.input.ownerDocument.createRange(\n\t\t\tthis.input.innerText.length,\n\t\t\tthis.input.innerText.length,\n\t\t);\n\n\t\tthis.lastRange = this.input.ownerDocument.getSelection().getRangeAt(0);\n\t}\n\n\tgetLayout(): HTMLDivElement\n\t{\n\t\treturn this.cache.remember('layout', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"landing-ui-field landing-ui-field-variables\">\n\t\t\t\t\t<div class=\"landing-ui-field-variables-left\">${this.input}</div>\n\t\t\t\t\t<div class=\"landing-ui-field-variables-right\">${this.getButton()}</div>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetButton(): BaseButton\n\t{\n\t\treturn this.cache.remember('button', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div \n\t\t\t\t\tclass=\"landing-ui-field-variables-button\" \n\t\t\t\t\tonclick=\"${this.onButtonClick}\"\n\t\t\t\t></div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetMenu(): Menu\n\t{\n\t\treturn this.cache.remember('menu', () => {\n\t\t\tconst rootWindow = PageObject.getRootWindow();\n\t\t\tconst menu = new rootWindow.BX.Main.Menu({\n\t\t\t\tbindElement: this.getButton(),\n\t\t\t\ttargetContainer: this.getLayout(),\n\t\t\t\tautoHide: true,\n\t\t\t\titems: this.options.variables.map((variable) => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttext: variable.name,\n\t\t\t\t\t\tonclick: () => {\n\t\t\t\t\t\t\tthis.onVariableClick(variable);\n\t\t\t\t\t\t\tmenu.close();\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t}),\n\t\t\t\tevents: {\n\t\t\t\t\tonPopupShow: () => {\n\t\t\t\t\t\tVariablesField[instances].forEach((item) => {\n\t\t\t\t\t\t\tif (item !== this)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\titem.getMenu().close();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\tDom.style(menu.getMenuContainer(), {\n\t\t\t\t\t\t\t\tleft: 'auto',\n\t\t\t\t\t\t\t\tright: '0px',\n\t\t\t\t\t\t\t\ttop: '30px',\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\n\t\t\treturn menu;\n\t\t});\n\t}\n\n\tonInputInput()\n\t{\n\t\tconst currentDocument = this.getLayout().ownerDocument;\n\t\tthis.lastRange = currentDocument.getSelection().getRangeAt(0);\n\t\tsuper.onInputInput();\n\t}\n\n\tonVariableClick(variable)\n\t{\n\t\tthis.enableEdit();\n\t\tthis.input.focus();\n\t\tconst currentDocument = this.getLayout().ownerDocument;\n\n\t\tif (this.lastRange)\n\t\t{\n\t\t\tcurrentDocument.getSelection().removeAllRanges();\n\t\t\tcurrentDocument.getSelection().addRange(this.lastRange);\n\t\t}\n\n\t\tcurrentDocument.execCommand('insertText', null, ` ${variable.value} `);\n\t}\n\n\tonButtonClick(event: MouseEvent)\n\t{\n\t\tevent.preventDefault();\n\t\tevent.stopPropagation();\n\n\t\tif (!this.lastRange && this.input.innerText.length)\n\t\t{\n\t\t\tconst currentDocument = this.input.ownerDocument;\n\t\t\tcurrentDocument.getSelection().collapse(this.input.childNodes[0], this.input.innerText.length);\n\t\t\tthis.lastRange = currentDocument.getSelection().getRangeAt(0);\n\t\t}\n\n\t\tconst menu = this.getMenu();\n\t\tif (menu.getPopupWindow().isShown())\n\t\t{\n\t\t\tthis.getMenu().close();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.getMenu().show();\n\t\t}\n\t}\n\n\tgetValue(): string\n\t{\n\t\treturn this.input.innerText;\n\t}\n}"],"names":["instances","Symbol","VariablesField","options","textOnly","setEventNamespace","onButtonClick","bind","onTopDocumentClick","Event","window","top","document","Dom","append","getLayout","layout","push","event","lastRange","input","ownerDocument","createRange","innerText","length","getSelection","getRangeAt","cache","remember","Tag","render","getButton","rootWindow","PageObject","getRootWindow","menu","BX","Main","Menu","bindElement","targetContainer","autoHide","items","variables","map","variable","text","name","onclick","onVariableClick","close","events","onPopupShow","forEach","item","getMenu","setTimeout","style","getMenuContainer","left","right","currentDocument","enableEdit","focus","removeAllRanges","addRange","execCommand","value","preventDefault","stopPropagation","collapse","childNodes","getPopupWindow","isShown","show","TextField"],"mappings":"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"}