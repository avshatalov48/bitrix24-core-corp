{"version":3,"file":"variablesfield.bundle.js","sources":["../src/variablesfield.js"],"sourcesContent":["import {TextField} from 'landing.ui.field.textfield';\nimport {Dom, Tag, Event} from 'main.core';\nimport {BaseButton} from 'landing.ui.button.basebutton';\nimport {Menu} from 'main.popup';\n\nimport './css/style.css';\n\nconst instances = Symbol('instances');\n\n/**\n * @memberOf BX.Landing.UI.Field\n */\nexport class VariablesField extends TextField\n{\n\tstatic [instances] = [];\n\n\tconstructor(options)\n\t{\n\t\tsuper({...options, textOnly: true});\n\t\tthis.setEventNamespace('BX.Landing.UI.Field.VariablesField');\n\t\tthis.onButtonClick = this.onButtonClick.bind(this);\n\t\tthis.onTopDocumentClick = this.onTopDocumentClick.bind(this);\n\n\t\tEvent.bind(window.top.document, 'click', this.onTopDocumentClick);\n\n\t\tDom.append(this.getLayout(), this.layout);\n\n\t\tVariablesField[instances].push(this);\n\t}\n\n\tonTopDocumentClick()\n\t{\n\t\tthis.getMenu().close();\n\t\tsuper.onDocumentClick();\n\t}\n\n\tonInputClick(event)\n\t{\n\t\tevent.preventDefault();\n\n\t\tthis.lastRange = this.input.ownerDocument.createRange(\n\t\t\tthis.input.innerText.length,\n\t\t\tthis.input.innerText.length,\n\t\t);\n\n\t\tthis.lastRange = this.input.ownerDocument.getSelection().getRangeAt(0);\n\t}\n\n\tgetLayout(): HTMLDivElement\n\t{\n\t\treturn this.cache.remember('layout', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"landing-ui-field landing-ui-field-variables\">\n\t\t\t\t\t<div class=\"landing-ui-field-variables-left\">${this.input}</div>\n\t\t\t\t\t<div class=\"landing-ui-field-variables-right\">${this.getButton()}</div>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetButton(): BaseButton\n\t{\n\t\treturn this.cache.remember('button', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div \n\t\t\t\t\tclass=\"landing-ui-field-variables-button\" \n\t\t\t\t\tonclick=\"${this.onButtonClick}\"\n\t\t\t\t></div>\n\t\t\t`;\n\t\t});\n\t}\n\n\tgetMenu(): Menu\n\t{\n\t\treturn this.cache.remember('menu', () => {\n\t\t\tconst menu = new Menu({\n\t\t\t\tbindElement: this.getButton(),\n\t\t\t\tautoHide: true,\n\t\t\t\titems: this.options.variables.map((variable) => {\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttext: variable.name,\n\t\t\t\t\t\tonclick: () => {\n\t\t\t\t\t\t\tthis.onVariableClick(variable);\n\t\t\t\t\t\t\tmenu.close();\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t}),\n\t\t\t\tevents: {\n\t\t\t\t\tonPopupShow: () => {\n\t\t\t\t\t\tVariablesField[instances].forEach((item) => {\n\t\t\t\t\t\t\titem.getMenu().close();\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\tDom.style(menu.getMenuContainer(), {\n\t\t\t\t\t\t\t\tleft: 'auto',\n\t\t\t\t\t\t\t\tright: '0px',\n\t\t\t\t\t\t\t\ttop: '30px',\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t});\n\n\t\t\tDom.append(menu.getMenuContainer(), this.getLayout());\n\n\t\t\treturn menu;\n\t\t});\n\t}\n\n\tonInputInput()\n\t{\n\t\tconst currentDocument = this.getLayout().ownerDocument;\n\t\tthis.lastRange = currentDocument.getSelection().getRangeAt(0);\n\t\tsuper.onInputInput();\n\t}\n\n\tonVariableClick(variable)\n\t{\n\t\tthis.enableEdit();\n\t\tthis.input.focus();\n\t\tconst currentDocument = this.getLayout().ownerDocument;\n\n\t\tif (this.lastRange)\n\t\t{\n\t\t\tcurrentDocument.getSelection().removeAllRanges();\n\t\t\tcurrentDocument.getSelection().addRange(this.lastRange);\n\t\t}\n\n\t\tcurrentDocument.execCommand('insertText', null, ` ${variable.value} `);\n\t}\n\n\tonButtonClick(event: MouseEvent)\n\t{\n\t\tevent.preventDefault();\n\t\tevent.stopPropagation();\n\n\t\tif (!this.lastRange && this.input.innerText.length)\n\t\t{\n\t\t\tconst currentDocument = this.input.ownerDocument;\n\t\t\tcurrentDocument.getSelection().collapse(this.input.childNodes[0], this.input.innerText.length);\n\t\t\tthis.lastRange = currentDocument.getSelection().getRangeAt(0);\n\t\t}\n\n\t\tconst menu = this.getMenu();\n\t\tif (menu.getPopupWindow().isShown())\n\t\t{\n\t\t\tthis.getMenu().close();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.getMenu().show();\n\t\t}\n\t}\n}"],"names":["instances","Symbol","VariablesField","options","textOnly","setEventNamespace","onButtonClick","bind","onTopDocumentClick","Event","window","top","document","Dom","append","getLayout","layout","push","getMenu","close","event","preventDefault","lastRange","input","ownerDocument","createRange","innerText","length","getSelection","getRangeAt","cache","remember","Tag","render","getButton","menu","Menu","bindElement","autoHide","items","variables","map","variable","text","name","onclick","onVariableClick","events","onPopupShow","forEach","item","setTimeout","style","getMenuContainer","left","right","currentDocument","enableEdit","focus","removeAllRanges","addRange","execCommand","value","stopPropagation","collapse","childNodes","getPopupWindow","isShown","show","TextField"],"mappings":"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"}