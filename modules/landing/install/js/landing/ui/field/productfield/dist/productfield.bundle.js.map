{"version":3,"file":"productfield.bundle.js","sources":["../src/productfield.js"],"sourcesContent":["import {BaseField} from 'landing.ui.field.basefield';\nimport {ProductForm} from 'catalog.product-form';\nimport {DiscountType} from \"catalog.product-calculator\";\nimport {PageObject} from 'landing.pageobject';\nimport {Dom, Runtime, Type} from 'main.core';\nimport {BaseEvent} from 'main.core.events';\nimport {fetchEventsFromOptions} from 'landing.ui.component.internal';\n\nimport './css/style.css';\n\nexport class ProductField extends BaseField\n{\n\tconstructor(options)\n\t{\n\t\tsuper(options);\n\t\tthis.setEventNamespace('BX.Landing.UI.Field.ProductField');\n\t\tthis.subscribeFromOptions(fetchEventsFromOptions(options));\n\t\tthis.setLayoutClass('landing-ui-field-product');\n\n\t\tthis.onBasketChange = this.onBasketChange.bind(this);\n\n\t\tDom.append(this.getProductSelector().wrapper, this.input);\n\n\t\tthis.setProducts(this.options.items);\n\t\tconst root = PageObject.getRootWindow();\n\t\troot.BX.Event.EventEmitter\n\t\t\t.subscribe(this.getProductSelector(), 'ProductForm:onBasketChange', this.onBasketChange);\n\t}\n\n\tsetProducts(products)\n\t{\n\t\tthis.cache.set('products', Runtime.clone(products));\n\t}\n\n\tgetProducts(): Array<any>\n\t{\n\t\treturn this.cache.get('products') || [];\n\t}\n\n\tonBasketChange(event: BaseEvent)\n\t{\n\t\tconst data = event.getData();\n\t\tthis.setProducts(data.basket);\n\t\tthis.emit('onChange', {skipPrepare: true});\n\t}\n\n\tgetValue()\n\t{\n\t\treturn this.getProducts().reduce((acc, item) => {\n\t\t\tif (!Type.isNil(item.offerId) || !Type.isNil(item.fields.productId))\n\t\t\t{\n\t\t\t\tconst pics = [];\n\t\t\t\tif (item.image && item.image.path)\n\t\t\t\t{\n\t\t\t\t\tpics.push(item.image.path);\n\t\t\t\t}\n\t\t\t\telse if (item.image && item.image.preview)\n\t\t\t\t{\n\t\t\t\t\tlet ic = document.createElement('div');\n\t\t\t\t\tic.innerHTML = item.image.preview;\n\t\t\t\t\tic = ic.querySelector('img');\n\t\t\t\t\tif (ic && ic.src)\n\t\t\t\t\t{\n\t\t\t\t\t\tpics.push(ic.src);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tconst value = item.offerId || item.fields.productId;\n\t\t\t\tif (acc.some(item => item.value === value))\n\t\t\t\t{\n\t\t\t\t\treturn acc;\n\t\t\t\t}\n\n\t\t\t\tacc.push({\n\t\t\t\t\tlabel: item.fields.name,\n\t\t\t\t\tchangeablePrice: false,\n\t\t\t\t\tdiscount: item.fields.discount,\n\t\t\t\t\tpics,\n\t\t\t\t\tprice: item.fields.price,\n\t\t\t\t\tquantity: [],\n\t\t\t\t\tselected: false,\n\t\t\t\t\tvalue,\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn acc;\n\t\t}, []);\n\t}\n\n\tgetProductSelector(): ProductForm\n\t{\n\t\treturn this.cache.remember('productSelector', () => {\n\t\t\tconst root = PageObject.getRootWindow();\n\t\t\treturn new root.BX.Catalog.ProductForm({\n\t\t\t\tiblockId: this.options.iblockId,\n\t\t\t\tshowResults: false,\n\t\t\t\tallowedDiscountTypes: [DiscountType.MONETARY],\n\t\t\t\tbuttonsPosition: 'BOTTOM',\n\t\t\t\tnewItemPosition: 'BOTTOM',\n\t\t\t\tbasket: this.options.items,\n\t\t\t});\n\t\t});\n\t}\n}"],"names":["ProductField","options","setEventNamespace","subscribeFromOptions","fetchEventsFromOptions","setLayoutClass","onBasketChange","bind","Dom","append","getProductSelector","wrapper","input","setProducts","items","root","PageObject","getRootWindow","BX","Event","EventEmitter","subscribe","products","cache","set","Runtime","clone","get","event","data","getData","basket","emit","skipPrepare","getProducts","reduce","acc","item","Type","isNil","offerId","fields","productId","pics","image","path","push","preview","ic","document","createElement","innerHTML","querySelector","src","value","some","label","name","changeablePrice","discount","price","quantity","selected","remember","Catalog","ProductForm","iblockId","showResults","allowedDiscountTypes","DiscountType","MONETARY","buttonsPosition","newItemPosition","BaseField"],"mappings":"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"}