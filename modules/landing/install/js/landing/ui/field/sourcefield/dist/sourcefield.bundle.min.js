this.BX=this.BX||{};this.BX.Landing=this.BX.Landing||{};this.BX.Landing.UI=this.BX.Landing.UI||{};(function(e,t,i,n,r){"use strict";function a(){return{key:"filterStub",name:n.Loc.getMessage("LANDING_BLOCK__SOURCE_FILTER_STUB"),value:""}}function l(e){if(r.Type.isArray(e)){return e.reduce(function(e,t){if(r.Type.isPlainObject(t)&&r.Type.isString(t.name)&&r.Type.isString(t.value)){var i=r.Runtime.clone(t);if(!r.Type.isArray(i.filter)||i.filter.length<=0){i.filter=[r.Runtime.clone(a())]}if(!r.Type.isPlainObject(i.sort)||!r.Type.isArray(i.sort.items)){i.sort={items:[]}}return[].concat(babelHelpers.toConsumableArray(e),[i])}return e},[])}return[]}function o(e,t){return e.reduce(function(e,i){if(r.Type.isPlainObject(i)){return[].concat(babelHelpers.toConsumableArray(e),[babelHelpers.objectSpread({},i,{url:t.url})])}return e},[])}function s(e,t){var i=babelHelpers.slicedToArray(t,1),n=i[0];if(!r.Type.isPlainObject(e)){return{source:n.value,filter:o(babelHelpers.toConsumableArray(n.filter),n),sort:{by:n.sort.items[0].key,order:"DESC"}}}var a=t.find(function(t){return t.value===e.source});if(!r.Type.isArray(e.filter)||e.filter.length<=0){if(a){e.filter=babelHelpers.toConsumableArray(a.filter)}}e.filter=o(e.filter,a);if(!r.Type.isPlainObject(e.sort)){e.sort={}}if(!r.Type.isString(e.sort.by)){if(a){e.sort.by=a.sort.items[0].value}}if(!r.Type.isString(e.sort.order)){e.sort.order="DESC"}return e}function u(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span class="landing-ui-field-source-placeholder-remove"></span>\n\t\t\t']);u=function t(){return e};return e}function c(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="landing-ui-field-source-placeholder">\n\t\t\t\t<span class="landing-ui-field-source-placeholder-text">',"</span>\n\t\t\t</div>\n\t\t"]);c=function t(){return e};return e}function d(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-field-source-grid">\n\t\t\t\t\t<div class="landing-ui-field-source-grid-left">','</div>\n\t\t\t\t\t<div class="landing-ui-field-source-grid-right">',"</div>\n\t\t\t\t</div>\n\t\t\t"]);d=function t(){return e};return e}function p(){var e=babelHelpers.taggedTemplateLiteral(["<span>&nbsp;(",")</span>"]);p=function t(){return e};return e}function f(){var e=babelHelpers.taggedTemplateLiteral(["<span></span>"]);f=function t(){return e};return e}var g=function(e){babelHelpers.inherits(i,e);function i(e){var t;babelHelpers.classCallCheck(this,i);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this,e));r.Dom.addClass(t.layout,"landing-ui-field-source");t.items=l(e.items);t.value=s(e.value,t.items);t.cache=new r.Cache.MemoryCache;t.onButtonClick=t.onButtonClick.bind(babelHelpers.assertThisInitialized(t));t.onMenuItemClick=t.onMenuItemClick.bind(babelHelpers.assertThisInitialized(t));t.onSliderMessage=t.onSliderMessage.bind(babelHelpers.assertThisInitialized(t));t.onPlaceholderRemoveClick=t.onPlaceholderRemoveClick.bind(babelHelpers.assertThisInitialized(t));t.onPlaceholderClick=t.onPlaceholderClick.bind(babelHelpers.assertThisInitialized(t));r.Dom.append(t.getGrid(),t.layout);r.Dom.append(t.getSortByField().layout,t.layout);r.Dom.append(t.getSortOrderField().layout,t.layout);r.Dom.append(t.getValueLayoutWrapper(),t.header);t.setValue(t.value);window.top.BX.addCustomEvent("SidePanel.Slider:onMessage",t.onSliderMessage);return t}babelHelpers.createClass(i,[{key:"getItem",value:function e(t){return this.items.find(function(e){return e.value===t})}},{key:"getButtonField",value:function e(){var t=this;return this.cache.remember("buttonField",function(){return new BX.Landing.UI.Button.BaseButton("dropdown_button",{text:n.Loc.getMessage("LINK_URL_SUGGESTS_SELECT"),className:"landing-ui-button-select-link",onClick:t.onButtonClick})})}},{key:"getSortByField",value:function e(){var t=this;return this.cache.remember("sortByField",function(){var e=t.getItem(t.value.source);return new BX.Landing.UI.Field.DropdownInline({title:n.Loc.getMessage("LANDING_CARDS__SOURCE_FIELD_SORT_TITLE").toLowerCase(),items:e.sort.items,content:t.value.sort.by})})}},{key:"getSortOrderField",value:function e(){var t=this;return this.cache.remember("sortOrderField",function(){return new BX.Landing.UI.Field.DropdownInline({title:", ",items:[{name:n.Loc.getMessage("LANDING_CARDS__SOURCE_FIELD_SORT_DESC"),value:"DESC"},{name:n.Loc.getMessage("LANDING_CARDS__SOURCE_FIELD_SORT_ASC"),value:"ASC"}],content:t.value.sort.order})})}},{key:"getValueLayout",value:function e(){return this.cache.remember("valueLayout",function(){return r.Tag.render(f())})}},{key:"getValueLayoutWrapper",value:function e(){var t=this;return this.cache.remember("valueLayoutWrapper",function(){return r.Tag.render(p(),t.getValueLayout())})}},{key:"getInput",value:function e(){return this.input}},{key:"getGrid",value:function e(){var t=this;return this.cache.remember("grid",function(){return r.Tag.render(d(),t.getInput(),t.getButtonField().layout)})}},{key:"onButtonClick",value:function e(){this.getMenu().show()}},{key:"onMenuItemClick",value:function e(t){var i=s({source:t.value},this.items);this.setValue(i);this.getMenu().close();this.openSourceFilterSlider(t.url)}},{key:"onPlaceholderClick",value:function e(t,i){i.preventDefault();this.openSourceFilterSlider(t.url)}},{key:"onPlaceholderRemoveClick",value:function e(t,i){i.preventDefault();i.stopPropagation();var n=i.currentTarget;if(r.Type.isDomNode(n)){var a=n.closest(".landing-ui-field-source-placeholder");if(a){r.Dom.remove(a)}if(this.getPlaceholders().length<=0){var l=s({source:this.getValue().source},this.items);this.value=l;this.setFilter(l.filter)}this.value.filter=this.getPlaceholders().map(function(e){return r.Dom.attr(e,"data-item")})}}},{key:"onSliderMessage",value:function e(t){if(t.getEventId()==="save"){var i=babelHelpers.objectSpread({},this.getValue(),{filter:t.getData().filter});var n=s(i,this.items);this.value=n;this.setFilter(n.filter)}}},{key:"openSourceFilterSlider",value:function e(i){if(r.Type.isString(i)){var n=t.Env.getInstance().getOptions().site_id;BX.SidePanel.Instance.open(i,{cacheable:false,requestMethod:"post",requestParams:{filter:this.getValue().filter,landingParams:{siteId:n}}})}}},{key:"getMenuItems",value:function e(){var t=this;return this.cache.remember("menuItems",function(){return t.items.map(function(e){return{id:e.value,text:r.Text.encode(e.name),onclick:function i(){return t.onMenuItemClick(e)}}})})}},{key:"getMenu",value:function e(){var t=this;return this.cache.remember("menu",function(){var e=t.input.closest(".landing-ui-field-source");var i=new BX.PopupMenuWindow({id:"".concat(t.selector,"_").concat(r.Text.getRandom()),bindElement:t.getButtonField().layout,autoHide:true,items:t.getMenuItems(),className:"landing-ui-field-source-popup",events:{onPopupShow:function n(){var a=r.Dom.getRelativePosition(t.getButtonField().layout,e);var l=0;var o=a.bottom;requestAnimationFrame(function(){r.Dom.style(i.popupWindow.popupContainer,{top:"".concat(o,"px"),left:"auto",right:"".concat(l,"px")})})}}});r.Dom.append(i.popupWindow.popupContainer,e);return i})}},{key:"addPlaceholder",value:function e(t){var i=r.Tag.render(c(),r.Text.encode(t.name));r.Dom.attr(i,{"data-item":t,title:t.name});if(!t.url){r.Dom.addClass(i.firstElementChild,"landing-ui-field-source-placeholder-text-plain")}if(t.url){var n=r.Tag.render(u());r.Dom.append(n,i);r.Event.bind(i,"click",this.onPlaceholderClick.bind(this,t));r.Event.bind(n,"click",this.onPlaceholderRemoveClick.bind(this,t))}r.Dom.append(i,this.input)}},{key:"getPlaceholders",value:function e(){return babelHelpers.toConsumableArray(this.input.querySelectorAll(".landing-ui-field-source-placeholder"))}},{key:"setFilter",value:function e(t){var i=this;r.Dom.clean(this.getInput());t.forEach(function(e){i.addPlaceholder(e)})}},{key:"setSource",value:function e(t){var i=t.value,n=t.name;var a=this.getValueLayout();r.Dom.attr(a,"data-value",i);a.innerText=n}},{key:"setSortByItems",value:function e(t){if(r.Type.isArray(t)){this.getSortByField().setItems(t)}}},{key:"setValue",value:function e(t,i){var n=s(t,this.items);var a=this.getItem(t.source);if(r.Type.isPlainObject(a)){if(n.source!==this.value.source||this.getPlaceholders().length<=0){this.value=r.Runtime.clone(n);this.setFilter(n.filter);this.setSource(a);var l=this.getSortByField();l.setItems(a.sort.items);l.setValue(n.sort.by);var o=this.getSortOrderField();o.setValue(n.sort.order);if(!i){this.onValueChangeHandler(this)}}}}},{key:"getValue",value:function e(){var t=r.Runtime.clone(this.value);t.filter=t.filter.filter(function(e){return e.key!==a().key}).map(function(e){Reflect.deleteProperty(e,"url");return e});t.sort.by=this.getSortByField().getValue();t.sort.order=this.getSortOrderField().getValue();return t}},{key:"getCurrentSource",value:function e(){var t=this.getValue();return this.getItem(t.source)}},{key:"isDetailPageAllowed",value:function e(){var t=this.getCurrentSource();return!r.Type.isPlainObject(t)||!r.Type.isPlainObject(t.settings)||t.settings.detailPage!==false}}]);return i}(i.BaseField);e.SourceField=g})(this.BX.Landing.UI.Field=this.BX.Landing.UI.Field||{},BX.Landing,BX.Landing.UI.Field,BX.Landing,BX);
//# sourceMappingURL=sourcefield.bundle.map.js