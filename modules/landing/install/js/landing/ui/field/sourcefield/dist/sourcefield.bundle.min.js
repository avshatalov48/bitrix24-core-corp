this.BX=this.BX||{};this.BX.Landing=this.BX.Landing||{};this.BX.Landing.UI=this.BX.Landing.UI||{};(function(e,t,n,i,r){"use strict";function a(){return{key:"filterStub",name:i.Loc.getMessage("LANDING_BLOCK__SOURCE_FILTER_STUB"),value:""}}function l(e){if(r.Type.isArray(e)){return e.reduce(function(e,t){if(r.Type.isPlainObject(t)&&r.Type.isString(t.name)&&r.Type.isString(t.value)){var n=r.Runtime.clone(t);if(!r.Type.isArray(n.filter)||n.filter.length<=0){n.filter=[r.Runtime.clone(a())]}if(!r.Type.isPlainObject(n.sort)||!r.Type.isArray(n.sort.items)){n.sort={items:[]}}return[].concat(babelHelpers.toConsumableArray(e),[n])}return e},[])}return[]}function o(e,t){return e.reduce(function(e,n){if(r.Type.isPlainObject(n)){return[].concat(babelHelpers.toConsumableArray(e),[babelHelpers.objectSpread({},n,{url:t.url})])}return e},[])}function s(e,t){var n=babelHelpers.slicedToArray(t,1),i=n[0];if(!r.Type.isPlainObject(e)){return{source:i.value,filter:o(babelHelpers.toConsumableArray(i.filter),i),sort:{by:i.sort.items[0].key,order:"DESC"}}}var a=t.find(function(t){return t.value===e.source});if(!r.Type.isArray(e.filter)||e.filter.length<=0){if(a){e.filter=babelHelpers.toConsumableArray(a.filter)}}e.filter=o(e.filter,a);if(!r.Type.isPlainObject(e.sort)){e.sort={}}if(!r.Type.isString(e.sort.by)){if(a){e.sort.by=a.sort.items[0].value}}if(!r.Type.isString(e.sort.order)){e.sort.order="DESC"}return e}function u(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span class="landing-ui-field-source-placeholder-remove"></span>\n\t\t\t']);u=function t(){return e};return e}function c(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="landing-ui-field-source-placeholder">\n\t\t\t\t<span class="landing-ui-field-source-placeholder-text">',"</span>\n\t\t\t</div>\n\t\t"]);c=function t(){return e};return e}function d(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-field-source-grid">\n\t\t\t\t\t<div class="landing-ui-field-source-grid-left">','</div>\n\t\t\t\t\t<div class="landing-ui-field-source-grid-right">',"</div>\n\t\t\t\t</div>\n\t\t\t"]);d=function t(){return e};return e}function f(){var e=babelHelpers.taggedTemplateLiteral(["<span>&nbsp;(",")</span>"]);f=function t(){return e};return e}function p(){var e=babelHelpers.taggedTemplateLiteral(["<span></span>"]);p=function t(){return e};return e}var g=function(e){babelHelpers.inherits(n,e);function n(e){var t;babelHelpers.classCallCheck(this,n);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this,e));r.Dom.addClass(t.layout,"landing-ui-field-source");t.items=l(e.items);t.value=s(e.value,t.items);t.cache=new r.Cache.MemoryCache;t.onButtonClick=t.onButtonClick.bind(babelHelpers.assertThisInitialized(t));t.onMenuItemClick=t.onMenuItemClick.bind(babelHelpers.assertThisInitialized(t));t.onSliderMessage=t.onSliderMessage.bind(babelHelpers.assertThisInitialized(t));t.onPlaceholderRemoveClick=t.onPlaceholderRemoveClick.bind(babelHelpers.assertThisInitialized(t));t.onPlaceholderClick=t.onPlaceholderClick.bind(babelHelpers.assertThisInitialized(t));r.Dom.append(t.getGrid(),t.layout);r.Dom.append(t.getSortByField().layout,t.layout);r.Dom.append(t.getSortOrderField().layout,t.layout);r.Dom.append(t.getValueLayoutWrapper(),t.header);t.setValue(t.value);window.top.BX.addCustomEvent("SidePanel.Slider:onMessage",t.onSliderMessage);return t}babelHelpers.createClass(n,[{key:"getItem",value:function e(t){return this.items.find(function(e){return e.value===t})}},{key:"getButtonField",value:function e(){var t=this;return this.cache.remember("buttonField",function(){return new BX.Landing.UI.Button.BaseButton("dropdown_button",{text:i.Loc.getMessage("LINK_URL_SUGGESTS_SELECT"),className:"landing-ui-button-select-link",onClick:t.onButtonClick})})}},{key:"getSortByField",value:function e(){var t=this;return this.cache.remember("sortByField",function(){var e=t.getItem(t.value.source);return new BX.Landing.UI.Field.DropdownInline({title:i.Loc.getMessage("LANDING_CARDS__SOURCE_FIELD_SORT_TITLE").toLowerCase(),items:e.sort.items,content:t.value.sort.by})})}},{key:"getSortOrderField",value:function e(){var t=this;return this.cache.remember("sortOrderField",function(){return new BX.Landing.UI.Field.DropdownInline({title:", ",items:[{name:i.Loc.getMessage("LANDING_CARDS__SOURCE_FIELD_SORT_DESC"),value:"DESC"},{name:i.Loc.getMessage("LANDING_CARDS__SOURCE_FIELD_SORT_ASC"),value:"ASC"}],content:t.value.sort.order})})}},{key:"getValueLayout",value:function e(){return this.cache.remember("valueLayout",function(){return r.Tag.render(p())})}},{key:"getValueLayoutWrapper",value:function e(){var t=this;return this.cache.remember("valueLayoutWrapper",function(){return r.Tag.render(f(),t.getValueLayout())})}},{key:"getInput",value:function e(){return this.input}},{key:"getGrid",value:function e(){var t=this;return this.cache.remember("grid",function(){return r.Tag.render(d(),t.getInput(),t.getButtonField().layout)})}},{key:"onButtonClick",value:function e(){this.getMenu().show()}},{key:"onMenuItemClick",value:function e(t){var n=s({source:t.value},this.items);this.setValue(n);this.getMenu().close();this.openSourceFilterSlider(t.url)}},{key:"onPlaceholderClick",value:function e(t,n){n.preventDefault();this.openSourceFilterSlider(t.url)}},{key:"onPlaceholderRemoveClick",value:function e(t,n){n.preventDefault();n.stopPropagation();var i=n.currentTarget;if(r.Type.isDomNode(i)){var a=i.closest(".landing-ui-field-source-placeholder");if(a){r.Dom.remove(a)}if(this.getPlaceholders().length<=0){var l=s({source:this.getValue().source},this.items);this.value=l;this.setFilter(l.filter)}this.value.filter=this.getPlaceholders().map(function(e){return r.Dom.attr(e,"data-item")})}}},{key:"onSliderMessage",value:function e(t){if(t.getEventId()==="save"){var n=babelHelpers.objectSpread({},this.getValue(),{filter:t.getData().filter});var i=s(n,this.items);this.value=i;this.setFilter(i.filter)}}},{key:"openSourceFilterSlider",value:function e(n){if(r.Type.isString(n)){var i=t.Env.getInstance().getOptions().site_id;BX.SidePanel.Instance.open(n,{cacheable:false,requestMethod:"post",requestParams:{filter:this.getValue().filter,landingParams:{siteId:i}}})}}},{key:"getMenuItems",value:function e(){var t=this;return this.cache.remember("menuItems",function(){return t.items.map(function(e){return{id:e.value,text:r.Text.encode(e.name),onclick:function n(){return t.onMenuItemClick(e)}}})})}},{key:"getMenu",value:function e(){var t=this;return this.cache.remember("menu",function(){var e=t.input.closest(".landing-ui-field-source");var n=new BX.Landing.UI.Tool.Menu({id:"".concat(t.selector,"_").concat(r.Text.getRandom()),bindElement:t.getButtonField().layout,autoHide:true,items:t.getMenuItems(),className:"landing-ui-field-source-popup",events:{onPopupShow:function i(){var a=r.Dom.getRelativePosition(t.getButtonField().layout,e);var l=0;var o=a.bottom;requestAnimationFrame(function(){r.Dom.style(n.popupWindow.popupContainer,{top:"".concat(o,"px"),left:"auto",right:"".concat(l,"px")})})}}});r.Dom.append(n.popupWindow.popupContainer,e);return n})}},{key:"addPlaceholder",value:function e(t){var n=r.Tag.render(c(),r.Text.encode(t.name));r.Dom.attr(n,{"data-item":t,title:t.name});if(!t.url){r.Dom.addClass(n.firstElementChild,"landing-ui-field-source-placeholder-text-plain")}if(t.url){var i=r.Tag.render(u());r.Dom.append(i,n);r.Event.bind(n,"click",this.onPlaceholderClick.bind(this,t));r.Event.bind(i,"click",this.onPlaceholderRemoveClick.bind(this,t))}r.Dom.append(n,this.input)}},{key:"getPlaceholders",value:function e(){return babelHelpers.toConsumableArray(this.input.querySelectorAll(".landing-ui-field-source-placeholder"))}},{key:"setFilter",value:function e(t){var n=this;r.Dom.clean(this.getInput());t.forEach(function(e){n.addPlaceholder(e)})}},{key:"setSource",value:function e(t){var n=t.value,i=t.name;var a=this.getValueLayout();r.Dom.attr(a,"data-value",n);a.innerText=i}},{key:"setSortByItems",value:function e(t){if(r.Type.isArray(t)){this.getSortByField().setItems(t)}}},{key:"setValue",value:function e(t,n){var i=s(t,this.items);var a=this.getItem(t.source);if(r.Type.isPlainObject(a)){if(i.source!==this.value.source||this.getPlaceholders().length<=0){this.value=r.Runtime.clone(i);this.setFilter(i.filter);this.setSource(a);var l=this.getSortByField();l.setItems(a.sort.items);l.setValue(i.sort.by);var o=this.getSortOrderField();o.setValue(i.sort.order);if(!n){this.onValueChangeHandler(this)}}}}},{key:"getValue",value:function e(){var t=r.Runtime.clone(this.value);t.filter=t.filter.filter(function(e){return e.key!==a().key}).map(function(e){Reflect.deleteProperty(e,"url");return e});t.sort.by=this.getSortByField().getValue();t.sort.order=this.getSortOrderField().getValue();return t}},{key:"getCurrentSource",value:function e(){var t=this.getValue();return this.getItem(t.source)}},{key:"isDetailPageAllowed",value:function e(){var t=this.getCurrentSource();return!r.Type.isPlainObject(t)||!r.Type.isPlainObject(t.settings)||t.settings.detailPage!==false}}]);return n}(n.BaseField);e.SourceField=g})(this.BX.Landing.UI.Field=this.BX.Landing.UI.Field||{},BX.Landing,BX.Landing.UI.Field,BX.Landing,BX);
//# sourceMappingURL=sourcefield.bundle.map.js