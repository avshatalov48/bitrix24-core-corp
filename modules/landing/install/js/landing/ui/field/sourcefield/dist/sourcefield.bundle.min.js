this.BX=this.BX||{};this.BX.Landing=this.BX.Landing||{};this.BX.Landing.UI=this.BX.Landing.UI||{};(function(e,t,n,i,r){"use strict";function a(){return{key:"filterStub",name:n.Loc.getMessage("LANDING_BLOCK__SOURCE_FILTER_STUB"),value:""}}function l(e){if(t.Type.isArray(e)){return e.reduce(function(e,n){if(t.Type.isPlainObject(n)&&t.Type.isString(n.name)&&t.Type.isString(n.value)){var i=t.Runtime.clone(n);if(!t.Type.isArray(i.filter)||i.filter.length<=0){i.filter=[t.Runtime.clone(a())]}if(!t.Type.isPlainObject(i.sort)||!t.Type.isArray(i.sort.items)){i.sort={items:[]}}return[].concat(babelHelpers.toConsumableArray(e),[i])}return e},[])}return[]}function o(e,n){return e.reduce(function(e,i){if(t.Type.isPlainObject(i)){return[].concat(babelHelpers.toConsumableArray(e),[babelHelpers.objectSpread({},i,{url:n.url})])}return e},[])}function s(e,n){var i=babelHelpers.slicedToArray(n,1),r=i[0];if(!t.Type.isPlainObject(e)){return{source:r.value,filter:o(babelHelpers.toConsumableArray(r.filter),r),sort:{by:r.sort.items[0].key,order:"DESC"}}}var a=n.find(function(t){return t.value===e.source});if(!t.Type.isArray(e.filter)||e.filter.length<=0){if(a){e.filter=babelHelpers.toConsumableArray(a.filter)}}e.filter=o(e.filter,a);if(!t.Type.isPlainObject(e.sort)){e.sort={}}if(!t.Type.isString(e.sort.by)){if(a){e.sort.by=a.sort.items[0].value}}if(!t.Type.isString(e.sort.order)){e.sort.order="DESC"}return e}function u(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span class="landing-ui-field-source-placeholder-remove"></span>\n\t\t\t']);u=function t(){return e};return e}function c(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="landing-ui-field-source-placeholder">\n\t\t\t\t<span class="landing-ui-field-source-placeholder-text">',"</span>\n\t\t\t</div>\n\t\t"]);c=function t(){return e};return e}function d(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-field-source-grid">\n\t\t\t\t\t<div class="landing-ui-field-source-grid-left">','</div>\n\t\t\t\t\t<div class="landing-ui-field-source-grid-right">',"</div>\n\t\t\t\t</div>\n\t\t\t"]);d=function t(){return e};return e}function f(){var e=babelHelpers.taggedTemplateLiteral(["<span>&nbsp;(",")</span>"]);f=function t(){return e};return e}function p(){var e=babelHelpers.taggedTemplateLiteral(["<span></span>"]);p=function t(){return e};return e}var g=function(e){babelHelpers.inherits(r,e);function r(e){var n;babelHelpers.classCallCheck(this,r);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(r).call(this,e));t.Dom.addClass(n.layout,"landing-ui-field-source");n.items=l(e.items);n.value=s(e.value,n.items);n.cache=new t.Cache.MemoryCache;n.onButtonClick=n.onButtonClick.bind(babelHelpers.assertThisInitialized(n));n.onMenuItemClick=n.onMenuItemClick.bind(babelHelpers.assertThisInitialized(n));n.onSliderMessage=n.onSliderMessage.bind(babelHelpers.assertThisInitialized(n));n.onPlaceholderRemoveClick=n.onPlaceholderRemoveClick.bind(babelHelpers.assertThisInitialized(n));n.onPlaceholderClick=n.onPlaceholderClick.bind(babelHelpers.assertThisInitialized(n));t.Dom.append(n.getGrid(),n.layout);t.Dom.append(n.getSortByField().layout,n.layout);t.Dom.append(n.getSortOrderField().layout,n.layout);t.Dom.append(n.getValueLayoutWrapper(),n.header);n.setValue(n.value);window.top.BX.addCustomEvent("SidePanel.Slider:onMessage",n.onSliderMessage);return n}babelHelpers.createClass(r,[{key:"getItem",value:function e(t){return this.items.find(function(e){return e.value===t})}},{key:"getButtonField",value:function e(){var t=this;return this.cache.remember("buttonField",function(){return new BX.Landing.UI.Button.BaseButton("dropdown_button",{text:n.Loc.getMessage("LINK_URL_SUGGESTS_SELECT"),className:"landing-ui-button-select-link",onClick:t.onButtonClick})})}},{key:"getSortByField",value:function e(){var t=this;return this.cache.remember("sortByField",function(){var e=t.getItem(t.value.source);return new BX.Landing.UI.Field.DropdownInline({title:n.Loc.getMessage("LANDING_CARDS__SOURCE_FIELD_SORT_TITLE").toLowerCase(),items:e.sort.items,content:t.value.sort.by})})}},{key:"getSortOrderField",value:function e(){var t=this;return this.cache.remember("sortOrderField",function(){return new BX.Landing.UI.Field.DropdownInline({title:", ",items:[{name:n.Loc.getMessage("LANDING_CARDS__SOURCE_FIELD_SORT_DESC"),value:"DESC"},{name:n.Loc.getMessage("LANDING_CARDS__SOURCE_FIELD_SORT_ASC"),value:"ASC"}],content:t.value.sort.order})})}},{key:"getValueLayout",value:function e(){return this.cache.remember("valueLayout",function(){return t.Tag.render(p())})}},{key:"getValueLayoutWrapper",value:function e(){var n=this;return this.cache.remember("valueLayoutWrapper",function(){return t.Tag.render(f(),n.getValueLayout())})}},{key:"getInput",value:function e(){return this.input}},{key:"getGrid",value:function e(){var n=this;return this.cache.remember("grid",function(){return t.Tag.render(d(),n.getInput(),n.getButtonField().layout)})}},{key:"onButtonClick",value:function e(){this.getMenu().show()}},{key:"onMenuItemClick",value:function e(t){var n=s({source:t.value},this.items);this.setValue(n);this.getMenu().close();this.openSourceFilterSlider(t.url)}},{key:"onPlaceholderClick",value:function e(t,n){n.preventDefault();this.openSourceFilterSlider(t.url)}},{key:"onPlaceholderRemoveClick",value:function e(n,i){i.preventDefault();i.stopPropagation();var r=i.currentTarget;if(t.Type.isDomNode(r)){var a=r.closest(".landing-ui-field-source-placeholder");if(a){t.Dom.remove(a)}if(this.getPlaceholders().length<=0){var l=s({source:this.getValue().source},this.items);this.value=l;this.setFilter(l.filter)}this.value.filter=this.getPlaceholders().map(function(e){return t.Dom.attr(e,"data-item")})}}},{key:"onSliderMessage",value:function e(t){if(t.getEventId()==="save"){var n=babelHelpers.objectSpread({},this.getValue(),{filter:t.getData().filter});var i=s(n,this.items);this.value=i;this.setFilter(i.filter)}}},{key:"openSourceFilterSlider",value:function e(n){if(t.Type.isString(n)){var r=i.Env.getInstance().getOptions().site_id;BX.SidePanel.Instance.open(n,{cacheable:false,requestMethod:"post",requestParams:{filter:this.getValue().filter,landingParams:{siteId:r}}})}}},{key:"getMenuItems",value:function e(){var n=this;return this.cache.remember("menuItems",function(){return n.items.map(function(e){return{id:e.value,text:t.Text.encode(e.name),onclick:function t(){return n.onMenuItemClick(e)}}})})}},{key:"getMenu",value:function e(){var n=this;return this.cache.remember("menu",function(){var e=n.input.closest(".landing-ui-field-source");var i=new BX.Landing.UI.Tool.Menu({id:"".concat(n.selector,"_").concat(t.Text.getRandom()),bindElement:n.getButtonField().layout,autoHide:true,items:n.getMenuItems(),className:"landing-ui-field-source-popup",events:{onPopupShow:function r(){var a=t.Dom.getRelativePosition(n.getButtonField().layout,e);var l=0;var o=a.bottom;requestAnimationFrame(function(){t.Dom.style(i.popupWindow.popupContainer,{top:"".concat(o,"px"),left:"auto",right:"".concat(l,"px")})})}}});t.Dom.append(i.popupWindow.popupContainer,e);return i})}},{key:"addPlaceholder",value:function e(n){var i=t.Tag.render(c(),t.Text.encode(n.name));t.Dom.attr(i,{"data-item":n,title:n.name});if(!n.url){t.Dom.addClass(i.firstElementChild,"landing-ui-field-source-placeholder-text-plain")}if(n.url){var r=t.Tag.render(u());t.Dom.append(r,i);t.Event.bind(i,"click",this.onPlaceholderClick.bind(this,n));t.Event.bind(r,"click",this.onPlaceholderRemoveClick.bind(this,n))}t.Dom.append(i,this.input)}},{key:"getPlaceholders",value:function e(){return babelHelpers.toConsumableArray(this.input.querySelectorAll(".landing-ui-field-source-placeholder"))}},{key:"setFilter",value:function e(n){var i=this;t.Dom.clean(this.getInput());n.forEach(function(e){i.addPlaceholder(e)})}},{key:"setSource",value:function e(n){var i=n.value,r=n.name;var a=this.getValueLayout();t.Dom.attr(a,"data-value",i);a.innerText=r}},{key:"setSortByItems",value:function e(n){if(t.Type.isArray(n)){this.getSortByField().setItems(n)}}},{key:"setValue",value:function e(n,i){var r=s(n,this.items);var a=this.getItem(n.source);if(t.Type.isPlainObject(a)){if(r.source!==this.value.source||this.getPlaceholders().length<=0){this.value=t.Runtime.clone(r);this.setFilter(r.filter);this.setSource(a);var l=this.getSortByField();l.setItems(a.sort.items);l.setValue(r.sort.by);var o=this.getSortOrderField();o.setValue(r.sort.order);if(!i){this.onValueChangeHandler(this)}}}}},{key:"getValue",value:function e(){var n=t.Runtime.clone(this.value);n.filter=n.filter.filter(function(e){return e.key!==a().key}).map(function(e){Reflect.deleteProperty(e,"url");return e});n.sort.by=this.getSortByField().getValue();n.sort.order=this.getSortOrderField().getValue();return n}},{key:"getCurrentSource",value:function e(){var t=this.getValue();return this.getItem(t.source)}},{key:"isDetailPageAllowed",value:function e(){var n=this.getCurrentSource();return!t.Type.isPlainObject(n)||!t.Type.isPlainObject(n.settings)||n.settings.detailPage!==false}}]);return r}(r.BaseField);e.SourceField=g})(this.BX.Landing.UI.Field=this.BX.Landing.UI.Field||{},BX,BX.Landing,BX.Landing,BX.Landing.UI.Field);
//# sourceMappingURL=sourcefield.bundle.map.js