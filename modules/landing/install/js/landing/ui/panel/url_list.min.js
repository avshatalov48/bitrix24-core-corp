(function(){"use strict";BX.namespace("BX.Landing.UI.Panel");var e=BX.Landing.Utils.addClass;var n=BX.Landing.Utils.removeClass;var i=BX.Landing.Utils.append;var t=BX.Landing.Utils.onCustomEvent;var a=BX.Landing.Utils.setTextContent;var r=BX.Landing.Utils.create;var s=BX.Landing.Utils.style;var d=BX.Landing.Utils.isNumber;var o=BX.Landing.Utils.isString;var h=BX.Landing.Utils.isPlainObject;var c=BX.Landing.Utils.isArray;var l=BX.Landing.Utils.addQueryParams;var u="landing";var g="block";var L="system";var f="crmFormPopup";var p="crmPhone";var v=BX.Landing.UI.Button.SidebarButton;BX.Landing.UI.Panel.URLList=function(n,a){BX.Landing.UI.Panel.Content.apply(this,arguments);e(this.layout,"landing-ui-panel-url-list");e(this.overlay,"landing-ui-panel-url-list-overlay");e(this.overlay,"landing-ui-hide");this.overlay.hidden=true;this.overlay.dataset.isShown="false";t("BX.Landing.Block:init",this.refresh.bind(this));t("BX.Landing.Block:remove",this.refresh.bind(this));i(this.layout,document.body);this.loader=new BX.Loader({target:this.content});this.promiseResolve=function(){};this.layout.hidden=true;this.isNeedLoad=true;this.cache=new BX.Cache.MemoryCache};BX.Landing.UI.Panel.URLList.getInstance=function(){if(!BX.Landing.UI.Panel.URLList.instance){BX.Landing.UI.Panel.URLList.instance=new BX.Landing.UI.Panel.URLList("url_list")}return BX.Landing.UI.Panel.URLList.instance};BX.Landing.UI.Panel.URLList.instance=null;BX.Landing.UI.Panel.URLList.prototype={constructor:BX.Landing.UI.Panel.URLList,__proto__:BX.Landing.UI.Panel.Content.prototype,refresh:function(){this.isNeedLoad=true},showLoader:function(){this.loader.show(this.content)},show:function(e,i){this.showOptions=i;BX.Landing.UI.Panel.Content.prototype.show.call(this);this.clear();this.showLoader();if(e===u){n(this.layout,"landing-ui-panel-url-list-blocks");a(this.title,i.panelTitle||BX.Landing.Loc.getMessage("LANDING_LINKS_LANDINGS_TITLE"));this.showSites(i)}else if(e===g){a(this.title,i.panelTitle||BX.Landing.Loc.getMessage("LANDING_LINKS_BLOCKS_TITLE"));this.showBlocks(i)}else if(e===f){a(this.title,i.panelTitle||BX.Landing.Loc.getMessage("LANDING_LINKS_CRM_FORMS_TITLE"));this.showForms(i)}else if(e===p){a(this.title,i.panelTitle||BX.Landing.Loc.getMessage("LANDING_LINKS_CRM_PHONES_TITLE"));this.showPhones(i)}return new Promise(function(e){this.promiseResolve=e}.bind(this))},showSites:function(e){var n=e.siteId;void s(this.layout,{width:null});if(!BX.Type.isPlainObject(e.filter)){e.filter={}}var i=BX.Landing.Env.getInstance();if(BX.Type.isNil(e.filter.ID)&&i.getType()==="GROUP"){e.filter.ID=i.getSiteId()}if(e.filter.ID===-1){delete e.filter.ID}e.filter.SPECIAL="N";void BX.Landing.Backend.getInstance().getSites(e).then(function(i){this.appendSidebarButton(new v("current_site",{text:BX.Landing.Loc.getMessage("LANDING_LINKS_PANEL_CURRENT_SITE")}));i.forEach(function(i){if(parseInt(i.ID)==n){this.currentSiteButton=new v(i.ID,{text:i.TITLE,onClick:!e.currentSiteOnly?this.onSiteClick.bind(this,i.ID,e.enableAreas):null,child:true,active:true});this.appendSidebarButton(this.currentSiteButton)}},this);BX.Landing.Backend.getInstance().getLandings({siteId:n},e.filterLanding).then(function(i){var t={currentTarget:this.currentSiteButton.layout};var a=this.onSiteClick.bind(this,n,e.enableAreas,t);if(!e.disableAddPage){this.appendCard(new BX.Landing.UI.Card.AddPageCard({siteId:n,onSave:this.addPageSave.bind(this,a,n)}))}i.forEach(function(n){if(!n.IS_AREA||n.IS_AREA&&e.enableAreas){this.appendCard(new BX.Landing.UI.Card.LandingPreviewCard({title:n.TITLE,description:n.DESCRIPTION,preview:n.PREVIEW,onClick:this.onLandingClick.bind(this,n.ID,n.TITLE)}))}},this);this.loader.hide()}.bind(this));if(!e.currentSiteOnly){this.appendSidebarButton(new v("my_sites",{text:BX.Landing.Loc.getMessage("LANDING_LINKS_PANEL_MY_SITES")}));i.forEach(function(n){this.appendSidebarButton(new v(n.ID,{text:n.TITLE,onClick:this.onSiteClick.bind(this,n.ID,e.enableAreas),child:true}))},this)}}.bind(this))},createCurrentSiteButton:function(){return new v("current_site",{text:BX.Landing.Loc.getMessage("LANDING_LINKS_PANEL_CURRENT_SITE")})},showBlocks:function(e){var n=e.landingId;var i=e.siteId;void s(this.layout,{width:"880px"});if(!BX.Type.isPlainObject(e.filter)){e.filter={SPECIAL:"N"}}else{e.filter.SPECIAL="N"}BX.Landing.Backend.getInstance().getSites(e).then(function(e){this.appendSidebarButton(this.createCurrentSiteButton());var n=e.map(function(e){return e.ID},this);return BX.Landing.Backend.getInstance().getLandings({siteId:n}).then(function(n){return e.reduce(function(e,i,t){var a=n.filter(function(e){return i.ID===e.SITE_ID});e[i.ID]={site:i,landings:a};return e},{})})}.bind(this)).then(function(t){t[i].landings.forEach(function(i){var t=parseInt(i.ID)===parseInt(n);if(!e.currentPageOnly||t){var a=this.createLandingSidebarButton(i,t);this.appendSidebarButton(a);if(t){a.layout.click()}}},this);if(!e.currentPageOnly){Object.keys(t).forEach(function(e){if(parseInt(e)!==parseInt(i)){var n=t[e].site;this.appendSidebarButton(this.createSiteSidebarButton(n));t[e].landings.forEach(function(e){this.appendSidebarButton(this.createLandingSidebarButton(e))},this)}},this)}}.bind(this))},showForms:function(){void s(this.layout,{width:"500px"});BX.Landing.Backend.getInstance().action("Form::getList").then(function(e){e.forEach(function(e){var n={title:e.NAME,className:"landing-ui-card-form-preview",onClick:this.onFormChange.bind(this,e)};if(e.IS_CALLBACK_FORM==="Y"){n.className+=" landing-ui-card-form-preview--callback"}this.appendCard(new BX.Landing.UI.Card.BaseCard(n))}.bind(this));this.loader.hide()}.bind(this))},onFormChange:function(e){this.hide();this.promiseResolve({id:e.ID,type:"crmFormPopup",name:e.NAME})},showPhones:function(){void s(this.layout,{width:"500px"});BX.Landing.Env.getInstance().getOptions().references.forEach(function(e){this.appendCard(new BX.Landing.UI.Card.BaseCard({title:e.text,className:"landing-ui-card-form-preview",onClick:this.onPhoneChange.bind(this,e)}))}.bind(this));this.loader.hide()},onPhoneChange:function(e){this.hide();this.promiseResolve({id:e.value,type:"crmPhone",name:e.text})},createLandingSidebarButton:function(e,n){return new v(e.ID,{text:e.TITLE,onClick:this.onLandingChange.bind(this,e),child:true,active:n})},createSiteSidebarButton:function(e){return new v(e.ID,{text:e.TITLE,child:false,active:false})},onLandingChange:function(e,n){this.currentSelectedLanding=e;this.sidebarButtons.forEach(function(e){if(e.layout===n.currentTarget){e.activate();return}e.deactivate()});this.showPreviewLoader().then(this.createIframeIfNeed()).then(this.loadPreviewSrc(this.buildLandingPreviewUrl(e))).then(this.hidePreviewLoader())},buildLandingPreviewUrl:function(e){var n=BX.Landing.Main.getInstance().options.params.sef_url.landing_view;n=n.replace("#site_show#",e.SITE_ID);n=n.replace("#landing_edit#",e.ID);return l(n,{landing_mode:"edit"})},loadPreviewSrc:function(e){return function(){return new Promise(function(n){if(this.previewFrame.src!==e){this.previewFrame.src=e;this.previewFrame.onload=function(){var e=this.previewFrame.contentDocument;BX.Landing.Utils.removePanels(e);[].slice.call(e.querySelectorAll(".block-wrapper")).forEach(function(e){e.classList.add("landing-ui-block-selectable-overlay");e.addEventListener("click",function(n){n.preventDefault();var i=e.closest("[data-landing]");var t=BX.Dom.attr(i,"data-landing");this.onBlockClick(parseInt(e.id.replace("block","")),n,t)}.bind(this))},this);n(this.previewFrame)}.bind(this);return}n(this.previewFrame)}.bind(this))}.bind(this)},showPreviewLoader:function(){if(!this.loader){this.loader=new BX.Loader}if(this.previewFrameWrapper){void s(this.previewFrameWrapper,{opacity:0})}return new Promise(function(e){void this.loader.show(this.content);e()}.bind(this))},hidePreviewLoader:function(){return function(){void s(this.previewFrameWrapper,{opacity:null});return this.loader.hide()}.bind(this)},createIframeIfNeed:function(){return function(){new Promise(function(e){if(!this.previewFrame){this.previewFrame=r("iframe",{});this.previewFrameWrapper=r("div",{attrs:{style:"width: 100%; height: 100%; overflow: hidden;"}});this.previewFrameWrapper.appendChild(this.previewFrame);this.content.innerHTML="";this.content.appendChild(this.previewFrameWrapper);this.showPreviewLoader();requestAnimationFrame(function(){var e=this.content.clientWidth-40;void s(this.previewFrame,{width:"1000px",height:"calc((100vh - 113px) * (100 / "+e/1e3*100+"))",transform:"scale("+e/1e3+") translateZ(0)","transform-origin":"top left",border:"none"})}.bind(this))}e(this.previewFrame)}.bind(this))}.bind(this)},onBlockClick:function(e,n,i){if(n.isTrusted){void BX.Landing.Backend.getInstance().getBlocks({landingId:i}).then(function(n){var i=n.find(function(n){return n.id===e});if(i){this.onChange({type:g,id:i.id,name:i.name,alias:i.alias})}}.bind(this))}},onLandingClick:function(e,n){this.onChange({type:u,id:e,name:n})},onSystemClick:function(e,n){this.onChange({type:L,id:"_"+e,name:n})},onSiteClick:function(e,n,i){this.sidebarButtons.forEach(function(e){if(e.layout===i.currentTarget||!!i.target&&e.layout===i.target.closest(".landing-ui-button")){this.currentSiteButton=e;e.activate()}else{e.deactivate()}},this);this.content.innerHTML="";this.showLoader();BX.Landing.Backend.getInstance().getLandings({siteId:e}).then(function(t){var a=this.onSiteClick.bind(this,e,n,i);this.appendCard(new BX.Landing.UI.Card.AddPageCard({siteId:e,onSave:this.addPageSave.bind(this,a,e)}));t.forEach(function(e){if(!e.IS_AREA||e.IS_AREA&&n){this.appendCard(this.createLandingPreview(e))}},this);this.loader.hide()}.bind(this))},addPageSave:function(e,n){this.cache=new BX.Cache.MemoryCache;var i=BX.Landing.Backend.getInstance();i.cache.delete("landings+["+n+"]");i.cache.delete('landings+["'+n+'"]');i.cache.delete("landing+"+n);e()},createLandingPreview:function(e){return new BX.Landing.UI.Card.LandingPreviewCard({title:e.TITLE,description:e.DESCRIPTION,preview:e.PREVIEW,onClick:this.onLandingClick.bind(this,e.ID,e.TITLE)})},createBlockPreview:function(e){return new BX.Landing.UI.Card.BlockHTMLPreview({content:e.id,onClick:this.onBlockClick.bind(this,e.id,e.name,e.alias)})},getLanding:function(e,n){var i=JSON.stringify(["getLanding"+e,n]);return this.cache.remember(i,function(){return BX.Landing.Backend.getInstance().action("Landing::getList",{params:{filter:{ID:e},get_preview:true}}).then(function(e){return e}.bind(this))}.bind(this))},getBlock:function(e){var n="getBlocks"+e;return this.cache.remember(n,function(){return BX.Landing.Backend.getInstance().action("Block::getById",{block:e,params:{edit_mode:true}}).then(function(e){return e}.bind(this))}.bind(this))},onChange:function(e){this.promiseResolve(e);this.hide()},hide:function(){this.previewFrame=null;return BX.Landing.UI.Panel.Content.prototype.hide.call(this)}}})();
//# sourceMappingURL=url_list.map.js