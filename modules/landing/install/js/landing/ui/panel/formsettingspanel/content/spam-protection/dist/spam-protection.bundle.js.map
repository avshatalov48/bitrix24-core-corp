{"version":3,"file":"spam-protection.bundle.js","sources":["../src/internal/keys-form.js","../src/spam-protection.js"],"sourcesContent":["import {FormSettingsForm} from 'landing.ui.form.formsettingsform';\n\nimport './keys-form.css';\nimport {Dom, Runtime, Type} from 'main.core';\nimport {Button, ButtonColor} from 'ui.buttons';\nimport {FormSettingsPanel} from 'landing.ui.panel.formsettingspanel';\n\nexport default class KeysForm extends FormSettingsForm\n{\n\tconstructor(options: {[key: string]: any})\n\t{\n\t\tsuper(options);\n\t\tthis.setEventNamespace('BX.Landing.UI.Panel.FormSettingsPanel.Content.SpamProtection.KeysForm');\n\t\tDom.addClass(this.layout, 'landing-ui-form-form-keys-settings');\n\n\t\tthis.getButton().renderTo(this.layout);\n\n\t\tthis.value = {};\n\t}\n\n\tgetButton(): Button\n\t{\n\t\treturn this.cache.remember('button', () => {\n\t\t\treturn new Button({\n\t\t\t\ttext: this.options.buttonLabel,\n\t\t\t\tcolor: ButtonColor.LIGHT_BORDER,\n\t\t\t\tonclick: () => {\n\t\t\t\t\tthis.getButton().setWaiting(true);\n\n\t\t\t\t\tRuntime\n\t\t\t\t\t\t.loadExtension('crm.form.captcha')\n\t\t\t\t\t\t.then(({Captcha}) => {\n\t\t\t\t\t\t\tthis.getButton().setWaiting(false);\n\t\t\t\t\t\t\treturn Captcha.open();\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then((result) => {\n\t\t\t\t\t\t\tthis.value = {...result};\n\t\t\t\t\t\t\tconst formSettingsPanel = FormSettingsPanel.getInstance();\n\t\t\t\t\t\t\tformSettingsPanel.getFormDictionary().captcha.hasKeys = (\n\t\t\t\t\t\t\t\tType.isStringFilled(result.key) && Type.isStringFilled(result.secret)\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tconst activeButton = formSettingsPanel.getSidebarButtons().find((button) => {\n\t\t\t\t\t\t\t\treturn button.isActive();\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tif (activeButton)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tactiveButton.getLayout().click();\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tthis.emit('onChange');\n\t\t\t\t\t\t});\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t}\n\n\tserialize(): { [p: string]: * }\n\t{\n\t\treturn this.value;\n\t}\n}","import {HeaderCard} from 'landing.ui.card.headercard';\nimport {Loc} from 'landing.loc';\nimport {FormSettingsForm} from 'landing.ui.form.formsettingsform';\nimport {RadioButtonField} from 'landing.ui.field.radiobuttonfield';\nimport {ContentWrapper} from 'landing.ui.panel.basepresetpanel';\nimport {Dom, Text} from 'main.core';\nimport KeysForm from './internal/keys-form';\nimport {MessageCard} from 'landing.ui.card.messagecard';\n\nimport './css/style.css';\n\nexport default class SpamProtection extends ContentWrapper\n{\n\tconstructor(options)\n\t{\n\t\tsuper(options);\n\t\tthis.setEventNamespace('BX.Landing.UI.Panel.FormSettingsPanel.SpamProtection');\n\n\t\tconst header = new HeaderCard({\n\t\t\ttitle: Loc.getMessage('LANDING_SPAM_PROTECTION_TITLE'),\n\t\t});\n\n\t\tconst message = new MessageCard({\n\t\t\theader: Loc.getMessage('LANDING_FORM_EDITOR_FORM_CAPTCHA_MESSAGE_TITLE'),\n\t\t\tdescription: Loc.getMessage('LANDING_FORM_EDITOR_FORM_CAPTCHA_MESSAGE_TEXT'),\n\t\t\tangle: false,\n\t\t});\n\n\t\tconst captchaTypeForm = new FormSettingsForm({\n\t\t\tid: 'type',\n\t\t\tdescription: null,\n\t\t\tfields: [\n\t\t\t\tnew RadioButtonField({\n\t\t\t\t\tselector: 'use',\n\t\t\t\t\ttitle: Loc.getMessage('LANDING_SPAM_PROTECTION_TABS_TITLE'),\n\t\t\t\t\tvalue: Text.toBoolean(this.options.formOptions.data.recaptcha.use) ? 'hidden' : 'disabled',\n\t\t\t\t\titems: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tid: 'disabled',\n\t\t\t\t\t\t\ttitle: Loc.getMessage('LANDING_SPAM_PROTECTION_TAB_DISABLED'),\n\t\t\t\t\t\t\ticon: 'landing-ui-spam-protection-icon-disabled',\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tid: 'hidden',\n\t\t\t\t\t\t\ttitle: Loc.getMessage('LANDING_SPAM_PROTECTION_TAB_HIDDEN'),\n\t\t\t\t\t\t\ticon: 'landing-ui-spam-protection-icon-hidden',\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t}),\n\t\t\t],\n\t\t});\n\n\t\tthis.addItem(header);\n\t\tthis.addItem(message);\n\t\tthis.addItem(captchaTypeForm);\n\n\t\tcaptchaTypeForm.subscribe('onChange', this.onTypeChange.bind(this));\n\t\tthis.onTypeChange();\n\t}\n\n\thasDefaultsCaptchaKeys(): boolean\n\t{\n\t\treturn Text.toBoolean(this.options.formOptions.captcha.hasDefaults);\n\t}\n\n\thasCustomKeys(): boolean\n\t{\n\t\treturn Text.toBoolean(this.options.dictionary.captcha.hasKeys);\n\t}\n\n\tonTypeChange()\n\t{\n\t\tDom.remove(this.getCustomKeysForm().getLayout());\n\t\tDom.remove(this.getRequiredKeysForm().getLayout());\n\t\tDom.remove(this.getKeysSettingsForm().getLayout());\n\n\t\tif (this.getValue().recaptcha.use)\n\t\t{\n\t\t\tif (!this.hasDefaultsCaptchaKeys() && !this.hasCustomKeys())\n\t\t\t{\n\t\t\t\tthis.addItem(this.getRequiredKeysForm());\n\t\t\t}\n\n\t\t\tif (\n\t\t\t\t(!this.hasDefaultsCaptchaKeys() && this.hasCustomKeys())\n\t\t\t\t|| (this.hasDefaultsCaptchaKeys() && this.hasCustomKeys())\n\t\t\t)\n\t\t\t{\n\t\t\t\tthis.addItem(this.getKeysSettingsForm());\n\t\t\t}\n\n\t\t\tif (this.hasDefaultsCaptchaKeys() && !this.hasCustomKeys())\n\t\t\t{\n\t\t\t\tthis.addItem(this.getCustomKeysForm());\n\t\t\t}\n\t\t}\n\t}\n\n\tgetCustomKeysForm(): KeysForm\n\t{\n\t\treturn this.cache.remember('customKeysForm', () => {\n\t\t\treturn new KeysForm({\n\t\t\t\ttitle: Loc.getMessage('LANDING_FORM_EDITOR_FORM_CAPTCHA_KEYS_FORM_TITLE'),\n\t\t\t\tbuttonLabel: Loc.getMessage('LANDING_FORM_EDITOR_FORM_CAPTCHA_KEYS_FORM_CUSTOM_BUTTON_LABEL'),\n\t\t\t});\n\t\t});\n\t}\n\n\tgetRequiredKeysForm()\n\t{\n\t\treturn this.cache.remember('requiredKeysForm', () => {\n\t\t\treturn new KeysForm({\n\t\t\t\ttitle: Loc.getMessage('LANDING_FORM_EDITOR_FORM_CAPTCHA_KEYS_FORM_TITLE'),\n\t\t\t\tbuttonLabel: Loc.getMessage('LANDING_FORM_EDITOR_FORM_CAPTCHA_KEYS_FORM_BUTTON_LABEL'),\n\t\t\t\tdescription: Loc.getMessage('LANDING_FORM_EDITOR_FORM_CAPTCHA_KEYS_FORM_REQUIRED_DESCRIPTION'),\n\t\t\t});\n\t\t});\n\t}\n\n\tgetKeysSettingsForm(): KeysForm\n\t{\n\t\treturn this.cache.remember('keysSettingsForm', () => {\n\t\t\treturn new KeysForm({\n\t\t\t\ttitle: Loc.getMessage('LANDING_FORM_EDITOR_FORM_CAPTCHA_KEYS_FORM_TITLE'),\n\t\t\t\tbuttonLabel: Loc.getMessage('LANDING_FORM_EDITOR_FORM_CAPTCHA_KEYS_FORM_CHANGE_BUTTON_LABEL'),\n\t\t\t});\n\t\t});\n\t}\n\n\t// eslint-disable-next-line class-methods-use-this\n\tvalueReducer(sourceValue: {[p: string]: any}): {[p: string]: any}\n\t{\n\t\treturn {\n\t\t\trecaptcha: {\n\t\t\t\tuse: sourceValue.use === 'hidden',\n\t\t\t\t...this.getKeysSettingsForm().serialize(),\n\t\t\t\t...this.getCustomKeysForm().serialize(),\n\t\t\t\t...this.getRequiredKeysForm().serialize(),\n\t\t\t},\n\t\t};\n\t}\n\n\tonChange(event: BaseEvent)\n\t{\n\t\tthis.emit('onChange', {...event.getData(), skipPrepare: true});\n\t}\n}"],"names":["KeysForm","options","setEventNamespace","Dom","addClass","layout","getButton","renderTo","value","cache","remember","Button","text","buttonLabel","color","ButtonColor","LIGHT_BORDER","onclick","setWaiting","Runtime","loadExtension","then","Captcha","open","result","formSettingsPanel","FormSettingsPanel","getInstance","getFormDictionary","captcha","hasKeys","Type","isStringFilled","key","secret","activeButton","getSidebarButtons","find","button","isActive","getLayout","click","emit","FormSettingsForm","SpamProtection","header","HeaderCard","title","Loc","getMessage","message","MessageCard","description","angle","captchaTypeForm","id","fields","RadioButtonField","selector","Text","toBoolean","formOptions","data","recaptcha","use","items","icon","addItem","subscribe","onTypeChange","bind","hasDefaults","dictionary","remove","getCustomKeysForm","getRequiredKeysForm","getKeysSettingsForm","getValue","hasDefaultsCaptchaKeys","hasCustomKeys","sourceValue","serialize","event","getData","skipPrepare","ContentWrapper"],"mappings":";;;;;;;;;;;;KAOqBA;;;GAEpB,kBAAYC,OAAZ,EACA;KAAA;;KAAA;KACC,sGAAMA,OAAN;;KACA,MAAKC,iBAAL,CAAuB,uEAAvB;;KACAC,aAAG,CAACC,QAAJ,CAAa,MAAKC,MAAlB,EAA0B,oCAA1B;;KAEA,MAAKC,SAAL,GAAiBC,QAAjB,CAA0B,MAAKF,MAA/B;;KAEA,MAAKG,KAAL,GAAa,EAAb;KAPD;;;;;iCAWA;OAAA;;OACC,OAAO,KAAKC,KAAL,CAAWC,QAAX,CAAoB,QAApB,EAA8B,YAAM;SAC1C,OAAO,IAAIC,iBAAJ,CAAW;WACjBC,IAAI,EAAE,MAAI,CAACX,OAAL,CAAaY,WADF;WAEjBC,KAAK,EAAEC,sBAAW,CAACC,YAFF;WAGjBC,OAAO,EAAE,mBAAM;aACd,MAAI,CAACX,SAAL,GAAiBY,UAAjB,CAA4B,IAA5B;;aAEAC,iBAAO,CACLC,aADF,CACgB,kBADhB,EAEEC,IAFF,CAEO,gBAAe;eAAA,IAAbC,OAAa,QAAbA,OAAa;;eACpB,MAAI,CAAChB,SAAL,GAAiBY,UAAjB,CAA4B,KAA5B;;eACA,OAAOI,OAAO,CAACC,IAAR,EAAP;cAJF,EAMEF,IANF,CAMO,UAACG,MAAD,EAAY;eACjB,MAAI,CAAChB,KAAL,qBAAiBgB,MAAjB;eACA,IAAMC,iBAAiB,GAAGC,oDAAiB,CAACC,WAAlB,EAA1B;eACAF,iBAAiB,CAACG,iBAAlB,GAAsCC,OAAtC,CAA8CC,OAA9C,GACCC,cAAI,CAACC,cAAL,CAAoBR,MAAM,CAACS,GAA3B,KAAmCF,cAAI,CAACC,cAAL,CAAoBR,MAAM,CAACU,MAA3B,CADpC;eAGA,IAAMC,YAAY,GAAGV,iBAAiB,CAACW,iBAAlB,GAAsCC,IAAtC,CAA2C,UAACC,MAAD,EAAY;iBAC3E,OAAOA,MAAM,CAACC,QAAP,EAAP;gBADoB,CAArB;;eAGA,IAAIJ,YAAJ,EACA;iBACCA,YAAY,CAACK,SAAb,GAAyBC,KAAzB;;;eAGD,MAAI,CAACC,IAAL,CAAU,UAAV;cApBF;;UANK,CAAP;QADM,CAAP;;;;iCAmCD;OACC,OAAO,KAAKlC,KAAZ;;;;GAnDoCmC;;;;;;KCIjBC;;;GAEpB,wBAAY3C,OAAZ,EACA;KAAA;;KAAA;KACC,4GAAMA,OAAN;;KACA,MAAKC,iBAAL,CAAuB,sDAAvB;;KAEA,IAAM2C,MAAM,GAAG,IAAIC,qCAAJ,CAAe;OAC7BC,KAAK,EAAEC,eAAG,CAACC,UAAJ,CAAe,+BAAf;MADO,CAAf;KAIA,IAAMC,OAAO,GAAG,IAAIC,uCAAJ,CAAgB;OAC/BN,MAAM,EAAEG,eAAG,CAACC,UAAJ,CAAe,gDAAf,CADuB;OAE/BG,WAAW,EAAEJ,eAAG,CAACC,UAAJ,CAAe,+CAAf,CAFkB;OAG/BI,KAAK,EAAE;MAHQ,CAAhB;KAMA,IAAMC,eAAe,GAAG,IAAIX,iDAAJ,CAAqB;OAC5CY,EAAE,EAAE,MADwC;OAE5CH,WAAW,EAAE,IAF+B;OAG5CI,MAAM,EAAE,CACP,IAAIC,kDAAJ,CAAqB;SACpBC,QAAQ,EAAE,KADU;SAEpBX,KAAK,EAAEC,eAAG,CAACC,UAAJ,CAAe,oCAAf,CAFa;SAGpBzC,KAAK,EAAEmD,cAAI,CAACC,SAAL,CAAe,MAAK3D,OAAL,CAAa4D,WAAb,CAAyBC,IAAzB,CAA8BC,SAA9B,CAAwCC,GAAvD,IAA8D,QAA9D,GAAyE,UAH5D;SAIpBC,KAAK,EAAE,CACN;WACCV,EAAE,EAAE,UADL;WAECR,KAAK,EAAEC,eAAG,CAACC,UAAJ,CAAe,sCAAf,CAFR;WAGCiB,IAAI,EAAE;UAJD,EAMN;WACCX,EAAE,EAAE,QADL;WAECR,KAAK,EAAEC,eAAG,CAACC,UAAJ,CAAe,oCAAf,CAFR;WAGCiB,IAAI,EAAE;UATD;QAJR,CADO;MAHe,CAAxB;;KAwBA,MAAKC,OAAL,CAAatB,MAAb;;KACA,MAAKsB,OAAL,CAAajB,OAAb;;KACA,MAAKiB,OAAL,CAAab,eAAb;;KAEAA,eAAe,CAACc,SAAhB,CAA0B,UAA1B,EAAsC,MAAKC,YAAL,CAAkBC,IAAlB,2CAAtC;;KACA,MAAKD,YAAL;;KA3CD;;;;;8CA+CA;OACC,OAAOV,cAAI,CAACC,SAAL,CAAe,KAAK3D,OAAL,CAAa4D,WAAb,CAAyBhC,OAAzB,CAAiC0C,WAAhD,CAAP;;;;qCAID;OACC,OAAOZ,cAAI,CAACC,SAAL,CAAe,KAAK3D,OAAL,CAAauE,UAAb,CAAwB3C,OAAxB,CAAgCC,OAA/C,CAAP;;;;oCAID;OACC3B,aAAG,CAACsE,MAAJ,CAAW,KAAKC,iBAAL,GAAyBlC,SAAzB,EAAX;OACArC,aAAG,CAACsE,MAAJ,CAAW,KAAKE,mBAAL,GAA2BnC,SAA3B,EAAX;OACArC,aAAG,CAACsE,MAAJ,CAAW,KAAKG,mBAAL,GAA2BpC,SAA3B,EAAX;;OAEA,IAAI,KAAKqC,QAAL,GAAgBd,SAAhB,CAA0BC,GAA9B,EACA;SACC,IAAI,CAAC,KAAKc,sBAAL,EAAD,IAAkC,CAAC,KAAKC,aAAL,EAAvC,EACA;WACC,KAAKZ,OAAL,CAAa,KAAKQ,mBAAL,EAAb;;;SAGD,IACE,CAAC,KAAKG,sBAAL,EAAD,IAAkC,KAAKC,aAAL,EAAnC,IACI,KAAKD,sBAAL,MAAiC,KAAKC,aAAL,EAFtC,EAIA;WACC,KAAKZ,OAAL,CAAa,KAAKS,mBAAL,EAAb;;;SAGD,IAAI,KAAKE,sBAAL,MAAiC,CAAC,KAAKC,aAAL,EAAtC,EACA;WACC,KAAKZ,OAAL,CAAa,KAAKO,iBAAL,EAAb;;;;;;yCAMH;OACC,OAAO,KAAKjE,KAAL,CAAWC,QAAX,CAAoB,gBAApB,EAAsC,YAAM;SAClD,OAAO,IAAIV,QAAJ,CAAa;WACnB+C,KAAK,EAAEC,eAAG,CAACC,UAAJ,CAAe,kDAAf,CADY;WAEnBpC,WAAW,EAAEmC,eAAG,CAACC,UAAJ,CAAe,gEAAf;UAFP,CAAP;QADM,CAAP;;;;2CASD;OACC,OAAO,KAAKxC,KAAL,CAAWC,QAAX,CAAoB,kBAApB,EAAwC,YAAM;SACpD,OAAO,IAAIV,QAAJ,CAAa;WACnB+C,KAAK,EAAEC,eAAG,CAACC,UAAJ,CAAe,kDAAf,CADY;WAEnBpC,WAAW,EAAEmC,eAAG,CAACC,UAAJ,CAAe,yDAAf,CAFM;WAGnBG,WAAW,EAAEJ,eAAG,CAACC,UAAJ,CAAe,iEAAf;UAHP,CAAP;QADM,CAAP;;;;2CAUD;OACC,OAAO,KAAKxC,KAAL,CAAWC,QAAX,CAAoB,kBAApB,EAAwC,YAAM;SACpD,OAAO,IAAIV,QAAJ,CAAa;WACnB+C,KAAK,EAAEC,eAAG,CAACC,UAAJ,CAAe,kDAAf,CADY;WAEnBpC,WAAW,EAAEmC,eAAG,CAACC,UAAJ,CAAe,gEAAf;UAFP,CAAP;QADM,CAAP;;;;;kCASY+B,aACb;OACC,OAAO;SACNjB,SAAS;WACRC,GAAG,EAAEgB,WAAW,CAAChB,GAAZ,KAAoB;YACtB,KAAKY,mBAAL,GAA2BK,SAA3B,EAFK,GAGL,KAAKP,iBAAL,GAAyBO,SAAzB,EAHK,GAIL,KAAKN,mBAAL,GAA2BM,SAA3B,EAJK;QADV;;;;8BAUQC,OACT;OACC,KAAKxC,IAAL,CAAU,UAAV,sCAA0BwC,KAAK,CAACC,OAAN,EAA1B;SAA2CC,WAAW,EAAE;;;;;GArIdC;;;;;;;;"}