this.BX=this.BX||{};this.BX.Landing=this.BX.Landing||{};this.BX.Landing.Ui=this.BX.Landing.Ui||{};this.BX.Landing.Ui.Panel=this.BX.Landing.Ui.Panel||{};this.BX.Landing.Ui.Panel.Formsettingspanel=this.BX.Landing.Ui.Panel.Formsettingspanel||{};(function(e,t,i,n,a,r,s,o,l,c,d){"use strict";var g;var u=function e(t){return!c.Type.isNil(t.ID)?t.ID:t.id};var m=function e(t){return!c.Type.isNil(t.NAME)?t.NAME:t.name};var h=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));c.Dom.replace(i.input,i.getInner());return i}babelHelpers.createClass(t,[{key:"getInner",value:function e(){var t=this;return this.cache.remember("inner",(function(){return c.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-field-stages">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"])),t.getCategoriesDropdown().getLayout())}))}},{key:"getCategoriesDropdown",value:function e(){var t=this;return this.cache.remember("categoriesDropdown",(function(){return new BX.Landing.UI.Field.Dropdown({title:t.options.listTitle||l.Loc.getMessage("LANDING_FORM_SETTINGS_CATEGORIES_FIELD_TITLE"),content:t.options.value.category,items:t.options.categories.map((function(e){return{name:m(e),value:u(e)}})),onChange:t.onCategoryChange.bind(t)})}))}},{key:"getCurrentCategory",value:function e(){var t=this.getCategoriesDropdown().getValue();return this.options.categories.find((function(e){return String(u(e))===String(t)}))}},{key:"onCategoryChange",value:function e(){this.emit("onChange")}},{key:"getValue",value:function e(){return{category:this.getCategoriesDropdown().getValue(),stage:""}}},{key:"setValue",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;this.getCategoriesDropdown().setValue(t.category);if(!i){this.emit("onChange")}}}]);return t}(o.BaseField);function p(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);if(t)n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}));i.push.apply(i,n)}return i}function y(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};if(t%2){p(Object(i),true).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])}))}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(e,Object.getOwnPropertyDescriptors(i))}else{p(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}}return e}var f=new WeakMap;var _=function(e){babelHelpers.inherits(i,e);function i(e){var t;babelHelpers.classCallCheck(this,i);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this,e));f.set(babelHelpers.assertThisInitialized(t),{writable:true,value:void 0});t.setEventNamespace("BX.Landing.UI.Panel.FormSettingsPanel.CrmContent");babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),f,new d.SchemeManager(babelHelpers.toConsumableArray(e.dictionary.document.schemes)));t.addItem(t.getHeader());t.addItem(t.getTypesField());if(t.isDynamicAvailable()){t.addItem(t.getDynamicEntitySettingsForm())}t.addItem(t.getExpertSettingsForm());t.addItem(t.getOrderSettingsForm());t.setLastScheme(t.options.formOptions.document.scheme);t.setLastDealCategory(t.options.formOptions.document.deal.category);return t}babelHelpers.createClass(i,[{key:"isDynamicAvailable",value:function e(){return c.Type.isArrayFilled(this.options.dictionary.document.dynamic)}},{key:"getHeader",value:function e(){return this.cache.remember("header",(function(){return new t.HeaderCard({title:l.Loc.getMessage("LANDING_FORM_SETTINGS_CRM_TITLE")})}))}},{key:"getDuplicatesField",value:function e(){var t=this;return this.cache.remember("duplicatesField",(function(){return new BX.Landing.UI.Field.Radio({title:l.Loc.getMessage("LANDING_FORM_SETTINGS_DUPLICATES_FIELD_TITLE"),selector:"duplicateMode",value:[t.options.formOptions.document.duplicateMode?t.options.formOptions.document.duplicateMode:"ALLOW"],items:[{name:l.Loc.getMessage("LANDING_FORM_SETTINGS_DUPLICATES_ALLOW"),value:"ALLOW"},{name:l.Loc.getMessage("LANDING_FORM_SETTINGS_DUPLICATES_REPLACE"),value:"REPLACE"},{name:l.Loc.getMessage("LANDING_FORM_SETTINGS_DUPLICATES_MERGE"),value:"MERGE"}]})}))}},{key:"getOrderSettingsForm",value:function e(){var t=this;return this.cache.remember("formSettingsForm",(function(){var e=t.getSchemeById(t.options.formOptions.document.scheme);var i=function(){if(e&&e.dynamic===true){return String(e.id).endsWith("1")}return c.Text.toNumber(t.options.formOptions.document.scheme)>4}();return new r.FormSettingsForm({title:l.Loc.getMessage("LANDING_FORM_SETTINGS_ORDER_HEADER"),toggleable:true,opened:i,fields:[]})}))}},{key:"getType1Header",value:function e(){return this.cache.remember("type1header",(function(){return new t.HeaderCard({title:l.Loc.getMessage("LANDING_FORM_SETTINGS_CRM_TYPE_1").replace("&nbsp;"," "),level:2})}))}},{key:"getType2Header",value:function e(){return this.cache.remember("type2header",(function(){return new t.HeaderCard({title:l.Loc.getMessage("LANDING_FORM_SETTINGS_CRM_TYPE_2").replace("&nbsp;"," "),level:2})}))}},{key:"getType3Header",value:function e(){return this.cache.remember("type3header",(function(){return new t.HeaderCard({title:l.Loc.getMessage("LANDING_FORM_SETTINGS_CRM_TYPE_3").replace("&nbsp;"," "),level:2})}))}},{key:"getType4Header",value:function e(){return this.cache.remember("type4header",(function(){return new t.HeaderCard({title:l.Loc.getMessage("LANDING_FORM_SETTINGS_CRM_TYPE_4").replace("&nbsp;"," "),level:2})}))}},{key:"getType6Header",value:function e(){return this.cache.remember("type6header",(function(){return new t.HeaderCard({title:l.Loc.getMessage("LANDING_FORM_SETTINGS_CRM_TYPE_6").replace("&nbsp;"," "),level:2})}))}},{key:"getDynamicHeader",value:function e(i){var n=this.cache.remember("dynamicHeader",(function(){return new t.HeaderCard({title:"",level:2})}));if(c.Type.isString(i)){n.setTitle(i)}return n}},{key:"getDynamicEntitiesField",value:function e(){var t=this;return this.cache.remember("dynamicEntitiesField",(function(){var e=t.getSchemeById(t.options.formOptions.document.scheme);return new BX.Landing.UI.Field.Dropdown({selector:"dynamicScheme",title:l.Loc.getMessage("LANDING_FORM_SETTINGS_CRM_SMART_ENTITY_LIST"),items:t.options.dictionary.document.dynamic.map((function(e){return{name:e.name,value:e.id}})),content:e.mainEntity,onChange:function e(){t.onTypeChange(new a.BaseEvent({data:{item:{id:t.getSelectedSchemeId()}}}))}})}))}},{key:"getDynamicEntitySettingsForm",value:function e(){var t=this;return this.cache.remember("dynamicEntitySettingsForm",(function(){return new r.FormSettingsForm({opened:true,hidden:true,fields:[t.getDynamicEntitiesField()]})}))}},{key:"getExpertSettingsForm",value:function e(){var i=this;return this.cache.remember("expertSettingsForm",(function(){return new r.FormSettingsForm({title:l.Loc.getMessage("LANDING_FORM_SETTINGS_EXPERT_MODE"),toggleable:true,toggleableType:r.FormSettingsForm.ToggleableType.Link,opened:false,fields:[new t.HeaderCard({title:l.Loc.getMessage("LANDING_FORM_SETTINGS_CRM_TYPE_1").replace("&nbsp;"," "),level:2}),i.getDuplicatesField()]})}))}},{key:"getTypesField",value:function e(){var t=this;return this.cache.remember("typesField",(function(){setTimeout((function(){t.onTypeChange(new a.BaseEvent({data:{item:{id:t.options.formOptions.document.scheme}}}))}));var e=[{id:"2",title:l.Loc.getMessage("LANDING_FORM_SETTINGS_CRM_TYPE_2"),icon:"landing-ui-crm-entity-type2"},{id:"3",title:l.Loc.getMessage("LANDING_FORM_SETTINGS_CRM_TYPE_3"),icon:"landing-ui-crm-entity-type3"},{id:"4",title:l.Loc.getMessage("LANDING_FORM_SETTINGS_CRM_TYPE_4"),icon:"landing-ui-crm-entity-type4"},{id:"310",title:l.Loc.getMessage("LANDING_FORM_SETTINGS_CRM_TYPE_310"),icon:"landing-ui-crm-entity-type310"}];if(t.isDynamicAvailable()){e.push({id:"smart",title:l.Loc.getMessage("LANDING_FORM_SETTINGS_CRM_TYPE_5"),icon:"landing-ui-crm-entity-type5"})}if(t.options.isLeadEnabled){e.unshift({id:"1",title:l.Loc.getMessage("LANDING_FORM_SETTINGS_CRM_TYPE_1"),icon:"landing-ui-crm-entity-type1"})}return new n.RadioButtonField({selector:"scheme",value:function(){var e=c.Text.toNumber(t.options.formOptions.document.scheme);if(babelHelpers.classPrivateFieldGet(t,f).isDefaultScheme(e)&&babelHelpers.classPrivateFieldGet(t,f).isInvoice(e)){return babelHelpers.classPrivateFieldGet(t,f).getSpecularSchemeId(e)}if(String(t.options.formOptions.document.scheme)==="310"){return 310}var i=t.getSchemeById(t.options.formOptions.document.scheme);if(c.Type.isPlainObject(i)&&i.dynamic===true){return"smart"}return String(e)}(),items:e,onChange:t.onTypeChange.bind(t)})}))}},{key:"getDealCategoryField",value:function e(){var t=this;return this.cache.remember("dealCategoryField",(function(){return new h({categories:t.options.categories,value:{category:t.options.formOptions.document.deal.category}})}))}},{key:"getDynamicCategoriesField",value:function e(t){var i=this;return this.cache.remember("dynamicCategories#".concat(t),(function(){var e=i.getDynamicSchemeById(t);return new h({listTitle:l.Loc.getMessage("LANDING_FORM_SETTINGS_SMART_STAGES_FIELD_TITLE"),categories:e.categories,value:{category:i.options.formOptions.document.dynamic.category}})}))}},{key:"getDuplicatesEnabledField",value:function e(){var t=this;return this.cache.remember("duplicatesEnabledField",(function(){return new BX.Landing.UI.Field.Checkbox({selector:"duplicatesEnabled",compact:true,value:[t.options.formOptions.document.deal.duplicatesEnabled||"Y"],items:[{name:l.Loc.getMessage("LANDING_FORM_SETTINGS_CRM_DUPLICATES_ENABLED"),value:true}]})}))}},{key:"getSchemeById",value:function e(t){var i=this;return this.options.dictionary.document.schemes.find((function(e){return String(e.id)===String(t)||t==="smart"&&e.dynamic&&String(e.id)===String(i.getSelectedSchemeId())}))}},{key:"getDynamicSchemeById",value:function e(t){var i=this.getSchemeById(t),n=i.mainEntity;return this.options.dictionary.document.dynamic.find((function(e){return String(e.id)===String(n)}))}},{key:"setLastScheme",value:function e(t){this.cache.set("lastScheme",t)}},{key:"getLastScheme",value:function e(){return this.cache.get("lastScheme")}},{key:"setLastDealCategory",value:function e(t){this.cache.set("lastDealCategory",t)}},{key:"getLastDealCategory",value:function e(){return this.cache.get("lastDealCategory",null)}},{key:"onTypeChange",value:function e(t){var i=t.getData(),n=i.item;var a=this.getSchemeById(n.id);this.clear();this.addItem(this.getHeader());this.addItem(this.getTypesField());if(this.isDynamicAvailable()){this.addItem(this.getDynamicEntitySettingsForm());this.getDynamicEntitySettingsForm().hide()}var r=this.getExpertSettingsForm();r.clear();if(String(n.id)==="1"||String(n.id)==="8"){r.addField(this.getType1Header());r.addField(this.getDuplicatesField())}if(String(n.id)==="2"||String(n.id)==="5"){r.addField(this.getType2Header());r.addField(this.getDuplicatesField())}if(String(n.id)==="3"||String(n.id)==="6"){r.addField(this.getType3Header());r.addField(this.getDealCategoryField());r.addField(this.getDuplicatesEnabledField());r.addField(this.getDuplicatesField())}if(String(n.id)==="4"||String(n.id)==="7"){r.addField(this.getType4Header());r.addField(this.getDuplicatesField())}if(String(n.id)==="310"){r.addField(this.getType6Header());r.addField(this.getDuplicatesField())}if(c.Text.toNumber(n.id)>4&&c.Type.isPlainObject(a)&&a.dynamic!==true&&String(n.id)!=="9"||this.getOrderSettingsForm().isOpened()){this.getOrderSettingsForm().onSwitchChange(true)}if(c.Type.isPlainObject(a)&&(String(n.id)==="smart"||a.dynamic===true)&&this.isDynamicAvailable()){r.addField(this.getDynamicHeader(a.name));var s=this.getDynamicSchemeById(a.id);if(s&&s.categories){r.addField(this.getDynamicCategoriesField(a.id))}r.addField(this.getDuplicatesField());if(String(a.id).endsWith("1")){this.getOrderSettingsForm().onSwitchChange(true)}this.getDynamicEntitySettingsForm().show()}this.addItem(r);if(String(n.id)!=="310"){this.addItem(this.getOrderSettingsForm())}}},{key:"setAdditionalValue",value:function e(t){this.cache.set("additionalValue",t)}},{key:"getAdditionalValue",value:function e(){return this.cache.get("additionalValue",{})}},{key:"getEntityChangeConfirm",value:function e(){return this.cache.remember("entityChangeConfirm",(function(){return new s.MessageBox({title:l.Loc.getMessage("LANDING_FORM_SETTINGS_PANEL_CRM_SCHEME_CHANGE_CONFIRM_TITLE"),buttons:s.MessageBoxButtons.OK_CANCEL})}))}},{key:"getDealCategoryChangeConfirm",value:function e(){return this.cache.remember("dealCategoryChangeConfirm",(function(){return new s.MessageBox({title:l.Loc.getMessage("LANDING_FORM_SETTINGS_PANEL_CRM_SCHEME_CHANGE_CONFIRM_TITLE"),buttons:s.MessageBoxButtons.OK_CANCEL})}))}},{key:"getCreateOrderChangeConfirm",value:function e(){return this.cache.remember("createOrderChangeConfirm",(function(){return new s.MessageBox({title:l.Loc.getMessage("LANDING_FORM_SETTINGS_PANEL_CRM_SCHEME_CHANGE_CONFIRM_TITLE"),buttons:s.MessageBoxButtons.OK_CANCEL})}))}},{key:"onChange",value:function e(t){var i=this;var n=this.getValue();var r=this.getSchemeById(n.document.scheme);if(c.Type.isPlainObject(r)){var s=r.entities;var o=this.options.formOptions.presetFields.filter((function(e){return!s.includes(e.entityName)})).map((function(e){return i.getCrmFieldById("".concat(e.entityName,"_").concat(e.fieldName))}));if(c.Type.isArrayFilled(o)){var d=l.Loc.getMessage("LANDING_FORM_SETTINGS_PANEL_CRM_ITEM_TEMPLATE");var g=c.Text.encode(d.replace("{text}",r.name));var u=function(){var e=o.map((function(e){return d.replace("{text}",c.Text.encode(e.caption))}));if(o.length>1){var t=e.pop();return l.Loc.getMessage("LANDING_FORM_SETTINGS_PANEL_CRM_SCHEME_CHANGE_CONFIRM_TEXT").replace("{fieldsList}",e.join(", ")).replace("{lastField}",c.Text.encode(t)).replaceAll("{entityName}",g)}return l.Loc.getMessage("LANDING_FORM_SETTINGS_PANEL_CRM_SCHEME_CHANGE_CONFIRM_TEXT_1").replace("{fieldName}",e.join(", ")).replaceAll("{entityName}",g)}();var m=this.getEntityChangeConfirm();m.setOkCallback((function(){m.close();m.getOkButton().setDisabled(false);m.getCancelButton().setDisabled(false);var e=i.options.formOptions.presetFields.filter((function(e){return s.includes(e.entityName)}));i.setLastScheme(r.id);i.setAdditionalValue({presetFields:e});i.options.formOptions.presetFields=e;i.emit("onChange",y(y({},t.getData()),{},{skipPrepare:true}));i.setAdditionalValue({})}));m.setCancelCallback((function(){m.close();m.getOkButton().setDisabled(false);m.getCancelButton().setDisabled(false);var e=i.getSchemeById(i.getLastScheme());if(e.dynamic){i.getTypesField().setValue("smart",true);i.getDynamicEntitiesField().setValue(e.mainEntity,true)}else{i.getTypesField().setValue(e.id)}i.onTypeChange(new a.BaseEvent({data:{item:{id:e.id}}}))}));m.setMessage(u);m.show();return}if(String(r.id)==="3"||String(r.id)==="6"){var h=this.getLastDealCategory();if(c.Text.toNumber(n.document.deal.category)!==c.Text.toNumber(h)){var p=this.options.formOptions.presetFields.find((function(e){return e.entityName==="DEAL"&&e.fieldName==="STAGE_ID"}));if(p){var _=this.getCrmFieldById("DEAL_STAGE_ID");var S=this.getDealCategoryChangeConfirm();var T=l.Loc.getMessage("LANDING_FORM_SETTINGS_PANEL_CRM_ITEM_TEMPLATE").replace("{text}",c.Text.encode(_.caption));var C=l.Loc.getMessage("LANDING_FORM_SETTINGS_PANEL_CRM_CATEGORY_CHANGE_CONFIRM_TEXT").replace("{fieldName}",T);S.setMessage(C);S.setOkCallback((function(){S.close();S.getOkButton().setDisabled(false);S.getCancelButton().setDisabled(false);var e=i.options.formOptions.presetFields.filter((function(e){return e!==p}));i.options.formOptions.presetFields=e;i.setLastDealCategory(n.document.deal.category);i.setAdditionalValue({presetFields:e});i.emit("onChange",y(y({},t.getData()),{},{skipPrepare:true}));i.setAdditionalValue({})}));S.setCancelCallback((function(){S.close();S.getOkButton().setDisabled(false);S.getCancelButton().setDisabled(false);i.getDealCategoryField().setValue({category:i.getLastDealCategory()});i.setAdditionalValue({})}));S.show();return}}}}if(!babelHelpers.classPrivateFieldGet(this,f).isInvoice(r.id)&&n.document.payment.use){var E=this.getCreateOrderChangeConfirm();E.setMessage(l.Loc.getMessage("LANDING_FORM_SETTINGS_PANEL_CRM_CREATE_ORDER_MESSAGE_BOX_TITLE"));E.setOkCallback((function(e){e.close();e.getOkButton().setDisabled(false);i.options.formOptions.payment.use=false;i.onChange(t)}));E.setCancelCallback((function(e){e.close();e.getCancelButton().setDisabled(false);var n=i.getOrderSettingsForm().getSwitch();n.setValue(true);n.onChange();i.onChange(t)}));E.show()}this.emit("onChange",y(y({},t.getData()),{},{skipPrepare:true}))}},{key:"getCrmFieldById",value:function e(t){return Object.values(this.options.crmFields).reduce((function(e,t){return[].concat(babelHelpers.toConsumableArray(e),babelHelpers.toConsumableArray(t.FIELDS))}),[]).find((function(e){return e.name===t}))}},{key:"getSelectedSchemeId",value:function e(){var t=this.getTypesField().getValue();if(String(t)==="smart"){var i=this.getDynamicEntitiesField().getValue();if(this.getOrderSettingsForm().isOpened()){return"".concat(i,"1")}return"".concat(i,"0")}return t}},{key:"valueReducer",value:function e(t){var i=this.getDuplicatesField().getValue()[0];var n={duplicateMode:i==="ALLOW"?"":i,scheme:this.getSelectedSchemeId(),deal:{duplicatesEnabled:c.Text.toBoolean(this.getDuplicatesEnabledField().getValue()[0])},payment:{use:this.options.formOptions.payment.use,payer:this.options.formOptions.payment.payer,disabledSystems:this.options.formOptions.payment.disabledSystems},dynamic:{category:null}};if(this.getOrderSettingsForm().isOpened()){if(String(n.scheme)==="1"){n.scheme="8"}if(String(n.scheme)==="2"){n.scheme="5"}if(String(n.scheme)==="3"){n.scheme="6"}if(String(n.scheme)==="4"){n.scheme="7"}}if(String(n.scheme)==="3"||String(n.scheme)==="6"){n.deal.category=this.getDealCategoryField().getValue().category}var a=this.getSchemeById(n.scheme);var r=this.getDynamicSchemeById(n.scheme);if(c.Type.isPlainObject(a)&&a.dynamic&&r&&r.categories){n.dynamic.category=this.getDynamicCategoriesField(a.id).getValue().category}return y({document:n},this.getAdditionalValue())}}]);return i}(i.ContentWrapper);e.default=_})(this.BX.Landing.Ui.Panel.Formsettingspanel.Content=this.BX.Landing.Ui.Panel.Formsettingspanel.Content||{},BX.Landing.UI.Card,BX.Landing.UI.Panel,BX.Landing.UI.Field,BX.Event,BX.Landing.UI.Form,BX.UI.Dialogs,BX.Landing.UI.Field,BX.Landing,BX,BX.Landing.Ui.Panel.Formsettingspanel.Content.Crm);
//# sourceMappingURL=crm.bundle.map.js