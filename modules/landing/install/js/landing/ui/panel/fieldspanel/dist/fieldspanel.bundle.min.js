this.BX=this.BX||{};this.BX.Landing=this.BX.Landing||{};this.BX.Landing.UI=this.BX.Landing.UI||{};(function(e,t,i,n,a,r,s,l,o,c,d,u,h){"use strict";function g(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-panel-content-create-field">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"]);g=function t(){return e};return e}function f(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div\n\t\t\t\t\tclass="landing-ui-panel-content-create-field-button"\n\t\t\t\t\tonclick="','"\n\t\t\t\t>\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"]);f=function t(){return e};return e}function y(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="landing-ui-panel-content-element landing-ui-panel-content-search">\n\t\t\t\t\t','\n\t\t\t\t\t<div class="landing-ui-panel-content-search-icon"></div>\n\t\t\t\t</div>\n\t\t\t']);y=function t(){return e};return e}var v=function(e){babelHelpers.inherits(i,e);babelHelpers.createClass(i,null,[{key:"getInstance",value:function e(t){var n=r.PageObject.getRootWindow();var a=n.BX.Landing.UI.Panel.FieldsPanel;if(!a.instance&&!i.instance){a.instance=new i(t)}var s=a.instance||i.instance;s.options=t;return s}}]);function i(){var e;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,i);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(e),"adjustActionsPanels",false);e.setEventNamespace("BX.Landing.UI.Panel.FieldsPanel");e.setLayoutClass("landing-ui-panel-fields");e.setOverlayClass("landing-ui-panel-fields-overlay");e.setTitle(l.Loc.getMessage("LANDING_FIELDS_PANEL_TITLE"));e.onSaveClick=e.onSaveClick.bind(babelHelpers.assertThisInitialized(e));e.onCancelClick=e.onCancelClick.bind(babelHelpers.assertThisInitialized(e));e.options=n;e.cache=new t.Cache.MemoryCache;t.Dom.append(e.layout,e.getViewContainer());t.Dom.append(e.overlay,e.getViewContainer());t.Dom.insertAfter(e.getSearchContainer(),e.header);t.Dom.append(e.getCreateFieldLayout(),e.body);e.showLoader();e.loadPromise=e.load().then(function(){e.hideLoader();Object.entries(e.getCrmFields()).forEach(function(i){var a=babelHelpers.slicedToArray(i,2),r=a[0],l=a[1];if(r!=="CATALOG"&&r!=="ACTIVITY"&&r!=="INVOICE"){if(t.Type.isPlainObject(n)&&t.Type.isBoolean(n.isLeadEnabled)&&!n.isLeadEnabled&&r==="LEAD"){return}var o=new s.SidebarButton({id:r,text:l.CAPTION,child:true,onClick:function t(){e.onSidebarButtonClick(o)}});e.appendSidebarButton(o)}})});e.appendFooterButton(new c.BaseButton("save_settings",{text:l.Loc.getMessage("LANDING_FIELDS_PANEL_ADD_SELECTED_BUTTON"),onClick:e.onSaveClick,className:"landing-ui-button-content-save",attrs:{title:l.Loc.getMessage("LANDING_TITLE_OF_SLIDER_SAVE")}}));e.appendFooterButton(new c.BaseButton("cancel_settings",{text:l.Loc.getMessage("BLOCK_CANCEL"),onClick:e.onCancelClick,className:"landing-ui-button-content-cancel",attrs:{title:l.Loc.getMessage("LANDING_TITLE_OF_SLIDER_CANCEL")}}));return e}babelHelpers.createClass(i,[{key:"isMultiple",value:function e(){return this.cache.get("multiple",true)}},{key:"setMultiple",value:function e(t){this.cache.set("multiple",t)}},{key:"setAllowedTypes",value:function e(t){this.cache.set("allowedTypes",t)}},{key:"getAllowedTypes",value:function e(){return this.cache.get("allowedTypes",[])}},{key:"setDisabledFields",value:function e(t){this.cache.set("disabledFields",t)}},{key:"getDisabledFields",value:function e(){return this.cache.get("disabledFields",[])}},{key:"setAllowedCategories",value:function e(t){this.cache.set("allowedCategories",t)}},{key:"getAllowedCategories",value:function e(){return this.cache.get("allowedCategories",[])}},{key:"resetFactoriesCache",value:function e(){var t=this;this.cache.keys().forEach(function(e){if(e.startsWith("userFieldFactory_")){t.cache.delete(e)}})}},{key:"show",value:function e(){var n=this;var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.getSearchField().input.textContent="";this.setMultiple(true);this.setAllowedTypes([]);this.setDisabledFields([]);this.setAllowedCategories([]);this.resetFactoriesCache();if(t.Type.isArrayFilled(a.disabledFields)){this.setDisabledFields(a.disabledFields)}if(t.Type.isArrayFilled(a.allowedCategories)){this.setAllowedCategories(a.allowedCategories)}if(t.Type.isArrayFilled(a.allowedTypes)){this.setAllowedTypes(a.allowedTypes)}if(t.Type.isBoolean(a.multiple)){this.setMultiple(a.multiple)}this.loadPromise.then(function(){n.sidebarButtons.forEach(function(e){t.Dom.show(e.layout)});if(a.isLeadEnabled===false){var e=n.sidebarButtons.get("LEAD");if(e){t.Dom.hide(e.layout)}}if(t.Type.isArrayFilled(a.allowedCategories)){n.sidebarButtons.forEach(function(e){if(!a.allowedCategories.includes(e.id)){t.Dom.hide(e.layout)}else{t.Dom.show(e.layout)}})}else{n.sidebarButtons.forEach(function(e){t.Dom.show(e.layout)})}var i=n.getFilteredFieldsTree();var r=Object.keys(i);n.sidebarButtons.forEach(function(e){e.deactivate();if(r.includes(e.id)){t.Dom.show(e.getLayout())}else{t.Dom.hide(e.getLayout())}});if(n.sidebarButtons.length>0){n.resetState();var s=n.sidebarButtons.find(function(e){return e.getLayout().hidden!==true});if(s){s.getLayout().click()}}});babelHelpers.get(babelHelpers.getPrototypeOf(i.prototype),"show",this).call(this,a).then(function(){n.getSearchField().enableEdit();n.getSearchField().input.focus()});return new Promise(function(e){n.promiseResolver=e})}},{key:"hide",value:function e(){this.setCrmFields(this.getOriginalCrmFields());return babelHelpers.get(babelHelpers.getPrototypeOf(i.prototype),"hide",this).call(this)}},{key:"onSaveClick",value:function e(){var t=Object.values(this.getState()).reduce(function(e,t){return[].concat(babelHelpers.toConsumableArray(e),babelHelpers.toConsumableArray(t))},[]);this.promiseResolver(t);void this.hide();this.resetState()}},{key:"onCancelClick",value:function e(){void this.hide();this.resetState()}},{key:"getViewContainer",value:function e(){return this.cache.remember("viewContainer",function(){var e=r.PageObject.getRootWindow();return e.document.querySelector(".landing-ui-view-container")})}},{key:"getLoader",value:function e(){var t=this;return this.cache.remember("loader",function(){return new n.Loader({target:t.body})})}},{key:"showLoader",value:function e(){this.hideCreateFieldButton();void this.getLoader().show()}},{key:"hideLoader",value:function e(){this.showCreateFieldButton();void this.getLoader().hide()}},{key:"load",value:function e(){var t=this;return a.Backend.getInstance().action("Form::getCrmFields").then(function(e){t.setOriginalCrmFields(e);t.setCrmFields(e);Object.assign(u.FormSettingsPanel.getInstance().getCrmFields(),e);return h.FormClient.getInstance().getDictionary().then(function(e){t.setFormDictionary(e)})})}},{key:"setFormDictionary",value:function e(t){this.cache.set("formDictionary",t)}},{key:"getFormDictionary",value:function e(){return this.cache.get("formDictionary",{})}},{key:"setOriginalCrmFields",value:function e(t){this.cache.set("originalFields",t)}},{key:"getOriginalCrmFields",value:function e(){return this.cache.get("originalFields")||{}}},{key:"setCrmFields",value:function e(t){this.cache.set("fields",t)}},{key:"getCrmFields",value:function e(){return this.cache.get("fields")||{}}},{key:"setState",value:function e(t){this.cache.set("state",t)}},{key:"getState",value:function e(){return this.cache.get("state")||{}}},{key:"resetState",value:function e(){this.cache.delete("state")}},{key:"onSidebarButtonClick",value:function e(i){var n=this.sidebarButtons.getActive();if(n){n.deactivate()}i.activate();var a=this.getAllowedTypes().every(function(e){return t.Type.isPlainObject(e)});if(t.Type.isArrayFilled(this.getAllowedTypes())&&a){this.hideCreateFieldButton()}else{this.showCreateFieldButton()}var r=this.getCrmFields();if(Reflect.has(r,i.id)){this.clearContent();var s=this.createFieldsListForm(i.id);this.appendForm(s)}}},{key:"getFilteredFieldsTree",value:function e(){var i=String(this.getSearchField().getValue()).toLowerCase().trim();var n=this.getAllowedCategories();var a=this.getAllowedTypes();return Object.entries(this.getCrmFields()).reduce(function(e,r){var s=babelHelpers.slicedToArray(r,2),l=s[0],o=s[1];if(l!=="CATALOG"&&l!=="ACTIVITY"&&l!=="INVOICE"&&(!t.Type.isArrayFilled(n)||n.includes(l))){var c=o.FIELDS.filter(function(e){var n=String(e.caption).toLowerCase().trim();if(t.Type.isArrayFilled(a)){var r=a.some(function(i){if(!t.Type.isPlainObject(i)){i={type:i}}if(i.entityFieldName&&i.entityFieldName!==e.entity_field_name){return false}if(t.Type.isBoolean(i.multiple)&&i.multiple!==e.multiple){return false}return e.type===i.type});if(!r){return false}}return!t.Type.isStringFilled(i)||n.includes(i)});if(t.Type.isArrayFilled(c)){e[l]=babelHelpers.objectSpread({},o,{FIELDS:c})}}return e},{})}},{key:"createFieldsListForm",value:function e(i){var n=this;var a=this.getFilteredFieldsTree();var r=this.getDisabledFields();var s={items:a[i].FIELDS.map(function(e){return{name:e.caption,value:e.name,disabled:t.Type.isArrayFilled(r)&&r.includes(e.name)}}),value:this.getState()[i]||[],onValueChange:function e(t){var a=babelHelpers.objectSpread({},n.getState());a[i]=t.getValue();n.setState(a)}};return new o.FormSettingsForm({fields:[this.isMultiple()?new BX.Landing.UI.Field.Checkbox(s):new BX.Landing.UI.Field.Radio(s)]})}},{key:"onSearchChange",value:function e(){var i=this.getFilteredFieldsTree();var n=Object.keys(i);this.sidebarButtons.forEach(function(e){e.deactivate();if(n.includes(e.id)){t.Dom.show(e.getLayout())}else{t.Dom.hide(e.getLayout())}});this.clearContent();var a=babelHelpers.slicedToArray(n,1),r=a[0];if(r){var s=this.sidebarButtons.get(r);if(s){s.activate()}var l=this.createFieldsListForm(r);this.showCreateFieldButton();this.appendForm(l)}else{this.hideCreateFieldButton()}}},{key:"getSearchField",value:function e(){var t=this;return this.cache.remember("searchField",function(){var e=r.PageObject.getRootWindow();return new e.BX.Landing.UI.Field.Text({selector:"search",textOnly:true,placeholder:l.Loc.getMessage("LANDING_FIELDS_PANEL_SEARCH"),onChange:t.onSearchChange.bind(t)})})}},{key:"getSearchContainer",value:function e(){var i=this;return this.cache.remember("searchLayout",function(){return t.Tag.render(y(),i.getSearchField().getLayout())})}},{key:"getUserFieldFactory",value:function e(i){var n=this;var a=this.cache.remember("userFieldFactory_".concat(i),function(){var e=r.PageObject.getRootWindow();var t=function(){if(i.startsWith("DYNAMIC_")){return n.getCrmFields()[i].DYNAMIC_ID}return"CRM_".concat(i)}();return new e.BX.UI.UserFieldFactory.Factory(t,{moduleId:"crm",bindElement:n.getCreateFieldButton()})});if(t.Type.isArrayFilled(this.getAllowedTypes())){a.types=a.types.filter(function(e){return n.getAllowedTypes().includes(e.name)})}else{a.types=a.types.filter(function(e){return e.name!=="employee"})}return a}},{key:"onCreateFieldClick",value:function e(i){var n=this;i.preventDefault();var a=this.getFormDictionary();if(t.Type.isPlainObject(a.permissions)&&t.Type.isPlainObject(a.permissions.userField)&&a.permissions.userField.add===false){var s=r.PageObject.getRootWindow();s.BX.UI.Dialogs.MessageBox.alert(l.Loc.getMessage("LANDING_FORM_ADD_USER_FIELD_PERMISSION_DENIED"));return}var o=this.sidebarButtons.getActive();var c=o.id;var d=this.getUserFieldFactory(c);var u=d.getMenu();u.open(function(e){var i=d.getConfigurator({userField:d.createUserField(e),onSave:function e(t){t.save().then(function(){return n.load()}).then(function(){n.getSearchField().setValue(t.getData().editFormLabel[l.Loc.getMessage("LANGUAGE_ID")]);n.showCreateFieldButton()})},onCancel:function e(){n.showCreateFieldButton();n.sidebarButtons.getActive().getLayout().click()}});n.clearContent();t.Dom.append(i.render(),n.content);n.hideCreateFieldButton()})}},{key:"getCreateFieldButton",value:function e(){var i=this;return this.cache.remember("getCreateFieldButton",function(){return t.Tag.render(f(),i.onCreateFieldClick.bind(i),l.Loc.getMessage("LANDING_FIELDS_PANEL_CREATE_FIELD"))})}},{key:"getCreateFieldLayout",value:function e(){var i=this;return this.cache.remember("createFieldLayout",function(){return t.Tag.render(g(),i.getCreateFieldButton())})}},{key:"isUserFieldEditorShowed",value:function e(){return t.Type.isDomNode(this.content.querySelector(".ui-userfieldfactory-configurator"))}},{key:"showCreateFieldButton",value:function e(){t.Dom.append(this.getCreateFieldLayout(),this.body)}},{key:"hideCreateFieldButton",value:function e(){t.Dom.remove(this.getCreateFieldLayout(),this.body)}}]);return i}(i.Content);e.FieldsPanel=v})(this.BX.Landing.UI.Panel=this.BX.Landing.UI.Panel||{},BX,BX.Landing.UI.Panel,BX,BX.Landing,BX.Landing,BX.Landing.UI.Button,BX.Landing,BX.Landing.UI.Form,BX.Landing.UI.Button,BX.Landing.UI.Field,BX.Landing.UI.Panel,BX.Crm.Form);
//# sourceMappingURL=fieldspanel.bundle.map.js