(function(){"use strict";BX.namespace("BX.Landing");var a=BX.Landing.Utils.isPlainObject;var n=BX.Landing.Utils.isString;var t=BX.Landing.Utils.addQueryParams;BX.Landing.Backend=function(){this.ajaxController=t("/bitrix/tools/landing/ajax.php",{site:BX.message["SITE_ID"]?BX.message("SITE_ID"):undefined})};BX.Landing.Backend.instance=null;BX.Landing.Backend.getInstance=function(){if(!BX.Landing.Backend.instance){BX.Landing.Backend.instance=new BX.Landing.Backend}return BX.Landing.Backend.instance};BX.Landing.Backend.prototype={action:function(a,t,i,e){e=BX.type.isPlainObject(e)?e:{};i=BX.type.isPlainObject(i)?i:{};BX.Landing.Utils.assign(i,{site_id:this.getSiteId()});var o={};o.sessid=BX.bitrix_sessid();o.action=a.replace("Landing\\Block","Block");o.data=typeof t==="object"?t:{};o.data.lid=o.data.lid||BX.Landing.Main.getInstance().id;if("action"in e){o.action=e.action}if("block"in e){o.data.block=e.block}if("lid"in e){o.data.lid=e.lid}if("id"in e){o.data.id=e.id}var d=BX.util.add_url_param(this.ajaxController,BX.util.objectMerge({action:o.action},i));return new Promise(function(a,n){BX.ajax({method:"POST",dataType:"json",url:d,data:o,onsuccess:function(t){if(!!t&&t.type==="error"){n(t)}else{a(t.result)}},onfailure:function(a){n(a)}})}).then(function(a){if(o.action==="Block::updateNodes"||o.action==="Block::removeCard"||o.action==="Block::cloneCard"||o.action==="Block::addCard"||o.action==="Block::updateStyles"){BX.Landing.UI.Panel.StatusPanel.getInstance().update()}return a}).catch(function(a){if(o.action!=="Block::getById"){a=n(a)?{type:"error"}:a;a.action=o.action;BX.Landing.ErrorManager.getInstance().add(a)}return Promise.reject()})},batch:function(a,t,i){i=BX.type.isPlainObject(i)?i:{};BX.Landing.Utils.assign(i,{site_id:t.siteId||this.getSiteId()});var e={};e.sessid=BX.bitrix_sessid();e.action=a.replace("Landing\\Block","Block");e.data={};e.batch=typeof t==="object"?t:{};e.data.lid=e.data.lid||BX.Landing.Main.getInstance().id;var o=BX.util.add_url_param(this.ajaxController,BX.util.objectMerge({action:e.action},i));return new Promise(function(a,n){BX.ajax({method:"POST",dataType:"json",url:o,data:e,onsuccess:function(t){if(!!t&&t.type==="error"){n(t)}else{a(t)}},onfailure:function(a){n(a)}})}).then(function(a){BX.Landing.UI.Panel.StatusPanel.getInstance().update();return a}).catch(function(a){if(e.action!=="Block::getById"){a=n(a)?{type:"error"}:a;a.action=e.action;BX.Landing.ErrorManager.getInstance().add(a)}return Promise.reject()})},getSiteId:function(){var a;try{a=BX.Landing.Main.getInstance().options.site_id}catch(n){a=-1}return a},upload:function(a,t){var i=new FormData;var e=t||{};var o="Block::uploadFile";i.append("sessid",BX.bitrix_sessid());i.append("action","Block::uploadFile");i.append("picture",a,a.name);if("block"in e){i.append("data[block]",e.block)}if("lid"in e){o="Landing::uploadFile";i.append("data[lid]",e.lid);i.set("action",o)}if("id"in e){o="Site::uploadFile";i.append("data[id]",e.id);i.set("action",o)}var d=BX.util.add_url_param(this.ajaxController,{action:o,site_id:this.getSiteId()});if(e.context){d=BX.util.add_url_param(d,{context:e.context})}return new Promise(function(a,n){var t=BX.ajax({url:d,method:"POST",dataType:"json",data:i,start:false,preparePost:false,onsuccess:function(t){if(!!t&&t.type==="error"){n(t)}else{a(t.result)}},onfailure:function(a){n(a)}});t.send(i)}).catch(function(a){a=n(a)?{type:"error"}:a;a.action="Block::uploadFile";BX.Landing.ErrorManager.getInstance().add(a);return Promise.reject(a)})},uploadImage:function(t,i,e,o){if(!t){t=document.createElement("form")}o=a(o)?o:{};var d={};d.sessid=BX.bitrix_sessid();d.action="action"in o?o.action:"Utils::uploadFile";d.picture=i;d.data={};d.data.params=typeof e==="object"?e:{};if("block"in o){d.data.block=o.block}if("lid"in o){d.data.lid=o.lid}if("id"in o){d.data.id=o.id}var r=BX.util.add_url_param(this.ajaxController,{action:d.action,site_id:this.getSiteId()});return new Promise(function(a,n){BX.ajax.submitAjax(t,{url:r,method:"POST",dataType:"json",data:d,onsuccess:function(t){if(!!t&&t.type==="error"){n(t)}else{a(t.result)}},onfailure:function(a){n(a)}})}).catch(function(a){a=n(a)?{type:"error"}:a;a.action=d.action;BX.Landing.ErrorManager.getInstance().add(a);return Promise.reject()})}}})();
//# sourceMappingURL=backend.map.js