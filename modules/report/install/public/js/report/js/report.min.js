BX.namespace("BX.Report");BX.mergeEx(BX.Report,{firstButtonInModalWindow:null,windowsWithoutManager:{},entityToNewShared:{},ajax:function(e){e.data=e.data||{};e.data["SITE_ID"]=BX.message("SITE_ID");e.data["sessid"]=BX.bitrix_sessid();return BX.ajax(e)},modalWindow:function(e){e=e||{};e.title=e.title||false;e.bindElement=e.bindElement||null;e.overlay=typeof e.overlay=="undefined"?true:e.overlay;e.autoHide=e.autoHide||false;e.closeIcon=typeof e.closeIcon=="undefined"?{right:"20px",top:"10px"}:e.closeIcon;e.modalId=e.modalId||"report_modal_window_"+(Math.random()*(2e5-100)+100);e.withoutContentWrap=typeof e.withoutContentWrap=="undefined"?false:e.withoutContentWrap;e.contentClassName=e.contentClassName||"";e.contentStyle=e.contentStyle||{};e.content=e.content||[];e.buttons=e.buttons||false;e.events=e.events||{};e.withoutWindowManager=!!e.withoutWindowManager||false;var t=[];if(e.title){t.push(BX.create("div",{props:{className:"bx-report-popup-title"},text:e.title}))}if(e.withoutContentWrap){t=t.concat(e.content)}else{t.push(BX.create("div",{props:{className:"bx-report-popup-content "+e.contentClassName},style:e.contentStyle,children:e.content}))}var n=[];if(e.buttons){for(var s in e.buttons){if(!e.buttons.hasOwnProperty(s)){continue}if(s>0){n.push(BX.create("SPAN",{html:"&nbsp;"}))}n.push(e.buttons[s])}t.push(BX.create("div",{props:{className:"bx-report-popup-buttons"},children:n}))}var i=BX.create("div",{props:{className:"bx-report-popup-container"},children:t});e.events.onPopupShow=BX.delegate(function(){if(n.length){this.firstButtonInModalWindow=n[0];BX.bind(document,"keydown",BX.proxy(this._keyPress,this))}if(e.events.onPopupShow)BX.delegate(e.events.onPopupShow,BX.proxy_context)},this);var o=e.events.onPopupClose;e.events.onPopupClose=BX.delegate(function(){this.firstButtonInModalWindow=null;try{BX.unbind(document,"keydown",BX.proxy(this._keypress,this))}catch(e){}if(o){BX.delegate(o,BX.proxy_context)()}if(e.withoutWindowManager){delete this.windowsWithoutManager[e.modalId]}BX.proxy_context.destroy()},this);var r;if(e.withoutWindowManager){if(!!this.windowsWithoutManager[e.modalId]){return this.windowsWithoutManager[e.modalId]}r=new BX.PopupWindow(e.modalId,e.bindElement,{content:i,closeByEsc:true,closeIcon:e.closeIcon,autoHide:e.autoHide,overlay:e.overlay,events:e.events,buttons:[],zIndex:isNaN(e["zIndex"])?0:e.zIndex});this.windowsWithoutManager[e.modalId]=r}else{r=BX.PopupWindowManager.create(e.modalId,e.bindElement,{content:i,closeByEsc:true,closeIcon:e.closeIcon,autoHide:e.autoHide,overlay:e.overlay,events:e.events,buttons:[],zIndex:isNaN(e["zIndex"])?0:e.zIndex})}r.show();return r},modalWindowLoader:function(e,t,n){n=n||null;t=t||{};var s=t.id;var i=t.responseType||"html";var o=t.afterSuccessLoad||null;var r=t.onPopupClose||null;var a=t.postData||{};var l=BX.PopupWindowManager.create("bx-report-"+s,n,{closeIcon:true,offsetTop:5,autoHide:true,lightShadow:false,overlay:true,content:BX.create("div",{children:[BX.create("div",{style:{display:"table",width:"30px",height:"30px"},children:[BX.create("div",{style:{display:"table-cell",verticalAlign:"middle",textAlign:"center"},children:[BX.create("div",{props:{className:"bx-report-wrap-loading-modal"}}),BX.create("span",{text:""})]})]})]}),closeByEsc:true,events:{onPopupClose:function(){if(r){BX.delegate(r,this)()}this.destroy()}}});l.show();a["sessid"]=BX.bitrix_sessid();a["SITE_ID"]=BX.message("SITE_ID");BX.ajax({url:e,method:"POST",dataType:i,data:a,onsuccess:BX.delegate(function(e){if(i=="html"){l.setContent(BX.create("DIV",{html:e}));l.adjustPosition()}else if(i=="json"){e=e||{}}o&&o(e,l)},this),onfailure:function(e){}})},getRightLabelByName:function(e){switch(e.toLowerCase()){case"access_read":return BX.message("REPORT_JS_SHARING_RIGHT_READ");case"access_edit":return BX.message("REPORT_JS_SHARING_RIGHT_EDIT");default:return"error"}},appendNewShared:function(e){var t=e.readOnly;var n=e.destFormName;var s=e.item.id;var i=e.item.name;var o=e.item.avatar;var r=e.type;var a=e.right||"access_read";this.entityToNewShared[s]={item:e.item,type:e.type,right:a};BX("bx-report-popup-shared-people-list").appendChild(BX.create("tr",{attrs:{"data-dest-id":s},children:[BX.create("td",{props:{className:"bx-report-popup-shared-people-list-col1"},children:[BX.create("a",{props:{className:"bx-report-filepage-used-people-link"},children:[BX.create("span",{props:{className:"bx-report-filepage-used-people-avatar "+(r!="users"?" group":"")},style:{backgroundImage:o?"url("+o+")":null}}),i]})]}),BX.create("td",{props:{className:"bx-report-popup-shared-people-list-col2"},children:[BX.create("a",{props:{className:"bx-report-filepage-used-people-permission"},text:this.getRightLabelByName(a),events:{}})]}),BX.create("td",{props:{className:"bx-report-popup-shared-people-list-col3 tar"},children:[!t?BX.create("span",{props:{className:"bx-report-filepage-used-people-del"},events:{click:BX.delegate(function(e){BX.SocNetLogDestination.deleteItem(s,r,n);var t=e.target||e.srcElement;BX.remove(t.parentNode.parentNode)},this)}}):null]})]}))},removeElement:function(e){return e.parentNode?e.parentNode.removeChild(e):e},addToLinkParam:function(e,t,n){if(!e.length){return"?"+t+"="+n}e=BX.util.remove_url_param(e,t);if(e.indexOf("?")!=-1){return e+"&"+t+"="+n}return e+"?"+t+"="+n},getFirstErrorFromResponse:function(e){e=e||{};if(!e.errors)return"";return e.errors.shift().message},showModalWithStatusAction:function(e,t){e=e||{};if(!e.message){if(e.status=="success"){e.message=BX.message("REPORT_JS_STATUS_ACTION_SUCCESS")}else{e.message=BX.message("REPORT_JS_STATUS_ACTION_ERROR")+". "+this.getFirstErrorFromResponse(e)}}var n=BX.create("div",{props:{className:"bx-report-alert"},children:[BX.create("span",{props:{className:"bx-report-aligner"}}),BX.create("span",{props:{className:"bx-report-alert-text"},text:e.message}),BX.create("div",{props:{className:"bx-report-alert-footer"}})]});var s=BX.PopupWindowManager.getCurrentPopup();if(s){s.destroy()}var i=setTimeout(function(){var e=BX.PopupWindowManager.getCurrentPopup();if(!e||e.uniquePopupId!="bx-report-status-action"){return}e.close();e.destroy()},2500);var o=BX.PopupWindowManager.create("bx-report-status-action",null,{content:n,onPopupClose:function(){this.destroy();clearTimeout(i)},autoHide:true,zIndex:2e3,className:"bx-report-alert-popup"});o.show();BX("bx-report-status-action").onmouseover=function(e){clearTimeout(i)};BX("bx-report-status-action").onmouseout=function(e){i=setTimeout(function(){var e=BX.PopupWindowManager.getCurrentPopup();if(!e||e.uniquePopupId!="bx-report-status-action"){return}e.close();e.destroy()},2500)}},show:function(e){if(this.getRealDisplay(e)!="none")return;var t=e.getAttribute("displayOld");e.style.display=t||"";if(this.getRealDisplay(e)==="none"){var n=e.nodeName,s=document.body,i;if(displayCache[n]){i=displayCache[n]}else{var o=document.createElement(n);s.appendChild(o);i=this.getRealDisplay(o);if(i==="none"){i="block"}s.removeChild(o);displayCache[n]=i}e.setAttribute("displayOld",i);e.style.display=i}},hide:function(e){if(!e.getAttribute("displayOld")){e.setAttribute("displayOld",e.style.display)}e.style.display="none"},getRealDisplay:function(e){if(e.currentStyle){return e.currentStyle.display}else if(window.getComputedStyle){var t=window.getComputedStyle(e,null);return t.getPropertyValue("display")}},isEmptyObject:function(e){for(var t in e){return false}return true}});if(typeof BX.ReportUserSearchPopup==="undefined"){BX.ReportUserSearchPopup=function(){this._id="";this._search_input=null;this._data_input=null;this._componentName="";this._componentContainer=null;this._componentObj=null;this._serviceContainer=null;this._zIndex=0;this._dlg=null;this._dlgDisplayed=false;this._currentUser={};this._searchKeyHandler=BX.delegate(this._handleSearchKey,this);this._searchFocusHandler=BX.delegate(this._handleSearchFocus,this);this._externalClickHandler=BX.delegate(this._handleExternalClick,this);this._userSelectorInitCounter=0};BX.ReportUserSearchPopup.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:"crm_user_search_popup_"+Math.random();if(!t){t={}}if(!BX.type.isElementNode(t["searchInput"])){throw"BX.ReportUserSearchPopup: 'search_input' is not defined!"}this._search_input=t["searchInput"];if(!BX.type.isElementNode(t["dataInput"])){throw"BX.ReportUserSearchPopup: 'data_input' is not defined!"}this._data_input=t["dataInput"];if(!BX.type.isNotEmptyString(t["componentName"])){throw"BX.ReportUserSearchPopup: 'componentName' is not defined!"}this._currentUser=t["user"]?t["user"]:{};this._componentName=t["componentName"];this._componentContainer=BX(this._componentName+"_selector_content");this._initializeUserSelector();this._adjustUser();this._serviceContainer=t["serviceContainer"]?t["serviceContainer"]:document.body;this.setZIndex(t["zIndex"])},_initializeUserSelector:function(){var e="O_"+this._componentName;if(!window[e]){if(this._userSelectorInitCounter===10){throw"BX.ReportUserSearchPopup: Could not find '"+e+"' user selector!"}this._userSelectorInitCounter++;window.setTimeout(BX.delegate(this._initializeUserSelector,this),200);return}this._componentObj=window[e];this._componentObj.onSelect=BX.delegate(this._handleUserSelect,this);this._componentObj.searchInput=this._search_input;if(this._currentUser){this._componentObj.setSelected([this._currentUser])}BX.bind(this._search_input,"keyup",this._searchKeyHandler);BX.bind(this._search_input,"focus",this._searchFocusHandler);BX.bind(document,"click",this._externalClickHandler)},open:function(){this._componentContainer.style.display="";this._dlg=new BX.PopupWindow(this._id,this._search_input,{autoHide:false,draggable:false,closeByEsc:true,offsetLeft:0,offsetTop:0,zIndex:this._zIndex,bindOptions:{forceBindPosition:true},content:this._componentContainer,events:{onPopupShow:BX.delegate(function(){this._dlgDisplayed=true},this),onPopupClose:BX.delegate(function(){this._dlgDisplayed=false;this._componentContainer.parentNode.removeChild(this._componentContainer);this._serviceContainer.appendChild(this._componentContainer);this._componentContainer.style.display="none";this._dlg.destroy()},this),onPopupDestroy:BX.delegate(function(){this._dlg=null},this)}});this._dlg.show()},_adjustUser:function(){if(parseInt(this._currentUser["id"])>0){this._data_input.value=this._currentUser["id"];this._search_input.value=this._currentUser["name"]?this._currentUser.name:this._currentUser["id"]}else{this._data_input.value=this._search_input.value=""}},getZIndex:function(){return this._zIndex},setZIndex:function(e){if(typeof e==="undefined"||e===null){e=0}var t=parseInt(e);this._zIndex=!isNaN(t)?t:0},close:function(){if(this._dlg){this._dlg.close()}},select:function(e){this._currentUser=e;this._adjustUser();if(this._componentObj){this._componentObj.setSelected([e])}},_onBeforeDelete:function(){if(BX.type.isElementNode(this._search_input)){BX.unbind(this._search_input,"keyup",this._searchKeyHandler);BX.unbind(this._search_input,"focus",this._searchFocusHandler)}BX.unbind(document,"click",this._externalClickHandler)},_handleExternalClick:function(e){if(!e){e=window.event}if(!this._dlgDisplayed){return}var t=null;if(e){if(e.target){t=e.target}else if(e.srcElement){t=e.srcElement}}if(t!==this._search_input&&!BX.findParent(t,{attribute:{id:this._componentName+"_selector_content"}})){this._adjustUser();this.close()}},_handleSearchKey:function(e){if(!this._dlg||!this._dlgDisplayed){this.open()}this._componentObj.search()},_handleSearchFocus:function(e){if(!this._dlg||!this._dlgDisplayed){this.open()}this._componentObj._onFocus(e)},_handleUserSelect:function(e){this._currentUser=e;this._adjustUser();this.close()}};BX.ReportUserSearchPopup.items={};BX.ReportUserSearchPopup.create=function(e,t,n){if(isNaN(n)){n=0}if(n>0){window.setTimeout(function(){BX.ReportUserSearchPopup.create(e,t,0)},n);return null}var s=new BX.ReportUserSearchPopup;s.initialize(e,t);this.items[e]=s;return s};BX.ReportUserSearchPopup.createIfNotExists=function(e,t){var n=this.items[e];if(typeof n!=="undefined"){n.initialize(e,t)}else{n=new BX.ReportUserSearchPopup;n.initialize(e,t);this.items[e]=n}return n};BX.ReportUserSearchPopup.deletePopup=function(e){var t=this.items[e];if(typeof t==="undefined"){return false}t._onBeforeDelete();delete this.items[e];return true}}