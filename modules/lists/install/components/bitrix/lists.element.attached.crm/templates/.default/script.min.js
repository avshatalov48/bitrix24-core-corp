BX.namespace("BX.Lists");BX.Lists.ListsElementAttachedCrm=function(){var e=function(e){this.randomString=e.randomString;this.jsObject=e.jsObject;this.entityId=e.entityId;this.entityType=e.entityType;this.singleMode=Boolean(e.singleMode);this.iblockId=e.iblockId;this.gridPrefixId=e.gridPrefixId;this.listElementTemplateUrl=e.listElementTemplateUrl;this.backEndUrl=e.backEndUrl;this.fieldsForSetValue=e.fieldsForSetValue;this.init()};e.prototype.init=function(){this.gridId=this.gridPrefixId+this.iblockId;this.externalContext="creatingElementFromCrm";this.externalRequestData=null;this.externalEventHandler=null;BX.addCustomEvent("Grid::beforeRequest",BX.delegate(function(e,t){this.setGridRequestParams(e,t)},this));if(this.singleMode){BX.bind(BX("leac-button-add-element-"+this.iblockId),"click",BX.delegate(this.addElement,this))}};e.prototype.setGridRequestParams=function(e,t){if(t.gridId!=this.gridId)return;if(t.url=="")t.url=this.backEndUrl;t.url=BX.util.add_url_param(t.url,{gridId:t.gridId,entityId:this.entityId,entityType:this.entityType})};e.prototype.showElement=function(e,t,n){var i;window.open(n);i=BX.Main.gridManager.getById(e);if(i.hasOwnProperty("instance")){var a=i.instance.getRows().getById(t);if(a)a.closeActionsMenu()}};e.prototype.unBind=function(e,t){BX.Lists.modalWindow({modalId:"bx-lists-migrate-list",title:BX.message("LEACT_DELETE_POPUP_TITLE"),contentClassName:"",draggable:true,contentStyle:{width:"400px",padding:"20px 20px 20px 20px"},events:{onPopupClose:function(){this.destroy()}},content:BX.message("LEACT_TOOLBAR_ELEMENT_DELETE_WARNING"),buttons:[BX.create("span",{text:BX.message("LEACT_DELETE_POPUP_ACCEPT_BUTTON"),props:{className:"webform-small-button webform-small-button-accept"},events:{click:BX.delegate(function(){var n={},i;n["action_button_"+e]="delete";n["ID"]=[t];i=BX.Main.gridManager.getById(e);if(i.hasOwnProperty("instance")){i.instance.reloadTable("POST",n);var a=i.instance.getRows().getById(t);if(a)a.closeActionsMenu()}BX.PopupWindowManager.getCurrentPopup().close()},this)}}),BX.create("span",{text:BX.message("LEACT_DELETE_POPUP_CANCEL_BUTTON"),props:{className:"popup-window-button popup-window-button-link popup-window-button-link-cancel"},events:{click:BX.delegate(function(){BX.PopupWindowManager.getCurrentPopup().close()},this)}})]})};e.prototype.addElement=function(){this.performExternalRequest()};e.prototype.performExternalRequest=function(){var e=this.listElementTemplateUrl[this.iblockId];e=e.replace("#section_id#",0).replace("#element_id#",0);var t={external_context:this.externalContext};for(var n in this.fieldsForSetValue){t["fieldId"]=n;t["defaultValue"]=this.fieldsForSetValue[n].defaultValue}e=BX.util.add_url_param(e,t);if(!this.externalRequestData){this.externalRequestData={}}this.externalRequestData[this.externalContext]={context:this.externalContext,wnd:window.open(e)};if(!this.externalEventHandler){this.externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this.externalEventHandler)}BX.localStorage.set("externalValue_"+this.iblockId,this.fieldsForSetValue,10)};e.prototype.onExternalEvent=function(e){var t=BX.type.isNotEmptyString(e["key"])?e["key"]:"";var n=BX.type.isPlainObject(e["value"])?e["value"]:{};var i=BX.type.isNotEmptyString(n["context"])?n["context"]:"";if(t==="onElementCreate"&&this.externalRequestData&&BX.type.isPlainObject(this.externalRequestData[i])){var a=BX.type.isBoolean(n["isCanceled"])?n["isCanceled"]:false;if(!a&&BX.type.isPlainObject(n["elementInfo"])){if(this.iblockId==n["elementInfo"]["iblockId"]){BX.Main.gridManager.getById(this.gridId).instance.reload()}}if(this.externalRequestData[i]["wnd"]){this.externalRequestData[i]["wnd"].close()}delete this.externalRequestData[i]}};return e}();