BX.namespace("BX.Security.UserEdit");BX.Security.UserEdit.Otp=function t(e){"use strict";var i=function(t,i){var o={successfulUrl:document.location.href,deactivateDays:null,availableTypes:null,ui:{activateButtonId:"otp-activate",deactivateButtonId:"otp-deactivate",defferButtonId:"otp-deffer",mandatoryActivateButtonId:"otp-mandatory-active",reinitializeButtonId:"otp-reinitialize"}};i=i||{};this._options=r(o,i);this.userId=t||0;var c={availableTypes:this._options.availableTypes,successfulUrl:this._options.successfulUrl};this.device=new n(this.userId,c);this.mobile=new s(this.userId,c);this.recovery=new a(this.userId,c);var l=null;l=e(this._options.ui.deactivateButtonId);if(l){this.initializeDeactivatePopup(l,"deactivate")}l=e(this._options.ui.defferButtonId);if(l){this.initializeDeactivatePopup(l,"deffer")}l=e(this._options.ui.mandatoryActivateButtonId);if(l){this.initializeDeactivatePopup(l,"deffer",5)}l=e(this._options.ui.activateButtonId);if(l){e.bind(l,"click",this.mobile.activateOtp.bind(this.mobile))}l=e(this._options.ui.reinitializeButtonId);if(l){e.bind(l,"click",e.proxy(function u(){var t=window.document.body.querySelectorAll('[data-show-on-reinitialize="yes"]');[].forEach.call(t,function e(t){if(t.style.display)t.style.display="";else t.style.display="none"},this)},this))}};i.prototype.initializeDeactivatePopup=function(t,i,o){i=i||"deactivate";if(this._options.deactivateDays){var n=[];for(var s in this._options.deactivateDays){if(!this._options.deactivateDays.hasOwnProperty(s))continue;if(o&&s<o)continue;n.push({TEXT:this._options.deactivateDays[s],ONCLICK:this.mobile.deactivateOtp.bind(this.mobile,null,i,s)})}e.bind(t,"click",function(i){if(i)i.preventDefault();e.adminShowMenu(t,n,{active_class:"",close_on_click:true})}.bind(this))}else{e.bind(t,"click",this.mobile.deactivateOtp.bind(this,null,i,o?o:0))}};var o=function(t,i){var o={actionUrl:"/bitrix/admin/security_otp.ajax.php?lang="+e.message("LANGUAGE_ID"),onCompleteCallback:e.DoNothing,ui:{showButtonId:null,id:null}};i=i||{};this._options=r(o,i);this.initialized=false;this.popup=null;this.container=null;this.errorContainer=null;this.userId=t;this.showButton=e(this._options.ui.showButtonId);this.type=null;this.typeMenu=[];e.bind(this.showButton,"click",this.show.bind(this))};o.prototype.show=function(t){if(!this.initialized)this.initialize();else this.cleanPopup();this.onShow();if(t)t.preventDefault()};o.prototype.onShow=function(){};o.prototype.onInitialize=function(){};o.prototype.getSecret=function(){};o.prototype.getType=function(){return this.type};o.prototype.initialize=function(){this.initialized=true;this.container=e(this._options.ui.id);this.popup=this.getPopup();this.errorContainer=this.container.querySelector('[data-role="error-container"]');for(var t in this._options.availableTypes){if(!this._options.availableTypes.hasOwnProperty(t))continue;this.typeMenu.push({TEXT:this._options.availableTypes[t].title,ONCLICK:function o(t,e){if(e===void 0)e=true;this.type=t;this.onShow(true,e)}.bind(this,this._options.availableTypes[t].type,this._options.availableTypes[t]["required_two_code"])})}var i=this.container.querySelectorAll('input[data-role="check-code"]');this.popup.ClearButtons();this.popup.SetButtons([{title:e.message("JS_CORE_WINDOW_SAVE"),id:"check-button",className:"adm-btn-save",action:function n(t){if(t)t.preventDefault();this.onCheck(i[0],i[1]||null)}.bind(this)},e.CDialog.btnCancel]);this.onInitialize()};o.prototype.getPopup=function(){return new e.CDialog({title:this.container.getAttribute("data-title")||"",resizable:false,content:this.container})};o.prototype.cleanPopup=function(){[].forEach.call(this.container.querySelectorAll('[data-autoclear="yes"]'),function t(i){switch(i.tagName){case"INPUT":i.value="";break;case"SELECT":break;default:e.cleanNode(i)}},this)};o.prototype.sendRequest=function(t,i,o,n){e.showWait();i=i||{};i.action=t||"check";i.sessid=e.bitrix_sessid();if(!i.userId)i.user=this.userId;i=e.ajax.prepareData(i);return e.ajax({method:"POST",dataType:"json",url:this._options["actionUrl"],data:i,onsuccess:this.onRequestSuccess.bind(this,o),onfailure:this.onRequestFailed.bind(this,n)})};o.prototype.onRequestSuccess=function(t,i){e.closeWait();if(!i["status"]){this.onRequestFailed(null,i)}else if(i["status"]!=="ok"){this.onRequestFailed(null,i)}else{t(i)}};o.prototype.onRequestFailed=function(t,i){e.closeWait();if(!t){if(i["error"])this.showError(i["error"]);else this.showError(e.message("SEC_OTP_UNKNOWN_ERROR"))}else{t(i)}};o.prototype.showError=function(t){if(!this.errorContainer)return;var i=e.create("div",{children:[e.create("div",{text:e.message("SEC_OTP_ERROR_TITLE")}),e.create("div",{html:t})],attrs:{className:"bx-notice error"}});this.errorContainer.appendChild(i)};o.prototype.clearErrors=function(){if(!this.errorContainer)return;e.cleanNode(this.errorContainer)};o.prototype.onCheck=function(t,e){this.clearErrors();this.activate(t.value,e?e.value:"")};o.prototype.activate=function(t,i){var o={secret:this.getSecret(),type:this.getType(),sync1:t,sync2:i};this.sendRequest("check_activate",o,e.proxy(this.onFinish,this))};o.prototype.onFinish=function(){window.location.replace(this._options.successfulUrl)};o.prototype.showPopup=function(){this.popup.Show();this.popup.adjustSizeEx();e.defer(this.popup.adjustPos,this.popup)()};o.prototype.showTypeTitle=function(t){var e=this.container.querySelectorAll("[data-show-type]");[].forEach.call(e,function i(e){if(e.getAttribute("data-show-type")==t)e.style.display="";else e.style.display="none"})};o.prototype.showHideRedundantCodes=function(t){var e=this.container.querySelectorAll('[data-require-two-codes="yes"]');[].forEach.call(e,function i(e){if(t)e.style.display="";else e.style.display="none"})};var n=function(t,e){var i={ui:{showButtonId:"otp-connect-device",id:"otp-device-popup"}};e=e||{};e=r(i,e);this.secretCodeElement=null;this.typeElement=null;n.superclass.constructor.call(this,t,e)};e.extend(n,o);n.prototype.onShow=function(t,i){if(!t&&this.typeMenu.length){e.adminShowMenu(this.showButton,this.typeMenu,{active_class:"adm-btn-save-active"});return}this.showHideRedundantCodes(i);this.showTypeTitle(this.type);this.showPopup()};n.prototype.onInitialize=function(){this.secretCodeElement=this.container.querySelector('[data-role="secret-code"]');this.typeElement=this.container.querySelector('[data-role="type-selector"]')};n.prototype.getSecret=function(){return this.secretCodeElement.value};var s=function(t,e){var i={ui:{showButtonId:"otp-connect-mobile",id:"otp-mobile-popup"}};e=e||{};e=r(i,e);this.secret=null;this.qrCodeElement=null;this.appSecretElement=null;s.superclass.constructor.call(this,t,e)};e.extend(s,o);s.prototype.onShow=function(t){if(!t&&this.typeMenu.length){e.adminShowMenu(this.showButton,this.typeMenu,{active_class:"adm-btn-save-active"});return}this.sendRequest("get_vew_params",{type:this.type||""},function i(t){this.secret=t.data.secret;this.type=t.data.type;this.showHideRedundantCodes(t.data.isTwoCodeRequired);this.showTypeTitle(t.data.type);this.drawQrCode(this.qrCodeElement,t.data.provisionUri);this.appSecretElement.innerHTML=e.util.htmlspecialchars(t.data.appSecretSpaced);this.showPopup()}.bind(this))};s.prototype.onInitialize=function(){this.qrCodeElement=this.container.querySelector('[data-role="qr-code-block"]');this.appSecretElement=this.container.querySelector('[data-role="app-code-block"]');e.bind(e("connect-mobile-manual-input"),"click",function(){e("connect-by-manual-input").style.display="";e("connect-by-qr").style.display="none"});e.bind(e("connect-by-manual-input"),"click",function(){e("connect-by-manual-input").style.display="none";e("connect-by-qr").style.display=""})};s.prototype.getSecret=function(){return this.secret};s.prototype.drawQrCode=function(t,e){new QRCode(t,{text:e,width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})};s.prototype.deactivateOtp=function(t,e,i){if(t)t.preventDefault();this.sendRequest(e,{days:i},function o(){window.location.replace(this._options.successfulUrl)}.bind(this))};s.prototype.activateOtp=function(t){if(t)t.preventDefault();this.sendRequest("activate",null,function e(){window.location.replace(this._options.successfulUrl)}.bind(this))};var a=function(t,i){var o={actionUrl:"/bitrix/admin/security_otp.ajax.php?lang="+e.message("LANGUAGE_ID"),publicUrl:"/bitrix/admin/security_otp_recovery_codes.php?lang="+e.message("LANGUAGE_ID"),ui:{showButtonId:"otp-show-recovery-codes",id:"otp-recovery-codes"}};i=i||{};i=r(o,i);a.superclass.constructor.call(this,t,i)};e.extend(a,o);a.prototype.onShow=function(t){t=t||null;this.sendRequest(t?"regenerate_recovery_codes":"get_recovery_codes",t?null:{allow_regenerate:"Y"},function e(t){this.drawRecoveryCodes(t.codes);var e=document.body.querySelector('[data-role="otp-recovery-codes-warning"]');if(e)e.style.display="none";this.showPopup()}.bind(this))};a.prototype.onInitialize=function(){this.popup.ClearButtons();this.codesContainer=this.container.querySelector('[data-role="recoverycodes-container"]');this.codesContainer.style.display="";this.codesTemplate=this.container.querySelector('[data-role="recoverycode-template"]').cloneNode(true);e.bind(this.container.querySelector('[data-role="print-codes"]'),"click",function t(){window.open(this._options["publicUrl"]+"&user="+this.userId)}.bind(this));e.bind(this.container.querySelector('[data-role="save-codes"]'),"click",function i(){window.location.href=this._options["publicUrl"]+"&action=download"+"&user="+this.userId}.bind(this));e.bind(this.container.querySelector('[data-role="regenerate-codes"]'),"click",this.onShow.bind(this,true))};a.prototype.drawRecoveryCodes=function(t){[].forEach.call(this.codesContainer.querySelectorAll('[data-autoclear="yes"]'),function i(t){e.remove(t)},this);[].forEach.call(t,function o(t){var i=this.codesTemplate.cloneNode(true);if(!t.used){e.adjust(i,{text:t.value,attrs:{className:"active"}})}else{i.innerHTML="";e.adjust(i,{html:"",children:[e.create("span",{text:t.value}),e.create("span",{text:" ("+l(t.using_date)+")"})],attrs:{className:"used"}})}this.codesContainer.appendChild(i)},this)};function r(t,e){for(var i in e){if(!e.hasOwnProperty(i))continue;if(e[i]&&e[i].constructor===Object){if(t[i]&&t[i].constructor===Object){t[i]=r(t[i],e[i])}else{t[i]=c(e[i])}}else{t[i]=e[i]}}return t}function c(t){return JSON.parse(JSON.stringify(t))}function l(t){var i=null;if(!e.isAmPmMode())i=[["tommorow","tommorow, H:i"],["today","today, H:i"],["yesterday","yesterday, H:i"],["",e.date.convertBitrixFormat(e.message("FORMAT_DATETIME"))]];else i=[["tommorow","tommorow, g:i a"],["today","today, g:i a"],["yesterday","yesterday, g:i a"],["",e.date.convertBitrixFormat(e.message("FORMAT_DATETIME"))]];return e.date.format(i,parseInt(t),e.date.convertToUTC(new Date))}return i}(BX);
//# sourceMappingURL=user-edit.map.js