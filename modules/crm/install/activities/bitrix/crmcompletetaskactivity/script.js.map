{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {Reflection, Dom, Text, Type} from 'main.core';\n\nconst namespace = Reflection.namespace('BX.Crm.Automation.Activity');\n\ntype StageInfo = {id: string, name: string};\n\nexport class CompleteTaskActivity\n{\n\t#form: HTMLFormElement;\n\t#chosenStages: Set<string>;\n\t#stages: Object<string, Array<StageInfo>>;\n\t#categoryContainer: HTMLSelectElement;\n\t#stagesContainer: HTMLSelectElement;\n\t#isRobot: boolean;\n\n\tconstructor(options: {\n\t\tformName: string,\n\t\tstages: Object<string, Array<{id: string, name: string}>>,\n\t\tchosenStages: Array<string>,\n\t\tisRobot: boolean,\n\t})\n\t{\n\t\tthis.#form = document.forms.namedItem(options.formName);\n\n\t\tif (!Type.isArray(options.chosenStages))\n\t\t{\n\t\t\toptions.chosenStages = [];\n\t\t}\n\n\t\tthis.#categoryContainer = this.#form['target_category'];\n\t\tthis.#stagesContainer = this.#form['target_status[]'];\n\t\tthis.#chosenStages = new Set(options.chosenStages.map(stageId => String(stageId)));\n\t\tthis.#isRobot = options.isRobot;\n\n\t\tthis.#stages = {};\n\n\t\tif (Type.isPlainObject(options.stages))\n\t\t{\n\t\t\tfor (const [categoryId, stages] of Object.entries(options.stages))\n\t\t\t{\n\t\t\t\t// Due to http://jabber.bx/view.php?id=169508\n\t\t\t\t// we have to cast types explicitly\n\t\t\t\tthis.#stages[categoryId] = stages.map((stageInfo) => ({\n\t\t\t\t\tid: String(stageInfo.id),\n\t\t\t\t\tname: String(stageInfo.name),\n\t\t\t\t}));\n\t\t\t}\n\t\t}\n\t\telse if (Type.isArray(options.stages))\n\t\t{\n\t\t\t// Due to http://jabber.bx/view.php?id=169508\n\t\t\t// we have to cast types explicitly\n\t\t\toptions.stages.forEach((categoryStages, categoryId) => {\n\t\t\t\tthis.#stages[categoryId] = categoryStages.map((stageInfo) => ({\n\t\t\t\t\tid: String(stageInfo.id),\n\t\t\t\t\tname: String(stageInfo.name),\n\t\t\t\t}))\n\t\t\t})\n\t\t}\n\t}\n\n\tinit()\n\t{\n\t\tif (this.#categoryContainer.options.length <= 1)\n\t\t{\n\t\t\tif (this.#isRobot)\n\t\t\t{\n\t\t\t\tDom.remove(this.#categoryContainer.parentElement);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tDom.remove(this.#categoryContainer.parentElement.parentElement);\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.updateStages();\n\t\t}\n\t}\n\n\tupdateStages()\n\t{\n\t\tDom.clean(this.#stagesContainer);\n\t\tthis.renderStages();\n\t}\n\n\trender()\n\t{\n\t\tif (this.#categoryContainer)\n\t\t{\n\t\t\tthis.#categoryContainer.onchange = this.updateStages.bind(this);\n\t\t}\n\t}\n\n\trenderStages()\n\t{\n\t\tif (this.#stages.hasOwnProperty(this.#categoryContainer.value))\n\t\t{\n\t\t\tconst stages = this.#stages[this.#categoryContainer.value];\n\n\t\t\tstages.forEach(({id, name}) => {\n\t\t\t\tconst option = new Option(name, id, false, this.#chosenStages.has(id))\n\n\t\t\t\tthis.#stagesContainer.append(option);\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tfor (const categoryOption of this.#categoryContainer.options)\n\t\t\t{\n\t\t\t\tconst categoryId = categoryOption.value;\n\t\t\t\tconst categoryName = categoryOption.text;\n\n\t\t\t\tif (this.#stages.hasOwnProperty(categoryId))\n\t\t\t\t{\n\t\t\t\t\tthis.#stages[categoryId].forEach(({id, name}) => {\n\t\t\t\t\t\tconst stageName = Text.encode(`${categoryName} / ${name}`);\n\t\t\t\t\t\tconst option = new Option(stageName, id, false, this.#chosenStages.has(id));\n\n\t\t\t\t\t\tthis.#stagesContainer.append(option);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nnamespace.CompleteTaskActivity = CompleteTaskActivity;"],"names":["namespace","Reflection","CompleteTaskActivity","options","document","forms","namedItem","formName","Type","isArray","chosenStages","Set","map","stageId","String","isRobot","isPlainObject","stages","Object","entries","categoryId","stageInfo","id","name","forEach","categoryStages","length","Dom","remove","parentElement","updateStages","clean","renderStages","onchange","bind","hasOwnProperty","value","option","Option","has","append","categoryOption","categoryName","text","stageName","Text","encode"],"mappings":"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"}