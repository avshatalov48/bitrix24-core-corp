{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { Reflection, Type, Event, Dom, Tag, Text } from 'main.core';\n\nconst namespace = Reflection.namespace('BX.Crm.Activity');\n\ntype Property = {\n\tId: string,\n\tName: string,\n\tFieldName: string,\n\tType: string,\n\tRequired: ?boolean,\n\tDefault: any,\n\tOptions: ?Array,\n\tSettings: Object<string, any>,\n}\n\ntype EntityTypeId = number;\ntype FieldId = string;\ntype FieldsMap = Object<FieldId, Property>;\ntype RawHTML = string;\n\nclass CrmCreateDynamicActivity\n{\n\tisRobot: boolean;\n\tfieldsMapContainer: ?HTMLDivElement = undefined;\n\tentityTypeIdSelect: ?HTMLSelectElement = undefined;\n\tentitiesFieldsMap: Object<EntityTypeId, {\n\t\tdocumentType: [string, string, string],\n\t\tfieldsMap: FieldsMap,\n\t}>;\n\n\tcurrentValues: Object<FieldId, any> = {};\n\trenderedProperties: Object<FieldId, RawHTML> = {};\n\n\tentitiesFieldsContainers = new Map();\n\n\tconstructor(options: {\n\t\tisRobot: boolean,\n\t\tformName: string,\n\t\tentitiesFieldsMap: Object<EntityTypeId, FieldsMap>,\n\t\tcurrentValues: Object<FieldId, any>,\n\t})\n\t{\n\t\tthis.fieldsMapContainer = document.getElementById('fields-map-container');\n\n\t\tif (Type.isPlainObject(options))\n\t\t{\n\t\t\tthis.isRobot = options.isRobot;\n\n\t\t\tconst form = document.forms[options.formName];\n\t\t\tif (!Type.isNil(form))\n\t\t\t{\n\t\t\t\tthis.entityTypeIdSelect = form['dynamic_type_id'];\n\t\t\t}\n\n\t\t\tthis.entitiesFieldsMap = options.entitiesFieldsMap;\n\n\t\t\tif (Type.isPlainObject(options.currentValues))\n\t\t\t{\n\t\t\t\tthis.currentValues = options.currentValues;\n\t\t\t}\n\t\t}\n\t}\n\n\tget currentEntityTypeId(): number\n\t{\n\t\tif (!this.entityTypeIdSelect)\n\t\t{\n\t\t\treturn 0;\n\t\t}\n\n\t\treturn parseInt(this.entityTypeIdSelect.value, 10);\n\t}\n\n\tgetBindFieldId(): string\n\t{\n\t\treturn `${this.currentEntityTypeId}_BindToCurrentElement`;\n\t}\n\n\tinit(): boolean\n\t{\n\t\tif (this.entityTypeIdSelect)\n\t\t{\n\t\t\tthis.render();\n\t\t\tEvent.bind(this.entityTypeIdSelect, 'change', this.onEntityTypeIdChange.bind(this));\n\t\t}\n\t}\n\n\tonEntityTypeIdChange(): void\n\t{\n\t\tDom.clean(this.fieldsMapContainer);\n\t\tthis.currentValues = {};\n\t\tthis.render();\n\t}\n\n\trender(): void\n\t{\n\t\tif (Object.hasOwn(this.entitiesFieldsMap, this.currentEntityTypeId))\n\t\t{\n\t\t\tconst { fieldsMap } = this.entitiesFieldsMap[this.currentEntityTypeId];\n\t\t\tthis.loadRenderedFields();\n\n\t\t\tfor (const fieldId of Object.keys(fieldsMap))\n\t\t\t{\n\t\t\t\tDom.append(this.renderProperty(fieldId), this.fieldsMapContainer);\n\t\t\t}\n\t\t}\n\t}\n\n\tloadRenderedFields()\n\t{\n\t\tconst { documentType, fieldsMap } = this.entitiesFieldsMap[this.currentEntityTypeId];\n\n\t\tif (Type.isFunction(BX.Bizproc.FieldType.renderControlCollection))\n\t\t{\n\t\t\tthis.renderedProperties = BX.Bizproc.FieldType.renderControlCollection(\n\t\t\t\tdocumentType,\n\t\t\t\tObject.entries(fieldsMap).map(([fieldId, field]) => ({\n\t\t\t\t\tproperty: field,\n\t\t\t\t\tfieldName: field.FieldName,\n\t\t\t\t\tvalue: this.currentValues[fieldId],\n\t\t\t\t\tcontrolId: fieldId,\n\t\t\t\t})),\n\t\t\t\tthis.isRobot ? 'public' : 'designer',\n\t\t\t);\n\t\t}\n\t}\n\n\trenderProperty(fieldId: FieldId): HTMLElement\n\t{\n\t\tif (this.getBindFieldId() === fieldId)\n\t\t{\n\t\t\treturn (\n\t\t\t\tthis.isRobot\n\t\t\t\t\t? this.renderRobotBindField()\n\t\t\t\t\t: ''\n\t\t\t);\n\t\t}\n\n\t\treturn (\n\t\t\tthis.isRobot\n\t\t\t\t? this.renderRobotProperty(fieldId)\n\t\t\t\t: this.renderDesignerProperty(fieldId)\n\t\t);\n\t}\n\n\trenderRobotBindField(): HTMLElement\n\t{\n\t\tconst { fieldsMap } = this.entitiesFieldsMap[this.currentEntityTypeId];\n\n\t\tconst bindField = fieldsMap[this.getBindFieldId()];\n\t\tconst bindFieldValue = (\n\t\t\tObject.hasOwn(this.currentValues, this.getBindFieldId())\n\t\t\t&& (\n\t\t\t\tthis.currentValues[this.getBindFieldId()] === 'Y'\n\t\t\t\t|| this.currentValues[this.getBindFieldId()] === true\n\t\t\t)\n\t\t);\n\n\t\treturn Tag.render`\n\t\t\t<div class=\"bizproc-automation-popup-settings\">\n\t\t\t\t<div class=\"bizproc-automation-popup-checkbox-item\">\n\t\t\t\t\t<input type=\"hidden\" name=\"${Text.encode(bindField.FieldName)}\" value=\"N\">\n\t\t\t\t\t<label class=\"bizproc-automation-popup-chk-label\">\n\t\t\t\t\t\t<input\n\t\t\t\t\t\t\ttype=\"checkbox\"\n\t\t\t\t\t\t\tname=\"${Text.encode(bindField.FieldName)}\"\n\t\t\t\t\t\t\tvalue=\"Y\"\n\t\t\t\t\t\t\tclass=\"bizproc-automation-popup-chk\"\n\t\t\t\t\t\t\t${bindFieldValue ? 'checked' : ''}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t${Text.encode(bindField.Name)}\n\t\t\t\t\t</label>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\trenderRobotProperty(fieldId: FieldId): HTMLElement\n\t{\n\t\tconst { documentType, fieldsMap } = this.entitiesFieldsMap[this.currentEntityTypeId];\n\t\tconst property = fieldsMap[fieldId];\n\n\t\tconst fallback = () => BX.Bizproc.FieldType.renderControlPublic(\n\t\t\tdocumentType,\n\t\t\tproperty,\n\t\t\tproperty.FieldName,\n\t\t\tthis.currentValues[fieldId],\n\t\t);\n\n\t\treturn Tag.render`\n\t\t\t<div class=\"bizproc-automation-popup-settings\">\n\t\t\t\t<span class=\"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete\">\n\t\t\t\t\t${Text.encode(property.Name)}:\n\t\t\t\t</span>\n\t\t\t\t${Type.isDomNode(this.renderedProperties[fieldId]) ? this.renderedProperties[fieldId] : fallback()}\n\t\t\t</div>\n\t\t`;\n\t}\n\n\trenderDesignerProperty(fieldId: FieldId): HTMLElement\n\t{\n\t\tconst { documentType, fieldsMap } = this.entitiesFieldsMap[this.currentEntityTypeId];\n\t\tconst property = fieldsMap[fieldId];\n\n\t\tconst fallback = () => BX.Bizproc.FieldType.renderControlDesigner(\n\t\t\tdocumentType,\n\t\t\tproperty,\n\t\t\tproperty.FieldName,\n\t\t\tthis.currentValues[fieldId],\n\t\t);\n\n\t\treturn Tag.render`\n\t\t\t<tr>\n\t\t\t\t<td align=\"right\" width=\"40%\">${Text.encode(property.Name)}:</td>\n\t\t\t\t<td width=\"60%\">\n\t\t\t\t\t${Type.isDomNode(this.renderedProperties[fieldId]) ? this.renderedProperties[fieldId] : fallback()}\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t`;\n\t}\n}\n\nnamespace.CrmCreateDynamicActivity = CrmCreateDynamicActivity;"],"names":["namespace","Reflection","CrmCreateDynamicActivity","options","undefined","Map","fieldsMapContainer","document","getElementById","Type","isPlainObject","isRobot","form","forms","formName","isNil","entityTypeIdSelect","entitiesFieldsMap","currentValues","currentEntityTypeId","render","Event","bind","onEntityTypeIdChange","Dom","clean","Object","hasOwn","fieldsMap","loadRenderedFields","keys","fieldId","append","renderProperty","documentType","isFunction","BX","Bizproc","FieldType","renderControlCollection","renderedProperties","entries","map","field","property","fieldName","FieldName","value","controlId","getBindFieldId","renderRobotBindField","renderRobotProperty","renderDesignerProperty","bindField","bindFieldValue","Tag","Text","encode","Name","fallback","renderControlPublic","isDomNode","renderControlDesigner","parseInt"],"mappings":"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"}