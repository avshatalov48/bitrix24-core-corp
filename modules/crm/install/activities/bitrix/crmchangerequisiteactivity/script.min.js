(function(){"use strict";BX.namespace("BX.Crm.Activity");if(typeof BX.Crm.Activity.CrmChangeRequisiteActivity!=="undefined"){return}BX.Crm.Activity.CrmChangeRequisiteActivity={};BX.Crm.Activity.CrmChangeRequisiteActivity.init=function(e){this.requisiteFieldsNode=BX(e.requisiteFieldsNodeId);this.bankDetailFieldsMap=e.bankDetailFieldsMap;this.addressFieldsMap=e.addressFieldsMap!==null?e.addressFieldsMap:{};this.fieldsMap=Object.assign(e.requisiteFieldsMap,this.bankDetailFieldsMap,this.addressFieldsMap);this.formName=e.formName;this.currentValues=e.currentValues!==null?e.currentValues:{};this.messages=e.messages;this.documentType=e.documentType;this.isRobot=e.isRobot;this.conditionFieldsCounter=0;this.selectPresetNode=BX(e.selectPresetNodeId);this.preparePresetFieldNames(e);var i=this.isRobot?"addRBPCondition":"addBPCondition";if(this.getObjectKeys(this.currentValues).length<=0){this[i]()}for(var t in this.currentValues){this[i](t)}if(e.isRobot){this.initRBPEvents()}else{this.initBPEvents(e);this.onSelectPresetNodeChange()}};BX.Crm.Activity.CrmChangeRequisiteActivity.preparePresetFieldNames=function(e){this.presetFieldNames=e.presetFieldNames;this.presetFieldNames["0"]=this.getObjectKeys(this.fieldsMap);this.presetFieldNames.has=function(e){return this.hasOwnProperty(e)};for(var i in this.presetFieldNames){if(this.presetFieldNames.hasOwnProperty(i)){this.presetFieldNames[i].has=function(e){return this.indexOf(e)!==-1}}}};BX.Crm.Activity.CrmChangeRequisiteActivity.initRBPEvents=function(e){this.fieldsListSelectNode=document.querySelector('[data-role="bca-ccra-fields-list"]');BX.bind(this.fieldsListSelectNode,"click",BX.proxy(this.onFieldsListSelectClick,this))};BX.Crm.Activity.CrmChangeRequisiteActivity.onFieldsListSelectClick=function(e){var i="bca-ccra-menu-"+this.conditionFieldsCounter;this.conditionFieldsCounter++;BX.PopupMenu.show(i,this.fieldsListSelectNode,this.getFieldsItems(),{autoHide:true,offsetLeft:BX.pos(this.fieldsListSelectNode)["width"]/2,angle:{position:"top",offset:0},zIndex:200,className:"bizproc-automation-inline-selector-menu",events:{onPopupClose:function(){this.destroy()}}});return e.preventDefault()};BX.Crm.Activity.CrmChangeRequisiteActivity.getFieldsItems=function(){var e=this.getPresetFieldIds();var i=[];for(var t in this.fieldsMap){if(this.fieldsMap.hasOwnProperty(t)&&(e.has(t)||this.addressFieldsMap.hasOwnProperty(t)||this.bankDetailFieldsMap.hasOwnProperty(t))){i.push({text:this.fieldsMap[t]["Name"],fieldId:t,onclick:function(e,i){this.popupWindow.close();BX.Crm.Activity.CrmChangeRequisiteActivity.addRBPCondition(i.fieldId)}})}}return i};BX.Crm.Activity.CrmChangeRequisiteActivity.addRBPCondition=function(e){this.conditionFieldsCounter++;var i="id_bca_ccra_row_id_"+this.conditionFieldsCounter;if(e===undefined){e=this.getObjectKeys(this.fieldsMap)[0]}var t=BX.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:this.fieldsMap[e]["Name"]});var s=BX.create("a",{attrs:{className:"bizproc-automation-popup-settings-delete bizproc-automation-popup-settings-link bizproc-automation-popup-settings-link-light"},props:{href:"#"},text:this.messages["CRM_CRA_DELETE_CONDITION"]});BX.bind(s,"click",function(e){this.deleteCondition(i);return e.preventDefault()}.bind(this));this.requisiteFieldsNode.appendChild(BX.create("div",{attrs:{className:"bizproc-automation-popup-settings"},props:{id:i},children:[t,this.renderField(e),s]}))};BX.Crm.Activity.CrmChangeRequisiteActivity.initBPEvents=function(e){BX.bind(BX(e.selectPresetNodeId),"change",this.onSelectPresetNodeChange.bind(this));BX.bind(BX(e.addConditionLinkId),"click",this.onAddConditionLinkClick.bind(this))};BX.Crm.Activity.CrmChangeRequisiteActivity.onSelectPresetNodeChange=function(){for(var e=0;e<this.requisiteFieldsNode.rows.length;e++){var i=this.requisiteFieldsNode.rows[e];this.hideFieldNamesOfUnselectedPresets(i.id)}};BX.Crm.Activity.CrmChangeRequisiteActivity.onAddConditionLinkClick=function(e){this.addBPCondition();return e.preventDefault()};BX.Crm.Activity.CrmChangeRequisiteActivity.addBPCondition=function(e){this.conditionFieldsCounter++;var i=this.requisiteFieldsNode.insertRow(-1);i.id="id_bca_ccra_row_id_"+this.conditionFieldsCounter;if(e===undefined){e=this.getObjectKeys(this.fieldsMap)[0]}i.insertCell(-1).appendChild(this.getFieldSelectNode(i,e));i.insertCell(-1).appendChild(this.getEqualSignNode());i.insertCell(-1).appendChild(this.renderField(e));i.insertCell(-1).appendChild(this.getDeleteButtonNode(i));this.hideFieldNamesOfUnselectedPresets(i.id)};BX.Crm.Activity.CrmChangeRequisiteActivity.hideFieldNamesOfUnselectedPresets=function(e){var i=this.getPresetFieldIds();var t=BX(e).firstChild.firstChild;var s=BX(e).children[2];for(var n=0;n<t.length;n++){var r=t[n];if(i.has(r.value)||this.bankDetailFieldsMap.hasOwnProperty(r.value)||this.addressFieldsMap.hasOwnProperty(r.value)){r.removeAttribute("hidden","hidden")}else{r.setAttribute("hidden","hidden")}}if(i.has(t.value)===false&&this.bankDetailFieldsMap.hasOwnProperty(t.value)===false&&this.addressFieldsMap.hasOwnProperty(r.value)===false){for(n=0;n<t.length;n++){r=t[n];if(r.hasAttribute("hidden")===false){t.value=r.value;BX(e).replaceChild(this.renderField(t.value),s);break}}}};BX.Crm.Activity.CrmChangeRequisiteActivity.getObjectKeys=function(e){var i=[];for(var t in e){if(e.hasOwnProperty(t)){i.push(t)}}return i};BX.Crm.Activity.CrmChangeRequisiteActivity.getFieldSelectNode=function(e,i){var t=BX.create("select",{children:this.getOptionsFromFieldsMap(i)});t.onchange=BX.proxy(function(){var i=e.children[2];e.replaceChild(this.renderField(t.value),i)},this);return t};BX.Crm.Activity.CrmChangeRequisiteActivity.getPresetFieldIds=function(){var e=this.selectPresetNode.value;if(this.presetFieldNames.has(e)===false){e="0"}return this.presetFieldNames[e]};BX.Crm.Activity.CrmChangeRequisiteActivity.getOptionsFromFieldsMap=function(e){var i=[];var t=this.getObjectKeys(this.fieldsMap);for(var s=0;s<t.length;s++){var n=t[s];var r=e===n?{selected:"selected"}:undefined;i.push(BX.create("option",{props:{value:n},attrs:r,text:this.fieldsMap[n]["Name"]}))}return i};BX.Crm.Activity.CrmChangeRequisiteActivity.getEqualSignNode=function(){return BX.create("span",{text:"="})};BX.Crm.Activity.CrmChangeRequisiteActivity.getFieldNameByRowId=function(e){var i=document.getElementById(e);var t=i.cells[0].firstChild;return t.selectedOptions[0].value};BX.Crm.Activity.CrmChangeRequisiteActivity.renderField=function(e){return BX.Bizproc.FieldType.renderControl(this.documentType,this.fieldsMap[e],e,this.currentValues[e],this.isRobot?"public":"designer")};BX.Crm.Activity.CrmChangeRequisiteActivity.getDeleteButtonNode=function(e){var i=BX.create("a",{props:{href:"#"},text:this.messages["CRM_CRA_DELETE_CONDITION"]});BX.bind(i,"click",function(i){this.deleteCondition(e.id);i.preventDefault()}.bind(this));return i};BX.Crm.Activity.CrmChangeRequisiteActivity.deleteCondition=function(e){var i=document.getElementById(e);i.parentNode.removeChild(i)}})();
//# sourceMappingURL=script.map.js