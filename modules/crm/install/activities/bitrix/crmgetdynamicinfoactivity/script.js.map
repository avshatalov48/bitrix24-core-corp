{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {Reflection, Type, Event, Dom} from 'main.core';\n\nconst namespace = Reflection.namespace('BX.Crm.Activity');\n\nclass CrmGetDynamicInfoActivity\n{\n\tdocumentType: Array<string>;\n\tisRobot: boolean;\n\tentityTypeIdSelect: HTMLSelectElement;\n\n\treturnFieldsProperty: object;\n\treturnFieldsMapContainer: HTMLDivElement;\n\treturnFieldsMap: Map<number, Map<string, object>>;\n\treturnFieldsIds: Array<string>;\n\n\tfilterFieldsContainer: HTMLDivElement | null;\n\tfilteringFieldsPrefix: string;\n\tfilterFieldsMap: Map<number, object>;\n\tconditionGroup: BX.Bizproc.Automation.ConditionGroup | undefined;\n\n\tcurrentEntityTypeId: number;\n\n\tconstructor(options)\n\t{\n\t\tif (Type.isPlainObject(options))\n\t\t{\n\t\t\tthis.documentType = options.documentType;\n\t\t\tthis.isRobot = options.isRobot;\n\t\t\tconst form = document.forms[options.formName];\n\n\t\t\tif (!Type.isNil(form))\n\t\t\t{\n\t\t\t\tthis.entityTypeIdSelect = form.dynamic_type_id;\n\t\t\t\tthis.currentEntityTypeId = Number(this.entityTypeIdSelect.value);\n\t\t\t\tthis.entityTypeDependentElements = document.querySelectorAll(\n\t\t\t\t\t'[data-role=\"bca-cuda-entity-type-id-dependent\"]',\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tthis.initFilterFields(options);\n\t\t\tthis.initReturnFields(options);\n\n\t\t\tthis.render();\n\t\t}\n\t}\n\n\tinitFilterFields(options)\n\t{\n\t\tthis.conditinIdPrefix = 'id_bca_cuda_field_';\n\t\tthis.filterFieldsContainer = document.querySelector('[data-role=\"bca-cuda-filter-fields-container\"]');\n\t\tthis.filteringFieldsPrefix = options.filteringFieldsPrefix;\n\t\tthis.filterFieldsMap = new Map(\n\t\t\tObject.entries(options.filterFieldsMap)\n\t\t\t\t.map(([entityTypeId, fieldsMap]) => [Number(entityTypeId), fieldsMap]),\n\t\t);\n\t\tif (!Type.isNil(options.documentName))\n\t\t{\n\t\t\tBX.Bizproc.Automation.API.documentName = options.documentName;\n\t\t}\n\t\tif (BX.Bizproc.Automation && BX.Bizproc.Automation.ConditionGroup)\n\t\t{\n\t\t\tthis.conditionGroup = new BX.Bizproc.Automation.ConditionGroup(options.conditions);\n\t\t}\n\t}\n\n\tinitReturnFields(options)\n\t{\n\t\tthis.returnFieldsProperty = options.returnFieldsProperty;\n\t\tthis.returnFieldsIds = Type.isArray(options.returnFieldsIds) ? options.returnFieldsIds : [];\n\n\t\tthis.returnFieldsMapContainer = document.querySelector('[data-role=\"bca-cuda-return-fields-container\"]');\n\t\tthis.returnFieldsMap = new Map();\n\t\tObject.entries(options.returnFieldsMap).forEach(([entityTypeId, fieldsMap]) => {\n\t\t\tthis.returnFieldsMap.set(Number(entityTypeId), new Map(Object.entries(fieldsMap)));\n\t\t});\n\t}\n\n\tinit(): void\n\t{\n\t\tif (this.entityTypeIdSelect)\n\t\t{\n\t\t\tEvent.bind(this.entityTypeIdSelect, 'change', this.onEntityTypeIdChange.bind(this));\n\t\t}\n\t}\n\n\tonEntityTypeIdChange(): void\n\t{\n\t\tthis.currentEntityTypeId = Number(this.entityTypeIdSelect.value);\n\n\t\tif (BX.Bizproc.Automation && BX.Bizproc.Automation.ConditionGroup)\n\t\t{\n\t\t\tthis.conditionGroup = new BX.Bizproc.Automation.ConditionGroup();\n\t\t}\n\n\t\tthis.returnFieldsIds = [];\n\n\t\tthis.render();\n\t}\n\n\trender(): void\n\t{\n\t\tif (Type.isNil(this.currentEntityTypeId) || this.currentEntityTypeId === 0)\n\t\t{\n\t\t\tthis.entityTypeDependentElements.forEach((element) => Dom.hide(element));\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.entityTypeDependentElements.forEach((element) => Dom.show(element));\n\t\t\tthis.renderFilterFields();\n\t\t\tthis.renderReturnFields();\n\t\t}\n\t}\n\n\trenderFilterFields(): void\n\t{\n\t\tif (\n\t\t\t!Type.isNil(this.conditionGroup)\n\t\t\t&& this.currentEntityTypeId !== 0\n\t\t)\n\t\t{\n\t\t\tconst selector = new BX.Bizproc.Automation.ConditionGroupSelector(this.conditionGroup, {\n\t\t\t\tfields: Object.values(this.filterFieldsMap.get(this.currentEntityTypeId)),\n\t\t\t\tfieldPrefix: this.filteringFieldsPrefix,\n\t\t\t});\n\n\t\t\tDom.clean(this.filterFieldsContainer);\n\t\t\tthis.filterFieldsContainer.appendChild(selector.createNode());\n\t\t}\n\t}\n\n\trenderReturnFields(): void\n\t{\n\t\tconst entityTypeId = this.currentEntityTypeId;\n\t\tconst fieldsMap = this.returnFieldsMap.get(entityTypeId);\n\n\t\tif (!Type.isNil(fieldsMap))\n\t\t{\n\t\t\tconst fieldOptions = {};\n\t\t\tfieldsMap.forEach((field, fieldId) => {\n\t\t\t\tfieldOptions[fieldId] = field.Name;\n\t\t\t});\n\t\t\tthis.returnFieldsProperty.Options = fieldOptions;\n\n\t\t\tDom.clean(this.returnFieldsMapContainer);\n\t\t\tthis.returnFieldsMapContainer.appendChild(\n\t\t\t\tBX.Bizproc.FieldType.renderControl(\n\t\t\t\t\tthis.documentType,\n\t\t\t\t\tthis.returnFieldsProperty,\n\t\t\t\t\tthis.returnFieldsProperty.FieldName,\n\t\t\t\t\tthis.returnFieldsIds,\n\t\t\t\t\tthis.isRobot ? 'public' : 'designer',\n\t\t\t\t),\n\t\t\t);\n\t\t}\n\t}\n}\n\nnamespace.CrmGetDynamicInfoActivity = CrmGetDynamicInfoActivity;"],"names":["namespace","Reflection","CrmGetDynamicInfoActivity","options","Type","isPlainObject","documentType","isRobot","form","document","forms","formName","isNil","entityTypeIdSelect","dynamic_type_id","currentEntityTypeId","Number","value","entityTypeDependentElements","querySelectorAll","initFilterFields","initReturnFields","render","conditinIdPrefix","filterFieldsContainer","querySelector","filteringFieldsPrefix","filterFieldsMap","Map","Object","entries","map","entityTypeId","fieldsMap","documentName","BX","Bizproc","Automation","API","ConditionGroup","conditionGroup","conditions","returnFieldsProperty","returnFieldsIds","isArray","returnFieldsMapContainer","returnFieldsMap","forEach","set","Event","bind","onEntityTypeIdChange","element","Dom","hide","show","renderFilterFields","renderReturnFields","selector","ConditionGroupSelector","fields","values","get","fieldPrefix","clean","appendChild","createNode","fieldOptions","field","fieldId","Name","Options","FieldType","renderControl","FieldName"],"mappings":"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"}