{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {Reflection, Type, Event, Dom} from 'main.core';\nimport {\n\tAutomationContext,\n\tConditionGroup,\n\tConditionGroupSelector,\n\tDocument,\n\tgetGlobalContext,\n\tsetGlobalContext,\n} from 'bizproc.automation';\n\nconst namespace = Reflection.namespace('BX.Crm.Activity');\n\nclass CrmGetDynamicInfoActivity\n{\n\tdocumentType: Array<string>;\n\tdocument: Document;\n\tisRobot: boolean;\n\tentityTypeIdSelect: HTMLSelectElement;\n\n\treturnFieldsProperty: object;\n\treturnFieldsMapContainer: HTMLDivElement;\n\treturnFieldsMap: Map<number, Map<string, object>>;\n\treturnFieldsIds: Array<string>;\n\n\tfilterFieldsContainer: HTMLDivElement | null;\n\tfilteringFieldsPrefix: string;\n\tfilterFieldsMap: Map<number, object>;\n\tconditionGroup: ConditionGroup | undefined;\n\n\tcurrentEntityTypeId: number;\n\n\tconstructor(options)\n\t{\n\t\tif (Type.isPlainObject(options))\n\t\t{\n\t\t\tthis.documentType = options.documentType;\n\t\t\tthis.isRobot = options.isRobot;\n\t\t\tconst form = document.forms[options.formName];\n\n\t\t\tthis.document = new Document({\n\t\t\t\trawDocumentType: this.documentType,\n\t\t\t\tdocumentFields: options.returnFieldsMap,\n\t\t\t\ttitle: options.documentName,\n\t\t\t});\n\n\t\t\tif (!Type.isNil(form))\n\t\t\t{\n\t\t\t\tthis.entityTypeIdSelect = form.dynamic_type_id;\n\t\t\t\tthis.currentEntityTypeId = Number(this.entityTypeIdSelect.value);\n\t\t\t\tthis.entityTypeDependentElements = document.querySelectorAll(\n\t\t\t\t\t'[data-role=\"bca-cuda-entity-type-id-dependent\"]',\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tthis.initFilterFields(options);\n\t\t\tthis.initReturnFields(options);\n\n\t\t\tthis.render();\n\t\t}\n\t}\n\n\tinitFilterFields(options)\n\t{\n\t\tthis.conditinIdPrefix = 'id_bca_cuda_field_';\n\t\tthis.filterFieldsContainer = document.querySelector('[data-role=\"bca-cuda-filter-fields-container\"]');\n\t\tthis.filteringFieldsPrefix = options.filteringFieldsPrefix;\n\t\tthis.filterFieldsMap = new Map(\n\t\t\tObject.entries(options.filterFieldsMap)\n\t\t\t\t.map(([entityTypeId, fieldsMap]) => [Number(entityTypeId), fieldsMap]),\n\t\t);\n\n\t\tthis.conditionGroup = new ConditionGroup(options.conditions);\n\t}\n\n\tinitReturnFields(options)\n\t{\n\t\tthis.returnFieldsProperty = options.returnFieldsProperty;\n\t\tthis.returnFieldsIds = Type.isArray(options.returnFieldsIds) ? options.returnFieldsIds : [];\n\n\t\tthis.returnFieldsMapContainer = document.querySelector('[data-role=\"bca-cuda-return-fields-container\"]');\n\t\tthis.returnFieldsMap = new Map();\n\t\tObject.entries(options.returnFieldsMap).forEach(([entityTypeId, fieldsMap]) => {\n\t\t\tthis.returnFieldsMap.set(Number(entityTypeId), new Map(Object.entries(fieldsMap)));\n\t\t});\n\t}\n\n\tinitAutomationContext()\n\t{\n\t\ttry\n\t\t{\n\t\t\tgetGlobalContext();\n\t\t}\n\t\tcatch(error)\n\t\t{\n\t\t\tsetGlobalContext(new AutomationContext({document: this.document}));\n\t\t}\n\t}\n\n\tinit(): void\n\t{\n\t\tif (this.entityTypeIdSelect)\n\t\t{\n\t\t\tEvent.bind(this.entityTypeIdSelect, 'change', this.onEntityTypeIdChange.bind(this));\n\t\t}\n\t}\n\n\tonEntityTypeIdChange(): void\n\t{\n\t\tthis.currentEntityTypeId = Number(this.entityTypeIdSelect.value);\n\n\t\tthis.conditionGroup = new ConditionGroup();\n\n\t\tthis.returnFieldsIds = [];\n\n\t\tthis.render();\n\t}\n\n\trender(): void\n\t{\n\t\tif (Type.isNil(this.currentEntityTypeId) || this.currentEntityTypeId === 0)\n\t\t{\n\t\t\tthis.entityTypeDependentElements.forEach((element) => Dom.hide(element));\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.entityTypeDependentElements.forEach((element) => Dom.show(element));\n\t\t\tthis.renderFilterFields();\n\t\t\tthis.renderReturnFields();\n\t\t}\n\t}\n\n\trenderFilterFields(): void\n\t{\n\t\tif (\n\t\t\t!Type.isNil(this.conditionGroup)\n\t\t\t&& this.currentEntityTypeId !== 0\n\t\t)\n\t\t{\n\t\t\tconst selector = new ConditionGroupSelector(this.conditionGroup, {\n\t\t\t\tfields: Object.values(this.filterFieldsMap.get(this.currentEntityTypeId)),\n\t\t\t\tfieldPrefix: this.filteringFieldsPrefix,\n\t\t\t});\n\n\t\t\tDom.clean(this.filterFieldsContainer);\n\t\t\tthis.filterFieldsContainer.appendChild(selector.createNode());\n\t\t}\n\t}\n\n\trenderReturnFields(): void\n\t{\n\t\tconst entityTypeId = this.currentEntityTypeId;\n\t\tconst fieldsMap = this.returnFieldsMap.get(entityTypeId);\n\n\t\tif (!Type.isNil(fieldsMap))\n\t\t{\n\t\t\tconst fieldOptions = {};\n\t\t\tfieldsMap.forEach((field, fieldId) => {\n\t\t\t\tfieldOptions[fieldId] = field.Name;\n\t\t\t});\n\t\t\tthis.returnFieldsProperty.Options = fieldOptions;\n\n\t\t\tDom.clean(this.returnFieldsMapContainer);\n\t\t\tthis.returnFieldsMapContainer.appendChild(\n\t\t\t\tBX.Bizproc.FieldType.renderControl(\n\t\t\t\t\tthis.documentType,\n\t\t\t\t\tthis.returnFieldsProperty,\n\t\t\t\t\tthis.returnFieldsProperty.FieldName,\n\t\t\t\t\tthis.returnFieldsIds,\n\t\t\t\t\tthis.isRobot ? 'public' : 'designer',\n\t\t\t\t),\n\t\t\t);\n\t\t}\n\t}\n}\n\nnamespace.CrmGetDynamicInfoActivity = CrmGetDynamicInfoActivity;"],"names":["namespace","Reflection","CrmGetDynamicInfoActivity","options","Type","isPlainObject","documentType","isRobot","form","document","forms","formName","Document","rawDocumentType","documentFields","returnFieldsMap","title","documentName","isNil","entityTypeIdSelect","dynamic_type_id","currentEntityTypeId","Number","value","entityTypeDependentElements","querySelectorAll","initFilterFields","initReturnFields","render","conditinIdPrefix","filterFieldsContainer","querySelector","filteringFieldsPrefix","filterFieldsMap","Map","Object","entries","map","entityTypeId","fieldsMap","conditionGroup","ConditionGroup","conditions","returnFieldsProperty","returnFieldsIds","isArray","returnFieldsMapContainer","forEach","set","getGlobalContext","error","setGlobalContext","AutomationContext","Event","bind","onEntityTypeIdChange","element","Dom","hide","show","renderFilterFields","renderReturnFields","selector","ConditionGroupSelector","fields","values","get","fieldPrefix","clean","appendChild","createNode","fieldOptions","field","fieldId","Name","Options","BX","Bizproc","FieldType","renderControl","FieldName"],"mappings":"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"}