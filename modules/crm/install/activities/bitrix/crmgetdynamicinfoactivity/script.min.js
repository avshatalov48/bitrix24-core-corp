(function(e,t,i){"use strict";var n=t.Reflection.namespace("BX.Crm.Activity");var r=function(){function e(n){babelHelpers.classCallCheck(this,e);if(t.Type.isPlainObject(n)){this.documentType=n.documentType;this.isRobot=n.isRobot;var r=document.forms[n.formName];if(!t.Type.isNil(r)){this.entityTypeIdSelect=r.dynamic_type_id;this.currentEntityTypeId=Number(this.entityTypeIdSelect.value);this.entityTypeDependentElements=document.querySelectorAll('[data-role="bca-cuda-entity-type-id-dependent"]')}this.document=new i.Document({rawDocumentType:this.documentType,documentFields:n.documentFields,title:n.documentName});this.initAutomationContext();this.initFilterFields(n);this.initReturnFields(n);this.render()}}babelHelpers.createClass(e,[{key:"initFilterFields",value:function e(n){this.conditinIdPrefix="id_bca_cuda_field_";this.filterFieldsContainer=document.querySelector('[data-role="bca-cuda-filter-fields-container"]');this.filteringFieldsPrefix=n.filteringFieldsPrefix;this.filterFieldsMap=new Map(Object.entries(n.filterFieldsMap).map((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],n=t[1];return[Number(i),n]})));if(!t.Type.isNil(n.documentType)&&!this.isRobot){BX.Bizproc.Automation.API.documentType=n.documentType}this.conditionGroup=new i.ConditionGroup(n.conditions)}},{key:"initReturnFields",value:function e(i){var n=this;this.returnFieldsProperty=i.returnFieldsProperty;this.returnFieldsIds=t.Type.isArray(i.returnFieldsIds)?i.returnFieldsIds:[];this.returnFieldsMapContainer=document.querySelector('[data-role="bca-cuda-return-fields-container"]');this.returnFieldsMap=new Map;Object.entries(i.returnFieldsMap).forEach((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],r=t[1];n.returnFieldsMap.set(Number(i),new Map(Object.entries(r)))}))}},{key:"initAutomationContext",value:function e(){var t=this;try{i.getGlobalContext();if(this.isRobot){this.onOpenFilterFieldsMenu=function(e){var t=i.Designer.getInstance().getRobotSettingsDialog();var n=t.template;var r=t.robot;if(n&&r){n.onOpenMenu(e,r)}}}}catch(e){i.setGlobalContext(new i.Context({document:this.document}));this.onOpenFilterFieldsMenu=function(e){return t.addBPFields(e.getData().selector)}}}},{key:"addBPFields",value:function e(i){var n=function e(i){var n=i.properties,r=i.objectName,s=i.expressionPrefix;if(t.Type.isObject(n)){return Object.entries(n).map((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],n=t[1];return{id:i,title:n.Name,customData:{field:{Id:i,Type:n.Type,Name:n.Name,ObjectName:r,SystemExpression:"{=".concat(r,":").concat(i,"}"),Expression:s?"{{".concat(s,":").concat(i,"}}"):"{=".concat(r,":").concat(i,"}")}}}}))}return[]};var r=function e(i){var n=i.properties,r=i.visibilityNames,s=i.objectName;if(t.Type.isObject(n)){return Object.entries(n).map((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],n=t[1];var o={id:i,Type:n.Type,title:n.Name,ObjectName:s,SystemExpression:"{=".concat(s,":").concat(i,"}"),Expression:"{=".concat(s,":").concat(i,"}")};if(n.Visibility&&r[n.Visibility]){o.Expression="{{".concat(r[n.Visibility],": ").concat(n.Name,"}}")}return{id:i,title:n.Name,supertitle:r[n.Visibility],customData:{field:o}}}))}return[]};i.addGroup("workflowParameters",{id:"workflowParameters",title:t.Loc.getMessage("BIZPROC_WFEDIT_MENU_PARAMS"),children:[{id:"parameters",title:t.Loc.getMessage("BIZPROC_AUTOMATION_CMP_PARAMETERS_LIST"),children:n({properties:window.arWorkflowParameters||{},objectName:"Template",expressionPrefix:"~*"})},{id:"variables",title:t.Loc.getMessage("BIZPROC_AUTOMATION_CMP_GLOB_VARIABLES_LIST_1"),children:n({properties:window.arWorkflowVariables||{},objectName:"Variable"})},{id:"constants",title:t.Loc.getMessage("BIZPROC_AUTOMATION_CMP_CONSTANTS_LIST"),children:n({properties:window.arWorkflowConstants||{},objectName:"Constant",expressionPrefix:"~&"})}]});if(window.arWorkflowGlobalVariables&&window.wfGVarVisibilityNames){i.addGroup("globalVariables",{id:"globalVariables",title:t.Loc.getMessage("BIZPROC_AUTOMATION_CMP_GLOB_VARIABLES_LIST"),children:r({properties:window.arWorkflowGlobalVariables||{},visibilityNames:window.wfGVarVisibilityNames||{},objectName:"GlobalVar"})})}i.addGroup("globalConstants",{id:"globalConstants",title:t.Loc.getMessage("BIZPROC_AUTOMATION_CMP_GLOB_CONSTANTS_LIST"),children:r({properties:window.arWorkflowGlobalConstants||{},visibilityNames:window.wfGConstVisibilityNames||{},objectName:"GlobalConst"})})}},{key:"init",value:function e(){if(this.entityTypeIdSelect){t.Event.bind(this.entityTypeIdSelect,"change",this.onEntityTypeIdChange.bind(this))}}},{key:"onEntityTypeIdChange",value:function e(){this.currentEntityTypeId=Number(this.entityTypeIdSelect.value);this.conditionGroup=new i.ConditionGroup;this.returnFieldsIds=[];this.render()}},{key:"render",value:function e(){if(t.Type.isNil(this.currentEntityTypeId)||this.currentEntityTypeId===0){this.entityTypeDependentElements.forEach((function(e){return t.Dom.hide(e)}))}else{this.entityTypeDependentElements.forEach((function(e){return t.Dom.show(e)}));this.renderFilterFields();this.renderReturnFields()}}},{key:"renderFilterFields",value:function e(){if(!t.Type.isNil(this.conditionGroup)&&this.currentEntityTypeId!==0){var n=new i.ConditionGroupSelector(this.conditionGroup,{fields:Object.values(this.filterFieldsMap.get(this.currentEntityTypeId)),fieldPrefix:this.filteringFieldsPrefix,onOpenMenu:this.onOpenFilterFieldsMenu,caption:{head:t.Loc.getMessage("CRM_GDIA_FILTERING_FIELDS_PROPERTY"),collapsed:t.Loc.getMessage("CRM_GDIA_FILTERING_FIELDS_COLLAPSED_TEXT")}});if(n.modern&&this.filterFieldsContainer&&this.filterFieldsContainer.parentNode){var r=this.filterFieldsContainer.parentNode.firstElementChild===this.filterFieldsContainer?this.filterFieldsContainer.parentNode.parentNode.firstElementChild:this.filterFieldsContainer.parentNode.firstElementChild;t.Dom.clean(r)}t.Dom.clean(this.filterFieldsContainer);t.Dom.append(n.createNode(),this.filterFieldsContainer)}}},{key:"renderReturnFields",value:function e(){var i=this.currentEntityTypeId;var n=this.returnFieldsMap.get(i);if(!t.Type.isNil(n)){var r={};n.forEach((function(e,t){r[t]=e.Name}));this.returnFieldsProperty.Options=r;t.Dom.clean(this.returnFieldsMapContainer);this.returnFieldsMapContainer.appendChild(BX.Bizproc.FieldType.renderControl(this.documentType,this.returnFieldsProperty,this.returnFieldsProperty.FieldName,this.returnFieldsIds,this.isRobot?"public":"designer"))}}}]);return e}();n.CrmGetDynamicInfoActivity=r})(this.window=this.window||{},BX,BX.Bizproc.Automation);
//# sourceMappingURL=script.map.js