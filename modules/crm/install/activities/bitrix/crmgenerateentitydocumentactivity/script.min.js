(function(){"use strict";BX.namespace("BX.Crm.Activity");if(typeof BX.Crm.Activity.CrmGenerateEntityDocumentActivity!=="undefined"){return}BX.Crm.Activity.CrmGenerateEntityDocumentActivity={};BX.Crm.Activity.CrmGenerateEntityDocumentActivity.init=function(e){this.documentType=e.documentType;this.entityType=e.entityType;this.entityTypeId=e.entityTypeId;this.selectTemplateNodeId=e.selectTemplateNodeId;this.selectFieldNodeId=e.selectFieldNodeId;this.textFieldNodeId=e.textFieldNodeId;this.deleteRowClassName=e.deleteRowClassName;this.openFieldInfoUrlClassName=e.openFieldInfoUrlClassName;this.addNewFieldButtonNodeId=e.addNewFieldButtonNodeId;this.fieldTableRowClassName=e.fieldTableRowClassName;this.fieldTableRowTagName=e.fieldTableRowTagName||"tr";this.isRobot=e.isRobot===true;this.initEvents()};BX.Crm.Activity.CrmGenerateEntityDocumentActivity.initEvents=function(){BX.bind(BX(this.selectTemplateNodeId),"change",BX.proxy(this.getTemplateFields,this));BX.bind(BX(this.selectFieldNodeId),"change",BX.proxy(function(){if(BX(this.selectFieldNodeId).value.length>0){BX(this.textFieldNodeId).value=BX(this.selectFieldNodeId).value}},this));BX.bindDelegate(document,"click",{className:this.deleteRowClassName},function(e){e.preventDefault();BX.remove(e.target.parentNode.parentNode)});BX.bindDelegate(document,"click",{className:this.openFieldInfoUrlClassName},function(e){e.preventDefault();if(BX.SidePanel){BX.SidePanel.Instance.open(e.target.getAttribute("href"),{width:845,cacheable:true})}else{location.href=e.target.getAttribute("href")}});BX.bind(BX(this.addNewFieldButtonNodeId),"click",BX.proxy(this.addNewField,this))};BX.Crm.Activity.CrmGenerateEntityDocumentActivity.addNewField=function(e){e.preventDefault();if(BX(this.textFieldNodeId).value.length<=0){return}var t=BX(this.textFieldNodeId).value;var i=BX.findChildrenByClassName(document,this.fieldTableRowClassName,true);if(i.length>1){for(var a=1;a<i.length;a++){if(i[a].children&&i[a].children[0]&&i[a].children[0].dataset["placeholder"]===t){return}}}BX.ajax.post("/bitrix/tools/bizproc_activity_ajax.php",{site_id:BX.message("SITE_ID"),sessid:BX.bitrix_sessid(),document_type:this.documentType,activity:"CrmGenerateEntityDocumentActivity",entity_type:this.entityType,content_type:"html",customer_action:"getValuePropertyDialog",placeholder:BX("add_new_field_text").value,templateId:BX("id_template_id").value,isRobot:this.isRobot===true?"y":"n"},BX.proxy(function(e){if(e){var t=BX.findChildrenByClassName(document,this.fieldTableRowClassName,true);var i=t[t.length-1]||BX("add_new_field_tr");var a=BX.create(this.fieldTableRowTagName,{attrs:{className:this.fieldTableRowClassName},html:e});BX.insertAfter(a,i);if(BX.getClass("BX.Bizproc.Automation.Designer")){var d=BX.Bizproc.Automation.Designer.getRobotSettingsDialog();if(d){d.template.initRobotSettingsControls(d.robot,a)}}}},this))};BX.Crm.Activity.CrmGenerateEntityDocumentActivity.getTemplateFields=function(){var e=BX(this.selectTemplateNodeId).value;if(e>0&&this.entityTypeId>0){BX.ajax.runAction("crm.documentgenerator.template.getFields",{data:{id:e,entityTypeId:this.entityTypeId}}).then(BX.proxy(function(e){BX.cleanNode(BX(this.selectFieldNodeId));var t=[BX.create("option",{attrs:{value:""},text:""})];for(var i in e.data.templateFields){if(e.data.templateFields.hasOwnProperty(i)){if(e.data.templateFields[i]["type"]&&(e.data.templateFields[i]["type"]=="IMAGE"||e.data.templateFields[i]["type"]=="STAMP")){continue}t.push(BX.create("option",{attrs:{value:i},text:i+(e.data.templateFields[i].title?" ("+e.data.templateFields[i].title+")":"")}))}}var a=BX(this.selectFieldNodeId);BX.adjust(a,{children:t})},this)).then(function(e){alert(e.errors.pop().message)})}}})(window);
//# sourceMappingURL=script.map.js