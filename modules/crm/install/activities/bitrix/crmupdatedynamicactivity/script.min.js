(function(t,e,i){"use strict";var n=e.Reflection.namespace("BX.Crm.Activity");var s=function(){function t(i){var n=this;babelHelpers.classCallCheck(this,t);if(e.Type.isPlainObject(i)){this.documentType=i.documentType;this.isRobot=i.isRobot;var s=document.forms[i.formName];if(!e.Type.isNil(s)){this.entityTypeIdSelect=s.dynamic_type_id;this.currentEntityTypeId=this.entityTypeIdSelect.value}if(this.isRobot){this.fieldsListSelect=document.querySelector('[data-role="bca-cuda-fields-list"]')}else{this.addConditionButton=document.querySelector('[data-role="bca_cuda_add_condition"]')}this.entitiesFieldsContainers=document.querySelector('[data-role="bca-cuda-fields-container"]');this.conditinIdPrefix="id_bca_cuda_field_";this.fieldsMap=new Map(Object.entries(i.fieldsMap));this.currentValues=new Map;Array.from(this.fieldsMap.keys()).forEach(function(t){return n.currentValues.set(t,{})});if(!e.Type.isNil(this.currentEntityTypeId)&&e.Type.isObject(i.currentValues)){this.currentValues.set(this.currentEntityTypeId,i.currentValues);this.renderEntityFields()}}}babelHelpers.createClass(t,[{key:"init",value:function t(){if(this.entityTypeIdSelect&&this.fieldsMap&&this.entitiesFieldsContainers){e.Event.bind(this.entityTypeIdSelect,"change",this.onEntityTypeIdChange.bind(this))}if(this.isRobot&&this.fieldsListSelect){e.Event.bind(this.fieldsListSelect,"click",this.onFieldsListSelectClick.bind(this))}else if(!this.isRobot&&this.addConditionButton){e.Event.bind(this.addConditionButton,"click",this.onAddConditionButtonClick.bind(this))}}},{key:"onEntityTypeIdChange",value:function t(){this.currentEntityTypeId=this.entityTypeIdSelect.value;Array.from(this.entitiesFieldsContainers.children).forEach(function(t){return e.Dom.remove(t)});this.renderEntityFields()}},{key:"renderEntityFields",value:function t(){var i=this;if(!e.Type.isNil(this.currentEntityTypeId)&&this.currentEntityTypeId!==""){Object.keys(this.currentValues.get(this.currentEntityTypeId)).forEach(function(t){return i.addCondition(t)})}}},{key:"onFieldsListSelectClick",value:function t(n){var s=this.fieldsMap.get(this.currentEntityTypeId);if(e.Type.isNil(s)){return n.preventDefault()}var r=this;var o=Object.entries(s).map(function(t){var e=babelHelpers.slicedToArray(t,2),i=e[0],n=e[1];return{fieldId:i,text:n.Name,onclick:function t(e,i){this.popupWindow.close();r.addCondition(i.fieldId)}}});var a={id:Math.random().toString(),bindElement:this.fieldsListSelect,items:Array.from(o),autoHide:true,offsetLeft:e.Dom.getPosition(this.fieldsListSelect).width/2,angle:{position:"top",offset:0},zIndex:200,className:"bizproc-automation-inline-selector-menu",events:{onPopupClose:function t(){this.destroy()}}};i.MenuManager.show(a);return n.preventDefault()}},{key:"onAddConditionButtonClick",value:function t(){var e=Object.keys(this.fieldsMap.get(this.currentEntityTypeId))[0];this.addCondition(e)}},{key:"addCondition",value:function t(e){if(this.isRobot){this.addRobotCondition(e)}else{this.addBizprocCondition(e)}}},{key:"addRobotCondition",value:function t(i){var n=this.conditinIdPrefix+i;var s=e.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:this.fieldsMap.get(this.currentEntityTypeId)[i].Name});var r=e.Dom.create("a",{attrs:{className:"bizproc-automation-popup-settings-delete bizproc-automation-popup-settings-link bizproc-automation-popup-settings-link-light"},props:{href:"#"},text:e.Loc.getMessage("CRM_UDA_DELETE_CONDITION"),events:{click:function(t){this.deleteCondition(i);return t.preventDefault()}.bind(this)}});var o=e.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},props:{id:n},children:[s,this.renderField(i),r]});this.entitiesFieldsContainers.appendChild(o)}},{key:"deleteCondition",value:function t(i){var n=this.conditinIdPrefix+i;e.Dom.remove(document.getElementById(n))}},{key:"addBizprocCondition",value:function t(i){var n=this.entitiesFieldsContainers.insertRow(-1);n.id=this.conditinIdPrefix+Math.random().toString().substr(1,5);var s=this;var r=e.Dom.create("select",{children:this.getCurrentFieldsOptions(i),events:{change:function t(e){var i=n.children[2];var r=e.srcElement.value;n.replaceChild(s.renderField(r),i)}}});var o=e.Dom.create("span",{text:"="});var a=this.renderField(i);var d=e.Dom.create("a",{props:{href:"#"},text:e.Loc.getMessage("CRM_UDA_DELETE_CONDITION"),events:{click:function t(i){e.Dom.remove(document.getElementById(n.id));i.preventDefault()}}});[r,o,a,d].forEach(function(t){n.insertCell(-1).appendChild(t)})}},{key:"getCurrentFieldsOptions",value:function t(i){return Object.entries(this.fieldsMap.get(this.currentEntityTypeId)).map(function(t){var n=babelHelpers.slicedToArray(t,2),s=n[0],r=n[1];return e.Dom.create("option",{props:{value:r.FieldName},attrs:i===s?{selected:"selected"}:undefined,text:r.Name})})}},{key:"renderField",value:function t(i){var n=this.currentValues.get(this.currentEntityTypeId)[i];if(e.Type.isNil(n)){n=""}return BX.Bizproc.FieldType.renderControl(this.documentType,this.fieldsMap.get(this.currentEntityTypeId)[i],i,n)}}]);return t}();n.CrmUpdateDynamicActivity=s})(this.window=this.window||{},BX,BX.Main);
//# sourceMappingURL=script.map.js