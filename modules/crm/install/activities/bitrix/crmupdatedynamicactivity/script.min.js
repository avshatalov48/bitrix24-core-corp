(function(e,t,i,n){"use strict";var o=t.Reflection.namespace("BX.Crm.Activity");var s=function(){function e(i){var o=this;babelHelpers.classCallCheck(this,e);if(t.Type.isPlainObject(i)){this.documentType=i.documentType;this.isRobot=i.isRobot;var s=document.forms[i.formName];if(!t.Type.isNil(s)){this.entityTypeIdSelect=s.dynamic_type_id;this.currentEntityTypeId=this.entityTypeIdSelect.value;this.entityTypeDependentElements=document.querySelectorAll('[data-role="bca-cuda-entity-type-id-dependent"]')}this.document=new n.Document({rawDocumentType:this.documentType,documentFields:i.documentFields,title:i.documentName});if(this.isRobot){this.fieldsListSelect=document.querySelector('[data-role="bca-cuda-fields-list"]')}else{this.addConditionButton=document.querySelector('[data-role="bca_cuda_add_condition"]')}this.entitiesFieldsContainers=document.querySelector('[data-role="bca-cuda-fields-container"]');this.conditinIdPrefix="id_bca_cuda_field_";this.fieldsMap=new Map(Object.entries(i.fieldsMap));this.filterFieldsContainer=document.querySelector('[data-role="bca-cuda-filter-fields-container"]');this.filteringFieldsPrefix=i.filteringFieldsPrefix;this.filterFieldsMap=new Map(Object.entries(i.filterFieldsMap));if(!t.Type.isNil(i.documentType)&&!this.isRobot){BX.Bizproc.Automation.API.documentType=i.documentType}this.conditionGroup=new n.ConditionGroup(i.conditions);this.currentValues=new Map;Array.from(this.fieldsMap.keys()).forEach((function(e){return o.currentValues.set(e,{})}));if(!t.Type.isNil(this.currentEntityTypeId)&&t.Type.isObject(i.currentValues)){this.currentValues.set(this.currentEntityTypeId,i.currentValues)}}}babelHelpers.createClass(e,[{key:"init",value:function e(){if(this.entityTypeIdSelect&&this.fieldsMap&&this.entitiesFieldsContainers){t.Event.bind(this.entityTypeIdSelect,"change",this.onEntityTypeIdChange.bind(this))}if(this.isRobot&&this.fieldsListSelect){t.Event.bind(this.fieldsListSelect,"click",this.onFieldsListSelectClick.bind(this))}else if(!this.isRobot&&this.addConditionButton){t.Event.bind(this.addConditionButton,"click",this.onAddConditionButtonClick.bind(this))}this.initAutomationContext()}},{key:"initAutomationContext",value:function e(){var t=this;try{n.getGlobalContext();if(this.isRobot){this.onOpenFilterFieldsMenu=function(e){var t=n.Designer.getInstance().getRobotSettingsDialog();var i=t.template;var o=t.robot;if(i&&o){i.onOpenMenu(e,o)}}}}catch(e){n.setGlobalContext(new n.Context({document:this.document}));this.onOpenFilterFieldsMenu=function(e){return t.addBPFields(e.getData().selector)}}}},{key:"addBPFields",value:function e(i){var n=function e(i){var n=i.properties,o=i.objectName,s=i.expressionPrefix;if(t.Type.isObject(n)){return Object.entries(n).map((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],n=t[1];return{id:i,title:n.Name,customData:{field:{Id:i,Type:n.Type,Name:n.Name,ObjectName:o,SystemExpression:"{=".concat(o,":").concat(i,"}"),Expression:s?"{{".concat(s,":").concat(i,"}}"):"{=".concat(o,":").concat(i,"}")}}}}))}return[]};var o=function e(i){var n=i.properties,o=i.visibilityNames,s=i.objectName;if(t.Type.isObject(n)){return Object.entries(n).map((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],n=t[1];var r={id:i,Type:n.Type,title:n.Name,ObjectName:s,SystemExpression:"{=".concat(s,":").concat(i,"}"),Expression:"{=".concat(s,":").concat(i,"}")};if(n.Visibility&&o[n.Visibility]){r.Expression="{{".concat(o[n.Visibility],":").concat(n.Name,"}}")}return{id:i,title:n.Name,supertitle:o[n.Visibility],customData:{field:r}}}))}return[]};i.addGroup("workflowParameters",{id:"workflowParameters",title:t.Loc.getMessage("BIZPROC_WFEDIT_MENU_PARAMS"),children:[{id:"parameters",title:t.Loc.getMessage("BIZPROC_AUTOMATION_CMP_PARAMETERS_LIST"),children:n({properties:window.arWorkflowParameters||{},objectName:"Template",expressionPrefix:"~*"})},{id:"variables",title:t.Loc.getMessage("BIZPROC_AUTOMATION_CMP_GLOB_VARIABLES_LIST_1"),children:n({properties:window.arWorkflowVariables||{},objectName:"Variable"})},{id:"constants",title:t.Loc.getMessage("BIZPROC_AUTOMATION_CMP_CONSTANTS_LIST"),children:n({properties:window.arWorkflowConstants||{},objectName:"Constant",expressionPrefix:"~&"})}]});if(window.arWorkflowGlobalVariables&&window.wfGVarVisibilityNames){i.addGroup("globalVariables",{id:"globalVariables",title:t.Loc.getMessage("BIZPROC_AUTOMATION_CMP_GLOB_VARIABLES_LIST"),children:o({properties:window.arWorkflowGlobalVariables||{},visibilityNames:window.wfGVarVisibilityNames||{},objectName:"GlobalVar"})})}i.addGroup("globalConstants",{id:"globalConstants",title:t.Loc.getMessage("BIZPROC_AUTOMATION_CMP_GLOB_CONSTANTS_LIST"),children:o({properties:window.arWorkflowGlobalConstants||{},visibilityNames:window.wfGConstVisibilityNames||{},objectName:"GlobalConst"})})}},{key:"onEntityTypeIdChange",value:function e(){this.currentEntityTypeId=this.entityTypeIdSelect.value;t.Dom.clean(this.filterFieldsContainer);this.conditionGroup=new n.ConditionGroup;Array.from(this.entitiesFieldsContainers.children).forEach((function(e){return t.Dom.remove(e)}));this.render()}},{key:"render",value:function e(){if(t.Type.isNil(this.currentEntityTypeId)||this.currentEntityTypeId===""){this.entityTypeDependentElements.forEach((function(e){return t.Dom.hide(e)}))}else{this.entityTypeDependentElements.forEach((function(e){return t.Dom.show(e)}));this.renderFilterFields();this.renderEntityFields()}}},{key:"renderFilterFields",value:function e(){if(!t.Type.isNil(this.conditionGroup)&&!t.Type.isNil(this.currentEntityTypeId)){var i=new n.ConditionGroupSelector(this.conditionGroup,{fields:Object.values(this.filterFieldsMap.get(this.currentEntityTypeId)),fieldPrefix:this.filteringFieldsPrefix,onOpenMenu:this.onOpenFilterFieldsMenu});this.filterFieldsContainer.appendChild(i.createNode())}}},{key:"renderEntityFields",value:function e(){var t=this;Object.keys(this.currentValues.get(this.currentEntityTypeId)).forEach((function(e){return t.addCondition(e)}))}},{key:"onFieldsListSelectClick",value:function e(n){var o=this.fieldsMap.get(this.currentEntityTypeId);if(t.Type.isNil(o)){return n.preventDefault()}var s=this;var r=Object.entries(o).map((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],n=t[1];return{fieldId:i,text:n.Name,onclick:function e(t,i){this.popupWindow.close();s.addCondition(i.fieldId)}}}));var a={id:Math.random().toString(),bindElement:this.fieldsListSelect,items:Array.from(r),autoHide:true,offsetLeft:t.Dom.getPosition(this.fieldsListSelect).width/2,angle:{position:"top",offset:0},zIndex:200,className:"bizproc-automation-inline-selector-menu",events:{onPopupClose:function e(){this.destroy()}}};i.MenuManager.show(a);return n.preventDefault()}},{key:"onAddConditionButtonClick",value:function e(t){var i=Object.keys(this.fieldsMap.get(this.currentEntityTypeId))[0];this.addCondition(i);return t.preventDefault()}},{key:"addCondition",value:function e(t){if(this.isRobot){this.addRobotCondition(t)}else{this.addBizprocCondition(t)}}},{key:"addRobotCondition",value:function e(i){var n=this.conditinIdPrefix+i;var o=t.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:this.fieldsMap.get(this.currentEntityTypeId)[i].Name});var s=t.Dom.create("a",{attrs:{className:"bizproc-automation-popup-settings-delete bizproc-automation-popup-settings-link bizproc-automation-popup-settings-link-light"},props:{href:"#"},text:t.Loc.getMessage("CRM_UDA_DELETE_CONDITION"),events:{click:function(e){this.deleteCondition(i);return e.preventDefault()}.bind(this)}});var r=t.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},props:{id:n},children:[o,this.renderField(i),s]});this.entitiesFieldsContainers.appendChild(r)}},{key:"deleteCondition",value:function e(i){var n=this.conditinIdPrefix+i;t.Dom.remove(document.getElementById(n))}},{key:"addBizprocCondition",value:function e(i){var n=this.entitiesFieldsContainers.insertRow(-1);n.id=this.conditinIdPrefix+Math.random().toString().substr(1,5);var o=this;var s=t.Dom.create("select",{children:this.getCurrentFieldsOptions(i),events:{change:function e(t){var i=n.children[2];var s=t.srcElement.value;n.replaceChild(o.renderField(s),i)}}});var r=t.Dom.create("span",{text:"="});var a=this.renderField(i);var l=t.Dom.create("a",{props:{href:"#"},text:t.Loc.getMessage("CRM_UDA_DELETE_CONDITION"),events:{click:function e(i){t.Dom.remove(document.getElementById(n.id));i.preventDefault()}}});[s,r,a,l].forEach((function(e){n.insertCell(-1).appendChild(e)}))}},{key:"getCurrentFieldsOptions",value:function e(i){return Object.entries(this.fieldsMap.get(this.currentEntityTypeId)).map((function(e){var n=babelHelpers.slicedToArray(e,2),o=n[0],s=n[1];return t.Dom.create("option",{props:{value:s.FieldName},attrs:i===o?{selected:"selected"}:undefined,text:s.Name})}))}},{key:"renderField",value:function e(i){var n=this.currentValues.get(this.currentEntityTypeId)[i];if(t.Type.isNil(n)){n=""}return BX.Bizproc.FieldType.renderControl(this.documentType,this.fieldsMap.get(this.currentEntityTypeId)[i],i,n,this.isRobot?"public":"designer")}}]);return e}();o.CrmUpdateDynamicActivity=s})(this.window=this.window||{},BX,BX.Main,BX.Bizproc.Automation);
//# sourceMappingURL=script.map.js