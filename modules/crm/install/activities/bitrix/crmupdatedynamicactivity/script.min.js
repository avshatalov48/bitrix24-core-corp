(function(e,t,i,n){"use strict";var s=t.Reflection.namespace("BX.Crm.Activity");var o=function(){function e(i){var s=this;babelHelpers.classCallCheck(this,e);if(t.Type.isPlainObject(i)){this.documentType=i.documentType;this.isRobot=i.isRobot;var o=document.forms[i.formName];if(!t.Type.isNil(o)){this.entityTypeIdSelect=o.dynamic_type_id;this.currentEntityTypeId=this.entityTypeIdSelect.value;this.entityTypeDependentElements=document.querySelectorAll('[data-role="bca-cuda-entity-type-id-dependent"]')}this.document=new n.Document({rawDocumentType:this.documentType,documentFields:i.fieldsMap,title:i.documentName});if(this.isRobot){this.fieldsListSelect=document.querySelector('[data-role="bca-cuda-fields-list"]')}else{this.addConditionButton=document.querySelector('[data-role="bca_cuda_add_condition"]')}this.entitiesFieldsContainers=document.querySelector('[data-role="bca-cuda-fields-container"]');this.conditinIdPrefix="id_bca_cuda_field_";this.fieldsMap=new Map(Object.entries(i.fieldsMap));this.filterFieldsContainer=document.querySelector('[data-role="bca-cuda-filter-fields-container"]');this.filteringFieldsPrefix=i.filteringFieldsPrefix;this.filterFieldsMap=new Map(Object.entries(i.filterFieldsMap));this.conditionGroup=new n.ConditionGroup(i.conditions);this.currentValues=new Map;Array.from(this.fieldsMap.keys()).forEach((function(e){return s.currentValues.set(e,{})}));if(!t.Type.isNil(this.currentEntityTypeId)&&t.Type.isObject(i.currentValues)){this.currentValues.set(this.currentEntityTypeId,i.currentValues)}this.render()}}babelHelpers.createClass(e,[{key:"init",value:function e(){if(this.entityTypeIdSelect&&this.fieldsMap&&this.entitiesFieldsContainers){t.Event.bind(this.entityTypeIdSelect,"change",this.onEntityTypeIdChange.bind(this))}if(this.isRobot&&this.fieldsListSelect){t.Event.bind(this.fieldsListSelect,"click",this.onFieldsListSelectClick.bind(this))}else if(!this.isRobot&&this.addConditionButton){t.Event.bind(this.addConditionButton,"click",this.onAddConditionButtonClick.bind(this))}this.initAutomationContext()}},{key:"initAutomationContext",value:function e(){try{n.getGlobalContext()}catch(e){n.setGlobalContext(new n.AutomationContext({document:this.document}))}}},{key:"onEntityTypeIdChange",value:function e(){this.currentEntityTypeId=this.entityTypeIdSelect.value;t.Dom.clean(this.filterFieldsContainer);this.conditionGroup=new n.ConditionGroup;Array.from(this.entitiesFieldsContainers.children).forEach((function(e){return t.Dom.remove(e)}));this.render()}},{key:"render",value:function e(){if(t.Type.isNil(this.currentEntityTypeId)||this.currentEntityTypeId===""){this.entityTypeDependentElements.forEach((function(e){return t.Dom.hide(e)}))}else{this.entityTypeDependentElements.forEach((function(e){return t.Dom.show(e)}));this.renderFilterFields();this.renderEntityFields()}}},{key:"renderFilterFields",value:function e(){if(!t.Type.isNil(this.conditionGroup)&&!t.Type.isNil(this.currentEntityTypeId)){var i=new n.ConditionGroupSelector(this.conditionGroup,{fields:Object.values(this.filterFieldsMap.get(this.currentEntityTypeId)),fieldPrefix:this.filteringFieldsPrefix});this.filterFieldsContainer.appendChild(i.createNode())}}},{key:"renderEntityFields",value:function e(){var t=this;Object.keys(this.currentValues.get(this.currentEntityTypeId)).forEach((function(e){return t.addCondition(e)}))}},{key:"onFieldsListSelectClick",value:function e(n){var s=this.fieldsMap.get(this.currentEntityTypeId);if(t.Type.isNil(s)){return n.preventDefault()}var o=this;var r=Object.entries(s).map((function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],n=t[1];return{fieldId:i,text:n.Name,onclick:function e(t,i){this.popupWindow.close();o.addCondition(i.fieldId)}}}));var d={id:Math.random().toString(),bindElement:this.fieldsListSelect,items:Array.from(r),autoHide:true,offsetLeft:t.Dom.getPosition(this.fieldsListSelect).width/2,angle:{position:"top",offset:0},zIndex:200,className:"bizproc-automation-inline-selector-menu",events:{onPopupClose:function e(){this.destroy()}}};i.MenuManager.show(d);return n.preventDefault()}},{key:"onAddConditionButtonClick",value:function e(t){var i=Object.keys(this.fieldsMap.get(this.currentEntityTypeId))[0];this.addCondition(i);return t.preventDefault()}},{key:"addCondition",value:function e(t){if(this.isRobot){this.addRobotCondition(t)}else{this.addBizprocCondition(t)}}},{key:"addRobotCondition",value:function e(i){var n=this.conditinIdPrefix+i;var s=t.Dom.create("span",{attrs:{className:"bizproc-automation-popup-settings-title bizproc-automation-popup-settings-title-autocomplete"},text:this.fieldsMap.get(this.currentEntityTypeId)[i].Name});var o=t.Dom.create("a",{attrs:{className:"bizproc-automation-popup-settings-delete bizproc-automation-popup-settings-link bizproc-automation-popup-settings-link-light"},props:{href:"#"},text:t.Loc.getMessage("CRM_UDA_DELETE_CONDITION"),events:{click:function(e){this.deleteCondition(i);return e.preventDefault()}.bind(this)}});var r=t.Dom.create("div",{attrs:{className:"bizproc-automation-popup-settings"},props:{id:n},children:[s,this.renderField(i),o]});this.entitiesFieldsContainers.appendChild(r)}},{key:"deleteCondition",value:function e(i){var n=this.conditinIdPrefix+i;t.Dom.remove(document.getElementById(n))}},{key:"addBizprocCondition",value:function e(i){var n=this.entitiesFieldsContainers.insertRow(-1);n.id=this.conditinIdPrefix+Math.random().toString().substr(1,5);var s=this;var o=t.Dom.create("select",{children:this.getCurrentFieldsOptions(i),events:{change:function e(t){var i=n.children[2];var o=t.srcElement.value;n.replaceChild(s.renderField(o),i)}}});var r=t.Dom.create("span",{text:"="});var d=this.renderField(i);var a=t.Dom.create("a",{props:{href:"#"},text:t.Loc.getMessage("CRM_UDA_DELETE_CONDITION"),events:{click:function e(i){t.Dom.remove(document.getElementById(n.id));i.preventDefault()}}});[o,r,d,a].forEach((function(e){n.insertCell(-1).appendChild(e)}))}},{key:"getCurrentFieldsOptions",value:function e(i){return Object.entries(this.fieldsMap.get(this.currentEntityTypeId)).map((function(e){var n=babelHelpers.slicedToArray(e,2),s=n[0],o=n[1];return t.Dom.create("option",{props:{value:o.FieldName},attrs:i===s?{selected:"selected"}:undefined,text:o.Name})}))}},{key:"renderField",value:function e(i){var n=this.currentValues.get(this.currentEntityTypeId)[i];if(t.Type.isNil(n)){n=""}return BX.Bizproc.FieldType.renderControl(this.documentType,this.fieldsMap.get(this.currentEntityTypeId)[i],i,n,this.isRobot?"public":"designer")}}]);return e}();s.CrmUpdateDynamicActivity=o})(this.window=this.window||{},BX,BX.Main,BX.Bizproc);
//# sourceMappingURL=script.map.js