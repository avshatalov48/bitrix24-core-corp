this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,s,t,l){"use strict";const a=s.Reflection.namespace("BX.Crm.Activity");var i=babelHelpers.classPrivateFieldLooseKey("isRobot");var r=babelHelpers.classPrivateFieldLooseKey("documentType");var o=babelHelpers.classPrivateFieldLooseKey("formName");var n=babelHelpers.classPrivateFieldLooseKey("editorWrapper");var b=babelHelpers.classPrivateFieldLooseKey("templates");var c=babelHelpers.classPrivateFieldLooseKey("placeholders");var d=babelHelpers.classPrivateFieldLooseKey("templateId");var p=babelHelpers.classPrivateFieldLooseKey("dialogItems");var v=babelHelpers.classPrivateFieldLooseKey("items");var h=babelHelpers.classPrivateFieldLooseKey("onChangeTemplate");var u=babelHelpers.classPrivateFieldLooseKey("setOnBeforeSaveSettingsCallback");var P=babelHelpers.classPrivateFieldLooseKey("setCurrentTemplate");var m=babelHelpers.classPrivateFieldLooseKey("addTemplate");var F=babelHelpers.classPrivateFieldLooseKey("loadTemplate");var L=babelHelpers.classPrivateFieldLooseKey("insertTemplateEditor");var f=babelHelpers.classPrivateFieldLooseKey("fillDialogItems");var H=babelHelpers.classPrivateFieldLooseKey("prepareFilledPlaceholders");var y=babelHelpers.classPrivateFieldLooseKey("removeTemplateEditor");var B=babelHelpers.classPrivateFieldLooseKey("onBeforeSaveRobotSettings");class g{constructor(e){Object.defineProperty(this,B,{value:R});Object.defineProperty(this,y,{value:D});Object.defineProperty(this,H,{value:K});Object.defineProperty(this,f,{value:I});Object.defineProperty(this,L,{value:C});Object.defineProperty(this,F,{value:w});Object.defineProperty(this,m,{value:j});Object.defineProperty(this,P,{value:E});Object.defineProperty(this,u,{value:O});Object.defineProperty(this,h,{value:T});Object.defineProperty(this,i,{writable:true,value:void 0});Object.defineProperty(this,r,{writable:true,value:void 0});Object.defineProperty(this,o,{writable:true,value:void 0});Object.defineProperty(this,n,{writable:true,value:void 0});Object.defineProperty(this,b,{writable:true,value:new Map});Object.defineProperty(this,c,{writable:true,value:new Map});Object.defineProperty(this,d,{writable:true,value:void 0});Object.defineProperty(this,p,{writable:true,value:[]});Object.defineProperty(this,v,{writable:true,value:{}});babelHelpers.classPrivateFieldLooseBase(this,i)[i]=s.Type.isBoolean(e.isRobot)?e.isRobot:true;if(!s.Type.isArrayFilled(e.documentType)){throw new Error("documentType must be filled array")}babelHelpers.classPrivateFieldLooseBase(this,r)[r]=e.documentType;if(!s.Type.isElementNode(e.editorWrapper)){throw new Error("editorWrapper must be HTMLDivElement")}babelHelpers.classPrivateFieldLooseBase(this,n)[n]=e.editorWrapper;if(!s.Type.isStringFilled(e.formName)){throw new Error("formName must be filled string")}babelHelpers.classPrivateFieldLooseBase(this,o)[o]=e.formName;const t=document.forms[babelHelpers.classPrivateFieldLooseBase(this,o)[o]];if(!t||!t.template_id){throw new Error("form must have template_id element")}s.Event.bind(t.template_id,"change",babelHelpers.classPrivateFieldLooseBase(this,h)[h].bind(this));babelHelpers.classPrivateFieldLooseBase(this,u)[u]();babelHelpers.classPrivateFieldLooseBase(this,f)[f]();if(s.Type.isPlainObject(e.currentTemplate)&&s.Text.toInteger(e.currentTemplateId)>0){babelHelpers.classPrivateFieldLooseBase(this,P)[P](s.Text.toInteger(e.currentTemplateId),e.currentTemplate,e.currentPlaceholders)}}}function T(e){const t=e.target;if(!t){return}const l=t.selectedOptions;const a=l.item(0)?s.Text.toInteger(l.item(0).value):0;babelHelpers.classPrivateFieldLooseBase(this,d)[d]=a;if(a<=0){babelHelpers.classPrivateFieldLooseBase(this,y)[y]();return}if(babelHelpers.classPrivateFieldLooseBase(this,b)[b].has(a)){babelHelpers.classPrivateFieldLooseBase(this,L)[L](a);return}babelHelpers.classPrivateFieldLooseBase(this,F)[F](a).then((({data:e})=>{if(s.Type.isPlainObject(e)){babelHelpers.classPrivateFieldLooseBase(this,m)[m](a,e);babelHelpers.classPrivateFieldLooseBase(this,L)[L](a)}})).catch((e=>console.error(e.errors)))}function O(){if(!babelHelpers.classPrivateFieldLooseBase(this,i)[i]){return}const e=l.Designer.getInstance();const s=e?e.getRobotSettingsDialog():null;if(s!=null&&s.robot){s.robot.setOnBeforeSaveRobotSettings(babelHelpers.classPrivateFieldLooseBase(this,B)[B].bind(this))}}function E(e,t,l){babelHelpers.classPrivateFieldLooseBase(this,d)[d]=e;babelHelpers.classPrivateFieldLooseBase(this,m)[m](e,t);if(s.Type.isPlainObject(l)){const s=babelHelpers.classPrivateFieldLooseBase(this,c)[c].get(e);Object.entries(l).forEach((([e,t])=>{if(Object.hasOwn(babelHelpers.classPrivateFieldLooseBase(this,v)[v],t)){s.set(e,{value:t,parentTitle:babelHelpers.classPrivateFieldLooseBase(this,v)[v][t].parentTitle,title:babelHelpers.classPrivateFieldLooseBase(this,v)[v][t].title})}}))}babelHelpers.classPrivateFieldLooseBase(this,L)[L](e)}function j(e,t){const l=s.Type.isString(t.content)?t.content:"";babelHelpers.classPrivateFieldLooseBase(this,b)[b].set(e,{content:s.Text.encode(l).replaceAll("\n","<br>"),placeholders:s.Type.isPlainObject(t.placeholders)?t.placeholders:{}});babelHelpers.classPrivateFieldLooseBase(this,c)[c].set(e,new Map)}function w(e){return s.ajax.runAction("bizproc.activity.request",{data:{documentType:babelHelpers.classPrivateFieldLooseBase(this,r)[r],activity:"CrmSendWhatsAppMessageActivity",params:{template_id:e,form_name:babelHelpers.classPrivateFieldLooseBase(this,o)[o]}}})}function C(e){var l;const a=babelHelpers.classPrivateFieldLooseBase(this,b)[b].get(e);s.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,n)[n],"bizproc-automation-whats-app-message-activity-editor");s.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,i)[i]?babelHelpers.classPrivateFieldLooseBase(this,n)[n].parentElement:(l=babelHelpers.classPrivateFieldLooseBase(this,n)[n].parentElement)==null?void 0:l.parentElement,"--hidden");const r=new t.Editor({target:babelHelpers.classPrivateFieldLooseBase(this,n)[n],onSelect:({id:s,value:t,parentTitle:l,title:a})=>{const i=babelHelpers.classPrivateFieldLooseBase(this,c)[c].get(e);i.set(s,{value:t,parentTitle:l,title:a})},dialogOptions:{items:babelHelpers.classPrivateFieldLooseBase(this,p)[p],entities:[]},usePlaceholderProvider:false,canUseFieldsDialog:true,canUseFieldValueInput:false});r.setPlaceholders(a.placeholders).setFilledPlaceholders(babelHelpers.classPrivateFieldLooseBase(this,H)[H](e)).setBody(a.content)}function I(){if(!babelHelpers.classPrivateFieldLooseBase(this,i)[i]){return}const e=l.tryGetGlobalContext();if(!e){return}const s=l.Designer.getInstance();const t=s?s.component:null;const a=s?s.getRobotSettingsDialog():null;const r=a?a.template:null;const o=t?t.triggerManager:null;const n=r?r.getRobotsWithReturnFields(a.robot):[];const b=new l.SelectorItemsManager({documentFields:l.enrichFieldsWithModifiers(e.document.getFields(),"Document"),documentTitle:e.document.title,globalVariables:e.automationGlobals.globalVariables,variables:r?r.getVariables():null,globalConstants:e.automationGlobals.globalConstants,constants:r?r.getConstants():null,activityResultFields:n.map((e=>({id:e.getId(),title:e.getTitle(),fields:l.enrichFieldsWithModifiers(e.getReturnFieldsDescription(),e.getId(),{friendly:false,printable:false,server:false,responsible:false,shortLink:true})}))),triggerResultFields:o&&r?o.getReturnProperties(r.getStatusId()):null,useModifier:true});babelHelpers.classPrivateFieldLooseBase(this,p)[p]=b.groupsWithChildren;b.items.forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,v)[v][e.id]={title:e.title,parentTitle:e.supertitle}}))}function K(e){const s=[];const t=babelHelpers.classPrivateFieldLooseBase(this,c)[c].get(e);t.forEach(((e,t)=>{s.push({PLACEHOLDER_ID:t,FIELD_NAME:e.value,FIELD_ENTITY_TYPE:"bp",TITLE:e.title,PARENT_TITLE:e.parentTitle})}));return s}function D(){var e;s.Dom.removeClass(babelHelpers.classPrivateFieldLooseBase(this,n)[n],"bizproc-automation-whats-app-message-activity-editor");s.Dom.clean(babelHelpers.classPrivateFieldLooseBase(this,n)[n]);s.Dom.addClass(babelHelpers.classPrivateFieldLooseBase(this,i)[i]?babelHelpers.classPrivateFieldLooseBase(this,n)[n].parentElement:(e=babelHelpers.classPrivateFieldLooseBase(this,n)[n].parentElement)==null?void 0:e.parentElement,"--hidden")}function R(){if(babelHelpers.classPrivateFieldLooseBase(this,d)[d]>0){const e={};babelHelpers.classPrivateFieldLooseBase(this,c)[c].get(babelHelpers.classPrivateFieldLooseBase(this,d)[d]).forEach((({value:s},t)=>{e[t]=s}));return{placeholders:e}}return{}}a.CrmSendWhatsAllMessageActivity=g})(this.BX.Crm.Activity=this.BX.Crm.Activity||{},BX,BX.Crm.Template,BX.Bizproc.Automation);
//# sourceMappingURL=script.map.js