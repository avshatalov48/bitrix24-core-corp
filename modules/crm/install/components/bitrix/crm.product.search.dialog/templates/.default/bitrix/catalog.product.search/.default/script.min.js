BX.namespace("BX.Crm");if(typeof BX.Crm.ProductSearchDialog==="undefined"){BX.Crm.ProductSearchDialog=function(){var e=function(e){this.tableId=e.tableId;this.callback=e.callback;this.callerName=e.callerName;this.currentUri=e.currentUri;this.popup=e.popup;this.iblockName=e.iblockName;this.jsEventsManagerId=e.jsEventsManagerId||"";this.jsEventsManager=BX.Crm[this.jsEventsManagerId]||null;this.leftContainerId=e.leftContainerId;this.leftContainer=BX(this.leftContainerId);this.splitterBtnId=e.splitterBtnId;this.splitterBtn=null;this.splitterBtnInner=null;this.splitter=null;this.searchTimer=null;this.isExternalSectionSelectDisabled=false;this.isSelectSectionEventDisabled=false;if(BX.type.isPlainObject(BX.Crm.ProductSearchDialog.splitterConfig)){this.splitterConfig=BX.Crm.ProductSearchDialog.splitterConfig}else{BX.Crm.ProductSearchDialog.splitterConfig=this.splitterConfig={isCollapsed:false,splitterBtnExpandValue:270,leftContainerExpandValue:275}}if(this.leftContainer&&typeof BX.Crm.Splitter!=="undefined"){var t=this.leftContainer.parentNode;if(t){this.splitterBtnInner=BX.create("DIV",{attrs:{id:this.splitterBtnId+"_inner",className:"crm-catalog-scale-btn-inner"}});this.splitterBtn=BX.create("DIV",{attrs:{id:this.splitterBtnId,className:"crm-catalog-scale-btn"},children:[this.splitterBtnInner]});if(BX.type.isPlainObject(this.splitterConfig)){this.leftContainer.style.width=(this.splitterConfig.isCollapsed?0:this.splitterConfig.leftContainerExpandValue)+"px";this.splitterBtn.style.left=(this.splitterConfig.isCollapsed?0:this.splitterConfig.splitterBtnExpandValue)+"px";if(this.splitterConfig.isCollapsed)BX.addClass(this.splitterBtn,"crm-catalog-close")}t.appendChild(this.splitterBtn);var i=this;this.splitter=new BX.Crm.Splitter({splitterMoveBtn:this.splitterBtn,isCollapse:this.splitterConfig.isCollapsed,splitterElem:[{node:this.splitterBtn,attr:"left",collapseValue:0,expandValue:this.splitterConfig.splitterBtnExpandValue,minValue:130,maxValue:925},{node:this.leftContainer,attr:"width",collapseValue:0,expandValue:this.splitterConfig.leftContainerExpandValue,minValue:135,maxValue:930}],splitterCallBack:BX.delegate(this._handleSplitterState,this),collapse:{collapseBtn:this.splitterBtnInner,collapseCallback:function(e){if(this.moveBtn.classList)this.moveBtn.classList.toggle("crm-catalog-close");i._handleSplitterState(e)},collapseAnimDuration:250,collapseAnimTimeFunc:BX.easing.makeEaseOut(BX.easing.transitions.linear)}})}}var n=this,l=function(e){var t=!!BX(n.tableId+"_form");if(t){if(!e.altKey&&!e.ctrlKey&&!e.metaKey&&document.activeElement.tagName!="INPUT"&&document.activeElement.tagName!="SELECT"&&document.activeElement.tagName!="TEXTAREA"){if(e.keyCode>=48&&e.keyCode<=90||e.keyCode>=96&&e.keyCode<=105||e.keyCode==219||e.keyCode==221){BX(n.tableId+"_query").focus()}}}else if(document.removeEventListener)document.removeEventListener("keydown",l);else document.detachEvent("onkeydown",l)};if(document.addEventListener)document.addEventListener("keydown",l);else if(document.attachEvent)document.attachEvent("onkeydown",l);this.jsEventsManager.registerEventHandler("CrmProduct_SelectSection",BX.proxy(this.onExternalSectionSelect,this))};e.prototype={getIblockId:function(){return BX(this.tableId+"_iblock").value},getForm:function(){return BX(this.tableId+"_form")},SelEl:function(e,t){this.clearSelection();if(t)BX.removeClass(t,"bx-active");if(e&&e["id"])BX.onCustomEvent("CrmProductSearchDialog_SelectProduct",[e["id"]])},clearSelection:function(){if(document.selection&&document.selection.empty){document.selection.empty()}else if(window.getSelection){var e=window.getSelection();e.removeAllRanges()}},onSubmitForm:function(){var e=BX.ajax.prepareForm(this.getForm()),t=[];for(var i in e.data){if(e.data.hasOwnProperty(i)&&e.data[i]){t.push(encodeURIComponent(i)+"="+encodeURIComponent(e.data[i]))}}t.push("sessid="+BX.bitrix_sessid());t.push("JS_EVENTS_MANAGER_ID="+this.jsEventsManagerId);t=this.currentUri+"?"+t.join("&");window["bxGrid_"+this.tableId].Reload(t);return false},onSearch:function(e,t){var i=BX(this.tableId+"_query_value"),n=i.value;if(n==e)return false;i.value=e;var l=this;if(this.searchTimer!=null)clearTimeout(this.searchTimer);this.searchTimer=setTimeout(function(){if(e.length==0||e.length>2){l.onSubmitForm()}BX(l.tableId+"_query_clear").style.display=e.length==0?"none":"inline";l.searchTimer=null},t||500)},clearQuery:function(){var e=BX(this.tableId+"_query"),t=e.value;e.value="";if(t.length>2)this.onSearch("",10);return false},checkSubstring:function(){var e=BX(this.tableId+"_query_substring"),t=BX(this.tableId+"_query_substring_value");if(BX.type.isElementNode(e)&&BX.type.isElementNode(t)){t.value=e.checked?"Y":"N";return true}return false},search:function(){var e=BX(this.tableId+"_query_value"),t=BX(this.tableId+"_query");if(BX.type.isElementNode(e)&&BX.type.isElementNode(t)){e.value=t.value;this.onSubmitForm()}},onExternalSectionSelect:function(e){if(this.isExternalSectionSelectDisabled)return;this.isSelectSectionEventDisabled=true;if(e)this.onSectionChange(e["sectionId"],e["sectionName"]);this.isSelectSectionEventDisabled=false},onSectionChange:function(e,t){BX(this.tableId+"_section_id").value=e;this.onSubmitForm();var i=BX(this.tableId+"_section_label");i.innerHTML=e!="0"?BX.util.htmlspecialchars(t)+' <span class="crm-search-tag-del" onclick="return '+this.tableId+'_helper._handleLabelDelClick()"></span>':"";i.style.display=e!="0"?"inline-block":"none";if(!this.isSelectSectionEventDisabled){this.isExternalSectionSelectDisabled=true;this.jsEventsManager.fireEvent("CrmProduct_SelectSection",[{sectionId:e,sectionName:t}]);this.isExternalSectionSelectDisabled=false}return false},_handleLabelDelClick:function(){this.onSectionChange("0","")},_handleSplitterState:function(e,t){var i=false;e=!!e;if(this.splitterConfig.isCollapsed!==e){this.splitterConfig.isCollapsed=e;i=true}if(t instanceof Array){for(var n=0;n<t.length;n++){if(t[n].node&&t[n].node===this.splitterBtn){this.splitterConfig.splitterBtnExpandValue=parseInt(t[n].val);i=true;break}}}if(i){this.splitterConfig.leftContainerExpandValue=this.splitterConfig.splitterBtnExpandValue+5;BX.Crm.ProductSearchDialog.splitterConfig=this.splitterConfig}}};return e}()}