if(typeof CrmAdsRetargeting==="undefined"){CrmAdsRetargeting=function(e){this.containerId=e.containerId||"crm-robot-ads-container-"+e.provider.TYPE;this.provider=e.provider;this.context=e.context;this.onRequest=e.onRequest;this.componentName=e.componentName;this.signedParameters=e.signedParameters;this.mess=e.mess;if(e.destroyEventName){BX.addCustomEvent(window,e.destroyEventName,BX.proxy(function(){this.unbindAll();this.cleanInstances()},this))}this.accountId=e.accountId;this.audienceId=e.audienceId;this.autoRemoveDayNumber=e.autoRemoveDayNumber;this.hasAudiences=false;this.loaded=[];this.init();this.showBlockByAuth()};CrmAdsRetargeting.prototype={instances:[],cleanInstances:function(){for(var e=0,t=this.instances.length;e<t;e++){if(!this.instances[e]){continue}this.instances[e].unbindAll();delete this.instances[e];this.instances[e]=null}},unbindAll:function(){BX.removeCustomEvent(window,"seo-client-auth-result",BX.proxy(this.onSeoAuth,this))},init:function(){this.cleanInstances();this.instances.push(this);this.containerNode=BX(this.containerId);if(!this.containerNode){this.containerNode=BX.create("div");this.containerNode.id=this.containerId}this.insertTemplateIntoNode("settings",this.containerNode);this.uiNodes={avatar:this.containerNode.querySelector("[data-bx-ads-auth-avatar]"),name:this.containerNode.querySelector("[data-bx-ads-auth-name]"),link:this.containerNode.querySelector("[data-bx-ads-auth-link]"),logout:this.containerNode.querySelector("[data-bx-ads-auth-logout]"),account:this.containerNode.querySelector("[data-bx-ads-account]"),accountLoader:this.containerNode.querySelector("[data-bx-ads-account-loader]"),audience:[],errorNotFound:this.containerNode.querySelector("[data-bx-ads-audience-not-found]"),refreshButton:this.containerNode.querySelector("[data-bx-ads-refresh-btn]"),createLinks:BX.convert.nodeListToArray(this.containerNode.querySelectorAll("[data-bx-ads-audience-create-link]")),autoRemover:{node:this.containerNode.querySelector("[data-bx-ads-audience-auto-remove]"),checker:this.containerNode.querySelector("[data-bx-ads-audience-auto-remove-checker]"),select:this.containerNode.querySelector("[data-bx-ads-audience-auto-remove-select]")}};var e="data-bx-ads-audience";var t="data-bx-ads-audience-loader";var i="data-bx-ads-audience-checker";var o=this.containerNode.querySelectorAll("["+e+"]");o=BX.convert.nodeListToArray(o);o.forEach(function(o){var n=o.getAttribute(e);var s=this.containerNode.querySelector("["+i+'="'+n+'"]');var r="["+t+(!n?"":'="'+n+'"')+"]";this.uiNodes.audience.push({type:n,node:o,loader:this.containerNode.querySelector(r),checker:s});BX.bind(s,"change",function(){o.disabled=o.options.length>0?!this.checked:true})},this);this.uiNodes.createLinks.forEach(function(e){BX.bind(e,"click",BX.proxy(function(){if(!this.hasAudiences)this.showBlockRefresh()},this))},this);BX.bind(this.uiNodes.refreshButton,"click",BX.proxy(function(){this.getProvider()},this));if(this.uiNodes.autoRemover.checker){BX.bind(this.uiNodes.autoRemover.checker,"click",BX.proxy(function(){var e=this.uiNodes.autoRemover;e.select.disabled=!e.checker.checked},this))}this.loader.init(this);BX.bind(this.uiNodes.logout,"click",BX.proxy(this.logout,this));this.listenSeoAuth()},showBlockByAuth:function(){if(this.provider.HAS_AUTH){this.showBlockMain()}else{this.showBlockLogin()}},listenSeoAuth:function(){BX.addCustomEvent(window,"seo-client-auth-result",BX.proxy(this.onSeoAuth,this))},onSeoAuth:function(e){e.reload=false;this.getProvider()},logout:function(){this.showBlock("loading");this.request("logout",{},BX.delegate(function(e){this.provider=e;this.showBlockByAuth()},this))},getProvider:function(){this.showBlock("loading");this.request("getProvider",{},BX.delegate(function(e){this.provider=e;this.showBlockByAuth()},this))},showBlock:function(e){e=BX.type.isArray(e)?e:[e];var t="data-bx-ads-block";var i=this.containerNode.querySelectorAll("["+t+"]");i=BX.convert.nodeListToArray(i);i.forEach(function(i){var o=i.getAttribute(t);var n=BX.util.in_array(o,e);i.style.display=n?"block":"none"},this)},showBlockRefresh:function(){this.showBlock(["auth","refresh"])},showBlockLogin:function(){this.showBlock("login")},showBlockMain:function(){if(this.uiNodes.avatar){this.uiNodes.avatar.style["background-image"]="url("+this.provider.PROFILE.PICTURE+")"}if(this.uiNodes.name){this.uiNodes.name.innerText=this.provider.PROFILE.NAME}if(this.uiNodes.link){if(this.provider.PROFILE.LINK){this.uiNodes.link.setAttribute("href",this.provider.PROFILE.LINK)}else{this.uiNodes.link.removeAttribute("href")}}this.showBlock(["auth","main"]);this.loadSettings()},insertTemplateIntoNode:function(e,t,i){i=i||false;var o="template-crm-ads-dlg-"+e;var n=o+"-"+this.provider.TYPE;var s=BX(n);if(!s){s=BX(o)}var r=BX.create("div");r.innerHTML=s.innerHTML;if(!i){t.innerHTML=""}var a=BX.convert.nodeListToArray(r.children);a.forEach(function(e){t.appendChild(e)})},onResponse:function(e,t){if(!e.error){t.apply(this,[e.data])}},request:function(e,t,i){t.action=e;t.type=this.provider.TYPE;if(this.onRequest){this.onRequest.apply(this,[t,BX.delegate(function(e){this.onResponse(e,i)},this)])}else{this.sendActionRequest(e,t,function(e){this.onResponse(e,i)})}},sendActionRequest:function(e,t,i,o){i=i||null;o=o||BX.proxy(this.showErrorPopup,this);t=t||{};var n=this;BX.ajax.runComponentAction(this.componentName,e,{mode:"class",signedParameters:this.signedParameters,data:t}).then(function(e){var t=e.data||{};if(t.error){o.apply(n,[t])}else if(i){i.apply(n,[t])}},function(){var e={error:true,text:""};o.apply(n,[e])})},showErrorPopup:function(e){e=e||{};var t=e.text||this.mess.errorAction;var i=BX.PopupWindowManager.create("crm_ads_rtg_error",null,{autoHide:true,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500}});i.setButtons([new BX.PopupWindowButton({text:this.mess.dlgBtnClose,events:{click:function(){this.popupWindow.close()}}})]);i.setContent('<span class="crm-ads-rtg-warning-popup-alert">'+t+"</span>");i.show()},loader:{init:function(e){this.caller=e},change:function(e,t,i){e.style.display=i?"":"none";if(t){t.disabled=!t.options.length==0||i?false:true}},forAccount:function(e){this.change(this.caller.uiNodes.accountLoader,this.caller.uiNodes.account,e)},forAudience:function(e){this.caller.uiNodes.audience.forEach(function(t){this.change(t.loader,t.node,e)},this);if(this.caller.uiNodes.autoRemover.node){this.caller.uiNodes.autoRemover.node.style.display=e?"none":""}}},loadSettings:function(){var e=this.provider.TYPE;var t=this.provider.IS_SUPPORT_ACCOUNT;if(BX.util.in_array(e,this.loaded))return;this.loaded.push(e);if(this.uiNodes.account&&t){var i=function(){this.loadSettingsAudiences(this.uiNodes.account.value)};BX.bind(this.uiNodes.account,"change",i.bind(this));this.loadSettingsAccounts()}else{this.loadSettingsAudiences(null)}},loadSettingsAccounts:function(){this.loader.forAccount(true);this.request("getAccounts",{},BX.delegate(function(e){var t=e.map(function(e){return{caption:e.name,value:e.id,selected:e.id==this.accountId}},this);this.fillDropDownControl(this.uiNodes.account,t);this.loader.forAccount(false);if(t.length>0){var i=function(){BX.fireEvent(this.uiNodes.account,"change")};setTimeout(i.bind(this),150)}else{this.ShowErrorEmptyAudiences()}},this))},loadSettingsAudiences:function(e){var t={accountId:e||null};this.loader.forAudience(true);this.request("getAudiences",t,BX.delegate(function(e){var t=false;var i=[];var o={};var n=this.provider.IS_SUPPORT_MULTI_TYPE_CONTACTS;this.hasAudiences=false;e.forEach(function(e){var t={caption:e.name,value:e.id,selected:e.id==this.audienceId};i.push(t);var n=BX.clone(t);o=o||{};e.supportedContactTypes=e.supportedContactTypes||[];e.supportedContactTypes.forEach(function(e){o[e]=o[e]||[];if(this.audienceId){n.selected=n.value==this.audienceId[e]}o[e].push(n)},this)},this);if(!n){var s=false;for(var r in o){var a=this.uiNodes.audience.filter(function(e){return e.type==r});if(!a[0]){continue}this.fillDropDownControl(a[0].node,o[r]);var c=o[r].length>0;var d=o[r].filter(function(e){return e.selected}).length>0;a[0].checker.checked=d;a[0].node.disabled=!d;if(d)s=true;if(c)t=true}if(!s){this.uiNodes.audience.forEach(function(e){e.checker.checked=true})}}else{var u=this.uiNodes.audience[0].node;this.fillDropDownControl(u,i);if(u.options.length>0)t=true}this.hasAudiences=t;this.ShowErrorEmptyAudiences();this.loader.forAudience(false)},this))},ShowErrorEmptyAudiences:function(){this.uiNodes.errorNotFound.style.display=this.hasAudiences?"none":""},fillDropDownControl:function(e,t){t=t||[];e.innerHTML="";t.forEach(function(t){if(!t||!t.caption){return}var i=document.createElement("option");i.value=t.value;i.selected=!!t.selected;i.innerText=t.caption;e.appendChild(i)})}}}