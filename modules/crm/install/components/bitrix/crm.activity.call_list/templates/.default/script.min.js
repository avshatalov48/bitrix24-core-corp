(function(){var t="/bitrix/components/bitrix/crm.activity.call_list/ajax.php";var e=null;var i=function(t){this.node=t.node;this.callListId=t.callListId||0;this.webformId=t.webformId||0;this.webformSecCode=t.webformSecCode||"";this.allowEdit=t.allowEdit==true;this.gridId=t.gridId||"";this.lastGridUrl="";this.enableSavePopup=t.enableSavePopup==true;this.tabs=[];this._itemsState="idle";this._handleTabHeaderClickEvent=this._handleTabHeaderClick.bind(this);this.init();this.externalRequests={}};i.create=function(t){e=new i(t);return e};i.getLast=function(){return e};i.prototype.init=function(){var t=this;if(this.getNode("call-list-display")){this.setActiveTab("params")}var e=this.getNode("call-list-tab-header");if(e){var i=BX.findChildrenByClassName(e,"activity-call-list-display-tab");if(BX.type.isArray(i)){i.forEach(function(e){t.tabs.push(e.dataset.tabHeader)})}}this.bindEvents();BX.addCustomEvent(window,"Grid::beforeRequest",function(e,i){i.url=BX.util.add_url_param(i.url,{sessid:BX.bitrix_sessid(),ajax_action:"GET_ITEMS_GRID",callListId:t.callListId,allowEdit:t.allowEdit?"Y":"N"});t.lastGridUrl=i.url});BX.addCustomEvent(window,"onLocalStorageSet",this._OnExternalEvent.bind(this))};i.prototype.reInit=function(){var t=this;this.tabs=[];this._itemsState="idle";var e=this.getNode("call-list-tab-header");if(e){var i=BX.findChildrenByClassName(e,"activity-call-list-display-tab");if(BX.type.isArray(i)){i.forEach(function(e){t.tabs.push(e.dataset.tabHeader)})}}this.bindEvents()};i.prototype.bindEvents=function(){var t=this;var e=this.getNode("call-list-tab-header");if(e){var i=BX.findChildren(e,{className:"activity-call-list-display-tab"});if(BX.type.isArray(i)){i.forEach(function(e){BX.bind(e,"click",t._handleTabHeaderClickEvent)})}}var a=this.getNode("create-from-leads");if(a)BX.bind(a,"click",t._handleCreateFromClick.bind(t));var r=this.getNode("create-from-contacts");if(r)BX.bind(r,"click",t._handleCreateFromClick.bind(t));var s=this.getNode("create-from-companies");if(s)BX.bind(s,"click",t._handleCreateFromClick.bind(t));var l=this.getNode("create-from-deals");if(l)BX.bind(l,"click",t._handleCreateFromClick.bind(t));var o=this.getNode("create-from-quotes");if(o)BX.bind(o,"click",t._handleCreateFromClick.bind(t));var n=this.getNode("create-from-invoices");if(n)BX.bind(n,"click",t._handleCreateFromClick.bind(t));var d=this.getNode("add-more");if(d)BX.bind(d,"click",t._handleAddMore.bind(t));var c=this.getNode("invoke-call-interface",document);if(c){BX.bind(c,"click",function(e){if(!top.BXIM)return false;if(top.BX.Bitrix24&&top.BX.Bitrix24.Slider){top.BX.Bitrix24.Slider.closeAll()}else{for(dialogId in top.BX.CrmActivityProvider.dialogs){if(top.BX.CrmActivityProvider.dialogs.hasOwnProperty(dialogId)&&top.BX.CrmActivityProvider.dialogs[dialogId]){top.BX.CrmActivityProvider.dialogs[dialogId].close()}}}if(top.BX.FoldedCallView)top.BX.FoldedCallView.getInstance().destroy();top.BXIM.startCallList(t.callListId,{webformId:t.webformId,webformSecCode:t.webformSecCode})})}var u=this.getNode("open-filter");if(u){BX.bind(u,"click",t._handleOpenFilterClick.bind(t))}var h=BX.Crm.Activity.Planner.Manager.getLast();if(h){BX.addCustomEvent(h,"onAfterActivitySave",this._onAfterActivitySave.bind(this))}BX.addCustomEvent(window,"onActivityEditorClose",this._onPlannerClose.bind(this))};i.prototype.getNode=function(t,e){if(!e)e=this.node;return e?e.querySelector('[data-role="'+t+'"]'):null};i.prototype.getNodeValue=function(t,e){if(!e)e=this.node;var i=e?e.querySelector('[data-role="'+t+'"]'):null;return i?i.value:""};i.prototype.getTab=function(t,e){if(!e)e=this.node;return e?e.querySelector('[data-tab="'+t+'"]'):null};i.prototype.getTabHeader=function(t,e){if(!e)e=this.node;return e?e.querySelector('[data-tab-header="'+t+'"]'):null};i.prototype.setActiveTab=function(t){var e=this;this.tabs.forEach(function(i){if(i===t){BX.removeClass(e.getTab(i),"activity-call-list-display-hidden");BX.addClass(e.getTabHeader(i),"activity-call-list-display-tab-active");BX.removeClass(e.getTabHeader(i),"activity-call-list-display-tab-inactive")}else{BX.addClass(e.getTab(i),"activity-call-list-display-hidden");BX.removeClass(e.getTabHeader(i),"activity-call-list-display-tab-active");BX.addClass(e.getTabHeader(i),"activity-call-list-display-tab-inactive")}});if(t==="grid"){this.showItemsGrid()}};i.prototype.showItemsGrid=function(){var t=this;var e=this.getNode("grid-container");if(t._itemsState==="idle"){t._itemsState="loading";t._loadItemsGrid(function(i){t._itemsState="loaded";e.innerHTML=i})}};i.prototype._loadItemsGrid=function(e){var i={sessid:BX.bitrix_sessid(),ajax_action:"GET_ITEMS_GRID",callListId:this.callListId,allowEdit:this.allowEdit?"Y":"N"};BX.ajax({method:"POST",dataType:"html",url:t,data:i,onsuccess:function(t){e(t)}})};i.prototype._reloadLayout=function(){var e=this;var i=this.getNodeValue("call-list-subject");var a=this.getNodeValue("call-list-description");var r={sessid:BX.bitrix_sessid(),ajax_action:"RELOAD",callListId:this.callListId,subject:i,description:a};BX.ajax({method:"POST",dataType:"html",url:t,data:r,onsuccess:function(t){e.node.outerHTML=t;e.node=BX("activity-call-list");e.reInit();e.getNode("call-list-subject").value=i;e.getNode("call-list-description").value=a}})};i.prototype._handleTabHeaderClick=function(t){var e=t.target.dataset.tabHeader;this.setActiveTab(e)};i.prototype._handleOpenFilterClick=function(e){var i={sessid:BX.bitrix_sessid(),ajax_action:"APPLY_ORIGINAL_FILTER",callListId:this.callListId};BX.ajax({method:"POST",dataType:"json",url:t,data:i,onsuccess:function(t){if(t.SUCCESS){var e=t.DATA;if(e.LIST_URL){window.open(e.LIST_URL)}}}})};i.prototype._handleCreateFromClick=function(t){var e=this._generateExternalContext();var i=t.target.dataset.url;this.externalRequests[e]={context:e,window:window.open(BX.util.add_url_param(i,{call_list_context:e,call_list_id:this.callListId}))}};i.prototype._handleAddMore=function(t){var e=this._generateExternalContext();var i=t.target.dataset.url;this.externalRequests[e]={context:e,window:window.open(BX.util.add_url_param(i,{call_list_context:e,call_list_id:this.callListId}))}};i.prototype._OnExternalEvent=function(t){t=BX.type.isPlainObject(t)?t:{};t.key=t.key||"";var e=t.value||{};if(t.key==="onCrmCallListUpdate"&&this.externalRequests[e.context]){var i=this.getGrid();if(i){this.reloadGrid()}else{this._reloadLayout()}if(this.externalRequests[e.context]["window"])this.externalRequests[e.context]["window"].close();delete this.externalRequests[e.context]}};i.prototype._onAfterActivitySave=function(t){if(!t.NEW||t.NEW=="N")return;if(!this.enableSavePopup)return;var e=new BX.PopupWindow("call_list_activity_created",null,{autoHide:true,overlay:false,lightShadow:true,closeIcon:true,closeByEsc:true,contentColor:"white",titleBar:BX.message("CRM_ACTIVITY_CALL_LIST_ACTIVITY_CREATED"),content:BX.create("span",{props:{className:"crm-activity-call-list-success-text"},text:BX.message("CRM_ACTIVITY_CALL_LIST_ACTIVITY_CREATED_TEXT")}),buttons:[new BX.PopupWindowButton({text:BX.message("CRM_ACTIVITY_CALL_LIST_ACTIVITY_GOTO"),events:{click:function(){if(t.VIEW_URL){e.close();window.open(t.VIEW_URL)}}}})],events:{onPopupClose:function(){e.destroy()}}});e.show()};i.prototype._onPlannerClose=function(){BX.Main.gridManager.destroy(this.gridId)};i.prototype.deleteItems=function(e){var i=this;if(!BX.type.isArray(e))return;var a={sessid:BX.bitrix_sessid(),ajax_action:"DELETE_ITEMS",callListId:this.callListId,items:e};BX.ajax({method:"POST",dataType:"json",url:t,data:a,onsuccess:function(t){if(t.SUCCESS){i.reloadGrid()}}})};i.prototype.deleteSelected=function(){var t=this.getGrid();if(!t)return false;var e=t.getRows().getSelectedIds();if(!BX.type.isArray(e))return false;this.deleteItems(e)};i.prototype.getGrid=function(){var t;if(BX&&BX.Main&&BX.Main.gridManager){t=BX.Main.gridManager.getById(this.gridId)}return t?t.instance:null};i.prototype.reloadGrid=function(){var e=this.lastGridUrl!=""?this.lastGridUrl:t;var i=this.getGrid();if(!i)return false;i.reload(e);return true};i.prototype._generateExternalContext=function(){return this._getRandomString(16)};i.prototype._getRandomString=function(t){charSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";var e="";for(var i=0;i<t;i++){var a=Math.floor(Math.random()*charSet.length);e+=charSet.substring(a,a+1)}return e};i.prototype.destroy=function(){BX.Main.gridManager.destroy(gridId)};BX.CallListActivity=i})();
//# sourceMappingURL=script.map.js