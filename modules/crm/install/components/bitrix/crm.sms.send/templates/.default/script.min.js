(function(e,t){"use strict";var i=t.Reflection.namespace("BX.Crm.Component");var s=function(){function e(t){babelHelpers.classCallCheck(this,e);this._senderId=null;this._from=null;this._commEntityTypeId=null;this._commEntityId=null;this._to=null;this._fromList=[];this._toList=[];this._input=null;this._menu=null;this._isMenuShown=false;this._shownMenuId=null;this._canUse=null;this._canSendMessage=null;this._manageUrl=null;this._senders=null;this._defaults=null;this._communications=null;this._container=t;this._isRequestRunning=false;this._isSenderFixed=false;this.saveButton=null;this.cancelButton=null;this._serviceUrl="";this._ownerTypeId="";this._ownerId=""}babelHelpers.createClass(e,[{key:"init",value:function e(t){this._canUse=BX.prop.getBoolean(t,"canUse",false);this._canSendMessage=BX.prop.getBoolean(t,"canSendMessage",false);this._manageUrl=BX.prop.getString(t,"manageUrl","");this._senders=BX.prop.getArray(t,"senders",[]);this._defaults=BX.prop.getObject(t,"defaults",{senderId:null,from:null});this._communications=BX.prop.getArray(t,"communications",[]);this._serviceUrl=BX.prop.getString(t,"serviceUrl","");this._ownerTypeId=BX.prop.getInteger(t,"ownerTypeId",0);this._ownerId=BX.prop.getInteger(t,"ownerId",0);this._senderId=BX.prop.getString(t,"providerId");this._isSenderFixed=BX.prop.getBoolean(t,"isProviderFixed",false);this._title=this._container.querySelector('[data-role="sender-title"]');this._senderContainerNode=this._container.querySelector('[data-role="sender-container"]');this._senderSelectorNode=this._container.querySelector('[data-role="sender-selector"]');this._senderSelectorBlockNode=this._container.querySelector('[data-role="sender-selector-block"]');this._fromContainerNode=this._container.querySelector('[data-role="from-container"]');this._fromSelectorNode=this._container.querySelector('[data-role="from-selector"]');this._clientContainerNode=this._container.querySelector('[data-role="client-container"]');this._clientSelectorNode=this._container.querySelector('[data-role="client-selector"]');this._toSelectorNode=this._container.querySelector('[data-role="to-selector"]');this._messageLengthCounterNode=this._container.querySelector('[data-role="message-length-counter"]');this._input=this._container.querySelector('[data-role="input"]');this.saveButton=this._container.querySelector('[data-role="button-save"]');this.cancelButton=this._container.querySelector('[data-role="button-cancel"]');if(this._canUse&&this._canSendMessage){this.initSenderSelector();this.initFromSelector();this.initClientContainer();this.initClientSelector();this.initToSelector();this.initMessageLengthCounter();this.initButtons();this.setMessageLengthCounter()}}},{key:"switchToFixedSenderAppearance",value:function e(i){this.setSender(i);var s=document.querySelector(".ui-side-panel-wrap-below");if(s){s.classList.add("crm-sms-send-subtitle");s.innerHTML=t.Loc.getMessage("CRM_SMS_SEND_SENDER_SUBTITLE",{"#SENDER#":'<span class="crm-sms-send-subtitle-sender">'+i.name+"</span>"})}this._senderSelectorBlockNode.style.display="none";this._senderContainerNode.style.display="inline";this._clientContainerNode.style.display="inline"}},{key:"initSenderSelector",value:function e(){var i;var s=(i=this._senderId)!==null&&i!==void 0?i:this._defaults.senderId;var n=this._senders[0].canUse?this._senders[0]:null;var o=null;var r=[];var l=this.onSenderSelectorClick.bind(this);for(var a=0;a<this._senders.length;++a){if(this._senders[a].canUse&&this._senders[a].fromList.length&&(this._senders[a].id===s||!n)){n=this._senders[a]}if(this._senders[a].id==="rest"){o=this._senders[a];continue}r.push({text:this._senders[a].name,sender:this._senders[a],onclick:l,className:!this._senders[a].canUse||!this._senders[a].fromList.length?"crm-sms-send-popup-menu-item-disabled menu-popup-no-icon":""})}if(n&&this._isSenderFixed){this.switchToFixedSenderAppearance(n);return}if(o){if(o.fromList.length>0){r.push({delimiter:true});for(var h=0;h<o.fromList.length;++h){r.push({text:o.fromList[h].name,sender:o,from:o.fromList[h],onclick:l})}}r.push({delimiter:true},{text:t.Loc.getMessage("CRM_SMS_REST_MARKETPLACE"),href:"/marketplace/category/crm_robot_sms/",target:"_blank"})}if(n){this.setSender(n)}BX.bind(this._senderSelectorNode,"click",this.openMenu.bind(this,"sender",this._senderSelectorNode,r))}},{key:"onSenderSelectorClick",value:function e(t,i){if(i.sender){if(!i.sender.canUse||!i.sender.fromList.length){window.open(i.sender.manageUrl);return}this.setSender(i.sender,true);var s=i.from?i.from:i.sender.fromList[0];this.setFrom(s,true)}this._menu.close()}},{key:"setSender",value:function e(t,i){this._senderId=t.id;this._fromList=t.fromList;this._senderSelectorNode.textContent=t.shortName?t.shortName:t.name;var s=t.id==="rest"?"hide":"show";BX[s](this._fromContainerNode);if(i){BX.userOptions.save("crm","sms_manager_editor","senderId",this._senderId)}}},{key:"initFromSelector",value:function e(){if(this._fromList.length>0){var t=this._defaults.from||this._fromList[0].id;var i=null;for(var s=0;s<this._fromList.length;++s){if(this._fromList[s].id===t||!i){i=this._fromList[s]}}if(i){this.setFrom(i)}}BX.bind(this._fromSelectorNode,"click",this.onFromSelectorClick.bind(this))}},{key:"onFromSelectorClick",value:function e(t){var i=[];var s=this.onFromSelectorItemClick.bind(this);for(var n=0;n<this._fromList.length;++n){i.push({text:this._fromList[n].name,from:this._fromList[n],onclick:s})}this.openMenu("from_"+this._senderId,this._fromSelectorNode,i,t)}},{key:"onFromSelectorItemClick",value:function e(t,i){if(i.from){this.setFrom(i.from,true)}this._menu.close()}},{key:"setFrom",value:function e(t,i){this._from=t.id;if(this._senderId==="rest"){this._senderSelectorNode.textContent=t.name}else{this._fromSelectorNode.textContent=t.name}if(i){BX.userOptions.save("crm","sms_manager_editor","from",this._from)}}},{key:"initClientContainer",value:function e(){if(this._communications.length===0){BX.hide(this._clientContainerNode)}}},{key:"initClientSelector",value:function e(){var t=[];var i=this.onClientSelectorClick.bind(this);for(var s=0;s<this._communications.length;++s){t.push({text:this._communications[s].caption,client:this._communications[s],onclick:i});if(s===0){this.setClient(this._communications[s])}}BX.bind(this._clientSelectorNode,"click",this.openMenu.bind(this,"comm",this._clientSelectorNode,t))}},{key:"onClientSelectorClick",value:function e(t,i){if(i.client){this.setClient(i.client)}this._menu.close()}},{key:"setClient",value:function e(t){this._commEntityTypeId=t.entityTypeId;this._commEntityId=t.entityId;this._clientSelectorNode.textContent=t.caption;this._toList=t.phones;this.setTo(t.phones[0])}},{key:"initToSelector",value:function e(){BX.bind(this._toSelectorNode,"click",this.onToSelectorClick.bind(this))}},{key:"onToSelectorClick",value:function e(t){var i=[];var s=this.onToSelectorItemClick.bind(this);for(var n=0;n<this._toList.length;++n){i.push({text:this._toList[n].valueFormatted||this._toList[n].value,to:this._toList[n],onclick:s})}this.openMenu("to_"+this._commEntityTypeId+"_"+this._commEntityId,this._toSelectorNode,i,t)}},{key:"onToSelectorItemClick",value:function e(t,i){if(i.to){this.setTo(i.to)}this._menu.close()}},{key:"setTo",value:function e(t){this._to=t.value;this._toSelectorNode.textContent=t.valueFormatted||t.value}},{key:"openMenu",value:function e(t,i,s,n){if(this._shownMenuId===t){return}if(this._shownMenuId!==null&&this._menu){this._menu.close();this._shownMenuId=null}BX.PopupMenu.show(this._id+t,i,s,{offsetTop:0,offsetLeft:36,angle:{position:"top",offset:0},events:{onPopupClose:this.onMenuClose.bind(this)}});this._menu=BX.PopupMenu.currentItem;n.preventDefault()}},{key:"onMenuClose",value:function e(){this._shownMenuId=null;this._menu=null}},{key:"initMessageLengthCounter",value:function e(){this._messageLengthMax=parseInt(this._messageLengthCounterNode.getAttribute("data-length-max"));BX.bind(this._input,"keyup",this.setMessageLengthCounter.bind(this))}},{key:"setMessageLengthCounter",value:function e(){var t=this._input.value.length;this._messageLengthCounterNode.textContent=t;var i=t>=this._messageLengthMax?"addClass":"removeClass";BX[i](this._messageLengthCounterNode,"sms-symbol-counter-number-overhead")}},{key:"initButtons",value:function e(){BX.bind(this.saveButton,"click",this.save.bind(this));BX.bind(this.cancelButton,"click",this.cancel.bind(this))}},{key:"save",value:function e(){var i=this._input.value;if(i===""){return}if(!this._communications.length){alert(t.Loc.getMessage("CRM_SMS_ERROR_NO_COMMUNICATIONS"));return}if(this._isRequestRunning){return}this._isRequestRunning=true;BX.ajax({url:BX.util.add_url_param(this._serviceUrl,{action:"save_sms_message",sender:this._senderId}),method:"POST",dataType:"json",data:{site:t.Loc.getMessage("SITE_ID"),sessid:BX.bitrix_sessid(),ACTION:"SAVE_SMS_MESSAGE",SENDER_ID:this._senderId,MESSAGE_FROM:this._from,MESSAGE_TO:this._to,MESSAGE_BODY:i,OWNER_TYPE_ID:this._ownerTypeId,OWNER_ID:this._ownerId,TO_ENTITY_TYPE_ID:this._commEntityTypeId,TO_ENTITY_ID:this._commEntityId},onsuccess:this.onSaveSuccess.bind(this),onfailure:this.onSaveFailure.bind(this)})}},{key:"cancel",value:function e(){if(BX.SidePanel){var t=BX.SidePanel.Instance.getSliderByWindow(window);if(t){t.close()}}}},{key:"onSaveSuccess",value:function e(t){this._isRequestRunning=false;var i=BX.prop.getString(t,"ERROR","");if(i!==""){alert(i);return}this.cancel()}},{key:"onSaveFailure",value:function e(t){this._isRequestRunning=false}}]);return e}();i.CrmSmsSend=s})(this.window=this.window||{},BX);
//# sourceMappingURL=script.map.js