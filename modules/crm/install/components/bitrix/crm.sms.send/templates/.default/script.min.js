if(typeof BX.CrmSmsSend==="undefined"){BX.CrmSmsSend=function(e){this._senderId=null;this._from=null;this._commEntityTypeId=null;this._commEntityId=null;this._to=null;this._fromList=[];this._toList=[];this._input=null;this._menu=null;this._isMenuShown=false;this._shownMenuId=null;this._canUse=null;this._canSendMessage=null;this._manageUrl=null;this._senders=null;this._defaults=null;this._communications=null;this._container=e;this._isRequestRunning=false;this.saveButton=null;this.cancelButton=null;this._serviceUrl="";this._ownerTypeId="";this._ownerId=""};BX.CrmSmsSend.prototype.init=function(e){this._canUse=BX.prop.getBoolean(e,"canUse",false);this._canSendMessage=BX.prop.getBoolean(e,"canSendMessage",false);this._manageUrl=BX.prop.getString(e,"manageUrl","");this._senders=BX.prop.getArray(e,"senders",[]);this._defaults=BX.prop.getObject(e,"defaults",{senderId:null,from:null});this._communications=BX.prop.getArray(e,"communications",[]);this._serviceUrl=BX.prop.getString(e,"serviceUrl","");this._ownerTypeId=BX.prop.getInteger(e,"ownerTypeId",0);this._ownerId=BX.prop.getInteger(e,"ownerId",0);this._senderSelectorNode=this._container.querySelector('[data-role="sender-selector"]');this._fromContainerNode=this._container.querySelector('[data-role="from-container"]');this._fromSelectorNode=this._container.querySelector('[data-role="from-selector"]');this._clientContainerNode=this._container.querySelector('[data-role="client-container"]');this._clientSelectorNode=this._container.querySelector('[data-role="client-selector"]');this._toSelectorNode=this._container.querySelector('[data-role="to-selector"]');this._messageLengthCounterNode=this._container.querySelector('[data-role="message-length-counter"]');this._input=this._container.querySelector('[data-role="input"]');this.saveButton=this._container.querySelector('[data-role="button-save"]');this.cancelButton=this._container.querySelector('[data-role="button-cancel"]');if(this._canUse&&this._canSendMessage){this.initSenderSelector();this.initFromSelector();this.initClientContainer();this.initClientSelector();this.initToSelector();this.initMessageLengthCounter();this.initButtons();this.setMessageLengthCounter()}};BX.CrmSmsSend.prototype.initSenderSelector=function(){var e=this._defaults.senderId;var t=this._senders[0].canUse?this._senders[0]:null;var n=null;var s=[];var i=this.onSenderSelectorClick.bind(this);for(var o=0;o<this._senders.length;++o){if(this._senders[o].canUse&&this._senders[o].fromList.length&&(this._senders[o].id===e||!t)){t=this._senders[o]}if(this._senders[o].id==="rest"){n=this._senders[o];continue}s.push({text:this._senders[o].name,sender:this._senders[o],onclick:i,className:!this._senders[o].canUse||!this._senders[o].fromList.length?"crm-sms-send-popup-menu-item-disabled menu-popup-no-icon":""})}if(n){if(n.fromList.length>0){s.push({delimiter:true});for(o=0;o<n.fromList.length;++o){s.push({text:n.fromList[o].name,sender:n,from:n.fromList[o],onclick:i})}}s.push({delimiter:true},{text:BX.message("CRM_SMS_REST_MARKETPLACE"),href:"/marketplace/category/crm_robot_sms/",target:"_blank"})}if(t){this.setSender(t)}BX.bind(this._senderSelectorNode,"click",this.openMenu.bind(this,"sender",this._senderSelectorNode,s))};BX.CrmSmsSend.prototype.onSenderSelectorClick=function(e,t){if(t.sender){if(!t.sender.canUse||!t.sender.fromList.length){window.open(t.sender.manageUrl);return}this.setSender(t.sender,true);var n=t.from?t.from:t.sender.fromList[0];this.setFrom(n,true)}this._menu.close()};BX.CrmSmsSend.prototype.setSender=function(e,t){this._senderId=e.id;this._fromList=e.fromList;this._senderSelectorNode.textContent=e.shortName?e.shortName:e.name;var n=e.id==="rest"?"hide":"show";BX[n](this._fromContainerNode);if(t){BX.userOptions.save("crm","sms_manager_editor","senderId",this._senderId)}};BX.CrmSmsSend.prototype.initFromSelector=function(){if(this._fromList.length>0){var e=this._defaults.from||this._fromList[0].id;var t=null;for(var n=0;n<this._fromList.length;++n){if(this._fromList[n].id===e||!t){t=this._fromList[n]}}if(t){this.setFrom(t)}}BX.bind(this._fromSelectorNode,"click",this.onFromSelectorClick.bind(this))};BX.CrmSmsSend.prototype.onFromSelectorClick=function(e){var t=[];var n=this.onFromSelectorItemClick.bind(this);for(var s=0;s<this._fromList.length;++s){t.push({text:this._fromList[s].name,from:this._fromList[s],onclick:n})}this.openMenu("from_"+this._senderId,this._fromSelectorNode,t,e)};BX.CrmSmsSend.prototype.onFromSelectorItemClick=function(e,t){if(t.from){this.setFrom(t.from,true)}this._menu.close()};BX.CrmSmsSend.prototype.setFrom=function(e,t){this._from=e.id;if(this._senderId==="rest"){this._senderSelectorNode.textContent=e.name}else{this._fromSelectorNode.textContent=e.name}if(t){BX.userOptions.save("crm","sms_manager_editor","from",this._from)}};BX.CrmSmsSend.prototype.initClientContainer=function(){if(this._communications.length===0){BX.hide(this._clientContainerNode)}};BX.CrmSmsSend.prototype.initClientSelector=function(){var e=[];var t=this.onClientSelectorClick.bind(this);for(var n=0;n<this._communications.length;++n){e.push({text:this._communications[n].caption,client:this._communications[n],onclick:t});if(n===0){this.setClient(this._communications[n])}}BX.bind(this._clientSelectorNode,"click",this.openMenu.bind(this,"comm",this._clientSelectorNode,e))};BX.CrmSmsSend.prototype.onClientSelectorClick=function(e,t){if(t.client){this.setClient(t.client)}this._menu.close()};BX.CrmSmsSend.prototype.setClient=function(e){this._commEntityTypeId=e.entityTypeId;this._commEntityId=e.entityId;this._clientSelectorNode.textContent=e.caption;this._toList=e.phones;this.setTo(e.phones[0])};BX.CrmSmsSend.prototype.initToSelector=function(){BX.bind(this._toSelectorNode,"click",this.onToSelectorClick.bind(this))};BX.CrmSmsSend.prototype.onToSelectorClick=function(e){var t=[];var n=this.onToSelectorItemClick.bind(this);for(var s=0;s<this._toList.length;++s){t.push({text:this._toList[s].valueFormatted||this._toList[s].value,to:this._toList[s],onclick:n})}this.openMenu("to_"+this._commEntityTypeId+"_"+this._commEntityId,this._toSelectorNode,t,e)};BX.CrmSmsSend.prototype.onToSelectorItemClick=function(e,t){if(t.to){this.setTo(t.to)}this._menu.close()};BX.CrmSmsSend.prototype.setTo=function(e){this._to=e.value;this._toSelectorNode.textContent=e.valueFormatted||e.value};BX.CrmSmsSend.prototype.openMenu=function(e,t,n,s){if(this._shownMenuId===e){return}if(this._shownMenuId!==null&&this._menu){this._menu.close();this._shownMenuId=null}BX.PopupMenu.show(this._id+e,t,n,{offsetTop:0,offsetLeft:36,angle:{position:"top",offset:0},events:{onPopupClose:BX.delegate(this.onMenuClose,this)}});this._menu=BX.PopupMenu.currentItem;s.preventDefault()};BX.CrmSmsSend.prototype.onMenuClose=function(){this._shownMenuId=null;this._menu=null};BX.CrmSmsSend.prototype.initMessageLengthCounter=function(){this._messageLengthMax=parseInt(this._messageLengthCounterNode.getAttribute("data-length-max"));BX.bind(this._input,"keyup",this.setMessageLengthCounter.bind(this))};BX.CrmSmsSend.prototype.setMessageLengthCounter=function(){var e=this._input.value.length;this._messageLengthCounterNode.textContent=e;var t=e>=this._messageLengthMax?"addClass":"removeClass";BX[t](this._messageLengthCounterNode,"sms-symbol-counter-number-overhead")};BX.CrmSmsSend.prototype.initButtons=function(){BX.bind(this.saveButton,"click",this.save.bind(this));BX.bind(this.cancelButton,"click",this.cancel.bind(this))};BX.CrmSmsSend.prototype.save=function(){var e=this._input.value;if(e===""){return}if(!this._communications.length){alert(BX.message("CRM_SMS_ERROR_NO_COMMUNICATIONS"));return}if(this._isRequestRunning){return}this._isRequestRunning=true;BX.ajax({url:BX.util.add_url_param(this._serviceUrl,{action:"save_sms_message",sender:this._senderId}),method:"POST",dataType:"json",data:{site:BX.message("SITE_ID"),sessid:BX.bitrix_sessid(),ACTION:"SAVE_SMS_MESSAGE",SENDER_ID:this._senderId,MESSAGE_FROM:this._from,MESSAGE_TO:this._to,MESSAGE_BODY:e,OWNER_TYPE_ID:this._ownerTypeId,OWNER_ID:this._ownerId,TO_ENTITY_TYPE_ID:this._commEntityTypeId,TO_ENTITY_ID:this._commEntityId},onsuccess:BX.delegate(this.onSaveSuccess,this),onfailure:BX.delegate(this.onSaveFailure,this)})};BX.CrmSmsSend.prototype.cancel=function(){if(BX.SidePanel){var e=BX.SidePanel.Instance.getSliderByWindow(window);if(e){e.close()}}};BX.CrmSmsSend.prototype.onSaveSuccess=function(e){this._isRequestRunning=false;var t=BX.prop.getString(e,"ERROR","");if(t!==""){alert(t);return}this.cancel()};BX.CrmSmsSend.prototype.onSaveFailure=function(e){this._isRequestRunning=false}}