BX.CrmConfigStatusClass=function(){var t=function(t){this.randomString=t.randomString;this.tabs=t.tabs;this.ajaxUrl=t.ajaxUrl;this.data=t.data;this.oldData=BX.clone(this.data);this.max_sort={};this.requestIsRunning=false;this.totalNumberFields=t.totalNumberFields;this.checkSubmit=false;this.defaultColors=["#39A8EF","#2FC6F6","#55D0E0","#47E4C2","#FFA900"];this.defaultFinalSuccessColor="#7BD500";this.defaultFinalUnSuccessColor="#FF5752";this.defaultLineColor="#D3EEF9";this.textColorLight="#FFF";this.textColorDark="#545C69";this.entityId=t.entityId;this.hasSemantics=!!t.hasSemantics;this.jsClass="CrmConfigStatusClass_"+t.randomString;this.contentIdPrefix="content_";this.contentClass="crm-status-content";this.contentActiveClass="crm-status-content active";this.fieldNameIdPrefix="field-name-";this.fieldEditNameIdPrefix="field-edit-name-";this.fieldHiddenNameIdPrefix="field-hidden-name-";this.spanStoringNameIdPrefix="field-title-inner-";this.mainDivStorageFieldIdPrefix="field-phase-";this.fieldSortHiddenIdPrefix="field-sort-";this.fieldHiddenNumberIdPrefix="field-number-";this.extraStorageFieldIdPrefix="extra-storage-";this.finalSuccessStorageFieldIdPrefix="final-success-storage-";this.finalStorageFieldIdPrefix="final-storage-";this.previouslyScaleIdPrefix="previously-scale-";this.previouslyScaleNumberIdPrefix="previously-scale-number-";this.previouslyScaleFinalSuccessIdPrefix="previously-scale-final-success-";this.previouslyScaleNumberFinalSuccessIdPrefix="previously-scale-number-final-success-";this.previouslyScaleFinalUnSuccessIdPrefix="previously-scale-final-un-success-";this.previouslyScaleNumberFinalUnSuccessIdPrefix="previously-scale-number-final-un-success-";this.previouslyScaleFinalCellIdPrefix="previously-scale-final-cell-";this.previouslyScaleNumberFinalCellIdPrefix="previously-scale-number-final-cell-";this.funnelSuccessIdPrefix="config-funnel-success-";this.funnelUnSuccessIdPrefix="config-funnel-unsuccess-";this.successFields=t.successFields;this.unSuccessFields=t.unSuccessFields;this.initialFields=t.initialFields;this.extraFields=t.extraFields;this.finalFields=t.finalFields;this.extraFinalFields=t.extraFinalFields;this.dataFunnel=[];this.colorFunnel=[];this.initAmChart=false;this.footer=BX("crm-configs-footer");this.windowSize={};this.scrollPosition={};this.contentPosition={};this.footerPosition={};this.limit=0;this.footerFixed=true;this.blockFixed=!!t.blockFixed;this.dragStartParentElement=null;this.initAmCharts();this.showError();this.init()};t.prototype.selectTab=function(e){var i=BX(this.contentIdPrefix+e);if(i.className==this.contentActiveClass)return;for(var s=0,a=this.tabs.length;s<a;s++){var n=BX(this.contentIdPrefix+this.tabs[s]);if(n.className==this.contentActiveClass){this.showTab(this.tabs[s],false);n.className=this.contentClass;break}}this.showTab(e,true);i.className=this.contentActiveClass;BX("ACTIVE_TAB").value="status_tab_"+e;this.entityId=e;this.hasSemantics=t.hasSemantics(this.entityId);this.processingFooter();if(this.hasSemantics){AmCharts.handleLoad()}};t.prototype.showTab=function(t,e){var i=e?"status_tab_active":"";BX("status_tab_"+t).className="status_tab "+i};t.prototype.statusReset=function(){BX("ACTION").value="reset";document.forms["crmStatusForm"].submit()};t.prototype.recoveryName=function(t,e){var i=this.searchElement("input",this.fieldHiddenNumberIdPrefix+t),s=this.searchElement("span",this.fieldNameIdPrefix+t),a=this.searchElement("input",this.fieldHiddenNameIdPrefix+t);s.innerHTML=BX.util.htmlspecialchars(i.value+". "+e);a.value=e;this.data[this.entityId][t].NAME=e;if(this.initAmChart){this.recalculateSort()}};t.prototype.editField=function(t){var e,i=this.searchElement("div",this.mainDivStorageFieldIdPrefix+t),s=this.searchElement("span",this.spanStoringNameIdPrefix+t),a=this.searchElement("span",this.fieldNameIdPrefix+t),n=this.searchElement("input",this.fieldHiddenNameIdPrefix+t);if(!n){return}e=BX.create("span",{props:{className:"transaction-stage-phase-title-input-container"},children:[BX.create("input",{props:{id:this.fieldEditNameIdPrefix+t},attrs:{type:"text",value:n.value,onkeydown:'if (event.keyCode==13) {BX["'+this.jsClass+"\"].saveFieldValue('"+t+"', this);}",onblur:'BX["'+this.jsClass+"\"].saveFieldValue('"+t+"', this);","data-onblur":"1"}})]});s.style.width="100%";i.setAttribute("ondblclick","");a.innerHTML="";a.appendChild(e);var r=this.searchElement("input",this.fieldEditNameIdPrefix+t);r.focus();r.selectionStart=BX(this.fieldEditNameIdPrefix+t+"").value.length};t.prototype.openPopupBeforeDeleteField=function(t){if(isNaN(parseInt(t))){this.deleteField(t);return}BX.ajax({url:this.ajaxUrl,method:"POST",dataType:"json",data:{ACTION:"CHECK_ENTITY_EXISTENCE",ENTITY_ID:this.entityId,FIELD_ID:t},onsuccess:BX.delegate(function(e){if(e.ERROR){var i=new BX.PopupWindow({titleBar:e.TITLE,closeIcon:true,autoHide:true,closeByEsc:true,content:e.ERROR,width:400,buttons:[new BX.PopupWindowButton({text:BX.message("CRM_STATUS_CLOSE_POPUP_REMOVE_ERROR"),className:"popup-window-button popup-window-button-link "+"popup-window-button-link-cancel",events:{click:function(){i.close()}.bind(this)}})]});i.show()}else{this.deleteField(t)}},this)})};t.prototype.deleteField=function(t){var e=this.searchElement("div",this.mainDivStorageFieldIdPrefix+t),i=e.parentNode;var s=BX.create("input",{attrs:{type:"hidden",value:t,name:"LIST["+this.entityId+"][REMOVE]["+t+"][FIELD_ID]"}});BX(this.contentIdPrefix+this.entityId).appendChild(s);i.removeChild(e);this.recalculateSort()};t.prototype.modalWindow=function(t){t=t||{};t.title=t.title||false;t.bindElement=t.bindElement||null;t.overlay=typeof t.overlay=="undefined"?true:t.overlay;t.autoHide=t.autoHide||false;t.closeIcon=typeof t.closeIcon=="undefined"?{right:"20px",top:"10px"}:t.closeIcon;t.modalId=t.modalId||"crm"+(Math.random()*(2e5-100)+100);t.withoutContentWrap=typeof t.withoutContentWrap=="undefined"?false:t.withoutContentWrap;t.contentClassName=t.contentClassName||"";t.contentStyle=t.contentStyle||{};t.content=t.content||[];t.buttons=t.buttons||false;t.events=t.events||{};t.withoutWindowManager=!!t.withoutWindowManager||false;var e=[];if(t.title){e.push(BX.create("div",{props:{className:"bx-crm-popup-title"},text:t.title}))}if(t.withoutContentWrap){e=e.concat(t.content)}else{e.push(BX.create("div",{props:{className:"bx-crm-popup-content "+t.contentClassName},style:t.contentStyle,children:t.content}))}var i=[];if(t.buttons){for(var s in t.buttons){if(!t.buttons.hasOwnProperty(s)){continue}if(s>0){i.push(BX.create("SPAN",{html:"&nbsp;"}))}i.push(t.buttons[s])}e.push(BX.create("div",{props:{className:"bx-crm-popup-buttons"},children:i}))}var a=BX.create("div",{props:{className:"bx-crm-popup-container"},children:e});t.events.onPopupShow=BX.delegate(function(){if(i.length){firstButtonInModalWindow=i[0];BX.bind(document,"keydown",BX.proxy(this._keyPress,this))}if(t.events.onPopupShow)BX.delegate(t.events.onPopupShow,BX.proxy_context)},this);var n=t.events.onPopupClose;t.events.onPopupClose=BX.delegate(function(){firstButtonInModalWindow=null;try{BX.unbind(document,"keydown",BX.proxy(this._keypress,this))}catch(t){}if(n){BX.delegate(n,BX.proxy_context)()}if(t.withoutWindowManager){delete windowsWithoutManager[t.modalId]}BX.proxy_context.destroy()},this);var r;if(t.withoutWindowManager){if(!!windowsWithoutManager[t.modalId]){return windowsWithoutManager[t.modalId]}r=new BX.PopupWindow(t.modalId,t.bindElement,{content:a,closeByEsc:true,closeIcon:t.closeIcon,autoHide:t.autoHide,overlay:t.overlay,events:t.events,buttons:[],zIndex:isNaN(t["zIndex"])?0:t.zIndex});windowsWithoutManager[t.modalId]=r}else{r=BX.PopupWindowManager.create(t.modalId,t.bindElement,{content:a,closeByEsc:true,closeIcon:t.closeIcon,autoHide:t.autoHide,overlay:t.overlay,events:t.events,buttons:[],zIndex:isNaN(t["zIndex"])?0:t.zIndex})}r.show();return r};t.prototype.saveFieldValue=function(t,e){var i="",s=e.value,a=this.searchElement("input",this.fieldHiddenNumberIdPrefix+t),n=this.searchElement("span",this.fieldNameIdPrefix+t),r=this.searchElement("div",this.mainDivStorageFieldIdPrefix+t),l=this.searchElement("span",this.spanStoringNameIdPrefix+t),o=this.searchElement("input",this.fieldHiddenNameIdPrefix+t);i+=a.value+". "+s;e.onblur="";if(s==""){if(a.value==1){s=this.data[this.entityId][t].NAME_INIT}else{var d=BX.message("CRM_STATUS_NEW");if(this.hasSemantics){d=BX.message("CRM_STATUS_NEW_"+this.entityId)}s=d}}n.innerHTML=BX.util.htmlspecialchars(i);r.setAttribute("ondblclick",'BX["'+this.jsClass+"\"].editField('"+t+"');");l.style.width="";o.value=s;this.data[this.entityId][t].NAME=s;if(this.initAmChart){this.recalculateSort()}};t.prototype.searchElement=function(t,e){var i=BX.findChildren(BX(this.contentIdPrefix+this.entityId),{tag:t,attribute:{id:e}},true);if(i[0]){return i[0]}return null};t.prototype.getDefaultColor=function(){var t=-1;var e=BX.util.objectSort(Object.values(this.data[this.entityId]),"SORT","asc");for(var i=e.length-1;i>0;i--){var s=e[i]["COLOR"];var a=BX.util.array_search(s,this.defaultColors);if(a>=0){t=a;break}}if(t<0||t===this.defaultColors.length-1){t=0}else{t++}return this.defaultColors[t]};t.prototype.addField=function(t){var e=t.parentNode;var i=1;var s=this.getDefaultColor();var a=BX.message("CRM_STATUS_NEW");if(e.id=="final-storage-"+this.entityId){s=this.defaultFinalUnSuccessColor;this.addCellFinalScale()}else{this.addCellMainScale()}for(var n in this.data[this.entityId]){i++}if(this.hasSemantics){a=BX.message("CRM_STATUS_NEW_"+this.entityId)}else{s=this.defaultLineColor}var r="n"+i;this.data[this.entityId][r]={ID:r,SORT:10,NAME:a,ENTITY_ID:this.entityId,COLOR:s};e.insertBefore(this.createStructureHtml(r),t);this.recalculateSort();this.editField(r)};t.prototype.recalculateSort=function(){var t,e;var i=BX.findChildren(BX(this.contentIdPrefix+this.entityId),{tag:"div",attribute:{"data-calculate":"1"}},true);if(!i){return}for(var s=0;s<i.length;s++){e=i[s].parentNode.id;if(e==this.extraStorageFieldIdPrefix+this.entityId){i[s].setAttribute("data-success","1")}else if(e==this.finalStorageFieldIdPrefix+this.entityId){i[s].setAttribute("data-success","0")}var a=s+1;var n=a*10;t=i[s].getAttribute("id").replace(this.mainDivStorageFieldIdPrefix,"");var r=BX.findChildren(i[s],{tag:"input",attribute:{"data-onblur":"1"}},true);if(r.length){this.saveFieldValue(t,r[0])}i[s].setAttribute("data-sort",""+n+"");var l=this.searchElement("span",this.fieldNameIdPrefix+t),o=this.searchElement("input",this.fieldHiddenNameIdPrefix+t),d=this.searchElement("input",this.fieldHiddenNumberIdPrefix+t),h=this.searchElement("input",this.fieldSortHiddenIdPrefix+t);l.innerHTML=BX.util.htmlspecialchars(a+". "+o.value);d.value=a;h.value=n;this.data[this.entityId][t].SORT=n}if(this.initAmChart&&this.hasSemantics){var c=BX.findChildren(BX(this.contentIdPrefix+this.entityId),{tag:"div",attribute:{"data-success":"1"}},true);if(c){this.successFields[this.entityId]=[];for(var u=0;u<c.length;u++){t=c[u].getAttribute("id").replace(this.mainDivStorageFieldIdPrefix,"");this.successFields[this.entityId][u]=this.data[this.entityId][t]}}var f=BX.findChildren(BX(this.contentIdPrefix+this.entityId),{tag:"div",attribute:{"data-success":"0"}},true);if(c){this.unSuccessFields[this.entityId]=[];for(var p=0;p<f.length;p++){t=f[p].getAttribute("id").replace(this.mainDivStorageFieldIdPrefix,"");this.unSuccessFields[this.entityId][p]=this.data[this.entityId][t]}}AmCharts.handleLoad()}this.changeCellScale()};t.prototype.changeCellScale=function(){if(!this.hasSemantics){return}if(!this.successFields[this.entityId]||!this.unSuccessFields[this.entityId]){return}var t=BX.findChildren(BX(this.previouslyScaleIdPrefix+this.entityId),{tag:"td",attribute:{"data-scale-type":"main"}},true),e=BX.findChildren(BX(this.previouslyScaleNumberIdPrefix+this.entityId),{tag:"td",attribute:{"data-scale-type":"main"}},true),i=BX.findChildren(BX(this.previouslyScaleFinalSuccessIdPrefix+this.entityId),{tag:"td"},true),s=BX.findChildren(BX(this.previouslyScaleNumberFinalSuccessIdPrefix+this.entityId),{tag:"td"},true);var a=this.successFields[this.entityId].length-1,n=t.length;if(a>n){for(var r=n;r<a;r++){this.addCellMainScale()}this.changeCellScale();return}else if(a<n){this.deleteCellMainScale(n-a);this.changeCellScale();return}var l,o;for(var d=0;d<a;d++){if(t[d]&&e[d]){if(this.successFields[this.entityId][d].COLOR){o=this.successFields[this.entityId][d].COLOR}else{o=this.getDefaultColor()}t[d].style.background=o;l=d+1;e[d].getElementsByTagName("span")[0].innerHTML=l}}if(i[0]&&s[0]){if(this.successFields[this.entityId][a].COLOR){o=this.successFields[this.entityId][a].COLOR}else{o=this.defaultFinalSuccessColor}l++;i[0].style.background=o;s[0].getElementsByTagName("span")[0].innerHTML=l}var h=BX.findChildren(BX(this.previouslyScaleFinalUnSuccessIdPrefix+this.entityId),{tag:"td"},true),c=BX.findChildren(BX(this.previouslyScaleNumberFinalUnSuccessIdPrefix+this.entityId),{tag:"td"},true);var u=this.unSuccessFields[this.entityId].length,f=h.length;if(u>f){for(var p=f;p<u;p++){this.addCellFinalScale()}this.changeCellScale();return}else if(u<f){this.deleteCellFinalScale(f-u);this.changeCellScale();return}for(var m=0;m<u;m++){if(h[m]&&c[m]){if(this.unSuccessFields[this.entityId][m].COLOR){o=this.unSuccessFields[this.entityId][m].COLOR}else{o=this.defaultFinalUnSuccessColor}h[m].style.background=o;l++;c[m].getElementsByTagName("span")[0].innerHTML=l}}};t.prototype.addCellMainScale=function(){if(!this.hasSemantics){return}var t=BX.findChildren(BX(this.previouslyScaleNumberIdPrefix+this.entityId),{tag:"td",attribute:{"data-scale-type":"main"}},true),e=BX.create("td",{attrs:{"data-scale-type":"main"},html:"&nbsp;"}),i=BX.create("td",{attrs:{"data-scale-type":"main"},children:[BX.create("span",{props:{className:"stage-name"},html:t.length})]});BX(this.previouslyScaleIdPrefix+this.entityId).insertBefore(e,BX(this.previouslyScaleFinalCellIdPrefix+this.entityId));BX(this.previouslyScaleNumberIdPrefix+this.entityId).insertBefore(i,BX(this.previouslyScaleNumberFinalCellIdPrefix+this.entityId))};t.prototype.addCellFinalScale=function(){if(!this.hasSemantics){return}var t=BX.findChildren(BX(this.previouslyScaleNumberFinalUnSuccessIdPrefix+this.entityId),{tag:"td"},true),e=BX.create("td",{html:"&nbsp;"}),i=BX.create("td",{children:[BX.create("span",{props:{className:"stage-name"},html:t.length})]});BX(this.previouslyScaleFinalUnSuccessIdPrefix+this.entityId).appendChild(e);BX(this.previouslyScaleNumberFinalUnSuccessIdPrefix+this.entityId).appendChild(i)};t.prototype.deleteCellMainScale=function(t){if(!this.hasSemantics){return}var e=BX.findChildren(BX(this.previouslyScaleIdPrefix+this.entityId),{tag:"td",attribute:{"data-scale-type":"main"}},true),i=BX.findChildren(BX(this.previouslyScaleNumberIdPrefix+this.entityId),{tag:"td",attribute:{"data-scale-type":"main"}},true);for(var s=0;s<t;s++){BX(this.previouslyScaleIdPrefix+this.entityId).removeChild(e[s]);BX(this.previouslyScaleNumberIdPrefix+this.entityId).removeChild(i[s])}};t.prototype.deleteCellFinalScale=function(t){if(!this.hasSemantics){return}var e=BX.findChildren(BX(this.previouslyScaleFinalUnSuccessIdPrefix+this.entityId),{tag:"td"},true),i=BX.findChildren(BX(this.previouslyScaleNumberFinalUnSuccessIdPrefix+this.entityId),{tag:"td"},true);for(var s=0;s<t;s++){BX(this.previouslyScaleFinalUnSuccessIdPrefix+this.entityId).removeChild(e[s]);BX(this.previouslyScaleNumberFinalUnSuccessIdPrefix+this.entityId).removeChild(i[s])}};t.prototype.createStructureHtml=function(t){var e,i=this.data[this.entityId][t];var s="",a=this.textColorDark,n="",r;if(this.hasSemantics){s="light-icon";a=this.textColorLight;n="transaction-stage-phase-dark";r=BX.create("div",{props:{className:"transaction-stage-phase-panel-button"},attrs:{onclick:'BX["'+this.jsClass+"\"].correctionColorPicker(event, '"+i.ID+"');"}})}e=BX.create("div",{props:{id:this.mainDivStorageFieldIdPrefix+i.ID,className:"transaction-stage-phase draghandle"},attrs:{ondblclick:'BX["'+this.jsClass+"\"].editField('"+i.ID+"');","data-sort":i.SORT,"data-calculate":1,"data-space":i.ID,style:"background: "+i.COLOR+"; color:"+a+";"},children:[BX.create("div",{props:{id:"phase-panel",className:n+" transaction-stage-phase-panel"},attrs:{"data-class":"transaction-stage-phase-panel"},children:[r,BX.create("div",{props:{className:"transaction-stage-phase-panel-button "+"transaction-stage-phase-panel-button-close"},attrs:{onclick:'BX["'+this.jsClass+"\"].openPopupBeforeDeleteField('"+i.ID+"');"}})]}),BX.create("span",{props:{id:"transaction-stage-phase-icon",className:s+" transaction-stage-phase-icon transaction-stage-phase-icon-move draggable"},attrs:{"data-class":"transaction-stage-phase-icon transaction-stage-phase-icon-move draggable"},children:[BX.create("span",{props:{className:"transaction-stage-phase-icon-burger"}})]}),BX.create("span",{props:{id:"phase-panel",className:n+" transaction-stage-phase-title"},attrs:{"data-class":"transaction-stage-phase-title"},children:[BX.create("span",{props:{id:this.spanStoringNameIdPrefix+i.ID,className:"transaction-stage-phase-title-inner"},children:[BX.create("span",{props:{id:this.fieldNameIdPrefix+i.ID,className:"transaction-stage-phase-name"},html:i.ID+". "+BX.util.htmlspecialchars(i.NAME)}),BX.create("span",{props:{className:"transaction-stage-phase-icon-edit"},attrs:{onclick:'BX["'+this.jsClass+"\"].editField('"+i.ID+"')"}})]})]}),BX.create("input",{props:{id:this.fieldHiddenNumberIdPrefix+i.ID},attrs:{type:"hidden",value:i.ID}}),BX.create("input",{props:{id:this.fieldSortHiddenIdPrefix+i.ID},attrs:{type:"hidden",name:"LIST["+this.entityId+"]["+i.ID+"][SORT]",value:i.SORT}}),BX.create("input",{props:{id:this.fieldHiddenNameIdPrefix+i.ID},attrs:{type:"hidden",name:"LIST["+this.entityId+"]["+i.ID+"][VALUE]",value:BX.util.htmlspecialchars(i.NAME)}}),BX.create("input",{props:{id:"stage-color-"+i.ID},attrs:{type:"hidden",name:"LIST["+this.entityId+"]["+i.ID+"][COLOR]",value:i.COLOR}}),BX.create("input",{props:{id:"stage-status-id-"+i.ID},attrs:{type:"hidden",name:"LIST["+this.entityId+"]["+i.ID+"][STATUS_ID]","data-status-id":"1",value:this.getNewStatusId()}})]});return e};t.prototype.getNewStatusId=function(){var t=0;var e=BX.findChildren(BX(this.contentIdPrefix+this.entityId),{tag:"input",attribute:{"data-status-id":"1"}},true);if(!e)return t;for(var i=0;i<e.length;i++){var s=+e[i].value;if(!isNaN(s)){if(s>t){t=s}}}t=t+1;return t};t.prototype.showPlaceToInsert=function(t,e){if(t.className=="space-to-insert draghandle"){return}var i=t.parentNode,s=t.getAttribute("data-space");var a=this.getDragStartParentElement(),n=null;if(a){n=a.id.replace(this.entityId,"")}if(n){switch(n){case"final-storage-":if(i.id.indexOf("extra-storage-")!==-1){return}break;case"extra-storage-":if(i.id.indexOf("final-storage-")!==-1){return}break}}var r=BX.create("div",{props:{id:"space-to-insert-"+s,className:"space-to-insert draghandle"},attrs:{"data-place":"1"}});var l=getCoords(t);var o=e.pageY-l.top;var d=t.offsetHeight/2;if(o>d){if(t.className=="transaction-stage-addphase draghandle"){return}this.deleteSpaceToInsert();this.insertAfter(r,t)}else{this.deleteSpaceToInsert();i.insertBefore(r,t)}};t.prototype.setDragStartParentElement=function(t){this.dragStartParentElement=t};t.prototype.getDragStartParentElement=function(){return this.dragStartParentElement};t.prototype.putDomElement=function(t,e,i){if(!t||!e||!i){return false}var s=e.id.replace(this.entityId,""),a=this.getDragStartParentElement();switch(s){case"final-storage-":if(a&&a.id.indexOf("extra-storage-")!==-1){return false}break;case"extra-storage-":if(a&&a.id.indexOf("final-storage-")!==-1){return false}break}e.insertBefore(t,i);return true};t.prototype.deleteSpaceToInsert=function(){var t=BX.findChildren(BX("crm-container"),{tag:"div",attribute:{"data-place":"1"}},true);if(t){for(var e=0;e<t.length;e++){var i=t[e].parentNode;i.removeChild(t[e])}}};t.prototype.insertAfter=function(t,e){if(!t||!e)return;var i=e.parentNode,s=e.nextSibling;if(s&&i){i.insertBefore(t,e.nextSibling)}else if(i){i.appendChild(t)}};t.prototype.checkChanges=function(){if(this.checkSubmit){return}var t=0,e=false;for(var i in this.data){for(var s in this.data[i]){t++;var a=parseInt(this.data[i][s].SORT),n=parseInt(this.oldData[i][s].SORT),r=this.data[i][s].NAME.toLowerCase(),l=this.oldData[i][s].NAME.toLowerCase(),o=this.data[i][s].COLOR.toLowerCase(),d=this.oldData[i][s].COLOR.toLowerCase();if(a!==n||r!==l||o!==d){e=true;break}}}if(this.totalNumberFields!==t||e){return BX.message("CRM_STATUS_CHECK_CHANGES")}};t.prototype.confirmSubmit=function(){this.checkSubmit=true};t.prototype.fixStatuses=function(){if(this.requestIsRunning){return}this.requestIsRunning=true;if(this.ajaxUrl===""){throw"Error: Service URL is not defined."}BX.ajax({url:this.ajaxUrl,method:"POST",dataType:"json",data:{ACTION:"FIX_STATUSES"},onsuccess:BX.delegate(function(){this.requestIsRunning=false;window.location.reload(true)},this),onfailure:BX.delegate(function(){this.requestIsRunning=false},this)})};t.prototype.correctionColorPicker=function(t,e){if(!e){return}var i=BX("block-color-picker");i.style.left=t.pageX+"px";i.style.top=t.pageY+"px";var s=BX.findChildren(BX("block-color-picker"),{tag:"IMG"},true)[0];s.setAttribute("data-img",e);s.onclick()};t.prototype.paintElement=function(t,e){if(!e){return}var i=e.pWnd.getAttribute("data-img");var s=BX.findChildren(BX(this.contentIdPrefix+this.entityId),{tag:"div",attribute:{id:this.mainDivStorageFieldIdPrefix+i}},true);if(s.length){if(!t&&s[0].parentNode.id==this.finalStorageFieldIdPrefix+this.entityId){t=this.defaultFinalUnSuccessColor}else if(!t&&s[0].parentNode.id==this.finalSuccessStorageFieldIdPrefix+this.entityId){t=this.defaultFinalSuccessColor}else if(!t){t=this.getDefaultColor()}if(!this.hasSemantics){t=this.defaultLineColor}s[0].style.background=t;var a=BX.findChildren(s[0],{tag:"span",attribute:{id:"transaction-stage-phase-icon"}},true);var n=BX.findChildren(s[0],{attribute:{id:"phase-panel"}},true);if(a.length&&n.length){BX.ajax({url:this.ajaxUrl,method:"POST",dataType:"json",data:{ACTION:"GET_COLOR",COLOR:t},onsuccess:BX.delegate(function(t){s[0].style.color=t.COLOR;a[0].className=t.ICON_CLASS+" "+a[0].getAttribute("data-class");for(var e in n){n[e].className=t.BLOCK_CLASS+" "+n[e].getAttribute("data-class")}},this)})}}else{return}var r=BX.findChildren(BX(this.contentIdPrefix+this.entityId),{tag:"input",attribute:{id:"stage-color-"+i}},true);if(r[0]){r[0].value=t}this.data[this.entityId][i].COLOR=t;this.recalculateSort()};t.prototype.initAmCharts=function(){this.initAmChart=true;if(AmCharts.isReady){this.renderAmCharts()}else{AmCharts.ready(BX.delegate(this.renderAmCharts,this))}if(this.hasSemantics){AmCharts.handleLoad()}};t.prototype.renderAmCharts=function(){var t=[];for(var e in this.initialFields){t.push(BX(this.funnelSuccessIdPrefix+e));t.push(BX(this.funnelUnSuccessIdPrefix+e))}if(!t.length){return}for(var i=0;i<t.length;i++){if(!t[i].id)continue;this.getDataForAmCharts(t[i].id);var s=AmCharts.makeChart(t[i].id,{type:"funnel",theme:"none",titleField:"title",valueField:"value",dataProvider:this.dataFunnel,colors:this.colorFunnel,labelsEnabled:false,marginRight:35,marginLeft:35,labelPosition:"center",funnelAlpha:.9,startX:200,neckWidth:"40%",startAlpha:0,depth3D:100,angle:10,outlineAlpha:1,outlineColor:"#FFFFFF",outlineThickness:1,neckHeight:"30%",balloonText:"[[title]]",export:{enabled:true}})}};t.prototype.getDataForAmCharts=function(t){var e=[],i="",s=false;if(t==this.funnelSuccessIdPrefix+this.entityId){e=this.successFields[this.entityId];i=this.getDefaultColor();s=true}else if(t==this.funnelUnSuccessIdPrefix+this.entityId){e=this.unSuccessFields[this.entityId];i=this.defaultFinalUnSuccessColor}this.dataFunnel=[];this.colorFunnel=[];for(var a=0;a<e.length;a++){if(a==e.length-1&&s){i=this.defaultFinalSuccessColor}this.dataFunnel[a]={title:BX.util.htmlspecialchars(e[a].NAME),value:1};if(e[a].COLOR){this.colorFunnel[a]=e[a].COLOR}else{this.colorFunnel[a]=i}}};t.prototype.showError=function(){var t=this.getParameterByName("ERROR");if(t){var e=BX.create("p",{props:{className:"bx-crm-popup-paragraph"},html:BX.util.htmlspecialchars(t)});this.modalWindow({modalId:"bx-crm-popup",title:BX.message("CRM_STATUS_REMOVE_ERROR"),overlay:false,content:[e],events:{onPopupClose:function(){this.destroy()},onAfterPopupShow:function(t){var e=BX.findChild(t.contentContainer,{className:"bx-crm-popup-title"},true);if(e){e.style.cursor="move";BX.bind(e,"mousedown",BX.proxy(t._startDrag,t))}}},buttons:[BX.create("a",{text:BX.message("CRM_STATUS_CLOSE_POPUP_REMOVE_ERROR"),props:{className:"webform-small-button webform-small-button-accept"},events:{click:BX.delegate(function(t){BX.PopupWindowManager.getCurrentPopup().close()},this)}})]})}};t.prototype.getParameterByName=function(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+t+"=([^&#]*)"),i=e.exec(location.search);return i===null?"":decodeURIComponent(i[1].replace(/\+/g," "))};t.prototype.init=function(){var t=BX("crm-configs-footer");if(!t){return}BX.addCustomEvent(t,"onFooterChangeState",BX.delegate(function(e){if(e){BX.removeClass(t,"crm-configs-footer");BX.addClass(t,"webform-buttons-fixed")}else{BX.addClass(t,"crm-configs-footer");BX.removeClass(t,"webform-buttons-fixed")}},this));BX.bind(window,"scroll",BX.proxy(this.processingFooter,this));this.processingFooter();if(!this.blockFixed){BX.onCustomEvent(this.footer,"onFooterChangeState",[false])}};t.prototype.processingFooter=function(){if(!this.footer||!this.blockFixed){return}this.windowSize=BX.GetWindowInnerSize();this.scrollPosition=BX.GetWindowScrollPos();this.contentPosition=BX.pos(BX(this.contentIdPrefix+this.entityId));this.footerPosition=BX.pos(this.footer);this.limit=this.contentPosition.top;var t=this.scrollPosition.scrollTop+this.windowSize.innerHeight;var e=this.contentPosition.bottom+this.footerPosition.height;if(this.limit>0&&t<this.limit){this.footerFixed=false}else if(!this.footerFixed&&t<e){this.footerFixed=true}else if(this.footerFixed&&t>=e){this.footerFixed=false}BX.onCustomEvent(this.footer,"onFooterChangeState",[this.footerFixed]);var i=parseInt(BX.style(this.footer,"paddingLeft"));this.footer.style.left=this.contentPosition.left+"px";this.footer.style.width=this.contentPosition.width-i*2+"px"};t.prototype.fixFooter=function(t){this.blockFixed=!this.blockFixed;if(this.blockFixed){BX.userOptions.save("crm","crm_config_status","fix_footer","on");BX.addClass(t,"crm-fixedbtn-pin");t.setAttribute("title",BX.message("CRM_STATUS_FOOTER_PIN_OFF"));this.processingFooter()}else{BX.userOptions.save("crm","crm_config_status","fix_footer","off");BX.removeClass(t,"crm-fixedbtn-pin");t.setAttribute("title",BX.message("CRM_STATUS_FOOTER_PIN_ON"));BX.onCustomEvent(this.footer,"onFooterChangeState",[false])}};t.semanticEntityTypes=[];t.hasSemantics=function(t){var e=this.semanticEntityTypes;if(!BX.type.isArray(e)){return false}for(var i=0,s=e.length;i<s;i++){if(e[i]===t){return true}}return false};return t}();
//# sourceMappingURL=script.map.js