this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(exports,d3,main_kanban,ui_notification,main_popup,main_core){"use strict";function _templateObject(){var e=babelHelpers.taggedTemplateLiteral(['<div class="crm-st-kanban-stub"></div>']);_templateObject=function t(){return e};return e}function createStub(){return main_core.Tag.render(_templateObject())}function isLine(e){return main_core.Type.isArray(e)&&e.length===2&&e.every(main_core.Type.isNumber)}function isOverlap(e,t){if(!isLine(e)||!isLine(t)){throw new Error("Invalid lines. Line should be Array<number>")}var n=Math.min.apply(Math,babelHelpers.toConsumableArray(e));var a=Math.max.apply(Math,babelHelpers.toConsumableArray(e));var r=Math.min.apply(Math,babelHelpers.toConsumableArray(t));var i=Math.max.apply(Math,babelHelpers.toConsumableArray(t));return n>=r&&n<=i||a>=r&&a<=i||r>=n&&r<=a||i>=n&&i<=a}var isValidRect=function e(t){return main_core.Type.isNumber(t.left)&&main_core.Type.isNumber(t.top)&&main_core.Type.isNumber(t.width)&&main_core.Type.isNumber(t.height)};function makeRelativeRect(e,t){if(!isValidRect(e)||!isValidRect(t)){throw new Error("Invalid rect. Rect should includes x, y, width and height props with a number value")}return{left:t.left-e.left,top:t.top-e.top,right:t.left-e.left+t.width,bottom:t.top-e.top+t.height,width:t.width,height:t.height}}function isRect(e){return main_core.Type.isNumber(e.left)&&main_core.Type.isNumber(e.top)&&main_core.Type.isNumber(e.width)&&main_core.Type.isNumber(e.height)}function getMiddlePoint(e){if(!isRect(e)){throw new Error("Invalid rect. Rect should includes x, y, width and height props with a number value")}return{middleX:e.left+e.width/2,middleY:e.top+e.height/2}}function _templateObject4(){var e=babelHelpers.taggedTemplateLiteral(['<span class="crm-st-tunnel-button-counter">0</span>']);_templateObject4=function t(){return e};return e}function _templateObject3(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-tunnel-button" \n\t\t\t\t\t onmouseenter="','"\n\t\t\t\t\t onmouseleave="','"\n\t\t\t\t\t onclick="','"\n\t\t\t\t\t title="','"\n\t\t\t\t\t style="','"\n\t\t\t\t>',"</div>\n\t\t\t"]);_templateObject3=function t(){return e};return e}function _templateObject2(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\tbottom: 0px;\n\t\t\tleft: ","px;\n\t\t\ttransform: translate3d(-50%, 50%, 0);\n\t\t"]);_templateObject2=function t(){return e};return e}function _templateObject$1(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\tbottom: 0px;\n\t\t\tleft: ","px;\n\t\t\ttransform: translate3d(-50%, 50%, 0);\n\t\t"]);_templateObject$1=function t(){return e};return e}var Marker=function(e){babelHelpers.inherits(t,e);babelHelpers.createClass(t,null,[{key:"getMarkerFromPoint",value:function e(n){return t.instances.find(function(e){return e.isReceiverIntersecting(n)})}},{key:"emitReceiverDragOutForAll",value:function e(){var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;t.instances.forEach(function(e){if(e!==n){e.onReceiverDragOut()}})}},{key:"getAllLinks",value:function e(){return t.instances.reduce(function(e,t){return babelHelpers.toConsumableArray(t.links).reduce(function(e,t){return e.add(t)},e)},new Set)}},{key:"getAllStubLinks",value:function e(){return t.instances.reduce(function(e,t){return babelHelpers.toConsumableArray(t.stubLinks).reduce(function(e,t){return e.add(t)},e)},new Set)}},{key:"highlightLink",value:function e(){for(var n=arguments.length,a=new Array(n),r=0;r<n;r++){a[r]=arguments[r]}t.getAllLinks().forEach(function(e){if(!a.includes(e)){if([].concat(a).every(function(t){return t.from!==e.from})){main_core.Dom.addClass(e.from.dispatcher,"crm-st-fade");main_core.Dom.addClass(e.from.receiver,"crm-st-fade");main_core.Dom.addClass(e.from.getTunnelButton(),"crm-st-fade")}main_core.Dom.addClass(e.to.dispatcher,"crm-st-fade");main_core.Dom.addClass(e.to.receiver,"crm-st-fade");main_core.Dom.addClass(e.node.node(),"crm-st-fade");main_core.Dom.addClass(e.arrow.select("path").node(),"crm-st-fade")}else{var t=e.node.node();t.parentNode.appendChild(t);var n=e.arrow.node();var r=n.closest("defs");main_core.Dom.insertAfter(n,r.firstChild)}})}},{key:"unhighlightLinks",value:function e(){t.getAllLinks().forEach(function(e){main_core.Dom.removeClass(e.from.dispatcher,"crm-st-fade");main_core.Dom.removeClass(e.from.receiver,"crm-st-fade");main_core.Dom.removeClass(e.from.getTunnelButton(),"crm-st-fade");main_core.Dom.removeClass(e.to.dispatcher,"crm-st-fade");main_core.Dom.removeClass(e.to.receiver,"crm-st-fade");main_core.Dom.removeClass(e.node.node(),"crm-st-fade");main_core.Dom.removeClass(e.arrow.select("path").node(),"crm-st-fade")})}},{key:"blurLinks",value:function e(n){t.getAllLinks().forEach(function(e){if(e.from===n||e.to===n){main_core.Dom.addClass(e.node.node(),"crm-st-blur-link");main_core.Dom.addClass(e.from.getTunnelButton(),"crm-st-blur-link")}})}},{key:"unblurLinks",value:function e(){t.getAllLinks().forEach(function(e){main_core.Dom.removeClass(e.node.node(),"crm-st-blur-link");main_core.Dom.removeClass(e.from.getTunnelButton(),"crm-st-blur-link");main_core.Dom.removeClass(e.to.getTunnelButton(),"crm-st-blur-link")})}},{key:"removeAllLinks",value:function e(){t.instances.forEach(function(e){var t=true;e.removeAllLinks(t)});t.instances.forEach(function(e){e.removeAllStubLinks()})}},{key:"restoreAllLinks",value:function e(){var n=true;t.getAllLinks().forEach(function(e){e.from.links.delete(e);e.from.addLinkTo(e.to,n)})}},{key:"adjustLinks",value:function e(){t.getAllLinks().forEach(function(e,n){var a=e.from.getLinkPath(e.to);e.node.style("transition","none");d3.select(e.from.getTunnelButton()).style("transition","none");e.from.showTunnelButton(a);e.node.attr("d",d3.line()(a));e.path=a;clearTimeout(t.adjustLinksTimeoutIds[n]);t.adjustLinksTimeoutIds[n]=setTimeout(function(){e.node.style("transition",null);d3.select(e.from.getTunnelButton()).style("transition",null)},1e3)})}}]);function t(e){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"links",new Set);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"stubLinks",new Set);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"cache",new main_core.Cache.MemoryCache);n.dispatcher=e.dispatcher;n.receiver=e.receiver;n.point=e.point;n.container=e.container;n.intermediateXPoints=e.intermediateXPoints;n.name=e.name;n.data=e.data;var a=n.getLinksRoot();if(!a.select("defs").node()){a.append("svg:defs").append("filter").attr("id","crm-st-blur").append("feGaussianBlur").attr("stdDeviation","2");a.select("#crm-st-blur").append("feColorMatrix").attr("type","saturate").attr("values","0")}n.onDispatcherMouseDown=n.onDispatcherMouseDown.bind(babelHelpers.assertThisInitialized(n));n.onMarkerRootMouseUp=n.onMarkerRootMouseUp.bind(babelHelpers.assertThisInitialized(n));n.onMarkerRootMouseMove=n.onMarkerRootMouseMove.bind(babelHelpers.assertThisInitialized(n));d3.select(n.dispatcher).on("mousedown",n.onDispatcherMouseDown);t.instances.push(babelHelpers.assertThisInitialized(n));return n}babelHelpers.createClass(t,[{key:"disable",value:function e(){this.disabled=true}},{key:"enable",value:function e(){this.disabled=false}},{key:"isEnabled",value:function e(){return!this.disabled}},{key:"getMarkerRoot",value:function e(){var t=this;return this.cache.remember("markerRoot",function(){var e=d3.select(t.container).select(".crm-st-svg-root");if(e.node()){return e}return d3.select(t.container).append("svg").attr("class","crm-st-svg-root")})}},{key:"getMarkerRootRect",value:function e(){return this.getMarkerRoot().node().getBoundingClientRect()}},{key:"getLinksRoot",value:function e(){var t=this;return this.cache.remember("linksRoot",function(){var e=d3.select(t.container).select(".crm-st-svg-links-root");if(e.node()){return e}return d3.select(t.container).append("svg").attr("class","crm-st-svg-links-root")})}},{key:"getMarkerLine",value:function e(){return this.cache.remember("markerLine",this.getMarkerRoot().append("line").attr("class","crm-st-svg-marker"))}},{key:"removeMarkerLine",value:function e(){this.getMarkerLine().remove();this.cache.delete("markerLine")}},{key:"getDispatcherRect",value:function e(){var t=makeRelativeRect(this.getMarkerRootRect(),this.dispatcher.getBoundingClientRect());return babelHelpers.objectSpread({},t,getMiddlePoint(t))}},{key:"getReceiverRect",value:function e(){var t=makeRelativeRect(this.getMarkerRootRect(),this.receiver.getBoundingClientRect());return babelHelpers.objectSpread({},t,getMiddlePoint(t))}},{key:"getPointRect",value:function e(){var t=makeRelativeRect(this.getMarkerRootRect(),this.point.getBoundingClientRect());return babelHelpers.objectSpread({},t,getMiddlePoint(t))}},{key:"getMarkerRootMousePosition",value:function e(){var t=d3.mouse(this.getMarkerRoot().node()),n=babelHelpers.slicedToArray(t,2),a=n[0],r=n[1];return{x:a,y:r}}},{key:"onReceiverDragOver",value:function e(t,n){if(!this.hovered){this.hovered=true;this.emit("Marker:receiver:dragOver",{from:t,to:n})}}},{key:"onReceiverDragOut",value:function e(){if(this.hovered){this.hovered=false;this.emit("Marker:receiver:dragOut")}}},{key:"onDispatcherMouseDown",value:function e(){var t=this.getDispatcherRect(),n=t.middleX,a=t.middleY;this.getMarkerLine().attr("x1",n).attr("y1",a).attr("x2",n).attr("y2",a);this.getMarkerRoot().style("z-index","222").on("mousemove",this.onMarkerRootMouseMove).on("mouseup",this.onMarkerRootMouseUp);this.emit("Marker:dragStart")}},{key:"onMarkerRootMouseMove",value:function e(){var n=this.getMarkerRootMousePosition(),a=n.x,r=n.y;this.getMarkerLine().attr("x2",a).attr("y2",r);this.emit("Marker:drag");var i=this.getDestinationMarker();if(i&&i.isEnabled()){if(i!==this){i.onReceiverDragOver(this,i)}}t.emitReceiverDragOutForAll(i)}},{key:"onMarkerRootMouseUp",value:function e(){this.getMarkerRoot().on("mousemove",null).on("mouseup",null).style("z-index",null);this.removeMarkerLine();t.instances.forEach(function(e){return e.onReceiverDragOut()});var n=this.getDestinationMarker();var a=new main_core.Event.BaseEvent({data:{from:this,to:n}});this.emit("Marker:dragEnd",a);if(n&&n.isEnabled()){if(n&&!a.isDefaultPrevented()){if(!this.data.column.data.canEditTunnels){this.emit("Marker:error",{message:main_core.Loc.getMessage("CRM_ST_TUNNEL_EDIT_ACCESS_DENIED")});return}this.addLinkTo(n)}}}},{key:"getTunnelMenu",value:function e(){var t=this;return this.cache.remember("tunnelMenu",function(){return new main_popup.PopupMenuWindow({bindElement:t.getTunnelButton(),items:t.getTunnelMenuItems(babelHelpers.toConsumableArray(t.links)[0]),events:{onPopupClose:function e(){return t.deactivateTunnelButton()},onPopupShow:function e(){return t.activateTunnelButton()}}})})}},{key:"getTunnelMenuItems",value:function e(t){var n=this;return[{text:main_core.Loc.getMessage("CRM_ST_SETTINGS"),onclick:function e(){n.editLink(t);this.close()}},{text:main_core.Loc.getMessage("CRM_ST_REMOVE"),onclick:function e(){n.removeLink(t);var a=this.getParentMenuWindow();if(a){a.removeMenuItem(this.getParentMenuItem().id)}}}]}},{key:"editLink",value:function e(t){this.emit("Marker:editLink",{link:t})}},{key:"addLinkTo",value:function e(n){var a=this;var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;setTimeout(function(){if(!babelHelpers.toConsumableArray(a.links).some(function(e){return e.to===n})){var e=a.getLinksRoot();var i=a.getLinkPath(n);var o=d3.line();var s=a.data.column.getId().replace(":","-");var l=n.data.column.getId().replace(":","-");var u="".concat(s,"-").concat(l);var c=e.select("defs").append("svg:marker").attr("id",u).attr("refX",8).attr("refY",6).attr("markerWidth",30).attr("markerHeight",30).attr("markerUnits","userSpaceOnUse").attr("orient","auto").append("path").attr("d","M 0 0 12 6 0 12 3 6").attr("class","crm-st-svg-link-arrow").select(function e(){return this.parentNode});var m=e.append("path").attr("class","crm-st-svg-link").attr("marker-end","url(#".concat(u,")")).attr("d",o(i));a.showTunnelButton(i);var d={from:a,to:n,node:m,arrow:c,path:i};a.emit("Marker:linkFrom",{link:d,preventSave:r});n.emit("Marker:linkTo",{link:d,preventSave:r});a.links.add(d);var g=a.getTunnelsListMenu();var b=g.getMenuItems().length;g.addMenuItem({id:"#".concat(b),text:n.name,events:{onMouseEnter:function e(){t.highlightLink(d)},onMouseLeave:function e(){t.unhighlightLinks()}},items:a.getTunnelMenuItems(d)})}if(a.links.size>1){a.setTunnelsCounterValue(a.links.size)}})}},{key:"addStubLinkTo",value:function e(t){var n=this;setTimeout(function(){if(!babelHelpers.toConsumableArray(n.stubLinks).some(function(e){return e.to===t})){var e=n.getLinksRoot();var a=n.getLinkPath(t);var r=d3.line();var i=n.data.column.getId().replace(":","-");var o=t.data.column.getId().replace(":","-");var s="".concat(i,"-").concat(o);var l=e.select("defs").append("svg:marker").attr("id",s).attr("refX",8).attr("refY",6).attr("markerWidth",30).attr("markerHeight",30).attr("markerUnits","userSpaceOnUse").attr("orient","auto").append("path").attr("d","M 0 0 12 6 0 12 3 6").attr("class","crm-st-svg-link-arrow crm-st-svg-link-arrow-stub").select(function e(){return this.parentNode});var u=e.append("path").attr("class","crm-st-svg-link crm-st-svg-link-stub").attr("marker-end","url(#".concat(s,")")).attr("d",r(a));n.showTunnelStubButton(a);var c={from:n,to:t,node:u,arrow:l,path:a};n.emit("Marker:stubLinkFrom",{link:c,preventSave:true});t.emit("Marker:stubLinkTo",{link:c,preventSave:true});n.stubLinks.add(c)}})}},{key:"updateLink",value:function e(t,n){var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var r=this.getLinkPath(n);var i=d3.line();var o=t.to;t.node.attr("d",i(r));t.path=r;t.to=n;this.emit("Marker:linkFrom",{link:t,preventSave:a});n.emit("Marker:linkTo",{link:t,preventSave:a});if(!o.isLinked()){o.emit("Marker:unlink")}}},{key:"removeLink",value:function e(t){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;t.hidden=true;if(!n){this.links.delete(t)}t.node.remove();t.arrow.remove();if(!this.isLinkedFrom()){main_core.Dom.remove(t.from.getTunnelButton());this.getTunnelMenu().destroy();this.deactivateTunnelButton();this.cache.delete("tunnelMenu")}this.setTunnelsCounterValue(this.links.size);var a=babelHelpers.toConsumableArray(this.links).filter(function(e){return!e.hidden});if(a.length<=1){if(this.getTunnelsListMenu().getPopupWindow().isShown()){this.getTunnelMenu().destroy();this.cache.delete("tunnelMenu");this.getTunnelMenu().show()}this.getTunnelsListMenu().destroy();this.deactivateTunnelButton();this.cache.delete("tunnelsListMenu")}t.from.emit("Marker:removeLinkFrom",{link:t,preventSave:n});if(!t.from.isLinked()){t.from.emit("Marker:unlink",{preventSave:n})}t.to.emit("Marker:removeTo",{link:t,preventSave:n});if(!t.to.isLinked()){t.to.emit("Marker:unlink",{preventSave:n})}}},{key:"removeAllLinks",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this.links.forEach(function(e){return t.removeLink(e,n)})}},{key:"removeStubLink",value:function e(t){this.stubLinks.delete(t);t.node.remove();t.arrow.remove();if(!this.isLinkedStub()){main_core.Dom.remove(t.from.getStubTunnelButton())}t.from.emit("Marker:removeStubLink",{link:t});t.from.emit("Marker:removeStubLinkFrom",{link:t});if(!t.from.isLinkedStub()){t.from.emit("Marker:unlinkStub")}t.to.emit("Marker:removeStubTo",{link:t});if(!t.to.isLinkedStub()){t.to.emit("Marker:unlinkStub")}}},{key:"removeAllStubLinks",value:function e(){var t=this;this.stubLinks.forEach(function(e){return t.removeStubLink(e)})}},{key:"isLinked",value:function e(){var n=this;return babelHelpers.toConsumableArray(t.getAllLinks()).some(function(e){return!e.hidden&&(e.from===n||e.to===n)})}},{key:"isLinkedFrom",value:function e(){var n=this;return babelHelpers.toConsumableArray(t.getAllLinks()).some(function(e){return!e.hidden&&e.from===n})}},{key:"isLinkedTo",value:function e(){var n=this;return babelHelpers.toConsumableArray(t.getAllLinks()).some(function(e){return!e.hidden&&e.to===n})}},{key:"isLinkedStub",value:function e(){var n=this;return babelHelpers.toConsumableArray(t.getAllLinks()).some(function(e){return!e.hidden&&(e.from===n||e.to===n)})}},{key:"showTunnelButton",value:function e(t){var n=this.getTunnelButton();var a=this.getCategory();var r=t[0][0];main_core.Tag.style(n)(_templateObject$1(),r);if(!a.contains(n)){main_core.Dom.append(n,a)}}},{key:"getStubTunnelButton",value:function e(){var t=this;return this.cache.remember("tunnelStubButton",function(){var e=main_core.Runtime.clone(t.getTunnelButton());main_core.Dom.addClass(e,"crm-st-tunnel-button-stub");return e})}},{key:"showTunnelStubButton",value:function e(t){var n=this.getStubTunnelButton();var a=this.getCategory();var r=t[0][0];main_core.Tag.style(n)(_templateObject2(),r);if(!a.contains(n)){main_core.Dom.append(n,a)}}},{key:"getTunnelButton",value:function e(){var n=this;var a=this.data.column.data.canEditTunnels;return this.cache.remember("tunnelButton",function(){return main_core.Tag.render(_templateObject3(),n.onTunnelButtonMouseEnter.bind(n),t.onTunnelButtonMouseLeave,n.onTunnelButtonClick.bind(n),main_core.Loc.getMessage("CRM_ST_TUNNEL_BUTTON_TITLE"),!a?"pointer-events: none;":"",main_core.Loc.getMessage("CRM_ST_TUNNEL_BUTTON_LABEL"))})}},{key:"onTunnelButtonMouseEnter",value:function e(){t.highlightLink.apply(t,babelHelpers.toConsumableArray(this.links))}},{key:"onTunnelButtonClick",value:function e(){if(this.links.size>1){if(this.isTunnelButtonActive()){this.getTunnelsListMenu().close();return}this.getTunnelsListMenu().show()}else{this.getTunnelMenu().show()}}},{key:"getTunnelsListMenu",value:function e(){var t=this;return this.cache.remember("tunnelsListMenu",new main_popup.PopupMenuWindow({bindElement:this.getTunnelButton(),items:[],closeByEsc:true,menuShowDelay:0,events:{onPopupClose:function e(){return t.deactivateTunnelButton()},onPopupShow:function e(){return t.activateTunnelButton()}}}))}},{key:"activateTunnelButton",value:function e(){main_core.Dom.addClass(this.getTunnelButton(),"crm-st-tunnel-button-active")}},{key:"deactivateTunnelButton",value:function e(){main_core.Dom.removeClass(this.getTunnelButton(),"crm-st-tunnel-button-active")}},{key:"isTunnelButtonActive",value:function e(){return main_core.Dom.hasClass(this.getTunnelButton(),"crm-st-tunnel-button-active")}},{key:"getTunnelsCounter",value:function e(){return this.cache.remember("tunnelsCounter",main_core.Tag.render(_templateObject4()))}},{key:"setTunnelsCounterValue",value:function e(t){var n=this.getTunnelButton();var a=this.getTunnelsCounter();if(t>1){if(!n.contains(a)){main_core.Dom.append(a,n)}a.innerText=t}else{a.innerText=0;main_core.Dom.remove(a)}}},{key:"getCategory",value:function e(){return this.receiver.closest(".crm-st-category")}},{key:"getIntermediateXPoints",value:function e(){if(main_core.Type.isArray(this.intermediateXPoints)){var t=this.getMarkerRootRect();return this.intermediateXPoints.map(function(e){return e-t.left})}if(main_core.Type.isFunction(this.intermediateXPoints)){var n=this.getMarkerRootRect();return this.intermediateXPoints().map(function(e){return e-n.left})}return[]}},{key:"getNearestIntermediateXPoint",value:function e(t){return this.getIntermediateXPoints().reduce(function(e,n){return Math.abs(n-t)<Math.abs(e-t)?n:e})}},{key:"getLinkPath",value:function e(n){var a=this;var r=n.getPointRect();var i=this.getDispatcherRect();var o=80;var s=10;var l=[];l.push([i.middleX,i.middleY]);l.push([i.middleX,i.middleY+o]);if(i.middleY!==r.middleY){var u=this.getNearestIntermediateXPoint(r.middleX);l.push([u,i.middleY+o]);l.push([u,r.middleY+o/3-s/3]);l.push([r.middleX,r.middleY+o/3-s/3])}else{l.push([r.middleX,r.middleY+o])}l.push([r.middleX,r.middleY+s]);var c=4;return babelHelpers.toConsumableArray(t.getAllLinks()).reduce(function(e,t){var n=t.from,r=t.path;if(n!==a){if(e[1][1]===r[1][1]){if(isOverlap([e[1][0],e[2][0]],[r[1][0],r[2][0]])){e[1][1]+=c;e[2][1]+=c}}if(r.length===6){if(e[1][1]===r[3][1]){if(isOverlap([e[1][0],e[2][0]],[r[3][0],r[4][0]])){e[1][1]+=c;e[2][1]+=c}}}if(e.length===6){if(e[3][1]===r[1][1]){if(isOverlap([e[3][0],e[4][0]],[r[1][0],r[2][0]])){e[3][1]+=c;e[4][1]+=c}}if(r.length===6){if(e[3][1]===r[3][1]){if(isOverlap([e[3][0],e[4][0]],[r[3][0],r[4][0]])){e[3][1]+=c;e[4][1]+=c}}}}if(e.length===6){if(e[2][0]===r[2][0]){if(isOverlap([e[2][1],e[3][1]],[r[2][1],r[3][1]])){e[2][0]+=c;e[3][0]+=c}}}}return e},[].concat(l))}},{key:"getDestinationMarker",value:function e(){var n=this.getMarkerRootMousePosition();var a=t.getMarkerFromPoint(n);if(a&&a!==this){return a}return null}},{key:"isReceiverIntersecting",value:function e(t){var n=this.getReceiverRect();var a=10;return t.x>n.left&&t.x<n.right&&t.y>n.top&&t.y<n.bottom+a}},{key:"blurLinks",value:function e(){t.blurLinks(this)}},{key:"getData",value:function e(){return this.data}}],[{key:"onTunnelButtonMouseLeave",value:function e(){t.unhighlightLinks()}}]);return t}(main_core.Event.EventEmitter);babelHelpers.defineProperty(Marker,"instances",[]);babelHelpers.defineProperty(Marker,"paths",[]);babelHelpers.defineProperty(Marker,"adjustLinksTimeoutIds",{});function isLinkInSameCategory(e){var t=e.data.from.data.column;var n=e.data.to.data.column;var a=t.getData();var r=n.getData();return String(a.category.id)===String(r.category.id)}function isCycleLink(e){var t=e.data.from.data.column;var n=e.data.to.data.column;return babelHelpers.toConsumableArray(Marker.getAllLinks()).some(function(e){return e.from===n.marker&&e.to===t.marker})}function _templateObject3$1(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t\ttitle: ",";\n\t\t\t\t"]);_templateObject3$1=function t(){return e};return e}function _templateObject2$1(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\ttitle: ",";\n\t\t"]);_templateObject2$1=function t(){return e};return e}function _templateObject$2(){var e=babelHelpers.taggedTemplateLiteral(['<div class="crm-st-kanban-column-dot" title="','">\n\t\t\t\t<span class="crm-st-kanban-column-dot-disallow-icon"> </span>\n\t\t\t\t<span class="crm-st-kanban-column-dot-pulse"> </span>\n\t\t\t</div>']);_templateObject$2=function t(){return e};return e}var Column=function(e){babelHelpers.inherits(t,e);function t(e){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));n.currentName=n.getName();n.marker=new Marker({dispatcher:n.getDot(),receiver:n.getHeader(),point:n.getDot(),container:n.getData().appContainer,intermediateXPoints:function e(){return n.getIntermediateXPoints()},name:"".concat(n.getData().categoryName," (").concat(n.getName(),")"),data:{column:babelHelpers.assertThisInitialized(n)}});n.marker.subscribe("Marker:dragStart",n.onMarkerDragStart.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:receiver:dragOver",n.onMarkerDragOver.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:receiver:dragOut",n.onMarkerDragOut.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:dragEnd",n.onMarkerDragEnd.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:linkFrom",n.onMarkerLinkFrom.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:stubLinkFrom",n.onMarkerStubLinkFrom.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:linkTo",n.onMarkerLinkTo.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:stubLinkTo",n.onMarkerStubLinkTo.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:removeLinkFrom",n.onRemoveLinkFrom.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:editLink",n.onEditLink.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:unlink",n.onMarkerUnlink.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:unlinkStub",n.onMarkerUnlinkStub.bind(babelHelpers.assertThisInitialized(n))).subscribe("Marker:error",n.onMarkerError.bind(babelHelpers.assertThisInitialized(n)));n.onTransitionStart=n.onTransitionStart.bind(babelHelpers.assertThisInitialized(n));n.onTransitionEnd=n.onTransitionEnd.bind(babelHelpers.assertThisInitialized(n));return n}babelHelpers.createClass(t,[{key:"isAllowedTransitionProperty",value:function e(t){return["width","min-width","max-width","transform"].includes(t)}},{key:"onTransitionStart",value:function e(t){if(t.srcElement===this.getContainer()&&this.isAllowedTransitionProperty(t.propertyName)){clearInterval(this.intervalId);this.intervalId=setInterval(Marker.adjustLinks,16)}}},{key:"onTransitionEnd",value:function e(t){if(t.srcElement===this.getContainer()&&this.isAllowedTransitionProperty(t.propertyName)){clearInterval(this.intervalId);this.intervalId=null}}},{key:"setOptions",value:function e(n){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"setOptions",this).call(this,n);if(main_core.Type.isFunction(n.data.onLink)){this.onLinkHandler=n.data.onLink}if(main_core.Type.isFunction(n.data.onRemoveLinkFrom)){this.onRemoveLinkFromHandler=n.data.onRemoveLinkFrom}if(main_core.Type.isFunction(n.data.onEditLink)){this.onEditLinkhandler=n.data.onEditLink}if(main_core.Type.isFunction(n.data.onNameChange)){this.onNameChangeHandler=n.data.onNameChange}if(main_core.Type.isFunction(n.data.onColorChange)){this.onColorChangeHandler=n.data.onColorChange}if(main_core.Type.isFunction(n.data.onAddColumn)){this.onAddColumnHandler=n.data.onAddColumn}if(main_core.Type.isFunction(n.data.onRemove)){this.onRemoveHandler=n.data.onRemove}if(main_core.Type.isFunction(n.data.onChange)){this.onChangeHandler=n.data.onChange}if(main_core.Type.isFunction(n.data.onError)){this.onErrorHandler=n.data.onError}if(this.marker){this.marker.container=this.getData().appContainer;this.marker.cache.clear()}}},{key:"onMarkerError",value:function e(t){this.onErrorHandler(t.data)}},{key:"onEditLink",value:function e(t){this.onEditLinkhandler(t.data)}},{key:"onMarkerLinkFrom",value:function e(t){this.onLinkHandler(t.data);this.activateDot()}},{key:"onMarkerStubLinkFrom",value:function e(){this.activateStubDot()}},{key:"onMarkerStubLinkTo",value:function e(){this.activateStubDot()}},{key:"onRemoveLinkFrom",value:function e(t){this.onRemoveLinkFromHandler(t.data)}},{key:"onMarkerLinkTo",value:function e(){this.activateDot()}},{key:"getIntermediateXPoints",value:function e(){var t=this.getData().stagesGroups,n=t.progressStagesGroup,a=t.successStagesGroup,r=t.failStagesGroup;var i=n.getBoundingClientRect();var o=a.getBoundingClientRect();var s=r.getBoundingClientRect();var l=15;return[i.left+l,o.left-l,o.left+l,o.right-l,o.right+l,s.right-l/2]}},{key:"onMarkerDragStart",value:function e(){this.activateDot()}},{key:"onMarkerDragOver",value:function e(t){if(isLinkInSameCategory(t)||isCycleLink(t)){t.preventDefault();this.disallowDot();return}this.allowDot();this.highlightDot()}},{key:"onMarkerDragOut",value:function e(){this.allowDot();this.unhighlightDot()}},{key:"onMarkerDragEnd",value:function e(t){if(!this.marker.isLinked()){this.deactivateDot()}if(t.data.from&&t.data.to){if(isLinkInSameCategory(t)||isCycleLink(t)){t.preventDefault()}}}},{key:"onMarkerUnlink",value:function e(){this.deactivateDot();this.deactivateStubDot()}},{key:"onMarkerUnlinkStub",value:function e(){this.deactivateStubDot()}},{key:"activateDot",value:function e(){main_core.Dom.addClass(this.getDot(),"crm-st-kanban-column-dot-active")}},{key:"deactivateDot",value:function e(){main_core.Dom.removeClass(this.getDot(),"crm-st-kanban-column-dot-active")}},{key:"activateStubDot",value:function e(){main_core.Dom.addClass(this.getDot(),"crm-st-kanban-column-dot-active-stub")}},{key:"deactivateStubDot",value:function e(){main_core.Dom.removeClass(this.getDot(),"crm-st-kanban-column-dot-active-stub")}},{key:"highlightDot",value:function e(){main_core.Dom.addClass(this.getDot(),"crm-st-kanban-column-dot-highlight")}},{key:"unhighlightDot",value:function e(){main_core.Dom.removeClass(this.getDot(),"crm-st-kanban-column-dot-highlight")}},{key:"allowDot",value:function e(){main_core.Dom.removeClass(this.getDot(),"crm-st-kanban-column-dot-disallow")}},{key:"disallowDot",value:function e(){main_core.Dom.addClass(this.getDot(),"crm-st-kanban-column-dot-disallow")}},{key:"getBody",value:function e(){return createStub()}},{key:"getDot",value:function e(){if(!main_core.Type.isDomNode(this.dot)){var t=main_core.Loc.getMessage("CRM_ST_DOT_TITLE");this.dot=main_core.Tag.render(_templateObject$2(),t)}return this.dot}},{key:"getHeader",value:function e(){var n=babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"getHeader",this).call(this);if(!this.headerDotted){this.headerDotted=true;var a=this.getDot();main_core.Event.bind(a,"mousedown",function(e){return e.stopPropagation()});main_core.Event.bind(a,"mouseup",function(e){return e.stopPropagation()});main_core.Event.bind(a,"mousemove",function(e){return e.stopPropagation()});main_core.Dom.append(a,n)}main_core.Tag.attrs(n)(_templateObject2$1(),this.getName());return n}},{key:"getSubTitle",value:function e(){return createStub()}},{key:"getContainer",value:function e(){var n=babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"getContainer",this).call(this);main_core.Dom.addClass(n,"crm-st-kanban-column");main_core.Event.bind(n,"transitionstart",this.onTransitionStart);main_core.Event.bind(n,"transitionend",this.onTransitionEnd);return n}},{key:"getTotalItem",value:function e(){this.layout.total=createStub();return this.layout.total}},{key:"handleTextBoxBlur",value:function e(n){var a=this;babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"handleTextBoxBlur",this).call(this,n);setTimeout(function(){if(a.currentName!==a.getName()){a.onNameChangeHandler(a);a.currentName=a.getName();main_core.Tag.attrs(a.getHeader())(_templateObject3$1(),a.getName())}},500)}},{key:"onColorSelected",value:function e(n){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"onColorSelected",this).call(this,n);this.onColorChangeHandler(this)}},{key:"handleAddColumnButtonClick",value:function e(n){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"handleAddColumnButtonClick",this).call(this,n);var a=this.getGrid().getNextColumnSibling(this);a.setOptions({canRemove:true,canSort:true});var r=a.applyEditMode;a.applyEditMode=function(){r.apply(a);Marker.adjustLinks()};main_core.Event.bind(a.getRemoveButton(),"click",function(){Marker.adjustLinks()});this.onAddColumnHandler(a);Marker.adjustLinks()}},{key:"handleRemoveButtonClick",value:function e(n){this.getConfirmDialog().setContent(main_core.Loc.getMessage("CRM_ST_CONFIRM_STAGE_REMOVE_TEXT"));babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"handleRemoveButtonClick",this).call(this,n)}},{key:"handleConfirmButtonClick",value:function e(){var n=this;var a=new main_core.Event.BaseEvent({data:{column:this,onConfirm:function e(){Marker.getAllLinks().forEach(function(e){if(String(e.to.data.column.id)===String(n.id)){e.from.removeLink(e)}if(String(e.from.data.column.id)===String(n.id)){e.from.removeLink(e)}});babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"handleConfirmButtonClick",n).call(n);setTimeout(function(){Marker.removeAllLinks();Marker.restoreAllLinks()})},onCancel:function e(){n.getConfirmDialog().close()}}});this.onRemoveHandler(a)}},{key:"switchToEditMode",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"switchToEditMode",this).call(this)}},{key:"applyEditMode",value:function e(){var n=BX.util.trim(this.getTitleTextBox().value);var a=this.colorChanged;var r=false;if(n.length>0&&this.getName()!==n){r=true}babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"applyEditMode",this).call(this);if(r||a){this.onChangeHandler(this)}Marker.adjustLinks()}},{key:"onColumnDrag",value:function e(n,a){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"onColumnDrag",this).call(this,n,a);Marker.adjustLinks()}},{key:"resetRectArea",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"resetRectArea",this).call(this);clearTimeout(this.resetRectAreaTimeoutId);this.resetRectAreaTimeoutId=setTimeout(function(){Marker.adjustLinks()},200)}}]);return t}(main_kanban.Kanban.Column);var Grid=function(e){babelHelpers.inherits(t,e);function t(){var e;var n;babelHelpers.classCallCheck(this,t);for(var a=arguments.length,r=new Array(a),i=0;i<a;i++){r[i]=arguments[i]}n=babelHelpers.possibleConstructorReturn(this,(e=babelHelpers.getPrototypeOf(t)).call.apply(e,[this].concat(r)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"emitter",new main_core.Event.EventEmitter);return n}babelHelpers.createClass(t,[{key:"adjustLayout",value:function e(){}},{key:"adjustHeight",value:function e(){}},{key:"getEmptyStub",value:function e(){return createStub()}},{key:"getDropZoneArea",value:function e(){var n=babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"getDropZoneArea",this).call(this);main_core.Dom.addClass(n.getContainer(),"crm-st-kanban-stub");return n}},{key:"getGridContainer",value:function e(){var n=babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"getGridContainer",this).call(this);main_core.Dom.addClass(n,"crm-st-kanban-grid");return n}},{key:"getInnerContainer",value:function e(){var n=babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"getInnerContainer",this).call(this);main_core.Dom.addClass(n,"crm-st-kanban-inner");return n}},{key:"getOuterContainer",value:function e(){var n=babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"getOuterContainer",this).call(this);main_core.Dom.addClass(n,"crm-st-kanban");return n}},{key:"getLeftEar",value:function e(){return createStub()}},{key:"getRightEar",value:function e(){return createStub()}},{key:"onColumnDragStart",value:function e(n){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"onColumnDragStart",this).call(this,n);Marker.adjustLinks()}},{key:"onColumnDragStop",value:function e(n){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"onColumnDragStop",this).call(this,n);this.emitter.emit("Kanban.Grid:columns:sort");setTimeout(function(){Marker.adjustLinks()});this.getColumns().forEach(function(e){clearInterval(e.intervalId)})}},{key:"addColumn",value:function e(n){var a=babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"addColumn",this).call(this,n);if(a.onChangeHandler){a.onChangeHandler(a)}return a}},{key:"getColumns",value:function e(){this.columnsOrder.sort(function(e,t){if(e.getContainer().parentNode){var n=babelHelpers.toConsumableArray(e.getContainer().parentNode.children).indexOf(e.getContainer());var a=babelHelpers.toConsumableArray(t.getContainer().parentNode.children).indexOf(t.getContainer());return n>a?1:-1}});return this.columnsOrder}}]);return t}(main_kanban.Kanban.Grid);function _templateObject31(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span class="crm-st-generator-link-icon" onclick="','">',"</span>\n\t\t\t"]);_templateObject31=function t(){return e};return e}function _templateObject30(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span class="crm-st-robots-link-icon"> </span>\n\t\t\t']);_templateObject30=function t(){return e};return e}function _templateObject29(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span \n\t\t\t\t\tclass="crm-st-category-action-drag"\n\t\t\t\t\ttitle="','"\n\t\t\t\t\t>&nbsp;</span>\n\t\t\t']);_templateObject29=function t(){return e};return e}function _templateObject28(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-info-title-container">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"]);_templateObject28=function t(){return e};return e}function _templateObject27(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-action-buttons">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"]);_templateObject27=function t(){return e};return e}function _templateObject26(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input class="crm-st-category-info-title-editor" \n\t\t\t\t\t onkeydown="','"\n\t\t\t\t\t onblur="','"\n\t\t\t\t\t value="','"\n\t\t\t\t\t placeholder="','"\n\t\t\t\t >\n\t\t\t']);_templateObject26=function t(){return e};return e}function _templateObject25(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<h3 class="crm-st-category-info-title" title="','">',"</h3>\n\t\t\t"]);_templateObject25=function t(){return e};return e}function _templateObject24(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t\tdisplay: none;\n\t\t\t\t"]);_templateObject24=function t(){return e};return e}function _templateObject23(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span \n\t\t\t\t\tclass="crm-st-remove-button" \n\t\t\t\t\tonclick="','" \n\t\t\t\t\ttitle="','"\n\t\t\t\t\t> </span>\n\t\t\t']);_templateObject23=function t(){return e};return e}function _templateObject22(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\ttitle: ",";\n\t\t\t"]);_templateObject22=function t(){return e};return e}function _templateObject21(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\tdisplay: none;\n\t\t"]);_templateObject21=function t(){return e};return e}function _templateObject20(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\tdisplay: null;\n\t\t"]);_templateObject20=function t(){return e};return e}function _templateObject19(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\tdisplay: null;\n\t\t"]);_templateObject19=function t(){return e};return e}function _templateObject18(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\tdisplay: block;\n\t\t"]);_templateObject18=function t(){return e};return e}function _templateObject17(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span \n\t\t\t\t\tclass="crm-st-edit-button" \n\t\t\t\t\tonmousedown="','"\n\t\t\t\t\ttitle="','"\n\t\t\t\t\t> </span>\n\t\t\t']);_templateObject17=function t(){return e};return e}function _templateObject16(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t",'\n\t\t\t\t<span class="crm-st-category-info-links-link crm-st-generator-link" onclick="','">\n\t\t\t\t\t',"\n\t\t\t\t</span>\n\t\t\t"]);_templateObject16=function t(){return e};return e}function _templateObject15(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t",'\n\t\t\t\t<span class="crm-st-category-info-links-link crm-st-robots-link" onclick="','">\n\t\t\t\t\t',"\n\t\t\t\t</span>\n\t\t\t"]);_templateObject15=function t(){return e};return e}function _templateObject14(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-stages-list"></div>\n\t\t\t']);_templateObject14=function t(){return e};return e}function _templateObject13(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-stages-group crm-st-category-stages-group-fail">\n\t\t\t\t\t<div class="crm-st-category-stages-group-header">\n\t\t\t\t\t\t<span class="crm-st-category-stages-group-in-fail"> </span> \n\t\t\t\t\t\t<span class="crm-st-category-stages-group-header-text">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"]);_templateObject13=function t(){return e};return e}function _templateObject12(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-stages-list"></div>\n\t\t\t']);_templateObject12=function t(){return e};return e}function _templateObject11(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-stages-group crm-st-category-stages-group-success">\n\t\t\t\t\t<div class="crm-st-category-stages-group-header">\n\t\t\t\t\t\t<span class="crm-st-category-stages-group-in-success"> </span> \n\t\t\t\t\t\t<span class="crm-st-category-stages-group-header-text">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"]);_templateObject11=function t(){return e};return e}function _templateObject10(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-stages-list"></div>\n\t\t\t']);_templateObject10=function t(){return e};return e}function _templateObject9(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category-stages-group crm-st-category-stages-group-in-progress">\n\t\t\t\t\t<div class="crm-st-category-stages-group-header">\n\t\t\t\t\t\t<span class="crm-st-category-stages-group-header-text">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"]);_templateObject9=function t(){return e};return e}function _templateObject8(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span \n\t\t\t\t\tclass="crm-st-category-info-links-help" \n\t\t\t\t\tonclick="','"\n\t\t\t\t\ttitle="','"\n\t\t\t\t\t> </span>\n\t\t\t']);_templateObject8=function t(){return e};return e}function _templateObject7(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span \n\t\t\t\t\tclass="crm-st-category-info-links-help" \n\t\t\t\t\tonclick="','"\n\t\t\t\t\ttitle="','"\n\t\t\t\t\t> </span>\n\t\t\t']);_templateObject7=function t(){return e};return e}function _templateObject6(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-st-category" data-id="','">\n\t\t\t\t\t<div class="crm-st-category-action">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="crm-st-category-info">\n\t\t\t\t\t\t','\n\t\t\t\t\t\t<div class="crm-st-category-info-links">\n\t\t\t\t\t\t\t<div class="crm-st-category-info-links-item">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t\t",'\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="crm-st-category-info-links-item">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t\t",'\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="crm-st-category-stages">\n\t\t\t\t\t\t',"\n\t\t\t\t\t\t","\n\t\t\t\t\t\t","\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"]);_templateObject6=function t(){return e};return e}function _templateObject5(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\ttransform: null;\n\t\t\t\ttransition: null;\n\t\t\t"]);_templateObject5=function t(){return e};return e}function _templateObject4$1(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t\ttransition: 200ms;\n\t\t\t\t\ttransform: translate3d(0px, 0px, 0px);\n\t\t\t\t"]);_templateObject4$1=function t(){return e};return e}function _templateObject3$2(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t\ttransition: 200ms;\n\t\t\t\t\ttransform: translate3d(0px, ","px, 0px);\n\t\t\t\t"]);_templateObject3$2=function t(){return e};return e}function _templateObject2$2(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t\ttransition: 200ms;\n\t\t\t\t\ttransform: translate3d(0px, ","px, 0px);\n\t\t\t\t"]);_templateObject2$2=function t(){return e};return e}function _templateObject$3(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\ttransform: translate3d(0px, ","px, 0px);\n\t\t"]);_templateObject$3=function t(){return e};return e}var Category=function(e){babelHelpers.inherits(t,e);babelHelpers.createClass(t,null,[{key:"createGrid",value:function e(t){return new Grid({renderTo:t.renderTo,canEditColumn:t.editable===true,canRemoveColumn:t.editable===true,canAddColumn:t.editable===true,canSortColumn:t.editable===true,columnType:t.columnType||"BX.Crm.SalesTunnels.Kanban.Column",dropzoneType:"BX.Crm.SalesTunnels.Kanban.DropZone",columns:t.columns})}}]);function t(e){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));t.instances.push(babelHelpers.assertThisInitialized(n));n.renderTo=e.renderTo;n.appContainer=e.appContainer;n.id=e.id;n.name=e.name;n.sort=Number.parseInt(e.sort);n.default=e.default;n.generatorsCount=Number(e.generatorsCount);n.stages=e.stages;n.robotsSettingsLink=e.robotsSettingsLink.replace("{category}",n.id);n.generatorSettingsLink=e.generatorSettingsLink;n.cache=new main_core.Cache.MemoryCache;n.drawed=false;n.allowWrite=Boolean(e.allowWrite);n.canEditTunnels=Boolean(e.canEditTunnels);n.isAvailableGenerator=e.isAvailableGenerator;n.showGeneratorRestrictionPopup=e.showGeneratorRestrictionPopup;n.isAvailableRobots=e.isAvailableRobots;n.showRobotsRestrictionPopup=e.showRobotsRestrictionPopup;if(!e.lazy){n.draw()}if(n.generatorsCount>0){n.showGeneratorLinkIcon()}var a=n.getDragButton();a.onbxdragstart=n.onDragStart.bind(babelHelpers.assertThisInitialized(n));a.onbxdrag=n.onDrag.bind(babelHelpers.assertThisInitialized(n));a.onbxdragstop=n.onDragStop.bind(babelHelpers.assertThisInitialized(n));jsDD.registerObject(a,40);n.adjustRobotsLinkIcon();n.getProgressKanban().emitter.subscribe("Kanban.Grid:removeColumn",function(e){n.emit("Category:removeStage",e)}).subscribe("Kanban.Grid:columns:sort",function(){setTimeout(function(){n.emit("Column:sort",{columns:n.getAllColumns()})},500)});n.getSuccessKanban().emitter.subscribe("Kanban.Grid:removeColumn",function(e){n.emit("Category:removeStage",e)}).subscribe("Kanban.Grid:columns:sort",function(){setTimeout(function(){n.emit("Column:sort",{columns:n.getAllColumns()})},500)});n.getFailKanban().emitter.subscribe("Kanban.Grid:removeColumn",function(e){n.emit("Category:removeStage",e)}).subscribe("Kanban.Grid:columns:sort",function(){setTimeout(function(){n.emit("Column:sort",{columns:n.getAllColumns()})},500)});return n}babelHelpers.createClass(t,[{key:"hasTunnels",value:function e(){return this.getAllColumns().some(function(e){return e.marker.links.size>0})}},{key:"getRectArea",value:function e(){var t=this;return this.cache.remember("rectArea",function(){var e=main_core.pos(t.getContainer());e.middle=e.top+e.height/2;return e})}},{key:"getIndex",value:function e(){var t=this;return babelHelpers.toConsumableArray(this.getContainer().parentNode.querySelectorAll(".crm-st-category")).findIndex(function(e){return e===t.getContainer()})}},{key:"getNextCategorySibling",value:function e(){var n=this;return t.instances.find(function(e,t){return t>n.getIndex()})||null}},{key:"onDragStart",value:function e(){main_core.Dom.addClass(this.getContainer(),"crm-st-category-drag");Marker.removeAllLinks();this.dragOffset=jsDD.start_y-this.getRectArea().top;this.dragIndex=this.getIndex();this.dragTargetCategory=this.dragTargetCategory||this}},{key:"onDrag",value:function e(n,a){var r=this;main_core.Tag.style(this.getContainer())(_templateObject$3(),a-this.dragOffset-this.getRectArea().top);var i=this.getRectArea().height;t.instances.forEach(function(e,t){if(e===r||main_core.Dom.hasClass(e.getContainer(),"crm-st-category-stub")){return}var n=e.getContainer();var o=e.getRectArea();var s=o.middle;if(a>s&&t>r.dragIndex&&n.style.transform!=="translate3d(0px, ".concat(-i,"px, 0px)")){main_core.Tag.style(n)(_templateObject2$2(),-i);r.dragTargetCategory=e.getNextCategorySibling();e.cache.delete("rectArea")}if(a<s&&t<r.dragIndex&&n.style.transform!=="translate3d(0px, ".concat(i,"px, 0px)")){main_core.Tag.style(n)(_templateObject3$2(),i);r.dragTargetCategory=e;e.cache.delete("rectArea")}var l=a<s&&t>r.dragIndex&&n.style.transform!==""&&n.style.transform!=="translate3d(0, 0, 0)";var u=a>s&&t<r.dragIndex&&n.style.transform!==""&&n.style.transform!=="translate3d(0, 0, 0)";if(u||l){main_core.Tag.style(n)(_templateObject4$1());r.dragTargetCategory=e;if(!l&&main_core.Dom.hasClass(e.getNextCategorySibling(),"crm-st-category-stub")){r.dragTargetCategory=e.getNextCategorySibling()}e.cache.delete("rectArea")}})}},{key:"onDragStop",value:function e(){main_core.Dom.removeClass(this.getContainer(),"crm-st-category-drag");requestAnimationFrame(function(){Marker.restoreAllLinks()});t.instances.forEach(function(e){main_core.Tag.style(e.getContainer())(_templateObject5());e.cache.delete("rectArea")});if(this.dragTargetCategory){main_core.Dom.insertBefore(this.getContainer(),this.dragTargetCategory.getContainer())}else{main_core.Dom.append(this.getContainer(),this.getContainer().parentElement)}var n=t.instances.map(function(e){return e.getIndex()});t.instances.sort(function(e,t){return e.getIndex()>t.getIndex()?1:-1});var a=t.instances.map(function(e){return e.getIndex()});if(JSON.stringify(n)!==JSON.stringify(a)){this.emit("Category:sort")}}},{key:"getContainer",value:function e(){var t=this;return this.cache.remember("container",function(){return main_core.Tag.render(_templateObject6(),t.id,t.getDragButton(),t.getTitleContainer(),t.getRobotsLink(),t.getRobotsHelpLink(),t.getGeneratorLink(),t.getGeneratorHelpLink(),t.getProgressContainer(),t.getSuccessContainer(),t.getFailContainer())})}},{key:"getRobotsHelpLink",value:function e(){return this.cache.remember("robotsHelpLink",function(){var e=function e(){if(window.top.BX.Helper){window.top.BX.Helper.show("redirect=detail&code=6908975")}};return main_core.Tag.render(_templateObject7(),e,main_core.Text.encode(main_core.Loc.getMessage("CRM_ST_ROBOTS_HELP_BUTTON")))})}},{key:"getGeneratorHelpLink",value:function e(){return this.cache.remember("generatorHelpLink",function(){var e=function e(){if(window.top.BX.Helper){window.top.BX.Helper.show("redirect=detail&code=7530721")}};return main_core.Tag.render(_templateObject8(),e,main_core.Text.encode(main_core.Loc.getMessage("CRM_ST_GENERATOR_HELP_BUTTON")))})}},{key:"getProgressContainer",value:function e(){var t=this;return this.cache.remember("progressContainer",function(){return main_core.Tag.render(_templateObject9(),main_core.Loc.getMessage("CRM_ST_STAGES_GROUP_IN_PROGRESS"),t.getProgressStagesContainer())})}},{key:"getProgressStagesContainer",value:function e(){return this.cache.remember("progressStagesContainer",function(){return main_core.Tag.render(_templateObject10())})}},{key:"getProgressKanban",value:function e(){var n=this;return this.cache.remember("progressKanban",function(){return t.createGrid({renderTo:n.getProgressStagesContainer(),editable:n.canEditTunnels,columns:n.stages.P.map(function(e){return new Column({id:e.STATUS_ID,name:e.NAME,color:e.COLOR.replace("#",""),data:n.getColumnData(e)})})})})}},{key:"getSuccessContainer",value:function e(){var t=this;return this.cache.remember("successContainer",function(){return main_core.Tag.render(_templateObject11(),main_core.Loc.getMessage("CRM_ST_STAGES_GROUP_SUCCESS"),t.getSuccessStagesContainer())})}},{key:"getSuccessStagesContainer",value:function e(){return this.cache.remember("successStagesContainer",function(){return main_core.Tag.render(_templateObject12())})}},{key:"getSuccessKanban",value:function e(){var n=this;return this.cache.remember("successKanban",function(){return t.createGrid({renderTo:n.getSuccessStagesContainer(),canEditColumn:n.canEditTunnels,editable:n.canEditTunnels,canRemoveColumn:n.allowWrite,columns:n.stages.S.map(function(e){return new Column({id:e.STATUS_ID,name:e.NAME,color:e.COLOR.replace("#",""),data:n.getColumnData(e),canRemove:false,canSort:false})})})})}},{key:"getFailContainer",value:function e(){var t=this;return this.cache.remember("failContainer",function(){return main_core.Tag.render(_templateObject13(),main_core.Loc.getMessage("CRM_ST_STAGES_GROUP_FAIL"),t.getFailStagesContainer())})}},{key:"getFailStagesContainer",value:function e(){return this.cache.remember("failStagesContainer",function(){return main_core.Tag.render(_templateObject14())})}},{key:"getFailKanban",value:function e(){var n=this;return this.cache.remember("failKanban",function(){return t.createGrid({renderTo:n.getFailStagesContainer(),editable:n.canEditTunnels,canEditColumn:n.canEditTunnels,canRemoveColumn:n.canEditTunnels,columns:n.stages.F.map(function(e){return new Column({id:e.STATUS_ID,name:e.NAME,color:e.COLOR.replace("#",""),data:n.getColumnData(e)})})})})}},{key:"getColumnData",value:function e(t){var n=this;return{stageId:t.ID,entityId:t.ENTITY_ID,stage:t,onLink:function e(t){n.emit("Column:link",t);n.adjustRobotsLinkIcon()},onRemoveLinkFrom:function e(t){n.emit("Column:removeLinkFrom",t);n.adjustRobotsLinkIcon()},onEditLink:function e(t){n.emit("Column:editLink",t);n.adjustRobotsLinkIcon()},onNameChange:function e(t){n.emit("Column:nameChange",{column:t})},onColorChange:function e(t){n.emit("Column:colorChange",{column:t})},onAddColumn:function e(t){n.emit("Column:addColumn",{column:t})},onRemove:function e(t){n.emit("Column:remove",t)},onChange:function e(t){n.emit("Column:change",{column:t})},onSort:function e(){n.emit("Column:sort",{columns:n.getAllColumns()})},onError:function e(t){n.emit("Column:error",t)},category:this,appContainer:this.appContainer,categoryContainer:this.getFailContainer(),stagesGroups:{progressStagesGroup:this.getProgressContainer(),successStagesGroup:this.getSuccessContainer(),failStagesGroup:this.getFailContainer()},currentStageGroup:this.getFailContainer(),categoryName:this.getTitle().innerText,canEditTunnels:this.canEditTunnels}}},{key:"getRobotsLink",value:function e(){var t=this;return this.cache.remember("robotsLink",function(){var e=t.onRobotsLinkClick.bind(t);return main_core.Tag.render(_templateObject15(),!t.isAvailableRobots?' <span class="tariff-lock"></span>':"",e,main_core.Loc.getMessage("CRM_ST_ROBOT_SETTINGS_LINK_LABEL"))})}},{key:"onRobotsLinkClick",value:function e(t){var n=this;t.preventDefault();if(!this.isAvailableRobots){this.showRobotsRestrictionPopup()}else{BX.SidePanel.Instance.open(this.robotsSettingsLink,{cacheable:false,events:{onClose:function e(){n.emit("Category:slider:close");n.emit("Category:slider:robots:close")}}})}}},{key:"getGeneratorLink",value:function e(){var t=this;return this.cache.remember("generatorLink",function(){var e=t.onGeneratorLinkClick.bind(t);return main_core.Tag.render(_templateObject16(),!t.isAvailableGenerator?' <span class="tariff-lock"></span>':"",e,main_core.Loc.getMessage("CRM_ST_GENERATOR_SETTINGS_LINK_LABEL"))})}},{key:"onGeneratorLinkClick",value:function e(t){var n=this;t.preventDefault();if(!this.isAvailableGenerator){this.showGeneratorRestrictionPopup()}else{BX.SidePanel.Instance.open(this.generatorSettingsLink,{cacheable:false,events:{onClose:function e(){n.emit("Category:slider:close");n.emit("Category:slider:generator:close",{category:n})}}})}}},{key:"getEditButton",value:function e(){var t=this;return this.cache.remember("editButton",function(){return main_core.Tag.render(_templateObject17(),t.onEditButtonClick.bind(t),main_core.Loc.getMessage("CRM_ST_EDIT_CATEGORY_TITLE"))})}},{key:"activateEditButton",value:function e(){main_core.Dom.addClass(this.getEditButton(),"crm-st-edit-button-active")}},{key:"deactivateEditButton",value:function e(){main_core.Dom.removeClass(this.getEditButton(),"crm-st-edit-button-active")}},{key:"onEditButtonClick",value:function e(t){if(t){t.preventDefault()}if(this.isTitleEditEnabled()){this.disableTitleEdit();this.saveTitle();return}this.enableTitleEdit()}},{key:"showTitleEditor",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var n=this.getTitleEditor();var a=this.getTitle(),r=a.innerText;n.value=main_core.Type.isString(t)?t:main_core.Text.decode(r);main_core.Tag.style(n)(_templateObject18())}},{key:"hideTitleEditor",value:function e(){var t=this.getTitleEditor();main_core.Tag.style(t)(_templateObject19())}},{key:"focusOnTitleEditor",value:function e(){var t=this.getTitleEditor();t.focus();var n=this.getTitle();var a=n.innerText.length;t.setSelectionRange(a,a)}},{key:"showTitle",value:function e(){main_core.Tag.style(this.getTitle())(_templateObject20())}},{key:"hideTitle",value:function e(){main_core.Tag.style(this.getTitle())(_templateObject21())}},{key:"saveTitle",value:function e(){var t=this.getTitle();var n=this.getTitleEditor();var a=n.value;var r=main_core.Text.encode(a.trim())||main_core.Loc.getMessage("CRM_ST_TITLE_EDITOR_PLACEHOLDER");if(t.innerHTML!==r){t.innerHTML=r;main_core.Tag.attrs(t)(_templateObject22(),a.trim());this.emit("Category:title:save",{categoryId:this.id,value:r})}}},{key:"enableTitleEdit",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;this.hideTitle();this.showTitleEditor(t);this.activateEditButton();this.focusOnTitleEditor()}},{key:"disableTitleEdit",value:function e(){this.showTitle();this.hideTitleEditor();this.deactivateEditButton()}},{key:"isTitleEditEnabled",value:function e(){return main_core.Dom.hasClass(this.getEditButton(),"crm-st-edit-button-active")}},{key:"getRemoveButton",value:function e(){var t=this;return this.cache.remember("removeButton",function(){var e=main_core.Tag.render(_templateObject23(),t.onRemoveButtonClick.bind(t),main_core.Loc.getMessage("CRM_ST_REMOVE_CATEGORY"));if(String(t.id)==="0"){main_core.Tag.style(e)(_templateObject24())}return e})}},{key:"onRemoveButtonClick",value:function e(){var t=this;this.showConfirmRemovePopup().then(function(e){var n=e.confirm;if(n){t.emit("Category:remove",{categoryId:t.id,onConfirm:function e(){t.remove()},onCancel:function e(){t.removeBlur()}});return}t.removeBlur()});this.addBlur()}},{key:"getAllColumns",value:function e(){var t=this.getProgressKanban().getColumns().sort(function(e,t){return e.getIndex()>t.getIndex()?1:-1});var n=this.getSuccessKanban().getColumns().sort(function(e,t){return e.getIndex()>t.getIndex()?1:-1});var a=this.getFailKanban().getColumns().sort(function(e,t){return e.getIndex()>t.getIndex()?1:-1});return[].concat(babelHelpers.toConsumableArray(t),babelHelpers.toConsumableArray(n),babelHelpers.toConsumableArray(a))}},{key:"addBlur",value:function e(){main_core.Dom.addClass(this.getContainer(),"crm-st-blur");this.getAllColumns().forEach(function(e){e.marker.blurLinks()})}},{key:"removeBlur",value:function e(){main_core.Dom.removeClass(this.getContainer(),"crm-st-blur");Marker.unblurLinks()}},{key:"remove",value:function e(){var n=this;main_core.Dom.remove(this.getContainer());Marker.getAllLinks().forEach(function(e){var t=e.from.data.column;var a=t.getData().category;var r=e.to.data.column;var i=r.getData().category;if(String(a.id)===String(n.id)){e.from.removeLink(e)}if(String(i.id)===String(n.id)){e.to.removeLink(e)}});Marker.getAllStubLinks().forEach(function(e){var t=e.from.data.column;var a=t.getData().category;var r=e.to.data.column;var i=r.getData().category;if(String(a.id)===String(n.id)){e.from.removeStubLink(e)}if(String(i.id)===String(n.id)){e.to.removeStubLink(e)}});t.instances=t.instances.filter(function(e){return e!==n})}},{key:"getTitle",value:function e(){var t=this;return this.cache.remember("title",function(){return main_core.Tag.render(_templateObject25(),t.name,t.name)})}},{key:"getTitleEditor",value:function e(){var t=this;return this.cache.remember("titleEditor",function(){var e=t.onTitleEditorKeyDown.bind(t);var n=t.onTitleEditorBlur.bind(t);return main_core.Tag.render(_templateObject26(),e,n,t.name,main_core.Loc.getMessage("CRM_ST_TITLE_EDITOR_PLACEHOLDER"))})}},{key:"onTitleEditorKeyDown",value:function e(t){t.stopPropagation();if(this.isTitleEditEnabled()){if(t.key.startsWith("Enter")){this.onEditButtonClick()}if(t.key.startsWith("Esc")){this.disableTitleEdit()}}}},{key:"onTitleEditorBlur",value:function e(){if(this.isTitleEditEnabled()){this.onEditButtonClick()}}},{key:"getActionsButtons",value:function e(){var t=this;return this.cache.remember("getActionsButtons",function(){return main_core.Tag.render(_templateObject27(),t.canEditTunnels?t.getEditButton():"",t.canEditTunnels?t.getRemoveButton():"")})}},{key:"getTitleContainer",value:function e(){var t=this;return this.cache.remember("titleContainer",function(){return main_core.Tag.render(_templateObject28(),t.getTitle(),t.getTitleEditor(),t.getActionsButtons())})}},{key:"getDragButton",value:function e(){return this.cache.remember("dragButton",function(){return main_core.Tag.render(_templateObject29(),main_core.Loc.getMessage("CRM_ST_CATEGORY_DRAG_BUTTON"))})}},{key:"isDrawed",value:function e(){return this.drawed}},{key:"draw",value:function e(){if(!this.isDrawed()){this.drawed=true;main_core.Dom.append(this.getContainer(),this.renderTo);this.getProgressKanban().draw();this.getSuccessKanban().draw();this.getFailKanban().draw()}}},{key:"getKanbanColumn",value:function e(t){var n=[].concat(babelHelpers.toConsumableArray(this.getProgressKanban().getColumns()),babelHelpers.toConsumableArray(this.getSuccessKanban().getColumns()),babelHelpers.toConsumableArray(this.getFailKanban().getColumns()));return n.find(function(e){return t===e.getId()||t===e.getData().statusId})}},{key:"showConfirmRemovePopup",value:function e(){var t=this;return new Promise(function(e){void new main_popup.PopupWindow({width:400,overlay:{opacity:30},titleBar:main_core.Loc.getMessage("CRM_ST_REMOVE_CATEGORY_CONFIRM_POPUP_TITLE").replace("#name#",t.getTitle().innerText),content:main_core.Loc.getMessage("CRM_ST_REMOVE_CATEGORY_CONFIRM_POPUP_DESCRIPTION"),buttons:[new main_popup.PopupWindowButton({text:main_core.Loc.getMessage("CRM_ST_REMOVE_CATEGORY_CONFIRM_REMOVE_BUTTON_LABEL"),className:"popup-window-button-decline",events:{click:function t(){e({confirm:true});this.popupWindow.destroy()}}}),new main_popup.PopupWindowButtonLink({text:main_core.Loc.getMessage("CRM_ST_REMOVE_CATEGORY_CONFIRM_CANCEL_BUTTON_LABEL"),events:{click:function t(){e({confirm:false});this.popupWindow.destroy()}}})]}).show()})}},{key:"getRobotsLinkIcon",value:function e(){return this.cache.remember("robotsLinkIcon",function(){return main_core.Tag.render(_templateObject30())})}},{key:"showRobotsLinkIcon",value:function e(){main_core.Dom.insertAfter(this.getRobotsLinkIcon(),this.getRobotsLink())}},{key:"hideRobotsLinkIcon",value:function e(){main_core.Dom.remove(this.getRobotsLinkIcon())}},{key:"adjustRobotsLinkIcon",value:function e(){var t=this;setTimeout(function(){if(t.hasTunnels()){t.showRobotsLinkIcon();return}t.hideRobotsLinkIcon()})}},{key:"getGeneratorLinkIcon",value:function e(){var t=this;return this.cache.remember("generatorLinkIcon",function(){var e=function e(){return window.top.open("/marketing/rc/")};return main_core.Tag.render(_templateObject31(),e,t.generatorsCount)})}},{key:"showGeneratorLinkIcon",value:function e(){main_core.Dom.insertAfter(this.getGeneratorLinkIcon(),this.getGeneratorLink())}}]);return t}(main_core.Event.EventEmitter);babelHelpers.defineProperty(Category,"instances",[]);var Backend=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"request",value:function t(n){var a=n.action,r=n.data,i=n.analyticsLabel;return new Promise(function(t,n){main_core.ajax.runComponentAction(e.component,a,{mode:"ajax",data:{data:r},analyticsLabel:i}).then(t,n)})}},{key:"createCategory",value:function t(n){return e.request({action:"createCategory",analyticsLabel:{component:e.component,action:"create.new.category"},data:n})}},{key:"getCategory",value:function t(n){return e.request({action:"getCategory",analyticsLabel:{component:e.component,action:"get.category"},data:n})}},{key:"updateCategory",value:function t(n){return e.request({action:"updateCategory",analyticsLabel:{component:e.component,action:"update.category"},data:n})}},{key:"removeCategory",value:function t(n){return e.request({action:"removeCategory",analyticsLabel:{component:e.component,action:"remove.category"},data:n})}},{key:"createRobot",value:function t(n){return e.request({action:"createRobot",analyticsLabel:{component:e.component,action:"create.robot"},data:n})}},{key:"removeRobot",value:function t(n){return e.request({action:"removeRobot",analyticsLabel:{component:e.component,action:"remove.robot"},data:n})}},{key:"getRobotSettingsDialog",value:function t(n){return e.request({action:"getRobotSettingsDialog",analyticsLabel:{component:e.component,action:"settings.robot"},data:n})}},{key:"addStage",value:function t(n){return e.request({action:"addStage",analyticsLabel:{component:e.component,action:"add.stage"},data:n})}},{key:"removeStage",value:function t(n){return e.request({action:"removeStage",analyticsLabel:{component:e.component,action:"remove.stage"},data:n})}},{key:"updateStage",value:function t(n){return e.request({action:"updateStage",analyticsLabel:{component:e.component,action:"update.stage"},data:n})}},{key:"updateStages",value:function t(n){return e.request({action:"updateStages",analyticsLabel:{component:e.component,action:"update.stages"},data:n})}},{key:"getCategories",value:function t(){return e.request({action:"getCategories",analyticsLabel:{component:e.component,action:"get.categories"}})}}]);return e}();babelHelpers.defineProperty(Backend,"component","bitrix:crm.sales.tunnels");var CategoryStub=function(e){babelHelpers.inherits(t,e);function t(e){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));main_core.Dom.addClass(n.getContainer(),"crm-st-category-stub");n.getAllColumns().forEach(function(e){e.marker.disable()});return n}return t}(Category);function createStageStubs(e){return Array.from({length:e}).map(function(e,t){return{STATUS_ID:"stub_".concat(t),COLOR:"F1F5F7",NAME:"category stub"}})}function makeErrorMessageFromResponse(e){var t=e.data;if(main_core.Type.isArray(t.errors)&&t.errors.length>0){return t.errors.join("<br>")}return main_core.Loc.getMessage("CRM_ST_SAVE_ERROR")}var Manager=function(){function Manager(e){var t=this;babelHelpers.classCallCheck(this,Manager);this.container=e.container;this.addCategoryButtonTop=e.addCategoryButtonTop;this.helpButton=e.helpButton;this.categoriesOptions=e.categories;this.robotsUrl=e.robotsUrl;this.generatorUrl=e.generatorUrl;this.tunnelScheme=e.tunnelScheme;this.allowWrite=Boolean(e.allowWrite);this.canEditTunnels=Boolean(e.canEditTunnels);this.canAddCategory=Boolean(e.canAddCategory);this.categoriesQuantityLimit=Number(e.categoriesQuantityLimit);this.restrictionPopupCode=e.restrictionPopupCode;this.isAvailableGenerator=e.isAvailableGenerator;this.showGeneratorRestrictionPopup=e.showGeneratorRestrictionPopup;this.isAvailableRobots=e.isAvailableRobots;this.showRobotsRestrictionPopup=e.showRobotsRestrictionPopup;this.categories=new Map;this.cache=new main_core.Cache.MemoryCache;this.initCategories();this.initTunnels();setTimeout(function(){if(!t.hasTunnels()){t.showCategoryStub()}});main_core.Event.bind(this.getAddCategoryButton(),"click",this.onAddCategoryClick.bind(this));main_core.Event.bind(this.addCategoryButtonTop,"click",this.onAddCategoryTopClick.bind(this));main_core.Event.bind(this.helpButton,"click",this.onHelpButtonClick.bind(this))}babelHelpers.createClass(Manager,[{key:"hasTunnels",value:function e(){return this.getTunnels().length>0}},{key:"getContainer",value:function e(){return this.cache.remember("container",function(){return document.querySelector(".crm-st")})}},{key:"getAppContainer",value:function e(){var t=this;return this.cache.remember("appContainer",function(){return t.getContainer().querySelector(".crm-st-container")})}},{key:"getCategoriesContainer",value:function e(){var t=this;return this.cache.remember("categoriesContainer",function(){return t.getAppContainer().querySelector(".crm-st-categories")})}},{key:"getAddCategoryButton",value:function e(){var t=this;return this.cache.remember("addCategoryButton",function(){return t.getContainer().querySelector(".crm-st-add-category-btn")})}},{key:"getMaxSort",value:function e(){return babelHelpers.toConsumableArray(this.categories.values()).reduce(function(e,t){return e>t.sort?e:t.sort},0)}},{key:"onAddCategoryClick",value:function onAddCategoryClick(event){var _this5=this;event.preventDefault();if(this.canAddCategory||this.categoriesQuantityLimit<=0||this.categoriesQuantityLimit>this.categories.size){return Backend.createCategory({name:main_core.Loc.getMessage("CRM_ST_TITLE_EDITOR_PLACEHOLDER"),sort:this.getMaxSort()+10}).then(function(e){_this5.addCategoryFromOptions(e.data);var t=_this5.getStages();var n=[].concat(babelHelpers.toConsumableArray(e.data.STAGES.P),babelHelpers.toConsumableArray(e.data.STAGES.S),babelHelpers.toConsumableArray(e.data.STAGES.F));n.forEach(function(e){return t.push(e)});var a=_this5.getCategory(e.data.ID);a.enableTitleEdit("");a.getAllColumns().forEach(function(e){_this5.tunnelScheme.stages.push({categoryId:e.getData().category.id,stageId:e.getId(),locked:false,tunnels:[]})});if(_this5.isShownCategoryStub()){_this5.hideCategoryStub()}})}else{try{eval(this.restrictionPopupCode)}catch(e){console.error(e)}return Promise.resolve(false)}}},{key:"onAddCategoryTopClick",value:function e(t){this.onAddCategoryClick(t).then(function(e){if(e){window.scrollTo(0,document.body.scrollHeight)}})}},{key:"onHelpButtonClick",value:function e(t){t.preventDefault();if(top.BX.Helper){top.BX.Helper.show("redirect=detail&code=9474707")}}},{key:"getCategoryStub",value:function e(){var t=this;return this.cache.remember("categoryStub",function(){return new CategoryStub({renderTo:t.getCategoriesContainer(),appContainer:t.getAppContainer(),id:"stub",name:"stub",default:false,stages:{P:createStageStubs(5),S:createStageStubs(1),F:createStageStubs(2)},sort:0,robotsSettingsLink:t.robotsUrl,generatorSettingsLink:t.generatorUrl,lazy:true,isAvailableGenerator:true,showGeneratorRestrictionPopup:function e(){},isAvailableRobots:true,showRobotsRestrictionPopup:function e(){}})})}},{key:"showCategoryStub",value:function e(){this.shownCategoryStub=true;var t=this.getCategoryStub();t.draw();var n=babelHelpers.toConsumableArray(this.categories.values())[0];var a=n.getSuccessKanban().getColumns(),r=babelHelpers.slicedToArray(a,1),i=r[0];var o=t.getProgressKanban().getColumns(),s=babelHelpers.slicedToArray(o,1),l=s[0];i.marker.addStubLinkTo(l.marker,true)}},{key:"hideCategoryStub",value:function e(){this.shownCategoryStub=false;this.getCategoryStub().remove();this.cache.delete("categoryStub")}},{key:"isShownCategoryStub",value:function e(){return this.shownCategoryStub}},{key:"adjustCategoryStub",value:function e(){if(!this.hasTunnels()){this.showCategoryStub();return}this.hideCategoryStub()}},{key:"addCategoryFromOptions",value:function e(t){var n=this;var a=new Category({renderTo:this.getCategoriesContainer(),appContainer:this.getAppContainer(),id:t.ID,name:t.NAME,default:t.IS_DEFAULT,stages:t.STAGES,sort:t.SORT,robotsSettingsLink:this.robotsUrl,generatorSettingsLink:this.generatorUrl,generatorsCount:t.RC_COUNT,allowWrite:this.allowWrite,canEditTunnels:this.canEditTunnels,isAvailableGenerator:this.isAvailableGenerator,showGeneratorRestrictionPopup:this.showGeneratorRestrictionPopup,isAvailableRobots:this.isAvailableRobots,showRobotsRestrictionPopup:this.showRobotsRestrictionPopup});a.subscribe("Category:title:save",function(e){var t=e.data,a=t.categoryId,r=t.value;Backend.updateCategory({id:a,fields:{NAME:r}}).then(function(e){var t=e.data;if(t.success){ui_notification.UI.Notification.Center.notify({content:main_core.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"})}else{n.showErrorPopup(makeErrorMessageFromResponse({data:t}))}})}).subscribe("Category:remove",function(e){Backend.removeCategory({id:e.data.categoryId}).then(function(t){var a=t.data;if(a.success){e.data.onConfirm();ui_notification.UI.Notification.Center.notify({content:main_core.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"})}else{e.data.onCancel();n.showErrorPopup(makeErrorMessageFromResponse({data:a}))}setTimeout(function(){if(n.isShownCategoryStub()){n.hideCategoryStub();n.showCategoryStub();return}n.adjustCategoryStub()})})}).subscribe("Column:link",function(e){if(!e.data.preventSave){var t={category:e.data.link.from.getData().column.getData().category.id,stage:e.data.link.from.getData().column.data.stage.STATUS_ID};var a={category:e.data.link.to.getData().column.getData().category.id,stage:e.data.link.to.getData().column.data.stage.STATUS_ID};Backend.createRobot({from:t,to:a}).then(function(e){if(e.data.success){ui_notification.UI.Notification.Center.notify({content:main_core.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"});var t=n.getStages().find(function(t){return String(t.CATEGORY_ID)===String(e.data.tunnel.srcCategory)&&String(t.STATUS_ID)===String(e.data.tunnel.srcStage)});t.TUNNELS.push(e.data.tunnel)}else{n.showErrorPopup(makeErrorMessageFromResponse({data:e.data}))}})}n.hideCategoryStub()}).subscribe("Column:removeLinkFrom",function(e){if(!e.data.preventSave){var t=e.data.link.from.getData().column;var a=e.data.link.to.getData().column;var r=t.getData().category.id;var i=t.getId();var o=a.getData().category.id;var s=a.getId();var l=n.getTunnelByLink(e.data.link);if(l){var u={srcCategory:r,srcStage:i,dstCategory:o,dstStage:s,robot:l.robot};Backend.removeRobot(u).then(function(e){var t=e.data;if(t.success){ui_notification.UI.Notification.Center.notify({content:main_core.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"})}else{n.showErrorPopup(makeErrorMessageFromResponse({data:t}))}});var c=n.getStageDataById(i);c.TUNNELS=c.TUNNELS.filter(function(e){return!(String(e.srcStage)===String(i)&&String(e.srcCategory)===String(r)&&String(e.dstStage)===String(s)&&String(e.dstCategory)===String(o))});n.adjustCategoryStub()}}}).subscribe("Column:editLink",function(e){var t=n.getTunnelByLink(e.data.link);BX.Bizproc.Automation.API.showRobotSettings(t.robot,["crm","CCrmDocumentDeal","DEAL"],t.srcStage,function(a){t.robot=a.serialize();Backend.request({action:"updateRobot",analyticsLabel:{component:Backend.component,action:"update.robot"},data:t}).then(function(r){var i=r.data;if(i.success){ui_notification.UI.Notification.Center.notify({content:main_core.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"});t.dstCategory=a.getProperty("CategoryId");t.dstStage=a.getProperty("StageId");var o=n.getCategory(t.dstCategory);var s=o.getKanbanColumn(t.dstStage);e.data.link.from.updateLink(e.data.link,s.marker,true);n.adjustCategoryStub()}else{n.showErrorPopup(makeErrorMessageFromResponse({data:i}))}})})}).subscribe("Category:sort",function(){var e=Category.instances.filter(function(e){return e.id!=="stub"}).map(function(e,t){return Backend.updateCategory({id:e.id,fields:{SORT:(t+1)*100}})});Promise.all(e).then(function(){ui_notification.UI.Notification.Center.notify({content:main_core.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"})})}).subscribe("Column:remove",function(e){if(!main_core.Type.isNil(e.data.column.data.stageId)){var t=babelHelpers.toConsumableArray(Marker.getAllLinks()).some(function(t){return e.data.column.marker===t.from||e.data.column.marker===t.to});Backend.removeStage({statusId:e.data.column.getId(),stageId:e.data.column.data.stageId,entityId:e.data.column.data.entityId}).then(function(a){if(a.data.success){e.data.onConfirm();if(!t){ui_notification.UI.Notification.Center.notify({content:main_core.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"})}}else{e.data.onCancel();n.showErrorPopup(makeErrorMessageFromResponse({data:a.data}))}})}}).subscribe("Column:change",function(e){Backend.updateStage({statusId:e.data.column.getId(),stageId:e.data.column.data.stageId,entityId:e.data.column.data.entityId,name:e.data.column.getName(),sort:e.data.column.data.stage.SORT,color:e.data.column.getColor()}).then(function(e){var t=e.data;if(t.success){ui_notification.UI.Notification.Center.notify({content:main_core.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"})}else{n.showErrorPopup(makeErrorMessageFromResponse({data:t}))}})}).subscribe("Column:addColumn",function(e){Backend.addStage({name:e.data.column.getGrid().getMessage("COLUMN_TITLE_PLACEHOLDER"),sort:function(){var t=e.data.column;var n=t.getGrid();var a=n.getPreviousColumnSibling(t);return Number(a.data.stage.SORT)+1}(),entityId:function(){var t=e.data.column;var n=t.getGrid();var a=n.getPreviousColumnSibling(t);return a.data.stage.ENTITY_ID}()}).then(function(t){var a=t.data;if(a.success){ui_notification.UI.Notification.Center.notify({content:main_core.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"});var r=e.data.column;var i=a.stage;var o=r.getGrid();var s=o.getPreviousColumnSibling(r);var l=n.getCategory(s.data.category.id);i.TUNNELS=[];n.getStages().push(i);r.setOptions({data:l.getColumnData(i)})}else{n.showErrorPopup(makeErrorMessageFromResponse({data:a}))}})}).subscribe("Column:sort",function(e){var t=e.data.columns.map(function(e,t){var n=(t+1)*100;var a={statusId:e.getId(),stageId:e.data.stageId,entityId:e.data.entityId,name:e.getName(),sort:n};e.data.stage.SORT=n;return a});Backend.updateStages(t).then(function(e){var t=e.data;var a=t.every(function(e){return e.success});if(a){ui_notification.UI.Notification.Center.notify({content:main_core.Loc.getMessage("CRM_ST_NOTIFICATION_CHANGES_SAVED"),autoHideDelay:1500,category:"save"})}else{n.showErrorPopup(makeErrorMessageFromResponse({data:t}))}})}).subscribe("Category:slider:close",function(){n.reload()}).subscribe("Column:error",function(e){n.showErrorPopup(makeErrorMessageFromResponse({data:{errors:[e.data.message]}}))});this.categories.set(String(t.ID),a)}},{key:"showErrorPopup",value:function e(t){if(!this.errorPopup){this.errorPopup=new main_popup.PopupWindow({titleBar:main_core.Loc.getMessage("CRM_ST_ERROR_POPUP_TITLE"),width:350,closeIcon:true,buttons:[new main_popup.PopupWindowButtonLink({id:"close",text:main_core.Loc.getMessage("CRM_ST_ERROR_POPUP_CLOSE_BUTTON_LABEL"),events:{click:function e(){this.popupWindow.close()}}})]})}this.errorPopup.setContent(t);this.errorPopup.show()}},{key:"getSlider",value:function e(){return BX.SidePanel.Instance.getSlider(window.location.pathname)}},{key:"reload",value:function e(){var t=this.getSlider();if(t){t.reload()}}},{key:"getStageDataById",value:function e(t){return this.getStages().find(function(e){return String(e.STATUS_ID)===String(t)})}},{key:"getTunnelByLink",value:function e(t){var n=t.from.getData().column;var a=t.to.getData().column;var r=n.getData().category.id;var i=n.getId();var o=a.getData().category.id;var s=a.getId();var l=this.getStageDataById(i);if(l){return l.TUNNELS.find(function(e){return String(e.srcCategory)===String(r)&&String(e.srcStage)===String(i)&&String(e.dstCategory)===String(o)&&String(e.dstStage)===String(s)})}return null}},{key:"getCategory",value:function e(t){return this.categories.get(String(t))}},{key:"getStages",value:function e(){var t=this;return this.cache.remember("allStages",function(){return t.categoriesOptions.reduce(function(e,t){return[].concat(babelHelpers.toConsumableArray(e),babelHelpers.toConsumableArray(t.STAGES.P),babelHelpers.toConsumableArray(t.STAGES.S),babelHelpers.toConsumableArray(t.STAGES.F))},[])})}},{key:"getTunnels",value:function e(){return this.getStages().reduce(function(e,t){return[].concat(babelHelpers.toConsumableArray(e),babelHelpers.toConsumableArray(t.TUNNELS||[]))},[])}},{key:"initCategories",value:function e(){var t=this;this.categoriesOptions.map(function(e){t.addCategoryFromOptions(e)})}},{key:"initTunnels",value:function e(){var t=this;this.getStages().filter(function(e){return main_core.Type.isArray(e.TUNNELS)&&e.TUNNELS.length}).forEach(function(e){e.TUNNELS.forEach(function(e){var n=t.getCategory(e.srcCategory);var a=t.getCategory(e.dstCategory);if(n&&a){var r=n.getKanbanColumn(e.srcStage);var i=a.getKanbanColumn(e.dstStage);if(r&&i){var o=true;r.marker.addLinkTo(i.marker,o)}}})})}}]);return Manager}();var Kanban={Column:Column,Grid:Grid};exports.Kanban=Kanban;exports.Manager=Manager})(this.BX.Crm.SalesTunnels=this.BX.Crm.SalesTunnels||{},BX.Main,BX,BX,BX,BX);
//# sourceMappingURL=script.map.js