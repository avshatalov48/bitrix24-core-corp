if(typeof BX.CrmEntityLiveFeedActivityList==="undefined"){BX.namespace("BX.Crm.Activity");BX.CrmEntityLiveFeedActivityList=function(){this._wrapper=null;this._container=null;this._activityEditor=null;this._items={};this._activityChangeHandler=BX.delegate(this._onActivityChange,this);this._activitySaveHandler=BX.delegate(this._onAfterActivitySave,this)};BX.CrmEntityLiveFeedActivityList.prototype={initialize:function(t,i){this._id=t;this._settings=i;this._containerId=this.getSetting("containerId");this._container=BX(this._containerId);this._wrapper=this._container.parentNode;var e=this.getSetting("activityEditorId","");if(BX.type.isNotEmptyString(e)&&typeof(BX.CrmActivityEditor!=="undefined")){this._activityEditor=typeof BX.CrmActivityEditor.items[e]!=="undefined"?BX.CrmActivityEditor.items[e]:null}BX.addCustomEvent(window,"onAfterActivitySave",this._activitySaveHandler);if(this._activityEditor){this._activityEditor.addActivityChangeHandler(this._activityChangeHandler)}if(this._container){var n=this.getSetting("data",[]);for(var a=0;a<n.length;a++){var s=n[a];var r=parseInt(s["ID"]);var l=BX.findChild(this._container,{attribute:{"data-entity-id":r}},true,false);if(l){this._items[r.toString()]=BX.CrmEntityLiveFeedActivity.create(r,{activityEditor:this._activityEditor,container:l,clientTemplate:this.getSetting("clientTemplate",""),referenceTemplate:this.getSetting("referenceTemplate",""),params:BX.CrmParamBag.create(s)})}}}},release:function(){BX.removeCustomEvent(window,"onAfterActivitySave",this._activitySaveHandler);if(this._activityEditor){this._activityEditor.removeActivityChangeHandler(this._activityChangeHandler)}for(var t in this._items){if(this._items.hasOwnProperty(t)){this._items[t].release()}}},getSetting:function(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i},setSetting:function(t,i){this._settings[t]=i},_onAfterActivitySave:function(){window.setTimeout(BX.delegate(this.reload,this),500)},_onActivityChange:function(){window.setTimeout(BX.delegate(this.reload,this),500)},reload:function(){var t=BX.prop.getObject(this._settings,"loader",null);if(!t){return}BX.ajax.post(BX.prop.getString(t,"serviceUrl",""),{PARAMS:BX.prop.getObject(t,"componentData",{})},function(t){BX.html(this._wrapper?this._wrapper:document.body,t);this.release()}.bind(this))}};BX.CrmEntityLiveFeedActivityList.create=function(t,i){var e=new BX.CrmEntityLiveFeedActivityList;e.initialize(t,i);return e}}if(typeof BX.CrmEntityLiveFeedActivity==="undefined"){BX.CrmEntityLiveFeedActivity=function(){this._settings={};this._id=0;this._activityEditor=null;this._container=this._completeButton=this._subjectElem=this._timeElem=this._responsibleElem=null;this._params=null;this._enableExternalChange=true;this._completeButtonHandler=BX.delegate(this._onCompleteButtonClick,this);this._titleHandler=BX.delegate(this._onTitleClick,this)};BX.CrmEntityLiveFeedActivity.prototype={initialize:function(t,i){this._id=t;this._settings=i;this._activityEditor=this.getSetting("activityEditor",null);if(!this._activityEditor){throw"BX.CrmEntityLiveFeedActivity: Could not find activityEditor."}this._activityEditor.addActivityChangeHandler(BX.delegate(this._onExternalChange,this));this._container=this.getSetting("container");if(!this._container){throw"BX.CrmEntityLiveFeedActivity: Could not find container."}this._completeButton=BX.findChild(this._container,{className:"crm-right-block-checkbox"},true,false);if(this._completeButton){BX.bind(this._completeButton,"click",this._completeButtonHandler)}this._subjectElem=BX.findChild(this._container,{className:"crm-right-block-item-title-text"},true,false);if(this._subjectElem){BX.bind(this._subjectElem,"click",this._titleHandler)}this._timeElem=BX.findChild(this._container,{className:"crm-right-block-date"},true,false);this._responsibleElem=BX.findChild(this._container,{className:"crm-right-block-name"},true,false);this._bindingElem=BX.findChild(this._container,{className:"crm-right-block-item-label"},true,false);this._params=this.getSetting("params",null);if(!this._params){this._params=BX.CrmParamBag.create()}},release:function(){if(this._completeButton){BX.unbind(this._completeButton,"click",this._completeButtonHandler)}if(this._subjectElem){BX.unbind(this._subjectElem,"click",this._titleHandler)}},getId:function(){return this._id},getSetting:function(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i},setSetting:function(t,i){this._settings[t]=i},isCompleted:function(){return this._params.getBooleanParam("completed",false)},setCompleted:function(t){t=!!t;if(this.isCompleted()!==t){this._enableExternalChange=false;this._activityEditor.setActivityCompleted(this._id,t,BX.delegate(this._onComplete,this))}},layout:function(t){t=!!t;var i=this._params.getIntParam("typeID",0);var e=this._params.getIntParam("direction",0);var n=this._params.getBooleanParam("completed",false);var a="";if(i===BX.CrmActivityType.call){a=e===BX.CrmActivityDirection.incoming?"crm-right-block-call":"crm-right-block-call-to"}else if(i===BX.CrmActivityType.meeting){a="crm-right-block-meet"}else if(i===BX.CrmActivityType.task){a="crm-right-block-task"}if(n){BX.removeClass(this._container,a);BX.addClass(this._container,a+"-done")}else{BX.removeClass(this._container,a+"-done");BX.addClass(this._container,a)}var s=new Date;var r=BX.parseDate(this._params.getParam("deadline"));if(!r){r=new Date}if(this._timeElem){if(!n&&r<=s){BX.addClass(this._container,"crm-right-block-deadline")}else{BX.removeClass(this._container,"crm-right-block-deadline")}}if(t){return}if(this._subjectElem&&this._params.getParam("subject")){this._subjectElem.innerHTML=BX.util.htmlspecialchars(this._params.getParam("subject"))}if(this._completeButton&&this._completeButton.checked!==n){this._completeButton.checked=n}if(this._timeElem){this._timeElem.innerHTML=BX.CrmActivityEditor.trimDateTimeString(BX.date.format(BX.CrmActivityEditor.getDateTimeFormat(),r))}if(this._responsibleElem){this._responsibleElem.innerHTML=BX.util.htmlspecialchars(this._params.getParam("responsibleName"))}if(this._bindingElem){var l=this._params.getParam("clientTitle","");var c=l!==""?this.getSetting("clientTemplate").replace(/#CLIENT#/gi,l):"";var o=this._params.getParam("ownerType","");var h=this._params.getParam("ownerTitle","");var m=h!==""&&(o=="DEAL"||o=="LEAD")?this.getSetting("referenceTemplate").replace(/#REFERENCE#/gi,h):"";var d=c;if(m!==""){if(d!==""){d+=" "}d+=m}this._bindingElem.innerHTML=BX.util.htmlspecialchars(d)}},_onCompleteButtonClick:function(t){this.setCompleted(!this.isCompleted())},_onComplete:function(t){this._enableExternalChange=true;if(BX.type.isBoolean(t["COMPLETED"])){this._params.setParam("completed",t["COMPLETED"])}this.layout(true)},_onTitleClick:function(t){this._activityEditor.viewActivity(this._id);return BX.PreventDefault(t)},_onExternalChange:function(t,i,e){if(!this._enableExternalChange){return}var n=typeof e["ID"]!=="undefined"?parseInt(e["ID"]):0;if(this._id!==n){return}this._params.merge(e);if(BX.type.isArray(e["communications"])){var a=e["communications"];for(var s=0;s<a.length;s++){var r=a[s];var l=r["entityType"];if(l==="CONTACT"||l==="COMPANY"){this._params.setParam("clientTitle",BX.type.isNotEmptyString(r["entityTitle"])?r["entityTitle"]:"");break}}}else{this._params.setParam("clientTitle","")}this.layout(false)}};BX.CrmEntityLiveFeedActivity.create=function(t,i){var e=new BX.CrmEntityLiveFeedActivity;e.initialize(t,i);return e}}