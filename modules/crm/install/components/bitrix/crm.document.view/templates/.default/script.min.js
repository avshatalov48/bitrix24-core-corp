(function(){BX.namespace("BX.Crm.DocumentViewComponent");BX.Crm.DocumentView=function(){this.pdfUrl="";this.printUrl="";this.downloadUrl="";this.editTemplateUrl="";this.editDocumentUrl="";this.emailCommunication=[];this.storageTypeID=0;this.emailDiskFile=0;this.title="";this.sendSmsUrl="";this.values={};this.progress=false;this.transformationError=false;this.progressInterval=0;this.changeStampsEnabled=false;this.changeStampsDisabledReason="";this.myCompanyEditUrl="";this.isTransformationError=false};BX.Crm.DocumentView.init=function(e){this.transformationErrorNode=BX("docs-preview-transform-error");this.previewNode=BX("docs-preview-node");this.imageContainer=BX("crm-document-image");this.documentId=e.id;e.imageContainer=this.imageContainer;e.previewNode=this.previewNode;e.transformationErrorNode=this.transformationErrorNode;e.onReady=BX.proxy(function(e){this.applyOptions(e);this.showError(false);if(this.progressInterval){clearInterval(this.progressInterval)}},this);this.preview=new BX.DocumentGenerator.DocumentPreview(e);this.applyOptions(e);this.initSendButton();this.initButtons();this.initEvents();if(!e.imageUrl&&!this.isTransformationError){this.initPreviewMessage(2)}if(e.documentUrl){window.history.replaceState({},"",e.documentUrl)}};BX.Crm.DocumentView.applyOptions=function(e){if(e.pdfUrl){this.pdfUrl=e.pdfUrl}if(e.printUrl){this.printUrl=e.printUrl}if(e.downloadUrl){this.downloadUrl=e.downloadUrl}if(e.editTemplateUrl){this.editTemplateUrl=e.editTemplateUrl}if(e.editDocumentUrl){this.editDocumentUrl=e.editDocumentUrl}if(e.values){this.values=e.values}if(e.emailCommunication){this.emailCommunication=e.emailCommunication}if(e.emailDiskFile){this.emailDiskFile=e.emailDiskFile}if(e.storageTypeID){this.storageTypeID=e.storageTypeID}if(e.title){this.title=e.title}if(e.transformationError){this.transformationError=e.transformationError}if(e.sendSmsUrl){this.sendSmsUrl=e.sendSmsUrl}if(BX.type.isBoolean(e.changeStampsEnabled)){this.changeStampsEnabled=e.changeStampsEnabled}if(BX.type.isBoolean(e.isTransformationError)){this.isTransformationError=e.isTransformationError}if(e.changeStampsDisabledReason){this.changeStampsDisabledReason=e.changeStampsDisabledReason}if(e.myCompanyEditUrl){this.myCompanyEditUrl=e.myCompanyEditUrl}this.preview.applyOptions(e)};BX.Crm.DocumentView.initSendButton=function(){var e=BX("crm-document-send");if(this.storageTypeID>0||this.sendSmsUrl){BX.bind(e,"click",BX.proxy(function(){BX.PopupMenu.show("crm-document-send-menu",e,[this.storageTypeID>0?{text:BX.message("CRM_DOCUMENT_VIEW_SEND_EMAIL"),onclick:BX.proxy(this.sendEmail,this)}:null,this.sendSmsUrl?{text:BX.message("CRM_DOCUMENT_VIEW_SEND_SMS"),onclick:BX.proxy(this.sendSms,this)}:null],{offsetLeft:0,offsetTop:0,closeByEsc:true})},this))}else{BX.hide(e)}};BX.Crm.DocumentView.sendEmail=function(){if(this.emailDiskFile>0){var e={subject:this.title,communications:this.emailCommunication,diskfiles:[this.emailDiskFile],storageTypeID:this.storageTypeID};BX.CrmActivityEditor.items["document-send-email"].addEmail(e)}else{this.showError(BX.message("CRM_DOCUMENT_VIEW_NO_AVAILABLE_FILES"))}};BX.Crm.DocumentView.sendSms=function(){if(this.sendSmsUrl){if(!BX.hasClass(BX("docs-preview-switcher"),"docs-preview-switcher-off")){if(BX.SidePanel){BX.SidePanel.Instance.open(this.sendSmsUrl,{width:443})}else{top.location.href=this.sendSmsUrl}this.showError(false);return}}this.showError(BX.message("CRM_DOCUMENT_VIEW_SMS_PUBLIC_URL_NECESSARY"))};BX.Crm.DocumentView.closeSlider=function(){var e=BX.SidePanel.Instance.getTopSlider();if(e){e.close()}if(BX.PopupMenu.getCurrentMenu()){BX.PopupMenu.getCurrentMenu().popupWindow.close()}};BX.Crm.DocumentView.initButtons=function(){BX.bind(BX("crm-document-stamp"),"click",BX.proxy(this.showChangeStampsDisabledMessage,this));BX.bind(BX("crm-document-stamp"),"change",BX.proxy(this.onChangeStamps,this));BX.bind(BX("crm-document-edit-template"),"click",BX.proxy(function(e){if(this.editTemplateUrl){if(BX.SidePanel){BX.SidePanel.Instance.open(this.editTemplateUrl,{width:845})}else{top.location.href=this.editTemplateUrl}}e.preventDefault()},this));BX.bind(BX("crm-document-print"),"click",BX.proxy(function(){if(this.printUrl){window.open(this.printUrl,"_blank")}else{this.showError(BX.message("CRM_DOCUMENT_VIEW_TRANSFORMATION_PROGRESS"))}},this));BX.bind(BX("crm-document-download-file"),"click",BX.proxy(function(){if(this.downloadUrl&&!this.progress){window.open(this.downloadUrl,"_blank")}},this));BX.bind(BX("crm-document-download-pdf"),"click",BX.proxy(function(){if(this.pdfUrl){window.open(this.pdfUrl,"_blank")}else{this.showError(BX.message("CRM_DOCUMENT_VIEW_TRANSFORMATION_PROGRESS"))}},this));BX.bind(BX("crm-document-edit-document"),"click",BX.proxy(function(){if(BX.SidePanel){var e="";var t=BX.SidePanel.Instance.getSliderByWindow(window);if(t){e=t.getUrl()}BX.SidePanel.Instance.open(this.editDocumentUrl,{width:500,mode:"edit",sliderUrl:e})}else{top.location.href=this.editDocumentUrl}},this));BX.bind(BX("docs-preview-switcher"),"click",BX.proxy(this.enablePublicUrl,this));BX.bind(BX("crm-document-public-url-container"),"click",BX.proxy(this.handleClickInput,this));BX.bind(BX("crm-document-copy-public-url"),"click",BX.proxy(this.copyPublicUrl,this));BX.bind(BX("crm-document-show-pdf"),"click",BX.proxy(this.showPdf,this))};BX.Crm.DocumentView.showError=function(e){if(e===false){BX.hide(BX("crm-document-view-error"))}if(!e){return}var t="";if(BX.type.isArray(e)){t=e.map(function(e){return e.message}).join("\n")}else{t=e}BX("crm-document-view-error-message").innerText=t;BX.show(BX("crm-document-view-error"))};BX.Crm.DocumentView.showChangeStampsDisabledMessage=function(e){if(this.changeStampsEnabled){return}e.preventDefault();if(this.changeStampsDisabledReason){if(this.popupChangeStampsMessage&&this.popupChangeStampsMessage.isShown()){return}this.popupChangeStampsMessage=new BX.PopupWindow("crm-popup-change-stamps",BX("crm-document-stamp"),{className:"crm-popup-stamps-disabled",bindOptions:{position:"top"},width:230,offsetLeft:90,darkMode:true,angle:true,content:this.changeStampsDisabledReason,autoHide:true});this.popupChangeStampsMessage.show()}};BX.Crm.DocumentView.onChangeStamps=function(){if(this.changeStampsEnabled){this.updateDocument()}};BX.Crm.DocumentView.updateDocument=function(){if(this.progress){return}if(!this.editTemplateUrl){return}this.progress=true;this.pdfUrl="";this.printUrl="";this.emailDiskFile=0;BX("crm-document-stamp").disabled=true;var e=0;if(BX("crm-document-stamp").checked){e=1}if(BX.type.isDomNode(this.preview.imageNode)){BX.hide(this.preview.imageNode)}BX.hide(BX("crm-document-pdf"));BX.hide(this.transformationErrorNode);this.initPreviewMessage(1);this.preview.imageUrl=null;BX.ajax.runAction("crm.documentgenerator.document.update",{data:{stampsEnabled:e,id:this.documentId,values:this.values}}).then(BX.proxy(function(e){this.initPreviewMessage(2);this.progress=false;BX("crm-document-stamp").disabled=false;this.applyOptions(e.data.document);BX.show(BX("crm-document-show-pdf"));var t=BX("pagetitle");if(t){t.innerText=e.data.document.title}},this),BX.proxy(function(e){this.applyOptions(e.data.document);this.progress=false;BX("crm-document-stamp").disabled=false;if(e.data.document.isTransformationError){BX.hide(this.previewNode);BX.show(this.transformationErrorNode)}else{this.initPreviewMessage(0);this.showError(e.errors)}},this))};BX.Crm.DocumentView.enablePublicUrl=function(){if(this.progress){return}BX("crm-document-stamp").disabled=true;var e=0,t;if(BX.hasClass(BX("docs-preview-switcher"),"docs-preview-switcher-off")){e=1;BX.removeClass(BX("docs-preview-switcher"),"docs-preview-switcher-off");BX("crm-document-public-value-container").style.height="47px";t="enablePublicUrl"}else{BX.addClass(BX("docs-preview-switcher"),"docs-preview-switcher-off");BX("crm-document-public-value-container").style.height=0;t="disablePublicUrl"}this.preview.showLoader();BX.ajax.runAction("crm.documentgenerator.document.enablePublicUrl",{analyticsLabel:t,data:{status:e,id:this.documentId}}).then(BX.proxy(function(e){this.progress=false;BX("crm-document-stamp").disabled=false;BX("crm-document-public-url-container").value=e.data.publicUrl||"";this.preview.hideLoader()},this),BX.proxy(function(e){this.progress=false;BX("crm-document-stamp").disabled=false;this.showError(e.errors.pop().message);this.preview.hideLoader()},this))};BX.Crm.DocumentView.initEvents=function(){BX.addCustomEvent("SidePanel.Slider:onMessage",BX.proxy(function(e){if(e.getEventId()==="crm-document-edit"){this.applyOptions(e.getData());this.updateDocument()}},this))};BX.Crm.DocumentView.handleClickInput=function(){var e=BX("crm-document-public-url-container");BX.focus(e);e.setSelectionRange(0,e.value.length)};BX.Crm.DocumentView.copyPublicUrl=function(){this.handleClickInput();document.execCommand("copy");this.showCopyLinkPopup(BX("crm-document-copy-public-url"),BX.message("CRM_DOCUMENT_VIEW_COPY_PUBLIC_URL_MESSAGE"))};BX.Crm.DocumentView.showCopyLinkPopup=function(e,t){if(this.popupOuterLink){return}this.popupOuterLink=new BX.PopupWindow("crm-popup-copy-link",e,{className:"crm-popup-copy-link",bindPosition:{position:"top"},offsetLeft:15,darkMode:true,angle:true,content:t});this.popupOuterLink.show();setTimeout(function(){BX.hide(BX(this.popupOuterLink.uniquePopupId))}.bind(this),2e3);setTimeout(function(){this.popupOuterLink.destroy();this.popupOuterLink=null}.bind(this),2200)};BX.Crm.DocumentView.initPreviewMessage=function(e){if(e!==2&&e!==0){e=1}BX.show(this.previewNode);if(e===0){BX.hide(BX("docs-preview-node-message"));BX.hide(BX("docs-preview-node-detail"));if(this.progressInterval>0){clearInterval(this.progressInterval)}}else if(e===1){BX("docs-preview-node-message").innerText=BX.message("CRM_DOCUMENT_VIEW_PREVIEW_GENERATION_MESSAGE");BX.show(BX("docs-preview-node-message"));BX.hide(BX("docs-preview-node-detail"));this.startProgressBar(BX("docs-progress-bar"),10)}else{BX("docs-preview-node-message").innerText=BX.message("CRM_DOCUMENT_VIEW_PREVIEW_TIME_MESSAGE");BX("docs-preview-node-detail").innerText=BX.message("CRM_DOCUMENT_VIEW_PREVIEW_READY_MESSAGE");BX.show(BX("docs-preview-node-message"));BX.show(BX("docs-preview-node-detail"));this.startProgressBar(BX("docs-progress-bar"),20)}};BX.Crm.DocumentView.startProgressBar=function(e,t,i,s){if(this.progressInterval>0){clearInterval(this.progressInterval)}if(!BX.type.isDomNode(e)){return}if(!BX.type.isNumber(t)){t=20}if(!BX.type.isNumber(i)||i>100){i=0}if(!BX.type.isNumber(s)){s=100}e.style.width=i+"%";var r=100/(t/(s/1e3));this.progressInterval=setInterval(BX.proxy(function(){var t;var i=parseFloat(e.style.width);if(i===100){t=0}else{t=i+r;if(t>100){t=100}}e.style.width=t+"%"},this),s)};BX.Crm.DocumentView.showPdf=function(){if(this.pdfUrl){if(BX("crm-document-pdf").style.display==="block"){return}BX.ajax.runAction("crm.documentgenerator.document.showpdf",{data:{id:this.documentId}}).then(BX.proxy(function(e){var t=this.preview.imageNode;if(t){BX.hide(t)}var i=BX.processHTML(e.data.html);BX("crm-document-pdf").innerHTML=i.HTML;BX.hide(BX("crm-document-show-pdf"));BX.show(BX("crm-document-pdf"));if(!!i.SCRIPT){BX.ajax.processScripts(i.SCRIPT)}},this)).then(function(e){BX.Crm.DocumentView.showError(e.errors.pop().message)})}else{this.showError(BX.message("CRM_DOCUMENT_VIEW_TRANSFORMATION_PROGRESS"))}};BX.Crm.DocumentEdit={};BX.Crm.DocumentEdit.init=function(){BX.bind(BX("crm-document-edit-spoiler"),"click",function(){BX.show(BX("crm-document-edit-all"));BX.hide(BX("crm-document-edit-spoiler"))});this.initForm()};BX.Crm.DocumentEdit.initForm=function(){BX.bind(BX("crm-document-edit-form"),"submit",BX.proxy(this.sendForm,this));BX.bind(BX("crm-document-edit-save"),"click",BX.proxy(this.sendForm,this));BX.bind(BX("crm-document-edit-cancel"),"click",BX.proxy(this.closeSlider,this));BX.bindDelegate(BX("crm-document-edit-form"),"change",{className:"crm-document-edit-select"},BX.proxy(this.refillValues,this))};BX.Crm.DocumentEdit.sendForm=function(e){var t=BX("crm-document-edit-form");var i="";var s={};for(var r=0;r<t.length;r++){if(t.elements[r].name.indexOf("values")!==0){continue}if(t.elements[r].required&&t.elements[r].value.length<=0){i+="<br />"+BX.message("CRM_DOCUMENT_VIEW_COMPONENT_EDIT_FIELD_ERROR").replace("#FIELD#",t.elements[r].previousSibling.innerText)}var n=t.elements[r].name.slice(7,-1);s[n]=t.elements[r].value}if(i.length<=0){if(BX.SidePanel){e.preventDefault();var o=false;var a=BX.SidePanel.Instance.getSliderByWindow(window);if(a.options.mode==="edit"&&BX.type.isNotEmptyString(a.options.sliderUrl)){o=BX.SidePanel.Instance.getSlider(a.options.sliderUrl)}if(o){BX.SidePanel.Instance.postMessage(a,"crm-document-edit",{values:s});this.closeSlider()}else{var d=a.getUrl();d=BX.util.add_url_param(d,this.collectFormData());a.close();BX.SidePanel.Instance.open(d,{width:980,requestMethod:"post"})}}else{}}else{this.showError(i);e.preventDefault()}};BX.Crm.DocumentEdit.collectFormData=function(){var e=BX("crm-document-edit-form");var t={};for(var i=0;i<e.length;i++){if(e.elements[i].getAttribute("bx-default")===e.elements[i].value){continue}t[e.elements[i].name]=e.elements[i].value}if(t.documentId&&t.documentId>0){t.id=t.documentId}else if(t.templateId&&t.templateId>0){t.id=t.templateId}return t};BX.Crm.DocumentEdit.closeSlider=function(){if(BX.SidePanel){var e=BX.SidePanel.Instance.getSliderByWindow(window);if(e){e.close()}}};BX.Crm.DocumentEdit.showError=function(e){BX("crm-document-edit-error").innerHTML=e;BX.show(BX("crm-document-edit-error"))};BX.Crm.DocumentEdit.refillValues=function(){var e="";var t=this.collectFormData();if(t.documentId>0){e="document"}else{e="template"}BX.ajax.runAction("crm.documentgenerator."+e+".getFields",{data:t}).then(function(t){var i=BX("crm-document-edit-form");var s=t.data[e+"Fields"];for(var r in s){if(s.hasOwnProperty(r)){if(typeof s[r].value==="object"&&BX.type.isNotEmptyObject(s[r].value)){var n=BX("field-"+r);if(!n){var o=s[r].group;if(BX.type.isArray(s[r].group)){o=s[r].group[s[r].group.length-1]}var a=BX("crm-document-edit-group-"+o);if(a){var d=BX.findChild(a,{tag:"h3"});if(d){BX.prepend(BX.create("div",{props:{className:"crm-document-edit-item"},children:[BX.create("label",{props:{className:"crm-document-edit-label"},attrs:{for:"field-"+r},text:s[r].title}),BX.create("select",{props:{className:"crm-document-edit-select"},attrs:{name:"values["+r+"]",id:"field-"+r}})]}),BX.nextSibling(d))}}}}}}for(var l=0;l<i.length;l++){var c=i.elements[l].name;var m=i.elements[l];if(i.elements[l].name.indexOf("values")!==0){if(m.tagName!=="SELECT"){continue}}else{c=i.elements[l].name.slice(7,-1)}m.value="";if(m.tagName==="SELECT"){BX.cleanNode(m);BX.hide(m.parentNode)}if(s.hasOwnProperty(c)){if(BX.type.isString(s[c].value)&&m.tagName==="INPUT"||m.tagName==="TEXTAREA"){m.value=s[c].value;if(s[c].hasOwnProperty("default")){m.setAttribute("bx-default",s[c].default)}}else if(typeof s[r].value==="object"&&BX.type.isNotEmptyObject(s[c].value)&&m.tagName==="SELECT"){var p,u;for(p in s[c].value){if(s[c].value.hasOwnProperty(p)){u={value:s[c]["value"][p]["value"]};if(s[c]["value"][p]["selected"]===true){u["selected"]="selected"}m.appendChild(BX.create("option",{attrs:u,text:s[c]["value"][p]["title"]}))}}if(u){BX.show(m.parentNode)}}}}},BX.proxy(function(e){this.showError(e.errors.pop().message)},this))}})(window);
//# sourceMappingURL=script.map.js