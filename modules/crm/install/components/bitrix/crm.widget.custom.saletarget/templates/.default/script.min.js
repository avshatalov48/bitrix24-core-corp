BX.namespace("BX.Crm.Widget.Custom");BX.Crm.Widget.Custom.SaleTarget=function(e){"use strict";var t=function(t){this.loopData={};this.rootNode=e.type.isDomNode(t)?e.clone(t):this.getTemplateNode(t)};t.prototype={getTemplateNode:function(t){var a=window.document.querySelector('[data-template="'+t+'"]');var r=e.create("div",{html:a.innerHTML});this.replaceIncludes(r);return r},getTemplateAttribute:function(e,t){var a=window.document.querySelector('[data-template="'+e+'"]');return a.getAttribute("data-"+t)},replaceIncludes:function(e){var t=e.querySelectorAll("[data-include]");for(var a=0;a<t.length;++a){var r=t[a].getAttribute("data-include");t[a].innerHTML="";t[a].appendChild(this.getTemplateNode(r))}},loop:function(a,r,n){var s=this.rootNode.querySelector('[data-loop="'+a+'"]');if(!s){return false}var i=s.firstElementChild;this.loopData[a]={itemNode:i,loopFn:n};e.cleanNode(s);for(var o=0;o<r.length;++o){var g=new t(i);if(n(g,r[o])!==false){s.appendChild(g.get())}}return true},loopAppend:function(e,a){var r=this.rootNode.querySelector('[data-loop="'+e+'"]');if(!r||!this.loopData[e]){return false}var n=new t(this.loopData[e]["itemNode"]);this.loopData[e]["loopFn"](n,a,true);r.appendChild(n.get());return true},applyIf:function(t,a){a=a.toString();var r=this.rootNode.querySelectorAll('[data-if^="'+t+'="]');for(var n=0;n<r.length;++n){var s=r[n].getAttribute("data-if").split("=")[1];if(s!==a){e.remove(r[n])}}},get:function(e){if(!e)return this.rootNode;return this.rootNode.querySelector('[data-role="'+e+'"]')},getAll:function(e){return Array.prototype.slice.call(this.rootNode.querySelectorAll('[data-role="'+e+'"]'))}};var a={getMonths:function(){return{1:e.message("CRM_WIDGET_SALETARGET_MONTH_JAN"),2:e.message("CRM_WIDGET_SALETARGET_MONTH_FEB"),3:e.message("CRM_WIDGET_SALETARGET_MONTH_MAR"),4:e.message("CRM_WIDGET_SALETARGET_MONTH_APR"),5:e.message("CRM_WIDGET_SALETARGET_MONTH_MAY"),6:e.message("CRM_WIDGET_SALETARGET_MONTH_JUN"),7:e.message("CRM_WIDGET_SALETARGET_MONTH_JUL"),8:e.message("CRM_WIDGET_SALETARGET_MONTH_AUG"),9:e.message("CRM_WIDGET_SALETARGET_MONTH_SEP"),10:e.message("CRM_WIDGET_SALETARGET_MONTH_OCT"),11:e.message("CRM_WIDGET_SALETARGET_MONTH_NOV"),12:e.message("CRM_WIDGET_SALETARGET_MONTH_DEC")}},getDaysOfMonth:function(){return{1:e.message("CRM_WIDGET_SALETARGET_DAY_OF_JAN"),2:e.message("CRM_WIDGET_SALETARGET_DAY_OF_FEB"),3:e.message("CRM_WIDGET_SALETARGET_DAY_OF_MAR"),4:e.message("CRM_WIDGET_SALETARGET_DAY_OF_APR"),5:e.message("CRM_WIDGET_SALETARGET_DAY_OF_MAY"),6:e.message("CRM_WIDGET_SALETARGET_DAY_OF_JUN"),7:e.message("CRM_WIDGET_SALETARGET_DAY_OF_JUL"),8:e.message("CRM_WIDGET_SALETARGET_DAY_OF_AUG"),9:e.message("CRM_WIDGET_SALETARGET_DAY_OF_SEP"),10:e.message("CRM_WIDGET_SALETARGET_DAY_OF_OCT"),11:e.message("CRM_WIDGET_SALETARGET_DAY_OF_NOV"),12:e.message("CRM_WIDGET_SALETARGET_DAY_OF_DEC")}},getQuarters:function(){return{1:e.message("CRM_WIDGET_SALETARGET_QUARTER_1"),2:e.message("CRM_WIDGET_SALETARGET_QUARTER_2"),3:e.message("CRM_WIDGET_SALETARGET_QUARTER_3"),4:e.message("CRM_WIDGET_SALETARGET_QUARTER_4")}},getHalfs:function(){return{1:e.message("CRM_WIDGET_SALETARGET_HALF_YEAR_1"),2:e.message("CRM_WIDGET_SALETARGET_HALF_YEAR_2")}},getDealPluralRules:function(){return[e.message("CRM_WIDGET_SALETARGET_DEAL_PLURAL_1"),e.message("CRM_WIDGET_SALETARGET_DEAL_PLURAL_2"),e.message("CRM_WIDGET_SALETARGET_DEAL_PLURAL_3")]},dealPlural:function(e){e=parseInt(e);var t=0;if(e>20)e=e%10;if(e===1)t=0;else if(e>1&&e<5)t=1;else t=2;return this.getDealPluralRules()[t]},month:function(e){var t=e.getMonth()+1;var a=this.getMonths();return a[t]?a[t]:""},day:function(e){var t=e.getDate(),a=e.getMonth()+1;var r=this.getDaysOfMonth();return(r[a]?r[a]:"").replace("#NUM#",t.toString())},quarter:function(e){var t=1,a=e.getMonth();if(a>8)t=4;else if(a>5)t=3;else if(a>2)t=2;return this.getQuarters()[t]},halfYear:function(e){var t=e.getMonth();var a=t<6?1:2;return this.getHalfs()[a]},number:function(t,a){var r=a?a["DEC_POINT"]:"";var n=a?a["THOUSANDS_SEP"]:" ";return e.util.number_format(t,0,r,n)},target:function(e,t,a){if(t===n.Type.Quantity){return this.number(e,a)+" <span>"+this.dealPlural(e)+"</span>"}e=this.number(e,a);var r="",s=false;var i=a["FORMAT_STRING"].split("#");for(var o=0;o<i.length;++o){if(i[o].length>0){r+="<span>"+i[o]+"</span>"}else if(!s){r+=e;s=true}}return r},copyPeriod:function(t){switch(t){case r.Type.Year:return e.message("CRM_WIDGET_SALETARGET_CONFIG_COPY_Y");break;case r.Type.Half:return e.message("CRM_WIDGET_SALETARGET_CONFIG_COPY_H");break;case r.Type.Quarter:return e.message("CRM_WIDGET_SALETARGET_CONFIG_COPY_Q");break;case r.Type.Month:return e.message("CRM_WIDGET_SALETARGET_CONFIG_COPY_M");break}return e.message("CRM_WIDGET_SALETARGET_CONFIG_COPY_PERIOD")}};var r=function(e){this.type=e.type;this.month=e.month?parseInt(e.month):null;this.year=e.year?parseInt(e.year):null;this.half=e.half?parseInt(e.half):null;this.quarter=e.quarter?parseInt(e.quarter):null;this.calculate()};r.Type={Year:"Y",Half:"H",Quarter:"Q",Month:"M"};r.getTypeList=function(){return[{id:"M",name:e.message("CRM_WIDGET_SALETARGET_CONFIG_PERIOD_TYPE_M")},{id:"Q",name:e.message("CRM_WIDGET_SALETARGET_CONFIG_PERIOD_TYPE_Q")},{id:"H",name:e.message("CRM_WIDGET_SALETARGET_CONFIG_PERIOD_TYPE_H")},{id:"Y",name:e.message("CRM_WIDGET_SALETARGET_CONFIG_PERIOD_TYPE_Y")}]};r.getYearList=function(){var e=2017;var t=(new Date).getFullYear()-e+5;var a=[];for(var r=0;r<=t;++r){a.push({id:e+r,name:(e+r).toString()})}return a};r.getHalfList=function(){return[{id:1,shortName:"I",name:e.message("CRM_WIDGET_SALETARGET_HALF_YEAR_1")},{id:2,shortName:"II",name:e.message("CRM_WIDGET_SALETARGET_HALF_YEAR_2")}]};r.getQuarterList=function(){return[{id:1,shortName:"I",name:e.message("CRM_WIDGET_SALETARGET_QUARTER_1")},{id:2,shortName:"II",name:e.message("CRM_WIDGET_SALETARGET_QUARTER_2")},{id:3,shortName:"III",name:e.message("CRM_WIDGET_SALETARGET_QUARTER_3")},{id:4,shortName:"IV",name:e.message("CRM_WIDGET_SALETARGET_QUARTER_4")}]};r.getMonthList=function(){return[{id:1,name:e.message("CRM_WIDGET_SALETARGET_MONTH_JAN")},{id:2,name:e.message("CRM_WIDGET_SALETARGET_MONTH_FEB")},{id:3,name:e.message("CRM_WIDGET_SALETARGET_MONTH_MAR")},{id:4,name:e.message("CRM_WIDGET_SALETARGET_MONTH_APR")},{id:5,name:e.message("CRM_WIDGET_SALETARGET_MONTH_MAY")},{id:6,name:e.message("CRM_WIDGET_SALETARGET_MONTH_JUN")},{id:7,name:e.message("CRM_WIDGET_SALETARGET_MONTH_JUL")},{id:8,name:e.message("CRM_WIDGET_SALETARGET_MONTH_AUG")},{id:9,name:e.message("CRM_WIDGET_SALETARGET_MONTH_SEP")},{id:10,name:e.message("CRM_WIDGET_SALETARGET_MONTH_OCT")},{id:11,name:e.message("CRM_WIDGET_SALETARGET_MONTH_NOV")},{id:12,name:e.message("CRM_WIDGET_SALETARGET_MONTH_DEC")}]};r.prototype={getId:function(){var e=r.Type.Year+this.year+this.type;switch(this.type){case r.Type.Month:e+=this.month;break;case r.Type.Quarter:e+=this.quarter;break;case r.Type.Half:e+=this.half;break}return e},calculate:function(){switch(this.type){case r.Type.Month:this.calculateMonth();break;case r.Type.Quarter:this.calculateQuarter();break;case r.Type.Half:this.calculateHalf();break;default:this.calculateYear()}},calculateMonth:function(){this.startDate=new Date(this.year,this.month-1,1);this.endDate=new Date(this.year,this.month,0)},calculateQuarter:function(){var e=(this.quarter-1)*3;this.startDate=new Date(this.year,e,1);this.endDate=new Date(this.year,e+3,0)},calculateHalf:function(){var e=this.half===1?0:6;this.startDate=new Date(this.year,e,1);this.endDate=new Date(this.year,e+6,0)},calculateYear:function(){this.startDate=new Date(this.year,0,1);this.endDate=new Date(this.year,11,31)},getLabel:function(){var e,t=this.startDate;switch(this.type){case r.Type.Month:e=a.month(t);break;case r.Type.Half:e=a.halfYear(t);break;case r.Type.Quarter:e=a.quarter(t);break}return(e?e+" ":"")+this.year},getDayPositionPercent:function(e){e.setHours(0,0,0,0);var t=e.getTime();var a=this.startDate.getTime();var r=this.endDate.getTime();if(e<a||e>r)return-1;return(t-a)/(r-a)*100},next:function(){switch(this.type){case r.Type.Month:this.month+=1;if(this.month>12){this.month=1;++this.year}break;case r.Type.Half:this.half+=1;if(this.half>2){this.half=1;++this.year}break;case r.Type.Quarter:this.quarter+=1;if(this.quarter>4){this.quarter=1;++this.year}break;default:++this.year}this.calculate();return this},getLeftBorder:function(){return this.startDate.getTime()/1e3},getRightBorder:function(){return this.endDate.getTime()/1e3}};var n=function(e,t,a,r){this.type=e;this.period=t;this.goal=parseInt(a);this.current=parseInt(r);this.calculate()};n.Type={Sum:"S",Quantity:"Q"};n.getTypeList=function(){return[{id:n.Type.Sum,name:e.message("CRM_WIDGET_SALETARGET_CONFIG_TARGET_TYPE_S")},{id:n.Type.Quantity,name:e.message("CRM_WIDGET_SALETARGET_CONFIG_TARGET_TYPE_Q")}]};n.prototype={calculate:function(){this.remaining=this.goal>this.current?this.goal-this.current:0;this.completedPercent=this.goal>0&&this.current>0?Math.floor(this.current/this.goal*100):0;this.progressPercent=Math.min(100,this.completedPercent)},append:function(e){this.goal+=e.goal;this.current+=e.current;this.calculate();return this}};return{useAutoHeight:function(){return true},prepareButtons:function(t){var a=e.CrmCustomWidget.superclass.prepareButtons.apply(t);if(t._data["attributes"]["isConfigurable"]===true){a["intitle_config"]=e.create("SPAN",{attrs:{className:"crm-widget-settings-text"},text:e.message("CRM_WIDGET_SALETARGET_CONFIG_LABEL"),events:{click:this.openConfigDialog.bind(this,t,null)}})}return a},createContentNode:function(s,i){var o=new t("widget-saletarget-main"),g=i.configuration;if(i.isNew){this.changeConfiguration(null,s,i);return e.create("div")}var l=s.getPanel().getCurrencyFormat();var u=new r(g.period);var _=new n(g.target.type,u,Math.max(0,g.target.totalGoal),i.totalCurrent);o.get("current-period").textContent=u.getLabel();o.get("total-target").innerHTML=a.target(_.goal,_.type,l);o.get("total-complete").innerHTML=a.target(_.current,_.type,l);o.get("total-remaining").innerHTML=a.target(_.remaining,_.type,l);o.get("total-progress-percent").textContent=Math.abs(_.completedPercent);o.applyIf("view-type",g.type);this.dealCategories=e.parseJSON(o.getTemplateAttribute("widget-saletarget-main","categories"));if(g.type==="COMPANY"){this.createCompanyContentNode(o,s,i)}else if(g.type==="CATEGORY"){this.createCategoryContentNode(o,s,i)}else if(g.type==="USER"){this.createUserContentNode(o,s,i)}o.getAll("today").forEach(function(e){e.textContent=a.day(new Date)});o.getAll("first-day").forEach(function(e){e.textContent=a.day(u.startDate)});o.getAll("last-day").forEach(function(e){e.textContent=a.day(u.endDate)});var T=Math.floor(u.getDayPositionPercent(new Date));o.getAll("progress-point").forEach(function(t){if(T>-1){t.style.left=T+"%";if(T<=2&&t.getAttribute("data-left-class")){e.addClass(t,t.getAttribute("data-left-class"))}else if(T>=98&&t.getAttribute("data-right-class")){e.addClass(t,t.getAttribute("data-right-class"))}}else{e.remove(t)}});o.getAll("progress-line").forEach(function(e){e.style.width=_.progressPercent+"%"});o.getAll("progress-total").forEach(function(e){e.textContent=_.completedPercent});if(_.completedPercent>95){o.getAll("progress").forEach(function(t){e.addClass(t,t.getAttribute("data-more-class"))})}if(i.previousConfigurationId>0){e.bind(o.get("previous-period"),"click",this.changeConfiguration.bind(this,i.previousConfigurationId,s,i))}else{e.remove(o.get("previous-period"))}if(i.nextConfigurationId>0){e.bind(o.get("next-period"),"click",this.changeConfiguration.bind(this,i.nextConfigurationId,s,i))}else{e.remove(o.get("next-period"))}return o?o.get():e.create("div",{text:"Invalid widget configuration."})},changeConfiguration:function(t,a,r){var n=this;if(a._contentWrapper.firstElementChild){a._contentWrapper.firstElementChild.style.opacity=.3}var s={sessid:e.bitrix_sessid(),site:e.message("SITE_ID"),action:"get_configuration",configuration_id:t};if(t===null){s.action="get_current_configuration";delete s.configuration_id}e.ajax({url:this.ajaxUrl||"/bitrix/components/bitrix/crm.widget.custom.saletarget/ajax.php",method:"POST",dataType:"json",data:s,onsuccess:function(e){delete r.isNew;r.configuration=e.configuration;r.current=e.current;r.nextConfigurationId=e.nextConfigurationId;r.previousConfigurationId=e.previousConfigurationId;r.totalCurrent=e.totalCurrent;a._contentWrapper.innerHTML="";a._contentWrapper.appendChild(n.createContentNode(a,r))},onfailure:function(){if(a._contentWrapper.firstElementChild){a._contentWrapper.firstElementChild.style.opacity=1}}})},createCompanyContentNode:function(e,t,a){return e},createCategoryContentNode:function(t,s,i){var o=i.configuration;var g=s.getPanel().getCurrencyFormat();var l=new r(o.period);t.loop("categories",this.dealCategories,function(t,r){var s=o.target.goal[r["id"]]||0;var u=i.current[r["id"]]||0;if(s<=0){return false}var _=new n(o.target.type,l,s,u);e.bind(t.get("category-row"),"click",function(t){e.toggleClass(t,t.getAttribute("data-open-class"));e.toggleClass(this,this.getAttribute("data-open-class"))}.bind(t.get("category-target-details"),t.get("category-row")));t.get("category-name").textContent=r.name;t.get("category-progress-line").style.width=_.progressPercent+"%";t.get("category-progress-line-value").textContent=_.completedPercent;if(_.completedPercent>95){e.addClass(t.get("category-progress"),t.get("category-progress").getAttribute("data-more-class"))}t.get("category-target").innerHTML=a.target(_.goal,_.type,g);t.get("category-target-current").innerHTML=a.target(_.current,_.type,g);t.get("category-target-remaining").innerHTML=a.target(_.remaining,_.type,g);t.get("category-target-effective").textContent=Math.abs(_.completedPercent)});return t},createUserContentNode:function(t,s,i){var o=i.configuration;var g=s.getPanel().getCurrencyFormat();var l=new r(o.period);var u=o.users.length<2;t.loop("users",o.users,function(t,r){var s=o.target.goal[r["id"]]||0;var _=i.current[r["id"]]||0;if(s<=0){return false}var T=new n(o.target.type,l,s,_);e.bind(t.get("user-row"),"click",function(t){e.toggleClass(t,t.getAttribute("data-open-class"));e.toggleClass(this,this.getAttribute("data-open-class"))}.bind(t.get("user-target-details"),t.get("user-row")));t.get("user-name").textContent=r.name;t.get("user-title").textContent=r.title;if(r.photo){t.get("user-photo").style.background='url("'+r.photo+'")'}if(!r.active){e.addClass(t.get("user-row"),t.get("user-row").getAttribute("data-inactive-class"))}t.get("user-progress-line").style.width=T.progressPercent+"%";t.get("user-progress-line-value").textContent=T.completedPercent;if(T.completedPercent>95){e.addClass(t.get("user-progress"),t.get("user-progress").getAttribute("data-more-class"))}t.get("user-target").innerHTML=a.target(T.goal,T.type,g);t.get("user-target-current").innerHTML=a.target(T.current,T.type,g);t.get("user-target-remaining").innerHTML=a.target(T.remaining,T.type,g);t.get("user-target-effective").textContent=Math.abs(T.completedPercent);if(u){e.addClass(t.get("user-row"),t.get("user-row").getAttribute("data-open-class"));e.addClass(t.get("user-target-details"),t.get("user-target-details").getAttribute("data-open-class"))}});return t},openConfigDialog:function(t,a){if(!a){a=e.type.isArray(t._data["items"])&&t._data["items"].length>0?t._data["items"][0]:null}new e.Crm.Widget.Custom.SaleTarget.ConfigPopup(t,a,{categories:this.dealCategories}).show()},Template:t,Period:r,Target:n,Label:a}}(window.BX||window.top.BX);
//# sourceMappingURL=script.map.js