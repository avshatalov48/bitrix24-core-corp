BX.namespace("BX.Crm.Widget.Custom.SaleTarget");BX.Crm.Widget.Custom.SaleTarget.UserSelector=function(t){"use strict";var e=function(e){this.id="saletarget-user-selector-"+t.util.getRandomString(7);this.bindTo=e.bindTo;this.selected={};if(e.selected){for(var i=0;i<e.selected.length;++i){this.selected[e.selected[i].id]="user"}}e.selected?t.clone(e.selected):[];this.addCallback=e.addCallback;this.parentPopup=e.parentPopup;this.bind()};e.canUse=function(){return!!t.SocNetLogDestination};e.prototype={bind:function(){t.bind(this.bindTo,"click",this.onBindClick.bind(this));if(this.parentPopup){t.addCustomEvent(this.parentPopup,"onPopupClose",this.onParentPopupClose.bind(this))}},initDialog:function(){if(!e.canUse()){return false}if(this.inited){return true}var i={users:e.data.users||{},department:e.data.department||{},departmentRelation:e.data.departmentRelation||{}};var n={users:e.data.last.USERS||{}};if(!i["departmentRelation"]){i["departmentRelation"]=t.SocNetLogDestination.buildDepartmentRelation(i["department"])}var a=this.addCallback;t.SocNetLogDestination.init({name:this.id,showSearchInput:true,bindMainPopup:{node:this.bindTo,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:true,sendAjaxSearch:true,allowAddUser:false,extranetUser:false,useClientDatabase:false,items:i,itemsLast:n,itemsSelected:this.selected,destSort:e.data.destSort||{},callback:{select:function(e,i,n,s,o,r){if(r!=="select"){return}var d={id:parseInt(e["entityId"]),name:t.util.htmlspecialcharsback(e["name"]),title:t.util.htmlspecialcharsback(e["desc"]),photo:e["avatar"]};a(d);t.SocNetLogDestination.closeDialog()}}});return this.inited=true},onBindClick:function(){if(this.initDialog()){t.SocNetLogDestination.openDialog(this.id)}},onParentPopupClose:function(){if(this.inited){if(t.SocNetLogDestination.isOpenDialog()){t.SocNetLogDestination.closeDialog()}}}};return e}(window.BX||window.top.BX);