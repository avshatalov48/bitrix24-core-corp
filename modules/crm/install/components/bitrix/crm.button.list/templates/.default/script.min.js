var CrmWebFormList=function(t){this.init=function(t){this.context=BX(t.context);this.canEdit=t.canEdit;this.isFramePopup=t.isFramePopup;this.pathToButtonList=t.pathToButtonList;this.nodeHead=this.context.querySelector("[data-bx-list-head]");this.nodeList=this.context.querySelector("[data-bx-list-items]");this.headHideClass="crm-webform-title-close";this.formAttribute="data-bx-crm-webform-item";this.formAttributeIsSystem="data-bx-crm-webform-item-is-system";this.forms=[];this.viewUserOptionName=t.viewUserOptionName;this.detailPageUrlTemplate=t.detailPageUrlTemplate;this.actionRequestUrl=t.actionRequestUrl;this.mess=t.mess||{};this.viewList=t.viewList||{};this.actionList=t.actionList||[];var e=this.context.querySelectorAll("["+this.formAttribute+"]");for(var i=0;i<e.length;i++){this.initItemByNode(e.item(i))}var s=BX("CRM_LIST_DESC_BTN_HIDE");if(s){BX.bind(s,"click",function(){BX.addClass(BX("CRM_LIST_DESC_CONT"),"intranet-button-list-info-hide");BX.userOptions.delay=0;BX.userOptions.save("crm",t.viewUserOptionName,"hide-desc","Y")})}this.initSlider()};this.initItemByNode=function(t){var e=t.getAttribute(this.formAttribute);var i=t.getAttribute(this.formAttributeIsSystem)=="Y";this.initForm({caller:this,id:e,node:t,isSystem:i,viewUserOptionName:this.viewUserOptionName,detailPageUrlTemplate:this.detailPageUrlTemplate,actionRequestUrl:this.actionRequestUrl})};this.onBeforeDeleteForm=function(t){var e=this.forms.filter(function(t){return t.isSystem==false});if(e.length>1){return}BX.addClass(this.nodeHead,this.headHideClass)};this.onAfterDeleteForm=function(t){var e=BX.util.array_search(t,this.forms);if(e>-1){delete this.forms[e]}};this.onRevertDeleteForm=function(t){BX.removeClass(this.nodeHead,this.headHideClass)};this.initForm=function(t){var e=new CrmWebFormListItem(t);this.forms.push(e)};this.initSlider=function(){if(!this.isFramePopup){return}BX.SidePanel.Instance.bindAnchors({rules:[{condition:[this.detailPageUrlTemplate.replace("#id#","(\\d+)").replace("#button_id#","(\\d+)")],loader:"crm-button-view-loader",stopParameters:[]}]})};this.init(t)};function CrmTiledViewListItemCopier(t){this.caller=t.caller;this.manager=t.manager;this.source=t.source;this.copiedNode=null;this.shadowNode=null}CrmTiledViewListItemCopier.prototype={draw:function(){var t=this.source.node.offsetHeight;this.copiedNode=this.source.node.cloneNode(true);this.copiedNode.style.height="0";this.copiedNode.style.opacity="0";this.prepareNode();var e=new CrmWebFormListItemActiveDateController({caller:{node:this.copiedNode}});e.deactivate(true);if(this.manager.nodeList.contains(this.source.node)){this.manager.nodeList.insertBefore(this.copiedNode,this.source.node)}else{this.manager.nodeList.insertBefore(this.copiedNode,this.firstChild)}this.startLoadAnimation();var i=new BX.easing({duration:300,start:{height:0,opacity:0},finish:{height:t,opacity:100},transition:BX.easing.transitions.quint,step:BX.proxy(function(t){this.copiedNode.style.height=t.height+"px";this.copiedNode.style.opacity=t.opacity/100},this)});i.animate()},erase:function(){var t=this.copiedNode.offsetHeight;var e=new BX.easing({duration:700,start:{height:t,opacity:100},finish:{height:-1,opacity:0},transition:BX.easing.transitions.quint,step:BX.proxy(function(t){this.copiedNode.style.height=t.height+"px";this.copiedNode.style.opacity=t.opacity/100},this),complete:BX.proxy(this.remove,this)});e.animate()},remove:function(){BX.remove(this.copiedNode)},getTitleNode:function(){if(!this.copiedNode){return null}return this.copiedNode.querySelector("[data-bx-title]")},prepareNode:function(t){t=t||{};this.copiedNode.setAttribute(this.manager.formAttribute,t.id||"0");this.copiedNode.setAttribute(this.manager.formAttributeIsSystem,"N");var e=this.getTitleNode();if(e){e.innerText=t.title||".  .  ."}var i=this.copiedNode.querySelectorAll("[data-bx-edit-link]");i=BX.convert.nodeListToArray(i);i.forEach(function(e){e.href=t.detailUrl||""})},init:function(t){this.stopLoadAnimation();this.prepareNode({id:t.id,title:t.title,detailUrl:t.detailUrl});this.manager.initItemByNode(this.copiedNode)},startLoadAnimation:function(){this.copiedNode.style.position="relative";this.shadowNode=document.createElement("DIV");BX.addClass(this.shadowNode,"crm-tiled-view-list-edit-item-loading-shadow");this.copiedNode.insertBefore(this.shadowNode,this.copiedNode.firstChild);var t=this.getTitleNode();if(t){BX.addClass(t,"crm-tiled-view-list-edit-item-loading")}},stopLoadAnimation:function(){var t=this.getTitleNode();if(t){BX.removeClass(t,"crm-tiled-view-list-edit-item-loading")}var e=new BX.easing({duration:300,start:{opacity:50},finish:{opacity:70},step:BX.proxy(function(t){this.shadowNode.style.opacity=t.opacity/100},this),complete:BX.proxy(function(){var t=new BX.easing({duration:300,start:{opacity:70},finish:{opacity:0},step:BX.proxy(function(t){this.shadowNode.style.opacity=t.opacity/100},this),complete:BX.proxy(function(){BX.remove(this.shadowNode);this.copiedNode.style.position=""},this)});t.animate()},this)});e.animate()}};function CrmWebFormListItem(t){this.caller=t.caller;this.id=t.id;this.node=t.node;this.isSystem=t.isSystem;this.actionRequestUrl=t.actionRequestUrl;this.viewUserOptionName=t.viewUserOptionName;this.detailPageUrlTemplate=t.detailPageUrlTemplate;this.nodeDelete=this.node.querySelector(".copy-to-buffer-button");this.nodeCopyToClipboard=this.node.querySelector(".copy-to-clipboard-node");this.nodeCopyToClipboardButton=this.node.querySelector(".copy-to-clipboard-button");this.nodeDelete=this.node.querySelector("[data-bx-crm-webform-item-delete]");this.nodeSettings=this.node.querySelector("[data-bx-crm-webform-item-settings]");this.nodeViewSettings=this.node.querySelector("[data-bx-crm-webform-item-view-settings]");this.nodeView=this.node.querySelector("[data-bx-crm-webform-item-view]");this.nodeBtnGetScript=this.node.querySelector("[data-bx-crm-webform-item-btn-getscript]");this.isActiveControlLocked=false;this.popupSettings=null;this.popupViewSettings=null;this.activeController=new CrmWebFormListItemActiveDateController({caller:this});this.bindControls(t)}CrmWebFormListItem.prototype={showViewSettings:function(){var t=[];var e=this.getCurrentViewType();for(var i in this.caller.viewList){if(!this.caller.viewList.hasOwnProperty(i))continue;var s=this.caller.viewList[i];t.push({id:i,text:s["NAME"],className:e==i?"view-settings-menu-sort-item-checked":"view-settings-menu-sort-item-checked-no",onclick:BX.proxy(this.onClickViewSettingsItem,this)})}if(!this.popupViewSettings){this.popupViewSettings=this.createPopup("crm_webform_list_view_settings_"+this.id,this.nodeViewSettings,t)}else{t.forEach(function(t){var e=this.popupViewSettings.getMenuItem(t.id);e.className=t.className;BX.removeClass(e.layout.item,"view-settings-menu-sort-item-checked");BX.addClass(e.layout.item,e.className)},this)}this.popupViewSettings.popupWindow.show()},showSettings:function(){if(!this.popupSettings){var t=[];var e=this.caller.actionList[this.isSystem?"SYSTEM":"USER"];for(var i in e){if(!e.hasOwnProperty(i))continue;var s=e[i];var o={id:s.id,text:s.text,link:s.url};switch(o.id){case"view":case"edit":o.onclick=BX.proxy(function(){this.redirectToDetailPage(this.id);this.popupSettings.close()},this);break;case"copy":o.onclick=BX.proxy(function(){this.copy();this.popupSettings.close()},this);break;case"reset_counters":o.onclick=BX.proxy(function(){this.resetCounters();this.popupSettings.close()},this);break}t.push(o)}this.popupSettings=this.createPopup("crm_webform_list_settings_"+this.id,this.nodeSettings,t,{offsetLeft:-30,offsetTop:10})}this.popupSettings.popupWindow.show()},onClickViewSettingsItem:function(t,e){var i=this.caller.viewList[e.id];i.id=e.id;this.closePopup(this.popupViewSettings);this.changeViewType(i)},getCurrentViewType:function(){var t=null;for(var e in this.caller.viewList){if(!this.caller.viewList.hasOwnProperty(e))continue;if(!t)t=e;var i=this.caller.viewList[e]["CLASS_NAME"];if(BX.hasClass(this.nodeView,i)){return e}}return t},changeViewType:function(t){for(var e in this.caller.viewList){if(!this.caller.viewList.hasOwnProperty(e))continue;var i=this.caller.viewList[e]["CLASS_NAME"];var s=this.nodeView.querySelector('[data-bx-crm-webform-view-info="'+e+'"]');var o=t.id==e;this.changeClass(this.nodeView,i,o);this.changeClass(s,"intranet-button-list-widget-content-item-show",o)}BX.userOptions.save("crm",this.viewUserOptionName,this.id,t.id)},showErrorPopup:function(t){t=t||{};var e=t.text||this.caller.mess.errorAction;var i=BX.PopupWindowManager.create("crm_webform_list_error",null,{autoHide:true,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500}});i.setButtons([new BX.PopupWindowButton({text:this.caller.mess.dlgBtnClose,events:{click:function(){this.popupWindow.close()}}})]);i.setContent('<span class="crm-webform-edit-warning-popup-alert">'+e+"</span>");i.show()},showConfirmPopup:function(t){t=t||{};var e=t.text||this.caller.mess.confirmAction;var i=BX.PopupWindowManager.create("crm_webform_list_confirm",null,{autoHide:true,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500}});i.setButtons([new BX.PopupWindowButton({text:this.caller.mess.dlgBtnApply,className:"popup-window-button-accept",events:{click:function(){this.popupWindow.close();t.action.apply(this,[])}}}),new BX.PopupWindowButton({text:this.caller.mess.dlgBtnCancel,events:{click:function(){this.popupWindow.close()}}})]);i.setContent('<span class="crm-webform-edit-warning-popup-confirm">'+e+"</span>");i.show()},changeActive:function(t,e){if(!this.caller.canEdit){return}e=e||false;if(this.isActiveControlLocked){return}var i=this.activeController.isActive();if(i){this.activeController.deactivate()}else{this.activeController.activate()}if(e){return}this.isActiveControlLocked=true;this.sendActionRequest(i?"deactivate":"activate",function(t){this.isActiveControlLocked=false},function(t){t=t||{error:true,text:""};this.isActiveControlLocked=false;this.activeController.revert();if(t.limited){if(!B24||!B24["licenseInfoPopup"]){return}B24.licenseInfoPopup.show("crm_webform_activation",this.caller.mess.dlgActiveCountLimitedTitle,"<span>"+this.caller.mess.dlgActiveCountLimitedText+"</span>")}else{this.showErrorPopup(t)}})},getDetailPageById:function(t){return this.detailPageUrlTemplate.replace("#id#",t).replace("#button_id#",t)},redirectToDetailPage:function(t,e){e=e||false;var i=this.getDetailPageById(t);if(this.caller.isFramePopup){if(!e){BX.SidePanel.Instance.open(i)}}else{window.location=i}},resetCounters:function(){this.sendActionRequest("reset_counters",function(){window.location.reload()})},copy:function(){var t=new CrmTiledViewListItemCopier({manager:this.caller,source:this});t.draw();this.sendActionRequest("copy",function(e){t.init({id:e.copiedId,title:e.copiedName,detailUrl:this.getDetailPageById(e.copiedId)});this.redirectToDetailPage(e.copiedId,true)},function(){t.erase()})},delete:function(){this.showConfirmPopup({text:this.caller.mess.deleteConfirmation,action:BX.proxy(function(){var t="crm-webform-row-close";BX.addClass(this.node,t);this.caller.onBeforeDeleteForm(this);this.sendActionRequest("delete",function(t){this.caller.onAfterDeleteForm(this)},function(e){BX.removeClass(this.node,t);this.caller.onRevertDeleteForm(this);this.showErrorPopup(e)})},this)})},sendActionRequest:function(t,e,i){e=e||null;i=i||BX.proxy(this.showErrorPopup,this);BX.ajax({url:this.actionRequestUrl,method:"POST",data:{action:t,button_id:this.id,sessid:BX.bitrix_sessid()},timeout:30,dataType:"json",processData:true,onsuccess:BX.proxy(function(t){t=t||{};if(t.error){i.apply(this,[t])}else if(e){e.apply(this,[t])}},this),onfailure:BX.proxy(function(){var t={error:true,text:""};i.apply(this,[t])},this)})},showScriptPopup:function(){BX.addClass(this.nodeBtnGetScript,"webform-small-button-wait");this.sendActionRequest("show_script",function(t){var e=this.createScriptPopup();this.scriptPopup.crmCopyScriptContainer.innerHTML=t.html;BX.removeClass(this.nodeBtnGetScript,"webform-small-button-wait");e.show()},function(t){BX.removeClass(this.nodeBtnGetScript,"webform-small-button-wait");this.showErrorPopup(t)})},createScriptPopup:function(t){if(this.scriptPopup){return this.scriptPopup}t=t||{};var e=BX("SCRIPT_CONTAINER");this.scriptPopup=BX.PopupWindowManager.create("crm_webform_list_script_popup",null,{titleBar:this.caller.mess.dlgGetScriptTitle,content:e,contentColor:"white",closeIcon:true,autoHide:true,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500}});this.scriptPopup.crmCopyScriptContainer=e.querySelector("[data-bx-webform-script-copy-text]");var i=[];if(BX.clipboard.isCopySupported()){var s=new BX.PopupWindowButton({text:this.caller.mess.dlgBtnCopyToClipboard,className:"webform-small-button-blue",events:{click:function(){}}});i.push(s);BX.clipboard.bindCopyClick(s.buttonNode,{text:this.scriptPopup.crmCopyScriptContainer})}i.push(new BX.PopupWindowButton({text:this.caller.mess.dlgBtnClose,events:{click:function(){this.popupWindow.close()}}}));this.scriptPopup.setButtons(i);return this.scriptPopup},bindControls:function(){BX.clipboard.bindCopyClick(this.nodeCopyToClipboardButton,{text:this.nodeCopyToClipboard});BX.bind(this.nodeDelete,"click",BX.proxy(this.delete,this));BX.bind(this.activeController.nodeActiveControl,"click",BX.proxy(this.changeActive,this));BX.bind(this.activeController.nodeButton,"click",BX.proxy(this.changeActive,this));BX.bind(this.nodeSettings,"click",BX.proxy(this.showSettings,this));BX.bind(this.nodeViewSettings,"click",BX.proxy(this.showViewSettings,this));BX.bind(this.nodeBtnGetScript,"click",BX.proxy(this.showScriptPopup,this))},changeClass:function(t,e,i){i=i||false;if(!t){return}if(i){BX.addClass(t,e)}else{BX.removeClass(t,e)}},styleDisplay:function(t,e,i){e=e||false;i=i||"";if(!t){return}t.style.display=e?i:"none"},createPopup:function(t,e,i,s){s=s||{};return BX.PopupMenu.create(t,e,i,{autoHide:true,offsetLeft:s.offsetLeft?s.offsetLeft:-21,offsetTop:s.offsetTop?s.offsetTop:-3,angle:{position:"top",offset:42},events:{onPopupClose:BX.delegate(this.onPopupClose,this)}})},closePopup:function(t){if(t&&t.popupWindow){t.popupWindow.close()}},onPopupClose:function(){}};function CrmWebFormListItemActiveDateController(t){this.caller=t.caller;this.nodeActiveControl=this.caller.node.querySelector("[data-bx-crm-webform-item-active]");this.nodeDate=this.caller.node.querySelector("[data-bx-crm-webform-item-active-date]");this.classDateNow="user-container-show-now";this.classDateNowState="user-container-show-now-deact";this.classOn="intranet-button-list-on";this.classOff="intranet-button-list-off";this.nodeView=this.caller.node.querySelector("[data-bx-crm-webform-item-view]");this.nodeButton=this.caller.node.querySelector("[data-bx-crm-webform-item-active-btn]");this.classBtnOn="webform-small-button-transparent";this.classBtnOff="webform-small-button-accept";this.classViewInactive="intranet-button-list-widget-inactive";this.isNowShowedCounter=0;this.isRevert=false}CrmWebFormListItemActiveDateController.prototype={isActive:function(){return BX.hasClass(this.nodeButton,this.classBtnOn)},revert:function(){this.isRevert=true;this.toggle();if(this.isNowShowedCounter<2){this.isNowShowedCounter=0}this.isRevert=false},toggle:function(){if(this.isActive()){this.deactivate()}else{this.activate()}},activate:function(){BX.addClass(this.nodeActiveControl,this.classOn);BX.removeClass(this.nodeActiveControl,this.classOff);this.actualizeButton();this.actualizeDate()},deactivate:function(t){BX.removeClass(this.nodeActiveControl,this.classOn);BX.addClass(this.nodeActiveControl,this.classOff);this.actualizeButton(t);this.actualizeDate()},actualizeButton:function(t){var e=t?true:this.isActive();this.changeClass(this.nodeView,this.classViewInactive,e);this.changeClass(this.nodeButton,this.classBtnOn,!e);this.changeClass(this.nodeButton,this.classBtnOff,e);this.nodeButton.innerText=e?this.nodeButton.getAttribute("data-bx-text-on"):this.nodeButton.getAttribute("data-bx-text-off")},actualizeDate:function(){this.changeClass(this.nodeDate,this.classDateNowState,!this.isActive());var t=!this.isRevert||this.isNowShowedCounter>1;this.changeClass(this.nodeDate,this.classDateNow,t);this.isNowShowedCounter++},changeClass:function(t,e,i){i=i||false;if(!t){return}if(i){BX.addClass(t,e)}else{BX.removeClass(t,e)}}};