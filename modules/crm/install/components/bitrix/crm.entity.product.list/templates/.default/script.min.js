this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};this.BX.Crm.Entity=this.BX.Crm.Entity||{};(function(e,t,i,n,a,r,s){"use strict";var o=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"_settings",{});this._settings=t?t:{};this.eventHandlers={}}babelHelpers.createClass(e,[{key:"registerEventHandler",value:function e(t,i){if(!this.eventHandlers[t])this.eventHandlers[t]=[];this.eventHandlers[t].push(i);BX.addCustomEvent(this,t,i)}},{key:"fireEvent",value:function e(t,i){BX.onCustomEvent(this,t,i)}},{key:"unregisterEventHandlers",value:function e(t){if(this.eventHandlers[t]){for(var i=0;i<this.eventHandlers[t].length;i++){BX.removeCustomEvent(this,t,this.eventHandlers[t][i])}delete this.eventHandlers[t]}}}]);return e}();function u(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<label class="ui-ctl-block ui-entity-editor-popup-create-field-item ui-ctl-w100">\n\t\t\t\t<div class="ui-ctl-w10" style="text-align: center">','</div>\n\t\t\t\t<div class="ui-ctl-w75">\n\t\t\t\t\t<span class="ui-entity-editor-popup-create-field-item-title">',"</span>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</label>\n\t\t"]);u=function t(){return e};return e}function l(){var e=babelHelpers.taggedTemplateLiteral(['<span class="ui-entity-editor-popup-create-field-item-desc">',"</span>"]);l=function t(){return e};return e}function d(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="checkbox">\n\t\t']);d=function t(){return e};return e}function c(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div class='ui-entity-editor-popup-create-field-list'></div>\n\t\t"]);c=function t(){return e};return e}function h(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var g=new WeakMap;var f=new WeakMap;var v=new WeakMap;var p=new WeakMap;var y=new WeakSet;var E=new WeakSet;var T=new WeakSet;var C=new WeakSet;var b=new WeakSet;var P=new WeakSet;var m=function(){function e(t){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var a=arguments.length>2?arguments[2]:undefined;babelHelpers.classCallCheck(this,e);P.add(this);b.add(this);C.add(this);T.add(this);E.add(this);y.add(this);g.set(this,{writable:true,value:void 0});f.set(this,{writable:true,value:void 0});v.set(this,{writable:true,value:void 0});p.set(this,{writable:true,value:new i.Cache.MemoryCache});babelHelpers.classPrivateFieldSet(this,g,t);babelHelpers.classPrivateFieldSet(this,f,n);babelHelpers.classPrivateFieldSet(this,v,a)}babelHelpers.createClass(e,[{key:"show",value:function e(){this.getPopup().show()}},{key:"getPopup",value:function e(){var i=this;return babelHelpers.classPrivateFieldGet(this,p).remember("settings-popup",function(){return new t.Popup(babelHelpers.classPrivateFieldGet(i,v).getId()+"_"+Math.random()*100,babelHelpers.classPrivateFieldGet(i,g),{autoHide:true,draggable:false,offsetLeft:0,offsetTop:0,angle:{position:"top",offset:43},noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,content:h(i,E,D).call(i)})})}},{key:"updateCheckboxState",value:function e(){var t=this;var n=this.getPopup().getContentContainer();babelHelpers.classPrivateFieldGet(this,f).filter(function(e){return e.action==="grid"&&i.Type.isArray(e.columns)}).forEach(function(e){var a=true;e.columns.forEach(function(e){if(!babelHelpers.classPrivateFieldGet(t,v).getGrid().getColumnHeaderCellByName(e)){a=false}});var r=n.querySelector('input[data-setting-id="'+e.id+'"]');if(i.Type.isDomNode(r)){r.checked=a}})}}]);return e}();var I=function e(t){return babelHelpers.classPrivateFieldGet(this,f).filter(function(e){return e.id===t})[0]};var D=function e(){var t=this;var n=i.Tag.render(c());babelHelpers.classPrivateFieldGet(this,f).forEach(function(e){n.append(h(t,T,k).call(t,e))});return n};var k=function e(t){var n=i.Tag.render(d());n.checked=t.checked;n.dataset.settingId=t.id;var a=i.Type.isStringFilled(t.desc)?i.Tag.render(l(),t.desc):"";var r=i.Tag.render(u(),n,t.title,a);i.Event.bind(r,"change",h(this,C,S).bind(this));return r};var S=function e(t){var i=h(this,y,I).call(this,t.target.dataset.settingId);if(!i){return}var n=t.target.checked;h(this,b,F).call(this,i,n)};var F=function e(t,n){var a=this;var r=[];var s=babelHelpers.classPrivateFieldGet(this,v).getGrid().getRows().getHeadFirstChild().getCells();Array.from(s).forEach(function(e){if("name"in e.dataset){r.push(e.dataset.name)}});i.ajax.runComponentAction(babelHelpers.classPrivateFieldGet(this,v).getComponentName(),"setGridSetting",{mode:"class",data:{signedParameters:babelHelpers.classPrivateFieldGet(this,v).getSignedParameters(),settingId:t.id,selected:n,currentHeaders:r}}).then(function(){t.checked=n;if(t.id==="ADD_NEW_ROW_TOP"){var e=n?"top":"bottom";babelHelpers.classPrivateFieldGet(a,v).setSettingValue("newRowPosition",e);var r=babelHelpers.classPrivateFieldGet(a,v).changeActivePanelButtons(e);var s=r.querySelector('[data-role="product-list-settings-button"]');a.getPopup().setBindElement(s)}else{babelHelpers.classPrivateFieldGet(a,v).reloadGrid()}a.getPopup().close();var o=n?i.Loc.getMessage("CRM_ENTITY_PL_SETTING_ENABLED"):i.Loc.getMessage("CRM_ENTITY_PL_SETTING_DISABLED");h(a,P,R).call(a,o.replace("#NAME#",t.title),{category:"popup-settings"})})};var R=function e(t,i){i=i||{};BX.UI.Notification.Center.notify({content:t,stack:i.stack||null,position:"top-right",width:"auto",category:i.category||null,autoHideDelay:i.autoHideDelay||3e3})};function N(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<a \n\t\t\t\t\thref="#"\n\t\t\t\t\tclass="main-grid-delete-button" \n\t\t\t\t\tonclick="','"\n\t\t\t\t\ttitle="','"\n\t\t\t\t></a>\n\t\t\t']);N=function t(){return e};return e}function A(e,t){var i;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(i=U(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var a=function e(){};return{s:a,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,s=false,o;return{s:function t(){i=e[Symbol.iterator]()},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){s=true;o=t},f:function e(){try{if(!r&&i.return!=null)i.return()}finally{if(s)throw o}}}}function U(e,t){if(!e)return;if(typeof e==="string")return w(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return w(e,t)}function w(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++){n[i]=e[i]}return n}var _="template_0";var O=2;var x=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"products",[]);babelHelpers.defineProperty(this,"cache",new i.Cache.MemoryCache);babelHelpers.defineProperty(this,"actions",{productChange:"productChange",productListChanged:"productListChanged",updateListField:"listField",stateChanged:"stateChange",updateTotal:"total"});babelHelpers.defineProperty(this,"stateChange",{changed:false,sended:false});babelHelpers.defineProperty(this,"updateFieldForList",null);babelHelpers.defineProperty(this,"totalData",{inProgress:false});babelHelpers.defineProperty(this,"productSelectionPopupHandler",this.handleProductSelectionPopup.bind(this));babelHelpers.defineProperty(this,"productRowAddHandler",this.handleProductRowAdd.bind(this));babelHelpers.defineProperty(this,"showSettingsPopupHandler",this.handleShowSettingsPopup.bind(this));babelHelpers.defineProperty(this,"onDialogSelectProductHandler",this.handleOnDialogSelectProduct.bind(this));babelHelpers.defineProperty(this,"onSaveHandler",this.handleOnSave.bind(this));babelHelpers.defineProperty(this,"onInnerCancelHandler",this.handleOnInnerCancel.bind(this));babelHelpers.defineProperty(this,"onBeforeGridRequestHandler",this.handleOnBeforeGridRequest.bind(this));babelHelpers.defineProperty(this,"onGridUpdatedHandler",this.handleOnGridUpdated.bind(this));babelHelpers.defineProperty(this,"onGridRowMovedHandler",this.handleOnGridRowMoved.bind(this));babelHelpers.defineProperty(this,"onBeforeProductChangeHandler",this.handleOnBeforeProductChange.bind(this));babelHelpers.defineProperty(this,"onProductChangeHandler",this.handleOnProductChange.bind(this));babelHelpers.defineProperty(this,"onProductClearHandler",this.handleOnProductClear.bind(this));babelHelpers.defineProperty(this,"dropdownChangeHandler",this.handleDropdownChange.bind(this));babelHelpers.defineProperty(this,"changeProductFieldHandler",this.handleFieldChange.bind(this));babelHelpers.defineProperty(this,"updateTotalDataDelayedHandler",i.Runtime.debounce(this.updateTotalDataDelayed,1e3,this));this.setId(t)}babelHelpers.createClass(e,[{key:"init",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.setSettings(t);if(this.canEdit()){this.addFirstRowIfEmpty();this.enableEdit()}this.initForm();this.initProducts();this.initGridData();n.EventEmitter.emit(window,"EntityProductListController",[this]);this.subscribeDomEvents();this.subscribeCustomEvents()}},{key:"subscribeDomEvents",value:function e(){var t=this;var n=this.getContainer();if(i.Type.isElementNode(n)){n.querySelectorAll('[data-role="product-list-select-button"]').forEach(function(e){i.Event.bind(e,"click",t.productSelectionPopupHandler)});n.querySelectorAll('[data-role="product-list-add-button"]').forEach(function(e){i.Event.bind(e,"click",t.productRowAddHandler)});n.querySelectorAll('[data-role="product-list-settings-button"]').forEach(function(e){i.Event.bind(e,"click",t.showSettingsPopupHandler)})}}},{key:"unsubscribeDomEvents",value:function e(){var t=this;var n=this.getContainer();if(i.Type.isElementNode(n)){n.querySelectorAll('[data-role="product-list-select-button"]').forEach(function(e){i.Event.unbind(e,"click",t.productSelectionPopupHandler)});n.querySelectorAll('[data-role="product-list-add-button"]').forEach(function(e){i.Event.unbind(e,"click",t.productRowAddHandler)});n.querySelectorAll('[data-role="product-list-settings-button"]').forEach(function(e){i.Event.unbind(e,"click",t.showSettingsPopupHandler)})}}},{key:"subscribeCustomEvents",value:function e(){n.EventEmitter.subscribe("CrmProductSearchDialog_SelectProduct",this.onDialogSelectProductHandler);n.EventEmitter.subscribe("BX.Crm.EntityEditor:onSave",this.onSaveHandler);n.EventEmitter.subscribe("EntityProductListController:onInnerCancel",this.onInnerCancelHandler);n.EventEmitter.subscribe("Grid::beforeRequest",this.onBeforeGridRequestHandler);n.EventEmitter.subscribe("Grid::updated",this.onGridUpdatedHandler);n.EventEmitter.subscribe("Grid::rowMoved",this.onGridRowMovedHandler);n.EventEmitter.subscribe("BX.Catalog.ProductSelector:onBeforeChange",this.onBeforeProductChangeHandler);n.EventEmitter.subscribe("BX.Catalog.ProductSelector:onChange",this.onProductChangeHandler);n.EventEmitter.subscribe("BX.Catalog.ProductSelector:onClear",this.onProductClearHandler);n.EventEmitter.subscribe("Dropdown::change",this.dropdownChangeHandler)}},{key:"unsubscribeCustomEvents",value:function e(){n.EventEmitter.unsubscribe("CrmProductSearchDialog_SelectProduct",this.onDialogSelectProductHandler);n.EventEmitter.unsubscribe("BX.Crm.EntityEditor:onSave",this.onSaveHandler);n.EventEmitter.unsubscribe("EntityProductListController:onInnerCancel",this.onInnerCancelHandler);n.EventEmitter.unsubscribe("Grid::beforeRequest",this.onBeforeGridRequestHandler);n.EventEmitter.unsubscribe("Grid::updated",this.onGridUpdatedHandler);n.EventEmitter.unsubscribe("Grid::rowMoved",this.onGridRowMovedHandler);n.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onBeforeChange",this.onBeforeProductChangeHandler);n.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onChange",this.onProductChangeHandler);n.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onClear",this.onProductClearHandler);n.EventEmitter.unsubscribe("Dropdown::change",this.dropdownChangeHandler)}},{key:"handleOnDialogSelectProduct",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,1),a=n[0];var r=this.addProductRow();this.selectProductInRow(r,a)}},{key:"selectProductInRow",value:function e(t,n){var a=this;if(!i.Type.isStringFilled(t)||i.Text.toNumber(n)<=0){return}requestAnimationFrame(function(){var e;(e=a.getProductSelector(t))===null||e===void 0?void 0:e.onProductSelect(n)})}},{key:"handleOnSave",value:function e(t){var i=[];this.products.forEach(function(e){var t={fields:babelHelpers.objectSpread({},e.fields),rowId:e.fields.ROW_ID};i.push(t)});this.setSettingValue("items",i)}},{key:"handleOnInnerCancel",value:function e(t){if(this.controller){this.controller.rollback()}this.reloadGrid(false)}},{key:"changeActivePanelButtons",value:function e(t){var n=this.getContainer();var a=n.querySelector(".crm-entity-product-list-add-block-"+t);if(i.Type.isDomNode(a)){i.Dom.removeClass(a,"crm-entity-product-list-add-block-hidden");i.Dom.addClass(a,"crm-entity-product-list-add-block-active")}var r=t==="top"?"bottom":"top";var s=n.querySelector(".crm-entity-product-list-add-block-"+r);if(i.Type.isDomNode(s)){i.Dom.addClass(s,"crm-entity-product-list-add-block-hidden");i.Dom.removeClass(s,"crm-entity-product-list-add-block-active")}return a}},{key:"reloadGrid",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(n===null){n=!i}this.getGrid().reloadTable("POST",{useProductsFromRequest:i},function(){return t.actionUpdateTotalData({isInternalChanging:n})})}},{key:"handleOnBeforeGridRequest",value:function e(t){var i=this;var a=t.getCompatData(),r=babelHelpers.slicedToArray(a,2),s=r[0],o=r[1];if(!s||!s.parent||s.parent.getId()!==this.getGridId()){return}var u=!("useProductsFromRequest"in o.data);var l=u?true:o.data.useProductsFromRequest;o.url=this.getReloadUrl();o.method="POST";o.sessid=BX.bitrix_sessid();o.data=babelHelpers.objectSpread({},o.data,{signedParameters:this.getSignedParameters(),products:l?this.getProductsFields():null});this.clearEditor();if(u){n.EventEmitter.subscribeOnce("Grid::updated",function(){return i.actionUpdateTotalData({isInternalChanging:false})})}}},{key:"handleOnGridUpdated",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,1),a=n[0];if(!a||a.getId()!==this.getGridId()){return}this.getSettingsPopup().updateCheckboxState()}},{key:"handleOnGridRowMoved",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,3),a=n[0],r=n[2];if(!r||r.getId()!==this.getGridId()){return}var s=this.resortProductsByIds(a);if(s){this.refreshSortFields();this.executeActions([{type:this.actions.productListChanged}])}}},{key:"initPageEventsManager",value:function e(){var t=this.getSettingValue("componentId");this.pageEventsManager=new o({id:t})}},{key:"getPageEventsManager",value:function e(){if(!this.pageEventsManager){this.initPageEventsManager()}return this.pageEventsManager}},{key:"canEdit",value:function e(){return this.getSettingValue("allowEdit",false)===true}},{key:"enableEdit",value:function e(){var t=this.getGrid().getRows().getRows();t.forEach(function(e){if(!e.isHeadChild()&&!e.isTemplate()){e.edit()}})}},{key:"addFirstRowIfEmpty",value:function e(){var t=this;if(this.getGrid().getRows().getCountDisplayed()===0){requestAnimationFrame(function(){return t.addProductRow()})}}},{key:"clearEditor",value:function e(){this.products=[];this.destroySettingsPopup();this.unsubscribeDomEvents();this.unsubscribeCustomEvents();i.Event.unbindAll(this.container)}},{key:"destroy",value:function e(){this.setForm(null);this.clearController();this.clearEditor()}},{key:"setController",value:function e(t){if(this.controller===t){return}if(this.controller){this.controller.clearProductList()}this.controller=t}},{key:"clearController",value:function e(){this.controller=null}},{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"getSettings",value:function e(){return this.settings}},{key:"setSettings",value:function e(t){this.settings=t?t:{}}},{key:"getSettingValue",value:function e(t,i){return this.settings.hasOwnProperty(t)?this.settings[t]:i}},{key:"setSettingValue",value:function e(t,i){this.settings[t]=i}},{key:"getComponentName",value:function e(){return this.getSettingValue("componentName","")}},{key:"getReloadUrl",value:function e(){return this.getSettingValue("reloadUrl","")}},{key:"getSignedParameters",value:function e(){return this.getSettingValue("signedParameters","")}},{key:"getContainerId",value:function e(){return this.getSettingValue("containerId","")}},{key:"getGridId",value:function e(){return this.getSettingValue("gridId","")}},{key:"getLanguageId",value:function e(){return this.getSettingValue("languageId","")}},{key:"getSiteId",value:function e(){return this.getSettingValue("siteId","")}},{key:"getCatalogId",value:function e(){return this.getSettingValue("catalogId",0)}},{key:"isReadOnly",value:function e(){return this.getSettingValue("readOnly",true)}},{key:"setReadOnly",value:function e(t){this.setSettingValue("readOnly",t)}},{key:"getCurrencyId",value:function e(){return this.getSettingValue("currencyId","")}},{key:"setCurrencyId",value:function e(t){this.setSettingValue("currencyId",t)}},{key:"changeCurrencyId",value:function e(t){var i=this;this.setCurrencyId(t);var n=[];this.products.forEach(function(e){n.push({fields:e.getFields(),id:e.getId()})});if(n.length>0){this.ajaxRequest("calculateProductPrices",{products:n,currencyId:t})}var a=this.getGridEditData();var r=a[_];r["CURRENCY"]=this.getCurrencyId();var s=["DISCOUNT_ROW","SUM","PRICE"];s.forEach(function(e){r[e]["CURRENCY"]["VALUE"]=i.getCurrencyId()});this.setGridEditData(a)}},{key:"onCalculatePricesResponse",value:function e(t){this.products.forEach(function(e){if(i.Type.isObject(t[e.getId()])){var n=i.Text.toNumber(t[e.getId()]["PRICE"]);e.updateUiCurrencyFields();e.updateField("PRICE",n);e.setField("CURRENCY",t[e.getId()]["CURRENCY_ID"])}});this.updateTotalUiCurrency()}},{key:"updateTotalUiCurrency",value:function e(){var t=this;var n=BX(this.getSettingValue("totalBlockContainerId",null));if(i.Type.isElementNode(n)){n.querySelectorAll('[data-role="currency-wrapper"]').forEach(function(e){e.innerHTML=t.getCurrencyText()})}}},{key:"getCurrencyText",value:function e(){var t=this.getCurrencyId();if(!i.Type.isStringFilled(t)){return""}var n=s.CurrencyCore.getCurrencyFormat(t);return n&&n.FORMAT_STRING.replace(/(^|[^&])#/,"$1").trim()||""}},{key:"getDataFieldName",value:function e(){return this.getSettingValue("dataFieldName","")}},{key:"getDataSettingsFieldName",value:function e(){var t=this.getDataFieldName();return i.Type.isStringFilled(t)?t+"_SETTINGS":""}},{key:"getDiscountEnabled",value:function e(){return this.getSettingValue("enableDiscount","N")}},{key:"getPricePrecision",value:function e(){return this.getSettingValue("pricePrecision",O)}},{key:"getQuantityPrecision",value:function e(){return this.getSettingValue("quantityPrecision",O)}},{key:"getCommonPrecision",value:function e(){return this.getSettingValue("commonPrecision",O)}},{key:"getTaxList",value:function e(){return this.getSettingValue("taxList",[])}},{key:"getTaxAllowed",value:function e(){return this.getSettingValue("allowTax","N")}},{key:"isTaxAllowed",value:function e(){return this.getTaxAllowed()==="Y"}},{key:"getTaxEnabled",value:function e(){return this.getSettingValue("enableTax","N")}},{key:"isTaxEnabled",value:function e(){return this.getTaxEnabled()==="Y"}},{key:"isTaxUniform",value:function e(){return this.getSettingValue("taxUniform",true)}},{key:"getMeasures",value:function e(){return this.getSettingValue("measures",[])}},{key:"getDefaultMeasure",value:function e(){return this.getSettingValue("defaultMeasure",{})}},{key:"getRowIdPrefix",value:function e(){return this.getSettingValue("rowIdPrefix","crm_entity_product_list_")}},{key:"parseInt",value:function(e){function t(t){return e.apply(this,arguments)}t.toString=function(){return e.toString()};return t}(function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var n;var a=i.Type.isNumber(e);var r=i.Type.isStringFilled(e);if(!a&&!r){return t}if(r){e=e.replace(/^\s+|\s+$/g,"");var s=e.indexOf("-")===0;n=parseInt(e.replace(/[^\d]/g,""),10);if(isNaN(n)){n=t}else{if(s){n=-n}}}else{n=parseInt(e,10);if(isNaN(n)){n=t}}return n})},{key:"parseFloat",value:function(e){function t(t){return e.apply(this,arguments)}t.toString=function(){return e.toString()};return t}(function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:O;var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var a;var r=i.Type.isNumber(e);var s=i.Type.isStringFilled(e);if(!r&&!s){return n}if(s){e=e.replace(/^\s+|\s+$/g,"");var o=e.indexOf(".");var u=e.indexOf(",");var l=e.indexOf("-")===0;if(o<0&&u>=0){var d=e.substr(0,u);var c=e.length-u-1;if(c>0){d+="."+e.substr(u+1,c)}e=d}e=e.replace(/[^\d.]+/g,"");a=parseFloat(e);if(isNaN(a)){a=n}if(l){a=-a}}else{a=parseFloat(e)}if(t>=0){a=this.round(a,t)}return a})},{key:"round",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:O;var n=Math.pow(10,i);return Math.round(t*n)/n}},{key:"calculatePriceWithoutDiscount",value:function e(t,i,n){var a=0;switch(n){case r.DiscountType.PERCENTAGE:a=t-t*i/100;break;case r.DiscountType.MONETARY:a=t-i;break}return a}},{key:"calculateDiscountRate",value:function e(t,i){if(t===0){return 0}if(i===0){return t>0?100:-100}return 100*(t-i)/t}},{key:"calculateDiscount",value:function e(t,i){return t*i/100}},{key:"calculatePriceWithoutTax",value:function e(t,i){return t/(1+i/100)}},{key:"calculatePriceWithTax",value:function e(t,i){return t*(1+i/100)}},{key:"getContainer",value:function e(){var t=this;return this.cache.remember("container",function(){return document.getElementById(t.getContainerId())})}},{key:"initForm",value:function e(){var t=this.getSettingValue("formId","");var n=i.Type.isStringFilled(t)?BX("form_"+t):null;if(i.Type.isElementNode(n)){this.setForm(n)}}},{key:"isExistForm",value:function e(){return i.Type.isElementNode(this.getForm())}},{key:"getForm",value:function e(){return this.form}},{key:"setForm",value:function e(t){this.form=t}},{key:"initFormFields",value:function e(){var t=this.getForm();if(i.Type.isElementNode(t)){var n=this.getDataField();if(!i.Type.isElementNode(n)){this.initDataField()}var a=this.getDataSettingsField();if(!i.Type.isElementNode(a)){this.initDataSettingsField()}}}},{key:"initFormField",value:function e(t){var n=this.getForm();if(i.Type.isElementNode(n)&&i.Type.isStringFilled(t)){n.appendChild(i.Dom.create("input",{attrs:{type:"hidden",name:t}}))}}},{key:"removeFormFields",value:function e(){var t=this.getDataField();if(i.Type.isElementNode(t)){i.Dom.remove(t)}var n=this.getDataSettingsField();if(i.Type.isElementNode(n)){i.Dom.remove(n)}}},{key:"initDataField",value:function e(){this.initFormField(this.getDataFieldName())}},{key:"initDataSettingsField",value:function e(){this.initFormField(this.getDataSettingsFieldName())}},{key:"getFormField",value:function e(t){var n=this.getForm();if(i.Type.isElementNode(n)&&i.Type.isStringFilled(t)){return n.querySelector('input[name="'+t+'"]')}return null}},{key:"getDataField",value:function e(){return this.getFormField(this.getDataFieldName())}},{key:"getDataSettingsField",value:function e(){return this.getFormField(this.getDataSettingsFieldName())}},{key:"getProductCount",value:function e(){return this.products.length}},{key:"initProducts",value:function e(){var t=this.getSettingValue("items",[]);var i=A(t),n;try{for(i.s();!(n=i.n()).done;){var a=n.value;var r=babelHelpers.objectSpread({},a.fields);this.products.push(new X(a.rowId,r,{},this));var s=this.getGrid().getRows().getById(r.ID);if(s){this.setDeleteButton(s.getNode(),r.ID)}}}catch(e){i.e(e)}finally{i.f()}}},{key:"getGrid",value:function e(){var t=this;return this.cache.remember("grid",function(){var e=t.getGridId();if(!i.Reflection.getClass("BX.Main.gridManager.getInstanceById")){throw Error("Cannot find grid with '".concat(e,"' id."))}return BX.Main.gridManager.getInstanceById(e)})}},{key:"initGridData",value:function e(){var t=this.getSettingValue("templateGridEditData",null);if(t){this.setGridEditData(t)}}},{key:"getGridEditData",value:function e(){return this.getGrid().arParams.EDITABLE_DATA}},{key:"setGridEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA=t}},{key:"setOriginalTemplateEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA[_]=t}},{key:"handleFieldChange",value:function e(t){var i=t.target.closest("tr");if(i&&i.hasAttribute("data-id")){var n=this.getProductById(i.getAttribute("data-id"));if(n){var a=t.target.closest("td");var r=this.getFieldCodeByGridCell(i,a);if(r){n.updateFieldByEvent(r,t)}}}}},{key:"handleDropdownChange",value:function e(t){var i=t.getData(),n=babelHelpers.slicedToArray(i,5),a=n[0],r=n[4];var s=new RegExp(this.getRowIdPrefix()+"([A-Za-z0-9]+)_(\\w+)_control","i");var o=a.match(s);if(o){var u=babelHelpers.slicedToArray(o,3),l=u[1],d=u[2];var c=this.getProductById(l);if(c){c.updateField(d,r)}}}},{key:"getProductById",value:function e(t){var i=this.getRowIdPrefix()+t;return this.getProductByRowId(i)}},{key:"getProductByRowId",value:function e(t){return this.products.find(function(e){return e.getId()===t})}},{key:"getFieldCodeByGridCell",value:function e(t,n){if(!i.Type.isDomNode(t)||!i.Type.isDomNode(n)){return null}var a=this.getGrid();if(a){var r=a.getRows().getHeadFirstChild();var s=babelHelpers.toConsumableArray(t.cells).indexOf(n);return r.getCellNameByCellIndex(s)}return null}},{key:"handleProductSelectionPopup",value:function e(t){var i="crm_entity_product_list";var a=this.getSettingValue("jsEventsManagerId","");var r=new BX.CDialog({content_url:"/bitrix/components/bitrix/crm.product_row.list/product_choice_dialog.php?"+"caller="+i+"&JS_EVENTS_MANAGER_ID="+BX.util.urlencode(a)+"&sessid="+BX.bitrix_sessid(),height:Math.max(500,window.innerHeight-400),width:Math.max(800,window.innerWidth-400),draggable:true,resizable:true,min_height:500,min_width:800,zIndex:800});n.EventEmitter.subscribe(r,"onWindowRegister",BX.defer(function(){r.Get().style.position="fixed";r.Get().style.top=parseInt(r.Get().style.top)-BX.GetWindowScrollPos().scrollTop+"px";r.OVERLAY.style.zIndex=798}));n.EventEmitter.subscribe(window,"EntityProductListController:onInnerCancel",BX.defer(function(){r.Close()}));if(typeof BX.Crm.EntityEvent!=="undefined"){n.EventEmitter.subscribe(window,BX.Crm.EntityEvent.names.update,BX.defer(function(){requestAnimationFrame(function(){r.Close()},0)}))}r.Show()}},{key:"addProductRow",value:function e(){var t=this.createGridProductRow();var i=t.getId();this.initializeNewProductRow(i);return i}},{key:"handleProductRowAdd",value:function e(){var t=this.addProductRow();this.focusProductSelector(t)}},{key:"handleShowSettingsPopup",value:function e(){this.getSettingsPopup().show()}},{key:"destroySettingsPopup",value:function e(){if(this.cache.has("settings-popup")){this.cache.get("settings-popup").getPopup().destroy();this.cache.delete("settings-popup")}}},{key:"getSettingsPopup",value:function e(){var t=this;return this.cache.remember("settings-popup",function(){return new m(t.getContainer().querySelector('.crm-entity-product-list-add-block-active [data-role="product-list-settings-button"]'),t.getSettingValue("popupSettings",[]),t)})}},{key:"createGridProductRow",value:function e(){var t=i.Text.getRandom();var a=this.redefineTemplateEditData(t);var r=this.getGrid();var s;if(this.getSettingValue("newRowPosition")==="bottom"){s=r.appendRowEditor()}else{s=r.prependRowEditor()}var o=s.getNode();this.setDeleteButton(o,t);if(i.Type.isDomNode(o)){o.setAttribute("data-id",t);s.makeCountable()}if(a){this.setOriginalTemplateEditData(a)}n.EventEmitter.emit("Grid::thereEditedRows",[]);r.adjustRows();r.updateCounterDisplayed();r.updateCounterSelected();return s}},{key:"setDeleteButton",value:function e(t,n){if(this.isReadOnly()){return}var a=t.querySelector(".main-grid-cell-action .main-grid-cell-content");if(n){var r=i.Tag.render(N(),this.handleDeleteRow.bind(this,n),i.Loc.getMessage("CRM_ENTITY_PL_DELETE"));i.Dom.append(r,a)}}},{key:"handleDeleteRow",value:function e(t,i){i.preventDefault();this.deleteRow(t)}},{key:"redefineTemplateEditData",value:function e(t){var i=this.getGridEditData();var n=i[_];var a=this.prepareCustomEditData(n,t);this.setOriginalTemplateEditData(babelHelpers.objectSpread({},n,a));return n}},{key:"prepareCustomEditData",value:function e(t,n){var a={};var r=this.getSettingValue("templateIdMask","");for(var s in t){if(t.hasOwnProperty(s)){if(i.Type.isStringFilled(t[s])&&t[s].indexOf(r)>=0){a[s]=t[s].replace(new RegExp(r,"g"),n)}else if(i.Type.isPlainObject(t[s])){a[s]=this.prepareCustomEditData(t[s],n)}else{a[s]=t[s]}}}return a}},{key:"initializeNewProductRow",value:function e(t){var i=this.getRowIdPrefix()+t;var n=babelHelpers.objectSpread({},this.getSettingValue("templateItemFields",{}),{ID:t,TAX_INCLUDED:this.isTaxIncludedActive()?"N":"Y",CURRENCY:this.getCurrencyId()});var a=new X(i,n,{},this);a.updateFieldValue("TAX_INCLUDED",this.isTaxIncludedActive());if(this.getSettingValue("newRowPosition")==="bottom"){this.products.push(a)}else{this.products.unshift(a)}this.refreshSortFields();a.updateUiCurrencyFields();this.updateTotalUiCurrency();return a}},{key:"isTaxIncludedActive",value:function e(){return this.products.filter(function(e){return e.isTaxIncluded()}).length>0}},{key:"getProductSelector",value:function e(t){return a.ProductSelector.getById("crm_grid_"+this.getRowIdPrefix()+t)}},{key:"focusProductSelector",value:function e(t){var i=this;requestAnimationFrame(function(){var e;(e=i.getProductSelector(t))===null||e===void 0?void 0:e.searchInDialog().focusName()})}},{key:"handleOnBeforeProductChange",value:function e(t){var i=t.getData();var n=this.getProductByRowId(i.rowId);if(n){this.getGrid().tableFade();n.resetExternalActions()}}},{key:"handleOnProductChange",value:function e(t){var n=this;var a=t.getData();var r=this.getProductByRowId(a.rowId);if(r&&a.fields){var s=new Promise(function(e,t){var s=a.fields;if(n.getCurrencyId()!==s["CURRENCY_ID"]){s["CURRENCY"]=s["CURRENCY_ID"];var o=[{fields:a.fields,id:r.getId()}];i.ajax.runComponentAction(n.getComponentName(),"calculateProductPrices",{mode:"class",signedParameters:n.getSignedParameters(),data:{products:o,currencyId:n.getCurrencyId(),options:{ACTION:"calculateProductPrices"}}}).then(function(t){var i=t.data.result[r.getId()];if(i){i["CUSTOMIZED"]="Y";e(Object.assign(s,i))}else{e(s)}})}else{e(s)}});s.then(function(e){Object.keys(e).forEach(function(t){r.updateFieldValue(t,e[t])});if(!i.Type.isStringFilled(e["CUSTOMIZED"])){r.setField("CUSTOMIZED","N")}r.setField("IS_NEW",a.isNew?"Y":"N");r.initHandlersForProductSelector();r.executeExternalActions();n.getGrid().tableUnfade()})}else{this.getGrid().tableUnfade()}}},{key:"handleOnProductClear",value:function e(t){var i=t.getData(),n=i.rowId;var a=this.getProductByRowId(n);if(a){a.initHandlersForProductSelector();a.changePrice(0);a.executeExternalActions()}}},{key:"compileProductData",value:function e(){if(!this.isExistForm()){return}this.initFormFields();var t=this.getDataField();var n=this.getDataSettingsField();this.cleanProductRows();if(i.Type.isElementNode(t)&&i.Type.isElementNode(n)){t.value=this.prepareProductDataValue();n.value=JSON.stringify({ENABLE_DISCOUNT:this.getDiscountEnabled(),ENABLE_TAX:this.getTaxEnabled()})}this.addFirstRowIfEmpty()}},{key:"prepareProductDataValue",value:function e(){var t="";if(this.getProductCount()){var i=[];this.products.forEach(function(e){var t=e.getFields();if(!/^[0-9]+$/.test(t["ID"])){t["ID"]=0}t["CUSTOMIZED"]="Y";i.push(t)});t=JSON.stringify(i)}return t}},{key:"executeActions",value:function e(t){var n=this;if(!i.Type.isArrayFilled(t)){return}var a=t.filter(function(e){return e.type===n.actions.updateTotal}).length>0;var r=A(t),s;try{for(r.s();!(s=r.n()).done;){var o=s.value;if(!i.Type.isPlainObject(o)||!i.Type.isStringFilled(o.type)){continue}switch(o.type){case this.actions.productChange:this.actionSendProductChange(o,a);break;case this.actions.productListChanged:this.actionSendProductListChanged(a);break;case this.actions.updateListField:this.actionUpdateListField(o);break;case this.actions.updateTotal:this.actionUpdateTotalData();break;case this.actions.stateChanged:this.actionSendStatusChange(o);break}}}catch(e){r.e(e)}finally{r.f()}}},{key:"actionSendProductChange",value:function e(t,a){if(!i.Type.isStringFilled(t.id)){return}var r=this.getProductByRowId(t.id);if(!r){return}n.EventEmitter.emit(this,"ProductList::onChangeFields",{rowId:t.id,productId:r.getField("PRODUCT_ID"),fields:this.getProductByRowId(t.id).getCatalogFields()});if(this.controller){this.controller.productChange(a)}}},{key:"actionSendProductListChanged",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(this.controller){this.controller.productChange(t)}}},{key:"actionUpdateListField",value:function e(t){if(!i.Type.isStringFilled(t.field)||!("value"in t)){return}if(!this.allowUpdateListField(t.field)){return}this.updateFieldForList=t.field;var n=A(this.products),a;try{for(n.s();!(a=n.n()).done;){var r=a.value;r.updateFieldByName(t.field,t.value)}}catch(e){n.e(e)}finally{n.f()}this.updateFieldForList=null}},{key:"actionUpdateTotalData",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(this.totalData.inProgress){return}this.updateTotalDataDelayedHandler(t)}},{key:"actionSendStatusChange",value:function e(t){if(!("value"in t)){return}if(this.stateChange.changed===t.value){return}this.stateChange.changed=t.value;if(this.stateChange.sended){return}this.stateChange.sended=true}},{key:"allowUpdateListField",value:function e(t){if(this.updateFieldForList!==null){return false}var i=true;switch(t){case"TAX_INCLUDED":i=this.isTaxUniform()&&this.isTaxAllowed();break}return i}},{key:"updateTotalDataDelayed",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(this.totalData.inProgress){return}this.totalData.inProgress=true;var i=this.getProductsFields(this.getProductFieldListForTotalData());i.forEach(function(e){return e["CUSTOMIZED"]="Y"});this.ajaxRequest("calculateTotalData",{options:t,products:i,currencyId:this.getCurrencyId()})}},{key:"getProductsFields",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var i=[];var n=A(this.products),a;try{for(n.s();!(a=n.n()).done;){var r=a.value;i.push(r.getFields(t))}}catch(e){n.e(e)}finally{n.f()}return i}},{key:"getProductFieldListForTotalData",value:function e(){return["PRODUCT_ID","PRODUCT_NAME","QUANTITY","DISCOUNT_TYPE_ID","DISCOUNT_RATE","DISCOUNT_SUM","TAX_RATE","TAX_INCLUDED","PRICE_EXCLUSIVE","PRICE","CUSTOMIZED"]}},{key:"setTotalData",value:function e(t){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a=BX(this.getSettingValue("totalBlockContainerId",null));if(i.Type.isElementNode(a)){var r=this.getCurrencyId();var o=["totalCost","totalTax","totalWithoutTax","totalDiscount","totalWithoutDiscount"];for(var u=0,l=o;u<l.length;u++){var d=l[u];var c=a.querySelector('[data-total="'+d+'"]');if(i.Type.isElementNode(c)&&d in t){c.innerHTML=s.CurrencyCore.currencyFormat(t[d],r,false)}}}this.sendTotalData(t,n);this.totalData.inProgress=false}},{key:"sendTotalData",value:function e(t,n){if(this.controller){var a=true;if(i.Type.isObject(n)&&(n.isInternalChanging===true||n.isInternalChanging==="true")){a=false}this.controller.changeSumTotal(t,a)}}},{key:"ajaxRequest",value:function e(t,n){var a=this;if(!i.Type.isPlainObject(n.options)){n.options={}}n.options.ACTION=t;i.ajax.runComponentAction(this.getComponentName(),t,{mode:"class",signedParameters:this.getSignedParameters(),data:n}).then(function(e){return a.ajaxResultSuccess(e,n.options)},function(e){return a.ajaxResultFailure(e)})}},{key:"ajaxResultSuccess",value:function e(t,n){if(!this.ajaxResultCommonCheck(t)){return}switch(t.data.action){case"calculateTotalData":if(i.Type.isPlainObject(t.data.result)){this.setTotalData(t.data.result,n)}break;case"calculateProductPrices":if(i.Type.isPlainObject(t.data.result)){this.onCalculatePricesResponse(t.data.result)}break}}},{key:"ajaxResultFailure",value:function e(t){}},{key:"ajaxResultCommonCheck",value:function e(t){if(!i.Type.isPlainObject(t)){return false}if(!i.Type.isStringFilled(t.status)){return false}if(t.status!=="success"){return false}if(!i.Type.isPlainObject(t.data)){return false}if(!i.Type.isStringFilled(t.data.action)){return false}if(!("result"in t.data)){return false}return true}},{key:"deleteRow",value:function e(t){var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!i.Type.isStringFilled(t)){return}var r=this.getGrid().getRows().getById(t);if(r){i.Dom.remove(r.getNode());this.getGrid().getRows().reset()}var s=this.getProductById(t);if(s){var o=this.products.indexOf(s);if(o>-1){this.products.splice(o,1);this.refreshSortFields()}}n.EventEmitter.emit("Grid::thereEditedRows",[]);if(!a){this.addFirstRowIfEmpty();this.executeActions([{type:this.actions.productListChanged},{type:this.actions.updateTotal}])}}},{key:"cleanProductRows",value:function e(){var t=this;this.products.filter(function(e){return!i.Type.isStringFilled(e.getField("PRODUCT_NAME","").trim())&&e.getField("PRODUCT_ID",0)<=0&&e.getPrice()<=0}).forEach(function(e){return t.deleteRow(e.getField("ID"),true)})}},{key:"resortProductsByIds",value:function e(t){var n=false;if(i.Type.isArrayFilled(t)){this.products.sort(function(e,i){if(t.indexOf(e.getField("ID"))>t.indexOf(i.getField("ID"))){return 1}n=true;return-1})}return n}},{key:"refreshSortFields",value:function e(){this.products.forEach(function(e,t){return e.setField("SORT",(t+1)*10)})}},{key:"handleOnTabShow",value:function e(){n.EventEmitter.emit("onDemandRecalculateWrapper")}}]);return e}();function H(e,t){var i;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(i=M(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var a=function e(){};return{s:a,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,s=false,o;return{s:function t(){i=e[Symbol.iterator]()},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){s=true;o=t},f:function e(){try{if(!r&&i.return!=null)i.return()}finally{if(s)throw o}}}}function M(e,t){if(!e)return;if(typeof e==="string")return B(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return B(e,t)}function B(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++){n[i]=e[i]}return n}var L="EDIT";var G="SET";var X=function(){function e(t,n,a,r){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"fields",{});babelHelpers.defineProperty(this,"externalActions",[]);babelHelpers.defineProperty(this,"cache",new i.Cache.MemoryCache);this.setId(t);this.setFields(n);this.setSettings(a);this.setEditor(r);requestAnimationFrame(this.initHandlers.bind(this))}babelHelpers.createClass(e,[{key:"getNode",value:function e(){var t=this;return this.cache.remember("node",function(){var e=t.getField("ID",0);return t.getEditorContainer().querySelector('[data-id="'+e+'"]')})}},{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"getSettings",value:function e(){return this.settings}},{key:"setSettings",value:function e(t){this.settings=i.Type.isPlainObject(t)?t:{}}},{key:"getSettingValue",value:function e(t,i){return this.settings.hasOwnProperty(t)?this.settings[t]:i}},{key:"setSettingValue",value:function e(t,i){this.settings[t]=i}},{key:"setEditor",value:function e(t){this.editor=t}},{key:"getEditor",value:function e(){return this.editor}},{key:"getEditorContainer",value:function e(){return this.getEditor().getContainer()}},{key:"initHandlers",value:function e(){var t=this.getEditor();this.getNode().querySelectorAll("input").forEach(function(e){i.Event.bind(e,"input",t.changeProductFieldHandler);i.Event.bind(e,"change",t.changeProductFieldHandler);i.Event.bind(e,"mousedown",function(e){return e.stopPropagation()})});this.getNode().querySelectorAll("select").forEach(function(e){i.Event.bind(e,"change",t.changeProductFieldHandler);i.Event.bind(e,"mousedown",function(e){return e.stopPropagation()})})}},{key:"initHandlersForProductSelector",value:function e(){var t=this.getEditor();this.getNode().querySelectorAll('[data-name="MAIN_INFO"] input[type="text"]').forEach(function(e){i.Event.bind(e,"input",t.changeProductFieldHandler);i.Event.bind(e,"change",t.changeProductFieldHandler);i.Event.bind(e,"mousedown",function(e){return e.stopPropagation()})})}},{key:"getFields",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var n;if(!i.Type.isArrayFilled(t)){n=i.Runtime.clone(this.fields)}else{n={};var a=H(t),r;try{for(a.s();!(r=a.n()).done;){var s=r.value;n[s]=this.getField(s)}}catch(e){a.e(e)}finally{a.f()}}if("PRODUCT_NAME"in n){var o=this.getField("FIXED_PRODUCT_NAME","");if(i.Type.isStringFilled(o)){n["PRODUCT_NAME"]=o}}return n}},{key:"getCatalogFields",value:function e(){var t=this.getFields(["CURRENCY","QUANTITY","MEASURE_CODE"]);t["PRICE"]=this.getBasePrice();t["VAT_INCLUDED"]=this.getTaxIncluded();t["VAT_ID"]=this.getTaxId();return t}},{key:"getCalculateFields",value:function e(){return{PRICE:this.getPrice(),PRICE_EXCLUSIVE:this.getPriceExclusive(),PRICE_NETTO:this.getPriceNetto(),PRICE_BRUTTO:this.getPriceBrutto(),QUANTITY:this.getQuantity(),DISCOUNT_TYPE_ID:this.getDiscountType(),DISCOUNT_RATE:this.getDiscountRate(),DISCOUNT_SUM:this.getDiscountSum(),DISCOUNT_ROW:this.getDiscountRow(),TAX_INCLUDED:this.getTaxIncluded(),TAX_RATE:this.getTaxRate()}}},{key:"setFields",value:function e(t){for(var i in t){if(t.hasOwnProperty(i)){this.setField(i,t[i])}}}},{key:"getField",value:function e(t,i){return this.fields.hasOwnProperty(t)?this.fields[t]:i}},{key:"setField",value:function e(t,i){this.fields[t]=i}},{key:"getUiFieldId",value:function e(t){return this.getId()+"_"+t}},{key:"getBasePrice",value:function e(){return this.isPriceNetto()?this.getPriceNetto():this.getPriceBrutto()}},{key:"isPriceNetto",value:function e(){return this.getEditor().isTaxAllowed()&&!this.isTaxIncluded()}},{key:"getPrice",value:function e(){return this.getField("PRICE",0)}},{key:"getPriceExclusive",value:function e(){return this.getField("PRICE_EXCLUSIVE",0)}},{key:"getPriceNetto",value:function e(){return this.getField("PRICE_NETTO",0)}},{key:"getPriceBrutto",value:function e(){return this.getField("PRICE_BRUTTO",0)}},{key:"getQuantity",value:function e(){return this.getField("QUANTITY",1)}},{key:"getDiscountType",value:function e(){return this.getField("DISCOUNT_TYPE_ID",r.DiscountType.UNDEFINED)}},{key:"isDiscountUndefined",value:function e(){return this.getDiscountType()===r.DiscountType.UNDEFINED}},{key:"isDiscountPercentage",value:function e(){return this.getDiscountType()===r.DiscountType.PERCENTAGE}},{key:"isDiscountMonetary",value:function e(){return this.getDiscountType()===r.DiscountType.MONETARY}},{key:"isDiscountHandmade",value:function e(){return this.isDiscountPercentage()||this.isDiscountMonetary()}},{key:"getDiscountRate",value:function e(){return this.getField("DISCOUNT_RATE",0)}},{key:"getDiscountSum",value:function e(){return this.getField("DISCOUNT_SUM",0)}},{key:"getDiscountRow",value:function e(){return this.getField("DISCOUNT_ROW",0)}},{key:"isEmptyDiscount",value:function e(){if(this.isDiscountPercentage()){return this.getDiscountRate()===0}else if(this.isDiscountMonetary()){return this.getDiscountSum()===0}else if(this.isDiscountUndefined()){return true}return false}},{key:"getTaxIncluded",value:function e(){return this.getField("TAX_INCLUDED","N")}},{key:"isTaxIncluded",value:function e(){return this.getTaxIncluded()==="Y"}},{key:"getTaxRate",value:function e(){return this.getField("TAX_RATE",0)}},{key:"getTaxSum",value:function e(){return this.isTaxIncluded()?this.getPrice()*this.getQuantity()*(1-1/(1+this.getTaxRate()/100)):this.getPriceExclusive()*this.getQuantity()*this.getTaxRate()/100}},{key:"getTaxNode",value:function e(){return this.getNode().querySelector('select[data-field-code="TAX_RATE"]')}},{key:"getTaxId",value:function e(){var t=this.getTaxNode();if(i.Type.isDomNode(t)&&t.options[t.selectedIndex]){return i.Text.toNumber(t.options[t.selectedIndex].getAttribute("data-tax-id"))}return 0}},{key:"updateFieldByEvent",value:function e(t,i){var n=i.target;var a=n.type==="checkbox"?n.checked:n.value;var r=i.type==="input"?L:G;this.updateField(t,a,r)}},{key:"updateField",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:G;this.resetExternalActions();this.updateFieldValue(t,i,n);this.executeExternalActions()}},{key:"updateFieldValue",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:G;switch(t){case"ID":this.changeProductId(i);break;case"PRICE":this.changePrice(i,n);break;case"QUANTITY":this.changeQuantity(i,n);break;case"MEASURE_CODE":this.changeMeasureCode(i);break;case"DISCOUNT":case"DISCOUNT_PRICE":this.changeDiscount(i,n);break;case"DISCOUNT_TYPE_ID":this.changeDiscountType(i);break;case"DISCOUNT_ROW":this.changeRowDiscount(i,n);break;case"VAT_ID":case"TAX_ID":this.changeTaxId(i);break;case"TAX_RATE":this.changeTaxRate(i);break;case"VAT_INCLUDED":case"TAX_INCLUDED":this.changeTaxIncluded(i);break;case"SUM":this.changeRowSum(i,n);break;case"NAME":case"PRODUCT_NAME":case"MAIN_INFO":this.changeProductName(i);break;case"SORT":this.changeSort(i,n);break}}},{key:"updateFieldByName",value:function e(t,i){switch(t){case"TAX_INCLUDED":this.setTaxIncluded(i);break}}},{key:"changeProductId",value:function e(t){var i=this.parseInt(t);this.setProductId(i)}},{key:"changePrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:G;var n=this.parseFloat(t,this.getPricePrecision());this.setPrice(n,i)}},{key:"changeQuantity",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:G;var n=this.parseFloat(t,this.getQuantityPrecision());this.setQuantity(n,i)}},{key:"changeMeasureCode",value:function e(t){var i=this;this.getEditor().getMeasures().filter(function(e){return e.CODE===t}).forEach(function(e){return i.setMeasure(e)})}},{key:"changeDiscount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:G;var n;if(this.isDiscountPercentage()){n=this.parseFloat(t,this.getCommonPrecision())}else{n=this.parseFloat(t,this.getPricePrecision()).toFixed(this.getPricePrecision())}this.setDiscount(n,i)}},{key:"changeDiscountType",value:function e(t){var i=this.parseInt(t,r.DiscountType.UNDEFINED);this.setDiscountType(i)}},{key:"changeRowDiscount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:G;var n=this.parseFloat(t,this.getPricePrecision());this.setRowDiscount(n,i)}},{key:"changeTaxId",value:function e(t){var n=this.getEditor().getTaxList();if(i.Type.isArrayFilled(n)){var a=n.find(function(e){return parseInt(e.ID)===parseInt(t)});if(a){this.changeTaxRate(this.parseFloat(a.VALUE))}}}},{key:"changeTaxRate",value:function e(t){var i=this.parseFloat(t,this.getCommonPrecision());this.setTaxRate(i)}},{key:"changeTaxIncluded",value:function e(t){if(i.Type.isBoolean(t)){t=t?"Y":"N"}this.setTaxIncluded(t)}},{key:"changeRowSum",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:G;var n=this.parseFloat(t,this.getPricePrecision());this.setRowSum(n,i)}},{key:"changeProductName",value:function e(t){var i=t.toString();var n=this.getField("PRODUCT_NAME")!==i;if(n){this.setField("PRODUCT_NAME",i);this.addActionProductChange()}}},{key:"changeSort",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:G;var n=this.parseInt(t);if(i===G){this.setField("SORT",n)}var a=this.getField("SORT")!==n;if(a){this.addActionProductChange()}}},{key:"refreshFieldsLayout",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];for(var i in this.fields){if(this.fields.hasOwnProperty(i)&&!t.includes(i)){this.updateUiField(i,this.fields[i])}}}},{key:"getCalculator",value:function e(){var t=this.cache.remember("calculator",function(){return new r.ProductCalculator});return t.setFields(this.getCalculateFields()).setSettings(this.getEditor().getSettings())}},{key:"setProductId",value:function e(t){var i=this.getField("PRODUCT_ID")!==t;if(i){this.setField("PRODUCT_ID",t);this.setField("OFFER_ID",t);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setPrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:G;if(i===G){this.updateUiInputField("PRICE",t.toFixed(this.getPricePrecision()))}var n=this.getBasePrice()!==t;if(n){var a=this.getCalculator().calculatePrice(t);this.setFields(a);this.refreshFieldsLayout(["PRICE_NETTO","PRICE_BRUTTO"]);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setQuantity",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:G;if(i===G){this.updateUiInputField("QUANTITY",t)}var n=this.getField("QUANTITY")!==t;if(n){var a=this.getCalculator().calculateQuantity(t);this.setFields(a);this.refreshFieldsLayout(["QUANTITY"]);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setMeasure",value:function e(t){this.setField("MEASURE_CODE",t.CODE);this.setField("MEASURE_NAME",t.SYMBOL);this.updateUiMoneyField("MEASURE_CODE",t.CODE,t.SYMBOL);this.addActionProductChange()}},{key:"setDiscount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:G;if(!this.isDiscountHandmade()){return}if(i===G){this.updateUiInputField("DISCOUNT_PRICE",t)}var n=this.isDiscountPercentage()?"DISCOUNT_RATE":"DISCOUNT_SUM";var a=this.getField(n)!==t;if(a){var r=this.getCalculator().calculateDiscount(t);this.setFields(r);this.refreshFieldsLayout(["DISCOUNT_RATE","DISCOUNT_SUM","DISCOUNT"]);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setDiscountType",value:function e(t){var i=t!==r.DiscountType.UNDEFINED&&this.getField("DISCOUNT_TYPE_ID")!==t;if(i){var n=this.getCalculator().calculateDiscountType(t);this.setFields(n);this.refreshFieldsLayout();this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setRowDiscount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:G;if(i===G){this.updateUiInputField("DISCOUNT_ROW",t.toFixed(this.getPricePrecision()))}var n=this.getField("DISCOUNT_ROW")!==t;if(n){var a=this.getCalculator().calculateRowDiscount(t);this.setFields(a);this.refreshFieldsLayout(["DISCOUNT_ROW"]);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setTaxRate",value:function e(t){if(!this.getEditor().isTaxAllowed()){return}var i=this.getTaxRate()!==t;if(i){var n=this.getCalculator().calculateTax(t);this.setFields(n);this.refreshFieldsLayout();this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setTaxIncluded",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:G;if(!this.getEditor().isTaxAllowed()){return}if(i===G){this.updateUiCheckboxField("TAX_INCLUDED",t)}var n=this.getTaxIncluded()!==t;if(n){var a=this.getCalculator().calculateTaxIncluded(t);this.setFields(a);this.refreshFieldsLayout();this.addActionUpdateFieldList("TAX_INCLUDED",t);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setRowSum",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:G;if(i===G){this.updateUiInputField("SUM",t.toFixed(this.getPricePrecision()))}var n=this.getField("SUM")!==t;if(n){var a=this.getCalculator().calculateRowSum(t);this.setFields(a);this.refreshFieldsLayout(["SUM"]);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"getInputByFieldName",value:function e(t){var n=this.getUiFieldId(t);var a=document.getElementById(n);if(!i.Type.isElementNode(a)){a=this.getNode().querySelector('[name="'+n+'"]')}return a}},{key:"updateUiInputField",value:function e(t,n){var a=this.getInputByFieldName(t);if(i.Type.isElementNode(a)){a.value=n}}},{key:"updateUiCheckboxField",value:function e(t,n){var a=this.getInputByFieldName(t);if(i.Type.isElementNode(a)){a.checked=n==="Y"}}},{key:"updateUiDiscountTypeField",value:function e(t,i){var n=i===r.DiscountType.MONETARY?this.getEditor().getCurrencyText():"%";this.updateUiMoneyField(t,i,n)}},{key:"getMoneyFieldDropdownApi",value:function e(t){if(!i.Reflection.getClass("BX.Main.dropdownManager")){return null}return BX.Main.dropdownManager.getById(this.getId()+"_"+t+"_control")}},{key:"updateMoneyFieldUiWithDropdownApi",value:function e(t,i){if(t.getValue()==i){return}var n=t.menu.itemsContainer.querySelector('[data-value="'+i+'"]');var a=n&&t.getMenuItem(n);if(a){t.refresh(a);t.selectItem(a)}}},{key:"updateMoneyFieldUiManually",value:function e(t,n,a){var r=this.getInputByFieldName(t);if(!i.Type.isElementNode(r)){return}r.dataset.value=n;var s=r.querySelector("span.main-dropdown-inner");if(!i.Type.isElementNode(s)){return}s.innerHTML=a}},{key:"updateUiMoneyField",value:function e(t,i,n){var a=this.getMoneyFieldDropdownApi(t);if(a){this.updateMoneyFieldUiWithDropdownApi(a,i)}else{this.updateMoneyFieldUiManually(t,i,n)}}},{key:"updateUiHtmlField",value:function e(t,n){var a=this.getInputByFieldName(t);if(i.Type.isElementNode(a)){a.innerHTML=n}}},{key:"updateUiCurrencyFields",value:function e(){var t=this;var n=this.getEditor().getCurrencyText();var a=""+this.getEditor().getCurrencyId();var s=["PRICE_CURRENCY","SUM_CURRENCY","DISCOUNT_TYPE_ID","DISCOUNT_ROW_CURRENCY"];s.forEach(function(e){var s=[];if(e==="DISCOUNT_TYPE_ID"){s.push({NAME:"%",VALUE:""+r.DiscountType.PERCENTAGE});s.push({NAME:n,VALUE:""+r.DiscountType.MONETARY});if(t.getDiscountType()===r.DiscountType.MONETARY){t.updateMoneyFieldUiManually(e,r.DiscountType.MONETARY,n)}}else{s.push({NAME:n,VALUE:a});t.updateUiMoneyField(e,a,n)}i.Dom.attr(t.getInputByFieldName(e),"data-items",s)});this.updateUiField("TAX_SUM",this.getField("TAX_SUM"))}},{key:"updateUiField",value:function e(t,n){var a=this.getUiFieldName(t);if(!a){return}var r=this.getUiFieldType(t);if(!r){return}if(!this.allowUpdateUiField(t)){return}switch(r){case"input":if(t==="QUANTITY"){n=this.parseFloat(n,this.getQuantityPrecision())}else if(t==="DISCOUNT_RATE"||t==="TAX_RATE"){n=this.parseFloat(n,this.getCommonPrecision())}else if(i.Type.isNumber(n)){n=this.parseFloat(n,this.getPricePrecision()).toFixed(this.getPricePrecision())}this.updateUiInputField(a,n);break;case"checkbox":this.updateUiCheckboxField(a,n);break;case"discount_type_field":this.updateUiDiscountTypeField(a,n);break;case"html":this.updateUiHtmlField(a,n);break;case"money_html":n=s.CurrencyCore.currencyFormat(n,this.getEditor().getCurrencyId(),true);this.updateUiHtmlField(a,n);break}}},{key:"getUiFieldName",value:function e(t){var i=null;switch(t){case"QUANTITY":case"MEASURE_CODE":case"DISCOUNT_ROW":case"DISCOUNT_TYPE_ID":case"TAX_RATE":case"TAX_INCLUDED":case"TAX_SUM":case"SUM":case"PRODUCT_NAME":case"SORT":i=t;break;case"PRICE_NETTO":case"PRICE_BRUTTO":i="PRICE";break;case"DISCOUNT_RATE":case"DISCOUNT_SUM":i="DISCOUNT_PRICE";break}return i}},{key:"getUiFieldType",value:function e(t){var i=null;switch(t){case"PRICE_NETTO":case"PRICE_BRUTTO":case"QUANTITY":case"TAX_RATE":case"DISCOUNT_RATE":case"DISCOUNT_SUM":case"DISCOUNT_ROW":case"SUM":case"PRODUCT_NAME":case"SORT":i="input";break;case"DISCOUNT_TYPE_ID":i="discount_type_field";break;case"TAX_INCLUDED":i="checkbox";break;case"TAX_SUM":i="money_html";break}return i}},{key:"allowUpdateUiField",value:function e(t){var i=true;switch(t){case"PRICE_NETTO":i=this.isPriceNetto();break;case"PRICE_BRUTTO":i=!this.isPriceNetto();break;case"DISCOUNT_RATE":i=this.isDiscountPercentage();break;case"DISCOUNT_SUM":i=this.isDiscountMonetary();break}return i}},{key:"parseInt",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;return this.getEditor().parseInt(t,i)}},{key:"parseFloat",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;return this.getEditor().parseFloat(t,i,n)}},{key:"getPricePrecision",value:function e(){return this.getEditor().getPricePrecision()}},{key:"getQuantityPrecision",value:function e(){return this.getEditor().getQuantityPrecision()}},{key:"getCommonPrecision",value:function e(){return this.getEditor().getCommonPrecision()}},{key:"resetExternalActions",value:function e(){this.externalActions.length=0}},{key:"addExternalAction",value:function e(t){this.externalActions.push(t)}},{key:"addActionProductChange",value:function e(){this.addExternalAction({type:this.getEditor().actions.productChange,id:this.getId()})}},{key:"addActionUpdateFieldList",value:function e(t,i){this.addExternalAction({type:this.getEditor().actions.updateListField,field:t,value:i})}},{key:"addActionStateChanged",value:function e(){this.addExternalAction({type:this.getEditor().actions.stateChanged,value:true})}},{key:"addActionStateReset",value:function e(){this.addExternalAction({type:this.getEditor().actions.stateChanged,value:false})}},{key:"addActionUpdateTotal",value:function e(){this.addExternalAction({type:this.getEditor().actions.updateTotal})}},{key:"executeExternalActions",value:function e(){if(this.externalActions.length===0){return}this.getEditor().executeActions(this.externalActions);this.resetExternalActions()}}]);return e}();e.Row=X;e.Editor=x;e.PageEventsManager=o})(this.BX.Crm.Entity.ProductList=this.BX.Crm.Entity.ProductList||{},BX.Main,BX,BX.Event,BX.Catalog,BX.Catalog,BX.Currency);
//# sourceMappingURL=script.map.js