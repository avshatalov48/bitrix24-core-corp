this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};this.BX.Crm.Entity=this.BX.Crm.Entity||{};(function(e,t,i,n,r,a,s,l,o,u,d,c,h,v,g){"use strict";var f;var p=function(){function e(t){babelHelpers.classCallCheck(this,e);this.editor=t}babelHelpers.createClass(e,[{key:"load",value:function e(t,i){if(!this.hintPopup){this.hintPopup=new a.Popup("ui-hint-popup-"+this.editor.getId(),null,{darkMode:true,closeIcon:true,animation:"fading-slide"})}this.hintPopup.setBindElement(t);this.hintPopup.adjustPosition();this.hintPopup.setContent(h.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div class='ui-hint-content'>","</div>\n\t\t"])),h.Text.encode(i)));return this.hintPopup}},{key:"show",value:function e(){if(this.hintPopup){this.hintPopup.show()}}},{key:"close",value:function e(){if(this.hintPopup){this.hintPopup.close()}}}]);return e}();var E,y,T,b,C;function S(e,t){I(e,t);t.add(e)}function m(e,t,i){I(e,t);t.set(e,i)}function I(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function P(e,t,i){R(e,t);return i}function R(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function D(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var F=new WeakMap;var N=new WeakMap;var _=new WeakSet;var k=new WeakSet;var A=new WeakSet;var w=function(){function e(t){babelHelpers.classCallCheck(this,e);S(this,A);S(this,k);S(this,_);m(this,F,{writable:true,value:null});m(this,N,{writable:true,value:new h.Cache.MemoryCache});babelHelpers.defineProperty(this,"isReserveEqualProductQuantity",true);babelHelpers.defineProperty(this,"wrapper",null);babelHelpers.classPrivateFieldSet(this,F,t.row);this.inputFieldName=t.inputName||e.INPUT_NAME;this.dateFieldName=t.dateFieldName||e.DATE_NAME;this.quantityFieldName=t.quantityFieldName||e.QUANTITY_NAME;this.deductedQuantityFieldName=t.deductedQuantityFieldName||e.DEDUCTED_QUANTITY_NAME;this.defaultDateReservation=t.defaultDateReservation||null;this.isBlocked=t.isBlocked||false;this.measureName=t.measureName;this.isReserveEqualProductQuantity=t.isReserveEqualProductQuantity&&(this.getReservedQuantity()===this.getQuantity()||babelHelpers.classPrivateFieldGet(this,F).isNewRow())}babelHelpers.createClass(e,[{key:"renderTo",value:function t(i){this.wrapper=i;h.Dom.append(h.Tag.render(E||(E=babelHelpers.taggedTemplateLiteral(["<div>","</div>"])),D(this,k,M).call(this)),this.wrapper);h.Event.bind(D(this,k,M).call(this).querySelector("input"),"input",h.Runtime.debounce(this.onReserveInputChange,800,this));if(this.getReservedQuantity()>0||this.isReserveEqualProductQuantity){D(this,A,H).call(this,this.getDateReservation())}h.Dom.append(D(this,_,O).call(this),this.wrapper);h.Event.bind(D(this,_,O).call(this),"click",P(e,e,U).bind(this));h.Event.bind(D(this,_,O).call(this).querySelector("input"),"change",this.onDateChange.bind(this))}},{key:"setReservedQuantity",value:function e(t,i){var n=D(this,k,M).call(this).querySelector("input");if(n){n.value=t;if(i){n.dispatchEvent(new window.Event("input"))}}}},{key:"getReservedQuantity",value:function e(){return h.Text.toNumber(babelHelpers.classPrivateFieldGet(this,F).getField(this.inputFieldName))}},{key:"getDateReservation",value:function e(){return babelHelpers.classPrivateFieldGet(this,F).getField(this.dateFieldName)||""}},{key:"getQuantity",value:function e(){return h.Text.toNumber(babelHelpers.classPrivateFieldGet(this,F).getField(this.quantityFieldName))}},{key:"getDeductedQuantity",value:function e(){return h.Text.toNumber(babelHelpers.classPrivateFieldGet(this,F).getField(this.deductedQuantityFieldName))}},{key:"getAvailableQuantity",value:function e(){return this.getQuantity()-this.getDeductedQuantity()}},{key:"onReserveInputChange",value:function e(t){var i=h.Text.toNumber(t.target.value);this.changeInputValue(i)}},{key:"changeInputValue",value:function e(t){if(t>this.getAvailableQuantity()){var i="reserveCountError";var n=BX.UI.Notification.Center.getBalloonById(i);if(!n){var r={id:i,closeButton:true,autoHideDelay:3e3,content:h.Tag.render(y||(y=babelHelpers.taggedTemplateLiteral(["<div>","</div>"])),h.Loc.getMessage("CRM_ENTITY_PL_IS_LESS_QUANTITY_WITH_DEDUCTED_THEN_RESERVED"))};n=BX.UI.Notification.Center.notify(r)}n.show();t=this.getAvailableQuantity();this.setReservedQuantity(t)}if(t>0){var a=this.getDateReservation();if(a===""){this.changeDateReservation(this.defaultDateReservation)}else{D(this,A,H).call(this,a)}}else if(t<=0){this.changeDateReservation()}this.setReservedQuantity(t,false);babelHelpers.classPrivateFieldGet(this,F).updateField(this.inputFieldName,t)}},{key:"clearCache",value:function e(){babelHelpers.classPrivateFieldGet(this,N)["delete"]("dateInput");babelHelpers.classPrivateFieldGet(this,N)["delete"]("reserveInput")}},{key:"isInputDisabled",value:function e(){if(this.isBlocked){return true}var t=babelHelpers.classPrivateFieldGet(this,F).getModel();if(t){return t.isSimple()||t.isService()}return false}},{key:"onDateChange",value:function e(t){var i=t.target.value;var n=BX.parseDate(i);var r=new Date;r.setHours(0,0,0,0);if(n>=r){this.changeDateReservation(i)}else{var a="reserveDateError";var s=BX.UI.Notification.Center.getBalloonById(a);if(!s){var l={id:a,closeButton:true,autoHideDelay:3e3,content:h.Tag.render(T||(T=babelHelpers.taggedTemplateLiteral(["<div>","</div>"])),h.Loc.getMessage("CRM_ENTITY_PL_DATE_IN_PAST"))};s=BX.UI.Notification.Center.notify(l)}s.show();this.changeDateReservation(this.defaultDateReservation)}}},{key:"changeDateReservation",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";if(t!==this.getDateReservation()){babelHelpers.classPrivateFieldGet(this,F).updateField(this.dateFieldName,t)}D(this,A,H).call(this,t)}},{key:"disable",value:function e(t){var i=t||this.wrapper;if(i){i.innerHTML=this.getReservedQuantity()+" "+h.Text.encode(this.measureName)}}}]);return e}();function U(e){BX.calendar({node:e.target,field:e.target.parentNode.querySelector("input"),bTime:false})}function O(){var e=this;return babelHelpers.classPrivateFieldGet(this,N).remember("dateInput",(function(){return h.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div>\n\t\t\t\t\t<a class="crm-entity-product-list-reserve-date"></a>\n\t\t\t\t\t<input\n\t\t\t\t\t\tdata-name="','"\n\t\t\t\t\t\tname="','"\n\t\t\t\t\t\ttype="hidden"\n\t\t\t\t\t\tvalue="','"\n\t\t\t\t\t>\n\t\t\t\t</div>\n\t\t\t'])),e.dateFieldName,e.dateFieldName,e.getDateReservation())}))}function M(){var e=this;return babelHelpers.classPrivateFieldGet(this,N).remember("reserveInput",(function(){var t=h.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div>\n\t\t\t\t\t<input type="text"\n\t\t\t\t\t\tdata-name="','"\n\t\t\t\t\t\tname="','"\n\t\t\t\t\t\tclass="ui-ctl-element ui-ctl-textbox ','"\n\t\t\t\t\t\tautoComplete="off"\n\t\t\t\t\t\tvalue="','"\n\t\t\t\t\t\tplaceholder="0"\n\t\t\t\t\t\ttitle="','"\n\t\t\t\t\t\t',"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t"])),e.inputFieldName,e.inputFieldName,e.isInputDisabled()?"crm-entity-product-list-locked-field":"",e.getReservedQuantity(),e.getReservedQuantity(),e.isInputDisabled()?"disabled":"");if(e.isBlocked){t.onclick=function(){return s.EventEmitter.emit(e,"onNodeClick")}}return t}))}function H(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var t=e===""?"":h.Loc.getMessage("CRM_ENTITY_PL_RESERVED_DATE",{"#FINAL_RESERVATION_DATE#":e});var i=D(this,_,O).call(this).querySelector("a");if(i){i.innerText=t}var n=D(this,_,O).call(this).querySelector("input");if(n){n.value=e}}babelHelpers.defineProperty(w,"INPUT_NAME","INPUT_RESERVE_QUANTITY");babelHelpers.defineProperty(w,"DATE_NAME","DATE_RESERVE_END");babelHelpers.defineProperty(w,"QUANTITY_NAME","QUANTITY");babelHelpers.defineProperty(w,"DEDUCTED_QUANTITY_NAME","DEDUCTED_QUANTITY");var B;function L(e,t){G(e,t);t.add(e)}function x(e,t,i){G(e,t);t.set(e,i)}function G(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function V(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var Y=new WeakMap;var W=new WeakMap;var X=new WeakMap;var Q=new WeakMap;var q=new WeakSet;var j=function(){function e(t){babelHelpers.classCallCheck(this,e);L(this,q);x(this,Y,{writable:true,value:void 0});x(this,W,{writable:true,value:void 0});x(this,X,{writable:true,value:void 0});x(this,Q,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,Y,t.rowId);babelHelpers.classPrivateFieldSet(this,W,t.model);this.setNode(t.node)}babelHelpers.createClass(e,[{key:"setNode",value:function e(t){babelHelpers.classPrivateFieldSet(this,X,t);babelHelpers.classPrivateFieldGet(this,X).classList.add("store-available-popup-link");h.Event.bind(babelHelpers.classPrivateFieldGet(this,X),"click",this.togglePopup.bind(this))}},{key:"refreshStoreInfo",value:function e(){babelHelpers.classPrivateFieldGet(this,W).getStoreCollection().refresh()}},{key:"getPopupContent",value:function e(){var t=this;var i=babelHelpers.classPrivateFieldGet(this,W).getField("STORE_ID");var n=babelHelpers.classPrivateFieldGet(this,W).getStoreCollection();var r=n.getStoreAmount(i);var a=n.getStoreReserved(i);var s=n.getStoreAvailableAmount(i);var l=function e(t){return'<td class="main-grid-cell-head main-grid-col-no-sortable main-grid-cell-right">\n\t\t\t\t<div class="main-grid-cell-inner">\n\t\t\t\t\t<span class="main-grid-cell-head-container">'.concat(t,"</span>\n\t\t\t\t</div>\n\t\t\t</td>")};var o=function e(t){return'<td class="main-grid-cell main-grid-cell-right">\n\t\t\t\t<div class="main-grid-cell-inner">\n\t\t\t\t\t<span class="main-grid-cell-content">'.concat(t,"</span>\n\t\t\t\t</div>\n\t\t\t</td>")};var u=a>0?'<a href="#" class="store-available-popup-reserves-slider-link">'.concat(a,"</a>"):a;var d=s<=0?'<span class="text--danger">'.concat(s):s;var c=h.Tag.render(B||(B=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="store-available-popup-container">\n\t\t\t\t<table class="main-grid-table">\n\t\t\t\t\t<thead class="main-grid-header">\n\t\t\t\t\t\t<tr class="main-grid-row-head">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t","\n\t\t\t\t\t\t\t",'\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</thead>\n\t\t\t\t\t<tbody>\n\t\t\t\t\t\t<tr class="main-grid-row main-grid-row-body">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t","\n\t\t\t\t\t\t\t","\n\t\t\t\t\t\t</tr>\n\t\t\t\t\t</tbody>\n\t\t\t\t</table>\n\t\t\t</div>\n\t\t"])),l(h.Loc.getMessage("CRM_ENTITY_PL_STORE_AVAILABLE_POPUP_QUANTITY_COMMON")),l(h.Loc.getMessage("CRM_ENTITY_PL_STORE_AVAILABLE_POPUP_QUANTITY_RESERVED")),l(h.Loc.getMessage("CRM_ENTITY_PL_STORE_AVAILABLE_POPUP_QUANTITY_AVAILABLE")),o(r),o(u),o(d));if(a>0){u=c.querySelector(".store-available-popup-reserves-slider-link");h.Event.bind(u,"click",(function(e){e.preventDefault();t.openDealsWithReservedProductSlider()}))}return c}},{key:"openDealsWithReservedProductSlider",value:function e(){var t="/bitrix/components/bitrix/catalog.productcard.reserved.deal.list/slider.php";var i=babelHelpers.classPrivateFieldGet(this,W).getField("STORE_ID");var n=babelHelpers.classPrivateFieldGet(this,W).getField("PRODUCT_ID");var r=new h.Uri(t);r.setQueryParam("productId",n);r.setQueryParam("storeId",i);BX.SidePanel.Instance.open(r.toString(),{allowChangeHistory:false,cacheable:false})}},{key:"togglePopup",value:function e(){if(babelHelpers.classPrivateFieldGet(this,Q)){if(babelHelpers.classPrivateFieldGet(this,Q).isShown()){babelHelpers.classPrivateFieldGet(this,Q).close()}else{babelHelpers.classPrivateFieldGet(this,Q).setContent(this.getPopupContent());babelHelpers.classPrivateFieldGet(this,Q).show()}}else{V(this,q,z).call(this);babelHelpers.classPrivateFieldGet(this,Q).show()}}}]);return e}();function z(){var e="store-available-popup-row-".concat(babelHelpers.classPrivateFieldGet(this,Y));var t=a.PopupManager.getPopupById(e);if(t){babelHelpers.classPrivateFieldSet(this,Q,t);babelHelpers.classPrivateFieldGet(this,Q).setBindElement(babelHelpers.classPrivateFieldGet(this,X));babelHelpers.classPrivateFieldGet(this,Q).setContent(this.getPopupContent())}else{babelHelpers.classPrivateFieldSet(this,Q,a.PopupManager.create({id:e,bindElement:babelHelpers.classPrivateFieldGet(this,X),autoHide:true,draggable:false,offsetLeft:-218,offsetTop:0,angle:{position:"top",offset:250},noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,content:this.getPopupContent()}))}}var K=function(){function e(t){babelHelpers.classCallCheck(this,e);this.node=t.node;this.hint=t.hint}babelHelpers.createClass(e,[{key:"enable",value:function e(){var t;this.node.removeAttribute("disabled");this.node.removeAttribute("data-hint-no-icon");this.node.removeAttribute("data-hint");this.node.classList.remove("ui-ctl-element");var i=this.node.querySelector(".main-grid-editor-money-currency");if(i){i.classList.add("main-dropdown");i.dataset.disabled=false}(t=this.node.querySelector(".main-grid-editor-money-price"))===null||t===void 0?void 0:t.removeAttribute("disabled")}},{key:"disable",value:function e(){var t;this.node.setAttribute("disabled","");this.node.classList.add("ui-ctl-element");(t=this.node.querySelector(".main-grid-editor-money-price"))===null||t===void 0?void 0:t.setAttribute("disabled","");var i=this.node.querySelector(".main-grid-editor-money-currency");if(i){i.classList.remove("main-dropdown");i.dataset.disabled=true}if(this.hint){this.node.setAttribute("data-hint-no-icon","");this.node.setAttribute("data-hint",this.hint);BX.UI.Hint.init(this.node.parentNode)}}}]);return e}();var Z,J,$,ee;function te(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=ie(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var r=function e(){};return{s:r,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,s=false,l;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();a=t.done;return t},e:function e(t){s=true;l=t},f:function e(){try{if(!a&&i["return"]!=null)i["return"]()}finally{if(s)throw l}}}}function ie(e,t){if(!e)return;if(typeof e==="string")return ne(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return ne(e,t)}function ne(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++){n[i]=e[i]}return n}function re(e,t){ae(e,t);t.add(e)}function ae(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function se(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var le="EDIT";var oe="SET";var ue=new WeakSet;var de=new WeakSet;var ce=new WeakSet;var he=new WeakSet;var ve=new WeakSet;var ge=new WeakSet;var fe=new WeakSet;var pe=new WeakSet;var Ee=new WeakSet;var ye=new WeakSet;var Te=new WeakSet;var be=new WeakSet;var Ce=new WeakSet;var Se=new WeakSet;var me=new WeakSet;var Ie=new WeakSet;var Pe=new WeakSet;var Re=new WeakSet;var De=new WeakSet;var Fe=new WeakSet;var Ne=new WeakSet;var _e=new WeakSet;var ke=new WeakSet;var Ae=function(){function e(t,i,n,r){babelHelpers.classCallCheck(this,e);re(this,ke);re(this,_e);re(this,Ne);re(this,Fe);re(this,De);re(this,Re);re(this,Pe);re(this,Ie);re(this,me);re(this,Se);re(this,Ce);re(this,be);re(this,Te);re(this,ye);re(this,Ee);re(this,pe);re(this,fe);re(this,ge);re(this,ve);re(this,he);re(this,ce);re(this,de);re(this,ue);babelHelpers.defineProperty(this,"fields",{});babelHelpers.defineProperty(this,"externalActions",[]);babelHelpers.defineProperty(this,"handleChangeStoreData",se(this,be,Ye).bind(this));babelHelpers.defineProperty(this,"handleProductErrorsChange",h.Runtime.debounce(se(this,Ce,We),500,this));babelHelpers.defineProperty(this,"handleMainSelectorClear",h.Runtime.debounce(se(this,ve,Me).bind(this),500,this));babelHelpers.defineProperty(this,"handleStoreFieldChange",h.Runtime.debounce(se(this,ye,Ge).bind(this),500,this));babelHelpers.defineProperty(this,"handleStoreFieldClear",h.Runtime.debounce(se(this,Te,Ve).bind(this),500,this));babelHelpers.defineProperty(this,"handleOnGridUpdated",se(this,Ne,Je).bind(this));babelHelpers.defineProperty(this,"cache",new h.Cache.MemoryCache);babelHelpers.defineProperty(this,"modeChanges",{EDIT:le,SET:oe});this.setId(t);this.setSettings(n);this.setEditor(r);this.setModel(i,n);this.setFields(i);se(this,ue,we).call(this);se(this,he,Oe).call(this);se(this,ge,He).call(this);se(this,fe,Be).call(this);se(this,Ee,xe).call(this);this.modifyBasePriceInput();this.modifyQuantityInput();this.refreshFieldsLayout();requestAnimationFrame(this.initHandlers.bind(this))}babelHelpers.createClass(e,[{key:"getNode",value:function e(){var t=this;return this.cache.remember("node",(function(){var e=t.getField("ID",0);return t.getEditorContainer().querySelector('[data-id="'+e+'"]')}))}},{key:"getSelector",value:function e(){return this.mainSelector}},{key:"isNewRow",value:function e(){return isNaN(+this.getField("ID"))}},{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"getSettings",value:function e(){return this.settings}},{key:"setSettings",value:function e(t){this.settings=h.Type.isPlainObject(t)?t:{}}},{key:"getSettingValue",value:function e(t,i){return this.settings.hasOwnProperty(t)?this.settings[t]:i}},{key:"setSettingValue",value:function e(t,i){this.settings[t]=i}},{key:"setEditor",value:function e(t){this.editor=t}},{key:"getEditor",value:function e(){return this.editor}},{key:"getEditorContainer",value:function e(){return this.getEditor().getContainer()}},{key:"getHintPopup",value:function e(){return this.getEditor().getHintPopup()}},{key:"initHandlers",value:function e(){var t=this.getEditor();this.getNode().querySelectorAll("input").forEach((function(e){h.Event.bind(e,"input",t.changeProductFieldHandler);h.Event.bind(e,"change",t.changeProductFieldHandler);h.Event.bind(e,"mousedown",(function(e){return e.stopPropagation()}))}));this.getNode().querySelectorAll("select").forEach((function(e){h.Event.bind(e,"change",t.changeProductFieldHandler);h.Event.bind(e,"mousedown",(function(e){return e.stopPropagation()}))}))}},{key:"initHandlersForSelectors",value:function e(){var t=this;var i=this.getEditor();var n=["MAIN_INFO","STORE_INFO","RESERVE_INFO"];n.forEach((function(e){t.getNode().querySelectorAll('[data-name="'+e+'"] input[type="text"]').forEach((function(e){h.Event.bind(e,"input",i.changeProductFieldHandler);h.Event.bind(e,"change",i.changeProductFieldHandler);h.Event.bind(e,"mousedown",(function(e){return e.stopPropagation()}))}))}))}},{key:"unsubscribeCustomEvents",value:function e(){if(this.mainSelector){this.mainSelector.unsubscribeEvents();s.EventEmitter.unsubscribe(this.mainSelector,"onClear",this.handleMainSelectorClear)}if(this.storeSelector){this.storeSelector.unsubscribeEvents();s.EventEmitter.unsubscribe(this.storeSelector,"onChange",this.handleStoreFieldChange);s.EventEmitter.unsubscribe(this.storeSelector,"onClear",this.handleStoreFieldClear)}s.EventEmitter.unsubscribe(this.model,"onChangeStoreData",this.handleChangeStoreData);s.EventEmitter.unsubscribe(this.model,"onErrorsChange",this.handleProductErrorsChange)}},{key:"modifyBasePriceInput",value:function e(){var t=se(this,De,Ke).call(this,"PRICE");if(!t){return}var i=new K({node:t,hint:h.Loc.getMessage("CRM_ENTITY_PL_PRICE_CHANGING_RESTRICTED")});if(!se(this,de,Ue).call(this)){i.disable()}else{i.enable()}}},{key:"modifyQuantityInput",value:function e(){if(!this.isRestrictedStoreInfo()){return}var t=se(this,De,Ke).call(this,"QUANTITY");if(t){var i=new K({node:t,hint:h.Loc.getMessage("CRM_ENTITY_PL_ROW_UPDATE_RESTRICTED_BY_STORE")});i.disable()}}},{key:"layoutStoreSelector",value:function e(){var t=se(this,De,Ke).call(this,"STORE_INFO");if(this.storeSelector&&t){t.innerHTML="";if(se(this,ke,et).call(this)){this.storeSelector.renderTo(t);if(this.isReserveBlocked()){se(this,pe,Le).call(this)}}}}},{key:"layoutReserveControl",value:function e(){var t=se(this,De,Ke).call(this,"RESERVE_INFO");if(t&&this.reserveControl){t.innerHTML="";this.reserveControl.clearCache();if(se(this,_e,$e).call(this)){if(this.isRestrictedStoreInfo()){t.innerHTML=this.reserveControl.getReservedQuantity()+" "+h.Text.encode(se(this,Re,ze).call(this));return}this.reserveControl.renderTo(t)}}}},{key:"clearReserveControl",value:function e(){var t=se(this,De,Ke).call(this,"RESERVE_INFO");if(t&&this.reserveControl){t.innerHTML="";this.reserveControl.clearCache()}}},{key:"setRowNumber",value:function e(t){this.getNode().querySelectorAll(".main-grid-row-number").forEach((function(e){e.textContent=t+"."}))}},{key:"getFields",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var i;if(!h.Type.isArrayFilled(t)){i=h.Runtime.clone(this.fields)}else{i={};var n=te(t),r;try{for(n.s();!(r=n.n()).done;){var a=r.value;i[a]=this.getField(a)}}catch(e){n.e(e)}finally{n.f()}}if("PRODUCT_NAME"in i){var s=this.getField("FIXED_PRODUCT_NAME","");if(h.Type.isStringFilled(s)){i["PRODUCT_NAME"]=s}}return i}},{key:"getCatalogFields",value:function e(){var t=this.getFields(["CURRENCY","QUANTITY","MEASURE_CODE"]);t["PRICE"]=this.getBasePrice();t["VAT_INCLUDED"]=this.getTaxIncluded();t["VAT_ID"]=this.getTaxId();return t}},{key:"getCalculateFields",value:function e(){return{PRICE:this.getPrice(),BASE_PRICE:this.getBasePrice(),PRICE_EXCLUSIVE:this.getPriceExclusive(),PRICE_NETTO:this.getPriceNetto(),PRICE_BRUTTO:this.getPriceBrutto(),QUANTITY:this.getQuantity(),DISCOUNT_TYPE_ID:this.getDiscountType(),DISCOUNT_RATE:this.getDiscountRate(),DISCOUNT_SUM:this.getDiscountSum(),DISCOUNT_ROW:this.getDiscountRow(),TAX_INCLUDED:this.getTaxIncluded(),TAX_RATE:this.getTaxRate()}}},{key:"setFields",value:function e(t){for(var i in t){if(t.hasOwnProperty(i)){this.setField(i,t[i]);this.getModel().setField(i,t[i])}}}},{key:"getField",value:function e(t,i){return this.fields.hasOwnProperty(t)?this.fields[t]:i}},{key:"setField",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;this.fields[t]=i;if(n){this.getModel().setField(t,i)}}},{key:"getUiFieldId",value:function e(t){return this.getId()+"_"+t}},{key:"getBasePrice",value:function e(){return this.getField("BASE_PRICE",0)}},{key:"isPriceNetto",value:function e(){return this.getEditor().isTaxAllowed()&&!this.isTaxIncluded()}},{key:"getPrice",value:function e(){return this.getField("PRICE",0)}},{key:"getPriceExclusive",value:function e(){return this.getField("PRICE_EXCLUSIVE",0)}},{key:"getPriceNetto",value:function e(){return this.getField("PRICE_NETTO",0)}},{key:"getPriceBrutto",value:function e(){return this.getField("PRICE_BRUTTO",0)}},{key:"getQuantity",value:function e(){return this.getField("QUANTITY",1)}},{key:"getDiscountType",value:function e(){return this.getField("DISCOUNT_TYPE_ID",r.DiscountType.UNDEFINED)}},{key:"isDiscountUndefined",value:function e(){return this.getDiscountType()===r.DiscountType.UNDEFINED}},{key:"isDiscountPercentage",value:function e(){return this.getDiscountType()===r.DiscountType.PERCENTAGE}},{key:"isDiscountMonetary",value:function e(){return this.getDiscountType()===r.DiscountType.MONETARY}},{key:"isDiscountHandmade",value:function e(){return this.isDiscountPercentage()||this.isDiscountMonetary()}},{key:"getDiscountRate",value:function e(){return this.getField("DISCOUNT_RATE",0)}},{key:"getDiscountSum",value:function e(){return this.getField("DISCOUNT_SUM",0)}},{key:"getDiscountRow",value:function e(){return this.getField("DISCOUNT_ROW",0)}},{key:"isEmptyDiscount",value:function e(){if(this.isDiscountPercentage()){return this.getDiscountRate()===0}else if(this.isDiscountMonetary()){return this.getDiscountSum()===0}else if(this.isDiscountUndefined()){return true}return false}},{key:"isEmptyRow",value:function e(){return!h.Type.isStringFilled(this.getField("NAME","").trim())&&this.model.isEmpty()&&this.getBasePrice()<=0}},{key:"getTaxIncluded",value:function e(){return this.getField("TAX_INCLUDED","N")}},{key:"isTaxIncluded",value:function e(){return this.getTaxIncluded()==="Y"}},{key:"getTaxRate",value:function e(){return this.getField("TAX_RATE",0)}},{key:"getTaxSum",value:function e(){return this.isTaxIncluded()?this.getPrice()*this.getQuantity()*(1-1/(1+this.getTaxRate()/100)):this.getPriceExclusive()*this.getQuantity()*this.getTaxRate()/100}},{key:"getTaxNode",value:function e(){return this.getNode().querySelector('select[data-field-code="TAX_RATE"]')}},{key:"getTaxId",value:function e(){var t=this.getTaxNode();if(h.Type.isDomNode(t)&&t.options[t.selectedIndex]){return h.Text.toNumber(t.options[t.selectedIndex].getAttribute("data-tax-id"))}return 0}},{key:"updateFieldByEvent",value:function e(t,i){var n=i.target;var r=n.type==="checkbox"?n.checked:n.value;var a=i.type==="input"||i.type==="change"?le:oe;this.updateField(t,r,a)}},{key:"updateField",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:oe;this.resetExternalActions();this.updateFieldValue(t,i,n);this.executeExternalActions()}},{key:"updateFieldValue",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:oe;switch(t){case"ID":case"OFFER_ID":this.changeProductId(i);break;case"QUANTITY":this.changeQuantity(i,n);break;case"MEASURE_CODE":this.changeMeasureCode(i,n);break;case"DISCOUNT":case"DISCOUNT_PRICE":this.changeDiscount(i,n);break;case"DISCOUNT_TYPE_ID":this.changeDiscountType(i);break;case"DISCOUNT_ROW":this.changeRowDiscount(i,n);break;case"VAT_ID":case"TAX_ID":this.changeTaxId(i);break;case"TAX_RATE":this.changeTaxRate(i);break;case"VAT_INCLUDED":case"TAX_INCLUDED":this.changeTaxIncluded(i);break;case"SUM":this.changeRowSum(i,n);break;case"NAME":case"PRODUCT_NAME":case"MAIN_INFO":this.changeProductName(i);break;case"SORT":this.changeSort(i,n);break;case"STORE_ID":this.changeStore(i);break;case"STORE_TITLE":this.changeStoreName(i);break;case"INPUT_RESERVE_QUANTITY":this.changeReserveQuantity(i);break;case"DATE_RESERVE_END":this.changeDateReserveEnd(i);break;case"PRICE":case"BASE_PRICE":this.changeBasePrice(i,n);break;case"DEDUCTED_QUANTITY":this.setDeductedQuantity(i);break;case"ROW_RESERVED":this.setRowReserved(i);break;case"TYPE":this.setType(i);break;case"SKU_TREE":case"DETAIL_URL":case"IMAGE_INFO":case"COMMON_STORE_AMOUNT":this.setField(t,i);break}}},{key:"updateFieldByName",value:function e(t,i){switch(t){case"TAX_INCLUDED":this.setTaxIncluded(i);break}}},{key:"handleCopyAction",value:function e(t,i){var n;(n=this.getEditor())===null||n===void 0?void 0:n.copyRow(this);var r=i.getMenuWindow();if(r){r.destroy()}}},{key:"handleDeleteAction",value:function e(t,i){var n;(n=this.getEditor())===null||n===void 0?void 0:n.deleteRow(this.getField("ID"));var r=i.getMenuWindow();if(r){r.destroy()}}},{key:"changeProductId",value:function e(t){var i=this.parseInt(t);this.setProductId(i)}},{key:"changeQuantity",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:oe;var n=this.parseFloat(t,this.getQuantityPrecision());this.setQuantity(n,i)}},{key:"changeMeasureCode",value:function e(t){var i=this;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:oe;this.getEditor().getMeasures().filter((function(e){return e.CODE===t})).forEach((function(e){return i.setMeasure(e,n)}))}},{key:"changeDiscount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:oe;var n;if(this.isDiscountPercentage()){n=this.parseFloat(t,this.getCommonPrecision())}else{n=this.parseFloat(t,this.getPricePrecision()).toFixed(this.getPricePrecision())}this.setDiscount(n,i)}},{key:"changeDiscountType",value:function e(t){var i=this.parseInt(t,r.DiscountType.UNDEFINED);this.setDiscountType(i)}},{key:"changeRowDiscount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:oe;var n=this.parseFloat(t,this.getPricePrecision());this.setRowDiscount(n,i)}},{key:"changeTaxId",value:function e(t){var i=this.getEditor().getTaxList();if(h.Type.isArrayFilled(i)){var n=i.find((function(e){return parseInt(e.ID)===parseInt(t)}));if(!n){n=i.find((function(e){return h.Type.isNil(e.VALUE)}))}if(n){this.changeTaxRate(n.VALUE)}}}},{key:"changeTaxRate",value:function e(t){var i=h.Type.isNil(t)||t===""?null:this.parseFloat(t,this.getCommonPrecision());this.setTaxRate(i)}},{key:"changeTaxIncluded",value:function e(t){if(h.Type.isBoolean(t)){t=t?"Y":"N"}this.setTaxIncluded(t)}},{key:"changeRowSum",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:oe;var n=this.parseFloat(t,this.getPricePrecision());this.setRowSum(n,i)}},{key:"changeProductName",value:function e(t){var i=t.toString();var n=this.getField("PRODUCT_NAME")!==i;if(n){this.setField("PRODUCT_NAME",i);this.setField("NAME",i);this.addActionProductChange()}}},{key:"changeSort",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:oe;var n=this.parseInt(t);if(i===oe){this.setField("SORT",n)}var r=this.getField("SORT")!==n;if(r){this.addActionProductChange()}}},{key:"changeStore",value:function e(t){if(this.isReserveBlocked()){return}var i=h.Text.toNumber(t);if(this.getField("STORE_ID")===i){return}this.setField("STORE_ID",i);this.setField("STORE_AVAILABLE",this.model.getStoreCollection().getStoreAvailableAmount(t));this.updateUiStoreAmountData();this.layoutReserveControl();this.addActionProductChange()}},{key:"updateUiStoreAmountData",value:function e(){var t=se(this,De,Ke).call(this,"STORE_AVAILABLE");if(!h.Type.isDomNode(t)){return}var i=this.getField("STORE_ID");if(!i){return}var n=this.model.getStoreCollection().getStoreAvailableAmount(i);var r=h.Text.toNumber(n);var a="";if(!this.getModel().isCatalogExisted()||this.isRestrictedStoreInfo()||this.getModel().isService());else{a=r+" "+se(this,Re,ze).call(this)}t.innerHTML=r>0?a:'<span class="store-available-popup-link--danger">'.concat(a,"</span>")}},{key:"updatePropertyFields",value:function e(){var t=this.model.getField("PRODUCT_PROPERTIES");for(var i in t){var n=se(this,De,Ke).call(this,i);if(n){var r;var a=(r=this.model.getField("PRODUCT_PROPERTIES")[i])!==null&&r!==void 0?r:"";n.innerHTML=a}}}},{key:"clearPropertyFields",value:function e(){var t=se(this,Fe,Ze).call(this);t.forEach((function(e){e.innerHTML=""}))}},{key:"setRowReserved",value:function e(t){this.setField("ROW_RESERVED",t);var i=se(this,De,Ke).call(this,"ROW_RESERVED");if(!h.Type.isDomNode(i)){return}if(!this.getModel().isCatalogExisted()||this.getModel().isService()){i.innerHTML="";return}i.innerHTML=h.Text.toNumber(this.getField("ROW_RESERVED"))+" "+se(this,Re,ze).call(this)}},{key:"setDeductedQuantity",value:function e(t){this.setField("DEDUCTED_QUANTITY",t);var i=se(this,De,Ke).call(this,"DEDUCTED_QUANTITY");if(!h.Type.isDomNode(i)){return}if(!this.getModel().isCatalogExisted()||this.getModel().isService()){i.innerHTML="";return}i.innerHTML=h.Text.toNumber(this.getField("DEDUCTED_QUANTITY"))+" "+se(this,Re,ze).call(this)}},{key:"changeStoreName",value:function e(t){var i=t.toString();this.setField("STORE_TITLE",i);this.addActionProductChange()}},{key:"changeDateReserveEnd",value:function e(t){var i=h.Type.isNil(t)?"":t.toString();this.setField("DATE_RESERVE_END",i);this.addActionProductChange()}},{key:"changeReserveQuantity",value:function e(t){var i=h.Text.toNumber(t);var n=i-this.getField("INPUT_RESERVE_QUANTITY");if(n===0||isNaN(n)){return}var r=this.getField("ROW_RESERVED")+n;this.setField("ROW_RESERVED",r);this.setField("RESERVE_QUANTITY",Math.max(r,0));this.setField("INPUT_RESERVE_QUANTITY",i);this.addActionProductChange()}},{key:"resetReserveFields",value:function e(){this.setField("ROW_RESERVED",null);this.setField("RESERVE_QUANTITY",null);this.setField("INPUT_RESERVE_QUANTITY",null)}},{key:"refreshFieldsLayout",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];for(var i in this.fields){if(this.fields.hasOwnProperty(i)&&!t.includes(i)){this.updateUiField(i,this.fields[i])}}}},{key:"getCalculator",value:function e(){return this.getModel().getCalculator().setFields(this.getCalculateFields()).setSettings(this.getEditor().getSettings())}},{key:"setModel",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=i.selectorId;if(n){var r=d.ProductModel.getById(n);if(r){this.model=r}}if(!this.model){this.model=new d.ProductModel({id:n,currency:this.getEditor().getCurrencyId(),iblockId:t["IBLOCK_ID"],basePriceId:t["BASE_PRICE_ID"],isSimpleModel:h.Text.toInteger(t["PRODUCT_ID"])<=0&&h.Type.isStringFilled(t["NAME"]),skuTree:h.Type.isStringFilled(t["SKU_TREE"])?JSON.parse(t["SKU_TREE"]):null,fields:t});var a=h.Type.isStringFilled(t["IMAGE_INFO"])?JSON.parse(t["IMAGE_INFO"]):null;if(h.Type.isObject(a)){this.model.getImageCollection().setPreview(a["preview"]);this.model.getImageCollection().setEditInput(a["input"]);this.model.getImageCollection().setMorePhotoValues(a["values"])}if(!h.Type.isNil(t["DETAIL_URL"])){this.model.setDetailPath(t["DETAIL_URL"])}}if(se(this,Pe,je).call(this)){if(!this.getModel().getField("DATE_RESERVE_END")){this.setField("DATE_RESERVE_END",this.editor.getSettingValue("defaultDateReservation"))}}s.EventEmitter.subscribe(this.model,"onErrorsChange",this.handleProductErrorsChange);s.EventEmitter.subscribe(this.model,"onChangeStoreData",this.handleChangeStoreData)}},{key:"getModel",value:function e(){return this.model}},{key:"setProductId",value:function e(t){var i=this;var n=this.getField("PRODUCT_ID")!==t;if(n){var r;this.getModel().setOption("isSimpleModel",t<=0&&h.Type.isStringFilled(this.getField("NAME")));this.setField("PRODUCT_ID",t,false);this.setField("OFFER_ID",t,false);(r=this.storeSelector)===null||r===void 0?void 0:r.setProductId(t);this.addActionProductChange();this.addActionUpdateTotal();if(this.reserveControl&&se(this,Pe,je).call(this)&&se(this,_e,$e).call(this)){if(!this.getModel().getField("DATE_RESERVE_END")){this.setField("DATE_RESERVE_END",this.editor.getSettingValue("defaultDateReservation"))}this.resetReserveFields();this.onAfterExecuteExternalActions=function(){i.reserveControl.changeInputValue(i.getField("QUANTITY"))}}}}},{key:"changeBasePrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:oe;if(i===le&&!se(this,de,Ue).call(this)){t=this.getField("BASE_PRICE");this.updateUiInputField("PRICE",t.toFixed(this.getPricePrecision()));return}var n=t;t=Math.max(t,0);if(i===oe){this.updateUiInputField("PRICE",t.toFixed(this.getPricePrecision()))}var r=this.getBasePrice()!==t;if(r){var a=this.getCalculator().calculateBasePrice(t);this.setFields(a);var s=i===le?["BASE_PRICE","PRICE"]:[];this.refreshFieldsLayout(s);this.addActionProductChange();this.addActionUpdateTotal()}se(this,me,Qe).call(this,n<0&&n!==t)}},{key:"setQuantity",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:oe;if(i===oe){this.updateUiInputField("QUANTITY",t)}var n=this.getField("QUANTITY")!==t;if(n){var r="quantityReservedCountError";var a=BX.UI.Notification.Center.getBalloonById(r);if(a){a.close()}var s=this.getCalculator().calculateQuantity(t);this.setFields(s);this.refreshFieldsLayout(["QUANTITY"]);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setReserveQuantity",value:function e(t){var i=se(this,De,Ke).call(this,"RESERVE_INFO");var n=i===null||i===void 0?void 0:i.querySelector('input[name="INPUT_RESERVE_QUANTITY"]');if(h.Type.isElementNode(n)){var r;n.value=t;(r=this.reserveControl)===null||r===void 0?void 0:r.changeInputValue(t)}else{this.changeReserveQuantity(t)}}},{key:"setMeasure",value:function e(t){var i=this;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:oe;this.setField("MEASURE_CODE",t.CODE);this.setField("MEASURE_NAME",t.SYMBOL);this.updateUiMoneyField("MEASURE_CODE",t.CODE,h.Text.encode(t.SYMBOL));if(this.getModel().isNew()){this.getModel().save(["MEASURE_CODE"])}else if(n===le){this.getModel().showSaveNotifier("measureChanger_"+this.getId(),{title:h.Loc.getMessage("CATALOG_PRODUCT_MODEL_SAVING_NOTIFICATION_MEASURE_CHANGED_QUERY"),events:{onSave:function e(){i.getModel().save(["MEASURE_CODE","MEASURE_NAME"])}}})}this.addActionProductChange()}},{key:"setDiscount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:oe;if(!this.isDiscountHandmade()){return}var n=this.isDiscountPercentage()?"DISCOUNT_RATE":"DISCOUNT_SUM";var r=this.getField(n)!==t;if(r){var a=this.getCalculator().calculateDiscount(t);this.setFields(a);var s=i===le?["DISCOUNT_RATE","DISCOUNT_SUM","DISCOUNT"]:[];this.refreshFieldsLayout(s);this.addActionProductChange();this.addActionUpdateTotal()}se(this,me,Qe).call(this)}},{key:"setDiscountType",value:function e(t){var i=t!==r.DiscountType.UNDEFINED&&this.getField("DISCOUNT_TYPE_ID")!==t;if(i){var n=this.getCalculator().calculateDiscountType(t);this.setFields(n);this.refreshFieldsLayout();this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setRowDiscount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:oe;var n=this.getField("DISCOUNT_ROW")!==t;if(n){var r=this.getCalculator().calculateRowDiscount(t);this.setFields(r);var a=i===le?["DISCOUNT_ROW"]:[];this.refreshFieldsLayout(a);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setTaxRate",value:function e(t){if(!this.getEditor().isTaxAllowed()){return}var i=this.getTaxRate()!==t;if(i){var n=this.getCalculator().calculateTax(t);this.setFields(n);this.refreshFieldsLayout();this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setTaxIncluded",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:oe;if(!this.getEditor().isTaxAllowed()){return}if(i===oe){this.updateUiCheckboxField("TAX_INCLUDED",t)}var n=this.getTaxIncluded()!==t;if(n){var r=this.getCalculator().calculateTaxIncluded(t);this.setFields(r);this.refreshFieldsLayout();this.addActionUpdateFieldList("TAX_INCLUDED",t);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setRowSum",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:oe;var n=this.getField("SUM")!==t;if(n){var r=this.getCalculator().calculateRowSum(t);this.setFields(r);var a=i===le?["SUM"]:[];this.refreshFieldsLayout(a);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"getInputByFieldName",value:function e(t){var i=this.getUiFieldId(t);var n=document.getElementById(i);if(!h.Type.isElementNode(n)){n=this.getNode().querySelector('[name="'+i+'"]')}return n}},{key:"updateUiInputField",value:function e(t,i){var n=this.getInputByFieldName(t);if(h.Type.isElementNode(n)){n.value=i}}},{key:"updateUiCheckboxField",value:function e(t,i){var n=this.getInputByFieldName(t);if(h.Type.isElementNode(n)){n.checked=i==="Y"}}},{key:"updateUiDiscountTypeField",value:function e(t,i){var n=i===r.DiscountType.MONETARY?this.getEditor().getCurrencyText():"%";this.updateUiMoneyField(t,i,n)}},{key:"getMoneyFieldDropdownApi",value:function e(t){if(!h.Reflection.getClass("BX.Main.dropdownManager")){return null}return BX.Main.dropdownManager.getById(this.getId()+"_"+t+"_control")}},{key:"updateMoneyFieldUiWithDropdownApi",value:function e(t,i){if(t.getValue()===i){return}var n=t.menu.itemsContainer.querySelector('[data-value="'+i+'"]');var r=n&&t.getMenuItem(n);if(r){t.refresh(r);t.selectItem(r)}}},{key:"updateMoneyFieldUiManually",value:function e(t,i,n){var r=this.getInputByFieldName(t);if(!h.Type.isElementNode(r)){return}r.dataset.value=i;var a=r.querySelector("span.main-dropdown-inner");if(!h.Type.isElementNode(a)){return}a.innerHTML=n}},{key:"updateUiMoneyField",value:function e(t,i,n){var r=this.getMoneyFieldDropdownApi(t);if(r){this.updateMoneyFieldUiWithDropdownApi(r,i)}else{this.updateMoneyFieldUiManually(t,i,n)}}},{key:"updateUiMeasure",value:function e(t,i){this.updateUiMoneyField("MEASURE_CODE",t,i);this.updateUiStoreAmountData()}},{key:"updateUiHtmlField",value:function e(t,i){var n=this.getNode().querySelector('[data-name="'+t+'"]');if(h.Type.isElementNode(n)){n.innerHTML=i}}},{key:"updateUiCurrencyFields",value:function e(){var t=this;var i=this.getEditor().getCurrencyText();var n=""+this.getEditor().getCurrencyId();var a=["PRICE_CURRENCY","SUM_CURRENCY","DISCOUNT_TYPE_ID","DISCOUNT_ROW_CURRENCY"];a.forEach((function(e){var a=[];if(e==="DISCOUNT_TYPE_ID"){a.push({NAME:"%",VALUE:""+r.DiscountType.PERCENTAGE});a.push({NAME:i,VALUE:""+r.DiscountType.MONETARY});if(t.getDiscountType()===r.DiscountType.MONETARY){t.updateMoneyFieldUiManually(e,r.DiscountType.MONETARY,i)}}else{a.push({NAME:i,VALUE:n});t.updateUiMoneyField(e,n,i)}h.Dom.attr(t.getInputByFieldName(e),"data-items",a)}));this.updateUiField("TAX_SUM",this.getField("TAX_SUM"))}},{key:"updateUiField",value:function e(t,i){var n=this.getUiFieldName(t);if(!n){return}var r=this.getUiFieldType(n);if(!r){return}if(!this.allowUpdateUiField(t)){return}switch(r){case"input":if(t==="QUANTITY"){i=this.parseFloat(i,this.getQuantityPrecision())}else if(t==="DISCOUNT_RATE"){i=this.parseFloat(i,this.getCommonPrecision())}else if(t==="TAX_RATE"){i=h.Type.isNil(i)||i===""?"":this.parseFloat(i,this.getCommonPrecision())}else if(i===0){i=""}else if(h.Type.isNumber(i)){i=this.parseFloat(i,this.getPricePrecision()).toFixed(this.getPricePrecision())}this.updateUiInputField(n,i);break;case"checkbox":this.updateUiCheckboxField(n,i);break;case"discount_type_field":this.updateUiDiscountTypeField(n,i);break;case"html":this.updateUiHtmlField(n,i);break;case"money_html":i=o.CurrencyCore.currencyFormat(i,this.getEditor().getCurrencyId(),true);this.updateUiHtmlField(n,i);break}}},{key:"getUiFieldName",value:function e(t){var i=null;switch(t){case"QUANTITY":case"MEASURE_CODE":case"DISCOUNT_ROW":case"DISCOUNT_TYPE_ID":case"TAX_RATE":case"TAX_INCLUDED":case"TAX_SUM":case"SUM":case"PRODUCT_NAME":case"SORT":i=t;break;case"BASE_PRICE":i="PRICE";break;case"DISCOUNT_RATE":case"DISCOUNT_SUM":i="DISCOUNT_PRICE";break}return i}},{key:"getUiFieldType",value:function e(t){var i=null;switch(t){case"PRICE":case"QUANTITY":case"TAX_RATE":case"DISCOUNT_PRICE":case"DISCOUNT_RATE":case"DISCOUNT_SUM":case"DISCOUNT_ROW":case"SUM":case"PRODUCT_NAME":case"SORT":i="input";break;case"DISCOUNT_TYPE_ID":i="discount_type_field";break;case"TAX_INCLUDED":i="checkbox";break;case"TAX_SUM":i="money_html";break}return i}},{key:"allowUpdateUiField",value:function e(t){var i=true;switch(t){case"PRICE_NETTO":i=this.isPriceNetto();break;case"PRICE_BRUTTO":i=!this.isPriceNetto();break;case"DISCOUNT_RATE":i=this.isDiscountPercentage();break;case"DISCOUNT_SUM":i=this.isDiscountMonetary();break}return i}},{key:"parseInt",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;return this.getEditor().parseInt(t,i)}},{key:"parseFloat",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;return this.getEditor().parseFloat(t,i,n)}},{key:"getPricePrecision",value:function e(){return this.getEditor().getPricePrecision()}},{key:"getQuantityPrecision",value:function e(){return this.getEditor().getQuantityPrecision()}},{key:"getCommonPrecision",value:function e(){return this.getEditor().getCommonPrecision()}},{key:"resetExternalActions",value:function e(){this.externalActions.length=0}},{key:"addExternalAction",value:function e(t){this.externalActions.push(t)}},{key:"addActionProductChange",value:function e(){this.addExternalAction({type:this.getEditor().actions.productChange,id:this.getId()})}},{key:"addActionDisableSaveButton",value:function e(){this.addExternalAction({type:this.getEditor().actions.disableSaveButton,id:this.getId()})}},{key:"addActionUpdateFieldList",value:function e(t,i){this.addExternalAction({type:this.getEditor().actions.updateListField,field:t,value:i})}},{key:"addActionStateChanged",value:function e(){this.addExternalAction({type:this.getEditor().actions.stateChanged,value:true})}},{key:"addActionStateReset",value:function e(){this.addExternalAction({type:this.getEditor().actions.stateChanged,value:false})}},{key:"addActionUpdateTotal",value:function e(){this.addExternalAction({type:this.getEditor().actions.updateTotal})}},{key:"executeExternalActions",value:function e(){if(this.externalActions.length===0){return}this.getEditor().executeActions(this.externalActions);this.resetExternalActions();if(this.onAfterExecuteExternalActions){var t=this.onAfterExecuteExternalActions;this.onAfterExecuteExternalActions=null;t.call()}}},{key:"isEmpty",value:function e(){return!h.Type.isStringFilled(this.getField("PRODUCT_NAME","").trim())&&this.getField("PRODUCT_ID",0)<=0&&this.getPrice()<=0}},{key:"isReserveBlocked",value:function e(){return this.getSettingValue("isReserveBlocked",false)}},{key:"isRestrictedStoreInfo",value:function e(){var t;if(!this.editor.getSettingValue("allowReservation",true)){return false}var i=(t=this.getField("STORE_ID"))===null||t===void 0?void 0:t.toString();if(h.Type.isNil(i)||i==="0"){return false}else if(this.getModel().isSimple()||this.getModel().isService()){return false}return!se(this,Ie,qe).call(this).includes(i)||!this.editor.getSettingValue("allowEntityReserve",true)}},{key:"setType",value:function e(t){this.setField("TYPE",t);if(this.getModel().isService()){this.clearReserveControl()}}}]);return e}();function we(){var e=this;if(this.getEditor().isReadOnly()||this.isRestrictedStoreInfo()){return}var t=this.getNode().querySelector(".main-grid-cell-action .main-grid-cell-content");if(h.Type.isDomNode(t)){var i=h.Tag.render(Z||(Z=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<a\n\t\t\t\t\thref="#"\n\t\t\t\t\tclass="main-grid-row-action-button"\n\t\t\t\t></a>\n\t\t\t'])));h.Event.bind(i,"click",(function(t){var n=[{text:h.Loc.getMessage("CRM_ENTITY_PL_COPY"),onclick:e.handleCopyAction.bind(e),disabled:e.editor.getSettingValue("disabledSelectProductInput")},{text:h.Loc.getMessage("CRM_ENTITY_PL_DELETE"),onclick:e.handleDeleteAction.bind(e),disabled:e.getModel().isEmpty()&&e.getEditor().products.length<=1}];a.PopupMenu.show({id:e.getId()+"_actions_popup",bindElement:i,items:n,cacheable:false});t.preventDefault();t.stopPropagation()}));h.Dom.append(i,t)}}function Ue(){return this.editor.canEditCatalogPrice()||!this.getModel().isCatalogExisted()||this.getModel().isNew()}function Oe(){var e="crm_grid_"+this.getId();this.mainSelector=u.ProductSelector.getById(e);if(!this.mainSelector){var t={iblockId:this.model.getIblockId(),basePriceId:this.model.getBasePriceId(),currency:this.model.getCurrency(),model:this.model,config:{ENABLE_SEARCH:true,IS_ALLOWED_CREATION_PRODUCT:true,ENABLE_IMAGE_INPUT:true,ROLLBACK_INPUT_AFTER_CANCEL:true,ENABLE_INPUT_DETAIL_LINK:true,ROW_ID:this.getId(),ENABLE_SKU_SELECTION:true,ENABLE_EMPTY_PRODUCT_ERROR:false,SELECTOR_INPUT_DISABLED:this.editor.getSettingValue("disabledSelectProductInput"),URL_BUILDER_CONTEXT:this.editor.getSettingValue("productUrlBuilderContext"),RESTRICTED_PRODUCT_TYPES:this.getEditor().getRestrictedProductTypes()},mode:u.ProductSelector.MODE_EDIT};this.mainSelector=new u.ProductSelector("crm_grid_"+this.getId(),t)}else{this.mainSelector.subscribeEvents()}if(this.isRestrictedStoreInfo()){this.mainSelector.setMode(u.ProductSelector.MODE_VIEW)}var i=se(this,De,Ke).call(this,"MAIN_INFO");if(i){var n=i.querySelector(".main-grid-row-number");if(!h.Type.isDomNode(n)){h.Dom.append(h.Tag.render(J||(J=babelHelpers.taggedTemplateLiteral(['<div class="main-grid-row-number"></div>']))),i)}var r=i.querySelector(".main-grid-row-product-selector");if(!h.Type.isDomNode(r)){r=h.Tag.render($||($=babelHelpers.taggedTemplateLiteral(['<div class="main-grid-row-product-selector"></div>'])));h.Dom.append(r,i)}this.mainSelector.skuTreeInstance=null;this.mainSelector.renderTo(r)}s.EventEmitter.subscribe(this.mainSelector,"onClear",this.handleMainSelectorClear)}function Me(){this.updateField("OFFER_ID",0);this.updateField("PRODUCT_NAME","");this.updateUiStoreAmountData();this.updateField("DEDUCTED_QUANTITY",0);this.updateField("ROW_RESERVED",0)}function He(){this.storeSelector=new n.StoreSelector(this.getId(),{inputFieldId:"STORE_ID",inputFieldTitle:"STORE_TITLE",config:{ENABLE_SEARCH:true,ENABLE_INPUT_DETAIL_LINK:false,ROW_ID:this.getId()},mode:n.StoreSelector.MODE_EDIT,model:this.model});s.EventEmitter.subscribe(this.storeSelector,"onChange",this.handleStoreFieldChange);s.EventEmitter.subscribe(this.storeSelector,"onClear",this.handleStoreFieldClear);if(this.isRestrictedStoreInfo()&&this.storeSelector.searchInput){this.storeSelector.searchInput.disable(h.Loc.getMessage("CRM_ENTITY_PL_ROW_UPDATE_STORE_RESTRICTED_BY_STORE"))}this.layoutStoreSelector()}function Be(){var e=se(this,De,Ke).call(this,"STORE_AVAILABLE");if(!e){return}this.storeAvailablePopup=new j({rowId:this.id,model:this.getModel(),node:e});s.EventEmitter.subscribeOnce("Grid::updated",this.handleOnGridUpdated)}function Le(){var e=this;var t=this.storeSelector.searchInput;if(!t||!t.getNameInput()){return}t.toggleIcon(this.storeSelector.searchInput.getSearchIcon(),"none");t.getNameInput().disabled=true;h.Dom.addClass(t.getNameInput(),"crm-entity-product-list-locked-field");if(this.storeSelector.getWrapper()){this.storeSelector.getWrapper().onclick=function(){return e.editor.openIntegrationLimitSlider()}}}function xe(){var e=this;var t=se(this,De,Ke).call(this,"RESERVE_INFO");if(t&&se(this,Ie,qe).call(this).length){this.reserveControl=new w({row:this,isReserveEqualProductQuantity:se(this,Pe,je).call(this),defaultDateReservation:this.editor.getSettingValue("defaultDateReservation"),isBlocked:this.isReserveBlocked(),measureName:se(this,Re,ze).call(this)});s.EventEmitter.subscribe(this.reserveControl,"onNodeClick",(function(){e.editor.openIntegrationLimitSlider()}));if(this.isRestrictedStoreInfo()){this.reserveControl.disable()}this.layoutReserveControl()}var i=this.getNode().querySelector('div[data-name="QUANTITY"] input');if(i){h.Event.bind(i,"change",(function(t){var i;var n=se(e,Pe,je).call(e)&&((i=e.reserveControl)===null||i===void 0?void 0:i.isReserveEqualProductQuantity);if(n){e.setReserveQuantity(e.getField("QUANTITY"));return}var r=h.Text.toNumber(t.target.value);var a="quantityReservedCountError";var s=BX.UI.Notification.Center.getBalloonById(a);if(r<e.getField("INPUT_RESERVE_QUANTITY")){if(!s){var l={id:a,closeButton:true,autoHideDelay:3e3,content:h.Tag.render(ee||(ee=babelHelpers.taggedTemplateLiteral(["<div>","</div>"])),h.Loc.getMessage("CRM_ENTITY_PL_IS_LESS_QUANTITY_THEN_RESERVED"))};s=BX.UI.Notification.Center.notify(l)}e.setReserveQuantity(e.getField("QUANTITY"));s.show()}}))}}function Ge(e){var t=this;var i=e.getData();i.fields.forEach((function(e){t.updateField(e.NAME,e.VALUE)}));this.initHandlersForSelectors()}function Ve(){this.initHandlersForSelectors()}function Ye(){var e=this.getField("STORE_ID");if(!this.isReserveBlocked()&&this.isNewRow()&&this.storeSelector){var t=this.getModel().getStoreCollection().getStoreAmount(e);if(t<=0&&this.getModel().isChanged()){var i=this.getModel().getStoreCollection().getMaxFilledStore();if(i.AMOUNT>t){this.storeSelector.onStoreSelect(i.STORE_ID,h.Text.decode(i.STORE_TITLE))}else if(h.Type.isNil(e)){e=+this.storeSelector.getStoreId();if(e>0){this.changeStore(e)}}}}this.setField("STORE_AVAILABLE",this.model.getStoreCollection().getStoreAvailableAmount(e));this.updateUiStoreAmountData()}function We(){this.getEditor().handleProductErrorsChange()}function Xe(){return h.Text.toNumber(this.getField("PRICE"))>0&&h.Text.toNumber(this.getField("PRICE"))<1&&this.isDiscountPercentage()&&(h.Text.toNumber(this.getField("DISCOUNT_SUM"))>0||h.Text.toNumber(this.getField("DISCOUNT_RATE"))>0||h.Text.toNumber(this.getField("DISCOUNT_ROW"))>0)}function Qe(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(se(this,Se,Xe).call(this)){this.getHintPopup().load(this.getInputByFieldName("PRICE"),h.Loc.getMessage("CRM_ENTITY_PL_SMALL_PRICE_NOTICE")).show()}else if(e){this.getHintPopup().load(this.getInputByFieldName("PRICE"),h.Loc.getMessage("CRM_ENTITY_PL_NEGATIVE_PRICE_NOTICE")).show()}else{this.getHintPopup().close()}}function qe(){return this.editor.getSettingValue("allowedStores",[])}function je(){return this.editor.getSettingValue("isReserveEqualProductQuantity",false)}function ze(){var e;var t=h.Type.isStringFilled(this.model.getField("MEASURE_NAME"))?this.model.getField("MEASURE_NAME"):((e=this.editor.getDefaultMeasure())===null||e===void 0?void 0:e.SYMBOL)||"";return h.Text.encode(t)}function Ke(e){return this.getNode().querySelector('[data-name="'.concat(e,'"]'))}function Ze(){return this.getNode().querySelectorAll("span[data-name]")}function Je(){if(this.storeAvailablePopup){this.storeAvailablePopup.refreshStoreInfo()}}function $e(){return!this.getModel().isSimple()&&!this.getModel().isService()}function et(){return!this.getModel().isSimple()&&!this.getModel().isService()}babelHelpers.defineProperty(Ae,"CATALOG_PRICE_CHANGING_DISABLED","CATALOG_PRICE_CHANGING_DISABLED");var tt=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"_settings",{});this._settings=t?t:{};this.eventHandlers={}}babelHelpers.createClass(e,[{key:"registerEventHandler",value:function e(t,i){if(!this.eventHandlers[t])this.eventHandlers[t]=[];this.eventHandlers[t].push(i);BX.addCustomEvent(this,t,i)}},{key:"fireEvent",value:function e(t,i){BX.onCustomEvent(this,t,i)}},{key:"unregisterEventHandlers",value:function e(t){if(this.eventHandlers[t]){for(var i=0;i<this.eventHandlers[t].length;i++){BX.removeCustomEvent(this,t,this.eventHandlers[t][i])}delete this.eventHandlers[t]}}}]);return e}();var it,nt,rt,at,st;function lt(e,t){ut(e,t);t.add(e)}function ot(e,t,i){ut(e,t);t.set(e,i)}function ut(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function dt(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var ct=new WeakMap;var ht=new WeakMap;var vt=new WeakMap;var gt=new WeakMap;var ft=new WeakSet;var pt=new WeakSet;var Et=new WeakSet;var yt=new WeakSet;var Tt=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var n=arguments.length>2?arguments[2]:undefined;babelHelpers.classCallCheck(this,e);lt(this,yt);lt(this,Et);lt(this,pt);lt(this,ft);ot(this,ct,{writable:true,value:void 0});ot(this,ht,{writable:true,value:void 0});ot(this,vt,{writable:true,value:void 0});ot(this,gt,{writable:true,value:new h.Cache.MemoryCache});babelHelpers.classPrivateFieldSet(this,ct,t);babelHelpers.classPrivateFieldSet(this,ht,i);babelHelpers.classPrivateFieldSet(this,vt,n)}babelHelpers.createClass(e,[{key:"show",value:function e(){this.getPopup().show()}},{key:"getPopup",value:function e(){var t=this;return babelHelpers.classPrivateFieldGet(this,gt).remember("settings-popup",(function(){return new a.Popup(babelHelpers.classPrivateFieldGet(t,vt).getId()+"_"+Math.random()*100,babelHelpers.classPrivateFieldGet(t,ct),{autoHide:true,draggable:false,offsetLeft:0,offsetTop:0,angle:{position:"top",offset:43},noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,content:dt(t,ft,bt).call(t)})}))}},{key:"getSetting",value:function e(t){return babelHelpers.classPrivateFieldGet(this,ht).filter((function(e){return e.id===t}))[0]}},{key:"requestGridSettings",value:function e(t,i){var n=this;var r=[];var a=babelHelpers.classPrivateFieldGet(this,vt).getGrid().getRows().getHeadFirstChild().getCells();Array.from(a).forEach((function(e){if("name"in e.dataset){r.push(e.dataset.name)}}));h.ajax.runComponentAction(babelHelpers.classPrivateFieldGet(this,vt).getComponentName(),"setGridSetting",{mode:"class",data:{signedParameters:babelHelpers.classPrivateFieldGet(this,vt).getSignedParameters(),settingId:t.id,selected:i,currentHeaders:r}}).then((function(){var e;t.checked=i;if(t.id==="ADD_NEW_ROW_TOP"){var r=i?"top":"bottom";babelHelpers.classPrivateFieldGet(n,vt).setSettingValue("newRowPosition",r);var a=babelHelpers.classPrivateFieldGet(n,vt).changeActivePanelButtons(r);var s=a.querySelector('[data-role="product-list-settings-button"]');n.getPopup().setBindElement(s);e=i?h.Loc.getMessage("CRM_ENTITY_PL_SETTING_ENABLED"):h.Loc.getMessage("CRM_ENTITY_PL_SETTING_DISABLED");e=e.replace("#NAME#",t.title)}else if(t.id==="WAREHOUSE"){babelHelpers.classPrivateFieldGet(n,vt).reloadGrid(false);e=i?h.Loc.getMessage("CRM_ENTITY_CARD_WAREHOUSE_ENABLED"):h.Loc.getMessage("CRM_ENTITY_CARD_WAREHOUSE_DISABLED")}else{babelHelpers.classPrivateFieldGet(n,vt).reloadGrid();e=i?h.Loc.getMessage("CRM_ENTITY_PL_SETTING_ENABLED"):h.Loc.getMessage("CRM_ENTITY_PL_SETTING_DISABLED");e=e.replace("#NAME#",t.title)}n.getPopup().close();dt(n,yt,mt).call(n,e,{category:"popup-settings"})}))}},{key:"updateCheckboxState",value:function e(){var t=this;var i=this.getPopup().getContentContainer();babelHelpers.classPrivateFieldGet(this,ht).filter((function(e){return e.action==="grid"&&h.Type.isArray(e.columns)})).forEach((function(e){var n=true;e.columns.forEach((function(e){if(!babelHelpers.classPrivateFieldGet(t,vt).getGrid().getColumnHeaderCellByName(e)){n=false}}));var r=i.querySelector('input[data-setting-id="'+e.id+'"]');if(h.Type.isDomNode(r)){r.checked=n}}))}}]);return e}();function bt(){var e=this;var t=h.Tag.render(it||(it=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div class='ui-entity-editor-popup-create-field-list'></div>\n\t\t"])));babelHelpers.classPrivateFieldGet(this,ht).forEach((function(i){t.append(dt(e,pt,Ct).call(e,i))}));return t}function Ct(e){var t,i=this;var n=h.Tag.render(nt||(nt=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="checkbox">\n\t\t'])));n.checked=e.checked;n.disabled=(t=e.disabled)!==null&&t!==void 0?t:false;n.dataset.settingId=e.id;var r=h.Type.isStringFilled(e.desc)?h.Tag.render(rt||(rt=babelHelpers.taggedTemplateLiteral(['<span class="ui-entity-editor-popup-create-field-item-desc">',"</span>"])),e.desc):"";var a=h.Type.isStringFilled(e.hint)?h.Tag.render(at||(at=babelHelpers.taggedTemplateLiteral(['<span class="crm-entity-product-list-setting-hint" data-hint="','"></span>'])),e.hint):"";var s=h.Tag.render(st||(st=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<label class="ui-ctl-block ui-entity-editor-popup-create-field-item ui-ctl-w100">\n\t\t\t\t<div class="ui-ctl-w10" style="text-align: center">','</div>\n\t\t\t\t<div class="ui-ctl-w75">\n\t\t\t\t\t<span class="ui-entity-editor-popup-create-field-item-title ','">',"","</span>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</label>\n\t\t"])),n,e.disabled?"crm-entity-product-list-disabled-setting":"",e.title,a,r);BX.UI.Hint.init(s);if(e.id==="SLIDER"){h.Event.bind(s,"change",(function(t){(new l.Slider).open(e.url,{}).then((function(){return babelHelpers.classPrivateFieldGet(i,vt).reloadGrid(false)}))}))}else{h.Event.bind(s,"change",dt(this,Et,St).bind(this))}return s}function St(e){var t=this.getSetting(e.target.dataset.settingId);if(!t){return}var i=e.target.checked;this.requestGridSettings(t,i)}function mt(e,t){t=t||{};BX.UI.Notification.Center.notify({content:e,stack:t.stack||null,position:"top-right",width:"auto",category:t.category||null,autoHideDelay:t.autoHideDelay||3e3})}function It(e,t){Rt(e,t);t.add(e)}function Pt(e,t,i){Rt(e,t);t.set(e,i)}function Rt(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function Dt(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var Ft=new WeakMap;var Nt=new WeakMap;var _t=new WeakSet;var kt=new WeakSet;var At=new WeakSet;var wt=new WeakSet;var Ut=new WeakSet;var Ot=new WeakSet;var Mt=function(){function e(t,i){babelHelpers.classCallCheck(this,e);It(this,Ot);It(this,Ut);It(this,wt);It(this,At);It(this,kt);It(this,_t);babelHelpers.defineProperty(this,"fieldHintIsBusy",false);babelHelpers.defineProperty(this,"activeHintGuide",null);Pt(this,Ft,{writable:true,value:void 0});Pt(this,Nt,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,Nt,t);babelHelpers.classPrivateFieldSet(this,Ft,i)}babelHelpers.createClass(e,[{key:"processFieldTour",value:function e(t,i,n){var r=this;var a=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];if(this.fieldHintIsBusy){return}this.fieldHintIsBusy=true;i.events={onClose:function e(){n();r.fieldHintIsBusy=false;r.activeHintGuide=null}};if(Dt(this,At,Lt).call(this,t)){var s=Dt(this,Ot,Vt).call(this,t,i);Dt(this,Ut,Gt).call(this,(function(){s.close()}))}else{var l=babelHelpers.classPrivateFieldGet(this,Ft).call(this).getContainer();var o=l.querySelector(".main-grid-ear-left");var u=l.querySelector(".main-grid-ear-right");var d=t.getClientRects()[0].x;var c=l.getClientRects()[0].x;var h=null;if(d>c){h=Dt(this,wt,xt).call(this,u)}else{h=Dt(this,wt,xt).call(this,o)}Dt(this,_t,Ht).call(this,t,(function(){h.close();var e=Dt(r,Ot,Vt).call(r,t,i);Dt(r,Ut,Gt).call(r,(function(){e.close()}))}),[],a)}}},{key:"getActiveHint",value:function e(){if(!this.fieldHintIsBusy){return null}else if(this.activeHintGuide instanceof g.Guide){return this.activeHintGuide}return null}}]);return e}();function Ht(e,t){var i,n=this;var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];var a=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];var s=(i=Dt(this,kt,Bt)).call.apply(i,[this,e].concat(babelHelpers.toConsumableArray(a)));var l=function e(i){var a;if((a=Dt(n,At,Lt)).call.apply(a,[n].concat(babelHelpers.toConsumableArray(s)))){h.Event.unbind(babelHelpers.classPrivateFieldGet(n,Ft).call(n).getScrollContainer(),"scroll",e);h.Event.unbind(window,"resize",e);t.apply(void 0,babelHelpers.toConsumableArray(r))}};h.Event.bind(babelHelpers.classPrivateFieldGet(this,Ft).call(this).getScrollContainer(),"scroll",l);h.Event.bind(window,"resize",l)}function Bt(e){var t,i;var n=[];for(var r=arguments.length,a=new Array(r>1?r-1:0),s=1;s<r;s++){a[s-1]=arguments[s]}for(var l=0,o=a;l<o.length;l++){var u=o[l];n.push({node:u,nodeRect:u.getClientRects()[0]})}var d={node:e,nodeRect:e.getClientRects()[0]};n.push(d);n.sort((function(e,t){var i=e.nodeRect.x;var n=t.nodeRect.x;if(i<n){return-1}else if(i>n){return 1}else{return 0}}));var c=(t=babelHelpers.classPrivateFieldGet(this,Ft).call(this))===null||t===void 0?void 0:(i=t.getContainer().getClientRects())===null||i===void 0?void 0:i[0];function h(e,t){return Math.abs(e-t)<c.width}while(n.length>1&&!h(n[0].nodeRect.x,n[n.length-1].nodeRect.x)){var v=n[0];var g=n[n.length-1];if(v===d){n.pop()}else if(g===d){n.shift()}else{var f=d.nodeRect.x-v.nodeRect.x;var p=g.nodeRect.x-d.nodeRect.x;if(f>=p){n.shift()}else{n.pop()}}}return n.map((function(e){return e.node}))}function Lt(){var e,t;var i=(e=babelHelpers.classPrivateFieldGet(this,Ft).call(this))===null||e===void 0?void 0:(t=e.getContainer().getClientRects())===null||t===void 0?void 0:t[0];if(i===undefined){return false}var n=i.x;var r=i.x+i.width;for(var a=arguments.length,s=new Array(a),l=0;l<a;l++){s[l]=arguments[l]}for(var o=0,u=s;o<u.length;o++){var d;var c=u[o];var h=(d=c.getClientRects())===null||d===void 0?void 0:d[0];if(h===undefined){return false}var v=h.x;var g=h.x+h.width;if(v<n||g>r){return false}}return true}function xt(e){var t=new BX.SpotLight({id:"arrow_spotlight",targetElement:e,autoSave:true,targetVertex:"middle-center",zIndex:200});t.show();t.container.style.pointerEvents="none";return t}function Gt(e){var t=this;var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var n=babelHelpers.classPrivateFieldGet(this,Ft).call(this).getContainer();var r=n.querySelector(".main-grid-ear-left");var a=n.querySelector(".main-grid-ear-right");n.style.pointerEvents="none";r.style.pointerEvents="none";a.style.pointerEvents="none";var s=function s(l){n.style.pointerEvents="auto";r.style.pointerEvents="auto";a.style.pointerEvents="auto";h.Event.unbind(babelHelpers.classPrivateFieldGet(t,Nt),"click",s);e.apply(void 0,babelHelpers.toConsumableArray(i))};setTimeout((function(){h.Event.bind(babelHelpers.classPrivateFieldGet(t,Nt),"click",s)}),500)}function Vt(e,t){var i=new g.Guide({steps:[Object.assign({target:e},t)],onEvents:true});this.activeHintGuide=i;i.showNextStep();return i}var Yt;function Wt(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=Xt(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var r=function e(){};return{s:r,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,s=false,l;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();a=t.done;return t},e:function e(t){s=true;l=t},f:function e(){try{if(!a&&i["return"]!=null)i["return"]()}finally{if(s)throw l}}}}function Xt(e,t){if(!e)return;if(typeof e==="string")return Qt(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return Qt(e,t)}function Qt(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++){n[i]=e[i]}return n}function qt(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function jt(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?qt(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):qt(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function zt(e,t){Zt(e,t);t.add(e)}function Kt(e,t,i){Zt(e,t);t.set(e,i)}function Zt(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function Jt(e,t,i){$t(e,t);return i}function $t(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function ei(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var ti="template_0";var ii=2;var ni=new WeakMap;var ri=new WeakSet;var ai=new WeakSet;var si=new WeakSet;var li=function(){function e(t){babelHelpers.classCallCheck(this,e);zt(this,si);zt(this,ai);zt(this,ri);babelHelpers.defineProperty(this,"ajaxPool",new Map);babelHelpers.defineProperty(this,"products",[]);babelHelpers.defineProperty(this,"productsWasInitiated",false);babelHelpers.defineProperty(this,"isChangedGrid",false);babelHelpers.defineProperty(this,"cache",new h.Cache.MemoryCache);Kt(this,ni,{writable:true,value:void 0});babelHelpers.defineProperty(this,"actions",{disableSaveButton:"disableSaveButton",productChange:"productChange",productListChanged:"productListChanged",updateListField:"listField",stateChanged:"stateChange",updateTotal:"total"});babelHelpers.defineProperty(this,"stateChange",{changed:false,sended:false});babelHelpers.defineProperty(this,"updateFieldForList",null);babelHelpers.defineProperty(this,"totalData",{inProgress:false});babelHelpers.defineProperty(this,"productSelectionPopupHandler",this.handleProductSelectionPopup.bind(this));babelHelpers.defineProperty(this,"productRowAddHandler",this.handleProductRowAdd.bind(this));babelHelpers.defineProperty(this,"showSettingsPopupHandler",this.handleShowSettingsPopup.bind(this));babelHelpers.defineProperty(this,"onDialogSelectProductHandler",this.handleOnDialogSelectProduct.bind(this));babelHelpers.defineProperty(this,"onSaveHandler",this.handleOnSave.bind(this));babelHelpers.defineProperty(this,"onFocusToProductList",this.handleProductListFocus.bind(this));babelHelpers.defineProperty(this,"onEntityUpdateHandler",this.handleOnEntityUpdate.bind(this));babelHelpers.defineProperty(this,"onEditorSubmit",this.handleEditorSubmit.bind(this));babelHelpers.defineProperty(this,"onInnerCancelHandler",this.handleOnInnerCancel.bind(this));babelHelpers.defineProperty(this,"onBeforeGridRequestHandler",this.handleOnBeforeGridRequest.bind(this));babelHelpers.defineProperty(this,"onGridUpdatedHandler",this.handleOnGridUpdated.bind(this));babelHelpers.defineProperty(this,"onGridRowMovedHandler",this.handleOnGridRowMoved.bind(this));babelHelpers.defineProperty(this,"onBeforeProductChangeHandler",this.handleOnBeforeProductChange.bind(this));babelHelpers.defineProperty(this,"onProductChangeHandler",this.handleOnProductChange.bind(this));babelHelpers.defineProperty(this,"onBeforeProductClearHandler",this.handleOnBeforeProductClear.bind(this));babelHelpers.defineProperty(this,"onProductClearHandler",this.handleOnProductClear.bind(this));babelHelpers.defineProperty(this,"dropdownChangeHandler",this.handleDropdownChange.bind(this));babelHelpers.defineProperty(this,"pullReloadGrid",null);babelHelpers.defineProperty(this,"changeProductFieldHandler",this.handleFieldChange.bind(this));babelHelpers.defineProperty(this,"updateTotalDataDelayedHandler",h.Runtime.debounce(this.updateTotalDataDelayed,1e3,this));this.setId(t)}babelHelpers.createClass(e,[{key:"init",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.setSettings(i);if(this.canEdit()){this.addFirstRowIfEmpty();this.enableEdit()}this.initForm();this.initProducts();this.initGridData();babelHelpers.classPrivateFieldSet(this,ni,new Mt(this.getContainer(),this.getGrid.bind(this)));s.EventEmitter.emit(window,"EntityProductListController",[this]);ei(this,ri,oi).call(this);this.subscribeDomEvents();this.subscribeCustomEvents();if(this.getSettingValue("isReserveBlocked",false)){var n=["STORE_INFO","RESERVE_INFO"];var r=this.getContainer();n.forEach((function(e){var i=r===null||r===void 0?void 0:r.querySelector('.main-grid-cell-head[data-name="'.concat(e,'"] .main-grid-cell-head-container'));if(i){h.Dom.addClass(i,"main-grid-cell-head-locked");i.onclick=function(e){if(h.Dom.hasClass(e.target,"ui-hint-icon")){return}t.openIntegrationLimitSlider()};var n=h.Tag.render(Yt||(Yt=babelHelpers.taggedTemplateLiteral(['<span class="crm-entity-product-list-locked-header"></span>'])));i.insertBefore(n,i.firstChild)}}))}this.getContainer().querySelectorAll(".crm-entity-product-list-add-block").forEach((function(e){BX.UI.Hint.init(e)}))}},{key:"subscribeDomEvents",value:function e(){var t=this;this.unsubscribeDomEvents();var i=this.getContainer();if(h.Type.isElementNode(i)){if(!this.getSettingValue("disabledSelectProductButton",false)){i.querySelectorAll('[data-role="product-list-select-button"]').forEach((function(e){h.Event.bind(e,"click",t.productSelectionPopupHandler)}))}if(!this.getSettingValue("disabledAddRowButton",false)){i.querySelectorAll('[data-role="product-list-add-button"]').forEach((function(e){h.Event.bind(e,"click",t.productRowAddHandler)}))}i.querySelectorAll('[data-role="product-list-settings-button"]').forEach((function(e){h.Event.bind(e,"click",t.showSettingsPopupHandler)}))}}},{key:"unsubscribeDomEvents",value:function e(){var t=this;var i=this.getContainer();if(h.Type.isElementNode(i)){i.querySelectorAll('[data-role="product-list-select-button"]').forEach((function(e){h.Event.unbind(e,"click",t.productSelectionPopupHandler)}));i.querySelectorAll('[data-role="product-list-add-button"]').forEach((function(e){h.Event.unbind(e,"click",t.productRowAddHandler)}));i.querySelectorAll('[data-role="product-list-settings-button"]').forEach((function(e){h.Event.unbind(e,"click",t.showSettingsPopupHandler)}))}}},{key:"subscribeCustomEvents",value:function e(){var t=this;this.unsubscribeCustomEvents();s.EventEmitter.subscribe("CrmProductSearchDialog_SelectProduct",this.onDialogSelectProductHandler);s.EventEmitter.subscribe("BX.Crm.EntityEditor:onSave",this.onSaveHandler);s.EventEmitter.subscribe("onFocusToProductList",this.onFocusToProductList);s.EventEmitter.subscribe("onCrmEntityUpdate",this.onEntityUpdateHandler);s.EventEmitter.subscribe("BX.Crm.EntityEditorAjax:onSubmit",this.onEditorSubmit);s.EventEmitter.subscribe("EntityProductListController:onInnerCancel",this.onInnerCancelHandler);s.EventEmitter.subscribe("Grid::beforeRequest",this.onBeforeGridRequestHandler);s.EventEmitter.subscribe("Grid::updated",this.onGridUpdatedHandler);s.EventEmitter.subscribe("Grid::rowMoved",this.onGridRowMovedHandler);s.EventEmitter.subscribe("BX.Catalog.ProductSelector:onBeforeChange",this.onBeforeProductChangeHandler);s.EventEmitter.subscribe("BX.Catalog.ProductSelector:onChange",this.onProductChangeHandler);s.EventEmitter.subscribe("BX.Catalog.ProductSelector:onBeforeClear",this.onBeforeProductClearHandler);s.EventEmitter.subscribe("BX.Catalog.ProductSelector:onClear",this.onProductClearHandler);s.EventEmitter.subscribe("Dropdown::change",this.dropdownChangeHandler);if(c.PULL){this.pullReloadGrid=c.PULL.subscribe({moduleId:"crm",callback:function e(i){if(i.command==="onCatalogInventoryManagementEnabled"||i.command==="onCatalogInventoryManagementDisabled"){t.reloadGrid(false)}}})}}},{key:"unsubscribeCustomEvents",value:function e(){s.EventEmitter.unsubscribe("CrmProductSearchDialog_SelectProduct",this.onDialogSelectProductHandler);s.EventEmitter.unsubscribe("BX.Crm.EntityEditor:onSave",this.onSaveHandler);s.EventEmitter.unsubscribe("onFocusToProductList",this.onFocusToProductList);s.EventEmitter.unsubscribe("onCrmEntityUpdate",this.onEntityUpdateHandler);s.EventEmitter.unsubscribe("BX.Crm.EntityEditorAjax:onSubmit",this.onEditorSubmit);s.EventEmitter.unsubscribe("EntityProductListController:onInnerCancel",this.onInnerCancelHandler);s.EventEmitter.unsubscribe("Grid::beforeRequest",this.onBeforeGridRequestHandler);s.EventEmitter.unsubscribe("Grid::updated",this.onGridUpdatedHandler);s.EventEmitter.unsubscribe("Grid::rowMoved",this.onGridRowMovedHandler);s.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onBeforeChange",this.onBeforeProductChangeHandler);s.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onChange",this.onProductChangeHandler);s.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onBeforeClear",this.onBeforeProductClearHandler);s.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onClear",this.onProductClearHandler);s.EventEmitter.unsubscribe("Dropdown::change",this.dropdownChangeHandler);if(!h.Type.isNil(this.pullReloadGrid)){this.pullReloadGrid()}}},{key:"handleOnDialogSelectProduct",value:function e(t){var i;var n=t.getCompatData(),r=babelHelpers.slicedToArray(n,1),a=r[0];var s;if(this.getProductCount()>0||((i=this.products[0])===null||i===void 0?void 0:i.getField("ID"))<=0){s=this.addProductRow()}else{var l;s=(l=this.products[0])===null||l===void 0?void 0:l.getField("ID")}this.selectProductInRow(s,a)}},{key:"selectProductInRow",value:function e(t,i){var n=this;if(!h.Type.isStringFilled(t)||h.Text.toNumber(i)<=0){return}requestAnimationFrame((function(){var e;(e=n.getProductSelector(t))===null||e===void 0?void 0:e.onProductSelect(i)}))}},{key:"handleOnSave",value:function e(t){var i=[];this.products.forEach((function(e){var t={fields:jt({},e.fields),rowId:e.fields.ROW_ID};i.push(t)}));this.setSettingValue("items",i)}},{key:"handleProductListFocus",value:function e(t){if(this.isReadOnly()){return}var i=false;var n=Wt(this.products),r;try{for(n.s();!(r=n.n()).done;){var a=r.value;if(a.isEmptyRow()){i=true;this.focusProductSelector(a.fields["ID"]);break}}}catch(e){n.e(e)}finally{n.f()}if(!i){this.handleProductRowAdd()}}},{key:"handleOnEntityUpdate",value:function e(t){var i=t.getData(),n=babelHelpers.slicedToArray(i,1),r=n[0];if(this.isChanged()&&r.entityId===this.getSettingValue("entityId")&&r.entityTypeId===this.getSettingValue("entityTypeId")){this.setGridChanged(false);this.reloadGrid(false)}}},{key:"handleEditorSubmit",value:function e(t){if(!this.isLocationDependantTaxesEnabled()){return}var i=t.getData()[0];if(!i||!i.hasOwnProperty("LOCATION_ID")){return}if(i["LOCATION_ID"]!==this.getLocationId()){this.setLocationId(i["LOCATION_ID"]);this.reloadGrid(false)}}},{key:"handleOnInnerCancel",value:function e(t){var i=this;if(this.controller){this.controller.rollback()}this.setGridChanged(false);s.EventEmitter.subscribeOnce(this,"onGridReloaded",(function(){return i.actionUpdateTotalData({isInternalChanging:true})}));this.reloadGrid(false)}},{key:"changeActivePanelButtons",value:function e(t){var i=this.getContainer();var n=i.querySelector(".crm-entity-product-list-add-block-"+t);if(h.Type.isDomNode(n)){h.Dom.removeClass(n,"crm-entity-product-list-add-block-hidden");h.Dom.addClass(n,"crm-entity-product-list-add-block-active")}var r=t==="top"?"bottom":"top";var a=i.querySelector(".crm-entity-product-list-add-block-"+r);if(h.Type.isDomNode(a)){h.Dom.addClass(a,"crm-entity-product-list-add-block-hidden");h.Dom.removeClass(a,"crm-entity-product-list-add-block-active")}return n}},{key:"reloadGrid",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;this.getGrid().reloadTable("POST",{useProductsFromRequest:i},(function(){return s.EventEmitter.emit(t,"onGridReloaded")}))}},{key:"handleOnBeforeGridRequest",value:function t(i){var n=this;var r=i.getCompatData(),a=babelHelpers.slicedToArray(r,2),l=a[0],o=a[1];if(!l||!l.parent||l.parent.getId()!==this.getGridId()){return}var u=!("useProductsFromRequest"in o.data);var d=u?true:o.data.useProductsFromRequest;o.url=this.getReloadUrl();o.method="POST";o.sessid=BX.bitrix_sessid();o.data=jt(jt({},o.data),{},{signedParameters:this.getSignedParameters(),products:d?this.getProductsFields(Jt(e,e,ci).call(e)):null,locationId:this.getLocationId(),currencyId:this.getCurrencyId()});this.clearEditor();if(u&&this.isChanged()){s.EventEmitter.subscribeOnce("Grid::updated",(function(){return n.actionUpdateTotalData({isInternalChanging:false})}))}}},{key:"handleOnGridUpdated",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,1),r=n[0];if(!r||r.getId()!==this.getGridId()){return}this.getSettingsPopup().updateCheckboxState()}},{key:"handleOnGridRowMoved",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,3),r=n[0],a=n[2];if(!a||a.getId()!==this.getGridId()){return}var s=this.resortProductsByIds(r);if(s){this.refreshSortFields();this.numerateRows();this.executeActions([{type:this.actions.productListChanged}])}}},{key:"initPageEventsManager",value:function e(){var t=this.getSettingValue("componentId");this.pageEventsManager=new tt({id:t})}},{key:"getPageEventsManager",value:function e(){if(!this.pageEventsManager){this.initPageEventsManager()}return this.pageEventsManager}},{key:"canEdit",value:function e(){return this.getSettingValue("allowEdit",false)===true}},{key:"canEditCatalogPrice",value:function e(){return this.getSettingValue("allowCatalogPriceEdit",false)===true}},{key:"canSaveCatalogPrice",value:function e(){return this.getSettingValue("allowCatalogPriceSave",false)===true}},{key:"enableEdit",value:function e(){var t=this.getGrid().getRows().getRows();t.forEach((function(e){if(!e.isHeadChild()&&!e.isTemplate()){e.edit()}}))}},{key:"addFirstRowIfEmpty",value:function e(){var t=this;if(this.getGrid().getRows().getCountDisplayed()===0){requestAnimationFrame((function(){return t.addProductRow()}))}}},{key:"clearEditor",value:function e(){this.unsubscribeProductsEvents();this.products=[];this.productsWasInitiated=false;this.destroySettingsPopup();this.unsubscribeDomEvents();this.unsubscribeCustomEvents();h.Event.unbindAll(this.container)}},{key:"wasProductsInitiated",value:function e(){return this.productsWasInitiated}},{key:"unsubscribeProductsEvents",value:function e(){this.products.forEach((function(e){e.unsubscribeCustomEvents()}))}},{key:"destroy",value:function e(){this.setForm(null);this.clearController();this.clearEditor()}},{key:"setController",value:function e(t){if(this.controller===t){return}if(this.controller){this.controller.clearProductList()}this.controller=t}},{key:"clearController",value:function e(){this.controller=null}},{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"getSettings",value:function e(){return this.settings}},{key:"setSettings",value:function e(t){this.settings=t?t:{}}},{key:"getSettingValue",value:function e(t,i){return this.settings.hasOwnProperty(t)?this.settings[t]:i}},{key:"setSettingValue",value:function e(t,i){this.settings[t]=i}},{key:"getComponentName",value:function e(){return this.getSettingValue("componentName","")}},{key:"getReloadUrl",value:function e(){return this.getSettingValue("reloadUrl","")}},{key:"getSignedParameters",value:function e(){return this.getSettingValue("signedParameters","")}},{key:"getContainerId",value:function e(){return this.getSettingValue("containerId","")}},{key:"getGridId",value:function e(){return this.getSettingValue("gridId","")}},{key:"getLanguageId",value:function e(){return this.getSettingValue("languageId","")}},{key:"getSiteId",value:function e(){return this.getSettingValue("siteId","")}},{key:"getCatalogId",value:function e(){return this.getSettingValue("catalogId",0)}},{key:"isReadOnly",value:function e(){return this.getSettingValue("readOnly",true)}},{key:"setReadOnly",value:function e(t){this.setSettingValue("readOnly",t)}},{key:"getCurrencyId",value:function e(){return this.getSettingValue("currencyId","")}},{key:"setCurrencyId",value:function e(t){this.setSettingValue("currencyId",t);this.products.forEach((function(e){var i;return(i=e.getModel())===null||i===void 0?void 0:i.setOption("currency",t)}))}},{key:"isLocationDependantTaxesEnabled",value:function e(){return this.getSettingValue("isLocationDependantTaxesEnabled",false)}},{key:"getLocationId",value:function e(){return this.getSettingValue("locationId")}},{key:"setLocationId",value:function e(t){this.setSettingValue("locationId",t)}},{key:"changeCurrencyId",value:function e(t){var i=this;this.setCurrencyId(t);var n=[];this.products.forEach((function(e){var t={};ei(i,ai,ui).call(i).forEach((function(i){t[i]=e.getField(i)}));n.push({fields:t,id:e.getId()})}));if(n.length>0){this.ajaxRequest("calculateProductPrices",{products:n,currencyId:t})}var r=this.getGridEditData();var a=r[ti];a["CURRENCY"]=this.getCurrencyId();var s=["DISCOUNT_ROW","SUM","PRICE"];s.forEach((function(e){a[e]["CURRENCY"]["VALUE"]=i.getCurrencyId()}));this.setGridEditData(r)}},{key:"onCalculatePricesResponse",value:function e(t){this.products.forEach((function(e){if(h.Type.isObject(t[e.getId()])){e.updateUiCurrencyFields();["BASE_PRICE","DISCOUNT_ROW","DISCOUNT_SUM","CURRENCY_ID"].forEach((function(i){e.updateField(i,h.Text.toNumber(t[e.getId()][i]))}));e.setField("CURRENCY",t[e.getId()]["CURRENCY_ID"])}}));this.updateTotalUiCurrency()}},{key:"updateTotalUiCurrency",value:function e(){var t=this;var i=BX(this.getSettingValue("totalBlockContainerId",null));if(h.Type.isElementNode(i)){i.querySelectorAll(".crm-product-list-payment-side-table-column").forEach((function(e){var i=e.querySelector(".crm-product-list-result-grid-total");if(i){e.innerHTML=o.CurrencyCore.getPriceControl(i,t.getCurrencyId())}}))}}},{key:"getCurrencyText",value:function e(){var t=this.getCurrencyId();if(!h.Type.isStringFilled(t)){return""}var i=o.CurrencyCore.getCurrencyFormat(t);return i&&i.FORMAT_STRING.replace(/(^|[^&])#/,"$1").trim()||""}},{key:"getDataFieldName",value:function e(){return this.getSettingValue("dataFieldName","")}},{key:"getDataSettingsFieldName",value:function e(){var t=this.getDataFieldName();return h.Type.isStringFilled(t)?t+"_SETTINGS":""}},{key:"getDiscountEnabled",value:function e(){return this.getSettingValue("enableDiscount","N")}},{key:"getPricePrecision",value:function e(){return this.getSettingValue("pricePrecision",ii)}},{key:"getQuantityPrecision",value:function e(){return this.getSettingValue("quantityPrecision",ii)}},{key:"getCommonPrecision",value:function e(){return this.getSettingValue("commonPrecision",ii)}},{key:"getTaxList",value:function e(){return this.getSettingValue("taxList",[])}},{key:"getTaxAllowed",value:function e(){return this.getSettingValue("allowTax","N")}},{key:"isTaxAllowed",value:function e(){return this.getTaxAllowed()==="Y"}},{key:"getTaxEnabled",value:function e(){return this.getSettingValue("enableTax","N")}},{key:"isTaxEnabled",value:function e(){return this.getTaxEnabled()==="Y"}},{key:"isTaxUniform",value:function e(){return this.getSettingValue("taxUniform",true)}},{key:"getMeasures",value:function e(){return this.getSettingValue("measures",[])}},{key:"getDefaultMeasure",value:function e(){return this.getSettingValue("defaultMeasure",{})}},{key:"getRowIdPrefix",value:function e(){return this.getSettingValue("rowIdPrefix","crm_entity_product_list_")}},{key:"parseInt",value:function(e){function t(t){return e.apply(this,arguments)}t.toString=function(){return e.toString()};return t}((function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var i;var n=h.Type.isNumber(e);var r=h.Type.isStringFilled(e);if(!n&&!r){return t}if(r){e=e.replace(/^\s+|\s+$/g,"");var a=e.indexOf("-")===0;i=parseInt(e.replace(/[^\d]/g,""),10);if(isNaN(i)){i=t}else{if(a){i=-i}}}else{i=parseInt(e,10);if(isNaN(i)){i=t}}return i}))},{key:"parseFloat",value:function(e){function t(t){return e.apply(this,arguments)}t.toString=function(){return e.toString()};return t}((function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ii;var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var n;var r=h.Type.isNumber(e);var a=h.Type.isStringFilled(e);if(!r&&!a){return i}if(a){e=e.replace(/^\s+|\s+$/g,"");var s=e.indexOf(".");var l=e.indexOf(",");var o=e.indexOf("-")===0;if(s<0&&l>=0){var u=e.substr(0,l);var d=e.length-l-1;if(d>0){u+="."+e.substr(l+1,d)}e=u}e=e.replace(/[^\d.]+/g,"");n=parseFloat(e);if(isNaN(n)){n=i}if(o){n=-n}}else{n=parseFloat(e)}if(t>=0){n=this.round(n,t)}return n}))},{key:"round",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ii;var n=Math.pow(10,i);return Math.round(t*n)/n}},{key:"calculatePriceWithoutDiscount",value:function e(t,i,n){var a=0;switch(n){case r.DiscountType.PERCENTAGE:a=t-t*i/100;break;case r.DiscountType.MONETARY:a=t-i;break}return a}},{key:"calculateDiscountRate",value:function e(t,i){if(t===0){return 0}if(i===0){return t>0?100:-100}return 100*(t-i)/t}},{key:"calculateDiscount",value:function e(t,i){return t*i/100}},{key:"calculatePriceWithoutTax",value:function e(t,i){return t/(1+i/100)}},{key:"calculatePriceWithTax",value:function e(t,i){return t*(1+i/100)}},{key:"getContainer",value:function e(){var t=this;return this.cache.remember("container",(function(){return document.getElementById(t.getContainerId())}))}},{key:"initForm",value:function e(){var t=this.getSettingValue("formId","");var i=h.Type.isStringFilled(t)?BX("form_"+t):null;if(h.Type.isElementNode(i)){this.setForm(i)}}},{key:"isExistForm",value:function e(){return h.Type.isElementNode(this.getForm())}},{key:"getForm",value:function e(){return this.form}},{key:"setForm",value:function e(t){this.form=t}},{key:"initFormFields",value:function e(){var t=this.getForm();if(h.Type.isElementNode(t)){var i=this.getDataField();if(!h.Type.isElementNode(i)){this.initDataField()}var n=this.getDataSettingsField();if(!h.Type.isElementNode(n)){this.initDataSettingsField()}}}},{key:"initFormField",value:function e(t){var i=this.getForm();if(h.Type.isElementNode(i)&&h.Type.isStringFilled(t)){h.Dom.append(h.Dom.create("input",{attrs:{type:"hidden",name:t}}),i)}}},{key:"removeFormFields",value:function e(){var t=this.getDataField();if(h.Type.isElementNode(t)){h.Dom.remove(t)}var i=this.getDataSettingsField();if(h.Type.isElementNode(i)){h.Dom.remove(i)}}},{key:"initDataField",value:function e(){this.initFormField(this.getDataFieldName())}},{key:"initDataSettingsField",value:function e(){this.initFormField(this.getDataSettingsFieldName())}},{key:"getFormField",value:function e(t){var i=this.getForm();if(h.Type.isElementNode(i)&&h.Type.isStringFilled(t)){return i.querySelector('input[name="'+t+'"]')}return null}},{key:"getDataField",value:function e(){return this.getFormField(this.getDataFieldName())}},{key:"getDataSettingsField",value:function e(){return this.getFormField(this.getDataSettingsFieldName())}},{key:"getProductCount",value:function e(){return this.products.filter((function(e){return!e.isEmpty()})).length}},{key:"initProducts",value:function e(){var t=this.getSettingValue("items",[]);var i=this.getSettingValue("isReserveBlocked",false);var n=Wt(t),r;try{for(n.s();!(r=n.n()).done;){var a=r.value;var s=jt({},a.fields);var l={selectorId:a.selectorId,isReserveBlocked:i};this.products.push(new Ae(a.rowId,s,l,this))}}catch(e){n.e(e)}finally{n.f()}this.numerateRows();this.productsWasInitiated=true}},{key:"numerateRows",value:function e(){this.products.forEach((function(e,t){e.setRowNumber(t+1)}))}},{key:"getGrid",value:function e(){var t=this;return this.cache.remember("grid",(function(){var e=t.getGridId();if(!h.Reflection.getClass("BX.Main.gridManager.getInstanceById")){throw Error("Cannot find grid with '".concat(e,"' id."))}return BX.Main.gridManager.getInstanceById(e)}))}},{key:"initGridData",value:function e(){var t=this.getSettingValue("templateGridEditData",null);if(t){this.setGridEditData(t)}}},{key:"getGridEditData",value:function e(){return this.getGrid().arParams.EDITABLE_DATA}},{key:"setGridEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA=t}},{key:"setOriginalTemplateEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA[ti]=t}},{key:"handleProductErrorsChange",value:function e(){if(ei(this,si,di).call(this)){this.controller.disableSaveButton()}}},{key:"handleFieldChange",value:function e(t){var i=t.target.closest("tr");if(i&&i.hasAttribute("data-id")){var n=this.getProductById(i.getAttribute("data-id"));if(n){var r=t.target.closest("td");var a=this.getFieldCodeByGridCell(i,r);if(a){n.updateFieldByEvent(a,t)}}}}},{key:"handleDropdownChange",value:function e(t){var i=t.getData(),n=babelHelpers.slicedToArray(i,5),r=n[0],a=n[4];var s=new RegExp(this.getRowIdPrefix()+"([A-Za-z0-9]+)_(\\w+)_control","i");var l=r.match(s);if(l){var o=babelHelpers.slicedToArray(l,3),u=o[1],d=o[2];var c=this.getProductById(u);if(c){c.updateField(d,a,c.modeChanges.EDIT)}}}},{key:"getProductById",value:function e(t){var i=this.getRowIdPrefix()+t;return this.getProductByRowId(i)}},{key:"getProductByRowId",value:function e(t){return this.products.find((function(e){return e.getId()===t}))}},{key:"getFieldCodeByGridCell",value:function e(t,i){if(!h.Type.isDomNode(t)||!h.Type.isDomNode(i)){return null}var n=this.getGrid();if(n){var r=n.getRows().getHeadFirstChild();var a=babelHelpers.toConsumableArray(t.cells).indexOf(i);return r.getCellNameByCellIndex(a)}return null}},{key:"handleProductSelectionPopup",value:function e(t){var i="crm_entity_product_list";var n=this.getSettingValue("jsEventsManagerId","");var r=new BX.CDialog({content_url:"/bitrix/components/bitrix/crm.product_row.list/product_choice_dialog.php?"+"caller="+i+"&JS_EVENTS_MANAGER_ID="+BX.util.urlencode(n)+"&sessid="+BX.bitrix_sessid(),height:Math.max(500,window.innerHeight-400),width:Math.max(800,window.innerWidth-400),draggable:true,resizable:true,min_height:500,min_width:800,zIndex:800});s.EventEmitter.subscribeOnce(r,"onWindowRegister",BX.defer((function(){r.Get().style.position="fixed";r.Get().style.top=parseInt(r.Get().style.top)-BX.GetWindowScrollPos().scrollTop+"px"})));s.EventEmitter.subscribeOnce(window,"EntityProductListController:onInnerCancel",BX.defer((function(){r.Close()})));if(!h.Type.isUndefined(BX.Crm.EntityEvent)){s.EventEmitter.subscribeOnce(window,BX.Crm.EntityEvent.names.update,BX.defer((function(){requestAnimationFrame((function(){r.Close()}),0)})))}r.Show()}},{key:"addProductRow",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var i=this.createGridProductRow();var n=i.getId();if(t){var r;var a=(r=this.getGrid().getRows().getById(t.getField("ID")))===null||r===void 0?void 0:r.getNode();if(a){a.parentNode.insertBefore(i.getNode(),a.nextSibling)}}this.initializeNewProductRow(n,t);this.getGrid().bindOnRowEvents();return n}},{key:"handleProductRowAdd",value:function e(){var t=this.addProductRow();this.focusProductSelector(t)}},{key:"handleShowSettingsPopup",value:function e(){this.getSettingsPopup().show()}},{key:"destroySettingsPopup",value:function e(){if(this.cache.has("settings-popup")){this.cache.get("settings-popup").getPopup().destroy();this.cache["delete"]("settings-popup")}}},{key:"getSettingsPopup",value:function e(){var t=this;return this.cache.remember("settings-popup",(function(){return new Tt(t.getContainer().querySelector('.crm-entity-product-list-add-block-active [data-role="product-list-settings-button"]'),t.getSettingValue("popupSettings",[]),t)}))}},{key:"getHintPopup",value:function e(){var t=this;return this.cache.remember("hint-popup",(function(){return new p(t)}))}},{key:"createGridProductRow",value:function e(){var t=h.Text.getRandom();var i=this.redefineTemplateEditData(t);var n=this.getGrid();var r;if(this.getSettingValue("newRowPosition")==="bottom"){r=n.appendRowEditor()}else{r=n.prependRowEditor()}var a=r.getNode();if(h.Type.isDomNode(a)){a.setAttribute("data-id",t);r.makeCountable()}if(i){this.setOriginalTemplateEditData(i)}s.EventEmitter.emit("Grid::thereEditedRows",[]);n.adjustRows();n.updateCounterDisplayed();n.updateCounterSelected();return r}},{key:"handleDeleteRow",value:function e(t,i){i.preventDefault();this.deleteRow(t)}},{key:"redefineTemplateEditData",value:function e(t){var i=this.getGridEditData();var n=i[ti];var r=this.prepareCustomEditData(n,t);this.setOriginalTemplateEditData(jt(jt({},n),r));return n}},{key:"prepareCustomEditData",value:function e(t,i){var n={};var r=this.getSettingValue("templateIdMask","");for(var a in t){if(t.hasOwnProperty(a)){if(h.Type.isStringFilled(t[a])&&t[a].indexOf(r)>=0){n[a]=t[a].replace(new RegExp(r,"g"),i)}else if(h.Type.isPlainObject(t[a])){n[a]=this.prepareCustomEditData(t[a],i)}else{n[a]=t[a]}}}return n}},{key:"initializeNewProductRow",value:function e(t){var i;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var r=n===null||n===void 0?void 0:n.getFields();if(h.Type.isNil(r)){r=jt(jt({},this.getSettingValue("templateItemFields",{})),{CURRENCY:this.getCurrencyId()});var a=this.products[this.products.length-1];if(a){r.TAX_INCLUDED=a.getField("TAX_INCLUDED")}}var s=this.getRowIdPrefix()+t;r.ID=t;if(h.Type.isObject(r.IMAGE_INFO)){delete r.IMAGE_INFO.input}delete r.RESERVE_ID;var l=this.getSettingValue("isReserveBlocked",false);var o={isReserveBlocked:l,selectorId:"crm_grid_"+s};var u=new Ae(s,r,o,this);u.refreshFieldsLayout();if(n instanceof Ae){var d,c;this.products.splice(1+this.products.indexOf(n),0,u);(d=u.getSelector())===null||d===void 0?void 0:d.reloadFileInput();(c=u.getSelector())===null||c===void 0?void 0:c.layout();u.updateUiMeasure(u.getField("MEASURE_CODE"),h.Text.encode(u.getField("MEASURE_NAME")))}else if(this.getSettingValue("newRowPosition")==="bottom"){this.products.push(u)}else{this.products.unshift(u)}this.refreshSortFields();this.numerateRows();u.updateUiCurrencyFields();this.updateTotalUiCurrency();(i=u.getSelector())===null||i===void 0?void 0:i.setConfig("ENABLE_EMPTY_PRODUCT_ERROR",this.getSettingValue("enableEmptyProductError",false));return u}},{key:"isTaxIncludedActive",value:function e(){return this.products.filter((function(e){return e.isTaxIncluded()})).length>0}},{key:"getProductSelector",value:function e(t){return u.ProductSelector.getById("crm_grid_"+this.getRowIdPrefix()+t)}},{key:"focusProductSelector",value:function e(t){var i=this;requestAnimationFrame((function(){var e;(e=i.getProductSelector(t))===null||e===void 0?void 0:e.searchInDialog().focusName()}))}},{key:"handleOnBeforeProductChange",value:function e(t){var i=t.getData();var n=this.getProductByRowId(i.rowId);if(n){this.getGrid().tableFade();n.resetExternalActions()}}},{key:"handleOnProductChange",value:function e(t){var i=this;var n=t.getData();var r=this.getProductByRowId(n.rowId);if(r&&n.fields){var a=new Promise((function(e,t){var a=n.fields;if(!h.Type.isNil(a["IMAGE_INFO"])){a["IMAGE_INFO"]=JSON.stringify(a["IMAGE_INFO"])}if(i.getCurrencyId()!==a["CURRENCY_ID"]){a["CURRENCY"]=a["CURRENCY_ID"];var s={};ei(i,ai,ui).call(i).forEach((function(e){s[e]=n.fields[e]}));var l=[{fields:s,id:r.getId()}];h.ajax.runComponentAction(i.getComponentName(),"calculateProductPrices",{mode:"class",signedParameters:i.getSignedParameters(),data:{products:l,currencyId:i.getCurrencyId(),options:{ACTION:"calculateProductPrices"}}}).then((function(t){var i=t.data.result[r.getId()];if(i){i["CUSTOMIZED"]="Y";e(Object.assign(a,i))}else{e(a)}}))}else{e(a)}}));a.then((function(e){if(i.products.length>1){var t=e["VAT_ID"]||e["TAX_ID"];var a=e["VAT_INCLUDED"]||e["TAX_INCLUDED"];if(t>0&&a!==r.getTaxIncluded()){var s;var l=(s=i.getTaxList())===null||s===void 0?void 0:s.find((function(e){return parseInt(e.ID)===t}));if((l===null||l===void 0?void 0:l.VALUE)>0&&a==="Y"){e["BASE_PRICE"]=e["BASE_PRICE"]/(1+l.VALUE/100)}}["TAX_INCLUDED","VAT_INCLUDED"].forEach((function(t){return delete e[t]}))}if(r.getField("OFFER_ID")!==e.ID){e["ROW_RESERVED"]=0;e["DEDUCTED_QUANTITY"]=0;if(!i.getSettingValue("allowDiscountChange",true)){e["DISCOUNT_ROW"]=0;e["DISCOUNT_SUM"]=0;e["DISCOUNT_RATE"]=0;e["DISCOUNT"]=0;r.updateUiHtmlField("DISCOUNT_PRICE",o.CurrencyCore.currencyFormat(0,i.getCurrencyId(),true));r.updateUiHtmlField("DISCOUNT_ROW",o.CurrencyCore.currencyFormat(0,i.getCurrencyId(),true))}}Object.keys(e).forEach((function(t){r.updateFieldValue(t,e[t])}));if(!h.Type.isStringFilled(e["CUSTOMIZED"])){r.setField("CUSTOMIZED","N")}r.setField("IS_NEW",n.isNew?"Y":"N");r.layoutReserveControl();r.layoutStoreSelector();r.initHandlersForSelectors();r.updateUiStoreAmountData();r.updatePropertyFields();r.modifyBasePriceInput();r.executeExternalActions();i.getGrid().tableUnfade()}))}else{this.getGrid().tableUnfade()}}},{key:"handleOnBeforeProductClear",value:function e(t){var i=t.getData(),n=i.rowId;var r=this.getProductByRowId(n);r.clearPropertyFields()}},{key:"handleOnProductClear",value:function e(t){var i=t.getData(),n=i.rowId;var r=this.getProductByRowId(n);if(r){r.layoutReserveControl();r.initHandlersForSelectors();r.changeBasePrice(0);if(!this.getSettingValue("allowDiscountChange",true)){r.setDiscount(0);r.updateUiHtmlField("DISCOUNT_PRICE",o.CurrencyCore.currencyFormat(0,this.getCurrencyId(),true));r.updateUiHtmlField("DISCOUNT_ROW",o.CurrencyCore.currencyFormat(0,this.getCurrencyId(),true))}r.modifyBasePriceInput();r.executeExternalActions()}}},{key:"compileProductData",value:function e(){if(!this.isExistForm()){return}this.initFormFields();var t=this.getDataField();var i=this.getDataSettingsField();this.cleanProductRows();if(h.Type.isElementNode(t)&&h.Type.isElementNode(i)){t.value=this.prepareProductDataValue();i.value=JSON.stringify({ENABLE_DISCOUNT:this.getDiscountEnabled(),ENABLE_TAX:this.getTaxEnabled()})}this.addFirstRowIfEmpty()}},{key:"prepareProductDataValue",value:function t(){var i="";if(this.getProductCount()){var n=[];this.products.forEach((function(t){var i=t.getFields(Jt(e,e,ci).call(e));if(!/^[0-9]+$/.test(i["ID"])){i["ID"]=0}i["CUSTOMIZED"]="Y";n.push(i)}));i=JSON.stringify(n)}return i}},{key:"executeActions",value:function e(t){var i=this;if(!h.Type.isArrayFilled(t)){return}var n=t.filter((function(e){return e.type===i.actions.updateTotal||e.type===i.actions.disableSaveButton})).length>0;var r=Wt(t),a;try{for(r.s();!(a=r.n()).done;){var s=a.value;if(!h.Type.isPlainObject(s)||!h.Type.isStringFilled(s.type)){continue}switch(s.type){case this.actions.productChange:this.actionSendProductChange(s,n);break;case this.actions.productListChanged:this.actionSendProductListChanged(n);break;case this.actions.updateListField:this.actionUpdateListField(s);break;case this.actions.updateTotal:this.actionUpdateTotalData();break;case this.actions.stateChanged:this.actionSendStatusChange(s);break}}}catch(e){r.e(e)}finally{r.f()}}},{key:"actionSendProductChange",value:function e(t,i){if(!h.Type.isStringFilled(t.id)){return}var n=this.getProductByRowId(t.id);if(!n){return}s.EventEmitter.emit(this,"ProductList::onChangeFields",{rowId:t.id,productId:n.getField("PRODUCT_ID"),fields:this.getProductByRowId(t.id).getCatalogFields()});if(this.controller){this.controller.productChange(i);this.setGridChanged(true)}}},{key:"actionSendProductListChanged",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(this.controller){this.controller.productChange(t);this.setGridChanged(true)}}},{key:"actionUpdateListField",value:function e(t){if(!h.Type.isStringFilled(t.field)||!("value"in t)){return}if(!this.allowUpdateListField(t.field)){return}this.updateFieldForList=t.field;var i=Wt(this.products),n;try{for(i.s();!(n=i.n()).done;){var r=n.value;r.updateFieldByName(t.field,t.value)}}catch(e){i.e(e)}finally{i.f()}this.updateFieldForList=null}},{key:"actionUpdateTotalData",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(this.totalData.inProgress){return}this.updateTotalDataDelayedHandler(t)}},{key:"actionSendStatusChange",value:function e(t){if(!("value"in t)){return}if(this.stateChange.changed===t.value){return}this.stateChange.changed=t.value;if(this.stateChange.sended){return}this.stateChange.sended=true}},{key:"allowUpdateListField",value:function e(t){if(this.updateFieldForList!==null){return false}var i=true;switch(t){case"TAX_INCLUDED":i=this.isTaxUniform()&&this.isTaxAllowed();break}return i}},{key:"setGridChanged",value:function e(t){this.isChangedGrid=t}},{key:"isChanged",value:function e(){return this.isChangedGrid}},{key:"updateTotalDataDelayed",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(this.totalData.inProgress){return}this.totalData.inProgress=true;var i=this.getProductsFields(this.getProductFieldListForTotalData());i.forEach((function(e){return e["CUSTOMIZED"]="Y"}));this.ajaxRequest("calculateTotalData",{options:t,products:i,currencyId:this.getCurrencyId()})}},{key:"getProductsFields",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var i=[];var n=Wt(this.products),r;try{for(n.s();!(r=n.n()).done;){var a=r.value;i.push(a.getFields(t))}}catch(e){n.e(e)}finally{n.f()}return i}},{key:"getProductFieldListForTotalData",value:function e(){return["PRODUCT_ID","PRODUCT_NAME","QUANTITY","DISCOUNT_TYPE_ID","DISCOUNT_RATE","DISCOUNT_SUM","TAX_RATE","TAX_INCLUDED","PRICE_EXCLUSIVE","PRICE","CUSTOMIZED"]}},{key:"setTotalData",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=BX(this.getSettingValue("totalBlockContainerId",null));if(h.Type.isElementNode(n)){var r=this.getCurrencyId();var a=["totalCost","totalDelivery","totalTax","totalWithoutTax","totalDiscount","totalWithoutDiscount"];for(var s=0,l=a;s<l.length;s++){var u=l[s];var d=n.querySelector('[data-total="'+u+'"]');if(h.Type.isElementNode(d)&&u in t){d.innerHTML=o.CurrencyCore.currencyFormat(t[u],r,false)}}}this.sendTotalData(t,i);this.totalData.inProgress=false}},{key:"sendTotalData",value:function e(t,i){var n=this;if(this.controller){var r=true;if(h.Type.isObject(i)&&(i.isInternalChanging===true||i.isInternalChanging==="true")){r=false}setTimeout((function(){n.controller.changeSumTotal(t,r,!ei(n,si,di).call(n))}),500)}}},{key:"ajaxRequest",value:function e(t,i){var n=this;var r=h.Text.getRandom();this.ajaxPool.set(t,r);if(!h.Type.isPlainObject(i.options)){i.options={}}i.options.ACTION=t;i.options.REQUEST_KEY=r;h.ajax.runComponentAction(this.getComponentName(),t,{mode:"class",signedParameters:this.getSignedParameters(),data:i}).then((function(e){return n.ajaxResultSuccess(e,i.options)}),(function(e){return n.ajaxResultFailure(e,i.options)}))}},{key:"ajaxResultSuccess",value:function e(t,i){if(!this.ajaxResultCommonCheck(t)||this.ajaxPool.get(t.data.action)!==i.REQUEST_KEY){return}this.ajaxPool["delete"](t.data.action);s.EventEmitter.emit(this,"onAjaxSuccess",t.data.action);switch(t.data.action){case"calculateTotalData":if(h.Type.isPlainObject(t.data.result)){this.setTotalData(t.data.result,i)}break;case"calculateProductPrices":if(h.Type.isPlainObject(t.data.result)){this.onCalculatePricesResponse(t.data.result)}break}}},{key:"validateSubmit",value:function e(){return new Promise((function(e,t){var i=BX.UI.Notification.Center.getBalloonByCategory(d.ProductModel.SAVE_NOTIFICATION_CATEGORY);if(i){s.EventEmitter.subscribeOnce(i,BX.UI.Notification.Event.getFullName("onClose"),(function(){setTimeout(e,500)}));i.close()}else{setTimeout(e(),50)}}))}},{key:"ajaxResultFailure",value:function e(t,i){this.ajaxPool["delete"](i.ACTION)}},{key:"ajaxResultCommonCheck",value:function e(t){if(!h.Type.isPlainObject(t)){return false}if(!h.Type.isStringFilled(t.status)){return false}if(t.status!=="success"){return false}if(!h.Type.isPlainObject(t.data)){return false}if(!h.Type.isStringFilled(t.data.action)){return false}if(!("result"in t.data)){return false}return true}},{key:"deleteRow",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!h.Type.isStringFilled(t)){return}var n=this.getGrid().getRows().getById(t);if(n){h.Dom.remove(n.getNode());this.getGrid().getRows().reset()}var r=this.getProductById(t);if(r){var a=this.products.indexOf(r);if(a>-1){this.products.splice(a,1);this.refreshSortFields();this.numerateRows()}}s.EventEmitter.emit("Grid::thereEditedRows",[]);if(!i){this.addFirstRowIfEmpty();this.executeActions([{type:this.actions.productListChanged},{type:this.actions.updateTotal}])}}},{key:"copyRow",value:function e(t){this.addProductRow(t);this.refreshSortFields();this.numerateRows();s.EventEmitter.emit("Grid::thereEditedRows",[]);this.executeActions([{type:this.actions.productListChanged},{type:this.actions.updateTotal}])}},{key:"cleanProductRows",value:function e(){var t=this;this.products.filter((function(e){return e.isEmpty()})).forEach((function(e){return t.deleteRow(e.getField("ID"),true)}))}},{key:"resortProductsByIds",value:function e(t){var i=false;if(h.Type.isArrayFilled(t)){this.products.sort((function(e,n){if(t.indexOf(e.getField("ID"))>t.indexOf(n.getField("ID"))){return 1}i=true;return-1}))}return i}},{key:"refreshSortFields",value:function e(){this.products.forEach((function(e,t){return e.setField("SORT",(t+1)*10)}))}},{key:"handleOnTabShow",value:function e(){s.EventEmitter.emit("onDemandRecalculateWrapper",[this])}},{key:"showFieldTourHint",value:function e(t,i,n){var r=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];var a=arguments.length>4&&arguments[4]!==undefined?arguments[4]:"";if(this.products.length>0){var s=this.products[0].getNode();if(this.getProductByRowId(a)){s=this.getProductByRowId(a).getNode()}var l=[];var o=Wt(r),u;try{for(o.s();!(u=o.n()).done;){var d=u.value;var c=s.querySelector('[data-name="'.concat(d,'"]'));if(c!==null){l.push(c)}}}catch(e){o.e(e)}finally{o.f()}var h=s.querySelector('[data-name="'.concat(t,'"]'));if(h!==null){babelHelpers.classPrivateFieldGet(this,ni).processFieldTour(h,i,n,l)}}}},{key:"getActiveHint",value:function e(){return babelHelpers.classPrivateFieldGet(this,ni).getActiveHint()}},{key:"openIntegrationLimitSlider",value:function e(){top.BX.UI.InfoHelper.show("limit_store_crm_integration");var t=top.BX.UI.InfoHelper.getSlider();top.BX.Event.EventEmitter.subscribeOnce("SidePanel.Slider:onCloseComplete",(function(e){var i;var n=(i=e.getData()[0])===null||i===void 0?void 0:i.getSlider();if(n!==t){return}window.location.search+="&active_tab=tab_products"}))}},{key:"getRestrictedProductTypes",value:function e(){return this.getSettingValue("restrictedProductTypes",[])}}]);return e}();function oi(){this.getGrid()._clickOnRowActionsButton=function(){}}function ui(){return["BASE_PRICE","TAX_INCLUDED","PRICE_NETTO","PRICE_BRUTTO","DISCOUNT_ROW","DISCOUNT_SUM","CURRENCY"]}function di(){return this.products.filter((function(e){return e.getModel().getErrorCollection().hasErrors()})).length>0}function ci(){return["ID","PRODUCT_ID","PRODUCT_NAME","QUANTITY","TAX_RATE","TAX_INCLUDED","PRICE_EXCLUSIVE","PRICE_NETTO","PRICE_BRUTTO","PRICE","CUSTOMIZED","BASE_PRICE","DISCOUNT_ROW","DISCOUNT_SUM","DISCOUNT_TYPE_ID","DISCOUNT_RATE","CURRENCY","STORE_ID","INPUT_RESERVE_QUANTITY","RESERVE_QUANTITY","DATE_RESERVE_END","SORT","MEASURE_CODE","MEASURE_NAME","TYPE"]}e.Editor=li;e.PageEventsManager=tt})(this.BX.Crm.Entity.ProductList=this.BX.Crm.Entity.ProductList||{},BX,BX,BX.Catalog,BX.Catalog,BX.Main,BX.Event,BX.Catalog.StoreUse,BX.Currency,BX.Catalog,BX.Catalog,BX,BX,BX,BX.UI.Tour);
//# sourceMappingURL=script.map.js