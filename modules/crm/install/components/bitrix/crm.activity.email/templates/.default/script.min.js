(function(){if(window.BXCrmActivityEmailController)return;var t={};t.init=function(t){var i=this;if(this.__inited)return;this.options=t;if(!BX.type.isPlainObject(this.options.templates))this.options.templates={};this.__dummyNode=document.createElement("DIV");this.templates={0:{FROM:"",SUBJECT:"",BODY:""}};if("edit"!=this.options.type){if(this.options.pageSize<1||this.options.pageSize>100)this.options.pageSize=5;this.__log={a:0,b:0};var e=BX("crm-activity-email-details-"+this.options.activityId);var a=BX.findChildByClassName(e.parentNode,"crm-task-list-mail-more-a",true);BX.bind(a,"click",this.handleLogClick.bind(this,"a"));var o=BX.findChildByClassName(e.parentNode,"crm-task-list-mail-more-b",true);BX.bind(o,"click",this.handleLogClick.bind(this,"b"));var s=BX.findChildrenByClassName(e.parentNode,"crm-task-list-mail-item",true);for(var l in s){var r=s[l].getAttribute("data-log").toLowerCase();if(typeof this.__log[r]!="undefined")this.__log[r]++;BX.bind(s[l],"click",this.handleLogItemClick.bind(this,s[l].getAttribute("data-id")))}BX.Event.EventEmitter.subscribe("BXMailMessageActions:CRM_EXCLUDE",function(t){if(i.options.mailMessageId==t.getData().messageId){var e=top.BX.SidePanel.Instance.getSliderByWindow(window);e.setCacheable(false);e.close()}})}this.__inited=true};t.initScrollable=function(){if(!this.__scrollable){if(document.scrollingElement)this.__scrollable=document.scrollingElement}if(!this.__scrollable){if(document.documentElement.scrollTop>0||document.documentElement.scrollLeft>0)this.__scrollable=document.documentElement;else if(document.body.scrollTop>0||document.body.scrollLeft>0)this.__scrollable=document.body}if(!this.__scrollable){window.scrollBy(1,1);if(document.documentElement.scrollTop>0||document.documentElement.scrollLeft>0)this.__scrollable=document.documentElement;else if(document.body.scrollTop>0||document.body.scrollLeft>0)this.__scrollable=document.body;window.scrollBy(-1,-1)}return this.__scrollable};t.scrollWrapper=function(t){var i=this;if(!this.initScrollable())return;if(this.__scrollable.__animation){clearInterval(this.__scrollable.__animation);this.__scrollable.__animation=null}var e=this.__scrollable.scrollTop;var a=t-e;var o=0;this.__scrollable.__animation=setInterval(function(){o++;i.__scrollable.scrollTop=e+a*o/8;if(o>=8){clearInterval(i.__scrollable.__animation);i.__scrollable.__animation=null}},20)};t.scrollTo=function(t,i){if(!this.initScrollable())return;var e=BX.pos(this.__scrollable);e.top+=this.__scrollable.scrollTop;e.bottom+=this.__scrollable.scrollTop;var a=BX.pos(t);var o=typeof i=="undefined"||i===t?a:BX.pos(i);if(a.top<e.top){this.scrollWrapper(this.__scrollable.scrollTop-(e.top-a.top))}else if(o.bottom>e.bottom){this.scrollWrapper(Math.min(this.__scrollable.scrollTop-(e.top-a.top),this.__scrollable.scrollTop+(o.bottom-e.bottom)))}};t.handleLogClick=function(t,i){BX.PreventDefault(i);var e=BX.findChildByClassName(BX("crm-activity-email-details-"+this.options.activityId).parentNode,"crm-task-list-mail-more-"+t,true);this.loadLog(t,e)};t.loadLog=function(t,i){var e=this;var a=i.parentNode;if(this["__loadingLog"+t])return;this["__loadingLog"+t]=true;BX.ajax({method:"POST",url:this.options.ajaxUrl,data:{act:"log",id:this.options.activityId,log:t+this.__log[t],size:this.options.pageSize,template:"slider"},dataType:"json",onsuccess:function(i){e["__loadingLog"+t]=false;if(i.result!="error"){e.__dummyNode.innerHTML=i.html;var o=t=="a"?BX.findNextSibling(a,{tag:"div"}):a;while(e.__dummyNode.childNodes.length>0){var s=a.parentNode.insertBefore(e.__dummyNode.childNodes[0],o);if(s.nodeType==1&&BX.hasClass(s,"crm-task-list-mail-item")){e.__log[t]++;BX.addClass(s,"crm-activity-email-show-animation-rev");BX.bind(s,"click",e.handleLogItemClick.bind(e,s.getAttribute("data-id")))}}if(i.count<e.options.pageSize)a.style.display="none";if(t=="b")e.scrollWrapper(e.__scrollable.scrollHeight);e.__dummyNode.innerHTML=""}},onfailure:function(){e["__loadingLog"+t]=false}})};t.handleLogItemClick=function(t,i){i=i||window.event;if(i.target&&i.target.tagName&&i.target.tagName.toUpperCase()=="A")return;if(window.getSelection){if(window.getSelection().toString().trim()!="")return}else if(document.selection){if(document.selection.createRange().htmlText.trim()!="")return}BX.PreventDefault(i);this.toggleLogItem(t)};t.toggleLogItem=function(t){var i=this;var e=BX("crm-activity-email-details-"+this.options.activityId).parentNode;var a=BX.findChildByClassName(e,"crm-activity-email-logitem-"+t,false);var o=BX.findChildByClassName(e,"crm-activity-email-details-"+t,false);var s=BX.hasClass(a,"crm-task-list-mail-item-open");BX.toggleClass(a,"crm-task-list-mail-item-open");if(s){o.style.display="none";BX.addClass(a,"crm-activity-email-show-animation-rev");a.style.display=""}else{BX.removeClass(o,"crm-activity-email-show-animation-rev");BX.addClass(o,"crm-activity-email-show-animation");o.style.display="";if(o.getAttribute("data-empty")){BX.ajax({method:"POST",url:this.options.ajaxUrl,data:{act:"logitem",id:t,template:"slider"},dataType:"json",onsuccess:function(e){if(e.result=="error"){o.innerHTML=e.error;return}var s=BX.processHTML(e.html);BX.removeClass(o,"crm-activity-email-show-animation");BX.removeClass(o,"crm-activity-email-show-animation-rev");setTimeout(function(){o.style.textAlign="";o.innerHTML=s.HTML;if(o.offsetHeight>0)a.style.display="none";BX.ajax.processScripts(s.SCRIPT);BX.addClass(o,"crm-activity-email-show-animation-rev");var e=BX.findChildByClassName(o,"crm-task-list-mail-item-inner-header",true);BX.bind(e,"click",i.handleLogItemClick.bind(i,t));i.scrollTo(o)},10);o.removeAttribute("data-empty")}});this.scrollTo(a,o)}else{a.style.display="none";this.scrollTo(o)}}};t.removeLogItem=function(t){var i=BX("crm-activity-email-details-"+this.options.activityId).parentNode;var e=BX.findChildByClassName(i,"crm-activity-email-logitem-"+t,false);var a=BX.findChildByClassName(i,"crm-activity-email-details-"+t,false);var o=e.getAttribute("data-log").toLowerCase();if(typeof this.__log[o]!="undefined")this.__log[o]--;setTimeout(function(){i.removeChild(a);i.removeChild(e)},200);a.style.maxHeight=a.offsetHeight*1.5+"px";a.style.transition="max-height .2s ease-in";a.offsetHeight;a.style.maxHeight="0px";BX.removeClass(a,"crm-activity-email-show-animation");BX.removeClass(a,"crm-activity-email-show-animation-rev");BX.addClass(a,"crm-activity-email-close-animation")};t.applyTemplate=function(t,i,e,a){var o=this;var s=t>0?[t,i,e].join(":"):t;if(this.templates[s]){a(this.templates[s]);return}BX.ajax({url:"/bitrix/components/bitrix/crm.activity.editor/ajax.php?action=prepare_mail_template&templateid="+t,method:"POST",dataType:"json",data:{sessid:BX.bitrix_sessid(),ACTION:"PREPARE_MAIL_TEMPLATE",TEMPLATE_ID:t,OWNER_TYPE:i,OWNER_ID:e,CONTENT_TYPE:"HTML"},onsuccess:function(t){if(t.DATA){o.templates[s]=t.DATA;a(t.DATA)}}})};var i=function(e){var a=this;this.ctrl=t;this.options=e;for(var o in this.options.templates){if(!this.options.templates.hasOwnProperty(o))continue;if(!(this.ctrl.options.templates[o]&&this.ctrl.options.templates[o].length>0))this.ctrl.options.templates[o]=this.options.templates[o]}this.__dummyNode=document.createElement("DIV");this.htmlForm=BX(this.options.formId);this.htmlForm.__wrapper=this.htmlForm.parentNode;if(this.htmlForm.__inited)return;if("edit"!=this.ctrl.options.type){this.__wrapper=BX("crm-activity-email-details-"+this.ctrl.options.activityId);if(this.options.activityId!=this.ctrl.options.activityId)this.__wrapper=BX.findChildByClassName(this.__wrapper.parentNode,"crm-activity-email-details-"+this.options.activityId,false);BX.addCustomEvent("CrmActivityEmail:replyButtonClick",function(t){if(t!==a)a.hideReplyForm()});var s="activity_"+this.options.activityId+"_body";var l=typeof document.querySelectorAll!="undefined"?document.querySelectorAll("#"+s+" a"):BX.findChildren(BX(s),{tag:"a"},true);for(var r in l){if(!l.hasOwnProperty(r))continue;if(l[r]&&l[r].setAttribute)l[r].setAttribute("target","_blank")}var n=typeof document.querySelectorAll!="undefined"?document.querySelectorAll("#"+s+" blockquote"):BX.findChildren(BX(s),{tag:"blockquote"},true);for(var r in n){if(!n.hasOwnProperty(r))continue;BX.bind(n[r],"click",function(){BX.addClass(this,"crm-email-quote-unfolded")})}var m=BX.findChildrenByClassName(this.__wrapper,"crm-task-list-mail-item-to-list-more");for(var r in m){BX.bind(m[r],"click",function(t){BX.findChildByClassName(this.parentNode,"crm-task-list-mail-item-to-list-hidden",false).style.display="inline";this.style.display="none";BX.PreventDefault(t)})}BX.addCustomEvent("onPullEvent-crm",function(t,i){if(t!="activity_email_read_confirmed")return;if(i.ID!=a.options.activityId)return;var e=BX.findChildrenByClassName(a.__wrapper,"read-confirmed-datetime",true);if(e&&e.length>0){for(var o in e)BX.adjust(e[o],{text:BX.message("CRM_ACT_EMAIL_VIEW_READ_CONFIRMED_SHORT")})}});var c=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-message-panel",true);var d=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-reply",true);var h=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-answertoall",true);var p=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-resend",true);var _=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-skip",true);var u=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-spam",true);var f=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-delete",true);BX.bind(c,"click",this.showReplyForm.bind(this));BX.bind(h,"click",this.showReplyForm.bind(this));BX.bind(d,"click",this.showReplyForm.bind(this,true));BX.bind(p,"click",function(){var t=(BX.CrmActivityType||top.BX.CrmActivityType||{email:4}).email;window.location.href="/bitrix/components/bitrix/crm.activity.planner/slider.php"+"?site_id="+BX.message("SITE_ID")+"&ajax_action=ACTIVITY_EDIT"+"&TYPE_ID="+t+"&FROM_ACTIVITY_ID="+a.options.activityId+"&MESSAGE_TYPE=FWD&IFRAME=Y&IFRAME_TYPE=SIDE_SLIDER"});BX.bind(_,"click",this.delete.bind(this,"skip"));BX.bind(u,"click",this.delete.bind(this,"spam"));BX.bind(f,"click",this.delete.bind(this))}var v=BXMainMailForm.getForm(this.options.formId);BX.addCustomEvent(v,"MailForm:footer:buttonClick",i.handleFooterButtonClick.bind(this));BX.addCustomEvent(v,"MailForm:submit",i.handleFormSubmit.bind(this));BX.addCustomEvent(v,"MailForm:submit:ajaxSuccess",i.handleFormSubmitSuccess.bind(this));this.htmlForm.__inited=true};i.handleFooterButtonClick=function(t,i){if(BX.hasClass(i,"main-mail-form-cancel-button")){if("edit"==this.ctrl.options.type){top.BX.SidePanel.Instance.getSliderByWindow(window).close()}else{this.hideReplyForm()}}};i.handleFormSubmit=function(t,i){var e=this.htmlForm.elements;var a=true;for(var o=0;o<e.length;o++){if("DATA[to][]"==e[o].name&&e[o].value.length>0)a=false}if(a){t.showError(BX.message("CRM_ACT_EMAIL_REPLY_EMPTY_RCPT"));return BX.PreventDefault(i)}var s,l,r=0;for(var o in t.postForm.controllers){if(!t.postForm.controllers.hasOwnProperty(o))continue;if(t.postForm.controllers[o].storage!="disk")continue;try{s=0;s=t.postForm.controllers[o].handler.agent.upload.filesCount}catch(t){}if(s>0){t.showError(BX.message("CRM_ACT_EMAIL_REPLY_UPLOADING"));return BX.PreventDefault(i)}if(BX.message("CRM_ACT_EMAIL_MAX_SIZE")>0){try{l=t.postForm.controllers[o].handler.agent.queue.items.items;r=Object.keys(l).reduce(function(t,i){return t+(l[i].file?parseInt(l[i].file.sizeInt||l[i].file.size):0)},r)}catch(t){}}}if(BX.message("CRM_ACT_EMAIL_MAX_SIZE")>0&&BX.message("CRM_ACT_EMAIL_MAX_SIZE")<=Math.ceil(r/3)*4){t.showError(BX.message("CRM_ACT_EMAIL_MAX_SIZE_EXCEED"));return BX.PreventDefault(i)}if("edit"==this.ctrl.options.type){var n=BX("crm_act_email_create_hidden");n.innerHTML="";var e=BX.findChildren(document,{tag:"input"},true);for(var o=0,m;o<e.length;o++){if(e[o].name&&e[o].name.indexOf("__crm_activity_planner[")>=0){m=e[o].cloneNode(true);m.removeAttribute("id");m.setAttribute("name","DATA"+e[o].name.substr("__crm_activity_planner".length));n.appendChild(m)}}}};i.handleFormSubmitSuccess=function(t,i){if(i.ERROR&&i.ERROR.length>0||i.ERROR_HTML&&i.ERROR_HTML.length>0){i.ERROR=!i.ERROR?[]:i.ERROR;i.ERROR=!BX.type.isArray(i.ERROR)?[i.ERROR]:i.ERROR;var e=document.createElement("DIV");for(var a=0;a<i.ERROR.length;a++){e.appendChild(document.createTextNode(i.ERROR[a]));e.appendChild(document.createElement("BR"))}i.ERROR_HTML=!i.ERROR_HTML?[]:i.ERROR_HTML;i.ERROR_HTML=!BX.type.isArray(i.ERROR_HTML)?[i.ERROR_HTML]:i.ERROR_HTML;for(var o=0;o<i.ERROR_HTML.length;++o){e.innerHTML+=i.ERROR_HTML[a]+"<br>"}t.showError(e.innerHTML)}else{top.BX.onCustomEvent("Bitrix24.Slider:postMessage",[window,{action:"ACTIVITY_CREATE",source_id:this.ctrl.options.activityId,target_id:i.ACTIVITY.ID}]);if("edit"!=this.ctrl.options.type){this.hideReplyForm()}var s=top.BX.SidePanel.Instance.getSliderByWindow(window);s.setCacheable(false);s.close()}};i.prototype.showReplyForm=function(t){var i=BXMainMailForm.getForm(this.options.formId);var e=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-message-panel",true);if(this.htmlForm.parentNode===this.__dummyNode)this.htmlForm.__wrapper.appendChild(this.htmlForm);i.init();if(t===true){i.getField("DATA[to]").setValue(this.options.rcptSelected);i.getField("DATA[cc]").setValue()}else{i.getField("DATA[to]").setValue(this.options.rcptAllSelected);i.getField("DATA[cc]").setValue(this.options.rcptCcSelected)}i.getField("DATA[bcc]").setValue();BX.onCustomEvent("CrmActivityEmail:replyButtonClick",[this]);BX.addClass(this.htmlForm,"crm-activity-email-show-animation");this.htmlForm.style.display="";e.style.display="none";BX.onCustomEvent(i,"MailForm:show",[]);this.ctrl.scrollTo(this.htmlForm)};i.prototype.hideReplyForm=function(){var t=BXMainMailForm.getForm(this.options.formId);var i=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-message-panel",true);BX.addClass(i,"crm-activity-email-show-animation-rev");i.style.display="";this.htmlForm.style.display="none";BX.onCustomEvent(t,"MailForm:hide",[]);this.__dummyNode.appendChild(this.htmlForm)};i.prototype.delete=function(t){var i=this;var e="CRM_ACT_EMAIL_DELETE_CONFIRM";switch(t){case"skip":e="CRM_ACT_EMAIL_SKIP_CONFIRM";break;case"spam":e="CRM_ACT_EMAIL_SPAM_CONFIRM";break}if(!window.confirm(BX.message(e)))return false;var a=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-delete",true);var o={sessid:BX.bitrix_sessid(),ACTION:"DELETE",IS_SKIP:"skip"==t?"Y":"N",IS_SPAM:"spam"==t?"Y":"N",ITEM_ID:this.options.activityId};var s=BX.findChildren(a.parentNode,{tag:"input"},true);for(var l=0;l<s.length;l++){if(s[l].name)o[s[l].name]=s[l].value}BX.ajax({url:"/bitrix/components/bitrix/crm.activity.editor/ajax.php?id="+this.options.activityId+"&action=delete",method:"POST",dataType:"json",data:o,onsuccess:function(t){top.BX.onCustomEvent("Bitrix24.Slider:postMessage",[window,{action:"ACTIVITY_DELETE",source_id:i.ctrl.options.activityId,target_id:i.options.activityId}]);if(i.ctrl.options.activityId!=i.options.activityId){i.ctrl.removeLogItem(i.options.activityId)}else{var e=top.BX.SidePanel.Instance.getSliderByWindow(window);e.setCacheable(false);e.close()}}})};i.prototype.batch=function(t){var i=BXMainMailForm.getForm(this.options.formId);i.getField("DATA[cc]")[t?"hide":"show"]();i.getField("DATA[bcc]")[t?"hide":"show"]()};i.prototype.templateMenu=function(t,i,e){var a=this;var o=function(o,s){var l=BXMainMailForm.getForm(a.options.formId);a.ctrl.applyTemplate(s.__id,t,i,function(t){if(t.FROM&&t.FROM.length>0){var i=l.getField("DATA[from]");i.setValue(t.FROM);if(i.params.folded)i.unfold()}if(t.SUBJECT&&t.SUBJECT.length>0){var e=a.htmlForm.elements;var o=e["DATA[FORWARDED_ID]"]?e["DATA[FORWARDED_ID]"].value:0;var s=e["DATA[REPLIED_ID]"]?e["DATA[REPLIED_ID]"].value:0;if(!(o>0||s>0)){var r=l.getField("DATA[subject]");r.setValue(t.SUBJECT);if(r.params.folded)r.unfold()}}if(t.FILES&&t.FILES.length>0)l.getField("DATA[__diskfiles]").setValue(t.FILES);l.getField("DATA[message]").setValue(t.BODY,{quote:true,signature:true})});BX.adjust(e,{html:s.text});s.menuWindow.close()};var s=[];if(t!="")s=s.concat(this.ctrl.options.templates[t]||[]);s=s.concat(this.ctrl.options.templates[""]||[]);if(!(s.length>0))return;var l=[{__id:"0",text:BX.message("CRM_ACT_EMAIL_CREATE_NOTEMPLATE"),onclick:o},{delimiter:true}];for(var r in s){l.push({__id:s[r].id,text:BX.util.htmlspecialchars(s[r].title),onclick:o})}BX.PopupMenu.show("crm-activity-email-"+this.options.activityId+"-template-menu",e,l,{offsetLeft:40,angle:true,closeByEsc:true})};window.BXCrmActivityEmailController=t;window.BXCrmActivityEmail=i})();
//# sourceMappingURL=script.map.js