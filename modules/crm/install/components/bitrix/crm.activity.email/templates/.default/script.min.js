(function(){if(window.BXCrmActivityEmailController)return;var t={};t.init=function(t){var e=this;if(this.__inited)return;this.options=t;this.__dummyNode=document.createElement("DIV");this.templates={0:{FROM:"",SUBJECT:"",BODY:""}};this.templateLoader=new BX.Loader({target:document.querySelector(".crm-activity-planner-slider-header-control-select"),size:20,mode:"inline",offset:{left:"4%",top:"-2%"}});if("edit"!=this.options.type){if(this.options.pageSize<1||this.options.pageSize>100)this.options.pageSize=5;this.__log={a:0,b:0};var i=BX("crm-activity-email-details-"+this.options.activityId);var s=BX.findChildByClassName(i.parentNode,"crm-task-list-mail-more-a",true);BX.bind(s,"click",this.handleLogClick.bind(this,"a"));var o=BX.findChildByClassName(i.parentNode,"crm-task-list-mail-more-b",true);BX.bind(o,"click",this.handleLogClick.bind(this,"b"));var a=BX.findChildrenByClassName(i.parentNode,"crm-task-list-mail-item",true);for(var n in a){var l=a[n].getAttribute("data-log").toLowerCase();if(typeof this.__log[l]!="undefined")this.__log[l]++;BX.bind(a[n],"click",this.handleLogItemClick.bind(this,a[n].getAttribute("data-id")))}BX.Event.EventEmitter.subscribe("BXMailMessageActions:CRM_EXCLUDE",(function(t){if(e.options.mailMessageId==t.getData().messageId){var i=top.BX.SidePanel.Instance.getSliderByWindow(window);i.setCacheable(false);i.close()}}))}this.__inited=true};t.initScrollable=function(){if(!this.__scrollable){if(document.scrollingElement)this.__scrollable=document.scrollingElement}if(!this.__scrollable){if(document.documentElement.scrollTop>0||document.documentElement.scrollLeft>0)this.__scrollable=document.documentElement;else if(document.body.scrollTop>0||document.body.scrollLeft>0)this.__scrollable=document.body}if(!this.__scrollable){window.scrollBy(1,1);if(document.documentElement.scrollTop>0||document.documentElement.scrollLeft>0)this.__scrollable=document.documentElement;else if(document.body.scrollTop>0||document.body.scrollLeft>0)this.__scrollable=document.body;window.scrollBy(-1,-1)}return this.__scrollable};t.scrollWrapper=function(t){var e=this;if(!this.initScrollable())return;if(this.__scrollable.__animation){clearInterval(this.__scrollable.__animation);this.__scrollable.__animation=null}var i=this.__scrollable.scrollTop;var s=t-i;var o=0;this.__scrollable.__animation=setInterval((function(){o++;e.__scrollable.scrollTop=i+s*o/8;if(o>=8){clearInterval(e.__scrollable.__animation);e.__scrollable.__animation=null}}),20)};t.scrollTo=function(t,e){if(!this.initScrollable())return;var i=BX.pos(this.__scrollable);i.top+=this.__scrollable.scrollTop;i.bottom+=this.__scrollable.scrollTop;var s=BX.pos(t);var o=typeof e=="undefined"||e===t?s:BX.pos(e);if(s.top<i.top){this.scrollWrapper(this.__scrollable.scrollTop-(i.top-s.top))}else if(o.bottom>i.bottom){this.scrollWrapper(Math.min(this.__scrollable.scrollTop-(i.top-s.top),this.__scrollable.scrollTop+(o.bottom-i.bottom)))}};t.handleLogClick=function(t,e){BX.PreventDefault(e);var i=BX.findChildByClassName(BX("crm-activity-email-details-"+this.options.activityId).parentNode,"crm-task-list-mail-more-"+t,true);this.loadLog(t,i)};t.loadLog=function(t,e){var i=this;var s=e.parentNode;if(this["__loadingLog"+t])return;this["__loadingLog"+t]=true;BX.ajax({method:"POST",url:this.options.ajaxUrl,data:{act:"log",id:this.options.activityId,log:t+this.__log[t],size:this.options.pageSize,template:"slider"},dataType:"json",onsuccess:function(e){i["__loadingLog"+t]=false;if(e.result!="error"){i.__dummyNode.innerHTML=e.html;var o=t=="a"?BX.findNextSibling(s,{tag:"div"}):s;while(i.__dummyNode.childNodes.length>0){var a=s.parentNode.insertBefore(i.__dummyNode.childNodes[0],o);if(a.nodeType==1&&BX.hasClass(a,"crm-task-list-mail-item")){i.__log[t]++;BX.addClass(a,"crm-activity-email-show-animation-rev");BX.bind(a,"click",i.handleLogItemClick.bind(i,a.getAttribute("data-id")))}}if(e.count<i.options.pageSize)s.style.display="none";if(t=="b")i.scrollWrapper(i.__scrollable.scrollHeight);i.__dummyNode.innerHTML=""}},onfailure:function(){i["__loadingLog"+t]=false}})};t.handleLogItemClick=function(t,e){e=e||window.event;if(e.target&&e.target.tagName&&e.target.tagName.toUpperCase()=="A")return;if(window.getSelection){if(window.getSelection().toString().trim()!="")return}else if(document.selection){if(document.selection.createRange().htmlText.trim()!="")return}BX.PreventDefault(e);this.toggleLogItem(t)};t.toggleLogItem=function(t){var e=this;var i=BX("crm-activity-email-details-"+this.options.activityId).parentNode;var s=BX.findChildByClassName(i,"crm-activity-email-logitem-"+t,false);var o=BX.findChildByClassName(i,"crm-activity-email-details-"+t,false);var a=BX.hasClass(s,"crm-task-list-mail-item-open");BX.toggleClass(s,"crm-task-list-mail-item-open");if(a){o.style.display="none";BX.addClass(s,"crm-activity-email-show-animation-rev");s.style.display=""}else{BX.removeClass(o,"crm-activity-email-show-animation-rev");BX.addClass(o,"crm-activity-email-show-animation");o.style.display="";if(o.getAttribute("data-empty")){BX.ajax({method:"POST",url:this.options.ajaxUrl,data:{act:"logitem",id:t,template:"slider"},dataType:"json",onsuccess:function(i){if(i.result=="error"){o.innerHTML=i.error;return}var a=BX.processHTML(i.html);BX.removeClass(o,"crm-activity-email-show-animation");BX.removeClass(o,"crm-activity-email-show-animation-rev");setTimeout((function(){o.style.textAlign="";o.innerHTML=a.HTML;if(o.offsetHeight>0)s.style.display="none";BX.ajax.processScripts(a.SCRIPT);BX.addClass(o,"crm-activity-email-show-animation-rev");var i=BX.findChildByClassName(o,"crm-task-list-mail-item-inner-header",true);BX.bind(i,"click",e.handleLogItemClick.bind(e,t));e.scrollTo(o)}),10);o.removeAttribute("data-empty")}});this.scrollTo(s,o)}else{s.style.display="none";this.scrollTo(o)}}};t.removeLogItem=function(t){var e=BX("crm-activity-email-details-"+this.options.activityId).parentNode;var i=BX.findChildByClassName(e,"crm-activity-email-logitem-"+t,false);var s=BX.findChildByClassName(e,"crm-activity-email-details-"+t,false);var o=i.getAttribute("data-log").toLowerCase();if(typeof this.__log[o]!="undefined")this.__log[o]--;setTimeout((function(){e.removeChild(s);e.removeChild(i)}),200);s.style.maxHeight=s.offsetHeight*1.5+"px";s.style.transition="max-height .2s ease-in";s.offsetHeight;s.style.maxHeight="0px";BX.removeClass(s,"crm-activity-email-show-animation");BX.removeClass(s,"crm-activity-email-show-animation-rev");BX.addClass(s,"crm-activity-email-close-animation")};t.applyTemplate=function(t,e,i,s){var o=this;var a=t>0?[t,e,i].join(":"):t;if(this.templates[a]){s(this.templates[a]);return}BX.ajax({url:"/bitrix/components/bitrix/crm.activity.editor/ajax.php?action=prepare_mail_template&templateid="+t,method:"POST",dataType:"json",data:{sessid:BX.bitrix_sessid(),ACTION:"PREPARE_MAIL_TEMPLATE",TEMPLATE_ID:t,OWNER_TYPE:e,OWNER_ID:i,CONTENT_TYPE:"HTML"},onsuccess:function(t){if(t.DATA){o.templates[a]=t.DATA;s(t.DATA)}}})};var e=function(i){var s=this;this.ctrl=t;this.options=i;this.progressPercent=0;if(!(this.ctrl.options.templates&&this.ctrl.options.templates.length>0)){this.ctrl.options.templates=this.options.templates}this.__dummyNode=document.createElement("DIV");this.htmlForm=BX(this.options.formId);this.htmlForm.__wrapper=this.htmlForm.parentNode;if(this.htmlForm.__inited)return;if("edit"!=this.ctrl.options.type){this.__wrapper=BX("crm-activity-email-details-"+this.ctrl.options.activityId);if(this.options.activityId!=this.ctrl.options.activityId)this.__wrapper=BX.findChildByClassName(this.__wrapper.parentNode,"crm-activity-email-details-"+this.options.activityId,false);BX.addCustomEvent("CrmActivityEmail:replyButtonClick",(function(t){if(t!==s)s.hideReplyForm()}));this.initMessageBody();var o=BX.findChildrenByClassName(this.__wrapper,"crm-task-list-mail-item-to-list-more");for(var a in o){BX.bind(o[a],"click",(function(t){BX.findChildByClassName(this.parentNode,"crm-task-list-mail-item-to-list-hidden",false).style.display="inline";this.style.display="none";BX.PreventDefault(t)}))}BX.addCustomEvent("onPullEvent-crm",(function(t,e){if(t!="activity_email_read_confirmed")return;if(e.ID!=s.options.activityId)return;var i=BX.findChildrenByClassName(s.__wrapper,"read-confirmed-datetime",true);if(i&&i.length>0){for(var o in i)BX.adjust(i[o],{text:BX.message("CRM_ACT_EMAIL_VIEW_READ_CONFIRMED_SHORT")})}}));var n=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-message-panel",true);var l=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-reply",true);var r=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-answertoall",true);var c=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-resend",true);var m=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-skip",true);var d=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-spam",true);var p=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-delete",true);BX.bind(n,"click",this.showReplyForm.bind(this));BX.bind(r,"click",this.showReplyForm.bind(this,true));BX.bind(l,"click",this.showReplyForm.bind(this));BX.bind(c,"click",(function(){var t=(BX.CrmActivityType||top.BX.CrmActivityType||{email:4}).email;window.location.href="/bitrix/components/bitrix/crm.activity.planner/slider.php"+"?site_id="+BX.message("SITE_ID")+"&ajax_action=ACTIVITY_EDIT"+"&TYPE_ID="+t+"&FROM_ACTIVITY_ID="+s.options.activityId+"&MESSAGE_TYPE=FWD&IFRAME=Y&IFRAME_TYPE=SIDE_SLIDER"}));BX.bind(m,"click",this.delete.bind(this,"skip"));BX.bind(d,"click",this.delete.bind(this,"spam"));BX.bind(p,"click",this.delete.bind(this));if(i.isAjaxBody&&i.bodyElementId){this.ajaxLoadMessageBody()}}var h=BXMainMailForm.getForm(this.options.formId);h.options.ownerId=this.ctrl.options.ownerId;h.options.ownerType=this.ctrl.options.ownerType;BX.addCustomEvent(h,"MailForm:footer:buttonClick",e.handleFooterButtonClick.bind(this));BX.addCustomEvent(h,"MailForm:submit",e.handleFormSubmit.bind(this));BX.addCustomEvent(h,"MailForm:submit:ajaxSuccess",e.handleFormSubmitSuccess.bind(this));this.htmlForm.__inited=true};e.prototype.initMessageBody=function(){var t="activity_"+this.options.activityId+"_body";i(t);s(t)};function i(t){const e=typeof document.querySelectorAll!="undefined"?document.querySelectorAll("#"+t+" a"):BX.findChildren(BX(t),{tag:"a"},true);for(const t in e){if(!e.hasOwnProperty(t))continue;if(e[t]&&e[t].setAttribute)e[t].setAttribute("target","_blank")}}function s(t){const e=typeof document.querySelectorAll!="undefined"?document.querySelectorAll("#"+t+" blockquote"):BX.findChildren(BX(t),{tag:"blockquote"},true);for(const t in e){if(!e.hasOwnProperty(t))continue;BX.bind(e[t],"click",(function(){BX.addClass(this,"crm-email-quote-unfolded")}))}}e.handleFooterButtonClick=function(t,e){if(BX.hasClass(e,"main-mail-form-cancel-button")){if("edit"==this.ctrl.options.type){top.BX.SidePanel.Instance.getSliderByWindow(window).close()}else{this.hideReplyForm()}}};e.handleFormSubmit=function(t,e){var i=this.htmlForm.elements;var s=true;for(var o=0;o<i.length;o++){if("DATA[to][]"==i[o].name&&i[o].value.length>0)s=false}if(s){t.showError(BX.message("CRM_ACT_EMAIL_REPLY_EMPTY_RCPT"));return BX.PreventDefault(e)}var a,n,l=0;for(var o in t.postForm.controllers){if(!t.postForm.controllers.hasOwnProperty(o))continue;if(t.postForm.controllers[o].storage!="disk")continue;try{a=0;a=t.postForm.controllers[o].handler.agent.upload.filesCount}catch(t){}if(a>0){t.showError(BX.message("CRM_ACT_EMAIL_REPLY_UPLOADING"));return BX.PreventDefault(e)}if(BX.message("CRM_ACT_EMAIL_MAX_SIZE")>0){try{n=t.postForm.controllers[o].handler.agent.queue.items.items;l=Object.keys(n).reduce((function(t,e){return t+(n[e].file?parseInt(n[e].file.sizeInt||n[e].file.size):0)}),l)}catch(t){}}}if(BX.message("CRM_ACT_EMAIL_MAX_SIZE")>0&&BX.message("CRM_ACT_EMAIL_MAX_SIZE")<=Math.ceil(l/3)*4){t.showError(BX.message("CRM_ACT_EMAIL_MAX_SIZE_EXCEED"));return BX.PreventDefault(e)}if("edit"==this.ctrl.options.type){var r=BX("crm_act_email_create_hidden");r.innerHTML="";var i=BX.findChildren(document,{tag:"input"},true);for(var o=0,c;o<i.length;o++){if(i[o].name&&i[o].name.indexOf("__crm_activity_planner[")>=0){c=i[o].cloneNode(true);c.removeAttribute("id");c.setAttribute("name","DATA"+i[o].name.substr("__crm_activity_planner".length));r.appendChild(c)}}}};e.handleFormSubmitSuccess=function(t,e){if(e.ERROR&&e.ERROR.length>0||e.ERROR_HTML&&e.ERROR_HTML.length>0){e.ERROR=!e.ERROR?[]:e.ERROR;e.ERROR=!BX.type.isArray(e.ERROR)?[e.ERROR]:e.ERROR;var i=document.createElement("DIV");for(var s=0;s<e.ERROR.length;s++){i.appendChild(document.createTextNode(e.ERROR[s]));i.appendChild(document.createElement("BR"))}e.ERROR_HTML=!e.ERROR_HTML?[]:e.ERROR_HTML;e.ERROR_HTML=!BX.type.isArray(e.ERROR_HTML)?[e.ERROR_HTML]:e.ERROR_HTML;for(var o=0;o<e.ERROR_HTML.length;++o){i.innerHTML+=e.ERROR_HTML[s]+"<br>"}t.showError(i.innerHTML)}else{top.BX.onCustomEvent("Bitrix24.Slider:postMessage",[window,{action:"ACTIVITY_CREATE",source_id:this.ctrl.options.activityId,target_id:e.ACTIVITY.ID}]);if("edit"!=this.ctrl.options.type){this.hideReplyForm()}var a=top.BX.SidePanel.Instance.getSliderByWindow(window);a.setCacheable(false);a.close()}};e.prototype.showReplyForm=function(t){var e=BXMainMailForm.getForm(this.options.formId);var i=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-message-panel",true);if(this.htmlForm.parentNode===this.__dummyNode)this.htmlForm.__wrapper.appendChild(this.htmlForm);var s=e.init({isReplyAll:t});if(s===false){if(t===true){e.fillFieldsForReplyAll()}else{e.fillFieldsForReply()}}BX.onCustomEvent("CrmActivityEmail:replyButtonClick",[this]);BX.addClass(this.htmlForm,"crm-activity-email-show-animation");this.htmlForm.style.display="";i.style.display="none";BX.onCustomEvent(e,"MailForm:show",[]);this.ctrl.scrollTo(this.htmlForm)};e.prototype.hideReplyForm=function(){var t=BXMainMailForm.getForm(this.options.formId);var e=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-message-panel",true);BX.addClass(e,"crm-activity-email-show-animation-rev");e.style.display="";this.htmlForm.style.display="none";BX.onCustomEvent(t,"MailForm:hide",[]);this.__dummyNode.appendChild(this.htmlForm)};e.prototype.delete=function(t){var e=this;var i="CRM_ACT_EMAIL_DELETE_CONFIRM";switch(t){case"skip":i="CRM_ACT_EMAIL_SKIP_CONFIRM";break;case"spam":i="CRM_ACT_EMAIL_SPAM_CONFIRM";break}if(!window.confirm(BX.message(i)))return false;var s=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-delete",true);var o={sessid:BX.bitrix_sessid(),ACTION:"DELETE",IS_SKIP:"skip"==t?"Y":"N",IS_SPAM:"spam"==t?"Y":"N",ITEM_ID:this.options.activityId};var a=BX.findChildren(s.parentNode,{tag:"input"},true);for(var n=0;n<a.length;n++){if(a[n].name)o[a[n].name]=a[n].value}BX.ajax({url:"/bitrix/components/bitrix/crm.activity.editor/ajax.php?id="+this.options.activityId+"&action=delete",method:"POST",dataType:"json",data:o,onsuccess:function(t){top.BX.onCustomEvent("Bitrix24.Slider:postMessage",[window,{action:"ACTIVITY_DELETE",source_id:e.ctrl.options.activityId,target_id:e.options.activityId}]);if(e.ctrl.options.activityId!=e.options.activityId){e.ctrl.removeLogItem(e.options.activityId)}else{var i=top.BX.SidePanel.Instance.getSliderByWindow(window);i.setCacheable(false);i.close()}}})};e.prototype.batch=function(t){var e=BXMainMailForm.getForm(this.options.formId);e.getField("DATA[cc]")[t?"hide":"show"]();e.getField("DATA[bcc]")[t?"hide":"show"]()};e.prototype.activateTemplate=function(t,e,i,s,a,n){var l=BXMainMailForm.getForm(i);var r=this;r.ctrl.templateLoader.show();r.ctrl.applyTemplate(e.__id,s,a,(function(t){r.hasTemplateSignature=false;if(t.FROM&&t.FROM.length>0){var e=l.getField("DATA[from]");e.setValue(t.FROM);if(e.params.folded)e.unfold()}const i=r.htmlForm.elements;const s=i["DATA[FORWARDED_ID]"]?i["DATA[FORWARDED_ID]"].value:0;const a=i["DATA[REPLIED_ID]"]?i["DATA[REPLIED_ID]"].value:0;if(!(s>0||a>0)){const e=l.getField("DATA[subject]");e.setValue(t.SUBJECT??"");if(e.params.folded){e.unfold()}}const n=t.FILES_INFO&&t.FILES_INFO.length>0?t.FILES_INFO:[];l.getField("DATA[__diskfiles]").setValue(n);let c=t.BODY&&t.BODY.length>0?`<div>${t.BODY}</div>`:"<br>";c=o(r,c,l.formId,l.signatureNodeId);if(l.sharingLinkNodeClass){c=l.updateSharingLinkNode(c,r.options.calendarLink)}l.getField("DATA[message]").setValue(c,{quote:true,signature:!r.hasTemplateSignature,filesInfo:n});r.ctrl.templateLoader.hide();const m=l.editor.selection.GetRange();const d=l.editor.GetIframeDoc().body.firstChild;const p=d.tagName;if(p==="BR"){return}if(p==="DIV"&&d.firstChild){m.setStartBefore(d.firstChild);m.setStartBefore(d.firstChild);l.editor.selection.SetSelection(m);return}m.setStartBefore(d);m.setStartBefore(d);l.editor.selection.SetSelection(m)}));BX.adjust(n,{html:e.text});if(e.menuWindow){e.menuWindow.close()}};const o=function(t,e,i,s){const o='"main_mail_form+\\w+_signature_+\\w+"';const a=new RegExp(o,"gi");if(a.test(e)){t.hasTemplateSignature=true;return e.replace(a,`"${s}"`)}return e};e.prototype.templateMenu=function(t,e,i){var s=this;const o=[];if(this.ctrl.options.templates){this.ctrl.options.templates.forEach((e=>{if(e.entityType===t||e.entityType===""){o.push(e)}}))}const a="lenta-sort-item-selected";let n="save-last-template-toggle lenta-sort-item";if(this.ctrl.options.saveLastUsedTemplate==="Y"){n+=" "+a}this.classSeparator="main-buttons-submenu-delimiter";this.classHiddenLabel="main-buttons-hidden-label";this.classSubmenuItem="main-buttons-submenu-item";const l=[];const r=BX("crm_act_email_create_last_used_template_id");if(this.ctrl.options.isEnabledSavingLastUsedTemplate==="Y"){l.push({delimiter:true,html:"<span>"+BX.message("CRM_ACT_EMAIL_TEMPLATE_SETTINGS_TITLE")+"</span>",className:[this.classSeparator,this.classSubmenuItem,this.classHiddenLabel].join(" ")},{text:BX.message("CRM_ACT_EMAIL_TEMPLATE_SAVE_LAST_TEMPLATE"),className:n,onclick:function(t,e){const i=e.getContainer();if(i.classList.contains(a)){BX.removeClass(i,a)}else{BX.addClass(i,a)}BX.ajax.runAction("crm.api.mail.MailTemplate.toggleSaveLastUsedTemplate")}},{text:BX.message("CRM_ACT_EMAIL_TEMPLATE_SETTINGS"),className:"lenta-sort-item",onclick:function(t){BX.SidePanel.Instance.open("/crm/configs/mailtemplate/",{cacheable:false,width:1080,events:{onOpen(){BX.PopupMenu.getCurrentMenu().close()},onClose(){s.ctrl.templateLoader.show();BX.ajax.runAction("crm.api.mail.MailTemplate.getTitleList",{data:{ownerTypeId:s.ctrl.options.activityOwnerTypeId}}).then((t=>{const e=t.data;BX.PopupMenu.getCurrentMenu().destroy();s.ctrl.templates={0:{FROM:"",SUBJECT:"",BODY:""}};s.ctrl.options.templates=e;s.ctrl.templateLoader.hide()}))}}})}},{delimiter:true,html:"<span>"+BX.message("CRM_ACT_EMAIL_TEMPLATE_LIST_TITLE")+"</span>",className:[this.classSeparator,this.classSubmenuItem,this.classHiddenLabel].join(" ")})}l.push({__id:0,text:BX.message("CRM_ACT_EMAIL_CREATE_NOTEMPLATE"),className:"menu-popup-no-icon",onclick:function(o,a){this.activateTemplate(null,a,s.options.formId,t,e,i);if(r){BX.adjust(r,{props:{value:0}})}}.bind(this)});for(var c in o){l.push({__id:o[c].id,text:BX.util.htmlspecialchars(o[c].title),title:BX.util.htmlspecialchars(o[c].title),className:"menu-popup-no-icon",onclick:function(o,a){if(r){BX.adjust(r,{props:{value:a.__id}})}this.activateTemplate(null,a,s.options.formId,t,e,i)}.bind(this)})}BX.PopupMenu.show("crm-activity-email-"+this.options.activityId+"-template-menu",i,l,{maxWidth:300,maxHeight:600,offsetLeft:40,angle:true,closeByEsc:true,events:{onPopupShow:function(){BX.Event.EventEmitter.emit(this,"CrmActivityEmail::onShowTemplatesList",{target:".save-last-template-toggle",stepId:"step-save-last-used-template"})}.bind(this)}})};e.prototype.ajaxLoadMessageBody=function(){const t=this.options.activityId;if(!t){return}this.bindErrorClose();this.startProgressTimer();BX.ajax.runAction("bitrix:crm.mail.message.getDescriptionAndQuote",{data:{id:t}}).then((t=>{if(BX.type.isNotEmptyObject(t.data)){this.handleSuccessResponse(t.data)}else{this.handleFailedResponse()}}),(()=>{this.handleFailedResponse()}))};e.prototype.handleSuccessResponse=function(t){this.stopProgress();if(BX.type.isNotEmptyObject(t)&&BX.type.isString(t.descriptionHtml)){this.insertBodyText(t.descriptionHtml);if(BX.type.isString(t.quote)){this.insertQuoteText(t.quote)}}a(this.options.warningWaitElementId);this.showControls()};e.prototype.insertQuoteText=function(t){const e=this.options;if(BX.type.isString(t)&&BX.type.isString(e.formId)&&BX.type.isString(e.formQuoteFieldName)&&BX.type.isObject(BXMainMailForm)&&BX.type.isObject(BXMainMailForm.getForm(e.formId))&&BX.type.isArray(BXMainMailForm.getForm(e.formId).fields)){const i=BXMainMailForm.getForm(e.formId).fields;for(const s in i){if(i.hasOwnProperty(s)){if(BX.type.isObject(i[s])&&i[s].name===e.formQuoteFieldName){i[s].value=t;break}}}}};e.prototype.insertBodyText=function(t){const e=document.getElementById(this.options.bodyElementId);if(e){e.innerHTML=t;this.initMessageBody()}};e.prototype.showError=function(){a(this.options.warningWaitElementId);n(this.options.warningFailElementId)};e.prototype.startProgressTimer=function(){const t=this.options;if(!t.bodyLoaderElementId||!t.bodyLoaderMaxTime){return}const e=document.getElementById(t.bodyLoaderElementId);if(!e){return}const i=new BX.UI.ProgressBar({maxValue:100,value:0});i.renderTo(BX(t.bodyLoaderElementId));const s=t.bodyLoaderMaxTime/100*1e3;this.progressInterval=setInterval((()=>{if(this.progressPercent>=100){this.stopProgress();this.progressPercent=100}else{this.progressPercent+=1}i.setValue(this.progressPercent);i.update()}),s)};e.prototype.stopProgress=function(){clearInterval(this.progressInterval)};e.prototype.handleFailedResponse=function(){this.stopProgress();this.showError();this.showControls()};e.prototype.showControls=function(){n(this.options.controlElementId);n(this.options.replyElementId)};e.prototype.bindErrorClose=function(){if(!this.options.warningFailElementId){return}const t=document.getElementById(this.options.warningFailElementId);if(!t){return}const e=t.querySelector(".ui-alert-close-btn");if(!e){return}BX.bind(e,"click",(function(){BX.hide(t)}))};function a(t){if(t){const e=document.getElementById(t);if(e){BX.hide(e)}}}function n(t){if(t){const e=document.getElementById(t);if(e&&e.style&&e.style.display==="none"){e.style.display=""}}}window.BXCrmActivityEmailController=t;window.BXCrmActivityEmail=e})();
//# sourceMappingURL=script.map.js