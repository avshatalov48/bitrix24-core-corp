(function(){if(window.BXCrmActivityEmailController)return;var t={};t.init=function(t){if(this.__inited)return;this.options=t;if(!BX.type.isPlainObject(this.options.templates))this.options.templates={};this.__dummyNode=document.createElement("DIV");this.templates={0:{FROM:"",SUBJECT:"",BODY:""}};if("edit"!=this.options.type){if(this.options.pageSize<1||this.options.pageSize>100)this.options.pageSize=5;this.__log={a:0,b:0};var i=BX("crm-activity-email-details-"+this.options.activityId);var e=BX.findChildByClassName(i.parentNode,"crm-task-list-mail-more-a",true);BX.bind(e,"click",this.handleLogClick.bind(this,"a"));var o=BX.findChildByClassName(i.parentNode,"crm-task-list-mail-more-b",true);BX.bind(o,"click",this.handleLogClick.bind(this,"b"));var a=BX.findChildrenByClassName(i.parentNode,"crm-task-list-mail-item",true);for(var l in a){var s=a[l].getAttribute("data-log").toLowerCase();if(typeof this.__log[s]!="undefined")this.__log[s]++;BX.bind(a[l],"click",this.handleLogItemClick.bind(this,a[l].getAttribute("data-id")))}}this.__inited=true};t.initScrollable=function(){if(!this.__scrollable){if(document.scrollingElement)this.__scrollable=document.scrollingElement}if(!this.__scrollable){if(document.documentElement.scrollTop>0||document.documentElement.scrollLeft>0)this.__scrollable=document.documentElement;else if(document.body.scrollTop>0||document.body.scrollLeft>0)this.__scrollable=document.body}if(!this.__scrollable){window.scrollBy(1,1);if(document.documentElement.scrollTop>0||document.documentElement.scrollLeft>0)this.__scrollable=document.documentElement;else if(document.body.scrollTop>0||document.body.scrollLeft>0)this.__scrollable=document.body;window.scrollBy(-1,-1)}return this.__scrollable};t.scrollWrapper=function(t){var i=this;if(!this.initScrollable())return;if(this.__scrollable.__animation){clearInterval(this.__scrollable.__animation);this.__scrollable.__animation=null}var e=this.__scrollable.scrollTop;var o=t-e;var a=0;this.__scrollable.__animation=setInterval(function(){a++;i.__scrollable.scrollTop=e+o*a/8;if(a>=8){clearInterval(i.__scrollable.__animation);i.__scrollable.__animation=null}},20)};t.scrollTo=function(t,i){if(!this.initScrollable())return;var e=BX.pos(this.__scrollable);e.top+=this.__scrollable.scrollTop;e.bottom+=this.__scrollable.scrollTop;var o=BX.pos(t);var a=typeof i=="undefined"||i===t?o:BX.pos(i);if(o.top<e.top){this.scrollWrapper(this.__scrollable.scrollTop-(e.top-o.top))}else if(a.bottom>e.bottom){this.scrollWrapper(Math.min(this.__scrollable.scrollTop-(e.top-o.top),this.__scrollable.scrollTop+(a.bottom-e.bottom)))}};t.handleLogClick=function(t,i){BX.PreventDefault(i);var e=BX.findChildByClassName(BX("crm-activity-email-details-"+this.options.activityId).parentNode,"crm-task-list-mail-more-"+t,true);this.loadLog(t,e)};t.loadLog=function(t,i){var e=this;var o=i.parentNode;if(this["__loadingLog"+t])return;this["__loadingLog"+t]=true;BX.ajax({method:"POST",url:this.options.ajaxUrl,data:{act:"log",id:this.options.activityId,log:t+this.__log[t],size:this.options.pageSize,template:"slider"},dataType:"json",onsuccess:function(i){e["__loadingLog"+t]=false;if(i.result!="error"){e.__dummyNode.innerHTML=i.html;var a=t=="a"?BX.findNextSibling(o,{tag:"div"}):o;while(e.__dummyNode.childNodes.length>0){var l=o.parentNode.insertBefore(e.__dummyNode.childNodes[0],a);if(l.nodeType==1&&BX.hasClass(l,"crm-task-list-mail-item")){e.__log[t]++;BX.addClass(l,"crm-activity-email-show-animation-rev");BX.bind(l,"click",e.handleLogItemClick.bind(e,l.getAttribute("data-id")))}}if(i.count<e.options.pageSize)o.style.display="none";if(t=="b")e.scrollWrapper(e.__scrollable.scrollHeight);e.__dummyNode.innerHTML=""}},onfailure:function(){e["__loadingLog"+t]=false}})};t.handleLogItemClick=function(t,i){i=i||window.event;if(i.target&&i.target.tagName&&i.target.tagName.toUpperCase()=="A")return;if(window.getSelection){if(window.getSelection().toString().trim()!="")return}else if(document.selection){if(document.selection.createRange().htmlText.trim()!="")return}BX.PreventDefault(i);this.toggleLogItem(t)};t.toggleLogItem=function(t){var i=this;var e=BX("crm-activity-email-details-"+this.options.activityId).parentNode;var o=BX.findChildByClassName(e,"crm-activity-email-logitem-"+t,false);var a=BX.findChildByClassName(e,"crm-activity-email-details-"+t,false);var l=BX.hasClass(o,"crm-task-list-mail-item-open");BX.toggleClass(o,"crm-task-list-mail-item-open");if(l){a.style.display="none";BX.addClass(o,"crm-activity-email-show-animation-rev");o.style.display=""}else{BX.removeClass(a,"crm-activity-email-show-animation-rev");BX.addClass(a,"crm-activity-email-show-animation");a.style.display="";if(a.getAttribute("data-empty")){BX.ajax({method:"POST",url:this.options.ajaxUrl,data:{act:"logitem",id:t,template:"slider"},dataType:"json",onsuccess:function(e){if(e.result=="error"){a.innerHTML=e.error;return}var l=BX.processHTML(e.html);BX.removeClass(a,"crm-activity-email-show-animation");BX.removeClass(a,"crm-activity-email-show-animation-rev");setTimeout(function(){a.style.textAlign="";a.innerHTML=l.HTML;if(a.offsetHeight>0)o.style.display="none";BX.ajax.processScripts(l.SCRIPT);BX.addClass(a,"crm-activity-email-show-animation-rev");var e=BX.findChildByClassName(a,"crm-task-list-mail-item-inner-header",true);BX.bind(e,"click",i.handleLogItemClick.bind(i,t));i.scrollTo(a)},10);a.removeAttribute("data-empty")}});this.scrollTo(o,a)}else{o.style.display="none";this.scrollTo(a)}}};t.removeLogItem=function(t){var i=BX("crm-activity-email-details-"+this.options.activityId).parentNode;var e=BX.findChildByClassName(i,"crm-activity-email-logitem-"+t,false);var o=BX.findChildByClassName(i,"crm-activity-email-details-"+t,false);var a=e.getAttribute("data-log").toLowerCase();if(typeof this.__log[a]!="undefined")this.__log[a]--;setTimeout(function(){i.removeChild(o);i.removeChild(e)},200);o.style.maxHeight=o.offsetHeight*1.5+"px";o.style.transition="max-height .2s ease-in";o.offsetHeight;o.style.maxHeight="0px";BX.removeClass(o,"crm-activity-email-show-animation");BX.removeClass(o,"crm-activity-email-show-animation-rev");BX.addClass(o,"crm-activity-email-close-animation")};t.applyTemplate=function(t,i,e,o){var a=this;var l=t>0?[t,i,e].join(":"):t;if(this.templates[l]){o(this.templates[l]);return}BX.ajax({url:"/bitrix/components/bitrix/crm.activity.editor/ajax.php?action=prepare_mail_template&templateid="+t,method:"POST",dataType:"json",data:{sessid:BX.bitrix_sessid(),ACTION:"PREPARE_MAIL_TEMPLATE",TEMPLATE_ID:t,OWNER_TYPE:i,OWNER_ID:e,CONTENT_TYPE:"HTML"},onsuccess:function(t){if(t.DATA){a.templates[l]=t.DATA;o(t.DATA)}}})};var i=function(e){var o=this;this.ctrl=t;this.options=e;for(var a in this.options.templates){if(!this.options.templates.hasOwnProperty(a))continue;if(!(this.ctrl.options.templates[a]&&this.ctrl.options.templates[a].length>0))this.ctrl.options.templates[a]=this.options.templates[a]}this.__dummyNode=document.createElement("DIV");this.htmlForm=BX(this.options.formId);this.htmlForm.__wrapper=this.htmlForm.parentNode;if(this.htmlForm.__inited)return;if("edit"!=this.ctrl.options.type){this.__wrapper=BX("crm-activity-email-details-"+this.ctrl.options.activityId);if(this.options.activityId!=this.ctrl.options.activityId)this.__wrapper=BX.findChildByClassName(this.__wrapper.parentNode,"crm-activity-email-details-"+this.options.activityId,false);BX.addCustomEvent("CrmActivityEmail:replyButtonClick",function(t){if(t!==o)o.hideReplyForm()});var l="activity_"+this.options.activityId+"_body";var s=typeof document.querySelectorAll!="undefined"?document.querySelectorAll("#"+l+" a"):BX.findChildren(BX(l),{tag:"a"},true);for(var r in s){if(!s.hasOwnProperty(r))continue;if(s[r]&&s[r].setAttribute)s[r].setAttribute("target","_blank")}var n=typeof document.querySelectorAll!="undefined"?document.querySelectorAll("#"+l+" blockquote"):BX.findChildren(BX(l),{tag:"blockquote"},true);for(var r in n){if(!n.hasOwnProperty(r))continue;BX.bind(n[r],"click",function(){BX.addClass(this,"crm-email-quote-unfolded")})}var c=BX.findChildrenByClassName(this.__wrapper,"crm-task-list-mail-item-to-list-more");for(var r in c){BX.bind(c[r],"click",function(t){BX.findChildByClassName(this.parentNode,"crm-task-list-mail-item-to-list-hidden",false).style.display="inline";this.style.display="none";BX.PreventDefault(t)})}BX.addCustomEvent("onPullEvent-crm",function(t,i){if(t!="activity_email_read_confirmed")return;if(i.ID!=o.options.activityId)return;var e=BX.findChildrenByClassName(o.__wrapper,"read-confirmed-datetime",true);if(e&&e.length>0){for(var a in e)BX.adjust(e[a],{text:BX.message("CRM_ACT_EMAIL_VIEW_READ_CONFIRMED_SHORT")})}});var m=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-message-panel",true);var d=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-reply",true);var h=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-answertoall",true);var p=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-resend",true);var u=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-skip",true);var _=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-spam",true);var f=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-delete",true);BX.bind(m,"click",this.showReplyForm.bind(this));BX.bind(h,"click",this.showReplyForm.bind(this));BX.bind(d,"click",this.showReplyForm.bind(this,true));BX.bind(p,"click",function(){var t=(BX.CrmActivityType||top.BX.CrmActivityType||{email:4}).email;window.location.href="/bitrix/components/bitrix/crm.activity.planner/slider.php"+"?site_id="+BX.message("SITE_ID")+"&ajax_action=ACTIVITY_EDIT"+"&TYPE_ID="+t+"&FROM_ACTIVITY_ID="+o.options.activityId+"&MESSAGE_TYPE=FWD&IFRAME=Y&IFRAME_TYPE=SIDE_SLIDER"});BX.bind(u,"click",this.delete.bind(this,"skip"));BX.bind(_,"click",this.delete.bind(this,"spam"));BX.bind(f,"click",this.delete.bind(this))}var v=BXMainMailForm.getForm(this.options.formId);BX.addCustomEvent(v,"MailForm:field:rcptSelectorClose",i.handleRcptSelectorClose.bind(this));BX.addCustomEvent(v,"MailForm:footer:buttonClick",i.handleFooterButtonClick.bind(this));BX.addCustomEvent(v,"MailForm:submit",i.handleFormSubmit.bind(this));BX.addCustomEvent(v,"MailForm:submit:ajaxSuccess",i.handleFormSubmitSuccess.bind(this));this.htmlForm.__inited=true};i.handleRcptSelectorClose=function(t,i){if(!i.params.name.match(/^DATA\[(to|cc|bcc)\]$/))return;for(var e=0,o;e<t.fields.length;e++){o=t.fields[e];if(o.selector==i.selector||!o.params.name.match(/^DATA\[(to|cc|bcc)\]$/))continue;BX.SocNetLogDestination.obItems[o.selector]=BX.SocNetLogDestination.obItems[i.selector];BX.SocNetLogDestination.obItemsLast[o.selector]=BX.SocNetLogDestination.obItemsLast[i.selector]}};i.handleFooterButtonClick=function(t,i){if(BX.hasClass(i,"main-mail-form-cancel-button")){if("edit"==this.ctrl.options.type){top.BX.SidePanel.Instance.getSliderByWindow(window).close()}else{this.hideReplyForm()}}};i.handleFormSubmit=function(t,i){var e=this.htmlForm.elements;var o=true;for(var a=0;a<e.length;a++){if("DATA[to][]"==e[a].name&&e[a].value.length>0)o=false}if(o){t.showError(BX.message("CRM_ACT_EMAIL_REPLY_EMPTY_RCPT"));return BX.PreventDefault(i)}var l;for(var a in t.postForm.controllers){if(!t.postForm.controllers.hasOwnProperty(a))continue;if(t.postForm.controllers[a].storage!="disk")continue;try{l=0;l=t.postForm.controllers[a].handler.agent.upload.filesCount}catch(t){}if(l>0){t.showError(BX.message("CRM_ACT_EMAIL_REPLY_UPLOADING"));return BX.PreventDefault(i)}}if("edit"==this.ctrl.options.type){var s=BX("crm_act_email_create_hidden");s.innerHTML="";var e=BX.findChildren(document,{tag:"input"},true);for(var a=0,r;a<e.length;a++){if(e[a].name&&e[a].name.indexOf("__crm_activity_planner[")>=0){r=e[a].cloneNode(true);r.removeAttribute("id");r.setAttribute("name","DATA"+e[a].name.substr("__crm_activity_planner".length));s.appendChild(r)}}}};i.handleFormSubmitSuccess=function(t,i){if(i.ERROR&&i.ERROR.length>0){var e=document.createElement("DIV");if(!BX.type.isArray(i.ERROR))i.ERROR=[i.ERROR];for(var o=0;o<i.ERROR.length;o++){e.appendChild(document.createTextNode(i.ERROR[o]));e.appendChild(document.createElement("BR"))}t.showError(e.innerHTML)}else{top.BX.onCustomEvent("Bitrix24.Slider:postMessage",[window,{action:"ACTIVITY_CREATE",source_id:this.ctrl.options.activityId,target_id:i.ACTIVITY.ID}]);if("edit"!=this.ctrl.options.type){this.hideReplyForm()}var a=top.BX.SidePanel.Instance.getSliderByWindow(window);a.setCacheable(false);a.close()}};i.prototype.showReplyForm=function(t){var i=BXMainMailForm.getForm(this.options.formId);var e=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-message-panel",true);if(this.htmlForm.parentNode===this.__dummyNode)this.htmlForm.__wrapper.appendChild(this.htmlForm);i.init();if(t===true){i.getField("DATA[to]").setValue(this.options.rcptSelected);i.getField("DATA[cc]").setValue()}else{i.getField("DATA[to]").setValue(this.options.rcptAllSelected);i.getField("DATA[cc]").setValue(this.options.rcptCcSelected)}i.getField("DATA[bcc]").setValue();BX.onCustomEvent("CrmActivityEmail:replyButtonClick",[this]);BX.addClass(this.htmlForm,"crm-activity-email-show-animation");this.htmlForm.style.display="";e.style.display="none";BX.onCustomEvent(i,"MailForm:show",[]);this.ctrl.scrollTo(this.htmlForm)};i.prototype.hideReplyForm=function(){var t=BXMainMailForm.getForm(this.options.formId);var i=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-message-panel",true);BX.addClass(i,"crm-activity-email-show-animation-rev");i.style.display="";this.htmlForm.style.display="none";BX.onCustomEvent(t,"MailForm:hide",[]);this.__dummyNode.appendChild(this.htmlForm)};i.prototype.delete=function(t){var i=this;var e="CRM_ACT_EMAIL_DELETE_CONFIRM";switch(t){case"skip":e="CRM_ACT_EMAIL_SKIP_CONFIRM";break;case"spam":e="CRM_ACT_EMAIL_SPAM_CONFIRM";break}if(!window.confirm(BX.message(e)))return false;var o=BX.findChildByClassName(this.__wrapper,"crm-task-list-mail-item-control-icon-delete",true);var a={sessid:BX.bitrix_sessid(),ACTION:"DELETE",IS_SKIP:"skip"==t?"Y":"N",IS_SPAM:"spam"==t?"Y":"N",ITEM_ID:this.options.activityId};var l=BX.findChildren(o.parentNode,{tag:"input"},true);for(var s=0;s<l.length;s++){if(l[s].name)a[l[s].name]=l[s].value}BX.ajax({url:"/bitrix/components/bitrix/crm.activity.editor/ajax.php?id="+this.options.activityId+"&action=delete",method:"POST",dataType:"json",data:a,onsuccess:function(t){top.BX.onCustomEvent("Bitrix24.Slider:postMessage",[window,{action:"ACTIVITY_DELETE",source_id:i.ctrl.options.activityId,target_id:i.options.activityId}]);if(i.ctrl.options.activityId!=i.options.activityId){i.ctrl.removeLogItem(i.options.activityId)}else{var e=top.BX.SidePanel.Instance.getSliderByWindow(window);e.setCacheable(false);e.close()}}})};i.prototype.batch=function(t){var i=BXMainMailForm.getForm(this.options.formId);i.getField("DATA[cc]")[t?"hide":"show"]();i.getField("DATA[bcc]")[t?"hide":"show"]()};i.prototype.templateMenu=function(t,i,e){var o=this;var a=function(a,l){var s=BXMainMailForm.getForm(o.options.formId);o.ctrl.applyTemplate(l.__id,t,i,function(t){if(t.FROM&&t.FROM.length>0){var i=s.getField("DATA[from]");i.setValue(t.FROM);if(i.params.folded)i.unfold()}if(t.SUBJECT&&t.SUBJECT.length>0){var e=o.htmlForm.elements;var a=e["DATA[FORWARDED_ID]"]?e["DATA[FORWARDED_ID]"].value:0;var l=e["DATA[REPLIED_ID]"]?e["DATA[REPLIED_ID]"].value:0;if(!(a>0||l>0)){var r=s.getField("DATA[subject]");r.setValue(t.SUBJECT);if(r.params.folded)r.unfold()}}if(t.FILES&&t.FILES.length>0)s.getField("DATA[__diskfiles]").setValue(t.FILES);s.getField("DATA[message]").setValue(t.BODY,{quote:true,signature:true})});BX.adjust(e,{html:l.text});l.menuWindow.close()};var l=[];if(t!="")l=l.concat(this.ctrl.options.templates[t]||[]);l=l.concat(this.ctrl.options.templates[""]||[]);if(!(l.length>0))return;var s=[{__id:"0",text:BX.message("CRM_ACT_EMAIL_CREATE_NOTEMPLATE"),onclick:a},{delimiter:true}];for(var r in l){s.push({__id:l[r].id,text:BX.util.htmlspecialchars(l[r].title),onclick:a})}BX.PopupMenu.show("crm-activity-email-"+this.options.activityId+"-template-menu",e,s,{offsetLeft:40,angle:true,closeByEsc:true})};window.BXCrmActivityEmailController=t;window.BXCrmActivityEmail=i})();
//# sourceMappingURL=script.map.js