this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};this.BX.Crm.Store=this.BX.Crm.Store||{};(function(t,e,n,r,o,a){"use strict";function i(t,e){var n=typeof Symbol!=="undefined"&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=s(t))||e&&t&&typeof t.length==="number"){if(n)t=n;var r=0;var o=function t(){};return{s:o,n:function e(){if(r>=t.length)return{done:true};return{done:false,value:t[r++]}},e:function t(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,i=false,l;return{s:function e(){n=n.call(t)},n:function t(){var e=n.next();a=e.done;return e},e:function t(e){i=true;l=e},f:function t(){try{if(!a&&n["return"]!=null)n["return"]()}finally{if(i)throw l}}}}function s(t,e){if(!t)return;if(typeof t==="string")return l(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);if(n==="Object"&&t.constructor)n=t.constructor.name;if(n==="Map"||n==="Set")return Array.from(t);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return l(t,e)}function l(t,e){if(e==null||e>t.length)e=t.length;for(var n=0,r=new Array(e);n<e;n++){r[n]=t[n]}return r}function c(t,e){d(t,e);e.add(t)}function u(t,e,n){d(t,e);e.set(t,n)}function d(t,e){if(e.has(t)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function f(t,e,n){if(!e.has(t)){throw new TypeError("attempted to get private field on non-instance")}return n}var v=new WeakMap;var b=new WeakMap;var m=new WeakMap;var E=new WeakSet;var p=new WeakSet;var h=new WeakSet;var C=function(){function t(e){babelHelpers.classCallCheck(this,t);c(this,h);c(this,p);c(this,E);u(this,v,{writable:true,value:void 0});u(this,b,{writable:true,value:void 0});u(this,m,{writable:true,value:null});babelHelpers.classPrivateFieldSet(this,v,e.onboardingData);babelHelpers.classPrivateFieldSet(this,b,e.documentGuid);if(e.productListController){babelHelpers.classPrivateFieldSet(this,m,e.productListController)}}babelHelpers.createClass(t,[{key:"processOnboarding",value:function t(){var e=babelHelpers.classPrivateFieldGet(this,v).chain;var n=babelHelpers.classPrivateFieldGet(this,v).chainStep;if(e===1&&n===1){var r=f(this,p,g).call(this);if(r){f(this,E,y).call(this,r)}}}}]);return t}();function y(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var e=document.querySelector("#".concat(babelHelpers.classPrivateFieldGet(this,b),"_TABS_MENU"));var n=new BX.SpotLight({id:"arrow_spotlight",targetElement:document.querySelector("[data-tab-id=tab_products]"),autoSave:true,targetVertex:"middle-center",zIndex:200});n.show();n.container.style.pointerEvents="none";var r=function r(i){n.close();var s=babelHelpers.slicedToArray(i.data,1),l=s[0];var c=function t(){var n=l.getActiveHint();if(n!==null){n.close();o.Event.unbind(e,"click",t)}};o.Event.bind(e,"click",c);var u=function t(e){var n,r;if((e===null||e===void 0?void 0:(n=e.data)===null||n===void 0?void 0:n.tabId)==="tab_products"){return}(r=l.getActiveHint())===null||r===void 0?void 0:r.close()};l.showFieldTourHint("AMOUNT",{title:o.Loc.getMessage("CRM_STORE_DOCUMENT_WAREHOUSE_PRODUCT_AMOUNT_GUIDE_TITLE_2"),text:o.Loc.getMessage("CRM_STORE_DOCUMENT_WAREHOUSE_PRODUCT_AMOUNT_GUIDE_TEXT")},(function(){o.userOptions.save("crm","warehouse-onboarding","secondChainStage",2);o.userOptions.save("crm","warehouse-onboarding","chainStage",2);o.Event.unbind(e,"click",c);a.EventEmitter.unsubscribe("onDemandRecalculateWrapper",r);a.EventEmitter.unsubscribe("BX.Catalog.EntityCard.TabManager:onOpenTab",u)}),[],t);a.EventEmitter.subscribe("BX.Catalog.EntityCard.TabManager:onOpenTab",u)};a.EventEmitter.subscribe("onDemandRecalculateWrapper",r)}function g(){var t=f(this,h,S).call(this);var e=i(t),n;try{for(e.s();!(n=e.n()).done;){var r=n.value;if(!r.getModel().isService()){return r.getId()}}}catch(t){e.e(t)}finally{e.f()}return""}function S(){if(babelHelpers.classPrivateFieldGet(this,m)&&babelHelpers.classPrivateFieldGet(this,m).productList){if(babelHelpers.classPrivateFieldGet(this,m).productList.products instanceof Array){return babelHelpers.classPrivateFieldGet(this,m).productList.products}}return[]}var B;function _(t,e){var n=typeof Symbol!=="undefined"&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=T(t))||e&&t&&typeof t.length==="number"){if(n)t=n;var r=0;var o=function t(){};return{s:o,n:function e(){if(r>=t.length)return{done:true};return{done:false,value:t[r++]}},e:function t(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,i=false,s;return{s:function e(){n=n.call(t)},n:function t(){var e=n.next();a=e.done;return e},e:function t(e){i=true;s=e},f:function t(){try{if(!a&&n["return"]!=null)n["return"]()}finally{if(i)throw s}}}}function T(t,e){if(!t)return;if(typeof t==="string")return w(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);if(n==="Object"&&t.constructor)n=t.constructor.name;if(n==="Map"||n==="Set")return Array.from(t);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return w(t,e)}function w(t,e){if(e==null||e>t.length)e=t.length;for(var n=0,r=new Array(e);n<e;n++){r[n]=t[n]}return r}function D(t,e){A(t,e);e.add(t)}function O(t,e,n){A(t,e);e.set(t,n)}function A(t,e){if(e.has(t)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function M(t,e,n){X(t,e);k(n,"get");return P(t,n)}function P(t,e){if(e.get){return e.get.call(t)}return e.value}function I(t,e,n,r){X(t,e);k(n,"set");L(t,n,r);return r}function k(t,e){if(t===undefined){throw new TypeError("attempted to "+e+" private static field before its declaration")}}function X(t,e){if(t!==e){throw new TypeError("Private static access of wrong provenance")}}function L(t,e,n){if(e.set){e.set.call(t,n)}else{if(!e.writable){throw new TypeError("attempted to set read only private field")}e.value=n}}function N(t,e,n){if(!e.has(t)){throw new TypeError("attempted to get private field on non-instance")}return n}var U=new WeakMap;var H=new WeakSet;var F=function(t){babelHelpers.inherits(e,t);function e(t,n){var r;babelHelpers.classCallCheck(this,e);r=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t,n));D(babelHelpers.assertThisInitialized(r),H);O(babelHelpers.assertThisInitialized(r),U,{writable:true,value:null});r.isDocumentDeducted=n.documentStatus==="Y";r.isDeductLocked=n.isDeductLocked;r.masterSliderUrl=n.masterSliderUrl;r.inventoryManagementSource=n.inventoryManagementSource;r.permissions=n.permissions;r.addCopyLinkPopup();a.EventEmitter.subscribe("BX.Crm.EntityEditor:onFailedValidation",(function(t){a.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"main"})}));a.EventEmitter.subscribe("onProductsCheckFailed",(function(t){a.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"tab_products"})}));a.EventEmitter.subscribe("BX.Crm.EntityEditor:onSave",(function(t){var n=t.data[0];if(n&&n._ajaxForm){var o,a;var i=((o=n._ajaxForm)===null||o===void 0?void 0:o._actionName)==="SAVE"?"save":(a=n._ajaxForm)===null||a===void 0?void 0:a._config.data.ACTION;if(i===e.saveAndDeductAction){var s=r.getControllersIssues(n.getControllers());if(s.length>0){var l,c;t.data[1].cancel=true;(l=n._toolPanel)===null||l===void 0?void 0:l.setLocked(false);(c=n._toolPanel)===null||c===void 0?void 0:c.addError(s[0]);return}}if(i==="SAVE"){i="save"}var u={isNewDocument:r.entityId<=0?"Y":"N",inventoryManagementSource:r.inventoryManagementSource};if(i){u.action=i}n._ajaxForm.addUrlParams(u)}}));a.EventEmitter.subscribe("BX.Catalog.EntityCard.TabManager:onSelectItem",(function(t){var e=t.data.tabId;if(e==="tab_products"&&!r.isTabAnalyticsSent){r.sendAnalyticsData({tab:"products",isNewDocument:r.entityId<=0?"Y":"N",documentType:"W",inventoryManagementSource:r.inventoryManagementSource});r.isTabAnalyticsSent=true}}));N(babelHelpers.assertThisInitialized(r),H,R).call(babelHelpers.assertThisInitialized(r));I(e,e,j,babelHelpers.assertThisInitialized(r));BX.UI.SidePanel.Wrapper.setParam("closeAfterSave",true);r.showNotificationOnClose=false;return r}babelHelpers.createClass(e,[{key:"focusOnTab",value:function t(e){a.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:e})}},{key:"getControllersIssues",value:function t(e){var n=[];if(e instanceof Array){e.forEach((function(t){if(t instanceof BX.Crm.EntityStoreDocumentProductListController){n.push.apply(n,babelHelpers.toConsumableArray(t.getErrorCollection()))}}))}return n}},{key:"openMasterSlider",value:function t(){var e=this;BX.SidePanel.Instance.open(this.masterSliderUrl,{cacheable:false,data:{openGridOnDone:false},events:{onCloseComplete:function t(n){var r=n.getSlider();if(!r){return}if(r.getData().get("isInventoryManagementEnabled")){e.isDeductLocked=false;var o=BX.SidePanel.Instance.getOpenSliders();o.forEach((function(t){var e,n;if((e=t.getWindow())!==null&&e!==void 0&&(n=e.BX.Catalog)!==null&&n!==void 0&&n.DocumentGridManager){t.allowChangeHistory=false;t.getWindow().location.reload()}}))}}}})}},{key:"adjustToolPanel",value:function t(){var n=this;var i=this.getEditorInstance();if(!i){return}var s=i._toolPanel;var l=i._toolPanel._editButton;this.defaultSaveActionName=i._ajaxForm._config.data.ACTION;this.defaultOnSuccessCallback=i._ajaxForm._config.onsuccess;l.onclick=function(t){n.showNotificationOnClose=false;i._ajaxForm._config.data.ACTION=n.defaultSaveActionName;i._ajaxForm._config.onsuccess=n.defaultOnSuccessCallback;s.onSaveButtonClick(t)};if(this.permissions.conduct&&!this.isDocumentDeducted){var c=o.Tag.render(B||(B=babelHelpers.taggedTemplateLiteral(['<button class="ui-btn ui-btn-light-border">',"</button>"])),o.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_SAVE_AND_DEDUCT_BUTTON"));c.onclick=function(t){if(n.isDeductLocked){n.openMasterSlider();return}i._ajaxForm._config.data.ACTION=e.saveAndDeductAction;i._ajaxForm._config.onsuccess=function(t){n.showNotificationOnClose=true;var e=BX.prop.getString(t,"ERROR","");if(!e){n.setViewModeButtons(i)}i.onSaveSuccess(t)};s.onSaveButtonClick(t)};l.after(c);this.deductAndSaveButton=c;var u=new r.Button({text:o.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_DEDUCT_BUTTON"),color:r.ButtonColor.LIGHT_BORDER,onclick:function t(o,a){if(s.isLocked()){return}if(n.isDeductLocked){n.openMasterSlider();return}o.setState(r.ButtonState.CLOCKING);s.setLocked(true);var l=e.deductAction;var c=i.getControllers();var u=[];c.forEach((function(t){if(t instanceof BX.Crm.EntityStoreDocumentProductListController){if(!t.validateProductList()){u.push.apply(u,babelHelpers.toConsumableArray(t.getErrorCollection()))}}}));if(u.length>0){s.clearErrors();s.addError(u[0]);s.setLocked(false);o.setActive(true);return}var d={};if(window.EntityEditorDocumentOrderShipmentController){d=window.EntityEditorDocumentOrderShipmentController.demandFormData()}var f=i.createAjaxForm({actionName:l,enableRequiredUserFieldCheck:false,formData:d},{onSuccess:function t(e){if(!n.isDocumentDeducted){n.showNotificationOnClose=true}o.setState(r.ButtonState.ACTIVE);i.onSaveSuccess(e)},onFailure:function t(e){o.setState(r.ButtonState.ACTIVE);i.onSaveFailure(e)}});f.addUrlParams({action:l,documentType:"W"});f.submit()}}).render();l.after(u);this.deductButton=u}else if(this.permissions.cancel){var d=new r.Button({text:o.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_CANCEL_DEDUCT_BUTTON"),color:r.ButtonColor.LIGHT_BORDER,onclick:function t(o,a){if(s.isLocked()){return}if(n.isDeductLocked){n.openMasterSlider();return}o.setState(r.ButtonState.CLOCKING);s.setLocked(true);var l=e.cancelDeductAction;var c={};if(window.EntityEditorDocumentOrderShipmentController){c=window.EntityEditorDocumentOrderShipmentController.demandFormData()}var u=i.createAjaxForm({actionName:l,enableRequiredUserFieldCheck:false,formData:c},{onSuccess:function t(e){if(!n.isDocumentDeducted){n.showNotificationOnClose=true}o.setState(r.ButtonState.ACTIVE);i.onSaveSuccess(e)},onFailure:function t(e){o.setState(r.ButtonState.ACTIVE);i.onSaveFailure(e)}});u.addUrlParams({action:l,documentType:"W",inventoryManagementSource:n.inventoryManagementSource});u.submit()}}).render();l.after(d);this.deductButton=d}a.EventEmitter.subscribe("BX.Crm.EntityEditor:onControlModeChange",(function(t){var e=t.data[0];var r=t.data[1].control;if(r.getMode()===BX.Crm.EntityEditorMode.edit){n.setEditModeButtons(e)}else{n.setViewModeButtons(e)}}));a.EventEmitter.subscribe("BX.Crm.EntityEditor:onControlChange",(function(t){var e=t.data[0];n.setEditModeButtons(e)}));a.EventEmitter.subscribe("BX.Crm.EntityEditor:onControllerChange",(function(t){var e=t.data[0];n.setEditModeButtons(e)}));a.EventEmitter.subscribe("BX.Crm.EntityEditor:onSwitchToViewMode",(function(t){var e=t.data[0];n.setViewModeButtons(e)}));a.EventEmitter.subscribe("BX.Crm.EntityEditor:onNothingChanged",(function(t){var e=t.data[0];n.setViewModeButtons(e)}));a.EventEmitter.subscribe("onEntityCreate",(function(t){var e;var n=t===null||t===void 0?void 0:(e=t.data[0])===null||e===void 0?void 0:e.sender;if(n){n._toolPanel.disableSaveButton();n.hideToolPanel()}}));a.EventEmitter.subscribe("beforeCrmEntityRedirect",(function(t){var e;var r=t===null||t===void 0?void 0:(e=t.data[0])===null||e===void 0?void 0:e.sender;if(r){r._toolPanel.disableSaveButton();r.hideToolPanel();if(n.showNotificationOnClose){var a=t.data[0].redirectUrl;if(!a){return}a=BX.Uri.removeParam(a,"closeOnSave");window.top.BX.UI.Notification.Center.notify({content:o.Loc.getMessage("CRM_STORE_DOCUMENT_SAVE_AND_CONDUCT_NOTIFICATION"),actions:[{title:o.Loc.getMessage("CRM_STORE_DOCUMENT_OPEN_DOCUMENT"),href:a,events:{click:function t(e,n,r){n.close()}}}]})}}}));if(i.isNew()){this.setEditModeButtons(i)}else{this.setViewModeButtons(i)}}},{key:"setViewModeButtons",value:function t(e){if(e._toolPanel&&e._toolPanel.hasOwnProperty("_cancelButton")){BX.hide(e._toolPanel._cancelButton)}if(e._toolPanel&&e._toolPanel.hasOwnProperty("_editButton")){BX.hide(e._toolPanel._editButton)}if(this.deductAndSaveButton){BX.hide(this.deductAndSaveButton)}if(this.deductButton){BX.show(this.deductButton)}}},{key:"setEditModeButtons",value:function t(e){if(e._toolPanel&&e._toolPanel.hasOwnProperty("_cancelButton")){BX.show(e._toolPanel._cancelButton)}if(e._toolPanel&&e._toolPanel.hasOwnProperty("_editButton")){BX.show(e._toolPanel._editButton)}if(this.deductAndSaveButton&&!this.isDocumentDeducted){BX.show(this.deductAndSaveButton)}if(this.deductButton&&!this.isDocumentDeducted){BX.hide(this.deductButton)}}},{key:"getEditorInstance",value:function t(){if(o.Reflection.getClass("BX.Crm.EntityEditor")){return BX.Crm.EntityEditor.getDefault()}return null}},{key:"addCopyLinkPopup",value:function t(){var e=this;var n=document.getElementById(this.settings.copyLinkButtonId);if(!n){return}n.onclick=function(){e.copyDocumentLinkToClipboard()}}},{key:"copyDocumentLinkToClipboard",value:function t(){var e=BX.util.remove_url_param(window.location.href,["IFRAME","IFRAME_TYPE"]);if(!BX.clipboard.copy(e)){return}var n=new BX.PopupWindow("catalog_copy_document_url_to_clipboard",document.getElementById(this.settings.copyLinkButtonId),{content:o.Loc.getMessage("CRM_STORE_DOCUMENT_DETAIL_LINK_COPIED"),darkMode:true,autoHide:true,zIndex:1e3,angle:true,bindOptions:{position:"top"}});n.show();setTimeout((function(){n.close()}),1500)}},{key:"sendAnalyticsData",value:function t(e){BX.ajax.runComponentAction("bitrix:crm.store.document.detail","sendAnalytics",{mode:"class",analyticsLabel:e})}},{key:"enableOnboardingChain",value:function t(e){if(babelHelpers.classPrivateFieldGet(this,U)===null){babelHelpers.classPrivateFieldSet(this,U,new C({onboardingData:e,documentGuid:this.id,productListController:this.getProductListController()}));babelHelpers.classPrivateFieldGet(this,U).processOnboarding()}}},{key:"getProductListController",value:function t(){var e=this.getEditorInstance();var n=e.getControllers();var r=_(n),o;try{for(r.s();!(o=r.n()).done;){var a=o.value;if(a instanceof BX.Crm.EntityStoreDocumentProductListController){return a}}}catch(t){r.e(t)}finally{r.f()}return null}}],[{key:"getInstance",value:function t(){return M(e,e,j)}}]);return e}(n.BaseCard);function R(){a.EventEmitter.subscribe("BX.UI.EntityEditorProductRowSummary:onDetailProductListLinkClick",(function(){a.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"tab_products"})}));a.EventEmitter.subscribe("BX.UI.EntityEditorProductRowSummary:onAddNewRowInProductList",(function(){a.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"tab_products"});setTimeout((function(){a.EventEmitter.emit("onFocusToProductList")}),500)}))}var j={writable:true,value:void 0};babelHelpers.defineProperty(F,"saveAndDeductAction","saveAndDeduct");babelHelpers.defineProperty(F,"deductAction","deduct");babelHelpers.defineProperty(F,"cancelDeductAction","cancelDeduct");t.Document=F})(this.BX.Crm.Store.DocumentCard=this.BX.Crm.Store.DocumentCard||{},BX,BX.Catalog.EntityCard,BX.UI,BX,BX.Event);
//# sourceMappingURL=script.map.js