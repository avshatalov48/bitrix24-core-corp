this.BX=this.BX||{};(function(e,t,i,a){"use strict";function s(e,t){r(e,t);t.add(e)}function l(e,t,i){r(e,t);t.set(e,i)}function r(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function n(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var b=new WeakMap;var p=new WeakMap;var c=new WeakMap;var d=new WeakMap;var v=new WeakMap;var u=new WeakMap;var o=new WeakMap;var h=new WeakMap;var f=new WeakSet;var H=new WeakSet;var P=new WeakSet;var E=new WeakSet;var F=function(){function e(t){babelHelpers.classCallCheck(this,e);s(this,E);s(this,P);s(this,H);s(this,f);l(this,b,{writable:true,value:void 0});l(this,p,{writable:true,value:void 0});l(this,c,{writable:true,value:void 0});l(this,d,{writable:true,value:void 0});l(this,v,{writable:true,value:void 0});l(this,u,{writable:true,value:void 0});l(this,o,{writable:true,value:void 0});l(this,h,{writable:true,value:void 0});if(!i.Type.isPlainObject(t)){throw'BX.Crm.EntityCounterManager: The "options" argument must be object.'}babelHelpers.classPrivateFieldSet(this,b,i.Type.isString(t.id)?t.id:"");if(babelHelpers.classPrivateFieldGet(this,b)===""){throw'BX.Crm.EntityCounterManager: The "id" argument must be specified.'}babelHelpers.classPrivateFieldSet(this,d,i.Type.isString(t.serviceUrl)?t.serviceUrl:"");if(babelHelpers.classPrivateFieldGet(this,d)===""){throw'BX.Crm.EntityCounterManager: The "serviceUrl" argument must be specified.'}babelHelpers.classPrivateFieldSet(this,p,t.entityTypeId?i.Text.toInteger(t.entityTypeId):0);babelHelpers.classPrivateFieldSet(this,c,BX.CrmEntityType.resolveName(babelHelpers.classPrivateFieldGet(this,p)));babelHelpers.classPrivateFieldSet(this,v,i.Type.isArray(t.codes)?t.codes:[]);babelHelpers.classPrivateFieldSet(this,u,i.Type.isObject(t.extras)?t.extras:{});babelHelpers.classPrivateFieldSet(this,o,{});n(this,f,T).call(this);this.constructor.lastInstance=this}babelHelpers.createClass(e,[{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,b)}},{key:"getCounterData",value:function e(){return babelHelpers.classPrivateFieldGet(this,o)}},{key:"setCounterData",value:function e(t){babelHelpers.classPrivateFieldSet(this,o,t)}}],[{key:"getLastInstance",value:function e(){return this.lastInstance}}]);return e}();function T(){a.EventEmitter.subscribe("onPullEvent-main",n(this,H,y).bind(this))}function y(e){var t=e.getData(),s=babelHelpers.slicedToArray(t,2),l=s[0],r=s[1];if(l!=="user_counter"){return}var b=false;var p=false;var c=i.Loc.getMessage("SITE_ID");var d=i.Type.isPlainObject(r[c])?r[c]:{};for(var u in d){if(!d.hasOwnProperty(u)||babelHelpers.classPrivateFieldGet(this,v).indexOf(u)<0){continue}var h=BX.prop.getInteger(d,u,0);if(h<0){p=true;break}var f=BX.prop.getInteger(babelHelpers.classPrivateFieldGet(this,o),u,0);if(f!==h){b=true;babelHelpers.classPrivateFieldGet(this,o)[u]=h}}if(p){n(this,P,I).call(this)}if(b){a.EventEmitter.emit("BX.Crm.EntityCounterManager:onRecalculate",this)}}function I(){if(babelHelpers.classPrivateFieldGet(this,h)){return}babelHelpers.classPrivateFieldSet(this,h,true);i.ajax({url:babelHelpers.classPrivateFieldGet(this,d),method:"POST",dataType:"json",data:{ACTION:"RECALCULATE",ENTITY_TYPES:[babelHelpers.classPrivateFieldGet(this,c)],EXTRAS:babelHelpers.classPrivateFieldGet(this,u)},onsuccess:BX.delegate(n(this,E,w),this)})}function w(e){babelHelpers.classPrivateFieldSet(this,h,false);var t=i.Type.isPlainObject(e["DATA"])?e["DATA"]:null;if(t===null){return}this.setCounterData(i.Type.isPlainObject(t[babelHelpers.classPrivateFieldGet(this,c)])?t[babelHelpers.classPrivateFieldGet(this,c)]:{});a.EventEmitter.emit("BX.Crm.EntityCounterManager:onRecalculate",this)}babelHelpers.defineProperty(F,"lastInstance",null);var C=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(C,"UNDEFINED",0);babelHelpers.defineProperty(C,"IDLE",1);babelHelpers.defineProperty(C,"PENDING",2);babelHelpers.defineProperty(C,"OVERDUE",4);babelHelpers.defineProperty(C,"CURRENT",6);babelHelpers.defineProperty(C,"ALL",7);babelHelpers.defineProperty(C,"IDLE_NAME","IDLE");babelHelpers.defineProperty(C,"PENDING_NAME","PENDING");babelHelpers.defineProperty(C,"OVERDUE_NAME","OVERDUE");babelHelpers.defineProperty(C,"CURRENT_NAME","CURRENT");babelHelpers.defineProperty(C,"ALL_NAME","ALL");function m(e,t){G(e,t);t.add(e)}function g(e,t,i){G(e,t);t.set(e,i)}function G(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function k(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var S=new WeakMap;var _=new WeakMap;var N=new WeakMap;var O=new WeakSet;var M=new WeakSet;var A=new WeakSet;var D=function(){function e(){babelHelpers.classCallCheck(this,e);m(this,A);m(this,M);m(this,O);g(this,S,{writable:true,value:void 0});g(this,_,{writable:true,value:void 0});g(this,N,{writable:true,value:true});var t=i.Type.isObject(BX.Main.filterManager)&&BX.Main.filterManager.hasOwnProperty("getList")?BX.Main.filterManager.getList():Object.values(BX.Main.filterManager.data);if(t.length===0){console.warn("BX.Crm.EntityCounterFilter: Unable to define filter.");babelHelpers.classPrivateFieldSet(this,N,false)}else{babelHelpers.classPrivateFieldSet(this,S,t[0]);k(this,O,U).call(this);this.updateFields()}}babelHelpers.createClass(e,[{key:"getManager",value:function e(){return babelHelpers.classPrivateFieldGet(this,S)}},{key:"isActive",value:function e(){return babelHelpers.classPrivateFieldGet(this,N)}},{key:"getFields",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(i){var a=Object.entries(babelHelpers.classPrivateFieldGet(this,_)).filter((function(e){var i=babelHelpers.slicedToArray(e,2),a=i[0],s=i[1];return k(t,A,R).call(t,a)}));return Object.fromEntries(a)}return babelHelpers.classPrivateFieldGet(this,_)}},{key:"getApi",value:function e(){return babelHelpers.classPrivateFieldGet(this,S).getApi()}},{key:"updateFields",value:function e(){babelHelpers.classPrivateFieldSet(this,_,babelHelpers.classPrivateFieldGet(this,S).getFilterFieldsValues())}},{key:"isFilteredByFieldEx",value:function e(t){if(!Object.keys(babelHelpers.classPrivateFieldGet(this,_)).includes(t)||t.endsWith("_datesel")||t.endsWith("_numsel")||t.endsWith("_label")){return false}return k(this,A,R).call(this,t)}},{key:"isFiltered",value:function t(a,s,l){var r=this;if(a===0||s===C.UNDEFINED){return false}var n=l===BX.CrmEntityType.enumeration.order?true:this.isFilteredByFieldEx(e.COUNTER_USER_FIELD)&&i.Type.isArray(babelHelpers.classPrivateFieldGet(this,_)[e.COUNTER_USER_FIELD])&&babelHelpers.classPrivateFieldGet(this,_)[e.COUNTER_USER_FIELD].length===1&&parseInt(babelHelpers.classPrivateFieldGet(this,_)[e.COUNTER_USER_FIELD][0],10)===a;var b=this.isFilteredByFieldEx(e.COUNTER_TYPE_FIELD)&&i.Type.isObject(babelHelpers.classPrivateFieldGet(this,_)[e.COUNTER_TYPE_FIELD])&&Object.values(babelHelpers.classPrivateFieldGet(this,_)[e.COUNTER_TYPE_FIELD]).length===1&&parseInt(Object.values(babelHelpers.classPrivateFieldGet(this,_)[e.COUNTER_TYPE_FIELD])[0],10)===s;var p=[e.COUNTER_USER_FIELD,e.COUNTER_TYPE_FIELD];var c=Object.keys(babelHelpers.classPrivateFieldGet(this,_));var d=p.filter((function(e){return!c.includes(e)})).concat(c.filter((function(e){return!p.includes(e)})));var v=d.some((function(e){return r.isFilteredByFieldEx(e)}));return n&&b&&!v}}]);return e}();function U(){a.EventEmitter.subscribe("BX.Main.Filter:apply",k(this,M,B).bind(this))}function B(){this.updateFields()}function R(e){if(i.Type.isArray(babelHelpers.classPrivateFieldGet(this,_)[e])){return babelHelpers.classPrivateFieldGet(this,_)[e].length>0}if(i.Type.isObject(babelHelpers.classPrivateFieldGet(this,_)[e])){return Object.values(babelHelpers.classPrivateFieldGet(this,_)[e]).length>0}return babelHelpers.classPrivateFieldGet(this,_)[e]!==""}babelHelpers.defineProperty(D,"COUNTER_TYPE_FIELD","ACTIVITY_COUNTER");babelHelpers.defineProperty(D,"COUNTER_USER_FIELD","ASSIGNED_BY_ID");function W(e,t){X(e,t);t.add(e)}function L(e,t,i){X(e,t);t.set(e,i)}function X(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function z(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var j=i.Reflection.namespace("BX.Crm");var x=new WeakMap;var Y=new WeakMap;var V=new WeakMap;var J=new WeakMap;var q=new WeakMap;var K=new WeakMap;var Q=new WeakMap;var Z=new WeakMap;var $=new WeakMap;var ee=new WeakSet;var te=new WeakSet;var ie=new WeakSet;var ae=new WeakSet;var se=new WeakSet;var le=new WeakSet;var re=new WeakSet;var ne=new WeakSet;var be=function(e){babelHelpers.inherits(t,e);function t(e){var a;babelHelpers.classCallCheck(this,t);if(!i.Type.isPlainObject(e)){throw'BX.Crm.EntityCounterPanel: The "options" argument must be object.'}var s=i.Type.isPlainObject(e.data)?e.data:{};a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{target:BX(e.id),items:t.getCounterItems(s),multiselect:false}));W(babelHelpers.assertThisInitialized(a),ne);W(babelHelpers.assertThisInitialized(a),re);W(babelHelpers.assertThisInitialized(a),le);W(babelHelpers.assertThisInitialized(a),se);W(babelHelpers.assertThisInitialized(a),ae);W(babelHelpers.assertThisInitialized(a),ie);W(babelHelpers.assertThisInitialized(a),te);W(babelHelpers.assertThisInitialized(a),ee);L(babelHelpers.assertThisInitialized(a),x,{writable:true,value:void 0});L(babelHelpers.assertThisInitialized(a),Y,{writable:true,value:void 0});L(babelHelpers.assertThisInitialized(a),V,{writable:true,value:void 0});L(babelHelpers.assertThisInitialized(a),J,{writable:true,value:void 0});L(babelHelpers.assertThisInitialized(a),q,{writable:true,value:void 0});L(babelHelpers.assertThisInitialized(a),K,{writable:true,value:void 0});L(babelHelpers.assertThisInitialized(a),Q,{writable:true,value:void 0});L(babelHelpers.assertThisInitialized(a),Z,{writable:true,value:void 0});L(babelHelpers.assertThisInitialized(a),$,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),x,e.id);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),Y,e.entityTypeId?i.Text.toInteger(e.entityTypeId):0);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),V,e.userId?i.Text.toInteger(e.userId):0);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),J,i.Type.isStringFilled(e.userName)?e.userName:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),V));babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),q,s);if(BX.CrmEntityType.isDefined(babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),Y))){babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),K,new F({id:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),x),entityTypeId:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),Y),serviceUrl:i.Type.isString(e.serviceUrl)?e.serviceUrl:"",codes:i.Type.isArray(e.codes)?e.codes:[],extras:i.Type.isObject(e.extras)?e.extras:{}}))}babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),Q,new D);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),Z,e.filterLastPresetId);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),$,i.Type.isArray(e.filterLastPresetData)?JSON.parse(e.filterLastPresetData[0]):{presetId:null});z(babelHelpers.assertThisInitialized(a),ee,pe).call(babelHelpers.assertThisInitialized(a));return a}babelHelpers.createClass(t,[{key:"init",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"init",this).call(this);z(this,re,he).call(this)}},{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,x)}}],[{key:"getCounterItems",value:function e(a){return Object.entries(a).map((function(e){var a=babelHelpers.slicedToArray(e,2),s=a[0],l=a[1];var r=parseInt(l.VALUE,10);return{id:s,title:i.Loc.getMessage("NEW_CRM_COUNTER_TYPE_"+l.TYPE_NAME),value:r,color:t.detectCounterItemColor(l.TYPE_NAME,r)}}),this)}},{key:"detectCounterItemColor",value:function e(t,i){return[C.IDLE_NAME,C.OVERDUE_NAME].includes(t)&&i>0?"DANGER":"THEME"}}]);return t}(t.CounterPanel);function pe(){a.EventEmitter.subscribe("BX.UI.CounterPanel.Item:activate",z(this,te,ce).bind(this));a.EventEmitter.subscribe("BX.UI.CounterPanel.Item:deactivate",z(this,ie,de).bind(this));a.EventEmitter.subscribe("BX.Main.Filter:apply",z(this,ae,ve).bind(this));a.EventEmitter.subscribe("BX.Crm.EntityCounterManager:onRecalculate",z(this,se,ue).bind(this))}function ce(e){var t=e.getData();if(!z(this,le,oe).call(this,t)){return BX.PreventDefault(e)}}function de(){if(z(this,ne,fe).call(this)&&babelHelpers.classPrivateFieldGet(this,Q).isActive()){var e=babelHelpers.classPrivateFieldGet(this,Q).getApi();if(babelHelpers.classPrivateFieldGet(this,$).presetId==="tmp_filter"){e.setFields(babelHelpers.classPrivateFieldGet(this,$).fields);e.apply()}else{e.setFilter({preset_id:babelHelpers.classPrivateFieldGet(this,$).presetId})}}}function ve(){if(babelHelpers.classPrivateFieldGet(this,Q).isActive()){babelHelpers.classPrivateFieldGet(this,Q).updateFields()}z(this,re,he).call(this)}function ue(){var e=babelHelpers.classPrivateFieldGet(this,K).getCounterData();for(var t in e){if(!e.hasOwnProperty(t)||!(t.indexOf("crm")===0&&e[t]>=0)||!babelHelpers.classPrivateFieldGet(this,q).hasOwnProperty(t)||i.Text.toNumber(babelHelpers.classPrivateFieldGet(this,q)[t].VALUE)===i.Text.toNumber(e[t])){continue}babelHelpers.classPrivateFieldGet(this,q)[t].VALUE=e[t];var a=this.getItemById(t);a.updateValue(i.Text.toNumber(e[t]));a.updateColor(be.detectCounterItemColor(babelHelpers.classPrivateFieldGet(this,q)[t].TYPE_NAME,i.Text.toNumber(e[t])))}}function oe(e){var t=parseInt(babelHelpers.classPrivateFieldGet(this,q)[e.id].TYPE_ID,10);if(t>0){var i={userId:babelHelpers.classPrivateFieldGet(this,V).toString(),userName:babelHelpers.classPrivateFieldGet(this,J),counterTypeId:t.toString(),cancel:false};if(babelHelpers.classPrivateFieldGet(this,Q).isActive()){var a=babelHelpers.classPrivateFieldGet(this,Q).getFields(true);if(typeof a[D.COUNTER_TYPE_FIELD]==="undefined"){babelHelpers.classPrivateFieldGet(this,$).presetId=babelHelpers.classPrivateFieldGet(this,Q).getApi().parent.getPreset().getCurrentPresetId();if(babelHelpers.classPrivateFieldGet(this,$).presetId==="tmp_filter"){babelHelpers.classPrivateFieldGet(this,$).fields=a}BX.userOptions.save("crm",babelHelpers.classPrivateFieldGet(this,Z),"",JSON.stringify(babelHelpers.classPrivateFieldGet(this,$)))}BX.onCustomEvent(window,"BX.CrmEntityCounterPanel:applyFilter",[this,i]);if(i.cancel){return false}}else{return false}}return true}function he(){var e=this;if(!babelHelpers.classPrivateFieldGet(this,Q).isActive()){return}Object.entries(babelHelpers.classPrivateFieldGet(this,q)).forEach((function(t){var i=babelHelpers.slicedToArray(t,2),a=i[0],s=i[1];var l=e.getItemById(a);babelHelpers.classPrivateFieldGet(e,Q).isFiltered(babelHelpers.classPrivateFieldGet(e,V),parseInt(s.TYPE_ID,10),babelHelpers.classPrivateFieldGet(e,Y))?l.activate(false):l.deactivate(false);if(l.value!==l.counter.getValue()){l.updateValue(l.value)}}))}function fe(){return this.getItems().every((function(e){return!e.isActive}))}j.EntityCounterPanel=be})(this.BX.Crm=this.BX.Crm||{},BX.UI,BX,BX.Event);
//# sourceMappingURL=script.map.js