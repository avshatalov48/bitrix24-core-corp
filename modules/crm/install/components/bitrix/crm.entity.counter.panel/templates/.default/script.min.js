this.BX=this.BX||{};(function(exports,ui_counterpanel,main_core,main_core_events){"use strict";function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t);t.add(e)}function _classPrivateFieldInitSpec(e,t,a){_checkPrivateRedeclaration(e,t);t.set(e,a)}function _checkPrivateRedeclaration(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet(e,t,a){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return a}var _id=new WeakMap;var _entityTypeId=new WeakMap;var _entityTypeName=new WeakMap;var _serviceUrl=new WeakMap;var _codes=new WeakMap;var _extras=new WeakMap;var _withExcludeUsers=new WeakMap;var _counterData=new WeakMap;var _isRequestRunning=new WeakMap;var _lastPullEventData=new WeakMap;var _isTabActive=new WeakMap;var _bindEvents=new WeakSet;var _onPullEvent=new WeakSet;var _tryRecalculate=new WeakSet;var _startRecalculationRequest=new WeakSet;var _onRecalculationSuccess=new WeakSet;var _fetchCounterData=new WeakSet;var _isRecalculationRequired=new WeakSet;var EntityCounterManager=function(){function e(t){babelHelpers.classCallCheck(this,e);_classPrivateMethodInitSpec(this,_isRecalculationRequired);_classPrivateMethodInitSpec(this,_fetchCounterData);_classPrivateMethodInitSpec(this,_onRecalculationSuccess);_classPrivateMethodInitSpec(this,_startRecalculationRequest);_classPrivateMethodInitSpec(this,_tryRecalculate);_classPrivateMethodInitSpec(this,_onPullEvent);_classPrivateMethodInitSpec(this,_bindEvents);_classPrivateFieldInitSpec(this,_id,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_entityTypeId,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_entityTypeName,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_serviceUrl,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_codes,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_extras,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_withExcludeUsers,{writable:true,value:false});_classPrivateFieldInitSpec(this,_counterData,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_isRequestRunning,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_lastPullEventData,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_isTabActive,{writable:true,value:void 0});if(!main_core.Type.isPlainObject(t)){throw'BX.Crm.EntityCounterManager: The "options" argument must be object.'}babelHelpers.classPrivateFieldSet(this,_id,main_core.Type.isString(t.id)?t.id:"");if(babelHelpers.classPrivateFieldGet(this,_id)===""){throw'BX.Crm.EntityCounterManager: The "id" argument must be specified.'}babelHelpers.classPrivateFieldSet(this,_serviceUrl,main_core.Type.isString(t.serviceUrl)?t.serviceUrl:"");if(babelHelpers.classPrivateFieldGet(this,_serviceUrl)===""){throw'BX.Crm.EntityCounterManager: The "serviceUrl" argument must be specified.'}babelHelpers.classPrivateFieldSet(this,_entityTypeId,t.entityTypeId?main_core.Text.toInteger(t.entityTypeId):0);babelHelpers.classPrivateFieldSet(this,_entityTypeName,BX.CrmEntityType.resolveName(babelHelpers.classPrivateFieldGet(this,_entityTypeId)));babelHelpers.classPrivateFieldSet(this,_codes,main_core.Type.isArray(t.codes)?t.codes:[]);babelHelpers.classPrivateFieldSet(this,_extras,main_core.Type.isObject(t.extras)?t.extras:{});babelHelpers.classPrivateFieldSet(this,_withExcludeUsers,main_core.Type.isBoolean(t.withExcludeUsers)?t.withExcludeUsers:false);babelHelpers.classPrivateFieldSet(this,_counterData,{});babelHelpers.classPrivateFieldSet(this,_isTabActive,true);_classPrivateMethodGet(this,_bindEvents,_bindEvents2).call(this);this.constructor.lastInstance=this}babelHelpers.createClass(e,[{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,_id)}},{key:"getCounterData",value:function e(){return babelHelpers.classPrivateFieldGet(this,_counterData)}},{key:"setCounterData",value:function e(t){babelHelpers.classPrivateFieldSet(this,_counterData,t)}}],[{key:"getLastInstance",value:function e(){return this.lastInstance}}]);return e}();function _bindEvents2(){var e=this;main_core_events.EventEmitter.subscribe("onPullEvent-main",_classPrivateMethodGet(this,_onPullEvent,_onPullEvent2).bind(this));main_core.Event.ready((function(){main_core.Event.bind(document,"visibilitychange",(function(){babelHelpers.classPrivateFieldSet(e,_isTabActive,document.visibilityState==="visible");if(babelHelpers.classPrivateFieldGet(e,_isTabActive)&&_classPrivateMethodGet(e,_isRecalculationRequired,_isRecalculationRequired2).call(e)){_classPrivateMethodGet(e,_tryRecalculate,_tryRecalculate2).call(e,babelHelpers.classPrivateFieldGet(e,_lastPullEventData))}}))}))}function _onPullEvent2(e){var t=e.getData(),a=babelHelpers.slicedToArray(t,2),i=a[0],r=a[1];if(i!=="user_counter"){return}babelHelpers.classPrivateFieldSet(this,_lastPullEventData,r);_classPrivateMethodGet(this,_tryRecalculate,_tryRecalculate2).call(this,r)}function _tryRecalculate2(e){var t=false;var a=false;var i=_classPrivateMethodGet(this,_fetchCounterData,_fetchCounterData2).call(this,e);for(var r in i){if(!i.hasOwnProperty(r)||babelHelpers.classPrivateFieldGet(this,_codes).indexOf(r)<0){continue}var s=BX.prop.getInteger(i,r,0);if(s<0){a=true;break}var l=BX.prop.getInteger(babelHelpers.classPrivateFieldGet(this,_counterData),r,0);if(l!==s){t=true;babelHelpers.classPrivateFieldGet(this,_counterData)[r]=s}}if(a){_classPrivateMethodGet(this,_startRecalculationRequest,_startRecalculationRequest2).call(this)}if(t){main_core_events.EventEmitter.emit(this,"BX.Crm.EntityCounterManager:onRecalculate")}}function _startRecalculationRequest2(){if(babelHelpers.classPrivateFieldGet(this,_isRequestRunning)){return}if(!babelHelpers.classPrivateFieldGet(this,_isTabActive)){return}babelHelpers.classPrivateFieldSet(this,_isRequestRunning,true);main_core.ajax.runAction("crm.counter.list",{data:{entityTypeId:babelHelpers.classPrivateFieldGet(this,_entityTypeId),extras:babelHelpers.classPrivateFieldGet(this,_extras),withExcludeUsers:babelHelpers.classPrivateFieldGet(this,_withExcludeUsers)?1:0}}).then(_classPrivateMethodGet(this,_onRecalculationSuccess,_onRecalculationSuccess2).bind(this))}function _onRecalculationSuccess2(e){babelHelpers.classPrivateFieldSet(this,_isRequestRunning,false);var t=main_core.Type.isPlainObject(e.data)?e.data:null;if(t===null){return}this.setCounterData(t);main_core_events.EventEmitter.emit("BX.Crm.EntityCounterManager:onRecalculate",this)}function _fetchCounterData2(e){var t=main_core.Loc.getMessage("SITE_ID");return main_core.Type.isPlainObject(e[t])?e[t]:{}}function _isRecalculationRequired2(){if(!babelHelpers.classPrivateFieldGet(this,_lastPullEventData)){return false}var e=_classPrivateMethodGet(this,_fetchCounterData,_fetchCounterData2).call(this,babelHelpers.classPrivateFieldGet(this,_lastPullEventData));return Object.values(e).includes(-1)}babelHelpers.defineProperty(EntityCounterManager,"lastInstance",null);var EntityCounterType=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(EntityCounterType,"UNDEFINED",0);babelHelpers.defineProperty(EntityCounterType,"IDLE",1);babelHelpers.defineProperty(EntityCounterType,"PENDING",2);babelHelpers.defineProperty(EntityCounterType,"OVERDUE",4);babelHelpers.defineProperty(EntityCounterType,"INCOMING_CHANNEL",8);babelHelpers.defineProperty(EntityCounterType,"READY_TODO",16);babelHelpers.defineProperty(EntityCounterType,"CURRENT",20);babelHelpers.defineProperty(EntityCounterType,"ALL_DEADLINE_BASED",7);babelHelpers.defineProperty(EntityCounterType,"ALL",31);babelHelpers.defineProperty(EntityCounterType,"IDLE_NAME","IDLE");babelHelpers.defineProperty(EntityCounterType,"PENDING_NAME","PENDING");babelHelpers.defineProperty(EntityCounterType,"OVERDUE_NAME","OVERDUE");babelHelpers.defineProperty(EntityCounterType,"READY_TODO_NAME","READYTODO");babelHelpers.defineProperty(EntityCounterType,"CURRENT_NAME","CURRENT");babelHelpers.defineProperty(EntityCounterType,"INCOMING_CHANNEL_NAME","INCOMINGCHANNEL");babelHelpers.defineProperty(EntityCounterType,"ALL_DEADLINE_BASED_NAME","ALLDEADLINEBASED");babelHelpers.defineProperty(EntityCounterType,"ALL_NAME","ALL");function _classPrivateMethodInitSpec$1(e,t){_checkPrivateRedeclaration$1(e,t);t.add(e)}function _classPrivateFieldInitSpec$1(e,t,a){_checkPrivateRedeclaration$1(e,t);t.set(e,a)}function _checkPrivateRedeclaration$1(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$1(e,t,a){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return a}var _filterManager=new WeakMap;var _fields=new WeakMap;var _isActive=new WeakMap;var _bindEvents$1=new WeakSet;var _onFilterApply=new WeakSet;var _isFilteredByField=new WeakSet;var EntityCounterFilterManager=function(){function e(){babelHelpers.classCallCheck(this,e);_classPrivateMethodInitSpec$1(this,_isFilteredByField);_classPrivateMethodInitSpec$1(this,_onFilterApply);_classPrivateMethodInitSpec$1(this,_bindEvents$1);_classPrivateFieldInitSpec$1(this,_filterManager,{writable:true,value:void 0});_classPrivateFieldInitSpec$1(this,_fields,{writable:true,value:void 0});_classPrivateFieldInitSpec$1(this,_isActive,{writable:true,value:true});var t=main_core.Type.isObject(BX.Main.filterManager)&&BX.Main.filterManager.hasOwnProperty("getList")?BX.Main.filterManager.getList():Object.values(BX.Main.filterManager.data);if(t.length===0){console.warn("BX.Crm.EntityCounterFilter: Unable to define filter.");babelHelpers.classPrivateFieldSet(this,_isActive,false)}else{babelHelpers.classPrivateFieldSet(this,_filterManager,t[0]);_classPrivateMethodGet$1(this,_bindEvents$1,_bindEvents2$1).call(this);this.updateFields()}}babelHelpers.createClass(e,[{key:"getManager",value:function e(){return babelHelpers.classPrivateFieldGet(this,_filterManager)}},{key:"isActive",value:function e(){return babelHelpers.classPrivateFieldGet(this,_isActive)}},{key:"getFields",value:function e(){var t=this;var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(a){var i=Object.entries(babelHelpers.classPrivateFieldGet(this,_fields)).filter((function(e){var a=babelHelpers.slicedToArray(e,2),i=a[0],r=a[1];return _classPrivateMethodGet$1(t,_isFilteredByField,_isFilteredByField2).call(t,i)}));return Object.fromEntries(i)}return babelHelpers.classPrivateFieldGet(this,_fields)}},{key:"getApi",value:function e(){return babelHelpers.classPrivateFieldGet(this,_filterManager).getApi()}},{key:"updateFields",value:function e(){babelHelpers.classPrivateFieldSet(this,_fields,babelHelpers.classPrivateFieldGet(this,_filterManager).getFilterFieldsValues())}},{key:"isFilteredByFieldEx",value:function e(t){if(!Object.keys(babelHelpers.classPrivateFieldGet(this,_fields)).includes(t)||t.endsWith("_datesel")||t.endsWith("_numsel")||t.endsWith("_label")){return false}return _classPrivateMethodGet$1(this,_isFilteredByField,_isFilteredByField2).call(this,t)}},{key:"isFiltered",value:function t(a,i,r,s){var l=this;if(a===0||i===EntityCounterType.UNDEFINED){return false}var n=r===BX.CrmEntityType.enumeration.order?"RESPONSIBLE_ID":"ASSIGNED_BY_ID";var c=this.isFilteredByFieldEx(n)&&main_core.Type.isArray(babelHelpers.classPrivateFieldGet(this,_fields)[n])&&babelHelpers.classPrivateFieldGet(this,_fields)[n].length===1&&(s?babelHelpers.classPrivateFieldGet(this,_fields)[n][0]===e.FILTER_OTHER_USERS:parseInt(babelHelpers.classPrivateFieldGet(this,_fields)[n][0],10)===a);var o=this.isFilteredByFieldEx(e.COUNTER_TYPE_FIELD)&&main_core.Type.isObject(babelHelpers.classPrivateFieldGet(this,_fields)[e.COUNTER_TYPE_FIELD]);var d=o?Object.values(babelHelpers.classPrivateFieldGet(this,_fields)[e.COUNTER_TYPE_FIELD]).map((function(e){return parseInt(e,10)})).sort():[];var _=d.length===1&&d[0]===i||d.length===2&&i===EntityCounterType.CURRENT&&d[0]===EntityCounterType.READY_TODO&&d[1]===EntityCounterType.OVERDUE;var p=[n,e.COUNTER_TYPE_FIELD].concat(babelHelpers.toConsumableArray(e.EXCLUDED_FIELDS));var b=Object.keys(babelHelpers.classPrivateFieldGet(this,_fields));var v=p.filter((function(e){return!b.includes(e)})).concat(b.filter((function(e){return!p.includes(e)})));var u=v.some((function(e){return l.isFilteredByFieldEx(e)}));return c&&_&&!u}}]);return e}();function _bindEvents2$1(){main_core_events.EventEmitter.subscribe("BX.Main.Filter:apply",_classPrivateMethodGet$1(this,_onFilterApply,_onFilterApply2).bind(this))}function _onFilterApply2(){this.updateFields()}function _isFilteredByField2(e){if(main_core.Type.isArray(babelHelpers.classPrivateFieldGet(this,_fields)[e])){return babelHelpers.classPrivateFieldGet(this,_fields)[e].length>0}if(main_core.Type.isObject(babelHelpers.classPrivateFieldGet(this,_fields)[e])){return Object.values(babelHelpers.classPrivateFieldGet(this,_fields)[e]).length>0}return babelHelpers.classPrivateFieldGet(this,_fields)[e]!==""}babelHelpers.defineProperty(EntityCounterFilterManager,"COUNTER_TYPE_FIELD","ACTIVITY_COUNTER");babelHelpers.defineProperty(EntityCounterFilterManager,"EXCLUDED_FIELDS",["FIND"]);babelHelpers.defineProperty(EntityCounterFilterManager,"FILTER_OTHER_USERS","other-users");function ownKeys(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,i)}return a}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(a),!0).forEach((function(t){babelHelpers.defineProperty(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):ownKeys(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function _classPrivateMethodInitSpec$2(e,t){_checkPrivateRedeclaration$2(e,t);t.add(e)}function _classPrivateFieldInitSpec$2(e,t,a){_checkPrivateRedeclaration$2(e,t);t.set(e,a)}function _checkPrivateRedeclaration$2(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$2(e,t,a){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return a}var namespace=main_core.Reflection.namespace("BX.Crm");var _id$1=new WeakMap;var _entityTypeId$1=new WeakMap;var _entityTypeName$1=new WeakMap;var _userId=new WeakMap;var _userName=new WeakMap;var _codes$1=new WeakMap;var _data=new WeakMap;var _counterManager=new WeakMap;var _filterManager$1=new WeakMap;var _filterLastPresetId=new WeakMap;var _filterLastPreset=new WeakMap;var _bindEvents$2=new WeakSet;var _onActivateItem=new WeakSet;var _onDeactivateItem=new WeakSet;var _onFilterApply$1=new WeakSet;var _onRecalculate=new WeakSet;var _processItemSelection=new WeakSet;var _makeFilterAnalyticsLabel=new WeakSet;var _prepareFilterTypeId=new WeakSet;var _markCounters=new WeakSet;var _isAllDeactivated=new WeakSet;var _deactivateLinkedMenuItem=new WeakSet;var _getParentItemTotalValue=new WeakSet;var EntityCounterPanel=function(e){babelHelpers.inherits(t,e);function t(e){var a;babelHelpers.classCallCheck(this,t);if(!main_core.Type.isPlainObject(e)){throw'BX.Crm.EntityCounterPanel: The "options" argument must be object.'}var i=main_core.Type.isPlainObject(e.data)?e.data:{};var r=main_core.Type.isBoolean(e.withExcludeUsers)?e.withExcludeUsers:false;a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{target:BX(e.id),items:t.getCounterItems(i,e),multiselect:false,title:main_core.Loc.getMessage("NEW_CRM_COUNTER_TITLE_MY")}));_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(a),_getParentItemTotalValue);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(a),_deactivateLinkedMenuItem);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(a),_isAllDeactivated);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(a),_markCounters);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(a),_prepareFilterTypeId);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(a),_makeFilterAnalyticsLabel);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(a),_processItemSelection);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(a),_onRecalculate);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(a),_onFilterApply$1);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(a),_onDeactivateItem);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(a),_onActivateItem);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(a),_bindEvents$2);_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(a),_id$1,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(a),_entityTypeId$1,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(a),_entityTypeName$1,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(a),_userId,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(a),_userName,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(a),_codes$1,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(a),_data,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(a),_counterManager,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(a),_filterManager$1,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(a),_filterLastPresetId,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(babelHelpers.assertThisInitialized(a),_filterLastPreset,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),_id$1,e.id);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),_entityTypeId$1,e.entityTypeId?main_core.Text.toInteger(e.entityTypeId):0);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),_entityTypeName$1,e.entityTypeName);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),_userId,e.userId?main_core.Text.toInteger(e.userId):0);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),_userName,main_core.Type.isStringFilled(e.userName)?e.userName:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),_userId));babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),_codes$1,main_core.Type.isArray(e.codes)?e.codes:[]);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),_data,i);if(BX.CrmEntityType.isDefined(babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),_entityTypeId$1))){babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),_counterManager,new EntityCounterManager({id:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),_id$1),entityTypeId:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),_entityTypeId$1),serviceUrl:main_core.Type.isString(e.serviceUrl)?e.serviceUrl:"",codes:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),_codes$1),extras:main_core.Type.isObject(e.extras)?e.extras:{},withExcludeUsers:r}))}babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),_filterManager$1,new EntityCounterFilterManager);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),_filterLastPresetId,e.filterLastPresetId);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),_filterLastPreset,main_core.Type.isArray(e.filterLastPresetData)?JSON.parse(e.filterLastPresetData[0]):{presetId:null});_classPrivateMethodGet$2(babelHelpers.assertThisInitialized(a),_bindEvents$2,_bindEvents2$2).call(babelHelpers.assertThisInitialized(a),e);return a}babelHelpers.createClass(t,[{key:"init",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"init",this).call(this);_classPrivateMethodGet$2(this,_markCounters,_markCounters2).call(this)}},{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,_id$1)}}],[{key:"getCounterItems",value:function e(a,i){var r=main_core.Type.isBoolean(i.withExcludeUsers)?i.withExcludeUsers:false;var s=main_core.Type.isStringFilled(i.lockedCallback);var l=t.getMenuParentItemId(main_core.Type.isArray(i.codes)?i.codes:[]);var n=[];if(r&&!main_core.Type.isUndefined(l)){var c=0;n=Object.entries(a).map((function(e){var a=babelHelpers.slicedToArray(e,2),i=a[0],r=a[1];if(i.endsWith(t.EXCLUDE_USERS_CODE_SUFFIX)){var s=parseInt(r.VALUE,10);c+=s;var n=t.detectCounterItemColor(r.TYPE_NAME,s);return{id:i,title:main_core.Loc.getMessage("NEW_CRM_COUNTER_TYPE_OTHER_"+r.TYPE_NAME),value:s,color:n==="THEME"?"GRAY":n,parentId:l}}}),this);n=[{id:l,title:main_core.Loc.getMessage("NEW_CRM_COUNTER_TYPE_OTHER_TITLE"),value:c,isRestricted:s,color:"THEME"}].concat(n)}var o=Object.entries(a).map((function(e){var a=babelHelpers.slicedToArray(e,2),i=a[0],r=a[1];if(!i.endsWith(t.EXCLUDE_USERS_CODE_SUFFIX)){var l=parseInt(r.VALUE,10);return{id:i,title:main_core.Loc.getMessage("NEW_CRM_COUNTER_TYPE_"+r.TYPE_NAME),value:l,isRestricted:s,color:t.detectCounterItemColor(r.TYPE_NAME,l)}}}),this);return o.concat(n).filter((function(e){return main_core.Type.isObject(e)}))}},{key:"getMenuParentItemId",value:function e(a){return a.find((function(e){return e.endsWith(t.EXCLUDE_ALL_USERS_CODE_SUFFIX)}))}},{key:"detectCounterItemColor",value:function e(t,a){var i=[EntityCounterType.IDLE_NAME,EntityCounterType.OVERDUE_NAME,EntityCounterType.CURRENT_NAME].includes(t);var r=[EntityCounterType.INCOMING_CHANNEL_NAME].includes(t);return a>0?i?"DANGER":r?"SUCCESS":"THEME":"THEME"}}]);return t}(ui_counterpanel.CounterPanel);function _bindEvents2$2(options){if(main_core.Type.isStringFilled(options.lockedCallback)){BX.bind(BX(options.id),"click",(function(){eval(options.lockedCallback)}))}else{main_core_events.EventEmitter.subscribe("BX.UI.CounterPanel.Item:activate",_classPrivateMethodGet$2(this,_onActivateItem,_onActivateItem2).bind(this));main_core_events.EventEmitter.subscribe("BX.UI.CounterPanel.Item:deactivate",_classPrivateMethodGet$2(this,_onDeactivateItem,_onDeactivateItem2).bind(this));main_core_events.EventEmitter.subscribe("BX.Main.Filter:apply",_classPrivateMethodGet$2(this,_onFilterApply$1,_onFilterApply2$1).bind(this));main_core_events.EventEmitter.subscribe("BX.Crm.EntityCounterManager:onRecalculate",_classPrivateMethodGet$2(this,_onRecalculate,_onRecalculate2).bind(this))}}function _onActivateItem2(e){var t=e.getData();if(!_classPrivateMethodGet$2(this,_processItemSelection,_processItemSelection2).call(this,t)){return BX.PreventDefault(e)}}function _onDeactivateItem2(e){_classPrivateMethodGet$2(this,_deactivateLinkedMenuItem,_deactivateLinkedMenuItem2).call(this,e.getData());if(_classPrivateMethodGet$2(this,_isAllDeactivated,_isAllDeactivated2).call(this)&&babelHelpers.classPrivateFieldGet(this,_filterManager$1).isActive()){var t=babelHelpers.classPrivateFieldGet(this,_filterManager$1).getApi();if(babelHelpers.classPrivateFieldGet(this,_filterLastPreset).presetId==="tmp_filter"){t.setFields(babelHelpers.classPrivateFieldGet(this,_filterLastPreset).fields);t.apply()}else{t.setFilter({preset_id:babelHelpers.classPrivateFieldGet(this,_filterLastPreset).presetId})}}}function _onFilterApply2$1(){if(babelHelpers.classPrivateFieldGet(this,_filterManager$1).isActive()){babelHelpers.classPrivateFieldGet(this,_filterManager$1).updateFields()}_classPrivateMethodGet$2(this,_markCounters,_markCounters2).call(this)}function _onRecalculate2(){var e=BX.SidePanel.Instance.getTopSlider()===null;var t=babelHelpers.classPrivateFieldGet(this,_counterManager).getCounterData();var a=this.getItemById(EntityCounterPanel.getMenuParentItemId(babelHelpers.classPrivateFieldGet(this,_codes$1)));for(var i in t){if(!t.hasOwnProperty(i)||!(i.indexOf("crm")===0&&t[i]>=0)||!babelHelpers.classPrivateFieldGet(this,_data).hasOwnProperty(i)||main_core.Text.toNumber(babelHelpers.classPrivateFieldGet(this,_data)[i].VALUE)===main_core.Text.toNumber(t[i])){continue}babelHelpers.classPrivateFieldGet(this,_data)[i].VALUE=t[i];var r=this.getItemById(i);r.updateValue(main_core.Text.toNumber(t[i]));r.updateColor(EntityCounterPanel.detectCounterItemColor(babelHelpers.classPrivateFieldGet(this,_data)[i].TYPE_NAME,main_core.Text.toNumber(t[i])))}if(a){a.updateValue(_classPrivateMethodGet$2(this,_getParentItemTotalValue,_getParentItemTotalValue2).call(this))}}function _processItemSelection2(e){var t=e.id.endsWith(EntityCounterPanel.EXCLUDE_USERS_CODE_SUFFIX);var a=parseInt(babelHelpers.classPrivateFieldGet(this,_data)[e.id].TYPE_ID,10);if(a>0){if(babelHelpers.classPrivateFieldGet(this,_filterManager$1).isActive()){var i=babelHelpers.classPrivateFieldGet(this,_filterManager$1).getFields(true);if(typeof i[EntityCounterFilterManager.COUNTER_TYPE_FIELD]==="undefined"){babelHelpers.classPrivateFieldGet(this,_filterLastPreset).presetId=babelHelpers.classPrivateFieldGet(this,_filterManager$1).getApi().parent.getPreset().getCurrentPresetId();if(babelHelpers.classPrivateFieldGet(this,_filterLastPreset).presetId==="tmp_filter"){babelHelpers.classPrivateFieldGet(this,_filterLastPreset).fields=i}BX.userOptions.save("crm",babelHelpers.classPrivateFieldGet(this,_filterLastPresetId),"",JSON.stringify(babelHelpers.classPrivateFieldGet(this,_filterLastPreset)))}var r=t?EntityCounterFilterManager.FILTER_OTHER_USERS:babelHelpers.classPrivateFieldGet(this,_userId).toString();var s=t?main_core.Loc.getMessage("NEW_CRM_COUNTER_TYPE_OTHER"):babelHelpers.classPrivateFieldGet(this,_userName);var l=_classPrivateMethodGet$2(this,_prepareFilterTypeId,_prepareFilterTypeId2).call(this,a);var n=babelHelpers.classPrivateFieldGet(this,_filterManager$1).getApi();var c={ACTIVITY_COUNTER:BX.Type.isPlainObject(l)?l:{0:l}};if(babelHelpers.classPrivateFieldGet(this,_entityTypeId$1)===BX.CrmEntityType.enumeration.order){c=_objectSpread(_objectSpread({},c),{},{RESPONSIBLE_ID:{0:r},RESPONSIBLE_ID_label:[s]})}else{c=_objectSpread(_objectSpread({},c),{},{ASSIGNED_BY_ID:{0:r},ASSIGNED_BY_ID_label:[s]})}n.setFields(c);n.apply({COUNTER:_classPrivateMethodGet$2(this,_makeFilterAnalyticsLabel,_makeFilterAnalyticsLabel2).call(this,l)})}else{return false}}return true}function _makeFilterAnalyticsLabel2(e){if(babelHelpers.classPrivateFieldGet(this,_entityTypeName$1)&&e){return"CRM_"+babelHelpers.classPrivateFieldGet(this,_entityTypeName$1)+"_COUNTER_TYPE_"+e}return""}function _prepareFilterTypeId2(e){if(e===EntityCounterType.CURRENT){return{0:EntityCounterType.OVERDUE.toString(),1:EntityCounterType.READY_TODO.toString()}}return e.toString()}function _markCounters2(){var e=this;if(!babelHelpers.classPrivateFieldGet(this,_filterManager$1).isActive()){return}var t=this.getItemById(EntityCounterPanel.getMenuParentItemId(babelHelpers.classPrivateFieldGet(this,_codes$1)));var a=false;Object.entries(babelHelpers.classPrivateFieldGet(this,_data)).forEach((function(t){var i=babelHelpers.slicedToArray(t,2),r=i[0],s=i[1];var l=e.getItemById(r);var n=l.id.endsWith(EntityCounterPanel.EXCLUDE_USERS_CODE_SUFFIX);if(babelHelpers.classPrivateFieldGet(e,_filterManager$1).isFiltered(babelHelpers.classPrivateFieldGet(e,_userId),parseInt(s.TYPE_ID,10),babelHelpers.classPrivateFieldGet(e,_entityTypeId$1),n)){l.activate(false);if(n){a=true}}else{l.deactivate(false)}if(l.value!==l.counter.getValue()){l.updateValue(l.value)}}));if(t){a?t.activate(false):t.deactivate(false)}}function _isAllDeactivated2(){return this.getItems().every((function(e){return!e.isActive}))}function _deactivateLinkedMenuItem2(e){var t=this;if(e.hasParentId()){var a=this.getItemById(EntityCounterPanel.getMenuParentItemId(babelHelpers.classPrivateFieldGet(this,_codes$1)));a.deactivate(false);return}if(e.parent){e.getItems().forEach((function(e){var a=t.getItemById(e);if(a.isActive){a.deactivate(false)}}))}}function _getParentItemTotalValue2(){var e=0;this.getItems().forEach((function(t){if(t.hasParentId()){e+=t.value}}));return e}babelHelpers.defineProperty(EntityCounterPanel,"EXCLUDE_USERS_CODE_SUFFIX","excl");babelHelpers.defineProperty(EntityCounterPanel,"EXCLUDE_ALL_USERS_CODE_SUFFIX","all_excl");namespace.EntityCounterPanel=EntityCounterPanel})(this.BX.Crm=this.BX.Crm||{},BX.UI,BX,BX.Event);
//# sourceMappingURL=script.map.js