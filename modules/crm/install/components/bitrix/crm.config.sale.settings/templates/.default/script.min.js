BX.CrmSaleSettings=function(){var t=function(t){this.randomString=t.randomString;this.tabs=null;this.ajaxUrl=t.ajaxUrl;this.data=t.data;this.oldData=BX.clone(this.data);this.max_sort={};this.requestIsRunning=false;this.totalNumberFields=t.totalNumberFields;this.checkSubmit=false;this.defaultColor="#ACE9FB";this.defaultFinalSuccessColor="#DBF199";this.defaultFinalUnSuccessColor="#FFBEBD";this.defaultLineColor="#D3EEF9";this.textColorLight="#FFF";this.textColorDark="#545C69";this.entityId=t.entityId;this.hasSemantics=!!t.hasSemantics;this.isDestroySidePanel=!!t.isDestroySidePanel;this.jsClass="CrmSaleSettings_"+t.randomString;this.contentIdPrefix="content_";this.contentClass="crm-status-content";this.contentActiveClass="crm-status-content active";this.fieldNameIdPrefix="field-name-";this.fieldEditNameIdPrefix="field-edit-name-";this.fieldHiddenNameIdPrefix="field-hidden-name-";this.spanStoringNameIdPrefix="field-title-inner-";this.mainDivStorageFieldIdPrefix="field-phase-";this.fieldSortHiddenIdPrefix="field-sort-";this.fieldHiddenNumberIdPrefix="field-number-";this.extraStorageFieldIdPrefix="extra-storage-";this.finalSuccessStorageFieldIdPrefix="final-success-storage-";this.finalStorageFieldIdPrefix="final-storage-";this.previouslyScaleIdPrefix="previously-scale-";this.previouslyScaleNumberIdPrefix="previously-scale-number-";this.previouslyScaleFinalSuccessIdPrefix="previously-scale-final-success-";this.previouslyScaleNumberFinalSuccessIdPrefix="previously-scale-number-final-success-";this.previouslyScaleFinalUnSuccessIdPrefix="previously-scale-final-un-success-";this.previouslyScaleNumberFinalUnSuccessIdPrefix="previously-scale-number-final-un-success-";this.previouslyScaleFinalCellIdPrefix="previously-scale-final-cell-";this.previouslyScaleNumberFinalCellIdPrefix="previously-scale-number-final-cell-";this.funnelSuccessIdPrefix="config-funnel-success-";this.funnelUnSuccessIdPrefix="config-funnel-unsuccess-";this.successFields=t.successFields;this.unSuccessFields=t.unSuccessFields;this.initialFields=t.initialFields;this.extraFields=t.extraFields;this.finalFields=t.finalFields;this.extraFinalFields=t.extraFinalFields;this.dataFunnel=[];this.colorFunnel=[];this.initAmChart=false;this.footer=BX("crm-configs-footer");this.windowSize={};this.scrollPosition={};this.contentPosition={};this.footerPosition={};this.limit=0;this.footerFixed=true;this.blockFixed=!!t.blockFixed;this.initAmCharts();this.showError();this.init()};t.prototype.selectTab=function(e){var i=BX(this.contentIdPrefix+e);if(i.className==this.contentActiveClass)return;for(var s=0,n=this.tabs.length;s<n;s++){var a=BX(this.contentIdPrefix+this.tabs[s]);if(a.className==this.contentActiveClass){this.showTab(this.tabs[s],false);a.className=this.contentClass;break}}this.showTab(e,true);i.className=this.contentActiveClass;BX("ACTIVE_TAB").value="status_tab_"+e;this.entityId=e;this.hasSemantics=t.hasSemantics(this.entityId);this.processingFooter();if(this.hasSemantics){AmCharts.handleLoad()}};t.prototype.showTab=function(t,e){var i=e?"status_tab_active":"";BX("status_tab_"+t).className="status_tab "+i};t.prototype.statusReset=function(){BX("ACTION").value="reset";document.forms["crmStatusForm"].submit()};t.prototype.destroySidePanel=function(){if(top.BX.SidePanel.Instance){if(top.BX.SidePanel.Instance.getTopSlider()){BX.addCustomEvent(top.BX.SidePanel.Instance.getTopSlider().getWindow(),"SidePanel.Slider:onClose",function(t){top.BX.SidePanel.Instance.destroy(t.getSlider().getUrl())})}top.BX.SidePanel.Instance.close()}};t.prototype.recoveryName=function(t,e){var i=this.searchElement("input",this.fieldHiddenNumberIdPrefix+t),s=this.searchElement("span",this.fieldNameIdPrefix+t),n=this.searchElement("input",this.fieldHiddenNameIdPrefix+t);s.innerHTML=BX.util.htmlspecialchars(i.value+". "+e);n.value=e;this.data[this.entityId][t].NAME=e;if(this.initAmChart){this.recalculateSort()}};t.prototype.editField=function(t){var e,i=this.searchElement("div",this.mainDivStorageFieldIdPrefix+t),s=this.searchElement("span",this.spanStoringNameIdPrefix+t),n=this.searchElement("span",this.fieldNameIdPrefix+t),a=this.searchElement("input",this.fieldHiddenNameIdPrefix+t);if(!a){return}e=BX.create("span",{props:{className:"transaction-stage-phase-title-input-container"},children:[BX.create("input",{props:{id:this.fieldEditNameIdPrefix+t},attrs:{type:"text",value:a.value,onkeydown:"if (event.keyCode==13) {BX['"+this.jsClass+"'].saveFieldValue(\""+t+'", this);}',onblur:"BX['"+this.jsClass+"'].saveFieldValue(\""+t+'", this);',"data-onblur":"1"}})]});s.style.width="100%";i.setAttribute("ondblclick","");n.innerHTML="";n.appendChild(e);var r=this.searchElement("input",this.fieldEditNameIdPrefix+t);r.focus();r.selectionStart=BX(this.fieldEditNameIdPrefix+t+"").value.length};t.prototype.openPopupBeforeDeleteField=function(t){if(isNaN(parseInt(t))){this.deleteField(t);return}var e="";if(this.hasSemantics){e=BX.message("CRM_STATUS_DELETE_FIELD_QUESTION")}if(!BX.type.isNotEmptyString(e)){e=BX.message("CRM_STATUS_DELETE_FIELD_QUESTION")}var i=BX.create("p",{props:{className:"bx-crm-popup-paragraph"},html:e});this.modalWindow({modalId:"bx-crm-popup",title:BX.message("CRM_STATUS_CONFIRMATION_DELETE_TITLE"),overlay:false,content:[i],events:{onPopupClose:function(){this.destroy()},onAfterPopupShow:function(t){var e=BX.findChild(t.contentContainer,{className:"bx-crm-popup-title"},true);if(e){e.style.cursor="move";BX.bind(e,"mousedown",BX.proxy(t._startDrag,t))}}},buttons:[BX.create("a",{text:BX.message("CRM_STATUS_CONFIRMATION_DELETE_CANCEL_BUTTON"),props:{className:"webform-small-button webform-small-button-accept"},events:{click:BX.delegate(function(t){BX.PopupWindowManager.getCurrentPopup().close()},this)}}),BX.create("a",{text:BX.message("CRM_STATUS_CONFIRMATION_DELETE_SAVE_BUTTON"),props:{className:"webform-small-button webform-button-cancel"},events:{click:BX.delegate(function(e){this.deleteField(t);BX.PopupWindowManager.getCurrentPopup().close()},this)}})]})};t.prototype.deleteField=function(t){var e=this.searchElement("div",this.mainDivStorageFieldIdPrefix+t),i=e.parentNode;var s=BX.create("input",{attrs:{type:"hidden",value:t,name:"LIST["+this.entityId+"][REMOVE]["+t+"][FIELD_ID]"}});BX(this.contentIdPrefix+this.entityId).appendChild(s);i.removeChild(e);this.recalculateSort()};t.prototype.modalWindow=function(t){t=t||{};t.title=t.title||false;t.bindElement=t.bindElement||null;t.overlay=typeof t.overlay=="undefined"?true:t.overlay;t.autoHide=t.autoHide||false;t.closeIcon=typeof t.closeIcon=="undefined"?{right:"20px",top:"10px"}:t.closeIcon;t.modalId=t.modalId||"crm"+(Math.random()*(2e5-100)+100);t.withoutContentWrap=typeof t.withoutContentWrap=="undefined"?false:t.withoutContentWrap;t.contentClassName=t.contentClassName||"";t.contentStyle=t.contentStyle||{};t.content=t.content||[];t.buttons=t.buttons||false;t.events=t.events||{};t.withoutWindowManager=!!t.withoutWindowManager||false;var e=[];if(t.title){e.push(BX.create("div",{props:{className:"bx-crm-popup-title"},text:t.title}))}if(t.withoutContentWrap){e=e.concat(t.content)}else{e.push(BX.create("div",{props:{className:"bx-crm-popup-content "+t.contentClassName},style:t.contentStyle,children:t.content}))}var i=[];if(t.buttons){for(var s in t.buttons){if(!t.buttons.hasOwnProperty(s)){continue}if(s>0){i.push(BX.create("SPAN",{html:"&nbsp;"}))}i.push(t.buttons[s])}e.push(BX.create("div",{props:{className:"bx-crm-popup-buttons"},children:i}))}var n=BX.create("div",{props:{className:"bx-crm-popup-container"},children:e});t.events.onPopupShow=BX.delegate(function(){if(i.length){firstButtonInModalWindow=i[0];BX.bind(document,"keydown",BX.proxy(this._keyPress,this))}if(t.events.onPopupShow)BX.delegate(t.events.onPopupShow,BX.proxy_context)},this);var a=t.events.onPopupClose;t.events.onPopupClose=BX.delegate(function(){firstButtonInModalWindow=null;try{BX.unbind(document,"keydown",BX.proxy(this._keypress,this))}catch(t){}if(a){BX.delegate(a,BX.proxy_context)()}if(t.withoutWindowManager){delete windowsWithoutManager[t.modalId]}BX.proxy_context.destroy()},this);var r;if(t.withoutWindowManager){if(!!windowsWithoutManager[t.modalId]){return windowsWithoutManager[t.modalId]}r=new BX.PopupWindow(t.modalId,t.bindElement,{content:n,closeByEsc:true,closeIcon:t.closeIcon,autoHide:t.autoHide,overlay:t.overlay,events:t.events,buttons:[],zIndex:isNaN(t["zIndex"])?0:t.zIndex});windowsWithoutManager[t.modalId]=r}else{r=BX.PopupWindowManager.create(t.modalId,t.bindElement,{content:n,closeByEsc:true,closeIcon:t.closeIcon,autoHide:t.autoHide,overlay:t.overlay,events:t.events,buttons:[],zIndex:isNaN(t["zIndex"])?0:t.zIndex})}r.show();return r};t.prototype.saveFieldValue=function(t,e){var i="",s=e.value,n=this.searchElement("input",this.fieldHiddenNumberIdPrefix+t),a=this.searchElement("span",this.fieldNameIdPrefix+t),r=this.searchElement("div",this.mainDivStorageFieldIdPrefix+t),o=this.searchElement("span",this.spanStoringNameIdPrefix+t),l=this.searchElement("input",this.fieldHiddenNameIdPrefix+t);i+=n.value+". "+s;e.onblur="";if(s==""){if(n.value==1){s=this.data[this.entityId][t].NAME_INIT}else{var d=BX.message("CRM_STATUS_NEW");if(this.hasSemantics){d=BX.message("CRM_STATUS_NEW_"+this.entityId)}s=d}}a.innerHTML=BX.util.htmlspecialchars(i);r.setAttribute("ondblclick",'BX["'+this.jsClass+'"].editField("'+t+'");');o.style.width="";l.value=s;this.data[this.entityId][t].NAME=s;if(this.initAmChart){this.recalculateSort()}};t.prototype.searchElement=function(t,e){var i=BX.findChildren(BX(this.contentIdPrefix+this.entityId),{tag:t,attribute:{id:e}},true);if(i[0]){return i[0]}return null};t.prototype.addField=function(t){var e=t.parentNode,i=1,s=this.defaultColor,n=BX.message("CRM_STATUS_NEW");if(e.id=="final-storage-"+this.entityId){s=this.defaultFinalUnSuccessColor;this.addCellFinalScale()}else{this.addCellMainScale()}for(var a in this.data[this.entityId]){i++}if(this.hasSemantics){n=BX.message("CRM_STATUS_NEW_"+this.entityId)}else{s=this.defaultLineColor}var r="n"+i;this.data[this.entityId][r]={ID:r,SORT:10,NAME:n,ENTITY_ID:this.entityId,COLOR:s};e.insertBefore(this.createStructureHtml(r),t);this.recalculateSort();this.editField(r)};t.prototype.recalculateSort=function(){var t,e;var i=BX.findChildren(BX(this.contentIdPrefix+this.entityId),{tag:"div",attribute:{"data-calculate":"1"}},true);if(!i){return}for(var s=0;s<i.length;s++){e=i[s].parentNode.id;if(e==this.extraStorageFieldIdPrefix+this.entityId){i[s].setAttribute("data-success","1")}else if(e==this.finalStorageFieldIdPrefix+this.entityId){i[s].setAttribute("data-success","0")}var n=s+1;var a=n*10;t=i[s].getAttribute("id").replace(this.mainDivStorageFieldIdPrefix,"");var r=BX.findChildren(i[s],{tag:"input",attribute:{"data-onblur":"1"}},true);if(r.length){this.saveFieldValue(t,r[0])}i[s].setAttribute("data-sort",""+a+"");var o=this.searchElement("span",this.fieldNameIdPrefix+t),l=this.searchElement("input",this.fieldHiddenNameIdPrefix+t),d=this.searchElement("input",this.fieldHiddenNumberIdPrefix+t),h=this.searchElement("input",this.fieldSortHiddenIdPrefix+t);o.innerHTML=BX.util.htmlspecialchars(n+". "+l.value);d.value=n;h.value=a;this.data[this.entityId][t].SORT=a}if(this.initAmChart&&this.hasSemantics){var c=BX.findChildren(BX(this.contentIdPrefix+this.entityId),{tag:"div",attribute:{"data-success":"1"}},true);if(c){this.successFields[this.entityId]=[];for(var u=0;u<c.length;u++){t=c[u].getAttribute("id").replace(this.mainDivStorageFieldIdPrefix,"");this.successFields[this.entityId][u]=this.data[this.entityId][t]}}var f=BX.findChildren(BX(this.contentIdPrefix+this.entityId),{tag:"div",attribute:{"data-success":"0"}},true);if(c){this.unSuccessFields[this.entityId]=[];for(var p=0;p<f.length;p++){t=f[p].getAttribute("id").replace(this.mainDivStorageFieldIdPrefix,"");this.unSuccessFields[this.entityId][p]=this.data[this.entityId][t]}}AmCharts.handleLoad()}this.changeCellScale()};t.prototype.changeCellScale=function(){if(!this.hasSemantics){return}if(!this.successFields[this.entityId]||!this.unSuccessFields[this.entityId]){return}var t=BX.findChildren(BX(this.previouslyScaleIdPrefix+this.entityId),{tag:"td",attribute:{"data-scale-type":"main"}},true),e=BX.findChildren(BX(this.previouslyScaleNumberIdPrefix+this.entityId),{tag:"td",attribute:{"data-scale-type":"main"}},true),i=BX.findChildren(BX(this.previouslyScaleFinalSuccessIdPrefix+this.entityId),{tag:"td"},true),s=BX.findChildren(BX(this.previouslyScaleNumberFinalSuccessIdPrefix+this.entityId),{tag:"td"},true);var n=this.successFields[this.entityId].length-1,a=t.length;if(n>a){for(var r=a;r<n;r++){this.addCellMainScale()}this.changeCellScale();return}else if(n<a){this.deleteCellMainScale(a-n);this.changeCellScale();return}var o,l;for(var d=0;d<n;d++){if(t[d]&&e[d]){if(this.successFields[this.entityId][d].COLOR){l=this.successFields[this.entityId][d].COLOR}else{l=this.defaultColor}t[d].style.background=l;o=d+1;e[d].getElementsByTagName("span")[0].innerHTML=o}}if(i[0]&&s[0]){if(this.successFields[this.entityId][n].COLOR){l=this.successFields[this.entityId][n].COLOR}else{l=this.defaultFinalSuccessColor}o++;i[0].style.background=l;s[0].getElementsByTagName("span")[0].innerHTML=o}var h=BX.findChildren(BX(this.previouslyScaleFinalUnSuccessIdPrefix+this.entityId),{tag:"td"},true),c=BX.findChildren(BX(this.previouslyScaleNumberFinalUnSuccessIdPrefix+this.entityId),{tag:"td"},true);var u=this.unSuccessFields[this.entityId].length,f=h.length;if(u>f){for(var p=f;p<u;p++){this.addCellFinalScale()}this.changeCellScale();return}else if(u<f){this.deleteCellFinalScale(f-u);this.changeCellScale();return}for(var m=0;m<u;m++){if(h[m]&&c[m]){if(this.unSuccessFields[this.entityId][m].COLOR){l=this.unSuccessFields[this.entityId][m].COLOR}else{l=this.defaultFinalUnSuccessColor}h[m].style.background=l;o++;c[m].getElementsByTagName("span")[0].innerHTML=o}}};t.prototype.addCellMainScale=function(){if(!this.hasSemantics){return}var t=BX.findChildren(BX(this.previouslyScaleNumberIdPrefix+this.entityId),{tag:"td",attribute:{"data-scale-type":"main"}},true),e=BX.create("td",{attrs:{"data-scale-type":"main"},html:"&nbsp;"}),i=BX.create("td",{attrs:{"data-scale-type":"main"},children:[BX.create("span",{props:{className:"stage-name"},html:t.length})]});BX(this.previouslyScaleIdPrefix+this.entityId).insertBefore(e,BX(this.previouslyScaleFinalCellIdPrefix+this.entityId));BX(this.previouslyScaleNumberIdPrefix+this.entityId).insertBefore(i,BX(this.previouslyScaleNumberFinalCellIdPrefix+this.entityId))};t.prototype.addCellFinalScale=function(){if(!this.hasSemantics){return}var t=BX.findChildren(BX(this.previouslyScaleNumberFinalUnSuccessIdPrefix+this.entityId),{tag:"td"},true),e=BX.create("td",{html:"&nbsp;"}),i=BX.create("td",{children:[BX.create("span",{props:{className:"stage-name"},html:t.length})]});BX(this.previouslyScaleFinalUnSuccessIdPrefix+this.entityId).appendChild(e);BX(this.previouslyScaleNumberFinalUnSuccessIdPrefix+this.entityId).appendChild(i)};t.prototype.deleteCellMainScale=function(t){if(!this.hasSemantics){return}var e=BX.findChildren(BX(this.previouslyScaleIdPrefix+this.entityId),{tag:"td",attribute:{"data-scale-type":"main"}},true),i=BX.findChildren(BX(this.previouslyScaleNumberIdPrefix+this.entityId),{tag:"td",attribute:{"data-scale-type":"main"}},true);for(var s=0;s<t;s++){BX(this.previouslyScaleIdPrefix+this.entityId).removeChild(e[s]);BX(this.previouslyScaleNumberIdPrefix+this.entityId).removeChild(i[s])}};t.prototype.deleteCellFinalScale=function(t){if(!this.hasSemantics){return}var e=BX.findChildren(BX(this.previouslyScaleFinalUnSuccessIdPrefix+this.entityId),{tag:"td"},true),i=BX.findChildren(BX(this.previouslyScaleNumberFinalUnSuccessIdPrefix+this.entityId),{tag:"td"},true);for(var s=0;s<t;s++){BX(this.previouslyScaleFinalUnSuccessIdPrefix+this.entityId).removeChild(e[s]);BX(this.previouslyScaleNumberFinalUnSuccessIdPrefix+this.entityId).removeChild(i[s])}};t.prototype.createStructureHtml=function(t){var e,i=this.data[this.entityId][t];var s="",n=this.textColorDark,a="",r;if(this.hasSemantics){s="light-icon";n=this.textColorLight;a="transaction-stage-phase-dark";r=BX.create("div",{props:{className:"transaction-stage-phase-panel-button"},attrs:{onclick:'BX["'+this.jsClass+'"].correctionColorPicker(event, "'+i.ID+'");'}})}e=BX.create("div",{props:{id:this.mainDivStorageFieldIdPrefix+i.ID,className:"transaction-stage-phase draghandle"},attrs:{ondblclick:'BX["'+this.jsClass+'"].editField("'+i.ID+'");',"data-sort":i.SORT,"data-calculate":1,"data-space":i.ID,style:"background: "+i.COLOR+"; color:"+n+";"},children:[BX.create("div",{props:{id:"phase-panel",className:a+" transaction-stage-phase-panel"},attrs:{"data-class":"transaction-stage-phase-panel"},children:[r,BX.create("div",{props:{className:"transaction-stage-phase-panel-button "+"transaction-stage-phase-panel-button-close"},attrs:{onclick:'BX["'+this.jsClass+'"].openPopupBeforeDeleteField("'+i.ID+'");'}})]}),BX.create("span",{props:{id:"transaction-stage-phase-icon",className:s+" transaction-stage-phase-icon transaction-stage-phase-icon-move draggable"},attrs:{"data-class":"transaction-stage-phase-icon transaction-stage-phase-icon-move draggable"},children:[BX.create("span",{props:{className:"transaction-stage-phase-icon-burger"}})]}),BX.create("span",{props:{id:"phase-panel",className:a+" transaction-stage-phase-title"},attrs:{"data-class":"transaction-stage-phase-title"},children:[BX.create("span",{props:{id:this.spanStoringNameIdPrefix+i.ID,className:"transaction-stage-phase-title-inner"},children:[BX.create("span",{props:{id:this.fieldNameIdPrefix+i.ID,className:"transaction-stage-phase-name"},html:i.ID+". "+BX.util.htmlspecialchars(i.NAME)}),BX.create("span",{props:{className:"transaction-stage-phase-icon-edit"},attrs:{onclick:'BX["'+this.jsClass+'"].editField("'+i.ID+'")'}})]})]}),BX.create("input",{props:{id:this.fieldHiddenNumberIdPrefix+i.ID},attrs:{type:"hidden",value:i.ID}}),BX.create("input",{props:{id:this.fieldSortHiddenIdPrefix+i.ID},attrs:{type:"hidden",name:"LIST["+this.entityId+"]["+i.ID+"][SORT]",value:i.SORT}}),BX.create("input",{props:{id:this.fieldHiddenNameIdPrefix+i.ID},attrs:{type:"hidden",name:"LIST["+this.entityId+"]["+i.ID+"][VALUE]",value:BX.util.htmlspecialchars(i.NAME)}}),BX.create("input",{props:{id:"stage-color-"+i.ID},attrs:{type:"hidden",name:"LIST["+this.entityId+"]["+i.ID+"][COLOR]",value:i.COLOR}}),BX.create("input",{props:{id:"stage-status-id-"+i.ID},attrs:{type:"hidden",name:"LIST["+this.entityId+"]["+i.ID+"][STATUS_ID]","data-status-id":"1",value:this.getNewStatusId()}})]});return e};t.prototype.getNewStatusId=function(){var t=0;var e=BX.findChildren(BX(this.contentIdPrefix+this.entityId),{tag:"input",attribute:{"data-status-id":"1"}},true);if(!e)return t;for(var i=0;i<e.length;i++){var s=+e[i].value;if(!isNaN(s)){if(s>t){t=s}}}t=t+1;return t};t.prototype.showPlaceToInsert=function(t,e){if(t.className=="space-to-insert draghandle"){return}var i=t.parentNode,s=t.getAttribute("data-space");var n=BX.create("div",{props:{id:"space-to-insert-"+s,className:"space-to-insert draghandle"},attrs:{"data-place":"1"}});var a=getCoords(t);var r=e.pageY-a.top;var o=t.offsetHeight/2;if(r>o){if(t.className=="transaction-stage-addphase draghandle"){return}this.deleteSpaceToInsert();this.insertAfter(n,t)}else{this.deleteSpaceToInsert();i.insertBefore(n,t)}};t.prototype.putDomElement=function(t,e,i){if(!t||!e||!i){return false}e.insertBefore(t,i);return true};t.prototype.deleteSpaceToInsert=function(){var t=BX.findChildren(BX("crm-container"),{tag:"div",attribute:{"data-place":"1"}},true);if(t){for(var e=0;e<t.length;e++){var i=t[e].parentNode;i.removeChild(t[e])}}};t.prototype.insertAfter=function(t,e){if(!t||!e)return;var i=e.parentNode,s=e.nextSibling;if(s&&i){i.insertBefore(t,e.nextSibling)}else if(i){i.appendChild(t)}};t.prototype.checkChanges=function(){if(this.checkSubmit){return}var t=0,e=false;for(var i in this.data){for(var s in this.data[i]){t++;var n=parseInt(this.data[i][s].SORT),a=parseInt(this.oldData[i][s].SORT),r=this.data[i][s].NAME.toLowerCase(),o=this.oldData[i][s].NAME.toLowerCase(),l=this.data[i][s].COLOR.toLowerCase(),d=this.oldData[i][s].COLOR.toLowerCase();if(n!==a||r!==o||l!==d){e=true;break}}}if(this.totalNumberFields!==t||e){return BX.message("CRM_STATUS_CHECK_CHANGES")}};t.prototype.confirmSubmit=function(){this.checkSubmit=true};t.prototype.fixStatuses=function(){if(this.requestIsRunning){return}this.requestIsRunning=true;if(this.ajaxUrl===""){throw"Error: Service URL is not defined."}BX.ajax({url:this.ajaxUrl,method:"POST",dataType:"json",data:{ACTION:"FIX_STATUSES"},onsuccess:BX.delegate(function(){this.requestIsRunning=false;window.location.reload(true)},this),onfailure:BX.delegate(function(){this.requestIsRunning=false},this)})};t.prototype.correctionColorPicker=function(t,e){if(!e){return}var i=BX("block-color-picker");i.style.left=t.pageX+"px";i.style.top=t.pageY+"px";var s=BX.findChildren(BX("block-color-picker"),{tag:"IMG"},true)[0];s.setAttribute("data-img",e);s.onclick()};t.prototype.paintElement=function(t,e){if(!e){return}var i=e.pWnd.getAttribute("data-img");var s=BX.findChildren(BX(this.contentIdPrefix+this.entityId),{tag:"div",attribute:{id:this.mainDivStorageFieldIdPrefix+i}},true);if(s.length){if(!t&&s[0].parentNode.id==this.finalStorageFieldIdPrefix+this.entityId){t=this.defaultFinalUnSuccessColor}else if(!t&&s[0].parentNode.id==this.finalSuccessStorageFieldIdPrefix+this.entityId){t=this.defaultFinalSuccessColor}else if(!t){t=this.defaultColor}if(!this.hasSemantics){t=this.defaultLineColor}s[0].style.background=t;var n=BX.findChildren(s[0],{tag:"span",attribute:{id:"transaction-stage-phase-icon"}},true);var a=BX.findChildren(s[0],{attribute:{id:"phase-panel"}},true);if(n.length&&a.length){BX.ajax({url:this.ajaxUrl,method:"POST",dataType:"json",data:{ACTION:"GET_COLOR",COLOR:t},onsuccess:BX.delegate(function(t){s[0].style.color=t.COLOR;n[0].className=t.ICON_CLASS+" "+n[0].getAttribute("data-class");for(var e in a){a[e].className=t.BLOCK_CLASS+" "+a[e].getAttribute("data-class")}},this)})}}else{return}var r=BX.findChildren(BX(this.contentIdPrefix+this.entityId),{tag:"input",attribute:{id:"stage-color-"+i}},true);if(r[0]){r[0].value=t}this.data[this.entityId][i].COLOR=t;this.recalculateSort()};t.prototype.initAmCharts=function(){if(this.hasSemantics){this.initAmChart=true;if(AmCharts.isReady){this.renderAmCharts()}else{AmCharts.ready(BX.delegate(this.renderAmCharts,this))}AmCharts.handleLoad()}};t.prototype.renderAmCharts=function(){var t=[];for(var e in this.initialFields){t.push(BX(this.funnelSuccessIdPrefix+e));t.push(BX(this.funnelUnSuccessIdPrefix+e))}if(!t.length){return}for(var i=0;i<t.length;i++){if(!t[i].id)continue;this.getDataForAmCharts(t[i].id);var s=AmCharts.makeChart(t[i].id,{type:"funnel",theme:"none",titleField:"title",valueField:"value",dataProvider:this.dataFunnel,colors:this.colorFunnel,labelsEnabled:false,marginRight:35,marginLeft:35,labelPosition:"center",funnelAlpha:.9,startX:200,neckWidth:"40%",startAlpha:0,depth3D:100,angle:10,outlineAlpha:1,outlineColor:"#FFFFFF",outlineThickness:1,neckHeight:"30%",balloonText:"[[title]]",export:{enabled:true}})}};t.prototype.getDataForAmCharts=function(t){var e=[],i="",s=false;if(t==this.funnelSuccessIdPrefix+this.entityId){e=this.successFields[this.entityId];i=this.defaultColor;s=true}else if(t==this.funnelUnSuccessIdPrefix+this.entityId){e=this.unSuccessFields[this.entityId];i=this.defaultFinalUnSuccessColor}this.dataFunnel=[];this.colorFunnel=[];for(var n=0;n<e.length;n++){if(n==e.length-1&&s){i=this.defaultFinalSuccessColor}this.dataFunnel[n]={title:BX.util.htmlspecialchars(e[n].NAME),value:1};if(e[n].COLOR){this.colorFunnel[n]=e[n].COLOR}else{this.colorFunnel[n]=i}}};t.prototype.showError=function(){var t=this.getParameterByName("ERROR");if(t){var e=BX.create("p",{props:{className:"bx-crm-popup-paragraph"},html:BX.util.htmlspecialchars(t)});this.modalWindow({modalId:"bx-crm-popup",title:BX.message("CRM_STATUS_REMOVE_ERROR"),overlay:false,content:[e],events:{onPopupClose:function(){this.destroy()},onAfterPopupShow:function(t){var e=BX.findChild(t.contentContainer,{className:"bx-crm-popup-title"},true);if(e){e.style.cursor="move";BX.bind(e,"mousedown",BX.proxy(t._startDrag,t))}}},buttons:[BX.create("a",{text:BX.message("CRM_STATUS_CLOSE_POPUP_REMOVE_ERROR"),props:{className:"webform-small-button webform-small-button-accept"},events:{click:BX.delegate(function(t){BX.PopupWindowManager.getCurrentPopup().close()},this)}})]})}};t.prototype.getParameterByName=function(t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var e=new RegExp("[\\?&]"+t+"=([^&#]*)"),i=e.exec(location.search);return i===null?"":decodeURIComponent(i[1].replace(/\+/g," "))};t.prototype.init=function(){if(this.isDestroySidePanel){this.destroySidePanel()}var t=BX("crm-configs-footer");if(!t){return}BX.addCustomEvent(t,"onFooterChangeState",BX.delegate(function(e){if(e){BX.removeClass(t,"crm-configs-footer");BX.addClass(t,"webform-buttons-fixed")}else{BX.addClass(t,"crm-configs-footer");BX.removeClass(t,"webform-buttons-fixed")}},this));BX.bind(window,"scroll",BX.proxy(this.processingFooter,this));this.processingFooter();if(!this.blockFixed){BX.onCustomEvent(this.footer,"onFooterChangeState",[false])}};t.prototype.processingFooter=function(){if(!this.footer||!this.blockFixed){return}this.windowSize=BX.GetWindowInnerSize();this.scrollPosition=BX.GetWindowScrollPos();this.contentPosition=BX.pos(BX(this.contentIdPrefix+this.entityId));this.footerPosition=BX.pos(this.footer);this.limit=this.contentPosition.top;var t=this.scrollPosition.scrollTop+this.windowSize.innerHeight;var e=this.contentPosition.bottom+this.footerPosition.height;if(this.limit>0&&t<this.limit){this.footerFixed=false}else if(!this.footerFixed&&t<e){this.footerFixed=true}else if(this.footerFixed&&t>=e){this.footerFixed=false}BX.onCustomEvent(this.footer,"onFooterChangeState",[this.footerFixed]);var i=parseInt(BX.style(this.footer,"paddingLeft"));this.footer.style.left=this.contentPosition.left+"px";this.footer.style.width=this.contentPosition.width-i*2+"px"};t.prototype.fixFooter=function(t){this.blockFixed=!this.blockFixed;if(this.blockFixed){BX.userOptions.save("crm","crm_config_status","fix_footer","on");BX.addClass(t,"crm-fixedbtn-pin");t.setAttribute("title",BX.message("CRM_STATUS_FOOTER_PIN_OFF"));this.processingFooter()}else{BX.userOptions.save("crm","crm_config_status","fix_footer","off");BX.removeClass(t,"crm-fixedbtn-pin");t.setAttribute("title",BX.message("CRM_STATUS_FOOTER_PIN_ON"));BX.onCustomEvent(this.footer,"onFooterChangeState",[false])}};t.semanticEntityTypes=[];t.hasSemantics=function(t){var e=this.semanticEntityTypes;if(!BX.type.isArray(e)){return false}for(var i=0,s=e.length;i<s;i++){if(e[i]===t){return true}}return false};return t}();(function(){"use strict";BX.namespace("BX.Crm");BX.Crm.CommonSaleSettings=function(t){this.ajaxUrl=t.ajaxUrl;this.isFramePopup=t.isFramePopup==="Y";this.optionPrefix=t.optionPrefix;this.listSiteId=t.listSiteId||[];this.languageId=t.languageId;this.init()};BX.Crm.CommonSaleSettings.prototype.init=function(){this.slider=null;this.formId="common_sale_settings_form";this.applyButtonId="common_sale_settings_apply_button";this.cancelButtonId="common_sale_settings_close_button";this.useStoreControl=null;this.enableReservationControl=null;this.hideNumeratorSettingsControl=null;this.PCDefaultValuesButton=null;this.addressDifferentSet=null;this.addressCurrentSite=null;this.addressCurrentSiteValue=null;this.weightDifferentSet=null;this.weightCurrentSite=null;this.weightUnitTmp={};this.weightUnit={};this.weightKoef={};this.weightCurrentSiteValue=null;this.initSlider();BX.bind(BX(this.applyButtonId),"click",BX.proxy(this.saveSettings,this));this.bindPCDefaultValuesButton();this.bindUseStoreControl();this.bindEnableReservationControl();this.bindHideNumeratorSettingsControl();this.bindAddressControl();this.bindWeightControl()};BX.Crm.CommonSaleSettings.prototype.bindPCDefaultValuesButton=function(){this.PCDefaultValuesButton=BX("product_card_settings");if(this.PCDefaultValuesButton){BX.bind(this.PCDefaultValuesButton,"click",BX.proxy(this.clickPCDefaultValuesButton,this))}};BX.Crm.CommonSaleSettings.prototype.bindUseStoreControl=function(){this.useStoreControl=BX.findChild(BX(this.formId),{attr:{name:this.optionPrefix+"default_use_store_control",type:"checkbox"}},true,false);if(this.useStoreControl){BX.bind(this.useStoreControl,"click",BX.proxy(this.clickUseStoreControl,this))}};BX.Crm.CommonSaleSettings.prototype.bindEnableReservationControl=function(){this.enableReservationControl=BX.findChild(BX(this.formId),{attr:{name:this.optionPrefix+"enable_reservation",type:"checkbox"}},true,false);if(this.enableReservationControl){if(this.useStoreControl&&this.useStoreControl.checked){this.enableReservationControl.disabled=true;this.setEnableReservationHidden("Y")}}};BX.Crm.CommonSaleSettings.prototype.bindHideNumeratorSettingsControl=function(){this.hideNumeratorSettingsControl=BX.findChild(BX(this.formId),{attr:{name:this.optionPrefix+"hideNumeratorSettings",type:"checkbox"}},true,false);if(this.hideNumeratorSettingsControl){BX.bind(this.hideNumeratorSettingsControl,"click",BX.proxy(this.clickHideNumeratorSettingsControl,this));this.clickHideNumeratorSettingsControl()}};BX.Crm.CommonSaleSettings.prototype.bindAddressControl=function(){this.addressDifferentSet=BX("ADDRESS_different_set");this.addressCurrentSite=BX("ADDRESS_current_site");if(!this.addressDifferentSet||!this.addressCurrentSite){return}this.addressCurrentSiteValue=BX.create("input",{props:{type:"hidden",name:"ADDRESS_current_site",value:this.addressCurrentSite.value}});this.addressCurrentSite.parentElement.appendChild(this.addressCurrentSiteValue);BX.bind(this.addressDifferentSet,"change",this.changeAddressDifferentSet.bind(this,this.addressDifferentSet));BX.bind(this.addressCurrentSite,"change",this.changeAddressCurrentSite.bind(this,this.addressCurrentSite))};BX.Crm.CommonSaleSettings.prototype.changeAddressDifferentSet=function(t){if(!this.addressCurrentSite){return}this.addressCurrentSite.disabled=!t.checked;this.setAddressCurrentSite(this.addressCurrentSite.value)};BX.Crm.CommonSaleSettings.prototype.changeAddressCurrentSite=function(t){var e=t.value,i=BX("ADDRESS_block_"+e);if(!i){return}this.setAddressCurrentSite(e);this.listSiteId.forEach(function(t){var e=BX("ADDRESS_block_"+t);if(e){BX.addClass(e,"crm-sale-settings-hidden-mode")}});BX.removeClass(i,"crm-sale-settings-hidden-mode")};BX.Crm.CommonSaleSettings.prototype.setAddressCurrentSite=function(t){if(this.addressCurrentSiteValue){this.addressCurrentSiteValue.value=t}};BX.Crm.CommonSaleSettings.prototype.bindWeightControl=function(){this.weightDifferentSet=BX("WEIGHT_different_set");this.weightCurrentSite=BX("WEIGHT_site_id");if(!this.weightDifferentSet||!this.weightCurrentSite){return}this.weightCurrentSiteValue=BX.create("input",{props:{type:"hidden",name:"WEIGHT_site_id",value:this.weightCurrentSite.value}});this.weightCurrentSite.parentElement.appendChild(this.weightCurrentSiteValue);this.listSiteId.forEach(function(t){this.weightUnitTmp[t]=BX("weight_unit_tmp["+t+"]");this.weightUnit[t]=BX("weight_unit["+t+"]");this.weightKoef[t]=BX("weight_koef["+t+"]")}.bind(this));for(var t in this.weightUnitTmp){if(this.weightUnitTmp.hasOwnProperty(t)){BX.bind(this.weightUnitTmp[t],"change",this.changeWeightUnit.bind(this,this.weightUnitTmp[t],t))}}BX.bind(this.weightDifferentSet,"change",this.changeWeightDifferentSet.bind(this,this.weightDifferentSet));BX.bind(this.weightCurrentSite,"change",this.changeWeightCurrentSite.bind(this,this.weightCurrentSite))};BX.Crm.CommonSaleSettings.prototype.changeWeightDifferentSet=function(t){if(!this.weightCurrentSite){return}this.weightCurrentSite.disabled=!t.checked;this.setWeightCurrentSite(this.weightCurrentSite.value)};BX.Crm.CommonSaleSettings.prototype.changeWeightCurrentSite=function(t){var e=t.value,i=BX("par_WEIGHT_"+e);if(!i){return}this.setWeightCurrentSite(e);this.listSiteId.forEach(function(t){var e=BX("par_WEIGHT_"+t);if(e){BX.addClass(e,"crm-sale-settings-hidden-mode")}});BX.removeClass(i,"crm-sale-settings-hidden-mode")};BX.Crm.CommonSaleSettings.prototype.changeWeightUnit=function(t,e){if(!t.value)return;if(this.weightUnit[e]&&this.weightKoef[e]){this.weightKoef[e].value=t.value;this.weightUnit[e].value=t.options[t.selectedIndex].text}};BX.Crm.CommonSaleSettings.prototype.setWeightCurrentSite=function(t){if(this.weightCurrentSiteValue){this.weightCurrentSiteValue.value=t}};BX.Crm.CommonSaleSettings.prototype.setEnableReservationHidden=function(t){var e=BX.findChild(BX(this.formId),{attr:{name:this.optionPrefix+"enable_reservation",type:"hidden"}},true,false);if(e){e.value=t}};BX.Crm.CommonSaleSettings.prototype.clickPCDefaultValuesButton=function(){this.showProductSettings()};BX.Crm.CommonSaleSettings.prototype.clickHideNumeratorSettingsControl=function(){if(!this.hideNumeratorSettingsControl){return false}var t=this.hideNumeratorSettingsControl.parentElement.parentElement;if(t){var e=t.nextElementSibling;if(this.hideNumeratorSettingsControl.checked){BX.show(e)}else{BX.hide(e)}}};BX.Crm.CommonSaleSettings.prototype.clickUseStoreControl=function(t){var e=t.currentTarget;if(!this.enableReservationControl){this.enableReservationControl=BX.findChild(BX(this.formId),{attr:{name:this.optionPrefix+"enable_reservation",type:"checkbox"}},true,false)}if(!this.enableReservationControl){return}if(e.checked){this.enableReservationControl.checked=true;this.enableReservationControl.disabled=true;this.setEnableReservationHidden("Y")}else{this.enableReservationControl.disabled=false;this.setEnableReservationHidden("N")}};BX.Crm.CommonSaleSettings.prototype.initSlider=function(){if(!this.isFramePopup){return}this.slider={bindClose:function(t){BX.bind(t,"click",this.close)},close:function(){window.top.BX.SidePanel.Instance.close()},open:function(t){window.top.BX.SidePanel.Instance.open(t)},reload:function(){var t=window.top.BX.SidePanel.Instance.getTopSlider();t.getWindow().location.reload()},reloadList:function(){window.top.BX.SidePanel.Instance.close();window.top.location.reload()}};this.slider.bindClose(BX(this.cancelButtonId))};BX.Crm.CommonSaleSettings.prototype.saveSettings=function(){BX.ajax.runComponentAction("bitrix:crm.config.sale.settings","saveCommonSettings",{mode:"class",data:new FormData(BX(this.formId))}).then(function(t){top.BX.UI.Notification.Center.notify({content:BX.message("CRM_SALE_SETTINGS_SAVE_SUCCESS")});if(this.slider){this.slider.close()}}.bind(this),function(t){}.bind(this))};BX.Crm.CommonSaleSettings.prototype.showProductSettings=function(){var t,e;e={sessid:BX.bitrix_sessid(),public_mode:"Y"};var i={title:BX.message("CRM_SALE_SETTINGS_BUTTON_CLOSE"),id:"close",name:"close",action:function(){this.parentWindow.Close()}};t=new BX.CAdminDialog({title:BX.message("CRM_SALE_PRODUCT_SETTINGS_TITLE"),content_url:"/bitrix/tools/catalog/product_settings.php?lang="+this.languageId,content_post:e,draggable:true,resizable:true,buttons:[i]});t.Show();BX.addCustomEvent(t,"onWindowClose",function(){if(this.slider){this.slider.reload()}else{window.top.location.reload()}}.bind(this));return false}})();