(function(){var t=BX.namespace("BX.Crm.Tracking");if(t.Expenses){return}function e(){}e.prototype.init=function(t){this.gridId=t.gridId;this.componentName=t.componentName;this.signedParameters=t.signedParameters;this.sourceId=t.sourceId;this.sourceName=t.sourceName;this.mess=t.mess;BX.bind(BX("crm-tracking-expenses-add"),"click",this.showAddPopup.bind(this));var e=BX("crm-tracking-expenses-popup");this.uiNodes={popup:e,actionsCheckbox:this.getNode("actions/checkbox",e),actionsCheckboxData:this.getNode("actions/checkbox/data",e),actionsCont:this.getNode("actions/cont",e),actionsData:this.getNode("actions/data",e),commentData:this.getNode("comment/data",e),currency:this.getNode("currency",e),currencyData:this.getNode("currency/data",e),sum:this.getNode("sum",e),sumData:this.getNode("sum/data",e),fromData:this.getNode("from/data",e),fromView:this.getNode("from/view",e),from:this.getNode("from",e),toData:this.getNode("to/data",e),toView:this.getNode("to/view",e),to:this.getNode("to",e)}};e.prototype.getNode=function(t,e){var s=(e||document.body).querySelector('[data-role="crm/tracking/'+t+'"]');return s?s:null};e.prototype.onAdd=function(){if(!this.checkFieldsBeforeAdd()){return}this.request("addExpenses",{sourceId:this.sourceId,from:this.uiNodes.fromData.value,to:this.uiNodes.toData.value,sum:this.uiNodes.sumData.value,currencyId:this.uiNodes.currencyData.value,actions:this.uiNodes.actionsData.value,comment:this.uiNodes.commentData.value},function(){BX.Main.gridManager.getInstanceById(this.gridId).reload();this.popup.close()}.bind(this))};e.prototype.showAddPopup=function(){if(!this.popup){this.popup=new BX.PopupWindow({titleBar:this.mess.addTitle.replace("%name%",this.sourceName),closeIcon:true,overlay:true,width:500,content:this.uiNodes.popup,buttons:[new BX.UI.AddButton({events:{click:this.onAdd.bind(this)}}),new BX.UI.CancelButton({events:{click:function(){this.getContext().close()}}})]});BX.bind(this.uiNodes.actionsCheckboxData,"change",function(){this.uiNodes.actionsCont.setAttribute("style",this.uiNodes.actionsCheckboxData.checked?"display: none !important":"");this.uiNodes.actionsData.value=0}.bind(this));BX.bind(this.uiNodes.fromView,"click",function(){BX.calendar({node:this.uiNodes.fromView,field:this.uiNodes.fromData,bTime:false,callback_after:this.setPopupDate.bind(this,true)})}.bind(this));BX.bind(this.uiNodes.toView,"click",function(){BX.calendar({node:this.uiNodes.toView,field:this.uiNodes.toData,bTime:false,callback_after:this.setPopupDate.bind(this,false)})}.bind(this))}this.uiNodes.sumData.value=0;this.uiNodes.actionsData.value=0;this.uiNodes.actionsCheckboxData.checked=true;BX.fireEvent(this.uiNodes.actionsCheckboxData,"change");this.setPopupDate(true);this.setPopupDate(false);this.popup.show()};e.prototype.setPopupDate=function(t,e){t=!!(t||false);e=e||new Date;var s=t?this.uiNodes.fromData:this.uiNodes.toData;var i=t?this.uiNodes.fromView:this.uiNodes.toView;s.setAttribute("data-timestamp",e.getTime());s.value=BX.formatDate(e,BX.message("FORMAT_DATE"));i.textContent=s.value;var o=!t?this.uiNodes.fromData:this.uiNodes.toData;var a=o.getAttribute("data-timestamp");if(a){var n=e.getTime()-a>0;if(n===t){this.setPopupDate(!t,e)}}};e.prototype.checkFieldsBeforeAdd=function(){var t="ui-ctl-danger";BX.removeClass(this.uiNodes.to,t);BX.removeClass(this.uiNodes.from,t);BX.removeClass(this.uiNodes.sum,t);BX.removeClass(this.uiNodes.currency,t);var e=false;if(!this.uiNodes.fromData.value){BX.addClass(this.uiNodes.from,t);e=true}if(!this.uiNodes.toData.value){BX.addClass(this.uiNodes.to,t);e=true}var s=this.uiNodes.fromData.getAttribute("data-timestamp");var i=this.uiNodes.toData.getAttribute("data-timestamp");if(s>i||(i-s)/(86400*1e3)>365){BX.addClass(this.uiNodes.from,t);BX.addClass(this.uiNodes.to,t);e=true}if(!this.uiNodes.sumData.value||!parseInt(this.uiNodes.sumData.value)){BX.addClass(this.uiNodes.sum,t);e=true}if(!this.uiNodes.currencyData.value){BX.addClass(this.uiNodes.currency,t);e=true}return!e};e.prototype.remove=function(t){this.request("remove",{id:t},function(){BX.Main.gridManager.getInstanceById(this.gridId).reload();this.popup.close()}.bind(this))};e.prototype.removeSelected=function(){var t=BX.Main.gridManager.getById(this.gridId);if(!t||!t.instance){return}this.request("removeList",{list:t.instance.getRows().getSelectedIds()},function(){BX.Main.gridManager.getInstanceById(this.gridId).reload();this.popup.close()}.bind(this))};e.prototype.request=function(t,e,s,i){e=e||{};s=s||null;i=i||BX.proxy(this.showErrorPopup,this);var o=this;BX.ajax.runComponentAction(this.componentName,t,{mode:"class",signedParameters:this.signedParameters,data:e}).then(function(t){var e=t.data||{};if(e.error){i.apply(o,[e])}else if(s){s.apply(o,[e])}},function(){var t={error:true,text:""};i.apply(o,[t])})};e.prototype.showErrorPopup=function(t){t=t||{};var e=t.text||this.mess.errorAction;var s=BX.PopupWindowManager.create({autoHide:true,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500}});s.setButtons([new BX.UI.CloseButton({events:{click:function(){this.getContext().close()}}})]);s.setContent('<span class="crm-tracking-expenses-popup-alert">'+e+"</span>");s.show()};t.Expenses=new e})();
//# sourceMappingURL=script.map.js