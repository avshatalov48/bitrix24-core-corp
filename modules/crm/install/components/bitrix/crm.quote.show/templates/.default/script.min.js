if(typeof BX.CrmQuoteShowInitScript==="undefined"){BX.CrmQuoteShowInitScript=function(e){var t=!!e["enableInstantEdit"];if(t){var i=e["messages"];BX.CrmInstantEditorMessages={editButtonTitle:i["editButtonTitle"],lockButtonTitle:i["lockButtonTitle"]};var n=BX.CrmInstantEditor.create(e["instantEditorId"],{containerID:[e["summaryContainerId"]],ownerType:e["ownerType"],ownerID:parseInt(e["ownerId"]),url:e["url"],callToFormat:parseInt(e["callToFormat"])});n.setFieldReadOnly("SUM_PAID",true);var s=typeof BX.CrmProductEditor!=="undefined"?BX.CrmProductEditor.getDefault():null;function r(){if(s){var e=s.getProductCount()>0;n.setFieldReadOnly("OPPORTUNITY",e);n.setFieldReadOnly("CURRENCY_ID",e)}}function a(t,i,n,r){var a=e["productRowsTabId"];if(typeof a==="string"&&a.length>0&&n===a)BX.onCustomEvent("CrmHandleShowProductEditor",[s])}if(s){BX.addCustomEvent(s,"sumTotalChange",function(e){n.setFieldValue("OPPORTUNITY",e);if(s.isViewMode()){n.riseSaveFieldValueEvent("OPPORTUNITY",e)}});r();BX.addCustomEvent(s,"productAdd",r);BX.addCustomEvent(s,"productRemove",r);BX.addCustomEvent("BX_CRM_INTERFACE_FORM_TAB_SELECTED",a)}}e["filesFieldSettings"]["formId"]=e["formId"];var o=new BX.FilesFieldContainer(e["filesFieldSettings"])}}if(typeof BX.FilesFieldContainer==="undefined"){BX.CrmQuoteStorageType={undefined:0,file:1,webdav:2,diskfiles:3};BX.CrmQuoteMode={edit:1,view:2};BX.FilesFieldContainer=function(e){this.random=Math.random().toString().substring(2);this.settings=e;this.controlMode=e["controlMode"]==="edit"?BX.CrmQuoteMode.edit:BX.CrmQuoteMode.view;this.container=BX(this.settings["containerId"]);var t=parseInt(this.getSetting("storageTypeId",BX.CrmQuoteStorageType.undefined));if(isNaN(t)||t===BX.CrmQuoteStorageType.undefined){t=this.getDefaultStorageTypeId()}this.storageTypeId=t;var i=this.getSetting("uploaderName","files_field_uploader_"+this.random);this.setSetting("uploaderName",i);if(this.storageTypeId===BX.CrmQuoteStorageType.webdav){this.prepareWebDavUploader(i,this.controlMode,this.getSetting("webdavelements",[]))}else if(this.storageTypeId===BX.CrmQuoteStorageType.diskfiles){var n=this.getSetting("diskfiles",[]);if(this.controlMode!==BX.CrmQuoteMode.view||n.length>0){this.prepareDiskUploader(i,this.controlMode,n)}}else{this.prepareFileUploader(i,this.getSetting("files",[]))}};BX.FilesFieldContainer.prototype={getSetting:function(e,t){return typeof this.settings[e]!="undefined"?this.settings[e]:t},setSetting:function(e,t){this.settings[e]=t},getMessage:function(e,t){return typeof this.settings["messages"]!=="undefined"&&this.settings["messages"][e]?this.settings["messages"][e]:t},getDialogElements:function(e){var t=document.forms["form_"+this.settings["formId"]];if(!t||!t.elements[e]){return[]}return t.elements[e]},prepareWebDavUploader:function(e,t,i){e=BX.type.isNotEmptyString(e)?e:"files_field_uploader_"+this.random;var n=typeof BX.CrmWebDavUploader.items[e]!=="undefined"?BX.CrmWebDavUploader.items[e]:null;if(n){n.cleanLayout()}else{n=BX.CrmWebDavUploader.create(e,{urlSelect:this.getSetting("webDavSelectUrl",""),urlUpload:this.getSetting("webDavUploadUrl",""),urlShow:this.getSetting("webDavShowUrl",""),elementInfoLoader:BX.delegate(this.getWebDavElementInfo,this),msg:{loading:this.getMessage("webdavFileLoading","Loading..."),file_exists:this.getMessage("webdavFileAlreadyExists","File already exists!"),access_denied:'<p style="margin-top:0;">'+this.getMessage("webdavFileAccessDenied","Access denied!")+"</p>",title:this.getMessage("webdavTitle","Files"),attachFile:this.getMessage("webdavAttachFile","Attach file"),dragFile:this.getMessage("webdavDragFile","Drag a files to this area"),selectFile:this.getMessage("webdavSelectFile","or select a file in your computer"),selectFromLib:this.getMessage("webdavSelectFromLib","Select from library"),loadFiles:this.getMessage("webdavLoadFiles","Load files")}})}n.setMode(t);n.setValues(i);if(this.container)n.layout(this.container);return this.container},prepareDiskUploader:function(e,t,i){e=BX.type.isNotEmptyString(e)?e:"files_field_uploader_";var n=typeof BX.CrmDiskUploader.items[e]!=="undefined"?BX.CrmDiskUploader.items[e]:null;if(n){n.cleanLayout()}else{n=BX.CrmDiskUploader.create(e,{msg:{diskAttachedFiles:this.getMessage("diskAttachedFiles")}})}n.setMode(t);n.setValues(i);if(this.container)n.layout(this.container);return this.container},prepareFileUploader:function(e,t){if(BX.CFileInput.Items[e]){BX.CFileInput.Items[e].setFiles(t)}if(this.container)this.container.style.display="";return this.container},getDefaultStorageTypeId:function(){return parseInt(this.getSetting("defaultStorageTypeId",BX.CrmQuoteStorageType.file))},getWebDavElementInfo:function(e,t){BX.ajax({url:this.getSetting("serviceUrl",""),method:"POST",dataType:"json",data:{ACTION:"GET_WEBDAV_ELEMENT_INFO",ELEMENT_ID:e},onsuccess:function(e){var i=e["DATA"]?e["DATA"]:{};if(BX.type.isFunction(t)){try{t(i["INFO"]?i["INFO"]:{})}catch(e){}}},onfailure:function(e){}})},getWebDavUploaderValues:function(e){var t=[];var i=BX.CrmWebDavUploader.items[e];var n=i?i.getValues():[];for(var s=0;s<n.length;s++){t.push(n[s]["ID"])}return t},getDiskUploaderValues:function(e){var t=BX.CrmDiskUploader.items[e];return t?t.getFileIds():[]},getFileUploaderValues:function(e){var t=[];if(BX.type.isElementNode(e)){t.push(e.value)}else if(BX.type.isArray(e)||typeof e.length!=="undefined"){for(var i=0;i<e.length;i++){t.push(e[i].value)}}return t},onSaveHandler:function(e){var t={};if(this.storageTypeId===BX.CrmQuoteStorageType.webdav){t["webdavelements"]=this.getWebDavUploaderValues(this.getSetting("uploaderName",""))}else if(this.storageTypeId===BX.CrmQuoteStorageType.diskfiles){t["diskfiles"]=this.getDiskUploaderValues(this.getSetting("uploaderName",""))}else{t["files"]=this.getFileUploaderValues(this.getDialogElements(this.getSetting("uploadInputID","")+"[]"));var i=this.getSetting("uploadControlID","");if(typeof BX.CFileInput!=="undefined"&&typeof BX.CFileInput.Items[i]!=="undefined"){t["uploadControlCID"]=BX.CFileInput.Items[i].CID}}if(this.container){var n,s;n=BX.findChildren(this.container,{tag:"input",attr:{type:"hidden"}});if(n instanceof Array&&n.length>0){for(var r in n){s=n[r].name;if(s.match(/^(webdavelements|diskfiles|files|uploadcontrolcid|storagetypeid)(\[\d*\])*/i))BX.remove(n[r])}}if(this.storageTypeId===BX.CrmQuoteStorageType.webdav){n=t["webdavelements"];if(n instanceof Array&&n.length>0){for(var r=0;r<n.length;r++){this.container.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:"webdavelements[]",value:n[r]}}))}}}else if(this.storageTypeId===BX.CrmQuoteStorageType.diskfiles){n=t["diskfiles"];if(n instanceof Array&&n.length>0){for(var r=0;r<n.length;r++){this.container.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:"diskfiles[]",value:n[r]}}))}}}else{n=t["files"];if(n instanceof Array&&n.length>0){for(var r=0;r<n.length;r++){this.container.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:"files[]",value:n[r]}}))}}if(t["uploadControlCID"]){this.container.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:"uploadControlCID",value:t["uploadControlCID"]}}))}}this.container.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:"storageTypeId",value:this.storageTypeId}}))}}}}if(typeof BX.CrmQuoteViewForm==="undefined"){BX.CrmQuoteViewForm=function(){this._id="";this._settings={};this._messages=BX.CrmQuoteViewForm.messages;this._printUrl="";this._downloadPdfUrl="";this._createPdfFileUrl="";this._printTemplates=[];this._printDlg=null;this._isCreatePdfRequestRunning=false};BX.CrmQuoteViewForm.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};var i=this.getSetting("printUrl");if(BX.type.isNotEmptyString(i)){this._printUrl=i}var n=this.getSetting("downloadPdfUrl");if(BX.type.isNotEmptyString(n)){this._downloadPdfUrl=n}var s=this.getSetting("createPdfFileUrl");if(BX.type.isNotEmptyString(s)){this._createPdfFileUrl=s}var r=this.getSetting("printTemplates");if(BX.type.isArray(r)){this._printTemplates=r}BX.addCustomEvent(window,"CrmQuotePrint",BX.delegate(this._onPrint,this));BX.addCustomEvent(window,"CrmQuoteDownloadPdf",BX.delegate(this._onDownloadPdf,this));BX.addCustomEvent(window,"CrmQuoteSendByEmail",BX.delegate(this._onSendByEmail,this))},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getId:function(){return this._id},getMessage:function(e){return this._messages.hasOwnProperty(e)?this._messages[e]:""},_onPrint:function(e,t){if(this._printUrl===""){alert(this.getMessage("noPrintUrlError"));return}if(this._printTemplates.length===0){alert(this.getMessage("noPrintTemplatesError"));return}if(!BX.type.isPlainObject(t)){t={}}var i=BX.type.isBoolean(t["blank"])?t["blank"]:false;var n=BX.CrmQuotePrintHandler.create({urlTemplate:this._printUrl,blank:i,openNewWindow:true});if(this._printTemplates.length>1){this._openPrintDialog(this._printTemplates,n);return}n.print(this._printTemplates[0]["ID"])},_onDownloadPdf:function(e,t){if(this._downloadPdfUrl===""){alert(this.getMessage("noPrintUrlError"));return}if(this._printTemplates.length===0){alert(this.getMessage("noPrintTemplatesError"));return}if(!BX.type.isPlainObject(t)){t={}}var i=BX.type.isBoolean(t["blank"])?t["blank"]:false;var n=BX.CrmQuotePrintHandler.create({urlTemplate:this._downloadPdfUrl,blank:i,openNewWindow:false});if(this._printTemplates.length>1){this._openPrintDialog(this._printTemplates,n);return}n.print(this._printTemplates[0]["ID"])},_onSendByEmail:function(e){if(this._createPdfFileUrl===""){alert(this.getMessage("noPrintUrlError"));return}if(this._printTemplates.length===0){alert(this.getMessage("noPrintTemplatesError"));return}var t=BX.CrmQuoteSendByEmailHandler.create({entityId:this.getSetting("entityId"),activityEditorId:this.getSetting("activityEditorId"),communications:this.getSetting("emailCommunications"),title:this.getSetting("emailTitle"),createPdfFileUrl:this._createPdfFileUrl});if(this._printTemplates.length>1){this._openPrintDialog(this._printTemplates,t);return}t.createEmail(this._printTemplates[0]["ID"])},_openPrintDialog:function(e,t){if(!this._printDlg){this._printDlg=BX.CrmQuotePrintDialog.create(this._id,{templates:e,handler:t,onClose:BX.delegate(this._onPrintDialogClose,this)})}else{this._printDlg.setSetting("templates",e);this._printDlg.setSetting("handler",t)}this._printDlg.open()},_onPrintDialogClose:function(e,t){if(t!==BX.CrmQuotePrintDialog.buttons.print){return}var i=e.getSetting("handler");if(!i){return}var n=e.getData();var s=BX.type.isNotEmptyString(n["templateId"])?n["templateId"]:"";if(s!==""){i.process(s)}}};BX.CrmQuoteViewForm.addUrlParams=function(e,t){if(!BX.type.isNotEmptyString(e)){return""}if(BX.type.isString(t)){t=[t]}for(var i=0;i<t.length;i++){var n=t[i];if(e.indexOf(n)==-1){e+=(e.indexOf("?")==-1?"?":"&")+n}}return e};if(typeof BX.CrmQuoteViewForm.messages==="undefined"){BX.CrmQuoteViewForm.messages={}}BX.CrmQuoteViewForm.create=function(e,t){var i=new BX.CrmQuoteViewForm;i.initialize(e,t);return i}}if(typeof BX.CrmQuotePrintHandler==="undefined"){BX.CrmQuotePrintHandler=function(){this._settings={};this._urlTemplate=""};BX.CrmQuotePrintHandler.prototype={initialize:function(e){this._settings=e?e:{};this._urlTemplate=this.getSetting("urlTemplate");if(!BX.type.isNotEmptyString(this._urlTemplate)){throw"CrmQuotePrintHandler. Could not find 'urlTemplate' setting."}},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},print:function(e){var t=this.getSetting("openNewWindow",true);if(t){jsUtils.OpenWindow(BX.CrmQuoteViewForm.addUrlParams(this._urlTemplate,["PAY_SYSTEM_ID="+e,"BLANK="+(this.getSetting("blank",false)?"Y":"N")]),900,600)}else{jsUtils.Redirect([],BX.CrmQuoteViewForm.addUrlParams(this._urlTemplate,["PAY_SYSTEM_ID="+e,"BLANK="+(this.getSetting("blank",false)?"Y":"N")]),900,600)}},process:function(e){this.print(e)}};BX.CrmQuotePrintHandler.create=function(e){var t=new BX.CrmQuotePrintHandler;t.initialize(e);return t}}if(typeof BX.CrmQuoteSendByEmailHandler==="undefined"){BX.CrmQuoteSendByEmailHandler=function(){this._settings={};this._entityId="";this._activityEditorId="";this._communications=[];this._title="";this._createPdfFileUrl="";this._isRequestRunning=false};BX.CrmQuoteSendByEmailHandler.prototype={initialize:function(e){this._settings=e?e:{};this._entityId=this.getSetting("entityId");if(!BX.type.isNotEmptyString(this._entityId)){throw"CrmQuoteSendByEmailHandler. Could not find 'entityId' setting."}this._activityEditorId=this.getSetting("activityEditorId");if(!BX.type.isNotEmptyString(this._activityEditorId)){throw"CrmQuoteSendByEmailHandler. Could not find 'activityEditorId' setting."}var t=this.getSetting("communications");if(BX.type.isArray(t)){this._communications=t}this._title=this.getSetting("title");this._createPdfFileUrl=this.getSetting("createPdfFileUrl");if(!BX.type.isNotEmptyString(this._createPdfFileUrl)){throw"CrmQuoteSendByEmailHandler. Could not find 'createPdfFileUrl' setting."}},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},createEmail:function(e){this._beginCreatePdfFileRequest(e)},_beginCreatePdfFileRequest:function(e){if(top.BX.Bitrix24&&top.BX.Bitrix24.Slider){this._onCreatePdfFileRequestSuccess.apply(this,[{__psid:e}]);return}if(this._createPdfFileUrl===""){return}if(this._isRequestRunning){return}var t={QUOTE_ID:this._entityId,PAY_SYSTEM_ID:e,MODE:"SAVE_PDF",GET_CONTENT:"Y",pdf:1,sessid:BX.bitrix_sessid()};BX.showWait();BX.ajax({data:t,method:"POST",dataType:"json",url:this._createPdfFileUrl,onsuccess:BX.delegate(this._onCreatePdfFileRequestSuccess,this),onfailure:BX.delegate(this._onCreatePdfFileRequestFailure,this)});this._isRequestRunning=true},_onCreatePdfFileRequestSuccess:function(e){this._isRequestRunning=false;BX.closeWait();if(!e){BX.debug("CrmQuoteSendByEmailHandler. Could not create PDF. Unknown error.");return}if(BX.type.isNotEmptyString(e["ERROR"])){BX.debug("CrmQuoteSendByEmailHandler. Could not create PDF. "+e["ERROR"]);return}var t={};if(e["webdavelement"]){t["storageTypeID"]=BX.CrmActivityStorageType.webdav;t["webdavelements"]=[e["webdavelement"]]}else if(e["diskfile"]){t["storageTypeID"]=BX.CrmActivityStorageType.disk;t["diskfiles"]=[e["diskfile"]]}else if(e["file"]){t["storageTypeID"]=BX.CrmActivityStorageType.file;e["file"]["fileURL"]=e["file"]["src"];t["files"]=[e["file"]]}var i=[];for(var n=0;n<this._communications.length;n++){var s=this._communications[n];i.push({entityType:s["ENTITY_TYPE"],entityId:s["ENTITY_ID"],entityTitle:s["TITLE"],type:s["TYPE"],value:s["VALUE"]})}if(i.length>0){t["communications"]=i}t["ownerType"]="QUOTE";t["ownerID"]=this._entityId;if(e.__psid>0)t["ownerPSID"]=e.__psid;t["subject"]=this._title;BX.CrmActivityEditor.items[this._activityEditorId].addEmail(t)},_onCreatePdfFileRequestFailure:function(e){this._isRequestRunning=false;BX.closeWait();BX.debug("CrmQuoteSendByEmailHandler. Could not create PDF. Unknown error.")},process:function(e){this.createEmail(e)}};BX.CrmQuoteSendByEmailHandler.create=function(e){var t=new BX.CrmQuoteSendByEmailHandler;t.initialize(e);return t}}if(typeof BX.CrmQuotePrintDialog==="undefined"){BX.CrmQuotePrintDialog=function(){this._id="";this._settings={};this._messages=BX.CrmQuotePrintDialog.messages;this._data={};this._isOpened=false;this._popup=null;this._templateSelect=null;this._onCloseCallback=null};BX.CrmQuotePrintDialog.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};var i=this.getSetting("onClose");this._onCloseCallback=BX.type.isFunction(i)?i:null},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},setSetting:function(e,t){return this._settings[e]=t},getId:function(){return this._id},isOpened:function(){return this._isOpened},getMessage:function(e){return this._messages.hasOwnProperty(e)?this._messages[e]:""},getData:function(){return this._data},open:function(){if(this._isOpened){return}this._popup=new BX.PopupWindow(this._id,null,{autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:true},closeByEsc:true,titleBar:this.getMessage("title"),content:this._prepareContent(),events:{onPopupShow:BX.delegate(this._onPopupShow,this),onPopupClose:BX.delegate(this._onPopupClose,this),onPopupDestroy:BX.delegate(this._onPopupDestroy,this)},buttons:this._prepareButtons()});this._popup.show()},_prepareContent:function(){var e=BX.create("TABLE",{attrs:{className:"bx-crm-dialog-quote-print-table"}});e.cellSpacing="0";e.cellPadding="0";e.border="0";var t=this._templateSelect=BX.create("SELECT",{attrs:{className:"bx-crm-dialog-quick-create-field-select"}});var i=this.getSetting("templates");if(!BX.type.isArray(i)){i=[]}for(var n=0;n<i.length;n++){var s=i[n];var r=BX.create("OPTION",{props:{value:s["ID"]},text:s["NAME"]});if(!BX.browser.isIE){t.add(r,null)}else{try{t.add(r,t.options[null])}catch(e){t.add(r,null)}}}var a=e.insertRow(-1);var o=a.insertCell(-1);o.className="bx-crm-dialog-quote-print-table-left";o.appendChild(BX.create("SPAN",{text:this.getMessage("templateField")+":"}));o=a.insertCell(-1);o.className="bx-crm-dialog-quote-print-table-right";o.appendChild(t);return BX.create("DIV",{attrs:{className:"bx-crm-dialog-quote-print-popup"},children:[e]})},_prepareButtons:function(){var e=new BX.PopupWindowButton({text:this.getMessage("printButton"),className:"popup-window-button-accept",events:{click:BX.delegate(this._onPrintButtonClick,this)}});var t=new BX.PopupWindowButtonLink({text:this.getMessage("cancelButton"),className:"popup-window-button-link-cancel",events:{click:BX.delegate(this._onCancelButtonClick,this)}});return[e,t]},_onPrintButtonClick:function(){this._data={templateId:this._templateSelect.value};if(this._onCloseCallback){this._onCloseCallback(this,BX.CrmQuotePrintDialog.buttons.print)}if(this._popup){this._popup.close()}},_onCancelButtonClick:function(){if(this._onCloseCallback){this._onCloseCallback(this,BX.CrmQuotePrintDialog.buttons.cancel)}if(this._popup){this._popup.close()}},_onPopupShow:function(){this._isOpened=true},_onPopupClose:function(){this._isOpened=false;if(this._popup){this._popup.destroy()}this._templateSelect=null},_onPopupDestroy:function(){this._popup=null}};BX.CrmQuotePrintDialog.buttons={cancel:0,print:1};if(typeof BX.CrmQuotePrintDialog.messages==="undefined"){BX.CrmQuotePrintDialog.messages={}}BX.CrmQuotePrintDialog.create=function(e,t){var i=new BX.CrmQuotePrintDialog;i.initialize(e,t);return i}}