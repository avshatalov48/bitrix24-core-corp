(function(){"use strict";var t=BX.namespace("BX.Crm.Tracking.Source");if(t.Editor){return}function e(){this.context=null;this.editor=null}e.prototype.init=function(t){this.context=BX(t.containerId);this.isSaved=t.isSaved||false;this.componentName=t.componentName||null;this.signedParameters=t.signedParameters||null;this.pathToExpenses=t.pathToExpenses||null;this.provider=t.provider||{};this.mess=t.mess||{};this.buttonUtmNode=BX("utm-edit-btn");BX.bind(this.buttonUtmNode,"click",this.onEditUtm.bind(this));this.buttonUtmNode=BX("utm-add-btn");BX.bind(this.buttonUtmNode,"click",this.onEditUtm.bind(this));BX.bind(BX("crm-tracking-expenses"),"click",this.onEditExpenses.bind(this));this.colorPicker=new i;this.connector=new n({manager:this});if(BX.UI&&BX.UI.TileSelector){this.selector=BX.UI.TileSelector.getById("ref-domain");if(!this.selector){throw new Error("Tile selector `ref-domain` not found.")}BX.addCustomEvent(this.selector,this.selector.events.search,this.onRefDomainSearch.bind(this))}};e.prototype.onEditExpenses=function(){BX.SidePanel.Instance.open(this.pathToExpenses,{width:670,cacheable:false})};e.prototype.onEditUtm=function(){BX.SidePanel.Instance.open("/crm/tracking/source/utm/",{width:670,cacheable:false})};e.prototype.onRefDomainSearch=function(t){(t||"").split(",").forEach(function(t){t=t.trim();if(!t){return}this.selector.addTile(t,{},t)},this)};t.Editor=new e;function i(){this.picker=null;this.pickerIcon=null;this.pickerPopup=null;this.init()}i.prototype.init=function(){this.input=BX("crm-analytics-utm-editor-color-input");if(!this.input){return}this.picker=BX("crm-analytics-utm-editor-color-select");this.pickerIcon=BX("crm-analytics-utm-editor-color-icon-value");this.setColor(this.input.value);BX.bind(this.picker,"click",this.handlePickerClick.bind(this))};i.prototype.setColor=function(t){this.input.value=t;this.pickerIcon.style.backgroundColor=t};i.prototype.handlePickerClick=function(){if(!this.pickerPopup){this.pickerPopup=new BX.ColorPicker({bindElement:this.picker,onColorSelected:this.setColor.bind(this)})}this.pickerPopup.open()};function n(t){this.manager=t.manager;this.initUi();this.listenSeoAuth();if(this.manager.provider.HAS_AUTH){this.requestAccounts()}}n.prototype.initUi=function(){var t=null;this.nodes={blocks:{desc:this.getNode("desc",t),connect:this.getNode("connect",t),connected:this.getNode("connected",t),accounts:this.getNode("ad/accounts",t)},ad:{accounts:{view:this.getNode("ad/accounts/view",t),data:this.getNode("ad/accounts/data",t)}},connect:this.getNode("connect/btn",t),disconnect:this.getNode("profile/disconnect",t),profile:{link:this.getNode("profile/link",t),name:this.getNode("profile/name",t),pic:this.getNode("profile/pic",t)}};BX.bind(this.nodes.connect,"click",this.connect.bind(this));BX.bind(this.nodes.disconnect,"click",this.disconnect.bind(this));BX.bind(this.nodes.ad.accounts.view,"change",function(){this.nodes.ad.accounts.data.value=this.nodes.ad.accounts.view.value}.bind(this))};n.prototype.listenSeoAuth=function(){BX.addCustomEvent(window,"seo-client-auth-result",this.onSeoAuth.bind(this))};n.prototype.connect=function(){var t=function(){if(this.serviceWindow){this.serviceWindow.close()}BX.removeClass(this.nodes.connect,"ui-btn-wait")}.bind(this);if(BX.hasClass(this.nodes.connect,"ui-btn-wait")){t();return}BX.addClass(this.nodes.connect,"ui-btn-wait")};n.prototype.disconnect=function(){if(BX.hasClass(this.nodes.disconnect,"ui-btn-wait")){return}BX.addClass(this.nodes.disconnect,"ui-btn-wait");this.request("disconnect",{},this.updateProvider.bind(this,true))};n.prototype.onSeoAuth=function(t){t.reload=false;this.requestProvider()};n.prototype.changeAuthDisplay=function(t){this.nodes.blocks.desc.style.display=t?"":"none";this.nodes.blocks.connect.style.display=t?"":"none";this.nodes.blocks.connected.style.display=!t?"":"none";if(this.nodes.blocks.accounts){this.nodes.blocks.accounts.style.display=!t?"":"none"}};n.prototype.requestAccounts=function(){if(!this.manager.provider.HAS_ACCOUNTS){return}this.request("getAccounts",{},this.updateAccounts.bind(this))};n.prototype.updateAccounts=function(t){var e=this.nodes.ad.accounts.view;var i=this.nodes.ad.accounts.data;e.innerHTML="";(t.data||[]).forEach(function(t){var n=document.createElement("option");n.value=t.ID||t.id;n.textContent=t.NAME||t.name;if(!i.value){i.value=n.value}if(i.value===n.value){n.selected=true}e.appendChild(n)},this)};n.prototype.requestProvider=function(){this.request("getProvider",{},this.updateProvider.bind(this,false))};n.prototype.updateProvider=function(t,e){var i=e.data||{};i.PROFILE=i.PROFILE||{};this.manager.provider=i;this.nodes.profile.name.link=i.PROFILE.LINK;this.nodes.profile.name.textContent=i.PROFILE.NAME;this.nodes.profile.pic.style.backgroundColor=i.PROFILE.PICTURE;this.nodes.connect.value=i.AUTH_URL;BX.removeClass(this.nodes.connect,"ui-btn-wait");BX.removeClass(this.nodes.disconnect,"ui-btn-wait");this.changeAuthDisplay(t);if(this.manager.provider.HAS_AUTH){this.requestAccounts()}};n.prototype.getNode=function(t,e){var i=(e||document.body).querySelector('[data-role="crm/tracking/'+t+'"]');return i?i:null};n.prototype.request=function(t,e,i,n){e=e||{};e.type=this.manager.provider.TYPE;i=i||null;n=n||BX.proxy(this.showErrorPopup,this);var o=this;BX.ajax.runComponentAction(this.manager.componentName,t,{mode:"class",signedParameters:this.manager.signedParameters,data:e}).then(function(t){var e=t.data||{};if(e.error){n.apply(o,[e])}else if(i){i.apply(o,[e])}},function(){var t={error:true,text:""};n.apply(o,[t])})};n.prototype.showErrorPopup=function(t){t=t||{};var e=t.text||this.manager.mess.errorAction;var i=BX.PopupWindowManager.create("crm_ads_rtg_error",null,{autoHide:true,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500}});i.setButtons([new BX.PopupWindowButton({text:this.manager.mess.dlgBtnClose,events:{click:function(){this.popupWindow.close()}}})]);i.setContent('<span class="crm-ads-rtg-warning-popup-alert">'+e+"</span>");i.show()}})();
//# sourceMappingURL=script.map.js