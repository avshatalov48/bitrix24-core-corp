(function(){"use strict";var t=BX.namespace("BX.Crm.Tracking.Source");if(t.Editor){return}function e(){this.context=null;this.editor=null}e.prototype.init=function(t){this.context=BX(t.containerId);this.isSaved=t.isSaved||false;this.componentName=t.componentName||null;this.signedParameters=t.signedParameters||null;this.pathToExpenses=t.pathToExpenses||null;this.provider=t.provider||null;this.mess=t.mess||{};this.buttonUtmNode=BX("utm-edit-btn");BX.bind(this.buttonUtmNode,"click",this.onEditUtm.bind(this));this.buttonUtmNode=BX("utm-add-btn");BX.bind(this.buttonUtmNode,"click",this.onEditUtm.bind(this));BX.bind(BX("crm-tracking-expenses"),"click",this.onEditExpenses.bind(this));this.colorPicker=new i;this.connector=new n({manager:this});if(BX.UI&&BX.UI.TileSelector){this.selectorRefDomain=BX.UI.TileSelector.getById("ref-domain");if(this.selectorRefDomain){BX.addCustomEvent(this.selectorRefDomain,this.selectorRefDomain.events.search,this.onRefDomainSearch.bind(this))}this.selectorUtmSource=BX.UI.TileSelector.getById("utm-source");if(!this.selectorUtmSource){throw new Error("Tile selector `utm-source` not found.")}BX.addCustomEvent(this.selectorUtmSource,this.selectorUtmSource.events.search,this.onUtmSourceSearch.bind(this))}};e.prototype.onEditExpenses=function(){BX.SidePanel.Instance.open(this.pathToExpenses,{width:670,cacheable:false})};e.prototype.onEditUtm=function(){BX.SidePanel.Instance.open("/crm/tracking/source/utm/",{width:670,cacheable:false})};e.prototype.onRefDomainSearch=function(t){t=(t||"").trim();if(window.URL&&/^http:|https:/.test(t)){t=new URL(t).hostname||""}t.split(",").forEach(function(t){t=t.trim();if(!t){return}this.selectorRefDomain.addTile(t,{},t)},this)};e.prototype.onUtmSourceSearch=function(t){t=(t||"").trim();if(window.URL&&/^http:|https:/.test(t)){t=new URL(t).searchParams.get("utm_source")||""}t.split(",").forEach(function(t){t=t.trim();if(!t){return}this.selectorUtmSource.addTile(t,{},t)},this)};t.Editor=new e;function i(){this.picker=null;this.pickerIcon=null;this.pickerPopup=null;this.init()}i.prototype.init=function(){this.input=BX("crm-analytics-utm-editor-color-input");if(!this.input){return}this.picker=BX("crm-analytics-utm-editor-color-select");this.pickerIcon=BX("crm-analytics-utm-editor-color-icon-value");this.setColor(this.input.value);BX.bind(this.picker,"click",this.handlePickerClick.bind(this))};i.prototype.setColor=function(t){this.input.value=t;this.pickerIcon.style.backgroundColor=t};i.prototype.handlePickerClick=function(){if(!this.pickerPopup){this.pickerPopup=new BX.ColorPicker({bindElement:this.picker,onColorSelected:this.setColor.bind(this)})}this.pickerPopup.open()};function n(t){this.manager=t.manager;if(!this.manager.provider||!this.manager.provider.TYPE){return}this.initUi();this.listenSeoAuth()}n.prototype.initUi=function(){var t=null;this.nodes={blocks:{desc:this.getNode("desc",t),connect:this.getNode("connect",t),connected:this.getNode("connected",t),accounts:this.getNode("ad/accounts",t),profile:this.getNode("profile",t)},ad:{accounts:{view:this.getNode("ad/accounts/view",t),data:this.getNode("ad/accounts/data",t)},client:this.getNode("ad/client",t)},connect:this.getNode("connect/btn",t),disconnect:this.getNode("profile/disconnect",t),profile:{link:this.getNode("profile/link",t),name:this.getNode("profile/name",t),pic:this.getNode("profile/pic",t)}};BX.bind(this.nodes.connect,"click",this.connect.bind(this));BX.bind(this.nodes.disconnect,"click",this.disconnect.bind(this));BX.bind(this.nodes.ad.accounts.view,"change",function(){this.nodes.ad.accounts.data.value=this.nodes.ad.accounts.view.value}.bind(this));this.initClient()};n.prototype.initClient=function(t){var e=this.manager.provider.CLIENTS;if(this.clientSelector){this.clientSelector.items=e}else{this.clientSelector=new BX.Seo.Ads.ClientSelector(this.nodes.blocks.profile,{selected:this.manager.provider.PROFILE,items:e,canAddItems:true,canUnSelectItem:true,events:{onNewItem:function(){BX.util.popup(this.manager.provider.AUTH_URL,800,600)}.bind(this),onSelectItem:function(t){this.setProfile(t)}.bind(this),onUnSelectItem:function(){this.setProfile(null)}.bind(this),onRemoveItem:function(t){this.disconnect(t.CLIENT_ID)}.bind(this)}})}if(!t){this.clientSelector.setSelected(this.manager.provider.PROFILE);this.setProfile(this.manager.provider.PROFILE)}this.clientSelector.enable();this.changeAuthDisplay(!e||e.length===0)};n.prototype.setProfile=function(t){if(t&&!t.CLIENT_ID){t=null}this.manager.provider.PROFILE=t;this.nodes.ad.client.value=t?t.CLIENT_ID:"";this.requestAccounts()};n.prototype.listenSeoAuth=function(){BX.addCustomEvent(window,"seo-client-auth-result",this.onSeoAuth.bind(this))};n.prototype.requestProvider=function(){this.clientSelector.disable();this.request("getProvider",{},this.updateProvider.bind(this))};n.prototype.updateProvider=function(t){var e=t.data||{};e.PROFILE=e.PROFILE||null;this.manager.provider=e;this.initClient()};n.prototype.connect=function(){var t=function(){if(this.serviceWindow){this.serviceWindow.close()}BX.removeClass(this.nodes.connect,"ui-btn-wait")}.bind(this);if(BX.hasClass(this.nodes.connect,"ui-btn-wait")){t();return}BX.addClass(this.nodes.connect,"ui-btn-wait")};n.prototype.disconnect=function(t){this.clientSelector.disable();this.request("disconnect",{clientId:t},function(e){var i=this.manager.provider.PROFILE;if(i&&i.CLIENT_ID===t){this.updateProvider(e)}else{this.manager.provider=e.data;this.initClient(true)}this.clientSelector.enable()}.bind(this))};n.prototype.onSeoAuth=function(t){t.reload=false;this.requestProvider()};n.prototype.changeAuthDisplay=function(t){this.nodes.blocks.desc.style.display=t?"":"none";this.nodes.blocks.connect.style.display=t?"":"none";this.nodes.blocks.connected.style.display=!t?"":"none";if(this.nodes.blocks.accounts){this.nodes.blocks.accounts.style.display=!t?"":"none"}};n.prototype.requestAccounts=function(){if(!this.manager.provider.HAS_ACCOUNTS){return}var t=this.nodes.ad.accounts.view;t.disabled=true;var e=this.manager.provider.PROFILE;if(!e){this.updateAccounts({data:[]});t.disabled=true;return}this.updateAccounts({data:[{id:"",name:this.manager.mess.loading+"..."}]},true);this.request("getAccounts",{clientId:e.CLIENT_ID},this.updateAccounts.bind(this))};n.prototype.updateAccounts=function(t,e){e=e||false;var i=this.nodes.ad.accounts.view;var n=this.nodes.ad.accounts.data;i.innerHTML="";i.disabled=false;(t.data||[]).forEach(function(t){var e=document.createElement("option");e.value=t.ID||t.id;e.textContent=t.NAME||t.name;if(n.value&&n.value===e.value){e.selected=true}i.appendChild(e)},this);if(!e){n.value=i.value}};n.prototype.getNode=function(t,e){var i=(e||document.body).querySelector('[data-role="crm/tracking/'+t+'"]');return i?i:null};n.prototype.request=function(t,e,i,n){e=e||{};e.type=this.manager.provider.TYPE;i=i||null;n=n||BX.proxy(this.showErrorPopup,this);var o=this;BX.ajax.runComponentAction(this.manager.componentName,t,{mode:"class",signedParameters:this.manager.signedParameters,data:e}).then(function(t){var e=t.data||{};if(e.error){n.apply(o,[e])}else if(i){i.apply(o,[e])}},function(){var t={error:true,text:""};n.apply(o,[t])})};n.prototype.showErrorPopup=function(t){t=t||{};var e=t.text||this.manager.mess.errorAction;var i=BX.PopupWindowManager.create("crm_ads_rtg_error",null,{autoHide:true,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500}});i.setButtons([new BX.PopupWindowButton({text:this.manager.mess.dlgBtnClose,events:{click:function(){this.popupWindow.close()}}})]);i.setContent('<span class="crm-ads-rtg-warning-popup-alert">'+e+"</span>");i.show()}})();
//# sourceMappingURL=script.map.js