BX.namespace("BX.Crm");if(typeof BX.Crm.EntityDetailProgressControl==="undefined"){BX.Crm.EntityDetailProgressControl=function(){this._id="";this._settings={};this._container=null;this._entityId=0;this._entityTypeId=0;this._stepInfoTypeId="";this._currentStepId="";this._previousStepId="";this._currentSemantics="";this._previousSemantics="";this._manager=null;this._stepInfos=null;this._steps=[];this._terminationDlg=null;this._failureDlg=null;this._isReadOnly=false;this._terminationControl=null;this._entityEditorDialog=null;this._entityEditorDialogHandler=BX.delegate(this.onEntityEditorDialogClose,this)};BX.Crm.EntityDetailProgressControl.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._container=BX(BX.prop.getString(this._settings,"containerId",""));this._entityId=BX.prop.getNumber(this._settings,"entityId",0);this._entityTypeId=BX.prop.getNumber(this._settings,"entityTypeId",0);this._entityType=BX.CrmEntityType.resolveName(this._entityTypeId);this._currentStepId=BX.prop.getString(this._settings,"currentStepId","");this._currentSemantics=BX.prop.getString(this._settings,"currentSemantics","");this._stepInfoTypeId=BX.prop.getString(this._settings,"stepInfoTypeId","");this._isReadOnly=BX.prop.getBoolean(this._settings,"readOnly",false);if(this._entityTypeId===BX.CrmEntityType.enumeration.deal){this._manager=BX.CrmDealStageManager.current}else if(this._entityTypeId===BX.CrmEntityType.enumeration.dealrecurring){this._manager=BX.CrmDealRecurringStageManager.current}if(this._entityTypeId===BX.CrmEntityType.enumeration.quote){this._manager=BX.CrmQuoteStatusManager.current}else if(this._entityTypeId===BX.CrmEntityType.enumeration.lead){this._manager=BX.CrmLeadStatusManager.current;this._terminationControl=BX.CrmLeadTerminationControl.create(this._id,BX.CrmParamBag.create({entityId:this._entityId,typeId:BX.prop.getInteger(e,"conversionTypeId",BX.CrmLeadConversionType.general),canConvert:BX.prop.getBoolean(e,"canConvert",false),conversionScheme:BX.prop.get(e,"conversionScheme",null)}))}else if(this._entityTypeId===BX.CrmEntityType.enumeration.order){this._manager=BX.CrmOrderStatusManager.current}else if(this._entityTypeId===BX.CrmEntityType.enumeration.ordershipment){this._manager=BX.CrmOrderShipmentStatusManager.current}this._stepInfos=this._manager.getInfos(this._stepInfoTypeId);var i=this.findStepInfoIndex(this._currentStepId);var s=this._stepInfos[i];for(var n=0,r=this._stepInfos.length;n<r;n++){var o=this._stepInfos[n];var a=BX.prop.getString(o,"id","");var l=this.getStepContainer(a);if(!l){continue}var p=l.querySelector(".crm-entity-section-status-step-item-text");if(p.scrollWidth>p.clientWidth){BX.addClass(l,"crm-entity-section-status-step-hover");l.style.maxWidth=p.scrollWidth+23+"px"}this._steps.push(BX.Crm.EntityDetailProgressStep.create(a,{name:o["name"],hint:BX.prop.getString(o,"hint",""),sort:BX.prop.getNumber(o,"sort",0),semantics:BX.prop.getString(o,"semantics",""),index:n,isPassed:i>=0&&n<=i,isReadOnly:this._isReadOnly,isVisible:l.style.display!=="none",container:l,control:this}))}if(i>=0){this.adjustSteps(i,BX.Crm.EntityDetailProgressControl.getStepColor(s))}BX.addCustomEvent(window,"Crm.EntityModel.Change",BX.delegate(this.onEntityModelChange,this))},onEntityModelChange:function(t,e){if(BX.prop.getInteger(e,"entityTypeId",0)!==this._entityTypeId||BX.prop.getInteger(e,"entityId",0)!==this._entityId){return}var i=BX.prop.getString(this._settings,"entityFieldName","");if(i===""){return}if(!BX.prop.getBoolean(e,"forAll",false)&&i!==BX.prop.getString(e,"fieldName","")){return}var s=t.getField(i,"");if(s===this._currentStepId){return}var n=this.findStepInfoIndex(s);if(n>=0){var r=this._stepInfos[n];this.setCurrentStep(r);this.adjustSteps(n,BX.Crm.EntityDetailProgressControl.getStepColor(r))}},getEntityId:function(){return this._entityId},getEntityTypeId:function(){return this._entityTypeId},getEntityTypeName:function(){return BX.CrmEntityType.resolveName(this._entityTypeId)},getCurrentStepId:function(){return this._currentStepId},getCurrentStepName:function(){var t=this.findStepInfoIndex(this._currentStepId);return t>=0?this._stepInfos[t]["name"]:"["+this._currentStepId+"]"},getCurrentSemantics:function(){return this._currentSemantics},getStepContainer:function(t){return this._container.querySelector('.crm-entity-section-status-step[data-id="'+t+'"]')},getTerminationStep:function(){return this._steps.length>0?this._steps[this._steps.length-1]:null},getStepById:function(t){for(var e=0,i=this._steps.length;e<i;e++){var s=this._steps[e];if(s.getId()===t){return s}}return null},findStepInfoIndex:function(t){for(var e=0,i=this._stepInfos.length;e<i;e++){if(this._stepInfos[e]["id"]===t){return e}}return-1},findStepInfoBySemantics:function(t){for(var e=0,i=this._stepInfos.length;e<i;e++){var s=this._stepInfos[e];var n=BX.type.isNotEmptyString(s["semantics"])?s["semantics"]:"";if(t===n){return s}}return null},findAllStepInfoBySemantics:function(t){var e=[];for(var i=0,s=this._stepInfos.length;i<s;i++){var n=this._stepInfos[i];var r=BX.prop.getString(n,"semantics","");if(t===r){e.push(n)}}return e},setCurrentStep:function(t,e){var i=t["id"];if(this._currentStepId===i){return false}if(BX.prop.getBoolean(e,"keepPreviousStep",true)){this._previousStepId=this._currentStepId;this._previousSemantics=this._currentSemantics}this._currentStepId=i;var s=t["semantics"];if(this._currentSemantics!==s){this._currentSemantics=s}this.adjustStepsVisibility();this.adjustFinalStepName();BX.onCustomEvent(window,"Crm.EntityProgress.Change",[this,{entityTypeId:this._entityTypeId,entityId:this._entityId,currentStepId:this._currentStepId,semantics:this._currentSemantics}]);return true},adjustFinalStepName:function(){var t=this.findStepInfoBySemantics("success");if(t){var e=this.findStepInfoIndex(t["id"]);if(e>=0){this._steps[e].setDisplayName(this._currentSemantics==="process"?BX.prop.getString(this._settings,"terminationTitle",""):"")}}},adjustStepsVisibility:function(){for(var t=0,e=this._steps.length;t<e;t++){var i=this._steps[t];var s=true;var n=i.getSemantics();if(this._currentSemantics==="process"||this._currentSemantics==="success"){s=n==="process"||n==="success"}else{if(n==="success"){s=false}else if(n==="failure"||n==="apology"){s=i.getId()===this._currentStepId}}i.setVisible(s)}},adjustSteps:function(t,e){if(t>=this._steps.length){t=this._steps.length-1}var i,s;for(i=t,s=this._steps.length;i<s;i++){this._steps[i].recoverColors();this._steps[i].saveStyles()}var n=BX.Crm.EntityDetailProgressStep.calculateTextColor(e);for(i=0,s=t;i<=s;i++){this._steps[i].setColor(n);this._steps[i].setBackgroundColor(e)}for(i=0,s=t;i<=s;i++){this._steps[i].saveStyles()}},setStepColorsBefore:function(t){var e=t.calculateTextColor();var i=t.getBackgroundColor();for(var s=0,n=t.getIndex();s<=n;s++){this._steps[s].setColor(e);this._steps[s].setBackgroundColor(i)}},recoverStepColorsBefore:function(t){for(var e=0,i=t.getIndex();e<=i;e++){this._steps[e].recoverStyles()}},save:function(){var t=BX.prop.getString(this._settings,"serviceUrl");var e=this.getCurrentStepId();var i=this.getEntityTypeName();var s=this.getEntityId();if(t===""||e===""||i===""||s<=0){return}var n={ACTION:"SAVE_PROGRESS",VALUE:e,TYPE:i,ID:s,sessid:BX.bitrix_sessid()};BX.onCustomEvent(this,"Crm.EntityProgress.onSaveBefore",[this,n]);BX.ajax({url:t,method:"POST",dataType:"json",data:n,onsuccess:BX.delegate(this.onSaveRequestSuccess,this)})},onSaveRequestSuccess:function(t){var e=BX.prop.getObject(t,"CHECK_ERRORS",null);if(e){this.openEntityEditorDialog({title:this._manager.getMessage("checkErrorTitle"),helpData:{text:this._manager.getMessage("checkErrorHelp"),code:this._manager.getMessage("checkErrorHelpArticleCode")},fieldNames:Object.keys(e),initData:BX.prop.getObject(t,"EDITOR_INIT_DATA",null),context:BX.prop.getObject(t,"CONTEXT",null)});return}BX.onCustomEvent(window,"Crm.EntityProgress.Saved",[this,{entityTypeId:this._entityTypeId,entityId:this._entityId,currentStepId:this._currentStepId,currentSemantics:this._currentSemantics,previousStepId:this._previousStepId,previousSemantics:this._previousSemantics,requestData:t}])},openEntityEditorDialog:function(t){BX.Crm.PartialEditorDialog.close("progressbar-entity-editor");this._entityEditorDialog=BX.Crm.PartialEditorDialog.create("progressbar-entity-editor",{title:BX.prop.getString(t,"title","Please fill in all required fields"),entityTypeId:this._entityTypeId,entityId:this._entityId,fieldNames:BX.prop.getArray(t,"fieldNames",[]),helpData:BX.prop.getObject(t,"helpData",null),context:BX.prop.getObject(t,"context",null)});window.setTimeout(function(){this._entityEditorDialog.open();BX.addCustomEvent(window,"Crm.PartialEditorDialog.Close",this._entityEditorDialogHandler)}.bind(this),150)},onEntityEditorDialogClose:function(t,e){if(!(this._entityTypeId===BX.prop.getInteger(e,"entityTypeId",0)&&this._entityId===BX.prop.getInteger(e,"entityId",0))){return}this._entityEditorDialog=null;BX.removeCustomEvent(window,"Crm.PartialEditorDialog.Close",this._entityEditorDialogHandler);if(BX.prop.getBoolean(e,"isCancelled",true)&&this._previousStepId!==""){var i=this.findStepInfoIndex(this._previousStepId);var s=this._stepInfos[i];this.setCurrentStep(s);this.adjustSteps(i,BX.Crm.EntityDetailProgressControl.getStepColor(this._stepInfos[i]))}},openTerminationDialog:function(){if(this._terminationDlg){this._terminationDlg.close();this._terminationDlg=null}var t=this.findAllStepInfoBySemantics("apology");this._terminationDlg=BX.CrmProcessTerminationDialog.create(this._id+"_TERMINATION",BX.CrmParamBag.create({title:this._manager.getMessage("dialogTitle"),failureTitle:t.length>0?this._manager.getMessage("failureTitle"):"",success:this.findStepInfoBySemantics("success"),failure:this.findStepInfoBySemantics("failure"),apologies:t,callback:BX.delegate(this.onTerminationDialogClose,this),terminationControl:this._terminationControl}));this._terminationDlg.open()},closeTerminationDialog:function(){if(!this._terminationDlg){return}this._terminationDlg.close(false);this._terminationDlg=null},onTerminationDialogClose:function(dialog,params){if(this._terminationDlg!==dialog){return}this.closeTerminationDialog();var stepId=BX.type.isNotEmptyString(params["result"])?params["result"]:"";var stepIndex=this.findStepInfoIndex(stepId);if(stepIndex<0){var currentStepIndex=this.findStepInfoIndex(this._currentStepId);this.adjustSteps(currentStepIndex,BX.Crm.EntityDetailProgressControl.getStepColor(this._stepInfos[currentStepIndex]));return}var stepInfo=this._stepInfos[stepIndex];this.setCurrentStep(stepInfo);var openFailureDialog=false;var failure=this.findStepInfoBySemantics("failure");if(failure&&failure["id"]===stepId){openFailureDialog=true}else if(stepInfo["semantics"]==="success"){if(typeof stepInfo["hasParams"]!=="undefined"&&stepInfo["hasParams"]===true){openFailureDialog=true}else{var finalScript=BX.prop.getString(this._settings,"finalScript","");if(finalScript!==""){eval(finalScript);return}var finalUrl=BX.prop.getString(this._settings,"finalUrl","");if(finalUrl!==""){window.location=finalUrl;return}}}this.adjustSteps(stepIndex,BX.Crm.EntityDetailProgressControl.getStepColor(stepInfo));if(openFailureDialog){this.openFailureDialog();return}this.save()},openFailureDialog:function(){if(this._failureDlg){this._failureDlg.close();this._failureDlg=null}var t=this.findStepInfoIndex(this._currentStepId);var e=t>=0?this._stepInfos[t]:null;var i=e?e["id"]:"";var s=this.findAllStepInfoBySemantics("apology");this._failureDlg=BX.CrmProcessFailureDialog.create(this._id+"_FAILURE",BX.CrmParamBag.create({entityType:this._entityType,entityId:this._entityId,initValue:i,failureTitle:s.length>0?this._manager.getMessage("failureTitle"):"",selectorTitle:this._manager.getMessage("selectorTitle"),success:this.findStepInfoBySemantics("success"),failure:this.findStepInfoBySemantics("failure"),apologies:s,callback:BX.delegate(this.onFailureDialogClose,this)}));this._failureDlg.open()},closeFailureDialog:function(){if(!this._failureDlg){return}this._failureDlg.close(false);this._failureDlg=null},onFailureDialogClose:function(dialog,params){if(this._failureDlg!==dialog){return}var stepInfo,stepIndex;BX.onCustomEvent(this,"CrmProgressControlBeforeFailureDialogClose",[this,this._failureDlg]);this.closeFailureDialog();var bid=BX.type.isNotEmptyString(params["bid"])?params["bid"]:"";if(bid!=="accept"){if(this._previousStepId!==""){stepIndex=this.findStepInfoIndex(this._previousStepId);stepInfo=this._stepInfos[stepIndex];this.setCurrentStep(stepInfo);this.adjustSteps(stepIndex,BX.Crm.EntityDetailProgressControl.getStepColor(this._stepInfos[stepIndex]))}return}var id=BX.type.isNotEmptyString(params["result"])?params["result"]:"";stepIndex=this.findStepInfoIndex(id);if(stepIndex>=0){stepInfo=this._stepInfos[stepIndex];if(stepInfo["semantics"]==="success"){var finalScript=BX.prop.getString(this._settings,"finalScript","");if(finalScript!==""){eval(finalScript);return}var finalUrl=BX.prop.getString(this._settings,"finalUrl","");if(finalUrl!==""){window.location=finalUrl;return}var verboseMode=BX.prop.getBoolean(this._settings,"verboseMode",false);if(verboseMode){if(this._previousStepId!==""){stepIndex=this.findStepInfoIndex(this._previousStepId);stepInfo=this._stepInfos[stepIndex];this.setCurrentStep(stepInfo);this.adjustSteps(stepIndex,BX.Crm.EntityDetailProgressControl.getStepColor(this._stepInfos[stepIndex]))}this.openTerminationDialog();return}}this.setCurrentStep(stepInfo,{keepPreviousStep:false});this.adjustSteps(stepIndex,BX.Crm.EntityDetailProgressControl.getStepColor(stepInfo));this.save()}},processStepHover:function(t){if(t.getIndex()<this._steps.length-1){this.setStepColorsBefore(t)}},processStepLeave:function(t){if(t.getIndex()<this._steps.length-1){this.recoverStepColorsBefore(t)}},processStepSelect:function(t){if(this._isReadOnly){return}this.closeTerminationDialog();if(BX.type.isFunction(this._manager["admitChange"])){this._manager.admitChange(this._currentStepId,t.getId()).then(function(t){if(!BX.prop.getBoolean(t,"succeeded",false)){return}var e=this.getStepById(BX.prop.getString(t,"currentId",""));if(e){this.setupStep(e)}}.bind(this))}else{this.setupStep(t)}},setupStep:function(t){if(this._entityEditorDialog!==null){return}var e=this.findStepInfoIndex(t.getId());if(e<0){return}var i=this._stepInfos[e];var s=i["semantics"];if(s==="failure"||s==="apology"||s==="success"&&(this._terminationControl||this.findStepInfoBySemantics("failure"))){if(this._terminationControl&&!this._terminationControl.isEnabled()){return}this.adjustSteps(t.getIndex(),t.getBackgroundColor());this.openTerminationDialog()}else{this.adjustSteps(t.getIndex(),t.getBackgroundColor());if(this._currentStepId!==i["id"]&&this.setCurrentStep(i)){this.save()}}}};if(typeof BX.Crm.EntityDetailProgressControl.defaultColors==="undefined"){BX.Crm.EntityDetailProgressControl.defaultColors={}}BX.Crm.EntityDetailProgressControl.getStepColor=function(t){var e=BX.prop.getString(t,"color");if(e!==""){return e}var i=BX.prop.getString(t,"semantics");return BX.Crm.EntityDetailProgressControl.defaultColors[i]};BX.Crm.EntityDetailProgressControl.create=function(t,e){var i=new BX.Crm.EntityDetailProgressControl;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityDetailProgressStep==="undefined"){BX.Crm.EntityDetailProgressStep=function(){this._id="";this._settings={};this._control=null;this._container=null;this._element=null;this._clickHandler=BX.delegate(this.onClick,this);this._hoverHandler=BX.delegate(this.onMouseHover,this);this._leaveHandler=BX.delegate(this.onMouseLeave,this);this._isVisible=true;this._displayName=""};BX.Crm.EntityDetailProgressStep.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._control=BX.prop.get(this._settings,"control");this._container=BX.prop.getElementNode(this._settings,"container");this._element=this._container.querySelector(".crm-entity-section-status-step-item-text");BX.bind(this._container,"click",this._clickHandler);BX.bind(this._element,"mouseenter",this._hoverHandler);BX.bind(this._element,"mouseleave",this._leaveHandler);if(BX.prop.getBoolean(this._settings,"isPassed",false)){this._element.style.color=this.calculateTextColor()}this.saveStyles();this._isVisible=BX.prop.getBoolean(this._settings,"isVisible",true)},getId:function(){return this._id},getIndex:function(){return BX.prop.getNumber(this._settings,"index",0)},isVisible:function(){return this._isVisible},setVisible:function(t){t=!!t;if(this._isVisible===t){return}this._isVisible=t;this._container.style.display=t?"":"none"},getSemantics:function(){return BX.prop.getString(this._settings,"semantics","")},getDisplayName:function(){return this._displayName},setDisplayName:function(t){this._displayName=t;if(this._element){this._element.innerHTML=BX.util.htmlspecialchars(this._displayName!==""?this._displayName:BX.prop.getString(this._settings,"name",this._id))}},onMouseHover:function(t){this._control.processStepHover(this)},onMouseLeave:function(t){this._control.processStepLeave(this)},onClick:function(t){this._control.processStepSelect(this)},calculateTextColor:function(){var t=this._element.getAttribute("data-base-color")?this._element.attributes["data-base-color"].value:getComputedStyle(this._element).borderBottomColor;return BX.Crm.EntityDetailProgressStep.calculateTextColor(t)},getBackgroundColor:function(){return this._element.getAttribute("data-base-color")?this._element.attributes["data-base-color"].value:getComputedStyle(this._element).borderBottomColor},setBackgroundColor:function(t){var e=encodeURIComponent(t);this._element.style.borderImage=BX.Crm.EntityDetailProgressStep.backgroundImageCss.replace(/#COLOR1#/gi,e).replace(/#COLOR2#/gi,e)},setColor:function(t){this._element.style.color=t},recoverColors:function(){var t=encodeURIComponent(BX.Crm.EntityDetailProgressStep.defaultBackgroundColor);if(this._element.getAttribute("data-base-color")){this._element.style.color="";var e=encodeURIComponent(this._element.getAttribute("data-base-color"));this._element.style.borderImage=BX.Crm.EntityDetailProgressStep.backgroundImageCss.replace(/#COLOR1#/gi,e).replace(/#COLOR2#/gi,t)}else{this._element.style.cssText=""}},saveStyles:function(){if(this._element.getAttribute("style")){BX.adjust(this._element,{attrs:{"data-style":this._element.getAttribute("style")}})}},recoverStyles:function(){this._element.style.cssText=this._element.getAttribute("data-style")?this._element.getAttribute("data-style"):""}};if(BX.Crm.EntityDetailProgressStep.backgroundImageCss==="undefined"){BX.Crm.EntityDetailProgressStep.backgroundImageCss=""}if(BX.Crm.EntityDetailProgressStep.defaultBackgroundColor==="undefined"){BX.Crm.EntityDetailProgressStep.defaultBackgroundColor=""}BX.Crm.EntityDetailProgressStep.calculateTextColor=function(t){var e,i,s;if(t>7){var n=t.split("(")[1].split(")")[0];n=n.split(",");e=parseInt(n[0]);i=parseInt(n[1]);s=parseInt(n[2])}else{if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(t)){var r=t.substring(1).split("");if(r.length===3){r=[r[0],r[0],r[1],r[1],r[2],r[2]]}r="0x"+r.join("");e=r>>16&255;i=r>>8&255;s=r&255}}var o=.21*e+.72*i+.07*s;return o<145?"#fff":"#333"};BX.Crm.EntityDetailProgressStep.create=function(t,e){var i=new BX.Crm.EntityDetailProgressStep;i.initialize(t,e);return i}}
//# sourceMappingURL=script.map.js