BX.namespace("BX.Crm.Order.Shipment.Product");if(typeof BX.Crm.Order.Shipment.Product.List==="undefined"){BX.Crm.Order.Shipment.Product.List=function(){this._controller=null;this._id=null;this._settings=null;this._formName="";this._form=null};BX.Crm.Order.Shipment.Product.List.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(this.dispatchSliderMessages,this))},dispatchSliderMessages:function(e){switch(e.getEventId()){case"CrmOrderShipmentProductList::productAdd":this.onProductAdd(e);break;case"CrmOrderShipmentProductListBarcodes::Save":this.onBarcodesSave(e);break;case"CrmOrderShipmentProductListBarcodes::Init":this.onBarcodesInit(e);break}},setController:function(e){this._controller=e;this._controller.setProductList(this)},getForm:function(){if(this._form===null&&this._formName){this._form=document.getElementsByName(this._formName)[0]}return this._form},setFormId:function(e){this._formName=e},getFormData:function(){var e=this.getForm();if(!e){return{}}var t=BX.ajax.prepareForm(e);if(t&&t.data&&t.data.ID){delete t.data.ID}var r=this._settings.storeBarcodeInfo;for(var o in r){if(!r.hasOwnProperty(o))continue;for(var n in r[o]){if(!r[o].hasOwnProperty(n))continue;if(r[o][n].IS_USED==="N")continue;if(!r[o][n].BARCODES)continue;var i=r[o][n].BARCODES,s=this.getProductStoreQuantityValue(o,n);if(i.length>0){var a=i.length>s?s:i.length;for(var d=0;d<a;d++){t.data=this.createBarcodeBranch(t.data,[n,"BARCODE_INFO",o,"PRODUCT"]);t.data["PRODUCT"][o]["BARCODE_INFO"][n]["BARCODE"].push(i[d])}}}}return!!t&&t.data?t.data:{}},createBarcodeBranch:function(e,t){if(t.length===0){if(typeof e["BARCODE"]==="undefined")e["BARCODE"]=[];return e}var r=t.pop();if(typeof e[r]==="undefined")e[r]={};e[r]=this.createBarcodeBranch(e[r],t);return e},setFormData:function(e){if(e&&e.PRODUCT_COMPONENT_RESULT){var t=BX.processHTML(e.PRODUCT_COMPONENT_RESULT);BX("crm-product-list-container").parentNode.innerHTML=t["HTML"];if(BX.type.isDomNode(BX(this._id+"-grid-settings-window")))BX.remove(BX(this._id+"-grid-settings-window"));setTimeout(function(){for(var e in t["SCRIPT"]){if(!t["SCRIPT"].hasOwnProperty(e))continue;BX.evalGlobal(t["SCRIPT"][e]["JS"]);delete t["SCRIPT"][e]}},1)}},onDataChanged:function(){this._controller.onDataChanged()},markAsChanged:function(){this._controller.markAsChangedItem()},onProductAdd:function(e){if(e.getEventId()==="CrmOrderShipmentProductList::productAdd"){var t=e.getData();if(t.entityTypeId===BX.CrmEntityType.enumeration.ordershipment){this._controller.onProductAdd(t.basketId)}}},onProductDelete:function(e){this._controller.onProductDelete(e)},showAddProductDialog:function(){var e=this.getSetting("addProductUrl",""),t=this.getFormData();if(t&&t.PRODUCT){for(var r in t.PRODUCT){if(t.PRODUCT.hasOwnProperty(r)){e+="&BID[]="+parseInt(r)}}}BX.SidePanel.Instance.open(e+"&"+Math.floor(Math.random()*99999))},getSetting:function(e,t){return typeof this._settings[e]!=="undefined"?this._settings[e]:t},setSetting:function(e,t){this._settings[e]=t},onBarcodeClick:function(e,t,r){var o=BX.util.add_url_param(this.getSetting("barcodesDialogUrl"),{basketId:t,storeId:r});BX.Crm.Page.openSlider(o,{width:500,cacheable:false})},onProductStoreQuantityChange:function(e,t,r){var o=this.getProductStoreAmountValue(e,t);r=parseFloat(r);if(r>0){if(r>o){this.getProductStoreQuantity(e,t).value=o}this.enableBarcodesButton(e,t)}else{if(r<0){this.getProductStoreQuantity(e,t).value=0}this.disableBarcodesButton(e,t)}this.markAsChanged();this.onDataChanged()},enableBarcodesButton:function(e,t){var r=BX("barcode_button_"+e+"_"+t);if(r&&r.disabled){r.disabled=false;BX.removeClass(r,"ui-btn-disabled")}},disableBarcodesButton:function(e,t){var r=BX("barcode_button_"+e+"_"+t);if(r&&!r.disabled){r.disabled=true;BX.addClass(r,"ui-btn-disabled")}},getProductStoreQuantity:function(e,t){return document.getElementsByName("PRODUCT["+e+"][BARCODE_INFO]["+t+"][QUANTITY]")[0]},getProductStoreQuantityValue:function(e,t){return this.getProductStoreQuantity(e,t).value},onAddStoreClick:function(e){this.showStoreDialog(e)},onBarcodesInit:function(e){if(e.getEventId()==="CrmOrderShipmentProductListBarcodes::Init"){var t=e.getData(),r=t.productBarcodes,o=t.storeId,n=t.basketId;var i=[],s;if(s=this.getStoreBarcode(n)){if(s[o]&&s[o].BARCODES){i=s[o].BARCODES}}r.setBarcodes(i,this.getProductStoreQuantityValue(n,o));r.setBarcodeCheckMethod(BX.delegate(this.checkBarcode,this))}},onBarcodesSave:function(e){if(e.getEventId()==="CrmOrderShipmentProductListBarcodes::Save"){var t=e.getData();if(t.basketId&&t.storeId&&t.barcodes){this.setStoreBarcode(t.basketId,t.storeId,t.barcodes);this.markAsChanged()}}},checkBarcode:function(e,t,r,o,n){BX.ajax.runComponentAction("bitrix:crm.order.shipment.product.list","checkProductBarcode",{mode:"ajax",data:{barcode:e,orderId:this._settings.params.ORDER_ID,basketId:t,storeId:r}}).then(function(e){if(e.status&&e.status==="success"){var t=null;if(e.data==="OK")t=true;else if(e.data==="ERROR")t=false;if(typeof o==="function"){o.apply(null,[t])}if(e.errors.length>0&&typeof n==="function"){n.apply(null,[e.errors])}}},function(e){{if(typeof n==="function"){n.apply(null,[e.errors])}}})},getStoreBarcode:function(e){if(typeof this._settings.storeBarcodeInfo[e]!=="undefined"){return this._settings.storeBarcodeInfo[e]}else{BX.debug("Can't find storeBarcodeInfo")}return null},setStoreBarcode:function(e,t,r){if(typeof this._settings.storeBarcodeInfo[e][t].BARCODES!=="undefined"){return this._settings.storeBarcodeInfo[e][t].BARCODES=r}else{BX.debug("Can't find storeBarcodeInfo")}},setStoreUsed:function(e,t,r){if(typeof this._settings.storeBarcodeInfo[e][t]!=="undefined"){this._settings.storeBarcodeInfo[e][t]["IS_USED"]=r}else{BX.debug("Can' find storeInfo")}},getStoresBarcodeByUsing:function(e,t){var r={},o=this.getStoreBarcode(e);if(o){if(!t){r=o}else{for(var n in o){if(o.hasOwnProperty(n)&&o[n]["IS_USED"]===t){r[n]=o[n]}}}}else{BX.debug("Can' find storeInfo")}return r},getStoresBarcodeCountByUsing:function(e,t){return Object.keys(this.getStoresBarcodeByUsing(e,t)).length},createStoresList:function(e){var t=BX.create("select"),r=this.getStoresBarcodeByUsing(e,"N");if(!r){return null}for(var o in r){if(r.hasOwnProperty(o)){if(!r[o].STORE_ID){continue}t.options.add(new Option(r[o].STORE_NAME,r[o].STORE_ID))}}return t},showStoreDialog:function(e){var t=this.createStoresList(e);var r=BX.create("form",{children:[BX.create("span",{props:{className:"fields enumeration field-wrap"},style:{width:"100%",marginBottom:"0px"},children:[BX.create("span",{props:{className:"fields enumeration field-item"},style:{paddingBottom:"10px"},children:[t]})]})]});var o=BX.PopupWindowManager.create("crm_order_shipment_product_stores",null,{content:r,titleBar:BX.message("CRM_ORDER_SPLT_CHOOSE_STORE"),autoHide:false,lightShadow:true,closeByEsc:true,width:400,overlay:{backgroundColor:"black",opacity:500}});o.setButtons([new BX.PopupWindowButton({text:BX.message("CRM_ORDER_SPLT_CHOOSE"),className:"popup-window-button-accept",events:{click:BX.proxy(function(){this.addStoreRow(e,t.value);o.close();o.destroy()},this)}}),new BX.PopupWindowButtonLink({text:BX.message("CRM_ORDER_SPLT_CLOSE"),className:"popup-window-button-link-cancel",events:{click:BX.proxy(function(){o.close();o.destroy()},this)}})]);o.show();o.resizeOverlay()},addStoreRow:function(e,t){var r=this.getStoreBarcode(e);if(!r){BX.debug("Can't find stores info");return}if(typeof r[t]==="undefined"){BX.debug("Can't find store");return}var o=this._settings.storeTmpl,n=this._settings.storeQuantityTmpl,i=this._settings.storeRemainingQuantityTmpl;if(r[t].BARCODE_MULTI==="Y"){var s=this._settings.storeBarcodeTmplB}else{s=this._settings.storeBarcodeTmplI}var a=0;for(var d in r[t]){if(!r[t].hasOwnProperty(d)){continue}var c=new RegExp("#"+d+"#","g"),u=BX.util.htmlspecialchars(r[t][d]);if(typeof u==="object"){continue}o=o.replace(c,u);n=n.replace(c,u);s=s.replace(c,u);i=i.replace(c,u);if(c==="QUANTITY"){a=u}}var h=this.createElement(o);BX.addClass(h,"crm-order-product-store-row-hidden");BX("crm-shipment-product-store-"+e).insertBefore(h,BX("crm-shipment-product-storeadd-"+e));var l=this.createElement(n);BX.addClass(l,"crm-order-product-store-row-hidden");BX("crm-shipment-product-quantity-"+e).appendChild(l);var f=this.createElement(i);BX.addClass(f,"crm-order-product-store-row-hidden");BX("crm-shipment-product-rquantity-"+e).appendChild(f);var B=this.createElement(s);BX.addClass(B,"crm-order-product-store-row-hidden");BX("crm-shipment-product-barcode-"+e).appendChild(B);setTimeout(function(){BX.removeClass(h,"crm-order-product-store-row-hidden");BX.removeClass(l,"crm-order-product-store-row-hidden");BX.removeClass(f,"crm-order-product-store-row-hidden");BX.removeClass(B,"crm-order-product-store-row-hidden")},100);this.setStoreUsed(e,t,true);if(this.getStoresBarcodeCountByUsing(e,"N")<=0){this.hideStoreAdder(e)}this.onProductStoreQuantityChange(e,t,a);this.markAsChanged()},createElement:function(e){return BX.create("div",{html:e}).firstChild},getProductStoreAmountValue:function(e,t){return this._settings.storeBarcodeInfo[e][t].AMOUNT},onStoreDeleteClick:function(e,t){var r=BX.findChildren(this.getForm(),{attribute:{"data-ps-basketcode":e,"data-ps-store-id":t}},true);for(var o in r){if(r.hasOwnProperty(o)){BX.addClass(r[o],"crm-order-product-store-row-hidden");(function(t,o){setTimeout(function(){r[t].parentNode.removeChild(r[t]);o.showStoreAdder(e)},400)})(o,this)}}this.setStoreUsed(e,t,"N");this.markAsChanged()},onBarcodeChange:function(e){this.checkBarcode(e.value,e.parentNode.getAttribute("data-ps-basketcode"),0,BX.proxy(function(t){this.showBarcodeCheckResult(e,t)},this),BX.proxy(function(e){BX.debug(e)},this));this.markAsChanged()},showBarcodeCheckResult:function(e,t){if(t===false){BX.addClass(e,"barcode-error");BX.removeClass(e,"barcode-ok")}else if(t===true){BX.addClass(e,"barcode-ok");BX.removeClass(e,"barcode-error")}else{BX.removeClass(e,"barcode-error");BX.removeClass(e,"barcode-ok")}},showStoreAdder:function(e){BX.removeClass(BX("crm-shipment-product-storeadd-"+e),"crm-order-product-store-row-hidden")},hideStoreAdder:function(e){BX.addClass(BX("crm-shipment-product-storeadd-"+e),"crm-order-product-store-row-hidden")}};BX.Crm.Order.Shipment.Product.List.create=function(e,t){var r=new BX.Crm.Order.Shipment.Product.List;r.initialize(e,t);return r}}