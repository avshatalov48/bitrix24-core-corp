BX.namespace("BX.Crm");if(typeof BX.setSelectValue==="undefined"){BX.setSelectValue=function(t,e){var i,s;var n=false;var r=!!t.getAttribute("multiple");if(!(e instanceof Array))e=[e];for(i=0;i<t.options.length;i++){for(s in e){if(t.options[i].value==e[s]){if(!n){n=true;t.selectedIndex=i}t.options[i].selected=true;break}}if(!r&&n)break}}}if(typeof BX.setTextContent==="undefined"){BX.setTextContent=function(t,e){if(t){if(t.textContent!==undefined)t.textContent=e;else t.innerText=e}}}if(typeof BX.CrmProductEditor==="undefined"){BX.CrmDiscountType={undefined:0,monetary:1,percentage:2};BX.CrmProductEditor=function(){this._id="";this._settings={};this._serviceUrl="";this._currencyId="";this._currencyFormat="# ?";this._clientTypeName="";this._products=[];this._dlgId="";this._addedProduct=null;this._deletedProduct=null;this._lastRowNumber=0;this._productCreateDialog=null;this._calculateTotalsTimer=null;this._locationID=0;this._topButtons=[];this._modeButton=null;this._discountExists=false;this._taxExists=false;this._viewMode=true;this._form=null;this._placeHolder=null;this._dragContainer=null;this._choiceBtnEnabled=false;this._overlay=null;this._hasLayout=false};BX.CrmProductEditor.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"CrmProductEditor: could not find service URL."}var i=this.isReadOnly();this._viewMode=!this.getSetting("initEditable",false)||i;this._locationID=this.isLDTaxAllowed()?this.getSetting("locationID",0):0;if(this.isLDTaxAllowed())BX.addCustomEvent("CrmProductRowSetLocation",BX.delegate(this._handleChangeLocation,this));var s=typeof this._settings["items"]!="undefined"?this._settings["items"]:[];for(var n=0;n<s.length;n++){var r=s[n];var a=r["rowID"];var o=r["settings"];o["readOnly"]=i;o["fields"]=this.getSetting("productFields",[]);this.getNextRowNumber();this._products.push(BX.CrmProduct.create(o,document.getElementById(a),this))}var l=document.getElementById(this.getSetting("choiceBtnID",""));if(l){this._topButtons.push(l);BX.bind(l,"click",BX.delegate(this.handleChoiceProductButtonClick,this));this._choiceBtnEnabled=true}var h=this.getSetting("addBtnID",""),d=BX(h);if(d){if(!this.isProductCardEnabled()){BX.bind(d,"click",BX.delegate(this._handleAddBtnClick,this))}this._topButtons.push(d)}var u=document.getElementById(this.getSetting("modeBtnID",""));if(u){this._modeButton=u;BX.bind(u,"click",BX.delegate(this.handleSwitchModeButtonClick,this))}this._currencyId=this.getSetting("currencyID","");this._currencyFormat=this.getSetting("currencyFormat","# ?");this._clientSelectorId=this.getSetting("clientSelectorId","CLIENT");this._clientTypeName=this.getSetting("clientTypeName","");BX.addCustomEvent("CrmClientSelectorChange",BX.delegate(this._handleEntitySelectorChangeValue,this));var c=this.getSetting("formID","");var _=BX.type.isNotEmptyString(c)?BX("form_"+c):null;if(_){this.setForm(_)}var T=BX(this.getSetting("addRowBtnID",""));if(T){BX.bind(T,"click",BX.delegate(this.handleProductRowAdd,this))}BX.addCustomEvent("CrmHandleShowProductEditor",BX.delegate(this._onSelectTab,this));BX.addCustomEvent("CrmProductSearchDialog_SelectProduct",BX.delegate(this.handleProductChoiceById,this));BX.addCustomEvent("InitiateInvoiceSumTotalChange",BX.delegate(this._handleRequestFromInvoiceOwner,this));BX.addCustomEvent("InvoiceAjaxSubmitResponse",BX.delegate(this._handleInvoiceAjaxSubmitResponse,this));if(this.isProductCardEnabled()){BX.addCustomEvent("SidePanel.Slider:onMessage",this.handleSliderMessage.bind(this))}this._discountExists=this.getSetting("_discountExistsInit",false);this._taxExists=this.getSetting("_taxExistsInit",false);this._dragContainer=BX.CrmProdoctRowListDragContainer.create(this.getId(),{editor:this,node:this.getTable()});this._dragContainer.addDragFinishListener(BX.delegate(this._onItemDrop,this));if(BX.prop.getBoolean(this._settings,"initLayout",true)){this.layout()}BX.onCustomEvent(window,"ProductRowEditorCreated",[this])},_handleAddBtnClick:function(){var t,e;t=BX.clone(this._settings["productCreateDialogSettings"]);t["initialControl"]=BX(this.getSetting("addBtnID",""));t["productAdditionHandler"]=BX.delegate(this.handleProductAdd,this);e=new BX.CrmProductCreateDialog(t);e.show()},_handleRequestFromInvoiceOwner:function(){BX.onCustomEvent("InvoiceSumTotalChange",[this])},_handleInvoiceAjaxSubmitResponse:function(t){if(t){var e=t["ob"];var i=t["info"];if(e&&e===this&&i){if(typeof i["TOTALS"]!="undefined"){this.refreshTotals(i["TOTALS"])}if(typeof i["TAX_LIST"]!="undefined"){this.setSetting("LDTaxes",i["TAX_LIST"]);this.refreshTaxList()}}}},getNextRowNumber:function(){return++this._lastRowNumber},getId:function(){return this._id},isReadOnly:function(){return this.getSetting("readOnly",false)},setReadOnly:function(t){var e=this.getSetting("readOnly",false);if(t!==e){this.setSetting("readOnly",t);if(t!==this._viewMode)this.toggleMode();this.layout()}},isInvoiceMode:function(){return this.getSetting("invoiceMode",false)},isViewMode:function(){return this._viewMode},getForm:function(){return this._form},setForm:function(t){if(this._form===t){return}this._form=t;if(!this._form){return}BX.bind(this._form,"submit",BX.delegate(this.handleFormSubmit,this))},getTable:function(){var t=this.getSetting("productContainerID","");return BX.type.isNotEmptyString(t)?BX(t):null},getCurrencyElement:function(){var t=this.getForm();return t?BX.findChild(t,{tag:"select",attr:{name:"CURRENCY_ID"}},true,false):null},getExchRateElement:function(){var t=this.getForm();return t?BX.findChild(t,{tag:"input",attr:{name:"EXCH_RATE"}},true,false):null},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},isProductCardEnabled:function(){return this.getSetting("newProductCard",false)===true},reinitialize:function(t){var e;for(e in this._products){if(this._products.hasOwnProperty(e)){this._products[e].clean()}}this._products=[];var i=this.getTable();for(e in t){if(!t.hasOwnProperty(e)){continue}var s=this._createRow();i.tBodies[0].appendChild(s);var n=BX.CrmProduct.create(this._prepareProductSettings(t[e]),s,this);n.layout();this._products[this._products.length++]=n}this.calculateTotals(false)},_createRow:function(){var t=this.getSetting("rowIdPrefix","");var e=BX(t+"#N#");var i,s;var n=BX.clone(e,true);var r=this._products.length;i=this.getNextRowNumber();s=i-1;n.id=n.id.replace("#N#",s);n.className=i%2===0?"crm-items-table-even-row":"crm-items-table-odd-row";BX.findChildren(n,function(t){if(t&&BX.type.isElementNode(t)){if(t.id){var e=t.id;if(e&&e.indexOf("#N#")>=0)t.id=e.replace("#N#",s)}if(t.className==="crm-item-num")BX.setTextContent(t,(r+1).toString()+".")}},true);n.style.display="";return n},handleBeforeSearch:function(t){if(t["entityType"]=="product"){t["postData"]["ENABLE_SEARCH_BY_ID"]="N";if(this._currencyId!==""){t["postData"]["CURRENCY_ID"]=this._currencyId}var e=this.getExchRateElement();if(e){var i=e.value;t["postData"]["EXCH_RATE"]=BX.type.isNotEmptyString(i)?parseFloat(i):0}t["postData"]["ENABLE_RAW_PRICES"]=!!this.getSetting("enableRawCatalogPricing",true)?"Y":"N"}},productsToJson:function(){var t="";if(this._products.length>0){for(var e=0;e<this._products.length;e++){t+=(t.length>0?", ":"")+this._products[e].toJson()}t="["+t+"]"}return t},handleFormSubmit:function(){if(!this._form){return}var t=this.getSetting("dataFieldName","PRODUCT_ROW_DATA");var e=BX.findChild(this._form,{tagName:"input",attr:{name:t}},true,false);if(!e){e=BX.create("input",{attrs:{type:"hidden",name:t}});this._form.appendChild(e)}var i=t+"_SETTINGS";var s=BX.findChild(this._form,{tagName:"input",attr:{name:i}},true,false);if(!s){s=BX.create("input",{attrs:{type:"hidden",name:i}});this._form.appendChild(s)}if(this._hasLayout){this.cleanProductRows();this.resortProducts()}e.value=this.productsToJson();s.value='{"ENABLE_DISCOUNT": "'+(this.isDiscountEnabled()?"Y":"N")+'",'+'"ENABLE_TAX": "'+(this.isTaxEnabled()?"Y":"N")+'"}'},removeFormFields:function(){if(!this._form){return}var t=this.getSetting("dataFieldName","PRODUCT_ROW_DATA");var e=BX.findChild(this._form,{tagName:"input",attr:{name:t}},true,false);if(e){BX.remove(e)}var i=t+"_SETTINGS";var s=BX.findChild(this._form,{tagName:"input",attr:{name:i}},true,false);if(s){BX.remove(s)}},handleControlSave:function(t){var e=this.getSetting("dataFieldName","PRODUCT_ROW_DATA");t[e]=this.productsToJson();t[e+"_SETTINGS"]='{"ENABLE_DISCOUNT": "'+(this.isDiscountEnabled()?"Y":"N")+'",'+'"ENABLE_TAX": "'+(this.isTaxEnabled()?"Y":"N")+'"}';return t},handleChoiceProductButtonClick:function(t){if(!this._choiceBtnEnabled)return;this._choiceBtnEnabled=false;this.createOverlay(995);var e=document.getElementById(this.getSetting("choiceBtnID",""));if(e)BX.addClass(e,"webform-small-button-wait");var i="crm_productrow_list";var s=this.getSetting("jsEventsManagerId","");var n=BX.CrmProductSearchDialogWindow.create({content_url:"/bitrix/components/bitrix/crm.product_row.list/product_choice_dialog.php"+"?caller="+i+"&JS_EVENTS_MANAGER_ID="+BX.util.urlencode(s)+"&sessid="+BX.bitrix_sessid(),closeWindowHandler:BX.delegate(this.handleChoiceProductDialogClose,this),showWindowHandler:BX.delegate(this.handleChoiceProductDialogShow,this),jsEventsManagerId:s,height:Math.max(500,window.innerHeight-400),width:Math.max(800,window.innerWidth-400),minHeight:500,minWidth:800,draggable:true,resizable:true});n.show()},handleChoiceProductDialogClose:function(){this._choiceBtnEnabled=true},handleChoiceProductDialogShow:function(){var t=document.getElementById(this.getSetting("choiceBtnID",""));if(t)BX.removeClass(t,"webform-small-button-wait");this.removeOverlay()},createOverlay:function(t){t=parseInt(t);if(!this._overlay){var e=BX.GetWindowScrollSize();this._overlay=document.body.appendChild(BX.create("DIV",{style:{position:"absolute",top:"0px",left:"0px",zIndex:t||parseInt(this.DIV.style.zIndex)-2,width:e.scrollWidth+"px",height:e.scrollHeight+"px"}}));BX.unbind(window,"resize",BX.proxy(this._resizeOverlay,this));BX.bind(window,"resize",BX.proxy(this._resizeOverlay,this))}},removeOverlay:function(){if(this._overlay&&this._overlay.parentNode){this._overlay.parentNode.removeChild(this._overlay);BX.unbind(window,"resize",BX.proxy(this._resizeOverlay,this));this._overlay=null}},_resizeOverlay:function(){var t=BX.GetWindowScrollSize();this._overlay.style.width=t.scrollWidth+"px"},handleSwitchModeButtonClick:function(){if(!this._viewMode){BX.showWait(this.getSetting("containerID",""),BX.CrmProductEditorMessages.saving);this.cleanProductRows();this.resortProducts();this.saveProductRows()}else{this.toggleMode();if(this.getProductCount()===0)this.productRowAdd()}},handleProductChoice:function(t,e,i){e=!!e;var s=typeof t["product"]!="undefined"&&typeof t["product"][0]!="undefined"?t["product"][0]:null;if(!s){return}var n=typeof s["customData"]!=="undefined"?s["customData"]:{};var r=typeof n["measure"]!=="undefined"?n["measure"]:{};var a={id:s["id"],name:s["title"],quantity:i instanceof BX.CrmProduct?i.getQuantity():1,price:typeof n["price"]!="undefined"?parseFloat(n["price"]):0,customized:false,measureCode:typeof r["code"]!=="undefined"?parseInt(r["code"]):0,measureName:typeof r["name"]!=="undefined"?r["name"]:"",tax:typeof n["tax"]!=="undefined"?n["tax"]:{}};if(this._viewMode){this.toggleMode()}if(i){this._setItem(i,a)}else{this._addItem(a,true)}if(!e){this.focusLastRow()}obCrm[this._dlgId]&&obCrm[this._dlgId].ClearSelectItems()},handleProductChoiceById:function(t){t=parseInt(t);if(t<=0){return}var e=this.getCurrencyId();var i=this.getSetting("productSearchUrl","");BX.ajax({url:i,method:"POST",dataType:"json",data:{MODE:"SEARCH",RESULT_WITH_VALUE:"Y",CURRENCY_ID:e,ENABLE_RAW_PRICES:"Y",ENABLE_SEARCH_BY_ID:"N",MULTI:"N",VALUE:"["+t+"]",LIMIT:1},onsuccess:BX.delegate(this.onProductChoiceByIdSuccess,this),onfailure:BX.delegate(this.onProductChoiceByIdFailure,this)})},onProductChoiceByIdSuccess:function(t,e){var i;if(t&&t["data"]){i=t["data"];if(i[0]){i={product:[i[0]]};this.handleProductChoice(i,true,e)}}},onProductChoiceByIdFailure:function(t){},handleProductSearchSelect:function(t,e){if(!t||!e){return}var i=typeof e["customData"]!=="undefined"?e["customData"]:{};var s=typeof i["measure"]!=="undefined"?i["measure"]:{};var n={id:e["id"],name:e["title"],quantity:1,price:typeof i["price"]!="undefined"?parseFloat(i["price"]):0,customized:false,measureCode:typeof s["code"]!=="undefined"?parseInt(s["code"]):0,measureName:typeof s["name"]!=="undefined"?s["name"]:"",tax:typeof i["tax"]!=="undefined"?i["tax"]:{}};this._setItem(t,n)},handleProductDeletion:function(t){if(!window.confirm(BX.CrmProductEditorMessages["deletionConfirm"])){return false}this._deleteProduct(t);this.calculateTotalsDelayed();return true},_onDeleteItemRequestSuccess:function(t){if(this._processAjaxError(t)){return}if(this._deletedProduct){this._deleteProduct(this._deletedProduct);this._deletedProduct=null}this.calculateTotalsDelayed()},_ondeleteItemRequestFailure:function(t){this._processAjaxError(t)},handleSliderMessage:function(t){if(t.getEventId()==="Catalog.ProductCard::onCreate"){var e=t.getSender();if(e){var i=t.getData();var s=e.getData();if(s.has("product")){this.handleProductAddFromSlider(i,s.get("product"))}else{this.handleProductAddFromSlider(i)}if(i.sender&&i.sender._enableCloseConfirmation){i.sender._enableCloseConfirmation=false}e.close()}}},handleProductAddFromSlider:function(t,e){if(!t||!t.entityId)return;BX.ajax({url:this.getSetting("productSearchUrl",""),method:"POST",dataType:"json",data:{MODE:"SEARCH",RESULT_WITH_VALUE:"Y",CURRENCY_ID:this.getCurrencyId(),ENABLE_RAW_PRICES:"Y",ENABLE_SEARCH_BY_ID:"Y",MULTI:"N",VALUE:t.entityId,LIMIT:1},onsuccess:function(t){this.onProductChoiceByIdSuccess(t,e)}.bind(this)})},handleProductAdd:function(t){var e=typeof t["product"]!="undefined"&&typeof t["product"][0]!="undefined"?t["product"][0]:null;if(!e){return}var i=typeof e["customData"]!=="undefined"?e["customData"]:{};var s=typeof i["measure"]!=="undefined"?i["measure"]:{};var n={id:e["id"],name:e["title"],quantity:1,price:typeof i["price"]!="undefined"?parseFloat(i["price"]):0,customized:false,measureCode:typeof s["code"]!=="undefined"?parseInt(s["code"]):0,measureName:typeof s["name"]!=="undefined"?s["name"]:"",tax:typeof i["tax"]!=="undefined"?i["tax"]:{}};if(this._viewMode)this.toggleMode();this._addItem(n,true);this.focusLastRow()},handleProductRowAdd:function(t){this.productRowAdd();return BX.PreventDefault(t)},productRowAdd:function(){var t={id:0,name:"",quantity:1,price:0,customized:true};if(this._viewMode)this.toggleMode();this._addItem(t,false);this.focusLastRow()},handleProductFocusChange:function(t,e){BX.onCustomEvent("onProductEditorFocusChange",[this,e])},focusLastRow:function(){var t=this._products.length,e,i,s;if(t>0){e=this._products[t-1];this.focusProductRow(e)}},focusProductRow:function(t){if(t){var e=t._container;if(e){var i=BX(e.id+"_PRODUCT_NAME");if(i){i.focus()}}}},getProducts:function(){return this._products},createPlaceHolder:function(t){var e=t["id"];var i=t["index"];var s=this.getTable();if(i<0){i=this._products.length}if(this._placeHolder){if(this._placeHolder.getProductIndex()===i){return this._placeHolder}s.deleteRow(this._placeHolder.getNode().rowIndex);this._placeHolder=null}this._placeHolder=BX.CrmProductRowListPlaceholder.create({editor:this,node:s.insertRow(i+1),productId:e,productIndex:i});this._placeHolder.layout();return this._placeHolder},getPlaceHolder:function(){return this._placeHolder},removePlaceHolder:function(){if(this._placeHolder){var t=this.getTable();t.deleteRow(this._placeHolder.getNode().rowIndex);this._placeHolder=null}},processDraggedItemDrop:function(t){if(this._viewMode){return}var e=t.getContextData();var i=BX.type.isNotEmptyString(e["contextId"])?e["contextId"]:"";if(i!==BX.CrmProdoctRowListDragItem.contextId){return}var s=typeof e["product"]!=="undefined"?e["product"]:null;if(!s){return}var n=this.getTable();var r=this.getPlaceHolder();if(r){n.tBodies[0].insertBefore(s.getContainer(),r.getNode())}else{n.tBodies[0].appendChild(s.getContainer())}var a=this.getProductIndex(s);var o=r.getProductIndex();if(a>=0&&o>=0&&a!==o){this._products.splice(a,1);if(a<o){o--}this._products.splice(o,0,s)}this._renumProducts(0);this.resortProducts()},_onItemDrop:function(t,e,i,s){this.processDraggedItemDrop(e)},_prepareProductSettings:function(t,e){e=e&&e instanceof BX.CrmProduct?e:null;var i=this._products.length;var s=parseInt(t["id"]);if(isNaN(s)){s=0}var n=BX.type.isNotEmptyString(t["name"])?t["name"]:"";var r=parseFloat(t["quantity"]);if(isNaN(r)){r=1}var a=parseFloat(t["price"]);if(isNaN(a)){a=0}var o=parseInt(t["measureCode"]);var l=BX.type.isNotEmptyString(t["measureName"])?t["measureName"]:"";if(isNaN(o)||o<0||l===""){var h=this.getSetting("defaultMeasure",null);if(h){o=h["CODE"];l=h["SYMBOL"]}else{o=0;l=""}}var d=typeof t["discount"]!=="undefined"?t["discount"]:null;if(d){var u=typeof d["discountType"]!=="undefined"?parseInt(d["discountType"]):BX.CrmDiscountType.percentage;if(u!==BX.CrmDiscountType.percentage&&u!==BX.CrmDiscountType.monetary){u=BX.CrmDiscountType.percentage}var c=typeof d["discountRate"]!=="undefined"?BX.CrmProduct.round(parseFloat(d["discountRate"]),2):0;var _=typeof d["discountSum"]!=="undefined"?BX.CrmProduct.round(parseFloat(d["discountSum"]),2):0}var T={PRODUCT_ID:s,PRODUCT_NAME:n,QUANTITY:r,MEASURE_CODE:o,MEASURE_NAME:l,PRICE:a,PRICE_EXCLUSIVE:a};if(d){T["DISCOUNT_TYPE_ID"]=u;T["DISCOUNT_RATE"]=c;T["DISCOUNT_SUM"]=_}var g=!!t["customized"];if(this.isTaxAllowed()){var f=typeof t["tax"]!=="undefined"?t["tax"]:{};var C=typeof f["id"]!=="undefined"?parseInt(f["id"]):0;var p=C>0?this.getTaxById(C):null;if(!p&&s===0){p=this.getSetting("defaultTax",null)}T["TAX_RATE"]=p?BX.CrmProduct.round(parseFloat(p["VALUE"]),2):0;var E=typeof f["included"]!=="undefined"?!!f["included"]:false;if(E){T["PRICE_EXCLUSIVE"]=BX.CrmProduct.round(BX.CrmProduct.calculateExclusivePrice(T["PRICE"],T["TAX_RATE"]),2)}else{T["PRICE"]=BX.CrmProduct.round(BX.CrmProduct.calculateInclusivePrice(T["PRICE"],T["TAX_RATE"]),2)}if(i>0&&this.getSetting("taxUniform",true)){var I=this._products[i-1];if(I!==e||i>1){if(I===e)I=this._products[i-2];var m=I.isTaxIncluded();if(m!==E){E=m;g=true}}}T["TAX_INCLUDED"]=E}else{T["TAX_RATE"]=0;T["TAX_INCLUDED"]=false}T["CUSTOMIZED"]=g;var S=0;if(e){S=e.getSort()}else{for(var D=0;D<i;D++){var N=this._products[D].getSort();if(S<N)S=N}S+=10}T["SORT"]=S;T["readOnly"]=this.isReadOnly();T["fields"]=this.getSetting("productFields",[]);return T},_addItem:function(t,e){if(!!e)this._removeLonelyEmptyRow();var i=this.getTable();var s=this.getSetting("rowIdPrefix","");var n=BX(s+"#N#");var r=BX.clone(n,true);var a=this.getSetting("productFields",[]);var o=this._products.length;var l,h;l=this.getNextRowNumber();h=l-1;r.id=r.id.replace("#N#",h);r.className=l%2===0?"crm-items-table-even-row":"crm-items-table-odd-row";BX.findChildren(r,function(t){if(t&&BX.type.isElementNode(t)){if(t.id){var e=t.id;if(e&&e.indexOf("#N#")>=0)t.id=e.replace("#N#",h)}if(t.className==="crm-item-num")BX.setTextContent(t,(o+1).toString()+".")}},true);r.style.display="";i.tBodies[0].appendChild(r);var d=this._prepareProductSettings(t);var u=BX.CrmProduct.create(d,r,this);this._products[o++]=u;if(o===1)this.layout();else u.layout();BX.onCustomEvent(this,"productAdd",[{product:u}]);this.calculateTotalsDelayed()},_setItem:function(t,e){var i=this._prepareProductSettings(e,t);t.setSettings(i);t.layout();BX.onCustomEvent(this,"productSet",[{product:t}]);this.calculateTotalsDelayed()},_onAddItemRequestSuccess:function(t){if(this._processAjaxError(t)){return}if(this._addedProduct){if(typeof t["PRODUCT_ROW"]!="undefined"){var e=t["PRODUCT_ROW"];if(typeof e["ID"]!="undefined"){this._addedProduct.setId(e["ID"])}}this._addedProduct=null}this.calculateTotalsDelayed()},_onAddItemRequestFailure:function(t){this._processAjaxError(t)},_removeLonelyEmptyRow:function(){var t,e;if(!this._viewMode){if(this._products.length===1&&this._products[0]instanceof BX.CrmProduct){e=BX.util.trim(this._products[0].getProductName());if(e===""){this._products[0].clean();this._deleteProduct(this._products[0])}}}},_deleteProduct:function(t){for(var e=0;e<this._products.length;e++){if(this._products[e]==t){this._products.splice(e,1);break}}if(this._products.length===0){BX.onCustomEvent(this,"sumTotalChange",["0.00",{TOTAL_SUM_FORMATTED:"",TOTAL_SUM_FORMATTED_SHORT:"",TOTAL_SUM:"0"}]);if(this.getSetting("initEditable",false)&&this.getSetting("hideModeButton",false))this.layoutElements(this._viewMode)}this._renumProducts(e);BX.onCustomEvent(this,"productRemove",[{product:t}])},_renumProducts:function(t){t=t?parseInt(t):0;for(var e=t;e<this._products.length;e++)this._products[e].setNumber(e+1)},_onSelectTab:function(t){if(t===this)BX.CrmProductEditor.arrangeColumns(this,true)},_onUpdateItemRequestSuccess:function(t){if(this._processAjaxError(t)){return}this.calculateTotalsDelayed()},_onUpdateItemRequestFailure:function(t){this._processAjaxError(t)},_onSaveProductsRequestSuccess:function(t){if(this._processAjaxError(t)){return}if(BX.type.isArray(t["PRODUCT_ROW_IDS"])){var e=t["PRODUCT_ROW_IDS"];if(e.length===this._products.length){for(var i=0,s=e.length;i<s;i++){this._products[i].setId(e[i])}}}if(!this._viewMode)this.toggleMode();BX.closeWait();this.calculateTotalsDelayed()},_onSaveProductsRequestFailure:function(t){BX.closeWait();this._processAjaxError(t)},refreshTaxList:function(){var t=this.getSetting("LDTaxes",[]);var e=this.getSetting("taxValueID","total_tax");if(e){var i=BX(e);i=i&&i.parentNode?i.parentNode:null;i=i&&i.parentNode?i.parentNode:null;if(i){var s;var n=i.parentNode;if(n){if(t&&typeof t==="object"&&t.length>0){while(s=BX.findNextSibling(i,{tag:"tr",class:"crm-tax-value"})){r=s.sibling;n.removeChild(s)}var r=i.nextSibling;i.style.display="none";var a,o,l=!this.getSetting("hideAllTaxes",false)&&(this.isLDTaxAllowed()||this.isTaxAllowed()&&this.isTaxEnabled())?"":"none";for(var h=0;h<t.length;h++){a=BX.create("TR",{attrs:{class:"crm-view-table-total-value crm-tax-value"},children:[BX.create("TD",{children:[BX.create("NOBR",{text:BX.util.htmlspecialchars(t[h]["TAX_NAME"]+":")})]}),BX.create("TD",{children:[o=BX.create("STRONG",{attrs:{class:"crm-view-table-total-value"},html:t[h]["TAX_VALUE"]})]})]});if(a){if(l!=="")a.style.display=l;if(h===0){n.removeChild(i);o.setAttribute("id",e)}if(r)n.insertBefore(a,r);else n.appendChild(a)}}}}}}},calculateTotals:function(t){if(typeof t==="undefined"){t=true}var e=[];for(var i=0;i<this._products.length;i++){var s=this._products[i];s.saveSettings();var n=s.getProductId();var r={PRODUCT_ID:n,PRODUCT_NAME:s.getProductName(),QUANTITY:s.getQuantity(),DISCOUNT_TYPE_ID:s.getDiscountTypeId(),DISCOUNT_RATE:s.getDiscountRate(),DISCOUNT_SUM:s.getDiscountSum(),TAX_RATE:s.getTaxRate(),TAX_INCLUDED:s.isTaxIncluded()?"Y":"N",PRICE_EXCLUSIVE:s.getExclusivePrice(),PRICE:s.getPrice(),CUSTOMIZED:"Y"};e.push(r)}var a=this._updateCalculatedTotals;if(!t){a=this._updateNoDemandCalculatedTotals}BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{MODE:"CALCULATE_TOTALS",OWNER_TYPE:this.getSetting("ownerType",""),OWNER_ID:this.getSetting("ownerID",0),PERMISSION_ENTITY_TYPE:this.getSetting("permissionEntityType",""),PRODUCTS:e,CURRENCY_ID:this._currencyId,CLIENT_TYPE_NAME:this.getClientTypeName(),SITE_ID:this.getSetting("siteId",""),LOCATION_ID:this._locationID,ALLOW_LD_TAX:this.isLDTaxAllowed()?"Y":"N",LD_TAX_PRECISION:this.getSetting("taxListPercentPrecision",2)},onsuccess:BX.delegate(a,this),onfailure:BX.delegate(this._onCalculateTotalsRequestFailure,this)})},calculateTotalsDelayed:function(){if(this._calculateTotalsTimer)clearTimeout(this._calculateTotalsTimer);this._calculateTotalsTimer=setTimeout(BX.delegate(this._handleCalculateTotalsTimer,this),1e3)},_handleChangeLocation:function(t){var e=0,i=document.getElementsByName(t)[0];if(i&&BX.type.isElementNode(i)){e=i.value;this._locationID=e;this.calculateTotalsDelayed()}},_handleEntitySelectorChangeValue:function(t,e){var i=e["target"];if(i!=="primaryEntity"){return}var s=null;if(BX.type.isPlainObject(e["selectorInfo"])&&BX.type.isNotEmptyString(e["selectorInfo"]["id"])){s=e["selectorInfo"]["id"]}if(s!==this._clientSelectorId){return}var n=BX.type.isPlainObject(e["data"])?e["data"]:{};var r=BX.type.isNotEmptyString(n["primaryEntityTypeName"])?n["primaryEntityTypeName"]:"";var a=n["primaryEntityInfo"]instanceof BX.CrmEntityInfo?n["primaryEntityInfo"].getId():0;var o=this.getClientTypeName();var l=o;if(o===BX.CrmEntityType.names.company){if(r===BX.CrmEntityType.names.company&&a==0)l=BX.CrmEntityType.names.contact}else{if(r===BX.CrmEntityType.names.company&&a>0)l=BX.CrmEntityType.names.company;else l=BX.CrmEntityType.names.contact}if(o!==l){this.setClientTypeName(l);if(this.isLDTaxAllowed())this.calculateTotalsDelayed()}},_handleCalculateTotalsTimer:function(){this.calculateTotals()},_updateCalculatedTotals:function(t){if(this._processAjaxError(t)){return}if(typeof t["TOTALS"]!="undefined"){this.refreshTotals(t["TOTALS"])}if(typeof t["LD_TAXES"]!="undefined"){this.setSetting("LDTaxes",t["LD_TAXES"]);this.refreshTaxList()}},_updateNoDemandCalculatedTotals:function(t){if(this._processAjaxError(t)){return}if(typeof t["TOTALS"]!="undefined"){this.refreshTotals(t["TOTALS"],false)}if(typeof t["LD_TAXES"]!="undefined"){this.setSetting("LDTaxes",t["LD_TAXES"]);this.refreshTaxList()}},refreshTotals:function(t,e){var i,s,n;n=BX(this.getSetting("TOTAL_BEFORE_DISCOUNT_ID","total_before_discount"));if(n){s=BX.type.isNotEmptyString(t["TOTAL_BEFORE_DISCOUNT_FORMATTED"])?t["TOTAL_BEFORE_DISCOUNT_FORMATTED"]:"";i=typeof t["TOTAL_BEFORE_DISCOUNT"]!="undefined"?parseFloat(t["TOTAL_BEFORE_DISCOUNT"]).toFixed(2):"0.00";n.innerHTML=s!==""?s:this._currencyFormat.replace(/(^|[^&])#/,"$1"+i)}n=BX(this.getSetting("TOTAL_DISCOUNT_ID","total_discount"));if(n){s=BX.type.isNotEmptyString(t["TOTAL_DISCOUNT_FORMATTED"])?t["TOTAL_DISCOUNT_FORMATTED"]:"";i=typeof t["TOTAL_DISCOUNT"]!="undefined"?parseFloat(t["TOTAL_DISCOUNT"]).toFixed(2):"0.00";this._discountExists=parseFloat(i)!==0;n.innerHTML=s!==""?s:this._currencyFormat.replace(/(^|[^&])#/,"$1"+i)}n=BX(this.getSetting("TOTAL_BEFORE_TAX_ID","total_before_tax"));if(n){s=BX.type.isNotEmptyString(t["TOTAL_BEFORE_TAX_FORMATTED"])?t["TOTAL_BEFORE_TAX_FORMATTED"]:"";i=typeof t["TOTAL_BEFORE_TAX"]!="undefined"?parseFloat(t["TOTAL_BEFORE_TAX"]).toFixed(2):"0.00";n.innerHTML=s!==""?s:this._currencyFormat.replace(/(^|[^&])#/,"$1"+i)}n=BX(this.getSetting("taxValueID","total_tax"));if(n){s=BX.type.isNotEmptyString(t["TOTAL_TAX_FORMATTED"])?t["TOTAL_TAX_FORMATTED"]:"";i=typeof t["TOTAL_TAX"]!="undefined"?parseFloat(t["TOTAL_TAX"]).toFixed(2):"0.00";this._taxExists=parseFloat(i)!==0;n.innerHTML=s!==""?s:this._currencyFormat.replace(/(^|[^&])#/,"$1"+i)}n=BX(this.getSetting("SUM_TOTAL_ID","sum_total"));if(n){s=BX.type.isNotEmptyString(t["TOTAL_SUM_FORMATTED"])?t["TOTAL_SUM_FORMATTED"]:"";i=typeof t["TOTAL_SUM"]!="undefined"?parseFloat(t["TOTAL_SUM"]).toFixed(2):"0.00";n.innerHTML=s!==""?s:this._currencyFormat.replace(/(^|[^&])#/,"$1"+i);BX.onCustomEvent(this,"sumTotalChange",[i,t,e])}this.switchTotalElements()},_onCalculateTotalsRequestFailure:function(t){self._processAjaxError(t)},registerProductDialogId:function(t){this._dlgId=t},getCurrencyId:function(){return this._currencyId},setCurrencyId:function(t){if(this._currencyId===t){return}if(this._settings["productCreateDialogSettings"])this._settings["productCreateDialogSettings"]["ownerCurrencyId"]=t;this.calculateProductPrices(t)},getClientTypeName:function(){return this._clientTypeName},setClientTypeName:function(t){if(this._clientTypeName===t){return}this._clientTypeName=t},getProductCount:function(){return this._products.length},convertMoney:function(t,e,i,s){var n=this;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{MODE:"CONVERT_MONEY",OWNER_TYPE:this.getSetting("ownerType",""),OWNER_ID:this.getSetting("ownerID",0),PERMISSION_ENTITY_TYPE:this.getSetting("permissionEntityType",""),DATA:{SRC_SUM:t,SRC_CURRENCY_ID:e,DST_CURRENCY_ID:i},SITE_ID:this.getSetting("siteId","")},onsuccess:function(t){if(t["SUM"]){if(n._processAjaxError(t)){return}try{s(parseFloat(t["SUM"]))}catch(t){}}},onfailure:function(t){n._processAjaxError(t)}})},setCurrencyFormat:function(t){if(typeof t!=="string"||t.length<=0)t="# ?";this._currencyFormat=t;var e=BX.util.trim(t.replace("#",""));var i=this.getSetting("discountTypeText",[]);if(i[BX.CrmDiscountType.monetary])i[BX.CrmDiscountType.monetary]=e;var s=BX(this.getSetting("priceTitleId",""));if(s){var n=BX.CrmProductEditorMessages["priceTitleText"];n=n.replace("#CURRENCY#"," ("+e+")");s.innerHTML=n}},calculateProductPrices:function(t){var e=this._currencyId;this._currencyId=t;var i=this.getExchRateElement();var s=[];var n=this.isTaxAllowed();var r,a;for(var o=0;o<this._products.length;o++){var l=this._products[o];r=l.getDiscountTypeId();a=l.isTaxIncluded();s.push({ID:l.getSetting("PRODUCT_ID","0"),PRICE:l.getSetting(n&&!a?"PRICE_NETTO":"PRICE_BRUTTO","0.0"),DISCOUNT_TYPE_ID:r,DISCOUNT_VALUE:r===BX.CrmDiscountType.percentage?l.getDiscountRate():l.getDiscountSum()})}var h=this;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{MODE:"CALC_PRODUCT_PRICES",OWNER_TYPE:this.getSetting("ownerType",""),OWNER_ID:this.getSetting("ownerID",0),PERMISSION_ENTITY_TYPE:this.getSetting("permissionEntityType",""),DATA:{SRC_CURRENCY_ID:e,SRC_EXCH_RATE:i?parseFloat(i.value):0,DST_CURRENCY_ID:t,PRODUCTS:s},SITE_ID:this.getSetting("siteId","")},onsuccess:function(t){if(typeof t["EXCH_RATE"]&&i){i.value=parseFloat(t["EXCH_RATE"])}if(t["PRODUCTS"]){if(h._processAjaxError(t)){return}var e=h.isTaxAllowed();var s,n;h.setCurrencyFormat(t["CURRENCY_FORMAT"]?t["CURRENCY_FORMAT"]:"# ?");for(var r=0;r<t["PRODUCTS"].length;r++){var a=t["PRODUCTS"][r];var o=h._products[r];s=parseInt(a["DISCOUNT_TYPE_ID"]);if(s!==BX.CrmDiscountType.percentage&&s!==BX.CrmDiscountType.monetary){s=BX.CrmDiscountType.percentage}n=o.isTaxIncluded();o.setFieldValue(e&&!n?"PRICE_NETTO":"PRICE_BRUTTO",parseFloat(a["PRICE"]).toFixed(2),true);if(s===BX.CrmDiscountType.monetary){o.refreshCurrencyText();o.setFieldValue("DISCOUNT_SUM",parseFloat(a["DISCOUNT_VALUE"]).toFixed(2),true)}}}if(t["PRODUCT_POPUP_ITEMS"]&&h._dlgId.length>0){obCrm[h._dlgId].SetPopupItems("product",t["PRODUCT_POPUP_ITEMS"])}},onfailure:function(t){h._processAjaxError(t)}})},getMeasures:function(){return this.getSetting("measures",[])},prepareMeasureOptionData:function(){var t=[];var e=this.getSetting("measures",[]);for(var i=0;i<e.length;i++){t.push({text:e[i]["SYMBOL"],value:e[i]["CODE"]})}return t},isTaxAllowed:function(){return this.getSetting("allowTax",false)},isLDTaxAllowed:function(){return this.getSetting("allowLDTax",false)},isTaxEnabled:function(){return this.getSetting("enableTax",false)},isDiscountEnabled:function(){return this.getSetting("enableDiscount",false)},getTaxes:function(){return this.getSetting("taxes",[])},prepareTaxOptionData:function(){var t=[];var e=this.getSetting("taxes",[]);for(var i=0;i<e.length;i++){t.push({text:e[i]["NAME"],value:e[i]["VALUE"]})}return t},getTaxById:function(t){t=parseInt(t);var e=this.getSetting("taxes",[]);for(var i=0;i<e.length;i++){var s=e[i];if(parseInt(s["ID"])==t){return s}}return null},getTaxNameByValue:function(t){var e=this.getSetting("taxes",[]);for(var i=0;i<e.length;i++){var s=e[i];if(parseFloat(s["VALUE"])==t){return e[i]["NAME"]}}return t+"%"},getTaxIdByValue:function(t){var e=this.getSetting("taxes",[]);for(var i=0;i<e.length;i++){var s=e[i];if(parseFloat(s["VALUE"])==t){return parseInt(e[i]["ID"])}}return 0},_processAjaxError:function(t){if(typeof t["ERROR"]=="undefined"){return false}var e=t["ERROR"];if(typeof BX.CrmProductEditorErrors[e]!="undefined"){e=BX.CrmProductEditorErrors[e]}else if(e=="OWNER_TYPE_NOT_FOUND"||e=="OWNER_ID_NOT_FOUND"||e=="SOURCE_DATA_NOT_FOUND"||e=="ID_NOT_FOUND"||e=="PRODUCT_ID_NOT_FOUND"||e=="PRODUCT_ROWS_SAVING_ERROR"){e=BX.CrmProductEditorErrors["INVALID_REQUEST_ERROR"]}this.showError(e);return true},showError:function(t){alert(t)},layoutElements:function(t){t=!!t;var e=this.getSetting("readOnly",false),i=this.getTable(),s=this._products.length;var n=this._topButtons;for(o=0;o<n.length;o++)n[o].style.display=e||t?"none":"";var r=BX(this.getSetting("addRowBtnID",""));if(r)r.style.display=e||t?"none":"";this.setModeBtnStyle();var a=[];a.push(i);a.push(BX("crm-top-sale-tab"));a.push(BX("crm-top-spacer"));a.push(BX("crm-top-tax-tab"));a.push(BX(this.getSetting("productTotalContainerID","")));for(var o=0;o<a.length;o++){if(a[o])a[o].style.display=s>0?"":"none"}},toggleMode:function(){var t=this._products;this.layoutElements(!this._viewMode);for(var e=0;e<t.length;e++)t[e].toggleMode();this._viewMode=!this._viewMode;this.setModeBtnStyle()},layout:function(){var t,e=this._products.length;this.layoutElements(this._viewMode);for(t=0;t<e;t++)this._products[t].layout();this._hasLayout=true;BX.CrmProductEditor.arrangeColumns(this,true)},hasLayout:function(){return this._hasLayout},cleanProductRows:function(){if(!this._hasLayout){return}var t,e,i=-1;var s=this._products.length;for(e=s-1;e>=0;e--){t=this._products[e];t.saveSettings();if(BX.util.trim(t.getProductName())===""){t.clean();this._products.splice(e,1);i=e}}if(this._products.length===0&&s>0){BX.onCustomEvent(this,"sumTotalChange",["0.00",{TOTAL_SUM_FORMATTED:"",TOTAL_SUM_FORMATTED_SHORT:"",TOTAL_SUM:"0.00"}])}if(i>=0)this._renumProducts(i)},resortProducts:function(){var t;for(t=0;t<this._products.length;t++)this._products[t].setSort((t+1)*10)},saveProductRows:function(){BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{MODE:"SAVE_PRODUCTS",OWNER_TYPE:this.getSetting("ownerType",""),OWNER_ID:this.getSetting("ownerID",0),PERMISSION_ENTITY_TYPE:this.getSetting("permissionEntityType",""),PRODUCT_ROW_DATA:this.productsToJson(),PRODUCT_ROW_SETTINGS:{ENABLE_DISCOUNT:this.isDiscountEnabled()?"Y":"N",ENABLE_TAX:this.isTaxEnabled()?"Y":"N"},SITE_ID:this.getSetting("siteId","")},onsuccess:BX.delegate(this._onSaveProductsRequestSuccess,this),onfailure:BX.delegate(this._onSaveProductsRequestFailure,this)})},getProductIndex:function(t){for(var e=0;e<this._products.length;e++){if(this._products[e]===t){return e}}return-1},getProductIndexByContainer:function(t){if(!BX.type.isDomNode(t)){return null}for(var e=0;e<this._products.length;e++){var i=this._products[e];if(i.getContainer()===t){return e}}return-1},switchTotalElements:function(){var t=this._discountExists,e=this._taxExists,i="crm-tax-value",s,n,r,a=this.isDiscountEnabled()||t?"":"none",o=e||!this.getSetting("hideAllTaxes",false)&&(this.isLDTaxAllowed()||this.isTaxAllowed()&&this.isTaxEnabled())?"":"none";var l=[{id:"TOTAL_BEFORE_DISCOUNT_ID",type:"discount"},{id:"TOTAL_DISCOUNT_ID",type:"discount"},{id:"TOTAL_BEFORE_TAX_ID",type:"tax"},{id:"taxValueID",type:"tax"}];for(s=0;s<l.length;s++){n=BX(this.getSetting(l[s]["id"],""));if(BX.type.isElementNode(n)){n=n.parentNode.parentNode;if(BX.type.isElementNode(n)){switch(l[s]["type"]){case"discount":n.style.display=a;break;case"tax":n.style.display=o;if(l[s]["id"]==="taxValueID"){r=n;while(r){r.style.display=o;r=BX.findNextSibling(r,{class:i})}}break}}}}},changeTaxIncludedUniform:function(t,e){var i,s=this._products;for(i=0;i<s.length;i++){if(s[i]!==t)s[i]._emulateTaxIncludedElementChange(e)}},getPathToProductShow:function(){return this.getSetting("pathToProductShow","")},setModeBtnStyle:function(){if(this._modeButton){var t=this.getSetting("readOnly",false),e=this.getSetting("hideModeButton",false),i=this._modeButton.parentNode,s=this._products.length,n=this._viewMode?s?"crmProductRowBtnEdit":"crmProductRowBtnAdd":"crmProductRowBtnEditF",r=BX.findChild(this._modeButton,{attr:{class:"webform-small-button-text"}});this._modeButton.style.display=t||e?"none":"";if(r)BX.setTextContent(r,BX.CrmProductEditorMessages[n]);if(this._viewMode&&s===0){i.style.cssFloat="left"}else{i.style.cssFloat="right"}}},processProductChange:function(t){BX.onCustomEvent(this,"productChange",[{product:t}])}};BX.CrmProductEditor.items={};BX.CrmProductEditor.get=function(t){return typeof this.items[t]!="undefined"?this.items[t]:null};BX.CrmProductEditor.getDefault=function(){return typeof this.items["__default"]!="undefined"?this.items["__default"]:null};BX.CrmProductEditor.create=function(t,e){var i=new BX.CrmProductEditor;i.initialize(t,e);this.items[t]=i;if(typeof this.items["__default"]=="undefined"){this.items["__default"]=i}return i};BX.CrmProductEditor.arrangeColumns=function(t,e){if(!t||typeof t._settings!=="object"||!t._settings["containerID"]||!t._settings["productContainerID"])return;var i=t.isTaxAllowed(),s=t.getSetting("hideTaxIncludedColumn",false),n=null,r=BX("crm-top-sale-checkbox"),a=r.parentNode.parentNode.offsetWidth,o=BX(t._settings["containerID"]),l=BX(t._settings["productContainerID"]),h=l.offsetWidth,d=l.rows[0],u=d.cells.length,c=BX("crm-l-space"),_=BX("crm-top-spacer").offsetWidth,T=h/100,g,f=0,C=0,p=[0,0,0,0,0,0,0,0],E=[29,10,10,10,10,10,18,3],I=[0,0,0,0,0,0,0,0],m=[29,16,16,16,0,0,19,3];if(i){n=BX("crm-top-tax-checkbox");if(s){p=[26,13,13,13,0,0,.5,10,0,10,11,3];E=[24,8,8,8,14,10,.5,0,0,0,24,3];I=[24,8,8,8,9,8,.5,10,0,10,11,3];m=[27,15,15,15,0,0,.5,0,0,0,24,3]}else{p=[26,13,13,13,0,0,.5,7,7,7,10,3];E=[24,8,8,8,15,15,.5,0,0,0,18,3];I=[24,8,8,8,10,7,.5,7,7,7,10,3];m=[29,16,16,16,0,0,.5,0,0,0,19,3]}}if(!e){var S=null;if(n&&this===n){if(n.checked!==t.getSetting("enableTax",false)){t.setSetting("enableTax",n.checked);if(!S)S={};S["SHOW_TAX"]=n.checked?"Y":"N"}}if(this===r){if(r.checked!==t.isDiscountEnabled()){t.setSetting("enableDiscount",r.checked);if(!S)S={};S["SHOW_DISCOUNT"]=r.checked?"Y":"N"}}var D=t.getSetting("ownerType","");var N=parseInt(t.getSetting("ownerID",0));if(S&&D.length>0&&N>0){BX.ajax({url:t._serviceUrl,method:"POST",dataType:"json",data:{MODE:"SET_OPTION",OWNER_TYPE:D,OWNER_ID:N,DATA:S,SITE_ID:t.getSetting("siteId","")}})}}for(var B=0;B<u;B++){d.cells[B].style.width=Math.round(d.cells[B].offsetWidth)+"px";setTimeout(function(){BX.addClass(o,"crm-items-list-anim")},50)}function R(t,e,i){var s=c.offsetWidth;c.style.width=s+"px";for(var n=0;n<u;n++){d.cells[n].style.width=Math.round(d.cells[n].offsetWidth)+"px";f+=Math.round(t[n]*T);if(n==3&&!e){C=f-Math.round(s);g=Math.round(t[n]*T)-C;if(g<0)g=0;d.cells[n].style.width=g+"px";f-=C}else if(n==5&&!e&&!i){C=f-Math.round(s+a+_);g=Math.round(t[n]*T)-C;if(g<0)g=0;d.cells[n].style.width=g+"px";f-=C}else if(n==6&&e&&i){if(f!=Math.round(s+a+_)){C=f-Math.round(s+a+_);g=Math.round(t[n]*T)-C;if(g<0)g=0;d.cells[n].style.width=g+"px";f-=C}else{d.cells[n].style.width=Math.round(t[n]*T)+"px"}}else if(n==6&&!e&&i){d.cells[n].style.width=Math.round(_)+"px";f-=Math.round(t[n]*T);f+=Math.round(_)}else if(n==7&&!i){g=Math.round(t[n]*T)-(f-h);if(g<0)g=0;d.cells[n].style.width=g+"px"}else if(n==11&&i){g=Math.round(t[n]*T)-(f-h);if(g<0)g=0;d.cells[n].style.width=g+"px"}else{d.cells[n].style.width=Math.round(t[n]*T)+"px"}}c.style.width=""}function U(t){for(var e=0;e<u;e++){d.cells[e].style.width=Math.round(t[e]*T)+"px"}}if(n&&this==n){if(o.getAttribute("data-tabs")==""){BX.addClass(o,"crm-items-list-tax");o.setAttribute("data-tabs","tax");setTimeout(function(){R(p,1,i)},70)}else if(o.getAttribute("data-tabs")=="sale"){BX.addClass(o,"crm-items-list-tax");o.setAttribute("data-tabs","all");setTimeout(function(){R(I,0,i)},70)}else if(o.getAttribute("data-tabs")=="tax"){BX.removeClass(o,"crm-items-list-tax");o.setAttribute("data-tabs","");setTimeout(function(){U(m)},70)}else if(o.getAttribute("data-tabs")=="all"){BX.removeClass(o,"crm-items-list-tax");o.setAttribute("data-tabs","sale");setTimeout(function(){R(E,0,i)},70)}}else if(this==r){if(o.getAttribute("data-tabs")==""){BX.addClass(o,"crm-items-list-sale");o.setAttribute("data-tabs","sale");setTimeout(function(){R(E,0,i)},70)}else if(o.getAttribute("data-tabs")=="tax"){BX.addClass(o,"crm-items-list-sale");o.setAttribute("data-tabs","all");setTimeout(function(){R(I,0,i)},70)}else if(o.getAttribute("data-tabs")=="sale"){BX.removeClass(o,"crm-items-list-sale");o.setAttribute("data-tabs","");setTimeout(function(){U(m)},70)}else if(o.getAttribute("data-tabs")=="all"){BX.removeClass(o,"crm-items-list-sale");o.setAttribute("data-tabs","tax");setTimeout(function(){R(p,1,i)},70)}}else{if(o.getAttribute("data-tabs")=="")setTimeout(function(){U(m)},70);else if(o.getAttribute("data-tabs")=="tax")setTimeout(function(){R(p,1,i)},70);else if(o.getAttribute("data-tabs")=="sale")setTimeout(function(){R(E,0,i)},70);else if(o.getAttribute("data-tabs")=="all")setTimeout(function(){R(I,0,i)},70)}t.switchTotalElements()};if(typeof BX.CrmProductEditorMessages==="undefined"){BX.CrmProductEditorMessages={editButtonTitle:"Edit",deleteButtonTitle:"Delete",deletionConfirm:"Are you sure you want to delete this product?"}}}if(typeof BX.CrmProduct==="undefined"){BX.CrmProduct=function(){this._viewMode=true;this._settings={};this._container=this._editor=null;this._fields={};this._fieldValue={};this._elements={};this._isEventsBinds=false;this._discountTypeView=0;this._fixProductName=false;this._focusedField=null;this._productSearch=null;this._dragButton=null;this._sumValueAfterBlur=null;this._hasLayout=false;this._keyDownHandler=BX.delegate(this._handleKeyDown,this)};BX.CrmProduct.prototype={initialize:function(t,e,i){this._editor=i;this.setSettings(t);if(typeof this._settings["FIXED_PRODUCT_NAME"]==="string"&&this._settings["FIXED_PRODUCT_NAME"].length>0)this._fixProductName=true;this._container=e;this._viewMode=i._viewMode;this._discountTypeView=BX.CrmDiscountType.percentage;var s=BX.findChild(e,{tag:"span",class:"crm-item-del"},true,false);if(s){BX.bind(s,"click",BX.delegate(this._handleDeleteClick,this));s.setAttribute("title",BX.CrmProductEditorMessages["deleteButtonTitle"])}this._dragButton=BX.findChild(e,{tag:"span",class:"crm-item-move-btn"},true,false);var n=e.id;var r,a,o,l,h,d=[];var u=[];if(n){var c=this.getSetting("fields",[]);for(var _=0;_<c.length;_++){if(c[_]){a=n+"_"+c[_];o="crm-item-cell-text";l=false;if(c[_]==="PRODUCT_NAME"&&this._fixProductName){a+="_v";o="crm-item-cell-view";l=true}r=BX(a);if(r){h=r.parentNode;if(h){if(BX.hasClass(h,o)){d.push(h)}else{h=h.parentNode;if(h&&BX.hasClass(h,o))d.push(h)}if(h&&this._viewMode&&!l)h.style.display="none"}}o="crm-item-cell-view";l=c[_]==="PRODUCT_NAME"&&this._fixProductName;r=BX(n+"_"+c[_]+"_v");if(r){h=r.parentNode;if(h){if(BX.hasClass(h,o)){u.push(h)}else{h=h.parentNode;if(h&&BX.hasClass(h,o))u.push(h)}if(h&&!this._viewMode&&!l)h.style.display="none"}}}}}this._viewBlocks=u;this._editBlocks=d;var T=BX.findChild(this._container,{attr:{class:"crm-item-del"}},true);if(T)T.style.display=this._viewMode?"none":"";if(!this._productSearch){var g=BX(this._container.id+"_PRODUCT_NAME");var f=g.parentNode;f.id=g.id+"_c";this._productSearch=BX.CrmProductSearch.create({AJAX_PAGE:this._editor.getSetting("productSearchUrl",""),CONTAINER_ID:f.id,INPUT_ID:this._container.id+"_PRODUCT_NAME",MIN_QUERY_LEN:3},this)}},initializeDragDropAbilities:function(){if(this._dragItem){return}if(!this._dragButton){throw"CrmProduct: Could not find drag button."}this._dragItem=BX.CrmProdoctRowListDragItem.create(this.getId(),{product:this,node:this._dragButton,container:this._editor.getTable(),showInDragMode:false,ghostOffset:{x:-12,y:-12}})},releaseDragDropAbilities:function(){if(this._dragItem){this._dragItem.release();this._dragItem=null}},getRowNumber:function(){return this._container.rowIndex},setNumber:function(t){var e=[];e[0]=BX(this._container.id+"_NUM");e[1]=BX(this._container.id+"_NUM_v");for(var i=0;i<e.length;i++){if(e[i])BX.setTextContent(e[i],parseInt(t).toString()+".")}this._container.className=t%2===0?"crm-items-table-even-row":"crm-items-table-odd-row"},getMeasureNameByCode:function(t){var e=this._editor.getSetting("measures",[]),i="-",s,n;if(e){for(n=0;n<e.length;n++){if(e[n]&&typeof e[n]==="object"){s=e[n];if(s.hasOwnProperty("CODE")&&parseInt(s["CODE"])===parseInt(t)){if(s.hasOwnProperty("SYMBOL")&&s["SYMBOL"].length>0){i=s["SYMBOL"];break}}}}}return i},getMeasureIdByCode:function(t){var e=this._editor.getSetting("measures",[]),i=0,s,n;if(e){for(n=0;n<e.length;n++){if(e[n]&&typeof e[n]==="object"){s=e[n];if(s.hasOwnProperty("CODE")&&parseInt(s["CODE"])===parseInt(t)){if(s.hasOwnProperty("ID")&&s["ID"].length>0){i=s["ID"];break}}}}}return i},setFieldView:function(t,e){var i,s=false;var n=this._editor.isTaxAllowed();var r=this.isTaxIncluded();if(t==="PRICE_NETTO"||t==="PRICE_BRUTTO")s=true;e=t==="TAX_INCLUDED"?!!e:e.toString();switch(t){case"PRICE_NETTO":case"PRICE_BRUTTO":i="PRICE";break;case"MEASURE_CODE":i="MEASURE";break;case"DISCOUNT_RATE":case"DISCOUNT_SUM":case"DISCOUNT_TYPE_ID":i="DISCOUNT";break;default:i=t}var a=0,o=this._discountTypeView;switch(i){case"PRICE":case"DISCOUNT_SUM":case"DISCOUNT_SUBTOTAL":case"SUM":a=2;break;case"DISCOUNT":if(o===BX.CrmDiscountType.monetary)a=2;break}if(a>0)e=this._parseFloat(e,a,0).toFixed(a);var l=this._container,h=BX(l.id+"_"+i+"_v"),d;var u,c;switch(t){case"PRODUCT_NAME":case"QUANTITY":case"SUM":if(h)BX.setTextContent(h,e);break;case"PRICE_NETTO":if(n&&!r){if(h)BX.setTextContent(h,e)}break;case"PRICE_BRUTTO":if(!n||r){if(h)BX.setTextContent(h,e)}break;case"MEASURE_CODE":var _=this.getMeasureNameByCode(e);if(h)BX.setTextContent(h,_);break;case"DISCOUNT_TYPE_ID":break;case"DISCOUNT_RATE":if(o===BX.CrmDiscountType.percentage){if(h)BX.setTextContent(h,e)}break;case"DISCOUNT_SUM":if(o===BX.CrmDiscountType.monetary){if(h)BX.setTextContent(h,e)}break;case"DISCOUNT_SUBTOTAL":if(h)BX.setTextContent(h,e);break;case"TAX_RATE":if(h)BX.setTextContent(h,e+"%");break;case"TAX_INCLUDED":if(h)BX.setTextContent(h,e?BX.CrmProductEditorMessages["yes"]:BX.CrmProductEditorMessages["no"]);break;case"TAX_SUM":if(h)BX.setTextContent(h,this._parseFloat(e,2,0).toFixed(2));break}},setFieldValue:function(t,e,i){var s,n=false;var r=this._editor.isTaxAllowed();var a=this.isTaxIncluded();if(t==="PRICE_NETTO"||t==="PRICE_BRUTTO")n=true;e=t==="TAX_INCLUDED"?!!e:e.toString();if(this._fieldValue.hasOwnProperty(t)&&this._fieldValue[t]===e&&!n)return;this._fieldValue[t]=e;switch(t){case"PRICE_NETTO":case"PRICE_BRUTTO":s="PRICE";break;case"MEASURE_CODE":s="MEASURE";break;case"DISCOUNT_RATE":case"DISCOUNT_SUM":s="DISCOUNT";break;default:s=t}var o=this._container,l=BX(o.id+"_"+s),h=BX(o.id+"_"+s+"_v"),d;var u,c,_,T,g=this._discountTypeView;switch(t){case"PRODUCT_NAME":case"QUANTITY":case"DISCOUNT_SUBTOTAL":case"SUM":if(l)l.value=e;if(h)BX.setTextContent(h,e);break;case"PRICE_NETTO":if(r&&!a){if(l)l.value=e;if(h)BX.setTextContent(h,e)}break;case"PRICE_BRUTTO":if(!r||a){if(l)l.value=e;if(h)BX.setTextContent(h,e)}break;case"MEASURE_CODE":if(l)BX.setSelectValue(l,e);var f=this.getMeasureNameByCode(e);this._fieldValue["MEASURE_NAME"]=f;if(h)BX.setTextContent(h,f);break;case"DISCOUNT_TYPE_ID":u=parseInt(e);if(u!==BX.CrmDiscountType.percentage&&u!==BX.CrmDiscountType.monetary)u=BX.CrmDiscountType.percentage;if(parseInt(g)!==u){var C=this._editor.getSetting("discountTypeText",[]);g=u;this._discountTypeView=g;var p=C[g]?C[g]:"?";var E=g===BX.CrmDiscountType.percentage?"DISCOUNT_RATE":"DISCOUNT_SUM";l=BX(o.id+"_DISCOUNT");var I=[];var m=this._parseFloat(this._fieldValue[E],2,0).toFixed(2);if(l){I[0]=BX.findChild(l.parentNode,{attr:{class:"crm-item-sale-text"}},true);l.value=g===BX.CrmDiscountType.percentage?this._fieldValue[E]:m}h=BX(o.id+"_DISCOUNT_v");if(h){I[1]=BX.findChild(h.parentNode,{attr:{class:"crm-item-sale-text"}},true);BX.setTextContent(h,g===BX.CrmDiscountType.percentage?this._fieldValue[E]:m)}{for(d=0;d<I.length;d++){if(I[d]){I[d].innerHTML=p}}}}break;case"DISCOUNT_RATE":if(g===BX.CrmDiscountType.percentage){if(l)l.value=e;if(h)BX.setTextContent(h,e)}break;case"DISCOUNT_SUM":if(g===BX.CrmDiscountType.monetary){if(l)l.value=e;if(h)BX.setTextContent(h,e)}break;case"TAX_RATE":if(l){var S=false;for(d=0;d<l.options.length;d++){if(l.options[d].value===e){l.selectedIndex=d;S=true;break}}if(!S){var D=document.createElement("option");D.value=e;D.innerHTML=BX.util.htmlspecialchars(e+"%");l.appendChild(D);l.selectedIndex=d}}if(h)BX.setTextContent(h,e+"%");break;case"TAX_INCLUDED":if(l)l.checked=e;if(h)BX.setTextContent(h,e?BX.CrmProductEditorMessages["yes"]:BX.CrmProductEditorMessages["no"]);break;case"TAX_SUM":if(l)BX.setTextContent(l,this._parseFloat(e,2,0).toFixed(2));if(h)BX.setTextContent(h,this._parseFloat(e,2,0).toFixed(2));break}i=typeof i==="undefined"?false:!!i;if(i)this.processFieldValueChange(t)},layout:function(){var t=this._container;var e=this._editor.getSetting("readOnly",false);var i=this.getSetting("PRODUCT_ID",0);var s=this.getSetting("PRODUCT_NAME","");var n=this.getSetting("PRICE",0);var r=this.getSetting("QUANTITY",0);var a=this._editor.isTaxAllowed();var o=this._editor.isTaxEnabled();var l,h,d,u,c,_;this.setFieldValue("PRODUCT_NAME",s);var T=this.getSetting("PRICE_NETTO",0);this.setFieldValue("PRICE_NETTO",T.toFixed(2));var g=this.getSetting("PRICE_BRUTTO",0);this.setFieldValue("PRICE_BRUTTO",g.toFixed(2));var f=this.getSetting("QUANTITY",0);this.setFieldValue("QUANTITY",f);var C="";var p=this._editor.getSetting("defaultMeasure",null);if(p){if(p.hasOwnProperty("CODE"))C=p["CODE"]}this.setFieldValue("MEASURE_CODE",this.getSetting("MEASURE_CODE",C));var E=this.getDiscountTypeId();this.setFieldValue("DISCOUNT_TYPE_ID",E);var I=this.getSetting("DISCOUNT_RATE",0);this.setFieldValue("DISCOUNT_RATE",I);var m=this.getSetting("DISCOUNT_SUM",0);this.setFieldValue("DISCOUNT_SUM",m.toFixed(2));var S=f*m;this.setFieldValue("DISCOUNT_SUBTOTAL",S.toFixed(2));var D="0";var N="0%";if(a){var B=this._editor.getSetting("defaultTax",null);if(B){if(B.hasOwnProperty("VALUE")){D=B["VALUE"];N=B["VALUE"]+"%"}}}this.setFieldValue("TAX_RATE",this.getSetting("TAX_RATE",D));this.setFieldValue("TAX_INCLUDED",this.isTaxIncluded());this.setFieldValue("TAX_SUM",this._round(this.getSetting("TAX_SUM",0),2));this.setFieldValue("SUM",this._calculateSumTotal());this._handleProductNameChange(s);if(this._container&&BX.type.isDomNode(this._container)){BX.bind(this._container,"keydown",this._keyDownHandler)}this._bindEventsHandlers();this.initializeDragDropAbilities();this._hasLayout=true},clean:function(){if(this._container){this._container.parentNode.removeChild(this._container);this.releaseDragDropAbilities();if(BX.type.isDomNode(this._container)){BX.unbind(this._container,"keydown",this._keyDownHandler)}}this._hasLayout=false},hasLayout:function(){return this._hasLayout},isReadOnly:function(){return this.getSetting("readOnly",false)},getContainer:function(){return this._container},toggleMode:function(){var t,e;var i=this._viewMode?this._viewBlocks:this._editBlocks;var s=this._viewMode?this._editBlocks:this._viewBlocks;for(t=0;t<i.length;t++)i[t].style.display="none";for(t=0;t<s.length;t++)s[t].style.display="";e=BX.findChild(this._container,{attr:{class:"crm-item-del"}},true);if(e)e.style.display=this._viewMode?"":"none";if(!this._viewMode){this.saveSettings()}this._viewMode=!this._viewMode},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},saveSettings:function(){if(!this._hasLayout||this._viewMode){return}this._settings["PRODUCT_NAME"]=BX.util.trim(BX.prop.getString(this._fieldValue,"PRODUCT_NAME"));this._settings["QUANTITY"]=this._parseFloat(this._fieldValue["QUANTITY"],4,0);this._settings["DISCOUNT_TYPE_ID"]=this._parseInt(this._fieldValue["DISCOUNT_TYPE_ID"],this.getDiscountTypeId());this._settings["DISCOUNT_RATE"]=this._parseFloat(this._fieldValue["DISCOUNT_RATE"],2,0);this._settings["DISCOUNT_SUM"]=this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this._settings["TAX_INCLUDED"]=this._fieldValue["TAX_INCLUDED"];this._settings["TAX_RATE"]=this._parseFloat(this._fieldValue["TAX_RATE"],2,0);this._settings["TAX_SUM"]=this._parseFloat(this._fieldValue["TAX_SUM"],2,0);this._settings["MEASURE_CODE"]=parseInt(this._fieldValue["MEASURE_CODE"]);this._settings["MEASURE_NAME"]=BX.prop.getString(this._fieldValue,"MEASURE_NAME")},getSettings:function(){return this._settings},setSettings:function(t){this._settings=t?t:{};this._settings["PRODUCT_ID"]=parseInt(this.getSetting("PRODUCT_ID",0));this._settings["PRODUCT_NAME"]=this.getSetting("PRODUCT_NAME","");this._settings["QUANTITY"]=this._round(parseFloat(this.getSetting("QUANTITY",0)),4);this._settings["MEASURE_CODE"]=parseInt(this.getSetting("MEASURE_CODE",0));this._settings["MEASURE_NAME"]=this.getSetting("MEASURE_NAME","");this._settings["DISCOUNT_TYPE_ID"]=parseInt(this.getDiscountTypeId());if(this._editor.isInvoiceMode())this._settings["DISCOUNT_TYPE_ID"]=BX.CrmDiscountType.monetary;this._settings["DISCOUNT_RATE"]=this._round(parseFloat(this.getSetting("DISCOUNT_RATE",0)),2);this._settings["DISCOUNT_SUM"]=this._round(parseFloat(this.getSetting("DISCOUNT_SUM",0)),2);this._settings["DISCOUNT_SUBTOTAL"]=this._round(this._settings["QUANTITY"]*this._settings["DISCOUNT_SUM"],2);this._settings["TAX_RATE"]=this._round(parseFloat(this.getSetting("TAX_RATE",0)),2);this._settings["TAX_INCLUDED"]=this.isTaxIncluded();this._settings["PRICE"]=this._round(parseFloat(this.getSetting("PRICE",0)),2);this._settings["PRICE_EXCLUSIVE"]=this._round(parseFloat(this.getSetting("PRICE_EXCLUSIVE",0)),2);if(typeof this._settings["PRICE_NETTO"]!=="undefined"){this._settings["PRICE_NETTO"]=this._round(parseFloat(this.getSetting("PRICE_NETTO",0)),2)}else{var e=this._settings["PRICE_EXCLUSIVE"];if(this._settings["DISCOUNT_TYPE_ID"]===BX.CrmDiscountType.monetary){this._settings["PRICE_NETTO"]=e+this._settings["DISCOUNT_SUM"]}else{var i=this._settings["DISCOUNT_RATE"];var s=i<100?this._round(this._calculateDiscountByDiscountPrice(e,i),2):this._settings["DISCOUNT_SUM"];this._settings["PRICE_NETTO"]=e+s}}if(typeof this._settings["PRICE_BRUTTO"]!=="undefined"){this._settings["PRICE_BRUTTO"]=this._round(parseFloat(this.getSetting("PRICE_BRUTTO",0)),2)}else{if(this._settings["DISCOUNT_SUM"]==0){this._settings["PRICE_BRUTTO"]=this._settings["PRICE"]}else{this._settings["PRICE_BRUTTO"]=this._round(BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_NETTO"],this._settings["TAX_RATE"]),2)}}this._settings["TAX_SUM"]=this.getTaxSum();this._settings["CUSTOMIZED"]=!!this.getSetting("CUSTOMIZED",false);this._settings["SORT"]=parseInt(this.getSetting("SORT",0))},getId:function(){return parseInt(this.getSetting("ID",0))},setId:function(t){this._settings["ID"]=parseInt(t)},setProductId:function(t){return this.setSetting("PRODUCT_ID",parseInt(t))},getProductId:function(){return this.getSetting("PRODUCT_ID",0)},getProductName:function(){return this.getSetting("PRODUCT_NAME","")},getQuantity:function(){return this.getSetting("QUANTITY",0)},getMeasureCode:function(){return this.getSetting("MEASURE_CODE",0)},getMeasureName:function(){return this.getSetting("MEASURE_NAME","")},getPrice:function(){return this.getSetting("PRICE",0)},getExclusivePrice:function(){return this.getSetting("PRICE_EXCLUSIVE",0)},getPriceNetto:function(){return this.getSetting("PRICE_NETTO",0)},getPriceBrutto:function(){return this.getSetting("PRICE_BRUTTO",0)},getDiscountTypeId:function(){var t=parseInt(this.getSetting("DISCOUNT_TYPE_ID",BX.CrmDiscountType.percentage));if(t!==BX.CrmDiscountType.percentage&&t!==BX.CrmDiscountType.monetary){t=BX.CrmDiscountType.percentage}return t},getDiscountRate:function(){return this.getSetting("DISCOUNT_RATE",0)},getDiscountSum:function(){return this.getSetting("DISCOUNT_SUM",0)},getDiscountSubtotal:function(){return this.getSetting("DISCOUNT_SUBTOTAL",0)},getTaxRate:function(){return this.getSetting("TAX_RATE",0)},isTaxIncluded:function(){return this.getSetting("TAX_INCLUDED",false)},isCustomized:function(){return this.getSetting("CUSTOMIZED",false)},getSort:function(){return this.getSetting("SORT",0)},setSort:function(t){return this.setSetting("SORT",t)},isViewMode:function(){return this._viewMode},toJson:function(){var t="";var e={};if(this._hasLayout&&!this._viewMode){this.saveSettings()}e["ID"]=this.getId();e["PRODUCT_NAME"]=this.getSetting(this._fixProductName?"FIXED_PRODUCT_NAME":"PRODUCT_NAME","");e["PRODUCT_ID"]=this.getSetting("PRODUCT_ID",0);e["QUANTITY"]=this.getSetting("QUANTITY",0).toFixed(4);e["MEASURE_CODE"]=this.getSetting("MEASURE_CODE",0);e["MEASURE_NAME"]=this.getSetting("MEASURE_NAME","");e["PRICE"]=this.getSetting("PRICE",0).toFixed(2);e["PRICE_EXCLUSIVE"]=this.getSetting("PRICE_EXCLUSIVE",0).toFixed(2);e["PRICE_NETTO"]=this.getSetting("PRICE_NETTO",0).toFixed(2);e["PRICE_BRUTTO"]=this.getSetting("PRICE_BRUTTO",0).toFixed(2);e["DISCOUNT_TYPE_ID"]=this.getDiscountTypeId();var i=this.getSetting("DISCOUNT_RATE",null);if(i!==null){e["DISCOUNT_RATE"]=i.toFixed(2)}var s=this.getSetting("DISCOUNT_SUM",null);if(s!==null){e["DISCOUNT_SUM"]=s.toFixed(2)}e["TAX_RATE"]=this.getSetting("TAX_RATE",0).toFixed(2);e["TAX_INCLUDED"]=this.getSetting("TAX_INCLUDED",false)?"Y":"N";e["CUSTOMIZED"]="Y";e["SORT"]=parseInt(this.getSetting("SORT",0));return JSON.stringify(e)},processFieldValueChange:function(t){var e,i,s,n,r,a,o;var l=this.getDiscountTypeId();if(t!=="DISCOUNT_SUM"&&t!=="DISCOUNT_RATE"&&t!=="DISCOUNT_SUBTOTAL"&&t!=="DISCOUNT_TYPE_ID"&&t!=="TAX_RATE"&&t!=="TAX_INCLUDED"&&t!=="PRICE_BRUTTO"&&t!=="PRICE_NETTO"&&t!=="QUANTITY"&&t!=="MEASURE_CODE"&&t!=="SUM"){return}if(t==="DISCOUNT_TYPE_ID"){this._settings["DISCOUNT_TYPE_ID"]=parseInt(this._fieldValue["DISCOUNT_TYPE_ID"]);if(parseInt(this._fieldValue[t])===BX.CrmDiscountType.monetary){n=this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"];this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this._settings["DISCOUNT_RATE"]=this._round(this._calculateDiscountRate(this._settings["PRICE_NETTO"],this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"]),2);this.setFieldValue("DISCOUNT_RATE",this._settings["DISCOUNT_RATE"]);this._settings["DISCOUNT_SUM"]=this._round(this._calculateDiscount(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"]),2);this.setFieldValue("DISCOUNT_SUM",this._settings["DISCOUNT_SUM"].toFixed(2));this._settings["DISCOUNT_SUBTOTAL"]=this._round(this._settings["QUANTITY"]*this._settings["DISCOUNT_SUM"],2);this.setFieldValue("DISCOUNT_SUBTOTAL",this._settings["DISCOUNT_SUBTOTAL"].toFixed(2));this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}else{n=this._round(this._calculatePrice(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"],BX.CrmDiscountType.percentage),2);this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this._settings["DISCOUNT_SUM"]=this._round(this._calculateDiscount(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"]),2);this.setFieldValue("DISCOUNT_SUM",this._settings["DISCOUNT_SUM"].toFixed(2));s=this._round(this._settings["QUANTITY"]*this._settings["DISCOUNT_SUM"],2);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2));this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}}if(t==="QUANTITY"){this._settings["QUANTITY"]=this._parseFloat(this._fieldValue[t],4,0);s=this._round(this._settings["QUANTITY"]*this._settings["DISCOUNT_SUM"],2);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2));this.setFieldValue("TAX_SUM",this.getTaxSum())}else if(t==="MEASURE_CODE"){this._settings["MEASURE_CODE"]=parseInt(this._fieldValue[t]);this._settings["MEASURE_NAME"]=this._fieldValue["MEASURE_NAME"]=this.getMeasureNameByCode(this._settings["MEASURE_CODE"])}else if(t==="PRICE_BRUTTO"||t==="PRICE_NETTO"){if(t==="PRICE_BRUTTO"){this._settings["PRICE_BRUTTO"]=this._parseFloat(this._fieldValue[t],2,0);this._settings["PRICE_NETTO"]=this._round(BX.CrmProduct.calculateExclusivePrice(this._settings["PRICE_BRUTTO"],this._settings["TAX_RATE"]),2);this.setFieldValue("PRICE_NETTO",this._settings["PRICE_NETTO"])}else{this._settings["PRICE_NETTO"]=this._parseFloat(this._fieldValue[t],2,0);this._settings["PRICE_BRUTTO"]=this._round(BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_NETTO"],this._settings["TAX_RATE"]),2);this.setFieldValue("PRICE_BRUTTO",this._settings["PRICE_BRUTTO"])}if(this._settings["DISCOUNT_TYPE_ID"]===BX.CrmDiscountType.percentage){if(this._settings["DISCOUNT_RATE"]==0){this._settings["PRICE_EXCLUSIVE"]=this._settings["PRICE_NETTO"];this._settings["PRICE"]=this._settings["PRICE_BRUTTO"];i=0}else{n=this._round(this._calculatePrice(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"],BX.CrmDiscountType.percentage),2);this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);i=this._settings["PRICE_NETTO"]-n}this.setFieldValue("DISCOUNT_SUM",i.toFixed(2));s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2))}else if(this._settings["DISCOUNT_TYPE_ID"]===BX.CrmDiscountType.monetary){if(this._settings["DISCOUNT_SUM"]==0){this._settings["PRICE_EXCLUSIVE"]=this._settings["PRICE_NETTO"];this._settings["PRICE"]=this._settings["PRICE_BRUTTO"];this.setFieldValue("DISCOUNT_RATE",0)}else{i=this._settings["DISCOUNT_SUM"];n=this._settings["PRICE_NETTO"]-i;this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this.setFieldValue("DISCOUNT_RATE",this._calculateDiscountRate(this._settings["PRICE_NETTO"],n))}}this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}else if(t==="DISCOUNT_RATE"){this._settings["DISCOUNT_TYPE_ID"]=BX.CrmDiscountType.percentage;this.setFieldValue("DISCOUNT_TYPE_ID",this._settings["DISCOUNT_TYPE_ID"]);this._settings["DISCOUNT_RATE"]=this._parseFloat(this._fieldValue[t],2,0);n=this._calculatePrice(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"],BX.CrmDiscountType.percentage);this._settings["PRICE_EXCLUSIVE"]=this._round(n,2);this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this.setFieldValue("DISCOUNT_SUM",this._calculateDiscount(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"]).toFixed(2));s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2));this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}else if(t==="DISCOUNT_SUM"){this._settings["DISCOUNT_TYPE_ID"]=BX.CrmDiscountType.monetary;this.setFieldValue("DISCOUNT_TYPE_ID",this._settings["DISCOUNT_TYPE_ID"]);this._settings["DISCOUNT_SUM"]=this._parseFloat(this._fieldValue[t],2,0);n=this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"];this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this._settings["DISCOUNT_RATE"]=this._round(this._calculateDiscountRate(this._settings["PRICE_NETTO"],this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"]),2);this.setFieldValue("DISCOUNT_RATE",this._settings["DISCOUNT_RATE"]);s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2));this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}else if(t==="TAX_RATE"){if(this._editor.isTaxAllowed()){r=this._settings["TAX_INCLUDED"];this._settings["TAX_RATE"]=this._parseFloat(this._fieldValue[t],2,0);if(r){a=BX.CrmProduct.calculateExclusivePrice(this._settings["PRICE_BRUTTO"],this._settings["TAX_RATE"]);this._settings["PRICE_NETTO"]=this._round(a,2)}else{a=this._settings["PRICE_NETTO"];o=BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_NETTO"],this._settings["TAX_RATE"]);this._settings["PRICE_BRUTTO"]=this._round(o,2)}e=l===BX.CrmDiscountType.percentage?this._settings["DISCOUNT_RATE"]:this._settings["DISCOUNT_SUM"];n=this._calculatePrice(a,e,l);this._settings["PRICE_EXCLUSIVE"]=this._round(n,2);this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);if(r){if(l===BX.CrmDiscountType.percentage){this.setFieldValue("PRICE_NETTO",this._settings["PRICE_NETTO"].toFixed(2));this.setFieldValue("DISCOUNT_SUM",this._calculateDiscount(this._settings["PRICE_NETTO"],this._settings["DISCOUNT_RATE"]).toFixed(2));s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2))}else{this._settings["DISCOUNT_RATE"]=this._round(this._calculateDiscountRate(this._settings["PRICE_NETTO"],this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"]),2);this.setFieldValue("DISCOUNT_RATE",this._settings["DISCOUNT_RATE"]);s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2))}}else{this.setFieldValue("PRICE_BRUTTO",this._settings["PRICE_BRUTTO"].toFixed(2))}this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}}else if(t==="TAX_INCLUDED"){if(this._editor.isTaxAllowed()){r=this._settings["TAX_INCLUDED"]=!!this._fieldValue[t];if(!r){this._settings["PRICE_NETTO"]=this._settings["PRICE_BRUTTO"];this._settings["PRICE_BRUTTO"]=this._round(BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_NETTO"],this._settings["TAX_RATE"]),2);this.setFieldValue("PRICE_NETTO",this._settings["PRICE_NETTO"].toFixed(2),true)}else{this._settings["PRICE_BRUTTO"]=this._settings["PRICE_NETTO"];this._settings["PRICE_NETTO"]=this._round(BX.CrmProduct.calculateExclusivePrice(this._settings["PRICE_BRUTTO"],this._settings["TAX_RATE"]),2);this.setFieldValue("PRICE_BRUTTO",this._settings["PRICE_BRUTTO"].toFixed(2),true)}}}else if(t==="DISCOUNT_SUBTOTAL"){this._settings["DISCOUNT_SUBTOTAL"]=this._parseFloat(this._fieldValue[t],2,0);if(this._round(parseFloat(this._settings["QUANTITY"]),4)===0){this._settings["QUANTITY"]=1;this.setFieldValue("QUANTITY",1)}this._settings["DISCOUNT_TYPE_ID"]=BX.CrmDiscountType.monetary;this.setFieldValue("DISCOUNT_TYPE_ID",this._settings["DISCOUNT_TYPE_ID"]);this._settings["DISCOUNT_SUM"]=this._round(this._settings["DISCOUNT_SUBTOTAL"]/this._settings["QUANTITY"],2);this.setFieldValue("DISCOUNT_SUM",this._settings["DISCOUNT_SUM"].toFixed(2));n=this._settings["PRICE_NETTO"]-this._settings["DISCOUNT_SUM"];this._settings["PRICE_EXCLUSIVE"]=n;this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(n,this._settings["TAX_RATE"]),2);this._settings["DISCOUNT_RATE"]=this._round(this._calculateDiscountRate(this._settings["PRICE_NETTO"],n),2);this.setFieldValue("DISCOUNT_RATE",this._settings["DISCOUNT_RATE"]);this._settings["DISCOUNT_SUBTOTAL"]=this._round(this._settings["QUANTITY"]*this._settings["DISCOUNT_SUM"],2);this._fieldValue["DISCOUNT_SUBTOTAL"]=this._settings["DISCOUNT_SUBTOTAL"].toFixed(2);this.setFieldView("DISCOUNT_SUBTOTAL",this._fieldValue["DISCOUNT_SUBTOTAL"]);this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}else if(t==="SUM"){this._settings["SUM"]=this._parseFloat(this._fieldValue[t],2,0);if(this._round(parseFloat(this._settings["QUANTITY"]),4)===0){this._settings["QUANTITY"]=1;this.setFieldValue("QUANTITY",1)}i=this._settings["PRICE_NETTO"]-this._settings["SUM"]/(this._settings["QUANTITY"]*(1+this._settings["TAX_RATE"]/100));i=this._round(i,2);this._settings["PRICE_EXCLUSIVE"]=this._round(this._settings["PRICE_NETTO"]-i,2);this._settings["PRICE"]=this._round(BX.CrmProduct.calculateInclusivePrice(this._settings["PRICE_EXCLUSIVE"],this._settings["TAX_RATE"]),2);this._settings["DISCOUNT_TYPE_ID"]=BX.CrmDiscountType.monetary;this.setFieldValue("DISCOUNT_TYPE_ID",this._settings["DISCOUNT_TYPE_ID"]);this._settings["DISCOUNT_SUM"]=this._round(i,2);this.setFieldValue("DISCOUNT_SUM",this._settings["DISCOUNT_SUM"]);this._settings["DISCOUNT_RATE"]=this._round(this._calculateDiscountRate(this._settings["PRICE_NETTO"],this._settings["PRICE_EXCLUSIVE"]),2);this.setFieldValue("DISCOUNT_RATE",this._settings["DISCOUNT_RATE"]);this.setFieldValue("PRICE_NETTO",this._settings["PRICE_NETTO"].toFixed(2));this.setFieldValue("PRICE_BRUTTO",this._settings["PRICE_BRUTTO"].toFixed(2));s=this._parseFloat(this._fieldValue["QUANTITY"],4,0)*this._parseFloat(this._fieldValue["DISCOUNT_SUM"],2,0);this.setFieldValue("DISCOUNT_SUBTOTAL",s.toFixed(2));this._sumValueAfterBlur=this._calculateSumTotal();this.setFieldValue("TAX_SUM",this.getTaxSum());this._settings["CUSTOMIZED"]=true}if(t!=="SUM"){if(this._settings["TAX_INCLUDED"]){this.setFieldValue("SUM",(this._settings["PRICE"]*this._settings["QUANTITY"]).toFixed(2))}else{this.setFieldValue("SUM",this._calculateSumTotal())}}this._editor.calculateTotalsDelayed()},_bindEventsHandlers:function(){var t=this,e=this._container,i=this.getSetting("fields",[]),s,n,r,a,o,l="crm-item-inp-btn";if(this._isEventsBinds)return;for(r=0;r<i.length;r++){s=i[r];n=BX(e.id+"_"+s);if(n){switch(s){case"PRODUCT_NAME":case"QUANTITY":if(s==="PRODUCT_NAME"){o=BX.findNextSibling(n,{class:l});if(o){BX.bind(o,"click",function(e){t._onProductNameButtonClick.apply(t,[this,e])})}}if(s!=="PRODUCT_NAME"||!this._fixProductName){BX.bind(n,"keyup",function(e){t._onElementKeyUp.apply(t,[this,e])});BX.bind(n,"input",function(e){t._onElementChange.apply(t,[this,e])});BX.bind(n,"focus",function(e){t._onElementFocus.apply(t,[this,e])});BX.bind(n,"blur",function(e){t._onElementBlur.apply(t,[this,e])})}break;case"DISCOUNT":var h=[];if(n)h[0]=BX.findChild(n.parentNode,{attr:{class:"crm-item-sale-text"}},true);var d=BX(e.id+"_"+s+"_v");if(d)h[1]=BX.findChild(d.parentNode,{attr:{class:"crm-item-sale-text"}},true);for(a=0;a<h.length;a++){if(h[a])BX.bind(h[a],"click",function(e){t._handleChangeDiscountTypeView.apply(t,[this,e])})}BX.bind(n,"keyup",function(e){t._onElementKeyUp.apply(t,[this,e])});BX.bind(n,"input",function(e){t._onElementChange.apply(t,[this,e])});BX.bind(n,"focus",function(e){t._onElementFocus.apply(t,[this,e])});BX.bind(n,"blur",function(e){t._onElementBlur.apply(t,[this,e])});break;case"MEASURE":case"TAX_RATE":BX.bind(n,"change",function(e){t._onElementChange.apply(t,[this,e])});break;case"TAX_INCLUDED":BX.bind(n,"click",function(e){t._onElementChange.apply(t,[this,e])});break;case"PRICE":case"DISCOUNT_SUBTOTAL":case"SUM":BX.bind(n,"keyup",function(e){t._onElementKeyUp.apply(t,[this,e])});BX.bind(n,"input",function(e){t._onElementChange.apply(t,[this,e])});BX.bind(n,"focus",function(e){t._onElementFocus.apply(t,[this,e])});BX.bind(n,"blur",function(e){t._onElementBlur.apply(t,[this,e])});break}}}this._isEventsBinds=true},_handleDeleteClick:function(t){if(this.isReadOnly()){return}if(this._editor.handleProductDeletion(this)){this.clean();BX.PreventDefault(t)}},_handleKeyDown:function(t){if(!this._editor||!t||typeof t!=="object"||t.repeat||t.keyCode!==13||t.type!=="keydown"||!t.altKey){return}this._editor.productRowAdd();return t.preventDefault()},refreshCurrencyText:function(){var t,e,i,s,n,r,a;e=this._discountTypeView;if(e===BX.CrmDiscountType.monetary){t=this._container;i=this._editor.getSetting("discountTypeText",[]);s=i[e]?i[e]:"?";n=[];if(r=BX(t.id+"_DISCOUNT"))n[0]=BX.findChild(r.parentNode,{attr:{class:"crm-item-sale-text"}},true);if(a=BX(t.id+"_"+"_DISCOUNT_v"))n[1]=BX.findChild(a.parentNode,{attr:{class:"crm-item-sale-text"}},true);for(var o=0;o<n.length;o++){if(n[o]){n[o].innerHTML=s}}}},createGhostNode:function(){var t=BX.create("DIV",{attrs:{className:"crm-items-table-draggable-item"}});var e=BX.create("DIV",{attrs:{className:"crm-items-table-drag-inner"}});e.style.width=BX.pos(this._container).width+"px";t.appendChild(e);var i=BX.create("TABLE",{attrs:{className:"crm-items-table"}});e.appendChild(i);var s=i.insertRow(-1);s.className="crm-items-table-even-row";var n=s.insertCell(-1);n.className="crm-item-cell crm-item-name";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-view"},children:[BX.create("SPAN",{attrs:{className:"crm-table-name-left"},children:[BX.create("SPAN",{attrs:{className:"crm-item-move-btn"}}),BX.create("SPAN",{attrs:{className:"crm-item-num"},text:this.getRowNumber().toString()+"."})]}),BX.create("SPAN",{attrs:{className:"crm-item-txt-wrap"},children:[BX.create("DIV",{attrs:{className:"crm-item-name-txt"},text:this.getProductName()})]})]}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-price";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-qua";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-unit";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-sale";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-total";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));n=s.insertCell(-1);n.className="crm-item-cell crm-item-move";n.appendChild(BX.create("SPAN",{attrs:{className:"crm-item-cell-text"}}));return t},_handleChangeDiscountTypeView:function(t,e){if(t&&!this._editor.isInvoiceMode()){var i=this.getDiscountTypeId();if(i===BX.CrmDiscountType.percentage)i=BX.CrmDiscountType.monetary;else i=BX.CrmDiscountType.percentage;if(!this._viewMode)this.setFieldValue("DISCOUNT_TYPE_ID",i,true);if(e)BX.PreventDefault(e)}},_parseFloat:function(t,e,i){if(typeof e==="undefined"){e=2}if(typeof i==="undefined"){i=0}if(!BX.type.isNotEmptyString(t)){return i}t=t.replace(/^\s+|\s+$/g,"");var s=t.indexOf(".");var n=t.indexOf(",");var r=t.indexOf("-")===0;if(s<0&&n>=0){var a=t.substr(0,n);var o=t.length-n-1;if(o>0){a+="."+t.substr(n+1,o)}t=a}t=t.replace(/[^\d\.]+/g,"");var l=parseFloat(t);if(isNaN(l)){l=i}if(r){l=-l}if(e>=0){l=this._round(l,e)}return l},_parseInt:function(t,e){if(typeof e==="undefined"){e=0}if(!BX.type.isNotEmptyString(t)){return e}t=t.replace(/^\s+|\s+$/g,"");var i=t.indexOf("-")===0;var s=parseInt(t.replace(/[^\d]/g,""));if(isNaN(s)){s=e}if(i){s=-s}return s},_round:function(t,e){return BX.CrmProduct.round(t,e)},_calculateDiscountRate:function(t,e){if(t===0){return 0}if(e===0){return t>0?100:-100}return this._round(100*(t-e)/t,2)},_calculateDiscount:function(t,e){return t*e/100},_calculateDiscountByDiscountPrice:function(t,e,i){return 100*t/(100-e)-t},_calculatePrice:function(t,e,i){if(i===BX.CrmDiscountType.percentage){return t-t*e/100}if(i===BX.CrmDiscountType.monetary){return t-e}return 0},_calculateSumTotal:function(){var t=this._settings["TAX_INCLUDED"]?this._settings["PRICE"]*this._settings["QUANTITY"]:BX.CrmProduct.calculateInclusivePrice(this._round(this._settings["PRICE_EXCLUSIVE"]*this._settings["QUANTITY"],2),this._settings["TAX_RATE"]);return this._round(t,2)},getTaxSum:function(){var t=this._settings["TAX_INCLUDED"]?this._settings["PRICE"]*this._settings["QUANTITY"]*(1-1/(1+this._settings["TAX_RATE"]/100)):this._settings["PRICE_EXCLUSIVE"]*this._settings["QUANTITY"]*this._settings["TAX_RATE"]/100;return this._round(t,2)},fieldNameByElement:function(t){var e="",i=this._container.id,s=i.length;if(BX.type.isElementNode(t)&&t.id&&s>0&&t.id.length>s+1){e=t.id.substring(s+1)}return e},clearZeroValue:function(t,e){if(t&&BX.type.isElementNode(e)){var i=-1;switch(t){case"PRICE":case"DISCOUNT":case"DISCOUNT_SUBTOTAL":case"SUM":i=2;break;case"QUANTITY":i=4;break}if(i>0){var s=this._parseFloat(e.value,i,0);if(s===0){e.value=""}}}},formatElementValue:function(t,e){if(t&&BX.type.isElementNode(e)){var i=-1;var s=-1;switch(t){case"PRICE":case"DISCOUNT_SUBTOTAL":case"SUM":s=i=2;break;case"QUANTITY":i=4;break;case"DISCOUNT":i=2;if(this._discountTypeView===BX.CrmDiscountType.monetary)s=2;break}if(i>0){var n;if(t==="DISCOUNT_SUBTOTAL")n=this._parseFloat(this._fieldValue["DISCOUNT_SUBTOTAL"],i,0);else n=this._parseFloat(e.value,i,0);if(s>=0)e.value=n.toFixed(s);else e.value=n.toString()}}},_onElementKeyUp:function(t,e){var i=this.fieldNameByElement(t),s;if(i){var n=e.keyCode;if(n===13||n===27||n>=37&&n<=40||n>=112&&n<=123)return;var r=this._editor.isTaxAllowed();var a=i==="TAX_INCLUDED"?!!t.checked:!!this._fieldValue["TAX_INCLUDED"];var o=this._discountTypeView;switch(i){case"PRICE":if(r&&!a)s="PRICE_NETTO";else s="PRICE_BRUTTO";break;case"MEASURE":s="MEASURE_CODE";break;case"DISCOUNT":if(o===BX.CrmDiscountType.percentage)s="DISCOUNT_RATE";else s="DISCOUNT_SUM";break;default:s=i}var l=t.type==="checkbox"?t.checked:t.value;if(this._fieldValue[s]===l)return;this._fieldValue[s]=l;this.setFieldView(s,l);if(i==="PRODUCT_NAME")this._handleProductNameChange(l);this.processFieldValueChange(s)}},_onElementChange:function(t,e){var i=this.fieldNameByElement(t),s;if(i){var n=this._editor.isTaxAllowed();var r=i==="TAX_INCLUDED"?!!t.checked:!!this._fieldValue["TAX_INCLUDED"];var a=this._discountTypeView;switch(i){case"PRICE":if(n&&!r)s="PRICE_NETTO";else s="PRICE_BRUTTO";break;case"MEASURE":s="MEASURE_CODE";break;case"DISCOUNT":if(a===BX.CrmDiscountType.percentage)s="DISCOUNT_RATE";else s="DISCOUNT_SUM";break;default:s=i}var o=t.type==="checkbox"?t.checked:t.value;if(this._fieldValue[s]===o)return;this._fieldValue[s]=o;this.setFieldView(s,o);if(i==="PRODUCT_NAME")this._handleProductNameChange(o);this.processFieldValueChange(s);if(i==="TAX_INCLUDED"&&this._editor.getSetting("taxUniform",true)===true)this._editor.changeTaxIncludedUniform(this,o);this._editor.processProductChange(this)}},_handleProductNameChange:function(t){var e=this._container,i=e?BX(e.id+"_PRODUCT_NAME"):null,s,n,r,a="crm-item-inp-btn",o="crm-item-inp-plus",l="crm-item-inp-arrow",h="34px";if(i){r=BX.findNextSibling(i,{class:a});if(r){n=this.getProductId();s=BX.util.trim(String(t));if(s.length>0){if(n>0){BX.removeClass(r,o);BX.addClass(r,l);r.setAttribute("title",BX.CrmProductEditorMessages["openProductCard"]);r.parentNode.style.paddingRight=h}else{BX.removeClass(r,l);if(this._editor.getSetting("canAddProduct",false)){BX.addClass(r,o);r.setAttribute("title",BX.CrmProductEditorMessages["createProduct"]);r.parentNode.style.paddingRight=h}else{r.setAttribute("title","");r.parentNode.style.paddingRight=0}}}else{this.setProductId(0);BX.removeClass(r,l+" "+o);r.setAttribute("title","");r.parentNode.style.paddingRight=0}}}},_emulateTaxIncludedElementChange:function(t){var e="TAX_INCLUDED",i=this._container,s=BX(i.id+"_"+e);if(s){t=!!t;if(s.checked!==t){s.checked=t;this._fieldValue[e]=t;this.setFieldView(e,t);this.processFieldValueChange(e)}}},_onElementFocus:function(t,e){var i=this.fieldNameByElement(t);if(i){this._focusedField=i;if(i==="PRODUCT_NAME"||i==="PRICE"||i==="QUANTITY"||i==="DISCOUNT"||i==="DISCOUNT_SUBTOTAL"||i==="SUM"){this._editor.handleProductFocusChange(this,true)}this.clearZeroValue(i,t)}},_onElementBlur:function(t,e){var i=this.fieldNameByElement(t);if(i){if(this._focusedField===i)this._focusedField=null;if(i==="PRODUCT_NAME"||i==="PRICE"||i==="QUANTITY"||i==="DISCOUNT"||i==="DISCOUNT_SUBTOTAL"||i==="SUM"){if(i==="SUM"&&this._sumValueAfterBlur!==null){this.setFieldValue("SUM",this._sumValueAfterBlur);this._sumValueAfterBlur=null}this._editor.handleProductFocusChange(this,false)}this.formatElementValue(i,t)}},_onProductNameButtonClick:function(t,e){if(BX.hasClass(t,"crm-item-inp-arrow")){this._openProductCardUrl(this._getProductShowUrl())}else if(BX.hasClass(t,"crm-item-inp-plus")){if(this._editor.isProductCardEnabled()){this._openNewProductCardUrl()}else{this.createInCatalogViaDialog(BX.type.isDomNode(t)?t:null)}}},_openNewProductCardUrl:function(){this.saveSettings();var t=0;var e=this._editor.getSetting("defaultMeasure",null);if(e){if(e.hasOwnProperty("ID")){t=e["ID"]}}var i=this.getMeasureIdByCode(this.getMeasureCode());if(i===0){i=t}var s=0;var n="N";if(this._editor.isTaxAllowed()){var r=parseFloat(this.getTaxRate());s=this._editor.getTaxIdByValue(r);n=s!==0&&this.getSetting("TAX_INCLUDED",false)?"Y":"N"}var a={NAME:this.getSetting(this._fixProductName?"FIXED_PRODUCT_NAME":"PRODUCT_NAME",""),CURRENCY:this._editor.getCurrencyId(),QUANTITY:this.getQuantity(),PRICE:n==="Y"?this.getSetting("PRICE_BRUTTO",0).toFixed(2):this.getSetting("PRICE_NETTO",0).toFixed(2),MEASURE:i,VAT_ID:s,VAT_INCLUDED:n};var o=this._getProductShowUrlByProductId(0);var l;if(BX.Reflection.getClass("BX.SidePanel.Instance")){var h=BX.SidePanel.Instance.getUrlRule(o);l=h&&h.options?BX.clone(h.options):{};l.requestMethod="post";l.requestParams={external_fields:a};l.data={product:this}}this._openProductCardUrl(o,l)},_openProductCardUrl:function(t,e){if(BX.type.isNotEmptyString(t)){if(this._editor.isProductCardEnabled()&&BX.Reflection.getClass("BX.SidePanel.Instance")){BX.SidePanel.Instance.open(t,e)}else{window.open(t)}}},_getProductShowUrl:function(){return this._getProductShowUrlByProductId(this.getProductId())},_getProductShowUrlByProductId:function(t){var e=null,i;if(this._editor){i=this._editor.getPathToProductShow();if(i&&typeof i==="string"&&i.length>0){t=parseInt(t);if(BX.type.isNumber(t)){e=i.replace("#product_id#",t)}}}return e},createInCatalog:function(){var t,e;var i,s,n;var r,a,o;this.saveSettings();s=0;n=this._editor.getSetting("defaultMeasure",null);if(n){if(n.hasOwnProperty("ID"))s=n["ID"]}i=this.getMeasureIdByCode(this.getMeasureCode());if(i===0)i=s;a=0;o="N";if(this._editor.isTaxAllowed()){r=parseFloat(this.getTaxRate());a=this._editor.getTaxIdByValue(r);o=a!==0&&this.getSetting("TAX_INCLUDED",false)?"Y":"N"}t={NAME:this.getSetting(this._fixProductName?"FIXED_PRODUCT_NAME":"PRODUCT_NAME",""),DESCRIPTION:"",ACTIVE:"Y",CURRENCY:this._editor.getCurrencyId(),PRICE:o==="Y"?this.getSetting("PRICE_BRUTTO",0).toFixed(2):this.getSetting("PRICE_NETTO",0).toFixed(2),MEASURE:i,VAT_ID:a,VAT_INCLUDED:o,SECTION_ID:0,SORT:100,sessid:this._editor.getSetting("sessid",""),ajax:"Y"};e=String(this._editor.getSetting("pathToProductEdit","")).replace("#product_id#","0");BX.ajax({url:e,method:"POST",dataType:"json",data:t,onsuccess:BX.delegate(this.onCreateInCatalogSuccess,this),onfailure:BX.delegate(this.onCreateInCatalogFailure,this)})},onCreateInCatalogSuccess:function(t){var e=0,i="",s,n,r,a="crm-item-inp-btn",o="crm-item-inp-plus",l="crm-item-inp-arrow",h="34px";BX.closeWait();i=t["err"]!==""?t["err"]:"";e=parseInt(t["productId"])>0?parseInt(t["productId"]):0;if(e>0){this.setProductId(e);s=this._container;n=s?BX(s.id+"_PRODUCT_NAME"):null;if(n){r=BX.findNextSibling(n,{class:a});if(r){BX.removeClass(r,o);BX.addClass(r,l);r.setAttribute("title",BX.CrmProductEditorMessages["openProductCard"]);r.parentNode.style.paddingRight=h}}}},onCreateInCatalogFailure:function(t){},createInCatalogViaDialog:function(t){var e,i,s;var n,r,a;var o,l,h;this.saveSettings();r=0;a=this._editor.getSetting("defaultMeasure",null);if(a){if(a.hasOwnProperty("ID"))r=a["ID"]}n=this.getMeasureIdByCode(this.getMeasureCode());if(n===0)n=r;l=0;h="N";if(this._editor.isTaxAllowed()){o=parseFloat(this.getTaxRate());l=this._editor.getTaxIdByValue(o);h=l!==0&&this.getSetting("TAX_INCLUDED",false)?"Y":"N"}s={NAME:this.getSetting(this._fixProductName?"FIXED_PRODUCT_NAME":"PRODUCT_NAME",""),CURRENCY:this._editor.getCurrencyId(),PRICE:h==="Y"?this.getSetting("PRICE_BRUTTO",0).toFixed(2):this.getSetting("PRICE_NETTO",0).toFixed(2),MEASURE:n,VAT_ID:l,VAT_INCLUDED:h};i=BX.clone(this._editor._settings["productCreateDialogSettings"]);i["initialControl"]=t;i["productAdditionHandler"]=BX.delegate(this.handleSetProductFromDialog,this);i["customValues"]=s;e=new BX.CrmProductCreateDialog(i);e.show()},handleSetProductFromDialog:function(t){var e=typeof t["product"]!="undefined"&&typeof t["product"][0]!="undefined"?t["product"][0]:null;if(!e)return;this.saveSettings();var i=this._editor;var s=this.getQuantity();var n=this.getDiscountTypeId();var r=n===BX.CrmDiscountType.percentage?this.getDiscountRate():this.getDiscountSum();i.handleProductSearchSelect(this,e);this.setFieldValue("DISCOUNT_TYPE_ID",parseInt(n));if(n===BX.CrmDiscountType.percentage)this.setFieldValue("DISCOUNT_RATE",this._round(parseFloat(r),2),true);else this.setFieldValue("DISCOUNT_SUM",parseFloat(r).toFixed(2),true);this.setFieldValue("QUANTITY",s,true)}};BX.CrmProduct.calculateExclusivePrice=function(t,e){return t/(1+e/100)};BX.CrmProduct.calculateInclusivePrice=function(t,e){return t*(1+e/100)};BX.CrmProduct.round=function(t,e){if(!BX.type.isNumber(e)){e=2}var i=Math.pow(10,e);return Math.round(t*i)/i};BX.CrmProduct.create=function(t,e,i){var s=new BX.CrmProduct;s.initialize(t,e,i);return s}}if(typeof BX.CrmProductSearch==="undefined"){BX.CrmProductSearch=function(){this._product=null;this._settings={};this.cache=[];this.cache_key=null;this._data=[];this.currentValue="";this.currentRow=-1;this.RESULT=null;this.CONTAINER=null;this.INPUT=null;this.WAIT=null;this._handleOnChange=true;this._onChangeTimer=null;this.focused=false};BX.CrmProductSearch.prototype={initialize:function(t,e){this._product=e;this._settings={AJAX_PAGE:t["AJAX_PAGE"],CONTAINER_ID:t["CONTAINER_ID"],INPUT_ID:t["INPUT_ID"],MIN_QUERY_LEN:parseInt(t["MIN_QUERY_LEN"])};if(t["WAIT_IMAGE"])this._settings["WAIT_IMAGE"]=t["WAIT_IMAGE"];if(this._settings["MIN_QUERY_LEN"]<=0)this._settings["MIN_QUERY_LEN"]=3;this.CONTAINER=document.getElementById(this._settings["CONTAINER_ID"]);this.RESULT=document.body.appendChild(document.createElement("DIV"));this.RESULT.className="title-search-result";this.INPUT=document.getElementById(this._settings["INPUT_ID"]);this.currentValue=this.oldValue=this.INPUT.value;BX.bind(this.INPUT,"focus",BX.delegate(this.onFocusGain,this));BX.bind(this.INPUT,"blur",BX.delegate(this.onFocusLost,this));BX.bind();this.INPUT.onkeydown=BX.delegate(this.onKeyDown,this);if(this._settings["WAIT_IMAGE"]){this.WAIT=document.body.appendChild(document.createElement("DIV"));this.WAIT.style.backgroundImage="url('"+this._settings["WAIT_IMAGE"]+"')";if(!BX.browser.IsIE())this.WAIT.style.backgroundRepeat="none";this.WAIT.style.display="none";this.WAIT.style.position="absolute";this.WAIT.style.zIndex="1100"}BX.bind(this.INPUT,"bxchange",BX.delegate(this.onChangeDelayed,this))},showResult:function(t){var e=BX.pos(this.CONTAINER);e.width=e.right-e.left;this.RESULT.style.position="absolute";this.RESULT.style.top=e.bottom+2+"px";this.RESULT.style.left=e.left+"px";this.RESULT.style.width=e.width+"px";if(t!=null)this.RESULT.innerHTML=t;if(this.RESULT.innerHTML.length>0&&this.INPUT.value!==this.currentValue&&this.focused)this.RESULT.style.display="block";else this.RESULT.style.display="none";var i;var s=BX.findChild(this.RESULT,{tag:"table",class:"title-search-result"},true);if(s)i=BX.findChild(s,{tag:"th"},true);if(i){var n=BX.pos(s);n.width=n.right-n.left;var r=BX.pos(i);r.width=r.right-r.left;i.style.width=r.width+"px";this.RESULT.style.width=e.width+r.width+"px";this.RESULT.style.left=e.left-r.width-1+"px";if(n.width-r.width>e.width)this.RESULT.style.width=e.width+r.width-1+"px";n=BX.pos(s);var a=BX.pos(this.RESULT);if(a.right>n.right){this.RESULT.style.width=n.right-n.left+"px"}}var o;if(s)o=BX.findChild(this.RESULT,{class:"title-search-fader"},true);if(o&&i){a=BX.pos(this.RESULT);o.style.left=a.right-a.left-18+"px";o.style.width=18+"px";o.style.top=0+"px";o.style.height=a.bottom-a.top+"px";o.style.display="block"}},onKeyPress:function(t){var e=BX.findChild(this.RESULT,{tag:"table",class:"title-search-result"},true);if(!e)return false;var i=e.rows.length,s;switch(t){case 27:this.RESULT.style.display="none";this.currentRow=-1;this.unselectAll();this.currentValue=this.INPUT.oldValue=this.INPUT.value;return true;case 40:if(this.RESULT.style.display=="none")this.RESULT.style.display="block";var n=-1;for(s=0;s<i;s++){if(!BX.findChild(e.rows[s],{class:"title-search-separator"},true)){if(n==-1)n=s;if(this.currentRow<s){this.currentRow=s;break}else if(e.rows[s].className=="title-search-selected"){e.rows[s].className=""}}}if(s==i&&this.currentRow!=s)this.currentRow=n;e.rows[this.currentRow].className="title-search-selected";return true;case 38:if(this.RESULT.style.display=="none")this.RESULT.style.display="block";var r=-1;for(s=i-1;s>=0;s--){if(!BX.findChild(e.rows[s],{class:"title-search-separator"},true)){if(r==-1)r=s;if(this.currentRow>s){this.currentRow=s;break}else if(e.rows[s].className=="title-search-selected"){e.rows[s].className=""}}}if(s<0&&this.currentRow!=s)this.currentRow=r;e.rows[this.currentRow].className="title-search-selected";return true;case 13:if(this.RESULT.style.display=="block"){for(s=0;s<i;s++){if(this.currentRow==s){this.RESULT.style.display="none";this.currentRow=-1;this.unselectAll();this.handleSelectItem(s)}}}return true}return false},onTimeout:function(){this.onChange(function(){setTimeout(BX.delegate(this.onTimeout,this),500)})},onChangeDelayed:function(){if(this._handleOnChange&&this.INPUT.value!=this.oldValue){this.RESULT.style.display="none";this.RESULT.innerHTML="";if(this.INPUT.value.length>=this._settings["MIN_QUERY_LEN"]){this.cache_key=this._settings["INPUT_ID"]+"|"+this.INPUT.value;if(this.cache[this.cache_key]==null){if(this._onChangeTimer)clearTimeout(this._onChangeTimer);this._onChangeTimer=setTimeout(BX.delegate(this.onChange,this),500);return}}this.onChange()}},onChange:function(){if(this._handleOnChange&&this.INPUT.value!=this.oldValue){this.RESULT.style.display="none";this.RESULT.innerHTML="";this.currentValue=null;this.oldValue=this.INPUT.value;if(this.INPUT.value.length>=this._settings["MIN_QUERY_LEN"]){this.cache_key=this._settings["INPUT_ID"]+"|"+this.INPUT.value;if(this.cache[this.cache_key]==null){if(this.WAIT){var t=BX.pos(this.INPUT);var e=t.bottom-t.top-2;this.WAIT.style.top=t.top+1+"px";this.WAIT.style.height=e+"px";this.WAIT.style.width=e+"px";this.WAIT.style.left=t.right-e+2+"px";this.WAIT.style.display="block"}var i=this._product._editor.getCurrencyId();BX.ajax({url:this._settings["AJAX_PAGE"],method:"POST",dataType:"json",data:{MODE:"SEARCH",RESULT_WITH_VALUE:"Y",CURRENCY_ID:i,ENABLE_RAW_PRICES:"Y",ENABLE_SEARCH_BY_ID:"N",MULTI:"N",VALUE:this.INPUT.value,LIMIT:5},onsuccess:BX.delegate(this.onProductSearchResponseSuccess,this),onfailure:BX.delegate(this.onProductSearchResponseFailure,this)})}else{var s=this.makeHtmlFromResult(this.cache[this.cache_key]);this.showResult(s);this.currentRow=-1;this.enableMouseEvents()}}else{this.RESULT.style.display="none";this.currentRow=-1;this.unselectAll();this.cache=[]}}},onProductSearchResponseSuccess:function(t){var e,i=t["data"];this.cache_key=this._settings["INPUT_ID"]+"|"+t["searchValue"];this.cache[this.cache_key]=i;if(this.INPUT.value===t["searchValue"]){e=this.makeHtmlFromResult(i);this.showResult(e)}this.currentRow=-1;this.enableMouseEvents();if(this.WAIT)this.WAIT.style.display="none"},onProductSearchResponseFailure:function(t){},makeHtmlFromResult:function(t){var e="",i,s;this._data=[];if(BX.type.isArray(t)&&t.length>0){e+='<table class="title-search-result">';for(s=0;s<t.length;s++){i=t[s];if(i&&i.hasOwnProperty("title")){e+='<tr id="row_'+s+'">';e+='<td class="title-search-item">'+BX.Text.encode(i["title"])+"</td>";e+="</tr>";this._data[s]=i}}e+="</table>"}return e},unselectAll:function(){var t=BX.findChild(this.RESULT,{tag:"table",class:"title-search-result"},true);if(t){var e=t.rows.length;for(var i=0;i<e;i++)t.rows[i].className=""}},enableMouseEvents:function(){var t=BX.findChild(this.RESULT,{tag:"table",class:"title-search-result"},true);var e=this;if(t){var i=t.rows.length;for(var s=0;s<i;s++)if(!BX.findChild(t.rows[s],{class:"title-search-separator"},true)){t.rows[s].id="row_"+s;t.rows[s].onmouseover=function(t){BX.delegate(e.onMouseOver,e)(this,t)};t.rows[s].onmouseout=function(t){BX.delegate(e.onMouseOut,e)(this,t)};BX.bind(t.rows[s],"click",function(){BX.delegate(e.handleSelectItem,e)(this.id.substr(4))})}}},onMouseOver:function(t,e){if(this.currentRow!=t.id.substr(4)){this.unselectAll();t.className="title-search-selected";this.currentRow=t.id.substr(4)}},onMouseOut:function(t,e){t.className="";this.currentRow=-1},onFocusGain:function(){this.focused=true},onFocusLost:function(){this.focused=false;setTimeout(BX.delegate(this.handleFocusLostTimer,this),250);this.currentValue=this.INPUT.value},handleFocusLostTimer:function(){this.RESULT.style.display="none"},onKeyDown:function(t){if(!t)t=window.event;if(this.RESULT.style.display=="block"){if(this.onKeyPress(t.keyCode))return BX.PreventDefault(t)}},handleSelectItem:function(t){if(this._product&&this._product._editor){var e=this._product._editor;this.disableOnChangeHandler();this.currentValue=this.oldValue=this._data[t]["title"];e.handleProductSearchSelect(this._product,this._data[t]);this.enableOnChangeHandler()}},enableOnChangeHandler:function(){this._handleOnChange=true},disableOnChangeHandler:function(){this._handleOnChange=false}};BX.CrmProductSearch.create=function(t,e){var i=new BX.CrmProductSearch;i.initialize(t,e);return i}}if(typeof BX.CrmProductRowListPlaceholder==="undefined"){BX.CrmProductRowListPlaceholder=function(){this._settings=null;this._node=null;this._editor=null;this._productId="";this._productIndex=-1};BX.CrmProductRowListPlaceholder.prototype={initialize:function(t){this._settings=t?t:{};this._node=this.getSetting("node",null);this._editor=this.getSetting("editor",null);this._productId=this.getSetting("productId","");this._productIndex=parseInt(this.getSetting("productIndex",-1))},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getNode:function(){return this._node},setNode:function(t){this._node=t},getProductId:function(){return this._productId},getProductIndex:function(){return this._productIndex},layout:function(){if(!this._node){throw"CrmProductRowListPlaceholder: The 'node' is not assigned."}var t=this._node;t.height="30px";var e=t.insertCell(-1);e.className="crm-item-cell";e.colSpan=8}};BX.CrmProductRowListPlaceholder.create=function(t){var e=new BX.CrmProductRowListPlaceholder;e.initialize(t);return e}}if(typeof BX.CrmProdoctRowListDragItem==="undefined"){BX.CrmProdoctRowListDragItem=function(){BX.CrmProdoctRowListDragItem.superclass.constructor.apply(this);this._product=null;this._container=null;this._showInDragMode=true;this._ghostWidth=0;this._ghostHeight=0};BX.extend(BX.CrmProdoctRowListDragItem,BX.CrmCustomDragItem);BX.CrmProdoctRowListDragItem.prototype.doInitialize=function(){this._product=this.getSetting("product");if(!this._product){throw"CrmProdoctRowListDragItem: The 'product' parameter is not defined in settings or empty."}this._container=this.getSetting("container");if(!this._container){throw"CrmProdoctRowListDragItem: The 'container' parameter is not defined in settings or empty."}this._showInDragMode=this.getSetting("showInDragMode",true)};BX.CrmProdoctRowListDragItem.prototype.getProduct=function(){return this._product};BX.CrmProdoctRowListDragItem.prototype.createGhostNode=function(){if(this._ghostNode){return this._ghostNode}this._ghostNode=this._product.createGhostNode();document.body.appendChild(this._ghostNode);var t=BX.pos(this._ghostNode);this._ghostWidth=t.width;this._ghostHeight=t.height};BX.CrmProdoctRowListDragItem.prototype.removeGhostNode=function(){if(this._ghostNode){document.body.removeChild(this._ghostNode);this._ghostNode=null}};BX.CrmProdoctRowListDragItem.prototype.getContextId=function(){return BX.CrmProdoctRowListDragItem.contextId};BX.CrmProdoctRowListDragItem.prototype.getContextData=function(){return{contextId:BX.CrmProdoctRowListDragItem.contextId,product:this._product}};BX.CrmProdoctRowListDragItem.prototype.processDragStart=function(){if(!this._showInDragMode){this._product.getContainer().style.display="none";BX.CrmProdoctRowListDragContainer.refresh()}};BX.CrmProdoctRowListDragItem.prototype._onDrag=function(t,e){if(!this._isInDragMode){return}if(this._ghostNode){t+=this._ghostOffset.x;e+=this._ghostOffset.y;var i=BX.pos(this._container);if(t<i.left||t+this._ghostWidth>i.right){t=i.left}if(e<i.top){e=i.top}else if(e>i.bottom){e=i.bottom}this._ghostNode.style.top=e+"px";this._ghostNode.style.left=t+"px"}this._dragNotifier.notify([t,e])};BX.CrmProdoctRowListDragItem.prototype.processDragStop=function(){if(!this._showInDragMode){this._product.getContainer().style.display="";BX.CrmProdoctRowListDragContainer.refresh()}};BX.CrmProdoctRowListDragItem.contextId="product_row_list_item";BX.CrmProdoctRowListDragItem.create=function(t,e){var i=new BX.CrmProdoctRowListDragItem;i.initialize(t,e);return i}}if(typeof BX.CrmProdoctRowListDragContainer==="undefined"){BX.CrmProdoctRowListDragContainer=function(){BX.CrmProdoctRowListDragContainer.superclass.constructor.apply(this);this._editor=null};BX.extend(BX.CrmProdoctRowListDragContainer,BX.CrmCustomDragContainer);BX.CrmProdoctRowListDragContainer.prototype.doInitialize=function(){this._editor=this.getSetting("editor");if(!this._editor){throw"CrmProdoctRowListDragContainer: The 'editor' parameter is not defined in settings or empty."}};BX.CrmProdoctRowListDragContainer.prototype.getEditor=function(){return this._editor};BX.CrmProdoctRowListDragContainer.prototype.createPlaceHolder=function(t){var e;var i=this._editor.getPlaceHolder();if(i){e=BX.pos(i.getNode());if(t.y>=e.top&&t.y<=e.bottom){return}}var s="";var n=-1;var r=this._editor.getProducts();for(var a=0;a<r.length;a++){var o=r[a];e=BX.pos(o.getContainer());if(t.y>=e.top&&t.y<=e.bottom){if(e.top+e.height/2-t.y>=0){s=o.getId();n=a}else if(a<r.length-1){s=r[a+1].getId();n=a+1}break}}this._editor.createPlaceHolder({id:s,index:n})};BX.CrmProdoctRowListDragContainer.prototype.removePlaceHolder=function(){this._editor.removePlaceHolder()};BX.CrmProdoctRowListDragContainer.prototype.isAllowedContext=function(t){return t===BX.CrmProdoctRowListDragItem.contextId};BX.CrmProdoctRowListDragContainer.enable=function(t,e){e=parseInt(e);if(e>0){window.setTimeout(function(){BX.CrmProdoctRowListDragContainer.enable(t,0)});return}for(var i in this.items){if(this.items.hasOwnProperty(i)){this.items[i].enable(t)}}};BX.CrmProdoctRowListDragContainer.refresh=function(){for(var t in this.items){if(this.items.hasOwnProperty(t)){this.items[t].refresh()}}};BX.CrmProdoctRowListDragContainer.items={};BX.CrmProdoctRowListDragContainer.create=function(t,e){var i=new BX.CrmProdoctRowListDragContainer;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmProductSearchDialogWindow==="undefined"){BX.CrmProductSearchDialogWindow=function(){this._settings={};this.popup=null;this.random="";this.contentContainer=null;this.zIndex=996;this.jsEventsManager=null;this.pos=null;this.height=0;this.width=0;this.resizeCorner=null};BX.CrmProductSearchDialogWindow.prototype={initialize:function(t){this.random=Math.random().toString().substring(2);this._settings=t?t:{};var e=BX.CrmProductSearchDialogWindow.size;this._settings.width=e.width||this._settings.width||1100;this._settings.height=e.height||this._settings.height||530;this._settings.minWidth=this._settings.minWidth||500;this._settings.minHeight=this._settings.minHeight||800;this._settings.draggable=!!this._settings.draggable||true;this._settings.resizable=!!this._settings.resizable||true;if(typeof this._settings.closeWindowHandler!=="function")this._settings.closeWindowHandler=null;if(typeof this._settings.showWindowHandler!=="function")this._settings.showWindowHandler=null;this.jsEventsManager=BX.Crm[this._settings.jsEventsManagerId]||null;this.contentContainer=BX.create("DIV",{attrs:{className:"crm-catalog",style:"display: block; background-color: #f3f6f7; height: "+this._settings.height+"px; overflow: hidden; width: "+this._settings.width+"px;"}})},_handleCloseDialog:function(t){if(t)t.destroy();this.popup=null;if(this.jsEventsManager){this.jsEventsManager.unregisterEventHandlers("CrmProduct_SelectSection")}if(typeof this._settings.closeWindowHandler==="function")this._settings.closeWindowHandler()},_handleAfterShowDialog:function(t){t.popupContainer.style.position="fixed";t.popupContainer.style.top=parseInt(t.popupContainer.style.top)-BX.GetWindowScrollPos().scrollTop+"px";if(typeof this._settings.showWindowHandler==="function")this._settings.showWindowHandler()},setContent:function(t){if(BX.type.isString(t)&&BX.type.isDomNode(this.contentContainer))this.contentContainer.innerHTML=t},show:function(){BX.ajax({method:"GET",dataType:"html",url:this._settings.content_url,data:{},skipAuthCheck:true,onsuccess:BX.delegate(function(t){this.setContent(t||"&nbsp;");this.showWindow()},this),onfailure:BX.delegate(function(){if(typeof this._settings.showWindowHandler==="function")this._settings.showWindowHandler()},this)})},showWindow:function(){this.popup=new BX.PopupWindow("CrmProductSearchDialogWindow_"+this.random,null,{overlay:{opacity:82},autoHide:false,draggable:this._settings.draggable,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},bindOnResize:false,zIndex:this.zIndex-1100,closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:BX.CrmProductEditorMessages["productSearchDialogTitle"],events:{onPopupClose:BX.delegate(this._handleCloseDialog,this),onAfterPopupShow:BX.delegate(this._handleAfterShowDialog,this)},content:this.contentContainer});if(this.popup.popupContainer){this.resizeCorner=BX.create("SPAN",{attrs:{className:"bx-crm-dialog-resize"},events:{mousedown:BX.delegate(this.resizeWindowStart,this)}});this.popup.popupContainer.appendChild(this.resizeCorner);if(!this._settings.resizable)this.resizeCorner.style.display="none"}this.popup.show()},setResizable:function(t){t=!!t;if(this._settings.resizable!==t){this._settings.resizable=t;if(this.resizeCorner){if(t)this.resizeCorner.style.display="inline-block";else this.resizeCorner.style.display="none"}}},resizeWindowStart:function(t){if(!this._settings.resizable)return;t=t||window.event;BX.PreventDefault(t);this.pos=BX.pos(this.contentContainer);BX.bind(document,"mousemove",BX.proxy(this.resizeWindowMove,this));BX.bind(document,"mouseup",BX.proxy(this.resizeWindowStop,this));if(document.body.setCapture)document.body.setCapture();try{document.onmousedown=false}catch(t){}try{document.body.onselectstart=false}catch(t){}try{document.body.ondragstart=false}catch(t){}try{document.body.style.MozUserSelect="none"}catch(t){}try{document.body.style.cursor="nwse-resize"}catch(t){}},resizeWindowMove:function(t){var e=BX.GetWindowScrollPos();var i=t.clientX+e.scrollLeft;var s=t.clientY+e.scrollTop;BX.CrmProductSearchDialogWindow.size.height=this.height=Math.max(s-this.pos.top,this._settings.minHeight);BX.CrmProductSearchDialogWindow.size.width=this.width=Math.max(i-this.pos.left,this._settings.minWidth);this.contentContainer.style.height=this.height+"px";this.contentContainer.style.width=this.width+"px"},resizeWindowStop:function(t){if(document.body.releaseCapture)document.body.releaseCapture();BX.unbind(document,"mousemove",BX.proxy(this.resizeWindowMove,this));BX.unbind(document,"mouseup",BX.proxy(this.resizeWindowStop,this));try{document.onmousedown=null}catch(t){}try{document.body.onselectstart=null}catch(t){}try{document.body.ondragstart=null}catch(t){}try{document.body.style.MozUserSelect=""}catch(t){}try{document.body.style.cursor="auto"}catch(t){}}};BX.CrmProductSearchDialogWindow.create=function(t){var e=new BX.CrmProductSearchDialogWindow;e.initialize(t);return e};BX.CrmProductSearchDialogWindow.loadCSS=function(t){BX.ajax({method:"GET",dataType:"html",url:t.content_url,data:{},skipAuthCheck:true})};BX.CrmProductSearchDialogWindow.size={width:0,height:0}}if(typeof BX.Crm.PageEventsManagerClass==="undefined"){BX.Crm.PageEventsManagerClass=function(){this._settings={}};BX.Crm.PageEventsManagerClass.prototype={initialize:function(t){this._settings=t?t:{};this.eventHandlers={}},registerEventHandler:function(t,e){if(!this.eventHandlers[t])this.eventHandlers[t]=[];this.eventHandlers[t].push(e);BX.addCustomEvent(this,t,e)},fireEvent:function(t,e){BX.onCustomEvent(this,t,e)},unregisterEventHandlers:function(t){if(this.eventHandlers[t]){for(var e=0;e<this.eventHandlers[t].length;e++){BX.removeCustomEvent(this,t,this.eventHandlers[t][e])}delete this.eventHandlers[t]}}};BX.Crm.PageEventsManagerClass.create=function(t){var e=new BX.Crm.PageEventsManagerClass;e.initialize(t);return e}}
//# sourceMappingURL=script.map.js