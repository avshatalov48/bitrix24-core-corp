if(typeof BX.CrmProductCreateDialog==="undefined"){BX.CrmProductCreateDialog=function(e){this.settings=e;this.messages=e["messages"];this.random=Math.random().toString().substring(2);this.popupContentId="";this.errorContainerId="";this.popup=null;this.initialControl=this.settings["initialControl"]};BX.CrmProductCreateDialog.prototype={show:function(){var e=typeof this.settings["bindToElement"]==="undefined"||this.settings["bindToElement"];var t=996;var i=new BX.PopupWindow("CrmProductCreateDialog_"+this.random,e?this.initialControl:null,{overlay:{opacity:10},titleBar:" ",autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,zIndex:t-1100,bindOptions:e?{forceBindPosition:false}:false,closeByEsc:true,closeIcon:{top:"10px",right:"15px"},cacheable:false});if(this.settings["lazyLoad"]){var a=BX.create("div",{attrs:{style:"height: 300px; width: 600px;"}});i.setContent(a);i.show();var s=new BX.Loader;s.show(a);BX.ajax.runComponentAction(this.settings["componentName"],"getProductCreateDialogParams",{mode:"class",signedParameters:this.settings["signedParameters"]}).then(BX.delegate(function(e){this.settings=BX.mergeEx(this.settings,e.data);this.settings["lazyLoad"]=false;this.messages=this.settings["messages"];this.doShow(i)},this),BX.delegate(function(e){var t=BX.create("div",{attrs:{className:"bx-crm-dialog-quick-create-error-wrap"},text:e.errors.map(function(e){return e.message}).join(", ")});i.setContent(t);i.adjustPosition()},this))}else{this.doShow(i)}},doShow:function(e){var t=this;var i=BX.create("TABLE",{attrs:{id:this.random+"_table",cellspacing:"7"}});var a=this.settings["fields"];var s=this.settings["messages"];var r,n,o,d,l,c,u,p,f;var h=[],m,g;f={};p=this.settings["customValues"]&&typeof this.settings["customValues"]==="object";if(p){f=this.settings["customValues"]}m=0;for(var x=0;x<a.length;x++){u=a[x]["value"];if(p&&f.hasOwnProperty(a[x]["textCode"]))u=f[a[x]["textCode"]];if(a[x]["skip"]==="Y")continue;o=a[x]["type"];c=parseInt(a[x]["maxLength"]);d=40;l=4;switch(o){case"select":var B={};if(a[x]["params"]&&typeof a[x]["params"]==="object"){var b=a[x]["params"];for(var v in b){if(b.hasOwnProperty(v))B[v]=b[v]}}B["id"]=this.random+"_"+x;B["className"]="bx-crm-dialog-quick-create-field-select";B["name"]=a[x]["textCode"];r=BX.create("SELECT",{style:{marginLeft:"10px"},attrs:B});this.rebuildSelect(r,a[x]["items"],u);break;case"checkbox":r=BX.create("INPUT",{style:{marginLeft:"10px"},attrs:{id:this.random+"_"+x,type:o,name:a[x]["textCode"]}});r.checked=u==="Y";break;case"textarea":r=BX.create("TEXTAREA",{style:{marginLeft:"10px"},attrs:{id:this.random+"_"+x,className:"bx-crm-dialog-quick-create-field-text-input",type:o,name:a[x]["textCode"],text:BX.util.htmlspecialchars(u),cols:d,rows:l,maxlength:c>0?c:7500}});break;case"custom":var C=BX.processHTML(u);r=BX.create("DIV",{style:{marginLeft:"10px"},attrs:{id:this.random+"_"+x,className:"bx-crm-dialog-quick-create-field-custom"},html:u});var X=[],w=0;for(w=0;w<C["SCRIPT"].length;w++){X[w]={TYPE:C["SCRIPT"][w].isInternal?"SCRIPT":"SCRIPT_EXT",DATA:C["SCRIPT"][w].JS}}g={scripts:X,styles:C["STYLE"]};h[m++]=g;break;default:r=BX.create("INPUT",{style:{marginLeft:"10px"},attrs:{id:this.random+"_"+x,className:"bx-crm-dialog-quick-create-field-text-input",type:o,name:a[x]["textCode"],value:u,size:d,maxlength:c>0?c:255}});break}var T=BX.create("TD");if("Y"===a[x]["required"])T.appendChild(BX.create("SPAN",{attrs:{style:"position: absolute; left: 18px; color: red;"},text:"*"}));T.appendChild(BX.create("SPAN",{text:s[a[x]["textCode"]]+":"}));i.appendChild(BX.create("TR",{children:[T,BX.create("TD",{children:[r]})]}))}var I=BX.create("DIV",{attrs:{id:this.random+"_error",className:"bx-crm-dialog-quick-create-error-wrap"}});var y=BX.create("DIV",{style:{marginLeft:"12px",marginTop:"12px",marginRight:"12px",marginBottom:"12px",minWidth:"600px"},attrs:{id:this.random+"_content"},children:[I,i]});var P=this.settings["url"]?BX.util.trim(this.settings["url"].toString()):"/crm/product/edit/0/";var E=BX.create("FORM",{attrs:{id:this.settings["formId"],name:this.settings["formId"],method:"POST",action:P,enctype:"multipart/form-data"}});var k=BX.create("INPUT",{attrs:{type:"hidden",name:"sessid",value:BX.bitrix_sessid()}});if(k)E.appendChild(k);k=BX.create("INPUT",{attrs:{type:"hidden",name:"ajaxSubmit",value:"Y"}});if(k)E.appendChild(k);k=BX.create("INPUT",{attrs:{type:"hidden",name:"currencyTo",value:this.settings["ownerCurrencyId"]}});if(k)E.appendChild(k);k=null;E.appendChild(y);e.setTitleBar(this.messages["dialogTitle"]);e.setContent(E);for(m=0;m<h.length;m++){if(h[m]["scripts"].length>0)BX.evalPack(h[m]["scripts"]);if(h[m]["styles"].length>0)BX.loadCSS(h[m]["styles"])}e.setButtons([new BX.PopupWindowButton({text:this.messages["buttonCreateTitle"],className:"popup-window-button-accept",events:{click:function(){if(e){if(y){t.popupContentId=y.id;t.errorContainerId=I.id;t.popup=e;t.createProduct()}}}}}),new BX.PopupWindowButtonLink({text:this.messages["buttonCancelTitle"],className:"popup-window-button-link-cancel",events:{click:function(){if(e)e.close()}}})]);e.show();if(e.popupContainer)BX.scrollToNode(e.popupContainer)},createProduct:function(){var e=BX(this.settings["formId"]);BX.ajax.submitAjax(e,{method:"POST",processData:false,onsuccess:BX.delegate(function(e){if(e===""){BX.closeWait();this.showAjaxError("")}var t=BX.parseJSON(e,{});if(!t){BX.closeWait();this.showAjaxError("")}var i=0,a="";BX.closeWait();a=t["err"]!==""?t["err"]:"";i=parseInt(t["productId"])>0?parseInt(t["productId"]):0;if(i>0){if(this.popup){this.popup.close();this.popup=null}if(typeof t["productData"]!=="undefined"){var s=t["productData"];if(typeof s["NAME"]!=="undefined"&&typeof s["PRICE"]!=="undefined"&&typeof(this.settings["productAdditionHandler"]==="function")){var r=this.settings["productAdditionHandler"];var n={product:[{id:i,title:s["NAME"],customData:{price:s["PRICE"],tax:{}}}]};if(typeof s["VAT_ID"]!=="undefined")n["product"][0]["customData"]["tax"]["id"]=s["VAT_ID"];if(typeof s["VAT_INCLUDED"]!=="undefined")n["product"][0]["customData"]["tax"]["included"]=s["VAT_INCLUDED"]==="Y";if(t["measureData"]&&typeof t["measureData"]==="object"){var o=t["measureData"];if(o["code"]&&parseInt(o["code"])>0&&o["name"]){n["product"][0]["customData"]["measure"]={code:o["code"],name:o["name"]}}}r(n)}}}else{this.showAjaxError(a)}},this),onfailure:BX.delegate(function(e){BX.closeWait();this.showAjaxError("")},this)})},showAjaxError:function(e){if(e==="")e=this.messages["ajaxError"];var t=BX(this.errorContainerId);if(t){t.innerHTML=e}if(this.popup.popupContainer)BX.scrollToNode(this.popup.popupContainer)},setSelectValue:function(e,t){var i,a;var s=false;var r=!!e.getAttribute("multiple");if(!(t instanceof Array))t=[t];for(i=0;i<e.options.length;i++){for(a in t){if(e.options[i].value==t[a]){if(!s){s=true;e.selectedIndex=i}e.options[i].selected=true;break}}if(!r&&s)break}},rebuildSelect:function(e,t,i){var a,s,r,n;var o=false;var d;if(!(i instanceof Array))i=[i];if(e){d=!!e.getAttribute("multiple");while(a=e.lastChild)e.removeChild(a);for(r=0;r<t.length;r++){s=document.createElement("option");s.value=t[r]["id"];s.innerHTML=BX.util.htmlspecialchars(t[r]["title"]);try{e.add(s,e.options[null])}catch(i){s=document.createElement("option");s.text=t[r]["title"];e.add(s,null)}if(!o||d){for(n=0;n<i.length;n++){if(t[r]["id"]==i[n]){s.selected=true;if(!o){o=true;e.selectedIndex=r}break}}}}}}}}if(typeof addNewTableRow==="undefined"){function addNewTableRow(e,t){var i=document.getElementById(e);var a=i.rows.length;if(t==null)t=a-1;var s=i.rows[t].cells[0].innerHTML;var r=i.insertRow(t+1);var n=r.insertCell(0);var o,d,l,c;c=0;while(true){o=s.indexOf("[n",c);if(o<0)break;d=s.indexOf("]",o);if(d<0)break;l=parseInt(s.substr(o+2,d-o));s=s.substr(0,o)+"[n"+ ++l+"]"+s.substr(d+1);c=o+1}c=0;while(true){o=s.indexOf("__n",c);if(o<0)break;d=s.indexOf("_",o+2);if(d<0)break;l=parseInt(s.substr(o+3,d-o));s=s.substr(0,o)+"__n"+ ++l+"_"+s.substr(d+1);c=d+1}c=0;while(true){o=s.indexOf("__N",c);if(o<0)break;d=s.indexOf("__",o+2);if(d<0)break;l=parseInt(s.substr(o+3,d-o));s=s.substr(0,o)+"__N"+ ++l+"__"+s.substr(d+2);c=d+2}c=0;while(true){o=s.indexOf("xxn",c);if(o<0)break;d=s.indexOf("xx",o+2);if(d<0)break;l=parseInt(s.substr(o+3,d-o));s=s.substr(0,o)+"xxn"+ ++l+"xx"+s.substr(d+2);c=d+2}c=0;while(true){o=s.indexOf("%5Bn",c);if(o<0)break;d=s.indexOf("%5D",o+3);if(d<0)break;l=parseInt(s.substr(o+4,d-o));s=s.substr(0,o)+"%5Bn"+ ++l+"%5D"+s.substr(d+3);c=d+3}var u={html:s};BX.onCustomEvent(window,"onAddNewRowBeforeInner",[u]);s=u.html;n.innerHTML=s;var p=new RegExp("<"+"script"+">[^\0]*?<"+"/"+"script"+">","ig");var f=s.match(p);if(f){for(var h=0;h<f.length;h++){if(f[h]!=""){o=f[h].substring(8,f[h].length-9);jsUtils.EvalGlobal(o)}}}if(BX&&BX.adminPanel){BX.adminPanel.modifyFormElements(r);BX.onCustomEvent("onAdminTabsChange")}setTimeout(function(){var e=BX.findChildren(n,{tag:/^(input|select|textarea)$/i});if(e&&e.length>0){for(var t=0,i=e.length;t<i;t++){if(e[t].form&&e[t].form.BXAUTOSAVE)e[t].form.BXAUTOSAVE.RegisterInput(e[t]);else break}}},10)}}
//# sourceMappingURL=product_create.map.js