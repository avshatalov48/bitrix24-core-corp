{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {Reflection, Event, ajax as Ajax, Text} from \"main.core\";\nimport {EventEmitter} from \"main.core.events\";\nimport {BaseButton, ButtonManager} from \"ui.buttons\";\nimport {Router} from \"crm.router\";\nimport {Menu} from \"main.popup\";\n\nconst namespace = Reflection.namespace('BX.Crm');\n\nlet instance = null;\n\nclass ToolbarEvents\n{\n\tstatic TYPE_UPDATED = 'TypeUpdated';\n\tstatic CATEGORIES_UPDATED = 'CategoriesUpdated';\n}\n\nclass ToolbarComponent extends EventEmitter\n{\n\tconstructor() {\n\t\tsuper();\n\n\t\tthis.setEventNamespace('BX.Crm.ToolbarComponent');\n\n\t\tEvent.ready(this.bindEvents.bind(this));\n\t}\n\n\tstatic get Instance(): ToolbarComponent\n\t{\n\t\tif ( (window.top !== window) && Reflection.getClass('top.BX.Crm.ToolbarComponent') )\n\t\t{\n\t\t\treturn window.top.BX.Crm.ToolbarComponent.Instance;\n\t\t}\n\n\t\tif(instance === null)\n\t\t{\n\t\t\tinstance = new ToolbarComponent();\n\t\t}\n\n\t\treturn instance;\n\t}\n\n\tbindEvents()\n\t{\n\t\tconst buttonNode = document.querySelector('[data-role=\"bx-crm-toolbar-categories-button\"]');\n\t\tif (buttonNode)\n\t\t{\n\t\t\tconst entityTypeId = Number(buttonNode.dataset.entityTypeId);\n\t\t\tconst button = ButtonManager.createFromNode(buttonNode);\n\t\t\tif (button && entityTypeId > 0)\n\t\t\t{\n\t\t\t\tthis.subscribeCategoriesUpdatedEvent(() => {\n\t\t\t\t\tthis.reloadCategoriesMenu(button, entityTypeId, buttonNode.dataset.categoryId);\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\temitTypeUpdatedEvent(data)\n\t{\n\t\tthis.emit(ToolbarEvents.TYPE_UPDATED, data);\n\t}\n\n\temitCategoriesUpdatedEvent(data)\n\t{\n\t\tthis.emit(ToolbarEvents.CATEGORIES_UPDATED, data);\n\t}\n\n\tsubscribeTypeUpdatedEvent(callback)\n\t{\n\t\tthis.subscribe(ToolbarEvents.TYPE_UPDATED, callback);\n\t}\n\n\tsubscribeCategoriesUpdatedEvent(callback)\n\t{\n\t\tthis.subscribe(ToolbarEvents.CATEGORIES_UPDATED, callback);\n\t}\n\n\treloadCategoriesMenu(button: BaseButton, entityTypeId: number, categoryId: ?number)\n\t{\n\t\tconst menu = button.getMenuWindow();\n\t\tif (!menu)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tAjax.runAction('crm.controller.category.list', {\n\t\t\tdata: {\n\t\t\t\tentityTypeId\n\t\t\t}\n\t\t}).then((response) => {\n\t\t\tlet startKey = 0;\n\t\t\tconst items = [];\n\t\t\tconst categories = response.data.categories;\n\t\t\tmenu.menuItems.forEach((item) => {\n\t\t\t\tif (item.id.indexOf('toolbar-category-') !== 0)\n\t\t\t\t{\n\t\t\t\t\titems.push(item.options);\n\t\t\t\t}\n\t\t\t\telse if (item.id === 'toolbar-category-all')\n\t\t\t\t{\n\t\t\t\t\titems.push(item.options);\n\t\t\t\t\tstartKey = 1;\n\t\t\t\t}\n\t\t\t});\n\t\t\tmenu.destroy();\n\t\t\tEvent.unbindAll(button.getContainer(), 'click');\n\t\t\tcategories.forEach((category) => {\n\t\t\t\tconst link = Router.Instance.getItemListUrlInCurrentView(entityTypeId, category.id);\n\t\t\t\titems.splice(startKey, 0, {\n\t\t\t\t\tid: 'toolbar-category-' + category.id,\n\t\t\t\t\ttext: Text.encode(category.name),\n\t\t\t\t\thref: link ? link.toString() : null,\n\t\t\t\t});\n\t\t\t\tif (category.id > 0 && categoryId > 0 && Number(categoryId) === Number(category.id))\n\t\t\t\t{\n\t\t\t\t\tbutton.setText(Text.encode(category.name));\n\t\t\t\t}\n\t\t\t\tstartKey++;\n\t\t\t});\n\t\t\tconst options = menu.params;\n\t\t\toptions.items = items;\n\t\t\tbutton.menuWindow = new Menu(options);\n\t\t\tEvent.bind(button.getContainer(), 'click', button.menuWindow.show.bind(button.menuWindow));\n\t\t}).catch((response) => {\n\t\t\tconsole.log('error trying reload categories', response.errors);\n\t\t});\n\t}\n}\n\nnamespace.ToolbarComponent = ToolbarComponent;"],"names":["namespace","Reflection","instance","ToolbarEvents","ToolbarComponent","setEventNamespace","Event","ready","bindEvents","bind","buttonNode","document","querySelector","entityTypeId","Number","dataset","button","ButtonManager","createFromNode","subscribeCategoriesUpdatedEvent","reloadCategoriesMenu","categoryId","data","emit","TYPE_UPDATED","CATEGORIES_UPDATED","callback","subscribe","menu","getMenuWindow","Ajax","runAction","then","response","startKey","items","categories","menuItems","forEach","item","id","indexOf","push","options","destroy","unbindAll","getContainer","category","link","Router","Instance","getItemListUrlInCurrentView","splice","text","Text","encode","name","href","toString","setText","params","menuWindow","Menu","show","catch","console","log","errors","window","top","getClass","BX","Crm","EventEmitter"],"mappings":"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"}