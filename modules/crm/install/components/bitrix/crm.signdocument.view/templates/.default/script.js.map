{"version":3,"file":"script.js","sources":["../../../../../js/crm/timeline/item/src/components/enums/button-state.js","script.es6.js"],"sourcesContent":["export class ButtonState\n{\n\tstatic DEFAULT = '';\n\tstatic LOADING = 'loading';\n\tstatic DISABLED = 'disabled';\n\tstatic HIDDEN = 'hidden';\n\tstatic AI_LOADING = 'ai-loading';\n}\n","import { Dom, Reflection, Tag, Loc, Type } from 'main.core';\nimport { BaseButton, ButtonManager } from 'ui.buttons';\nimport type { DocumentSend } from 'sign.v2.document-send';\nimport { ButtonState } from '../../../../../js/crm/timeline/item/src/components/enums/button-state';\n\nconst namespace = Reflection.namespace('BX.Crm.Component');\nconst Viewer = Reflection.namespace('BX.UI.Viewer');\n\ndeclare type SignDocumentViewParameters = {\n\tpdfNode: ?Element,\n\tpdfSource: ?string,\n\tprintButtonId: ?string,\n\tdownloadButtonId: ?string,\n};\n\nlet defaultComponent = null;\n\n/**\n * @memberOf BX.Crm.Component\n */\nclass SignDocumentView\n{\n\tpdfNode: ?Element;\n\tpdfSource: ?string;\n\tprintButton: ?BaseButton;\n\tdownloadButton: ?BaseButton;\n\tviewer: ?Viewer.SingleDocumentController;\n\n\tconstructor(parameters: SignDocumentViewParameters)\n\t{\n\t\tthis.pdfNode = parameters.pdfNode;\n\t\tthis.pdfSource = parameters.pdfSource;\n\t\tthis.printButton = ButtonManager.createByUniqId('crm-document-print');\n\t\tthis.downloadButton = ButtonManager.createByUniqId('crm-document-download');\n\n\t\tthis.#initViewer();\n\t\tthis.#bindEvents();\n\n\t\tdefaultComponent = this;\n\t}\n\n\t#initViewer(): void\n\t{\n\t\tconst viewer = this.getViewer();\n\t\tif (!viewer)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tviewer.setItems([Viewer.buildItemByNode(this.pdfNode)]);\n\t\tviewer.setPdfSource(this.pdfSource);\n\t\tviewer.setScale(1.2);\n\t\tviewer.open();\n\t}\n\n\tgetViewer(): ?Viewer.SingleDocumentController\n\t{\n\t\tif (!this.viewer && this.pdfNode)\n\t\t{\n\t\t\tthis.viewer = new Viewer.SingleDocumentController({baseContainer: this.pdfNode, stretch: true});\n\t\t}\n\n\t\treturn this.viewer ?? null;\n\t}\n\n\t#bindEvents(): void\n\t{\n\t\tif (this.printButton && this.getViewer())\n\t\t{\n\t\t\tthis.printButton.bindEvent('click', () => {\n\t\t\t\tthis.getViewer().print();\n\t\t\t})\n\t\t}\n\t\tif (this.downloadButton)\n\t\t{\n\t\t\tthis.downloadButton.bindEvent('click', () => {\n\t\t\t\twindow.open(this.pdfSource, '_blank');\n\t\t\t});\n\t\t}\n\t}\n\n\tstatic getDefaultComponent(): ?SignDocumentView\n\t{\n\t\treturn defaultComponent;\n\t}\n}\n\ndeclare type SignDocumentViewSendWidgetParameters = {\n\tmemberIds: Array<number>\n}\n\nclass SignDocumentViewSendWidget\n{\n\t#container: HTMLElement = null;\n\t#button: HTMLElement = null;\n\t#docSend: DocumentSend | undefined = undefined;\n\t#memberIds: Array<number> = [];\n\n\tconstructor(options: SignDocumentViewSendWidgetParameters = {})\n\t{\n\t\tthis.#memberIds = options?.memberIds ?? [];\n\t\tthis.#button = this.#createButton();\n\n\t\tif (!Type.isUndefined(BX?.Sign?.V2?.DocumentSend))\n\t\t{\n\t\t\tthis.#docSend = new BX.Sign.V2.DocumentSend();\n\t\t\tthis.#docSend.subscribeOnce('ready', (event) => {\n\t\t\t\tif (event.getData()?.readyMembers?.length)\n\t\t\t\t{\n\t\t\t\t\tthis.enableButton();\n\t\t\t\t}\n\t\t\t});\n\t\t\tthis.#docSend.loadStatus(this.#memberIds);\n\t\t}\n\t}\n\n\tenableButton(): void\n\t{\n\t\tDom.removeClass(this.#button, 'crm__sign-document-view-resend--button-disabled');\n\t}\n\n\tdisableButton(): void\n\t{\n\t\tDom.addClass(this.#button, 'crm__sign-document-view-resend--button-disabled');\n\t}\n\n\tisButtonDisabled(): boolean\n\t{\n\t\treturn Dom.hasClass(this.#button, 'crm__sign-document-view-resend--button-disabled');\n\t}\n\n\trenderTo(node: HTMLElement): void\n\t{\n\t\tDom.append(this.render(), node);\n\t}\n\n\trender(): HTMLElement\n\t{\n\t\tif (!this.#container)\n\t\t{\n\t\t\tthis.#container = Tag.render`\n\t\t\t\t<div class=\"crm__sign-document-view-resend--container\">\n\t\t\t\t\t<div class=\"crm__sign-document-view-resend--list\">\n\t\t\t\t\t\t${this.#button}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`;\n\t\t}\n\n\t\treturn this.#container;\n\t}\n\n\tsend(memberIds: Array<number>): Promise\n\t{\n\t\treturn this.#docSend.send(memberIds);\n\t}\n\n\t#updateStatus(memberIds: Array<number>): Promise\n\t{\n\t\treturn this.#docSend.loadStatus(memberIds);\n\t}\n\n\t#createButton(): HTMLElement\n\t{\n\t\tconst onResendBtnClick = (event) => {\n\t\t\tif (this.isButtonDisabled())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.#updateStatus(this.#memberIds).then((readyMembers) => {\n\t\t\t\tif (readyMembers.length > 0)\n\t\t\t\t{\n\t\t\t\t\treturn this.send(readyMembers).then(() => {\n\t\t\t\t\t\tthis.disableWithTimer(60);\n\t\t\t\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\t\t\t\tcontent: Loc.getMessage('CRM_DOCUMENT_VIEW_DOCUMENT_SEND_NOTIFY_SUCCESS'),\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tthrow new Error('no members in appropriate status');\n\t\t\t});\n\t\t};\n\n\t\treturn Tag.render`\n\t\t\t<div\n\t\t\t\tclass=\"crm__sign-document-view-resend--button crm__sign-document-view-resend--button-disabled\"\n\t\t\t\tonclick=\"${onResendBtnClick.bind(this)}\"\n\t\t\t>\n\t\t\t\t<div class=\"crm__sign-document-view-resend--button-icon --service-sms\"></div>\n\t\t\t\t<div class=\"crm__sign-document-view-resend--button-main-title\">\n\t\t\t\t\t${Loc.getMessage('CRM_DOCUMENT_VIEW_DOCUMENT_SEND_SEND_AGAIN')}\n\t\t\t\t</div>\n\t\t\t\t<div class=\"crm__sign-document-view-resend--button-helper\"></div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t#createButtonText(remainingSeconds: number): string\n\t{\n\t\treturn remainingSeconds > 0\n\t\t\t? Loc.getMessage('CRM_DOCUMENT_VIEW_DOCUMENT_SEND_SEND_AGAIN_TIMER', {\n\t\t\t\t'#COUNTDOWN#': this.#formatSeconds(remainingSeconds),\n\t\t\t})\n\t\t\t: Loc.getMessage('CRM_DOCUMENT_VIEW_DOCUMENT_SEND_SEND_AGAIN')\n\t\t;\n\t}\n\n\t#setButtonText(text: string): void\n\t{\n\t\tthis.#button\n\t\t\t.querySelector('.crm__sign-document-view-resend--button-main-title')\n\t\t\t.textContent = text;\n\t}\n\n\tdisableWithTimer(sec: number): void\n\t{\n\t\tthis.disableButton();\n\t\tlet remainingSeconds = sec;\n\n\t\tthis.#setButtonText(this.#createButtonText(remainingSeconds));\n\n\t\tconst timer = setInterval(() => {\n\t\t\tif (remainingSeconds < 1)\n\t\t\t{\n\t\t\t\tclearInterval(timer);\n\t\t\t\tthis.#setButtonText(this.#createButtonText(0));\n\t\t\t\tthis.enableButton();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tremainingSeconds--;\n\t\t\tthis.#setButtonText(this.#createButtonText(remainingSeconds));\n\t\t}, 1000);\n\t}\n\n\t#formatSeconds(sec: number): string\n\t{\n\t\tconst minutes = Math.floor(sec / 60);\n\t\tconst seconds = sec % 60;\n\n\t\tconst formatMinutes = this.#formatNumber(minutes);\n\t\tconst formatSeconds = this.#formatNumber(seconds);\n\n\t\treturn `${formatMinutes}:${formatSeconds}`;\n\t}\n\n\t#formatNumber(num: number): string\n\t{\n\t\treturn num < 10 ? `0${num}` : num;\n\t}\n}\n\nnamespace.SignDocumentView = SignDocumentView;\nnamespace.SignDocumentViewSendWidget = SignDocumentViewSendWidget;\n"],"names":["ButtonState","namespace","Reflection","Viewer","defaultComponent","SignDocumentView","parameters","pdfNode","pdfSource","printButton","ButtonManager","createByUniqId","downloadButton","viewer","SingleDocumentController","baseContainer","stretch","getViewer","setItems","buildItemByNode","setPdfSource","setScale","open","bindEvent","print","window","SignDocumentViewSendWidget","options","undefined","memberIds","Type","isUndefined","BX","Sign","V2","DocumentSend","subscribeOnce","event","getData","readyMembers","length","enableButton","loadStatus","Dom","removeClass","addClass","hasClass","node","append","render","Tag","send","sec","disableButton","remainingSeconds","timer","setInterval","clearInterval","onResendBtnClick","isButtonDisabled","then","disableWithTimer","UI","Notification","Center","notify","content","Loc","getMessage","Error","bind","text","querySelector","textContent","minutes","Math","floor","seconds","formatMinutes","formatSeconds","num"],"mappings":"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"}