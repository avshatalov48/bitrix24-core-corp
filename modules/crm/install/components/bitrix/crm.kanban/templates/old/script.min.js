if(typeof BX.CrmKanbanHelper==="undefined"){BX.CrmKanbanHelper=function(t){this._error="";this._popup_name="kanban_dialog";this._delayStack=t.DELAY_BETWEEN_LOADING||25;this._type=t.ENTITY_TYPE||"";this._gridId=t.GRID_ID||"";this._ajaxPath=t.AJAX_PATH||"/bitrix/components/bitrix/crm.kanban/ajax.php";this._data=t.DATA||{};this._data.container=t.CONTAINER||document.body;this._currency=t.CURRENCY||"";this._extra=t.EXTRA||[];this._more_fields=t.MORE_FIELDS||[];this._more_fields_new=null;this._popup=null;this._entityId=0;this._entityLastId=0;this.settings={path_column_edit:t.PATH_COLUMN_EDIT||"/crm/configs/status/",show_activity:t.SHOW_ACTIVITY==="Y",access_config_perms:t.ACCESS_CONFIG_PERMS==="Y"};BX.addCustomEvent("onPullEvent-im",BX.proxy(this._pullEventHandler,this));BX.addCustomEvent("onPullEvent-crm",BX.proxy(this._pullEventHandler,this));BX.addCustomEvent("onCrmActivityTodoChecked",BX.proxy(this._activityCheckHandler,this));BX.addCustomEvent("onPopupClose",BX.proxy(this._onClosePopup,this));BX.addCustomEvent("BX.Main.Filter:apply",BX.proxy(this._applyFilter,this));BX.addCustomEvent("BX.CrmEntityCounterPanel:applyFilter",BX.proxy(this._applyFilterCounter,this));setInterval(BX.proxy(this._loadStack,this),this._delayStack*1e3)};BX.CrmKanbanHelper.prototype={getEntityType:function(){return this._type},getKanban:function(){return this._kanban},getMoreFields:function(){if(this._more_fields_new===null){this._more_fields_new=[];for(var t=0;t<this._more_fields.length;t++){if(this._more_fields[t].new===1){this._more_fields_new.push(this._more_fields[t])}}}return this._more_fields_new},getSettings:function(t){return this.settings[t]},openActivityItems:function(t){this._entityId=t;this._showPopup("",{onAfterPopupShow:BX.proxy(this._loadActivities,this)})},moveState:function(t,e,a,n){var i=this._kanban.getColumn(a).items;var n=n||{};if(i.length>1){n.old_status_lastid=i[i.length-1].id}this._loadJSON({entity_id:t,prev_entity_id:this._kanban.prevItem(t,e),status:e,status_params:n||{},action:"status"})},setLastId:function(t){t=parseInt(t);if(t>this._entityLastId){this._entityLastId=t}},loadPage:function(t,e){this._loadJSON({column:t,page:e,action:"page"})},_addFade:function(t){if(t===true){this._data.container.classList.add("crm-kanban-grid-search")}else{this._data.container.classList.remove("crm-kanban-grid-search")}},_applyFilter:function(t,e,a){this._addFade(true);this._loadJSON({action:"get",clear:true})},_applyFilterCounter:function(t,e){setTimeout(BX.delegate(function(){var t={ACTIVITY_COUNTER:e["counterTypeId"]};var a=BX.Main.filterManager.getById(this._gridId);var n=a.getApi();n.setFields(t);n.apply()},this),0);e["cancel"]=true},_showPopup:function(t,e){if(true||this._popup===null){this._popup=new BX.PopupWindow(this._popup_name,BX.proxy_context,{closeIcon:false,autoHide:true,overlay:false,className:"crm-kanban-popup-plan",closeByEsc:true,contentColor:"white",angle:true,offsetLeft:15,events:e})}var a='<div class="crm-kanban-user-loader-item"><div class="crm-kanban-loader"><svg class="crm-kanban-circular" viewBox="25 25 50 50"><circle class="crm-kanban-path" cx="50" cy="50" r="20" fill="none" stroke-width="1" stroke-miterlimit="10"/></svg></div></div>';this._popup.setContent(a);this._popup.show()},_onClosePopup:function(t,e){if(t.uniquePopupId===this._popup_name){BX.cleanNode(t.contentContainer)}if(t.bindElement&&t.bindElement.tagName=="SPAN"){var a=t.bindElement.getAttribute("parent-id");var n=kanban.querySelector('[data-id="'+a+'"]');if(n){n.classList.remove("crm-kanban-deal-item-show")}}},_loadActivities:function(){var t=this;var e={entity_id:this._entityId,entity_type:this._type,action:"activities"};BX.ajax.get(this._ajaxPath,e,function(e){t._popup.setContent(e);t._popup.adjustPosition()})},_loadStack:function(){this._loadJSON({min_entity_id:this._entityLastId,action:"get",show:true})},_loadJSON:function(t){var e=this;t.entity_type=this._type;t.sessid=BX.bitrix_sessid();t.extra=this._extra;BX.ajax.loadJSON(this._ajaxPath,t,function(a){BX.CrmKanbanGrid.prototype.counterTotalPrice();if(typeof a!=="undefined"){var n=a.error||[];var i=a.items||[];var o=a.columns||[];if(n.length>0){}else{if(t.clear===true){if(i.length==0){kanban.classList.add("crm-kanban-empty-mode")}else{kanban.classList.remove("crm-kanban-empty-mode")}var r=e._kanban.items;for(var s in r){e._kanban.getColumn(r[s].columnId).removeItem(r[s])}}for(var l=0;l<i.length;l++){var c=e._kanban.getItem(i[l].id);if(!c||t.clear===true){e._kanban.addItem(i[l],e._kanban.getColumn(i[l].columnId).items[0])}if(typeof t.page==="undefined"&&(typeof t.status_params==="undefined"||typeof t.status_params.old_status_lastid==="undefined")){if(e._kanban.getColumn(i[l].columnId)!==null){var m=e._kanban.getColumn(i[l].columnId).items;e._kanban.moveItemToColumFilter(i[l].id,i[l].columnId,m.length>0?m[0].id:null,i[l].modifyByAvatar);if(t.show===true){e._kanban.moveItemToColum(i[l].id,i[l].columnId,m.length>0?m[0].id:null,true)}else{e._kanban.moveItemToColumFilter(i[l].id,i[l].columnId,m.length>0?m[0].id:null,i[l].modifyByAvatar)}}}}e._kanban.counterTotalPrice(o)}e._addFade(false)}})},_pullEventHandler:function(t,e){if(t==="activity_add"&&e.OWNER_TYPE_NAME===this._type&&e.COMPLETED!=="Y"){BX.CrmKanbanItem.changeActCount(e.OWNER_ID,1)}if(t==="kanban_add"||t==="kanban_update"){var a=e;var n=this._kanban.getItem(a.id);var i=this._kanban.getColumn(a.columnId);var o=i.items;var r=o.length>0?o[0].id:null;var s=this._kanban.columns;var l=[];if(!n){a.columnColor=i.color;this._kanban.addItem(a,r)}else if(n.columnId===a.columnId){return}for(var c in s){var m=parseInt(s[c].count);var d=parseFloat(s[c].total);if(n&&n.columnId===c){m--;d=d-parseFloat(a.price)}else if(a.columnId===c){m++;d=d+parseFloat(a.price)}s[c].count=m;s[c].total=d;s[c].total_format=BX.Currency.currencyFormat(d,this._currency,true);l.push({id:s[c].id,price:s[c].price,columnId:c,count:m,total:d,total_format:s[c].total_format})}this._kanban.moveItemToColumShow(a.id,a.columnId,r,a.modifyByAvatar);this._kanban.counterTotalPrice(l)}},_activityCheckHandler:function(t,e,a){BX.CrmKanbanItem.changeActCount(e,-1)}};BX.CrmKanbanHelper.instance=null;BX.CrmKanbanHelper.create=function(t){if(BX.CrmKanbanHelper.instance===null){var e=new BX.CrmKanbanHelper(t);BX.CrmKanbanHelper.instance=e;e._kanban=new BX.CrmKanbanGrid(e._data);e._kanban.draw()}return BX.CrmKanbanHelper.instance};BX.CrmKanbanHelper.getInstance=function(){return BX.CrmKanbanHelper.instance}}if(typeof BX.CrmKanbanGrid==="undefined"){BX.CrmKanbanGrid=function(t){this.columns=Object.create(null);this.columns_sort={};this.items=Object.create(null);this.dropzones=Object.create(null);this.container=t.container;this.dragger=new BX.CrmKanbanDragDrop(this);this.loadData(t);this.timer=null;this.kanban=null};BX.CrmKanbanGrid.prototype={setWidth:function(){var t=null;var e=null;var a=null;setTimeout(function(){a=document.querySelector(".crm-kanban-dropzone");t=parseInt(getComputedStyle(kanban.parentNode).paddingLeft);e=document.documentElement.clientWidth-BX.pos(kanban.parentNode).left-64;kanban.parentNode.style.width=e+"px";kanban.style.width=e-t*2+"px";a.style.width=e+"px";kanban.style.left=""},0);setTimeout(this.resize,500)},setHeight:function(){var t=parseInt(getComputedStyle(kanban.parentNode).paddingLeft);if(kanban.parentNode.getBoundingClientRect().top>=0){var e=document.documentElement.clientHeight-kanban.getBoundingClientRect().top;kanban.style.height=e+"px";kanban.style.top="";kanban.parentNode.style.minHeight=e+t*2+"px"}if(kanban.parentNode.getBoundingClientRect().bottom>=document.documentElement.clientHeight){setTimeout(function(){if(kanban.offsetHeight!==document.documentElement.clientHeight-kanban.getBoundingClientRect().top){kanban.style.height=document.documentElement.clientHeight-kanban.getBoundingClientRect().top+"px"}},200)}},resize:function(t){var e=parseInt(getComputedStyle(kanban.parentNode).paddingLeft);var a=null;var n=document.querySelector(".crm-kanban-dropzone");n.style.left=BX.pos(kanban.parentNode).left+"px";if(kanban.parentNode.getBoundingClientRect().top>=0){a=document.documentElement.clientHeight-kanban.getBoundingClientRect().top-1;kanban.style.height=a+"px";kanban.parentNode.style.minHeight=document.documentElement.clientHeight+"px";kanban.style.left="";kanban.style.top="";kanban.classList.remove("crm-kanban-grid-fixed")}else{kanban.classList.add("crm-kanban-grid-fixed");kanban.style.left=BX.pos(kanban.parentNode.parentNode).left+e+"px";kanban.style.top=e+"px";kanban.style.height="";if(kanban.parentNode.getBoundingClientRect().bottom<=document.documentElement.clientHeight){}else{kanban.style.minHeight=document.documentElement.clientHeight-e+"px";n.style.bottom=""}}},prevItem:function(t,e){var a=this.getColumn(e);if(a){var n=a.items||[];var i=n.length;if(i>1){for(var o=0;o<i-1;o++){if(n[o+1].id===t){return n[o].id}}}}return 0},counterTotalPrice:function(t){var e=this.columns;if(typeof t==="undefined"){for(var a in e){n(e[a].total,e[a].layout.summary,e[a].count,e[a].layout.total,e[a].total_format,e[a])}}else{for(var a=0;a<t.length;a++){if(e[t[a].id]){n(t[a].total,e[t[a].id].layout.summary,t[a].count,e[t[a].id].layout.total,t[a].total_format,e[t[a].id])}}}function n(t,e,a,n,i,o){var a=a;var n=n;var t=t;var r=e;var s;var l=r.getAttribute("data-total");var c=+l;n.innerHTML=a;if(o.items.length<+a){o.layout.items.appendChild(o.layout.loadMore);o.layout.loadMore.classList.remove("crm-kanban-loadmore-show")}if(c!==null){if(c>t){s=(c-t)/20}else{s=(t-c)/20}}else{s=t/20}if(t!=0){function m(t,e,a,n,o){t=parseInt(t);s=0;if(o!=null){var s=+o}if(s<t){(function(){if(s<=t){setTimeout(arguments.callee,a);r.innerHTML=BX.util.number_format(s,0,","," ");s=s+n}else{r.innerHTML=i;r.setAttribute("data-total",t)}})()}else if(s>t){(function(){if(s>=t){setTimeout(arguments.callee,a);r.innerHTML=BX.util.number_format(s,0,","," ");s=s-n}else{r.innerHTML=i;r.setAttribute("data-total",t)}})()}else{return false}}m(t,r,5,s,c)}else{r.setAttribute("data-total","0");r.innerHTML="0"}}},addColumn:function(t){t=t||{};if(this.getColumn(t.id)!==null){return}var e=new BX.CrmKanbanColumn(t);e.kanban=this;this.columns[t.id]=e;this.columns_sort[t.sort]=t.id},addDrop:function(t){t=t||{};if(this.getDrop(t.id)!==null){return}var e=new BX.CrmKanbanDrop(t);e.kanban=this;this.dropzones[t.id]=e},addItem:function(t){t=t||{};var e=this.getColumn(t.columnId);if(e){var a=new BX.CrmKanbanItem(t);a.kanban=this;this.items[t.id]=a;e.addItem(a)}},moveItemToColumShow:function(t,e,a,n){t=this.getItem(t);e=this.getColumn(e);a=this.getItem(a);var i=this.getColumn(t.columnId);var o=document.querySelector('[data-move="'+t.id+'"]');var r=o.offsetWidth;var s=document.querySelector('[data-move-column="'+e.id+'"]');if(a){s=document.querySelector('[data-move="'+a.id+'"]')}var l=null;var c=null;function m(t){var e=t.getBoundingClientRect();var a=document.body;var n=document.documentElement;var i=window.pageYOffset||n.scrollTop||a.scrollTop;var o=window.pageXOffset||n.scrollLeft||a.scrollLeft;var r=n.clientTop||a.clientTop||0;var s=n.clientLeft||a.clientLeft||0;l=e.top+i-r;c=e.left+o-s}m(o);o.classList.add("crm-kanban-deal-item-block");var d="crm-kanban-grid-item-pre";if(a){d="crm-kanban-deal-item-pre"}s.classList.add(d);var p=o.cloneNode(true);if(n){var h=BX.create("div",{attrs:{className:"crm-kanban-deal-item-touchuser",style:n?"background-image: url("+n+")":""}});p.appendChild(h)}p.classList.add("crm-kanban-deal-item-dragshow");p.style.width=r+"px";p.style.position="absolute";p.style.top=l+"px";p.style.left=c+"px";p.style.zIndex="999999";document.body.appendChild(p);setTimeout(m(s),1);setTimeout(function(){p.style.top=l+102+"px";if(a){p.style.top=l+"px"}p.style.left=c+"px"},1);setTimeout(function(){if(i!==e){i.removeItem(t);e.addItem(t,a)}o.classList.remove("crm-kanban-deal-item-block");s.classList.remove(d);p.parentNode.removeChild(p)},1e3)},moveItemToColumFilter:function(t,e,a){t=this.getItem(t);e=this.getColumn(e);a=this.getItem(a);var n=this.getColumn(t.columnId);if(n!==e){n.removeItem(t);e.addItem(t,a)}},moveItemToColum:function(t,e,a,n){if(BX.type.isNumber(+t)){t=this.getItem(t)}if(n){t.layout.container.classList.add("crm-kanban-deal-item-added");setTimeout(function(){t.layout.container.classList.remove("crm-kanban-deal-item-added")}.bind(this),2100)}var i=t.layout.container.querySelector(".crm-kanban-deal-item-wrapper-border");var o=e.color;i.style.background="#"+o;if(BX.type.isNumber(e)||BX.type.isString(e)){e=this.getColumn(e)}if(BX.type.isNumber(+a)){a=this.getItem(a)}var r=this.getColumn(t.columnId);if(r!==e){r.removeItem(t);e.addItem(t,a)}else if(a){if(a!==t){r.removeItem(t);e.addItem(t,a)}}else if(r&&!a){r.removeItem(t);e.addItem(t,a)}},getColumn:function(t){return this.columns[t]?this.columns[t]:null},getDrop:function(t){return this.dropzones[t]?this.dropzones[t]:null},getItem:function(t){return this.items[t]?this.items[t]:null},draw:function(){var t=document.createDocumentFragment();for(var e in this.columns_sort){var a=this.columns_sort[e];t.appendChild(this.columns[a].render())}var n=BX.create("div",{attrs:{className:"crm-kanban-dropzone"},style:{left:BX.pos(this.container.parentNode).left+"px",bottom:"0"}});var i=document.createDocumentFragment();for(var o in this.dropzones){i.appendChild(this.dropzones[o].render())}var r=BX.create("div",{attrs:{className:"crm-kanban-grid-wrapper"}});r.appendChild(t);n.appendChild(i);this.container.appendChild(r);document.body.appendChild(n);this.counterTotalPrice();this.setWidth();this.setHeight();this.setScroll();BX.bind(window,"scroll",this.resize);BX.bind(window,"resize",this.resize);BX.bind(window,"resize",this.setHeight);BX.bind(window,"resize",this.setWidth);BX.bind(window,"resize",this.setScrollPosition)},scrollingRight:function(){var t=kanban.lastChild;this.timer=setInterval(function(){t.scrollLeft+=10},10)},scrollingLeft:function(){var t=kanban.lastChild;this.timer=setInterval(function(){t.scrollLeft-=10},10)},scrollingStop:function(){clearInterval(this.timer)},setScroll:function(){this.scrollLeft=this.container.querySelector(".crm-kanban-scroll-left");this.scrollRight=this.container.querySelector(".crm-kanban-scroll-right");if(kanban.lastElementChild.scrollWidth>document.documentElement.clientWidth-BX.pos(kanban.parentNode).left-65){this.scrollRight.classList.add("crm-kanban-scroll-show")}BX.bind(this.container.lastElementChild,"scroll",this.setScrollPosition);setTimeout(function(){this.setScrollPosition()}.bind(this),0);BX.bind(this.scrollRight,"mouseenter",this.scrollingRight);BX.bind(this.scrollLeft,"mouseenter",this.scrollingLeft);BX.bind(this.scrollRight,"mouseleave",this.scrollingStop);BX.bind(this.scrollLeft,"mouseleave",this.scrollingStop)},setScrollPosition:function(){var t=kanban.querySelector(".crm-kanban-scroll-left");var e=kanban.querySelector(".crm-kanban-scroll-right");if(kanban.lastElementChild.scrollLeft>0){t.classList.add("crm-kanban-scroll-show")}else{t.classList.remove("crm-kanban-scroll-show")}setTimeout(function(){if(kanban.lastElementChild.scrollLeft+kanban.lastElementChild.offsetWidth<kanban.lastElementChild.scrollWidth){e.classList.add("crm-kanban-scroll-show")}else{e.classList.remove("crm-kanban-scroll-show")}},0);if(kanban.lastElementChild.scrollLeft+kanban.lastElementChild.offsetWidth<kanban.lastElementChild.scrollWidth){e.classList.add("crm-kanban-scroll-show")}else{e.classList.remove("crm-kanban-scroll-show")}},setEmptyMode:function(t){var e=BX.create("div",{attrs:{className:"crm-kanban-empty"},children:[BX.create("div",{attrs:{className:"crm-kanban-empty-inner","data-role":"kanban-empty"},children:[BX.create("div",{attrs:{className:"crm-kanban-empty-image"}}),BX.create("div",{attrs:{className:"crm-kanban-empty-text"},text:BX.message("CRM_KANBAN_NO_DATA")})]})]});kanban.appendChild(e);if(t==0){kanban.classList.add("crm-kanban-empty-mode")}else{kanban.classList.remove("crm-kanban-empty-mode")}},loadData:function(t){if(BX.type.isArray(t.columns)){t.columns.forEach(function(t){if(t.type==="LOOSE"){this.addDrop(t)}else{this.addColumn(t,true)}},this)}if(BX.type.isArray(t.items)){this.setEmptyMode(t.items.length);t.items.forEach(function(t){this.addItem(t)},this)}if(t.events){for(var e in t.events){if(t.events.hasOwnProperty(e)){BX.addCustomEvent(this,e,t.events[e])}}}}}}if(typeof BX.CrmKanbanDrop==="undefined"){BX.CrmKanbanDrop=function(t){this.id=t.id;this.name=t.name;this.color=t.color;this.kanban=null;this.scrollLeft=null;this.scrollRight=null;this.layout={container:null}};BX.CrmKanbanDrop.prototype={render:function(){var t=BX.create("div",{attrs:{className:"crm-kanban-dropzone-item","data-type":"drop","data-id":this.id},children:[BX.create("div",{attrs:{className:"crm-kanban-dropzone-item-title"},html:this.name}),BX.create("div",{attrs:{className:"crm-kanban-item-remove"}}),BX.create("div",{attrs:{className:"crm-kanban-dropzone-item-bg",style:"background: #"+this.color}})]});this.scrollRight=BX.create("div",{attrs:{className:"crm-kanban-scroll-right","data-role":"scroll-right","data-type":"scroll"}});this.scrollLeft=BX.create("div",{attrs:{className:"crm-kanban-scroll-left","data-role":"scroll-left","data-type":"scroll"}});var e=document.querySelector(".bx-layout-table");this.kanban.container.appendChild(this.scrollLeft);this.kanban.container.appendChild(this.scrollRight);this.kanban.dragger.registerScrollLeft(this.scrollLeft);this.kanban.dragger.registerScrollRight(this.scrollRight);this.kanban.dragger.registerDrop(t);if(e){this.kanban.dragger.registerBody(e)}return t}}}if(typeof BX.CrmKanbanColumn==="undefined"){BX.CrmKanbanColumn=function(t){this.id=t.id;this.name=t.name;this.color=t.color;this.sort=t.sort;this.count=t.count;this.total=t.total;this.total_format=t.total_format;this.currency=t.currency;this.items=[];this.layout={container:null,items:null,itemsPre:null,title:null,summary:null,total:null,input:null,name:null,color:null,loadMore:null,loadMorePre:null,loadMoreClick:null,scrollTop:null,scrollBottom:null};this.kanban=null;this.page=1;this.lastId=0};BX.CrmKanbanColumn.prototype={addItem:function(t,e){if(!t instanceof BX.CrmKanbanItem){throw"item must be an instance of BX.CrmKanbanItem"}t.columnId=this.id;this.lastId=t.id;BX.CrmKanbanHelper.getInstance().setLastId(t.id);var a=BX.util.array_search(e,this.items);if(a>=0){this.items.splice(a,0,t)}else{this.items.push(t)}if(this.layout.container){this.render()}},removeItem:function(t){this.items=this.items.filter(function(e){return e!==t});if(this.layout.container){this.render()}},setName:function(t){this.name=t},loadMoreClick:function(){this.page++;BX.CrmKanbanHelper.getInstance().loadPage(this.id,this.page);this.layout.loadMore.classList.add("crm-kanban-loadmore-show")},createLayout:function(){this.layout.loadMore=BX.create("div",{attrs:{className:"crm-kanban-loadmore"},children:[this.layout.loadMorePre=BX.create("div",{attrs:{className:"crm-kanban-loadmore-pre"}}),BX.create("div",{attrs:{className:"crm-kanban-user-loader"},html:'<div class="crm-kanban-user-loader-item">'+'<div class="crm-kanban-loader">'+'<svg class="crm-kanban-circular" viewBox="25 25 50 50">'+'<circle class="crm-kanban-path" cx="50" cy="50" r="20" fill="none" stroke-width="1" stroke-miterlimit="10"/>'+"</svg>"+"</div>"+"</div>"})]});if(this.layout.container!==null){return this.layout.container}var t="crm-kanban-header crm-kanban-header-lead";BX.CrmKanbanHelper.getInstance().getEntityType()!=="LEAD"?t="crm-kanban-header":null;var e="crm-kanban-step-title";function a(t){var a=parseInt(t,16);var n=a>>16&255;var i=a>>8&255;var o=a&255;var r=.21*n+.72*i+.07*o;if(r<145){e="crm-kanban-step-title crm-kanban-step-title-dark"}}if(this.color){a(this.color)}this.layout.container=BX.create("div",{attrs:{className:"crm-kanban-grid-item"},children:[this.layout.scrollTop=BX.create("div",{attrs:{className:"crm-kanban-items-scroll-top","data-role":"scroll-top","data-type":"scroll","data-column-id":this.id},events:{mouseenter:function(){BX.CrmKanbanDragDrop.prototype.startScrollUp(this.layout.items)}.bind(this),mouseleave:function(){BX.CrmKanbanDragDrop.prototype.stopScroll()}}}),this.layout.scrollBottom=BX.create("div",{attrs:{className:"crm-kanban-items-scroll-bottom","data-role":"scroll-bottom","data-type":"scroll","data-column-id":this.id},events:{mouseenter:function(){BX.CrmKanbanDragDrop.prototype.startScrollDown(this.layout.items)}.bind(this),mouseleave:function(){BX.CrmKanbanDragDrop.prototype.stopScroll()}}}),BX.create("div",{attrs:{className:t},children:[BX.create("div",{attrs:{className:e},children:[this.layout.color=BX.create("div",{attrs:{className:"crm-kanban-step-title-bg",style:"background: #"+this.color}}),this.layout.name=BX.create("span",{attrs:{className:"crm-kanban-step-title-name"}}),this.layout.total=BX.create("span",{attrs:{className:"crm-kanban-step-title-total"}}),BX.CrmKanbanHelper.getInstance().getSettings("access_config_perms")?BX.create("a",{attrs:{href:BX.CrmKanbanHelper.getInstance().getSettings("path_column_edit"),className:"crm-kanban-step-title-edit"}}):null,this.color==""?BX.create("span",{attrs:{className:"crm-kanban-step-title-right"}}):BX.create("span",{attrs:{className:"crm-kanban-step-title-right",style:"background: #fff url(data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2213%22%20height%3D%2232%22%20viewBox%3D%220%200%2013%2032%22%3E%3Cpath%20fill%3D%22%23"+this.color+"%22%20fill-opacity%3D%221%22%20d%3D%22M0%200h3c2.8%200%204%203%204%203l6%2013-6%2013s-1.06%203-4%203H0V0z%22/%3E%3C/svg%3E) no-repeat"}})]}),BX.CrmKanbanHelper.getInstance().getEntityType()!=="LEAD"?BX.create("div",{attrs:{className:"crm-kanban-total-price"},children:[this.layout.summary=BX.create("span",{attrs:{className:"crm-kanban-total-price-total"}})]}):BX.create("div",{attrs:{className:"crm-kanban-total-price crm-kanban-total-price-off"},children:[this.layout.summary=BX.create("span",{attrs:{className:"crm-kanban-total-price-total"}})]})]}),this.layout.items=BX.create("div",{attrs:{className:"crm-kanban-items","data-id":this.id,"data-move-column":this.id,"data-type":"column"},events:{scroll:function(){this.showScrollGradient()}.bind(this)},children:[this.layout.itemsPre=BX.create("div",{attrs:{className:"crm-kanban-items-preitem"}})]})]});this.kanban.dragger.registerColumn(this.layout.items);this.kanban.dragger.registerScrollTop(this.layout.scrollTop);this.kanban.dragger.registerScrollBottom(this.layout.scrollBottom);BX.bind(this.layout.items,"mousewheel",this.blockedScroll);return this.layout.container},blockedScroll:function(t){if(this.scrollHeight>this.offsetHeight){var e=t.deltaY||t.detail||t.wheelDelta;if(e<0&&this.scrollTop==0){t.preventDefault()}if(e>0&&this.scrollHeight-this.clientHeight-this.scrollTop<=1){t.preventDefault()}}},showScrollGradient:function(){if(this.layout.items.scrollHeight>this.layout.items.offsetHeight+this.layout.items.scrollTop){this.layout.container.classList.add("crm-kanban-grid-item-scroll-bottom")}else if(this.layout.container.classList.contains("crm-kanban-grid-item-scroll-bottom")){this.loadMoreClick();this.layout.container.classList.remove("crm-kanban-grid-item-scroll-bottom")}if(this.layout.items.scrollTop>0){this.layout.container.classList.add("crm-kanban-grid-item-scroll-top")}else if(this.layout.items.scrollTop<=0){this.layout.container.classList.remove("crm-kanban-grid-item-scroll-top")}},render:function(){var t=true;var e=true;if(this.layout.container===null){this.createLayout()}this.layout.container.style.maxWidth=this.kanban.container.offsetWidth/2+"px";BX.cleanNode(this.layout.items);for(var a=0;a<this.items.length;a++){var n=this.items[a];if(this.id===n.columnId){e=false;if(n.page===n.pageCount){t=false}}this.layout.items.appendChild(n.render())}this.layout.name.innerHTML=this.name;this.layout.items.appendChild(this.layout.itemsPre);setTimeout(this.showScrollGradient.bind(this),200);return this.layout.container}}}if(typeof BX.CrmKanbanItem==="undefined"){BX.CrmKanbanItem=function(t){this.id=t.id;this.name=t.name;this.link=t.link;this.price=t.price;this.price_formatted=t.price_formatted;this.date=t.date;this.im=t.im;this.activityProgress=t.activityProgress;this.activityTotal=t.activityTotal;this.activityShow=t.activityShow;this.contactName=t.contactName;this.contactLink=t.contactLink;this.contactId=t.contactId;this.contactType=t.contactType;this.mail=t.email;this.phone=t.phone;this.columnId=t.columnId;this.columnColor=t.columnColor;this.page=t.page;this.pageCount=t.pageCount;this.fields=t.fields;this.layout={container:null,containerPre:null,title:null,items:null,popup:null};this.popupTooltip=null;this.kanban=null;this.helper=BX.CrmKanbanHelper.getInstance();this.entityType=this.helper.getEntityType();this.moreFields=this.helper.getMoreFields();this.activityShow=this.helper.getSettings("show_activity")};BX.CrmKanbanItem.prototype={clickChat:function(){BXIM.openMessengerSlider(this.im.value,{RECENT:"N",MENU:"N"})},clickContact:function(t){var e=t==="mail"?this.mail:this.phone;if(e.length>1){var a=BX.findParent(BX.proxy_context,{className:"crm-kanban-deal-item"}).getAttribute("data-id");var n=[];this.layout.container.classList.add("crm-kanban-deal-item-active");document.body.addEventListener("click",BX.proxy(this.onBodyClick,this),true);for(var i=0;i<e.length;i++){if(t==="mail"){n.push({text:e[i]["value"]+" ("+e[i]["title"]+")",href:"mailto:"+e[i]["value"]})}else{n.push({phone:e[i]["value"],text:e[i]["value"]+" ("+e[i]["title"]+")",onclick:BX.proxy(this.clickPhoneCall,this)})}}BX.PopupMenu.show("kanban-contact-"+t+"-"+a,BX.proxy_context,n,{autoHide:true,zIndex:1200,offsetLeft:20,angle:true,closeByEsc:true})}else{var i=0;if(t==="mail"){}else{this.clickPhoneCall(i,{phone:e[i]["value"]})}}},onBodyClick:function(){var t=document.body.querySelector(".crm-kanban-deal-item-active");t.classList.remove("crm-kanban-deal-item-active");document.body.removeEventListener("click",BX.proxy(this.onBodyClick,this),true)},clickMail:function(){this.clickContact("mail")},clickPhone:function(){this.clickContact("phone")},clickPhoneCall:function(t,e){if(typeof BXIM!=="undefined"){BXIM.phoneTo(e.phone,{ENTITY_TYPE:this.contactType,ENTITY_ID:this.contactId})}},addField:function(){var t=BX.findParent(BX.proxy_context,{className:"crm-kanban-deal-item"}).getAttribute("data-id");var e=[];for(var a=0;a<this.moreFields.length;a++){e.push({code:this.moreFields[a]["code"],text:this.moreFields[a]["title"],onclick:BX.proxy(this.addFieldClick,this)})}BX.PopupMenu.show("kanban-more-fields-"+t,BX.proxy_context,e)},addFieldClick:function(t,e){var a=top.location.href;top.location.href=a+(a.indexOf("?")===-1?"?":"&")+"set_field="+e.code},delField:function(){var t=top.location.href;t=t+(t.indexOf("?")===-1?"?":"&")+"del_field="+BX.proxy_context.getAttribute("data-code");top.location.href=t},fixedItemPosition:function(t){t.layout.container.classList.add("crm-kanban-deal-item-show")},activityClick:function(){this.fixedItemPosition(this);BX.CrmKanbanHelper.getInstance().openActivityItems(this.id)},activityPlanClick:function(){this.fixedItemPosition(this);var t=BX.findParent(BX.proxy_context,{className:"crm-kanban-deal-item"}).getAttribute("data-id");var e=[{type:"call",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_CALL"),onclick:BX.proxy(this.activityPlanClickItem,this)},{type:"meeting",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_MEETING"),onclick:BX.proxy(this.activityPlanClickItem,this)},{type:"task",text:BX.message("CRM_KANBAN_ACTIVITY_PLAN_TASK"),onclick:BX.proxy(this.activityPlanClickItem,this)}];BX.PopupMenu.show("kanban-plan-"+t,BX.proxy_context,e,{autoHide:true,offsetLeft:20,angle:true,overlay:false})},activityPlanClickItem:function(t,e){if(e.type==="meeting"||e.type==="call"){(new BX.Crm.Activity.Planner).showEdit({TYPE_ID:BX.CrmActivityType[e.type],OWNER_TYPE:this.entityType,OWNER_ID:this.id})}else if(e.type==="task"){if(typeof window["taskIFramePopup"]!=="undefined"){var a={UF_CRM_TASK:[BX.CrmOwnerTypeAbbr.resolve(this.entityType)+"_"+this.id],TITLE:"CRM: ",TAGS:"crm"};window["taskIFramePopup"].add(a)}}},renderFields:function(){var t=[];for(var e=0;e<this.fields.length;e++){t.push(BX.create("div",{attrs:{},children:[BX.create("span",{attrs:{className:"crm-kanban-deal-item-field"},html:this.fields[e]["title"]+": "+this.fields[e]["value"]}),BX.create("span",{attrs:{className:"crm-kanban-deal-item-field-del","data-code":this.fields[e]["code"]},html:"*",events:{click:BX.proxy(this.delField,this)}})]}))}return t},render:function(){if(this.layout.container===null){this.layout.container=BX.create("div",{attrs:{className:"crm-kanban-deal-item","data-id":this.id,"data-move":this.id,"data-type":"item"},children:[this.layout.containerPre=BX.create("div",{attrs:{className:"crm-kanban-deal-item-wrapper-pre"}}),BX.create("div",{attrs:{className:"crm-kanban-deal-item-wrapper"},children:[BX.create("div",{attrs:{className:"crm-kanban-deal-item-wrapper-border","data-role":"item-color",style:"background: #"+this.columnColor}}),BX.create("a",{attrs:{className:"crm-kanban-deal-item-title",href:this.link,title:BX.util.htmlspecialcharsback(this.name)},html:this.name}),BX.CrmKanbanHelper.getInstance().getEntityType()!=="LEAD"?BX.create("div",{attrs:{className:"crm-kanban-deal-item-total"},children:[BX.create("div",{attrs:{className:"crm-kanban-deal-item-total-price"},html:this.price_formatted})]}):null,BX.create("a",{attrs:{className:"crm-kanban-deal-item-user",href:this.contactLink},html:this.contactName}),BX.create("div",{attrs:{className:"crm-kanban-deal-item-date"},html:this.date}),BX.create("div",{attrs:{className:"crm-kanban-deal-item-planner"},children:[this.activityShow?BX.create("span",{attrs:{className:"crm-kanban-deal-item-activity",id:"crm-kanban-act-count-"+this.id,"parent-id":this.id,"data-count":this.activityProgress,style:this.activityProgress>0?"display: block":"display: none;"},text:BX.message("CRM_KANBAN_ACTIVITY_PLAN")+": "+this.activityProgress,events:{click:BX.proxy(this.activityClick,this)}}):null,this.activityShow?BX.create("div",{attrs:{className:"crm-kanban-deal-item-activity-empty",id:"crm-kanban-act-icon-"+this.id,"parent-id":this.id,style:this.activityProgress>0?"display: none":"display: block;"},events:{mouseover:function(){this.popupTooltip=new BX.PopupWindow("kanban_plan_tooltip",this,{className:"crm-kanban-withiot-tooltip",offsetLeft:14,darkMode:true,closeByEsc:true,angle:true,autoHide:true,content:BX.message("CRM_KANBAN_ACTIVITY_LETSGO")});this.popupTooltip.show()},mouseout:function(){this.popupTooltip.destroy()}}}):null,this.activityShow?BX.create("span",{attrs:{className:"crm-kanban-deal-item-plan","parent-id":this.id},text:BX.message("CRM_KANBAN_ACTIVITY_MY"),events:{click:BX.proxy(this.activityPlanClick,this)}}):null]}),BX.create("div",{attrs:{className:"crm-kanban-deal-item-contact"},children:[BX.create("a",{attrs:{className:this.phone?"crm-kanban-step-contact-phone":"crm-kanban-step-contact-phone crm-kanban-step-contact-phone-disabled",href:"javascript:void(0)"},events:{click:this.phone?BX.proxy(this.clickPhone,this):null,mouseover:this.phone?null:function(){this.popupTooltip=new BX.PopupWindow("kanban_plan_tooltip",this,{className:"crm-kanban-withiot-tooltip",offsetLeft:16,offsetTop:-4,darkMode:true,closeByEsc:true,angle:true,autoHide:true,content:BX.message("CRM_KANBAN_NO_PHONE")});this.popupTooltip.show()},mouseout:this.phone?null:function(){this.popupTooltip.destroy()}}}),BX.create("a",{attrs:{className:this.mail?"crm-kanban-step-contact-mail":"crm-kanban-step-contact-mail crm-kanban-step-contact-mail-disabled",href:!this.mail||this.mail.length>1?"javascript:void(0)":"mailto:"+this.mail[0]["value"]},events:{click:this.mail?BX.proxy(this.clickMail,this):null,mouseover:this.mail?null:function(){this.popupTooltip=new BX.PopupWindow("kanban_plan_tooltip",this,{className:"crm-kanban-withiot-tooltip",offsetLeft:16,offsetTop:-4,darkMode:true,closeByEsc:true,angle:true,autoHide:true,content:BX.message("CRM_KANBAN_NO_EMAIL")});this.popupTooltip.show()},mouseout:this.mail?null:function(){this.popupTooltip.destroy()}}}),BX.create("span",{attrs:{className:this.im?"crm-kanban-step-contact-message":"crm-kanban-step-contact-message crm-kanban-step-contact-message-disabled"},events:{click:this.im?BX.proxy(this.clickChat,this):null,mouseover:this.im?null:function(){this.popupTooltip=new BX.PopupWindow("kanban_plan_tooltip",this,{className:"crm-kanban-withiot-tooltip",offsetLeft:16,offsetTop:-4,darkMode:true,closeByEsc:true,angle:true,autoHide:true,content:BX.message("CRM_KANBAN_NO_IMOL")});this.popupTooltip.show()},mouseout:this.im?null:function(){this.popupTooltip.destroy()}}})]})]})]});this.kanban.dragger.registerItem(this.layout.container)}return this.layout.container}};BX.CrmKanbanItem.changeActCount=function(t,e){var a=Math.max(0,parseInt(BX.data(BX("crm-kanban-act-count-"+t),"count"))+parseInt(e)*1);BX.data(BX("crm-kanban-act-count-"+t),"count",a);BX("crm-kanban-act-count-"+t).innerText=BX.message("CRM_KANBAN_ACTIVITY_PLAN")+": "+a;if(a>0){BX.show(BX("crm-kanban-act-count-"+t));BX.hide(BX("crm-kanban-act-icon-"+t))}else{BX.hide(BX("crm-kanban-act-count-"+t));BX.show(BX("crm-kanban-act-icon-"+t))}}}if(typeof BX.CrmKanbanDragDrop==="undefined"){BX.CrmKanbanDragDrop=function(t){this.kanban=t;this.draggableItem=null;this.droppableColumn=null;this.stub=null;this.droppableZone=null;this.dropContainer=null;this.preDraggableItem=null;this.scrollZone=null;this.timer=null;this.body=null;this.timeoutId=null};BX.CrmKanbanDragDrop.prototype.registerItem=function(t){t.onbxdragstart=BX.proxy(this.onDragStart,this);t.onbxdrag=BX.proxy(this.onDrag,this);t.onbxdragstop=BX.proxy(this.onDragStop,this);t.onbxdraghover=BX.proxy(this.onDragOver,this);jsDD.registerObject(t);jsDD.registerDest(t,30)};BX.CrmKanbanDragDrop.prototype.registerDrop=function(t){jsDD.registerDest(t,10)};BX.CrmKanbanDragDrop.prototype.registerColumn=function(t){jsDD.registerDest(t,40)};BX.CrmKanbanDragDrop.prototype.registerScrollTop=function(t){jsDD.registerDest(t,20)};BX.CrmKanbanDragDrop.prototype.registerScrollBottom=function(t){jsDD.registerDest(t,20)};BX.CrmKanbanDragDrop.prototype.registerScrollLeft=function(t){jsDD.registerDest(t,20)};BX.CrmKanbanDragDrop.prototype.registerScrollRight=function(t){jsDD.registerDest(t,20)};BX.CrmKanbanDragDrop.prototype.registerBody=function(t){jsDD.registerDest(t,60)};BX.CrmKanbanDragDrop.prototype.onDragStart=function(){BX.CrmKanbanGrid.prototype.resize();this.dropContainer=document.querySelector(".crm-kanban-dropzone");this.dropContainer.classList.remove("crm-kanban-dropzone-pre");this.dropContainer.classList.add("crm-kanban-dropzone-show");var t=BX.proxy_context;var e=BX.type.isDomNode(t)?t.getAttribute("data-id"):null;this.draggableItem=this.kanban.getItem(e);this.preDraggableItem=this.kanban.getItem(this.draggableItem.layout.container.nextSibling.dataset.id);this.draggableItem.layout.container.classList.add("crm-kanban-deal-item-block");if(!this.draggableItem){jsDD.stopCurrentDrag();return}if(!this.stub){var a=this.draggableItem.layout.container.offsetWidth;var n=this.draggableItem.layout.container.offsetHeight;this.stub=this.draggableItem.layout.container.cloneNode(true);this.stub.dataset.column=this.draggableItem.columnId;this.stub.dataset.pre=this.draggableItem.layout.container.nextElementSibling.dataset.id;this.stub.dataset.drag="drag";this.stub.style.position="absolute";this.stub.style.width=a+"px";this.stub.style.height=n+"px";this.stub.className="crm-kanban-deal-item crm-kanban-deal-item-drag";document.body.appendChild(this.stub)}};BX.CrmKanbanDragDrop.prototype.onDrag=function(t,e){this.stub.style.left=t+"px";this.stub.style.top=e+"px"};BX.CrmKanbanDragDrop.prototype.onDragOver=function(t,e,a){setTimeout(function(){var t=this.kanban.container.querySelectorAll(".crm-kanban-loadmore-pre");for(var e=0;e<t.length;e++){t[e].style.height=""}}.bind(this),0);if(this.droppableItem){this.droppableItem.layout.container.classList.remove("crm-kanban-deal-item-pre");this.droppableItem.layout.containerPre.style.height=""}if(this.droppableColumn){this.droppableColumn.layout.itemsPre.style.height=this.stub.offsetHeight+"px";if(this.droppableColumn.layout.container.classList.contains("crm-kanban-grid-item-scroll-bottom")&&this.droppableColumn.layout.container.classList.contains("crm-kanban-grid-item-scroll-top")){this.droppableColumn.layout.container.className="crm-kanban-grid-item crm-kanban-grid-item-scroll-bottom crm-kanban-grid-item-scroll-top"}else if(this.droppableColumn.layout.container.classList.contains("crm-kanban-grid-item-scroll-top")){this.droppableColumn.layout.container.className="crm-kanban-grid-item crm-kanban-grid-item-scroll-top"}else if(this.droppableColumn.layout.container.classList.contains("crm-kanban-grid-item-scroll-bottom")){this.droppableColumn.layout.container.className="crm-kanban-grid-item crm-kanban-grid-item-scroll-bottom"}else{this.droppableColumn.layout.container.className="crm-kanban-grid-item";this.droppableColumn.layout.itemsPre.style.height=""}}if(this.droppableZone){this.droppableZone.parentNode.className="crm-kanban-dropzone crm-kanban-dropzone-show";this.droppableZone.className="crm-kanban-dropzone-item"}if(this.scrollZone){this.scrollZone.classList.remove("crm-kanban-items-scroll-show")}var n=t.getAttribute("data-id");var i=t.getAttribute("data-type");var o=t.tagName;if(o!=="DIV"){this.body=t;this.droppableItem=this.kanban.getItem(n);this.droppableColumn=null;this.droppableZone=null;this.scrollZone=null;this.stopScroll()}if(i==="item"){this.droppableItem=this.kanban.getItem(n);this.droppableColumn=null;this.droppableZone=null;this.scrollZone=null;this.stopScroll()}else if(i==="column"){this.droppableColumn=this.kanban.getColumn(n);this.droppableItem=null;this.droppableZone=null;this.scrollZone=null;this.stopScroll()}else if(i==="drop"){this.droppableZone=t;this.droppableColumn=null;this.droppableItem=null;this.scrollZone=null;this.stopScroll();this.droppableZone.parentNode.classList.add("crm-kanban-dropzone-pre")}else if(i==="scroll"){this.stopScroll();this.scrollZone=t;var r=t.dataset.role;var s=t.dataset.columnId;this.scrollZone.classList.add("crm-kanban-items-scroll-show");this.droppableColumn=this.kanban.getColumn(s);if(r==="scroll-top"){this.startScrollUp(this.droppableColumn.layout.items)}else if(r==="scroll-bottom"){this.startScrollDown(this.droppableColumn.layout.items)}else if(r==="scroll-left"){this.startScrollLeft()}else if(r==="scroll-right"){this.startScrollRight()}this.droppableItem=null;this.droppableZone=null}if(this.droppableItem){this.droppableItem.layout.container.classList.add("crm-kanban-deal-item-pre");this.droppableItem.layout.containerPre.style.height=this.stub.style.height}if(this.droppableZone){this.droppableZone.className="crm-kanban-dropzone-item crm-kanban-dropzone-item-pre"}if(this.droppableColumn){var l="crm-kanban-grid-item-pre";if(this.droppableColumn.layout.loadMore.parentNode==null){l="crm-kanban-grid-item-column-pre";this.droppableColumn.layout.itemsPre.style.height=this.stub.style.height}this.droppableColumn.layout.loadMorePre.style.height=this.stub.style.height;this.droppableColumn.layout.container.classList.add(l)}};BX.CrmKanbanDragDrop.prototype.stopScroll=function(){clearInterval(this.timer)};BX.CrmKanbanDragDrop.prototype.startScrollDown=function(t){this.timer=setInterval(function(){t.scrollTop+=10;jsDD.refreshDestArea()},20)};BX.CrmKanbanDragDrop.prototype.startScrollUp=function(t){this.timer=setInterval(function(){jsDD.refreshDestArea();t.scrollTop-=10;jsDD.refreshDestArea()},20)};BX.CrmKanbanDragDrop.prototype.startScrollLeft=function(){var t=this.kanban.container.lastChild;this.timer=setInterval(function(){t.scrollLeft-=10;jsDD.refreshDestArea()},10)};BX.CrmKanbanDragDrop.prototype.startScrollRight=function(){var t=this.kanban.container.lastChild;this.timer=setInterval(function(){t.scrollLeft+=10;jsDD.refreshDestArea()},10)};BX.CrmKanbanDragDrop.prototype.invoicePopupInstance=null;BX.CrmKanbanDragDrop.prototype.invoicePopup=function(t,e,a){if(this.invoicePopupInstance===null){this.invoicePopupInstance=new BX.PopupWindow("kanban_invoice",window.body,{offsetLeft:0,lightShadow:true,overlay:true,titleBar:{content:BX.create("span",{html:""})},draggable:true,contentColor:"white",content:BX.create("div",{attrs:{className:"crm-kanban-popup-wrapper"},children:[BX.create("table",{attrs:{className:"crm-kanban-popup-table"},children:[BX.create("tr",{children:[BX.create("td",{children:[BX.create("SPAN",{attrs:{className:"crm-kanban-popup-text"},text:BX.message("CRM_KANBAN_INVOICE_PARAMS_DATE")})]}),BX.create("td",{children:[BX.create("INPUT",{attrs:{id:"crm-kanban-droppopup-date",className:"crm-kanban-popup-input"},events:{click:function(){BX.calendar({node:this,field:this})}}})]})]}),BX.create("tr",{attrs:{id:"crm-kanban-droppopup-winblock"},children:[BX.create("td",{children:[BX.create("SPAN",{attrs:{className:"crm-kanban-popup-text"},text:BX.message("CRM_KANBAN_INVOICE_PARAMS_DOCNUM")})]}),BX.create("td",{children:[BX.create("INPUT",{attrs:{id:"crm-kanban-droppopup-docnum",className:"crm-kanban-popup-input"}})]})]}),BX.create("tr",{children:[BX.create("td",{attrs:{colspan:"2",className:"crm-kanban-popup-border"},children:[BX.create("SPAN",{attrs:{className:"crm-kanban-popup-text"},text:BX.message("CRM_KANBAN_INVOICE_PARAMS_COMMENT")}),BX.create("TEXTAREA",{attrs:{id:"crm-kanban-droppopup-comment",className:"crm-kanban-popup-textarea"}}),BX.create("INPUT",{attrs:{type:"hidden",id:"crm-kanban-droppopup-id"}}),BX.create("INPUT",{attrs:{type:"hidden",id:"crm-kanban-droppopup-status"}}),BX.create("INPUT",{attrs:{type:"hidden",id:"crm-kanban-droppopup-oldstatus"}})]})]})]})]}),buttons:[new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_INVOICE_PARAMS_SAVE"),className:"popup-window-button-accept",events:{click:function(){BX.CrmKanbanHelper.getInstance().moveState(BX("crm-kanban-droppopup-id").value,BX("crm-kanban-droppopup-status").value,BX("crm-kanban-droppopup-oldstatus").value,{comment:BX("crm-kanban-droppopup-comment").value,date:BX("crm-kanban-droppopup-date").value,docnum:BX("crm-kanban-droppopup-docnum").value});this.popupWindow.close()}}})]});this.invoicePopupInstance.setTitleBar(BX.message("CRM_KANBAN_INVOICE_PARAMS"))}BX("crm-kanban-droppopup-comment").value="";BX("crm-kanban-droppopup-date").value=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATE")));BX("crm-kanban-droppopup-docnum").value="";BX("crm-kanban-droppopup-id").value=t;BX("crm-kanban-droppopup-status").value=e;BX("crm-kanban-droppopup-oldstatus").value=a;if(e==="P"){BX.show(BX("crm-kanban-droppopup-winblock"))}else{BX.hide(BX("crm-kanban-droppopup-winblock"))}this.invoicePopupInstance.show()};BX.CrmKanbanDragDrop.prototype.convertId=null;BX.CrmKanbanDragDrop.prototype.convertPopupInstance=null;BX.CrmKanbanDragDrop.prototype.convertPopup=function(t){this.convertPopupInstance=null;BX.CrmKanbanDragDrop.prototype.convertId=t;if(this.convertPopupInstance===null){var e=[];for(var a in BX.CrmLeadConversionScheme.messages){e.push(BX.create("DIV",{attrs:{"data-type":a},text:BX.CrmLeadConversionScheme.messages[a],events:{click:BX.proxy(this.convertPopupClick,this)}}))}e.push(BX.create("div",{attrs:{"data-type":"SELECT"},text:BX.message("CRM_KANBAN_CONVERT_SELECT_ENTITY"),events:{click:BX.proxy(this.convertPopupClick,this)}}));this.convertPopupInstance=new BX.PopupWindow("kanban_convert",window,{className:"crm-kanban-popup-convert",offsetLeft:-50,lightShadow:true,closeIcon:false,overlay:true,titleBar:{content:BX.create("span",{html:""})},draggable:true,closeByEsc:false,content:BX.create("div",{attrs:{className:"crm-kanban-popup-convert-list"},children:e})});var n=this.stub;var i=BX.create("div",{attrs:{className:"crm-kanban-popup-convert-button"},children:[BX.create("input",{attrs:{className:"webform-small-button webform-small-button-cancel",type:"submit",value:BX.message("CRM_KANBAN_FAIL_CONFIRM_CANCEL")},events:{click:function(){this.convertPopupInstance.close();this.kanban.moveItemToColum(this.kanban.getItem(n.dataset.id),this.kanban.getColumn(n.dataset.column),this.kanban.getItem(n.dataset.pre))}.bind(this)}})]});var o=this.convertPopupInstance.contentContainer.parentNode;o.appendChild(i);this.convertPopupInstance.setTitleBar(BX.message("CRM_KANBAN_CONVERT_POPUP_TITLE"))}this.convertPopupInstance.show()};BX.CrmKanbanDragDrop.prototype.convertPopupClick=function(){var t=BX.proxy_context.getAttribute("data-type");var e=this.convertId;if(t==="SELECT"){BX.CrmLeadConverter.getCurrent().openEntitySelector(function(t){BX.CrmLeadConverter.getCurrent().convert(e,t.config,"",t.data)})}else{BX.CrmLeadConverter.getCurrent().convert(e,BX.CrmLeadConversionScheme.createConfig(t),"")}this.convertPopupInstance.close()};BX.CrmKanbanDragDrop.prototype.onDragStop=function(t,e,a){this.stopScroll();this.draggableItem.layout.container.classList.remove("crm-kanban-deal-item-block");var n=this.draggableItem.columnId;document.body.style.height="";document.body.style.overflow="";document.body.style.width="";var i=new BX.PopupWindow("kanban_stop_drag",window,{className:"crm-kanban-popup-convert",closeIcon:true,closeByEsc:true,autoHide:true,content:BX.message("CRM_KANBAN_ERROR_DISABLE_CONVERTED_LEAD"),overlay:false});if(this.draggableItem){if(this.droppableZone){if(this.draggableItem.columnId=="CONVERTED"){var o=this.kanban.getColumn(this.draggableItem.columnId);this.kanban.moveItemToColum(this.draggableItem,o,this.preDraggableItem);this.dropContainer.className="crm-kanban-dropzone";this.droppableZone.className="crm-kanban-dropzone-item";i.show();setTimeout(function(){i.close()},5e3)}else{var r=this.droppableZone.dataset.item;this.droppableZone.className="crm-kanban-dropzone-item";this.droppableZone.setAttribute("data-item",this.draggableItem.id);var s=this.droppableZone.getAttribute("data-id");var l=this.droppableZone;var c=this.draggableItem;var m=this.droppableZone.querySelector(".crm-kanban-item-remove");var d=this.draggableItem.layout.container;BX.cleanNode(m);this.dropContainer.className="crm-kanban-dropzone crm-kanban-dropzone-show";this.droppableZone.className="crm-kanban-dropzone-item crm-kanban-dropzone-item-pre";var p=function(t,e,a){if(t.dataset.item){h(+t.dataset.item,e,a,t,c.id)}clearTimeout(this.timeoutId)}.bind(this);var h=function(t,e,a,n){var i=document.querySelector('[data-move="'+t+'"]');if(i.classList.contains("crm-kanban-deal-item-deleted")){if(BX.CrmKanbanHelper.getInstance().getEntityType()==="INVOICE"&&(a==="P"||n)&&e!=a){this.invoicePopup(t,a,e)}else{BX.CrmKanbanHelper.getInstance().moveState(t,a,e)}if(BX.CrmKanbanHelper.getInstance().getEntityType()==="LEAD"&&a==="CONVERTED"&&e!=a){this.convertPopup(t)}}}.bind(this);var u=function(t,e,a,n){if(BX.CrmKanbanHelper.getInstance().getEntityType()==="INVOICE"&&(a==="P"||n)&&e!=a){this.invoicePopup(t,a,e)}else{BX.CrmKanbanHelper.getInstance().moveState(t,a,e)}if(BX.CrmKanbanHelper.getInstance().getEntityType()==="LEAD"&&a==="CONVERTED"&&e!=a){this.convertPopup(t)}}.bind(this);var b=BX.create("span",{attrs:{className:"crm-kanban-item-remove-confirm"},events:{click:function(){f(c,m);d.classList.remove("crm-kanban-deal-item-deleted")}.bind(this)},html:BX.message("CRM_KANBAN_FAIL_CONFIRM_CANCEL")});var f=function(t,e){if(t.id===e.parentNode.dataset.item){BX.cleanNode(m);l.className="crm-kanban-dropzone-item"}var a=document.querySelectorAll(".crm-kanban-item-remove-confirm");if(a.length===0){this.dropContainer.classList.remove("crm-kanban-dropzone-show")}}.bind(this);m.appendChild(b);d.classList.add("crm-kanban-deal-item-deleted");var g=this.droppableZone;this.timeoutId=setTimeout(function(){p(g,n,s,c)}.bind(this),8e3);if(r){u(+r,this.kanban.items[+r].columnId,this.droppableZone.dataset.id,this.droppableZone)}setTimeout(function(){f(c,m)},8e3)}}else{this.dropContainer.className="crm-kanban-dropzone";if(this.droppableItem){this.droppableItem.layout.container.style="";this.droppableItem.layout.containerPre.style.height="";this.droppableItem.layout.container.classList.remove("crm-kanban-deal-item-pre");var o=this.kanban.getColumn(this.droppableItem.columnId);var s=this.droppableItem.columnId;this.dropContainer.className="crm-kanban-dropzone";if(this.draggableItem.columnId=="CONVERTED"&&this.droppableItem.columnId!=="CONVERTED"){o=this.kanban.getColumn(this.draggableItem.columnId);this.kanban.moveItemToColum(this.draggableItem,o,this.preDraggableItem);i.show();setTimeout(function(){i.close()},5e3)}else{this.kanban.moveItemToColum(this.draggableItem,o,this.droppableItem)}}else if(this.droppableColumn){var s=this.droppableColumn.id;this.droppableColumn.layout.container.className="crm-kanban-grid-item";this.droppableColumn.layout.itemsPre.style.height="";this.dropContainer.className="crm-kanban-dropzone";if(this.draggableItem.columnId=="CONVERTED"&&this.droppableColumn.id!=="CONVERTED"){o=this.kanban.getColumn(this.draggableItem.columnId);this.kanban.moveItemToColum(this.draggableItem,o,this.preDraggableItem);i.show();setTimeout(function(){i.close()},5e3)}else{this.kanban.moveItemToColum(this.draggableItem,this.droppableColumn)}}if(BX.CrmKanbanHelper.getInstance().getEntityType()==="INVOICE"&&(s==="P"||this.droppableZone)&&n!=s){this.invoicePopup(this.draggableItem.id,s,n)}else{BX.CrmKanbanHelper.getInstance().moveState(this.draggableItem.id,s,n)}if(BX.CrmKanbanHelper.getInstance().getEntityType()==="LEAD"&&s==="CONVERTED"&&n!=s){this.convertPopup(this.draggableItem.id)}}}setTimeout(function(){var t=this.kanban.container.querySelectorAll(".crm-kanban-loadmore-pre");for(var e=0;e<t.length;e++){t[e].style.height=""}}.bind(this),50);this.stub.parentNode.removeChild(this.stub);this.stub=null;this.draggableItem=null;this.droppableColumn=null;this.droppableItem=null;this.droppableZone=null;this.scrollZone=null;this.timer=null}}