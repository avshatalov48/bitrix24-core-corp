{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { ajax as Ajax, Loc, Reflection, Text, Type } from \"main.core\";\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { MessageBox, MessageBoxButtons } from \"ui.dialogs.messagebox\";\nimport { Router } from \"crm.router\";\n\nconst namespace = Reflection.namespace('BX.Crm');\n\nclass ItemListComponent\n{\n\tentityTypeId: number;\n\tcategoryId: number;\n\tgridId: string;\n\tgrid: BX.Main.grid;\n\terrorTextContainer: Element;\n\tentityTypeName: string;\n\treloadGridTimeoutId: number;\n\n\tconstructor(params): void\n\t{\n\t\tif(Type.isPlainObject(params))\n\t\t{\n\t\t\tthis.entityTypeId = Text.toInteger(params.entityTypeId);\n\t\t\tthis.entityTypeName = params.entityTypeName;\n\t\t\tthis.categoryId = Text.toInteger(params.categoryId);\n\n\t\t\tif (Type.isString(params.gridId))\n\t\t\t{\n\t\t\t\tthis.gridId = params.gridId;\n\t\t\t}\n\t\t\tif(this.gridId && BX.Main.grid && BX.Main.gridManager)\n\t\t\t{\n\t\t\t\tthis.grid = BX.Main.gridManager.getInstanceById(this.gridId);\n\t\t\t\tif (this.grid && params.backendUrl)\n\t\t\t\t{\n\t\t\t\t\tBX.addCustomEvent(window, \"Grid::beforeRequest\", (gridData, requestParams) => {\n\t\t\t\t\t\tif (!gridData.parent || gridData.parent !== this.grid)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\trequestParams.url = params.backendUrl;\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (Type.isElementNode(params.errorTextContainer))\n\t\t\t{\n\t\t\t\tthis.errorTextContainer = params.errorTextContainer;\n\t\t\t}\n\t\t}\n\n\t\tthis.reloadGridTimeoutId = 0;\n\t}\n\n\tinit(): void\n\t{\n\t\tthis.bindEvents();\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('BX.Crm.ItemListComponent:onClickDelete', this.handleItemDelete.bind(this));\n\n\t\tconst toolbarComponent = Reflection.getClass('BX.Crm.ToolbarComponent')\n\t\t\t? Reflection.getClass('BX.Crm.ToolbarComponent').Instance\n\t\t\t: null;\n\n\t\tif (toolbarComponent)\n\t\t{\n\t\t\ttoolbarComponent.subscribeTypeUpdatedEvent(() => {\n\n\t\t\t\tconst newUrl = Router.Instance.getItemListUrl(this.entityTypeId, this.categoryId);\n\t\t\t\tif (newUrl)\n\t\t\t\t{\n\t\t\t\t\twindow.location.href = newUrl;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\twindow.location.reload();\n\t\t\t});\n\t\t\tif (this.grid)\n\t\t\t{\n\t\t\t\ttoolbarComponent.subscribeCategoriesUpdatedEvent(() => {\n\t\t\t\t\tthis.reloadGridAfterTimeout();\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tEventEmitter.subscribe(\"onLocalStorageSet\", (event) => {\n\t\t\tconst parameters = event.data;\n\t\t\tif (!Type.isArray(parameters) || !parameters[0])\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst params = parameters[0];\n\t\t\tconst key = params.key || '';\n\t\t\tif(key !== \"onCrmEntityCreate\" && key !== \"onCrmEntityUpdate\" && key !== \"onCrmEntityDelete\" && key !== \"onCrmEntityConvert\")\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst eventData = params.value;\n\t\t\tif (!Type.isPlainObject(eventData))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (!this.entityTypeName || !eventData.entityTypeName || this.entityTypeName !== eventData.entityTypeName)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.reloadGridAfterTimeout();\n\t\t});\n\t}\n\n\treloadGridAfterTimeout()\n\t{\n\t\tif (!this.grid)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tif (this.reloadGridTimeoutId > 0)\n\t\t{\n\t\t\tclearTimeout(this.reloadGridTimeoutId);\n\t\t\tthis.reloadGridTimeoutId = 0;\n\t\t}\n\n\t\tthis.reloadGridTimeoutId = setTimeout(() => {\n\t\t\tthis.grid.reload();\n\t\t}, 1000);\n\t}\n\n\tshowErrors(errors: []): void\n\t{\n\t\tlet text = '';\n\t\terrors.forEach((message) => {\n\t\t\ttext = text + message + ' ';\n\t\t});\n\n\t\tif (Type.isElementNode(this.errorTextContainer))\n\t\t{\n\t\t\tthis.errorTextContainer.innerText = text;\n\t\t\tthis.errorTextContainer.parentElement.style.display = 'block';\n\t\t}\n\t\telse\n\t\t{\n\t\t\tconsole.error(text);\n\t\t}\n\t}\n\n\thideErrors(): void\n\t{\n\t\tif (Type.isElementNode(this.errorTextContainer))\n\t\t{\n\t\t\tthis.errorTextContainer.innerText = '';\n\t\t\tthis.errorTextContainer.parentElement.style.display = 'none';\n\t\t}\n\t}\n\n\tshowErrorsFromResponse({errors}): void\n\t{\n\t\tconst messages = [];\n\t\terrors.forEach(({message}) => messages.push(message));\n\t\tthis.showErrors(messages);\n\t}\n\n\t// region EventHandlers\n\thandleItemDelete(event: BaseEvent): void\n\t{\n\t\tconst entityTypeId = Text.toInteger(event.data.entityTypeId);\n\t\tconst id = Text.toInteger(event.data.id);\n\n\t\tif (!entityTypeId)\n\t\t{\n\t\t\tthis.showErrors([Loc.getMessage('CRM_TYPE_TYPE_NOT_FOUND')]);\n\t\t\treturn;\n\t\t}\n\t\tif (!id)\n\t\t{\n\t\t\tthis.showErrors([Loc.getMessage('CRM_TYPE_ITEM_NOT_FOUND')]);\n\t\t\treturn;\n\t\t}\n\n\t\tMessageBox.show({\n\t\t\ttitle: Loc.getMessage('CRM_TYPE_ITEM_DELETE_CONFIRMATION_TITLE'),\n\t\t\tmessage: Loc.getMessage('CRM_TYPE_ITEM_DELETE_CONFIRMATION_MESSAGE'),\n\t\t\tmodal: true,\n\t\t\tbuttons: MessageBoxButtons.YES_CANCEL,\n\t\t\tonYes: (messageBox) => {\n\t\t\t\tAjax.runAction(\n\t\t\t\t\t'crm.controller.item.delete', {\n\t\t\t\t\t\tanalyticsLabel: 'crmItemListDeleteItem',\n\t\t\t\t\t\tdata:\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tentityTypeId,\n\t\t\t\t\t\t\t\tid,\n\t\t\t\t\t\t\t}\n\t\t\t\t}).then(() => {\n\t\t\t\t\tthis.reloadGridAfterTimeout();\n\t\t\t\t}).catch(this.showErrorsFromResponse.bind(this));\n\n\t\t\t\tmessageBox.close();\n\t\t\t}\n\t\t});\n\t}\n\t//endregion\n}\n\nnamespace.ItemListComponent = ItemListComponent;\n"],"names":["namespace","Reflection","ItemListComponent","params","Type","isPlainObject","entityTypeId","Text","toInteger","entityTypeName","categoryId","isString","gridId","BX","Main","grid","gridManager","getInstanceById","backendUrl","addCustomEvent","window","gridData","requestParams","parent","url","isElementNode","errorTextContainer","reloadGridTimeoutId","bindEvents","EventEmitter","subscribe","handleItemDelete","bind","toolbarComponent","getClass","Instance","subscribeTypeUpdatedEvent","newUrl","Router","getItemListUrl","location","href","reload","subscribeCategoriesUpdatedEvent","reloadGridAfterTimeout","event","parameters","data","isArray","key","eventData","value","clearTimeout","setTimeout","errors","text","forEach","message","innerText","parentElement","style","display","console","error","messages","push","showErrors","id","Loc","getMessage","MessageBox","show","title","modal","buttons","MessageBoxButtons","YES_CANCEL","onYes","messageBox","Ajax","runAction","analyticsLabel","then","catch","showErrorsFromResponse","close"],"mappings":"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"}