(function(e,t,r,i,n){"use strict";function o(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function a(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?o(Object(r),!0).forEach((function(t){babelHelpers.defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):o(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function s(e,t){c(e,t);t.add(e)}function l(e,t,r){c(e,t);t.set(e,r)}function c(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function d(e,t,r){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return r}var u=t.Reflection.namespace("BX.Crm");var p=new WeakMap;var f=new WeakMap;var m=new WeakMap;var h=new WeakMap;var y=new WeakSet;var v=new WeakSet;var T=function(){function e(r){var i=this;babelHelpers.classCallCheck(this,e);s(this,v);s(this,y);l(this,p,{writable:true,value:false});l(this,f,{writable:true,value:false});l(this,m,{writable:true,value:false});l(this,h,{writable:true,value:false});this.exportPopups={};if(t.Type.isPlainObject(r)){this.entityTypeId=t.Text.toInteger(r.entityTypeId);this.entityTypeName=r.entityTypeName;this.categoryId=t.Text.toInteger(r.categoryId);babelHelpers.classPrivateFieldSet(this,m,t.Text.toBoolean(r.smartActivityNotificationSupported));if(t.Type.isString(r.gridId)){this.gridId=r.gridId}if(this.gridId&&BX.Main.grid&&BX.Main.gridManager){this.grid=BX.Main.gridManager.getInstanceById(this.gridId);if(this.grid&&r.backendUrl){BX.addCustomEvent(window,"Grid::beforeRequest",(function(e,n){if(!e.parent||e.parent!==i.grid){return}var o=new t.Uri(n.url);var s=new t.Uri(r.backendUrl);if(o.getPath()!==s.getPath()){o.setPath(s.getPath());o.setQueryParams(a(a({},o.getQueryParams()),s.getQueryParams()))}n.url=o.toString()}))}}if(t.Type.isElementNode(r.errorTextContainer)){this.errorTextContainer=r.errorTextContainer}if(t.Type.isBoolean(r.isUniversalActivityScenarioEnabled)){babelHelpers.classPrivateFieldSet(this,p,r.isUniversalActivityScenarioEnabled)}if(t.Type.isBoolean(r.isIframe)){babelHelpers.classPrivateFieldSet(this,f,r.isIframe)}if(t.Type.isBoolean(r.isEmbedded)){babelHelpers.classPrivateFieldSet(this,h,r.isEmbedded)}}this.reloadGridTimeoutId=0}babelHelpers.createClass(e,[{key:"init",value:function e(){this.bindEvents();d(this,v,g).call(this)}},{key:"bindEvents",value:function e(){var i=this;r.EventEmitter.subscribe("BX.Crm.ItemListComponent:onClickDelete",this.handleItemDelete.bind(this));r.EventEmitter.subscribe("BX.Crm.ItemListComponent:onStartExportCsv",(function(e){i.handleStartExport(e,"csv")}));r.EventEmitter.subscribe("BX.Crm.ItemListComponent:onStartExportExcel",(function(e){i.handleStartExport(e,"excel")}));var o=d(this,y,E).call(this);if(o){o.subscribeTypeUpdatedEvent((function(){var e=n.Router.Instance.getItemListUrl(i.entityTypeId,i.categoryId);if(e){window.location.href=e;return}window.location.reload()}));if(this.grid){o.subscribeCategoriesUpdatedEvent((function(){i.reloadGridAfterTimeout()}))}}r.EventEmitter.subscribe("Crm.EntityConverter.Converted",(function(e){var r=e.data;if(!t.Type.isArray(r)||!r[1]){return}var n=r[1];if(!i.entityTypeName||!n.entityTypeName){return}i.reloadGridAfterTimeout()}));r.EventEmitter.subscribe("onLocalStorageSet",(function(e){var r=e.data;if(!t.Type.isArray(r)||!r[0]){return}var n=r[0];var o=n.key||"";if(o!=="onCrmEntityCreate"&&o!=="onCrmEntityUpdate"&&o!=="onCrmEntityDelete"&&o!=="onCrmEntityConvert"){return}var a=n.value;if(!t.Type.isPlainObject(a)){return}if(!i.entityTypeName||!a.entityTypeName){return}i.reloadGridAfterTimeout()}));var a=document.querySelector('[data-role="add-new-item-button-'+this.gridId+'"]');if(a){var s=a.href;a.href="javascript: void(0);";t.Event.bind(a,"click",(function(e){e.preventDefault();e.stopPropagation();r.EventEmitter.emit("BX.Crm.ItemListComponent:onAddNewItemButtonClick",{detailUrl:s,entityTypeId:i.entityTypeId})}))}}},{key:"reloadGridAfterTimeout",value:function e(){var t=this;if(!this.grid){return}if(this.reloadGridTimeoutId>0){clearTimeout(this.reloadGridTimeoutId);this.reloadGridTimeoutId=0}this.reloadGridTimeoutId=setTimeout((function(){t.grid.reload()}),1e3)}},{key:"showErrors",value:function e(r){var i="";r.forEach((function(e){i=i+e+" "}));if(t.Type.isElementNode(this.errorTextContainer)){this.errorTextContainer.innerText=i;this.errorTextContainer.parentElement.style.display="block"}else{console.error(i)}}},{key:"hideErrors",value:function e(){if(t.Type.isElementNode(this.errorTextContainer)){this.errorTextContainer.innerText="";this.errorTextContainer.parentElement.style.display="none"}}},{key:"showErrorsFromResponse",value:function e(t){var r=t.errors;var i=[];r.forEach((function(e){var t=e.message;return i.push(t)}));this.showErrors(i)}},{key:"handleItemDelete",value:function e(r){var n=this;var o=t.Text.toInteger(r.data.entityTypeId);var a=t.Text.toInteger(r.data.id);if(!o){this.showErrors([t.Loc.getMessage("CRM_TYPE_TYPE_NOT_FOUND")]);return}if(!a){this.showErrors([t.Loc.getMessage("CRM_TYPE_ITEM_NOT_FOUND")]);return}i.MessageBox.show({title:t.Loc.getMessage("CRM_TYPE_ITEM_DELETE_CONFIRMATION_TITLE"),message:t.Loc.getMessage("CRM_TYPE_ITEM_DELETE_CONFIRMATION_MESSAGE"),modal:true,buttons:i.MessageBoxButtons.YES_CANCEL,onYes:function e(r){t.ajax.runAction("crm.controller.item.delete",{analyticsLabel:"crmItemListDeleteItem",data:{entityTypeId:o,id:a}}).then((function(){BX.UI.Notification.Center.notify({content:t.Loc.getMessage("CRM_TYPE_ITEM_DELETE_NOTIFICATION")});n.reloadGridAfterTimeout()}))["catch"](n.showErrorsFromResponse.bind(n));r.close()}})}},{key:"handleStartExport",value:function e(t,r){this.getExportPopup(r).then((function(e){return e.showDialog()}))}},{key:"getExportPopup",value:function e(r){var i=this;if(this.exportPopups[r]){return Promise.resolve(this.exportPopups[r])}return t.Runtime.loadExtension("ui.stepprocessing").then((function(e){i.exportPopups[r]=e.ProcessManager.create({id:"crm.item.list.export."+r,controller:"bitrix:crm.api.itemExport",queue:[{action:"dispatcher"}],params:{SITE_ID:t.Loc.getMessage("SITE_ID"),entityTypeId:i.entityTypeId,categoryId:i.categoryId,EXPORT_TYPE:r,COMPONENT_NAME:"bitrix:crm.item.list"},messages:{DialogTitle:t.Loc.getMessage("CRM_ITEM_EXPORT_"+r.toUpperCase()+"_TITLE"),DialogSummary:t.Loc.getMessage("CRM_ITEM_EXPORT_"+r.toUpperCase()+"_SUMMARY")},dialogMaxWidth:"650"});i.exportPopups[r].setHandler(BX.UI.StepProcessing.ProcessCallback.StepCompleted,function(e){return function(){delete i.exportPopups[e]}}(r));return i.exportPopups[r]}))}}]);return e}();function E(){var e=t.Reflection.getClass("BX.Crm.ToolbarComponent");return e?e.Instance:null}function g(){var e=this;if(!babelHelpers.classPrivateFieldGet(this,p)||babelHelpers.classPrivateFieldGet(this,f)||babelHelpers.classPrivateFieldGet(this,h)){return}var r=d(this,y,E).call(this);if(!r){console.error("BX.Crm.ToolbarComponent not found");return}t.Runtime.loadExtension("crm.push-crm-settings").then((function(t){var i;var n=t.PushCrmSettings;new n({smartActivityNotificationSupported:babelHelpers.classPrivateFieldGet(e,m),entityTypeId:e.entityTypeId,rootMenu:(i=r.getSettingsButton())===null||i===void 0?void 0:i.getMenuWindow(),grid:e.grid})}))}u.ItemListComponent=T})(this.window=this.window||{},BX,BX.Event,BX.UI.Dialogs,BX.Crm);
//# sourceMappingURL=script.map.js