(function(e,t,r,i,n,o){"use strict";function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach((function(t){babelHelpers.defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function l(e,t){c(e,t);t.add(e)}function d(e,t,r){c(e,t);t.set(e,r)}function c(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function u(e,t,r){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return r}var p=i.Reflection.namespace("BX.Crm");var h=new WeakMap;var f=new WeakMap;var m=new WeakMap;var y=new WeakMap;var g=new WeakMap;var v=new WeakSet;var T=new WeakSet;var E=function(){function e(t){var r=this;babelHelpers.classCallCheck(this,e);l(this,T);l(this,v);d(this,h,{writable:true,value:false});d(this,f,{writable:true,value:false});d(this,m,{writable:true,value:false});d(this,y,{writable:true,value:void 0});d(this,g,{writable:true,value:void 0});this.exportPopups={};if(i.Type.isPlainObject(t)){this.entityTypeId=i.Text.toInteger(t.entityTypeId);this.entityTypeName=t.entityTypeName;this.categoryId=i.Text.toInteger(t.categoryId);babelHelpers.classPrivateFieldSet(this,f,i.Text.toBoolean(t.smartActivityNotificationSupported));if(i.Type.isString(t.gridId)){this.gridId=t.gridId}if(this.gridId&&BX.Main.grid&&BX.Main.gridManager){this.grid=BX.Main.gridManager.getInstanceById(this.gridId);if(this.grid&&t.backendUrl){BX.addCustomEvent(window,"Grid::beforeRequest",(function(e,n){if(!e.parent||e.parent!==r.grid){return}var o=new i.Uri(n.url);var a=new i.Uri(t.backendUrl);if(o.getPath()!==a.getPath()){o.setPath(a.getPath());o.setQueryParams(s(s({},o.getQueryParams()),a.getQueryParams()))}n.url=o.toString()}))}}if(i.Type.isElementNode(t.errorTextContainer)){this.errorTextContainer=t.errorTextContainer}if(i.Type.isBoolean(t.isIframe)){babelHelpers.classPrivateFieldSet(this,h,t.isIframe)}if(i.Type.isBoolean(t.isEmbedded)){babelHelpers.classPrivateFieldSet(this,m,t.isEmbedded)}if(i.Type.isPlainObject(t.pingSettings)){babelHelpers.classPrivateFieldSet(this,y,t.pingSettings)}babelHelpers.classPrivateFieldSet(this,g,i.Type.isString(t.aiAutostartSettings)?t.aiAutostartSettings:null)}this.reloadGridTimeoutId=0}babelHelpers.createClass(e,[{key:"init",value:function e(){this.bindEvents();u(this,T,I).call(this)}},{key:"bindEvents",value:function e(){var r=this;n.EventEmitter.subscribe("BX.Crm.ItemListComponent:onClickDelete",this.handleItemDelete.bind(this));n.EventEmitter.subscribe("BX.Crm.ItemListComponent:onStartExportCsv",(function(e){r.handleStartExport(e,"csv")}));n.EventEmitter.subscribe("BX.Crm.ItemListComponent:onStartExportExcel",(function(e){r.handleStartExport(e,"excel")}));var o=u(this,v,b).call(this);if(o){o.subscribeTypeUpdatedEvent((function(){var e=t.Router.Instance.getItemListUrl(r.entityTypeId,r.categoryId);if(e){window.location.href=e;return}window.location.reload()}));if(this.grid){o.subscribeCategoriesUpdatedEvent((function(){r.reloadGridAfterTimeout()}))}}n.EventEmitter.subscribe("Crm.EntityConverter.Converted",(function(e){var t=e.data;if(!i.Type.isArray(t)||!t[1]){return}var n=t[1];if(!r.entityTypeName||!n.entityTypeName){return}r.reloadGridAfterTimeout()}));n.EventEmitter.subscribe("onLocalStorageSet",(function(e){var t=e.data;if(!i.Type.isArray(t)||!t[0]){return}var n=t[0];var o=n.key||"";if(o!=="onCrmEntityCreate"&&o!=="onCrmEntityUpdate"&&o!=="onCrmEntityDelete"&&o!=="onCrmEntityConvert"){return}var a=n.value;if(!i.Type.isPlainObject(a)){return}if(!r.entityTypeName||!a.entityTypeName){return}r.reloadGridAfterTimeout()}));var a=document.querySelector('[data-role="add-new-item-button-'+this.gridId+'"]');if(a){var s=a.href;a.href="javascript: void(0);";i.Event.bind(a,"click",(function(e){e.preventDefault();e.stopPropagation();n.EventEmitter.emit("BX.Crm.ItemListComponent:onAddNewItemButtonClick",{detailUrl:s,entityTypeId:r.entityTypeId})}))}}},{key:"reloadGridAfterTimeout",value:function e(){var t=this;if(!this.grid){return}if(this.reloadGridTimeoutId>0){clearTimeout(this.reloadGridTimeoutId);this.reloadGridTimeoutId=0}this.reloadGridTimeoutId=setTimeout((function(){t.grid.reload()}),1e3)}},{key:"showErrors",value:function e(t){var r="";t.forEach((function(e){r=r+e+" "}));if(i.Type.isElementNode(this.errorTextContainer)){this.errorTextContainer.innerText=r;this.errorTextContainer.parentElement.style.display="block"}else{console.error(r)}}},{key:"hideErrors",value:function e(){if(i.Type.isElementNode(this.errorTextContainer)){this.errorTextContainer.innerText="";this.errorTextContainer.parentElement.style.display="none"}}},{key:"showErrorsFromResponse",value:function e(t){var r=t.errors;var i=[];r.forEach((function(e){var t=e.message;return i.push(t)}));this.showErrors(i)}},{key:"handleItemDelete",value:function e(t){var r=this;var n=i.Text.toInteger(t.data.entityTypeId);var a=i.Text.toInteger(t.data.id);if(!n){this.showErrors([i.Loc.getMessage("CRM_TYPE_TYPE_NOT_FOUND")]);return}if(!a){this.showErrors([i.Loc.getMessage("CRM_TYPE_ITEM_NOT_FOUND")]);return}o.MessageBox.show({title:i.Loc.getMessage("CRM_TYPE_ITEM_DELETE_CONFIRMATION_TITLE"),message:i.Loc.getMessage("CRM_TYPE_ITEM_DELETE_CONFIRMATION_MESSAGE"),modal:true,buttons:o.MessageBoxButtons.YES_CANCEL,onYes:function e(t){i.ajax.runAction("crm.controller.item.delete",{analyticsLabel:"crmItemListDeleteItem",data:{entityTypeId:n,id:a}}).then((function(){BX.UI.Notification.Center.notify({content:i.Loc.getMessage("CRM_TYPE_ITEM_DELETE_NOTIFICATION")});r.reloadGridAfterTimeout()}))["catch"](r.showErrorsFromResponse.bind(r));t.close()}})}},{key:"handleStartExport",value:function e(t,r){this.getExportPopup(r).then((function(e){return e.showDialog()}))}},{key:"getExportPopup",value:function e(t){var r=this;if(this.exportPopups[t]){return Promise.resolve(this.exportPopups[t])}return i.Runtime.loadExtension("ui.stepprocessing").then((function(e){r.exportPopups[t]=e.ProcessManager.create({id:"crm.item.list.export."+t,controller:"bitrix:crm.api.itemExport",queue:[{action:"dispatcher"}],params:{SITE_ID:i.Loc.getMessage("SITE_ID"),entityTypeId:r.entityTypeId,categoryId:r.categoryId,EXPORT_TYPE:t,COMPONENT_NAME:"bitrix:crm.item.list"},messages:{DialogTitle:i.Loc.getMessage("CRM_ITEM_EXPORT_"+t.toUpperCase()+"_TITLE"),DialogSummary:i.Loc.getMessage("CRM_ITEM_EXPORT_"+t.toUpperCase()+"_SUMMARY")},dialogMaxWidth:"650"});r.exportPopups[t].setHandler(BX.UI.StepProcessing.ProcessCallback.StepCompleted,function(e){return function(){delete r.exportPopups[e]}}(t));return r.exportPopups[t]}))}}]);return e}();function b(){var e=i.Reflection.getClass("BX.Crm.ToolbarComponent");return e?e.Instance:null}function I(){var e;if(babelHelpers.classPrivateFieldGet(this,h)||babelHelpers.classPrivateFieldGet(this,m)){return}var t=u(this,v,b).call(this);if(!t){console.error("BX.Crm.ToolbarComponent not found");return}var i=(e=t.getSettingsButton())===null||e===void 0?void 0:e.getMenuWindow();if(i){new r.SettingsButtonExtender({smartActivityNotificationSupported:babelHelpers.classPrivateFieldGet(this,f),entityTypeId:this.entityTypeId,categoryId:this.categoryId,aiAutostartSettings:babelHelpers.classPrivateFieldGet(this,g),pingSettings:babelHelpers.classPrivateFieldGet(this,y),rootMenu:i,grid:this.grid})}}p.ItemListComponent=E})(this.window=this.window||{},BX.Crm,BX.Crm,BX,BX.Event,BX.UI.Dialogs);
//# sourceMappingURL=script.map.js