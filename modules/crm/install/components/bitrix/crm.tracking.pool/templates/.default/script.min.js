(function(){"use strict";var t=BX.namespace("BX.Crm.Tracking.Channel");if(t.Pool){return}function e(){this.context=null;this.editor=null;this.colors={used:"#e9e9e9"}}e.prototype.init=function(t){this.context=BX(t.containerId);this.componentName=t.componentName;this.signedParameters=t.signedParameters;this.mess=t.mess||{};this.typeId=t.typeId;BX.bind(BX("item-allocate"),"click",this.allocate.bind(this));this.poolSelector=BX.UI.TileSelector.getById("available-list");this.organicSelector=BX.UI.TileSelector.getById("organic-list");BX.addCustomEvent(this.poolSelector,this.poolSelector.events.tileRemove,this.onRemoveTile.bind(this));BX.addCustomEvent(this.poolSelector,this.poolSelector.events.tileClick,this.onTileClick.bind(this));this.selectors=BX.UI.TileSelector.getList().filter(function(t){return t!==this.poolSelector&&t!==this.organicSelector},this);this.selectors.forEach(function(t){BX.addCustomEvent(t,t.events.tileAdd,this.actualizePool.bind(this));BX.addCustomEvent(t,t.events.tileRemove,this.actualizePool.bind(this));BX.addCustomEvent(t,t.events.tileClick,this.onTileClick.bind(this));BX.addCustomEvent(t,t.events.buttonSelect,this.showSelectorPopup.bind(this,t))},this);this.actualizePool();this.itemDialogBtn=BX("item-add");BX.bind(this.itemDialogBtn,"click",this.showAddItemDialog.bind(this))};e.prototype.showSelectorPopup=function(t){var e=this.poolSelector.getTiles().filter(function(t){return!t.data.used});t.showSearcher(this.mess.searcherTitle);t.setSearcherData([{id:"all",name:this.mess.searcherCategory,data:{},items:e}])};e.prototype.onRemoveTile=function(t){if(!t.id){return}this.request("removeItem",{typeId:this.typeId,value:t.id},function(t){},function(){})};e.prototype.onTileClick=function(t){if(!t.data.using){return}if(!this.tester){this.tester=new i({manager:this})}this.tester.open(t.id,t.data.using)};e.prototype.showAddItemDialog=function(){if(!this.itemDialog){this.itemDialog=new BX.PopupWindow("crm-tracking-phone-add",this.itemDialogBtn,{content:BX("crm-tracking-dialog-add"),minWidth:300});this.itemDialogName=BX("item-add-name");var t=BX("item-add-name-btn-add");BX.bind(t,"click",function(){var e=this.itemDialogName.value.trim();if(!e){this.itemDialog.close();return}BX.addClass(t,"ui-btn-wait");this.request("addItem",{typeId:this.typeId,value:e},function(e){BX.removeClass(t,"ui-btn-wait");this.itemDialog.close();if(!e.data||!e.data.value){return}if(e.data.value===true){return}var i=this.poolSelector.addTile(e.data.value,{canRemove:true,using:e.data.using},e.data.value);this.onTileClick(i)},function(){BX.removeClass(t,"ui-btn-wait");this.itemDialog.close()})}.bind(this));BX.bind(BX("item-add-name-btn-close"),"click",function(){this.itemDialog.close()}.bind(this))}if(this.itemDialog.isShown()){this.itemDialog.close()}else{this.itemDialogName.value="";this.itemDialog.show();this.itemDialogName.focus()}};e.prototype.actualizePool=function(){var t=this.selectors.reduce(function(t,e){return t.concat(e.getTiles())},[]);this.organicSelector.removeTiles();this.poolSelector.getTiles().forEach(function(e){e.data.used=t.some(function(t){return e.id===t.id});e.changeRemoving(!e.data.used&&e.data.canRemove);this.poolSelector.updateTile(e,null,e.data,e.data.used?this.colors.used:null);if(!e.data.used){this.organicSelector.addTile(e.name||e.id,e.data,e.id).changeRemoving(false)}},this);var e="crm-tracking-channel-pool-item-status";var i=e+"-gray";var n=e+"-green";var s={};[this.poolSelector,this.organicSelector].concat(this.selectors).forEach(function(t){t.getTiles().forEach(function(t){if(!t.data.using){if(!s[t.id]){return}t.data.using=s[t.id]}var o=t.data.using.cnt>0;t.node.title=o?this.mess.phoneStatusSuccess:this.mess.phoneStatusUnknown;s[t.id]=t.data.using;var a=t.node.querySelector('[data-role="tile-item-status"]');if(!a){a=document.createElement("span");a.setAttribute("data-role","tile-item-status");t.node.insertBefore(a,t.node.firstChild);BX.addClass(a,e)}BX.removeClass(a,i);BX.removeClass(a,n);BX.addClass(a,o?n:i)},this)},this)};e.prototype.allocate=function(){var t=this.poolSelector.getTiles().filter(function(t){return!t.data.used});if(t.length===0){return}this.selectors.filter(function(t){return t.getTiles().length===0}).forEach(function(e){if(t.length===0){return}var i=t.shift();e.addTile(i.name||i.id,i.data,i.id)})};e.prototype.request=function(t,e,i,n){BX.ajax.runComponentAction(this.componentName,t,{mode:"class",signedParameters:this.signedParameters,data:e}).then(function(t){var e=t.data||{};if(e.error){n.apply(this,[e])}else if(i){i.apply(this,[e])}}.bind(this),function(){var t={error:true,text:""};n.apply(this,[t])}.bind(this))};function i(t){this.manager=t.manager;BX.addCustomEvent("onPullEvent-crm",function(t,e){if(t!=="tracking-call-end"){return}if(!this.listening){return}this.end(e.numberFrom,e.numberTo)}.bind(this));top.BX.loadCSS("/bitrix/components/bitrix/crm.tracking.pool/templates/.default/tester.css");top.BX.loadExt("ui.forms");top.BX.loadExt("ui.buttons")}i.prototype={manager:null,container:null,numberTo:null,listening:false,numberFrom:null,classSuccess:"crm-tracking-call-tester-status-success",open:function(t,e){if(!e){return}if(!this.container){this.init()}this.clear();this.numberTo=t;var i=e.cnt>0;this.nodeTitle.textContent=t;this.nodeDate.textContent=e.date||this.manager.mess.noPhoneTesting;this.nodeFromInput.value=this.numberFrom;i?BX.addClass(this.nodeStatus,this.classSuccess):BX.removeClass(this.nodeStatus,this.classSuccess);BX.SidePanel.Instance.open("crm-tracking-pool-tester",{width:550,cacheable:false,contentCallback:function(){var t=new BX.Promise;t.fulfill(this.container);return t}.bind(this),events:{onLoad:function(t){}}})},start:function(){this.clear();BX.removeClass(this.nodeFrom,"ui-ctl-danger");var t=this.nodeFromInput.value;if(!t){BX.addClass(this.nodeFrom,"ui-ctl-danger");return}this.numberFrom=t;this.listening=true;this.manager.request("startTesting",{numberFrom:this.numberFrom},function(t){if(t.data&&t.data.numberFrom){this.numberFrom=t.data.numberFrom;this.nodeFromInput.value=this.numberFrom}else{this.end(null,null,true);BX.addClass(this.nodeFrom,"ui-ctl-danger")}}.bind(this),function(){this.end(null,null,true);BX.addClass(this.nodeFrom,"ui-ctl-danger")}.bind(this));this.nodeWaitNumber.textContent=this.numberTo;this.nodeWait.style.display="";BX.removeClass(this.nodeButton,"ui-btn-primary");this.nodeButton.textContent=this.nodeButton.getAttribute("data-lang-stop")},clear:function(t,e){this.listening=false;this.nodeWait.style.display="none";this.nodeButton.textContent=this.nodeButton.getAttribute("data-lang-start");BX.addClass(this.nodeButton,"ui-btn-primary");this.nodeResultSuccess.style.display=t===true?"":"none";this.nodeResultFail.style.display=t===false?"":"none";this.nodeResultUnknown.style.display=e&&!BX.type.isBoolean(t)?"":"none";if(t){BX.addClass(this.nodeStatus,this.classSuccess)}},end:function(t,e,i){if(t&&t!==this.numberFrom){return}if(e&&e!==this.numberTo){return}var n=null;if(t){n=false}if(e){n=true;var s=this.manager.poolSelector.getTile(e);if(s){s.data.using=s.data.using||{};s.data.using.cnt=s.data.using.cnt||1;s.data.using.date=s.data.using.date||BX.formatDate();this.manager.actualizePool()}}this.clear(n,i)},onButtonClick:function(){this.listening?this.end(null,null,true):this.start()},init:function(){this.container=document.createElement("div");this.container.innerHTML=BX("crm-tracking-pool-tester").innerHTML;this.nodeTitle=this.getNode("tester/title");this.nodeStatus=this.getNode("tester/status");this.nodeDate=this.getNode("tester/date");this.nodeFrom=this.getNode("tester/from");this.nodeFromInput=this.getNode("tester/from/input");this.nodeButton=this.getNode("tester/btn");this.nodeWait=this.getNode("tester/wait");this.nodeWaitNumber=this.getNode("tester/wait/number");this.nodeWaitLoader=this.getNode("tester/wait/loader");this.nodeResultSuccess=this.getNode("tester/result/success");this.nodeResultFail=this.getNode("tester/result/fail");this.nodeResultUnknown=this.getNode("tester/result/unknown");BX.bind(this.nodeButton,"click",this.onButtonClick.bind(this));new BX.Loader({}).show(this.nodeWaitLoader)},getNode:function(t){var e=this.container.querySelector('[data-role="crm/tracking/pool/'+t+'"]');return e?e:null}};t.Pool=new e})();
//# sourceMappingURL=script.map.js