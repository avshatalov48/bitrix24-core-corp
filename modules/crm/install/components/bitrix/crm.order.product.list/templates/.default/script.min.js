BX.namespace("BX.Crm.Order.Product");if(typeof BX.Crm.Order.Product.List==="undefined"){BX.Crm.Order.Product.List=function(){this._controller=null;this._id=null;this._settings=null;this._formName="";this._form=null;this._timerId=null;this._timeOutDelay=850;this._canSend=true};BX.Crm.Order.Product.List.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._isChanged=this.getSetting("isChanged",false);this._isReadOnly=this.getSetting("isReadOnly",false);if(!this._isReadOnly){BX.Event.EventEmitter.unsubscribeAll("onFocusToProductList");BX.Event.EventEmitter.subscribe("onFocusToProductList",(()=>{this.onFocusToProductList();BX.onCustomEvent("crmOrderProductListFocused")}))}BX.addCustomEvent("crmOrderDetailDiscountToggle",BX.proxy((function(t){this.setDiscountById(t.discountId,t.isSet,false,true)}),this));BX.onCustomEvent("crmOrderProductListInit",[{id:this._id}])},setController:function(t){this._controller=t;this._controller.setProductList(this)},getForm:function(){if(this._form===null&&this._formName){this._form=document.getElementsByName(this._formName)[0]}return this._form},setFormId:function(t){this._formName=t},getFormData:function(){var t=this.getForm();if(!t){return{}}var e=BX.ajax.prepareForm(t);if(e&&e.data&&e.data.ID){delete e.data.ID}return!!e&&e.data?e.data:{}},setFormData:function(t){if(t&&t.PRODUCT_COMPONENT_RESULT){var e=BX.processHTML(t.PRODUCT_COMPONENT_RESULT),n=BX("crm-product-list-container").parentNode,i=Boolean(n.offsetWidth||n.offsetHeight||n.getClientRects().length);if(i){var o=n.getBoundingClientRect();var s=n.cloneNode(true);BX.addClass(s,"crm-order-product-refresh-stub");document.body.appendChild(s);s.style.left=o.left+"px";s.style.top=o.top+"px";s.style.width=o.width+"px";s.style.height=o.height+"px"}setTimeout((function(){n.innerHTML=e["HTML"];setTimeout((function(){if(i){s.style.opacity=0}setTimeout((function(){if(i){s.parentNode.removeChild(s)}if(BX.type.isDomNode(BX(this._id+"-grid-settings-window")))BX.remove(BX(this._id+"-grid-settings-window"));setTimeout((function(){for(var t in e["SCRIPT"]){if(!e["SCRIPT"].hasOwnProperty(t))continue;BX.evalGlobal(e["SCRIPT"][t]["JS"]);delete e["SCRIPT"][t]}}),1)}),120)}),100)}),1)}},setChanged:function(){this._isChanged=true},isChanged:function(){return this._isChanged},onDataChanged:function(){if(!this._canSend){return}var t=this;clearTimeout(this._timerId);this._timerId=interval=setTimeout((function(){t._canSend=false;t._controller.onDataChanged();setTimeout((function(){t._canSend=true}),200)}),this._timeOutDelay)},showProductExistDialog:function(t){BX.UI.EditorAuxiliaryDialog.create("order_product_exist_dialog",{title:this._settings.messages["CRM_ORDER_PL_PROD_EXIST_DLG_TITLE"],content:this._settings.messages["CRM_ORDER_PL_PROD_EXIST_DLG_TEXT_FOR_DOUBLE"].replace("#NAME#",this.getProductName(t.id)),buttons:[{id:"incrementProduct",type:BX.Crm.DialogButtonType.accept,text:this._settings.messages["CRM_ORDER_PL_PROD_EXIST_DLG_BUTT_ADD"],callback:BX.proxy((function(e){this.setChanged();this._controller.onProductAdd(t.id,t.quantity,"N");e.getDialog().close()}),this)},{id:"cancel",type:BX.Crm.DialogButtonType.cancel,text:this._settings.messages["CRM_ORDER_PL_PROD_EXIST_DLG_BUTT_CANCEL"],callback:function(t){t.getDialog().close()}}]}).open()},onFocusToProductList:function(){const t=this.getSetting("languageId",false);const e=this.getSetting("siteId",false);const n=this.getSetting("orderId",false);if(t&&e&&n){this.addProductSearch({languageId:t,siteId:e,orderId:n})}},onProductAdd:function(t,e){if(this.isProductAlreadyInBasket(t.id)){this.showProductExistDialog(t)}else{this.setChanged();this._controller.onProductAdd(t.id,t.quantity)}},onProductCreate:function(t){this.setChanged();this._controller.onProductCreate(t)},onProductUpdate:function(t,e){if(BX.type.isNotEmptyString(t)){this.setChanged();this._controller.onProductUpdate(t,e)}},onProductDelete:function(t){this.setChanged();this._controller.onProductDelete(t)},onGroupAction:function(t,e){var n=BX.Main.gridManager.getById(t);var i=n.instance.getRows().getSelectedIds(),o=n.instance.getActionsPanel().getValues(),s=n.instance.getForAllKey()in o?o[n.instance.getForAllKey()]:"N";this._controller.onProductGroupAction(i,e,s)},onRefreshOrderDataAndSave:function(){this._controller.onRefreshOrderDataAndSave()},onCouponAdd:function(){var t=BX("crm-order-product-new-coupon").value;if(t){this._controller.onCouponAdd(t)}},onProductDiscountCheck:function(t,e){this.setDiscountById(e,t.checked,true);this.onDataChanged()},onDiscountCheck:function(t,e){this.setDiscountById(e,t.checked)},setDiscountById:function(t,e,n,i){if(t<=0)return;i=i||false;var o=BX.findChildren(document,{attribute:{"data-discount-id":t}},true);for(var s in o){if(o.hasOwnProperty(s)){if(n&&(!e||!o[s].hasAttribute("data-is-coupon"))){continue}if(o[s].type==="checkbox"){o[s].checked=e}else if(o[s].type==="hidden"){o[s].value=e?"Y":"N"}}}if(!i){BX.onCustomEvent("crmOrderProductListDiscountToggle",[{discountId:t,isSet:e}]);this.onDataChanged()}},onOpenCreateDiscountBlock:function(t){t.parentNode.parentNode.appendChild(BX.create("div",{props:{className:"crm-order-product-control-discounts-list-item"},html:this._settings.customDiscountTempl}))},onApplyCustomDiscount:function(){alert("Apply discount")},onCouponDelete:function(t){this._controller.onCouponDelete(t)},onCouponApply:function(t,e,n){var i=this.getForm();if(i.elements["DISCOUNTS[COUPON_LIST]["+e+"]"]){i.elements["DISCOUNTS[COUPON_LIST]["+e+"]"].value=t.checked?"Y":"N";this.setDiscountById(n,t.checked);this.onDataChanged()}},onCloseCustomDiscount:function(t){t.parentNode.parentNode.removeChild(t.parentNode)},isProductAlreadyInBasket:function(t){var e=BX.findChildren(document,{attribute:{"data-offer-id":t}},true);for(var n in e){if(e.hasOwnProperty(n)){return true}}return false},getProductName:function(t){var e=BX.findChildren(document,{attribute:{"data-offer-id":t,"data-product-field":"name"}},true);for(var n in e){if(e.hasOwnProperty(n)){return e[n].dataset.fullname||e[n].innerHTML}}return""},addProductSearch:function(t){var e="CrmProductListonProductAdd";window[e]=BX.proxy((function(t,e){this.onProductAdd(t,e)}),this);var n=new BX.CDialog({content_url:"/bitrix/tools/sale/product_search_dialog.php?"+"lang="+this._settings.languageId+"&LID="+this._settings.siteId+"&caller=order_edit"+"&func_name="+e+"&STORE_FROM_ID=0"+"&public_mode=Y",height:Math.max(500,window.innerHeight-400),width:Math.max(800,window.innerWidth-400),draggable:true,resizable:true,min_height:500,min_width:800,zIndex:800});BX.addCustomEvent(n,"onWindowRegister",BX.defer((function(){n.Get().style.position="fixed";n.Get().style.top=parseInt(n.Get().style.top)-BX.GetWindowScrollPos().scrollTop+"px"})));BX.addCustomEvent(window,"EntityEditorOrderController:onInnerCancel",BX.defer((function(){n.Close()})));if(typeof BX.Crm.EntityEvent!=="undefined"){BX.addCustomEvent(window,BX.Crm.EntityEvent.names.update,BX.defer((function(){window.setTimeout(BX.delegate((function(){n.Close()}),this),0)})))}n.Show()},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},setFormInputValue:function(t,e){var n=this.getForm(),i;if(n.elements.name){i=n.elements.name;i.value=e}else{i=BX.create("input",{props:{type:"hidden",value:e,name:t}});n.appendChild(i)}},getVatMenuElements:function(t){var e=[];for(var n in this._settings.vatRates){if(this._settings.vatRates.hasOwnProperty(n)){e.push({value:n,text:this._settings.vatRates[n],onclick:t})}}return e},onSkuSelect:function(t,e,n){var i=this._settings.basketItemsParams[t].PRODUCT_ID,o=this._settings.basketItemsParams[t].OFFERS_IBLOCK_ID,s=this._settings.productSkuValues[i];s[e]=n;this._controller.onSkuSelect({BASKET_CODE:t,CHANGED_SKU_ID:e,SKU_PROPS:s,SKU_ORDER:this._settings.skuOrder[o],PRODUCT_ID:i})},showProductVatMenu:function(t,e){var n=this;var i=function(i,o){t.innerHTML="<span>"+BX.prop.getString(o,"text")+"</span>";n.setFormInputValue("PRODUCT["+e+"][VAT_RATE]",BX.prop.getString(o,"value"));var s=BX.PopupMenu.getMenuById(t.id);if(s){s.popupWindow.close()}n.onDataChanged()};BX.PopupMenu.show(t.id,t,this.getVatMenuElements(i),{angle:false,events:{onPopupClose:function(){BX.PopupMenu.destroy(t.id)}}})}};BX.Crm.Order.Product.List.create=function(t,e){var n=new BX.Crm.Order.Product.List;n.initialize(t,e);return n}}
//# sourceMappingURL=script.map.js