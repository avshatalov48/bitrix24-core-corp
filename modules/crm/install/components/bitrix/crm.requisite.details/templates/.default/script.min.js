BX.namespace("BX.Crm");BX.localStorage.set("BX.Crm.RequisiteSliderDetails:initStarted",{},10);if(typeof BX.Crm.RequisiteDetailsManager==="undefined"){BX.Crm.RequisiteDetailsManager=function(){this.needEmitCancelEvent=true;this.entityEditor=null};BX.Crm.RequisiteDetailsManager.presetControlName="PRESET_ID";BX.Crm.RequisiteDetailsManager.autocompleteControlName="AUTOCOMPLETE";BX.Crm.RequisiteDetailsManager.bankDetailsControlName="BANK_DETAILS";BX.Crm.RequisiteDetailsManager.addressControlName="RQ_ADDR";BX.Crm.RequisiteDetailsManager.prototype={initialize:function(e){this._settings=e;this.entityEditor=this.getEntityEditor();this.prevPresetId=null;this.addEvents();if(this.getSetting("markPresetAsChanged",false)){this.markPresetAsChanged()}},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getEntityEditor:function(){var e;var t=this.getSetting("entityEditorId","");if(BX.Type.isStringFilled(t)){e=BX.UI.EntityEditor.get(t);if(!e){e=null}}return e},initializeDupControl:function(){var e=this.getEntityEditor();if(!e){return}var t=e.getId().toLowerCase()+"_dup";var i=this.getSetting("duplicateControl",{});i["editor"]=e;BX.Crm.RequisiteDetailsDupManager.create(t,i)},markPresetAsChanged:function(){if(!this.entityEditor){return}var e=this.entityEditor.getControlByCombinedIdRecursive(BX.Crm.RequisiteDetailsManager.presetControlName);if(e){e.markAsChanged()}},addNewBankDetails:function(){if(!this.entityEditor){return}var e=this.entityEditor.getControlByCombinedIdRecursive(BX.Crm.RequisiteDetailsManager.bankDetailsControlName);if(e){e.addEmptyValue({scrollToTop:true})}},addEvents:function(){BX.Event.EventEmitter.subscribe("BX.UI.EntityEditor:onCancel",this.onCancelEdit.bind(this));BX.Event.EventEmitter.subscribe("BX.UI.EntityEditor:onNothingChanged",this.onCancelEdit.bind(this));BX.Event.EventEmitter.subscribe("onEntityUpdate",this.onSave.bind(this));var e=this.getSliderInstance();if(e){BX.addCustomEvent(e,"SidePanel.Slider:onClose",this.onCloseSlider.bind(this));BX.addCustomEvent(e,"SidePanel.Slider:onLoad",this.onLoadSlider.bind(this))}if(this.entityEditor){BX.Event.EventEmitter.subscribe(this.entityEditor,"onControlChanged",this.onControlChanged.bind(this));var t=this.entityEditor.getControlById("NAME");var i=document.querySelector(".ui-side-panel-wrap-title-input")||BX("pagetitle_input");if(t&&BX.Type.isDomNode(i)){BX.bind(i,"change",(function(){t.markAsChanged()}))}const e=this.getAttributeManagerSettings();if(BX.Type.isPlainObject(e)){const t=BX.Crm.EntityFieldAttributeManager.create(this.entityEditor.getId()+"_ATTR_MANAGER",{entityTypeId:parseInt(this.getSetting("entityTypeId",BX.CrmEntityType.enumeration.undefined)),entityScope:BX.prop.getString(e,"ENTITY_SCOPE",""),isPermitted:BX.prop.getBoolean(e,"IS_PERMITTED",true),isPhaseDependent:BX.prop.getBoolean(e,"IS_PHASE_DEPENDENT",true),isAttrConfigButtonHidden:BX.prop.getBoolean(e,"IS_ATTR_CONFIG_BUTTON_HIDDEN",true),lockScript:BX.prop.getString(e,"LOCK_SCRIPT",""),captions:BX.prop.getObject(e,"CAPTIONS",{}),entityPhases:BX.prop.getArray(e,"ENTITY_PHASES",null)});this.entityEditor.setAttributeManager(t)}}},isMatchedAutocompleteControlName:function(e,t){if(e===t||e.endsWith("."+t)||e.endsWith("["+t+"]")){return true}return false},onControlChanged:function(e){var t;var i=e.getData();if(BX.Type.isArray(i)){t=i.length>0?i[0]:null;if(t instanceof BX.UI.EntityEditorList&&this.isMatchedAutocompleteControlName(t.getId(),BX.Crm.RequisiteDetailsManager.presetControlName)){if(this.prevPresetId===null){this.prevPresetId=t.getValue()}if(this.prevPresetId!==t.getRuntimeValue()){this.onPresetChanged(t,this.prevPresetId);this.prevPresetId=t.getRuntimeValue()}}if(t instanceof BX.Crm.EntityEditorRequisiteAutocomplete&&this.isMatchedAutocompleteControlName(t.getId(),BX.Crm.RequisiteDetailsManager.autocompleteControlName)){var r=t.getAutocompleteData();var n=BX.prop.getObject(r,"fields",{});var s=Object.keys(n);var a=false;var l=null;if(n.hasOwnProperty(BX.Crm.RequisiteDetailsManager.presetControlName)){l=this.getEntityEditor().getControlByIdRecursive(BX.Crm.RequisiteDetailsManager.presetControlName);if(l){const e=n[BX.Crm.RequisiteDetailsManager.presetControlName];if(l.getRuntimeValue()!=e){this.prevPresetId=l.getRuntimeValue();a=true}}}for(var o=0;o<s.length;o++){var d=s[o];var u=n[d];var p=this.getEntityEditor().getControlByCombinedIdRecursive(d);if(p){if(this.isMatchedAutocompleteControlName(d,BX.Crm.RequisiteDetailsManager.addressControlName)){var g=this.getEntityEditor()._model.getField(d);if(BX.Type.isPlainObject(g)){u=BX.merge(g,u)}}this.getEntityEditor()._model.setField(p.getId(),u);p.refreshLayout();if(!this.isMatchedAutocompleteControlName(d,BX.Crm.RequisiteDetailsManager.presetControlName)){p.markAsChanged()}}else if(a&&BX.Type.isStringFilled(u)){this.getEntityEditor().getFormElement().appendChild(BX.create("input",{props:{type:"hidden",name:d,value:u}}))}}if(a&&l){this.onPresetChanged(l,this.prevPresetId)}}}},onPresetChanged:function(e,t){const i=e.getEditor();if(i){if(typeof i.setValidationEnabled==="function"){i.setValidationEnabled(false)}else{const e=BX.UI.EntityUserFieldManager.getById(i.getId());if(e&&typeof e.setValidationEnabled==="function"){e.setValidationEnabled(false)}}BX.Event.EventEmitter.subscribe("BX.UI.EntityEditor:onSave",this.onSaveNewPreset.bind(this,t));i.releaseAjaxForm();i.save()}},onSaveNewPreset:function(e){var t=this.getEntityEditor();if(t){var i=t.getFormElement();if(i){i.appendChild(BX.create("input",{props:{type:"hidden",name:"PREV_PRESET_ID",value:e}}));i.appendChild(BX.create("input",{props:{type:"hidden",name:"ACTION",value:"RELOAD"}}));i.method="post";i.submit()}}},onCancelEdit:function(e){for(var t in e.getData()){if(e.data[t].cancel===false){e.data[t].cancel=true}}this.closeSlider()},onCloseSlider:function(){if(!this.needEmitCancelEvent){this.needEmitCancelEvent=true}else{this.emitEvent("onCancelEdit")}},onLoadSlider:function(){if(this.getSetting("duplicateControlEnabled",false)){this.initializeDupControl()}if(this.getSetting("autoAddBankDetailsItem",false)){this.addNewBankDetails()}},onSave:function(e){var t=e.getData();var i=BX.prop.getObject(t[0],"entityData",{});this.emitEvent("onSave",{requisiteData:BX.prop.getString(i,"REQUISITE_DATA",""),requisiteDataSign:BX.prop.getString(i,"REQUISITE_DATA_SIGN",""),presetId:this.getPresetId(),presetCountryId:this.getPresetCountryId()});setTimeout(this.closeSliderSilently.bind(this),10)},emitEvent:function(e,t){if(!t){t={}}t.contextId=this.getContextId();BX.localStorage.set("BX.Crm.RequisiteSliderDetails:"+e,t,10)},closeSlider:function(){var e=this.getSliderInstance();if(e){e.close()}},closeSliderSilently:function(){this.needEmitCancelEvent=false;this.closeSlider()},getContextId:function(){return this.getContextField("external_context_id")},getPresetId:function(){return this.getContextField("pid")},getPresetCountryId:function(){return this.getContextField("presetCountryId")},getContextField:function(e){if(!this.entityEditor){return""}var t=this.entityEditor.getContext();return BX.prop.getString(t,e,"")},getSliderInstance:function(){if(typeof top.BX.SidePanel!=="undefined"){var e=top.BX.SidePanel.Instance.getSliderByWindow(window);if(e&&e.isOpen()){return e}}return null},getAttributeManagerSettings:function(){return this.getSetting("attributeConfig",null)}};BX.Crm.RequisiteDetailsManager.create=function(e){var t=new BX.Crm.RequisiteDetailsManager;t.initialize(e);return t}}if(typeof BX.Crm.RequisiteDetailsDupManager==="undefined"){BX.Crm.RequisiteDetailsDupManager=function(){this._id="";this._settings=null;this._serviceUrl="";this._entityTypeName="";this._form=null;this._controller=null};BX.Crm.RequisiteDetailsDupManager.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=t?t:{};this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this._entityTypeName=BX.prop.getString(this._settings,"entityTypeName","");this._entityId=BX.prop.getString(this._settings,"entityId","");this._editor=BX.prop.get(this._settings,"editor",null);this._requisiteFieldsMap=BX.prop.getArray(this._settings,"requisiteFieldsMap",[]);this._bankDetailsFieldsMap=BX.prop.getArray(this._settings,"bankDetailsFieldsMap",[]);this._requisiteId=BX.prop.getString(this._settings,"requisiteId","");this._presetId=BX.prop.getString(this._settings,"presetId","");this._form=this._editor.getFormElement();this._bankDetailsValues={};this._controller=BX.Crm.RequisiteDetailsDupController.create(this._id,{serviceUrl:this._serviceUrl,entityTypeName:this._entityTypeName,entityId:this._entityId,form:this._form});for(var i,r=0;r<this._requisiteFieldsMap.length;r++){i=this._editor.getControlByIdRecursive(this._requisiteFieldsMap[r]);if(i){this.registerField(i.getId(),{id:i.getId(),field:i})}}BX.Event.EventEmitter.subscribe(this._editor,"onControlChanged",this.onChangeBankDetails.bind(this));this.processBankDetails()},onChangeBankDetails:function(e){var t=e.getData();if(BX.Type.isArray(t)){var i=t.length>0?t[0]:null;if(i&&i.getId()===BX.Crm.RequisiteDetailsManager.bankDetailsControlName){this.processBankDetails()}}},processBankDetails:function(){var e=this._editor.getControlById(BX.Crm.RequisiteDetailsManager.bankDetailsControlName);if(e){var t=e.getEditors();for(var i in t){if(!t.hasOwnProperty(i)){continue}if(this._bankDetailsValues[i]){continue}this._bankDetailsValues[i]=true;for(var r,n=0;n<this._bankDetailsFieldsMap.length;n++){var s=BX.Crm.RequisiteDetailsManager.bankDetailsControlName+"["+i+"]["+this._bankDetailsFieldsMap[n]+"]";r=t[i].getControlByIdRecursive(s);if(r){var a=this._bankDetailsFieldsMap[n];this.registerField(a,{id:a,context:{BANK_DETAILS_ID:i},field:r})}}}}},search:function(){this._controller.initialSearch()},getGroup:function(e){return this._controller.getGroup(e)},ensureGroupRegistered:function(e,t){var i=this.getGroup(e);if(!i){i=this._controller.registerGroup(e,{parameterName:e,requisiteId:this._requisiteId,presetId:this._presetId,context:t.context,groupType:"requisite",groupSummaryTitle:t.field?'"'+t.field.getTitle()+'"':""})}return i},registerField:function(e,t){var i=this.ensureGroupRegistered(e,t);if(!i){return null}return i.registerField(t)},unregisterField:function(e,t){var i=this.getGroup(e);if(!i){return}i.unregisterField(t)}};BX.Crm.RequisiteDetailsDupManager.create=function(e,t){var i=new BX.Crm.RequisiteDetailsDupManager;i.initialize(e,t);return i}}if(typeof BX.Crm.RequisiteDetailsDupController==="undefined"){BX.Crm.RequisiteDetailsDupController=function(){BX.Crm.RequisiteDetailsDupController.superclass.constructor.apply(this)};BX.ready((function(){BX.extend(BX.Crm.RequisiteDetailsDupController,BX.CrmDupController);BX.Crm.RequisiteDetailsDupController.prototype.registerGroup=function(e,t){var i=BX.type.isNotEmptyString(t["groupType"])?t["groupType"]:"";var r=null;try{if(i==="requisite"){r=BX.Crm.RequisiteDetailsSingleField.create(e,t)}}catch(e){}if(r){this.addGroup(r)}else{r=BX.Crm.RequisiteDetailsDupController.superclass.registerGroup.apply(this,[e,t])}return r}}));BX.Crm.RequisiteDetailsDupController.create=function(e,t){var i=new BX.Crm.RequisiteDetailsDupController;i.initialize(e,t);return i}}if(typeof BX.Crm.RequisiteDetailsSingleField==="undefined"){BX.Crm.RequisiteDetailsSingleField=function(){BX.Crm.RequisiteDetailsSingleField.superclass.constructor.apply(this);this._requisiteId=null;this._presetId=null;this._context=null};BX.ready((function(){BX.extend(BX.Crm.RequisiteDetailsSingleField,BX.CrmDupCtrlSingleField);BX.Crm.RequisiteDetailsSingleField.prototype._afterInitialize=function(){this._requisiteId=this.getSetting("requisiteId","");this._presetId=this.getSetting("presetId","");this._context=this.getSetting("context",null);this._paramName=this.getSetting("parameterName","");if(!BX.type.isNotEmptyString(this._paramName)){throw"BX.Crm.RequisiteDetailsSingleField. Could not find parameter name."}var e=this.getSetting("field",null);if(e){this._field=this.addField(BX.Crm.RequisiteDetailsCtrlField.create(this._paramName,e))}};BX.Crm.RequisiteDetailsSingleField.prototype.registerField=function(e){var t=BX.prop.getString(e,"id","");if(t!==this._paramName){return null}var i=BX.prop.get(e,"field",null);if(!i){return null}if(!this._field){this._field=this.addField(BX.Crm.RequisiteDetailsCtrlField.create(this._paramName,i))}return this._field};BX.Crm.RequisiteDetailsSingleField.prototype.prepareSearchParams=function(){var e=BX.Crm.RequisiteDetailsSingleField.superclass.prepareSearchParams.apply(this);if(e){e.PRESET_ID=this._presetId;e.ID=this._requisiteId;if(BX.Type.isPlainObject(this._context)){e=BX.mergeEx(e,this._context)}}return e}}));BX.Crm.RequisiteDetailsSingleField.create=function(e,t){var i=new BX.Crm.RequisiteDetailsSingleField;i.initialize(e,t);return i}}if(typeof BX.Crm.RequisiteDetailsCtrlField==="undefined"){BX.Crm.RequisiteDetailsCtrlField=function(){this._field=null;BX.Crm.RequisiteDetailsCtrlField.superclass.constructor.apply(this)};BX.ready((function(){BX.extend(BX.Crm.RequisiteDetailsCtrlField,BX.CrmDupCtrlField);BX.Crm.RequisiteDetailsCtrlField.prototype.initialize=function(e,t){if(!BX.type.isNotEmptyString(e)){throw"BX.Crm.RequisiteDetailsCtrlField. Invalid parameter 'id': is not defined."}this._id=e;if(!(t instanceof BX.UI.EntityEditorField)){throw"BX.Crm.RequisiteDetailsCtrlField. Invalid parameter 'field': not instance of BX.UI.EntityEditorField."}this._field=t;this._value=t._input?t._input.value:"";BX.Event.EventEmitter.subscribe(this._field.getEditor(),"onControlChanged",this.onFieldChanged.bind(this));this._initialized=true};BX.Crm.RequisiteDetailsCtrlField.prototype.onFieldChanged=function(e){var t=e.getData();if(BX.Type.isArray(t)){var i=t.length>0?t[0]:null;if(i!==this._field||this._value===i._input.value){return}if(this._elementTimeoutId>0){window.clearTimeout(this._elementTimeoutId);this._elementTimeoutId=0}this._elementTimeoutId=window.setTimeout(this._elementTimeoutHandler,1500)}};BX.Crm.RequisiteDetailsCtrlField.prototype.getElementTitle=function(){return this._field.getWrapper()};BX.Crm.RequisiteDetailsCtrlField.prototype.getValue=function(){return this._field._input.value}}));BX.Crm.RequisiteDetailsCtrlField.create=function(e,t){var i=new BX.Crm.RequisiteDetailsCtrlField;i.initialize(e,t);return i}}
//# sourceMappingURL=script.map.js