BX.crmPaySys={formId:"",orderProps:{},orderFields:{},paymentFields:{},userProps:{},userFields:{},requisiteFields:{},bankDetailFields:{},companyFields:{},userColumnFields:{},contactFields:{},simpleMode:true,template:"",init:function(e){for(var t in e){if(e.hasOwnProperty(t)){this[t]=e[t]}}this.formObj=BX(this.formId);if(this.template)BX.crmPSActionFile.reloadPreview(this.template);this.bindInputsChange()},getTemplatePreview:function(){var e=BX("frame");e.parentNode.style.opacity="0.5";var t=BX("form_CRM_PS_EDIT_FORM");var a={formData:BX.ajax.prepareForm(t),action:"refresh_template",sessid:BX.bitrix_sessid()};BX.ajax({data:a,method:"POST",dataType:"json",url:BX.crmPaySys.url+"/ajax.php",onsuccess:BX.delegate(function(e){if(e.TEMPLATE){BX.crmPSActionFile.reloadPreview(e.TEMPLATE);BX.crmPaySys.bindInputsChange()}var t=BX("frame");t.parentNode.style.opacity="1"},this),onfailure:function(){var e=BX("frame");e.parentNode.style.opacity="1";BX.debug("onfailure: getHandlerTemplate")}})},bindInputsChange:function(){var e=BX("bx-tabs");var t=BX.findChildren(e.nextElementSibling,{tag:"input"},true);for(var a in t){if(t.hasOwnProperty(a))BX.bind(t[a],"change",this.getTemplatePreview)}},switchMode:function(){var e=BX("MODE_SWITCHER");if(BX.crmPaySys.simpleMode){BX.crmPSPropType.showItems();BX.crmPSActionFile.showNoneSimpleRows();e.innerHTML=BX.message("CRM_PS_HIDE_FIELDS")}else{BX.crmPSPropType.hideItems();BX.crmPSActionFile.hideNoneSimpleRows();e.innerHTML=BX.message("CRM_PS_SHOW_FIELDS")}BX.crmPaySys.simpleMode=!BX.crmPaySys.simpleMode},getPrivateKey:function(){var e={action:"get_private_key",pay_system_id:BX("ps_id").value,sessid:BX.bitrix_sessid()};BX.ajax({data:e,method:"POST",dataType:"json",url:BX.crmPaySys.url+"/ajax.php",onsuccess:BX.delegate(function(e){if(e.ERROR)alert(e.ERROR);else alert(BX.message("CRM_PS_GENERATE_SUCCESS"))},this),onfailure:function(){BX.debug("onfailure: BX.crmPaySys.getPrivateKey")}})}};BX.crmPSPersonType={init:function(e){for(var t in e)this[t]=e[t];var a=BX.crmPaySys.formObj["PERSON_TYPE_ID"];if(a)BX.bind(a,"change",BX.delegate(BX.crmPSPersonType.onSelect,this))},getId:function(){return BX.crmPaySys.formObj["PERSON_TYPE_ID"].value},onSelect:function(){var e=this.getOrderPropsFNames();this.replaceOrderPropsSelectors(e)},getOrderPropsFNames:function(){var e=[];for(var t=0,a=BX.crmPaySys.formObj.elements.length;t<a;t++){if(!/^TYPE_/.test(BX.crmPaySys.formObj.elements[t].name))continue;if(BX.crmPaySys.formObj.elements[t].value!="PROPERTY")continue;e.push(BX.crmPaySys.formObj.elements[t].name.replace(/^TYPE_/,""))}return e},replaceOrderPropsSelectors:function(e){var t=this.getId();var a=BX.crmPSActionFile.getId();var i="bill";if(a.indexOf("quote")>=0)i="quote";var s=Object.assign({},BX.crmPaySys.orderProps[t],BX.crmPaySys.userFields[i]);for(var r=0,l=e.length;r<l;r++)BX.crmPSPropType.insertOptions(BX.crmPaySys.formObj["VALUE1_"+e[r]],s)}};BX.crmPSPropType={aTabs:{},init:function(e){for(var t in e)this[t]=e[t];this.bindEvents()},bindEvents:function(){var e=function(){var e=this;BX.delegate(BX.crmPSPropType.onSelect(e),this)};for(var t=0,a=BX.crmPaySys.formObj.elements.length;t<a;t++){if(!/^TYPE_/.test(BX.crmPaySys.formObj.elements[t].name))continue;var i=BX.crmPaySys.formObj.elements[t];if(i)BX.bind(i,"change",e)}},onSelect:function(e){this.replaceValueField(e)},replaceValueField:function(e){var t=e.name.replace(/^TYPE_/,"");if(e.value=="USER")this.setUserProps(t);else if(e.value=="ORDER")this.setOrderFields(t);else if(e.value=="PAYMENT")this.setPaymentFields(t);else if(e.value=="PROPERTY")this.setOrderProps(t);else if(e.value=="REQUISITE")this.setRequisiteFields(t);else if(e.value=="BANK_DETAIL")this.setBankDetailFields(t);else if(e.value=="CRM_COMPANY")this.setCompanyFields(t);else if(e.value=="CRM_CONTACT")this.setContactFields(t);else if(e.value=="MC_REQUISITE")this.setRequisiteFields(t);else if(e.value=="MC_BANK_DETAIL")this.setBankDetailFields(t);else if(e.value=="CRM_MYCOMPANY")this.setCompanyFields(t);else if(e.value=="USER_COLUMN_LIST")this.setUserColumnsFields(t);else if(e.value==""||e.value=="VALUE")this.setOtherProps(t)},setUserProps:function(e){this.insertOptions(BX.crmPaySys.formObj["VALUE1_"+e],BX.crmPaySys.userProps);this.showSelectorField(e)},setOrderFields:function(e){this.insertOptions(BX.crmPaySys.formObj["VALUE1_"+e],BX.crmPaySys.orderFields);this.showSelectorField(e)},setPaymentFields:function(e){this.insertOptions(BX.crmPaySys.formObj["VALUE1_"+e],BX.crmPaySys.paymentFields);this.showSelectorField(e)},setOrderProps:function(e){var t=BX.crmPSPersonType.getId();var a=BX.crmPaySys.orderProps[t];var i=BX.crmPSActionFile.getId();var s="bill";if(i.indexOf("quote")>=0)s="quote";if(typeof BX.crmPaySys.userFields[s]!=="undefined"){a=BX.clone(a);var r=BX.crmPaySys.userFields[s];for(var l in r){if(!r.hasOwnProperty(l)){continue}a[l]=r[l]}}this.insertOptions(BX.crmPaySys.formObj["VALUE1_"+e],a);this.showSelectorField(e)},setRequisiteFields:function(e){this.rebuildSelect(BX.crmPaySys.formObj["VALUE1_"+e],BX.crmPaySys.requisiteFields,"");this.showSelectorField(e)},setBankDetailFields:function(e){this.rebuildSelect(BX.crmPaySys.formObj["VALUE1_"+e],BX.crmPaySys.bankDetailFields);this.showSelectorField(e)},rebuildSelect:function(e,t,a){var i,s,r,l,n;var o=false;var d,c;var m=null;if(!(a instanceof Array))a=[a];if(e){d=!!e.getAttribute("multiple");while(i=e.lastChild)e.removeChild(i);s=0;for(l=0;l<t.length;l++){c=false;if(t[l]["type"]){if(t[l]["type"]==="group"){r=document.createElement("optgroup");r.label=t[l]["title"];c=true}else if(t[l]["type"]==="endgroup"){m=null;continue}}else{r=document.createElement("option");r.value=t[l]["id"];r.innerHTML=BX.util.htmlspecialchars(t[l]["title"])}if(!c&&m)m.appendChild(r);else e.appendChild(r);if(c){m=r}else{if(!o||d){for(n=0;n<a.length;n++){if(t[l]["id"]==a[n]){r.selected=true;if(!o){o=true;e.selectedIndex=s}break}}}s++}}}},setCompanyFields:function(e){this.insertOptions(BX.crmPaySys.formObj["VALUE1_"+e],BX.crmPaySys.companyFields);this.showSelectorField(e)},setUserColumnsFields:function(e){this.insertOptions(BX.crmPaySys.formObj["VALUE1_"+e],BX.crmPaySys.userColumnFields);this.showSelectorField(e)},setContactFields:function(e){this.insertOptions(BX.crmPaySys.formObj["VALUE1_"+e],BX.crmPaySys.contactFields);this.showSelectorField(e)},setOtherProps:function(e){BX.crmPaySys.formObj["VALUE2_"+e].value="";this.showInputField(e)},showSelectorField:function(e,t){var a=!t;if(BX("VALUE1_"+e))BX("VALUE1_"+e).style.display=a?"":"none";if(BX("VALUE2_"+e))BX("VALUE2_"+e).style.display=a?"none":""},showInputField:function(e){this.showSelectorField(e,true)},insertOptions:function(e,t){var a=e.value;e.options.length=0;for(var i in t){var s=document.createElement("option");s.value=i;s.text=t[i];try{e.add(s,null)}catch(t){e.add(s)}}e.value=a},hideItems:function(e){var t=!e;var a={};var i,s;for(i=0,l=BX.crmPaySys.formObj.elements.length;i<l;i++){if(!/^TYPE_/.test(BX.crmPaySys.formObj.elements[i].name))continue;s=BX.crmPaySys.formObj.elements[i];if(s&&s.value!="SELECT"&&s.value!="FILE"&&s.value!="CHECKBOX"&&s.value!="USER_COLUMN_LIST"){s.style.display=t?"none":"";if(t){BX.remove(s.nextElementSibling)}else{s.style.marginBottom="5px";s.parentNode.insertBefore(BX.create("br"),s.nextElementSibling)}}if(s&&(s.value===""||s.value==="SELECT"||s.value==="FILE"||s.value==="CHECKBOX")){var r=BX.findParent(s,{className:"bx-edit-tab-inner"},true);var n=r.getAttribute("id");var o=n.substring(10);a[o]=true}}for(i in this.aTabs){if(!a.hasOwnProperty(this.aTabs[i])){var d=BX("tab_cont_"+this.aTabs[i]);d.style.display=t?"none":""}}if(t){var c=false;var m;for(m in BX.crmPSPropType.aTabs){if(!a.hasOwnProperty(BX.crmPSPropType.aTabs[m])){d=BX("tab_cont_"+BX.crmPSPropType.aTabs[m]);d.style.display="none";if(c===false)c=BX.findChildByClassName(d,"bx-tab-selected",true)!==null}}if(c){for(m in BX.crmPSPropType.aTabs){d=BX("tab_cont_"+BX.crmPSPropType.aTabs[m]);if(d.style.display!=="none"){BX.crmPSPropType.ShowTab(BX.crmPSPropType.aTabs[m],true);BX.crmPSPropType.SelectTab(BX.crmPSPropType.aTabs[m]);break}}}}},showItems:function(){this.hideItems(true)},ShowTab:function(e,t){var a=t?"-selected":"";document.getElementById("tab_cont_"+e).className="bx-tab-container"+a;document.getElementById("tab_left_"+e).className="bx-tab-left"+a;document.getElementById("tab_"+e).className="bx-tab"+a;document.getElementById("tab_right_"+e).className="bx-tab-right"+a},HoverTab:function(e,t){var a=document.getElementById("tab_"+e);if(a.className=="bx-tab-selected")return;document.getElementById("tab_left_"+e).className=t?"bx-tab-left-hover":"bx-tab-left";a.className=t?"bx-tab-hover":"bx-tab";var i=document.getElementById("tab_right_"+e);i.className=t?"bx-tab-right-hover":"bx-tab-right"},SelectTab:function(e){var t=document.getElementById("inner_tab_"+e);if(t.style.display!="none")return;for(var a=0,i=this.aTabs.length;a<i;a++){var s=document.getElementById("inner_tab_"+this.aTabs[a]);if(s.style.display!="none"){this.ShowTab(this.aTabs[a],false);s.style.display="none";break}}this.ShowTab(e,true);t.style.display="block";var r=document.getElementById(this.name+"_active_tab");if(r)r.value=e}};BX.crmPSActionFile={documentHandler:"invoicedocument",arFields:{},arFieldsList:{},arSavedFields:{},typeValuesTmpl:"",fileValuesTmpl:"",selectValuesTmpl:"",userColValuesTmpl:"",userPropsListTmpl:"",checkboxValuesTmpl:"",hiddenFieldList:null,groups:null,init:function(e){this.hiddenFieldList=["PS_IS_TEST","PS_CHANGE_STATUS_PAY","PAYPAL_SSL_ENABLE","PAYPAL_ON0","PAYPAL_ON1","PAYPAL_IDENTITY_TOKEN","PAYPAL_RETURN","PAYPAL_NOTIFY_URL","PAYPAL_BUTTON_SRC","PAYPAL_BUSINESS"];for(var t in e)this[t]=e[t];var a=BX.crmPaySys.formObj["ACTION_FILE"];if(a)BX.bind(a,"change",BX.delegate(BX.crmPSActionFile.onSelect,this));if(BX.crmPaySys.simpleMode)this.hideNoneSimpleRows()},getId:function(){return BX.crmPaySys.formObj["ACTION_FILE"].value},onSelect:function(){if(BX("SECURITY"))BX.remove(BX("SECURITY"));this.getAjaxFields()},getAjaxFields:function(e){var t=this.getId();if(this.arFields[t]&&BX("ACTION_FILE").value!==this.documentHandler){BX.crmPSPropType.aTabs=[];for(var a in this.arFields[t]){if(this.arFields[t].hasOwnProperty(a))BX.crmPSPropType.aTabs.push(a)}this.insertFields(t,this.arFields[t]);if(this.arFieldsList[t])this.setFieldsList(this.arFieldsList[t]);BX.crmPaySys.getTemplatePreview();return}var i={id:t,action:"get_fields",person_type:BX.crmPSPersonType.getId(),sessid:BX.bitrix_sessid()};var s=BX("frame");s.parentNode.style.opacity="0.5";BX.ajax({data:i,method:"POST",dataType:"json",url:BX.crmPaySys.url+"/ajax.php",onsuccess:BX.delegate(function(e){var t=BX("frame");if(e.ERROR){BX.debug("BX.crmPSActionFile.getAjaxFields: "+e.ERROR)}else{if(e.hasOwnProperty("NAME")&&e.NAME){for(var a in BX.crmPaySys.formObj.elements){if(BX.crmPaySys.formObj.elements.hasOwnProperty(a)){if(BX.crmPaySys.formObj.elements[a].name=="NAME"){BX.crmPaySys.formObj.elements[a].value=e.NAME;break}}}}BX("MODE_SWITCHER").style.display="inline";BX("bx-tabs").style.display="table";BX("bx-tabs").nextElementSibling.style.display="table";if(e.GROUP_LIST)this.groups=e.GROUP_LIST;if(e.FIELDS_BY_GROUP){BX.crmPSPropType.aTabs=[];for(var a in e.FIELDS_BY_GROUP){if(e.FIELDS_BY_GROUP.hasOwnProperty(a))BX.crmPSPropType.aTabs.push(a)}this.arFields[this.getId()]=e.FIELDS_BY_GROUP;this.insertFields(this.getId(),e.FIELDS_BY_GROUP)}if(e.FIELDS_LIST){this.arFieldsList[this.getId()]=e.FIELDS_LIST;this.setFieldsList(e.FIELDS_LIST)}var i=BX.crmPaySys.formObj["PS_MODE"];if(i){BX.remove(i.parentNode.parentNode)}this.onHandlerModeChange();var s=BX.crmPaySys.formObj["ACTION_FILE"].parentNode.parentNode;if(e.PS_MODE_LIST||BX("ACTION_FILE").value===this.documentHandler){var r=[];if(e.PS_MODE_LIST){var l=BX.create("select",{attrs:{name:"PS_MODE",id:"PS_MODE"}});BX.crmPSPropType.insertOptions(l,e.PS_MODE_LIST);BX.bind(l,"change",function(){BX.crmPSActionFile.onHandlerModeChange()});r.push(l)}if(BX("ACTION_FILE").value===this.documentHandler){var n=BX.create("span",{text:BX.message("CRM_TEMPLATE_DOCUMENT_ADD"),attrs:{class:"bx-button-add-template",style:"margin-left: 5px"}});BX.bind(n,"click",function(){BX.SidePanel.Instance.open(e.INVOICE_DOC_ADD_LINK,{width:930,events:{onCloseComplete:function(){BX.crmPSActionFile.onSelect(BX("ACTION_FILE"))}}})});r.push(n)}var o=BX.create("tr",{children:[BX.create("td",{props:{className:"bx-field-name bx-padding"},text:e.PAYMENT_MODE_TITLE+":"}),BX.create("td",{props:{className:"bx-field-value"},children:r})]});BX.insertAfter(o,s)}if(e.TEMPLATE){this.reloadPreview(e.TEMPLATE);BX.crmPaySys.bindInputsChange()}else{t.parentNode.style.display="none"}}t.parentNode.style.opacity="1"},this),onfailure:function(){BX.debug("onfailure: BX.crmPSActionFile.getAjaxFields")}})},onHandlerModeChange:function(){var e=BX("ACTION_FILE").value.indexOf(this.documentHandler)===0;BX("MODE_SWITCHER").style.display=e?"none":"table";BX("bx-tabs").style.display=e?"none":"table";BX("bx-tabs").nextElementSibling.style.display=e?"none":"table"},reloadPreview:function(e){var t=BX("frame");t.parentNode.style.display="block";var a=BX.create("base");a.href=window.location.href;t.contentDocument.open();t.contentDocument.close();t.contentDocument.head.appendChild(a);t.contentDocument.body.innerHTML=e;var i=t.contentWindow.document;if(i){var s=BX.findChild(i.body,{tag:"div"});if(s)s.style.height="100%"}t.onload=function(){var e=t.contentWindow.document;if(e){var a=BX.findChild(e.body,{tag:"div"});if(a)a.style.height="100%"}}},saveFields:function(){for(var e=0,t=BX.crmPaySys.formObj.elements.length;e<t;e++){if(!/^TYPE_/.test(BX.crmPaySys.formObj.elements[e].name))continue;var a=BX.crmPaySys.formObj.elements[e].name.replace(/^TYPE_/,"");this.arSavedFields[a]={};this.arSavedFields[a].TYPE=BX.crmPaySys.formObj["TYPE_"+a].value;switch(this.arSavedFields[a].TYPE){case"FILE":var i=BX(a+"_preview_img");if(i){this.arSavedFields[a].SRC=i.getAttribute("src");this.arSavedFields[a].HEIGHT=i.getAttribute("height");this.arSavedFields[a].WIDTH=i.getAttribute("width")}break;case"SELECT":var s=BX("VALUE1_"+a);var r={};for(var l=0;l<s.options.length;l++)r[s.options[l].value]=s.options[l].text;this.arSavedFields[a].VALUE1=s.value;this.arSavedFields[a].OPTIONS=r;break;case"CHECKBOX":var s=BX("VALUE1_"+a);if(s.checked)this.arSavedFields[a].VALUE1="Y";break;default:var s=BX("VALUE1_"+a);var n=BX("VALUE2_"+a);if(s)this.arSavedFields[a].VALUE1=s.value;if(n)this.arSavedFields[a].VALUE2=n.value}}},restoreFields:function(){if(this.arSavedFields){for(var e in this.arSavedFields){var t=BX("TYPE_"+e);if(t)t.value=this.arSavedFields[e]["TYPE"];switch(t.value){case"FILE":var a=BX(e+"_preview_img");if(a&&this.arSavedFields[e]&&this.arSavedFields[e].SRC){a.setAttribute("src",this.arSavedFields[e].SRC);a.setAttribute("height",this.arSavedFields[e].HEIGHT);a.setAttribute("width",this.arSavedFields[e].WIDTH)}else{BX(e+"_preview").style.display="none"}break;case"SELECT":var i=BX("VALUE1_"+e);if(this.arSavedFields[fieldId]){BX.crmPSPropType.insertOptions(i,this.arSavedFields[e].OPTIONS);i.value=this.arSavedFields[e].VALUE1}else{i.value=0}break;case"CHECKBOX":var i=BX("VALUE1_"+e);if(this.arSavedFields[e].VALUE1=="Y")i.checked=true;break;default:var i=BX("VALUE1_"+e);var s=BX("VALUE2_"+e);i.value=this.arSavedFields[e]["VALUE1"];if(s)s.value=this.arSavedFields[e]["VALUE2"]}}}},insertFields:function(e,t){this.removeFields();var a=BX("bx-tabs");if(a){var s=BX.findChildByClassName(a,"bx-tab-indent",true);var r=s.nextElementSibling;for(c in t){var l=BX.create("td",{attrs:{id:"tab_cont_"+c,className:"bx-tab-container",onclick:"BX.crmPSPropType.SelectTab('"+c+"');",onmouseover:"BX.crmPSPropType.HoverTab('"+c+"', true);",onmouseout:"BX.crmPSPropType.HoverTab('"+c+"', false);"}});var n=BX.create("table",{attrs:{cellspacing:"0"},children:[BX.create("tr",{children:[BX.create("td",{attrs:{className:"bx-tab-left",id:"tab_left_"+c},children:[BX.create("div",{attrs:{className:"empty"}})]}),BX.create("td",{text:this.groups[c].NAME,attrs:{className:"bx-tab",id:"tab_"+c}}),BX.create("td",{attrs:{className:"bx-tab-right",id:"tab_right_"+c},children:[BX.create("div",{attrs:{className:"empty"}})]})]})]});l.appendChild(n);s.parentNode.insertBefore(l,r)}}var o=a.nextElementSibling;var d=BX.findChild(o,{tag:"td"},true);for(var c in t){i=0;var m=3;var f=BX.create("div",{attrs:{id:"inner_tab_"+c,className:"bx-edit-tab-inner"},children:[BX.create("div",{attrs:{className:"bx-edit-table"},children:[BX.create("table",{attrs:{className:"bx-edit-table",id:c+"_edit_table"}})]})]});f.style.display="none";d.appendChild(f);n=BX(c+"_edit_table");var u=t[c];for(var S in u){if(S==="USER_COLUMNS")continue;i++;if(i%m===0&&(S.indexOf("BILLUA_COLUMN_SUM_")>=0||S.indexOf("BILLUA_COLUMN_PRICE_")>=0))m=4;else m=3;var p=this.makeRow(S,u[S]);n.appendChild(p);if(c==="COLUMN_SETTINGS"&&i%m===0){n.appendChild(this.makeEmptyRow());i=0}var y=BX("TYPE_"+S);if(!y)continue;if(this.arSavedFields[S]&&this.arSavedFields[S].TYPE)y.value=this.arSavedFields[S].TYPE;else y.value=u[S].TYPE=="VALUE"?"":u[S].TYPE;BX.crmPSPropType.replaceValueField(y);if(BX.crmPaySys.simpleMode){if(y.value!=""&&y.value!="SELECT"&&y.value!="FILE"&&y.value!="CHECKBOX"&&y.value!="USER_COLUMN_LIST")p.style.display="none";if(this.hiddenFieldList.indexOf(S)!==-1)p.style.display="none";y.style.display="none"}else if(y&&y.value!="SELECT"&&y.value!="FILE"&&y.value!="CHECKBOX"&&y.value!="USER_COLUMN_LIST"){y.style.marginBottom="5px";y.parentNode.insertBefore(BX.create("br"),y.nextElementSibling)}switch(y.value){case"FILE":var h=BX(S+"_preview_img");if(h&&this.arSavedFields[S]&&this.arSavedFields[S].SRC){h.setAttribute("src",this.arSavedFields[S].SRC);h.setAttribute("height",this.arSavedFields[S].HEIGHT);h.setAttribute("width",this.arSavedFields[S].WIDTH)}else{BX(S+"_preview").style.display="none"}break;case"SELECT":var v=BX("VALUE1_"+S);if(this.arSavedFields[S]){BX.crmPSPropType.insertOptions(v,this.arSavedFields[S].OPTIONS);v.value=this.arSavedFields[S].VALUE1}else{BX.crmPSPropType.insertOptions(v,u[S].VALUE)}break;case"CHECKBOX":var B=BX("VALUE1_"+S);if(this.arSavedFields[S]){if(this.arSavedFields[S].VALUE1=="Y")B.checked=true}else if(u[S].VALUE=="Y"){B.checked=true}break;case"VALUE":case"":var v=BX("VALUE2_"+S);if(v&&v!=""){if(this.arSavedFields[S]&&this.arSavedFields[S].VALUE2)v.value=this.arSavedFields[S].VALUE2;else if(u[S].VALUE)v.value=u[S].VALUE;else v.value=""}break;default:var v=BX("VALUE1_"+S);if(v&&v!=""){v.value=this.arSavedFields[S]&&this.arSavedFields[S].VALUE1?this.arSavedFields[S].VALUE1:u[S].VALUE}}}if(c==="COLUMN_SETTINGS"){l=BX.create("td",{attrs:{colspan:2}});l.innerHTML=this.userPropsListTmpl;n.appendChild(BX.create("tr",{attrs:{id:"ADD_USER_PROP",style:"text-align: center;"},children:[l]}))}}this.hideNoneSimpleRows(!BX.crmPaySys.simpleMode);BX.crmPSPropType.bindEvents()},makeRow:function(e,t){var a=document.createElement("tr"),i=document.createElement("td"),s=document.createElement("td");i.className="bx-field-name bx-padding bx-props-field-width";i.title=t.DESCR;i.innerHTML=t.NAME+":";a.appendChild(i);var r="";switch(t.TYPE){case"FILE":r=this.fileValuesTmpl.replace(/\#FIELD_ID\#/g,e);break;case"SELECT":r=this.selectValuesTmpl.replace(/\#FIELD_ID\#/g,e);break;case"CHECKBOX":r=this.checkboxValuesTmpl.replace(/\#FIELD_ID\#/g,e);break;default:r=this.typeValuesTmpl.replace(/\#FIELD_ID\#/g,e)}s.className="bx-field-value";s.innerHTML=r;a.appendChild(s);return a},makeEmptyRow:function(){return BX.create("tr",{children:[BX.create("td",{attrs:{colspan:2}})]})},removeFields:function(){var e=BX("bx-tabs");if(e){var t=BX.findChildByClassName(e,"bx-tab-indent",true);t=t.nextElementSibling;while(t.nextElementSibling){var a=t.nextElementSibling;BX.remove(t);t=a}}var i=e.nextElementSibling;if(i){var s=BX.findChildrenByClassName(i,"bx-edit-tab-inner",true);for(var r in s){if(s.hasOwnProperty(r))BX.remove(s[r])}}BX.PopupMenu.destroy("user-props-list")},setFieldsList:function(e){var t=BX.crmPaySys.formObj["PS_ACTION_FIELDS_LIST"];if(t)t.value=e},hideNoneSimpleRows:function(e){var t={};var a=null;var i=!e;var s=null;for(var r=0,l=BX.crmPaySys.formObj.elements.length;r<l;r++){if(!/^TYPE_/.test(BX.crmPaySys.formObj.elements[r].name))continue;var n=BX.crmPaySys.formObj[BX.crmPaySys.formObj.elements[r].name];if(!n||n.value==""||n.value=="SELECT"||n.value=="FILE"||n.value=="CHECKBOX"||n.value=="USER_COLUMN_LIST"){var o=BX.crmPaySys.formObj.elements[r].name;o=o.substr(5);if(this.hiddenFieldList.indexOf(o)===-1){a=BX.findParent(n,{className:"bx-edit-tab-inner"},true);var d=a.getAttribute("id");var c=d.substring(10);t[c]=true;continue}}var m=n.parentNode.parentNode;if(m)m.style.display=i?"none":"";if(s===null)s=m.parentNode}var f=false,u=false;var S;for(S in BX.crmPSPropType.aTabs){var p=BX("tab_cont_"+BX.crmPSPropType.aTabs[S]);if(!t.hasOwnProperty(BX.crmPSPropType.aTabs[S])){p.style.display=i?"none":"";if(i&&f===false)f=BX.findChildByClassName(p,"bx-tab-selected",true)!==null}else if(u==false){u=BX.findChildByClassName(p,"bx-tab-selected",true)!==null}}if(f===true||u==false){for(S in t){if(t.hasOwnProperty(S)){BX.crmPSPropType.ShowTab(S,true);BX.crmPSPropType.SelectTab(S);break}}}if(!s)return;var y=true;a=null;var h=s.children;for(r=0;r<h.length;r++){var v=h[r];if(v.childElementCount===1){if(a!==null&&y===true)a.style.display=i?"none":"";y=true;a=v}else{if(y===true)y=v.style.display==="none"||e}}},showNoneSimpleRows:function(){this.hideNoneSimpleRows(true)},addUserColumn:function(e,t){var a=BX("ACTION_FILE").value;var i=BX("ADD_USER_PROP");var s=["NAME","SORT","ACTIVE"];for(var r in s){var l="USER_COLUMNS["+e+"]["+s[r]+"]";if(BX("VALUE1_"+l)||BX("VALUE2_"+l)){alert(BX.message("CRM_PROP_ALREADY_EXIST"));return}var n="";if(s[r]==="NAME")n=t;else if(s[r]==="SORT")n=1e3;this.arFields[a]["COLUMN_SETTINGS"][l]={NAME:BX.message("CRM_COLUMN_"+s[r])+(s[r]==="NAME"?t:""),SORT:1e3,GROUP:"COLUMN_SETTINGS",TYPE:s[r]==="ACTIVE"?"CHECKBOX":"",VALUE:n,DESCR:""};var o=this.makeRow(l,this.arFields[a]["COLUMN_SETTINGS"][l]);i.parentNode.insertBefore(o,i);var d=BX("TYPE_"+l);BX.crmPSPropType.replaceValueField(d);if(BX.crmPaySys.simpleMode)d.style.display="none";if(!BX.crmPaySys.simpleMode&&s[r]!=="ACTIVE"){d.style.marginBottom="5px";d.parentNode.insertBefore(BX.create("br"),d.nextElementSibling)}if(s[r]==="ACTIVE")BX("VALUE1_"+l).checked=true;var c=BX("VALUE2_"+l);if(c&&c!="")c.value=this.arFields[a]["COLUMN_SETTINGS"][l]["VALUE"]}i.parentNode.insertBefore(this.makeEmptyRow(),i);BX.crmPaySys.bindInputsChange();BX.crmPaySys.getTemplatePreview();BX.PopupMenu.destroy("user-props-list")}};