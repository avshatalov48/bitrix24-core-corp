{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {UI} from 'ui.notification';\nimport {MenuManager, PopupManager} from \"main.popup\";\nimport {Tag, Loc, Type, Dom, Reflection} from \"main.core\";\nimport {EventEmitter} from \"main.core.events\";\nimport {Loader} from \"main.loader\";\n\n\nconst namespace = Reflection.namespace('BX.Crm');\n\nexport class DedupeAutosearch\n{\n\tconstructor()\n\t{\n\t\tthis._componentName = '';\n\t\tthis._componentSignedParams = '';\n\t\tthis._entityTypeId = 0;\n\t\tthis._instanceId = '';\n\t\tthis._internalMergeStatus = '';\n\t\tthis._mergeCheckerTimeoutId = null;\n\t\tthis._mergerUrl = '';\n\t\tthis._dedupeListUrl = '';\n\t\tthis._execInterval = null;\n\t\tthis._intervalsList = [];\n\t\tthis._isDropdownMenuShown = false;\n\t\tthis._selectedExecInterval = null;\n\t\tthis._selectedExecIntervalNode = null;\n\t\tthis._status = '';\n\t\tthis._infoHelperId = '';\n\t\tthis._progressData = {};\n\n\t\tthis._settingsPopupId = 'autosearch-settings-popup';\n\t}\n\n\tinitialize(params)\n\t{\n\t\tthis._componentName = BX.prop.getString(params, 'componentName', '');\n\t\tthis._componentSignedParams = BX.prop.getString(params, 'signedParameters', '');\n\t\tthis._entityTypeId = BX.prop.getInteger(params, 'entityTypeId', 0);\n\t\tthis._instanceId = BX.Text.getRandom(8);\n\t\tthis._internalMergeStatus = 'waiting';\n\t\tthis._mergerUrl = BX.prop.getString(params, 'mergerUrl', '');\n\t\tthis._dedupeListUrl = BX.prop.getString(params, 'dedupeListUrl', '');\n\t\tthis._execInterval = BX.prop.getString(params, 'selectedInterval', '0');\n\t\tthis._intervalsList = BX.prop.getArray(params, 'intervals', []);\n\t\tthis._status = BX.prop.getString(params, 'status', '');\n\t\tthis._infoHelperId = BX.prop.getString(params, 'infoHelperId', '');\n\t\tthis._progressData = BX.prop.getObject(params, 'progressData', {});\n\n\t\tthis.tryToStartMerge(true);\n\n\t\tthis.subscribeEvents();\n\t}\n\n\tsubscribeEvents()\n\t{\n\t\tif (BX.PULL)\n\t\t{\n\t\t\tBX.PULL.subscribe({\n\t\t\t\ttype: BX.PullClient.SubscriptionType.Server,\n\t\t\t\tmoduleId: 'crm',\n\t\t\t\tcommand: 'dedupe.autosearch.startMerge',\n\t\t\t\tcallback: (params) =>\n\t\t\t\t{\n\t\t\t\t\tif (BX.prop.getInteger(params, 'entityTypeId', 0) === this._entityTypeId)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis._status = BX.prop.getString(params, 'status', '');\n\t\t\t\t\t\tthis._progressData = BX.prop.getObject(params, 'progressData', {});\n\n\t\t\t\t\t\tif (this._status === 'MERGING')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet notification = UI.Notification.Center.getBalloonById('crm.autosearch.start_merge');\n\t\t\t\t\t\t\tif (notification)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tnotification.close();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis.tryToStartMerge();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t\tBX.PULL.subscribe({\n\t\t\t\ttype: BX.PullClient.SubscriptionType.Server,\n\t\t\t\tmoduleId: 'crm',\n\t\t\t\tcommand: 'dedupe.autosearch.mergeComplete',\n\t\t\t\tcallback: (params) =>\n\t\t\t\t{\n\t\t\t\t\tif (BX.prop.getInteger(params, 'entityTypeId', 0) === this._entityTypeId)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst data = BX.prop.getObject(params, 'data', {});\n\t\t\t\t\t\tthis._status =  BX.prop.getInteger(data, 'CONFLICT_COUNT', 0) > 0 ?\n\t\t\t\t\t\t\t'CONFLICTS_RESOLVING' : '';\n\t\t\t\t\t\tclearTimeout(this._mergeCheckerTimeoutId);\n\t\t\t\t\t\tthis.showMergeCompleteNotification(data);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\tEventEmitter.subscribe('onLocalStorageSet', this.onExternalEvent.bind(this));\n\t}\n\n\tshowSettings()\n\t{\n\t\tthis._selectedExecInterval = this._execInterval;\n\t\tconst popup = PopupManager.create({\n\t\t\tid: this._settingsPopupId,\n\t\t\tcacheable: false,\n\t\t\ttitleBar: Loc.getMessage('CRM_DP_AUTOSEARCH_SETTINGS_TITLE'),\n\t\t\tcontent: this.needLoadConflictsCount() ? this.getSettingsPopupLoader() : this.getSettingsPopupContent(),\n\t\t\tcloseByEsc: true,\n\t\t\tcloseIcon: true,\n\t\t\tdraggable: true,\n\t\t\twidth: 500,\n\t\t\tbuttons: [\n\t\t\t\tnew BX.UI.SaveButton({\n\t\t\t\t\tonclick: () =>\n\t\t\t\t\t{\n\t\t\t\t\t\tpopup.close();\n\t\t\t\t\t\tthis.saveSelectedExecInterval();\n\t\t\t\t\t}\n\t\t\t\t}),\n\t\t\t\tnew BX.UI.CancelButton({\n\t\t\t\t\tonclick: () =>\n\t\t\t\t\t{\n\t\t\t\t\t\tpopup.close();\n\t\t\t\t\t}\n\t\t\t\t}),\n\t\t\t]\n\t\t});\n\t\tpopup.show();\n\t\tif (this.needLoadConflictsCount())\n\t\t{\n\t\t\tthis.loadConflictsCount()\n\t\t\t\t.then((conflictsCount) =>\n\t\t\t\t{\n\t\t\t\t\tpopup.setContent(this.getSettingsPopupContent(conflictsCount));\n\t\t\t\t\tpopup.adjustPosition();\n\t\t\t\t}, () => {\n\t\t\t\t\tpopup.setContent(this.getSettingsPopupContent(0));\n\t\t\t\t\tpopup.adjustPosition();\n\t\t\t\t});\n\t\t}\n\t}\n\n\ttryToStartMerge(immediately = false)\n\t{\n\t\tif (this._status === 'READY_TO_MERGE')\n\t\t{\n\t\t\tthis.showStartConfirmation();\n\t\t}\n\t\tif (this._status === 'MERGING')\n\t\t{\n\t\t\tthis.startMerging(immediately ? 1 : this.getShortTimeout());\n\t\t}\n\t\tif (this._status === 'CONFLICTS_RESOLVING')\n\t\t{\n\t\t\tthis.showMergeCompleteNotification(this._progressData);\n\t\t}\n\t}\n\n\tshowStartConfirmation()\n\t{\n\t\tif (!BX.prop.getBoolean(this._progressData, 'SHOW_NOTIFICATION', true))\n\t\t{\n\t\t\t// message was already shown in this session\n\t\t\treturn;\n\t\t}\n\t\tconst entityTypeName = BX.CrmEntityType.resolveName(this._entityTypeId);\n\t\tconst foundItemsCount = BX.prop.getInteger(this._progressData, 'FOUND_ITEMS', 0);\n\t\tconst totalEntitiesCount = BX.prop.getInteger(this._progressData, 'TOTAL_ENTITIES', 0);\n\t\tconst notificationContent = Tag.render`\n\t\t\t<span>\n\t\t\t\t${Loc.getMessage('CRM_DP_AUTOSEARCH_START_CONFIRMATION_TEXT_' + entityTypeName)\n\t\t\t\t\t.replace('#FOUND_ITEMS_COUNT#', foundItemsCount)\n\t\t\t\t\t.replace('#TOTAL_ENTITIES_COUNT#', totalEntitiesCount)}\n\t\t\t\t<br>\n\t\t\t\t${Loc.getMessage('CRM_DP_AUTOSEARCH_START_CONFIRMATION_TEXT')}\n\t\t\t\t<span class=\"ui-hint notification-hint-inline\">\n\t\t\t\t\t<span class=\"ui-hint-icon\" onclick=\"${this.onHintClick.bind(this)}\"></span>\n\t\t\t\t</span>\n\t\t\t</span>`;\n\t\tUI.Notification.Center.notify({\n\t\t\tcontent: notificationContent,\n\t\t\tautoHide: false,\n\t\t\tid: 'crm.autosearch.start_merge',\n\t\t\twidth: 600,\n\t\t\tactions: [\n\t\t\t\t{\n\t\t\t\t\ttitle: Loc.getMessage('CRM_DP_AUTOSEARCH_START_CONFIRMATION_BUTTON'),\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: (event, balloon, action) =>\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.showSettings();\n\t\t\t\t\t\t\tballoon.close();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t],\n\t\t\tevents: {\n\t\t\t\tonOpen: function(event)\n\t\t\t\t{\n\t\t\t\t\tvar balloon = event.getBalloon();\n\t\t\t\t\tBX.UI.Hint.init(balloon.getContainer());\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tshowMergeCompleteNotification(data)\n\t{\n\t\tif (!BX.prop.getBoolean(data, 'SHOW_NOTIFICATION', true))\n\t\t{\n\t\t\t// message was already shown in this session\n\t\t\treturn;\n\t\t}\n\n\t\tconst entityTypeName = BX.CrmEntityType.resolveName(this._entityTypeId);\n\t\tconst successCount = BX.prop.getInteger(data, 'SUCCESS_COUNT', 0);\n\t\tconst conflictsCount = BX.prop.getInteger(data, 'CONFLICT_COUNT', 0);\n\n\t\tif (successCount === 0 && conflictsCount === 0)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet message = Tag.render`<div></div>`;\n\t\tconst automaticallyFoundText = successCount > 0 ?\n\t\t\tLoc.getMessage('CRM_DP_AUTOSEARCH_COMPLETE_TEXT_' + entityTypeName)\n\t\t\t\t.replace('#FOUND_ITEMS_COUNT#', successCount)\n\t\t\t:\n\t\t\tLoc.getMessage('CRM_DP_AUTOSEARCH_EMPTY_RESULTS_' + entityTypeName);\n\t\tDom.append(\n\t\t\tTag.render`<div>${automaticallyFoundText}</div>`,\n\t\t\tmessage\n\t\t);\n\t\tlet actions = [];\n\t\tlet notificationWidth = 400;\n\t\tif (conflictsCount > 0)\n\t\t{\n\t\t\tDom.append(Tag.render`<div>${Loc.getMessage('CRM_DP_AUTOSEARCH_COMPLETE_CONFLICTED_TEXT').replace('#CONFLICTS_COUNT#', conflictsCount)}</div>`, message);\n\t\t\tactions.push({\n\t\t\t\ttitle: Loc.getMessage('CRM_DP_AUTOSEARCH_COMPLETE_RESOLVE_CONFLICT_BUTTON'),\n\t\t\t\tevents: {\n\t\t\t\t\tclick: (event, balloon, action) =>\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.openMerger();\n\t\t\t\t\t\tballoon.close();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tnotificationWidth = 670;\n\t\t}\n\t\tUI.Notification.Center.notify({\n\t\t\tcontent: message,\n\t\t\tautoHide: false,\n\t\t\tid: 'crm.autosearch.merge_complete',\n\t\t\twidth: notificationWidth,\n\t\t\tactions: actions\n\t\t});\n\t}\n\n\tsaveSelectedExecInterval()\n\t{\n\t\tthis._execInterval = this._selectedExecInterval;\n\t\tBX.ajax.runComponentAction(\n\t\t\tthis._componentName,\n\t\t\t'setExecInterval',\n\t\t\t{\n\t\t\t\tmode: 'class',\n\t\t\t\tsignedParameters: this._componentSignedParams,\n\t\t\t\tdata: {\n\t\t\t\t\tinterval: this._selectedExecInterval\n\t\t\t\t}\n\t\t\t});\n\t}\n\n\tstartMerging(timeout)\n\t{\n\t\tconst p = new Promise((resolve, reject) => {\n\t\t\tthis.askIfNoActiveMerging(timeout, resolve);\n\t\t});\n\t\tp.then(() => this.doMerge());\n\t}\n\n\tdoMerge()\n\t{\n\t\tBX.ajax.runComponentAction(\n\t\t\tthis._componentName,\n\t\t\t'merge',\n\t\t\t{\n\t\t\t\tmode: 'class',\n\t\t\t\tsignedParameters: this._componentSignedParams,\n\t\t\t\tdata: {\n\t\t\t\t\tmergeId: this._instanceId\n\t\t\t\t}\n\t\t\t}).then((response) =>\n\t\t\t{\n\t\t\t\tconst data = BX.prop.getObject(response, \"data\", {});\n\t\t\t\tconst instanceId = BX.prop.getString(data, \"MERGE_ID\", \"\");\n\t\t\t\tif (instanceId === this._instanceId)\n\t\t\t\t{\n\t\t\t\t\tconst status = BX.prop.getString(data, \"STATUS\", \"\");\n\n\t\t\t\t\tif (status !== \"COMPLETED\")\n\t\t\t\t\t{\n\t\t\t\t\t\twindow.setTimeout(() => this.doMerge(), 400);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.startMerging(this.getLongTimeout());\n\t\t\t\t}\n\t\t\t},\n\t\t\t(response) =>\n\t\t\t{\n\t\t\t\tthis.startMerging(this.getShortTimeout());\n\t\t\t}\n\t\t);\n\t}\n\n\tgetSettingsPopupLoader()\n\t{\n\t\tconst loaderContainer = Tag.render`<div></div>`;\n\t\tloaderContainer.style.height = '180px';\n\n\t\tconst loader = new Loader({\n\t\t\ttarget: loaderContainer\n\t\t});\n\t\tsetTimeout(() => {\n\t\t\tloader.show();\n\t\t}, 10);\n\t\treturn loaderContainer;\n\t}\n\n\tgetSettingsPopupContent(conflictsCount)\n\t{\n\t\tconst selectedExecInterval =\n\t\t\tthis._intervalsList.reduce((prev, item) => (item.value === this._selectedExecInterval ? item.title : prev), '');\n\n\t\tthis._selectedExecIntervalNode = Tag.render`<div class=\"ui-ctl-element\">${selectedExecInterval}</div>`;\n\t\treturn Tag.render`\n\t\t\t<div>\n\t\t\t\t${this.getConflictsInfo(conflictsCount)}\n\t\t\t\t<p>${Loc.getMessage('CRM_DP_AUTOSEARCH_SETTINGS_NOTE')}</p>\n\t\t\t\t<div class=\"ui-ctl-label-text\">${Loc.getMessage('CRM_DP_AUTOSEARCH_SETTINGS_INTERVAL_TITLE')}</div>\n\t\t\t\t<div class=\"ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100\" onclick=\"${this.toggleIntervalsList.bind(this)}\">\n\t\t\t\t\t${this._selectedExecIntervalNode}\n\t\t\t\t\t<div class=\"ui-ctl-after ui-ctl-icon-angle\"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\tneedLoadConflictsCount()\n\t{\n\t\treturn (this._status === 'CONFLICTS_RESOLVING');\n\t}\n\n\tloadConflictsCount()\n\t{\n\t\treturn BX.ajax.runComponentAction(\n\t\t\tthis._componentName,\n\t\t\t'getStatistic',\n\t\t\t{\n\t\t\t\tmode: 'class',\n\t\t\t\tsignedParameters: this._componentSignedParams\n\t\t\t}).then((response) =>\n\t\t\t{\n\t\t\t\tconst data = BX.prop.getObject(response, \"data\", {});\n\t\t\t\treturn BX.prop.getInteger(data, \"conflictsCount\", 0);\n\t\t\t}\n\t\t);\n\t}\n\n\tgetConflictsInfo(conflictsCount)\n\t{\n\t\tif (!this.needLoadConflictsCount())\n\t\t{\n\t\t\treturn '';\n\t\t}\n\t\tif (conflictsCount <= 0)\n\t\t{\n\t\t\treturn '';\n\t\t}\n\t\treturn Tag.render`\n\t\t\t<div class=\"ui-alert ui-alert-warning\">\n\t\t\t\t<span class=\"ui-alert-message\">\n\t\t\t\t\t${Loc.getMessage('CRM_DP_AUTOSEARCH_SETTINGS_CONFLICTS_FOUND').replace('#CONFLICTS_COUNT#', conflictsCount)}\n\t\t\t\t\t<span class=\"ui-link\" onclick=\"${this.onStartMergeButtonClick.bind(this)}\">${Loc.getMessage('CRM_DP_AUTOSEARCH_COMPLETE_RESOLVE_CONFLICT_BUTTON')}</span>\n\t\t\t\t</span>\n\t\t\t</div>`;\n\t}\n\n\tgetShortTimeout()\n\t{\n\t\treturn Math.round(Math.random() * 5000) + 500;\n\t}\n\n\tgetLongTimeout()\n\t{\n\t\treturn Math.floor(Math.random() * 10000) + 30000;\n\t}\n\n\topenDedupeList()\n\t{\n\t\tlet url = BX.util.add_url_param(this._dedupeListUrl, {'is_automatic': 'yes'});\n\t\tBX.Crm.Page.openSlider(url);\n\t}\n\n\topenMerger()\n\t{\n\t\tlet url = BX.util.add_url_param(this._mergerUrl, {'is_automatic': 'yes'});\n\t\tBX.Crm.Page.openSlider(url);\n\t\tthis.bindMergerSliderEvent();\n\t}\n\n\ttoggleIntervalsList(e)\n\t{\n\t\tif (this._isDropdownMenuShown)\n\t\t{\n\t\t\tthis.closeDropdownMenu();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.showDropdownMenu(e.target);\n\t\t}\n\t}\n\n\tshowDropdownMenu(bindElement)\n\t{\n\t\tif (this._isDropdownMenuShown || !bindElement)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet menu = [];\n\t\tfor (let i = 0; i < this._intervalsList.length; i++)\n\t\t{\n\t\t\tmenu.push(\n\t\t\t\t{\n\t\t\t\t\ttext: this._intervalsList[i].title,\n\t\t\t\t\tvalue: this._intervalsList[i].value,\n\t\t\t\t\tonclick: this.onSelectInterval.bind(this, this._intervalsList[i].value)\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\n\t\tMenuManager.show(\n\t\t\t'autosearch-settings-intervals-dropdown',\n\t\t\tbindElement,\n\t\t\tmenu,\n\t\t\t{\n\t\t\t\twidth: bindElement.offsetWidth,\n\t\t\t\tangle: false,\n\t\t\t\tcacheable: false,\n\t\t\t\tevents:\n\t\t\t\t\t{\n\t\t\t\t\t\tonPopupShow: () =>\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis._isDropdownMenuShown = true;\n\t\t\t\t\t\t},\n\t\t\t\t\t\tonPopupClose: () =>\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis._isDropdownMenuShown = false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t}\n\t\t);\n\t}\n\n\tcloseDropdownMenu()\n\t{\n\t\tif (!this._isDropdownMenuShown)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet menu = MenuManager.getMenuById('autosearch-settings-intervals-dropdown');\n\t\tif (menu)\n\t\t{\n\t\t\tmenu.popupWindow.close();\n\t\t}\n\t}\n\n\taskIfNoActiveMerging(timeout, callback)\n\t{\n\t\tclearTimeout(this._mergeCheckerTimeoutId);\n\t\tthis._mergeCheckerTimeoutId = setTimeout(() =>\n\t\t{\n\t\t\tthis._internalMergeStatus = 'ready';\n\t\t\t// ask another tabs\n\t\t\tBX.localStorage.set(\n\t\t\t\t\"BX.Crm.onCrmEntityAutosearchStartMerge\",\n\t\t\t\t{\n\t\t\t\t\tentityTypeId: this._entityTypeId,\n\t\t\t\t\tinstanceId: this._instanceId\n\t\t\t\t},\n\t\t\t\t5\n\t\t\t);\n\t\t\tthis._mergeCheckerTimeoutId = setTimeout(() =>\n\t\t\t{\n\t\t\t\t// if another tabs don't change status\n\t\t\t\tif (this._internalMergeStatus === 'ready')\n\t\t\t\t{\n\t\t\t\t\t// we can start merging\n\t\t\t\t\tthis._internalMergeStatus = 'merging';\n\t\t\t\t\tcallback();\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t// if there is another tab with active merging, try to wait ~30 sec\n\t\t\t\t\tthis.askIfNoActiveMerging(this.getLongTimeout(), callback);\n\t\t\t\t}\n\t\t\t}, 5000);\n\t\t}, timeout);\n\t}\n\n\tbindMergerSliderEvent()\n\t{\n\t\tconst slider = BX.Crm.Page.getTopSlider();\n\t\tif (!slider)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tEventEmitter.subscribe(slider, \"SidePanel.Slider:onCloseStart\", this.onCloseMergeSlider.bind(this));\n\t}\n\n\tonExternalEvent(event)\n\t{\n\t\tlet dataArray = event.getData();\n\t\tif (!Type.isArray(dataArray))\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tlet data = dataArray[0];\n\n\t\tlet eventName = BX.prop.getString(data, \"key\", \"\");\n\n\t\tif (eventName === \"BX.Crm.onCrmEntityAutosearchStartMerge\" ||\n\t\t\teventName === \"BX.Crm.onCrmEntityAutosearchMergeStatusNotify\")\n\t\t{\n\t\t\tlet value = BX.prop.getObject(data, \"value\", {});\n\t\t\tlet entityTypeId = BX.prop.getInteger(value, \"entityTypeId\", 0);\n\t\t\tif (entityTypeId !== this._entityTypeId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tlet instanceId = BX.prop.getString(value, \"instanceId\", \"\");\n\n\t\t\tif (eventName === \"BX.Crm.onCrmEntityAutosearchStartMerge\")\n\t\t\t{\n\t\t\t\tif (instanceId !== this._instanceId && this._internalMergeStatus !== 'waiting')  // event from another tab\n\t\t\t\t{\n\t\t\t\t\tif (instanceId < this._instanceId || this._internalMergeStatus === 'merging')\n\t\t\t\t\t// notify only if current instance is already merging or if current instanceId is lower then another ready candidate\n\t\t\t\t\t{\n\t\t\t\t\t\tBX.localStorage.set(\n\t\t\t\t\t\t\t\"BX.Crm.onCrmEntityAutosearchMergeStatusNotify\",\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tentityTypeId: this._entityTypeId,\n\t\t\t\t\t\t\t\tinstanceId: instanceId,\n\t\t\t\t\t\t\t\tstatus: this._internalMergeStatus\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t5\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis._internalMergeStatus = 'waiting';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (eventName === \"BX.Crm.onCrmEntityAutosearchMergeStatusNotify\")\n\t\t\t{\n\t\t\t\tif (instanceId === this._instanceId)\n\t\t\t\t{\n\t\t\t\t\t// another tab canceled this merging\n\t\t\t\t\tthis._internalMergeStatus = 'waiting';\n\t\t\t\t}\n\n\t\t\t}\n\t\t}\n\t}\n\n\tonStartMergeButtonClick()\n\t{\n\t\tconst popup = PopupManager.getPopupById(this._settingsPopupId);\n\t\tif (popup && popup.isShown())\n\t\t{\n\t\t\tpopup.close();\n\t\t}\n\t\tthis.openMerger();\n\t}\n\n\tonSelectInterval(interval)\n\t{\n\t\tthis._selectedExecInterval = interval;\n\t\tif (Type.isDomNode(this._selectedExecIntervalNode))\n\t\t{\n\t\t\tthis._selectedExecIntervalNode.textContent =\n\t\t\t\tthis._intervalsList.reduce((prev, item) => (item.value === this._selectedExecInterval ? item.title : prev), '');\n\t\t}\n\t\tthis.closeDropdownMenu();\n\t}\n\n\tonHintClick()\n\t{\n\t\tif (this._infoHelperId)\n\t\t{\n\t\t\tBX.Helper.show(\"redirect=detail&code=\"+this._infoHelperId);\n\t\t}\n\t}\n\n\tonCloseMergeSlider(event)\n\t{\n\t\tif (top.BX.CRM && top.BX.CRM.Kanban)\n\t\t{\n\t\t\tvar kanban = top.BX.CRM.Kanban.Grid.getInstance();\n\t\t\tif (kanban)\n\t\t\t{\n\t\t\t\tkanban.reload();\n\t\t\t}\n\t\t}\n\t\tif (top.BX.Main.gridManager)\n\t\t{\n\t\t\tvar gridId = 'CRM_' +  BX.CrmEntityType.resolveName(this._entityTypeId) + '_LIST_V12'; // does not support deal categories\n\t\t\tvar grid = top.BX.Main.gridManager.getInstanceById(gridId);\n\t\t\tif (grid)\n\t\t\t{\n\t\t\t\tgrid.reload();\n\t\t\t}\n\t\t}\n\t}\n\n\tstatic create(params)\n\t{\n\t\tlet autosearch = new DedupeAutosearch();\n\t\tautosearch.initialize(params);\n\t\treturn autosearch;\n\t}\n\n\tstatic setDefault(instance, entityTypeName)\n\t{\n\t\tif (!Type.isObject(DedupeAutosearch.defaultInstance))\n\t\t{\n\t\t\tDedupeAutosearch.defaultInstance = {};\n\t\t}\n\t\tDedupeAutosearch.defaultInstance[entityTypeName] = instance\n\t}\n\n\tstatic getDefault(entityTypeName)\n\t{\n\t\treturn DedupeAutosearch.defaultInstance[entityTypeName];\n\t}\n}\n\n\nnamespace.DedupeAutosearch = DedupeAutosearch;"],"names":["namespace","Reflection","DedupeAutosearch","_componentName","_componentSignedParams","_entityTypeId","_instanceId","_internalMergeStatus","_mergeCheckerTimeoutId","_mergerUrl","_dedupeListUrl","_execInterval","_intervalsList","_isDropdownMenuShown","_selectedExecInterval","_selectedExecIntervalNode","_status","_infoHelperId","_progressData","_settingsPopupId","params","BX","prop","getString","getInteger","Text","getRandom","getArray","getObject","tryToStartMerge","subscribeEvents","PULL","subscribe","type","PullClient","SubscriptionType","Server","moduleId","command","callback","notification","UI","Notification","Center","getBalloonById","close","data","clearTimeout","showMergeCompleteNotification","EventEmitter","onExternalEvent","bind","popup","PopupManager","create","id","cacheable","titleBar","Loc","getMessage","content","needLoadConflictsCount","getSettingsPopupLoader","getSettingsPopupContent","closeByEsc","closeIcon","draggable","width","buttons","SaveButton","onclick","saveSelectedExecInterval","CancelButton","show","loadConflictsCount","then","conflictsCount","setContent","adjustPosition","immediately","showStartConfirmation","startMerging","getShortTimeout","getBoolean","entityTypeName","CrmEntityType","resolveName","foundItemsCount","totalEntitiesCount","notificationContent","Tag","render","replace","onHintClick","notify","autoHide","actions","title","events","click","event","balloon","action","showSettings","onOpen","getBalloon","Hint","init","getContainer","successCount","message","automaticallyFoundText","Dom","append","notificationWidth","push","openMerger","ajax","runComponentAction","mode","signedParameters","interval","timeout","p","Promise","resolve","reject","askIfNoActiveMerging","doMerge","mergeId","response","instanceId","status","window","setTimeout","getLongTimeout","loaderContainer","style","height","loader","Loader","target","selectedExecInterval","reduce","prev","item","value","getConflictsInfo","toggleIntervalsList","onStartMergeButtonClick","Math","round","random","floor","url","util","add_url_param","Crm","Page","openSlider","bindMergerSliderEvent","e","closeDropdownMenu","showDropdownMenu","bindElement","menu","i","length","text","onSelectInterval","MenuManager","offsetWidth","angle","onPopupShow","onPopupClose","getMenuById","popupWindow","localStorage","set","entityTypeId","slider","getTopSlider","onCloseMergeSlider","dataArray","getData","Type","isArray","eventName","getPopupById","isShown","isDomNode","textContent","Helper","top","CRM","Kanban","kanban","Grid","getInstance","reload","Main","gridManager","gridId","grid","getInstanceById","autosearch","initialize","instance","isObject","defaultInstance"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;CAOA,IAAMA,SAAS,GAAGC,oBAAU,CAACD,SAAX,CAAqB,QAArB,CAAlB;AAEA,KAAaE,gBAAb;CAEC,8BACA;CAAA;CACC,SAAKC,cAAL,GAAsB,EAAtB;CACA,SAAKC,sBAAL,GAA8B,EAA9B;CACA,SAAKC,aAAL,GAAqB,CAArB;CACA,SAAKC,WAAL,GAAmB,EAAnB;CACA,SAAKC,oBAAL,GAA4B,EAA5B;CACA,SAAKC,sBAAL,GAA8B,IAA9B;CACA,SAAKC,UAAL,GAAkB,EAAlB;CACA,SAAKC,cAAL,GAAsB,EAAtB;CACA,SAAKC,aAAL,GAAqB,IAArB;CACA,SAAKC,cAAL,GAAsB,EAAtB;CACA,SAAKC,oBAAL,GAA4B,KAA5B;CACA,SAAKC,qBAAL,GAA6B,IAA7B;CACA,SAAKC,yBAAL,GAAiC,IAAjC;CACA,SAAKC,OAAL,GAAe,EAAf;CACA,SAAKC,aAAL,GAAqB,EAArB;CACA,SAAKC,aAAL,GAAqB,EAArB;CAEA,SAAKC,gBAAL,GAAwB,2BAAxB;CACA;;CAtBF;CAAA;CAAA,+BAwBYC,MAxBZ,EAyBC;CACC,WAAKjB,cAAL,GAAsBkB,EAAE,CAACC,IAAH,CAAQC,SAAR,CAAkBH,MAAlB,EAA0B,eAA1B,EAA2C,EAA3C,CAAtB;CACA,WAAKhB,sBAAL,GAA8BiB,EAAE,CAACC,IAAH,CAAQC,SAAR,CAAkBH,MAAlB,EAA0B,kBAA1B,EAA8C,EAA9C,CAA9B;CACA,WAAKf,aAAL,GAAqBgB,EAAE,CAACC,IAAH,CAAQE,UAAR,CAAmBJ,MAAnB,EAA2B,cAA3B,EAA2C,CAA3C,CAArB;CACA,WAAKd,WAAL,GAAmBe,EAAE,CAACI,IAAH,CAAQC,SAAR,CAAkB,CAAlB,CAAnB;CACA,WAAKnB,oBAAL,GAA4B,SAA5B;CACA,WAAKE,UAAL,GAAkBY,EAAE,CAACC,IAAH,CAAQC,SAAR,CAAkBH,MAAlB,EAA0B,WAA1B,EAAuC,EAAvC,CAAlB;CACA,WAAKV,cAAL,GAAsBW,EAAE,CAACC,IAAH,CAAQC,SAAR,CAAkBH,MAAlB,EAA0B,eAA1B,EAA2C,EAA3C,CAAtB;CACA,WAAKT,aAAL,GAAqBU,EAAE,CAACC,IAAH,CAAQC,SAAR,CAAkBH,MAAlB,EAA0B,kBAA1B,EAA8C,GAA9C,CAArB;CACA,WAAKR,cAAL,GAAsBS,EAAE,CAACC,IAAH,CAAQK,QAAR,CAAiBP,MAAjB,EAAyB,WAAzB,EAAsC,EAAtC,CAAtB;CACA,WAAKJ,OAAL,GAAeK,EAAE,CAACC,IAAH,CAAQC,SAAR,CAAkBH,MAAlB,EAA0B,QAA1B,EAAoC,EAApC,CAAf;CACA,WAAKH,aAAL,GAAqBI,EAAE,CAACC,IAAH,CAAQC,SAAR,CAAkBH,MAAlB,EAA0B,cAA1B,EAA0C,EAA1C,CAArB;CACA,WAAKF,aAAL,GAAqBG,EAAE,CAACC,IAAH,CAAQM,SAAR,CAAkBR,MAAlB,EAA0B,cAA1B,EAA0C,EAA1C,CAArB;CAEA,WAAKS,eAAL,CAAqB,IAArB;CAEA,WAAKC,eAAL;CACA;CA1CF;CAAA;CAAA,sCA6CC;CAAA;;CACC,UAAIT,EAAE,CAACU,IAAP,EACA;CACCV,QAAAA,EAAE,CAACU,IAAH,CAAQC,SAAR,CAAkB;CACjBC,UAAAA,IAAI,EAAEZ,EAAE,CAACa,UAAH,CAAcC,gBAAd,CAA+BC,MADpB;CAEjBC,UAAAA,QAAQ,EAAE,KAFO;CAGjBC,UAAAA,OAAO,EAAE,8BAHQ;CAIjBC,UAAAA,QAAQ,EAAE,kBAACnB,MAAD,EACV;CACC,gBAAIC,EAAE,CAACC,IAAH,CAAQE,UAAR,CAAmBJ,MAAnB,EAA2B,cAA3B,EAA2C,CAA3C,MAAkD,KAAI,CAACf,aAA3D,EACA;CACC,cAAA,KAAI,CAACW,OAAL,GAAeK,EAAE,CAACC,IAAH,CAAQC,SAAR,CAAkBH,MAAlB,EAA0B,QAA1B,EAAoC,EAApC,CAAf;CACA,cAAA,KAAI,CAACF,aAAL,GAAqBG,EAAE,CAACC,IAAH,CAAQM,SAAR,CAAkBR,MAAlB,EAA0B,cAA1B,EAA0C,EAA1C,CAArB;;CAEA,kBAAI,KAAI,CAACJ,OAAL,KAAiB,SAArB,EACA;CACC,oBAAIwB,YAAY,GAAGC,kBAAE,CAACC,YAAH,CAAgBC,MAAhB,CAAuBC,cAAvB,CAAsC,4BAAtC,CAAnB;;CACA,oBAAIJ,YAAJ,EACA;CACCA,kBAAAA,YAAY,CAACK,KAAb;CACA;CACD;;CACD,cAAA,KAAI,CAAChB,eAAL;CACA;CACD;CArBgB,SAAlB;CAuBAR,QAAAA,EAAE,CAACU,IAAH,CAAQC,SAAR,CAAkB;CACjBC,UAAAA,IAAI,EAAEZ,EAAE,CAACa,UAAH,CAAcC,gBAAd,CAA+BC,MADpB;CAEjBC,UAAAA,QAAQ,EAAE,KAFO;CAGjBC,UAAAA,OAAO,EAAE,iCAHQ;CAIjBC,UAAAA,QAAQ,EAAE,kBAACnB,MAAD,EACV;CACC,gBAAIC,EAAE,CAACC,IAAH,CAAQE,UAAR,CAAmBJ,MAAnB,EAA2B,cAA3B,EAA2C,CAA3C,MAAkD,KAAI,CAACf,aAA3D,EACA;CACC,kBAAMyC,IAAI,GAAGzB,EAAE,CAACC,IAAH,CAAQM,SAAR,CAAkBR,MAAlB,EAA0B,MAA1B,EAAkC,EAAlC,CAAb;CACA,cAAA,KAAI,CAACJ,OAAL,GAAgBK,EAAE,CAACC,IAAH,CAAQE,UAAR,CAAmBsB,IAAnB,EAAyB,gBAAzB,EAA2C,CAA3C,IAAgD,CAAhD,GACf,qBADe,GACS,EADzB;CAEAC,cAAAA,YAAY,CAAC,KAAI,CAACvC,sBAAN,CAAZ;;CACA,cAAA,KAAI,CAACwC,6BAAL,CAAmCF,IAAnC;CACA;CACD;CAdgB,SAAlB;CAgBA;;CACDG,MAAAA,6BAAY,CAACjB,SAAb,CAAuB,mBAAvB,EAA4C,KAAKkB,eAAL,CAAqBC,IAArB,CAA0B,IAA1B,CAA5C;CACA;CAzFF;CAAA;CAAA,mCA4FC;CAAA;;CACC,WAAKrC,qBAAL,GAA6B,KAAKH,aAAlC;CACA,UAAMyC,KAAK,GAAGC,uBAAY,CAACC,MAAb,CAAoB;CACjCC,QAAAA,EAAE,EAAE,KAAKpC,gBADwB;CAEjCqC,QAAAA,SAAS,EAAE,KAFsB;CAGjCC,QAAAA,QAAQ,EAAEC,aAAG,CAACC,UAAJ,CAAe,kCAAf,CAHuB;CAIjCC,QAAAA,OAAO,EAAE,KAAKC,sBAAL,KAAgC,KAAKC,sBAAL,EAAhC,GAAgE,KAAKC,uBAAL,EAJxC;CAKjCC,QAAAA,UAAU,EAAE,IALqB;CAMjCC,QAAAA,SAAS,EAAE,IANsB;CAOjCC,QAAAA,SAAS,EAAE,IAPsB;CAQjCC,QAAAA,KAAK,EAAE,GAR0B;CASjCC,QAAAA,OAAO,EAAE,CACR,IAAI/C,EAAE,CAACoB,EAAH,CAAM4B,UAAV,CAAqB;CACpBC,UAAAA,OAAO,EAAE,mBACT;CACClB,YAAAA,KAAK,CAACP,KAAN;;CACA,YAAA,MAAI,CAAC0B,wBAAL;CACA;CALmB,SAArB,CADQ,EAQR,IAAIlD,EAAE,CAACoB,EAAH,CAAM+B,YAAV,CAAuB;CACtBF,UAAAA,OAAO,EAAE,mBACT;CACClB,YAAAA,KAAK,CAACP,KAAN;CACA;CAJqB,SAAvB,CARQ;CATwB,OAApB,CAAd;CAyBAO,MAAAA,KAAK,CAACqB,IAAN;;CACA,UAAI,KAAKZ,sBAAL,EAAJ,EACA;CACC,aAAKa,kBAAL,GACEC,IADF,CACO,UAACC,cAAD,EACN;CACCxB,UAAAA,KAAK,CAACyB,UAAN,CAAiB,MAAI,CAACd,uBAAL,CAA6Ba,cAA7B,CAAjB;CACAxB,UAAAA,KAAK,CAAC0B,cAAN;CACA,SALF,EAKI,YAAM;CACR1B,UAAAA,KAAK,CAACyB,UAAN,CAAiB,MAAI,CAACd,uBAAL,CAA6B,CAA7B,CAAjB;CACAX,UAAAA,KAAK,CAAC0B,cAAN;CACA,SARF;CASA;CACD;CApIF;CAAA;CAAA,sCAuIC;CAAA,UADgBC,WAChB,uEAD8B,KAC9B;;CACC,UAAI,KAAK/D,OAAL,KAAiB,gBAArB,EACA;CACC,aAAKgE,qBAAL;CACA;;CACD,UAAI,KAAKhE,OAAL,KAAiB,SAArB,EACA;CACC,aAAKiE,YAAL,CAAkBF,WAAW,GAAG,CAAH,GAAO,KAAKG,eAAL,EAApC;CACA;;CACD,UAAI,KAAKlE,OAAL,KAAiB,qBAArB,EACA;CACC,aAAKgC,6BAAL,CAAmC,KAAK9B,aAAxC;CACA;CACD;CApJF;CAAA;CAAA,4CAuJC;CAAA;;CACC,UAAI,CAACG,EAAE,CAACC,IAAH,CAAQ6D,UAAR,CAAmB,KAAKjE,aAAxB,EAAuC,mBAAvC,EAA4D,IAA5D,CAAL,EACA;CACC;CACA;CACA;;CACD,UAAMkE,cAAc,GAAG/D,EAAE,CAACgE,aAAH,CAAiBC,WAAjB,CAA6B,KAAKjF,aAAlC,CAAvB;CACA,UAAMkF,eAAe,GAAGlE,EAAE,CAACC,IAAH,CAAQE,UAAR,CAAmB,KAAKN,aAAxB,EAAuC,aAAvC,EAAsD,CAAtD,CAAxB;CACA,UAAMsE,kBAAkB,GAAGnE,EAAE,CAACC,IAAH,CAAQE,UAAR,CAAmB,KAAKN,aAAxB,EAAuC,gBAAvC,EAAyD,CAAzD,CAA3B;CACA,UAAMuE,mBAAmB,GAAGC,aAAG,CAACC,MAAP,oBAErBjC,aAAG,CAACC,UAAJ,CAAe,+CAA+CyB,cAA9D,EACAQ,OADA,CACQ,qBADR,EAC+BL,eAD/B,EAEAK,OAFA,CAEQ,wBAFR,EAEkCJ,kBAFlC,CAFqB,EAMrB9B,aAAG,CAACC,UAAJ,CAAe,2CAAf,CANqB,EAQgB,KAAKkC,WAAL,CAAiB1C,IAAjB,CAAsB,IAAtB,CARhB,CAAzB;CAWAV,MAAAA,kBAAE,CAACC,YAAH,CAAgBC,MAAhB,CAAuBmD,MAAvB,CAA8B;CAC7BlC,QAAAA,OAAO,EAAE6B,mBADoB;CAE7BM,QAAAA,QAAQ,EAAE,KAFmB;CAG7BxC,QAAAA,EAAE,EAAE,4BAHyB;CAI7BY,QAAAA,KAAK,EAAE,GAJsB;CAK7B6B,QAAAA,OAAO,EAAE,CACR;CACCC,UAAAA,KAAK,EAAEvC,aAAG,CAACC,UAAJ,CAAe,6CAAf,CADR;CAECuC,UAAAA,MAAM,EAAE;CACPC,YAAAA,KAAK,EAAE,eAACC,KAAD,EAAQC,OAAR,EAAiBC,MAAjB,EACP;CACC,cAAA,MAAI,CAACC,YAAL;;CACAF,cAAAA,OAAO,CAACxD,KAAR;CACA;CALM;CAFT,SADQ,CALoB;CAiB7BqD,QAAAA,MAAM,EAAE;CACPM,UAAAA,MAAM,EAAE,gBAASJ,KAAT,EACR;CACC,gBAAIC,OAAO,GAAGD,KAAK,CAACK,UAAN,EAAd;CACApF,YAAAA,EAAE,CAACoB,EAAH,CAAMiE,IAAN,CAAWC,IAAX,CAAgBN,OAAO,CAACO,YAAR,EAAhB;CACA;CALM;CAjBqB,OAA9B;CAyBA;CApMF;CAAA;CAAA,kDAsM+B9D,IAtM/B,EAuMC;CAAA;;CACC,UAAI,CAACzB,EAAE,CAACC,IAAH,CAAQ6D,UAAR,CAAmBrC,IAAnB,EAAyB,mBAAzB,EAA8C,IAA9C,CAAL,EACA;CACC;CACA;CACA;;CAED,UAAMsC,cAAc,GAAG/D,EAAE,CAACgE,aAAH,CAAiBC,WAAjB,CAA6B,KAAKjF,aAAlC,CAAvB;CACA,UAAMwG,YAAY,GAAGxF,EAAE,CAACC,IAAH,CAAQE,UAAR,CAAmBsB,IAAnB,EAAyB,eAAzB,EAA0C,CAA1C,CAArB;CACA,UAAM8B,cAAc,GAAGvD,EAAE,CAACC,IAAH,CAAQE,UAAR,CAAmBsB,IAAnB,EAAyB,gBAAzB,EAA2C,CAA3C,CAAvB;;CAEA,UAAI+D,YAAY,KAAK,CAAjB,IAAsBjC,cAAc,KAAK,CAA7C,EACA;CACC;CACA;;CAED,UAAIkC,OAAO,GAAGpB,aAAG,CAACC,MAAP,oBAAX;CACA,UAAMoB,sBAAsB,GAAGF,YAAY,GAAG,CAAf,GAC9BnD,aAAG,CAACC,UAAJ,CAAe,qCAAqCyB,cAApD,EACEQ,OADF,CACU,qBADV,EACiCiB,YADjC,CAD8B,GAI9BnD,aAAG,CAACC,UAAJ,CAAe,qCAAqCyB,cAApD,CAJD;CAKA4B,MAAAA,aAAG,CAACC,MAAJ,CACCvB,aAAG,CAACC,MADL,qBACmBoB,sBADnB,GAECD,OAFD;CAIA,UAAId,OAAO,GAAG,EAAd;CACA,UAAIkB,iBAAiB,GAAG,GAAxB;;CACA,UAAItC,cAAc,GAAG,CAArB,EACA;CACCoC,QAAAA,aAAG,CAACC,MAAJ,CAAWvB,aAAG,CAACC,MAAf,qBAA6BjC,aAAG,CAACC,UAAJ,CAAe,4CAAf,EAA6DiC,OAA7D,CAAqE,mBAArE,EAA0FhB,cAA1F,CAA7B,GAAgJkC,OAAhJ;CACAd,QAAAA,OAAO,CAACmB,IAAR,CAAa;CACZlB,UAAAA,KAAK,EAAEvC,aAAG,CAACC,UAAJ,CAAe,oDAAf,CADK;CAEZuC,UAAAA,MAAM,EAAE;CACPC,YAAAA,KAAK,EAAE,eAACC,KAAD,EAAQC,OAAR,EAAiBC,MAAjB,EACP;CACC,cAAA,MAAI,CAACc,UAAL;;CACAf,cAAAA,OAAO,CAACxD,KAAR;CACA;CALM;CAFI,SAAb;CAWAqE,QAAAA,iBAAiB,GAAG,GAApB;CACA;;CACDzE,MAAAA,kBAAE,CAACC,YAAH,CAAgBC,MAAhB,CAAuBmD,MAAvB,CAA8B;CAC7BlC,QAAAA,OAAO,EAAEkD,OADoB;CAE7Bf,QAAAA,QAAQ,EAAE,KAFmB;CAG7BxC,QAAAA,EAAE,EAAE,+BAHyB;CAI7BY,QAAAA,KAAK,EAAE+C,iBAJsB;CAK7BlB,QAAAA,OAAO,EAAEA;CALoB,OAA9B;CAOA;CA1PF;CAAA;CAAA,+CA6PC;CACC,WAAKrF,aAAL,GAAqB,KAAKG,qBAA1B;CACAO,MAAAA,EAAE,CAACgG,IAAH,CAAQC,kBAAR,CACC,KAAKnH,cADN,EAEC,iBAFD,EAGC;CACCoH,QAAAA,IAAI,EAAE,OADP;CAECC,QAAAA,gBAAgB,EAAE,KAAKpH,sBAFxB;CAGC0C,QAAAA,IAAI,EAAE;CACL2E,UAAAA,QAAQ,EAAE,KAAK3G;CADV;CAHP,OAHD;CAUA;CAzQF;CAAA;CAAA,iCA2Qc4G,OA3Qd,EA4QC;CAAA;;CACC,UAAMC,CAAC,GAAG,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;CAC1C,QAAA,MAAI,CAACC,oBAAL,CAA0BL,OAA1B,EAAmCG,OAAnC;CACA,OAFS,CAAV;CAGAF,MAAAA,CAAC,CAAChD,IAAF,CAAO;CAAA,eAAM,MAAI,CAACqD,OAAL,EAAN;CAAA,OAAP;CACA;CAjRF;CAAA;CAAA,8BAoRC;CAAA;;CACC3G,MAAAA,EAAE,CAACgG,IAAH,CAAQC,kBAAR,CACC,KAAKnH,cADN,EAEC,OAFD,EAGC;CACCoH,QAAAA,IAAI,EAAE,OADP;CAECC,QAAAA,gBAAgB,EAAE,KAAKpH,sBAFxB;CAGC0C,QAAAA,IAAI,EAAE;CACLmF,UAAAA,OAAO,EAAE,KAAK3H;CADT;CAHP,OAHD,EASIqE,IATJ,CASS,UAACuD,QAAD,EACR;CACC,YAAMpF,IAAI,GAAGzB,EAAE,CAACC,IAAH,CAAQM,SAAR,CAAkBsG,QAAlB,EAA4B,MAA5B,EAAoC,EAApC,CAAb;CACA,YAAMC,UAAU,GAAG9G,EAAE,CAACC,IAAH,CAAQC,SAAR,CAAkBuB,IAAlB,EAAwB,UAAxB,EAAoC,EAApC,CAAnB;;CACA,YAAIqF,UAAU,KAAK,MAAI,CAAC7H,WAAxB,EACA;CACC,cAAM8H,MAAM,GAAG/G,EAAE,CAACC,IAAH,CAAQC,SAAR,CAAkBuB,IAAlB,EAAwB,QAAxB,EAAkC,EAAlC,CAAf;;CAEA,cAAIsF,MAAM,KAAK,WAAf,EACA;CACCC,YAAAA,MAAM,CAACC,UAAP,CAAkB;CAAA,qBAAM,MAAI,CAACN,OAAL,EAAN;CAAA,aAAlB,EAAwC,GAAxC;CACA;CACD,SARD,MAUA;CACC,UAAA,MAAI,CAAC/C,YAAL,CAAkB,MAAI,CAACsD,cAAL,EAAlB;CACA;CACD,OA1BF,EA2BC,UAACL,QAAD,EACA;CACC,QAAA,MAAI,CAACjD,YAAL,CAAkB,MAAI,CAACC,eAAL,EAAlB;CACA,OA9BF;CAgCA;CArTF;CAAA;CAAA,6CAwTC;CACC,UAAMsD,eAAe,GAAG9C,aAAG,CAACC,MAAP,oBAArB;CACA6C,MAAAA,eAAe,CAACC,KAAhB,CAAsBC,MAAtB,GAA+B,OAA/B;CAEA,UAAMC,MAAM,GAAG,IAAIC,kBAAJ,CAAW;CACzBC,QAAAA,MAAM,EAAEL;CADiB,OAAX,CAAf;CAGAF,MAAAA,UAAU,CAAC,YAAM;CAChBK,QAAAA,MAAM,CAAClE,IAAP;CACA,OAFS,EAEP,EAFO,CAAV;CAGA,aAAO+D,eAAP;CACA;CAnUF;CAAA;CAAA,4CAqUyB5D,cArUzB,EAsUC;CAAA;;CACC,UAAMkE,oBAAoB,GACzB,KAAKlI,cAAL,CAAoBmI,MAApB,CAA2B,UAACC,IAAD,EAAOC,IAAP;CAAA,eAAiBA,IAAI,CAACC,KAAL,KAAe,MAAI,CAACpI,qBAApB,GAA4CmI,IAAI,CAAChD,KAAjD,GAAyD+C,IAA1E;CAAA,OAA3B,EAA4G,EAA5G,CADD;;CAGA,WAAKjI,yBAAL,GAAiC2E,aAAG,CAACC,MAArC,qBAA0EmD,oBAA1E;CACA,aAAOpD,aAAG,CAACC,MAAX,qBAEI,KAAKwD,gBAAL,CAAsBvE,cAAtB,CAFJ,EAGOlB,aAAG,CAACC,UAAJ,CAAe,iCAAf,CAHP,EAImCD,aAAG,CAACC,UAAJ,CAAe,2CAAf,CAJnC,EAK+E,KAAKyF,mBAAL,CAAyBjG,IAAzB,CAA8B,IAA9B,CAL/E,EAMK,KAAKpC,yBANV;CAWA;CAtVF;CAAA;CAAA,6CAyVC;CACC,aAAQ,KAAKC,OAAL,KAAiB,qBAAzB;CACA;CA3VF;CAAA;CAAA,yCA8VC;CACC,aAAOK,EAAE,CAACgG,IAAH,CAAQC,kBAAR,CACN,KAAKnH,cADC,EAEN,cAFM,EAGN;CACCoH,QAAAA,IAAI,EAAE,OADP;CAECC,QAAAA,gBAAgB,EAAE,KAAKpH;CAFxB,OAHM,EAMHuE,IANG,CAME,UAACuD,QAAD,EACR;CACC,YAAMpF,IAAI,GAAGzB,EAAE,CAACC,IAAH,CAAQM,SAAR,CAAkBsG,QAAlB,EAA4B,MAA5B,EAAoC,EAApC,CAAb;CACA,eAAO7G,EAAE,CAACC,IAAH,CAAQE,UAAR,CAAmBsB,IAAnB,EAAyB,gBAAzB,EAA2C,CAA3C,CAAP;CACA,OAVK,CAAP;CAYA;CA3WF;CAAA;CAAA,qCA6WkB8B,cA7WlB,EA8WC;CACC,UAAI,CAAC,KAAKf,sBAAL,EAAL,EACA;CACC,eAAO,EAAP;CACA;;CACD,UAAIe,cAAc,IAAI,CAAtB,EACA;CACC,eAAO,EAAP;CACA;;CACD,aAAOc,aAAG,CAACC,MAAX,qBAGKjC,aAAG,CAACC,UAAJ,CAAe,4CAAf,EAA6DiC,OAA7D,CAAqE,mBAArE,EAA0FhB,cAA1F,CAHL,EAIoC,KAAKyE,uBAAL,CAA6BlG,IAA7B,CAAkC,IAAlC,CAJpC,EAIgFO,aAAG,CAACC,UAAJ,CAAe,oDAAf,CAJhF;CAOA;CA9XF;CAAA;CAAA,sCAiYC;CACC,aAAO2F,IAAI,CAACC,KAAL,CAAWD,IAAI,CAACE,MAAL,KAAgB,IAA3B,IAAmC,GAA1C;CACA;CAnYF;CAAA;CAAA,qCAsYC;CACC,aAAOF,IAAI,CAACG,KAAL,CAAWH,IAAI,CAACE,MAAL,KAAgB,KAA3B,IAAoC,KAA3C;CACA;CAxYF;CAAA;CAAA,qCA2YC;CACC,UAAIE,GAAG,GAAGrI,EAAE,CAACsI,IAAH,CAAQC,aAAR,CAAsB,KAAKlJ,cAA3B,EAA2C;CAAC,wBAAgB;CAAjB,OAA3C,CAAV;CACAW,MAAAA,EAAE,CAACwI,GAAH,CAAOC,IAAP,CAAYC,UAAZ,CAAuBL,GAAvB;CACA;CA9YF;CAAA;CAAA,iCAiZC;CACC,UAAIA,GAAG,GAAGrI,EAAE,CAACsI,IAAH,CAAQC,aAAR,CAAsB,KAAKnJ,UAA3B,EAAuC;CAAC,wBAAgB;CAAjB,OAAvC,CAAV;CACAY,MAAAA,EAAE,CAACwI,GAAH,CAAOC,IAAP,CAAYC,UAAZ,CAAuBL,GAAvB;CACA,WAAKM,qBAAL;CACA;CArZF;CAAA;CAAA,wCAuZqBC,CAvZrB,EAwZC;CACC,UAAI,KAAKpJ,oBAAT,EACA;CACC,aAAKqJ,iBAAL;CACA,OAHD,MAKA;CACC,aAAKC,gBAAL,CAAsBF,CAAC,CAACpB,MAAxB;CACA;CACD;CAjaF;CAAA;CAAA,qCAmakBuB,WAnalB,EAoaC;CAAA;;CACC,UAAI,KAAKvJ,oBAAL,IAA6B,CAACuJ,WAAlC,EACA;CACC;CACA;;CAED,UAAIC,IAAI,GAAG,EAAX;;CACA,WAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAK1J,cAAL,CAAoB2J,MAAxC,EAAgDD,CAAC,EAAjD,EACA;CACCD,QAAAA,IAAI,CAAClD,IAAL,CACC;CACCqD,UAAAA,IAAI,EAAE,KAAK5J,cAAL,CAAoB0J,CAApB,EAAuBrE,KAD9B;CAECiD,UAAAA,KAAK,EAAE,KAAKtI,cAAL,CAAoB0J,CAApB,EAAuBpB,KAF/B;CAGC5E,UAAAA,OAAO,EAAE,KAAKmG,gBAAL,CAAsBtH,IAAtB,CAA2B,IAA3B,EAAiC,KAAKvC,cAAL,CAAoB0J,CAApB,EAAuBpB,KAAxD;CAHV,SADD;CAOA;;CAEDwB,MAAAA,sBAAW,CAACjG,IAAZ,CACC,wCADD,EAEC2F,WAFD,EAGCC,IAHD,EAIC;CACClG,QAAAA,KAAK,EAAEiG,WAAW,CAACO,WADpB;CAECC,QAAAA,KAAK,EAAE,KAFR;CAGCpH,QAAAA,SAAS,EAAE,KAHZ;CAIC0C,QAAAA,MAAM,EACL;CACC2E,UAAAA,WAAW,EAAE,uBACb;CACC,YAAA,MAAI,CAAChK,oBAAL,GAA4B,IAA5B;CACA,WAJF;CAKCiK,UAAAA,YAAY,EAAE,wBACd;CACC,YAAA,MAAI,CAACjK,oBAAL,GAA4B,KAA5B;CACA;CARF;CALF,OAJD;CAqBA;CA3cF;CAAA;CAAA,wCA8cC;CACC,UAAI,CAAC,KAAKA,oBAAV,EACA;CACC;CACA;;CAED,UAAIwJ,IAAI,GAAGK,sBAAW,CAACK,WAAZ,CAAwB,wCAAxB,CAAX;;CACA,UAAIV,IAAJ,EACA;CACCA,QAAAA,IAAI,CAACW,WAAL,CAAiBnI,KAAjB;CACA;CACD;CAzdF;CAAA;CAAA,yCA2dsB6E,OA3dtB,EA2d+BnF,QA3d/B,EA4dC;CAAA;;CACCQ,MAAAA,YAAY,CAAC,KAAKvC,sBAAN,CAAZ;CACA,WAAKA,sBAAL,GAA8B8H,UAAU,CAAC,YACzC;CACC,QAAA,MAAI,CAAC/H,oBAAL,GAA4B,OAA5B,CADD;;CAGCc,QAAAA,EAAE,CAAC4J,YAAH,CAAgBC,GAAhB,CACC,wCADD,EAEC;CACCC,UAAAA,YAAY,EAAE,MAAI,CAAC9K,aADpB;CAEC8H,UAAAA,UAAU,EAAE,MAAI,CAAC7H;CAFlB,SAFD,EAMC,CAND;CAQA,QAAA,MAAI,CAACE,sBAAL,GAA8B8H,UAAU,CAAC,YACzC;CACC;CACA,cAAI,MAAI,CAAC/H,oBAAL,KAA8B,OAAlC,EACA;CACC;CACA,YAAA,MAAI,CAACA,oBAAL,GAA4B,SAA5B;CACAgC,YAAAA,QAAQ;CACR,WALD,MAOA;CACC;CACA,YAAA,MAAI,CAACwF,oBAAL,CAA0B,MAAI,CAACQ,cAAL,EAA1B,EAAiDhG,QAAjD;CACA;CACD,SAduC,EAcrC,IAdqC,CAAxC;CAeA,OA3BuC,EA2BrCmF,OA3BqC,CAAxC;CA4BA;CA1fF;CAAA;CAAA,4CA6fC;CACC,UAAM0D,MAAM,GAAG/J,EAAE,CAACwI,GAAH,CAAOC,IAAP,CAAYuB,YAAZ,EAAf;;CACA,UAAI,CAACD,MAAL,EACA;CACC;CACA;;CACDnI,MAAAA,6BAAY,CAACjB,SAAb,CAAuBoJ,MAAvB,EAA+B,+BAA/B,EAAgE,KAAKE,kBAAL,CAAwBnI,IAAxB,CAA6B,IAA7B,CAAhE;CACA;CApgBF;CAAA;CAAA,oCAsgBiBiD,KAtgBjB,EAugBC;CACC,UAAImF,SAAS,GAAGnF,KAAK,CAACoF,OAAN,EAAhB;;CACA,UAAI,CAACC,cAAI,CAACC,OAAL,CAAaH,SAAb,CAAL,EACA;CACC;CACA;;CACD,UAAIzI,IAAI,GAAGyI,SAAS,CAAC,CAAD,CAApB;CAEA,UAAII,SAAS,GAAGtK,EAAE,CAACC,IAAH,CAAQC,SAAR,CAAkBuB,IAAlB,EAAwB,KAAxB,EAA+B,EAA/B,CAAhB;;CAEA,UAAI6I,SAAS,KAAK,wCAAd,IACHA,SAAS,KAAK,+CADf,EAEA;CACC,YAAIzC,KAAK,GAAG7H,EAAE,CAACC,IAAH,CAAQM,SAAR,CAAkBkB,IAAlB,EAAwB,OAAxB,EAAiC,EAAjC,CAAZ;CACA,YAAIqI,YAAY,GAAG9J,EAAE,CAACC,IAAH,CAAQE,UAAR,CAAmB0H,KAAnB,EAA0B,cAA1B,EAA0C,CAA1C,CAAnB;;CACA,YAAIiC,YAAY,KAAK,KAAK9K,aAA1B,EACA;CACC;CACA;;CACD,YAAI8H,UAAU,GAAG9G,EAAE,CAACC,IAAH,CAAQC,SAAR,CAAkB2H,KAAlB,EAAyB,YAAzB,EAAuC,EAAvC,CAAjB;;CAEA,YAAIyC,SAAS,KAAK,wCAAlB,EACA;CACC,cAAIxD,UAAU,KAAK,KAAK7H,WAApB,IAAmC,KAAKC,oBAAL,KAA8B,SAArE;CACA;CACC,kBAAI4H,UAAU,GAAG,KAAK7H,WAAlB,IAAiC,KAAKC,oBAAL,KAA8B,SAAnE;CAEA;CACCc,kBAAAA,EAAE,CAAC4J,YAAH,CAAgBC,GAAhB,CACC,+CADD,EAEC;CACCC,oBAAAA,YAAY,EAAE,KAAK9K,aADpB;CAEC8H,oBAAAA,UAAU,EAAEA,UAFb;CAGCC,oBAAAA,MAAM,EAAE,KAAK7H;CAHd,mBAFD,EAOC,CAPD;CASA,iBAZD,MAcA;CACC,qBAAKA,oBAAL,GAA4B,SAA5B;CACA;CACD;CACD;;CACD,YAAIoL,SAAS,KAAK,+CAAlB,EACA;CACC,cAAIxD,UAAU,KAAK,KAAK7H,WAAxB,EACA;CACC;CACA,iBAAKC,oBAAL,GAA4B,SAA5B;CACA;CAED;CACD;CACD;CA7jBF;CAAA;CAAA,8CAgkBC;CACC,UAAM6C,KAAK,GAAGC,uBAAY,CAACuI,YAAb,CAA0B,KAAKzK,gBAA/B,CAAd;;CACA,UAAIiC,KAAK,IAAIA,KAAK,CAACyI,OAAN,EAAb,EACA;CACCzI,QAAAA,KAAK,CAACP,KAAN;CACA;;CACD,WAAKuE,UAAL;CACA;CAvkBF;CAAA;CAAA,qCAykBkBK,QAzkBlB,EA0kBC;CAAA;;CACC,WAAK3G,qBAAL,GAA6B2G,QAA7B;;CACA,UAAIgE,cAAI,CAACK,SAAL,CAAe,KAAK/K,yBAApB,CAAJ,EACA;CACC,aAAKA,yBAAL,CAA+BgL,WAA/B,GACC,KAAKnL,cAAL,CAAoBmI,MAApB,CAA2B,UAACC,IAAD,EAAOC,IAAP;CAAA,iBAAiBA,IAAI,CAACC,KAAL,KAAe,OAAI,CAACpI,qBAApB,GAA4CmI,IAAI,CAAChD,KAAjD,GAAyD+C,IAA1E;CAAA,SAA3B,EAA4G,EAA5G,CADD;CAEA;;CACD,WAAKkB,iBAAL;CACA;CAllBF;CAAA;CAAA,kCAqlBC;CACC,UAAI,KAAKjJ,aAAT,EACA;CACCI,QAAAA,EAAE,CAAC2K,MAAH,CAAUvH,IAAV,CAAe,0BAAwB,KAAKxD,aAA5C;CACA;CACD;CA1lBF;CAAA;CAAA,uCA4lBoBmF,KA5lBpB,EA6lBC;CACC,UAAI6F,GAAG,CAAC5K,EAAJ,CAAO6K,GAAP,IAAcD,GAAG,CAAC5K,EAAJ,CAAO6K,GAAP,CAAWC,MAA7B,EACA;CACC,YAAIC,MAAM,GAAGH,GAAG,CAAC5K,EAAJ,CAAO6K,GAAP,CAAWC,MAAX,CAAkBE,IAAlB,CAAuBC,WAAvB,EAAb;;CACA,YAAIF,MAAJ,EACA;CACCA,UAAAA,MAAM,CAACG,MAAP;CACA;CACD;;CACD,UAAIN,GAAG,CAAC5K,EAAJ,CAAOmL,IAAP,CAAYC,WAAhB,EACA;CACC,YAAIC,MAAM,GAAG,SAAUrL,EAAE,CAACgE,aAAH,CAAiBC,WAAjB,CAA6B,KAAKjF,aAAlC,CAAV,GAA6D,WAA1E,CADD;;CAEC,YAAIsM,IAAI,GAAGV,GAAG,CAAC5K,EAAJ,CAAOmL,IAAP,CAAYC,WAAZ,CAAwBG,eAAxB,CAAwCF,MAAxC,CAAX;;CACA,YAAIC,IAAJ,EACA;CACCA,UAAAA,IAAI,CAACJ,MAAL;CACA;CACD;CACD;CA/mBF;CAAA;CAAA,2BAinBenL,MAjnBf,EAknBC;CACC,UAAIyL,UAAU,GAAG,IAAI3M,gBAAJ,EAAjB;CACA2M,MAAAA,UAAU,CAACC,UAAX,CAAsB1L,MAAtB;CACA,aAAOyL,UAAP;CACA;CAtnBF;CAAA;CAAA,+BAwnBmBE,QAxnBnB,EAwnB6B3H,cAxnB7B,EAynBC;CACC,UAAI,CAACqG,cAAI,CAACuB,QAAL,CAAc9M,gBAAgB,CAAC+M,eAA/B,CAAL,EACA;CACC/M,QAAAA,gBAAgB,CAAC+M,eAAjB,GAAmC,EAAnC;CACA;;CACD/M,MAAAA,gBAAgB,CAAC+M,eAAjB,CAAiC7H,cAAjC,IAAmD2H,QAAnD;CACA;CA/nBF;CAAA;CAAA,+BAioBmB3H,cAjoBnB,EAkoBC;CACC,aAAOlF,gBAAgB,CAAC+M,eAAjB,CAAiC7H,cAAjC,CAAP;CACA;CApoBF;CAAA;CAAA;CAwoBApF,SAAS,CAACE,gBAAV,GAA6BA,gBAA7B;;;;;;;;"}