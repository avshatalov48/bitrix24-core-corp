(function(t,e,i,n,r,s,a){"use strict";var o,l;var c=900;var m=600;var p=e.Reflection.namespace("BX.Crm");var u=function(t){babelHelpers.inherits(s,t);function s(t){var i;babelHelpers.classCallCheck(this,s);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(s).call(this,t));if(e.Type.isPlainObject(t)){i.activityEditorId=t.activityEditorId;if(e.Type.isPlainObject(t.emailSettings)){i.emailSettings=t.emailSettings}if(e.Type.isArray(t.printTemplates)){i.printTemplates=t.printTemplates;i.isMultipleTemplates=Boolean(i.printTemplates.length>1)}if(e.Type.isPlainObject(t.conversion)){i.conversionSettings=t.conversion}}return i}babelHelpers.createClass(s,[{key:"init",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(s.prototype),"init",this).call(this);if(this.conversionSettings){this.initConversionApi()}}},{key:"initConversionApi",value:function t(){var e=this;var i=a.Conversion.Manager.Instance.initializeConverter(this.entityTypeId,this.conversionSettings.converter);var n=new a.Conversion.SchemeSelector(i,this.conversionSettings.schemeSelector);if(this.conversionSettings.lockScript){n.subscribe("SchemeSelector:onSchemeSelected",this.conversionSettings.lockScript);n.subscribe("SchemeSelector:onContainerClick",this.conversionSettings.lockScript);r.EventEmitter.subscribe("CrmCreateDealFromQuote",this.conversionSettings.lockScript);r.EventEmitter.subscribe("CrmCreateInvoiceFromQuote",this.conversionSettings.lockScript)}else{n.enableAutoConversion();var s=function t(n){var r=i.getConfig().getScheme().getItemForSingleEntityTypeId(n);if(!r){console.error("SchemeItem with single entityTypeId "+n+" is not found");return}i.getConfig().updateFromSchemeItem(r);i.convert(e.id)};r.EventEmitter.subscribe("CrmCreateDealFromQuote",(function(){s(BX.CrmEntityType.enumeration.deal)}));r.EventEmitter.subscribe("CrmCreateInvoiceFromQuote",(function(){s(BX.CrmEntityType.enumeration.invoice)}));r.EventEmitter.subscribe("BX.Crm.ItemListComponent:onAddNewItemButtonClick",(function(t){var e=Number(t.getData().entityTypeId);if(e>0){s(e)}}))}}},{key:"bindEvents",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(s.prototype),"bindEvents",this).call(this);r.EventEmitter.subscribe("BX.Crm.ItemDetailsComponent:onClickPrint",this.handlePrintOrPdf.bind(this));r.EventEmitter.subscribe("BX.Crm.ItemDetailsComponent:onClickPdf",this.handlePrintOrPdf.bind(this));r.EventEmitter.subscribe("BX.Crm.ItemDetailsComponent:onClickEmail",this.handleEmail.bind(this))}},{key:"handlePrintOrPdf",value:function t(i){var n=this;if(!this.validatePrintTemplates()){return}var r=this.normalizeUrl(new e.Uri(i.getData().link));var s=Boolean(i.getData().openInNewWindow);if(this.isMultipleTemplates){this.openTemplateSelectDialog().then((function(t){n.openPrintWindow(r,t,s)}))["catch"]((function(){}))}else{var a=this.getSinglePrintTemplate();this.openPrintWindow(r,a.id,s)}}},{key:"validatePrintTemplates",value:function t(){if(!e.Type.isArray(this.printTemplates)||this.printTemplates.length<=0){this.showError(this.messages.errorNoPrintTemplates);return false}return true}},{key:"getSinglePrintTemplate",value:function t(){return this.printTemplates[this.printTemplates.length-1]}},{key:"openTemplateSelectDialog",value:function t(){var r=this;return new Promise((function(t,s){var a=e.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-form ui-form-line">\n\t\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t\t\t<div class="ui-ctl-label-text">','</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown">\n\t\t\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t\t\t<select class="ui-ctl-element">\n\t\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t'])),r.messages.template);var c=a.querySelector("select");r.printTemplates.forEach((function(t){var i=t.id,n=t.name;c.appendChild(e.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral([' <option value="','">',"</option> "])),e.Text.encode(i),e.Text.encode(n)))}));var m=new i.Popup({titleBar:r.messages.selectTemplate,content:a,closeByEsc:true,closeIcon:true,buttons:[new n.Button({text:r.messages.print,onclick:function e(i,n){var r=c.value;m.destroy();t(Number(r))}})],events:{onClose:function t(){s("Template select dialog was closed")}}});m.show()}))}},{key:"openPrintWindow",value:function t(e,i,n){e.setQueryParam("PAY_SYSTEM_ID",i);if(n){jsUtils.OpenWindow(e.toString(),c,m)}else{jsUtils.Redirect([],e.toString())}}},{key:"handleEmail",value:function t(){var e=this;if(!this.validatePrintTemplates()){return}if(!this.emailSettings){this.showError(this.messages.errorNoEmailSettings);return}if(this.isMultipleTemplates){this.openTemplateSelectDialog().then((function(t){e.sendViaEmail(t)}))["catch"]((function(){}))}else{var i=this.getSinglePrintTemplate();this.sendViaEmail(i.id)}}},{key:"sendViaEmail",value:function t(e){var i=this;this.emailSettings.ownerPSID=e;if(!top.BX.SidePanel.Instance){this.modifyEmailSettings(this.emailSettings).then((function(t){i.getActivityEditor().addEmail(t)}))["catch"](this.showErrorsFromResponse.bind(this));return}this.getActivityEditor().addEmail(this.emailSettings)}},{key:"modifyEmailSettings",value:function t(i){return e.ajax.runComponentAction("bitrix:crm.quote.details","createEmailAttachment",{mode:"class",signedParameters:this.signedParameters,analyticsLabel:"crmQuoteDetailsSendViaEmail",data:{entityTypeId:this.entityTypeId,id:this.id,paymentSystemId:i.ownerPSID}}).then((function(t){var e=t.data;i.storageTypeID=e["STORAGE_TYPE_ID"];if(i.storageTypeID===BX.CrmActivityStorageType.webdav){i.webdavelements=[e]}else if(i.storageTypeID===BX.CrmActivityStorageType.disk){i.diskfiles=[Number(e.ID)]}else if(i.storageTypeID===BX.CrmActivityStorageType.file){i.files=[e]}return i}))}},{key:"getActivityEditor",value:function t(){return BX.CrmActivityEditor.items[this.activityEditorId]}}]);return s}(s.ItemDetailsComponent);p.QuoteDetailsComponent=u})(this.window=this.window||{},BX,BX.Main,BX.UI,BX.Event,BX.Crm,BX.Crm);
//# sourceMappingURL=script.map.js