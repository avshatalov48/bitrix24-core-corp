(function(t,e,i,n,s,r,a,o){"use strict";var l,c;var m=900;var p=600;var u=s.Reflection.namespace("BX.Crm");var d=function(t){babelHelpers.inherits(n,t);function n(t){var e;babelHelpers.classCallCheck(this,n);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this,t));if(s.Type.isPlainObject(t)){e.activityEditorId=t.activityEditorId;if(s.Type.isPlainObject(t.emailSettings)){e.emailSettings=t.emailSettings}if(s.Type.isArray(t.printTemplates)){e.printTemplates=t.printTemplates;e.isMultipleTemplates=Boolean(e.printTemplates.length>1)}if(s.Type.isPlainObject(t.conversion)){e.conversionSettings=t.conversion}}return e}babelHelpers.createClass(n,[{key:"init",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(n.prototype),"init",this).call(this);if(this.conversionSettings){this.initConversionApi()}}},{key:"initConversionApi",value:function t(){var n=this;var s=e.Conversion.Manager.Instance.initializeConverter(this.entityTypeId,this.conversionSettings.converter);var a=new e.Conversion.SchemeSelector(s,this.conversionSettings.schemeSelector);if(this.conversionSettings.lockScript){a.subscribe("onSchemeSelected",this.conversionSettings.lockScript);a.subscribe("onContainerClick",this.conversionSettings.lockScript);r.EventEmitter.subscribe("CrmCreateDealFromQuote",this.conversionSettings.lockScript);r.EventEmitter.subscribe("CrmCreateInvoiceFromQuote",this.conversionSettings.lockScript)}else{a.enableAutoConversion();var o=function t(e){var r=s.getConfig().getScheme().getItemForSingleEntityTypeId(e);if(!r){console.error("SchemeItem with single entityTypeId "+e+" is not found");return}s.getConfig().updateFromSchemeItem(r);s.setAnalyticsElement(i.Dictionary.ELEMENT_CREATE_LINKED_ENTITY_BUTTON);s.convert(n.id)};r.EventEmitter.subscribe("CrmCreateDealFromQuote",(function(){o(BX.CrmEntityType.enumeration.deal)}));r.EventEmitter.subscribe("CrmCreateInvoiceFromQuote",(function(){o(BX.CrmEntityType.enumeration.invoice)}));r.EventEmitter.subscribe("BX.Crm.ItemListComponent:onAddNewItemButtonClick",(function(t){var e=Number(t.getData().entityTypeId);if(e>0){o(e)}}))}}},{key:"bindEvents",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(n.prototype),"bindEvents",this).call(this);r.EventEmitter.subscribe("BX.Crm.ItemDetailsComponent:onClickPrint",this.handlePrintOrPdf.bind(this));r.EventEmitter.subscribe("BX.Crm.ItemDetailsComponent:onClickPdf",this.handlePrintOrPdf.bind(this));r.EventEmitter.subscribe("BX.Crm.ItemDetailsComponent:onClickEmail",this.handleEmail.bind(this))}},{key:"handlePrintOrPdf",value:function t(e){var i=this;if(!this.validatePrintTemplates()){return}var n=this.normalizeUrl(new s.Uri(e.getData().link));var r=Boolean(e.getData().openInNewWindow);if(this.isMultipleTemplates){this.openTemplateSelectDialog().then((function(t){i.openPrintWindow(n,t,r)}))["catch"]((function(){}))}else{var a=this.getSinglePrintTemplate();this.openPrintWindow(n,a.id,r)}}},{key:"validatePrintTemplates",value:function t(){if(!s.Type.isArray(this.printTemplates)||this.printTemplates.length<=0){this.showError(this.messages.errorNoPrintTemplates);return false}return true}},{key:"getSinglePrintTemplate",value:function t(){return this.printTemplates[this.printTemplates.length-1]}},{key:"openTemplateSelectDialog",value:function t(){var e=this;return new Promise((function(t,i){var n=s.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-form ui-form-line">\n\t\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t\t\t<div class="ui-ctl-label-text">','</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown">\n\t\t\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t\t\t<select class="ui-ctl-element">\n\t\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t'])),e.messages.template);var r=n.querySelector("select");e.printTemplates.forEach((function(t){var e=t.id,i=t.name;r.appendChild(s.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral([' <option value="','">',"</option> "])),s.Text.encode(e),s.Text.encode(i)))}));var m=new a.Popup({titleBar:e.messages.selectTemplate,content:n,closeByEsc:true,closeIcon:true,buttons:[new o.Button({text:e.messages.print,onclick:function e(i,n){var s=r.value;m.destroy();t(Number(s))}})],events:{onClose:function t(){i("Template select dialog was closed")}}});m.show()}))}},{key:"openPrintWindow",value:function t(e,i,n){e.setQueryParam("PAY_SYSTEM_ID",i);if(n){jsUtils.OpenWindow(e.toString(),m,p)}else{jsUtils.Redirect([],e.toString())}}},{key:"handleEmail",value:function t(){var e=this;if(!this.validatePrintTemplates()){return}if(!this.emailSettings){this.showError(this.messages.errorNoEmailSettings);return}if(this.isMultipleTemplates){this.openTemplateSelectDialog().then((function(t){e.sendViaEmail(t)}))["catch"]((function(){}))}else{var i=this.getSinglePrintTemplate();this.sendViaEmail(i.id)}}},{key:"sendViaEmail",value:function t(e){var i=this;this.emailSettings.ownerPSID=e;if(!top.BX.SidePanel.Instance){this.modifyEmailSettings(this.emailSettings).then((function(t){i.getActivityEditor().addEmail(t)}))["catch"](this.showErrorsFromResponse.bind(this));return}this.getActivityEditor().addEmail(this.emailSettings)}},{key:"modifyEmailSettings",value:function t(e){return s.ajax.runComponentAction("bitrix:crm.quote.details","createEmailAttachment",{mode:"class",signedParameters:this.signedParameters,analyticsLabel:"crmQuoteDetailsSendViaEmail",data:{entityTypeId:this.entityTypeId,id:this.id,paymentSystemId:e.ownerPSID}}).then((function(t){var i=t.data;e.storageTypeID=i["STORAGE_TYPE_ID"];if(e.storageTypeID===BX.CrmActivityStorageType.webdav){e.webdavelements=[i]}else if(e.storageTypeID===BX.CrmActivityStorageType.disk){e.diskfiles=[Number(i.ID)]}else if(e.storageTypeID===BX.CrmActivityStorageType.file){e.files=[i]}return e}))}},{key:"getActivityEditor",value:function t(){return BX.CrmActivityEditor.items[this.activityEditorId]}}]);return n}(n.ItemDetailsComponent);u.QuoteDetailsComponent=d})(this.window=this.window||{},BX.Crm,BX.Crm.Integration.Analytics,BX.Crm,BX,BX.Event,BX.Main,BX.UI);
//# sourceMappingURL=script.map.js