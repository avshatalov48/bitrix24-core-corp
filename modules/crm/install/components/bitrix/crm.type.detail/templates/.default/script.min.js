(function(e,t,i,s,n,r,a,o,l,c,d,u){"use strict";var h,m,f,p,v,y,S,b,g;function C(e,t,i,s){I(e,t);T(i,"set");E(e,i,s);return s}function E(e,t,i){if(t.set){t.set.call(e,i)}else{if(!t.writable){throw new TypeError("attempted to set read only private field")}t.value=i}}function k(e,t,i){I(e,t);T(i,"get");return w(e,i)}function T(e,t){if(e===undefined){throw new TypeError("attempted to "+t+" private static field before its declaration")}}function I(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function w(e,t){if(t.get){return t.get.call(e)}return t.value}function D(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=A(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var s=0;var n=function e(){};return{s:n,n:function t(){if(s>=e.length)return{done:true};return{done:false,value:e[s++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,a=false,o;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){a=true;o=t},f:function e(){try{if(!r&&i["return"]!=null)i["return"]()}finally{if(a)throw o}}}}function A(e,t){if(!e)return;if(typeof e==="string")return B(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return B(e,t)}function B(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,s=new Array(t);i<t;i++)s[i]=e[i];return s}function P(e,t){N(e,t);t.add(e)}function U(e,t,i){N(e,t);t.set(e,i)}function N(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function L(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var R=r.Reflection.namespace("BX.Crm.Component");var _=null;var M=new WeakMap;var F=new WeakSet;var H=new WeakSet;var q=new WeakSet;var O=new WeakSet;var x=function(){function e(t){babelHelpers.classCallCheck(this,e);P(this,O);P(this,q);P(this,H);P(this,F);babelHelpers.defineProperty(this,"isProgress",false);babelHelpers.defineProperty(this,"tabs",new Map);babelHelpers.defineProperty(this,"isRestricted",false);babelHelpers.defineProperty(this,"isExternal",false);babelHelpers.defineProperty(this,"isSaveFromTypeDetail",true);babelHelpers.defineProperty(this,"isCreateSectionsViaAutomatedSolutionDetails",false);babelHelpers.defineProperty(this,"canEditAutomatedSolution",false);babelHelpers.defineProperty(this,"permissionsUrl",null);U(this,M,{writable:true,value:false});if(r.Type.isPlainObject(t)){this.type=t.type;this.isNew=!this.type.isSaved();this.form=t.form;this.container=t.container;this.errorsContainer=t.errorsContainer;this.presets=t.presets;this.relations=t.relations;this.isRestricted=Boolean(t.isRestricted);this.restrictionErrorMessage=r.Type.isStringFilled(t.restrictionErrorMessage)?t.restrictionErrorMessage:"";this.restrictionSliderCode=r.Type.isStringFilled(t.restrictionSliderCode)&&this.isRestricted?t.restrictionSliderCode:null;this.isExternal=Boolean(t.isExternal);this.isCreateSectionsViaAutomatedSolutionDetails=Boolean(t.isCreateSectionsViaAutomatedSolutionDetails);this.canEditAutomatedSolution=Boolean(t.canEditAutomatedSolution);if(r.Type.isStringFilled(t.permissionsUrl)){this.permissionsUrl=t.permissionsUrl}}this.buttonsPanel=document.getElementById("ui-button-panel");this.saveButton=document.getElementById("ui-button-panel-save");this.cancelButton=document.getElementById("ui-button-panel-cancel");this.deleteButton=document.getElementById("ui-button-panel-remove");_=this}babelHelpers.createClass(e,[{key:"init",value:function e(){this.bindEvents();this.fillTabs();if(this.type.getId()){this.disablePresetsView();var t=document.querySelector('[data-role="preset-selector-container"]');if(t){r.Dom.addClass(t,"crm-type-hidden")}}else{this.enablePresetsView()}r.Dom.removeClass(document.querySelector("body"),"crm-type-hidden");this.initRelations();this.initCustomSections()}},{key:"bindEvents",value:function e(){var i=this;r.Event.bind(this.saveButton,"click",(function(e){i.save(e)}),{passive:false});if(this.deleteButton){r.Event.bind(this.deleteButton,"click",(function(e){i["delete"](e)}))}var s=this.getBooleanFieldNodeByName("isUseInUserfieldEnabled");if(s){r.Event.bind(s,"click",this.disableLinkedUserFieldsIfNotAvailable.bind(this))}this.form.querySelectorAll('[data-name*="linkedUserFields"]').forEach((function(e){r.Event.bind(e,"click",i.enableUserFieldIfAnyLinkedChecked.bind(i))}));a.EventEmitter.subscribe("SidePanel.Slider:onCloseByEsc",(function(e){var s=e.getData(),n=babelHelpers.slicedToArray(s,1),r=n[0];var a=r.getSlider();if(a===i.getSlider()){L(i,F,j).call(i,t.Dictionary.ELEMENT_ESC_BUTTON)}}));a.EventEmitter.subscribe("SidePanel.Slider:onClose",(function(e){var t=e.getData(),s=babelHelpers.slicedToArray(t,1),n=s[0];var r=n.getSlider();if(r===i.getSlider()){L(i,F,j).call(i,null)}}));this.handleSliderDestroy=this.handleSliderDestroy.bind(this);top.BX.Event.EventEmitter.subscribe("SidePanel.Slider:onDestroy",this.handleSliderDestroy)}},{key:"handleSliderDestroy",value:function e(t){var i=t.getData(),s=babelHelpers.slicedToArray(i,1),n=s[0];var r=n.getSlider();if(r.getFrameWindow()===window){this.destroy();top.BX.Event.EventEmitter.unsubscribe("SidePanel.Slider:onDestroy",this.handleSliderDestroy)}}},{key:"destroy",value:function e(){var t;(t=this.customSectionController)===null||t===void 0?void 0:t.destroy()}},{key:"enablePresetsView",value:function e(){r.Dom.addClass(document.querySelector("body"),"crm-type-settings-presets");var t=this.container.querySelector(".crm-type-tab-current");if(t){r.Dom.removeClass(t,"crm-type-tab-current")}var i=this.container.querySelector('[data-tab="presets"]');if(i){r.Dom.addClass(i,"crm-type-tab-current")}var s=document.querySelector('[data-role="preset-selector-container"]');if(s){r.Dom.addClass(s,"crm-type-hidden")}r.Dom.removeClass(document.getElementById("pagetitle"),"crm-type-hidden");r.Dom.addClass(this.buttonsPanel,"crm-type-hidden");this.hideErrors()}},{key:"disablePresetsView",value:function e(){var t;r.Dom.removeClass(document.querySelector("body"),"crm-type-settings-presets");((t=L(this,H,V).call(this))!==null&&t!==void 0?t:L(this,q,X).call(this)).click();var i=document.querySelector('[data-role="preset-selector-container"]');if(i){r.Dom.removeClass(i,"crm-type-hidden")}r.Dom.addClass(document.getElementById("pagetitle"),"crm-type-hidden");r.Dom.removeClass(this.buttonsPanel,"crm-type-hidden")}},{key:"disableLinkedUserFieldsIfNotAvailable",value:function e(){var t=this;var i=this.getBooleanFieldNodeByName("isUseInUserfieldEnabled");if(!this.isBooleanFieldChecked(i)){this.form.querySelectorAll('[data-name*="linkedUserFields"]').forEach((function(e){t.setBooleanFieldCheckedState(e,false)}))}}},{key:"enableUserFieldIfAnyLinkedChecked",value:function e(){var t=this;var i=this.getBooleanFieldNodeByName("isUseInUserfieldEnabled");if(!this.isBooleanFieldChecked(i)){this.form.querySelectorAll('[data-name*="linkedUserFields"]').forEach((function(e){if(t.isBooleanFieldChecked(e)){t.setBooleanFieldCheckedState(i,true)}}))}}},{key:"getLoader",value:function e(){if(!this.loader){this.loader=new o.Loader({size:150})}return this.loader}},{key:"startProgress",value:function e(){this.isProgress=true;if(!this.getLoader().isShown()){this.getLoader().show(this.form)}this.hideErrors()}},{key:"stopProgress",value:function e(){var t=this;this.isProgress=false;this.getLoader().hide();setTimeout((function(){r.Dom.removeClass(t.saveButton,"ui-btn-wait");r.Dom.removeClass(t.cancelButton,"ui-btn-wait");if(t.deleteButton){r.Dom.removeClass(t.deleteButton,"ui-btn-wait")}}),200)}},{key:"save",value:function e(i){var s=this;if(this.isRestricted){if(r.Type.isStringFilled(this.restrictionSliderCode)&&r.Reflection.getClass("BX.UI.InfoHelper.show")){BX.UI.InfoHelper.show(this.restrictionSliderCode)}else{this.showErrors([this.restrictionErrorMessage])}this.stopProgress();return}i.preventDefault();if(!this.form){return}if(this.isProgress){return}if(!this.type){return}this.startProgress();this.type.setTitle(this.form.querySelector('[name="title"]').value);n.TypeModel.getBooleanFieldNames().forEach((function(e){var t=s.getBooleanFieldNodeByName(e);if(t){s.type.data[e]=s.isBooleanFieldChecked(t)}}));var a={};this.form.querySelectorAll('[data-name*="linkedUserFields"]').forEach((function(e){var t=e.dataset.name.slice("linkedUserFields[".length).replace("]","");a[t]=s.isBooleanFieldChecked(e)}));this.type.setLinkedUserFields(a);this.type.setRelations({parent:this.parentRelationsController.getData(),child:this.childRelationsController.getData()});if(this.customSectionController){var o=this.customSectionController.getData();this.type.setCustomSectionId(o.customSectionId);this.type.setCustomSections(o.customSections);this.type.setIsExternalDynamicalType(this.isExternal);this.type.setIsSaveFromTypeDetail(this.isSaveFromTypeDetail)}var c=L(this,O,W).call(this).setElement(t.Dictionary.ELEMENT_CREATE_BUTTON);l.sendData(c.setStatus(t.Dictionary.STATUS_ATTEMPT).buildData());this.type.save().then((function(e){l.sendData(c.setStatus(t.Dictionary.STATUS_SUCCESS).setId(s.type.getId()).buildData());babelHelpers.classPrivateFieldSet(s,M,true);s.stopProgress();s.afterSave(e);s.isNew=false}))["catch"]((function(e){l.sendData(c.setStatus(t.Dictionary.STATUS_ERROR).setId(s.type.getId()).buildData());s.showErrors(e);s.stopProgress()}))}},{key:"collectEntityTypeIds",value:function e(t){var i=[];var s=this.container.querySelectorAll('[data-role="'.concat(t,'"]'));babelHelpers.toConsumableArray(s).forEach((function(e){if(e.checked){i.push(e.dataset.entityTypeId)}}));return i}},{key:"afterSave",value:function e(t){var s;this.addDataToSlider("response",t);if(Object.hasOwn(t.data,"urlTemplates")){i.Router.Instance.setUrlTemplates(t.data.urlTemplates)}(s=this.getSlider())===null||s===void 0?void 0:s.close();this.emitTypeUpdatedEvent({isUrlChanged:t.data.isUrlChanged===true})}},{key:"getSlider",value:function e(){var t,i;return(t=BX.SidePanel)===null||t===void 0?void 0:(i=t.Instance)===null||i===void 0?void 0:i.getSliderByWindow(window)}},{key:"emitTypeUpdatedEvent",value:function e(t){s.ToolbarComponent.Instance.emitTypeUpdatedEvent(t)}},{key:"addDataToSlider",value:function e(t,i){if(r.Type.isString(t)&&r.Type.isPlainObject(i)){var s=this.getSlider();if(s){s.data.set(t,i)}}}},{key:"showErrors",value:function e(t){var i="";t.forEach((function(e){i+=e}));if(r.Type.isDomNode(this.errorsContainer)){this.errorsContainer.innerText=i;r.Dom.style(this.errorsContainer.parentNode,"display","block")}else{console.error(i)}}},{key:"hideErrors",value:function e(){if(r.Type.isDomNode(this.errorsContainer)){r.Dom.style(this.errorsContainer.parentNode,"display","none");this.errorsContainer.innerText=""}}},{key:"delete",value:function e(s){var n=this;s.preventDefault();if(!this.form){return}if(this.isProgress){return}if(!this.type){return}var a=new r.Uri(decodeURI(window.location.href));var o=(new t.Builder.Automation.Type.DeleteEvent).setElement(t.Dictionary.ELEMENT_DELETE_BUTTON).setIsExternal(this.isExternal).setSubSection(a.getQueryParam("c_sub_section")).setId(this.type.getId());c.MessageBox.confirm(r.Loc.getMessage("CRM_TYPE_DETAIL_DELETE_CONFIRM"),(function(){return new Promise((function(e){l.sendData(o.setStatus(t.Dictionary.STATUS_ATTEMPT).buildData());n.startProgress();n.type["delete"]().then((function(e){l.sendData(o.setStatus(t.Dictionary.STATUS_SUCCESS).buildData());babelHelpers.classPrivateFieldSet(n,M,true);n.stopProgress();var s=r.Type.isObject(e.data)&&e.data.isUrlChanged===true;n.emitTypeUpdatedEvent({isUrlChanged:s});i.Router.Instance.closeSliderOrRedirect(i.Router.Instance.getTypeListUrl())}))["catch"]((function(i){l.sendData(o.setStatus(t.Dictionary.STATUS_ERROR).buildData());n.showErrors(i);n.stopProgress();e()}))}))}),null,(function(e){l.sendData(o.setStatus(t.Dictionary.STATUS_CANCEL).buildData());n.stopProgress();e.close()}))}},{key:"fillTabs",value:function e(){var t=this;if(this.container){this.container.querySelectorAll(".crm-type-tab").forEach((function(e){if(e.dataset.tab){t.tabs.set(e.dataset.tab,e)}}))}}},{key:"showTab",value:function e(t){var i=this;babelHelpers.toConsumableArray(this.tabs.keys()).forEach((function(e){if(e===t){r.Dom.addClass(i.tabs.get(e),"crm-type-tab-current")}else{r.Dom.removeClass(i.tabs.get(e),"crm-type-tab-current")}}))}},{key:"applyPreset",value:function e(t){var i=this;this.disablePresetsView();var s=document.querySelector('[data-role="crm-type-preset-selector"]');var n=this.container.querySelector('[data-role="preset"].crm-type-preset-active');if(n){var a=this.getPresetById(n.dataset.presetId);if(a&&a.data.title&&this.form.querySelector('[name="title"]').value===a.data.title){this.form.querySelector('[name="title"]').value=""}}var o=this.container.querySelectorAll('[data-role="preset"]');o.forEach((function(e){r.Dom.removeClass(e,"crm-type-preset-active");if(e.dataset.presetId===t){r.Dom.addClass(e,"crm-type-preset-active");var n=i.getPresetById(t);if(n){i.updateInputs(n.data);if(s){s.textContent=r.Text.encode(n.fields.title)}}}}));this.selectedPresetId=t}},{key:"getPresetById",value:function e(t){var i=D(this.presets),s;try{for(i.s();!(s=i.n()).done;){var n=s.value;if(n.fields.id===t){return n}}}catch(e){i.e(e)}finally{i.f()}return null}},{key:"updateInputs",value:function e(t){var i=this;if(this.form.querySelector('[name="title"]').value.length<=0){this.form.querySelector('[name="title"]').value=t.title||""}n.TypeModel.getBooleanFieldNames().forEach((function(e){var s=i.getBooleanFieldNodeByName(e);if(s){i.setBooleanFieldCheckedState(s,t[e])}}));this.disableLinkedUserFieldsIfNotAvailable()}},{key:"toggleBooleanField",value:function e(t){var i=this.getBooleanFieldNodeByName(t);if(!i){return}if(i.nodeName==="INPUT"){i.checked=!i.checked}else{r.Dom.toggleClass(i,"crm-type-field-button-item-active")}}},{key:"getBooleanFieldNodeByName",value:function e(t){return this.container.querySelector('[data-name="'.concat(t,'"]'))}},{key:"isBooleanFieldChecked",value:function e(t){if(t.nodeName==="INPUT"){return t.checked}return r.Dom.hasClass(t,"crm-type-field-button-item-active")}},{key:"setBooleanFieldCheckedState",value:function e(t,i){if(t.nodeName==="INPUT"){t.checked=i;return}if(i){r.Dom.addClass(t,"crm-type-field-button-item-active")}else{r.Dom.removeClass(t,"crm-type-field-button-item-active")}}},{key:"initRelations",value:function e(){this.parentRelationsController=new G({switcher:BX.UI.Switcher.getById("crm-type-relation-parent-switcher"),container:this.container.querySelector('[data-role="crm-type-relation-parent-items"]'),typeSelectorContainer:this.container.querySelector('[data-role="crm-type-relation-parent-items-selector"]'),tabsContainer:this.container.querySelector('[data-role="crm-type-relation-parent-items-tabs"]'),tabsCheckbox:this.container.querySelector('[data-name="isRelationParentShowChildrenEnabled"]'),tabsSelectorContainer:this.container.querySelector('[data-role="crm-type-relation-parent-items-tabs-selector"]'),relations:this.relations.parent});this.childRelationsController=new G({switcher:BX.UI.Switcher.getById("crm-type-relation-child-switcher"),container:this.container.querySelector('[data-role="crm-type-relation-child-items"]'),typeSelectorContainer:this.container.querySelector('[data-role="crm-type-relation-child-items-selector"]'),tabsContainer:this.container.querySelector('[data-role="crm-type-relation-child-items-tabs"]'),tabsCheckbox:this.container.querySelector('[data-name="isRelationChildShowChildrenEnabled"]'),tabsSelectorContainer:this.container.querySelector('[data-role="crm-type-relation-child-items-tabs-selector"]'),relations:this.relations.child})}},{key:"initCustomSections",value:function e(){this.customSectionController=new z({switcher:BX.UI.Switcher.getById("crm-type-custom-section-switcher"),container:this.container.querySelector('[data-role="crm-type-custom-section-container"]'),selectorContainer:this.container.querySelector('[data-role="crm-type-custom-section-selector"]'),customSections:this.type.getCustomSections()||[],isCreateSectionsViaAutomatedSolutionDetails:this.isCreateSectionsViaAutomatedSolutionDetails,canEditAutomatedSolution:this.canEditAutomatedSolution,isNew:this.isNew,permissionsUrl:this.permissionsUrl})}}],[{key:"handleLeftMenuClick",value:function e(t){if(_){_.showTab(t)}}},{key:"handlePresetClick",value:function e(t){if(_){_.applyPreset(t)}}},{key:"handleHideDescriptionClick",value:function e(t){r.Dom.style(t.parentNode,"display","none")}},{key:"handleBooleanFieldClick",value:function e(t){var i;(i=_)===null||i===void 0?void 0:i.toggleBooleanField(t)}},{key:"handlePresetSelectorClick",value:function e(){var t;(t=_)===null||t===void 0?void 0:t.enablePresetsView()}},{key:"handleCancelButtonClick",value:function e(){var i;(i=_)===null||i===void 0?void 0:L(i,F,j).call(i,t.Dictionary.ELEMENT_CANCEL_BUTTON)}}]);return e}();function j(e){if(babelHelpers.classPrivateFieldGet(this,M)){return}babelHelpers.classPrivateFieldSet(this,M,true);l.sendData(L(this,O,W).call(this).setElement(e).setStatus(t.Dictionary.STATUS_CANCEL).buildData())}function V(){return document.querySelector(".ui-sidepanel-menu-item.ui-sidepanel-menu-active > [data-role^=tab-]")}function X(){return document.querySelector(".ui-sidepanel-menu-item > [data-role^=tab-]")}function W(){var e=this.isNew?new t.Builder.Automation.Type.CreateEvent:new t.Builder.Automation.Type.EditEvent;e.setIsExternal(this.isExternal);if(r.Type.isStringFilled(this.selectedPresetId)){e.setPreset(this.selectedPresetId)}if(this.type.getId()>0){e.setId(this.type.getId())}var i=new r.Uri(decodeURI(window.location.href));if(i.getQueryParam("c_sub_section")&&e instanceof t.Builder.Automation.Type.EditEvent){e.setSubSection(i.getQueryParam("c_sub_section"))}return e}R.TypeDetail=x;var G=function(){function e(t){babelHelpers.classCallCheck(this,e);this.switcher=t.switcher;this.container=t.container;this.typeSelectorContainer=t.typeSelectorContainer;this.tabsContainer=t.tabsContainer;this.tabsCheckbox=t.tabsCheckbox;this.tabsSelectorContainer=t.tabsSelectorContainer;this.relations=t.relations;this.initSelectors();this.adjustInitialState();this.bindEvents();this.adjust()}babelHelpers.createClass(e,[{key:"initSelectors",value:function e(){var t=[];var i=[];var s=[];var n=[];this.relations.forEach((function(e){var r={id:e.entityTypeId,entityId:"crmType",title:e.title,tabs:"recents"};if(e.isChecked){i.push(r);if(e.isChildrenListEnabled){n.push(r)}else{s.push(r)}}else{t.push(r)}}));this.typeSelector=new d.TagSelector({dialogOptions:{enableSearch:false,multiple:false,items:t,selectedItems:i,dropdownMode:true,height:200,showAvatars:false},events:{onAfterTagAdd:this.adjust.bind(this),onAfterTagRemove:this.adjust.bind(this)}});this.typeSelector.renderTo(this.typeSelectorContainer);this.tabsSelector=new d.TagSelector({dialogOptions:{enableSearch:false,multiple:false,items:s,selectedItems:n,dropdownMode:true,height:200,showAvatars:false}});this.tabsSelector.renderTo(this.tabsSelectorContainer)}},{key:"adjustInitialState",value:function e(){var t=this.typeSelector.getDialog().getSelectedItems();if(t.length>0){this.switcher.check(true)}this.tabsCheckbox.checked=this.tabsSelector.getDialog().getSelectedItems().length>0}},{key:"bindEvents",value:function e(){a.EventEmitter.subscribe(this.switcher,"toggled",this.adjust.bind(this));r.Event.bind(this.tabsCheckbox,"click",this.adjust.bind(this))}},{key:"adjust",value:function e(){var t=this;if(this.switcher.isChecked()){r.Dom.removeClass(this.container,"crm-type-hidden")}else{r.Dom.addClass(this.container,"crm-type-hidden")}var i=this.typeSelector.getDialog().getSelectedItems();if(i.length>0){r.Dom.removeClass(this.tabsContainer,"crm-type-hidden")}else{r.Dom.addClass(this.tabsContainer,"crm-type-hidden")}if(this.tabsCheckbox.checked){r.Dom.removeClass(this.tabsSelectorContainer,"crm-type-hidden")}else{r.Dom.addClass(this.tabsSelectorContainer,"crm-type-hidden")}this.tabsSelector.getDialog().getItems().forEach((function(e){if(!t.isItemSelected(e,i)){e.deselect();t.tabsSelector.getDialog().removeItem(e);t.tabsSelector.removeTag({id:e.getId(),entityId:e.getEntityId()})}}));i.forEach((function(e){var i={id:e.getId(),entityId:e.getEntityId(),title:e.getTitle(),tabs:"recents"};var s=t.tabsSelector.getDialog().getItem(i);if(!s){var n=t.tabsSelector.getDialog().addItem(i);n.select()}}))}},{key:"isItemSelected",value:function e(t,i){return i.some((function(e){return t.id===e.id}))}},{key:"getData",value:function e(){var t=this;var i=[];if(!this.switcher.isChecked()){return[]}var s=this.tabsCheckbox.checked;var n=this.typeSelector.getDialog().getSelectedItems();n.forEach((function(e){var n={entityTypeId:e.getId(),isChildrenListEnabled:false};if(s&&t.isItemSelected(e,t.tabsSelector.getDialog().getSelectedItems())){n.isChildrenListEnabled=true}i.push(n)}));return i}}]);return e}();var z=function(){function e(t){var i;babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"permissionsResetAlert",null);babelHelpers.defineProperty(this,"isPermissionsResetAlertShown",false);babelHelpers.defineProperty(this,"permissionsUrl",null);this.switcher=t.switcher;this.container=t.container;this.selectorContainer=t.selectorContainer;if(r.Type.isArray(t.customSections)){this.customSections=t.customSections}else{this.customSections=[]}this.originallySelectedCustomSection=(i=this.customSections.find((function(e){return e.isSelected})))!==null&&i!==void 0?i:null;this.isNew=r.Type.isBoolean(t.isNew)?t.isNew:false;if(r.Type.isBoolean(t.isCreateSectionsViaAutomatedSolutionDetails)){this.isCreateSectionsViaAutomatedSolutionDetails=t.isCreateSectionsViaAutomatedSolutionDetails}if(r.Type.isBoolean(t.canEditAutomatedSolution)){this.canEditAutomatedSolution=t.canEditAutomatedSolution}if(r.Type.isStringFilled(t.permissionsUrl)){this.permissionsUrl=t.permissionsUrl}this.initSelector();this.settingsContainer=r.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-type-hidden crm-type-custom-sections-settings-container">\n\t\t\t\t<div class="crm-type-relation-subtitle">',"</div>\n\t\t\t</div>\n\t\t"])),r.Loc.getMessage("CRM_TYPE_DETAIL_CUSTOM_SECTION_LIST_MSGVER_1"));this.container.append(this.settingsContainer);this.adjustInitialState();this.bindEvents();this.adjust()}babelHelpers.createClass(e,[{key:"destroy",value:function e(){var t;this.unbindEvents();(t=this.selector)===null||t===void 0?void 0:t.unsubscribeAll()}},{key:"initSelector",value:function e(){var t=[];var i=[];this.customSections.forEach((function(e){var s={id:e.id,entityId:"custom-section",title:e.title,tabs:"recents"};t.push(s);if(e.isSelected){i.push(s)}}));var s=r.Runtime.debounce(this.adjustResetPermissionsAlert.bind(this),200);var n={multiple:false,dialogOptions:{items:t,selectedItems:i,dropdownMode:true,height:200,showAvatars:false},events:{onAfterTagRemove:s,onAfterTagAdd:s}};if(this.isCreateSectionsViaAutomatedSolutionDetails){n.showCreateButton=false;n.dialogOptions.footer=r.Tag.render(m||(m=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<a\n\t\t\t\t\tonclick="','"\n\t\t\t\t\tclass="ui-selector-footer-link ui-selector-footer-link-add"\n\t\t\t\t>',"</a>\n\t\t\t"])),this.onOpenAutomatedSolutionCreationSliderClick.bind(this),r.Loc.getMessage("CRM_COMMON_ACTION_CREATE"))}else{n.showCreateButton=true;n.createButtonCaption=r.Loc.getMessage("CRM_COMMON_ACTION_CONFIG");n.events={onCreateButtonClick:this.onCreateButtonClick.bind(this)}}if(!this.canEditAutomatedSolution){n.locked=true}this.selector=new d.TagSelector(n);this.selector.renderTo(this.selectorContainer)}},{key:"adjustResetPermissionsAlert",value:function e(){var t,i;if(!K.getInstance().isPermissionsLayoutV2Enabled()||this.permissionsUrl===null||this.isNew){return}var s=this.selector.getDialog().getSelectedItems();var n=(t=s[0])!==null&&t!==void 0?t:null;var r=this.getPermissionsResetAlert();var a=(n===null||n===void 0?void 0:n.getId())!==((i=this.originallySelectedCustomSection)===null||i===void 0?void 0:i.id)&&this.switcher.isChecked();var o=this.originallySelectedCustomSection&&!this.switcher.isChecked();var l=a||o;if(l){if(!this.isPermissionsResetAlertShown){this.isPermissionsResetAlertShown=true;r.renderTo(this.container.parentNode);r.show()}return}if(this.isPermissionsResetAlertShown){this.isPermissionsResetAlertShown=false;r.hide()}}},{key:"getPermissionsResetAlert",value:function e(){if(this.permissionsResetAlert===null){var t=r.Loc.getMessage("CRM_TYPE_DETAIL_PERMISSIONS_WILL_BE_RESET_ALERT").replace("#LINK#",this.permissionsUrl);this.permissionsResetAlert=new u.Alert({size:u.AlertSize.MD,color:u.AlertColor.WARNING,customClass:"crm-type-permissions-reset-alert",text:t})}return this.permissionsResetAlert}},{key:"reInitSelector",value:function e(){this.selector.getDialog().destroy();this.selector.unsubscribeAll();this.selector=null;r.Dom.clean(this.selectorContainer);this.initSelector()}},{key:"showSelector",value:function e(){r.Dom.removeClass(this.selectorContainer,"crm-type-hidden")}},{key:"hideSelector",value:function e(){r.Dom.addClass(this.selectorContainer,"crm-type-hidden")}},{key:"adjustInitialState",value:function e(){var t=this.selector.getDialog().getSelectedItems();if(t.length>0){this.switcher.check(true)}}},{key:"bindEvents",value:function e(){this.adjust=this.adjust.bind(this);this.onAutomatedSolutionUpdate=this.onAutomatedSolutionUpdate.bind(this);a.EventEmitter.subscribe(this.switcher,"toggled",this.adjust);a.EventEmitter.subscribe(this.switcher,"toggled",this.adjustResetPermissionsAlert.bind(this));if(this.isCreateSectionsViaAutomatedSolutionDetails){s.ToolbarComponent.Instance.subscribeAutomatedSolutionUpdatedEvent(this.onAutomatedSolutionUpdate)}}},{key:"unbindEvents",value:function e(){a.EventEmitter.unsubscribe(this.switcher,"toggled",this.adjust);s.ToolbarComponent.Instance.unsubscribeAutomatedSolutionUpdatedEvent(this.onAutomatedSolutionUpdate)}},{key:"onAutomatedSolutionUpdate",value:function e(t){var i=r.Text.toInteger(t.getData().intranetCustomSectionId);var s=String(t.getData().title);if(i<=0||!r.Type.isStringFilled(s)){return}var n=this.customSections.find((function(e){return r.Text.toInteger(e.id)===i}));if(n){n.title=s}else{this.customSections.push({id:i,title:s})}this.reInitSelector();this.selectCustomSectionById(i)}},{key:"selectCustomSectionById",value:function e(t){var i;var s=this.selector.getDialog();s.deselectAll();(i=s.getItem({entityId:"custom-section",id:t}))===null||i===void 0?void 0:i.select()}},{key:"onOpenAutomatedSolutionCreationSliderClick",value:function e(){void i.Router.Instance.openAutomatedSolutionDetail()}},{key:"onCreateButtonClick",value:function e(){this.hideSelector();this.showSectionsList()}},{key:"renderSectionsConfig",value:function e(){var t=this;if(!this.sectionsListContainer){this.sectionsListContainer=r.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['<div class="crm-type-custom-sections-list-container"></div>'])));this.settingsContainer.append(this.sectionsListContainer)}this.renderSectionsList(this.sectionsListContainer);if(!this.addSectionItemButton){this.addSectionItemButton=r.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-type-custom-section-add-item-container">\n\t\t\t\t\t<span\n\t\t\t\t\t\tclass="crm-type-custom-section-add-item-button"\n\t\t\t\t\t\tonclick="','"\n\t\t\t\t\t>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t"])),(function(){return t.sectionsListContainer.append(t.renderSectionItem())}),r.Loc.getMessage("CRM_COMMON_ACTION_CREATE"));this.settingsContainer.append(this.addSectionItemButton)}if(!this.buttonsContainer){this.settingsContainer.append(r.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['<hr class="crm-type-custom-sections-line">']))));this.buttonsContainer=r.Tag.render(y||(y=babelHelpers.taggedTemplateLiteral(['<div class="crm-type-custom-sections-buttons-container"></div>'])));this.settingsContainer.append(this.buttonsContainer)}if(!this.saveButton){this.saveButton=r.Tag.render(S||(S=babelHelpers.taggedTemplateLiteral(['<span class="ui-btn ui-btn-primary" onclick="','">',"</span>"])),this.onSaveConfigHandler.bind(this),r.Loc.getMessage("CRM_COMMON_ACTION_SAVE"));this.buttonsContainer.append(this.saveButton)}if(!this.cancelButton){this.cancelButton=r.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(['<span class="ui-btn ui-btn-light-border" onclick="','">',"</span>"])),this.onCancelConfigHandler.bind(this),r.Loc.getMessage("CRM_COMMON_ACTION_CANCEL"));this.buttonsContainer.append(this.cancelButton)}}},{key:"onSaveConfigHandler",value:function e(t){t.preventDefault();var i=this.getSelectedSection();var s=[];babelHelpers.toConsumableArray(this.sectionsListContainer.children).forEach((function(e){var t=e.querySelector('[name="id"]');var n=e.querySelector('[name="value"]');if(!t||!n){return}var r=t.value;var a=n.value;var o=false;if(i&&i.id===r){o=true}if(a){s.push({id:r,title:a,isSelected:o})}}));this.customSections=s;this.reInitSelector();this.showSelector();this.hideSectionsList()}},{key:"onCancelConfigHandler",value:function e(t){t.preventDefault();this.showSelector();this.hideSectionsList()}},{key:"renderSectionsList",value:function e(t){var i=this;r.Dom.clean(t);this.customSections.forEach((function(e){t.append(i.renderSectionItem(e))}));t.append(this.renderSectionItem())}},{key:"renderSectionItem",value:function e(t){var i=this;var s=new Q(t);var n=r.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div style="margin-bottom: 10px;" class="ui-ctl ui-ctl-textbox ui-ctl-w100 ui-ctl-row">\n\t\t\t\t<input type="hidden" name="id" value="','" />\n\t\t\t\t<input class="ui-ctl-element" name="value" type="text" value="','">\n\t\t\t\t<div\n\t\t\t\t\tclass="crm-type-custom-section-remove-item"\n\t\t\t\t\tonclick="','">\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),s.getId(),r.Text.encode(s.getValue()),(function(e){e.preventDefault();i.sectionsListContainer.removeChild(s.getNode())}));s.setNode(n);return n}},{key:"showSectionsList",value:function e(){this.renderSectionsConfig();r.Dom.removeClass(this.settingsContainer,"crm-type-hidden")}},{key:"hideSectionsList",value:function e(){r.Dom.clean(this.sectionsListContainer);r.Dom.addClass(this.settingsContainer,"crm-type-hidden")}},{key:"adjust",value:function e(){if(this.switcher.isChecked()){r.Dom.removeClass(this.container,"crm-type-hidden")}else{r.Dom.addClass(this.container,"crm-type-hidden")}}},{key:"getSelectedSection",value:function e(){var t=this.selector.getDialog().getSelectedItems();if(t.length>0){return{id:t[0].getId(),title:t[0].getTitle()}}return null}},{key:"getData",value:function e(){var t={customSectionId:0,customSections:this.customSections};if(this.switcher.isChecked()){var i=this.getSelectedSection();if(i){t.customSectionId=i.id}}return t}}]);return e}();var Q=function(){function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;babelHelpers.classCallCheck(this,e);this.id=t?t.id:"new_".concat(r.Text.getRandom());this.value=t?t.title:""}babelHelpers.createClass(e,[{key:"setNode",value:function e(t){this.node=t}},{key:"getId",value:function e(){return this.id}},{key:"getNode",value:function e(){return this.node}},{key:"getInput",value:function e(){var t=this.getNode();if(!t){return null}if(t instanceof HTMLInputElement){return t}return t.querySelector("input")}},{key:"getValue",value:function e(){var t=this.getInput();if(t&&t.value){return t.value}return this.value||""}}]);return e}();var Y=new WeakMap;var K=function(){function e(){babelHelpers.classCallCheck(this,e);U(this,Y,{writable:true,value:false})}babelHelpers.createClass(e,[{key:"setPermissionsLayoutV2Enabled",value:function e(t){babelHelpers.classPrivateFieldSet(this,Y,t);return this}},{key:"isPermissionsLayoutV2Enabled",value:function e(){return babelHelpers.classPrivateFieldGet(this,Y)}}],[{key:"getInstance",value:function t(){if(k(this,e,$)===null){C(this,e,$,new e)}return k(this,e,$)}}]);return e}();var $={writable:true,value:null};R.FeatureManager=K})(this.window=this.window||{},BX.Crm.Integration.Analytics,BX.Crm,BX.Crm,BX.Crm.Models,BX,BX.Event,BX,BX.UI.Analytics,BX.UI.Dialogs,BX.UI.EntitySelector,BX.UI);
//# sourceMappingURL=script.map.js