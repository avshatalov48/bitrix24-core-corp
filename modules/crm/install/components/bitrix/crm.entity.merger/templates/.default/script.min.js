BX.namespace("BX.Crm");if(typeof BX.Crm.EntityMerger==="undefined"){BX.Crm.EntityMerger=function(){this._id="";this._settings={};this._entityTypeId=0;this._entityIds=[];this._entityInfos=[];this._editorIds=[];this._editors={};this._primaryEntityId=0;this._primaryEditor=null;this._controls=null;this._primaryEditorWrapper=null;this._primaryEditorSwitchName="";this._secondaryEditorContainer=null;this._secondaryEditorHeaderContainer=null;this._beforeEditorLayoutHandler=BX.delegate(this.onBeforeEditorLayout,this);this._afterEditorLayoutHandler=BX.delegate(this.onAfterEditorLayout,this);this._editorRefreshLayoutHandler=BX.delegate(this.onEditorRefreshLayout,this);this._editorResolveFieldLayoutHandler=BX.delegate(this.onEditorResolveFieldLayout,this);this._scroller=null;this._scrollerY=null;this._editorHeaders=null;this._editorColumns=null;this._editorMergerColumns=null;this._editorButtons=null;this._editorWrappers=null;this._dedupeConfig=null;this._dedupeCriterionData=null;this._dedupeQueueInfo=null;this._isDedupeQueueEnabled=false;this._isDedupeQueueRequestRunning=false;this._panel=null;this._externalContextId="";this._externalEventHandler=null};BX.Crm.EntityMerger.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._primaryEditorWrapper=BX(BX.prop.getString(this._settings,"primaryEditorWrapperId"));this._primaryEditorSwitchName=BX.prop.getString(this._settings,"primaryEditorSwitchName");this._secondaryEditorContainer=BX(BX.prop.getString(this._settings,"secondaryEditorContainerId"));this._secondaryEditorHeaderContainer=BX(BX.prop.getString(this._settings,"secondaryEditorHeaderContainerId"));this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",0);this._entityIds=BX.prop.getArray(this._settings,"entityIds",[]);this._entityInfos=BX.prop.getArray(this._settings,"entityInfos",[]);this._dedupeConfig=BX.prop.getObject(this._settings,"dedupeConfig",{});this._dedupeCriterionData=BX.prop.getObject(this._settings,"dedupeCriterionData",{});this._dedupeQueueInfo=BX.prop.getObject(this._settings,"dedupeQueueInfo",{});this._isDedupeQueueEnabled=BX.prop.getInteger(this._dedupeQueueInfo,"length",0)>0;this.entityWrapper=document.querySelector(".crm-entity-merger-wrapper");this._panel=BX.Crm.EntityMergerPanel.create(this._id,{merger:this});this._externalContextId=BX.prop.getString(this._settings,"externalContextId","");this.loadAllEntityEditors()},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.Crm.EntityMerger.messages,t,t)},getEntityTypeId:function(){return this._entityTypeId},getEntityTypeName:function(){return BX.CrmEntityType.resolveName(this._entityTypeId)},containsEntityId:function(t){for(var e=0,i=this._entityIds.length;e<i;e++){if(t==this._entityIds[e]){return true}}return false},getScheme:function(){var t=Object.keys(this._editors);return t.length>0?this._editors[t[0]].getScheme():null},close:function(){this.animateColumns(function(){var t=top.BX.SidePanel.Instance.getSliderByWindow(window);if(t&&t.isOpen()){t.close(false)}}.bind(this))},clearSecondaryEditorsLayout:function(){for(var t in this._editors){if(!this._editors.hasOwnProperty(t)){continue}var e=this._editors[t];this.unregisterEntityEditor(e);e.release();BX.Crm.EntityEditor.items[e.getId()]}this._entityIds=[];this._entityInfos=[];this._editorIds=[];this._editors={};this._editorHeaders=null;this._editorColumns=null;this._editorButtons=null;this._editorMergerColumns=null;this._editorWrappers=null;BX.clean(this._secondaryEditorHeaderContainer);BX.clean(this._secondaryEditorContainer)},createSecondaryEditorLayout:function(t){if(!this._editorHeaders){this._editorHeaders={}}if(!this._editorWrappers){this._editorWrappers={}}if(!this._editorHeaders.hasOwnProperty(t)){var e=BX.create("div",{props:{className:"crm-entity-merger-column-btn"},attrs:{"data-entity-id":t}});this._secondaryEditorHeaderContainer.appendChild(e);this._editorHeaders[t]=BX.Crm.EntityMergerHeader.create("header_"+t,{merger:this,container:e,switchName:this._primaryEditorSwitchName,entityId:t,titleTemplate:BX.prop.getString(this._settings,"headerTitleTemplate","")})}if(!this._editorWrappers.hasOwnProperty(t)){var i=BX.create("div",{props:{className:"crm-entity-merger-column-item"},attrs:{"data-entity-id":t}});this._secondaryEditorContainer.appendChild(i);this._editorWrappers[t]=i}return{header:this._editorHeaders[t],wrapper:this._editorWrappers[t]}},isQueueEnabled:function(){return this._isDedupeQueueEnabled},getDedupeQueueLength:function(){return BX.prop.getInteger(this._dedupeQueueInfo,"length",0)},getDedupeQueueOffset:function(){return BX.prop.getInteger(this._dedupeQueueInfo,"offset",0)},addQueueOffset:function(t){var e=new BX.Promise;if(this._isDedupeQueueRequestRunning){window.setTimeout(function(){e.fulfill(false)},0);return e}var i=BX.prop.getInteger(this._dedupeQueueInfo,"offset",0);var r=BX.prop.getInteger(this._dedupeQueueInfo,"length",0);i+=t;if(i>=r||i<0){window.setTimeout(function(){e.fulfill(false)},0)}else{this._isDedupeQueueRequestRunning=true;this.loadDedupeQueueItem(i).then(function(i){var r=BX.prop.getObject(i,"queueInfo",null);if(r){this._dedupeQueueInfo=r}var n=BX.prop.getArray(i,"entityInfos",[]);if(n.length===0){if(t<0){this._dedupeQueueInfo["offset"]=0}else if(this._dedupeQueueInfo["offset"]>=this._dedupeQueueInfo["length"]){this._dedupeQueueInfo["offset"]=this._dedupeQueueInfo["length"]-1}e.fulfill(false);return}this._dedupeCriterionData=BX.prop.getObject(i,"dedupeCriterionData",{});this.setupByEntityInfos(n);this._isDedupeQueueRequestRunning=false;e.fulfill(true)}.bind(this)).catch(function(){this._isDedupeQueueRequestRunning=false}.bind(this))}return e},moveToNextQueueItem:function(){return this.addQueueOffset(1)},moveToPreviousQueueItem:function(){return this.addQueueOffset(-1)},loadDedupeQueueItem:function(t){var e=new BX.Promise;BX.ajax.runComponentAction("bitrix:crm.entity.merger","getDedupeQueueItem",{data:{entityTypeName:this.getEntityTypeName(),typeNames:BX.prop.getArray(this._dedupeConfig,"typeNames",[]),scope:BX.prop.getString(this._dedupeConfig,"scope",""),offset:t}}).then(function(i){this._dedupeQueueInfo["offset"]=t;var r=BX.prop.getObject(i,"data",{});e.fulfill({entityIds:BX.prop.getArray(r,"ENTITY_IDS",[]),entityInfos:BX.prop.getArray(r,"ENTITY_INFOS",[]),dedupeCriterionData:BX.prop.getObject(r,"CRITERION_DATA",{}),queueInfo:BX.prop.getObject(r,"QUEUE_INFO",{})})}.bind(this));return e},setupByEntityInfos:function(t){if(this._primaryEditor){this.unregisterEntityEditor(this._primaryEditor);this._primaryEditor.release();this._primaryEditor=null}if(this._primaryEntityId!==0){this._primaryEntityId=0}this.clearSecondaryEditorsLayout();if(t.length===0){return false}var e=[];for(var i=0,r=t.length;i<r;i++){var n=BX.prop.getInteger(t[i],"ENTITY_ID",0);if(n>0){e.push(n)}}this._entityIds=e;this._entityInfos=t;this.loadAllEntityEditors();return true},isDeduplicationMode:function(){return!!BX.prop.getArray(this._dedupeConfig,"typeNames",null)},getDeduplicationCriterionData:function(){return this._dedupeCriterionData},getDedupeListUrl:function(){return BX.prop.getString(this._settings,"dedupeListUrl","")},openDedupeList:function(){BX.Crm.Page.open(BX.util.add_url_param(this.getDedupeListUrl(),{scope:BX.prop.getString(this._dedupeConfig,"scope",""),typeNames:BX.prop.getArray(this._dedupeConfig,"typeNames",[])}))},bindBeforeEditorLayout:function(){this.unbindBeforeEditorLayout();BX.addCustomEvent(window,"BX.Crm.EntityEditor:onBeforeLayout",this._beforeEditorLayoutHandler)},unbindBeforeEditorLayout:function(){BX.removeCustomEvent(window,"BX.Crm.EntityEditor:onBeforeLayout",this._beforeEditorLayoutHandler)},bindAfterEditorLayout:function(){this.unbindAfterEditorLayout();BX.addCustomEvent(window,"BX.Crm.EntityEditor:onLayout",this._afterEditorLayoutHandler)},unbindAfterEditorLayout:function(){BX.removeCustomEvent(window,"BX.Crm.EntityEditor:onLayout",this._afterEditorLayoutHandler)},loadAllEntityEditors:function(){if(!(BX.type.isArray(this._entityIds)&&this._entityIds.length>0)){return}this.bindBeforeEditorLayout();this.bindAfterEditorLayout();var t=document.body.querySelector(".crm-entity-merger-sidebar");t.classList.remove("crm-entity-merger-sidebar-closing");var e=document.querySelector(".crm-entity-merger-column");e.classList.remove("crm-entity-merger-column-closing");var i=document.querySelector(".crm-entity-merger-wrapper");i.classList.add("crm-entity-merger-wrapper-loading");var r=new BX.Loader({target:document.body});r.show();var n=0;var o=function(){n++;if(n===this._entityIds.length){r.destroy();i.classList.remove("crm-entity-merger-wrapper-loading")}}.bind(this);for(var s=0,a=this._entityIds.length;s<a;s++){this.doLoadEntityEditor(this._entityIds[s]).then(o)}},reloadEntityEditor:function(t){if(this._primaryEditor){this.unregisterEntityEditor(this._primaryEditor);this._primaryEditor.release();this._primaryEditor=null}var e=this.getSecondaryEditorByEntityId(t);if(e){this.releaseEntityEditor(e)}this.clearLayout();this.bindBeforeEditorLayout();this.bindAfterEditorLayout();this.doLoadEntityEditor(t)},doLoadEntityEditor:function(t){var e=this.getEntityTypeName();var i=BX.prop.getString(this._settings,"editorConfigId","");if(i===""){i="merger_"+e.toLowerCase()}var r=i+"_"+t;this._editorIds.push(r);var n=BX.prop.getString(this._settings,"entityEditorUrl","");if(n===""){n=BX.Crm.EntityMerger.getEntityEditorUrl(e)}if(n===""){throw"Crm.EntityMerger: Could not resolve entity editor URL."}var o=new BX.Promise;BX.ajax.post(BX.util.add_url_param(n,{sessid:BX.bitrix_sessid()}),{ACTION:"PREPARE_EDITOR_HTML",ACTION_ENTITY_TYPE_NAME:e,ACTION_ENTITY_ID:t,GUID:r,CONFIG_ID:"",ENABLE_COMMUNICATION_CONTROLS:"N",ENABLE_CONFIG_VARIABILITY:"N",PARAMS:{},TITLE:"",SCOPE:"C",FORCE_DEFAULT_CONFIG:"N",ENABLE_CONFIG_SCOPE_TOGGLE:"N",ENABLE_CONFIGURATION_UPDATE:"N",ENABLE_FIELDS_CONTEXT_MENU:"N",ENABLE_REQUIRED_USER_FIELD_CHECK:"Y",ENABLE_AVAILABLE_FIELDS_INJECTION:"Y",ENABLE_EXTERNAL_LAYOUT_RESOLVERS:"Y",SHOW_EMPTY_FIELDS:"Y",INITIAL_MODE:"view",READ_ONLY:"Y",IS_EMBEDDED:"Y"},function(e){this.createSecondaryEditorLayout(t);this._editorWrappers[t].innerHTML=e;o.fulfill(t)}.bind(this));return o},areEditorsLoaded:function(){return Object.keys(this._editors).length===this._editorIds.length},isReadyForLayout:function(){if(Object.keys(this._editors).length!==this._editorIds.length){return false}for(var t in this._editors){if(!this._editors.hasOwnProperty(t)){continue}if(!this._editors[t].hasLayout()){return false}}return true},getEditorColumns:function(){if(this._editorColumns!==null){return this._editorColumns}var t=this.getEditorButtons();var e=this.getMergerColumns();this._editorColumns=[];for(var i=0;i<t.length;i++){this._editorColumns.push({entityId:parseInt(t[i].getAttribute("data-entity-id")),button:t[i],column:e[i],label:t[i].querySelector(".crm-entity-merger-column-btn-label")})}return this._editorColumns},getMergerColumns:function(){if(!this._editorMergerColumns){this._editorMergerColumns=document.querySelectorAll(".crm-entity-merger-column-item")}return this._editorMergerColumns},getEditorButtons:function(){if(!this._editorButtons){this._editorButtons=document.querySelectorAll(".crm-entity-merger-column-btn")}return this._editorButtons},getEntityDetailsUrl:function(t){for(var e=0,i=this._entityInfos.length;e<i;e++){if(t===BX.prop.getInteger(this._entityInfos[e],"ENTITY_ID")){return BX.prop.getString(this._entityInfos[e],"DETAILS_URL","")}}return""},getColumnItemByEntityId:function(t){if(!BX.type.isInteger(t)){t=parseInt(t)}if(t<=0){return null}var e=this.getEditorColumns();if(e){for(var i=0,r=e.length;i<r;i++){var n=e[i];if(n["entityId"]===t){return n}}}return null},selectColumnItem:function(t){t.button.classList.add("crm-entity-merger-column-btn-hover");t.column.classList.add("crm-entity-merger-column-item-hover")},unSelectColumnItem:function(t){t.button.classList.remove("crm-entity-merger-column-btn-hover");t.column.classList.remove("crm-entity-merger-column-item-hover")},prepareControls:function(){var t=this.getScheme();if(!(t instanceof BX.Crm.EntityScheme)){throw"Crm.EntityMerger. Could not find editor scheme."}this._controls=[];var e=t.getElements();for(var i=0,r=e.length;i<r;i++){var n=this.createControlsBySchemeElement(e[i]);for(var o=0;o<n.length;o++){this._controls.push(n[o])}}},getEditorControlsById:function(t){var e=[];for(var i in this._editors){if(!this._editors.hasOwnProperty(i)){continue}var r=this._editors[i].getControlById(t);if(r){e.push(r)}}return e},createControl:function(t,e,i){if(e==="section"){return BX.Crm.EntityMergerSection.create(t,{merger:this,editorControls:i})}else if(e==="company"){return BX.Crm.EntityMergerField.create(t,{merger:this,editorControls:i,controller:BX.Crm.EntityMergerClientCompanyController.create(false)})}else if(e==="multiple_company"){return BX.Crm.EntityMergerField.create(t,{merger:this,editorControls:i,controller:BX.Crm.EntityMergerClientCompanyController.create(true)})}else if(e==="multiple_contact"){return BX.Crm.EntityMergerField.create(t,{merger:this,editorControls:i,controller:BX.Crm.EntityMergerClientContactController.create()})}else{return BX.Crm.EntityMergerField.create(t,{merger:this,editorControls:i,controller:BX.Crm.EntityMergerFieldController.create()})}},createControlsBySchemeElement:function(t){var e=t.getType();var i=t.getName();var r=[];var n=null;var o=t.getDataArrayParam("compound",null);if(o===null){n=this.createControl(i,e,this.getEditorControlsById(i));if(n){r.push(n)}}else{var s=this.getEditorControlsById(i);for(var a=0;a<o.length;a++){var l=o[a];n=this.createControl(l["name"],l["type"],s.slice(0));if(n){if(a>0){n._enableAdjusting=false}r.push(n)}}}return r},layout:function(){if(this._editorHeaders){for(var t in this._editorHeaders){if(this._editorHeaders.hasOwnProperty(t)){this._editorHeaders[t].layout()}}}for(var e=0,i=this._controls.length;e<i;e++){this._controls[e].layout()}var r=this.getEditorColumns();var n=this;for(var o=0;o<r.length;o++){BX.bind(r[o].column,"mouseenter",function(){n.selectColumnItem(n.getColumnItemByEntityId(this.getAttribute("data-entity-id")))});BX.bind(r[o].column,"mouseleave",function(){n.unSelectColumnItem(n.getColumnItemByEntityId(this.getAttribute("data-entity-id")))});BX.bind(r[o].column,"click",function(){n.setCurrentActiveColumn(n.getColumnItemByEntityId(this.getAttribute("data-entity-id")))})}this.getFirstEntitySwitchClick();BX.removeCustomEvent(window,"BX.Crm.EntityEditor:onRefreshLayout",this._editorRefreshLayoutHandler);BX.addCustomEvent(window,"BX.Crm.EntityEditor:onRefreshLayout",this._editorRefreshLayoutHandler);this._scroller=BX.Crm.EntityMergerScroller.create();this._scroller.layout();this.columnContainer=document.body.querySelector(".crm-entity-merger-column-container");if(!this._scroller.outerColumnContainer.classList.contains("crm-entity-merger-right-ear-shown")){this.columnContainer.style.width="100"+"%"}else{this.columnContainer.style.width="auto"}this._scrollerY=BX.Crm.EntityMergerVerticalScroller.create();this._scrollerY.layout();this._panel.layout();var s=top.BX.SidePanel.Instance.getSliderByWindow(window);if(s){document.body.style.overflow="hidden"}},clearLayout:function(){if(this._editorHeaders){for(var t in this._editorHeaders){if(this._editorHeaders.hasOwnProperty(t)){this._editorHeaders[t].clearLayout()}}}for(var e=0,i=this._controls.length;e<i;e++){this._controls[e].clearLayout()}BX.removeCustomEvent(window,"BX.Crm.EntityEditor:onRefreshLayout",this._editorRefreshLayoutHandler)},clearSecondaryEntityLayout:function(t){var e=this.getSecondaryEditorByEntityId(t);if(e){this.releaseEntityEditor(e)}var i=this.getColumnItemByEntityId(t);if(i){BX.remove(i["button"]);BX.remove(i["column"])}},getEntityCreationDate:function(t){var e=this.getSecondaryEditorByEntityId(t);if(e){return e.getModel().getStringField("DATE_CREATE")}return""},registerEntityEditor:function(t){if(!this._controls){return}for(var e=0,i=this._controls.length;e<i;e++){this._controls[e].registerEntityEditor(t)}},unregisterEntityEditor:function(t){if(!this._controls){return}for(var e=0,i=this._controls.length;e<i;e++){this._controls[e].unregisterEntityEditor(t)}},releaseEntityEditor:function(t){if(!t){return}this.removeEntityEditor(t);this.unregisterEntityEditor(t);t.release()},removeEntityEditor:function(t){if(!t){return}var e=t.getId();var i=this._editorIds.indexOf(e);if(i>=0){this._editorIds.splice(i,1)}if(this._editors.hasOwnProperty(e)){delete this._editors[e]}},getSecondaryEditor:function(t){return this._editors.hasOwnProperty(t)?this._editors[t]:null},getSecondaryEditorByEntityId:function(t){for(var e in this._editors){if(!this._editors.hasOwnProperty(e)){continue}var i=this._editors[e];if(i.getEntityId()===t){return i}}return null},getSecondaryEntityIds:function(){var t=this.getPrimaryEntityId();var e=[];for(var i in this._editors){if(!this._editors.hasOwnProperty(i)){continue}var r=this._editors[i].getEntityId();if(r!==t){e.push(r)}}return e},getSecondaryEntityCount:function(){return Object.keys(this._editors).length},getPrimaryEntityId:function(){return this._primaryEntityId},setPrimaryEntity:function(t,e){if(!BX.type.isInteger(t)){t=parseInt(t);if(isNaN(t)){throw"Crm.EntityMerger. Parameter 'entityId' must be integer."}}if(!e&&this._primaryEntityId===t){return}var i=this.getSecondaryEditorByEntityId(t);if(!i){throw"Crm.EntityMerger. Could not find entity editor."}if(this._primaryEditor){this.unregisterEntityEditor(this._primaryEditor);this._primaryEditor.release();this._primaryEditor=null}this._primaryEntityId=t;this._primaryEditor=i.clone({id:i.getId()+"_primary",wrapper:this._primaryEditorWrapper});this.registerEntityEditor(this._primaryEditor);BX.onCustomEvent(this,"onPrimaryEntityChange")},checkIfPrimaryEditorControl:function(t){return this._primaryEditor&&t&&this._primaryEditor===t.getEditor()},checkIfSecondaryEditorControl:function(t){return!this.checkIfPrimaryEditorControl(t)},getControlById:function(t,e){e=!!e;if(this._controls){for(var i=0,r=this._controls.length;i<r;i++){if(this._controls[i].getId()===t){return this._controls[i]}if(e){var n=this._controls[i].getChildControlById(t);if(n){return n}}}}return null},setupPrimaryEditor:function(){BX.ajax.runComponentAction("bitrix:crm.entity.merger","prepareMergeData",{data:{entityTypeName:this.getEntityTypeName(),seedEntityIds:this.getSecondaryEntityIds(),targEntityId:this.getPrimaryEntityId()}}).then(function(t){var e=BX.prop.getObject(t,"data",{});var i={};var r=this._primaryEditor.getModel().getData();for(var n=0,o=this._controls.length;n<o;n++){this._controls[n].applyMergeResults(e,i,r)}this._primaryEditor.getModel().updateData(i,{enableNotification:false});BX.addCustomEvent(window,"BX.Crm.EntityEditor:onResolveFieldLayoutOptions",this._editorResolveFieldLayoutHandler);this._primaryEditor.refreshLayout({reset:true});BX.removeCustomEvent(window,"BX.Crm.EntityEditor:onResolveFieldLayoutOptions",this._editorResolveFieldLayoutHandler)}.bind(this))},setupPrimaryEditorControl:function(t,e,i){if(!BX.type.isArray(i)){i=[]}if(i.length===0){i.push(0)}BX.ajax.runComponentAction("bitrix:crm.entity.merger","prepareFieldMergeData",{data:{entityTypeName:this.getEntityTypeName(),seedEntityIds:this.getSecondaryEntityIds(),targEntityId:this.getPrimaryEntityId(),fieldId:t,options:{enabledIds:i}}}).then(function(i){var r=this.getControlById(t,true);if(!r){return}var n={};r.applyMergeResults(BX.prop.getObject(i,"data",{}),n,this._primaryEditor.getModel().getData());this._primaryEditor.getModel().updateData(n,{enableNotification:false});var o=this._primaryEditor.getControlById(e);if(o){o.refreshLayout({reset:true})}}.bind(this))},processSecondaryEntityRemoval:function(){if(this.getSecondaryEntityCount()<2){if(this.isQueueEnabled()){this.addQueueOffset(0).then(function(t){if(!t){this.close()}}.bind(this))}else{window.setTimeout(function(){this.close()}.bind(this),0)}}},processFieldSourceEntityChange:function(t,e){if(!this._primaryEditor){return}var i=t.getActiveSwitches();if(!t.isMultiple()){if(i.length>0){var r=this._primaryEditor.getControlById(e.getId());if(r){t.adjustEditorControl(e,r)}}}else{if(e instanceof BX.Crm.EntityEditorUserField||e instanceof BX.Crm.EntityEditorMultifield||e instanceof BX.Crm.EntityEditorClientLight){var n=[];for(var o=0,s=i.length;o<s;o++){n.push(i[o].getEntityId())}this.setupPrimaryEditorControl(t.getId(),e.getId(),n)}}},onBeforeEditorLayout:function(t,e){var i=t.getId();if(this._editorIds.indexOf(i)<0){return}this._editors[i]=t;e["cancel"]=true;if(this.areEditorsLoaded()){this.unbindBeforeEditorLayout();window.setTimeout(function(){this.prepareControls();BX.addCustomEvent(window,"BX.Crm.EntityEditor:onResolveFieldLayoutOptions",this._editorResolveFieldLayoutHandler);for(var t in this._editors){if(!this._editors.hasOwnProperty(t)){continue}var e=this._editors[t];if(!e.hasLayout()){e.layout()}}BX.removeCustomEvent(window,"BX.Crm.EntityEditor:onResolveFieldLayoutOptions",this._editorResolveFieldLayoutHandler)}.bind(this),0)}},onAfterEditorLayout:function(t){if(!this._editors.hasOwnProperty(t.getId())){return}if(this.isReadyForLayout()){this.unbindAfterEditorLayout();var e=0;for(var i in this._editors){if(!this._editors.hasOwnProperty(i)){continue}var r=this._editors[i];if(r.isPersistent()){continue}e++;this.clearSecondaryEntityLayout(r.getEntityId())}if(this.isQueueEnabled()&&this._entityIds.length-e<2){this.moveToNextQueueItem()}else{this.layout();if(this._primaryEntityId>0){window.setTimeout(function(){this.removeOnloadState();this.setupPrimaryEntity(this._primaryEntityId,true)}.bind(this),0)}}}},onEditorRefreshLayout:function(t){if(!this._editors.hasOwnProperty(t.getId())&&this._primaryEditor!==t){return}for(var e=0,i=this._controls.length;e<i;e++){this._controls[e].refreshLayout()}},onEditorResolveFieldLayout:function(t,e){if(!this._editors.hasOwnProperty(t.getId())&&this._primaryEditor!==t){return}var i=e["field"].getId();var r=this.getControlById(i,true);if(r){e["layoutOptions"]["isNeedToDisplay"]=r.checkIfNeedToDisplay()}},setCurrentActiveBtn:function(t){if(!t){return}for(var e=0,i=this._editorColumns.length;e<i;e++){var r=this._editorColumns[e];if(r===t){r.button.classList.add("crm-entity-merger-column-btn-active");r.column.classList.add("crm-entity-merger-column-item-active")}else{r.button.classList.remove("crm-entity-merger-column-btn-active");r.column.classList.remove("crm-entity-merger-column-item-active")}}this.removeOnloadState();this.setupPrimaryEntity(t["entityId"])},setCurrentActiveColumn:function(t){if(!t){return}if(!t.column.classList.contains("crm-entity-merger-column-onload-state")){return}t.button.querySelector(".crm-entity-merger-column-btn-radio").checked=true;this.setCurrentActiveBtn(t)},removeOnloadState:function(){var t=document.querySelectorAll(".crm-entity-merger-column-item");for(var e=0;e<t.length;e++){var i=t[e];i.classList.remove("crm-entity-merger-column-onload-state")}this.entityWrapper.classList.remove("crm-entity-merger-onload-sidebar-state")},getFirstEntitySwitchClick:function(){for(var t in this._editors){if(!this._editors.hasOwnProperty(t)){continue}var e=this._editors[t].getContainer();e.closest(".crm-entity-merger-column-item").classList.add("crm-entity-merger-column-onload-state");this.entityWrapper.classList.add("crm-entity-merger-onload-sidebar-state")}},setupPrimaryEntity:function(t,e){if(!BX.type.isInteger(t)){t=parseInt(t);if(isNaN(t)){throw"Crm.EntityMerger. Parameter 'entityId' must be integer."}}if(!e&&this._primaryEntityId===t){return}this.setPrimaryEntity(t,e);this.setupPrimaryEditor()},synchronizeVerticalScroll:function(){this._scrollerY.handleColumnScroll()},postpone:function(){if(!this.isQueueEnabled()){window.setTimeout(function(){this.close()}.bind(this),0);return}BX.onCustomEvent(this,"onPostponeStart");BX.ajax.runComponentAction("bitrix:crm.entity.merger","postponeDedupeItem",{data:{entityTypeName:this.getEntityTypeName(),typeId:BX.prop.getInteger(this._dedupeCriterionData,"typeId",0),matches:BX.prop.getObject(this._dedupeCriterionData,"matches",{}),scope:BX.prop.getString(this._dedupeConfig,"scope","")}}).then(function(t){BX.onCustomEvent(this,"onPostponeComplete");this._dedupeQueueInfo["offset"]--;this.moveToNextQueueItem().then(function(t){if(!t){this.close()}}.bind(this))}.bind(this)).catch(function(t){BX.onCustomEvent(this,"onPostponeError");var e=[];var i=BX.prop.getArray(t,"errors",[]);for(var r=0,n=i.length;r<n;r++){e.push(BX.prop.getString(i[r],"message",""))}BX.UI.Notification.Center.notify({content:e.join("\n"),position:"top-right",autoHideDelay:5e3})}.bind(this))},merge:function(){var t=this.getPrimaryEntityId();var e=this.getSecondaryEntityIds();if(t<=0){BX.UI.Notification.Center.notify({content:this.getMessage("primaryEntityNotFound"),position:"top-right",autoHideDelay:5e3});return}if(e.length===0){BX.UI.Notification.Center.notify({content:this.getMessage("entitiesNotFound"),position:"top-right",autoHideDelay:5e3});return}var i={};var r=true;var n={scrollToConflict:true};for(var o=0,s=this._controls.length;o<s;o++){var a=this._controls[o];if(!(r=a.checkIfConflictResolved(n))){break}a.saveMappedData(i)}if(!r){BX.UI.Notification.Center.notify({content:this.getMessage("unresolvedConflictsFound"),position:"top-right",autoHideDelay:5e3});return}var l;if(this.isQueueEnabled()){l=BX.ajax.runComponentAction("bitrix:crm.entity.merger","mergeDedupeQueueItem",{data:{entityTypeName:this.getEntityTypeName(),typeNames:BX.prop.getArray(this._dedupeConfig,"typeNames",[]),scope:BX.prop.getString(this._dedupeConfig,"scope",""),offset:this._dedupeQueueInfo["offset"],seedEntityIds:e,targEntityId:t,map:i}})}else{l=BX.ajax.runComponentAction("bitrix:crm.entity.merger","merge",{data:{entityTypeName:this.getEntityTypeName(),seedEntityIds:e,targEntityId:t,map:i}})}if(!l){return}BX.onCustomEvent(this,"onMergeStart");l.then(function(i){BX.onCustomEvent(this,"onMergeComplete");var r=BX.prop.getObject(i,"data",{});if(this.isQueueEnabled()){var n=1;var o=BX.prop.getObject(r,"QUEUE_INFO",null);if(o){this._dedupeQueueInfo=o;n=0}BX.localStorage.set("onCrmEntityMergeComplete",{entityTypeId:this.getEntityTypeId(),entityTypeName:this.getEntityTypeName(),context:this._externalContextId,length:this._dedupeQueueInfo["length"]},10);this.addQueueOffset(n).then(function(t){if(!t){this.close()}}.bind(this))}else{BX.localStorage.set("onCrmEntityMergeComplete",{entityTypeId:this.getEntityTypeId(),entityTypeName:this.getEntityTypeName(),context:this._externalContextId,seedEntityIds:e,targEntityId:t},100);window.setTimeout(function(){this.close()}.bind(this),0)}}.bind(this)).catch(function(t){BX.onCustomEvent(this,"onMergeError");var e=[];var i=BX.prop.getArray(t,"errors",[]);for(var r=0,n=i.length;r<n;r++){e.push(BX.prop.getString(i[r],"message",""))}BX.UI.Notification.Center.notify({content:e.join("\n"),position:"top-right",autoHideDelay:5e3})}.bind(this))},markEntityAsNonDuplicate:function(t){var e=this.getPrimaryEntityId();if(e<=0||t<=0){return}var i=this.getDeduplicationCriterionData();if(!BX.type.isPlainObject(i)){return}BX.ajax.runComponentAction("bitrix:crm.entity.merger","markAsNonDuplicates",{data:{entityTypeName:this.getEntityTypeName(),leftEntityID:e,rightEntityID:t,indexType:BX.prop.getInteger(i,"typeId",0),matches:BX.prop.getObject(i,"matches",{})}}).then(function(e){this.clearSecondaryEntityLayout(t);this.processSecondaryEntityRemoval()}.bind(this))},openEntityDetails:function(t){var e=this.getEntityDetailsUrl(t);if(e===""){return}if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}BX.Crm.Page.open(e)},onExternalEvent:function(t){var e=BX.prop.getString(t,"key","");if(e!=="onCrmEntityUpdate"&&e!=="onCrmEntityDelete"){return}var i=BX.prop.getObject(t,"value",{});var r=BX.prop.getInteger(i,"entityTypeId",0);var n=BX.prop.getInteger(i,"entityId",0);if(r===this.getEntityTypeId()&&this.containsEntityId(n)){if(e==="onCrmEntityUpdate"){window.setTimeout(function(){this.reloadEntityEditor(n)}.bind(this),0)}else{window.setTimeout(function(){this.clearSecondaryEntityLayout(n);this.processSecondaryEntityRemoval()}.bind(this),0)}}},animateSidebar:function(t){var e=document.body.querySelector(".crm-entity-merger-sidebar");e.classList.add("crm-entity-merger-sidebar-closing");e.addEventListener("transitionend",function i(){e.removeEventListener("transitionend",i);t()})},animateColumns:function(t){var e=this.getEditorColumns();if(!e.length){t();return}var i=document.querySelector(".crm-entity-merger-column");var r=i.querySelector(".crm-entity-merger-ear-left");var n=i.querySelector(".crm-entity-merger-ear-right");i.classList.add("crm-entity-merger-column-closing");if(n){n.remove()}if(r){r.remove()}var o=0;var s=800;var a=Math.ceil(s/e.length);var l=20;for(var d=e.length-1;d>=0;d--){var u=e[d].button;var h=e[d].column;var c=u.offsetWidth+l;var y=h.offsetWidth+l;u.style.transitionDelay=o+"ms";u.style.transitionDuration=s-o+"ms";u.style.transform="translateX(-"+c*(d+1)+"px)";u.style.opacity=0;h.style.transitionDelay=o+"ms";h.style.transitionDuration=s-o+"ms";h.style.transform="translateX(-"+y*(d+1)+"px)";h.style.opacity=0;o+=a}h.addEventListener("transitionend",function e(){h.removeEventListener("transitionend",e);t()})}};if(typeof BX.Crm.EntityMerger.entityEditorUrls==="undefined"){BX.Crm.EntityMerger.entityEditorUrls={}}BX.Crm.EntityMerger.registerEntityEditorUrl=function(t,e){this.entityEditorUrls[t]=e};BX.Crm.EntityMerger.getEntityEditorUrl=function(t){return BX.prop.getString(this.entityEditorUrls,t,"")};BX.Crm.EntityMerger.items={};BX.Crm.EntityMerger.get=function(t){return this.items.hasOwnProperty(t)?this.items[t]:null};if(typeof BX.Crm.EntityMerger.messages==="undefined"){BX.Crm.EntityMerger.messages={}}BX.Crm.EntityMerger.create=function(t,e){var i=new BX.Crm.EntityMerger;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EntityMergerHeader==="undefined"){BX.Crm.EntityMergerHeader=function(){this._id="";this._settings={};this._entityId=0;this._merger=null;this._container=null;this._label=null;this._input=null;this._title=null;this._buttonWrapper=null;this._markAsNonDuplicateButton=null;this._markAsNonDuplicateButtonHandler=BX.delegate(this.onMarkAsNonDuplicateButtonClick,this);this._openButton=null;this._openButtonHandler=BX.delegate(this.onOpenButtonClick,this);this._primaryEntityChangeHandler=BX.delegate(this.onPrimaryEntityChange,this);this._hasLayout=false};BX.Crm.EntityMergerHeader.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entityId=BX.prop.getInteger(this._settings,"entityId",0);this._merger=BX.prop.get(this._settings,"merger");if(!this._merger){throw"Crm.EntityMergerHeader: Could not find param 'merger'."}this._container=BX.prop.getElementNode(this._settings,"container");if(!this._container){throw"Crm.EntityMergerHeader: Could not find param 'container'."}BX.addCustomEvent(this._merger,"onPrimaryEntityChange",this._primaryEntityChangeHandler)},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.Crm.EntityMergerHeader.messages,t,t)},getEntityId:function(){return this._entityId},layout:function(){if(this._hasLayout){return}var t=BX.prop.getString(this._settings,"switchName","");var e=t+"_"+this._entityId;this._input=BX.create("input",{props:{id:e,name:t,type:"radio",className:"crm-entity-merger-column-btn-radio"},attrs:{"data-entity-id":this._entityId}});this.prepareTitle();this._label=BX.create("label",{props:{className:"crm-entity-merger-column-btn-label",for:e},children:[BX.create("span",{props:{className:"crm-entity-merger-column-btn-radio-container"},children:[this._input,BX.create("span",{props:{className:"crm-entity-merger-column-btn-radio-mark"}})]}),this._title]});BX.bind(this._label,"click",BX.delegate(this.onLabelClick,this));this._container.appendChild(this._label);this._openButton=BX.create("a",{props:{className:"crm-entity-merger-column-btn-link",href:"#"},text:this.getMessage("open"),events:{click:this._openButtonHandler}});this._markAsNonDuplicateButton=BX.create("a",{props:{className:"crm-entity-merger-column-btn-link",href:"#"},text:this.getMessage("markAsNonDuplicate"),events:{click:this._markAsNonDuplicateButtonHandler}});this._buttonWrapper=BX.create("div",{props:{className:"crm-entity-merger-column-btn-link-box"},children:[this._openButton,this._markAsNonDuplicateButton]});this._container.appendChild(this._buttonWrapper);BX.bind(this._container,"mouseenter",BX.delegate(this.onMouseEnter,this));BX.bind(this._container,"mouseleave",BX.delegate(this.onMouseLeave,this));this._hasLayout=true;this.adjustLayout()},prepareTitle:function(){this._title=BX.create("span",{props:{className:"crm-entity-merger-column-btn-text"}});var t=this._merger.getEntityCreationDate(this._entityId);var e=BX.parseDate(t);if(!e){return}var i=BX.date.format([["today","today"],["tommorow","tommorow"],["yesterday","yesterday"],["",e.getFullYear()===(new Date).getFullYear()?"j F":"j F Y"]],e);this._title.innerHTML=BX.prop.getString(this._settings,"titleTemplate").replace(/#DATE_CREATE#/,i)},adjustLayout:function(){if(!this._hasLayout){return}var t=this._merger.getPrimaryEntityId();if(this._entityId>0&&this._entityId===t){this._input.checked=true}var e=this._merger.isDeduplicationMode();if(e){e=this._entityId>0&&t>0&&this._entityId!==t}this._markAsNonDuplicateButton.style.display=e?"":"none"},clearLayout:function(){if(!this._hasLayout){return}BX.cleanNode(this._container);this._hasLayout=false},onPrimaryEntityChange:function(){this.adjustLayout()},onOpenButtonClick:function(t){this._merger.openEntityDetails(this._entityId);t.preventDefault()},onMarkAsNonDuplicateButtonClick:function(t){this._merger.markEntityAsNonDuplicate(this._entityId);t.preventDefault()},onMouseEnter:function(t){this._merger.selectColumnItem(this._merger.getColumnItemByEntityId(this._entityId))},onMouseLeave:function(t){this._merger.unSelectColumnItem(this._merger.getColumnItemByEntityId(this._entityId))},onLabelClick:function(t){this._merger.setCurrentActiveBtn(this._merger.getColumnItemByEntityId(this._entityId))}};if(typeof BX.Crm.EntityMergerHeader.messages==="undefined"){BX.Crm.EntityMergerHeader.messages={}}BX.Crm.EntityMergerHeader.create=function(t,e){var i=new BX.Crm.EntityMergerHeader;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityMergerVerticalScroller==="undefined"){BX.Crm.EntityMergerVerticalScroller=function(){this.slider=document.querySelector(".ui-page-slider-wrapper");this.columnContainer=document.body.querySelector(".crm-entity-merger-column-container");this.sidebarColumn=document.body.querySelector(".crm-entity-merger-sidebar-inner");this.bottomPanel=document.body.querySelector(".ui-button-panel-wrapper");this.skeleton=document.body.querySelector(".crm-entity-merger-sidebar-skeleton")};BX.Crm.EntityMergerVerticalScroller.prototype={initialize:function(){this.columnContainerHeight=this.columnContainer.offsetHeight;this.sidebarColumnHeight=this.sidebarColumn.offsetHeight;BX.bind(this.columnContainer,"mouseenter",this.handleColumnMouseEnter.bind(this));BX.bind(this.columnContainer,"mouseleave",this.handleColumnMouseLeave.bind(this));BX.bind(this.columnContainer,"mouseenter",this.handleColumnMouseClick.bind(this));BX.bind(this.sidebarColumn,"mouseenter",this.handleSidebarMouseEnter.bind(this));BX.bind(this.sidebarColumn,"mouseleave",this.handleSidebarMouseLeave.bind(this));this.handleSidebarScroll=this.handleSidebarScroll.bind(this);this.handleColumnScroll=this.handleColumnScroll.bind(this);BX.bind(window,"resize",this.adjustHeight.bind(this))},adjustHeight:function(){if(this.slider){if(this.skeleton){this.skeleton.style.height=this.columnContainer.scrollHeight+"px"}this.sidebarColumn.style.height=this.slider.clientHeight-(this.sidebarColumn.getBoundingClientRect().top+this.bottomPanel.offsetHeight)+"px"}else{this.sidebarColumn.style.height=this.columnContainer.getBoundingClientRect().top+this.columnContainer.getBoundingClientRect().bottom-this.columnContainerHeight+"px"}},handleColumnMouseClick:function(){BX.bind(this.columnContainer,"click",this.handleColumnScroll)},handleColumnMouseEnter:function(){BX.bind(this.columnContainer,"scroll",this.handleColumnScroll)},handleColumnMouseLeave:function(){BX.unbind(this.columnContainer,"scroll",this.handleColumnScroll)},handleSidebarMouseEnter:function(){BX.bind(this.sidebarColumn,"scroll",this.handleSidebarScroll)},handleSidebarMouseLeave:function(){BX.unbind(this.sidebarColumn,"scroll",this.handleSidebarScroll)},handleSidebarScroll:function(){this.columnContainer.scrollTop=this.sidebarColumn.scrollTop},handleColumnScroll:function(){this.sidebarColumn.scrollTop=this.columnContainer.scrollTop},layout:function(){this.adjustHeight()}};BX.Crm.EntityMergerVerticalScroller.create=function(){var t=new BX.Crm.EntityMergerVerticalScroller;t.initialize();return t}}if(typeof BX.Crm.EntityMergerScroller==="undefined"){BX.Crm.EntityMergerScroller=function(){this.earTimer=null;this.columnLayout={earLeft:null,earRight:null};this.outerColumnContainer=document.body.querySelector(".crm-entity-merger-column");this.columnInner=document.body.querySelector(".crm-entity-merger-column-inner")};BX.Crm.EntityMergerScroller.prototype={initialize:function(){BX.bind(window,"resize",this.adjustEars.bind(this));BX.bind(this.columnInner,"scroll",this.adjustEars.bind(this));BX.bind(window,"resize",this.centerEarsByContainerHeight.bind(this))},adjustEars:function(){var t=this.columnInner;var e=t.scrollLeft;var i=e>0;var r=t.scrollWidth>Math.round(e+t.offsetWidth);this.outerColumnContainer.classList[i?"add":"remove"]("crm-entity-merger-left-ear-shown");this.outerColumnContainer.classList[r?"add":"remove"]("crm-entity-merger-right-ear-shown")},getLeftEar:function(){if(this.columnLayout.earLeft){return this.columnLayout.earLeft}this.columnLayout.earLeft=BX.create("div",{attrs:{className:"crm-entity-merger-ear-left"},events:{mouseenter:this.scrollToLeft.bind(this),mouseleave:this.stopAutoScroll.bind(this)}});return this.columnLayout.earLeft},getRightEar:function(){if(this.columnLayout.earRight){return this.columnLayout.earRight}this.columnLayout.earRight=BX.create("div",{attrs:{className:"crm-entity-merger-ear-right"},events:{mouseenter:this.scrollToRight.bind(this),mouseleave:this.stopAutoScroll.bind(this)}});return this.columnLayout.earRight},scrollToRight:function(){this.earTimer=setInterval(function(){this.columnInner.scrollLeft+=10}.bind(this),20)},scrollToLeft:function(){this.earTimer=setInterval(function(){this.columnInner.scrollLeft-=10}.bind(this),20)},stopAutoScroll:function(){clearInterval(this.earTimer);jsDD.refreshDestArea()},centerEarsByContainerHeight:function(){var t=document.querySelector(".ui-page-slider-wrapper");var e=document.body.querySelector(".crm-entity-merger-column-container");var i=e.offsetHeight;var r=document.body.querySelector(".ui-button-panel-wrapper");if(t){e.style.height=t.clientHeight-(e.getBoundingClientRect().top+r.offsetHeight)+"px"}else{e.style.height=e.getBoundingClientRect().top+e.getBoundingClientRect().bottom-i+"px"}},layout:function(){this.outerColumnContainer.appendChild(this.getLeftEar());this.outerColumnContainer.appendChild(this.getRightEar());this.centerEarsByContainerHeight();this.adjustEars()}};BX.Crm.EntityMergerScroller.create=function(){var t=new BX.Crm.EntityMergerScroller;t.initialize();return t}}if(typeof BX.Crm.EntityMergerControl==="undefined"){BX.Crm.EntityMergerControl=function(){this._id="";this._settings={};this._merger=null;this._editorControls=null;this._controls=null;this._layoutOptions=null};BX.Crm.EntityMergerControl.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._merger=BX.prop.get(this._settings,"merger");this._editorControls=BX.prop.getArray(this._settings,"editorControls",[]);this._controls=[];this.doInitialize()},doInitialize:function(){},getId:function(){return this._id},getSchemeElement:function(){return this._editorControls.length>0?this._editorControls[0].getSchemeElement():null},getAllEntityIds:function(){var t=[];for(var e=0,i=this._editorControls.length;e<i;e++){t.push(this._editorControls[e].getEditor().getEntityId())}return t},getEditorControlIndex:function(t){for(var e=0,i=this._editorControls.length;e<i;e++){if(t===this._editorControls[e]){return e}}return-1},getChildControlById:function(t){for(var e=0,i=this._controls.length;e<i;e++){if(this._controls[e].getId()===t){return this._controls[e]}}return null},addEditorControl:function(t){if(!t){return}this._editorControls.push(t);this.doAddEditorControl(t)},doAddEditorControl:function(t){},removeEditorControl:function(t){if(!t){return}var e=this.getEditorControlIndex(t);if(e>=0){this._editorControls.splice(e,1)}this.doRemoveEditorControl(t)},doRemoveEditorControl:function(t){},getLayoutOptions:function(){return this._layoutOptions},setLayoutOptions:function(t){this._layoutOptions=t},layout:function(){},clearLayout:function(){},refreshLayout:function(){this.clearLayout();this.layout()},adjust:function(){},saveMappedData:function(t){throw"Crm.EntityMergerControl: Method 'saveMappedData' is not implemented"},hasConflict:function(){return false},setHasConflict:function(t){throw"Crm.EntityMergerControl: Method 'setHasConflict' is not implemented"},checkIfConflictResolved:function(t){return true},applyMergeResults:function(t,e,i){},registerEntityEditor:function(t){},unregisterEntityEditor:function(t){},scrollInToView:function(){if(this._editorControls.length===0){return}var t=this._editorControls[0].getWrapper();if(t){t.scrollIntoView();window.setTimeout(function(){this._merger.synchronizeVerticalScroll()}.bind(this),0)}}}}if(typeof BX.Crm.EntityMergerField==="undefined"){BX.Crm.EntityMergerField=function(){this._controller=null;this._hasConflict=false;this._isMultiple=false;this._sourceEntityIds=[];this._fieldSwitches=null;this._editorControlLayoutHandler=this.onEditorControlLayout.bind(this);this._enableAdjusting=true;this._hasLayout=false;BX.Crm.EntityMergerField.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityMergerField,BX.Crm.EntityMergerControl);BX.Crm.EntityMergerField.prototype.doInitialize=function(){this._controller=BX.prop.get(this._settings,"controller",null)};BX.Crm.EntityMergerField.prototype.layout=function(){if(this._hasLayout){return}var t,e;for(t=0,e=this._editorControls.length;t<e;t++){if(!this._editorControls[t].hasLayout()){BX.removeCustomEvent(window,"BX.Crm.EntityEditorField:onLayout",this._editorControlLayoutHandler);BX.addCustomEvent(window,"BX.Crm.EntityEditorField:onLayout",this._editorControlLayoutHandler);return}}this._fieldSwitches=[];var i=BX.prop.getInteger(this._layoutOptions,"interlacingIndex",0);for(t=0,e=this._editorControls.length;t<e;t++){var r=this._editorControls[t];if(i>0){var n=r.getWrapper();if(i%2>0){BX.addClass(n,"crm-entity-merger-row-odd");BX.removeClass(n,"crm-entity-merger-row-even")}else{BX.addClass(n,"crm-entity-merger-row-even");BX.removeClass(n,"crm-entity-merger-row-odd")}}if(!this._merger.checkIfPrimaryEditorControl(r)&&(this._hasConflict||this._isMultiple)){var o=r.getEditor();var s=o.getEntityTypeName();var a=o.getEntityId();var l=BX.Crm.EntityMergerFieldSwitch.create(s+"_"+a+"_"+r.getId(),{control:this,editorControl:r,entityId:a,isSelected:this.findSourceEntityIndex(a)>=0});this._fieldSwitches.push(l);l.layout()}}this._hasLayout=true;window.setTimeout(this.adjust.bind(this),500)};BX.Crm.EntityMergerField.prototype.clearLayout=function(){if(!this._hasLayout){return}for(var t=0,e=this._fieldSwitches.length;t<e;t++){this._fieldSwitches[t].clearLayout()}this._fieldSwitches=null;this._hasLayout=false};BX.Crm.EntityMergerField.prototype.checkIfHasLayout=function(){for(var t=0,e=this._editorControls.length;t<e;t++){if(!this._editorControls[t].hasLayout()){return false}}return true};BX.Crm.EntityMergerField.prototype.checkIfNeedToDisplay=function(){var t=this.getSchemeElement();if(t&&!t.isMergeable()){return false}for(var e=0,i=this._editorControls.length;e<i;e++){if(this._editorControls[e].isNeedToDisplay({enableLayoutResolvers:false})){return true}}return false};BX.Crm.EntityMergerField.prototype.onEditorControlLayout=function(t){if(this.getEditorControlIndex(t)>=0&&this.checkIfHasLayout()){BX.removeCustomEvent(window,"BX.Crm.EntityEditorField:onLayout",this._editorControlLayoutHandler);window.setTimeout(function(){this.layout()}.bind(this),0)}};BX.Crm.EntityMergerField.prototype.adjust=function(){if(!this._enableAdjusting){return}var t,e;var i=0;for(t=0,e=this._editorControls.length;t<e;t++){var r=this._editorControls[t];var n=r.getWrapper();if(this._merger.checkIfPrimaryEditorControl(r)){n.classList[this._hasConflict?"add":"remove"]("crm-entity-merger-column-cell-conflict")}var o=BX.pos(n).height;if(o>i){i=o}}if(i>0){for(t=0;t<e;t++){this._editorControls[t].getWrapper().style.minHeight=i+"px"}}};BX.Crm.EntityMergerField.prototype.isMultiple=function(){return this._isMultiple};BX.Crm.EntityMergerField.prototype.setIsMultiple=function(t){this._isMultiple=!!t};BX.Crm.EntityMergerField.prototype.hasConflict=function(){return this._hasConflict};BX.Crm.EntityMergerField.prototype.setHasConflict=function(t){this._hasConflict=!!t};BX.Crm.EntityMergerField.prototype.checkIfConflictResolved=function(t){var e=!this._hasConflict||this._sourceEntityIds.length>0;if(!e&&BX.prop.getBoolean(t,"scrollToConflict",false)){window.setTimeout(function(){this.scrollInToView()}.bind(this),0);t["scrollToConflict"]=false}return e};BX.Crm.EntityMergerField.prototype.getSourceEntityIds=function(){return this._sourceEntityIds};BX.Crm.EntityMergerField.prototype.setSourceEntityIds=function(t){this._sourceEntityIds=BX.type.isArray(t)?t:[]};BX.Crm.EntityMergerField.prototype.findSourceEntityIndex=function(t){if(this._sourceEntityIds===null){return-1}for(var e=0,i=this._sourceEntityIds.length;e<i;e++){if(this._sourceEntityIds[e]===t){return e}}return-1};BX.Crm.EntityMergerField.prototype.addSourceEntityId=function(t){if(!BX.type.isInteger(t)){t=parseInt(t);if(isNaN(t)){return}}if(this.findSourceEntityIndex(t)>=0){return}if(this._sourceEntityIds===null){this._sourceEntityIds=[]}this._sourceEntityIds.push(t)};BX.Crm.EntityMergerField.prototype.removeSourceEntityId=function(t){if(this._sourceEntityIds===null){return}if(!BX.type.isInteger(t)){t=parseInt(t);if(isNaN(t)){return}}var e=this.findSourceEntityIndex(t);if(e>=0){this._sourceEntityIds.splice(e,1)}};BX.Crm.EntityMergerField.prototype.getActiveSwitches=function(){var t=[];for(var e=0,i=this._fieldSwitches.length;e<i;e++){var r=this._fieldSwitches[e];if(r.isSelected()){t.push(r)}}return t};BX.Crm.EntityMergerField.prototype.onSwitchChange=function(t){var e,i;if(!this._isMultiple){if(!t.isSelected()){t.setSelected(true)}else{for(e=0,i=this._fieldSwitches.length;e<i;e++){if(this._fieldSwitches[e]===t||!this._fieldSwitches[e].isSelected()){continue}this._fieldSwitches[e].setSelected(false);this.removeSourceEntityId(this._fieldSwitches[e].getEntityId())}}}else if(!t.isSelected()){var r=false;for(e=0,i=this._fieldSwitches.length;e<i;e++){if(this._fieldSwitches[e].isSelected()){r=true;break}}if(!r){t.setSelected(true)}}if(t.isSelected()){this.addSourceEntityId(t.getEntityId())}else{this.removeSourceEntityId(t.getEntityId())}this._merger.processFieldSourceEntityChange(this,t.getEditorControl())};BX.Crm.EntityMergerField.prototype.saveMappedData=function(t){if(this._controller){this._controller.saveMappedData(this,t)}};BX.Crm.EntityMergerField.prototype.applyMergeResults=function(t,e,i){if(this._controller){this._controller.applyMergeResults(this,t,e,i)}};BX.Crm.EntityMergerField.prototype.adjustEditorControl=function(t,e){if(this._controller){this._controller.adjustEditorControl(t,e)}};BX.Crm.EntityMergerField.prototype.registerEntityEditor=function(t){if(this._editorControls.length===0){return}var e=t.getControlById(this._editorControls[0].getId());if(e){this.addEditorControl(e)}};BX.Crm.EntityMergerField.prototype.unregisterEntityEditor=function(t){if(this._editorControls.length===0){return}var e=t.getControlById(this._editorControls[0].getId());if(e){this.removeEditorControl(e)}};BX.Crm.EntityMergerField.prototype.getDataTagName=function(){return this._controller.resolveDataTagName(this)};BX.Crm.EntityMergerField.create=function(t,e){var i=new BX.Crm.EntityMergerField;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityMergerSection==="undefined"){BX.Crm.EntityMergerSection=function(){BX.Crm.EntityMergerSection.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityMergerSection,BX.Crm.EntityMergerControl);BX.Crm.EntityMergerSection.prototype.doInitialize=function(){this._controls=[];var t=this.getSchemeElement();if(!t){throw"Crm.EntityMergerSection. Could not find editor scheme element."}var e=t.getElements();for(var i=0;i<e.length;i++){var r=this._merger.createControlsBySchemeElement(e[i]);for(var n=0;n<r.length;n++){this._controls.push(r[n])}}};BX.Crm.EntityMergerSection.prototype.doAddEditorControl=function(t){for(var e=0,i=this._controls.length;e<i;e++){this._controls[e].addEditorControl(t.getChildById(this._controls[e].getId()))}};BX.Crm.EntityMergerSection.prototype.doRemoveEditorControl=function(t){for(var e=0,i=this._controls.length;e<i;e++){this._controls[e].removeEditorControl(t.getChildById(this._controls[e].getId()))}};BX.Crm.EntityMergerSection.prototype.layout=function(){var t=0;for(var e=0,i=this._controls.length;e<i;e++){var r=this._controls[e];var n={};if(r.checkIfNeedToDisplay()&&r._enableAdjusting){n["interlacingIndex"]=++t}r.setLayoutOptions(n);r.layout()}};BX.Crm.EntityMergerSection.prototype.clearLayout=function(){for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].clearLayout()}};BX.Crm.EntityMergerSection.prototype.refreshLayout=function(){for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].clearLayout();this._controls[t].layout()}};BX.Crm.EntityMergerSection.prototype.adjust=function(){for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].adjust()}};BX.Crm.EntityMergerSection.prototype.hasConflict=function(){for(var t=0,e=this._controls.length;t<e;t++){if(this._controls[t].hasConflict()){return true}}return false};BX.Crm.EntityMergerSection.prototype.setHasConflict=function(t){for(var e=0,i=this._controls.length;e<i;e++){this._controls[e].setHasConflict(t)}};BX.Crm.EntityMergerSection.prototype.checkIfConflictResolved=function(t){for(var e=0,i=this._controls.length;e<i;e++){if(!this._controls[e].checkIfConflictResolved(t)){return false}}return true};BX.Crm.EntityMergerSection.prototype.saveMappedData=function(t){for(var e=0,i=this._controls.length;e<i;e++){this._controls[e].saveMappedData(t)}};BX.Crm.EntityMergerSection.prototype.applyMergeResults=function(t,e,i){for(var r=0,n=this._controls.length;r<n;r++){this._controls[r].applyMergeResults(t,e,i)}};BX.Crm.EntityMergerSection.prototype.registerEntityEditor=function(t){for(var e=0,i=this._controls.length;e<i;e++){this._controls[e].registerEntityEditor(t)}};BX.Crm.EntityMergerSection.prototype.unregisterEntityEditor=function(t){for(var e=0,i=this._controls.length;e<i;e++){this._controls[e].unregisterEntityEditor(t)}};BX.Crm.EntityMergerSection.create=function(t,e){var i=new BX.Crm.EntityMergerSection;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityMergerFieldController==="undefined"){BX.Crm.EntityMergerFieldController=function(){};BX.Crm.EntityMergerFieldController.prototype={applyMergeResults:function(t,e,i,r){var n=BX.prop.getObject(e,t.getId(),null);if(!n){return}t.setIsMultiple(BX.prop.getBoolean(n,"IS_MULTIPLE",false));t.setSourceEntityIds(BX.prop.getArray(n,"SOURCE_ENTITY_IDS",[]));t.setHasConflict(!BX.prop.getBoolean(n,"IS_MERGED",true));i[t.getId()]=n.hasOwnProperty("VALUE")?n["VALUE"]:""},adjustEditorControl:function(t,e){e.setupFromModel(t.getModel(),{enableNotification:false});e.refreshLayout({reset:true})},saveMappedData:function(t,e){var i=t.getSourceEntityIds();if(t.isMultiple()){if(i.length===0){i.push(0)}e[t.getId()]={SOURCE_ENTITY_IDS:i}}else if(i.length>0){e[t.getId()]={SOURCE_ENTITY_IDS:i}}},resolveDataTagName:function(t){return t.getId()},getDataTagNameByEntityType:function(t,e){var i=t.getSchemeElement();if(!i){return""}var r=i.getDataArrayParam("compound",null);if(BX.type.isArray(r)){for(var n=0,o=r.length;n<o;n++){if(BX.prop.getString(r[n],"entityTypeName","")===e){return BX.prop.getString(r[n],"tagName","")}}}return""}};BX.Crm.EntityMergerFieldController.create=function(){return new BX.Crm.EntityMergerFieldController}}if(typeof BX.Crm.EntityMergerClientCompanyController==="undefined"){BX.Crm.EntityMergerClientCompanyController=function(t){this._isMultiple=!!t;BX.Crm.EntityMergerClientCompanyController.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityMergerClientCompanyController,BX.Crm.EntityMergerFieldController);BX.Crm.EntityMergerClientCompanyController.prototype.applyMergeResults=function(t,e,i,r){var n=BX.prop.getObject(e,t.getId(),null);if(!n){n=BX.prop.getObject(e,this._isMultiple?"COMPANY_IDS":"COMPANY_ID",null)}if(!n){return}if(!i.hasOwnProperty("CLIENT_INFO")){i["CLIENT_INFO"]=BX.prop.getObject(r,"CLIENT_INFO",{})}var o=BX.prop.getArray(BX.prop.getObject(n,"EXTRAS",{}),"INFOS",null);if(o){i["CLIENT_INFO"]["COMPANY_DATA"]=o}t.setIsMultiple(BX.prop.getBoolean(n,"IS_MULTIPLE",this._isMultiple));t.setHasConflict(!BX.prop.getBoolean(n,"IS_MERGED",true));t.setSourceEntityIds(BX.prop.getArray(n,"SOURCE_ENTITY_IDS",[]))};BX.Crm.EntityMergerClientCompanyController.prototype.adjustEditorControl=function(t,e){var i=e.getModel();var r=t.getModel();var n=r.getField("CLIENT_INFO");var o={COMPANY_DATA:n["COMPANY_DATA"]};i.updateDataObject("CLIENT_INFO",o,{enableNotification:false});e.refreshLayout({reset:true})};BX.Crm.EntityMergerClientCompanyController.prototype.saveMappedData=function(t,e){var i=t.getSourceEntityIds();if(!this._isMultiple){if(i.length>0){e[t.getId()]={SOURCE_ENTITY_IDS:i}}}else{if(i.length===0){i.push(0)}e[t.getId()]={SOURCE_ENTITY_IDS:i}}};BX.Crm.EntityMergerClientCompanyController.prototype.resolveDataTagName=function(t){return this.getDataTagNameByEntityType(t,BX.CrmEntityType.names.company)};BX.Crm.EntityMergerClientCompanyController.create=function(t){return new BX.Crm.EntityMergerClientCompanyController(t)}}if(typeof BX.Crm.EntityMergerClientContactController==="undefined"){BX.Crm.EntityMergerClientContactController=function(){BX.Crm.EntityMergerClientContactController.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityMergerClientContactController,BX.Crm.EntityMergerFieldController);BX.Crm.EntityMergerClientContactController.prototype.applyMergeResults=function(t,e,i,r){var n=BX.prop.getObject(e,t.getId(),null);if(!n){n=BX.prop.getObject(e,"CONTACT_IDS",null)}if(!n){return}if(!i.hasOwnProperty("CLIENT_INFO")){i["CLIENT_INFO"]=BX.prop.getObject(r,"CLIENT_INFO",{})}var o=BX.prop.getArray(BX.prop.getObject(n,"EXTRAS",{}),"INFOS",null);if(o){i["CLIENT_INFO"]["CONTACT_DATA"]=o}t.setIsMultiple(BX.prop.getBoolean(n,"IS_MULTIPLE",true));t.setHasConflict(!BX.prop.getBoolean(n,"IS_MERGED",true));t.setSourceEntityIds(BX.prop.getArray(n,"SOURCE_ENTITY_IDS",[]))};BX.Crm.EntityMergerClientContactController.prototype.adjustEditorControl=function(t,e){var i=e.getModel();var r=t.getModel();var n=r.getField("CLIENT_INFO");var o={CONTACT_DATA:n["CONTACT_DATA"]};i.updateDataObject("CLIENT_INFO",o,{enableNotification:false});e.refreshLayout({reset:true})};BX.Crm.EntityMergerClientContactController.prototype.saveMappedData=function(t,e){var i=t.getSourceEntityIds();if(i.length===0){i.push(0)}e[t.getId()]={SOURCE_ENTITY_IDS:i}};BX.Crm.EntityMergerClientContactController.prototype.resolveDataTagName=function(t){return this.getDataTagNameByEntityType(t,BX.CrmEntityType.names.contact)};BX.Crm.EntityMergerClientContactController.create=function(){return new BX.Crm.EntityMergerClientContactController}}if(typeof BX.Crm.EntityMergerFieldSwitch==="undefined"){BX.Crm.EntityMergerFieldSwitch=function(){this._id="";this._settings={};this._control=null;this._editorControl=null;this._entityId=0;this._wrapper=null;this._checkbox=null;this._clickHandler=BX.delegate(this.onClick,this);this._isSelected=false;this._hasLayout=false};BX.Crm.EntityMergerFieldSwitch.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._control=BX.prop.get(this._settings,"control");this._editorControl=BX.prop.get(this._settings,"editorControl");this._entityId=BX.prop.getInteger(this._settings,"entityId",0);this._isSelected=BX.prop.getBoolean(this._settings,"isSelected",false)},getId:function(){return this._id},getEntityId:function(){return this._entityId},isSelected:function(){return this._isSelected},setSelected:function(t){t=!!t;this._isSelected=t;if(this._checkbox){this._checkbox.checked=t}},getEditorControl:function(){return this._editorControl},layout:function(){if(this._hasLayout){return}var t=this._editorControl.getWrapper();var e=null;var i=t.querySelectorAll(".crm-entity-widget-before-action");for(var r=0;r<i.length;++r){if(i[r].getAttribute("data-field-tag")===this._control.getDataTagName()){e=i[r];break}}if(e){BX.cleanNode(e);BX.addClass(t,"crm-entity-merger-column-cell-conflict-option");this._checkbox=BX.create("input",{props:{className:"crm-entity-merger-column-cell-switch-checkbox",type:"checkbox"}});if(this._isSelected){this._checkbox.checked=true}BX.bind(this._checkbox,"click",this._clickHandler);var n=BX.create("label",{props:{className:"crm-entity-merger-column-cell-switch-container"},children:[this._checkbox,BX.create("div",{props:{className:"crm-entity-merger-column-cell-switch-checkbox-btn"}})]});e.appendChild(n)}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}BX.removeClass(this._editorControl.getWrapper(),"crm-entity-merger-column-cell-conflict-option");BX.unbind(this._checkbox,"click",this._clickHandler);this._checkbox=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},onClick:function(t){this._isSelected=this._checkbox.checked;this._control.onSwitchChange(this)}};BX.Crm.EntityMergerFieldSwitch.create=function(t,e){var i=new BX.Crm.EntityMergerFieldSwitch;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityMergerPanel==="undefined"){BX.Crm.EntityMergerPanel=function(){this._id="";this._settings={};this._merger=null;this._initialQueueLength=0;this._processedElement=null;this._remainingElement=null;this._mergeButton=null;this._postponeButton=null;this._isLocked=false;this._mergeHandler=BX.delegate(this.onMergeButtonClick,this);this._postponeHandler=BX.delegate(this.onPostponeButtonClick,this);this._previousButtonHandler=BX.delegate(this.onPreviousButtonClick,this);this._nextButtonHandler=BX.delegate(this.onNextButtonClick,this);this._dedupeListButtonHandler=BX.delegate(this.onDedupeListButtonClick,this)};BX.Crm.EntityMergerPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._merger=BX.prop.get(this._settings,"merger");this._initialQueueLength=this._merger.getDedupeQueueLength();BX.addCustomEvent(this._merger,"onMergeStart",BX.delegate(this.onMergeStart,this));BX.addCustomEvent(this._merger,"onPostponeStart",BX.delegate(this.onPostponeStart,this));BX.addCustomEvent(this._merger,"onMergeComplete",BX.delegate(this.onMergeComplete,this));BX.addCustomEvent(this._merger,"onPostponeComplete",BX.delegate(this.onPostponeComplete,this));BX.addCustomEvent(this._merger,"onMergeError",BX.delegate(this.onMergeComplete,this));BX.addCustomEvent(this._merger,"onPostponeError",BX.delegate(this.onPostponeError,this))},layout:function(){this._processedElement=BX("processedAmount");this._remainingElement=BX("remainingAmount");this._mergeButton=BX("mergeButton");BX.bind(this._mergeButton,"click",this._mergeHandler);this._postponeButton=BX("postponeButton");BX.bind(this._postponeButton,"click",this._postponeHandler);var t=BX("previousButton");if(t){BX.bind(t,"click",this._previousButtonHandler)}var e=BX("nextButton");if(e){BX.bind(e,"click",this._nextButtonHandler)}var i=BX("duplicateListButton");if(i){BX.bind(i,"click",this._dedupeListButtonHandler)}this.adjustLayout()},adjustLayout:function(){var t=this._merger.isQueueEnabled();var e=this._merger.isDeduplicationMode();var i=BX("duplicateListButton");if(i){i.style.display=e?"":"none"}var r=BX("queueStatisticsWrapper");if(r){r.style.display=t?"":"none"}var n=BX("queueNavigationButton");if(n){n.style.display=t?"":"none"}if(t){var o=this._merger.getDedupeQueueLength();if(this._processedElement){this._processedElement.innerHTML=this._initialQueueLength-o}if(this._remainingElement){this._remainingElement.innerHTML=o}}},onMergeButtonClick:function(t){if(!this._isLocked){this._merger.merge()}},onPostponeButtonClick:function(t){if(!this._isLocked){this._merger.postpone()}},onPreviousButtonClick:function(t){if(this._merger.isQueueEnabled()){this._merger.moveToPreviousQueueItem()}},onNextButtonClick:function(t){if(this._merger.isQueueEnabled()){this._merger.moveToNextQueueItem()}},onDedupeListButtonClick:function(t){if(this._merger.isDeduplicationMode()){this._merger.openDedupeList()}},onMergeStart:function(){this.setLocked(true);BX.addClass(this._mergeButton,"ui-btn-clock");BX.addClass(this._postponeButton,"ui-btn-disabled")},onPostponeStart:function(){this.setLocked(true);BX.addClass(this._mergeButton,"ui-btn-disabled");BX.addClass(this._postponeButton,"ui-btn-clock")},onMergeComplete:function(){this.setLocked(false);BX.removeClass(this._mergeButton,"ui-btn-clock");BX.removeClass(this._postponeButton,"ui-btn-disabled");this.adjustLayout()},onPostponeComplete:function(){this.setLocked(false);BX.removeClass(this._mergeButton,"ui-btn-disabled");BX.removeClass(this._postponeButton,"ui-btn-clock")},onMergeError:function(){this.setLocked(false);BX.removeClass(this._mergeButton,"ui-btn-clock");BX.removeClass(this._postponeButton,"ui-btn-disabled")},onPostponeError:function(){this.setLocked(false);BX.removeClass(this._mergeButton,"ui-btn-disabled");BX.removeClass(this._postponeButton,"ui-btn-clock")},setLocked:function(t){t=!!t;if(this._isLocked!==t){this._isLocked=t}}};BX.Crm.EntityMergerPanel.create=function(t,e){var i=new BX.Crm.EntityMergerPanel;i.initialize(t,e);return i}}
//# sourceMappingURL=script.map.js