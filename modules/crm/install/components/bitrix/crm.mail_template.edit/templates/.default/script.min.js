if(typeof BX.CrmEntityFieldSelector=="undefined"){BX.CrmEntityFieldSelector=function(){this._id="";this._settings={};this._container=null;this._entityTypeSelector=null;this._selector1=this._selector2=this._addButton=null;this._entityTypeId="";this._fieldTypeId="";this._fieldId="";this._childFieldId="";this._entityTypeChangeHandler=BX.delegate(this._onEntityTypeChange,this)};BX.CrmEntityFieldSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._map=this.getSetting("map");if(!BX.type.isArray(this._map)){throw"BX.CrmEntityFieldSelector: Could not find map!"}this._entityTypeId=this.getSetting("entityTypeId","");this._fieldTypeId=this.getSetting("fieldTypeId","");this._fieldId=this.getSetting("fieldId","");this._childFieldId=this.getSetting("_childFieldId","")},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},registerEntityTypeSelector:function(t){if(!BX.type.isElementNode(t)){throw"BX.CrmEntityFieldSelector: entity type selector is not DOM node!"}if(this._entityTypeSelector){BX.unbind(t,"change",this._entityTypeChangeHandler)}this._entityTypeSelector=t;this._entityTypeId=t.value;BX.bind(t,"change",this._entityTypeChangeHandler);this._setupDefaultField()},getEntityTypeInfo:function(t){if(!BX.type.isNotEmptyString(t)){return null}for(var e=0;e<this._map.length;e++){var i=this._map[e];if(i["typeId"]==t){return i}}return null},findEntityField:function(t,e){if(!BX.type.isNotEmptyString(t)){return null}var i=this.getEntityTypeInfo(t);var n=i&&i["fields"]?i["fields"]:[];for(var s=0;s<n.length;s++){var l=n[s];if(l["id"]==e){return l}}return null},clearLayout:function(){if(this._container){BX.cleanNode(this._container,false)}this._selector1=null;this._selector2=null;this._addButton=null},layout:function(t){if(!t){t=this._container}if(!t){throw"BX.CrmEntityFieldSelector: Container is not defined!"}if(t!==this._container){this._container=t}if(this._entityTypeId===""){throw"BX.CrmEntityFieldSelector: Could not find entity type Id!"}this._selector1=this._createSelector(this._entityTypeId,{attrs:{id:this._id+"Selector1"},events:{change:BX.delegate(this._onSelector1Change,this)}},this._fieldId);if(!this._selector1){return}t.appendChild(this._selector1);if(this._fieldTypeId!==""){this._selector2=this._createSelector(this._fieldTypeId,{attrs:{id:this._id+"Selector2"},events:{change:BX.delegate(this._onSelector2Change,this)}},this._childFieldId);if(this._selector2){t.appendChild(this._selector2)}}this._addButton=BX.create("BUTTON",{text:BX.CrmEntityFieldSelector.getMessage("buttonAdd"),events:{click:BX.delegate(this._onAddButtonClick,this)}});t.appendChild(this._addButton)},_createSelector:function(t,e,i){var n=this.getEntityTypeInfo(t);return n?this._createSelect(e,this._fieldsToOptions(n["fields"]),i):null},_fieldsToOptions:function(t){if(!BX.type.isArray(t)){return[]}var e=[];for(var i=0;i<t.length;i++){var n=t[i];e.push({text:n["name"],attrs:{value:n["id"]}})}return e},_createSelect:function(t,e,i){i=BX.type.isString(i)?i:"";var n=BX.create("SELECT",t);for(var s=0;s<e.length;s++){var l=e[s];if(!l["text"]){l["text"]=l["value"]}if(l["value"]==i){l["selected"]="selected"}var d=BX.create("OPTION",e[s]);if(!BX.browser.isIE){n.add(d,null)}else{try{n.add(d,n.options[null])}catch(t){n.add(d,null)}}}return n},_setupDefaultField:function(){var t=this.getEntityTypeInfo(this._entityTypeId);if(t&&t["fields"]&&t["fields"].length>0){var e=t["fields"][0];this._fieldTypeId=BX.type.isNotEmptyString(e["typeId"])?e["typeId"]:"";this._fieldId=BX.type.isNotEmptyString(e["id"])?e["id"]:"";if(this._fieldTypeId==""){this._childFieldId=""}else{t=this.getEntityTypeInfo(this._fieldTypeId);if(t&&t["fields"]&&t["fields"].length>0){e=t["fields"][0];this._childFieldId=BX.type.isNotEmptyString(e["id"])?e["id"]:""}}}else{this._fieldTypeId="";this._fieldId="";this._childFieldId=""}},_onEntityTypeChange:function(t){this._entityTypeId=this._entityTypeSelector.value;this._setupDefaultField();this.clearLayout();this.layout()},_onSelector1Change:function(t){if(!this._selector1){return}var e=this.findEntityField(this._entityTypeId,this._selector1.value);this._fieldId=e&&BX.type.isNotEmptyString(e["id"])?e["id"]:"";this._fieldTypeId=e&&BX.type.isNotEmptyString(e["typeId"])?e["typeId"]:"";if(this._fieldTypeId!==""){var i=this.getEntityTypeInfo(this._fieldTypeId);if(i&&i["fields"]&&i["fields"].length>0){e=i["fields"][0];this._childFieldId=BX.type.isNotEmptyString(e["id"])?e["id"]:""}if(this._selector2){BX.remove(this._selector2);this._selector2=null}this._selector2=this._createSelector(this._fieldTypeId,{attrs:{id:this._id+"Selector2"},events:{change:BX.delegate(this._onSelector2Change,this)}},this._childFieldId);if(this._selector2){this._container.insertBefore(this._selector2,this._addButton)}}else{this._childFieldId="";if(this._selector2){BX.remove(this._selector2);this._selector2=null}}},_onSelector2Change:function(t){if(!this._selector2){return}var e=this.findEntityField(this._fieldTypeId,this._selector2.value);this._childFieldId=e&&BX.type.isNotEmptyString(e["id"])?e["id"]:""},_onAddButtonClick:function(t){BX.PreventDefault(t);var e=this.getSetting("editorName","");var i=BX.type.isNotEmptyString(e)?window[e]:null;if(!i){return}var n=this.getEntityTypeInfo(this._entityTypeId);if(n&&this._fieldId){var s=n["typeName"]+"."+this._fieldId;if(this._childFieldId!==""){s+="."+this._childFieldId}i.InsertHTML("#"+s+"#")}return false},setPreselectedItems:(t,e,i)=>{const n=()=>{const e=i;const n=s.getDialog().getSelectedItems();if(BX.type.isArray(n)){const i=[];n.forEach((t=>{if(t.entityId==="user"&&t.id===e){BX.UI.Notification.Center.notify({content:BX.Loc.getMessage("CRM_MAIL_TEMPLATE_ENTITY_FIELD_SELECTOR_OWNER_ADD_ERROR")});s.getDialog().removeItem(t)}else{i.push([t.entityId,t.id])}}));BX(t).value=JSON.stringify(i)}};const s=new BX.UI.EntitySelector.TagSelector({dialogOptions:{context:"PROVIDING-ACCESS-TO-TEMPLATE",events:{"Item:onSelect":n,"Item:onDeselect":n},entities:[{id:"user",options:{inviteEmployeeLink:false,"!userId":[Number(i)]}},{id:"department",options:{selectMode:"usersAndDepartments"}},{id:"meta-user",options:{"all-users":true}}],preselectedItems:e}});BX.ready((()=>{const t=document.querySelector('[name = "ACCESS_SELECTOR"]');const e=t.closest("td");e.id="template-access-selector";e.innerHTML="";s.renderTo(document.getElementById("template-access-selector"))}))}};if(typeof BX.CrmEntityFieldSelector.messages=="undefined"){BX.CrmEntityFieldSelector.messages={}}BX.CrmEntityFieldSelector.getMessage=function(t){return typeof BX.CrmEntityFieldSelector.messages[t]!=="undefined"?BX.CrmEntityFieldSelector.messages[t]:""};BX.CrmEntityFieldSelector.create=function(t,e){var i=new BX.CrmEntityFieldSelector;i.initialize(t,e);return i}}
//# sourceMappingURL=script.map.js