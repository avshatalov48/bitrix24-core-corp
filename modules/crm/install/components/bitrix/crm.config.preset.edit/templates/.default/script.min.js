BX.namespace("BX.Crm");if(typeof BX.Crm.rebuildSelect==="undefined"){BX.Crm.rebuildSelect=function(e,t,i){var l,a,s,d,n;var r=false;var h,p;var o=null;if(!(i instanceof Array))i=[i];if(e){h=!!e.getAttribute("multiple");while(l=e.lastChild)e.removeChild(l);a=0;for(d=0;d<t.length;d++){p=false;if(t[d]["type"]){if(t[d]["type"]==="group"){s=document.createElement("optgroup");s.label=t[d]["title"];p=true}else if(t[d]["type"]==="endgroup"){o=null;continue}}else{s=document.createElement("option");s.value=t[d]["id"];s.innerHTML=BX.util.htmlspecialchars(t[d]["title"])}if(!p&&o)o.appendChild(s);else e.appendChild(s);if(p){o=s}else{if(!r||h){for(n=0;n<i.length;n++){if(t[d]["id"]==i[n]){s.selected=true;if(!r){r=true;e.selectedIndex=a}break}}}a++}}}}}BX.Crm.PresetFieldListManagerClass=function(){var e=function(e){this.settings=e?e:{};this._form=BX(this.settings["formId"])};e.prototype={getMessage:function(e){return typeof this.settings.messages[e]!="undefined"?this.settings.messages[e]:""},addField:function(){this.editField(0)},editField:function(e){e=parseInt(e);if(e<0)e=0;if(this.dlg&&this.dlg.popup)return;var t="";this.dlg={popupId:this.settings["id"]+(e===0?"_FieldAdd":"_FieldEdit"),popup:null,elements:{createNew:null,fieldName:null,fieldNameWrapper:null,fieldType:null,fieldTypeWrapper:null,fieldTitle:null,fieldTitleWrapper:null,inShortList:null,sort:null},fieldId:e,fieldData:{FIELD_NAME:t,FIELD_TITLE:this.getMessage("defaultFieldTitle"),FIELD_ETITLE:"",SORT:this.getMessage("defaultSort"),IN_SHORT_LIST:this.getMessage("defaultInShortList")}};if(e>0&&this.settings.fieldData[e])this.dlg.fieldData=this.settings.fieldData[e];this.dlg.popup=new BX.PopupWindow(this.dlg.popupId,null,{overlay:{opacity:10},autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:this.getMessage(this.dlg.fieldId>0?"fieldEditDialogTitle":"fieldAddDialogTitle"),events:{onPopupShow:function(){},onPopupClose:BX.delegate(function(){this.dlg.popup.destroy()},this),onPopupDestroy:BX.delegate(function(){delete this.dlg},this)},content:this._prepareFieldEditDialogContent(),buttons:[new BX.PopupWindowButton({text:this.dlg.fieldId===0?this.getMessage("addBtnText"):this.getMessage("editBtnText"),className:"popup-window-button-accept",events:{click:BX.delegate(this._hanleFieldEditDialogSave,this)}}),new BX.PopupWindowButtonLink({text:this.getMessage("cancelBtnText"),className:"popup-window-button-link-cancel",events:{click:BX.delegate(this._hanleFieldEditDialogCancel,this)}})]});this.dlg.popup.show();BX.focus(this.dlg.elements.fieldName)},_prepareFieldEditDialogContent:function(){var e,t,i;var l=BX.create("TABLE",{style:{marginLeft:"12px",marginTop:"12px",marginRight:"12px",marginBottom:"12px"},attrs:{cellspacing:"7"}});if(this.dlg.fieldId<=0){var a=this.dlg.popupId+"_CREATE_NEW";l.appendChild(BX.create("TR",{children:[BX.create("TD",{attrs:{colspan:"2"},children:[BX.create("TABLE",{attrs:{style:"width: 100%; text-align: center;"},children:[BX.create("TR",{children:[BX.create("TD",{children:[this.dlg.elements.createNew=BX.create("INPUT",{attrs:{id:a+"_1",type:"radio",name:a,value:"Y"},props:{checked:true},events:{click:BX.delegate(this._hanleCreateNewFlagSwitch,this)}}),BX.create("LABEL",{attrs:{for:a+"_1"},text:this.getMessage("createNewTitle")})]}),BX.create("TD",{children:[BX.create("INPUT",{attrs:{id:a+"_2",type:"radio",name:a,value:"N"},events:{click:BX.delegate(this._hanleCreateNewFlagSwitch,this)}}),BX.create("LABEL",{attrs:{for:a+"_2"},text:this.getMessage("createSelectedTitle")})]})]})]})]})]}))}if(this.dlg.fieldId===0){l.appendChild(this.dlg.elements.fieldNameWrapper=BX.create("TR",{attrs:{style:"display: none;"},children:[BX.create("TD",{children:[BX.create("LABEL",{html:this.getMessage("fieldNameSelectFieldTitle")+":"})]}),BX.create("TD",{children:[this.dlg.elements.fieldName=BX.create("SELECT")]})]}));BX.Crm.rebuildSelect(this.dlg.elements.fieldName,this.settings["entityFieldsForSelect"],"")}else{l.appendChild(this.dlg.elements.fieldNameWrapper=BX.create("TR",{children:[BX.create("TD",{children:[BX.create("LABEL",{html:this.getMessage("fieldNameFieldTitle")+":"})]}),BX.create("TD",{children:[this.dlg.elements.fieldName=BX.create("SPAN",{html:BX.util.htmlspecialchars(this.dlg.fieldData.FIELD_ETITLE)})]})]}))}if(this.dlg.fieldId===0){l.appendChild(this.dlg.elements.fieldTypeWrapper=BX.create("TR",{children:[BX.create("TD",{children:[BX.create("LABEL",{html:this.getMessage("fieldTypeFieldTitle")+":"})]}),BX.create("TD",{children:[this.dlg.elements.fieldType=BX.create("SELECT")]})]}));i="_new_string";t=[{id:"_new_string",title:this.getMessage("newStringFieldTitle")},{id:"_new_double",title:this.getMessage("newDoubleFieldTitle")},{id:"_new_boolean",title:this.getMessage("newBooleanFieldTitle")},{id:"_new_datetime",title:this.getMessage("newDatetimeFieldTitle")}];BX.Crm.rebuildSelect(this.dlg.elements.fieldType,t,i)}l.appendChild(this.dlg.elements.fieldTitleWrapper=BX.create("TR",{children:[BX.create("TD",{children:[BX.create("LABEL",{html:this.getMessage("fieldTitleTitle")+":"})]}),BX.create("TD",{children:[this.dlg.elements.fieldTitle=BX.create("INPUT",{attrs:{class:"bx-crm-edit-input"},props:{type:"text",value:this.dlg.fieldData.FIELD_TITLE}})]})]}));l.appendChild(BX.create("TR",{children:[BX.create("TD",{children:[BX.create("LABEL",{html:this.getMessage("sortFieldTitle")+":"})]}),BX.create("TD",{children:[this.dlg.elements.sort=BX.create("INPUT",{attrs:{class:"bx-crm-edit-input"},props:{type:"text",value:this.dlg.fieldData.SORT}})]})]}));l.appendChild(BX.create("TR",{attrs:{style:"display: none;"},children:[BX.create("TD",{children:[BX.create("LABEL",{html:this.getMessage("inShortListFieldTitle")+":"})]}),BX.create("TD",{children:[this.dlg.elements.inShortList=BX.create("INPUT",{props:{type:"checkbox",checked:this.dlg.fieldData.IN_SHORT_LIST==="Y"}})]})]}));return l},_hanleFieldEditDialogSave:function(){if(!this._form)return;var e=BX.findChild(this._form,{tag:"input",attr:{name:"action"}});var t=BX.findChild(this._form,{tag:"input",attr:{name:"ID"}});var i=BX.findChild(this._form,{tag:"input",attr:{name:"FIELD_NAME"}});var l=BX.findChild(this._form,{tag:"input",attr:{name:"FIELD_TITLE"}});var a=BX.findChild(this._form,{tag:"input",attr:{name:"IN_SHORT_LIST"}});var s=BX.findChild(this._form,{tag:"input",attr:{name:"SORT"}});var d=this.dlg.elements.fieldName;var n=this.dlg.elements.fieldType;var r=this.dlg.elements.fieldTitle;var h=this.dlg.elements.inShortList;var p=this.dlg.elements.sort;var o,c,g;if(this.dlg.fieldId===0){if(this.dlg.elements.createNew.checked)o=n.value;else o=d.value;if(o.length<=0){alert(this.getMessage(this.dlg.elements.createNew.checked?"emptyFieldTypeError":"emptyFieldNameError"));return}}g=r.value;if(g.length>255){alert(this.getMessage("longFieldTitleError"));return}if(this.dlg.fieldId===0){e.value="ADD_FIELD";t.value=0;i.value=d.value;l.value=r.value;a.value=h.checked?"Y":"N";s.value=p.value;if(BX.type.isNotEmptyString(o)&&o.substr(0,5)==="_new_"){c=o.substr(5);if(!BX.type.isNotEmptyString(g)){alert(this.getMessage("emptyNewFieldTitleError"));return}switch(c){case"string":case"double":case"boolean":case"datetime":this._addUserField({type:c,title:g},BX.delegate(this._continueHanleFieldEditDialogSave,this));return;break}}}else{e.value="edit";t.value=this.dlg.fieldId;i.value="";l.value=this.dlg.fieldData.FIELD_TITLE=r.value;a.value=this.dlg.fieldData.IN_SHORT_LIST=h.checked?"Y":"N";s.value=this.dlg.fieldData.SORT=p.value}this._continueHanleFieldEditDialogSave()},_continueHanleFieldEditDialogSave:function(){BX.showWait();if(this._form)this._form.submit()},_hanleFieldEditDialogCancel:function(){this.dlg.popup.close()},_addUserField:function(e,t){var i=this.settings["userFieldEntityId"];var l=this.settings["userFieldServiceUrl"];if(!BX.type.isNotEmptyString(i)){throw"Error: The 'userFieldEntityId' parameter is not defined in settings or empty."}if(!BX.type.isNotEmptyString(l)){throw"Error: Could not find 'userFieldServiceUrl' parameter in settings."}var a={USER_TYPE_ID:e["type"],ENTITY_ID:i,MULTIPLE:"N",MANDATORY:"N",SHOW_FILTER:"Y",EDIT_FORM_LABEL:e["title"]};this._pendingData={fieldData:a,callback:BX.type.isFunction(t)?t:null};BX.ajax({url:l,method:"POST",dataType:"json",data:{ACTION:"ADD_FIELD",DATA:this._pendingData["fieldData"]},onsuccess:BX.delegate(this._onCreateUserFieldRequestSuccess,this),onfailure:BX.delegate(this._onCreateUserFieldRequestFailure,this)})},_onCreateUserFieldRequestSuccess:function(e){var t=BX.type.isNotEmptyString(e["ERROR"])?e["ERROR"]:"";if(t!==""){alert(t);return}var i=BX.type.isPlainObject(e["RESULT"])?e["RESULT"]:{};var l=this._pendingData["fieldData"];var a=l["ID"]=BX.type.isNotEmptyString(i["ID"])?i["ID"]:"";if(!BX.type.isNotEmptyString(a)){throw"Error: Could not find 'ID' in action result."}var s=l["FIELD_NAME"]=BX.type.isNotEmptyString(i["FIELD_NAME"])?i["FIELD_NAME"]:"";if(!BX.type.isNotEmptyString(s)){throw"Error: Could not find 'FIELD_NAME' in action result."}var d=BX.findChild(this._form,{tag:"input",attr:{name:"FIELD_NAME"}});d.value=s;if(typeof this._pendingData["callback"]==="function")this._pendingData["callback"]();this._pendingData=null},_onCreateUserFieldRequestFailure:function(e){this._pendingData=null;alert("Could not create user field.")},_hanleCreateNewFlagSwitch:function(){if(this.dlg.elements.createNew.checked){this.dlg.elements.fieldNameWrapper.style.display="none";this.dlg.elements.fieldTypeWrapper.style.display=this.dlg.elements.fieldTitleWrapper.style.display=""}else{this.dlg.elements.fieldNameWrapper.style.display="";this.dlg.elements.fieldTypeWrapper.style.display=this.dlg.elements.fieldTitleWrapper.style.display="none"}}};return e}();