{"version":3,"file":"script.js","sources":["src/panel.js"],"sourcesContent":["import {Event, Loc, Type, Dom, Runtime, ajax, Text} from 'main.core';\nimport {PopupMenuWindow} from 'main.popup';\n\ntype PanelItem = {\n\tID: number | string,\n\tNAME: string,\n\tIS_ACTIVE: boolean,\n\tCOUNTER: number,\n\tCOUNTER_CODE: string,\n\tURL: string,\n\tCREATE_URL: string,\n\tENABLED: string,\n};\n\ntype PanelOptions = {\n\tcounter: HTMLSpanElement,\n\tbutton: HTMLButtonElement,\n\tcontainer: HTMLDivElement,\n\titems: Array<PanelItem>,\n\ttunnelsUrl: string,\n\tcomponentParams: Object,\n};\n\nexport class Panel extends Event.EventEmitter\n{\n\tstatic createMenuItem(options: PanelItem)\n\t{\n\t\tconst item = {\n\t\t\tid: options.ID,\n\t\t\ttext: Text.encode(options.NAME),\n\t\t\thref: options.URL,\n\t\t};\n\n\t\tconst count = Number.parseInt(options.COUNTER, 10);\n\n\t\tif (Type.isNumber(count) && count > 0)\n\t\t{\n\t\t\tconst counter = `<span class=\"main-buttons-item-counter\">${options.COUNTER}</span>`;\n\t\t\titem.text = `${item.text} ${counter}`;\n\t\t}\n\n\t\treturn item;\n\t}\n\n\tconstructor(options: PanelOptions)\n\t{\n\t\tsuper();\n\n\t\tthis.button = options.button;\n\t\tthis.counter = options.counter;\n\t\tthis.container = options.container;\n\t\tthis.items = options.items;\n\t\tthis.tunnelsUrl = options.tunnelsUrl;\n\t\tthis.componentParams = options.componentParams;\n\t\tthis.onButtonClick = this.onButtonClick.bind(this);\n\n\t\tEvent.bind(this.button, 'click', this.onButtonClick);\n\t}\n\n\tisDropdown()\n\t{\n\t\treturn Dom.hasClass(this.button, 'ui-btn-dropdown');\n\t}\n\n\treload()\n\t{\n\t\treturn ajax\n\t\t\t.runComponentAction(\n\t\t\t\t'bitrix:crm.deal_category.panel',\n\t\t\t\t'getComponent',\n\t\t\t\t{\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tparams: this.componentParams,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t)\n\t\t\t.then((response) => {\n\t\t\t\tconst newContainer = Runtime.html(null, response.data.html);\n\t\t\t\tDom.replace(this.container, newContainer);\n\t\t\t\tthis.getMenu().destroy();\n\t\t\t});\n\t}\n\n\tonButtonClick(event)\n\t{\n\t\tevent.preventDefault();\n\n\t\tif (this.isDropdown())\n\t\t{\n\t\t\tthis.getMenu().show();\n\t\t\treturn;\n\t\t}\n\n\t\tthis.showTunnelSlider();\n\t}\n\n\tshowTunnelSlider()\n\t{\n\t\t// eslint-disable-next-line\n\t\tBX.SidePanel.Instance.open(\n\t\t\tthis.tunnelsUrl,\n\t\t\t{\n\t\t\t\tcacheable: false,\n\t\t\t\tcustomLeftBoundary: 40,\n\t\t\t\tallowChangeHistory: false,\n\t\t\t\tevents: {\n\t\t\t\t\tonClose: () => {\n\t\t\t\t\t\tthis.reload();\n\t\t\t\t\t\tif (window.top.BX.Main && window.top.BX.Main.filterManager)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tconst {data} = window.top.BX.Main.filterManager;\n\t\t\t\t\t\t\t// eslint-disable-next-line\n\t\t\t\t\t\t\tObject.values(data).forEach(filter => filter._onFindButtonClick());\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t);\n\t}\n\n\tgetMenu()\n\t{\n\t\tif (!this.menu)\n\t\t{\n\t\t\tconst menuItems = this.items\n\t\t\t\t.map(item => Panel.createMenuItem(item));\n\n\t\t\tmenuItems.push({\n\t\t\t\tdelimiter: true,\n\t\t\t});\n\n\t\t\tmenuItems.push({\n\t\t\t\tid: 'tunnels',\n\t\t\t\ttext: Loc.getMessage('CRM_DEAL_CATEGORY_PANEL_TUNNELS'),\n\t\t\t\tonclick: this.showTunnelSlider.bind(this),\n\t\t\t});\n\n\t\t\tthis.menu = new PopupMenuWindow({\n\t\t\t\tbindElement: this.button,\n\t\t\t\titems: menuItems,\n\t\t\t});\n\t\t}\n\n\t\treturn this.menu;\n\t}\n}"],"names":["Panel","options","item","id","ID","text","Text","encode","NAME","href","URL","count","Number","parseInt","COUNTER","Type","isNumber","counter","button","container","items","tunnelsUrl","componentParams","onButtonClick","bind","Event","Dom","hasClass","ajax","runComponentAction","data","params","then","response","newContainer","Runtime","html","replace","getMenu","destroy","event","preventDefault","isDropdown","show","showTunnelSlider","BX","SidePanel","Instance","open","cacheable","customLeftBoundary","allowChangeHistory","events","onClose","reload","window","top","Main","filterManager","Object","values","forEach","filter","_onFindButtonClick","menu","menuItems","map","createMenuItem","push","delimiter","Loc","getMessage","onclick","PopupMenuWindow","bindElement","EventEmitter"],"mappings":"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"}