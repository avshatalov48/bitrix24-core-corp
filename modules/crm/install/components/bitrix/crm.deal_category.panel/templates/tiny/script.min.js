if(typeof BX.CrmDealCategoryTinyPanel==="undefined"){BX.CrmDealCategoryTinyPanel=function(){this._id="";this._settings={};this._items=null;this._container=null;this._selectorButton=null;this._isCustomized=false;this._counterId="";this._counterContainer="";this._counterMap=null;this._enableCreation=false;this._createUrl="";this._createLockScript="";this._nodes=null;this._button=null;this._menuId="";this._menu=null};BX.CrmDealCategoryTinyPanel.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._items=this.getSetting("items",[]);var i=this.getSetting("containerId","");this._container=BX.type.isNotEmptyString(i)?BX(i):null;if(!BX.type.isElementNode(this._container)){throw"BX.CrmDealCategoryTinyPanel: Container is not found."}var n=this.getSetting("selectorButtonId","");this._selectorButton=BX.type.isNotEmptyString(n)?BX(n):null;if(this._selectorButton){BX.bind(this._selectorButton,"click",BX.delegate(this.onSelectorClick,this))}this._isCustomized=this.getSetting("isCustomized",false);this._enableCreation=this.getSetting("enableCreation",false);this._createUrl=this.getSetting("createUrl","");this._createLockScript=this.getSetting("createLockScript","");this._menuId=this._id;this._counterId=this.getSetting("counterId","");this._counterContainer=BX(this.getSetting("counterContainerId",""));if(this._counterId!==""&&BX.type.isElementNode(this._counterContainer)){BX.addCustomEvent("onPullEvent-main",BX.delegate(this.onPullEvent,this))}this._counterMap={};for(var s=0,r=this._items.length;s<r;s++){var o=this._items[s];var a=BX.prop.getNumber(o,"ID",0);var u=BX.prop.getString(o,"COUNTER_CODE","");if(u!==""){this._counterMap[u]=a}}},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.CrmDealCategoryTinyPanel.messages;return e.hasOwnProperty(t)?e[t]:t},getItemById:function(t){t=BX.convert.toNumber(t);for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(t===BX.prop.getNumber(n,"ID",-1)){return n}}return null},createNewItem:function(){if(this._enableCreation&&this._createUrl!==""){window.location.href=this._createUrl}else if(this._createLockScript!==""){eval(this._createLockScript)}},onSelectorClick:function(t){if(this._isCustomized){this.openMenu()}else{this.createNewItem()}},onCreateButtonClick:function(t){this.createNewItem()},openMenu:function(){this.closeMenu();var t=[];for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];var s='<span class="main-buttons-item-text">'+n["NAME"]+"</span>";var r=BX.prop.getInteger(n,"COUNTER",0);if(r>0){s+='</span> <span class="main-buttons-item-counter">'+r+"</span>"}t.push({text:s,href:n["URL"]})}if(this._enableCreation){t.push({delimiter:true});t.push({text:this.getMessage("create"),onclick:BX.delegate(this.onCreateButtonClick,this)})}this._menu=BX.PopupMenu.create(this._menuId,this._selectorButton,t,{autoHide:true,closeByEsc:true});this._menu.popupWindow.show()},closeMenu:function(){if(this._menu){BX.PopupMenu.destroy(this._menuId);this._menu=null}},onPullEvent:function(t,e){if(t!=="user_counter"){return}var i=BX.prop.getObject(e,BX.message("SITE_ID"),{});for(var n in i){if(!i.hasOwnProperty(n)){continue}var s=BX.convert.toNumber(i[n]);if(s<0){continue}if(this._counterId===n){this._counterContainer.innerHTML=s}var r=BX.prop.getNumber(this._counterMap,n,-1);if(r>=0){var o=this.getItemById(r);if(o){o["COUNTER"]=s}}}}};if(typeof BX.CrmDealCategoryTinyPanel.messages==="undefined"){BX.CrmDealCategoryTinyPanel.messages={}}BX.CrmDealCategoryTinyPanel.create=function(t,e){var i=new BX.CrmDealCategoryTinyPanel;i.initialize(t,e);return i}}