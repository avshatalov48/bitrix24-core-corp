(function(){"use strict";BX.namespace("BX.Config.Order.Property");BX.Config.Order.Property=function(e){this.params=e.params||{};this.signedParamsString=e.signedParamsString;this.actionRequestUrl=e.actionRequestUrl;this.bindEvents()};BX.Config.Order.Property.prototype={getFileIds:function(){var e={};var r=BX("crm-order-prop"),i,t;if(BX.type.isDomNode(r)){var n=0;for(var o=0;o<r.elements.length;o++){i=r.elements[o];if(i.disabled||!i.type||i.type.toLowerCase()!=="file")continue;t=i.previousSibling;if(t.type==="hidden"){var s=i.name;var a=s.indexOf("[");if(a>-1){s=i.name.substring(0,a);n=i.name.substring(a+1,i.name.indexOf("]"))}if(!BX.type.isPlainObject(e[s])){e[s]={}}e[s][n]={ID:t.value};n++}}}return e},reloadAction:function(){var e=BX("crm-order-prop");var r=this;this.fadeForm();BX.ajax.submitAjax(e,{url:this.actionRequestUrl,method:"POST",dataType:"json",data:{action:"reloadFormAjax",isAjax:"Y",FILE_IDS:this.getFileIds(),signedParamsString:this.signedParamsString},onsuccess:function(i){if(!i.html)return;var t=BX.processHTML(i.html);e.innerHTML=t.HTML;BX.ajax.processScripts(t.SCRIPT);if(!i.error){window.top.BX.SidePanel.Instance.postMessage(window,"OrderPropertyEdit::onReload",{property:i.property})}r.showForm()}})},saveAction:function(){var e=BX("crm-order-prop");var r=this;this.fadeForm();BX.ajax.submitAjax(e,{url:this.actionRequestUrl,method:"POST",dataType:"json",data:{action:"saveFormAjax",isAjax:"Y",FILE_IDS:this.getFileIds(),signedParamsString:this.signedParamsString},onsuccess:function(i){r.showForm();if(!i)return;if(i.html){var t=BX.processHTML(i.html);e.innerHTML=t.HTML;BX.ajax.processScripts(t.SCRIPT)}if(!i.error){if(r.params.IFRAME){window.top.BX.SidePanel.Instance.postMessage(window,"OrderPropertyEdit::onSave",{property:i.property});window.top.BX.SidePanel.Instance.close()}else if(BX.type.isNotEmptyString(i.redirect)){document.location.href=i.redirect}}}})},applyAction:function(){var e=BX("crm-order-prop");window.top.BX.SidePanel.Instance.postMessage(window,"OrderPropertyEdit::onApply",{property:BX.ajax.prepareForm(e).data});window.top.BX.SidePanel.Instance.close()},fadeForm:function(){var e=BX("crm-order-prop");e.style.opacity="0.2"},showForm:function(){var e=BX("crm-order-prop");e.style.opacity=""},closeSlider:function(){window.top.BX.SidePanel.Instance.close()},saveClickHandler:function(e){if(this.params.LOAD_FROM_REQUEST==="Y"&&parseInt(this.params.PROPERTY_ID)<=0){this.applyAction(e)}else{this.saveAction(e)}},bindEvents:function(){BX.bind(BX("CRM_ORDER_PROPERTY_APPLY_BUTTON"),"click",BX.proxy(this.saveClickHandler,this));BX.bind(BX("CRM_ORDER_PROPERTY_SUBMIT_BUTTON"),"click",BX.proxy(this.saveClickHandler,this));BX.bind(BX("CRM_ORDER_PROPERTY_CANCEL"),"click",BX.proxy(this.closeSlider,this))}}})();