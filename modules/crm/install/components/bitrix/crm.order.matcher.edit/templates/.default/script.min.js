var CrmFormEditor=function(e){this.init=function(e){this.jsEventsManagerId=e.jsEventsManagerId;this.detailPageUrlTemplate=e.detailPageUrlTemplate;this.id=e.id;this.userBlockController=new CrmFormEditorUserBlockController(e.userBlocks);e.fields=e.fields||[];this.actionRequestUrl=e.actionRequestUrl;this.signedParamsString=e.signedParamsString;this.personType=e.personType;this.context=e.context;this.templates=e.templates;this.path=e.path;this.mess=e.mess;this.currency=e.currency;this.entityDictionary=e.entityDictionary;this.schemesDictionary=e.schemesDictionary;this.fieldsDictionary=e.fieldsDictionary;this.booleanFieldItems=e.booleanFieldItems;this.isFramePopup=e.isFramePopup;this.isItemWasAdded=e.isItemWasAdded;this.fields=[];this.fieldTemporaryData={};this.initSlider();this.helper=new CrmFormEditorHelper;this.dragdrop=new CrmFormEditorDragDrop(e.dragdrop);BX.addCustomEvent(this.dragdrop,"onSort",BX.delegate(this.onSort,this));this.initExistedFields(e);this.popupFieldSettings=new CrmOrderFormEditPopupFieldSettings({caller:this,content:BX("CRM_ORDER_FORM_POPUP_SETTINGS"),container:BX("CRM_ORDER_FORM_POPUP_SETTINGS_CONTAINER")});this.fieldSelector=new CrmFormEditorFieldSelector({caller:this,context:BX("FIELD_SELECTOR")});this.entityScheme=new CrmOrderFormEditEntityScheme({caller:this,context:BX("ENTITY_SCHEME_CONTAINER")});this.dependencies=new CrmFormEditorDependencies({caller:this,relations:e.relations,relationEntities:e.relationEntities});this.destination=new CrmFormEditorDestination({caller:this,container:BX("crm-orderform-edit-responsible")});this.adsForm=new CrmFormAdsForm({caller:this,container:BX("CRM_ORDERFORM_ADS_FORM")});this.sortFields();this.initAnimation();this.initInterface();this.initToolTips();BX.addCustomEvent("SidePanel.Slider:onMessage",this.listenSliderEvents.bind(this))};this.initSlider=function(){if(!this.isFramePopup){return}if(this.isItemWasAdded){this.slider.reloadList()}this.slider.bindClose(BX("CRM_ORDERFORM_EDIT_TO_LIST_BOTTOM"))};this.slider={bindClose:function(e){BX.bind(e,"click",this.close)},close:function(e){e.preventDefault();window.top.BX.SidePanel.Instance.close()},open:function(e){window.top.BX.SidePanel.Instance.open(e)},reloadList:function(e){window.top.BX.SidePanel.Instance.close();window.top.location.reload()}};this.redirectToUrl=function(e){if(!this.isFramePopup){window.location.href=e}else{this.slider.open(e)}};this.initExistedFields=function(e){if(!e.fields){return}e.fields.forEach(function(e){var t={node:BX(e.CODE),id:e.ID,name:e.CODE,name_id:e.NAME,type:e.TYPE,items:e.ITEMS||[],entity:e.ENTITY_NAME||"",getCaption:this.onGetFieldCaption};this.initField(t);this.initFieldSettings(t)},this)};this.initInterface=function(){BX.bind(BX("IS_PAY"),"click",function(){BX.toggleClass(BX("PAY_SYSTEM_CONT"),"crm-orderform-display-none")})};this.showErrors=function(e){var t=BX("crm-orderform-error");if(BX.type.isDomNode(t)){var i="";e.forEach(function(e){i+='<div class="crm-entity-widget-content-error-text">'+e+"</div>"});t.innerHTML=i;BX.show(t);BX.scrollToNode(t)}};this.submitForm=function(){var e=[];this.fields.forEach(function(t){if(!t.dict["caption"]||!t.dict["entity_name"]){return}e.push(t.name)},this);var t=BX("crm_orderform_edit_form");var i=this;BX.addClass(BX("CRM_ORDERFORM_SUBMIT_BUTTON"),"ui-btn-clock");BX.addClass(BX("CRM_ORDERFORM_SUBMIT_APPLY"),"ui-btn-clock");BX.ajax.submitAjax(t,{url:this.actionRequestUrl,method:"POST",dataType:"json",data:{action:"saveFormAjax",checkFields:e,signedParamsString:this.signedParamsString},onsuccess:function(e){BX.removeClass(BX("CRM_ORDERFORM_SUBMIT_BUTTON"),"ui-btn-clock");BX.removeClass(BX("CRM_ORDERFORM_SUBMIT_APPLY"),"ui-btn-clock");i.entityScheme.submitButtonEnabled=true;if(!e||e.error){if(e.error){i.showErrors(e.errors)}return}if(e.redirect){document.location.reload()}else{window.top.BX.SidePanel.Instance.postMessage(window,"OrderForm::onSave",{properties:e.properties});window.top.BX.SidePanel.Instance.close()}}})};this.initAnimation=function(){var e=document.getElementsByClassName(".crm-orderform-edit-animate");e=BX.convert.nodeListToArray(e);e.forEach(function(e){},this)};this.bindEditInline=function(e,t){var i=e.querySelector("[data-bx-order-form-lbl-cont]");var r=e.querySelector("[data-bx-order-form-lbl-caption]");var n=e.querySelector("[data-bx-order-form-btn-caption]");var o=e.querySelector("[data-bx-order-form-lbl-btn-edit]");var s=e.querySelector("[data-bx-order-form-lbl-btn-apply]");BX.bind(o,"click",function(){BX.addClass(i,t)});BX.bind(s,"click",function(){r.innerText=n.value;BX.removeClass(i,t)})};this.sendActionRequest=function(e,t,i,r){i=i||null;r=r||null;t=t||{};t.action=e;t.form_id=null;t.signedParamsString=this.signedParamsString;t.sessid=BX.bitrix_sessid();BX.ajax({url:this.actionRequestUrl,method:"POST",data:t,timeout:30,dataType:"json",processData:true,onsuccess:BX.proxy(function(e){e=e||{};if(e.error){r.apply(this,[e])}else if(i){i.apply(this,[e])}},this),onfailure:BX.proxy(function(){var e={error:true,text:""};r.apply(this,[e])},this)})};this.onGetFieldCaption=function(){var e="";var t=document.querySelector("#"+this.name+" [data-bx-order-form-lbl-caption]");if(BX.type.isDomNode(t)){e=t.getAttribute("data-bx-order-form-lbl-caption")}return e};this.getFieldNameList=function(){var e=[];this.fields.forEach(function(t){e.push(t.name_id||t.name)});return e};this.fireChangeFieldListEvent=function(){BX.onCustomEvent(this,"change-field-list",[this.fields])};this.fireFieldChangeItemsEvent=function(e){BX.onCustomEvent(e,"change-field-items");BX.onCustomEvent(this,"change-field-items",[this.fields,e])};this.addFieldByCode=function(e){var t=this.fieldsDictionary.filter(function(t){return t.name==e});if(t[0]){this.addField(t[0])}};this.addFieldByData=function(e){var t=this.fieldsDictionary.filter(function(t){var i=true;for(var r in e){if(e.hasOwnProperty(r)&&e[r]){if(t[r]!=e[r]){i=false;break}}}return i});if(t[0]){this.addField(t[0])}};this.addField=function(e,t){if(!e.duplicated&&this.findField(e.name)){return}var i=this.templates.field.replace("%type%",e.type);if(!this.helper.getTemplate(i)){i=this.templates.field.replace("%type%","string")}var r=e.is_phone||e.entity_field_name==="PHONE";var n=e.is_email||e.entity_field_name==="EMAIL";e.entity_field_name=e.entity_field_name||"";var o=e.entity_name==="ORDER";var s=this.helper.appendNodeByTemplate(BX("FIELD_CONTAINER"),i,{id:e.id||"",code:e.name||"",type:e.type,name:e.code?e.code:e.name,name_id:e.name?e.name:e.code,caption:e.caption,placeholder:e.placeholder||"",multiple:e.multiple?"Y":"N",required:e.required?"Y":"N",sort:e.sort!==undefined?e.sort:1e3,props_group_id:e.props_group_id||"0",value_type:"",value:e.value||"",items:"",settings_items:"",checked:e.checked||"",show_multiple:e.multiple?"multiple":"","~show_match_anchor":o?'style="display: none;"':"",show_time:e.show_time||"",control_id:e.name?e.name:this.helper.generateId(),url_display_style:e.entity_field_name.substring(0,3)==="UF_"?"initial":"none",preset_id:e.preset_id||0,bank_detail:e.bank_detail||"N",address:e.address||"N",address_type:e.address_type||0,user_props:e.user_props||!o?"Y":"N",is_location:e.is_location?"Y":"N",is_location4tax:e.is_location4tax?"Y":"N",is_profile_name:e.is_profile_name?"Y":"N",is_payer:e.is_payer?"Y":"N",is_email:n?"Y":"N",is_phone:r?"Y":"N",is_zip:e.is_zip?"Y":"N",is_address:e.is_address?"Y":"N",time:e.time?"Y":"N",entity_field_name:e.entity_field_name,entity_field_caption:o?e.caption:e.original_caption,entity_name:e.entity_name,entity_caption:e.entity_caption});if(!s){return}var a={type:e.type,node:s,name:e.name,items:e.items||[],entity:e.entity_name,getCaption:this.onGetFieldCaption};if(a.type==="file"&&a.items.length===0){a.items=[{name:a.name,ID:""}]}this.initField(a);this.addFieldItems(a);this.addFieldSettingsItems(a);this.initFieldSettings(a);if(!t){this.sortFields();this.fireChangeFieldListEvent()}this.fieldSelector.adjustHeight();return a};this.addFieldItems=function(e,t){t=t||false;if(e.items.length==0||!e.itemsContainer){return}if(t){e.itemsContainer.innerHTML=""}var i=this.templates.field.replace("%type%",e.type);var r=i+"_item";if(!BX.type.isArray(e.items)){e.items=BX.util.array_values(e.items)}e.items.forEach(function(t,i){var n=t.NAME!==undefined;var o=n?t.VALUE:t.ID;var s=n?t.NAME:t.VALUE;var a=BX.type.isArray(e.dict.value)?e.dict.value:[e.dict.value];var l=BX.util.in_array(o,a);var d=BX.message("CRM_ORDERFORM_EDIT_TMPL_FILE_NOT_SELECTED");if(t.SRC&&t.FILE_NAME){d='<a href="'+t.SRC+'" title="'+BX.message("CRM_ORDERFORM_EDIT_TMPL_FILE_DOWNLOAD")+'" target="_blank">'+(t.FILE_NAME.length>35&&"..."+t.FILE_NAME.substr(-32)||t.FILE_NAME)+"</a>"}this.helper.appendNodeByTemplate(e.itemsContainer,r,{name:e.name,item_id:t.ID,item_code:o,item_value:s,checked:l?"checked":"",selected:l?"selected":"",field_item_name:e.type+"_"+e.name+"_"+e.randomId+"[]",field_item_id:e.type+"_"+t.ID+this.helper.generateId(),"~file_src":d,list_order:e.dict.multiple?"["+i+"]":""})},this)};this.getSaleFieldType=function(e){var t;switch(e){case"checkbox":t="Y/N";break;case"radio":case"list":case"listCheckbox":t="ENUM";break;case"date":t="DATE";break;case"file":t="FILE";break;case"location":t="LOCATION";break;case"string":case"text":default:t="STRING"}return t};this.getCrmFieldType=function(e,t){var i;switch(e.TYPE){case"STRING":case"NUMBER":if(t==="typed_string"){i=t}else{i="string"}break;case"Y/N":i="checkbox";break;case"ENUM":if(e.MULTIELEMENT==="Y"){i=e.MULTIPLE==="Y"?"listCheckbox":"radio"}else{i="list"}break;case"DATE":i="date";break;case"FILE":i="file";break;case"LOCATION":i="location";break;default:i="STRING"}return i};this.getSaleVariants=function(e){var t=[];var i=100;for(var r in e){if(e.hasOwnProperty(r)){t.push({VALUE:e[r].ID,NAME:e[r].NAME,SORT:i});i+=100}}return t};this.convertDataCrmToSale=function(e){e.NAME=e.CAPTION;e.TYPE=this.getSaleFieldType(e.TYPE);if(e.TYPE==="ENUM"){e.VARIANTS=this.getSaleVariants(e.ITEMS)}return e};this.initField=function(e){if(!e.node){return}var t=this.findDictionaryField(e.name);if(!t){t={code:e.name,type:e.type,required:false,multiple:false}}e.dict=t;e.randomId=this.helper.generateId();var i=e.node.querySelector("[data-bx-order-form-btn-caption]");var r=e.node.querySelector("[data-bx-order-form-btn-slider-edit]");var n=e.node.querySelector("[data-bx-order-form-btn-delete]");e.lblCaption=e.node.querySelector("[data-bx-order-form-lbl-caption]");e.itemsContainer=e.node.querySelector("[data-bx-order-form-field-display-cont]");var o=this;BX.bind(i,"change",function(){e.lblCaption.innerText=i.value;o.fireChangeFieldListEvent()});BX.bind(r,"click",function(){var t=o.personType||0;var i=e.id||e.dict.id||0;var r=o.path.property.replace("#person_type_id#",t).replace("#property_id#",i);var n={cacheable:false,allowChangeHistory:false};if(!i){var s;if(o.fieldTemporaryData[e.dict.name]){s=o.fieldTemporaryData[e.dict.name]}else{var a=BX.ajax.prepareForm(BX("crm_orderform_edit_form"));s=a.data&&a.data.FIELD&&a.data.FIELD[e.dict.name];s=o.convertDataCrmToSale(s);s.PERSON_TYPE_ID=t;s.CODE=e.dict.name;s.MATCHED=e.dict.entity_name!=="ORDER"?"Y":"N"}if(BX.type.isNotEmptyObject(s)){n={cacheable:false,allowChangeHistory:false,requestMethod:"post",requestParams:BX.merge(s,{action:"initialLoadFromRequest",sessid:BX.bitrix_sessid()})}}}window.top.BX.SidePanel.Instance.open(r,n)});BX.bind(n,"click",function(){o.deleteField(e)});this.dragdrop.addItem(e.node);this.fields.push(e);BX.addCustomEvent(e,"change-field-items",BX.proxy(function(){var t=null;if(e.type=="product"){t=e.itemsContainer.children[0]}e.itemsContainer.innerHTML="";if(t){e.itemsContainer.appendChild(t)}this.addFieldItems(e)},this));BX.bind(e.node.querySelector("[data-crm-orderform-name-link]"),"click",this.showFieldInFieldSelector.bind(this))};this.showFieldInFieldSelector=function(e){var t=BX.getEventTarget(e);var i=t.getAttribute("data-crm-orderform-name-link");if(!i)return;var r=field=this.fieldSelector.getFieldNode(i);if(BX.type.isDomNode(r)){while(r=BX.findParent(r,{attrs:this.fieldSelector.attributeGroup},BX("FIELD_SELECTOR"))){BX.addClass(r,this.fieldSelector.classGroupShow);BX.removeClass(r,this.fieldSelector.classGroupClose)}}if(BX.type.isDomNode(field)){this.fieldSelector.scrollIntoView(field)}};this.initFieldSettings=function(e){if(!e.node){return}var t=e.node.querySelector("[data-bx-order-form-field-type]");var i=e.node.querySelector("[data-bx-order-form-btn-multiple-value]");var r=e.node.querySelector("[data-bx-order-form-btn-multiple]");var n=e.node.querySelector("[data-bx-order-form-btn-multiple-cont]");var o=e.node.querySelector("[data-bx-order-form-btn-add]");if(n&&i&&r){if(!e.dict.multiple){this.helper.styleDisplay(n,false);i.value="N"}else{r.checked=i.value=="Y";if(e.dict.type=="checkbox"){var s=function(){i.value=r.checked?"Y":"N";t.value=e.type=r.checked?"checkbox":"radio";this.addFieldItems(e,true)};BX.bind(r,"click",BX.proxy(s,this));s.apply(this,[])}else{this.helper.styleDisplay(o,r.checked,"inline-block");BX.bind(r,"click",BX.proxy(function(){i.value=r.checked?"Y":"N";this.helper.styleDisplay(o,r.checked,"inline-block")},this))}}}var a=BX.convert.nodeListToArray(e.node.querySelectorAll("[data-bx-order-form-btn-checkbox-value]"));var l=BX.convert.nodeListToArray(e.node.querySelectorAll("[data-bx-order-form-btn-checkbox]"));if(a.length===a.length){a.forEach(function(e,t){if(e.value==="Y"){l[t].checked=true}BX.bind(l[t],"change",function(){e.value=l[t].checked?"Y":"N"})})}var d=e.dict["type"]?e.dict.type:e.type;var c="initFieldType"+d.substring(0,1).toUpperCase()+d.substring(1);if(this[c]){this[c](e)}};this.addFieldSettingsItems=function(e){var t=e.node.querySelector("[data-bx-crm-orderform-field-settings-items]");if(!t||e.items.length==0||!e.itemsContainer){return}var i=this.templates.field.replace("%type%",e.type);var r=i+"_settings_item";e.items.forEach(function(i){var n=i.NAME!==undefined;var o=n?i.ID:"";var s=n?i.VALUE:i.ID;var a=n?i.VALUE:i.ID;var l=n?i.NAME:i.VALUE;this.helper.appendNodeByTemplate(t,r,{name:e.name,item_id:o,item_code:s,item_value:a,item_name:l,field_item_name:e.type+"_"+e.name+"_"+e.randomId+"[]",field_item_id:e.type+"_"+i.ID+this.helper.generateId()})},this)};this.initFieldTypeProduct=function(e){e.productSelector=new CrmFormEditorProductSelector({jsEventsManagerId:this.jsEventsManagerId,context:e.node,caller:this,id:e.id,field:e})};this.initFieldTypeListCheckbox=function(e){this.initFieldTypeList(e)};this.initFieldTypeCheckbox=function(e){this.initFieldTypeList(e)};this.initFieldTypeRadio=function(e){this.initFieldTypeList(e)};this.initFieldTypeList=function(e){e.fieldListManager=new CrmFormEditorFieldListSettings({caller:this,context:e.node,type:e.type,field:e})};this.initFieldTypeSection=function(e){this.bindEditInline(e.node,"dynamic-field")};this.initFieldTypeString=function(e){var t=e.node.querySelector("[data-bx-order-form-field-string-type]");var i=e.node.querySelector("[data-bx-order-form-field-type]");if(t){t.value=i.value;BX.bind(t,"bxchange",function(){i.value=t.value||"string"})}};this.initFieldTypeTyped_string=function(e){this.initFieldTypeString(e);if(!e.dict["value_type"]){return}var t=e.node.querySelector("[data-bx-order-form-field-string-value-types]");var i=e.node.querySelector("[data-bx-order-form-field-string-value-type]");if(t){var r=i.value;var n=[];e.dict.value_type.forEach(function(e){if(!r){r=e.ID}n.push({caption:e.VALUE,value:e.ID,selected:e.ID==r})},this);this.helper.fillDropDownControl(t,n);i.value=r;BX.bind(t,"bxchange",function(){i.value=t.value||"OTHER"})}};this.initFieldTypeDouble=function(e){this.initFieldTypeString(e)};this.initFieldTypeInteger=function(e){this.initFieldTypeString(e)};this.findDictionaryField=function(e){var t=this.fieldsDictionary.filter(function(t){return t.name==e});if(t&&t.length>0){return t[0]}return null};this.findField=function(e){var t=this.fields.filter(function(t){return t.name==e});if(t&&t.length>0){return t[0]}return null};this.findFieldByNode=function(e){var t=this.fields.filter(function(t){return t.node==e});if(t&&t.length>0){return t[0]}return null};this.editField=function(e,t){this.popupFieldSettings.show(e.settingsContainer)};this.deleteField=function(e,t){t=t||false;BX.onCustomEvent(this,"delete-field",[e]);this.dragdrop.removeItem(e.node);BX.remove(e.node);var i=BX.util.array_search(e,this.fields);if(i>-1){delete this.fields[i]}if(!t){this.sortFields()}this.fireChangeFieldListEvent();this.fieldSelector.adjustHeight()};this.moveField=function(e,t){this.sortFields()};this.sortFields=function(){this.fields.forEach(function(e){e.sortValue=BX.convert.nodeListToArray(e.node.parentNode.children).indexOf(e.node)});this.fields.sort(function(e,t){return e.sortValue>t.sortValue?1:-1});var e=10;this.fields.forEach(function(t){t.sort=(t.sortValue+1)*e;var i=t.node.querySelector("[data-bx-order-form-field-sort]");if(i){i.value=t.sort}})};this.onSort=function(e,t){this.sortFields()};this.initToolTips=function(e){this.popupTooltip={};e=e||BX.convert.nodeListToArray(document.body.querySelectorAll(".crm-orderform-context-help"));var t=this;for(var i=0;i<e.length;i++){if(e[i].getAttribute("context-help")=="y")continue;e[i].setAttribute("data-id",i);e[i].setAttribute("context-help","y");BX.bind(e[i],"mouseover",function(){var e=this.getAttribute("data-id");var i=this.getAttribute("data-text");t.showTooltip(e,this,i)});BX.bind(e[i],"mouseout",function(){var e=this.getAttribute("data-id");t.hideTooltip(e)})}};this.showTooltip=function(e,t,i){if(this.popupTooltip[e])this.popupTooltip[e].close();this.popupTooltip[e]=new BX.PopupWindow("bx-crm-orderform-edit-tooltip",t,{lightShadow:true,autoHide:false,darkMode:true,offsetLeft:0,offsetTop:2,bindOptions:{position:"top"},zIndex:200,events:{onPopupClose:function(){this.destroy()}},content:BX.create("div",{attrs:{style:"padding-right: 5px; width: 250px;"},html:i})});this.popupTooltip[e].setAngle({offset:13,position:"bottom"});this.popupTooltip[e].show();return true};this.hideTooltip=function(e){this.popupTooltip[e].close();this.popupTooltip[e]=null};this.listenSliderEvents=function(e){if(e.getEventId()==="OrderPropertyEdit::onSave"){this.onPropertyEditSave(e)}if(e.getEventId()==="OrderPropertyEdit::onApply"){this.onPropertyEditApply(e);this.onPropertyEditSave(e)}};this.onPropertyEditSave=function(e){var t=e.getData();var i=t.property;if(i){var r=i.MATCH_CODE||i.CODE;var n=this.findField(r);if(!n){r="ORDER_"+r;n=this.findField(r)}if(!n){return}this.deleteField(n,true);for(var o=0;o<this.fieldsDictionary.length;o++){if(this.fieldsDictionary[o].name===r){this.fieldsDictionary[o]=BX.merge(this.fieldsDictionary[o],{id:i.ID,type:this.getCrmFieldType(i,this.fieldsDictionary[o].type),caption:i.NAME,placeholder:i.DESCRIPTION,sort:n.sort,code:i.CODE,props_group_id:i.PROPS_GROUP_ID,is_address:i.IS_ADDRESS==="Y",is_email:i.IS_EMAIL==="Y",is_location:i.IS_LOCATION==="Y",is_location4tax:i.IS_LOCATION4TAX==="Y",is_payer:i.IS_PAYER==="Y",is_phone:i.IS_PHONE==="Y",is_profile_name:i.IS_PROFILE_NAME==="Y",is_zip:i.IS_ZIP==="Y",multiple:i.MULTIPLE==="Y",required:i.REQUIRED==="Y",user_props:i.USER_PROPS==="Y"});this.fieldsDictionary[o].value=i.DEFAULT_VALUE;if(i.TYPE==="FILE"){this.fieldsDictionary[o].items=i.DEFAULT_VALUE||[]}else{this.fieldsDictionary[o].items=i.VARIANTS||[]}if(this.fieldsDictionary[o].type==="checkbox"){this.fieldsDictionary[o].checked=i.DEFAULT_VALUE==="Y"?"checked":""}break}}this.addField(this.fieldsDictionary[o]);this.fieldSelector.onCallerFieldAdd(n);if(n.entity==="ORDER"){this.fieldSelector.changeFieldText(n.name,i.NAME)}}};this.onPropertyEditApply=function(e){var t=e.getData();var i=t.property;if(i){this.fieldTemporaryData[i.CODE]=BX.clone(i)}};this.init(e)};function CrmOrderFormEditEntityScheme(e){this.caller=e.caller;this.context=e.context;this.submitButtonEnabled=true;this.currentEntityPayerType=null;this.init()}CrmOrderFormEditEntityScheme.prototype={init:function(){this.helper=BX.CrmFormEditorHelper;this.descriptionNode=this.context.querySelector("[data-bx-orderform-edit-scheme-desc]");this.descriptionTopNode=BX("ENTITY_SCHEMES_TOP_DESCRIPTION");this.radioList=BX.convert.nodeListToArray(this.context.querySelectorAll("[data-bx-order-form-entity-scheme-value]"));this.dealCategoryNode=this.context.querySelector("[data-bx-order-form-entity-scheme-deal-cat]");var e=document.getElementsByName("ENTITY_SCHEME");this.valueNode=e[0];this.submitButtonNode=BX("CRM_ORDERFORM_SUBMIT_BUTTON");BX.bind(this.submitButtonNode,"click",BX.proxy(this.checkCreateFields,this));BX.bind(BX("CRM_ORDERFORM_SUBMIT_APPLY"),"click",BX.proxy(this.checkCreateFields,this));BX.addCustomEvent(this.caller,"change-field-list",BX.proxy(this.actualizeInvoiceSettings,this));this.actualizeInvoiceSettings()},isInvoiceChecked:function(){return false},addRequiredFields:function(){var e=this.popupConfirmCreateFields.contentContainer.querySelectorAll("[data-form-required-field]"),t;e=BX.convert.nodeListToArray(e);for(var i=0;i<e.length;i++){t=e[i].getAttribute("data-form-required-field");this.caller.addFieldByCode(t);BX.addClass(BX(t),"crm-orderform-field-highlight")}setTimeout(function(){for(var i=0;i<e.length;i++){t=e[i].getAttribute("data-form-required-field");BX.removeClass(BX(t),"crm-orderform-field-highlight")}},2e3)},showPopupCreateProductField:function(){if(!this.popupCreateProductField){this.popupCreateProductField=BX.PopupWindowManager.create("crm_orderform_edit_create_prod_field",null,{content:this.caller.mess.dlgInvoiceEmptyProduct,titleBar:this.caller.mess.dlgInvoiceEmptyProductTitle,autoHide:false,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500}});this.popupCreateProductField.setButtons([new BX.PopupWindowButton({text:this.caller.mess.dlgContinue,className:"orderform-small-button-accept",events:{click:BX.proxy(function(){this.popupCreateProductField.close()},this)}})])}this.popupCreateProductField.show();this.popupCreateProductField.resizeOverlay()},showPopupCreateFields:function(){if(!this.popupConfirmCreateFields){this.popupConfirmCreateFields=BX.PopupWindowManager.create("crm_orderform_edit_create_fields",null,{titleBar:this.caller.mess.dlgTitleFieldCreate,content:BX("CRM_ORDER_FORM_POPUP_CONFIRM_FIELD_CREATE"),autoHide:false,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500},onPopupClose:BX.proxy(this.onClose)});this.popupConfirmCreateFields.setButtons([new BX.PopupWindowButton({text:this.caller.mess.dlgCreateFields,className:"orderform-small-button-accept",events:{click:BX.proxy(function(){this.submitButtonEnabled=true;BX.removeClass(this.submitButtonNode,"crm-orderform-submit-button-loader");this.popupConfirmCreateFields.close();this.addRequiredFields()},this)}}),new BX.PopupWindowButton({text:this.caller.mess.dlgCancel,className:"orderform-small-button-cancel",events:{click:BX.proxy(function(){this.submitButtonEnabled=true;BX.removeClass(this.submitButtonNode,"crm-orderform-submit-button-loader");this.popupConfirmCreateFields.close()},this)}})])}this.popupConfirmCreateFields.show()},checkCreateFields:function(e){if(!this.submitButtonEnabled){BX.PreventDefault(e);return false}var t=this.getCurrent();var i=false;var r=[];var n={};this.caller.fields.forEach(function(e){if(e.type=="product"&&e.items.length>0){i=true}if(!e.dict["caption"]||!e.dict["entity_name"]){return}r.push(e.name);n[e.name]=e.dict.caption},this);if(this.isInvoiceChecked()&&!i){BX.PreventDefault(e);this.showPopupCreateProductField();return false}BX.PreventDefault(e);this.submitButtonEnabled=false;BX.addClass(this.submitButtonNode,"crm-orderform-submit-button-loader");var o=BX("CRM_ORDER_FORM_POPUP_CONFIRM_FIELD_CREATE_LIST");this.caller.sendActionRequest("checkFieldsAjax",{schemeId:t.ID,fieldCodes:r},BX.proxy(function(e){e=e||{};var t=[];var i=e.requiredFieldCodes||[];if(i.length===0){this.caller.submitForm();return}var r=this;i.forEach(function(e){var i=r.caller.findDictionaryField(e);if(i){t.push('<li class="crm-p-s-f-item" data-form-required-field="'+i.name+'">'+BX.util.htmlspecialchars(i.caption)+" ("+BX.util.htmlspecialchars(r.caller.entityDictionary[i.entity_name])+")</li>")}});o.innerHTML=t.join("");this.showPopupCreateFields()},this),BX.proxy(function(){o.innerHTML=fieldCaptionList.join("");this.showPopupCreateFields()},this));return false},setCurrentId:function(e){if(this.valueNode){this.valueNode.value=e}},isUsingRequisites:function(){return this.hasFieldsRequisite},getCurrentPayerEntityType:function(){return this.currentEntityPayerType},setCurrentPayerEntityType:function(e){var t=this.currentEntityPayerType!==e;this.currentEntityPayerType=e;if(t){this.onChange()}},_currentPayerEntityType:function(e){e=e||null;this.invoice.payerTypeNodes.forEach(function(t){if(e){t.checked=e==t.value}else if(t.checked){e=t.value}},this);return e},getCurrent:function(){var e="BY_NON_INVOICE";var t=null;this.radioList.forEach(function(e){if(!t||e.checked){t=e.value}});return this.caller.schemesDictionary[e][t]},onChange:function(){var e=this.getCurrent();this.setCurrentId(e.ID);this.actualizeInvoiceSettings(e);this.actualizeDealCategory(e);BX.onCustomEvent(this.caller,"change-entity-scheme",[e])},getCurrentWillCreatedEntities:function(){var e=this.getCurrent();var t=[];var i=this.getCurrentPayerEntityType();var r=this.isUsingRequisites();e.ENTITIES.forEach(function(e){var n=i===e;var o=e==="CONTACT";var s=e==="COMPANY";var a=e==="REQUISITE";if(o&&!this.hasFieldsContact&&!n){return}if(s&&!this.hasFieldsCompany&&!n){return}if(a&&!r){return}if(this.caller.entityDictionary[e]){t.push(e)}},this);return t},actualizeDealCategory:function(){var e=this.getCurrent();var t=BX.util.in_array("DEAL",e.ENTITIES);this.helper.changeClass(this.dealCategoryNode,"crm-orderform-edit-animate-show-120",t)},actualizeTextWillCreatedEntities:function(){var e=[];this.getCurrentWillCreatedEntities().forEach(function(t){e.push(this.caller.entityDictionary[t])},this);var t=this.getCurrent();var i=e.length>0?e.join(", "):t["DESCRIPTION"];if(this.descriptionNode){this.descriptionNode.innerText=i}if(this.descriptionTopNode){this.descriptionTopNode.innerText=i}},actualizePayer:function(){var e=false,t=false,i=false;this.caller.fields.forEach(function(r){if(r.dict["entity_name"]){if(r.dict.entity_name==="CONTACT")e=true;if(r.dict.entity_name==="COMPANY")t=true;if(r.dict.entity_name==="REQUISITE")i=true}},this);this.hasFieldsCompany=t;this.hasFieldsContact=e;this.hasFieldsRequisite=i;if(e){this.setCurrentPayerEntityType("CONTACT")}else if(t){this.setCurrentPayerEntityType("COMPANY")}else{this.setCurrentPayerEntityType(null)}},actualizeInvoiceSettings:function(){this.actualizePayer();this.actualizeTextWillCreatedEntities()}};function CrmOrderFormEditFormButton(e){this.caller=e.caller;this.context=e.context;this.helper=BX.CrmFormEditorHelper;this.buttonNode=BX("FORM_BUTTON");this.buttonInputNode=BX("FORM_BUTTON_INPUT");this.buttonTextErrorNode=BX("FORM_BUTTON_INPUT_ERROR");this.buttonColorBgNode=BX("BUTTON_COLOR_BG");this.buttonColorFontNode=BX("BUTTON_COLOR_FONT");this.popupButtonNameNode=BX("CRM_ORDER_FORM_POPUP_BUTTON_NAME");this.init()}CrmOrderFormEditFormButton.prototype={init:function(){BX.bind(this.buttonNode.parentNode,"click",BX.proxy(this.editButton,this));BX.bind(this.buttonInputNode,"bxchange",BX.proxy(this.onButtonCaptionChange,this));this.initColorPicker()},editButton:function(){this.caller.popupFieldSettings.show(this.popupButtonNameNode,BX.proxy(this.onEditButtonClosePopup,this))},onEditButtonClosePopup:function(){var e=!!BX.util.trim(this.buttonInputNode.value);this.helper.styleDisplay(this.buttonTextErrorNode,!e,"block");return e},onButtonCaptionChange:function(){this.buttonNode.innerText=this.buttonInputNode.value},updateButtonColors:function(){this.buttonNode.style.background=this.buttonColorBgNode.value;this.buttonNode.style.color=this.buttonColorFontNode.value},initColorPicker:function(){this.picker=new window.BXColorPicker({id:"picker",name:"picker"});this.picker.Create();var e=this;var t=function(){var t=this;t.parentNode.appendChild(e.picker.pCont);e.picker.oPar.OnSelect=BX.proxy(function(e){if(!e)e="";t.value=e;var i=BX.nextSibling(t);if(i){i.style.background=e}BX.fireEvent(t,"change")},e);e.picker.pCont.style.display="";e.picker.Close();e.picker.Open(t);e.picker.pCont.style.display="none"};var i=function(){var t=BX.nextSibling(this);if(t){t.style.background=this.value;e.updateButtonColors()}};var r=this.context.querySelectorAll("[data-order-form-color-picker]");r=BX.convert.nodeListToArray(r);for(var n in r){var o=r[n];var s=BX.nextSibling(o);BX.bind(s,"click",BX.proxy(t,o));BX.bind(o,"click",t);BX.bind(o,"focus",t);BX.bind(o,"bxchange",BX.delegate(i,o));BX.fireEvent(o,"change")}}};function CrmOrderFormEditPopupFieldSettings(e){this.caller=e.caller;this.popup=null;this.popupContent=e.content;this.popupContainer=e.container;this.popupCloseHandler=null;this.fieldContainer=null}CrmOrderFormEditPopupFieldSettings.prototype={setAutoHide:function(e){if(this.popup){this.popup.params.autoHide=e}},show:function(e,t){this.popupCloseHandler=t||null;this.initPopup();this.moveSettingsBack();this.fieldContainer=e;this.moveSettingsOn();this.popup.show()},moveSettingsOn:function(){if(!this.fieldContainer){return}this.replaceSettingsNode(this.fieldContainer,this.popupContainer)},moveSettingsBack:function(){if(!this.fieldContainer){return}this.replaceSettingsNode(this.popupContainer,this.fieldContainer);this.fieldContainer=null},_popupClose:function(e){if(this.popupCloseHandler&&!this.popupCloseHandler.apply(this,[])){return}this.onClose();BX.PopupWindow.prototype.close.apply(this.popup,[e])},onClose:function(){this.moveSettingsBack();this.popupCloseHandler=null},replaceSettingsNode:function(e,t){if(!e||!e.firstElementChild){return}t.appendChild(e.firstElementChild)},initPopup:function(){if(this.popup){return}var e=BX.PopupWindowManager.create("crm_orderform_edit_field_settings",null,{content:this.popupContent,autoHide:false,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500},zIndex:-400,titleBar:this.caller.mess.dlgTitle,closeIcon:true});e.setButtons([new BX.PopupWindowButton({text:this.caller.mess.dlgClose,className:"orderform-small-button-accept crm-orderform-edit-popup-button",events:{click:BX.proxy(function(){this.popup.close()},this)}})]);e.close=BX.proxy(this._popupClose,this);this.popup=e}};function CrmFormEditorFieldSelector(e){this.caller=e.caller;this.context=e.context;this.attributeSearch="data-bx-crm-wf-selector-search";this.attributeSearchButton="data-bx-crm-wf-selector-search-btn";this.attributeGroup="data-bx-crm-wf-selector-field-group";this.attributeField="data-bx-crm-wf-selector-field-name";this.presetAttributeField="data-bx-crm-wf-selector-preset-field";this.attributeAddButton="data-bx-crm-wf-selector-btn-add";this.classFieldSelected="crm-orderform-edit-right-inner-list-active";this.classSearchActive="crm-orderform-edit-constructor-right-search-active";this.classGroupShow="crm-orderform-edit-open";this.classGroupClose="crm-orderform-edit-close";this.helper=BX.CrmFormEditorHelper;this.init(e)}CrmFormEditorFieldSelector.prototype={getFieldNode:function(e){return this.context.querySelector("["+this.attributeField+'="'+e+'"]')},init:function(e){this.groupNodeList=this.context.querySelectorAll("["+this.attributeGroup+"]");this.groupNodeList=BX.convert.nodeListToArray(this.groupNodeList);this.groupNodeList.forEach(this.initGroup,this);this.fieldNodeList=this.context.querySelectorAll("["+this.attributeField+"]");this.fieldNodeList=BX.convert.nodeListToArray(this.fieldNodeList);this.fieldNodeList.forEach(this.initField,this);BX.addCustomEvent(this.caller,"delete-field",BX.proxy(this.onCallerFieldDelete,this));this.searchButton=this.context.querySelector("["+this.attributeSearchButton+"]");BX.bind(this.searchButton,"click",BX.proxy(this.onSearchButtonClick,this));this.searchInput=this.context.querySelector("["+this.attributeSearch+"]");BX.bind(this.searchInput,"bxchange",BX.proxy(this.onSearchChange,this));this.adjustHeight()},adjustHeight:function(){var e=document.querySelector(".crm-orderform-edit-constructor-right-list-container");var t=document.querySelector(".crm-orderform-edit-constructor-left-container");if(BX.type.isDomNode(e)&&BX.type.isDomNode(t)){e.style.maxHeight=t.offsetHeight-55+"px"}},showSearchResult:function(e){e=e||"";e=e.toLowerCase();this.fieldNodeList.forEach(function(t){var i=!e?true:t.innerText.toLowerCase().indexOf(e)>-1;this.helper.styleDisplay(t,i,"list-item")},this)},onSearchChange:function(){this.showSearchResult(this.searchInput.value)},onSearchButtonClick:function(){var e=BX.hasClass(this.searchButton,this.classSearchActive);if(e){this.showSearchResult()}else{this.groupNodeList.forEach(function(e){BX.addClass(e,this.classGroupShow)},this);this.showSearchResult(this.searchInput.value)}BX.toggleClass(this.searchButton,this.classSearchActive);this.searchInput.focus()},initGroup:function(e){BX.bind(e.children[0],"click",BX.delegate(function(){BX.toggleClass(e,this.classGroupShow);BX.toggleClass(e,this.classGroupClose);if(BX.hasClass(e,this.classGroupShow)){this.scrollIntoView(e)}},this))},scrollIntoView:function(e){var t=document.querySelector(".crm-orderform-edit-constructor-right-list-container");var i=BX.pos(t);var r=BX.pos(e);var n=r.top-i.top+t.scrollTop;var o=r.bottom-i.top+t.scrollTop;var s={};if(o>t.scrollTop+t.offsetHeight-18){s.start=t.scrollTop;if(r.height>=t.offsetHeight){s.finish=n-5}else{s.finish=o-t.offsetHeight}}if(BX.type.isNotEmptyObject(s)){new BX.easing({duration:300,start:{scroll:s.start},finish:{scroll:s.finish},transition:BX.easing.makeEaseInOut(BX.easing.transitions.quart),step:BX.delegate(function(e){t.scrollTo(0,e.scroll)},this)}).animate()}},initField:function(e){var t=e.getAttribute(this.attributeField);var i=this.caller.fields.filter(function(e){return e.name==t});if(i.length>0){BX.addClass(e,this.classFieldSelected)}BX.bind(e,"click",BX.proxy(this.addFieldByClick,this))},addFieldByClick:function(e){BX.addClass(BX.proxy_context,this.classFieldSelected);this.caller.addFieldByData({name:BX.proxy_context.getAttribute(this.attributeField),preset_id:BX.proxy_context.getAttribute(this.presetAttributeField)});e.preventDefault()},addSpecialFormField:function(e){var t={entity_caption:"-",caption:"",type:e,name:e+"_"+this.helper.generateId()};switch(e){case"product":t.caption=this.caller.mess.newFieldProductsCaption;t.id="n"+this.helper.generateId();break;case"section":t.caption=this.caller.mess.newFieldSectionCaption;break;case"hr":break;case"br":break}t.entity_field_caption=t.caption;return this.caller.addField(t)},changeFieldText:function(e,t){var i=this.getFieldNode(e);if(BX.type.isDomNode(i)){i.innerHTML=t}},onCallerFieldAdd:function(e){var t=this.getFieldNode(e.name);if(t){BX.addClass(t,this.classFieldSelected)}},onCallerFieldDelete:function(e){var t=this.getFieldNode(e.name);if(t){BX.removeClass(t,this.classFieldSelected)}}};function CrmFormEditorDragDrop(e){this.init(e)}CrmFormEditorDragDrop.prototype={addItem:function(e){this.dragdrop.addDragItem([e]);this.dragdrop.addSortableItem(e)},removeItem:function(e){this.dragdrop.removeSortableItem(e)},init:function(e){this.dragdrop=BX.DragDrop.create({sortable:{rootElem:BX("FIELD_CONTAINER"),gagClass:"gag-class"},dragActiveClass:"crm-orderform-field-drag",dragItemClassName:"field-selected",dragStart:BX.delegate(function(e,t,i){if(!t){t=e.dragElement}if(!t){return}},this),dragEnd:BX.delegate(function(e,t,i){BX.onCustomEvent(this,"onSort",[t,e])},this)})}};function CrmFormEditorDependencies(e){e=e||{};e.relations=e.relations||[];this.helper=BX.CrmFormEditorHelper;this.deps=[];this.container=BX("DEPENDENCY_CONTAINER");this.buttonAdd=BX("DEPENDENCY_BUTTON_ADD");this.init(e)}CrmFormEditorDependencies.prototype={add:function(e){var t="n"+this.helper.generateId();var i={ID:t,IF_FIELD_CODE:"",IF_VALUE:"",DO_FIELD_CODE:"",DO_ACTION:""};var r=this.helper.appendNodeByTemplate(this.container,this.caller.templates.dependency,i);this.bind(i);return r},bind:function(e){e.node=BX("DEPENDENCIES_"+e.ID);e.ifValueNodeCtrlS=BX("DEPENDENCIES_"+e.ID+"_IF_VALUE_CTRL_S");e.ifValueNodeCtrlI=BX("DEPENDENCIES_"+e.ID+"_IF_VALUE_CTRL_I");e.ifFieldNodeCtrl=BX("DEPENDENCIES_"+e.ID+"_IF_FIELD_CODE_CTRL");e.doFieldNodeCtrl=BX("DEPENDENCIES_"+e.ID+"_DO_FIELD_CODE_CTRL");e.ifValueNode=BX("DEPENDENCIES_"+e.ID+"_IF_VALUE");e.ifFieldNode=BX("DEPENDENCIES_"+e.ID+"_IF_FIELD_CODE");e.doFieldNode=BX("DEPENDENCIES_"+e.ID+"_DO_FIELD_CODE");e.actionNodeCtrl=BX("DEPENDENCIES_"+e.ID+"_DO_ACTION");e.elseHideTextNode=BX("DEPENDENCIES_"+e.ID+"_ELSE_HIDE");e.elseShowTextNode=BX("DEPENDENCIES_"+e.ID+"_ELSE_SHOW");var t=this;BX.bind(BX("DEPENDENCIES_"+e.ID+"_BTN_REMOVE"),"click",function(){t.remove(e)});BX.bind(e.ifFieldNodeCtrl,"change",function(){if(t.canChangeFields){e.ifFieldNode.value=this.value;t.actualizeFieldValues(e)}});BX.bind(e.doFieldNodeCtrl,"change",function(){if(t.canChangeFields){e.doFieldNode.value=this.value}var i="";if(this.selectedOptions&&this.selectedOptions.length>0){i=this.selectedOptions[0].innerText;i='"'+i+'"'}e.elseShowTextNode.children[0].innerText=i;e.elseHideTextNode.children[0].innerText=i});BX.bind(e.ifValueNodeCtrlS,"change",function(){var t=[];for(var i=0;i<this.options.length;i++){if(this.options[i].selected){t.push(this.options[i].value)}}e.ifValueNode.value=t.join(",")});BX.bind(e.ifValueNodeCtrlI,"change",function(){if(t.canChangeFields){e.ifValueNode.value=this.value}});BX.bind(e.actionNodeCtrl,"change",BX.proxy(function(){var t=e.actionNodeCtrl.value==="HIDE";this.helper.styleDisplay(e.elseHideTextNode,!t);this.helper.styleDisplay(e.elseShowTextNode,t)},this));this.actualize(e);this.deps.push(e)},remove:function(e){BX.remove(e.node);var t=BX.util.array_search(e,this.deps);if(t>-1){delete this.deps[t]}},actualizeFieldList:function(e,t,i){this.canChangeFields=false;var r=["hr","br"];var n=[];var o="";i=i||false;if(i){o=this.caller.mess.selectField;this.caller.fields.forEach(function(e){if(!BX.util.in_array(e.type,r)){var i=e.name_id||e.name||"";n.push({value:i,caption:e.getCaption(),selected:BX.util.in_array(i,t)})}},this)}else{o=this.caller.mess.selectField;this.relationEntities.forEach(function(e){n.push({value:e.CODE,caption:e.NAME,selected:BX.util.in_array(e.CODE,t)})})}n=BX.util.array_merge([{caption:o,value:"",selected:false}],n);this.helper.fillDropDownControl(e,n);this.canChangeFields=true},getRelationItems:function(e){var t=[];for(var i=0;i<this.relationEntities.length;i++){if(this.relationEntities[i].CODE===e){t=this.relationEntities[i].ITEMS;break}}return t},actualizeFieldValues:function(e){this.canChangeFields=false;var t=e.ifFieldNode.value;if(!t)return;var i=true;e.ifValueNodeCtrlI.style.display=i?"none":"";e.ifValueNodeCtrlS.style.display=!i?"none":"";var r=e.ifValueNode.value.split(",");if(i){var n=this.getRelationItems(t);n=n.map(function(e){return{value:e.ID,caption:e.VALUE,selected:BX.util.in_array(e.ID,r)}});this.helper.fillDropDownControl(e.ifValueNodeCtrlS,n)}this.canChangeFields=true},actualizeFieldListConditional:function(e,t){this.actualizeFieldList(e,t,false)},actualizeFieldListOperational:function(e,t){this.actualizeFieldList(e,t,true)},actualize:function(e){var t=e.ifFieldNode.value;var i=e.doFieldNode.value;var r=this.caller.getFieldNameList();if(i&&!BX.util.in_array(i,r)){this.remove(e)}else{this.actualizeFieldListConditional(e.ifFieldNodeCtrl,[t]);this.actualizeFieldValues(e);this.actualizeFieldListOperational(e.doFieldNodeCtrl,[i])}},onChangeFormFields:function(){this.deps.forEach(this.actualize,this)},init:function(e){this.caller=e.caller;this.relationEntities=e.relationEntities||{};this.helper=new CrmFormEditorHelper;this.canChangeFields=true;BX.bind(this.buttonAdd,"click",BX.proxy(this.add,this));e.relations.forEach(this.bind,this);BX.addCustomEvent(this.caller,"change-field-list",BX.proxy(this.onChangeFormFields,this));BX.addCustomEvent(this.caller,"change-field-items",BX.proxy(this.onChangeFormFields,this))}};function CrmFormEditorFieldPreset(e){e=e||{};e.fields=e.fields||[];this.fields=[];this.container=BX("PRESET_FIELD_CONTAINER");this.buttonAdd=BX("PRESET_FIELD_SELECTOR_BTN");this.dealCatrgoryNode=BX("DEAL_CATEGORY");this.init(e)}CrmFormEditorFieldPreset.prototype={isExists:function(e){var t=false;this.fields.forEach(function(i){if(i.CODE==e){t=true}});return t},add:function(e){if(this.isExists(e.CODE)){return null}var t=this.caller.findDictionaryField(e.CODE);if(!t){return null}var i={CODE:t.name,ENTITY_CAPTION:t.entity_caption,ENTITY_FIELD_CAPTION:t.caption,ENTITY_NAME:t.entity_name,ENTITY_FIELD_NAME:t.entity_field_name,VALUE:""};var r=this.helper.appendNodeByTemplate(this.container,this.caller.templates.presetField,i);i.ITEMS=t.items||null;this.bind(i);return r},bind:function(e){e.node=BX("FIELD_PRESET_"+e.CODE);e.valueNodeCtrl=BX("FIELD_PRESET_"+e.CODE+"_VALUE");e.valueNodeCtrlS=BX("FIELD_PRESET_"+e.CODE+"_VALUE_CTRL_S");e.valueNodeCtrlI=BX("FIELD_PRESET_"+e.CODE+"_VALUE_CTRL_I");e.valueNodeCtrlIMacros=BX("FIELD_PRESET_"+e.CODE+"_VALUE_CTRL_I_M");e.valueNodeCtrlIMacrosHint=e.node.querySelector(".crm-orderform-context-help");this.caller.initToolTips([e.valueNodeCtrlIMacrosHint]);var t=this;BX.bind(BX("FIELD_PRESET_"+e.CODE+"_BTN_REMOVE"),"click",function(){t.remove(e)});BX.bind(e.valueNodeCtrlS,"change",function(){if(t.canChangeFields){e.valueNodeCtrl.value=this.value}});BX.bind(e.valueNodeCtrlI,"change",function(){if(t.canChangeFields){e.valueNodeCtrl.value=this.value}});BX.bind(e.valueNodeCtrlIMacros,"click",function(){t.popupMacrosCurrentInput=e.valueNodeCtrlI;t.popupMacros.setBindElement(e.valueNodeCtrlIMacros);t.popupMacros.show()});if(e.CODE=="DEAL_STAGE_ID"&&this.dealCatrgoryNode){BX.bind(this.dealCatrgoryNode,"click",function(){t.actualize(e)})}this.actualize(e);this.fields.push(e);if(this.isFieldTypeList(e)){BX.fireEvent(e.valueNodeCtrlS,"change")}else{BX.fireEvent(e.valueNodeCtrlI,"change")}},remove:function(e){BX.remove(e.node);var t=BX.util.array_search(e,this.fields);if(t>-1){delete this.fields[t]}},isFieldTypeList:function(e){var t=["list","checkbox","radio"];var i=e.CODE;if(!i)return false;var r=this.caller.findDictionaryField(i);if(!r)return false;return BX.util.in_array(r.type,t)},actualize:function(e){this.canChangeFields=false;var t=e.CODE;if(!t)return;var i=this.caller.findDictionaryField(t);if(!i)return;var r=this.isFieldTypeList(e);e.valueNodeCtrlI.style.display=r?"none":"";e.valueNodeCtrlIMacros.style.display=r?"none":"";e.valueNodeCtrlIMacrosHint.style.display=r?"none":"";e.valueNodeCtrlS.style.display=!r?"none":"";var n=[e.valueNodeCtrl.value];if(r){var o;if(!i.items||i.items.length==0){if(i.type=="checkbox"){o=this.caller.booleanFieldItems}}else{o=i.items}if(o){if(t=="DEAL_STAGE_ID"&&this.dealCatrgoryNode){var s=this.dealCatrgoryNode.value;if(s&&i.itemsByCategory&&i.itemsByCategory[s]){o=i.itemsByCategory[s]}}this.helper.fillDropDownControl(e.valueNodeCtrlS,o.map(function(e){return{value:e.ID,caption:e.VALUE,selected:BX.util.in_array(e.ID,n)}}))}}else if(!r){e.valueNodeCtrlI.value=n[0]}this.canChangeFields=true},onChangeEntityScheme:function(e){var t=this.caller.entityScheme.getCurrentWillCreatedEntities();t.push("ACTIVITY");var i=this.fields.filter(function(e){return!BX.util.in_array(e.ENTITY_NAME,t)},this);if(i){i.reverse();i.forEach(function(e){this.remove(e)},this)}var r;var n=BX.convert.nodeListToArray(BX("PRESET_FIELD_SELECTOR").querySelectorAll("optgroup"));n.forEach(function(e){var i=BX.util.in_array(e.getAttribute("data-bx-crm-wf-entity"),t);e.style.display=i?"block":"none";if(!r&&i)r=e.querySelector("option")},this);if(r){r.selected=true}},onButtonAddClick:function(){this.add({CODE:BX("PRESET_FIELD_SELECTOR").value})},init:function(e){this.caller=e.caller;this.helper=new CrmFormEditorHelper;this.canChangeFields=true;BX.bind(this.buttonAdd,"click",BX.proxy(this.onButtonAddClick,this));if(e.fields){e.fields.forEach(this.bind,this)}BX.addCustomEvent(this.caller,"change-entity-scheme",BX.proxy(this.onChangeEntityScheme,this));this.onChangeEntityScheme(this.caller.entityScheme.getCurrent());this.initMacros()},initMacros:function(){this.popupMacrosCurrentInput=null;var e="data-bx-preset-macros";var t=BX("CRM_ORDER_FORM_POPUP_PRESET_MACROS");var i=BX.convert.nodeListToArray(t.querySelectorAll("["+e+"]"));i.forEach(BX.proxy(function(t){BX.bind(t,"click",BX.delegate(function(){if(!this.popupMacrosCurrentInput){return}this.popupMacrosCurrentInput.value+=" "+t.getAttribute(e);BX.fireEvent(this.popupMacrosCurrentInput,"change");this.popupMacros.close()},this))},this));this.popupMacros=BX.PopupWindowManager.create("crm_orderform_edit_preset_macros",null,{content:t,autoHide:true,lightShadow:true,closeByEsc:true})}};function CrmFormEditorUserBlockController(e){this.context=BX("CRM_ORDERFORM_ADDITIONAL_OPTIONS");this.additionalOptionContainer=BX("ADDITIONAL_OPTION_CONTAINER");this.attributeOption="data-bx-crm-orderform-edit-option";this.attributeNav="data-bx-crm-orderform-edit-option-nav";this.attributePin="data-bx-crm-orderform-edit-option-pin";this.userOptionPin=e.optionPinName;this.blocks=[];this.helper=BX.CrmFormEditorHelper;var t=this.context.querySelectorAll("["+this.attributeOption+"]");t=BX.convert.nodeListToArray(t);t.forEach(this.initBlock,this);BX.bind(BX("ADDITIONAL_OPTION_BUTTON"),"click",BX.proxy(function(){BX.toggleClass(this.additionalOptionContainer,"crm-orderform-edit-open")},this))}CrmFormEditorUserBlockController.prototype={initBlock:function(e){var t=e.getAttribute(this.attributeOption);var i=e.querySelector("["+this.attributePin+"]");var r={id:t,node:e,navNode:this.context.querySelector("["+this.attributeNav+'="'+t+'"]'),pinNode:i,isFixed:this.isBlockPinFixed(i)};this.blocks.push(r);var n=this;BX.bind(r.pinNode,"click",function(){n.onClickBlockPin(r)});BX.bind(r.navNode,"click",function(e){BX.PreventDefault(e);n.highLightBlock(r);return true});if(r.id=="ENTITY_SCHEME"){BX.bind(BX("CRM_ORDERFORM_STICKER_ENTITY_SCHEME_NAV"),"click",function(e){BX.PreventDefault(e);n.highLightBlock(r);return true})}},isBlockPinFixed:function(e){return BX.hasClass(e,"task-option-fixed-state")},onClickBlockPin:function(e){e.isFixed=!this.isBlockPinFixed(e.pinNode);this.saveBlockPinState(e.id,e.isFixed);this.helper.changeClass(e.pinNode,"task-option-fixed-state",e.isFixed);this.moveBlock(e);this.helper.changeClass(e.navNode,"crm-orderform-display-none",e.isFixed)},show:function(){BX.addClass(this.additionalOptionContainer,"crm-orderform-edit-open")},hide:function(){BX.removeClass(this.additionalOptionContainer,"crm-orderform-edit-open")},highLightBlock:function(e){this.show();var t="crm-orderform-edit-highlight";BX.addClass(e.node,t);setTimeout(function(){var t=BX.pos(e.node),i=window.scrollY||window.pageYOffset||document.body.scrollTop+(document.documentElement&&document.documentElement.scrollTop||0);new BX.easing({duration:300,start:{scroll:i},finish:{scroll:t.top},transition:BX.easing.makeEaseInOut(BX.easing.transitions.quart),step:BX.delegate(function(e){window.scrollTo(0,e.scroll)},this)}).animate()},50);setTimeout(function(){BX.removeClass(e.node,t)},2e3)},moveBlock:function(e){this.show();BX.addClass(e.node,"crm-orderform-display-none");var t=e.isFixed?BX("FIXED_OPTION_PLACE"):BX("ADDITIONAL_OPTION_PLACE_"+e.id);t.appendChild(e.node);BX.removeClass(e.node,"crm-orderform-display-none")},saveBlockPinState:function(e,t){BX.userOptions.save("crm",this.userOptionPin,e,t?"Y":"N")}};function CrmFormEditorFieldListSettings(e){this.type=e.type;this.context=e.context;this.caller=e.caller;this.field=e.field;this.helper=BX.CrmFormEditorHelper;this.nodeItemsContainer=this.context.querySelector("[data-bx-crm-orderform-field-settings-items]");this.attributeItem="data-bx-crm-orderform-field-settings-item";this.attributeItemCheck="data-bx-crm-orderform-field-settings-item-check";this.attributeItemRadio="data-bx-crm-orderform-field-settings-item-radio";this.attributeItemClear="data-bx-crm-orderform-field-settings-item-clear";this.attributeItemInput="data-bx-crm-orderform-field-settings-item-input";this.init()}CrmFormEditorFieldListSettings.prototype={init:function(){if(!this.nodeItemsContainer){return}var e=this.nodeItemsContainer.querySelectorAll("["+this.attributeItem+"]");e=BX.convert.nodeListToArray(e);e.forEach(function(e){var t=e.querySelector("["+this.attributeItemClear+"]");var i=e.querySelector("["+this.attributeItemInput+"]");var r=e.getAttribute(this.attributeItem);BX.bind(t,"click",function(){i.value="";BX.fireEvent(i,"change")});BX.bind(i,"change",BX.proxy(function(){this.field.items.forEach(function(e){if(e.ID==r){if(e.NAME!==undefined){e.NAME=i.value}else{e.VALUE=i.value}this.caller.fireFieldChangeItemsEvent(this.field)}},this)},this))},this);if(this.type=="checkbox"){this.showControls(this.attributeItemCheck)}else if(this.type=="radio"){this.showControls(this.attributeItemRadio)}},showControls:function(e){var t=this.nodeItemsContainer.querySelectorAll("["+e+"]");t=BX.convert.nodeListToArray(t);t.forEach(function(e){e.disabled=false;this.helper.styleDisplay(e,true)},this)}};function CrmFormEditorProductSelector(e){this.helper=BX.CrmFormEditorHelper;this.caller=e.caller;this.id=e.id;this.field=e.field;this.context=e.context;this.node=this.context.querySelector("[data-bx-crm-orderform-product]");if(!this.node){return}this.nodeItems=this.node.querySelector("[data-bx-crm-orderform-product-items]");this.nodeSelect=this.node.querySelector("[data-bx-crm-orderform-product-select]");this.nodeAddRow=this.node.querySelector("[data-bx-crm-orderform-product-add-row]");this.attributeItem="data-bx-crm-orderform-product-item";this.attributeItemDelete="data-bx-crm-orderform-product-item-del";this.attributeItemInput="data-bx-crm-orderform-product-item-input";this.random=Math.random();this.jsEventsManagerId=e.jsEventsManagerId;this.caller=e.caller;BX.bind(this.nodeSelect,"click",BX.proxy(this.onClick,this));BX.bind(this.nodeAddRow,"click",BX.proxy(this.onClickAddRow,this));this._choiceBtnEnabled=true;BX.addCustomEvent("CrmProductSearchDialog_SelectProduct",BX.proxy(this.onProductClick,this));this.isCallSearchDialog=false;this.initItems()}CrmFormEditorProductSelector.prototype={onShow:function(e){this.isCallSearchDialog=true;this.helper.overlay.removeOverlay();this.caller.popupFieldSettings.setAutoHide(false)},onClose:function(e){this.isCallSearchDialog=false;this._choiceBtnEnabled=true;this.caller.popupFieldSettings.setAutoHide(false)},onClick:function(e){if(!this._choiceBtnEnabled)return;this._choiceBtnEnabled=false;this.helper.overlay.createOverlay(2e3)},onClickAddRow:function(){this.addFieldItem({id:"n"+this.helper.generateId(),name:"",price:""})},initItems:function(){this.field.items.forEach(function(e){var t=this.nodeItems.querySelector("["+this.attributeItem+'="'+e.ID+'"'+"]");if(!t){return}this.initProductItem(t,e)},this)},handleProductChoice:function(e,t){t=!!t;var i=typeof e["product"]!="undefined"&&typeof e["product"][0]!="undefined"?e["product"][0]:null;if(!i){return}var r=typeof i["customData"]!=="undefined"?i["customData"]:{};var n=typeof r["measure"]!=="undefined"?r["measure"]:{};var o={id:i["id"],name:i["title"],quantity:1,price:typeof r["price"]!="undefined"?parseFloat(r["price"]):0,customized:false,measureCode:typeof n["code"]!=="undefined"?parseInt(n["code"]):0,measureName:typeof n["name"]!=="undefined"?n["name"]:"",tax:typeof r["tax"]!=="undefined"?r["tax"]:{}};this.addFieldItem(o)},addFieldItem:function(e){var t=this.helper.getNodeByTemplate("tmpl_field_product_settings_item",{id:this.id,name:this.field.name,item_id:e.id,item_value:e.NAME?e.NAME:e.VALUE,item_price:e.price,currency_short_name:this.caller.currency.SHORT_NAME});var i={ID:e.id,PRICE:e.price,VALUE:e.name};this.initProductItem(t,i);this.field.items.push(i);this.nodeItems.appendChild(t);this.fireFieldItemsChange()},fireFieldItemsChange:function(){this.caller.fireFieldChangeItemsEvent(this.field)},initProductItem:function(e,t){var i=e.getAttribute(this.attributeItem);var r=e.querySelector("["+this.attributeItemDelete+"]");var n=e.querySelector("["+this.attributeItemInput+"]");BX.bind(r,"click",BX.proxy(function(){this.removeProductItem(e,t)},this));BX.bind(n,"change",BX.proxy(function(){this.field.items.forEach(function(e){if(e.ID==i){e.VALUE=n.value;this.caller.fireFieldChangeItemsEvent(this.field)}},this)},this))},removeProductItem:function(e,t){var i=BX.util.array_search(t,this.field.items);if(i>-1){this.field.items=BX.util.deleteFromArray(this.field.items,i)}BX.remove(e);this.fireFieldItemsChange()},onProductClick:function(e){if(!this.isCallSearchDialog){return}e=parseInt(e);if(e<=0){return}var t="";BX.ajax({url:"/bitrix/components/bitrix/crm.product.list/list.ajax.php",method:"POST",dataType:"json",data:{sessid:BX.bitrix_sessid(),MODE:"SEARCH",RESULT_WITH_VALUE:"Y",CURRENCY_ID:t,ENABLE_RAW_PRICES:"Y",ENABLE_SEARCH_BY_ID:"N",MULTI:"N",VALUE:"["+e+"]",LIMIT:1},onsuccess:BX.delegate(this.onProductChoiceByIdSuccess,this),onfailure:BX.delegate(this.onProductChoiceByIdFailure,this)})},onProductChoiceByIdSuccess:function(e){var t;if(e&&e["data"]){t=e["data"];if(t[0]){t={product:[t[0]]};this.handleProductChoice(t,true)}}},onProductChoiceByIdFailure:function(e){}};function CrmFormEditorHelper(){}CrmFormEditorHelper.prototype={generateId:function(e,t){e=e||1e6;t=t||9999999;return Math.floor(Math.random()*(t-e))+e},fillDropDownControl:function(e,t){t=t||[];e.innerHTML="";t.forEach(function(t){if(!t||!t.caption){return}var i=document.createElement("option");i.value=t.value;i.selected=!!t.selected;i.innerText=t.caption;e.appendChild(i)})},appendNodeByTemplate:function(e,t,i){var r=this.getNodeByTemplate(t,i);if(r){var n=false;if(i.sort){var o=e.querySelectorAll("[data-crm-orderform-edit-field-container]");for(var s=0;s<o.length;s++){var a=o[s].querySelector("[data-bx-order-form-field-sort]");if(!BX.type.isDomNode(a)||parseInt(i.sort)<parseInt(a.value)){e.insertBefore(r,o[s]);n=true;break}}}if(!n){e.appendChild(r)}BX.ajax.processScripts(this.getScriptsByTemplate(t,i));if(t==="tmpl_field_location"){if(typeof window.BX.locationsDeferred!="undefined"){for(var l in window.BX.locationsDeferred){if(l!=="%control_id%"){window.BX.locationsDeferred[l].call(this);window.BX.locationsDeferred[l]=null;window.BX.locationSelectors[l].setValueByLocationCode(i.value)}delete window.BX.locationsDeferred[l]}}}}return r},getNodeByTemplate:function(e,t){var i=this.getTemplate(e,t);if(!i){return null}var r=BX.create("div",{html:i});return r.firstElementChild},getScriptsByTemplate:function(e,t){var i=this.getTemplate(e,t);if(!i){return null}return BX.processHTML(i).SCRIPT},getTemplate:function(e,t){var i=BX(e);if(!i){return null}var r=i.innerHTML;if(t){for(var n in t){if(!t.hasOwnProperty(n)&&t[n]===undefined){continue}var o;if(n[0]==="~"){o=t[n];n=n.substr(1)}else{o=BX.util.htmlspecialchars(t[n])}r=r.replace(new RegExp("%"+n+"%","g"),o)}}return r},changeClass:function(e,t,i){i=i||false;if(!e){return}if(i){BX.addClass(e,t)}else{BX.removeClass(e,t)}},styleDisplay:function(e,t,i){t=t||false;i=i||"";if(!e){return}e.style.display=t?i:"none"},overlay:{createOverlay:function(e){e=parseInt(e);if(!this._overlay){var t=BX.GetWindowScrollSize();this._overlay=document.body.appendChild(BX.create("DIV",{style:{position:"absolute",top:"0px",left:"0px",zIndex:e||parseInt(this.DIV.style.zIndex)-2,width:t.scrollWidth+"px",height:t.scrollHeight+"px"}}));BX.unbind(window,"resize",BX.proxy(this._resizeOverlay,this));BX.bind(window,"resize",BX.proxy(this._resizeOverlay,this))}},removeOverlay:function(){if(this._overlay&&this._overlay.parentNode){this._overlay.parentNode.removeChild(this._overlay);BX.unbind(window,"resize",BX.proxy(this._resizeOverlay,this));this._overlay=null}},_resizeOverlay:function(){var e=BX.GetWindowScrollSize();this._overlay.style.width=e.scrollWidth+"px"}}};BX.CrmFormEditorHelper=new CrmFormEditorHelper;if(typeof BX.CrmProductSearchDialogWindow==="undefined"){BX.CrmProductSearchDialogWindow=function(){this._settings={};this.popup=null;this.random="";this.contentContainer=null;this.zIndex=100;this.jsEventsManager=null;this.pos=null;this.height=0;this.width=0;this.resizeCorner=null};BX.CrmProductSearchDialogWindow.prototype={initialize:function(e){this.random=Math.random().toString().substring(2);this._settings=e?e:{};var t=BX.CrmProductSearchDialogWindow.size;this._settings.width=t.width||this._settings.width||1100;this._settings.height=t.height||this._settings.height||530;this._settings.minWidth=this._settings.minWidth||500;this._settings.minHeight=this._settings.minHeight||800;this._settings.draggable=!!this._settings.draggable||true;this._settings.resizable=!!this._settings.resizable||true;if(typeof this._settings.closeWindowHandler!=="function")this._settings.closeWindowHandler=null;if(typeof this._settings.showWindowHandler!=="function")this._settings.showWindowHandler=null;this.jsEventsManager=BX.Crm[this._settings.jsEventsManagerId]||null;this.contentContainer=BX.create("DIV",{attrs:{className:"crm-catalog",style:"display: block; background-color: #f3f6f7; height: "+this._settings.height+"px; overflow: hidden; width: "+this._settings.width+"px;"}})},_handleCloseDialog:function(e){if(e)e.destroy();this.popup=null;if(this.jsEventsManager){this.jsEventsManager.unregisterEventHandlers("CrmProduct_SelectSection")}if(typeof this._settings.closeWindowHandler==="function")this._settings.closeWindowHandler()},_handleAfterShowDialog:function(e){e.popupContainer.style.position="fixed";e.popupContainer.style.top=parseInt(e.popupContainer.style.top)-BX.GetWindowScrollPos().scrollTop+"px";if(typeof this._settings.showWindowHandler==="function")this._settings.showWindowHandler()},setContent:function(e){if(BX.type.isString(e)&&BX.type.isDomNode(this.contentContainer))this.contentContainer.innerHTML=e},show:function(){BX.ajax({method:"GET",dataType:"html",url:this._settings.content_url,data:{},skipAuthCheck:true,onsuccess:BX.delegate(function(e){this.setContent(e||"&nbsp;");this.showWindow()},this),onfailure:BX.delegate(function(){if(typeof this._settings.showWindowHandler==="function")this._settings.showWindowHandler()},this)})},showWindow:function(){this.popup=new BX.PopupWindow("CrmProductSearchDialogWindow_"+this.random,null,{overlay:{opacity:82},autoHide:false,draggable:this._settings.draggable,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},bindOnResize:false,zIndex:this.zIndex-300,closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:{content:BX.create("SPAN",{attrs:{className:"popup-window-titlebar-text"},text:BX.message("CRM_ORDERFORM_EDIT_JS_PRODUCT_CHOICE")})},events:{onPopupClose:BX.delegate(this._handleCloseDialog,this),onAfterPopupShow:BX.delegate(this._handleAfterShowDialog,this)},content:this.contentContainer});if(this.popup.popupContainer){this.resizeCorner=BX.create("SPAN",{attrs:{className:"bx-crm-dialog-resize"},events:{mousedown:BX.delegate(this.resizeWindowStart,this)}});this.popup.popupContainer.appendChild(this.resizeCorner);if(!this._settings.resizable)this.resizeCorner.style.display="none"}this.popup.show()},setResizable:function(e){e=!!e;if(this._settings.resizable!==e){this._settings.resizable=e;if(this.resizeCorner){if(e)this.resizeCorner.style.display="inline-block";else this.resizeCorner.style.display="none"}}},resizeWindowStart:function(e){if(!this._settings.resizable)return;e=e||window.event;BX.PreventDefault(e);this.pos=BX.pos(this.contentContainer);BX.bind(document,"mousemove",BX.proxy(this.resizeWindowMove,this));BX.bind(document,"mouseup",BX.proxy(this.resizeWindowStop,this));if(document.body.setCapture)document.body.setCapture();try{document.onmousedown=false}catch(e){}try{document.body.onselectstart=false}catch(e){}try{document.body.ondragstart=false}catch(e){}try{document.body.style.MozUserSelect="none"}catch(e){}try{document.body.style.cursor="nwse-resize"}catch(e){}},resizeWindowMove:function(e){var t=BX.GetWindowScrollPos();var i=e.clientX+t.scrollLeft;var r=e.clientY+t.scrollTop;BX.CrmProductSearchDialogWindow.size.height=this.height=Math.max(r-this.pos.top,this._settings.minHeight);BX.CrmProductSearchDialogWindow.size.width=this.width=Math.max(i-this.pos.left,this._settings.minWidth);this.contentContainer.style.height=this.height+"px";this.contentContainer.style.width=this.width+"px"},resizeWindowStop:function(e){if(document.body.releaseCapture)document.body.releaseCapture();BX.unbind(document,"mousemove",BX.proxy(this.resizeWindowMove,this));BX.unbind(document,"mouseup",BX.proxy(this.resizeWindowStop,this));try{document.onmousedown=null}catch(e){}try{document.body.onselectstart=null}catch(e){}try{document.body.ondragstart=null}catch(e){}try{document.body.style.MozUserSelect=""}catch(e){}try{document.body.style.cursor="auto"}catch(e){}}};BX.CrmProductSearchDialogWindow.create=function(e){var t=new BX.CrmProductSearchDialogWindow;t.initialize(e);return t};BX.CrmProductSearchDialogWindow.loadCSS=function(e){BX.ajax({method:"GET",dataType:"html",url:e.content_url,data:{},skipAuthCheck:true})};BX.CrmProductSearchDialogWindow.size={width:0,height:0}}BX.namespace("BX.Crm");if(typeof BX.Crm.PageEventsManagerClass==="undefined"){BX.Crm.PageEventsManagerClass=function(){this._settings={}};BX.Crm.PageEventsManagerClass.prototype={initialize:function(e){this._settings=e?e:{};this.eventHandlers={}},registerEventHandler:function(e,t){if(!this.eventHandlers[e])this.eventHandlers[e]=[];this.eventHandlers[e].push(t);BX.addCustomEvent(this,e,t)},fireEvent:function(e,t){BX.onCustomEvent(this,e,t)},unregisterEventHandlers:function(e){if(this.eventHandlers[e]){for(var t=0;t<this.eventHandlers[e].length;t++){BX.removeCustomEvent(this,e,this.eventHandlers[e][t]);delete this.eventHandlers[e][t]}}}};BX.Crm.PageEventsManagerClass.create=function(e){var t=new BX.Crm.PageEventsManagerClass;t.initialize(e);return t}}function CrmFormEditorDestination(e){var t=this;this.caller=e.caller;var i=e.container;var r,n=i.getAttribute("data-config");if(n){r=BX.parseJSON(n)}if(!BX.type.isPlainObject(r))r={};this.container=i;this.itemsNode=BX.create("span");this.inputBoxNode=BX.create("span",{attrs:{className:"feed-add-destination-input-box",style:"display: none;"}});this.inputNode=BX.create("input",{props:{type:"text"},attrs:{className:"feed-add-destination-inp"}});this.inputBoxNode.appendChild(this.inputNode);this.tagNode=BX.create("a",{attrs:{className:"feed-add-destination-link"}});BX.addClass(i,"crm-orderform-popup-autocomplete");i.appendChild(this.itemsNode);i.appendChild(this.inputBoxNode);i.appendChild(this.tagNode);this.itemTpl=r.itemTpl;this.data=null;this.dialogId="crm_orderform_edit_responsible_";this.createValueNode(r.valueInputName||"");this.selected=r.selected?BX.clone(r.selected):[];this.selectOne=!r.multiple;this.required=r.required||false;this.additionalFields=BX.type.isArray(r.additionalFields)?r.additionalFields:[];BX.bind(this.tagNode,"focus",function(e){t.openDialog({bByFocusEvent:true});return BX.PreventDefault(e)});BX.bind(this.container,"click",function(e){t.openDialog();return BX.PreventDefault(e)});this.addItems(this.selected);this.tagNode.innerHTML=this.selected.length<=0?this.caller.mess.dlgChoose:this.caller.mess.dlgChange}CrmFormEditorDestination.prototype={getData:function(e){var t=this;if(t.ajaxProgress)return;t.ajaxProgress=true;this.caller.sendActionRequest("getDestinationDataAjax",{},function(i){t.data=i.DATA||{};t.ajaxProgress=false;t.initDialog(e)},function(){})},initDialog:function(e){var t,i=this,r=this.data;if(!r){i.getData(e);return}var n={};for(t=0;t<i.selected.length;++t){n[i.selected[t].id]=i.selected[t].entityType}var o={users:r.USERS||{},department:r.DEPARTMENT||{},departmentRelation:r.DEPARTMENT_RELATION||{},bpuserroles:r.ROLES||{}};var s={users:r.LAST.USERS||{},bpuserroles:r.LAST.ROLES||{}};for(t=0;t<this.additionalFields.length;++t){o.bpuserroles[this.additionalFields[t]["id"]]=this.additionalFields[t]}if(!o["departmentRelation"]){o["departmentRelation"]=BX.SocNetLogDestination.buildDepartmentRelation(o["department"])}if(!i.inited){i.inited=true;var a=i.inputNode;a.id=i.dialogId+"input";var l=i.inputBoxNode;l.id=i.dialogId+"input-box";var d=this.tagNode;d.id=this.dialogId+"tag";var c=i.itemsNode;BX.SocNetLogDestination.init({name:i.dialogId,searchInput:a,extranetUser:false,bindMainPopup:{node:i.container,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:i.container,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:true,sendAjaxSearch:true,callback:{select:function(e,t,r,n){i.addItem(e,t);if(i.selectOne)BX.SocNetLogDestination.closeDialog()},unSelect:function(e){if(i.selectOne)return;i.unsetValue(e.entityId);BX.SocNetLogDestination.BXfpUnSelectCallback.call({formName:i.dialogId,inputContainerName:c,inputName:a.id,tagInputName:d.id,tagLink1:i.caller.mess.dlgChoose,tagLink2:i.caller.mess.dlgChange},e)},openDialog:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:l.id,inputName:a.id,tagInputName:d.id}),closeDialog:BX.delegate(BX.SocNetLogDestination.BXfpCloseDialogCallback,{inputBoxName:l.id,inputName:a.id,tagInputName:d.id}),openSearch:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:l.id,inputName:a.id,tagInputName:d.id}),closeSearch:BX.delegate(BX.SocNetLogDestination.BXfpCloseSearchCallback,{inputBoxName:l.id,inputName:a.id,tagInputName:d.id})},items:o,itemsLast:s,itemsSelected:n,useClientDatabase:false,destSort:r.DEST_SORT||{},allowAddUser:false});BX.bind(a,"keyup",BX.delegate(BX.SocNetLogDestination.BXfpSearch,{formName:i.dialogId,inputName:a.id,tagInputName:d.id}));BX.bind(a,"keydown",BX.delegate(BX.SocNetLogDestination.BXfpSearchBefore,{formName:i.dialogId,inputName:a.id}));BX.SocNetLogDestination.BXfpSetLinkName({formName:i.dialogId,tagInputName:d.id,tagLink1:i.caller.mess.dlgChoose,tagLink2:i.caller.mess.dlgChange})}e()},addItem:function(e,t){var i=this;var r=this.inputNode;var n=this.tagNode;var o=this.itemsNode;if(!BX.findChild(o,{attr:{"data-id":e.id}},false,false)){if(i.selectOne&&i.inited){var s=[];for(var a=0;a<o.childNodes.length;++a){s.push({itemId:o.childNodes[a].getAttribute("data-id"),itemType:o.childNodes[a].getAttribute("data-type")})}i.initDialog(function(){for(var e=0;e<s.length;++e){BX.SocNetLogDestination.deleteItem(s[e].itemId,s[e].itemType,i.dialogId)}});BX.cleanNode(o);i.cleanValue()}var l=this.createItemNode({text:e.name,deleteEvents:{click:function(r){if(i.selectOne&&i.required){i.openDialog()}else{i.initDialog(function(){BX.SocNetLogDestination.deleteItem(e.id,t,i.dialogId);BX.remove(l);i.unsetValue(e.entityId)})}BX.PreventDefault(r)}}});this.setValue(e.entityId);l.setAttribute("data-id",e.id);l.setAttribute("data-type",t);o.appendChild(l);if(!e.entityType)e.entityType=t}r.value="";n.innerHTML=this.caller.mess.dlgChange},addItems:function(e){for(var t=0;t<e.length;++t){this.addItem(e[t],e[t].entityType)}},openDialog:function(e){var t=this;this.initDialog(function(){BX.SocNetLogDestination.openDialog(t.dialogId,e)})},destroy:function(){if(this.inited){if(BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.closeDialog()}BX.SocNetLogDestination.closeSearch()}},createItemNode:function(e){return BX.create("span",{attrs:{className:"crm-orderform-popup-autocomplete-item"},children:[BX.create("span",{attrs:{className:"crm-orderform-popup-autocomplete-name"},html:e.text||""}),BX.create("span",{attrs:{className:"crm-orderform-popup-autocomplete-delete"},events:e.deleteEvents})]})},createValueNode:function(e){this.valueNode=BX.create("input",{props:{type:"hidden",name:e}});this.container.appendChild(this.valueNode)},setValue:function(e){if(/^\d+$/.test(e)!==true)return;if(this.selectOne)this.valueNode.value=e;else{var t,i=[],r=this.valueNode.value.split(",");for(t=0;t<r.length;++t){if(!r[t]||e==r[t])continue;i.push(r[t])}i.push(e);this.valueNode.value=i.join(",")}},unsetValue:function(e){if(/^\d+$/.test(e)!==true)return;if(this.selectOne)this.valueNode.value="";else{var t,i=[],r=this.valueNode.value.split(",");for(t=0;t<r.length;++t){if(!r[t]||e==r[t])continue;i.push(r[t])}this.valueNode.value=i.join(",")}},cleanValue:function(){this.valueNode.value=""}};function CrmFormAdsForm(e){this.caller=e.caller;this.container=e.container;this.init()}CrmFormAdsForm.prototype={init:function(e){if(!this.container||!this.caller.id){return}this.attributeButton="data-bx-ads-button";var t=this.container.querySelectorAll("["+this.attributeButton+"]");t=BX.convert.nodeListToArray(t);t.forEach(function(e){var t=e.getAttribute(this.attributeButton);BX.bind(e,"click",BX.proxy(function(){this.showAdsSend(t,e.textContent)},this))},this);this.adsPopup=null},showAdsSend:function(e,t){var i=this.createAdsPopup({title:t});var r=i.contentContainer.querySelector("[data-bx-ads-content]");var n=i.contentContainer.querySelector("[data-bx-ads-loader]");r.innerHTML="";n.style.display="";i.show();var o=this;this.caller.sendActionRequest("showAdsSend",{formId:this.caller.id,containerNodeId:r.id,adsType:e},function(e){var t=BX.processHTML(e.html);var i=o.createAdsPopup();r.innerHTML=t.HTML;t.SCRIPT.forEach(function(e){if(e.isInternal){BX.evalGlobal(e.JS)}});n.style.display="none";i.show()},function(e){n.style.display="none";this.showErrorPopup(e)})},createAdsPopup:function(e){if(this.adsPopup){return this.adsPopup}var t=BX("crm-orderform-list-template-ads-popup");e=e||{};this.scriptPopup=BX.PopupWindowManager.create("crm_orderform_list_ads_popup",null,{titleBar:e.title||this.caller.mess.dlgTitle,contentColor:"white",content:t.innerHTML,width:620,closeIcon:true,autoHide:true,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500}});var i=[];i.push(new BX.PopupWindowButton({text:this.caller.mess.dlgClose,events:{click:function(){this.popupWindow.close()}}}));this.scriptPopup.setButtons(i);return this.scriptPopup}};
//# sourceMappingURL=script.map.js