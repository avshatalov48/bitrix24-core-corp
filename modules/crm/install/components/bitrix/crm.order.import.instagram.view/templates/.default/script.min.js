+BX.namespace("BX.Crm.Instagram.TileGrid");BX.Crm.Instagram.Status={INITIAL:1,PROCESS:2,STOPPED:3,FINISHED:4,BEFORE_RENDERED:5,AFTER_RENDERED:6};BX.Crm.Instagram.TileGrid.List=function(t){this.params=t.params;this.signedParameters=t.signedParameters;this.componentName=t.componentName;this.lastViewedTimestamp=t.lastViewedTimestamp;this.haveItemsToImport=t.haveItemsToImport;this.filterId=t.filterId;this.gridId=t.gridId;this.grid=BX.Main.tileGridManager.getById(this.gridId).instance;BX.removeClass(this.grid.renderTo,"disk-tile-grid");BX.addClass(this.grid.renderTo,"crm-order-instagram-grid");this.grid.setMultiSelectMode();this.state=BX.Crm.Instagram.Status.INITIAL;this.totalImportedProducts=0;this.progressBarAnimation=null;this.progressBarLastStep=null;this.drawFooter();this.drawStoreFooter();this.drawStepImportFooter();this.handleDescription();this.handleSelectControls();this.handleFooter();this.bindCustomEvents()};BX.Crm.Instagram.TileGrid.List.prototype={handleDescription:function(){if(this.state>=BX.Crm.Instagram.Status.FINISHED){this.showImportedDescription()}else if(this.haveItemsToImport){this.showDescription(BX.message("CRM_OIIV_SELECT_MEDIA"))}else{this.showDescription(BX.message("CRM_OIIV_SELECT_NO_MEDIA"))}},showImportedDescription:function(){var t=document.querySelector('[data-entity="parent-container"]');if(BX.type.isDomNode(t)){BX.addClass(t,"crm-order-instagram-view-imported");var e=t.querySelector('[data-entity="step-description-text"]');if(BX.type.isDomNode(e)){e.textContent=BX.message("CRM_OIIV_STEP_IMPORTED")+": "+this.grid.items.length}e=t.querySelector('[data-entity="total-description-text"]');if(BX.type.isDomNode(e)){e.textContent=BX.message("CRM_OIIV_TOTAL_IMPORTED")+": "+this.totalImportedProducts}}},showDescription:function(t){var e=document.querySelector('[data-entity="parent-container"]');if(BX.type.isDomNode(e)){BX.removeClass(e,"crm-order-instagram-view-imported");var i=e.querySelector('[data-entity="step-description-text"]');if(BX.type.isDomNode(i)){i.textContent=t}i=e.querySelector('[data-entity="total-description-text"]');if(BX.type.isDomNode(i)){i.textContent=""}}},handleSelectControls:function(){if(this.state===BX.Crm.Instagram.Status.INITIAL&&this.grid.items.length&&this.hasItemsToImport()){this.showSelectorControls()}else{this.hideSelectorControls()}},hasItemsToImport:function(){return this.grid.items.some(function(t){return!t.imported})},getLinkWithLastViewedTimestamp:function(t){return BX.util.add_url_param(t,{last_viewed_timestamp:this.lastViewedTimestamp,show_new:"n"})},handleBeforeGridRequest:function(t,e){if(this.gridId!==e.gridId){return}if(e.url){e.url=this.getLinkWithLastViewedTimestamp(e.url)}},handleBeforeRedraw:function(){this.grid.items.forEach(function(t){BX.remove(t.layout.container)},this)},handleFooter:function(){if(this.state===BX.Crm.Instagram.Status.PROCESS){BX.removeClass(this.footer,"crm-section-control-active");BX.removeClass(this.storeFooter,"crm-section-control-active");BX.addClass(this.stepImportFooter,"crm-section-control-active")}else if(this.state===BX.Crm.Instagram.Status.STOPPED){BX.removeClass(this.footer,"crm-section-control-active");BX.removeClass(this.storeFooter,"crm-section-control-active");BX.removeClass(this.stepImportFooter,"crm-section-control-active")}else if(this.state!==BX.Crm.Instagram.Status.FINISHED){if(this.state>=BX.Crm.Instagram.Status.BEFORE_RENDERED||this.getCheckedItems().length===0){BX.removeClass(this.footer,"crm-section-control-active");BX.removeClass(this.stepImportFooter,"crm-section-control-active");BX.addClass(this.storeFooter,"crm-section-control-active")}else{BX.removeClass(this.storeFooter,"crm-section-control-active");BX.removeClass(this.stepImportFooter,"crm-section-control-active");BX.addClass(this.footer,"crm-section-control-active")}}},bindCustomEvents:function(){BX.bind(document.querySelector('[data-entity="tile-grid-import-more"]'),"click",this.handleImportMore.bind(this));BX.bind(document.querySelector('[data-entity="tile-grid-select-all"]'),"click",this.handleCheckAllItems.bind(this));BX.bind(document.querySelector('[data-entity="tile-grid-unselect-all"]'),"click",this.handleUnCheckAllItems.bind(this));BX.addCustomEvent("BX.TileGrid.Grid:beforeReload",this.handleBeforeGridRequest.bind(this));BX.addCustomEvent("BX.TileGrid.Grid:beforeRedraw",this.handleBeforeRedraw.bind(this));BX.addCustomEvent("BX.TileGrid.Grid:checkItem",this.handleFooter.bind(this));BX.addCustomEvent("BX.TileGrid.Grid:unCheckItem",this.handleFooter.bind(this));BX.addCustomEvent("BX.TileGrid.Grid:afterResetSelectAllItems",this.handleFooter.bind(this));BX.addCustomEvent("BX.TileGrid.Grid:multiSelectModeOff",this.handleMultiSelectModeOff.bind(this));BX.addCustomEvent("BX.TileGrid.Grid:selectItem",this.handleUnselectItem.bind(this));BX.addCustomEvent("BX.TileGrid.Grid:checkItem",this.handleCheckItem.bind(this));BX.addCustomEvent("SidePanel.Slider:onClose",this.handleSliderClose.bind(this));BX.addCustomEvent("BX.Main.Filter:beforeApply",this.onBeforeFilterApply.bind(this));BX.addCustomEvent("BX.Main.Filter:apply",this.onFilterApply.bind(this))},handleCheckItem:function(t){if(this.state===BX.Crm.Instagram.Status.INITIAL&&t.imported){this.grid.unCheckItem(t)}},handleUnselectItem:function(t){if(this.state===BX.Crm.Instagram.Status.INITIAL&&t.imported){this.grid.unSelectItem(t)}},handleImportMore:function(t){this.addLoader();document.location.href=this.getLinkWithLastViewedTimestamp(document.location.href);t.preventDefault()},handleCheckAllItems:function(t){this.grid.selectAllItems();t.preventDefault()},handleUnCheckAllItems:function(t){this.uncheckAllItems();t.preventDefault()},handleMultiSelectModeOff:function(){this.grid.setMultiSelectMode()},handleSliderClose:function(){if(this.state>BX.Crm.Instagram.Status.INITIAL){var t=this.getCatalogGridInstance();if(t){t.reloadTable("POST")}}},onBeforeFilterApply:function(t,e,i,r){if(t!==this.filterId){return}r.then(function(){this.fade()}.bind(this))},onFilterApply:function(t,e,i,r,n){if(t!==this.filterId){return}r.then(function(){return this.grid.reload()}.bind(this)).then(function(){this.handleSelectControls();this.unFade()}.bind(this))},fade:function(){this.grid.setFadeContainer();this.grid.getLoader();this.grid.showLoader()},unFade:function(){this.grid.getLoader().hide();this.grid.unSetFadeContainer()},importButtonHandler:function(t){var e=[];this.getCheckedItems().forEach(function(t){e.push(t.getRawData(true))});if(e.length){Promise.resolve().then(function(){this.state=BX.Crm.Instagram.Status.PROCESS;this.lockActionButton(BX.getEventTarget(t))}.bind(this)).then(this.startImport()).then(this.import(e)).then(this.finishImport()).then(function(){this.state=BX.Crm.Instagram.Status.AFTER_RENDERED;this.unlockActionButton(BX.getEventTarget(t))}.bind(this)).catch(function(t){if(this.state!==BX.Crm.Instagram.Status.STOPPED){this.failProgressBar();this.disableDotAnimation();this.disableActionButton();this.showStepImportTitle(BX.message("CRM_OIIV_STEP_STOPPED_TITLE"));this.unlockActionButton();this.handleFooter();this.showImportMoreButton()}this.fillErrors(t)}.bind(this))}},startImport:function(){return function(){this.importedItems={};this.showStepImport();this.handleFooter()}.bind(this)},import:function(t){return function(){var e=Promise.resolve();var i=[];var r=[].concat(t);while(r.length){i.push(r.splice(0,this.params.IMPORT_MEDIA_STEP))}i.forEach(function(r,n){e=e.then(function(){if(this.state===BX.Crm.Instagram.Status.STOPPED){return Promise.reject()}this.animateProgressBar(n+1,i.length,r.length);var e=n+1===i.length;if(e){this.disableActionButton()}return this.requestImportChunk(r,e,t.length)}.bind(this)).then(function(t){BX.merge(this.importedItems,t.addedItems);if(BX.type.isNumber(t.total)){this.totalImportedProducts=parseInt(t.total)}}.bind(this)).catch(function(t){return Promise.reject(t)}.bind(this))}.bind(this));return e}.bind(this)},finishImport:function(){return function(){return Promise.resolve().then(function(){this.state=BX.Crm.Instagram.Status.FINISHED}.bind(this)).then(this.processSuccessImport()).then(this.delay(1500)).then(function(){this.state=BX.Crm.Instagram.Status.BEFORE_RENDERED;this.handleActiveContainer();this.showImportMoreButton();this.handleFooter();this.makeImportNotification();this.clearErrors();this.setGridFilter()}.bind(this))}.bind(this)},requestImportChunk:function(t,e,i){return new Promise(function(r,n){BX.ajax.runComponentAction(this.componentName,"importAjax",{mode:"class",signedParameters:this.signedParameters,data:{analyticsLabel:{source:"InstagramStore",entity:"Import",action:"requestImportChunk"},items:t,totalCount:i,total:e?"Y":"N"}}).then(function(t){r(t.data)}.bind(this)).catch(function(t){n(BX.util.array_values(t.errors))}.bind(this))}.bind(this))},addLoader:function(){if(!this.loaderNode){this.loaderNode=BX.create("div",{props:{className:"side-panel-overlay side-panel-overlay-open",style:"position: fixed; background-color: rgba(255, 255, 255, .7);"},children:[BX.create("div",{props:{className:"side-panel-default-loader-container"},html:'<svg class="side-panel-default-loader-circular" viewBox="25 25 50 50">'+"<circle "+'class="side-panel-default-loader-path" '+'cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"'+"/>"+"</svg>"})]});document.body.appendChild(this.loaderNode)}},removeLoader:function(){this.loaderNode.parentNode.removeChild(this.loaderNode)},processSuccessImport:function(){return function(){this.finishProgressBar();this.hideFilter();BX.addClass(this.grid.renderTo,"crm-order-instagram-grid-imported");this.grid.redraw(this.filterImportedItems(this.importedItems));this.handleDescription();this.handleSelectControls()}.bind(this)},filterImportedItems:function(t){return this.grid.items.filter(function(e){if(t.hasOwnProperty(e.id)){e.setProductId(t[e.id]);e.setEditable(true);return true}return false})},getCatalogGridInstance:function(){if(window.top.BX.Main.gridManager){var t=window.top.BX.Main.gridManager.data.filter(function(t){return t.id.indexOf("tbl_product_admin")===0});if(t[0]&&t[0].hasOwnProperty("instance")){return t[0].instance}}return false},getCatalogFilterInstance:function(){if(window.top.BX.Main.filterManager){for(var t in window.top.BX.Main.filterManager.data){if(window.top.BX.Main.filterManager.data.hasOwnProperty(t)&&t.indexOf("tbl_product_admin")===0){return window.top.BX.Main.filterManager.data[t]}}}return false},setGridFilter:function(){if(!this.params.IFRAME)return;var t=this.getCatalogGridInstance();if(t.filterApplied)return;var e=this.getCatalogFilterInstance();if(e&&!e.filterApplied){e.getSearch().clearInput();e.getPreset().applyPreset("import_instagram");e.applyFilter();t.filterApplied=true}},makeImportNotification:function(){window.top.BX.UI.Notification.Center.notify({content:BX.message("CRM_OIIV_PRODUCTS_ADDED_SUCCESSFUL"),category:"InstagramStore::general",width:"auto"})},fillErrors:function(t){if(!t||!BX.type.isArray(t))return;var e=document.querySelector("div.crm-section-control-active div.crm-entity-section-control-error-block");if(BX.type.isDomNode(e)){var i="";t.forEach(function(t){if(t.code==="NETWORK_ERROR"){t.message=BX.message("CRM_OIIV_IMPORT_NETWORK_ERROR")}i+='<div class="crm-entity-section-control-error-text">'+t.message+"</div>"});e.innerHTML=i}},clearErrors:function(){BX.cleanNode(BX("bx-crm-error"))},unlockActionButton:function(t){t=t||document.querySelector("div.crm-section-control-active .ui-btn-clock");if(BX.type.isDomNode(t)){BX.removeClass(t,"ui-btn-clock")}},lockActionButton:function(t){t=t||document.querySelector("div.crm-section-control-active .ui-btn-clock");if(BX.type.isDomNode(t)){BX.addClass(t,"ui-btn-clock")}},disableActionButton:function(t){t=t||document.querySelector("div.crm-section-control-active .ui-btn-success");if(BX.type.isDomNode(t)){BX.addClass(t,"ui-btn-disabled")}},showStepImport:function(){this.handleActiveContainer();this.showProgressBar();this.enableDotAnimation()},handleActiveContainer:function(){if(this.state===BX.Crm.Instagram.Status.PROCESS){BX.show(document.querySelector('[data-entity="import-step-process"]'));BX.hide(document.querySelector('[data-entity="import-selector"]'))}else{BX.show(document.querySelector('[data-entity="import-selector"]'));BX.hide(document.querySelector('[data-entity="import-step-process"]'))}},delay:function(t){t=BX.type.isNumber(t)?t:0;return function(){return new Promise(function(e){setTimeout(e,t)})}},showProgressBar:function(){this.progressBar=new BX.UI.ProgressBar({maxValue:100,value:0,column:true,statusType:BX.UI.ProgressBar.Status.PERCENT});BX.addClass(this.progressBar.getContainer(),"crm-order-instagram-view-block-progressbar");document.querySelector('[data-entity="progress-bar"]').appendChild(this.progressBar.getContainer())},animateProgressBar:function(t,e,i){if(this.progressBarAnimation===null){this.progressBarAnimation=new BX.easing({transition:BX.easing.makeEaseInOut(BX.easing.transitions.linear),step:function(t){this.progressBar.update(t.value)}.bind(this)})}this.progressBarAnimation.stop();this.progressBarAnimation.options.duration=this.getProgressBarStepDuration(i);this.progressBarAnimation.options.start={value:this.progressBar.getValue()};this.progressBarAnimation.options.finish={value:t/e*100};this.progressBarAnimation.animate()},finishProgressBar:function(){if(this.progressBarAnimation){this.progressBarAnimation.stop();this.progressBarAnimation.options.duration=500;this.progressBarAnimation.options.start={value:this.progressBar.getValue()};this.progressBarAnimation.options.finish={value:this.progressBar.getMaxValue()};this.progressBarAnimation.options.complete=function(){this.showStepImportTitle(BX.message("CRM_OIIV_STEP_READY_TITLE"));this.disableDotAnimation()}.bind(this);this.progressBarAnimation.animate()}},failProgressBar:function(){if(this.progressBarAnimation){this.progressBarAnimation.stop();this.progressBar.setColor(BX.UI.ProgressBar.Color.DANGER)}},getProgressBarStepDuration:function(t){var e;if(BX.type.isNumber(this.progressBarLastStep)){e=Date.now()-this.progressBarLastStep}else{e=15e3}e=e*t/this.params.IMPORT_MEDIA_STEP;this.progressBarLastStep=Date.now();return e},showStepImportTitle:function(t){var e=document.querySelector('[data-entity="step-import-title"]');if(BX.type.isDomNode(e)){e.textContent=t||""}},enableDotAnimation:function(){this.importAnimation=setInterval(function(){var t=document.querySelector('[data-entity="step-import-pointer"]');if(BX.type.isDomNode(t)){if(t.textContent[t.textContent.length-1]==="."){t.textContent=String.fromCharCode(160)+String.fromCharCode(160)+String.fromCharCode(160)}for(var e=0;e<t.textContent.length;e++){if(t.textContent[e]===String.fromCharCode(160)){t.textContent=t.textContent.substr(0,e)+"."+t.textContent.substr(e+1);break}}}},1e3)},disableDotAnimation:function(){clearTimeout(this.importAnimation);var t=document.querySelector('[data-entity="step-import-pointer"]');if(BX.type.isDomNode(t)){t.textContent=""}},uncheckAllItems:function(){this.grid.items.forEach(function(t){this.grid.unSelectItem(t);this.grid.unCheckItem(t)},this)},cancelBtnHandler:function(t){this.uncheckAllItems()},getTemplatePreviewInstance:function(){var t;var e=window.top.BX.SidePanel.Instance.getOpenSliders();for(var i=0;i<e.length;i++){t=e[i].getWindow();if(t.BX.Landing&&t.BX.Landing.TemplatePreviewInstance){return t.BX.Landing.TemplatePreviewInstance}}return null},createStoreBtnHandler:function(t){var e=this.getTemplatePreviewInstance();if(e){BX.addClass(e.createByImportButton,"ui-btn-wait");e.onCreateButtonClick(t);window.top.BX.SidePanel.Instance.getTopSlider().close()}},closeBtnHandler:function(t){this.cancelBtnHandler(t);window.top.BX.SidePanel.Instance.getTopSlider().close()},cancelStepImport:function(t){if(this.state===BX.Crm.Instagram.Status.STOPPED)return;if(BX.hasClass(BX.getEventTarget(t),"ui-btn-disabled"))return;this.state=BX.Crm.Instagram.Status.STOPPED;this.failProgressBar();this.showStepImportTitle(BX.message("CRM_OIIV_STEP_STOPPED_TITLE"));this.disableDotAnimation();this.unlockActionButton();this.showImportMoreButton();this.handleFooter()},getCheckedItems:function(){return this.grid.items.filter(function(t){return t.checked})},showImportMoreButton:function(){BX.show(document.querySelector('[data-entity="tile-grid-import-more"]'))},hideFilter:function(){BX.hide(document.querySelector('[data-entity="filter"]'))},hideSelectorControls:function(){BX.hide(document.querySelector('[data-entity="select-controls"]'))},showSelectorControls:function(){BX.show(document.querySelector('[data-entity="select-controls"]'))},drawFooter:function(){this.footer=BX.create("div",{props:{className:"crm-entity-wrap"},children:[BX.create("div",{props:{className:"crm-entity-section crm-entity-section-control"},children:[BX.create("button",{props:{className:"ui-btn ui-btn-success"},text:BX.message("CRM_OIIV_IMPORT"),events:{click:this.importButtonHandler.bind(this)}}),BX.create("button",{props:{className:"ui-btn ui-btn-link"},text:BX.message("CRM_OIIV_CANCEL"),events:{click:this.cancelBtnHandler.bind(this)}}),BX.create("div",{props:{className:"crm-entity-section-control-error-block"}})]})]});document.querySelector('[data-entity="footer"]').appendChild(this.footer)},canCreateStore:function(){return this.getTemplatePreviewInstance()!==null},drawStoreFooter:function(){if(!this.canCreateStore())return;this.storeFooter=BX.create("div",{props:{className:"crm-entity-wrap"},children:[BX.create("div",{props:{className:"crm-entity-section crm-entity-section-control"},children:[BX.create("button",{props:{className:"ui-btn ui-btn-success"},text:BX.message("CRM_OIIV_CREATE_STORE"),events:{click:this.createStoreBtnHandler.bind(this)}}),BX.create("button",{props:{className:"ui-btn ui-btn-link"},text:BX.message("CRM_OIIV_CANCEL"),events:{click:this.closeBtnHandler.bind(this)}}),BX.create("div",{props:{className:"crm-entity-section-control-error-block"}})]})]});document.querySelector('[data-entity="store-footer"]').appendChild(this.storeFooter)},drawStepImportFooter:function(){this.stepImportFooter=BX.create("div",{props:{className:"crm-entity-wrap"},children:[BX.create("div",{props:{className:"crm-entity-section crm-entity-section-control"},children:[BX.create("button",{props:{className:"ui-btn ui-btn-success"},text:BX.message("CRM_OIIV_STOP"),events:{click:this.cancelStepImport.bind(this)}}),BX.create("div",{props:{className:"crm-entity-section-control-error-block"}})]})]});document.querySelector('[data-entity="step-import-footer"]').appendChild(this.stepImportFooter)}};BX.Crm.Instagram.TileGrid.Item=function(t){BX.TileGrid.Item.apply(this,arguments);this.isDraggable=t.isDraggable;this.isDroppable=t.isDroppable;this.isEditable=t.isEditable;this.dblClickDelay=0;this.id=t.id;this.productId=t.productId;this.imported=t.imported||false;this.name=t.name;this.caption=t.caption;this.currency=t.currency;this.price=BX.type.isNumber(t.price)?t.price:null;this.formattedPrice=this.getFormattedPrice(this.price,this.currency);this.formattedCurrency=this.getFormattedCurrency(this.currency);this.images=t.images;this.image=t.images[0];this.mediaType=t.mediaType;this.permalink=t.permalink;this.sourceData=t.sourceData;this.actions=[];this.componentName=t.componentName;this.signedParameters=t.signedParameters;this.item={container:null,action:null,title:null,titleWrapper:null,titleLink:null,titleInput:null,price:null,priceWrapper:null,priceSubWrapper:null,priceLink:null,priceInput:null,lock:null,symlink:null,imageBlock:null,picture:null,fileType:null,icons:null}};BX.Crm.Instagram.TileGrid.Item.prototype={__proto__:BX.TileGrid.Item.prototype,constructor:BX.TileGrid.Item,getRawData:function(t){var e={ID:this.id,NAME:this.name,DESCRIPTION:this.caption,IMAGES:this.images,MEDIA_TYPE:this.mediaType,LINK:this.permalink};if(BX.type.isNumber(this.price)){e.PRICE=this.price}if(this.productId){e.PRODUCT_ID=this.productId}if(t){e.SOURCE_DATA=this.sourceData}return e},setProductId:function(t){this.productId=t},setEditable:function(t){this.isEditable=!!t},getCheckBox:function(){if(this.isEditable)return;return this.layout.checkbox=BX.create("div",{props:{className:"ui-grid-tile-item-checkbox"},events:{click:function(t){if(this!==this.gridTile.getCurrentItem()){this.gridTile.checkItem(this.gridTile.getCurrentItem())}this.gridTile.checkItem(this);this.gridTile.selectItem(this);this.gridTile.setCurrentItem(this);this.gridTile.setFirstCurrentItem(this);if(!this.gridTile.isLastSelectedItem()){if(this.gridTile.isMultiSelectMode())this.gridTile.checkItem(this.gridTile.getFirstCurrentItem())}this.focusItem();this.resetFocusItem();t.stopPropagation()}.bind(this)}})},getContent:function(){this.item.container=BX.create("div",{attrs:{className:"crm-order-instagram-grid-item"},children:[this.getImage(),this.isEditable?BX.create("div",{props:{className:"crm-order-instagram-grid-item-bottom crm-order-instagram-grid-item-bottom-without-icons"},children:[this.getNameAndPrice()]}):null],events:{contextmenu:function(t){if(t.ctrlKey){return}this.gridTile.resetSelection();this.gridTile.selectItem(this);t.preventDefault()}.bind(this)}});if(this.image){this.imageItemHandler=BX.throttle(this.appendImageItem,20).bind(this);BX.bind(window,"resize",this.imageItemHandler);BX.bind(window,"scroll",this.imageItemHandler)}return this.item.container},appendImageItem:function(){if(this.isVisibleInList()){this.item.picture.setAttribute("src",this.image);BX.unbind(window,"resize",this.imageItemHandler);BX.unbind(window,"scroll",this.imageItemHandler)}},getFormattedPrice:function(t,e){if(!BX.type.isNumber(t))return"";var i=t.toString();if(BX.Currency){var r=BX.Currency.currencyFormat(t,e);if(r!==""){i=r}}return i},getFormattedCurrency:function(t){var e="";if(BX.Currency){var i=BX.Currency.getCurrencyFormat(t);if(i){e=BX.util.trim(i.FORMAT_STRING.replace("#"," "))}}return e},getNameAndPrice:function(){this.item.title=BX.create("div",{children:[this.item.titleWrapper=BX.create("div",{props:{className:"crm-order-instagram-grid-item-title-wrapper"},children:[this.getNameInput(),this.item.titleLink=BX.create("span",{attrs:{className:"crm-order-instagram-grid-item-title-link",title:this.name},text:this.name,events:{click:this.onChangeName.bind(this)},dataset:{field:"name",productId:this.productId}}),BX.create("span",{props:{className:"crm-order-instagram-view-item-edit"},events:{click:this.onChangeName.bind(this)}})]})]});this.item.price=BX.create("div",{children:[this.item.priceWrapper=BX.create("div",{props:{className:"crm-order-instagram-grid-item-title-wrapper crm-order-instagram-grid-item-title-wrapper-price"},children:[this.getPriceInput(),this.item.priceSubWrapper=BX.create("span",{attrs:{className:"crm-order-instagram-view-item-price"+(BX.type.isNumber(this.price)?"":" crm-order-instagram-view-item-price-no")},children:[this.item.priceLink=BX.create("span",{attrs:{title:BX.type.isNumber(this.price)?this.formattedPrice:""},text:BX.type.isNumber(this.price)?this.formattedPrice:BX.message("CRM_OIIV_NO_PRICE")}),this.item.currency=BX.create("span",{props:{className:"crm-order-instagram-view-item-currency"},text:BX.type.isNumber(this.price)?this.formattedCurrency:""})],events:{click:this.onChangePrice.bind(this)},dataset:{field:"price",productId:this.productId}}),BX.create("span",{props:{className:"crm-order-instagram-view-item-edit"},events:{click:this.onChangePrice.bind(this)}})]})]});return BX.create("div",{props:{className:"crm-order-instagram-grid-item-title"},children:[this.item.title,this.item.price]})},getGridItemByProductId:function(t){var e=this.gridTile.items.filter(function(e){return e.productId==t});return e[0]?e[0]:null},focusNextInput:function(t){if(!BX.type.isDomNode(t))return;var e=this.gridTile.container.querySelectorAll('[data-entity="grid-item-input"]');for(var i=0;i<e.length;i++){if(e[i]===t&&BX.type.isDomNode(e[i+1])){var r=e[i+1].getAttribute("data-id");var n=this.getGridItemByProductId(r);var s=e[i+1].getAttribute("data-field");if(n&&s){var a="onChange"+s[0].toUpperCase()+s.substring(1).toLowerCase();n[a]&&n[a]()}break}}},getNameInput:function(){this.item.titleInput=BX.create("input",{attrs:{className:"crm-order-instagram-grid-item-title-input",type:"text",value:this.name||""},dataset:{entity:"grid-item-input",id:this.productId,field:"name"}});BX.bind(this.item.titleInput,"click",function(t){t.stopPropagation()});BX.bind(this.item.titleInput,"keydown",function(t){if(t.key==="Escape"){this.cancelRenaming();t.preventDefault()}if(t.key==="Enter"||t.key==="Tab"){this.cancelRenaming();this.focusNextInput(t.target);t.preventDefault()}t.stopPropagation()}.bind(this));BX.bind(this.item.titleInput,"blur",function(t){BX.removeClass(this.item.title,"crm-order-instagram-grid-item-title-rename");jsDD.Enable();if(this.name!==this.item.titleInput.value){this.runRename()}t.stopPropagation()}.bind(this));return this.item.titleInput},getPriceInput:function(){this.item.priceInput=BX.create("input",{attrs:{className:"crm-order-instagram-grid-item-title-input",type:"text",value:BX.type.isNumber(this.price)?this.price:""},dataset:{entity:"grid-item-input",id:this.productId,field:"price"}});BX.bind(this.item.priceInput,"click",function(t){t.stopPropagation()});BX.bind(this.item.priceInput,"keydown",function(t){if(t.key==="Escape"){this.cancelPriceChange();t.preventDefault()}if(t.key==="Enter"||t.key==="Tab"){this.cancelPriceChange();this.focusNextInput(t.target);t.preventDefault()}t.stopPropagation()}.bind(this));BX.bind(this.item.priceInput,"blur",function(t){BX.removeClass(this.item.price,"crm-order-instagram-grid-item-title-rename");jsDD.Enable();if(BX.type.isNumber(parseFloat(this.item.priceInput.value))&&this.price!==parseFloat(this.item.priceInput.value)){this.runChangePrice()}t.stopPropagation()}.bind(this));return this.item.priceInput},onChangeName:function(t){this.gridTile.resetSelection();jsDD.Disable();this.item.titleInput.value=this.name;BX.addClass(this.item.title,"crm-order-instagram-grid-item-title-rename");this.item.titleInput.focus();this.item.titleInput.select();t&&t.stopPropagation()},onChangePrice:function(t){this.gridTile.resetSelection();jsDD.Disable();this.item.priceInput.value=this.price;BX.addClass(this.item.price,"crm-order-instagram-grid-item-title-rename");this.item.priceInput.focus();this.item.priceInput.select();t&&t.stopPropagation()},cancelRenaming:function(){BX.removeClass(this.item.title,"crm-order-instagram-grid-item-title-rename");this.item.titleInput.blur();jsDD.Enable()},cancelPriceChange:function(){BX.removeClass(this.item.price,"crm-order-instagram-grid-item-title-rename");this.item.priceInput.blur();jsDD.Enable()},rename:function(t){t=BX.util.trim(t);if(t==="")return;BX.addClass(this.item.titleLink,"crm-order-instagram-grid-item-title-link-renamed");this.item.titleLink.addEventListener("animationend",function(){BX.removeClass(this.item.titleLink,"crm-order-instagram-grid-item-title-link-renamed")}.bind(this));this.item.titleLink.textContent=t;this.item.titleLink.setAttribute("title",t);this.name=t;this.rebuildLinkAfterRename(t);jsDD.Enable()},changePrice:function(t){t=parseFloat(t);if(!BX.type.isNumber(t))return;var e=this.getFormattedPrice(t,this.currency);BX.addClass(this.item.priceLink,"crm-order-instagram-grid-item-title-link-renamed");this.item.priceLink.addEventListener("animationend",function(){BX.removeClass(this.item.priceLink,"crm-order-instagram-grid-item-title-link-renamed")}.bind(this));this.item.priceLink.setAttribute("title",e);if(e){this.item.priceLink.textContent=e;BX.removeClass(this.item.priceSubWrapper,"crm-order-instagram-view-item-price-no")}else{this.item.priceLink.textContent=BX.message("CRM_OIIV_NO_PRICE");BX.addClass(this.item.priceSubWrapper,"crm-order-instagram-view-item-price-no")}this.item.currency.textContent=BX.type.isNumber(t)?this.formattedCurrency:"";this.price=BX.type.isNumber(t)?t:null;this.formattedPrice=e;jsDD.Enable()},rebuildLinkAfterRename:function(t){if(this.isFile){this.permalink=this.permalink.substring(0,this.permalink.lastIndexOf("/")+1)+encodeURIComponent(t)}else{this.permalink=this.permalink.substring(0,this.permalink.lastIndexOf("/",this.permalink.length-2)+1)+encodeURIComponent(t)+"/"}this.item.titleLink.href=this.permalink},makeFastNotification:function(t){if(BX.type.isNotEmptyString(t)){window.top.BX.UI.Notification.Center.notify({content:t,category:"InstagramStore::product",autoHideDelay:3e3,width:"auto"})}},runRename:function(){var t=this.name;this.rename(this.item.titleInput.value);if(this.name!==t){BX.ajax.runComponentAction(this.componentName,"modifyProductAjax",{mode:"class",signedParameters:this.signedParameters,data:{productId:this.productId,newName:this.name}}).then(function(t){this.makeFastNotification(BX.message("CRM_OIIV_PRODUCT_RENAME_SUCCESSFUL"))}.bind(this)).catch(function(e){this.rename(t)}.bind(this))}},runChangePrice:function(){var t=this.price;this.changePrice(this.item.priceInput.value);if(this.price!==t){BX.ajax.runComponentAction(this.componentName,"modifyProductAjax",{mode:"class",signedParameters:this.signedParameters,data:{productId:this.productId,newPrice:this.price}}).then(function(t){this.makeFastNotification(BX.message("CRM_OIIV_PRODUCT_CHANGE_PRICE_SUCCESSFUL"))}.bind(this)).catch(function(e){this.changePrice(t)}.bind(this))}},markImported:function(){BX.addClass(this.layout.container,"ui-grid-tile-item-imported")},afterRender:function(){if(this.imported){this.markImported()}if(!this.item.picture)return;this.appendImageItem();this.item.picture.onload=function(){BX.show(this.item.picture);BX.hide(this.item.fileType)}.bind(this)},isVisibleInList:function(){var t=this.layout.container.getBoundingClientRect();var e=document.body.getBoundingClientRect();var i=this.layout.container.offsetHeight*2;if(t.top<0||t.bottom<0)return false;return e.height>t.top-i&&e.height>=t.bottom-i},getImage:function(){this.item.imageBlock=BX.create("div",{attrs:{className:"crm-order-instagram-grid-item-image"},children:[this.item.fileType=BX.create("div",{attrs:{className:"ui-icon ui-icon-file ui-icon-file-img"},style:{width:this.isFolder?"85%":"70%"},html:"<i></i>"}),this.item.picture=this.image?BX.create("img",{attrs:{className:"crm-order-instagram-grid-item-image-img"},style:{display:"none"}}):null]});return this.item.imageBlock},getActions:function(){return this.actions}};
//# sourceMappingURL=script.map.js