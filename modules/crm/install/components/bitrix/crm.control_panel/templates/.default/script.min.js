if(typeof BX.CrmControlPanel==="undefined"){BX.CrmControlPanel=function(){this._id="";this._settings=null;this._container=null;this._wrapper=null;this._searchContainer=null;this._items=[];this._activeItem=null;this._additionalItem=null;this._slider=null;this._isFixed=false;this._isFixedLayout=false;this._scrollHandler=BX.delegate(this._onWindowScroll,this);this._resizeHandler=BX.delegate(this._onWindowResize,this);this._gridReinitializeHandler=BX.delegate(this._onGridManagerReinitialize,this);this._searchButton=null;this._pinButton=null};BX.CrmControlPanel.prototype={initialize:function(t,i){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=i?i:BX.CrmParamBag.create(null);this._container=BX(this.getSetting("containerId"));this._wrapper=BX(this.getSetting("wrapperId"));this._searchContainer=BX(this.getSetting("searchContainerId"));var e=this.getSetting("itemInfos",[]);for(var n=0;n<e.length;n++){var s=e[n];var r=BX.CrmParamBag.create(BX.clone(s));r.setParam("panel",this);var a=BX.CrmControlPanelItem.create(r.getParam("id"),r);if(a.isActive()){this._activeItem=a}this._items.push(a)}var o=this.getSetting("additionalItemInfo",null);if(o){var h=BX.CrmParamBag.create(BX.clone(o));h.setParam("panel",this);this._additionalItem=BX.CrmControlPanelItem.create(h.getParam("id"),h)}this._searchButton=BX.findChild(this._container,{tag:"SPAN","class":"crm-search-btn"},true,false);if(this._searchButton){BX.bind(this._searchButton,"click",BX.delegate(this._onSearchButtonClick,this))}this._pinButton=BX.findChild(this._container,{tag:"SPAN","class":"crm-menu-fixed-btn"},true,false);if(this._pinButton){BX.bind(this._pinButton,"click",BX.delegate(this._onPinButtonClick,this))}BX.addCustomEvent("onPullEvent-main",BX.delegate(function(t,i){if(t=="user_counter"&&i[BX.message("SITE_ID")]){var e=BX.clone(i[BX.message("SITE_ID")]);this.updateCounters(e)}},this));BX.addCustomEvent(window,"onImUpdateCounter",BX.delegate(function(t){if(!t)return;this.updateCounters(BX.clone(t))},this));this._slider=BX.CrmControlPanelSlider.create(this._id,BX.CrmParamBag.create({wrapperId:this.getSetting("itemWrapperId"),anchorId:this.getSetting("anchorId"),items:this._items,additionalItem:this._additionalItem}));this._isFixed=this.getSetting("isFixed",false);if(this._isFixed){this.adjust();BX.bind(window,"scroll",this._scrollHandler);BX.bind(window,"resize",this._resizeHandler)}BX.addCustomEvent(window,"BXInterfaceGridManagerReinitialize",this._gridReinitializeHandler)},getSetting:function(t,i){return this._settings.getParam(t,i)},getId:function(){return this._id},getItemContainerId:function(t){return this.getSetting("itemContainerPrefix","crm_ctrl_panel_item_")+t.toLowerCase()},requireItemActivityChange:function(t){return true},handleItemActivityChange:function(t){if(!t.isActive()){return}if(this._activeItem!==null&&this._activeItem!==t){this._activeItem.setActive(false,true,true)}this._activeItem=t},getNodeRect:function(t){var i=t.getBoundingClientRect();return{top:i.top,bottom:i.bottom,left:i.left,right:i.right,width:typeof i.width!=="undefined"?i.width:i.right-i.left,height:typeof i.height!=="undefined"?i.height:i.bottom-i.top}},getRect:function(){return this._isFixed?BX.pos(this._wrapper,true):BX.pos(this._container)},adjust:function(){if(!this._isFixed){if(this._isFixedLayout){this._isFixedLayout=false;BX.removeClass(this._wrapper,"crm-menu-fixed");this._container.style.height=this._container.style.width="";this._wrapper.style.height=this._wrapper.style.width=this._wrapper.style.left=this._wrapper.style.top="";BX.onCustomEvent(window,"CrmControlPanelLayoutChange",[this])}this._slider.adjust();return}if(this.getNodeRect(this._container).top<=0){if(this._isFixedLayout){this._wrapper.style.width=this.getNodeRect(this._container).width.toString()+"px"}else{var t=this.getNodeRect(this._container);this._container.style.height=t.height+"px";this._wrapper.style.width=t.width+"px";this._wrapper.style.left=t.left+"px";this._wrapper.style.top=0;BX.addClass(this._wrapper,"crm-menu-fixed");this._isFixedLayout=true;if(this._searchContainer){BX.onCustomEvent(this._searchContainer,"OnNodeLayoutChange")}BX.onCustomEvent(window,"CrmControlPanelLayoutChange",[this])}}else if(this._isFixedLayout){this._isFixedLayout=false;BX.removeClass(this._wrapper,"crm-menu-fixed");this._container.style.height=this._container.style.width="";this._wrapper.style.height=this._wrapper.style.width=this._wrapper.style.left=this._wrapper.style.top="";if(this._searchContainer){BX.onCustomEvent(this._searchContainer,"OnNodeLayoutChange")}BX.onCustomEvent(window,"CrmControlPanelLayoutChange",[this])}this._slider.adjust()},isFixed:function(){return this._isFixed},setFixed:function(t){t=!!t;if(this._isFixed===t){return}if(t){BX.unbind(window,"scroll",this._scrollHandler);BX.bind(window,"scroll",this._scrollHandler);BX.unbind(window,"resize",this._resizeHandler);BX.bind(window,"resize",this._resizeHandler);BX.removeClass(this._pinButton,"crm-lead-header-contact-btn-unpin");BX.addClass(this._pinButton,"crm-lead-header-contact-btn-pin")}else{BX.unbind(window,"scroll",this._scrollHandler);BX.unbind(window,"resize",this._resizeHandler);BX.removeClass(this._pinButton,"crm-lead-header-contact-btn-pin");BX.addClass(this._pinButton,"crm-lead-header-contact-btn-unpin");this._container.style.height=this._container.style.width="";this._wrapper.style.height=this._wrapper.style.width=this._wrapper.style.left=this._wrapper.style.top=""}this._isFixed=t;this.adjust();BX.onCustomEvent(window,"CrmControlPanelFixed",[this,this._isFixed]);BX.userOptions.save("crm.control.panel",this.getId().toLowerCase(),"fixed",t?"Y":"N")},_onSearchButtonClick:function(t){var i=BX.findChild(this._container,{tag:"FORM","class":"crm-search"},true,false);if(i){i.submit()}},_onWindowScroll:function(){this.adjust()},_onWindowResize:function(t){this.adjust()},_onGridManagerReinitialize:function(t){this.adjust()},_onPinButtonClick:function(t){this.setFixed(!this.isFixed())},updateCounters:function(t,i){i=i!=false;for(var e in t){if(e=="CRM_**"){var n=BX("crm_menu_counter",true);if(!n){break}if(t[e]>0){n.innerHTML=t[e]>99?"99+":t[e];n.style.display="inline-block"}else{n.innerHTML=0;n.style.display="none"}break}else{continue}}}};BX.CrmControlPanel._default=null;BX.CrmControlPanel.setDefault=function(t){this._default=t};BX.CrmControlPanel.getDefault=function(){return this._default};BX.CrmControlPanel.items={};BX.CrmControlPanel.create=function(t,i){var e=new BX.CrmControlPanel;e.initialize(t,i);this.items[e.getId()]=e;return e}}if(typeof BX.CrmControlPanelItem==="undefined"){BX.CrmControlPanelItem=function(){this._id="";this._settings=null;this._panel=null;this._container=null;this._actions=null;this._childItems=null;this._isVisible=true;this._menuId="";this._isMenuShown=false};BX.CrmControlPanelItem.prototype={initialize:function(t,i){this._id=BX.type.isNotEmptyString(t)?t:"";this._menuId="crm_menu_popup_"+this._id.toLowerCase();this._settings=i?i:BX.CrmParamBag.create(null);this._panel=this.getSetting("panel");this._container=BX(this._panel.getItemContainerId(this._id));if(!this._container){throw"BX.CrmControlPanelItem: Container is not found."}this._isVisible=this._container.style.display!=="none";this._isActive=this.getSetting("isActive",false);this._actions=this.getSetting("actions",[]);this._childItems=this.getSetting("childItems",[]);BX.bind(this._getLink(),"click",BX.delegate(this._onClick,this));if(this._findAction("CREATE")){var e=this._findAction("CREATE");this._container.appendChild(BX.create("A",{attrs:{"class":"crm-menu-plus-btn"},props:{href:this._getActionUrl("CREATE")},events:{click:BX.delegate(this._onCreateButtonClick,this)}}))}},getSetting:function(t,i){return this._settings.getParam(t,i)},getId:function(){return this._id},isActive:function(){return this._isActive},setActive:function(t,i,e){t=!!t;if(this._isActive===t){return}if(!i&&!this._panel.requireItemActivityChange(this)){return}this._isActive=t;if(t){BX.addClass(this._getLink(),"crm-menu-item-active")}else{BX.removeClass(this._getLink(),"crm-menu-item-active")}if(!e){this._panel.handleItemActivityChange(this)}},getContainer:function(){return this._container},isVisible:function(){return this._isVisible},setVisible:function(t){t=!!t;if(this._isVisible===t){return}this._container.style.display=t?"":"none";this._isVisible=t},hasUrl:function(){var t=this.getSetting("url");return BX.type.isNotEmptyString(t)&&t!=="#"},hasChildItems:function(){return this._childItems.length>0},getChildItems:function(){return this._childItems},setChildItems:function(t){this._childItems=BX.type.isArray(t)?t:[]},prepareChildItemSettings:function(){return{id:this._id,name:this.getSetting("name",this._id),icon:this.getSetting("icon",""),url:this.getSetting("url","")}},showSubMenu:function(){if(this._isMenuShown){return}var t=[];for(var i=0;i<this._childItems.length;i++){var e=this._childItems[i];var n=e["name"];if(!BX.type.isNotEmptyString(n)){continue}var s=BX.type.isNotEmptyString(e["icon"])?"crm-menu-more-"+e["icon"]:"";t.push({text:n,className:s,href:BX.type.isNotEmptyString(e["url"])?e["url"]:""})}if(t.length===0){return}if(typeof BX.PopupMenu.Data[this._menuId]!=="undefined"){BX.PopupMenu.Data[this._menuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._menuId]}var r=this._getLink();var a=BX.pos(r);BX.PopupMenu.show(this._menuId,r,t,{autoHide:true,offsetLeft:a["width"]/2-18,offsetTop:4,angle:{position:"top",offset:20},events:{onPopupClose:BX.delegate(this._onSubMenuClose,this)}});this._isMenuShown=true},closeSubMenu:function(){if(!this._isMenuShown){return}BX.PopupMenu.destroy(this._menuId);this._isMenuShown=false},_onSubMenuClose:function(){this.setActive(false,false,true);this._isMenuShown=false},_getActionUrl:function(t){var i=this._findAction(t);return i&&BX.type.isNotEmptyString(i["url"])?i["url"]:"#"},_findAction:function(t){for(var i=0;i<this._actions.length;i++){var e=this._actions[i];if(e["id"]===t){return e}}return null},_processAction:function(action){if(!action){return}if(BX.type.isNotEmptyString(action["script"])){try{eval(action["script"])}catch(ex){}}if(BX.type.isNotEmptyString(action["url"])){window.location=action["url"]}},_getLink:function(){return BX.findChild(this._container,{tag:"A","class":"crm-menu-item"},true,false)},_onClick:function(t){if(this.hasChildItems()){if(!this.isActive()){this.setActive(true,false,true)}if(!this._isMenuShown){this.showSubMenu()}else{this.closeSubMenu()}return BX.PreventDefault(t)}if(!this.isActive()){this.setActive(true)}return this.hasUrl()?true:BX.PreventDefault(t)},_onCreateButtonClick:function(t){this._processAction(this._findAction("CREATE"));return BX.eventReturnFalse(t)}};BX.CrmControlPanelItem.items={};BX.CrmControlPanelItem.create=function(t,i){var e=new BX.CrmControlPanelItem;e.initialize(t,i);this.items[e.getId()]=e;return e}}if(typeof BX.CrmControlPanelSliderInitData==="undefined"){BX.CrmControlPanelSliderInitData={}}if(typeof BX.CrmControlPanelSlider==="undefined"){BX.CrmControlPanelSlider=function(){this._id="";this._settings=null;this._wrapper=null;this._anchor=null;this._items=null;this._additionalItem=null;this._borderingItemIndex=-1;this._resizeHandler=BX.delegate(this._onResize,this)};BX.CrmControlPanelSlider.prototype={initialize:function(t,i){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=i?i:BX.CrmParamBag.create(null);this._wrapper=BX(this.getSetting("wrapperId"));if(!this._wrapper){throw"BX.CrmControlPanelSlider. Wrapper is not found."}this._items=this.getSetting("items");if(!this._items){throw"BX.CrmControlPanelSlider. Items are not found."}this._additionalItem=this.getSetting("additionalItem");this._anchor=BX(this.getSetting("anchorId"));if(typeof BX.CrmControlPanelSliderInitData[this._id]!=="undefined"&&typeof BX.CrmControlPanelSliderInitData[this._id]["borderingItemIndex"]!=="undefined"){this._borderingItemIndex=BX.CrmControlPanelSliderInitData[this._id]["borderingItemIndex"];this._setupAdditionalItemChildren()}this.adjust();BX.bind(window,"resize",this._resizeHandler)},getSetting:function(t,i){return this._settings.getParam(t,i)},getId:function(){return this._id},adjust:function(){var t=this._items.length;if(t===0){return}var i=this._items[0];var e=BX.pos(i.getContainer()).top;var n;var s=t-1;var r=null;var a=null;var o=this._additionalItem;var h=o.getContainer();o.setVisible(false);var l=-1;for(var d=s;d>0;d--){n=this._items[d];if(BX.pos(n.getContainer()).top>e){continue}l=d;if(l<s){r=n;a=n.getContainer();a.parentNode.insertBefore(h,a);o.setVisible(true);var u=BX.pos(r.getContainer()).top;o.setVisible(false);while(l<s&&u<=e){l++;r=this._items[l];a=r.getContainer();a.parentNode.insertBefore(h,a);o.setVisible(true);u=BX.pos(a).top;o.setVisible(false)}}break}if(l<0){l=0}if(l<s){r=this._items[l];a=r.getContainer();a.parentNode.insertBefore(h,a);o.setVisible(true)}this._borderingItemIndex=l;this._setupAdditionalItemChildren()},_onResize:function(t){this.adjust()},_setupAdditionalItemChildren:function(){if(!this._additionalItem){return}var t=[];var i=this._items.length-1;if(this._borderingItemIndex<i){for(var e=i;e>=this._borderingItemIndex;e--){t.push(this._items[e].prepareChildItemSettings())}}if(t.length>0){t.reverse()}this._additionalItem.closeSubMenu();this._additionalItem.setChildItems(t)}};BX.CrmControlPanelSlider.create=function(t,i){var e=new BX.CrmControlPanelSlider;e.initialize(t,i);return e}}
//# sourceMappingURL=script.map.js