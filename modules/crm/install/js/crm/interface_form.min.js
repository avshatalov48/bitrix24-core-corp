function BxCrmInterfaceForm(t,e){var i=this;this.name=t;this.aTabs=e;this.bExpandTabs=false;this.vars={};this.oTabsMeta={};this.aTabsEdit=[];this.oFields={};this.menu=new PopupMenu("bxFormMenu_"+this.name,1010);this.settingsMenu=[];this.tabSettingsWnd=null;this.fieldSettingsWnd=null;this.activeTabClass="bx-crm-view-tab-active";this._form=null;this._isSubmitted=false;this._enableSigleSubmit=true;this._submitConditionsChecked=true;this.isVisibleInViewMode=true;var n=BX("container_"+this.name.toLowerCase());if(n){this.isVisibleInViewMode=n.style.display!=="none"}this.Initialize=function(){this._form=BX("form_"+this.name);if(this._enableSigleSubmit){this._submitHandler=BX.delegate(this._OnSubmit,this);BX.bind(this._form,"submit",this._submitHandler)}BX.onCustomEvent(window,"CrmInterfaceFormCreated",[this])};this.EnableSigleSubmit=function(t){t=!!t;if(this._enableSigleSubmit===t){return}if(this._enableSigleSubmit&&this._submitHandler){BX.unbind(this._form,"submit",this._submitHandler);this._submitHandler=null}this._enableSigleSubmit=t;if(this._enableSigleSubmit){this._submitHandler=BX.delegate(this._OnSubmit,this);BX.bind(this._form,"submit",this._submitHandler)}};this.GetForm=function(){return this._form};this._OnSubmit=function(t){if(!this._enableSigleSubmit){return true}BX.onCustomEvent(this,"OnSubmitConditionsCheck",[this]);if(!this.IsSubmitConditionsChecked()){return true}if(this._isSubmitted){return BX.PreventDefault(t)}this._isSubmitted=true;window.setTimeout(BX.delegate(this._LockSubmits,this),10);return true};this._LockSubmits=function(){var t=BX(this.name+"_saveAndView");if(t){t.disabled="disabled"}var e=BX(this.name+"_saveAndAdd");if(e){e.disabled="disabled"}var i=BX(this.name+"_apply");if(i){i.disabled="disabled"}};this.GetTabs=function(){var t=BX.findChildren(BX(this.name+"_tab_block"),{tagName:"a",className:"bx-crm-view-tab"},false);return t?t:[]};this.GetActiveTabId=function(){var t=this.GetTabs();for(var e=0;e<t.length;e++){var i=t[e];if(BX.hasClass(i,this.activeTabClass)){return i.id.substring((this.name+"_tab_").length)}}return""};this.GetActiveTabContainer=function(){return this.GetTabContainer(this.GetActiveTabId())};this.ShowOnDemand=function(t){var e=BX.findParent(t,{tagName:"DIV",className:"bx-crm-view-fieldset"});var i=BX.findChildren(e,{tagName:"tr",className:"bx-crm-view-on-demand"},true);if(!BX.type.isArray(i)){return}for(var n=0;n<i.length;n++){i[n].style.display=""}if(t){BX.findParent(t,{tagName:"tr",className:"bx-crm-view-show-more"}).style.display="none"}};this.GetTabContainer=function(t){return BX.type.isNotEmptyString(t)?BX("inner_tab_"+t):null};this.SelectTab=function(t){var e=BX("inner_tab_"+t);if(!e||e.style.display!="none")return;for(var i=0,n=this.aTabs.length;i<n;i++){var s=BX("inner_tab_"+this.aTabs[i]);if(!s)continue;if(s.style.display!="none"){this.ShowTab(this.aTabs[i],false);s.style.display="none";break}}this.ShowTab(t,true);e.style.display="block";var a=BX(this.name+"_active_tab");if(a)a.value=t;BX.onCustomEvent(window,"BX_CRM_INTERFACE_FORM_TAB_SELECTED",[this,this.name,t,e])};this.ShowTab=function(t,e){var i=this.name+"_tab_"+t;var n=this.GetTabs();for(var s=0;s<n.length;s++){var a=n[s];if(i!==a.id){continue}if(e){BX.addClass(a,"bx-crm-view-tab-active");BX.onCustomEvent(this,"OnTabShow",[t])}else{BX.removeClass(a,"bx-crm-view-tab-active");BX.onCustomEvent(this,"OnTabHide",[t])}break}};this.HoverTab=function(t,e){var i=document.getElementById("tab_"+t);if(i.className=="bx-tab-selected")return;document.getElementById("tab_left_"+t).className=e?"bx-tab-left-hover":"bx-tab-left";i.className=e?"bx-tab-hover":"bx-tab";var n=document.getElementById("tab_right_"+t);n.className=e?"bx-tab-right-hover":"bx-tab-right"};this.ShowDisabledTab=function(t,e){var n=document.getElementById("tab_cont_"+t);if(e){n.className="bx-tab-container-disabled";n.onclick=null;n.onmouseover=null;n.onmouseout=null}else{n.className="bx-tab-container";n.onclick=function(){i.SelectTab(t)};n.onmouseover=function(){i.HoverTab(t,true)};n.onmouseout=function(){i.HoverTab(t,false)}}};this.ToggleTabs=function(t){this.bExpandTabs=!this.bExpandTabs;var e=document.getElementById("bxForm_"+this.name+"_expand_link");e.title=this.bExpandTabs?this.vars.mess.collapseTabs:this.vars.mess.expandTabs;e.className=this.bExpandTabs?e.className.replace(/\s*bx-down/gi," bx-up"):e.className.replace(/\s*bx-up/gi," bx-down");var i;for(var n in this.aTabs){var s=this.aTabs[n];this.ShowTab(s,false);this.ShowDisabledTab(s,this.bExpandTabs);i=document.getElementById("inner_tab_"+s);i.style.display=this.bExpandTabs?"block":"none"}if(!this.bExpandTabs){this.ShowTab(this.aTabs[0],true);i=document.getElementById("inner_tab_"+this.aTabs[0]);i.style.display="block"}if(t!==true)BX.ajax.get("/bitrix/components"+this.vars.component_path+"/settings.php?FORM_ID="+this.name+"&action=expand&expand="+(this.bExpandTabs?"Y":"N")+"&sessid="+this.vars.sessid)};this.SetTheme=function(t,e){BX.loadCSS(this.vars.template_path+"/themes/"+e+"/style.css");var n=this.menu.GetMenuByItemId(t.id);n.SetAllItemsIcon("");n.SetItemIcon(t,"checked");BX.ajax.get("/bitrix/components"+i.vars.component_path+"/settings.php?FORM_ID="+this.name+"&GRID_ID="+this.vars.GRID_ID+"&action=settheme&theme="+e+"&sessid="+this.vars.sessid)};this.ShowSettings=function(){var t=false;if(!window["formSettingsDialog"+this.name]){window["formSettingsDialog"+this.name]=new BX.CDialog({content:'<form name="form_settings_'+this.name+'"></form>',title:this.vars.mess.settingsTitle,width:this.vars.settingWndSize.width,height:this.vars.settingWndSize.height,resize_id:"InterfaceFormSettingWnd"});t=true}window["formSettingsDialog"+this.name].ClearButtons();window["formSettingsDialog"+this.name].SetButtons([{title:this.vars.mess.settingsSave,action:function(){i.SaveSettings();this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]);window["formSettingsDialog"+this.name].Show();var e=document["form_settings_"+this.name];if(t)e.appendChild(BX("form_settings_"+this.name));var n;this.aTabsEdit=[];for(n in this.oTabsMeta){var s=[];for(var a in this.oTabsMeta[n].fields)s[s.length]=BX.clone(this.oTabsMeta[n].fields[a]);this.aTabsEdit[this.aTabsEdit.length]=BX.clone(this.oTabsMeta[n]);this.aTabsEdit[this.aTabsEdit.length-1].fields=s}jsSelectUtils.deleteAllOptions(e.tabs);for(n in this.aTabsEdit)e.tabs.options[e.tabs.length]=new Option(this.aTabsEdit[n].name,this.aTabsEdit[n].id,false,false);e.tabs.selectedIndex=0;this.OnSettingsChangeTab();this.aAvailableFields=BX.clone(this.oFields);jsSelectUtils.deleteAllOptions(e.all_fields);for(n in this.aAvailableFields)e.all_fields.options[e.all_fields.length]=new Option(this.aAvailableFields[n].name,this.aAvailableFields[n].id,false,false);jsSelectUtils.sortSelect(e.all_fields);this.HighlightSections(e.all_fields);this.ProcessButtons();e.tabs.focus()};this.OnSettingsChangeTab=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;jsSelectUtils.deleteAllOptions(t.fields);for(var i in this.aTabsEdit[e].fields){var n=new Option(this.aTabsEdit[e].fields[i].name,this.aTabsEdit[e].fields[i].id,false,false);if(this.aTabsEdit[e].fields[i].type=="section")n.className="bx-section";t.fields.options[t.fields.length]=n}this.ProcessButtons()};this.TabMoveUp=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;if(e>0){var i=BX.clone(this.aTabsEdit[e]);var n=BX.clone(this.aTabsEdit[e-1]);this.aTabsEdit[e]=n;this.aTabsEdit[e-1]=i}jsSelectUtils.moveOptionsUp(t.tabs)};this.TabMoveDown=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;if(e<t.tabs.length-1){var i=BX.clone(this.aTabsEdit[e]);this.aTabsEdit[e]=BX.clone(this.aTabsEdit[e+1]);this.aTabsEdit[e+1]=i}jsSelectUtils.moveOptionsDown(t.tabs)};this.TabEdit=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;if(e<0)return;this.ShowTabSettings(this.aTabsEdit[e],(function(){var n=document["tab_settings_"+i.name];i.aTabsEdit[e].name=n.tab_name.value;i.aTabsEdit[e].title=n.tab_title.value;t.tabs[e].text=n.tab_name.value}))};this.TabAdd=function(){this.ShowTabSettings({name:"",title:""},(function(){var t="tab_"+Math.round(Math.random()*1e6);var e=document["tab_settings_"+i.name];i.aTabsEdit[i.aTabsEdit.length]={id:t,name:e.tab_name.value,title:e.tab_title.value,fields:[]};var n=document["form_settings_"+i.name];n.tabs[n.tabs.length]=new Option(e.tab_name.value,t,true,true);i.OnSettingsChangeTab()}))};this.TabDelete=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;if(e<0)return;var i;for(i in this.aTabsEdit[e].fields){this.aAvailableFields[this.aTabsEdit[e].fields[i].id]=this.aTabsEdit[e].fields[i];jsSelectUtils.addNewOption(t.all_fields,this.aTabsEdit[e].fields[i].id,this.aTabsEdit[e].fields[i].name,true,false)}this.HighlightSections(t.all_fields);this.aTabsEdit=BX.util.deleteFromArray(this.aTabsEdit,e);t.tabs.remove(e);if(t.tabs.length>0){i=e<t.tabs.length?e:t.tabs.length-1;t.tabs[i].selected=true;this.OnSettingsChangeTab()}else{jsSelectUtils.deleteAllOptions(t.fields);this.ProcessButtons()}};this.ShowTabSettings=function(t,e){var i=this.tabSettingsWnd;if(!i){this.tabSettingsWnd=i=new BX.CDialog({content:'<form name="tab_settings_'+this.name+'">'+'<table width="100%">'+"<tr>"+'<td width="50%" align="right">'+this.vars.mess.tabSettingsName+"</td>"+'<td><input type="text" name="tab_name" size="30" value="" style="width:90%"></td>'+"</tr>"+"<tr>"+'<td align="right">'+this.vars.mess.tabSettingsCaption+"</td>"+'<td><input type="text" name="tab_title" size="30" value="" style="width:90%"></td>'+"</tr>"+"</table>"+"</form>",title:this.vars.mess.tabSettingsTitle,width:this.vars.tabSettingWndSize.width,height:this.vars.tabSettingWndSize.height,resize_id:"InterfaceFormTabSettingWnd"})}i.ClearButtons();i.SetButtons([{title:this.vars.mess.tabSettingsSave,action:function(){e();this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]);i.Show();var n=document["tab_settings_"+this.name];n.tab_name.value=t.name;n.tab_title.value=t.title;n.tab_name.focus()};this.ShowFieldSettings=function(t,e){var i=this.fieldSettingsWnd;if(!i){this.fieldSettingsWnd=i=new BX.CDialog({content:'<form name="field_settings_'+this.name+'">'+'<table width="100%">'+"<tr>"+'<td width="50%" align="right" id="field_name_'+this.name+'"></td>'+'<td><input type="text" name="field_name" size="30" value="" style="width:90%"></td>'+"</tr>"+"</table>"+"</form>",width:this.vars.fieldSettingWndSize.width,height:this.vars.fieldSettingWndSize.height,resize_id:"InterfaceFormFieldSettingWnd"})}i.SetTitle(t.type&&t.type=="section"?this.vars.mess.sectSettingsTitle:this.vars.mess.fieldSettingsTitle);BX("field_name_"+this.name).innerHTML=t.type&&t.type=="section"?this.vars.mess.sectSettingsName:this.vars.mess.fieldSettingsName;i.ClearButtons();i.SetButtons([{title:this.vars.mess.tabSettingsSave,action:function(){e();this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]);i.Show();var n=document["field_settings_"+this.name];n.field_name.value=t.name;n.field_name.focus()};this.FieldEdit=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;var n=t.fields.selectedIndex;if(e<0||n<0)return;this.ShowFieldSettings(this.aTabsEdit[e].fields[n],(function(){var s=document["field_settings_"+i.name];i.aTabsEdit[e].fields[n].name=s.field_name.value;t.fields[n].text=s.field_name.value}))};this.FieldAdd=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;if(e<0)return;this.ShowFieldSettings({name:"",type:"section"},(function(){var n="field_"+Math.round(Math.random()*1e6);var s=document["field_settings_"+i.name];i.aTabsEdit[e].fields[i.aTabsEdit[e].fields.length]={id:n,name:s.field_name.value,type:"section"};var a=new Option(s.field_name.value,n,true,true);a.className="bx-section";t.fields[t.fields.length]=a;i.ProcessButtons()}))};this.FieldsMoveUp=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;var i=t.fields.length;for(var n=0;n<i;n++){if(t.fields[n].selected&&n>0&&t.fields[n-1].selected==false){var s=BX.clone(this.aTabsEdit[e].fields[n]);this.aTabsEdit[e].fields[n]=BX.clone(this.aTabsEdit[e].fields[n-1]);this.aTabsEdit[e].fields[n-1]=s;var a=new Option(t.fields[n].text,t.fields[n].value);var r=new Option(t.fields[n-1].text,t.fields[n-1].value);a.className=t.fields[n].className;r.className=t.fields[n-1].className;t.fields[n]=r;t.fields[n].selected=false;t.fields[n-1]=a;t.fields[n-1].selected=true}}};this.FieldsMoveDown=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;var i=t.fields.length;for(var n=i-1;n>=0;n--){if(t.fields[n].selected&&n<i-1&&t.fields[n+1].selected==false){var s=BX.clone(this.aTabsEdit[e].fields[n]);this.aTabsEdit[e].fields[n]=BX.clone(this.aTabsEdit[e].fields[n+1]);this.aTabsEdit[e].fields[n+1]=s;var a=new Option(t.fields[n].text,t.fields[n].value);var r=new Option(t.fields[n+1].text,t.fields[n+1].value);a.className=t.fields[n].className;r.className=t.fields[n+1].className;t.fields[n]=r;t.fields[n].selected=false;t.fields[n+1]=a;t.fields[n+1].selected=true}}};this.FieldsAdd=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;if(e==-1)return;var i=this.aTabsEdit[e].fields;var n=t.all_fields.length,s;for(s=0;s<n;s++)if(t.all_fields[s].selected)i[i.length]={id:t.all_fields[s].value,name:t.all_fields[s].text,type:this.aAvailableFields[t.all_fields[s].value].type};jsSelectUtils.addSelectedOptions(t.all_fields,t.fields,false,false);jsSelectUtils.deleteSelectedOptions(t.all_fields);for(s=0,n=t.fields.length;s<n;s++)if(i[s].type=="section")t.fields[s].className="bx-section";this.ProcessButtons()};this.FieldsDelete=function(){var t=document["form_settings_"+this.name];var e=t.tabs.selectedIndex;if(e==-1)return;var i=t.fields.length;var n=0;for(var s=0;s<i;s++){if(t.fields[s].selected){this.aAvailableFields[t.fields[s].value]=this.aTabsEdit[e].fields[s-n];this.aTabsEdit[e].fields=BX.util.deleteFromArray(this.aTabsEdit[e].fields,s-n);n++}}jsSelectUtils.addSelectedOptions(t.fields,t.all_fields,false,true);jsSelectUtils.deleteSelectedOptions(t.fields);this.HighlightSections(t.all_fields);this.ProcessButtons()};this.ProcessButtons=function(){var t=document["form_settings_"+this.name];t.add_btn.disabled=t.all_fields.selectedIndex==-1||t.tabs.selectedIndex==-1;t.del_btn.disabled=t.up_btn.disabled=t.down_btn.disabled=t.field_edit_btn.disabled=t.fields.selectedIndex==-1;t.tab_up_btn.disabled=t.tab_down_btn.disabled=t.tab_edit_btn.disabled=t.tab_del_btn.disabled=t.field_add_btn.disabled=t.tabs.selectedIndex==-1};this.HighlightSections=function(t){for(var e=0,i=t.length;e<i;e++)if(this.aAvailableFields[t[e].value].type=="section")t[e].className="bx-section"};this.SaveSettings=function(){var t={FORM_ID:this.name,action:"savesettings",sessid:this.vars.sessid,tabs:this.aTabsEdit};var e=document["form_settings_"+this.name];if(e&&e["set_default_settings"]){t.set_default_settings=e.set_default_settings.checked?"Y":"N";t.delete_users_settings=e.delete_users_settings.checked?"Y":"N"}BX.ajax.post("/bitrix/components"+i.vars.component_path+"/settings.php",t,(function(){i.Reload()}))};this.SaveSettings=function(t){if(!BX.type.isPlainObject(t)){t={}}var e=BX.type.isFunction(t["callback"])?t["callback"]:null;var n={FORM_ID:this.name,action:"savesettings",sessid:this.vars.sessid,tabs:this.aTabsEdit};var s=document["form_settings_"+this.name];if(s&&s["set_default_settings"]){n["set_default_settings"]=s.set_default_settings.checked?"Y":"N";n["delete_users_settings"]=s.delete_users_settings.checked?"Y":"N"}else{if(BX.type.isBoolean(t["setDefaultSettings"])){n["set_default_settings"]=t["setDefaultSettings"]?"Y":"N"}if(BX.type.isBoolean(t["deleteUserSettings"])){n["delete_users_settings"]=t["deleteUserSettings"]?"Y":"N"}}var a="/bitrix/components"+i.vars.component_path+"/settings.php";if(e){BX.ajax.post(a,n,e)}else{BX.ajax.post(a,n,(function(){i.Reload()}))}};this.EnableSettings=function(t,e){var n="/bitrix/components"+this.vars.component_path+"/settings.php?FORM_ID="+this.name+"&action=enable&enabled="+(t?"Y":"N")+"&sessid="+this.vars.sessid;if(BX.type.isFunction(e)){BX.ajax.get(n,e)}else{BX.ajax.get(n,(function(){i.Reload()}))}};this.Reload=function(){var t=this.vars.ajax.AJAX_ID;if(t!=""){var e=BX.util.remove_url_param(this.vars.current_url,"bxajaxid");if(e[e.length-1]==="?"){e=e.substr(0,e.length-1)}BX.ajax.insertToNode(e+(e.indexOf("?")<0?"?":"&")+"bxajaxid="+t,"comp_"+t)}else{window.location=window.location.href}};this.ReloadActiveTab=function(){var t=this.name+"_active_tab";var e=BX.util.remove_url_param(this.vars.current_url,t);if(e[e.length-1]==="?"){e=e.substr(0,e.length-1)}e+=(e.indexOf("?")<0?"?":"&")+t+"="+this.GetActiveTabId();var i=this.vars.ajax.AJAX_ID;if(i!=""){BX.ajax.insertToNode(e+"&bxajaxid="+i,"comp_"+i)}else{window.location=e}};this.SetViewModeVisibility=function(t){t=!!t;if(this.isVisibleInViewMode===t){return}this.isVisibleInViewMode=t;var e=BX("container_"+this.name.toLowerCase());if(e){e.style.display=this.isVisibleInViewMode?"":"none"}BX.userOptions.save("main.interface.form",this.name,"show_in_view_mode",t?"Y":"N",false)};this.IsSubmitConditionsChecked=function(){return this._submitConditionsChecked};this.SetSubmitConditionsFlag=function(t){this._submitConditionsChecked=!!t}}BX.CmrSidebarFieldSelector=function(){this._id="";this._fieldId="";this._currentItem=null;this._elem=null;this._settings={};this._items={};this._popupMenu=null};BX.CmrSidebarFieldSelector.prototype={initialize:function(t,e,i,n){this._id=t;this._fieldId=e;this._elem=i;this._settings=n;this._items={};var s=this.getSettings("options",null);if(s){for(var a=0;a<s.length;a++){var r=s[a];if(BX.type.isNotEmptyString(r["id"])){var o=r["id"];this._items[o]=BX.CmrSidebarFieldSelectorItem.create(o,this,{text:BX.type.isNotEmptyString(r["caption"])?r["caption"]:o})}}}BX.bind(this._elem,"click",BX.proxy(this._onElementClick,this));var l=BX(this.getSettings("buttonId",""));if(l){BX.bind(l,"click",BX.proxy(this._onElementClick,this))}},getSettings:function(t,e){var i=this._settings;return i[t]?i[t]:e},getFieldId:function(){return this._fieldId},getCurrentItem:function(){return this._currentItem},setCurrentItemId:function(t,e){var i=null;for(var n in this._items){if(!this._items.hasOwnProperty(n)){continue}if(this._items[n].getId()===t){i=this._items[n]}}if(!i){return}this._currentItem=i;if(this._elem){this._elem.innerHTML=i.getTitle()}e=!!e;if(e){var s=BX.CrmInstantEditor.getDefault();if(s){s.saveFieldValue(this._fieldId,i.getId())}BX.CmrSidebarFieldSelector._synchronize(this)}},_onElementClick:function(t){var e=[];for(var i in this._items){if(!this._items.hasOwnProperty(i)){continue}var n=this._items[i].createMenuItem();if(n){e.push(n)}}BX.PopupMenu.show(this._id,this._elem,e,{offsetTop:0,offsetLeft:0});this._popupMenu=BX.PopupMenu.currentItem},handleItemChange:function(t){if(this._popupMenu&&this._popupMenu.popupWindow){this._popupMenu.popupWindow.close()}this.setCurrentItemId(t.getId(),true)}};BX.CmrSidebarFieldSelector.items={};BX.CmrSidebarFieldSelector.create=function(t,e,i,n){var s=new BX.CmrSidebarFieldSelector;s.initialize(t,e,i,n);this.items[t]=s;return s};BX.CmrSidebarFieldSelector._synchronize=function(t){var e=t.getCurrentItem();if(!e){return}var i=t.getFieldId();for(var n in this.items){if(!this.items.hasOwnProperty(n)){continue}var s=this.items[n];if(s===t){continue}if(i===s.getFieldId()){s.setCurrentItemId(e.getId(),false)}}};BX.CmrSidebarFieldSelectorItem=function(){this._id="";this._parent=null;this._settings={}};BX.CmrSidebarFieldSelectorItem.prototype={initialize:function(t,e,i){this._id=t;this._parent=e;this._settings=i},getSettings:function(t,e){var i=this._settings;return i[t]?i[t]:e},getId:function(){return this._id},getTitle:function(){return this.getSettings("text",this._id)},createMenuItem:function(){return{text:this.getTitle(),onclick:BX.proxy(this._onMenuItemClick,this)}},_onMenuItemClick:function(){if(this._parent){this._parent.handleItemChange(this)}}};BX.CmrSidebarFieldSelectorItem.create=function(t,e,i){var n=new BX.CmrSidebarFieldSelectorItem;n.initialize(t,e,i);return n};BX.CrmSidebarUserSelector=function(){this._id="";this._settings={};this._button=null;this._container=null;this.componentName="";this._componentContainer=null;this._componentObj=null;this._fieldId="";this._editor=null;this._dlg=null;this._dlgDisplayed=false;this._userInfo=null;this._userInfoProvider=null;this._enableLazyLoad=false;this._isLoaded=false;this._serviceUrl="";this._options={};this._userSelectorScriptLoaded=null};BX.CrmSidebarUserSelector.prototype={initialize:function(t,e,i,n,s){this._id=BX.type.isNotEmptyString(t)?t:"crm_sidebar_user_sel_"+Math.random();if(!BX.type.isElementNode(e)){throw"BX.CrmSidebarUserSelector: button is not defined"}this._button=e;if(!BX.type.isElementNode(i)){throw"BX.CrmSidebarUserSelector: container is not defined"}this._container=i;if(!BX.type.isNotEmptyString(n)){throw"BX.CrmSidebarUserSelector: componentName is not defined"}this.componentName=n;this._options=s?s:{};this._enableLazyLoad=this.getOption("enableLazyLoad",false);this._serviceUrl=this.getOption("serviceUrl","");if(!this._enableLazyLoad){this._componentContainer=BX(n+"_selector_content");var a="O_"+n;if(window[a]){this._componentObj=window[a];this._componentObj.onSelect=BX.delegate(this._handleUserSelect,this);this._isLoaded=true}}BX.bind(this._button,"click",BX.delegate(this._handleButtonClick,this));this._fieldId=this.getStringOption("fieldId");this._userInfoProvider=BX.CrmUserInfoProvider.getItemById(this.getStringOption("userInfoProviderId"));if(this._fieldId!==""){var r=this.getOption("editorId","");if(r!==""){var o=BX.CrmInstantEditor.items[r];if(o){this._setupEditor(o)}else{BX.addCustomEvent("CrmInstantEditorCreated",BX.delegate(this._handleEditorCreation,this))}}}},openDialog:function(){this._dlg=new BX.PopupWindow(this._id,this._button,{autoHide:true,draggable:false,closeByEsc:true,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:true},content:this._componentContainer,events:{onPopupShow:BX.delegate((function(){this._dlgDisplayed=true}),this),onPopupClose:BX.delegate((function(){this._dlgDisplayed=false;this._dlg.destroy()}),this),onPopupDestroy:BX.delegate((function(){this._dlg=null}),this)}});this._dlg.show()},closeDialog:function(){if(this._dlg){this._dlg.close()}},getSetting:function(t,e){return this._settings[t]?this._settings[t]:e},getOption:function(t,e){return this._options.hasOwnProperty(t)?this._options[t]:e},getStringOption:function(t){return BX.type.isNotEmptyString(this._options[t])?this._options[t]:""},layout:function(){this._container.href=this._userInfo?this._userInfo.getProfileUrl():"#";var t=BX.findChild(this._container,{className:"crm-detail-info-resp-name"},true,false);if(t){t.innerHTML=BX.util.htmlspecialchars(this._userInfo?this._userInfo.getFullName():"")}var e=BX.findChild(this._container,{className:"crm-detail-info-resp-descr"},true,false);if(e){e.innerHTML=BX.util.htmlspecialchars(this._userInfo?this._userInfo.getWorkPosition():"")}var i=BX.findChild(this._container,{className:"crm-detail-info-resp-img"},true,false);if(i){BX.cleanNode(i,false);i.appendChild(BX.create("IMG",{attrs:{height:"38",width:"38",src:this._userInfo?this._userInfo.getPhotoUrl():""}}))}},toggleDialog:function(){if(this._dlg&&this._dlgDisplayed){this.closeDialog()}else{this.openDialog()}},_handleButtonClick:function(){if(this._isLoaded){this.toggleDialog();return}if(this._enableLazyLoad&&this._serviceUrl!==""){this._userSelectorScriptLoaded=BX.delegate(this._handleUserSelectorScriptLoaded,this);BX.addCustomEvent("onAjaxSuccessFinish",this._userSelectorScriptLoaded);BX.ajax({url:this._serviceUrl,method:"POST",dataType:"html",data:{MODE:"GET_USER_SELECTOR",NAME:this.componentName},onsuccess:BX.delegate(this._handleUserSelectorHtmlLoaded,this)})}},_handleUserSelectorHtmlLoaded:function(t){this._container.parentNode.appendChild(BX.create("DIV",{html:t}));this._isLoaded=true},_handleUserSelectorScriptLoaded:function(t){if(t["url"]!==this._serviceUrl){return}BX.removeCustomEvent("onAjaxSuccessFinish",this._userSelectorScriptLoaded);this._userSelectorScriptLoaded=null;this._componentContainer=BX(this.componentName+"_selector_content");var e="O_"+this.componentName;if(window[e]){this._componentObj=window[e];this._componentObj.onSelect=BX.delegate(this._handleUserSelect,this)}this.openDialog()},_handleUserSelect:function(t){this.closeDialog();if(!this._userInfoProvider){return}var e=this;this._userInfoProvider.getInfo(t.id,(function(t){e._userInfo=t;e.layout();if(e._fieldId.length>0){var i=e._editor;if(!i){i=BX.CrmInstantEditor.getDefault()}if(i){i.saveFieldValue(e._fieldId,t.getId())}}}))},_handleEditorCreation:function(t){var e=this.getOption("editorId","");if(e!==""&&t.getId()===e){this._setupEditor(t)}},_handleEditorFieldValueSaved:function(t,e){if(this._fieldId!==t||!this._userInfoProvider){return}if(this._userInfo&&this._userInfo.getId()===e){return}var i=this;this._userInfoProvider.getInfo(e,(function(t){i._userInfo=t;i.layout()}))},_setupEditor:function(t){if(this._editor){BX.removeCustomEvent(this._editor,"CrmInstantEditorFieldValueSaved",BX.delegate(this._handleEditorFieldValueSaved,this))}this._editor=t;if(this._editor){BX.addCustomEvent(this._editor,"CrmInstantEditorFieldValueSaved",BX.delegate(this._handleEditorFieldValueSaved,this))}}};BX.CrmSidebarUserSelector.create=function(t,e,i,n,s){var a=new BX.CrmSidebarUserSelector;a.initialize(t,e,i,n,s);return a};BX.CrmUserSearchField=function(){this._id="";this._search_input=null;this._data_input=null;this._componentName="";this._componentContainer=null;this._componentObj=null;this._dlg=null;this._dlgDisplayed=false;this._currentUser={}};BX.CrmUserSearchField.prototype={initialize:function(t,e,i,n,s){this._id=BX.type.isNotEmptyString(t)?t:"crm_user_search_field_"+Math.random();if(!BX.type.isElementNode(e)){throw"BX.CrmUserSearchField: 'search_input' is not defined!"}this._search_input=e;if(!BX.type.isElementNode(i)){throw"BX.CrmUserSearchField: 'data_input' is not defined!"}this._data_input=i;if(!BX.type.isNotEmptyString(n)){throw"BX.CrmUserSearchField: 'componentName' is not defined!"}this._componentName=n;this._componentContainer=BX(n+"_selector_content");var a="O_"+n;if(window[a]){this._componentObj=window[a];this._componentObj.onSelect=BX.delegate(this._handleUserSelect,this);this._componentObj.searchInput=e;BX.bind(e,"keyup",BX.proxy(this._handleSearchKey,this));BX.bind(e,"focus",BX.proxy(this._handleSearchFocus,this));BX.bind(document,"click",BX.delegate(this._handleExternalClick,this))}this._currentUser=s?s:{};this._adjustUser()},openDialog:function(){this._dlg=new BX.PopupWindow(this._id,this._search_input,{autoHide:false,draggable:false,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:true},content:this._componentContainer,events:{onPopupShow:BX.delegate((function(){this._dlgDisplayed=true}),this),onPopupClose:BX.delegate((function(){this._dlgDisplayed=false;this._dlg.destroy()}),this),onPopupDestroy:BX.delegate((function(){this._dlg=null}),this)}});this._dlg.show()},_adjustUser:function(){this._search_input.value=this._currentUser["name"]?this._currentUser.name:"";this._data_input.value=this._currentUser["id"]?this._currentUser.id:0},closeDialog:function(){if(this._dlg){this._dlg.close()}},_handleExternalClick:function(t){if(!t){t=window.event}if(t.target!==this._search_input&&!BX.findParent(t.target,{attribute:{id:this._componentName+"_selector_content"}})){this._adjustUser();this.closeDialog()}},_handleSearchKey:function(t){if(!this._dlg||!this._dlgDisplayed){this.openDialog()}this._componentObj.search()},_handleSearchFocus:function(t){if(!this._dlg||!this._dlgDisplayed){this.openDialog()}this._componentObj._onFocus(t)},_handleUserSelect:function(t){this._currentUser=t;this._adjustUser();this.closeDialog()}};BX.CrmUserSearchField.items={};BX.CrmUserSearchField.create=function(t,e,i,n,s){var a=new BX.CrmUserSearchField;a.initialize(t,e,i,n,s);this.items[t]=a;return a};BX.CrmUserLinkField=function(){this._settings={};this._container=null;this._fieldId="";this._editor=null;this._userInfoProvider=null;this._userInfo=null};BX.CrmUserLinkField.prototype={initialize:function(t){this._settings=t?t:{};this._container=this.getSetting("container",null);if(!this._container){this._container=BX(this.getSetting("containerId",""))}if(!this._container){throw"BX.CrmUserLinkField: container is not found"}this._userInfoProvider=BX.CrmUserInfoProvider.getItemById(this.getSetting("userInfoProviderId",""));this._userInfo=this.getSetting("userInfo",null);this._fieldId=this.getSetting("fieldId","");if(this._fieldId!==""){var e=this.getSetting("editorId","");if(e!==""){var i=BX.CrmInstantEditor.items[e];if(i){this._setupEditor(i)}else{BX.addCustomEvent("CrmInstantEditorCreated",BX.delegate(this._handleEditorCreation,this))}}}},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},layout:function(){this._container.href=this._userInfo?this._userInfo.getProfileUrl():"#";var t=BX.findChild(this._container,{className:"crm-detail-info-resp-name"},true,false);if(t){t.innerHTML=BX.util.htmlspecialchars(this._userInfo?this._userInfo.getFullName():"")}var e=BX.findChild(this._container,{className:"crm-detail-info-resp-descr"},true,false);if(e){e.innerHTML=BX.util.htmlspecialchars(this._userInfo?this._userInfo.getWorkPosition():"")}var i=BX.findChild(this._container,{className:"crm-detail-info-resp-img"},true,false);if(i){BX.cleanNode(i,false);i.appendChild(BX.create("IMG",{attrs:{src:this._userInfo?this._userInfo.getPhotoUrl():""}}))}},_handleEditorCreation:function(t){var e=this.getSetting("editorId","");if(e!==""&&t.getId()===e){this._setupEditor(t)}},_setupEditor:function(t){if(this._editor){BX.removeCustomEvent(this._editor,"CrmInstantEditorFieldValueSaved",BX.delegate(this._handleEditorFieldValueSaved,this))}this._editor=t;if(this._editor){BX.addCustomEvent(this._editor,"CrmInstantEditorFieldValueSaved",BX.delegate(this._handleEditorFieldValueSaved,this))}},_handleEditorFieldValueSaved:function(t,e){if(this._fieldId!==t||!this._userInfoProvider){return}var i=this;this._userInfoProvider.getInfo(e,(function(t){i._userInfo=t;i.layout()}))}};BX.CrmUserLinkField.create=function(t){var e=new BX.CrmUserLinkField;e.initialize(t);return e};BX.CrmUserInfo=function(){this._data={}};BX.CrmUserInfo.prototype={initialize:function(t){this._data=t?t:{}},getId:function(){return BX.type.isNotEmptyString(this._data["ID"])?this._data["ID"]:""},getProfileUrl:function(){return BX.type.isNotEmptyString(this._data["USER_PROFILE"])?this._data["USER_PROFILE"]:""},getFullName:function(){return BX.type.isNotEmptyString(this._data["FULL_NAME"])?this._data["FULL_NAME"]:""},getWorkPosition:function(){return BX.type.isNotEmptyString(this._data["WORK_POSITION"])?this._data["WORK_POSITION"]:""},getPhotoUrl:function(){return BX.type.isNotEmptyString(this._data["PERSONAL_PHOTO"])?this._data["PERSONAL_PHOTO"]:""}};BX.CrmUserInfo.items={};BX.CrmUserInfo.create=function(t){var e=new BX.CrmUserInfo;e.initialize(t);this.items[e.getId()]=e;return e};BX.CrmUserInfoProvider=function(){this._id="";this._settings={};this._serviceUrl="";this._items={}};BX.CrmUserInfoProvider.prototype={initialize:function(t,e){if(!BX.type.isNotEmptyString(t)){throw"BX.CrmUserInfoProvider: id is not defined"}this._id=t;this._settings=e?e:{};var i=this.getSetting("serviceUrl","");if(i===""){throw"BX.CrmUserInfoProvider: serviceUrl is not found"}this._serviceUrl=i},getId:function(){return this._id},getSetting:function(t,e){return this._settings[t]?this._settings[t]:e},getInfo:function(t,e){if(!BX.type.isString(t)){t=t.toString()}if(!BX.type.isNotEmptyString(t)){if(BX.type.isFunction(e)){e(null)}return}if(typeof this._items[t]!=="undefined"){if(BX.type.isFunction(e)){e(this._items[t])}return}var i=this;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{MODE:"GET_USER_INFO",USER_ID:t,USER_PROFILE_URL_TEMPLATE:this.getSetting("userProfileUrlTemplate","")},onsuccess:function(n){var s=BX.CrmUserInfo.create(n["USER_INFO"]?n["USER_INFO"]:{});i._items[t]=s;if(BX.type.isFunction(e)){e(s)}},onfailure:function(t){i._showError(i.getMessage("generalError"));if(BX.type.isFunction(e)){e(null)}}})},getMessage:function(t){var e=BX.CrmUserInfoProvider.messages;return typeof e[t]!=="undefined"?e[t]:""},_showError:function(t){alert(t)}};BX.CrmUserInfoProvider.items={};BX.CrmUserInfoProvider.getItemById=function(t){return typeof this.items[t]?this.items[t]:null};BX.CrmUserInfoProvider.createIfNotExists=function(t,e){if(typeof this.items[t]!=="undefined"){return this.items[t]}var i=new BX.CrmUserInfoProvider;i.initialize(t,e);this.items[i.getId()]=i;return i};if(typeof BX.CrmUserInfoProvider.messages==="undefined"){BX.CrmUserInfoProvider.messages={}}BX.CrmDateLinkField=function(){this._dataElem=null;this._viewElem=null;this._settings={}};BX.CrmDateLinkField.prototype={initialize:function(t,e,i){if(!BX.type.isElementNode(t)){throw"BX.CrmDateLinkField: 'dataElem' is not defined!"}this._dataElem=t;if(BX.type.isElementNode(e)){this._viewElem=e;BX.bind(e,"click",BX.delegate(this._onViewClick,this))}else{BX.bind(t,"click",BX.delegate(this._onViewClick,this))}this._settings=i?i:{}},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},_onViewClick:function(t){BX.calendar({node:this._viewElem?this._viewElem:this._dataElem,field:this._dataElem,bTime:this.getSetting("showTime",true),bSetFocus:this.getSetting("setFocusOnShow",true),callback:BX.delegate(this._onCalendarSaveValue,this)})},_onCalendarSaveValue:function(t){var e=BX.calendar.ValueToString(t,this.getSetting("showTime",true),false);this._dataElem.value=e;if(this._viewElem){this._viewElem.innerHTML=e}}};BX.CrmDateLinkField.create=function(t,e,i){var n=new BX.CrmDateLinkField;n.initialize(t,e,i);return n};BX.CrmCompanyContactData=function(){this._companyId=0;this._contactIds=[]};BX.CrmCompanyContactData.prototype={initialize:function(t){if(BX.type.isPlainObject(t)){this._companyId=t.hasOwnProperty("companyId")?t["companyId"]:0;this._contactIds=t.hasOwnProperty("contactIds")&&BX.type.isArray(t["contactIds"])?t["contactIds"]:[]}},getCompanyId:function(){return this._companyId},setCompanyId:function(t){this._companyId=t},getContactId:function(t){return t>=0&&t<this._contactIds.length?this._contactIds[t]:null},findContactIndex:function(t){for(var e=0;e<this._contactIds.length;e++){if(this._contactIds[e]===t){return e}}return-1},addContactId:function(t){if(this.findContactIndex(t)>=0){return false}this._contactIds.push(t);return true},removeContactId:function(t){var e=this.findContactIndex(t);if(e<0){return false}this._contactIds.splice(e,1);return true}};BX.CrmCompanyContactData.create=function(t){var e=new BX.CrmCompanyContactData;e.initialize(t);return e};BX.CrmCompanyContactEditor=function(){this._id="";this._settings={};this._data={}};BX.CrmCompanyContactEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"CRM_COMPANY_CONTACT_EDITOR"+Math.random();this._settings=e?e:{};this._data=this.getSetting("data",null);if(!(this._data instanceof BX.CrmCompanyContactData)){this._data=BX.CrmCompanyContactData.create(null)}},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},layout:function(){}};BX.CrmCompanyContactEditor.create=function(t,e){var i=new BX.CrmCompanyContactEditor;i.initialize(t,e);return i};BX.CrmEntityEditor=function(){this._id="";this._settings={};this._readonly=false;this._dlg=null;this._data=null;this._info=null;this._container=null;this._selector=null;this._advInfoContainer=null;this._externalRequestData=null;this._externalEventHandler=null;this._blockArea=null;this._rqLinkedInputId="";this._rqLinkedId=0;this._bdLinkedId=0};BX.CrmEntityEditor.prototype={initialize:function(t,e,i,n){this._id=BX.type.isNotEmptyString(t)?t:"CRM_ENTITY_EDITOR"+Math.random();this._settings=e?e:{};if(!i){i=this._prepareData()}if(!i){throw"BX.CrmEntityEditor: Could not find data!"}this._data=i;this._info=n?n:BX.CrmEntityInfo.create();var s=this.getSetting("entitySelectorId","");if(obCrm&&obCrm[s]){var a=this._selector=obCrm[s];a.AddOnSaveListener(BX.delegate(this._onEntitySelect,this))}var r=this._container=BX(this.getSetting("containerId",""));if(!r){throw"BX.CrmEntityEditor: Could not find field container!"}this._advInfoContainer=BX(this.getSetting("containerId","")+"_descr");BX.bind(BX.findChild(r,{className:"crm-element-item-delete"},true,false),"click",BX.delegate(this._onDeleteButtonClick,this));var o=this.getSetting("buttonChangeIgnore",false);if(!o)BX.bind(BX.findChild(r,{className:"bx-crm-edit-crm-entity-change"},true,false),"click",BX.delegate(this._onChangeButtonClick,this));var l=BX(this.getSetting("buttonAddId",""));BX.bind(l?l:BX.findChild(r,{className:"bx-crm-edit-crm-entity-add"},true,false),"click",BX.delegate(this._onAddButtonClick,this));if(this.getSetting("cardViewMode",false)){this._rqLinkedInputId=this.getSetting("rqLinkedInputId","");this._bdLinkedInputId=this.getSetting("bdLinkedInputId","");this._setRqLinkedId(this.getSetting("rqLinkedId",0),this.getSetting("bdLinkedId",0),this.getSetting("skipInitInput",false))}var h=this._info.getSetting("id","");var d,c=0;if(typeof h==="string"&&h.length>0){if(/^\d+$/.test(h))c=parseInt(h);else if(/^\w+_\d+$/.test(h))c=parseInt(h.replace(/^\w+_/,""));else c=0}else{c=parseInt(h)}if(c>0){this._data.setId(h);this.layout()}},getId:function(){return this._id},getTypeName:function(){return this.getSetting("typeName","")},getContext:function(){return this.getSetting("context","")},getCreateUrl:function(){return this.getSetting("createUrl","")},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},getData:function(){return this._data},getMessage:function(t){var e=BX.CrmEntityEditor.messages;return BX.type.isNotEmptyString(e[t])?e[t]:""},openDialog:function(t,e){if(this._dlg){this._dlg.setData(this._data);this._dlg.open(t,e);return}switch(this.getTypeName()){case"CONTACT":this._dlg=BX.CrmContactEditDialog.create(this._id,this.getSetting("dialog",{}),this._data,BX.delegate(this._onSaveDialogData,this));break;case"COMPANY":this._dlg=BX.CrmCompanyEditDialog.create(this._id,this.getSetting("dialog",{}),this._data,BX.delegate(this._onSaveDialogData,this));break}if(this._dlg){this._dlg.open(t,e)}},closeDialog:function(){if(this._dlg){this._dlg.close()}},isReadOnly:function(){return this._readonly},setReadOnly:function(t){t=!!t;if(this._readonly===t){return}this._readonly=t;var e=BX.findChild(this._container,{className:"crm-element-item-delete"},true,false);if(e){e.style.display=t?"none":""}var i=BX.findChild(this._container,{className:"bx-crm-entity-buttons-wrapper"},true,false);if(i){i.style.display=t?"none":""}},_prepareData:function(t){var e=this.getTypeName();var i=this.getSetting("enableValuePrefix",false);if(e==="CONTACT"){if(t&&i)t["id"]="C_"+t["id"];return BX.CrmContactData.create(t)}if(e==="COMPANY"){if(t&&i)t["id"]="CO_"+t["id"];return BX.CrmCompanyData.create(t)}if(e==="LEAD"){if(t&&i)t["id"]="L_"+t["id"];return BX.CrmLeadData.create(t)}if(e==="DEAL"){if(t&&i)t["id"]="D_"+t["id"];return BX.CrmDealData.create(t)}if(e==="QUOTE"){if(t&&i)t["id"]="Q_"+t["id"];return BX.CrmQuoteData.create(t)}return null},_onDeleteButtonClick:function(t){if(this._readonly){return}var e=BX(this.getSetting("dataInputId",""));if(e){e.value=0}if(this.getSetting("cardViewMode",false)){var i=BX(this.getSetting("rqLinkedInputId",""));if(i)i.value=0}else{BX.cleanNode(BX.findChild(this._container,{className:"bx-crm-entity-info-wrapper"},true,false));if(this._advInfoContainer)BX.cleanNode(this._advInfoContainer)}BX.onCustomEvent("CrmEntitySelectorChangeValue",[this.getId(),this.getTypeName(),0,this])},_onChangeButtonClick:function(t){if(this._readonly){return}var e=this._selector;if(e){e.Open()}},_onAddButtonClick:function(t){if(this._readonly){return}this._data.reset();var e=this.getCreateUrl();var i=this.getContext();if(e===""||i===""){this.openDialog(BX.findChild(this._container,{className:"bx-crm-edit-crm-entity-add"},true,false),"CREATE");return}i=(i+"_"+BX.util.getRandomString(6)).toLowerCase();e=BX.util.add_url_param(e,{external_context:i});if(!this._externalRequestData){this._externalRequestData={}}this._externalRequestData[i]={context:i,wnd:window.open(e)};if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this._onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}},_onExternalEvent:function(t){var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";var i=BX.type.isPlainObject(t["value"])?t["value"]:{};var n=BX.type.isNotEmptyString(i["entityTypeName"])?i["entityTypeName"]:"";var s=BX.type.isNotEmptyString(i["context"])?i["context"]:"";if(e==="onCrmEntityCreate"&&n===this.getTypeName()&&this._externalRequestData&&BX.type.isPlainObject(this._externalRequestData[s])){var a=BX.type.isBoolean(i["isCanceled"])?i["isCanceled"]:false;if(!a){var r=BX.type.isPlainObject(i["entityInfo"])?i["entityInfo"]:{};this._data=this._prepareData(r);this._info=BX.CrmEntityInfo.create(r);var o=BX(this.getSetting("newDataInputId",""));if(o){o.value=this._data.getId();BX.onCustomEvent("CrmEntitySelectorChangeValue",[this.getId(),this.getTypeName(),this._data.getId(),this])}this.layout()}if(this._externalRequestData[s]["wnd"]){this._externalRequestData[s]["wnd"].close()}delete this._externalRequestData[s]}},_onSaveDialogData:function(t){this._data=this._dlg.getData();var e=this.getSetting("serviceUrl","");var i=this.getSetting("actionName","");if(!(BX.type.isNotEmptyString(e)&&BX.type.isNotEmptyString(i))){return}var n=this;BX.ajax({url:e,method:"POST",dataType:"json",data:{ACTION:i,DATA:this._data.toJSON()},onsuccess:function(t){if(t["ERROR"]){n._showDialogError(t["ERROR"])}else if(!t["DATA"]){n._showDialogError("BX.CrmEntityEditor: Could not find contact data!")}else{n._data=n._prepareData(t["DATA"]);n._info=BX.CrmEntityInfo.create(t["INFO"]?t["INFO"]:{});var e=BX(n.getSetting("newDataInputId",""));if(e){e.value=n._data.getId();BX.onCustomEvent("CrmEntitySelectorChangeValue",[n.getId(),n.getTypeName(),n._data.getId(),n])}n.layout(function(t){t.closeDialog()}(n))}},onfailure:function(t){n._showDialogError(t["ERROR"]?t["ERROR"]:n.getMessage("unknownError"))}})},layout:function(t){var e=BX(this.getSetting("dataInputId",""));if(e){e.value=this._data.getId()}var i=this.getSetting("cardViewMode",false);if(i){var n=BX(this.getSetting("rqLinkedInputId",""));if(n)n.value=this._rqLinkedId;var s=BX(this.getSetting("bdLinkedInputId",""));if(s)s.value=this._bdLinkedId}if(i&&this._advInfoContainer){if(this._blockArea){var a=this;this._blockArea.destroy((function(){a._continueLayout(t)}))}else{this._continueLayout(t)}}else{var r=BX.findChild(this._container,{className:"bx-crm-entity-info-wrapper"},true,false);if(!r){return}BX.cleanNode(r);r.appendChild(BX.create("A",{attrs:{className:"bx-crm-entity-info-link",href:this._info.getSetting("url",""),target:"_blank"},text:this._info.getSetting("title",this._data.getId())}));r.appendChild(BX.create("SPAN",{attrs:{className:"crm-element-item-delete"},events:{click:BX.delegate(this._onDeleteButtonClick,this)}}));if(this._advInfoContainer){this._advInfoContainer.innerHTML=this._prepareAdvInfoHTML()}if(typeof t==="function")t(t)}},_continueLayout:function(t){this._blockArea=null;this._blockArea=new BX.Crm.EntityEditorBlockAreaClass({editor:this,container:this._advInfoContainer,nextNode:null,entityInfoList:[this._info],readOnlyMode:this.isReadOnly(),closeBlockHandler:BX.delegate(this._onDeleteButtonClick,this),changeSelectedRequisiteHandler:BX.delegate(this._onChangeSelectedRequisite,this),changeLinkedRequisiteHandler:BX.delegate(this._onChangeLinkedRequisite,this),rqLinkedId:this._rqLinkedId,bdLinkedId:this._bdLinkedId});if(typeof t==="function")t()},_onEntitySelect:function(t){var e=this.getTypeName().toLowerCase();var i=t[e]&&t[e][0]?t[e][0]:null;var n=this.getSetting("cardViewMode",false);if(!i){if(n&&this._advInfoContainer&&this._blockArea)this._blockArea.destroy();return}this._data.setId(i["id"]);this._info=BX.CrmEntityInfo.create(i);this._setRqLinkedId(0,0);var s=this;this.layout((function(){BX.onCustomEvent("CrmEntitySelectorChangeValue",[s.getId(),s.getTypeName(),i["id"],s])}))},_showDialogError:function(t){if(this._dlg){this._dlg.showError(t)}},_prepareAdvInfoHTML:function(){var t="";var e,i,n;var s="";var a=[],r=[];e=this._info.getSetting("type",null);if(e){i=this._info.getSetting("advancedInfo",null);if(i){if(i["contactType"]&&i["contactType"]["name"]&&typeof i["contactType"]["name"]==="string"){s=BX.util.trim(i["contactType"]["name"])}if(i["multiFields"]&&i["multiFields"]instanceof Array){var o=i["multiFields"];for(n=0;n<o.length;n++){if(o[n]["TYPE_ID"]&&o[n]["TYPE_ID"]==="PHONE"){a.push({VALUE:BX.util.trim(o[n]["VALUE"])})}if(o[n]["TYPE_ID"]&&o[n]["TYPE_ID"]==="EMAIL"){r.push({VALUE:BX.util.trim(o[n]["VALUE"])})}}}switch(e){case"contact":if(a.length>0){t+='<span class="crm-offer-info-descrip-tem crm-offer-info-descrip-tel">'+this.getMessage("prefPhone")+": "+BX.util.htmlspecialchars(a[0]["VALUE"])+'<a href="callto:'+BX.util.htmlspecialchars(a[0]["VALUE"])+'" class="crm-offer-info-descrip-icon"></a></span><br/>'}if(r.length>0){t+='<span class="crm-offer-info-descrip-tem crm-offer-info-descrip-imail">'+this.getMessage("prefEmail")+": "+BX.util.htmlspecialchars(r[0]["VALUE"])+'<a href="mailto:'+BX.util.htmlspecialchars(r[0]["VALUE"])+'" class="crm-offer-info-descrip-icon"></a></span><br/>'}if(s){t+='<span class="crm-offer-info-descrip-tem crm-offer-info-descrip-type">'+this.getMessage("prefContactType")+": "+BX.util.htmlspecialchars(s)+"</span><br/>"}break;case"company":case"lead":if(a.length>0){t+='<span class="crm-offer-info-descrip-tem crm-offer-info-descrip-tel">'+this.getMessage("prefPhone")+": "+BX.util.htmlspecialchars(a[0]["VALUE"])+'<a href="callto:'+BX.util.htmlspecialchars(a[0]["VALUE"])+'" class="crm-offer-info-descrip-icon"></a></span><br/>'}if(r.length>0){t+='<span class="crm-offer-info-descrip-tem crm-offer-info-descrip-imail">'+this.getMessage("prefEmail")+": "+BX.util.htmlspecialchars(r[0]["VALUE"])+'<a href="mailto:'+BX.util.htmlspecialchars(r[0]["VALUE"])+'" class="crm-offer-info-descrip-icon"></a></span><br/>'}break}}}return t},_onChangeSelectedRequisite:function(t,e,i,n){t=parseInt(t);e=parseInt(e);i=parseInt(i);n=parseInt(n);if(n<0||isNaN(n))n=0;var s,a,r,o;if(t>0&&e>0&&i>0){o=parseInt(this._info.getSetting("id",0));if(o===e){a=this._info.getSetting("advancedInfo",null);if(BX.type.isPlainObject(a)&&BX.type.isArray(a["requisiteData"])){r=a["requisiteData"];for(s=0;s<r.length;s++){if(r[s]["selected"]=t===parseInt(r[s]["entityTypeId"])&&e===parseInt(r[s]["entityId"])&&i===parseInt(r[s]["requisiteId"])){r[s]["bankDetailIdSelected"]=n}}}}}},_onChangeLinkedRequisite:function(t,e){this._setRqLinkedId(t,e)},_setRqLinkedId:function(t,e,i){i=!!i;if(this.getSetting("cardViewMode",false)){var n;this._rqLinkedId=parseInt(t);if(this._rqLinkedId<0||isNaN(this._rqLinkedId))this._rqLinkedId=0;if(!i){n=BX(this._rqLinkedInputId);if(n)n.value=this._rqLinkedId}this._bdLinkedId=parseInt(e);if(this._bdLinkedId<0||isNaN(this._bdLinkedId))this._bdLinkedId=0;if(!i){n=BX(this._bdLinkedInputId);if(n)n.value=this._bdLinkedId}}}};if(typeof BX.CrmEntityEditor.messages==="undefined"){BX.CrmEntityEditor.messages={}}BX.CrmEntityEditor.items={};BX.CrmEntityEditor.create=function(t,e,i,n){var s=new BX.CrmEntityEditor;s.initialize(t,e,i,n);this.items[t]=s;return s};BX.CrmContactEditDialog=function(){this._id="";this._settings={};this._dlg=null;this._dlgCfg={};this._data=null;this._mode="CREATE";this._onSaveCallback=null};BX.CrmContactEditDialog.prototype={initialize:function(t,e,i,n){this._id=BX.type.isNotEmptyString(t)?t:"CRM_CONTACT_EDIT_DIALOG_"+Math.random();this._settings=e?e:{};this._data=i?i:BX.CrmContactData.create();this._onSaveCallback=BX.type.isFunction(n)?n:null},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},getData:function(){return this._data},setData:function(t){this._data=t?t:BX.CrmContactData.create()},isOpened:function(){return this._dlg&&this._dlg.isShown()},open:function(t,e){if(!BX.type.isNotEmptyString(e)||e!=="CREATE"&&e!=="EDIT"){e=this._mode}if(this._dlg&&this._mode===e){if(!this._dlg.isShown()){this._dlg.show()}return}if(this._mode!==e){this._mode=e}var i=this._dlgCfg={};i["id"]=this._id;this._dlg=new BX.PopupWindow(i["id"],t,{autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:this.getSetting("title","New contact"),events:{onPopupClose:BX.delegate(this._onPopupClose,this),onPopupDestroy:BX.delegate(this._onPopupDestroy,this)},content:this._prepareContent(),buttons:this._prepareButtons()});this._dlg.show()},close:function(){if(this._dlg){this._dlg.close()}},showError:function(t){var e=BX(this._getElementId("errors"));if(e){e.innerHTML=t;e.style.display=""}},_onPopupClose:function(){this._dlg.destroy()},_onPopupDestroy:function(){this._dlg=null},_prepareContent:function(){var t=BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-popup"}});var e=this._data;t.appendChild(BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-error-wrap",style:"display:none"},props:{id:this._getElementId("errors")}}));t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("lastName"),title:this.getSetting("lastNameTitle","Last Name"),value:e.getLastName()}));t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("name"),title:this.getSetting("nameTitle","Name"),value:e.getName()}));t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("secondName"),title:this.getSetting("secondNameTitle","Second Name"),value:e.getSecondName()}));if(this.getSetting("enableEmail",true)){t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("email"),title:this.getSetting("emailTitle","E-mail"),value:e.getEmail()}))}if(this.getSetting("enablePhone",true)){t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("phone"),title:this.getSetting("phoneTitle","Phone"),value:e.getPhone()}))}if(this.getSetting("enableExport",true)){if(this._mode==="CREATE"){e.markAsExportable(true)}t.appendChild(BX.CrmPopupWindowHelper.prepareCheckBoxField({id:this._getElementId("export"),title:this.getSetting("exportTitle","Enable Export"),value:e.isExportable()}))}return t},_prepareButtons:function(){return BX.CrmPopupWindowHelper.prepareButtons([{type:"button",settings:{text:this.getSetting("addButtonName","Add"),className:"popup-window-button-accept",events:{click:BX.delegate(this._onSaveButtonClick,this)}}},{type:"link",settings:{text:this.getSetting("cancelButtonName","Cancel"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}}}])},_getElementId:function(t){return this._dlgCfg["id"]+"_"+t},_onSaveButtonClick:function(){this._data.setLastName(BX(this._getElementId("lastName")).value);this._data.setName(BX(this._getElementId("name")).value);this._data.setSecondName(BX(this._getElementId("secondName")).value);if(this.getSetting("enableEmail",true)){this._data.setEmail(BX(this._getElementId("email")).value)}if(this.getSetting("enablePhone",true)){this._data.setPhone(BX(this._getElementId("phone")).value)}if(this.getSetting("enableExport",true)){this._data.markAsExportable(BX(this._getElementId("export")).checked)}if(this._onSaveCallback){this._onSaveCallback(this)}}};BX.CrmContactEditDialog.create=function(t,e,i,n){var s=new BX.CrmContactEditDialog;s.initialize(t,e,i,n);return s};BX.CrmCompanyEditDialog=function(){this._id="";this._settings={};this._dlg=null;this._dlgCfg={};this._data=null;this._mode="CREATE";this._onSaveCallback=null};BX.CrmCompanyEditDialog.prototype={initialize:function(t,e,i,n){this._id=BX.type.isNotEmptyString(t)?t:"CRM_COMPANY_EDIT_DIALOG_"+Math.random();this._settings=e?e:{};this._data=i?i:BX.CrmCompanyData.create();this._onSaveCallback=BX.type.isFunction(n)?n:null},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},getData:function(){return this._data},setData:function(t){this._data=t?t:BX.CrmCompanyData.create()},isOpened:function(){return this._dlg&&this._dlg.isShown()},open:function(t,e){if(!BX.type.isNotEmptyString(e)||e!=="CREATE"&&e!=="EDIT"){e=this._mode}if(this._dlg&&this._mode===e){this._dlg.setContent(this._prepareContent());if(!this._dlg.isShown()){this._dlg.show()}return}if(this._mode!==e){this._mode=e}var i=this._dlgCfg={};i["id"]=this._id;this._dlg=new BX.PopupWindow(i["id"],t,{autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:this.getSetting("title","New company"),events:{onPopupClose:BX.delegate(this._onPopupClose,this),onPopupDestroy:BX.delegate(this._onPopupDestroy,this)},content:this._prepareContent(),buttons:this._prepareButtons()});this._dlg.show()},close:function(){if(this._dlg){this._dlg.close()}},showError:function(t){var e=BX(this._getElementId("errors"));if(e){e.innerHTML=t;e.style.display=""}},_onPopupClose:function(){this._dlg.destroy()},_onPopupDestroy:function(){this._dlg=null},_prepareContent:function(){var t=BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-popup"}});var e=this._data;t.appendChild(BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-error-wrap",style:"display:none"},props:{id:this._getElementId("errors")}}));t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("title"),title:this.getSetting("titleTitle","Title"),value:e.getTitle()}));t.appendChild(BX.CrmPopupWindowHelper.prepareSelectField({id:this._getElementId("companyType"),title:this.getSetting("companyTypeTitle","Company Type"),value:e.getCompanyType(),items:this.getSetting("companyTypeItems",null)}));t.appendChild(BX.CrmPopupWindowHelper.prepareSelectField({id:this._getElementId("industry"),title:this.getSetting("industryTitle","Industry"),value:e.getIndustry(),items:this.getSetting("industryItems",null)}));t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("email"),title:this.getSetting("emailTitle","E-mail"),value:e.getEmail()}));t.appendChild(BX.CrmPopupWindowHelper.prepareTextField({id:this._getElementId("phone"),title:this.getSetting("phoneTitle","Phone"),value:e.getPhone()}));return t},_prepareButtons:function(){return BX.CrmPopupWindowHelper.prepareButtons([{type:"button",settings:{text:this.getSetting("addButtonName","Add"),className:"popup-window-button-accept",events:{click:BX.delegate(this._onSaveButtonClick,this)}}},{type:"link",settings:{text:this.getSetting("cancelButtonName","Cancel"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}}}])},_getElementId:function(t){return this._dlgCfg["id"]+"_"+t},_onSaveButtonClick:function(){this._data.setTitle(BX(this._getElementId("title")).value);this._data.setCompanyType(BX(this._getElementId("companyType")).value);this._data.setIndustry(BX(this._getElementId("industry")).value);this._data.setEmail(BX(this._getElementId("email")).value);this._data.setPhone(BX(this._getElementId("phone")).value);if(this._onSaveCallback){this._onSaveCallback(this)}}};BX.CrmCompanyEditDialog.create=function(t,e,i,n){var s=new BX.CrmCompanyEditDialog;s.initialize(t,e,i,n);return s};BX.CrmContactData=function(){this._id=0;this._name=this._secondName=this._lastName=this._email=this._phone="";this._export=null};BX.CrmContactData.prototype={initialize:function(t){if(!t){return}if(t["id"]){this.setId(t["id"])}if(t["name"]){this.setName(t["name"])}if(t["secondName"]){this.setSecondName(t["secondName"])}if(t["lastName"]){this.setLastName(t["lastName"])}if(t["email"]){this.setEmail(t["email"])}if(t["phone"]){this.setPhone(t["phone"])}if(t["export"]){this.markAsExportable(t["export"])}},reset:function(){this._id=0;this._name=this._secondName=this._lastName=this._email=this._phone="";this._export=null},getId:function(){return this._id},setId:function(t){this._id=t},getName:function(){return this._name},setName:function(t){this._name=BX.type.isNotEmptyString(t)?t:""},getSecondName:function(){return this._secondName},setSecondName:function(t){this._secondName=BX.type.isNotEmptyString(t)?t:""},getLastName:function(){return this._lastName},setLastName:function(t){this._lastName=BX.type.isNotEmptyString(t)?t:""},getEmail:function(){return this._email},setEmail:function(t){this._email=BX.type.isNotEmptyString(t)?t:""},getPhone:function(){return this._phone},setPhone:function(t){this._phone=BX.type.isNotEmptyString(t)?t:""},isExportable:function(){return!!this._export},markAsExportable:function(t){this._export=!!t},toJSON:function(){var t={id:this._id,name:this._name,secondName:this._secondName,lastName:this._lastName,email:this._email,phone:this._phone};if(this._export!==null){t["export"]=this._export?"Y":"N"}return t}};BX.CrmContactData.create=function(t){var e=new BX.CrmContactData;e.initialize(t);return e};BX.CrmCompanyData=function(){this._id=0;this._title=this._companyType=this._industry=this._email=this._phone=this._addressLegal=""};BX.CrmCompanyData.prototype={initialize:function(t){if(!t){return}if(t["id"]){this.setId(t["id"])}if(t["title"]){this.setTitle(t["title"])}if(t["companyType"]){this.setCompanyType(t["companyType"])}if(t["industry"]){this.setIndustry(t["industry"])}if(t["email"]){this.setEmail(t["email"])}if(t["phone"]){this.setPhone(t["phone"])}},reset:function(){this._id=0;this._title=this._companyType=this._industry=this._email=this._phone=this._addressLegal=""},getId:function(){return this._id},setId:function(t){this._id=t},getTitle:function(){return this._title},setTitle:function(t){this._title=BX.type.isNotEmptyString(t)?t:""},getCompanyType:function(){return this._companyType},setCompanyType:function(t){this._companyType=BX.type.isNotEmptyString(t)?t:""},getIndustry:function(){return this._industry},setIndustry:function(t){this._industry=BX.type.isNotEmptyString(t)?t:""},getEmail:function(){return this._email},setEmail:function(t){this._email=BX.type.isNotEmptyString(t)?t:""},getPhone:function(){return this._phone},setPhone:function(t){this._phone=BX.type.isNotEmptyString(t)?t:""},getAddressLegal:function(){return this._addressLegal},setAddressLegal:function(t){this._addressLegal=BX.type.isNotEmptyString(t)?t:""},toJSON:function(){return{id:this.id,title:this._title,companyType:this._companyType,industry:this._industry,email:this._email,phone:this._phone}}};BX.CrmCompanyData.create=function(t){var e=new BX.CrmCompanyData;e.initialize(t);return e};BX.CrmLeadData=function(){this._id=0;this._title=this._name=this._secondName=this._lastName=this._email=this._phone=""};BX.CrmLeadData.prototype={initialize:function(t){if(!t){return}if(t["id"]){this.setId(t["id"])}if(t["title"]){this.setTitle(t["title"])}if(t["name"]){this.setName(t["name"])}if(t["secondName"]){this.setSecondName(t["secondName"])}if(t["lastName"]){this.setLastName(t["lastName"])}if(t["email"]){this.setEmail(t["email"])}if(t["phone"]){this.setPhone(t["phone"])}},reset:function(){this._id=0;this._name=this._secondName=this._lastName=this._email=this._phone=""},getId:function(){return this._id},setId:function(t){this._id=t},getName:function(){return this._name},setTitle:function(t){this._title=BX.type.isNotEmptyString(t)?t:""},setName:function(t){this._name=BX.type.isNotEmptyString(t)?t:""},getSecondName:function(){return this._secondName},setSecondName:function(t){this._secondName=BX.type.isNotEmptyString(t)?t:""},getLastName:function(){return this._lastName},setLastName:function(t){this._lastName=BX.type.isNotEmptyString(t)?t:""},getEmail:function(){return this._email},setEmail:function(t){this._email=BX.type.isNotEmptyString(t)?t:""},getPhone:function(){return this._phone},setPhone:function(t){this._phone=BX.type.isNotEmptyString(t)?t:""},toJSON:function(){return{id:this._id,name:this._name,secondName:this._secondName,lastName:this._lastName,email:this._email,phone:this._phone}}};BX.CrmLeadData.create=function(t){var e=new BX.CrmLeadData;e.initialize(t);return e};BX.CrmDealData=function(){this._id=this._dealPrice=0;this._title=this._dealType=""};BX.CrmDealData.prototype={initialize:function(t){if(!t){return}if(t["id"]){this.setId(t["id"])}if(t["title"]){this.setTitle(t["title"])}if(t["dealType"]){this.setDealType(t["dealType"])}if(t["dealPrice"]){this.setDealType(t["dealPrice"])}},reset:function(){this._id=this._dealPrice=0;this._title=this._dealType=""},getId:function(){return this._id},setId:function(t){this._id=t},getTitle:function(){return this._title},setTitle:function(t){this._title=BX.type.isNotEmptyString(t)?t:""},getDealType:function(){return this._dealType},setDealType:function(t){this._dealType=BX.type.isNotEmptyString(t)?t:""},getDealPrice:function(){return this._dealPrice},setDealPrice:function(t){this._dealPrice=BX.type.isNumber(t)?t:0}};BX.CrmDealData.create=function(t){var e=new BX.CrmDealData;e.initialize(t);return e};BX.CrmQuoteData=function(){this._id=this._quotePrice=0;this._title=this._quoteType=""};BX.CrmQuoteData.prototype={initialize:function(t){if(!t){return}if(t["id"]){this.setId(t["id"])}if(t["title"]){this.setTitle(t["title"])}if(t["quoteType"]){this.setQuoteType(t["quoteType"])}if(t["quotePrice"]){this.setQuoteType(t["quotePrice"])}},reset:function(){this._id=this._quotePrice=0;this._title=this._quoteType=""},getId:function(){return this._id},setId:function(t){this._id=t},getTitle:function(){return this._title},setTitle:function(t){this._title=BX.type.isNotEmptyString(t)?t:""},getQuoteType:function(){return this._quoteType},setQuoteType:function(t){this._quoteType=BX.type.isNotEmptyString(t)?t:""},getQuotePrice:function(){return this._quotePrice},setQuotePrice:function(t){this._quotePrice=BX.type.isNumber(t)?t:0}};BX.CrmQuoteData.create=function(t){var e=new BX.CrmQuoteData;e.initialize(t);return e};if(typeof BX.CrmCalltoFormat==="undefined"){BX.CrmCalltoFormat={undefined:0,standard:1,slashless:2,custom:3,bitrix:4}}if(typeof BX.CrmEntityInfo==="undefined"){BX.CrmEntityInfo=function(){this._settings={}};BX.CrmEntityInfo.prototype={initialize:function(t){this._settings=BX.type.isPlainObject(t)?t:{}},getSettings:function(){return this._settings},getSetting:function(t,e){return this._settings[t]?this._settings[t]:e},isNew:function(){return BX.prop.getInteger(this._settings,"id",0)<=0},getId:function(){return BX.prop.getInteger(this._settings,"id",0)},getTypeName:function(){var t=BX.prop.getString(this._settings,"typeName","");if(!BX.type.isNotEmptyString(t)){t=BX.CrmEntityType.verifyName(BX.prop.getString(this._settings,"type",""))}return t},getTypeId:function(){return BX.CrmEntityType.resolveId(this.getTypeName())},getTypeCaption:function(){return BX.CrmEntityType.getCaptionByName(this.getTypeName())},getTitle:function(){return BX.prop.getString(this._settings,"title","")},setTitle:function(t){if(BX.type.isString(t)){this._settings["title"]=t}},getCategoryId:function(){return BX.prop.getInteger(this._settings,"categoryId","")},setCategoryId:function(t){if(BX.type.isInteger(t)){this._settings["categoryId"]=t}},getDescription:function(){return BX.prop.getString(this._settings,"desc","")},getShowUrl:function(){return BX.prop.getString(this._settings,"url","")},getImageUrl:function(){return BX.prop.getString(this._settings,"image","")},getLargeImageUrl:function(){return BX.prop.getString(this._settings,"largeImage","")},canUpdate:function(){return BX.prop.getBoolean(BX.prop.getObject(this._settings,"permissions"),"canUpdate",false)},hasMultiFields:function(){var t=this.getSetting("advancedInfo",null);return BX.type.isPlainObject(t)&&BX.type.isArray(t["multiFields"])&&t["multiFields"].length>0},setMultifields:function(t){if(!BX.type.isArray(t)){return}if(!BX.type.isPlainObject(this._settings["advancedInfo"])){this._settings["advancedInfo"]={}}this._settings["advancedInfo"]["multiFields"]=t},setRequisites:function(t){if(!BX.type.isArray(t)){return}if(!BX.type.isPlainObject(this._settings["advancedInfo"])){this._settings["advancedInfo"]={}}this._settings["advancedInfo"]["requisiteData"]=t;this._settings["advancedInfo"]["hasEditRequisiteData"]=true},setRequisitesForSave:function(t){if(!BX.type.isPlainObject(t)){return}this._settings["requisitesForSave"]=t},getRequisitesForSave:function(){return BX.prop.getObject(this._settings,"requisitesForSave",{})},getMultifields:function(){return BX.prop.getArray(BX.prop.getObject(this._settings,"advancedInfo"),"multiFields",[])},findIndexMultifieldById:function(t){if(t===null||t===undefined){return-1}if(!BX.type.isString(t)){t=t.toString()}var e=this.getSetting("advancedInfo",null);if(!e){return-1}var i=BX.prop.getArray(e,"multiFields",[]);for(var n=0;n<i.length;n++){var s=i[n];if(BX.prop.getString(s,"ID","")===t){return n}}return-1},getMultiField:function(t){var e=this.getSetting("advancedInfo",null);if(!e){return null}var i=BX.prop.getArray(e,"multiFields",[]);return i.length>t?i[t]:null},setMultifield:function(t,e){if(!BX.type.isPlainObject(this._settings["advancedInfo"])){this._settings["advancedInfo"]={}}if(!BX.type.isArray(this._settings["advancedInfo"]["multiFields"])){this._settings["advancedInfo"]["multiFields"]=[]}if(this._settings["advancedInfo"]["multiFields"].length>e){this._settings["advancedInfo"]["multiFields"][e]=t}else{throw"Could not find field"}},addMultifield:function(t){if(!BX.type.isPlainObject(this._settings["advancedInfo"])){this._settings["advancedInfo"]={}}if(!BX.type.isArray(this._settings["advancedInfo"]["multiFields"])){this._settings["advancedInfo"]["multiFields"]=[]}this._settings["advancedInfo"]["multiFields"].push(t)},setMultifieldById:function(t,e){var i=this.findIndexMultifieldById(e);if(i>=0){this.setMultifield(t,i)}else{this.addMultifield(t)}},getMultiFieldsByType:function(t){var e=this.getSetting("advancedInfo",null);if(!(BX.type.isPlainObject(e)&&BX.type.isArray(e["multiFields"]))){return[]}var i=e["multiFields"];var n=[];for(var s=0;s<i.length;s++){var a=i[s];var r=BX.type.isNotEmptyString(a["TYPE_ID"])?a["TYPE_ID"]:"";if(r!==t){continue}if(BX.type.isNotEmptyString(a["VALUE"])){n.push({TYPE:t,VALUE:a["VALUE"],VALUE_EXTRA:a["VALUE_EXTRA"]||{},ID:a["ID"],ENTITY_ID:a["ENTITY_ID"],COMPLEX_NAME:a["COMPLEX_NAME"]||"",VALUE_FORMATTED:a["VALUE_FORMATTED"]||a["VALUE"]})}}return n},getPhones:function(){return this.getMultiFieldsByType("PHONE")},getEmails:function(){return this.getMultiFieldsByType("EMAIL")},getEntityBindings:function(t){var e=BX.prop.getObject(this._settings,"advancedInfo",{});var i=BX.prop.getObject(e,"bindings",{});return BX.prop.getArray(i,t,[])},setEntityBindings:function(t,e){var i=BX.prop.getObject(this._settings,"advancedInfo",{});if(!this._settings.hasOwnProperty("advancedInfo")){this._settings["advancedInfo"]={}}if(!this._settings["advancedInfo"].hasOwnProperty("bindings")){this._settings["advancedInfo"]["bindings"]={}}this._settings["advancedInfo"]["bindings"][t]=e},checkEntityBinding:function(t,e){e=BX.convert.toNumber(e);var i=this.getEntityBindings(t);for(var n=0,s=i.length;n<s;n++){if(e==i[n]){return true}}return false},removeEntityBinding:function(t,e){var i=this.getEntityBindings(t);var n=-1;for(var s=0,a=i.length;s<a;s++){if(i[s]==e){n=s;break}}if(n>=0){i.splice(n,1);this.setEntityBindings(t,i)}},addEntityBinding:function(t,e){var i=this.getEntityBindings(t);var n=-1;for(var s=0,a=i.length;s<a;s++){if(i[s]==e){n=s;break}}if(n<0){i.push(e);this.setEntityBindings(t,i)}},hasRequisites:function(){var t=this.getSetting("advancedInfo",null);return BX.type.isPlainObject(t)&&BX.type.isArray(t["requisiteData"])&&t["requisiteData"].length>0},getRequisites:function(){var t=this.getSetting("advancedInfo",null);return BX.type.isPlainObject(t)&&BX.type.isArray(t["requisiteData"])?t["requisiteData"]:[]},hasEditRequisiteData:function(){var t=this.getSetting("advancedInfo",null);return BX.type.isPlainObject(t)&&BX.type.isBoolean(t["hasEditRequisiteData"])?t["hasEditRequisiteData"]:false},prepareRequisiteData:function(t){var e=this.getRequisites();if(e.length===0){return{requisites:[],context:t}}var i=0;var n=0;if(BX.type.isPlainObject(t)){if(BX.type.isNumber(t["requisiteId"])){i=t["requisiteId"]}if(BX.type.isNumber(t["bankDetailId"])){n=t["bankDetailId"]}}var s=-1;var a=-1;for(var r=0;r<e.length;r++){var o=e[r];var l=BX.type.isNotEmptyString(o["requisiteId"])?parseInt(o["requisiteId"]):0;o["requisiteId"]=l;var h=BX.type.isNotEmptyString(o["entityTypeId"])?parseInt(o["entityTypeId"]):0;o["entityTypeId"]=h;var d=BX.type.isNotEmptyString(o["entityId"])?parseInt(o["entityId"]):0;o["entityId"]=d;var c=BX.type.isBoolean(o["selected"])?o["selected"]:false;o["selected"]=c;var u=0;if(typeof o["bankDetailIdSelected"]!=="undefined"){u=parseInt(o["bankDetailIdSelected"]);if(u<0||isNaN(u)){u=0}}o["bankDetailIdSelected"]=u;var f=BX.type.isNotEmptyString(o["requisiteData"])?BX.parseJSON(o["requisiteData"]):null;if(!BX.type.isPlainObject(f)){f={}}o["viewData"]=BX.type.isPlainObject(f["viewData"])?f["viewData"]:{};var p=BX.type.isArray(f["bankDetailViewDataList"])?f["bankDetailViewDataList"]:[];if(p.length>0){var m=-1;var _=-1;var g=-1;for(var y=0;y<p.length;y++){var B=p[y];var I=parseInt(B["pseudoId"]);if(l===i&&I===n){m=y}if(u>0&&I===u){g=y}if(B["selected"]){_=y}}if(m>=0){if(m!==_){if(_>=0){p[_]["selected"]=false}p[m]["selected"]=true;o["bankDetailIdSelected"]=parseInt(p[m]["pseudoId"])}}else if(g>=0){if(g!==_){if(_>=0){p[_]["selected"]=false}p[g]["selected"]=true;o["bankDetailIdSelected"]=parseInt(p[g]["pseudoId"])}}else{if(_<0){_=0}o["bankDetailIdSelected"]=parseInt(p[_]["pseudoId"])}}o["bankDetailViewDataList"]=p;if(c){a=r}if(i==l){s=r}}if(s>=0&&a>=0&&a!==s){e[a]["selected"]=false;e[s]["selected"]=true;a=s}var C=0;var X=0;if(a>=0){var b=e[a];if(b["requisiteId"]>0){C=b["requisiteId"]}if(b["bankDetailIdSelected"]>0){X=b["bankDetailIdSelected"]}}if(i!==C||n!==X){i=C;n=X}return{requisites:e,requisiteId:i,bankDetailId:n}}};BX.CrmEntityInfo.equals=function(t,e){return t.getId()===e.getId()&&t.getTypeName()===e.getTypeName()};BX.CrmEntityInfo.getHashCode=function(t){return t.getTypeName()+"_"+t.getId().toString()};BX.CrmEntityInfo.create=function(t){var e=new BX.CrmEntityInfo;e.initialize(t);return e}}if(typeof BX.CrmEntityBankDetailList==="undefined"){BX.CrmEntityBankDetailList=function(){this._settings={};this._data=null;this._items=null};BX.CrmEntityBankDetailList.prototype={initialize:function(t){if(BX.type.isPlainObject(t)){this._settings=t}this._items=BX.prop.getArray(this._settings,"items",[])},getItemCount:function(){return this._items.length},getItemIndex:function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1},getItemByIndex:function(t){return t>=0&&t<this._items.length?this._items[t]:null},getItemById:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(t===BX.prop.getInteger(n,"pseudoId",0)){return n}}return null},getSelectedItem:function(){for(var t=0,e=this._items.length.length;t<e;t++){var i=this._items.length[t];if(BX.prop.getBoolean(i,"selected",false)){return i}}return null},getFirstItem:function(){return this._items.length>0?this._items[0]:null}};BX.CrmEntityBankDetailList.resolveItemId=function(t){return BX.prop.getInteger(t,"pseudoId",0)};BX.CrmEntityBankDetailList.create=function(t){var e=new BX.CrmEntityBankDetailList;e.initialize(t);return e}}if(typeof BX.CrmEntityRequisiteInfo==="undefined"){BX.CrmEntityRequisiteInfo=function(){this._settings={};this._requisiteId=0;this._bankDetailId=0;this._data=null;this._items=null};BX.CrmEntityRequisiteInfo.prototype={initialize:function(t){if(BX.type.isPlainObject(t)){this._settings=t}this._items=[];this._data=this.getSetting("data");if(!BX.type.isArray(this._data)){this._data=[]}if(this._data.length===0){this._requisiteId=this._bankDetailId=0;return}this._requisiteId=parseInt(this.getSetting("requisiteId",0));this._bankDetailId=parseInt(this.getSetting("bankDetailId",0));var e=-1;var i=-1;for(var n=0;n<this._data.length;n++){var s=this._data[n];var a=s["bankDetailIdSelected"]=this.parseIntegerParam("bankDetailIdSelected",s);var r=s["requisiteId"]=this.parseIntegerParam("requisiteId",s);var o=s["entityTypeId"]=this.parseIntegerParam("entityTypeId",s);var l=s["entityId"]=this.parseIntegerParam("entityId",s);var h=s["selected"]=this.parseBooleanParam("selected",s);var d=this.parseJsonParam("requisiteData",s);s["viewData"]=BX.type.isPlainObject(d["viewData"])?d["viewData"]:{};var c=BX.type.isArray(d["bankDetailViewDataList"])?d["bankDetailViewDataList"]:[];var u=BX.type.isArray(d["deletedBankDetailList"])?d["deletedBankDetailList"]:[];var f={};for(var p=0;p<u.length;p++){f[u[p]]=true}if(c.length>0){var m=-1;var _=-1;var g=-1;for(var y=0;y<c.length;y++){var B=c[y];var I=B["pseudoId"]=this.parseIntegerParam("pseudoId",B);if(BX.prop.getBoolean(f,I,false)){B["isDeleted"]=true;continue}if(r===this._requisiteId&&I===this._bankDetailId){m=y}if(B["selected"]){_=y}if(a>0&&I===a){g=y}}if(m>=0){if(m!==_){if(_>=0){c[_]["selected"]=false}c[m]["selected"]=true}s["bankDetailIdSelected"]=c[m]["pseudoId"]}else if(g>=0){if(g!==_){if(_>=0){c[_]["selected"]=false}c[g]["selected"]=true;s["bankDetailIdSelected"]=c[g]["pseudoId"]}}else{if(_<0){_=0}s["bankDetailIdSelected"]=c[_]["pseudoId"]}}s["bankDetailViewDataList"]=c;this._items.push(s);if(h){i=n}if(this._requisiteId==r){e=n}}if(e>=0&&i>=0&&i!==e){this._items[i]["selected"]=false;this._items[e]["selected"]=true;i=e}var C=0;var X=0;if(i>=0){var b=this._items[i];if(b["requisiteId"]>0){C=b["requisiteId"]}if(b["bankDetailIdSelected"]>0){X=b["bankDetailIdSelected"]}}if(this._requisiteId!==C||this._bankDetailId!==X){this._requisiteId=C;this._bankDetailId=X}},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},parseStringParam:function(t,e,i){if(typeof i==="undefined"){i=""}var n=i;if(BX.type.isNotEmptyString(e[t])){n=e[t]}else{n=e[t].toString()}return n},parseIntegerParam:function(t,e,i){if(typeof i==="undefined"){i=0}var n=i;if(BX.type.isNumber(e[t])){n=e[t]}else if(BX.type.isNotEmptyString(e[t])){n=parseInt(e[t]);if(isNaN(n)){n=i}}return n},parseBooleanParam:function(t,e,i){if(typeof i==="undefined"){i=false}var n=i;if(BX.type.isBoolean(e[t])){n=e[t]}else if(BX.type.isNotEmptyString(e[t])){n=e[t].toLowerCase()==="true"}return n},parseJsonParam:function(t,e,i){if(typeof i==="undefined"){i={}}var n=i;if(BX.type.isNotEmptyString(e[t])){n=BX.parseJSON(e[t]);if(!BX.type.isPlainObject(n)){n={}}}return n},getRequisiteId:function(){return this._requisiteId},getBankDetailId:function(){return this._bankDetailId},getItems:function(){return this._items},getItemCount:function(){return this._items.length},getItemIndex:function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1},getItemByIndex:function(t){return t>=0&&t<this._items.length?this._items[t]:null},getItemByKey:function(t,e){for(var i=0,n=this._items.length;i<n;i++){var s=this._items[i];if(e==BX.prop.getString(s,t,"")){return s}}return null},getItemById:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(t==BX.prop.getInteger(n,"requisiteId",0)){return n}}return null},getSelectedItem:function(){for(var t=0,e=this._items.length;t<e;t++){var i=this._items[t];if(BX.prop.getBoolean(i,"selected",false)){return i}}return null},getFirstItem:function(){return this._items.length>0?this._items[0]:null},getItemBankDetailList:function(t){var e=this.getItemById(t);if(!e){return null}return BX.CrmEntityBankDetailList.create({items:BX.prop.getArray(e,"bankDetailViewDataList",[])})},getItemBankDetailById:function(t,e){var i=this.getItemById(t);if(!i){return null}var n=BX.prop.getArray(i,"bankDetailViewDataList",[]);for(var s=0,a=n.length;s<a;s++){var r=n[s];if(e==BX.prop.getInteger(r,"pseudoId",0)){return r}}return null},getSelectedItemBankDetail:function(t){var e=this.getItemById(t);if(!e){return null}var i=BX.prop.getArray(e,"bankDetailViewDataList",[]);for(var n=0,s=i.length;n<s;n++){var a=i[n];if(BX.prop.getBoolean(a,"selected",false)){return a}}return null},getFirstItemBankDetail:function(t){var e=this.getItemById(t);if(!e){return null}var i=BX.prop.getArray(e,"bankDetailViewDataList",[]);return i.length>0?i[0]:null}};BX.CrmEntityRequisiteInfo.resolveItemId=function(t){return BX.prop.getInteger(t,"requisiteId",0)};BX.CrmEntityRequisiteInfo.create=function(t){var e=new BX.CrmEntityRequisiteInfo;e.initialize(t);return e}}if(typeof BX.CrmMultipleEntitySummaryView==="undefined"){BX.CrmMultipleEntitySummaryView=function(){this._id="";this._settings={};this._index=0;this._entityCount=0;this._owner=null;this._entityType="";this._entityInfos=[];this._areEntitiesLoaded=false;this._loaderCfg=null;this._entitiesLoadHandler=BX.delegate(this.onLoadEntities,this);this._hasLayout=false;this._enableRequisites=false;this._enableRequisiteChange=false;this._readOnly=false;this._containerId="";this._container=null;this._wrapper=null;this._controlWrapper=null;this._views=[];this._navPrevButton=null;this._navNextButton=null;this._navPrevHandler=BX.delegate(this.onNavPrev,this);this._navNextHandler=BX.delegate(this.onNavNext,this);this._deleteHandler=BX.delegate(this.onDelete,this);this._deletionNotifier=null};BX.CrmMultipleEntitySummaryView.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._entityType=this.getSetting("entityType","");if(!BX.type.isNotEmptyString(this._entityType)){throw"CrmMultipleEntitySummaryView: Could not find 'entityType' parameter in settings."}this._container=this.getSetting("container","");if(!BX.type.isElementNode(this._container)){this._containerId=this.getSetting("containerId","");if(!BX.type.isNotEmptyString(this._containerId)){throw"CrmMultipleEntitySummaryView: Could not find 'containerId' parameter in settings."}this._container=BX(this._containerId);if(!BX.type.isElementNode(this._container)){throw"CrmMultipleEntitySummaryView: Could not find container element."}}this._entityInfos=this.getSetting("entityInfos",[]);if(!BX.type.isArray(this._entityInfos)){throw"CrmMultipleEntitySummaryView: Could not find 'entityInfos' parameter in settings."}this._entityCount=parseInt(this.getSetting("count",0));this._areEntitiesLoaded=this._entityInfos.length===this._entityCount;if(!this._areEntitiesLoaded){this._entityType=this.getSetting("entityType","");if(!BX.type.isNotEmptyString(this._entityType)){throw"CrmMultipleEntitySummaryView: Could not find 'entityType' parameter in settings."}this._owner=this.getSetting("owner",null);if(!BX.type.isPlainObject(this._owner)){throw"CrmMultipleEntitySummaryView: Could not find owner config."}this._loaderCfg=this.getSetting("loader",null);if(!BX.type.isPlainObject(this._loaderCfg)){throw"CrmMultipleEntitySummaryView: Could not find loader config."}}this._readOnly=!!this.getSetting("readOnly");this._enableRequisites=!!this.getSetting("enableRequisites",true);this._enableRequisiteChange=this._enableRequisites&&!this._readOnly?!!this.getSetting("enableRequisiteChange",true):false;this._deletionNotifier=BX.CrmNotifier.create(this)},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getMessage:function(t){var e=BX.CrmMultipleEntitySummaryView.messages;return e.hasOwnProperty(t)?e[t]:t},getContainerId:function(){return this._containerId},addDeletionListener:function(t){this._deletionNotifier.addListener(t)},removeDeletionListener:function(t){this._deletionNotifier.removeListener(t)},layout:function(){if(this._hasLayout){return}var t=this._wrapper=BX.create("DIV",{attrs:{className:"crm-client-selector-tabs-wrap-slider-container"}});this._container.appendChild(t);var e=BX.create("DIV",{attrs:{className:"crm-client-selector-tabs-wrap-slider-container-overflow"}});t.appendChild(e);var i=this._controlWrapper=BX.create("DIV",{attrs:{className:"crm-offer-tabs-wrap-slide-box"},style:{width:(100*this._entityCount).toString()+"%"}});e.appendChild(i);this._navPrevButton=BX.create("DIV",{attrs:{className:"crm-offer-tabs-wrap-slider-arrow crm-offer-tabs-wrap-slider-arrow-left"}});t.appendChild(this._navPrevButton);BX.bind(this._navPrevButton,"click",this._navPrevHandler);this._navNextButton=BX.create("DIV",{attrs:{className:"crm-offer-tabs-wrap-slider-arrow crm-offer-tabs-wrap-slider-arrow-right"}});t.appendChild(this._navNextButton);BX.bind(this._navNextButton,"click",this._navNextHandler);this.initializaControls();this._hasLayout=true},initializaControls:function(){var t=(100/this._entityCount).toFixed(5)+"%";for(var e=0;e<this._entityCount;e++){var i=e<this._entityInfos.length?this._entityInfos[e]:null;var n=!(i instanceof BX.CrmEntityInfo)&&!BX.type.isPlainObject(i);var s=BX.CrmEntitySummaryView.create(this._id+"_"+e.toString(),{entityInfo:i,requisiteInfo:null,container:this._controlWrapper,width:t,readOnly:this._readOnly,enableRequisites:this._enableRequisites,enableRequisiteChange:this._enableRequisiteChange,isStub:n});this._views.push(s);if(!this._readOnly){s.addDeletionListener(this._deleteHandler)}s.layout()}},resetControls:function(){for(var t=0;t<this._views.length;t++){this._views[t].clearLayout()}this._views=[]},clearLayout:function(){if(!this._hasLayout){return}this.resetControls();if(this._wrapper){this._wrapper=BX.remove(this._wrapper)}this._hasLayout=false},getIndex:function(){return this._index},setIndex:function(t){if(this._index===t){return}this._index=t;this.adjust();if(!this._areEntitiesLoaded){this.loadEntities()}},adjust:function(){var t=this._entityCount-1;if(this._index<0){this._index=t}else if(this._index>t){this._index=0}this._controlWrapper.style.left=this._index>0?(-100*this._index).toString()+"%":"0";if(this._index<this._views.length){this._views[this._index].adjust()}},loadEntities:function(){if(this._areEntitiesLoaded){return}this._dataLoader=BX.CrmDataLoader.create(this._id,{serviceUrl:this._loaderCfg["url"],action:this._loaderCfg["action"],params:{OWNER_TYPE_NAME:this._owner["typeName"],OWNER_ID:this._owner["id"],ENTITY_TYPE_NAME:this._entityType}});this._dataLoader.load(this._entitiesLoadHandler)},onLoadEntities:function(t,e){this._entityInfos=e["DATA"];this._entityCount=this._entityInfos.length;this._areEntitiesLoaded=true;if(this._hasLayout){this.resetControls();this.initializaControls()}},onNavPrev:function(t){this.setIndex(this._index-1)},onNavNext:function(t){this.setIndex(this._index+1)},onDelete:function(t){this._deletionNotifier.notify([t])}};BX.CrmMultipleEntitySummaryView.create=function(t,e){var i=new BX.CrmMultipleEntitySummaryView;i.initialize(t,e);return i}}if(typeof BX.CrmEntitySummaryView==="undefined"){BX.CrmEntitySummaryView=function(){this._id="";this._settings={};this._hasLayout=false;this._container=null;this._entityInfo=null;this._requisiteInfo=null;this._waiter=null;this._width="";this._clientPanel=null;this._enableRequisiteChange=false;this._enableRequisites=false;this._readOnly=false;this._isStub=false;this._deleteHandler=BX.delegate(this.onDelete,this);this._requisiteChangeHandler=BX.delegate(this.onRequisiteChange,this);this._deletionNotifier=null;this._requisiteChangeNotifier=null};BX.CrmEntitySummaryView.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){var i=this.getSetting("containerId","");if(BX.type.isNotEmptyString(i)){this._container=BX(i)}if(!BX.type.isElementNode(this._container)){throw"CrmEntitySummaryView: Could not find 'container' parameter in settings."}}var n=this.getSetting("entityInfo");this._entityInfo=n instanceof BX.CrmEntityInfo?n:BX.CrmEntityInfo.create(n);this._width=this.getSetting("width","");this._readOnly=!!this.getSetting("readOnly");this._enableRequisites=!!this.getSetting("enableRequisites",true);this._enableRequisiteChange=this._enableRequisites&&!this._readOnly?!!this.getSetting("enableRequisiteChange",true):false;if(this._enableRequisites){var s=this.getSetting("requisiteInfo");if(s instanceof BX.CrmEntityRequisiteInfo){this._requisiteInfo=s}else{this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:0,bankDetailId:0,data:this._entityInfo.getRequisites()})}}this._isStub=!!this.getSetting("isStub");this._requisiteChangeNotifier=BX.CrmNotifier.create(this);this._deletionNotifier=BX.CrmNotifier.create(this)},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getEntityInfo:function(){return this._entityInfo},getMessage:function(t){var e=BX.CrmEntitySummaryView.messages;return e.hasOwnProperty(t)?e[t]:t},isStub:function(){return this._isStub},adjust:function(){if(this._isStub&&this._waiter){this._waiter.firstElementChild.style.minHeight=BX.pos(this._container)["height"]+"px"}},layout:function(){if(this._hasLayout){return}if(this._isStub){this._waiter=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-block-wrap"},children:[BX.create("DIV",{attrs:{className:"crm-offer-tabs-wrap-slide-waiter"}})]});if(this._width!==""){this._waiter.style.width=this._width}this._container.appendChild(this._waiter);window.setTimeout(BX.delegate(this.adjust,this),500)}else if(this._entityInfo.getId()>0){this._clientPanel=BX.CrmClientPanel.create("",{container:this._container,entityInfo:this._entityInfo,requisiteInfo:this._requisiteInfo,readOnly:this._readOnly,enableRequisites:this._enableRequisites,requisiteServiceUrl:this.getSetting("requisiteServiceUrl"),width:this._width});if(!this._readOnly){this._clientPanel.addDeletionListener(this._deleteHandler)}if(this._enableRequisites){this._clientPanel.addRequisiteChangeListener(this._requisiteChangeHandler)}this._clientPanel.layout()}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}if(this._clientPanel){this._clientPanel.clearLayout();this._clientPanel=null}if(this._waiter){this._waiter=BX.remove(this._waiter)}this._hasLayout=false},addRequisiteChangeListener:function(t){this._requisiteChangeNotifier.addListener(t)},removeRequisiteChangeListener:function(t){this._requisiteChangeNotifier.removeListener(t)},addDeletionListener:function(t){this._deletionNotifier.addListener(t)},removeDeletionListener:function(t){this._deletionNotifier.removeListener(t)},onDelete:function(t){this._deletionNotifier.notify()},onRequisiteChange:function(t,e,i){this._requisiteChangeNotifier.notify([e,i])}};if(typeof BX.CrmEntitySummaryView.messages==="undefined"){BX.CrmMultipleEntitySummaryView.messages={}}BX.CrmEntitySummaryView.create=function(t,e){var i=new BX.CrmEntitySummaryView;i.initialize(t,e);return i}}if(typeof BX.CrmClientPanel==="undefined"){BX.CrmClientPanel=function(){this._id="";this._settings={};this._entityInfo=null;this._requisiteInfo=null;this._readOnly=false;this._hasLayout=false;this._container=null;this._wrapper=null;this._width="";this._tabs={};this._multifieldPanel=null;this._requisitePanel=null;this._activeTab="";this._mainTabHandler=BX.delegate(this.onMainTabClick,this);this._requisiteTabHandler=BX.delegate(this.onRequisiteTabClick,this);this._requisiteChangeHandler=BX.delegate(this.onRequisiteChange,this);this._deleteButtonHandler=BX.delegate(this.onDeleteButtonClick,this);this._readOnly=false;this._enableRequisites=false;this._enableRequisiteChange=false;this._requisiteChangeNotifier=null;this._deletionNotifier=null};BX.CrmClientPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"CRM_CLIENT_PANEL_"+Math.random();this._settings=BX.type.isPlainObject(e)?e:{};this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"CrmClientPanel: Could not find 'container' parameter in settings."}this._entityInfo=this.getSetting("entityInfo");if(!(this._entityInfo instanceof BX.CrmEntityInfo)){throw"CrmClientPanel: Could not find 'entityInfo' parameter in settings."}this._readOnly=!!this.getSetting("readOnly");this._enableRequisites=!!this.getSetting("enableRequisites",true);this._enableRequisiteChange=this._enableRequisites&&!this._readOnly?!!this.getSetting("enableRequisiteChange",true):false;this._width=this.getSetting("width","");if(this._enableRequisites){this._requisiteInfo=this.getSetting("requisiteInfo");if(!(this._requisiteInfo instanceof BX.CrmEntityRequisiteInfo)){throw"CrmClientPanel: Could not find 'requisiteInfo' parameter in settings."}}this._requisiteChangeNotifier=BX.CrmNotifier.create(this);this._deletionNotifier=BX.CrmNotifier.create(this)},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getMessage:function(t){var e=BX.CrmClientPanel.messages;return e.hasOwnProperty(t)?e[t]:t},layout:function(){if(this._hasLayout){return}var t=this._wrapper=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-block-wrap"}});if(this._width!==""){this._wrapper.style.width=this._width}this._container.appendChild(t);var e=this._entityInfo.getTypeName();if(e===BX.CrmEntityType.names.contact){BX.addClass(t,"crm-client-selector-tab-contact")}else if(e===BX.CrmEntityType.names.company){BX.addClass(t,"crm-client-selector-tab-company")}var i=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-block"}});t.appendChild(i);var n=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-title"}});i.appendChild(n);var s=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-resp-img"}});var a=this._entityInfo.getLargeImageUrl();if(a!==""){s.appendChild(BX.create("IMG",{attrs:{src:a}}))}n.appendChild(s);var r=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-title-name-block"}});n.appendChild(r);r.appendChild(BX.create("DIV",{attrs:{className:"crm-client-selector-tab-title-name"},children:[BX.create("A",{attrs:{className:"crm-offer-tab-title-name",href:this._entityInfo.getShowUrl(),target:"_blank"},text:this._entityInfo.getTitle()})]}));r.appendChild(BX.create("DIV",{attrs:{className:"crm-client-selector-tab-title-descript"},text:this._entityInfo.getDescription()}));if(!this._readOnly){var o=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-close-btn"}});n.appendChild(o);BX.bind(o,"click",this._deleteButtonHandler)}var l=this._entityInfo.hasMultiFields();var h=this._enableRequisites&&this._entityInfo.hasRequisites();if(l||h){var d=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-main-cont-wrap"}});i.appendChild(d);var c=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-list-wrap"}});d.appendChild(c);var u=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-cont-wrap"}});d.appendChild(u);if(l){var f="";if(e===BX.CrmEntityType.names.contact){f=this.getMessage("contact")}else if(e===BX.CrmEntityType.names.company){f=this.getMessage("company")}var p=BX.create("SPAN",{attrs:{className:"crm-offer-tab crm-client-selector-tab-active"},children:[BX.create("SPAN",{attrs:{className:"crm-client-selector-tab-text"},text:f})]});c.appendChild(p);BX.bind(p,"click",this._mainTabHandler);var m=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-cont"}});u.appendChild(m);this._tabs["main"]={button:p,node:m}}if(h){var _="";if(e===BX.CrmEntityType.names.contact){_=this.getMessage("contactRequisites")}else if(e===BX.CrmEntityType.names.company){_=this.getMessage("companyRequisites")}var g=BX.create("SPAN",{attrs:{className:"crm-offer-tab"},children:[BX.create("SPAN",{attrs:{className:"crm-client-selector-tab-text"},text:_})]});c.appendChild(g);BX.bind(g,"click",this._requisiteTabHandler);var y=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-cont"}});u.appendChild(y);this._tabs["requisite"]={button:g,node:y}}}if(l){this.setActiveTab("main")}else if(h){this.setActiveTab("requisite")}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}if(this._multifieldPanel){this._multifieldPanel.clearLayout();this._multifieldPanel=null}if(this._wrapper){this._wrapper=BX.remove(this._wrapper)}this._hasLayout=false},setActiveTab:function(t){if(t!=="main"&&t!=="requisite"){t="main"}if(this._activeTab===t||typeof this._tabs[t]==="undefined"){return}var e=this._tabs[t];if(t==="main"){if(!this._multifieldPanel){this._multifieldPanel=BX.CrmClientMultiFieldPanel.create(this._id,{container:e["node"],entityInfo:this._entityInfo});this._multifieldPanel.layout()}}else if(t==="requisite"){if(!this._requisitePanel){this._requisitePanel=BX.CrmClientRequisitePanel.create(this._id,{container:e["node"],entityInfo:this._entityInfo,requisiteInfo:this._requisiteInfo,requisiteServiceUrl:this.getSetting("requisiteServiceUrl"),readOnly:this._readOnly||!this._enableRequisiteChange});this._requisitePanel.addChangeListener(this._requisiteChangeHandler);this._requisitePanel.layout()}}for(var i in this._tabs){if(!this._tabs.hasOwnProperty(i)){continue}var n=this._tabs[i];if(t===i){n["node"].style.display="";BX.addClass(n["button"],"crm-client-selector-tab-active")}else{n["node"].style.display="none";BX.removeClass(n["button"],"crm-client-selector-tab-active")}}this._activeTab=t},addRequisiteChangeListener:function(t){this._requisiteChangeNotifier.addListener(t)},removeRequisiteChangeListener:function(t){this._requisiteChangeNotifier.removeListener(t)},addDeletionListener:function(t){this._deletionNotifier.addListener(t)},removeDeletionListener:function(t){this._deletionNotifier.removeListener(t)},onMainTabClick:function(t){this.setActiveTab("main")},onRequisiteTabClick:function(t){this.setActiveTab("requisite")},onDeleteButtonClick:function(t){this._deletionNotifier.notify()},onRequisiteChange:function(t,e,i){this._requisiteChangeNotifier.notify([e,i])}};if(typeof BX.CrmClientPanel.messages==="undefined"){BX.CrmClientPanel.messages={}}BX.CrmClientPanel.create=function(t,e){var i=new BX.CrmClientPanel;i.initialize(t,e);return i}}if(typeof BX.CrmClientMultiFieldPanel==="undefined"){BX.CrmClientMultiFieldPanel=function(){this._id="";this._settings={};this._hasLayout=false;this._container=null;this._wrapper=null;this._entityInfo=null;this._items=[]};BX.CrmClientMultiFieldPanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"CRM_CLIENT_MULTIFIELDS"+Math.random();this._settings=e?e:{};this._entityInfo=this.getSetting("entityInfo");if(!(this._entityInfo instanceof BX.CrmEntityInfo)){throw"CrmClientMultiFieldPanel: Could not find 'entityInfo' parameter in settings."}this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"CrmClientMultiFieldPanel: Could not find 'container' parameter in settings."}},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getEntityId:function(){return this._entityInfo.getId()},getEntityTypeName:function(){return this._entityInfo.getTypeName()},createItem:function(t,e){var i=BX.CrmClientPanelCommunication.create("",{container:e,entityId:this.getEntityId(),entityType:this.getEntityTypeName(),fieldInfo:t});i.layout();this._items.push(i)},layout:function(){if(this._hasLayout){return}var t=this._wrapper=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-info"}});this._container.appendChild(t);var e,i,n,s;e=BX.create("TABLE",{attrs:{className:"crm-client-selector-tab-table"}});t.appendChild(e);i=e.insertRow(-1);var a,r;a=this._entityInfo.getPhones();r=a.length;if(r>0){n=i.insertCell(-1);n.className="crm-client-selector-tab-cell";for(s=0;s<r;s++){this.createItem(a[s],n)}}a=this._entityInfo.getEmails();r=a.length;if(r>0){n=i.insertCell(-1);n.className="crm-client-selector-tab-cell";for(s=0;s<r;s++){this.createItem(a[s],n)}}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}if(this._items.length>0){for(var t=0;t<this._items.length;t++){this._items[t].clearLayout()}this._items=[]}if(this._wrapper){this._wrapper=BX.remove(this._wrapper)}this._hasLayout=false}};BX.CrmClientMultiFieldPanel.create=function(t,e){var i=new BX.CrmClientMultiFieldPanel;i.initialize(t,e);return i}}if(typeof BX.CrmClientPanelCommunication==="undefined"){BX.CrmClientPanelCommunication=function(){this._id="";this._settings={};this._entityTypeName="";this._entityId=0;this._fieldInfo={};this._hasLayout=false;this._container=null;this._wrapper=null;this._link=null;this._button=null;this._buttonHandler=BX.delegate(this.onButtonClick,this)};BX.CrmClientPanelCommunication.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"CRM_CLIENT_COMM"+Math.random();this._settings=e?e:{};this._fieldInfo=this.getSetting("fieldInfo");if(!BX.type.isPlainObject(this._fieldInfo)){throw"CrmClientPanelCommunication: Could not find 'fieldInfo' parameter in settings."}this._entityTypeName=this.getSetting("entityType","");this._entityId=this.getSetting("entityId",0);this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"CrmClientPanelCommunication: Could not find 'container' parameter in settings."}},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getTypeName:function(){return BX.type.isNotEmptyString(this._fieldInfo["TYPE"])?this._fieldInfo["TYPE"]:""},getValue:function(){return BX.type.isNotEmptyString(this._fieldInfo["VALUE"])?this._fieldInfo["VALUE"]:""},layout:function(){if(this._hasLayout){return}var t=this._wrapper=BX.create("DIV",{attrs:{className:"crm-client-contacts-block"}});this._container.appendChild(t);var e,i,n;var s=this.getTypeName();var a=this.getValue();var r=BX.util.htmlspecialchars(a);if(s==="PHONE"){var o=BX.CrmClientPanelCommunication.callToFormat;e=BX.create("SPAN",{attrs:{className:"crm-client-contacts-block-text crm-client-contacts-block-handset"}});t.appendChild(e);this._link=BX.create("A",{attrs:{className:"crm-client-contacts-block-text-tel"},props:{href:(o===BX.CrmCalltoFormat.standard?"callto://":"callto:")+r,title:r},text:a});if(o===BX.CrmCalltoFormat.bitrix){BX.bind(this._link,"click",this._buttonHandler)}e.appendChild(this._link);this._button=BX.create("SPAN",{attrs:{className:"crm-client-contacts-block-text-tel-icon"}});e.appendChild(this._button);BX.bind(this._button,"click",this._buttonHandler)}else if(s==="EMAIL"){e=BX.create("SPAN",{attrs:{className:"crm-client-contacts-block-text crm-client-contacts-block-handset"}});t.appendChild(e);this._link=BX.create("A",{attrs:{className:"crm-client-contacts-block-text-mail"},props:{href:"mailto:"+r,title:r},text:a});e.appendChild(this._link);this._button=BX.create("SPAN",{attrs:{className:"crm-client-contacts-block-text-mail-icon"}});e.appendChild(this._button);BX.bind(this._button,"click",this._buttonHandler)}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}if(this._link){this._link=BX.remove(this._link)}if(this._button){BX.unbind(this._button,"click",this._buttonHandler);this._button=BX.remove(this._button)}if(this._wrapper){this._wrapper=BX.remove(this._wrapper)}this._hasLayout=false},onButtonClick:function(t){var e=this.getTypeName();if(e==="EMAIL"){this._link.click()}else if(e==="PHONE"&&typeof BX.CrmSipManager!=="undefined"){BX.CrmSipManager.startCall({number:this.getValue(),enableInfoLoading:true},{ENTITY_TYPE:BX.CrmSipManager.resolveSipEntityTypeName(this._entityTypeName),ENTITY_ID:this._entityId},true,this._button)}return BX.PreventDefault(t)}};if(typeof BX.CrmClientPanelCommunication.callToFormat!=="undefined"){BX.CrmClientPanelCommunication.callToFormat=BX.CrmCalltoFormat.bitrix}BX.CrmClientPanelCommunication.create=function(t,e){var i=new BX.CrmClientPanelCommunication;i.initialize(t,e);return i}}if(typeof BX.CrmClientRequisitePanel==="undefined"){BX.CrmClientRequisitePanel=function(){this._id="";this._settings={};this._hasLayout=false;this._container=null;this._wrapper=null;this._entityInfo=null;this._requisiteInfo=null;this._requisiteId=0;this._bankDetailId=0;this._readOnly=false;this._selectorName="";this._items=null;this._changeNotifier=null;this._itemSelectHandler=BX.delegate(this.onItemSelect,this);this._itemBankDetailSelectHandler=BX.delegate(this.onItemBankDetailSelect,this)};BX.CrmClientRequisitePanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"CRM_CLIENT_REQUISITE"+Math.random();this._settings=e?e:{};this._entityInfo=this.getSetting("entityInfo");if(!(this._entityInfo instanceof BX.CrmEntityInfo)){throw"CrmClientRequisitePanel: Could not find 'entityInfo' parameter in settings."}this._requisiteInfo=this.getSetting("requisiteInfo");if(!(this._requisiteInfo instanceof BX.CrmEntityRequisiteInfo)){throw"CrmClientRequisitePanel: Could not find 'requisiteInfo' parameter in settings."}this._requisiteId=this._requisiteInfo.getRequisiteId();this._bankDetailId=this._requisiteInfo.getBankDetailId();this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"CrmClientRequisitePanel: Could not find 'container' parameter in settings."}this._readOnly=!!this.getSetting("readOnly");this._changeNotifier=BX.CrmNotifier.create(this)},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getRequisiteId:function(){return this._requisiteId},setRequisiteId:function(t){this._requisiteId=t;this._changeNotifier.notify([this._requisiteId,this._bankDetailId])},getBankDetailId:function(){return this._bankDetailId},setBankDetailId:function(t){this._bankDetailId=t;this._changeNotifier.notify([this._requisiteId,this._bankDetailId]);this.saveSettings()},setup:function(t,e){if(this._requisiteId===t&&this._bankDetailId===e){return}this._requisiteId=t;this._bankDetailId=e;this._changeNotifier.notify([this._requisiteId,this._bankDetailId]);this.saveSettings()},saveSettings:function(){var t=this.getSetting("requisiteServiceUrl");if(!BX.type.isNotEmptyString(t)){return}BX.ajax.post(t,{action:"savelastselectedrequisite",requisiteEntityTypeId:this._entityInfo.getTypeId(),requisiteEntityId:this._entityInfo.getId(),requisiteId:this._requisiteId,bankDetailId:this._bankDetailId})},layout:function(){if(this._hasLayout){return}var t=this._wrapper=BX.create("FORM");this._container.appendChild(t);this._items=[];var e=this._requisiteInfo.getItems();var i=this._selectorName=this._id;for(var n=0;n<e.length;n++){var s=e[n];if(!BX.type.isNotEmptyString(s["viewData"]["title"])&&BX.type.isArray(s["viewData"]["fields"])){continue}var a=BX.CrmClientRequisitePanelItem.create(i+"_"+(this._items.length+1),{name:i,container:t,data:{requisiteId:s["requisiteId"],entityTypeId:s["entityTypeId"],entityId:s["entityId"],viewData:s["viewData"],bankDetailViewDataList:s["bankDetailViewDataList"],bankDetailIdSelected:s["bankDetailIdSelected"]},isSelected:s["selected"],readOnly:this._readOnly});this._items.push(a);a.addChangeListener(this._itemSelectHandler);a.addBankDetailSelectListener(this._itemBankDetailSelectHandler);a.layout()}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}if(this._wrapper){this._wrapper=BX.remove(this._wrapper)}this._hasLayout=false},addChangeListener:function(t){this._changeNotifier.addListener(t)},removeChangeListener:function(t){this._changeNotifier.removeListener(t)},onItemSelect:function(t){if(!t.isSelected()){return}for(var e=0;e<this._items.length;e++){if(this._items[e]!==t){this._items[e].setSelected(false,true)}}this.setup(t.getRequisiteId(),t.getBankingDetailId())},onItemBankDetailSelect:function(t){if(!t.isSelected()){return}this.setBankDetailId(t.getBankingDetailId())}};BX.CrmClientRequisitePanel.create=function(t,e){var i=new BX.CrmClientRequisitePanel;i.initialize(t,e);return i}}if(typeof BX.CrmClientRequisitePanelItem==="undefined"){BX.CrmClientRequisitePanelItem=function(){this._id="";this._settings={};this._name="";this._readOnly=false;this._data=null;this._container=null;this._wrapper=null;this._selector=null;this._hasLayout=false;this._readOnly=false;this._isHighlighted=false;this._isSelected=false;this._selectHandler=BX.delegate(this.onSelect,this);this._bankDetailSelectHandler=BX.delegate(this.onBankDetailsSelect,this);this._clickHandler=BX.delegate(this.onClick,this);this._changeNotifier=null;this._bankDetailSelectNotifier=null};BX.CrmClientRequisitePanelItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"CRM_CLIENT_REQUISITE_ITEM"+Math.random();this._settings=e?e:{};this._name=this.getSetting("name","");this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"CrmClientRequisitePanelItem: Could not find 'container' parameter in settings."}this._data=this.getSetting("data");if(!BX.type.isPlainObject(this._data)){throw"CrmClientRequisitePanelItem: Could not find 'data' parameter in settings."}this._isSelected=!!this.getSetting("isSelected");this._readOnly=!!this.getSetting("readOnly");this._changeNotifier=BX.CrmNotifier.create(this);this._bankDetailSelectNotifier=BX.CrmNotifier.create(this)},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getMessage:function(t){var e=BX.CrmClientRequisitePanelItem.messages;return e.hasOwnProperty(t)?e[t]:t},getRequisiteId:function(){return this._data["requisiteId"]},isSelected:function(){return this._isSelected},setSelected:function(t,e){t=!!t;if(this._isSelected===t){return}this._isSelected=t;if(this._selector.checked!=this._isSelected){this._selector.checked=this._isSelected}this.setHighlighted(this._isSelected);if(!e){this._changeNotifier.notify()}},isHighlighted:function(){return this._isHighlighted},setHighlighted:function(t){if(!this._hasLayout){return}t=!!t;if(this._isHighlighted===t){return}this._isHighlighted=t;this.adjust()},getBankingDetailId:function(){return this._data["bankDetailIdSelected"]},setBankingDetailId:function(t){if(!BX.type.isNumber(t)){t=parseInt(t)}if(isNaN(t)||t<0){t=0}this._data["bankDetailIdSelected"]=t},getData:function(){return this._data},save:function(){this._isSelected=this._selector.checked},adjust:function(){if(this._isSelected){BX.addClass(this._wrapper,"crm-offer-requisite-active")}else{BX.removeClass(this._wrapper,"crm-offer-requisite-active")}},layout:function(){if(this._hasLayout){return}this._selector=BX.create("INPUT",{attrs:{id:this._id,className:"crm-offer-requisite-inp",type:"radio",name:this._name,value:this._data["requisiteId"]},props:{checked:this._isSelected}});if(this._readOnly){this._selector.disabled="disabled"}else{BX.bind(this._selector,"click",this._selectHandler)}this._wrapper=BX.create("DIV",{attrs:{className:"crm-offer-requisite"},children:[BX.create("DIV",{attrs:{className:"crm-offer-requisite-title"},children:[this._selector,BX.create("LABEL",{attrs:{className:"crm-offer-requisite-lable",for:this._id},html:BX.util.htmlspecialchars(this._data["viewData"]["title"])})]})]});this._container.appendChild(this._wrapper);if(!this._readOnly){BX.bind(this._wrapper,"click",this._clickHandler)}var t=this._data["viewData"]["fields"];var e=this._data["bankDetailViewDataList"];if(t.length>0||e.length>0){var i=BX.create("TABLE",{attrs:{className:"crm-offer-tab-table"}});this._wrapper.appendChild(i);for(var n=0;n<t.length;n++){var s=t[n];var a=i.insertRow(-1);var r=a.insertCell(-1);r.className="crm-offer-tab-cell";r.innerHTML=(s["title"]?BX.util.htmlspecialchars(s["title"]):"")+":";r=a.insertCell(-1);r.className="crm-offer-tab-cell";r.innerHTML=s["textValue"]?BX.util.nl2br(BX.util.htmlspecialchars(s["textValue"])):""}var o=this.prepareBankDetails(this._data);if(o){a=i.insertRow(-1);r=a.insertCell(-1);r.className="crm-offer-tab-cell";r.innerHTML=BX.util.htmlspecialchars(this.getMessage("bankDetails")+":");r=a.insertCell(-1);r.className="crm-offer-tab-cell";r.appendChild(o)}}this._hasLayout=true;this.setHighlighted(this._isSelected)},clearLayout:function(){if(!this._hasLayout){return}if(this._selector&&!this._readOnly){BX.unbind(this._selector,"click",this._selectHandler)}if(this._wrapper){BX.unbind(this._wrapper,"click",this._clickHandler);this._wrapper=BX.remove(this._wrapper)}this._hasLayout=false},prepareBankDetails:function(t){if(!BX.type.isPlainObject(t)){return null}var e=parseInt(t["requisiteId"]);var i=BX.type.isArray(t["bankDetailViewDataList"])?t["bankDetailViewDataList"]:[];if(!(e>0&&i.length>0)){return null}var n=null;var s=this._id+"_RQ_"+e+"_BD";for(var a=0;a<i.length;a++){var r=i[a];if(!(typeof r["pseudoId"]!=="undefined"&&BX.type.isPlainObject(r["viewData"])&&BX.type.isNotEmptyString(r["viewData"]["title"])&&BX.type.isArray(r["viewData"]["fields"]))){continue}var o=r["pseudoId"];var l=s+"_"+o;if(n===null){n=BX.create("DIV")}var h=BX.create("INPUT",{attrs:{id:l,className:"crm-offer-bankdetail-inp",type:"radio",name:s,value:o},props:{checked:r["selected"]===true},events:{click:this._bankDetailSelectHandler}});if(this._readOnly){h.disabled="disabled"}n.appendChild(BX.create("DIV",{children:[h,BX.create("LABEL",{attrs:{for:l},html:BX.util.htmlspecialchars(r["viewData"]["title"])})]}))}return n},addChangeListener:function(t){this._changeNotifier.addListener(t)},removeChangeListener:function(t){this._changeNotifier.removeListener(t)},addBankDetailSelectListener:function(t){this._bankDetailSelectNotifier.addListener(t)},removeBankDetailListener:function(t){this._bankDetailSelectNotifier.removeListener(t)},onSelect:function(t){this.setSelected(this._selector.checked)},onClick:function(t){if(!this._readOnly&&!this._isSelected){this.setSelected(true)}},onBankDetailsSelect:function(t){t=t||window.event;var e=t.target||t.srcElement;if(BX.type.isElementNode(e)){this.setBankingDetailId(e.value);this._bankDetailSelectNotifier.notify()}}};if(typeof BX.CrmClientRequisitePanelItem.messages==="undefined"){BX.CrmClientRequisitePanelItem.messages={}}BX.CrmClientRequisitePanelItem.create=function(t,e){var i=new BX.CrmClientRequisitePanelItem;i.initialize(t,e);return i}}if(typeof BX.CrmCompositeClientSelector==="undefined"){BX.CrmCompositeClientSelector=function(){this._id="";this._settings={};this._owner=null;this._primaryEntityInfo=null;this._secondaryEntityInfos=null;this._secondaryEntityTypeName="";this._additionalData=null;this._primaryView=null;this._auxiliaryGroup=null;this._primaryEntityTypeInpuId="";this._primaryEntityInputId="";this._secondaryEntitiesInputId="";this._requisiteInputId="";this._bankDetailInputId="";this._containerId="";this._container=null;this._wrapper=null;this._waiterWrapper=null;this._enableMultiplicity=true;this._readOnly=false;this._hasLayout=false;this._entityTypeName="";this._entitySelectorId="";this._typeSelectorButton=null;this._typeSelectorButtonContent=null;this._entitySelectorButton=null;this._entityCreationButton=null;this._selectorMenu=null;this._externalRequestData=null;this._externalEventHandler=null;this._typeSelectorClickHandler=BX.delegate(this.onTypeSelectorClick,this);this._entitySelectClickHandler=BX.delegate(this.onEntitySelectClick,this);this._entityCreateClickHandler=BX.delegate(this.onEntityCreateClick,this);this._typeSelectHandler=BX.delegate(this.onTypeSelect,this);this._entitySelectHandler=BX.delegate(this.onEntitySelect,this);this._contactGroupChangeHandler=BX.delegate(this.onContactGroupChange,this);this._deletePrimaryViewHandler=BX.delegate(this.onPrimaryViewDelete,this);this._requisiteChangeHandler=BX.delegate(this.onRequisiteChange,this);this._waiterTimeoutId=0};BX.CrmCompositeClientSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._containerId=this.getSetting("containerId","");if(!BX.type.isNotEmptyString(this._containerId)){throw"CrmCompositeClientSelector: Could not find 'containerId' parameter in settings."}this._container=BX(this._containerId);if(!BX.type.isElementNode(this._container)){throw"CrmCompositeClientSelector: Could not find container element."}this._owner=this.getSetting("owner",null);if(!BX.type.isPlainObject(this._owner)){throw"CrmCompositeClientSelector: Could not find owner config."}this._readOnly=!!this.getSetting("readOnly",false);this._enableMultiplicity=!!this.getSetting("enableMultiplicity",true);if(!this._readOnly){this._primaryEntityTypeInpuId=this.getSetting("primaryEntityTypeInpuId","");this._primaryEntityInputId=this.getSetting("primaryEntityInputId","");this._secondaryEntitiesInputId=this.getSetting("secondaryEntitiesInputId","");this._requisiteInputId=this.getSetting("requisiteInputId","");this._bankDetailInputId=this.getSetting("bankDetailInputId","")}var i=this.getSetting("additionalData");this._additionalData=BX.type.isPlainObject(i)?i:{};var n=this.getSetting("primaryEntityData");var s=BX.type.isPlainObject(n)?BX.CrmEntityInfo.create(n):null;this.setPrimaryEntity(s);if(s){this.setEntityTypeName(s.getTypeName())}else{this.setEntityTypeName(this.getSetting("primaryEntityType"))}this._secondaryEntityTypeName=this.getSetting("secondaryEntityType");var a=this.getSetting("secondaryEntityData");if(!BX.type.isArray(a)){a=[]}this._secondaryEntityInfos=[];for(var r=0;r<a.length;r++){var o=BX.CrmEntityInfo.create(a[r]);if(o.getId()>0){this._secondaryEntityInfos.push(o)}}this._entitySelectorId=this._id+"_PRIMARY_ENTITY_SELECTOR";var l=this.getSetting("selectorSearchOptions",{});this._selectorSearchOptions=BX.type.isPlainObject(l)?l:{}},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getMessage:function(t){var e=BX.CrmCompositeClientSelector.messages;return e.hasOwnProperty(t)?e[t]:t},getEntityTypeName:function(){return this._entityTypeName},setEntityTypeName:function(t){if(this._entityTypeName===t){return}this._entityTypeName=t;if(this._hasLayout){this._typeSelectorButtonContent.innerHTML=BX.util.htmlspecialchars(BX.CrmEntityType.getCaptionByName(this._entityTypeName)+" ");this.prepareEntitySelector()}},getPrimaryEntity:function(){return this._primaryEntityInfo},setPrimaryEntity:function(t){var e=BX(this._primaryEntityTypeInpuId);var i=BX(this._primaryEntityInputId);if(this._primaryEntityInfo){this._primaryEntityInfo=null;if(e){e.value=""}if(i){i.value=""}}if(this._primaryEntityRequisiteInfo){this._primaryEntityRequisiteInfo=null}if(t instanceof BX.CrmEntityInfo){this._primaryEntityInfo=t;if(e){e.value=this._primaryEntityInfo.getTypeName()}if(i){i.value=this._primaryEntityInfo.getId()}this.prepareRequisiteInfo()}this.notify("primaryEntity")},prepareRequisiteInfo:function(){this._primaryEntityRequisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:this.getRequisiteId(),bankDetailId:this.getBankDetailId(),data:this._primaryEntityInfo.getRequisites()});if(this._primaryEntityRequisiteInfo.getRequisiteId()!==this.getRequisiteId()){this.setRequisiteId(this._primaryEntityRequisiteInfo.getRequisiteId())}if(this._primaryEntityRequisiteInfo.getBankDetailId()!==this.getBankDetailId()){this.setBankDetailId(this._primaryEntityRequisiteInfo.getBankDetailId())}},findSecondaryEntityById:function(t){if(!BX.type.isNumber(t)){t=parseInt(t)}if(isNaN(t)||t<=0){return-1}for(var e=0;e<this._secondaryEntityInfos.length;e++){if(this._secondaryEntityInfos[e].getId()==t){return e}}return-1},getSecondaryEntityById:function(t){var e=this.findSecondaryEntityById(t);return e>=0?this._secondaryEntityInfos[e]:null},addSecondaryEntity:function(t,e){if(!(t instanceof BX.CrmEntityInfo)){return false}if(e===undefined||e<0){e=this._secondaryEntityInfos.length}if(this.findSecondaryEntityById(t.getId())>=0){return false}if(e===this._secondaryEntityInfos.length){this._secondaryEntityInfos.push(t)}else{this._secondaryEntityInfos.splice(e,0,t)}var i=BX(this._secondaryEntitiesInputId);if(i){i.value=this.getSecondaryEntityIds().join(",")}this.notify("entity");return true},moveSecondaryEntity:function(t,e){if(!(t instanceof BX.CrmEntityInfo)){return false}if(e===undefined||e<0){e=this._secondaryEntityInfos.length}var i=this.findSecondaryEntityById(t.getId());if(i<0||i===e){return false}t=this._secondaryEntityInfos[i];this._secondaryEntityInfos.splice(i,1);if(e>=this._secondaryEntityInfos.length){this._secondaryEntityInfos.push(t)}else{this._secondaryEntityInfos.splice(e,0,t)}var n=BX(this._secondaryEntitiesInputId);if(n){n.value=this.getSecondaryEntityIds().join(",")}this.notify("entity");return true},removeSecondaryEntity:function(t){if(!(t instanceof BX.CrmEntityInfo)){return false}var e=this.findSecondaryEntityById(t.getId());if(e<0){return false}this._secondaryEntityInfos.splice(e,1);var i=BX(this._secondaryEntitiesInputId);if(i){i.value=this.getSecondaryEntityIds().join(",")}this.notify("entity");return true},removeAllSecondaryEntities:function(){this._secondaryEntityInfos=[];var t=BX(this._secondaryEntitiesInputId);if(t){t.value=""}this.notify("entity")},getSecondaryEntityIds:function(){var t=[];for(var e=0;e<this._secondaryEntityInfos.length;e++){t.push(this._secondaryEntityInfos[e].getId())}return t},getRequisiteId:function(){return BX.type.isNumber(this._additionalData["requisiteId"])?this._additionalData["requisiteId"]:0},setRequisiteId:function(t){if(!BX.type.isNumber(t)){t=parseInt(t)}if(isNaN(t)||t<0){t=0}if(this._additionalData["requisiteId"]===t){return}this._additionalData["requisiteId"]=t;var e=BX(this._requisiteInputId);if(e){e.value=t>0?t.toString():""}},getBankDetailId:function(){return BX.type.isNumber(this._additionalData["bankDetailId"])?this._additionalData["bankDetailId"]:0},setBankDetailId:function(t){if(!BX.type.isNumber(t)){t=parseInt(t)}if(isNaN(t)||t<0){t=0}if(this._additionalData["bankDetailId"]===t){return}this._additionalData["bankDetailId"]=t;var e=BX(this._bankDetailInputId);if(e){e.value=t>0?t.toString():""}},getContext:function(){return this.getSetting("context","")},getCreateCompanyUrl:function(){return this.getSetting("createCompanyUrl","")},getCreateContactUrl:function(){return this.getSetting("createContactUrl","")},getCreateUrl:function(){if(this._entityTypeName===BX.CrmEntityType.names.company){return this.getCreateCompanyUrl()}else if(this._entityTypeName===BX.CrmEntityType.names.contact){return this.getCreateContactUrl()}return""},prepareEntitySelector:function(){if(this._readOnly){return}if(obCrm[this._entitySelectorId]){obCrm[this._entitySelectorId].Clear();delete obCrm[this._entitySelectorId]}CRM.Set(this._entitySelectorButton,this._entitySelectorId,"",{},false,false,[this.getEntityTypeName().toLowerCase()],this.getSetting("selectorMessages"),true,{requireRequisiteData:true,searchOptions:this._selectorSearchOptions});obCrm[this._entitySelectorId].AddOnSaveListener(this._entitySelectHandler)},prepareViews:function(){if(!this._hasLayout){return}this.showWaiter();if(this._primaryView){this._primaryView.clearLayout();this._primaryView=null}if(this._auxiliaryGroup){this._auxiliaryGroup.clearLayout();this._auxiliaryGroup=null}var t=[];if(!this._primaryEntityInfo){for(var e=0;e<this._secondaryEntityInfos.length;e++){t.push(this._secondaryEntityInfos[e])}}else{var i=this._primaryEntityInfo.getTypeName()===BX.CrmEntityType.names.contact;for(var n=0;n<this._secondaryEntityInfos.length;n++){var s=this._secondaryEntityInfos[n];if(i&&BX.CrmEntityInfo.equals(s,this._primaryEntityInfo)){continue}t.push(s)}this._primaryView=BX.CrmEntitySummaryView.create(this._id,{entityInfo:this._primaryEntityInfo,requisiteInfo:this._primaryEntityRequisiteInfo,requisiteServiceUrl:this.getSetting("requisiteServiceUrl"),container:this._wrapper,readOnly:this._readOnly});this._primaryView.addDeletionListener(this._deletePrimaryViewHandler);this._primaryView.addRequisiteChangeListener(this._requisiteChangeHandler);this._primaryView.layout()}if(!this._enableMultiplicity&&this._primaryEntityInfo&&this._primaryEntityInfo.getTypeName()===BX.CrmEntityType.names.contact){this.hideWaiterAfter(200);return}if(this._primaryEntityInfo||t.length>0){var a=this.getCreateContactUrl();var r={};if(this._primaryEntityInfo&&this._primaryEntityInfo.getTypeName()===BX.CrmEntityType.names.company){r["company_id"]=this._primaryEntityInfo.getId()}var o=(this._primaryEntityInfo?this._primaryEntityInfo.getTypeName():this._entityTypeName)===BX.CrmEntityType.names.contact;this._auxiliaryGroup=BX.CrmClientPanelGroup.create(this._id,{entityType:this._secondaryEntityTypeName,entityInfos:t,context:this.getContext(),enableMarking:o,createUrl:a,createUrlParams:r,container:this._wrapper,selectorMessages:this.getSetting("selectorMessages"),messages:this.getSetting("secondaryEntityMessages"),enableMultiplicity:this._enableMultiplicity,readOnly:this._readOnly});this._auxiliaryGroup.layout();this._auxiliaryGroup.addChangeListener(this._contactGroupChangeHandler)}this.hideWaiterAfter(200)},showWaiter:function(){if(this._waiterTimeoutId>0){window.clearTimeout(this._waiterTimeoutId);this._waiterTimeoutId=0}if(this._waiterWrapper){return}var t=BX.create("DIV",{attrs:{className:"crm-offer-tabs-wrap-slide-waiter"}});this._waiterWrapper=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-block-wrap"},children:[t]});var e=BX.pos(this._wrapper);t.style.width=e["width"]+"px";t.style.height=e["height"]+"px";this._wrapper.style.display="none";this._container.appendChild(this._waiterWrapper)},hideWaiterAfter:function(t){if(this._waiterTimeoutId>0){window.clearTimeout(this._waiterTimeoutId);this._waiterTimeoutId=0}this._waiterTimeoutId=window.setTimeout(BX.delegate(this.hideWaiter,this),t>0?t:0)},hideWaiter:function(){if(!this._hasLayout||!this._waiterWrapper||this._waiterTimeoutId<=0){return}this._waiterTimeoutId=0;this._container.removeChild(this._waiterWrapper);this._waiterWrapper=null;this._wrapper.style.display=""},layout:function(){if(this._hasLayout){return}this._wrapper=BX.create("DIV",{attrs:{className:"crm-client-selector-tabs-wrapper"}});this._container.appendChild(this._wrapper);if(!this._readOnly){var t=BX.create("DIV",{attrs:{className:"crm-client-selector-type"}});this._wrapper.appendChild(t);this._typeSelectorButton=BX.create("DIV",{attrs:{className:"crm-client-selector-type-item-list selected"}});this._typeSelectorButtonContent=BX.create("SPAN",{text:BX.CrmEntityType.getCaptionByName(this.getEntityTypeName())+" "});this._typeSelectorButton.appendChild(this._typeSelectorButtonContent);this._typeSelectorButton.appendChild(BX.create("SPAN",{attrs:{className:"crm-client-selector-arrow"}}));t.appendChild(this._typeSelectorButton);BX.bind(this._typeSelectorButton,"click",this._typeSelectorClickHandler);this._entitySelectorButton=BX.create("DIV",{attrs:{id:this._entitySelectorId,className:"crm-client-selector-type-item-select"},text:this.getMessage("selectButton")});t.appendChild(this._entitySelectorButton);BX.bind(this._entitySelectorButton,"click",this._entitySelectClickHandler);this._entityCreationButton=BX.create("DIV",{attrs:{className:"crm-client-selector-type-item-create"},events:{click:this._entityCreateClickHandler},text:this.getMessage("createButton")});t.appendChild(this._entityCreationButton);BX.bind(this._entityCreationButton,"click",this._entityCreateClickHandler)}this._hasLayout=true;this.prepareViews();this.prepareEntitySelector()},clearLayout:function(){if(!this._hasLayout){return}if(this._primaryView){this._primaryView.clearLayout();this._primaryView=null}if(this._auxiliaryGroup){this._auxiliaryGroup.clearLayout();this._auxiliaryGroup=null}this._typeSelectorButtonContent=null;if(this._typeSelectorButton){BX.unbind(this._typeSelectorButton,"click",this._typeSelectorClickHandler);this._typeSelectorButton=null}if(this._entitySelectorButton){BX.unbind(this._entitySelectorButton,"click",this._entitySelectClickHandler);this._entitySelectorButton=null}if(this._entityCreationButton){BX.unbind(this._entityCreationButton,"click",this._entityCreateClickHandler);this._entityCreationButton=null}if(this._wrapper){this._wrapper=BX.remove(this._wrapper)}this._hasLayout=false},loadSecondaryEntityInfos:function(){var t=this.getSetting("serviceUrl");if(BX.type.isNotEmptyString(t)){BX.CrmDataLoader.create(this._id,{serviceUrl:t,action:"GET_SECONDARY_ENTITY_INFOS",params:{PRIMARY_TYPE_NAME:this._primaryEntityInfo.getTypeName(),PRIMARY_ID:this._primaryEntityInfo.getId(),SECONDARY_TYPE_NAME:this._secondaryEntityTypeName,OWNER_TYPE_NAME:this._owner["typeName"]}}).load(BX.delegate(this.onLoadSecondaryEntityInfos,this))}},notify:function(t){var e={selectorInfo:{type:"combined",id:this._id},target:t,data:{primaryEntityTypeName:this._primaryEntityInfo?this._primaryEntityInfo.getTypeName():this._entityTypeName,primaryEntityInfo:this._primaryEntityInfo,entityTypeName:this._secondaryEntityTypeName,entityInfos:this._secondaryEntityInfos}};BX.onCustomEvent("CrmClientSelectorChange",[this,e])},openTypeSelectorMenu:function(){if(!this._selectorMenu){this._selectorMenu=BX.CmrSelectorMenu.create(this._id,{items:[{text:BX.CrmEntityType.getCaption(BX.CrmEntityType.enumeration.company),value:BX.CrmEntityType.names.company},{text:BX.CrmEntityType.getCaption(BX.CrmEntityType.enumeration.contact),value:BX.CrmEntityType.names.contact}]});this._selectorMenu.addOnSelectListener(this._typeSelectHandler)}if(!this._selectorMenu.isOpened()){this._selectorMenu.open(this._typeSelectorButton)}},onTypeSelectorClick:function(t){if(this._readOnly){return}this.openTypeSelectorMenu()},onTypeSelect:function(t,e){if(this._readOnly){return}this.setEntityTypeName(e.getValue());if(this._selectorMenu.isOpened()){this._selectorMenu.close()}},onEntitySelectClick:function(t){if(this._readOnly){return}if(obCrm[this._entitySelectorId]){var e=obCrm[this._entitySelectorId];e.ClearSelectItems();e.Open()}},onEntityCreateClick:function(t){if(this._readOnly){return}var e=this.getCreateUrl();var i=(this.getContext()+"_"+BX.util.getRandomString(6)).toLowerCase();if(e===""||i===""){return}i=(i+"_"+BX.util.getRandomString(6)).toLowerCase();var n={external_context:i};if(BX.type.isPlainObject(this._selectorSearchOptions)&&this._selectorSearchOptions["ONLY_MY_COMPANIES"]==="Y"){n["mycompany"]="y"}e=BX.util.add_url_param(e,n);if(!this._externalRequestData){this._externalRequestData={}}this._externalRequestData[i]={context:i,wnd:window.open(e)};if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}},onEntitySelect:function(t){if(this._readOnly){return}var e=this._entityTypeName.toLowerCase();var i=t[e]&&t[e][0]?t[e][0]:null;if(!i){return}var n=BX.CrmEntityInfo.create(i);if(this._entityTypeName===BX.CrmEntityType.names.company){this.setPrimaryEntity(n);this.removeAllSecondaryEntities();this.loadSecondaryEntityInfos()}else if(this._entityTypeName===BX.CrmEntityType.names.contact){if(!this._enableMultiplicity){this.removeAllSecondaryEntities();this.addSecondaryEntity(n)}else{if(this._primaryEntityInfo){var s=this._primaryEntityInfo.getTypeName();if(s===BX.CrmEntityType.names.contact){this.removeSecondaryEntity(this._primaryEntityInfo)}else if(s===BX.CrmEntityType.names.company){this.removeAllSecondaryEntities()}}if(!this.addSecondaryEntity(n,0)){this.moveSecondaryEntity(n,0)}}this.setPrimaryEntity(this.getSecondaryEntityById(n.getId()))}this.prepareViews()},onContactGroupChange:function(t,e){if(this._readOnly){return}var i=e["name"];var n=e["item"];var s=true;if(i==="add"){s=this.addSecondaryEntity(n.getEntityInfo(),-1)}else if(i==="mark"){this.moveSecondaryEntity(n.getEntityInfo(),0);this.setPrimaryEntity(this.getSecondaryEntityById(n.getEntityId()));this.prepareViews()}else if(i==="remove"){s=this.removeSecondaryEntity(n.getEntityInfo())}e["cancel"]=!s},onPrimaryViewDelete:function(t){if(this._readOnly||!this._primaryEntityInfo){return}if(this._primaryEntityInfo.getTypeName()===BX.CrmEntityType.names.contact){this.removeSecondaryEntity(this._primaryEntityInfo)}var e=this._secondaryEntityInfos.length>0?this._secondaryEntityInfos[0]:null;this.setPrimaryEntity(e);if(e){this.setEntityTypeName(this._secondaryEntityTypeName)}this.prepareViews()},onRequisiteChange:function(t,e,i){if(this._readOnly){return}this.setRequisiteId(e);this.setBankDetailId(i)},onExternalEvent:function(t){if(this._readOnly){return}var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";var i=BX.type.isPlainObject(t["value"])?t["value"]:{};var n=BX.type.isNotEmptyString(i["entityTypeName"])?i["entityTypeName"]:"";var s=BX.type.isNotEmptyString(i["context"])?i["context"]:"";if(e==="onCrmEntityCreate"&&n===this._entityTypeName&&this._externalRequestData&&BX.type.isPlainObject(this._externalRequestData[s])){var a=BX.type.isBoolean(i["isCanceled"])?i["isCanceled"]:false;if(!a&&BX.type.isPlainObject(i["entityInfo"])){var r=BX.CrmEntityInfo.create(i["entityInfo"]);if(this._entityTypeName===BX.CrmEntityType.names.company){this.removeAllSecondaryEntities();this.setPrimaryEntity(r)}else if(this._entityTypeName===BX.CrmEntityType.names.contact){if(!this._enableMultiplicity){this.removeAllSecondaryEntities();this.addSecondaryEntity(r)}else{if(this._primaryEntityInfo){var o=this._primaryEntityInfo.getTypeName();if(o===BX.CrmEntityType.names.contact){this.removeSecondaryEntity(this._primaryEntityInfo)}else if(o===BX.CrmEntityType.names.company){this.removeAllSecondaryEntities()}}this.addSecondaryEntity(r,0)}this.setPrimaryEntity(r)}this.prepareViews()}if(this._externalRequestData[s]["wnd"]){this._externalRequestData[s]["wnd"].close()}delete this._externalRequestData[s]}},onLoadSecondaryEntityInfos:function(t,e){var i=BX.type.isArray(e["ENTITY_INFOS"])?e["ENTITY_INFOS"]:[];var n=i.length;if(!this._enableMultiplicity&&n>1){n=1}for(var s=0;s<n;s++){this.addSecondaryEntity(BX.CrmEntityInfo.create(i[s]))}this.prepareViews()}};if(typeof BX.CrmCompositeClientSelector.messages==="undefined"){BX.CrmCompositeClientSelector.messages={}}BX.CrmCompositeClientSelector.create=function(t,e){var i=new BX.CrmCompositeClientSelector;i.initialize(t,e);return i}}if(typeof BX.CrmMultipleClientSelector==="undefined"){BX.CrmMultipleClientSelector=function(){this._id="";this._settings={};this._entityInfos=null;this._entityTypeName="";this._entitySelectorId="";this._containerId="";this._container=null;this._wrapper=null;this._view=null;this._entitiesInputId="";this._entitySelectorButton=null;this._entityCreationButton=null;this._entitySelectClickHandler=BX.delegate(this.onEntitySelectClick,this);this._entityCreateClickHandler=BX.delegate(this.onEntityCreateClick,this);this._entitySelectHandler=BX.delegate(this.onEntitySelect,this);this._entityDeleteHandler=BX.delegate(this.onEntityDelete,this);this._externalRequestData=null;this._externalEventHandler=null;this._enableEntityCreation=false;this._enableRequisites=false;this._enableLazyLoad=false;this._readOnly=false;this._hasLayout=false};BX.CrmMultipleClientSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._containerId=this.getSetting("containerId","");if(!BX.type.isNotEmptyString(this._containerId)){throw"CrmMultipleClientSelector: Could not find 'containerId' parameter in settings."}this._container=BX(this._containerId);if(!BX.type.isElementNode(this._container)){throw"CrmMultipleClientSelector: Could not find container element."}this._entityTypeName=BX.CrmEntityType.verifyName(this.getSetting("entityType",""));if(this._entityTypeName===BX.CrmEntityType.names.undefined){throw"CrmMultipleClientSelector: Could not find 'entityTypeName' parameter in settings."}var i=this.getSetting("entityData");if(!BX.type.isArray(i)){i=[]}this._entityInfos=[];for(var n=0;n<i.length;n++){var s=BX.CrmEntityInfo.create(i[n]);if(s.getId()>0){this._entityInfos.push(s)}}this._readOnly=!!this.getSetting("readOnly");this._enableLazyLoad=!!this.getSetting("enableLazyLoad");if(!this._readOnly&&this._enableLazyLoad){throw"CrmMultipleClientSelector: Lazy load is supported in read only mode only."}this._enableEntityCreation=!!this.getSetting("enableEntityCreation",false);this._enableRequisites=!!this.getSetting("enableRequisites",true);this._entitiesInputId=this.getSetting("entitiesInputId","");this._entitySelectorId=this._id+"_ENTITY_SELECTOR";var a=this.getSetting("selectorSearchOptions",{});this._selectorSearchOptions=BX.type.isPlainObject(a)?a:{}},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getMessage:function(t){var e=BX.CrmMultipleClientSelector.messages;return e.hasOwnProperty(t)?e[t]:t},getContext:function(){return this.getSetting("context","")},getCreateUrl:function(){return this.getSetting("entityCreateUrl","")},getEntityIds:function(){var t=[];for(var e=0,i=this._entityInfos.length;e<i;e++){t.push(this._entityInfos[e].getId())}return t},findEntityInfoById:function(t){if(!BX.type.isNumber(t)){t=parseInt(t)}if(isNaN(t)||t<=0){return-1}for(var e=0,i=this._entityInfos.length;e<i;e++){if(this._entityInfos[e].getId()==t){return e}}return-1},getEntityInfo:function(t){return t>=0&&t<this._entityInfos.length?this._entityInfos[t]:null},addEntityInfo:function(t){if(this.findEntityInfoById(t.getId())>=0){return-1}this._entityInfos.push(t);var e=BX(this._entitiesInputId);if(e){e.value=this.getEntityIds().join(",")}this.notify("entity");return this._entityInfos.length-1},removeEntityInfo:function(t){var e=this.findEntityInfoById(t.getId());if(e<0){return false}this._entityInfos.splice(e,1);var i=BX(this._entitiesInputId);if(i){i.value=this.getEntityIds().join(",")}this.notify("entity");return true},prepareView:function(t){if(!this._hasLayout){return}if(!BX.type.isPlainObject(t)){t={}}if(this._view){this._view.clearLayout();this._view=null}var e=0;if(!this._enableLazyLoad){e=this._entityInfos.length}else{e=parseInt(this.getSetting("entityCount"))}if(e>0){var i={entityType:this._entityTypeName,entityInfos:this._entityInfos,count:e,container:this._wrapper,readOnly:this._readOnly,enableRequisites:this._enableRequisites,enableRequisiteChange:false};if(this._enableLazyLoad){i["loader"]=this.getSetting("loader");i["owner"]=this.getSetting("owner")}this._view=BX.CrmMultipleEntitySummaryView.create(this._id,i);this._view.layout();if(!this._readOnly){this._view.addDeletionListener(this._entityDeleteHandler)}if(BX.type.isNumber(t["index"])){this._view.setIndex(t["index"])}}},prepareEntitySelector:function(){if(this._readOnly){return}if(obCrm[this._entitySelectorId]){obCrm[this._entitySelectorId].Clear();delete obCrm[this._entitySelectorId]}CRM.Set(this._entitySelectorButton,this._entitySelectorId,"",{},false,false,[this._entityTypeName.toLowerCase()],this.getSetting("selectorMessages"),true,{requireRequisiteData:this._enableRequisites,searchOptions:this._selectorSearchOptions});obCrm[this._entitySelectorId].AddOnSaveListener(this._entitySelectHandler)},layout:function(){if(this._hasLayout){return}this._wrapper=BX.create("DIV",{attrs:{className:"crm-client-selector-tabs-wrapper"}});this._container.appendChild(this._wrapper);if(!this._readOnly){var t=BX.create("DIV",{attrs:{className:"crm-client-selector-type"}});this._wrapper.appendChild(t);this._entitySelectorButton=BX.create("DIV",{attrs:{id:this._entitySelectorId,className:"crm-client-selector-type-item-select"},text:this.getMessage("selectButton")});t.appendChild(this._entitySelectorButton);BX.bind(this._entitySelectorButton,"click",this._entitySelectClickHandler);if(this._enableEntityCreation){this._entityCreationButton=BX.create("DIV",{attrs:{className:"crm-client-selector-type-item-create"},events:{click:this._entityCreateClickHandler},text:this.getMessage("createButton")});t.appendChild(this._entityCreationButton);BX.bind(this._entityCreationButton,"click",this._entityCreateClickHandler)}}this._hasLayout=true;this.prepareView();this.prepareEntitySelector()},clearLayout:function(){if(!this._hasLayout){return}if(this._entitySelectorButton){BX.unbind(this._entitySelectorButton,"click",this._entitySelectClickHandler);this._entitySelectorButton=null}if(this._entityCreationButton){BX.unbind(this._entityCreationButton,"click",this._entityCreateClickHandler);this._entityCreationButton=null}if(this._wrapper){this._wrapper=BX.remove(this._wrapper)}this._hasLayout=false},notify:function(t){var e={selectorInfo:{type:"multiple",id:this._id},target:t,data:{entityTypeName:this._entityTypeName,entityInfos:this._entityInfos}};BX.onCustomEvent("CrmClientSelectorChange",[this,e])},onEntitySelectClick:function(t){if(this._readOnly){return}if(obCrm[this._entitySelectorId]){obCrm[this._entitySelectorId].Open()}},onEntityCreateClick:function(t){if(this._readOnly||!this._enableEntityCreation){return}var e=this.getCreateUrl();var i=(this.getContext()+"_"+BX.util.getRandomString(6)).toLowerCase();if(e===""||i===""){return}i=(i+"_"+BX.util.getRandomString(6)).toLowerCase();var n={external_context:i};if(BX.type.isPlainObject(this._selectorSearchOptions)&&this._selectorSearchOptions["ONLY_MY_COMPANIES"]==="Y"){n["mycompany"]="y"}e=BX.util.add_url_param(e,n);if(!this._externalRequestData){this._externalRequestData={}}this._externalRequestData[i]={context:i,wnd:window.open(e)};if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}},onEntitySelect:function(t){if(this._readOnly){return}var e=this._entityTypeName.toLowerCase();var i=t[e]&&t[e][0]?t[e][0]:null;if(!i){return}var n=this.addEntityInfo(BX.CrmEntityInfo.create(i));if(n>=0){this.prepareView({index:n})}},onEntityDelete:function(t,e){if(this._readOnly){return}if(this.removeEntityInfo(e.getEntityInfo())){this.prepareView()}},onExternalEvent:function(t){if(this._readOnly||!this._enableEntityCreation){return}var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";var i=BX.type.isPlainObject(t["value"])?t["value"]:{};var n=BX.type.isNotEmptyString(i["entityTypeName"])?i["entityTypeName"]:"";var s=BX.type.isNotEmptyString(i["context"])?i["context"]:"";if(e==="onCrmEntityCreate"&&n===this._entityTypeName&&this._externalRequestData&&BX.type.isPlainObject(this._externalRequestData[s])){var a=BX.type.isBoolean(i["isCanceled"])?i["isCanceled"]:false;if(!a&&BX.type.isPlainObject(i["entityInfo"])){var r=this.addEntityInfo(BX.CrmEntityInfo.create(i["entityInfo"]));if(r>=0){this.prepareView({index:r})}}if(this._externalRequestData[s]["wnd"]){this._externalRequestData[s]["wnd"].close()}delete this._externalRequestData[s]}}};if(typeof BX.CrmMultipleClientSelector.messages==="undefined"){BX.CrmMultipleClientSelector.messages={}}BX.CrmMultipleClientSelector.create=function(t,e){var i=new BX.CrmMultipleClientSelector;i.initialize(t,e);return i}}if(typeof BX.CrmSingleClientSelector==="undefined"){BX.CrmSingleClientSelector=function(){this._id="";this._settings={};this._entityInfo=null;this._requisiteInfo=null;this._additionalData=null;this._entityTypeName="";this._entitySelectorId="";this._containerId="";this._container=null;this._wrapper=null;this._view=null;this._entityInputId="";this._requisiteInputId="";this._bankDetailInputId="";this._entitySelectorButton=null;this._entityCreationButton=null;this._entitySelectClickHandler=BX.delegate(this.onEntitySelectClick,this);this._entityCreateClickHandler=BX.delegate(this.onEntityCreateClick,this);this._entitySelectHandler=BX.delegate(this.onEntitySelect,this);this._entityDeleteHandler=BX.delegate(this.onEntityDelete,this);this._entityRequisiteChangeHandler=BX.delegate(this.onEntityRequisiteChange,this);this._externalRequestData=null;this._externalEventHandler=null;this._enableEntityCreation=false;this._enableRequisites=false;this._enableRequisiteChange=false;this._readOnly=false;this._hasLayout=false};BX.CrmSingleClientSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._containerId=this.getSetting("containerId","");if(!BX.type.isNotEmptyString(this._containerId)){throw"CrmSingleClientSelector: Could not find 'containerId' parameter in settings."}this._container=BX(this._containerId);if(!BX.type.isElementNode(this._container)){throw"CrmSingleClientSelector: Could not find container element."}this._entityTypeName=BX.CrmEntityType.verifyName(this.getSetting("entityType",""));if(this._entityTypeName===BX.CrmEntityType.names.undefined){throw"CrmSingleClientSelector: Could not find 'entityTypeName' parameter in settings."}this._readOnly=!!this.getSetting("readOnly");this._enableEntityCreation=!!this.getSetting("enableEntityCreation",false);this._enableRequisites=!!this.getSetting("enableRequisites",true);this._enableRequisiteChange=!!this.getSetting("enableRequisiteChange",this._enableRequisites);this._entityInputId=this.getSetting("entityInputId","");this._requisiteInputId=this.getSetting("requisiteInputId","");this._bankDetailInputId=this.getSetting("bankDetailInputId","");var i=this.getSetting("selectorSearchOptions",{});this._selectorSearchOptions=BX.type.isPlainObject(i)?i:{};var n=this.getSetting("additionalData");this._additionalData=BX.type.isPlainObject(n)?n:{};var s=this.getSetting("entityData");if(BX.type.isPlainObject(s)){this.setEntityInfo(BX.CrmEntityInfo.create(s))}this._entitySelectorId=this._id+"_ENTITY_SELECTOR"},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getMessage:function(t){var e=BX.CrmSingleClientSelector.messages;return e.hasOwnProperty(t)?e[t]:t},getContext:function(){return this.getSetting("context","")},getCreateUrl:function(){return this.getSetting("entityCreateUrl","")},getEntityInfo:function(){return this._entityInfo},setEntityInfo:function(t){var e=BX(this._entityInputId);if(this._entityInfo){this._entityInfo=null;if(e){e.value=""}}if(t instanceof BX.CrmEntityInfo){this._entityInfo=t;if(e){e.value=this._entityInfo?this._entityInfo.getId():""}}this.prepareRequisiteInfo();this.notify("primaryEntity")},getRequisiteId:function(){return BX.type.isNumber(this._additionalData["requisiteId"])?this._additionalData["requisiteId"]:0},setRequisiteId:function(t){if(!BX.type.isNumber(t)){t=parseInt(t)}if(isNaN(t)||t<0){t=0}if(this._additionalData["requisiteId"]===t){return}this._additionalData["requisiteId"]=t;var e=BX(this._requisiteInputId);if(e){e.value=t>0?t.toString():""}},getBankDetailId:function(){return BX.type.isNumber(this._additionalData["bankDetailId"])?this._additionalData["bankDetailId"]:0},setBankDetailId:function(t){if(!BX.type.isNumber(t)){t=parseInt(t)}if(isNaN(t)||t<0){t=0}if(this._additionalData["bankDetailId"]===t){return}this._additionalData["bankDetailId"]=t;var e=BX(this._bankDetailInputId);if(e){e.value=t>0?t.toString():""}},prepareRequisiteInfo:function(){if(this._entityInfo!==null){this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:this.getRequisiteId(),bankDetailId:this.getBankDetailId(),data:this._entityInfo.getRequisites()});if(this._requisiteInfo.getRequisiteId()!==this.getRequisiteId()){this.setRequisiteId(this._requisiteInfo.getRequisiteId())}if(this._requisiteInfo.getBankDetailId()!==this.getBankDetailId()){this.setBankDetailId(this._requisiteInfo.getBankDetailId())}}else{this._requisiteInfo=null;if(this.getRequisiteId()!==0){this.setRequisiteId(0)}if(this.getBankDetailId()!==0){this.setBankDetailId(0)}}},prepareView:function(){if(!this._hasLayout){return}if(this._view){this._view.clearLayout();this._view=null}if(this._entityInfo!==null){this._view=BX.CrmEntitySummaryView.create(this._id,{entityInfo:this._entityInfo,requisiteInfo:null,container:this._wrapper,readOnly:this._readOnly,enableRequisites:this._enableRequisites,enableRequisiteChange:this._enableRequisiteChange,requisiteServiceUrl:this.getSetting("requisiteServiceUrl")});this._view.layout();if(!this._readOnly){this._view.addDeletionListener(this._entityDeleteHandler);if(this._enableRequisiteChange){this._view.addRequisiteChangeListener(this._entityRequisiteChangeHandler)}}}},prepareEntitySelector:function(){if(this._readOnly){return}if(obCrm[this._entitySelectorId]){obCrm[this._entitySelectorId].Clear();delete obCrm[this._entitySelectorId]}CRM.Set(this._entitySelectorButton,this._entitySelectorId,"",{},false,false,[this._entityTypeName.toLowerCase()],this.getSetting("selectorMessages"),true,{requireRequisiteData:this._enableRequisites,searchOptions:this._selectorSearchOptions});obCrm[this._entitySelectorId].AddOnSaveListener(this._entitySelectHandler)},layout:function(){if(this._hasLayout){return}this._wrapper=BX.create("DIV",{attrs:{className:"crm-client-selector-tabs-wrapper"}});this._container.appendChild(this._wrapper);if(!this._readOnly){var t=BX.create("DIV",{attrs:{className:"crm-client-selector-type"}});this._wrapper.appendChild(t);this._entitySelectorButton=BX.create("DIV",{attrs:{id:this._entitySelectorId,className:"crm-client-selector-type-item-select"},text:this.getMessage("selectButton")});t.appendChild(this._entitySelectorButton);BX.bind(this._entitySelectorButton,"click",this._entitySelectClickHandler);if(this._enableEntityCreation){this._entityCreationButton=BX.create("DIV",{attrs:{className:"crm-client-selector-type-item-create"},events:{click:this._entityCreateClickHandler},text:this.getMessage("createButton")});t.appendChild(this._entityCreationButton);BX.bind(this._entityCreationButton,"click",this._entityCreateClickHandler)}}this._hasLayout=true;this.prepareView();this.prepareEntitySelector()},clearLayout:function(){if(!this._hasLayout){return}if(this._entitySelectorButton){BX.unbind(this._entitySelectorButton,"click",this._entitySelectClickHandler);this._entitySelectorButton=null}if(this._entityCreationButton){BX.unbind(this._entityCreationButton,"click",this._entityCreateClickHandler);this._entityCreationButton=null}if(this._wrapper){this._wrapper=BX.remove(this._wrapper)}this._hasLayout=false},notify:function(t){var e={selectorInfo:{type:"single",id:this._id},target:t,data:{primaryEntityTypeName:this._entityTypeName,primaryEntityInfo:this._entityInfo}};BX.onCustomEvent("CrmClientSelectorChange",[this,e])},onEntitySelectClick:function(t){if(this._readOnly){return}if(obCrm[this._entitySelectorId]){obCrm[this._entitySelectorId].Open()}},onEntityCreateClick:function(t){if(this._readOnly||!this._enableEntityCreation){return}var e=this.getCreateUrl();var i=(this.getContext()+"_"+BX.util.getRandomString(6)).toLowerCase();if(e===""||i===""){return}i=(i+"_"+BX.util.getRandomString(6)).toLowerCase();var n={external_context:i};if(BX.type.isPlainObject(this._selectorSearchOptions)&&this._selectorSearchOptions["ONLY_MY_COMPANIES"]==="Y"){n["mycompany"]="y"}e=BX.util.add_url_param(e,n);if(!this._externalRequestData){this._externalRequestData={}}this._externalRequestData[i]={context:i,wnd:window.open(e)};if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}},onEntitySelect:function(t){if(this._readOnly){return}var e=this._entityTypeName.toLowerCase();var i=t[e]&&t[e][0]?t[e][0]:null;if(i){this.setEntityInfo(BX.CrmEntityInfo.create(i));this.prepareView()}},onEntityDelete:function(t,e){if(this._readOnly){return}this.setEntityInfo(null);this.prepareView()},onEntityRequisiteChange:function(t,e,i){if(this._readOnly){return}this.setRequisiteId(e);this.setBankDetailId(i)},onExternalEvent:function(t){if(this._readOnly||!this._enableEntityCreation){return}var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";var i=BX.type.isPlainObject(t["value"])?t["value"]:{};var n=BX.type.isNotEmptyString(i["entityTypeName"])?i["entityTypeName"]:"";var s=BX.type.isNotEmptyString(i["context"])?i["context"]:"";if(e==="onCrmEntityCreate"&&n===this._entityTypeName&&this._externalRequestData&&BX.type.isPlainObject(this._externalRequestData[s])){var a=BX.type.isBoolean(i["isCanceled"])?i["isCanceled"]:false;if(!a&&BX.type.isPlainObject(i["entityInfo"])){this.setEntityInfo(BX.CrmEntityInfo.create(i["entityInfo"]));this.prepareView()}if(this._externalRequestData[s]["wnd"]){this._externalRequestData[s]["wnd"].close()}delete this._externalRequestData[s]}}};if(typeof BX.CrmSingleClientSelector.messages==="undefined"){BX.CrmSingleClientSelector.messages={}}BX.CrmSingleClientSelector.create=function(t,e){var i=new BX.CrmSingleClientSelector;i.initialize(t,e);return i}}if(typeof BX.CrmClientPanelGroup==="undefined"){BX.CrmClientPanelGroup=function(){this._id="";this._settings={};this._customMessages=null;this._entityTypeName="";this._entityInfos=[];this._items=[];this._entitySelectorId="";this._container=null;this._wrapper=null;this._itemWrapper=null;this._enableMarking=false;this._enableMultiplicity=true;this._readOnly=false;this._hasLayout=false;this._addButtonClickHandler=BX.delegate(this.onAddButtomClick,this);this._createButtonClickHandler=BX.delegate(this.onCreateButtomClick,this);this._entitySelectHandler=BX.delegate(this.onEntitySelect,this);this._deleteItemHandler=BX.delegate(this.onItemDelete,this);this._markItemHandler=BX.delegate(this.onItemMark,this);this._externalRequestData=null;this._externalEventHandler=null;this._changeNotifier=null};BX.CrmClientPanelGroup.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._id=BX.type.isNotEmptyString(t)?t:"CRM_CLIENT_PANEL_GROUP"+Math.random();this._settings=BX.type.isPlainObject(e)?e:{};this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"CrmClientPanelGroup: Could not find 'container' parameter in settings."}this._entityTypeName=this.getSetting("entityType","");if(!BX.type.isNotEmptyString(this._entityTypeName)){throw"CrmClientPanelGroup: Could not find 'entityType' parameter in settings."}var i=this.getSetting("entityInfos");if(BX.type.isArray(i)){this._entityInfos=i}this._enableMarking=!!this.getSetting("enableMarking",false);this._enableMultiplicity=!!this.getSetting("enableMultiplicity",true);this._readOnly=!!this.getSetting("readOnly",false);this._changeNotifier=BX.CrmNotifier.create(this);this._customMessages=this.getSetting("messages");if(!BX.type.isPlainObject(this._customMessages)){this._customMessages={}}},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getMessage:function(t){var e=BX.CrmClientPanelGroup.messages;return e.hasOwnProperty(t)?e[t]:t},getCustomMessage:function(t){var e=this._customMessages;return e.hasOwnProperty(t)?e[t]:t},getEntityInfos:function(){return this._entityInfos},getEntityIds:function(){var t=[];for(var e=0;e<this._entityInfos.length;e++){t.push(this._entityInfos[e].getId())}return t},getContext:function(){return this.getSetting("context","")},getCreateUrl:function(){return this.getSetting("createUrl","")},getCreateUrlParams:function(){var t=this.getSetting("createUrlParams");return BX.type.isPlainObject(t)?t:{}},layout:function(){if(this._hasLayout){return}var t=this._wrapper=BX.create("DIV",{attrs:{className:"crm-deal-client-selector-container"}});this._container.appendChild(t);t.appendChild(BX.create("DIV",{attrs:{className:"crm-deal-client-selector-title"},text:this.getCustomMessage("header")+":"}));var e=this._itemWrapper=BX.create("DIV",{attrs:{className:"crm-deal-client-selector-card-list"}});t.appendChild(e);var i=this._entityInfos.length;if(i>1&&!this._enableMultiplicity){i=1}for(var n=0;n<i;n++){var s=this.createItem(this._entityInfos[n]);s.addDeletionListener(this._deleteItemHandler);s.addMarkingListener(this._markItemHandler);s.layout();this._items.push(s)}t.appendChild(BX.create("DIV",{style:{clear:"both"}}));t.appendChild(BX.create("BR"));if(!this._readOnly){var a=this._entitySelectorId=this._id+"_"+this._entityTypeName;var r=BX.create("A",{attrs:{id:a,href:"#",className:"crm-deal-client-selector-add-contact"},events:{click:this._addButtonClickHandler},children:[BX.create("STRONG",{text:this.getMessage("selectButton").toLowerCase()})]});t.appendChild(r);CRM.Set(r,a,"",{},false,false,[this._entityTypeName.toLowerCase()],this.getSetting("selectorMessages"),true,{requireRequisiteData:true});obCrm[a].AddOnSaveListener(this._entitySelectHandler);var o=BX.create("A",{attrs:{id:a,href:"#",className:"crm-deal-client-selector-create-contact"},events:{click:this._createButtonClickHandler},children:[BX.create("STRONG",{text:this.getMessage("createButton").toLowerCase()})]});t.appendChild(o)}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}if(this._items.length>0){for(var t=0;t<this._items.length;t++){var e=this._items[t];e.removeDeletionListener(this._deleteItemHandler);e.removeMarkingListener(this._markItemHandler);e.clearLayout()}this._items=[]}if(this._itemWrapper){this._itemWrapper=BX.remove(this._itemWrapper)}if(this._entitySelectorId!==""){if(obCrm[this._entitySelectorId]){obCrm[this._entitySelectorId].Clear();delete obCrm[this._entitySelectorId]}this._entitySelectorId=""}if(this._wrapper){this._wrapper=BX.remove(this._wrapper)}this._hasLayout=false},createItem:function(t){return BX.CrmClientPanelGroupItem.create("",{parent:this,container:this._itemWrapper,entityType:this._entityTypeName,entityInfo:t,enableMarking:this._enableMarking,readOnly:this._readOnly})},addItem:function(t){var e=this.createItem(t);var i={name:"add",item:e,cancel:false};this._changeNotifier.notify([i]);if(i["cancel"]){return null}this._items.push(e);e.addDeletionListener(this._deleteItemHandler);e.addMarkingListener(this._markItemHandler);this._entityInfos.push(t);return e},removeItem:function(t){var e=this.findItemById(t.getEntityId());if(e<0){return false}var i={name:"remove",item:t,cancel:false};this._changeNotifier.notify([i]);if(i["cancel"]){return false}this._items[e].clearLayout();this._items.splice(e,1);this._entityInfos.splice(e,1);return true},removeAllItems:function(){if(this._items.length===0){return}for(var t=0;t<this._items.length;t++){var e=this._items[t];e.removeDeletionListener(this._deleteItemHandler);e.removeMarkingListener(this._markItemHandler);e.clearLayout()}this._items=[]},findItemById:function(t){if(!BX.type.isNumber(t)){t=parseInt(t)}if(isNaN(t)||t<=0){return-1}for(var e=0;e<this._items.length;e++){if(this._items[e].getEntityId()==t){return e}}return-1},isMarkingEnabled:function(){return this._enableMarking},enebleMarking:function(t){t=!!t;if(this._enableMarking===t){return}this._enableMarking=t;for(var e=0;e<this._items.length;e++){this._items[e].enebleMarking(t)}},addChangeListener:function(t){this._changeNotifier.addListener(t)},removeChangeListener:function(t){this._changeNotifier.removeListener(t)},onAddButtomClick:function(t){if(!this._readonly&&obCrm[this._entitySelectorId]){var e=obCrm[this._entitySelectorId];e.ClearSelectItems();e.Open()}return BX.PreventDefault(t)},onCreateButtomClick:function(t){if(this._readonly){return BX.PreventDefault(t)}var e=this.getCreateUrl();var i=this.getContext();if(e===""||i===""){return BX.PreventDefault(t)}i=(this.getContext()+"_"+BX.util.getRandomString(6)).toLowerCase();var n={external_context:i};var s=this.getCreateUrlParams();for(var a in s){if(s.hasOwnProperty(a)){n[a]=s[a]}}e=BX.util.add_url_param(e,n);if(!this._externalRequestData){this._externalRequestData={}}this._externalRequestData[i]={context:i,wnd:window.open(e)};if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}return BX.PreventDefault(t)},onEntitySelect:function(t){if(this._readonly){return}var e=this._entityTypeName.toLowerCase();var i=t[e]&&t[e][0]?t[e][0]:null;if(!i){return}var n=parseInt(i["id"]);if(isNaN(n)||n<=0){return}if(this.findItemById(n)>=0){return}if(!this._enableMultiplicity&&this._items.length>0){this.removeItem(this._items[0])}var s=this.addItem(BX.CrmEntityInfo.create(i));if(s){s.layout()}},onItemDelete:function(t){this.removeItem(t)},onItemMark:function(t){var e={name:"mark",item:t,cancel:false};this._changeNotifier.notify([e]);if(e["cancel"]){t.setMarked(!t.isMarked())}},onExternalEvent:function(t){var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";var i=BX.type.isPlainObject(t["value"])?t["value"]:{};var n=BX.type.isNotEmptyString(i["entityTypeName"])?i["entityTypeName"]:"";var s=BX.type.isNotEmptyString(i["context"])?i["context"]:"";if(e==="onCrmEntityCreate"&&n===this._entityTypeName&&this._externalRequestData&&BX.type.isPlainObject(this._externalRequestData[s])){var a=BX.type.isBoolean(i["isCanceled"])?i["isCanceled"]:false;if(!a&&BX.type.isPlainObject(i["entityInfo"])){if(!this._enableMultiplicity&&this._items.length>0){this.removeItem(this._items[0])}var r=this.addItem(BX.CrmEntityInfo.create(i["entityInfo"]));if(r){r.layout()}}if(this._externalRequestData[s]["wnd"]){this._externalRequestData[s]["wnd"].close()}delete this._externalRequestData[s]}}};if(typeof BX.CrmClientPanelGroup.messages==="undefined"){BX.CrmClientPanelGroup.messages={}}BX.CrmClientPanelGroup.create=function(t,e){var i=new BX.CrmClientPanelGroup;i.initialize(t,e);return i}}if(typeof BX.CrmClientPanelGroupItem==="undefined"){BX.CrmClientPanelGroupItem=function(){this._id="";this._settings={};this._parent=null;this._entityTypeName="";this._entityInfo=null;this._commynications=[];this._container=null;this._wrapper=null;this._readOnly=false;this._enableMarking=false;this._isMarked=false;this._hasLayout=false;this._markButton=null;this._deleteButtonHandler=BX.delegate(this.onDeleteButtonClick,this);this._markButtonHandler=BX.delegate(this.onMarkButtonClick,this);this._deleteNotifier=null;this._markNotifier=null};BX.CrmClientPanelGroupItem.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._id=BX.type.isNotEmptyString(t)?t:"CRM_CLIENT_PANEL_GROUP_ITEM"+Math.random();this._settings=BX.type.isPlainObject(e)?e:{};this._parent=this.getSetting("parent");if(!(this._parent instanceof BX.CrmClientPanelGroup)){throw"CrmClientPanelGroupItem: Could not find 'parent' parameter in settings."}this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"CrmClientPanelGroupItem: Could not find 'container' parameter in settings."}this._entityTypeName=this.getSetting("entityType","");if(!BX.type.isNotEmptyString(this._entityTypeName)){throw"CrmClientPanelGroupItem: Could not find 'entityType' parameter in settings."}this._entityInfo=this.getSetting("entityInfo");if(!(this._entityInfo instanceof BX.CrmEntityInfo)){throw"CrmClientPanelGroupItem: Could not find 'entityInfo' parameter in settings."}this._readOnly=!!this.getSetting("readOnly");this._enableMarking=!!this.getSetting("enableMarking");this._deleteNotifier=BX.CrmNotifier.create(this);this._markNotifier=BX.CrmNotifier.create(this)},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getEntityTypeName:function(){return this._entityTypeName},getEntityId:function(){return this._entityInfo.getId()},getEntityInfo:function(){return this._entityInfo},isMarkingEnabled:function(){return this._enableMarking},enebleMarking:function(t){t=!!t;if(this._enableMarking===t){return}this._enableMarking=t;if(this._markButton){this._markButton.style.display=this._enableMarking?"":"none"}},isMarked:function(){return this._isMarked},setMarked:function(t){t=!!t;if(this._isMarked===t){return}this._isMarked=t;this._markNotifier.notify()},layout:function(){if(this._hasLayout){return}var t=this._wrapper=BX.create("DIV",{attrs:{className:"crm-deal-client-selector-card"}});this._container.appendChild(t);var e=BX.create("DIV",{attrs:{className:"crm-deal-client-selector-table-list-title"}});t.appendChild(e);if(this._entityTypeName==="CONTACT"){BX.addClass(e,"crm-deal-client-selector-tab-contact")}else if(this._entityTypeName==="COMPANY"){BX.addClass(e,"crm-deal-client-selector-tab-company")}var i=BX.create("DIV",{attrs:{className:"crm-deal-client-selector-table-list-resp-img"}});var n=this._entityInfo.getLargeImageUrl();if(n!==""){i.appendChild(BX.create("IMG",{attrs:{src:n}}))}e.appendChild(i);var s=BX.create("DIV",{attrs:{className:"crm-deal-client-selector-table-list-title-name-block"}});e.appendChild(s);var a=BX.create("DIV",{attrs:{className:"crm-deal-client-selector-table-list-title-name"},children:[BX.create("A",{attrs:{className:"crm-deal-client-selector-title-name",href:this._entityInfo.getShowUrl(),target:"_blank"},text:this._entityInfo.getTitle()})]});s.appendChild(a);if(!this._readOnly&&this._enableMarking){this._markButton=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-flag",title:this._parent.getCustomMessage("markingTitle")}});a.appendChild(this._markButton);BX.bind(this._markButton,"click",this._markButtonHandler)}s.appendChild(BX.create("DIV",{attrs:{className:"crm-deal-client-selector-table-list-title-descript"},text:this._entityInfo.getDescription()}));if(!this._readOnly){var r=BX.create("DIV",{attrs:{className:"crm-client-selector-tab-close-btn"}});e.appendChild(r);BX.bind(r,"click",this._deleteButtonHandler)}var o,l,h;o=this._entityInfo.getPhones();l=o.length;if(l>0){for(h=0;h<l;h++){this.createCommunicationItem(o[h],e)}}o=this._entityInfo.getEmails();l=o.length;if(l>0){for(h=0;h<l;h++){this.createCommunicationItem(o[h],e)}}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}if(this._markButton){BX.bind(this._markButton,"click",this._markButtonHandler);this._markButton=BX.remove(this._markButton)}for(var t=0;t<this._commynications.length;t++){this._commynications[t].clearLayout()}this._commynications=[];if(this._wrapper){this._wrapper=BX.remove(this._wrapper)}this._hasLayout=false},addDeletionListener:function(t){this._deleteNotifier.addListener(t)},removeDeletionListener:function(t){this._deleteNotifier.removeListener(t)},addMarkingListener:function(t){this._markNotifier.addListener(t)},removeMarkingListener:function(t){this._markNotifier.removeListener(t)},createCommunicationItem:function(t,e){var i=BX.CrmClientPanelCommunication.create("",{container:e,entityId:this.getEntityId(),entityType:this.getEntityTypeName(),fieldInfo:t});i.layout();this._commynications.push(i)},onDeleteButtonClick:function(t){this._deleteNotifier.notify()},onMarkButtonClick:function(t){this.setMarked(true)}};BX.CrmClientPanelGroupItem.create=function(t,e){var i=new BX.CrmClientPanelGroupItem;i.initialize(t,e);return i}}BX.CrmPopupWindowHelper={};BX.CrmPopupWindowHelper.prepareButtons=function(t){var e=[];for(var i=0;i<t.length;i++){var n=t[i];e.push(n["type"]==="link"?new BX.PopupWindowButtonLink(n["settings"]):new BX.PopupWindowButton(n["settings"]))}return e};BX.CrmPopupWindowHelper.prepareTextField=function(t){return BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-field"},children:[BX.create("SPAN",{attrs:{className:"bx-crm-dialog-quick-create-field-title"},text:t["title"]+":"}),BX.create("INPUT",{attrs:{className:"bx-crm-dialog-quick-create-field-text-input"},props:{id:t["id"],value:t["value"]}})]})};BX.CrmPopupWindowHelper.prepareSelectField=function(t){var e=BX.create("SELECT",{attrs:{className:"bx-crm-dialog-quick-create-field-select"},props:{id:t["id"]}});var i=t["value"]?t["value"]:"";if(t["items"]){for(var n=0;n<t["items"].length;n++){var s=t["items"][n];var a=s["value"]?s["value"]:n.toString();var r=BX.create("OPTION",{text:s["text"]?s["text"]:a,props:{value:a}});if(!BX.browser.isIE){e.add(r,null)}else{try{e.add(r,e.options[null])}catch(t){e.add(r,null)}}if(a===i){r.selected=true}}}return BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-field"},children:[BX.create("SPAN",{attrs:{className:"bx-crm-dialog-quick-create-field-title"},text:t["title"]+":"}),e]})};BX.CrmPopupWindowHelper.prepareTextAreaField=function(t){return BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-field"},children:[BX.create("SPAN",{attrs:{className:"bx-crm-dialog-quick-create-field-title"},text:t["title"]+":"}),BX.create("TEXTAREA",{attrs:{className:"bx-crm-dialog-quick-create-field-text-input"},props:{id:t["id"]},text:t["value"]})]})};BX.CrmPopupWindowHelper.prepareCheckBoxField=function(t){var e=BX.create("INPUT",{attrs:{className:"bx-crm-dialog-quick-create-field-checkbox"},props:{id:t["id"],type:"checkbox",checked:!!t["value"]?"checked":""}});if(!!t["value"]){e.checked=true}return BX.create("DIV",{attrs:{className:"bx-crm-dialog-quick-create-field"},children:[BX.create("LABEL",{attrs:{className:"bx-crm-dialog-quick-create-field-checkbox-label"},children:[e,BX.create("SPAN",{attrs:{className:"bx-crm-dialog-quick-create-field-checkbox-label-text"},text:t["title"]})]})]})};BX.CrmPopupWindowHelper.prepareTitle=function(t){return BX.create("DIV",{attrs:{className:"bx-crm-dialog-tittle-wrap"},children:[BX.create("SPAN",{text:t,props:{className:"bx-crm-dialog-title-text"}})]})};BX.CrmEntityDetailViewDialog=function(){this._id="";this._dlg=null;this._settings={}};BX.CrmEntityDetailViewDialog.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"CRM_ENTITY_DETAIL_VIEW_DIALOG_"+Math.random();this._settings=e?e:{}},getId:function(){return this._id},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},isOpened:function(){return this._dlg&&this._dlg.isShown()},open:function(){if(this._dlg){if(!this._dlg.isShown()){this._dlg.show()}return}var t=BX(this.getSetting("containerId"));if(!t){t=BX.findChild(BX("sidebar"),{class:"crm-entity-info-details-container"},true,false)}this._dlg=new BX.PopupWindow(this._id,null,{autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:this.getSetting("title","Details"),events:{onAfterPopupShow:BX.delegate(this._onAfterPopupShow,this),onPopupDestroy:BX.delegate(this._onPopupDestroy,this)},content:t});this._dlg.show()},close:function(){if(this._dlg&&this._dlg.isShown()){this._dlg.close()}},toggle:function(){this.isOpened()?this.close():this.open()},_onAfterPopupShow:function(){var t=BX.findChild(BX("sidebar"),{class:"sidebar-block"},true,false);if(!t){return}var e=BX.pos(t);var i=this._dlg.popupContainer;if(!i){return}var n=BX.pos(i);i.style.top=e.top.toString()+"px";i.style.left=(e.left-n.width-1).toString()+"px"},_onPopupDestroy:function(){this._dlg=null}};BX.CrmEntityDetailViewDialog.items={};BX.CrmEntityDetailViewDialog.create=function(t,e){var i=new BX.CrmEntityDetailViewDialog;i.initialize(t,e);this.items[i.getId()]=i;return i};BX.CrmEntityDetailViewDialog.ensureCreated=function(t,e){return typeof this.items[t]!=="undefined"?this.items[t]:this.create(t,e)};BX.CrmContactEditor=function(){this._id="";this._settings={};this._dlg=null;this._clientField=null;this._mode="CREATE"};BX.CrmContactEditor.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};var i=this.getSetting("data",null);if(i){this._mode="EDIT"}else{i={};this._mode="CREATE"}this._data=BX.CrmContactData.create(i)},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},openDialog:function(t){if(this._dlg){this._dlg.setData(this._data);this._dlg.open(t);return}this._dlg=BX.CrmContactEditDialog.create(this._id,this.getSetting("dialog",{}),this._data,BX.delegate(this._onSaveDialogData,this));if(this._dlg){this._dlg.open(t,this._mode)}},closeDialog:function(){if(this._dlg){this._dlg.close()}},openExternalFieldEditor:function(t){this._clientField=t;this.openDialog()},_onSaveDialogData:function(t){this._data=this._dlg.getData();var e=this.getSetting("serviceUrl","");var i=this.getSetting("actionName","");if(!(BX.type.isNotEmptyString(e)&&BX.type.isNotEmptyString(i))){return}var n=this;BX.ajax({url:e,method:"POST",dataType:"json",data:{ACTION:i,DATA:this._data.toJSON(),NAME_TEMPLATE:this.getSetting("nameTemplate","")},onsuccess:function(t){if(t["ERROR"]){n._showDialogError(t["ERROR"])}else if(!t["DATA"]){n._showDialogError("BX.CrmContactEditor: Could not find contact data!")}else{n._data=BX.CrmContactData.create(t["DATA"]);var e=t["INFO"]?t["INFO"]:{};n._clientField.setFieldValue(BX.type.isNotEmptyString(e["title"])?BX.util.htmlspecialchars(e["title"]):"");n.closeDialog()}},onfailure:function(t){n._showDialogError(t["ERROR"]?t["ERROR"]:n.getMessage("unknownError"))}})},_showDialogError:function(t){if(this._dlg){this._dlg.showError(t)}}};BX.CrmContactEditor.create=function(t,e){var i=new BX.CrmContactEditor;i.initialize(t,e);return i};BX.CrmSonetSubscription=function(){this._id="";this._settings={}};BX.CrmSonetSubscription.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{}},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},enableSubscription:function(t,e,i){var n=this.getSetting("serviceUrl","");var s=this.getSetting("actionName","");if(!(BX.type.isNotEmptyString(n)&&BX.type.isNotEmptyString(s))){return}var a=this.getSetting("reload",false);BX.ajax({url:n,method:"POST",dataType:"json",data:{ACTION:s,ENTITY_TYPE:this.getSetting("entityType",""),ENTITY_ID:t,ENABLE:e?"Y":"N"},onsuccess:function(t){if(BX.type.isFunction(i)){i()}},onfailure:function(t){}})},subscribe:function(t,e){this.enableSubscription(t,true,e)},unsubscribe:function(t,e){this.enableSubscription(t,false,e)}};BX.CrmSonetSubscription.items={};BX.CrmSonetSubscription.create=function(t,e){var i=new BX.CrmSonetSubscription;i.initialize(t,e);this.items[t]=i;return i};if(typeof BX.CrmFormTabLazyLoader=="undefined"){BX.CrmFormTabLazyLoader=function(){this._id="";this._settings={};this._container=null;this._wrapper=null;this._serviceUrl="";this._formId="";this._tabId="";this._params={};this._formManager=null;this._isRequestRunning=false;this._isLoaded=false;this._waiter=null;this._scrollHandler=BX.delegate(this._onWindowScroll,this);this._formManagerHandler=BX.delegate(this._onFormManagerCreate,this)};BX.CrmFormTabLazyLoader.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_lf_disp_"+Math.random().toString().substring(2);this._settings=e?e:{};this._container=BX(this.getSetting("containerID",""));if(!this._container){throw"Error: Could not find container."}this._wrapper=BX.findParent(this._container,{tagName:"DIV",className:"bx-edit-tab-inner"});this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"Error. Could not find service url."}this._formId=this.getSetting("formID","");if(!BX.type.isNotEmptyString(this._formId)){throw"Error: Could not find form id."}this._tabId=this.getSetting("tabID","");if(!BX.type.isNotEmptyString(this._tabId)){throw"Error: Could not find tab id."}this._params=this.getSetting("params",{});var i=window["bxForm_"+this._formId];if(i){this.setFormManager(i)}else{BX.addCustomEvent(window,"CrmInterfaceFormCreated",this._formManagerHandler)}},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},load:function(){if(this._isLoaded){return}var t=this._params;t["FORM_ID"]=this._formId;t["TAB_ID"]=this._tabId;this._startRequest(t)},getContainerRect:function(){var t=this._container.getBoundingClientRect();return{top:t.top,bottom:t.bottom,left:t.left,right:t.right,width:typeof t.width!=="undefined"?t.width:t.right-t.left,height:typeof t.height!=="undefined"?t.height:t.bottom-t.top}},isContanerInClientRect:function(){return this.getContainerRect().top<=document.documentElement.clientHeight},setFormManager:function(t){if(this._formManager===t){return}this._formManager=t;if(!this._formManager){return}if(this._formManager.GetActiveTabContainer()===this._wrapper){if(this.isContanerInClientRect()){this.load()}else{BX.bind(window,"scroll",this._scrollHandler)}}else{BX.addCustomEvent(window,"BX_CRM_INTERFACE_FORM_TAB_SELECTED",BX.delegate(this._onFormTabSelect,this))}},_startRequest:function(t){if(this._isRequestRunning){return false}this._isRequestRunning=true;this._waiter=BX.showWait(this._container);BX.ajax({url:this._serviceUrl,method:"POST",dataType:"html",data:{LOADER_ID:this._id,PARAMS:t},onsuccess:BX.delegate(this._onRequestSuccess,this),onfailure:BX.delegate(this._onRequestFailure,this)});return true},_onRequestSuccess:function(t){this._isRequestRunning=false;if(this._waiter){BX.closeWait(this._container,this._waiter);this._waiter=null}this._container.innerHTML=t;this._isLoaded=true},_onRequestFailure:function(t){this._isRequestRunning=false;if(this._waiter){BX.closeWait(this._container,this._waiter);this._waiter=null}this._isLoaded=true},_onFormManagerCreate:function(t){if(t["name"]===this._formId){BX.removeCustomEvent(window,"CrmInterfaceFormCreated",this._formManagerHandler);this.setFormManager(t)}},_onFormTabSelect:function(t,e,i,n){if(this._formId===e&&this._wrapper===n){this.load()}},_onWindowScroll:function(t){if(!this._isLoaded&&!this._isRequestRunning&&this.isContanerInClientRect()){BX.unbind(window,"scroll",this._scrollHandler);this.load()}}};BX.CrmFormTabLazyLoader.items={};BX.CrmFormTabLazyLoader.create=function(t,e){var i=new BX.CrmFormTabLazyLoader;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmCustomDragItem==="undefined"){BX.CrmCustomDragItem=function(){this._id="";this._settings={};this._node=null;this._ghostNode=null;this._ghostOffset={x:0,y:0};this._previousPos=null;this._currentPos=null;this._enableDrag=true;this._isInDragMode=false;this._dragNotifier=null;this._preserveDocument=false;this._bodyOverflow=""};BX.CrmCustomDragItem.prototype={initialize:function(t,e){if(typeof jsDD==="undefined"){throw"CrmCustomDragItem: Could not find jsDD API."}this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(8);this._settings=e?e:{};this._node=this.getSetting("node");if(!this._node){throw"CrmCustomDragItem: The 'node' parameter is not defined in settings or empty."}this._enableDrag=this.getSetting("enableDrag",true);this._ghostOffset=this.getSetting("ghostOffset",{x:0,y:0});this._dragNotifier=BX.CrmNotifier.create(this);this.doInitialize();this.bindEvents()},doInitialize:function(){},release:function(){this.doRelease();this.unbindEvents()},doRelease:function(){},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},bindEvents:function(){this._node.onbxdragstart=BX.delegate(this._onDragStart,this);this._node.onbxdrag=BX.delegate(this._onDrag,this);this._node.onbxdragstop=BX.delegate(this._onDragStop,this);this._node.onbxdragrelease=BX.delegate(this._onDragRelease,this);jsDD.registerObject(this._node);this.doBindEvents()},doBindEvents:function(){},unbindEvents:function(){delete this._node.onbxdragstart;delete this._node.onbxdrag;delete this._node.onbxdragstop;delete this._node.onbxdragrelease;if(BX.type.isFunction(jsDD.unregisterObject)){jsDD.unregisterObject(this._node)}this.doUnbindEvents()},doUnbindEvents:function(){},createGhostNode:function(){throw"CrmCustomDragItem: The 'createGhostNode' function is not implemented."},getGhostNode:function(){return this._ghostNode},removeGhostNode:function(){throw"CrmCustomDragItem: The 'removeGhostNode' function is not implemented."},processDragStart:function(){},processDragPositionChange:function(t){},processDrag:function(t,e){},processDragStop:function(){},addDragListener:function(t){this._dragNotifier.addListener(t)},removeDragListener:function(t){this._dragNotifier.removeListener(t)},getContextId:function(){return""},getContextData:function(){return{}},getScrollTop:function(){var t=document.documentElement;var e=document.body;var i=t.scrollTop||e&&e.scrollTop||0;i-=t.clientTop;return i},getScrollHeight:function(){var t=document.documentElement;var e=document.body;return t.scrollHeight||e&&e.scrollHeight||0},isDragDropBinEnabled:function(){return true},_onDragStart:function(){if(!this._enableDrag){return}this.createGhostNode();var t=BX.pos(this._node);this._ghostNode.style.top=t.top+"px";this._ghostNode.style.left=t.left+"px";this._currentPos=this._previousPos=null;this._isInDragMode=true;BX.CrmCustomDragItem.currentDragged=this;BX.onCustomEvent("CrmDragItemDragStart",[this]);this.processDragStart();window.setTimeout(BX.delegate(this._prepareDocument,this),0)},_onDrag:function(t,e){if(!this._isInDragMode){return}var i={x:t,y:e};this.processDragPositionChange(i);if(this._ghostNode){this._ghostNode.style.top=i.y+this._ghostOffset.y+"px";this._ghostNode.style.left=i.x+this._ghostOffset.x+"px"}this._currentPos=i;if(!this._previousPos){this._previousPos=i}this._scrollIfNeed();this.processDrag(i.x,i.y);this._dragNotifier.notify([i.x,i.y]);this._previousPos=this._currentPos},_onDragStop:function(t,e){if(!this._isInDragMode){return}this.removeGhostNode();this._isInDragMode=false;if(BX.CrmCustomDragItem.currentDragged===this){BX.CrmCustomDragItem.currentDragged=null}this._currentPos=this._previousPos=null;BX.onCustomEvent("CrmDragItemDragStop",[this]);this.processDragStop();window.setTimeout(BX.delegate(this._resetDocument,this),0)},_onDragRelease:function(t,e){BX.onCustomEvent("CrmDragItemDragRelease",[this])},_prepareDocument:function(){if(!this._preserveDocument){this._bodyOverflow=document.body.style.overflow;document.body.style.overflow="hidden"}},_resetDocument:function(){if(!this._preserveDocument){document.body.style.overflow=this._bodyOverflow}},_scrollIfNeed:function(){if(!this._ghostNode){return}var t=window.document.documentElement;var e=t.clientTop;var i=t.clientTop+t.clientHeight;var n=this.getScrollHeight();var s=this._currentPos.y-this._previousPos.y;if(s===0){return}var a=-1;for(;;){var r=this.getScrollTop();var o=this._ghostNode.getBoundingClientRect();if(s>0&&(o.bottom>i||i-o.bottom<64)){if(r>=n||a===r){break}a=r;r+=1;window.scrollTo(0,r<n?r:n)}else if(s<0&&(e>o.top||o.top-e<64)){if(r<=0||a===r){break}a=r;r-=1;window.scrollTo(0,r>0?r:0)}else{break}}}};BX.CrmCustomDragItem.currentDragged=null;BX.CrmCustomDragItem.emulateDrag=function(){jsDD.refreshDestArea();if(jsDD.current_node){jsDD.drag({clientX:jsDD.x-jsDD.wndSize.scrollLeft,clientY:jsDD.y-jsDD.wndSize.scrollTop})}}}if(typeof BX.CrmCustomDragContainer==="undefined"){BX.CrmCustomDragContainer=function(){this._id="";this._settings={};this._node=null;this._itemDragHandler=BX.delegate(this._onItemDrag,this);this._draggedItem=null;this._dragFinishNotifier=null;this._enabled=true};BX.CrmCustomDragContainer.prototype={initialize:function(t,e){if(typeof jsDD==="undefined"){throw"CrmCustomDragContainer: Could not find jsDD API."}this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(8);this._settings=e?e:{};this._node=this.getSetting("node");if(!this._node){throw"CrmCustomDragContainer: The 'node' parameter is not defined in settings or empty."}this._dragFinishNotifier=BX.CrmNotifier.create(this);this.doInitialize();this.bindEvents()},doInitialize:function(){},release:function(){this.doRelease();this.unbindEvents()},doRelease:function(){},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},bindEvents:function(){this._node.onbxdestdraghover=BX.delegate(this._onDragOver,this);this._node.onbxdestdraghout=BX.delegate(this._onDragOut,this);this._node.onbxdestdragfinish=BX.delegate(this._onDragFinish,this);this._node.onbxdragstop=BX.delegate(this._onDragStop,this);this._node.onbxdragrelease=BX.delegate(this._onDragRelease,this);jsDD.registerDest(this._node,this.getPriority());this.doBindEvents()},doBindEvents:function(){},unbindEvents:function(){delete this._node.onbxdestdraghover;delete this._node.onbxdestdraghout;delete this._node.onbxdestdragfinish;delete this._node.onbxdragstop;delete this._node.onbxdragrelease;if(BX.type.isFunction(jsDD.unregisterDest)){jsDD.unregisterDest(this._node)}this.doUnbindEvents()},doUnbindEvents:function(){},createPlaceHolder:function(t){throw"CrmCustomDragContainer: The 'createPlaceHolder' function is not implemented."},removePlaceHolder:function(){throw"CrmCustomDragContainer: The 'removePlaceHolder' function is not implemented."},initializePlaceHolder:function(t){this.createPlaceHolder(t);this.refresh()},releasePlaceHolder:function(){this.removePlaceHolder();this.refresh()},getPriority:function(){return BX.CrmCustomDragContainer.defaultPriority},addDragFinishListener:function(t){this._dragFinishNotifier.addListener(t)},removeDragFinishListener:function(t){this._dragFinishNotifier.removeListener(t)},getDraggedItem:function(){return this._draggedItem},setDraggedItem:function(t){if(this._draggedItem===t){return}if(this._draggedItem){this._draggedItem.removeDragListener(this._itemDragHandler)}this._draggedItem=t;if(this._draggedItem){this._draggedItem.addDragListener(this._itemDragHandler)}},isAllowedContext:function(t){return true},isEnabled:function(){return this._enabled},enable:function(t){t=!!t;if(this._enabled===t){return}this._enabled=t;if(t){jsDD.enableDest(this._node)}else{jsDD.disableDest(this._node)}},refresh:function(){jsDD.refreshDestArea(this._node.__bxddeid)},processDragOver:function(t){this.initializePlaceHolder(t)},processDragOut:function(){this.releasePlaceHolder()},processDragStop:function(){this.releasePlaceHolder()},processDragRelease:function(){this.releasePlaceHolder()},processItemDrop:function(){this.releasePlaceHolder()},_onDragOver:function(t,e,i){var n=BX.CrmCustomDragItem.currentDragged;if(!n){return}if(!this.isAllowedContext(n.getContextId())){return}this.setDraggedItem(n);this.processDragOver({x:e,y:i})},_onDragOut:function(t,e,i){if(!this._draggedItem){return}this.processDragOut();this.setDraggedItem(null)},_onDragFinish:function(t,e,i){if(!this._draggedItem){return}this._dragFinishNotifier.notify([this._draggedItem,e,i]);this.processItemDrop();this.setDraggedItem(null);BX.CrmCustomDragContainer.refresh()},_onDragRelease:function(t,e,i){if(!this._draggedItem){return}this.processDragRelease();this.setDraggedItem(null)},_onDragStop:function(t,e,i){if(!this._draggedItem){return}this.processDragStop();this.setDraggedItem(null)},_onItemDrag:function(t,e,i){if(!this._draggedItem){return}this.initializePlaceHolder({x:e,y:i})}};BX.CrmCustomDragContainer.defaultPriority=100;BX.CrmCustomDragContainer.refresh=function(){jsDD.refreshDestArea()}}BX.CrmDragDropBinState={suspend:0,wait:1,ready:2,open:3,close:4};if(typeof BX.CrmDragDropBin==="undefined"){BX.CrmDragDropBin=function(){this._state=BX.CrmDragDropBinState.suspend;this._chargeItem=null;this._enableChargeItem=false;this._chargeDragStartHandler=BX.delegate(this._onChargeDragStart,this);this._chargeDragStopHandler=BX.delegate(this._onChargeDragStop,this);this._chargeDragReleaseHandler=BX.delegate(this._onChargeDragRelease,this);this._chargeDragHandler=BX.delegate(this._onChargeDrag,this);this._workareaRect=null;this._promptingWrapper=null;this._closePromptingButtonId="crm_dd_bin_close_prompting_btn";this._closePromptingHandler=BX.delegate(this._onClosePromptingButtonClick,this);this._demoButtonId="crm_dd_bin_demo_btn";this._demoHandler=BX.delegate(this._onDemoButtonClick,this)};BX.extend(BX.CrmDragDropBin,BX.CrmCustomDragContainer);BX.CrmDragDropBin.prototype.doInitialize=function(){BX.addCustomEvent(window,"CrmDragItemDragStart",this._chargeDragStartHandler);BX.addCustomEvent(window,"CrmDragItemDragStop",this._chargeDragStopHandler);BX.addCustomEvent(window,"CrmDragItemDragRelease",this._chargeDragReleaseHandler);this.cacheWorkareaRect();BX.bind(window,"resize",BX.delegate(this._onWindowResize,this))};BX.CrmDragDropBin.prototype.getPriority=function(){return 10};BX.CrmDragDropBin.prototype.createPlaceHolder=function(t){};BX.CrmDragDropBin.prototype.removePlaceHolder=function(){};BX.CrmDragDropBin.prototype.processDragOver=function(t){if(this._chargeItem){this._enableChargeItem=false}this.setState(BX.CrmDragDropBinState.open)};BX.CrmDragDropBin.prototype.processDragOut=function(){if(this._chargeItem){this._enableChargeItem=true}this.setState(BX.CrmDragDropBinState.ready)};BX.CrmDragDropBin.prototype.processDragStop=function(){this.setState(BX.CrmDragDropBinState.suspend)};BX.CrmDragDropBin.prototype.processDragRelease=function(){this.setState(BX.CrmDragDropBinState.suspend)};BX.CrmDragDropBin.prototype.processItemDrop=function(){if(this._chargeItem){this._chargeItem.removeDragListener(this._chargeDragHandler);this._chargeItem=null}this._enableChargeItem=false;this.setState(BX.CrmDragDropBinState.close);window.setTimeout(BX.delegate(this.reset,this),1e3);BX.onCustomEvent(this,"CrmDragDropBinItemDrop",[this,this.getDraggedItem()])};BX.CrmDragDropBin.prototype.getState=function(){return this._state};BX.CrmDragDropBin.prototype.reset=function(){this.setState(BX.CrmDragDropBinState.suspend)};BX.CrmDragDropBin.prototype.setState=function(t){t=parseInt(t);if(t<BX.CrmDragDropBinState.suspend||t>BX.CrmDragDropBinState.close){t=BX.CrmDragDropBinState.suspend}if(this._state===t){return}this._state=t;var e=["crm-cart-block-wrap"];if(this._state>=BX.CrmDragDropBinState.wait){e.push("crm-cart-start")}if(this._state>=BX.CrmDragDropBinState.ready){e.push("crm-cart-active")}if(this._state>=BX.CrmDragDropBinState.open){e.push("crm-cart-hover")}if(this._state===BX.CrmDragDropBinState.close){e.push("crm-cart-finish")}this._node.className=e.join(" ");window.setTimeout(BX.delegate(BX.CrmCustomDragItem.emulateDrag,this),400);window.setTimeout(BX.delegate(BX.CrmCustomDragItem.emulateDrag,this),800)};BX.CrmDragDropBin.prototype._onChargeDragStart=function(t){if(!t.isDragDropBinEnabled()){return}this._enableChargeItem=true;this._chargeItem=t;this._chargeItem.addDragListener(this._chargeDragHandler);this.setState(BX.CrmDragDropBinState.wait)};BX.CrmDragDropBin.prototype._onChargeDragStop=function(t){if(!this._enableChargeItem||this._chargeItem!==t){return}this._chargeItem.removeDragListener(this._chargeDragHandler);this._chargeItem=null;this._enableChargeItem=false;this.setState(BX.CrmDragDropBinState.suspend)};BX.CrmDragDropBin.prototype._onChargeDragRelease=function(t){if(!this._enableChargeItem||this._chargeItem!==t){return}this._chargeItem.removeDragListener(this._chargeDragHandler);this._chargeItem=null;this._enableChargeItem=false;this.setState(BX.CrmDragDropBinState.suspend)};BX.CrmDragDropBin.prototype._onChargeDrag=function(t,e,i){if(this._enableChargeItem&&this._chargeItem===t){this.adjust()}};BX.CrmDragDropBin.prototype._onWindowResize=function(t){this.cacheWorkareaRect()};BX.CrmDragDropBin.prototype.cacheWorkareaRect=function(){var t=BX("workarea");if(!t){t=document.documentElement}this._workareaRect=BX.pos(t);this._readyThreshold=this._workareaRect.width/6};BX.CrmDragDropBin.prototype.adjust=function(){if(!this._chargeItem){return}var t=this._chargeItem.getGhostNode();if(!t){return}var e=BX.pos(t);var i=this._state>=BX.CrmDragDropBinState.ready;if(i!==this._workareaRect.right-e.left<=this._readyThreshold){i=!i;this.setState(i?BX.CrmDragDropBinState.ready:BX.CrmDragDropBinState.wait)}};BX.CrmDragDropBin.prototype.getMessage=function(t,e){var i=BX.CrmDragDropBin.messages;return i.hasOwnProperty(t)?i[t]:e};BX.CrmDragDropBin.prototype.showPromptingIfRequired=function(t){if(BX.localStorage.get("crm_dd_bin_show_prompt")!=="N"){this.showPrompting(t)}};BX.CrmDragDropBin.prototype.showPrompting=function(t){if(this._promptingWrapper){return}var e=this.getMessage("prompting");e=e.replace("#CLOSE_BTN_ID#",this._closePromptingButtonId).replace("#DEMO_BTN_ID#",this._demoButtonId);this._promptingWrapper=BX.create("DIV",{attrs:{className:"crm-view-message"},html:e});t.appendChild(this._promptingWrapper);BX.bind(BX(this._closePromptingButtonId),"click",this._closePromptingHandler);BX.bind(BX(this._demoButtonId),"click",this._demoHandler)};BX.CrmDragDropBin.prototype.hidePrompting=function(){if(!this._promptingWrapper){return}BX.localStorage.set("crm_dd_bin_show_prompt","N",31104e3);BX.unbind(BX(this._closePromptingButtonId),"click",this._closePromptingHandler);BX.unbind(BX(this._demoButtonId),"click",this._demoHandler);BX.remove(this._promptingWrapper)};BX.CrmDragDropBin.prototype.demo=function(){this.setState(BX.CrmDragDropBinState.wait);var t=this;window.setTimeout((function(){t.setState(BX.CrmDragDropBinState.ready)}),1e3);window.setTimeout((function(){t.setState(BX.CrmDragDropBinState.open)}),1500);window.setTimeout((function(){t.setState(BX.CrmDragDropBinState.close)}),2e3)};BX.CrmDragDropBin.prototype._onDemoButtonClick=function(t){this.demo();return BX.PreventDefault(t)};BX.CrmDragDropBin.prototype._onClosePromptingButtonClick=function(t){this.hidePrompting();return BX.PreventDefault(t)};BX.CrmDragDropBin.instance=null;BX.CrmDragDropBin.getInstance=function(){if(this.instance){return this.instance}var t=BX.create("DIV",{attrs:{className:"crm-cart-block-wrap"},children:[BX.create("DIV",{attrs:{className:"crm-cart-block"},children:[BX.create("DIV",{attrs:{className:"crm-cart-icon"},children:[BX.create("DIV",{attrs:{className:"crm-cart-icon-top"}}),BX.create("DIV",{attrs:{className:"crm-cart-icon-body"}})]})]})]});document.body.appendChild(t);var e=new BX.CrmDragDropBin;e.initialize("default",{node:t});return this.instance=e};if(typeof BX.CrmDragDropBin.messages==="undefined"){BX.CrmDragDropBin.messages={}}}if(typeof BX.CrmLocalitySearchField==="undefined"){BX.CrmLocalitySearchField=function(){this._id="";this._settings={};this._localityType="";this._serviceUrl="";this._searchInput=null;this._dataInput=null;this._timeoutId=0;this._value="";this._items=[];this._menuId="crm-locality-search";this._menu=null;this._isRequestStarted=false;this._checkHandler=BX.delegate(this.check,this);this._keyPressHandler=BX.delegate(this.onKeyPress,this);this._menuItemClickHandler=BX.delegate(this.onMenuItemClick,this);this._searchCompletionHandler=BX.delegate(this.onSearchRequestComplete,this)};BX.CrmLocalitySearchField.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_loc_search_field_"+Math.random();this._settings=e?e:{};this._localityType=this.getSetting("localityType");if(!BX.type.isNotEmptyString(this._localityType)){throw"BX.CrmLocalitySearchField: localityType is not found!"}this._serviceUrl=this.getSetting("serviceUrl");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"BX.CrmLocalitySearchField: serviceUrl is not found!"}this._searchInput=this.findElement("searchInput");if(!BX.type.isElementNode(this._searchInput)){throw"BX.CrmLocalitySearchField: searchInput is not found!"}this._dataInput=this.findElement("dataInput");if(!BX.type.isElementNode(this._dataInput)){throw"BX.CrmLocalitySearchField: dataInputId is not found!"}BX.bind(this._searchInput,"keyup",BX.proxy(this._keyPressHandler,this));BX.bind(document,"click",BX.delegate(this._handleExternalClick,this))},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},findElement:function(t){var e=this.getSetting(t);if(BX.type.isElementNode(t)){return e}var i=null;if(BX.type.isNotEmptyString(e)){i=BX(e);if(!i){var n=document.getElementsByName(e);if(n.length>0){i=n[0]}}}return i!==undefined?i:null},check:function(){this._timeoutId=0;if(this._value!==this._searchInput.value){this._value=this._searchInput.value;this._timeoutId=window.setTimeout(this._checkHandler,750)}else if(this._value.length>=2){this.startSearchRequest(this._value)}},startSearchRequest:function(t){if(this._isRequestStarted){return false}this._isRequestStarted=true;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"FIND_LOCALITIES",LOCALITY_TYPE:this._localityType,NEEDLE:t},onsuccess:this._searchCompletionHandler,onfailure:this._searchCompletionHandler})},showMenu:function(t){BX.PopupMenu.destroy(this._menuId);var e=[];for(var i=0;i<t.length;i++){e.push(this.prepareMenuItem(t[i]))}this._menu=BX.PopupMenu.create(this._menuId,this._searchInput,e,{offsetTop:0,offsetLeft:0});this._menu.popupWindow.show()},closeMenu:function(){BX.PopupMenu.destroy(this._menuId);this._menu=null},prepareMenuItem:function(t){var e=BX.type.isNotEmptyString(t["CODE"])?t["CODE"]:"";if(e===""){throw"BX.CrmLocalitySearchField: could not find item code!"}var i=BX.type.isNotEmptyString(t["CAPTION"])?t["CAPTION"]:e;return{value:e,text:i,onclick:this._menuItemClickHandler}},onMenuItemClick:function(t,e){this.selectItem(e);this.closeMenu()},selectItem:function(t){this._dataInput.value=t["value"];this._searchInput.value=t["text"]},onKeyPress:function(t){if(this._timeoutId!==0){window.clearTimeout(this._timeoutId);this._timeoutId=0}this._timeoutId=window.setTimeout(this._checkHandler,375)},onSearchRequestComplete:function(t){this._isRequestStarted=false;var e=typeof t["DATA"]!=="undefined"&&typeof t["DATA"]["ITEMS"]!=="undefined"?t["DATA"]["ITEMS"]:[];if(e.length>0){this.showMenu(e)}}};BX.CrmLocalitySearchField.create=function(t,e){var i=new BX.CrmLocalitySearchField;i.initialize(t,e);return i}}if(typeof BX.CrmAddressType==="undefined"){BX.CrmAddressType={undefined:0,primary:1,secondary:2,third:3,home:4,work:5,registered:6,custom:7,post:8,beneficiary:9,bank:10,delivery:11,billing:12}}if(typeof BX.CrmMultipleAddressEditor==="undefined"){BX.CrmMultipleAddressEditor=function(){this._id="";this._settings={};this._fieldId="";this._formId="";this._scheme=null;this._data=null;this._currentTypeId=0;this._typeInfos=null;this._fieldLabels=null;this._fielNameTemplate="";this._serviceUrl="";this._container=null;this._createButton=null;this._typeMenuButton=null;this._createButtonHandler=BX.delegate(this.onCreateButtonClick,this);this._typenuButtonHandler=BX.delegate(this.onTypeMenuButtonClick,this);this._typeMenuItemClickHandler=BX.delegate(this.onTypeMenuItemClick,this);this._typeMenuCloseHandler=BX.delegate(this.onTypeMenuClose,this);this._typeMenuId="";this._isTypeMenuOpened=false;this._items={};this._entityAddresses={}};BX.CrmMultipleAddressEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_multiaddr_"+Math.random();this._settings=e?e:{};this._fieldId=this.getSetting("fieldId","");this._formId=this.getSetting("formId","");this._scheme=this.getSetting("scheme");if(!BX.type.isArray(this._scheme)){throw"BX.CrmMultipleAddressEditor: Could not find a parameter named 'scheme'."}this._data=this.getSetting("data");if(!BX.type.isPlainObject(this._data)){throw"BX.CrmMultipleAddressEditor: Could not find a parameter named 'data'."}this._typeInfos=this.getSetting("typeInfos");if(!BX.type.isArray(this._typeInfos)){throw"BX.CrmMultipleAddressEditor: Could not find a parameter named 'typeInfos'."}this._fieldLabels=this.getSetting("fieldLabels");if(!BX.type.isPlainObject(this._fieldLabels)){throw"BX.CrmMultipleAddressEditor: Could not find a parameter named 'fieldLabels'."}this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"BX.CrmMultipleAddressEditor: Could not find a parameter named 'container'."}this._itemWrapper=BX.findChildByClassName(this._container,"crm-multi-address");var i=this.getSetting("createButtonContainer");if(BX.type.isElementNode(i)){this._createButton=BX.findChildByClassName(i,"crm-offer-requisite-option-text");if(this._createButton){BX.bind(this._createButton,"click",this._createButtonHandler)}this._typeMenuButton=BX.findChildByClassName(i,"crm-offer-requisite-option-arrow");if(this._typeMenuButton){BX.bind(this._typeMenuButton,"click",this._typenuButtonHandler)}}this._currentTypeId=this.getSetting("currentTypeId");this._fielNameTemplate=this.getSetting("fielNameTemplate","");this._serviceUrl=this.getSetting("serviceUrl","");for(var n in this._data){if(!this._data.hasOwnProperty(n)){continue}var s=parseInt(n);var a=this._id+"_"+s.toString();var r=this._fielNameTemplate.replace("#TYPE_ID#",s).replace("#FIELD_NAME#","wrapper").toLowerCase();this._items[a]=BX.CrmMultipleAddressItemEditor.create(a,{typeId:s,fields:this._data[n],editor:this,container:BX(r),hasLayout:true,isPersistent:true})}},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getFieldId:function(){return this._fieldId},getFormId:function(){return this._formId},getScheme:function(){return this._scheme},getTypeName:function(t){for(var e=0;e<this._typeInfos.length;e++){var i=this._typeInfos[e];if(i["id"]==t){return i["name"]}}return t},getFieldLabel:function(t){return this._fieldLabels.hasOwnProperty(t)?this._fieldLabels[t]:t},getFieldNameTemplate:function(){return this._fielNameTemplate},prepareQualifiedName:function(t,e){if(this._fielNameTemplate!==""){if(!BX.type.isPlainObject(e)){e={}}var i=typeof e["typeId"]!=="undefined"?e["typeId"]:this._currentTypeId;t=this._fielNameTemplate.replace("#TYPE_ID#",i).replace("#FIELD_NAME#",t)}return t},getServiceUrl:function(){return this._serviceUrl},getMessage:function(t){var e=BX.CrmMultipleAddressEditor.messages;return e.hasOwnProperty(t)?e[t]:t},createItem:function(t,e,i){if(!BX.type.isNumber(t)){t=parseInt(t)}if(isNaN(t)||t<=0){t=this._currentTypeId}if(!BX.type.isString(e)){e=""}var n=BX.create("DIV",{attrs:{className:"crm-multi-address-item"}});this._itemWrapper.appendChild(n);var s=false;var a=this._id+"_"+t.toString();if(this._items.hasOwnProperty(a)){var r=this._items[a];if(r.isMarkedAsDeleted()){s=r.isPersistent();this.removeItem(r,true)}else{if(!i){window.alert(this.getMessage("alreadyExists").replace("#TYPE_NAME#",this.getTypeName(t)))}return false}}var o=BX.CrmMultipleAddressItemEditor.create(a,{typeId:t,fields:{},editor:this,container:n,hasLayout:false,isPersistent:s,originatorId:e});this._items[a]=o;o.layout();if(this._itemWrapper.style.display==="none"){this._itemWrapper.style.display=""}BX.onCustomEvent(this,"CrmMultipleAddressItemCreated",[this,o]);return o},removeItem:function(t,e){var i=t.getId();if(!this._items.hasOwnProperty(i)){return false}if(!t.isPersistent()||!!e){t.cleanLayout();BX.remove(t.getContainer());delete this._items[i]}if(this.getActiveItemCount()===0){this._itemWrapper.style.display="none"}return true},getItemByTypeId:function(t){t=parseInt(t);if(isNaN(t)||t<=0){return null}for(var e in this._items){if(!this._items.hasOwnProperty(e)){continue}var i=this._items[e];if(t===i.getTypeId()){return i}}return null},getActiveItemCount:function(){var t=0;for(var e in this._items){if(this._items.hasOwnProperty(e)&&!this._items[e].isMarkedAsDeleted()){t++}}return t},loadEntityAddress:function(t,e,i,n){if(BX.type.isPlainObject(this._entityAddresses[e])&&BX.type.isPlainObject(this._entityAddresses[e][i])&&BX.type.isPlainObject(this._entityAddresses[e][i][t])){n(this._entityAddresses[e][i][t]["fields"]);return}if(!BX.type.isPlainObject(this._entityAddresses[e])){this._entityAddresses[e]={}}if(!BX.type.isPlainObject(this._entityAddresses[e][i])){this._entityAddresses[e][i]={}}if(!BX.type.isPlainObject(this._entityAddresses[e][i][t])){this._entityAddresses[e][i][t]={}}if(BX.type.isFunction(n)){if(!BX.type.isArray(this._entityAddresses[e][i][t]["callbacks"])){this._entityAddresses[e][i][t]["callbacks"]=[]}this._entityAddresses[e][i][t]["callbacks"].push(n)}BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"GET_ENTITY_ADDRESS",ENTITY_TYPE_ID:e,ENTITY_ID:i,TYPE_ID:t},onsuccess:BX.delegate(this.onEntityAddressLoadSuccess,this)})},openTypeMenu:function(){if(this._isTypeMenuOpened){return}var t=[];for(var e=0;e<this._typeInfos.length;e++){var i=this._typeInfos[e];t.push({text:i["name"],id:i["id"],className:"crm-convert-item",onclick:this._typeMenuItemClickHandler})}if(typeof BX.PopupMenu.Data[this._typeMenuId]!=="undefined"){BX.PopupMenu.Data[this._typeMenuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._typeMenuId]}BX.PopupMenu.show(this._typeMenuId,this._typeMenuButton,t,{autoHide:true,offsetLeft:BX.pos(this._typeMenuButton)["width"]/2,angle:{position:"top",offset:0},events:{onPopupClose:this._typeMenuCloseHandler}});this._isTypeMenuOpened=true},closeTypeMenu:function(){if(this._isTypeMenuOpened){BX.PopupMenu.destroy(this._typeMenuId);this._isTypeMenuOpened=false}},onCreateButtonClick:function(t){this.createItem(this._currentTypeId)},onTypeMenuButtonClick:function(t){if(!this._isTypeMenuOpened){this.openTypeMenu()}else{this.closeTypeMenu()}return BX.PreventDefault(t)},onTypeMenuItemClick:function(t,e){this._currentTypeId=parseInt(e["id"]);this._createButton.innerHTML=this.getTypeName(this._currentTypeId);this.closeTypeMenu()},onTypeMenuClose:function(t){this._isTypeMenuOpened=false},onEntityAddressLoadSuccess:function(t){if(!BX.type.isPlainObject(t["DATA"])){return}var e=t["DATA"];var i=typeof e["ENTITY_TYPE_ID"]?parseInt(e["ENTITY_TYPE_ID"]):0;var n=typeof e["ENTITY_ID"]?parseInt(e["ENTITY_ID"]):0;if(isNaN(i)||i<=0||isNaN(n)||n<=0){return}if(!BX.type.isPlainObject(this._entityAddresses[i])){this._entityAddresses[i]={}}if(!BX.type.isPlainObject(this._entityAddresses[i][n])){this._entityAddresses[i][n]={}}var s=BX.type.isPlainObject(e["FIELDS"])?e["FIELDS"]:null;var a=s!==null&&typeof s["TYPE_ID"]!=="undefined"?parseInt(s["TYPE_ID"]):1;if(!BX.type.isPlainObject(this._entityAddresses[i][n][a])){this._entityAddresses[i][n][a]={}}this._entityAddresses[i][n][a]["fields"]=s;if(BX.type.isArray(this._entityAddresses[i][n][a]["callbacks"])){var r=this._entityAddresses[i][n][a]["callbacks"];for(var o=0;o<r.length;o++){r[o](s)}delete this._entityAddresses[i][n][a]["callbacks"]}}};if(typeof BX.CrmMultipleAddressEditor.messages==="undefined"){BX.CrmMultipleAddressEditor.messages={}}BX.CrmMultipleAddressEditor.items={};BX.CrmMultipleAddressEditor.getItemsByFormId=function(t){var e;t=BX.type.isNotEmptyString(t)?t:"";if(t===""){return[]}var i=[];for(var n in this.items){if(this.items.hasOwnProperty(n)){e=this.items[n];if(e.getFormId()===t){i.push(e)}}}return i};BX.CrmMultipleAddressEditor.create=function(t,e){var i=new BX.CrmMultipleAddressEditor;i.initialize(t,e);BX.CrmMultipleAddressEditor.items[i.getId()]=i;return i}}if(typeof BX.CrmMultipleAddressItemEditor==="undefined"){BX.CrmMultipleAddressItemEditor=function(){this._id="";this._settings={};this._typeId=0;this._fields={};this._editor=null;this._container=null;this._isPersistent=false;this._isMarkedAsDeleted=false;this._hasLayout=false;this._originatorId="";this._deleteButton=null;this._deleteButtonHandler=BX.delegate(this.onDeleteButtonClick,this)};BX.CrmMultipleAddressItemEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_multiaddr_item_"+Math.random();this._settings=e?e:{};this._typeId=parseInt(this.getSetting("typeId",0));this._fields=this.getSetting("fields",{});this._editor=this.getSetting("editor");if(!(this._editor instanceof BX.CrmMultipleAddressEditor)){throw"BX.CrmMultipleAddressItemEditor: Could not find a parameter named 'editor'."}this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"BX.CrmMultipleAddressItemEditor: Could not find a parameter named 'container'."}this._isPersistent=!!this.getSetting("isPersistent",false);this._hasLayout=!!this.getSetting("hasLayout",false);if(this._hasLayout){this._deleteButton=BX.findChildByClassName(this._container,"crm-offer-title-del");if(!BX.type.isElementNode(this._deleteButton)){throw"BX.CrmMultipleAddressItemEditor: Could not find the 'Delete' button."}this.bind()}this._originatorId=this.getSetting("originatorId","")},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},getMessage:function(t){var e=BX.CrmMultipleAddressItemEditor.messages;return e.hasOwnProperty(t)?e[t]:t},getTypeId:function(){return this._typeId},getContainer:function(){return this._container},getOriginatorId:function(){return this._originatorId},getFieldControl:function(t){var e=this._editor.prepareQualifiedName(t,{typeId:this._typeId});var i=document.getElementsByName(e);return i.length>0?i[0]:null},getFieldValue:function(t){var e=this.getFieldControl(t);return e!==null?e.value:""},setFieldValue:function(t,e){var i=this.getFieldControl(t);if(i!==null){i.value=e}},setup:function(t){if(!BX.type.isPlainObject(t)){return}for(var e in t){if(t.hasOwnProperty(e)){this.setFieldValue(e,t[e])}}},bind:function(){if(this._deleteButton){BX.bind(this._deleteButton,"click",this._deleteButtonHandler)}},unbind:function(){if(this._deleteButton){BX.unbind(this._deleteButton,"click",this._deleteButtonHandler)}},layout:function(){if(this._hasLayout){return}var t,e,i;t=BX.create("TABLE",{attrs:{className:"crm-offer-info-table"}});this._container.appendChild(t);e=t.insertRow(-1);i=e.insertCell(-1);i.colSpan="4";this._deleteButton=BX.create("SPAN",{attrs:{className:"crm-offer-title-del"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-offer-title"},children:[BX.create("SPAN",{attrs:{className:"crm-offer-title-text"},text:this._editor.getTypeName(this._typeId)}),BX.create("SPAN",{attrs:{className:"crm-offer-title-set-wrap"},children:[this._deleteButton]})]}));var n=this._editor.getScheme();for(var s=0;s<n.length;s++){var a=n[s];var r=BX.type.isNotEmptyString(a["type"])?a["type"]:"";var o=BX.type.isNotEmptyString(a["name"])?a["name"]:"";var l=this._editor.prepareQualifiedName(o,{typeId:this._typeId});var h=this._fields.hasOwnProperty(o)?this._fields[o]:"";if(r==="locality"){e=t.insertRow(-1);e.style.display="none";i=e.insertCell(-1);i.colSpan="4";i.appendChild(BX.create("INPUT",{props:{type:"hidden",name:l,value:h}}));var d=BX.type.isPlainObject(a["params"])?a["params"]:{};var c=BX.type.isNotEmptyString(a["related"])?a["related"]:"";BX.CrmLocalitySearchField.create(l,{localityType:BX.type.isNotEmptyString(d["locality"])?d["locality"]:"",serviceUrl:this._editor.getServiceUrl(),searchInput:this._editor.prepareQualifiedName(c,{typeId:this._typeId}),dataInput:l})}else{e=t.insertRow(-1);i=e.insertCell(-1);i.className="crm-offer-info-left";i.appendChild(BX.create("SPAN",{attrs:{className:"crm-offer-info-label-alignment"}}));i.appendChild(BX.create("SPAN",{attrs:{className:"crm-offer-info-label"},text:this._editor.getFieldLabel(o)}));i=e.insertCell(-1);i.className="crm-offer-info-right";if(r==="multilinetext"){i.appendChild(BX.create("DIV",{attrs:{className:"crm-offer-info-data-wrap"},children:[BX.create("TEXTAREA",{props:{className:"crm-offer-textarea",name:l,value:h}})]}))}else{i.appendChild(BX.create("DIV",{attrs:{className:"crm-offer-info-data-wrap"},children:[BX.create("INPUT",{props:{className:"crm-offer-item-inp",type:"text",name:l,value:h}})]}))}i=e.insertCell(-1);i.className="crm-offer-info-right-btn";i=e.insertCell(-1);i.className="crm-offer-last-td"}}this.bind();this._hasLayout=true},cleanLayout:function(){if(!this._hasLayout){return}this.unbind();BX.cleanNode(this._container);this._hasLayout=false},isPersistent:function(){return this._isPersistent},markAsDeleted:function(){if(this._isMarkedAsDeleted){return}this._isMarkedAsDeleted=true;this._container.appendChild(BX.create("INPUT",{props:{name:this._editor.prepareQualifiedName("DELETED",{typeId:this._typeId}),type:"hidden",value:"Y"}}));this._container.style.display="none";BX.onCustomEvent(this._editor,"CrmMultipleAddressItemMarkAsDeleted",[this._editor,this])},isMarkedAsDeleted:function(){return this._isMarkedAsDeleted},setupByEntity:function(t,e){this._editor.loadEntityAddress(this.getTypeId(),t,e,BX.delegate(this.onEntityAddressLoad,this))},onEntityAddressLoad:function(t){if(!BX.type.isPlainObject(t)){return}var e=true;var i=this._editor.getScheme();for(var n=0,s=i.length;n<s;n++){var a=i[n];var r=BX.type.isNotEmptyString(a["name"])?a["name"]:"";if(BX.type.isNotEmptyString(t[r])){e=false;break}}if(!e&&window.confirm(this.getMessage("copyConfirmation"))){this.setup(t)}},onDeleteButtonClick:function(t){if(window.confirm(this.getMessage("deletionConfirmation"))){this.markAsDeleted();this._editor.removeItem(this)}}};if(typeof BX.CrmMultipleAddressItemEditor.messages==="undefined"){BX.CrmMultipleAddressItemEditor.messages={}}BX.CrmMultipleAddressItemEditor.create=function(t,e){var i=new BX.CrmMultipleAddressItemEditor;i.initialize(t,e);return i}}BX.namespace("BX.Crm");BX.Crm.EntityEditorBlockAreaClass=function(){var t=function(t){this.editor=t.editor;this.container=t.container;this.nextNode=t.nextNode;this.entityInfoList=t.entityInfoList;this.readOnlyMode=t.readOnlyMode;this.closeBlockHandler=t.closeBlockHandler;this.changeSelectedRequisiteHandler=t.changeSelectedRequisiteHandler;this.changeLinkedRequisiteHandler=t.changeLinkedRequisiteHandler;this.rqLinkedId=t.rqLinkedId;this.bdLinkedId=t.bdLinkedId;this.wrapper=BX.type.isElementNode(t.wrapper)?t.wrapper:null;this.visualization=null;this.blockList=[];this.blockPseudoIdIndex={};this.cleanState={started:false,cleanAll:false,afterClean:null};this.initialize()};t.prototype={initialize:function(){if(this.container&&this.wrapper){this.clean(false,BX.delegate(this.continueInitialize,this))}else{this.continueInitialize()}},continueInitialize:function(){if(this.container){if(!this.wrapper){this.wrapper=BX.create("DIV",{attrs:{class:"crm-offer-tabs-wrapper"}})}else{BX.addClass(this.wrapper,"crm-offer-tabs-wrapper")}if(!this.wrapper.parentNode){if(this.nextNode)this.container.insertBefore(this.wrapper,this.nextNode);else this.container.appendChild(this.wrapper)}this.visualization=new BX.Crm.EntityEditorBlockAreaVisualizationClass({blockArea:this,tabActiveClass:"crm-offer-tab-active"})}var t=this.entityInfoList.length;if(this.entityInfoList instanceof Array&&t>0){for(var e=0;e<t;e++){if(this.entityInfoList[e]instanceof BX.CrmEntityInfo)this.addBlock(this.entityInfoList[e])}}},getWrapperNode:function(){return this.wrapper},getBlockByPseudoId:function(t){var e=null;if(this.blockPseudoIdIndex.hasOwnProperty(t)){e=this.blockPseudoIdIndex[t]}return e},addBlock:function(t){var e=this.blockList.length;var i=new BX.Crm.EntityEditorBlockClass({editor:this.editor,blockArea:this,blockIndex:e,container:this.wrapper,nextNode:null,entityInfo:t,readOnlyMode:this.readOnlyMode,closeBlockHandler:this.closeBlockHandler,changeSelectedRequisiteHandler:this.changeSelectedRequisiteHandler,changeLinkedRequisiteHandler:BX.delegate(this.changeLinkedRequisite,this),rqLinkedId:this.rqLinkedId,bdLinkedId:this.bdLinkedId});if(i){this.blockList[e]=i;this.blockPseudoIdIndex[i.getPseudoId()]=e;if(this.visualization)this.visualization.addTabBlock(i)}},clean:function(t,e){if(!this.cleanState.started){this.cleanState.started=true;this.cleanState.cleanAll=!!t;this.cleanState.afterClean=typeof e==="function"?e:null;if(this.blockList.length>0)this.blockList[0].destroy();else this.continueClean()}},continueClean:function(){if(this.cleanState.started){if(this.blockList.length>0){this.blockList[0].destroy()}else{if(this.wrapper){if(this.visualization)this.visualization=null;BX.cleanNode(this.wrapper,this.cleanState.cleanAll)}var t=this.cleanState.afterClean;this.cleanState={cleanAll:false,started:false,afterClean:null};if(typeof t==="function")t()}}},onBlockDestroy:function(t){if(t>=0&&this.blockList&&this.blockList.length>t){if(this.visualization)this.visualization.removeTabsBlock(this.blockList[t],BX.delegate(this.continueBlockDestroy,this));else this.continueBlockDestroy(t)}},changeLinkedRequisite:function(t,e){this.rqLinkedId=parseInt(t);if(this.rqLinkedId<0||isNaN(this.rqLinkedId))this.rqLinkedId=0;this.bdLinkedId=parseInt(e);if(this.bdLinkedId<0||isNaN(this.bdLinkedId))this.bdLinkedId=0;if(typeof this.changeLinkedRequisiteHandler==="function")this.changeLinkedRequisiteHandler(this.rqLinkedId,this.bdLinkedId)},continueBlockDestroy:function(t){if(t>=0&&this.blockList&&this.blockList.length>t){var e=this.blockList[t];this.blockList.splice(t,1);delete this.blockPseudoIdIndex[e.getPseudoId()];this.reindexBlocks(t);e.continueDestroy();if(this.cleanState.started)this.continueClean()}},reindexBlocks:function(t){for(var e=t;e<this.blockList.length;e++){this.blockList[e].setIndex(e);this.blockPseudoIdIndex[blockList[e].getPseudoId()]=e}},destroy:function(t){this.clean(true,t)}};return t}();BX.Crm.EntityEditorBlockAreaVisualizationClass=function(){var t=function(t){this.block=null;this.wrapper=null;this.activeClass="";this.tabsObjList=[];this.init(t)};t.prototype={init:function(t){this.blockArea=t.blockArea;if(this.blockArea)this.wrapper=this.blockArea.getWrapperNode();this.activeClass=t.tabActiveClass},createTabObj:function(t){var e,i,n,s=this;var a={mainblock:t,innerBlock:t.querySelector("[data-tab-block=tabBlockInner]"),contWrap:t.querySelector("[data-tab-block=tabBlockWrap]"),btnList:[],contList:[],requisiteItems:[]};e=t.querySelectorAll("[data-tab-block=tab-btn]");i=t.querySelectorAll("[data-tab-block=tab-cont]");for(var r=0;r<i.length;r++){a.contList[r]=i[r];n=i[r].querySelectorAll("[data-tab-block=requisiteItem]");if(n.length>0)this.bindSwitchRequisiteItems(n)}for(var o=0;o<e.length;o++){a.btnList[o]=e[o];(function(t,i){BX.bind(e[o],"click",(function(){s.switchTab(t,i)}))})(a,o)}this.tabsObjList.push(a)},switchTab:function(t,e){t.contWrap.style.height=t.contWrap.clientHeight+"px";for(var i=0;i<t.btnList.length;i++){BX.removeClass(t.btnList[i],this.activeClass);t.contList[i].style.display="none"}t.contList[e].style.display="block";BX.addClass(t.btnList[e],this.activeClass);t.contWrap.style.height=t.contList[e].offsetHeight+"px"},bindSwitchRequisiteItems:function(t){var e,i,n,s,a,r=this;for(s=0;s<t.length;s++){i=0;e=[];e[i++]=t[s].querySelector("[class=crm-offer-requisite-inp]");n=t[s].querySelectorAll("[class=crm-offer-bankdetail-inp]");if(n){for(a=0;a<n.length;a++)e[i++]=n[a]}n=null;(function(t,i){for(var n=0;n<e.length;n++){BX.bind(e[n],"click",(function(){r.switchRequisiteItems(t,i)}))}})(t[s],t)}},switchRequisiteItems:function(t,e){var i;for(var n=0;n<e.length;n++){BX.removeClass(e[n],"crm-offer-requisite-active")}BX.addClass(t,"crm-offer-requisite-active");if(i=t.querySelector("[class=crm-offer-requisite-inp]")){i.checked=true}},removeTabsBlock:function(t,e){var i=t.getWrapperNode();if(i){i.style.height=i.offsetHeight+"px";var n=i.getBoundingClientRect().top,s=n,a;for(var r=0;r<this.tabsObjList.length;r++){if(this.tabsObjList[r].mainblock==i){if(r<this.tabsObjList.length-1)s=this.tabsObjList[r+1].mainblock.getBoundingClientRect().top;a=this.tabsObjList.indexOf(this.tabsObjList[r]);this.tabsObjList.splice(a,1)}}setTimeout((function(){if(n==s)i.style.width=0;i.style.height=0;i.style.opacity=0}),100);setTimeout((function(){i.style.display="none";e(t.getIndex())}),700)}},addTabBlock:function(t){var e=t.getWrapperNode();this.createTabObj(e);this.showTabObj()},completeTabObjAnimation:function(){var t=this.tabsObjList[this.tabsObjList.length-1].mainblock;BX.removeClass(t,"crm-offer-tab-block-hidden");t.style.height="auto"},showTabObj:function(){var t=this.tabsObjList.length-1;var e=this.tabsObjList[t].mainblock;var i=this.tabsObjList[t].innerBlock;if(BX.pos(i)["height"]>0){var n=parseInt(BX.style(i,"marginBottom"));e.style.height=i.offsetHeight+n+"px";BX.bind(e,"transitionend",BX.delegate(this.completeTabObjAnimation,this))}else{this.completeTabObjAnimation()}}};return t}();BX.Crm.EntityEditorBlockClass=function(){var t=function(t){this.editor=t.editor;this.blockArea=t.blockArea;this.blockIndex=t.blockIndex;this.container=t.container;this.nextNode=t.nextNode;this.entityInfo=t.entityInfo;this.readOnlyMode=t.readOnlyMode;this.closeBlockHandler=t.closeBlockHandler;this.changeSelectedRequisiteHandler=t.changeSelectedRequisiteHandler;this.changeLinkedRequisiteHandler=t.changeLinkedRequisiteHandler;this.rqLinkedId=parseInt(t.rqLinkedId);if(this.rqLinkedId<0||isNaN(this.rqLinkedId))this.rqLinkedId=0;this.bdLinkedId=parseInt(t.bdLinkedId);if(this.bdLinkedId<0||isNaN(this.bdLinkedId))this.bdLinkedId=0;this.ajaxUrl="/bitrix/components/bitrix/crm.requisite.edit/settings.php";this.closeButtonClickHandler=null;this.wrapper=null;this.wrapperInner=null;this.titleNode=null;this.closeButtonNode=null;this.requisiteIndex=[];this.random=Math.random().toString().substring(2);this.initialize()};t.prototype={initialize:function(){if(this.container){this.clean();if(!this.wrapper){var t="";if(this.entityInfo instanceof BX.CrmEntityInfo){var e=this.entityInfo.getSetting("type","");if(typeof e==="string"&&e.length>0)t=" crm-offer-tab-"+e}this.wrapper=BX.create("DIV",{attrs:{class:"crm-offer-tab-block-wrap"+t+" crm-offer-tab-block-hidden","data-tab-block":"tabBlock"}});if(this.wrapper){if(this.nextNode)this.container.insertBefore(this.wrapper,this.nextNode);else this.container.appendChild(this.wrapper)}}}if(this.wrapper){this.wrapperInner=BX.create("DIV",{attrs:{class:"crm-offer-tab-block","data-tab-block":"tabBlockInner"}});if(this.wrapperInner){this.wrapper.appendChild(this.wrapperInner);var i,n,s,a=null;if(this.entityInfo instanceof BX.CrmEntityInfo){i=this.entityInfo.getSetting("title","");if(i.length>0){n=this.entityInfo.getSetting("url","");if(BX.type.isNotEmptyString(n)){a=BX.create("A",{attrs:{class:"crm-offer-tab-title-name",href:n,target:"_blank"},html:BX.util.htmlspecialchars(i)})}else{a=BX.create("SPAN",{attrs:{class:"crm-offer-tab-title-name"},html:BX.util.htmlspecialchars(i)})}s=this.entityInfo.getSetting("desc","")}if(a){this.titleNode=BX.create("DIV",{attrs:{class:"crm-offer-tab-title"},children:[BX.create("DIV",{attrs:{class:"crm-offer-tab-title-icon"}}),BX.create("DIV",{attrs:{class:"crm-offer-tab-title-name-block"},children:[a,BX.create("DIV",{attrs:{class:"crm-offer-tab-title-descript"},html:BX.util.htmlspecialchars(s)})]})]})}}if(this.titleNode){if(!this.readOnlyMode){this.closeButtonNode=BX.create("DIV",{attrs:{class:"crm-offer-tab-close-btn","data-tab-block":"closeBtn"}});if(this.closeButtonNode){this.titleNode.appendChild(this.closeButtonNode);this.closeButtonClickHandler=BX.delegate(this.onCloseButtonClick,this);BX.bind(this.closeButtonNode,"click",this.closeButtonClickHandler)}}this.wrapperInner.appendChild(this.titleNode)}if(this.titleNode){var r,o,l,h,d,c="",u=[],f=[],p=[];l=this.entityInfo.getSetting("advancedInfo",null);h=this.entityInfo.getSetting("id","");d=this.entityInfo.getSetting("type","");if(BX.type.isPlainObject(l)){if(d==="contact"){if(BX.type.isPlainObject(l["contactType"])&&typeof l["contactType"]["name"]==="string"){c=l["contactType"]["name"]}}if(l["multiFields"]&&l["multiFields"]instanceof Array){var m=l["multiFields"];for(r=0;r<m.length;r++){if(m[r]["TYPE_ID"]&&m[r]["TYPE_ID"]==="PHONE"){u.push({VALUE:BX.util.trim(m[r]["VALUE"])})}if(m[r]["TYPE_ID"]&&m[r]["TYPE_ID"]==="EMAIL"){f.push({VALUE:BX.util.trim(m[r]["VALUE"])})}}}if(l["requisiteData"]instanceof Array){var _,g,y,B,I,C,X,b,v,S,E,D,N,w,k=0,T=-1,L=-1;_=l["requisiteData"];y=this.rqLinkedId;for(r=0;r<_.length;r++){if(typeof _[r]["requisiteId"]!=="undefined"){g=parseInt(_[r]["requisiteId"])}else{g=0}if(typeof _[r]["entityTypeId"]!=="undefined"){B=parseInt(_[r]["entityTypeId"])}else{B=0}if(typeof _[r]["entityId"]!=="undefined"){h=parseInt(_[r]["entityId"])}else{h=0}if(typeof _[r]["requisiteData"]==="string"){I=BX.parseJSON(_[r]["requisiteData"],this);if(!BX.type.isPlainObject(I))I={}}else{I={}}if(BX.type.isPlainObject(I["viewData"]))C=I["viewData"];else C={};if(typeof C["title"]==="string"&&C["title"].length>0){if(BX.type.isArray(I["bankDetailViewDataList"]))X=I["bankDetailViewDataList"];else X=[];if(typeof _[r]["bankDetailIdSelected"]!=="undefined"){E=parseInt(_[r]["bankDetailIdSelected"]);if(E<0||isNaN(E))E=0}else{_[r]["bankDetailIdSelected"]=E=0}if(X.length>0){v=-1;D=-1;N=-1;for(o=0;o<X.length;o++){w=parseInt(X[o]["pseudoId"]);if(w<0||isNaN(w))w=0;if(g===this.rqLinkedId&&this.bdLinkedId>0&&w===this.bdLinkedId){v=o}if(E>0&&w===E)N=o;if(X[o]["selected"])D=o}if(v>=0){if(N!==D){if(D>=0)X[D]["selected"]=false;X[v]["selected"]=true;_[r]["bankDetailIdSelected"]=parseInt(X[v]["pseudoId"])}}else if(N>=0){if(N!==D){if(D>=0)X[D]["selected"]=false;X[N]["selected"]=true;_[r]["bankDetailIdSelected"]=parseInt(X[N]["pseudoId"])}}else{if(D<0)D=0;_[r]["bankDetailIdSelected"]=parseInt(X[D]["pseudoId"])}}p.push({requisiteId:g,entityTypeId:B,entityId:h,viewData:C,bankDetailViewDataList:X,bankDetailIdSelected:_[r]["bankDetailIdSelected"],selected:_[r]["selected"]});this.requisiteIndex[g]={entityTypeId:B,entityId:h,bankDetailIdSelected:_[r]["bankDetailIdSelected"]};if(_[r]["selected"])T=k;if(this.rqLinkedId>0&&this.rqLinkedId==g)L=k;k++}}if(L>=0){if(T>=0&&T!==L){p[T]["selected"]=false;p[L]["selected"]=true;T=L}}y=0;S=0;if(T>=0){y=parseInt(p[T]["requisiteId"]);if(y<0||isNaN(y))y=0;S=parseInt(p[T]["bankDetailIdSelected"]);if(S<0||isNaN(S))S=0}if(this.rqLinkedId!==y||this.bdLinkedId!==S){if(typeof this.changeLinkedRequisiteHandler==="function"){this.rqLinkedId=y;this.bdLinkedId=S;this.changeLinkedRequisiteHandler(this.rqLinkedId,this.bdLinkedId)}}}}var P=false,q=false,x=false;if(d==="contact"&&c.length>0||u.length>0||f.length>0){P=true}if(p.length>0){q=true}x=P||q;if(x){var O=1,M=2,R=P?O:M;var A=this.getMessage(d+"TabTitleAbout"),H;if(d==="company"){H=this.getMessage("tabTitleCompanyRequisites")}else{H=this.getMessage("tabTitleContactRequisites")}if(!BX.type.isNotEmptyString(A))A=this.getMessage(d+"tabTitleAbout");var F={class:"crm-offer-tab"+(O===R?" crm-offer-tab-active":""),"data-tab-block":"tab-btn"};var V={class:"crm-offer-tab"+(M===R?" crm-offer-tab-active":""),"data-tab-block":"tab-btn"};if(!P)F["style"]="display: none;";if(!q)V["style"]="display: none;";var U=null;this.wrapperInner.appendChild(U=BX.create("DIV",{attrs:{class:"crm-offer-tab-main-cont-wrap"},children:[BX.create("DIV",{attrs:{class:"crm-offer-tab-list-wrap"},children:[BX.create("SPAN",{attrs:F,html:'<span class="crm-offer-tab-text">'+BX.util.htmlspecialchars(A)+"</span>"}),BX.create("SPAN",{attrs:V,html:'<span class="crm-offer-tab-text">'+BX.util.htmlspecialchars(H)+"</span>"})]})]}));if(U){var j={class:"crm-offer-tab-cont","data-tab-block":"tab-cont"},z={class:"crm-offer-tab-cont","data-tab-block":"tab-cont"};if(O!==R)j["style"]="display: none;";if(M!==R)z["style"]="display: none;";var W=null,Y=null;U.appendChild(BX.create("DIV",{attrs:{class:"crm-offer-tab-cont-wrap","data-tab-block":"tabBlockWrap"},children:[BX.create("DIV",{attrs:j,children:[W=BX.create("DIV",{attrs:{class:"crm-offer-tab-info"},children:[BX.create("DIV",{attrs:{class:"crm-offer-tab-info-img"}})]})]}),BX.create("DIV",{attrs:z,children:[Y=BX.create("FORM")]})]}));var G,Q,K,J;if(W&&P){G=BX.create("TABLE",{attrs:{class:"crm-offer-tab-table"}});if(G){if(d==="contact"&&c.length>0){var $=this.getMessage("prefContactType");Q=G.insertRow(-1);K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=BX.util.htmlspecialchars($+":");K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=BX.util.htmlspecialchars(c)}if(u.length>0){var Z,tt;Z=this.getMessage("prefPhoneLong");var et="",it="",nt="";for(r=0;r<u.length;r++){if(BX.type.isNotEmptyString(u[r]["VALUE"])){it=u[r]["VALUE"];et+='<div class="crm-client-contacts-block">';et+='<span style="max-width: 330px;" class="crm-client-contacts-block-text crm-client-contacts-block-handset">';et+='<a class="crm-client-contacts-block-text-tel" href="callto://'+BX.util.urlencode(it)+'">'+BX.util.htmlspecialchars(it)+"</a>";et+="</span>";et+="</div>"}}Q=G.insertRow(-1);K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=BX.util.htmlspecialchars(Z+":");K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=et}if(f.length>0){var st,at="",rt="";st=this.getMessage("prefEmail");for(r=0;r<f.length;r++){if(BX.type.isNotEmptyString(f[r]["VALUE"])){rt=f[r]["VALUE"];at+='<div class="crm-client-contacts-block">';at+='<a class="crm-client-contacts-block-text-tel" href="mailto://'+BX.util.urlencode(rt)+'">'+BX.util.htmlspecialchars(rt)+"</a>";at+="</div>"}}Q=G.insertRow(-1);K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=BX.util.htmlspecialchars(st+":");K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=at}}W.appendChild(G)}if(Y&&q){var ot,lt,ht;if(this.editor)lt=this.editor.getSetting("containerId",null);if(!BX.type.isNotEmptyString(lt))lt=this.random;lt+="_REQUISITE";for(r=0;r<p.length;r++){if(BX.type.isPlainObject(p[r]["viewData"])&&typeof p[r]["requisiteId"]!=="undefined"&&typeof p[r]["selected"]!=="undefined"&&BX.type.isNotEmptyString(p[r]["viewData"]["title"])&&p[r]["viewData"]["fields"]instanceof Array){ht=lt+"_"+r;ot=BX.create("DIV",{attrs:{class:"crm-offer-requisite"+(p[r]["selected"]===true?" crm-offer-requisite-active":""),"data-tab-block":"requisiteItem"},children:[BX.create("DIV",{attrs:{class:"crm-offer-requisite-title"},children:[BX.create("INPUT",{attrs:{id:ht,class:"crm-offer-requisite-inp",type:"radio",name:lt,value:p[r]["requisiteId"]},props:{checked:p[r]["selected"]===true},events:{click:BX.delegate(this.onRequisiteRadioClick,this)}}),BX.create("LABEL",{attrs:{class:"crm-offer-requisite-lable",for:ht},html:BX.util.htmlspecialchars(p[r]["viewData"]["title"])})]})]});if(ot){var dt=p[r]["viewData"]["fields"];if(dt.length>0||p[r]["bankDetailViewDataList"].length>0){G=BX.create("TABLE",{attrs:{class:"crm-offer-tab-table"}});if(G){for(o=0;o<dt.length;o++){Q=G.insertRow(-1);K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=(dt[o]["title"]?BX.util.htmlspecialchars(dt[o]["title"]):"")+":";K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=dt[o]["textValue"]?BX.util.nl2br(BX.util.htmlspecialchars(dt[o]["textValue"])):""}J=this.makeBankDetailsNode(p[r]);if(J){Q=G.insertRow(-1);K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.innerHTML=BX.util.htmlspecialchars(this.getMessage("bankDetailsTitle")+":");K=Q.insertCell(-1);K.className="crm-offer-tab-cell";K.appendChild(J)}ot.appendChild(G)}}Y.appendChild(ot)}}}}}}}}}},makeBankDetailsNode:function(t){var e,i,n,s,a,r,o,l;if(!BX.type.isPlainObject(t)){return null}a=parseInt(t["requisiteId"]);if(!(a>0&&BX.type.isArray(t["bankDetailViewDataList"])&&t["bankDetailViewDataList"].length>0)){return null}n=t["bankDetailViewDataList"];s=BX.create("DIV");if(!s){return null}i=0;for(e=0;e<n.length;e++){if(!(typeof n[e]["pseudoId"]!=="undefined"&&BX.type.isPlainObject(n[e]["viewData"])&&BX.type.isNotEmptyString(n[e]["viewData"]["title"])&&BX.type.isArray(n[e]["viewData"]["fields"]))){continue}r=n[e]["pseudoId"];if(this.editor)o=this.editor.getSetting("containerId",null);if(!BX.type.isNotEmptyString(o))o=this.random;o+="_RQ_"+a+"_BD";l=o+"_"+r;s.appendChild(BX.create("DIV",{children:[BX.create("INPUT",{attrs:{id:l,class:"crm-offer-bankdetail-inp",type:"radio",name:o,value:""+a+"|"+r},props:{checked:n[e]["selected"]===true},events:{click:BX.delegate(this.onBankDetailRadioClick,this)}}),BX.create("LABEL",{attrs:{for:l},html:BX.util.htmlspecialchars(n[e]["viewData"]["title"])})]}));i++}if(i<=0){BX.cleanNode(s,true);s=null}return s},getMessage:function(t){if(this.editor)return this.editor.getMessage(t);return""},getWrapperNode:function(){return this.wrapper},onCloseButtonClick:function(){if(this.readOnlyMode)return;if(typeof this.closeBlockHandler==="function")this.closeBlockHandler();this.destroy()},onRequisiteRadioClick:function(t){var e,i,n,s;if(!t)t=window.event;if(t&&BX.type.isDomNode(t.target)){e=parseInt(t.target.value);if(e>0){if(this.requisiteIndex[e]){i=parseInt(this.requisiteIndex[e].entityTypeId);n=parseInt(this.requisiteIndex[e].entityId);s=parseInt(this.requisiteIndex[e].bankDetailIdSelected);if(s<0||isNaN(s))s=0;if(i>0&&n>0){if(typeof this.changeSelectedRequisiteHandler==="function")this.changeSelectedRequisiteHandler(i,n,e,s);if(typeof this.changeLinkedRequisiteHandler==="function")this.changeLinkedRequisiteHandler(e,s);var a=BX.util.add_url_param(this.ajaxUrl,{sessid:BX.bitrix_sessid()});var r={action:"savelastselectedrequisite",requisiteEntityTypeId:i,requisiteEntityId:n,requisiteId:e,bankDetailId:s};BX.ajax.post(a,r)}}}}},onBankDetailRadioClick:function(t){var e,i,n,s,a;if(!t)t=window.event;if(t&&BX.type.isDomNode(t.target)&&BX.type.isNotEmptyString(t.target.value)){a=t.target.value.match(/^(\d+)\|(\d+)$/);if(a){e=parseInt(a[1]);s=parseInt(a[2]);if(e>0){if(this.requisiteIndex[e]){i=parseInt(this.requisiteIndex[e].entityTypeId);n=parseInt(this.requisiteIndex[e].entityId);if(i>0&&n>0){if(typeof this.changeSelectedRequisiteHandler==="function")this.changeSelectedRequisiteHandler(i,n,e,s);if(typeof this.changeLinkedRequisiteHandler==="function")this.changeLinkedRequisiteHandler(e,s);var r=BX.util.add_url_param(this.ajaxUrl,{sessid:BX.bitrix_sessid()});var o={action:"savelastselectedrequisite",requisiteEntityTypeId:i,requisiteEntityId:n,requisiteId:e,bankDetailId:s};BX.ajax.post(r,o)}}}}}},getIndex:function(){return this.blockIndex},setIndex:function(t){this.blockIndex=t},clean:function(t){t=!!t;if(this.wrapper){if(this.closeButtonNode){if(this.closeButtonClickHandler){BX.unbind(this.closeButtonNode,"click",this.closeButtonClickHandler);this.closeButtonClickHandler=null;this.closeButtonNode=null;this.requisiteIndex=[]}}BX.cleanNode(this.wrapper,t)}},destroy:function(){if(this.blockArea)this.blockArea.onBlockDestroy(this.blockIndex);else this.continueDestroy()},continueDestroy:function(){this.clean(true)}};return t}();if(typeof BX.Crm.RequisiteBankDetailsArea==="undefined"){BX.Crm.RequisiteBankDetailsArea=function(){this._id=null;this.formId="";this.container=null;this.nextNode=null;this.messages={};this.presetCountryId=0;this.fieldList=[];this.dataList=[];this.fieldNameTemplate="";this.wrapper=null;this.blocksContainer=null;this.blockList=[];this.elementIndex=0;this.cleanState={started:false,cleanAll:false,afterClean:null};this.addBlockBtn=null;this.addBlockBtnClickHandler=null;this.mode="EDIT";this._requisitePopupCloseHandler=BX.delegate(this.onRequisitePopupClose,this)};BX.Crm.RequisiteBankDetailsArea.prototype={initialize:function(t,e){var i;this._id=BX.type.isNotEmptyString(t)?t:"crm_rq_bank_details_area_"+Math.random().toString().substring(2);this.formId=e.formId||"";this.container=e.container;this.nextNode=e.nextNode;this.messages=e.messages||{};if(e.hasOwnProperty("presetCountryId")){this.presetCountryId=parseInt(e.presetCountryId);if(this.presetCountryId<0||isNaN(this.presetCountryId))this.presetCountryId=0}this.fieldList=BX.type.isArray(e.fieldList)?e.fieldList:[];this.dataList=BX.type.isArray(e.dataList)?e.dataList:[];this.fieldNameTemplate=BX.type.isNotEmptyString(e.fieldNameTemplate)?e.fieldNameTemplate:"BANK_DETAILS[#ELEMENT_ID#][#FIELD_NAME#]";this.lastInForm=!!e.lastInForm;this.mode=e.mode||"EDIT";if(this.container){this.clean();if(!this.wrapper){this.wrapper=BX.create("DIV",{attrs:{class:"crm-offer-requisite-block-wrap"}});if(this.wrapper){if(this.nextNode)this.container.insertBefore(this.wrapper,this.nextNode);else this.container.appendChild(this.wrapper)}if(this.wrapper){if(this.nextNode)this.container.insertBefore(this.wrapper,this.nextNode);else this.container.appendChild(this.wrapper)}}}this.elementIndex=0;if(this.wrapper){this.wrapper.appendChild(BX.create("SPAN",{attrs:{class:"crm-offer-requisite-option"},children:[this.addBlockBtn=BX.create("SPAN",{attrs:{class:"crm-offer-requisite-option-text"},text:this.getMessage("addBlockBtnText")})]}));this.wrapper.appendChild(BX.create("DIV",{attrs:{class:"crm-offer-requisite-form-wrap"},children:[this.blocksContainer=BX.create("DIV",{attrs:{class:"crm-multi-address"}})]}));if(this.addBlockBtn){this.addBlockBtnClickHandler=BX.delegate(this.onAddBlockButtonClick,this);BX.bind(this.addBlockBtn,"click",this.addBlockBtnClickHandler)}if(BX.type.isArray(this.dataList)){for(i=0;i<this.dataList.length;i++){if(BX.type.isPlainObject(this.dataList[i])){t=this.dataList[i].hasOwnProperty("ID")?parseInt(this.dataList[i]["ID"]):0;this.addBlock(t,this.dataList[i])}}}}if(BX.type.isNotEmptyString(this.formId))BX.addCustomEvent("CrmRequisitePopupFormManagerClosePopup",this._requisitePopupCloseHandler)},getId:function(){return this._id},getWrapperNode:function(){return this.wrapper},getMessage:function(t){return this.messages[t]},onAddBlockButtonClick:function(){this.addBlock()},addBlock:function(t,e){var i=0;t=parseInt(t);if(t<0||isNaN(t))t=0;if(!e||!BX.type.isPlainObject(e))e={};var n=this.blockList.length;var s=null;if(n>0)s=this.blockList[n-1].getWrapperNode();var a=new BX.Crm.RequisiteBankDetailsBlock({mode:this.mode,formId:this.formId,bankDetailId:t,bankDetailData:e,blockArea:this,blockIndex:n,elementIndex:this.elementIndex++,container:this.blocksContainer,nextNode:s,presetCountryId:this.presetCountryId,fieldList:this.fieldList,fieldNameTemplate:this.fieldNameTemplate});if(a){i=a.getPseudoId();this.blockList[n]=a}return i},onBlockDestroy:function(t){if(t>=0&&this.blockList&&this.blockList.length>t){this.blockList.splice(t,1);this.reindexBlocks(t)}if(this.cleanState.started)this.continueClean()},reindexBlocks:function(t){for(var e=t;e<this.blockList.length;e++)this.blockList[e].setIndex(e)},isLastInForm:function(){return this.lastInForm},getLastBlockIndex:function(){return this.blockList.length-1},onRequisitePopupClose:function(t){var e="";if(t!==null&&typeof t==="object"){e=t.getFormId();if(BX.type.isNotEmptyString(e)){e=e.replace(/[^a-z0-9_]/gi,"");if(e===this.formId)BX.Crm.RequisiteBankDetailsArea.delete(this.getId())}}},clean:function(t,e){if(!this.cleanState.started){this.cleanState.started=true;this.cleanState.cleanAll=!!t;this.cleanState.afterClean=typeof e==="function"?e:null;if(this.blockList.length>0)this.blockList[0].destroy();else this.continueClean()}},continueClean:function(){if(this.cleanState.started){if(this.blockList.length>0){this.blockList[0].destroy()}else{if(this.addBlockBtn){if(this.addBlockBtnClickHandler){BX.unbind(this.addBlockBtn,"click",this.addBlockBtnClickHandler);this.addBlockBtnClickHandler=null}this.addBlockBtn=null}if(this.wrapper){this.blocksContainer=null;BX.cleanNode(this.wrapper,this.cleanState.cleanAll)}var t=this.cleanState.afterClean;this.cleanState={cleanAll:false,started:false,afterClean:null};this.mode="EDIT";BX.removeCustomEvent("CrmRequisitePopupFormManagerClosePopup",this._requisitePopupCloseHandler);if(typeof t==="function")t()}}},destroy:function(t){this.clean(true,t)}};BX.Crm.RequisiteBankDetailsArea.items={};BX.Crm.RequisiteBankDetailsArea.create=function(t,e){var i=new BX.Crm.RequisiteBankDetailsArea;i.initialize(t,e);this.items[i.getId()]=i;return i};BX.Crm.RequisiteBankDetailsArea.delete=function(t){if(BX.Crm.RequisiteBankDetailsArea.items.hasOwnProperty(t)){var e=BX.Crm.RequisiteBankDetailsArea.items[t];e.destroy();delete BX.Crm.RequisiteBankDetailsArea.items[t]}}}if(typeof BX.Crm.RequisiteBankDetailsBlock==="undefined"){BX.Crm.RequisiteBankDetailsBlock=function(t){this.bankDetailId=parseInt(t.bankDetailId);if(this.bankDetailId<0)this.bankDetailId=0;this.bankDetailData=BX.type.isPlainObject(t.bankDetailData)?t.bankDetailData:{};this.formId=t.formId||"";this.blockArea=t.blockArea;this.blockIndex=t.blockIndex;this.elementIndex=t.elementIndex;this.container=t.container;this.nextNode=t.nextNode;this.fieldList=t.fieldList;this.fieldNameTemplate=t.fieldNameTemplate;this.mode=t.mode||"EDIT";this.wrapper=null;this.documentClickHandler=null;this.editNameMode=false;this.editNameInput=null;this.hiddenNameInput=null;this.nameLabelNode=null;this.editNameBtn=null;this.editNameKeyPressHandler=null;this.editNameBtnClickHandler=null;this.deleteBtn=null;this.deleteBtnClickHandler=null;this.markedAsDeleted=false;this.presetCountryId=0;if(t.hasOwnProperty("presetCountryId")){this.presetCountryId=parseInt(t.presetCountryId);if(this.presetCountryId<0||isNaN(this.presetCountryId))this.presetCountryId=0}this.wrapperId=this.getFormId()+"_BD"+this.getPseudoId();this._crmRequisiteBankDetailBlockGetParamsHandler=BX.delegate(this.onCrmRequisiteBankDetailBlockGetParams,this);this.initialize();BX.onCustomEvent("CrmFormBankDetailBlockCreate",[this.prepareBlockParams()])};BX.Crm.RequisiteBankDetailsBlock.prototype={initialize:function(){var t,e,i,n,s;if(this.container){this.clean();if(!this.wrapper){this.wrapper=BX.create("DIV",{attrs:{id:this.wrapperId,class:"crm-multi-address-item"}});if(this.wrapper){if(this.nextNode)this.container.insertBefore(this.wrapper,this.nextNode);else this.container.appendChild(this.wrapper)}}}if(this.wrapper&&this.fieldList.length>0){var a,r,o;a=BX.create("TABLE",{attrs:{class:"crm-offer-info-table"}});n=BX.create("DIV",{attrs:{style:"display: none;"}});r=a.insertRow(-1);o=r.insertCell(-1);o.colSpan="4";o.appendChild(s=BX.create("DIV",{attrs:{class:"crm-offer-title"},children:[this.editNameInput=BX.create("INPUT",{attrs:{class:"crm-item-table-inp",type:"text",placeholder:this.getMessage("fieldNamePlaceHolder"),style:"display: none;"}}),this.nameLabelNode=BX.create("SPAN",{attrs:{class:"crm-offer-title-text"}})]}));if(s&&this.mode==="EDIT"){this.editNameMode=false;this.documentClickHandler=BX.delegate(this.onDocumentClick,this);this.editNameKeyPressHandler=BX.delegate(this.onEditNameKeyPress,this);s.appendChild(BX.create("SPAN",{attrs:{class:"crm-offer-title-set-wrap"},children:[this.editNameBtn=BX.create("SPAN",{attrs:{class:"crm-offer-title-edit"}}),this.deleteBtn=BX.create("SPAN",{attrs:{class:"crm-offer-title-del"}})]}));if(this.editNameBtn){this.editNameBtnClickHandler=BX.delegate(this.onEditNameButtonClick,this);BX.bind(this.editNameBtn,"click",this.editNameBtnClickHandler)}if(this.deleteBtn){this.deleteBtnClickHandler=BX.delegate(this.onDeleteButtonClick,this);BX.bind(this.deleteBtn,"click",this.deleteBtnClickHandler)}BX.addCustomEvent("CrmRequisiteBankDetailBlockGetParams",this._crmRequisiteBankDetailBlockGetParamsHandler)}for(var l=0;l<this.fieldList.length;l++){i=this.resolveFieldInputName(this.fieldList[l]["name"]);if(BX.type.isPlainObject(this.bankDetailData)&&this.bankDetailData.hasOwnProperty(this.fieldList[l]["name"])){t=this.bankDetailData[this.fieldList[l]["name"]]}else if(this.fieldList[l].hasOwnProperty("defaultValue")){t=this.fieldList[l]["defaultValue"]}else{t=""}if(this.fieldList[l]["name"]==="NAME"){if(!BX.type.isNotEmptyString(t)){t=this.getMessage("bankDetailsTitle")+" "+(this.elementIndex+1)}if(this.nameLabelNode){BX.adjust(this.nameLabelNode,{text:t})}if(n){n.appendChild(this.hiddenNameInput=BX.create("INPUT",{attrs:{type:"hidden",name:i,value:t}}))}}else if(n&&this.fieldList[l]["type"]==="hidden"){e=BX.create("INPUT",{attrs:{type:"hidden",name:i,value:t}});if(e)n.appendChild(e)}else if(a){r=a.insertRow(-1);o=r.insertCell(-1);o.className="crm-offer-info-left";o.appendChild(BX.create("SPAN",{attrs:{class:"crm-offer-info-label-alignment"}}));if(this.fieldList[l]["required"]){o.appendChild(BX.create("SPAN",{attrs:{class:"required"},text:"*"}))}o.appendChild(BX.create("SPAN",{attrs:{class:"crm-offer-info-label"},text:this.fieldList[l]["title"]+":"}));o=r.insertCell(-1);o.className="crm-offer-info-right";e=null;if(this.fieldList[l]["type"]==="text"){e=BX.create("INPUT",{attrs:{type:"text",class:"crm-offer-item-inp",name:i,value:t}})}else if(this.fieldList[l]["type"]==="textarea"){e=BX.create("TEXTAREA",{attrs:{class:"crm-offer-textarea",name:i,cols:40,rows:3},html:BX.util.htmlspecialchars(t)})}if(e)o.appendChild(e);o=r.insertCell(-1);o.className="crm-offer-info-right-btn";o=r.insertCell(-1);o.className="crm-offer-last-td"}}if(a)this.wrapper.appendChild(a);if(n)this.wrapper.appendChild(n)}},getFormId:function(){return this.formId},setIndex:function(t){this.blockIndex=t},getIndex:function(){return this.blockIndex},getPseudoId:function(){return this.bankDetailId>0?this.bankDetailId:"n"+this.elementIndex},getWrapperNode:function(){return this.wrapper},getMessage:function(t){if(this.blockArea)return this.blockArea.getMessage(t);return""},getFieldList:function(){return this.fieldList},clean:function(t){t=!!t;if(this.wrapper){this.hiddenNameInput=null;this.nameLabelNode=null;if(this.editNameInput&&this.editNameKeyPressHandler){BX.unbind(this.editNameInput,"keydown",this.editNameKeyPressHandler);this.editNameKeyPressHandler=null}this.editNameInput=null;this.editNameMode=false;if(this.documentClickHandler)this.enableDocumentClick(false);this.documentClickHandler=null;if(this.editNameBtn){if(this.editNameBtnClickHandler){BX.unbind(this.editNameBtn,"click",this.editNameBtnClickHandler);this.editNameBtnClickHandler=null}this.editNameBtn=null}if(this.deleteBtn){if(this.deleteBtnClickHandler){BX.unbind(this.deleteBtn,"click",this.deleteBtnClickHandler);this.deleteBtnClickHandler=null}this.deleteBtn=null;this.markedAsDeleted=false}BX.removeCustomEvent("CrmRequisiteBankDetailBlockGetParams",this._crmRequisiteBankDetailBlockGetParamsHandler);BX.cleanNode(this.wrapper,t)}},destroy:function(){this.clean(true);if(this.blockArea)this.blockArea.onBlockDestroy(this.blockIndex)},onEditNameButtonClick:function(){if(this.editNameMode)return;this.enableEditNameMode(true)},enableEditNameMode:function(t){t=!!t;if(this.editNameMode===t)return;this.editNameMode=t;if(this.editNameMode){if(this.nameLabelNode)this.nameLabelNode.style.display="none";if(this.editNameInput){this.editNameInput.style.display="";if(this.hiddenNameInput)this.editNameInput.value=this.hiddenNameInput.value;this.editNameInput.focus();this.editNameInput.setSelectionRange(0,this.editNameInput.value.length);this.enableDocumentClick(true);BX.bind(this.editNameInput,"keydown",this.editNameKeyPressHandler)}}else{this.editNameInput.style.display="none";this.nameLabelNode.style.display="";this.enableDocumentClick(false);BX.unbind(this.editNameInput,"keydown",this.editNameKeyPressHandler)}},enableDocumentClick:function(t){if(t){var e=this;window.setTimeout((function(){BX.bind(document,"click",e.documentClickHandler)}),0)}else{BX.unbind(document,"click",this.documentClickHandler)}},onDocumentClick:function(t){if(!t){t=window.event}var e=BX.getEventTarget(t);if(e&&this.editNameInput===e){return}if(!this.editNameMode){BX.unbind(document,"click",this.documentClickHandler)}else{this.completeEditName(true)}},onEditNameKeyPress:function(t){if(!t){t=window.event}if(t.keyCode==13){this.completeEditName(true);return BX.eventReturnFalse(t)}else if(t.keyCode==27){this.completeEditName(false);return BX.eventReturnFalse(t)}return true},completeEditName:function(t){if(!this.editNameMode){return}if(!!t){var e=BX.util.trim(this.editNameInput.value);if(e!==""&&this.hiddenNameInput){this.hiddenNameInput.value=e}if(this.nameLabelNode)BX.adjust(this.nameLabelNode,{text:e})}this.enableEditNameMode(false)},onDeleteButtonClick:function(){this.markAsDeleted()},resolveFieldInputName:function(t){if(this.fieldNameTemplate!==""){return this.fieldNameTemplate.replace("#ELEMENT_ID#",this.getPseudoId()).replace("#FIELD_NAME#",t)}return t},markAsDeleted:function(){if(this.markedAsDeleted){return}this.markedAsDeleted=true;if(this.wrapper){this.wrapper.appendChild(BX.create("INPUT",{props:{name:this.resolveFieldInputName("DELETED"),type:"hidden",value:"Y"}}));this.wrapper.style.display="none"}BX.onCustomEvent("CrmFormBankDetailBlockRemove",[this])},isMarkedAsDeleted:function(){return this.markedAsDeleted},onCrmRequisiteBankDetailBlockGetParams:function(t){if(BX.type.isFunction(t))t(this.prepareBlockParams())},prepareBlockParams:function(){var t="";if(this.fieldNameTemplate!==""){t=this.fieldNameTemplate.replace("#ELEMENT_ID#",this.getPseudoId())}var e=0;if(this.bankDetailData.hasOwnProperty("COUNTRY_ID")){e=parseInt(this.bankDetailData["COUNTRY_ID"]);if(e<0||isNaN(e))e=0}if(e<=0)e=this.presetCountryId;return{bankDetailBlock:this,formId:this.formId,containerId:this.wrapperId,bankDetailPseudoId:this.getPseudoId(),countryId:e,enableFieldMasquerading:this.fieldNameTemplate!=="",fieldNameTemplate:t}}}}
//# sourceMappingURL=interface_form.map.js