this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,s,a,i,l,r){"use strict";async function o(e,t){const s=await BX.ajax.runAction("crm.activity.sms.getTemplates",{data:{senderId:R,context:{module:"crm",entityTypeId:e,entityCategoryId:t,entityId:null}}});return s.data.templates}async function n(){const e=await l.ajax.runAction("crm.api.messagesender.providersConfig",{data:{providerName:R}});return e.data||[]}var c=babelHelpers.classPrivateFieldLooseKey("instance");var d=babelHelpers.classPrivateFieldLooseKey("currentFromNumberId");var b=babelHelpers.classPrivateFieldLooseKey("rawProviders");var p=babelHelpers.classPrivateFieldLooseKey("getEdnaProviderFromRaw");var P=babelHelpers.classPrivateFieldLooseKey("createProvidersMenu");var u=babelHelpers.classPrivateFieldLooseKey("createFromNumberMenus");var v=babelHelpers.classPrivateFieldLooseKey("onFromNumbersChange");class m{constructor(e){Object.defineProperty(this,v,{value:y});Object.defineProperty(this,u,{value:g});Object.defineProperty(this,P,{value:L});Object.defineProperty(this,p,{value:h});Object.defineProperty(this,c,{writable:true,value:null});Object.defineProperty(this,d,{writable:true,value:null});Object.defineProperty(this,b,{writable:true,value:[]});babelHelpers.classPrivateFieldLooseBase(this,d)[d]=e}async create(){babelHelpers.classPrivateFieldLooseBase(this,b)[b]=await n();if(babelHelpers.classPrivateFieldLooseBase(this,d)[d]===null){babelHelpers.classPrivateFieldLooseBase(this,d)[d]=babelHelpers.classPrivateFieldLooseBase(this,p)[p](babelHelpers.classPrivateFieldLooseBase(this,b)[b]).fromList[0].id}const e="crm-whatsapp-channels-settings-menu";babelHelpers.classPrivateFieldLooseBase(this,c)[c]=a.MenuManager.create({id:e,bindElement:document.querySelector(".bx-crm-group-actions-messages-settings-icon"),items:[{delimiter:true,text:l.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_SETTINGS")},{id:"channelSubmenu",text:l.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_SENDER_SELECTOR"),items:babelHelpers.classPrivateFieldLooseBase(this,P)[P](babelHelpers.classPrivateFieldLooseBase(this,b)[b])},{id:"phoneSubmenu",text:l.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_NUMBER_SELECTOR"),items:babelHelpers.classPrivateFieldLooseBase(this,u)[u](babelHelpers.classPrivateFieldLooseBase(this,p)[p](babelHelpers.classPrivateFieldLooseBase(this,b)[b]).fromList,babelHelpers.classPrivateFieldLooseBase(this,d)[d])}]});return babelHelpers.classPrivateFieldLooseBase(this,c)[c]}}function h(e){if(babelHelpers.classPrivateFieldLooseBase(this,b)[b].length!==1&&e[0].id!==R){throw new Error(`Currently only ${R} is supported.`)}return babelHelpers.classPrivateFieldLooseBase(this,b)[b][0]}function L(e){const t=babelHelpers.classPrivateFieldLooseBase(this,p)[p](e);return[{id:t.id,title:t.name,text:t.name,disabled:true,className:"menu-popup-item-accept"}]}function g(e,t){return e.map((e=>{const s=e.id===t?"menu-popup-item-accept":"menu-popup-item-none";return{id:e.id,title:e.name,text:e.name,onclick:babelHelpers.classPrivateFieldLooseBase(this,v)[v].bind(this),className:s}}))}function y(e,t){const s=t.id;BX.Event.EventEmitter.emit("BX.Crm.GroupActionsWhatsApp.FromPhoneSelected",{phone:s});babelHelpers.classPrivateFieldLooseBase(this,c)[c].close()}let F=null;function H(e,t,s,a){const{id:i,value:r,entityType:o,text:n}=a;l.ajax.runAction("crm.activity.smsplaceholder.createOrUpdatePlaceholder",{data:{placeholderId:i,fieldName:l.Type.isStringFilled(r)?r:null,entityType:l.Type.isStringFilled(o)?o:null,fieldValue:l.Type.isStringFilled(n)?n:null,templateId:e,entityTypeId:t,entityCategoryId:s}})}const B={name:"SmsEditorWrapper",props:{templateParam:Object,title:String,entityTypeId:Number,categoryId:Number},data(){return{counter:0,editorInstance:null,messages:{send:l.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_POPUP_SEND")}}},methods:{onSend(){if(!F){console.error("SmsEditorWrapper: editorInstance is null");return}let e="";if(F){const t=F.getData();if(l.Type.isPlainObject(t)){e=t.body}}if(e===""){e=this.templateParam.PREVIEW}const t=this.templateParam.ID;r.EventEmitter.emit("BX.Crm.SmsEditorWrapper:click",{text:e,templateId:t})}},mounted(){const e={target:this.$refs.editorContainerEl,categoryId:this.categoryId,entityId:0,entityTypeId:this.entityTypeId,onSelect:e=>{H(this.templateParam.ORIGINAL_ID,this.entityTypeId,this.categoryId,{id:e.id,value:e.value,entityType:e.entityType,text:e.text})}};const t=this.templateParam.PREVIEW;const s=this.templateParam.PLACEHOLDERS||{};const a=this.templateParam.FILLED_PLACEHOLDERS||[];F=new BX.Crm.Template.Editor(e).setPlaceholders(s).setFilledPlaceholders(a);F.setBody(t)},unmounted(){F=null},template:`\n\t\t<div class="bx-crm-group-actions-messages__item">\n\t\t\t<div class="bx-crm-group-actions-messages__item-title">{{ title }}</div>\n\t\t\t<div class="bx-crm-group-actions-messages__editor" ref="editorContainerEl"></div>\n\n\t\t\t<button\n\t\t\t\t@click="onSend"\n\t\t\t\tclass="ui-btn ui-btn-primary ui-btn-md bx-crm-group-actions-messages__button"\n\t\t\t>{{ messages.send }}</button>\n\t\t</div>\n\t`};var E=babelHelpers.classPrivateFieldLooseKey("messages");var S=babelHelpers.classPrivateFieldLooseKey("itemSlot");var _=babelHelpers.classPrivateFieldLooseKey("getTemplateItems");var f=babelHelpers.classPrivateFieldLooseKey("catalogHeader");var A=babelHelpers.classPrivateFieldLooseKey("catalogFooter");class I{constructor(){Object.defineProperty(this,A,{value:M});Object.defineProperty(this,f,{value:T});Object.defineProperty(this,_,{value:C});Object.defineProperty(this,S,{value:O});Object.defineProperty(this,E,{writable:true,value:{startConversation:l.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_POPUP_START"),sendFirst:l.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_POPUP_FIRST"),howItWork:l.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_POPUP_HOW"),learnCompliance:l.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_POPUP_COMPLIANCE"),learnMore:l.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_POPUP_MORE")}})}async create(e,t){const s=await o(e,t);const a=babelHelpers.classPrivateFieldLooseBase(this,_)[_](e,t,s);const r=babelHelpers.classPrivateFieldLooseBase(this,S)[S]();return new i.EntityCatalog({canDeselectGroups:false,showEmptyGroups:false,customComponents:{SmsEditorWrapper:B},slots:{[i.EntityCatalog.SLOT_MAIN_CONTENT_ITEM]:r,[i.EntityCatalog.SLOT_MAIN_CONTENT_HEADER]:babelHelpers.classPrivateFieldLooseBase(this,f)[f](),[i.EntityCatalog.SLOT_MAIN_CONTENT_FOOTER]:babelHelpers.classPrivateFieldLooseBase(this,A)[A]()},groups:a.groups,items:a.templateItems,title:l.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_POPUP_TITLE"),popupOptions:{overlay:true}})}}function O(){return`\n\t\t\t<div>\n\t\t\t\t<SmsEditorWrapper  \n\t\t\t\t\t:templateParam="itemSlotProps.itemData.customData"\n\t\t\t\t\t:title="itemSlotProps.itemData.title" \n\t\t\t\t\t:entityTypeId="itemSlotProps.itemData.entityTypeId"\n\t\t\t\t\t:categoryId="itemSlotProps.itemData.categoryId"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t`}function C(e,t,s){const a=s.map((e=>({id:e.ID,name:e.TITLE})));if(a.length>0){a[0].selected=true}const i=s.map((s=>({id:s.ORIGINAL_ID,title:s.TITLE,entityTypeId:e,categoryId:t,groupIds:[s.ID],customData:{title:s.TITLE,FILLED_PLACEHOLDERS:s.FILLED_PLACEHOLDERS||[],...s}})));return{groups:a,templateItems:i}}function T(){return`\n\t\t\t<div class="bx-crm-group-actions-messages-tpl-header">\n\t\t\t\t<div class="bx-crm-group-actions-messages-tpl-header-left">\n\t\t\t\t\t<div class="bx-crm-group-actions-messages-whatsapp-icon"></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-crm-group-actions-messages-tpl-header-center">\n\t\t\t\t\t<strong \n\t\t\t\t\t\tclass="bx-crm-group-actions-messages-tpl-header-center-title"\n\t\t\t\t\t>${babelHelpers.classPrivateFieldLooseBase(this,E)[E].startConversation}</strong><br>\n\t\t\t\t\t<span class="bx-crm-group-actions-messages-tpl-header_gray">${babelHelpers.classPrivateFieldLooseBase(this,E)[E].sendFirst}</span><br>\n\t\t\t\t\t<a \n\t\t\t\t\t\t\thref="#" \n\t\t\t\t\t\t\tonclick="BX.Event.EventEmitter.emit('BX.Crm.GroupActionsWhatsApp.Settings:help', { code: 20526810});"\n\t\t\t\t\t\t>${babelHelpers.classPrivateFieldLooseBase(this,E)[E].howItWork}</a>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-crm-group-actions-messages-tpl-header-right">\n\t\t\t\t\t<div \n\t\t\t\t\t\tclass="bx-crm-group-actions-messages-settings-icon"\n\t\t\t\t\t\tonclick="BX.Event.EventEmitter.emit('BX.Crm.GroupActionsWhatsApp.Settings:click');"\n\t\t\t\t\t></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`}function M(){return`\n\t\t\t<div class="bx-crm-group-actions-messages-compliance">\n\t\t\t\t${babelHelpers.classPrivateFieldLooseBase(this,E)[E].learnCompliance}\n\t\t\t</div>\n\t\t`}const R="ednaru";const w="bx.crm.group_actions.messages.selected_from_number";var G=babelHelpers.classPrivateFieldLooseKey("instance");var N=babelHelpers.classPrivateFieldLooseKey("options");var j=babelHelpers.classPrivateFieldLooseKey("progressBarRepo");var W=babelHelpers.classPrivateFieldLooseKey("catalog");var x=babelHelpers.classPrivateFieldLooseKey("settingsMenu");var X=babelHelpers.classPrivateFieldLooseKey("selectedFromNumber");var D=babelHelpers.classPrivateFieldLooseKey("messages");var K=babelHelpers.classPrivateFieldLooseKey("showSettingsMenu");var U=babelHelpers.classPrivateFieldLooseKey("showHelpArticle");var k=babelHelpers.classPrivateFieldLooseKey("destroy");var $=babelHelpers.classPrivateFieldLooseKey("fromPhoneSelected");var V=babelHelpers.classPrivateFieldLooseKey("sendMessages");var q=babelHelpers.classPrivateFieldLooseKey("showAnotherProcessRunningNotification");var z=babelHelpers.classPrivateFieldLooseKey("showGridLoader");var J=babelHelpers.classPrivateFieldLooseKey("hideGridLoader");var Q=babelHelpers.classPrivateFieldLooseKey("getGridLoader");var Y=babelHelpers.classPrivateFieldLooseKey("restoreLastSelectedFromNumber");var Z=babelHelpers.classPrivateFieldLooseKey("storeLastSelectedFromNumber");class ee{static getInstance(e,t){if(babelHelpers.classPrivateFieldLooseBase(ee,G)[G]){babelHelpers.classPrivateFieldLooseBase(ee,G)[G].setOptions(t)}else{babelHelpers.classPrivateFieldLooseBase(ee,G)[G]=new ee(e,t)}return babelHelpers.classPrivateFieldLooseBase(ee,G)[G]}constructor(e,t){Object.defineProperty(this,Z,{value:be});Object.defineProperty(this,Y,{value:de});Object.defineProperty(this,Q,{value:ce});Object.defineProperty(this,J,{value:ne});Object.defineProperty(this,z,{value:oe});Object.defineProperty(this,q,{value:re});Object.defineProperty(this,V,{value:le});Object.defineProperty(this,$,{value:ie});Object.defineProperty(this,k,{value:ae});Object.defineProperty(this,U,{value:se});Object.defineProperty(this,K,{value:te});Object.defineProperty(this,N,{writable:true,value:void 0});Object.defineProperty(this,j,{writable:true,value:void 0});Object.defineProperty(this,W,{writable:true,value:void 0});Object.defineProperty(this,x,{writable:true,value:null});Object.defineProperty(this,X,{writable:true,value:null});Object.defineProperty(this,D,{writable:true,value:{inProgress:l.Loc.getMessage("CRM_GROUP_ACTIONS_WHATSAPP_MESSAGE_IN_PROGRESS")}});babelHelpers.classPrivateFieldLooseBase(this,j)[j]=e;babelHelpers.classPrivateFieldLooseBase(this,N)[N]=t;babelHelpers.classPrivateFieldLooseBase(this,X)[X]=babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]()}setOptions(e){babelHelpers.classPrivateFieldLooseBase(this,N)[N]=e}async execute(){r.EventEmitter.subscribeOnce("BX.Crm.SmsEditorWrapper:click",babelHelpers.classPrivateFieldLooseBase(this,V)[V].bind(this));r.EventEmitter.subscribe("BX.Crm.GroupActionsWhatsApp.FromPhoneSelected",babelHelpers.classPrivateFieldLooseBase(this,$)[$].bind(this));babelHelpers.classPrivateFieldLooseBase(this,z)[z]();babelHelpers.classPrivateFieldLooseBase(this,W)[W]=await(new I).create(babelHelpers.classPrivateFieldLooseBase(this,N)[N].entityTypeId,babelHelpers.classPrivateFieldLooseBase(this,N)[N].categoryId);babelHelpers.classPrivateFieldLooseBase(this,J)[J]();babelHelpers.classPrivateFieldLooseBase(this,W)[W].show();const e=babelHelpers.classPrivateFieldLooseBase(this,W)[W].getPopup();e.subscribeOnce("onClose",babelHelpers.classPrivateFieldLooseBase(this,k)[k].bind(this));r.EventEmitter.subscribe("BX.Crm.GroupActionsWhatsApp.Settings:click",babelHelpers.classPrivateFieldLooseBase(this,K)[K].bind(this));r.EventEmitter.subscribe("BX.Crm.GroupActionsWhatsApp.Settings:help",babelHelpers.classPrivateFieldLooseBase(this,U)[U].bind(this))}}async function te(e){if(babelHelpers.classPrivateFieldLooseBase(this,x)[x]!==null){babelHelpers.classPrivateFieldLooseBase(this,x)[x].close();babelHelpers.classPrivateFieldLooseBase(this,x)[x].destroy();babelHelpers.classPrivateFieldLooseBase(this,x)[x]=null}babelHelpers.classPrivateFieldLooseBase(this,x)[x]=await new m(babelHelpers.classPrivateFieldLooseBase(this,X)[X]).create();babelHelpers.classPrivateFieldLooseBase(this,x)[x].show()}function se(e){const t=e.getData().code;if(!t){throw new Error("articleCode is not defined")}const s=l.Reflection.getClass("top.BX.Helper");if(s){s.show(`redirect=detail&code=${t}`)}}function ae(){r.EventEmitter.unsubscribeAll("BX.Crm.SmsEditorWrapper:click");r.EventEmitter.unsubscribeAll("BX.Crm.GroupActionsWhatsApp.Settings:click");r.EventEmitter.unsubscribeAll("BX.Crm.GroupActionsWhatsApp.Settings:help");r.EventEmitter.unsubscribeAll("BX.Crm.GroupActionsWhatsApp.FromPhoneSelected");if(babelHelpers.classPrivateFieldLooseBase(this,W)[W]){babelHelpers.classPrivateFieldLooseBase(this,W)[W].getPopup().unsubscribeAll("onClose");babelHelpers.classPrivateFieldLooseBase(this,W)[W].close();babelHelpers.classPrivateFieldLooseBase(this,W)[W]=null}if(babelHelpers.classPrivateFieldLooseBase(this,x)[x]){babelHelpers.classPrivateFieldLooseBase(this,x)[x].close();babelHelpers.classPrivateFieldLooseBase(this,x)[x].destroy();babelHelpers.classPrivateFieldLooseBase(this,x)[x]=null}}function ie(e){const t=e.getData().phone;babelHelpers.classPrivateFieldLooseBase(this,Z)[Z](t);babelHelpers.classPrivateFieldLooseBase(this,X)[X]=t}async function le(e){var s,a;const i=babelHelpers.classPrivateFieldLooseBase(this,N)[N].gridId;const l=babelHelpers.classPrivateFieldLooseBase(this,N)[N].entityTypeId;const r=((s=e.getData())==null?void 0:s.text)||"";const o=((a=e.getData())==null?void 0:a.templateId)||null;const n=babelHelpers.classPrivateFieldLooseBase(this,j)[j].getOrCreateProgressBarContainer("whatsapp-message").id;const c={gridId:i,entityTypeId:l,container:n};const d=t.BatchWhatsappMessageManager.getInstance(i,c);if(d.isRunning()){return}if(t.ProcessRegistry.isProcessRunning(i)){babelHelpers.classPrivateFieldLooseBase(this,q)[q]();return}d.setTemplateParams({messageBody:r,messageTemplate:o,fromPhone:babelHelpers.classPrivateFieldLooseBase(this,X)[X]});if(babelHelpers.classPrivateFieldLooseBase(this,N)[N].forAll){d.resetEntityIds()}else{d.setEntityIds(babelHelpers.classPrivateFieldLooseBase(this,N)[N].selectedIds)}d.execute();babelHelpers.classPrivateFieldLooseBase(this,k)[k]()}function re(){s.UI.Notification.Center.notify({content:babelHelpers.classPrivateFieldLooseBase(this,D)[D].inProgress,autoHide:true,autoHideDelay:5e3})}function oe(){const e=babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]();if(e){e.show()}}function ne(){const e=babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]();if(e){e.hide()}}function ce(){var e,t;return(e=BX.Main.gridManager.getById(babelHelpers.classPrivateFieldLooseBase(this,N)[N].gridId))==null?void 0:(t=e.instance)==null?void 0:t.getLoader()}function de(){return localStorage.getItem(w)||null}function be(e){localStorage.setItem(w,e)}Object.defineProperty(ee,G,{writable:true,value:null});e.DEFAULT_PROVIDER=R;e.Messages=ee})(this.BX.Crm.GroupActions=this.BX.Crm.GroupActions||{},BX.Crm.Autorun,BX,BX.Main,BX.UI,BX,BX.Event);
//# sourceMappingURL=messages.bundle.map.js