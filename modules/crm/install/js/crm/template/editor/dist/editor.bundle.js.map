{"version":3,"file":"editor.bundle.js","sources":["../src/editor.js"],"sourcesContent":["import { Dom, Event, Loc, Runtime, Tag, Text, Type } from 'main.core';\nimport { BaseEvent } from 'main.core.events';\nimport { Dialog } from 'crm.entity-selector';\nimport { DialogOptions } from 'ui.entity-selector';\n\nimport type { EditorOptions } from './editor-options';\n\nimport 'ui.design-tokens';\nimport './editor.css';\n\nconst SELECTOR_TARGET_NAME = 'crm-template-editor-element-pill';\n\nexport class Editor\n{\n\t#id: ?string;\n\t#target: HTMLElement = null;\n\t#entityTypeId: number = null;\n\t#entityId: number = null;\n\t#categoryId: ?number = null;\n\t#placeHolderMaskRe: ?RegExp = null;\n\n\t#headerContainerEl: ?HTMLElement = null;\n\t#bodyContainerEl: ?HTMLElement = null;\n\t#footerContainerEl: ?HTMLElement = null;\n\n\t#placeHoldersDialogDefaultOptions: ?DialogOptions = null;\n\n\t#headerRaw: ?string = null;\n\t#bodyRaw: ?string = null;\n\t#footerRaw: ?string = null;\n\n\tconstructor(params: EditorOptions)\n\t{\n\t\tthis.#assertValidParams(params);\n\n\t\tthis.#id = params.id || `crm-template-editor-${Text.getRandom()}`;\n\t\tthis.#target = params.target;\n\t\tthis.#entityTypeId = params.entityTypeId;\n\t\tthis.#entityId = params.entityId;\n\t\tthis.#categoryId = Type.isNumber(params.entityId) ? params.entityId : null;\n\t\tthis.#placeHolderMaskRe = Type.isStringFilled(params.placeHolderMaskRe)\n\t\t\t? params.placeHolderMaskRe\n\t\t\t: /{{\\s+(\\d+)\\s+}}/g; // {{ 1 }}, {{ 2 }}, {{ 3 }} ... default regex\n\n\t\tthis.#placeHoldersDialogDefaultOptions = {\n\t\t\tmultiple: false,\n\t\t\tshowAvatars: false,\n\t\t\tdropdownMode: true,\n\t\t\tcompactView: true,\n\t\t\tenableSearch: true,\n\t\t\ttagSelectorOptions: {\n\t\t\t\ttextBoxWidth: '100%',\n\t\t\t},\n\t\t\tentities: [{\n\t\t\t\tid: 'placeholder',\n\t\t\t\toptions: {\n\t\t\t\t\tentityTypeId: this.#entityTypeId,\n\t\t\t\t\tentityId: this.#entityId,\n\t\t\t\t\tcategoryId: this.#categoryId,\n\t\t\t\t},\n\t\t\t}],\n\t\t};\n\n\t\tthis.#createContainer();\n\t\tthis.#bindEvents();\n\t}\n\n\t// region Public methods\n\tsetHeader(input: string): void\n\t{\n\t\tif (!Type.isStringFilled(input))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#headerRaw = input;\n\t\tDom.append(this.#createContainerWithSelectors(input), this.#headerContainerEl);\n\t}\n\n\tsetBody(input: string): void\n\t{\n\t\tif (!Type.isStringFilled(input))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#bodyRaw = input;\n\t\tDom.append(this.#createContainerWithSelectors(input), this.#bodyContainerEl);\n\t}\n\n\tsetFooter(input: string): void\n\t{\n\t\tif (!Type.isStringFilled(input))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#footerRaw = input;\n\t\tDom.append(this.#createContainerWithSelectors(input), this.#footerContainerEl);\n\t}\n\n\tgetData(): Object\n\t{\n\t\treturn {\n\t\t\theader: this.#getPlainText(this.#headerContainerEl),\n\t\t\tbody: this.#getPlainText(this.#bodyContainerEl),\n\t\t\tfooter: this.#getPlainText(this.#footerContainerEl),\n\t\t};\n\t}\n\n\tgetRawData(): Object\n\t{\n\t\treturn {\n\t\t\theader: this.#headerRaw,\n\t\t\tbody: this.#bodyRaw,\n\t\t\tfooter: this.#footerRaw,\n\t\t};\n\t}\n\t// endregion\n\n\t#createContainer(): void\n\t{\n\t\tif (!this.#target)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst containerEl = Tag.render`\n\t\t\t<div id=\"${this.#id}\" class=\"crm-template-editor crm-template-editor__scope\"></div>\n\t\t`;\n\n\t\tthis.#headerContainerEl = Tag.render`<div class=\"crm-template-editor-header\"></div>`;\n\t\tDom.append(this.#headerContainerEl, containerEl);\n\t\tthis.#bodyContainerEl = Tag.render`<div class=\"crm-template-editor-body\"></div>`;\n\t\tDom.append(this.#bodyContainerEl, containerEl);\n\t\tthis.#footerContainerEl = Tag.render`<div class=\"crm-template-editor-footer\"></div>`;\n\t\tDom.append(this.#footerContainerEl, containerEl);\n\n\t\tDom.append(containerEl, this.#target);\n\t}\n\n\t#createContainerWithSelectors(input: string): HTMLElement\n\t{\n\t\tconst placeHolders = input.match(this.#placeHolderMaskRe);\n\t\tif (!placeHolders)\n\t\t{\n\t\t\treturn input;\n\t\t}\n\n\t\tconst result: string = input.replace(\n\t\t\tthis.#placeHolderMaskRe,\n\t\t\t`<span class=\"${SELECTOR_TARGET_NAME}\">${Loc.getMessage('CRM_TEMPLATE_EDITOR_EMPTY_PLACEHOLDER_LABEL')}</span>`,\n\t\t);\n\n\t\tconst container = Tag.render`<div>${result}</div>`;\n\t\tconst dlgOptions = this.#placeHoldersDialogDefaultOptions;\n\t\tconst elements = container.querySelectorAll(`.${SELECTOR_TARGET_NAME}`);\n\t\telements.forEach((element?: Node): void => {\n\t\t\tdlgOptions.events = {\n\t\t\t\t'Item:onSelect': (event: BaseEvent): void => {\n\t\t\t\t\tconst item = event.getData().item;\n\n\t\t\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\t\t\telement.textContent = item.getTitle();\n\t\t\t\t\tDom.attr(element, 'placeholder-id', item.id);\n\t\t\t\t\tDom.addClass(element, '--selected');\n\t\t\t\t},\n\t\t\t\t'Item:onDeselect': (event: BaseEvent): void => {\n\t\t\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\t\t\telement.textContent = Loc.getMessage('CRM_TEMPLATE_EDITOR_EMPTY_PLACEHOLDER_LABEL');\n\t\t\t\t\tDom.attr(element, 'placeholder-id', '');\n\t\t\t\t\tDom.removeClass(element, '--selected');\n\t\t\t\t},\n\t\t\t};\n\t\t\tdlgOptions.targetNode = element;\n\n\t\t\tconst dlg = new Dialog(dlgOptions);\n\n\t\t\tEvent.bind(element, 'click', () => dlg.show());\n\t\t});\n\n\t\treturn container;\n\t}\n\n\t#getPlainText(container: HTMLElement): ?string\n\t{\n\t\tif (!Type.isDomNode(container))\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst containerCopy = Runtime.clone(container);\n\t\tconst elements = containerCopy.querySelectorAll(`.${SELECTOR_TARGET_NAME}`);\n\t\telements.forEach((element?: Node): void => {\n\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\telement.textContent = element?.hasAttribute('placeholder-id')\n\t\t\t\t? `{${element.getAttribute('placeholder-id')}}`\n\t\t\t\t: '';\n\t\t});\n\n\t\treturn containerCopy.textContent;\n\t}\n\n\t// region Event handlers\n\t#bindEvents(): void\n\t{\n\t\t// TODO: not implemented yet\n\t}\n\t// endregion\n\n\t#assertValidParams(params: EditorOptions): void\n\t{\n\t\tif (!Type.isPlainObject(params))\n\t\t{\n\t\t\tthrow new TypeError('BX.Crm.Template.Editor: The \"params\" argument must be object');\n\t\t}\n\n\t\tif (!Type.isDomNode(params.target))\n\t\t{\n\t\t\tthrow new Error('BX.Crm.Template.Editor: The \"target\" argument must be DOM node');\n\t\t}\n\n\t\tif (!BX.CrmEntityType.isDefined(params.entityTypeId))\n\t\t{\n\t\t\tthrow new TypeError('BX.Crm.Template.Editor: The \"entityTypeId\" argument is not correct');\n\t\t}\n\n\t\tif (!Type.isNumber(params.entityId) || params.entityId <= 0)\n\t\t{\n\t\t\tthrow new TypeError('BX.Crm.Template.Editor: The \"entityId\" argument is not correct');\n\t\t}\n\t}\n}\n"],"names":["SELECTOR_TARGET_NAME","Editor","params","id","Text","getRandom","target","entityTypeId","entityId","Type","isNumber","isStringFilled","placeHolderMaskRe","multiple","showAvatars","dropdownMode","compactView","enableSearch","tagSelectorOptions","textBoxWidth","entities","options","categoryId","input","Dom","append","header","body","footer","containerEl","Tag","render","placeHolders","match","result","replace","Loc","getMessage","container","dlgOptions","elements","querySelectorAll","forEach","element","events","event","item","getData","textContent","getTitle","attr","addClass","removeClass","targetNode","dlg","Dialog","Event","bind","show","isDomNode","containerCopy","Runtime","clone","hasAttribute","getAttribute","isPlainObject","TypeError","Error","BX","CrmEntityType","isDefined"],"mappings":"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"}