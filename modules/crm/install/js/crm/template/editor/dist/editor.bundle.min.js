this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,l,a,i,r,s,n){"use strict";function o(e,t){h(e,t);t.add(e)}function c(e,t,l){h(e,t);t.set(e,l)}function h(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function u(e,t,l){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return l}var d=new WeakMap;var v=new WeakMap;var p=new WeakMap;var b=new WeakMap;var f=new WeakMap;var E=new WeakSet;var T=new WeakSet;var P=new WeakSet;var w=new WeakSet;var m=new WeakSet;var F=function(){function e(t){var l=t.bindElement,a=t.isTextItemFirst,i=t.onEditorItemClick,r=t.onTextItemClick;babelHelpers.classCallCheck(this,e);o(this,m);o(this,w);o(this,P);o(this,T);o(this,E);c(this,d,{writable:true,value:null});c(this,v,{writable:true,value:null});c(this,p,{writable:true,value:false});c(this,b,{writable:true,value:function e(){}});c(this,f,{writable:true,value:function e(){}});babelHelpers.classPrivateFieldSet(this,v,l);babelHelpers.classPrivateFieldSet(this,p,a);babelHelpers.classPrivateFieldSet(this,b,i);babelHelpers.classPrivateFieldSet(this,f,r)}babelHelpers.createClass(e,[{key:"show",value:function e(){u(this,E,H).call(this).show()}}]);return e}();function H(){if(babelHelpers.classPrivateFieldGet(this,d)===null){babelHelpers.classPrivateFieldSet(this,d,s.MenuManager.create({id:"crm-template-editor-placeholder-selector",bindElement:babelHelpers.classPrivateFieldGet(this,v),autoHide:true,offsetLeft:20,angle:true,closeByEsc:false,cacheable:false,items:u(this,T,S).call(this)}))}return babelHelpers.classPrivateFieldGet(this,d)}function S(){var e=u(this,P,y).call(this);var t=u(this,w,g).call(this);if(babelHelpers.classPrivateFieldGet(this,p)){return[t,e]}return[e,t]}function y(){var e=this;return{html:u(this,m,k).call(this,"CRM_TEMPLATE_EDITOR_SELECT_FIELD"),onclick:function t(){babelHelpers.classPrivateFieldGet(e,b).call(e,babelHelpers.classPrivateFieldGet(e,v))}}}function g(){var e=this;var t=babelHelpers.classPrivateFieldGet(this,p)?"CRM_TEMPLATE_EDITOR_UPDATE_TEXT":"CRM_TEMPLATE_EDITOR_CREATE_TEXT";return{html:u(this,m,k).call(this,t),onclick:function t(){u(e,E,H).call(e).close();babelHelpers.classPrivateFieldGet(e,f).call(e,babelHelpers.classPrivateFieldGet(e,v))}}}function k(e){var t='<span class="crm-template-editor-placeholder-selector-menu-item">#ITEM_TEXT#</span>';return t.replace("#ITEM_TEXT#",r.Text.encode(r.Loc.getMessage(e)))}var L,I;function D(e,t){M(e,t);t.add(e)}function _(e,t,l){M(e,t);t.set(e,l)}function M(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function C(e,t,l){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return l}var W=new WeakMap;var G=new WeakMap;var A=new WeakMap;var B=new WeakMap;var R=new WeakMap;var x=new WeakSet;var X=new WeakSet;var O=new WeakSet;var N=new WeakSet;var U=new WeakSet;var V=new WeakSet;var j=new WeakSet;var z=new WeakSet;var Y=new WeakSet;var q=new WeakSet;var J=new WeakSet;var K=function(){function e(t){var l=t.bindElement,a=t.value,i=t.onApply;babelHelpers.classCallCheck(this,e);D(this,J);D(this,q);D(this,Y);D(this,z);D(this,j);D(this,V);D(this,U);D(this,N);D(this,O);D(this,X);D(this,x);_(this,W,{writable:true,value:null});_(this,G,{writable:true,value:null});_(this,A,{writable:true,value:null});_(this,B,{writable:true,value:null});_(this,R,{writable:true,value:function e(){}});babelHelpers.classPrivateFieldSet(this,A,l);babelHelpers.classPrivateFieldSet(this,B,a);babelHelpers.classPrivateFieldSet(this,R,i)}babelHelpers.createClass(e,[{key:"destroy",value:function e(){var t;(t=babelHelpers.classPrivateFieldGet(this,W))===null||t===void 0?void 0:t.destroy()}},{key:"show",value:function e(){C(this,x,Q).call(this).show()}}]);return e}();function Q(){var e=this;if(babelHelpers.classPrivateFieldGet(this,W)===null){babelHelpers.classPrivateFieldSet(this,W,s.PopupWindowManager.create("crm-template-editor-text-popup",babelHelpers.classPrivateFieldGet(this,A),{autoHide:true,content:C(this,X,Z).call(this),closeByEsc:true,closeIcon:false,buttons:C(this,N,ee).call(this),cacheable:false}));babelHelpers.classPrivateFieldGet(this,W).subscribe("onShow",(function(){babelHelpers.classPrivateFieldGet(e,G).focus();C(e,J,ne).call(e)}))}return babelHelpers.classPrivateFieldGet(this,W)}function Z(){var e=r.Tag.render(L||(L=babelHelpers.taggedTemplateLiteral(['<div class="crm-template-editor-text-popup-wrapper"></div>'])));babelHelpers.classPrivateFieldSet(this,G,r.Tag.render(I||(I=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input \n\t\t\t\ttype="text" \n\t\t\t\tvalue="','"\n\t\t\t\tplaceholder="','\n\t\t\t">\n\t\t'])),r.Text.encode(babelHelpers.classPrivateFieldGet(this,B)),r.Loc.getMessage("CRM_TEMPLATE_EDITOR_SELECT_FIELD_PLACEHOLDER")));r.Dom.append(babelHelpers.classPrivateFieldGet(this,G),e);C(this,O,$).call(this);return e}function $(){var e=this;r.Event.bind(babelHelpers.classPrivateFieldGet(this,G),"keyup",(function(t){var l=C(e,Y,re).call(e);if(!l){return}var a=t.target.value;C(e,V,le).call(e,l,a)}))}function ee(){return[C(this,U,te).call(this),C(this,q,se).call(this)]}function te(){var e=this;var t=new n.Button({id:"apply-button",text:C(this,j,ae).call(this),className:"ui-btn ui-btn-xs ui-btn-primary ui-btn-round",onclick:function t(){C(e,z,ie).call(e)}});var l=babelHelpers.classPrivateFieldGet(this,G),a=l.value;C(this,V,le).call(this,t,a);return t}function le(e,t){e.setState(r.Type.isStringFilled(t)&&r.Type.isStringFilled(t.trim())?n.ButtonState.ACTIVE:n.ButtonState.DISABLED)}function ae(){if(r.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,B))){return r.Loc.getMessage("CRM_TEMPLATE_EDITOR_TEXT_POPUP_UPDATE")}return r.Loc.getMessage("CRM_TEMPLATE_EDITOR_TEXT_POPUP_ADD")}function ie(){var e=C(this,Y,re).call(this);if(e.getState()!==n.ButtonState.ACTIVE){return}this.destroy();var t=babelHelpers.classPrivateFieldGet(this,G),l=t.value;babelHelpers.classPrivateFieldGet(this,A).textContent=r.Text.encode(l);babelHelpers.classPrivateFieldGet(this,R).call(this,l.trim())}function re(){return babelHelpers.classPrivateFieldGet(this,W).getButton("apply-button")}function se(){var e=this;return new n.Button({text:r.Loc.getMessage("CRM_TEMPLATE_EDITOR_TEXT_POPUP_CANCEL"),className:"ui-btn ui-btn-xs ui-btn-light ui-btn-round",onclick:function t(){e.destroy()}})}function ne(){var e=babelHelpers.classPrivateFieldGet(this,G).value.length;babelHelpers.classPrivateFieldGet(this,G).selectionStart=e;babelHelpers.classPrivateFieldGet(this,G).selectionEnd=e}var oe,ce,he,ue,de;function ve(e,t){be(e,t);t.add(e)}function pe(e,t,l){be(e,t);t.set(e,l)}function be(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function fe(e,t,l){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return l}var Ee="update";var Te="delete";var Pe="HEADER";var we="PREVIEW";var me="FOOTER";var Fe=new WeakMap;var He=new WeakMap;var Se=new WeakMap;var ye=new WeakMap;var ge=new WeakMap;var ke=new WeakMap;var Le=new WeakMap;var Ie=new WeakMap;var De=new WeakMap;var _e=new WeakMap;var Me=new WeakMap;var Ce=new WeakMap;var We=new WeakMap;var Ge=new WeakMap;var Ae=new WeakMap;var Be=new WeakMap;var Re=new WeakSet;var xe=new WeakSet;var Xe=new WeakSet;var Oe=new WeakSet;var Ne=new WeakSet;var Ue=new WeakSet;var Ve=new WeakSet;var je=new WeakSet;var ze=new WeakSet;var Ye=new WeakSet;var qe=new WeakSet;var Je=new WeakSet;var Ke=new WeakSet;var Qe=new WeakSet;var Ze=new WeakSet;var $e=function(){function e(t){var l,a;babelHelpers.classCallCheck(this,e);ve(this,Ze);ve(this,Qe);ve(this,Ke);ve(this,Je);ve(this,qe);ve(this,Ye);ve(this,ze);ve(this,je);ve(this,Ve);ve(this,Ue);ve(this,Ne);ve(this,Oe);ve(this,Xe);ve(this,xe);ve(this,Re);pe(this,Fe,{writable:true,value:void 0});pe(this,He,{writable:true,value:null});pe(this,Se,{writable:true,value:null});pe(this,ye,{writable:true,value:null});pe(this,ge,{writable:true,value:null});pe(this,ke,{writable:true,value:true});pe(this,Le,{writable:true,value:true});babelHelpers.defineProperty(this,"placeholders",[]);babelHelpers.defineProperty(this,"filledPlaceholders",[]);babelHelpers.defineProperty(this,"onSelect",(function(){}));pe(this,Ie,{writable:true,value:null});pe(this,De,{writable:true,value:null});pe(this,_e,{writable:true,value:null});pe(this,Me,{writable:true,value:null});pe(this,Ce,{writable:true,value:null});pe(this,We,{writable:true,value:null});pe(this,Ge,{writable:true,value:null});pe(this,Ae,{writable:true,value:null});pe(this,Be,{writable:true,value:null});fe(this,Ze,pt).call(this,t);babelHelpers.classPrivateFieldSet(this,Fe,t.id||"crm-template-editor-".concat(r.Text.getRandom()));babelHelpers.classPrivateFieldSet(this,He,t.target);babelHelpers.classPrivateFieldSet(this,Se,t.entityTypeId);babelHelpers.classPrivateFieldSet(this,ye,t.entityId);babelHelpers.classPrivateFieldSet(this,ge,r.Type.isNumber(t.categoryId)?t.categoryId:null);this.onSelect=t.onSelect;babelHelpers.classPrivateFieldSet(this,ke,Boolean((l=t.canUseFieldsDialog)!==null&&l!==void 0?l:true));babelHelpers.classPrivateFieldSet(this,Le,Boolean((a=t.canUseFieldValueInput)!==null&&a!==void 0?a:true));this.onPlaceholderClick=this.onPlaceholderClick.bind(this);this.onShowInputPopup=this.onShowInputPopup.bind(this);babelHelpers.classPrivateFieldSet(this,Me,{multiple:false,showAvatars:false,dropdownMode:true,compactView:true,enableSearch:true,tagSelectorOptions:{textBoxWidth:"100%"},entities:[{id:"placeholder",options:{entityTypeId:babelHelpers.classPrivateFieldGet(this,Se),entityId:babelHelpers.classPrivateFieldGet(this,ye),categoryId:babelHelpers.classPrivateFieldGet(this,ge)}}]});fe(this,Re,et).call(this)}babelHelpers.createClass(e,[{key:"setPlaceholders",value:function e(t){this.placeholders=t;return this}},{key:"setFilledPlaceholders",value:function e(t){this.filledPlaceholders=t;return this}},{key:"setHeader",value:function e(t){if(!r.Type.isStringFilled(t)){return}babelHelpers.classPrivateFieldSet(this,Ce,t);r.Dom.append(fe(this,xe,tt).call(this,t),babelHelpers.classPrivateFieldGet(this,Ie))}},{key:"setBody",value:function e(t){if(!r.Type.isStringFilled(t)){return}babelHelpers.classPrivateFieldSet(this,We,t);r.Dom.append(fe(this,xe,tt).call(this,t),babelHelpers.classPrivateFieldGet(this,De))}},{key:"setFooter",value:function e(t){if(!r.Type.isStringFilled(t)){return}babelHelpers.classPrivateFieldSet(this,Ge,t);r.Dom.append(fe(this,xe,tt).call(this,t),babelHelpers.classPrivateFieldGet(this,_e))}},{key:"getData",value:function e(){if(this.placeholders===null){return null}return{header:fe(this,Ke,dt).call(this,Pe),body:fe(this,Ke,dt).call(this,we),footer:fe(this,Ke,dt).call(this,me)}}},{key:"getRawData",value:function e(){return{header:babelHelpers.classPrivateFieldGet(this,Ce),body:babelHelpers.classPrivateFieldGet(this,We),footer:babelHelpers.classPrivateFieldGet(this,Ge)}}},{key:"onPlaceholderClick",value:function e(t){var l,a=this;var i=t.dialog,s=t.event;(l=babelHelpers.classPrivateFieldGet(this,Be))===null||l===void 0?void 0:l.destroy();var n=fe(this,Ye,ct).call(this,s.target,we);var o=r.Type.isStringFilled(n===null||n===void 0?void 0:n.FIELD_VALUE);if(babelHelpers.classPrivateFieldGet(this,ke)&&babelHelpers.classPrivateFieldGet(this,Le)){babelHelpers.classPrivateFieldSet(this,Ae,new F({bindElement:s.target,isTextItemFirst:o,onEditorItemClick:function e(){a.onShowDialogPopup(n,i)},onTextItemClick:function e(t){a.onShowInputPopup(t)}}));babelHelpers.classPrivateFieldGet(this,Ae).show()}else if(babelHelpers.classPrivateFieldGet(this,ke)){this.onShowDialogPopup(n,i)}else if(babelHelpers.classPrivateFieldGet(this,Le)){this.onShowInputPopup(s.target)}}},{key:"onShowDialogPopup",value:function e(t,l){if(r.Type.isStringFilled(t===null||t===void 0?void 0:t.FIELD_VALUE)){l.getPreselectedItems().forEach((function(e){var t=l.getItem(e);if(t){t.deselect()}}))}l.show()}},{key:"onShowInputPopup",value:function e(t){var l=this;var a=fe(this,Ye,ct).call(this,t);var i=r.Type.isStringFilled(a===null||a===void 0?void 0:a.FIELD_VALUE)?a.FIELD_VALUE:"";babelHelpers.classPrivateFieldSet(this,Be,new K({bindElement:t,value:i,onApply:function e(a){fe(l,Xe,lt).call(l,a,t)}}));babelHelpers.classPrivateFieldGet(this,Be).show()}}]);return e}();function et(){if(!babelHelpers.classPrivateFieldGet(this,He)){return}var e=r.Tag.render(oe||(oe=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div id="','" class="crm-template-editor crm-template-editor__scope"></div>\n\t\t'])),babelHelpers.classPrivateFieldGet(this,Fe));babelHelpers.classPrivateFieldSet(this,Ie,r.Tag.render(ce||(ce=babelHelpers.taggedTemplateLiteral(['<div class="crm-template-editor-header"></div>']))));r.Dom.append(babelHelpers.classPrivateFieldGet(this,Ie),e);babelHelpers.classPrivateFieldSet(this,De,r.Tag.render(he||(he=babelHelpers.taggedTemplateLiteral(['<div class="crm-template-editor-body"></div>']))));r.Dom.append(babelHelpers.classPrivateFieldGet(this,De),e);babelHelpers.classPrivateFieldSet(this,_e,r.Tag.render(ue||(ue=babelHelpers.taggedTemplateLiteral(['<div class="crm-template-editor-footer"></div>']))));r.Dom.append(babelHelpers.classPrivateFieldGet(this,_e),e);r.Dom.clean(babelHelpers.classPrivateFieldGet(this,He));r.Dom.append(e,babelHelpers.classPrivateFieldGet(this,He))}function tt(e){var l=this;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:we;var i=fe(this,Ne,it).call(this,a);if(i===null){return null}var s=fe(this,Oe,at).call(this,e,a);var n=babelHelpers.classPrivateFieldGet(this,Me);i.forEach((function(e,i){var o=babelHelpers.toConsumableArray(s.childNodes).find((function(e){return e.dataset&&Number(e.dataset.templatePlaceholder)===i}));if(!o){return}fe(l,Ue,rt).call(l,n,o,a);var c=new t.Dialog(n);r.Event.bind(o,"click",(function(e){l.onPlaceholderClick({dialog:c,event:e})}))}));return s}function lt(e,t){var l=fe(this,qe,ht).call(this,t,we);var a={id:l,parentTitle:null,text:e,title:e,entityType:BX.CrmEntityType.resolveName(babelHelpers.classPrivateFieldGet(this,Se)).toLowerCase()};t.textContent=e;r.Dom.addClass(t,"--selected");fe(this,Ve,st).call(this,a);this.onSelect(a)}function at(e,t){var l=this;var a=fe(this,Ne,it).call(this,t);if(a===null){return null}var i=0;a.forEach((function(t){var a=fe(l,Je,ut).call(l,t);var s=r.Loc.getMessage("CRM_TEMPLATE_EDITOR_EMPTY_PLACEHOLDER_LABEL");var n="crm-template-editor-element-pill";if(a){if(r.Type.isStringFilled(a.PARENT_TITLE)&&r.Type.isStringFilled(a.TITLE)){s="".concat(a.PARENT_TITLE,": ").concat(a.TITLE)}else if(r.Type.isStringFilled(a.TITLE)){s=a.TITLE}else if(r.Type.isStringFilled(a.FIELD_NAME)){s=a.FIELD_NAME}else{s=a.FIELD_VALUE}s=r.Text.encode(s);n+=" --selected"}var o='<span class="'.concat(n,'" data-template-placeholder="').concat(i++,'">').concat(s,"</span>");e=e.replace(t,o)}));return r.Tag.render(de||(de=babelHelpers.taggedTemplateLiteral(["<div>","</div>"])),e)}function it(e){var t=r.Type.isPlainObject(this.placeholders)?this.placeholders:{};var l=r.Type.isArrayFilled(t[e])?t[e]:[];return r.Type.isArrayLike(l)?l:null}function rt(e,t,l){var a,i=this;var s=fe(this,Ne,it).call(this,l);var n=(a=s[t.dataset.templatePlaceholder])!==null&&a!==void 0?a:null;if(n){var o=fe(this,Je,ut).call(this,n);if(o){e.preselectedItems=[[o.FIELD_ENTITY_TYPE,o.FIELD_NAME]]}}e.events={onShow:function e(){var l=[{transform:"rotate(0)"},{transform:"rotate(90deg)"},{transform:"rotate(180deg)"}];var a={duration:200,pseudoElement:"::after"};t.animate(l,a);r.Dom.addClass(t,"--flipped")},onHide:function e(){var l=[{transform:"rotate(180deg)"},{transform:"rotate(90deg)"},{transform:"rotate(0)"}];var a={duration:200,pseudoElement:"::after"};t.animate(l,a);r.Dom.removeClass(t,"--flipped")},"Item:onSelect":function e(l){r.Dom.addClass(t,"--selected");var a=l.getData().item;var s=a.supertitle.text;var o=a.title.text;t.textContent="".concat(s,": ").concat(o);var c=a.id;var h=a.entityId;var u={id:n,value:c,parentTitle:s,title:o,entityType:h};fe(i,Ve,st).call(i,u);i.onSelect(u)}};e.targetNode=t}function st(e){var t=e.id,l=e.value,a=e.text,i=e.parentTitle,r=e.title;var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:Ee;if(s===Te){fe(this,je,nt).call(this,t,l);return}fe(this,ze,ot).call(this,{id:t,value:l,text:a,parentTitle:i,title:r})}function nt(e,t){this.filledPlaceholders=this.filledPlaceholders.filter((function(l){return l.PLACEHOLDER_ID!==e||l.FIELD_NAME!==t}))}function ot(e){var t=e.id,l=e.value,a=e.text,i=e.parentTitle,r=e.title;var s=fe(this,Je,ut).call(this,t);if(s){s.FIELD_NAME=l!==null&&l!==void 0?l:null;s.FIELD_VALUE=a!==null&&a!==void 0?a:null;s.PARENT_TITLE=i;s.TITLE=r}else{this.filledPlaceholders.push({PLACEHOLDER_ID:t,FIELD_NAME:l,FIELD_VALUE:a,PARENT_TITLE:i,TITLE:r})}}function ct(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:we;var l=fe(this,qe,ht).call(this,e,t);return fe(this,Je,ut).call(this,l)}function ht(e){var t;var l=arguments.length>1&&arguments[1]!==undefined?arguments[1]:we;var a=fe(this,Ne,it).call(this,l);return(t=a[e.dataset.templatePlaceholder])!==null&&t!==void 0?t:null}function ut(e){return this.filledPlaceholders.find((function(t){return t.PLACEHOLDER_ID===e}))}function dt(e){var t=fe(this,Qe,vt).call(this,e);if(t===null){return null}if(r.Type.isArrayFilled(this.filledPlaceholders)){this.filledPlaceholders.forEach((function(e){if(r.Type.isStringFilled(e.FIELD_NAME)){t=t.replace(e.PLACEHOLDER_ID,"{".concat(e.FIELD_NAME,"}"))}else if(r.Type.isStringFilled(e.FIELD_VALUE)){t=t.replace(e.PLACEHOLDER_ID,e.FIELD_VALUE)}}))}var l=this.placeholders[e];if(r.Type.isArrayFilled(l)){l.forEach((function(e){t=t.replace(e," ")}))}return t}function vt(e){if(e===Pe){return babelHelpers.classPrivateFieldGet(this,Ce)}if(e===we){return babelHelpers.classPrivateFieldGet(this,We)}if(e===me){return babelHelpers.classPrivateFieldGet(this,Ge)}return null}function pt(e){if(!r.Type.isPlainObject(e)){throw new TypeError('BX.Crm.Template.Editor: The "params" argument must be object')}if(!r.Type.isDomNode(e.target)){throw new Error('BX.Crm.Template.Editor: The "target" argument must be DOM node')}if(!BX.CrmEntityType.isDefined(e.entityTypeId)){throw new TypeError('BX.Crm.Template.Editor: The "entityTypeId" argument is not correct')}if(!r.Type.isNumber(e.entityId)||e.entityId<=0){throw new TypeError('BX.Crm.Template.Editor: The "entityId" argument is not correct')}if(!r.Type.isFunction(e.onSelect)){throw new TypeError('BX.Crm.Template.Editor: The "onSelect" argument is not correct')}}e.Editor=$e})(this.BX.Crm.Template=this.BX.Crm.Template||{},BX.Crm.EntitySelectorEx,BX.Event,BX,BX.UI.EntitySelector,BX,BX.Main,BX.UI);
//# sourceMappingURL=editor.bundle.map.js