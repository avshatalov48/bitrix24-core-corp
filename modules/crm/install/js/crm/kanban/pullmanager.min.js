this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t){"use strict";var i=t.Reflection.namespace("BX.Crm.Kanban");var a=new WeakMap;var l=new WeakMap;var r=new WeakMap;var s=function(){function e(t){babelHelpers.classCallCheck(this,e);a.set(this,{writable:true,value:void 0});l.set(this,{writable:true,value:void 0});r.set(this,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,l,t);babelHelpers.classPrivateFieldSet(this,a,[]);babelHelpers.classPrivateFieldSet(this,r,false)}babelHelpers.createClass(e,[{key:"loadItem",value:function e(t){t=t||false;if(babelHelpers.classPrivateFieldGet(this,r)&&!t){return}var i=this.pop();if(i){babelHelpers.classPrivateFieldSet(this,r,true);babelHelpers.classPrivateFieldGet(this,l).loadNew(i,false,true).then(function(e){if(this.peek()){this.loadItem(true)}else{babelHelpers.classPrivateFieldSet(this,r,false)}}.bind(this))}}},{key:"push",value:function e(t){t=parseInt(t,10);var i=this.getAll().indexOf(t);if(i!==-1){this.splice(i)}babelHelpers.classPrivateFieldGet(this,a).push(t);return this}},{key:"pop",value:function e(){return babelHelpers.classPrivateFieldGet(this,a).shift()}},{key:"peek",value:function e(){return babelHelpers.classPrivateFieldGet(this,a).length?babelHelpers.classPrivateFieldGet(this,a)[0]:null}},{key:"getAll",value:function e(){return babelHelpers.classPrivateFieldGet(this,a)}},{key:"splice",value:function e(t){babelHelpers.classPrivateFieldGet(this,a).splice(t,1)}}]);return e}();var n=t.Reflection.namespace("BX.Crm.Kanban");var d=function(){function e(i){babelHelpers.classCallCheck(this,e);this.grid=i;this.queue=new s(this.grid);if(t.Type.isString(i.getData().moduleId)&&i.getData().userId>0){this.init()}}babelHelpers.createClass(e,[{key:"init",value:function e(){var i=this;t.Event.ready(function(){var e=BX.PULL;if(!e){console.error("pull is not initialized");return}e.subscribe({moduleId:i.grid.getData().moduleId,command:i.grid.getData().pullTag,callback:function e(a){if(t.Type.isString(a.eventName)){if(a.eventName==="ITEMUPDATED"){i.onPullItemUpdated(a)}else if(a.eventName==="ITEMADDED"){i.onPullItemAdded(a)}else if(a.eventName==="ITEMDELETED"){i.onPullItemDeleted(a)}else if(a.eventName==="STAGEADDED"){i.onPullStageAdded(a)}else if(a.eventName==="STAGEDELETED"){i.onPullStageDeleted(a)}else if(a.eventName==="STAGEUPDATED"){i.onPullStageUpdated(a)}}}});e.extendWatch(i.grid.getData().pullTag)})}},{key:"onPullItemUpdated",value:function e(t){if(this.updateItem(t)){this.queue.loadItem()}}},{key:"updateItem",value:function e(t){var i=this.grid.getItem(t.item.id);var a=t.item;if(i){var l=parseFloat(i.data.price);var r=i.data.columnId;for(var s in a.data){if(s in i.data){i.data[s]=a.data[s]}}i.rawData=a.rawData;i.setActivityExistInnerHtml();i.useAnimation=true;i.setChangedInPullRequest();this.grid.resetMultiSelectMode();i.preventNextFieldsRendering();this.grid.insertItem(i);var n=this.grid.getColumn(a.data.columnId);var d=parseFloat(a.data.price);if(r!==a.data.columnId){var u=this.grid.getColumn(r);u.decPrice(l);u.renderSubTitle();n.incPrice(d);n.renderSubTitle()}else{if(l<d){n.incPrice(d-l);n.renderSubTitle()}else if(l>d){n.decPrice(l-d);n.renderSubTitle()}}i.columnId=a.data.columnId;this.queue.push(i.id);return true}this.onPullItemAdded(t);return false}},{key:"onPullItemAdded",value:function e(t){this.addItem(t);this.queue.loadItem()}},{key:"addItem",value:function e(t){var i=this.grid.getItem(t.item.id);if(i){return}this.grid.addItemTop(t.item);this.queue.push(t.item.id)}},{key:"onPullItemDeleted",value:function e(i){if(!t.Type.isPlainObject(i.item)){return}this.grid.removeItem(i.item.id);var a=this.grid.getColumn(i.item.data.columnId);a.decPrice(i.item.data.price);a.renderSubTitle()}},{key:"onPullStageAdded",value:function e(t){this.grid.onApplyFilter()}},{key:"onPullStageDeleted",value:function e(t){this.grid.removeColumn(t.stage.id)}},{key:"onPullStageUpdated",value:function e(t){this.grid.onApplyFilter()}}]);return e}();n.PullManager=d;e.default=d})(this.BX.Crm.Kanban=this.BX.Crm.Kanban||{},BX);
//# sourceMappingURL=pullmanager.map.js