this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(t,e,i,n,a,r,s){"use strict";var l,o,d,c,u,p,h,f,m,v;var g="view";var b="edit";var I=function(){function t(e){var i,n;babelHelpers.classCallCheck(this,t);this.popup=null;this.fields=null;this.fieldsPopupItems=null;this.options=e;this.type=this.options.hasOwnProperty("type")?this.options.type:g;this.selectedFields=this.options.hasOwnProperty("selectedFields")?this.options.selectedFields.slice(0):[];this.enableHeadersSections=Boolean(this.options.headersSections);this.headersSections=(i=this.options.headersSections)!==null&&i!==void 0?i:{};this.defaultHeaderSectionId=(n=this.options.defaultHeaderSectionId)!==null&&n!==void 0?n:null;this.fieldVisibleClass="crm-kanban-popup-field-search-list-item-visible";this.fieldHiddenClass="crm-kanban-popup-field-search-list-item-hidden"}babelHelpers.createClass(t,[{key:"show",value:function t(){if(!this.popup){this.popup=this.createPopup()}if(this.fields){this.popup.setContent(this.getFieldsLayout())}else{this.loadPopupContent(this.popup)}this.popup.show()}},{key:"createPopup",value:function t(){var n=this;return i.PopupManager.create({id:"kanban_custom_fields_"+this.type,className:"crm-kanban-popup-field",titleBar:s.Loc.getMessage("CRM_KANBAN_CUSTOM_FIELDS_"+this.type.toUpperCase()),cacheable:false,closeIcon:true,lightShadow:true,overlay:true,draggable:true,closeByEsc:true,contentColor:"white",maxHeight:window.innerHeight-50,events:{onClose:function t(){n.fieldsPopupItems=null;n.popup=null}},buttons:[new BX.UI.SaveButton({color:BX.UI.Button.Color.PRIMARY,state:this.fields?"":BX.UI.Button.State.DISABLED,onclick:function t(){var i=n.fields?n.fields.filter((function(t){return n.selectedFields.indexOf(t.NAME)>=0})):[];if(i.length){n.popup.close();n.executeCallback(i)}else{e.UI.Notification.Center.notify({content:s.Loc.getMessage("CRM_KANBAN_POPUP_AT_LEAST_ONE_FIELD"),autoHide:true,autoHideDelay:2e3})}}}),new BX.UI.CancelButton({onclick:function t(){n.popup.close()}})]})}},{key:"loadPopupContent",value:function t(e){var i=this;var n=s.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['<div class="crm-kanban-popup-field-loader"></div>'])));var a=new BX.Loader({target:n,size:80});a.show();e.setContent(n);BX.ajax.runComponentAction("bitrix:crm.kanban","getFields",{mode:"ajax",data:{entityType:this.options.entityTypeName,viewType:this.type}}).then((function(t){a.destroy();i.fields=t.data;e.setContent(i.getFieldsLayout());e.getButtons().forEach((function(t){return t.setDisabled(false)}));e.adjustPosition()}))["catch"]((function(t){BX.Kanban.Utils.showErrorDialog(t.errors.pop().message)}));return e}},{key:"getFieldsLayout",value:function t(){var e=this;var i=this.distributeFieldsBySections(this.fields);var n=s.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['<div class="crm-kanban-popup-field"></div>'])));var a=s.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-kanban-popup-field-search-header-wrapper">\n\t\t\t\t<div class="ui-form-row-inline"></div>\n\t\t\t</div>\n\t\t'])));n.prepend(a);this.preparePopupContentHeaderSections(a);this.preparePopupContentHeaderSearch(a);this.getSections().map((function(t){var a=e.getSectionWrapperNameBySectionName(t.name);var r=s.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div \n\t\t\t\t\tclass="crm-kanban-popup-field-search-section" \n\t\t\t\t\tdata-crm-kanban-popup-field-search-section="','">\n\t\t\t\t</div>\n\t\t\t'])),a);s.Dom.append(r,n);var l=t.name;if(i.hasOwnProperty(l)&&i[l].length){s.Dom.append(s.Tag.render(u||(u=babelHelpers.taggedTemplateLiteral(['<div class="crm-kanban-popup-field-title">',"</div>"])),s.Text.encode(t.title)),r);s.Dom.append(s.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['<div class="crm-kanban-popup-field-wrapper">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>"])),i[l].map((function(i){var n=i.LABEL;if(!n.length&&t["elements"]&&t["elements"][i.NAME]&&t["elements"][i.NAME]["title"]&&t["elements"][i.NAME]["title"].length){n=t["elements"][i.NAME]["title"]}var a=s.Text.encode(n);return s.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t\t<div class="crm-kanban-popup-field-item" title="','">\n\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\tid="cf_','" \n\t\t\t\t\t\t\t\t\t\ttype="checkbox" \n\t\t\t\t\t\t\t\t\t\tname="','"\n\t\t\t\t\t\t\t\t\t\tclass="crm-kanban-popup-field-item-input"\n\t\t\t\t\t\t\t\t\t\tdata-label="','"\n\t\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t\t\tonclick="','"\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<label for="cf_','" class="crm-kanban-popup-field-item-label">\n\t\t\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t</div>"])),a,s.Text.encode(i.ID),s.Text.encode(i.NAME),a,e.selectedFields.indexOf(i.NAME)>=0?"checked":"",e.onFieldClick.bind(e),s.Text.encode(i.ID),a)}))),r)}}));return n}},{key:"preparePopupContentHeaderSections",value:function t(e){if(!this.enableHeadersSections){return}var i=s.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form-row">\n\t\t\t\t<div class="ui-form-content crm-kanban-popup-field-search-section-wrapper"></div>\n\t\t\t</div>\n\t\t'])));e.firstElementChild.appendChild(i);var n=this.getHeadersSections();for(var a in n){var r="crm-kanban-popup-field-search-section-item-icon"+(n[a].selected?" crm-kanban-popup-field-search-section-item-icon-active":"");var l=s.Tag.render(m||(m=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-kanban-popup-field-search-section-item" data-kanban-popup-filter-section-button="','">\n\t\t\t\t\t<div class="','">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"])),a,r,s.Text.encode(n[a].name));i.firstElementChild.appendChild(l);if(this.type!==g){break}s.Event.bind(l,"click",this.onFilterSectionClick.bind(this,l))}}},{key:"onFilterSectionClick",value:function t(e){var i="crm-kanban-popup-field-search-section-item-icon-active";var n=e.dataset.kanbanPopupFilterSectionButton;var a=document.querySelectorAll('[data-crm-kanban-popup-field-search-section="'.concat(n,'"]'));if(s.Dom.hasClass(e.firstElementChild,i)){s.Dom.removeClass(e.firstElementChild,i);this.filterSectionsToggle(a,"hide")}else{s.Dom.addClass(e.firstElementChild,i);this.filterSectionsToggle(a,"show")}}},{key:"filterSectionsToggle",value:function t(e,i){Array.from(e).map((function(t){i==="show"?s.Dom.show(t):s.Dom.hide(t)}))}},{key:"preparePopupContentHeaderSearch",value:function t(e){var i=s.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form-row">\n\t\t\t\t<div class="ui-form-content crm-kanban-popup-field-search-input-wrapper">\n\t\t\t\t\t<div class="ui-ctl ui-ctl-textbox ui-ctl-before-icon ui-ctl-after-icon">\n\t\t\t\t\t\t<div class="ui-ctl-before ui-ctl-icon-search"></div>\n\t\t\t\t\t\t<button class="ui-ctl-after ui-ctl-icon-clear"></button>\n\t\t\t\t\t\t<input type="text" class="ui-ctl-element crm-kanban-popup-field-search-section-input">\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])));e.firstElementChild.appendChild(i);var n=i.getElementsByClassName("crm-kanban-popup-field-search-section-input");if(n.length){var a=n[0];s.Event.bind(a,"input",this.onFilterSectionSearchInput.bind(this,a));s.Event.bind(a.previousElementSibling,"click",this.onFilterSectionSearchInputClear.bind(this,a))}}},{key:"onFilterSectionSearchInput",value:function t(e){var i=this;var n=e.value;if(n.length){n=n.toLowerCase()}this.getFieldsPopupItems().map((function(t){var e=t.innerText.toLowerCase();if(n.length&&e.indexOf(n)===-1){s.Dom.removeClass(t,i.fieldVisibleClass);s.Dom.addClass(t,i.fieldHiddenClass)}else{s.Dom.removeClass(t,i.fieldHiddenClass);s.Dom.addClass(t,i.fieldVisibleClass);t.style.display="block"}}))}},{key:"getFieldsPopupItems",value:function t(){if(!s.Type.isArray(this.fieldsPopupItems)){this.fieldsPopupItems=Array.from(this.popup.getPopupContainer().querySelectorAll(".crm-kanban-popup-field-item"));this.prepareAnimation()}return this.fieldsPopupItems}},{key:"prepareAnimation",value:function t(){var e=this;this.fieldsPopupItems.map((function(t){s.Event.bind(t,"animationend",e.onAnimationEnd.bind(e,t))}))}},{key:"onAnimationEnd",value:function t(e){e.style.display=s.Dom.hasClass(e,this.fieldHiddenClass)?"none":"block"}},{key:"onFilterSectionSearchInputClear",value:function t(e){if(e.value.length){e.value="";this.onFilterSectionSearchInput(e)}}},{key:"getSectionWrapperNameBySectionName",value:function t(e){var i=this.getHeadersSections();for(var n in i){if(this.headersSections[n].sections&&this.headersSections[n].sections.includes(e)){return this.headersSections[n].id}}return this.headersSections[this.defaultHeaderSectionId]&&this.defaultHeaderSectionId?this.headersSections[this.defaultHeaderSectionId].id:null}},{key:"getHeadersSections",value:function t(){var e;return(e=this.headersSections)!==null&&e!==void 0?e:{}}},{key:"distributeFieldsBySections",value:function t(e){var i=this.getIgnoredFields();e=e.filter((function(t){return!(i.hasOwnProperty(t.NAME)&&i[t.NAME])}));var n={};var a="";var r=this.options.hasOwnProperty("sections")?this.options.sections:[];for(var l=0;l<r.length;l++){var o=r[l];var d=o.name;n[d]=[];if(s.Type.isPlainObject(o.elements)){n[d]=this.filterFieldsByList(e,o.elements)}else if(o.hasOwnProperty("elementsRule")){n[d]=this.filterFieldsByRule(e,new RegExp(o.elementsRule))}else if(o.elements==="*"){a=d}}if(a!==""){n[a]=this.filterNotUsedFields(e,n)}return n}},{key:"filterFieldsByList",value:function t(e,i){return e.filter((function(t){return i.hasOwnProperty(t.NAME)}))}},{key:"filterFieldsByRule",value:function t(e,i){return e.filter((function(t){return t.NAME.match(i)}))}},{key:"filterNotUsedFields",value:function t(e,i){var n=Object.values(i).reduce((function(t,e){return t.concat(e.map((function(t){return t.NAME})))}),[]);return e.filter((function(t){return n.indexOf(t.NAME)<0}))}},{key:"getSections",value:function t(){return this.options.hasOwnProperty("sections")?this.options.sections:[]}},{key:"getIgnoredFields",value:function t(){var e=Object.assign({},this.options.ignoredFields);var i=[];if(this.type===b){i=["ID","CLOSED","DATE_CREATE","DATE_MODIFY","COMMENTS","OPPORTUNITY"]}else{i=["PHONE","EMAIL","WEB","IM"]}i.forEach((function(t){return e[t]=true}));return e}},{key:"executeCallback",value:function t(e){if(!this.options.hasOwnProperty("onSelect")||!s.Type.isFunction(this.options.onSelect)){return}var i={};e.forEach((function(t){i[t.NAME]=t.LABEL?t.LABEL:""}));this.options.onSelect(i)}},{key:"onFieldClick",value:function t(e){var i=e.target.name;if(e.target.checked&&this.selectedFields.indexOf(i)<0){this.selectedFields.push(i)}if(!e.target.checked&&this.selectedFields.indexOf(i)>=0){this.selectedFields.splice(this.selectedFields.indexOf(i),1)}}}]);return t}();var y=function(){babelHelpers.createClass(t,null,[{key:"createInstance",value:function e(i){return new t(i.grid).setItemId(i.itemId).setAction(i.action).setActionParams(i.actionParams)}}]);function t(e){babelHelpers.classCallCheck(this,t);this.grid=e}babelHelpers.createClass(t,[{key:"setItemId",value:function t(e){this.itemId=e;return this}},{key:"getItemId",value:function t(){return this.itemId}},{key:"setAction",value:function t(e){this.action=e;return this}},{key:"getAction",value:function t(){return this.action}},{key:"setActionParams",value:function t(e){this.actionParams=e;return this}},{key:"getActionParams",value:function t(){return this.actionParams}},{key:"execute",value:function t(){var e=this.getAction();if(e==="updateItem"){this.updateItem();return}if(e==="addItem"){this.addItem()}}},{key:"updateItem",value:function t(){var e=this.getActionParams();var i=this.grid.getItem(e.item.id);var n=e.item;if(!i){return}var a={};var r=n.data,l=r.lastActivity,o=r.columnId,d=r.price;if(s.Type.isObjectLike(l)&&l.timestamp!==i.data.lastActivity.timestamp){a.canShowLastActivitySortTour=true}var c=parseFloat(i.data.price);var u=i.columnId;for(var p in n.data){if(p in i.data){i.data[p]=n.data[p]}}i.rawData=n.rawData;i.setActivityExistInnerHtml();i.useAnimation=true;i.setChangedInPullRequest();this.grid.resetMultiSelectMode();var h=this.grid.getColumn(o);var f=parseFloat(d);a.newColumnId=o;this.grid.insertItem(i,a);i.columnId=o;if(!this.grid.getTypeInfoParam("showTotalPrice")){return}if(u===o){if(c<f){h.incPrice(f-c);h.renderSubTitle()}else if(c>f){h.decPrice(c-f);h.renderSubTitle()}return}var m=this.grid.getColumn(u);m.decPrice(c);m.renderSubTitle();if(h){h.incPrice(f);h.renderSubTitle()}}},{key:"addItem",value:function t(){var e=this.getActionParams();var i=this.grid.getItem(e.item.id);if(i){return}var n=this.grid.getColumn(e.item.data.columnId);if(!n){return}var a=r.Sorter.createWithCurrentSortType(n.getItems());var s=a.calcBeforeItemByParams(e.item.data.sort);if(s){e.item.targetId=s.getId()}this.grid.addItem(e.item)}}]);return t}();var S={MODE_STAGES:"STAGES",MODE_ACTIVITIES:"ACTIVITIES",getDefault:function t(){return this.MODE_STAGES},getAll:function t(){return[this.MODE_STAGES,this.MODE_ACTIVITIES]},normalize:function t(e){return this.getAll().includes(e)?e:this.getDefault()}};Object.freeze(S);function k(t,e){E(t,e);e.add(t)}function E(t,e){if(e.has(t)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function T(t,e,i){if(!e.has(t)){throw new TypeError("attempted to get private field on non-instance")}return i}var C={itemUpdated:"ITEMUPDATED",itemAdded:"ITEMADDED",itemDeleted:"ITEMDELETED",stageAdded:"STAGEADDED",stageUpdated:"STAGEUPDATED",stageDeleted:"STAGEDELETED"};var A=new WeakSet;var P=new WeakSet;var D=new WeakSet;var w=new WeakSet;var B=new WeakSet;var M=new WeakSet;var F=new WeakSet;var L=new WeakSet;var N=new WeakSet;var H=new WeakSet;var O=new WeakSet;var x=function t(e){var i=this;babelHelpers.classCallCheck(this,t);k(this,O);k(this,H);k(this,N);k(this,L);k(this,F);k(this,M);k(this,B);k(this,w);k(this,D);k(this,P);k(this,A);if(!BX.PULL){console.info("BX.PULL is not initialized");return}this.grid=e;var n=e.getData();var r={moduleId:n.moduleId,pullTag:n.pullTag,userId:n.userId,additionalData:{viewMode:n.viewMode},events:{onBeforePull:function t(e){T(i,w,W).call(i,e)},onPull:function t(e){T(i,B,R).call(i,e)}},callbacks:{onBeforeQueueExecute:function t(e){return T(i,A,_).call(i,e)},onQueueExecute:function t(e){return T(i,P,X).call(i,e)},onReload:function t(){T(i,D,U).call(i)}}};this.queueManager=new a.QueueManager(r)};function _(t){var e=this;t.forEach((function(t){var i=t.data;var n=y.createInstance({grid:e.grid,itemId:i.id,action:i.action,actionParams:i.actionParams});n.execute()}));return Promise.resolve()}function X(t){var e=[];t.forEach((function(t){var i=t.id,n=t.data.action;if(n==="addItem"||n==="updateItem"){e.push(parseInt(i,10))}}));if(e.length===0){return Promise.resolve()}return this.grid.loadNew(e,false,true,true,true)}function U(){this.grid.reload()}function W(t){var e=t.data,i=e.options,n=e.pullData;if(!n.command.startsWith(i.pullTag)&&i.additionalData.viewMode!==S.MODE_ACTIVITIES){t.preventDefault()}}function R(t){var e=t.data.pullData.params;if(e.eventName===C.itemUpdated){T(this,M,j).call(this,t);return}if(e.eventName===C.itemAdded){T(this,F,V).call(this,t);return}if(e.eventName===C.itemDeleted){T(this,N,G).call(this,t);return}if(e.eventName===C.stageAdded){T(this,H,K).call(this,t);return}if(e.eventName===C.stageUpdated){T(this,H,K).call(this,t);return}if(e.eventName===C.stageDeleted){T(this,O,z).call(this,t)}}function j(t){if(s.Type.isNil(t.data)){return}var e=t.data,i=e.pullData.params,n=e.promises;var a=this.grid.getItem(i.item.id);if(a){n.push(Promise.resolve({data:T(this,L,q).call(this,"updateItem",i)}));return}T(this,F,V).call(this,i);t.preventDefault()}function V(t){if(s.Type.isNil(t.data)){return}var e=t.data,i=e.pullData.params,n=e.promises;var a=i.item.id;var r=this.grid.getItem(a);if(r){t.preventDefault();return}n.push(Promise.resolve({data:T(this,L,q).call(this,"addItem",i)}))}function q(t,e){var i=e.item.id;return{id:i,action:t,actionParams:e}}function G(t){var e=this;var i=t.data.pullData.params;if(!s.Type.isPlainObject(i.item)){return}var n=i.item,a=n.id,r=n.data.columnId;var l=this.queueManager.hasInQueue(a)?this.queueManager.getLoadItemsDelay():0;setTimeout((function(){e.queueManager.deleteFromQueue(a);var t=e.grid;var i=t.getItem(a);if(!i){return}t.removeItem(a);if(t.getTypeInfoParam("showTotalPrice")){var n=t.getColumn(r);n.decPrice(i.data.price);n.renderSubTitle()}}),l);t.preventDefault()}function K(t){t.preventDefault();this.grid.onApplyFilter()}function z(t){t.preventDefault();var e=t.data.pullData.params;this.grid.removeColumn(e.stage.id)}t.PullManager=x;t.FieldsSelector=I;t.ViewMode=S})(this.BX.Crm.Kanban=this.BX.Crm.Kanban||{},BX,BX.Main,BX.Event,BX.Pull,BX.CRM.Kanban,BX);
//# sourceMappingURL=kanban.map.js