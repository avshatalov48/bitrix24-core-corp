this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,i,a,l){"use strict";var s=new WeakMap;var r=new WeakMap;var n=new WeakMap;var u=new WeakMap;var d=function(){function e(t){babelHelpers.classCallCheck(this,e);s.set(this,{writable:true,value:void 0});r.set(this,{writable:true,value:void 0});n.set(this,{writable:true,value:void 0});u.set(this,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,r,t);babelHelpers.classPrivateFieldSet(this,s,new Set);babelHelpers.classPrivateFieldSet(this,n,false);babelHelpers.classPrivateFieldSet(this,u,false)}babelHelpers.createClass(e,[{key:"loadItem",value:function e(t){var i=this;setTimeout(function(){t=t||false;if(babelHelpers.classPrivateFieldGet(i,n)&&!t){return}if(document.hidden||i.isOverflow()||i.isFreezed()){return}var e=i.pop();if(e){var a=function e(t){if(i.peek()){i.loadItem(true)}babelHelpers.classPrivateFieldSet(i,n,false)};var l=function e(t){};babelHelpers.classPrivateFieldSet(i,n,true);babelHelpers.classPrivateFieldGet(i,r).loadNew(e,false,true,true).then(a,l)}},1e3)}},{key:"push",value:function e(t){t=parseInt(t,10);if(babelHelpers.classPrivateFieldGet(this,s).has(t)){babelHelpers.classPrivateFieldGet(this,s).delete(t)}babelHelpers.classPrivateFieldGet(this,s).add(t);return this}},{key:"pop",value:function e(){var t=babelHelpers.classPrivateFieldGet(this,s).values();var i=t.next();if(i.value!==undefined){babelHelpers.classPrivateFieldGet(this,s).delete(i.value)}return i.value}},{key:"peek",value:function e(){var t=babelHelpers.classPrivateFieldGet(this,s).values();var i=t.next();return i.value!==undefined?i.value:null}},{key:"delete",value:function e(t){babelHelpers.classPrivateFieldGet(this,s).delete(t)}},{key:"has",value:function e(t){return babelHelpers.classPrivateFieldGet(this,s).has(t)}},{key:"clear",value:function e(){babelHelpers.classPrivateFieldGet(this,s).clear()}},{key:"isOverflow",value:function e(){var t=10;return babelHelpers.classPrivateFieldGet(this,s).size>t}},{key:"freeze",value:function e(){babelHelpers.classPrivateFieldSet(this,u,true)}},{key:"unfreeze",value:function e(){babelHelpers.classPrivateFieldSet(this,u,false)}},{key:"isFreezed",value:function e(){return babelHelpers.classPrivateFieldGet(this,u)}}]);return e}();var o=function(){function e(t){babelHelpers.classCallCheck(this,e);this.grid=t;this.queue=new d(this.grid);if(l.Type.isString(t.getData().moduleId)&&t.getData().userId>0){this.init()}this.bindEvents()}babelHelpers.createClass(e,[{key:"init",value:function e(){var t=this;l.Event.ready(function(){var e=BX.PULL;if(!e){console.error("pull is not initialized");return}e.subscribe({moduleId:t.grid.getData().moduleId,command:t.grid.getData().pullTag,callback:function e(i){if(l.Type.isString(i.eventName)){if(t.queue.isOverflow()){return}if(i.eventName==="ITEMUPDATED"){t.onPullItemUpdated(i)}else if(i.eventName==="ITEMADDED"){t.onPullItemAdded(i)}else if(i.eventName==="ITEMDELETED"){t.onPullItemDeleted(i)}else if(i.eventName==="STAGEADDED"){t.onPullStageAdded(i)}else if(i.eventName==="STAGEDELETED"){t.onPullStageDeleted(i)}else if(i.eventName==="STAGEUPDATED"){t.onPullStageUpdated(i)}}}});e.extendWatch(t.grid.getData().pullTag);l.Event.bind(document,"visibilitychange",function(){if(!document.hidden){t.onTabActivated()}})})}},{key:"onPullItemUpdated",value:function e(t){if(this.updateItem(t)){this.queue.loadItem()}}},{key:"updateItem",value:function e(t){var i=this.grid.getItem(t.item.id);var a=t.item;if(i){var l=parseFloat(i.data.price);var s=i.data.columnId;for(var r in a.data){if(r in i.data){i.data[r]=a.data[r]}}i.rawData=a.rawData;i.setActivityExistInnerHtml();i.useAnimation=true;i.setChangedInPullRequest();this.grid.resetMultiSelectMode();this.grid.insertItem(i);var n=this.grid.getColumn(a.data.columnId);var u=parseFloat(a.data.price);if(s!==a.data.columnId){var d=this.grid.getColumn(s);d.decPrice(l);d.renderSubTitle();n.incPrice(u);n.renderSubTitle()}else{if(l<u){n.incPrice(u-l);n.renderSubTitle()}else if(l>u){n.decPrice(l-u);n.renderSubTitle()}}i.columnId=a.data.columnId;this.queue.push(i.id);return true}this.onPullItemAdded(t);return false}},{key:"onPullItemAdded",value:function e(t){this.addItem(t);this.queue.loadItem()}},{key:"addItem",value:function e(t){var i=this.grid.getItem(t.item.id);if(i){return}this.grid.addItemTop(t.item);this.queue.push(t.item.id)}},{key:"onPullItemDeleted",value:function e(t){var i=this;if(!l.Type.isPlainObject(t.item)){return}var a=this.queue.has(t.item.id)?5e3:0;setTimeout(function(){i.queue.delete(t.item.id);i.grid.removeItem(t.item.id);var e=i.grid.getColumn(t.item.data.columnId);e.decPrice(t.item.data.price);e.renderSubTitle()},a)}},{key:"onPullStageAdded",value:function e(t){this.grid.onApplyFilter()}},{key:"onPullStageDeleted",value:function e(t){this.grid.removeColumn(t.stage.id)}},{key:"onPullStageUpdated",value:function e(t){this.grid.onApplyFilter()}},{key:"onTabActivated",value:function e(){if(this.queue.isOverflow()){this.showOutdatedDataDialog()}else if(this.queue.peek()){this.queue.loadItem()}}},{key:"showOutdatedDataDialog",value:function e(){var t=this;if(!this.notifier){this.notifier=BX.UI.Notification.Center.notify({content:l.Loc.getMessage("CRM_KANBAN_NOTIFY_OUTDATED_DATA"),closeButton:false,autoHide:false,actions:[{title:l.Loc.getMessage("CRM_KANBAN_GRID_RELOAD"),events:{click:function e(i,a,l){a.close();t.grid.reload();t.queue.clear()}}}]})}else{this.notifier.show()}}},{key:"bindEvents",value:function e(){var i=this;t.EventEmitter.subscribe("SidePanel.Slider:onOpen",function(e){if(i.isEntitySlider(e.data[0].slider)){i.queue.freeze()}});t.EventEmitter.subscribe("SidePanel.Slider:onClose",function(e){if(i.isEntitySlider(e.data[0].slider)){i.queue.unfreeze();i.onTabActivated()}})}},{key:"isEntitySlider",value:function e(t){var i=t.getUrl();var a=this.grid.getData().entityPath;var l=a.replace(/\#([^\#]+)\#/,"([\\d]+)");return new RegExp(l).test(i)}}]);return e}();e.PullManager=o})(this.BX.Crm.Kanban=this.BX.Crm.Kanban||{},BX.Event,BX,BX.Main,BX);
//# sourceMappingURL=kanban.map.js