this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,i,a,n){"use strict";var l=new WeakMap;var s=new WeakMap;var r=new WeakMap;var u=new WeakMap;var o=function(){function e(t){babelHelpers.classCallCheck(this,e);l.set(this,{writable:true,value:void 0});s.set(this,{writable:true,value:void 0});r.set(this,{writable:true,value:void 0});u.set(this,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,s,t);babelHelpers.classPrivateFieldSet(this,l,new Set);babelHelpers.classPrivateFieldSet(this,r,false);babelHelpers.classPrivateFieldSet(this,u,false)}babelHelpers.createClass(e,[{key:"loadItem",value:function e(t){var i=this;setTimeout(function(){t=t||false;if(babelHelpers.classPrivateFieldGet(i,r)&&!t){return}if(document.hidden||i.isOverflow()||i.isFreezed()){return}var e=i.pop();if(e){var a=function e(t){if(i.peek()){i.loadItem(true)}babelHelpers.classPrivateFieldSet(i,r,false)};var n=function e(t){};babelHelpers.classPrivateFieldSet(i,r,true);babelHelpers.classPrivateFieldGet(i,s).loadNew(e,false,true,true).then(a,n)}},1e3)}},{key:"push",value:function e(t){t=parseInt(t,10);if(babelHelpers.classPrivateFieldGet(this,l).has(t)){babelHelpers.classPrivateFieldGet(this,l).delete(t)}babelHelpers.classPrivateFieldGet(this,l).add(t);return this}},{key:"pop",value:function e(){var t=babelHelpers.classPrivateFieldGet(this,l).values();var i=t.next();if(i.value!==undefined){babelHelpers.classPrivateFieldGet(this,l).delete(i.value)}return i.value}},{key:"peek",value:function e(){var t=babelHelpers.classPrivateFieldGet(this,l).values();var i=t.next();return i.value!==undefined?i.value:null}},{key:"delete",value:function e(t){babelHelpers.classPrivateFieldGet(this,l).delete(t)}},{key:"has",value:function e(t){return babelHelpers.classPrivateFieldGet(this,l).has(t)}},{key:"clear",value:function e(){babelHelpers.classPrivateFieldGet(this,l).clear()}},{key:"isOverflow",value:function e(){var t=10;return babelHelpers.classPrivateFieldGet(this,l).size>t}},{key:"freeze",value:function e(){babelHelpers.classPrivateFieldSet(this,u,true)}},{key:"unfreeze",value:function e(){babelHelpers.classPrivateFieldSet(this,u,false)}},{key:"isFreezed",value:function e(){return babelHelpers.classPrivateFieldGet(this,u)}}]);return e}();var d=function(){function e(t){babelHelpers.classCallCheck(this,e);this.grid=t;this.queue=new o(this.grid);if(n.Type.isString(t.getData().moduleId)&&t.getData().userId>0){this.init()}this.bindEvents()}babelHelpers.createClass(e,[{key:"init",value:function e(){var t=this;n.Event.ready(function(){var e=BX.PULL;if(!e){console.error("pull is not initialized");return}e.subscribe({moduleId:t.grid.getData().moduleId,command:t.grid.getData().pullTag,callback:function e(i){if(n.Type.isString(i.eventName)){if(t.queue.isOverflow()){return}if(i.eventName==="ITEMUPDATED"){t.onPullItemUpdated(i)}else if(i.eventName==="ITEMADDED"){t.onPullItemAdded(i)}else if(i.eventName==="ITEMDELETED"){t.onPullItemDeleted(i)}else if(i.eventName==="STAGEADDED"){t.onPullStageAdded(i)}else if(i.eventName==="STAGEDELETED"){t.onPullStageDeleted(i)}else if(i.eventName==="STAGEUPDATED"){t.onPullStageUpdated(i)}}}});e.extendWatch(t.grid.getData().pullTag);n.Event.bind(document,"visibilitychange",function(){if(!document.hidden){t.onTabActivated()}})})}},{key:"onPullItemUpdated",value:function e(t){if(this.updateItem(t)){this.queue.loadItem()}}},{key:"updateItem",value:function e(t){var i=this.grid.getItem(t.item.id);var a=t.item;if(i){var n=parseFloat(i.data.price);var l=i.data.columnId;for(var s in a.data){if(s in i.data){i.data[s]=a.data[s]}}i.rawData=a.rawData;i.setActivityExistInnerHtml();i.useAnimation=true;i.setChangedInPullRequest();this.grid.resetMultiSelectMode();this.grid.insertItem(i);var r=this.grid.getColumn(a.data.columnId);var u=parseFloat(a.data.price);if(l!==a.data.columnId){var o=this.grid.getColumn(l);o.decPrice(n);o.renderSubTitle();r.incPrice(u);r.renderSubTitle()}else{if(n<u){r.incPrice(u-n);r.renderSubTitle()}else if(n>u){r.decPrice(n-u);r.renderSubTitle()}}i.columnId=a.data.columnId;this.queue.push(i.id);return true}this.onPullItemAdded(t);return false}},{key:"onPullItemAdded",value:function e(t){this.addItem(t);this.queue.loadItem()}},{key:"addItem",value:function e(t){var i=this.grid.getItem(t.item.id);if(i){return}this.grid.addItemTop(t.item);this.queue.push(t.item.id)}},{key:"onPullItemDeleted",value:function e(t){if(!n.Type.isPlainObject(t.item)){return}var i=this.queue.has(t.item.id)?5e3:0;setTimeout(function(){this.queue.delete(t.item.id);this.grid.removeItem(t.item.id);var e=this.grid.getColumn(t.item.data.columnId);e.decPrice(t.item.data.price);e.renderSubTitle()}.bind(this),i)}},{key:"onPullStageAdded",value:function e(t){this.grid.onApplyFilter()}},{key:"onPullStageDeleted",value:function e(t){this.grid.removeColumn(t.stage.id)}},{key:"onPullStageUpdated",value:function e(t){this.grid.onApplyFilter()}},{key:"onTabActivated",value:function e(){if(this.queue.isOverflow()){this.showOutdatedDataDialog()}else if(this.queue.peek()){this.queue.loadItem()}}},{key:"showOutdatedDataDialog",value:function e(){var t=this;if(!this.notifier){this.notifier=BX.UI.Notification.Center.notify({content:n.Loc.getMessage("CRM_KANBAN_NOTIFY_OUTDATED_DATA"),closeButton:false,autoHide:false,actions:[{title:n.Loc.getMessage("CRM_KANBAN_GRID_RELOAD"),events:{click:function e(i,a,n){a.close();t.grid.reload();t.queue.clear()}}}]})}else{this.notifier.show()}}},{key:"bindEvents",value:function e(){var i=this;t.EventEmitter.subscribe("SidePanel.Slider:onOpen",function(e){if(i.isEntitySlider(e.data[0].slider)){i.queue.freeze()}});t.EventEmitter.subscribe("SidePanel.Slider:onClose",function(e){if(i.isEntitySlider(e.data[0].slider)){i.queue.unfreeze();i.onTabActivated()}})}},{key:"isEntitySlider",value:function e(t){var i=t.getUrl();var a=this.grid.getData().entityPath;var n=a.replace(/\#([^\#]+)\#/,"([\\d]+)");return new RegExp(n).test(i)}}]);return e}();var c,p,f,v,h;var b="view";var m="edit";var g=function(){function e(t){babelHelpers.classCallCheck(this,e);this.popup=null;this.fields=null;this.options=t;this.type=this.options.hasOwnProperty("type")?this.options.type:b;this.selectedFields=this.options.hasOwnProperty("selectedFields")?this.options.selectedFields.slice(0):[]}babelHelpers.createClass(e,[{key:"show",value:function e(){if(!this.popup){this.popup=this.createPopup()}if(this.fields){this.popup.setContent(this.getFieldsLayout())}else{this.loadPopupContent(this.popup)}this.popup.show()}},{key:"createPopup",value:function e(){var t=this;return a.PopupManager.create({id:"kanban_custom_fields_"+this.type,className:"crm-kanban-popup-field",titleBar:BX.message("CRM_KANBAN_CUSTOM_FIELDS_"+this.type.toUpperCase()),cacheable:false,closeIcon:true,lightShadow:true,overlay:true,draggable:true,closeByEsc:true,contentColor:"white",maxHeight:window.innerHeight-50,events:{onClose:function e(){return t.popup=null}},buttons:[new BX.UI.SaveButton({color:BX.UI.Button.Color.PRIMARY,state:this.fields?"":BX.UI.Button.State.DISABLED,onclick:function e(){var a=t.fields?t.fields.filter(function(e){return t.selectedFields.indexOf(e.NAME)>=0}):[];if(a.length){t.popup.close();t.executeCallback(a)}else{i.UI.Notification.Center.notify({content:n.Loc.getMessage("CRM_KANBAN_POPUP_AT_LEAST_ONE_FIELD"),autoHide:true,autoHideDelay:2e3})}}}),new BX.UI.CancelButton({onclick:function e(){t.popup.close()}})]})}},{key:"loadPopupContent",value:function e(t){var i=this;var a=n.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['<div class="crm-kanban-popup-field-loader"></div>'])));var l=new BX.Loader({target:a,size:80});l.show();t.setContent(a);BX.ajax.runComponentAction("bitrix:crm.kanban","getFields",{mode:"ajax",data:{entityType:this.options.entityTypeName,viewType:this.type}}).then(function(e){l.destroy();i.fields=e.data;t.setContent(i.getFieldsLayout());t.getButtons().forEach(function(e){return e.setDisabled(false)});t.adjustPosition()}).catch(function(e){BX.Kanban.Utils.showErrorDialog(e.errors.pop().message)});return t}},{key:"getFieldsLayout",value:function e(){var t=this;var i=this.distributeFieldsBySections(this.fields);var a=n.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['<div class="crm-kanban-popup-field"></div>'])));this.getSections().forEach(function(e){var l=e.name;if(i.hasOwnProperty(l)&&i[l].length){n.Dom.append(n.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['<div class="crm-kanban-popup-field-title">',"</div>"])),n.Text.encode(e.title)),a);n.Dom.append(n.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['<div class="crm-kanban-popup-field-wrapper">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>"])),i[l].map(function(i){var a=i.LABEL;if(!a.length&&e["elements"]&&e["elements"][i.NAME]&&e["elements"][i.NAME]["title"]&&e["elements"][i.NAME]["title"].length){a=e["elements"][i.NAME]["title"]}var l=n.Text.encode(a);return n.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t\t<div class="crm-kanban-popup-field-item" title="','">\n\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\tid="cf_','" \n\t\t\t\t\t\t\t\t\t\ttype="checkbox" \n\t\t\t\t\t\t\t\t\t\tname="','"\n\t\t\t\t\t\t\t\t\t\tclass="crm-kanban-popup-field-item-input"\n\t\t\t\t\t\t\t\t\t\tdata-label="','"\n\t\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t\t\tonclick="','"\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<label for="cf_','" class="crm-kanban-popup-field-item-label">\n\t\t\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t</div>"])),l,n.Text.encode(i.ID),n.Text.encode(i.NAME),l,t.selectedFields.indexOf(i.NAME)>=0?"checked":"",t.onFieldClick.bind(t),n.Text.encode(i.ID),l)})),a)}});return a}},{key:"distributeFieldsBySections",value:function e(t){var i=this.getIgnoredFields();t=t.filter(function(e){return!(i.hasOwnProperty(e.NAME)&&i[e.NAME])});var a={};var l="";var s=this.options.hasOwnProperty("sections")?this.options.sections:[];for(var r=0;r<s.length;r++){var u=s[r];var o=u.name;a[o]=[];if(n.Type.isPlainObject(u.elements)){a[o]=this.filterFieldsByList(t,u.elements)}else if(u.hasOwnProperty("elementsRule")){a[o]=this.filterFieldsByRule(t,new RegExp(u.elementsRule))}else if(u.elements==="*"){l=o}}if(l!==""){a[l]=this.filterNotUsedFields(t,a)}return a}},{key:"filterFieldsByList",value:function e(t,i){return t.filter(function(e){return i.hasOwnProperty(e.NAME)})}},{key:"filterFieldsByRule",value:function e(t,i){return t.filter(function(e){return e.NAME.match(i)})}},{key:"filterNotUsedFields",value:function e(t,i){var a=Object.values(i).reduce(function(e,t){return e.concat(t.map(function(e){return e.NAME}))},[]);return t.filter(function(e){return a.indexOf(e.NAME)<0})}},{key:"getSections",value:function e(){return this.options.hasOwnProperty("sections")?this.options.sections:[]}},{key:"getIgnoredFields",value:function e(){var t=Object.assign({},this.options.ignoredFields);var i=[];if(this.type===m){i=["ID","CLOSED","CLOSEDATE","DATE_CREATE","DATE_MODIFY","COMMENTS","OPPORTUNITY"]}else{i=["PHONE","EMAIL","WEB","IM"]}i.forEach(function(e){return t[e]=true});return t}},{key:"executeCallback",value:function e(t){if(!this.options.hasOwnProperty("onSelect")||!n.Type.isFunction(this.options.onSelect)){return}var i={};t.forEach(function(e){i[e.NAME]=e.LABEL?e.LABEL:""});this.options.onSelect(i)}},{key:"onFieldClick",value:function e(t){var i=t.target.name;if(t.target.checked&&this.selectedFields.indexOf(i)<0){this.selectedFields.push(i)}if(!t.target.checked&&this.selectedFields.indexOf(i)>=0){this.selectedFields.splice(this.selectedFields.indexOf(i),1)}}}]);return e}();e.PullManager=d;e.FieldsSelector=g})(this.BX.Crm.Kanban=this.BX.Crm.Kanban||{},BX.Event,BX,BX.Main,BX);
//# sourceMappingURL=kanban.map.js