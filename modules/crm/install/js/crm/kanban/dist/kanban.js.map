{"version":3,"file":"kanban.js","sources":["../src/fieldsselector.js","../src/pulloperation.js","../src/viewmode.js","../src/pullmanager.js"],"sourcesContent":["import {UI} from 'ui.notification';\nimport {PopupManager} from \"main.popup\";\nimport {Dom, Event, Loc, Tag, Text, Type} from \"main.core\";\n\ntype FieldsSelectorOptions = {\n\ttype: string,\n\tentityTypeName: string,\n\tsections: Array,\n\tselectedFields: Array,\n\tignoredFields: Object,\n\theadersSections: Object,\n\tdefaultHeaderSectionId: ?string,\n\tonSelect?: Function\n}\n\nconst TYPE_VIEW = 'view';\nconst TYPE_EDIT = 'edit';\n\nexport default class FieldsSelector\n{\n\tconstructor(options: FieldsSelectorOptions)\n\t{\n\t\tthis.popup = null;\n\t\tthis.fields = null;\n\t\tthis.fieldsPopupItems = null;\n\t\tthis.options = options;\n\t\tthis.type =\n\t\t\tthis.options.hasOwnProperty('type')\n\t\t\t\t? this.options.type\n\t\t\t\t: TYPE_VIEW\n\t\t;\n\n\t\tthis.selectedFields =\n\t\t\tthis.options.hasOwnProperty('selectedFields')\n\t\t\t\t? this.options.selectedFields.slice(0)\n\t\t\t\t: []\n\t\t;\n\n\t\tthis.enableHeadersSections = Boolean(this.options.headersSections);\n\t\tthis.headersSections = (this.options.headersSections ?? {});\n\t\tthis.defaultHeaderSectionId = (this.options.defaultHeaderSectionId ?? null);\n\n\t\tthis.fieldVisibleClass = 'crm-kanban-popup-field-search-list-item-visible';\n\t\tthis.fieldHiddenClass = 'crm-kanban-popup-field-search-list-item-hidden';\n\t}\n\n\tshow()\n\t{\n\t\tif (!this.popup)\n\t\t{\n\t\t\tthis.popup = this.createPopup();\n\t\t}\n\t\tif (this.fields)\n\t\t{\n\t\t\tthis.popup.setContent(this.getFieldsLayout());\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.loadPopupContent(this.popup);\n\t\t}\n\t\tthis.popup.show();\n\t}\n\n\tcreatePopup()\n\t{\n\t\treturn PopupManager.create({\n\t\t\tid: 'kanban_custom_fields_' + this.type,\n\t\t\tclassName: 'crm-kanban-popup-field',\n\t\t\ttitleBar: Loc.getMessage('CRM_KANBAN_CUSTOM_FIELDS_' + this.type.toUpperCase()),\n\t\t\tcacheable: false,\n\t\t\tcloseIcon: true,\n\t\t\tlightShadow: true,\n\t\t\toverlay: true,\n\t\t\tdraggable: true,\n\t\t\tcloseByEsc: true,\n\t\t\tcontentColor: 'white',\n\t\t\tmaxHeight: window.innerHeight - 50,\n\t\t\tevents: {\n\t\t\t\tonClose: () => {\n\t\t\t\t\tthis.fieldsPopupItems = null;\n\t\t\t\t\tthis.popup = null;\n\t\t\t\t}\n\t\t\t},\n\t\t\tbuttons: [\n\t\t\t\tnew BX.UI.SaveButton({\n\t\t\t\t\tcolor: BX.UI.Button.Color.PRIMARY,\n\t\t\t\t\tstate: this.fields ? '' : BX.UI.Button.State.DISABLED,\n\t\t\t\t\tonclick: () =>\n\t\t\t\t\t{\n\t\t\t\t\t\tconst selectedFields =\n\t\t\t\t\t\t\tthis.fields\n\t\t\t\t\t\t\t\t? this.fields.filter(field => this.selectedFields.indexOf(field.NAME) >= 0)\n\t\t\t\t\t\t\t\t: []\n\t\t\t\t\t\t;\n\t\t\t\t\t\tif (selectedFields.length)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.popup.close();\n\t\t\t\t\t\t\tthis.executeCallback(selectedFields);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tUI.Notification.Center.notify({\n\t\t\t\t\t\t\t\tcontent: Loc.getMessage('CRM_KANBAN_POPUP_AT_LEAST_ONE_FIELD'),\n\t\t\t\t\t\t\t\tautoHide: true,\n\t\t\t\t\t\t\t\tautoHideDelay: 2000,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}),\n\t\t\t\tnew BX.UI.CancelButton({\n\t\t\t\t\tonclick: () =>\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.popup.close();\n\t\t\t\t\t}\n\t\t\t\t}),\n\t\t\t]\n\t\t});\n\t}\n\n\tloadPopupContent(popup: Popup)\n\t{\n\t\tconst loaderContainer = Tag.render`<div class=\"crm-kanban-popup-field-loader\"></div>`;\n\n\t\tconst loader = new BX.Loader({\n\t\t\ttarget: loaderContainer,\n\t\t\tsize: 80\n\t\t});\n\t\tloader.show();\n\n\t\tpopup.setContent(loaderContainer);\n\n\t\tBX.ajax.runComponentAction(\n\t\t\t'bitrix:crm.kanban',\n\t\t\t'getFields',\n\t\t\t{\n\t\t\t\tmode: 'ajax',\n\t\t\t\tdata: {\n\t\t\t\t\tentityType: this.options.entityTypeName,\n\t\t\t\t\tviewType: this.type,\n\t\t\t\t}\n\t\t\t}\n\t\t)\n\t\t\t.then(\n\t\t\t\t(response) =>\n\t\t\t\t{\n\t\t\t\t\tloader.destroy();\n\n\t\t\t\t\tthis.fields = response.data;\n\t\t\t\t\tpopup.setContent(this.getFieldsLayout());\n\t\t\t\t\tpopup.getButtons().forEach(button => button.setDisabled(false));\n\t\t\t\t\tpopup.adjustPosition();\n\t\t\t\t}\n\t\t\t)\n\t\t\t.catch(\n\t\t\t\t(response) =>\n\t\t\t\t{\n\t\t\t\t\tBX.Kanban.Utils.showErrorDialog(response.errors.pop().message);\n\t\t\t\t}\n\t\t\t);\n\n\t\treturn popup;\n\t}\n\n\tgetFieldsLayout()\n\t{\n\t\tconst sectionsWithFields = this.distributeFieldsBySections(this.fields);\n\n\t\tconst container = Tag.render`<div class=\"crm-kanban-popup-field\"></div>`;\n\n\t\tconst headerWrapper = Tag.render`\n\t\t\t<div class=\"crm-kanban-popup-field-search-header-wrapper\">\n\t\t\t\t<div class=\"ui-form-row-inline\"></div>\n\t\t\t</div>\n\t\t`;\n\n\t\tcontainer.prepend(headerWrapper);\n\n\t\tthis.preparePopupContentHeaderSections(headerWrapper);\n\t\tthis.preparePopupContentHeaderSearch(headerWrapper);\n\n\t\tthis.getSections().map(section => {\n\t\t\tconst sectionWrapperId = this.getSectionWrapperNameBySectionName(section.name);\n\t\t\tconst sectionWrapper = Tag.render`\n\t\t\t\t<div \n\t\t\t\t\tclass=\"crm-kanban-popup-field-search-section\" \n\t\t\t\t\tdata-crm-kanban-popup-field-search-section=\"${sectionWrapperId}\">\n\t\t\t\t</div>\n\t\t\t`;\n\t\t\tDom.append(sectionWrapper, container);\n\n\t\t\tconst sectionName = section.name;\n\t\t\tif (sectionsWithFields.hasOwnProperty(sectionName) && sectionsWithFields[sectionName].length)\n\t\t\t{\n\t\t\t\tDom.append(\n\t\t\t\t\tTag.render`<div class=\"crm-kanban-popup-field-title\">${Text.encode(section.title)}</div>`,\n\t\t\t\t\tsectionWrapper\n\t\t\t\t);\n\t\t\t\tDom.append(\n\t\t\t\t\tTag.render`<div class=\"crm-kanban-popup-field-wrapper\">\n\t\t\t\t\t\t${sectionsWithFields[sectionName].map(\n\t\t\t\t\t\t(field) =>\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet label = field.LABEL;\n\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t!label.length\n\t\t\t\t\t\t\t\t&& section['elements']\n\t\t\t\t\t\t\t\t&& section['elements'][field.NAME]\n\t\t\t\t\t\t\t\t&& section['elements'][field.NAME]['title']\n\t\t\t\t\t\t\t\t&& section['elements'][field.NAME]['title'].length\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlabel = section['elements'][field.NAME]['title'];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tconst encodedLabel = Text.encode(label);\n\n\t\t\t\t\t\t\treturn Tag.render`\n\t\t\t\t\t\t\t\t<div class=\"crm-kanban-popup-field-item\" title=\"${encodedLabel}\">\n\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\tid=\"cf_${Text.encode(field.ID)}\" \n\t\t\t\t\t\t\t\t\t\ttype=\"checkbox\" \n\t\t\t\t\t\t\t\t\t\tname=\"${Text.encode(field.NAME)}\"\n\t\t\t\t\t\t\t\t\t\tclass=\"crm-kanban-popup-field-item-input\"\n\t\t\t\t\t\t\t\t\t\tdata-label=\"${encodedLabel}\"\n\t\t\t\t\t\t\t\t\t\t${this.selectedFields.indexOf(field.NAME) >= 0 ? 'checked' : ''}\n\t\t\t\t\t\t\t\t\t\tonclick=\"${this.onFieldClick.bind(this)}\"\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<label for=\"cf_${Text.encode(field.ID)}\" class=\"crm-kanban-popup-field-item-label\">\n\t\t\t\t\t\t\t\t\t\t${encodedLabel}\n\t\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t</div>`;\n\t\t\t\t\t\t}\n\t\t\t\t\t)}\n\t\t\t\t\t</div>`,\n\t\t\t\t\tsectionWrapper\n\t\t\t\t);\n\t\t\t}\n\t\t});\n\n\t\treturn container;\n\t}\n\n\tpreparePopupContentHeaderSections(headerWrapper: HTMLElement): void\n\t{\n\t\tif (!this.enableHeadersSections)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst headerSectionsWrapper = Tag.render`\n\t\t\t<div class=\"ui-form-row\">\n\t\t\t\t<div class=\"ui-form-content crm-kanban-popup-field-search-section-wrapper\"></div>\n\t\t\t</div>\n\t\t`;\n\n\t\theaderWrapper.firstElementChild.appendChild(headerSectionsWrapper);\n\n\t\tconst headersSections = this.getHeadersSections();\n\n\t\tfor (let key in headersSections)\n\t\t{\n\t\t\tconst itemClass = 'crm-kanban-popup-field-search-section-item-icon'\n\t\t\t\t+ (headersSections[key].selected ? ` crm-kanban-popup-field-search-section-item-icon-active` : '');\n\n\t\t\tconst headerSectionItem = Tag.render`\n\t\t\t\t<div class=\"crm-kanban-popup-field-search-section-item\" data-kanban-popup-filter-section-button=\"${key}\">\n\t\t\t\t\t<div class=\"${itemClass}\">\n\t\t\t\t\t\t${Text.encode(headersSections[key].name)}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`;\n\n\t\t\theaderSectionsWrapper.firstElementChild.appendChild(headerSectionItem);\n\n\t\t\tif (this.type !== TYPE_VIEW)\n\t\t\t{\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tEvent.bind(headerSectionItem, 'click', this.onFilterSectionClick.bind(this, headerSectionItem));\n\t\t}\n\t}\n\n\tonFilterSectionClick(item: HTMLElement): void\n\t{\n\t\tconst activeClass = 'crm-kanban-popup-field-search-section-item-icon-active';\n\t\tconst sectionId = item.dataset.kanbanPopupFilterSectionButton;\n\t\tconst sections = document.querySelectorAll(\n\t\t\t`[data-crm-kanban-popup-field-search-section=\"${sectionId}\"]`\n\t\t);\n\t\tif (Dom.hasClass(item.firstElementChild, activeClass))\n\t\t{\n\t\t\tDom.removeClass(item.firstElementChild, activeClass);\n\t\t\tthis.filterSectionsToggle(sections, 'hide');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.addClass(item.firstElementChild, activeClass);\n\t\t\tthis.filterSectionsToggle(sections, 'show');\n\t\t}\n\t}\n\n\tfilterSectionsToggle(sections: NodeList, action: string): void\n\t{\n\t\tArray.from(sections).map(section => {\n\t\t\t(action === 'show' ? Dom.show(section) : Dom.hide(section));\n\t\t});\n\t}\n\n\tpreparePopupContentHeaderSearch(headerWrapper: HTMLElement): void\n\t{\n\t\tconst searchForm = Tag.render`\n\t\t\t<div class=\"ui-form-row\">\n\t\t\t\t<div class=\"ui-form-content crm-kanban-popup-field-search-input-wrapper\">\n\t\t\t\t\t<div class=\"ui-ctl ui-ctl-textbox ui-ctl-before-icon ui-ctl-after-icon\">\n\t\t\t\t\t\t<div class=\"ui-ctl-before ui-ctl-icon-search\"></div>\n\t\t\t\t\t\t<button class=\"ui-ctl-after ui-ctl-icon-clear\"></button>\n\t\t\t\t\t\t<input type=\"text\" class=\"ui-ctl-element crm-kanban-popup-field-search-section-input\">\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\theaderWrapper.firstElementChild.appendChild(searchForm);\n\t\tconst inputs = searchForm.getElementsByClassName('crm-kanban-popup-field-search-section-input');\n\t\tif (inputs.length)\n\t\t{\n\t\t\tconst input = inputs[0];\n\t\t\tEvent.bind(input, 'input', this.onFilterSectionSearchInput.bind(this, input));\n\t\t\tEvent.bind(input.previousElementSibling, 'click', this.onFilterSectionSearchInputClear.bind(this, input));\n\t\t}\n\t}\n\n\tonFilterSectionSearchInput(input: HTMLElement): void\n\t{\n\t\tlet search = input.value;\n\t\tif (search.length)\n\t\t{\n\t\t\tsearch = search.toLowerCase();\n\t\t}\n\n\t\tthis.getFieldsPopupItems().map(item => {\n\t\t\tconst title = item.innerText.toLowerCase();\n\n\t\t\tif (search.length && title.indexOf(search) === -1)\n\t\t\t{\n\t\t\t\tDom.removeClass(item, this.fieldVisibleClass);\n\t\t\t\tDom.addClass(item, this.fieldHiddenClass);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tDom.removeClass(item, this.fieldHiddenClass);\n\t\t\t\tDom.addClass(item, this.fieldVisibleClass);\n\t\t\t\titem.style.display = 'block';\n\t\t\t}\n\t\t});\n\t}\n\n\tgetFieldsPopupItems(): ?HTMLElement[]\n\t{\n\t\tif (!Type.isArray(this.fieldsPopupItems))\n\t\t{\n\t\t\tthis.fieldsPopupItems = Array.from(\n\t\t\t\tthis.popup.getPopupContainer().querySelectorAll('.crm-kanban-popup-field-item')\n\t\t\t);\n\t\t\tthis.prepareAnimation();\n\t\t}\n\n\t\treturn this.fieldsPopupItems;\n\t}\n\n\tprepareAnimation(): void\n\t{\n\t\tthis.fieldsPopupItems.map(item => {\n\t\t\tEvent.bind(item, 'animationend', this.onAnimationEnd.bind(this, item));\n\t\t});\n\t}\n\n\tonAnimationEnd(item: HTMLElement): void\n\t{\n\t\titem.style.display = (\n\t\t\tDom.hasClass(item, this.fieldHiddenClass)\n\t\t\t\t? 'none'\n\t\t\t\t: 'block'\n\t\t);\n\t}\n\n\tonFilterSectionSearchInputClear(input: HTMLElement): void\n\t{\n\t\tif (input.value.length)\n\t\t{\n\t\t\tinput.value = '';\n\t\t\tthis.onFilterSectionSearchInput(input);\n\t\t}\n\t}\n\n\tgetSectionWrapperNameBySectionName(name: string): ?string\n\t{\n\t\tconst headerSections = this.getHeadersSections();\n\t\tfor (let id in headerSections)\n\t\t{\n\t\t\tif (this.headersSections[id].sections && this.headersSections[id].sections.includes(name))\n\t\t\t{\n\t\t\t\treturn this.headersSections[id].id;\n\t\t\t}\n\t\t}\n\n\t\treturn (\n\t\t\t(this.headersSections[this.defaultHeaderSectionId] && this.defaultHeaderSectionId)\n\t\t\t\t? this.headersSections[this.defaultHeaderSectionId].id\n\t\t\t\t: null\n\t\t);\n\t}\n\n\tgetHeadersSections(): Object\n\t{\n\t\treturn (this.headersSections ?? {});\n\t}\n\n\tdistributeFieldsBySections(fields: Array)\n\t{\n\t\t// remove ignored fields from result:\n\t\tconst ignoredFields = this.getIgnoredFields();\n\t\tfields = fields.filter(item => !(ignoredFields.hasOwnProperty(item.NAME) && ignoredFields[item.NAME]));\n\n\t\tlet fieldsBySections = {};\n\t\tlet defaultSectionName = '';\n\t\tconst sections = this.options.hasOwnProperty('sections') ? this.options.sections : [];\n\t\tfor (let i = 0; i < sections.length; i++)\n\t\t{\n\t\t\tconst section = sections[i];\n\t\t\tconst sectionName = section.name;\n\t\t\tfieldsBySections[sectionName] = [];\n\t\t\tif (Type.isPlainObject(section.elements))\n\t\t\t{\n\t\t\t\tfieldsBySections[sectionName] = this.filterFieldsByList(fields, section.elements);\n\t\t\t}\n\t\t\telse if (section.hasOwnProperty('elementsRule'))\n\t\t\t{\n\t\t\t\tfieldsBySections[sectionName] = this.filterFieldsByRule(fields, new RegExp(section.elementsRule));\n\t\t\t}\n\t\t\telse if (section.elements === '*')\n\t\t\t{\n\t\t\t\tdefaultSectionName = sectionName;\n\t\t\t}\n\t\t}\n\t\tif (defaultSectionName !== '')\n\t\t{\n\t\t\tfieldsBySections[defaultSectionName] = this.filterNotUsedFields(fields, fieldsBySections);\n\t\t}\n\n\t\treturn fieldsBySections;\n\t}\n\n\tfilterFieldsByList(fields: Array, whiteList: Object): Array\n\t{\n\t\treturn fields.filter((item) => whiteList.hasOwnProperty(item.NAME));\n\t}\n\n\tfilterFieldsByRule(fields: Array, rule: RegExp): Array\n\t{\n\t\treturn fields.filter((item) => item.NAME.match(rule));\n\t}\n\n\tfilterNotUsedFields(fields: Array, alreadyUsedFieldsBySection: Object): Array\n\t{\n\t\tlet alreadyUsedFieldsNames = Object.values(alreadyUsedFieldsBySection).reduce(\n\t\t\t(prevFields, sectionFields) =>\n\t\t\t{\n\t\t\t\treturn prevFields.concat(sectionFields.map((item) => item.NAME))\n\t\t\t},\n\t\t\t[]\n\t\t);\n\n\t\treturn fields.filter(item => alreadyUsedFieldsNames.indexOf(item.NAME) < 0);\n\t}\n\n\tgetSections(): Array\n\t{\n\t\treturn this.options.hasOwnProperty('sections') ? this.options.sections : [];\n\t}\n\n\tgetIgnoredFields()\n\t{\n\t\tlet fields = Object.assign({}, this.options.ignoredFields);\n\t\tlet extraFields = [];\n\t\tif (this.type === TYPE_EDIT)\n\t\t{\n\t\t\textraFields = [\n\t\t\t\t'ID',\n\t\t\t\t'CLOSED',\n\t\t\t\t'DATE_CREATE',\n\t\t\t\t'DATE_MODIFY',\n\t\t\t\t'COMMENTS',\n\t\t\t\t'OPPORTUNITY',\n\t\t\t]\n\t\t}\n\t\telse\n\t\t{\n\t\t\textraFields = [\n\t\t\t\t'PHONE',\n\t\t\t\t'EMAIL',\n\t\t\t\t'WEB',\n\t\t\t\t'IM',\n\t\t\t]\n\t\t}\n\t\textraFields.forEach((fieldName => (fields[fieldName] = true)));\n\n\t\treturn fields;\n\t}\n\n\texecuteCallback(selectedFields: Array)\n\t{\n\t\tif (!this.options.hasOwnProperty('onSelect') || !Type.isFunction(this.options.onSelect))\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tlet callbackPayload = {};\n\t\tselectedFields.forEach(\n\t\t\t(field) =>\n\t\t\t{\n\t\t\t\tcallbackPayload[field.NAME] =\n\t\t\t\t\tfield.LABEL\n\t\t\t\t\t\t? field.LABEL\n\t\t\t\t\t\t: ''\n\t\t\t\t;\n\t\t\t}\n\t\t);\n\t\tthis.options.onSelect(callbackPayload);\n\t}\n\n\tonFieldClick(event)\n\t{\n\t\tconst fieldName = event.target.name;\n\t\tif (event.target.checked && this.selectedFields.indexOf(fieldName) < 0)\n\t\t{\n\t\t\tthis.selectedFields.push(fieldName);\n\t\t}\n\t\tif (!event.target.checked && this.selectedFields.indexOf(fieldName) >= 0)\n\t\t{\n\t\t\tthis.selectedFields.splice(this.selectedFields.indexOf(fieldName), 1);\n\t\t}\n\t}\n}\n","import { Sorter } from 'crm.kanban.sort';\nimport { Type } from 'main.core';\n\nexport default class PullOperation\n{\n\tgrid: BX.CRM.Kanban.Grid;\n\titemId: Number;\n\taction: String;\n\tactionParams: Object;\n\n\tstatic createInstance(data: Object): PullOperation\n\t{\n\t\treturn (new PullOperation(data.grid))\n\t\t\t.setItemId(data.itemId)\n\t\t\t.setAction(data.action)\n\t\t\t.setActionParams(data.actionParams)\n\t\t;\n\t}\n\n\tconstructor(grid: BX.CRM.Kanban.Grid): void\n\t{\n\t\tthis.grid = grid;\n\t}\n\n\tsetItemId(itemId: Number): PullOperation\n\t{\n\t\tthis.itemId = itemId;\n\n\t\treturn this;\n\t}\n\n\tgetItemId(): Number\n\t{\n\t\treturn this.itemId;\n\t}\n\n\tsetAction(action: String): PullOperation\n\t{\n\t\tthis.action = action;\n\n\t\treturn this;\n\t}\n\n\tgetAction(): String\n\t{\n\t\treturn this.action;\n\t}\n\n\tsetActionParams(actionParams: Object): PullOperation\n\t{\n\t\tthis.actionParams = actionParams;\n\n\t\treturn this;\n\t}\n\n\tgetActionParams(): Object\n\t{\n\t\treturn this.actionParams;\n\t}\n\n\texecute(): void\n\t{\n\t\tconst action = this.getAction();\n\n\t\tif (action === 'updateItem')\n\t\t{\n\t\t\tthis.updateItem();\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (action === 'addItem')\n\t\t{\n\t\t\tthis.addItem();\n\t\t}\n\t}\n\n\tupdateItem(): void\n\t{\n\t\tconst params = this.getActionParams();\n\t\tconst item = this.grid.getItem(params.item.id);\n\t\tconst paramsItem = params.item;\n\n\t\tif (!item)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst insertItemParams = {};\n\t\tconst { lastActivity, columnId: newColumnId, price } = paramsItem.data;\n\t\tif (Type.isObjectLike(lastActivity) && lastActivity.timestamp !== item.data.lastActivity.timestamp)\n\t\t{\n\t\t\tinsertItemParams.canShowLastActivitySortTour = true;\n\t\t}\n\n\t\tconst oldPrice = parseFloat(item.data.price);\n\t\tconst oldColumnId = item.columnId;\n\n\t\tfor (const key in paramsItem.data)\n\t\t{\n\t\t\tif (key in item.data)\n\t\t\t{\n\t\t\t\titem.data[key] = paramsItem.data[key];\n\t\t\t}\n\t\t}\n\n\t\titem.rawData = paramsItem.rawData;\n\t\titem.setActivityExistInnerHtml();\n\t\titem.useAnimation = true;\n\t\titem.setChangedInPullRequest();\n\n\t\tthis.grid.resetMultiSelectMode();\n\n\t\tconst newColumn = this.grid.getColumn(newColumnId);\n\t\tconst newPrice = parseFloat(price);\n\n\t\tinsertItemParams.newColumnId = newColumnId;\n\t\tthis.grid.insertItem(item, insertItemParams);\n\n\t\titem.columnId = newColumnId;\n\n\t\tif (!this.grid.getTypeInfoParam('showTotalPrice'))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (oldColumnId === newColumnId)\n\t\t{\n\t\t\tif (oldPrice < newPrice)\n\t\t\t{\n\t\t\t\tnewColumn.incPrice(newPrice - oldPrice);\n\t\t\t\tnewColumn.renderSubTitle();\n\t\t\t}\n\t\t\telse if (oldPrice > newPrice)\n\t\t\t{\n\t\t\t\tnewColumn.decPrice(oldPrice - newPrice);\n\t\t\t\tnewColumn.renderSubTitle();\n\t\t\t}\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst oldColumn = this.grid.getColumn(oldColumnId);\n\t\toldColumn.decPrice(oldPrice);\n\t\toldColumn.renderSubTitle();\n\t\tif (newColumn)\n\t\t{\n\t\t\tnewColumn.incPrice(newPrice);\n\t\t\tnewColumn.renderSubTitle();\n\t\t}\n\t}\n\n\taddItem(): void\n\t{\n\t\tconst params = this.getActionParams();\n\t\tconst oldItem = this.grid.getItem(params.item.id);\n\t\tif (oldItem)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst column = this.grid.getColumn(params.item.data.columnId);\n\t\tif (!column)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst sorter = Sorter.createWithCurrentSortType(column.getItems());\n\n\t\tconst beforeItem = sorter.calcBeforeItemByParams(params.item.data.sort);\n\t\tif (beforeItem)\n\t\t{\n\t\t\tparams.item.targetId = beforeItem.getId();\n\t\t}\n\n\t\tthis.grid.addItem(params.item);\n\t}\n}\n","const ViewMode = {\n\tMODE_STAGES: 'STAGES',\n\tMODE_ACTIVITIES: 'ACTIVITIES',\n\n\tgetDefault(): string\n\t{\n\t\treturn this.MODE_STAGES;\n\t},\n\n\tgetAll(): string[]\n\t{\n\t\treturn [\n\t\t\tthis.MODE_STAGES,\n\t\t\tthis.MODE_ACTIVITIES,\n\t\t];\n\t},\n\n\tnormalize(mode: string): string\n\t{\n\t\treturn this.getAll().includes(mode) ? mode : this.getDefault();\n\t},\n};\n\nObject.freeze(ViewMode);\n\nexport {\n\tViewMode,\n};\n","import { Type } from 'main.core';\nimport { BaseEvent } from 'main.core.events';\nimport type { ActionItem } from 'pull.queuemanager';\nimport { QueueManager } from 'pull.queuemanager';\nimport PullOperation from './pulloperation';\nimport { ViewMode } from './viewmode';\n\nconst EventName = {\n\titemUpdated: 'ITEMUPDATED',\n\titemAdded: 'ITEMADDED',\n\titemDeleted: 'ITEMDELETED',\n\tstageAdded: 'STAGEADDED',\n\tstageUpdated: 'STAGEUPDATED',\n\tstageDeleted: 'STAGEDELETED',\n};\n\nexport default class PullManager\n{\n\tqueueManager: QueueManager;\n\tgrid: BX.CRM.Kanban.Grid;\n\n\tconstructor(grid: BX.CRM.Kanban.Grid)\n\t{\n\t\tif (!BX.PULL)\n\t\t{\n\t\t\tconsole.info('BX.PULL is not initialized');\n\n\t\t\treturn;\n\t\t}\n\n\t\tthis.grid = grid;\n\n\t\tconst data = grid.getData();\n\t\tconst options = {\n\t\t\tmoduleId: data.moduleId,\n\t\t\tpullTag: data.pullTag,\n\t\t\tuserId: data.userId,\n\t\t\tadditionalData: {\n\t\t\t\tviewMode: data.viewMode,\n\t\t\t},\n\t\t\tevents: {\n\t\t\t\tonBeforePull: (event) => {\n\t\t\t\t\tthis.#onBeforePull(event);\n\t\t\t\t},\n\t\t\t\tonPull: (event) => {\n\t\t\t\t\tthis.#onPull(event);\n\t\t\t\t},\n\t\t\t},\n\t\t\tcallbacks: {\n\t\t\t\tonBeforeQueueExecute: (items) => {\n\t\t\t\t\treturn this.#onBeforeQueueExecute(items);\n\t\t\t\t},\n\t\t\t\tonQueueExecute: (items) => {\n\t\t\t\t\treturn this.#onQueueExecute(items);\n\t\t\t\t},\n\t\t\t\tonReload: () => {\n\t\t\t\t\tthis.#onReload();\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\n\t\tthis.queueManager = new QueueManager(options);\n\t}\n\n\t#onBeforeQueueExecute(items: Object[]): Promise\n\t{\n\t\titems.forEach((item) => {\n\t\t\tconst { data } = item;\n\n\t\t\tconst operation = PullOperation.createInstance({\n\t\t\t\tgrid: this.grid,\n\t\t\t\titemId: data.id,\n\t\t\t\taction: data.action,\n\t\t\t\tactionParams: data.actionParams,\n\t\t\t});\n\n\t\t\toperation.execute(); // change to async and use Promise.all in return\n\t\t});\n\n\t\treturn Promise.resolve();\n\t}\n\n\t#onQueueExecute(items: Object[]): Promise\n\t{\n\t\tconst ids = [];\n\t\titems.forEach(({ id, data: { action } }) => {\n\t\t\tif (action === 'addItem' || action === 'updateItem')\n\t\t\t{\n\t\t\t\tids.push(parseInt(id, 10));\n\t\t\t}\n\t\t});\n\n\t\tif (ids.length === 0)\n\t\t{\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\treturn this.grid.loadNew(ids, false, true, true, true);\n\t}\n\n\t#onReload(): void\n\t{\n\t\tthis.grid.reload();\n\t}\n\n\t#onBeforePull(event: BaseEvent): void\n\t{\n\t\tconst { data: { options, pullData } } = event;\n\t\tif (\n\t\t\t!pullData.command.startsWith(options.pullTag)\n\t\t\t&& options.additionalData.viewMode !== ViewMode.MODE_ACTIVITIES\n\t\t)\n\t\t{\n\t\t\tevent.preventDefault();\n\t\t}\n\t}\n\n\t#onPull(event: BaseEvent): void\n\t{\n\t\tconst { pullData: { params } } = event.data;\n\n\t\tif (params.eventName === EventName.itemUpdated)\n\t\t{\n\t\t\tthis.#onPullItemUpdated(event);\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (params.eventName === EventName.itemAdded)\n\t\t{\n\t\t\tthis.#onPullItemAdded(event);\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (params.eventName === EventName.itemDeleted)\n\t\t{\n\t\t\tthis.#onPullItemDeleted(event);\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (params.eventName === EventName.stageAdded)\n\t\t{\n\t\t\tthis.#onPullStageChanged(event);\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (params.eventName === EventName.stageUpdated)\n\t\t{\n\t\t\tthis.#onPullStageChanged(event);\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (params.eventName === EventName.stageDeleted)\n\t\t{\n\t\t\tthis.#onPullStageDeleted(event);\n\t\t}\n\t}\n\n\t#onPullItemUpdated(event: BaseEvent): void\n\t{\n\t\tif (Type.isNil(event.data))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst { pullData: { params }, promises } = event.data;\n\n\t\tconst item = this.grid.getItem(params.item.id);\n\n\t\tif (item)\n\t\t{\n\t\t\tpromises.push(Promise.resolve({\n\t\t\t\tdata: this.#getPullData('updateItem', params),\n\t\t\t}));\n\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#onPullItemAdded(params);\n\n\t\tevent.preventDefault();\n\t}\n\n\t#onPullItemAdded(event: BaseEvent): void\n\t{\n\t\tif (Type.isNil(event.data))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst { pullData: { params }, promises } = event.data;\n\n\t\tconst itemId = params.item.id;\n\t\tconst oldItem = this.grid.getItem(itemId);\n\n\t\tif (oldItem)\n\t\t{\n\t\t\tevent.preventDefault();\n\n\t\t\treturn;\n\t\t}\n\n\t\tpromises.push(Promise.resolve({\n\t\t\tdata: this.#getPullData('addItem', params),\n\t\t}));\n\t}\n\n\t#getPullData(action: string, actionParams: Object): ActionItem\n\t{\n\t\tconst { id } = actionParams.item;\n\n\t\treturn {\n\t\t\tid,\n\t\t\taction,\n\t\t\tactionParams,\n\t\t};\n\t}\n\n\t#onPullItemDeleted(event: BaseEvent): void\n\t{\n\t\tconst { pullData: { params } } = event.data;\n\n\t\tif (!Type.isPlainObject(params.item))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst { id, data: { columnId } } = params.item;\n\n\t\t/**\n\t\t * Delay so that the element has time to be rendered before deletion,\n\t\t * if an event for changing the element came before. Ticket #141983\n\t\t */\n\t\tconst delay = (\n\t\t\tthis.queueManager.hasInQueue(id)\n\t\t\t\t? this.queueManager.getLoadItemsDelay()\n\t\t\t\t: 0\n\t\t);\n\n\t\tsetTimeout(() => {\n\t\t\tthis.queueManager.deleteFromQueue(id);\n\n\t\t\tconst { grid } = this;\n\t\t\tconst item = grid.getItem(id);\n\t\t\tif (!item)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tgrid.removeItem(id);\n\n\t\t\tif (grid.getTypeInfoParam('showTotalPrice'))\n\t\t\t{\n\t\t\t\tconst column = grid.getColumn(columnId);\n\t\t\t\tcolumn.decPrice(item.data.price);\n\t\t\t\tcolumn.renderSubTitle();\n\t\t\t}\n\t\t}, delay);\n\n\t\tevent.preventDefault();\n\t}\n\n\t#onPullStageChanged(event: BaseEvent): void\n\t{\n\t\tevent.preventDefault();\n\n\t\tthis.grid.onApplyFilter();\n\t}\n\n\t#onPullStageDeleted(event: BaseEvent): void\n\t{\n\t\tevent.preventDefault();\n\n\t\tconst { pullData: { params } } = event.data;\n\t\tthis.grid.removeColumn(params.stage.id);\n\t}\n}\n"],"names":["TYPE_VIEW","TYPE_EDIT","FieldsSelector","options","popup","fields","fieldsPopupItems","type","hasOwnProperty","selectedFields","slice","enableHeadersSections","Boolean","headersSections","defaultHeaderSectionId","fieldVisibleClass","fieldHiddenClass","createPopup","setContent","getFieldsLayout","loadPopupContent","show","PopupManager","create","id","className","titleBar","Loc","getMessage","toUpperCase","cacheable","closeIcon","lightShadow","overlay","draggable","closeByEsc","contentColor","maxHeight","window","innerHeight","events","onClose","buttons","BX","UI","SaveButton","color","Button","Color","PRIMARY","state","State","DISABLED","onclick","filter","field","indexOf","NAME","length","close","executeCallback","Notification","Center","notify","content","autoHide","autoHideDelay","CancelButton","loaderContainer","Tag","render","loader","Loader","target","size","ajax","runComponentAction","mode","data","entityType","entityTypeName","viewType","then","response","destroy","getButtons","forEach","button","setDisabled","adjustPosition","Kanban","Utils","showErrorDialog","errors","pop","message","sectionsWithFields","distributeFieldsBySections","container","headerWrapper","prepend","preparePopupContentHeaderSections","preparePopupContentHeaderSearch","getSections","map","section","sectionWrapperId","getSectionWrapperNameBySectionName","name","sectionWrapper","Dom","append","sectionName","Text","encode","title","label","LABEL","encodedLabel","ID","onFieldClick","bind","headerSectionsWrapper","firstElementChild","appendChild","getHeadersSections","key","itemClass","selected","headerSectionItem","Event","onFilterSectionClick","item","activeClass","sectionId","dataset","kanbanPopupFilterSectionButton","sections","document","querySelectorAll","hasClass","removeClass","filterSectionsToggle","addClass","action","Array","from","hide","searchForm","inputs","getElementsByClassName","input","onFilterSectionSearchInput","previousElementSibling","onFilterSectionSearchInputClear","search","value","toLowerCase","getFieldsPopupItems","innerText","style","display","Type","isArray","getPopupContainer","prepareAnimation","onAnimationEnd","headerSections","includes","ignoredFields","getIgnoredFields","fieldsBySections","defaultSectionName","i","isPlainObject","elements","filterFieldsByList","filterFieldsByRule","RegExp","elementsRule","filterNotUsedFields","whiteList","rule","match","alreadyUsedFieldsBySection","alreadyUsedFieldsNames","Object","values","reduce","prevFields","sectionFields","concat","assign","extraFields","fieldName","isFunction","onSelect","callbackPayload","event","checked","push","splice","PullOperation","grid","setItemId","itemId","setAction","setActionParams","actionParams","getAction","updateItem","addItem","params","getActionParams","getItem","paramsItem","insertItemParams","lastActivity","newColumnId","columnId","price","isObjectLike","timestamp","canShowLastActivitySortTour","oldPrice","parseFloat","oldColumnId","rawData","setActivityExistInnerHtml","useAnimation","setChangedInPullRequest","resetMultiSelectMode","newColumn","getColumn","newPrice","insertItem","getTypeInfoParam","incPrice","renderSubTitle","decPrice","oldColumn","oldItem","column","sorter","Sorter","createWithCurrentSortType","getItems","beforeItem","calcBeforeItemByParams","sort","targetId","getId","ViewMode","MODE_STAGES","MODE_ACTIVITIES","getDefault","getAll","normalize","freeze","EventName","itemUpdated","itemAdded","itemDeleted","stageAdded","stageUpdated","stageDeleted","PullManager","PULL","console","info","getData","moduleId","pullTag","userId","additionalData","viewMode","onBeforePull","onPull","callbacks","onBeforeQueueExecute","items","onQueueExecute","onReload","queueManager","QueueManager","operation","createInstance","execute","Promise","resolve","ids","parseInt","loadNew","reload","pullData","command","startsWith","preventDefault","eventName","isNil","promises","delay","hasInQueue","getLoadItemsDelay","setTimeout","deleteFromQueue","removeItem","onApplyFilter","removeColumn","stage"],"mappings":"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"}