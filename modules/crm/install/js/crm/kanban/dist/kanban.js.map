{"version":3,"file":"kanban.js","sources":["../src/pulloperation.js","../src/pullqueue.js","../src/pullmanager.js","../src/fieldsselector.js"],"sourcesContent":["import { Sorter } from \"crm.kanban.sort\";\n\nexport default class PullOperation\n{\n\tgrid: BX.CRM.Kanban.Grid;\n\titemId: Number;\n\taction: String;\n\tactionParams: Object;\n\n\tstatic createInstance(data: Object): PullOperation\n\t{\n\t\tconst instance = new PullOperation(data.grid);\n\n\t\tinstance.setItemId(data.itemId);\n\t\tinstance.setAction(data.action);\n\t\tinstance.setActionParams(data.actionParams);\n\n\t\treturn instance;\n\t}\n\n\tconstructor(grid: BX.CRM.Kanban.Grid): void\n\t{\n\t\tthis.grid = grid;\n\t}\n\n\tsetItemId(itemId: Number): PullOperation\n\t{\n\t\tthis.itemId = itemId;\n\t\treturn this;\n\t}\n\n\tgetItemId(): Number\n\t{\n\t\treturn this.itemId;\n\t}\n\n\tsetAction(action: String): PullOperation\n\t{\n\t\tthis.action = action;\n\t\treturn this;\n\t}\n\n\tgetAction(): String\n\t{\n\t\treturn this.action;\n\t}\n\n\tsetActionParams(actionParams: Object): PullOperation\n\t{\n\t\tthis.actionParams = actionParams;\n\t\treturn this;\n\t}\n\n\tgetActionParams(): Object\n\t{\n\t\treturn this.actionParams;\n\t}\n\n\texecute(): void\n\t{\n\t\tif (this.getAction() === 'updateItem')\n\t\t{\n\t\t\treturn this.updateItem();\n\t\t}\n\n\t\tif (this.getAction() === 'addItem')\n\t\t{\n\t\t\treturn this.addItem();\n\t\t}\n\t}\n\n\tupdateItem(): void\n\t{\n\t\tconst params = this.getActionParams();\n\t\tconst item = this.grid.getItem(params.item.id);\n\t\tconst paramsItem = params.item;\n\n\t\tif (!item)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst oldPrice = parseFloat(item.data.price);\n\t\tconst oldColumnId = item.columnId;\n\n\t\tfor (let key in paramsItem.data)\n\t\t{\n\t\t\tif (key in item.data)\n\t\t\t{\n\t\t\t\titem.data[key] = paramsItem.data[key];\n\t\t\t}\n\t\t}\n\n\t\titem.rawData = paramsItem.rawData;\n\t\titem.setActivityExistInnerHtml();\n\t\titem.useAnimation = true;\n\t\titem.setChangedInPullRequest();\n\n\t\tthis.grid.resetMultiSelectMode();\n\t\tthis.grid.insertItem(item);\n\n\t\tconst newColumnId = paramsItem.data.columnId;\n\t\tconst newColumn = this.grid.getColumn(newColumnId);\n\t\tconst newPrice = parseFloat(paramsItem.data.price);\n\n\t\titem.columnId = newColumnId;\n\n\t\tif (oldColumnId !== newColumnId)\n\t\t{\n\t\t\tconst oldColumn = this.grid.getColumn(oldColumnId);\n\t\t\toldColumn.decPrice(oldPrice);\n\t\t\toldColumn.renderSubTitle();\n\t\t\tif (newColumn)\n\t\t\t{\n\t\t\t\tnewColumn.incPrice(newPrice);\n\t\t\t\tnewColumn.renderSubTitle();\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif (oldPrice < newPrice)\n\t\t\t{\n\t\t\t\tnewColumn.incPrice(newPrice - oldPrice);\n\t\t\t\tnewColumn.renderSubTitle();\n\t\t\t}\n\t\t\telse if (oldPrice > newPrice)\n\t\t\t{\n\t\t\t\tnewColumn.decPrice(oldPrice - newPrice);\n\t\t\t\tnewColumn.renderSubTitle();\n\t\t\t}\n\t\t}\n\t}\n\n\taddItem(): void\n\t{\n\t\tconst params = this.getActionParams();\n\t\tconst oldItem = this.grid.getItem(params.item.id);\n\t\tif (oldItem)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst column = this.grid.getColumn(params.item.data.columnId);\n\t\tif (!column)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst sorter = Sorter.createWithCurrentSortType(column.getItems());\n\n\t\tconst beforeItem = sorter.calcBeforeItemByParams(params.item.data.sort);\n\t\tif (beforeItem)\n\t\t{\n\t\t\tparams.item.targetId = beforeItem.getId();\n\t\t}\n\n\t\tthis.grid.addItem(params.item);\n\t}\n}\n","import PullOperation from \"./pulloperation\";\n\n/**\n * @class PullQueue\n */\n\nexport default class PullQueue\n{\n\t#queue: Map<number>;\n\t#grid: BX.CRM.Kanban.Grid;\n\t#isProgress: boolean;\n\t#isFreeze: boolean;\n\tloadItemsTimer;\n\n\tconstructor(grid: BX.CRM.Kanban.Grid): void\n\t{\n\t\tthis.#grid = grid;\n\t\tthis.#queue = new Map();\n\t\tthis.#isProgress = false;\n\t\tthis.#isFreeze = false;\n\t\tthis.loadItemsTimer = null;\n\t}\n\n\tloadItem(isForce: boolean): void\n\t{\n\t\tif (this.loadItemsTimer)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.loadItemsTimer = setTimeout(\n\t\t\t() => {\n\t\t\t\tisForce = (isForce || false);\n\t\t\t\tif (this.#isProgress && !isForce)\n\t\t\t\t{\n\t\t\t\t\tthis.loadItemsTimer = null;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (document.hidden || this.isOverflow() || this.isFreezed())\n\t\t\t\t{\n\t\t\t\t\tthis.loadItemsTimer = null;\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst items = this.popAllAsArray();\n\t\t\t\tif (items.length)\n\t\t\t\t{\n\t\t\t\t\tconst ids = [];\n\t\t\t\t\titems.map(item => {\n\t\t\t\t\t\tids.push(item.id);\n\t\t\t\t\t\tconst data = item.data;\n\t\t\t\t\t\tconst operation = PullOperation.createInstance({\n\t\t\t\t\t\t\tgrid: this.#grid,\n\t\t\t\t\t\t\titemId: data.id,\n\t\t\t\t\t\t\taction: data.action,\n\t\t\t\t\t\t\tactionParams: data.actionParams,\n\t\t\t\t\t\t});\n\t\t\t\t\t\toperation.execute();\n\t\t\t\t\t});\n\n\t\t\t\t\tconst loadNextOnSuccess = () => {\n\t\t\t\t\t\tthis.loadItemsTimer = null;\n\t\t\t\t\t\tif (this.peek())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.loadItem(true);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis.#isProgress = false;\n\t\t\t\t\t};\n\t\t\t\t\tconst doNothingOnError = () => {\n\t\t\t\t\t\tthis.loadItemsTimer = null;\n\t\t\t\t\t};\n\n\t\t\t\t\tthis.#isProgress = true;\n\t\t\t\t\tthis.\n\t\t\t\t\t\t#grid\n\t\t\t\t\t\t.loadNew(ids, false, true, true)\n\t\t\t\t\t\t.then(loadNextOnSuccess, doNothingOnError)\n\t\t\t\t\t;\n\t\t\t\t}\n\t\t\t},\n\t\t\t5000\n\t\t);\n\t}\n\n\tpush(id: number, item: string): PullQueue\n\t{\n\t\tid = parseInt(id, 10);\n\t\tif (this.has(id))\n\t\t{\n\t\t\tthis.delete(id);\n\t\t}\n\n\t\tthis.#queue.set(id, item);\n\t\treturn this;\n\t}\n\n\tpopAllAsArray()\n\t{\n\t\tconst items = Array.from(this.#queue, ([id, data]) => ({id, data}));\n\t\tthis.#queue.clear();\n\t\treturn items;\n\t}\n\n\tpopBatch(count: number)\n\t{\n\t\tif (count <= 0)\n\t\t{\n\t\t\treturn [];\n\t\t}\n\n\t\tconst results = [];\n\t\tfor (let i=0; i < count; i++)\n\t\t{\n\t\t\tconst item = this.pop();\n\n\t\t\tif (!item)\n\t\t\t{\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tresults.push(item);\n\t\t}\n\n\t\treturn results;\n\t}\n\n\tpop(): number\n\t{\n\t\tconst items = this.#queue.entries();\n\t\tconst first = items.next();\n\t\tif (first.value)\n\t\t{\n\t\t\tthis.#queue.delete(first.value[0]);\n\t\t}\n\t\treturn first.value;\n\t}\n\n\tpeek(): number|null\n\t{\n\t\tconst items = this.#queue.entries();\n\t\tconst first = items.next();\n\t\treturn (first.value ?? null);\n\t}\n\n\tdelete(id: number): void\n\t{\n\t\tthis.#queue.delete(id);\n\t}\n\n\thas(id: number): boolean\n\t{\n\t\treturn this.#queue.has(id);\n\t}\n\n\tclear(): void\n\t{\n\t\tthis.#queue.clear();\n\t}\n\n\tisOverflow(): boolean\n\t{\n\t\tconst MAX_PENDING_ITEMS = 30;\n\t\treturn (this.#queue.size > MAX_PENDING_ITEMS);\n\t}\n\n\tfreeze(): void\n\t{\n\t\tthis.#isFreeze = true;\n\t}\n\n\tunfreeze(): void\n\t{\n\t\tthis.#isFreeze = false;\n\t}\n\n\tisFreezed(): boolean\n\t{\n\t\treturn this.#isFreeze;\n\t}\n}\n","import {Event, Type, Loc} from 'main.core';\nimport PullQueue from \"./pullqueue\";\nimport {EventEmitter} from \"main.core.events\";\n\nexport default class PullManager\n{\n\tgrid: BX.CRM.Kanban.Grid;\n\tqueue: PullQueue;\n\tnotifier: BX.UI.Notification.Balloon;\n\topenedSlidersCount: Number;\n\n\tconstructor(grid)\n\t{\n\t\tthis.grid = grid;\n\t\tthis.queue = new PullQueue(this.grid);\n\t\tthis.openedSlidersCount = 0;\n\t\tif (Type.isString(grid.getData().moduleId) && grid.getData().userId > 0)\n\t\t{\n\t\t\tthis.init();\n\t\t}\n\n\t\tthis.bindEvents();\n\t}\n\n\tinit()\n\t{\n\t\tEvent.ready(() =>\n\t\t{\n\t\t\tconst Pull = BX.PULL;\n\t\t\tif (!Pull)\n\t\t\t{\n\t\t\t\tconsole.error('pull is not initialized');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tPull.subscribe({\n\t\t\t\tmoduleId: this.grid.getData().moduleId,\n\t\t\t\tcommand: this.grid.getData().pullTag,\n\t\t\t\tcallback: (params) =>\n\t\t\t\t{\n\t\t\t\t\tif (Type.isString(params.eventName))\n\t\t\t\t\t{\n\t\t\t\t\t\tif(this.queue.isOverflow())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (params.eventName === 'ITEMUPDATED')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.onPullItemUpdated(params);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (params.eventName === 'ITEMADDED')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.onPullItemAdded(params);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (params.eventName === 'ITEMDELETED')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.onPullItemDeleted(params);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (params.eventName === 'STAGEADDED')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.onPullStageAdded(params);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (params.eventName === 'STAGEDELETED')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.onPullStageDeleted(params);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (params.eventName === 'STAGEUPDATED')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.onPullStageUpdated(params);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t});\n\t\t\tPull.extendWatch(this.grid.getData().pullTag);\n\n\t\t\tEvent.bind(document, 'visibilitychange', () => {\n\t\t\t\tif (!document.hidden)\n\t\t\t\t{\n\t\t\t\t\tthis.onTabActivated();\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n\n\tonPullItemUpdated(params)\n\t{\n\t\tif (this.updateItem(params))\n\t\t{\n\t\t\tthis.queue.loadItem();\n\t\t}\n\t}\n\n\tupdateItem(params)\n\t{\n\t\tconst item = this.grid.getItem(params.item.id);\n\n\t\tif (item)\n\t\t{\n\t\t\tthis.queue.push(item.id, {\n\t\t\t\tid: item.id,\n\t\t\t\taction: 'updateItem',\n\t\t\t\tactionParams: params,\n\t\t\t});\n\n\t\t\treturn true;\n\t\t}\n\n\t\tthis.onPullItemAdded(params);\n\t\treturn false\n\t}\n\n\tonPullItemAdded(params)\n\t{\n\t\tif (this.addItem(params))\n\t\t{\n\t\t\tthis.queue.loadItem();\n\t\t}\n\t}\n\n\taddItem(params)\n\t{\n\t\tconst itemId = params.item.id;\n\t\tconst oldItem = this.grid.getItem(itemId);\n\t\tif (oldItem)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.queue.push(itemId, {\n\t\t\tid: itemId,\n\t\t\taction: 'addItem',\n\t\t\tactionParams: params,\n\t\t});\n\n\t\treturn true;\n\t}\n\n\tonPullItemDeleted(params)\n\t{\n\t\tif (!Type.isPlainObject(params.item))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\t/**\n\t\t * Delay so that the element has time to be rendered before deletion,\n\t\t * if an event for changing the element came before. Ticket #141983\n\t\t */\n\t\tconst delay = (this.queue.has(params.item.id) ? 5000 : 0);\n\n\t\tsetTimeout(function() {\n\t\t\tthis.queue.delete(params.item.id);\n\t\t\tthis.grid.removeItem(params.item.id);\n\n\t\t\tconst column = this.grid.getColumn(params.item.data.columnId);\n\t\t\tcolumn.decPrice(params.item.data.price);\n\t\t\tcolumn.renderSubTitle();\n\t\t}.bind(this), delay);\n\t}\n\n\tonPullStageAdded(params)\n\t{\n\t\tthis.grid.onApplyFilter();\n\t}\n\n\tonPullStageDeleted(params)\n\t{\n\t\tthis.grid.removeColumn(params.stage.id);\n\t}\n\n\tonPullStageUpdated(params)\n\t{\n\t\tthis.grid.onApplyFilter();\n\t}\n\n\tonTabActivated()\n\t{\n\t\tif (this.queue.isOverflow())\n\t\t{\n\t\t\tthis.showOutdatedDataDialog();\n\t\t}\n\t\telse if (this.queue.peek())\n\t\t{\n\t\t\tthis.queue.loadItem();\n\t\t}\n\t}\n\n\tshowOutdatedDataDialog()\n\t{\n\t\tif (!this.notifier)\n\t\t{\n\t\t\tthis.notifier = BX.UI.Notification.Center.notify({\n\t\t\t\tcontent: Loc.getMessage('CRM_KANBAN_NOTIFY_OUTDATED_DATA'),\n\t\t\t\tcloseButton: false,\n\t\t\t\tautoHide: false,\n\t\t\t\tactions: [{\n\t\t\t\t\ttitle: Loc.getMessage('CRM_KANBAN_GRID_RELOAD'),\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: (event, balloon, action) => {\n\t\t\t\t\t\t\tballoon.close();\n\t\t\t\t\t\t\tthis.grid.reload();\n\t\t\t\t\t\t\tthis.queue.clear();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}]\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.notifier.show();\n\t\t}\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('SidePanel.Slider:onOpen', (event) => {\n\t\t\tthis.openedSlidersCount++;\n\t\t\tthis.queue.freeze();\n\t\t});\n\t\tEventEmitter.subscribe('SidePanel.Slider:onClose', (event) => {\n\t\t\tthis.openedSlidersCount--;\n\t\t\tif (this.openedSlidersCount <= 0)\n\t\t\t{\n\t\t\t\tthis.openedSlidersCount = 0;\n\t\t\t\tthis.queue.unfreeze();\n\t\t\t\tthis.onTabActivated();\n\t\t\t}\n\t\t});\n\t}\n}\n","import {UI} from 'ui.notification';\nimport {PopupManager} from \"main.popup\";\nimport {Dom, Event, Loc, Tag, Text, Type} from \"main.core\";\n\ntype FieldsSelectorOptions = {\n\ttype: string,\n\tentityTypeName: string,\n\tsections: Array,\n\tselectedFields: Array,\n\tignoredFields: Object,\n\theadersSections: Object,\n\tdefaultHeaderSectionId: ?string,\n\tonSelect?: Function\n}\n\nconst TYPE_VIEW = 'view';\nconst TYPE_EDIT = 'edit';\n\nexport default class FieldsSelector\n{\n\tconstructor(options: FieldsSelectorOptions)\n\t{\n\t\tthis.popup = null;\n\t\tthis.fields = null;\n\t\tthis.fieldsPopupItems = null;\n\t\tthis.options = options;\n\t\tthis.type =\n\t\t\tthis.options.hasOwnProperty('type')\n\t\t\t\t? this.options.type\n\t\t\t\t: TYPE_VIEW\n\t\t;\n\n\t\tthis.selectedFields =\n\t\t\tthis.options.hasOwnProperty('selectedFields')\n\t\t\t\t? this.options.selectedFields.slice(0)\n\t\t\t\t: []\n\t\t;\n\n\t\tthis.enableHeadersSections = Boolean(this.options.headersSections);\n\t\tthis.headersSections = (this.options.headersSections ?? {});\n\t\tthis.defaultHeaderSectionId = (this.options.defaultHeaderSectionId ?? null);\n\n\t\tthis.fieldVisibleClass = 'crm-kanban-popup-field-search-list-item-visible';\n\t\tthis.fieldHiddenClass = 'crm-kanban-popup-field-search-list-item-hidden';\n\t}\n\n\tshow()\n\t{\n\t\tif (!this.popup)\n\t\t{\n\t\t\tthis.popup = this.createPopup();\n\t\t}\n\t\tif (this.fields)\n\t\t{\n\t\t\tthis.popup.setContent(this.getFieldsLayout());\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.loadPopupContent(this.popup);\n\t\t}\n\t\tthis.popup.show();\n\t}\n\n\tcreatePopup()\n\t{\n\t\treturn PopupManager.create({\n\t\t\tid: 'kanban_custom_fields_' + this.type,\n\t\t\tclassName: 'crm-kanban-popup-field',\n\t\t\ttitleBar: BX.message('CRM_KANBAN_CUSTOM_FIELDS_' + this.type.toUpperCase()),\n\t\t\tcacheable: false,\n\t\t\tcloseIcon: true,\n\t\t\tlightShadow: true,\n\t\t\toverlay: true,\n\t\t\tdraggable: true,\n\t\t\tcloseByEsc: true,\n\t\t\tcontentColor: 'white',\n\t\t\tmaxHeight: window.innerHeight - 50,\n\t\t\tevents: {\n\t\t\t\tonClose: () => (this.popup = null)\n\t\t\t},\n\t\t\tbuttons: [\n\t\t\t\tnew BX.UI.SaveButton({\n\t\t\t\t\tcolor: BX.UI.Button.Color.PRIMARY,\n\t\t\t\t\tstate: this.fields ? '' : BX.UI.Button.State.DISABLED,\n\t\t\t\t\tonclick: () =>\n\t\t\t\t\t{\n\t\t\t\t\t\tconst selectedFields =\n\t\t\t\t\t\t\tthis.fields\n\t\t\t\t\t\t\t\t? this.fields.filter(field => this.selectedFields.indexOf(field.NAME) >= 0)\n\t\t\t\t\t\t\t\t: []\n\t\t\t\t\t\t;\n\t\t\t\t\t\tif (selectedFields.length)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.popup.close();\n\t\t\t\t\t\t\tthis.executeCallback(selectedFields);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tUI.Notification.Center.notify({\n\t\t\t\t\t\t\t\tcontent: Loc.getMessage('CRM_KANBAN_POPUP_AT_LEAST_ONE_FIELD'),\n\t\t\t\t\t\t\t\tautoHide: true,\n\t\t\t\t\t\t\t\tautoHideDelay: 2000,\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}),\n\t\t\t\tnew BX.UI.CancelButton({\n\t\t\t\t\tonclick: () =>\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.popup.close();\n\t\t\t\t\t}\n\t\t\t\t}),\n\t\t\t]\n\t\t});\n\t}\n\n\tloadPopupContent(popup: Popup)\n\t{\n\t\tconst loaderContainer = Tag.render`<div class=\"crm-kanban-popup-field-loader\"></div>`;\n\n\t\tconst loader = new BX.Loader({\n\t\t\ttarget: loaderContainer,\n\t\t\tsize: 80\n\t\t});\n\t\tloader.show();\n\n\t\tpopup.setContent(loaderContainer);\n\n\t\tBX.ajax.runComponentAction(\n\t\t\t'bitrix:crm.kanban',\n\t\t\t'getFields',\n\t\t\t{\n\t\t\t\tmode: 'ajax',\n\t\t\t\tdata: {\n\t\t\t\t\tentityType: this.options.entityTypeName,\n\t\t\t\t\tviewType: this.type,\n\t\t\t\t}\n\t\t\t}\n\t\t)\n\t\t\t.then(\n\t\t\t\t(response) =>\n\t\t\t\t{\n\t\t\t\t\tloader.destroy();\n\n\t\t\t\t\tthis.fields = response.data;\n\t\t\t\t\tpopup.setContent(this.getFieldsLayout());\n\t\t\t\t\tpopup.getButtons().forEach(button => button.setDisabled(false));\n\t\t\t\t\tpopup.adjustPosition();\n\t\t\t\t}\n\t\t\t)\n\t\t\t.catch(\n\t\t\t\t(response) =>\n\t\t\t\t{\n\t\t\t\t\tBX.Kanban.Utils.showErrorDialog(response.errors.pop().message);\n\t\t\t\t}\n\t\t\t);\n\n\t\treturn popup;\n\t}\n\n\tgetFieldsLayout()\n\t{\n\t\tconst sectionsWithFields = this.distributeFieldsBySections(this.fields);\n\n\t\tconst container = Tag.render`<div class=\"crm-kanban-popup-field\"></div>`;\n\n\t\tconst headerWrapper = Tag.render`\n\t\t\t<div class=\"crm-kanban-popup-field-search-header-wrapper\">\n\t\t\t\t<div class=\"ui-form-row-inline\"></div>\n\t\t\t</div>\n\t\t`;\n\n\t\tcontainer.prepend(headerWrapper);\n\n\t\tthis.preparePopupContentHeaderSections(headerWrapper);\n\t\tthis.preparePopupContentHeaderSearch(headerWrapper);\n\n\t\tthis.getSections().map(section => {\n\t\t\tconst sectionWrapperId = this.getSectionWrapperNameBySectionName(section.name);\n\t\t\tconst sectionWrapper = Tag.render`\n\t\t\t\t<div \n\t\t\t\t\tclass=\"crm-kanban-popup-field-search-section\" \n\t\t\t\t\tdata-crm-kanban-popup-field-search-section=\"${sectionWrapperId}\">\n\t\t\t\t</div>\n\t\t\t`;\n\t\t\tDom.append(sectionWrapper, container);\n\n\t\t\tconst sectionName = section.name;\n\t\t\tif (sectionsWithFields.hasOwnProperty(sectionName) && sectionsWithFields[sectionName].length)\n\t\t\t{\n\t\t\t\tDom.append(\n\t\t\t\t\tTag.render`<div class=\"crm-kanban-popup-field-title\">${Text.encode(section.title)}</div>`,\n\t\t\t\t\tsectionWrapper\n\t\t\t\t);\n\t\t\t\tDom.append(\n\t\t\t\t\tTag.render`<div class=\"crm-kanban-popup-field-wrapper\">\n\t\t\t\t\t\t${sectionsWithFields[sectionName].map(\n\t\t\t\t\t\t(field) =>\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet label = field.LABEL;\n\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t!label.length\n\t\t\t\t\t\t\t\t&& section['elements']\n\t\t\t\t\t\t\t\t&& section['elements'][field.NAME]\n\t\t\t\t\t\t\t\t&& section['elements'][field.NAME]['title']\n\t\t\t\t\t\t\t\t&& section['elements'][field.NAME]['title'].length\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlabel = section['elements'][field.NAME]['title'];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tconst encodedLabel = Text.encode(label);\n\n\t\t\t\t\t\t\treturn Tag.render`\n\t\t\t\t\t\t\t\t<div class=\"crm-kanban-popup-field-item\" title=\"${encodedLabel}\">\n\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\tid=\"cf_${Text.encode(field.ID)}\" \n\t\t\t\t\t\t\t\t\t\ttype=\"checkbox\" \n\t\t\t\t\t\t\t\t\t\tname=\"${Text.encode(field.NAME)}\"\n\t\t\t\t\t\t\t\t\t\tclass=\"crm-kanban-popup-field-item-input\"\n\t\t\t\t\t\t\t\t\t\tdata-label=\"${encodedLabel}\"\n\t\t\t\t\t\t\t\t\t\t${this.selectedFields.indexOf(field.NAME) >= 0 ? 'checked' : ''}\n\t\t\t\t\t\t\t\t\t\tonclick=\"${this.onFieldClick.bind(this)}\"\n\t\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t\t\t<label for=\"cf_${Text.encode(field.ID)}\" class=\"crm-kanban-popup-field-item-label\">\n\t\t\t\t\t\t\t\t\t\t${encodedLabel}\n\t\t\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t\t\t</div>`;\n\t\t\t\t\t\t}\n\t\t\t\t\t)}\n\t\t\t\t\t</div>`,\n\t\t\t\t\tsectionWrapper\n\t\t\t\t);\n\t\t\t}\n\t\t});\n\n\t\treturn container;\n\t}\n\n\tpreparePopupContentHeaderSections(headerWrapper: HTMLElement): void\n\t{\n\t\tif (!this.enableHeadersSections)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst headerSectionsWrapper = Tag.render`\n\t\t\t<div class=\"ui-form-row\">\n\t\t\t\t<div class=\"ui-form-content crm-kanban-popup-field-search-section-wrapper\"></div>\n\t\t\t</div>\n\t\t`;\n\n\t\theaderWrapper.firstElementChild.appendChild(headerSectionsWrapper);\n\n\t\tconst headersSections = this.getHeadersSections();\n\n\t\tfor (let key in headersSections)\n\t\t{\n\t\t\tconst itemClass = 'crm-kanban-popup-field-search-section-item-icon'\n\t\t\t\t+ (headersSections[key].selected ? ` crm-kanban-popup-field-search-section-item-icon-active` : '');\n\n\t\t\tconst headerSectionItem = Tag.render`\n\t\t\t\t<div class=\"crm-kanban-popup-field-search-section-item\" data-kanban-popup-filter-section-button=\"${key}\">\n\t\t\t\t\t<div class=\"${itemClass}\">\n\t\t\t\t\t\t${Text.encode(headersSections[key].name)}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`;\n\n\t\t\theaderSectionsWrapper.firstElementChild.appendChild(headerSectionItem);\n\n\t\t\tif (this.type !== TYPE_VIEW)\n\t\t\t{\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tEvent.bind(headerSectionItem, 'click', this.onFilterSectionClick.bind(this, headerSectionItem));\n\t\t}\n\t}\n\n\tonFilterSectionClick(item: HTMLElement): void\n\t{\n\t\tconst activeClass = 'crm-kanban-popup-field-search-section-item-icon-active';\n\t\tconst sectionId = item.dataset.kanbanPopupFilterSectionButton;\n\t\tconst sections = document.querySelectorAll(\n\t\t\t`[data-crm-kanban-popup-field-search-section=\"${sectionId}\"]`\n\t\t);\n\t\tif (Dom.hasClass(item.firstElementChild, activeClass))\n\t\t{\n\t\t\tDom.removeClass(item.firstElementChild, activeClass);\n\t\t\tthis.filterSectionsToggle(sections, 'hide');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.addClass(item.firstElementChild, activeClass);\n\t\t\tthis.filterSectionsToggle(sections, 'show');\n\t\t}\n\t}\n\n\tfilterSectionsToggle(sections: NodeList, action: string): void\n\t{\n\t\tArray.from(sections).map(section => {\n\t\t\t(action === 'show' ? Dom.show(section) : Dom.hide(section));\n\t\t});\n\t}\n\n\tpreparePopupContentHeaderSearch(headerWrapper: HTMLElement): void\n\t{\n\t\tconst searchForm = Tag.render`\n\t\t\t<div class=\"ui-form-row\">\n\t\t\t\t<div class=\"ui-form-content crm-kanban-popup-field-search-input-wrapper\">\n\t\t\t\t\t<div class=\"ui-ctl ui-ctl-textbox ui-ctl-before-icon ui-ctl-after-icon\">\n\t\t\t\t\t\t<div class=\"ui-ctl-before ui-ctl-icon-search\"></div>\n\t\t\t\t\t\t<button class=\"ui-ctl-after ui-ctl-icon-clear\"></button>\n\t\t\t\t\t\t<input type=\"text\" class=\"ui-ctl-element crm-kanban-popup-field-search-section-input\">\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\theaderWrapper.firstElementChild.appendChild(searchForm);\n\t\tconst inputs = searchForm.getElementsByClassName('crm-kanban-popup-field-search-section-input');\n\t\tif (inputs.length)\n\t\t{\n\t\t\tconst input = inputs[0];\n\t\t\tEvent.bind(input, 'input', this.onFilterSectionSearchInput.bind(this, input));\n\t\t\tEvent.bind(input.previousElementSibling, 'click', this.onFilterSectionSearchInputClear.bind(this, input));\n\t\t}\n\t}\n\n\tonFilterSectionSearchInput(input: HTMLElement): void\n\t{\n\t\tlet search = input.value;\n\t\tif (search.length)\n\t\t{\n\t\t\tsearch = search.toLowerCase();\n\t\t}\n\n\t\tthis.getFieldsPopupItems().map(item => {\n\t\t\tconst title = item.innerText.toLowerCase();\n\n\t\t\tif (search.length && title.indexOf(search) === -1)\n\t\t\t{\n\t\t\t\tDom.removeClass(item, this.fieldVisibleClass);\n\t\t\t\tDom.addClass(item, this.fieldHiddenClass);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tDom.removeClass(item, this.fieldHiddenClass);\n\t\t\t\tDom.addClass(item, this.fieldVisibleClass);\n\t\t\t\titem.style.display = 'block';\n\t\t\t}\n\t\t});\n\t}\n\n\tgetFieldsPopupItems(): ?HTMLElement[]\n\t{\n\t\tif (!Type.isArray(this.fieldsPopupItems))\n\t\t{\n\t\t\tthis.fieldsPopupItems = Array.from(\n\t\t\t\tthis.popup.getPopupContainer().querySelectorAll('.crm-kanban-popup-field-item')\n\t\t\t);\n\t\t\tthis.prepareAnimation();\n\t\t}\n\n\t\treturn this.fieldsPopupItems;\n\t}\n\n\tprepareAnimation(): void\n\t{\n\t\tthis.fieldsPopupItems.map(item => {\n\t\t\tEvent.bind(item, 'animationend', this.onAnimationEnd.bind(this, item));\n\t\t});\n\t}\n\n\tonAnimationEnd(item: HTMLElement): void\n\t{\n\t\titem.style.display = (\n\t\t\tDom.hasClass(item, this.fieldHiddenClass)\n\t\t\t\t? 'none'\n\t\t\t\t: 'block'\n\t\t);\n\t}\n\n\tonFilterSectionSearchInputClear(input: HTMLElement): void\n\t{\n\t\tif (input.value.length)\n\t\t{\n\t\t\tinput.value = '';\n\t\t\tthis.onFilterSectionSearchInput(input);\n\t\t}\n\t}\n\n\tgetSectionWrapperNameBySectionName(name: string): ?string\n\t{\n\t\tconst headerSections = this.getHeadersSections();\n\t\tfor (let id in headerSections)\n\t\t{\n\t\t\tif (this.headersSections[id].sections && this.headersSections[id].sections.includes(name))\n\t\t\t{\n\t\t\t\treturn this.headersSections[id].id;\n\t\t\t}\n\t\t}\n\n\t\treturn (\n\t\t\t(this.headersSections[this.defaultHeaderSectionId] && this.defaultHeaderSectionId)\n\t\t\t\t? this.headersSections[this.defaultHeaderSectionId].id\n\t\t\t\t: null\n\t\t);\n\t}\n\n\tgetHeadersSections(): Object\n\t{\n\t\treturn (this.headersSections ?? {});\n\t}\n\n\tdistributeFieldsBySections(fields: Array)\n\t{\n\t\t// remove ignored fields from result:\n\t\tconst ignoredFields = this.getIgnoredFields();\n\t\tfields = fields.filter(item => !(ignoredFields.hasOwnProperty(item.NAME) && ignoredFields[item.NAME]));\n\n\t\tlet fieldsBySections = {};\n\t\tlet defaultSectionName = '';\n\t\tconst sections = this.options.hasOwnProperty('sections') ? this.options.sections : [];\n\t\tfor (let i = 0; i < sections.length; i++)\n\t\t{\n\t\t\tconst section = sections[i];\n\t\t\tconst sectionName = section.name;\n\t\t\tfieldsBySections[sectionName] = [];\n\t\t\tif (Type.isPlainObject(section.elements))\n\t\t\t{\n\t\t\t\tfieldsBySections[sectionName] = this.filterFieldsByList(fields, section.elements);\n\t\t\t}\n\t\t\telse if (section.hasOwnProperty('elementsRule'))\n\t\t\t{\n\t\t\t\tfieldsBySections[sectionName] = this.filterFieldsByRule(fields, new RegExp(section.elementsRule));\n\t\t\t}\n\t\t\telse if (section.elements === '*')\n\t\t\t{\n\t\t\t\tdefaultSectionName = sectionName;\n\t\t\t}\n\t\t}\n\t\tif (defaultSectionName !== '')\n\t\t{\n\t\t\tfieldsBySections[defaultSectionName] = this.filterNotUsedFields(fields, fieldsBySections);\n\t\t}\n\n\t\treturn fieldsBySections;\n\t}\n\n\tfilterFieldsByList(fields: Array, whiteList: Object): Array\n\t{\n\t\treturn fields.filter((item) => whiteList.hasOwnProperty(item.NAME));\n\t}\n\n\tfilterFieldsByRule(fields: Array, rule: RegExp): Array\n\t{\n\t\treturn fields.filter((item) => item.NAME.match(rule));\n\t}\n\n\tfilterNotUsedFields(fields: Array, alreadyUsedFieldsBySection: Object): Array\n\t{\n\t\tlet alreadyUsedFieldsNames = Object.values(alreadyUsedFieldsBySection).reduce(\n\t\t\t(prevFields, sectionFields) =>\n\t\t\t{\n\t\t\t\treturn prevFields.concat(sectionFields.map((item) => item.NAME))\n\t\t\t},\n\t\t\t[]\n\t\t);\n\n\t\treturn fields.filter(item => alreadyUsedFieldsNames.indexOf(item.NAME) < 0);\n\t}\n\n\tgetSections(): Array\n\t{\n\t\treturn this.options.hasOwnProperty('sections') ? this.options.sections : [];\n\t}\n\n\tgetIgnoredFields()\n\t{\n\t\tlet fields = Object.assign({}, this.options.ignoredFields);\n\t\tlet extraFields = [];\n\t\tif (this.type === TYPE_EDIT)\n\t\t{\n\t\t\textraFields = [\n\t\t\t\t'ID',\n\t\t\t\t'CLOSED',\n\t\t\t\t'CLOSEDATE',\n\t\t\t\t'DATE_CREATE',\n\t\t\t\t'DATE_MODIFY',\n\t\t\t\t'COMMENTS',\n\t\t\t\t'OPPORTUNITY',\n\t\t\t]\n\t\t}\n\t\telse\n\t\t{\n\t\t\textraFields = [\n\t\t\t\t'PHONE',\n\t\t\t\t'EMAIL',\n\t\t\t\t'WEB',\n\t\t\t\t'IM',\n\t\t\t]\n\t\t}\n\t\textraFields.forEach((fieldName => (fields[fieldName] = true)));\n\n\t\treturn fields;\n\t}\n\n\texecuteCallback(selectedFields: Array)\n\t{\n\t\tif (!this.options.hasOwnProperty('onSelect') || !Type.isFunction(this.options.onSelect))\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tlet callbackPayload = {};\n\t\tselectedFields.forEach(\n\t\t\t(field) =>\n\t\t\t{\n\t\t\t\tcallbackPayload[field.NAME] =\n\t\t\t\t\tfield.LABEL\n\t\t\t\t\t\t? field.LABEL\n\t\t\t\t\t\t: ''\n\t\t\t\t;\n\t\t\t}\n\t\t);\n\t\tthis.options.onSelect(callbackPayload);\n\t}\n\n\tonFieldClick(event)\n\t{\n\t\tconst fieldName = event.target.name;\n\t\tif (event.target.checked && this.selectedFields.indexOf(fieldName) < 0)\n\t\t{\n\t\t\tthis.selectedFields.push(fieldName);\n\t\t}\n\t\tif (!event.target.checked && this.selectedFields.indexOf(fieldName) >= 0)\n\t\t{\n\t\t\tthis.selectedFields.splice(this.selectedFields.indexOf(fieldName), 1);\n\t\t}\n\t}\n}\n"],"names":["PullOperation","data","instance","grid","setItemId","itemId","setAction","action","setActionParams","actionParams","getAction","updateItem","addItem","params","getActionParams","item","getItem","id","paramsItem","oldPrice","parseFloat","price","oldColumnId","columnId","key","rawData","setActivityExistInnerHtml","useAnimation","setChangedInPullRequest","resetMultiSelectMode","insertItem","newColumnId","newColumn","getColumn","newPrice","oldColumn","decPrice","renderSubTitle","incPrice","oldItem","column","sorter","Sorter","createWithCurrentSortType","getItems","beforeItem","calcBeforeItemByParams","sort","targetId","getId","PullQueue","Map","loadItemsTimer","isForce","setTimeout","document","hidden","isOverflow","isFreezed","items","popAllAsArray","length","ids","map","push","operation","createInstance","execute","loadNextOnSuccess","peek","loadItem","doNothingOnError","loadNew","then","parseInt","has","set","Array","from","clear","count","results","i","pop","entries","first","next","value","MAX_PENDING_ITEMS","size","PullManager","queue","openedSlidersCount","Type","isString","getData","moduleId","userId","init","bindEvents","Event","ready","Pull","BX","PULL","console","error","subscribe","command","pullTag","callback","eventName","onPullItemUpdated","onPullItemAdded","onPullItemDeleted","onPullStageAdded","onPullStageDeleted","onPullStageUpdated","extendWatch","bind","onTabActivated","isPlainObject","delay","removeItem","onApplyFilter","removeColumn","stage","showOutdatedDataDialog","notifier","UI","Notification","Center","notify","content","Loc","getMessage","closeButton","autoHide","actions","title","events","click","event","balloon","close","reload","show","EventEmitter","freeze","unfreeze","TYPE_VIEW","TYPE_EDIT","FieldsSelector","options","popup","fields","fieldsPopupItems","type","hasOwnProperty","selectedFields","slice","enableHeadersSections","Boolean","headersSections","defaultHeaderSectionId","fieldVisibleClass","fieldHiddenClass","createPopup","setContent","getFieldsLayout","loadPopupContent","PopupManager","create","className","titleBar","message","toUpperCase","cacheable","closeIcon","lightShadow","overlay","draggable","closeByEsc","contentColor","maxHeight","window","innerHeight","onClose","buttons","SaveButton","color","Button","Color","PRIMARY","state","State","DISABLED","onclick","filter","field","indexOf","NAME","executeCallback","autoHideDelay","CancelButton","loaderContainer","Tag","render","loader","Loader","target","ajax","runComponentAction","mode","entityType","entityTypeName","viewType","response","destroy","getButtons","forEach","button","setDisabled","adjustPosition","Kanban","Utils","showErrorDialog","errors","sectionsWithFields","distributeFieldsBySections","container","headerWrapper","prepend","preparePopupContentHeaderSections","preparePopupContentHeaderSearch","getSections","section","sectionWrapperId","getSectionWrapperNameBySectionName","name","sectionWrapper","Dom","append","sectionName","Text","encode","label","LABEL","encodedLabel","ID","onFieldClick","headerSectionsWrapper","firstElementChild","appendChild","getHeadersSections","itemClass","selected","headerSectionItem","onFilterSectionClick","activeClass","sectionId","dataset","kanbanPopupFilterSectionButton","sections","querySelectorAll","hasClass","removeClass","filterSectionsToggle","addClass","hide","searchForm","inputs","getElementsByClassName","input","onFilterSectionSearchInput","previousElementSibling","onFilterSectionSearchInputClear","search","toLowerCase","getFieldsPopupItems","innerText","style","display","isArray","getPopupContainer","prepareAnimation","onAnimationEnd","headerSections","includes","ignoredFields","getIgnoredFields","fieldsBySections","defaultSectionName","elements","filterFieldsByList","filterFieldsByRule","RegExp","elementsRule","filterNotUsedFields","whiteList","rule","match","alreadyUsedFieldsBySection","alreadyUsedFieldsNames","Object","values","reduce","prevFields","sectionFields","concat","assign","extraFields","fieldName","isFunction","onSelect","callbackPayload","checked","splice"],"mappings":"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"}