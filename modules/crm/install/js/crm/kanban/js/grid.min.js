(function(){"use strict";BX.namespace("BX.CRM.Kanban");BX.CRM.Kanban.Grid=function(e){BX.Kanban.Grid.apply(this,arguments);BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemCaptured",BX.delegate(this.onBeforeItemCaptured,this));BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemRestored",BX.delegate(this.onBeforeItemRestored,this));BX.addCustomEvent(this,"Kanban.Grid:onBeforeItemMoved",BX.delegate(this.onBeforeItemMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnAddedAsync",BX.delegate(this.onColumnAddedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnUpdated",BX.delegate(this.onColumnUpdated,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnMoved",BX.delegate(this.onColumnMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnRemovedAsync",BX.delegate(this.onColumnRemovedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnLoadAsync",BX.delegate(this.onColumnLoadAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStart",BX.delegate(this.onItemDragStartHandler,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStart",BX.delegate(this.setKanbanDragMode,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStop",BX.delegate(this.unSetKanbanDragMode,this));BX.addCustomEvent("BX.Main.Filter:apply",BX.delegate(this.onApplyFilter,this));BX.addCustomEvent("BX.CrmEntityCounterPanel:applyFilter",BX.delegate(this.onApplyFilterCounter,this));BX.addCustomEvent("Crm.PartialEditorDialog.Close",BX.delegate(this.onPartialEditorClose,this));BX.addCustomEvent("onPullEvent-crm",BX.proxy(this.onPullEventHandlerCrm,this));BX.addCustomEvent("onPullEvent-im",BX.proxy(this.onPullEventHandlerCrm,this));BX.addCustomEvent("onCrmActivityTodoChecked",BX.proxy(this.onCrmActivityTodoChecked,this));BX.addCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.onSliderClose,this));BX.addCustomEvent("BX.CRM.Kanban.Item.select",BX.proxy(this.startActionPanel,this));BX.addCustomEvent("BX.CRM.Kanban.Item.unSelect",BX.proxy(this.stopActionPanel,this));BX.addCustomEvent("BX.UI.ActionPanel:clickResetAllBlock",BX.proxy(this.resetMultiSelectMode,this));BX.addCustomEvent("BX.Crm.EntityEditorSection:onOpenChildMenu",BX.proxy(this.onOpenEditorMenu,this));BX.addCustomEvent("BX.Crm.EntityEditor:onConfigScopeChange",BX.proxy(this.onConfigEditorScopeChange,this));BX.addCustomEvent("BX.Crm.EntityEditor:onConfigReset",BX.proxy(this.onConfigEditorReset,this));BX.addCustomEvent("BX.Crm.EntityEditor:onForceCommonConfigScopeForAll",BX.proxy(this.onForceCommonEditorConfigScopeForAll,this));BX.addCustomEvent("onPopupShow",BX.proxy(this.onPopupShow,this));BX.addCustomEvent("CrmDragItemDragRelease",BX.proxy(this.onEditorDragItemRelease,this));this.bindEvents();BX.CRM.Kanban.Grid.Instance=this};BX.CRM.Kanban.Grid.Instance=null;BX.CRM.Kanban.Grid.getInstance=function(){return BX.CRM.Kanban.Grid.Instance};BX.CRM.Kanban.Grid.prototype={__proto__:BX.Kanban.Grid.prototype,constructor:BX.CRM.Kanban.Grid,accessNotifyDialog:null,loadNewInterval:25,ajaxParams:{},customFieldsPopup:null,customFieldsContainer:null,actionPanel:null,currentNode:null,itemMoving:null,actionItems:[],checkedItems:[],progressBarEditor:null,ccItem:null,restItem:null,popupCancel:null,dropZonesShow:false,schemeInline:null,isBindEvents:false,fieldsSelectors:{},headersSections:{},getChecked:function(){return this.checkedItems},getCheckedId:function(){var e=this.getChecked();var t=[];for(var i=0;i<e.length;i++){t.push(e[i].id)}return t},checkItem:function(e){var t=this.getItem(e);if(!BX.util.in_array(t,this.checkedItems)){t.checked=true;if(!this.isCheckedItem(t)){this.checkedItems.push(t)}BX.addClass(t.checkedButton,"crm-kanban-item-checkbox-checked");BX.addClass(t.container,"crm-kanban-item-selected");BX.onCustomEvent("BX.CRM.Kanban.Item.select",[t])}},isCheckedItem:function(e){var t=this.checkedItems;for(var i=0,n=t.length;i<n;i++){if(t[i]["id"]===e["id"]){return true}}return false},onEditorDragItemRelease:function(){var e=this.getColumns();for(var t=0,i=e.length;t<i;t++){if(!e[t].isEditorOpen()){e[t].cleanEditorNode();e[t].editor=null}}},unCheckItem:function(e){var t=this.getItem(e);if(BX.util.in_array(t,this.checkedItems)){this.checkedItems.splice(this.checkedItems.indexOf(t),1);t.checked=false;BX.removeClass(t.checkedButton,"crm-kanban-item-checkbox-checked");BX.removeClass(t.container,"crm-kanban-item-selected");BX.onCustomEvent("BX.CRM.Kanban.Item.unSelect",[t])}},getPopupCancel:function(e){if(!this.popupCancel){this.popupCancel=new BX.PopupWindow("crm-kanban-popup-cancel",window,{className:"crm-kanban-popup-cancel",autoHide:false,overlay:true,maxWidth:350,buttons:[new BX.PopupWindowButton({text:"OK",className:"ui-btn ui-btn-primary",events:{click:function(){this.popupCancel.close()}.bind(this)}})],closeByEsc:true,events:{onPopupClose:function(){}.bind(this)},closeIcon:true})}this.popupCancel.setContent(e);return this.popupCancel},getItemsForAction:function(e){var t=this.getChecked();this.actionItems=[];if(e){t.splice(this.actionItems.indexOf(e),1)}for(var i=0;i<t.length;i++){this.actionItems.push(parseInt(t[i].id,10))}return this.actionItems},bindEvents:function(){if(!this.isBindEvents){BX.bind(window,"click",function(e){if(this.dropZonesShow){return}this.isItKanban(e.target)?this.currentNode=e.target:this.currentNode=null;if(!BX.findParent(e.target,{className:"main-kanban-item"})&&!BX.findParent(e.target,{className:"ui-action-panel"})){this.unSetKanbanDragMode()}}.bind(this));BX.bind(window,"keydown",function(e){if(this.dropZonesShow){return}if(e.code==="Escape"){this.resetMultiSelectMode();this.unSetKanbanDragMode()}}.bind(this));BX.addCustomEvent(window,"Crm.PartialEditorDialog.Close",function(e,t){if(t.isCancelled&&this.itemMoving.item){this.moveItem(this.itemMoving.item,this.itemMoving.oldColumn,this.itemMoving.oldNextSiblingId)}}.bind(this));BX.Event.EventEmitter.subscribe("Crm.Kanban.Column:onItemAdded",function(e){if(this.itemMoving&&this.itemMoving.item.id===e.data.item.id&&this.items[this.itemMoving.item.id]!==undefined&&this.itemMoving.item.columnId===this.items[this.itemMoving.item.id].columnId){this.onItemMoved(e.data.item,e.data.targetColumn,e.data.beforeItem)}}.bind(this));BX.Event.EventEmitter.subscribe("crm-kanban-settings-fields-view",function(){this.showFieldsSelectPopup("view")}.bind(this));BX.Event.EventEmitter.subscribe("crm-kanban-settings-fields-edit",function(){this.showFieldsSelectPopup("edit")}.bind(this));var e=BX.Reflection.getClass("BX.Crm.ToolbarComponent")?BX.Reflection.getClass("BX.Crm.ToolbarComponent").Instance:null;if(this.getData().isDynamicEntity&&e){e.subscribeTypeUpdatedEvent(function(){if(BX.Reflection.getClass("BX.Crm.Router.Instance.getKanbanUrl")){var e=this.getData().hasOwnProperty("entityTypeInt")?BX.Text.toInteger(this.getData().entityTypeInt):0;var t=this.getData().params.hasOwnProperty("CATEGORY_ID")?BX.Text.toInteger(this.getData().params.CATEGORY_ID):0;var i=BX.Crm.Router.Instance.getKanbanUrl(e,t);if(i){window.location.href=i;return}}window.location.reload()}.bind(this));e.subscribeCategoriesUpdatedEvent(function(){this.reload()}.bind(this))}this.isBindEvents=true}},isItKanban:function(e){if(BX.findParent(e,{className:"main-kanban"})){return true}},setKanbanDragMode:function(){BX.addClass(document.body,"crm-kanban-drag-mode")},unSetKanbanDragMode:function(){this.stopActionPanel(true);BX.removeClass(document.body,"crm-kanban-drag-mode")},renderLayout:function(){var e=this.getData();BX.Kanban.Grid.prototype.renderLayout.apply(this,arguments);this.setDropareaFirstItemWidth();if(this.ccItem&&!e.contactCenterShow){this.hideItem(this.ccItem)}if(this.restItem&&!e.restDemoBlockShow){this.hideItem(this.restItem)}},setDropareaFirstItemWidth:function(){var e=document.head;var t=BX.create("style",{attrs:{type:"text/css"}});if(this.layout.gridContainer.firstChild!==null){var i=document.createTextNode(".main-kanban-dropzone:first-child, main-kanban-dropzone:last-child {"+"max-width: "+(this.layout.gridContainer.firstChild.offsetWidth+3)+"px; "+"min-width: "+(this.layout.gridContainer.firstChild.offsetWidth+3)+"px;}");t.appendChild(i);e.appendChild(t)}},getAjaxHandlerPath:function(){var e=this.getData();return BX.type.isNotEmptyString(e.ajaxHandlerPath)?e.ajaxHandlerPath:"/bitrix/components/bitrix/crm.kanban/ajax.old.php"},setAjaxParams:function(e){this.ajaxParams=e},ajax:function(e,t,i,n){var a=this.getData();var o=this.getAjaxHandlerPath();if(typeof n==="undefined"){n="json"}e.sessid=BX.bitrix_sessid();e.extra=a.params;e.entity_type=a.entityType;e.version=2;e.ajaxParams=this.ajaxParams;e.entityPath=a.entityPath;this.setAjaxParams({});if(e.action!=="undefined"){o+=o.indexOf("?")===-1?"?":"&";o+="action="+e.action}if(this.isMultiSelectMode()){o+="&group=yes"}if(this.isCicleRequest(e)){this.reload()}else{BX.ajax({method:"POST",dataType:n,url:o,data:e,onsuccess:t,onfailure:i})}},isCicleRequest:function(e){if(e.action!=="page"){return false}var t=10*1e3;var i=5;var n=function(e){BX.localStorage.set("crm-kanban-cicle-request-params",e,t)};var a=BX.localStorage.get("crm-kanban-cicle-request-params");if(!a){a=this.getEmptyCicleRequestParams();a.total+=1;n(a);return false}var o=Date.now()-a.startTime;if(o<t&&a.total>=i){n(this.getEmptyCicleRequestParams());return true}if(o>t){a=this.getEmptyCicleRequestParams()}a.total+=1;n(a);return false},getEmptyCicleRequestParams:function(){return{total:0,startTime:Date.now()}},accessNotify:function(){if(typeof BX.Intranet!=="undefined"&&typeof BX.Intranet.NotifyDialog!=="undefined"){if(this.accessNotifyDialog===null){var e=this.getData();this.accessNotifyDialog=new BX.Intranet.NotifyDialog({listUserData:this.getData().admins,notificationHandlerUrl:this.getAjaxHandlerPath()+"?action=notifyAdmin&version=2&entity_type="+e.entityType,popupTexts:{sendButton:BX.message("CRM_KANBAN_NOTIFY_BUTTON"),title:BX.message("CRM_KANBAN_NOTIFY_TITLE"),header:BX.message("CRM_KANBAN_NOTIFY_HEADER"),description:BX.message("CRM_KANBAN_NOTIFY_TEXT2")}})}this.accessNotifyDialog.show()}},addStage:function(e){var t=new BX.Promise;var i=this.getPreviousColumnSibling(e);var n=i?i.getId():0;this.ajax({action:"modifyStage",columnName:e.getName(),columnColor:e.getColor(),afterColumnId:n},function(e){if(e&&!e.error){this.resetActionPanel();t.fulfill(e)}else if(e){BX.Kanban.Utils.showErrorDialog(e.error,e.fatal);t.reject(e.error)}}.bind(this),function(e){BX.Kanban.Utils.showErrorDialog("Error: "+e,true);t.reject("Error: "+e)}.bind(this));return t},removeStage:function(e){var t=new BX.Promise;this.ajax({action:"modifyStage",columnId:e.getId(),delete:1},function(e){if(e&&!e.error){this.resetActionPanel();t.fulfill()}else if(e){t.reject(e.error)}}.bind(this),function(e){BX.Kanban.Utils.showErrorDialog("Error: "+e,true);t.reject("Error: "+e)}.bind(this));return t},getColumnItems:function(e){var t=new BX.Promise;this.data.params["total"]=e.getTotal();this.data.params["itemsCount"]=e.getItemsCount();var i=e.getPagination();if(e.getTotal()<i.getPage()*e.blockSize){e.setTotal(e.getItemsCount());t.fulfill([]);return t}e.loadingInProgress=true;var n=i.getPage()+1;this.ajax({action:"page",page:n,column:e.getId(),onlyItems:n>1?"Y":"N"},function(e){if(e&&(BX.type.isArray(e)||BX.type.isArray(e.items))&&!e.error){t.fulfill(BX.type.isArray(e)?e:e.items)}else if(e){BX.Kanban.Utils.showErrorDialog(e.error,e.fatal);t.reject(e.error)}if(this.ccItem){var i=this.getData();if(!i.contactCenterShow){this.hideItem(this.ccItem)}}}.bind(this),function(e){BX.Kanban.Utils.showErrorDialog("Error: "+e,true);t.reject("Error: "+e)}.bind(this));return t},addItemTop:function(e,t){var i=this.getColumn(e.columnId);var n=i?i.getItems():[];t=typeof t!=="undefined"?t:true;if(n.length>0){e.targetId=n[0].getId()}i&&t?i.incPrice(e.data.price):null;this.addItem(e)},moveItem:function(e,t,i,n){n=n||false;return this.movePromisedItem(e,t,i,n)},movePromisedItem:function(item,targetColumn,beforeItem,usePromise){var notChangeTotal=item.notChangeTotal||false;item=this.getItem(item);item.notChangeTotal=notChangeTotal;targetColumn=this.getColumn(targetColumn);if(!item||!targetColumn||item===beforeItem){if(usePromise){return Promise.resolve({status:false})}return false}beforeItem=beforeItem?this.getItem(beforeItem):targetColumn.items[0]||null;var currentColumn=item.getColumn();var targetColumnId=targetColumn.getId();var gridData=this.getData();var targetColumnData=targetColumn.getData();if(this.getChecked().length>1){var error=false;var checked=this.getChecked();for(var i=0,c=checked.length;i<c;i++){var itemData=checked[i].getData();var currentColumnId=checked[i].getColumn().getId();if(this.getTypeInfoParam("hasRestictionToMoveToWinColumn")&&targetColumnData.type==="WIN"){error=true;if(checked.length===i+1){this.resetMultiSelectMode()}}else if(itemData.required&&itemData.required[targetColumnId]&&itemData.required[targetColumnId].length>0&&targetColumnId!==currentColumnId){if(itemData.required_fm){var newRequired=[];for(var j=0,cc=itemData.required[targetColumnId].length;j<cc;j++){var key=itemData.required[targetColumnId][j];if(typeof itemData.required_fm[key]==="undefined"||itemData.required_fm[key]===true){newRequired.push(itemData.required[targetColumnId][j])}}itemData.required[targetColumnId]=newRequired}if(itemData.required[targetColumnId].length>0){error=true;if(checked.length===i+1){this.resetMultiSelectMode()}}}else if(itemData["updateRestrictionCallback"]){try{eval(itemData["updateRestrictionCallback"])}catch(e){console.log("update action restricted")}this.resetMultiSelectMode();if(usePromise){return Promise.resolve()}return}}if(error){this.showNotCompletedPopup(gridData)}var itemsChecked=this.getChecked();var removePromises=[];for(var i=0;i<itemsChecked.length;i++){if(itemsChecked[i]!==item&&itemsChecked[i].getColumn()!==targetColumn){itemsChecked[i].getColumn().layout.total.textContent=+itemsChecked[i].getColumn().layout.total.innerHTML-1}removePromises.push(currentColumn.removeItem(itemsChecked[i]))}var checked=this.getChecked();if(usePromise){return Promise.all(removePromises).then(function(){checked.forEach((function(e){e.useAnimation=false;e.layout.container.style.opacity=1}));targetColumn.addItems(checked,beforeItem);this.resetMultiSelectMode();this.stopActionPanel()}.bind(this))}targetColumn.addItems(checked,beforeItem);this.resetMultiSelectMode();this.stopActionPanel();return}else{item.beforeItem=beforeItem;currentColumn.removeItem(item).then((function(){targetColumn.addItem(item,item.beforeItem)}));this.stopActionPanel();if(usePromise){return Promise.resolve({status:true})}return true}},loadNew:function(e,t,i,n){var a=this.getData();var o=typeof e!=="undefined"?Array.isArray(e)?e:[e]:0;if(document.hidden){return Promise.reject(new Error("Tab is not active"))}var r=0;r=o.reduce(function(e,t,i,n){var a=this.getItem(t);if(a&&a.getData().updateRestrictionCallback){delete n[i];return e}return++e}.bind(this),0);if(!r){return Promise.resolve()}return new Promise(function(e,r){this.ajax(o[0]?{action:"get",entity_id:o,force:t===true?"Y":"N",onlyItems:n===true?"Y":"N"}:{action:"get",min_entity_id:a.lastId,force:t===true?"Y":"N",onlyItems:n===true?"Y":"N"},function(t){if(t&&t.items){var n=false;if(t.items.length){var r={};for(var s=t.items.length-1;s>=0;s--){var l=t.items[s];var d=this.getItem(l.id);if(l.id<=0){continue}n=true;if(d){var m=d.getData();var u=d.getColumn();var c=this.getColumn(l.columnId);u.decPrice(parseFloat(m.price));r[u.getId()]=u;if(c){c.incPrice(parseFloat(l.data.price));d.data.price=l.data.price;if(c!==u||i===true){l.notChangeTotal=true;this.updateItem(l.id,l);r[c.getId()]=c}}else{this.removeItem(d)}}else if(l.id&&this.getColumn(l.columnId)===null){BX.onCustomEvent(this,"Kanban.Column:render")}else if(l.id){this.addItemTop(l)}if(!o[0]){a.lastId=l.id;this.setData(a)}}for(var h in r){r[h].renderSubTitle()}}if(!n&&o[0]){var l=this.getItem(o[0]);if(l){var g=l.getData();var f=l.getColumn();f.decPrice(g.price);this.removeItem(o[0])}}}e(t)}.bind(this),function(e){r()}.bind(this))}.bind(this))},updateItem:function(e,t){e=this.getItem(e);if(!e){return false}if(BX.Kanban.Utils.isValidId(t.columnId)&&t.columnId!==e.getColumn().getId()){if(t.notChangeTotal){e.notChangeTotal=t.notChangeTotal}this.moveItem(e,this.getColumn(t.columnId),this.getItem(t.targetId))}var i=["UPDATE",{task:e,options:t}];BX.onCustomEvent(window,"tasksTaskEvent",i);e.setOptions(t);e.render();return true},onItemDragStart:function(e){this.setDragMode(BX.Kanban.DragMode.ITEM);if(parseInt(e.getId())<0){return}var t=this.getItems();var i=e.getColumnId();if(e.isItemMoveDisabled()){for(var n in t){var a=t[n].getColumnId();if(a===i){t[n].enableDropping()}}return}BX.Kanban.Grid.prototype.onItemDragStart.apply(this,arguments);if(this.progressBarEditor){this.progressBarEditor.close()}},onItemDragStartHandler:function(e){e.setLastPosition()},onColumnLoadAsync:function(e){e.push(BX.delegate(this.getColumnItems,this))},onColumnRemovedAsync:function(e){e.push(BX.delegate(this.removeStage,this))},onColumnAddedAsync:function(e){e.push(BX.delegate(this.addStage,this))},onBeforeItemCaptured:function(e){BX.onCustomEvent("Crm.Kanban.Grid:onBeforeItemCapturedStart",[this,e]);if(e.isActionAllowed()){var t=e.getItem();var i=t.getColumn();var n=e.getDropZone();this.itemMoving={item:t,price:parseFloat(t.getData().price),oldColumn:i,oldNextSiblingId:i.getNextItemSibling(t),newColumn:null,newNextSibling:null,dropEvent:e,groupIds:this.getItemsForAction()};this.onItemMoved(t,n,null,true);if(n.getId()==="DELETED"){var a=this.getItemsForAction();BX.CRM.Kanban.Actions.delete(this,a.length?a:parseInt(t.getId(),10),n)}}},onBeforeItemRestored:function(e){var t=e.getItem();var i=t.getColumn();var n=parseFloat(t.getData().price);i.incPrice(n);this.onItemMoved(t,i)},onBeforeItemMoved:function(e){var t=e.getItem();var i=t.getColumn();this.itemMoving={item:t,price:parseFloat(t.getData().price),oldColumn:i,oldNextSiblingId:i.getNextItemSibling(t),newColumn:null,newNextSibling:null}},onItemMoved:function(item,targetColumn,beforeItem,skipHandler){var itemData=item.getData();var columnId=targetColumn.getId();var gridData=this.getData();var isDropZone=targetColumn instanceof BX.Kanban.DropZone;if(targetColumn.getId()!=="DELETED"&&itemData["updateRestrictionCallback"]&&BX.Type.isString(itemData["updateRestrictionCallback"])&&columnId!==this.itemMoving.oldColumn.getId()){try{eval(itemData["updateRestrictionCallback"])}catch(e){console.log("update action restricted")}if(isDropZone){this.itemMoving.dropEvent.denyAction()}else{this.moveItem(item,this.itemMoving.oldColumn,this.itemMoving.oldNextSiblingId)}return}var isItemDataHasRequiredColumn=itemData.required&&itemData.required[columnId]&&itemData.required[columnId].length>0;if(isItemDataHasRequiredColumn&&this.itemMoving.oldColumn.getId()!==targetColumn.getId()&&!item.isChangedInPullRequest()){if(itemData.required_fm){var newRequired=[];for(var i=0,c=itemData.required[columnId].length;i<c;i++){var key=itemData.required[columnId][i];if(typeof itemData.required_fm[key]==="undefined"||itemData.required_fm[key]===true){newRequired.push(itemData.required[columnId][i])}}itemData.required[columnId]=newRequired}if(item.rawData&&typeof item.rawData==="object"){var requiredFields=itemData.required[columnId];for(var i=0,c=itemData.required[columnId].length;i<c;i++){var key=itemData.required[columnId][i];if(!(typeof item.rawData[key]==="undefined"||item.rawData[key]===null||item.rawData[key]===""||Array.isArray(item.rawData[key])&&!item.rawData[key].length)){requiredFields.splice(i,1)}}itemData.required[columnId]=requiredFields}if(itemData.required[columnId].length>0&&this.getTypeInfoParam("isQuickEditorEnabled")){this.itemMoving.newColumn=targetColumn;this.itemMoving.newNextSibling=beforeItem;if(isDropZone){this.itemMoving.dropEvent.denyAction()}if(this.getChecked().length>1){this.showNotCompletedPopup(gridData);this.resetMultiSelectMode()}else{this.openPartialEditor(item.getId(),columnId,itemData.required[columnId]);BX.addClass(item.layout.container,"main-kanban-item-waiting")}return}}if(!item.isChangedInPullRequest()){if(this.getTypeInfoParam("canShowPopupForLeadConvert")&&targetColumn.getId()==="CONVERTED"&&this.itemMoving.dropEvent){BX.Crm.KanbanComponent.dropPopup(this,this.itemMoving.dropEvent)}if(!item.notChangeTotal){if(this.itemMoving.item.getData().runtimePrice!==true){this.itemMoving.oldColumn.decPrice(this.itemMoving.price)}if(!isDropZone){targetColumn.incPrice(this.itemMoving.price);targetColumn.renderSubTitle();this.itemMoving.oldColumn.renderSubTitle()}}}this.itemMoving.item.setDataKey("runtimePrice",false);if(skipHandler!==true&&!item.isChangedInPullRequest()){var handlerData={grid:this,item:item,targetColumn:targetColumn,beforeItem:beforeItem,skip:false};BX.onCustomEvent("Crm.Kanban.Grid:onItemMovedFinal",[handlerData]);if(handlerData.skip===true){return}}var afterItemId=0;var itemId=item.getId();var targetColumnId=targetColumn?targetColumn.getId():0;if(targetColumn instanceof BX.Kanban.DropZone){afterItemId=0}else{var afterItem=targetColumn.getPreviousItemSibling(item);if(afterItem){afterItemId=afterItem.getId()}}BX.removeClass(item.layout.container,"main-kanban-item-waiting");if(this.itemMoving.groupIds&&this.itemMoving.groupIds.length===0){this.itemMoving.groupIds.push(itemId)}if(!item.isChangedInPullRequest()){this.ajax({action:"status",entity_id:this.itemMoving.groupIds?this.itemMoving.groupIds:itemId,prev_entity_id:afterItemId,status:targetColumnId},function(e){if(e&&!e.error){if(e.items&&e.items.length>0){this.updateItem(itemId,e.items[0])}else{item.setDataKey("columnId",targetColumnId)}}else if(e){BX.Kanban.Utils.showErrorDialog(e.error,true)}}.bind(this),function(e){BX.Kanban.Utils.showErrorDialog("Error: "+e,true)}.bind(this))}if(item.isChangedInPullRequest()){this.clearItemMoving();item.dropChangedInPullRequest()}},showNotCompletedPopup:function(e){var t=BX.message("CRM_KANBAN_SET_STATUS_NOT_COMPLETED_TEXT_"+e.entityType);if(e.isDynamicEntity){t=BX.message("CRM_KANBAN_SET_STATUS_NOT_COMPLETED_TEXT_DYNAMIC")}this.getPopupCancel(t).show()},onColumnUpdated:function(e){var t=e.getId();var i=e.getName();var n=e.getColor();this.ajax({action:"modifyStage",columnId:t,columnName:i,columnColor:n},function(e){if(e&&e.error){BX.Kanban.Utils.showErrorDialog(e.error,e.fatal)}else{this.resetActionPanel()}}.bind(this),function(e){BX.Kanban.Utils.showErrorDialog("Error: "+e,true)}.bind(this))},onColumnMoved:function(e,t){var i=e.getId();var n=this.getPreviousColumnSibling(e);var a=n?n.getId():0;this.ajax({action:"modifyStage",columnId:i,afterColumnId:a},function(e){if(e&&e.error){BX.Kanban.Utils.showErrorDialog(e.error,true)}else{this.resetActionPanel()}}.bind(this),function(e){BX.Kanban.Utils.showErrorDialog("Error: "+e,true)}.bind(this))},onApplyFilter:function(e,t,i,n,a){this.clearItemMoving();this.fadeOut();if(typeof a!=="undefined"){a.autoResolve=false}this.ajax({action:"get"},function(e){var t=this.getData();if(typeof e.customFields!=="undefined"){t.customFields=e.customFields}if(typeof e.customEditFields!=="undefined"){t.customEditFields=e.customEditFields}if(typeof BX.UI.EntityScheme!=="undefined"&&typeof e.scheme_inline!=="undefined"){t.schemeInline=BX.UI.EntityScheme.create("kanban_scheme",{current:e.scheme_inline})}this.setData(t);this.destroyFieldsSelectPopup();var i=[],a=null;var o=this.getColumns();for(var r=0,s=o.length;r<s;r++){a=o[r].getId();i.push(a);this.removeColumn(a)}this.removeItems();this.loadData(e);var l=this.getDropZoneArea();var d=this.getDropZoneArea().getDropZones();for(var r=0,s=d.length;r<s;r++){l.removeDropZone(d[r])}if(e.dropzones){for(var r=0,s=e.dropzones.length;r<s;r++){l.addDropZone(e.dropzones[r])}}var m=null;o=this.getColumns();for(var r=0,s=o.length;r<s;r++){a=o[r].getId();if(!BX.util.in_array(a,i)){m=o[r]}}if(m!==null){this.addClassEar()}this.fadeIn();this.resetMultiSelectMode();if(typeof n!=="undefined"){n.fulfill()}}.bind(this),function(e){if(typeof n!=="undefined"){n.reject()}this.fadeIn()}.bind(this))},clearItemMoving:function(){this.itemMoving=null},addClassEar:function(){var e=document.querySelector(".main-kanban-ear-right");e.classList.contains("crm-kanban-ear-animate")?BX.removeClass("crm-kanban-ear-animate"):null;BX.addClass(e,"crm-kanban-ear-animate")},toggleCC:function(){var e=BX.PopupMenu.getCurrentMenu();if(e){e.close()}if(this.ccItem){var t=this.getData();if(t.contactCenterShow){this.hideItem(this.ccItem)}else{this.unhideItem(this.ccItem)}t.contactCenterShow=!t.contactCenterShow}this.ajax({action:"toggleCC"},function(){}.bind(this),function(e){}.bind(this))},toggleRest:function(){if(this.restItem){this.hideItem(this.restItem)}this.ajax({action:"toggleRest"},function(){}.bind(this),function(e){}.bind(this))},unhideItem:function(e){e=this.getItem(e);if(!e||e.isVisible()){return false}e.setOptions({visible:true});if(e.layout.container&&e.layout.container.classList.contains("main-kanban-item-disabled")){BX.removeClass(e.layout.container,"main-kanban-item-disabled")}if(e.isCountable()){e.getColumn().incrementTotal()}e.getColumn().render();return true},addMenuAdditionalFields:function(e){var t=BX.PopupMenu.getCurrentMenu(e);var i=t.getMenuItems();if(t&&i&&t.bindElement&&BX(t.bindElement)&&BX.hasClass(BX(t.bindElement),"ui-btn-icon-setting")){var n=i.length>0?i[0].getId():0;var a=[{text:BX.message("CRM_KANBAN_SETTINGS_FIELDS_VIEW"),onclick:function(e,t){this.showFieldsSelectPopup("view")}.bind(this)}];if(this.getData().entityType!=="ORDER"){a.push({text:BX.message("CRM_KANBAN_SETTINGS_FIELDS_EDIT"),onclick:function(e,t){var i=this.columnsOrder[0]?this.columnsOrder[0].id:null;if(i&&this.columns[i].canAddItem){this.columns[i].showQuickEditor(true);this.showFieldsSelectPopup("edit")}}.bind(this)})}t.addMenuItem({text:BX.message("CRM_KANBAN_SETTINGS_TITLE"),items:a},n)}},addMenuToggleCS:function(e){var t=this.getData();var i=BX.PopupMenu.getCurrentMenu(e);if(i&&i.bindElement&&BX(i.bindElement)&&BX.hasClass(BX(i.bindElement),"ui-btn-icon-setting")){i.addMenuItem({text:"",delimiter:true},null);i.addMenuItem({text:t.contactCenterShow?BX.message("CRM_KANBAN_HIDE_CC"):BX.message("CRM_KANBAN_SHOW_CC"),onclick:function(e,t){this.toggleCC()}.bind(this)},null)}},getQuickEditor:function(){var e=this.getColumns();for(var t=0,i=e.length;t<i;t++){var n=e[t].getQuickEditor();if(n){return n}}return null},showFieldsSelectPopup:function(e){if(!this.fieldsSelectors.hasOwnProperty(e)){var t=this.getData();this.fieldsSelectors[e]=new BX.Crm.Kanban.FieldsSelector({entityTypeName:t.entityType,type:e,sections:t.customSectionsFields,headersSections:t.headersSections||{},defaultHeaderSectionId:t.defaultHeaderSectionId||null,selectedFields:e==="view"?t.customFields:t.customEditFields,ignoredFields:t.customDisabledFields,onSelect:function(i){var n=[];if(e==="view"){n=t.customFields;t.customFields=Object.keys(i)}else{n=t.customEditFields;t.customEditFields=Object.keys(i)}this.ajax({action:"saveFields",fields:i,type:e},function(){if(e==="view"){this.onApplyFilter()}else{this.applyCustomEditFields(t.customEditFields,n)}}.bind(this))}.bind(this)})}this.fieldsSelectors[e].show()},applyCustomEditFields:function(e,t){var i=this.getQuickEditor().getControlById("main");var n=e.filter((function(e){return t.indexOf(e)<0&&i.getChildById(e)===null}));var a=t.filter((function(t){return e.indexOf(t)<0&&i.getChildById(t)!==null}));var o=this.getColumns();for(var r=0;r<o.length;r++){var s=o[r].getQuickEditor();if(!s){continue}var l;for(var d=0;d<n.length;d++){l=s.getAvailableSchemeElementByName(n[d]);if(l){var m=s.createControl(l.getType(),l.getName(),{schemeElement:l,model:s._model,mode:s._mode});if(m){s.getControlById("main").addChild(m,{layout:{forceDisplay:true},enableSaving:false})}}}for(var u=0;u<a.length;u++){l=s.getSchemeElementByName(a[u]);if(l){var c=s.getControlById("main");var h=c.getChildById(a[u]);if(h){c.removeChild(h,{enableSaving:false})}}}s.commitSchemeChanges()}this.getQuickEditor().saveSchemeChanges().then((function(){for(var e=0;e<o.length;e++){var t=o[e].getQuickEditor();if(t){t.refreshLayout()}}}))},destroyFieldsSelectPopup:function(){var e=BX.Main.PopupManager.getPopupById("kanban_custom_fields");if(e){e.destroy()}},onApplyFilterCounter:function(e,t){setTimeout(BX.delegate((function(){var e=this.getData();var i={ASSIGNED_BY_ID:{0:t["userId"]},ASSIGNED_BY_ID_label:[t["userName"]],ACTIVITY_COUNTER:{0:t["counterTypeId"]}};var n=BX.Main.filterManager.getById(e.gridId);var a=n.getApi();a.setFields(i);a.apply({COUNTER:this.getAnalyticsLabel(t["counterTypeId"])})}),this),0);t["cancel"]=true},getAnalyticsLabel:function(e){var t=this.getData().entityType;if(t&&e){return"CRM_"+t+"_COUNTER_TYPE_"+e}return""},onPartialEditorClose:function(e,t){BX.removeClass(this.itemMoving.item.layout.container,"main-kanban-item-waiting");if(t.isCancelled){return}var i=false;if(t.entityData){var n=this.itemMoving.item.getData();var a=this.itemMoving.newColumn.getId();if(n.required&&n.required[a]){var o=n.required[a];var r=false;var s={};for(var l in n.required_fm){if(t.entityData[l]){n.required_fm[l]=false;s[l]=true}}var d=[];for(var m=0,u=o.length;m<u;m++){var c=o[m];if(s[c]){r=false}else if(t.entityData[c]&&(typeof t.entityData[c]==="object"&&t.entityData[c].IS_EMPTY===false||typeof t.entityData[c]!=="object"&&t.entityData[c]!=="")){r=false}else if(c==="OPPORTUNITY_WITH_CURRENCY"&&parseFloat(t.entityData["OPPORTUNITY"])>0){this.itemMoving.item.setDataKey("runtimePrice",true);r=false}else if(c==="CLIENT"&&(parseInt(t.entityData["CONTACT_ID"])>0||parseInt(t.entityData["COMPANY_ID"])>0)){r=false}else if(c==="FILES"&&(BX.Type.isArray(t.entityData["STORAGE_ELEMENT_IDS"])&&t.entityData["STORAGE_ELEMENT_IDS"].reduce((function(e,t){return e+t}),0)>0)){r=false}else if(c==="OBSERVER"&&t.entityData["OBSERVER_IDS"].length){r=false}else{r=true}if(!r){for(var h in n.required){var g=n.required[h];for(var f=0,p=g.length;f<p;f++){if(g[f]===c){g=BX.util.deleteFromArray(g,f);break}}n.required[h]=g}}else{i=true}}this.itemMoving.item.setDataKey("required",n.required);this.itemMoving.item.setDataKey("required_fm",n.required_fm);if(t.entityData["OPPORTUNITY"]){this.itemMoving.price=parseFloat(t.entityData["OPPORTUNITY"]);this.itemMoving.item.setDataKey("price",this.itemMoving.price);this.itemMoving.item.setDataKey("price_formatted",t.entityData["FORMATTED_OPPORTUNITY_WITH_CURRENCY"])}}}if(this.itemMoving.newColumn instanceof BX.Kanban.DropZone){this.itemMoving.newColumn.captureItem(this.itemMoving.item)}else{if(!i){this.moveItem(this.itemMoving.item,this.itemMoving.newColumn,this.itemMoving.newNextSibling)}}},onPullEventHandlerCrm:function(e,t){var i=this.getData();if(e==="notify"){if(i.entityType==="INVOICE"&&t.settingName==="crm|invoice_responsible_changed"){var n=t.originalTag.match(new RegExp("CRM\\|"+i.entityType+"\\|([\\d]+)"));if(n&&n[1]){this.loadNew(n[1])}}}},onCrmActivityTodoChecked:function(e,t,i,n){var a=this.getItem(t);if(a){if(n){var o=a.getDataKey("activityErrorTotal");o--;a.setDataKey("activityErrorTotal",o)}var r=a.getDataKey("activityProgress");r--;a.setDataKey("activityProgress",r);a.switchPlanner()}},onSliderClose:function(e){var t=this.getData();var i=t.entityPath;var n=e.slider.getUrl();i=i.replace(/\#([^\#]+)\#/,"([\\d]+)");var a=n.match(new RegExp(i));if(a&&a[1]){this.loadNew(a[1],false,true,true)}},onPopupShow:function(e){var t=["menu-popup-toolbar_lead_list_menu","menu-popup-toolbar_deal_list_menu","menu-popup-toolbar_order_kanban_menu","menu-popup-toolbar_quote_list_menu"];var i=["menu-popup-toolbar_order_kanban_menu","menu-popup-toolbar_quote_list_menu"];if(t.indexOf(e.uniquePopupId)!==-1){var n=e.uniquePopupId.substr(11);this.addMenuAdditionalFields(n);if(i.indexOf(e.uniquePopupId)===-1){this.addMenuToggleCS(n)}}},setMultiSelectMode:function(){this.multiSelectMode=true;this.setKanbanDragMode()},initActionPanel:function(){var e=this.getData();var t=document.querySelector(".pagetitle-wrap");if(!t){t=document.getElementById("uiToolbarContainer")}this.actionPanel=new BX.UI.ActionPanel({renderTo:t,removeLeftPosition:true,maxHeight:58,parentPosition:"bottom",autoHide:false});this.actionPanel.draw();this.actionPanel.appendItem({id:"kanban_delete",text:BX.message("CRM_KANBAN_PANEL_DELETE"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-delete.svg",onclick:function(){BX.CRM.Kanban.Actions.deleteAll(this)}.bind(this)});if(this.getTypeInfoParam("canUseIgnoreItemInPanel")){this.actionPanel.appendItem({id:"kanban_ignore",text:BX.message("CRM_KANBAN_PANEL_IGNORE"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-ignore.svg",onclick:function(){BX.CRM.Kanban.Actions.ignore(this)}.bind(this)})}var i=[],n=[],a=this.getColumns(),o=this.getDropZoneArea().getDropZones();for(var r=0,s=a.length;r<s;r++){n.push({id:a[r].id,name:a[r].name})}for(var r=0,s=o.length;r<s;r++){var l=o[r].getData();if(e.entityType==="LEAD"&&l.type==="LOOSE"||e.entityType!=="LEAD"&&l.type){n.push({id:o[r].id,name:o[r].name})}}for(var r=0,s=n.length;r<s;r++){i.push({id:"kanban_column_"+n[r].id,column:n[r],text:BX.util.htmlspecialchars(n[r].name),onclick:function(e,t){t.menuWindow.close();BX.CRM.Kanban.Actions.changeColumn(this,t.column)}.bind(this)})}this.actionPanel.appendItem({id:"kanban_column",text:e.entityType==="DEAL"||e.isDynamicEntity?BX.message("CRM_KANBAN_PANEL_STAGE"):BX.message("CRM_KANBAN_PANEL_STATUS"),items:i,icon:e.entityType==="DEAL"||e.isDynamicEntity?"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-stage.svg":"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-status.svg"});if(e.categories&&e.categories.length){var i=[],n=e.categories;for(var r=0,s=n.length;r<s;r++){i.push({id:"kanban_category_"+n[r].ID,category:n[r],text:BX.util.htmlspecialchars(n[r].NAME),onclick:function(e,t){t.menuWindow.close();BX.CRM.Kanban.Actions.changeCategory(this,t.category)}.bind(this)})}this.actionPanel.appendItem({id:"kanban_category",text:BX.message("CRM_KANBAN_PANEL_CATEGORY"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-fulling.svg",items:i})}if(typeof BX.Crm.EntityEditorUserSelector!=="undefined"){this.actionPanel.appendItem({id:"kanban_assigned",text:BX.message("CRM_KANBAN_PANEL_ASSIGNED"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-responsible.svg",onclick:function(e,t){setTimeout(function(){var e=BX.Crm.EntityEditorUserSelector.create("selector_assigned",{callback:function(t,i){BX.CRM.Kanban.Actions.setAssigned(this,i);e.close()}.bind(this)});var i=t.layout.container===undefined?t.actionPanel.layout.more:t.layout.container;e.open(i)}.bind(this),100)}.bind(this)})}if(this.getTypeInfoParam("canUseCreateTaskInPanel")){this.actionPanel.appendItem({id:"kanban_task",text:BX.message("CRM_KANBAN_PANEL_TASK"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-create.svg",onclick:function(){BX.CRM.Kanban.Actions.task(this)}.bind(this)})}if(this.getTypeInfoParam("canUseCallListInPanel")){this.actionPanel.appendItem({id:"kanban_calllist",text:BX.message("CRM_KANBAN_PANEL_CALLLIST"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-call.svg",onclick:function(){BX.CRM.Kanban.Actions.startCallList(this,false)}.bind(this)})}if(this.getTypeInfoParam("canUseMergeInPanel")){this.actionPanel.appendItem({id:"kanban_merge",text:BX.message("CRM_KANBAN_PANEL_MERGE"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-merge.svg",onclick:function(){BX.CRM.Kanban.Actions.merge(this)}.bind(this)})}},startActionPanel:function(){if(!this.actionPanel){this.initActionPanel()}this.actionPanel.showPanel()},stopActionPanel:function(e){if(!this.actionPanel){return}if(e||!this.getChecked().length){this.actionPanel.hidePanel()}},resetActionPanel:function(){if(this.actionPanel){this.actionPanel.removeItems();this.actionPanel=null}},reload:function(){this.resetMultiSelectMode();this.unSetKanbanDragMode();this.onApplyFilter()},calculateTotalCheckItems:function(){if(!this.actionPanel){this.initActionPanel()}this.actionPanel.setTotalSelectedItems(this.getChecked().length)},isMultiSelectMode:function(){return this.multiSelectMode},onMultiSelectMode:function(){if(this.multiSelectMode)return;this.multiSelectMode=true;BX.addClass(this.layout.gridContainer,"crm-kanban-multi-select-mode")},resetMultiSelectMode:function(){for(var e=0;e<this.getChecked().length;e++){this.getChecked()[e].unSelectItem();if(this.getChecked()[e].layout.container&&this.getChecked()[e].layout.container.classList.contains("main-kanban-item-disabled")){BX.removeClass(this.getChecked()[e].layout.container,"main-kanban-item-disabled")}}this.checkedItems=[];this.actionItems=[];this.multiSelectMode=false;BX.removeClass(this.layout.gridContainer,"crm-kanban-multi-select-mode")},onOpenEditorMenu:function(e,t){var i=this.getData();var n=this.getQuickEditor();if(n){i.customEditFields=[];var a=n.getControlById("main");for(var o=0,r=a._fields.length;o<r;o++){i.customEditFields.push(a._fields[o].getId())}this.setData(i)}var s=[],l=null;s.push({id:s.length+1,text:BX.message("CRM_KANBAN_CUSTOM_FIELDS_VIEW"),onclick:function(){this.showFieldsSelectPopup("view",e)}.bind(this)});s.push({id:s.length+1,text:BX.message("CRM_KANBAN_CUSTOM_FIELDS_EDIT"),onclick:function(){this.showFieldsSelectPopup("edit",e)}.bind(this)});l=new BX.PopupMenuWindow("crm-kanban-qiuck-form-add-fields-popup",e._addChildButton,s,{autohide:true,bindOptions:{forceBindPosition:true},autoHide:true,cacheable:false,closeByEsc:true});l.show();t["cancel"]=true},onConfigEditorScopeChange:function(){this.onApplyFilter()},onConfigEditorReset:function(){this.setAjaxParams({editorReset:"Y"});this.onApplyFilter()},onForceCommonEditorConfigScopeForAll:function(){this.setAjaxParams({editorSetCommon:"Y"});this.onApplyFilter()},insertItem:function(e){var t=null;var i=this.getColumn(e.getData().columnId);if(i){if(e!==i.getFirstItem()){t=i.getFirstItem()}else if(e===i.getFirstItem()&&i.getItemsCount()>1){t=i.getNextItemSibling(i.getFirstItem())}this.moveItem(e,e.getData().columnId,t)}else{this.removeItem(e)}},removeItem:function(e){var t=this.getItem(e);if(t){t.useAnimation=true;var i=t.getColumn();delete this.items[t.getId()];i.removeItem(t);t.dispose()}return t},openPartialEditor:function(e,t,i){var n=this.getData();var a={};var o={entityTypeId:n.entityTypeInt,entityId:e,fieldNames:i,context:a};a[this.getTypeInfoParam("stageIdKey")]=t;a["NOT_CHANGE_STATUS"]="Y";if(this.getTypeInfoParam("useFactoryBasedApproach")){o.title=BX.message("CRM_TYPE_ITEM_PARTIAL_EDITOR_TITLE");o.isController=true;o.entityTypeName=n.entityType;o.stageId=t}else{o.title=BX.message("CRM_KANBAN_REQUIRED_FIELDS_TITLE_"+n.entityType)}this.progressBarEditor=BX.Crm.PartialEditorDialog.create("progressbar-entity-editor",o);window.setTimeout(function(){this.progressBarEditor.open()}.bind(this),150)},getTypeInfoParam:function(e){var t=this.getTypeInfo();return t[e]?t[e]:false},getTypeInfo:function(){return this.getData().typeInfo}}})();
//# sourceMappingURL=grid.map.js