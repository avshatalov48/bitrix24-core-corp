this.BX=this.BX||{};this.BX.CRM=this.BX.CRM||{};(function(e,s){"use strict";const t={BY_ID:"BY_ID",BY_LAST_ACTIVITY_TIME:"BY_LAST_ACTIVITY_TIME",isDefined(e){return e===this.BY_ID||e===this.BY_LAST_ACTIVITY_TIME},getAll(){return[this.BY_ID,this.BY_LAST_ACTIVITY_TIME]}};Object.freeze(t);var r=babelHelpers.classPrivateFieldLooseKey("supportedTypes");var l=babelHelpers.classPrivateFieldLooseKey("currentType");class i{constructor(e,i){Object.defineProperty(this,r,{writable:true,value:void 0});Object.defineProperty(this,l,{writable:true,value:void 0});e=s.Type.isArray(e)?e:[];babelHelpers.classPrivateFieldLooseBase(this,r)[r]=e.filter((e=>t.isDefined(e)));if(babelHelpers.classPrivateFieldLooseBase(this,r)[r].length<=0){throw new Error("No valid supported types provided")}if(!s.Type.isString(i)||!t.isDefined(i)){throw new Error("currentType is not a valid sort type")}if(!babelHelpers.classPrivateFieldLooseBase(this,r)[r].includes(i)){throw new Error("currentType is not supported")}babelHelpers.classPrivateFieldLooseBase(this,l)[l]=i}getSupportedTypes(){return babelHelpers.classPrivateFieldLooseBase(this,r)[r]}isTypeSupported(e){return babelHelpers.classPrivateFieldLooseBase(this,r)[r].includes(e)}getCurrentType(){return babelHelpers.classPrivateFieldLooseBase(this,l)[l]}static createFromJson(e){const{supportedTypes:s,currentType:t}=JSON.parse(e);return new i(s,t)}}let a=null;var o=babelHelpers.classPrivateFieldLooseKey("grid");var n=babelHelpers.classPrivateFieldLooseKey("settings");var c=babelHelpers.classPrivateFieldLooseKey("sortChangePromise");class b{static get Instance(){if(window.top!==window&&s.Reflection.getClass("top.BX.CRM.Kanban.Sort.SettingsController")){return window.top.BX.CRM.Kanban.Sort.SettingsController}if(!a){throw new Error("SettingsController must be inited before use")}return a}static init(e,s){if(a){console.warn("Attempt to re-init SettingsController");return}a=new b(e,s)}constructor(e,s){Object.defineProperty(this,o,{writable:true,value:void 0});Object.defineProperty(this,n,{writable:true,value:void 0});Object.defineProperty(this,c,{writable:true,value:null});if(a){throw new Error("SettingsController is a singleton, another instance exists already. Use Instance to access it")}if(!(e instanceof BX.CRM.Kanban.Grid)){console.error(e);throw new Error("grid should be an instance of BX.CRM.Kanban.Grid")}babelHelpers.classPrivateFieldLooseBase(this,o)[o]=e;if(!(s instanceof i)){console.error(s);throw new Error("settings should be an instance of Settings")}babelHelpers.classPrivateFieldLooseBase(this,n)[n]=s}setCurrentSortType(e){if(!babelHelpers.classPrivateFieldLooseBase(this,c)[c]){babelHelpers.classPrivateFieldLooseBase(this,c)[c]=babelHelpers.classPrivateFieldLooseBase(this,o)[o].setCurrentSortType(e).then((()=>{babelHelpers.classPrivateFieldLooseBase(this,n)[n]=new i(babelHelpers.classPrivateFieldLooseBase(this,n)[n].getSupportedTypes(),e);babelHelpers.classPrivateFieldLooseBase(this,o)[o].reload()})).catch((e=>{console.error(e);throw e})).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,c)[c]=null}))}return babelHelpers.classPrivateFieldLooseBase(this,c)[c]}getCurrentSettings(){return babelHelpers.classPrivateFieldLooseBase(this,n)[n]}}var p=babelHelpers.classPrivateFieldLooseKey("sortType");var d=babelHelpers.classPrivateFieldLooseKey("items");var u=babelHelpers.classPrivateFieldLooseKey("extractId");var v=babelHelpers.classPrivateFieldLooseKey("extractTimestamp");var h=babelHelpers.classPrivateFieldLooseKey("calcById");var B=babelHelpers.classPrivateFieldLooseKey("calcByLastActivityTime");var f=babelHelpers.classPrivateFieldLooseKey("findFirstDifferentItem");class P{static createWithCurrentSortType(e){return new P(b.Instance.getCurrentSettings().getCurrentType(),e)}constructor(e,r){Object.defineProperty(this,f,{value:H});Object.defineProperty(this,B,{value:F});Object.defineProperty(this,h,{value:T});Object.defineProperty(this,v,{value:L});Object.defineProperty(this,u,{value:y});Object.defineProperty(this,p,{writable:true,value:void 0});Object.defineProperty(this,d,{writable:true,value:void 0});if(!t.isDefined(e)){throw new Error("Undefined sort type")}babelHelpers.classPrivateFieldLooseBase(this,p)[p]=e;babelHelpers.classPrivateFieldLooseBase(this,d)[d]=s.Type.isArray(r)?r:[]}getSortType(){return babelHelpers.classPrivateFieldLooseBase(this,p)[p]}getSortedItems(){let e;if(babelHelpers.classPrivateFieldLooseBase(this,p)[p]===t.BY_ID){e=babelHelpers.classPrivateFieldLooseBase(this,u)[u]}else if(babelHelpers.classPrivateFieldLooseBase(this,p)[p]===t.BY_LAST_ACTIVITY_TIME){e=babelHelpers.classPrivateFieldLooseBase(this,v)[v]}else{throw new Error("Unknown sort type")}const s=Array.from(babelHelpers.classPrivateFieldLooseBase(this,d)[d]);s.sort(((s,t)=>e(t)-e(s)));return s}calcBeforeItem(e){const t=e.getData().sort;return s.Type.isPlainObject(t)?this.calcBeforeItemByParams(t):null}calcBeforeItemByParams(e){const r=s.Text.toInteger(e==null?void 0:e.id);if(r<=0){return null}if(babelHelpers.classPrivateFieldLooseBase(this,p)[p]===t.BY_ID){return babelHelpers.classPrivateFieldLooseBase(this,h)[h](r)}else if(babelHelpers.classPrivateFieldLooseBase(this,p)[p]===t.BY_LAST_ACTIVITY_TIME){const t=s.Text.toInteger(e==null?void 0:e.lastActivityTimestamp);if(t<=0){return null}return babelHelpers.classPrivateFieldLooseBase(this,B)[B](r,t)}else{throw new Error("Unknown sort type")}}}function y(e){var t,r;return s.Text.toInteger((t=e.getData())==null?void 0:(r=t.sort)==null?void 0:r.id)}function L(e){var t,r;return s.Text.toInteger((t=e.getData())==null?void 0:(r=t.sort)==null?void 0:r.lastActivityTimestamp)}function T(e){const s=babelHelpers.classPrivateFieldLooseBase(this,d)[d];for(let t=0;t<s.length;t++){const r=s[t];if(babelHelpers.classPrivateFieldLooseBase(this,u)[u](r)===e){return babelHelpers.classPrivateFieldLooseBase(this,f)[f](e,s,t)}}return null}function F(e,s){const t=this.getSortedItems();for(let r=0;r<t.length;r++){const l=t[r];if(babelHelpers.classPrivateFieldLooseBase(this,v)[v](l)<=s){return babelHelpers.classPrivateFieldLooseBase(this,f)[f](e,t,r)}}if(t.length>0){return t[t.length-1]}return null}function H(e,s,t){for(let r=t;r<s.length;r++){const t=s[r];if(e!==babelHelpers.classPrivateFieldLooseBase(this,u)[u](t)){return t}}return null}const g=s.Reflection.namespace("BX.CRM.Kanban.Sort");g.Sorter=P;g.Settings=i;g.SettingsController=b;g.Type=t;e.Sorter=P;e.Settings=i;e.SettingsController=b;e.Type=t})(this.BX.CRM.Kanban=this.BX.CRM.Kanban||{},BX);
//# sourceMappingURL=sort.bundle.map.js