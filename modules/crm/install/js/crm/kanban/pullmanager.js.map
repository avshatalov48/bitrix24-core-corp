{"version":3,"file":"pullmanager.js","sources":["src/pullqueue.js","src/pullmanager.js"],"sourcesContent":["import {Reflection} from \"main.core\";\n\nconst namespace = Reflection.namespace('BX.Crm.Kanban');\n\nexport default class PullQueue\n{\n\t#queue;\n\t#grid;\n\t#isProgress;\n\n\tconstructor(grid)\n\t{\n\t\tthis.#grid = grid;\n\t\tthis.#queue = [];\n\t\tthis.#isProgress = false;\n\t}\n\n\tloadItem(isForce)\n\t{\n\t\tisForce = (isForce || false);\n\t\tif (this.#isProgress && !isForce)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst id = this.pop();\n\n\t\tif (id)\n\t\t{\n\t\t\tthis.#isProgress = true;\n\t\t\tthis.#grid.loadNew(id, false, true).then(\n\t\t\t\tfunction (response)\n\t\t\t\t{\n\t\t\t\t\tif (this.peek())\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.loadItem(true);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#isProgress = false;\n\t\t\t\t\t}\n\t\t\t\t}.bind(this)\n\t\t\t);\n\t\t}\n\t}\n\n\tpush(id)\n\t{\n\t\tid = parseInt(id, 10);\n\t\tconst index = this.getAll().indexOf(id);\n\n\t\tif (index !== -1)\n\t\t{\n\t\t\tthis.splice(index);\n\t\t}\n\n\t\tthis.#queue.push(id);\n\t\treturn this;\n\t}\n\n\tpop()\n\t{\n\t\treturn this.#queue.shift();\n\t}\n\n\tpeek()\n\t{\n\t\treturn (this.#queue.length ? this.#queue[0] : null)\n\t}\n\n\tgetAll()\n\t{\n\t\treturn this.#queue;\n\t}\n\n\tsplice(index)\n\t{\n\t\tthis.#queue.splice(index, 1);\n\t}\n}\n","import {Text, Event, Type, Reflection} from 'main.core';\nimport PullQueue from \"./pullqueue\";\n\nconst namespace = Reflection.namespace('BX.Crm.Kanban');\n\nexport default class PullManager\n{\n\tgrid;\n\tqueue;\n\n\tconstructor(grid)\n\t{\n\t\tthis.grid = grid;\n\t\tthis.queue = new PullQueue(this.grid);\n\t\tif (\n\t\t\tType.isString(grid.getData().moduleId)\n\t\t\t&& grid.getData().userId > 0\n\t\t)\n\t\t{\n\t\t\tthis.init();\n\t\t}\n\t}\n\n\tinit()\n\t{\n\t\tEvent.ready(() =>\n\t\t{\n\t\t\tconst Pull = BX.PULL;\n\t\t\tif (!Pull)\n\t\t\t{\n\t\t\t\tconsole.error('pull is not initialized');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tPull.subscribe({\n\t\t\t\tmoduleId: this.grid.getData().moduleId,\n\t\t\t\tcommand: this.grid.getData().pullTag,\n\t\t\t\tcallback: (params) =>\n\t\t\t\t{\n\t\t\t\t\tif (Type.isString(params.eventName))\n\t\t\t\t\t{\n\t\t\t\t\t\tif (params.eventName === 'ITEMUPDATED')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.onPullItemUpdated(params);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (params.eventName === 'ITEMADDED')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.onPullItemAdded(params);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (params.eventName === 'ITEMDELETED')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.onPullItemDeleted(params);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (params.eventName === 'STAGEADDED')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.onPullStageAdded(params);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (params.eventName === 'STAGEDELETED')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.onPullStageDeleted(params);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (params.eventName === 'STAGEUPDATED')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.onPullStageUpdated(params);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t});\n\t\t\tPull.extendWatch(this.grid.getData().pullTag);\n\t\t});\n\t}\n\n\tonPullItemUpdated(params)\n\t{\n\t\tif (this.updateItem(params))\n\t\t{\n\t\t\tthis.queue.loadItem();\n\t\t}\n\t}\n\n\tupdateItem(params)\n\t{\n\t\tconst item = this.grid.getItem(params.item.id);\n\t\tconst paramsItem = params.item;\n\n\t\tif (item)\n\t\t{\n\t\t\tconst oldPrice = parseFloat(item.data.price);\n\t\t\tconst oldColumnId = item.data.columnId;\n\n\t\t\tfor (let key in paramsItem.data)\n\t\t\t{\n\t\t\t\tif (key in item.data)\n\t\t\t\t{\n\t\t\t\t\titem.data[key] = paramsItem.data[key];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\titem.rawData = paramsItem.rawData;\n\t\t\titem.setActivityExistInnerHtml();\n\t\t\titem.useAnimation = true;\n\t\t\titem.setChangedInPullRequest();\n\t\t\tthis.grid.resetMultiSelectMode();\n\n\t\t\titem.preventNextFieldsRendering();\n\t\t\tthis.grid.insertItem(item);\n\n\t\t\tconst newColumn = this.grid.getColumn(paramsItem.data.columnId);\n\t\t\tconst newPrice = parseFloat(paramsItem.data.price);\n\n\t\t\tif (oldColumnId !== paramsItem.data.columnId)\n\t\t\t{\n\t\t\t\tconst oldColumn = this.grid.getColumn(oldColumnId);\n\t\t\t\toldColumn.decPrice(oldPrice);\n\t\t\t\toldColumn.renderSubTitle();\n\n\t\t\t\tnewColumn.incPrice(newPrice);\n\t\t\t\tnewColumn.renderSubTitle();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (oldPrice < newPrice)\n\t\t\t\t{\n\t\t\t\t\tnewColumn.incPrice(newPrice - oldPrice);\n\t\t\t\t\tnewColumn.renderSubTitle();\n\t\t\t\t}\n\t\t\t\telse if (oldPrice > newPrice)\n\t\t\t\t{\n\t\t\t\t\tnewColumn.decPrice(oldPrice - newPrice);\n\t\t\t\t\tnewColumn.renderSubTitle();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\titem.columnId = paramsItem.data.columnId;\n\t\t\tthis.queue.push(item.id);\n\n\t\t\treturn true;\n\t\t}\n\n\t\tthis.onPullItemAdded(params);\n\t\treturn false\n\t}\n\n\tonPullItemAdded(params)\n\t{\n\t\tthis.addItem(params);\n\t\tthis.queue.loadItem();\n\t}\n\n\taddItem(params)\n\t{\n\t\tconst oldItem = this.grid.getItem(params.item.id);\n\t\tif (oldItem)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.grid.addItemTop(params.item);\n\t\tthis.queue.push(params.item.id);\n\t}\n\n\tonPullItemDeleted(params)\n\t{\n\t\tif (!Type.isPlainObject(params.item))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.grid.removeItem(params.item.id);\n\n\t\tconst column = this.grid.getColumn(params.item.data.columnId);\n\t\tcolumn.decPrice(params.item.data.price);\n\t\tcolumn.renderSubTitle();\n\t}\n\n\tonPullStageAdded(params)\n\t{\n\t\tthis.grid.onApplyFilter();\n\t}\n\n\tonPullStageDeleted(params)\n\t{\n\t\tthis.grid.removeColumn(params.stage.id);\n\t}\n\n\tonPullStageUpdated(params)\n\t{\n\t\tthis.grid.onApplyFilter();\n\t}\n}\n\nnamespace.PullManager = PullManager;\n"],"names":["namespace","Reflection","PullQueue","grid","isForce","id","pop","loadNew","then","response","peek","loadItem","bind","parseInt","index","getAll","indexOf","splice","push","shift","length","PullManager","queue","Type","isString","getData","moduleId","userId","init","Event","ready","Pull","BX","PULL","console","error","subscribe","command","pullTag","callback","params","eventName","onPullItemUpdated","onPullItemAdded","onPullItemDeleted","onPullStageAdded","onPullStageDeleted","onPullStageUpdated","extendWatch","updateItem","item","getItem","paramsItem","oldPrice","parseFloat","data","price","oldColumnId","columnId","key","rawData","setActivityExistInnerHtml","useAnimation","setChangedInPullRequest","resetMultiSelectMode","preventNextFieldsRendering","insertItem","newColumn","getColumn","newPrice","oldColumn","decPrice","renderSubTitle","incPrice","addItem","oldItem","addItemTop","isPlainObject","removeItem","column","onApplyFilter","removeColumn","stage"],"mappings":"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"}