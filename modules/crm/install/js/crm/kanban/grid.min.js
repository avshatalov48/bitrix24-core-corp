(function(){"use strict";BX.namespace("BX.CRM.Kanban");BX.CRM.Kanban.Grid=function(t){BX.Kanban.Grid.apply(this,arguments);BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemCaptured",BX.delegate(this.onBeforeItemCaptured,this));BX.addCustomEvent(this,"Kanban.DropZone:onBeforeItemRestored",BX.delegate(this.onBeforeItemRestored,this));BX.addCustomEvent(this,"Kanban.Grid:onBeforeItemMoved",BX.delegate(this.onBeforeItemMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onItemMoved",BX.delegate(this.onItemMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnAddedAsync",BX.delegate(this.onColumnAddedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnUpdated",BX.delegate(this.onColumnUpdated,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnMoved",BX.delegate(this.onColumnMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnRemovedAsync",BX.delegate(this.onColumnRemovedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnLoadAsync",BX.delegate(this.onColumnLoadAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStart",BX.delegate(this.onItemDragStartHandler,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStart",BX.delegate(this.setKanbanDragMode,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStop",BX.delegate(this.unSetKanbanDragMode,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStop",BX.delegate(this.stopActionPanel,this));BX.addCustomEvent("BX.Main.Filter:apply",BX.delegate(this.onApplyFilter,this));BX.addCustomEvent("BX.CrmEntityCounterPanel:applyFilter",BX.delegate(this.onApplyFilterCounter,this));BX.addCustomEvent("Crm.PartialEditorDialog.Close",BX.delegate(this.onPartialEditorClose,this));BX.addCustomEvent("onPullEvent-crm",BX.proxy(this.onPullEventHandlerCrm,this));BX.addCustomEvent("onPullEvent-im",BX.proxy(this.onPullEventHandlerCrm,this));BX.addCustomEvent("onCrmActivityTodoChecked",BX.proxy(this.onCrmActivityTodoChecked,this));BX.addCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.onSliderClose,this));BX.addCustomEvent("BX.CRM.Kanban.Item.select",BX.proxy(this.startActionPanel,this));BX.addCustomEvent("BX.UI.ActionPanel:clickResetAllBlock",BX.proxy(this.resetMultiSelectMode,this));BX.addCustomEvent("onPopupShow",BX.proxy(this.onPopupShow,this));this.bindEvents()};BX.CRM.Kanban.Grid.prototype={__proto__:BX.Kanban.Grid.prototype,constructor:BX.CRM.Kanban.Grid,accessNotifyDialog:null,loadNewInterval:25,ajaxParams:{},customFieldsPopup:null,customFieldsContainer:null,actionPanel:null,currentNode:null,itemMoving:null,actionItems:[],checkedItems:[],progressBarEditor:null,ccItem:null,popupCancel:null,dropZonesShow:false,getChecked:function(){return this.checkedItems},getCheckedId:function(){var t=this.getChecked();var e=[];for(var i=0;i<t.length;i++){e.push(t[i].id)}return e},checkItem:function(t){var e=this.getItem(t);if(!BX.util.in_array(e,this.checkedItems)){e.checked=true;this.checkedItems.push(e);BX.addClass(e.checkedButton,"crm-kanban-item-checkbox-checked");BX.addClass(e.container,"crm-kanban-item-selected");BX.onCustomEvent("BX.CRM.Kanban.Item.select",[e])}},unCheckItem:function(t){var e=this.getItem(t);if(BX.util.in_array(e,this.checkedItems)){this.checkedItems.splice(this.checkedItems.indexOf(e),1);e.checked=false;BX.removeClass(e.checkedButton,"crm-kanban-item-checkbox-checked");BX.removeClass(e.container,"crm-kanban-item-selected");BX.onCustomEvent("BX.CRM.Kanban.Item.unSelect",[e])}},getPopupCancel:function(t){if(!this.popupCancel){this.popupCancel=new BX.PopupWindow("crm-kanban-popup-cancel",window,{className:"crm-kanban-popup-cancel",autoHide:false,overlay:true,maxWidth:350,buttons:[new BX.PopupWindowButton({text:"OK",className:"ui-btn ui-btn-primary",events:{click:function(){this.popupCancel.close()}.bind(this)}})],closeByEsc:true,events:{onPopupClose:function(){}.bind(this)},closeIcon:true})}this.popupCancel.setContent(t);return this.popupCancel},getItemsForAction:function(t){var e=this.getChecked();this.actionItems=[];if(t){e.splice(this.actionItems.indexOf(t),1)}for(var i=0;i<e.length;i++){this.actionItems.push(e[i].id)}return this.actionItems},bindEvents:function(){BX.bind(window,"click",function(t){if(this.dropZonesShow){return}this.isItKanban(t.target)?this.currentNode=t.target:this.currentNode=null;if(!BX.findParent(t.target,{className:"main-kanban-item"})&&!BX.findParent(t.target,{className:"ui-action-panel"})){this.resetMultiSelectMode();this.stopActionPanel();this.unSetKanbanDragMode()}}.bind(this));BX.bind(window,"keydown",function(t){if(this.dropZonesShow){return}if(t.code==="Escape"){this.resetMultiSelectMode();this.stopActionPanel();this.unSetKanbanDragMode()}}.bind(this))},isItKanban:function(t){if(BX.findParent(t,{className:"main-kanban"})){return true}},setKanbanDragMode:function(){BX.addClass(document.body,"crm-kanban-drag-mode")},unSetKanbanDragMode:function(){BX.removeClass(document.body,"crm-kanban-drag-mode")},renderLayout:function(){var t=this.getData();BX.Kanban.Grid.prototype.renderLayout.apply(this,arguments);this.setDropareaFirstItemWidth();if(this.ccItem&&!t.contactCenterShow){this.hideItem(this.ccItem)}},setDropareaFirstItemWidth:function(){var t=document.head;var e=BX.create("style",{attrs:{type:"text/css"}});var i=document.createTextNode(".main-kanban-dropzone:first-child, main-kanban-dropzone:last-child {"+"max-width: "+(this.layout.gridContainer.firstChild.offsetWidth+3)+"px; "+"min-width: "+(this.layout.gridContainer.firstChild.offsetWidth+3)+"px;}");e.appendChild(i);t.appendChild(e)},getAjaxHandlerPath:function(){var t=this.getData();return BX.type.isNotEmptyString(t.ajaxHandlerPath)?t.ajaxHandlerPath:"/bitrix/components/bitrix/crm.kanban/ajax.php"},setAjaxParams:function(t){this.ajaxParams=t},ajax:function(t,e,i,n){var a=this.getData();var o=this.getAjaxHandlerPath();if(typeof n==="undefined"){n="json"}t.sessid=BX.bitrix_sessid();t.extra=a.params;t.entity_type=a.entityType;t.version=2;t.ajaxParams=this.ajaxParams;if(t.action!=="undefined"){o+=o.indexOf("?")===-1?"?":"&";o+="action="+t.action}if(this.isMultiSelectMode()){o+="&group=yes"}BX.ajax({method:"POST",dataType:n,url:o,data:t,onsuccess:e,onfailure:i})},accessNotify:function(){if(typeof BX.Intranet!=="undefined"&&typeof BX.Intranet.NotifyDialog!=="undefined"){if(this.accessNotifyDialog===null){var t=this.getData();this.accessNotifyDialog=new BX.Intranet.NotifyDialog({listUserData:[],notificationHandlerUrl:this.getAjaxHandlerPath()+"?action=notifyAdmin&version=2&entity_type="+t.entityType,popupTexts:{sendButton:BX.message("CRM_KANBAN_NOTIFY_BUTTON"),title:BX.message("CRM_KANBAN_NOTIFY_TITLE"),header:BX.message("CRM_KANBAN_NOTIFY_HEADER"),description:BX.message("CRM_KANBAN_NOTIFY_TEXT")}})}this.accessNotifyDialog.setUsersForNotify(this.getData().admins);this.accessNotifyDialog.show()}},addStage:function(t){var e=new BX.Promise;var i=this.getPreviousColumnSibling(t);var n=i?i.getId():0;this.ajax({action:"modifyStage",columnName:t.getName(),columnColor:t.getColor(),afterColumnId:n},function(t){if(t&&!t.error){this.resetActionPanel();e.fulfill(t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal);e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},removeStage:function(t){var e=new BX.Promise;this.ajax({action:"modifyStage",columnId:t.getId(),delete:1},function(t){if(t&&!t.error){this.resetActionPanel();e.fulfill()}else if(t){e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},getColumnItems:function(t){var e=new BX.Promise;this.ajax({action:"page",page:t.getPagination().getPage()+1,column:t.getId()},function(t){if(t&&(BX.type.isArray(t)||BX.type.isArray(t.items))&&!t.error){e.fulfill(BX.type.isArray(t)?t:t.items)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal);e.reject(t.error)}if(this.ccItem){var i=this.getData();if(!i.contactCenterShow){this.hideItem(this.ccItem)}}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},addItemTop:function(t){var e=this.getColumn(t.columnId);var i=e?e.getItems():[];if(i.length>0){t.targetId=i[0].getId()}e.incPrice(t.data.price);this.addItem(t)},moveItem:function(t,e,i){t=this.getItem(t);e=this.getColumn(e);i=this.getItem(i);var n=t.getColumn();var a=e.getId();var o=this.getData();var r=e.getData();if(!t||!e||t===i){return false}if(this.getChecked().length>1){var s=false;var l=this.getChecked();for(var d=0,c=l.length;d<c;d++){var u=l[d].getData();var m=l[d].getColumn().getId();if(o.entityType==="LEAD"&&r.type==="WIN"||o.entityType==="INVOICE"){s=true;if(l.length===d+1){this.resetMultiSelectMode()}}else if(u.required&&u.required[a]&&u.required[a].length>0&&a!==m){if(u.required_fm){var h=[];for(var g=0,f=u.required[a].length;g<f;g++){var p=u.required[a][g];if(typeof u.required_fm[p]==="undefined"||u.required_fm[p]===true){h.push(u.required[a][g])}}u.required[a]=h}if(u.required[a].length>0){s=true;if(l.length===d+1){this.resetMultiSelectMode()}}}}if(s){this.getPopupCancel(BX.message("CRM_KANBAN_SET_STATUS_NOT_COMPLETED_TEXT_"+o.entityType)).show()}var v=this.getChecked();for(var d=0;d<v.length;d++){if(v[d]!==t&&v[d].getColumn()!==e){v[d].getColumn().layout.total.textContent=+v[d].getColumn().layout.total.innerHTML-1}n.removeItem(v[d])}e.addItems(this.getChecked(),i);this.resetMultiSelectMode();return}n.removeItem(t);e.addItem(t,i);return true},loadNew:function(t,e){var i=this.getData();var n=typeof t!=="undefined"?t:0;if(document.hidden){return}this.ajax(n?{action:"get",entity_id:n,force:e===true?"Y":"N"}:{action:"get",min_entity_id:i.lastId,force:e===true?"Y":"N"},function(t){if(t&&t.items){var e=false;if(t.items.length>0){var a={};for(var o=t.items.length-1;o>=0;o--){var r=t.items[o];var s=this.getItem(r.id);if(r.id<=0){continue}e=true;if(s){var l=s.getData();var d=s.getColumn();var c=this.getColumn(r.columnId);d.decPrice(parseFloat(l.price));a[d.getId()]=d;if(c){c.incPrice(parseFloat(r.data.price));this.updateItem(r.id,r);a[c.getId()]=c}else{this.removeItem(r.id)}}else if(r.id){this.addItemTop(r)}if(!n){i.lastId=r.id;this.setData(i)}}for(var u in a){a[u].renderSubTitle()}}if(!e&&n){var r=this.getItem(n);if(r){var m=r.getData();var h=r.getColumn();h.decPrice(m.price);this.removeItem(n)}}}}.bind(this),function(t){}.bind(this))},onItemDragStart:function(t){this.setDragMode(BX.Kanban.DragMode.ITEM);var e=this.getData();var i=this.getItems();var n=t.getColumn().getData();var a=t.getColumnId();if(parseInt(t.getId())<0){return}if(e.entityType==="LEAD"&&n.type==="WIN"){for(var o in i){var r=i[o].getColumnId();if(r===a){i[o].enableDropping()}}return}BX.Kanban.Grid.prototype.onItemDragStart.apply(this,arguments);if(this.progressBarEditor){this.progressBarEditor.close()}},onItemDragStartHandler:function(t){t.setLastPosition()},onColumnLoadAsync:function(t){t.push(BX.delegate(this.getColumnItems,this))},onColumnRemovedAsync:function(t){t.push(BX.delegate(this.removeStage,this))},onColumnAddedAsync:function(t){t.push(BX.delegate(this.addStage,this))},onBeforeItemCaptured:function(t){BX.onCustomEvent("Crm.Kanban.Grid:onBeforeItemCapturedStart",[this,t]);if(t.isActionAllowed()){var e=t.getItem();var i=e.getColumn();var n=t.getDropZone();this.itemMoving={item:e,price:parseFloat(e.getData().price),oldColumn:i,oldNextSiblingId:i.getNextItemSibling(e),newColumn:null,newNextSibling:null,dropEvent:t,groupIds:this.getItemsForAction()};this.onItemMoved(e,n,null,true);if(n.getId()==="DELETED"){var a=this.getItemsForAction();setTimeout(function(){BX.CRM.Kanban.Actions.delete(this,a.length?a:e.getId())}.bind(this),n.getDropZoneArea().getDropZoneTimeout())}}},onBeforeItemRestored:function(t){var e=t.getItem();var i=e.getColumn();var n=parseFloat(e.getData().price);i.incPrice(n);this.onItemMoved(e,i)},onBeforeItemMoved:function(t){var e=t.getItem();var i=e.getColumn();this.itemMoving={item:e,price:parseFloat(e.getData().price),oldColumn:i,oldNextSiblingId:i.getNextItemSibling(e),newColumn:null,newNextSibling:null}},onItemMoved:function(t,e,i,n){var a=t.getData();var o=e.getId();var r=this.getData();var s=e instanceof BX.Kanban.DropZone;if(a.required&&a.required[o]&&a.required[o].length>0&&this.itemMoving.oldColumn.getId()!==e.getId()){if(a.required_fm){var l=[];for(var d=0,c=a.required[o].length;d<c;d++){var u=a.required[o][d];if(typeof a.required_fm[u]==="undefined"||a.required_fm[u]===true){l.push(a.required[o][d])}}a.required[o]=l}if(a.required[o].length>0){this.itemMoving.newColumn=e;this.itemMoving.newNextSibling=i;if(!s){this.moveItem(this.itemMoving.item,this.itemMoving.oldColumn,this.itemMoving.oldNextSiblingId)}else{this.itemMoving.dropEvent.denyAction()}this.progressBarEditor=BX.Crm.PartialEditorDialog.create("progressbar-entity-editor",{entityTypeId:r.entityTypeInt,entityId:t.getId(),fieldNames:a.required[o],title:BX.message("CRM_KANBAN_REQUIRED_FIELDS_TITLE_"+r.entityType)});this.progressBarEditor.open();BX.addClass(t.layout.container,"main-kanban-item-waiting");return}}if(r.entityType==="LEAD"&&e.getId()==="CONVERTED"){BX.Crm.KanbanComponent.dropPopup(this,this.itemMoving.dropEvent)}if(this.itemMoving.item.getData().runtimePrice!==true){this.itemMoving.oldColumn.decPrice(this.itemMoving.price)}if(!s){e.incPrice(this.itemMoving.price);e.renderSubTitle();this.itemMoving.oldColumn.renderSubTitle()}this.itemMoving.item.setDataKey("runtimePrice",false);if(n!==true){var m={grid:this,item:t,targetColumn:e,beforeItem:i,skip:false};BX.onCustomEvent("Crm.Kanban.Grid:onItemMovedFinal",[m]);if(m.skip===true){return}}var h=0;var g=t.getId();var f=e?e.getId():0;if(e instanceof BX.Kanban.DropZone){h=0}else{var p=e.getPreviousItemSibling(t);if(p){h=p.getId()}}BX.removeClass(t.layout.container,"main-kanban-item-waiting");if(this.itemMoving.groupIds&&this.itemMoving.groupIds.length===0){this.itemMoving.groupIds.push(g)}this.ajax({action:"status",entity_id:g?g:this.itemMoving.groupIds,prev_entity_id:h,status:f},function(e){if(e&&!e.error){if(e.items&&e.items.length>0){this.updateItem(g,e.items[0])}else{t.setDataKey("columnId",f)}}else if(e){BX.Kanban.Utils.showErrorDialog(e.error,true)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},onColumnUpdated:function(t){var e=t.getId();var i=t.getName();var n=t.getColor();this.ajax({action:"modifyStage",columnId:e,columnName:i,columnColor:n},function(t){if(t&&t.error){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}else{this.resetActionPanel()}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},onColumnMoved:function(t,e){var i=t.getId();var n=this.getPreviousColumnSibling(t);var a=n?n.getId():0;this.ajax({action:"modifyStage",columnId:i,afterColumnId:a},function(t){if(t&&t.error){BX.Kanban.Utils.showErrorDialog(t.error,true)}else{this.resetActionPanel()}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},onApplyFilter:function(t,e,i,n,a){this.fadeOut();if(typeof a!=="undefined"){a.autoResolve=false}this.ajax({action:"get"},function(t){var e=[],i=null;var a=this.getColumns();for(var o=0,r=a.length;o<r;o++){i=a[o].getId();e.push(i);this.removeColumn(i)}this.removeItems();this.loadData(t);var s=this.getDropZoneArea();var l=this.getDropZoneArea().getDropZones();for(var o=0,r=l.length;o<r;o++){s.removeDropZone(l[o])}if(t.dropzones){for(var o=0,r=t.dropzones.length;o<r;o++){s.addDropZone(t.dropzones[o])}}var d=null;a=this.getColumns();for(var o=0,r=a.length;o<r;o++){i=a[o].getId();if(!BX.util.in_array(i,e)){d=a[o]}}if(d!==null){this.addClassEar()}this.fadeIn();if(typeof n!=="undefined"){n.fulfill()}}.bind(this),function(t){if(typeof n!=="undefined"){n.reject()}this.fadeIn()}.bind(this))},addClassEar:function(){var t=document.querySelector(".main-kanban-ear-right");t.classList.contains("crm-kanban-ear-animate")?BX.removeClass("crm-kanban-ear-animate"):null;BX.addClass(t,"crm-kanban-ear-animate")},toggleCC:function(){var t=BX.PopupMenu.getCurrentMenu();if(t){t.close()}if(this.ccItem){var e=this.getData();if(e.contactCenterShow){this.hideItem(this.ccItem)}else{this.unhideItem(this.ccItem)}e.contactCenterShow=!e.contactCenterShow}this.ajax({action:"toggleCC"},function(){}.bind(this),function(t){}.bind(this))},unhideItem:function(t){t=this.getItem(t);if(!t||t.isVisible()){return false}t.setOptions({visible:true});if(t.layout.container&&t.layout.container.classList.contains("main-kanban-item-disabled")){BX.removeClass(t.layout.container,"main-kanban-item-disabled")}if(t.isCountable()){t.getColumn().incrementTotal()}t.getColumn().render();return true},addMenuToggleCS:function(t){var e=this.getData();var i=BX.PopupMenu.getCurrentMenu(t);if(i&&i.bindElement&&BX(i.bindElement)&&BX.hasClass(BX(i.bindElement),"ui-btn-icon-setting")){i.addMenuItem({text:"",delimiter:true},null);i.addMenuItem({text:e.contactCenterShow?BX.message("CRM_KANBAN_HIDE_CC"):BX.message("CRM_KANBAN_SHOW_CC"),onclick:function(t,e){this.toggleCC()}.bind(this)},null)}},addMenuCustomFieldsPopup:function(t){var e=this.getData();var i=e.entityType.toLowerCase();var n=BX.PopupMenu.getCurrentMenu(t);if(n){var a=n.getMenuItems();n.addMenuItem({text:BX.message("CRM_KANBAN_CUSTOM_FIELDS"),onclick:function(){if(!this.customFieldsPopup){this.customFieldsPopup=new BX.PopupWindow("kanban_custom_fields",window.body,{closeIcon:true,offsetLeft:0,lightShadow:true,overlay:true,titleBar:{content:BX.create("span",{html:""})},draggable:true,contentColor:"white",closeByEsc:true,buttons:[new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_POPUP_SAVE"),className:"popup-window-button-accept",events:{click:function(){var t={};var e=BX.findChild(this.customFieldsContainer,{tagName:"input"},false,true);for(var i=0,n=e.length;i<n;i++){if(e[i].checked){t[e[i].getAttribute("name")]=BX.data(e[i],"label")}}this.ajax({action:"saveFields",fields:t},function(t){this.onApplyFilter()}.bind(this),function(t){}.bind(this));this.customFieldsPopup.close()}.bind(this)}}),new BX.PopupWindowButton({text:BX.message("CRM_KANBAN_POPUP_CANCEL"),className:"popup-window-button-decline",events:{click:function(){this.customFieldsPopup.close()}.bind(this)}})]});this.customFieldsPopup.setContent("wait...");this.customFieldsPopup.setTitleBar(BX.message("CRM_KANBAN_CUSTOM_FIELDS"));BX.ajax({method:"GET",dataType:"json",url:"/bitrix/components/bitrix/crm.lead.list/filter.ajax.php"+"?filter_id="+e.gridId+"&siteID="+BX.message("SITE_ID")+"&sessid="+BX.bitrix_sessid(),onsuccess:function(t){var i=[];for(var n=0,a=t.length;n<a;n++){i.push(BX.create("input",{props:{id:"cf_"+t[n].ID,type:"checkbox",name:t[n].NAME,checked:BX.util.in_array(t[n].NAME,e.customFields)},dataset:{label:t[n].LABEL}}));i.push(BX.create("label",{attrs:{for:"cf_"+t[n].ID},text:t[n].LABEL}));i.push(BX.create("br"))}this.customFieldsContainer=BX.create("div",{children:i});this.customFieldsPopup.setContent(this.customFieldsContainer);this.customFieldsPopup.adjustPosition()}.bind(this)})}this.customFieldsPopup.show()}.bind(this)},a.length>0?a[0].id:null)}},onApplyFilterCounter:function(t,e){setTimeout(BX.delegate(function(){var t=this.getData();var i={ASSIGNED_BY_ID:{0:e["userId"]},ASSIGNED_BY_ID_label:[e["userName"]],ACTIVITY_COUNTER:{0:e["counterTypeId"]}};var n=BX.Main.filterManager.getById(t.gridId);var a=n.getApi();a.setFields(i);a.apply()},this),0);e["cancel"]=true},onPartialEditorClose:function(t,e){BX.removeClass(this.itemMoving.item.layout.container,"main-kanban-item-waiting");if(e.isCancelled){return}var i=false;if(e.entityData){var n=this.itemMoving.item.getData();var a=this.itemMoving.newColumn.getId();if(n.required&&n.required[a]){var o=n.required[a];var r=false;var s={};for(var l in n.required_fm){if(e.entityData[l]){n.required_fm[l]=false;s[l]=true}}var d=[];for(var c=0,u=o.length;c<u;c++){var m=o[c];if(s[m]){r=false}else if(e.entityData[m]&&(typeof e.entityData[m]==="object"&&e.entityData[m].IS_EMPTY===false||typeof e.entityData[m]!=="object"&&e.entityData[m]!=="")){r=false}else if(m==="OPPORTUNITY_WITH_CURRENCY"&&parseFloat(e.entityData["OPPORTUNITY"])>0){this.itemMoving.item.setDataKey("runtimePrice",true);r=false}else if(m==="CLIENT"&&(parseInt(e.entityData["CONTACT_ID"])>0||parseInt(e.entityData["COMPANY_ID"])>0)){r=false}else{r=true}if(!r){for(var h in n.required){var g=n.required[h];for(var f=0,p=g.length;f<p;f++){if(g[f]===m){g=BX.util.deleteFromArray(g,f);break}}n.required[h]=g}}else{i=true}}this.itemMoving.item.setDataKey("required",n.required);this.itemMoving.item.setDataKey("required_fm",n.required_fm);if(e.entityData["OPPORTUNITY"]){this.itemMoving.price=parseFloat(e.entityData["OPPORTUNITY"]);this.itemMoving.item.setDataKey("price",this.itemMoving.price);this.itemMoving.item.setDataKey("price_formatted",e.entityData["FORMATTED_OPPORTUNITY_WITH_CURRENCY"])}}}if(this.itemMoving.newColumn instanceof BX.Kanban.DropZone){this.itemMoving.newColumn.captureItem(this.itemMoving.item)}else{this.onItemMoved(this.itemMoving.item,this.itemMoving.newColumn,this.itemMoving.newNextSibling);if(!i){this.moveItem(this.itemMoving.item,this.itemMoving.newColumn,this.itemMoving.newNextSibling)}}},onPullEventHandlerCrm:function(t,e){var i=this.getData();if(t==="activity_add"&&e.OWNER_TYPE_NAME===i.entityType){var n=this.getItem(e.OWNER_ID);if(n){this.loadNew(n.getId())}else{this.loadNew()}}if(t==="notify"){var a=e.originalTag.match(new RegExp("CRM\\|"+i.entityType+"_RESPONSIBLE\\|([\\d]+)"));if(a&&a[1]){this.loadNew(a[1])}if(i.entityType==="INVOICE"&&e.settingName==="crm|invoice_responsible_changed"){var a=e.originalTag.match(new RegExp("CRM\\|"+i.entityType+"\\|([\\d]+)"));if(a&&a[1]){this.loadNew(a[1])}}}},onCrmActivityTodoChecked:function(t,e,i,n){var a=this.getItem(e);if(a){if(n){var o=a.getDataKey("activityErrorTotal");o--;a.setDataKey("activityErrorTotal",o)}var r=a.getDataKey("activityProgress");r--;a.setDataKey("activityProgress",r);a.switchPlanner()}},onSliderClose:function(t){var e=this.getData();var i=e.entityPath;var n=t.slider.getUrl();i=i.replace(/\#([^\#]+)\#/,"([\\d]+)");var a=n.match(new RegExp(i));if(a&&a[1]){this.loadNew(a[1])}},onPopupShow:function(t){if(t.uniquePopupId=="menu-popup-toolbar_lead_list_menu"||t.uniquePopupId=="menu-popup-toolbar_deal_list_menu"){this.addMenuToggleCS(t.uniquePopupId.substr(11))}},setMultiSelectMode:function(){this.multiSelectMode=true;this.setKanbanDragMode()},initActionPanel:function(){var t=this.getData();this.actionPanel=new BX.UI.ActionPanel({renderTo:document.querySelector(".pagetitle-wrap"),removeLeftPosition:true,maxHeight:56,parentPosition:"bottom"});this.actionPanel.draw();this.actionPanel.appendItem({id:"kanban_delete",text:BX.message("CRM_KANBAN_PANEL_DELETE"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-delete.svg",onclick:function(){BX.CRM.Kanban.Actions.deleteAll(this)}.bind(this)});if(t.entityType==="LEAD"||t.entityType==="DEAL"){this.actionPanel.appendItem({id:"kanban_ignore",text:BX.message("CRM_KANBAN_PANEL_IGNORE"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-ignore.svg",onclick:function(){BX.CRM.Kanban.Actions.ignore(this)}.bind(this)})}if(t.entityType==="LEAD"||t.entityType==="DEAL"||t.entityType==="QUOTE"){var e=[],i=[],n=this.getColumns(),a=this.getDropZoneArea().getDropZones();for(var o=0,r=n.length;o<r;o++){i.push({id:n[o].id,name:n[o].name})}for(var o=0,r=a.length;o<r;o++){var s=a[o].getData();if(t.entityType==="LEAD"&&s.type==="LOOSE"||t.entityType==="DEAL"&&s.type||t.entityType==="QUOTE"&&s.type){i.push({id:a[o].id,name:a[o].name})}}for(var o=0,r=i.length;o<r;o++){e.push({id:"kanban_column_"+i[o].id,column:i[o],text:BX.util.htmlspecialchars(i[o].name),onclick:function(t,e){e.menuWindow.close();BX.CRM.Kanban.Actions.changeColumn(this,e.column)}.bind(this)})}this.actionPanel.appendItem({id:"kanban_column",text:t.entityType==="DEAL"?BX.message("CRM_KANBAN_PANEL_STAGE"):BX.message("CRM_KANBAN_PANEL_STATUS"),items:e,icon:t.entityType==="DEAL"?"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-stage.svg":"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-status.svg"})}if(t.entityType==="DEAL"){var e=[],i=t.categories;for(var o=0,r=i.length;o<r;o++){e.push({id:"kanban_category_"+i[o].ID,category:i[o],text:BX.util.htmlspecialchars(i[o].NAME),onclick:function(t,e){e.menuWindow.close();BX.CRM.Kanban.Actions.changeCategory(this,e.category)}.bind(this)})}this.actionPanel.appendItem({id:"kanban_category",text:BX.message("CRM_KANBAN_PANEL_CATEGORY"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-fulling.svg",items:e})}if(typeof BX.Crm.EntityEditorUserSelector!=="undefined"){this.actionPanel.appendItem({id:"kanban_assigned",text:BX.message("CRM_KANBAN_PANEL_ASSIGNED"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-responsible.svg",onclick:function(t,e){setTimeout(function(){var t=BX.Crm.EntityEditorUserSelector.create("selector_assigned",{callback:function(e,i){BX.CRM.Kanban.Actions.setAssigned(this,i);t.close()}.bind(this)});t.open(e.layout.container)}.bind(this),100)}.bind(this)})}if(t.entityType==="LEAD"||t.entityType==="DEAL"){this.actionPanel.appendItem({id:"kanban_task",text:BX.message("CRM_KANBAN_PANEL_TASK"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-create.svg",onclick:function(){BX.CRM.Kanban.Actions.task(this)}.bind(this)})}this.actionPanel.appendItem({id:"kanban_calllist",text:BX.message("CRM_KANBAN_PANEL_CALLLIST"),icon:"/bitrix/js/crm/kanban/images/crm-kanban-actionpanel-call.svg",onclick:function(){BX.CRM.Kanban.Actions.startCallList(this,false)}.bind(this)})},startActionPanel:function(){if(!this.actionPanel){this.initActionPanel()}this.actionPanel.showPanel()},stopActionPanel:function(){if(!this.actionPanel){return}this.actionPanel.hidePanel()},resetActionPanel:function(){if(this.actionPanel){this.actionPanel.removeItems();this.actionPanel=null}},calculateTotalCheckItems:function(){if(!this.actionPanel){this.initActionPanel()}this.actionPanel.setTotalSelectedItems(this.getChecked().length)},isMultiSelectMode:function(){return this.multiSelectMode},onMultiSelectMode:function(){if(this.multiSelectMode)return;this.multiSelectMode=true;BX.addClass(this.layout.gridContainer,"crm-kanban-multi-select-mode")},resetMultiSelectMode:function(){for(var t=0;t<this.getChecked().length;t++){this.getChecked()[t].unSelectItem();if(this.getChecked()[t].layout.container&&this.getChecked()[t].layout.container.classList.contains("main-kanban-item-disabled")){BX.removeClass(this.getChecked()[t].layout.container,"main-kanban-item-disabled")}}this.checkedItems=[];this.actionItems=[];this.multiSelectMode=false;BX.removeClass(this.layout.gridContainer,"crm-kanban-multi-select-mode")}}})();
//# sourceMappingURL=grid.map.js