{"version":3,"file":"client-selector.bundle.js","sources":["../src/client-selector.js"],"sourcesContent":["import { Loc, Text, Type } from 'main.core';\nimport type { ItemOptions } from 'ui.entity-selector';\nimport { Dialog } from 'ui.entity-selector';\n\nexport type Communication = {\n\tcaption: string,\n\tentityId: number,\n\tentityTypeId: number,\n\tentityTypeName: string,\n\tphones?: CommunicationItem[],\n\temails?: CommunicationItem[],\n}\n\nexport type CommunicationItem = {\n\tid: string,\n\ttype: string,\n\ttypeLabel: string,\n\tvalue: string,\n\tvalueFormatted: string,\n}\n\ntype SelectorEvents = {\n\t'Item:onSelect'?: Function,\n\tonShow?: Function,\n\tonHide?: Function,\n}\n\nconst DEFAULT_TAB_ID = 'client';\n\nexport class ClientSelector\n{\n\ttargetNode: HTMLElement;\n\tcontext: string;\n\titems: ItemOptions[] = [];\n\tevents: SelectorEvents = {};\n\tclientSelectorDialog: Dialog;\n\n\tstatic createFromCommunications({\n\t\ttargetNode,\n\t\tcontext = null,\n\t\tcommunications,\n\t\tselected = [],\n\t\tevents = {},\n\t}): ClientSelector\n\t{\n\t\tconst instance = new ClientSelector({\n\t\t\ttargetNode,\n\t\t\tcontext,\n\t\t\tevents,\n\t\t});\n\n\t\tinstance.items = instance.getPhoneSelectorItems(communications);\n\t\tinstance.setSelected(selected);\n\n\t\treturn instance;\n\t}\n\n\tstatic createFromItems({\n\t\ttargetNode,\n\t\tcontext = null,\n\t\titems,\n\t\tselected = [],\n\t\tevents = {},\n\t}): ClientSelector\n\t{\n\t\tconst instance = new ClientSelector({\n\t\t\ttargetNode,\n\t\t\tcontext,\n\t\t\tevents,\n\t\t});\n\n\t\tinstance.items = instance.prepareItems(items);\n\t\tinstance.setSelected(selected);\n\n\t\treturn instance;\n\t}\n\n\tconstructor({\n\t\ttargetNode,\n\t\tcontext = null,\n\t\tevents = {},\n\t})\n\t{\n\t\tthis.targetNode = targetNode;\n\t\tthis.context = Type.isStringFilled(context) ? context : `crm-client-selector-${Text.getRandom()}`;\n\t\tthis.events = Type.isObjectLike(events) ? events : {};\n\t}\n\n\tsetSelected(ids: string[]): ClientSelector\n\t{\n\t\t// eslint-disable-next-line no-return-assign,no-param-reassign\n\t\tthis.items.forEach((item) => item.selected = ids.includes(item.id));\n\n\t\treturn this;\n\t}\n\n\tgetPhoneSelectorItems(communications: Communication[]): Array\n\t{\n\t\tconst items = [];\n\n\t\tcommunications.forEach((communication) => {\n\t\t\tconst {\n\t\t\t\tphones,\n\t\t\t\tentityTypeName,\n\t\t\t\tentityId,\n\t\t\t\tentityTypeId,\n\t\t\t\tcaption: title,\n\t\t\t} = communication;\n\n\t\t\tif (!Array.isArray(phones))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tphones.forEach((phone) => {\n\t\t\t\tconst { id, valueFormatted, typeLabel } = phone;\n\n\t\t\t\titems.push({\n\t\t\t\t\tid,\n\t\t\t\t\ttitle,\n\t\t\t\t\tsubtitle: `${valueFormatted}, ${typeLabel}`,\n\t\t\t\t\tentityId: DEFAULT_TAB_ID,\n\t\t\t\t\ttabs: DEFAULT_TAB_ID,\n\t\t\t\t\tavatar: this.#getEntityAvatarPath(entityTypeName),\n\t\t\t\t\tcustomData: {\n\t\t\t\t\t\tentityId,\n\t\t\t\t\t\tentityTypeId,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\treturn items;\n\t}\n\n\tprepareItems(items: ItemOptions[]): ItemOptions[]\n\t{\n\t\treturn items.map((item) => {\n\t\t\titem.entityId = DEFAULT_TAB_ID;\n\t\t\titem.tabs = DEFAULT_TAB_ID;\n\n\t\t\tif (item.customData?.entityTypeId && !item.avatar)\n\t\t\t{\n\t\t\t\tconst { entityTypeId } = item.customData;\n\t\t\t\titem.avatar = item.avatar ?? this.#getEntityAvatarPath(BX.CrmEntityType.resolveName(entityTypeId));\n\t\t\t}\n\n\t\t\treturn item;\n\t\t});\n\t}\n\n\t#getEntityAvatarPath(entityTypeName: string): string\n\t{\n\t\t// eslint-disable-next-line no-param-reassign\n\t\tentityTypeName = entityTypeName.toLowerCase();\n\n\t\tconst whiteList = [\n\t\t\t'contact',\n\t\t\t'company',\n\t\t\t'lead',\n\t\t];\n\n\t\tif (!whiteList.includes(entityTypeName))\n\t\t{\n\t\t\treturn '';\n\t\t}\n\n\t\treturn `/bitrix/images/crm/entity_provider_icons/${entityTypeName}.svg`;\n\t}\n\n\tshow(): void\n\t{\n\t\tconst { targetNode, context, items } = this;\n\t\tconst events = this.#prepareEvents();\n\t\tconst tabs = [\n\t\t\t{\n\t\t\t\tid: DEFAULT_TAB_ID,\n\t\t\t\ttitle: Loc.getMessage('CRM_CLIENT_SELECTOR_TAB_TITLE'),\n\t\t\t},\n\t\t];\n\n\t\tthis.clientSelectorDialog = new Dialog({\n\t\t\ttargetNode,\n\t\t\tid: 'client-phone-selector-dialog',\n\t\t\tcontext,\n\t\t\tmultiple: false,\n\t\t\tdropdownMode: true,\n\t\t\tshowAvatars: true,\n\t\t\tenableSearch: true,\n\t\t\twidth: 450,\n\t\t\tzIndex: 2500,\n\t\t\titems,\n\t\t\ttabs,\n\t\t\tevents,\n\t\t});\n\n\t\tthis.clientSelectorDialog.show();\n\t}\n\n\t#prepareEvents(): SelectorEvents\n\t{\n\t\tconst { events: { onSelect, onHide, onShow } } = this;\n\n\t\tconst events = {};\n\n\t\tif (onSelect)\n\t\t{\n\t\t\tevents['Item:onSelect'] = onSelect;\n\t\t}\n\n\t\tif (onHide)\n\t\t{\n\t\t\tevents.onHide = onHide;\n\t\t}\n\n\t\tif (onShow)\n\t\t{\n\t\t\tevents.onShow = onShow;\n\t\t}\n\n\t\treturn events;\n\t}\n\n\thide(): void\n\t{\n\t\tif (this.isOpen())\n\t\t{\n\t\t\tthis.clientSelectorDialog.hide();\n\t\t}\n\t}\n\n\tisOpen(): boolean\n\t{\n\t\treturn (this.clientSelectorDialog && this.clientSelectorDialog.isOpen());\n\t}\n}\n"],"names":["DEFAULT_TAB_ID","ClientSelector","createFromCommunications","targetNode","context","communications","selected","events","instance","items","getPhoneSelectorItems","setSelected","createFromItems","prepareItems","constructor","Type","isStringFilled","Text","getRandom","isObjectLike","ids","forEach","item","includes","id","communication","phones","entityTypeName","entityId","entityTypeId","caption","title","Array","isArray","phone","valueFormatted","typeLabel","push","subtitle","tabs","avatar","customData","map","BX","CrmEntityType","resolveName","show","Loc","getMessage","clientSelectorDialog","Dialog","multiple","dropdownMode","showAvatars","enableSearch","width","zIndex","hide","isOpen","toLowerCase","whiteList","onSelect","onHide","onShow"],"mappings":"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"}