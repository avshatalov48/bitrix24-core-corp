{"version":3,"file":"client-selector.bundle.js","sources":["../src/client-selector.js"],"sourcesContent":["import { Loc, Text, Type } from 'main.core';\nimport type { ItemOptions } from 'ui.entity-selector';\nimport { Dialog } from 'ui.entity-selector';\n\nexport type Communication = {\n\tcaption: string,\n\tentityId: number,\n\tentityTypeId: number,\n\tentityTypeName: string,\n\tphones?: CommunicationItem[],\n\temails?: CommunicationItem[],\n}\n\nexport type CommunicationItem = {\n\tid: string,\n\ttype: string,\n\ttypeLabel: string,\n\tvalue: string,\n\tvalueFormatted: string,\n}\n\ntype SelectorEvents = {\n\t'Item:onSelect'?: Function,\n\t'Item:onDeselect'?: Function,\n\tonShow?: Function,\n\tonHide?: Function,\n}\n\nconst DEFAULT_TAB_ID = 'client';\n\nexport class ClientSelector\n{\n\ttargetNode: HTMLElement;\n\tcontext: string;\n\titems: ItemOptions[] = [];\n\tevents: SelectorEvents = {};\n\tclientSelectorDialog: Dialog;\n\t#multiple: boolean = false;\n\n\tstatic createFromCommunications({\n\t\ttargetNode,\n\t\tcontext = null,\n\t\tcommunications,\n\t\tmultiple = false,\n\t\tselected = [],\n\t\tevents = {},\n\t}): ClientSelector\n\t{\n\t\tconst instance = new ClientSelector({\n\t\t\ttargetNode,\n\t\t\tmultiple,\n\t\t\tcontext,\n\t\t\tevents,\n\t\t});\n\n\t\tinstance.items = instance.getPhoneSelectorItems(communications);\n\t\tinstance.setSelected(selected);\n\n\t\treturn instance;\n\t}\n\n\tstatic createFromItems({\n\t\ttargetNode,\n\t\tcontext = null,\n\t\titems,\n\t\tmultiple = false,\n\t\tselected = [],\n\t\tevents = {},\n\t}): ClientSelector\n\t{\n\t\tconst instance = new ClientSelector({\n\t\t\ttargetNode,\n\t\t\tmultiple,\n\t\t\tcontext,\n\t\t\tevents,\n\t\t});\n\n\t\tinstance.items = instance.prepareItems(items);\n\t\tinstance.setSelected(selected);\n\n\t\treturn instance;\n\t}\n\n\tconstructor({\n\t\ttargetNode,\n\t\tmultiple = false,\n\t\tcontext = null,\n\t\tevents = {},\n\t})\n\t{\n\t\tthis.targetNode = targetNode;\n\t\tthis.#multiple = multiple;\n\t\tthis.context = Type.isStringFilled(context) ? context : `crm-client-selector-${Text.getRandom()}`;\n\t\tthis.events = Type.isObjectLike(events) ? events : {};\n\t}\n\n\tsetSelected(ids: string[]): ClientSelector\n\t{\n\t\t// eslint-disable-next-line no-return-assign,no-param-reassign\n\t\tthis.items.forEach((item) => item.selected = ids.includes(item.id));\n\n\t\treturn this;\n\t}\n\n\tsetSelectedItemByEntityData(entityId: number, entityTypeId: number): ClientSelector\n\t{\n\t\tthis.items.forEach((item) => {\n\t\t\tif (\n\t\t\t\titem.customData.entityId === entityId\n\t\t\t\t&& item.customData.entityTypeId === entityTypeId\n\t\t\t)\n\t\t\t{\n\t\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\t\titem.selected = true;\n\t\t\t}\n\t\t});\n\n\t\treturn this;\n\t}\n\n\tgetPhoneSelectorItems(communications: Communication[]): Array\n\t{\n\t\tconst items = [];\n\n\t\tcommunications.forEach((communication) => {\n\t\t\tconst {\n\t\t\t\tphones,\n\t\t\t\tentityTypeName,\n\t\t\t\tentityId,\n\t\t\t\tentityTypeId,\n\t\t\t\tcaption: title,\n\t\t\t} = communication;\n\n\t\t\tif (!Array.isArray(phones))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tphones.forEach((phone) => {\n\t\t\t\tconst { id, valueFormatted, typeLabel } = phone;\n\n\t\t\t\titems.push({\n\t\t\t\t\tid,\n\t\t\t\t\ttitle,\n\t\t\t\t\tsubtitle: `${valueFormatted}, ${typeLabel}`,\n\t\t\t\t\tentityId: DEFAULT_TAB_ID,\n\t\t\t\t\ttabs: DEFAULT_TAB_ID,\n\t\t\t\t\tavatar: this.#getEntityAvatarPath(entityTypeName),\n\t\t\t\t\tcustomData: {\n\t\t\t\t\t\tentityId,\n\t\t\t\t\t\tentityTypeId,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\treturn items;\n\t}\n\n\tprepareItems(items: ItemOptions[]): ItemOptions[]\n\t{\n\t\treturn items.map((item) => {\n\t\t\titem.entityId = DEFAULT_TAB_ID;\n\t\t\titem.tabs = DEFAULT_TAB_ID;\n\n\t\t\tif (item.customData?.entityTypeId && !item.avatar)\n\t\t\t{\n\t\t\t\tconst { entityTypeId } = item.customData;\n\t\t\t\titem.avatar = item.avatar ?? this.#getEntityAvatarPath(BX.CrmEntityType.resolveName(entityTypeId));\n\t\t\t}\n\n\t\t\treturn item;\n\t\t});\n\t}\n\n\t#getEntityAvatarPath(entityTypeName: string): string\n\t{\n\t\t// eslint-disable-next-line no-param-reassign\n\t\tentityTypeName = entityTypeName.toLowerCase();\n\n\t\tconst whiteList = [\n\t\t\t'contact',\n\t\t\t'company',\n\t\t\t'lead',\n\t\t];\n\n\t\tif (!whiteList.includes(entityTypeName))\n\t\t{\n\t\t\treturn '';\n\t\t}\n\n\t\treturn `/bitrix/images/crm/entity_provider_icons/${entityTypeName}.svg`;\n\t}\n\n\tshow(): void\n\t{\n\t\tconst { targetNode, context, items } = this;\n\t\tconst events = this.#prepareEvents();\n\t\tconst tabs = [\n\t\t\t{\n\t\t\t\tid: DEFAULT_TAB_ID,\n\t\t\t\ttitle: Loc.getMessage('CRM_CLIENT_SELECTOR_TAB_TITLE'),\n\t\t\t},\n\t\t];\n\n\t\tthis.clientSelectorDialog = new Dialog({\n\t\t\ttargetNode,\n\t\t\tid: 'client-phone-selector-dialog',\n\t\t\tcontext,\n\t\t\tmultiple: this.#multiple,\n\t\t\tdropdownMode: true,\n\t\t\tshowAvatars: true,\n\t\t\tenableSearch: true,\n\t\t\twidth: 450,\n\t\t\tzIndex: 2500,\n\t\t\titems,\n\t\t\ttabs,\n\t\t\tevents,\n\t\t});\n\n\t\tthis.clientSelectorDialog.show();\n\t}\n\n\t#prepareEvents(): SelectorEvents\n\t{\n\t\tconst { events: { onSelect, onDeselect, onHide, onShow } } = this;\n\n\t\tconst events = {};\n\n\t\tif (onSelect)\n\t\t{\n\t\t\tevents['Item:onSelect'] = onSelect;\n\t\t}\n\n\t\tif (onDeselect)\n\t\t{\n\t\t\tevents['Item:onDeselect'] = onDeselect;\n\t\t}\n\n\t\tif (onHide)\n\t\t{\n\t\t\tevents.onHide = onHide;\n\t\t}\n\n\t\tif (onShow)\n\t\t{\n\t\t\tevents.onShow = onShow;\n\t\t}\n\n\t\treturn events;\n\t}\n\n\thide(): void\n\t{\n\t\tif (this.isOpen())\n\t\t{\n\t\t\tthis.clientSelectorDialog.hide();\n\t\t}\n\t}\n\n\tisOpen(): boolean\n\t{\n\t\treturn (this.clientSelectorDialog && this.clientSelectorDialog.isOpen());\n\t}\n}\n"],"names":["DEFAULT_TAB_ID","ClientSelector","createFromCommunications","targetNode","context","communications","multiple","selected","events","instance","items","getPhoneSelectorItems","setSelected","createFromItems","prepareItems","constructor","Type","isStringFilled","Text","getRandom","isObjectLike","ids","forEach","item","includes","id","setSelectedItemByEntityData","entityId","entityTypeId","customData","communication","phones","entityTypeName","caption","title","Array","isArray","phone","valueFormatted","typeLabel","push","subtitle","tabs","avatar","map","BX","CrmEntityType","resolveName","show","Loc","getMessage","clientSelectorDialog","Dialog","dropdownMode","showAvatars","enableSearch","width","zIndex","hide","isOpen","toLowerCase","whiteList","onSelect","onDeselect","onHide","onShow"],"mappings":"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"}