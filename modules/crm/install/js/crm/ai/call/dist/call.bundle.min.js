this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(t,e,i,n,s,a,l,r,o,c,u,d,p,v,_){"use strict";var h;var b=function(){function t(e){var s;babelHelpers.classCallCheck(this,t);babelHelpers.defineProperty(this,"languageTitle",null);this.initDefaultOptions();this.activityId=e.activityId;this.ownerTypeId=e.ownerTypeId;this.ownerId=e.ownerId;this.languageTitle=(s=e.languageTitle)!==null&&s!==void 0?s:null;this.audioPlayerNode=_.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['<div id="crm-textbox-audio-player"></div>'])));this.audioPlayerApp=new a.AudioPlayer({rootNode:this.audioPlayerNode});this.textbox=new n.Textbox({title:this.textboxTitle,previousTextContent:this.audioPlayerNode,attentions:this.getTextboxAttentions()});this.sliderId="".concat(this.id,"-").concat(Math.floor(Math.random()*1e3));this.wrapperSlider=new i.Slider({url:this.sliderId,sliderTitle:this.sliderTitle,sliderContentClass:this.getSliderContentClass(),width:this.sliderWidth,extensions:this.getExtensions(),design:this.getSliderDesign(),events:this.getSliderEvents(),toolbar:this.getSliderToolbar()})}babelHelpers.createClass(t,[{key:"getExtensions",value:function t(){return["crm.ai.textbox","crm.audio-player"]}},{key:"getSliderContentClass",value:function t(){return null}},{key:"getSliderDesign",value:function t(){return null}},{key:"getSliderToolbar",value:function t(){return null}},{key:"getSliderEvents",value:function t(){var e=this;return{onLoad:function t(){e.audioPlayerApp.attachTemplate()},onClose:function t(){e.audioPlayerApp.detachTemplate()}}}},{key:"open",value:function t(){var e=this;var i=new Promise((function(t,i){e.getAiJobResultAndCallRecord().then((function(i){var n=e.prepareAudioProps(i);e.audioPlayerApp.setAudioProps(n);var s=e.prepareAiJobResult(i);e.textbox.setText(s);e.textbox.render();t(e.textbox.get())}))["catch"]((function(t){e.showError(t);e.wrapperSlider.destroy()}))}));this.wrapperSlider.setContent(i);this.wrapperSlider.open()}},{key:"getAiJobResultAndCallRecord",value:function t(){var e={data:{activityId:this.activityId,ownerTypeId:this.ownerTypeId,ownerId:this.ownerId}};return BX.ajax.runAction(this.aiJobResultAndCallRecordAction,e)}},{key:"showError",value:function t(e){s.UI.Notification.Center.notify({content:e.errors[0].message,autoHideDelay:5e3})}},{key:"prepareAiJobResult",value:function t(e){return""}},{key:"prepareAudioProps",value:function t(e){var i=e.data.callRecord;return{id:i.id,src:i.src,title:i.title,context:window.top}}},{key:"getTextboxAttentions",value:function t(){var e=[this.getNotAccurateAttention()];var i=this.getJobLanguageAttention();if(i!==null){e.push(i)}return e}},{key:"getNotAccurateAttention",value:function t(){var e="20412666";var i=_.Loc.getMessage(this.getNotAccuratePhraseCode(),{"[helpdesklink]":'<a href="##" onclick="top.BX.Helper.show(\'redirect=detail&code='.concat(e,"');\">"),"[/helpdesklink]":"</a>"});return new n.Attention({content:i})}},{key:"getJobLanguageAttention",value:function t(){if(!_.Type.isStringFilled(this.languageTitle)){return null}var e="20423978";var i=_.Loc.getMessage("CRM_COPILOT_CALL_JOB_LANGUAGE_ATTENTION",{"#LANGUAGE_TITLE#":'<span style="text-transform: lowercase">'.concat(_.Text.encode(this.languageTitle),"</span>"),"[helpdesklink]":'<a href="##" onclick="top.BX.Helper.show(\'redirect=detail&code='.concat(e,"');\">"),"[/helpdesklink]":"</a>"});return new n.Attention({preset:n.AttentionPresets.COPILOT,content:i})}},{key:"getNotAccuratePhraseCode",value:function t(){return""}},{key:"getSliderTitle",value:function t(){return""}},{key:"getTextboxTitle",value:function t(){return""}},{key:"initDefaultOptions",value:function t(){}}]);return t}();function m(t,e,i){f(t,e);e.set(t,i)}function f(t,e){if(e.has(t)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var T="call_scoring_add";var g=new WeakMap;var C=new WeakMap;var A=function(){function t(e){babelHelpers.classCallCheck(this,t);m(this,g,{writable:true,value:void 0});m(this,C,{writable:true,value:null});babelHelpers.classPrivateFieldSet(this,g,e)}babelHelpers.createClass(t,[{key:"init",value:function t(){var e=this;if(!l.PULL){console.error("pull is not initialized");return}babelHelpers.classPrivateFieldSet(this,C,l.PULL.subscribe({moduleId:"crm",command:T,callback:function t(i){babelHelpers.classPrivateFieldGet(e,g).call(e,i)}}));l.PULL.extendWatch(T)}},{key:"unsubscribe",value:function t(){babelHelpers.classPrivateFieldGet(this,C).call(this)}}]);return t}();var y=Object.freeze({usedNotAssessmentScript:"usedNotAssessmentScript",usedCurrentVersionOfScript:"usedCurrentVersionOfScript",usedOtherVersionOfScript:"usedOtherVersionOfScript",emptyScriptList:"emptyScriptList",pending:"pending",error:"error"});var L={props:{title:{type:String,required:true},assessment:{type:Number,default:null},viewMode:{type:String,default:null}},mounted:function t(){this.startAnimate()},methods:{startAnimate:function t(){if(this.$refs.assessment){this.animateCounter(this.$refs.assessment,this.assessment)}},animateCounter:function t(e,i){var n=0;var s=1500;var a=i/(s/50);var l=setInterval((function(){n+=a;if(n>=i){n=i;clearInterval(l)}e.textContent=Math.floor(n)}),50)}},computed:{classList:function t(){return{"call-quality__compliance__container":true,"--empty-state":!this.isUsedCurrentVersionOfScript}},isUsedCurrentVersionOfScript:function t(){return this.viewMode===y.usedCurrentVersionOfScript},infoTitle:function t(){return this.viewMode===y.emptyScriptList?_.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_COMPLIANCE_EMPTY_SCRIPT_LIST_TITLE"):_.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_COMPLIANCE_TITLE")},valueTitle:function t(){return this.viewMode===y.emptyScriptList?_.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_COMPLIANCE_EMPTY_SCRIPT_LIST_VALUE"):this.title}},template:'\n\t\t<div :class="classList">\n\t\t\t<div class="call-quality__compliance">\n\t\t\t\t<div\n\t\t\t\t\tv-if="isUsedCurrentVersionOfScript"\n\t\t\t\t\tclass="call-quality__compliance__assessment"\n\t\t\t\t>\n\t\t\t\t\t<span ref="assessment" class="call-quality__compliance__assessment-value">\n\t\t\t\t\t\t{{ assessment }}\n\t\t\t\t\t</span>\n\t\t\t\t\t<div class="call-quality__compliance__assessment-measure">\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="call-quality__compliance__info">\n\t\t\t\t\t<span class="call-quality__compliance__info-title">\n\t\t\t\t\t\t{{ infoTitle }}\n\t\t\t\t\t</span>\n\t\t\t\t\t<span class="call-quality__compliance__info-value">\n\t\t\t\t\t\t{{ valueTitle }}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'};var S={computed:{title:function t(){return _.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_EMPTY_SCRIPT_LIST_TITLE")},text:function t(){return _.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_EMPTY_SCRIPT_LIST_TEXT")}},template:'\n\t\t<div class="call-quality__explanation">\n\t\t\t<div class="call-quality__explanation__container">\n\t\t\t\t<div class="call-quality__explanation-title">\n\t\t\t\t\t{{ title }}\n\t\t\t\t</div>\n\t\t\t\t<div class="call-quality__explanation-text" v-html="text">\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'};var I={data:function t(){return{errorText:null}},methods:{setErrorMessage:function t(e){this.errorText=e}},computed:{explanationText:function t(){return _.Type.isStringFilled(this.errorText)?this.errorText:_.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_ERROR_TEXT")}},template:'\n\t\t<div class="call-quality__explanation">\n\t\t\t<div class="call-quality__explanation__container --error">\n\t\t\t\t<div class="call-quality__explanation-title">\n\t\t\t\t\t{{ $Bitrix.Loc.getMessage(\'CRM_COPILOT_CALL_QUALITY_ERROR_TITLE\') }}\n\t\t\t\t</div>\n\t\t\t\t<div class="call-quality__explanation-text">\n\t\t\t\t\t{{ explanationText }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'};var P={methods:{doAssessment:function t(){this.$emit("doAssessment")}},computed:{title:function t(){return _.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_NO_EXPLANATION_TITLE")},text:function t(){return _.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_NO_EXPLANATION_TEXT")},buttonText:function t(){return _.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_NO_EXPLANATION_ASSESSMENT")}},template:'\n\t\t<div class="call-quality__explanation">\n\t\t\t<div class="call-quality__explanation__container ">\n\t\t\t\t<div class="call-quality__explanation-title">\n\t\t\t\t\t{{ title }}\n\t\t\t\t</div>\n\t\t\t\t<div class="call-quality__explanation-text" v-html="text">\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="call-quality__explanation__buttons-container">\n\t\t\t\t<button\n\t\t\t\t\tclass="ui-btn ui-btn-md ui-btn-no-caps ui-btn-color-ai ui-btn-round ui-btn-active"\n\t\t\t\t\t@click="doAssessment"\n\t\t\t\t>\n\t\t\t\t\t{{ buttonText }}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t'};var w={methods:{showAssessment:function t(){this.$emit("showAssessment")},doAssessment:function t(){this.$emit("doAssessment")}},computed:{title:function t(){return _.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_OLD_EXPLANATION_TITLE")},text:function t(){return _.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_OLD_EXPLANATION_TEXT")},buttonShowText:function t(){return _.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_OLD_EXPLANATION_SHOW_ASSESSMENT")},buttonDoText:function t(){return _.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_OLD_EXPLANATION_ASSESSMENT")}},template:'\n\t\t<div class="call-quality__explanation">\n\t\t\t<div class="call-quality__explanation__container ">\n\t\t\t\t<div class="call-quality__explanation-title" v-html="title">\n\t\t\t\t</div>\n\t\t\t\t<div class="call-quality__explanation-text" v-html="text">\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="call-quality__explanation__buttons-container">\n\t\t\t\t<button\n\t\t\t\t\tclass="ui-btn ui-btn-md ui-btn-no-caps ui-btn-color-ai ui-btn-round ui-btn-active"\n\t\t\t\t\t@click="doAssessment"\n\t\t\t\t>\n\t\t\t\t\t{{ buttonDoText }}\n\t\t\t\t</button>\n\t\t\t\t<button\n\t\t\t\t\tclass="ui-btn ui-btn-md ui-btn-no-caps ui-btn-light-border ui-btn-round"\n\t\t\t\t\t@click="showAssessment"\n\t\t\t\t>\n\t\t\t\t\t{{ buttonShowText }}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t'};var O={mounted:function t(){this.renderLottieAnimation()},methods:{renderLottieAnimation:function t(){var e=r.Lottie.loadAnimation({path:this.getAnimationPath(),container:this.$refs.lottie,renderer:"svg",loop:true,autoplay:true});e.setSpeed(.75);return this.$refs.lottie.root},getAnimationPath:function t(){return"/bitrix/js/crm/ai/call/src/call-quality/lottie/loader.json"}},template:'\n\t\t<div class="call-quality__explanation">\n\t\t\t<div class="call-quality__explanation__container ">\n\t\t\t\t<div class="call-quality__explanation-title">\n\t\t\t\t\t{{ $Bitrix.Loc.getMessage(\'CRM_COPILOT_CALL_QUALITY_PENDING_TITLE\') }}\n\t\t\t\t</div>\n\t\t\t\t<div class="call-quality__explanation-text">\n\t\t\t\t\t<div class="call-quality__explanation-loader__container">\n\t\t\t\t\t\t<div ref="lottie" class="call-quality__explanation-loader__lottie"></div>\n\t\t\t\t\t\t<div class="call-quality__explanation-loader__lottie-text">{{ $Bitrix.Loc.getMessage(\'CRM_COPILOT_CALL_QUALITY_PENDING_TEXT\') }}</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'};var M="23240682";var E={props:{recommendations:{type:String,default:null},summary:{type:String,default:null},useInRating:{type:Boolean,default:false}},methods:{showArticle:function t(){var e,i;(e=window.top.BX)===null||e===void 0?void 0:(i=e.Helper)===null||i===void 0?void 0:i.show("redirect=detail&code=".concat(M))}},template:'\n\t\t<div class="call-quality__explanation --copilot-content">\n\t\t\t<div class="call-quality__explanation__container ">\n\t\t\t\t<div class="call-quality__explanation-title">\n\t\t\t\t\t{{ $Bitrix.Loc.getMessage(\'CRM_COPILOT_CALL_QUALITY_EXPLANATION_TITLE\') }}\n\t\t\t\t</div>\n\t\t\t\t<div class="call-quality__explanation-text">\n\t\t\t\t\t<div \n\t\t\t\t\t\tv-if="!useInRating"\n\t\t\t\t\t\tclass="call-quality__explanation-badge"\n\t\t\t\t\t>\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage(\'CRM_COPILOT_CALL_QUALITY_EXPLANATION_NOT_IN_RATING\') }}\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclass="call-quality__explanation-badge-article ui-icon-set --help"\n\t\t\t\t\t\t\t\t@click="showArticle"\n\t\t\t\t\t\t\t></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<p>\n\t\t\t\t\t\t{{ summary }}\n\t\t\t\t\t</p>\n\t\t\t\t\t<p>\n\t\t\t\t\t\t{{ recommendations }}\n\t\t\t\t\t</p>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'};var x,R;function k(t,e){H(t,e);e.add(t)}function N(t,e,i){H(t,e);e.set(t,i)}function H(t,e){if(e.has(t)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function q(t,e,i){if(!e.has(t)){throw new TypeError("attempted to get private field on non-instance")}return i}var U=new WeakMap;var B=new WeakMap;var F=new WeakSet;var D=function(){function t(){babelHelpers.classCallCheck(this,t);k(this,F);N(this,U,{writable:true,value:void 0});N(this,B,{writable:true,value:false});babelHelpers.classPrivateFieldSet(this,U,q(this,F,X).call(this))}babelHelpers.createClass(t,[{key:"getTargetNode",value:function t(){return this.titleNode}},{key:"updateTitle",value:function t(e){this.innerTitleNode.innerText=e;this.innerTitleNode.title=e}},{key:"setLoading",value:function t(e){if(babelHelpers.classPrivateFieldGet(this,B)===e){return}babelHelpers.classPrivateFieldSet(this,B,e);_.Dom.toggleClass(babelHelpers.classPrivateFieldGet(this,U),"--loading")}}]);return t}();function X(){this.innerTitleNode=_.Tag.render(x||(x=babelHelpers.taggedTemplateLiteral(["<span></span>"])));this.titleNode=_.Tag.render(R||(R=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="call-quality__script-selector">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"])),this.innerTitleNode);return this.titleNode}var G="23240682";var V={props:{assessmentSettingsId:{type:Number,required:true},assessmentSettingsTitle:{type:String,required:true},isPromptChanged:{type:Boolean,required:true},promptUpdatedAt:{type:String,required:true},prompt:{type:String,required:true},viewMode:{type:String,default:""}},data:function t(){return{callAssessmentSelector:this.getCallAssessmentSelector(),htmlFormatter:new d.HtmlFormatter}},methods:{getCallAssessmentSelector:function t(){return new o.CallAssessmentSelector({currentCallAssessment:{id:this.assessmentSettingsId,title:this.assessmentSettingsId>0?this.assessmentSettingsTitle:_.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_EMPTY_SCRIPT_LIST_SCRIPT_TITLE")},emptyScriptListTitle:_.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_EMPTY_SCRIPT_LIST_SCRIPT_TITLE"),displayStrategy:new D,additionalSelectorOptions:{dialog:{events:{"Item:onBeforeSelect":this.onBeforeSelect.bind(this)}},popup:{events:{onShow:function t(e){var i=p.SidePanel.Instance.getTopSlider().getZindex()+1;e.target.getZIndexComponent().setZIndex(i)}}}}})},onBeforeSelect:function t(e){var i;this.$emit("onBeforeSelect",(i=this.callAssessmentSelector.getCurrentCallAssessmentItem())===null||i===void 0?void 0:i.id)},onEditCallAssessmentSettings:function t(e){var i=e.target;top.BX.UI.Hint.popupParameters={closeByEsc:true,autoHide:true,angle:false};top.BX.UI.Hint.show(i,_.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_SCRIPT_EDIT_HINT"),false)},onShowActualPrompt:function t(){this.$emit("onShowActualPrompt")},showArticle:function t(){var e,i;(e=window.top.BX)===null||e===void 0?void 0:(i=e.Helper)===null||i===void 0?void 0:i.show("redirect=detail&code=".concat(G))},formatHtml:function t(e){return this.htmlFormatter.format({source:e})},close:function t(){var e;(e=this.callAssessmentSelector)===null||e===void 0?void 0:e.close()},disable:function t(){var e;(e=this.callAssessmentSelector)===null||e===void 0?void 0:e.disable()},enable:function t(){var e;(e=this.callAssessmentSelector)===null||e===void 0?void 0:e.enable()},doAssessment:function t(){this.$emit("doAssessment")}},mounted:function t(){_.Dom.append(this.callAssessmentSelector.getContainer(),this.$refs.container);if(this.$refs.prompt){_.Dom.append(this.formattedPrompt,this.$refs.prompt)}},computed:{scriptUpdatedAt:function t(){var e=new Date(this.promptUpdatedAt);var i=new c.DatetimeConverter(e);var n=i.toDatetimeString({withDayOfWeek:false,delimiter:", "});return _.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_SCRIPT_INFO_UPDATED",{"#UPDATED_AT#":n})},formattedPrompt:function t(){return this.formatHtml(this.prompt)},isShowFooterButtons:function t(){return this.viewMode!==y.usedOtherVersionOfScript&&this.viewMode!==y.usedNotAssessmentScript&&this.viewMode!==y.pending&&this.assessmentSettingsId>0},footerButtonClassList:function t(){var e=this.viewMode===y.error;return{"ui-btn":true,"ui-btn-xs":true,"ui-btn-no-caps":true,"ui-btn-light-border":!e,"ui-btn-round":true,"ui-btn-active":!e,"ui-btn-success":e}},isEmptyScriptListViewMode:function t(){return this.viewMode===y.emptyScriptList}},watch:{prompt:function t(){_.Dom.clean(this.$refs.prompt);_.Dom.append(this.formattedPrompt,this.$refs.prompt)}},template:'\n\t\t<div>\n\t\t\t<div class="call-quality__script-selector__container">\n\t\t\t\t<div class="call-quality__script-selector__title">\n\t\t\t\t\t<div>\n\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage(\'CRM_COPILOT_CALL_QUALITY_SCRIPT_SELECTOR_TITLE\') }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="call-quality__script-selector__selector-container" ref="container"></div>\n\t\t\t\t\t<div \n\t\t\t\t\t\tclass="call-quality__script-selector__article ui-icon-set --help"\n\t\t\t\t\t\t@click="showArticle"\n\t\t\t\t\t></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-if="this.isPromptChanged && isShowFooterButtons"\n\t\t\t\tclass="call-quality__script-info__container"\n\t\t\t>\n\t\t\t\t<span>{{scriptUpdatedAt}}</span>\n\t\t\t\t<button\n\t\t\t\t\tclass="ui-btn ui-btn-xs ui-btn-no-caps ui-btn-round ui-btn-link ui-btn-active"\n\t\t\t\t\t@click="onShowActualPrompt"\n\t\t\t\t>\n\t\t\t\t\t{{ $Bitrix.Loc.getMessage(\'CRM_COPILOT_CALL_QUALITY_SCRIPT_INFO_SHOW_NEW_PROMPT\') }}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t\t<div class="call-quality__script-container">\n\t\t\t\t<div\n\t\t\t\t\tv-if="isEmptyScriptListViewMode"\n\t\t\t\t\tclass="call-quality__script-text"\n\t\t\t\t>\n\t\t\t\t\t{{ $Bitrix.Loc.getMessage(\'CRM_COPILOT_CALL_QUALITY_EMPTY_SCRIPT_LIST_PROMPT_TEXT\') }}\n\t\t\t\t</div>\n\t\t\t\t<div v-else class="call-quality__script-text" ref="prompt">\n\t\t\t\t</div>\n\t\t\t\t\n\t\t\t\t<div\n\t\t\t\t\tv-if="isShowFooterButtons"\n\t\t\t\t\tclass="call-quality__script-footer"\n\t\t\t\t>\n\t\t\t\t\t<button \n\t\t\t\t\t\t:class="footerButtonClassList"\n\t\t\t\t\t\t@click="doAssessment"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage(\'CRM_COPILOT_CALL_QUALITY_SCRIPT_ASSESSMENT_REPLY\') }}\n\t\t\t\t\t</button>\n\t\t\t\t\t<button \n\t\t\t\t\t\tclass="ui-btn ui-btn-xs ui-btn-no-caps ui-btn-round ui-btn-light ui-btn-active edit-button"\n\t\t\t\t\t\t@click="onEditCallAssessmentSettings"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage(\'CRM_COPILOT_CALL_QUALITY_SCRIPT_EDIT\') }}\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'};function Y(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function Q(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Y(Object(i),!0).forEach((function(e){babelHelpers.defineProperty(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Y(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}var W={components:{AudioPlayerComponent:a.AudioPlayerComponent,ScriptSelectorComponent:V,RecommendationBlock:E,OtherScriptBlock:w,NotAssessmentScriptBlock:P,PendingBlock:O,ErrorBlock:I,EmptyScriptListBlock:S,ComplianceComponent:L},props:{client:{type:Object,required:true},data:{type:Object,required:true},audioProps:{type:Object,required:true},context:{type:Object,required:true}},data:function t(){var e;var i=this.getPreparedQualityProps(this.data);var n=(e=i.id)!==null&&e!==void 0?e:null;var s=null;if(this.data.viewMode===y.usedNotAssessmentScript){s=y.usedNotAssessmentScript}else if(this.data.viewMode===y.pending){s=y.pending}else if(this.data.viewMode===y.emptyScriptList){s=y.emptyScriptList}else if(i.id){var a;s=(a=this.data.viewMode)!==null&&a!==void 0?a:y.usedCurrentVersionOfScript}else{s=y.error}return{quality:i,currentQualityAssessmentId:n,viewMode:s,isShowAudioPlayer:false,direction:this.data.callDirection}},mounted:function t(){this.pull=new A(this.onPullChangeScript);this.pull.init()},methods:{showAudioPlayer:function t(){this.isShowAudioPlayer=true},onShowActualPrompt:function t(){this.viewMode=y.usedOtherVersionOfScript},onShowCurrentAssessment:function t(){this.viewMode=y.usedCurrentVersionOfScript},onDoAssessment:function t(){var e,i=this;this.viewMode=y.pending;(e=this.$refs.scriptSelector)===null||e===void 0?void 0:e.disable();var n={data:Q(Q({},this.context),{},{assessmentSettingsId:this.quality.assessmentSettingsId})};_.ajax.runAction("crm.copilot.callqualityassessment.doAssessment",n).then((function(t){var e;var n=t.status,s=t.data;(e=i.$refs.scriptSelector)===null||e===void 0?void 0:e.enable();if(n!=="success"){i.showError(t);return}u.EventEmitter.emit("crm.ai.callQuality:doAssessment",{data:s})}))["catch"]((function(t){var e;i.showError(t);(e=i.$refs.scriptSelector)===null||e===void 0?void 0:e.enable()}))},onChangeScript:function t(e){var i=this;var n={data:Q(Q({},this.context),{},{assessmentSettingsId:e})};_.ajax.runAction("crm.copilot.callqualityassessment.get",n).then((function(t){var e;(e=i.$refs.scriptSelector)===null||e===void 0?void 0:e.enable();var n=t.status,s=t.data;if(n!=="success"){i.showError(t);return}if(_.Type.isObject(s)){i.quality=i.getPreparedQualityProps(s);i.viewMode=s.viewMode}}))["catch"]((function(t){var e;(e=i.$refs.scriptSelector)===null||e===void 0?void 0:e.enable();top.BX.UI.Notification.Center.notify({content:t.errors[0].message,autoHideDelay:5e3})}))},showError:function t(e){var i=this;this.viewMode=y.error;this.$nextTick((function(){var t,n;(t=i.$refs.errorBlock)===null||t===void 0?void 0:t.setErrorMessage((n=e.errors[0])===null||n===void 0?void 0:n.message)}))},getPreparedQualityProps:function t(e){var i,n,s,a,l,r,o,c,u,d,p,v,h,b;var m=e.callQuality;if(!_.Type.isPlainObject(m)){m={}}return{id:Number((i=m.ID)!==null&&i!==void 0?i:0),createdAt:(n=m.CREATED_AT)!==null&&n!==void 0?n:null,assessmentSettingsId:Number((s=m.ASSESSMENT_SETTING_ID)!==null&&s!==void 0?s:0),assessment:Number((a=m.ASSESSMENT)!==null&&a!==void 0?a:0),assessmentAvg:Number((l=m.ASSESSMENT_AVG)!==null&&l!==void 0?l:0),prevAssessmentAvg:Number((r=m.PREV_ASSESSMENT_AVG)!==null&&r!==void 0?r:0),isPromptChanged:Boolean((o=m.IS_PROMPT_CHANGED)!==null&&o!==void 0?o:false),useInRating:Boolean((c=m.USE_IN_RATING)!==null&&c!==void 0?c:false),prompt:(u=m.PROMPT)!==null&&u!==void 0?u:"",actualPrompt:(d=m.ACTUAL_PROMPT)!==null&&d!==void 0?d:"",promptUpdatedAt:(p=m.PROMPT_UPDATED_AT)!==null&&p!==void 0?p:"",title:(v=m.TITLE)!==null&&v!==void 0?v:"",recommendations:(h=m.RECOMMENDATIONS)!==null&&h!==void 0?h:"",summary:(b=m.SUMMARY)!==null&&b!==void 0?b:""}},close:function t(){var e;(e=this.$refs.scriptSelector)===null||e===void 0?void 0:e.close();this.pull.unsubscribe()},onPullChangeScript:function t(e){if(this.context.activityId!==e.activityId){return}if(e.status==="error"||!_.Type.isNumber(e.assessmentSettingsId)){this.viewMode=y.error}else{this.onChangeScript(e.assessmentSettingsId)}}},computed:{clientNameClassList:function t(){return{"call-quality__call-client-name":true,"--incoming":Number(this.direction)===1,"--outgoing":Number(this.direction)===2}},clientName:function t(){return _.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_AI_CALL_TITLE",{"[clientname]":'<a href="'.concat(this.client.detailUrl,'">'),"[/clientname]":"</a>","#CLIENT_NAME#":_.Text.encode(this.client.fullName)})},formattedDate:function t(){var e=c.DatetimeConverter.createFromServerTimestamp(this.client.activityCreated);return e.toDatetimeString({withDayOfWeek:false,delimiter:", "})},isUsedCurrentVersionOfScriptViewMode:function t(){return this.viewMode===y.usedCurrentVersionOfScript},isUsedOtherVersionOfScriptViewMode:function t(){return this.viewMode===y.usedOtherVersionOfScript},isUsedNotAssessmentScriptViewMode:function t(){return this.viewMode===y.usedNotAssessmentScript},isPendingViewMode:function t(){return this.viewMode===y.pending},isErrorViewMode:function t(){return this.viewMode===y.error},isEmptyScriptListViewMode:function t(){return this.viewMode===y.emptyScriptList}},template:'\n\t\t<div class="call-quality__column --info">\n\t\t\t<div>\n\t\t\t\t<div class="call-quality__header">\n\t\t\t\t\t<div class="call-quality__header-row --flex">\n\t\t\t\t\t\t<div :class="clientNameClassList" v-html="clientName">\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="call-quality__call-date">\n\t\t\t\t\t\t\t{{ formattedDate }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="call-quality__header-row">\n\t\t\t\t\t\t<div id="crm-textbox-audio-player" ref="audioPlayer">\n\t\t\t\t\t\t\t<AudioPlayerComponent v-if="isShowAudioPlayer" v-bind="audioProps" />\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<ComplianceComponent \n\t\t\t\t\t:assessment="quality.assessment"\n\t\t\t\t\t:title="quality.title"\n\t\t\t\t\t:viewMode="viewMode"\n\t\t\t\t/>\n\t\t\t\t<RecommendationBlock\n\t\t\t\t\tv-if="isUsedCurrentVersionOfScriptViewMode"\n\t\t\t\t\t:recommendations="quality.recommendations"\n\t\t\t\t\t:summary="quality.summary"\n\t\t\t\t\t:use-in-rating="quality.useInRating"\n\t\t\t\t/>\n\t\t\t\t<OtherScriptBlock\n\t\t\t\t\tv-if="isUsedOtherVersionOfScriptViewMode"\n\t\t\t\t\t@showAssessment="onShowCurrentAssessment"\n\t\t\t\t\t@doAssessment="onDoAssessment"\n\t\t\t\t/>\n\t\t\t\t<NotAssessmentScriptBlock\n\t\t\t\t\tv-if="isUsedNotAssessmentScriptViewMode"\n\t\t\t\t\t@doAssessment="onDoAssessment"\n\t\t\t\t/>\n\t\t\t\t<PendingBlock v-if="isPendingViewMode"/>\n\t\t\t\t<ErrorBlock v-if="isErrorViewMode" ref="errorBlock"/>\n\t\t\t\t<EmptyScriptListBlock v-if="isEmptyScriptListViewMode"/>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="call-quality__column --prompt">\n\t\t\t<ScriptSelectorComponent\n\t\t\t\tref="scriptSelector"\n\t\t\t\t:assessmentSettingsId="quality.assessmentSettingsId"\n\t\t\t\t:assessmentSettingsTitle="quality.title"\n\t\t\t\t:isPromptChanged="quality.isPromptChanged"\n\t\t\t\t:promptUpdatedAt="quality.promptUpdatedAt"\n\t\t\t\t:prompt="quality.prompt"\n\t\t\t\t:viewMode="viewMode"\n\t\t\t\t@onBeforeSelect="onChangeScript"\n\t\t\t\t@onShowActualPrompt="onShowActualPrompt"\n\t\t\t\t@doAssessment="onDoAssessment"\n\t\t\t/>\n\t\t</div>\n\t'};var j,$,z,J,Z;function K(t,e){et(t,e);e.add(t)}function tt(t,e,i){et(t,e);e.set(t,i)}function et(t,e){if(e.has(t)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function it(t,e,i){if(!e.has(t)){throw new TypeError("attempted to get private field on non-instance")}return i}var nt=Object.freeze({up:1,down:-1,noChanges:0});var st="23240682";var at="rate";var lt=new WeakMap;var rt=new WeakMap;var ot=new WeakMap;var ct=new WeakMap;var ut=new WeakMap;var dt=new WeakMap;var pt=new WeakMap;var vt=new WeakSet;var _t=new WeakSet;var ht=new WeakSet;var bt=new WeakSet;var mt=new WeakSet;var ft=new WeakSet;var Tt=new WeakSet;var gt=function(){function t(){babelHelpers.classCallCheck(this,t);K(this,Tt);K(this,ft);K(this,mt);K(this,bt);K(this,ht);K(this,_t);K(this,vt);tt(this,lt,{writable:true,value:void 0});tt(this,rt,{writable:true,value:null});tt(this,ot,{writable:true,value:null});tt(this,ct,{writable:true,value:null});tt(this,ut,{writable:true,value:st});tt(this,dt,{writable:true,value:at});tt(this,pt,{writable:true,value:true});babelHelpers.classPrivateFieldSet(this,lt,"crm.ai.call.quality-rating-".concat(_.Text.getRandom()))}babelHelpers.createClass(t,[{key:"render",value:function t(){var e=babelHelpers.classPrivateFieldGet(this,pt)?it(this,vt,Ct).call(this):it(this,_t,At).call(this);return _.Tag.render(j||(j=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div id="','" class="call-quality__rating__container">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"])),babelHelpers.classPrivateFieldGet(this,lt),e)}},{key:"setRating",value:function t(e){babelHelpers.classPrivateFieldSet(this,rt,e)}},{key:"setPrevRating",value:function t(e){babelHelpers.classPrivateFieldSet(this,ot,e)}},{key:"setUserPhotoUrl",value:function t(e){babelHelpers.classPrivateFieldSet(this,ct,e)}},{key:"setSkeletonMode",value:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;if(babelHelpers.classPrivateFieldGet(this,pt)!==e){babelHelpers.classPrivateFieldSet(this,pt,e);it(this,Tt,Pt).call(this)}}}]);return t}();function Ct(){return _.Tag.render($||($=babelHelpers.taggedTemplateLiteral(["<div></div>"])))}function At(){return _.Tag.render(z||(z=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="call-quality__rating__text-container">\n\t\t\t\t','\n\t\t\t\t<div \n\t\t\t\t\tclass="call-quality__rating_article ui-icon-set --help"\n\t\t\t\t\tonclick="','"\n\t\t\t\t></div>\n\t\t\t</div>\n\t\t\t<div class="call-quality__rating__value-container">\n\t\t\t\t','\n\t\t\t\t<div class="call-quality__rating__value">\n\t\t\t\t\t','\n\t\t\t\t\t<span class="call-quality__rating__measure">%</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="call-quality__rating__trend ','"></div>\n\t\t\t</div>\n\t\t'])),_.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_RATING"),it(this,ft,It).bind(this),it(this,ht,yt).call(this),babelHelpers.classPrivateFieldGet(this,rt),it(this,bt,Lt).call(this))}function yt(){if(_.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,ct))){return _.Tag.render(J||(J=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div\n\t\t\t\t\tclass="call-quality__rating__avatar"\n\t\t\t\t\tstyle="background-image: url(',')"\n\t\t\t\t></div>\n\t\t\t'])),encodeURI(babelHelpers.classPrivateFieldGet(this,ct)))}return _.Tag.render(Z||(Z=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="call-quality__rating__avatar ui-icon ui-icon-common-user">\n\t\t\t\t<i style=""></i>\n\t\t\t</div>\n\t\t'])))}function Lt(){var t=it(this,mt,St).call(this);if(t===nt.up){return"--up"}if(t===nt.down){return"--down"}return"--no-changes"}function St(){if(babelHelpers.classPrivateFieldGet(this,rt)>babelHelpers.classPrivateFieldGet(this,ot)){return nt.up}if(babelHelpers.classPrivateFieldGet(this,rt)<babelHelpers.classPrivateFieldGet(this,ot)){return nt.down}return nt.noChanges}function It(){var t,e;(t=window.top.BX)===null||t===void 0?void 0:(e=t.Helper)===null||e===void 0?void 0:e.show("redirect=detail&code=".concat(babelHelpers.classPrivateFieldGet(this,ut),"&anchor=").concat(babelHelpers.classPrivateFieldGet(this,dt)))}function Pt(){var t=document.getElementById(babelHelpers.classPrivateFieldGet(this,lt));if(t===null){return}_.Dom.replace(t,this.render())}var wt;function Ot(t,e){Et(t,e);e.add(t)}function Mt(t,e,i){Et(t,e);e.set(t,i)}function Et(t,e){if(e.has(t)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function xt(t,e,i){if(!e.has(t)){throw new TypeError("attempted to get private field on non-instance")}return i}var Rt=new WeakMap;var kt=new WeakMap;var Nt=new WeakMap;var Ht=new WeakMap;var qt=new WeakMap;var Ut=new WeakMap;var Bt=new WeakMap;var Ft=new WeakMap;var Dt=new WeakSet;var Xt=function(t){babelHelpers.inherits(i,t);function i(t){var e;babelHelpers.classCallCheck(this,i);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this,t));Ot(babelHelpers.assertThisInitialized(e),Dt);Mt(babelHelpers.assertThisInitialized(e),Rt,{writable:true,value:null});Mt(babelHelpers.assertThisInitialized(e),kt,{writable:true,value:null});Mt(babelHelpers.assertThisInitialized(e),Nt,{writable:true,value:void 0});Mt(babelHelpers.assertThisInitialized(e),Ht,{writable:true,value:void 0});Mt(babelHelpers.assertThisInitialized(e),qt,{writable:true,value:void 0});Mt(babelHelpers.assertThisInitialized(e),Ut,{writable:true,value:void 0});Mt(babelHelpers.assertThisInitialized(e),Bt,{writable:true,value:void 0});Mt(babelHelpers.assertThisInitialized(e),Ft,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(e),Nt,_.Type.isNumber(t.jobId)?t.jobId:null);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(e),Ht,_.Type.isStringFilled(t.clientDetailUrl)?t.clientDetailUrl:null);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(e),qt,_.Type.isStringFilled(t.clientFullName)?t.clientFullName:null);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(e),Bt,_.Type.isStringFilled(t.userPhotoUrl)?t.userPhotoUrl:null);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(e),Ut,_.Type.isNumber(t.activityCreated)?t.activityCreated:null);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(e),Ft,_.Type.isNumber(t.assessmentSettingsId)?t.assessmentSettingsId:null);e.rating=new gt;return e}babelHelpers.createClass(i,[{key:"initDefaultOptions",value:function t(){this.id="crm-copilot-call-quality";this.sliderTitle=_.Loc.getMessage("CRM_COPILOT_CALL_QUALITY_SLIDER_TITLE");var e=Math.round(BX.SidePanel.Instance.getTopSlider().getWidth()*.75);this.sliderWidth=e>0?e:Math.round(window.screen.width*.75);this.textboxTitle=_.Loc.getMessage("CRM_COPILOT_CALL_TRANSCRIPT_TITLE");this.aiJobResultAndCallRecordAction="crm.timeline.ai.getCopilotCallQuality"}},{key:"getExtensions",value:function t(){var e=babelHelpers.get(babelHelpers.getPrototypeOf(i.prototype),"getExtensions",this).call(this);e.push("crm.ai.call");return e}},{key:"getSliderContentClass",value:function t(){return"crm-copilot-call-quality-wrapper"}},{key:"getSliderDesign",value:function t(){return{margin:0}}},{key:"getSliderToolbar",value:function t(){var e=this;return function(){return[e.rating.render()]}}},{key:"getSliderEvents",value:function t(){var e=this;var n=babelHelpers.get(babelHelpers.getPrototypeOf(i.prototype),"getSliderEvents",this).call(this);n.onLoad=function(){babelHelpers.classPrivateFieldGet(e,Rt).showAudioPlayer()};n.onClose=function(){babelHelpers.classPrivateFieldGet(e,Rt).close()};return n}},{key:"open",value:function t(){var i=this;var n=new Promise((function(t,n){i.getAiJobResultAndCallRecord().then((function(n){var s=i.prepareAudioProps(n);xt(i,Dt,Gt).call(i,n.data);var a={activityId:i.activityId,ownerTypeId:i.ownerTypeId,ownerId:i.ownerId,jobId:babelHelpers.classPrivateFieldGet(i,Nt)};babelHelpers.classPrivateFieldSet(i,kt,e.BitrixVue.createApp(W,{client:{detailUrl:babelHelpers.classPrivateFieldGet(i,Ht),fullName:babelHelpers.classPrivateFieldGet(i,qt),activityCreated:babelHelpers.classPrivateFieldGet(i,Ut)},data:n.data,audioProps:s,context:a}));var l=_.Tag.render(wt||(wt=babelHelpers.taggedTemplateLiteral(['<div class="call-quality__container"></div>'])));babelHelpers.classPrivateFieldSet(i,Rt,babelHelpers.classPrivateFieldGet(i,kt).mount(l));u.EventEmitter.subscribe("crm.ai.callQuality:doAssessment",(function(){}));t(l)}))["catch"]((function(t){i.showError(t);i.wrapperSlider.destroy()}))}));this.wrapperSlider.setContent(n);this.wrapperSlider.open()}},{key:"getAiJobResultAndCallRecord",value:function t(){var e={data:{activityId:this.activityId,ownerTypeId:this.ownerTypeId,ownerId:this.ownerId,jobId:babelHelpers.classPrivateFieldGet(this,Nt),assessmentSettingsId:babelHelpers.classPrivateFieldGet(this,Ft)}};return BX.ajax.runAction(this.aiJobResultAndCallRecordAction,e)}},{key:"getNotAccuratePhraseCode",value:function t(){return"CRM_COPILOT_CALL_TRANSCRIPT_NOT_BE_ACCURATE"}}]);return i}(b);function Gt(t){var e=t.callQuality;if(!_.Type.isPlainObject(e)){return}var i=this.rating;if(e){i.setRating(e===null||e===void 0?void 0:e.ASSESSMENT_AVG);i.setPrevRating(e===null||e===void 0?void 0:e.PREV_ASSESSMENT_AVG)}if(_.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,Bt))){i.setUserPhotoUrl(babelHelpers.classPrivateFieldGet(this,Bt))}i.setSkeletonMode(false)}var Vt=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).apply(this,arguments))}babelHelpers.createClass(e,[{key:"initDefaultOptions",value:function t(){this.id="crm-copilot-summary";this.aiJobResultAndCallRecordAction="crm.timeline.ai.getCopilotSummaryAndCallRecord";this.sliderTitle=_.Loc.getMessage("CRM_COMMON_COPILOT");this.sliderWidth=520;this.textboxTitle=_.Loc.getMessage("CRM_COPILOT_CALL_SUMMARY_TITLE")}},{key:"getNotAccuratePhraseCode",value:function t(){return"CRM_COPILOT_CALL_SUMMARY_NOT_BE_ACCURATE"}},{key:"prepareAiJobResult",value:function t(e){return e.data.aiJobResult.summary}}]);return e}(b);var Yt=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).apply(this,arguments))}babelHelpers.createClass(e,[{key:"initDefaultOptions",value:function t(){this.id="crm-copilot-transcript";this.aiJobResultAndCallRecordAction="crm.timeline.ai.getCopilotTranscriptAndCallRecord";this.sliderTitle=_.Loc.getMessage("CRM_COMMON_COPILOT");this.sliderWidth=730;this.textboxTitle=_.Loc.getMessage("CRM_COPILOT_CALL_TRANSCRIPT_TITLE")}},{key:"getNotAccuratePhraseCode",value:function t(){return"CRM_COPILOT_CALL_TRANSCRIPT_NOT_BE_ACCURATE"}},{key:"prepareAiJobResult",value:function t(e){return e.data.aiJobResult.transcription}}]);return e}(b);var Qt={Summary:Vt,Transcription:Yt,CallQuality:Xt};t.Call=Qt})(this.BX.Crm.AI=this.BX.Crm.AI||{},BX.Vue3,BX.Crm.AI,BX.Crm.AI,BX,BX.Crm,BX,BX.UI,BX.Crm.Copilot,BX.Crm.Timeline,BX.Event,BX.UI.BBCode.Formatter,BX,BX,BX);
//# sourceMappingURL=call.bundle.map.js