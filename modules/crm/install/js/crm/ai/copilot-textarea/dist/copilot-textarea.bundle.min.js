this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,i,l,a){"use strict";var s,r;var n=["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","borderStyle","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","tabSize","MozTabSize"];function o(e,t){var i=window.mozInnerScreenX!==null;var l=a.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(["<div id='textarea-caret-position-dummy-div'></div>"])));a.Dom.append(l,document.body);var o=l.style;var c=window.getComputedStyle?window.getComputedStyle(e):e.currentStyle;var d=e.nodeName==="INPUT";o.whiteSpace="pre-wrap";if(!d){o.wordWrap="break-word"}o.position="absolute";o.visibility="hidden";n.forEach((function(e){if(d&&e==="lineHeight"){if(c.boxSizing==="border-box"){var t=parseInt(c.height,10);var i=parseInt(c.paddingTop,10)+parseInt(c.paddingBottom,10)+parseInt(c.borderTopWidth,10)+parseInt(c.borderBottomWidth,10);var l=i+parseInt(c.lineHeight,10);if(t>l){o.lineHeight="".concat(t-i,"px")}else if(t===l){o.lineHeight=c.lineHeight}else{o.lineHeight=0}}else{o.lineHeight=c.height}}else{o[e]=c[e]}}));if(i){if(e.scrollHeight>parseInt(c.height,10)){o.overflowY="scroll"}}else{o.overflow="hidden"}l.textContent=e.value.slice(0,Math.max(0,t));if(d){l.textContent=l.textContent.replaceAll(/\s/g,"\xa0")}var h=a.Tag.render(r||(r=babelHelpers.taggedTemplateLiteral(["<span></span>"])));h.textContent=e.value.slice(Math.max(0,t))||".";a.Dom.append(h,l);var b={top:h.offsetTop+parseInt(c.borderTopWidth,10),left:h.offsetLeft+parseInt(c.borderLeftWidth,10)};a.Dom.remove(l);return b}var c;function d(e,t){b(e,t);t.add(e)}function h(e,t,i){b(e,t);t.set(e,i)}function b(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function v(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var p=80;var u=32;var f="<<<";var w=">>>";var g={EVENT_VALUE_CHANGE:"crm:ai:copilot-textarea:value-change"};var H=new WeakMap;var P=new WeakMap;var F=new WeakMap;var m=new WeakMap;var S=new WeakMap;var G=new WeakMap;var T=new WeakMap;var x=new WeakSet;var C=new WeakSet;var y=new WeakSet;var E=new WeakSet;var k=new WeakSet;var W=new WeakSet;var I=new WeakSet;var B=new WeakSet;var A=new WeakSet;var X=new WeakSet;var M=new WeakSet;var R=new WeakSet;var L=new WeakSet;var _=new WeakSet;var D=new WeakSet;var O=new WeakSet;var z=new WeakSet;var N=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);d(this,z);d(this,O);d(this,D);d(this,_);d(this,L);d(this,R);d(this,M);d(this,X);d(this,A);d(this,B);d(this,I);d(this,W);d(this,k);d(this,E);d(this,y);d(this,C);d(this,x);h(this,H,{writable:true,value:void 0});h(this,P,{writable:true,value:void 0});h(this,F,{writable:true,value:void 0});h(this,m,{writable:true,value:false});h(this,S,{writable:true,value:false});h(this,G,{writable:true,value:null});h(this,T,{writable:true,value:""});v(this,I,K).call(this,t);babelHelpers.classPrivateFieldSet(this,H,t.id);babelHelpers.classPrivateFieldSet(this,F,t.target);babelHelpers.classPrivateFieldSet(this,P,new l.Copilot(t.copilotParams));babelHelpers.classPrivateFieldSet(this,m,t.isDebugEnabled||false);v(this,y,U).call(this);babelHelpers.classPrivateFieldGet(this,P).init();a.Event.bind(babelHelpers.classPrivateFieldGet(this,F),"keydown",(function(e){return v(i,E,Y).call(i,e)}));a.Event.bind(babelHelpers.classPrivateFieldGet(this,F),"select",(function(e){return v(i,k,q).call(i,e)}))}babelHelpers.createClass(e,[{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,H)}},{key:"setReadOnly",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;if(t){babelHelpers.classPrivateFieldGet(this,F).setAttribute("readonly",1)}else{babelHelpers.classPrivateFieldGet(this,F).removeAttribute("readonly")}}}]);return e}();function j(e){var t=this;var i=v(this,M,ee).call(this);if(!i){return}var l=e.context||"";var s=e.selectedText||"";babelHelpers.classPrivateFieldGet(this,P).setContext(l);babelHelpers.classPrivateFieldGet(this,P).setSelectedText(s);babelHelpers.classPrivateFieldGet(this,P).show({bindElement:i,width:babelHelpers.classPrivateFieldGet(this,F).offsetWidth-10});babelHelpers.classPrivateFieldGet(this,P).subscribe("cancel",(function(e){v(t,z,re).call(t,"CoPilot canceled",e);v(t,L,ie).call(t);babelHelpers.classPrivateFieldGet(t,P).adjust({hide:false,position:v(t,M,ee).call(t)})}));var r=v(this,W,J).bind(this);babelHelpers.classPrivateFieldGet(this,P).subscribe("hide",(function(e){v(t,z,re).call(t,"CoPilot hidden",e);a.Event.unbind(window,"keyup",r)}));a.Event.bind(window,"keyup",r)}function V(){var e=this;var t=a.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<button class="show-copilot-btn">\n\t\t\t\t<div class="show-copilot-btn-icon ui-icon-set --copilot-ai"></div>\n\t\t\t\t',"\n\t\t\t</button>\n\t\t"])),a.Loc.getMessage("CRM_COMMON_COPILOT").toUpperCase());a.Event.bind(t,"click",(function(t){v(e,x,j).call(e,{context:v(e,A,Z).call(e),selectedText:babelHelpers.classPrivateFieldGet(e,T)});babelHelpers.classPrivateFieldGet(e,G).close()}));var l=v(this,M,ee).call(this);babelHelpers.classPrivateFieldSet(this,G,new i.Popup({id:"copilot_textarea_popup_button_".concat(a.Text.getRandom(5)),content:t,bindElement:{top:l.top-u/2,left:l.left+(babelHelpers.classPrivateFieldGet(this,F).offsetWidth/2-p/2)},padding:5,borderRadius:"4px"}));a.Event.bind(document,"keyup",(function(t){v(e,L,ie).call(e);babelHelpers.classPrivateFieldGet(e,G).close()}));a.Event.bind(t,"click",(function(){babelHelpers.classPrivateFieldGet(e,G).close()}));setTimeout((function(){a.Event.bind(window,"mouseup",(function(t){babelHelpers.classPrivateFieldGet(e,G).close()}))}),100);babelHelpers.classPrivateFieldGet(this,G).show()}function U(){var e=this;babelHelpers.classPrivateFieldGet(this,P).subscribe("start-init",(function(t){v(e,z,re).call(e,"CoPilot load start",t);e.setReadOnly()}));babelHelpers.classPrivateFieldGet(this,P).subscribe("finish-init",(function(t){v(e,z,re).call(e,"CoPilot loaded",t);babelHelpers.classPrivateFieldSet(e,S,true);e.setReadOnly(false)}));babelHelpers.classPrivateFieldGet(this,P).subscribe("aiResult",(function(t){v(e,z,re).call(e,"CoPilot result received",t);var i="";if(a.Type.isStringFilled(babelHelpers.classPrivateFieldGet(e,T))){var l=babelHelpers.classPrivateFieldGet(e,F).selectionStart;var s=babelHelpers.classPrivateFieldGet(e,F).selectionEnd;var r=v(e,A,Z).call(e);i=r.slice(0,Math.max(0,l))+v(e,R,te).call(e,t.data.result)+r.slice(s,r.length)}else{i=v(e,A,Z).call(e)+v(e,R,te).call(e,t.data.result)}v(e,X,$).call(e,i);babelHelpers.classPrivateFieldGet(e,P).adjust({hide:false,position:v(e,M,ee).call(e)})}));babelHelpers.classPrivateFieldGet(this,P).subscribe("save",(function(t){v(e,z,re).call(e,"CoPilot result saved",t);v(e,D,ae).call(e,t.data.result);v(e,_,le).call(e);babelHelpers.classPrivateFieldGet(e,P).hide()}));babelHelpers.classPrivateFieldGet(this,P).subscribe("add_below",(function(t){v(e,z,re).call(e,"CoPilot result text place below",t);var i=v(e,A,Z).call(e);v(e,X,$).call(e,"".concat(i,"\n").concat(t.data.result));babelHelpers.classPrivateFieldGet(e,P).hide()}))}function Y(e){var t=e.key===" "||e.code==="Space";if(!t||!babelHelpers.classPrivateFieldGet(this,S)||babelHelpers.classPrivateFieldGet(this,P).isShown()||!v(this,B,Q).call(this)){return}v(this,z,re).call(this,"Space pressed",e);v(this,x,j).call(this,{context:v(this,A,Z).call(this),selectedText:""});e.preventDefault()}function q(e){var t,i=this;var l=e.target;if(!l){return}if((t=babelHelpers.classPrivateFieldGet(this,G))!==null&&t!==void 0&&t.isShown()){return}babelHelpers.classPrivateFieldSet(this,T,l.value.slice(l.selectionStart,l.selectionEnd));if(a.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,T))){v(this,z,re).call(this,"Text selected",e);setTimeout((function(){return v(i,C,V).call(i)}),100)}}function J(e){if(e.key==="Escape"&&babelHelpers.classPrivateFieldGet(this,P).isShown()){v(this,_,le).call(this);babelHelpers.classPrivateFieldGet(this,P).hide();babelHelpers.classPrivateFieldGet(this,F).focus()}}function K(e){if(!a.Type.isPlainObject(e)){throw new TypeError("BX.Crm.AI.CopilotTextarea: The CoPilot textarea params must be object")}if(!a.Type.isStringFilled(e.id)){throw new TypeError('BX.Crm.AI.CopilotTextarea: The "id" argument must be filled')}if(!a.Type.isDomNode(e.target)){throw new Error('BX.Crm.AI.CopilotTextarea: The "target" argument must be DOM node')}if(e.target.tagName.toLowerCase()!=="textarea"){throw new Error('BX.Crm.AI.CopilotTextarea: The "target" argument must be textarea element')}}function Q(){var e=v(this,A,Z).call(this);var t=v(this,O,se).call(this);var i=e.lastIndexOf("\n",t.selectionStart-1)+1;return!a.Type.isStringFilled(e.slice(i,t.selectionStart))}function Z(){return v(this,O,se).call(this).value}function $(e){if(v(this,O,se).call(this).value===e){return}v(this,O,se).call(this).value=e;a.Dom.style(babelHelpers.classPrivateFieldGet(this,F),"height","auto");var i=v(this,O,se).call(this).scrollHeight;a.Dom.style(babelHelpers.classPrivateFieldGet(this,F),"height","".concat(i,"px"));t.EventEmitter.emit(this,g.EVENT_VALUE_CHANGE,{id:babelHelpers.classPrivateFieldGet(this,H),value:e})}function ee(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;var t=babelHelpers.classPrivateFieldGet(this,F).getBoundingClientRect();if(t.top===0&&t.right===0&&t.bottom===0&&t.left===0){return null}var i=o(babelHelpers.classPrivateFieldGet(this,F),babelHelpers.classPrivateFieldGet(this,F).selectionEnd);return{left:e?t.left+window.scrollX+5:t.left+window.scrollX+i.left+2,top:t.top+window.scrollY+i.top+21}}function te(e){return f+e+w}function ie(){var e=new RegExp("".concat(f,"(.*)").concat(w),"gs");v(this,X,$).call(this,v(this,A,Z).call(this).replaceAll(e,""))}function le(){var e=new RegExp(f,"gs");var t=new RegExp(w,"gs");v(this,X,$).call(this,v(this,A,Z).call(this).replaceAll(e,"").replaceAll(t,""))}function ae(e){if(a.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,T))&&a.Type.isStringFilled(e)){v(this,X,$).call(this,v(this,A,Z).call(this).replace(babelHelpers.classPrivateFieldGet(this,T),e))}}function se(){return BX(babelHelpers.classPrivateFieldGet(this,F))}function re(e,t){if(babelHelpers.classPrivateFieldGet(this,m)){console.debug(e,t)}}e.Events=g;e.CopilotTextarea=N})(this.BX.Crm.AI=this.BX.Crm.AI||{},BX.Event,BX.Main,BX.AI,BX);
//# sourceMappingURL=copilot-textarea.bundle.map.js