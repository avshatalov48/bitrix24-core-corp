{"version":3,"file":"copilot-textarea.bundle.js","sources":["../src/textarea-caret-coordinates.js","../src/copilot-textarea.js"],"sourcesContent":["import { Dom, Tag } from 'main.core';\n\nconst PROPERTIES = [\n\t'direction',\n\t'boxSizing',\n\t'width',\n\t'height',\n\t'overflowX',\n\t'overflowY',\n\t'borderTopWidth',\n\t'borderRightWidth',\n\t'borderBottomWidth',\n\t'borderLeftWidth',\n\t'borderStyle',\n\t'paddingTop',\n\t'paddingRight',\n\t'paddingBottom',\n\t'paddingLeft',\n\t'fontStyle',\n\t'fontVariant',\n\t'fontWeight',\n\t'fontStretch',\n\t'fontSize',\n\t'fontSizeAdjust',\n\t'lineHeight',\n\t'fontFamily',\n\t'textAlign',\n\t'textTransform',\n\t'textIndent',\n\t'textDecoration',\n\t'letterSpacing',\n\t'wordSpacing',\n\t'tabSize',\n\t'MozTabSize',\n];\n\nexport type Coordinates = {\n\ttop: number,\n\tleft: number,\n};\n\n// eslint-disable-next-line sonarjs/cognitive-complexity\nexport function getCaretCoordinates(element: HTMLElement, position: number): Coordinates\n{\n\t// eslint-disable-next-line no-eq-null\n\tconst isFirefox = window.mozInnerScreenX !== null;\n\n\tconst dummyEl = Tag.render`<div id='textarea-caret-position-dummy-div'></div>`;\n\tDom.append(dummyEl, document.body);\n\n\tconst style = dummyEl.style;\n\tconst computed = window.getComputedStyle\n\t\t? window.getComputedStyle(element)\n\t\t: element.currentStyle;\n\tconst isInput = element.nodeName === 'INPUT';\n\n\tstyle.whiteSpace = 'pre-wrap';\n\tif (!isInput)\n\t{\n\t\tstyle.wordWrap = 'break-word';\n\t}\n\n\t// Position off-screen\n\tstyle.position = 'absolute'; // required to return coordinates properly\n\tstyle.visibility = 'hidden'; // not 'display: none' because we want rendering\n\n\t// Transfer the element's properties to the div\n\tPROPERTIES.forEach((prop) => {\n\t\tif (isInput && prop === 'lineHeight')\n\t\t{\n\t\t\t// Special case for <input>s because text is rendered centered and line height may be != height\n\t\t\tif (computed.boxSizing === 'border-box')\n\t\t\t{\n\t\t\t\tconst height = parseInt(computed.height, 10);\n\t\t\t\tconst outerHeight = parseInt(computed.paddingTop, 10)\n\t\t\t\t\t+ parseInt(computed.paddingBottom, 10)\n\t\t\t\t\t+ parseInt(computed.borderTopWidth, 10)\n\t\t\t\t\t+ parseInt(computed.borderBottomWidth, 10)\n\t\t\t\t;\n\n\t\t\t\tconst targetHeight = outerHeight + parseInt(computed.lineHeight, 10);\n\t\t\t\tif (height > targetHeight)\n\t\t\t\t{\n\t\t\t\t\tstyle.lineHeight = `${height - outerHeight}px`;\n\t\t\t\t}\n\t\t\t\telse if (height === targetHeight)\n\t\t\t\t{\n\t\t\t\t\tstyle.lineHeight = computed.lineHeight;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tstyle.lineHeight = 0;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tstyle.lineHeight = computed.height;\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tstyle[prop] = computed[prop];\n\t\t}\n\t});\n\n\tif (isFirefox)\n\t{\n\t\tif (element.scrollHeight > parseInt(computed.height, 10))\n\t\t{\n\t\t\tstyle.overflowY = 'scroll';\n\t\t}\n\t}\n\telse\n\t{\n\t\tstyle.overflow = 'hidden';\n\t}\n\n\tdummyEl.textContent = element.value.slice(0, Math.max(0, position));\n\n\tif (isInput)\n\t{\n\t\tdummyEl.textContent = dummyEl.textContent.replaceAll(/\\s/g, '\\u00A0');\n\t}\n\n\tconst spanEl = Tag.render`<span></span>`;\n\tspanEl.textContent = element.value.slice(Math.max(0, position)) || '.'; // || because a completely empty faux span doesn't render at all\n\tDom.append(spanEl, dummyEl);\n\n\tconst coordinates = {\n\t\ttop: spanEl.offsetTop + parseInt(computed.borderTopWidth, 10),\n\t\tleft: spanEl.offsetLeft + parseInt(computed.borderLeftWidth, 10),\n\t};\n\n\tDom.remove(dummyEl);\n\n\treturn coordinates;\n}\n","import { Dom, Event, Loc, Tag, Text, Type } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { Popup } from 'main.popup';\nimport { Copilot } from 'ai.copilot';\n\nimport { getCaretCoordinates } from './textarea-caret-coordinates';\n\nimport 'ui.design-tokens';\nimport './copilot-textarea.css';\n\ndeclare type CopilotTextareaParams = {\n\tid: string,\n\ttarget: HTMLElement,\n\tcopilotParams: Object,\n\tisDebugEnabled: ?boolean,\n};\n\ndeclare type ShowCopilotParams = {\n\tcontext: string,\n\tselectedText: string,\n};\n\nconst COPILOT_BUTTON_WIDTH = 80;\nconst COPILOT_BUTTON_HEIGHT = 32;\nconst COPILOT_RESULT_TEXT_WRAP_LEFT = '<<<';\nconst COPILOT_RESULT_TEXT_WRAP_RIGHT = '>>>';\n\nexport const Events = {\n\tEVENT_VALUE_CHANGE: 'crm:ai:copilot-textarea:value-change',\n};\n\nexport class CopilotTextarea\n{\n\t#id: string;\n\t#copilot: any;\n\t#element: HTMLElement;\n\t#isDebugEnabled: boolean = false;\n\t#copilotLoaded: boolean = false;\n\t#copilotBtnPopup: ?Popup = null;\n\t#currentSelectedText: string = '';\n\n\tconstructor(params: CopilotTextareaParams)\n\t{\n\t\tthis.#assertValidParams(params);\n\n\t\tthis.#id = params.id;\n\t\tthis.#element = params.target;\n\t\tthis.#copilot = new Copilot(params.copilotParams); // @see CopilotOptions [ai/install/js/ai/copilot/src/copilot.js]\n\t\tthis.#isDebugEnabled = params.isDebugEnabled || false;\n\n\t\tthis.#bindHandlers();\n\t\tthis.#copilot.init();\n\n\t\tEvent.bind(this.#element, 'keydown', (event: BaseEvent) => this.#handleKeyDown(event));\n\t\tEvent.bind(this.#element, 'select', (event: BaseEvent) => this.#handleSelect(event));\n\t}\n\n\tgetId(): string\n\t{\n\t\treturn this.#id;\n\t}\n\n\tsetReadOnly(flag: boolean = true): void\n\t{\n\t\t// NOTE: Dom.attr method NOT WORKED, so use setAttribute/removeAttribute\n\t\tif (flag)\n\t\t{\n\t\t\tthis.#element.setAttribute('readonly', 1);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#element.removeAttribute('readonly');\n\t\t}\n\t}\n\n\t#showCopilot(params: ShowCopilotParams): void\n\t{\n\t\tconst coordinates = this.#getElementCoordinates();\n\t\tif (!coordinates)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst context = params.context || '';\n\t\tconst selectedText = params.selectedText || '';\n\n\t\tthis.#copilot.setContext(context);\n\t\tthis.#copilot.setSelectedText(selectedText);\n\t\tthis.#copilot.show({\n\t\t\tbindElement: coordinates,\n\t\t\twidth: this.#element.offsetWidth - 10,\n\t\t});\n\n\t\tthis.#copilot.subscribe('cancel', (event) => {\n\t\t\tthis.#logEventInfo('CoPilot canceled', event);\n\n\t\t\tthis.#cleanWrappedText();\n\t\t\tthis.#copilot.adjust({\n\t\t\t\thide: false,\n\t\t\t\tposition: this.#getElementCoordinates(),\n\t\t\t});\n\t\t});\n\n\t\tconst handleKeyUpEscape = this.#handleKeyUpEscape.bind(this);\n\t\tthis.#copilot.subscribe('hide', (event) => {\n\t\t\tthis.#logEventInfo('CoPilot hidden', event);\n\n\t\t\tEvent.unbind(window, 'keyup', handleKeyUpEscape);\n\t\t});\n\t\tEvent.bind(window, 'keyup', handleKeyUpEscape);\n\t}\n\n\t#showCopilotButton(): void\n\t{\n\t\tconst copilotButton = Tag.render`\n\t\t\t<button class=\"show-copilot-btn\">\n\t\t\t\t<div class=\"show-copilot-btn-icon ui-icon-set --copilot-ai\"></div>\n\t\t\t\t${Loc.getMessage('CRM_COMMON_COPILOT').toUpperCase()}\n\t\t\t</button>\n\t\t`;\n\n\t\tEvent.bind(copilotButton, 'click', (event) => {\n\t\t\tthis.#showCopilot({\n\t\t\t\tcontext: this.#getTextAreaValue(),\n\t\t\t\tselectedText: this.#currentSelectedText,\n\t\t\t});\n\t\t\tthis.#copilotBtnPopup.close();\n\t\t});\n\n\t\tconst coordinates = this.#getElementCoordinates();\n\n\t\tthis.#copilotBtnPopup = new Popup({\n\t\t\tid: `copilot_textarea_popup_button_${Text.getRandom(5)}`,\n\t\t\tcontent: copilotButton,\n\t\t\tbindElement: {\n\t\t\t\ttop: coordinates.top - (COPILOT_BUTTON_HEIGHT / 2),\n\t\t\t\tleft: coordinates.left + (this.#element.offsetWidth / 2 - COPILOT_BUTTON_WIDTH / 2),\n\t\t\t},\n\t\t\tpadding: 5,\n\t\t\tborderRadius: '4px',\n\t\t});\n\n\t\tEvent.bind(document, 'keyup', (event) => {\n\t\t\tthis.#cleanWrappedText();\n\n\t\t\tthis.#copilotBtnPopup.close();\n\t\t});\n\n\t\tEvent.bind(copilotButton, 'click', () => {\n\t\t\tthis.#copilotBtnPopup.close();\n\t\t});\n\n\t\tsetTimeout(() => {\n\t\t\tEvent.bind(window, 'mouseup', (event) => {\n\t\t\t\tthis.#copilotBtnPopup.close();\n\t\t\t});\n\t\t}, 100);\n\n\t\tthis.#copilotBtnPopup.show();\n\t}\n\n\t// region Handlers\n\t#bindHandlers(): void\n\t{\n\t\tthis.#copilot.subscribe('start-init', (event) => {\n\t\t\tthis.#logEventInfo('CoPilot load start', event);\n\t\t\tthis.setReadOnly();\n\t\t});\n\n\t\tthis.#copilot.subscribe('finish-init', (event) => {\n\t\t\tthis.#logEventInfo('CoPilot loaded', event);\n\t\t\tthis.#copilotLoaded = true;\n\t\t\tthis.setReadOnly(false);\n\t\t});\n\n\t\tthis.#copilot.subscribe('aiResult', (event) => {\n\t\t\tthis.#logEventInfo('CoPilot result received', event);\n\n\t\t\tlet newValue = '';\n\t\t\tif (Type.isStringFilled(this.#currentSelectedText))\n\t\t\t{\n\t\t\t\tconst start = this.#element.selectionStart;\n\t\t\t\tconst end = this.#element.selectionEnd;\n\t\t\t\tconst allText = this.#getTextAreaValue();\n\n\t\t\t\tnewValue = allText.slice(0, Math.max(0, start))\n\t\t\t\t\t+ this.#wrapText(event.data.result)\n\t\t\t\t\t+ allText.slice(end, allText.length)\n\t\t\t\t;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tnewValue = this.#getTextAreaValue() + this.#wrapText(event.data.result);\n\t\t\t}\n\n\t\t\tthis.#setTextAreaValue(newValue);\n\t\t\tthis.#copilot.adjust({\n\t\t\t\thide: false,\n\t\t\t\tposition: this.#getElementCoordinates(),\n\t\t\t});\n\t\t});\n\n\t\tthis.#copilot.subscribe('save', (event) => {\n\t\t\tthis.#logEventInfo('CoPilot result saved', event);\n\n\t\t\tthis.#replaceSelectionText(event.data.result);\n\t\t\tthis.#cleanWrapChars();\n\t\t\tthis.#copilot.hide();\n\t\t});\n\n\t\tthis.#copilot.subscribe('add_below', (event) => {\n\t\t\tthis.#logEventInfo('CoPilot result text place below', event);\n\n\t\t\tconst currentText = this.#getTextAreaValue();\n\t\t\tthis.#setTextAreaValue(`${currentText}\\n${event.data.result}`);\n\t\t\tthis.#copilot.hide();\n\t\t});\n\t}\n\n\t#handleKeyDown(event: BaseEvent): void\n\t{\n\t\tconst isSpacePressed = event.key === ' ' || event.code === 'Space';\n\n\t\tif (\n\t\t\t!isSpacePressed\n\t\t\t|| !this.#copilotLoaded\n\t\t\t|| this.#copilot.isShown()\n\t\t\t|| !this.#isCursorAtBeginningOfLine()\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#logEventInfo('Space pressed', event);\n\n\t\tthis.#showCopilot({\n\t\t\tcontext: this.#getTextAreaValue(),\n\t\t\tselectedText: '',\n\t\t});\n\n\t\tevent.preventDefault();\n\t}\n\n\t#handleSelect(event: BaseEvent): void\n\t{\n\t\tconst target = event.target;\n\t\tif (!target)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#copilotBtnPopup?.isShown())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#currentSelectedText = target.value.slice(target.selectionStart, target.selectionEnd);\n\t\tif (Type.isStringFilled(this.#currentSelectedText))\n\t\t{\n\t\t\tthis.#logEventInfo('Text selected', event);\n\n\t\t\tsetTimeout(() => this.#showCopilotButton(), 100);\n\t\t}\n\t}\n\n\t#handleKeyUpEscape(event: BaseEvent): void\n\t{\n\t\tif (event.key === 'Escape' && this.#copilot.isShown())\n\t\t{\n\t\t\tthis.#cleanWrapChars();\n\t\t\tthis.#copilot.hide();\n\t\t\tthis.#element.focus();\n\t\t}\n\t}\n\t// endregion\n\n\t// region Utils\n\t#assertValidParams(params: CopilotTextareaParams): void\n\t{\n\t\tif (!Type.isPlainObject(params))\n\t\t{\n\t\t\tthrow new TypeError('BX.Crm.AI.CopilotTextarea: The CoPilot textarea params must be object');\n\t\t}\n\n\t\tif (!Type.isStringFilled(params.id))\n\t\t{\n\t\t\tthrow new TypeError('BX.Crm.AI.CopilotTextarea: The \"id\" argument must be filled');\n\t\t}\n\n\t\tif (!Type.isDomNode(params.target))\n\t\t{\n\t\t\tthrow new Error('BX.Crm.AI.CopilotTextarea: The \"target\" argument must be DOM node');\n\t\t}\n\n\t\tif (params.target.tagName.toLowerCase() !== 'textarea')\n\t\t{\n\t\t\tthrow new Error('BX.Crm.AI.CopilotTextarea: The \"target\" argument must be textarea element');\n\t\t}\n\t}\n\n\t#isCursorAtBeginningOfLine(): boolean\n\t{\n\t\tconst val = this.#getTextAreaValue();\n\t\tconst element = this.#getElement();\n\t\tconst currentLineIndex = val.lastIndexOf('\\n', element.selectionStart - 1) + 1;\n\n\t\treturn !Type.isStringFilled(val.slice(currentLineIndex, element.selectionStart));\n\t}\n\n\t#getTextAreaValue(): string\n\t{\n\t\treturn this.#getElement().value;\n\t}\n\n\t#setTextAreaValue(value: string): void\n\t{\n\t\tif (this.#getElement().value === value)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#getElement().value = value;\n\t\tDom.style(this.#element, 'height', 'auto');\n\n\t\tconst currentTextareaHeight = this.#getElement().scrollHeight;\n\t\tDom.style(this.#element, 'height', `${currentTextareaHeight}px`);\n\n\t\tEventEmitter.emit(this, Events.EVENT_VALUE_CHANGE, { id: this.#id, value });\n\t}\n\n\t#getElementCoordinates(pressToLeft: boolean = true): ?Coordinates\n\t{\n\t\tconst elementRect = this.#element.getBoundingClientRect();\n\t\tif (\n\t\t\telementRect.top === 0\n\t\t\t&& elementRect.right === 0\n\t\t\t&& elementRect.bottom === 0\n\t\t\t&& elementRect.left === 0\n\t\t)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst coordinates = getCaretCoordinates(this.#element, this.#element.selectionEnd);\n\n\t\treturn {\n\t\t\tleft: pressToLeft\n\t\t\t\t? elementRect.left + window.scrollX + 5\n\t\t\t\t: elementRect.left + window.scrollX + coordinates.left + 2,\n\t\t\ttop: elementRect.top + window.scrollY + coordinates.top + 21,\n\t\t};\n\t}\n\n\t#wrapText(text: string): string\n\t{\n\t\treturn COPILOT_RESULT_TEXT_WRAP_LEFT + text + COPILOT_RESULT_TEXT_WRAP_RIGHT;\n\t}\n\n\t#cleanWrappedText(): void\n\t{\n\t\tconst re = new RegExp(\n\t\t\t`${COPILOT_RESULT_TEXT_WRAP_LEFT}(.*)${COPILOT_RESULT_TEXT_WRAP_RIGHT}`,\n\t\t\t'gs',\n\t\t);\n\n\t\tthis.#setTextAreaValue(this.#getTextAreaValue().replaceAll(re, ''));\n\t}\n\n\t#cleanWrapChars(): void\n\t{\n\t\tconst wrapLeftRe = new RegExp(COPILOT_RESULT_TEXT_WRAP_LEFT, 'gs');\n\t\tconst wrapRightRe = new RegExp(COPILOT_RESULT_TEXT_WRAP_RIGHT, 'gs');\n\n\t\tthis.#setTextAreaValue(\n\t\t\tthis.#getTextAreaValue()\n\t\t\t\t.replaceAll(wrapLeftRe, '')\n\t\t\t\t.replaceAll(wrapRightRe, ''),\n\t\t);\n\t}\n\n\t#replaceSelectionText(text: string): void\n\t{\n\t\tif (\n\t\t\tType.isStringFilled(this.#currentSelectedText)\n\t\t\t&& Type.isStringFilled(text)\n\t\t)\n\t\t{\n\t\t\tthis.#setTextAreaValue(this.#getTextAreaValue().replace(this.#currentSelectedText, text));\n\t\t}\n\t}\n\n\t#getElement(): HTMLElement\n\t{\n\t\treturn BX(this.#element);\n\t}\n\n\t#logEventInfo(name: string, event: BaseEvent): void\n\t{\n\t\tif (this.#isDebugEnabled)\n\t\t{\n\t\t\t// eslint-disable-next-line no-console\n\t\t\tconsole.debug(name, event);\n\t\t}\n\t}\n\t// endregion\n}\n"],"names":["PROPERTIES","getCaretCoordinates","element","position","isFirefox","window","mozInnerScreenX","dummyEl","Tag","render","Dom","append","document","body","style","computed","getComputedStyle","currentStyle","isInput","nodeName","whiteSpace","wordWrap","visibility","forEach","prop","boxSizing","height","parseInt","outerHeight","paddingTop","paddingBottom","borderTopWidth","borderBottomWidth","targetHeight","lineHeight","scrollHeight","overflowY","overflow","textContent","value","slice","Math","max","replaceAll","spanEl","coordinates","top","offsetTop","left","offsetLeft","borderLeftWidth","remove","COPILOT_BUTTON_WIDTH","COPILOT_BUTTON_HEIGHT","COPILOT_RESULT_TEXT_WRAP_LEFT","COPILOT_RESULT_TEXT_WRAP_RIGHT","Events","EVENT_VALUE_CHANGE","CopilotTextarea","params","id","target","Copilot","copilotParams","isDebugEnabled","init","Event","bind","event","flag","setAttribute","removeAttribute","context","selectedText","setContext","setSelectedText","show","bindElement","width","offsetWidth","subscribe","adjust","hide","handleKeyUpEscape","unbind","copilotButton","Loc","getMessage","toUpperCase","close","Popup","Text","getRandom","content","padding","borderRadius","setTimeout","setReadOnly","newValue","Type","isStringFilled","start","selectionStart","end","selectionEnd","allText","data","result","length","currentText","isSpacePressed","key","code","isShown","preventDefault","focus","isPlainObject","TypeError","isDomNode","Error","tagName","toLowerCase","val","currentLineIndex","lastIndexOf","currentTextareaHeight","EventEmitter","emit","pressToLeft","elementRect","getBoundingClientRect","right","bottom","scrollX","scrollY","text","re","RegExp","wrapLeftRe","wrapRightRe","replace","BX","name","console","debug"],"mappings":"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"}