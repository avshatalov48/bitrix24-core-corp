this.BX=this.BX||{},function(e,t,s,i,o,l,a,n,r,d,c,u){"use strict";const b=e=>new Promise((t=>{setTimeout(t,e)})),p=async(e,t,s)=>{if(s<=0)return;const i=(t-e.scrollTop)/s*10;await b(10),e.scrollTop+=i,e.scrollTop!==t&&await p(e,t,s-10)},h={name:"CloseConfirm",data:()=>({messageBoxInstance:null,uniquePopupId:"ai-form-fill-feedback-popup_"+c.Text.getRandom(20).toLowerCase()}),computed:{...l.mapGetters(["isFooterHiddenAndSaveDisabled"])},methods:{...l.mapMutations(["setIsConfirmPopupShow"]),onMessageClose(e){e.uniquePopupId===this.uniquePopupId&&this.setIsConfirmPopupShow(!1)}},mounted(){this.messageBoxInstance=i.MessageBox.create({message:c.Loc.getMessage("CRM_AI_FORM_FILL_MERGER_CANCEL_CONFIRM_TEXT"),title:c.Loc.getMessage("CRM_AI_FORM_FILL_MERGER_CANCEL_CONFIRM_TITLE"),okCaption:c.Loc.getMessage("CRM_AI_FORM_FILL_MERGER_CANCEL_CONFIRM_CLOSE"),cancelCaption:c.Loc.getMessage("CRM_AI_FORM_FILL_MERGER_CANCEL_CONFIRM_CANCEL"),onOk:()=>{this.$Bitrix.eventEmitter.emit("crm:ai:form-fill:close-confirm:confirmClose",{})},onCancel:()=>{this.setIsConfirmPopupShow(!1)},buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,popupOptions:{targetContainer:this.$refs.closeConfirmRoot,id:this.uniquePopupId}}),c.addCustomEvent(window,"BX.Main.Popup:onClose",this.onMessageClose),this.messageBoxInstance.show()},unmounted(){this.messageBoxInstance&&this.messageBoxInstance.close(),c.removeCustomEvent(window,"BX.Main.Popup:onClose",this.onMessageClose)},template:'\n\t\t<div \n\t\t\tref="closeConfirmRoot" \n\t\t\tclass="crm-ai-form-fill__close-confirm"\n\t\t\t:class="{\'hidden-footer\': isFooterHiddenAndSaveDisabled}"\n\t\t></div>\n\t'},m={name:"EntityEditorWrapper",computed:{...l.mapGetters(["mergeUuid"]),entityEditorContainerId(){return`crm-ai-merge-fields__container__${this.mergeUuid}_container`}},template:'<div v-bind:id="entityEditorContainerId"></div>'},f={name:"FeedbackMessage",data:()=>({messageBoxInstance:null,uniquePopupId:"ai-form-fill-feedback-popup_"+c.Text.getRandom(20).toLowerCase()}),computed:{...l.mapGetters(["isFooterHiddenAndSaveDisabled"])},methods:{...l.mapActions(["closeFeedbackMessage","sendAiCallParsingData"]),async onOKButton(){this.closeFeedbackMessage(!0)},onCancelButton(){this.closeFeedbackMessage(!1),this.sendAiCallParsingData("feedback_refused")},onMessageClose(e){e.uniquePopupId===this.uniquePopupId&&this.closeFeedbackMessage(!1)}},mounted(){this.messageBoxInstance=a.createFeedbackMessageBox({onOk:this.onOKButton,onCancel:this.onCancelButton,popupOptions:{targetContainer:this.$refs.feedbackMessageRoot,id:this.uniquePopupId}}),c.addCustomEvent(window,"BX.Main.Popup:onClose",this.onMessageClose),this.messageBoxInstance.show()},unmounted(){this.messageBoxInstance&&this.messageBoxInstance.close(),c.removeCustomEvent(window,"BX.Main.Popup:onClose",this.onMessageClose)},template:'\n\t\t<div \n\t\t\tref="feedbackMessageRoot" \n\t\t\tclass="crm-ai-form-fill__confirm" \n\t\t\t:class="{\'hidden-footer\': isFooterHiddenAndSaveDisabled}"\n\t\t></div>\n\t'},F={name:"FloatingActionButton",computed:{...l.mapGetters({count:"getNotVisibleUnresolvedCount"}),showCounter(){return this.count>0}},methods:{click(){this.$Bitrix.eventEmitter.emit("crm:ai:form-fill:scroll-to-next",{})}},template:'\n\t\t<div @click="click" class="bx-crm-ai-merge-fields-fab">\n\t\t\t<div\n\t\t\t\tv-if="showCounter"\n\t\t\t\tclass="bx-crm-ai-merge-fields-fab_counter"\n\t\t\t>{{count}}</div>\n\t\t\t<i class="bx-crm-ai-merge-fields-fab_icon"></i>\n\t\t</div>\n\t'},C={name:"Main",components:{Loader:{name:"Loader",data:()=>({loaderInstance:null}),template:'\n\t\t<div ref="root" class="bx-crm-ai-merge-fields-loading">\n\t\t\t<div class="bx-crm-ai-merge-fields-loading__image"></div>\n\t\t</div>\n\t'},EntityEditorWrapper:m,ToolBar:{name:"ToolBar",computed:{...l.mapGetters(["conflictFields"]),conflictCount(){return this.conflictFields.length},resolvedCount(){return this.conflictFields.filter((e=>e.isAiValuesUsed)).length},isApplyAllDisabled(){return this.conflictCount===this.resolvedCount},isRevertDisabled(){return 0===this.resolvedCount},titleText:()=>c.Loc.getMessage("CRM_AI_FORM_FILL_TOOLBAR_CONFLICT_COUNT_TITLE"),applyAllBtnText:()=>c.Loc.getMessage("CRM_AI_FORM_FILL_TOOLBAR_BUTTON_APPLY_ALL"),revertText:()=>c.Loc.getMessage("CRM_AI_FORM_FILL_TOOLBAR_BUTTON_ROLLBACK")},methods:{...l.mapActions(["applyAllAiFields","revertAllAiFields"])},template:'\n\t\t<div class="bx-crm-ai-form-fill__toolbar">\n\t\t\t<div class="bx-crm-ai-form-fill__toolbar__conflict_count">\n\t\t\t\t{{ titleText }}<span class="bx-crm-ai-form-fill__toolbar__conflict_count__count">{{conflictCount}}</span>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tclass="bx-crm-ai-form-fill__toolbar__button"\n\t\t\t\t@click="applyAllAiFields"\n\t\t\t>{{ applyAllBtnText }}</div>\n\t\t\t<div\n\t\t\t\tclass="bx-crm-ai-form-fill__toolbar__button"\n\t\t\t\t@click="revertAllAiFields"\n\t\t\t>{{ revertText }}</div>\n\t\t</div>\n\t'},Merger:{name:"Merger",components:{MergeControl:{name:"MergeControl",props:{field:{type:Object,required:!0},tmp:Number},data:()=>({hasLargeContent:!0,isExpanded:!1,coveredByAnother:!1}),computed:{...l.mapGetters(["getexpandedConflictControls","eeControlPositions"]),replaceBtnText(){return this.field.isAiValuesUsed?c.Loc.getMessage("CRM_AI_FORM_FILL_MERGER_REPLACE_BTN_BACK"):c.Loc.getMessage("CRM_AI_FORM_FILL_MERGER_REPLACE_BTN_FORTH")},value(){return this.field.isAiValuesUsed?this.field.originalValue:this.field.aiValue}},methods:{...l.mapActions(["setEditorFieldValue","showEntityEditorControlOutline"]),...l.mapMutations(["toggleExpandedConflictControls"]),async toggleAiValue(e){await this.setEditorFieldValue(e),await this.expand(!1),this.hasLargeContent=this.checkHasLargeContent()},async expand(e){this.hasLargeContent&&(this.isExpanded=e,await o.nextTick(),this.toggleExpandedConflictControls({fieldId:this.field.name,size:this.$refs.root.getBoundingClientRect().height,isExpanded:e}))},onControlsExpandedModeChange(){let e=!1;const t=this.eeControlPositions.get(this.field.name,0);for(const[s,i]of this.getexpandedConflictControls){const o=this.eeControlPositions.get(s,0);if(t>o&&t-o<i){e=!0;break}}this.coveredByAnother=e},checkHasLargeContent(){return this.$refs.fieldValue.scrollWidth>this.$refs.fieldValue.clientWidth},onMouseenter(e){this.showEntityEditorControlOutline({fieldName:this.field.name,isShow:!0}),this.expand(!0)},onMouseleave(e){this.showEntityEditorControlOutline({fieldName:this.field.name,isShow:!1}),this.expand(!1)}},mounted(){this.hasLargeContent=this.checkHasLargeContent(),o.watch(this.getexpandedConflictControls,this.onControlsExpandedModeChange)},template:'\n\t\t<div \n\t\t\tclass="bx-crm-ai-form-fill-merge-control__container"\n\t\t\t:class="{\'expanded\': isExpanded, \'covered\': coveredByAnother}"\n\t\t\t@mouseenter="onMouseenter"\n\t\t\t@mouseleave="onMouseleave"\n\t\t\tref="root"\n\t\t>\n\t\t\t<div \n\t\t\t\tclass="bx-crm-ai-form-fill-merge-control-icon"\n\t\t\t\t@click="toggleAiValue(field)"\n\t\t\t>\n\n\t\t\t</div>\n\t\t\t<div class="bx-crm-ai-form-fill-merge-control-field">\n\t\t\t\t<div\n\t\t\t\t\tclass="bx-crm-ai-form-fill-merge-control-field-title"\n\t\t\t\t\t:title="field.title"\n\t\t\t\t>{{ field.title }}</div>\n\t\t\t\t<div class="bx-crm-ai-form-fill-merge-control-field-value-container">\n\t\t\t\t\t<div\n\t\t\t\t\t\tref="fieldValue"\n\t\t\t\t\t\tclass="bx-crm-ai-form-fill-merge-control-field-value-container__value"\n\t\t\t\t\t\t:class="{\'expanded\': isExpanded, \'ai-value\': !field.isAiValuesUsed}"\n\t\t\t\t\t\t:title="this.value"\n\t\t\t\t\t>{{ this.value }}</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="bx-crm-ai-form-fill-merge-control-field-value-container__control"\n\t\t\t\t\t\t:class="{\'expanded\': isExpanded}"\n\t\t\t\t\t\t:style="{display: hasLargeContent ? \'block\': \'none\'}"\n\t\t\t\t\t></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tclass="bx-crm-ai-form-fill-merge-control-right-column"\n\t\t\t\t@click="toggleAiValue(field)"\n\t\t\t>\n\t\t\t\t<div \n\t\t\t\t\tclass="bx-crm-ai-form-fill-merge-control-button">\n\t\t\t\t\t{{ replaceBtnText }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'}},data:()=>({isRootMounted:!1}),computed:{...l.mapGetters(["conflictFields","eeControlPosition","eeControlPositions","getMainLayoutScrollPosition"])},methods:{getControlTopOffset(e){return this.eeControlPositions.get(e.name,0)}},mounted(){this.isRootMounted=!0},template:'\n\t\t<div ref="root" class="bx-crm-ai-merge-fields-merger ">\n\t\t\t<MergeControl\n\t\t\t\tv-if="isRootMounted"\n\t\t\t\tv-for="field in conflictFields" :key="field.name"\n\t\t\t\tclass="bx-crm-ai-merge-fields-merger__field"\n\t\t\t\t:style="{top: getControlTopOffset(field) + \'px\'}"\n\t\t\t\t:field="field"\n\t\t\t\t:tmp="getControlTopOffset(field)"\n\t\t\t></MergeControl>\n\t\t</div>\n\t'},FloatingActionButton:F,CloseConfirm:h,FeedbackMessage:f},data:()=>({}),computed:{...l.mapGetters(["conflictFields","isLoading","eeControlPositions","getFirstUnseenFieldPosition","aiValuesAppliedCount","mergeUuid","isSliderConfirmPopupShown","isFeedbackMessageShown","isFooterHiddenAndSaveDisabled"])},methods:{...l.mapActions(["initialize","saveFormFieldsToMerge","updateControlPositionInfo","updateSliderFooter","closeFormWithoutConfirm","sendAiCallParsingData"]),...l.mapMutations(["changeMainLayoutScrollPosition","startLoading","stopLoading","setMainLayoutScrollHeight"]),onFooterSaveBtn(){this.saveFormFieldsToMerge().then((()=>this.sendAiCallParsingData("conflict_accept_changes"))).catch((()=>{}))},onFooterCancelBtn(){this.closeFormWithoutConfirm(),this.sendAiCallParsingData("conflict_cancel_changes")},onCloseConfirm(){this.closeFormWithoutConfirm()},handleScroll:null,positionChanged(){this.setMainLayoutScrollHeight(this.$refs.layout.scrollHeight),this.changeMainLayoutScrollPosition({scrollTop:this.$refs.layout.scrollTop,containerHeight:this.$refs.layout.getBoundingClientRect().height})},resizeHandler(){this.handleScroll()},scrollToNext(){const e=this.getFirstUnseenFieldPosition;e&&p(this.$refs.layout,e,300)},subscribeInternalEvents(){this.$Bitrix.eventEmitter.subscribe("crm:ai:form-fill:scroll-to-next",this.scrollToNext),this.$Bitrix.eventEmitter.subscribe("crm:ai:form-fill:close-confirm:confirmClose",this.onCloseConfirm),this.$Bitrix.eventEmitter.subscribe("crm:ai:form-fill:close-confirm:cancelClose",this.scrollToNext)},unSubscribeInternalEvents(){this.$Bitrix.eventEmitter.unsubscribe("crm:ai:form-fill:scroll-to-next",this.scrollToNext),this.$Bitrix.eventEmitter.unsubscribe("crm:ai:form-fill:close-confirm:confirmClose",this.onCloseConfirm),this.$Bitrix.eventEmitter.unsubscribe("crm:ai:form-fill:close-confirm:cancelClose",this.scrollToNext)},autoScrollToFirst(){const e=this.$refs.layout.getBoundingClientRect().height,t=this.getFirstUnseenFieldPosition;t&&t>e&&p(this.$refs.layout,t,800)}},async mounted(){this.updateSliderFooter(),this.startLoading(),this.handleScroll=c.Runtime.throttle((()=>{this.positionChanged()}),300),await this.initialize(),this.positionChanged(),this.subscribeInternalEvents(),await this.$nextTick((()=>{c.Event.bind(window,"resize",this.resizeHandler)})),this.stopLoading(),this.autoScrollToFirst(),e.sliderButtonsAdapter.onSaveCallback=this.onFooterSaveBtn,e.sliderButtonsAdapter.onCancelCallback=this.onFooterCancelBtn},watch:{aiValuesAppliedCount:{handler(e,t){this.updateSliderFooter()},immediate:!0}},unmounted(){this.unSubscribeInternalEvents(),c.Event.unbind(window,"resize",this.resizeHandler)},template:'\n\t\t<div class="bx-crm-ai-merge-fields" :class="{\'hidden-footer\': isFooterHiddenAndSaveDisabled}">\n\t\t\t<div \n\t\t\t\tclass="bx-crm-ai-merge-fields-layout" \n\t\t\t\t@scroll="handleScroll"\n\t\t\t\tref="layout"\n\t\t\t\t:style="{\'visibility\': !isLoading ? \'visible\' : \'hidden\'}"\n\t\t\t\t:class="{\'hidden-footer\': isFooterHiddenAndSaveDisabled}"\n\t\t\t>\n\t\t\t\t<EntityEditorWrapper class="bx-crm-ai-merge-fields-layout__ee_column"/>\n\t\t\t\t<Merger class="bx-crm-ai-merge-fields-layout__aifields_column"/>\n\t\t\t\t<div class="bx-crm-ai-merge-fields-layout__floating-button_column">\n\t\t\t\t\t<FloatingActionButton/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<Loader v-if="isLoading" />\n\t\t\t<CloseConfirm v-if="isSliderConfirmPopupShown" />\n\t\t\t<FeedbackMessage v-if="isFeedbackMessageShown" />\n\t\t</div>\n\t'};var g=babelHelpers.classPrivateFieldLooseKey("editor"),v=babelHelpers.classPrivateFieldLooseKey("initialContainerTop"),L=babelHelpers.classPrivateFieldLooseKey("onUserFieldDeployedCb"),B=babelHelpers.classPrivateFieldLooseKey("refreshControlLayout"),P=babelHelpers.classPrivateFieldLooseKey("setEntityEditorBBValue"),y=babelHelpers.classPrivateFieldLooseKey("setPlainTextFieldValue"),E=babelHelpers.classPrivateFieldLooseKey("setUserFieldValue"),_=babelHelpers.classPrivateFieldLooseKey("getValueFromControl");class I{constructor(){Object.defineProperty(this,_,{value:S}),Object.defineProperty(this,E,{value:w}),Object.defineProperty(this,y,{value:H}),Object.defineProperty(this,P,{value:M}),Object.defineProperty(this,B,{value:A}),Object.defineProperty(this,g,{writable:!0,value:null}),Object.defineProperty(this,v,{writable:!0,value:void 0}),Object.defineProperty(this,L,{writable:!0,value:null})}async init(e){babelHelpers.classPrivateFieldLooseBase(this,g)[g]=e;babelHelpers.classPrivateFieldLooseBase(this,v)[v]=babelHelpers.classPrivateFieldLooseBase(this,g)[g].getContainer().getBoundingClientRect().y+5,c.addCustomEvent(window,"BX.UI.EntityUserFieldLayoutLoader:onUserFieldDeployed",(e=>{c.Type.isFunction(babelHelpers.classPrivateFieldLooseBase(this,L)[L])&&babelHelpers.classPrivateFieldLooseBase(this,L)[L](e)}))}setOnUserFieldDeployedCb(e){babelHelpers.classPrivateFieldLooseBase(this,L)[L]=e}async getEditorControlsParams(e){await b(10);const t=[];let s=0;for(const i of babelHelpers.classPrivateFieldLooseBase(this,g)[g].getAllControls()){if(!e.has(i.getId())||!i.getWrapper())continue;const[o,l]=babelHelpers.classPrivateFieldLooseBase(this,_)[_](i);t.push({fieldId:i.getId(),relatedFieldOffsetY:i.getWrapper().getBoundingClientRect().y,originalValue:o,originalModel:l,order:s}),s++}return t}async getEditorControlsPositions(e){const t=new Map;for(const s of babelHelpers.classPrivateFieldLooseBase(this,g)[g].getAllControls()){if(!e.has(s.getId())||!s.getWrapper())continue;const i=s.getWrapper().getBoundingClientRect().y;t.set(s.getId(),i-babelHelpers.classPrivateFieldLooseBase(this,v)[v])}return t}setControlOutline(e,t){const s=babelHelpers.classPrivateFieldLooseBase(this,g)[g].getControlById(e);if(!s)return;const i=s.getWrapper();t?c.Dom.addClass(i,"bx-crm-ai-merge-fields-ee-control-outline"):c.Dom.removeClass(i,"bx-crm-ai-merge-fields-ee-control-outline")}setControlAiClass(e,t){const s=babelHelpers.classPrivateFieldLooseBase(this,g)[g].getControlById(e);if(!s)return;const i=s.getWrapper();t?c.Dom.addClass(i,"bx-crm-ai-merge-fields-ee-control-ai-value"):c.Dom.removeClass(i,"bx-crm-ai-merge-fields-ee-control-ai-value")}async setFieldValue(e,t){const s=babelHelpers.classPrivateFieldLooseBase(this,g)[g].getControlById(e);if(s)switch(s.constructor){case BX.Crm.EntityEditorText:babelHelpers.classPrivateFieldLooseBase(this,y)[y](e,t.value);break;case BX.UI.EntityEditorBB:babelHelpers.classPrivateFieldLooseBase(this,P)[P](e,t.value),babelHelpers.classPrivateFieldLooseBase(this,B)[B](s);break;case BX.Crm.EntityEditorUserField:babelHelpers.classPrivateFieldLooseBase(this,E)[E](e,t.model),babelHelpers.classPrivateFieldLooseBase(this,B)[B](s);break;default:throw new Error("Not supported field type")}}}function A(e){e.refreshLayout({reset:!0})}function M(e,t){const s=e+"_HTML";babelHelpers.classPrivateFieldLooseBase(this,g)[g].getModel().setField(s,t,{enableNotification:!0})}function H(e,t){babelHelpers.classPrivateFieldLooseBase(this,g)[g].getModel().setField(e,t,{enableNotification:!0})}function w(e,t){babelHelpers.classPrivateFieldLooseBase(this,g)[g].getModel().setField(e,t)}function S(e){const t=e.getValue();let s=null,i=null;if(e.constructor===BX.UI.EntityEditorBB){const t=babelHelpers.classPrivateFieldLooseBase(this,g)[g].getModel(),i=e.getId()+"_HTML";s=t.getField(i,"")}else c.Type.isObject(t)&&Object.hasOwn(t,"VALUE")?(s=t.VALUE,i=t):(c.Type.isString(t)||c.Type.isNumber(t))&&(s=t,i=null);return[s,i]}var T={isLoading:e=>e.isLoading,conflictFields:e=>e.conflictFields.sort(((e,t)=>e.order-t.order)),mergeUuid:e=>e.mergeUuid,activityId:e=>e.activityId,getEntityInfo:e=>e.entityInfo,isEntityEditorLoaded:e=>e.isEntityEditorLoaded,eeControlPosition:e=>t=>e.eeControlPositions.get(t,0),eeControlPositions:e=>e.eeControlPositions,getexpandedConflictControls:e=>e.expandedConflictControls,getNotVisibleUnresolvedCount:e=>e.notVisibleUnresolvedCount,getMainLayoutScrollPosition:e=>e.mainLayoutScrollPosition,getMainLayoutContainerHeight:e=>e.mainLayoutContainerHeight,getMainLayoutScrollHeight:e=>e.mainLayoutScrollHeight,getFirstUnseenFieldPosition:e=>{const t=e.mainLayoutScrollPosition;let s=null,i=1/0;for(const[o,l]of e.eeControlPositions){const a=e.conflictFields.find((e=>e.name===o));!a||a.isAiValuesUsed||t+120>l||l<i&&(i=l,s=o)}return s?e.eeControlPositions.get(s):null},isFieldsTouched:e=>e.isFieldsTouched,aiValuesAppliedCount:e=>e.aiValuesAppliedCount,isFooterHiddenAndSaveDisabled:e=>0===e.aiValuesAppliedCount,isSliderConfirmPopupShown:e=>e.isSliderConfirmPopupShown,isNeededShowCloseConfirm:e=>e.isNeededShowCloseConfirm,isFeedbackMessageShown:e=>e.aiFeedback.isMessageComponentShown,isAiFeedbackShowBeforeClose:e=>e.aiFeedback.showBeforeClose,aiFeedback:e=>e.aiFeedback},O={setMergeUUID:(e,t)=>{e.mergeUuid=t},setActivityId:(e,t)=>{e.activityId=t},startLoading:e=>{e.isLoading=!0},stopLoading:e=>{e.isLoading=!1},setEntityInfo:(e,t)=>{e.entityInfo=t},setConflictFields:(e,t)=>{e.conflictFields=t},setEditMode:(e,t)=>{e.isEditMode=t},setIsEntityEditorLoaded(e,t){e.isEntityEditorLoaded=t},updateConflictField:(e,{name:t,field:s})=>{e.conflictFields=e.conflictFields.map((e=>e.name===t?{...e,...s}:e));const i=e.conflictFields.filter((e=>e.isAiValuesUsed)).length;e.aiValuesAppliedCount=i,e.isNeededShowCloseConfirm=i>0},setEeControlPositions:(e,{fieldId:t,topPosition:s})=>{e.eeControlPositions.set(t,s)},toggleExpandedConflictControls:(e,{fieldId:t,size:s,isExpanded:i})=>{i?e.expandedConflictControls.set(t,s):e.expandedConflictControls.delete(t)},changeMainLayoutScrollPosition:(e,{scrollTop:t,containerHeight:s})=>{const i=t+s;e.mainLayoutScrollPosition=t,e.mainLayoutContainerHeight=s;const o=[];for(const[t,s]of e.eeControlPositions)i<s+30&&o.push(t);if(0===o.length)return void(e.notVisibleUnresolvedCount=0);let l=0;for(const t of o){const s=e.conflictFields.find((e=>e.name===t));s&&!s.isAiValuesUsed&&l++}e.notVisibleUnresolvedCount=l},setIsFieldsTouched(e,t){e.isFieldsTouched=t},setIsConfirmPopupShow(e,t){e.isSliderConfirmPopupShown=t},setNeededShowCloseConfirm(e,t){e.isNeededShowCloseConfirm=t},showFeedbackMessageIfNeeded(e,t){e.aiFeedback.feedbackWasSent||"FEEDBACK_TRIGGER_CONTROL"===t&&e.aiFeedback.isShownByReturnBtn||(e.aiFeedback.lastTriggeredBy=t,"FEEDBACK_TRIGGER_CONTROL"===t&&(e.aiFeedback.isShownByReturnBtn=!0),e.aiFeedback.isMessageComponentShown=!0)},hideFeedbackMessage(e){e.aiFeedback.isMessageComponentShown=!1},setAiFeedbackWasSent(e,t){e.aiFeedback.feedbackWasSent=t},setAiFeedbackShowBeforeClose(e,t){e.aiFeedback.showBeforeClose=t},setMainLayoutScrollHeight(e,t){e.mainLayoutScrollHeight=t}},x=babelHelpers.classPrivateFieldLooseKey("params"),R=babelHelpers.classPrivateFieldLooseKey("fetchEntityEditor");class k{constructor(e){Object.defineProperty(this,R,{value:U}),Object.defineProperty(this,x,{writable:!0,value:void 0}),babelHelpers.classPrivateFieldLooseBase(this,x)[x]=e}async render(){return babelHelpers.classPrivateFieldLooseBase(this,R)[R](babelHelpers.classPrivateFieldLooseBase(this,x)[x]),new Promise((e=>{c.addCustomEvent(window,"BX.Crm.EntityEditor:onUserFieldsDeployed",(async t=>{t.getId()===babelHelpers.classPrivateFieldLooseBase(this,x)[x].domContainerId&&e(t)}))}))}}function U(e){let t="";switch(e.entityTypeName){case"DEAL":t="/bitrix/components/bitrix/crm.deal.details/ajax.php";break;case"LEAD":t="/bitrix/components/bitrix/crm.lead.details/ajax.php";break;default:throw new Error("Unknown entity type: "+e.entityTypeName)}t=`${t}?sessid=${BX.bitrix_sessid()}`,BX.ajax.post(t,{ACTION:"PREPARE_EDITOR_HTML",ACTION_ENTITY_TYPE_NAME:e.entityTypeName,ACTION_ENTITY_ID:e.entityId,GUID:e.domContainerId,CONFIG_ID:e.configId,FORCE_DEFAULT_CONFIG:"N",FORCE_DEFAULT_OPTIONS:"Y",IS_EMBEDDED:"Y",ENABLE_CONFIG_SCOPE_TOGGLE:"N",ENABLE_CONFIGURATION_UPDATE:"N",ENABLE_REQUIRED_USER_FIELD_CHECK:"N",ENABLE_FIELDS_CONTEXT_MENU:"N",CONTEXT:{},READ_ONLY:"Y",MODULE_ID:"crm"},(()=>{}))}var N={async initialize({dispatch:e,getters:t}){await e("fetchFormFieldsToMerge"),await e("createEntityEditor"),await e("collectFieldDataFromEntityEditor"),await e("updateControlPositionInfo")},async fetchFormFieldsToMerge({commit:e,getters:t}){const s=await V(t.mergeUuid);e("setConflictFields",s.fields.map((e=>({name:e.name,type:e.type,title:e.title,aiModel:e.aiModel,isMultiple:e.isMultiple,isUserField:e.isUserField,aiValue:e.aiModel.VALUE,originalValue:null,originalModel:null,isAiValuesUsed:!1})))),e("setEditMode",s.editMode),e("setEntityInfo",s.target),e("setAiFeedbackWasSent",s.target.feedbackWasSent),e("setAiFeedbackShowBeforeClose",!s.target.feedbackWasSent)},async saveFormFieldsToMerge({getters:e,commit:t,dispatch:s}){const i=e.conflictFields.filter((e=>e.isAiValuesUsed)).map((e=>e.name)),o=e.mergeUuid,l=await BX.ajax.runAction("crm.timeline.ai.applyMerge",{method:"GET",getParameters:{mergeUuid:o,fieldNamesToApply:i}});t("setAiFeedbackShowBeforeClose",!1),"success"===l.status?s("closeFormWithoutConfirm"):d.UI.Notification.Center.notify({content:c.Loc.getMessage("CRM_AI_FORM_FILL_MERGER_SAVE_ERROR"),autoHideDelay:5e3})},showFeedbackMessageBeforeClose({getters:e,commit:t}){t("showFeedbackMessageIfNeeded","FEEDBACK_TRIGGER_APP_CLOSE"),t("setAiFeedbackShowBeforeClose",!1)},closeFeedbackMessage({getters:e,commit:t,dispatch:s},i=!1){i&&(s("sendFeedBack"),t("setAiFeedbackShowBeforeClose",!1)),t("hideFeedbackMessage"),"FEEDBACK_TRIGGER_APP_CLOSE"===e.aiFeedback.lastTriggeredBy&&s("closeFormWithoutConfirm")},closeFormWithoutConfirm({getters:e,commit:t}){t("setNeededShowCloseConfirm",!1),t("setIsConfirmPopupShow",!1);const s=e.mergeUuid;c.onCustomEvent(window,"BX.Crm.AiFormFill:CloseSlider",{mergeUuid:s})},async setEditorFieldValue({dispatch:e,getters:t,commit:s},i){const o=i.name,l=!i.isAiValuesUsed,a=l?i.aiValue:i.originalValue,n=l?i.aiModel:i.originalModel;l||setTimeout((()=>{s("showFeedbackMessageIfNeeded","FEEDBACK_TRIGGER_CONTROL")}),300);const r={value:a,model:n};await K.setFieldValue(o,r),await K.setControlAiClass(o,l),s("setIsFieldsTouched",!0),s("updateConflictField",{name:o,field:{isAiValuesUsed:!i.isAiValuesUsed}})},async createEntityEditor({getters:e,commit:t,dispatch:s}){const i=e.getEntityInfo,o=new k({entityId:i.entityId,configId:i.editorId,entityTypeName:i.entityTypeName,domContainerId:"crm-ai-merge-fields__container__"+e.mergeUuid}),l=await o.render();await K.init(l),K.setOnUserFieldDeployedCb((async()=>{const t=Math.floor(e.getMainLayoutScrollPosition+e.getMainLayoutContainerHeight);let i=0;(e.getMainLayoutScrollHeight||0)-t<40&&(i=400),await b(i),s("updateControlPositionInfo")}))},async collectFieldDataFromEntityEditor({getters:e,commit:t,dispatch:s}){const i=e.conflictFields,o=new Set(i.map((e=>e.name))),l=await K.getEditorControlsParams(o);if(0!==l.length){for(const e of l)t("updateConflictField",{name:e.fieldId,field:{originalValue:e.originalValue,originalModel:e.originalModel,order:e.order}}),t("setEeControlPositions",{fieldId:e.fieldId,topPosition:e.relatedFieldOffsetY});t("setIsEntityEditorLoaded",!0)}},async updateControlPositionInfo({getters:e,commit:t},{updateOnlyFrom:s}={}){const i=e.conflictFields;if(0===i.length)return;const o=new Set(i.map((e=>e.name))),l=await K.getEditorControlsPositions(o),a=e.getMainLayoutScrollPosition||0;for(const[e,t]of l)l.set(e,a+t);for(const e of i){const i=e.name;!s&&s>e.order||l.has(i)&&t("setEeControlPositions",{fieldId:i,topPosition:l.get(i)})}},async applyAllAiFields({dispatch:e,getters:t}){for(const s of t.conflictFields)s.isAiValuesUsed||e("setEditorFieldValue",s)},revertAllAiFields({dispatch:e,getters:t}){for(const s of t.conflictFields)s.isAiValuesUsed&&e("setEditorFieldValue",s)},showEntityEditorControlOutline(e,{fieldName:t,isShow:s}){K.setControlOutline(t,s)},updateSliderFooter({getters:t}){const s=t.isFooterHiddenAndSaveDisabled;e.sliderButtonsAdapter.saveButton.setDisabled(s),null==e.copilotSliderInstance||e.copilotSliderInstance.footerDisplay(!s)},async sendFeedBack({commit:e,getters:t}){const s=t.mergeUuid;if(t.aiFeedback.checkFeedbackBeforeSend){if(await D(s))return void e("setAiFeedbackWasSent",!0)}const i=t.getEntityInfo.entityTypeName;a.sendFeedback(s,i,t.activityId),e("setAiFeedbackWasSent",!0)},sendAiCallParsingData({getters:e},t){const s=e.getEntityInfo.entityTypeName,i=e.activityId;r.sendData(n.Builder.AI.CallParsingEvent.createDefault(s,i,n.Dictionary.STATUS_SUCCESS).setElement(t).buildData())}};const D=async e=>a.wasFeedbackSent(e),V=async e=>(await BX.ajax.runAction("crm.timeline.ai.mergeFields",{method:"GET",getParameters:{mergeUuid:e}})).data;let K=null;var G=babelHelpers.classPrivateFieldLooseKey("application"),X=babelHelpers.classPrivateFieldLooseKey("options"),j=babelHelpers.classPrivateFieldLooseKey("store");class W{constructor(e,t={}){if(Object.defineProperty(this,G,{writable:!0,value:void 0}),Object.defineProperty(this,X,{writable:!0,value:void 0}),Object.defineProperty(this,j,{writable:!0,value:void 0}),babelHelpers.classPrivateFieldLooseBase(this,X)[X]=t,this.rootNode=document.querySelector("#"+e),!babelHelpers.classPrivateFieldLooseBase(this,X)[X].mergeUuid)throw new Error("param mergeUuid is required")}get application(){return babelHelpers.classPrivateFieldLooseBase(this,G)[G]}get store(){return babelHelpers.classPrivateFieldLooseBase(this,j)[j]}start(){K=new I,babelHelpers.classPrivateFieldLooseBase(this,j)[j]=l.createStore({state:{mergeUuid:null,isLoading:!0,conflictFields:[],isEditMode:!1,isEntityEditorLoaded:!1,entityInfo:null,eeControlPositions:new Map,expandedConflictControls:new Map,mainLayoutScrollPosition:null,mainLayoutContainerHeight:null,mainLayoutScrollHeight:null,notVisibleUnresolvedCount:0,isFieldsTouched:!1,aiValuesAppliedCount:0,isSliderConfirmPopupShown:!1,isNeededShowCloseConfirm:!1,aiFeedback:{feedbackWasSent:!1,isShownByReturnBtn:!1,isMessageComponentShown:!1,lastTriggeredBy:null,showBeforeClose:!0,checkFeedbackBeforeSend:!1}},getters:T,mutations:O,actions:N}),babelHelpers.classPrivateFieldLooseBase(this,G)[G]=o.BitrixVue.createApp({name:"AiFormFill",components:{Main:C},beforeCreate(){this.$bitrix.Application.set(this)},template:"\n\t\t\t\t<Main/>\n\t\t\t"}),babelHelpers.classPrivateFieldLooseBase(this,j)[j].commit("setMergeUUID",babelHelpers.classPrivateFieldLooseBase(this,X)[X].mergeUuid),babelHelpers.classPrivateFieldLooseBase(this,j)[j].commit("setActivityId",babelHelpers.classPrivateFieldLooseBase(this,X)[X].activityId),babelHelpers.classPrivateFieldLooseBase(this,G)[G].use(babelHelpers.classPrivateFieldLooseBase(this,j)[j]),babelHelpers.classPrivateFieldLooseBase(this,G)[G].mount(this.rootNode)}stop(){babelHelpers.classPrivateFieldLooseBase(this,G)[G].unmount(),babelHelpers.classPrivateFieldLooseBase(this,G)[G]=null,babelHelpers.classPrivateFieldLooseBase(this,j)[j]=null,K=null}isNeededShowCloseConfirm(){return babelHelpers.classPrivateFieldLooseBase(this,j)[j].getters.isNeededShowCloseConfirm}showCloseConfirm(){babelHelpers.classPrivateFieldLooseBase(this,j)[j].commit("setIsConfirmPopupShow",!0)}isShowAiFeedbackBeforeClose(){return babelHelpers.classPrivateFieldLooseBase(this,j)[j].getters.isAiFeedbackShowBeforeClose}showAiFeedbackBeforeClose(){babelHelpers.classPrivateFieldLooseBase(this,j)[j].dispatch("showFeedbackMessageBeforeClose")}isAppLoading(){return babelHelpers.classPrivateFieldLooseBase(this,j)[j].getters.isLoading}}var $=babelHelpers.classPrivateFieldLooseKey("onSaveCallback"),z=babelHelpers.classPrivateFieldLooseKey("onCancelCallback"),q=babelHelpers.classPrivateFieldLooseKey("saveButton"),Y=babelHelpers.classPrivateFieldLooseKey("cancelButton"),Q=babelHelpers.classPrivateFieldLooseKey("createButtons");class J{constructor(){Object.defineProperty(this,Q,{value:Z}),Object.defineProperty(this,$,{writable:!0,value:null}),Object.defineProperty(this,z,{writable:!0,value:null}),Object.defineProperty(this,q,{writable:!0,value:null}),Object.defineProperty(this,Y,{writable:!0,value:null}),babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]()}set onSaveCallback(e){babelHelpers.classPrivateFieldLooseBase(this,$)[$]=e}set onCancelCallback(e){babelHelpers.classPrivateFieldLooseBase(this,z)[z]=e}get saveButton(){return babelHelpers.classPrivateFieldLooseBase(this,q)[q]}get cancelButton(){return babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]}getButtons(){return[babelHelpers.classPrivateFieldLooseBase(this,q)[q],babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]]}}function Z(){babelHelpers.classPrivateFieldLooseBase(this,q)[q]=new u.Button({text:c.Loc.getMessage("CRM_AI_FORM_FILL_MERGER_SAVE"),size:u.Button.Size.MEDIUM,color:u.Button.Color.SUCCESS,dependOnTheme:!0,onclick:()=>{c.Type.isFunction(babelHelpers.classPrivateFieldLooseBase(this,$)[$])&&babelHelpers.classPrivateFieldLooseBase(this,$)[$]()}}),babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]=new u.Button({text:c.Loc.getMessage("CRM_AI_FORM_FILL_MERGER_CANCEL"),size:u.Button.Size.MEDIUM,color:u.ButtonColor.LIGHT_BORDER,onclick:()=>{c.Type.isFunction(babelHelpers.classPrivateFieldLooseBase(this,z)[z])&&babelHelpers.classPrivateFieldLooseBase(this,z)[z]()}})}e.sliderButtonsAdapter=null,e.copilotSliderInstance=null;var ee=babelHelpers.classPrivateFieldLooseKey("options"),te=babelHelpers.classPrivateFieldLooseKey("copilotSliderClass"),se=babelHelpers.classPrivateFieldLooseKey("app"),ie=babelHelpers.classPrivateFieldLooseKey("sliderInstance"),oe=babelHelpers.classPrivateFieldLooseKey("onLoadEventName"),le=babelHelpers.classPrivateFieldLooseKey("onCloseEventName"),ae=babelHelpers.classPrivateFieldLooseKey("sliderUrl"),ne=babelHelpers.classPrivateFieldLooseKey("containerId"),re=babelHelpers.classPrivateFieldLooseKey("makeSliderToolbar"),de=babelHelpers.classPrivateFieldLooseKey("createSliderWrapper"),ce=babelHelpers.classPrivateFieldLooseKey("calculateSliderWidth"),ue=babelHelpers.classPrivateFieldLooseKey("onSliderLoadFn"),be=babelHelpers.classPrivateFieldLooseKey("onSliderCloseFn"),pe=babelHelpers.classPrivateFieldLooseKey("onAiFormFillDownFn");class he{constructor(t,s){Object.defineProperty(this,pe,{value:ye}),Object.defineProperty(this,be,{value:Pe}),Object.defineProperty(this,ue,{value:Be}),Object.defineProperty(this,ce,{value:Le}),Object.defineProperty(this,de,{value:ve}),Object.defineProperty(this,re,{value:ge}),Object.defineProperty(this,ne,{get:Ce,set:void 0}),Object.defineProperty(this,ae,{get:Fe,set:void 0}),Object.defineProperty(this,le,{get:fe,set:void 0}),Object.defineProperty(this,oe,{get:me,set:void 0}),Object.defineProperty(this,ee,{writable:!0,value:void 0}),Object.defineProperty(this,te,{writable:!0,value:void 0}),Object.defineProperty(this,se,{writable:!0,value:void 0}),Object.defineProperty(this,ie,{writable:!0,value:void 0}),babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]=t,babelHelpers.classPrivateFieldLooseBase(this,te)[te]=s,e.sliderButtonsAdapter=new J}create(){babelHelpers.classPrivateFieldLooseBase(this,ie)[ie]=babelHelpers.classPrivateFieldLooseBase(this,de)[de](),c.addCustomEvent("SidePanel.Slider:onLoad",babelHelpers.classPrivateFieldLooseBase(this,ue)[ue].bind(this),babelHelpers.classPrivateFieldLooseBase(this,oe)[oe]),c.addCustomEvent("SidePanel.Slider:onClose",babelHelpers.classPrivateFieldLooseBase(this,be)[be].bind(this),babelHelpers.classPrivateFieldLooseBase(this,le)[le]),c.addCustomEvent(window,"BX.Crm.AiFormFill:CloseSlider",babelHelpers.classPrivateFieldLooseBase(this,pe)[pe].bind(this)),babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].open()}}function me(){return"CopilotSliderWrapper:onLoad_"+babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].mergeUuid}function fe(){return"CopilotSliderWrapper:onClose_"+babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].mergeUuid}function Fe(){return"crm:copilot-wrapper-slider-"+babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].mergeUuid}function Ce(){return"crm-ai-merge-fields__container__"+babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].mergeUuid}function ge(){const e=babelHelpers.classPrivateFieldLooseBase(this,te)[te].makeDefaultToolbarButtons();return[new u.Button({text:c.Loc.getMessage("CRM_AI_FORM_FILL_MERGER_TRANSCRIPTION"),size:u.Button.Size.MEDIUM,color:u.Button.Color.LIGHT_BORDER,dependOnTheme:!0,onclick:()=>{if(top.BX.Helper){new t.Call.Transcription({activityId:babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].activityId,ownerTypeId:babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].ownerTypeId,ownerId:babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].ownerId}).open()}}}),new u.Button({text:c.Loc.getMessage("CRM_AI_FORM_FILL_MERGER_RESUME"),size:u.Button.Size.MEDIUM,color:u.Button.Color.LIGHT_BORDER,dependOnTheme:!0,onclick:()=>{if(top.BX.Helper){new t.Call.Summary({activityId:babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].activityId,ownerTypeId:babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].ownerTypeId,ownerId:babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].ownerId}).open()}}}),...e]}function ve(){const t=e.sliderButtonsAdapter.getButtons(),s=babelHelpers.classPrivateFieldLooseBase(this,re)[re]();return new(babelHelpers.classPrivateFieldLooseBase(this,te)[te])({content:()=>`<div id="${babelHelpers.classPrivateFieldLooseBase(this,ne)[ne]}"></div>`,sliderTitle:c.Loc.getMessage("CRM_AI_FORM_FILL_MERGER_TITLE"),label:babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].label,extensions:["crm.ai-form-fill","crm.entity-editor"],url:babelHelpers.classPrivateFieldLooseBase(this,ae)[ae],width:babelHelpers.classPrivateFieldLooseBase(this,ce)[ce](),toolbar:()=>s,buttons:()=>t})}function Le(){const e=BX.SidePanel.Instance.getTopSlider().getWidth()||.86*window.screen.width;return Math.floor(.86*e)}function Be(t){t.getSlider().getUrl()===babelHelpers.classPrivateFieldLooseBase(this,ae)[ae]&&(e.copilotSliderInstance=babelHelpers.classPrivateFieldLooseBase(this,ie)[ie],babelHelpers.classPrivateFieldLooseBase(this,se)[se]=new W(babelHelpers.classPrivateFieldLooseBase(this,ne)[ne],{mergeUuid:babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].mergeUuid,activityId:babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].activityId}),babelHelpers.classPrivateFieldLooseBase(this,se)[se].start(),c.removeAllCustomEvents("SidePanel.Slider:onLoad",babelHelpers.classPrivateFieldLooseBase(this,oe)[oe]))}function Pe(t){if(t.getSlider().getUrl()===babelHelpers.classPrivateFieldLooseBase(this,ae)[ae])if(babelHelpers.classPrivateFieldLooseBase(this,se)[se]&&!babelHelpers.classPrivateFieldLooseBase(this,se)[se].isAppLoading()){if(babelHelpers.classPrivateFieldLooseBase(this,se)[se].isNeededShowCloseConfirm())return babelHelpers.classPrivateFieldLooseBase(this,se)[se].showCloseConfirm(),void t.denyAction();if(babelHelpers.classPrivateFieldLooseBase(this,se)[se].isShowAiFeedbackBeforeClose())return babelHelpers.classPrivateFieldLooseBase(this,se)[se].showAiFeedbackBeforeClose(),void t.denyAction();c.removeAllCustomEvents("SidePanel.Slider:onClose",babelHelpers.classPrivateFieldLooseBase(this,le)[le]),c.removeAllCustomEvents(window,"BX.Crm.AiFormFill:CloseSlider"),babelHelpers.classPrivateFieldLooseBase(this,se)[se]&&(babelHelpers.classPrivateFieldLooseBase(this,se)[se].stop(),babelHelpers.classPrivateFieldLooseBase(this,se)[se]=null),e.sliderButtonsAdapter=null,e.copilotSliderInstance=null}else t.denyAction()}function ye(e){var t;(null==e||null==(t=e.data)?void 0:t.mergeUuid)===babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].mergeUuid&&babelHelpers.classPrivateFieldLooseBase(this,ie)[ie].close()}e.createAiFormFillApplicationInsideSlider=function(e){var t,s,i;const o=t=>{new he(e,t).create()};c.Type.isFunction(null==(t=BX)||null==(s=t.Crm)||null==(i=s.AI)?void 0:i.Slider)?o(BX.Crm.AI.Slider):top.BX.Runtime.loadExtension("crm.ai.slider").then((e=>{const{Slider:t}=e;o(t)})).catch((()=>{throw new Error("Cant load Crm.AI.Slider extension")}))}}(this.BX.Crm=this.BX.Crm||{},BX.Crm.AI,BX.Crm.AI,BX.UI.Dialogs,BX.Vue3,BX.Vue3.Vuex,BX.Crm.AI.Feedback,BX.Crm.Integration.Analytics,BX.UI.Analytics,BX,BX,BX.UI);
//# sourceMappingURL=ai-form-fill.bundle.map.js