(function(){"use strict";if(typeof webPacker==="undefined"){return}window.b24Tracker=window.b24Tracker||{};if(window.b24Tracker.guest){return}window.b24Tracker.guest={cookieName:"b24_crm_guest_id",returnCookieName:"b24_crm_guest_id_returned",requestUrl:"",isInit:false,init:function(){if(this.isInit){return}this.isInit=true;this.requestUrl=(webPacker.getAddress()+"/").match(/((http|https):\/\/[^\/]+?)\//)[1]+"/pub/guest.php";if(module.properties["lifespan"]){var t=parseInt(module.properties["lifespan"]);if(!isNaN(t)&&t){r.lifespan=t;i.lifespan=t}}e.collect();r.collect();i.collect();n.collect();this.checkReturn();window.b24order=window.b24order||[];window.b24order.forEach(function(e){this.registerOrder(e)},this);window.b24order.push=function(e){this.registerOrder(e)}.bind(this)},checkReturn:function(){if(!this.getGidCookie()||webPacker.cookie.get(this.returnCookieName)){return}s.query(this.requestUrl,{a:"event",e:"Return"},this.onAjaxResponse.bind(this));webPacker.cookie.set(this.returnCookieName,"y",3600*6)},storeTrace:function(e,t){t=t||"storeTrace";s.query(this.requestUrl,{a:t,d:{trace:e}})},link:function(e){if(!e||this.getGidCookie()){return}s.query(this.requestUrl,{a:"link",gid:e},this.onAjaxResponse.bind(this))},register:function(){if(this.getGidCookie()){return}s.query(this.requestUrl,{a:"register"},this.onAjaxResponse.bind(this))},onAjaxResponse:function(e){e=e||{};e.data=e.data||{};if(this.getGidCookie()==null&&!!e.data.gid){webPacker.cookie.set(this.cookieName,e.data.gid);webPacker.cookie.set(this.returnCookieName,"y",3600*6)}},getPages:function(){return n.list()},getTags:function(){return r.list()},registerOrder:function(e){if(!module.properties["canRegisterOrder"]){return}this.storeTrace(this.getTraceOrder(e),"registerOrder")},getTraceOrder:function(e){e=e||{};var t=e.id||"";if(!Number.isNaN(t)&&typeof t==="number"){t=t.toString()}if(!t||!webPacker.type.isString(t)||!t.match(/^[\d\w.\-\/\\_#]{1,30}$/i)){if(window.console&&window.console.error){window.console.error("Wrong order id: "+e.id)}}var r=parseFloat(e.sum);if(isNaN(r)||r<0){if(window.console&&window.console.error){window.console.error("Wrong order sum: "+e.sum)}}this.sentOrders=this.sentOrders||[];if(this.sentOrders.indexOf(t)>=0){return}this.sentOrders.push(t);return this.getTrace({channels:[{code:"order",value:t}],order:{id:t,sum:r}})},getTrace:function(t){var r=this.remindTrace(t);e.clear();return r},remindTrace:function(t){return JSON.stringify(e.current(t))},getUtmSource:function(){return this.getTags().utm_source||""},getGidCookie:function(){return webPacker.cookie.get(this.cookieName)}};var e={maxCount:5,lsKey:"b24_crm_guest_traces",previous:function(){return webPacker.ls.getItem(this.lsKey)||{list:[]}},current:function(e){e=e||{};var s={url:window.location.href,ref:i.getData().ref,device:{isMobile:webPacker.browser.isMobile()},tags:r.getData(),client:t.getData(),pages:{list:n.list()},gid:b24Tracker.guest.getGidCookie()};if(e.previous!==false){s.previous=this.previous()}if(e.channels){s.channels=e.channels}if(e.order){s.order=e.order}return s},clear:function(){webPacker.ls.removeItem(this.lsKey)},collect:function(){if(!r.isSourceDetected()&&!i.detect().newest){return}var e=this.current({previous:false});if(!e.pages.list){return}var t=this.previous();t=t||{};t.list=t.list||[];t.list.push(this.current({previous:false}));if(t.list.length>this.maxCount){t.list.shift()}r.clear();n.clear();webPacker.ls.setItem(this.lsKey,t)}};var t={getData:function(){var e={gaId:this.getGaId(),yaId:this.getYaId()};if(!e.gaId)delete e["gaId"];if(!e.yaId)delete e["yaId"];return e},getGaId:function(){var e;if(typeof window.ga==="function"){ga(function(t){e=t.get("clientId")});if(e){return e}if(ga.getAll&&ga.getAll()[0]){e=ga.getAll()[0].get("clientId")}}if(e){return e}e=(document.cookie||"").match(/_ga=(.+?);/);if(e){e=(e[1]||"").split(".").slice(-2).join(".")}return e?e:null},getYaId:function(){var e;if(window.Ya){var t;if(Ya.Metrika&&Ya.Metrika.counters()[0]){t=Ya.Metrika.counters()[0].id}else if(Ya.Metrika2&&Ya.Metrika2.counters()[0]){t=Ya.Metrika2.counters()[0].id}if(!t){return null}if(window.ym&&typeof window.ym==="object"){ym(t,"getClientID",function(t){e=t})}if(!e&&window["yaCounter"+t]){e=window["yaCounter"+t].getClientID()}}if(!e){e=webPacker.cookie.get("_ym_uid")}return e?e:null}};var r={lifespan:28,lsPageKey:"b24_crm_guest_utm",tags:["utm_source","utm_medium","utm_campaign","utm_content","utm_term"],sameTagLifeSpan:3600,list:function(){return this.getData().list||{}},isSourceDetected:function(){var e=this.tags[0];var t=webPacker.url.parameter.get(e);if(t===null||!t){return false}if(this.list()[e]!==t){return true}return this.getTimestamp(true)-this.getTimestamp()>this.sameTagLifeSpan},getGCLid:function(){return this.getData().gclid||null},getTimestamp:function(e){return(e?null:parseInt(this.getData().ts))||parseInt(Date.now()/1e3)},getData:function(){return(webPacker.ls.isSupported()?webPacker.ls.getItem(this.lsPageKey):webPacker.cookie.getItem(this.lsPageKey))||{}},clear:function(){webPacker.ls.removeItem(this.lsPageKey)},collect:function(){var e=this.getTimestamp();var t=webPacker.url.parameter.getList().filter(function(e){return this.tags.indexOf(e.name)>-1},this);if(t.length>0){t=t.filter(function(e){return e.value.trim().length>0}).reduce(function(e,t){e[t.name]=decodeURIComponent(t.value);return e},{});e=this.getTimestamp(true)}else{t=this.list()}var r=webPacker.url.parameter.getList().filter(function(e){return e.name==="gclid"},this).map(function(e){return e.value});r=r[0]||this.getGCLid();if(this.getTimestamp(true)-e>this.lifespan*3600*24){this.clear();return}var i={ts:e,list:t,gclid:r};webPacker.ls.isSupported()?webPacker.ls.setItem(this.lsPageKey,i):webPacker.cookie.setItem(this.lsPageKey,i)}};var i={lifespan:28,lsKey:"b24_crm_guest_ref",sameRefLifeSpan:3600,detect:function(){var e={detected:false,existed:false,expired:false,newest:false,value:null};var t=document.referrer;if(!t){return e}var r=document.createElement("a");r.href=t;if(!r.hostname){return e}if(r.hostname===window.location.hostname){return e}e.value=t;e.detected=true;if(t!==this.getData().ref){e.newest=true;return e}e.existed=true;if(this.getTs(true)-this.getTs()>this.sameRefLifeSpan){e.expired=true;return e}return false},getTs:function(e){return(e?null:parseInt(this.getData().ts))||parseInt(Date.now()/1e3)},getData:function(){return(webPacker.ls.isSupported()?webPacker.ls.getItem(this.lsKey,this.getTtl()):null)||{}},clear:function(){webPacker.ls.removeItem(this.lsKey)},getTtl:function(){return this.lifespan*3600*24},collect:function(){var e=this.detect();if(!e.detected){return}if(e.expired){this.clear();return}webPacker.ls.setItem(this.lsKey,{ts:this.getTs(),ref:e.value},this.getTtl())}};var n={maxCount:5,lsPageKey:"b24_crm_guest_pages",list:function(){return webPacker.ls.getItem(this.lsPageKey)},clear:function(){webPacker.ls.removeItem(this.lsPageKey)},collect:function(){if(!document.body){return}var e=document.body.querySelector("h1");e=e?e.textContent.trim():"";if(e.length===0){e=document.head.querySelector("title");e=e?e.textContent.trim():""}e=e.substring(0,40);var t=window.location.href;var r=webPacker.ls.getItem(this.lsPageKey);r=r instanceof Array?r:[];var i=-1;r.forEach(function(e,r){if(e[0]===t)i=r});if(i>-1){r=r.slice(0,i).concat(r.slice(i+1))}while(r.length>=this.maxCount){r.shift()}var n=new Date;r.push([t,Math.round(n.getTime()/1e3),e]);webPacker.ls.setItem(this.lsPageKey,r)}};var s={query:function(e,t,r){this.ajax=null;if(window.XMLHttpRequest){this.ajax=new XMLHttpRequest}else if(window.ActiveXObject){this.ajax=new window.ActiveXObject("Microsoft.XMLHTTP")}"withCredentials"in this.ajax?this.post(e,t,r):this.get(e,t)},get:function(e,t){var r=document.createElement("script");r.type="text/javascript";r.src=e+"?"+this.stringify(t);r.async=true;var i=document.getElementsByTagName("script")[0];i.parentNode.insertBefore(r,i)},post:function(e,t,r){var i=this.ajax;i.open("POST",e,true);i.setRequestHeader("Content-Type","application/x-www-form-urlencoded");i.withCredentials=true;i.onreadystatechange=function(){if(r&&i.readyState===4&&i.status===200){r.apply(this,[JSON.parse(this.responseText)])}};i.send(this.stringify(t))},stringify:function(e){var t=[];if(Object.prototype.toString.call(e)==="[object Array]"){}else if(typeof e==="object"){for(var r in e){if(!e.hasOwnProperty(r)){continue}var i=e[r];if(typeof i==="object"){i=JSON.stringify(i)}t.push(r+"="+encodeURIComponent(i))}}return t.join("&")},getAjax:function(){if(this.ajax){return this.ajax}if(window.XMLHttpRequest){this.ajax=new XMLHttpRequest}else if(window.ActiveXObject){this.ajax=new window.ActiveXObject("Microsoft.XMLHTTP")}return this.ajax}};window.b24Tracker.guest.init()})();
//# sourceMappingURL=script.map.js