this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,s,r,i,a){"use strict";let n=null;var o=babelHelpers.classPrivateFieldLooseKey("gridIdToProcessCountMap");class l{constructor(){Object.defineProperty(this,o,{writable:true,value:new Map})}static get Instance(){if(window.top!==window&&a.Reflection.getClass("top.BX.Crm.Autorun.ProcessRegistry")){return window.top.BX.Crm.Autorun.ProcessRegistry.Instance}if(n===null){n=new l}return n}isProcessRunning(e){return this.getProcessCount(e)>0}getProcessCount(e){var t;return(t=babelHelpers.classPrivateFieldLooseBase(this,o)[o].get(e))!=null?t:0}registerProcessRun(e){var t;const s=(t=babelHelpers.classPrivateFieldLooseBase(this,o)[o].get(e))!=null?t:0;babelHelpers.classPrivateFieldLooseBase(this,o)[o].set(e,s+1)}registerProcessStop(e){var t;const s=(t=babelHelpers.classPrivateFieldLooseBase(this,o)[o].get(e))!=null?t:0;let r=s-1;if(r<0){r=0}babelHelpers.classPrivateFieldLooseBase(this,o)[o].set(e,r)}static isProcessRunning(e){return this.Instance.isProcessRunning(e)}}const c=Object.freeze({intermediate:0,running:1,completed:2,stopped:3,error:4});class h{static isExists(e){return e in h.items}static create(e,t){const s=new h(e,t);h.items[s.getId()]=s;return s}constructor(e,t){this._id="";this._settings={};this._manager=null;this._container=null;this._wrapper=null;this._stateNode=null;this._progressNode=null;this._hasLayout=false;this._isHidden=false;this._id=e;this._settings=t||{};this._container=BX(this.getSetting("container"));if(!BX.type.isElementNode(this._container)){throw"AutorunProcessPanel: Could not find container."}this._manager=this.getSetting("manager");this._isHidden=this.getSetting("isHidden",false)}getId(){return this._id}getSetting(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t}scrollInToView(){if(!this._container){return}const e=BX.pos(this._container);if(window.scrollY>e.top){window.scrollTo(window.scrollX,e.top)}}layout(){if(this._hasLayout){return}this._wrapper=BX.create("DIV",{attrs:{className:"crm-view-progress"}});BX.addClass(this._wrapper,this._isHidden?"crm-view-progress-hide":"crm-view-progress-show crm-view-progress-bar-active");this._container.appendChild(this._wrapper);this._wrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-view-progress-info"},text:this.getSetting("title","Please wait...")}));this._progressNode=BX.create("DIV",{attrs:{className:"crm-view-progress-bar-line"}});this._stateNode=BX.create("DIV",{attrs:{className:"crm-view-progress-steps"}});this._wrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-view-progress-inner"},children:[BX.create("DIV",{attrs:{className:"crm-view-progress-bar"},children:[this._progressNode]}),this._stateNode]}));if(BX.prop.getBoolean(this._settings,"enableCancellation",false)){this._wrapper.appendChild(BX.create("a",{attrs:{className:"crm-view-progress-link",href:"#"},text:a.Loc.getMessage("JS_CORE_WINDOW_CANCEL"),events:{click:this.onCancelButtonClick.bind(this)}}))}this._hasLayout=true}hasLayout(){return this._hasLayout}isHidden(){return this._isHidden}show(){if(!this._isHidden){return}if(!this._hasLayout){return}BX.removeClass(this._wrapper,"crm-view-progress-hide");BX.addClass(this._wrapper,"crm-view-progress-show");this._isHidden=false}hide(){if(this._isHidden){return}if(!this._hasLayout){return}BX.removeClass(this._wrapper,"crm-view-progress-show");BX.addClass(this._wrapper,"crm-view-progress-hide");this._isHidden=true}clearLayout(){if(!this._hasLayout){return}BX.remove(this._wrapper);this._wrapper=this._stateNode=null;this._hasLayout=false}getManager(){return this._manager}setManager(e){this._manager=e}onManagerStateChange(){if(!(this._hasLayout&&this._manager)){return}const e=this._manager.getState();if(e!==c.error){const e=this._manager.getProcessedItemCount();const t=this._manager.getTotalItemCount();let s=0;if(t!==0){s=Math.floor(e/t*100);const r=s%5;if(r!==0){s-=r}}if(e>0&&t>0){const s=this.getSetting("stateTemplate",a.Loc.getMessage("CRM_AUTORUN_PROCESS_PANEL_DEFAULT_STATE_TEMPLATE"));this._stateNode.innerHTML=s.replace("#processed#",e).replace("#total#",t)}else{this._stateNode.innerHTML=""}this._progressNode.className="crm-view-progress-bar-line";if(s>0){this._progressNode.className+=` crm-view-progress-line-${s.toString()}`}}}onCancelButtonClick(e){this._manager.stop();return BX.eventReturnFalse(e)}}h.items={};var g=babelHelpers.classPrivateFieldLooseKey("setErrorsFromResponseData");class _{static create(e,t){const s=new _(e,t);_.items[s.getId()]=s;return s}static createIfNotExists(e,t){if(e in _.items){return _.items[e]}return _.create(e,t)}constructor(e,t){Object.defineProperty(this,g,{value:u});this._id="";this._settings={};this._serviceUrl="";this._actionName="";this._controllerActionName="";this._params=null;this._container=null;this._panel=null;this._runHandle=0;this._hasLayout=false;this._state=c.intermediate;this._processedItemCount=0;this._totalItemCount=0;this._errors=[];this._id=a.Type.isStringFilled(e)?e:`crm_lrp_mgr_${Math.random().toString().slice(2)}`;this._settings=t||{};this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this._actionName=BX.prop.getString(this._settings,"actionName","");this._controllerActionName=BX.prop.getString(this._settings,"controllerActionName","");if(this._serviceUrl===""&&this._controllerActionName===""){throw"AutorunProcessManager: Either the serviceUrl or controllerActionName parameter must be specified."}this._container=BX(this.getSetting("container"));if(!a.Type.isElementNode(this._container)){throw"AutorunProcessManager: Could not find container."}this._params=BX.prop.getObject(this._settings,"params",null);if(BX.prop.getBoolean(this._settings,"enableLayout",false)){this.layout()}}getId(){return this._id}getSetting(e,t){if(e in this._settings){return this._settings[e]}return t}getTimeout(){return BX.prop.getInteger(this._settings,"timeout",2e3)}getMessage(e,t){if(e in _.messages){return _.messages[e]}return a.Type.isUndefined(t)?e:t}getParams(){return this._params}setParams(e){this._params=e}isHidden(){return!this._hasLayout||this._panel.isHidden()}show(){if(this._hasLayout){this._panel.show()}}hide(){if(this._hasLayout){this._panel.hide()}}scrollInToView(){if(this._panel){this._panel.scrollInToView()}}layout(){if(this._hasLayout){return}if(!this._panel){let e=BX.prop.getString(this._settings,"title","");if(e===""){e=this.getMessage("title","")}let t=BX.prop.getString(this._settings,"stateTemplate","");if(t===""){t=this.getMessage("stateTemplate","")}const s={manager:this,container:this._container,enableCancellation:BX.prop.getBoolean(this._settings,"enableCancellation",false)};if(a.Type.isStringFilled(e)){s.title=e}if(a.Type.isStringFilled(t)){s.stateTemplate=t}this._panel=h.create(this._id,s)}this._panel.layout();this._hasLayout=true}clearLayout(){if(!this._hasLayout){return}this._panel.clearLayout();this._hasLayout=false}getPanel(){return this._panel}setPanel(e){this._panel=e;if(this._panel){this._panel.setManager(this);this._hasLayout=this._panel.hasLayout()}else{this._hasLayout=false}}refresh(){if(!this._hasLayout){this.layout()}if(this._panel.isHidden()){this._panel.show()}this._panel.onManagerStateChange()}getState(){return this._state}getProcessedItemCount(){return this._processedItemCount}getTotalItemCount(){return this._totalItemCount}getErrorCount(){return this._errors.length}getErrors(){return this._errors}run(){if(this._state===c.stopped){this._state=c.intermediate}this.startRequest()}runAfter(e){this._runHandle=window.setTimeout(this.run.bind(this),e)}stop(){this._state=c.stopped;BX.onCustomEvent(this,"ON_AUTORUN_PROCESS_STATE_CHANGE",[this])}reset(){if(this._runHandle>0){window.clearTimeout(this._runHandle);this._runHandle=0}if(this._panel&&this._panel.isHidden()){this._panel.show()}this._processedItemCount=0;this._totalItemCount=0}startRequest(){if(this._state===c.stopped){return}if(this._requestIsRunning){return}this._requestIsRunning=true;this._state=c.running;const e={};if(this._serviceUrl===""){if(this._params){e.params=this._params}a.ajax.runAction(this._controllerActionName,{data:e}).then((e=>{this.onRequestSuccess(BX.prop.getObject(e,"data",{}))})).catch((e=>{this.onRequestFailure(BX.prop.getObject(e,"data",{}))}))}else{if(this._actionName!==""){e.ACTION=this._actionName}if(this._params){e.PARAMS=this._params}e.sessid=BX.bitrix_sessid();a.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:e,onsuccess:this.onRequestSuccess.bind(this),onfailure:this.onRequestFailure.bind(this)})}}onRequestSuccess(e){this._requestIsRunning=false;if(this._state===c.stopped){return}if(this._serviceUrl===""){const t=BX.prop.getString(e,"status","");if(t==="ERROR"){this._state=c.error}else if(t==="COMPLETED"){this._state=c.completed}if(this._state===c.error){babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)}else{this._processedItemCount=BX.prop.getInteger(e,"processedItems",0);this._totalItemCount=BX.prop.getInteger(e,"totalItems",0);this._errors=BX.prop.getArray(e,"errors",[])}}else{const t=BX.prop.getString(e,"STATUS","");if(t==="ERROR"){this._state=c.error}else if(t==="COMPLETED"){this._state=c.completed}if(this._state===c.error){babelHelpers.classPrivateFieldLooseBase(this,g)[g](e)}else{this._processedItemCount=BX.prop.getInteger(e,"PROCESSED_ITEMS",0);this._totalItemCount=BX.prop.getInteger(e,"TOTAL_ITEMS",0);this._errors=BX.prop.getArray(e,"ERRORS",[])}}this.refresh();if(this._state===c.running){window.setTimeout(this.startRequest.bind(this),this.getTimeout())}else if(this._state===c.completed&&BX.prop.getBoolean(this._settings,"hideAfterComplete",true)){this.hide()}BX.onCustomEvent(this,"ON_AUTORUN_PROCESS_STATE_CHANGE",[this])}onRequestFailure(e){this._requestIsRunning=false;this._state=c.error;babelHelpers.classPrivateFieldLooseBase(this,g)[g](e);this.refresh();BX.onCustomEvent(this,"ON_AUTORUN_PROCESS_STATE_CHANGE",[this])}}function u(e){const t=this._serviceUrl===""?"errors":"ERRORS";this._errors=BX.prop.getArray(e,t,[]);if(this._errors.length===0){this._errors.push({message:this.getMessage("requestError")})}}_.messages={requestError:a.Loc.getMessage("CRM_AUTORUN_PROCESS_REQUEST_ERROR")};_.items={};class p{static create(e,t){return new p(e,t)}constructor(e,t){this._id="";this._settings={};this._data=null;this._container=null;this._wrapper=null;this._id=e;this._settings=t||{};this._container=BX(BX.prop.get(this._settings,"container"));if(!BX.type.isElementNode(this._container)){throw"BatchConversionPanel: Could not find container."}this._data=BX.prop.getObject(this._settings,"data",{})}getId(){return this._id}getMessage(e){const t=BX.prop.getObject(this._settings,"messages",p.messages);return BX.prop.getString(t,e,e)}layout(){if(this._hasLayout){return}this._wrapper=BX.create("DIV",{attrs:{className:"crm-view-progress"}});BX.addClass(this._wrapper,this._isHidden?"crm-view-progress-hide":"crm-view-progress-show");BX.addClass(this._wrapper,"crm-view-progress-row-hidden");this._container.appendChild(this._wrapper);const e=[BX.create("span",{text:this.getMessage("summaryCaption")})];const t=new RegExp(BX.prop.getString(this._settings,"numberSubstitution","#number#"),"ig");const s=BX.prop.getInteger(this._data,"succeededCount",0);if(s>0){e.push(BX.create("span",{attrs:{className:"crm-view-progress-text"},text:this.getMessage("summarySucceeded").replace(t,s)}))}const r=BX.prop.getInteger(this._data,"failedCount",0);if(r>0){e.push(BX.create("span",{attrs:{className:"crm-view-progress-link crm-view-progress-text-button"},text:this.getMessage("summaryFailed").replace(t,r),events:{click:this.onToggleErrorButtonClick.bind(this)}}))}const i=[];i.push(BX.create("DIV",{attrs:{className:"crm-view-progress-info"},children:e}));i.push(BX.create("a",{attrs:{className:"crm-view-progress-link",href:"#"},text:a.Loc.getMessage("JS_CORE_WINDOW_CLOSE"),events:{click:this.onCloseButtonClick.bind(this)}}));this._wrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-view-progress-row"},children:i}));const n=BX.prop.getArray(this._data,"errors",[]);if(n.length>0){for(let e=0,t=n.length;e<t;e++){const t=n[e];const s=[];const r=BX.prop.getObject(BX.prop.getObject(t,"customData",{}),"info",null);if(r){const e=BX.prop.getString(r,"title","");const t=BX.prop.getString(r,"showUrl","");if(e!==""&&t!==""){s.push(BX.create("a",{props:{className:"crm-view-progress-link",href:t,target:"_blank"},text:`${e}:`}))}}s.push(BX.create("span",{attrs:{className:"crm-view-progress-text"},text:t.message}));this._wrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-view-progress-row"},children:[BX.create("DIV",{attrs:{className:"crm-view-progress-info"},children:s})]}))}}else{const e=this.getDisplayTimeout();if(e>0){window.setTimeout((()=>{this.clearLayout()}),e)}}this._hasLayout=true;BX.onCustomEvent(window,"BX.Crm.ProcessSummaryPanel:onLayout",[this])}hasLayout(){return this._hasLayout}isHidden(){return this._isHidden}show(){if(!this._isHidden){return}if(!this._hasLayout){return}BX.removeClass(this._wrapper,"crm-view-progress-hide");BX.addClass(this._wrapper,"crm-view-progress-show");this._isHidden=false}hide(){if(this._isHidden){return}if(!this._hasLayout){return}BX.removeClass(this._wrapper,"crm-view-progress-show");BX.addClass(this._wrapper,"crm-view-progress-hide");this._isHidden=true}clearLayout(){if(!this._hasLayout){return}BX.remove(this._wrapper);this._wrapper=null;this._hasLayout=false;BX.onCustomEvent(window,"BX.Crm.ProcessSummaryPanel:onClearLayout",[this])}getDisplayTimeout(){return BX.prop.getInteger(this._settings,"displayTimeout",0)}onCloseButtonClick(e){this.clearLayout();return BX.eventReturnFalse(e)}onToggleErrorButtonClick(){BX.toggleClass(this._wrapper,"crm-view-progress-row-hidden")}}p.messages={};var d=babelHelpers.classPrivateFieldLooseKey("throwNotImplementedError");class m{constructor(e,t){Object.defineProperty(this,d,{value:C});this._id="";this._settings={};this._gridId="";this._entityTypeId=BX.CrmEntityType.enumeration.undefined;this._entityIds=null;this._filter=null;this._operationHash="";this._containerId="";this._errors=null;this._progress=null;this._hasLayout=false;this._isRunning=false;this._progressChangeHandler=this.onProgress.bind(this);this._documentUnloadHandler=this.onDocumentUnload.bind(this);this._summaryLayoutHandler=this.onSummaryLayout.bind(this);this._summaryClearLayoutHandler=this.onSummaryClearLayout.bind(this);this._id=a.Type.isStringFilled(e)?e:`${this.getIdPrefix()}_${Math.random().toString().slice(2)}`;this._settings=t||{};this._gridId=BX.prop.getString(this._settings,"gridId",this._id);this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",BX.CrmEntityType.enumeration.undefined);this._containerId=BX.prop.getString(this._settings,"container","");if(this._containerId===""){throw`${this.getEventNamespace()}: Could not find container.`}this._progress=_.create(`${this.getIdPrefix()}_${this._id}`,{controllerActionName:this.getProcessActionName(),container:this._containerId,enableCancellation:true,title:this.getMessage("title"),timeout:1e3,stateTemplate:BX.prop.getString(this._settings,"stateTemplate",null),enableLayout:false});this._errors=[]}getEventNamespace(){return`BX.Crm.${this.getEventNamespacePostfix()}`}getEventNamespacePostfix(){babelHelpers.classPrivateFieldLooseBase(this,d)[d]()}getIdPrefix(){babelHelpers.classPrivateFieldLooseBase(this,d)[d]()}getProcessActionName(){babelHelpers.classPrivateFieldLooseBase(this,d)[d]()}getPrepareActionName(){babelHelpers.classPrivateFieldLooseBase(this,d)[d]()}getCancelActionName(){babelHelpers.classPrivateFieldLooseBase(this,d)[d]()}getId(){return this._id}getEntityIds(){return this._entityIds}setEntityIds(e){this._entityIds=a.Type.isArray(e)?e:[]}resetEntityIds(){this._entityIds=[]}getFilter(){return this._filter}setFilter(e){this._filter=a.Type.isPlainObject(e)?e:null}getMessage(e,t=null){const s=BX.prop.getObject(this._settings,"messages",this.getDefaultMessages());return BX.prop.getString(s,e,t!=null?t:e)}getDefaultMessages(){return this.constructor.messages}scrollInToView(){if(this._progress){this._progress.scrollInToView();this.refreshGridHeader()}}refreshGridHeader(){window.requestAnimationFrame((()=>{const e=BX.Main.gridManager.getById(this._gridId);if(e&&e.instance&&e.instance.pinHeader){e.instance.pinHeader.refreshRect();e.instance.pinHeader._onScroll()}}))}layout(){if(this._hasLayout){return}this._progress.layout();this._hasLayout=true}clearLayout(){if(!this._hasLayout){return}this._progress.clearLayout();this._hasLayout=false}getState(){return this._progress.getState()}getProcessedItemCount(){return this._progress.getProcessedItemCount()}getTotalItemCount(){return this._progress.getTotalItemCount()}execute(){this.layout();this.run();window.setTimeout(this.scrollInToView.bind(this),100)}isRunning(){return this._isRunning}run(){if(this._isRunning){return}this._isRunning=true;l.Instance.registerProcessRun(this._gridId);BX.bind(window,"beforeunload",this._documentUnloadHandler);this.enableGridFilter(false);a.ajax.runAction(this.getPrepareActionName(),{data:{params:this.getPrepareActionParams()}}).then((e=>{const t=BX.prop.getString(BX.prop.getObject(e,"data",{}),"hash","");if(t===""){this.reset();return}this._operationHash=t;this._progress.setParams({hash:this._operationHash});this._progress.run();BX.addCustomEvent(this._progress,"ON_AUTORUN_PROCESS_STATE_CHANGE",this._progressChangeHandler)})).catch((()=>{this.reset()}))}getPrepareActionParams(){const e={gridId:this._gridId,entityTypeId:this._entityTypeId,extras:BX.prop.getObject(this._settings,"extras",{})};if(a.Type.isArray(this._entityIds)&&this._entityIds.length>0){e.entityIds=this._entityIds}return e}stop(){if(!this._isRunning){return}this._isRunning=false;void a.ajax.runAction(this.getCancelActionName(),{data:{params:{hash:this._operationHash}}});this.reset()}reset(){BX.unbind(window,"beforeunload",this._documentUnloadHandler);BX.removeCustomEvent(this._progress,"ON_AUTORUN_PROCESS_STATE_CHANGE",this._progressChangeHandler);this._isRunning=false;l.Instance.registerProcessStop(this._gridId);this._operationHash="";this._errors=[];const e=this._progress.getProcessedItemCount()>0;this._progress.reset();if(this._hasLayout){window.setTimeout(this.clearLayout.bind(this),100)}this.enableGridFilter(true);if(e){BX.Main.gridManager.reload(this._gridId)}}enableGridFilter(e){const t=this._gridId===""?null:BX(`${this._gridId}_search_container`);if(!t){return}if(e){BX.removeClass(t,"main-ui-disable")}else{BX.addClass(t,"main-ui-disable")}}getErrorCount(){return this._errors?this._errors.length:0}getErrors(){var e;return(e=this._errors)!=null?e:[]}onDocumentUnload(e){e.preventDefault();e.returnValue=true}onProgress(e){const t=this._progress.getState();if(t===c.stopped){this.stop();return}const s=this._progress.getErrors();if(s.length>0){if(this._errors){this._errors=[...this._errors,...s]}else{this._errors=s}}if(t===c.completed||t===c.error){const e=this.getErrorCount();const t=this.getProcessedItemCount()-e;BX.addCustomEvent(window,"BX.Crm.ProcessSummaryPanel:onLayout",this._summaryLayoutHandler);p.create(this._id,{container:this._containerId,data:{succeededCount:t,failedCount:e,errors:this.getErrors()},messages:BX.prop.getObject(this._settings,"messages",this.constructor.messages),numberSubstitution:"#number#",displayTimeout:1500}).layout();this.reset();window.setTimeout((()=>{BX.onCustomEvent(window,`${this.getEventNamespace()}:onProcessComplete`,[this])}),300)}}onSummaryLayout(){this.refreshGridHeader();BX.removeCustomEvent(window,"BX.Crm.ProcessSummaryPanel:onLayout",this._summaryLayoutHandler);BX.addCustomEvent(window,"BX.Crm.ProcessSummaryPanel:onClearLayout",this._summaryClearLayoutHandler)}onSummaryClearLayout(){this.refreshGridHeader();BX.removeCustomEvent(window,"BX.Crm.ProcessSummaryPanel:onClearLayout",this._summaryClearLayoutHandler)}}function C(){throw new Error("not implemented")}m.messages={};var T=babelHelpers.classPrivateFieldLooseKey("assignedById");class B extends m{constructor(...e){super(...e);Object.defineProperty(this,T,{writable:true,value:void 0})}static getItem(e){return BX.prop.get(B.items,e,null)}static create(e,t){const s=new B(e,t);B.items[s.getId()]=s;return s}getIdPrefix(){return"crm_batch_assignment_mgr"}getEventNamespacePostfix(){return"BatchAssignmentManager"}getPrepareActionName(){return"crm.api.autorun.assign.prepare"}getPrepareActionParams(){const e=super.getPrepareActionParams();e.assignedById=babelHelpers.classPrivateFieldLooseBase(this,T)[T];return e}getProcessActionName(){return"crm.api.autorun.assign.process"}getCancelActionName(){return"crm.api.autorun.assign.cancel"}setAssignedById(e){babelHelpers.classPrivateFieldLooseBase(this,T)[T]=a.Text.toInteger(e)}}B.messages={title:a.Loc.getMessage("CRM_AUTORUN_BATCH_ASSIGN_TITLE"),summaryCaption:a.Loc.getMessage("CRM_AUTORUN_BATCH_ASSIGN_SUMMARY_CAPTION"),summarySucceeded:a.Loc.getMessage("CRM_AUTORUN_BATCH_ASSIGN_SUMMARY_SUCCEEDED"),summaryFailed:a.Loc.getMessage("CRM_AUTORUN_BATCH_ASSIGN_SUMMARY_FAILED")};B.items={};var A=babelHelpers.classPrivateFieldLooseKey("sendAnalyticsData");class f{static getItem(e){return BX.prop.get(f.items,e,null)}static create(e,t){const s=new f(e,t);f.items[s.getId()]=s;return s}constructor(e,t){Object.defineProperty(this,A,{value:y});this._id="";this._settings={};this._gridId="";this._config=null;this._entityIds=null;this._enableUserFieldCheck=true;this._enableConfigCheck=true;this._filter=null;this._serviceUrl="";this._containerId="";this._errors=null;this._progress=null;this._hasLayout=false;this._succeededItemCount=0;this._failedItemCount=0;this._isRunning=false;this._messages=null;this._progressChangeHandler=this.onProgress.bind(this);this._documentUnloadHandler=this.onDocumentUnload.bind(this);this._id=a.Type.isStringFilled(e)?e:`crm_batch_conversion_mgr_${Math.random().toString().slice(2)}`;this._settings=t||{};this._gridId=BX.prop.getString(this._settings,"gridId",this._id);this._config=BX.prop.getObject(this._settings,"config",{});this._entityIds=BX.prop.getArray(this._settings,"entityIds",[]);this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");if(this._serviceUrl===""){throw"BX.Crm.BatchConversionManager. Could not find 'serviceUrl' parameter in settings."}this._containerId=BX.prop.getString(this._settings,"container","");if(this._containerId===""){throw"BX.Crm.BatchConversionManager: Could not find container."}const s={serviceUrl:this._serviceUrl,actionName:"PROCESS_BATCH_CONVERSION",container:this._containerId,enableCancellation:true,title:this.getMessage("title"),enableLayout:false};const r=BX.prop.getString(this._settings,"stateTemplate",null);if(a.Type.isStringFilled(r)){s.stateTemplate=r}this._progress=_.create(this._id,s);this._errors=[]}isRunning(){return this._isRunning}resetEntityIds(){this._entityIds=[]}getId(){return this._id}getConfig(){return this._config}setConfig(e){this._config=a.Type.isPlainObject(e)?e:{}}getEntityIds(){return this._entityIds}setEntityIds(e){this._entityIds=a.Type.isArray(e)?e:[]}getFilter(){return this._filter}setFilter(e){this._filter=a.Type.isPlainObject(e)?e:null}isUserFieldCheckEnabled(){return this._enableUserFieldCheck}enableUserFieldCheck(e){this._enableUserFieldCheck=e}isConfigCheckEnabled(){return this._enableConfigCheck}enableConfigCheck(e){this._enableConfigCheck=e}getMessage(e){if(this._messages&&BX.prop.getString(this._messages,e,null)){return BX.prop.getString(this._messages,e,e)}const t=BX.prop.getObject(this._settings,"messages",f.messages);return BX.prop.getString(t,e,e)}layout(){if(this._hasLayout){return}this._progress.layout();this._hasLayout=true}clearLayout(){if(!this._hasLayout){return}this._progress.clearLayout();this._hasLayout=false}getState(){return this._progress.getState()}getProcessedItemCount(){return this._progress.getProcessedItemCount()}getTotalItemCount(){return this._progress.getTotalItemCount()}execute(){const e={GRID_ID:this._gridId,CONFIG:this._config,ENABLE_CONFIG_CHECK:this._enableConfigCheck?"Y":"N",ENABLE_USER_FIELD_CHECK:this._enableUserFieldCheck?"Y":"N"};if(this._filter===null){e.IDS=this._entityIds}else{e.FILTER=this._filter}const t={ACTION:"PREPARE_BATCH_CONVERSION",PARAMS:e,sessid:BX.bitrix_sessid()};babelHelpers.classPrivateFieldLooseBase(this,A)[A]("attempt");a.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:t,onsuccess:this.onPrepare.bind(this)})}onPrepare(e){const t=a.Type.isPlainObject(e.DATA)?e.DATA:{};const s=BX.prop.getString(t,"STATUS","");this._config=BX.prop.getObject(t,"CONFIG",{});if(t.hasOwnProperty("messages")&&a.Type.isPlainObject(t.messages)){this._messages=t.messages;if(!BX.CrmLeadConverter.messages){BX.CrmLeadConverter.messages={}}BX.CrmLeadConverter.messages=Object.assign(BX.CrmLeadConverter.messages,t.messages)}if(s==="ERROR"){babelHelpers.classPrivateFieldLooseBase(this,A)[A]("error");const e=BX.prop.getArray(t,"ERRORS",[]);i.MessageBox.alert(e.map((e=>a.Text.encode(e))).join("<br/>"),this.getMessage("title"));return}if(s==="REQUIRES_SYNCHRONIZATION"){const e=BX.CrmLeadConverter.getCurrent().createSynchronizationEditor(this._id,this._config,BX.prop.getArray(t,"FIELD_NAMES",[]));e.addClosingListener(this.onSynchronizationEditorClose.bind(this));e.show();return}this.layout();this.run()}run(){if(this._isRunning){return}this._isRunning=true;l.Instance.registerProcessRun(this._gridId);this._progress.setParams({GRID_ID:this._gridId,CONFIG:this._config});this._progress.run();BX.addCustomEvent(this._progress,"ON_AUTORUN_PROCESS_STATE_CHANGE",this._progressChangeHandler);BX.bind(window,"beforeunload",this._documentUnloadHandler)}stop(){if(!this._isRunning){return}this._isRunning=false;babelHelpers.classPrivateFieldLooseBase(this,A)[A]("cancel");a.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"STOP_BATCH_CONVERSION",PARAMS:{GRID_ID:this._gridId}},onsuccess:this.onStop.bind(this)})}onStop(e){this.reset();window.setTimeout((()=>{BX.onCustomEvent(window,"BX.Crm.BatchConversionManager:onStop",[this])}),300)}reset(){this._progress.reset();BX.removeCustomEvent(this._progress,"ON_AUTORUN_PROCESS_STATE_CHANGE",this._progressChangeHandler);BX.unbind(window,"beforeunload",this._documentUnloadHandler);if((this._succeededItemCount>0||this._failedItemCount>0)&&BX.getClass("BX.Main.gridManager")){BX.Main.gridManager.reload(this._gridId)}this._succeededItemCount=this._failedItemCount=0;this._isRunning=false;l.Instance.registerProcessStop(this._gridId);if(this._hasLayout){window.setTimeout(this.clearLayout.bind(this),100)}this._errors=[]}getSucceededItemCount(){return this._succeededItemCount}getFailedItemCount(){return this._failedItemCount}getErrors(){return this._errors}onDocumentUnload(e){e.preventDefault();e.returnValue=true}onSynchronizationEditorClose(e,t){if(BX.prop.getBoolean(t,"isCanceled",false)){babelHelpers.classPrivateFieldLooseBase(this,A)[A]("cancel");this.clearLayout();return}this._config=e.getConfig();this.run()}onProgress(e){const t=this._progress.getState();if(t===c.stopped){this.stop();return}const s=this._progress.getErrors();if(s.length===0){this._succeededItemCount++}else{if(this._errors){this._errors=[...this._errors,...s]}else{this._errors=s}this._failedItemCount++;babelHelpers.classPrivateFieldLooseBase(this,A)[A]("error")}if(t===c.completed){babelHelpers.classPrivateFieldLooseBase(this,A)[A]("success");p.create(this._id,{container:this._containerId,data:{succeededCount:this.getSucceededItemCount(),failedCount:this.getFailedItemCount(),errors:this.getErrors()},messages:BX.prop.getObject(this._settings,"messages",null),numberSubstitution:"#number_leads#"}).layout();this.reset();window.setTimeout((()=>{BX.onCustomEvent(window,"BX.Crm.BatchConversionManager:onProcessComplete",[this])}),300)}}}function y(e){if(!BX.CrmEntityType.isDefined(this._settings.entityTypeId)){return}for(const t of Object.keys(this._config)){if(this._config[t].active!=="Y"){continue}const i=s.Builder.Entity.ConvertBatchEvent.createDefault(this._settings.entityTypeId,BX.CrmEntityType.resolveId(t));if(a.Type.isPlainObject(this._settings.analytics)){if(a.Type.isStringFilled(this._settings.analytics.c_section)){i.setSection(this._settings.analytics.c_section)}if(a.Type.isStringFilled(this._settings.analytics.c_sub_section)){i.setSubSection(this._settings.analytics.c_sub_section)}if(a.Type.isStringFilled(this._settings.analytics.c_element)){i.setElement(this._settings.analytics.c_element)}}i.setStatus(e);r.sendData(i.buildData())}}f.messages={};f.items={};class E extends m{static getItem(e){return BX.prop.get(E.items,e,null)}static create(e,t){const s=new E(e,t);E.items[s.getId()]=s;return s}getDefaultMessages(){const e=super.getDefaultMessages();const t=BX.CrmEntityType.resolveName(this._entityTypeId);const s=a.Loc.getMessage(`CRM_AUTORUN_BATCH_DELETE_TITLE_${t}`);if(a.Type.isStringFilled(s)){e.title=s}const r=a.Loc.getMessage(`CRM_AUTORUN_BATCH_DELETE_CONFIRMATION_TITLE_${t}`);if(a.Type.isStringFilled(r)){e.confirmationTitle=r}return e}getIdPrefix(){return"crm_batch_deletion_mgr"}getEventNamespacePostfix(){return"BatchDeletionManager"}getPrepareActionName(){return"crm.api.autorun.delete.prepare"}getProcessActionName(){return"crm.api.autorun.delete.process"}getCancelActionName(){return"crm.api.autorun.delete.cancel"}execute(){i.MessageBox.confirm(this.getMessage("confirmation"),this.getMessage("confirmationTitle","")||this.getMessage("title"),(()=>{super.execute();return true}),this.getMessage("confirmationYesCaption"))}}E.messages={title:a.Loc.getMessage("CRM_AUTORUN_BATCH_DELETE_TITLE"),confirmation:a.Loc.getMessage("CRM_AUTORUN_BATCH_DELETE_CONFIRMATION"),confirmationTitle:a.Loc.getMessage("CRM_AUTORUN_BATCH_DELETE_CONFIRMATION_TITLE"),confirmationYesCaption:a.Loc.getMessage("CRM_AUTORUN_BATCH_DELETE_CONFIRMATION_YES_CAPTION"),summaryCaption:a.Loc.getMessage("CRM_AUTORUN_BATCH_DELETE_SUMMARY_CAPTION"),summarySucceeded:a.Loc.getMessage("CRM_AUTORUN_BATCH_DELETE_SUMMARY_SUCCEEDED"),summaryFailed:a.Loc.getMessage("CRM_AUTORUN_BATCH_DELETE_SUMMARY_FAILED")};E.items={};class I extends m{static getItem(e){return BX.prop.get(I.items,e,null)}static create(e,t){const s=new I(e,t);I.items[s.getId()]=s;return s}getIdPrefix(){return"crm_batch_exclusion_mgr"}getEventNamespacePostfix(){return"BatchExclusionManager"}getPrepareActionName(){return"crm.api.autorun.exclusion.prepare"}getProcessActionName(){return"crm.api.autorun.exclusion.process"}getCancelActionName(){return"crm.api.autorun.exclusion.cancel"}}I.messages={title:a.Loc.getMessage("CRM_AUTORUN_BATCH_EXCLUSION_TITLE"),summaryCaption:a.Loc.getMessage("CRM_AUTORUN_BATCH_EXCLUSION_SUMMARY_CAPTION"),summarySucceeded:a.Loc.getMessage("CRM_AUTORUN_BATCH_EXCLUSION_SUMMARY_SUCCEEDED"),summaryFailed:a.Loc.getMessage("CRM_AUTORUN_BATCH_EXCLUSION_SUMMARY_FAILED")};I.items={};var P=babelHelpers.classPrivateFieldLooseKey("categoryId");class S extends m{constructor(...e){super(...e);Object.defineProperty(this,P,{writable:true,value:void 0})}static getItem(e){return BX.prop.get(S.items,e,null)}static create(e,t){const s=new S(e,t);S.items[s.getId()]=s;return s}getIdPrefix(){return"crm_batch_set_category_mgr"}getEventNamespacePostfix(){return"BatchSetCategoryManager"}getPrepareActionName(){return"crm.api.autorun.setcategory.prepare"}getPrepareActionParams(){const e=super.getPrepareActionParams();e.categoryId=babelHelpers.classPrivateFieldLooseBase(this,P)[P];return e}getProcessActionName(){return"crm.api.autorun.setcategory.process"}getCancelActionName(){return"crm.api.autorun.setcategory.cancel"}setCategoryId(e){babelHelpers.classPrivateFieldLooseBase(this,P)[P]=a.Text.toInteger(e)}}S.messages={title:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_CATEGORY_TITLE"),summaryCaption:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_CATEGORY_SUMMARY_CAPTION"),summarySucceeded:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_CATEGORY_SUMMARY_SUCCEEDED"),summaryFailed:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_CATEGORY_SUMMARY_FAILED")};S.items={};var b=babelHelpers.classPrivateFieldLooseKey("export");class R extends m{constructor(...e){super(...e);Object.defineProperty(this,b,{writable:true,value:void 0})}static getItem(e){return BX.prop.get(R.items,e,null)}static create(e,t){const s=new R(e,t);R.items[s.getId()]=s;return s}getDefaultMessages(){const e=super.getDefaultMessages();const t=BX.CrmEntityType.resolveName(this._entityTypeId);const s=a.Loc.getMessage(`CRM_AUTORUN_BATCH_SET_EXPORT_TITLE_${t}`);if(a.Type.isStringFilled(s)){e.title=s}return e}getIdPrefix(){return"crm_batch_set_export_mgr"}getEventNamespacePostfix(){return"BatchSetExportManager"}getPrepareActionName(){return"crm.api.autorun.setexport.prepare"}getPrepareActionParams(){const e=super.getPrepareActionParams();e.export=babelHelpers.classPrivateFieldLooseBase(this,b)[b]?"Y":"N";return e}getProcessActionName(){return"crm.api.autorun.setexport.process"}getCancelActionName(){return"crm.api.autorun.setexport.cancel"}setExport(e){if(a.Type.isString(e)){babelHelpers.classPrivateFieldLooseBase(this,b)[b]=e==="Y"}else{babelHelpers.classPrivateFieldLooseBase(this,b)[b]=Boolean(e)}}}R.messages={title:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_EXPORT_TITLE"),summaryCaption:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_EXPORT_SUMMARY_CAPTION"),summarySucceeded:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_EXPORT_SUMMARY_SUCCEEDED"),summaryFailed:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_EXPORT_SUMMARY_FAILED")};R.items={};var M=babelHelpers.classPrivateFieldLooseKey("isOpened");class L extends m{constructor(...e){super(...e);Object.defineProperty(this,M,{writable:true,value:void 0})}static getItem(e){return BX.prop.get(L.items,e,null)}static create(e,t){const s=new L(e,t);L.items[s.getId()]=s;return s}getIdPrefix(){return"crm_batch_set_stage_mgr"}getEventNamespacePostfix(){return"BatchSetOpenedManager"}getPrepareActionName(){return"crm.api.autorun.setopened.prepare"}getPrepareActionParams(){const e=super.getPrepareActionParams();e.isOpened=babelHelpers.classPrivateFieldLooseBase(this,M)[M]?"Y":"N";return e}getProcessActionName(){return"crm.api.autorun.setopened.process"}getCancelActionName(){return"crm.api.autorun.setopened.cancel"}setIsOpened(e){if(a.Type.isString(e)){babelHelpers.classPrivateFieldLooseBase(this,M)[M]=e==="Y"}else{babelHelpers.classPrivateFieldLooseBase(this,M)[M]=Boolean(e)}}}L.messages={title:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_OPENED_TITLE"),summaryCaption:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_OPENED_SUMMARY_CAPTION"),summarySucceeded:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_OPENED_SUMMARY_SUCCEEDED"),summaryFailed:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_OPENED_SUMMARY_FAILED")};L.items={};var N=babelHelpers.classPrivateFieldLooseKey("stageId");class v extends m{constructor(...e){super(...e);Object.defineProperty(this,N,{writable:true,value:void 0})}static getItem(e){return BX.prop.get(v.items,e,null)}static create(e,t){const s=new v(e,t);v.items[s.getId()]=s;return s}getIdPrefix(){return"crm_batch_set_stage_mgr"}getEventNamespacePostfix(){return"BatchSetStageManager"}getPrepareActionName(){return"crm.api.autorun.setstage.prepare"}getPrepareActionParams(){const e=super.getPrepareActionParams();e.stageId=babelHelpers.classPrivateFieldLooseBase(this,N)[N];return e}getProcessActionName(){return"crm.api.autorun.setstage.process"}getCancelActionName(){return"crm.api.autorun.setstage.cancel"}setStageId(e){babelHelpers.classPrivateFieldLooseBase(this,N)[N]=String(e)}}v.messages={title:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_STAGE_TITLE"),summaryCaption:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_STAGE_SUMMARY_CAPTION"),summarySucceeded:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_STAGE_SUMMARY_SUCCEEDED"),summaryFailed:a.Loc.getMessage("CRM_AUTORUN_BATCH_SET_STAGE_SUMMARY_FAILED")};v.items={};class w extends m{static getItem(e){return BX.prop.get(w.items,e,null)}static create(e,t){const s=new w(e,t);w.items[s.getId()]=s;return s}getIdPrefix(){return"crm_batch_refresh_accounting_data_mgr"}getEventNamespacePostfix(){return"BatchRefreshAccountingDataManager"}getPrepareActionName(){return"crm.api.autorun.refreshaccountingdata.prepare"}getProcessActionName(){return"crm.api.autorun.refreshaccountingdata.process"}getCancelActionName(){return"crm.api.autorun.refreshaccountingdata.cancel"}}w.messages={title:a.Loc.getMessage("CRM_AUTORUN_BATCH_REFRESH_ACCOUNTING_DATA_TITLE"),summaryCaption:a.Loc.getMessage("CRM_AUTORUN_BATCH_REFRESH_ACCOUNTING_DATA_SUMMARY_CAPTION"),summarySucceeded:a.Loc.getMessage("CRM_AUTORUN_BATCH_REFRESH_ACCOUNTING_DATA_SUMMARY_SUCCEEDED"),summaryFailed:a.Loc.getMessage("CRM_AUTORUN_BATCH_REFRESH_ACCOUNTING_DATA_SUMMARY_FAILED")};w.items={};let U=e=>e,O;var X=babelHelpers.classPrivateFieldLooseKey("container");var H=babelHelpers.classPrivateFieldLooseKey("storage");class F{constructor(e){Object.defineProperty(this,X,{writable:true,value:void 0});Object.defineProperty(this,H,{writable:true,value:new Map});if(!a.Type.isElementNode(e)){throw new TypeError("expected element node")}babelHelpers.classPrivateFieldLooseBase(this,X)[X]=e}getOrCreateProgressBarContainer(e){const t=F.getFullId(e);if(babelHelpers.classPrivateFieldLooseBase(this,H)[H].has(t)){return babelHelpers.classPrivateFieldLooseBase(this,H)[H].get(t)}let s=babelHelpers.classPrivateFieldLooseBase(this,X)[X].querySelector(`div#${t}`);if(!s){s=a.Tag.render(O||(O=U`<div id="${0}"></div>`),t);a.Dom.append(s,babelHelpers.classPrivateFieldLooseBase(this,X)[X])}babelHelpers.classPrivateFieldLooseBase(this,H)[H].set(t,s);return s}static getFullId(e){return`crm-autorun-progress-bar-${e}`}}var D=babelHelpers.classPrivateFieldLooseKey("templateParams");var x=babelHelpers.classPrivateFieldLooseKey("instances");class j extends m{constructor(...e){super(...e);Object.defineProperty(this,D,{writable:true,value:null})}setTemplateParams(e){babelHelpers.classPrivateFieldLooseBase(this,D)[D]=e}static getInstance(e,t){if(babelHelpers.classPrivateFieldLooseBase(j,x)[x].has(e)){return babelHelpers.classPrivateFieldLooseBase(j,x)[x].get(e)}const s=new j(e,t);babelHelpers.classPrivateFieldLooseBase(j,x)[x].set(s.getId(),s);return s}getPrepareActionParams(){if(!babelHelpers.classPrivateFieldLooseBase(this,D)[D]){throw new Error("templateParams is required")}const e=super.getPrepareActionParams();return{...e,extras:{messageBody:babelHelpers.classPrivateFieldLooseBase(this,D)[D].messageBody,messageTemplate:babelHelpers.classPrivateFieldLooseBase(this,D)[D].messageTemplate,fromPhone:babelHelpers.classPrivateFieldLooseBase(this,D)[D].fromPhone}}}getIdPrefix(){return"crm_batch_whatsappmessage_mgr"}getEventNamespacePostfix(){return"BatchWhatsAppMessageManager"}getPrepareActionName(){return"crm.api.autorun.whatsappmessage.prepare"}getProcessActionName(){return"crm.api.autorun.whatsappmessage.process"}getCancelActionName(){return"crm.api.autorun.whatsappmessage.cancel"}}j.messages={title:a.Loc.getMessage("CRM_AUTORUN_BATCH_WHATSAPP_MESSAGE_TITLE"),summaryCaption:a.Loc.getMessage("CRM_AUTORUN_BATCH_WHATSAPP_MESSAGE_SUMMARY_CAPTION"),summarySucceeded:a.Loc.getMessage("CRM_AUTORUN_BATCH_WHATSAPP_MESSAGE_SUMMARY_SUCCEEDED"),summaryFailed:a.Loc.getMessage("CRM_AUTORUN_BATCH_WHATSAPP_MESSAGE_SUMMARY_FAILED")};Object.defineProperty(j,x,{writable:true,value:new Map});const Y=a.Reflection.namespace("BX");Y.AutorunProcessManager=_;Y.AutorunProcessPanel=h;Y.AutoRunProcessState=c;const G=a.Reflection.namespace("BX.Crm");G.ProcessSummaryPanel=p;G.BatchDeletionManager=E;G.BatchConversionManager=f;e.ProcessRegistry=l;e.Processor=_;e.ProcessPanel=h;e.ProcessState=c;e.SummaryPanel=p;e.ProgressBarRepository=F;e.BatchAssignmentManager=B;e.BatchDeletionManager=E;e.BatchConversionManager=f;e.BatchSetCategoryManager=S;e.BatchSetStageManager=v;e.BatchSetOpenedManager=L;e.BatchSetExportManager=R;e.BatchExclusionManager=I;e.BatchWhatsappMessageManager=j;e.BatchRefreshAccountingDataManager=w})(this.BX.Crm.Autorun=this.BX.Crm.Autorun||{},BX,BX.Crm.Integration.Analytics,BX.UI.Analytics,BX.UI.Dialogs,BX);
//# sourceMappingURL=autorun.bundle.map.js