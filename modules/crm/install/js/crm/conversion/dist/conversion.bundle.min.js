this.BX=this.BX||{};(function(exports,crm_categoryList,crm_categoryModel,main_core_events,main_popup,ui_buttons,ui_dialogs_messagebox,ui_forms,main_core){"use strict";function _classPrivateFieldInitSpec(e,t,i){_checkPrivateRedeclaration(e,t);t.set(e,i)}function _checkPrivateRedeclaration(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var _id=new WeakMap;var _name=new WeakMap;var _entityTypeIds=new WeakMap;var _phrase=new WeakMap;var _availabilityLock=new WeakMap;var SchemeItem=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);_classPrivateFieldInitSpec(this,_id,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_name,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_entityTypeIds,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_phrase,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_availabilityLock,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,_id,String(t.id));babelHelpers.classPrivateFieldSet(this,_name,String(t.name));babelHelpers.classPrivateFieldSet(this,_phrase,String(t.phrase));babelHelpers.classPrivateFieldSet(this,_availabilityLock,String(t.availabilityLock));babelHelpers.classPrivateFieldSet(this,_entityTypeIds,[]);if(main_core.Type.isArray(t.entityTypeIds)){t.entityTypeIds.forEach((function(e){babelHelpers.classPrivateFieldGet(i,_entityTypeIds).push(Number(e))}))}}babelHelpers.createClass(e,[{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,_id)}},{key:"getName",value:function e(){return babelHelpers.classPrivateFieldGet(this,_name)}},{key:"getEntityTypeIds",value:function e(){return babelHelpers.classPrivateFieldGet(this,_entityTypeIds)}},{key:"getPhrase",value:function e(){return babelHelpers.classPrivateFieldGet(this,_phrase)}},{key:"getAvailabilityLock",value:function e(){return babelHelpers.classPrivateFieldGet(this,_availabilityLock)}}]);return e}();function _createForOfIteratorHelper(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=_unsupportedIterableToArray(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var a=0;var r=function e(){};return{s:r,n:function t(){if(a>=e.length)return{done:true};return{done:false,value:e[a++]}},e:function e(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n=true,s=false,l;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();n=t.done;return t},e:function e(t){s=true;l=t},f:function e(){try{if(!n&&i["return"]!=null)i["return"]()}finally{if(s)throw l}}}}function _unsupportedIterableToArray(e,t){if(!e)return;if(typeof e==="string")return _arrayLikeToArray(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return _arrayLikeToArray(e,t)}function _arrayLikeToArray(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,a=new Array(t);i<t;i++)a[i]=e[i];return a}function _classPrivateFieldInitSpec$1(e,t,i){_checkPrivateRedeclaration$1(e,t);t.set(e,i)}function _checkPrivateRedeclaration$1(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var _currentItemId=new WeakMap;var _items=new WeakMap;var Scheme=function(){function e(t,i){var a=this;babelHelpers.classCallCheck(this,e);_classPrivateFieldInitSpec$1(this,_currentItemId,{writable:true,value:void 0});_classPrivateFieldInitSpec$1(this,_items,{writable:true,value:[]});babelHelpers.classPrivateFieldSet(this,_currentItemId,main_core.Type.isNull(t)?t:String(t));if(main_core.Type.isArray(i)){i.forEach((function(e){if(e instanceof SchemeItem){babelHelpers.classPrivateFieldGet(a,_items).push(e)}else{console.error("SchemeItem is invalid in Scheme constructor. Expected instance of SchemeItem, got "+babelHelpers["typeof"](e))}}))}}babelHelpers.createClass(e,[{key:"getCurrentItem",value:function e(){if(!babelHelpers.classPrivateFieldGet(this,_items)||!babelHelpers.classPrivateFieldGet(this,_items).length){return null}var t=this.getItemById(babelHelpers.classPrivateFieldGet(this,_currentItemId));return t||babelHelpers.classPrivateFieldGet(this,_items)[0]}},{key:"setCurrentItemId",value:function e(t){babelHelpers.classPrivateFieldSet(this,_currentItemId,t)}},{key:"getItems",value:function e(){return babelHelpers.classPrivateFieldGet(this,_items)}},{key:"getItemById",value:function e(t){var i=_createForOfIteratorHelper(babelHelpers.classPrivateFieldGet(this,_items)),a;try{for(i.s();!(a=i.n()).done;){var r=a.value;if(r.getId()===t){return r}}}catch(e){i.e(e)}finally{i.f()}return null}},{key:"getItemForSingleEntityTypeId",value:function e(t){var i=_createForOfIteratorHelper(babelHelpers.classPrivateFieldGet(this,_items)),a;try{for(i.s();!(a=i.n()).done;){var r=a.value;var n=r.getEntityTypeIds();if(n.length===1&&Array.from(n)[0]===t){return r}}}catch(e){i.e(e)}finally{i.f()}return null}}],[{key:"create",value:function t(i){var a=[];i.items.forEach((function(e){a.push(new SchemeItem(e))}));return new e(i.currentItemId,a)}}]);return e}();function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration$2(e,t);t.add(e)}function _classPrivateFieldInitSpec$2(e,t,i){_checkPrivateRedeclaration$2(e,t);t.set(e,i)}function _checkPrivateRedeclaration$2(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var _active=new WeakMap;var _enableSync=new WeakMap;var _initData=new WeakMap;var _entityTypeId=new WeakMap;var _title=new WeakMap;var _internalizeBooleanValue=new WeakSet;var ConfigItem=function(){function e(t){babelHelpers.classCallCheck(this,e);_classPrivateMethodInitSpec(this,_internalizeBooleanValue);_classPrivateFieldInitSpec$2(this,_active,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(this,_enableSync,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(this,_initData,{writable:true,value:{}});_classPrivateFieldInitSpec$2(this,_entityTypeId,{writable:true,value:void 0});_classPrivateFieldInitSpec$2(this,_title,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,_entityTypeId,Number(t.entityTypeId));babelHelpers.classPrivateFieldSet(this,_active,_classPrivateMethodGet(this,_internalizeBooleanValue,_internalizeBooleanValue2).call(this,t.active));babelHelpers.classPrivateFieldSet(this,_enableSync,_classPrivateMethodGet(this,_internalizeBooleanValue,_internalizeBooleanValue2).call(this,t.enableSync));if(main_core.Type.isPlainObject(t.initData)){babelHelpers.classPrivateFieldSet(this,_initData,t.initData)}babelHelpers.classPrivateFieldSet(this,_title,String(t.title))}babelHelpers.createClass(e,[{key:"externalize",value:function e(){return{entityTypeId:this.getEntityTypeId(),title:this.getTitle(),initData:this.getInitData(),active:this.isActive()?"Y":"N",enableSync:this.isEnableSync()?"Y":"N"}}},{key:"isActive",value:function e(){return babelHelpers.classPrivateFieldGet(this,_active)}},{key:"setActive",value:function e(t){babelHelpers.classPrivateFieldSet(this,_active,t);return this}},{key:"isEnableSync",value:function e(){return babelHelpers.classPrivateFieldGet(this,_enableSync)}},{key:"setEnableSync",value:function e(t){babelHelpers.classPrivateFieldSet(this,_enableSync,t);return this}},{key:"getInitData",value:function e(){return babelHelpers.classPrivateFieldGet(this,_initData)||{}}},{key:"setInitData",value:function e(t){babelHelpers.classPrivateFieldSet(this,_initData,t);return this}},{key:"getEntityTypeId",value:function e(){return babelHelpers.classPrivateFieldGet(this,_entityTypeId)}},{key:"getTitle",value:function e(){return babelHelpers.classPrivateFieldGet(this,_title)}},{key:"setTitle",value:function e(t){babelHelpers.classPrivateFieldSet(this,_title,t);return this}}]);return e}();function _internalizeBooleanValue2(e){if(main_core.Type.isBoolean(e)){return e}if(main_core.Type.isString(e)){return e==="Y"}return Boolean(e)}function _createForOfIteratorHelper$1(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=_unsupportedIterableToArray$1(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var a=0;var r=function e(){};return{s:r,n:function t(){if(a>=e.length)return{done:true};return{done:false,value:e[a++]}},e:function e(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n=true,s=false,l;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();n=t.done;return t},e:function e(t){s=true;l=t},f:function e(){try{if(!n&&i["return"]!=null)i["return"]()}finally{if(s)throw l}}}}function _unsupportedIterableToArray$1(e,t){if(!e)return;if(typeof e==="string")return _arrayLikeToArray$1(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return _arrayLikeToArray$1(e,t)}function _arrayLikeToArray$1(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,a=new Array(t);i<t;i++)a[i]=e[i];return a}function _classPrivateFieldInitSpec$3(e,t,i){_checkPrivateRedeclaration$3(e,t);t.set(e,i)}function _checkPrivateRedeclaration$3(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var _entityTypeId$1=new WeakMap;var _items$1=new WeakMap;var _scheme=new WeakMap;var Config=function(){function e(t,i,a){var r=this;babelHelpers.classCallCheck(this,e);_classPrivateFieldInitSpec$3(this,_entityTypeId$1,{writable:true,value:void 0});_classPrivateFieldInitSpec$3(this,_items$1,{writable:true,value:[]});_classPrivateFieldInitSpec$3(this,_scheme,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,_entityTypeId$1,Number(t));if(main_core.Type.isArray(i)){i.forEach((function(e){if(e instanceof ConfigItem){babelHelpers.classPrivateFieldGet(r,_items$1).push(e)}else{console.error("ConfigItem is invalid in Config constructor. Expected instance of ConfigItem, got "+babelHelpers["typeof"](e))}}))}if(a instanceof Scheme){babelHelpers.classPrivateFieldSet(this,_scheme,a)}else{console.error("Scheme is invalid in Config constructor. Expected instance of Scheme, got "+babelHelpers["typeof"](a))}}babelHelpers.createClass(e,[{key:"getEntityTypeId",value:function e(){return babelHelpers.classPrivateFieldGet(this,_entityTypeId$1)}},{key:"getItems",value:function e(){return babelHelpers.classPrivateFieldGet(this,_items$1)}},{key:"getScheme",value:function e(){return babelHelpers.classPrivateFieldGet(this,_scheme)}},{key:"updateFromSchemeItem",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(!t){t=this.getScheme().getCurrentItem()}else{this.getScheme().setCurrentItemId(t.getId())}var i=t.getEntityTypeIds();babelHelpers.classPrivateFieldGet(this,_items$1).forEach((function(e){var t=i.indexOf(e.getEntityTypeId())>-1;e.setEnableSync(t);e.setActive(t)}));return this}},{key:"getItemByEntityTypeId",value:function e(t){var i=_createForOfIteratorHelper$1(babelHelpers.classPrivateFieldGet(this,_items$1)),a;try{for(i.s();!(a=i.n()).done;){var r=a.value;if(r.getEntityTypeId()===t){return r}}}catch(e){i.e(e)}finally{i.f()}return null}},{key:"externalize",value:function e(){var t={};this.getItems().forEach((function(e){t[BX.CrmEntityType.resolveName(e.getEntityTypeId()).toLowerCase()]=e.externalize()}));return t}},{key:"updateItems",value:function e(t){var i=this;babelHelpers.classPrivateFieldSet(this,_items$1,[]);t.forEach((function(e){babelHelpers.classPrivateFieldGet(i,_items$1).push(new ConfigItem(e))}));return this}}],[{key:"create",value:function t(i,a,r){var n=[];a.forEach((function(e){n.push(new ConfigItem(e))}));return new e(i,n,r)}}]);return e}();var _templateObject,_templateObject2;function _createForOfIteratorHelper$2(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=_unsupportedIterableToArray$2(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var a=0;var r=function e(){};return{s:r,n:function t(){if(a>=e.length)return{done:true};return{done:false,value:e[a++]}},e:function e(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n=true,s=false,l;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();n=t.done;return t},e:function e(t){s=true;l=t},f:function e(){try{if(!n&&i["return"]!=null)i["return"]()}finally{if(s)throw l}}}}function _unsupportedIterableToArray$2(e,t){if(!e)return;if(typeof e==="string")return _arrayLikeToArray$2(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return _arrayLikeToArray$2(e,t)}function _arrayLikeToArray$2(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,a=new Array(t);i<t;i++)a[i]=e[i];return a}function _classPrivateMethodInitSpec$1(e,t){_checkPrivateRedeclaration$4(e,t);t.add(e)}function _classPrivateFieldInitSpec$4(e,t,i){_checkPrivateRedeclaration$4(e,t);t.set(e,i)}function _checkPrivateRedeclaration$4(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$1(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var _entityTypeId$2=new WeakMap;var _entityId=new WeakMap;var _config=new WeakMap;var _params=new WeakMap;var _isProgress=new WeakMap;var _isSynchronisationAllowed=new WeakMap;var _fieldsSynchronizer=new WeakMap;var _request=new WeakSet;var _onRequestSuccess=new WeakSet;var _onRequestError=new WeakSet;var _collectAdditionalData=new WeakSet;var _getCategoryForEntityTypeId=new WeakSet;var _isNeedToLoadCategories=new WeakSet;var _showCategorySelector=new WeakSet;var _processRequiredAction=new WeakSet;var _getFieldsSynchronizer=new WeakSet;var _getMessage=new WeakSet;var _emitConvertedEvent=new WeakSet;var Converter=function(){function Converter(e,t,i){babelHelpers.classCallCheck(this,Converter);_classPrivateMethodInitSpec$1(this,_emitConvertedEvent);_classPrivateMethodInitSpec$1(this,_getMessage);_classPrivateMethodInitSpec$1(this,_getFieldsSynchronizer);_classPrivateMethodInitSpec$1(this,_processRequiredAction);_classPrivateMethodInitSpec$1(this,_showCategorySelector);_classPrivateMethodInitSpec$1(this,_isNeedToLoadCategories);_classPrivateMethodInitSpec$1(this,_getCategoryForEntityTypeId);_classPrivateMethodInitSpec$1(this,_collectAdditionalData);_classPrivateMethodInitSpec$1(this,_onRequestError);_classPrivateMethodInitSpec$1(this,_onRequestSuccess);_classPrivateMethodInitSpec$1(this,_request);_classPrivateFieldInitSpec$4(this,_entityTypeId$2,{writable:true,value:void 0});_classPrivateFieldInitSpec$4(this,_entityId,{writable:true,value:void 0});_classPrivateFieldInitSpec$4(this,_config,{writable:true,value:void 0});_classPrivateFieldInitSpec$4(this,_params,{writable:true,value:void 0});_classPrivateFieldInitSpec$4(this,_isProgress,{writable:true,value:void 0});_classPrivateFieldInitSpec$4(this,_isSynchronisationAllowed,{writable:true,value:void 0});_classPrivateFieldInitSpec$4(this,_fieldsSynchronizer,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,_entityTypeId$2,Number(e));if(t instanceof Config){babelHelpers.classPrivateFieldSet(this,_config,t)}else{console.error("Config is invalid in Converter constructor. Expected instance of Config, got "+babelHelpers["typeof"](t))}babelHelpers.classPrivateFieldSet(this,_params,i!==null&&i!==void 0?i:{});babelHelpers.classPrivateFieldSet(this,_isProgress,false);babelHelpers.classPrivateFieldSet(this,_isSynchronisationAllowed,false);babelHelpers.classPrivateFieldSet(this,_entityId,0)}babelHelpers.createClass(Converter,[{key:"getEntityTypeId",value:function e(){return babelHelpers.classPrivateFieldGet(this,_entityTypeId$2)}},{key:"getConfig",value:function e(){return babelHelpers.classPrivateFieldGet(this,_config)}},{key:"getServiceUrl",value:function e(){var t=babelHelpers.classPrivateFieldGet(this,_params).serviceUrl;if(!t){return null}var i={action:"convert"};this.getConfig().getItems().forEach((function(e){i[BX.CrmEntityType.resolveName(e.getEntityTypeId()).toLowerCase()]=e.isActive()?"Y":"N"}));return BX.util.add_url_param(t,i)}},{key:"getOriginUrl",value:function e(){if(babelHelpers.classPrivateFieldGet(this,_params)&&babelHelpers.classPrivateFieldGet(this,_params).hasOwnProperty("originUrl")){return String(babelHelpers.classPrivateFieldGet(this,_params).originUrl)}return null}},{key:"isRedirectToDetailPageEnabled",value:function e(){if(babelHelpers.classPrivateFieldGet(this,_params)&&babelHelpers.classPrivateFieldGet(this,_params).hasOwnProperty("isRedirectToDetailPageEnabled")){return babelHelpers.classPrivateFieldGet(this,_params).isRedirectToDetailPageEnabled}return true}},{key:"convert",value:function convert(entityId,data){var _this=this;babelHelpers.classPrivateFieldSet(this,_entityId,entityId);this.data=data;var schemeItem=babelHelpers.classPrivateFieldGet(this,_config).getScheme().getCurrentItem();if(!schemeItem){console.error("Scheme is not found");return}if(main_core.Type.isStringFilled(schemeItem.getAvailabilityLock())){eval(schemeItem.getAvailabilityLock());return}_classPrivateMethodGet$1(this,_collectAdditionalData,_collectAdditionalData2).call(this,schemeItem).then((function(e){if(e.isCanceled){return}_classPrivateMethodGet$1(_this,_request,_request2).call(_this)}))["catch"]((function(e){if(e){console.error(e)}}))}}]);return Converter}();function _request2(){var e=this.getServiceUrl();if(!e){console.error("Convert endpoint is not specifier");return}if(babelHelpers.classPrivateFieldGet(this,_isProgress)){console.error("Another request is in progress");return}babelHelpers.classPrivateFieldSet(this,_isProgress,true);main_core.ajax({url:e,method:"POST",dataType:"json",data:{MODE:"CONVERT",ENTITY_ID:babelHelpers.classPrivateFieldGet(this,_entityId),ENABLE_SYNCHRONIZATION:babelHelpers.classPrivateFieldGet(this,_isSynchronisationAllowed)?"Y":"N",ENABLE_REDIRECT_TO_SHOW:this.isRedirectToDetailPageEnabled?"Y":"N",CONFIG:this.getConfig().externalize(),CONTEXT:this.data,ORIGIN_URL:this.getOriginUrl()},onsuccess:_classPrivateMethodGet$1(this,_onRequestSuccess,_onRequestSuccess2).bind(this),onfailure:_classPrivateMethodGet$1(this,_onRequestError,_onRequestError2).bind(this)})}function _onRequestSuccess2(e){babelHelpers.classPrivateFieldSet(this,_isProgress,false);if(e.ERROR){ui_dialogs_messagebox.MessageBox.alert(e.ERROR.MESSAGE||"Error during conversion");return}if(main_core.Type.isPlainObject(e.REQUIRED_ACTION)){return _classPrivateMethodGet$1(this,_processRequiredAction,_processRequiredAction2).call(this,e.REQUIRED_ACTION)}var t=main_core.Type.isPlainObject(e.DATA)?e.DATA:{};if(!t){return}var i=main_core.Type.isString(t.URL)?t.URL:"";var a=false;if(t.IS_FINISHED&&t.IS_FINISHED==="Y"){this.data={};a=_classPrivateMethodGet$1(this,_emitConvertedEvent,_emitConvertedEvent2).call(this,i)}if(i!==""&&!a){BX.Crm.Page.open(i)}else if(!(a&&window.top===window));}function _onRequestError2(e){babelHelpers.classPrivateFieldSet(this,_isProgress,false);ui_dialogs_messagebox.MessageBox.alert(e)}function _collectAdditionalData2(e){var t=this;var i=this.getConfig();var a=[];e.getEntityTypeIds().forEach((function(e){a.push((function(){return _classPrivateMethodGet$1(t,_getCategoryForEntityTypeId,_getCategoryForEntityTypeId2).call(t,e)}))}));var r={isCanceled:false};var n=function e(t){var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;return new Promise((function(n,s){if(r.isCanceled||!t[a]){n(r);return}t[a]().then((function(l){if(l.isCanceled){r.isCanceled=true}else if(l.category){var o=l.category.getEntityTypeId();var c=i.getItemByEntityTypeId(o);if(!c){s("Scheme is not correct: configItem is not found for "+o);return}var u=c.getInitData();u.categoryId=l.category.getId();c.setInitData(u)}n(e(t,++a))}))}))};return n(a)}function _getCategoryForEntityTypeId2(e){var t=this;return new Promise((function(i,a){var r=t.getConfig().getItemByEntityTypeId(e);if(!r){a("Scheme is not correct: configItem is not found for "+e);return}if(_classPrivateMethodGet$1(t,_isNeedToLoadCategories,_isNeedToLoadCategories2).call(t,e)){crm_categoryList.CategoryList.Instance.getItems(e).then((function(e){if(e.length>1){_classPrivateMethodGet$1(t,_showCategorySelector,_showCategorySelector2).call(t,e,r.getTitle()).then(i)["catch"](a)}else{i({isCanceled:false,category:e[0]})}}))["catch"](a)}else{i({isCanceled:false,category:null})}}))}function _isNeedToLoadCategories2(e){return e===BX.CrmEntityType.enumeration.deal||BX.CrmEntityType.isDynamicTypeByTypeId(e)}function _showCategorySelector2(e,t){return new Promise((function(i){var a=main_core.Tag.render(_templateObject||(_templateObject=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-converter-category-selector ui-form ui-form-line">\n\t\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t\t<div class="crm-converter-category-selector-label ui-form-label">\n\t\t\t\t\t\t\t<div class="ui-ctl-label-text">','</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t\t<div class="crm-converter-category-selector-select ui-ctl ui-ctl-after-icon ui-ctl-dropdown">\n\t\t\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t\t\t<select class="ui-ctl-element"></select>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t'])),main_core.Loc.getMessage("CRM_COMMON_CATEGORY"));var r=a.querySelector("select");e.forEach((function(e){r.appendChild(main_core.Tag.render(_templateObject2||(_templateObject2=babelHelpers.taggedTemplateLiteral(['<option value="','">',"</option>"])),e.getId(),main_core.Text.encode(e.getName())))}));var n=new main_popup.Popup({titleBar:main_core.Loc.getMessage("CRM_CONVERSION_CATEGORY_SELECTOR_TITLE",{"#ENTITY#":main_core.Text.encode(t)}),content:a,closeByEsc:true,closeIcon:true,buttons:[new ui_buttons.Button({text:main_core.Loc.getMessage("CRM_COMMON_ACTION_SAVE"),color:ui_buttons.ButtonColor.SUCCESS,onclick:function t(){var a=Array.from(r.selectedOptions)[0].value;n.destroy();var s=_createForOfIteratorHelper$2(e),l;try{for(s.s();!(l=s.n()).done;){var o=l.value;if(o.getId()===Number(a)){i({category:o});return true}}}catch(e){s.e(e)}finally{s.f()}console.error("Selected category not found");i({isCanceled:true});return true}}),new ui_buttons.Button({text:main_core.Loc.getMessage("CRM_COMMON_ACTION_CANCEL"),color:ui_buttons.ButtonColor.LIGHT,onclick:function e(){n.destroy();i({isCanceled:true});return true}})],events:{onClose:function e(){i({isCanceled:true})}}});n.show()}))}function _processRequiredAction2(e){var t=String(e.NAME);var i=main_core.Type.isPlainObject(e.DATA)?e.DATA:{};if(t==="SYNCHRONIZE"){var a=null;if(main_core.Type.isArray(i.CONFIG)){a=i.CONFIG}else if(main_core.Type.isPlainObject(i.CONFIG)){a=Object.values(i.CONFIG)}if(a){babelHelpers.classPrivateFieldGet(this,_config).updateItems(a)}_classPrivateMethodGet$1(this,_getFieldsSynchronizer,_getFieldsSynchronizer2).call(this,main_core.Type.isArray(i.FIELD_NAMES)?i.FIELD_NAMES:[]).show();return}if(t==="CORRECT"){if(main_core.Type.isPlainObject(i.CHECK_ERRORS)){return}}}function _getFieldsSynchronizer2(e){var t=this;if(babelHelpers.classPrivateFieldGet(this,_fieldsSynchronizer)){babelHelpers.classPrivateFieldGet(this,_fieldsSynchronizer).setConfig(babelHelpers.classPrivateFieldGet(this,_config).externalize());babelHelpers.classPrivateFieldGet(this,_fieldsSynchronizer).setFieldNames(e);return babelHelpers.classPrivateFieldGet(this,_fieldsSynchronizer)}babelHelpers.classPrivateFieldSet(this,_fieldsSynchronizer,BX.CrmEntityFieldSynchronizationEditor.create("crm_converter_fields_synchronizer_"+this.getEntityTypeId(),{config:babelHelpers.classPrivateFieldGet(this,_config).externalize(),title:_classPrivateMethodGet$1(this,_getMessage,_getMessage2).call(this,"dialogTitle"),fieldNames:e,legend:_classPrivateMethodGet$1(this,_getMessage,_getMessage2).call(this,"syncEditorLegend"),fieldListTitle:_classPrivateMethodGet$1(this,_getMessage,_getMessage2).call(this,"syncEditorFieldListTitle"),entityListTitle:_classPrivateMethodGet$1(this,_getMessage,_getMessage2).call(this,"syncEditorEntityListTitle"),continueButton:_classPrivateMethodGet$1(this,_getMessage,_getMessage2).call(this,"continueButton"),cancelButton:_classPrivateMethodGet$1(this,_getMessage,_getMessage2).call(this,"cancelButton")}));babelHelpers.classPrivateFieldGet(this,_fieldsSynchronizer).addClosingListener((function(e,i){if(!(main_core.Type.isBoolean(i["isCanceled"])&&i["isCanceled"]===false)){return}babelHelpers.classPrivateFieldSet(t,_isSynchronisationAllowed,true);babelHelpers.classPrivateFieldGet(t,_config).updateItems(Object.values(babelHelpers.classPrivateFieldGet(t,_fieldsSynchronizer).getConfig()));_classPrivateMethodGet$1(t,_request,_request2).call(t)}));return babelHelpers.classPrivateFieldGet(this,_fieldsSynchronizer)}function _getMessage2(e){if(!babelHelpers.classPrivateFieldGet(this,_params).messages){babelHelpers.classPrivateFieldGet(this,_params).messages={}}return babelHelpers.classPrivateFieldGet(this,_params).messages[e]||e}function _emitConvertedEvent2(e){var t=this.getEntityTypeId();var i={entityTypeId:t,entityTypeName:BX.CrmEntityType.resolveName(t),entityId:babelHelpers.classPrivateFieldGet(this,_entityId),redirectUrl:e,isRedirected:false};var a=BX.Crm.Page.getTopSlider();if(a){i["sliderUrl"]=a.getUrl()}BX.onCustomEvent(window,"Crm.EntityConverter.Converted",[this,i]);BX.localStorage.set("onCrmEntityConvert",i,10);this.getConfig().getItems().forEach((function(e){if(e.isActive()){main_core_events.EventEmitter.emit("Crm.EntityConverter.SingleConverted",{entityTypeName:BX.CrmEntityType.resolveName(e.getEntityTypeId())})}}));return i["isRedirected"]}function _classPrivateMethodInitSpec$2(e,t){_checkPrivateRedeclaration$5(e,t);t.add(e)}function _classPrivateFieldInitSpec$5(e,t,i){_checkPrivateRedeclaration$5(e,t);t.set(e,i)}function _checkPrivateRedeclaration$5(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$2(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var _entityId$1=new WeakMap;var _container=new WeakMap;var _menuButton=new WeakMap;var _label=new WeakMap;var _converter=new WeakMap;var _menuId=new WeakMap;var _isAutoConversionEnabled=new WeakMap;var _initUI=new WeakSet;var _bindEvents=new WeakSet;var _handleContainerClick=new WeakSet;var _handleMenuButtonClick=new WeakSet;var _showMenu=new WeakSet;var _closeMenu=new WeakSet;var _getMenuItems=new WeakSet;var _handleItemClick=new WeakSet;var SchemeSelector=function(){function e(t,i){babelHelpers.classCallCheck(this,e);_classPrivateMethodInitSpec$2(this,_handleItemClick);_classPrivateMethodInitSpec$2(this,_getMenuItems);_classPrivateMethodInitSpec$2(this,_closeMenu);_classPrivateMethodInitSpec$2(this,_showMenu);_classPrivateMethodInitSpec$2(this,_handleMenuButtonClick);_classPrivateMethodInitSpec$2(this,_handleContainerClick);_classPrivateMethodInitSpec$2(this,_bindEvents);_classPrivateMethodInitSpec$2(this,_initUI);_classPrivateFieldInitSpec$5(this,_entityId$1,{writable:true,value:void 0});_classPrivateFieldInitSpec$5(this,_container,{writable:true,value:void 0});_classPrivateFieldInitSpec$5(this,_menuButton,{writable:true,value:void 0});_classPrivateFieldInitSpec$5(this,_label,{writable:true,value:void 0});_classPrivateFieldInitSpec$5(this,_converter,{writable:true,value:void 0});_classPrivateFieldInitSpec$5(this,_menuId,{writable:true,value:void 0});_classPrivateFieldInitSpec$5(this,_isAutoConversionEnabled,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,_converter,t);babelHelpers.classPrivateFieldSet(this,_entityId$1,Number(i.entityId));babelHelpers.classPrivateFieldSet(this,_container,document.getElementById(i.containerId));babelHelpers.classPrivateFieldSet(this,_menuButton,document.getElementById(i.buttonId));babelHelpers.classPrivateFieldSet(this,_label,document.getElementById(i.labelId));babelHelpers.classPrivateFieldSet(this,_menuId,"crm_conversion_scheme_selector_"+babelHelpers.classPrivateFieldGet(this,_entityId$1)+"_"+main_core.Text.getRandom());babelHelpers.classPrivateFieldSet(this,_isAutoConversionEnabled,false);if(!babelHelpers.classPrivateFieldGet(this,_entityId$1)||!babelHelpers.classPrivateFieldGet(this,_container)||!babelHelpers.classPrivateFieldGet(this,_menuButton)||!babelHelpers.classPrivateFieldGet(this,_label)||!babelHelpers.classPrivateFieldGet(this,_converter)){console.error("Error SchemeSelector initializing",this)}else{_classPrivateMethodGet$2(this,_initUI,_initUI2).call(this);_classPrivateMethodGet$2(this,_bindEvents,_bindEvents2).call(this)}main_core_events.EventEmitter.makeObservable(this,"BX.Crm.Conversion")}babelHelpers.createClass(e,[{key:"enableAutoConversion",value:function e(){babelHelpers.classPrivateFieldSet(this,_isAutoConversionEnabled,true)}},{key:"disableAutoConversion",value:function e(){babelHelpers.classPrivateFieldSet(this,_isAutoConversionEnabled,false)}}]);return e}();function _initUI2(){var e=babelHelpers.classPrivateFieldGet(this,_converter).getConfig().getScheme().getCurrentItem();if(e){babelHelpers.classPrivateFieldGet(this,_label).innerText=e.getPhrase()}}function _bindEvents2(){main_core.Event.bind(babelHelpers.classPrivateFieldGet(this,_container),"click",_classPrivateMethodGet$2(this,_handleContainerClick,_handleContainerClick2).bind(this));main_core.Event.bind(babelHelpers.classPrivateFieldGet(this,_menuButton),"click",_classPrivateMethodGet$2(this,_handleMenuButtonClick,_handleMenuButtonClick2).bind(this))}function _handleContainerClick2(){var e=new main_core_events.BaseEvent({data:{isCanceled:false}});this.emit("SchemeSelector:onContainerClick",e);babelHelpers.classPrivateFieldGet(this,_converter).getConfig().updateFromSchemeItem();if(babelHelpers.classPrivateFieldGet(this,_isAutoConversionEnabled)&&!e.getData().isCanceled){babelHelpers.classPrivateFieldGet(this,_converter).convert(babelHelpers.classPrivateFieldGet(this,_entityId$1))}}function _handleMenuButtonClick2(){_classPrivateMethodGet$2(this,_showMenu,_showMenu2).call(this)}function _showMenu2(){var e=BX.pos(babelHelpers.classPrivateFieldGet(this,_container));main_popup.MenuManager.show({id:babelHelpers.classPrivateFieldGet(this,_menuId),bindElement:babelHelpers.classPrivateFieldGet(this,_menuButton),items:_classPrivateMethodGet$2(this,_getMenuItems,_getMenuItems2).call(this),closeByEsc:true,cacheable:false,offsetLeft:-e["width"]})}function _closeMenu2(){main_popup.MenuManager.destroy(babelHelpers.classPrivateFieldGet(this,_menuId))}function _getMenuItems2(){var e=this;var t=[];babelHelpers.classPrivateFieldGet(this,_converter).getConfig().getScheme().getItems().forEach((function(i){t.push({text:main_core.Text.encode(i.getPhrase()),onclick:function t(){_classPrivateMethodGet$2(e,_handleItemClick,_handleItemClick2).call(e,i)}})}));return t}function _handleItemClick2(e){_classPrivateMethodGet$2(this,_closeMenu,_closeMenu2).call(this);babelHelpers.classPrivateFieldGet(this,_label).innerText=e.getPhrase();babelHelpers.classPrivateFieldGet(this,_converter).getConfig().updateFromSchemeItem(e);var t=new main_core_events.BaseEvent({data:{isCanceled:false}});this.emit("SchemeSelector:onSchemeSelected",t);if(babelHelpers.classPrivateFieldGet(this,_isAutoConversionEnabled)&&!t.getData().isCanceled){babelHelpers.classPrivateFieldGet(this,_converter).convert(babelHelpers.classPrivateFieldGet(this,_entityId$1))}}function _classPrivateFieldInitSpec$6(e,t,i){_checkPrivateRedeclaration$6(e,t);t.set(e,i)}function _checkPrivateRedeclaration$6(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var instance=null;var _converters=new WeakMap;var Manager=function(){function e(){babelHelpers.classCallCheck(this,e);_classPrivateFieldInitSpec$6(this,_converters,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,_converters,{})}babelHelpers.createClass(e,[{key:"initializeConverter",value:function e(t,i){var a=Config.create(t,i.configItems,Scheme.create(i.scheme));babelHelpers.classPrivateFieldGet(this,_converters)[t]=new Converter(t,a,i.params);return babelHelpers.classPrivateFieldGet(this,_converters)[t]}},{key:"getConverter",value:function e(t){return babelHelpers.classPrivateFieldGet(this,_converters)[t]||null}}],[{key:"Instance",get:function t(){if(window.top!==window&&main_core.Reflection.getClass("top.BX.Crm.Conversion.Manager")){return window.top.BX.Crm.Conversion.Manager.Instance}if(instance===null){instance=new e}return instance}}]);return e}();var Conversion={Scheme:Scheme,Config:Config,Converter:Converter,Manager:Manager,SchemeSelector:SchemeSelector};exports.Conversion=Conversion})(this.BX.Crm=this.BX.Crm||{},BX.Crm,BX.Crm.Models,BX.Event,BX.Main,BX.UI,BX.UI.Dialogs,BX,BX);
//# sourceMappingURL=conversion.bundle.map.js