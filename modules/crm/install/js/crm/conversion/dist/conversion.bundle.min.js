this.BX=this.BX||{};(function(exports,crm_integration_analytics,ui_analytics,ui_dialogs_messagebox,ui_forms,crm_categoryModel,ui_buttons,ui_entitySelector,main_core,main_core_events,main_popup){"use strict";var _active=babelHelpers.classPrivateFieldLooseKey("active");var _enableSync=babelHelpers.classPrivateFieldLooseKey("enableSync");var _initData=babelHelpers.classPrivateFieldLooseKey("initData");var _entityTypeId=babelHelpers.classPrivateFieldLooseKey("entityTypeId");var _title=babelHelpers.classPrivateFieldLooseKey("title");var _internalizeBooleanValue=babelHelpers.classPrivateFieldLooseKey("internalizeBooleanValue");class ConfigItem{constructor(e){Object.defineProperty(this,_internalizeBooleanValue,{value:_internalizeBooleanValue2});Object.defineProperty(this,_active,{writable:true,value:void 0});Object.defineProperty(this,_enableSync,{writable:true,value:void 0});Object.defineProperty(this,_initData,{writable:true,value:{}});Object.defineProperty(this,_entityTypeId,{writable:true,value:void 0});Object.defineProperty(this,_title,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,_entityTypeId)[_entityTypeId]=Number(e.entityTypeId);babelHelpers.classPrivateFieldLooseBase(this,_active)[_active]=babelHelpers.classPrivateFieldLooseBase(this,_internalizeBooleanValue)[_internalizeBooleanValue](e.active);babelHelpers.classPrivateFieldLooseBase(this,_enableSync)[_enableSync]=babelHelpers.classPrivateFieldLooseBase(this,_internalizeBooleanValue)[_internalizeBooleanValue](e.enableSync);if(main_core.Type.isPlainObject(e.initData)){babelHelpers.classPrivateFieldLooseBase(this,_initData)[_initData]=e.initData}babelHelpers.classPrivateFieldLooseBase(this,_title)[_title]=String(e.title)}externalize(){return{entityTypeId:this.getEntityTypeId(),title:this.getTitle(),initData:this.getInitData(),active:this.isActive()?"Y":"N",enableSync:this.isEnableSync()?"Y":"N"}}isActive(){return babelHelpers.classPrivateFieldLooseBase(this,_active)[_active]}setActive(e){babelHelpers.classPrivateFieldLooseBase(this,_active)[_active]=e;return this}isEnableSync(){return babelHelpers.classPrivateFieldLooseBase(this,_enableSync)[_enableSync]}setEnableSync(e){babelHelpers.classPrivateFieldLooseBase(this,_enableSync)[_enableSync]=e;return this}getInitData(){return babelHelpers.classPrivateFieldLooseBase(this,_initData)[_initData]||{}}setInitData(e){babelHelpers.classPrivateFieldLooseBase(this,_initData)[_initData]=e;return this}getEntityTypeId(){return babelHelpers.classPrivateFieldLooseBase(this,_entityTypeId)[_entityTypeId]}getTitle(){return babelHelpers.classPrivateFieldLooseBase(this,_title)[_title]}setTitle(e){babelHelpers.classPrivateFieldLooseBase(this,_title)[_title]=e;return this}}function _internalizeBooleanValue2(e){if(main_core.Type.isBoolean(e)){return e}if(main_core.Type.isString(e)){return e==="Y"}return Boolean(e)}var _id=babelHelpers.classPrivateFieldLooseKey("id");var _name=babelHelpers.classPrivateFieldLooseKey("name");var _entityTypeIds=babelHelpers.classPrivateFieldLooseKey("entityTypeIds");var _phrase=babelHelpers.classPrivateFieldLooseKey("phrase");var _availabilityLock=babelHelpers.classPrivateFieldLooseKey("availabilityLock");class SchemeItem{constructor(e){Object.defineProperty(this,_id,{writable:true,value:void 0});Object.defineProperty(this,_name,{writable:true,value:void 0});Object.defineProperty(this,_entityTypeIds,{writable:true,value:void 0});Object.defineProperty(this,_phrase,{writable:true,value:void 0});Object.defineProperty(this,_availabilityLock,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,_id)[_id]=String(e.id);babelHelpers.classPrivateFieldLooseBase(this,_name)[_name]=String(e.name);babelHelpers.classPrivateFieldLooseBase(this,_phrase)[_phrase]=String(e.phrase);babelHelpers.classPrivateFieldLooseBase(this,_availabilityLock)[_availabilityLock]=String(e.availabilityLock);babelHelpers.classPrivateFieldLooseBase(this,_entityTypeIds)[_entityTypeIds]=[];if(main_core.Type.isArray(e.entityTypeIds)){e.entityTypeIds.forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,_entityTypeIds)[_entityTypeIds].push(Number(e))}))}}getId(){return babelHelpers.classPrivateFieldLooseBase(this,_id)[_id]}getName(){return babelHelpers.classPrivateFieldLooseBase(this,_name)[_name]}getEntityTypeIds(){return babelHelpers.classPrivateFieldLooseBase(this,_entityTypeIds)[_entityTypeIds]}getPhrase(){return babelHelpers.classPrivateFieldLooseBase(this,_phrase)[_phrase]}getAvailabilityLock(){return babelHelpers.classPrivateFieldLooseBase(this,_availabilityLock)[_availabilityLock]}}var _currentItemId=babelHelpers.classPrivateFieldLooseKey("currentItemId");var _items=babelHelpers.classPrivateFieldLooseKey("items");class Scheme{constructor(e,t){Object.defineProperty(this,_currentItemId,{writable:true,value:void 0});Object.defineProperty(this,_items,{writable:true,value:[]});babelHelpers.classPrivateFieldLooseBase(this,_currentItemId)[_currentItemId]=main_core.Type.isNull(e)?e:String(e);if(main_core.Type.isArray(t)){t.forEach((e=>{if(e instanceof SchemeItem){babelHelpers.classPrivateFieldLooseBase(this,_items)[_items].push(e)}else{console.error(`SchemeItem is invalid in Scheme constructor. Expected instance of SchemeItem, got ${typeof e}`)}}))}}static create(e){const t=[];e.items.forEach((e=>{t.push(new SchemeItem(e))}));return new Scheme(e.currentItemId,t)}getCurrentItem(){if(!babelHelpers.classPrivateFieldLooseBase(this,_items)[_items]||babelHelpers.classPrivateFieldLooseBase(this,_items)[_items].length===0){return null}const e=this.getItemById(babelHelpers.classPrivateFieldLooseBase(this,_currentItemId)[_currentItemId]);return e||babelHelpers.classPrivateFieldLooseBase(this,_items)[_items][0]}setCurrentItemId(e){babelHelpers.classPrivateFieldLooseBase(this,_currentItemId)[_currentItemId]=e}getItems(){return babelHelpers.classPrivateFieldLooseBase(this,_items)[_items]}getItemById(e){for(const t of babelHelpers.classPrivateFieldLooseBase(this,_items)[_items]){if(t.getId()===e){return t}}return null}getItemForSingleEntityTypeId(e){for(const t of babelHelpers.classPrivateFieldLooseBase(this,_items)[_items]){const s=t.getEntityTypeIds();if(s.length===1&&[...s][0]===e){return t}}return null}getItemForEntityTypeIds(e){const t=e=>new Set(e.map((e=>main_core.Text.toInteger(e))));const s=[...t(e)];for(const e of babelHelpers.classPrivateFieldLooseBase(this,_items)[_items]){const i=t(e.getEntityTypeIds());if(s.length!==i.size){continue}const a=s.filter((e=>!i.has(e)));if(a.length<=0){return e}}return null}getAllEntityTypeIds(){const e=new Set;for(const t of babelHelpers.classPrivateFieldLooseBase(this,_items)[_items]){for(const s of t.getEntityTypeIds()){e.add(s)}}return[...e]}}var _entityTypeId$1=babelHelpers.classPrivateFieldLooseKey("entityTypeId");var _items$1=babelHelpers.classPrivateFieldLooseKey("items");var _scheme=babelHelpers.classPrivateFieldLooseKey("scheme");class Config{constructor(e,t,s){Object.defineProperty(this,_entityTypeId$1,{writable:true,value:void 0});Object.defineProperty(this,_items$1,{writable:true,value:[]});Object.defineProperty(this,_scheme,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,_entityTypeId$1)[_entityTypeId$1]=Number(e);if(main_core.Type.isArray(t)){t.forEach((e=>{if(e instanceof ConfigItem){babelHelpers.classPrivateFieldLooseBase(this,_items$1)[_items$1].push(e)}else{console.error(`ConfigItem is invalid in Config constructor. Expected instance of ConfigItem, got ${typeof e}`)}}))}if(s instanceof Scheme){babelHelpers.classPrivateFieldLooseBase(this,_scheme)[_scheme]=s}else{console.error(`Scheme is invalid in Config constructor. Expected instance of Scheme, got ${typeof s}`)}}static create(e,t,s){const i=[];t.forEach((e=>{i.push(new ConfigItem(e))}));return new Config(e,i,s)}getEntityTypeId(){return babelHelpers.classPrivateFieldLooseBase(this,_entityTypeId$1)[_entityTypeId$1]}getItems(){return babelHelpers.classPrivateFieldLooseBase(this,_items$1)[_items$1]}getActiveItems(){return babelHelpers.classPrivateFieldLooseBase(this,_items$1)[_items$1].filter((e=>e.isActive()))}getScheme(){return babelHelpers.classPrivateFieldLooseBase(this,_scheme)[_scheme]}updateFromSchemeItem(e=null){let t=null;if(e){t=e;this.getScheme().setCurrentItemId(e.getId())}else{t=this.getScheme().getCurrentItem()}const s=t.getEntityTypeIds();babelHelpers.classPrivateFieldLooseBase(this,_items$1)[_items$1].forEach((e=>{const t=s.includes(e.getEntityTypeId());e.setEnableSync(t);e.setActive(t)}));return this}getItemByEntityTypeId(e){for(const t of babelHelpers.classPrivateFieldLooseBase(this,_items$1)[_items$1]){if(t.getEntityTypeId()===e){return t}}return null}externalize(){const e={};this.getItems().forEach((t=>{e[BX.CrmEntityType.resolveName(t.getEntityTypeId()).toLowerCase()]=t.externalize()}));return e}updateItems(e){babelHelpers.classPrivateFieldLooseBase(this,_items$1)[_items$1]=[];e.forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,_items$1)[_items$1].push(new ConfigItem(e))}));return this}}let instance=null;var _extensionSettings=babelHelpers.classPrivateFieldLooseKey("extensionSettings");var _storage=babelHelpers.classPrivateFieldLooseKey("storage");class CategoryRepository{constructor(){Object.defineProperty(this,_extensionSettings,{writable:true,value:main_core.Extension.getSettings("crm.conversion")});Object.defineProperty(this,_storage,{writable:true,value:new Map})}static get Instance(){if(instance===null){instance=new CategoryRepository}return instance}isCategoriesEnabled(e){return Boolean(babelHelpers.classPrivateFieldLooseBase(this,_extensionSettings)[_extensionSettings].get(`isCategoriesEnabled.${e}`,false))}getCategories(e){if(babelHelpers.classPrivateFieldLooseBase(this,_storage)[_storage].has(e)){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,_storage)[_storage].get(e))}return main_core.ajax.runAction("crm.conversion.getDstCategoryList",{data:{entityTypeId:e}}).then((({data:t})=>{var s;const i=[];t==null?void 0:(s=t.categories)==null?void 0:s.forEach((e=>{i.push(new crm_categoryModel.CategoryModel(e))}));babelHelpers.classPrivateFieldLooseBase(this,_storage)[_storage].set(e,i);return i}))}}let _=e=>e,_t,_t2;const REQUIRED_FIELDS_INFOHELPER_CODE=8233923;var _entityTypeId$2=babelHelpers.classPrivateFieldLooseKey("entityTypeId");var _entityId=babelHelpers.classPrivateFieldLooseKey("entityId");var _config=babelHelpers.classPrivateFieldLooseKey("config");var _params=babelHelpers.classPrivateFieldLooseKey("params");var _isProgress=babelHelpers.classPrivateFieldLooseKey("isProgress");var _isSynchronisationAllowed=babelHelpers.classPrivateFieldLooseKey("isSynchronisationAllowed");var _fieldsSynchronizer=babelHelpers.classPrivateFieldLooseKey("fieldsSynchronizer");var _data=babelHelpers.classPrivateFieldLooseKey("data");var _request=babelHelpers.classPrivateFieldLooseKey("request");var _sendAnalyticsData=babelHelpers.classPrivateFieldLooseKey("sendAnalyticsData");var _filterExternalAnalytics=babelHelpers.classPrivateFieldLooseKey("filterExternalAnalytics");var _onRequestSuccess=babelHelpers.classPrivateFieldLooseKey("onRequestSuccess");var _collectAdditionalData=babelHelpers.classPrivateFieldLooseKey("collectAdditionalData");var _getCategoryForEntityTypeId=babelHelpers.classPrivateFieldLooseKey("getCategoryForEntityTypeId");var _isNeedToLoadCategories=babelHelpers.classPrivateFieldLooseKey("isNeedToLoadCategories");var _showCategorySelector=babelHelpers.classPrivateFieldLooseKey("showCategorySelector");var _processRequiredAction=babelHelpers.classPrivateFieldLooseKey("processRequiredAction");var _synchronizeFields=babelHelpers.classPrivateFieldLooseKey("synchronizeFields");var _getFieldsSynchronizer=babelHelpers.classPrivateFieldLooseKey("getFieldsSynchronizer");var _askToFillRequiredFields=babelHelpers.classPrivateFieldLooseKey("askToFillRequiredFields");var _getMessage=babelHelpers.classPrivateFieldLooseKey("getMessage");var _emitConvertedEvent=babelHelpers.classPrivateFieldLooseKey("emitConvertedEvent");class Converter{constructor(e,t,s){Object.defineProperty(this,_emitConvertedEvent,{value:_emitConvertedEvent2});Object.defineProperty(this,_getMessage,{value:_getMessage2});Object.defineProperty(this,_askToFillRequiredFields,{value:_askToFillRequiredFields2});Object.defineProperty(this,_getFieldsSynchronizer,{value:_getFieldsSynchronizer2});Object.defineProperty(this,_synchronizeFields,{value:_synchronizeFields2});Object.defineProperty(this,_processRequiredAction,{value:_processRequiredAction2});Object.defineProperty(this,_showCategorySelector,{value:_showCategorySelector2});Object.defineProperty(this,_isNeedToLoadCategories,{value:_isNeedToLoadCategories2});Object.defineProperty(this,_getCategoryForEntityTypeId,{value:_getCategoryForEntityTypeId2});Object.defineProperty(this,_collectAdditionalData,{value:_collectAdditionalData2});Object.defineProperty(this,_onRequestSuccess,{value:_onRequestSuccess2});Object.defineProperty(this,_filterExternalAnalytics,{value:_filterExternalAnalytics2});Object.defineProperty(this,_sendAnalyticsData,{value:_sendAnalyticsData2});Object.defineProperty(this,_request,{value:_request2});Object.defineProperty(this,_entityTypeId$2,{writable:true,value:void 0});Object.defineProperty(this,_entityId,{writable:true,value:void 0});Object.defineProperty(this,_config,{writable:true,value:void 0});Object.defineProperty(this,_params,{writable:true,value:void 0});Object.defineProperty(this,_isProgress,{writable:true,value:void 0});Object.defineProperty(this,_isSynchronisationAllowed,{writable:true,value:void 0});Object.defineProperty(this,_fieldsSynchronizer,{writable:true,value:void 0});Object.defineProperty(this,_data,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,_entityTypeId$2)[_entityTypeId$2]=Number(e);if(t instanceof Config){babelHelpers.classPrivateFieldLooseBase(this,_config)[_config]=t}else{console.error("Config is invalid in Converter constructor. Expected instance of Config",t,this)}babelHelpers.classPrivateFieldLooseBase(this,_params)[_params]=s!=null?s:{};babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].id=main_core.Type.isStringFilled(babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].id)?babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].id:main_core.Text.getRandom();babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].analytics=babelHelpers.classPrivateFieldLooseBase(this,_filterExternalAnalytics)[_filterExternalAnalytics](babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].analytics);babelHelpers.classPrivateFieldLooseBase(this,_isProgress)[_isProgress]=false;babelHelpers.classPrivateFieldLooseBase(this,_isSynchronisationAllowed)[_isSynchronisationAllowed]=false;babelHelpers.classPrivateFieldLooseBase(this,_entityId)[_entityId]=0}getEntityTypeId(){return babelHelpers.classPrivateFieldLooseBase(this,_entityTypeId$2)[_entityTypeId$2]}getConfig(){return babelHelpers.classPrivateFieldLooseBase(this,_config)[_config]}getId(){return babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].id}getServiceUrl(){const e=babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].serviceUrl;if(!e){return null}const t={action:"convert"};this.getConfig().getItems().forEach((e=>{t[BX.CrmEntityType.resolveName(e.getEntityTypeId()).toLowerCase()]=e.isActive()?"Y":"N"}));return BX.util.add_url_param(e,t)}getOriginUrl(){if(babelHelpers.classPrivateFieldLooseBase(this,_params)[_params]&&"originUrl"in babelHelpers.classPrivateFieldLooseBase(this,_params)[_params]){return String(babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].originUrl)}return null}isRedirectToDetailPageEnabled(){if(babelHelpers.classPrivateFieldLooseBase(this,_params)[_params]&&"isRedirectToDetailPageEnabled"in babelHelpers.classPrivateFieldLooseBase(this,_params)[_params]){return babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].isRedirectToDetailPageEnabled}return true}setAnalyticsElement(e){const t=babelHelpers.classPrivateFieldLooseBase(this,_filterExternalAnalytics)[_filterExternalAnalytics]({c_element:e});if("c_element"in t){babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].analytics.c_element=t.c_element}return this}convertBySchemeItemId(e,t,s){const i=babelHelpers.classPrivateFieldLooseBase(this,_config)[_config].getScheme().getItemById(e);if(!i){console.error("Scheme is not found",e,this);return}babelHelpers.classPrivateFieldLooseBase(this,_config)[_config].updateFromSchemeItem(i);this.convert(t,s)}convert(entityId,data){babelHelpers.classPrivateFieldLooseBase(this,_entityId)[_entityId]=entityId;babelHelpers.classPrivateFieldLooseBase(this,_data)[_data]=data;const schemeItem=babelHelpers.classPrivateFieldLooseBase(this,_config)[_config].getScheme().getCurrentItem();if(!schemeItem){console.error("Scheme is not found",this);return}if(main_core.Type.isStringFilled(schemeItem.getAvailabilityLock())){eval(schemeItem.getAvailabilityLock());return}babelHelpers.classPrivateFieldLooseBase(this,_config)[_config].getActiveItems().forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,_sendAnalyticsData)[_sendAnalyticsData](e.getEntityTypeId(),crm_integration_analytics.Dictionary.STATUS_ATTEMPT)}));babelHelpers.classPrivateFieldLooseBase(this,_collectAdditionalData)[_collectAdditionalData](schemeItem).then((e=>{if(e.isCanceled){return e}return babelHelpers.classPrivateFieldLooseBase(this,_request)[_request]()})).then((e=>{if(!e.isFinished){return}const t=e.isCanceled?crm_integration_analytics.Dictionary.STATUS_CANCEL:crm_integration_analytics.Dictionary.STATUS_SUCCESS;babelHelpers.classPrivateFieldLooseBase(this,_config)[_config].getActiveItems().forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,_sendAnalyticsData)[_sendAnalyticsData](e.getEntityTypeId(),t)}))})).catch((e=>{if(e){console.log("Convert error",e,this)}babelHelpers.classPrivateFieldLooseBase(this,_config)[_config].getActiveItems().forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,_sendAnalyticsData)[_sendAnalyticsData](e.getEntityTypeId(),crm_integration_analytics.Dictionary.STATUS_ERROR)}))}))}getMessagePublic(e){return babelHelpers.classPrivateFieldLooseBase(this,_getMessage)[_getMessage](e)}}function _request2(){const e=new Promise(((e,t)=>{const s=this.getServiceUrl();if(!s){console.error("Convert endpoint is not specifier");t();return}if(babelHelpers.classPrivateFieldLooseBase(this,_isProgress)[_isProgress]){console.error("Another request is in progress");t();return}babelHelpers.classPrivateFieldLooseBase(this,_isProgress)[_isProgress]=true;main_core.ajax({url:s,method:"POST",dataType:"json",data:{MODE:"CONVERT",ENTITY_ID:babelHelpers.classPrivateFieldLooseBase(this,_entityId)[_entityId],ENABLE_SYNCHRONIZATION:babelHelpers.classPrivateFieldLooseBase(this,_isSynchronisationAllowed)[_isSynchronisationAllowed]?"Y":"N",ENABLE_REDIRECT_TO_SHOW:this.isRedirectToDetailPageEnabled()?"Y":"N",CONFIG:this.getConfig().externalize(),CONTEXT:babelHelpers.classPrivateFieldLooseBase(this,_data)[_data],ORIGIN_URL:this.getOriginUrl()},onsuccess:e,onfailure:t})}));return e.then((e=>{babelHelpers.classPrivateFieldLooseBase(this,_isProgress)[_isProgress]=false;return babelHelpers.classPrivateFieldLooseBase(this,_onRequestSuccess)[_onRequestSuccess](e)})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,_isProgress)[_isProgress]=false;if(main_core.Type.isStringFilled(e)){ui_dialogs_messagebox.MessageBox.alert(main_core.Text.encode(e))}throw e}))}function _sendAnalyticsData2(e,t){const s=crm_integration_analytics.Builder.Entity.ConvertEvent.createDefault(babelHelpers.classPrivateFieldLooseBase(this,_entityTypeId$2)[_entityTypeId$2],e).setSection(babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].analytics.c_section).setSubSection(babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].analytics.c_sub_section).setElement(babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].analytics.c_element).setStatus(t);ui_analytics.sendData(s.buildData())}function _filterExternalAnalytics2(e){if(!main_core.Type.isPlainObject(e)){return{}}const t=new Set(["c_section","c_sub_section","c_element"]);const s={};for(const[i,a]of Object.entries(e)){if(t.has(i)&&main_core.Type.isStringFilled(a)){s[i]=a}}return s}function _onRequestSuccess2(e){return new Promise(((t,s)=>{if(e.ERROR){var i;s(((i=e.ERROR)==null?void 0:i.MESSAGE)||e.ERROR||"Error during conversion");return}if(main_core.Type.isPlainObject(e.REQUIRED_ACTION)){t(babelHelpers.classPrivateFieldLooseBase(this,_processRequiredAction)[_processRequiredAction](e.REQUIRED_ACTION));return}const a=main_core.Type.isPlainObject(e.DATA)?e.DATA:{};if(!a){s();return}const r={isCanceled:false,isFinished:true};const l=main_core.Type.isString(a.URL)?a.URL:"";if(a.IS_FINISHED==="Y"){babelHelpers.classPrivateFieldLooseBase(this,_data)[_data]={};const e=babelHelpers.classPrivateFieldLooseBase(this,_emitConvertedEvent)[_emitConvertedEvent](l);if(e){t(r);return}}else{r.isFinished=false}if(l){const e=new main_core.Uri(l);const t=e.getQueryParam("st")||{};e.setQueryParam("st",{...babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].analytics,...t});BX.Crm.Page.open(e.toString())}else if(window.top!==window);t(r)}))}function _collectAdditionalData2(e){const t=this.getConfig();const s=[];e.getEntityTypeIds().forEach((e=>{s.push((()=>babelHelpers.classPrivateFieldLooseBase(this,_getCategoryForEntityTypeId)[_getCategoryForEntityTypeId](e)))}));const i={isCanceled:false,isFinished:true};const a=(e,s=0)=>new Promise(((r,l)=>{if(i.isCanceled||!e[s]){r(i);return}e[s]().then((o=>{if(o.isCanceled){i.isCanceled=true}else if(o.category){const e=o.category.getEntityTypeId();const s=t.getItemByEntityTypeId(e);if(!s){console.error(`Scheme is not correct: configItem is not found for ${e}`,this);l();return}const i=s.getInitData();i.categoryId=o.category.getId();s.setInitData(i)}r(a(e,s+1))})).catch(l)}));return a(s)}function _getCategoryForEntityTypeId2(e){return new Promise(((t,s)=>{const i=this.getConfig().getItemByEntityTypeId(e);if(!i){console.error(`Scheme is not correct: configItem is not found for ${e}`,this);s();return}if(babelHelpers.classPrivateFieldLooseBase(this,_isNeedToLoadCategories)[_isNeedToLoadCategories](e)){CategoryRepository.Instance.getCategories(e).then((e=>{if(e.length>1){t(babelHelpers.classPrivateFieldLooseBase(this,_showCategorySelector)[_showCategorySelector](e,i.getTitle()))}else{t({isCanceled:false,category:e[0]})}})).catch(s)}else{t({isCanceled:false,category:null})}}))}function _isNeedToLoadCategories2(e){return CategoryRepository.Instance.isCategoriesEnabled(e)}function _showCategorySelector2(e,t){return new Promise((s=>{const i=main_core.Tag.render(_t||(_t=_`
				<div class="crm-converter-category-selector ui-form ui-form-line">
					<div class="ui-form-row">
						<div class="crm-converter-category-selector-label ui-form-label">
							<div class="ui-ctl-label-text">${0}</div>
						</div>
						<div class="ui-form-content">
							<div class="crm-converter-category-selector-select ui-ctl ui-ctl-after-icon ui-ctl-dropdown">
								<div class="ui-ctl-after ui-ctl-icon-angle"></div>
								<select class="ui-ctl-element"></select>
							</div>
						</div>
					</div>
				</div>
			`),main_core.Loc.getMessage("CRM_COMMON_CATEGORY"));const a=i.querySelector("select");e.forEach((e=>{main_core.Dom.append(main_core.Tag.render(_t2||(_t2=_`<option value="${0}">${0}</option>`),e.getId(),main_core.Text.encode(e.getName())),a)}));const r=new main_popup.Popup({titleBar:main_core.Loc.getMessage("CRM_CONVERSION_CATEGORY_SELECTOR_TITLE",{"#ENTITY#":main_core.Text.encode(t)}),content:i,closeByEsc:true,closeIcon:true,buttons:[new ui_buttons.Button({text:main_core.Loc.getMessage("CRM_COMMON_ACTION_SAVE"),color:ui_buttons.ButtonColor.SUCCESS,onclick:()=>{const t=[...a.selectedOptions][0].value;r.destroy();for(const i of e){if(i.getId()===Number(t)){s({category:i});return true}}console.error("Selected category not found",t,e);s({isCanceled:true});return true}}),new ui_buttons.Button({text:main_core.Loc.getMessage("CRM_COMMON_ACTION_CANCEL"),color:ui_buttons.ButtonColor.LIGHT,onclick:()=>{r.destroy();s({isCanceled:true});return true}})],events:{onClose:()=>{s({isCanceled:true})}}});r.show()}))}function _processRequiredAction2(e){const t=String(e.NAME);const s=main_core.Type.isPlainObject(e.DATA)?e.DATA:{};if(t==="SYNCHRONIZE"){let e=null;if(main_core.Type.isArray(s.CONFIG)){e=s.CONFIG}else if(main_core.Type.isPlainObject(s.CONFIG)){e=Object.values(s.CONFIG)}if(e){babelHelpers.classPrivateFieldLooseBase(this,_config)[_config].updateItems(e)}return babelHelpers.classPrivateFieldLooseBase(this,_synchronizeFields)[_synchronizeFields](main_core.Type.isArray(s.FIELD_NAMES)?s.FIELD_NAMES:[])}if(t==="CORRECT"&&main_core.Type.isPlainObject(s.CHECK_ERRORS)){return babelHelpers.classPrivateFieldLooseBase(this,_askToFillRequiredFields)[_askToFillRequiredFields](s)}return Promise.resolve({isCanceled:false,isFinished:true})}function _synchronizeFields2(e){const t=babelHelpers.classPrivateFieldLooseBase(this,_getFieldsSynchronizer)[_getFieldsSynchronizer](e);return new Promise((e=>{const s=(i,a)=>{const r=main_core.Type.isBoolean(a.isCanceled)&&a.isCanceled===true;if(r){t.removeClosingListener(s);e({isCanceled:true,isFinished:true});return}babelHelpers.classPrivateFieldLooseBase(this,_isSynchronisationAllowed)[_isSynchronisationAllowed]=true;babelHelpers.classPrivateFieldLooseBase(this,_config)[_config].updateItems(Object.values(babelHelpers.classPrivateFieldLooseBase(this,_fieldsSynchronizer)[_fieldsSynchronizer].getConfig()));t.removeClosingListener(s);e(babelHelpers.classPrivateFieldLooseBase(this,_request)[_request]())};t.addClosingListener(s);t.show()}))}function _getFieldsSynchronizer2(e){if(!babelHelpers.classPrivateFieldLooseBase(this,_fieldsSynchronizer)[_fieldsSynchronizer]){babelHelpers.classPrivateFieldLooseBase(this,_fieldsSynchronizer)[_fieldsSynchronizer]=BX.CrmEntityFieldSynchronizationEditor.create(`crm_converter_fields_synchronizer_${this.getEntityTypeId()}`,{config:babelHelpers.classPrivateFieldLooseBase(this,_config)[_config].externalize(),title:babelHelpers.classPrivateFieldLooseBase(this,_getMessage)[_getMessage]("dialogTitle"),fieldNames:e,legend:babelHelpers.classPrivateFieldLooseBase(this,_getMessage)[_getMessage]("syncEditorLegend"),fieldListTitle:babelHelpers.classPrivateFieldLooseBase(this,_getMessage)[_getMessage]("syncEditorFieldListTitle"),entityListTitle:babelHelpers.classPrivateFieldLooseBase(this,_getMessage)[_getMessage]("syncEditorEntityListTitle"),continueButton:babelHelpers.classPrivateFieldLooseBase(this,_getMessage)[_getMessage]("continueButton"),cancelButton:babelHelpers.classPrivateFieldLooseBase(this,_getMessage)[_getMessage]("cancelButton")})}babelHelpers.classPrivateFieldLooseBase(this,_fieldsSynchronizer)[_fieldsSynchronizer].setConfig(babelHelpers.classPrivateFieldLooseBase(this,_config)[_config].externalize());babelHelpers.classPrivateFieldLooseBase(this,_fieldsSynchronizer)[_fieldsSynchronizer].setFieldNames(e);return babelHelpers.classPrivateFieldLooseBase(this,_fieldsSynchronizer)[_fieldsSynchronizer]}function _askToFillRequiredFields2(e){BX.Crm.PartialEditorDialog.close("entity-converter-editor");const t=BX.Crm.PartialEditorDialog.create("entity-converter-editor",{title:main_core.Loc.getMessage("CRM_CONVERSION_REQUIRED_FIELDS_POPUP_TITLE"),entityTypeId:babelHelpers.classPrivateFieldLooseBase(this,_entityTypeId$2)[_entityTypeId$2],entityId:babelHelpers.classPrivateFieldLooseBase(this,_entityId)[_entityId],fieldNames:Object.keys(e.CHECK_ERRORS),helpData:{text:main_core.Loc.getMessage("CRM_CONVERSION_MORE_ABOUT_REQUIRED_FIELDS"),code:REQUIRED_FIELDS_INFOHELPER_CODE},context:e.CONTEXT});return new Promise((e=>{const s=(t,i)=>{if(babelHelpers.classPrivateFieldLooseBase(this,_entityTypeId$2)[_entityTypeId$2]!==(i==null?void 0:i.entityTypeId)||babelHelpers.classPrivateFieldLooseBase(this,_entityId)[_entityId]!==(i==null?void 0:i.entityId)){return}BX.removeCustomEvent(window,"Crm.PartialEditorDialog.Close",s);const a=main_core.Type.isBoolean(i.isCancelled)?i.isCancelled:true;if(a){e({isCanceled:true,isFinished:true})}else{e(babelHelpers.classPrivateFieldLooseBase(this,_request)[_request]())}};BX.addCustomEvent(window,"Crm.PartialEditorDialog.Close",s);t.open()}))}function _getMessage2(e){if(!babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].messages){babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].messages={}}return babelHelpers.classPrivateFieldLooseBase(this,_params)[_params].messages[e]||e}function _emitConvertedEvent2(e){const t=this.getEntityTypeId();const s={entityTypeId:t,entityTypeName:BX.CrmEntityType.resolveName(t),entityId:babelHelpers.classPrivateFieldLooseBase(this,_entityId)[_entityId],redirectUrl:e,isRedirected:false};const i=BX.Crm.Page.getTopSlider();if(i){s.sliderUrl=i.getUrl()}BX.onCustomEvent(window,"Crm.EntityConverter.Converted",[this,s]);BX.localStorage.set("onCrmEntityConvert",s,10);this.getConfig().getActiveItems().forEach((e=>{main_core_events.EventEmitter.emit("Crm.EntityConverter.SingleConverted",{entityTypeName:BX.CrmEntityType.resolveName(e.getEntityTypeId())})}));return s.isRedirected}var _converter=babelHelpers.classPrivateFieldLooseKey("converter");var _entityId$1=babelHelpers.classPrivateFieldLooseKey("entityId");var _dstEntityTypeIds=babelHelpers.classPrivateFieldLooseKey("dstEntityTypeIds");var _target=babelHelpers.classPrivateFieldLooseKey("target");var _dialogProp=babelHelpers.classPrivateFieldLooseKey("dialogProp");var _dialog=babelHelpers.classPrivateFieldLooseKey("dialog");var _convert=babelHelpers.classPrivateFieldLooseKey("convert");var _handleItemSelect=babelHelpers.classPrivateFieldLooseKey("handleItemSelect");var _ensureOnlyOneItemOfEachTypeIsSelected=babelHelpers.classPrivateFieldLooseKey("ensureOnlyOneItemOfEachTypeIsSelected");class EntitySelector{constructor(e,t,s,i=null){Object.defineProperty(this,_handleItemSelect,{value:_handleItemSelect2});Object.defineProperty(this,_convert,{value:_convert2});Object.defineProperty(this,_dialog,{get:_get_dialog,set:void 0});Object.defineProperty(this,_converter,{writable:true,value:void 0});Object.defineProperty(this,_entityId$1,{writable:true,value:void 0});Object.defineProperty(this,_dstEntityTypeIds,{writable:true,value:void 0});Object.defineProperty(this,_target,{writable:true,value:void 0});Object.defineProperty(this,_dialogProp,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,_converter)[_converter]=e;t=main_core.Text.toInteger(t);if(t>0){babelHelpers.classPrivateFieldLooseBase(this,_entityId$1)[_entityId$1]=t}babelHelpers.classPrivateFieldLooseBase(this,_dstEntityTypeIds)[_dstEntityTypeIds]=s.map((e=>main_core.Text.toInteger(e))).filter((e=>BX.CrmEntityType.isDefined(e)));babelHelpers.classPrivateFieldLooseBase(this,_dstEntityTypeIds)[_dstEntityTypeIds].sort();if(main_core.Type.isDomNode(i)||main_core.Type.isNil(i)){babelHelpers.classPrivateFieldLooseBase(this,_target)[_target]=i}if(!babelHelpers.classPrivateFieldLooseBase(this,_converter)[_converter]||!babelHelpers.classPrivateFieldLooseBase(this,_entityId$1)[_entityId$1]||!main_core.Type.isArrayFilled(babelHelpers.classPrivateFieldLooseBase(this,_dstEntityTypeIds)[_dstEntityTypeIds])){console.error("Invalid constructor params:",{converter:e,entityId:t,dstEntityTypeIds:s});throw new Error("Invalid constructor params")}}show(){return new Promise((e=>{babelHelpers.classPrivateFieldLooseBase(this,_dialog)[_dialog].subscribeOnce("onShow",e);babelHelpers.classPrivateFieldLooseBase(this,_dialog)[_dialog].show()}))}hide(){return new Promise((e=>{babelHelpers.classPrivateFieldLooseBase(this,_dialog)[_dialog].subscribeOnce("onHide",e);babelHelpers.classPrivateFieldLooseBase(this,_dialog)[_dialog].hide()}))}destroy(){return new Promise((e=>{babelHelpers.classPrivateFieldLooseBase(this,_dialog)[_dialog].unsubscribe("Item:onSelect",babelHelpers.classPrivateFieldLooseBase(this,_handleItemSelect)[_handleItemSelect].bind(this));babelHelpers.classPrivateFieldLooseBase(this,_dialog)[_dialog].destroy();e()}))}getConverter(){return babelHelpers.classPrivateFieldLooseBase(this,_converter)[_converter]}}function _get_dialog(){if(babelHelpers.classPrivateFieldLooseBase(this,_dialogProp)[_dialogProp]){return babelHelpers.classPrivateFieldLooseBase(this,_dialogProp)[_dialogProp]}const e=new ui_buttons.ApplyButton({color:ui_buttons.ButtonColor.SUCCESS,onclick:()=>{void this.hide();babelHelpers.classPrivateFieldLooseBase(this,_convert)[_convert]()}});const t=new ui_buttons.CancelButton({onclick:()=>{void this.hide()}});babelHelpers.classPrivateFieldLooseBase(this,_dialogProp)[_dialogProp]=new ui_entitySelector.Dialog({targetNode:babelHelpers.classPrivateFieldLooseBase(this,_target)[_target],enableSearch:true,context:`crm.converter.entity-selector.${babelHelpers.classPrivateFieldLooseBase(this,_dstEntityTypeIds)[_dstEntityTypeIds].join("-")}`,entities:babelHelpers.classPrivateFieldLooseBase(this,_dstEntityTypeIds)[_dstEntityTypeIds].map((e=>({id:BX.CrmEntityType.resolveName(e),dynamicLoad:true,dynamicSearch:true,options:{showTab:true,excludeMyCompany:true},searchFields:[{name:"id"}],searchCacheLimits:["^\\d+$"]}))),footer:[e.render(),t.render()],footerOptions:{containerStyles:{display:"flex","justify-content":"center"}},tagSelectorOptions:{textBoxWidth:565}});babelHelpers.classPrivateFieldLooseBase(this,_dialogProp)[_dialogProp].subscribe("Item:onSelect",babelHelpers.classPrivateFieldLooseBase(this,_handleItemSelect)[_handleItemSelect].bind(this));return babelHelpers.classPrivateFieldLooseBase(this,_dialogProp)[_dialogProp]}function _convert2(){const e=new Set;const t={};babelHelpers.classPrivateFieldLooseBase(this,_dialog)[_dialog].getSelectedItems().forEach((s=>{e.add(BX.CrmEntityType.resolveId(s.getEntityId().toUpperCase()));t[s.getEntityId()]=s.getId()}));const s=babelHelpers.classPrivateFieldLooseBase(this,_converter)[_converter].getConfig().getScheme().getItemForEntityTypeIds([...e]);if(!s){throw new Error(`Could not find a scheme item for destinations ${[...e].join(", ")}`)}babelHelpers.classPrivateFieldLooseBase(this,_converter)[_converter].getConfig().updateFromSchemeItem(s);babelHelpers.classPrivateFieldLooseBase(this,_converter)[_converter].convert(babelHelpers.classPrivateFieldLooseBase(this,_entityId$1)[_entityId$1],t)}function _handleItemSelect2(e){const{item:t}=e.getData();babelHelpers.classPrivateFieldLooseBase(EntitySelector,_ensureOnlyOneItemOfEachTypeIsSelected)[_ensureOnlyOneItemOfEachTypeIsSelected](babelHelpers.classPrivateFieldLooseBase(this,_dialog)[_dialog],t)}function _ensureOnlyOneItemOfEachTypeIsSelected2(e,t){e.getSelectedItems().forEach((e=>{if(e.getEntityId()===t.getEntityId()&&main_core.Text.toInteger(e.getId())!==main_core.Text.toInteger(t.getId())){e.deselect()}}))}Object.defineProperty(EntitySelector,_ensureOnlyOneItemOfEachTypeIsSelected,{value:_ensureOnlyOneItemOfEachTypeIsSelected2});let instance$1=null;var _converters=babelHelpers.classPrivateFieldLooseKey("converters");class Manager{constructor(){Object.defineProperty(this,_converters,{writable:true,value:{}})}static get Instance(){if(instance$1===null){instance$1=new Manager}return instance$1}initializeConverter(e,t){const s=Config.create(e,t.configItems,Scheme.create(t.scheme));const i=new Converter(e,s,t.params);babelHelpers.classPrivateFieldLooseBase(this,_converters)[_converters][i.getId()]=i;return i}getConverter(e){return babelHelpers.classPrivateFieldLooseBase(this,_converters)[_converters][e]}createEntitySelector(e,t,s){const i=this.getConverter(e);if(!i){console.error("Converter with given id not found",e,this);return null}const a=i.getConfig().getScheme().getItemForEntityTypeIds(t);if(!a){console.error("Could not find scheme item",t,i);return null}return new EntitySelector(i,s,t)}}var _entityId$2=babelHelpers.classPrivateFieldLooseKey("entityId");var _container=babelHelpers.classPrivateFieldLooseKey("container");var _menuButton=babelHelpers.classPrivateFieldLooseKey("menuButton");var _label=babelHelpers.classPrivateFieldLooseKey("label");var _converter$1=babelHelpers.classPrivateFieldLooseKey("converter");var _menuId=babelHelpers.classPrivateFieldLooseKey("menuId");var _isAutoConversionEnabled=babelHelpers.classPrivateFieldLooseKey("isAutoConversionEnabled");var _analytics=babelHelpers.classPrivateFieldLooseKey("analytics");var _initUI=babelHelpers.classPrivateFieldLooseKey("initUI");var _bindEvents=babelHelpers.classPrivateFieldLooseKey("bindEvents");var _unbindEvents=babelHelpers.classPrivateFieldLooseKey("unbindEvents");var _handleContainerClick=babelHelpers.classPrivateFieldLooseKey("handleContainerClick");var _handleMenuButtonClick=babelHelpers.classPrivateFieldLooseKey("handleMenuButtonClick");var _showMenu=babelHelpers.classPrivateFieldLooseKey("showMenu");var _closeMenu=babelHelpers.classPrivateFieldLooseKey("closeMenu");var _getMenuItems=babelHelpers.classPrivateFieldLooseKey("getMenuItems");var _prepareEntitySelector=babelHelpers.classPrivateFieldLooseKey("prepareEntitySelector");var _handleItemClick=babelHelpers.classPrivateFieldLooseKey("handleItemClick");class SchemeSelector{constructor(e,t){Object.defineProperty(this,_handleItemClick,{value:_handleItemClick2});Object.defineProperty(this,_prepareEntitySelector,{value:_prepareEntitySelector2});Object.defineProperty(this,_getMenuItems,{value:_getMenuItems2});Object.defineProperty(this,_closeMenu,{value:_closeMenu2});Object.defineProperty(this,_showMenu,{value:_showMenu2});Object.defineProperty(this,_handleMenuButtonClick,{value:_handleMenuButtonClick2});Object.defineProperty(this,_handleContainerClick,{value:_handleContainerClick2});Object.defineProperty(this,_unbindEvents,{value:_unbindEvents2});Object.defineProperty(this,_bindEvents,{value:_bindEvents2});Object.defineProperty(this,_initUI,{value:_initUI2});Object.defineProperty(this,_entityId$2,{writable:true,value:void 0});Object.defineProperty(this,_container,{writable:true,value:void 0});Object.defineProperty(this,_menuButton,{writable:true,value:void 0});Object.defineProperty(this,_label,{writable:true,value:void 0});Object.defineProperty(this,_converter$1,{writable:true,value:void 0});Object.defineProperty(this,_menuId,{writable:true,value:void 0});Object.defineProperty(this,_isAutoConversionEnabled,{writable:true,value:void 0});Object.defineProperty(this,_analytics,{writable:true,value:{}});babelHelpers.classPrivateFieldLooseBase(this,_converter$1)[_converter$1]=e;babelHelpers.classPrivateFieldLooseBase(this,_entityId$2)[_entityId$2]=Number(t.entityId);babelHelpers.classPrivateFieldLooseBase(this,_container)[_container]=document.getElementById(t.containerId);babelHelpers.classPrivateFieldLooseBase(this,_menuButton)[_menuButton]=document.getElementById(t.buttonId);babelHelpers.classPrivateFieldLooseBase(this,_label)[_label]=document.getElementById(t.labelId);babelHelpers.classPrivateFieldLooseBase(this,_menuId)[_menuId]=`crm_conversion_scheme_selector_${babelHelpers.classPrivateFieldLooseBase(this,_entityId$2)[_entityId$2]}_${main_core.Text.getRandom()}`;babelHelpers.classPrivateFieldLooseBase(this,_isAutoConversionEnabled)[_isAutoConversionEnabled]=false;if(main_core.Type.isStringFilled(t.analytics.c_element)){babelHelpers.classPrivateFieldLooseBase(this,_analytics)[_analytics].c_element=t.analytics.c_element}if(!babelHelpers.classPrivateFieldLooseBase(this,_entityId$2)[_entityId$2]||!babelHelpers.classPrivateFieldLooseBase(this,_container)[_container]||!babelHelpers.classPrivateFieldLooseBase(this,_menuButton)[_menuButton]||!babelHelpers.classPrivateFieldLooseBase(this,_label)[_label]||!babelHelpers.classPrivateFieldLooseBase(this,_converter$1)[_converter$1]){console.error("Error SchemeSelector initializing",this)}else{babelHelpers.classPrivateFieldLooseBase(this,_initUI)[_initUI]();babelHelpers.classPrivateFieldLooseBase(this,_bindEvents)[_bindEvents]()}main_core_events.EventEmitter.makeObservable(this,"BX.Crm.Conversion.SchemeSelector")}destroy(){babelHelpers.classPrivateFieldLooseBase(this,_closeMenu)[_closeMenu]();babelHelpers.classPrivateFieldLooseBase(this,_unbindEvents)[_unbindEvents]();this.unsubscribeAll()}release(){this.destroy()}enableAutoConversion(){babelHelpers.classPrivateFieldLooseBase(this,_isAutoConversionEnabled)[_isAutoConversionEnabled]=true}disableAutoConversion(){babelHelpers.classPrivateFieldLooseBase(this,_isAutoConversionEnabled)[_isAutoConversionEnabled]=false}}function _initUI2(){const e=babelHelpers.classPrivateFieldLooseBase(this,_converter$1)[_converter$1].getConfig().getScheme().getCurrentItem();if(e){babelHelpers.classPrivateFieldLooseBase(this,_label)[_label].innerText=e.getPhrase()}}function _bindEvents2(){main_core.Event.bind(babelHelpers.classPrivateFieldLooseBase(this,_container)[_container],"click",babelHelpers.classPrivateFieldLooseBase(this,_handleContainerClick)[_handleContainerClick].bind(this));main_core.Event.bind(babelHelpers.classPrivateFieldLooseBase(this,_menuButton)[_menuButton],"click",babelHelpers.classPrivateFieldLooseBase(this,_handleMenuButtonClick)[_handleMenuButtonClick].bind(this))}function _unbindEvents2(){main_core.Event.unbind(babelHelpers.classPrivateFieldLooseBase(this,_container)[_container],"click",babelHelpers.classPrivateFieldLooseBase(this,_handleContainerClick)[_handleContainerClick].bind(this));main_core.Event.unbind(babelHelpers.classPrivateFieldLooseBase(this,_menuButton)[_menuButton],"click",babelHelpers.classPrivateFieldLooseBase(this,_handleMenuButtonClick)[_handleMenuButtonClick].bind(this))}function _handleContainerClick2(){const e=new main_core_events.BaseEvent({data:{isCanceled:false}});this.emit("onContainerClick",e);babelHelpers.classPrivateFieldLooseBase(this,_converter$1)[_converter$1].getConfig().updateFromSchemeItem();if(babelHelpers.classPrivateFieldLooseBase(this,_isAutoConversionEnabled)[_isAutoConversionEnabled]&&!e.getData().isCanceled){babelHelpers.classPrivateFieldLooseBase(this,_converter$1)[_converter$1].setAnalyticsElement(babelHelpers.classPrivateFieldLooseBase(this,_analytics)[_analytics].c_element);babelHelpers.classPrivateFieldLooseBase(this,_converter$1)[_converter$1].convert(babelHelpers.classPrivateFieldLooseBase(this,_entityId$2)[_entityId$2])}}function _handleMenuButtonClick2(){babelHelpers.classPrivateFieldLooseBase(this,_showMenu)[_showMenu]()}function _showMenu2(){const e=BX.pos(babelHelpers.classPrivateFieldLooseBase(this,_container)[_container]);main_popup.MenuManager.show({id:babelHelpers.classPrivateFieldLooseBase(this,_menuId)[_menuId],bindElement:babelHelpers.classPrivateFieldLooseBase(this,_menuButton)[_menuButton],items:babelHelpers.classPrivateFieldLooseBase(this,_getMenuItems)[_getMenuItems](),closeByEsc:true,cacheable:false,offsetLeft:-e.width})}function _closeMenu2(){main_popup.MenuManager.destroy(babelHelpers.classPrivateFieldLooseBase(this,_menuId)[_menuId])}function _getMenuItems2(){const e=babelHelpers.classPrivateFieldLooseBase(this,_converter$1)[_converter$1].getConfig().getScheme();const t=[];for(const s of e.getItems()){t.push({text:main_core.Text.encode(s.getPhrase()),onclick:()=>{babelHelpers.classPrivateFieldLooseBase(this,_handleItemClick)[_handleItemClick](s)}})}const s=babelHelpers.classPrivateFieldLooseBase(this,_prepareEntitySelector)[_prepareEntitySelector](e);if(s){t.push({text:babelHelpers.classPrivateFieldLooseBase(this,_converter$1)[_converter$1].getMessagePublic("openEntitySelector"),onclick:()=>{babelHelpers.classPrivateFieldLooseBase(this,_closeMenu)[_closeMenu]();void s.show()}})}return t}function _prepareEntitySelector2(e){if(babelHelpers.classPrivateFieldLooseBase(this,_converter$1)[_converter$1].getEntityTypeId()!==BX.CrmEntityType.enumeration.lead){return null}const t=e.getAllEntityTypeIds();const s=[];if(t.includes(BX.CrmEntityType.enumeration.contact)){s.push(BX.CrmEntityType.enumeration.contact)}if(t.includes(BX.CrmEntityType.enumeration.company)){s.push(BX.CrmEntityType.enumeration.company)}if(!main_core.Type.isArrayFilled(s)){return null}return new EntitySelector(babelHelpers.classPrivateFieldLooseBase(this,_converter$1)[_converter$1],babelHelpers.classPrivateFieldLooseBase(this,_entityId$2)[_entityId$2],s)}function _handleItemClick2(e){babelHelpers.classPrivateFieldLooseBase(this,_closeMenu)[_closeMenu]();babelHelpers.classPrivateFieldLooseBase(this,_label)[_label].innerText=e.getPhrase();babelHelpers.classPrivateFieldLooseBase(this,_converter$1)[_converter$1].getConfig().updateFromSchemeItem(e);const t=new main_core_events.BaseEvent({data:{isCanceled:false}});this.emit("onSchemeSelected",t);if(babelHelpers.classPrivateFieldLooseBase(this,_isAutoConversionEnabled)[_isAutoConversionEnabled]&&!t.getData().isCanceled){babelHelpers.classPrivateFieldLooseBase(this,_converter$1)[_converter$1].setAnalyticsElement(babelHelpers.classPrivateFieldLooseBase(this,_analytics)[_analytics].c_element);babelHelpers.classPrivateFieldLooseBase(this,_converter$1)[_converter$1].convert(babelHelpers.classPrivateFieldLooseBase(this,_entityId$2)[_entityId$2])}}const Conversion={Scheme:Scheme,Config:Config,Converter:Converter,Manager:Manager,SchemeSelector:SchemeSelector,EntitySelector:EntitySelector};exports.Conversion=Conversion})(this.BX.Crm=this.BX.Crm||{},BX.Crm.Integration.Analytics,BX.UI.Analytics,BX.UI.Dialogs,BX,BX.Crm.Models,BX.UI,BX.UI.EntitySelector,BX,BX.Event,BX.Main);
//# sourceMappingURL=conversion.bundle.map.js