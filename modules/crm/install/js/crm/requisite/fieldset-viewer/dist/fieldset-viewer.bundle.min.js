this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,i,s,n,o,r){"use strict";let l=e=>e,d,a,c,u,h,E,v,g;class p extends i.EventEmitter{constructor(e={}){super();this.cache=new t.Cache.MemoryCache;this.endpoint="crm.api.fieldset.load";this.setEventNamespace("BX.Crm.Requisite.FieldsetViewer");this.subscribeFromOptions((e==null?void 0:e.events)||{});this.setOptions(e);t.Event.bind(e.bindElement,"click",this.onBindElementClick.bind(this))}setData(e){this.cache.set("data",e)}setEndpoint(e){this.endpoint=e;return this}getData(){return this.cache.get("data",{})}load(){return new Promise(((e,t)=>{var i,s;const{entityTypeId:n,entityId:o,fieldListEditorOptions:r,documentUid:l}=this.getOptions();const d=(i=r==null?void 0:(s=r.fieldsPanelOptions)==null?void 0:s.presetId)!=null?i:null;BX.ajax.runAction(this.endpoint,{json:{entityTypeId:n,entityId:o,presetId:d,documentUid:l}}).then((t=>{e(t.data)})).catch((e=>{t(e.errors)}))}))}setOptions(e){this.cache.set("options",{...e})}getOptions(){return this.cache.get("options")}getPopup(){return this.cache.remember("popup",(()=>{const e=this.getOptions();return new s.Popup({bindElement:e.bindElement,autoHide:false,width:570,height:478,className:"crm-requisite-fieldset-viewer",noAllPaddings:true,...t.Type.isPlainObject(e==null?void 0:e.popupOptions)?e==null?void 0:e.popupOptions:{},events:{onClose:()=>{this.emit("onClose",{changed:this.getIsChanged()});this.setIsChanged(false)}}})}))}setIsChanged(e){this.cache.set("isChanged",t.Text.toBoolean(e))}getIsChanged(){return this.cache.get("isChanged",false)}getLoader(){return this.cache.remember("loader",(()=>new n.Loader))}show(){const e=this.getPopup();t.Dom.clean(e.getContentContainer());void this.getLoader().show(e.getContentContainer());this.load().then((t=>{this.setData({...t});e.setContent(this.createPopupContent(t))})).catch((e=>{this.emit("onFieldSetLoadError",{requestErrors:e})}));e.show()}hide(){this.getPopup().close()}onBindElementClick(e){e.preventDefault();this.show()}createPopupContent(e){return t.Tag.render(d||(d=l`
			<div class="crm-requisite-fieldset-viewer-content">
				${0}
				${0}
				${0}
				${0}
			</div>
		`),this.createBannerLayout(e),this.createListLayout(e),this.getFooterLayout(),this.createCloseButton())}createBannerLayout(e){const i=t.Loc.getMessage("CRM_REQUISITE_FIELDSET_VIEWER_BANNER_TITLE").replace("{{requisite}}",` <strong>${t.Text.encode(e==null?void 0:e.title)}</strong>`);const s=(()=>{let i=t.Loc.getMessage("CRM_REQUISITE_FIELDSET_VIEWER_BANNER_DESCRIPTION");if(t.Type.isStringFilled(e==null?void 0:e.more)){i+=`\n\t\t\t\t\t<a class="ui-link" href="${t.Text.encode(e==null?void 0:e.more)}">\n\t\t\t\t\t\t\t\t\t\t${t.Loc.getMessage("CRM_REQUISITE_FIELDSET_VIEWER_BANNER_MORE_LINK_LABEL")}\n\t\t\t\t\t\t\t\t\t</a>\n\t\t\t\t`}return i})();return t.Tag.render(a||(a=l`
			<div class="crm-requisite-fieldset-viewer-banner">
				<div class="crm-requisite-fieldset-viewer-banner-text">
					<div class="crm-requisite-fieldset-viewer-banner-text-title">
						${0}
					</div>
					<div class="crm-requisite-fieldset-viewer-banner-text-description">
						${0}
					</div>
				</div>
			</div>
		`),i,s)}createListLayout(e){return t.Tag.render(c||(c=l`
			<div class="crm-requisite-fieldset-viewer-list">
				${0}
			</div>
		`),this.createListContainer(e.fields))}createListContainer(e){return t.Tag.render(u||(u=l`
			<div class="crm-requisite-fieldset-viewer-list-container">
				${0}
			</div>
		`),e.map((e=>this.createListItem(e))))}createListItem(e){var i;const s=(()=>{var i;if(t.Type.isStringFilled(e==null?void 0:(i=e.editing)==null?void 0:i.url)){var s;let i;if((e==null?void 0:(s=e.editing)==null?void 0:s.entityTypeId)===8){var n;const t={permissionToken:e==null?void 0:(n=e.editing)==null?void 0:n.permissionToken};i=()=>{var i;BX.SidePanel.Instance.open(e==null?void 0:(i=e.editing)==null?void 0:i.url,{cacheable:false,requestMethod:"post",requestParams:t,events:{onClose:()=>{this.show()}}});this.setIsChanged(true)}}else if(["COMPANY_PHONE","COMPANY_EMAIL"].includes(e==null?void 0:e.name)){i=()=>{t.Runtime.loadExtension("sign.v2.company-editor").then((i=>{var s,n,o,r;const{CompanyEditor:l,CompanyEditorMode:d,DocumentEntityTypeId:a,EditorTypeGuid:c}=i;l.openSlider({mode:d.Edit,documentEntityId:e==null?void 0:(s=e.editing)==null?void 0:s.documentEntityId,companyId:e==null?void 0:(n=e.editing)==null?void 0:n.entityId,layoutTitle:t.Loc.getMessage("CRM_REQUISITE_FIELDSET_VIEWER__SET_FORM_TITLE"),entityTypeId:e==null?void 0:(o=e.editing)==null?void 0:o.documentEntityTypeId,showOnlyCompany:true,guid:(e==null?void 0:(r=e.editing)==null?void 0:r.documentEntityTypeId)===a.B2b?c.B2b:c.B2e,params:{enableSingleSectionCombining:"Y"}},{onCloseHandler:()=>this.show()})})).catch((t=>{console.error(t);console.log("you should update sign service");i=()=>{var t;BX.SidePanel.Instance.open(e==null?void 0:(t=e.editing)==null?void 0:t.url,{cacheable:false,events:{onClose:()=>{this.show()}}});this.setIsChanged(true)}}))}}else{i=()=>{var t;BX.SidePanel.Instance.open(e==null?void 0:(t=e.editing)==null?void 0:t.url,{cacheable:false,events:{onClose:()=>{this.show()}}});this.setIsChanged(true)}}return t.Tag.render(h||(h=l`
					<span 
						class="ui-btn ui-btn-link" 
						onclick="${0}">
							${0}
					</span>
				`),i,t.Loc.getMessage("CRM_REQUISITE_FIELDSET_VIEWER_LIST_ITEM_VALUE_LINK_LABEL"))}return""})();const n=t.Type.isObject(e==null?void 0:e.value)?(i=Object.values(e==null?void 0:e.value))==null?void 0:i.reduce(((e,t)=>`${e}, ${t}`)):e==null?void 0:e.value;return t.Tag.render(E||(E=l`
			<div class="crm-requisite-fieldset-viewer-list-item">
				<div class="crm-requisite-fieldset-viewer-list-item-left">
					<div class="crm-requisite-fieldset-viewer-list-item-label">${0}</div>
					<div class="crm-requisite-fieldset-viewer-list-item-value">${0}</div>
				</div>
				<div class="crm-requisite-fieldset-viewer-list-item-right">
					${0}
				</div>
			</div>
		`),t.Text.encode(e==null?void 0:e.label),t.Text.encode(n),s)}createCloseButton(){return this.cache.remember("closeButton",(()=>{const e=()=>{this.hide()};return t.Tag.render(v||(v=l`
				<div 
					class="crm-requisite-fieldset-viewer-close-button"
					onclick="${0}"
				></div>
			`),e)}))}getFieldListEditor(){return this.cache.remember("fieldListEditor",(()=>{const e=this.getOptions();return new r.ListEditor({setId:this.getData().id,title:t.Loc.getMessage("CRM_REQUISITE_FIELDSET_VIEWER__SET_EDITOR_TITLE_MSGVER_1"),editable:{label:{label:t.Loc.getMessage("CRM_REQUISITE_FIELDSET_VIEWER__SET_EDITOR_NAME_LABEL"),type:"string"},required:{label:t.Loc.getMessage("CRM_REQUISITE_FIELDSET_VIEWER__SET_EDITOR_REQUIRED_LABEL"),type:"checkbox"}},autoSave:false,cacheable:false,events:{onSave:()=>this.show()},fieldsPanelOptions:{hideVirtual:1,...t.Type.isPlainObject(e.fieldsPanelOptions)?e.fieldsPanelOptions:{}},...t.Type.isPlainObject(e.fieldListEditorOptions)?e.fieldListEditorOptions:{}})}))}getEditButton(){return this.cache.remember("editButton",(()=>new o.Button({text:t.Loc.getMessage("CRM_REQUISITE_FIELDSET_VIEWER_EDIT_BUTTON_LABEL_MSGVER_1"),color:o.Button.Color.LIGHT_BORDER,icon:o.Button.Icon.EDIT,size:o.Button.Size.SMALL,round:true,events:{click:this.onEditButtonClick.bind(this)}})))}onEditButtonClick(){this.getFieldListEditor().showSlider();this.setIsChanged(true)}getFooterLayout(){return this.cache.remember("footerLayout",(()=>t.Tag.render(g||(g=l`
				<div class="crm-requisite-fieldset-viewer-footer">
					${0}
				</div>
			`),this.getEditButton().render())))}}e.FieldsetViewer=p})(this.BX.Crm.Requisite=this.BX.Crm.Requisite||{},BX,BX.Event,BX.Main,BX,BX.UI,BX.Crm.Field);
//# sourceMappingURL=fieldset-viewer.bundle.map.js