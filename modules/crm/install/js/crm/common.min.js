BX.namespace("BX.Crm");if(typeof BX.HtmlHelper==="undefined"){BX.HtmlHelper=function(){};BX.HtmlHelper.setupSelectOptions=function(t,e){while(t.options.length>0){t.remove(0)}var i=null;var n="";for(var r=0;r<e.length;r++){var s=e[r];var o=BX.type.isNotEmptyString(s["group"])?s["group"]:"";if(o!==""&&o!==n){n=o;i=document.createElement("OPTGROUP");i.label=o;t.appendChild(i)}var a=BX.type.isNotEmptyString(s["value"])?s["value"]:"";var l=BX.type.isNotEmptyString(s["text"])?s["text"]:s["value"];var u=new Option(l,a,false,false);var h=BX.type.isPlainObject(s["attrs"])?s["attrs"]:null;if(h){for(var c in h){if(!h.hasOwnProperty(c)){continue}u.setAttribute("data-"+c,h[c])}}if(i){i.appendChild(u)}else{if(!BX.browser.IsIE()){t.add(u,null)}else{try{t.add(u,t.options[null])}catch(e){t.add(u,null)}}}}}}if(typeof BX.CrmUserSearchPopup==="undefined"){BX.CrmUserSearchPopup=function(){this._id="";this._search_input=null;this._data_input=null;this._componentName="";this._componentContainer=null;this._componentObj=null;this._serviceContainer=null;this._zIndex=0;this._dlg=null;this._dlgDisplayed=false;this._currentUser={};this._searchKeyHandler=BX.delegate(this._handleSearchKey,this);this._searchFocusHandler=BX.delegate(this._handleSearchFocus,this);this._externalClickHandler=BX.delegate(this._handleExternalClick,this);this._clearButtonClickHandler=BX.delegate(this._hadleClearButtonClick,this);this._userSelectorInitCounter=0};BX.CrmUserSearchPopup.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_user_search_popup_"+Math.random();if(!e){e={}}if(!BX.type.isElementNode(e["searchInput"])){throw"BX.CrmUserSearchPopup: 'search_input' is not defined!"}this._search_input=e["searchInput"];this._clearButton=BX.findPreviousSibling(this._search_input,{className:"crm-filter-name-clean"});if(!BX.type.isElementNode(e["dataInput"])){throw"BX.CrmUserSearchPopup: 'data_input' is not defined!"}this._data_input=e["dataInput"];if(!BX.type.isNotEmptyString(e["componentName"])){throw"BX.CrmUserSearchPopup: 'componentName' is not defined!"}this._currentUser=e["user"]?e["user"]:{};this._componentName=e["componentName"];this._componentContainer=BX(this._componentName+"_selector_content");this._initializeUserSelector();this._adjustUser();this._serviceContainer=e["serviceContainer"]?e["serviceContainer"]:document.body;this.setZIndex(e["zIndex"])},_initializeUserSelector:function(){var t="O_"+this._componentName;if(!window[t]){if(this._userSelectorInitCounter===10){throw"BX.CrmUserSearchPopup: Could not find '"+t+"' user selector!"}this._userSelectorInitCounter++;window.setTimeout(BX.delegate(this._initializeUserSelector,this),200);return}this._componentObj=window[t];this._componentObj.onSelect=BX.delegate(this._handleUserSelect,this);this._componentObj.searchInput=this._search_input;if(this._currentUser&&this._currentUser["id"]>0){this._componentObj.setSelected([this._currentUser])}BX.bind(this._search_input,"keyup",this._searchKeyHandler);BX.bind(this._search_input,"focus",this._searchFocusHandler);if(BX.type.isElementNode(this._clearButton)){BX.bind(this._clearButton,"click",this._clearButtonClickHandler)}BX.bind(document,"click",this._externalClickHandler)},open:function(){this._componentContainer.style.display="";this._dlg=new BX.PopupWindow(this._id,this._search_input,{autoHide:false,draggable:false,closeByEsc:true,offsetLeft:0,offsetTop:0,zIndex:this._zIndex,bindOptions:{forceBindPosition:true},content:this._componentContainer,events:{onPopupShow:BX.delegate((function(){this._dlgDisplayed=true}),this),onPopupClose:BX.delegate((function(){this._dlgDisplayed=false;this._componentContainer.parentNode.removeChild(this._componentContainer);this._serviceContainer.appendChild(this._componentContainer);this._componentContainer.style.display="none";this._dlg.destroy()}),this),onPopupDestroy:BX.delegate((function(){this._dlg=null}),this)}});this._dlg.show()},_adjustUser:function(){if(parseInt(this._currentUser["id"])>0){this._data_input.value=this._currentUser["id"];this._search_input.value=this._currentUser["name"]?this._currentUser.name:this._currentUser["id"]}else{this._data_input.value=this._search_input.value=""}},getZIndex:function(){return this._zIndex},setZIndex:function(t){if(typeof t==="undefined"||t===null){t=0}var e=parseInt(t);this._zIndex=!isNaN(e)?e:0},close:function(){if(this._dlg){this._dlg.close()}},select:function(t){this._currentUser=t;this._adjustUser();if(this._componentObj){this._componentObj.setSelected([t])}},_onBeforeDelete:function(){if(BX.type.isElementNode(this._search_input)){BX.unbind(this._search_input,"keyup",this._searchKeyHandler);BX.unbind(this._search_input,"focus",this._searchFocusHandler)}if(BX.type.isElementNode(this._clearButton)){BX.bind(this._clearButton,"click",this._clearButtonClickHandler)}BX.unbind(document,"click",this._externalClickHandler);if(this._componentContainer){this._componentContainer.parentNode.removeChild(this._componentContainer);this._serviceContainer.appendChild(this._componentContainer);this._componentContainer.style.display="none";this._componentContainer=null}},_hadleClearButtonClick:function(t){this._data_input.value=this._search_input.value=""},_handleExternalClick:function(t){if(!t){t=window.event}if(!this._dlgDisplayed){return}var e=null;if(t){if(t.target){e=t.target}else if(t.srcElement){e=t.srcElement}}if(e!==this._search_input&&!BX.findParent(e,{attribute:{id:this._componentName+"_selector_content"}})){this._adjustUser();this.close()}},_handleSearchKey:function(t){if(!this._dlg||!this._dlgDisplayed){this.open()}this._componentObj.search()},_handleSearchFocus:function(t){if(!this._dlg||!this._dlgDisplayed){this.open()}this._componentObj._onFocus(t)},_handleUserSelect:function(t){this._currentUser=t;this._adjustUser();this.close()}};BX.CrmUserSearchPopup.items={};BX.CrmUserSearchPopup.create=function(t,e,i){if(isNaN(i)){i=0}if(i>0){window.setTimeout((function(){BX.CrmUserSearchPopup.create(t,e,0)}),i);return null}var n=new BX.CrmUserSearchPopup;n.initialize(t,e);this.items[t]=n;return n};BX.CrmUserSearchPopup.createIfNotExists=function(t,e){var i=this.items[t];if(typeof i!=="undefined"){i.initialize(t,e)}else{i=new BX.CrmUserSearchPopup;i.initialize(t,e);this.items[t]=i}return i};BX.CrmUserSearchPopup.deletePopup=function(t){var e=this.items[t];if(typeof e==="undefined"){return false}e._onBeforeDelete();delete this.items[t];return true}}if(typeof BX.CrmNotifier==="undefined"){BX.CrmNotifier=function(){this._sender=null;this._listeners=[]};BX.CrmNotifier.prototype={initialize:function(t){this._sender=t},addListener:function(t){if(!BX.type.isFunction(t)){return}for(var e=0;e<this._listeners.length;e++){if(this._listeners[e]===t){return}}this._listeners.push(t)},removeListener:function(t){if(!BX.type.isFunction(t)){return}for(var e=0;e<this._listeners.length;e++){if(this._listeners[e]===t){this._listeners.splice(e,1);return}}},resetListeners:function(){this._listeners=[]},notify:function(t){var e=[];for(var i=0;i<this._listeners.length;i++){e.push(this._listeners[i])}if(!BX.type.isArray(t)){t=[]}t.splice(0,0,this._sender);for(var n=0;n<e.length;n++){try{e[n].apply(this._sender,t)}catch(t){}}},getListenerCount:function(){return this._listeners.length}};BX.CrmNotifier.create=function(t){var e=new BX.CrmNotifier;e.initialize(t);return e}}if(typeof BX.CmrSelectorMenuItem==="undefined"){BX.CmrSelectorMenuItem=function(){this._parent=null;this._settings={};this._onSelectNotifier=null};BX.CmrSelectorMenuItem.prototype={initialize:function(t){this._settings=t;this._onSelectNotifier=BX.CrmNotifier.create(this);var e=this.getSetting("events");if(e&&e["select"]){this._onSelectNotifier.addListener(e["select"])}},getSetting:function(t,e){var i=this._settings;return typeof i[t]!="undefined"?i[t]:e},getValue:function(){return this.getSetting("value","")},getText:function(){var t=this.getSetting("text");return BX.type.isNotEmptyString(t)?t:this.getValue()},isEnabled:function(){return this.getSetting("enabled",true)},isDefault:function(){return this.getSetting("default",false)},createMenuItem:function(t){if(BX.prop.getBoolean(this._settings,"delimiter",false)){return{delimiter:true}}t=!!t;var e=this.getText();if(!!t){e=BX.util.htmlspecialchars(e)}return{text:e,onclick:BX.delegate(this._onClick,this),className:this.getSetting("className","")}},addOnSelectListener:function(t){this._onSelectNotifier.addListener(t)},removeOnSelectListener:function(t){this._onSelectNotifier.removeListener(t)},_onClick:function(){this._onSelectNotifier.notify()}};BX.CmrSelectorMenuItem.create=function(t){var e=new BX.CmrSelectorMenuItem;e.initialize(t);return e}}if(typeof BX.CmrSelectorMenu==="undefined"){BX.CmrSelectorMenu=function(){this._id="";this._settings={};this._items=[];this._encodeItems=true;this._onSelectNotifier=null;this._popup=null;this._isOpened=false;this._itemSelectHandler=BX.delegate(this.onItemSelect,this)};BX.CmrSelectorMenu.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_selector_menu_"+Math.random().toString().substring(2);this._settings=e?e:{};this._encodeItems=!!this.getSetting("encodeItems",true);var i=this.getSetting("items");i=BX.type.isArray(i)?i:[];this._items=[];for(var n=0;n<i.length;n++){var r=BX.CmrSelectorMenuItem.create(i[n]);r.addOnSelectListener(this._itemSelectHandler);this._items.push(r)}this._onSelectNotifier=BX.CrmNotifier.create(this)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getItems:function(){return this._items},setupItems:function(t){this._items=[];for(var e=0;e<t.length;e++){var i=BX.CmrSelectorMenuItem.create(t[e]);i.addOnSelectListener(this._itemSelectHandler);this._items.push(i)}},isOpened:function(){return this._isOpened},open:function(t){if(this._isOpened){return}var e=[];for(var i=0;i<this._items.length;i++){var n=this._items[i];if(n.isEnabled()){e.push(n.createMenuItem(this._encodeItems))}}BX.PopupMenu.show(this._id,t,e,{offsetTop:0,offsetLeft:0,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}});this._popup=BX.PopupMenu.currentItem},close:function(){if(this._popup&&this._popup.popupWindow){this._popup.popupWindow.close()}},addOnSelectListener:function(t){this._onSelectNotifier.addListener(t)},removeOnSelectListener:function(t){this._onSelectNotifier.removeListener(t)},onItemSelect:function(t){this.close();this._onSelectNotifier.notify([t])},onPopupShow:function(){this._isOpened=true},onPopupClose:function(){if(this._popup){if(this._popup.popupWindow){this._popup.popupWindow.destroy()}}},onPopupDestroy:function(){this._isOpened=false;this._popup=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}}};BX.CmrSelectorMenu.create=function(t,e){var i=new BX.CmrSelectorMenu;i.initialize(t,e);return i}}if(typeof BX.CrmSelector==="undefined"){BX.CrmSelector=function(){this._id="";this._selectedValue="";this._settings={};this._outerWrapper=this._wrapper=this._container=this._view=null;this._items=[];this._encodeItems=true;this._onSelectNotifier=null;this._popup=null;this._isPopupShown=false};BX.CrmSelector.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_selector_"+Math.random().toString().substring(2);this._settings=e?e:{};this._container=this.getSetting("container",null);this._selectedValue=this.getSetting("selectedValue","");this._encodeItems=!!this.getSetting("encodeItems",true);var i=this.getSetting("items");i=BX.type.isArray(i)?i:[];this._items=[];for(var n=0;n<i.length;n++){var r=BX.CmrSelectorMenuItem.create(i[n]);r.addOnSelectListener(BX.delegate(this._onItemSelect,this));this._items.push(r)}this._onSelectNotifier=BX.CrmNotifier.create(this)},getId:function(){return this._id},getSetting:function(t,e){var i=this._settings;return typeof i[t]!="undefined"?i[t]:e},isEnabled:function(){return this.getSetting("enabled",true)},layout:function(t){if(BX.type.isDomNode(t)){this._container=t}else if(this._container){t=this._container}if(!t){return}var e=this.isEnabled();var i=this.getSetting("layout");if(!i){i={}}var n=this._outerWrapper=BX.create("DIV",{attrs:{className:"crm-selector-container",id:this._id}});if(i["position"]==="first"){t.insertBefore(n,BX.firstChild(t))}else if(i["insertBefore"]){t.insertBefore(n,BX.findChild(t,i["insertBefore"]))}else{t.appendChild(n)}var r=BX.type.isPlainObject(i["offset"])?i["offset"]:{};if(BX.type.isNotEmptyString(r["left"])){n.style.marginLeft=r["left"]}if(BX.type.isNotEmptyString(r["right"])){n.style.marginRight=r["right"]}var s=this.getSetting("title","");if(BX.type.isNotEmptyString(s)){n.appendChild(BX.create("SPAN",{attrs:{className:"crm-selector-title"},text:s+":"}))}var o=this._wrapper=BX.create("DIV",{attrs:{className:"crm-selector-wrapper"}});n.appendChild(o);var a=BX.delegate(this._onClick,this);var l=BX.create("DIV",{attrs:{className:"crm-selector-inner-wrapper"}});if(e){BX.bind(l,"click",a)}o.appendChild(l);var u=this._findItemByValue(this._selectedValue);if(!u){u=this.getDefaultItem()}var h=u?u.getText():"";if(this._encodeItems){h=BX.util.htmlspecialchars(h)}var c=this._view=BX.create("SPAN",{attrs:{className:"crm-selector-view"},html:h});l.appendChild(c);if(e){l.appendChild(BX.create("A",{attrs:{className:"crm-selector-arrow"},events:{click:a},html:"&nbsp;"}))}},clearLayout:function(){if(!this._outerWrapper){return}BX.remove(this._outerWrapper);this._outerWrapper=null},getItems:function(){return this._items},selectValue:function(t){this.selectItem(this._findItemByValue(t))},selectItem:function(t){if(!t){return}this._selectedValue=t.getValue();if(this._view){var e=t.getText();if(this._encodeItems){e=BX.util.htmlspecialchars(e)}this._view.innerHTML=e}},getSelectedValue:function(){return this._selectedValue},getSelectedItem:function(){return this._findItemByValue(this._selectedValue)},getDefaultItem:function(){var t=this.getItems();for(var e=0;e<t.length;e++){var i=t[e];if(i.isDefault()){return i}}return null},showPopup:function(){if(this._isPopupShown){return}var t=[];for(var e=0;e<this._items.length;e++){var i=this._items[e];if(i.isEnabled()){t.push(i.createMenuItem(this._encodeItems))}}BX.PopupMenu.show(this._id,this._wrapper,t,{offsetTop:0,offsetLeft:0,events:{onPopupShow:BX.delegate(this._onPopupShow,this),onPopupClose:BX.delegate(this._onPopupClose,this),onPopupDestroy:BX.delegate(this._onPopupDestroy,this)}});this._popup=BX.PopupMenu.currentItem},addOnSelectListener:function(t){this._onSelectNotifier.addListener(t)},removeOnSelectListener:function(t){this._onSelectNotifier.removeListener(t)},_findItemByValue:function(t){var e=this.getItems();for(var i=0;i<e.length;i++){var n=e[i];if(t===n.getValue()){return n}}return null},_onClick:function(t){t=t?t:window.event;BX.PreventDefault(t);if(this.isEnabled()){this.showPopup()}},_onItemSelect:function(t){this.selectItem(t);if(this._popup){if(this._popup.popupWindow){this._popup.popupWindow.close()}}this._onSelectNotifier.notify([t])},_onPopupShow:function(){this._isPopupShown=true},_onPopupClose:function(){if(this._popup){if(this._popup.popupWindow){this._popup.popupWindow.destroy()}}},_onPopupDestroy:function(){this._isPopupShown=false;this._popup=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}}};BX.CrmSelector.create=function(t,e){var i=new BX.CrmSelector;i.initialize(t,e);this.items[i.getId()]=i;return i};BX.CrmSelector.deleteItem=function(t){if(this.items[t]){this.items[t].clearLayout();delete this.items[t]}};BX.CrmSelector.items={}}if(typeof BX.CrmInterfaceFormUtil==="undefined"){BX.CrmInterfaceFormUtil=function(){};BX.CrmInterfaceFormUtil.disableThemeSelection=function(t){var e=window["bxForm_"+t];var i=e?e.settingsMenu:null;if(!i){return}for(var n=0;n<i.length;n++){if(i[n]&&i[n].ICONCLASS==="form-themes"){i.splice(n,1);break}}if(i.length===0){var r=BX.findChild(BX("form_"+t),{tag:"A",class:"bx-context-button bx-form-menu"},true);if(r){r.style.display="none"}}};BX.CrmInterfaceFormUtil.showFormRow=function(t,e){var i=BX.findParent(e,{tag:"TR"});if(i){i.style.display=!!t?"":"none"}}}if(typeof BX.CrmParamBag==="undefined"){BX.CrmParamBag=function(){this._params={}};BX.CrmParamBag.prototype={initialize:function(t){this._params=t?t:{}},getParam:function(t,e){var i=this._params;return typeof i[t]!="undefined"?i[t]:e},getIntParam:function(t,e){if(typeof e==="undefined"){e=0}var i=this._params;return typeof i[t]!="undefined"?parseInt(i[t]):e},getBooleanParam:function(t,e){if(typeof e==="undefined"){e=0}var i=this._params;return typeof i[t]!="undefined"?!!i[t]:e},setParam:function(t,e){this._params[t]=e},clear:function(){this._params={}},merge:function(t){this._params=BX.util.objectMerge(this._params,t)}};BX.CrmParamBag.create=function(t){var e=new BX.CrmParamBag;e.initialize(t);return e}}if(typeof BX.CrmSubscriber==="undefined"){BX.CrmSubscriber=function(){this._id="";this._element=null;this._eventName="";this._callback=null;this._settings=null;this._handler=BX.delegate(this._onElementEvent,this)};BX.CrmSubscriber.prototype={initialize:function(t,e,i,n,r){this._id=t;this._element=e;this._eventName=i;this._callback=n;this._settings=r?r:BX.CrmParamBag.create(null)},getSetting:function(t,e){return this._settings.getParam(t,e)},setSetting:function(t,e){return this._settings.setParam(t,e)},getId:function(){return this._id},getElement:function(){return this._element},getEventName:function(){return this._eventName},getCallback:function(){return this._callback},subscribe:function(){BX.bind(this.getElement(),this.getEventName(),this._handler)},unsubscribe:function(){BX.unbind(this.getElement(),this.getEventName(),this._handler)},_onElementEvent:function(t){var e=this.getCallback();if(BX.type.isFunction(e)){e(this,{event:t})}return this.getSetting("preventDefault",false)?BX.PreventDefault(t):true}};BX.CrmSubscriber.items={};BX.CrmSubscriber.create=function(t,e,i,n,r){var s=new BX.CrmSubscriber;s.initialize(t,e,i,n,r);this.items[t]=s;return s};BX.CrmSubscriber.subscribe=function(t,e,i,n,r){var s=this.create(t,e,i,n,r);s.subscribe();return s}}if(typeof BX.CrmMultiFieldViewer==="undefined"){BX.CrmMultiFieldViewer=function(){this._id="";this._shown=false;this._layout="";this._typeName=""};BX.CrmMultiFieldViewer.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._layout=this.getSetting("layout","grid").toLowerCase();this._typeName=this.getSetting("typeName","")},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},show:function(){if(this._shown){return}var t=BX.create("TABLE");t.cellSpacing="0";t.cellPadding="0";t.border="0";var e="bx-crm-grid-multi-field-viewer";var i=false;var n=this.getSetting("items",[]);for(var r=0;r<n.length;r++){var s=n[r];var o=t.insertRow(-1);var a=o.insertCell(-1);var l=s["value"];var u="crm-client-contacts-block-text";if(this._typeName==="PHONE"&&BX.type.isNotEmptyString(s["sipCallHtml"])){if(!i){i=true}l+=s["sipCallHtml"]}a.appendChild(BX.create("SPAN",{attrs:{className:u},html:l}));var h=o.insertCell(-1);h.appendChild(BX.create("SPAN",{attrs:{className:"crm-multi-field-value-type"},text:BX.type.isNotEmptyString(s["type"])?s["type"]:""}))}if(i){e+=" bx-crm-grid-multi-field-viewer-tel-sip"}t.className=e;var c=BX.CrmMultiFieldViewer.dialogs[this._id]?BX.CrmMultiFieldViewer.dialogs[this._id]:null;if(!c){var p=this.getSetting("anchor");if(!BX.type.isElementNode(p)){p=BX(this.getSetting("anchorId",""))}var m=!!this.getSetting("topmost",false);c=new BX.PopupWindow(this._id,p,{autoHide:true,draggable:false,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:true},closeByEsc:true,zIndex:m?-10:-14,className:"crm-item-popup-num-block",events:{onPopupShow:BX.delegate((function(){this._shown=true}),this),onPopupClose:BX.delegate((function(){this._shown=false;BX.CrmMultiFieldViewer.dialogs[this._id].destroy()}),this),onPopupDestroy:BX.delegate((function(){delete BX.CrmMultiFieldViewer.dialogs[this._id]}),this)},content:t});BX.CrmMultiFieldViewer.dialogs[this._id]=c}c.show()},close:function(){if(this._shown&&typeof BX.CrmMultiFieldViewer.dialogs[this._id]!=="undefined"){BX.CrmMultiFieldViewer.dialogs[this._id].close()}}};BX.CrmMultiFieldViewer.items={};BX.CrmMultiFieldViewer.create=function(t,e){var i=new BX.CrmMultiFieldViewer;i.initialize(t,e);this.items[t]=i;return i};BX.CrmMultiFieldViewer.ensureCreated=function(t,e){return this.items[t]?this.items[t]:this.create(t,e)};BX.CrmMultiFieldViewer.dialogs={}}if(typeof BX.CrmSipManager==="undefined"){BX.CrmSipManager=function(){this._id="";this._settings=null;this._serviceUrls={};this._recipientInfos={}};BX.CrmSipManager.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:BX.CrmParamBag.create(null)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.getParam(t,e)},setSetting:function(t,e){return this._settings.setParam(t,e)},openPreCallDialog:function(t,e,i,n){if(!t||typeof t!=="object"){return}if(!e||typeof e!=="object"){e={}}var r=BX.type.isNotEmptyString(e["ENTITY_TYPE"])?e["ENTITY_TYPE"]:"";var s=BX.type.isNotEmptyString(e["ENTITY_ID"])?e["ENTITY_ID"]:"";var o=r+"_"+s.toString();var a=BX.CrmPreCallDialog.create(o,BX.CrmParamBag.create({recipient:t,params:e,anchor:i,closeCallback:n}));a.show()},setServiceUrl:function(t,e){if(BX.type.isNotEmptyString(t)&&BX.type.isNotEmptyString(e)){this._serviceUrls[t]=e}},getServiceUrl:function(t){return BX.type.isNotEmptyString(t)&&this._serviceUrls.hasOwnProperty(t)?this._serviceUrls[t]:""},makeCall:function(t,e){var i=BX.type.isNotEmptyString(t["number"])?t["number"]:"";if(i==""){return}var n=BX.type.isNotEmptyString(e["ENTITY_TYPE"])?e["ENTITY_TYPE"]:"";var r=BX.type.isNotEmptyString(e["ENTITY_ID"])?parseInt(e["ENTITY_ID"]):0;if(!(n!==""&&r>0)){n=BX.type.isNotEmptyString(t["entityTypeName"])?t["entityTypeName"]:"";if(n!==""){n="CRM_"+n.toUpperCase()}e["ENTITY_TYPE"]=n;e["ENTITY_ID"]=typeof t["entityId"]!=="undefined"?parseInt(t["entityId"]):0}var s=[];BX.onCustomEvent(window,"CRM_SIP_MANAGER_MAKE_CALL",[this,t,e,s]);if(BX.type.isArray(s)&&s.length>0){for(var o=0;o<s.length;o++){var a=s[o];if(BX.type.isFunction(a)){try{a(t,e)}catch(t){}}}}else if(typeof top.BXIM!=="undefined"){top.BXIM.phoneTo(i,e)}},startCall:function(t,e,i,n){i=!!i;if(i){var r=typeof t["enableInfoLoading"]?t["enableInfoLoading"]:false;if(r){var s=BX.type.isNotEmptyString(e["ENTITY_TYPE"])?e["ENTITY_TYPE"]:"";var o="";if(BX.type.isNotEmptyString(e["ENTITY_ID"])||BX.type.isNumber(e["ENTITY_ID"])){o=e["ENTITY_ID"]}var a=s+"_"+o.toString();if(this._recipientInfos.hasOwnProperty(a)){var l=this._recipientInfos[a];t["title"]=BX.type.isNotEmptyString(l["title"])?l["title"]:"";t["legend"]=BX.type.isNotEmptyString(l["legend"])?l["legend"]:"";t["imageUrl"]=BX.type.isNotEmptyString(l["imageUrl"])?l["imageUrl"]:"";t["showUrl"]=BX.type.isNotEmptyString(l["showUrl"])?l["showUrl"]:""}else{var u=this.getServiceUrl(BX.type.isNotEmptyString(e["ENTITY_TYPE"])?e["ENTITY_TYPE"]:"");if(u!==""){var h=BX.CrmSipRecipientInfoLoader.create(BX.CrmParamBag.create({serviceUrl:u,recipient:t,params:e,anchor:n,callback:BX.delegate(this._onRecipientInfoLoad,this)}));h.process();return}}}this.openPreCallDialog(t,e,n,BX.delegate(this._onPreCallDialogClose,this))}else{this.makeCall(t,e)}},getMessage:function(t){return BX.CrmSipManager.messages&&BX.CrmSipManager.messages.hasOwnProperty(t)?BX.CrmSipManager.messages[t]:""},_onPreCallDialogClose:function(t,e,i,n){if(!i||typeof i!=="object"){i={}}this.makeCall(e,i)},_onRecipientInfoLoad:function(t,e,i,n,r){var s=BX.type.isNotEmptyString(i["ENTITY_TYPE"])?i["ENTITY_TYPE"]:"";var o=BX.type.isNotEmptyString(i["ENTITY_ID"])?i["ENTITY_ID"]:"";var a=s+"_"+o.toString();this._recipientInfos[a]=r;e["title"]=BX.type.isNotEmptyString(r["title"])?r["title"]:"";e["legend"]=BX.type.isNotEmptyString(r["legend"])?r["legend"]:"";e["imageUrl"]=BX.type.isNotEmptyString(r["imageUrl"])?r["imageUrl"]:"";e["showUrl"]=BX.type.isNotEmptyString(r["showUrl"])?r["showUrl"]:"";this.openPreCallDialog(e,i,n,BX.delegate(this._onPreCallDialogClose,this))}};BX.CrmSipManager.items={};BX.CrmSipManager.create=function(t,e){var i=new BX.CrmSipManager;i.initialize(t,e);this.items[t]=i;return i};BX.CrmSipManager.current=null;BX.CrmSipManager.getCurrent=function(){if(!this._current){this._current=this.create("_CURRENT",null)}return this._current};BX.CrmSipManager.startCall=function(t,e,i,n){this.getCurrent().startCall(t,e,i,n)};BX.CrmSipManager.resolveSipEntityTypeName=function(t){return BX.type.isNotEmptyString(t)?"CRM_"+t.toUpperCase():""};BX.CrmSipManager.ensureInitialized=function(t){var e=BX.type.isPlainObject(t["serviceUrls"])?t["serviceUrls"]:null;if(e){for(var i in e){if(!e.hasOwnProperty(i)){continue}BX.CrmSipManager.getCurrent().setServiceUrl(i,e[i])}}var n=BX.type.isPlainObject(t["messages"])?t["messages"]:null;if(n){BX.CrmSipManager.messages=n}}}if(typeof BX.CrmSipRecipientInfoLoader==="undefined"){BX.CrmSipRecipientInfoLoader=function(){this._settings=null;this._serviceUrl=null;this._recipient=null;this._params=null;this._anchor=null;this._callBack=null};BX.CrmSipRecipientInfoLoader.prototype={initialize:function(t){this._settings=t?t:BX.CrmParamBag.create(null);this._serviceUrl=this.getSetting("serviceUrl","");this._recipient=this.getSetting("recipient");if(!this._recipient){this._recipient={}}this._params=this.getSetting("params");if(!this._params){this._params={}}this._anchor=this.getSetting("anchor",null);this._callBack=this.getSetting("callback");if(!BX.type.isFunction(this._callBack)){this._callBack=null}},getSetting:function(t,e){return this._settings.getParam(t,e)},setSetting:function(t,e){return this._settings.setParam(t,e)},process:function(){var t=this._params;var e=BX.type.isNotEmptyString(t["ENTITY_TYPE"])?t["ENTITY_TYPE"]:"";var i=typeof t["ENTITY_ID"]!=="undefined"?parseInt(t["ENTITY_ID"]):0;var n=this._serviceUrl;var r=this._callBack;if(e===""||i<=0||n===""){if(BX.type.isFunction(this._callBack)){r(this,this._recipient,this._params,this._anchor,{})}return}BX.ajax({url:n,method:"POST",dataType:"json",data:{MODE:"GET_ENTITY_SIP_INFO",ENITY_TYPE:e,ENITY_ID:i},onsuccess:BX.delegate(this._onSuccess,this)})},_onSuccess:function(t){var e=this._callBack;if(!BX.type.isFunction(e)){return}var i=typeof t["DATA"]!=="undefined"?t["DATA"]:{};var n=BX.type.isNotEmptyString(i["TITLE"])?i["TITLE"]:"";var r=BX.type.isNotEmptyString(i["LEGEND"])?i["LEGEND"]:"";var s=BX.type.isNotEmptyString(i["IMAGE_URL"])?i["IMAGE_URL"]:"";var o=BX.type.isNotEmptyString(i["SHOW_URL"])?i["SHOW_URL"]:"";try{e(this,this._recipient,this._params,this._anchor,{title:n,legend:r,showUrl:o,imageUrl:s})}catch(t){}}};BX.CrmSipRecipientInfoLoader.create=function(t){var e=new BX.CrmSipRecipientInfoLoader;e.initialize(t);return e}}if(typeof BX.CrmPreCallDialog==="undefined"){BX.CrmPreCallDialog=function(){this._id="";this._settings=null;this._recipient=null;this._params=null;this._anchor=null;this._dlg=null;this._isShown=false;this._makeCallButton=null;this._closeCallBack=null;this._onMakeCallButtonClickHandler=BX.delegate(this._onMakeCallButtonClick,this)};BX.CrmPreCallDialog.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:BX.CrmParamBag.create(null);this._recipient=this.getSetting("recipient");if(!this._recipient){this._recipient={}}this._params=this.getSetting("params");if(!this._params){this._params={}}this._anchor=this.getSetting("anchor",null);this._closeCallBack=this.getSetting("closeCallback");if(!BX.type.isFunction(this._closeCallBack)){this._closeCallBack=null}},getSetting:function(t,e){return this._settings.getParam(t,e)},setSetting:function(t,e){return this._settings.setParam(t,e)},getId:function(){return this._id},getMessage:function(t){return BX.CrmSipManager.messages&&BX.CrmSipManager.messages.hasOwnProperty(t)?BX.CrmSipManager.messages[t]:""},show:function(){if(this._isShown){return}this._dlg=BX.PopupWindowManager.create(this._id.toLowerCase()+"-pre-call",this._anchor,{content:this._preparePreCallDialogContent(),closeIcon:true,closeByEsc:true,lightShadow:true,angle:{offset:5},zIndex:200,events:{onPopupClose:BX.delegate(this._onDialogClose,this)}});if(!this._dlg.isShown()){this._dlg.show()}this._isShown=this._dlg.isShown()},close:function(){if(!this._isShown){return}if(this._dlg){this._dlg.close();this._isShown=this._dlg.isShown()}else{this._isShown=false}},_preparePreCallDialogContent:function(){var t=this._recipient;var e=BX.create("DIV",{attrs:{className:"crm-tel-popup"}});var i=BX.create("DIV",{attrs:{className:"crm-tel-popup-user"}});e.appendChild(i);var n=BX.create("DIV",{attrs:{className:"crm-tel-avatar"}});var r=BX.type.isNotEmptyString(t["imageUrl"])?t["imageUrl"]:"";if(r!==""){n.style.background="url("+r+") no-repeat 3px 3px"}i.appendChild(n);i.appendChild(BX.create("DIV",{attrs:{className:"crm-tel-user-alignment"}}));var s=BX.type.isNotEmptyString(t["title"])?t["title"]:this.getMessage("unknownRecipient");var o=BX.type.isNotEmptyString(t["legend"])?t["legend"]:"";var a=BX.type.isNotEmptyString(t["showUrl"])?t["showUrl"]:"#";i.appendChild(BX.create("DIV",{attrs:{className:"crm-tel-user-data"},children:[BX.create("A",{attrs:{className:"crm-tel-user-name",target:"_blank",href:a},text:s}),BX.create("DIV",{attrs:{className:"crm-tel-user-organ"},text:o})]}));var l=BX.type.isNotEmptyString(t["number"])?t["number"]:"-";var u=this._id.toLowerCase()+"_enable_recordind";var h=BX.create("DIV",{attrs:{className:"crm-tel-popup-num-block"},children:[BX.create("DIV",{attrs:{className:"crm-tel-popup-num"},text:l})]});e.appendChild(h);var c=BX.create("DIV",{attrs:{className:"crm-tel-popup-footer"}});e.appendChild(c);this._makeCallButton=BX.create("SPAN",{attrs:{className:"crm-tel-popup-call-btn"},text:this.getMessage("makeCall")});BX.bind(this._makeCallButton,"click",this._onMakeCallButtonClickHandler);c.appendChild(this._makeCallButton);return e},_onMakeCallButtonClick:function(t){if(!this._isShown){return}if(this._dlg){this._dlg.close()}this._isShown=this._dlg?this._dlg.isShown():false;BX.unbind(this._makeCallButton,"click",this._onMakeCallButtonClickHandler);if(this._closeCallBack){try{this._closeCallBack(this,this._recipient,this._params,{})}catch(t){}}},_onDialogClose:function(t){if(this._dlg){this._dlg.destroy();this._dlg=null}this._isShown=false}};BX.CrmPreCallDialog.create=function(t,e){var i=new BX.CrmPreCallDialog;i.initialize(t,e);return i}}if(typeof BX.CrmBizprocDispatcher==="undefined"){BX.CrmBizprocDispatcher=function(){this._id="";this._settings={};this._container=null;this._wrapper=null;this._serviceUrl="";this._entityTypeName="";this._entityId=0;this._formId="";this._tabId="tab_bizproc";this._currentPage="";this._formManager=null;this._isRequestRunning=false;this._isLoaded=false;this._waiter=null;this._scrollHandler=BX.delegate(this._onWindowScroll,this);this._formManagerHandler=BX.delegate(this._onFormManagerCreate,this)};BX.CrmBizprocDispatcher.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_bp_disp_"+Math.random().toString().substring(2);this._settings=e?e:{};this._container=BX(this.getSetting("containerID",""));if(!this._container){throw"BX.CrmBizprocDispatcher. Could not find container."}this._wrapper=BX.findParent(this._container,{tagName:"DIV",className:"bx-edit-tab-inner"});this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"BX.CrmBizprocDispatcher. Could not find service url."}this._entityTypeName=this.getSetting("entityTypeName","");if(!BX.type.isNotEmptyString(this._entityTypeName)){throw"BX.CrmBizprocDispatcher. Could not find entity type name."}this._entityId=parseInt(this.getSetting("entityID",0));if(!BX.type.isNumber(this._entityId)||this._entityId<=0){throw"BX.CrmBizprocDispatcher. Could not find entity id."}this._formId=this.getSetting("formID","");if(!BX.type.isNotEmptyString(this._formId)){throw"BX.CrmBizprocDispatcher. Could not find form id."}var i=window["bxForm_"+this._formId];if(i){this.setFormManager(i)}else{BX.addCustomEvent(window,"CrmInterfaceFormCreated",this._formManagerHandler)}this._currentPage=this.getSetting("currentPage","")},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},getContainerRect:function(){var t=this._container.getBoundingClientRect();return{top:t.top,bottom:t.bottom,left:t.left,right:t.right,width:typeof t.width!=="undefined"?t.width:t.right-t.left,height:typeof t.height!=="undefined"?t.height:t.bottom-t.top}},isContanerInClientRect:function(){return this.getContainerRect().top<=document.documentElement.clientHeight},setFormManager:function(t){if(this._formManager===t){return}this._formManager=t;if(!this._formManager){return}if(this._formManager.GetActiveTabId()!==this._tabId){BX.addCustomEvent(window,"BX_CRM_INTERFACE_FORM_TAB_SELECTED",BX.delegate(this._onFormTabSelect,this))}else{if(this.isContanerInClientRect()){this.loadIndex()}else{BX.bind(window,"scroll",this._scrollHandler)}}},loadIndex:function(){if(this._isLoaded){return}if(this._currentPage==="index"){return}var t=this._startRequest("INDEX",{FORM_ID:this.getSetting("formID",""),PATH_TO_ENTITY_SHOW:this.getSetting("pathToEntityShow","")});if(t){this._currentPage="index"}},_startRequest:function(t,e){if(this._isRequestRunning){return false}this._isRequestRunning=true;this._waiter=BX.showWait(this._container);BX.ajax({url:this._serviceUrl,method:"POST",dataType:"html",data:{ACTION:t,ENTITY_TYPE_NAME:this._entityTypeName,ENTITY_ID:this._entityId,PARAMS:e},onsuccess:BX.delegate(this._onRequestSuccess,this),onfailure:BX.delegate(this._onRequestFailure,this)});return true},_onRequestSuccess:function(t){this._isRequestRunning=false;if(this._waiter){BX.closeWait(this._container,this._waiter);this._waiter=null}this._container.innerHTML=t;this._isLoaded=true},_onRequestFailure:function(t){this._isRequestRunning=false;if(this._waiter){BX.closeWait(this._container,this._waiter);this._waiter=null}this._isLoaded=true},_onFormManagerCreate:function(t){if(t["name"]===this._formId){BX.removeCustomEvent(window,"CrmInterfaceFormCreated",this._formManagerHandler);this.setFormManager(t)}},_onFormTabSelect:function(t,e,i,n){if(this._formId===e&&(i===this._tabId||this._wrapper===n)){this.loadIndex()}},_onWindowScroll:function(t){if(!this._isLoaded&&!this._isRequestRunning&&this.isContanerInClientRect()){BX.unbind(window,"scroll",this._scrollHandler);this.loadIndex()}}};BX.CrmBizprocDispatcher.items={};BX.CrmBizprocDispatcher.create=function(t,e){var i=new BX.CrmBizprocDispatcher;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmEntityTreeDispatcher==="undefined"){BX.CrmEntityTreeDispatcher=function(){this._id="";this._settings={};this._container=null;this._subContainer=null;this._wrapper=null;this._serviceUrl="";this._entityTypeName="";this._entityId=0;this._formId="";this._tabId="tab_tree";this._formManager=null;this._isRequestRunning=false;this._isLoaded=false;this._waiter=null;this._scrollHandler=BX.delegate(this._onWindowScroll,this);this._formManagerHandler=BX.delegate(this._onFormManagerCreate,this)};BX.CrmEntityTreeDispatcher.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_tree_disp_"+Math.random().toString().substring(2);this._settings=e?e:{};this._container=BX(this.getSetting("containerID",""));if(!this._container){throw"BX.CrmEntityTreeDispatcher. Could not find container."}this._wrapper=BX.findParent(this._container,{tagName:"DIV",className:"bx-edit-tab-inner"});this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"BX.CrmEntityTreeDispatcher. Could not find service url."}this._entityTypeName=this.getSetting("entityTypeName","");if(!BX.type.isNotEmptyString(this._entityTypeName)){throw"BX.CrmEntityTreeDispatcher. Could not find entity type name."}this._entityId=parseInt(this.getSetting("entityID",0));if(!BX.type.isNumber(this._entityId)||this._entityId<=0){throw"BX.CrmEntityTreeDispatcher. Could not find entity id."}this._formId=this.getSetting("formID","");if(!BX.type.isNotEmptyString(this._formId)){throw"BX.CrmEntityTreeDispatcher. Could not find form id."}var i=window["bxForm_"+this._formId];if(i){this.setFormManager(i);if(e.selected===true){i.SelectTab(this._tabId)}}else{BX.addCustomEvent(window,"CrmInterfaceFormCreated",this._formManagerHandler)}this._moreButtonClickHandler=BX.delegate(this._handleMoreButtonClickHandler,this);this._entityButtonClickHandler=BX.delegate(this._handleEntityButtonClickHandler,this)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},getContainerRect:function(){var t=this._container.getBoundingClientRect();return{top:t.top,bottom:t.bottom,left:t.left,right:t.right,width:typeof t.width!=="undefined"?t.width:t.right-t.left,height:typeof t.height!=="undefined"?t.height:t.bottom-t.top}},isContanerInClientRect:function(){return this.getContainerRect().top<=document.documentElement.clientHeight},setFormManager:function(t){if(this._formManager===t){return}this._formManager=t;if(!this._formManager){return}if(this._formManager.GetActiveTabId()!==this._tabId){BX.addCustomEvent(window,"BX_CRM_INTERFACE_FORM_TAB_SELECTED",BX.delegate(this._onFormTabSelect,this))}else{if(this.isContanerInClientRect()){this.loadIndex()}else{BX.bind(window,"scroll",this._scrollHandler)}}},_startRequest:function(t){if(this._isRequestRunning){return false}var e={FORM_ID:this.getSetting("formID",""),PATH_TO_LEAD_SHOW:this.getSetting("pathToLeadShow",""),PATH_TO_CONTACT_SHOW:this.getSetting("pathToContactShow",""),PATH_TO_COMPANY_SHOW:this.getSetting("pathToCompanyShow",""),PATH_TO_DEAL_SHOW:this.getSetting("pathToDealShow",""),PATH_TO_QUOTE_SHOW:this.getSetting("pathToQuoteShow",""),PATH_TO_INVOICE_SHOW:this.getSetting("pathToInvoiceShow",""),PATH_TO_USER_PROFILE:this.getSetting("pathToUserProfile","")};e=BX.mergeEx(e,t);this._isRequestRunning=true;this._waiter=BX.showWait(this._container);BX.ajax({url:this._serviceUrl,method:"POST",dataType:"html",data:{ADDITIONAL_PARAMS:"active_tab="+this._tabId,ENTITY_TYPE_NAME:e.ENTITY_TYPE_NAME?e.ENTITY_TYPE_NAME:this._entityTypeName,ENTITY_ID:e.ENTITY_ID?e.ENTITY_ID:this._entityId,PARAMS:e},onsuccess:BX.delegate(this._onRequestSuccess,this),onfailure:BX.delegate(this._onRequestFailure,this)});return true},_onRequestSuccess:function(t){this._isRequestRunning=false;if(this._waiter){BX.closeWait(this._container,this._waiter);this._waiter=null}if(this._subContainer!==null){BX.insertAfter(BX.create("DIV",{html:t}),this._subContainer)}else{this._container.innerHTML=t}this._isLoaded=true;var e=this;var i=BX.findChild(this._container,{class:"crm-entity-more"},true,true);var n=false;if(i){for(var r=0;r<i.length;r++){BX.bind(i[r],"click",this._moreButtonClickHandler)}}if(n){for(var r=0;r<n.length;r++){BX.bind(n[r],"click",this._entityButtonClickHandler)}}},_onRequestFailure:function(t){this._isRequestRunning=false;if(this._waiter){BX.closeWait(this._container,this._waiter);this._waiter=null}this._isLoaded=true},_handleMoreButtonClickHandler:function(){var t=BX.proxy_context;this._subContainer=BX.findParent(t);BX.remove(t);var e=parseInt(BX.data(t,"page"))+1;BX.data(t,"page",e);this._startRequest({BLOCK:BX.data(t,"block"),BLOCK_PAGE:e})},_handleEntityButtonClickHandler:function(t){var e=BX.proxy_context;this._subContainer=null;this._startRequest({ENTITY_ID:BX.data(e,"id"),ENTITY_TYPE_NAME:BX.data(e,"type")});t.preventDefault()},_onFormManagerCreate:function(t){if(t["name"]===this._formId){BX.removeCustomEvent(window,"CrmInterfaceFormCreated",this._formManagerHandler);this.setFormManager(t)}},_onFormTabSelect:function(t,e,i,n){if(this._formId===e&&(i===this._tabId||this._wrapper===n)){this._startRequest()}},_onWindowScroll:function(t){if(!this._isLoaded&&!this._isRequestRunning&&this.isContanerInClientRect()){BX.unbind(window,"scroll",this._scrollHandler);this._startRequest()}}};BX.CrmEntityTreeDispatcher.items={};BX.CrmEntityTreeDispatcher.create=function(t,e){var i=new BX.CrmEntityTreeDispatcher;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmLongRunningProcessState==="undefined"){BX.CrmLongRunningProcessState={intermediate:0,running:1,completed:2,stoped:3,error:4}}if(typeof BX.CrmLongRunningProcessDialog==="undefined"){BX.CrmLongRunningProcessDialog=function(){this._id="";this._settings={};this._serviceUrl="";this._controller="";this._method="POST";this._params={};this._option={};this._initialOptions={};this._dlg=null;this._buttons={};this._summary=null;this._progressUI=null;this._progressbar=null;this._initialOptionsBlock=null;this._isSummaryHtml=false;this._isShown=false;this._state=BX.CrmLongRunningProcessState.intermediate;this._cancelRequest=false;this._requestIsRunning=false;this._networkErrorCount=0;this._requestHandler=null};BX.CrmLongRunningProcessDialog.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_long_run_proc_"+Math.random().toString().substring(2);this._settings=e?e:{};this._method=this.getSetting("method","POST");this._controller=this.getSetting("controller","");this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._controller)&&!BX.type.isNotEmptyString(this._serviceUrl)){throw"BX.CrmLongRunningProcess. Could not find service url or ajax controller."}this._action=this.getSetting("action","");if(!BX.type.isNotEmptyString(this._action)){throw"BX.CrmLongRunningProcess. Could not find action."}this._params=this.getSetting("params");if(!this._params){this._params={}}this._initialOptions=this.getSetting("initialOptions");if(!this._initialOptions){this._initialOptions={}}this._isSummaryHtml=!!this.getSetting("isSummaryHtml",false);if(typeof BX.UI!="undefined"&&typeof BX.UI.ProgressBar!="undefined"){this._progressUI=new BX.UI.ProgressBar({statusType:BX.UI.ProgressBar.Status.COUNTER,size:BX.UI.ProgressBar.Size.LARGE,fill:true})}this._requestHandler=this.getSetting("requestHandler",null)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},getMessage:function(t){return BX.CrmLongRunningProcessDialog.messages&&BX.CrmLongRunningProcessDialog.messages.hasOwnProperty(t)?BX.CrmLongRunningProcessDialog.messages[t]:""},getState:function(){return this._state},getServiceUrl:function(){return this._serviceUrl},getAction:function(){return this._action},setAction:function(t){this._action=t},getParams:function(){return this._params},show:function(){if(this._isShown){return}this._dlg=BX.PopupWindowManager.create(this._id.toLowerCase(),this._anchor,{className:"bx-crm-dialog-wrap bx-crm-dialog-long-run-proc",autoHide:false,bindOptions:{forceBindPosition:false},buttons:this._prepareDialogButtons(),closeByEsc:false,closeIcon:false,content:this._prepareDialogContent(),draggable:true,events:{onPopupClose:BX.delegate(this._onDialogClose,this)},offsetLeft:0,offsetTop:0,titleBar:this.getSetting("title",""),overlay:true});if(!this._dlg.isShown()){this._dlg.show()}this._isShown=this._dlg.isShown()},close:function(){if(!this._isShown){return}if(this._dlg){this._dlg.close()}this._isShown=false},start:function(){if(this._state===BX.CrmLongRunningProcessState.intermediate||this._state===BX.CrmLongRunningProcessState.stoped||this._state===BX.CrmLongRunningProcessState.completed){this._startRequest()}},stop:function(){if(this._state===BX.CrmLongRunningProcessState.running){this._stopRequest()}},_prepareDialogContent:function(){var t=this.getSetting("summary","");var e={attrs:{className:"bx-crm-dialog-long-run-proc-summary"}};if(this._isSummaryHtml){e["html"]=t}else{e["text"]=t}this._summary=BX.create("DIV",e);if(this._progressUI){this._progressbar=BX.create("DIV",{attrs:{className:"bx-crm-dialog-long-run-proc-progressbar"},style:{display:"none"},children:[this._progressUI.getContainer()]})}var i,n,r,s,o=0;for(n in this._initialOptions){if(this._initialOptions.hasOwnProperty(n)){i=this._initialOptions[n];if(BX.type.isPlainObject(i)&&i.hasOwnProperty("name")&&i.hasOwnProperty("type")&&i.hasOwnProperty("title")&&i.hasOwnProperty("value")){r=null;switch(i["type"]){case"checkbox":s=this._id+"_opt_"+n;var a={id:s,type:i["type"],name:n};if(i["value"]==="Y")a["checked"]="checked";r=BX.create("DIV",{children:[BX.create("SPAN",{children:[BX.create("INPUT",{attrs:a}),BX.create("LABEL",{attrs:{for:s},text:i["title"]})]})]});a=null;break}if(r!==null){if(this._initialOptionsBlock===null){this._initialOptionsBlock=BX.create("DIV",{attrs:{className:"bx-crm-dialog-long-run-proc-options"}})}this._initialOptionsBlock.appendChild(r);o++}}}}var l=[this._summary];if(this._progressbar)l.push(this._progressbar);if(this._initialOptionsBlock)l.push(this._initialOptionsBlock);return BX.create("DIV",{attrs:{className:"bx-crm-dialog-long-run-proc-popup"},children:l})},_prepareDialogButtons:function(){this._buttons={};var t=this.getMessage("startButton");this._buttons["start"]=new BX.PopupWindowButton({text:t!==""?t:"Start",className:"popup-window-button-accept",events:{click:BX.delegate(this._handleStartButtonClick,this)}});var e=this.getMessage("stopButton");this._buttons["stop"]=new BX.PopupWindowButton({text:e!==""?e:"Stop",className:"popup-window-button-disable",events:{click:BX.delegate(this._handleStopButtonClick,this)}});var i=this.getMessage("closeButton");this._buttons["close"]=new BX.PopupWindowButtonLink({text:i!==""?i:"Close",className:"popup-window-button-link-cancel",events:{click:BX.delegate(this._handleCloseButtonClick,this)}});return[this._buttons["start"],this._buttons["stop"],this._buttons["close"]]},_onDialogClose:function(t){if(this._dlg){this._dlg.destroy();this._dlg=null}this._setState(BX.CrmLongRunningProcessState.intermediate);this._buttons={};this._summary=null;this._isShown=false;BX.onCustomEvent(this,"ON_CLOSE",[this])},_handleStartButtonClick:function(){var t=typeof this._buttons["start"]!=="undefined"?this._buttons["start"]:null;if(t){var e=BX.data(t.buttonNode,"disabled");if(e===true){return}}this.start()},_handleStopButtonClick:function(){var t=typeof this._buttons["stop"]!=="undefined"?this._buttons["stop"]:null;if(t){var e=BX.data(t.buttonNode,"disabled");if(e===true){return}}this.stop()},_handleCloseButtonClick:function(){if(this._state!==BX.CrmLongRunningProcessState.running){this._dlg.close()}},_lockButton:function(t,e){var i=typeof this._buttons[t]!=="undefined"?this._buttons[t]:null;if(!i){return}if(!!e){BX.removeClass(i.buttonNode,"popup-window-button-accept");BX.addClass(i.buttonNode,"popup-window-button-disable");i.buttonNode.disabled=true;BX.data(i.buttonNode,"disabled",true)}else{BX.removeClass(i.buttonNode,"popup-window-button-disable");BX.addClass(i.buttonNode,"popup-window-button-accept");i.buttonNode.disabled=false;BX.data(i.buttonNode,"disabled",false)}},_showButton:function(t,e){var i=typeof this._buttons[t]!=="undefined"?this._buttons[t]:null;if(i){i.buttonNode.style.display=!!e?"":"none"}},_setSummary:function(t,e){if(this._initialOptionsBlock){BX.remove(this._initialOptionsBlock);this._initialOptionsBlock=null}e=!!e;if(this._summary){if(e)this._summary.innerHTML=t;else this._summary.innerHTML=BX.util.htmlspecialchars(t)}},_setProgressBar:function(t,e){if(this._progressUI){if(BX.type.isNumber(e)&&BX.type.isNumber(t)&&t>0){BX.show(this._progressbar);this._progressUI.setMaxValue(t);this._progressUI.update(e)}else{BX.hide(this._progressbar)}}},_setState:function(t){if(this._state===t){return}this._state=t;if(t===BX.CrmLongRunningProcessState.intermediate||t===BX.CrmLongRunningProcessState.stoped){this._lockButton("start",false);this._lockButton("stop",true);this._showButton("close",true)}else if(t===BX.CrmLongRunningProcessState.running){this._lockButton("start",true);this._lockButton("stop",false);this._showButton("close",false)}else if(t===BX.CrmLongRunningProcessState.completed||t===BX.CrmLongRunningProcessState.error){this._lockButton("start",true);this._lockButton("stop",true);this._showButton("close",true)}if(this._progressUI){if(t===BX.CrmLongRunningProcessState.completed){BX.hide(this._progressbar)}if(t===BX.CrmLongRunningProcessState.error){this._progressUI.setColor(BX.UI.ProgressBar.Color.DANGER)}}BX.onCustomEvent(this,"ON_STATE_CHANGE",[this])},_startRequest:function(){if(this._requestIsRunning){return}this._requestIsRunning=true;this._setState(BX.CrmLongRunningProcessState.running);var t=BX.type.isNotEmptyString(this._controller);var e;if(t){e=BX.clone(this._params)}else{e={ACTION:this._action,PARAMS:this._params}}if(this._initialOptionsBlock){this._option={};var i={};var n=0;var r,s,o,a,l,u;for(s in this._initialOptions){if(this._initialOptions.hasOwnProperty(s)){r=this._initialOptions[s];if(BX.type.isPlainObject(r)&&r.hasOwnProperty("name")&&r.hasOwnProperty("type")&&r.hasOwnProperty("title")&&r.hasOwnProperty("value")){u=false;switch(r["type"]){case"checkbox":o=this._id+"_opt_"+s;a=BX(o);if(a){l=a.checked?"Y":"N";u=true}break}if(u){i[s]=l;n++}}}}if(n>0){this._option=i;e["INITIAL_OPTIONS"]=i}}else if(BX.type.isNotEmptyObject(this._option)){e["INITIAL_OPTIONS"]=this._option}if(t){BX.ajax.runAction(this._controller+"."+this._action,{data:e,method:this._method}).then(BX.delegate(this._onRequestSuccess,this),BX.delegate(this._onRequestFailure,this))}else{BX.ajax({url:this._serviceUrl,method:this._method,dataType:"json",data:e,onsuccess:BX.delegate(this._onRequestSuccess,this),onfailure:BX.delegate(this._onRequestFailure,this)})}},_stopRequest:function(){if(this._cancelRequest){return}this._cancelRequest=true;this._requestIsRunning=false;this._setState(BX.CrmLongRunningProcessState.stoped);var t=BX.type.isNotEmptyString(this._controller);var e;if(t){e=BX.clone(this._params);BX.ajax.runAction(this._controller+".cancel",{data:e,method:this._method}).then(BX.delegate(this._onRequestSuccess,this),BX.delegate(this._onRequestFailure,this))}},_onRequestSuccess:function(t){this._requestIsRunning=false;if(!t){this._setSummary(this.getMessage("requestError"));this._setState(BX.CrmLongRunningProcessState.error);return}var e=BX.type.isNotEmptyString(this._controller);if(e){if(BX.type.isArray(t["errors"])&&t["errors"].length>0){var i=t["errors"][t["errors"].length-1];this._setState(BX.CrmLongRunningProcessState.error);this._setSummary(i.message);return}}else if(BX.type.isNotEmptyString(t["ERROR"])){this._setState(BX.CrmLongRunningProcessState.error);this._setSummary(t["ERROR"]);return}if(e){t=t["data"]}if(typeof this._requestHandler=="function"){this._requestHandler.call(this,t)}this._networkErrorCount=0;var n=BX.type.isNotEmptyString(t["STATUS"])?t["STATUS"]:"";var r=BX.type.isNotEmptyString(t["SUMMARY"])?t["SUMMARY"]:"";var s=false;if(!BX.type.isNotEmptyString(r)){r=BX.type.isNotEmptyString(t["SUMMARY_HTML"])?t["SUMMARY_HTML"]:"";s=true}if(n==="PROGRESS"){var o=BX.type.isNumber(t["PROCESSED_ITEMS"])?t["PROCESSED_ITEMS"]:0;var a=BX.type.isNumber(t["TOTAL_ITEMS"])?t["TOTAL_ITEMS"]:0;if(a>0){this._setProgressBar(a,o)}if(r!==""){this._setSummary(r,s)}if(this._cancelRequest){this._setState(BX.CrmLongRunningProcessState.stoped);this._cancelRequest=false}else{var l=BX.type.isNotEmptyString(t["NEXT_ACTION"])?t["NEXT_ACTION"]:"";if(l!==""){this._action=l}window.setTimeout(BX.delegate(this._startRequest,this),200)}return}if(n==="NOT_REQUIRED"||n==="COMPLETED"){this._setState(BX.CrmLongRunningProcessState.completed);if(r!==""){this._setSummary(r,s)}}else{this._setSummary(this.getMessage("requestError"));this._setState(BX.CrmLongRunningProcessState.error)}if(this._cancelRequest){this._cancelRequest=false}},_onRequestFailure:function(t){this._requestIsRunning=false;var e=BX.type.isNotEmptyString(this._controller);if(e){if(BX.type.isArray(t["errors"])&&t["errors"].length>0){var i=t["errors"][t["errors"].length-1];if(i.code==="NETWORK_ERROR"){this._networkErrorCount++;if(this._networkErrorCount<=2){window.setTimeout(BX.delegate(this._startRequest,this),15e3);return}}this._setSummary(i.message)}else{this._setSummary(this.getMessage("requestError"))}}else{this._setSummary(this.getMessage("requestError"))}this._setState(BX.CrmLongRunningProcessState.error)}};if(typeof BX.CrmLongRunningProcessDialog.messages=="undefined"){BX.CrmLongRunningProcessDialog.messages={}}BX.CrmLongRunningProcessDialog.items={};BX.CrmLongRunningProcessDialog.create=function(t,e){var i=new BX.CrmLongRunningProcessDialog;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmEntityType==="undefined"){BX.CrmEntityType=function(){};BX.CrmEntityType.dynamicTypeStart=128;BX.CrmEntityType.dynamicTypeEnd=192;BX.CrmEntityType.dynamicTypeNamePrefix="DYNAMIC_";BX.CrmEntityType.dynamicTypeAbbreviationPrefix="T";BX.CrmEntityType.enumeration={undefined:0,lead:1,deal:2,contact:3,company:4,invoice:5,activity:6,quote:7,wait:11,dealrecurring:13,order:14,ordershipment:16,orderpayment:17,smartinvoice:31,storeDocument:33,shipmentDocument:34,smartdocument:36,agentcontract:38,document:12};BX.CrmEntityType.names={undefined:"",lead:"LEAD",deal:"DEAL",contact:"CONTACT",company:"COMPANY",invoice:"INVOICE",activity:"ACTIVITY",quote:"QUOTE",wait:"WAIT",dealrecurring:"DEAL_RECURRING",order:"ORDER",ordershipment:"ORDER_SHIPMENT",orderpayment:"ORDER_PAYMENT",ordercheck:"ORDER_CHECK",smartinvoice:"SMART_INVOICE",dynamic:"DYNAMIC",smartdocument:"SMART_DOCUMENT",agentcontract:"AGENT_CONTRACT"};BX.CrmEntityType.abbreviations={undefined:"",lead:"L",deal:"D",contact:"C",company:"CO",invoice:"I",quote:"Q",order:"O",ordershipment:"OS",orderpayment:"OP",smartinvoice:"SI",smartdocument:"DO",agentcontract:"AC"};BX.CrmEntityType.isDefined=function(t){if(!BX.type.isNumber(t)){t=parseInt(t);if(isNaN(t)){t=0}}var e=Object.values(this.enumeration);var i=e.indexOf(t)!==-1&&t!==this.enumeration.undefined;var n=this.isDynamicTypeByTypeId(t);return i||n};BX.CrmEntityType.resolveName=function(t){if(!BX.type.isNumber(t)){t=parseInt(t);if(isNaN(t)){t=0}}if(t===BX.CrmEntityType.enumeration.lead){return BX.CrmEntityType.names.lead}else if(t===BX.CrmEntityType.enumeration.deal){return BX.CrmEntityType.names.deal}else if(t===BX.CrmEntityType.enumeration.dealrecurring){return BX.CrmEntityType.names.dealrecurring}else if(t===BX.CrmEntityType.enumeration.contact){return BX.CrmEntityType.names.contact}else if(t===BX.CrmEntityType.enumeration.company){return BX.CrmEntityType.names.company}else if(t===BX.CrmEntityType.enumeration.invoice){return BX.CrmEntityType.names.invoice}else if(t===BX.CrmEntityType.enumeration.activity){return BX.CrmEntityType.names.activity}else if(t===BX.CrmEntityType.enumeration.quote){return BX.CrmEntityType.names.quote}else if(t===BX.CrmEntityType.enumeration.wait){return BX.CrmEntityType.names.wait}else if(t===BX.CrmEntityType.enumeration.order){return BX.CrmEntityType.names.order}else if(t===BX.CrmEntityType.enumeration.ordershipment){return BX.CrmEntityType.names.ordershipment}else if(t===BX.CrmEntityType.enumeration.orderpayment){return BX.CrmEntityType.names.orderpayment}else if(t===BX.CrmEntityType.enumeration.smartinvoice){return BX.CrmEntityType.names.smartinvoice}else if(t===BX.CrmEntityType.enumeration.smartdocument){return BX.CrmEntityType.names.smartdocument}else if(t===BX.CrmEntityType.enumeration.agentcontract){return BX.CrmEntityType.names.agentcontract}else if(BX.CrmEntityType.isDynamicTypeByTypeId(t)){return BX.CrmEntityType.getDynamicTypeName(t)}else{return""}};BX.CrmEntityType.resolveId=function(t){t=t.toUpperCase();if(t===BX.CrmEntityType.names.lead){return this.enumeration.lead}else if(t===BX.CrmEntityType.names.deal){return this.enumeration.deal}else if(t===BX.CrmEntityType.names.dealrecurring){return this.enumeration.dealrecurring}else if(t===BX.CrmEntityType.names.contact){return this.enumeration.contact}else if(t===BX.CrmEntityType.names.company){return this.enumeration.company}else if(t===BX.CrmEntityType.names.invoice){return this.enumeration.invoice}else if(t===BX.CrmEntityType.names.activity){return this.enumeration.activity}else if(t===BX.CrmEntityType.names.quote){return this.enumeration.quote}else if(t===BX.CrmEntityType.names.order){return this.enumeration.order}else if(t===BX.CrmEntityType.names.ordershipment){return this.enumeration.ordershipment}else if(t===BX.CrmEntityType.names.orderpayment){return this.enumeration.orderpayment}else if(t===BX.CrmEntityType.names.wait){return this.enumeration.wait}else if(t===BX.CrmEntityType.names.smartinvoice){return this.enumeration.smartinvoice}else if(t===BX.CrmEntityType.names.smartdocument){return this.enumeration.smartdocument}else if(t===BX.CrmEntityType.names.agentcontract){return this.enumeration.agentcontract}else if(BX.CrmEntityType.isDynamicTypeByName(t)){return this.getTypeIdFromDynamicTypeName(t)}else{return this.enumeration.undefined}};BX.CrmEntityType.resolveAbbreviation=function(t){t=t.toUpperCase();if(t===BX.CrmEntityType.names.lead){return this.abbreviations.lead}else if(t===BX.CrmEntityType.names.deal){return this.abbreviations.deal}else if(t===BX.CrmEntityType.names.contact){return this.abbreviations.contact}else if(t===BX.CrmEntityType.names.company){return this.abbreviations.company}else if(t===BX.CrmEntityType.names.invoice){return this.abbreviations.invoice}else if(t===BX.CrmEntityType.names.order){return this.abbreviations.order}else if(t===BX.CrmEntityType.names.ordershipment){return this.abbreviations.ordershipment}else if(t===BX.CrmEntityType.names.orderpayment){return this.abbreviations.orderpayment}else if(t===BX.CrmEntityType.names.smartinvoice){return this.abbreviations.smartinvoice}else if(BX.CrmEntityType.isDynamicTypeByName(t)){var e=this.getTypeIdFromDynamicTypeName(t);return this.getDynamicTypeAbbreviation(e)}else{return this.abbreviations.undefined}};BX.CrmEntityType.isDynamicTypeByTypeId=function(t){t=Number(t);return t>=this.dynamicTypeStart&&t<this.dynamicTypeEnd};BX.CrmEntityType.isUseFactoryBasedApproach=function(t){t=Number(t);return t===this.enumeration.quote||t===this.enumeration.smartinvoice||t===this.enumeration.smartdocument||this.isDynamicTypeByTypeId(t)};BX.CrmEntityType.isDynamicTypeByName=function(t){t=String(t);var e=t.indexOf(this.dynamicTypeNamePrefix)===0;var i=this.isDynamicTypeByTypeId(this.getTypeIdFromDynamicTypeName(t));return e&&i};BX.CrmEntityType.isUseDynamicTypeBasedApproach=function(t){t=Number(t);return t===BX.CrmEntityType.enumeration.smartinvoice||t===BX.CrmEntityType.enumeration.smartdocument||BX.CrmEntityType.isDynamicTypeByTypeId(t)};BX.CrmEntityType.isUseDynamicTypeBasedApproachByName=function(t){t=String(t);if(t===BX.CrmEntityType.names.smartinvoice){return true}if(t===BX.CrmEntityType.names.smartdocument){return true}return BX.CrmEntityType.isDynamicTypeByName(t)};BX.CrmEntityType.isUseFactoryBasedApproachByName=function(t){t=String(t);if(t===BX.CrmEntityType.names.quote){return true}return BX.CrmEntityType.isUseDynamicTypeBasedApproachByName(t)};BX.CrmEntityType.getDynamicTypeName=function(t){return this.dynamicTypeNamePrefix+t};BX.CrmEntityType.getDynamicTypeAbbreviation=function(t){return this.dynamicTypeAbbreviationPrefix+this.normalizeTypeIdForAbbreviation(t)};BX.CrmEntityType.normalizeTypeIdForAbbreviation=function(t){t=Number(t);return t.toString(16)};BX.CrmEntityType.getTypeIdFromDynamicTypeName=function(t){t=String(t);var e=t.replace(this.dynamicTypeNamePrefix,"");return parseInt(e)};BX.CrmEntityType.verifyName=function(t){if(!BX.type.isNotEmptyString(t)){return""}t=t.toUpperCase();return this.resolveId(t)!==this.enumeration.undefined?t:""};BX.CrmEntityType.setCaptions=function(t){if(BX.type.isPlainObject(t)){this.captions=t}};BX.CrmEntityType.getCaption=function(t){var e=this.resolveName(t);return this.captions.hasOwnProperty(e)?this.captions[e]:e};BX.CrmEntityType.getCaptionByName=function(t){if(!BX.type.isNotEmptyString(t)){return""}t=t.toUpperCase();return this.captions.hasOwnProperty(t)?this.captions[t]:t};BX.CrmEntityType.setNotFoundMessages=function(t){if(BX.type.isPlainObject(t)){this.notFoundMessages=t}};BX.CrmEntityType.getNotFoundMessage=function(t){var e=this.resolveName(t);var i=null;if(this.notFoundMessages.hasOwnProperty(e)){i=this.notFoundMessages[e]}if(!i&&this.notFoundMessages.hasOwnProperty(BX.CrmEntityType.names.dynamic)){i=this.notFoundMessages[BX.CrmEntityType.names.dynamic]}if(!i){i=e}return i};BX.CrmEntityType.getNotFoundMessageByName=function(t){if(!BX.type.isNotEmptyString(t)){return""}t=t.toUpperCase();return this.notFoundMessages.hasOwnProperty(t)?this.notFoundMessages[t]:t};BX.CrmEntityType.prepareEntityKey=function(t,e){var i=this.resolveAbbreviation(t);return i!==""?i+"_"+e.toString():""};if(typeof BX.CrmEntityType.captions==="undefined"){BX.CrmEntityType.captions={}}if(typeof BX.CrmEntityType.categoryCaptions==="undefined"){BX.CrmEntityType.categoryCaptions={}}}if(typeof BX.CrmDuplicateManager==="undefined"){BX.CrmDuplicateManager=function(){this._id="";this._settings={};this._entityTypeName="";this._processDialogs={}};BX.CrmDuplicateManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_dp_mgr_"+Math.random().toString().substring(2);this._settings=e?e:{};this._entityTypeName=this.getSetting("entityTypeName","");if(!BX.type.isNotEmptyString(this._entityTypeName)){throw"BX.CrmDuplicateManager. Could not find entity type name."}this._entityTypeName=this._entityTypeName.toUpperCase()},getId:function(){return this._id},getEntityTypeName:function(){return this._entityTypeName},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},getMessage:function(t){return BX.CrmDuplicateManager.messages&&BX.CrmDuplicateManager.messages.hasOwnProperty(t)?BX.CrmDuplicateManager.messages[t]:""},rebuildIndex:function(){var t=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(t)){throw"BX.CrmDuplicateManager. Could not find service url."}var e=this._entityTypeName.toLowerCase().replace(/(?:^)\S/,(function(t){return t.toUpperCase()}));var i="rebuild"+e+"Index";var n=null;if(typeof this._processDialogs[i]!=="undefined"){n=this._processDialogs[i]}else{n=BX.CrmLongRunningProcessDialog.create(i,{serviceUrl:t,action:"REBUILD_DUPLICATE_INDEX",params:{ENTITY_TYPE_NAME:this._entityTypeName},title:this.getMessage(i+"DlgTitle"),summary:this.getMessage(i+"DlgSummary")});this._processDialogs[i]=n;BX.addCustomEvent(n,"ON_STATE_CHANGE",BX.delegate(this._onProcessStateChange,this))}n.show()},_onProcessStateChange:function(t){var e=t.getId();if(typeof this._processDialogs[e]!=="undefined"){var i=this._processDialogs[e];if(i.getState()===BX.CrmLongRunningProcessState.completed){BX.onCustomEvent(this,"ON_"+this._entityTypeName+"_INDEX_REBUILD_COMPLETE",[this])}}}};if(typeof BX.CrmDuplicateManager.messages=="undefined"){BX.CrmDuplicateManager.messages={}}BX.CrmDuplicateManager.items={};BX.CrmDuplicateManager.create=function(t,e){var i=new BX.CrmDuplicateManager;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmDupController==="undefined"){BX.CrmDupController=function(){this._id="";this._settings={};this._entityTypeName="";this._entityId=0;this._enable=true;this._groups={};this._requestIsRunning=false;this._request=null;this._searchData={};this._searchSummary=null;this._warningDialog=null;this._submits=[];this._lastSummaryGroupId="";this._lastSummaryFieldId="";this._lastSubmit=null;this._submitClickHandler=BX.delegate(this._onSubmitClick,this);this._beforeFormSubmitHandler=BX.delegate(this._onBeforeFormSubmit,this);this._startDestroy=false};BX.CrmDupController.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_dp_ctrl_"+Math.random().toString().substring(2);this._settings=e?e:{};this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"BX.CrmDupController. Could not find service url."}this._bind();this._entityTypeName=this.getSetting("entityTypeName","");this._entityId=this.getSetting("entityId",0);this._ignoredItems=BX.prop.getArray(this._settings,"ignoredItems",[]);var i=this.getSetting("groups",null);var n=null;if(i){for(var r in i){if(!i.hasOwnProperty(r)){continue}n=i[r];var s=BX.type.isNotEmptyString(n["groupType"])?n["groupType"]:"";var o=null;try{if(s==="single"){o=BX.CrmDupCtrlSingleField.create(r,n)}else if(s==="fullName"){o=BX.CrmDupCtrlFullName.create(r,n)}else if(s==="communication"){o=BX.CrmDupCtrlCommunication.create(r,n)}}catch(t){}if(o){this.addGroup(o)}}}this._afterInitialize();this.initialSearch()},initialSearch:function(t){var e=[];var i=BX.type.isPlainObject(t)?t:this._groups;for(var n in i){if(!i.hasOwnProperty(n)){continue}var r=i[n];var s=r.prepareSearchParams();if(!s){continue}s["GROUP_ID"]=n;s["HASH_CODE"]=r.getSearchHashCode();s["FIELD_ID"]=r.getDefaultSearchSummaryFieldId();e.push(s)}if(e.length>0){this._search({GROUPS:e})}},destroy:function(){this._startDestroy=true;this._unbind();for(var t in this._groups){if(this._groups.hasOwnProperty(t))this.deleteGroup(t)}},_afterInitialize:function(){BX.onCustomEvent("CrmDupControllerAfterInitialize",[this])},getId:function(){return this._id},getEntityTypeName:function(){return this._entityTypeName},isEnabled:function(){return this._enable},enable:function(t){this._enable=!!t},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},registerGroup:function(t,e){var i=BX.type.isNotEmptyString(e["groupType"])?e["groupType"]:"";var n=null;try{if(i==="single"){n=BX.CrmDupCtrlSingleField.create(t,e)}else if(i==="fullName"){n=BX.CrmDupCtrlFullName.create(t,e)}else if(i==="communication"){n=BX.CrmDupCtrlCommunication.create(t,e)}}catch(t){}if(n){this.addGroup(n)}return n},unregisterGroup:function(t){if(!this._groups.hasOwnProperty(t)){return}delete[this._groups[t]]},addGroup:function(t){this._groups[t.getId()]=t;t.setController(this);return t},getGroup:function(t){return this._groups.hasOwnProperty(t)?this._groups[t]:null},deleteGroup:function(t){var e=false;if(BX.type.isNotEmptyString(t)&&this._groups.hasOwnProperty(t)){this._groups[t].clearFields();if(typeof this._searchData[t]!=="undefined"){delete this._searchData[t];this._refreshSearchSummary(t,"")}delete this._groups[t];e=true}return e},getDuplicateData:function(){return this._searchData},hasDuplicates:function(){for(var t in this._searchData){if(!this._searchData.hasOwnProperty(t)){continue}var e=this._searchData[t];if(e.hasOwnProperty("items")&&e["items"].length>0){return true}}return false},processGroupChange:function(t,e){var i=t.getId();var n=t.prepareSearchParams();if(!n){if(typeof this._searchData[i]!=="undefined"&&e){delete this._searchData[i];this._refreshSearchSummary(i,e.getId())}return}var r=t.getSearchHashCode();if(r!==this._getGroupSearchHashCode(i)){n["GROUP_ID"]=i;if(e){n["FIELD_ID"]=e.getId()}n["HASH_CODE"]=r;this._search({GROUPS:[n]})}},processGroupsChange:function(t){if(BX.type.isPlainObject(t)){var e=[];for(var i in t){if(t.hasOwnProperty(i)){var n=t[i]["group"];var r=t[i]["fields"];var s=n.prepareSearchParams();if(s){for(var o=0;o<r.length;o++){var a=n.getSearchHashCode();if(a!==this._getGroupSearchHashCode(i)){s["GROUP_ID"]=i;s["FIELD_ID"]=r[o].getId();s["HASH_CODE"]=a;e.push(s)}}}else{for(var o=0;o<r.length;o++){if(typeof this._searchData[i]!=="undefined"){delete this._searchData[i];this._refreshSearchSummary(i,r[o].getId())}}}}}if(e.length>0){this._search({GROUPS:e})}}},_bind:function(){var t=this.getSetting("submits",[]);if(BX.type.isArray(t)){for(var e=0;e<t.length;e++){var i=BX(t[e]);if(BX.type.isElementNode(i)){this._submits.push(i);BX.bind(i,"click",this._submitClickHandler)}}}},_unbind:function(){for(var t=0;t<this._submits.length;t++){BX.unbind(this._submits[t],"click",this._submitClickHandler)}},_search:function(t){if(this._requestIsRunning){this._stopSearchRequest()}t["ENTITY_TYPE_NAME"]=this._entityTypeName;t["ENTITY_ID"]=this._entityId;if(this._ignoredItems&&this._ignoredItems.length){t["IGNORED_ITEMS"]=this._ignoredItems}this._startSearchRequest(t)},_startSearchRequest:function(t){if(this._requestIsRunning){return}BX.showWait();this._requestIsRunning=true;this._request=BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"FIND_DUPLICATES",PARAMS:t,sessid:BX.bitrix_sessid()},onsuccess:BX.delegate(this._onSearchRequestSuccsess,this),onfailure:BX.delegate(this._onSearchRequestFailure,this)})},_stopSearchRequest:function(){if(!this._requestIsRunning){return}this._requestIsRunning=false;if(this._request){this._request.abort();this._request=null}BX.closeWait()},_onSearchRequestSuccsess:function(t){BX.closeWait();if(this._startDestroy)return;this._requestIsRunning=false;if(!t){return}if(BX.type.isNotEmptyString(t["ERROR"])){return}var e="";var i="";var n=BX.type.isArray(t["GROUP_RESULTS"])?t["GROUP_RESULTS"]:[];for(var r=0;r<n.length;r++){var s=n[r];var o=typeof s["GROUP_ID"]!=="undefined"?s["GROUP_ID"]:"";if(!BX.type.isNotEmptyString(o)){return}var a=this.getGroup(o);if(!a){return}if(typeof this._searchData[o]==="undefined"){this._searchData[o]={}}var l=BX.type.isArray(s["DUPLICATES"])?s["DUPLICATES"]:[];if(l.length>0){this._searchData[o]["items"]=BX.type.isArray(s["DUPLICATES"])?s["DUPLICATES"]:[];this._searchData[o]["totalText"]=BX.type.isNotEmptyString(s["ENTITY_TOTAL_TEXT"])?s["ENTITY_TOTAL_TEXT"]:"";var u=0;if(typeof s["HASH_CODE"]!=="undefined"){u=parseInt(s["HASH_CODE"]);if(isNaN(u)){u=0}}this._searchData[o]["hash"]=u;if(BX.type.isNotEmptyString(s["FIELD_ID"])){e=o;i=s["FIELD_ID"]}}else{delete this._searchData[o]}}this._refreshSearchSummary(e,i)},_refreshSearchSummary:function(t,e){if(!BX.type.isNotEmptyString(t)){t=""}if(!BX.type.isNotEmptyString(e)){e=""}if(this.hasDuplicates()){var i=null;if(t===""||e===""){t=this._lastSummaryGroupId;e=this._lastSummaryFieldId}if(t!==""&&e!==""){var n=this.getGroup(t);if(n){i=n.getField(e)}this._lastSummaryGroupId=t;this._lastSummaryFieldId=e}if(this._isSearchSummaryShown()){this._replaceShownSearchSummary(i)}else{this._showSearchSummary(i)}}else{this._closeSearchSummary()}},_onSearchRequestFailure:function(t){BX.closeWait();this._requestIsRunning=false},_onBeforeFormSubmit:function(t,e){if(BX.prop.get(BX.prop.getObject(e,"options",{}),"originator",null)===this){return}if(this.hasDuplicates()){e["cancel"]=true;window.setTimeout(BX.delegate(this._openWarningDialog,this),100)}},_onSubmitClick:function(t){if(!this.hasDuplicates()){return true}var e=null;if(t){if(t.target){e=t.target}else if(t.srcElement){e=t.srcElement}}if(BX.type.isElementNode(e)){this._lastSubmit=e}window.setTimeout(BX.delegate(this._openWarningDialog,this),100);return BX.PreventDefault(t)},_openWarningDialog:function(){if(!this.hasDuplicates()){this._unbind();this._submitForm()}else{this._warningDialog=BX.CrmDuplicateWarningDialog.create(this._id+"_warn",{controller:this,onClose:BX.delegate(this._onWarningDialogClose,this),onCancel:BX.delegate(this._onWarningDialogCancel,this),onAccept:BX.delegate(this._onWarningDialogAccept,this)});this._warningDialog.show()}},_getGroupSearchData:function(t){return this._searchData.hasOwnProperty(t)?this._searchData[t]:null},_getGroupSearchHashCode:function(t){var e=this._getGroupSearchData(t);return e&&e.hasOwnProperty("hash")?e["hash"]:0},_showSearchSummary:function(t){let e=null;if(t){e=t?t.getElementTitle():null;if(!e){e=t.getElement()}}const i=this.getSetting("form",null);if(i&&BX.Type.isFunction(i["getElementNode"])){const t=i.getElementNode();this._searchSummary=BX.Crm.Duplicate.SummaryList.create(this._id+"_summary",{controller:this,anchor:e,wrapper:t,clientSearchBox:this.getSetting("clientSearchBox",null),enableEntitySelect:this.getSetting("enableEntitySelect",false)})}else{this._searchSummary=BX.CrmDuplicateSummaryPopup.create(this._id+"_summary",{controller:this,anchor:e,position:this.getSetting("searchSummaryPosition","bottom")})}this._searchSummary.show()},_replaceShownSearchSummary:function(t){if(BX.Type.isFunction(this._searchSummary["subscribe"])){this._searchSummary.subscribe("close",(()=>{this._showSearchSummary(t)}));this._closeSearchSummary()}else{this._showSearchSummary(t)}},_isSearchSummaryShown:function(){return this._searchSummary&&this._searchSummary.isShown()},_closeSearchSummary:function(){if(this._searchSummary){this._searchSummary.close();this._searchSummary=null}},_onWarningDialogClose:function(t){if(this._warningDialog===t){this._warningDialog=null}},_onWarningDialogCancel:function(t){if(this._warningDialog===t){this._warningDialog.close()}},_onWarningDialogAccept:function(t){if(this._warningDialog===t){this._warningDialog.close();this._unbind();this._submitForm()}},_submitForm:function(){if(BX.type.isElementNode(this._lastSubmit)){if(this._lastSubmit.disabled){this._lastSubmit.disabled=false}this._lastSubmit.click()}else{var t=this.getSetting("form",null);if(t instanceof BX.Crm.Form||t instanceof BX.UI.AjaxForm){t.submit({originator:this})}else{t=BX(t);if(BX.type.isElementNode(t)){t.submit()}}}}};BX.CrmDupController.items={};BX.CrmDupController.getItem=function(t){return this.items.hasOwnProperty(t)?this.items[t]:null};BX.CrmDupController.create=function(t,e){var i=new BX.CrmDupController;i.initialize(t,e);BX.CrmDupController.items[t]=i;return i};BX.CrmDupController.delete=function(t){BX.onCustomEvent("CrmDupControllerDelete",[this]);if(BX.CrmDupController.items.hasOwnProperty(t)){BX.CrmDupController.items[t].destroy();delete BX.CrmDupController.items[t]}}}if(typeof BX.CrmDupCtrlField==="undefined"){BX.CrmDupCtrlField=function(){this._id="";this._group=null;this._element=null;this._elementTitle=null;this._value="";this._hasFosus=false;this._elementTimeoutId=0;this._elementTimeoutHandler=BX.delegate(this._onElementTimeout,this);this._elementKeyUpHandler=BX.delegate(this._onElementKeyUp,this);this._elementFocusHandler=BX.delegate(this._onElementFocus,this);this._elementBlurHandler=BX.delegate(this._onElementBlur,this);this._initialized=false};BX.CrmDupCtrlField.prototype={initialize:function(t,e,i){if(!BX.type.isNotEmptyString(t)){throw"BX.CrmDupCtrlField. Invalid parameter 'id': is not defined."}this._id=t;if(!BX.type.isElementNode(e)){throw"BX.CrmDupCtrlField. Invalid parameter 'element': is not defined."}this._element=e;this._value=e.value;BX.bind(this._element,"keyup",this._elementKeyUpHandler);BX.bind(this._element,"focus",this._elementFocusHandler);BX.bind(this._element,"blur",this._elementBlurHandler);if(BX.type.isElementNode(i)){this._elementTitle=i}this._initialized=true},release:function(){BX.unbind(this._element,"keyup",this._elementKeyUpHandler);BX.unbind(this._element,"focus",this._elementFocusHandler);BX.unbind(this._element,"blur",this._elementBlurHandler);this._element=null;this._initialized=false},getId:function(){return this._id},getGroup:function(){return this._group},setGroup:function(t){this._group=t},hasFocus:function(){return this._hasFosus},getElement:function(){return this._element},getElementTitle:function(){return this._elementTitle},getValue:function(){return this._element.value},_onElementKeyUp:function(t){var e=t.keyCode;if(e===13||e===27||e>=37&&e<=40||e>=112&&e<=123){return}if(this._value===this._element.value){return}this._value=this._element.value;if(this._elementTimeoutId>0){window.clearTimeout(this._elementTimeoutId);this._elementTimeoutId=0}this._elementTimeoutId=window.setTimeout(this._elementTimeoutHandler,1500);if(!this._hasFosus){this._hasFosus=true}},_onElementFocus:function(t){this._hasFosus=true;if(this._group){this._group.processFieldFocusGain(this)}},_onElementBlur:function(t){if(this._elementTimeoutId>0){window.clearTimeout(this._elementTimeoutId);this._elementTimeoutId=0}this._hasFosus=false;if(this._group){this._group.processFieldFocusLoss(this)}},_onElementTimeout:function(){if(this._elementTimeoutId<=0){return}this._elementTimeoutId=0;if(this._group){this._group.processFieldDelay(this)}}};BX.CrmDupCtrlField.create=function(t,e,i){var n=new BX.CrmDupCtrlField;n.initialize(t,e,i);return n}}if(typeof BX.CrmDupCtrlRequisiteField==="undefined"){BX.CrmDupCtrlRequisiteField=function(){this._params={formId:"",requisitePseudoId:"",presetId:0,countryId:0,fieldName:""};BX.CrmDupCtrlRequisiteField.superclass.constructor.apply(this)};BX.extend(BX.CrmDupCtrlRequisiteField,BX.CrmDupCtrlField);BX.CrmDupCtrlRequisiteField.prototype.initialize=function(t,e,i,n){this.setParams(n);BX.CrmDupCtrlRequisiteField.superclass.initialize.apply(this,[t,e,i])};BX.CrmDupCtrlRequisiteField.prototype.setParams=function(t){if(BX.type.isPlainObject(t)){if(t.hasOwnProperty("formId")&&BX.type.isNotEmptyString(t["formId"]))this._params["formId"]=t["formId"];if(t.hasOwnProperty("requisitePseudoId")&&BX.type.isNotEmptyString(t["requisitePseudoId"]))this._params["requisitePseudoId"]=t["requisitePseudoId"];if(t.hasOwnProperty("presetId"))this._params["presetId"]=parseInt(t["presetId"]);if(t.hasOwnProperty("countryId"))this._params["countryId"]=parseInt(t["countryId"]);if(t.hasOwnProperty("fieldName")&&BX.type.isNotEmptyString(t["fieldName"]))this._params["fieldName"]=t["fieldName"]}if(!BX.type.isNotEmptyString(this._params["formId"])||!BX.type.isNotEmptyString(this._params["requisitePseudoId"])||this._params["presetId"]<=0||this._params["countryId"]<=0||!BX.type.isNotEmptyString(this._params["fieldName"])){throw"BX.CrmDupCtrlRequisiteField. Invalid parameters."}};BX.CrmDupCtrlRequisiteField.prototype.getParams=function(){return this._params};BX.CrmDupCtrlRequisiteField.create=function(t,e,i,n){var r=new BX.CrmDupCtrlRequisiteField;r.initialize(t,e,i,n);return r}}if(typeof BX.CrmDupCtrlBankDetailField==="undefined"){BX.CrmDupCtrlBankDetailField=function(){this._params={formId:"",requisitePseudoId:"",presetId:0,bankDetailPseudoId:"",countryId:0,fieldName:""};BX.CrmDupCtrlBankDetailField.superclass.constructor.apply(this)};BX.extend(BX.CrmDupCtrlBankDetailField,BX.CrmDupCtrlField);BX.CrmDupCtrlBankDetailField.prototype.initialize=function(t,e,i,n){this.setParams(n);BX.CrmDupCtrlBankDetailField.superclass.initialize.apply(this,[t,e,i])};BX.CrmDupCtrlBankDetailField.prototype.setParams=function(t){if(BX.type.isPlainObject(t)){if(t.hasOwnProperty("formId")&&BX.type.isNotEmptyString(t["formId"]))this._params["formId"]=t["formId"];if(t.hasOwnProperty("requisitePseudoId")&&BX.type.isNotEmptyString(t["requisitePseudoId"]))this._params["requisitePseudoId"]=t["requisitePseudoId"];if(t.hasOwnProperty("presetId"))this._params["presetId"]=parseInt(t["presetId"]);if(t.hasOwnProperty("bankDetailPseudoId")&&BX.type.isNotEmptyString(t["bankDetailPseudoId"]))this._params["bankDetailPseudoId"]=t["bankDetailPseudoId"];if(t.hasOwnProperty("countryId"))this._params["countryId"]=parseInt(t["countryId"]);if(t.hasOwnProperty("fieldName")&&BX.type.isNotEmptyString(t["fieldName"]))this._params["fieldName"]=t["fieldName"]}if(!BX.type.isNotEmptyString(this._params["formId"])||!BX.type.isNotEmptyString(this._params["requisitePseudoId"])||this._params["presetId"]<=0||this._params["countryId"]<=0||!BX.type.isNotEmptyString(this._params["fieldName"])){throw"BX.CrmDupCtrlBankDetailField. Invalid parameters."}};BX.CrmDupCtrlBankDetailField.prototype.getParams=function(){return this._params};BX.CrmDupCtrlBankDetailField.create=function(t,e,i,n){var r=new BX.CrmDupCtrlBankDetailField;r.initialize(t,e,i,n);return r}}if(typeof BX.CrmDupCtrlFieldGroup==="undefined"){BX.CrmDupCtrlFieldGroup=function(){this._id="";this._settings={};this._controller=null;this._fields={}};BX.CrmDupCtrlFieldGroup.prototype={initialize:function(t,e){if(!BX.type.isNotEmptyString(t)){throw"BX.CrmDupCtrlFieldGroup. Invalid parameter 'id': is not defined."}this._id=t;this._settings=e?e:{};this._afterInitialize()},_afterInitialize:function(){},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},getController:function(){return this._controller},setController:function(t){this._controller=t},addField:function(t){this._fields[t.getId()]=t;t.setGroup(this);return t},removeField:function(t){var e=t.getId();if(this._fields.hasOwnProperty(e)){delete this._fields[e]}},getField:function(t){return this._fields.hasOwnProperty(t)?this._fields[t]:null},getFirstField:function(){var t=Object.keys(this._fields);return t.length>0?this._fields[t[0]]:null},getFieldValues:function(){var t=[];for(var e in this._fields){if(this._fields.hasOwnProperty(e)){var i=BX.util.trim(this._fields[e].getValue());if(i!==""){t.push(i)}}}return t},getFieldCount:function(){return Object.keys(this._fields).length},clearFields:function(){for(var t in this._fields){if(this._fields.hasOwnProperty(t)){this._fields[t].release()}}this._fields={}},registerField:function(t){var e=BX.prop.getString(t,"id","");if(e===""){return null}var i=this.getField(e);if(i){return i}var n=BX.prop.getElementNode(t,"element",null);if(!n){return null}return this.addField(BX.CrmDupCtrlField.create(e,n,null))},unregisterField:function(t){var e=BX.prop.getString(t,"id","");if(e===""){return}var i=this.getField(e);if(i){this.removeField(i);i.release()}},getSummaryTitle:function(){return this.getSetting("groupSummaryTitle","")},prepareSearchParams:function(){return null},getSearchHashCode:function(){return 0},getDefaultSearchSummaryFieldId:function(){return""},processFieldDelay:function(t){},processFieldFocusGain:function(t){},processFieldFocusLoss:function(t){}}}if(typeof BX.CrmDupCtrlSingleField==="undefined"){BX.CrmDupCtrlSingleField=function(){BX.CrmDupCtrlSingleField.superclass.constructor.apply(this);this._paramName="";this._field=null};BX.extend(BX.CrmDupCtrlSingleField,BX.CrmDupCtrlFieldGroup);BX.CrmDupCtrlSingleField.prototype._afterInitialize=function(){this._paramName=this.getSetting("parameterName","");if(!BX.type.isNotEmptyString(this._paramName)){throw"BX.CrmDupCtrlSingleField. Could not find parameter name."}var t=BX(this.getSetting("element",null));if(BX.type.isDomNode(t)){this._field=this.addField(BX.CrmDupCtrlField.create(this._paramName,t,BX(this.getSetting("elementCaption",null))))}};BX.CrmDupCtrlSingleField.prototype.registerField=function(t){var e=BX.prop.getString(t,"id","");if(e!==this._paramName){return null}var i=BX.prop.getElementNode(t,"element",null);if(!i){return null}if(!this._field){this._field=this.addField(BX.CrmDupCtrlField.create(this._paramName,i,null))}return this._field};BX.CrmDupCtrlSingleField.prototype.getValue=function(){return this._field?BX.util.trim(this._field.getValue()):""};BX.CrmDupCtrlSingleField.prototype.prepareSearchParams=function(){var t=this.getValue();if(t===""){return null}var e={};e[this._paramName]=t;return e};BX.CrmDupCtrlSingleField.prototype.getSearchHashCode=function(){var t=this.getValue();if(t===""){return 0}return BX.util.hashCode(t)};BX.CrmDupCtrlSingleField.prototype.getDefaultSearchSummaryFieldId=function(){return this._field?this._field.getId():""};BX.CrmDupCtrlSingleField.prototype.processFieldDelay=function(t){this._fireChangeEvent(t)};BX.CrmDupCtrlSingleField.prototype.processFieldFocusLoss=function(t){this._fireChangeEvent(t)};BX.CrmDupCtrlSingleField.prototype._fireChangeEvent=function(t){if(this._controller){this._controller.processGroupChange(this,t)}};BX.CrmDupCtrlSingleField.create=function(t,e){var i=new BX.CrmDupCtrlSingleField;i.initialize(t,e);return i}}if(typeof BX.CrmDupCtrlFullName==="undefined"){BX.CrmDupCtrlFullName=function(){BX.CrmDupCtrlFullName.superclass.constructor.apply(this);this._nameField=null;this._secondNameField=null;this._lastNameField=null};BX.extend(BX.CrmDupCtrlFullName,BX.CrmDupCtrlFieldGroup);BX.CrmDupCtrlFullName.prototype._afterInitialize=function(){var t=BX(this.getSetting("name",null));if(BX.type.isDomNode(t)){this._nameField=this.addField(BX.CrmDupCtrlField.create("NAME",t,BX(this.getSetting("nameCaption",null))))}t=BX(this.getSetting("secondName",null));if(BX.type.isDomNode(t)){this._secondNameField=this.addField(BX.CrmDupCtrlField.create("SECOND_NAME",t,BX(this.getSetting("secondNameCaption",null))))}t=BX(this.getSetting("lastName",null));if(BX.type.isDomNode(t)){this._lastNameField=this.addField(BX.CrmDupCtrlField.create("LAST_NAME",t,BX(this.getSetting("lastNameCaption",null))))}};BX.CrmDupCtrlFullName.prototype.registerField=function(t){var e=BX.prop.getString(t,"id","");if(e===""){return null}var i=this.getField(e);if(i){return i}var n=BX.prop.getElementNode(t,"element",null);if(!n){return null}i=this.addField(BX.CrmDupCtrlField.create(e,n,null));if(e==="NAME"){this._nameField=i}else if(e==="SECOND_NAME"){this._secondNameField=i}else if(e==="LAST_NAME"){this._lastNameField=i}return i};BX.CrmDupCtrlFullName.prototype.getName=function(){return this._nameField?BX.util.trim(this._nameField.getValue()):""};BX.CrmDupCtrlFullName.prototype.getSecondName=function(){return this._secondNameField?BX.util.trim(this._secondNameField.getValue()):""};BX.CrmDupCtrlFullName.prototype.getLastName=function(){return this._lastNameField?BX.util.trim(this._lastNameField.getValue()):""};BX.CrmDupCtrlFullName.prototype.prepareSearchParams=function(){var t=this.getLastName();if(t===""){return null}var e={LAST_NAME:t};var i=this.getName();if(i!==""){e["NAME"]=i}var n=this.getSecondName();if(n!==""){e["SECOND_NAME"]=n}return e};BX.CrmDupCtrlFullName.prototype.getSearchHashCode=function(){var t=this.getLastName();if(t===""){return 0}var e=t.toLowerCase();var i=this.getName();if(i!==""){e+="$"+i.toLowerCase()}var n=this.getSecondName();if(n!==""){e+="$"+n.toLowerCase()}return BX.util.hashCode(e)};BX.CrmDupCtrlFullName.prototype.getDefaultSearchSummaryFieldId=function(){return this._lastNameField?this._lastNameField.getId():""};BX.CrmDupCtrlFullName.prototype.processFieldDelay=function(t){this._fireChangeEvent(t)};BX.CrmDupCtrlFullName.prototype.processFieldFocusLoss=function(t){this._fireChangeEvent(t)};BX.CrmDupCtrlFullName.prototype._fireChangeEvent=function(t){if(this._controller){this._controller.processGroupChange(this,t)}};BX.CrmDupCtrlFullName.create=function(t,e){var i=new BX.CrmDupCtrlFullName;i.initialize(t,e);return i}}if(typeof BX.CrmDupCtrlCommunication==="undefined"){BX.CrmDupCtrlCommunication=function(){this._communicationType="";this._container=null;this._editorCreateItemHandler=BX.delegate(this.onCommunicaionEditorItemCreate,this);this._editorDeleteItemHandler=BX.delegate(this.onCommunicaionEditorItemDelete,this);BX.CrmDupCtrlCommunication.superclass.constructor.apply(this)};BX.extend(BX.CrmDupCtrlCommunication,BX.CrmDupCtrlFieldGroup);BX.CrmDupCtrlCommunication.prototype._afterInitialize=function(){this._communicationType=this.getSetting("communicationType","");if(!BX.type.isNotEmptyString(this._communicationType)){throw"BX.CrmDupCtrlCommunication. Could not find communication type."}this._editorId=this.getSetting("editorId","");this._container=this.getSetting("container",null);if(BX.type.isNotEmptyString(this._container)){this._container=BX(this._container)}if(!BX.type.isElementNode(this._container)){this._container=BX(this._editorId)}BX.addCustomEvent(window,"CrmFieldMultiEditorItemCreated",this._editorCreateItemHandler);BX.addCustomEvent(window,"CrmFieldMultiEditorItemDeleted",this._editorDeleteItemHandler);this._initializeFields()};BX.CrmDupCtrlCommunication.prototype._initializeFields=function(){this.clearFields();if(!this._container){return}var t=BX(this.getSetting("editorCaption",null));var e=BX.findChildren(this._container,{tagName:"input",className:"bx-crm-edit-input"},true);var i=e.length;for(var n=0;n<i;n++){this.addField(BX.CrmDupCtrlField.create("VALUE_"+(n+1).toString(),e[n],t))}};BX.CrmDupCtrlCommunication.prototype.prepareFieldId=function(t){return"VALUE_"+(t+1).toString()};BX.CrmDupCtrlCommunication.prototype.registerField=function(t){var e=BX.prop.getString(t,"id","");if(e===""){e=this.prepareFieldId(this.getFieldCount())}var i=BX.prop.getElementNode(t,"element",null);if(!i){return null}return this.addField(BX.CrmDupCtrlField.create(e,i,null))};BX.CrmDupCtrlCommunication.prototype.prepareSearchParams=function(){var t=this.getFieldValues();var e=t.length;if(e===0){return null}var i={};if(this._communicationType!=="PHONE"){i[this._communicationType]=t;return i}var n=[];for(var r=0;r<e;r++){var s=t[r];if(s.length>=5){n.push(s)}}if(n.length===0){return null}i["PHONE"]=n;return i};BX.CrmDupCtrlCommunication.prototype.getSearchHashCode=function(){var t=this.getFieldValues();return t.length>0?BX.util.hashCode(t.join("$")):0};BX.CrmDupCtrlCommunication.prototype.getDefaultSearchSummaryFieldId=function(){var t=this.getFirstField();return t?t.getId():""};BX.CrmDupCtrlCommunication.prototype.processFieldDelay=function(t){if(this._controller){this._controller.processGroupChange(this,t)}};BX.CrmDupCtrlCommunication.prototype.processFieldFocusLoss=function(t){if(this._controller){this._controller.processGroupChange(this,t)}};BX.CrmDupCtrlCommunication.prototype.onCommunicaionEditorItemCreate=function(t,e){if(this._editorId!==e){return}this._initializeFields()};BX.CrmDupCtrlCommunication.prototype.onCommunicaionEditorItemDelete=function(t,e){if(this._editorId!==e){return}this._initializeFields();if(this._controller){var i=this.getFieldCount();this._controller.processGroupChange(this,i>0?this.getField(this.prepareFieldId(i-1)):null)}};BX.CrmDupCtrlCommunication.create=function(t,e){var i=new BX.CrmDupCtrlCommunication;i.initialize(t,e);return i}}if(typeof BX.CrmDupCtrlRequisite==="undefined"){BX.CrmDupCtrlRequisite=function(){this._fieldIndex=[];this._firstField=null;this._lastField=null;BX.CrmDupCtrlRequisite.superclass.constructor.apply(this)};BX.extend(BX.CrmDupCtrlRequisite,BX.CrmDupCtrlFieldGroup);BX.CrmDupCtrlRequisite.prototype.addField=function(t){var e=t.getId();this._fields[e]=t;t.setGroup(this);if(!this._firstField)this._firstField=t;this._lastField=t;this._fieldIndex.push(e);return t};BX.CrmDupCtrlRequisite.prototype.removeField=function(t){var e=false;if(this._fields.hasOwnProperty(t)){this._fields[t].release();delete this._fields[t];var i=this._fieldIndex.indexOf(t);var n=this._fieldIndex.length;if(i>=0){if(i===0)this._firstField=n>1?this._fields[this._fieldIndex[i+1]]:null;if(i===n-1)this._lastField=n>1?this._fields[this._fieldIndex[i-1]]:null;this._fieldIndex.splice(i,1)}e=true}return e};BX.CrmDupCtrlRequisite.prototype.prepareRequisiteList=function(){var t={};var e=[];var i=0;for(var n in this._fields){if(this._fields.hasOwnProperty(n)){var r=BX.util.trim(this._fields[n].getValue());if(r!==""){var s=this._fields[n].getParams();var o;if(t.hasOwnProperty(s["requisitePseudoId"])){o=e[t[s["requisitePseudoId"]]]}else{t[s["requisitePseudoId"]]=i;e[i++]=o={}}o["ID"]=s["requisitePseudoId"];o["PRESET_ID"]=s["presetId"];o["PRESET_COUNTRY_ID"]=s["countryId"];o[s["fieldName"]]=r;o=null}}}return e};BX.CrmDupCtrlRequisite.prototype.prepareSearchParams=function(){var t=null;var e=this.prepareRequisiteList();if(e.length>0){t={};t[this._id]=e}return t};BX.CrmDupCtrlRequisite.prototype.getSearchHashCode=function(){var t=this.prepareRequisiteList();var e=[];for(var i=0;i<t.length;i++){var n="";for(var r in t[i]){if(t[i].hasOwnProperty(r)){var s=n===""?"":"|";n+=s+t[i][r]}}e.push(n)}return e.length>0?BX.util.hashCode(e.join("$")):0};BX.CrmDupCtrlRequisite.prototype.getDefaultSearchSummaryFieldId=function(){return this._firstField?this._firstField.getId():""};BX.CrmDupCtrlRequisite.prototype.processFieldDelay=function(t){if(this._controller){this._controller.processGroupChange(this,t)}};BX.CrmDupCtrlRequisite.prototype.processFieldFocusLoss=function(t){if(this._controller){this._controller.processGroupChange(this,t)}};BX.CrmDupCtrlRequisite.create=function(t,e){var i=new BX.CrmDupCtrlRequisite;i.initialize(t,e);return i}}if(typeof BX.CrmDupCtrlBankDetail==="undefined"){BX.CrmDupCtrlBankDetail=function(){this._fieldIndex=[];this._firstField=null;this._lastField=null;BX.CrmDupCtrlBankDetail.superclass.constructor.apply(this)};BX.extend(BX.CrmDupCtrlBankDetail,BX.CrmDupCtrlFieldGroup);BX.CrmDupCtrlBankDetail.prototype.addField=function(t){var e=t.getId();this._fields[e]=t;t.setGroup(this);if(!this._firstField)this._firstField=t;this._lastField=t;this._fieldIndex.push(e);return t};BX.CrmDupCtrlBankDetail.prototype.removeField=function(t){var e=false;if(this._fields.hasOwnProperty(t)){this._fields[t].release();delete this._fields[t];var i=this._fieldIndex.indexOf(t);var n=this._fieldIndex.length;if(i>=0){if(i===0)this._firstField=n>1?this._fields[this._fieldIndex[i+1]]:null;if(i===n-1)this._lastField=n>1?this._fields[this._fieldIndex[i-1]]:null;this._fieldIndex.splice(i,1)}e=true}return e};BX.CrmDupCtrlBankDetail.prototype.prepareBankDetailList=function(){var t={};var e=[];var i=0;for(var n in this._fields){if(this._fields.hasOwnProperty(n)){var r=BX.util.trim(this._fields[n].getValue());if(r!==""){var s=this._fields[n].getParams();var o;if(t.hasOwnProperty(s["bankDetailPseudoId"])){o=e[t[s["bankDetailPseudoId"]]]}else{t[s["bankDetailPseudoId"]]=i;e[i++]=o={}}o["ID"]=s["bankDetailPseudoId"];o["REQUISITE_ID"]=s["requisitePseudoId"];o["PRESET_ID"]=s["presetId"];o["PRESET_COUNTRY_ID"]=s["countryId"];o[s["fieldName"]]=r;o=null}}}return e};BX.CrmDupCtrlBankDetail.prototype.prepareSearchParams=function(){var t=null;var e=this.prepareBankDetailList();if(e.length>0){t={};t[this._id]=e}return t};BX.CrmDupCtrlBankDetail.prototype.getSearchHashCode=function(){var t=this.prepareBankDetailList();var e=[];for(var i=0;i<t.length;i++){var n="";for(var r in t[i]){if(t[i].hasOwnProperty(r)){var s=n===""?"":"|";n+=s+t[i][r]}}e.push(n)}return e.length>0?BX.util.hashCode(e.join("$")):0};BX.CrmDupCtrlBankDetail.prototype.getDefaultSearchSummaryFieldId=function(){return this._firstField?this._firstField.getId():""};BX.CrmDupCtrlBankDetail.prototype.processFieldDelay=function(t){if(this._controller){this._controller.processGroupChange(this,t)}};BX.CrmDupCtrlBankDetail.prototype.processFieldFocusLoss=function(t){if(this._controller){this._controller.processGroupChange(this,t)}};BX.CrmDupCtrlBankDetail.create=function(t,e){var i=new BX.CrmDupCtrlBankDetail;i.initialize(t,e);return i}}if(typeof BX.CrmDupControllerRequisite==="undefined"){BX.CrmDupControllerRequisite=function(){this._id="";this._settings={};this._dupControllerId="";this._dupController=null;this._groups={};this._formFieldMap={};this._requisiteEditFormCreateHandler=BX.delegate(this.onRequisiteEditFormCreate,this);this._requisiteEditFormRemoveHandler=BX.delegate(this.onRequisiteEditFormRemove,this);this._dupControllerDeleteHandler=BX.delegate(this.onDupControllerDelete,this);this._requisitePopupCloseHandler=BX.delegate(this.onRequisitePopupClose,this);this._dupControllerAfterInitializeHandler=BX.delegate(this.onDupControllerAfterInitialize,this);this._requisiteEditFormGetParamsCallback=BX.delegate(this.onRequisiteEditFormParams,this);this._dupControllerRequisiteFindHandler=BX.delegate(this.onDupControllerRequisiteFind,this);this._requisitePopupSaveLockHandler=BX.delegate(this.onRequisitePopupSaveLock,this);this._warningDialog=null};BX.CrmDupControllerRequisite.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_dp_ctrl_rq_"+Math.random().toString().substring(2);this._settings=e?e:{};this._dupControllerId=this.getSetting("dupControllerId","");if(BX.type.isNotEmptyString(this._dupControllerId)&&typeof BX.CrmDupController.items[this._dupControllerId]==="object"&&BX.CrmDupController.items[this._dupControllerId]!==null){this._dupController=BX.CrmDupController.items[this._dupControllerId]}this._bind()},destroy:function(){this._unbind();for(var t in this._groups){if(this._groups.hasOwnProperty(t))this.deleteGroup(t)}this._groups={};this.setDupController(null)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},_bind:function(){if(this._dupController){BX.addCustomEvent("CrmRequisiteEditFormCreate",this._requisiteEditFormCreateHandler);BX.addCustomEvent("CrmFormSettingManagerSectionRemove",this._requisiteEditFormRemoveHandler);BX.addCustomEvent("CrmDupControllerDelete",this._dupControllerDeleteHandler);BX.addCustomEvent("CrmRequisitePopupFormManagerClosePopup",this._requisitePopupCloseHandler)}else{BX.addCustomEvent("CrmDupControllerAfterInitialize",this._dupControllerAfterInitializeHandler)}BX.addCustomEvent("CrmDupControllerRequisiteFind",this._dupControllerRequisiteFindHandler);BX.addCustomEvent(this,"CrmRequisitePopupFormManagerSaveLock",this._requisitePopupSaveLockHandler)},_unbind:function(){BX.removeCustomEvent("CrmRequisiteEditFormCreate",this._requisiteEditFormCreateHandler);BX.removeCustomEvent("CrmFormSettingManagerSectionRemove",this._requisiteEditFormRemoveHandler);BX.removeCustomEvent("CrmDupControllerDelete",this._dupControllerDeleteHandler);BX.removeCustomEvent("CrmRequisitePopupFormManagerClosePopup",this._requisitePopupCloseHandler);BX.removeCustomEvent("CrmDupControllerAfterInitialize",this._dupControllerAfterInitializeHandler);BX.removeCustomEvent("CrmDupControllerRequisiteFind",this._dupControllerRequisiteFindHandler);BX.removeCustomEvent(this,"CrmRequisitePopupFormManagerSaveLock",this._requisitePopupSaveLockHandler)},_openWarningDialog:function(){this._warningDialog=BX.CrmDuplicateWarningDialog.create(this._id+"_warn",{controller:this._dupController,onClose:BX.delegate(this._onWarningDialogClose,this),onCancel:BX.delegate(this._onWarningDialogCancel,this),onAccept:BX.delegate(this._onWarningDialogAccept,this)});this._warningDialog.show()},_onWarningDialogClose:function(t){if(this._warningDialog===t){this._warningDialog=null}},_onWarningDialogCancel:function(t){if(this._warningDialog===t){this._warningDialog.close();BX.onCustomEvent("CrmRequisitePopupFormManagerDoSave",[this,false])}},_onWarningDialogAccept:function(t){if(this._warningDialog===t){this._warningDialog.close();BX.onCustomEvent("CrmRequisitePopupFormManagerDoSave",[this,true])}},onDupControllerAfterInitialize:function(t){if(t instanceof BX.CrmDupController){if(this._dupControllerId===t.getId()){BX.removeCustomEvent("CrmDupControllerAfterInitialize",this._dupControllerAfterInitializeHandler);this.setDupController(t);BX.onCustomEvent("CrmRequisiteEditFormGetParams",[this._requisiteEditFormGetParamsCallback])}}},setDupController:function(t){var e=this._dupController;this._dupController=t;if(!e&&this._dupController){BX.addCustomEvent("CrmRequisiteEditFormCreate",this._requisiteEditFormCreateHandler);BX.addCustomEvent("CrmFormSettingManagerSectionRemove",this._requisiteEditFormRemoveHandler);BX.addCustomEvent("CrmDupControllerDelete",this._dupControllerDeleteHandler);BX.addCustomEvent("CrmRequisitePopupFormManagerClosePopup",this._requisitePopupCloseHandler)}else if(!this._dupController){BX.removeCustomEvent("CrmRequisiteEditFormCreate",this._requisiteEditFormCreateHandler);BX.removeCustomEvent("CrmFormSettingManagerSectionRemove",this._requisiteEditFormRemoveHandler);BX.removeCustomEvent("CrmDupControllerDelete",this._dupControllerDeleteHandler);BX.removeCustomEvent("CrmRequisitePopupFormManagerClosePopup",this._requisitePopupCloseHandler)}},onRequisiteEditFormParams:function(t){this.onRequisiteEditFormCreate(t)},onDupControllerRequisiteFind:function(t,e){if(t!==null&&typeof t==="object"){var i=t.getFormId();i=i.replace(/[^a-z0-9_]/gi,"");if(BX.type.isNotEmptyString(i)&&this._formFieldMap.hasOwnProperty(i)&&BX.type.isArray(e)){e.push(this)}}},onRequisitePopupSaveLock:function(){if(!(this._dupController&&this._dupController.hasDuplicates())){BX.onCustomEvent("CrmRequisitePopupFormManagerDoSave",[this,true])}else{window.setTimeout(BX.delegate(this._openWarningDialog,this),100)}},onRequisiteEditFormCreate:function(t){var e=0;var i="";var n=null;var r="";var s=0;var o="";var a="";var l=0;var u=false;var h="";if(BX.type.isPlainObject(t)){if(BX.type.isNotEmptyString(t["formId"])){i=t["formId"];i=i.replace(/[^a-z0-9_]/gi,"")}if(BX.type.isNotEmptyString(t["containerId"])){r=t["containerId"];n=BX(r)}if(BX.type.isNotEmptyString(t["countryId"])||BX.type.isNumber(t["countryId"]))s=parseInt(t["countryId"]);if(t["enableFieldMasquerading"]===true)u=true;if(BX.type.isNotEmptyString(t["fieldNameTemplate"])){o=t["fieldNameTemplate"];h=o.replace(/\[/g,"\\5b ").replace(/]/g,"\\5d ")}}if(BX.type.isNotEmptyString(i)){var c=i.match(/^([a-z0-9_]+)_(n?\d+)_PID(\d+)$/i);if(BX.type.isArray(c)&&c.length===4){a=c[2];l=parseInt(c[3])}}if(BX.type.isNotEmptyString(i)&&BX.type.isDomNode(n)&&s>0&&BX.type.isNotEmptyString(a)&&l>0){var p=this.getSetting("dupFieldsMap",{});var m=[],d,f,g;var _,C,y;var B=u&&BX.type.isNotEmptyString(h);for(_ in p){if(!p.hasOwnProperty(_))continue;if(p.hasOwnProperty(_)&&s===parseInt(_)&&BX.type.isArray(p[_])){C=p[_];y=0;for(e=0;e<C.length;e++){d=B?h.replace("#FIELD_NAME#",C[e]):C[e];m[y++]="[name="+d+"]"}}}m=m.join(",");f=n.querySelectorAll(m);for(e=0;e<f.length;e++){g=this.getFieldNameByElement(f[e],B?o:"");if(BX.type.isNotEmptyString(g)){this.registerRequisiteField(i,a,l,s,g,f[e])}}}},onRequisiteEditFormRemove:function(t){var e="";if(t!==null&&typeof t==="object"){e=t.getFormId();if(BX.type.isNotEmptyString(e)){e=e.replace(/[^a-z0-9_]/gi,"");this.unregisterRequisiteFieldsByFormId(e)}}},onDupControllerDelete:function(t){if(this._dupController&&this._dupController===t)BX.CrmDupControllerRequisite.delete(this._id)},onRequisitePopupClose:function(t){var e="";if(t!==null&&typeof t==="object"){e=t.getFormId();if(BX.type.isNotEmptyString(e)){e=e.replace(/[^a-z0-9_]/gi,"");if(BX.type.isNotEmptyString(e)&&this._formFieldMap.hasOwnProperty(e)){if(this._warningDialog!==null&&typeof this._warningDialog==="object"){this._warningDialog.close()}var i=null;if(this._dupController)i=this._dupController;BX.CrmDupControllerRequisite.delete(this._id);if(i)BX.CrmDupController.delete(i.getId())}}}},getFieldNameByElement:function(t,e){var i="";if(BX.type.isElementNode(t)){i=t.getAttribute("name");if(BX.type.isNotEmptyString(e)&&BX.type.isNotEmptyString(i)){var n,r;var s;n="#FIELD_NAME#";s=e.indexOf(n);if(s>=0){if(s<i.length){i=i.substr(s)}s=s+n.length;if(s<e.length){r=e.substr(s);s=i.lastIndexOf(r);if(s>=0){i=i.substr(0,s)}}}}}return i},registerRequisiteField:function(t,e,i,n,r,s){var o=r+"|"+n.toString();var a=this.getGroup(o);if(!a){var l=this.getSetting("dupFieldsDescriptions",{});var u=o;if(l[r]&&l[r][n]){u=l[r][n]}a=this.addGroup(o,{controller:this,countryId:n,fieldName:r,groupSummaryTitle:this.getSetting("groupSummaryTitle","")+' "'+u+'"'})}if(a){var h=s.getAttribute("name");if(!this._formFieldMap.hasOwnProperty(t))this._formFieldMap[t]={};if(!this._formFieldMap[t].hasOwnProperty(o))this._formFieldMap[t][o]={};this._formFieldMap[t][o][h]=a.addField(BX.CrmDupCtrlRequisiteField.create(h,s,null,{formId:t,requisitePseudoId:e,presetId:i,countryId:n,fieldName:r}))}},unregisterRequisiteFieldsByFormId:function(t){if(BX.type.isNotEmptyString(t)&&this._formFieldMap.hasOwnProperty(t)){var e;var i=this._formFieldMap[t];var n={};delete this._formFieldMap[t];for(e in i){if(i.hasOwnProperty(e)){var r;var s=i[e];for(r in s){if(s.hasOwnProperty(r)){if(this.unregisterRequisiteField(e,r)){if(!n.hasOwnProperty(e))n[e]={group:this.getGroup(e),fields:[]};n[e]["fields"].push(s[r])}}}}}if(this._dupController)this._dupController.processGroupsChange(n)}},unregisterRequisiteField:function(t,e){var i=this.getGroup(t);if(i){return i.removeField(e)}return false},addGroup:function(t,e){var i=null;if(BX.type.isNotEmptyString(t)){var n=BX.CrmDupCtrlRequisite.create(t,e);if(n){this._groups[t]=n;if(this._dupController)this._dupController.addGroup(n);i=n}}return i},deleteGroup:function(t){var e=false;if(BX.type.isNotEmptyString(t)&&this._groups.hasOwnProperty(t)){if(this._dupController)this._dupController.deleteGroup(t);else this._groups[t].clearFields();delete this._groups[t];e=true}return e},getGroup:function(t){if(BX.type.isNotEmptyString(t)&&this._groups.hasOwnProperty(t)){return this._groups[t]}return null}};BX.CrmDupControllerRequisite.items={};BX.CrmDupControllerRequisite.getItem=function(t){return this.items.hasOwnProperty(t)?this.items[t]:null};BX.CrmDupControllerRequisite.create=function(t,e){var i=new BX.CrmDupControllerRequisite;i.initialize(t,e);BX.CrmDupControllerRequisite.items[t]=i;return i};BX.CrmDupControllerRequisite.delete=function(t){if(BX.CrmDupControllerRequisite.items.hasOwnProperty(t)){var e=BX.CrmDupControllerRequisite.items[t];e.destroy();delete BX.CrmDupControllerRequisite.items[t]}}}if(typeof BX.CrmDupControllerBankDetail==="undefined"){BX.CrmDupControllerBankDetail=function(){this._id="";this._settings={};this._dupControllerId="";this._dupController=null;this._groups={};this._formFieldMap={};this._bankDetailBlockCreateHandler=BX.delegate(this.onBankDetailBlockCreate,this);this._requisiteEditFormRemoveHandler=BX.delegate(this.onRequisiteEditFormRemove,this);this._dupControllerDeleteHandler=BX.delegate(this.onDupControllerDelete,this);this._requisitePopupCloseHandler=BX.delegate(this.onRequisitePopupClose,this);this._bankDetailBlockRemoveHandler=BX.delegate(this.onBankDetailBlockRemove,this);this._dupControllerAfterInitializeHandler=BX.delegate(this.onDupControllerAfterInitialize,this);this._bankDetailBlockGetParamsCallback=BX.delegate(this.onBankDetailBlockParams,this)};BX.CrmDupControllerBankDetail.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_dp_ctrl_bd_"+Math.random().toString().substring(2);this._settings=e?e:{};this._dupControllerId=this.getSetting("dupControllerId","");var i=BX.CrmDupController.getItem(this._dupControllerId);if(BX.type.isNotEmptyString(this._dupControllerId)&&typeof i==="object"&&i!==null){this._dupController=i}this._bind()},destroy:function(){this._unbind();for(var t in this._groups){if(this._groups.hasOwnProperty(t))this.deleteGroup(t)}this._groups={};this.setDupController(null)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},_bind:function(){if(this._dupController){BX.addCustomEvent("CrmFormBankDetailBlockCreate",this._bankDetailBlockCreateHandler);BX.addCustomEvent("CrmFormSettingManagerSectionRemove",this._requisiteEditFormRemoveHandler);BX.addCustomEvent("CrmDupControllerDelete",this._dupControllerDeleteHandler);BX.addCustomEvent("CrmRequisitePopupFormManagerClosePopup",this._requisitePopupCloseHandler);BX.addCustomEvent("CrmFormBankDetailBlockRemove",this._bankDetailBlockRemoveHandler)}else{BX.addCustomEvent("CrmDupControllerAfterInitialize",this._dupControllerAfterInitializeHandler)}},_unbind:function(){BX.removeCustomEvent("CrmFormBankDetailBlockCreate",this._bankDetailBlockCreateHandler);BX.removeCustomEvent("CrmFormSettingManagerSectionRemove",this._requisiteEditFormRemoveHandler);BX.removeCustomEvent("CrmDupControllerDelete",this._dupControllerDeleteHandler);BX.removeCustomEvent("CrmRequisitePopupFormManagerClosePopup",this._requisitePopupCloseHandler);BX.removeCustomEvent("CrmFormBankDetailBlockRemove",this._bankDetailBlockRemoveHandler);BX.removeCustomEvent("CrmDupControllerAfterInitialize",this._dupControllerAfterInitializeHandler)},onDupControllerAfterInitialize:function(t){if(t instanceof BX.CrmDupController){if(this._dupControllerId===t.getId()){BX.removeCustomEvent("CrmDupControllerAfterInitialize",this._dupControllerAfterInitializeHandler);this.setDupController(t);BX.onCustomEvent("CrmRequisiteBankDetailBlockGetParams",[this._bankDetailBlockGetParamsCallback])}}},setDupController:function(t){var e=this._dupController;this._dupController=t;if(!e&&this._dupController){BX.addCustomEvent("CrmFormBankDetailBlockCreate",this._bankDetailBlockCreateHandler);BX.addCustomEvent("CrmFormSettingManagerSectionRemove",this._requisiteEditFormRemoveHandler);BX.addCustomEvent("CrmDupControllerDelete",this._dupControllerDeleteHandler);BX.addCustomEvent("CrmRequisitePopupFormManagerClosePopup",this._requisitePopupCloseHandler);BX.addCustomEvent("CrmFormBankDetailBlockRemove",this._bankDetailBlockRemoveHandler)}else if(!this._dupController){BX.removeCustomEvent("CrmFormBankDetailBlockCreate",this._bankDetailBlockCreateHandler);BX.removeCustomEvent("CrmFormSettingManagerSectionRemove",this._requisiteEditFormRemoveHandler);BX.removeCustomEvent("CrmDupControllerDelete",this._dupControllerDeleteHandler);BX.removeCustomEvent("CrmRequisitePopupFormManagerClosePopup",this._requisitePopupCloseHandler);BX.removeCustomEvent("CrmFormBankDetailBlockRemove",this._bankDetailBlockRemoveHandler)}},onBankDetailBlockParams:function(t){this.onBankDetailBlockCreate(t)},onBankDetailBlockCreate:function(t){var e=0;var i="";var n=null;var r="";var s="";var o=0;var a="";var l="";var u=0;var h=false;var c="";if(BX.type.isPlainObject(t)){if(BX.type.isNotEmptyString(t["formId"])){i=t["formId"];i=i.replace(/[^a-z0-9_]/gi,"")}if(BX.type.isNotEmptyString(t["containerId"])){r=t["containerId"];n=BX(r)}if(t.hasOwnProperty("bankDetailPseudoId")){if(BX.type.isNumber(t["bankDetailPseudoId"]))s=t["bankDetailPseudoId"].toString();else if(BX.type.isNotEmptyString(t["bankDetailPseudoId"]))s=t["bankDetailPseudoId"]}if(BX.type.isNotEmptyString(t["countryId"])||BX.type.isNumber(t["countryId"]))o=parseInt(t["countryId"]);if(t["enableFieldMasquerading"]===true)h=true;if(BX.type.isNotEmptyString(t["fieldNameTemplate"])){a=t["fieldNameTemplate"];c=a.replace(/\[/g,"\\5b ").replace(/]/g,"\\5d ")}}if(BX.type.isNotEmptyString(i)){var p=i.match(/^([a-z0-9_]+)_(n?\d+)_PID(\d+)$/i);if(BX.type.isArray(p)&&p.length===4){l=p[2];u=parseInt(p[3])}}if(BX.type.isNotEmptyString(i)&&BX.type.isDomNode(n)&&BX.type.isNotEmptyString(s)&&o>0&&BX.type.isNotEmptyString(l)&&u>0){var m=this.getSetting("dupFieldsMap",{});var d=[],f,g,_;var C,y,B;var X=h&&BX.type.isNotEmptyString(c);for(C in m){if(!m.hasOwnProperty(C))continue;if(m.hasOwnProperty(C)&&o===parseInt(C)&&BX.type.isArray(m[C])){y=m[C];B=0;for(e=0;e<y.length;e++){f=X?c.replace("#FIELD_NAME#",y[e]):y[e];d[B++]="[name="+f+"]"}}}d=d.join(",");g=n.querySelectorAll(d);for(e=0;e<g.length;e++){_=this.getFieldNameByElement(g[e],X?a:"");if(BX.type.isNotEmptyString(_)){this.registerBankDetailField(i,l,u,s,o,_,g[e])}}}},onRequisiteEditFormRemove:function(t){var e="";if(t!==null&&typeof t==="object"){e=t.getFormId();if(BX.type.isNotEmptyString(e)){e=e.replace(/[^a-z0-9_]/gi,"");this.unregisterBankDetailFieldsByFormId(e)}}},onDupControllerDelete:function(t){if(this._dupController&&this._dupController===t)BX.CrmDupControllerBankDetail.delete(this._id)},onRequisitePopupClose:function(t){var e="";if(t!==null&&typeof t==="object"){e=t.getFormId();if(BX.type.isNotEmptyString(e)){e=e.replace(/[^a-z0-9_]/gi,"");if(BX.type.isNotEmptyString(e)&&this._formFieldMap.hasOwnProperty(e)){var i=null;if(this._dupController)i=this._dupController;BX.CrmDupControllerBankDetail.delete(this._id);if(i)BX.CrmDupController.delete(i.getId())}}}},onBankDetailBlockRemove:function(t){var e="";if(t!==null&&typeof t==="object"){e=t.getFormId();if(BX.type.isNotEmptyString(e)){e=e.replace(/[^a-z0-9_]/gi,"");var i=t.getPseudoId();if(BX.type.isNumber(i))i=i.toString();if(BX.type.isNotEmptyString(i))this.unregisterBankDetailFieldsByBankDetailId(e,i)}}},getFieldNameByElement:function(t,e){var i="";if(BX.type.isElementNode(t)){i=t.getAttribute("name");if(BX.type.isNotEmptyString(e)&&BX.type.isNotEmptyString(i)){var n,r;var s;n="#FIELD_NAME#";s=e.indexOf(n);if(s>=0){if(s<i.length){i=i.substr(s)}s=s+n.length;if(s<e.length){r=e.substr(s);s=i.lastIndexOf(r);if(s>=0){i=i.substr(0,s)}}}}}return i},registerBankDetailField:function(t,e,i,n,r,s,o){var a=s+"|"+r.toString();var l=this.getGroup(a);if(!l){var u=this.getSetting("dupFieldsDescriptions",{});var h=a;if(u[s]&&u[s][r]){h=u[s][r]}l=this.addGroup(a,{controller:this,countryId:r,fieldName:s,groupSummaryTitle:this.getSetting("groupSummaryTitle","")+' "'+h+'"'})}if(l){var c=o.getAttribute("name");if(!this._formFieldMap.hasOwnProperty(t))this._formFieldMap[t]={};if(!this._formFieldMap[t].hasOwnProperty(a))this._formFieldMap[t][a]={};if(!this._formFieldMap[t][a].hasOwnProperty(n))this._formFieldMap[t][a][n]={};this._formFieldMap[t][a][n][c]=l.addField(BX.CrmDupCtrlBankDetailField.create(c,o,null,{formId:t,requisitePseudoId:e,presetId:i,bankDetailPseudoId:n,countryId:r,fieldName:s}))}},unregisterBankDetailFieldsByFormId:function(t){if(BX.type.isNotEmptyString(t)&&this._formFieldMap.hasOwnProperty(t)){var e;var i=this._formFieldMap[t];var n={};delete this._formFieldMap[t];for(e in i){if(i.hasOwnProperty(e)){var r;var s=i[e];for(r in s){if(s.hasOwnProperty(r)){var o;var a=s[r];for(o in a){if(a.hasOwnProperty(o)){if(this.unregisterBankDetailField(e,o)){if(!n.hasOwnProperty(e))n[e]={group:this.getGroup(e),fields:[]};n[e]["fields"].push(a[o])}}}}}}}if(this._dupController)this._dupController.processGroupsChange(n)}},unregisterBankDetailFieldsByBankDetailId:function(t,e){if(BX.type.isNotEmptyString(t)&&this._formFieldMap.hasOwnProperty(t)&&BX.type.isNotEmptyString(e)){var i;var n=this._formFieldMap[t];var r={};for(i in n){if(n.hasOwnProperty(i)){var s;var o=n[i];for(s in o){if(s===e&&o.hasOwnProperty(s)){var a;var l=o[s];for(a in l){if(l.hasOwnProperty(a)){if(this.unregisterBankDetailField(i,a)){if(!r.hasOwnProperty(i))r[i]={group:this.getGroup(i),fields:[]};r[i]["fields"].push(l[a])}}}delete this._formFieldMap[t][i][e];var u,h=this._formFieldMap[t][i];var c=true;for(u in h){if(h.hasOwnProperty(u)){c=false;break}}if(c)delete this._formFieldMap[t][i];u=h=c=null}}}}if(this._dupController)this._dupController.processGroupsChange(r)}},unregisterBankDetailField:function(t,e){var i=this.getGroup(t);if(i){return i.removeField(e)}return false},addGroup:function(t,e){var i=null;if(BX.type.isNotEmptyString(t)){var n=BX.CrmDupCtrlBankDetail.create(t,e);if(n){this._groups[t]=n;if(this._dupController)this._dupController.addGroup(n);i=n}}return i},deleteGroup:function(t){var e=false;if(BX.type.isNotEmptyString(t)&&this._groups.hasOwnProperty(t)){if(this._dupController)this._dupController.deleteGroup(t);else this._groups[t].clearFields();delete this._groups[t];e=true}return e},getGroup:function(t){if(BX.type.isNotEmptyString(t)&&this._groups.hasOwnProperty(t)){return this._groups[t]}return null}};BX.CrmDupControllerBankDetail.items={};BX.CrmDupControllerBankDetail.getItem=function(t){return this.items.hasOwnProperty(t)?this.items[t]:null};BX.CrmDupControllerBankDetail.create=function(t,e){var i=new BX.CrmDupControllerBankDetail;i.initialize(t,e);BX.CrmDupControllerBankDetail.items[t]=i;return i};BX.CrmDupControllerBankDetail.delete=function(t){if(BX.CrmDupControllerBankDetail.items.hasOwnProperty(t)){var e=BX.CrmDupControllerBankDetail.items[t];e.destroy();delete BX.CrmDupControllerBankDetail.items[t]}}}if(typeof BX.CrmDuplicateSummaryItem==="undefined"){BX.CrmDuplicateSummaryItem=function(){this._id="";this._settings={};this._groupId="";this._controller=null;this._container=null};BX.CrmDuplicateSummaryItem.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._controller=this.getSetting("controller",null);if(!this._controller){throw"BX.CrmDuplicateListPopup. Parameter 'controller' is not found."}this._container=this.getSetting("container",null);if(!this._controller){throw"BX.CrmDuplicateSummaryItem. Parameter 'container' is not found."}this._link=this.getSetting("link",null);if(!this._link){throw"BX.CrmDuplicateSummaryItem. Parameter 'link' is not found."}BX.bind(this._link,"click",BX.delegate(this._onLinkClick,this));this._groupId=this.getSetting("groupId",null)},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},_onLinkClick:function(t){if(this._groupId!==""){var e=BX.CrmDuplicateListPopup.create(this._id,{controller:this._controller,groupId:this._groupId});e.show()}}};BX.CrmDuplicateSummaryItem.create=function(t,e){var i=new BX.CrmDuplicateSummaryItem;i.initialize(t,e);return i}}if(typeof BX.CrmDuplicateSummaryPopup==="undefined"){BX.CrmDuplicateSummaryPopup=function(){this._id="";this._settings={};this._controller=null;this._items={};this._popup=null};BX.CrmDuplicateSummaryPopup.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._controller=this.getSetting("controller",null);if(!this._controller){throw"BX.CrmDuplicateSummaryPopup. Parameter 'controller' is not found."}},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},getId:function(){return this._id},show:function(){if(this.isShown()){return}var t=this.getId();if(BX.CrmDuplicateSummaryPopup.windows[t]){BX.CrmDuplicateSummaryPopup.windows[t].destroy()}var e=this.getSetting("anchor",null);var i=this.getSetting("position","");if(i===""){i="left"}var n="right";var r=0;var s=0;if(i==="top"){n="bottom"}else if(i==="bottom"){n="top";r=40}else if(i==="right"){n="left"}this._popup=new BX.PopupWindow(t,e,{autoHide:false,draggable:true,closeByEsc:false,closeIcon:{marginRight:"-4px",marginTop:"-4px"},zIndex:1,events:{onPopupClose:BX.delegate(this._onPopupClose,this),onPopupDestroy:BX.delegate(this._onPopupDestroy,this)},content:this._prepareContent(),className:"crm-tip-popup",angle:{position:n},offsetLeft:r,offsetTop:s,lightShadow:true});BX.CrmDuplicateSummaryPopup.windows[t]=this._popup;this._popup.show();var o,a,l,u;if(i==="left"){o=BX.pos(e);a=BX.pos(this._popup.angle.element);l=this._popup.popupContainer.offsetWidth+a.width+5;u=o.height+(a.height+this._popup.angle.element.offsetTop)/2;this._popup.move(-l,-u)}else if(i==="right"){o=BX.pos(e);a=BX.pos(this._popup.angle.element);l=o.width+a.width;u=o.height;this._popup.move(l,-u)}},close:function(){if(!(this._popup&&this._popup.isShown())){return}this._popup.close()},isShown:function(){return this._popup&&this._popup.isShown()},getMessage:function(t){return BX.CrmDuplicateSummaryPopup.messages&&BX.CrmDuplicateSummaryPopup.messages.hasOwnProperty(t)?BX.CrmDuplicateSummaryPopup.messages[t]:""},_prepareContent:function(){this._items={};var t={};var e=this._controller.getDuplicateData();var i;for(i in e){if(!e.hasOwnProperty(i)){continue}var n=e[i];if(BX.type.isNotEmptyString(n["totalText"])){t[i]={total:n["totalText"]}}}var r=BX.create("DIV",{attrs:{className:"crm-tip-popup-cont"}});var s=false;for(i in t){if(!t.hasOwnProperty(i)){continue}var o=this._controller.getGroup(i);if(!o){continue}var a=BX.create("SPAN",{attrs:{className:"ui-link ui-link-dotted"},text:t[i]["total"]});var l=BX.create("DIV",{attrs:{className:"crm-tip-popup-item"}});if(!s){l.appendChild(BX.create("SPAN",{text:this.getMessage("title")+" "}));s=true}l.appendChild(a);l.appendChild(BX.create("SPAN",{text:" "+o.getSummaryTitle()}));r.appendChild(l);this._items[i]=BX.CrmDuplicateSummaryItem.create(i,{controller:this._controller,container:l,link:a,groupId:i})}return r},_onPopupClose:function(){if(this._popup){this._popup.destroy()}},_onPopupDestroy:function(){if(this._popup){this._popup=null}}};BX.CrmDuplicateSummaryPopup.windows={};if(typeof BX.CrmDuplicateSummaryPopup.messages==="undefined"){BX.CrmDuplicateSummaryPopup.messages={}}BX.CrmDuplicateSummaryPopup.create=function(t,e){var i=new BX.CrmDuplicateSummaryPopup;i.initialize(t,e);return i}}if(typeof BX.CrmDuplicateWarningDialog==="undefined"){BX.CrmDuplicateWarningDialog=function(){this._id="";this._settings={};this._controller=null;this._popup=null;this._contentWrapper=null};BX.CrmDuplicateWarningDialog.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._controller=this.getSetting("controller",null);if(!this._controller){throw"BX.CrmDuplicateWarningDialog. Parameter 'controller' is not found."}},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},getId:function(){return this._id},show:function(){if(this.isShown()){return}var t=this.getId();if(BX.CrmDuplicateWarningDialog.windows[t]){BX.CrmDuplicateWarningDialog.windows[t].destroy()}var e=this.getSetting("anchor",null);this._popup=new BX.PopupWindow(t,e,{autoHide:false,draggable:true,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{marginRight:"4px",marginTop:"9px"},zIndex:3,titleBar:this.getMessage("title"),events:{onPopupShow:BX.delegate(this._onPopupShow,this),onPopupClose:BX.delegate(this._onPopupClose,this),onPopupDestroy:BX.delegate(this._onPopupDestroy,this)},content:this._prepareContent(),className:"crm-tip-popup",lightShadow:true,buttons:[new BX.PopupWindowButton({text:this.getMessage("acceptButtonTitle"),className:"popup-window-button-create",events:{click:BX.delegate(this._onAcceptButtonClick,this)}}),new BX.PopupWindowButtonLink({text:this.getMessage("cancelButtonTitle"),className:"webform-button-link-cancel",events:{click:BX.delegate(this._onCancelButtonClick,this)}})]});BX.CrmDuplicateWarningDialog.windows[t]=this._popup;this._popup.show();this._contentWrapper.tabIndex="1";this._contentWrapper.focus()},close:function(){if(!(this._popup&&this._popup.isShown())){return}this._popup.close()},isShown:function(){return this._popup&&this._popup.isShown()},getMessage:function(t){return BX.CrmDuplicateWarningDialog.messages&&BX.CrmDuplicateWarningDialog.messages.hasOwnProperty(t)?BX.CrmDuplicateWarningDialog.messages[t]:""},_prepareContent:function(){this._contentWrapper=BX.CrmDuplicateRenderer.prepareListContent(this._controller.getDuplicateData());return this._contentWrapper},_onCancelButtonClick:function(){var t=this.getSetting("onCancel",null);if(BX.type.isFunction(t)){t(this)}},_onAcceptButtonClick:function(){var t=this.getSetting("onAccept",null);if(BX.type.isFunction(t)){t(this)}},_onPopupShow:function(){if(!this._contentWrapper){return}BX.bind(this._contentWrapper,"keyup",BX.delegate(this._onKeyUp,this))},_onPopupClose:function(){var t=this.getSetting("onClose",null);if(BX.type.isFunction(t)){t(this)}if(this._popup){this._popup.destroy()}},_onPopupDestroy:function(){if(this._popup){this._popup=null}},_onKeyUp:function(t){var e=t.keyCode;if(e===13){var i=this.getSetting("onAccept",null);if(BX.type.isFunction(i)){i(this)}}}};BX.CrmDuplicateWarningDialog.windows={};if(typeof BX.CrmDuplicateWarningDialog.messages==="undefined"){BX.CrmDuplicateWarningDialog.messages={}}BX.CrmDuplicateWarningDialog.create=function(t,e){var i=new BX.CrmDuplicateWarningDialog;i.initialize(t,e);return i}}if(typeof BX.CrmDuplicateListPopup==="undefined"){BX.CrmDuplicateListPopup=function(){this._id="";this._settings={};this._controller=null;this._groupId="";this._popup=null;this._contentWrapper=null};BX.CrmDuplicateListPopup.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._controller=this.getSetting("controller",null);if(!this._controller){throw"BX.CrmDuplicateListPopup. Parameter 'controller' is not found."}this._groupId=this.getSetting("groupId",null)},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},getId:function(){return this._id},show:function(){if(this.isShown()){return}var t=this.getId();if(BX.CrmDuplicateListPopup.windows[t]){BX.CrmDuplicateListPopup.windows[t].destroy()}var e=this.getSetting("anchor",null);this._popup=new BX.PopupWindow(t,e,{autoHide:true,draggable:false,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{marginRight:"-4px",marginTop:"-4px"},zIndex:2,events:{onPopupShow:BX.delegate(this._onPopupShow,this),onPopupClose:BX.delegate(this._onPopupClose,this),onPopupDestroy:BX.delegate(this._onPopupDestroy,this)},content:this._prepareContent(),lightShadow:true,className:"crm-tip-popup"});BX.CrmDuplicateListPopup.windows[t]=this._popup;this._popup.show()},close:function(){if(!(this._popup&&this._popup.isShown())){return}this._popup.close()},isShown:function(){return this._popup&&this._popup.isShown()},getMessage:function(t){return BX.CrmDuplicateListPopup.messages&&BX.CrmDuplicateListPopup.messages.hasOwnProperty(t)?BX.CrmDuplicateListPopup.messages[t]:""},_prepareContent:function(){this._contentWrapper=BX.CrmDuplicateRenderer.prepareListContent(this._controller.getDuplicateData(),{groupId:this._groupId,classes:["crm-cont-info-popup-light"]});return this._contentWrapper},_onPopupShow:function(){},_onPopupClose:function(){var t=this.getSetting("onClose",null);if(BX.type.isFunction(t)){t(this)}if(this._popup){this._popup.destroy()}},_onPopupDestroy:function(){if(this._popup){this._popup=null}}};BX.CrmDuplicateListPopup.windows={};if(typeof BX.CrmDuplicateListPopup.messages=="undefined"){BX.CrmDuplicateListPopup.messages={}}BX.CrmDuplicateListPopup.create=function(t,e){var i=new BX.CrmDuplicateListPopup;i.initialize(t,e);return i}}if(typeof BX.CrmDuplicateRenderer==="undefined"){BX.CrmDuplicateRenderer=function(){};BX.CrmDuplicateRenderer._onCommunicationBlockClick=function(t){var e=null;if(t){if(t.target){e=t.target}else if(t.srcElement){e=t.srcElement}}if(BX.type.isElementNode(e)){if(BX.hasClass(e,"crm-info-popup-block-main")){BX.removeClass(e,"crm-info-popup-block-main")}var i=BX.findParent(e,{className:"crm-info-popup-block"});if(BX.type.isElementNode(i)&&!BX.hasClass(i,"crm-info-popup-block-open")){BX.addClass(i,"crm-info-popup-block-open")}BX.unbind(e,"click",BX.CrmDuplicateRenderer._onCommunicationBlockClickHandler)}};BX.CrmDuplicateRenderer._onCommunicationBlockClickHandler=BX.delegate(BX.CrmDuplicateRenderer._onCommunicationBlockClick,BX.CrmDuplicateRenderer);BX.CrmDuplicateRenderer._prepareCommunications=function(t){if(!BX.type.isArray(t)||t.length===0){return null}var e=t.length;if(e===1){return BX.util.htmlspecialchars(t[0])}var i=BX.create("DIV",{attrs:{className:"crm-info-popup-block"}});var n=BX.create("DIV",{attrs:{className:"crm-info-popup-block-main"},text:t[0]});i.appendChild(n);BX.bind(n,"click",this._onCommunicationBlockClickHandler);var r=BX.create("DIV",{attrs:{className:"crm-info-popup-block-inner"}});for(var s=1;s<e;s++){r.appendChild(BX.create("DIV",{text:t[s]}))}i.appendChild(r);return i};BX.CrmDuplicateRenderer.prepareListContent=function(t,e){if(!e){e={}}var i=BX.type.isNotEmptyString(e["groupId"])?e["groupId"]:"";var n={};for(var r in t){if(!t.hasOwnProperty(r)){continue}if(i!==""&&i!==r){continue}var s=t[r];var o=BX.type.isArray(s["items"])?s["items"]:[];var a=o.length;for(var l=0;l<a;l++){var u=o[l];var h=BX.type.isArray(u["ENTITIES"])?u["ENTITIES"]:[];var c=h.length;for(var p=0;p<c;p++){var m=h[p];var d=BX.type.isNotEmptyString(m["ENTITY_TYPE_ID"])?parseInt(m["ENTITY_TYPE_ID"]):0;if(!BX.CrmEntityType.isDefined(d)){continue}var f=BX.CrmEntityType.resolveName(d);if(typeof n[f]==="undefined"){n[f]=[m]}else{var g=BX.type.isNotEmptyString(m["ENTITY_ID"])?parseInt(m["ENTITY_ID"]):0;var _=false;for(var C=0;C<n[f].length;C++){var y=n[f][C];var B=BX.type.isNotEmptyString(y["ENTITY_ID"])?parseInt(y["ENTITY_ID"]):0;if(B===g){_=true;break}}if(!_){n[f].push(m)}}}}}var X=BX.create("DIV",{attrs:{className:"crm-cont-info-popup"}});var v=typeof e["classes"]!=="undefined"?e["classes"]:null;if(BX.type.isArray(v)){for(var S=0;S<v.length;S++){BX.addClass(X,v[S])}}var E=BX.create("TABLE",{attrs:{className:"crm-cont-info-table"}});X.appendChild(E);var D=false;var I=false;for(var N in n){if(!n.hasOwnProperty(N)){continue}var P=E.insertRow(-1);P.className="crm-cont-info-table-title";var w=P.insertCell(-1);w.colspan=4;w.innerHTML=BX.util.htmlspecialchars(BX.CrmEntityType.categoryCaptions[N]);var T=n[N];var b=T.length;for(var R=0;R<b;R++){var F=T[R];var O=E.insertRow(-1);var L=O.insertCell(-1);if(BX.type.isNotEmptyString(F["URL"])){L.appendChild(BX.create("A",{attrs:{href:F["URL"],target:"_blank"},text:BX.type.isNotEmptyString(F["TITLE"])?F["TITLE"]:"[Untitled]"}))}else{L.innerHTML=BX.type.isNotEmptyString(F["TITLE"])?BX.util.htmlspecialchars(F["TITLE"]):"[Untitled]"}var M=false;var k=O.insertCell(-1);var A=BX.type.isArray(F["EMAIL"])?this._prepareCommunications(F["EMAIL"]):null;if(BX.type.isElementNode(A)){k.appendChild(A);M=true}else if(BX.type.isNotEmptyString(A)){k.innerHTML=A;M=true}else if(!D){D=true}var x=false;var q=O.insertCell(-1);q.className="crm-cont-info-table-tel";var U=BX.type.isArray(F["PHONE"])?this._prepareCommunications(F["PHONE"]):null;if(BX.type.isElementNode(U)){q.appendChild(U);x=true}else if(BX.type.isNotEmptyString(U)){q.innerHTML=U;x=true}else if(!D){D=true}if(M&&x&&!I){I=true}var H=O.insertCell(-1);var z=BX.type.isNotEmptyString(F["RESPONSIBLE_ID"])?parseInt(F["RESPONSIBLE_ID"]):0;if(z>0){var j=BX.create("DIV",{attrs:{className:"crm-info-popup-user"}});H.appendChild(j);j.className="crm-info-popup-user";j.setAttribute("data-userid",z.toString());j.setAttribute("bx-tooltip-user-id",z.toString());var W={};if(BX.type.isNotEmptyString(F["RESPONSIBLE_PHOTO_URL"])){W["background"]="url("+F["RESPONSIBLE_PHOTO_URL"]+") repeat scroll center center"}j.appendChild(BX.create("SPAN",{attrs:{className:"crm-info-popup-user-img"},style:W}));j.appendChild(BX.create("A",{attrs:{target:"_blank",href:BX.type.isNotEmptyString(F["RESPONSIBLE_URL"])?F["RESPONSIBLE_URL"]:"#",className:"crm-info-popup-user-name"},text:BX.type.isNotEmptyString(F["RESPONSIBLE_FULL_NAME"])?F["RESPONSIBLE_FULL_NAME"]:"["+z+"]"}))}}}if(!I){BX.addClass(E,"crm-cont-info-table-empty")}return X}}if(typeof BX.NotificationPopup==="undefined"){BX.NotificationPopup=function(){this._id="";this._settings={};this._popup=null;this._contentWrapper=null;this._title="";this._timeout=3e3;this._timeoutId=null;this._messages=[]};BX.NotificationPopup.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._messages=this.getSetting("messages",null);if(!BX.type.isArray(this._messages)||this._messages.length===0){throw"BX.NotificationPopup. Parameter 'messages' is not defined or empty."}var i=parseInt(this.getSetting("timeout",3e3));if(isNaN(i)||i<=0){i=3e3}this._timeout=i},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},getId:function(){return this._id},show:function(){if(this.isShown()){return}var t=this.getId();if(BX.NotificationPopup.windows[t]){BX.NotificationPopup.windows[t].destroy()}this._popup=new BX.PopupWindow(t,null,{autoHide:true,draggable:false,zIndex:10200,className:"bx-notification-popup",closeByEsc:true,events:{onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},content:this.prepareContent()});BX.NotificationPopup.windows[t]=this._popup;this._popup.show();this._timeoutId=setTimeout(BX.delegate(this.close,this),this._timeout);BX.bind(this._contentWrapper,"mouseover",BX.delegate(this._onMouseOver,this));BX.bind(this._contentWrapper,"mouseout",BX.delegate(this._onMouseOut,this))},_onMouseOver:function(t){if(this._timeoutId!==null){clearTimeout(this._timeoutId)}},_onMouseOut:function(t){this._timeoutId=setTimeout(BX.delegate(this.close,this),this._timeout)},close:function(){if(!(this._popup&&this._popup.isShown())){return}this._popup.close()},isShown:function(){return this._popup&&this._popup.isShown()},prepareContent:function(){this._contentWrapper=BX.create("DIV",{attrs:{className:"bx-notification"}});var t=this.getSetting("align","");if(t==="justify"){BX.addClass(this._contentWrapper,"bx-notification-content-justify")}this._contentWrapper.appendChild(BX.create("SPAN",{attrs:{className:"bx-notification-aligner"}}));for(var e=0;e<this._messages.length;e++){this._contentWrapper.appendChild(BX.create("SPAN",{props:{className:"bx-notification-text"},text:this._messages[e]}))}this._contentWrapper.appendChild(BX.create("DIV",{props:{className:"bx-notification-footer"}}));return this._contentWrapper},onPopupClose:function(){if(this._popup){this._popup.destroy()}},onPopupDestroy:function(){if(this._popup){this._popup=null}if(this._contentWrapper){this._contentWrapper=null}}};BX.NotificationPopup.windows={};BX.NotificationPopup.create=function(t,e){var i=new BX.NotificationPopup;i.initialize(t,e);return i};BX.NotificationPopup.show=function(t,e){this.create(t,e).show()}}if(typeof BX.CrmInterfaceMode==="undefined"){BX.CrmInterfaceMode={edit:1,view:2}}if(typeof BX.GridAjaxLoader==="undefined"){BX.GridAjaxLoader=function(){this._id="";this._settings={};this._url="";this._method="";this._data={};this._dataType="html";this._ajaxId="";this._ajaxInsertHandler=BX.delegate(this._onAjaxInsert,this)};BX.GridAjaxLoader.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._url=this.getSetting("url","");this._method=this.getSetting("method","GET");this._data=this.getSetting("data",{});this._dataType=this.getSetting("dataType","html");this._ajaxId=this.getSetting("ajaxId","");this._urlAjaxIdRegex=/bxajaxid\s*=\s*([a-z0-9]+)/i;this._urlPageNumRegexes=[/(PAGEN_[0-9]+)\s*=\s*([0-9]+)/i,/(page)\s*=\s*(-?[0-9]+)/i];BX.addCustomEvent(window,"onAjaxInsertToNode",this._ajaxInsertHandler)},release:function(){BX.removeCustomEvent(window,"onAjaxInsertToNode",this._ajaxInsertHandler)},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getId:function(){return this._id},reload:function(t,e){if(!BX.type.isNotEmptyString(t)){t=this._url}t=BX.util.add_url_param(t,{bxajaxid:this._ajaxId});var i={url:t,dataType:this._dataType};if(this._method==="POST"){i["method"]="POST";i["data"]=this._data}else{i["method"]="GET"}if(BX.type.isFunction(e)){i["onsuccess"]=e}BX.ajax(i)},loadPage:function(t,e){var i={bxajaxid:this._ajaxId};i[t]=e;var n={url:BX.util.add_url_param(this._url,i),dataType:this._dataType};if(this._method==="POST"){n["method"]="POST";n["data"]=this._data}else{n["method"]="GET"}n["onsuccess"]=BX.delegate(this._onPageLoadSuccess,this);BX.ajax(n)},setupFormAction:function(t,e){if(!BX.type.isNotEmptyString(e)){e=this._url}e=BX.util.add_url_param(e,{bxajaxid:this._ajaxId});t.action=e},setupForm:function(t,e){this.setupFormAction(t,e);BX.util.addObjectToForm(this._data,t)},_onAjaxInsert:function(t){if(typeof t.eventArgs==="undefined"){return}var e=this._urlAjaxIdRegex.exec(t.url);if(BX.type.isArray(e)&&e.length>1&&e[1]===this._ajaxId){var i=this._urlPageNumRegexes.length;for(var n=0;n<i;n++){e=this._urlPageNumRegexes[n].exec(t.url);if(!(BX.type.isArray(e)&&e.length>2)){continue}this.loadPage(e[1],e[2]);t.eventArgs.cancel=true;return}}},_onPageLoadSuccess:function(t){var e=BX("comp_"+this._ajaxId);if(e){e.innerHTML=t}}};BX.GridAjaxLoader.items={};BX.GridAjaxLoader.create=function(t,e){var i=new BX.GridAjaxLoader;i.initialize(t,e);this.items[t]=i;return i};BX.GridAjaxLoader.remove=function(t){if(typeof this.items[t]==="undefined"){return}this.items[t].release();delete this.items[t]}}if(typeof BX.AddressFormatSelector==="undefined"){BX.AddressFormatSelector=function(){this._id="";this._settings={};this._controlPrefix="";this._descrContainer=null;this._typeInfos={}};BX.AddressFormatSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._controlPrefix=this.getSetting("controlPrefix");this._typeInfos=this.getSetting("typeInfos",{});for(var i in this._typeInfos){if(!this._typeInfos.hasOwnProperty(i)){continue}var n=BX(this._controlPrefix+i.toLowerCase());if(n){BX.bind(n,"change",BX.delegate(this._onControlChange,this))}}this._descrContainer=BX(this.getSetting("descrContainerId"))},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},_onControlChange:function(t){if(!t){t=window.event}var e=BX.getEventTarget(t);if(e&&BX.type.isNotEmptyString(this._typeInfos[e.value])&&this._descrContainer){this._descrContainer.innerHTML=this._typeInfos[e.value]}}};BX.AddressFormatSelector.create=function(t,e){var i=new BX.AddressFormatSelector;i.initialize(t,e);return i}}if(typeof BX.CrmLongRunningProcessManager==="undefined"){BX.CrmLongRunningProcessManager=function(){this._id="";this._settings={};this._serviceUrl="";this._actionName="";this._dialog=null};BX.CrmLongRunningProcessManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_lrp_mgr_"+Math.random().toString().substring(2);this._settings=e?e:{};this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"BX.CrmLongRunningProcessManager. Could not find 'serviceUrl' parameter in settings."}this._actionName=this.getSetting("actionName","");if(!BX.type.isNotEmptyString(this._actionName)){throw"BX.CrmLongRunningProcessManager. Could not find 'actionName' parameter in settings."}},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},getMessage:function(t){var e=BX.CrmLongRunningProcessManager.messages;return e.hasOwnProperty(t)?e[t]:t},getServiceUrl:function(){return this._serviceUrl},getActionName:function(){return this._actionName},run:function(){if(!this._dialog){var t=this.getSetting("dialogTitle",this.getMessage("dialogTitle"));var e=this.getSetting("dialogSummary",this.getMessage("dialogSummary"));this._dialog=BX.CrmLongRunningProcessDialog.create(this.getId(),{serviceUrl:this.getServiceUrl(),action:this.getActionName(),title:t,summary:e})}BX.addCustomEvent(this._dialog,"ON_STATE_CHANGE",BX.delegate(this._onProcessStateChange,this));this._dialog.show()},_onProcessStateChange:function(t){if(t===this._dialog){if(this._dialog.getState()===BX.CrmLongRunningProcessState.completed){BX.onCustomEvent(this,"ON_LONG_RUNNING_PROCESS_COMPLETE",[this])}}}};if(typeof BX.CrmLongRunningProcessManager.messages=="undefined"){BX.CrmLongRunningProcessManager.messages={}}BX.CrmLongRunningProcessManager.items={};BX.CrmLongRunningProcessManager.create=function(t,e){var i=new BX.CrmLongRunningProcessManager;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmLongRunningProcessPanel==="undefined"){BX.CrmLongRunningProcessPanel=function(){this._id="";this._settings={};this._prefix="";this._hasLayout=false;this._active=false;this._container=null;this._wrapper=null;this._link=null;this._manager=null;this._clickHandler=BX.delegate(this.onClick,this);this._processCompleteHandler=BX.delegate(this.onProcessComplete,this)};BX.CrmLongRunningProcessPanel.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._container=BX(this.getSetting("containerId"));if(!this._container){throw"CrmLongRunningProcessPanel: Could not find container."}this._active=!!this.getSetting("active",false);this._prefix=this.getSetting("prefix");this._message=this.getSetting("message");this._manager=BX.CrmLongRunningProcessManager.create(this._id,this.getSetting("manager"))},layout:function(){if(this._hasLayout){return}this._wrapper=BX.create("DIV",{props:{className:"crm-view-message"}});this._container.appendChild(this._wrapper);if(!this._active){this._wrapper.style.display="none"}var t=(this._prefix!==""?this._prefix:this._id)+"_link";var e=this._message.replace(/#ID#/gi,t).replace(/#URL#/gi,"#");this._wrapper.appendChild(BX.create("SPAN",{html:e}));this._link=BX(t);if(this._link){BX.bind(this._link,"click",this._clickHandler)}this._hasLayout=true},cleanLayout:function(){if(!this._hasLayout){return}if(this._link){BX.unbind(this._link,"click",this._clickHandler);this._link=null}BX.cleanNode(this._wrapper,true);this._wrapper=null;this._hasLayout=false},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},isActive:function(){return this._active},setActive:function(t){t=!!t;if(this._active===t){return}this._active=t;this._wrapper.style.display=t?"":"none"},onClick:function(t){BX.addCustomEvent(this._manager,"ON_LONG_RUNNING_PROCESS_COMPLETE",this._processCompleteHandler);this._manager.run();return BX.PreventDefault(t)},onProcessComplete:function(t){if(t!==this._manager){return}BX.removeCustomEvent(this._manager,"ON_LONG_RUNNING_PROCESS_COMPLETE",this._processCompleteHandler);this.setActive(false)}};BX.CrmLongRunningProcessPanel.create=function(t,e){var i=new BX.CrmLongRunningProcessPanel;i.initialize(t,e);return i}}if(typeof BX.InterfaceFilterFieldInfoProvider==="undefined"){BX.InterfaceFilterFieldInfoProvider=function(){this._id="";this._settings={};this._infos=null;this._setFildsHandler=BX.delegate(this.onSetFilterFields,this);this._getFildsHandler=BX.delegate(this.onGetFilterFields,this)};BX.InterfaceFilterFieldInfoProvider.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._infos=this.getSetting("infos",null);BX.onCustomEvent(window,"InterfaceFilterFieldInfoProviderCreate",[this])},getId:function(){return this._id},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},registerFilter:function(t){BX.addCustomEvent(t,"AFTER_SET_FILTER_FIELDS",this._setFildsHandler);BX.addCustomEvent(t,"AFTER_GET_FILTER_FIELDS",this._getFildsHandler)},getFieldInfos:function(){return this._infos},onSetFilterFields:function(t,e,i){var n=this._infos;if(!BX.type.isArray(n)){return}var r=e.name.indexOf("flt_settings")===0;var s=n.length;var o="";for(var a=0;a<s;a++){var l=n[a];var u=BX.type.isNotEmptyString(l["id"])?l["id"]:"";var h=BX.type.isNotEmptyString(l["typeName"])?l["typeName"].toUpperCase():"";var c=l["params"]?l["params"]:{};if(h==="USER"){var p=c["data"]?c["data"]:{};this.setElementByFilter(p[r?"settingsElementId":"elementId"],p["paramName"],i);var m=c["search"]?c["search"]:{};this.setElementByFilter(m[r?"settingsElementId":"elementId"],m["paramName"],i)}}},onGetFilterFields:function(t,e,i){var n=this._infos;if(!BX.type.isArray(n)){return}var r=e.name.indexOf("flt_settings")===0;var s=n.length;for(var o=0;o<s;o++){var a=n[o];var l=BX.type.isNotEmptyString(a["id"])?a["id"]:"";var u=BX.type.isNotEmptyString(a["typeName"])?a["typeName"].toUpperCase():"";var h=a["params"]?a["params"]:{};if(u==="USER"){var c=h["data"]?h["data"]:{};this.setFilterByElement(c[r?"settingsElementId":"elementId"],c["paramName"],i);var p=h["search"]?h["search"]:{};this.setFilterByElement(p[r?"settingsElementId":"elementId"],p["paramName"],i)}}},setElementByFilter:function(t,e,i){var n=BX.type.isNotEmptyString(t)?BX(t):null;if(BX.type.isElementNode(n)){n.value=BX.type.isNotEmptyString(e)&&i[e]?i[e]:""}},setFilterByElement:function(t,e,i){var n=BX.type.isNotEmptyString(t)?BX(t):null;if(BX.type.isElementNode(n)&&BX.type.isNotEmptyString(e)){i[e]=n.value}}};BX.InterfaceFilterFieldInfoProvider.items={};BX.InterfaceFilterFieldInfoProvider.create=function(t,e){var i=new BX.InterfaceFilterFieldInfoProvider;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmConversionSchemeSelector==="undefined"){BX.CrmConversionSchemeSelector=function(){this._id="";this._settings={};this._entityId=0;this._scheme="";this._isMenuShown=false;this._menuId="";this._container=null;this._containerClickHandler=BX.delegate(this.onContainerClick,this);this._label=null;this._button=null;this._buttonClickHandler=BX.delegate(this.onButtonClick,this);this._menuIiemClickHandler=BX.delegate(this.onMenuItemClick,this);this._menuCloseHandler=BX.delegate(this.onMenuClose,this);this._hint=null};BX.CrmConversionSchemeSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._entityId=parseInt(this.getSetting("entityId",0));if(!BX.type.isNumber(this._entityId)){throw"BX.CrmConversionSchemeSelector: entity id is not found!"}this._scheme=this.getSetting("scheme","");this._container=BX(this.getSetting("containerId"));if(!BX.type.isElementNode(this._container)){throw"BX.CrmConversionSchemeSelector: container element is not found!"}BX.bind(this._container,"click",this._containerClickHandler);this._menuId="crm_menu_popup_"+this._id.toLowerCase();this._button=BX(this.getSetting("buttonId"));if(!BX.type.isElementNode(this._button)){throw"BX.CrmConversionSchemeSelector: button element is not found!"}BX.bind(this._button,"click",this._buttonClickHandler);var i=this.getSetting("labelId","");if(BX.type.isNotEmptyString(i)){this._label=BX(i)}if(this.getSetting("enableHint",false)){this.createHint(this.getSetting("hintMessages",null))}this.doInitialize();BX.addCustomEvent(window,"BX.CrmEntityConverter:applyPermissions",BX.delegate(this.applyPermissions,this))},doInitialize:function(){},release:function(){this.closeMenu();BX.unbind(this._container,"click",this._containerClickHandler);BX.unbind(this._button,"click",this._buttonClickHandler)},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},getId:function(){return this._id},getEntityTypeName:function(){return BX.CrmEntityType.names.undefined},getScheme:function(){return this._scheme},setScheme:function(t,e){this._scheme=t;this.processSchemeChange(e)},processSchemeChange:function(t){if(this._label){this._label.innerHTML=BX.util.htmlspecialchars(this.getSchemeDescription(this._scheme))}if(BX.prop.getBoolean(t,"convert",true)){window.setTimeout(BX.delegate(this.convert,this),250)}},getSchemeDescription:function(t){return"["+t+"]"},applyPermissions:function(t){if(t!==this.getEntityTypeName()){return}var e=this.prepareItems();if(e.length===0){return}for(var i=0,n=e.length;i<n;i++){if(this._scheme===e[i]["value"]){return}}this.setScheme(e[0]["value"],{convert:false})},showMenu:function(){if(this._isMenuShown){return}var t=[];var e=this.prepareItems();for(var i=0;i<e.length;i++){var n=e[i];t.push({text:n["text"],value:n["value"],href:"#",className:"crm-convert-item",onclick:this._menuIiemClickHandler})}if(typeof BX.PopupMenu.Data[this._menuId]!=="undefined"){BX.PopupMenu.Data[this._menuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._menuId]}var r=this._button;var s=BX.pos(r);BX.PopupMenu.show(this._menuId,r,t,{autoHide:true,offsetLeft:s["width"]/2,angle:{position:"top",offset:0},events:{onPopupClose:this._menuCloseHandler}});this._isMenuShown=true},closeMenu:function(){if(!this._isMenuShown){return}BX.PopupMenu.destroy(this._menuId);this._isMenuShown=false},prepareItems:function(){return[]},prepareConfig:function(){},processContainerClick:function(){this.convert()},processMenuItemClick:function(t){this.setScheme(t["value"]);this.closeMenu()},createHint:function(t){if(!t){return}this._hint=BX.PopupWindowManager.create(this._id+"_hint",this._container,{offsetTop:-8,autoHide:true,closeByEsc:false,angle:{position:"bottom",offset:42},events:{onPopupClose:BX.delegate(this.onHintClose,this)},content:BX.create("DIV",{attrs:{className:"crm-conv-selector-popup-contents"},children:[BX.create("SPAN",{attrs:{className:"crm-popup-title"},text:t["title"]}),BX.create("P",{text:t["content"]}),BX.create("P",{children:[BX.create("A",{props:{href:"#"},text:t["disabling"],events:{click:BX.delegate(this.onDisableHint,this)}})]})]})});this._hint.show()},onDisableHint:function(t){if(this._hint){this._hint.close();BX.userOptions.save("crm.interface.toobar","conv_scheme_selector","enable_"+this.getId().toLowerCase()+"_hint","N",false)}return BX.PreventDefault(t)},onHintClose:function(){if(this._hint){this._hint.destroy();this._hint=null}},onButtonClick:function(t){this.showMenu()},onContainerClick:function(t){this.processContainerClick()},onMenuItemClick:function(t,e){this.processMenuItemClick(e);return BX.PreventDefault(t)},onMenuClose:function(){this._isMenuShown=false},convert:function(){}}}if(typeof BX.CrmEntityConversionScheme==="undefined"){BX.CrmEntityConversionScheme=function(){};BX.CrmEntityConversionScheme.mergeConfigs=function(t,e){this.mergeEntityConfigs(BX.CrmEntityType.names.deal,t,e);this.mergeEntityConfigs(BX.CrmEntityType.names.contact,t,e);this.mergeEntityConfigs(BX.CrmEntityType.names.company,t,e);this.mergeEntityConfigs(BX.CrmEntityType.names.invoice,t,e);this.mergeEntityConfigs(BX.CrmEntityType.names.quote,t,e)};BX.CrmEntityConversionScheme.mergeEntityConfigs=function(t,e,i){var n=t.toLowerCase();if(typeof e[n]==="undefined"){return}if(typeof i[n]==="undefined"){i[n]={}}if(BX.type.isNotEmptyString(e[n]["active"])){i[n]["active"]=e[n]["active"]}if(BX.type.isNotEmptyString(e[n]["enableSync"])){i[n]["enableSync"]=e[n]["enableSync"]}if(BX.type.isPlainObject(e[n]["initData"])){i[n]["initData"]=e[n]["initData"]}};BX.CrmEntityConversionScheme.removeEntityConfigs=function(t,e){var i=t.toLowerCase();if(typeof e[i]!=="undefined"){delete e[i]}}}if(typeof BX.CrmLeadConversionScheme==="undefined"){BX.CrmLeadConversionScheme={undefined:"",dealcontactcompany:"DEAL_CONTACT_COMPANY",dealcontact:"DEAL_CONTACT",dealcompany:"DEAL_COMPANY",deal:"DEAL",contactcompany:"CONTACT_COMPANY",contact:"CONTACT",company:"COMPANY",getListItems:function(t){var e=[];for(var i=0;i<t.length;i++){var n=t[i];e.push({value:n,text:this.getDescription(n)})}return e},getDescription:function(t){var e=this.messages;return e.hasOwnProperty(t)?e[t]:t},fromConfig:function(t){var e=this.undefined;var i=this.isEntityActive(t,"deal");var n=this.isEntityActive(t,"contact");var r=this.isEntityActive(t,"company");if(i){if(n&&r){e=this.dealcontactcompany}else if(n){e=this.dealcontact}else if(r){e=this.dealcompany}else{e=this.deal}}else if(n&&r){e=this.contactcompany}else if(n){e=this.contact}else if(r){e=this.company}return e},toConfig:function(t,e){this.markEntityAsActive(e,BX.CrmEntityType.names.deal,t===this.dealcontactcompany||t===this.dealcontact||t===this.dealcompany||t===this.deal);this.markEntityAsActive(e,BX.CrmEntityType.names.contact,t===this.dealcontactcompany||t===this.dealcontact||t===this.contactcompany||t===this.contact);this.markEntityAsActive(e,BX.CrmEntityType.names.company,t===this.dealcontactcompany||t===this.dealcompany||t===this.contactcompany||t===this.company)},createConfig:function(t){var e={};this.toConfig(t,e);return e},isEntityActive:function(t,e){var i=e.toLowerCase();var n=typeof t[i]!=="undefined"?t[i]:{};return BX.type.isNotEmptyString(n["active"])&&n["active"]==="Y"},markEntityAsActive:function(t,e,i){var n=e.toLowerCase();if(typeof t[n]==="undefined"){t[n]={}}t[n]["active"]=i?"Y":"N"},mergeConfigs:function(t,e){BX.CrmEntityConversionScheme.mergeEntityConfigs(BX.CrmEntityType.names.deal,t,e);BX.CrmEntityConversionScheme.mergeEntityConfigs(BX.CrmEntityType.names.contact,t,e);BX.CrmEntityConversionScheme.mergeEntityConfigs(BX.CrmEntityType.names.company,t,e);BX.CrmEntityConversionScheme.removeEntityConfigs(BX.CrmEntityType.names.invoice,e);BX.CrmEntityConversionScheme.removeEntityConfigs(BX.CrmEntityType.names.quote,e)}};if(typeof BX.CrmLeadConversionScheme.messages==="undefined"){BX.CrmLeadConversionScheme.messages={}}}if(typeof BX.CrmDealConversionScheme==="undefined"){BX.CrmDealConversionScheme={undefined:"",invoice:"INVOICE",quote:"QUOTE",getListItems:function(t){var e=[];for(var i=0;i<t.length;i++){var n=t[i];e.push({value:n,text:this.getDescription(n)})}return e},getDescription:function(t){var e=this.messages;return e.hasOwnProperty(t)?e[t]:t},fromConfig:function(t){var e=this.undefined;if(this.isEntityActive(t,"invoice")){e=this.invoice}else if(this.isEntityActive(t,"quote")){e=this.quote}return e},toConfig:function(t,e){this.markEntityAsActive(e,"invoice",t===this.invoice);this.markEntityAsActive(e,"quote",t===this.quote)},createConfig:function(t){var e={};this.toConfig(t,e);return e},isEntityActive:function(t,e){var i=typeof t[e]!=="undefined"?t[e]:{};return BX.type.isNotEmptyString(i["active"])&&i["active"]==="Y"},markEntityAsActive:function(t,e,i){if(typeof t[e]==="undefined"){t[e]={}}t[e]["active"]=i?"Y":"N"},mergeConfigs:function(t,e){BX.CrmEntityConversionScheme.mergeEntityConfigs(BX.CrmEntityType.names.invoice,t,e);BX.CrmEntityConversionScheme.mergeEntityConfigs(BX.CrmEntityType.names.quote,t,e);BX.CrmEntityConversionScheme.removeEntityConfigs(BX.CrmEntityType.names.deal,e);BX.CrmEntityConversionScheme.removeEntityConfigs(BX.CrmEntityType.names.contact,e);BX.CrmEntityConversionScheme.removeEntityConfigs(BX.CrmEntityType.names.company,e)}};if(typeof BX.CrmDealConversionScheme.messages==="undefined"){BX.CrmDealConversionScheme.messages={}}}if(typeof BX.CrmQuoteConversionScheme==="undefined"){BX.CrmQuoteConversionScheme={undefined:"",deal:"DEAL",invoice:"INVOICE",getListItems:function(t){var e=[];for(var i=0;i<t.length;i++){var n=t[i];e.push({value:n,text:this.getDescription(n)})}return e},getDescription:function(t){var e=this.messages;return e.hasOwnProperty(t)?e[t]:t},fromConfig:function(t){var e=this.undefined;if(this.isEntityActive(t,"deal")){e=this.deal}else if(this.isEntityActive(t,"invoice")){e=this.invoice}return e},toConfig:function(t,e){this.markEntityAsActive(e,"deal",t===this.deal);this.markEntityAsActive(e,"invoice",t===this.invoice)},createConfig:function(t){var e={};this.toConfig(t,e);return e},isEntityActive:function(t,e){var i=typeof t[e]!=="undefined"?t[e]:{};return BX.type.isNotEmptyString(i["active"])&&i["active"]==="Y"},markEntityAsActive:function(t,e,i){if(typeof t[e]==="undefined"){t[e]={}}t[e]["active"]=i?"Y":"N"},mergeConfigs:function(t,e){BX.CrmEntityConversionScheme.mergeEntityConfigs(BX.CrmEntityType.names.deal,t,e);BX.CrmEntityConversionScheme.mergeEntityConfigs(BX.CrmEntityType.names.invoice,t,e);BX.CrmEntityConversionScheme.removeEntityConfigs(BX.CrmEntityType.names.quote,e);BX.CrmEntityConversionScheme.removeEntityConfigs(BX.CrmEntityType.names.contact,e);BX.CrmEntityConversionScheme.removeEntityConfigs(BX.CrmEntityType.names.company,e)}};if(typeof BX.CrmQuoteConversionScheme.messages==="undefined"){BX.CrmQuoteConversionScheme.messages={}}}if(typeof BX.CrmOrderConversionScheme==="undefined"){BX.CrmOrderConversionScheme={undefined:"",deal:"DEAL",invoice:"INVOICE",getListItems:function(t){var e=[];for(var i=0;i<t.length;i++){var n=t[i];e.push({value:n,text:this.getDescription(n)})}return e},getDescription:function(t){var e=this.messages;return e.hasOwnProperty(t)?e[t]:t},fromConfig:function(t){var e=this.undefined;if(this.isEntityActive(t,"deal")){e=this.deal}else if(this.isEntityActive(t,"invoice")){e=this.invoice}return e},toConfig:function(t,e){this.markEntityAsActive(e,"deal",t===this.deal);this.markEntityAsActive(e,"invoice",t===this.invoice)},createConfig:function(t){var e={};this.toConfig(t,e);return e},isEntityActive:function(t,e){var i=typeof t[e]!=="undefined"?t[e]:{};return BX.type.isNotEmptyString(i["active"])&&i["active"]==="Y"},markEntityAsActive:function(t,e,i){if(typeof t[e]==="undefined"){t[e]={}}t[e]["active"]=i?"Y":"N"},mergeConfigs:function(t,e){BX.CrmEntityConversionScheme.mergeEntityConfigs(BX.CrmEntityType.names.deal,t,e);BX.CrmEntityConversionScheme.mergeEntityConfigs(BX.CrmEntityType.names.invoice,t,e);BX.CrmEntityConversionScheme.removeEntityConfigs(BX.CrmEntityType.names.quote,e);BX.CrmEntityConversionScheme.removeEntityConfigs(BX.CrmEntityType.names.contact,e);BX.CrmEntityConversionScheme.removeEntityConfigs(BX.CrmEntityType.names.company,e)}};if(typeof BX.CrmOrderConversionScheme.messages==="undefined"){BX.CrmOrderConversionScheme.messages={}}}if(typeof BX.CrmEntityConverterMode==="undefined"){BX.CrmEntityConverterMode={intermediate:0,schemeSetup:1,syncSetup:2,request:3}}if(typeof BX.CrmEntityConverter==="undefined"){BX.CrmEntityConverter=function(){this._id="";this._settings={};this._config={};this._contextData=null;this._mode=BX.CrmEntityConverterMode.intermediate;this._entityId=0;this._originUrl="";this._syncEditor=null;this._syncEditorClosingListener=BX.delegate(this.onSyncEditorClose,this);this._enableSync=false;this._enablePageRefresh=true;this._enableRedirectToShowPage=true;this._requestIsRunning=false;this._dealCategorySelectDialog=null;this._entityEditorDialog=null;this._dealCategorySelectListener=BX.delegate(this.onDealCategorySelect,this);this._entityEditorDialogListener=BX.delegate(this.onEntityEditorDialogClose,this)};BX.CrmEntityConverter.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._config=this.getSetting("config",{});this._serviceUrl=this.getSetting("serviceUrl","");this._enablePageRefresh=this.getSetting("enablePageRefresh",true);this._enableRedirectToShowPage=this.getSetting("enableRedirectToShowPage",true);this._enableSlider=this.getSetting("enableSlider",false)},getSetting:function(t,e){return typeof this._settings[t]!=="undefined"?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},getId:function(){return this._id},getMessage:function(t){return t},getEntityTypeId:function(){return BX.CrmEntityType.enumeration.undefined},getEntityId:function(){return this._entityId},getConfig:function(){return this._config},getProgressManager:function(){return null},setupSynchronization:function(t){this._mode=BX.CrmEntityConverterMode.syncSetup;if(this._syncEditor){this._syncEditor.setConfig(this._config);this._syncEditor.setFieldNames(t)}else{this._syncEditor=BX.CrmEntityFieldSynchronizationEditor.create(this._id+"_config",{converter:this,config:this._config,title:this.getMessage("dialogTitle"),fieldNames:t,legend:this.getMessage("syncEditorLegend"),fieldListTitle:this.getMessage("syncEditorFieldListTitle"),entityListTitle:this.getMessage("syncEditorEntityListTitle"),continueButton:this.getMessage("continueButton"),cancelButton:this.getMessage("cancelButton")});this._syncEditor.addClosingListener(this._syncEditorClosingListener)}this._syncEditor.show()},createSynchronizationEditor:function(t,e,i){return BX.CrmEntityFieldSynchronizationEditor.create(t,{converter:this,config:e,title:this.getMessage("dialogTitle"),fieldNames:i,legend:this.getMessage("syncEditorLegend"),fieldListTitle:this.getMessage("syncEditorFieldListTitle"),entityListTitle:this.getMessage("syncEditorEntityListTitle"),continueButton:this.getMessage("continueButton"),cancelButton:this.getMessage("cancelButton")})},convert:function(t,e,i,n){if(!BX.type.isPlainObject(e)){return}this._entityId=t;this._contextData=BX.type.isPlainObject(n)?n:null;this._originUrl=i;this.registerConfig(e);if(!BX.CrmLeadConversionScheme.isEntityActive(this._config,BX.CrmEntityType.names.deal)){this.startRequest()}else{var r=BX.CrmDealCategory.infos.length;if(r<2){if(r>0){if(!BX.type.isPlainObject(this._config["deal"]["initData"])){this._config["deal"]["initData"]={}}this._config["deal"]["initData"]["categoryId"]=BX.prop.getInteger(BX.CrmDealCategory.infos[0],"id",0)}this.startRequest()}else{var s=BX.type.isPlainObject(this._config["deal"]["initData"])?this._config["deal"]["initData"]["categoryId"]:0;if(!this._dealCategorySelectDialog){this._dealCategorySelectDialog=BX.CrmDealCategorySelectDialog.create(this._id,{value:s});this._dealCategorySelectDialog.addCloseListener(this._dealCategorySelectListener)}this._dealCategorySelectDialog.open()}}},registerConfig:function(t){BX.CrmEntityConversionScheme.mergeConfigs(t,this._config)},onDealCategorySelect:function(t,e){if(!(BX.type.isBoolean(e["isCanceled"])&&e["isCanceled"]===false)){return}if(!BX.type.isPlainObject(this._config["deal"]["initData"])){this._config["deal"]["initData"]={}}this._config["deal"]["initData"]["categoryId"]=t.getValue();this.startRequest()},onSyncEditorClose:function(t,e){this._mode=BX.CrmEntityConverterMode.intermediate;if(!(BX.type.isBoolean(e["isCanceled"])&&e["isCanceled"]===false)){return}this._enableSync=true;this._config=this._syncEditor.getConfig();this.startRequest()},singRequestUrl:function(t){var e={action:"convert"};for(var i in this._config){if(this._config.hasOwnProperty(i)){e[i]=BX.prop.getString(this._config[i],"active","N")}}return BX.util.add_url_param(t,e)},startRequest:function(){if(this._requestIsRunning){return}this._requestIsRunning=true;BX.ajax({url:this.singRequestUrl(this._serviceUrl),method:"POST",dataType:"json",data:{MODE:"CONVERT",ENTITY_ID:this._entityId,ENABLE_SYNCHRONIZATION:this._enableSync?"Y":"N",ENABLE_REDIRECT_TO_SHOW:this._enableRedirectToShowPage?"Y":"N",ENABLE_SLIDER:this._enableSlider?"Y":"N",CONFIG:this._config,CONTEXT:this._contextData,ORIGIN_URL:this._originUrl},onsuccess:BX.delegate(this.onRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)});this._mode=BX.CrmEntityConverterMode.request},onRequestSuccess:function(t){this._requestIsRunning=false;this._mode=BX.CrmEntityConverterMode.intermediate;if(BX.type.isPlainObject(t["ERROR"])){this.showError(t["ERROR"]);return}var e;if(BX.type.isPlainObject(t["REQUIRED_ACTION"])){var i=t["REQUIRED_ACTION"];var n=BX.type.isNotEmptyString(i["NAME"])?i["NAME"]:"";e=BX.type.isPlainObject(i["DATA"])?i["DATA"]:{};if(n==="SYNCHRONIZE"){if(BX.type.isPlainObject(e["CONFIG"])){this._config=e["CONFIG"]}this.setupSynchronization(BX.type.isArray(e["FIELD_NAMES"])?e["FIELD_NAMES"]:[])}if(n==="CORRECT"){var r=BX.prop.getObject(e,"CHECK_ERRORS",null);if(r){var s=this.getProgressManager();this.openEntityEditorDialog({title:s?s.getMessage("checkErrorTitle"):null,helpData:{text:s.getMessage("checkErrorHelp"),code:s.getMessage("checkErrorHelpArticleCode")},fieldNames:Object.keys(r),initData:BX.prop.getObject(e,"EDITOR_INIT_DATA",null),context:BX.prop.getObject(e,"CONTEXT",null)});return}}return}e=BX.prop.getObject(t,"DATA",null);if(!e){return}var o=BX.prop.getString(e,"URL","");var a=false;if(BX.prop.getString(e,"IS_FINISHED","")==="Y"){this._contextData=null;var l=this.getEntityTypeId();var u={entityTypeId:l,entityTypeName:BX.CrmEntityType.resolveName(l),entityId:this._entityId,redirectUrl:o,isRedirected:false};var h=BX.Crm.Page.getTopSlider();if(h){u["sliderUrl"]=h.getUrl()}BX.onCustomEvent(window,"Crm.EntityConverter.Converted",[this,u]);BX.localStorage.set("onCrmEntityConvert",u,10);a=u["isRedirected"]}if(o!==""&&!a){window.setTimeout((function(){BX.Crm.Page.open(o)}),0)}else if(this._enablePageRefresh&&!(a&&window.top===window)){window.setTimeout((function(){window.location.reload()}),0)}},onRequestFailure:function(t){BX.closeWait();this._requestIsRunning=false;this._mode=BX.CrmEntityConverterMode.intermediate},openEntityEditorDialog:function(t){BX.Crm.PartialEditorDialog.close("entity-converter-editor");this._entityEditorDialog=BX.Crm.PartialEditorDialog.create("entity-converter-editor",{title:BX.prop.getString(t,"title","Please fill in all required fields"),entityTypeId:this.getEntityTypeId(),entityId:this.getEntityId(),fieldNames:BX.prop.getArray(t,"fieldNames",[]),helpData:BX.prop.getObject(t,"helpData",null),context:BX.prop.getObject(t,"context",null)});window.setTimeout(function(){this._entityEditorDialog.open();BX.addCustomEvent(window,"Crm.PartialEditorDialog.Close",this._entityEditorDialogListener)}.bind(this),150)},onEntityEditorDialogClose:function(t,e){if(!(this.getEntityTypeId()===BX.prop.getInteger(e,"entityTypeId",0)&&this.getEntityId()===BX.prop.getInteger(e,"entityId",0))){return}this._entityEditorDialog=null;BX.removeCustomEvent(window,"Crm.PartialEditorDialog.Close",this._entityEditorDialogListener);if(!BX.prop.getBoolean(e,"isCancelled",true)){this.startRequest()}},showError:function(t){if(BX.type.isPlainObject(t)){alert(BX.type.isNotEmptyString(t["MESSAGE"])?t["MESSAGE"]:this.getMessage("generalError"))}}};BX.CrmEntityConverter.create=function(t,e){var i=new BX.CrmEntityConverter;i.initialize(t,e);return i}}if(typeof BX.CrmLeadConverter==="undefined"){BX.CrmLeadConverter=function(){BX.CrmLeadConverter.superclass.constructor.apply(this);this._entitySelectorId="lead_converter";this._entitySelectHandler=BX.delegate(this.onEntitySelect,this);this._entitySelectCallback=null};BX.extend(BX.CrmLeadConverter,BX.CrmEntityConverter);BX.CrmLeadConverter.prototype.getProgressManager=function(){return BX.CrmLeadStatusManager.current};BX.CrmLeadConverter.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.lead};BX.CrmLeadConverter.prototype.registerConfig=function(t){BX.CrmLeadConversionScheme.mergeConfigs(t,this._config)};BX.CrmLeadConverter.prototype.getMessage=function(t){var e=BX.CrmLeadConverter.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.CrmLeadConverter.messages==="undefined"){BX.CrmLeadConverter.messages={}}BX.CrmLeadConverter.prototype.openEntitySelector=function(t){this._entitySelectCallback=BX.type.isFunction(t)?t:null;var e=this._entitySelectorId;if(typeof obCrm[e]==="undefined"){obCrm[e]=new CRM(e,null,null,e,[],false,true,["contact","company"],{contact:this.getMessage("contact"),company:this.getMessage("company"),ok:this.getMessage("selectButton"),cancel:BX.message("JS_CORE_WINDOW_CANCEL"),close:BX.message("JS_CORE_WINDOW_CLOSE"),wait:BX.message("JS_CORE_LOADING"),noresult:this.getMessage("noresult"),search:this.getMessage("search"),last:this.getMessage("last")},true);obCrm[e].Init();obCrm[e].AddOnSaveListener(this._entitySelectHandler)}obCrm[e].Open({closeIcon:{top:"10px",right:"15px"},closeByEsc:true,titleBar:this.getMessage("entitySelectorTitle")})};BX.CrmLeadConverter.prototype.onEntitySelect=function(t){var e=this._entitySelectorId;obCrm[e].RemoveOnSaveListener(this._entitySelectHandler);obCrm[e].Clear();delete obCrm[e];if(!this._entitySelectCallback){return}var i;var n=null;for(i in t){if(t.hasOwnProperty(i)&&BX.type.isPlainObject(t[i])&&BX.type.isPlainObject(t[i][0])){var r=t[i][0];var s=typeof r["id"]?parseInt(r["id"]):0;if(s>0){if(n===null){n={}}n[i]=s}}}if(n===null){this._entitySelectCallback({config:null,data:null})}else{var o={deal:{active:"N"},contact:{active:"N"},company:{active:"N"}};for(i in n){if(n.hasOwnProperty(i)&&typeof o[i]!=="undefined"){o[i]["active"]="Y"}}this._entitySelectCallback({config:o,data:n})}};BX.CrmLeadConverter.create=function(t,e){var i=new BX.CrmLeadConverter;i.initialize(t,e);return i};BX.CrmLeadConverter.current=null;if(typeof(BX.CrmLeadConverter.settings==="undefined")){BX.CrmLeadConverter.settings={}}if(typeof(BX.CrmLeadConverter.permissions==="undefined")){BX.CrmLeadConverter.permissions={contact:false,company:false,deal:false}}BX.CrmLeadConverter.getCurrent=function(){if(!this.current){this.current=BX.CrmLeadConverter.create("current",this.settings)}return this.current}}if(typeof BX.CrmDealConverter==="undefined"){BX.CrmDealConverter=function(){BX.CrmDealConverter.superclass.constructor.apply(this)};BX.extend(BX.CrmDealConverter,BX.CrmEntityConverter);BX.CrmDealConverter.prototype.getProgressManager=function(){return BX.CrmDealStageManager.current};BX.CrmDealConverter.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.deal};BX.CrmDealConverter.prototype.registerConfig=function(t){BX.CrmDealConversionScheme.mergeConfigs(t,this._config)};BX.CrmDealConverter.prototype.getMessage=function(t){var e=BX.CrmDealConverter.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.CrmDealConverter.messages==="undefined"){BX.CrmDealConverter.messages={}}BX.CrmDealConverter.create=function(t,e){var i=new BX.CrmDealConverter;i.initialize(t,e);return i};BX.CrmDealConverter.current=null;if(typeof(BX.CrmDealConverter.settings==="undefined")){BX.CrmDealConverter.settings={}}if(typeof(BX.CrmDealConverter.permissions==="undefined")){BX.CrmDealConverter.permissions={invoice:false,quote:false}}BX.CrmDealConverter.getCurrent=function(){if(!this.current){this.current=BX.CrmDealConverter.create("current",this.settings)}return this.current}}if(typeof BX.CrmQuoteConverter==="undefined"){BX.CrmQuoteConverter=function(){BX.CrmQuoteConverter.superclass.constructor.apply(this)};BX.extend(BX.CrmQuoteConverter,BX.CrmEntityConverter);BX.CrmQuoteConverter.prototype.getProgressManager=function(){return BX.CrmQuoteStatusManager.current};BX.CrmQuoteConverter.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.quote};BX.CrmQuoteConverter.prototype.registerConfig=function(t){BX.CrmQuoteConversionScheme.mergeConfigs(t,this._config)};BX.CrmQuoteConverter.prototype.getMessage=function(t){var e=BX.CrmQuoteConverter.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.CrmQuoteConverter.messages==="undefined"){BX.CrmQuoteConverter.messages={}}BX.CrmQuoteConverter.create=function(t,e){var i=new BX.CrmQuoteConverter;i.initialize(t,e);return i};BX.CrmQuoteConverter.current=null;if(typeof(BX.CrmQuoteConverter.settings==="undefined")){BX.CrmQuoteConverter.settings={}}if(typeof(BX.CrmQuoteConverter.permissions==="undefined")){BX.CrmQuoteConverter.permissions={invoice:false,quote:false}}BX.CrmQuoteConverter.getCurrent=function(){if(!this.current){this.current=BX.CrmQuoteConverter.create("current",this.settings)}return this.current}}if(typeof BX.CrmOrderConverter==="undefined"){BX.CrmOrderConverter=function(){BX.CrmOrderConverter.superclass.constructor.apply(this)};BX.extend(BX.CrmOrderConverter,BX.CrmEntityConverter);BX.CrmOrderConverter.prototype.getProgressManager=function(){return BX.CrmOrderStatusManager.current};BX.CrmOrderConverter.prototype.getEntityTypeId=function(){return BX.CrmEntityType.enumeration.order};BX.CrmOrderConverter.prototype.registerConfig=function(t){BX.CrmOrderConversionScheme.mergeConfigs(t,this._config)};BX.CrmOrderConverter.prototype.getMessage=function(t){var e=BX.CrmOrderConverter.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.CrmOrderConverter.messages==="undefined"){BX.CrmOrderConverter.messages={}}BX.CrmOrderConverter.create=function(t,e){var i=new BX.CrmOrderConverter;i.initialize(t,e);return i};BX.CrmOrderConverter.current=null;if(typeof(BX.CrmOrderConverter.settings==="undefined")){BX.CrmOrderConverter.settings={}}if(typeof(BX.CrmOrderConverter.permissions==="undefined")){BX.CrmOrderConverter.permissions={invoice:false,quote:false}}BX.CrmOrderConverter.getCurrent=function(){if(!this.current){this.current=BX.CrmOrderConverter.create("current",this.settings)}return this.current}}if(typeof BX.CrmEntityFieldSynchronizationEditor==="undefined"){BX.CrmEntityFieldSynchronizationEditor=function(){this._id="";this._settings={};this._converter=null;this._config={};this._fieldNames=[];this._closingNotifier=null;this._contentWrapper=null;this._fieldWrapper=null;this._foldButton=null;this._foldButtonClickHandler=BX.delegate(this.onFoldButtonClick,this);this._checkBoxes={};this._resizer=null;this._popup=null};BX.CrmEntityFieldSynchronizationEditor.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._converter=this.getSetting("converter");this._config=this.getSetting("config",{});this._fieldNames=this.getSetting("fieldNames",[]);this._closingNotifier=BX.CrmNotifier.create(this)},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},getId:function(){return this._id},getConfig:function(){return this._config},setConfig:function(t){this._config=t},getFieldNames:function(){return this._fieldNames},setFieldNames:function(t){this._fieldNames=t},show:function(){if(this.isShown()){return}var t=this.getId();if(BX.CrmEntityFieldSynchronizationEditor.windows[t]){BX.CrmEntityFieldSynchronizationEditor.windows[t].destroy();delete BX.CrmEntityFieldSynchronizationEditor.windows[t]}var e=this.getSetting("anchor",null);this._popup=new BX.PopupWindow(t,e,{autoHide:false,draggable:true,zIndex:100,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{marginRight:"-2px",marginTop:"3px"},events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},titleBar:this.getSetting("title"),content:this.prepareContent(),buttons:this.prepareButtons(),lightShadow:true,className:"crm-tip-popup"});BX.CrmEntityFieldSynchronizationEditor.windows[t]=this._popup;this._popup.show()},close:function(){if(!(this._popup&&this._popup.isShown())){return}this._popup.close()},isShown:function(){return this._popup&&this._popup.isShown()},addClosingListener:function(t){this._closingNotifier.addListener(t)},removeClosingListener:function(t){this._closingNotifier.removeListener(t)},getMessage:function(t){var e=BX.CrmEntityFieldSynchronizationEditor.messages;return e.hasOwnProperty(t)?e.messages[t]:t},prepareButtons:function(){return[new BX.PopupWindowButton({text:this.getSetting("continueButton"),className:"popup-window-button-accept",events:{click:BX.delegate(this.onContinueBtnClick,this)}}),new BX.PopupWindowButtonLink({text:this.getSetting("cancelButton"),className:"popup-window-button-link-cancel",events:{click:BX.delegate(this.onCancelBtnClick,this)}})]},prepareContent:function(){this._contentWrapper=BX.create("DIV",{attrs:{className:"crm-popup-setting-fields"}});var t=BX.create("UL",{attrs:{className:"crm-p-s-f-items-list"}});for(var e=0;e<this._fieldNames.length;e++){t.appendChild(BX.create("LI",{attrs:{className:"crm-p-s-f-item"},text:this._fieldNames[e]}))}var i=this._fieldWrapper=BX.create("DIV",{attrs:{className:"crm-p-s-f-block-wrap crm-p-s-f-block-hide"}});this._contentWrapper.appendChild(i);var n=BX.create("DIV",{attrs:{className:"crm-p-s-f-top-block"},children:[BX.create("DIV",{attrs:{className:"crm-p-s-f-title"},text:this.getSetting("fieldListTitle")+":"}),t]});var r=this._foldButton=BX.create("DIV",{attrs:{className:"crm-p-s-f-open-btn"}});if(t.children.length>6){BX.bind(r,"click",this._foldButtonClickHandler)}else{i.classList.toggle("crm-p-s-f-block-open")}var s=BX.create("DIV",{attrs:{className:"crm-p-s-f-block-hide-inner"},children:[BX.create("DIV",{attrs:{className:"crm-p-s-f-text"},text:this.getSetting("legend")}),n,r]});i.appendChild(s);this._resizer=BX.AnimatedResize.create(s,i);var o=BX.create("DIV",{attrs:{className:"crm-p-s-f-block-wrap"}});this._contentWrapper.appendChild(o);o.appendChild(BX.create("DIV",{attrs:{className:"crm-p-s-f-title"},text:this.getSetting("entityListTitle")+":"}));var a=this.getId();this._checkBoxes={};var l=BX.create("UL",{attrs:{className:"crm-p-s-f-checkbox-items-list"}});for(var u in this._config){if(!this._config.hasOwnProperty(u)){continue}var h=this._config[u];var c=BX.type.isNotEmptyString(h["enableSync"])&&h["enableSync"]==="Y";if(!c){continue}var p=a+"_"+u;var m=BX.create("INPUT",{props:{id:p,type:"checkbox",checked:true}});this._checkBoxes[u]=m;var d=h.title||BX.CrmEntityType.getCaptionByName(u);var f=BX.create("LABEL",{props:{htmlFor:p},text:d});l.appendChild(BX.create("LI",{attrs:{className:"crm-p-s-f-checkbox-item"},children:[m,f]}))}o.appendChild(l);return this._contentWrapper},saveConfig:function(){for(var t in this._checkBoxes){if(this._checkBoxes.hasOwnProperty(t)&&this._config.hasOwnProperty(t)){this._config[t]["enableSync"]=this._checkBoxes[t].checked?"Y":"N"}}},onFoldButtonClick:function(){this._fieldWrapper.classList.toggle("crm-p-s-f-block-open");this._resizer.run()},onContinueBtnClick:function(){this.saveConfig();this._closingNotifier.notify([{isCanceled:false}]);this.close()},onCancelBtnClick:function(){this._closingNotifier.notify([{isCanceled:true}]);this.close()},onPopupShow:function(){},onPopupClose:function(){if(this._popup){this._contentWrapper=null;this._popup.destroy()}},onPopupDestroy:function(){if(!this._popup){return}this._fieldWrapper=null;this._foldButton=null;this._contentWrapper=null;this._checkBoxes={};this._resizer=null;this._popup=null;delete BX.CrmEntityFieldSynchronizationEditor.windows[this.getId()]}};BX.CrmEntityFieldSynchronizationEditor.windows={};if(typeof BX.CrmEntityFieldSynchronizationEditor.messages=="undefined"){BX.CrmEntityFieldSynchronizationEditor.messages={}}BX.CrmEntityFieldSynchronizationEditor.create=function(t,e){var i=new BX.CrmEntityFieldSynchronizationEditor;i.initialize(t,e);return i}}if(typeof BX.AnimatedResize==="undefined"){BX.AnimatedResize=function(){this._innerBlock=null;this._mainBlock=null;this._isOpen=false};BX.AnimatedResize.prototype={initialize:function(t,e){this._innerBlock=t;this._mainBlock=e},run:function(){this._isOpen=this._mainBlock.offsetHeight==this._innerBlock.offsetHeight;this.ease(this._isOpen?{start:this._innerBlock.offsetHeight,finish:0}:{start:this._mainBlock.offsetHeight,finish:this._innerBlock.offsetHeight});this._isOpen=!this._isOpen},step:function(t){this._mainBlock.style.height=t.height+"px"},complete:function(){if(this._isOpen){this._mainBlock.style.height="auto"}},ease:function(t){new BX.easing({duration:300,start:{height:t["start"]},finish:{height:t["finish"]},transition:BX.easing.makeEaseOut(BX.easing.transitions.circ),step:BX.delegate(this.step,this),complete:BX.delegate(this.complete,this)}).animate()}};BX.AnimatedResize.create=function(t,e){var i=new BX.AnimatedResize;i.initialize(t,e);return i}}if(typeof BX.CrmLeadConversionType==="undefined"){BX.CrmLeadConversionType={undefined:0,general:1,returningCustomer:2,supplement:3,configs:{},getConfig:function(t){return BX.prop.getObject(this.configs,t,null)}}}if(typeof BX.CrmLeadConversionSchemeSelector==="undefined"){BX.CrmLeadConversionSchemeSelector=function(){BX.CrmLeadConversionSchemeSelector.superclass.constructor.apply(this);this._converter=null};BX.extend(BX.CrmLeadConversionSchemeSelector,BX.CrmConversionSchemeSelector);BX.CrmLeadConversionSchemeSelector.prototype.getEntityTypeName=function(){return BX.CrmEntityType.names.lead};BX.CrmLeadConversionSchemeSelector.prototype.getConverter=function(){if(!this._converter){var t=BX.prop.getInteger(this._settings,"typeId",BX.CrmLeadConversionType.general);var e=BX.CrmLeadConversionType.getConfig(t);if(!e){e=BX.prop.getObject(BX.CrmLeadConverter.settings,"config",null)}var i=BX.prop.getString(BX.CrmLeadConverter.settings,"serviceUrl");this._converter=BX.CrmLeadConverter.create(this._id,{serviceUrl:i,config:e})}return this._converter};BX.CrmLeadConversionSchemeSelector.prototype.prepareItems=function(){var t=BX.CrmLeadConverter.permissions["deal"];var e=BX.CrmLeadConverter.permissions["contact"];var i=BX.CrmLeadConverter.permissions["company"];var n=t;var r=e;var s=i;var o=BX.prop.getInteger(this._settings,"typeId",BX.CrmLeadConversionType.undefined);if(o===BX.CrmLeadConversionType.returningCustomer||o===BX.CrmLeadConversionType.supplement){r=s=false}var a=[];if(n){if(r&&s){a.push(BX.CrmLeadConversionScheme.dealcontactcompany)}if(r){a.push(BX.CrmLeadConversionScheme.dealcontact)}if(s){a.push(BX.CrmLeadConversionScheme.dealcompany)}a.push(BX.CrmLeadConversionScheme.deal)}if(r&&s){a.push(BX.CrmLeadConversionScheme.contactcompany)}if(r){a.push(BX.CrmLeadConversionScheme.contact)}if(s){a.push(BX.CrmLeadConversionScheme.company)}var l=BX.CrmLeadConversionScheme.getListItems(a);if(o!==BX.CrmLeadConversionType.returningCustomer&&(e||i)){l.push({value:"CUSTOM",text:this.getConverter().getMessage("openEntitySelector")})}return l};BX.CrmLeadConversionSchemeSelector.prototype.prepareConfig=function(){return BX.CrmLeadConversionScheme.createConfig(this._scheme)};BX.CrmLeadConversionSchemeSelector.prototype.getSchemeDescription=function(t){return BX.CrmLeadConversionScheme.getDescription(t)};BX.CrmLeadConversionSchemeSelector.prototype.processMenuItemClick=function(t){var e=t["value"];if(e==="CUSTOM"){this.getConverter().openEntitySelector(BX.delegate(this.onEntitySelect,this))}else{this.setScheme(e)}this.closeMenu()};BX.CrmLeadConversionSchemeSelector.prototype.onEntitySelect=function(t){if(!BX.type.isPlainObject(t)){return}this.getConverter().convert(this._entityId,t["config"],this.getSetting("originUrl"),t["data"])};BX.CrmLeadConversionSchemeSelector.prototype.convert=function(){this.getConverter().convert(this._entityId,this.prepareConfig(),this.getSetting("originUrl"))};BX.CrmLeadConversionSchemeSelector.create=function(t,e){var i=new BX.CrmLeadConversionSchemeSelector;i.initialize(t,e);return i}}if(typeof BX.CrmDealConversionSchemeSelector==="undefined"){BX.CrmDealConversionSchemeSelector=function(){BX.CrmDealConversionSchemeSelector.superclass.constructor.apply(this)};BX.extend(BX.CrmDealConversionSchemeSelector,BX.CrmConversionSchemeSelector);BX.CrmDealConversionSchemeSelector.prototype.getEntityTypeName=function(){return BX.CrmEntityType.names.deal};BX.CrmDealConversionSchemeSelector.prototype.prepareItems=function(){var t=[];if(BX.CrmDealConverter.permissions["invoice"]){t.push(BX.CrmDealConversionScheme.invoice)}if(BX.CrmDealConverter.permissions["quote"]){t.push(BX.CrmDealConversionScheme.quote)}return BX.CrmDealConversionScheme.getListItems(t)};BX.CrmDealConversionSchemeSelector.prototype.prepareConfig=function(){return BX.CrmDealConversionScheme.createConfig(this._scheme)};BX.CrmDealConversionSchemeSelector.prototype.getSchemeDescription=function(t){return BX.CrmDealConversionScheme.getDescription(t)};BX.CrmDealConversionSchemeSelector.prototype.convert=function(){BX.CrmDealConverter.getCurrent().convert(this._entityId,this.prepareConfig(),this.getSetting("originUrl",""))};BX.CrmDealConversionSchemeSelector.create=function(t,e){var i=new BX.CrmDealConversionSchemeSelector;i.initialize(t,e);return i}}if(typeof BX.CrmQuoteConversionSchemeSelector==="undefined"){BX.CrmQuoteConversionSchemeSelector=function(){BX.CrmQuoteConversionSchemeSelector.superclass.constructor.apply(this)};BX.extend(BX.CrmQuoteConversionSchemeSelector,BX.CrmConversionSchemeSelector);BX.CrmQuoteConversionSchemeSelector.prototype.getEntityTypeName=function(){return BX.CrmEntityType.names.quote};BX.CrmQuoteConversionSchemeSelector.prototype.prepareItems=function(){var t=[];if(BX.CrmQuoteConverter.permissions["deal"]){t.push(BX.CrmQuoteConversionScheme.deal)}if(BX.CrmQuoteConverter.permissions["invoice"]){t.push(BX.CrmQuoteConversionScheme.invoice)}return BX.CrmQuoteConversionScheme.getListItems(t)};BX.CrmQuoteConversionSchemeSelector.prototype.prepareConfig=function(){return BX.CrmQuoteConversionScheme.createConfig(this._scheme)};BX.CrmQuoteConversionSchemeSelector.prototype.getSchemeDescription=function(t){return BX.CrmQuoteConversionScheme.getDescription(t)};BX.CrmQuoteConversionSchemeSelector.prototype.convert=function(){BX.CrmQuoteConverter.getCurrent().convert(this._entityId,this.prepareConfig(),this.getSetting("originUrl",""))};BX.CrmQuoteConversionSchemeSelector.items={};BX.CrmQuoteConversionSchemeSelector.create=function(t,e){var i=new BX.CrmQuoteConversionSchemeSelector;i.initialize(t,e);this.items[i.getId()]=i;return i}}BX.CrmRequisitePresetListLoader=function(){this._id="";this._settings={};this._entityTypeName="";this._serviceUrl="";this._callback=null;this._isRequestRunning=false;this._waiter=null;this._resultData=null};BX.CrmRequisitePresetListLoader.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_rq_prest_loader"+Math.random().toString().substring(2);this._settings=e?e:{};this._entityTypeName=this.getSetting("entityTypeName","");if(!BX.type.isNotEmptyString(this._entityTypeName)){throw"BX.CrmRequisitePresetListLoader. Could not find 'entityTypeName' parameter."}this._entityTypeName=this._entityTypeName.toUpperCase();this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"BX.CrmRequisitePresetListLoader. Could not find 'serviceUrl' parameter."}var i=this.getSetting("callback");if(BX.type.isFunction(i)){this._callback=i}},getId:function(){return this._id},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},getResultData:function(){return this._resultData},start:function(){if(this._isRequestRunning){return false}this._isRequestRunning=true;this._waiter=BX.showWait();BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ENTITY_TYPE_NAME:this._entityTypeName,ACTION:"GET_REQUISITE_PRESETS"},onsuccess:BX.delegate(this.onRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)});return true},onRequestSuccess:function(t){this._isRequestRunning=false;if(this._waiter){BX.closeWait(null,this._waiter);this._waiter=null}var e=BX.type.isPlainObject(t["RESULT"])?t["RESULT"]:{};this._resultData=BX.type.isArray(e["ITEMS"])?e["ITEMS"]:[];if(this._callback){this._callback(this,{isSuccessed:true,resultData:this._resultData})}},onRequestFailure:function(t){this._isRequestRunning=false;if(this._waiter){BX.closeWait(null,this._waiter);this._waiter=null}this._resultData=[];if(this._callback){this._callback(this,{isSuccessed:false,resultData:this._resultData})}}};BX.CrmRequisitePresetListLoader.create=function(t,e){var i=new BX.CrmRequisitePresetListLoader;i.initialize(t,e);return i};BX.CrmRequisitePresetSelectDialog=function(){this._id="";this._settings={};this._popup=null;this._contentWrapper=null;this._list=null;this._selector=null;this._callback=null};BX.CrmRequisitePresetSelectDialog.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._list=this.getSetting("list");if(!BX.type.isArray(this._list)){throw"BX.CrmRequisitePresetSelectDialog. Could not find 'list' parameter."}var i=this.getSetting("callback");if(BX.type.isFunction(i)){this._callback=i}},getId:function(){return this._id},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},getMessage:function(t){var e=BX.CrmRequisitePresetSelectDialog.messages;return e.hasOwnProperty(t)?e[t]:t},show:function(){if(this.isShown()){return}var t=this.getId();if(BX.CrmRequisitePresetSelectDialog.windows[t]){BX.CrmRequisitePresetSelectDialog.windows[t].destroy()}this._popup=new BX.PopupWindow(t,this.getSetting("anchor",null),{autoHide:false,draggable:true,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{top:"10px",right:"15px"},zIndex:0,titleBar:this.getMessage("title"),content:this.prepareContent(),className:"crm-tip-popup",lightShadow:true,buttons:[new BX.PopupWindowButton({text:BX.message("JS_CORE_WINDOW_CONTINUE"),className:"popup-window-button-accept",events:{click:BX.delegate(this.onAcceptButtonClick,this)}}),new BX.PopupWindowButtonLink({text:BX.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:BX.delegate(this.onCancelButtonClick,this)}})],events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}});(BX.CrmRequisitePresetSelectDialog.windows[t]=this._popup).show()},close:function(){if(!(this._popup&&this._popup.isShown())){return}this._popup.close()},isShown:function(){return this._popup&&this._popup.isShown()},getSelectedValue:function(){return this._selector?this._selector.value:""},prepareContent:function(){var t=this._contentWrapper=BX.create("DIV",{attrs:{className:"bx-requisite-dialog"}});var e=BX.create("DIV",{attrs:{className:"container-item"}});t.appendChild(e);var i=this._selector=BX.create("SELECT",{});var n=[];for(var r=0;r<this._list.length;r++){var s=this._list[r];n.push({value:s["ID"],text:s["NAME"]})}BX.HtmlHelper.setupSelectOptions(i,n);e.appendChild(BX.create("DIV",{attrs:{className:"field-container field-container-left"},children:[BX.create("LABEL",{attrs:{className:"field-container-title"},text:this.getMessage("presetField")+":"}),BX.create("SPAN",{attrs:{className:"select-container"},children:[i]})]}));return this._contentWrapper},onCancelButtonClick:function(){if(this._callback){this._callback(this,{isAccepted:false,selectedValue:this.getSelectedValue()})}},onAcceptButtonClick:function(){if(this._callback){this._callback(this,{isAccepted:true,selectedValue:this.getSelectedValue()})}},onPopupShow:function(){},onPopupClose:function(){if(this._popup){this._popup.destroy()}if(this._callback){this._callback(this,{isAccepted:false,selectedValue:this.getSelectedValue()})}},onPopupDestroy:function(){if(this._popup){this._popup=null}}};if(typeof BX.CrmRequisitePresetSelectDialog.messages==="undefined"){BX.CrmRequisitePresetSelectDialog.messages={}}BX.CrmRequisitePresetSelectDialog.windows={};BX.CrmRequisitePresetSelectDialog.create=function(t,e){var i=new BX.CrmRequisitePresetSelectDialog;i.initialize(t,e);return i};BX.CrmRequisiteConverter=function(){this._id="";this._settings={};this._entityTypeName="";this._serviceUrl="";this._presetId=0;this._presetList=null;this._presetListLoader=null;this._presetListLoadHandler=BX.delegate(this.onPresetListLoad,this);this._presetSelector=null;this._presetSelectHandler=BX.delegate(this.onPresetSelect,this);this._processDialog=null;this._processStateChangeHandler=BX.delegate(this.onProcessStateChange,this)};BX.CrmRequisiteConverter.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._entityTypeName=this.getSetting("entityTypeName","");if(!BX.type.isNotEmptyString(this._entityTypeName)){throw"BX.CrmRequisiteConverter. Could not find 'entityTypeName' parameter."}this._entityTypeName=this._entityTypeName.toUpperCase();this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"BX.CrmRequisiteConverter. Could not find 'serviceUrl' parameter."}},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.CrmRequisiteConverter.messages;return e.hasOwnProperty(t)?e[t]:t},convert:function(){if(this._presetId>0){this.openProcessDialog()}else{if(this._presetList===null){this.openPresetListLoader()}else{this.openPresetSelector()}}},skip:function(){BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"SKIP_CONVERT_REQUISITES",PARAMS:{}},onsuccess:BX.delegate(this._onRequestSuccess,this),onfailure:BX.delegate(this._onRequestFailure,this)})},openPresetListLoader:function(){if(!this._presetListLoader){this._presetListLoader=BX.CrmRequisitePresetListLoader.create(this._id,{entityTypeName:this._entityTypeName,serviceUrl:this._serviceUrl,callback:this._presetListLoadHandler})}this._presetListLoader.start()},onPresetListLoad:function(t,e){this._presetList=e["isSuccessed"]?e["resultData"]:[];this.openPresetSelector()},openPresetSelector:function(){if(!this._presetSelector){this._presetSelector=BX.CrmRequisitePresetSelectDialog.create(this._id,{list:this._presetList,callback:this._presetSelectHandler})}this._presetSelector.show()},onPresetSelect:function(t,e){if(this._presetSelector){if(e["isAccepted"]){this._presetId=parseInt(e["selectedValue"]);this.openProcessDialog()}this._presetSelector.close()}},openProcessDialog:function(){if(!this._processDialog){var t=this._entityTypeName.toLowerCase().replace(/(?:^)\S/,(function(t){return t.toUpperCase()}));var e="convert"+t+"Requisites";this._processDialog=BX.CrmLongRunningProcessDialog.create(e,{serviceUrl:this._serviceUrl,action:"CONVERT_REQUISITES",params:{ENTITY_TYPE_NAME:this._entityTypeName,PRESET_ID:this._presetId},title:this.getMessage("processDialogTitle"),summary:this.getMessage("processDialogSummary")});BX.addCustomEvent(this._processDialog,"ON_STATE_CHANGE",this._processStateChangeHandler)}this._processDialog.show()},closeProcessDialog:function(){if(this._processDialog){this._processDialog.close();this._processDialog=null}},onProcessStateChange:function(t){if(t.getState()===BX.CrmLongRunningProcessState.completed){BX.onCustomEvent(this,"ON_"+this._entityTypeName+"_REQUISITE_TRANFER_COMPLETE",[this])}}};if(typeof BX.CrmRequisiteConverter.messages==="undefined"){BX.CrmRequisiteConverter.messages={}}BX.CrmRequisiteConverter.create=function(t,e){var i=new BX.CrmRequisiteConverter;i.initialize(t,e);return i};BX.CrmPSRequisiteConverter=function(){this._id="";this._settings={};this._serviceUrl="";this._processDialog=null;this._processStateChangeHandler=BX.delegate(this.onProcessStateChange,this)};BX.CrmPSRequisiteConverter.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"BX.CrmPSRequisiteConverter. Could not find 'serviceUrl' parameter."}},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.CrmPSRequisiteConverter.messages;return e.hasOwnProperty(t)?e[t]:t},convert:function(){this.openProcessDialog()},skip:function(){BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"SKIP_CONVERT_PS_REQUISITES",PARAMS:{}},onsuccess:BX.delegate(this._onRequestSuccess,this),onfailure:BX.delegate(this._onRequestFailure,this)})},openProcessDialog:function(){if(!this._processDialog){this._processDialog=BX.CrmLongRunningProcessDialog.create("convertPSRequisites",{serviceUrl:this._serviceUrl,action:"CONVERT_PS_REQUISITES",params:{ENTITY_TYPE_NAME:this._entityTypeName,PRESET_ID:this._presetId},title:this.getMessage("processDialogTitle"),summary:this.getMessage("processDialogSummary")});BX.addCustomEvent(this._processDialog,"ON_STATE_CHANGE",this._processStateChangeHandler)}this._processDialog.show()},closeProcessDialog:function(){if(this._processDialog){this._processDialog.close();this._processDialog=null}},onProcessStateChange:function(t){if(t.getState()===BX.CrmLongRunningProcessState.completed){BX.onCustomEvent(this,"ON_PS_REQUISITE_TRANFER_COMPLETE",[this])}}};if(typeof BX.CrmPSRequisiteConverter.messages==="undefined"){BX.CrmPSRequisiteConverter.messages={}}BX.CrmPSRequisiteConverter.create=function(t,e){var i=new BX.CrmPSRequisiteConverter;i.initialize(t,e);return i};if(typeof BX.CrmDealCategory==="undefined"){BX.CrmDealCategory=function(){};BX.CrmDealCategory.getDefaultValue=function(){return"0"};BX.CrmDealCategory.getListItems=function(t){if(!BX.type.isArray(t)){t=BX.CrmDealCategory.infos}var e=[];for(var i=0,n=t.length;i<n;i++){var r=t[i];e.push({value:r["id"],text:r["name"]})}return e};BX.CrmDealCategory.getCount=function(){return BX.CrmDealCategory.infos.length};if(typeof BX.CrmDealCategory.infos==="undefined"){BX.CrmDealCategory.infos=[]}}if(typeof BX.CrmDealCategorySelector==="undefined"){BX.CrmDealCategorySelector=function(){this._id="";this._settings={};this._selectorMenu=null;this._menuItemSelectHandler=BX.delegate(this.onMenuItemSelect,this);this._canCreateCategory=false;this._createUrl="";this._categoryListUrl="";this._categoryCreateUrl=""};BX.CrmDealCategorySelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._canCreateCategory=!!this.getSetting("canCreateCategory",false);this._createUrl=this.getSetting("createUrl","");this._categoryListUrl=this.getSetting("categoryListUrl","");this._categoryCreateUrl=this.getSetting("categoryCreateUrl","")},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.CrmDealCategorySelector.messages;return e.hasOwnProperty(t)?e[t]:t},redirectToCreateUrl:function(t){if(this._createUrl===""){return}BX.Crm.Page.open(BX.util.add_url_param(this._createUrl,{category_id:t}))},openMenu:function(t){if(!this.getSelectorMenu().isOpened()){this.getSelectorMenu().open(t)}},getSelectorMenu:function(){if(!this._selectorMenu){var t=BX.CrmDealCategory.getListItems();if(this._canCreateCategory){t.push({text:this.getMessage("create"),value:"new"})}this._selectorMenu=BX.CmrSelectorMenu.create(this._id,{items:t});this._selectorMenu.addOnSelectListener(this._menuItemSelectHandler)}return this._selectorMenu},onMenuItemSelect:function(t,e){var i=e.getValue();if(this._selectorMenu.isOpened()){this._selectorMenu.close()}if(i==="new"){window.location=this._categoryCreateUrl}else{this.redirectToCreateUrl(parseInt(i))}}};if(typeof BX.CrmDealCategorySelector.messages==="undefined"){BX.CrmDealCategorySelector.messages={}}BX.CrmDealCategorySelector.items={};BX.CrmDealCategorySelector.create=function(t,e){var i=new BX.CrmDealCategorySelector;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmDealCategorySelectDialog==="undefined"){BX.CrmDealCategorySelectDialog=function(){this._id="";this._settings={};this._popup=null;this._selector=null;this._value="";this._isOpened=false;this._closeNotifier=null};BX.CrmDealCategorySelectDialog.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._value=parseInt(this.getSetting("value",0));if(isNaN(this._value)){this._value=0}this._closeNotifier=BX.CrmNotifier.create(this)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.CrmDealCategorySelectDialog.messages;return e.hasOwnProperty(t)?e[t]:t},isOpened:function(){return this._isOpened},open:function(){if(this._isOpened){return}this._popup=new BX.PopupWindow(this._id,null,{autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:true},closeByEsc:true,closeIcon:{top:"10px",right:"15px"},titleBar:this.getMessage("title"),content:this.prepareContent(),events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},buttons:this.prepareButtons()});this._popup.show()},close:function(){if(this._popup){this._popup.close()}},addCloseListener:function(t){this._closeNotifier.addListener(t)},removeCloseListener:function(t){this._closeNotifier.removeListener(t)},getFilteredCategories:function(){var t=BX.prop.getArray(this._settings,"categoryIds",[]);if(t.length===0){return BX.CrmDealCategory.infos}var e=BX.CrmDealCategory.infos.filter((function(e){for(var i=0,n=t.length;i<n;i++){if(e["id"]==t[i]){return true}}return false}));return e},prepareContent:function(){var t=BX.create("TABLE",{attrs:{className:"bx-crm-deal-category-selector-dialog",cellspacing:"2"}});var e,i;e=t.insertRow(-1);i=e.insertCell(-1);i.appendChild(BX.create("LABEL",{text:this.getMessage("field")+":"}));i=e.insertCell(-1);this._selector=BX.create("SELECT",{});var n=BX.CrmDealCategory.getListItems(this.getFilteredCategories());BX.HtmlHelper.setupSelectOptions(this._selector,n);if(n.length>0){this._selector.value=this._value>=0?this._value:n[0].value}i.appendChild(this._selector);return t},prepareButtons:function(){return[new BX.PopupWindowButton({text:this.getMessage("saveButton"),className:"popup-window-button-accept",events:{click:BX.delegate(this.processSave,this)}}),new BX.PopupWindowButtonLink({text:this.getMessage("cancelButton"),className:"popup-window-button-link-cancel",events:{click:BX.delegate(this.processCancel,this)}})]},getValue:function(){return this._value},setValue:function(t){t=parseInt(t);if(isNaN(t)){t=0}this._value=t},processSave:function(){this._value=parseInt(this._selector.value);if(isNaN(this._value)){this._value=0}this._closeNotifier.notify([{isCanceled:false}]);this.close()},processCancel:function(){this._closeNotifier.notify([{isCanceled:true}]);this.close()},onPopupShow:function(){this._isOpened=true},onPopupClose:function(){if(this._popup){this._popup.destroy()}},onPopupDestroy:function(){this._isOpened=false;this._popup=null}};if(typeof BX.CrmDealCategorySelectDialog.messages==="undefined"){BX.CrmDealCategorySelectDialog.messages={}}BX.CrmDealCategorySelectDialog.create=function(t,e){var i=new BX.CrmDealCategorySelectDialog;i.initialize(t,e);return i}}if(typeof BX.CrmEntityManager==="undefined"){BX.CrmEntityManager=function(){this._id="";this._settings={}};BX.CrmEntityManager.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{}},getEntityCreateUrl:function(t){return BX.prop.getString(BX.CrmEntityManager.entityCreateUrls,t,"")},innerCreateEntity:function(t,e){var i=this.getEntityCreateUrl(t);if(i===""){throw"BX.CrmEntityManager.innerCreateEntity: Could not find create URL for type "+t}var n=BX.prop.getObject(e,"urlParams",null);if(n){i=BX.util.add_url_param(i,n)}return BX.Crm.Page.open(i,{openInNewWindow:true})},createEntity:function(t,e){if(BX.type.isNumber(t)||BX.CrmEntityType.verifyName(t)===""){t=BX.CrmEntityType.resolveName(t)}if(!BX.type.isPlainObject(e)){e={}}var i=new BX.Promise;if(t===BX.CrmEntityType.names.deal&&BX.CrmDealCategory.getCount()>1){var n=BX.CrmDealCategorySelectDialog.create(this._id,{value:0});n.addCloseListener(function(t,n){if(!(BX.type.isBoolean(n["isCanceled"])&&n["isCanceled"]===false)){i.reject({isCanceled:true})}else{var r=t.getValue();if(r>=0){e["urlParams"]=BX.mergeEx(BX.prop.getObject(e,"urlParams",{}),{category_id:r})}i.fulfill({wnd:this.innerCreateEntity(BX.CrmEntityType.names.deal,e)})}}.bind(this));n.open()}else{window.setTimeout(function(){i.fulfill({wnd:this.innerCreateEntity(t,e)})}.bind(this),0)}return i}};BX.CrmEntityManager.entityCreateUrls={};BX.CrmEntityManager.current=null;BX.CrmEntityManager.getCurrent=function(){if(!this._current){this._current=this.create("current",{})}return this._current};BX.CrmEntityManager.createEntity=function(t,e){return this.getCurrent().createEntity(t,e)};BX.CrmEntityManager.create=function(t,e){var i=new BX.CrmEntityManager;i.initialize(t,e);return i}}if(typeof BX.CrmHtmlLoader==="undefined"){BX.CrmHtmlLoader=function(){this._id="";this._settings={};this._params={};this._serviceUrl="";this._requestIsRunning=false;this._button=null;this._wrapper=null;this._buttonClickHandler=BX.delegate(this.onButtonClick,this)};BX.CrmHtmlLoader.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._serviceUrl=this.getSetting("serviceUrl");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"BX.CrmHtmlLoader: service url not found!"}this._action=this.getSetting("action");if(!BX.type.isNotEmptyString(this._action)){throw"BX.CrmHtmlLoader: action not found!"}this._params=this.getSetting("params",{});this._button=BX(this.getSetting("button"));if(!BX.type.isElementNode(this._button)){throw"BX.CrmHtmlLoader: button element not found!"}BX.bind(this._button,"click",this._buttonClickHandler);this._wrapper=BX(this.getSetting("wrapper"));if(!BX.type.isElementNode(this._wrapper)){throw"BX.CrmHtmlLoader: wrapper element not found!"}},release:function(){BX.unbind(this._button,"click",this._buttonClickHandler)},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},onButtonClick:function(t){this.startRequest();return BX.PreventDefault(t)},startRequest:function(){if(this._requestIsRunning){return}this._requestIsRunning=true;BX.showWait();BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:this._action,PARAMS:this._params},onsuccess:BX.delegate(this.onRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})},onRequestSuccess:function(t){BX.closeWait();this._requestIsRunning=false;if(BX.type.isPlainObject(t["ERROR"])){this.showError(t["ERROR"]);return}if(BX.type.isPlainObject(t["DATA"])){var e=t["DATA"];if(BX.type.isNotEmptyString(e["HTML"])){this._wrapper.innerHTML=e["HTML"]}else if(BX.type.isNotEmptyString(e["TEXT"])){this._wrapper.innerHTML=BX.util.htmlspecialchars(e["TEXT"])}}},onRequestFailure:function(t){BX.closeWait();this._requestIsRunning=false},showError:function(t){if(BX.type.isPlainObject(t)&&BX.type.isNotEmptyString(t["MESSAGE"])){alert(t["MESSAGE"])}}};BX.CrmHtmlLoader.create=function(t,e){var i=new BX.CrmHtmlLoader;i.initialize(t,e);return i}}if(typeof BX.CrmDataLoader==="undefined"){BX.CrmDataLoader=function(){this._id="";this._settings={};this._params={};this._serviceUrl="";this._requestIsRunning=false;this._notifier=null;this._result=null};BX.CrmDataLoader.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._serviceUrl=this.getSetting("serviceUrl");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"BX.CrmDataLoader: service url not found!"}this._action=this.getSetting("action");if(!BX.type.isNotEmptyString(this._action)){throw"BX.CrmDataLoader: action not found!"}this._params=this.getSetting("params",{});this._notifier=BX.CrmNotifier.create(this)},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getResult:function(){return this._result},isRequestRunning:function(){return this._requestIsRunning},addCallBack:function(t){if(!BX.type.isFunction(t)){return}for(var e=0;this._callbacks.length;e++){if(this._callbacks[e]===t){return}}this._callbacks.push(t)},load:function(t){if(!BX.type.isFunction(t)){t=null}if(this._result===null){this._notifier.addListener(t);this.startRequest()}else if(t!==null){t(this._result)}},startRequest:function(){if(this._requestIsRunning){return}this._requestIsRunning=true;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:this._action,PARAMS:this._params},onsuccess:BX.delegate(this.onRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})},onRequestSuccess:function(t){BX.closeWait();this._requestIsRunning=false;this._result=BX.type.isPlainObject(t)?t:{};this._notifier.notify([this._result]);this._notifier.resetListeners()},onRequestFailure:function(t){BX.closeWait();this._requestIsRunning=false;this._result=BX.type.isPlainObject(t)?t:{};this._notifier.notify([this._result]);this._notifier.resetListeners()}};BX.CrmDataLoader.create=function(t,e){var i=new BX.CrmDataLoader;i.initialize(t,e);return i}}if(typeof BX.CrmRemoteAction){BX.CrmRemoteAction=function(){this._id="";this._settings={};this._serviceUrl="";this._redirectUrl=""};BX.CrmRemoteAction.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"BX.CrmRemoteAction: service url not found!"}this._redirectUrl=this.getSetting("redirectUrl","")},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},execute:function(t){if(BX.type.isNotEmptyString(t)){this._redirectUrl=t}BX.ajax({method:"POST",dataType:"html",url:this._serviceUrl,data:this.getSetting("data",{}),onsuccess:BX.delegate(this.onActionSuccess,this)})},onActionSuccess:function(t){if(BX.type.isNotEmptyString(this._redirectUrl)){document.location.href=this._redirectUrl}}};BX.CrmRemoteAction.items={};BX.CrmRemoteAction.create=function(t,e){var i=new BX.CrmRemoteAction;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmDeletionConfirmDialog==="undefined"){BX.CrmDeletionConfirmDialog=function(){this._id="";this._settings={};this._name="";this._path="";this._messages={};this._dlg=null;this._closeNotifier=null};BX.CrmDeletionConfirmDialog.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._name=this.getSetting("name","");this._path=this.getSetting("path","");if(!BX.type.isNotEmptyString(this._path)){throw"BX.CrmDeletionConfirmDialog: Could not find parameter 'path'."}this._messages=this.getSetting("messages",{});this._closeNotifier=BX.CrmNotifier.create(this)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){return this._messages.hasOwnProperty(t)?this._messages[t]:t},open:function(){this._dlg=new BX.CDialog({title:this.getMessage("title"),head:"",content:this.getMessage("confirm").replace(/#NAME#/gi,this._name),resizable:false,draggable:true,height:70,width:300});this._dlg.SetButtons([{title:this.getMessage("deleteButton"),id:"delete",action:BX.delegate(this.onAction,this)},BX.CDialog.btnClose]);this._dlg.Show()},close:function(){if(this._dlg){this._dlg.Close()}},onAction:function(){this.close();window.location.href=this._path}};BX.CrmDeletionConfirmDialog.create=function(t,e){var i=new BX.CrmDeletionConfirmDialog;i.initialize(t,e);return i}}if(typeof BX.FilterUserSelector==="undefined"){BX.FilterUserSelector=function(){this._id="";this._settings={};this._fieldId="";this._control=null;this._currentUser=null;this._componentName=null;this._componentObj=null;this._componentContainer=null;this._serviceContainer=null;this._zIndex=1100;this._isDialogDisplayed=false;this._dialog=null;this._inputKeyPressHandler=BX.delegate(this.onInputKeyPress,this)};BX.FilterUserSelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._fieldId=this.getSetting("fieldId","");this._componentName=this.getSetting("componentName","");this._componentContainer=BX(this._componentName+"_selector_content");this._serviceContainer=this.getSetting("serviceContainer",null);if(!BX.type.isDomNode(this._serviceContainer)){this._serviceContainer=document.body}BX.addCustomEvent(window,"BX.Main.Filter:customEntityFocus",BX.delegate(this.onCustomEntitySelectorOpen,this));BX.addCustomEvent(window,"BX.Main.Filter:customEntityBlur",BX.delegate(this.onCustomEntitySelectorClose,this))},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getSearchInput:function(){return this._control?this._control.getLabelNode():null},isOpened:function(){return this._isDialogDisplayed},open:function(){if(this._componentObj===null){var t="O_"+this._componentName;if(!window[t]){throw"BX.FilterUserSelector: Could not find '"+t+"' user selector."}this._componentObj=window[t]}var e=this.getSearchInput();if(this._componentObj.searchInput){BX.unbind(this._componentObj.searchInput,"keyup",BX.proxy(this._componentObj.search,this._componentObj))}this._componentObj.searchInput=e;BX.bind(this._componentObj.searchInput,"keyup",BX.proxy(this._componentObj.search,this._componentObj));this._componentObj.onSelect=BX.delegate(this.onSelect,this);BX.bind(e,"keyup",this._inputKeyPressHandler);if(this._currentUser){this._componentObj.setSelected([this._currentUser])}else{var i=this._componentObj.getSelected();if(i){for(var n in i){if(i.hasOwnProperty(n)){this._componentObj.unselect(n)}}}}if(this._dialog===null){this._componentContainer.style.display="";this._dialog=new BX.PopupWindow(this._id,this.getSearchInput(),{autoHide:false,draggable:false,closeByEsc:true,offsetLeft:0,offsetTop:0,zIndex:this._zIndex,bindOptions:{forceBindPosition:true},content:this._componentContainer,events:{onPopupShow:BX.delegate(this.onDialogShow,this),onPopupClose:BX.delegate(this.onDialogClose,this),onPopupDestroy:BX.delegate(this.onDialogDestroy,this)}})}this._dialog.show();this._componentObj._onFocus();if(this._control){this._control.setPopupContainer(this._componentContainer)}},close:function(){var t=this.getSearchInput();if(t){BX.unbind(t,"keyup",this._inputKeyPressHandler)}if(this._dialog){this._dialog.close()}if(this._control){this._control.setPopupContainer(null)}},closeSiblings:function(){var t=BX.FilterUserSelector.items;for(var e in t){if(t.hasOwnProperty(e)&&t[e]!==this){t[e].close()}}},onCustomEntitySelectorOpen:function(t){var e=t.getId();if(this._fieldId!==e){this._control=null;this.close()}else{this._control=t;if(this._control){var i=this._control.getCurrentValues();this._currentUser={id:i["value"]}}this.closeSiblings();this.open()}},onCustomEntitySelectorClose:function(t){if(this._fieldId===t.getId()){this._control=null;this.close()}},onDialogShow:function(){this._isDialogDisplayed=true},onDialogClose:function(){this._componentContainer.parentNode.removeChild(this._componentContainer);this._serviceContainer.appendChild(this._componentContainer);this._componentContainer.style.display="none";this._dialog.destroy();this._isDialogDisplayed=false},onDialogDestroy:function(){this._dialog=null},onInputKeyPress:function(t){if(!this._dialog||!this._isDialogDisplayed){this.open()}if(this._componentObj){this._componentObj.search()}},onSelect:function(t){this._currentUser=t;if(this._control){var e=this._control.getLabelNode();e.value="";this._control.setData(t["name"],t["id"])}this.close()}};BX.FilterUserSelector.closeAll=function(){for(var t in this.items){if(this.items.hasOwnProperty(t)){this.items[t].close()}}};BX.FilterUserSelector.items={};BX.FilterUserSelector.create=function(t,e){var i=new BX.FilterUserSelector(t,e);i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.CrmUIFilterEntitySelector==="undefined"){BX.CrmUIFilterEntitySelector=function(){this._id="";this._settings={};this._fieldId="";this._control=null;this._entitySelector=null;this._filterOpenHandler=BX.delegate(this.onCustomEntitySelectorOpen,this);this._filterCloseHandler=BX.delegate(this.onCustomEntitySelectorClose,this)};BX.CrmUIFilterEntitySelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._fieldId=this.getSetting("fieldId","");BX.addCustomEvent(window,"BX.Main.Filter:customEntityFocus",this._filterOpenHandler);BX.addCustomEvent(window,"BX.Main.Filter:customEntityBlur",this._filterCloseHandler)},release:function(){BX.removeCustomEvent(window,"BX.Main.Filter:customEntityFocus",this._filterOpenHandler);BX.removeCustomEvent(window,"BX.Main.Filter:customEntityBlur",this._filterCloseHandler)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getSearchInput:function(){return this._control?this._control.getLabelNode():null},onCustomEntitySelectorOpen:function(t){var e=t.getId();if(this._fieldId!==e){this._control=null;this.close()}else{this._control=t;this.closeSiblings();this.open()}},onCustomEntitySelectorClose:function(t){if(this._fieldId===t.getId()){this._control=null;this.close()}},onSelect:function(t,e){if(!this._control){return}var i=[];var n={};for(var r in e){if(!e.hasOwnProperty(r)){continue}var s=e[r];for(var o=0,a=s.length;o<a;o++){var l=s[o];i.push(l["title"]);if(typeof n[r]==="undefined"){n[r]=[]}n[r].push(l["entityId"])}}this._control.setData(i.join(", "),JSON.stringify(n))},open:function(){if(!this._entitySelector){this._entitySelector=BX.CrmEntitySelector.create(this._id,{entityTypeNames:this.getSetting("entityTypeNames",[]),isMultiple:this.getSetting("isMultiple",false),title:this.getSetting("title","")});BX.addCustomEvent(this._entitySelector,"BX.CrmEntitySelector:select",BX.delegate(this.onSelect,this))}this._entitySelector.open(this.getSearchInput());if(this._control){this._control.setPopupContainer(this._entitySelector.getPopup()["contentContainer"])}},close:function(){if(this._entitySelector){this._entitySelector.close();if(this._control){this._control.setPopupContainer(null)}}},closeSiblings:function(){var t=BX.CrmUIFilterEntitySelector.items;for(var e in t){if(t.hasOwnProperty(e)&&t[e]!==this){t[e].close()}}}};BX.CrmUIFilterEntitySelector.items={};BX.CrmUIFilterEntitySelector.remove=function(t){var e=BX.prop.get(this.items,t,null);if(e){e.release();delete this.items[t]}};BX.CrmUIFilterEntitySelector.create=function(t,e){var i=new BX.CrmUIFilterEntitySelector(t,e);i.initialize(t,e);BX.CrmUIFilterEntitySelector.items[i.getId()]=i;return i}}if(typeof BX.CrmEntitySelector==="undefined"){BX.CrmEntitySelector=function(){this._id="";this._settings={};this._entityTypeNames=[];this._isMultiple=false;this._entityInfos=null;this._entitySelectHandler=BX.delegate(this.onEntitySelect,this)};BX.CrmEntitySelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._entityTypeNames=this.getSetting("entityTypeNames",[]);this._isMultiple=this.getSetting("isMultiple",false);this._entityInfos=[]},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.CrmEntitySelector.messages;return e.hasOwnProperty(t)?e[t]:t},isOpened:function(){return obCrm[this._id].popup instanceof BX.PopupWindow&&obCrm[this._id].popup.isShown()},open:function(t){if(typeof obCrm[this._id]==="undefined"){var e=[];for(var i=0,n=this._entityTypeNames.length;i<n;i++){e.push(this._entityTypeNames[i].toLowerCase())}obCrm[this._id]=new CRM(this._id,null,null,this._id,this._entityInfos,false,this._isMultiple,e,{contact:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.contact),company:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.company),invoice:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.invoice),quote:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.quote),lead:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.lead),deal:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.deal),ok:this.getMessage("selectButton"),cancel:BX.message("JS_CORE_WINDOW_CANCEL"),close:BX.message("JS_CORE_WINDOW_CLOSE"),wait:BX.message("JS_CORE_LOADING"),noresult:this.getMessage("noresult"),search:this.getMessage("search"),last:this.getMessage("last")},true);obCrm[this._id].Init();obCrm[this._id].AddOnSaveListener(this._entitySelectHandler)}if(!(obCrm[this._id].popup instanceof BX.PopupWindow&&obCrm[this._id].popup.isShown())){if(!BX.type.isDomNode(t)){t=BX.prop.getElementNode(this._settings,"anchor",null)}obCrm[this._id].Open({closeIcon:{top:"10px",right:"15px"},closeByEsc:true,autoHide:false,gainFocus:false,anchor:t,titleBar:this.getSetting("title","")})}},close:function(){if(typeof obCrm[this._id]!=="undefined"){obCrm[this._id].RemoveOnSaveListener(this._entitySelectHandler);obCrm[this._id].Clear();delete obCrm[this._id]}},getPopup:function(){return typeof obCrm[this._id]!=="undefined"?obCrm[this._id].popup:null},onEntitySelect:function(t){this.close();var e={};this._entityInfos=[];for(var i in t){if(!t.hasOwnProperty(i)){continue}var n=t[i];if(!BX.type.isPlainObject(n)){continue}var r=i.toUpperCase();for(var s in n){if(!n.hasOwnProperty(s)){continue}var o=n[s];this._entityInfos.push({id:o["id"],type:o["type"],title:o["title"],desc:o["desc"],url:o["url"],image:o["image"],selected:"Y"});var a=BX.type.isNotEmptyString(o["id"])?parseInt(o["id"]):0;if(a>0){if(typeof e[r]==="undefined"){e[r]=[]}e[r].push({entityTypeName:r,entityId:a,title:BX.type.isNotEmptyString(o["title"])?o["title"]:"["+a+"]"})}}}BX.onCustomEvent(this,"BX.CrmEntitySelector:select",[this,e])}};if(typeof BX.CrmEntitySelector.messages==="undefined"){BX.CrmEntitySelector.messages={}}BX.CrmEntitySelector.closeAll=function(){for(var t in this.items){if(this.items.hasOwnProperty(t)){this.items[t].close()}}};BX.CrmEntitySelector.items={};BX.CrmEntitySelector.create=function(t,e){var i=new BX.CrmEntitySelector(t,e);i.initialize(t,e);BX.CrmEntitySelector.items[i.getId()]=i;return i}}if(typeof BX.CrmSearchContentManager==="undefined"){BX.CrmSearchContentManager=function(){this._id="";this._settings={};this._entityTypeName="";this._processDialogs={}};BX.CrmSearchContentManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_search_content_mgr_"+Math.random().toString().substring(2);this._settings=e?e:{};this._entityTypeName=this.getSetting("entityTypeName","");if(!BX.type.isNotEmptyString(this._entityTypeName)){throw"BX.CrmSearchContentManager. Could not find entity type name."}this._entityTypeName=this._entityTypeName.toUpperCase()},getId:function(){return this._id},getEntityTypeName:function(){return this._entityTypeName},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},getMessage:function(t){var e=BX.CrmSearchContentManager.messages;return e.hasOwnProperty(t)?e[t]:t},rebuildIndex:function(){var t=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(t)){throw"BX.CrmSearchContentManager. Could not find service url."}var e=this._entityTypeName.toLowerCase().replace(/(?:^)\S/,(function(t){return t.toUpperCase()}));var i="rebuild"+e;var n=null;if(typeof this._processDialogs[i]!=="undefined"){n=this._processDialogs[i]}else{n=BX.CrmLongRunningProcessDialog.create(i,{serviceUrl:t,action:"REBUILD_SEARCH_CONTENT",params:{ENTITY_TYPE_NAME:this._entityTypeName},title:this.getMessage(i+"DlgTitle"),summary:this.getMessage(i+"DlgSummary")});this._processDialogs[i]=n;BX.addCustomEvent(n,"ON_STATE_CHANGE",BX.delegate(this._onProcessStateChange,this))}n.show()},_onProcessStateChange:function(t){var e=t.getId();if(typeof this._processDialogs[e]!=="undefined"){var i=this._processDialogs[e];if(i.getState()===BX.CrmLongRunningProcessState.completed){BX.onCustomEvent(this,"ON_"+this._entityTypeName+"_SEARCH_CONTENT_REBUILD_COMPLETE",[this])}}}};if(typeof BX.CrmSearchContentManager.messages==="undefined"){BX.CrmSearchContentManager.messages={}}BX.CrmSearchContentManager.items={};BX.CrmSearchContentManager.create=function(t,e){var i=new BX.CrmSearchContentManager;i.initialize(t,e);this.items[i.getId()]=i;return i}}BX.Crm.Page={sliders:{lead:{condition:new RegExp("/crm/lead/details/[0-9]+/","i")},leadMerge:{condition:new RegExp("/crm/lead/merge/","i"),options:{customLeftBoundary:0}},leadDedupeList:{condition:new RegExp("/crm/lead/dedupelist/","i"),stopParameters:["page","IFRAME"]},leadAutomation:{condition:new RegExp("/crm/lead/automation/[0-9]+/","i"),stopParameters:["grid_action","page"],options:{customLeftBoundary:0,loader:"bizproc:automation-loader"}},contact:{condition:new RegExp("/crm/contact/details/[0-9]+/","i")},contactMerge:{condition:new RegExp("/crm/contact/merge/","i"),options:{customLeftBoundary:0}},contactDedupeList:{condition:new RegExp("/crm/contact/dedupelist/","i"),stopParameters:["page","IFRAME"]},company:{condition:new RegExp("/crm/company/details/[0-9]+/","i")},companyMerge:{condition:new RegExp("/crm/company/merge/","i"),options:{customLeftBoundary:0}},companyDedupeList:{condition:new RegExp("/crm/company/dedupelist/","i"),stopParameters:["page","IFRAME"]},deal:{condition:new RegExp("/crm/deal/details/[0-9]+/","i")},dealMerge:{condition:new RegExp("/crm/deal/merge/","i"),options:{customLeftBoundary:0}},dealAutomation:{condition:new RegExp("/crm/deal/automation/[0-9]+/","i"),stopParameters:["grid_action","page"],options:{customLeftBoundary:0,loader:"bizproc:automation-loader"}},quote:{condition:new RegExp("/crm/type/7/details/[0-9]+/","i")},order:{condition:new RegExp("/shop/orders/details/[0-9]+/","i")},orderSalescenter:{condition:new RegExp("/saleshub/orders/order/","i")},orderShipment:{condition:new RegExp("/shop/orders/shipment/details/[0-9]+/","i")},orderPayment:{condition:new RegExp("/shop/orders/payment/details/[0-9]+/","i")},orderAutomation:{condition:new RegExp("/shop/orders/automation/[0-9]+/","i"),stopParameters:["grid_action","page"],options:{customLeftBoundary:0,loader:"bizproc:automation-loader"}},factoryBased:{condition:new RegExp("/type/[0-9]+/details/[0-9]+/","i")},dynamicAutomation:{condition:new RegExp("/crm/type/[0-9]+/automation/[0-9]+/","i"),stopParameters:["grid_action","page"],options:{customLeftBoundary:0,loader:"bizproc:automation-loader"}},activity:{condition:new RegExp("/bitrix/components/bitrix/crm.activity.planner/slider.php","i"),options:{allowChangeHistory:false,width:1080}}},items:[],initialized:false,initialize:function(){if(this.initialized){return}if(!(BX.SidePanel&&BX.SidePanel.Instance)){return}if(window===window.top){var t=[];for(var e in this.sliders){if(!this.sliders.hasOwnProperty(e)){continue}var i=this.sliders[e];var n=BX.prop.getObject(i,"options",{});if(!n.hasOwnProperty("cacheable")){n["cacheable"]=false}t.push({condition:[i.condition],stopParameters:BX.prop.getArray(i,"stopParameters",[]),loader:"crm-entity-details-loader",options:n})}BX.SidePanel.Instance.bindAnchors({rules:t})}this.initialized=true},getItem:function(t){for(var e=0,i=this.items.length;e<i;e++){var n=this.items[e];if(BX.prop.getString(n,"url","")===t){return n}}return null},isSliderEnabled:function(t){if(!(window.top.BX.SidePanel&&window.top.BX.SidePanel.Instance)){return false}for(var e in this.sliders){if(!this.sliders.hasOwnProperty(e)){continue}var i=this.sliders[e];if(i.condition.test(t)){return true}}return false},open:function(t,e){if(!this.initialized){this.initialize()}if(!BX.browser.IsMobile()&&this.isSliderEnabled(t)){this.openSlider(t);return null}if(BX.prop.getBoolean(e,"openInNewWindow",false)){return window.open(t)}window.top.location.href=t;return null},close:function(t,e){var i=this.getItem(t);if(!i){return}if(BX.prop.getString(i,"","isSlider",false)){this.closeSlider(t,false,e)}else{var n=BX.prop.getString(i,"","wnd",null);if(n){n.close()}}},openInNewTab:function(t){if(this.isSliderEnabled(t)){this.openSlider(t)}else{this.openTab(t)}},openTab:function(t){this.items.push({url:t,isSlider:false,wnd:window.open(t)})},openPage:function(t){window.top.location.href=BX.util.remove_url_param(t,["IFRAME","IFRAME_TYPE"])},openSlider:function(t,e){if(!(window.top.BX.SidePanel&&window.top.BX.SidePanel.Instance)){return}if(!BX.type.isPlainObject(e)){e=undefined}window.top.BX.SidePanel.Instance.open(BX.util.add_url_param(t,{IFRAME:"Y",IFRAME_TYPE:"SIDE_SLIDER"}),e);this.items.push({url:t,isSlider:true})},closeSlider:function(t,e,i){if(!(window.top.BX.SidePanel&&window.top.BX.SidePanel.Instance)){return}var n=window.top.BX.SidePanel.Instance.getTopSlider();if(!n){return}var r=false,s="",o="";var a=BX.prop.getObject(i,"identity",null);if(a){s=BX.prop.getString(a,"key","");o=BX.prop.getString(a,"value","")}if(s!==""&&o!==""){var l="";if(typeof BX.Uri!=="undefined"){l=new BX.Uri(n.getUrl()).getQueryParam(s)}else{l=this.getQueryParam(n.getUrl(),s)}r=BX.type.isString(l)&&l.toUpperCase()===o.toUpperCase()}else{r=n.getUrl()===t}if(r){n.close(true);if(!e){window.top.BX.SidePanel.Instance.destroy(n.getUrl())}}else if(!e){window.top.BX.SidePanel.Instance.destroy(t)}},removeSlider:function(t){window.top.BX.SidePanel.Instance.destroy(t)},getQueryParam:function(t,e){if(!BX.type.isNotEmptyString(e)){return""}var i=new RegExp("(?:^|[?&])"+e+"=([^&#]*)","i").exec(t);return BX.type.isArray(i)&&typeof i[1]!=="undefined"?i[1]:""},getTopSlider:function(){if(window.top.BX.SidePanel&&window.top.BX.SidePanel.Instance){return window.top.BX.SidePanel.Instance.getTopSlider()}return null}};if(typeof BX.Crm.Form==="undefined"){BX.Crm.Form=function(){this._id="";this._settings=null;this._elementNode=null};BX.Crm.Form.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=BX.type.isPlainObject(e)?e:{};this._elementNode=BX.prop.getElementNode(this._settings,"elementNode",null);if(!this._elementNode){throw"BX.Crm.Form: Could not find 'elementNode' parameter in settings."}this.doInitialize()},doInitialize:function(){},getId:function(){return this._id},getElementNode:function(){return this._elementNode},submit:function(t){if(!BX.type.isPlainObject(t)){t={}}var e={cancel:false,options:t};BX.onCustomEvent(this,"onBeforeSubmit",[this,e]);if(e["cancel"]){BX.onCustomEvent(this,"onSubmitCancel",[this,e]);return false}this.doSubmit(t);BX.onCustomEvent(this,"onAfterSubmit",[this,{options:t}]);return true},doSubmit:function(t){}}}if(typeof BX.Crm.AjaxForm==="undefined"){BX.Crm.AjaxForm=function(){BX.Crm.AjaxForm.superclass.constructor.apply(this);this._config=null};BX.extend(BX.Crm.AjaxForm,BX.Crm.Form);BX.Crm.AjaxForm.prototype.doInitialize=function(){this._config=BX.prop.getObject(this._settings,"config",null);if(!this._config){throw"BX.Crm.AjaxForm: Could not find 'config' parameter in settings."}if(BX.prop.getString(this._config,"url","")===""){throw"BX.Crm.AjaxForm: Could not find 'url' parameter in config"}if(BX.prop.getString(this._config,"method","")===""){this._config["method"]="POST"}if(BX.prop.getString(this._config,"dataType","")===""){this._config["dataType"]="json"}};BX.Crm.AjaxForm.prototype.getUrl=function(){return BX.prop.getString(this._config,"url","")};BX.Crm.AjaxForm.prototype.setUrl=function(t){this._config["url"]=t};BX.Crm.AjaxForm.prototype.addUrlParams=function(t){if(BX.type.isPlainObject(t)&&Object.keys(t).length>0){this._config["url"]=BX.util.add_url_param(BX.prop.getString(this._config,"url",""),t)}};BX.Crm.AjaxForm.prototype.doSubmit=function(t){BX.ajax.submitAjax(this._elementNode,this._config)};BX.Crm.AjaxForm.create=function(t,e){var i=new BX.Crm.AjaxForm;i.initialize(t,e);return i}}if(typeof BX.Crm.ComponentAjax==="undefined"){BX.Crm.ComponentAjax=function(){BX.Crm.ComponentAjax.superclass.constructor.apply(this);this._className="";this._actionName="";this._signedParameters=null;this._callbacks=null;this._getParameters={}};BX.extend(BX.Crm.ComponentAjax,BX.Crm.Form);BX.Crm.ComponentAjax.prototype.doInitialize=function(){this._className=BX.prop.getString(this._settings,"className","");this._actionName=BX.prop.getString(this._settings,"actionName","");this._signedParameters=BX.prop.getString(this._settings,"signedParameters",null);this._callbacks=BX.prop.getObject(this._settings,"callbacks",{})};BX.Crm.ComponentAjax.prototype.addUrlParams=function(t){if(BX.type.isPlainObject(t)&&Object.keys(t).length>0){this._getParameters=BX.merge(this._getParameters,t)}};BX.Crm.ComponentAjax.prototype.doSubmit=function(t){BX.ajax.runComponentAction(this._className,this._actionName,{mode:"class",signedParameters:this._signedParameters,data:BX.ajax.prepareForm(this._elementNode),getParameters:this._getParameters}).then(function(t){var e=BX.prop.getFunction(this._callbacks,"onSuccess",null);if(e){BX.onCustomEvent(window,"BX.Crm.EntityEditorAjax:onSubmit",[t["data"]["ENTITY_DATA"],t]);e(t["data"])}}.bind(this)).catch(function(t){var e=BX.prop.getFunction(this._callbacks,"onFailure",null);if(!e){return}var i=[];var n=t["errors"];for(var r=0,s=n.length;r<s;r++){i.push(n[r]["message"])}BX.onCustomEvent(window,"BX.Crm.EntityEditorAjax:onSubmitFailure",[t["errors"]]);e({ERRORS:i})}.bind(this))};BX.Crm.ComponentAjax.create=function(t,e){var i=new BX.Crm.ComponentAjax;i.initialize(t,e);return i}}if(typeof BX.Collection==="undefined"){BX.Collection=function(){this._items=[]};BX.Collection.prototype={initialize:function(t){this._items=BX.type.isArray(t)?t:[]},findIndex:function(t){for(var e=0,i=this._items.length;e<i;e++){if(t===this._items[e]){return e}}return-1},search:function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(t(n)){return n}}return null},getItems:function(){return[].concat(this._items)},get:function(t){return t<this._items.length?this._items[t]:null},set:function(t,e){if(this.findIndex(e)>=0){return}if(t>=0&&t<this._items.length){this._items[t]=e}else{this._items.push(e)}},add:function(t){if(this.findIndex(t)<0){this._items.push(t)}},remove:function(t){var e=this.findIndex(t);if(e>=0){this._items.splice(e,1)}},removeAll:function(){this._items=[]},length:function(){return this._items.length}};BX.Collection.create=function(t){var e=new BX.Collection;e.initialize(t);return e}}if(typeof BX.CrmLeadMode==="undefined"){BX.namespace("BX.CrmLeadMode");BX.CrmLeadMode={currentCrmType:"simple",typeBlocks:[],message:{},isAdmin:false,leadPath:"",dealPath:"",isLeadEnabled:true,existActiveLeads:false,init:function(t){this.existActiveLeads=false;if(typeof t=="object"&&t){this.ajaxPath=t.ajaxPath||"";this.message=t.messages||"";this.leadPath=t.leadPath||"";this.dealPath=t.dealPath||"";this.isAdmin=t.isAdmin=="Y";this.isLeadEnabled=t.isLeadEnabled=="Y";this.currentCrmType=this.isLeadEnabled?"classic":"simple"}},changeCrmType:function(t){if(!BX.type.isDomNode(t))return;for(var e=0,i=this.typeBlocks.length;e<i;e++){var n=BX.firstChild(this.typeBlocks[e]);if(!BX.type.isDomNode(n))continue;if(this.typeBlocks[e]==t){BX.addClass(n,"crm-lead-info-popup-btn-active");this.currentCrmType=this.typeBlocks[e].getAttribute("data-crm-type")}else{BX.removeClass(n,"crm-lead-info-popup-btn-active")}}},sendAjax:function(t){BX.ajax({url:this.ajaxPath+"?analyticsModeChange="+this.currentCrmType+(t=="convertCompleted"?"&analyticsLeadConvertToDeal":""),method:"POST",dataType:"json",data:{sessid:BX.bitrix_sessid(),action:"changeCrmType",crmType:this.currentCrmType},onsuccess:BX.proxy((function(t){if(t.error){alert(t.error)}else{document.location.href=this.currentCrmType=="simple"?this.dealPath:this.leadPath}}),this),onfailure:function(){}})},convertLead:function(){var t=BX.Crm.BatchConversionManager.create("simpleCrmConvert",{gridId:"simpleCrmConvert",serviceUrl:"/bitrix/components/bitrix/crm.lead.list/list.ajax.php?sessid="+BX.bitrix_sessid(),container:"crmLeadConverterWrapper",stateTemplate:this.message["CRM_LEAD_BATCH_CONVERSION_STATE"],messages:{title:this.message["CRM_LEAD_BATCH_CONVERSION_TITLE"],windowCloseConfirm:this.message["CRM_LEAD_BATCH_CONVERSION_DLG_CLOSE_CONFIRMATION"],summaryCaption:this.message["CRM_LEAD_BATCH_CONVERSION_COMPLETED"],summarySucceeded:this.message["CRM_LEAD_BATCH_CONVERSION_COUNT_SUCCEEDED"],summaryFailed:this.message["CRM_LEAD_BATCH_CONVERSION_COUNT_FAILED"]}});var e=BX.CrmLeadConversionScheme.createConfig(BX.CrmLeadConversionScheme.dealcontactcompany);e.contact.initData={defaultName:this.message["CRM_LEAD_BATCH_CONVERSION_NO_NAME"]};t.setConfig(e);t.setFilter({"=STATUS_SEMANTIC_ID":"P"});t.enableConfigCheck(false);t.enableUserFieldCheck(false);BX.addCustomEvent(window,"BX.Crm.BatchConversionManager:onProcessComplete",function(){this.sendAjax("convertCompleted")}.bind(this));BX.addCustomEvent(window,"BX.Crm.BatchConversionManager:onStop",function(){BX.PopupWindowManager.getCurrentPopup().destroy()}.bind(this));t.execute()},confirmLeadConvert:function(){BX.PopupWindowManager.create("confirmLeadConvert",null,{closeIcon:false,lightShadow:true,overlay:true,titleBar:this.message["CRM_LEAD_CONVERT_TITLE"],zIndex:-970,buttons:[new BX.UI.Button({text:this.message["CRM_TYPE_CONTINUE"],id:"continue",color:BX.UI.Button.Color.SUCCESS,events:{click:function(){var t=BX.PopupWindowManager.getPopupById("confirmLeadConvert").getButton("continue");if(t.isWaiting()){return}t.setWaiting();BX.loadCSS("/bitrix/js/crm/css/autorun_proc.css");BX.loadScript(["/bitrix/js/crm/batch_conversion.js","/bitrix/js/crm/progress_control.js","/bitrix/js/crm/autorun_proc.js"],function(){this.convertLead()}.bind(this))}.bind(this)}}),new BX.UI.Button({text:this.message["CRM_TYPE_CANCEL"],color:BX.UI.Button.Color.LINK,events:{click:function(){this.getContext().close()}}})],content:'<div id="crmLeadConverterWrapper" style="margin-bottom: 6px;"></div><div style="width:420px;">'+this.message["CRM_LEAD_CONVERT_TEXT"]+"</div>"}).show()},preparePopup:function(){BX.ajax({method:"POST",dataType:"json",url:"/bitrix/components/bitrix/crm.lead.list/list.ajax.php",data:{sessid:BX.bitrix_sessid(),ACTION:"CHECK_ACTIVE_LEAD"},onsuccess:BX.proxy((function(t){if(t.hasOwnProperty("EXIST_LEADS")){this.existActiveLeads=t.EXIST_LEADS=="Y"}this.showPopup()}),this)})},showPopup:function(){var t=[];if(this.isAdmin){t.push(new BX.PopupWindowButton({text:this.message["CRM_TYPE_SAVE"],className:"popup-window-button-create",events:{click:BX.proxy((function(){BX.addClass(BX.proxy_context.buttonNode,"popup-window-button-wait");if(this.currentCrmType=="simple"&&this.existActiveLeads){this.confirmLeadConvert();BX.removeClass(BX.proxy_context.buttonNode,"popup-window-button-wait")}else{this.sendAjax()}}),this)}}))}if(this.isLeadEnabled||window.location.toString().indexOf("deal")!==-1){t.push(new BX.PopupWindowButtonLink({text:this.message["CRM_TYPE_CANCEL"],events:{click:function(){this.popupWindow.close()}}}))}else{t.push(new BX.PopupWindowButtonLink({text:this.message["CRM_TYPE_CANCEL"],events:{click:function(){history.back()}}}))}BX.PopupWindowManager.create("leadFirstPopup",null,{closeIcon:this.isLeadEnabled?true:false,lightShadow:true,overlay:true,titleBar:this.message["CRM_TYPE_TITLE"],buttons:t,content:'<div style="width:600px;height:550px; background: url(/bitrix/js/crm/images/waiter-white-64px.gif) no-repeat center;"></div>',events:{onPopupClose:BX.proxy((function(){BX.ajax({url:this.ajaxPath,method:"POST",dataType:"json",data:{sessid:BX.bitrix_sessid(),action:"popupClose"},onsuccess:function(t){},onfailure:function(){}})}),this),onAfterPopupShow:BX.proxy((function(){var t=BX.proxy_context;BX.ajax.post("/bitrix/tools/crm_lead_mode.php",{},BX.proxy((function(e){t.setContent(e);this.containerNode=BX("leadFirstPopupHtml");if(BX.type.isDomNode(this.containerNode)){this.typeBlocks=this.containerNode.getElementsByClassName("js-bx-lead-type-block");if(this.typeBlocks){for(var i=0,n=this.typeBlocks.length;i<n;i++){BX.bind(this.typeBlocks[i],"click",BX.proxy((function(){this.self.changeCrmType(this.element)}),{element:this.typeBlocks[i],self:this}))}}var r=this.containerNode.getElementsByClassName("js-bx-converter-config");if(r){BX.bind(r[0],"click",this.showConverterConfig.bind(this))}}}),this))}),this)}}).show()},showConverterConfig:function(t){t.preventDefault();BX.SidePanel.Instance.open("/bitrix/components/bitrix/crm.lead.mode/converter.php?site_id="+BX.message("SITE_ID"))}}}BX.ready((function(){BX.Crm.Page.initialize()}));if(typeof cssQuery!=="function"){eval(function(t,e,i,n,r,s){r=function(t){return(t<e?"":r(parseInt(t/e)))+((t=t%e)>35?String.fromCharCode(t+29):t.toString(36))};if(!"".replace(/^/,String)){while(i--)s[r(i)]=n[i]||r(i);n=[function(t){return s[t]}];r=function(){return"\\w+"};i=1}while(i--)if(n[i])t=t.replace(new RegExp("\\b"+r(i)+"\\b","g"),n[i]);return t}('7 x=6(){7 1D="2.0.2";7 C=/\\s*,\\s*/;7 x=6(s,A){33{7 m=[];7 u=1z.32.2c&&!A;7 b=(A)?(A.31==22)?A:[A]:[1g];7 1E=18(s).1l(C),i;9(i=0;i<1E.y;i++){s=1y(1E[i]);8(U&&s.Z(0,3).2b("")==" *#"){s=s.Z(2);A=24([],b,s[1])}1A A=b;7 j=0,t,f,a,c="";H(j<s.y){t=s[j++];f=s[j++];c+=t+f;a="";8(s[j]=="("){H(s[j++]!=")")a+=s[j];a=a.Z(0,-1);c+="("+a+")"}A=(u&&V[c])?V[c]:21(A,t,f,a);8(u)V[c]=A}m=m.30(A)}2a x.2d;5 m}2Z(e){x.2d=e;5[]}};x.1Z=6(){5"6 x() {\\n  [1D "+1D+"]\\n}"};7 V={};x.2c=L;x.2Y=6(s){8(s){s=1y(s).2b("");2a V[s]}1A V={}};7 29={};7 19=L;x.15=6(n,s){8(19)1i("s="+1U(s));29[n]=12 s()};x.2X=6(c){5 c?1i(c):o};7 D={};7 h={};7 q={P:/\\[([\\w-]+(\\|[\\w-]+)?)\\s*(\\W?=)?\\s*([^\\]]*)\\]/};7 T=[];D[" "]=6(r,f,t,n){7 e,i,j;9(i=0;i<f.y;i++){7 s=X(f[i],t,n);9(j=0;(e=s[j]);j++){8(M(e)&&14(e,n))r.z(e)}}};D["#"]=6(r,f,i){7 e,j;9(j=0;(e=f[j]);j++)8(e.B==i)r.z(e)};D["."]=6(r,f,c){c=12 1t("(^|\\\\s)"+c+"(\\\\s|$)");7 e,i;9(i=0;(e=f[i]);i++)8(c.l(e.1V))r.z(e)};D[":"]=6(r,f,p,a){7 t=h[p],e,i;8(t)9(i=0;(e=f[i]);i++)8(t(e,a))r.z(e)};h["2W"]=6(e){7 d=Q(e);8(d.1C)9(7 i=0;i<d.1C.y;i++){8(d.1C[i]==e)5 K}};h["2V"]=6(e){};7 M=6(e){5(e&&e.1c==1&&e.1f!="!")?e:23};7 16=6(e){H(e&&(e=e.2U)&&!M(e))28;5 e};7 G=6(e){H(e&&(e=e.2T)&&!M(e))28;5 e};7 1r=6(e){5 M(e.27)||G(e.27)};7 1P=6(e){5 M(e.26)||16(e.26)};7 1o=6(e){7 c=[];e=1r(e);H(e){c.z(e);e=G(e)}5 c};7 U=K;7 1h=6(e){7 d=Q(e);5(2S d.25=="2R")?/\\.1J$/i.l(d.2Q):2P(d.25=="2O 2N")};7 Q=6(e){5 e.2M||e.1g};7 X=6(e,t){5(t=="*"&&e.1B)?e.1B:e.X(t)};7 17=6(e,t,n){8(t=="*")5 M(e);8(!14(e,n))5 L;8(!1h(e))t=t.2L();5 e.1f==t};7 14=6(e,n){5!n||(n=="*")||(e.2K==n)};7 1e=6(e){5 e.1G};6 24(r,f,B){7 m,i,j;9(i=0;i<f.y;i++){8(m=f[i].1B.2J(B)){8(m.B==B)r.z(m);1A 8(m.y!=23){9(j=0;j<m.y;j++){8(m[j].B==B)r.z(m[j])}}}}5 r};8(![].z)22.2I.z=6(){9(7 i=0;i<1z.y;i++){o[o.y]=1z[i]}5 o.y};7 N=/\\|/;6 21(A,t,f,a){8(N.l(f)){f=f.1l(N);a=f[0];f=f[1]}7 r=[];8(D[t]){D[t](r,A,f,a)}5 r};7 S=/^[^\\s>+~]/;7 20=/[\\s#.:>+~()@]|[^\\s#.:>+~()@]+/g;6 1y(s){8(S.l(s))s=" "+s;5 s.P(20)||[]};7 W=/\\s*([\\s>+~(),]|^|$)\\s*/g;7 I=/([\\s>+~,]|[^(]\\+|^)([#.:@])/g;7 18=6(s){5 s.O(W,"$1").O(I,"$1*$2")};7 1u={1Z:6(){5"\'"},P:/^(\'[^\']*\')|("[^"]*")$/,l:6(s){5 o.P.l(s)},1S:6(s){5 o.l(s)?s:o+s+o},1Y:6(s){5 o.l(s)?s.Z(1,-1):s}};7 1s=6(t){5 1u.1Y(t)};7 E=/([\\/()[\\]?{}|*+-])/g;6 R(s){5 s.O(E,"\\\\$1")};x.15("1j-2H",6(){D[">"]=6(r,f,t,n){7 e,i,j;9(i=0;i<f.y;i++){7 s=1o(f[i]);9(j=0;(e=s[j]);j++)8(17(e,t,n))r.z(e)}};D["+"]=6(r,f,t,n){9(7 i=0;i<f.y;i++){7 e=G(f[i]);8(e&&17(e,t,n))r.z(e)}};D["@"]=6(r,f,a){7 t=T[a].l;7 e,i;9(i=0;(e=f[i]);i++)8(t(e))r.z(e)};h["2G-10"]=6(e){5!16(e)};h["1x"]=6(e,c){c=12 1t("^"+c,"i");H(e&&!e.13("1x"))e=e.1n;5 e&&c.l(e.13("1x"))};q.1X=/\\\\:/g;q.1w="@";q.J={};q.O=6(m,a,n,c,v){7 k=o.1w+m;8(!T[k]){a=o.1W(a,c||"",v||"");T[k]=a;T.z(a)}5 T[k].B};q.1Q=6(s){s=s.O(o.1X,"|");7 m;H(m=s.P(o.P)){7 r=o.O(m[0],m[1],m[2],m[3],m[4]);s=s.O(o.P,r)}5 s};q.1W=6(p,t,v){7 a={};a.B=o.1w+T.y;a.2F=p;t=o.J[t];t=t?t(o.13(p),1s(v)):L;a.l=12 2E("e","5 "+t);5 a};q.13=6(n){1d(n.2D()){F"B":5"e.B";F"2C":5"e.1V";F"9":5"e.2B";F"1T":8(U){5"1U((e.2A.P(/1T=\\\\1v?([^\\\\s\\\\1v]*)\\\\1v?/)||[])[1]||\'\')"}}5"e.13(\'"+n.O(N,":")+"\')"};q.J[""]=6(a){5 a};q.J["="]=6(a,v){5 a+"=="+1u.1S(v)};q.J["~="]=6(a,v){5"/(^| )"+R(v)+"( |$)/.l("+a+")"};q.J["|="]=6(a,v){5"/^"+R(v)+"(-|$)/.l("+a+")"};7 1R=18;18=6(s){5 1R(q.1Q(s))}});x.15("1j-2z",6(){D["~"]=6(r,f,t,n){7 e,i;9(i=0;(e=f[i]);i++){H(e=G(e)){8(17(e,t,n))r.z(e)}}};h["2y"]=6(e,t){t=12 1t(R(1s(t)));5 t.l(1e(e))};h["2x"]=6(e){5 e==Q(e).1H};h["2w"]=6(e){7 n,i;9(i=0;(n=e.1F[i]);i++){8(M(n)||n.1c==3)5 L}5 K};h["1N-10"]=6(e){5!G(e)};h["2v-10"]=6(e){e=e.1n;5 1r(e)==1P(e)};h["2u"]=6(e,s){7 n=x(s,Q(e));9(7 i=0;i<n.y;i++){8(n[i]==e)5 L}5 K};h["1O-10"]=6(e,a){5 1p(e,a,16)};h["1O-1N-10"]=6(e,a){5 1p(e,a,G)};h["2t"]=6(e){5 e.B==2s.2r.Z(1)};h["1M"]=6(e){5 e.1M};h["2q"]=6(e){5 e.1q===L};h["1q"]=6(e){5 e.1q};h["1L"]=6(e){5 e.1L};q.J["^="]=6(a,v){5"/^"+R(v)+"/.l("+a+")"};q.J["$="]=6(a,v){5"/"+R(v)+"$/.l("+a+")"};q.J["*="]=6(a,v){5"/"+R(v)+"/.l("+a+")"};6 1p(e,a,t){1d(a){F"n":5 K;F"2p":a="2n";1a;F"2o":a="2n+1"}7 1m=1o(e.1n);6 1k(i){7 i=(t==G)?1m.y-i:i-1;5 1m[i]==e};8(!Y(a))5 1k(a);a=a.1l("n");7 m=1K(a[0]);7 s=1K(a[1]);8((Y(m)||m==1)&&s==0)5 K;8(m==0&&!Y(s))5 1k(s);8(Y(s))s=0;7 c=1;H(e=t(e))c++;8(Y(m)||m==1)5(t==G)?(c<=s):(s>=c);5(c%m)==s}});x.15("1j-2m",6(){U=1i("L;/*@2l@8(@\\2k)U=K@2j@*/");8(!U){X=6(e,t,n){5 n?e.2i("*",t):e.X(t)};14=6(e,n){5!n||(n=="*")||(e.2h==n)};1h=1g.1I?6(e){5/1J/i.l(Q(e).1I)}:6(e){5 Q(e).1H.1f!="2g"};1e=6(e){5 e.2f||e.1G||1b(e)};6 1b(e){7 t="",n,i;9(i=0;(n=e.1F[i]);i++){1d(n.1c){F 11:F 1:t+=1b(n);1a;F 3:t+=n.2e;1a}}5 t}}});19=K;5 x}();',62,190,"|||||return|function|var|if|for||||||||pseudoClasses||||test|||this||AttributeSelector|||||||cssQuery|length|push|fr|id||selectors||case|nextElementSibling|while||tests|true|false|thisElement||replace|match|getDocument|regEscape||attributeSelectors|isMSIE|cache||getElementsByTagName|isNaN|slice|child||new|getAttribute|compareNamespace|addModule|previousElementSibling|compareTagName|parseSelector|loaded|break|_0|nodeType|switch|getTextContent|tagName|document|isXML|eval|css|_1|split|ch|parentNode|childElements|nthChild|disabled|firstElementChild|getText|RegExp|Quote|x22|PREFIX|lang|_2|arguments|else|all|links|version|se|childNodes|innerText|documentElement|contentType|xml|parseInt|indeterminate|checked|last|nth|lastElementChild|parse|_3|add|href|String|className|create|NS_IE|remove|toString|ST|select|Array|null|_4|mimeType|lastChild|firstChild|continue|modules|delete|join|caching|error|nodeValue|textContent|HTML|prefix|getElementsByTagNameNS|end|x5fwin32|cc_on|standard||odd|even|enabled|hash|location|target|not|only|empty|root|contains|level3|outerHTML|htmlFor|class|toLowerCase|Function|name|first|level2|prototype|item|scopeName|toUpperCase|ownerDocument|Document|XML|Boolean|URL|unknown|typeof|nextSibling|previousSibling|visited|link|valueOf|clearCache|catch|concat|constructor|callee|try".split("|"),0,{}))}
//# sourceMappingURL=common.map.js