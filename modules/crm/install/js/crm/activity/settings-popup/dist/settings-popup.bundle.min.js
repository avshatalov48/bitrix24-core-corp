this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(t,e,i,s,n,a,o,r,l,c,d,u){"use strict";const h={props:{id:{type:String,required:true},toggleTitle:{type:String,default:""},toggleEnabled:{type:Boolean,default:true},toggleVisible:{type:Boolean,default:true}},watch:{enabled(){this.$emit("onToggle",{id:this.id,isActive:this.enabled})}},data(){return{enabled:this.toggleEnabled}},template:`\n\t\t<section>\n\t\t\t<div class="ui-form-row" v-if="toggleVisible">\n\t\t\t\t<label for class="ui-ctl ui-ctl-checkbox" @click="enabled = !enabled">\n\t\t\t\t\t<input type="checkbox" class="ui-ctl-element" v-model="enabled">\n\t\t\t\t\t<div class="ui-ctl-label-text">{{ toggleTitle }}</div>\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t\t<div class="ui-form-row" v-else>\n\t\t\t\t<label>\n\t\t\t\t\t<div class="ui-ctl-label-text">{{ toggleTitle }}</div>\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t\t<slot v-if="enabled"></slot>\n\t\t</section>\n\t`};const m={props:{id:String,active:Boolean,title:String},methods:{onClick:function(){this.$emit("onClick",this.id)}},template:`\n\t\t<button @click="onClick" :class="['ui-btn ui-btn-secondary ui-btn-md ui-btn-no-caps', { active }]">\n\t\t\t{{this.title}}\n\t\t</button>\n\t`};const p={today:{id:"today",days:0},tomorrow:{id:"tomorrow",days:1},after2days:{id:"after2days",days:2},after3days:{id:"after3days",days:3}};const g={minute:{id:"minute",seconds:60},hour:{id:"hour",seconds:60*60},day:{id:"day",seconds:60*60*24}};const v={components:{RecallButton:m},props:{params:{type:Object,default:{}}},data(){const t=this.params.from||o.Factory.getUserNow().getTime()/1e3;const e=Math.round(t/60)*60;let i=1;let s=g.hour.id;if(this.params.duration){s=this.getPeriodIdBySeconds(this.params.duration);i=this.params.duration/g[s].seconds}const n=e+i*g[s].seconds;return{id:this.getId(),from:e,to:n,duration:i,durationPeriodId:s,timeFromClockInstance:null,timeToClockInstance:null,plannerInstance:null}},computed:{DurationPeriods:()=>g,Recall:()=>p,fromDateFormatted:{get(){return n.Date.format(BX.Crm.DateTime.Dictionary.Format.SHORT_DATE_FORMAT,this.from)},set(t){const e=n.Date.parse(t);const i=this.createDateInstance(this.from);e.setHours(i.getHours(),i.getMinutes(),0,0);this.from=e.getTime()/1e3;this.to=this.from+this.duration}},fromTimeFormatted:{get(){return this.getFormattedTime("from")},set(t){const e=this.getDateInstanceWithTime(this.from,t);this.from=e.getTime()/1e3;this.timeFromClockInstance.closeWnd()}},toDateFormatted:{get(){const t=this.from+this.duration*g[this.durationPeriodId].seconds;return n.Date.format(BX.Crm.DateTime.Dictionary.Format.SHORT_DATE_FORMAT,t)},set(t){const e=n.Date.parse(t);const i=this.from+this.duration*g[this.durationPeriodId].seconds;const s=o.Factory.createFromTimestampInUserTimezone(i);e.setHours(s.getHours(),s.getMinutes(),0,0);this.calcDuration(e)}},toTimeFormatted:{get(){const t=this.from+this.duration*g[this.durationPeriodId].seconds;return n.Date.format(BX.Crm.DateTime.Dictionary.Format.SHORT_TIME_FORMAT,t)},set(t){const e=this.getDateInstanceWithTime(this.to,t);this.calcDuration(e);this.timeToClockInstance.closeWnd()}},activeRecallId(){const t=(t,e)=>t.getTime()===e.getTime();const e=this.createDateInstance(this.from,true);const i=this.createDateInstance(null,true);if(t(e,i)){return p.today.id}const s=t=>t.setDate(t.getDate()+1);s(i);if(t(e,i)){return p.tomorrow.id}s(i);if(t(e,i)){return p.after2days.id}s(i);if(t(e,i)){return p.after3days.id}return null}},mounted(){this.plannerInstance=new a.Planner({wrap:this.$refs.plannerContainer,compactMode:true,minWidth:770,minHeight:104,height:104,width:770});this.plannerInstance.subscribe("onDateChange",this.handlePlannerSelectorChanges.bind(this));this.plannerInstance.show();this.getAccessibilityForUsers();this.onDataUpdate()},unmounted(){this.emitSettingsChange(false)},watch:{duration(){this.onDataUpdate()},durationPeriodId(){this.onDataUpdate()},from(){this.onDataUpdate()},to(){this.onDataUpdate()}},methods:{getId(){return"calendar"},getDateInstanceWithTime(t,e){const i=e.split(":");const s=o.Factory.createFromTimestampInUserTimezone(t);let n=Number(i[0]);let a=i[1];const r=a.includes("am")||a.includes("pm");if(r){if(a.includes("pm")&&n!==12){n+=12}a=parseInt(a,10)}s.setHours(n,a,0,0);return s},calcDuration(t){const e=t.getTime()/1e3-this.from;if(e%g[this.durationPeriodId].seconds===0){this.duration=e/g[this.durationPeriodId].seconds}else{this.duration=e/g.minute.seconds;this.durationPeriodId=g.minute.id}},getPeriodIdBySeconds(t){if(t%g.day.seconds===0){return g.day.id}if(t%g.hour.seconds===0){return g.hour.id}return g.minute.id},handlePlannerSelectorChanges({data:{dateFrom:t,dateTo:e}}){this.from=t.getTime()/1e3;this.calcDuration(e)},onDataUpdate(){this.updatePlanner();this.emitSettingsChange()},updatePlanner(){const t=this.createDateInstance(this.from);const e=this.getDurationSeconds();const i=this.createDateInstance(this.from+e);this.plannerInstance.updateSelector(t,i)},emitSettingsChange(t=true){const e=this.exportParams(t);if(t&&this.validateParams(e)||!t){this.$Bitrix.eventEmitter.emit(c.Events.EVENT_SETTINGS_CHANGE,e)}else{this.$Bitrix.eventEmitter.emit(c.Events.EVENT_SETTINGS_VALIDATION,{isValid:false})}},getDurationSeconds(){return this.duration*g[this.durationPeriodId].seconds},getFormattedDate(t){return this.getFormattedValue(t,BX.Crm.DateTime.Dictionary.Format.SHORT_DATE_FORMAT)},getFormattedTime(t){return this.getFormattedValue(t,BX.Crm.DateTime.Dictionary.Format.SHORT_TIME_FORMAT)},getFormattedValue(t,e){const i=t==="from"?this.from:this.to;return n.Date.format(e,i)},getSecondsFromStartOfDay(t){const e=this.createDateInstance(t,true);return t-e.getTime()/1e3},getDurationPeriodTitle(t){const e=`CRM_SETTINGS_POPUP_CALENDAR_DURATION_${t.toUpperCase()}S`;return this.$Bitrix.Loc.getMessage(e)},onDateFromClick(){BX.calendar({node:this.$refs.dateFrom,field:this.$refs.dateFrom,bTime:false})},onDateFromChange(t){this.fromDateFormatted=t.target.value},onDateToChange(t){this.toDateFormatted=t.target.value},onDateToClick(){BX.calendar({node:this.$refs.dateTo,field:this.$refs.dateTo,bTime:false})},onTimeFromClick(){this.showClockSelector("timeFromClockInstance",this.from,this.$refs.timeFrom,"fromTimeFormatted")},onTimeToClick(){this.showClockSelector("timeToClockInstance",this.to,this.$refs.timeTo,"toTimeFormatted")},showClockSelector(t,e,i,s){if(!this[t]){this[t]=new BX.CClockSelector({start_time:this.getSecondsFromStartOfDay(e),node:i,callback:t=>{this[s]=t}})}this[t].Show()},onDurationKeyUp(){this.duration=this.duration.replace(/\D/g,"")},onRecallClick(t){const e=this.createDateInstance(this.from);const i=this.createDateInstance(null,true);i.setHours(e.getHours(),e.getMinutes());this.from=i.setDate(i.getDate()+p[t].days)/1e3;const s=this.duration*g[this.durationPeriodId].seconds;this.to=this.from+s},createDateInstance(t=null,e=false){if(!t){t=Date.now()/1e3}const i=new Date(t*1e3);if(e){i.setHours(0,0,0,0)}return i},isActiveRecall(t){return t===this.activeRecallId},exportParams(t=true){const e=this.from;const i=this.duration*g[this.durationPeriodId].seconds;const s=this.from+i;return{id:this.id,from:e,duration:i,to:s,active:t,fromText:n.DateTimeFormat.format(l.DatetimeConverter.getSiteDateTimeFormat(),e),toText:n.DateTimeFormat.format(l.DatetimeConverter.getSiteDateTimeFormat(),s)}},validateParams(t){if(t.duration<0){this.$refs.durationRegion.classList.add("ui-ctl-danger");return false}this.$refs.durationRegion.classList.remove("ui-ctl-danger");return true},getAccessibilityForUsers(){const t=12*24*3600;r.ajax.runAction("crm.activity.settings.calendar.getAccessibilityForUsers",{data:{from:this.from-t,to:this.from+t}}).then((({data:t})=>this.plannerInstance.update(t.entries,t.accessibility)))},updateSettings(t){if(!t||!t.deadline){return}this.from=t.deadline.getTime()/1e3}},template:`\n\t\t<div class="ui-form">\n\t\t\t<div class="ui-form-row-inline">\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-label">\n                \t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage('CRM_SETTINGS_POPUP_CALENDAR_FROM_DATETIME') }}\n\t\t\t\t\t\t</div>\n            \t\t</div>\n            \t\t<div class="ui-form-content">\n\t\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-date">\n\t\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-calendar"></div>\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tref="dateFrom"\n\t\t\t\t\t\t\t\ttype="text"\n\t\t\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t\t\t@click="onDateFromClick"\n\t\t\t\t\t\t\t\t@change="onDateFromChange"\n\t\t\t\t\t\t\t\treadonly\n\t\t\t\t\t\t\t\tv-model="fromDateFormatted"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-time">\n    \t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-clock"></div>\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tref="timeFrom"\n\t\t\t\t\t\t\t\ttype="text"\n\t\t\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t\t\t@click="onTimeFromClick"\n\t\t\t\t\t\t\t\treadonly\n\t\t\t\t\t\t\t\tv-model="fromTimeFormatted"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-label">\n                \t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage('CRM_SETTINGS_POPUP_CALENDAR_DURATION') }}\n\t\t\t\t\t\t</div>\n            \t\t</div>\n            \t\t<div class="ui-form-content">\n\t\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-date" ref="durationRegion">\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tref="durationValue"\n\t\t\t\t\t\t\t\ttype="text" \n\t\t\t\t\t\t\t\tv-model="duration"\n\t\t\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t\t\t@keyup="onDurationKeyUp"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown">\n    \t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t\t<select\n\t\t\t\t\t\t\t\tref="durationPeriod"\n\t\t\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t\t\tv-model="durationPeriodId"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<option\n\t\t\t\t\t\t\t\t\tv-for="duration in DurationPeriods"\n\t\t\t\t\t\t\t\t\tkey="id"\n\t\t\t\t\t\t\t\t\t:selected="duration.id === durationPeriodId"\n\t\t\t\t\t\t\t\t\t:value="duration.id"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t{{ getDurationPeriodTitle(duration.id) }}\n\t\t\t\t\t\t\t\t</option>\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-label">\n                \t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage('CRM_SETTINGS_POPUP_CALENDAR_TO_DATETIME') }}\n\t\t\t\t\t\t</div>\n            \t\t</div>\n            \t\t<div class="ui-form-content">\n\t\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-date">\n\t\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-calendar"></div>\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tref="dateTo"\n\t\t\t\t\t\t\t\ttype="text"\n\t\t\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t\t\t@click="onDateToClick"\n\t\t\t\t\t\t\t\t@change="onDateToChange"\n\t\t\t\t\t\t\t\treadonly\n\t\t\t\t\t\t\t\tv-model="toDateFormatted"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-time">\n    \t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-clock"></div>\n\t\t\t\t\t\t\t<input\n\t\t\t\t\t\t\t\tref="timeTo"\n\t\t\t\t\t\t\t\ttype="text"\n\t\t\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\t\t\t@click="onTimeToClick"\n\t\t\t\t\t\t\t\treadonly\n\t\t\t\t\t\t\t\tv-model="toTimeFormatted"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="ui-form-row-inline crm-activity__settings_popup__calendar__recall-container">\n\t\t\t\t<RecallButton\n\t\t\t\t\t:id=Recall.today.id\n\t\t\t\t\t:active=isActiveRecall(Recall.today.id)\n\t\t\t\t\t@onClick="this.onRecallClick"\n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('CRM_SETTINGS_POPUP_CALENDAR_RECALL_TODAY')"\n\t\t\t\t/>\n\t\t\t\t<RecallButton\n\t\t\t\t\t:id=Recall.tomorrow.id\n\t\t\t\t\t:active=isActiveRecall(Recall.tomorrow.id)\n\t\t\t\t\t@onClick="this.onRecallClick"\n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('CRM_SETTINGS_POPUP_CALENDAR_RECALL_TOMORROW')"\n\t\t\t\t/>\n\t\t\t\t<RecallButton\n\t\t\t\t\t:id=Recall.after2days.id\n\t\t\t\t\t:active=isActiveRecall(Recall.after2days.id)\n\t\t\t\t\t@onClick="this.onRecallClick"\n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('CRM_SETTINGS_POPUP_CALENDAR_RECALL_AFTER_2_DAYS')"\n\t\t\t\t/>\n\t\t\t\t<RecallButton\n\t\t\t\t\t:id=Recall.after3days.id\n\t\t\t\t\t:active=isActiveRecall(Recall.after3days.id)\n\t\t\t\t\t@onClick="this.onRecallClick"\n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('CRM_SETTINGS_POPUP_CALENDAR_RECALL_AFTER_3_DAYS')"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div ref="plannerContainer" class="crm-activity__settings_popup__calendar__planner-container"></div>\n\t\t</div>\n\t`};const b={props:{params:{type:Object,default:{}}},data(){const t=this.params.selectedItems||[];return{id:this.getId(),selectedItems:t}},mounted(){const t=[];this.selectedItems.forEach((e=>t.push(["timeline_ping",e])));this.pingSelector=new d.TagSelector({textBoxWidth:"100%",dialogOptions:{height:330,dropdownMode:true,showAvatars:false,enableSearch:false,preselectedItems:t,entities:[{id:"timeline_ping"}],events:{"Item:onSelect":()=>{this.onChangeSelectorData()},"Item:onDeselect":()=>{this.onChangeSelectorData()}}}});this.pingSelector.renderTo(this.$refs.pingSel);this.emitSettingsChange()},unmounted(){this.emitSettingsChange(false)},watch:{selectedItems(){this.emitSettingsChange()}},methods:{getId(){return"ping"},onChangeSelectorData(){if(this.pingSelector){this.selectedItems=this.pingSelector.getDialog().getSelectedItems().map((t=>t.id))}},emitSettingsChange(t=true){this.$Bitrix.eventEmitter.emit(c.Events.EVENT_SETTINGS_CHANGE,this.exportParams(t))},exportParams(t=true){this.pingSelector.getDialog().getSelectedItems().map((t=>t.id));return{id:this.id,selectedItems:this.selectedItems,active:t}},updateSettings(t){}},template:`\n\t\t<div class="ui-form">\n\t\t\t<div ref="pingSel" class="crm-activity__settings_popup__ping-selector-container"></div>\n\t\t</div>\n\t`};const f={components:{WrapperSection:h,SettingsPopupCalendar:v,SettingsPopupPing:b},props:{onSettingsChangeCallback:{type:Function,required:true},onSettingsValidationCallback:{type:Function},sections:{type:Array,required:true}},data(){return{settings:new Map}},computed:{activeSettingsIds(){const t={};this.sections.forEach((e=>{t[e.id]=Boolean(e.active)}));return t}},methods:{getSectionTitle(t){t=t.toUpperCase();const e="CRM_SETTINGS_POPUP_SECTION_SWITCH";const i=`${e}_${t}`;return this.$Bitrix.Loc.getMessage(i)||this.$Bitrix.Loc.getMessage(e)},getSectionToggle(t){if(r.Type.isBoolean(t)){return t}return true},prepareSettings(){for(const t in this.activeSettingsIds){if(!this.activeSettingsIds[t]){continue}const e=this.sections.find((e=>e.id===t));if(!e){continue}const i={id:e.id,...e.params};this.settings.set(t,i)}},onSettingsChange({data:t}){if(t.id){if(t.active){this.settings.set(t.id,t)}else{this.settings.delete(t.id)}}if(this.onSettingsChangeCallback){this.onSettingsChangeCallback(this.exportParams())}},onSettingsValidation({data:t}){if(this.onSettingsChangeCallback){this.onSettingsValidationCallback(t)}},exportParams(){const t=Object.fromEntries(this.settings);let e={};for(const i in this.activeSettingsIds){if(this.activeSettingsIds[i]&&t[i]){e[i]=t[i]}}return e},onToggleSettingsSection({id:t,isActive:e}){if(this.activeSettingsIds.hasOwnProperty(t)){this.activeSettingsIds[t]=e}},updateSettings(t){this.sections.forEach((e=>{if(this.$refs["section-"+e.id]&&this.$refs["section-"+e.id][0]){this.$refs["section-"+e.id][0].updateSettings(t)}}))}},mounted(){this.prepareSettings();this.$Bitrix.eventEmitter.subscribe(c.Events.EVENT_SETTINGS_CHANGE,this.onSettingsChange);this.$Bitrix.eventEmitter.subscribe(c.Events.EVENT_SETTINGS_VALIDATION,this.onSettingsValidation)},beforeUnmount(){this.$Bitrix.eventEmitter.unsubscribe(c.Events.EVENT_SETTINGS_CHANGE,this.onSettingsChange);this.$Bitrix.eventEmitter.unsubscribe(c.Events.EVENT_SETTINGS_VALIDATION,this.onSettingsValidation)},template:`\n\t\t<div class="crm-activity__settings-popup_body">\n\t\t\t<WrapperSection\n\t\t\t\tv-for="section in sections"\n\t\t\t\t:id="section.id"\n\t\t\t\t:toggle-title="getSectionTitle(section.id)"\n\t\t\t\t:toggle-enabled="activeSettingsIds[section.id]"\n\t\t\t\t:toggle-visible="getSectionToggle(section.showToggleSelector)"\n\t\t\t\t@onToggle="onToggleSettingsSection"\n\t\t\t>\n\t\t\t\t<component \n\t\t\t\t\tv-bind:is="section.component"\n\t\t\t\t\t:params="section.params || {}"\n\t\t\t\t\t:ref="'section-' + section.id"\n\t\t\t\t></component>\n\t\t\t</WrapperSection>\n\t\t</div>\n\t`};let T=t=>t,S;const P="save";const y="cancel";const C={EVENT_SETTINGS_CHANGE:"crm:settings-popup:settings-change",EVENT_SETTINGS_VALIDATION:"crm:settings-popup:settings-validation"};var _=babelHelpers.classPrivateFieldLooseKey("onSettingsChange");var F=babelHelpers.classPrivateFieldLooseKey("onSave");var I=babelHelpers.classPrivateFieldLooseKey("settingsSections");var D=babelHelpers.classPrivateFieldLooseKey("fetchSettingsPath");var B=babelHelpers.classPrivateFieldLooseKey("ownerTypeId");var E=babelHelpers.classPrivateFieldLooseKey("ownerId");var L=babelHelpers.classPrivateFieldLooseKey("id");var H=babelHelpers.classPrivateFieldLooseKey("currentSettings");var A=babelHelpers.classPrivateFieldLooseKey("onSettingsValidation");var R=babelHelpers.classPrivateFieldLooseKey("getPopupContent");var O=babelHelpers.classPrivateFieldLooseKey("getPopupTitle");var w=babelHelpers.classPrivateFieldLooseKey("getPopupButtons");var N=babelHelpers.classPrivateFieldLooseKey("cancel");var k=babelHelpers.classPrivateFieldLooseKey("initLayoutComponent");var x=babelHelpers.classPrivateFieldLooseKey("adjustPopup");var M=babelHelpers.classPrivateFieldLooseKey("closePopup");class ${constructor(t){Object.defineProperty(this,M,{value:q});Object.defineProperty(this,x,{value:W});Object.defineProperty(this,k,{value:K});Object.defineProperty(this,N,{value:j});Object.defineProperty(this,w,{value:X});Object.defineProperty(this,O,{value:G});Object.defineProperty(this,R,{value:V});Object.defineProperty(this,A,{value:U});this.container=null;this.layoutApp=null;this.layoutComponent=null;this.popup=null;Object.defineProperty(this,_,{writable:true,value:null});Object.defineProperty(this,F,{writable:true,value:null});Object.defineProperty(this,I,{writable:true,value:[]});Object.defineProperty(this,D,{writable:true,value:null});Object.defineProperty(this,B,{writable:true,value:null});Object.defineProperty(this,E,{writable:true,value:null});Object.defineProperty(this,L,{writable:true,value:null});Object.defineProperty(this,H,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,I)[I]=t.sections||[];babelHelpers.classPrivateFieldLooseBase(this,D)[D]=t.fetchSettingsPath||null;babelHelpers.classPrivateFieldLooseBase(this,B)[B]=t.ownerTypeId||null;babelHelpers.classPrivateFieldLooseBase(this,E)[E]=t.ownerId||null;babelHelpers.classPrivateFieldLooseBase(this,L)[L]=t.id||null;babelHelpers.classPrivateFieldLooseBase(this,_)[_]=t.onSettingsChange||null;babelHelpers.classPrivateFieldLooseBase(this,H)[H]=t.settings||null;if(t.onSave){babelHelpers.classPrivateFieldLooseBase(this,F)[F]=t.onSave}}show(){if(!this.popup||this.popup.isDestroyed()){const t=getComputedStyle(document.documentElement);const i=t.getPropertyValue("--ui-space-inset-sm");const n=parseFloat(i)||12;const a=t.getPropertyValue("--ui-color-base-solid")||"#000000";const o=r.Tag.render(S||(S=T`
				<div class="crm-activity__settings">
					<div class="crm-activity__settings_title">${0}</div>
					<div class="crm-activity__todo-settings_content"></div>
				</div>
			`),babelHelpers.classPrivateFieldLooseBase(this,O)[O]());this.popup=new e.Popup({closeIcon:true,closeByEsc:true,padding:n,overlay:{opacity:40,backgroundColor:a},content:o,buttons:babelHelpers.classPrivateFieldLooseBase(this,w)[w](),minWidth:850,width:850,className:"crm-activity__settings-popup"});this.popup.subscribeOnce("onFirstShow",(()=>{this.loadSettings().then((()=>{babelHelpers.classPrivateFieldLooseBase(this,R)[R]();this.popup.adjustPosition()}),(()=>{s.UI.Notification.Center.notify({content:r.Loc.getMessage("CRM_SETTINGS_POPUP_ERROR"),autoHideDelay:5e3})}))}));this.popup.subscribe("onClose",babelHelpers.classPrivateFieldLooseBase(this,k)[k].bind(this))}this.popup.show()}loadSettings(){if(!babelHelpers.classPrivateFieldLooseBase(this,D)[D]){return Promise.resolve()}const t={id:babelHelpers.classPrivateFieldLooseBase(this,L)[L],ownerTypeId:babelHelpers.classPrivateFieldLooseBase(this,B)[B],ownerId:babelHelpers.classPrivateFieldLooseBase(this,E)[E]};return new Promise(((e,i)=>{r.ajax.runAction(babelHelpers.classPrivateFieldLooseBase(this,D)[D],{data:t}).then((({data:t})=>{t.forEach((t=>{const e=babelHelpers.classPrivateFieldLooseBase(this,I)[I].find((e=>e.id===t.id));if(!e){return}e.active=t.active;e.params=t.settings}));e()})).catch(i)}))}save(){babelHelpers.classPrivateFieldLooseBase(this,H)[H]=this.getSettings();if(babelHelpers.classPrivateFieldLooseBase(this,_)[_]){babelHelpers.classPrivateFieldLooseBase(this,_)[_](this.getSettings())}babelHelpers.classPrivateFieldLooseBase(this,M)[M]();if(babelHelpers.classPrivateFieldLooseBase(this,F)[F]){babelHelpers.classPrivateFieldLooseBase(this,F)[F](babelHelpers.classPrivateFieldLooseBase(this,B)[B],babelHelpers.classPrivateFieldLooseBase(this,E)[E],babelHelpers.classPrivateFieldLooseBase(this,L)[L],this.getSettings())}}getSettings(){var t;return(t=this.layoutComponent)==null?void 0:t.exportParams()}syncSettings(t=null){if(t&&this.layoutComponent){this.layoutComponent.updateSettings(t)}}}function U(t){if(this.popup){this.popup.buttons[0].setDisabled(!t.isValid)}}function V(){this.container=this.popup.getContentContainer().getElementsByClassName("crm-activity__todo-settings_content").item(0);babelHelpers.classPrivateFieldLooseBase(this,k)[k]();return this.layoutComponent}function G(){return r.Loc.getMessage("CRM_SETTINGS_POPUP_TITLE")}function X(){return[new i.SaveButton({id:P,round:true,state:i.ButtonState.ACTIVE,events:{click:this.save.bind(this)}}),new i.CancelButton({id:y,round:true,events:{click:babelHelpers.classPrivateFieldLooseBase(this,N)[N].bind(this)},text:r.Loc.getMessage("CRM_SETTINGS_POPUP_CANCEL"),color:i.ButtonColor.LIGHT_BORDER})]}function j(){babelHelpers.classPrivateFieldLooseBase(this,M)[M]();babelHelpers.classPrivateFieldLooseBase(this,k)[k]()}function K(){if(this.layoutApp&&this.layoutComponent){this.layoutApp.unmount(this.container)}if(babelHelpers.classPrivateFieldLooseBase(this,H)[H]){babelHelpers.classPrivateFieldLooseBase(this,I)[I].forEach((t=>{if(babelHelpers.classPrivateFieldLooseBase(this,H)[H][t.id]){t.active=true;t.params=babelHelpers.classPrivateFieldLooseBase(this,H)[H][t.id]}}))}this.layoutApp=u.BitrixVue.createApp(f,{onSettingsChangeCallback:babelHelpers.classPrivateFieldLooseBase(this,x)[x].bind(this),onSettingsValidationCallback:babelHelpers.classPrivateFieldLooseBase(this,A)[A].bind(this),sections:babelHelpers.classPrivateFieldLooseBase(this,I)[I]});this.layoutComponent=this.layoutApp.mount(this.container)}function W(){this.popup.adjustPosition();this.popup.buttons[0].setDisabled(false)}function q(){var t;(t=this.popup)==null?void 0:t.close()}t.Calendar=v;t.Ping=b;t.SettingsPopup=$;t.Events=C})(this.BX.Crm.Activity=this.BX.Crm.Activity||{},BX.Main,BX.UI,BX,BX.Main,BX.Calendar,BX.Crm.DateTime,BX,BX.Crm.Timeline,BX.Crm.Activity,BX.Crm.EntitySelectorEx,BX.Vue3);
//# sourceMappingURL=settings-popup.bundle.map.js