{"version":3,"file":"file-uploader-popup.bundle.js","sources":["../src/file-uploader-popup.js"],"sourcesContent":["import { ajax as Ajax, Loc, Tag, Type } from 'main.core';\nimport { Popup } from 'main.popup';\nimport { Button, ButtonColor, ButtonState, CancelButton, SaveButton } from 'ui.buttons';\nimport { FileUploader as TodoEditorFileUploader } from 'crm.activity.file-uploader';\n\nimport type { FileUploaderPopupOptions } from './file-uploader-popup-options';\n\nimport 'ui.design-tokens';\nimport './file-uploader-popup.css';\n\nconst SAVE_BUTTON_ID = 'save';\nconst CANCEL_BUTTON_ID = 'cancel';\n\nexport class FileUploaderPopup\n{\n\t#entityTypeId: Number = null;\n\t#entityId: Number = null;\n\t#files: Array = [];\n\t#ownerTypeId: Number = null;\n\t#ownerId: Number = null;\n\n\t#popup: ?Popup = null;\n\t#fileUploader: ?TodoEditorFileUploader = null;\n\n\tconstructor(params: FileUploaderPopupOptions)\n\t{\n\t\tthis.#entityTypeId = params.entityTypeId;\n\t\tthis.#entityId = params.entityId;\n\t\tthis.#files = Type.isArrayFilled(params.files) ? params.files : [];\n\t\tthis.#ownerTypeId = params.ownerTypeId;\n\t\tthis.#ownerId = params.ownerId;\n\t}\n\n\tshow(): void\n\t{\n\t\tif (!this.#popup)\n\t\t{\n\t\t\tconst htmlStyles = getComputedStyle(document.documentElement);\n\t\t\tconst popupPadding = htmlStyles.getPropertyValue('--ui-space-inset-sm');\n\t\t\tconst popupPaddingNumberValue = parseFloat(popupPadding) || 12;\n\t\t\tconst popupOverlayColor = htmlStyles.getPropertyValue('--ui-color-base-solid') || '#000000';\n\n\t\t\tthis.#popup = new Popup({\n\t\t\t\tclassName: 'crm-activity__file-uploader-popup',\n\t\t\t\tcloseIcon: true,\n\t\t\t\tcloseByEsc: true,\n\t\t\t\tpadding: popupPaddingNumberValue,\n\t\t\t\toverlay: {\n\t\t\t\t\topacity: 40,\n\t\t\t\t\tbackgroundColor: popupOverlayColor,\n\t\t\t\t},\n\t\t\t\tcacheable: false,\n\t\t\t\tcontent: this.#getPopupContent(),\n\t\t\t\tbuttons: this.#getPopupButtons(),\n\t\t\t\tminWidth: 650,\n\t\t\t\twidth: 650,\n\t\t\t\tmaxHeight: 650\n\t\t\t});\n\t\t}\n\n\t\tthis.#popup.show();\n\t}\n\n\t#updateFiles(): void\n\t{\n\t\tthis.#popup?.getButton(SAVE_BUTTON_ID)?.setState(ButtonState.WAITING);\n\t\tthis.#popup?.getButton(CANCEL_BUTTON_ID)?.setState(ButtonState.DISABLED);\n\n\t\tAjax.runAction('crm.activity.todo.updateFiles', {\n\t\t\tdata: {\n\t\t\t\townerTypeId: this.#ownerTypeId,\n\t\t\t\townerId: this.#ownerId,\n\t\t\t\tid: this.#entityId,\n\t\t\t\tfileTokens: this.#fileUploader ? this.#fileUploader.getServerFileIds() : []\n\t\t\t}\n\t\t}).then((result) => {\n\t\t\t\tthis.#revertButtonsState();\n\n\t\t\t\tif (!(result.hasOwnProperty('errors') && result.errors.length))\n\t\t\t\t{\n\t\t\t\t\tthis.#closePopup();\n\t\t\t\t}\n\t\t\t}).catch(() => {\n\t\t\tthis.#revertButtonsState();\n\t\t});\n\t}\n\n\t#revertButtonsState()\n\t{\n\t\tthis.#popup?.getButton(SAVE_BUTTON_ID)?.setState(null);\n\t\tthis.#popup?.getButton(CANCEL_BUTTON_ID)?.setState(null);\n\t}\n\n\t#closePopup(): void\n\t{\n\t\tthis.#popup?.close();\n\t}\n\n\t#getPopupContent(): HTMLElement\n\t{\n\t\tconst uploaderContainer = Tag.render`<div></div>`;\n\n\t\tconst content = Tag.render`<div class=\"crm-activity__file-uploader\">\n\t\t\t<div class=\"crm-activity__file-uploader_title\">${this.#getPopupTitle()}</div>\n\t\t\t<div class=\"crm-activity__file-uploader_content\">\n\t\t\t\t${uploaderContainer}\n\t\t\t</div>\n\t\t</div>`;\n\n\t\tthis.#fileUploader = new TodoEditorFileUploader({\n\t\t\tevents: {\n\t\t\t\t'File:onComplete': (event) => {\n\t\t\t\t\tthis.#revertButtonsState();\n\t\t\t\t},\n\t\t\t\t'File:onRemove': (event) => {\n\t\t\t\t\tthis.#changeUploaderContainerSize();\n\t\t\t\t\tthis.#revertButtonsState();\n\t\t\t\t},\n\t\t\t\t'onUploadStart': (event) => {\n\t\t\t\t\tthis.#changeUploaderContainerSize();\n\t\t\t\t\tthis.#popup?.getButton(SAVE_BUTTON_ID)?.setState(ButtonState.DISABLED);\n\t\t\t\t\tthis.#popup?.getButton(CANCEL_BUTTON_ID)?.setState(ButtonState.DISABLED);\n\t\t\t\t},\n\t\t\t\t// TODO: not implemented yet\n\t\t\t\t//\t\t'onUploadComplete'\n\t\t\t},\n\t\t\townerId: this.#ownerId,\n\t\t\townerTypeId: this.#ownerTypeId,\n\t\t\tactivityId: this.#entityId,\n\t\t\tfiles: this.#files,\n\t\t});\n\t\tthis.#fileUploader.renderTo(uploaderContainer);\n\n\t\treturn content;\n\t}\n\n\t#getPopupTitle(): string\n\t{\n\t\treturn Loc.getMessage('CRM_FILE_UPLOADER_POPUP_TITLE_2');\n\t}\n\n\t#getPopupButtons(): Array<Button>\n\t{\n\t\treturn [\n\t\t\tnew SaveButton({\n\t\t\t\tid: SAVE_BUTTON_ID,\n\t\t\t\tround: true,\n\t\t\t\tstate: ButtonState.DISABLED,\n\t\t\t\tevents: {\n\t\t\t\t\tclick: this.#updateFiles.bind(this),\n\t\t\t\t},\n\t\t\t}),\n\t\t\tnew CancelButton({\n\t\t\t\tid: CANCEL_BUTTON_ID,\n\t\t\t\tround: true,\n\t\t\t\tevents: {\n\t\t\t\t\tclick: this.#closePopup.bind(this),\n\t\t\t\t},\n\t\t\t\ttext: Loc.getMessage('CRM_FILE_UPLOADER_POPUP_CANCEL'),\n\t\t\t\tcolor: ButtonColor.LIGHT_BORDER,\n\t\t\t}),\n\t\t]\n\t}\n\n\t#changeUploaderContainerSize(): void\n\t{\n\t\tif (this.#popup)\n\t\t{\n\t\t\tthis.#popup.adjustPosition();\n\t\t}\n\t}\n}\n"],"names":["SAVE_BUTTON_ID","CANCEL_BUTTON_ID","FileUploaderPopup","constructor","params","entityTypeId","entityId","Type","isArrayFilled","files","ownerTypeId","ownerId","show","htmlStyles","getComputedStyle","document","documentElement","popupPadding","getPropertyValue","popupPaddingNumberValue","parseFloat","popupOverlayColor","Popup","className","closeIcon","closeByEsc","padding","overlay","opacity","backgroundColor","cacheable","content","buttons","minWidth","width","maxHeight","getButton","setState","ButtonState","WAITING","DISABLED","Ajax","runAction","data","id","fileTokens","getServerFileIds","then","result","hasOwnProperty","errors","length","catch","close","uploaderContainer","Tag","render","TodoEditorFileUploader","events","event","activityId","renderTo","Loc","getMessage","SaveButton","round","state","click","bind","CancelButton","text","color","ButtonColor","LIGHT_BORDER","adjustPosition"],"mappings":"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"}