this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,i,s,a,l,r,n,o){"use strict";const d={props:{icon:{type:String,required:true,default:""},action:{type:Function,required:true,default:()=>{}},description:{type:String,required:false,default:""}},data(){return{popup:null}},computed:{iconClassname(){return["crm-activity__todo-editor_action-btn-icon",`--${this.icon}`]}},methods:{onMouseEnter(e){if(!this.description){return}this.popup=new s.Popup({content:this.description,bindElement:e.target,darkMode:true});setTimeout((()=>{if(!this.popup){return}this.popup.show()}),400)},onMouseLeave(){if(!this.popup||!this.description){return}this.popup.close();this.popup=null},onButtonClick(){this.action.call(this)}},template:`\n\t\t<button\n\t\t\t@mouseenter="onMouseEnter"\n\t\t\t@mouseleave="onMouseLeave"\n\t\t\t@click="onButtonClick"\n\t\t\tclass="crm-activity__todo-editor_action-btn"\n\t\t>\n\t\t\t<i :class="iconClassname"></i>\n\t\t</button>\n\t`};const c=126;const u={components:{TodoEditorActionBtn:d},props:{onFocus:Function,onChangeDescription:Function,onSaveHotkeyPressed:Function,deadline:Date,defaultDescription:{type:String,required:false,default:""},additionalButtons:Array,popupMode:Boolean},data(){var e;return{description:this.defaultDescription,currentDeadline:(e=this.deadline)!==null&&e!==void 0?e:new Date,showFileUploader:false,isTextareaToLong:false}},computed:{deadlineFormatted(){const e=new n.DatetimeConverter(this.currentDeadline);return e.toDatetimeString({withDayOfWeek:true,delimiter:", "})}},watch:{description(){a.Dom.style(this.$refs.textarea,"height","auto");void this.$nextTick((()=>{const e=this.$refs.textarea.scrollHeight;a.Dom.style(this.$refs.textarea,"height",`${e}px`);if(this.popupMode===true){this.isTextareaToLong=e>c}}))}},methods:{clearDescription(){this.description="";a.Dom.style(this.$refs.textarea,"height","auto")},setDescription(e){this.description=e},onTextareaFocus(){this.onFocus()},onTextareaKeydown(e){if(e.keyCode!==13){return}const t=a.Browser.isMac()&&(e.metaKey===true||e.altKey===true);if(e.ctrlKey===true||t){this.onSaveHotkeyPressed()}},setTextareaFocused(){this.$refs.textarea.focus()},onDeadlineClick(){BX.calendar({node:this.$refs.deadline,bTime:true,bHideTime:false,bSetFocus:false,value:r.DateTimeFormat.format(n.DatetimeConverter.getSiteDateTimeFormat(),this.currentDeadline),callback:this.setDeadline.bind(this)})},setDeadline(e){this.currentDeadline=e},getData(){return{description:this.description,deadline:this.currentDeadline}},onTextareaInput(e){this.setDescription(e.target.value);this.onChangeDescription(e.target.value)}},template:`\n\t\t<label class="crm-activity__todo-editor_body">\n\t\t\t<textarea\n\t\t\t\trows="1"\n\t\t\t\tref="textarea"\n\t\t\t\t@focus="onTextareaFocus"\n\t\t\t\t@keydown="onTextareaKeydown"\n\t\t\t\tclass="crm-activity__todo-editor_textarea"\n\t\t\t\t:placeholder="$Bitrix.Loc.getMessage('CRM_ACTIVITY_TODO_ADD_PLACEHOLDER')"\n\t\t\t\t@input="onTextareaInput"\n\t\t\t\t:value="description"\n\t\t\t\t:class="{ '--has-scroll': isTextareaToLong }"\n\t\t\t></textarea>\n\t\t\t<div class="crm-activity__todo-editor_tools">\n\t\t\t\t<div\n\t\t\t\t\tref="deadline"\n\t\t\t\t\t@click="onDeadlineClick"\n\t\t\t\t\tclass="crm-activity__todo-editor_deadline"\n\t\t\t\t>\n\t\t\t\t\t<span class="crm-activity__todo-editor_deadline-icon"><i></i></span>\n\t\t\t\t\t<span class="crm-activity__todo-editor_deadline-text">{{ deadlineFormatted }}</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="crm-activity__todo-editor_action-btns">\n\t\t\t\t\t<TodoEditorActionBtn\n\t\t\t\t\t\tv-for="btn in additionalButtons"\n\t\t\t\t\t\t:key="btn.id"\n\t\t\t\t\t\t:icon="btn.icon"\n\t\t\t\t\t\t:description="btn.description"\n\t\t\t\t\t\t:action="btn.action"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</label>\n\t`};let p=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(p,"DEFAULT","default");babelHelpers.defineProperty(p,"PRIMARY","primary");function b(e,t){v(e,t);t.add(e)}function h(e,t,i){v(e,t);t.set(e,i)}function v(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function F(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}const f={ADD:"add",UPDATE:"update"};var m=new WeakMap;var D=new WeakMap;var P=new WeakMap;var H=new WeakMap;var T=new WeakMap;var y=new WeakMap;var w=new WeakMap;var C=new WeakMap;var k=new WeakMap;var _=new WeakMap;var G=new WeakMap;var S=new WeakMap;var g=new WeakMap;var M=new WeakMap;var E=new WeakMap;var I=new WeakSet;var A=new WeakSet;var B=new WeakSet;var x=new WeakSet;var W=new WeakSet;var L=new WeakSet;var O=new WeakSet;var U=new WeakSet;var X=new WeakSet;let N=function(){function e(i){babelHelpers.classCallCheck(this,e);b(this,X);b(this,U);b(this,O);b(this,L);b(this,W);b(this,x);b(this,B);b(this,A);b(this,I);h(this,m,{writable:true,value:null});h(this,D,{writable:true,value:null});h(this,P,{writable:true,value:null});h(this,H,{writable:true,value:null});h(this,T,{writable:true,value:f.ADD});h(this,y,{writable:true,value:null});h(this,w,{writable:true,value:null});h(this,C,{writable:true,value:null});h(this,k,{writable:true,value:null});h(this,_,{writable:true,value:null});h(this,G,{writable:true,value:""});h(this,S,{writable:true,value:null});h(this,g,{writable:true,value:null});h(this,M,{writable:true,value:null});h(this,E,{writable:true,value:false});if(!a.Type.isDomNode(i.container)){throw new Error("TodoEditor container must be a DOM Node")}babelHelpers.classPrivateFieldSet(this,m,i.container);babelHelpers.classPrivateFieldSet(this,G,F(this,O,q).call(this,i.borderColor)?i.borderColor:e.BorderColor.DEFAULT);a.Dom.addClass(babelHelpers.classPrivateFieldGet(this,m),F(this,U,z).call(this));if(!a.Type.isNumber(i.ownerTypeId)){throw new Error("OwnerTypeId must be set")}babelHelpers.classPrivateFieldSet(this,y,i.ownerTypeId);if(!a.Type.isNumber(i.ownerId)){throw new Error("OwnerId must be set")}babelHelpers.classPrivateFieldSet(this,w,i.ownerId);babelHelpers.classPrivateFieldSet(this,C,a.Type.isString(i.defaultDescription)?i.defaultDescription:F(this,B,V).call(this));babelHelpers.classPrivateFieldSet(this,k,a.Type.isDate(i.deadline)?i.deadline:null);if(!babelHelpers.classPrivateFieldGet(this,k)){this.setDefaultDeadLine(false)}if(i.popupMode===true){babelHelpers.classPrivateFieldSet(this,E,true)}babelHelpers.classPrivateFieldSet(this,g,new t.EventEmitter);babelHelpers.classPrivateFieldGet(this,g).setEventNamespace("Crm.Activity.TodoEditor");if(a.Type.isObject(i.events)){for(const e in i.events){if(a.Type.isFunction(i.events[e])){babelHelpers.classPrivateFieldGet(this,g).subscribe(e,i.events[e])}}}}babelHelpers.createClass(e,[{key:"setMode",value:function e(t){if(!Object.values(f).some((e=>e===t))){throw new Error(`Unknown TodoEditor mode ${t}`)}babelHelpers.classPrivateFieldSet(this,T,t);return this}},{key:"show",value:function e(){babelHelpers.classPrivateFieldSet(this,D,i.BitrixVue.createApp(u,{deadline:babelHelpers.classPrivateFieldGet(this,k),defaultDescription:babelHelpers.classPrivateFieldGet(this,C),onFocus:F(this,x,K).bind(this),onChangeDescription:F(this,W,Y).bind(this),onSaveHotkeyPressed:F(this,L,j).bind(this),additionalButtons:[{id:"file-uploader",icon:"attach",description:a.Loc.getMessage("CRM_ACTIVITY_TODO_UPLOAD_FILE_BUTTON_HINT"),action:F(this,X,J).bind(this)}],popupMode:babelHelpers.classPrivateFieldGet(this,E)}));babelHelpers.classPrivateFieldSet(this,P,babelHelpers.classPrivateFieldGet(this,D).mount(babelHelpers.classPrivateFieldGet(this,m)))}},{key:"save",value:function e(){if(babelHelpers.classPrivateFieldGet(this,H)){return babelHelpers.classPrivateFieldGet(this,H)}const t=F(this,I,$).call(this);babelHelpers.classPrivateFieldSet(this,H,new Promise(((e,i)=>{a.ajax.runAction(F(this,A,R).call(this),{data:t}).then(e).catch(i)})).catch((e=>{l.UI.Notification.Center.notify({content:e.errors[0].message,autoHideDelay:5e3});throw e})).finally((()=>{babelHelpers.classPrivateFieldSet(this,H,null)})));return babelHelpers.classPrivateFieldGet(this,H)}},{key:"getDeadline",value:function e(){var t;return(t=babelHelpers.classPrivateFieldGet(this,P).getData()["deadline"])!==null&&t!==void 0?t:null}},{key:"getDescription",value:function e(){var t;return(t=babelHelpers.classPrivateFieldGet(this,P).getData()["description"])!==null&&t!==void 0?t:""}},{key:"setParentActivityId",value:function e(t){babelHelpers.classPrivateFieldSet(this,_,t);return this}},{key:"setActivityId",value:function e(t){babelHelpers.classPrivateFieldSet(this,S,t);return this}},{key:"setDeadline",value:function e(t){let i=BX.parseDate(t);if(a.Type.isDate(i)){babelHelpers.classPrivateFieldGet(this,P).setDeadline(i);babelHelpers.classPrivateFieldSet(this,k,i)}return this}},{key:"setDefaultDeadLine",value:function e(t=true){let i=BX.parseDate(a.Loc.getMessage("CRM_TIMELINE_TODO_EDITOR_DEFAULT_DATETIME"));if(a.Type.isDate(i)){babelHelpers.classPrivateFieldSet(this,k,i)}else{babelHelpers.classPrivateFieldSet(this,k,new Date);babelHelpers.classPrivateFieldGet(this,k).setMinutes(0);babelHelpers.classPrivateFieldGet(this,k).setTime(babelHelpers.classPrivateFieldGet(this,k).getTime()+60*60*1e3)}if(t){babelHelpers.classPrivateFieldGet(this,P).setDeadline(babelHelpers.classPrivateFieldGet(this,k))}return this}},{key:"setFocused",value:function e(){babelHelpers.classPrivateFieldGet(this,P).setTextareaFocused()}},{key:"setDescription",value:function e(t){babelHelpers.classPrivateFieldGet(this,P).setDescription(t);return this}},{key:"clearValue",value:function e(){babelHelpers.classPrivateFieldGet(this,P).clearDescription();babelHelpers.classPrivateFieldSet(this,_,null);this.setDefaultDeadLine();a.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,m),"--is-edit");if(babelHelpers.classPrivateFieldGet(this,M)){a.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,M).getContainer(),"--is-displayed")}babelHelpers.classPrivateFieldSet(this,M,null);return new Promise((e=>{setTimeout(e,10)}))}},{key:"resetToDefaults",value:function e(){babelHelpers.classPrivateFieldGet(this,P).setDescription(F(this,B,V).call(this));this.setDefaultDeadLine();a.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,m),"--is-edit");if(babelHelpers.classPrivateFieldGet(this,M)){a.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,M).getContainer(),"--is-displayed")}babelHelpers.classPrivateFieldSet(this,M,null);return new Promise((e=>{setTimeout(e,10)}))}},{key:"setStorageElementIds",value:function e(t){this.initFileUploader(t)}},{key:"initFileUploader",value:function e(t=[]){if(!babelHelpers.classPrivateFieldGet(this,M)){babelHelpers.classPrivateFieldSet(this,M,new o.FileUploader({baseContainer:babelHelpers.classPrivateFieldGet(this,m),events:{"File:onRemove":e=>{babelHelpers.classPrivateFieldGet(this,g).emit("onChangeUploaderContainerSize")},onUploadStart:e=>{babelHelpers.classPrivateFieldGet(this,g).emit("onChangeUploaderContainerSize")}},ownerId:babelHelpers.classPrivateFieldGet(this,w),ownerTypeId:babelHelpers.classPrivateFieldGet(this,y),activityId:babelHelpers.classPrivateFieldGet(this,S),files:t}))}const i=babelHelpers.classPrivateFieldGet(this,M).getContainer();const s="--is-displayed";if(t&&!a.Dom.hasClass(i,s)){a.Dom.addClass(i,s)}else{a.Dom.toggleClass(i,s)}babelHelpers.classPrivateFieldGet(this,g).emit("onChangeUploaderContainerSize")}}]);return e}();function $(){const e=babelHelpers.classPrivateFieldGet(this,P).getData();const t={ownerTypeId:babelHelpers.classPrivateFieldGet(this,y),ownerId:babelHelpers.classPrivateFieldGet(this,w),description:e.description,deadline:r.DateTimeFormat.format(n.DatetimeConverter.getSiteDateTimeFormat(),e.deadline),parentActivityId:babelHelpers.classPrivateFieldGet(this,_),fileTokens:babelHelpers.classPrivateFieldGet(this,M)?babelHelpers.classPrivateFieldGet(this,M).getServerFileIds():[]};if(babelHelpers.classPrivateFieldGet(this,T)===f.UPDATE){t.id=babelHelpers.classPrivateFieldGet(this,S)}return t}function R(){return babelHelpers.classPrivateFieldGet(this,T)===f.ADD?"crm.activity.todo.add":"crm.activity.todo.update"}function V(){let e="CRM_ACTIVITY_TODO_NOTIFICATION_DEFAULT_TEXT";switch(babelHelpers.classPrivateFieldGet(this,y)){case BX.CrmEntityType.enumeration.deal:e="CRM_ACTIVITY_TODO_NOTIFICATION_DEFAULT_TEXT_DEAL"}return a.Loc.getMessage(e)}function K(){a.Dom.addClass(babelHelpers.classPrivateFieldGet(this,m),"--is-edit");babelHelpers.classPrivateFieldGet(this,g).emit("onFocus")}function Y(e){const i=new t.BaseEvent({data:{description:e}});babelHelpers.classPrivateFieldGet(this,g).emit("onChangeDescription",i)}function j(){babelHelpers.classPrivateFieldGet(this,g).emit("onSaveHotkeyPressed")}function q(e){return a.Type.isString(e)&&N.BorderColor[e.toUpperCase()]}function z(){return`crm-activity__todo-editor --border-${babelHelpers.classPrivateFieldGet(this,G)}`}function J(){this.initFileUploader()}babelHelpers.defineProperty(N,"BorderColor",p);const Q=a.Reflection.namespace("BX.Crm.Activity");Q.TodoEditor=N;e.TodoEditorMode=f;e.TodoEditor=N})(this.BX.Crm.Activity=this.BX.Crm.Activity||{},BX.Event,BX.Vue3,BX.Main,BX,BX,BX.Main,BX.Crm.Timeline,BX.Crm.Activity);
//# sourceMappingURL=todo-editor.bundle.map.js