this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,i,a,s,r,l,n){"use strict";const o={props:{icon:{type:String,required:true,default:""},action:{type:Object,required:true,default:()=>({})},description:{type:String,required:false,default:""}},data(){return{popup:null}},computed:{iconClassname(){return["crm-activity__todo-editor_action-btn-icon",`--${this.icon}`]}},methods:{onMouseEnter(e){if(!this.description){return}this.popup=new a.Popup({content:this.description,bindElement:e.target,darkMode:true});setTimeout((()=>{if(!this.popup){return}this.popup.show()}),400)},onMouseLeave(){if(!this.popup||!this.description){return}this.popup.close();this.popup=null}},template:`\n\t\t<button\n\t\t\t@mouseenter="onMouseEnter"\n\t\t\t@mouseleave="onMouseLeave"\n\t\t\tclass="crm-activity__todo-editor_action-btn"\n\t\t>\n\t\t\t<i :class="iconClassname"></i>\n\t\t</button>\n\t`};const d={components:{TodoEditorActionBtn:o},props:{onFocus:Function,onChangeDescription:Function,onSaveHotkeyPressed:Function,deadline:Date,defaultDescription:{type:String,required:false,default:""}},data(){var e;return{description:this.defaultDescription,currentDeadline:(e=this.deadline)!==null&&e!==void 0?e:new Date}},computed:{deadlineFormatted(){return new n.DatetimeConverter(this.currentDeadline).toDatetimeString({withDayOfWeek:true,delimiter:", "})},exampleAdditionalButtons(){return[]}},methods:{clearDescription(){this.description="";s.Dom.style(this.$refs.textarea,"height","auto")},setDescription(e){this.description=e;s.Dom.style(this.$refs.textarea,"height","auto");s.Dom.style(this.$refs.textarea,"height",`${this.$refs.textarea.scrollHeight}px`)},onTextareaFocus(){this.onFocus()},onTextareaKeydown(e){if(e.keyCode===13&&(e.ctrlKey===true||s.Browser.isMac()&&(e.metaKey===true||e.altKey===true))){this.onSaveHotkeyPressed()}},setTextareaFocused(){this.$refs.textarea.focus()},onDeadlineClick(){BX.calendar({node:this.$refs.deadline,bTime:true,bHideTime:false,bSetFocus:false,value:l.DateTimeFormat.format(n.DatetimeConverter.getSiteDateTimeFormat(),this.currentDeadline),callback:this.setDeadlineValue.bind(this)})},setDeadlineValue(e){this.currentDeadline=e},getData(){return{description:this.description,deadline:this.currentDeadline}},onTextareaInput(e){s.Dom.style(e.target,"height","auto");s.Dom.style(e.target,"height",`${e.target.scrollHeight}px`);this.description=e.target.value;this.onChangeDescription(e.target.value)}},template:`\n\t\t\t<textarea \n\t\t\t\trows="1" \n\t\t\t\tref="textarea"\n\t\t\t\t@focus="onTextareaFocus"\n\t\t\t\t@keydown="onTextareaKeydown"\n\t\t\t\tclass="crm-activity__todo-editor_textarea"\n\t\t\t\t:placeholder="$Bitrix.Loc.getMessage('CRM_ACTIVITY_TODO_ADD_PLACEHOLDER')"\n\t\t\t\t@input="onTextareaInput"\n\t\t\t\t:value="description"\n\t\t\t></textarea>\n\t\t\t<div\n\t\t\t\tref="deadline"\n\t\t\t\t@click="onDeadlineClick"\n\t\t\t\tclass="crm-activity__todo-editor_deadline"\n\t\t\t>\n\t\t\t\t<span class="crm-activity__todo-editor_deadline-icon"><i></i></span>\n\t\t\t\t<span class="crm-activity__todo-editor_deadline-text">{{ deadlineFormatted }}</span>\n\t\t\t</div>\n\t\t\t<div class="crm-activity__todo-editor_action-btns">\n\t\t\t\t<TodoEditorActionBtn\n\t\t\t\tv-for="btn in exampleAdditionalButtons"\n\t\t\t\t:key="btn.id"\n\t\t\t\t:icon="btn.icon"\n\t\t\t\t:description="btn.description"\n\t\t\t\t:action="btn.action"\n\t\t\t/>\n\t\t\t</div>\n\t`};let c=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(c,"DEFAULT","default");babelHelpers.defineProperty(c,"PRIMARY","primary");function u(e,t){h(e,t);t.add(e)}function p(e,t,i){h(e,t);t.set(e,i)}function h(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function b(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var v=new WeakMap;var m=new WeakMap;var D=new WeakMap;var f=new WeakMap;var F=new WeakMap;var y=new WeakMap;var T=new WeakMap;var w=new WeakMap;var H=new WeakMap;var P=new WeakMap;var C=new WeakMap;var _=new WeakSet;var k=new WeakSet;var g=new WeakSet;var E=new WeakSet;var S=new WeakSet;var G=new WeakSet;let M=function(){function e(i){babelHelpers.classCallCheck(this,e);u(this,G);u(this,S);u(this,E);u(this,g);u(this,k);u(this,_);p(this,v,{writable:true,value:null});p(this,m,{writable:true,value:null});p(this,D,{writable:true,value:null});p(this,f,{writable:true,value:null});p(this,F,{writable:true,value:null});p(this,y,{writable:true,value:null});p(this,T,{writable:true,value:null});p(this,w,{writable:true,value:null});p(this,H,{writable:true,value:null});p(this,P,{writable:true,value:""});p(this,C,{writable:true,value:null});if(!s.Type.isDomNode(i.container)){throw new Error("TodoEditor container must be a DOM Node")}babelHelpers.classPrivateFieldSet(this,v,i.container);babelHelpers.classPrivateFieldSet(this,P,b(this,S,O).call(this,i.borderColor)?i.borderColor:e.BorderColor.DEFAULT);s.Dom.addClass(babelHelpers.classPrivateFieldGet(this,v),b(this,G,X).call(this));if(!s.Type.isNumber(i.ownerTypeId)){throw new Error("OwnerTypeId must be set")}babelHelpers.classPrivateFieldSet(this,F,i.ownerTypeId);if(!s.Type.isNumber(i.ownerId)){throw new Error("OwnerId must be set")}babelHelpers.classPrivateFieldSet(this,y,i.ownerId);babelHelpers.classPrivateFieldSet(this,T,s.Type.isString(i.defaultDescription)?i.defaultDescription:b(this,_,I).call(this));babelHelpers.classPrivateFieldSet(this,w,s.Type.isDate(i.deadline)?i.deadline:null);if(!babelHelpers.classPrivateFieldGet(this,w)){this.setDefaultDeadLine(false)}babelHelpers.classPrivateFieldSet(this,C,new t.EventEmitter);babelHelpers.classPrivateFieldGet(this,C).setEventNamespace("Crm.Activity.TodoEditor");if(s.Type.isObject(i.events)){for(const e in i.events){if(s.Type.isFunction(i.events[e])){babelHelpers.classPrivateFieldGet(this,C).subscribe(e,i.events[e])}}}}babelHelpers.createClass(e,[{key:"show",value:function e(){babelHelpers.classPrivateFieldSet(this,m,i.BitrixVue.createApp(d,{deadline:babelHelpers.classPrivateFieldGet(this,w),defaultDescription:babelHelpers.classPrivateFieldGet(this,T),onFocus:b(this,k,B).bind(this),onChangeDescription:b(this,g,A).bind(this),onSaveHotkeyPressed:b(this,E,x).bind(this)}));babelHelpers.classPrivateFieldSet(this,D,babelHelpers.classPrivateFieldGet(this,m).mount(babelHelpers.classPrivateFieldGet(this,v)))}},{key:"save",value:function e(){if(babelHelpers.classPrivateFieldGet(this,f)){return babelHelpers.classPrivateFieldGet(this,f)}const t=babelHelpers.classPrivateFieldGet(this,D).getData();babelHelpers.classPrivateFieldSet(this,f,new Promise(((e,i)=>{s.ajax.runAction("crm.activity.todo.add",{data:{ownerTypeId:babelHelpers.classPrivateFieldGet(this,F),ownerId:babelHelpers.classPrivateFieldGet(this,y),description:t.description,deadline:l.DateTimeFormat.format(n.DatetimeConverter.getSiteDateTimeFormat(),t.deadline),parentActivityId:babelHelpers.classPrivateFieldGet(this,H)}}).then(e).catch(i)})).catch((e=>{r.UI.Notification.Center.notify({content:e.errors[0].message,autoHideDelay:5e3});throw e})).finally((()=>{babelHelpers.classPrivateFieldSet(this,f,null)})));return babelHelpers.classPrivateFieldGet(this,f)}},{key:"getDeadline",value:function e(){var t;return(t=babelHelpers.classPrivateFieldGet(this,D).getData()["deadline"])!==null&&t!==void 0?t:null}},{key:"getDescription",value:function e(){var t;return(t=babelHelpers.classPrivateFieldGet(this,D).getData()["description"])!==null&&t!==void 0?t:""}},{key:"setParentActivityId",value:function e(t){babelHelpers.classPrivateFieldSet(this,H,t)}},{key:"setDeadLine",value:function e(t){let i=BX.parseDate(t);if(s.Type.isDate(i)){babelHelpers.classPrivateFieldGet(this,D).setDeadlineValue(i);babelHelpers.classPrivateFieldSet(this,w,i)}}},{key:"setDefaultDeadLine",value:function e(t=true){let i=BX.parseDate(s.Loc.getMessage("CRM_TIMELINE_TODO_EDITOR_DEFAULT_DATETIME"));if(s.Type.isDate(i)){babelHelpers.classPrivateFieldSet(this,w,i)}else{babelHelpers.classPrivateFieldSet(this,w,new Date);babelHelpers.classPrivateFieldGet(this,w).setMinutes(0);babelHelpers.classPrivateFieldGet(this,w).setTime(babelHelpers.classPrivateFieldGet(this,w).getTime()+60*60*1e3)}if(t){babelHelpers.classPrivateFieldGet(this,D).setDeadlineValue(babelHelpers.classPrivateFieldGet(this,w))}}},{key:"setFocused",value:function e(){babelHelpers.classPrivateFieldGet(this,D).setTextareaFocused()}},{key:"clearValue",value:function e(){babelHelpers.classPrivateFieldGet(this,D).clearDescription();babelHelpers.classPrivateFieldSet(this,H,null);this.setDefaultDeadLine();s.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,v),"--is-edit");return new Promise((e=>{setTimeout(e,10)}))}},{key:"resetToDefaults",value:function e(){babelHelpers.classPrivateFieldGet(this,D).setDescription(b(this,_,I).call(this));this.setDefaultDeadLine();s.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,v),"--is-edit");return new Promise((e=>{setTimeout(e,10)}))}}]);return e}();function I(){let e="CRM_ACTIVITY_TODO_NOTIFICATION_DEFAULT_TEXT";switch(babelHelpers.classPrivateFieldGet(this,F)){case BX.CrmEntityType.enumeration.deal:e="CRM_ACTIVITY_TODO_NOTIFICATION_DEFAULT_TEXT_DEAL"}return s.Loc.getMessage(e)}function B(){s.Dom.addClass(babelHelpers.classPrivateFieldGet(this,v),"--is-edit");babelHelpers.classPrivateFieldGet(this,C).emit("onFocus")}function A(e){const i=new t.BaseEvent({data:{description:e}});babelHelpers.classPrivateFieldGet(this,C).emit("onChangeDescription",i)}function x(){babelHelpers.classPrivateFieldGet(this,C).emit("onSaveHotkeyPressed")}function O(e){return s.Type.isString(e)&&M.BorderColor[e.toUpperCase()]}function X(){return`crm-activity__todo-editor --border-${babelHelpers.classPrivateFieldGet(this,P)}`}babelHelpers.defineProperty(M,"BorderColor",c);const L=s.Reflection.namespace("BX.Crm.Activity");L.TodoEditor=M;e.TodoEditor=M})(this.BX.Crm.Activity=this.BX.Crm.Activity||{},BX.Event,BX.Vue3,BX.Main,BX,BX,BX.Main,BX.Crm.Timeline);
//# sourceMappingURL=todo-editor.bundle.map.js