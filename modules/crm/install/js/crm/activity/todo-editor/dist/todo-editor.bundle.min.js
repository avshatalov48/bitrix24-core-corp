this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,i,a,s,l,r,n,o){"use strict";const d={props:{icon:{type:String,required:true,default:""},action:{type:Function,required:true,default:()=>{}},description:{type:String,required:false,default:""}},data(){return{popup:null}},computed:{iconClassname(){return["crm-activity__todo-editor_action-btn-icon",`--${this.icon}`]}},methods:{onMouseEnter(e){if(!this.description){return}this.popup=new a.Popup({content:this.description,bindElement:e.target,darkMode:true});setTimeout((()=>{if(!this.popup){return}this.popup.show()}),400)},onMouseLeave(){if(!this.popup||!this.description){return}this.popup.close();this.popup=null},onButtonClick(){this.action.call(this)}},template:`\n\t\t<button\n\t\t\t@mouseenter="onMouseEnter"\n\t\t\t@mouseleave="onMouseLeave"\n\t\t\t@click="onButtonClick"\n\t\t\tclass="crm-activity__todo-editor_action-btn"\n\t\t>\n\t\t\t<i :class="iconClassname"></i>\n\t\t</button>\n\t`};const c={components:{TodoEditorActionBtn:d},props:{onFocus:Function,onChangeDescription:Function,onSaveHotkeyPressed:Function,deadline:Date,defaultDescription:{type:String,required:false,default:""},additionalButtons:Array},data(){var e;return{description:this.defaultDescription,currentDeadline:(e=this.deadline)!==null&&e!==void 0?e:new Date,showFileUploader:false}},computed:{deadlineFormatted(){return new n.DatetimeConverter(this.currentDeadline).toDatetimeString({withDayOfWeek:true,delimiter:", "})}},methods:{clearDescription(){this.description="";s.Dom.style(this.$refs.textarea,"height","auto")},setDescription(e){this.description=e;s.Dom.style(this.$refs.textarea,"height","auto");s.Dom.style(this.$refs.textarea,"height",`${this.$refs.textarea.scrollHeight}px`)},onTextareaFocus(){this.onFocus()},onTextareaKeydown(e){if(e.keyCode===13&&(e.ctrlKey===true||s.Browser.isMac()&&(e.metaKey===true||e.altKey===true))){this.onSaveHotkeyPressed()}},setTextareaFocused(){this.$refs.textarea.focus()},onDeadlineClick(){BX.calendar({node:this.$refs.deadline,bTime:true,bHideTime:false,bSetFocus:false,value:r.DateTimeFormat.format(n.DatetimeConverter.getSiteDateTimeFormat(),this.currentDeadline),callback:this.setDeadlineValue.bind(this)})},setDeadlineValue(e){this.currentDeadline=e},getData(){return{description:this.description,deadline:this.currentDeadline}},onTextareaInput(e){s.Dom.style(e.target,"height","auto");s.Dom.style(e.target,"height",`${e.target.scrollHeight}px`);this.description=e.target.value;this.onChangeDescription(e.target.value)}},template:`\n\t\t\t<textarea \n\t\t\t\trows="1" \n\t\t\t\tref="textarea"\n\t\t\t\t@focus="onTextareaFocus"\n\t\t\t\t@keydown="onTextareaKeydown"\n\t\t\t\tclass="crm-activity__todo-editor_textarea"\n\t\t\t\t:placeholder="$Bitrix.Loc.getMessage('CRM_ACTIVITY_TODO_ADD_PLACEHOLDER')"\n\t\t\t\t@input="onTextareaInput"\n\t\t\t\t:value="description"\n\t\t\t></textarea>\n\t\t\t<div\n\t\t\t\tref="deadline"\n\t\t\t\t@click="onDeadlineClick"\n\t\t\t\tclass="crm-activity__todo-editor_deadline"\n\t\t\t>\n\t\t\t\t<span class="crm-activity__todo-editor_deadline-icon"><i></i></span>\n\t\t\t\t<span class="crm-activity__todo-editor_deadline-text">{{ deadlineFormatted }}</span>\n\t\t\t</div>\n\t\t\t<div class="crm-activity__todo-editor_action-btns">\n\t\t\t\t<TodoEditorActionBtn\n\t\t\t\t\tv-for="btn in additionalButtons"\n\t\t\t\t\t:key="btn.id"\n\t\t\t\t\t:icon="btn.icon"\n\t\t\t\t\t:description="btn.description"\n\t\t\t\t\t:action="btn.action"\n\t\t\t\t/>\n\t\t\t</div>\n\t`};let p=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(p,"DEFAULT","default");babelHelpers.defineProperty(p,"PRIMARY","primary");function u(e,t){h(e,t);t.add(e)}function b(e,t,i){h(e,t);t.set(e,i)}function h(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function v(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var F=new WeakMap;var m=new WeakMap;var f=new WeakMap;var D=new WeakMap;var H=new WeakMap;var P=new WeakMap;var y=new WeakMap;var T=new WeakMap;var w=new WeakMap;var C=new WeakMap;var g=new WeakMap;var _=new WeakMap;var k=new WeakSet;var G=new WeakSet;var S=new WeakSet;var I=new WeakSet;var E=new WeakSet;var B=new WeakSet;var M=new WeakSet;let A=function(){function e(i){babelHelpers.classCallCheck(this,e);u(this,M);u(this,B);u(this,E);u(this,I);u(this,S);u(this,G);u(this,k);b(this,F,{writable:true,value:null});b(this,m,{writable:true,value:null});b(this,f,{writable:true,value:null});b(this,D,{writable:true,value:null});b(this,H,{writable:true,value:null});b(this,P,{writable:true,value:null});b(this,y,{writable:true,value:null});b(this,T,{writable:true,value:null});b(this,w,{writable:true,value:null});b(this,C,{writable:true,value:""});b(this,g,{writable:true,value:null});b(this,_,{writable:true,value:null});if(!s.Type.isDomNode(i.container)){throw new Error("TodoEditor container must be a DOM Node")}babelHelpers.classPrivateFieldSet(this,F,i.container);babelHelpers.classPrivateFieldSet(this,C,v(this,E,W).call(this,i.borderColor)?i.borderColor:e.BorderColor.DEFAULT);s.Dom.addClass(babelHelpers.classPrivateFieldGet(this,F),v(this,B,U).call(this));if(!s.Type.isNumber(i.ownerTypeId)){throw new Error("OwnerTypeId must be set")}babelHelpers.classPrivateFieldSet(this,H,i.ownerTypeId);if(!s.Type.isNumber(i.ownerId)){throw new Error("OwnerId must be set")}babelHelpers.classPrivateFieldSet(this,P,i.ownerId);babelHelpers.classPrivateFieldSet(this,y,s.Type.isString(i.defaultDescription)?i.defaultDescription:v(this,k,x).call(this));babelHelpers.classPrivateFieldSet(this,T,s.Type.isDate(i.deadline)?i.deadline:null);if(!babelHelpers.classPrivateFieldGet(this,T)){this.setDefaultDeadLine(false)}babelHelpers.classPrivateFieldSet(this,g,new t.EventEmitter);babelHelpers.classPrivateFieldGet(this,g).setEventNamespace("Crm.Activity.TodoEditor");if(s.Type.isObject(i.events)){for(const e in i.events){if(s.Type.isFunction(i.events[e])){babelHelpers.classPrivateFieldGet(this,g).subscribe(e,i.events[e])}}}}babelHelpers.createClass(e,[{key:"show",value:function e(){babelHelpers.classPrivateFieldSet(this,m,i.BitrixVue.createApp(c,{deadline:babelHelpers.classPrivateFieldGet(this,T),defaultDescription:babelHelpers.classPrivateFieldGet(this,y),onFocus:v(this,G,O).bind(this),onChangeDescription:v(this,S,L).bind(this),onSaveHotkeyPressed:v(this,I,X).bind(this),additionalButtons:[{id:"file-uploader",icon:"attach",description:s.Loc.getMessage("CRM_ACTIVITY_TODO_UPLOAD_FILE_BUTTON_HINT"),action:v(this,M,N).bind(this)}]}));babelHelpers.classPrivateFieldSet(this,f,babelHelpers.classPrivateFieldGet(this,m).mount(babelHelpers.classPrivateFieldGet(this,F)))}},{key:"save",value:function e(){if(babelHelpers.classPrivateFieldGet(this,D)){return babelHelpers.classPrivateFieldGet(this,D)}const t=babelHelpers.classPrivateFieldGet(this,f).getData();babelHelpers.classPrivateFieldSet(this,D,new Promise(((e,i)=>{s.ajax.runAction("crm.activity.todo.add",{data:{ownerTypeId:babelHelpers.classPrivateFieldGet(this,H),ownerId:babelHelpers.classPrivateFieldGet(this,P),description:t.description,deadline:r.DateTimeFormat.format(n.DatetimeConverter.getSiteDateTimeFormat(),t.deadline),parentActivityId:babelHelpers.classPrivateFieldGet(this,w),fileTokens:babelHelpers.classPrivateFieldGet(this,_)?babelHelpers.classPrivateFieldGet(this,_).getServerFileIds():[]}}).then(e).catch(i)})).catch((e=>{l.UI.Notification.Center.notify({content:e.errors[0].message,autoHideDelay:5e3});throw e})).finally((()=>{babelHelpers.classPrivateFieldSet(this,D,null)})));return babelHelpers.classPrivateFieldGet(this,D)}},{key:"getDeadline",value:function e(){var t;return(t=babelHelpers.classPrivateFieldGet(this,f).getData()["deadline"])!==null&&t!==void 0?t:null}},{key:"getDescription",value:function e(){var t;return(t=babelHelpers.classPrivateFieldGet(this,f).getData()["description"])!==null&&t!==void 0?t:""}},{key:"setParentActivityId",value:function e(t){babelHelpers.classPrivateFieldSet(this,w,t)}},{key:"setDeadLine",value:function e(t){let i=BX.parseDate(t);if(s.Type.isDate(i)){babelHelpers.classPrivateFieldGet(this,f).setDeadlineValue(i);babelHelpers.classPrivateFieldSet(this,T,i)}}},{key:"setDefaultDeadLine",value:function e(t=true){let i=BX.parseDate(s.Loc.getMessage("CRM_TIMELINE_TODO_EDITOR_DEFAULT_DATETIME"));if(s.Type.isDate(i)){babelHelpers.classPrivateFieldSet(this,T,i)}else{babelHelpers.classPrivateFieldSet(this,T,new Date);babelHelpers.classPrivateFieldGet(this,T).setMinutes(0);babelHelpers.classPrivateFieldGet(this,T).setTime(babelHelpers.classPrivateFieldGet(this,T).getTime()+60*60*1e3)}if(t){babelHelpers.classPrivateFieldGet(this,f).setDeadlineValue(babelHelpers.classPrivateFieldGet(this,T))}}},{key:"setFocused",value:function e(){babelHelpers.classPrivateFieldGet(this,f).setTextareaFocused()}},{key:"clearValue",value:function e(){babelHelpers.classPrivateFieldGet(this,f).clearDescription();babelHelpers.classPrivateFieldSet(this,w,null);this.setDefaultDeadLine();s.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,F),"--is-edit");if(babelHelpers.classPrivateFieldGet(this,_)){s.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,_).getContainer(),"--is-displayed")}babelHelpers.classPrivateFieldSet(this,_,null);return new Promise((e=>{setTimeout(e,10)}))}},{key:"resetToDefaults",value:function e(){babelHelpers.classPrivateFieldGet(this,f).setDescription(v(this,k,x).call(this));this.setDefaultDeadLine();s.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,F),"--is-edit");if(babelHelpers.classPrivateFieldGet(this,_)){s.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,_).getContainer(),"--is-displayed")}babelHelpers.classPrivateFieldSet(this,_,null);return new Promise((e=>{setTimeout(e,10)}))}}]);return e}();function x(){let e="CRM_ACTIVITY_TODO_NOTIFICATION_DEFAULT_TEXT";switch(babelHelpers.classPrivateFieldGet(this,H)){case BX.CrmEntityType.enumeration.deal:e="CRM_ACTIVITY_TODO_NOTIFICATION_DEFAULT_TEXT_DEAL"}return s.Loc.getMessage(e)}function O(){s.Dom.addClass(babelHelpers.classPrivateFieldGet(this,F),"--is-edit");babelHelpers.classPrivateFieldGet(this,g).emit("onFocus")}function L(e){const i=new t.BaseEvent({data:{description:e}});babelHelpers.classPrivateFieldGet(this,g).emit("onChangeDescription",i)}function X(){babelHelpers.classPrivateFieldGet(this,g).emit("onSaveHotkeyPressed")}function W(e){return s.Type.isString(e)&&A.BorderColor[e.toUpperCase()]}function U(){return`crm-activity__todo-editor --border-${babelHelpers.classPrivateFieldGet(this,C)}`}function N(){if(!babelHelpers.classPrivateFieldGet(this,_)){babelHelpers.classPrivateFieldSet(this,_,new o.FileUploader({baseContainer:babelHelpers.classPrivateFieldGet(this,F),events:{"File:onRemove":e=>{babelHelpers.classPrivateFieldGet(this,g).emit("onChangeUploaderContainerSize")},onUploadStart:e=>{babelHelpers.classPrivateFieldGet(this,g).emit("onChangeUploaderContainerSize")}},ownerId:babelHelpers.classPrivateFieldGet(this,P),ownerTypeId:babelHelpers.classPrivateFieldGet(this,H),activityId:null}))}s.Dom.toggleClass(babelHelpers.classPrivateFieldGet(this,_).getContainer(),"--is-displayed");babelHelpers.classPrivateFieldGet(this,g).emit("onChangeUploaderContainerSize")}babelHelpers.defineProperty(A,"BorderColor",p);const R=s.Reflection.namespace("BX.Crm.Activity");R.TodoEditor=A;e.TodoEditor=A})(this.BX.Crm.Activity=this.BX.Crm.Activity||{},BX.Event,BX.Vue3,BX.Main,BX,BX,BX.Main,BX.Crm.Timeline,BX.Crm.Activity);
//# sourceMappingURL=todo-editor.bundle.map.js