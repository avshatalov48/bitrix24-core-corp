{"version":3,"file":"grid-activities-manager.bundle.js","sources":["../src/manager.js","../src/grid-activities-manager.js"],"sourcesContent":["import { ajax, Dom, Reflection, Runtime } from 'main.core';\n\nconst Util = Reflection.namespace('BX.util');\n\ninterface Activity {\n\tID: ?number;\n\ttypeID: number;\n\tproviderID: string;\n\tassociatedEntityID: ?number;\n\tcalendarEventId: ?number;\n\tcustomViewLink: ?string;\n}\n\nexport class Manager\n{\n\tstatic #activityTypes = {\n\t\ttask: 3,\n\t\tprovider: 6,\n\t};\n\n\tactivityAddingPopup = {};\n\n\tasync showAddPopup(\n\t\tbindElement: HTMLElement,\n\t\tgridManagerId: string,\n\t\tentityTypeId: number,\n\t\tentityId: number,\n\t\tcurrentUser: Object,\n\t\tsettings: ?any,\n\t)\n\t{\n\t\tDom.addClass(bindElement, '--active');\n\t\tconst key = `${entityTypeId}_${entityId}`;\n\n\t\tconst exports = await Runtime.loadExtension('crm.activity.adding-popup');\n\n\t\tif (!exports || !exports.AddingPopup)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (!Object.hasOwn(this.activityAddingPopup, key))\n\t\t{\n\t\t\tthis.activityAddingPopup[key] = new exports.AddingPopup(\n\t\t\t\tentityTypeId,\n\t\t\t\tentityId,\n\t\t\t\tcurrentUser,\n\t\t\t\tsettings,\n\t\t\t\t{\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tonClose() {\n\t\t\t\t\t\t\tBX.Dom.removeClass(bindElement, '--active');\n\t\t\t\t\t\t},\n\t\t\t\t\t\tonSave() {\n\t\t\t\t\t\t\tconst grid = BX.Main.gridManager.getById(gridManagerId);\n\t\t\t\t\t\t\tif (grid)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tgrid.instance.reload();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\n\t\tthis.activityAddingPopup[key].show();\n\t}\n\n\tasync viewActivity(gridId: string, activityId: number, allowEdit: boolean)\n\t{\n\t\ttry\n\t\t{\n\t\t\tconst activity = await this.#fetchActivity(activityId);\n\n\t\t\tif (!activity)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (activity.customViewLink)\n\t\t\t{\n\t\t\t\tBX.Crm.Page.open(activity.customViewLink);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.openActivityDialog(activity, allowEdit);\n\t\t\t}\n\t\t}\n\t\tcatch (err)\n\t\t{\n\t\t\tconsole.error(err);\n\t\t}\n\t}\n\n\topenActivityDialog(activity: Activity, allowEdit: boolean)\n\t{\n\t\tconst typeId = parseInt(activity.typeID, 10);\n\n\t\tif (typeId === Manager.#activityTypes.provider && BX.CrmActivityProvider)\n\t\t{\n\t\t\tthis.#showProviderSix(activity, allowEdit);\n\t\t}\n\t\telse if (typeId === Manager.#activityTypes.task)\n\t\t{\n\t\t\tthis.#showTask(activity, allowEdit);\n\t\t}\n\t}\n\n\t#showProviderSix(activity: Activity, allowEdit: boolean)\n\t{\n\t\tconst providerID = activity.providerID;\n\n\t\tswitch (providerID)\n\t\t{\n\t\t\tcase 'CRM_TASKS_TASK':\n\t\t\tcase 'CRM_TASKS_TASK_COMMENT':\n\t\t\t\tthis.#showTask(activity, allowEdit);\n\t\t\t\tbreak;\n\t\t\tcase 'REST_APP':\n\t\t\tcase 'CONFIGURABLE_REST_APP':\n\t\t\t\tthis.#showRestApp(activity);\n\n\t\t\t\tbreak;\n\t\t\tcase 'CRM_CALENDAR_SHARING':\n\t\t\t\tthis.#showCalendarSharing(activity);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t}\n\t}\n\n\t#showRestApp(activity: Activity)\n\t{\n\t\tBX.rest.AppLayout.openApplication(\n\t\t\tactivity.associatedEntityID || 0,\n\t\t\t{\n\t\t\t\taction: 'view_activity',\n\t\t\t\tactivity_id: activity.ID || 0,\n\t\t\t},\n\t\t);\n\t}\n\n\t#showCalendarSharing(activity: Activity)\n\t{\n\t\tconst calendarEventId = parseInt(activity.calendarEventId, 10);\n\t\tif (!calendarEventId)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif ((window.top.BX || window.BX).Calendar.SliderLoader)\n\t\t{\n\t\t\tconst sliderId = `crm-calendar-slider-${calendarEventId}-${Math.floor(Math.random() * 1000)}`;\n\n\t\t\tnew (window.top.BX || window.BX).Calendar.SliderLoader(calendarEventId, {\n\t\t\t\tsliderId,\n\t\t\t}).show();\n\t\t}\n\t}\n\n\t#showTask(activity: Activity, allowEdit: boolean)\n\t{\n\t\tconst taskId = parseInt(activity.associatedEntityID, 10);\n\t\tif (taskId <= 0)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet taskOpenUrl = allowEdit\n\t\t\t? '/company/personal/user/#user_id#/tasks/task/edit/#task_id#/'\n\t\t\t: '/company/personal/user/#user_id#/tasks/task/view/#task_id#/'\n\t\t;\n\n\t\ttaskOpenUrl = taskOpenUrl.replace('#user_id#', this.#getCurrentUserId());\n\t\ttaskOpenUrl = taskOpenUrl.replace('#task_id#', taskId);\n\n\t\tif (BX.SidePanel)\n\t\t{\n\t\t\tBX.SidePanel.Instance.open(taskOpenUrl);\n\t\t}\n\t\telse\n\t\t{\n\t\t\twindow.top.location.href = taskOpenUrl;\n\t\t}\n\t}\n\n\t#getCurrentUserId(): string\n\t{\n\t\treturn BX.message('USER_ID');\n\t}\n\n\tasync #fetchActivity(activityId: number): Promise<Activity>\n\t{\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tconst serviceUrl = Util.add_url_param(\n\t\t\t\t'/bitrix/components/bitrix/crm.activity.editor/ajax.php',\n\t\t\t\t{\n\t\t\t\t\tid: activityId,\n\t\t\t\t\taction: 'get_activity',\n\t\t\t\t\tsessid: BX.bitrix_sessid(),\n\t\t\t\t},\n\t\t\t);\n\n\t\t\tajax({\n\t\t\t\turl: serviceUrl,\n\t\t\t\tmethod: 'POST',\n\t\t\t\tdataType: 'json',\n\t\t\t\tdata: {\n\t\t\t\t\tACTION: 'GET_ACTIVITY',\n\t\t\t\t\tID: activityId,\n\t\t\t\t},\n\t\t\t\tonsuccess: (data): void => {\n\t\t\t\t\tif (data.ERROR)\n\t\t\t\t\t{\n\t\t\t\t\t\treject(data.ERROR);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tresolve(data.ACTIVITY || null);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tonfailure: (errorData) => {\n\t\t\t\t\treject(errorData);\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t}\n}\n","import { Manager } from './manager';\n\nexport class GridActivitiesManager\n{\n\tstatic #instance: ?GridActivitiesManager = null;\n\n\tstatic showActivityAddingPopup(\n\t\tbindElement: HTMLElement,\n\t\tgridManagerId: string,\n\t\tentityTypeId: number,\n\t\tentityId: number,\n\t\tcurrentUser: Object,\n\t\tsettings: ?any,\n\t)\n\t{\n\t\tvoid GridActivitiesManager\n\t\t\t.getManagerInstance()\n\t\t\t.showAddPopup(bindElement, gridManagerId, entityTypeId, entityId, currentUser, settings)\n\t\t;\n\t}\n\n\tstatic viewActivity(gridId: string, activityId: number, allowEdit: boolean)\n\t{\n\t\tvoid GridActivitiesManager.getManagerInstance()\n\t\t\t.viewActivity(gridId, activityId, allowEdit)\n\t\t;\n\t}\n\n\tstatic getManagerInstance(): Manager\n\t{\n\t\tif (!this.#instance)\n\t\t{\n\t\t\tthis.#instance = new Manager();\n\t\t}\n\n\t\treturn this.#instance;\n\t}\n}\n"],"names":["Util","Reflection","namespace","Manager","activityAddingPopup","showAddPopup","bindElement","gridManagerId","entityTypeId","entityId","currentUser","settings","Dom","addClass","key","exports","Runtime","loadExtension","AddingPopup","Object","hasOwn","events","onClose","BX","removeClass","onSave","grid","Main","gridManager","getById","instance","reload","show","viewActivity","gridId","activityId","allowEdit","activity","customViewLink","Crm","Page","open","openActivityDialog","err","console","error","typeId","parseInt","typeID","provider","CrmActivityProvider","task","providerID","rest","AppLayout","openApplication","associatedEntityID","action","activity_id","ID","calendarEventId","window","top","Calendar","SliderLoader","sliderId","Math","floor","random","taskId","taskOpenUrl","replace","SidePanel","Instance","location","href","message","Promise","resolve","reject","serviceUrl","add_url_param","id","sessid","bitrix_sessid","ajax","url","method","dataType","data","ACTION","onsuccess","ERROR","ACTIVITY","onfailure","errorData","GridActivitiesManager","showActivityAddingPopup","getManagerInstance"],"mappings":"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"}