this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,i,s,a,l,r){"use strict";let n=e=>e,o;function c(e,t){b(e,t);t.add(e)}function d(e,t,i){b(e,t);t.set(e,i)}function b(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function h(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var v=new WeakMap;var p=new WeakMap;var u=new WeakMap;var P=new WeakMap;var f=new WeakMap;var H=new WeakMap;var F=new WeakMap;var w=new WeakSet;var G=new WeakSet;var S=new WeakSet;var m=new WeakSet;var y=new WeakSet;var g=new WeakSet;var B=new WeakSet;var E=new WeakSet;let A=function(){function e(i,s,a,r){babelHelpers.classCallCheck(this,e);c(this,E);c(this,B);c(this,g);c(this,y);c(this,m);c(this,S);c(this,G);c(this,w);d(this,v,{writable:true,value:null});d(this,p,{writable:true,value:null});d(this,u,{writable:true,value:null});d(this,P,{writable:true,value:null});d(this,f,{writable:true,value:null});d(this,H,{writable:true,value:null});d(this,F,{writable:true,value:null});babelHelpers.classPrivateFieldSet(this,v,t.Text.toInteger(s));babelHelpers.classPrivateFieldSet(this,p,t.Text.toInteger(i));babelHelpers.classPrivateFieldSet(this,u,a);babelHelpers.classPrivateFieldSet(this,F,new l.EventEmitter);babelHelpers.classPrivateFieldGet(this,F).setEventNamespace("Crm.Activity.AddingPopup");if(!t.Type.isPlainObject(r)){r={}}if(t.Type.isObject(r.events)){for(const e in r.events){if(t.Type.isFunction(r.events[e])){babelHelpers.classPrivateFieldGet(this,F).subscribe(e,r.events[e])}}}}babelHelpers.createClass(e,[{key:"show",value:function e(i,l=a.TodoEditorMode.ADD){const r=h(this,S,D).call(this);r.setBindElement(i);if(r.isShown()){return}if(!babelHelpers.classPrivateFieldGet(this,f).hasChildNodes()){babelHelpers.classPrivateFieldSet(this,H,new a.TodoEditor({container:babelHelpers.classPrivateFieldGet(this,f),ownerTypeId:babelHelpers.classPrivateFieldGet(this,p),ownerId:babelHelpers.classPrivateFieldGet(this,v),currentUser:babelHelpers.classPrivateFieldGet(this,u),events:{onChangeDescription:h(this,g,I).bind(this),onSaveHotkeyPressed:h(this,B,M).bind(this),onChangeUploaderContainerSize:h(this,E,X).bind(this)},popupMode:true}));r.setButtons([new s.SaveButton({id:"save",color:s.ButtonColor.PRIMARY,size:s.ButtonSize.EXTRA_SMALL,round:true,events:{click:h(this,m,W).bind(this)}}),new s.CancelButton({id:"cancel",size:s.ButtonSize.EXTRA_SMALL,round:true,events:{click:()=>r.close()}})]);r.subscribeOnce("onFirstShow",(()=>babelHelpers.classPrivateFieldGet(this,H).show()));r.subscribe("onAfterShow",(()=>{h(this,y,C).call(this,babelHelpers.classPrivateFieldGet(this,H).getDescription());babelHelpers.classPrivateFieldGet(this,H).setFocused()}));r.subscribe("onAfterClose",(()=>{babelHelpers.classPrivateFieldGet(this,H).resetToDefaults().then((()=>{babelHelpers.classPrivateFieldGet(this,F).emit("onClose")}))}));r.subscribe("onShow",(()=>{const{mode:e,activity:i}=r.params;if(e===a.TodoEditorMode.UPDATE&&i){babelHelpers.classPrivateFieldGet(this,H).setMode(e).setActivityId(i.id).setDescription(i.description).setDeadline(i.deadline);if(t.Type.isArrayFilled(i.storageElementIds)){babelHelpers.classPrivateFieldGet(this,H).setStorageElementIds(i.storageElementIds)}}}))}h(this,w,k).call(this,r,l)}},{key:"bindPopup",value:function e(t){if(!babelHelpers.classPrivateFieldGet(this,P)){return}if(t!==babelHelpers.classPrivateFieldGet(this,P).bindElement){babelHelpers.classPrivateFieldGet(this,P).setBindElement(t)}}}]);return e}();function k(e,t=a.TodoEditorMode.ADD){e.params.mode=t;if(t===a.TodoEditorMode.ADD){e.show();return}if(t===a.TodoEditorMode.UPDATE){h(this,G,T).call(this).then((t=>{if(t){e.params.activity=t;e.show()}}));return}console.error("Wrong TodoEditor mode")}function T(){const e={ownerTypeId:babelHelpers.classPrivateFieldGet(this,p),ownerId:babelHelpers.classPrivateFieldGet(this,v)};return new Promise(((i,s)=>{t.ajax.runAction("crm.activity.todo.getNearest",{data:e}).then((({data:e})=>i(e))).catch((e=>{r.UI.Notification.Center.notify({content:e.errors[0].message,autoHideDelay:5e3});s()}))}))}function D(){if(!babelHelpers.classPrivateFieldGet(this,P)||babelHelpers.classPrivateFieldGet(this,P).isDestroyed()){babelHelpers.classPrivateFieldSet(this,f,t.Tag.render(o||(o=n`<div class="crm-activity-adding-popup-container"></div>`)));babelHelpers.classPrivateFieldSet(this,P,new i.Popup({id:`kanban_planner_menu_${babelHelpers.classPrivateFieldGet(this,v)}`,overlay:{opacity:0},content:babelHelpers.classPrivateFieldGet(this,f),cacheable:false,isScrollBlock:true,className:"crm-activity-adding-popup",closeByEsc:true,closeIcon:false,angle:{offset:27},padding:16,minWidth:500,maxWidth:550,minHeight:150,maxHeight:400}))}return babelHelpers.classPrivateFieldGet(this,P)}function W(){if(babelHelpers.classPrivateFieldGet(this,P)){const e=babelHelpers.classPrivateFieldGet(this,P).getButton("save");if(e.getState()){return}e===null||e===void 0?void 0:e.setWaiting(true);babelHelpers.classPrivateFieldGet(this,H).save().then((()=>{babelHelpers.classPrivateFieldGet(this,P).close();babelHelpers.classPrivateFieldGet(this,F).emit("onSave")})).catch((()=>{})).finally((()=>e===null||e===void 0?void 0:e.setWaiting(false)))}}function C(e){if(babelHelpers.classPrivateFieldGet(this,P)&&babelHelpers.classPrivateFieldGet(this,P).isShown()){babelHelpers.classPrivateFieldGet(this,F).emit("onActualizePopupLayout",{entityId:babelHelpers.classPrivateFieldGet(this,v)});babelHelpers.classPrivateFieldGet(this,P).adjustPosition({forceBindPosition:true});const t=babelHelpers.classPrivateFieldGet(this,P).getButton("save");if(!e.length&&t&&!t.getState()){t.setState(s.ButtonState.DISABLED)}else if(e.length&&t&&t.getState()===s.ButtonState.DISABLED){t.setState(null)}}}function I(e){const{description:t}=e.getData();h(this,y,C).call(this,t)}function M(){h(this,m,W).call(this)}function X(){if(babelHelpers.classPrivateFieldGet(this,P)){babelHelpers.classPrivateFieldGet(this,F).emit("onActualizePopupLayout",{entityId:babelHelpers.classPrivateFieldGet(this,v)});babelHelpers.classPrivateFieldGet(this,P).adjustPosition()}}e.AddingPopup=A})(this.BX.Crm.Activity=this.BX.Crm.Activity||{},BX,BX.Main,BX.UI,BX.Crm.Activity,BX.Event,BX);
//# sourceMappingURL=adding-popup.bundle.map.js