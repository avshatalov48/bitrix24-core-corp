this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,i,s,a,l,r){"use strict";let n=e=>e,o;function c(e,t){b(e,t);t.add(e)}function d(e,t,i){b(e,t);t.set(e,i)}function b(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function h(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var v=new WeakMap;var u=new WeakMap;var p=new WeakMap;var P=new WeakMap;var f=new WeakMap;var H=new WeakMap;var F=new WeakMap;var w=new WeakMap;var S=new WeakSet;var m=new WeakSet;var G=new WeakSet;var g=new WeakSet;var y=new WeakSet;var B=new WeakSet;var E=new WeakSet;var k=new WeakSet;var A=new WeakSet;let T=function(){function e(t,a,l,r,n){babelHelpers.classCallCheck(this,e);c(this,A);c(this,k);c(this,E);c(this,B);c(this,y);c(this,g);c(this,G);c(this,m);c(this,S);d(this,v,{writable:true,value:null});d(this,u,{writable:true,value:null});d(this,p,{writable:true,value:null});d(this,P,{writable:true,value:null});d(this,f,{writable:true,value:null});d(this,H,{writable:true,value:null});d(this,F,{writable:true,value:null});d(this,w,{writable:true,value:null});babelHelpers.classPrivateFieldSet(this,v,i.Text.toInteger(a));babelHelpers.classPrivateFieldSet(this,u,i.Text.toInteger(t));babelHelpers.classPrivateFieldSet(this,p,l);babelHelpers.classPrivateFieldSet(this,P,r);babelHelpers.classPrivateFieldSet(this,w,new s.EventEmitter);babelHelpers.classPrivateFieldGet(this,w).setEventNamespace("Crm.Activity.AddingPopup");if(!i.Type.isPlainObject(n)){n={}}if(i.Type.isObject(n.events)){for(const e in n.events){if(i.Type.isFunction(n.events[e])){babelHelpers.classPrivateFieldGet(this,w).subscribe(e,n.events[e])}}}}babelHelpers.createClass(e,[{key:"show",value:function e(s,a=t.TodoEditorMode.ADD){const r=h(this,G,D).call(this);r.setBindElement(s);if(r.isShown()){return}if(!babelHelpers.classPrivateFieldGet(this,H).hasChildNodes()){babelHelpers.classPrivateFieldSet(this,F,new t.TodoEditor({container:babelHelpers.classPrivateFieldGet(this,H),ownerTypeId:babelHelpers.classPrivateFieldGet(this,u),ownerId:babelHelpers.classPrivateFieldGet(this,v),currentUser:babelHelpers.classPrivateFieldGet(this,p),pingSettings:babelHelpers.classPrivateFieldGet(this,P),events:{onChangeDescription:h(this,B,X).bind(this),onSaveHotkeyPressed:h(this,E,z).bind(this),onChangeUploaderContainerSize:h(this,k,L).bind(this),onFocus:h(this,A,j).bind(this)},popupMode:true}));r.setButtons([new l.SaveButton({id:"save",color:l.ButtonColor.PRIMARY,size:l.ButtonSize.EXTRA_SMALL,round:true,events:{click:h(this,g,I).bind(this)}}),new l.CancelButton({id:"cancel",size:l.ButtonSize.EXTRA_SMALL,round:true,events:{click:()=>r.close()}})]);r.subscribeOnce("onFirstShow",(e=>{e.target.getZIndexComponent().setZIndex(1400);babelHelpers.classPrivateFieldGet(this,F).show()}));r.subscribe("onAfterShow",(()=>{h(this,y,M).call(this,babelHelpers.classPrivateFieldGet(this,F).getDescription());babelHelpers.classPrivateFieldGet(this,F).setFocused()}));r.subscribe("onAfterClose",(()=>{babelHelpers.classPrivateFieldGet(this,F).resetToDefaults().then((()=>{babelHelpers.classPrivateFieldGet(this,w).emit("onClose")}))}));r.subscribe("onShow",(()=>{const{mode:e,activity:s}=r.params;if(e===t.TodoEditorMode.UPDATE&&s){babelHelpers.classPrivateFieldGet(this,F).setMode(e).setActivityId(s.id).setDescription(s.description).setDeadline(s.deadline);if(i.Type.isArrayFilled(s.storageElementIds)){babelHelpers.classPrivateFieldGet(this,F).setStorageElementIds(s.storageElementIds)}}}))}h(this,S,W).call(this,r,a)}},{key:"bindPopup",value:function e(t){if(!babelHelpers.classPrivateFieldGet(this,f)){return}if(t!==babelHelpers.classPrivateFieldGet(this,f).bindElement){babelHelpers.classPrivateFieldGet(this,f).setBindElement(t)}}}]);return e}();function W(e,i=t.TodoEditorMode.ADD){e.params.mode=i;if(i===t.TodoEditorMode.ADD){e.show();return}if(i===t.TodoEditorMode.UPDATE){h(this,m,C).call(this).then((t=>{if(t){e.params.activity=t;e.show()}}));return}console.error("Wrong TodoEditor mode")}function C(){const e={ownerTypeId:babelHelpers.classPrivateFieldGet(this,u),ownerId:babelHelpers.classPrivateFieldGet(this,v)};return new Promise(((t,s)=>{i.ajax.runAction("crm.activity.todo.getNearest",{data:e}).then((({data:e})=>t(e))).catch((e=>{r.UI.Notification.Center.notify({content:e.errors[0].message,autoHideDelay:5e3});s()}))}))}function D(){if(!babelHelpers.classPrivateFieldGet(this,f)||babelHelpers.classPrivateFieldGet(this,f).isDestroyed()){babelHelpers.classPrivateFieldSet(this,H,i.Tag.render(o||(o=n`<div class="crm-activity-adding-popup-container"></div>`)));babelHelpers.classPrivateFieldSet(this,f,new a.Popup({id:`kanban_planner_menu_${babelHelpers.classPrivateFieldGet(this,v)}`,overlay:{opacity:0},content:babelHelpers.classPrivateFieldGet(this,H),cacheable:false,isScrollBlock:true,className:"crm-activity-adding-popup",closeByEsc:true,closeIcon:false,angle:{offset:27},padding:16,minWidth:500,maxWidth:550,minHeight:150,maxHeight:400}))}return babelHelpers.classPrivateFieldGet(this,f)}function I(){if(babelHelpers.classPrivateFieldGet(this,f)){const e=babelHelpers.classPrivateFieldGet(this,f).getButton("save");if(e.getState()){return}e===null||e===void 0?void 0:e.setWaiting(true);babelHelpers.classPrivateFieldGet(this,F).save().then((()=>{babelHelpers.classPrivateFieldGet(this,f).close();babelHelpers.classPrivateFieldGet(this,w).emit("onSave")})).catch((()=>{})).finally((()=>e===null||e===void 0?void 0:e.setWaiting(false)))}}function M(e){if(babelHelpers.classPrivateFieldGet(this,f)&&babelHelpers.classPrivateFieldGet(this,f).isShown()){babelHelpers.classPrivateFieldGet(this,w).emit("onActualizePopupLayout",{entityId:babelHelpers.classPrivateFieldGet(this,v)});babelHelpers.classPrivateFieldGet(this,f).adjustPosition({forceBindPosition:true});const t=babelHelpers.classPrivateFieldGet(this,f).getButton("save");if(!e.length&&t&&!t.getState()){t.setState(l.ButtonState.DISABLED)}else if(e.length&&t&&t.getState()===l.ButtonState.DISABLED){t.setState(null)}}}function X(e){const{description:t}=e.getData();h(this,y,M).call(this,t)}function z(){h(this,g,I).call(this)}function L(){if(babelHelpers.classPrivateFieldGet(this,f)){babelHelpers.classPrivateFieldGet(this,w).emit("onActualizePopupLayout",{entityId:babelHelpers.classPrivateFieldGet(this,v)});babelHelpers.classPrivateFieldGet(this,f).adjustPosition()}}function j(){setTimeout((()=>{const e=h(this,G,D).call(this);e.adjustPosition({forceBindPosition:true})}),0)}e.AddingPopup=T})(this.BX.Crm.Activity=this.BX.Crm.Activity||{},BX.Crm.Activity,BX,BX.Event,BX.Main,BX.UI,BX);
//# sourceMappingURL=adding-popup.bundle.map.js