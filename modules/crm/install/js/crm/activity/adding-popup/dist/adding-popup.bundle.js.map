{"version":3,"file":"adding-popup.bundle.js","sources":["../src/adding-popup.js"],"sourcesContent":["import {Text, Type} from \"main.core\";\nimport {PopupManager, Popup} from \"main.popup\";\nimport {SaveButton, CancelButton, ButtonColor, ButtonSize, ButtonState} from \"ui.buttons\";\nimport {TodoEditor} from \"crm.activity.todo-editor\";\nimport {BaseEvent, EventEmitter} from \"main.core.events\";\n\nimport \"./adding-popup.css\"\n\n/**\n * @event onSave\n * @event onClose\n */\nexport class AddingPopup\n{\n\t#entityId: Number = null;\n\t#entityTypeId: Number = null;\n\t#popup: ?Popup = null;\n\t#todoEditor: ?TodoEditor = null;\n\t#eventEmitter: EventEmitter = null;\n\n\tconstructor(entityTypeId: Number, entityId: Number, params: Object)\n\t{\n\t\tthis.#entityId = Text.toInteger(entityId);\n\t\tthis.#entityTypeId = Text.toInteger(entityTypeId);\n\n\t\tthis.#eventEmitter = new EventEmitter;\n\t\tthis.#eventEmitter.setEventNamespace('Crm.Activity.AddingPopup');\n\n\t\tif (!Type.isPlainObject(params))\n\t\t{\n\t\t\tparams = {};\n\t\t}\n\n\t\tif (Type.isObject(params.events))\n\t\t{\n\t\t\tfor (const eventName in params.events)\n\t\t\t{\n\t\t\t\tif (Type.isFunction(params.events[eventName]))\n\t\t\t\t{\n\t\t\t\t\tthis.#eventEmitter.subscribe(eventName, params.events[eventName]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tshow(bindElement: HTMLElement)\n\t{\n\t\tconst popup = this.#createPopupIfNotExists();\n\t\tpopup.setBindElement(bindElement);\n\t\tif (popup.isShown())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (!popup.getContentContainer().hasChildNodes())\n\t\t{\n\t\t\t// just created, initialize\n\t\t\tthis.#todoEditor = new TodoEditor({\n\t\t\t\tcontainer: popup.getContentContainer(),\n\t\t\t\townerTypeId: this.#entityTypeId,\n\t\t\t\townerId: this.#entityId,\n\t\t\t\tevents: {\n\t\t\t\t\tonChangeDescription: this.#onChangeEditorDescription.bind(this),\n\t\t\t\t\tonSaveHotkeyPressed: this.#onEditorSaveHotkeyPressed.bind(this)\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tpopup.setButtons([\n\t\t\t\tnew SaveButton({\n\t\t\t\t\tid: 'save',\n\t\t\t\t\tcolor: ButtonColor.PRIMARY,\n\t\t\t\t\tsize: ButtonSize.EXTRA_SMALL,\n\t\t\t\t\tround: true,\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: this.#saveAndClose.bind(this),\n\t\t\t\t\t}\n\t\t\t\t}),\n\t\t\t\tnew CancelButton({\n\t\t\t\t\tid: 'cancel',\n\t\t\t\t\tsize: ButtonSize.EXTRA_SMALL,\n\t\t\t\t\tround: true,\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: () => popup.close(),\n\t\t\t\t\t}\n\t\t\t\t}),\n\t\t\t]);\n\n\t\t\tpopup.subscribeOnce('onFirstShow', () => this.#todoEditor.show());\n\t\t\tpopup.subscribe('onAfterShow', () => {\n\t\t\t\tthis.#actualizePopupLayout(this.#todoEditor.getDescription());\n\t\t\t\tthis.#todoEditor.setFocused();\n\t\t\t});\n\t\t\tpopup.subscribe('onAfterClose', () => {\n\t\t\t\tthis.#todoEditor.resetToDefaults();\n\t\t\t\tthis.#eventEmitter.emit('onClose');\n\t\t\t});\n\t\t}\n\t\tpopup.show();\n\t}\n\n\t#createPopupIfNotExists(): Popup\n\t{\n\t\tif (!this.#popup)\n\t\t{\n\t\t\tthis.#popup = PopupManager.create({\n\t\t\t\tid: `kanban_planner_menu_${this.#entityId}`,\n\t\t\t\toverlay: {\n\t\t\t\t\topacity: 0,\n\t\t\t\t},\n\t\t\t\tisScrollBlock: true,\n\t\t\t\tclassName: 'crm-activity-adding-popup',\n\t\t\t\tcloseByEsc: true,\n\t\t\t\tcloseIcon: false,\n\t\t\t\tangle: {\n\t\t\t\t\toffset: 27,\n\t\t\t\t},\n\t\t\t\tminWidth: 500,\n\t\t\t\tpadding: 16,\n\t\t\t\tminHeight: 150,\n\t\t\t});\n\t\t}\n\n\t\treturn this.#popup;\n\t}\n\n\t#saveAndClose(): void\n\t{\n\t\tif (this.#popup)\n\t\t{\n\t\t\tconst saveButton = this.#popup.getButton('save');\n\t\t\tif (saveButton.getState())\n\t\t\t{\n\t\t\t\treturn; // button is disabled\n\t\t\t}\n\t\t\tsaveButton?.setWaiting(true);\n\t\t\tthis.#todoEditor.save()\n\t\t\t\t.then(() => {\n\t\t\t\t\tthis.#popup.close();\n\t\t\t\t\tthis.#eventEmitter.emit('onSave');\n\t\t\t\t})\n\t\t\t\t.catch(() => {})\n\t\t\t\t.finally(() => saveButton?.setWaiting(false))\n\t\t\t;\n\t\t}\n\t}\n\n\t#actualizePopupLayout(description): void{\n\t\tif (this.#popup && this.#popup.isShown())\n\t\t{\n\t\t\tthis.#popup.adjustPosition({\n\t\t\t\tforceBindPosition: true,\n\t\t\t});\n\n\t\t\tconst saveButton = this.#popup.getButton('save');\n\n\t\t\tif (!description.length && saveButton && !saveButton.getState())\n\t\t\t{\n\t\t\t\tsaveButton.setState(ButtonState.DISABLED);\n\t\t\t}\n\t\t\telse if (description.length && saveButton && saveButton.getState() === ButtonState.DISABLED)\n\t\t\t{\n\t\t\t\tsaveButton.setState(null);\n\t\t\t}\n\t\t}\n\t}\n\n\t#onChangeEditorDescription(event: BaseEvent)\n\t{\n\t\tconst {description} = event.getData();\n\t\tthis.#actualizePopupLayout(description);\n\t}\n\n\t#onEditorSaveHotkeyPressed()\n\t{\n\t\tthis.#saveAndClose();\n\t}\n}\n"],"names":["AddingPopup","entityTypeId","entityId","params","Text","toInteger","EventEmitter","setEventNamespace","Type","isPlainObject","isObject","events","eventName","isFunction","subscribe","bindElement","popup","setBindElement","isShown","getContentContainer","hasChildNodes","TodoEditor","container","ownerTypeId","ownerId","onChangeDescription","bind","onSaveHotkeyPressed","setButtons","SaveButton","id","color","ButtonColor","PRIMARY","size","ButtonSize","EXTRA_SMALL","round","click","CancelButton","close","subscribeOnce","show","getDescription","setFocused","resetToDefaults","emit","PopupManager","create","overlay","opacity","isScrollBlock","className","closeByEsc","closeIcon","angle","offset","minWidth","padding","minHeight","saveButton","getButton","getState","setWaiting","save","then","catch","finally","description","adjustPosition","forceBindPosition","length","setState","ButtonState","DISABLED","event","getData"],"mappings":";;;;;;;;;;;;CAQA;CACA;CACA;CACA;;;;;;;;;;;;;;;;;;;;;;AACA,KAAaA,WAAb;GAQC,qBAAYC,YAAZ,EAAkCC,QAAlC,EAAoDC,MAApD,EACA;KAAA;;KAAA;;KAAA;;KAAA;;KAAA;;KAAA;;KAAA;OAAA;OAAA,OAPoB;;;KAOpB;OAAA;OAAA,OANwB;;;KAMxB;OAAA;OAAA,OALiB;;;KAKjB;OAAA;OAAA,OAJ2B;;;KAI3B;OAAA;OAAA,OAH8B;;;KAI7B,mDAAiBC,cAAI,CAACC,SAAL,CAAeH,QAAf,CAAjB;KACA,uDAAqBE,cAAI,CAACC,SAAL,CAAeJ,YAAf,CAArB;KAEA,uDAAqB,IAAIK,6BAAJ,EAArB;KACA,uDAAmBC,iBAAnB,CAAqC,0BAArC;;KAEA,IAAI,CAACC,cAAI,CAACC,aAAL,CAAmBN,MAAnB,CAAL,EACA;OACCA,MAAM,GAAG,EAAT;;;KAGD,IAAIK,cAAI,CAACE,QAAL,CAAcP,MAAM,CAACQ,MAArB,CAAJ,EACA;OACC,KAAK,MAAMC,SAAX,IAAwBT,MAAM,CAACQ,MAA/B,EACA;SACC,IAAIH,cAAI,CAACK,UAAL,CAAgBV,MAAM,CAACQ,MAAP,CAAcC,SAAd,CAAhB,CAAJ,EACA;WACC,uDAAmBE,SAAnB,CAA6BF,SAA7B,EAAwCT,MAAM,CAACQ,MAAP,CAAcC,SAAd,CAAxC;;;;;;GA3BL;KAAA;KAAA,qBAiCMG,WAjCN,EAkCC;OACC,MAAMC,KAAK,0BAAG,IAAH,0DAAG,IAAH,CAAX;;OACAA,KAAK,CAACC,cAAN,CAAqBF,WAArB;;OACA,IAAIC,KAAK,CAACE,OAAN,EAAJ,EACA;SACC;;;OAGD,IAAI,CAACF,KAAK,CAACG,mBAAN,GAA4BC,aAA5B,EAAL,EACA;;SAEC,qDAAmB,IAAIC,kCAAJ,CAAe;WACjCC,SAAS,EAAEN,KAAK,CAACG,mBAAN,EADsB;WAEjCI,WAAW,oCAAE,IAAF,gBAFsB;WAGjCC,OAAO,oCAAE,IAAF,YAH0B;WAIjCb,MAAM,EAAE;aACPc,mBAAmB,EAAE,sFAAgCC,IAAhC,CAAqC,IAArC,CADd;aAEPC,mBAAmB,EAAE,sFAAgCD,IAAhC,CAAqC,IAArC;;UANJ,CAAnB;SAUAV,KAAK,CAACY,UAAN,CAAiB,CAChB,IAAIC,qBAAJ,CAAe;WACdC,EAAE,EAAE,MADU;WAEdC,KAAK,EAAEC,sBAAW,CAACC,OAFL;WAGdC,IAAI,EAAEC,qBAAU,CAACC,WAHH;WAIdC,KAAK,EAAE,IAJO;WAKd1B,MAAM,EAAE;aACP2B,KAAK,EAAE,4DAAmBZ,IAAnB,CAAwB,IAAxB;;UANT,CADgB,EAUhB,IAAIa,uBAAJ,CAAiB;WAChBT,EAAE,EAAE,QADY;WAEhBI,IAAI,EAAEC,qBAAU,CAACC,WAFD;WAGhBC,KAAK,EAAE,IAHS;WAIhB1B,MAAM,EAAE;aACP2B,KAAK,EAAE,MAAMtB,KAAK,CAACwB,KAAN;;UALf,CAVgB,CAAjB;SAoBAxB,KAAK,CAACyB,aAAN,CAAoB,aAApB,EAAmC,MAAM,qDAAiBC,IAAjB,EAAzC;SACA1B,KAAK,CAACF,SAAN,CAAgB,aAAhB,EAA+B,MAAM;WACpC,uFAA2B,qDAAiB6B,cAAjB,EAA3B;;WACA,qDAAiBC,UAAjB;UAFD;SAIA5B,KAAK,CAACF,SAAN,CAAgB,cAAhB,EAAgC,MAAM;WACrC,qDAAiB+B,eAAjB;WACA,uDAAmBC,IAAnB,CAAwB,SAAxB;UAFD;;;OAKD9B,KAAK,CAAC0B,IAAN;;;GArFF;CAAA;;qCAyFC;GACC,IAAI,mCAAC,IAAD,SAAJ,EACA;KACC,gDAAcK,uBAAY,CAACC,MAAb,CAAoB;OACjClB,EAAE,EAAG,uBAAD,kCAAuB,IAAvB,YAAsC,EADT;OAEjCmB,OAAO,EAAE;SACRC,OAAO,EAAE;QAHuB;OAKjCC,aAAa,EAAE,IALkB;OAMjCC,SAAS,EAAE,2BANsB;OAOjCC,UAAU,EAAE,IAPqB;OAQjCC,SAAS,EAAE,KARsB;OASjCC,KAAK,EAAE;SACNC,MAAM,EAAE;QAVwB;OAYjCC,QAAQ,EAAE,GAZuB;OAajCC,OAAO,EAAE,EAbwB;OAcjCC,SAAS,EAAE;MAdE,CAAd;;;GAkBD,yCAAO,IAAP;CACA;;2BAGD;GACC,sCAAI,IAAJ,WACA;KACC,MAAMC,UAAU,GAAG,gDAAYC,SAAZ,CAAsB,MAAtB,CAAnB;;KACA,IAAID,UAAU,CAACE,QAAX,EAAJ,EACA;OACC,OADD;;;KAGAF,UAAU,SAAV,IAAAA,UAAU,WAAV,YAAAA,UAAU,CAAEG,UAAZ,CAAuB,IAAvB;KACA,qDAAiBC,IAAjB,GACEC,IADF,CACO,MAAM;OACX,gDAAYzB,KAAZ;OACA,uDAAmBM,IAAnB,CAAwB,QAAxB;MAHF,EAKEoB,KALF,CAKQ,MAAM,EALd,EAMEC,OANF,CAMU,MAAMP,UAAN,aAAMA,UAAN,uBAAMA,UAAU,CAAEG,UAAZ,CAAuB,KAAvB,CANhB;;CASD;;iCAEqBK,aAAkB;GACvC,IAAI,mDAAe,gDAAYlD,OAAZ,EAAnB,EACA;KACC,gDAAYmD,cAAZ,CAA2B;OAC1BC,iBAAiB,EAAE;MADpB;KAIA,MAAMV,UAAU,GAAG,gDAAYC,SAAZ,CAAsB,MAAtB,CAAnB;;KAEA,IAAI,CAACO,WAAW,CAACG,MAAb,IAAuBX,UAAvB,IAAqC,CAACA,UAAU,CAACE,QAAX,EAA1C,EACA;OACCF,UAAU,CAACY,QAAX,CAAoBC,sBAAW,CAACC,QAAhC;MAFD,MAIK,IAAIN,WAAW,CAACG,MAAZ,IAAsBX,UAAtB,IAAoCA,UAAU,CAACE,QAAX,OAA0BW,sBAAW,CAACC,QAA9E,EACL;OACCd,UAAU,CAACY,QAAX,CAAoB,IAApB;;;CAGF;;sCAE0BG,OAC3B;GACC,MAAM;KAACP;OAAeO,KAAK,CAACC,OAAN,EAAtB;;GACA,uFAA2BR,WAA3B;CACA;;wCAGD;GACC;CACA;;;;;;;;"}