{"version":3,"file":"adding-popup.bundle.js","sources":["../src/adding-popup.js"],"sourcesContent":["import { Tag, Text, Type} from \"main.core\";\nimport {PopupManager, Popup} from \"main.popup\";\nimport {SaveButton, CancelButton, ButtonColor, ButtonSize, ButtonState} from \"ui.buttons\";\nimport {TodoEditor} from \"crm.activity.todo-editor\";\nimport {BaseEvent, EventEmitter} from \"main.core.events\";\n\nimport \"./adding-popup.css\"\n\n/**\n * @event onSave\n * @event onClose\n */\nexport class AddingPopup\n{\n\t#entityId: Number = null;\n\t#entityTypeId: Number = null;\n\t#popup: ?Popup = null;\n\t#popupContainer: HTMLElement = null;\n\t#todoEditor: ?TodoEditor = null;\n\t#eventEmitter: EventEmitter = null;\n\n\tconstructor(entityTypeId: Number, entityId: Number, params: Object)\n\t{\n\t\tthis.#entityId = Text.toInteger(entityId);\n\t\tthis.#entityTypeId = Text.toInteger(entityTypeId);\n\n\t\tthis.#eventEmitter = new EventEmitter;\n\t\tthis.#eventEmitter.setEventNamespace('Crm.Activity.AddingPopup');\n\n\t\tif (!Type.isPlainObject(params))\n\t\t{\n\t\t\tparams = {};\n\t\t}\n\n\t\tif (Type.isObject(params.events))\n\t\t{\n\t\t\tfor (const eventName in params.events)\n\t\t\t{\n\t\t\t\tif (Type.isFunction(params.events[eventName]))\n\t\t\t\t{\n\t\t\t\t\tthis.#eventEmitter.subscribe(eventName, params.events[eventName]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tshow(bindElement: HTMLElement)\n\t{\n\t\tconst popup = this.#createPopupIfNotExists();\n\t\tpopup.setBindElement(bindElement);\n\t\tif (popup.isShown())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.#popupContainer.hasChildNodes())\n\t\t{\n\t\t\t// just created, initialize\n\t\t\tthis.#todoEditor = new TodoEditor({\n\t\t\t\tcontainer: this.#popupContainer,\n\t\t\t\townerTypeId: this.#entityTypeId,\n\t\t\t\townerId: this.#entityId,\n\t\t\t\tevents: {\n\t\t\t\t\tonChangeDescription: this.#onChangeEditorDescription.bind(this),\n\t\t\t\t\tonSaveHotkeyPressed: this.#onEditorSaveHotkeyPressed.bind(this),\n\t\t\t\t\tonChangeUploaderContainerSize: this.#onChangeUploaderContainerSize.bind(this),\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tpopup.setButtons([\n\t\t\t\tnew SaveButton({\n\t\t\t\t\tid: 'save',\n\t\t\t\t\tcolor: ButtonColor.PRIMARY,\n\t\t\t\t\tsize: ButtonSize.EXTRA_SMALL,\n\t\t\t\t\tround: true,\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: this.#saveAndClose.bind(this),\n\t\t\t\t\t}\n\t\t\t\t}),\n\t\t\t\tnew CancelButton({\n\t\t\t\t\tid: 'cancel',\n\t\t\t\t\tsize: ButtonSize.EXTRA_SMALL,\n\t\t\t\t\tround: true,\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: () => popup.close(),\n\t\t\t\t\t}\n\t\t\t\t}),\n\t\t\t]);\n\n\t\t\tpopup.subscribeOnce('onFirstShow', () => this.#todoEditor.show());\n\t\t\tpopup.subscribe('onAfterShow', () => {\n\t\t\t\tthis.#actualizePopupLayout(this.#todoEditor.getDescription());\n\t\t\t\tthis.#todoEditor.setFocused();\n\t\t\t});\n\t\t\tpopup.subscribe('onAfterClose', () => {\n\t\t\t\tthis.#todoEditor.resetToDefaults();\n\t\t\t\tthis.#eventEmitter.emit('onClose');\n\t\t\t});\n\t\t}\n\t\tpopup.show();\n\t}\n\n\t#createPopupIfNotExists(): Popup\n\t{\n\t\tif (!this.#popup)\n\t\t{\n\t\t\tthis.#popupContainer = Tag.render`<div class=\"crm-activity-adding-popup-container\"></div>`;\n\t\t\tthis.#popup = PopupManager.create({\n\t\t\t\tid: `kanban_planner_menu_${this.#entityId}`,\n\t\t\t\toverlay: {\n\t\t\t\t\topacity: 0,\n\t\t\t\t},\n\t\t\t\tcontent: this.#popupContainer,\n\t\t\t\tisScrollBlock: true,\n\t\t\t\tclassName: 'crm-activity-adding-popup',\n\t\t\t\tcloseByEsc: true,\n\t\t\t\tcloseIcon: false,\n\t\t\t\tangle: {\n\t\t\t\t\toffset: 27,\n\t\t\t\t},\n\t\t\t\tpadding: 16,\n\t\t\t\tminWidth: 500,\n\t\t\t\tmaxWidth: 550,\n\t\t\t\tminHeight: 150,\n\t\t\t\tmaxHeight: 400\n\t\t\t});\n\t\t}\n\n\t\treturn this.#popup;\n\t}\n\n\t#saveAndClose(): void\n\t{\n\t\tif (this.#popup)\n\t\t{\n\t\t\tconst saveButton = this.#popup.getButton('save');\n\t\t\tif (saveButton.getState())\n\t\t\t{\n\t\t\t\treturn; // button is disabled\n\t\t\t}\n\t\t\tsaveButton?.setWaiting(true);\n\t\t\tthis.#todoEditor.save()\n\t\t\t\t.then(() => {\n\t\t\t\t\tthis.#popup.close();\n\t\t\t\t\tthis.#eventEmitter.emit('onSave');\n\t\t\t\t})\n\t\t\t\t.catch(() => {})\n\t\t\t\t.finally(() => saveButton?.setWaiting(false))\n\t\t\t;\n\t\t}\n\t}\n\n\t#actualizePopupLayout(description): void{\n\t\tif (this.#popup && this.#popup.isShown())\n\t\t{\n\t\t\tthis.#popup.adjustPosition({\n\t\t\t\tforceBindPosition: true,\n\t\t\t});\n\n\t\t\tconst saveButton = this.#popup.getButton('save');\n\n\t\t\tif (!description.length && saveButton && !saveButton.getState())\n\t\t\t{\n\t\t\t\tsaveButton.setState(ButtonState.DISABLED);\n\t\t\t}\n\t\t\telse if (description.length && saveButton && saveButton.getState() === ButtonState.DISABLED)\n\t\t\t{\n\t\t\t\tsaveButton.setState(null);\n\t\t\t}\n\t\t}\n\t}\n\n\t#onChangeEditorDescription(event: BaseEvent)\n\t{\n\t\tconst {description} = event.getData();\n\t\tthis.#actualizePopupLayout(description);\n\t}\n\n\t#onEditorSaveHotkeyPressed()\n\t{\n\t\tthis.#saveAndClose();\n\t}\n\n\t#onChangeUploaderContainerSize()\n\t{\n\t\tif (this.#popup)\n\t\t{\n\t\t\tthis.#popup.adjustPosition();\n\t\t}\n\t}\n}\n"],"names":["AddingPopup","entityTypeId","entityId","params","Text","toInteger","EventEmitter","setEventNamespace","Type","isPlainObject","isObject","events","eventName","isFunction","subscribe","bindElement","popup","setBindElement","isShown","hasChildNodes","TodoEditor","container","ownerTypeId","ownerId","onChangeDescription","bind","onSaveHotkeyPressed","onChangeUploaderContainerSize","setButtons","SaveButton","id","color","ButtonColor","PRIMARY","size","ButtonSize","EXTRA_SMALL","round","click","CancelButton","close","subscribeOnce","show","getDescription","setFocused","resetToDefaults","emit","Tag","render","PopupManager","create","overlay","opacity","content","isScrollBlock","className","closeByEsc","closeIcon","angle","offset","padding","minWidth","maxWidth","minHeight","maxHeight","saveButton","getButton","getState","setWaiting","save","then","catch","finally","description","adjustPosition","forceBindPosition","length","setState","ButtonState","DISABLED","event","getData"],"mappings":"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"}