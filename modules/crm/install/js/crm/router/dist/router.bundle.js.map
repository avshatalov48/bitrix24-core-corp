{"version":3,"file":"router.bundle.js","sources":["../src/router.js"],"sourcesContent":["import { Reflection, Type, Uri } from 'main.core';\n\nimport 'sidepanel';\n\nlet instance = null;\n\nclass ListViewTypes\n{\n\tstatic KANBAN = 'KANBAN';\n\tstatic LIST = 'LIST';\n}\n\ndeclare type UrlTemplatesSettings = {\n\tdefaultRootUrlTemplates: UrlTemplates,\n\tcustomRootUrlTemplates: CustomRootUrlTemplates,\n};\n\ndeclare type UrlTemplates = Object<string, string>;\n\ndeclare type CustomRootUrlTemplates = Object<number, UrlTemplates>;\n\n/**\n * @memberOf BX.Crm\n */\nclass Router\n{\n\tdefaultRootUrlTemplates: UrlTemplates = {};\n\tcustomRootUrlTemplates: CustomRootUrlTemplates = {};\n\tcurrentViews: Object<number, string> = {};\n\n\tstatic get Instance(): Router\n\t{\n\t\tif ((window.top !== window) && Reflection.getClass('top.BX.Crm.Router'))\n\t\t{\n\t\t\treturn window.top.BX.Crm.Router.Instance;\n\t\t}\n\n\t\tif (instance === null)\n\t\t{\n\t\t\tinstance = new Router();\n\t\t}\n\n\t\treturn instance;\n\t}\n\n\t/**\n\t * @public\n\t * @param params\n\t * @return {BX.Crm.Router}\n\t */\n\tsetUrlTemplates(params: UrlTemplatesSettings): Router\n\t{\n\t\tif (Type.isPlainObject(params.defaultRootUrlTemplates))\n\t\t{\n\t\t\tthis.defaultRootUrlTemplates = params.defaultRootUrlTemplates;\n\t\t}\n\t\tif (Type.isPlainObject(params.customRootUrlTemplates))\n\t\t{\n\t\t\tthis.customRootUrlTemplates = params.customRootUrlTemplates;\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tsetCurrentListView(entityTypeId: number, view: string): Router\n\t{\n\t\tthis.currentViews[entityTypeId] = view;\n\t\treturn this;\n\t}\n\n\tgetCurrentListView(entityTypeId: number): string\n\t{\n\t\treturn this.currentViews[entityTypeId] || ListViewTypes.LIST;\n\t}\n\n\tstatic openSlider(url, options): Promise<?BX.SidePanel.Slider>\n\t{\n\t\tif (!Type.isPlainObject(options))\n\t\t{\n\t\t\toptions = {};\n\t\t}\n\t\toptions = { ...{ cacheable: false, allowChangeHistory: true, events: {} }, ...options };\n\t\treturn new Promise((resolve) =>\n\t\t{\n\t\t\tif (Type.isString(url) && url.length > 1)\n\t\t\t{\n\t\t\t\toptions.events.onClose = function(event)\n\t\t\t\t{\n\t\t\t\t\tresolve(event.getSlider());\n\t\t\t\t};\n\t\t\t\tBX.SidePanel.Instance.open(url, options);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tresolve();\n\t\t\t}\n\t\t});\n\t}\n\n\topenTypeDetail(typeId: number, options: ?{}): ?Promise<?BX.SidePanel.Slider>\n\t{\n\t\tif (!Type.isPlainObject(options))\n\t\t{\n\t\t\toptions = {};\n\t\t}\n\t\toptions.width = 702;\n\t\tconst uri = this.getTypeDetailUrl(typeId);\n\t\tif (uri)\n\t\t{\n\t\t\treturn Router.openSlider(uri.toString(), options);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * @protected\n\t * @param component\n\t * @param entityTypeId\n\t * @return {string|null}\n\t */\n\tgetTemplate(component: string, entityTypeId: number = 0): ?string\n\t{\n\t\tif ((entityTypeId > 0) && this.customRootUrlTemplates.hasOwnProperty(entityTypeId))\n\t\t{\n\t\t\tif (this.customRootUrlTemplates[entityTypeId].hasOwnProperty(component))\n\t\t\t{\n\t\t\t\treturn this.customRootUrlTemplates[entityTypeId][component];\n\t\t\t}\n\n\t\t\treturn null;\n\t\t}\n\n\t\treturn (this.defaultRootUrlTemplates.hasOwnProperty(component) ? this.defaultRootUrlTemplates[component] : null);\n\t}\n\n\tgetTypeDetailUrl(entityTypeId: number = 0): ?Uri\n\t{\n\t\tconst template = this.getTemplate('bitrix:crm.type.detail', entityTypeId);\n\t\tif (template)\n\t\t{\n\t\t\treturn new Uri(template.replace('#entityTypeId#', entityTypeId));\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tgetTypeListUrl(): ?Uri\n\t{\n\t\tconst template = this.getTemplate('bitrix:crm.type.list');\n\t\tif (template)\n\t\t{\n\t\t\treturn new Uri(template);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\topenTypeHelpPage()\n\t{\n\t\tRouter.openHelper(null, 13315798);\n\t}\n\n\tstatic openHelper(event: Event = null, code: number = null)\n\t{\n\t\tif (event && Type.isFunction(event.preventDefault))\n\t\t{\n\t\t\tevent.preventDefault();\n\t\t}\n\t\tif (top.BX.Helper && code > 0)\n\t\t{\n\t\t\ttop.BX.Helper.show('redirect=detail&code=' + code);\n\t\t}\n\t}\n\n    showFeatureSlider(event, item)\n    {\n        Router.Instance.closeSettingsMenu(event, item);\n        BX.UI.InfoHelper.show('limit_smart_process_automation');\n    }\n\n    /**\n     * For dynamic entities only.\n     * Does not support knowledge about whether kanban available or not.\n     *\n     * @param entityTypeId\n     * @param categoryId\n     */\n    getItemListUrlInCurrentView(entityTypeId: number, categoryId: ?number = 0): ?Uri\n    {\n        const currentListView = this.getCurrentListView(entityTypeId);\n        let template;\n        if (currentListView === ListViewTypes.KANBAN)\n        {\n            template = this.getTemplate('bitrix:crm.kanban', entityTypeId);\n        }\n        else\n        {\n            template = this.getTemplate('bitrix:crm.item.list', entityTypeId);\n        }\n\n        if (template)\n        {\n            return new Uri(template.replace('#entityTypeId#', entityTypeId).replace('#categoryId#', categoryId));\n        }\n\n        return null;\n    }\n\n\t/**\n\t * For factory based entities only.\n\t * Does not support knowledge about whether kanban available or not.\n\t *\n\t * @public\n\t * @param entityTypeId\n\t * @param categoryId\n\t * @return {null|BX.Uri}\n\t */\n\tgetKanbanUrl(entityTypeId: number, categoryId: ?number = 0): ?Uri\n\t{\n\t\tconst template = this.getTemplate('bitrix:crm.item.kanban', entityTypeId);\n\t\tif (template)\n\t\t{\n\t\t\treturn new Uri(template.replace('#entityTypeId#', entityTypeId).replace('#categoryId#', categoryId));\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * For factory based entities only\n\t *\n\t * @public\n\t * @param entityTypeId\n\t * @param categoryId\n\t * @return {null|BX.Uri}\n\t */\n\tgetItemListUrl(entityTypeId: number, categoryId: ?number = 0): ?Uri\n\t{\n\t\tconst template = this.getTemplate('bitrix:crm.item.list', entityTypeId);\n\t\tif (template)\n\t\t{\n\t\t\treturn new Uri(template.replace('#entityTypeId#', entityTypeId).replace('#categoryId#', categoryId));\n\t\t}\n\n\t\treturn null;\n\t}\n\n\topenDocumentSlider(documentId: number): Promise<?BX.SidePanel.Slider>\n\t{\n\t\treturn Router.openSlider(\n\t\t\t'/bitrix/components/bitrix/crm.document.view/slider.php?documentId=' + documentId,\n\t\t\t{\n\t\t\t\twidth: 1060,\n\t\t\t\tloader: '/bitrix/components/bitrix/crm.document.view/templates/.default/images/document_view.svg',\n\t\t\t}\n\t\t);\n\t}\n\n\topenSignDocumentSlider(documentId: number, memberHash: string): Promise<?BX.SidePanel.Slider>\n\t{\n\t\t// todo make a url template\n\t\treturn Router.openSlider(\n\t\t\t'/bitrix/components/bitrix/crm.signdocument.view/slider.php?documentId=' + documentId\n\t\t\t+ '&memberHash=' + memberHash\n\t\t\t,\n\t\t\t{\n\t\t\t\twidth: 1060,\n\t\t\t}\n\t\t);\n\t}\n\n\topenSignDocumentModifySlider(documentId: number): Promise<?BX.SidePanel.Slider>\n\t{\n\t\treturn Router.openSlider(\n\t\t\t'/sign/doc/0/?docId=' + documentId + '&stepId=changePartner&noRedirect=Y'\n\t\t);\n\t}\n\n\topenCalendarEventSlider(eventId: number, isSharing: boolean): Promise<?BX.SidePanel.Slider>\n\t{\n\t\tconst sliderId = 'crm-calendar-slider-' + eventId + '-' + Math.floor(Math.random() * 1000);\n\n\t\treturn new (window.top.BX || window.BX).Calendar.SliderLoader(eventId, {\n\t\t\tsliderId: sliderId,\n\t\t\tisSharing: isSharing\n\t\t}).show();\n\t}\n\n    closeSettingsMenu(event, item)\n    {\n        if(item && Type.isFunction(item.getMenuWindow))\n        {\n            const window = item.getMenuWindow();\n            if(window)\n            {\n                window.close();\n                return;\n            }\n        }\n        const menu = this;\n        if(menu && Type.isFunction(menu.close))\n        {\n            menu.close();\n        }\n    }\n}\n\nexport {\n\tRouter\n};\n"],"names":["instance","ListViewTypes","Router","params","Type","isPlainObject","defaultRootUrlTemplates","customRootUrlTemplates","entityTypeId","view","currentViews","LIST","typeId","options","width","uri","getTypeDetailUrl","openSlider","toString","component","hasOwnProperty","template","getTemplate","Uri","replace","openHelper","event","item","Instance","closeSettingsMenu","BX","UI","InfoHelper","show","categoryId","currentListView","getCurrentListView","KANBAN","documentId","loader","memberHash","eventId","isSharing","sliderId","Math","floor","random","window","top","Calendar","SliderLoader","isFunction","getMenuWindow","close","menu","url","cacheable","allowChangeHistory","events","Promise","resolve","isString","length","onClose","getSlider","SidePanel","open","code","preventDefault","Helper","Reflection","getClass","Crm"],"mappings":"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"}