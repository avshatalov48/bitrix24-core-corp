{"version":3,"file":"router.bundle.js","sources":["../src/router.js"],"sourcesContent":["import { Reflection, Type, Uri } from 'main.core';\n\nimport 'sidepanel';\n\nlet instance = null;\n\nclass ListViewTypes\n{\n\tstatic KANBAN = 'KANBAN';\n\tstatic LIST = 'LIST';\n}\n\ndeclare type UrlTemplatesSettings = {\n\tdefaultRootUrlTemplates: UrlTemplates,\n\tcustomRootUrlTemplates: CustomRootUrlTemplates,\n};\n\ndeclare type UrlTemplates = Object<string, string>;\n\ndeclare type CustomRootUrlTemplates = Object<number, UrlTemplates>;\n\n/**\n * @memberOf BX.Crm\n */\nclass Router\n{\n\tdefaultRootUrlTemplates: UrlTemplates = {};\n\tcustomRootUrlTemplates: CustomRootUrlTemplates = {};\n\tcurrentViews: Object<number, string> = {};\n\n\tstatic get Instance(): Router\n\t{\n\t\tif ((window.top !== window) && Reflection.getClass('top.BX.Crm.Router'))\n\t\t{\n\t\t\treturn window.top.BX.Crm.Router.Instance;\n\t\t}\n\n\t\tif (instance === null)\n\t\t{\n\t\t\tinstance = new Router();\n\t\t}\n\n\t\treturn instance;\n\t}\n\n\t/**\n\t * @public\n\t * @param params\n\t * @return {BX.Crm.Router}\n\t */\n\tsetUrlTemplates(params: UrlTemplatesSettings): Router\n\t{\n\t\tif (Type.isPlainObject(params.defaultRootUrlTemplates))\n\t\t{\n\t\t\tthis.defaultRootUrlTemplates = params.defaultRootUrlTemplates;\n\t\t}\n\t\tif (Type.isPlainObject(params.customRootUrlTemplates))\n\t\t{\n\t\t\tthis.customRootUrlTemplates = params.customRootUrlTemplates;\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tsetCurrentListView(entityTypeId: number, view: string): Router\n\t{\n\t\tthis.currentViews[entityTypeId] = view;\n\t\treturn this;\n\t}\n\n\tgetCurrentListView(entityTypeId: number): string\n\t{\n\t\treturn this.currentViews[entityTypeId] || ListViewTypes.LIST;\n\t}\n\n\tstatic openSlider(url, options): Promise<?BX.SidePanel.Slider>\n\t{\n\t\tif (!Type.isPlainObject(options))\n\t\t{\n\t\t\toptions = {};\n\t\t}\n\t\toptions = { ...{ cacheable: false, allowChangeHistory: true, events: {} }, ...options };\n\t\treturn new Promise((resolve) =>\n\t\t{\n\t\t\tif (Type.isString(url) && url.length > 1)\n\t\t\t{\n\t\t\t\toptions.events.onClose = function(event)\n\t\t\t\t{\n\t\t\t\t\tresolve(event.getSlider());\n\t\t\t\t};\n\t\t\t\tBX.SidePanel.Instance.open(url, options);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tresolve();\n\t\t\t}\n\t\t});\n\t}\n\n\topenTypeDetail(typeId: number, options: ?{}): ?Promise<?BX.SidePanel.Slider>\n\t{\n\t\tif (!Type.isPlainObject(options))\n\t\t{\n\t\t\toptions = {};\n\t\t}\n\t\toptions.width = 702;\n\t\tconst uri = this.getTypeDetailUrl(typeId);\n\t\tif (uri)\n\t\t{\n\t\t\treturn Router.openSlider(uri.toString(), options);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * @protected\n\t * @param component\n\t * @param entityTypeId\n\t * @return {string|null}\n\t */\n\tgetTemplate(component: string, entityTypeId: number = 0): ?string\n\t{\n\t\tif ((entityTypeId > 0) && this.customRootUrlTemplates.hasOwnProperty(entityTypeId))\n\t\t{\n\t\t\tif (this.customRootUrlTemplates[entityTypeId].hasOwnProperty(component))\n\t\t\t{\n\t\t\t\treturn this.customRootUrlTemplates[entityTypeId][component];\n\t\t\t}\n\n\t\t\treturn null;\n\t\t}\n\n\t\treturn (this.defaultRootUrlTemplates.hasOwnProperty(component) ? this.defaultRootUrlTemplates[component] : null);\n\t}\n\n\tgetTypeDetailUrl(entityTypeId: number = 0): ?Uri\n\t{\n\t\tconst template = this.getTemplate('bitrix:crm.type.detail', entityTypeId);\n\t\tif (template)\n\t\t{\n\t\t\treturn new Uri(template.replace('#entityTypeId#', entityTypeId));\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tgetTypeListUrl(): ?Uri\n\t{\n\t\tconst template = this.getTemplate('bitrix:crm.type.list');\n\t\tif (template)\n\t\t{\n\t\t\treturn new Uri(template);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tstatic openHelper(event: Event = null, code: number = null)\n\t{\n\t\tif (event && Type.isFunction(event.preventDefault))\n\t\t{\n\t\t\tevent.preventDefault();\n\t\t}\n\t\tif (top.BX.Helper && code > 0)\n\t\t{\n\t\t\ttop.BX.Helper.show('redirect=detail&code=' + code);\n\t\t}\n\t}\n\n    showFeatureSlider(event, item)\n    {\n        Router.Instance.closeSettingsMenu(event, item);\n        BX.UI.InfoHelper.show('limit_smart_process_automation');\n    }\n\n    /**\n     * For dynamic entities only.\n     * Does not support knowledge about whether kanban available or not.\n     *\n     * @param entityTypeId\n     * @param categoryId\n     */\n    getItemListUrlInCurrentView(entityTypeId: number, categoryId: ?number = 0): ?Uri\n    {\n        const currentListView = this.getCurrentListView(entityTypeId);\n        let template;\n        if (currentListView === ListViewTypes.KANBAN)\n        {\n            template = this.getTemplate('bitrix:crm.kanban', entityTypeId);\n        }\n        else\n        {\n            template = this.getTemplate('bitrix:crm.item.list', entityTypeId);\n        }\n\n        if (template)\n        {\n            return new Uri(template.replace('#entityTypeId#', entityTypeId).replace('#categoryId#', categoryId));\n        }\n\n        return null;\n    }\n\n\t/**\n\t * For factory based entities only.\n\t * Does not support knowledge about whether kanban available or not.\n\t *\n\t * @public\n\t * @param entityTypeId\n\t * @param categoryId\n\t * @return {null|BX.Uri}\n\t */\n\tgetKanbanUrl(entityTypeId: number, categoryId: ?number = 0): ?Uri\n\t{\n\t\tconst template = this.getTemplate('bitrix:crm.item.kanban', entityTypeId);\n\t\tif (template)\n\t\t{\n\t\t\treturn new Uri(template.replace('#entityTypeId#', entityTypeId).replace('#categoryId#', categoryId));\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * For factory based entities only\n\t *\n\t * @public\n\t * @param entityTypeId\n\t * @param categoryId\n\t * @return {null|BX.Uri}\n\t */\n\tgetItemListUrl(entityTypeId: number, categoryId: ?number = 0): ?Uri\n\t{\n\t\tconst template = this.getTemplate('bitrix:crm.item.list', entityTypeId);\n\t\tif (template)\n\t\t{\n\t\t\treturn new Uri(template.replace('#entityTypeId#', entityTypeId).replace('#categoryId#', categoryId));\n\t\t}\n\n\t\treturn null;\n\t}\n\n\topenDocumentSlider(documentId: number): Promise<?BX.SidePanel.Slider>\n\t{\n\t\treturn Router.openSlider(\n\t\t\t'/bitrix/components/bitrix/crm.document.view/slider.php?documentId=' + documentId,\n\t\t\t{\n\t\t\t\twidth: 1060,\n\t\t\t\tloader: '/bitrix/components/bitrix/crm.document.view/templates/.default/images/document_view.svg',\n\t\t\t}\n\t\t);\n\t}\n\n\topenSignDocumentSlider(documentId: number, memberHash: string): Promise<?BX.SidePanel.Slider>\n\t{\n\t\t// todo make a url template\n\t\treturn Router.openSlider(\n\t\t\t'/bitrix/components/bitrix/crm.signdocument.view/slider.php?documentId=' + documentId\n\t\t\t+ '&memberHash=' + memberHash\n\t\t\t,\n\t\t\t{\n\t\t\t\twidth: 1060,\n\t\t\t}\n\t\t);\n\t}\n\n\topenSignDocumentModifySlider(documentId: number): Promise<?BX.SidePanel.Slider>\n\t{\n\t\treturn Router.openSlider(\n\t\t\t'/sign/doc/0/?docId=' + documentId + '&stepId=changePartner&noRedirect=Y'\n\t\t);\n\t}\n\n\topenCalendarEventSlider(eventId: number, isSharing: boolean): Promise<?BX.SidePanel.Slider>\n\t{\n\t\tconst sliderId = 'crm-calendar-slider-' + eventId + '-' + Math.floor(Math.random() * 1000);\n\n\t\treturn new (window.top.BX || window.BX).Calendar.SliderLoader(eventId, {\n\t\t\tsliderId: sliderId,\n\t\t\tisSharing: isSharing\n\t\t}).show();\n\t}\n\n    closeSettingsMenu(event, item)\n    {\n        if(item && Type.isFunction(item.getMenuWindow))\n        {\n            const window = item.getMenuWindow();\n            if(window)\n            {\n                window.close();\n                return;\n            }\n        }\n        const menu = this;\n        if(menu && Type.isFunction(menu.close))\n        {\n            menu.close();\n        }\n    }\n}\n\nexport {\n\tRouter\n};\n"],"names":["instance","ListViewTypes","Router","params","Type","isPlainObject","defaultRootUrlTemplates","customRootUrlTemplates","entityTypeId","view","currentViews","LIST","typeId","options","width","uri","getTypeDetailUrl","openSlider","toString","component","hasOwnProperty","template","getTemplate","Uri","replace","event","item","Instance","closeSettingsMenu","BX","UI","InfoHelper","show","categoryId","currentListView","getCurrentListView","KANBAN","documentId","loader","memberHash","eventId","isSharing","sliderId","Math","floor","random","window","top","Calendar","SliderLoader","isFunction","getMenuWindow","close","menu","url","cacheable","allowChangeHistory","events","Promise","resolve","isString","length","onClose","getSlider","SidePanel","open","code","preventDefault","Helper","Reflection","getClass","Crm"],"mappings":"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"}