{"version":3,"file":"router.bundle.js","sources":["../src/router.js"],"sourcesContent":["import { Reflection, Type, Uri } from 'main.core';\n\nimport 'sidepanel';\n\nlet instance = null;\n\nclass ListViewTypes\n{\n\tstatic KANBAN = 'KANBAN';\n\tstatic LIST = 'LIST';\n}\n\ndeclare type UrlTemplatesSettings = {\n\tdefaultRootUrlTemplates: UrlTemplates,\n\tcustomRootUrlTemplates: CustomRootUrlTemplates,\n};\n\ndeclare type UrlTemplates = Object<string, string>;\n\ndeclare type CustomRootUrlTemplates = Object<number, UrlTemplates>;\n\n/**\n * @memberOf BX.Crm\n */\nclass Router\n{\n\tdefaultRootUrlTemplates: UrlTemplates = {};\n\tcustomRootUrlTemplates: CustomRootUrlTemplates = {};\n\tcurrentViews: Object<number, string> = {};\n\n\tstatic get Instance(): Router\n\t{\n\t\tif ((window.top !== window) && Reflection.getClass('top.BX.Crm.Router'))\n\t\t{\n\t\t\treturn window.top.BX.Crm.Router.Instance;\n\t\t}\n\n\t\tif (instance === null)\n\t\t{\n\t\t\tinstance = new Router();\n\t\t}\n\n\t\treturn instance;\n\t}\n\n\t/**\n\t * @public\n\t * @param params\n\t * @return {BX.Crm.Router}\n\t */\n\tsetUrlTemplates(params: UrlTemplatesSettings): Router\n\t{\n\t\tif (Type.isPlainObject(params.defaultRootUrlTemplates))\n\t\t{\n\t\t\tthis.defaultRootUrlTemplates = params.defaultRootUrlTemplates;\n\t\t}\n\t\tif (Type.isPlainObject(params.customRootUrlTemplates))\n\t\t{\n\t\t\tthis.customRootUrlTemplates = params.customRootUrlTemplates;\n\t\t}\n\n\t\treturn this;\n\t}\n\n\tsetCurrentListView(entityTypeId: number, view: string): Router\n\t{\n\t\tthis.currentViews[entityTypeId] = view;\n\t\treturn this;\n\t}\n\n\tgetCurrentListView(entityTypeId: number): string\n\t{\n\t\treturn this.currentViews[entityTypeId] || ListViewTypes.LIST;\n\t}\n\n\tstatic openSlider(url, options): Promise<?BX.SidePanel.Slider>\n\t{\n\t\tif (!Type.isPlainObject(options))\n\t\t{\n\t\t\toptions = {};\n\t\t}\n\t\toptions = { ...{ cacheable: false, allowChangeHistory: true, events: {} }, ...options };\n\t\treturn new Promise((resolve) =>\n\t\t{\n\t\t\tif (Type.isString(url) && url.length > 1)\n\t\t\t{\n\t\t\t\toptions.events.onClose = function(event)\n\t\t\t\t{\n\t\t\t\t\tresolve(event.getSlider());\n\t\t\t\t};\n\t\t\t\tBX.SidePanel.Instance.open(url, options);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tresolve();\n\t\t\t}\n\t\t});\n\t}\n\n\topenTypeDetail(typeId: number, options: ?{}): ?Promise<?BX.SidePanel.Slider>\n\t{\n\t\tif (!Type.isPlainObject(options))\n\t\t{\n\t\t\toptions = {};\n\t\t}\n\t\toptions.width = 702;\n\t\tconst uri = this.getTypeDetailUrl(typeId);\n\t\tif (uri)\n\t\t{\n\t\t\treturn Router.openSlider(uri.toString(), options);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * @protected\n\t * @param component\n\t * @param entityTypeId\n\t * @return {string|null}\n\t */\n\tgetTemplate(component: string, entityTypeId: number = 0): ?string\n\t{\n\t\tif ((entityTypeId > 0) && this.customRootUrlTemplates.hasOwnProperty(entityTypeId))\n\t\t{\n\t\t\tif (this.customRootUrlTemplates[entityTypeId].hasOwnProperty(component))\n\t\t\t{\n\t\t\t\treturn this.customRootUrlTemplates[entityTypeId][component];\n\t\t\t}\n\n\t\t\treturn null;\n\t\t}\n\n\t\treturn (this.defaultRootUrlTemplates.hasOwnProperty(component) ? this.defaultRootUrlTemplates[component] : null);\n\t}\n\n\tgetTypeDetailUrl(entityTypeId: number = 0): ?Uri\n\t{\n\t\tconst template = this.getTemplate('bitrix:crm.type.detail', entityTypeId);\n\t\tif (template)\n\t\t{\n\t\t\treturn new Uri(template.replace('#entityTypeId#', entityTypeId));\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tgetTypeListUrl(): ?Uri\n\t{\n\t\tconst template = this.getTemplate('bitrix:crm.type.list');\n\t\tif (template)\n\t\t{\n\t\t\treturn new Uri(template);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\topenTypeHelpPage()\n\t{\n\t\tRouter.openHelper(null, 13315798);\n\t}\n\n\tstatic openHelper(event: Event = null, code: number = null)\n\t{\n\t\tif (event && Type.isFunction(event.preventDefault))\n\t\t{\n\t\t\tevent.preventDefault();\n\t\t}\n\t\tif (top.BX.Helper && code > 0)\n\t\t{\n\t\t\ttop.BX.Helper.show('redirect=detail&code=' + code);\n\t\t}\n\t}\n\n    showFeatureSlider(event, item)\n    {\n        Router.Instance.closeSettingsMenu(event, item);\n        BX.UI.InfoHelper.show('limit_smart_process_automation');\n    }\n\n    /**\n     * For dynamic entities only.\n     * Does not support knowledge about whether kanban available or not.\n     *\n     * @param entityTypeId\n     * @param categoryId\n     */\n    getItemListUrlInCurrentView(entityTypeId: number, categoryId: ?number = 0): ?Uri\n    {\n        const currentListView = this.getCurrentListView(entityTypeId);\n        let template;\n        if (currentListView === ListViewTypes.KANBAN)\n        {\n            template = this.getTemplate('bitrix:crm.kanban', entityTypeId);\n        }\n        else\n        {\n            template = this.getTemplate('bitrix:crm.item.list', entityTypeId);\n        }\n\n        if (template)\n        {\n            return new Uri(template.replace('#entityTypeId#', entityTypeId).replace('#categoryId#', categoryId));\n        }\n\n        return null;\n    }\n\n\t/**\n\t * For factory based entities only.\n\t * Does not support knowledge about whether kanban available or not.\n\t *\n\t * @public\n\t * @param entityTypeId\n\t * @param categoryId\n\t * @return {null|BX.Uri}\n\t */\n\tgetKanbanUrl(entityTypeId: number, categoryId: ?number = 0): ?Uri\n\t{\n\t\tconst template = this.getTemplate('bitrix:crm.item.kanban', entityTypeId);\n\t\tif (template)\n\t\t{\n\t\t\treturn new Uri(template.replace('#entityTypeId#', entityTypeId).replace('#categoryId#', categoryId));\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t/**\n\t * For factory based entities only\n\t *\n\t * @public\n\t * @param entityTypeId\n\t * @param categoryId\n\t * @return {null|BX.Uri}\n\t */\n\tgetItemListUrl(entityTypeId: number, categoryId: ?number = 0): ?Uri\n\t{\n\t\tconst template = this.getTemplate('bitrix:crm.item.list', entityTypeId);\n\t\tif (template)\n\t\t{\n\t\t\treturn new Uri(template.replace('#entityTypeId#', entityTypeId).replace('#categoryId#', categoryId));\n\t\t}\n\n\t\treturn null;\n\t}\n\n    closeSettingsMenu(event, item)\n    {\n        if(item && Type.isFunction(item.getMenuWindow))\n        {\n            const window = item.getMenuWindow();\n            if(window)\n            {\n                window.close();\n                return;\n            }\n        }\n        const menu = this;\n        if(menu && Type.isFunction(menu.close))\n        {\n            menu.close();\n        }\n    }\n}\n\nexport {\n\tRouter\n};\n"],"names":["instance","ListViewTypes","Router","params","Type","isPlainObject","defaultRootUrlTemplates","customRootUrlTemplates","entityTypeId","view","currentViews","LIST","typeId","options","width","uri","getTypeDetailUrl","openSlider","toString","component","hasOwnProperty","template","getTemplate","Uri","replace","openHelper","event","item","Instance","closeSettingsMenu","BX","UI","InfoHelper","show","categoryId","currentListView","getCurrentListView","KANBAN","isFunction","getMenuWindow","window","close","menu","url","cacheable","allowChangeHistory","events","Promise","resolve","isString","length","onClose","getSlider","SidePanel","open","code","preventDefault","top","Helper","Reflection","getClass","Crm"],"mappings":"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"}