{"version":3,"file":"item-details-component.bundle.js","sources":["../src/item-details-component.js"],"sourcesContent":["import { ajax as Ajax, Dom, Loc, Reflection, Tag, Text, Type, Uri } from \"main.core\";\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { MessageBox, MessageBoxButtons } from \"ui.dialogs.messagebox\";\nimport { StageFlow } from 'ui.stageflow';\nimport type { StageModelData } from 'crm.stage-model';\nimport { StageModel } from 'crm.stage-model';\nimport { Loader } from \"main.loader\";\nimport { PopupMenu } from \"main.popup\";\n\nexport type ItemDetailsComponentParams = {\n\tentityTypeId: number,\n\tentityTypeName: string,\n\tserviceUrl: string,\n\tid: number,\n\tcategoryId?: number,\n\tcategories?: Category[],\n\terrorTextContainer: HTMLElement,\n\tstages: StageModelData[],\n\tcurrentStageId: number,\n\tmessages: Object,\n\tsignedParameters: ?string,\n\tdocumentButtonParameters: ?Object,\n\tisPageTitleEditable: boolean,\n\tuserFieldCreateUrl: ?string,\n\teditorGuid: ?string,\n\tisStageFlowActive: ?boolean,\n\tpullTag: ?string,\n\tbizprocStarterConfig: ?Object,\n};\n\ndeclare type Category = {\n\tid: string,\n\tcategoryId: number,\n\ttext: string,\n\thref: string,\n};\n\nconst BACKGROUND_COLOR = 'd3d7dc';\n\nexport class ItemDetailsComponent\n{\n\tentityTypeId: number;\n\tentityTypeName: string;\n\tid: number;\n\tcategoryId: ?number = null;\n\tcategories: ?Category[];\n\terrorTextContainer: HTMLElement;\n\tstages: StageModel[];\n\tstageflowChart: StageFlow.Chart;\n\tcurrentStageId: number;\n\tisProgress: boolean;\n\tcontainer: HTMLElement;\n\tmessages: {[code: string]: string};\n\tsignedParameters: ?string;\n\tdocumentButtonParameters: ?Object;\n\tisPageTitleEditable: boolean;\n\tpartialEntityEditor: ?BX.Crm.PartialEditorDialog;\n\tpartialEditorId: ?string;\n\teditorContext: Object;\n\tuserFieldCreateUrl: ?string;\n\teditorGuid: ?string;\n\tisStageFlowActive: ?boolean;\n\tpullTag: ?string;\n\tbizprocStarterConfig: ?Object;\n\n\tconstructor(params: ItemDetailsComponentParams): void\n\t{\n\t\tif(Type.isPlainObject(params))\n\t\t{\n\t\t\tthis.entityTypeId = Text.toInteger(params.entityTypeId);\n\t\t\tthis.entityTypeName = params.entityTypeName;\n\t\t\tthis.id = Text.toInteger(params.id);\n\t\t\tif (BX.Crm.PartialEditorDialog && params.serviceUrl)\n\t\t\t{\n\t\t\t\tthis.partialEditorId = 'partial_editor_' + this.entityTypeId + '_' + this.id;\n\t\t\t\tBX.Crm.PartialEditorDialog.registerEntityEditorUrl(this.entityTypeId, params.serviceUrl);\n\t\t\t}\n\t\t\tif (params.hasOwnProperty('editorContext'))\n\t\t\t{\n\t\t\t\tthis.editorContext = params.editorContext;\n\t\t\t}\n\t\t\tif (params.hasOwnProperty('categoryId'))\n\t\t\t{\n\t\t\t\tthis.categoryId = Text.toInteger(params.categoryId);\n\t\t\t\tthis.categories = params.categories;\n\t\t\t}\n\t\t\tif (Type.isElementNode(params.errorTextContainer))\n\t\t\t{\n\t\t\t\tthis.errorTextContainer = params.errorTextContainer;\n\t\t\t}\n\t\t\tif(Type.isArray(params.stages))\n\t\t\t{\n\t\t\t\tthis.stages = [];\n\t\t\t\tparams.stages.forEach((data) => {\n\t\t\t\t\tthis.stages.push(new StageModel(data));\n\t\t\t\t});\n\t\t\t}\n\t\t\tthis.currentStageId = params.currentStageId;\n\t\t\tthis.messages = params.messages;\n\t\t\tthis.signedParameters = params.signedParameters;\n\t\t\tthis.documentButtonParameters = params.documentButtonParameters;\n\t\t\tthis.userFieldCreateUrl = params.userFieldCreateUrl;\n\t\t\tthis.editorGuid = params.editorGuid;\n\t\t\tthis.isStageFlowActive = params.isStageFlowActive;\n\t\t\tthis.pullTag = params.pullTag;\n\t\t\tthis.bizprocStarterConfig = params.bizprocStarterConfig;\n\n\t\t\tthis.isPageTitleEditable = Boolean(params.isPageTitleEditable);\n\t\t}\n\n\t\tthis.container = document.querySelector('[data-role=\"crm-item-detail-container\"]');\n\t\tthis.handleClosePartialEntityEditor = this.handleClosePartialEntityEditor.bind(this);\n\t\tthis.handleErrorPartialEntityEditor = this.handleErrorPartialEntityEditor.bind(this);\n\t}\n\n\tgetCurrentCategory(): ?Category\n\t{\n\t\tlet currentCategory = null\n\t\tif(this.categories && this.categoryId)\n\t\t{\n\t\t\tthis.categories.forEach((category) => {\n\t\t\t\tif(category.categoryId === this.categoryId)\n\t\t\t\t{\n\t\t\t\t\tcurrentCategory = category;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn currentCategory;\n\t}\n\n\tgetLoader()\n\t{\n\t\tif(!this.loader)\n\t\t{\n\t\t\tthis.loader = new Loader({\n\t\t\t\tsize: 200,\n\t\t\t\toffset: {\n\t\t\t\t\tleft: '-100px',\n\t\t\t\t\ttop: '-200px',\n\t\t\t\t}\n\t\t\t});\n\t\t\tthis.loader.layout.style.zIndex = 300;\n\t\t}\n\n\t\treturn this.loader;\n\t}\n\n\tstartProgress()\n\t{\n\t\tthis.isProgress = true;\n\t\tif(!this.getLoader().isShown() && this.container)\n\t\t{\n\t\t\tthis.getLoader().show(this.container);\n\t\t}\n\t\tthis.hideErrors();\n\t}\n\n\tstopProgress()\n\t{\n\t\tthis.isProgress = false;\n\t\tthis.getLoader().hide();\n\t}\n\n\tgetStageById(id: number): ?StageModel\n\t{\n\t\tlet result = null;\n\t\tlet key = 0;\n\t\twhile(true)\n\t\t{\n\t\t\tif(!this.stages[key])\n\t\t\t{\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tconst stage = this.stages[key];\n\t\t\tif(stage.getId() === id)\n\t\t\t{\n\t\t\t\tresult = stage;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tkey++;\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tgetStageByStatusId(statusId: string): ?StageModel\n\t{\n\t\tlet result = null;\n\t\tlet key = 0;\n\t\twhile(true)\n\t\t{\n\t\t\tif(!this.stages[key])\n\t\t\t{\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tconst stage = this.stages[key];\n\t\t\tif(stage.getStatusId() === statusId)\n\t\t\t{\n\t\t\t\tresult = stage;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tkey++;\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tinit(): void\n\t{\n\t\tthis.initStageFlow();\n\t\tthis.bindEvents();\n\t\tthis.initDocumentButton();\n\t\tif (this.id > 0)\n\t\t{\n\t\t\tthis.initPageTitleButtons();\n\t\t\tthis.initPull();\n\t\t}\n\t}\n\n\tinitDocumentButton(): void\n\t{\n\t\tif(\n\t\t\tType.isPlainObject(this.documentButtonParameters)\n\t\t\t&& this.documentButtonParameters.buttonId\n\t\t\t&& BX.DocumentGenerator\n\t\t\t&& BX.DocumentGenerator.Button\n\t\t)\n\t\t{\n\t\t\tthis.documentButton = new BX.DocumentGenerator.Button(this.documentButtonParameters.buttonId, this.documentButtonParameters);\n\t\t\tthis.documentButton.init();\n\t\t}\n\t}\n\n\tinitPageTitleButtons(): void\n\t{\n\t\tconst pageTitleButtons = Tag.render`\n\t\t\t<span id=\"pagetitle_btn_wrapper\" class=\"pagetitile-button-container\">\n\t\t\t\t<span id=\"page_url_copy_btn\" class=\"crm-page-link-btn\"></span>\n\t\t\t</span>\n\t\t`;\n\n\t\tif (this.isPageTitleEditable)\n\t\t{\n\t\t\tconst editButton = Tag.render`\n\t\t\t\t<span id=\"pagetitle_edit\" class=\"pagetitle-edit-button\"></span>\n\t\t\t`;\n\t\t\tDom.prepend(editButton, pageTitleButtons);\n\t\t}\n\n\t\tconst pageTitle = document.getElementById('pagetitle');\n\t\tDom.insertAfter(pageTitleButtons, pageTitle);\n\n\t\tif(Type.isArray(this.categories) && this.categories.length > 0)\n\t\t{\n\t\t\tconst currentCategory = this.getCurrentCategory();\n\t\t\tif(currentCategory)\n\t\t\t{\n\t\t\t\tconst categoriesSelector = Tag.render`\n\t\t\t\t\t<div id=\"pagetitle_sub\" class=\"pagetitle-sub\">\n\t\t\t\t\t\t<a href=\"#\" onclick=\"${this.onCategorySelectorClick.bind(this)}\">${currentCategory.text}</a>\n\t\t\t\t\t</div>\n\t\t\t\t`;\n\n\t\t\t\tDom.insertAfter(categoriesSelector, pageTitleButtons);\n\t\t\t}\n\t\t}\n\t}\n\n\tonCategorySelectorClick(event)\n\t{\n\t\tif(!this.categoryId || !this.categories)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst notCurrentCategories = this.categories.filter((category) => {\n\t\t\treturn category.categoryId !== this.categoryId;\n\t\t});\n\t\tnotCurrentCategories.forEach((category) => {\n\t\t\tdelete category.href;\n\t\t\tcategory.onclick = () => {\n\t\t\t\tthis.onCategorySelect(category.categoryId);\n\t\t\t}\n\t\t});\n\n\t\tPopupMenu.show({\n\t\t\tid: 'item-detail-' + this.entityTypeId + '-' + this.id,\n\t\t\tbindElement: event.target,\n\t\t\titems: notCurrentCategories\n\t\t});\n\t}\n\n\tonCategorySelect(categoryId)\n\t{\n\t\tif(this.isProgress)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tthis.startProgress();\n\t\tAjax.runAction('crm.controller.item.update', {\n\t\t\tanalyticsLabel: 'crmItemDetailsChangeCategory',\n\t\t\tdata: {\n\t\t\t\tentityTypeId: this.entityTypeId,\n\t\t\t\tid: this.id,\n\t\t\t\tfields: {\n\t\t\t\t\tcategoryId\n\t\t\t\t}\n\t\t\t}\n\t\t}).then( () => {\n\t\t\tsetTimeout(() => {\n\t\t\t\t//todo what if editor is changed ?\n\t\t\t\twindow.location.reload();\n\t\t\t}, 500);\n\t\t}).catch(this.showErrorsFromResponse.bind(this))\n\t}\n\n\tinitStageFlow()\n\t{\n\t\tif(this.stages)\n\t\t{\n\t\t\tconst flowStagesData = this.prepareStageFlowStagesData();\n\t\t\tconst stageFlowContainer = document.querySelector('[data-role=\"stageflow-wrap\"]');\n\t\t\tif(stageFlowContainer)\n\t\t\t{\n\t\t\t\tthis.stageflowChart = new StageFlow.Chart({\n\t\t\t\t\tbackgroundColor: BACKGROUND_COLOR,\n\t\t\t\t\tcurrentStage: this.currentStageId,\n\t\t\t\t\tisActive: this.isStageFlowActive === true,\n\t\t\t\t\tonStageChange: this.onStageChange.bind(this),\n\t\t\t\t\tlabels: {\n\t\t\t\t\t\tfinalStageName: Loc.getMessage('CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_NAME'),\n\t\t\t\t\t\tfinalStagePopupTitle: Loc.getMessage('CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_POPUP'),\n\t\t\t\t\t\tfinalStagePopupFail: Loc.getMessage('CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_POPUP_FAIL'),\n\t\t\t\t\t\tfinalStageSelectorTitle: Loc.getMessage('CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_SELECTOR'),\n\t\t\t\t\t},\n\t\t\t\t}, flowStagesData);\n\t\t\t\tstageFlowContainer.appendChild(this.stageflowChart.render());\n\t\t\t}\n\t\t}\n\t}\n\n\tprepareStageFlowStagesData(): Array\n\t{\n\t\tconst flowStagesData = [];\n\t\tconst isNew = (this.id <= 0);\n\t\tthis.stages.forEach((stage: StageModel) => {\n\t\t\tconst data = stage.getData();\n\t\t\tlet color = (stage.getColor().indexOf('#') === 0) ? stage.getColor().substr(1) : stage.getColor();\n\t\t\tif(isNew)\n\t\t\t{\n\t\t\t\tcolor = BACKGROUND_COLOR;\n\t\t\t}\n\t\t\tdata.isSuccess = stage.isSuccess();\n\t\t\tdata.isFail = stage.isFailure();\n\t\t\tdata.color = color;\n\t\t\tflowStagesData.push(data);\n\t\t});\n\n\t\treturn flowStagesData;\n\t}\n\n\tbindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('BX.Crm.ItemDetailsComponent:onClickDelete', this.handleItemDelete.bind(this));\n\t\tif (this.bizprocStarterConfig)\n\t\t{\n\t\t\tEventEmitter.subscribe(\n\t\t\t\t'BX.Crm.ItemDetailsComponent:onClickBizprocTemplates',\n\t\t\t\tthis.handleBPTemplatesShow.bind(this),\n\t\t\t);\n\t\t}\n\t\tif (this.editorGuid && this.userFieldCreateUrl && BX.SidePanel && BX.Crm.EntityEditor)\n\t\t{\n\t\t\tEventEmitter.subscribe(\n\t\t\t\t'BX.UI.EntityConfigurationManager:onCreateClick',\n\t\t\t\tthis.handleUserFieldCreationUrlClick.bind(this)\n\t\t\t);\n\t\t}\n\t}\n\n\tinitPull()\n\t{\n\t\tconst Pull = BX.PULL;\n\t\tif (!Pull)\n\t\t{\n\t\t\tconsole.error('pull is not initialized');\n\t\t\treturn;\n\t\t}\n\t\tif (!this.pullTag)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tPull.subscribe({\n\t\t\tmoduleId: 'crm',\n\t\t\tcommand: this.pullTag,\n\t\t\tcallback: (params) => {\n\t\t\t\tif (params && params.item && params.item.data)\n\t\t\t\t{\n\t\t\t\t\tconst columnId = params.item.data.columnId;\n\t\t\t\t\tif (this.stageflowChart && this.stageflowChart.isActive)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst currentStage = this.getStageById(this.stageflowChart.currentStage);\n\t\t\t\t\t\tif (currentStage && currentStage.statusId !== columnId)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tconst newStage = this.getStageByStatusId(columnId);\n\t\t\t\t\t\t\tif (newStage)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.updateStage(newStage);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\t\tPull.extendWatch(this.pullTag);\n\t}\n\n\tgetEditor(): ?BX.Crm.EntityEditor\n\t{\n\t\tif (BX.Crm.EntityEditor)\n\t\t{\n\t\t\tif (this.editorGuid)\n\t\t\t{\n\t\t\t\treturn BX.Crm.EntityEditor.get(this.editorGuid);\n\t\t\t}\n\n\t\t\treturn BX.Crm.EntityEditor.getDefault();\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tbindPartialEntityEditorEvents()\n\t{\n\t\tEventEmitter.subscribe('Crm.PartialEditorDialog.Close', this.handleClosePartialEntityEditor);\n\t\tEventEmitter.subscribe('Crm.PartialEditorDialog.Error', this.handleErrorPartialEntityEditor);\n\t}\n\n\tunBindPartialEntityEditorEvents()\n\t{\n\t\tEventEmitter.unsubscribe('Crm.PartialEditorDialog.Close', this.handleClosePartialEntityEditor);\n\t\tEventEmitter.unsubscribe('Crm.PartialEditorDialog.Error', this.handleErrorPartialEntityEditor);\n\t}\n\n\tonStageChange(stageFlowStage: StageFlow.Stage)\n\t{\n\t\tif(this.isProgress)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tconst stage = this.getStageById(stageFlowStage.getId());\n\t\tif(!stage)\n\t\t{\n\t\t\tconsole.error('Wrong stage');\n\t\t\treturn;\n\t\t}\n\t\tthis.startProgress();\n\t\tAjax.runAction('crm.controller.item.update', {\n\t\t\tanalyticsLabel: 'crmItemDetailsMoveItem',\n\t\t\tdata: {\n\t\t\t\tentityTypeId: this.entityTypeId,\n\t\t\t\tid: this.id,\n\t\t\t\tfields: {\n\t\t\t\t\tstageId: stage.getStatusId()\n\t\t\t\t}\n\t\t\t}\n\t\t}).then( () => {\n\t\t\tthis.stopProgress();\n\n\t\t\tlet currentSlider: ?BX.SidePanel.Slider = null;\n\t\t\tif (Reflection.getClass('BX.SidePanel.Instance.getTopSlider'))\n\t\t\t{\n\t\t\t\tcurrentSlider = BX.SidePanel.Instance.getTopSlider();\n\t\t\t}\n\t\t\tif (currentSlider !== null)\n\t\t\t{\n\t\t\t\tif (Reflection.getClass('BX.Crm.EntityEvent'))\n\t\t\t\t{\n\t\t\t\t\tlet eventParams = null;\n\t\t\t\t\tif(currentSlider)\n\t\t\t\t\t{\n\t\t\t\t\t\teventParams = { \"sliderUrl\": currentSlider.getUrl() };\n\t\t\t\t\t}\n\t\t\t\t\tBX.Crm.EntityEvent.fireUpdate(this.entityTypeId, this.id, '', eventParams);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.updateStage(stage);\n\t\t}).catch((response) => {\n\t\t\tthis.stopProgress();\n\n\t\t\tif (!this.partialEditorId)\n\t\t\t{\n\t\t\t\tthis.showErrorsFromResponse(response);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst requiredFields = [];\n\t\t\tresponse.errors.forEach(({code, customData}) => {\n\t\t\t\tif (code === 'CRM_FIELD_ERROR_REQUIRED' && customData.fieldName)\n\t\t\t\t{\n\t\t\t\t\trequiredFields.push(customData.fieldName);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif(requiredFields.length > 0)\n\t\t\t{\n\t\t\t\tBX.Crm.PartialEditorDialog.close(this.partialEditorId);\n\n\t\t\t\tthis.partialEntityEditor = BX.Crm.PartialEditorDialog.create(\n\t\t\t\t\tthis.partialEditorId,\n\t\t\t\t\t{\n\t\t\t\t\t\ttitle: BX.prop.getString(this.messages, \"partialEditorTitle\", \"Please fill in all required fields\"),\n\t\t\t\t\t\tentityTypeName: this.entityTypeName,\n\t\t\t\t\t\tentityTypeId: this.entityTypeId,\n\t\t\t\t\t\tentityId: this.id,\n\t\t\t\t\t\tfieldNames: requiredFields,\n\t\t\t\t\t\thelpData: null,\n\t\t\t\t\t\tcontext: this.editorContext || null,\n\t\t\t\t\t\tisController: true,\n\t\t\t\t\t\tstageId: stage.getStatusId(),\n\t\t\t\t\t}\n\t\t\t\t);\n\n\t\t\t\tthis.bindPartialEntityEditorEvents();\n\t\t\t\tthis.partialEntityEditor.open();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.showErrorsFromResponse(response);\n\t\t\t}\n\t\t})\n\t}\n\n\tupdateStage(stage: StageModel)\n\t{\n\t\tconst currentStage = this.getStageById(this.stageflowChart.currentStage);\n\t\tthis.stageflowChart.setCurrentStageId(stage.getId());\n\t\tEventEmitter.emit(\n\t\t\t'BX.Crm.ItemDetailsComponent:onStageChange',\n\t\t\t{\n\t\t\t\tentityTypeId: this.entityTypeId,\n\t\t\t\tid: this.id,\n\t\t\t\tstageId: stage.getStatusId(),\n\t\t\t\tpreviousStageId: currentStage ? currentStage.getStatusId() : null,\n\t\t\t}\n\t\t);\n\t}\n\n\tshowError(error: string): void\n\t{\n\t\tif (Type.isElementNode(this.errorTextContainer))\n\t\t{\n\t\t\tthis.errorTextContainer.innerText = error;\n\t\t\tthis.errorTextContainer.parentElement.style.display = 'block';\n\t\t}\n\t\telse\n\t\t{\n\t\t\tconsole.error(error);\n\t\t}\n\t}\n\n\tshowErrors(errors: string[]): void\n\t{\n\t\tlet severalErrorsText = '';\n\t\terrors.forEach((message) => {\n\t\t\tseveralErrorsText = severalErrorsText + message + ' ';\n\t\t});\n\n\t\tthis.showError(severalErrorsText);\n\t}\n\n\thideErrors(): void\n\t{\n\t\tif (Type.isElementNode(this.errorTextContainer))\n\t\t{\n\t\t\tthis.errorTextContainer.innerText = '';\n\t\t\tthis.errorTextContainer.parentElement.style.display = 'none';\n\t\t}\n\t}\n\n\tshowErrorsFromResponse({errors}): void\n\t{\n\t\tthis.stopProgress();\n\t\tconst messages = [];\n\t\terrors.forEach(({message}) => messages.push(message));\n\t\tthis.showErrors(messages);\n\t}\n\n\tnormalizeUrl(url: Uri): Uri\n\t{\n\t\t// Allow redirects only in the current domain\n\t\treturn url.setHost('');\n\t}\n\n\t// region EventHandlers\n\thandleItemDelete(): void\n\t{\n\t\tif(this.isProgress)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tMessageBox.show({\n\t\t\ttitle: this.messages.deleteItemTitle,\n\t\t\tmessage: this.messages.deleteItemMessage,\n\t\t\tmodal: true,\n\t\t\tbuttons: MessageBoxButtons.YES_CANCEL,\n\t\t\tonYes: (messageBox) => {\n\t\t\t\tthis.startProgress();\n\t\t\t\tAjax.runAction(\n\t\t\t\t\t'crm.controller.item.delete', {\n\t\t\t\t\t\tanalyticsLabel: 'crmItemDetailsDeleteItem',\n\t\t\t\t\t\tdata:\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tentityTypeId: this.entityTypeId,\n\t\t\t\t\t\t\t\tid: this.id,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t}).then( ({data}) => {\n\t\t\t\t\tthis.stopProgress();\n\n\t\t\t\t\tlet currentSlider: ?BX.SidePanel.Slider = null;\n\t\t\t\t\tif (Reflection.getClass('BX.SidePanel.Instance.getTopSlider'))\n\t\t\t\t\t{\n\t\t\t\t\t\tcurrentSlider = BX.SidePanel.Instance.getTopSlider();\n\t\t\t\t\t}\n\n\t\t\t\t\tif (currentSlider !== null)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (Reflection.getClass('BX.Crm.EntityEvent'))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet eventParams = null;\n\t\t\t\t\t\t\tif(currentSlider)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\teventParams = { \"sliderUrl\": currentSlider.getUrl() };\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tBX.Crm.EntityEvent.fireDelete(this.entityTypeId, this.id, '', eventParams);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcurrentSlider.close();\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tconst link = data.redirectUrl;\n\t\t\t\t\t\tif (Type.isStringFilled(link))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tconst url = this.normalizeUrl(new Uri(link));\n\t\t\t\t\t\t\tlocation.href = url.toString();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}).catch(this.showErrorsFromResponse.bind(this));\n\n\t\t\t\tmessageBox.close();\n\t\t\t}\n\t\t});\n\t}\n\n\thandleBPTemplatesShow(event)\n\t{\n\t\tconst starter = new BX.Bizproc.Starter(this.bizprocStarterConfig);\n\t\tstarter.showTemplatesMenu(event.data.button.button);\n\t}\n\n\thandleClosePartialEntityEditor(event: BaseEvent)\n\t{\n\t\tthis.unBindPartialEntityEditorEvents();\n\t\tthis.stopProgress();\n\n\t\tconst data = event.getData();\n\t\tif(Type.isArray(data) && data.length === 2)\n\t\t{\n\t\t\tconst parameters = data[1];\n\n\t\t\tif(parameters.isCancelled)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst stage = this.getStageByStatusId(parameters.stageId);\n\t\t\tif(!stage)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.updateStage(stage);\n\t\t}\n\t}\n\n\thandleErrorPartialEntityEditor(event: BaseEvent)\n\t{\n\t\tthis.unBindPartialEntityEditorEvents();\n\n\t\tthis.stopProgress();\n\n\t\tconst data = event.getData();\n\t\tif(Type.isArray(data) && data[1] && Type.isArray(data[1].errors))\n\t\t{\n\t\t\tthis.showErrorsFromResponse({errors: data[1].errors});\n\t\t}\n\t}\n\n\thandleUserFieldCreationUrlClick(event: BaseEvent)\n\t{\n\t\tconst data = event.getData();\n\t\tif (data.hasOwnProperty('isCanceled'))\n\t\t{\n\t\t\tevent.setData({ ...data, ...{isCanceled: true}});\n\t\t\tBX.SidePanel.Instance.open(this.userFieldCreateUrl, {\n\t\t\t\tallowChangeHistory: false,\n\t\t\t\tcacheable: false,\n\t\t\t\tevents: {\n\t\t\t\t\tonClose: this.onCreateUserFieldSliderClose.bind(this)\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tonCreateUserFieldSliderClose(event: BX.SidePanel.Event)\n\t{\n\t\tconst slider = event.getSlider();\n\t\tconst sliderData = slider.getData();\n\t\tconst userFieldData = sliderData.get('userFieldData');\n\t\tif (userFieldData && Type.isString(userFieldData))\n\t\t{\n\t\t\tthis.reloadPageIfNotChanged();\n\t\t}\n\t}\n\t//endregion\n\n\treloadPageIfNotChanged()\n\t{\n\t\tconst editor = this.getEditor();\n\t\tif (editor)\n\t\t{\n\t\t\tif(editor.isChanged())\n\t\t\t{\n\t\t\t\tMessageBox.alert(this.messages.onCreateUserFieldAddMessage);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\twindow.location.reload();\n\t\t\t}\n\t\t}\n\t}\n}\n"],"names":["BACKGROUND_COLOR","ItemDetailsComponent","params","Type","isPlainObject","entityTypeId","Text","toInteger","entityTypeName","id","BX","Crm","PartialEditorDialog","serviceUrl","partialEditorId","registerEntityEditorUrl","hasOwnProperty","editorContext","categoryId","categories","isElementNode","errorTextContainer","isArray","stages","forEach","data","push","StageModel","currentStageId","messages","signedParameters","documentButtonParameters","userFieldCreateUrl","editorGuid","isStageFlowActive","pullTag","bizprocStarterConfig","isPageTitleEditable","Boolean","container","document","querySelector","handleClosePartialEntityEditor","bind","handleErrorPartialEntityEditor","currentCategory","category","loader","Loader","size","offset","left","top","layout","style","zIndex","isProgress","getLoader","isShown","show","hideErrors","hide","result","key","stage","getId","statusId","getStatusId","initStageFlow","bindEvents","initDocumentButton","initPageTitleButtons","initPull","buttonId","DocumentGenerator","Button","documentButton","init","pageTitleButtons","Tag","render","editButton","Dom","prepend","pageTitle","getElementById","insertAfter","length","getCurrentCategory","categoriesSelector","onCategorySelectorClick","text","event","notCurrentCategories","filter","href","onclick","onCategorySelect","PopupMenu","bindElement","target","items","startProgress","Ajax","runAction","analyticsLabel","fields","then","setTimeout","window","location","reload","showErrorsFromResponse","flowStagesData","prepareStageFlowStagesData","stageFlowContainer","stageflowChart","StageFlow","Chart","backgroundColor","currentStage","isActive","onStageChange","labels","finalStageName","Loc","getMessage","finalStagePopupTitle","finalStagePopupFail","finalStageSelectorTitle","appendChild","isNew","getData","color","getColor","indexOf","substr","isSuccess","isFail","isFailure","EventEmitter","subscribe","handleItemDelete","handleBPTemplatesShow","SidePanel","EntityEditor","handleUserFieldCreationUrlClick","Pull","PULL","console","error","moduleId","command","callback","item","columnId","getStageById","newStage","getStageByStatusId","updateStage","extendWatch","get","getDefault","unsubscribe","stageFlowStage","stageId","stopProgress","currentSlider","Reflection","getClass","Instance","getTopSlider","eventParams","getUrl","EntityEvent","fireUpdate","response","requiredFields","errors","code","customData","fieldName","close","partialEntityEditor","create","title","prop","getString","entityId","fieldNames","helpData","context","isController","bindPartialEntityEditorEvents","open","setCurrentStageId","emit","previousStageId","innerText","parentElement","display","severalErrorsText","message","showError","showErrors","url","setHost","MessageBox","deleteItemTitle","deleteItemMessage","modal","buttons","MessageBoxButtons","YES_CANCEL","onYes","messageBox","fireDelete","link","redirectUrl","isStringFilled","normalizeUrl","Uri","toString","starter","Bizproc","Starter","showTemplatesMenu","button","unBindPartialEntityEditorEvents","parameters","isCancelled","setData","isCanceled","allowChangeHistory","cacheable","events","onClose","onCreateUserFieldSliderClose","slider","getSlider","sliderData","userFieldData","isString","reloadPageIfNotChanged","editor","getEditor","isChanged","alert","onCreateUserFieldAddMessage"],"mappings":"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"}