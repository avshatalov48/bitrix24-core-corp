this.BX=this.BX||{};(function(t,e,i,r,a,n,s,o,l){"use strict";var d,u,c;function h(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,r)}return i}function g(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?h(Object(i),!0).forEach((function(e){babelHelpers.defineProperty(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):h(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}var y="d3d7dc";var f=function(){function t(e){var a=this;babelHelpers.classCallCheck(this,t);babelHelpers.defineProperty(this,"categoryId",null);babelHelpers.defineProperty(this,"receiversJSONString","");if(r.Type.isPlainObject(e)){this.entityTypeId=r.Text.toInteger(e.entityTypeId);this.entityTypeName=e.entityTypeName;this.id=r.Text.toInteger(e.id);if(BX.Crm.PartialEditorDialog&&e.serviceUrl){this.partialEditorId="partial_editor_"+this.entityTypeId+"_"+this.id;BX.Crm.PartialEditorDialog.registerEntityEditorUrl(this.entityTypeId,e.serviceUrl)}if(e.hasOwnProperty("editorContext")){this.editorContext=e.editorContext}if(e.hasOwnProperty("categoryId")){this.categoryId=r.Text.toInteger(e.categoryId);this.categories=e.categories}if(r.Type.isElementNode(e.errorTextContainer)){this.errorTextContainer=e.errorTextContainer}if(r.Type.isArray(e.stages)){this.stages=[];e.stages.forEach((function(t){a.stages.push(new i.StageModel(t))}))}this.currentStageId=e.currentStageId;this.messages=e.messages;this.signedParameters=e.signedParameters;this.documentButtonParameters=e.documentButtonParameters;this.userFieldCreateUrl=e.userFieldCreateUrl;this.editorGuid=e.editorGuid;this.isStageFlowActive=e.isStageFlowActive;this.pullTag=e.pullTag;this.bizprocStarterConfig=e.bizprocStarterConfig;this.automationCheckAutomationTourGuideData=r.Type.isPlainObject(e.automationCheckAutomationTourGuideData)?e.automationCheckAutomationTourGuideData:null;if(r.Type.isString(e.receiversJSONString)){this.receiversJSONString=e.receiversJSONString}this.isPageTitleEditable=Boolean(e.isPageTitleEditable)}this.container=document.querySelector('[data-role="crm-item-detail-container"]');this.handleClosePartialEntityEditor=this.handleClosePartialEntityEditor.bind(this);this.handleErrorPartialEntityEditor=this.handleErrorPartialEntityEditor.bind(this)}babelHelpers.createClass(t,[{key:"getCurrentCategory",value:function t(){var e=this;var i=null;if(this.categories&&this.categoryId){this.categories.forEach((function(t){if(t.categoryId===e.categoryId){i=t}}))}return i}},{key:"getLoader",value:function t(){if(!this.loader){this.loader=new n.Loader({size:200,offset:{left:"-100px",top:"-200px"}});this.loader.layout.style.zIndex=300}return this.loader}},{key:"startProgress",value:function t(){this.isProgress=true;if(!this.getLoader().isShown()&&this.container){this.getLoader().show(this.container)}this.hideErrors()}},{key:"stopProgress",value:function t(){this.isProgress=false;this.getLoader().hide()}},{key:"getStageById",value:function t(e){var i=null;var r=0;while(true){if(!this.stages[r]){break}var a=this.stages[r];if(a.getId()===e){i=a;break}r++}return i}},{key:"getStageByStatusId",value:function t(e){var i=null;var r=0;while(true){if(!this.stages[r]){break}var a=this.stages[r];if(a.getStatusId()===e){i=a;break}r++}return i}},{key:"init",value:function t(){this.initStageFlow();this.bindEvents();this.initDocumentButton();this.initReceiversRepository();if(this.id>0){this.initPageTitleButtons();this.initPull();this.initTours()}}},{key:"initDocumentButton",value:function t(){if(r.Type.isPlainObject(this.documentButtonParameters)&&this.documentButtonParameters.buttonId&&BX.DocumentGenerator&&BX.DocumentGenerator.Button){this.documentButton=new BX.DocumentGenerator.Button(this.documentButtonParameters.buttonId,this.documentButtonParameters);this.documentButton.init()}}},{key:"initReceiversRepository",value:function t(){e.ReceiverRepository.onDetailsLoad(this.entityTypeId,this.id,this.receiversJSONString)}},{key:"initPageTitleButtons",value:function t(){var e=r.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<span id="pagetitle_btn_wrapper" class="pagetitile-button-container">\n\t\t\t\t<span id="page_url_copy_btn" class="crm-page-link-btn"></span>\n\t\t\t</span>\n\t\t'])));if(this.isPageTitleEditable){var i=r.Tag.render(u||(u=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span id="pagetitle_edit" class="pagetitle-edit-button"></span>\n\t\t\t'])));r.Dom.prepend(i,e)}var a=document.getElementById("pagetitle");r.Dom.insertAfter(e,a);if(r.Type.isArray(this.categories)&&this.categories.length>0){var n=this.getCurrentCategory();if(n){var s=r.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div id="pagetitle_sub" class="pagetitle-sub">\n\t\t\t\t\t\t<a href="#" onclick="','">',"</a>\n\t\t\t\t\t</div>\n\t\t\t\t"])),this.onCategorySelectorClick.bind(this),n.text);r.Dom.insertAfter(s,e)}}}},{key:"onCategorySelectorClick",value:function t(e){var i=this;if(!this.categoryId||!this.categories){return}var r=this.categories.filter((function(t){return t.categoryId!==i.categoryId}));r.forEach((function(t){delete t.href;t.onclick=function(){i.onCategorySelect(t.categoryId)}}));s.PopupMenu.show({id:"item-detail-"+this.entityTypeId+"-"+this.id,bindElement:e.target,items:r})}},{key:"onCategorySelect",value:function t(e){if(this.isProgress){return}this.startProgress();r.ajax.runAction("crm.controller.item.update",{analyticsLabel:"crmItemDetailsChangeCategory",data:{entityTypeId:this.entityTypeId,id:this.id,fields:{categoryId:e}}}).then((function(){setTimeout((function(){window.location.reload()}),500)}))["catch"](this.showErrorsFromResponse.bind(this))}},{key:"initStageFlow",value:function t(){if(this.stages){var e=this.prepareStageFlowStagesData();var i=document.querySelector('[data-role="stageflow-wrap"]');if(i){this.stageflowChart=new l.StageFlow.Chart({backgroundColor:y,currentStage:this.currentStageId,isActive:this.isStageFlowActive===true,onStageChange:this.onStageChange.bind(this),labels:{finalStageName:r.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_NAME"),finalStagePopupTitle:r.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_POPUP"),finalStagePopupFail:r.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_POPUP_FAIL"),finalStageSelectorTitle:r.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_SELECTOR")}},e);i.appendChild(this.stageflowChart.render())}}}},{key:"prepareStageFlowStagesData",value:function t(){var e=[];var i=this.id<=0;this.stages.forEach((function(t){var r=t.getData();var a=t.getColor().indexOf("#")===0?t.getColor().substr(1):t.getColor();if(i){a=y}r.isSuccess=t.isSuccess();r.isFail=t.isFailure();r.color=a;e.push(r)}));return e}},{key:"bindEvents",value:function t(){a.EventEmitter.subscribe("BX.Crm.ItemDetailsComponent:onClickDelete",this.handleItemDelete.bind(this));if(this.bizprocStarterConfig){a.EventEmitter.subscribe("BX.Crm.ItemDetailsComponent:onClickBizprocTemplates",this.handleBPTemplatesShow.bind(this))}if(this.editorGuid&&this.userFieldCreateUrl&&BX.SidePanel&&BX.Crm.EntityEditor){a.EventEmitter.subscribe("BX.UI.EntityConfigurationManager:onCreateClick",this.handleUserFieldCreationUrlClick.bind(this))}}},{key:"initPull",value:function t(){var e=this;var i=BX.PULL;if(!i){console.error("pull is not initialized");return}if(!this.pullTag){return}i.subscribe({moduleId:"crm",command:this.pullTag,callback:function t(i){var r,a;if(!(i!==null&&i!==void 0&&(r=i.item)!==null&&r!==void 0&&r.data)){return}var n=i.item.data.columnId;if((a=e.stageflowChart)!==null&&a!==void 0&&a.isActive){var s=e.getStageById(e.stageflowChart.currentStage);if((s===null||s===void 0?void 0:s.statusId)!==n){var o=e.getStageByStatusId(n);if(o){e.updateStage(o)}}}}});i.extendWatch(this.pullTag)}},{key:"getEditor",value:function t(){if(BX.Crm.EntityEditor){if(this.editorGuid){return BX.Crm.EntityEditor.get(this.editorGuid)}return BX.Crm.EntityEditor.getDefault()}return null}},{key:"bindPartialEntityEditorEvents",value:function t(){a.EventEmitter.subscribe("Crm.PartialEditorDialog.Close",this.handleClosePartialEntityEditor);a.EventEmitter.subscribe("Crm.PartialEditorDialog.Error",this.handleErrorPartialEntityEditor)}},{key:"unBindPartialEntityEditorEvents",value:function t(){a.EventEmitter.unsubscribe("Crm.PartialEditorDialog.Close",this.handleClosePartialEntityEditor);a.EventEmitter.unsubscribe("Crm.PartialEditorDialog.Error",this.handleErrorPartialEntityEditor)}},{key:"onStageChange",value:function t(e){var i=this;if(this.isProgress){return}var a=this.getStageById(e.getId());if(!a){console.error("Wrong stage");return}this.startProgress();r.ajax.runAction("crm.controller.item.update",{analyticsLabel:"crmItemDetailsMoveItem",data:{entityTypeId:this.entityTypeId,id:this.id,fields:{stageId:a.getStatusId()}}}).then((function(){i.stopProgress();var t=null;if(r.Reflection.getClass("BX.SidePanel.Instance.getTopSlider")){t=BX.SidePanel.Instance.getTopSlider()}if(t!==null){if(r.Reflection.getClass("BX.Crm.EntityEvent")){var e=null;if(t){e={sliderUrl:t.getUrl()}}BX.Crm.EntityEvent.fireUpdate(i.entityTypeId,i.id,"",e)}}i.updateStage(a)}))["catch"]((function(t){i.stopProgress();if(!i.partialEditorId){i.showErrorsFromResponse(t);return}var e=[];t.errors.forEach((function(t){var i=t.code,r=t.customData;if(i==="CRM_FIELD_ERROR_REQUIRED"&&r.fieldName){e.push(r.fieldName)}}));if(e.length>0){BX.Crm.PartialEditorDialog.close(i.partialEditorId);i.partialEntityEditor=BX.Crm.PartialEditorDialog.create(i.partialEditorId,{title:BX.prop.getString(i.messages,"partialEditorTitle","Please fill in all required fields"),entityTypeName:i.entityTypeName,entityTypeId:i.entityTypeId,entityId:i.id,fieldNames:e,helpData:null,context:i.editorContext||null,isController:true,stageId:a.getStatusId()});i.bindPartialEntityEditorEvents();i.partialEntityEditor.open()}else{i.showErrorsFromResponse(t)}}))}},{key:"updateStage",value:function t(e){var i=this.getStageById(this.stageflowChart.currentStage);this.stageflowChart.setCurrentStageId(e.getId());a.EventEmitter.emit("BX.Crm.ItemDetailsComponent:onStageChange",{entityTypeId:this.entityTypeId,id:this.id,stageId:e.getStatusId(),previousStageId:i?i.getStatusId():null})}},{key:"showError",value:function t(e){if(r.Type.isElementNode(this.errorTextContainer)){this.errorTextContainer.innerText=e;this.errorTextContainer.parentElement.style.display="block"}else{console.error(e)}}},{key:"showErrors",value:function t(e){var i="";e.forEach((function(t){i=i+t+" "}));this.showError(i)}},{key:"hideErrors",value:function t(){if(r.Type.isElementNode(this.errorTextContainer)){this.errorTextContainer.innerText="";this.errorTextContainer.parentElement.style.display="none"}}},{key:"showErrorsFromResponse",value:function t(e){var i=e.errors;this.stopProgress();var r=[];i.forEach((function(t){var e=t.message;return r.push(e)}));this.showErrors(r)}},{key:"normalizeUrl",value:function t(e){return e.setHost("")}},{key:"handleItemDelete",value:function t(){var e=this;if(this.isProgress){return}o.MessageBox.show({title:this.messages.deleteItemTitle,message:this.messages.deleteItemMessage,modal:true,buttons:o.MessageBoxButtons.YES_CANCEL,onYes:function t(i){e.startProgress();r.ajax.runAction("crm.controller.item.delete",{analyticsLabel:"crmItemDetailsDeleteItem",data:{entityTypeId:e.entityTypeId,id:e.id}}).then((function(t){var i=t.data;e.stopProgress();var a=null;if(r.Reflection.getClass("BX.SidePanel.Instance.getTopSlider")){a=BX.SidePanel.Instance.getTopSlider()}if(a!==null){if(r.Reflection.getClass("BX.Crm.EntityEvent")){var n=null;if(a){n={sliderUrl:a.getUrl()}}BX.Crm.EntityEvent.fireDelete(e.entityTypeId,e.id,"",n)}a.close()}else{var s=i.redirectUrl;if(r.Type.isStringFilled(s)){var o=e.normalizeUrl(new r.Uri(s));location.href=o.toString()}}}))["catch"](e.showErrorsFromResponse.bind(e));i.close()}})}},{key:"handleBPTemplatesShow",value:function t(e){var i=new BX.Bizproc.Starter(this.bizprocStarterConfig);i.showTemplatesMenu(e.data.button.button)}},{key:"handleClosePartialEntityEditor",value:function t(e){this.unBindPartialEntityEditorEvents();this.stopProgress();var i=e.getData();if(r.Type.isArray(i)&&i.length===2){var a=i[1];if(a.isCancelled){return}var n=this.getStageByStatusId(a.stageId);if(!n){return}this.updateStage(n)}}},{key:"handleErrorPartialEntityEditor",value:function t(e){this.unBindPartialEntityEditorEvents();this.stopProgress();var i=e.getData();if(r.Type.isArray(i)&&i[1]&&r.Type.isArray(i[1].errors)){this.showErrorsFromResponse({errors:i[1].errors})}}},{key:"handleUserFieldCreationUrlClick",value:function t(e){var i=e.getData();if(i.hasOwnProperty("isCanceled")){e.setData(g(g({},i),{isCanceled:true}));BX.SidePanel.Instance.open(this.userFieldCreateUrl,{allowChangeHistory:false,cacheable:false,events:{onClose:this.onCreateUserFieldSliderClose.bind(this)}})}}},{key:"onCreateUserFieldSliderClose",value:function t(e){var i=e.getSlider();var a=i.getData();var n=a.get("userFieldData");if(n&&r.Type.isString(n)){this.reloadPageIfNotChanged()}}},{key:"reloadPageIfNotChanged",value:function t(){var e=this.getEditor();if(e){if(e.isChanged()){o.MessageBox.alert(this.messages.onCreateUserFieldAddMessage)}else{window.location.reload()}}}},{key:"initTours",value:function t(){var e=this;if(this.automationCheckAutomationTourGuideData){r.Runtime.loadExtension("bizproc.automation.guide").then((function(t){var i=t.CrmCheckAutomationGuide;if(i){var r;i.showCheckAutomation(e.entityTypeName,(r=e.categoryId)!==null&&r!==void 0?r:0,e.automationCheckAutomationTourGuideData["options"])}}))}}}]);return t}();t.ItemDetailsComponent=f})(this.BX.Crm=this.BX.Crm||{},BX.Crm.MessageSender,BX.Crm.Models,BX,BX.Event,BX,BX.Main,BX.UI.Dialogs,BX.UI);
//# sourceMappingURL=item-details-component.bundle.map.js