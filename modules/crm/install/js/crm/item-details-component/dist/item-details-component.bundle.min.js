this.BX=this.BX||{};(function(exports,crm_messagesender,crm_stageModel,crm_stage_permissionChecker,main_core,main_core_events,main_loader,main_popup,ui_dialogs_messagebox,ui_stageflow,crm_itemDetailsComponent_stageFlow){"use strict";var _templateObject,_templateObject2,_templateObject3;function ownKeys(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ownKeys(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var BACKGROUND_COLOR="d3d7dc";var ItemDetailsComponent=function(){function ItemDetailsComponent(e){var t=this;babelHelpers.classCallCheck(this,ItemDetailsComponent);babelHelpers.defineProperty(this,"categoryId",null);babelHelpers.defineProperty(this,"permissionChecker",null);babelHelpers.defineProperty(this,"receiversJSONString","");if(main_core.Type.isPlainObject(e)){this.entityTypeId=main_core.Text.toInteger(e.entityTypeId);this.entityTypeName=e.entityTypeName;this.id=main_core.Text.toInteger(e.id);if(BX.Crm.PartialEditorDialog&&e.serviceUrl){this.partialEditorId="partial_editor_"+this.entityTypeId+"_"+this.id;BX.Crm.PartialEditorDialog.registerEntityEditorUrl(this.entityTypeId,e.serviceUrl)}if(e.hasOwnProperty("editorContext")){this.editorContext=e.editorContext}if(e.hasOwnProperty("categoryId")){this.categoryId=main_core.Text.toInteger(e.categoryId);this.categories=e.categories}if(main_core.Type.isElementNode(e.errorTextContainer)){this.errorTextContainer=e.errorTextContainer}if(main_core.Type.isArray(e.stages)){this.stages=[];e.stages.forEach((function(e){t.stages.push(new crm_stageModel.StageModel(e))}));this.permissionChecker=crm_stage_permissionChecker.PermissionChecker.createFromStageModels(this.stages)}this.currentStageId=e.currentStageId;this.messages=e.messages;this.signedParameters=e.signedParameters;this.documentButtonParameters=e.documentButtonParameters;this.userFieldCreateUrl=e.userFieldCreateUrl;this.editorGuid=e.editorGuid;this.isStageFlowActive=e.isStageFlowActive;this.pullTag=e.pullTag;this.bizprocStarterConfig=e.bizprocStarterConfig;this.automationCheckAutomationTourGuideData=main_core.Type.isPlainObject(e.automationCheckAutomationTourGuideData)?e.automationCheckAutomationTourGuideData:null;if(main_core.Type.isString(e.receiversJSONString)){this.receiversJSONString=e.receiversJSONString}this.isPageTitleEditable=Boolean(e.isPageTitleEditable)}this.container=document.querySelector('[data-role="crm-item-detail-container"]');this.handleClosePartialEntityEditor=this.handleClosePartialEntityEditor.bind(this);this.handleErrorPartialEntityEditor=this.handleErrorPartialEntityEditor.bind(this)}babelHelpers.createClass(ItemDetailsComponent,[{key:"isNew",value:function e(){return this.id<=0}},{key:"getCurrentCategory",value:function e(){var t=this;var i=null;if(this.categories&&this.categoryId){this.categories.forEach((function(e){if(e.categoryId===t.categoryId){i=e}}))}return i}},{key:"getLoader",value:function e(){if(!this.loader){this.loader=new main_loader.Loader({size:200,offset:{left:"-100px",top:"-200px"}});this.loader.layout.style.zIndex=300}return this.loader}},{key:"startProgress",value:function e(){this.isProgress=true;if(!this.getLoader().isShown()&&this.container){this.getLoader().show(this.container)}this.hideErrors()}},{key:"stopProgress",value:function e(){this.isProgress=false;this.getLoader().hide()}},{key:"getStageById",value:function e(t){var i=null;var r=0;while(true){if(!this.stages[r]){break}var a=this.stages[r];if(a.getId()===t){i=a;break}r++}return i}},{key:"getStageByStatusId",value:function e(t){var i=null;var r=0;while(true){if(!this.stages[r]){break}var a=this.stages[r];if(a.getStatusId()===t){i=a;break}r++}return i}},{key:"init",value:function e(){this.initStageFlow();this.bindEvents();this.initDocumentButton();this.initReceiversRepository();if(this.isNew()){var t=document.getElementById("pagetitle");main_core.Dom.style(t,"padding-right","15px");this.initCategoriesSelector(t);var i=document.getElementById("pagetitle_sub");main_core.Dom.style(i,{position:"relative",padding:"10px","z-index":1e3,"background-size":"contain"})}else{this.initPageTitleButtons();this.initPull();this.initTours()}}},{key:"initDocumentButton",value:function e(){if(main_core.Type.isPlainObject(this.documentButtonParameters)&&this.documentButtonParameters.buttonId&&BX.DocumentGenerator&&BX.DocumentGenerator.Button){this.documentButton=new BX.DocumentGenerator.Button(this.documentButtonParameters.buttonId,this.documentButtonParameters);this.documentButton.init()}}},{key:"initReceiversRepository",value:function e(){crm_messagesender.ReceiverRepository.onDetailsLoad(this.entityTypeId,this.id,this.receiversJSONString)}},{key:"initPageTitleButtons",value:function e(){var t=main_core.Tag.render(_templateObject||(_templateObject=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<span id="pagetitle_btn_wrapper" class="pagetitile-button-container">\n\t\t\t\t<span id="page_url_copy_btn" class="crm-page-link-btn"></span>\n\t\t\t</span>\n\t\t'])));if(this.isPageTitleEditable){var i=main_core.Tag.render(_templateObject2||(_templateObject2=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span id="pagetitle_edit" class="pagetitle-edit-button"></span>\n\t\t\t'])));main_core.Dom.prepend(i,t)}var r=document.getElementById("pagetitle");main_core.Dom.insertAfter(t,r);this.initCategoriesSelector(t)}},{key:"initCategoriesSelector",value:function e(t){if(main_core.Type.isArray(this.categories)&&this.categories.length>0){var i=this.getCurrentCategory();if(i){var r=main_core.Tag.render(_templateObject3||(_templateObject3=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div id="pagetitle_sub" class="pagetitle-sub">\n\t\t\t\t\t\t<a href="#" onclick="','">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</a>\n\t\t\t\t\t</div>\n\t\t\t\t"])),this.onCategorySelectorClick.bind(this),i.text);main_core.Dom.insertAfter(r,t)}}}},{key:"onCategorySelectorClick",value:function e(t){var i=this;if(!this.categoryId||!this.categories){return}var r=this.categories.filter((function(e){return e.categoryId!==i.categoryId}));r.forEach((function(e){delete e.href;e.onclick=function(){i.onCategorySelect(e.categoryId)}}));main_popup.PopupMenu.show({id:"item-detail-".concat(this.entityTypeId,"-").concat(this.id),bindElement:t.target,items:r})}},{key:"onCategorySelect",value:function e(t){var i=this;if(this.isProgress){return}if(this.isNew()){var r;if((r=this.getEditor())!==null&&r!==void 0&&r.isChanged()){ui_dialogs_messagebox.MessageBox.show({modal:true,title:main_core.Loc.getMessage("CRM_ITEM_DETAIL_CHANGE_FUNNEL_CONFIRM_DIALOG_TITLE"),message:main_core.Loc.getMessage("CRM_ITEM_DETAIL_CHANGE_FUNNEL_CONFIRM_DIALOG_MESSAGE"),minHeight:100,buttons:ui_dialogs_messagebox.MessageBoxButtons.OK_CANCEL,okCaption:main_core.Loc.getMessage("CRM_ITEM_DETAIL_CHANGE_FUNNEL_CONFIRM_DIALOG_OK_BTN"),onOk:function e(r){r.close();i.reloadPageWhenCategoryChanged(t)},onCancel:function e(t){return t.close()}})}else{this.reloadPageWhenCategoryChanged(t)}return}this.startProgress();main_core.ajax.runAction("crm.controller.item.update",{analyticsLabel:"crmItemDetailsChangeCategory",data:{entityTypeId:this.entityTypeId,id:this.id,fields:{categoryId:t}}}).then((function(){setTimeout((function(){window.location.reload()}),500)}))["catch"](this.showErrorsFromResponse.bind(this))}},{key:"reloadPageWhenCategoryChanged",value:function e(t){var i=new main_core.Uri(window.location.href);i.setQueryParam("categoryId",t);window.location.href=i.toString()}},{key:"initStageFlow",value:function e(){if(!this.stages){return}var t=this.prepareStageFlowStagesData();var i=document.querySelector('[data-role="stageflow-wrap"]');if(!i){return}var r={backgroundColor:BACKGROUND_COLOR,currentStage:this.currentStageId,isActive:this.isStageFlowActive===true,onStageChange:this.onStageChange.bind(this),labels:{finalStageName:main_core.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_NAME"),finalStagePopupTitle:main_core.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_POPUP"),finalStagePopupFail:main_core.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_POPUP_FAIL"),finalStageSelectorTitle:main_core.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_SELECTOR")}};this.stageflowChart=new crm_itemDetailsComponent_stageFlow.Chart(r,t,this.permissionChecker,this.getStageById.bind(this),this.isNew());main_core.Dom.append(this.stageflowChart.render(),i)}},{key:"prepareStageFlowStagesData",value:function e(){var t=this;var i=[];this.stages.forEach((function(e){var r=e.getData();var a=e.getColor().indexOf("#")===0?e.getColor().substr(1):e.getColor();if(t.isNew()){a=BACKGROUND_COLOR}r.isSuccess=e.isSuccess();r.isFail=e.isFailure();r.color=a;i.push(r)}));return i}},{key:"bindEvents",value:function e(){main_core_events.EventEmitter.subscribe("BX.Crm.ItemDetailsComponent:onClickDelete",this.handleItemDelete.bind(this));if(this.bizprocStarterConfig){main_core_events.EventEmitter.subscribe("BX.Crm.ItemDetailsComponent:onClickBizprocTemplates",this.handleBPTemplatesShow.bind(this))}if(this.editorGuid&&this.userFieldCreateUrl&&BX.SidePanel&&BX.Crm.EntityEditor){main_core_events.EventEmitter.subscribe("BX.UI.EntityConfigurationManager:onCreateClick",this.handleUserFieldCreationUrlClick.bind(this))}}},{key:"initPull",value:function e(){var t=this;var i=BX.PULL;if(!i){console.error("pull is not initialized");return}if(!this.pullTag){return}i.subscribe({moduleId:"crm",command:this.pullTag,callback:function e(i){var r,a;if(!(i!==null&&i!==void 0&&(r=i.item)!==null&&r!==void 0&&r.data)){return}var n=i.item.data.columnId;if((a=t.stageflowChart)!==null&&a!==void 0&&a.isActive){var o=t.getStageById(t.stageflowChart.currentStage);if((o===null||o===void 0?void 0:o.statusId)!==n){var s=t.getStageByStatusId(n);if(s){t.updateStage(s)}}}}});i.extendWatch(this.pullTag)}},{key:"getEditor",value:function e(){if(BX.Crm.EntityEditor){if(this.editorGuid){return BX.Crm.EntityEditor.get(this.editorGuid)}return BX.Crm.EntityEditor.getDefault()}return null}},{key:"bindPartialEntityEditorEvents",value:function e(){main_core_events.EventEmitter.subscribe("Crm.PartialEditorDialog.Close",this.handleClosePartialEntityEditor);main_core_events.EventEmitter.subscribe("Crm.PartialEditorDialog.Error",this.handleErrorPartialEntityEditor)}},{key:"unBindPartialEntityEditorEvents",value:function e(){main_core_events.EventEmitter.unsubscribe("Crm.PartialEditorDialog.Close",this.handleClosePartialEntityEditor);main_core_events.EventEmitter.unsubscribe("Crm.PartialEditorDialog.Error",this.handleErrorPartialEntityEditor)}},{key:"onStageChange",value:function e(t){var i=this;if(this.isProgress){return}var r=this.getStageById(t.getId());if(!r){console.error("Wrong stage");return}this.startProgress();main_core.ajax.runAction("crm.controller.item.update",{analyticsLabel:"crmItemDetailsMoveItem",data:{entityTypeId:this.entityTypeId,id:this.id,fields:{stageId:r.getStatusId()}}}).then((function(){i.stopProgress();var e=null;if(main_core.Reflection.getClass("BX.SidePanel.Instance.getTopSlider")){e=BX.SidePanel.Instance.getTopSlider()}if(e!==null){if(main_core.Reflection.getClass("BX.Crm.EntityEvent")){var t=null;if(e){t={sliderUrl:e.getUrl()}}BX.Crm.EntityEvent.fireUpdate(i.entityTypeId,i.id,"",t)}}i.updateStage(r)}))["catch"]((function(e){i.stopProgress();if(!i.partialEditorId){i.showErrorsFromResponse(e);return}var t=[];e.errors.forEach((function(e){var i=e.code,r=e.customData;if(i==="CRM_FIELD_ERROR_REQUIRED"&&r.fieldName){t.push(r.fieldName)}}));if(t.length>0){BX.Crm.PartialEditorDialog.close(i.partialEditorId);i.partialEntityEditor=BX.Crm.PartialEditorDialog.create(i.partialEditorId,{title:BX.prop.getString(i.messages,"partialEditorTitle","Please fill in all required fields"),entityTypeName:i.entityTypeName,entityTypeId:i.entityTypeId,entityId:i.id,fieldNames:t,helpData:null,context:i.editorContext||null,isController:true,stageId:r.getStatusId()});i.bindPartialEntityEditorEvents();i.partialEntityEditor.open()}else{i.showErrorsFromResponse(e)}}))}},{key:"updateStage",value:function e(t){var i=this.getStageById(this.stageflowChart.currentStage);this.stageflowChart.setCurrentStageId(t.getId());main_core_events.EventEmitter.emit("BX.Crm.ItemDetailsComponent:onStageChange",{entityTypeId:this.entityTypeId,id:this.id,stageId:t.getStatusId(),previousStageId:i?i.getStatusId():null})}},{key:"showError",value:function e(t){if(main_core.Type.isElementNode(this.errorTextContainer)){this.errorTextContainer.innerText=t;this.errorTextContainer.parentElement.style.display="block"}else{console.error(t)}}},{key:"showErrors",value:function e(t){var i="";t.forEach((function(e){i=i+e+" "}));this.showError(i)}},{key:"hideErrors",value:function e(){if(main_core.Type.isElementNode(this.errorTextContainer)){this.errorTextContainer.innerText="";this.errorTextContainer.parentElement.style.display="none"}}},{key:"showErrorsFromResponse",value:function e(t){var i=t.errors;this.stopProgress();var r=[];i.forEach((function(e){var t=e.message;return r.push(t)}));this.showErrors(r)}},{key:"normalizeUrl",value:function e(t){return t.setHost("")}},{key:"handleItemDelete",value:function e(){var t=this;if(this.isProgress){return}ui_dialogs_messagebox.MessageBox.show({title:this.messages.deleteItemTitle,message:this.messages.deleteItemMessage,modal:true,buttons:ui_dialogs_messagebox.MessageBoxButtons.YES_CANCEL,onYes:function e(i){t.startProgress();main_core.ajax.runAction("crm.controller.item.delete",{analyticsLabel:"crmItemDetailsDeleteItem",data:{entityTypeId:t.entityTypeId,id:t.id}}).then((function(e){var i=e.data;t.stopProgress();var r=null;if(main_core.Reflection.getClass("BX.SidePanel.Instance.getTopSlider")){r=BX.SidePanel.Instance.getTopSlider()}if(r!==null){if(main_core.Reflection.getClass("BX.Crm.EntityEvent")){var a=null;if(r){a={sliderUrl:r.getUrl()}}BX.Crm.EntityEvent.fireDelete(t.entityTypeId,t.id,"",a)}r.close()}else{var n=i.redirectUrl;if(main_core.Type.isStringFilled(n)){var o=t.normalizeUrl(new main_core.Uri(n));location.href=o.toString()}}}))["catch"](t.showErrorsFromResponse.bind(t));i.close()}})}},{key:"handleBPTemplatesShow",value:function handleBPTemplatesShow(event){if(this.bizprocStarterConfig.availabilityLock){eval(this.bizprocStarterConfig.availabilityLock);return}var starter=new BX.Bizproc.Starter(this.bizprocStarterConfig);starter.showTemplatesMenu(event.data.button.button)}},{key:"handleClosePartialEntityEditor",value:function e(t){this.unBindPartialEntityEditorEvents();this.stopProgress();var i=t.getData();if(main_core.Type.isArray(i)&&i.length===2){var r=i[1];if(r.isCancelled){return}var a=this.getStageByStatusId(r.stageId);if(!a){return}this.updateStage(a)}}},{key:"handleErrorPartialEntityEditor",value:function e(t){this.unBindPartialEntityEditorEvents();this.stopProgress();var i=t.getData();if(main_core.Type.isArray(i)&&i[1]&&main_core.Type.isArray(i[1].errors)){this.showErrorsFromResponse({errors:i[1].errors})}}},{key:"handleUserFieldCreationUrlClick",value:function e(t){var i=t.getData();if(i.hasOwnProperty("isCanceled")){t.setData(_objectSpread(_objectSpread({},i),{isCanceled:true}));BX.SidePanel.Instance.open(this.userFieldCreateUrl,{allowChangeHistory:false,cacheable:false,events:{onClose:this.onCreateUserFieldSliderClose.bind(this)}})}}},{key:"onCreateUserFieldSliderClose",value:function e(t){var i=t.getSlider();var r=i.getData();var a=r.get("userFieldData");if(a&&main_core.Type.isString(a)){this.reloadPageIfNotChanged()}}},{key:"reloadPageIfNotChanged",value:function e(){var t=this.getEditor();if(t){if(t.isChanged()){ui_dialogs_messagebox.MessageBox.alert(this.messages.onCreateUserFieldAddMessage)}else{window.location.reload()}}}},{key:"initTours",value:function e(){var t=this;if(this.automationCheckAutomationTourGuideData){main_core.Runtime.loadExtension("bizproc.automation.guide").then((function(e){var i=e.CrmCheckAutomationGuide;if(i){var r;i.showCheckAutomation(t.entityTypeName,(r=t.categoryId)!==null&&r!==void 0?r:0,t.automationCheckAutomationTourGuideData["options"])}}))}}}]);return ItemDetailsComponent}();exports.ItemDetailsComponent=ItemDetailsComponent})(this.BX.Crm=this.BX.Crm||{},BX.Crm.MessageSender,BX.Crm.Models,BX.Crm.Stage,BX,BX.Event,BX,BX.Main,BX.UI.Dialogs,BX.UI,BX.Crm.ItemDetailsComponent);
//# sourceMappingURL=item-details-component.bundle.map.js