this.BX=this.BX||{};(function(t,e,i,r,a,n,s,o,l){"use strict";var d,u,c;function h(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,r)}return i}function g(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?h(Object(i),!0).forEach((function(e){babelHelpers.defineProperty(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):h(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}var y="d3d7dc";var f=function(){function t(i){var r=this;babelHelpers.classCallCheck(this,t);babelHelpers.defineProperty(this,"categoryId",null);babelHelpers.defineProperty(this,"receiversJSONString","");if(e.Type.isPlainObject(i)){this.entityTypeId=e.Text.toInteger(i.entityTypeId);this.entityTypeName=i.entityTypeName;this.id=e.Text.toInteger(i.id);if(BX.Crm.PartialEditorDialog&&i.serviceUrl){this.partialEditorId="partial_editor_"+this.entityTypeId+"_"+this.id;BX.Crm.PartialEditorDialog.registerEntityEditorUrl(this.entityTypeId,i.serviceUrl)}if(i.hasOwnProperty("editorContext")){this.editorContext=i.editorContext}if(i.hasOwnProperty("categoryId")){this.categoryId=e.Text.toInteger(i.categoryId);this.categories=i.categories}if(e.Type.isElementNode(i.errorTextContainer)){this.errorTextContainer=i.errorTextContainer}if(e.Type.isArray(i.stages)){this.stages=[];i.stages.forEach((function(t){r.stages.push(new n.StageModel(t))}))}this.currentStageId=i.currentStageId;this.messages=i.messages;this.signedParameters=i.signedParameters;this.documentButtonParameters=i.documentButtonParameters;this.userFieldCreateUrl=i.userFieldCreateUrl;this.editorGuid=i.editorGuid;this.isStageFlowActive=i.isStageFlowActive;this.pullTag=i.pullTag;this.bizprocStarterConfig=i.bizprocStarterConfig;this.automationCheckAutomationTourGuideData=e.Type.isPlainObject(i.automationCheckAutomationTourGuideData)?i.automationCheckAutomationTourGuideData:null;if(e.Type.isString(i.receiversJSONString)){this.receiversJSONString=i.receiversJSONString}this.isPageTitleEditable=Boolean(i.isPageTitleEditable)}this.container=document.querySelector('[data-role="crm-item-detail-container"]');this.handleClosePartialEntityEditor=this.handleClosePartialEntityEditor.bind(this);this.handleErrorPartialEntityEditor=this.handleErrorPartialEntityEditor.bind(this)}babelHelpers.createClass(t,[{key:"getCurrentCategory",value:function t(){var e=this;var i=null;if(this.categories&&this.categoryId){this.categories.forEach((function(t){if(t.categoryId===e.categoryId){i=t}}))}return i}},{key:"getLoader",value:function t(){if(!this.loader){this.loader=new s.Loader({size:200,offset:{left:"-100px",top:"-200px"}});this.loader.layout.style.zIndex=300}return this.loader}},{key:"startProgress",value:function t(){this.isProgress=true;if(!this.getLoader().isShown()&&this.container){this.getLoader().show(this.container)}this.hideErrors()}},{key:"stopProgress",value:function t(){this.isProgress=false;this.getLoader().hide()}},{key:"getStageById",value:function t(e){var i=null;var r=0;while(true){if(!this.stages[r]){break}var a=this.stages[r];if(a.getId()===e){i=a;break}r++}return i}},{key:"getStageByStatusId",value:function t(e){var i=null;var r=0;while(true){if(!this.stages[r]){break}var a=this.stages[r];if(a.getStatusId()===e){i=a;break}r++}return i}},{key:"init",value:function t(){this.initStageFlow();this.bindEvents();this.initDocumentButton();this.initReceiversRepository();if(this.id>0){this.initPageTitleButtons();this.initPull();this.initTours()}}},{key:"initDocumentButton",value:function t(){if(e.Type.isPlainObject(this.documentButtonParameters)&&this.documentButtonParameters.buttonId&&BX.DocumentGenerator&&BX.DocumentGenerator.Button){this.documentButton=new BX.DocumentGenerator.Button(this.documentButtonParameters.buttonId,this.documentButtonParameters);this.documentButton.init()}}},{key:"initReceiversRepository",value:function t(){l.ReceiverRepository.onDetailsLoad(this.entityTypeId,this.id,this.receiversJSONString)}},{key:"initPageTitleButtons",value:function t(){var i=e.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<span id="pagetitle_btn_wrapper" class="pagetitile-button-container">\n\t\t\t\t<span id="page_url_copy_btn" class="crm-page-link-btn"></span>\n\t\t\t</span>\n\t\t'])));if(this.isPageTitleEditable){var r=e.Tag.render(u||(u=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span id="pagetitle_edit" class="pagetitle-edit-button"></span>\n\t\t\t'])));e.Dom.prepend(r,i)}var a=document.getElementById("pagetitle");e.Dom.insertAfter(i,a);if(e.Type.isArray(this.categories)&&this.categories.length>0){var n=this.getCurrentCategory();if(n){var s=e.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div id="pagetitle_sub" class="pagetitle-sub">\n\t\t\t\t\t\t<a href="#" onclick="','">',"</a>\n\t\t\t\t\t</div>\n\t\t\t\t"])),this.onCategorySelectorClick.bind(this),n.text);e.Dom.insertAfter(s,i)}}}},{key:"onCategorySelectorClick",value:function t(e){var i=this;if(!this.categoryId||!this.categories){return}var r=this.categories.filter((function(t){return t.categoryId!==i.categoryId}));r.forEach((function(t){delete t.href;t.onclick=function(){i.onCategorySelect(t.categoryId)}}));o.PopupMenu.show({id:"item-detail-"+this.entityTypeId+"-"+this.id,bindElement:e.target,items:r})}},{key:"onCategorySelect",value:function t(i){if(this.isProgress){return}this.startProgress();e.ajax.runAction("crm.controller.item.update",{analyticsLabel:"crmItemDetailsChangeCategory",data:{entityTypeId:this.entityTypeId,id:this.id,fields:{categoryId:i}}}).then((function(){setTimeout((function(){window.location.reload()}),500)}))["catch"](this.showErrorsFromResponse.bind(this))}},{key:"initStageFlow",value:function t(){if(this.stages){var i=this.prepareStageFlowStagesData();var r=document.querySelector('[data-role="stageflow-wrap"]');if(r){this.stageflowChart=new a.StageFlow.Chart({backgroundColor:y,currentStage:this.currentStageId,isActive:this.isStageFlowActive===true,onStageChange:this.onStageChange.bind(this),labels:{finalStageName:e.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_NAME"),finalStagePopupTitle:e.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_POPUP"),finalStagePopupFail:e.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_POPUP_FAIL"),finalStageSelectorTitle:e.Loc.getMessage("CRM_ITEM_DETAIL_STAGEFLOW_FINAL_STAGE_SELECTOR")}},i);r.appendChild(this.stageflowChart.render())}}}},{key:"prepareStageFlowStagesData",value:function t(){var e=[];var i=this.id<=0;this.stages.forEach((function(t){var r=t.getData();var a=t.getColor().indexOf("#")===0?t.getColor().substr(1):t.getColor();if(i){a=y}r.isSuccess=t.isSuccess();r.isFail=t.isFailure();r.color=a;e.push(r)}));return e}},{key:"bindEvents",value:function t(){i.EventEmitter.subscribe("BX.Crm.ItemDetailsComponent:onClickDelete",this.handleItemDelete.bind(this));if(this.bizprocStarterConfig){i.EventEmitter.subscribe("BX.Crm.ItemDetailsComponent:onClickBizprocTemplates",this.handleBPTemplatesShow.bind(this))}if(this.editorGuid&&this.userFieldCreateUrl&&BX.SidePanel&&BX.Crm.EntityEditor){i.EventEmitter.subscribe("BX.UI.EntityConfigurationManager:onCreateClick",this.handleUserFieldCreationUrlClick.bind(this))}}},{key:"initPull",value:function t(){var e=this;var i=BX.PULL;if(!i){console.error("pull is not initialized");return}if(!this.pullTag){return}i.subscribe({moduleId:"crm",command:this.pullTag,callback:function t(i){if(i&&i.item&&i.item.data){var r=i.item.data.columnId;if(e.stageflowChart&&e.stageflowChart.isActive){var a=e.getStageById(e.stageflowChart.currentStage);if(a&&a.statusId!==r){var n=e.getStageByStatusId(r);if(n){e.updateStage(n)}}}}}});i.extendWatch(this.pullTag)}},{key:"getEditor",value:function t(){if(BX.Crm.EntityEditor){if(this.editorGuid){return BX.Crm.EntityEditor.get(this.editorGuid)}return BX.Crm.EntityEditor.getDefault()}return null}},{key:"bindPartialEntityEditorEvents",value:function t(){i.EventEmitter.subscribe("Crm.PartialEditorDialog.Close",this.handleClosePartialEntityEditor);i.EventEmitter.subscribe("Crm.PartialEditorDialog.Error",this.handleErrorPartialEntityEditor)}},{key:"unBindPartialEntityEditorEvents",value:function t(){i.EventEmitter.unsubscribe("Crm.PartialEditorDialog.Close",this.handleClosePartialEntityEditor);i.EventEmitter.unsubscribe("Crm.PartialEditorDialog.Error",this.handleErrorPartialEntityEditor)}},{key:"onStageChange",value:function t(i){var r=this;if(this.isProgress){return}var a=this.getStageById(i.getId());if(!a){console.error("Wrong stage");return}this.startProgress();e.ajax.runAction("crm.controller.item.update",{analyticsLabel:"crmItemDetailsMoveItem",data:{entityTypeId:this.entityTypeId,id:this.id,fields:{stageId:a.getStatusId()}}}).then((function(){r.stopProgress();var t=null;if(e.Reflection.getClass("BX.SidePanel.Instance.getTopSlider")){t=BX.SidePanel.Instance.getTopSlider()}if(t!==null){if(e.Reflection.getClass("BX.Crm.EntityEvent")){var i=null;if(t){i={sliderUrl:t.getUrl()}}BX.Crm.EntityEvent.fireUpdate(r.entityTypeId,r.id,"",i)}}r.updateStage(a)}))["catch"]((function(t){r.stopProgress();if(!r.partialEditorId){r.showErrorsFromResponse(t);return}var e=[];t.errors.forEach((function(t){var i=t.code,r=t.customData;if(i==="CRM_FIELD_ERROR_REQUIRED"&&r.fieldName){e.push(r.fieldName)}}));if(e.length>0){BX.Crm.PartialEditorDialog.close(r.partialEditorId);r.partialEntityEditor=BX.Crm.PartialEditorDialog.create(r.partialEditorId,{title:BX.prop.getString(r.messages,"partialEditorTitle","Please fill in all required fields"),entityTypeName:r.entityTypeName,entityTypeId:r.entityTypeId,entityId:r.id,fieldNames:e,helpData:null,context:r.editorContext||null,isController:true,stageId:a.getStatusId()});r.bindPartialEntityEditorEvents();r.partialEntityEditor.open()}else{r.showErrorsFromResponse(t)}}))}},{key:"updateStage",value:function t(e){var r=this.getStageById(this.stageflowChart.currentStage);this.stageflowChart.setCurrentStageId(e.getId());i.EventEmitter.emit("BX.Crm.ItemDetailsComponent:onStageChange",{entityTypeId:this.entityTypeId,id:this.id,stageId:e.getStatusId(),previousStageId:r?r.getStatusId():null})}},{key:"showError",value:function t(i){if(e.Type.isElementNode(this.errorTextContainer)){this.errorTextContainer.innerText=i;this.errorTextContainer.parentElement.style.display="block"}else{console.error(i)}}},{key:"showErrors",value:function t(e){var i="";e.forEach((function(t){i=i+t+" "}));this.showError(i)}},{key:"hideErrors",value:function t(){if(e.Type.isElementNode(this.errorTextContainer)){this.errorTextContainer.innerText="";this.errorTextContainer.parentElement.style.display="none"}}},{key:"showErrorsFromResponse",value:function t(e){var i=e.errors;this.stopProgress();var r=[];i.forEach((function(t){var e=t.message;return r.push(e)}));this.showErrors(r)}},{key:"normalizeUrl",value:function t(e){return e.setHost("")}},{key:"handleItemDelete",value:function t(){var i=this;if(this.isProgress){return}r.MessageBox.show({title:this.messages.deleteItemTitle,message:this.messages.deleteItemMessage,modal:true,buttons:r.MessageBoxButtons.YES_CANCEL,onYes:function t(r){i.startProgress();e.ajax.runAction("crm.controller.item.delete",{analyticsLabel:"crmItemDetailsDeleteItem",data:{entityTypeId:i.entityTypeId,id:i.id}}).then((function(t){var r=t.data;i.stopProgress();var a=null;if(e.Reflection.getClass("BX.SidePanel.Instance.getTopSlider")){a=BX.SidePanel.Instance.getTopSlider()}if(a!==null){if(e.Reflection.getClass("BX.Crm.EntityEvent")){var n=null;if(a){n={sliderUrl:a.getUrl()}}BX.Crm.EntityEvent.fireDelete(i.entityTypeId,i.id,"",n)}a.close()}else{var s=r.redirectUrl;if(e.Type.isStringFilled(s)){var o=i.normalizeUrl(new e.Uri(s));location.href=o.toString()}}}))["catch"](i.showErrorsFromResponse.bind(i));r.close()}})}},{key:"handleBPTemplatesShow",value:function t(e){var i=new BX.Bizproc.Starter(this.bizprocStarterConfig);i.showTemplatesMenu(e.data.button.button)}},{key:"handleClosePartialEntityEditor",value:function t(i){this.unBindPartialEntityEditorEvents();this.stopProgress();var r=i.getData();if(e.Type.isArray(r)&&r.length===2){var a=r[1];if(a.isCancelled){return}var n=this.getStageByStatusId(a.stageId);if(!n){return}this.updateStage(n)}}},{key:"handleErrorPartialEntityEditor",value:function t(i){this.unBindPartialEntityEditorEvents();this.stopProgress();var r=i.getData();if(e.Type.isArray(r)&&r[1]&&e.Type.isArray(r[1].errors)){this.showErrorsFromResponse({errors:r[1].errors})}}},{key:"handleUserFieldCreationUrlClick",value:function t(e){var i=e.getData();if(i.hasOwnProperty("isCanceled")){e.setData(g(g({},i),{isCanceled:true}));BX.SidePanel.Instance.open(this.userFieldCreateUrl,{allowChangeHistory:false,cacheable:false,events:{onClose:this.onCreateUserFieldSliderClose.bind(this)}})}}},{key:"onCreateUserFieldSliderClose",value:function t(i){var r=i.getSlider();var a=r.getData();var n=a.get("userFieldData");if(n&&e.Type.isString(n)){this.reloadPageIfNotChanged()}}},{key:"reloadPageIfNotChanged",value:function t(){var e=this.getEditor();if(e){if(e.isChanged()){r.MessageBox.alert(this.messages.onCreateUserFieldAddMessage)}else{window.location.reload()}}}},{key:"initTours",value:function t(){var i=this;if(this.automationCheckAutomationTourGuideData){e.Runtime.loadExtension("bizproc.automation.guide").then((function(t){var e=t.CrmCheckAutomationGuide;if(e){var r;e.showCheckAutomation(i.entityTypeName,(r=i.categoryId)!==null&&r!==void 0?r:0,i.automationCheckAutomationTourGuideData["options"])}}))}}}]);return t}();t.ItemDetailsComponent=f})(this.BX.Crm=this.BX.Crm||{},BX,BX.Event,BX.UI.Dialogs,BX.UI,BX.Crm.Models,BX,BX.Main,BX.Crm.MessageSender);
//# sourceMappingURL=item-details-component.bundle.map.js