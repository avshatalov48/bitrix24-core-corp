this.BX=this.BX||{};(function(e,s,t,a,l,i,r,o){"use strict";function n(e,s,t){if(l.Type.isNil(e)){return e}return b(e,s,t)}function b(e,s,t){if(e instanceof s){return e}throw new Error(`Expected ${t} be an instance of ${s.name}, got ${d(e)} instead`)}function c(e,s){if(l.Type.isStringFilled(e)||l.Type.isNil(e)){return e}throw new Error(`Expected ${s} be either non-empty string or null, got ${d(e)} instead`)}function d(e){if(l.Type.isObject(e)&&!l.Type.isPlainObject(e)){var s;return(e==null?void 0:(s=e.constructor)==null?void 0:s.name)||"unknown"}return typeof e}const v=l.Extension.getSettings("crm.settings-button-extender").get("createTimeAliases",{});const p={};for(const e in v){p[e]={column:v[e],order:"desc"}}Object.freeze(p);var u=babelHelpers.classPrivateFieldLooseKey("entityTypeId");var P=babelHelpers.classPrivateFieldLooseKey("grid");var h=babelHelpers.classPrivateFieldLooseKey("disableLastActivitySort");var L=babelHelpers.classPrivateFieldLooseKey("enableLastActivitySort");var y=babelHelpers.classPrivateFieldLooseKey("isColumnExists");var F=babelHelpers.classPrivateFieldLooseKey("isColumnShowed");var H=babelHelpers.classPrivateFieldLooseKey("isColumnSortable");var g=babelHelpers.classPrivateFieldLooseKey("getShowedColumnList");var B=babelHelpers.classPrivateFieldLooseKey("setSortOrder");var T=babelHelpers.classPrivateFieldLooseKey("showColumn");class f{constructor(e,s){Object.defineProperty(this,T,{value:M});Object.defineProperty(this,B,{value:A});Object.defineProperty(this,g,{value:m});Object.defineProperty(this,H,{value:_});Object.defineProperty(this,F,{value:C});Object.defineProperty(this,y,{value:O});Object.defineProperty(this,L,{value:I});Object.defineProperty(this,h,{value:S});Object.defineProperty(this,u,{writable:true,value:void 0});Object.defineProperty(this,P,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,u)[u]=l.Text.toInteger(e);babelHelpers.classPrivateFieldLooseBase(this,P)[P]=b(s,BX.Main.grid,"grid")}isLastActivitySortSupported(){return babelHelpers.classPrivateFieldLooseBase(this,y)[y]("LAST_ACTIVITY_TIME")}isLastActivitySortEnabled(){const e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].getUserOptions().getCurrentOptions();const s=e.last_sort_by;const t=e.last_sort_order;return(s==null?void 0:s.toLowerCase())==="last_activity_time"&&(t==null?void 0:t.toLowerCase())==="desc"}toggleLastActivitySort(){if(this.isLastActivitySortEnabled()){babelHelpers.classPrivateFieldLooseBase(this,h)[h]()}else{babelHelpers.classPrivateFieldLooseBase(this,L)[L]()}}}async function S(){const e=p[babelHelpers.classPrivateFieldLooseBase(this,u)[u]];let s;if(l.Type.isPlainObject(e)&&babelHelpers.classPrivateFieldLooseBase(this,y)[y](e.column)&&babelHelpers.classPrivateFieldLooseBase(this,H)[H](e.column)){s=e.column;if(!babelHelpers.classPrivateFieldLooseBase(this,F)[F](s)){await babelHelpers.classPrivateFieldLooseBase(this,T)[T](s)}babelHelpers.classPrivateFieldLooseBase(this,B)[B](s,e.order)}else{s=babelHelpers.classPrivateFieldLooseBase(this,g)[g]().find((e=>e!=="LAST_ACTIVITY_TIME"&&babelHelpers.classPrivateFieldLooseBase(this,H)[H](e)))}babelHelpers.classPrivateFieldLooseBase(this,P)[P].sortByColumn(s)}async function I(){if(!babelHelpers.classPrivateFieldLooseBase(this,F)[F]("LAST_ACTIVITY_TIME")){await babelHelpers.classPrivateFieldLooseBase(this,T)[T]("LAST_ACTIVITY_TIME")}babelHelpers.classPrivateFieldLooseBase(this,B)[B]("LAST_ACTIVITY_TIME","desc");babelHelpers.classPrivateFieldLooseBase(this,P)[P].sortByColumn("LAST_ACTIVITY_TIME")}function O(e){return babelHelpers.classPrivateFieldLooseBase(this,P)[P].getParam("COLUMNS_ALL",{}).hasOwnProperty(e)}function C(e){return babelHelpers.classPrivateFieldLooseBase(this,g)[g]().includes(e)}function _(e){const s=babelHelpers.classPrivateFieldLooseBase(this,P)[P].getColumnByName(e);return!!(s&&s.sort!==false)}function m(){return babelHelpers.classPrivateFieldLooseBase(this,P)[P].getSettingsWindow().getShowedColumns()}function A(e,s){babelHelpers.classPrivateFieldLooseBase(this,P)[P].getColumnByName(e).sort_order=s}function M(e){return new Promise(((s,t)=>{if(!babelHelpers.classPrivateFieldLooseBase(this,y)[y](e)){t(`Column ${e} does not exists`);return}if(babelHelpers.classPrivateFieldLooseBase(this,F)[F](e)){t(`Column ${e} is showed already`);return}const a=babelHelpers.classPrivateFieldLooseBase(this,P)[P].getSettingsWindow().getItems().find((s=>s.getId()===e));a==null?void 0:a.select();const l=babelHelpers.classPrivateFieldLooseBase(this,g)[g]();l.push(e);babelHelpers.classPrivateFieldLooseBase(this,P)[P].getSettingsWindow().saveColumns(l,s)}))}const w=l.Reflection.getClass("BX.CrmEntityType");const E="menu-popup-item-accept";const j="menu-popup-item-none";var K=babelHelpers.classPrivateFieldLooseKey("entityTypeId");var N=babelHelpers.classPrivateFieldLooseKey("categoryId");var R=babelHelpers.classPrivateFieldLooseKey("pingSettings");var x=babelHelpers.classPrivateFieldLooseKey("rootMenu");var X=babelHelpers.classPrivateFieldLooseKey("targetItemId");var k=babelHelpers.classPrivateFieldLooseKey("kanbanController");var Y=babelHelpers.classPrivateFieldLooseKey("restriction");var G=babelHelpers.classPrivateFieldLooseKey("gridController");var U=babelHelpers.classPrivateFieldLooseKey("todoSkipMenu");var W=babelHelpers.classPrivateFieldLooseKey("todoPingSettingsMenu");var V=babelHelpers.classPrivateFieldLooseKey("isSetSortRequestRunning");var $=babelHelpers.classPrivateFieldLooseKey("smartActivityNotificationSupported");var D=babelHelpers.classPrivateFieldLooseKey("aiAutostartSettings");var q=babelHelpers.classPrivateFieldLooseKey("isSetAiSettingsRequestRunning");var z=babelHelpers.classPrivateFieldLooseKey("extensionSettings");var J=babelHelpers.classPrivateFieldLooseKey("bindEvents");var Q=babelHelpers.classPrivateFieldLooseKey("getItems");var Z=babelHelpers.classPrivateFieldLooseKey("getPushCrmSettings");var ee=babelHelpers.classPrivateFieldLooseKey("shouldShowLastActivitySortToggle");var se=babelHelpers.classPrivateFieldLooseKey("getLastActivitySortToggle");var te=babelHelpers.classPrivateFieldLooseKey("isLastActivitySortEnabled");var ae=babelHelpers.classPrivateFieldLooseKey("handleLastActivitySortToggleClick");var le=babelHelpers.classPrivateFieldLooseKey("shouldShowTodoSkipMenu");var ie=babelHelpers.classPrivateFieldLooseKey("shouldShowTodoPingSettingsMenu");var re=babelHelpers.classPrivateFieldLooseKey("getCoPilotSettings");var oe=babelHelpers.classPrivateFieldLooseKey("handleCoPilotMenuItemClick");var ne=babelHelpers.classPrivateFieldLooseKey("getAllOperationTypes");var be=babelHelpers.classPrivateFieldLooseKey("getTranscribeAIOperationType");class ce{constructor(e){Object.defineProperty(this,be,{value:Te});Object.defineProperty(this,ne,{value:Be});Object.defineProperty(this,oe,{value:ge});Object.defineProperty(this,re,{value:He});Object.defineProperty(this,ie,{value:Fe});Object.defineProperty(this,le,{value:ye});Object.defineProperty(this,ae,{value:Le});Object.defineProperty(this,te,{value:he});Object.defineProperty(this,se,{value:Pe});Object.defineProperty(this,ee,{value:ue});Object.defineProperty(this,Z,{value:pe});Object.defineProperty(this,Q,{value:ve});Object.defineProperty(this,J,{value:de});Object.defineProperty(this,K,{writable:true,value:void 0});Object.defineProperty(this,N,{writable:true,value:void 0});Object.defineProperty(this,R,{writable:true,value:void 0});Object.defineProperty(this,x,{writable:true,value:void 0});Object.defineProperty(this,X,{writable:true,value:void 0});Object.defineProperty(this,k,{writable:true,value:void 0});Object.defineProperty(this,Y,{writable:true,value:void 0});Object.defineProperty(this,G,{writable:true,value:null});Object.defineProperty(this,U,{writable:true,value:void 0});Object.defineProperty(this,W,{writable:true,value:void 0});Object.defineProperty(this,V,{writable:true,value:false});Object.defineProperty(this,$,{writable:true,value:false});Object.defineProperty(this,D,{writable:true,value:null});Object.defineProperty(this,q,{writable:true,value:false});Object.defineProperty(this,z,{writable:true,value:l.Extension.getSettings("crm.settings-button-extender")});babelHelpers.classPrivateFieldLooseBase(this,K)[K]=l.Text.toInteger(e.entityTypeId);babelHelpers.classPrivateFieldLooseBase(this,N)[N]=l.Type.isInteger(e.categoryId)?e.categoryId:null;babelHelpers.classPrivateFieldLooseBase(this,R)[R]=l.Type.isPlainObject(e.pingSettings)?e.pingSettings:{};babelHelpers.classPrivateFieldLooseBase(this,$)[$]=l.Text.toBoolean(e.smartActivityNotificationSupported);if(w&&!w.isDefined(babelHelpers.classPrivateFieldLooseBase(this,K)[K])){throw new Error(`Provided entityTypeId is invalid: ${babelHelpers.classPrivateFieldLooseBase(this,K)[K]}`)}babelHelpers.classPrivateFieldLooseBase(this,x)[x]=b(e.rootMenu,o.Menu,"params.rootMenu");babelHelpers.classPrivateFieldLooseBase(this,X)[X]=c(e.targetItemId,"params.targetItemId");babelHelpers.classPrivateFieldLooseBase(this,k)[k]=n(e.controller,r.SettingsController,"params.controller");babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]=n(e.restriction,i.Restriction,"params.restriction");if(l.Reflection.getClass("BX.Main.grid")&&e.grid){babelHelpers.classPrivateFieldLooseBase(this,G)[G]=new f(babelHelpers.classPrivateFieldLooseBase(this,K)[K],e.grid)}babelHelpers.classPrivateFieldLooseBase(this,U)[U]=new s.TodoNotificationSkipMenu({entityTypeId:babelHelpers.classPrivateFieldLooseBase(this,K)[K],selectedValue:c(e.todoCreateNotificationSkipPeriod,"params.todoCreateNotificationSkipPeriod")});if(Object.keys(babelHelpers.classPrivateFieldLooseBase(this,R)[R]).length>0){babelHelpers.classPrivateFieldLooseBase(this,W)[W]=new t.TodoPingSettingsMenu({entityTypeId:babelHelpers.classPrivateFieldLooseBase(this,K)[K],settings:babelHelpers.classPrivateFieldLooseBase(this,R)[R]})}const a=c(e.aiAutostartSettings,"params.aiAutostartSettings");if(l.Type.isStringFilled(a)){const e=JSON.parse(a);if(l.Type.isPlainObject(e)){babelHelpers.classPrivateFieldLooseBase(this,D)[D]=e}}babelHelpers.classPrivateFieldLooseBase(this,J)[J]()}}function de(){const e=[];a.EventEmitter.subscribe(a.EventEmitter.GLOBAL_TARGET,"onPopupShow",(s=>{const t=s.getTarget();if(t.getId()!==babelHelpers.classPrivateFieldLooseBase(this,x)[x].getId()){return}const a=babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]();if(a.length<=0){return}while(e.length>0){babelHelpers.classPrivateFieldLooseBase(this,x)[x].removeMenuItem(e.pop())}let l=babelHelpers.classPrivateFieldLooseBase(this,X)[X];for(const s of a.reverse()){const t=babelHelpers.classPrivateFieldLooseBase(this,x)[x].addMenuItem(s,l);l=t.getId();e.push(t.getId())}}))}function ve(){const e=[];const s=babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]();if(s){e.push(s)}const t=babelHelpers.classPrivateFieldLooseBase(this,re)[re]();if(t){e.push(t)}return e}function pe(){const e=[];if(babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]()){e.push(babelHelpers.classPrivateFieldLooseBase(this,se)[se]())}if(babelHelpers.classPrivateFieldLooseBase(this,le)[le]()){e.push(...babelHelpers.classPrivateFieldLooseBase(this,U)[U].getItems())}if(babelHelpers.classPrivateFieldLooseBase(this,ie)[ie]()){e.push(...babelHelpers.classPrivateFieldLooseBase(this,W)[W].getItems())}if(e.length<=0){return null}return{text:l.Loc.getMessage("CRM_SETTINGS_BUTTON_EXTENDER_PUSH_CRM"),items:e}}function ue(){var e,s,t;const a=((e=babelHelpers.classPrivateFieldLooseBase(this,k)[k])==null?void 0:e.getCurrentSettings().isTypeSupported(r.Type.BY_LAST_ACTIVITY_TIME))&&((s=babelHelpers.classPrivateFieldLooseBase(this,Y)[Y])==null?void 0:s.isSortTypeChangeAvailable());return!!(a||(t=babelHelpers.classPrivateFieldLooseBase(this,G)[G])!=null&&t.isLastActivitySortSupported())}function Pe(){return{text:l.Loc.getMessage("CRM_SETTINGS_BUTTON_EXTENDER_PUSH_CRM_TOGGLE_SORT"),disabled:babelHelpers.classPrivateFieldLooseBase(this,V)[V],className:babelHelpers.classPrivateFieldLooseBase(this,te)[te]()?E:j,onclick:babelHelpers.classPrivateFieldLooseBase(this,ae)[ae].bind(this)}}function he(){if(babelHelpers.classPrivateFieldLooseBase(this,k)[k]){return babelHelpers.classPrivateFieldLooseBase(this,k)[k].getCurrentSettings().getCurrentType()===r.Type.BY_LAST_ACTIVITY_TIME}if(babelHelpers.classPrivateFieldLooseBase(this,G)[G]){return babelHelpers.classPrivateFieldLooseBase(this,G)[G].isLastActivitySortEnabled()}return false}function Le(e,s){var t,a;(t=s.getMenuWindow())==null?void 0:(a=t.getRootMenuWindow())==null?void 0:a.close();s.disable();if(babelHelpers.classPrivateFieldLooseBase(this,k)[k]){if(babelHelpers.classPrivateFieldLooseBase(this,V)[V]){return}babelHelpers.classPrivateFieldLooseBase(this,V)[V]=true;const e=babelHelpers.classPrivateFieldLooseBase(this,k)[k].getCurrentSettings();let t;if(e.getCurrentType()===r.Type.BY_LAST_ACTIVITY_TIME){t=e.getSupportedTypes().find((e=>e!==r.Type.BY_LAST_ACTIVITY_TIME))}else{t=r.Type.BY_LAST_ACTIVITY_TIME}babelHelpers.classPrivateFieldLooseBase(this,k)[k].setCurrentSortType(t).then((()=>{})).catch((()=>{})).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,V)[V]=false;s.enable()}))}else if(babelHelpers.classPrivateFieldLooseBase(this,G)[G]){babelHelpers.classPrivateFieldLooseBase(this,G)[G].toggleLastActivitySort();s.enable()}else{console.error("Can not handle last activity toggle click")}}function ye(){return babelHelpers.classPrivateFieldLooseBase(this,$)[$]}function Fe(){return babelHelpers.classPrivateFieldLooseBase(this,W)[W]&&babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]()}function He(){var e,s,t,a,i,r;if(!l.Type.isPlainObject(babelHelpers.classPrivateFieldLooseBase(this,D)[D])){return null}const o=(e=babelHelpers.classPrivateFieldLooseBase(this,D)[D])==null?void 0:(s=e.autostartOperationTypes)==null?void 0:s.includes(babelHelpers.classPrivateFieldLooseBase(this,be)[be]());const n=(t=babelHelpers.classPrivateFieldLooseBase(this,D)[D])==null?void 0:t.autostartTranscriptionOnlyOnFirstCallWithRecording;let b=null;if(!babelHelpers.classPrivateFieldLooseBase(this,z)[z].get("isAIEnabledInGlobalSettings")){b=()=>{if(l.Reflection.getClass("BX.UI.InfoHelper.show")){BX.UI.InfoHelper.show("limit_copilot_off")}}}return{text:l.Loc.getMessage("CRM_COMMON_COPILOT"),disabled:babelHelpers.classPrivateFieldLooseBase(this,q)[q],items:[{text:l.Loc.getMessage("CRM_SETTINGS_BUTTON_EXTENDER_COPILOT_AUTO_CALLS_PROCESSING_FIRST_INCOMING"),className:o&&n?E:j,onclick:(a=b)!=null?a:babelHelpers.classPrivateFieldLooseBase(this,oe)[oe].bind(this,"firstCall")},{text:l.Loc.getMessage("CRM_SETTINGS_BUTTON_EXTENDER_COPILOT_AUTO_CALLS_PROCESSING_ALL"),className:o&&!n?E:j,onclick:(i=b)!=null?i:babelHelpers.classPrivateFieldLooseBase(this,oe)[oe].bind(this,"allCalls")},{text:l.Loc.getMessage("CRM_SETTINGS_BUTTON_EXTENDER_COPILOT_MANUAL_CALLS_PROCESSING"),className:o?j:E,onclick:(r=b)!=null?r:babelHelpers.classPrivateFieldLooseBase(this,oe)[oe].bind(this,"manual")}]}}function ge(e,s,t){var a,i,r,o;(a=t.getMenuWindow())==null?void 0:(i=a.getRootMenuWindow())==null?void 0:i.close();(r=t.getMenuWindow())==null?void 0:(o=r.getParentMenuItem())==null?void 0:o.disable();if(babelHelpers.classPrivateFieldLooseBase(this,q)[q]){return}babelHelpers.classPrivateFieldLooseBase(this,q)[q]=true;switch(e){case"manual":babelHelpers.classPrivateFieldLooseBase(this,D)[D].autostartOperationTypes=babelHelpers.classPrivateFieldLooseBase(this,ne)[ne]().filter((e=>e!==babelHelpers.classPrivateFieldLooseBase(this,be)[be]()));break;case"firstCall":babelHelpers.classPrivateFieldLooseBase(this,D)[D].autostartOperationTypes=babelHelpers.classPrivateFieldLooseBase(this,ne)[ne]();babelHelpers.classPrivateFieldLooseBase(this,D)[D].autostartTranscriptionOnlyOnFirstCallWithRecording=true;break;case"allCalls":babelHelpers.classPrivateFieldLooseBase(this,D)[D].autostartOperationTypes=babelHelpers.classPrivateFieldLooseBase(this,ne)[ne]();babelHelpers.classPrivateFieldLooseBase(this,D)[D].autostartTranscriptionOnlyOnFirstCallWithRecording=false;break}l.ajax.runAction("crm.settings.ai.saveAutostartSettings",{json:{entityTypeId:babelHelpers.classPrivateFieldLooseBase(this,K)[K],categoryId:babelHelpers.classPrivateFieldLooseBase(this,N)[N],settings:babelHelpers.classPrivateFieldLooseBase(this,D)[D]}}).then((({data:e})=>{var s,a;babelHelpers.classPrivateFieldLooseBase(this,D)[D]=e.settings;(s=t.getMenuWindow())==null?void 0:(a=s.getParentMenuItem())==null?void 0:a.enable();babelHelpers.classPrivateFieldLooseBase(this,q)[q]=false})).catch((({errors:e})=>{console.error("Could not save ai settings",e);return l.ajax.runAction("crm.settings.ai.getAutostartSettings",{json:{entityTypeId:babelHelpers.classPrivateFieldLooseBase(this,K)[K],categoryId:babelHelpers.classPrivateFieldLooseBase(this,N)[N]}})})).then((({data:e})=>{var s,a;babelHelpers.classPrivateFieldLooseBase(this,D)[D]=e.settings;(s=t.getMenuWindow())==null?void 0:(a=s.getParentMenuItem())==null?void 0:a.enable();babelHelpers.classPrivateFieldLooseBase(this,q)[q]=false})).catch((({errors:e})=>{var s,a;console.error("Could not fetch ai settings after error in save",e);(s=t.getMenuWindow())==null?void 0:(a=s.getParentMenuItem())==null?void 0:a.enable();babelHelpers.classPrivateFieldLooseBase(this,q)[q]=false}))}function Be(){return babelHelpers.classPrivateFieldLooseBase(this,z)[z].get("allAIOperationTypes").map((e=>l.Text.toInteger(e)))}function Te(){return l.Text.toInteger(babelHelpers.classPrivateFieldLooseBase(this,z)[z].get("transcribeAIOperationType"))}e.SettingsButtonExtender=ce})(this.BX.Crm=this.BX.Crm||{},BX.Crm.Activity,BX.Crm.Activity,BX.Event,BX,BX.CRM.Kanban,BX.CRM.Kanban,BX.Main);
//# sourceMappingURL=settings-button-extender.bundle.map.js