this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,s,r){"use strict";function i(e){if(e instanceof r.ItemIdentifier){return}throw new Error("Argument should be an instance of ItemIdentifier")}function a(e){if(e instanceof v){return}throw new Error("Argument should be an instance of Receiver")}function l(e){const t=s.Type.isPlainObject(e)&&(s.Type.isNil(e.id)||s.Type.isInteger(e.id))&&s.Type.isStringFilled(e.typeId)&&s.Type.isStringFilled(e.valueType)&&s.Type.isStringFilled(e.value);if(t){return}throw new Error("Argument should be an object of valid MultifieldValue structure")}function o(e){const t=s.Type.isPlainObject(e)&&s.Type.isStringFilled(e.title);if(t){return}throw new Error("Argument should be an object of valid SourceData structure")}var n=babelHelpers.classPrivateFieldLooseKey("rootSource");var d=babelHelpers.classPrivateFieldLooseKey("addressSource");var c=babelHelpers.classPrivateFieldLooseKey("addressSourceData");var u=babelHelpers.classPrivateFieldLooseKey("address");class v{constructor(e,t,s,r=null){Object.defineProperty(this,n,{writable:true,value:void 0});Object.defineProperty(this,d,{writable:true,value:void 0});Object.defineProperty(this,c,{writable:true,value:null});Object.defineProperty(this,u,{writable:true,value:void 0});i(e);babelHelpers.classPrivateFieldLooseBase(this,n)[n]=e;i(t);babelHelpers.classPrivateFieldLooseBase(this,d)[d]=t;l(s);babelHelpers.classPrivateFieldLooseBase(this,u)[u]=Object.freeze({id:s.id,typeId:s.typeId,valueType:s.valueType,value:s.value,valueFormatted:s.valueFormatted});if(r){o(r);babelHelpers.classPrivateFieldLooseBase(this,c)[c]=Object.freeze({title:r.title})}}static fromJSON(e){const t=r.ItemIdentifier.fromJSON(e==null?void 0:e.rootSource);if(!t){return null}const s=r.ItemIdentifier.fromJSON(e==null?void 0:e.addressSource);if(!s){return null}try{return new v(t,s,e==null?void 0:e.address,e==null?void 0:e.addressSourceData)}catch(e){return null}}get rootSource(){return babelHelpers.classPrivateFieldLooseBase(this,n)[n]}get addressSource(){return babelHelpers.classPrivateFieldLooseBase(this,d)[d]}get addressSourceData(){return babelHelpers.classPrivateFieldLooseBase(this,c)[c]}get address(){return babelHelpers.classPrivateFieldLooseBase(this,u)[u]}isEqualTo(e){if(!(e instanceof v)){return false}return this.rootSource.isEqualTo(e.rootSource)&&this.addressSource.isEqualTo(e.addressSource)&&String(this.address.typeId)===String(e.address.typeId)&&String(this.address.valueType)===String(e.address.valueType)&&String(this.address.value)===String(e.address.value)}}function b(e,t){const s=[];if(t!=null&&t.hasOwnProperty("MULTIFIELD_DATA")){s.push(...p(e,t))}if(t!=null&&t.hasOwnProperty("CLIENT_INFO")){s.push(...f(e,t.CLIENT_INFO))}return P(s)}function p(e,t){const i=[];const a=t.MULTIFIELD_DATA;for(const l in a){if(!a.hasOwnProperty(l)||!s.Type.isPlainObject(a[l])){continue}for(const o in a[l]){if(!a[l].hasOwnProperty(o)||!s.Type.isArrayFilled(a[l][o])){continue}const[n,d]=o.split("_");let c;try{c=new r.ItemIdentifier(s.Text.toInteger(n),s.Text.toInteger(d))}catch(e){continue}const u=y(e,c,t);for(const t of a[l][o]){try{i.push(new v(e,c,{id:s.Text.toInteger(t.ID),typeId:String(l),valueType:h(t.VALUE_TYPE),value:h(t.VALUE),valueFormatted:h(t.VALUE_FORMATTED)},{title:u}))}catch(e){}}}}return i}function y(e,t,r){var i;if(e.isEqualTo(t)){var a,l;return(a=(l=r==null?void 0:r.TITLE)!=null?l:r.FORMATTED_NAME)!=null?a:""}const o=`${BX.CrmEntityType.resolveName(t.entityTypeId)}_DATA`;if(s.Type.isArrayFilled(r==null?void 0:(i=r.CLIENT_INFO)==null?void 0:i[o])){const e=r.CLIENT_INFO[o].find((e=>s.Text.toInteger(e.id)===t.entityId));if(s.Type.isString(e==null?void 0:e.title)){return e.title}}return""}function f(e,t){const i=[];for(const l of Object.values(t)){if(!s.Type.isArrayFilled(l)){continue}for(const t of l){var a;if(!s.Type.isPlainObject(t)){continue}let l;try{l=new r.ItemIdentifier(BX.CrmEntityType.resolveId(t.typeName),t.id)}catch(e){continue}const o=(a=t.advancedInfo)==null?void 0:a.multiFields;if(!s.Type.isArrayFilled(o)){continue}for(const r of o){try{i.push(new v(e,l,{id:s.Text.toInteger(r.ID),typeId:h(r.TYPE_ID),valueType:h(r.VALUE_TYPE),value:h(r.VALUE),valueFormatted:h(r.VALUE_FORMATTED)},{title:h(t.title)}))}catch(e){}}}}return i}function h(e){return s.Type.isNil(e)?undefined:String(e)}function P(e){return e.filter(((t,s)=>{const r=e.findIndex((e=>t.isEqualTo(e)));return r===s}))}const F=new Set(["onCrmEntityCreate","onCrmEntityUpdate","onCrmEntityDelete"]);var T=babelHelpers.classPrivateFieldLooseKey("instance");var L=babelHelpers.classPrivateFieldLooseKey("onDetailsTabChangeEventHandler");var I=babelHelpers.classPrivateFieldLooseKey("storage");var m=babelHelpers.classPrivateFieldLooseKey("observedItems");var B=babelHelpers.classPrivateFieldLooseKey("init");var E=babelHelpers.classPrivateFieldLooseKey("destroy");var g=babelHelpers.classPrivateFieldLooseKey("onCrmEntityChange");var H=babelHelpers.classPrivateFieldLooseKey("addReceivers");var w=babelHelpers.classPrivateFieldLooseKey("startObservingItem");class S{static get Instance(){if(window.top!==window&&s.Reflection.getClass("top.BX.Crm.MessageSender.ReceiverRepository")){return window.top.BX.Crm.MessageSender.ReceiverRepository}if(!babelHelpers.classPrivateFieldLooseBase(S,T)[T]){babelHelpers.classPrivateFieldLooseBase(S,T)[T]=new S}return babelHelpers.classPrivateFieldLooseBase(S,T)[T]}constructor(){Object.defineProperty(this,w,{value:j});Object.defineProperty(this,H,{value:D});Object.defineProperty(this,g,{value:A});Object.defineProperty(this,E,{value:C});Object.defineProperty(this,B,{value:O});Object.defineProperty(this,L,{writable:true,value:void 0});Object.defineProperty(this,I,{writable:true,value:{}});Object.defineProperty(this,m,{writable:true,value:{}});if(babelHelpers.classPrivateFieldLooseBase(S,T)[T]){throw new Error("Attempt to make a new instance of a singleton")}babelHelpers.classPrivateFieldLooseBase(this,B)[B]()}static onDetailsLoad(e,t,i){let a;try{a=new r.ItemIdentifier(e,t)}catch(e){return}const l=S.Instance;babelHelpers.classPrivateFieldLooseBase(l,w)[w](a);const o=JSON.parse(i);if(s.Type.isArrayFilled(o)){const e=[];for(const t of o){const r=v.fromJSON(t);if(!s.Type.isNil(r)){e.push(r)}}if(s.Type.isArrayFilled(e)){babelHelpers.classPrivateFieldLooseBase(l,H)[H](a,e)}}}getReceivers(e,t){try{return this.getReceiversByIdentifier(new r.ItemIdentifier(e,t))}catch(e){return[]}}getReceiversByIdentifier(e){var t;i(e);return(t=babelHelpers.classPrivateFieldLooseBase(this,I)[I][e.hash])!=null?t:[]}}function O(){var e,r;t.EventEmitter.makeObservable(this,"BX.Crm.MessageSender.ReceiverRepository");babelHelpers.classPrivateFieldLooseBase(this,L)[L]=e=>{if(!(e instanceof t.BaseEvent)){console.error("unexpected event type",e);return}if(!s.Type.isArrayFilled(e.getData())||!s.Type.isPlainObject(e.getData()[0])){return}babelHelpers.classPrivateFieldLooseBase(this,g)[g](e.getType(),e.getData()[0])};babelHelpers.classPrivateFieldLooseBase(this,L)[L]=babelHelpers.classPrivateFieldLooseBase(this,L)[L].bind(this);for(const e of F){t.EventEmitter.subscribe(e,babelHelpers.classPrivateFieldLooseBase(this,L)[L])}if((e=BX.SidePanel)!=null&&(r=e.Instance)!=null&&r.isOpen()){t.EventEmitter.subscribe("SidePanel.Slider:onDestroy",babelHelpers.classPrivateFieldLooseBase(this,E)[E].bind(this))}}function C(){for(const e of F){t.EventEmitter.unsubscribe(e,babelHelpers.classPrivateFieldLooseBase(this,L)[L])}babelHelpers.classPrivateFieldLooseBase(S,T)[T]=null}function A(e,{entityTypeId:t,entityId:i,entityData:a}){var l;if(!((l=babelHelpers.classPrivateFieldLooseBase(this,m)[m][t])!=null&&l.has(i))){return}const o=new r.ItemIdentifier(t,i);if(e.toLowerCase()==="onCrmEntityCreate".toLowerCase()||e.toLowerCase()==="onCrmEntityUpdate".toLowerCase()){var n;const e=(n=babelHelpers.classPrivateFieldLooseBase(this,I)[I][o.hash])!=null?n:[];const t=b(o,a);babelHelpers.classPrivateFieldLooseBase(this,I)[I][o.hash]=t;const r=t.filter((t=>s.Type.isNil(e.find((e=>e.isEqualTo(t))))));const i=e.filter((e=>s.Type.isNil(t.find((t=>t.isEqualTo(e))))));if(r.length>0||i.length>0){this.emit("OnReceiversChanged",{item:o,previous:e,current:t,added:r,deleted:i})}}else if(e.toLowerCase()==="onCrmEntityDelete".toLowerCase()){delete babelHelpers.classPrivateFieldLooseBase(this,I)[I][o.hash];babelHelpers.classPrivateFieldLooseBase(this,m)[m][o.entityTypeId].delete(o.entityId);this.emit("OnItemDeleted",{item:o})}else{console.error("unknown event type",e)}}function D(e,t){i(e);babelHelpers.classPrivateFieldLooseBase(this,I)[I][e.hash]=[];for(const s of t){a(s);babelHelpers.classPrivateFieldLooseBase(this,I)[I][e.hash].push(s)}babelHelpers.classPrivateFieldLooseBase(this,w)[w](e)}function j(e){var t;i(e);const s=(t=babelHelpers.classPrivateFieldLooseBase(this,m)[m][e.entityTypeId])!=null?t:new Set;s.add(e.entityId);babelHelpers.classPrivateFieldLooseBase(this,m)[m][e.entityTypeId]=s}Object.defineProperty(S,T,{writable:true,value:void 0});e.ReceiverRepository=S;e.Receiver=v})(this.BX.Crm.MessageSender=this.BX.Crm.MessageSender||{},BX.Event,BX,BX.Crm.DataStructures);
//# sourceMappingURL=messagesender.bundle.map.js