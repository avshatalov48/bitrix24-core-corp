this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,s,i,r,n){"use strict";const a=Object.freeze({bitrix24:"bitrix24",sms:"sms_provider"});var l=babelHelpers.classPrivateFieldLooseKey("senderType");var o=babelHelpers.classPrivateFieldLooseKey("showConsentAgreementBox");var c=babelHelpers.classPrivateFieldLooseKey("getButtons");var d=babelHelpers.classPrivateFieldLooseKey("approveConsent");var u=babelHelpers.classPrivateFieldLooseKey("closeAgreementBox");var p=babelHelpers.classPrivateFieldLooseKey("showNotify");class b{constructor(e=null){Object.defineProperty(this,p,{value:L});Object.defineProperty(this,u,{value:f});Object.defineProperty(this,d,{value:y});Object.defineProperty(this,c,{value:v});Object.defineProperty(this,o,{value:h});Object.defineProperty(this,l,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,l)[l]=e}async checkAndApprove(){if(babelHelpers.classPrivateFieldLooseBase(this,l)[l]!==a.bitrix24){return Promise.resolve(true)}return new Promise((e=>{r.ajax.runAction("notifications.consent.Agreement.get").then((({data:t})=>{if(!t||!t.html){e(true);return}babelHelpers.classPrivateFieldLooseBase(this,o)[o](t,e)})).catch((()=>{babelHelpers.classPrivateFieldLooseBase(this,p)[p](r.Loc.getMessage("CRM_MESSAGESENDER_B24_CONSENT_AGREEMENT_VALIDATION_ERROR"));e(false)}))}))}}function h({title:e,html:t},s){BX.UI.Dialogs.MessageBox.show({modal:true,minWidth:980,title:e,message:t,buttons:babelHelpers.classPrivateFieldLooseBase(this,c)[c](s),popupOptions:{className:"crm-agreement-terms-popup"}})}function v(e){return[new BX.UI.Button({className:"ui-btn-round",color:BX.UI.Button.Color.SUCCESS,text:r.Loc.getMessage("CRM_MESSAGESENDER_B24_CONSENT_ACCEPT"),onclick:t=>{babelHelpers.classPrivateFieldLooseBase(this,d)[d]();babelHelpers.classPrivateFieldLooseBase(this,p)[p](r.Loc.getMessage("CRM_MESSAGESENDER_B24_AGREEMENT_ACCEPT"));babelHelpers.classPrivateFieldLooseBase(this,u)[u](t);e(true)}}),new BX.UI.Button({className:"ui-btn-round",color:BX.UI.Button.Color.LIGHT_BORDER,text:r.Loc.getMessage("CRM_MESSAGESENDER_B24_CONSENT_REJECT"),onclick:t=>{babelHelpers.classPrivateFieldLooseBase(this,u)[u](t);e(false)}})]}function y(){void r.ajax.runAction("notifications.consent.Agreement.approve")}function f({context:e}){e.close()}function L(e){BX.UI.Notification.Center.notify({content:e})}const E=e=>{BX.UI.Notification.Center.notify({content:e})};var P=babelHelpers.classPrivateFieldLooseKey("showConnectAlertMessage");class I{constructor(e){Object.defineProperty(this,P,{value:g});this.openLineItems=null;this.senderType=null;this.entityTypeId=null;if(r.Type.isPlainObject(e==null?void 0:e.openLineItems)){var t,s;this.openLineItems=(t=e.openLineItems)!=null?t:null;this.senderType=(s=e.senderType)!=null?s:null}if(r.Type.isNumber(e==null?void 0:e.entityTypeId)){this.entityTypeId=e.entityTypeId}}getOpenLineCode(){throw new Error("Must be implement in child class")}async checkAndGetLineId(){await babelHelpers.classPrivateFieldLooseBase(this,P)[P]();return Promise.resolve(null)}async isOpenLineItemSelected(e=false){const t=await this.getOpenLineItem(e);if(!t){throw new ReferenceError(`OpenLine item with code: ${this.getOpenLineCode()} not found`)}return t.selected}async getOpenLineItem(e=false,t=null){if(this.openLineItems===null||e){this.openLineItems=await this.fetchOpenLineItems()}return this.openLineItems[t!=null?t:this.getOpenLineCode()]}async fetchOpenLineItems(){return new Promise(((e,t)=>{r.ajax.runAction("crm.controller.integration.openlines.getItems").then((({status:s,data:i,errors:r})=>{if(s==="success"){e(i);return}t(r)})).catch((e=>{t(e)}))}))}async getLineId(){return new Promise((e=>{const t={connectorId:this.getOpenLineCode(),withConnector:true};r.ajax.runAction("imconnector.Openlines.list",{data:t}).then((({data:t})=>{if(r.Type.isArrayFilled(t)){const{lineId:s}=t[t.length-1];e(s);return}e(null)})).catch((()=>{E(r.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR"))}))}))}async canEditConnector(){return new Promise((e=>{r.ajax.runAction("imconnector.Openlines.hasAccess").then((({data:t})=>{if(t.canEditConnector){e(true);return}e(false)})).catch((()=>babelHelpers.classPrivateFieldLooseBase(this,P)[P]()))}))}async openConnectSidePanel(e,s){return new Promise((i=>{if(r.Type.isStringFilled(e)){void t.Router.openSlider(e,{width:700,cacheable:false}).then((()=>{s(i)}));return}E(r.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR"));i(null)}))}}async function g(){const e=await this.getOpenLineItem();const t=r.Loc.getMessage("CRM_MESSAGESENDER_B24_CONNECT_ACCESS_DENIED",{"#SERVICE_NAME#":e.name});E(t)}var m=babelHelpers.classPrivateFieldLooseKey("checkVirtualWhatsAppAvailable");var F=babelHelpers.classPrivateFieldLooseKey("fetchVirtualWhatsAppConfig");var C=babelHelpers.classPrivateFieldLooseKey("isVirtualWhatsAppConnected");class S extends I{constructor(...e){super(...e);Object.defineProperty(this,C,{value:T});Object.defineProperty(this,F,{value:w});Object.defineProperty(this,m,{value:B})}async checkAndGetLineId(){const e=await babelHelpers.classPrivateFieldLooseBase(this,m)[m]();if(!e){return null}const t=await this.isOpenLineItemSelected();if(t){if(await babelHelpers.classPrivateFieldLooseBase(this,C)[C]()){return this.getLineId()}const e=await this.canEditConnector();if(e){var s,i;const e=(s=this.openLineItems)==null?void 0:(i=s.virtual_whatsapp)==null?void 0:i.url;return this.openConnectSidePanel(e,this.onConnectVirtualWhatsApp.bind(this))}return super.checkAndGetLineId()}const r=await this.canEditConnector();if(r){const e=await this.getOpenLineItem();return this.openConnectSidePanel(e.url,this.onConnect.bind(this))}return super.checkAndGetLineId()}async onConnectVirtualWhatsApp(e){if(await babelHelpers.classPrivateFieldLooseBase(this,C)[C]()){return e(this.getLineId())}E(r.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR"));return e(null)}async onConnect(e){const t=await this.isOpenLineItemSelected(true);if(t){return e(this.checkAndGetLineId())}E(r.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR"));return e(null)}getOpenLineCode(){return"notifications"}}async function B(){const e=await babelHelpers.classPrivateFieldLooseBase(this,F)[F]();if(r.Type.isStringFilled(e.infoHelperCode)){if(r.Reflection.getClass("BX.UI.InfoHelper.show")){BX.UI.InfoHelper.show(e.infoHelperCode)}return false}return true}function w(){const{entityTypeId:e}=this;return new Promise(((t,s)=>{r.ajax.runAction("crm.controller.messagesender.conditionchecker.getVirtualWhatsAppConfig",{data:{entityTypeId:e}}).then((({status:e,data:i,errors:r})=>{if(e==="success"){t(i);return}s(r)})).catch((e=>s(e)))}))}async function T(){const e=await this.getOpenLineItem(true,"virtual_whatsapp");return e==null?void 0:e.selected}var O=babelHelpers.classPrivateFieldLooseKey("checkConsentApproved");class H extends I{constructor(...e){super(...e);Object.defineProperty(this,O,{value:A})}async checkAndGetLineId(){const e=await this.isOpenLineItemSelected();if(e){const e=await babelHelpers.classPrivateFieldLooseBase(this,O)[O]();if(e){const e=await this.getLineId();if(!e){const e=await this.getOpenLineItem();return this.openConnectSidePanel(e.url,this.onConnect.bind(this))}return Promise.resolve(e)}E(r.Loc.getMessage("CRM_MESSAGESENDER_B24_AGREEMENT_NOTIFY"));return Promise.resolve(null)}const t=await this.canEditConnector();if(t){const e=await this.getOpenLineItem();return this.openConnectSidePanel(e.url,this.onConnect.bind(this))}return super.checkAndGetLineId()}async onConnect(e){const t=await this.getLineId();if(t===null){E(r.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR"));return e(null)}const s=await this.getOpenLineItem(true);E(r.Loc.getMessage("CRM_MESSAGESENDER_B24_CONNECT_SUCCESS",{"#LINE_NAME#":s.name}));const i=await babelHelpers.classPrivateFieldLooseBase(this,O)[O]();if(i){return e(t)}E(r.Loc.getMessage("CRM_MESSAGESENDER_B24_AGREEMENT_NOTIFY"));return e(null)}getOpenLineCode(){return"telegrambot"}}async function A(){return new b(this.senderType).checkAndApprove()}var _=babelHelpers.classPrivateFieldLooseKey("checkVirtualWhatsAppAvailable");var N=babelHelpers.classPrivateFieldLooseKey("fetchVirtualWhatsAppConfig");var R=babelHelpers.classPrivateFieldLooseKey("isVirtualWhatsAppConnected");var M=babelHelpers.classPrivateFieldLooseKey("hasAvailableSmsProvider");var D=babelHelpers.classPrivateFieldLooseKey("getSmsSenders");var j=babelHelpers.classPrivateFieldLooseKey("showMarketplaceDialog");var K=babelHelpers.classPrivateFieldLooseKey("openMarketplace");var k=babelHelpers.classPrivateFieldLooseKey("onCloseMarketplace");var G=babelHelpers.classPrivateFieldLooseKey("getSettings");class X extends I{constructor(...e){super(...e);Object.defineProperty(this,G,{value:$});Object.defineProperty(this,k,{value:z});Object.defineProperty(this,K,{value:Y});Object.defineProperty(this,j,{value:J});Object.defineProperty(this,D,{value:q});Object.defineProperty(this,M,{value:W});Object.defineProperty(this,R,{value:V});Object.defineProperty(this,N,{value:U});Object.defineProperty(this,_,{value:x})}async checkAndGetLineId(){const e=await babelHelpers.classPrivateFieldLooseBase(this,_)[_]();if(!e){return null}if(await babelHelpers.classPrivateFieldLooseBase(this,R)[R]()){const e=await babelHelpers.classPrivateFieldLooseBase(this,M)[M]();if(e){return Promise.resolve(0)}const t=await this.canEditConnector();if(t){return babelHelpers.classPrivateFieldLooseBase(this,j)[j]()}return super.checkAndGetLineId()}const t=await this.canEditConnector();if(t){var s,i;const e=(s=this.openLineItems)==null?void 0:(i=s.virtual_whatsapp)==null?void 0:i.url;return this.openConnectSidePanel(e,this.onConnectVirtualWhatsApp.bind(this))}return super.checkAndGetLineId()}async onConnectVirtualWhatsApp(e){if(await babelHelpers.classPrivateFieldLooseBase(this,R)[R]()){return e(this.checkAndGetLineId())}E(r.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR"));return e(null)}getOpenLineCode(){return"notifications"}}async function x(){const e=await babelHelpers.classPrivateFieldLooseBase(this,N)[N]();if(r.Type.isStringFilled(e.infoHelperCode)){if(r.Reflection.getClass("BX.UI.InfoHelper.show")){BX.UI.InfoHelper.show(e.infoHelperCode)}return false}return true}function U(){const{entityTypeId:e}=this;return new Promise(((t,s)=>{r.ajax.runAction("crm.controller.messagesender.conditionchecker.getVirtualWhatsAppConfig",{data:{entityTypeId:e}}).then((({status:e,data:i,errors:r})=>{if(e==="success"){t(i);return}s(r)})).catch((e=>s(e)))}))}async function V(){const e=await this.getOpenLineItem(true,"virtual_whatsapp");return e==null?void 0:e.selected}async function W(){const e=await babelHelpers.classPrivateFieldLooseBase(this,D)[D]();return Promise.resolve(e.some((e=>e.canUse&&!e.isTemplatesBased)))}async function q(){const{entityTypeId:e}=this;return new Promise(((t,s)=>{r.ajax.runAction("crm.controller.messagesender.conditionchecker.getSmsSenders",{data:{entityTypeId:e}}).then((({status:e,data:i,errors:r})=>{if(e==="success"){t(i);return}s(r)})).catch((e=>s(e)))}))}function J(){return new Promise((e=>{s.MessageBox.show({message:r.Loc.getMessage("CRM_MESSAGESENDER_B24_CONDITION_CHECKER_MARKET_MESSAGE"),modal:true,buttons:s.MessageBoxButtons.OK_CANCEL,okCaption:r.Loc.getMessage("CRM_MESSAGESENDER_B24_CONDITION_CHECKER_OK_BTN_TEXT"),onOk:t=>{void babelHelpers.classPrivateFieldLooseBase(this,K)[K](e);t.close()}})}))}function Y(e){const t=babelHelpers.classPrivateFieldLooseBase(this,G)[G]().marketUrl;BX.SidePanel.Instance.open(t,{cacheable:false,events:{onClose:()=>{void babelHelpers.classPrivateFieldLooseBase(this,k)[k](e)}}})}async function z(e){const t=await babelHelpers.classPrivateFieldLooseBase(this,M)[M]();if(t){e(0);return}E(r.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR"));e(null)}function $(){return r.Extension.getSettings("crm.messagesender")}class Q{static getScenarioInstance(e,t){if(e==="telegrambot"){return new H(t)}if(e==="ru-whatsapp"){return new S(t)}if(e==="whatsapp"){return new X(t)}throw new RangeError(`Unknown scenario name: ${e}`)}}var Z=babelHelpers.classPrivateFieldLooseKey("openLineItems");var ee=babelHelpers.classPrivateFieldLooseKey("senderType");var te=babelHelpers.classPrivateFieldLooseKey("serviceId");var se=babelHelpers.classPrivateFieldLooseKey("entityTypeId");class ie{static async checkAndGetLine({senderType:e,openLineItems:t=null,serviceId:s=null,entityTypeId:i=null}){const n=new ie({senderType:e});if(r.Type.isObjectLike(t)){n.setOpenLineItems(t)}if(r.Type.isStringFilled(s)){n.setServiceId(s)}else{throw new TypeError("ServiceId is required")}if(BX.CrmEntityType.isDefined(i)){n.setEntityTypeId(i)}else{throw new TypeError("EntityTypeId is not specified or incorrect")}return n.check()}static async checkIsApproved({senderType:e}){const t=new ie({senderType:e});return t.checkApproveConsent()}constructor({senderType:e}){Object.defineProperty(this,Z,{writable:true,value:null});Object.defineProperty(this,ee,{writable:true,value:void 0});Object.defineProperty(this,te,{writable:true,value:void 0});Object.defineProperty(this,se,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]=e}setOpenLineItems(e){babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]=e;return this}setServiceId(e){babelHelpers.classPrivateFieldLooseBase(this,te)[te]=e;return this}setEntityTypeId(e){babelHelpers.classPrivateFieldLooseBase(this,se)[se]=e;return this}async check(){const e=Q.getScenarioInstance(babelHelpers.classPrivateFieldLooseBase(this,te)[te],{senderType:babelHelpers.classPrivateFieldLooseBase(this,ee)[ee],openLineItems:babelHelpers.classPrivateFieldLooseBase(this,Z)[Z],entityTypeId:babelHelpers.classPrivateFieldLooseBase(this,se)[se]});return e.checkAndGetLineId()}async checkApproveConsent(){const e=await new b(babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]).checkAndApprove();if(e){return Promise.resolve(true)}return Promise.resolve(null)}}function re(e){if(e instanceof n.ItemIdentifier){return}throw new Error("Argument should be an instance of ItemIdentifier")}function ne(e){if(e instanceof pe){return}throw new Error("Argument should be an instance of Receiver")}function ae(e){const t=r.Type.isPlainObject(e)&&(r.Type.isNil(e.id)||r.Type.isInteger(e.id))&&r.Type.isStringFilled(e.typeId)&&r.Type.isStringFilled(e.valueType)&&r.Type.isStringFilled(e.value);if(t){return}throw new Error("Argument should be an object of valid MultifieldValue structure")}function le(e){const t=r.Type.isPlainObject(e)&&r.Type.isStringFilled(e.title);if(t){return}throw new Error("Argument should be an object of valid SourceData structure")}var oe=babelHelpers.classPrivateFieldLooseKey("rootSource");var ce=babelHelpers.classPrivateFieldLooseKey("addressSource");var de=babelHelpers.classPrivateFieldLooseKey("addressSourceData");var ue=babelHelpers.classPrivateFieldLooseKey("address");class pe{constructor(e,t,s,i=null){Object.defineProperty(this,oe,{writable:true,value:void 0});Object.defineProperty(this,ce,{writable:true,value:void 0});Object.defineProperty(this,de,{writable:true,value:null});Object.defineProperty(this,ue,{writable:true,value:void 0});re(e);babelHelpers.classPrivateFieldLooseBase(this,oe)[oe]=e;re(t);babelHelpers.classPrivateFieldLooseBase(this,ce)[ce]=t;ae(s);babelHelpers.classPrivateFieldLooseBase(this,ue)[ue]=Object.freeze({id:s.id,typeId:s.typeId,valueType:s.valueType,value:s.value,valueFormatted:s.valueFormatted});if(i){le(i);babelHelpers.classPrivateFieldLooseBase(this,de)[de]=Object.freeze({title:i.title})}}static fromJSON(e){const t=n.ItemIdentifier.fromJSON(e==null?void 0:e.rootSource);if(!t){return null}const s=n.ItemIdentifier.fromJSON(e==null?void 0:e.addressSource);if(!s){return null}try{return new pe(t,s,e==null?void 0:e.address,e==null?void 0:e.addressSourceData)}catch(e){return null}}get rootSource(){return babelHelpers.classPrivateFieldLooseBase(this,oe)[oe]}get addressSource(){return babelHelpers.classPrivateFieldLooseBase(this,ce)[ce]}get addressSourceData(){return babelHelpers.classPrivateFieldLooseBase(this,de)[de]}get address(){return babelHelpers.classPrivateFieldLooseBase(this,ue)[ue]}isEqualTo(e){if(!(e instanceof pe)){return false}return this.rootSource.isEqualTo(e.rootSource)&&this.addressSource.isEqualTo(e.addressSource)&&String(this.address.typeId)===String(e.address.typeId)&&String(this.address.valueType)===String(e.address.valueType)&&String(this.address.value)===String(e.address.value)}}function be(e,t){const s=[];if(t!=null&&t.hasOwnProperty("MULTIFIELD_DATA")){s.push(...he(e,t))}if(t!=null&&t.hasOwnProperty("CLIENT_INFO")){s.push(...ye(e,t.CLIENT_INFO))}return Le(s)}function he(e,t){const s=[];const i=t.MULTIFIELD_DATA;for(const a in i){if(!i.hasOwnProperty(a)||!r.Type.isPlainObject(i[a])){continue}for(const l in i[a]){if(!i[a].hasOwnProperty(l)||!r.Type.isArrayFilled(i[a][l])){continue}const[o,c]=l.split("_");let d;try{d=new n.ItemIdentifier(r.Text.toInteger(o),r.Text.toInteger(c))}catch(e){continue}const u=ve(e,d,t);for(const t of i[a][l]){try{s.push(new pe(e,d,{id:r.Text.toInteger(t.ID),typeId:String(a),valueType:fe(t.VALUE_TYPE),value:fe(t.VALUE),valueFormatted:fe(t.VALUE_FORMATTED)},{title:u}))}catch(e){}}}}return s}function ve(e,t,s){var i;if(e.isEqualTo(t)){var n,a;return(n=(a=s==null?void 0:s.TITLE)!=null?a:s.FORMATTED_NAME)!=null?n:""}const l=`${BX.CrmEntityType.resolveName(t.entityTypeId)}_DATA`;if(r.Type.isArrayFilled(s==null?void 0:(i=s.CLIENT_INFO)==null?void 0:i[l])){const e=s.CLIENT_INFO[l].find((e=>r.Text.toInteger(e.id)===t.entityId));if(r.Type.isString(e==null?void 0:e.title)){return e.title}}return""}function ye(e,t){const s=[];for(const a of Object.values(t)){if(!r.Type.isArrayFilled(a)){continue}for(const t of a){var i;if(!r.Type.isPlainObject(t)){continue}let a;try{a=new n.ItemIdentifier(BX.CrmEntityType.resolveId(t.typeName),t.id)}catch(e){continue}const l=(i=t.advancedInfo)==null?void 0:i.multiFields;if(!r.Type.isArrayFilled(l)){continue}for(const i of l){try{s.push(new pe(e,a,{id:r.Text.toInteger(i.ID),typeId:fe(i.TYPE_ID),valueType:fe(i.VALUE_TYPE),value:fe(i.VALUE),valueFormatted:fe(i.VALUE_FORMATTED)},{title:fe(t.title)}))}catch(e){}}}}return s}function fe(e){return r.Type.isNil(e)?undefined:String(e)}function Le(e){return e.filter(((t,s)=>{const i=e.findIndex((e=>t.isEqualTo(e)));return i===s}))}const Ee=new Set(["onCrmEntityCreate","onCrmEntityUpdate","onCrmEntityDelete"]);var Pe=babelHelpers.classPrivateFieldLooseKey("instance");var Ie=babelHelpers.classPrivateFieldLooseKey("onDetailsTabChangeEventHandler");var ge=babelHelpers.classPrivateFieldLooseKey("storage");var me=babelHelpers.classPrivateFieldLooseKey("observedItems");var Fe=babelHelpers.classPrivateFieldLooseKey("init");var Ce=babelHelpers.classPrivateFieldLooseKey("destroy");var Se=babelHelpers.classPrivateFieldLooseKey("onCrmEntityChange");var Be=babelHelpers.classPrivateFieldLooseKey("addReceivers");var we=babelHelpers.classPrivateFieldLooseKey("startObservingItem");class Te{static get Instance(){if(window.top!==window&&r.Reflection.getClass("top.BX.Crm.MessageSender.ReceiverRepository")){return window.top.BX.Crm.MessageSender.ReceiverRepository}if(!babelHelpers.classPrivateFieldLooseBase(Te,Pe)[Pe]){babelHelpers.classPrivateFieldLooseBase(Te,Pe)[Pe]=new Te}return babelHelpers.classPrivateFieldLooseBase(Te,Pe)[Pe]}constructor(){Object.defineProperty(this,we,{value:Ne});Object.defineProperty(this,Be,{value:_e});Object.defineProperty(this,Se,{value:Ae});Object.defineProperty(this,Ce,{value:He});Object.defineProperty(this,Fe,{value:Oe});Object.defineProperty(this,Ie,{writable:true,value:void 0});Object.defineProperty(this,ge,{writable:true,value:{}});Object.defineProperty(this,me,{writable:true,value:{}});if(babelHelpers.classPrivateFieldLooseBase(Te,Pe)[Pe]){throw new Error("Attempt to make a new instance of a singleton")}babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe]()}static onDetailsLoad(e,t,s){let i;try{i=new n.ItemIdentifier(e,t)}catch(e){return}const a=Te.Instance;babelHelpers.classPrivateFieldLooseBase(a,we)[we](i);const l=JSON.parse(s);if(r.Type.isArrayFilled(l)){const e=[];for(const t of l){const s=pe.fromJSON(t);if(!r.Type.isNil(s)){e.push(s)}}if(r.Type.isArrayFilled(e)){babelHelpers.classPrivateFieldLooseBase(a,Be)[Be](i,e)}}}getReceivers(e,t){try{return this.getReceiversByIdentifier(new n.ItemIdentifier(e,t))}catch(e){return[]}}getReceiversByIdentifier(e){var t;re(e);return(t=babelHelpers.classPrivateFieldLooseBase(this,ge)[ge][e.hash])!=null?t:[]}}function Oe(){var e,t;i.EventEmitter.makeObservable(this,"BX.Crm.MessageSender.ReceiverRepository");babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie]=e=>{if(!(e instanceof i.BaseEvent)){console.error("unexpected event type",e);return}if(!r.Type.isArrayFilled(e.getData())||!r.Type.isPlainObject(e.getData()[0])){return}babelHelpers.classPrivateFieldLooseBase(this,Se)[Se](e.getType(),e.getData()[0])};babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie]=babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie].bind(this);for(const e of Ee){i.EventEmitter.subscribe(e,babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie])}if((e=BX.SidePanel)!=null&&(t=e.Instance)!=null&&t.isOpen()){i.EventEmitter.subscribe("SidePanel.Slider:onDestroy",babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce].bind(this))}}function He(){for(const e of Ee){i.EventEmitter.unsubscribe(e,babelHelpers.classPrivateFieldLooseBase(this,Ie)[Ie])}babelHelpers.classPrivateFieldLooseBase(Te,Pe)[Pe]=null}function Ae(e,{entityTypeId:t,entityId:s,entityData:i}){var a;if(!((a=babelHelpers.classPrivateFieldLooseBase(this,me)[me][t])!=null&&a.has(s))){return}const l=new n.ItemIdentifier(t,s);if(e.toLowerCase()==="onCrmEntityCreate".toLowerCase()||e.toLowerCase()==="onCrmEntityUpdate".toLowerCase()){var o;const e=(o=babelHelpers.classPrivateFieldLooseBase(this,ge)[ge][l.hash])!=null?o:[];const t=be(l,i);babelHelpers.classPrivateFieldLooseBase(this,ge)[ge][l.hash]=t;const s=t.filter((t=>r.Type.isNil(e.find((e=>e.isEqualTo(t))))));const n=e.filter((e=>r.Type.isNil(t.find((t=>t.isEqualTo(e))))));if(s.length>0||n.length>0){this.emit("OnReceiversChanged",{item:l,previous:e,current:t,added:s,deleted:n})}}else if(e.toLowerCase()==="onCrmEntityDelete".toLowerCase()){delete babelHelpers.classPrivateFieldLooseBase(this,ge)[ge][l.hash];babelHelpers.classPrivateFieldLooseBase(this,me)[me][l.entityTypeId].delete(l.entityId);this.emit("OnItemDeleted",{item:l})}else{console.error("unknown event type",e)}}function _e(e,t){re(e);babelHelpers.classPrivateFieldLooseBase(this,ge)[ge][e.hash]=[];for(const s of t){ne(s);babelHelpers.classPrivateFieldLooseBase(this,ge)[ge][e.hash].push(s)}babelHelpers.classPrivateFieldLooseBase(this,we)[we](e)}function Ne(e){var t;re(e);const s=(t=babelHelpers.classPrivateFieldLooseBase(this,me)[me][e.entityTypeId])!=null?t:new Set;s.add(e.entityId);babelHelpers.classPrivateFieldLooseBase(this,me)[me][e.entityTypeId]=s}Object.defineProperty(Te,Pe,{writable:true,value:void 0});e.ConditionChecker=ie;e.ReceiverRepository=Te;e.Receiver=pe;e.Types=a})(this.BX.Crm.MessageSender=this.BX.Crm.MessageSender||{},BX.Crm,BX.UI.Dialogs,BX.Event,BX,BX.Crm.DataStructures);
//# sourceMappingURL=messagesender.bundle.map.js