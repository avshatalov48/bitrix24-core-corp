this.BX=this.BX||{},this.BX.Crm=this.BX.Crm||{},function(e,s,t,i){"use strict";const a=Object.freeze({telegram:"telegrambot",notifications:"notifications"}),r=Object.freeze({bitrix24:"bitrix24",sms:"sms_provider"}),l=Object.freeze({agreement:t.Loc.getMessage("CRM_MESSAGESENDER_B24_AGREEMENT_NOTIFY"),connectSuccess:t.Loc.getMessage("CRM_MESSAGESENDER_B24_CONNECT_SUCCESS"),connectAccessDenied:t.Loc.getMessage("CRM_MESSAGESENDER_B24_CONNECT_ACCESS_DENIED"),consentAgreementValidationError:t.Loc.getMessage("CRM_MESSAGESENDER_B24_CONSENT_AGREEMENT_VALIDATION_ERROR")});var o=babelHelpers.classPrivateFieldLooseKey("isOpenLineItemSelected"),n=babelHelpers.classPrivateFieldLooseKey("fetchOpenLineItems"),c=babelHelpers.classPrivateFieldLooseKey("getOpenLineItem"),d=babelHelpers.classPrivateFieldLooseKey("checkConsentApproved"),p=babelHelpers.classPrivateFieldLooseKey("getLineId"),b=babelHelpers.classPrivateFieldLooseKey("canEditConnector"),u=babelHelpers.classPrivateFieldLooseKey("showNotify"),v=babelHelpers.classPrivateFieldLooseKey("openConnectSidePanel"),h=babelHelpers.classPrivateFieldLooseKey("onConnect"),y=babelHelpers.classPrivateFieldLooseKey("showConnectAlertMessage");class L{static async checkAndGetLine({openLineCode:e,senderType:s,messages:i=null,openLineItems:a=null}){const r=new L({openLineCode:e,senderType:s,messages:i});return t.Type.isObjectLike(a)&&r.setOpenLineItems(a),r.check()}static async checkIsApproved({openLineCode:e,senderType:s}){return new L({openLineCode:e,senderType:s}).checkApproveConsent()}constructor({openLineCode:e,senderType:s,messages:i=null}){Object.defineProperty(this,y,{value:S}),Object.defineProperty(this,h,{value:T}),Object.defineProperty(this,v,{value:B}),Object.defineProperty(this,u,{value:g}),Object.defineProperty(this,b,{value:I}),Object.defineProperty(this,p,{value:F}),Object.defineProperty(this,d,{value:m}),Object.defineProperty(this,c,{value:E}),Object.defineProperty(this,n,{value:P}),Object.defineProperty(this,o,{value:f}),this.openLineItems=null,this.openLineCode=e,this.senderType=s,t.Type.isObjectLike(i)||(i={}),this.messages={...l,...i}}setOpenLineItems(e){return this.openLineItems=e,this}async check(){if(await babelHelpers.classPrivateFieldLooseBase(this,o)[o]()){if(await babelHelpers.classPrivateFieldLooseBase(this,d)[d]()){const e=await babelHelpers.classPrivateFieldLooseBase(this,p)[p]();return e?Promise.resolve(e):babelHelpers.classPrivateFieldLooseBase(this,v)[v]()}return babelHelpers.classPrivateFieldLooseBase(this,u)[u](this.messages.agreement),Promise.resolve(null)}return await babelHelpers.classPrivateFieldLooseBase(this,b)[b]()?babelHelpers.classPrivateFieldLooseBase(this,v)[v]():(babelHelpers.classPrivateFieldLooseBase(this,y)[y](),Promise.resolve(null))}async checkApproveConsent(){return await babelHelpers.classPrivateFieldLooseBase(this,d)[d]()?Promise.resolve(!0):Promise.resolve(null)}}async function f(){const e=await babelHelpers.classPrivateFieldLooseBase(this,c)[c]();if(!e)throw new Error(`OpenLine item with code: ${this.openLineCode} not found`);return e.selected}async function P(){return new Promise(((e,s)=>{t.ajax.runAction("crm.controller.integration.openlines.getItems").then((({status:t,data:i,errors:a})=>{"success"!==t?s(a):e(i)})).catch((e=>s(e)))}))}async function E(e=!1){return(null===this.openLineItems||e)&&(this.openLineItems=await babelHelpers.classPrivateFieldLooseBase(this,n)[n]()),this.openLineItems[this.openLineCode]}async function m(){return this.senderType!==r.bitrix24?Promise.resolve(!0):new Promise((e=>{t.ajax.runAction("notifications.consent.Agreement.get").then((({data:s})=>{s&&s.html?BX.UI.Dialogs.MessageBox.show({modal:!0,minWidth:980,title:s.title,message:s.html,buttons:[new BX.UI.Button({className:"ui-btn-round",color:BX.UI.Button.Color.SUCCESS,text:t.Loc.getMessage("CRM_MESSAGESENDER_B24_CONSENT_ACCEPT"),onclick:s=>{t.ajax.runAction("notifications.consent.Agreement.approve"),babelHelpers.classPrivateFieldLooseBase(this,u)[u](t.Loc.getMessage("CRM_MESSAGESENDER_B24_AGREEMENT_ACCEPT")),s.context.close(),e(!0)}}),new BX.UI.Button({className:"ui-btn-round",color:BX.UI.Button.Color.LIGHT_BORDER,text:t.Loc.getMessage("CRM_MESSAGESENDER_B24_CONSENT_REJECT"),onclick:s=>{s.context.close(),e(!1)}})],popupOptions:{className:"crm-agreement-terms-popup"}}):e(!0)})).catch((()=>{babelHelpers.classPrivateFieldLooseBase(this,u)[u](this.messages.consentAgreementValidationError),e(!1)}))}))}async function F(){return new Promise((e=>{const s={connectorId:this.openLineCode,withConnector:!0};t.ajax.runAction("imconnector.Openlines.list",{data:s}).then((({data:s})=>{if(s.length>0){const{lineId:t}=s[s.length-1];e(t)}else e(null)})).catch((()=>babelHelpers.classPrivateFieldLooseBase(this,u)[u](t.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR"))))}))}async function I(){return new Promise((e=>{t.ajax.runAction("imconnector.Openlines.hasAccess").then((({data:s})=>{s.canEditConnector?e(!0):e(!1)})).catch((()=>babelHelpers.classPrivateFieldLooseBase(this,y)[y]()))}))}function g(e){BX.UI.Notification.Center.notify({content:e})}async function B(){const e=await babelHelpers.classPrivateFieldLooseBase(this,c)[c]();return new Promise((s=>{t.Type.isStringFilled(e.url)?BX.SidePanel.Instance.open(e.url,{width:700,cacheable:!1,events:{onClose:()=>babelHelpers.classPrivateFieldLooseBase(this,h)[h](s)}}):(babelHelpers.classPrivateFieldLooseBase(this,u)[u](t.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR")),s(null))}))}async function T(e){const s=await babelHelpers.classPrivateFieldLooseBase(this,p)[p]();if(!s)return e(null),void babelHelpers.classPrivateFieldLooseBase(this,u)[u](this.messages.agreement);const t=await babelHelpers.classPrivateFieldLooseBase(this,c)[c](!0);babelHelpers.classPrivateFieldLooseBase(this,u)[u](this.messages.connectSuccess.replace("#LINE_NAME#",t.name));await babelHelpers.classPrivateFieldLooseBase(this,d)[d]()?e(s):(babelHelpers.classPrivateFieldLooseBase(this,u)[u](this.messages.agreement),e(null))}async function S(){const e=await babelHelpers.classPrivateFieldLooseBase(this,c)[c](),s=this.messages.connectAccessDenied.replace("#SERVICE_NAME#",e.name);BX.UI.Dialogs.MessageBox.alert(s)}function C(e){if(!(e instanceof i.ItemIdentifier))throw new Error("Argument should be an instance of ItemIdentifier")}function H(e){if(!(e instanceof _))throw new Error("Argument should be an instance of Receiver")}var O=babelHelpers.classPrivateFieldLooseKey("rootSource"),w=babelHelpers.classPrivateFieldLooseKey("addressSource"),A=babelHelpers.classPrivateFieldLooseKey("addressSourceData"),N=babelHelpers.classPrivateFieldLooseKey("address");class _{constructor(e,s,i,a=null){Object.defineProperty(this,O,{writable:!0,value:void 0}),Object.defineProperty(this,w,{writable:!0,value:void 0}),Object.defineProperty(this,A,{writable:!0,value:null}),Object.defineProperty(this,N,{writable:!0,value:void 0}),C(e),babelHelpers.classPrivateFieldLooseBase(this,O)[O]=e,C(s),babelHelpers.classPrivateFieldLooseBase(this,w)[w]=s,function(e){if(!(t.Type.isPlainObject(e)&&(t.Type.isNil(e.id)||t.Type.isInteger(e.id))&&t.Type.isStringFilled(e.typeId)&&t.Type.isStringFilled(e.valueType)&&t.Type.isStringFilled(e.value)))throw new Error("Argument should be an object of valid MultifieldValue structure")}(i),babelHelpers.classPrivateFieldLooseBase(this,N)[N]=Object.freeze({id:i.id,typeId:i.typeId,valueType:i.valueType,value:i.value,valueFormatted:i.valueFormatted}),a&&(!function(e){if(!(t.Type.isPlainObject(e)&&t.Type.isStringFilled(e.title)))throw new Error("Argument should be an object of valid SourceData structure")}(a),babelHelpers.classPrivateFieldLooseBase(this,A)[A]=Object.freeze({title:a.title}))}static fromJSON(e){const s=i.ItemIdentifier.fromJSON(null==e?void 0:e.rootSource);if(!s)return null;const t=i.ItemIdentifier.fromJSON(null==e?void 0:e.addressSource);if(!t)return null;try{return new _(s,t,null==e?void 0:e.address,null==e?void 0:e.addressSourceData)}catch(e){return null}}get rootSource(){return babelHelpers.classPrivateFieldLooseBase(this,O)[O]}get addressSource(){return babelHelpers.classPrivateFieldLooseBase(this,w)[w]}get addressSourceData(){return babelHelpers.classPrivateFieldLooseBase(this,A)[A]}get address(){return babelHelpers.classPrivateFieldLooseBase(this,N)[N]}isEqualTo(e){return e instanceof _&&(this.rootSource.isEqualTo(e.rootSource)&&this.addressSource.isEqualTo(e.addressSource)&&String(this.address.typeId)===String(e.address.typeId)&&String(this.address.valueType)===String(e.address.valueType)&&String(this.address.value)===String(e.address.value))}}function R(e,s){const a=[];return null!=s&&s.hasOwnProperty("MULTIFIELD_DATA")&&a.push(...function(e,s){const a=[],r=s.MULTIFIELD_DATA;for(const l in r)if(r.hasOwnProperty(l)&&t.Type.isPlainObject(r[l]))for(const o in r[l]){if(!r[l].hasOwnProperty(o)||!t.Type.isArrayFilled(r[l][o]))continue;const[n,c]=o.split("_");let d;try{d=new i.ItemIdentifier(t.Text.toInteger(n),t.Text.toInteger(c))}catch(e){continue}const p=M(e,d,s);for(const s of r[l][o])try{a.push(new _(e,d,{id:t.Text.toInteger(s.ID),typeId:String(l),valueType:D(s.VALUE_TYPE),value:D(s.VALUE),valueFormatted:D(s.VALUE_FORMATTED)},{title:p}))}catch(e){}}return a}(e,s)),null!=s&&s.hasOwnProperty("CLIENT_INFO")&&a.push(...function(e,s){const a=[];for(const l of Object.values(s))if(t.Type.isArrayFilled(l))for(const s of l){var r;if(!t.Type.isPlainObject(s))continue;let l;try{l=new i.ItemIdentifier(BX.CrmEntityType.resolveId(s.typeName),s.id)}catch(e){continue}const o=null==(r=s.advancedInfo)?void 0:r.multiFields;if(t.Type.isArrayFilled(o))for(const i of o)try{a.push(new _(e,l,{id:t.Text.toInteger(i.ID),typeId:D(i.TYPE_ID),valueType:D(i.VALUE_TYPE),value:D(i.VALUE),valueFormatted:D(i.VALUE_FORMATTED)},{title:D(s.title)}))}catch(e){}}return a}(e,s.CLIENT_INFO)),function(e){return e.filter(((s,t)=>e.findIndex((e=>s.isEqualTo(e)))===t))}(a)}function M(e,s,i){var a,r,l;if(e.isEqualTo(s))return null!=(r=null!=(l=null==i?void 0:i.TITLE)?l:i.FORMATTED_NAME)?r:"";const o=BX.CrmEntityType.resolveName(s.entityTypeId)+"_DATA";if(t.Type.isArrayFilled(null==i||null==(a=i.CLIENT_INFO)?void 0:a[o])){const e=i.CLIENT_INFO[o].find((e=>t.Text.toInteger(e.id)===s.entityId));if(t.Type.isString(null==e?void 0:e.title))return e.title}return""}function D(e){return t.Type.isNil(e)?void 0:String(e)}const j=new Set(["onCrmEntityCreate","onCrmEntityUpdate","onCrmEntityDelete"]);var K=babelHelpers.classPrivateFieldLooseKey("instance"),X=babelHelpers.classPrivateFieldLooseKey("onDetailsTabChangeEventHandler"),x=babelHelpers.classPrivateFieldLooseKey("storage"),U=babelHelpers.classPrivateFieldLooseKey("observedItems"),k=babelHelpers.classPrivateFieldLooseKey("init"),G=babelHelpers.classPrivateFieldLooseKey("destroy"),V=babelHelpers.classPrivateFieldLooseKey("onCrmEntityChange"),q=babelHelpers.classPrivateFieldLooseKey("addReceivers"),J=babelHelpers.classPrivateFieldLooseKey("startObservingItem");class z{static get Instance(){return window.top!==window&&t.Reflection.getClass("top.BX.Crm.MessageSender.ReceiverRepository")?window.top.BX.Crm.MessageSender.ReceiverRepository:(babelHelpers.classPrivateFieldLooseBase(z,K)[K]||(babelHelpers.classPrivateFieldLooseBase(z,K)[K]=new z),babelHelpers.classPrivateFieldLooseBase(z,K)[K])}constructor(){if(Object.defineProperty(this,J,{value:Z}),Object.defineProperty(this,q,{value:Q}),Object.defineProperty(this,V,{value:$}),Object.defineProperty(this,G,{value:W}),Object.defineProperty(this,k,{value:Y}),Object.defineProperty(this,X,{writable:!0,value:void 0}),Object.defineProperty(this,x,{writable:!0,value:{}}),Object.defineProperty(this,U,{writable:!0,value:{}}),babelHelpers.classPrivateFieldLooseBase(z,K)[K])throw new Error("Attempt to make a new instance of a singleton");babelHelpers.classPrivateFieldLooseBase(this,k)[k]()}static onDetailsLoad(e,s,a){let r;try{r=new i.ItemIdentifier(e,s)}catch(e){return}const l=z.Instance;babelHelpers.classPrivateFieldLooseBase(l,J)[J](r);const o=JSON.parse(a);if(t.Type.isArrayFilled(o)){const e=[];for(const s of o){const i=_.fromJSON(s);t.Type.isNil(i)||e.push(i)}t.Type.isArrayFilled(e)&&babelHelpers.classPrivateFieldLooseBase(l,q)[q](r,e)}}getReceivers(e,s){try{return this.getReceiversByIdentifier(new i.ItemIdentifier(e,s))}catch(e){return[]}}getReceiversByIdentifier(e){var s;return C(e),null!=(s=babelHelpers.classPrivateFieldLooseBase(this,x)[x][e.hash])?s:[]}}function Y(){var e,i;s.EventEmitter.makeObservable(this,"BX.Crm.MessageSender.ReceiverRepository"),babelHelpers.classPrivateFieldLooseBase(this,X)[X]=e=>{e instanceof s.BaseEvent?t.Type.isArrayFilled(e.getData())&&t.Type.isPlainObject(e.getData()[0])&&babelHelpers.classPrivateFieldLooseBase(this,V)[V](e.getType(),e.getData()[0]):console.error("unexpected event type",e)},babelHelpers.classPrivateFieldLooseBase(this,X)[X]=babelHelpers.classPrivateFieldLooseBase(this,X)[X].bind(this);for(const e of j)s.EventEmitter.subscribe(e,babelHelpers.classPrivateFieldLooseBase(this,X)[X]);null!=(e=BX.SidePanel)&&null!=(i=e.Instance)&&i.isOpen()&&s.EventEmitter.subscribe("SidePanel.Slider:onDestroy",babelHelpers.classPrivateFieldLooseBase(this,G)[G].bind(this))}function W(){for(const e of j)s.EventEmitter.unsubscribe(e,babelHelpers.classPrivateFieldLooseBase(this,X)[X]);babelHelpers.classPrivateFieldLooseBase(z,K)[K]=null}function $(e,{entityTypeId:s,entityId:a,entityData:r}){var l;if(null==(l=babelHelpers.classPrivateFieldLooseBase(this,U)[U][s])||!l.has(a))return;const o=new i.ItemIdentifier(s,a);if(e.toLowerCase()==="onCrmEntityCreate".toLowerCase()||e.toLowerCase()==="onCrmEntityUpdate".toLowerCase()){var n;const e=null!=(n=babelHelpers.classPrivateFieldLooseBase(this,x)[x][o.hash])?n:[],s=R(o,r);babelHelpers.classPrivateFieldLooseBase(this,x)[x][o.hash]=s;const i=s.filter((s=>t.Type.isNil(e.find((e=>e.isEqualTo(s)))))),a=e.filter((e=>t.Type.isNil(s.find((s=>s.isEqualTo(e))))));(i.length>0||a.length>0)&&this.emit("OnReceiversChanged",{item:o,previous:e,current:s,added:i,deleted:a})}else e.toLowerCase()==="onCrmEntityDelete".toLowerCase()?(delete babelHelpers.classPrivateFieldLooseBase(this,x)[x][o.hash],babelHelpers.classPrivateFieldLooseBase(this,U)[U][o.entityTypeId].delete(o.entityId),this.emit("OnItemDeleted",{item:o})):console.error("unknown event type",e)}function Q(e,s){C(e),babelHelpers.classPrivateFieldLooseBase(this,x)[x][e.hash]=[];for(const t of s)H(t),babelHelpers.classPrivateFieldLooseBase(this,x)[x][e.hash].push(t);babelHelpers.classPrivateFieldLooseBase(this,J)[J](e)}function Z(e){var s;C(e);const t=null!=(s=babelHelpers.classPrivateFieldLooseBase(this,U)[U][e.entityTypeId])?s:new Set;t.add(e.entityId),babelHelpers.classPrivateFieldLooseBase(this,U)[U][e.entityTypeId]=t}Object.defineProperty(z,K,{writable:!0,value:void 0}),e.ConditionChecker=L,e.OpenLineCodes=a,e.ReceiverRepository=z,e.Receiver=_,e.Types=r}(this.BX.Crm.MessageSender=this.BX.Crm.MessageSender||{},BX.Event,BX,BX.Crm.DataStructures);
//# sourceMappingURL=messagesender.bundle.map.js