this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,s,i,r,n){"use strict";const a=Object.freeze({bitrix24:"bitrix24",sms:"sms_provider"});var l=babelHelpers.classPrivateFieldLooseKey("senderType");var o=babelHelpers.classPrivateFieldLooseKey("showConsentAgreementBox");var c=babelHelpers.classPrivateFieldLooseKey("getButtons");var d=babelHelpers.classPrivateFieldLooseKey("approveConsent");var u=babelHelpers.classPrivateFieldLooseKey("closeAgreementBox");var p=babelHelpers.classPrivateFieldLooseKey("showErrorNotify");var b=babelHelpers.classPrivateFieldLooseKey("showNotify");class h{constructor(e=null){Object.defineProperty(this,b,{value:P});Object.defineProperty(this,p,{value:E});Object.defineProperty(this,u,{value:L});Object.defineProperty(this,d,{value:f});Object.defineProperty(this,c,{value:y});Object.defineProperty(this,o,{value:v});Object.defineProperty(this,l,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,l)[l]=e}async checkAndApprove(){return new Promise((e=>{r.ajax.runAction("notifications.consent.Agreement.get").then((({data:t})=>{if(!t||!t.html){e(true);return}babelHelpers.classPrivateFieldLooseBase(this,o)[o](t,e)})).catch((()=>{babelHelpers.classPrivateFieldLooseBase(this,p)[p]();e(false)}))}))}}function v({title:e,html:t},s){BX.UI.Dialogs.MessageBox.show({modal:true,minWidth:980,title:e,message:t,buttons:babelHelpers.classPrivateFieldLooseBase(this,c)[c](s),popupOptions:{className:"crm-agreement-terms-popup"}})}function y(e){return[new BX.UI.Button({className:"ui-btn-round",color:BX.UI.Button.Color.SUCCESS,text:r.Loc.getMessage("CRM_MESSAGESENDER_B24_CONSENT_ACCEPT"),onclick:t=>{babelHelpers.classPrivateFieldLooseBase(this,d)[d]().then((s=>{if(s){babelHelpers.classPrivateFieldLooseBase(this,b)[b](r.Loc.getMessage("CRM_MESSAGESENDER_B24_AGREEMENT_ACCEPT"))}babelHelpers.classPrivateFieldLooseBase(this,u)[u](t);e(true)})).catch((()=>{babelHelpers.classPrivateFieldLooseBase(this,p)[p]();e(false)}))}}),new BX.UI.Button({className:"ui-btn-round",color:BX.UI.Button.Color.LIGHT_BORDER,text:r.Loc.getMessage("CRM_MESSAGESENDER_B24_CONSENT_REJECT"),onclick:t=>{babelHelpers.classPrivateFieldLooseBase(this,u)[u](t);e(false)}})]}function f(){return new Promise((e=>{r.ajax.runAction("notifications.consent.Agreement.approve").then((t=>{if((t==null?void 0:t.status)==="success"&&t!=null&&t.data){e(true);return}e(false)})).catch((()=>{e(false)}))}))}function L({context:e}){e.close()}function E(){babelHelpers.classPrivateFieldLooseBase(this,b)[b](r.Loc.getMessage("CRM_MESSAGESENDER_B24_CONSENT_AGREEMENT_VALIDATION_ERROR"))}function P(e){BX.UI.Notification.Center.notify({content:e})}const I=e=>{BX.UI.Notification.Center.notify({content:e})};var g=babelHelpers.classPrivateFieldLooseKey("showConnectAlertMessage");class m{constructor(e){Object.defineProperty(this,g,{value:F});this.openLineItems=null;this.senderType=null;this.entityTypeId=null;if(r.Type.isPlainObject(e==null?void 0:e.openLineItems)){var t,s;this.openLineItems=(t=e.openLineItems)!=null?t:null;this.senderType=(s=e.senderType)!=null?s:null}if(r.Type.isNumber(e==null?void 0:e.entityTypeId)){this.entityTypeId=e.entityTypeId}}getOpenLineCode(){throw new Error("Must be implement in child class")}async checkAndGetLineId(){await babelHelpers.classPrivateFieldLooseBase(this,g)[g]();return Promise.resolve(null)}async isOpenLineItemSelected(e=false){const t=await this.getOpenLineItem(e);if(!t){throw new ReferenceError(`OpenLine item with code: ${this.getOpenLineCode()} not found`)}return t.selected}async getOpenLineItem(e=false,t=null){if(this.openLineItems===null||e){this.openLineItems=await this.fetchOpenLineItems()}return this.openLineItems[t!=null?t:this.getOpenLineCode()]}async fetchOpenLineItems(){return new Promise(((e,t)=>{r.ajax.runAction("crm.controller.integration.openlines.getItems").then((({status:s,data:i,errors:r})=>{if(s==="success"){e(i);return}t(r)})).catch((e=>{t(e)}))}))}async getLineId(){return new Promise((e=>{const t={connectorId:this.getOpenLineCode(),withConnector:true};r.ajax.runAction("imconnector.Openlines.list",{data:t}).then((({data:t})=>{if(r.Type.isArrayFilled(t)){const{lineId:s}=t[t.length-1];e(s);return}e(null)})).catch((()=>{I(r.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR"))}))}))}async canEditConnector(){return new Promise((e=>{r.ajax.runAction("imconnector.Openlines.hasAccess").then((({data:t})=>{if(t.canEditConnector){e(true);return}e(false)})).catch((()=>babelHelpers.classPrivateFieldLooseBase(this,g)[g]()))}))}async openConnectSidePanel(e,s){return new Promise((i=>{if(r.Type.isStringFilled(e)){void t.Router.openSlider(e,{width:700,cacheable:false}).then((()=>{s(i)}));return}I(r.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR"));i(null)}))}}async function F(){const e=await this.getOpenLineItem();const t=r.Loc.getMessage("CRM_MESSAGESENDER_B24_CONNECT_ACCESS_DENIED",{"#SERVICE_NAME#":e.name});I(t)}var B=babelHelpers.classPrivateFieldLooseKey("checkVirtualWhatsAppAvailable");var S=babelHelpers.classPrivateFieldLooseKey("fetchVirtualWhatsAppConfig");var T=babelHelpers.classPrivateFieldLooseKey("isVirtualWhatsAppConnected");class C extends m{constructor(...e){super(...e);Object.defineProperty(this,T,{value:H});Object.defineProperty(this,S,{value:O});Object.defineProperty(this,B,{value:w})}async checkAndGetLineId(){const e=await babelHelpers.classPrivateFieldLooseBase(this,B)[B]();if(!e){return null}const t=await this.isOpenLineItemSelected();if(t){if(await babelHelpers.classPrivateFieldLooseBase(this,T)[T]()){return this.getLineId()}const e=await this.canEditConnector();if(e){var s,i;const e=(s=this.openLineItems)==null?void 0:(i=s.virtual_whatsapp)==null?void 0:i.url;return this.openConnectSidePanel(e,this.onConnectVirtualWhatsApp.bind(this))}return super.checkAndGetLineId()}const r=await this.canEditConnector();if(r){const e=await this.getOpenLineItem();return this.openConnectSidePanel(e.url,this.onConnect.bind(this))}return super.checkAndGetLineId()}async onConnectVirtualWhatsApp(e){if(await babelHelpers.classPrivateFieldLooseBase(this,T)[T]()){return e(this.getLineId())}I(r.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR"));return e(null)}async onConnect(e){const t=await this.isOpenLineItemSelected(true);if(t){return e(this.checkAndGetLineId())}I(r.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR"));return e(null)}getOpenLineCode(){return"notifications"}}async function w(){const e=await babelHelpers.classPrivateFieldLooseBase(this,S)[S]();if(r.Type.isStringFilled(e.infoHelperCode)){if(r.Reflection.getClass("BX.UI.InfoHelper.show")){BX.UI.InfoHelper.show(e.infoHelperCode)}return false}return true}function O(){const{entityTypeId:e}=this;return new Promise(((t,s)=>{r.ajax.runAction("crm.controller.messagesender.conditionchecker.getVirtualWhatsAppConfig",{data:{entityTypeId:e}}).then((({status:e,data:i,errors:r})=>{if(e==="success"){t(i);return}s(r)})).catch((e=>s(e)))}))}async function H(){const e=await this.getOpenLineItem(true,"virtual_whatsapp");return e==null?void 0:e.selected}var A=babelHelpers.classPrivateFieldLooseKey("checkConsentApproved");class _ extends m{constructor(...e){super(...e);Object.defineProperty(this,A,{value:N})}async checkAndGetLineId(){const e=await this.isOpenLineItemSelected();if(e){const e=await babelHelpers.classPrivateFieldLooseBase(this,A)[A]();if(e){const e=await this.getLineId();if(!e){const e=await this.getOpenLineItem();return this.openConnectSidePanel(e.url,this.onConnect.bind(this))}return Promise.resolve(e)}I(r.Loc.getMessage("CRM_MESSAGESENDER_B24_AGREEMENT_NOTIFY"));return Promise.resolve(null)}const t=await this.canEditConnector();if(t){const e=await this.getOpenLineItem();return this.openConnectSidePanel(e.url,this.onConnect.bind(this))}return super.checkAndGetLineId()}async onConnect(e){const t=await this.getLineId();if(t===null){I(r.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR"));return e(null)}const s=await this.getOpenLineItem(true);I(r.Loc.getMessage("CRM_MESSAGESENDER_B24_CONNECT_SUCCESS",{"#LINE_NAME#":s.name}));const i=await babelHelpers.classPrivateFieldLooseBase(this,A)[A]();if(i){return e(t)}I(r.Loc.getMessage("CRM_MESSAGESENDER_B24_AGREEMENT_NOTIFY"));return e(null)}getOpenLineCode(){return"telegrambot"}}async function N(){return new h(this.senderType).checkAndApprove()}var R=babelHelpers.classPrivateFieldLooseKey("checkVirtualWhatsAppAvailable");var M=babelHelpers.classPrivateFieldLooseKey("fetchVirtualWhatsAppConfig");var D=babelHelpers.classPrivateFieldLooseKey("isVirtualWhatsAppConnected");var j=babelHelpers.classPrivateFieldLooseKey("hasAvailableSmsProvider");var K=babelHelpers.classPrivateFieldLooseKey("getSmsSenders");var k=babelHelpers.classPrivateFieldLooseKey("showMarketplaceDialog");var G=babelHelpers.classPrivateFieldLooseKey("openMarketplace");var x=babelHelpers.classPrivateFieldLooseKey("onCloseMarketplace");var X=babelHelpers.classPrivateFieldLooseKey("getSettings");class U extends m{constructor(...e){super(...e);Object.defineProperty(this,X,{value:Z});Object.defineProperty(this,x,{value:Q});Object.defineProperty(this,G,{value:$});Object.defineProperty(this,k,{value:z});Object.defineProperty(this,K,{value:Y});Object.defineProperty(this,j,{value:J});Object.defineProperty(this,D,{value:q});Object.defineProperty(this,M,{value:W});Object.defineProperty(this,R,{value:V})}async checkAndGetLineId(){const e=await babelHelpers.classPrivateFieldLooseBase(this,R)[R]();if(!e){return null}if(await babelHelpers.classPrivateFieldLooseBase(this,D)[D]()){const e=await babelHelpers.classPrivateFieldLooseBase(this,j)[j]();if(e){return Promise.resolve(0)}const t=await this.canEditConnector();if(t){return babelHelpers.classPrivateFieldLooseBase(this,k)[k]()}return super.checkAndGetLineId()}const t=await this.canEditConnector();if(t){var s,i;const e=(s=this.openLineItems)==null?void 0:(i=s.virtual_whatsapp)==null?void 0:i.url;return this.openConnectSidePanel(e,this.onConnectVirtualWhatsApp.bind(this))}return super.checkAndGetLineId()}async onConnectVirtualWhatsApp(e){if(await babelHelpers.classPrivateFieldLooseBase(this,D)[D]()){return e(this.checkAndGetLineId())}I(r.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR"));return e(null)}getOpenLineCode(){return"notifications"}}async function V(){const e=await babelHelpers.classPrivateFieldLooseBase(this,M)[M]();if(r.Type.isStringFilled(e.infoHelperCode)){if(r.Reflection.getClass("BX.UI.InfoHelper.show")){BX.UI.InfoHelper.show(e.infoHelperCode)}return false}return true}function W(){const{entityTypeId:e}=this;return new Promise(((t,s)=>{r.ajax.runAction("crm.controller.messagesender.conditionchecker.getVirtualWhatsAppConfig",{data:{entityTypeId:e}}).then((({status:e,data:i,errors:r})=>{if(e==="success"){t(i);return}s(r)})).catch((e=>s(e)))}))}async function q(){const e=await this.getOpenLineItem(true,"virtual_whatsapp");return e==null?void 0:e.selected}async function J(){const e=await babelHelpers.classPrivateFieldLooseBase(this,K)[K]();return Promise.resolve(e.some((e=>e.canUse&&!e.isTemplatesBased)))}async function Y(){const{entityTypeId:e}=this;return new Promise(((t,s)=>{r.ajax.runAction("crm.controller.messagesender.conditionchecker.getSmsSenders",{data:{entityTypeId:e}}).then((({status:e,data:i,errors:r})=>{if(e==="success"){t(i);return}s(r)})).catch((e=>s(e)))}))}function z(){return new Promise((e=>{s.MessageBox.show({message:r.Loc.getMessage("CRM_MESSAGESENDER_B24_CONDITION_CHECKER_MARKET_MESSAGE"),modal:true,buttons:s.MessageBoxButtons.OK_CANCEL,okCaption:r.Loc.getMessage("CRM_MESSAGESENDER_B24_CONDITION_CHECKER_OK_BTN_TEXT"),onOk:t=>{void babelHelpers.classPrivateFieldLooseBase(this,G)[G](e);t.close()}})}))}function $(e){const t=babelHelpers.classPrivateFieldLooseBase(this,X)[X]().marketUrl;BX.SidePanel.Instance.open(t,{cacheable:false,events:{onClose:()=>{void babelHelpers.classPrivateFieldLooseBase(this,x)[x](e)}}})}async function Q(e){const t=await babelHelpers.classPrivateFieldLooseBase(this,j)[j]();if(t){e(0);return}I(r.Loc.getMessage("CRM_MESSAGESENDER_B24_OPENLINE_LINEID_ERROR"));e(null)}function Z(){return r.Extension.getSettings("crm.messagesender")}class ee{static getScenarioInstance(e,t){if(e==="telegrambot"){return new _(t)}if(e==="ru-whatsapp"){return new C(t)}if(e==="whatsapp"){return new U(t)}throw new RangeError(`Unknown scenario name: ${e}`)}}var te=babelHelpers.classPrivateFieldLooseKey("openLineItems");var se=babelHelpers.classPrivateFieldLooseKey("senderType");var ie=babelHelpers.classPrivateFieldLooseKey("serviceId");var re=babelHelpers.classPrivateFieldLooseKey("entityTypeId");class ne{static async checkAndGetLine({senderType:e,openLineItems:t=null,serviceId:s=null,entityTypeId:i=null}){const n=new ne({senderType:e});if(r.Type.isObjectLike(t)){n.setOpenLineItems(t)}if(r.Type.isStringFilled(s)){n.setServiceId(s)}else{throw new TypeError("ServiceId is required")}if(BX.CrmEntityType.isDefined(i)){n.setEntityTypeId(i)}else{throw new TypeError("EntityTypeId is not specified or incorrect")}return n.check()}static async checkIsApproved({senderType:e}){const t=new ne({senderType:e});return t.checkApproveConsent()}constructor({senderType:e}){Object.defineProperty(this,te,{writable:true,value:null});Object.defineProperty(this,se,{writable:true,value:void 0});Object.defineProperty(this,ie,{writable:true,value:void 0});Object.defineProperty(this,re,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,se)[se]=e}setOpenLineItems(e){babelHelpers.classPrivateFieldLooseBase(this,te)[te]=e;return this}setServiceId(e){babelHelpers.classPrivateFieldLooseBase(this,ie)[ie]=e;return this}setEntityTypeId(e){babelHelpers.classPrivateFieldLooseBase(this,re)[re]=e;return this}async check(){const e=ee.getScenarioInstance(babelHelpers.classPrivateFieldLooseBase(this,ie)[ie],{senderType:babelHelpers.classPrivateFieldLooseBase(this,se)[se],openLineItems:babelHelpers.classPrivateFieldLooseBase(this,te)[te],entityTypeId:babelHelpers.classPrivateFieldLooseBase(this,re)[re]});return e.checkAndGetLineId()}async checkApproveConsent(){const e=await new h(babelHelpers.classPrivateFieldLooseBase(this,se)[se]).checkAndApprove();if(e){return Promise.resolve(true)}return Promise.resolve(null)}}function ae(e){if(e instanceof n.ItemIdentifier){return}throw new Error("Argument should be an instance of ItemIdentifier")}function le(e){if(e instanceof he){return}throw new Error("Argument should be an instance of Receiver")}function oe(e){const t=r.Type.isPlainObject(e)&&(r.Type.isNil(e.id)||r.Type.isInteger(e.id))&&r.Type.isStringFilled(e.typeId)&&r.Type.isStringFilled(e.valueType)&&r.Type.isStringFilled(e.value);if(t){return}throw new Error("Argument should be an object of valid MultifieldValue structure")}function ce(e){const t=r.Type.isPlainObject(e)&&r.Type.isStringFilled(e.title);if(t){return}throw new Error("Argument should be an object of valid SourceData structure")}var de=babelHelpers.classPrivateFieldLooseKey("rootSource");var ue=babelHelpers.classPrivateFieldLooseKey("addressSource");var pe=babelHelpers.classPrivateFieldLooseKey("addressSourceData");var be=babelHelpers.classPrivateFieldLooseKey("address");class he{constructor(e,t,s,i=null){Object.defineProperty(this,de,{writable:true,value:void 0});Object.defineProperty(this,ue,{writable:true,value:void 0});Object.defineProperty(this,pe,{writable:true,value:null});Object.defineProperty(this,be,{writable:true,value:void 0});ae(e);babelHelpers.classPrivateFieldLooseBase(this,de)[de]=e;ae(t);babelHelpers.classPrivateFieldLooseBase(this,ue)[ue]=t;oe(s);babelHelpers.classPrivateFieldLooseBase(this,be)[be]=Object.freeze({id:s.id,typeId:s.typeId,valueType:s.valueType,value:s.value,valueFormatted:s.valueFormatted});if(i){ce(i);babelHelpers.classPrivateFieldLooseBase(this,pe)[pe]=Object.freeze({title:i.title})}}static fromJSON(e){const t=n.ItemIdentifier.fromJSON(e==null?void 0:e.rootSource);if(!t){return null}const s=n.ItemIdentifier.fromJSON(e==null?void 0:e.addressSource);if(!s){return null}try{return new he(t,s,e==null?void 0:e.address,e==null?void 0:e.addressSourceData)}catch(e){return null}}get rootSource(){return babelHelpers.classPrivateFieldLooseBase(this,de)[de]}get addressSource(){return babelHelpers.classPrivateFieldLooseBase(this,ue)[ue]}get addressSourceData(){return babelHelpers.classPrivateFieldLooseBase(this,pe)[pe]}get address(){return babelHelpers.classPrivateFieldLooseBase(this,be)[be]}isEqualTo(e){if(!(e instanceof he)){return false}return this.rootSource.isEqualTo(e.rootSource)&&this.addressSource.isEqualTo(e.addressSource)&&String(this.address.typeId)===String(e.address.typeId)&&String(this.address.valueType)===String(e.address.valueType)&&String(this.address.value)===String(e.address.value)}}function ve(e,t){const s=[];if(t!=null&&t.hasOwnProperty("MULTIFIELD_DATA")){s.push(...ye(e,t))}if(t!=null&&t.hasOwnProperty("CLIENT_INFO")){s.push(...Le(e,t.CLIENT_INFO))}return Pe(s)}function ye(e,t){const s=[];const i=t.MULTIFIELD_DATA;for(const a in i){if(!i.hasOwnProperty(a)||!r.Type.isPlainObject(i[a])){continue}for(const l in i[a]){if(!i[a].hasOwnProperty(l)||!r.Type.isArrayFilled(i[a][l])){continue}const[o,c]=l.split("_");let d;try{d=new n.ItemIdentifier(r.Text.toInteger(o),r.Text.toInteger(c))}catch(e){continue}const u=fe(e,d,t);for(const t of i[a][l]){try{s.push(new he(e,d,{id:r.Text.toInteger(t.ID),typeId:String(a),valueType:Ee(t.VALUE_TYPE),value:Ee(t.VALUE),valueFormatted:Ee(t.VALUE_FORMATTED)},{title:u}))}catch(e){}}}}return s}function fe(e,t,s){var i;if(e.isEqualTo(t)){var n,a;return(n=(a=s==null?void 0:s.TITLE)!=null?a:s.FORMATTED_NAME)!=null?n:""}const l=`${BX.CrmEntityType.resolveName(t.entityTypeId)}_DATA`;if(r.Type.isArrayFilled(s==null?void 0:(i=s.CLIENT_INFO)==null?void 0:i[l])){const e=s.CLIENT_INFO[l].find((e=>r.Text.toInteger(e.id)===t.entityId));if(r.Type.isString(e==null?void 0:e.title)){return e.title}}return""}function Le(e,t){const s=[];for(const a of Object.values(t)){if(!r.Type.isArrayFilled(a)){continue}for(const t of a){var i;if(!r.Type.isPlainObject(t)){continue}let a;try{a=new n.ItemIdentifier(BX.CrmEntityType.resolveId(t.typeName),t.id)}catch(e){continue}const l=(i=t.advancedInfo)==null?void 0:i.multiFields;if(!r.Type.isArrayFilled(l)){continue}for(const i of l){try{s.push(new he(e,a,{id:r.Text.toInteger(i.ID),typeId:Ee(i.TYPE_ID),valueType:Ee(i.VALUE_TYPE),value:Ee(i.VALUE),valueFormatted:Ee(i.VALUE_FORMATTED)},{title:Ee(t.title)}))}catch(e){}}}}return s}function Ee(e){return r.Type.isNil(e)?undefined:String(e)}function Pe(e){return e.filter(((t,s)=>{const i=e.findIndex((e=>t.isEqualTo(e)));return i===s}))}const Ie=new Set(["onCrmEntityCreate","onCrmEntityUpdate","onCrmEntityDelete"]);var ge=babelHelpers.classPrivateFieldLooseKey("instance");var me=babelHelpers.classPrivateFieldLooseKey("onDetailsTabChangeEventHandler");var Fe=babelHelpers.classPrivateFieldLooseKey("storage");var Be=babelHelpers.classPrivateFieldLooseKey("observedItems");var Se=babelHelpers.classPrivateFieldLooseKey("init");var Te=babelHelpers.classPrivateFieldLooseKey("destroy");var Ce=babelHelpers.classPrivateFieldLooseKey("onCrmEntityChange");var we=babelHelpers.classPrivateFieldLooseKey("addReceivers");var Oe=babelHelpers.classPrivateFieldLooseKey("startObservingItem");class He{static get Instance(){if(!babelHelpers.classPrivateFieldLooseBase(He,ge)[ge]){babelHelpers.classPrivateFieldLooseBase(He,ge)[ge]=new He}return babelHelpers.classPrivateFieldLooseBase(He,ge)[ge]}constructor(){Object.defineProperty(this,Oe,{value:Me});Object.defineProperty(this,we,{value:Re});Object.defineProperty(this,Ce,{value:Ne});Object.defineProperty(this,Te,{value:_e});Object.defineProperty(this,Se,{value:Ae});Object.defineProperty(this,me,{writable:true,value:void 0});Object.defineProperty(this,Fe,{writable:true,value:{}});Object.defineProperty(this,Be,{writable:true,value:{}});if(babelHelpers.classPrivateFieldLooseBase(He,ge)[ge]){throw new Error("Attempt to make a new instance of a singleton")}babelHelpers.classPrivateFieldLooseBase(this,Se)[Se]()}static onDetailsLoad(e,t,s){let i=null;try{i=new n.ItemIdentifier(e,t)}catch{return}const a=He.Instance;babelHelpers.classPrivateFieldLooseBase(a,Oe)[Oe](i);const l=JSON.parse(s);if(r.Type.isArrayFilled(l)){const e=[];for(const t of l){const s=he.fromJSON(t);if(!r.Type.isNil(s)){e.push(s)}}if(r.Type.isArrayFilled(e)){babelHelpers.classPrivateFieldLooseBase(a,we)[we](i,e)}}}getReceivers(e,t){try{return this.getReceiversByIdentifier(new n.ItemIdentifier(e,t))}catch{return[]}}getReceiversByIdentifier(e){var t;ae(e);return(t=babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe][e.hash])!=null?t:[]}}function Ae(){var e,t;i.EventEmitter.makeObservable(this,"BX.Crm.MessageSender.ReceiverRepository");babelHelpers.classPrivateFieldLooseBase(this,me)[me]=e=>{if(!(e instanceof i.BaseEvent)){console.error("unexpected event type",e);return}if(!r.Type.isArrayFilled(e.getData())||!r.Type.isPlainObject(e.getData()[0])){return}babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce](e.getType(),e.getData()[0])};babelHelpers.classPrivateFieldLooseBase(this,me)[me]=babelHelpers.classPrivateFieldLooseBase(this,me)[me].bind(this);for(const e of Ie){i.EventEmitter.subscribe(e,babelHelpers.classPrivateFieldLooseBase(this,me)[me])}if((e=BX.SidePanel)!=null&&(t=e.Instance)!=null&&t.isOpen()){i.EventEmitter.subscribe("SidePanel.Slider:onDestroy",babelHelpers.classPrivateFieldLooseBase(this,Te)[Te].bind(this))}}function _e(){for(const e of Ie){i.EventEmitter.unsubscribe(e,babelHelpers.classPrivateFieldLooseBase(this,me)[me])}babelHelpers.classPrivateFieldLooseBase(He,ge)[ge]=null}function Ne(e,{entityTypeId:t,entityId:s,entityData:i}){var a;if(!((a=babelHelpers.classPrivateFieldLooseBase(this,Be)[Be][t])!=null&&a.has(s))){return}const l=new n.ItemIdentifier(t,s);if(e.toLowerCase()==="onCrmEntityCreate".toLowerCase()||e.toLowerCase()==="onCrmEntityUpdate".toLowerCase()){var o;const e=(o=babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe][l.hash])!=null?o:[];const t=ve(l,i);babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe][l.hash]=t;const s=t.filter((t=>r.Type.isNil(e.find((e=>e.isEqualTo(t))))));const n=e.filter((e=>r.Type.isNil(t.find((t=>t.isEqualTo(e))))));if(s.length>0||n.length>0){this.emit("OnReceiversChanged",{item:l,previous:e,current:t,added:s,deleted:n})}}else if(e.toLowerCase()==="onCrmEntityDelete".toLowerCase()){delete babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe][l.hash];babelHelpers.classPrivateFieldLooseBase(this,Be)[Be][l.entityTypeId].delete(l.entityId);this.emit("OnItemDeleted",{item:l})}else{console.error("unknown event type",e)}}function Re(e,t){ae(e);babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe][e.hash]=[];for(const s of t){le(s);babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe][e.hash].push(s)}babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe](e)}function Me(e){var t;ae(e);const s=(t=babelHelpers.classPrivateFieldLooseBase(this,Be)[Be][e.entityTypeId])!=null?t:new Set;s.add(e.entityId);babelHelpers.classPrivateFieldLooseBase(this,Be)[Be][e.entityTypeId]=s}Object.defineProperty(He,ge,{writable:true,value:void 0});e.ConditionChecker=ne;e.ReceiverRepository=He;e.Receiver=he;e.Types=a})(this.BX.Crm.MessageSender=this.BX.Crm.MessageSender||{},BX.Crm,BX.UI.Dialogs,BX.Event,BX,BX.Crm.DataStructures);
//# sourceMappingURL=messagesender.bundle.map.js