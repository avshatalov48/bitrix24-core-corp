this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,i,a,l,r,s,n,d,o,c,p,u){"use strict";var b,h,v,g,f,T,H,m,F,C,I,P,_;function A(e,t){M(e,t);t.add(e)}function G(e,t,i){M(e,t);t.set(e,i)}function M(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function R(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var N=[];var y=new WeakMap;var O=new WeakMap;var E=new WeakMap;var w=new WeakMap;var L=new WeakMap;var S=new WeakMap;var k=new WeakMap;var B=new WeakMap;var W=new WeakMap;var z=new WeakSet;var x=new WeakSet;var X=new WeakSet;var J=new WeakSet;var D=new WeakSet;var U=new WeakSet;var Y=new WeakSet;var j=new WeakSet;var K=new WeakSet;var V=new WeakSet;var q=new WeakSet;var Q=new WeakSet;var Z=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));A(babelHelpers.assertThisInitialized(i),Q);A(babelHelpers.assertThisInitialized(i),q);A(babelHelpers.assertThisInitialized(i),V);A(babelHelpers.assertThisInitialized(i),K);A(babelHelpers.assertThisInitialized(i),j);A(babelHelpers.assertThisInitialized(i),Y);A(babelHelpers.assertThisInitialized(i),U);A(babelHelpers.assertThisInitialized(i),D);A(babelHelpers.assertThisInitialized(i),J);A(babelHelpers.assertThisInitialized(i),X);A(babelHelpers.assertThisInitialized(i),x);A(babelHelpers.assertThisInitialized(i),z);G(babelHelpers.assertThisInitialized(i),y,{writable:true,value:void 0});G(babelHelpers.assertThisInitialized(i),O,{writable:true,value:void 0});G(babelHelpers.assertThisInitialized(i),E,{writable:true,value:void 0});G(babelHelpers.assertThisInitialized(i),w,{writable:true,value:void 0});G(babelHelpers.assertThisInitialized(i),L,{writable:true,value:void 0});G(babelHelpers.assertThisInitialized(i),S,{writable:true,value:null});G(babelHelpers.assertThisInitialized(i),k,{writable:true,value:null});G(babelHelpers.assertThisInitialized(i),B,{writable:true,value:null});G(babelHelpers.assertThisInitialized(i),W,{writable:true,value:void 0});i.type=e.type;i.form=e.form;i.fields=e.fields;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),W,(function(e){R(babelHelpers.assertThisInitialized(i),x,ee).call(babelHelpers.assertThisInitialized(i),e);e.reload=false}));i.dictionary=e.dictionary;BX.addCustomEvent(window,"seo-client-auth-result",babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),W));N.forEach((function(e){return e.destroy()}));N=[];N.push(babelHelpers.assertThisInitialized(i));return i}babelHelpers.createClass(t,[{key:"destroy",value:function e(){BX.removeCustomEvent(window,"seo-client-auth-result",babelHelpers.classPrivateFieldGet(this,W))}},{key:"getCase",value:function e(){var t=this;var i=this.form.integration.cases.filter((function(e){return e.providerCode===t.type}))[0]||null;if(!i){var a=(this.getProvider()||{}).profile||{};i={linkDirection:1,providerCode:this.type,date:null,account:{id:a.id||null,name:a.name||null},form:{id:null,name:null},fieldsMapping:[]};this.form.integration.cases.push(i)}return i}},{key:"getProvider",value:function e(){var t=this;return this.dictionary.integration.providers.filter((function(e){return e.type===t.type}))[0]||null}},{key:"getTypeTitle",value:function e(){return i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PROVIDER_"+this.type.toUpperCase())}},{key:"getAdForm",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(t===null){t=this.getCase().form.id+""}return(babelHelpers.classPrivateFieldGet(this,S)||[]).filter((function(e){return e.id===t}))[0]||null}},{key:"getAdAccount",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(t===null){t=this.getCase().account.id}return(babelHelpers.classPrivateFieldGet(this,B)||[]).filter((function(e){return e.id===t}))[0]||null}},{key:"getAdFormId",value:function e(){var t=this.getAdForm();if(t&&babelHelpers.classPrivateFieldGet(this,S).some((function(e){return e.id===t.id}))){return t.id}return null}},{key:"getAdAccountId",value:function e(){var t=this.getAdAccount();if(t&&babelHelpers.classPrivateFieldGet(this,B).some((function(e){return e.id===t.id}))){return t.id}return null}},{key:"render",value:function e(){var t=this;if(!babelHelpers.classPrivateFieldGet(this,y)){babelHelpers.classPrivateFieldSet(this,y,i.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(["<div></div>"]))))}babelHelpers.classPrivateFieldGet(this,y).innerHTML="";if(!this.dictionary.integration.canUse){return babelHelpers.classPrivateFieldGet(this,y)}var a=this.getCase();if(a&&a.linkDirection===0){babelHelpers.classPrivateFieldGet(this,y).appendChild(new s.Alert({color:s.Alert.Color.WARNING,text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_NEW_INTEGRATION",{"%providerName%":this.getTypeTitle()})}).render());babelHelpers.classPrivateFieldGet(this,y).appendChild(new n.Button({text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_NEW_INTEGRATION_BTN"),color:n.ButtonColor.PRIMARY,onclick:function e(){return R(t,z,$).call(t)}}).render());return babelHelpers.classPrivateFieldGet(this,y)}babelHelpers.classPrivateFieldGet(this,y).appendChild(R(this,Y,re).call(this));return babelHelpers.classPrivateFieldGet(this,y)}}]);return t}(a.EventEmitter);function $(){this.getCase().linkDirection=1;this.emit("change");this.render()}function ee(e){var t=this;if(!babelHelpers.classPrivateFieldGet(this,y)){return}o.ajax.runAction("crm.api.form.getDict",{json:{}}).then((function(e){return e.data})).then((function(i){t.dictionary.integration=i.integration;if(/.group/.test(e.engine||"")){R(t,K,ne).call(t)}else{R(t,Y,re).call(t)}}))}function te(){p.LoginFactory.getLoginObject({TYPE:this.type,ENGINE_CODE:this.getProvider().engineCode,AUTH_URL:this.getProvider().authUrl}).login()}function ie(){var e=this;o.ajax.runAction("crm.api.ads.leadads.service.logout",{data:{type:this.type}}).then((function(){babelHelpers.classPrivateFieldSet(e,B,null);e.getProvider().profile=null;R(e,Y,re).call(e)}))}function ae(){var e=BX.util.popup("",800,600);o.ajax.runAction("crm.api.ads.leadads.service.registerGroup",{data:{type:this.type,group:this.getAdAccountId()}}).then((function(t){e.location=t.data.authUrl}))}function le(){var e=this;var t=this.getProvider().group;if(!t.groupId){return Promise.resolve()}return o.ajax.runAction("crm.api.ads.leadads.service.logoutGroup",{data:{type:this.type,groupId:t.groupId}}).then((function(t){e.getProvider().group.hasAuth=false;R(e,K,ne).call(e)}))}function re(){var e=this;if(!babelHelpers.classPrivateFieldGet(this,O)){babelHelpers.classPrivateFieldSet(this,O,i.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(["<div></div>"]))))}babelHelpers.classPrivateFieldGet(this,O).innerHTML="";var t=this.getProvider();if(!t.profile){babelHelpers.classPrivateFieldGet(this,O).appendChild(new s.Alert({color:s.Alert.Color.PRIMARY,text:'\n\t\t\t\t\t<div class="ui-slider-heading-3">\n\t\t\t\t\t\t'.concat(i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_LOGIN_TITLE",{"%providerName%":this.getTypeTitle()}),'\n\t\t\t\t\t</div>\n\t\t\t\t\t<p class="ui-slider-paragraph-2">\n\t\t\t\t\t\t').concat(i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_LOGIN_DESC",{"%providerName%":this.getTypeTitle()}),"\n\t\t\t\t\t</p>\n\t\t\t\t")}).render());babelHelpers.classPrivateFieldGet(this,O).appendChild(new n.Button({text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_LOGIN_BTN"),color:n.ButtonColor.PRIMARY,onclick:function t(){return R(e,X,te).call(e)}}).render());return babelHelpers.classPrivateFieldGet(this,O)}babelHelpers.classPrivateFieldGet(this,O).appendChild(i.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div>\n\t\t\t\t<div class="crm-ads-conversion-block">\n\t\t\t\t\t<div class="crm-ads-conversion-social crm-ads-conversion-social-facebook">\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<div\n\t\t\t\t\t\t\t\tclass="crm-ads-conversion-social-avatar-icon"\n\t\t\t\t\t\t\t\tstyle="background-image: url(',')"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="crm-ads-conversion-social-user">\n\t\t\t\t\t\t\t<a\n\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\ttarget="_top"\n\t\t\t\t\t\t\t\tclass="crm-ads-conversion-social-user-link"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="crm-ads-conversion-social-shutoff">\n\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\tclass="crm-ads-conversion-social-shutoff-link"\n\t\t\t\t\t\t\t\tonclick="','"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),i.Tag.safe(g||(g=babelHelpers.taggedTemplateLiteral(["",""])),t.profile.picture),t.profile.url?'href="'+i.Tag.safe(f||(f=babelHelpers.taggedTemplateLiteral(["",""])),t.profile.url)+'"':"",i.Tag.safe(T||(T=babelHelpers.taggedTemplateLiteral(["",""])),t.profile.name),R(this,J,ie).bind(this),i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_LOGOUT_BTN")));babelHelpers.classPrivateFieldGet(this,O).appendChild(R(this,K,ne).call(this));return babelHelpers.classPrivateFieldGet(this,O)}function se(e){this.getCase().account.id=e||"";this.getCase().account.name=(this.getAdAccount(e)||{}).name;this.emit("change");babelHelpers.classPrivateFieldSet(this,S,null);R(this,K,ne).call(this)}function ne(){var e=this;if(!babelHelpers.classPrivateFieldGet(this,E)){babelHelpers.classPrivateFieldSet(this,E,i.Tag.render(H||(H=babelHelpers.taggedTemplateLiteral(["<div></div>"]))))}babelHelpers.classPrivateFieldGet(this,E).innerHTML="";if(!babelHelpers.classPrivateFieldGet(this,B)){babelHelpers.classPrivateFieldGet(this,E).appendChild(R(this,q,oe).call(this));o.ajax.runAction("crm.api.ads.leadads.account.getAccounts",{data:{type:this.type,proxyId:null}}).then((function(t){babelHelpers.classPrivateFieldSet(e,B,t.data.accounts.map((function(e){return{id:e.id+"",name:e.name+""}})));R(e,K,ne).call(e)}));return babelHelpers.classPrivateFieldGet(this,E)}if(babelHelpers.classPrivateFieldGet(this,B).length===0){babelHelpers.classPrivateFieldGet(this,E).appendChild(new s.Alert({color:s.Alert.Color.PRIMARY,text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PAGE_EMPTY",{"%providerName%":this.getTypeTitle()})}).render());return babelHelpers.classPrivateFieldGet(this,E)}var t=this.getAdAccountId();var a=new BX.Landing.UI.Field.Dropdown({selector:"page-list",title:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PAGE_"+this.type.toUpperCase()),content:t,items:[{name:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_NOT_SELECTED"),value:""}].concat(babelHelpers.toConsumableArray(babelHelpers.classPrivateFieldGet(this,B).map((function(e){return{value:e.id,name:e.name}}))))});a.subscribe("onChange",(function(){R(e,j,se).call(e,a.getValue())}));var l=i.Tag.render(m||(m=babelHelpers.taggedTemplateLiteral(['<div class="crm-form-integration-page-container"></div>'])));var r=i.Tag.render(F||(F=babelHelpers.taggedTemplateLiteral(['<div class="crm-form-integration-page-selector"></div>'])));r.appendChild(a.getNode());l.appendChild(r);babelHelpers.classPrivateFieldGet(this,E).appendChild(l);var d=this.getProvider().group;var c=d.isAuthUsed&&d.hasAuth&&d.groupId;if(c&&t&&t!==d.groupId){babelHelpers.classPrivateFieldGet(this,E).appendChild(new s.Alert({color:s.Alert.Color.WARNING,text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PAGE_VKONTAKTE_RESTRICTED",{"%groupName%":(this.getAdAccount(d.groupId)||{}).name})}).render());var p=new n.Button({text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PAGE_DISCONNECT_BTN"),color:n.ButtonColor.PRIMARY,className:"",onclick:function t(){p.setWaiting(true);R(e,U,le).call(e).then((function(){p.setWaiting(false)}))["catch"]((function(){p.setWaiting(false)}))}});babelHelpers.classPrivateFieldGet(this,E).appendChild(p.render());return babelHelpers.classPrivateFieldGet(this,E)}if(t&&d.isAuthUsed&&!d.hasAuth){var u=new n.Button({text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PAGE_CONNECT_BTN"),color:n.ButtonColor.PRIMARY,className:"",onclick:function t(){return R(e,D,ae).call(e)}});l.appendChild(u.render());babelHelpers.classPrivateFieldGet(this,E).appendChild(new s.Alert({color:s.Alert.Color.PRIMARY,text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PAGE_CONNECT_INFO")}).render());return babelHelpers.classPrivateFieldGet(this,E)}babelHelpers.classPrivateFieldGet(this,E).appendChild(R(this,V,de).call(this));return babelHelpers.classPrivateFieldGet(this,E)}function de(){var e=this;if(!babelHelpers.classPrivateFieldGet(this,w)){babelHelpers.classPrivateFieldSet(this,w,i.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(["<div></div>"]))))}babelHelpers.classPrivateFieldGet(this,w).innerHTML="";var t=this.getAdAccountId();if(!t){babelHelpers.classPrivateFieldGet(this,w).appendChild(new s.Alert({color:s.Alert.Color.PRIMARY,text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PAGE_CHOOSE")}).render());return babelHelpers.classPrivateFieldGet(this,w)}if(!babelHelpers.classPrivateFieldGet(this,S)){babelHelpers.classPrivateFieldGet(this,w).appendChild(R(this,q,oe).call(this));o.ajax.runAction("crm.api.ads.leadads.form.list",{data:{type:this.type,accountId:t,proxyId:null}}).then((function(t){babelHelpers.classPrivateFieldSet(e,S,t.data.forms.map((function(e){e.id+="";return e})));R(e,V,de).call(e)}))["catch"]((function(t){babelHelpers.classPrivateFieldSet(e,k,t.errors);babelHelpers.classPrivateFieldSet(e,S,[]);R(e,V,de).call(e)}));return babelHelpers.classPrivateFieldGet(this,w)}if(babelHelpers.classPrivateFieldGet(this,S).length===0){babelHelpers.classPrivateFieldGet(this,w).appendChild(new s.Alert({color:s.Alert.Color.PRIMARY,text:babelHelpers.classPrivateFieldGet(this,k).length>0?babelHelpers.classPrivateFieldGet(this,k)[0].message:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_FORM_EMPTY",{"%providerName%":this.getTypeTitle()})}).render());return babelHelpers.classPrivateFieldGet(this,w)}var a=new BX.Landing.UI.Field.Dropdown({selector:"form-list",title:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_FORM"),content:this.getAdFormId(),items:[{name:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_NOT_SELECTED"),value:""}].concat(babelHelpers.toConsumableArray(babelHelpers.classPrivateFieldGet(this,S).map((function(e){return{name:e.name,value:e.id}}))))});a.subscribe("onChange",(function(){var t=a.getValue();e.getCase().form.id=t;e.getCase().form.name=(e.getAdForm(t)||{}).name;e.getCase().fieldsMapping=[];e.emit("change");R(e,Q,ce).call(e)}));babelHelpers.classPrivateFieldGet(this,w).appendChild(a.getNode());babelHelpers.classPrivateFieldGet(this,w).appendChild(R(this,Q,ce).call(this));return babelHelpers.classPrivateFieldGet(this,w)}function oe(){var e=i.Tag.render(I||(I=babelHelpers.taggedTemplateLiteral(['<div style="position: relative; min-height: 100px;"></div>'])));(new c.Loader).show(e).then((function(){}));return e}function ce(){var e=this;if(!babelHelpers.classPrivateFieldGet(this,L)){babelHelpers.classPrivateFieldSet(this,L,i.Tag.render(P||(P=babelHelpers.taggedTemplateLiteral(["<div></div>"]))))}babelHelpers.classPrivateFieldGet(this,L).innerHTML="";if(!this.getAdForm()){babelHelpers.classPrivateFieldGet(this,L).appendChild(new s.Alert({color:s.Alert.Color.PRIMARY,text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_FORM_CHOOSE")}).render());return babelHelpers.classPrivateFieldGet(this,L)}var t=i.Tag.render(_||(_=babelHelpers.taggedTemplateLiteral(['<div style="margin-bottom: 40px"></div>'])));new s.Alert({color:s.Alert.Color.PRIMARY,text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_FIELD_MAP")}).renderTo(t);babelHelpers.classPrivateFieldGet(this,L).appendChild(t);var a=new r.Mapper({from:{caption:this.getTypeTitle()},fields:this.fields,map:this.getAdForm().fields.map((function(t){var i=e.getCase().fieldsMapping.filter((function(e){return e.adsFieldKey===t.key}))[0];i=(i||{}).crmFieldKey||"";if(!i){i=e.getProvider().defaultMapping.filter((function(e){return e.adsFieldType.toLowerCase()===(t.type||"").toLowerCase()}))[0];i=(i||{}).crmFieldType||""}return{inputType:(t.type||"").toLowerCase(),inputCode:t.key,inputName:t.label,outputCode:i,outputName:"",data:{items:t.options||[]}}}))});var l=function t(){var i=[];e.getCase().fieldsMapping=a.getMap().map((function(e){if(e.outputCode){i.push({name:e.outputCode})}return{crmFieldKey:e.outputCode,adsFieldKey:e.inputCode,items:e.data.items||[]}})).filter((function(e){return e.crmFieldKey}));e.emit("change",{fields:i})};l();a.subscribe("change",l);babelHelpers.classPrivateFieldGet(this,L).appendChild(a.render());return babelHelpers.classPrivateFieldGet(this,L)}e.Integration=Z})(this.BX.Crm.Form=this.BX.Crm.Form||{},BX,BX,BX.Event,BX.Crm.Form,BX.Crm.Form.Fields,BX.UI,BX.UI,BX,BX,BX,BX.Seo.Ads,BX.Seo.Ads);
//# sourceMappingURL=integration.bundle.map.js