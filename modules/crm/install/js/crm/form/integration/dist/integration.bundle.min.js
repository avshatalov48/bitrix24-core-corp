this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,i,a,l,r,s,n,o,d,c,p,u){"use strict";var h,b,v,g,f,T,m,H,_,F,P,I,C,A;function R(e,t){G(e,t);t.add(e)}function M(e,t,i){G(e,t);t.set(e,i)}function G(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function N(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var O=[];var E=new WeakMap;var y=new WeakMap;var L=new WeakMap;var w=new WeakMap;var S=new WeakMap;var k=new WeakMap;var B=new WeakMap;var x=new WeakMap;var z=new WeakMap;var W=new WeakSet;var J=new WeakSet;var X=new WeakSet;var U=new WeakSet;var D=new WeakSet;var Y=new WeakSet;var j=new WeakSet;var K=new WeakSet;var V=new WeakSet;var q=new WeakSet;var Q=new WeakSet;var Z=new WeakSet;var $=new WeakSet;var ee=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));R(babelHelpers.assertThisInitialized(i),$);R(babelHelpers.assertThisInitialized(i),Z);R(babelHelpers.assertThisInitialized(i),Q);R(babelHelpers.assertThisInitialized(i),q);R(babelHelpers.assertThisInitialized(i),V);R(babelHelpers.assertThisInitialized(i),K);R(babelHelpers.assertThisInitialized(i),j);R(babelHelpers.assertThisInitialized(i),Y);R(babelHelpers.assertThisInitialized(i),D);R(babelHelpers.assertThisInitialized(i),U);R(babelHelpers.assertThisInitialized(i),X);R(babelHelpers.assertThisInitialized(i),J);R(babelHelpers.assertThisInitialized(i),W);M(babelHelpers.assertThisInitialized(i),E,{writable:true,value:void 0});M(babelHelpers.assertThisInitialized(i),y,{writable:true,value:void 0});M(babelHelpers.assertThisInitialized(i),L,{writable:true,value:void 0});M(babelHelpers.assertThisInitialized(i),w,{writable:true,value:void 0});M(babelHelpers.assertThisInitialized(i),S,{writable:true,value:void 0});M(babelHelpers.assertThisInitialized(i),k,{writable:true,value:null});M(babelHelpers.assertThisInitialized(i),B,{writable:true,value:null});M(babelHelpers.assertThisInitialized(i),x,{writable:true,value:null});M(babelHelpers.assertThisInitialized(i),z,{writable:true,value:void 0});i.type=e.type;i.form=e.form;i.fields=e.fields;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),z,(function(e){N(babelHelpers.assertThisInitialized(i),J,ie).call(babelHelpers.assertThisInitialized(i),e);e.reload=false}));i.dictionary=e.dictionary;BX.addCustomEvent(window,"seo-client-auth-result",babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(i),z));O.forEach((function(e){return e.destroy()}));O=[];O.push(babelHelpers.assertThisInitialized(i));return i}babelHelpers.createClass(t,[{key:"destroy",value:function e(){BX.removeCustomEvent(window,"seo-client-auth-result",babelHelpers.classPrivateFieldGet(this,z))}},{key:"getCase",value:function e(){var t=this;var i=this.form.integration.cases.filter((function(e){return e.providerCode===t.type}))[0]||null;if(!i){var a=(this.getProvider()||{}).profile||{};i={linkDirection:1,providerCode:this.type,date:null,account:{id:a.id||null,name:a.name||null},form:{id:null,name:null},fieldsMapping:[]};this.form.integration.cases.push(i)}return i}},{key:"getProvider",value:function e(){var t=this;return this.dictionary.integration.providers.filter((function(e){return e.type===t.type}))[0]||null}},{key:"getTypeTitle",value:function e(){return i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PROVIDER_"+this.type.toUpperCase())}},{key:"getAdForm",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(t===null){t=this.getCase().form.id+""}return(babelHelpers.classPrivateFieldGet(this,k)||[]).filter((function(e){return e.id===t}))[0]||null}},{key:"getAdAccount",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(t===null){t=this.getCase().account.id}return(babelHelpers.classPrivateFieldGet(this,x)||[]).filter((function(e){return e.id===t}))[0]||null}},{key:"getAdFormId",value:function e(){var t=this.getAdForm();if(t&&babelHelpers.classPrivateFieldGet(this,k).some((function(e){return e.id===t.id}))){return t.id}return null}},{key:"getAdAccountId",value:function e(){var t=this.getAdAccount();if(t&&babelHelpers.classPrivateFieldGet(this,x).some((function(e){return e.id===t.id}))){return t.id}return null}},{key:"render",value:function e(){var t=this;if(!babelHelpers.classPrivateFieldGet(this,E)){babelHelpers.classPrivateFieldSet(this,E,i.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(["<div></div>"]))))}babelHelpers.classPrivateFieldGet(this,E).innerHTML="";if(!this.dictionary.integration.canUse){return babelHelpers.classPrivateFieldGet(this,E)}var a=this.getCase();if(a&&a.linkDirection===0){babelHelpers.classPrivateFieldGet(this,E).appendChild(new s.Alert({color:s.Alert.Color.WARNING,text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_NEW_INTEGRATION",{"%providerName%":this.getTypeTitle()})}).render());babelHelpers.classPrivateFieldGet(this,E).appendChild(new n.Button({text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_NEW_INTEGRATION_BTN"),color:n.ButtonColor.PRIMARY,onclick:function e(){return N(t,W,te).call(t)}}).render());return babelHelpers.classPrivateFieldGet(this,E)}babelHelpers.classPrivateFieldGet(this,E).appendChild(N(this,j,ne).call(this));return babelHelpers.classPrivateFieldGet(this,E)}},{key:"showBannerForOldProfile",value:function e(){var t=this;var a=u.MessageBox.create({message:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_ALERT_POPUP_MESSAGE"),title:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_ALERT_POPUP_TITLE"),minWidth:517,buttons:[new n.Button({text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_ALERT_POPUP_BTN_YES"),color:n.Button.Color.SUCCESS,onclick:function e(){return N(t,X,ae).call(t)}}),new n.Button({text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_ALERT_POPUP_BTN_OK"),color:n.Button.Color.LIGHT_BORDER,onclick:function e(){a.close()}})]});a.show()}},{key:"showAvatar",value:function e(t){if(t.profile.picture!==undefined){return i.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(['<div>\n\t\t\t\t<div\n\t\t\t\t\tclass="crm-ads-conversion-social-avatar-icon"\n\t\t\t\t\tstyle="background-image: url(',')"\n\t\t\t\t>\n\t\t\t\t</div>\n\t\t\t</div>'])),i.Tag.safe(v||(v=babelHelpers.taggedTemplateLiteral(["",""])),t.profile.picture))}}},{key:"handleLoginCompletionError",value:function e(t){}},{key:"createLogoutProfileButton",value:function e(){return new n.Button({text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_LOGOUT_BTN"),color:n.Button.Color.LIGHT_BORDER,round:true,size:n.Button.Size.EXTRA_SMALL,onclick:N(this,U,le).bind(this)})}}]);return t}(a.EventEmitter);function te(){this.getCase().linkDirection=1;this.emit("change");this.render()}function ie(e){var t=this;if(!babelHelpers.classPrivateFieldGet(this,E)){return}d.ajax.runAction("crm.api.form.getDict",{json:{}}).then((function(e){return e.data})).then((function(i){t.dictionary.integration=i.integration;if(/.group/.test(e.engine||"")){N(t,V,de).call(t)}else{N(t,j,ne).call(t)}}));d.ajax.runAction("crm.api.ads.leadads.account.loginCompletion",{data:{type:this.type}}).then((function(e){}),(function(e){t.handleLoginCompletionError(e)}))}function ae(){p.LoginFactory.getLoginObject({TYPE:this.type,ENGINE_CODE:this.getProvider().engineCode,AUTH_URL:this.getProvider().authUrl}).login()}function le(){var e=this;d.ajax.runAction("crm.api.ads.leadads.service.logout",{data:{type:this.type}}).then((function(){babelHelpers.classPrivateFieldSet(e,x,null);e.getProvider().profile=null;N(e,j,ne).call(e)}))}function re(){var e=BX.util.popup("",800,600);d.ajax.runAction("crm.api.ads.leadads.service.registerGroup",{data:{type:this.type,group:this.getAdAccountId()}}).then((function(t){e.location=t.data.authUrl}))}function se(){var e=this;var t=this.getProvider().group;if(!t.groupId){return Promise.resolve()}return d.ajax.runAction("crm.api.ads.leadads.service.logoutGroup",{data:{type:this.type,groupId:t.groupId}}).then((function(t){e.getProvider().group.hasAuth=false;N(e,V,de).call(e)}))}function ne(){var e=this;if(!babelHelpers.classPrivateFieldGet(this,y)){babelHelpers.classPrivateFieldSet(this,y,i.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(["<div></div>"]))))}babelHelpers.classPrivateFieldGet(this,y).innerHTML="";var t=this.getProvider();if(!t.profile){babelHelpers.classPrivateFieldGet(this,y).appendChild(new s.Alert({color:s.Alert.Color.PRIMARY,text:'\n\t\t\t\t\t<div class="ui-slider-heading-3">\n\t\t\t\t\t\t'.concat(i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_LOGIN_TITLE",{"%providerName%":this.getTypeTitle()}),'\n\t\t\t\t\t</div>\n\t\t\t\t\t<p class="ui-slider-paragraph-2">\n\t\t\t\t\t\t').concat(i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_LOGIN_DESC",{"%providerName%":this.getTypeTitle()}),"\n\t\t\t\t\t</p>\n\t\t\t\t")}).render());babelHelpers.classPrivateFieldGet(this,y).appendChild(new n.Button({text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_LOGIN_BTN"),color:n.ButtonColor.PRIMARY,onclick:function t(){return N(e,X,ae).call(e)}}).render());return babelHelpers.classPrivateFieldGet(this,y)}babelHelpers.classPrivateFieldGet(this,y).appendChild(i.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div>\n\t\t\t\t<div class="crm-ads-conversion-block">\n\t\t\t\t\t<div class="crm-ads-conversion-social crm-ads-conversion-social-facebook"  style="padding-bottom: 15px">\n\t\t\t\t\t\t','\n\t\t\t\t\t\t<div class="crm-ads-conversion-social-user">\n\t\t\t\t\t\t\t<a\n\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\ttarget="_top"\n\t\t\t\t\t\t\t\tclass="crm-ads-conversion-social-user-link"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="crm-ads-conversion-social-shutoff">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),this.showAvatar(t),t.profile.url?'href="'+i.Tag.safe(T||(T=babelHelpers.taggedTemplateLiteral(["",""])),t.profile.url)+'"':"",i.Tag.safe(m||(m=babelHelpers.taggedTemplateLiteral(["",""])),t.profile.name),this.createLogoutProfileButton().render()));if(this.type==="vkontakte"){babelHelpers.classPrivateFieldGet(this,y).appendChild(N(this,q,ce).call(this))}else{babelHelpers.classPrivateFieldGet(this,y).appendChild(N(this,V,de).call(this))}if(this.type==="vkontakte"){N(this,$,he).call(this)}return babelHelpers.classPrivateFieldGet(this,y)}function oe(e){this.getCase().account.id=e||"";this.getCase().account.name=(this.getAdAccount(e)||{}).name;this.emit("change");babelHelpers.classPrivateFieldSet(this,k,null);N(this,V,de).call(this)}function de(){var e=this;if(!babelHelpers.classPrivateFieldGet(this,L)){babelHelpers.classPrivateFieldSet(this,L,i.Tag.render(H||(H=babelHelpers.taggedTemplateLiteral(["<div></div>"]))))}babelHelpers.classPrivateFieldGet(this,L).innerHTML="";if(!babelHelpers.classPrivateFieldGet(this,x)){babelHelpers.classPrivateFieldGet(this,L).appendChild(N(this,Q,pe).call(this));d.ajax.runAction("crm.api.ads.leadads.account.getAccounts",{data:{type:this.type,proxyId:null}}).then((function(t){babelHelpers.classPrivateFieldSet(e,x,t.data.accounts.map((function(e){return{id:e.id+"",name:e.name+""}})));N(e,V,de).call(e)}));return babelHelpers.classPrivateFieldGet(this,L)}if(babelHelpers.classPrivateFieldGet(this,x).length===0){babelHelpers.classPrivateFieldGet(this,L).appendChild(new s.Alert({color:s.Alert.Color.PRIMARY,text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PAGE_EMPTY",{"%providerName%":this.getTypeTitle()})}).render());return babelHelpers.classPrivateFieldGet(this,L)}var t=this.getAdAccountId();var a=new BX.Landing.UI.Field.Dropdown({selector:"page-list",title:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PAGE_"+this.type.toUpperCase()),content:t,items:[{name:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_NOT_SELECTED"),value:""}].concat(babelHelpers.toConsumableArray(babelHelpers.classPrivateFieldGet(this,x).map((function(e){return{value:e.id,name:e.name}}))))});a.subscribe("onChange",(function(){N(e,K,oe).call(e,a.getValue())}));var l=i.Tag.render(_||(_=babelHelpers.taggedTemplateLiteral(['<div class="crm-form-integration-page-container"></div>'])));var r=i.Tag.render(F||(F=babelHelpers.taggedTemplateLiteral(['<div class="crm-form-integration-page-selector"></div>'])));r.appendChild(a.getNode());l.appendChild(r);babelHelpers.classPrivateFieldGet(this,L).appendChild(l);var o=this.getProvider().group;var c=o.isAuthUsed&&o.hasAuth&&o.groupId;if(c&&t&&t!==o.groupId){babelHelpers.classPrivateFieldGet(this,L).appendChild(new s.Alert({color:s.Alert.Color.WARNING,text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PAGE_VKONTAKTE_RESTRICTED",{"%groupName%":(this.getAdAccount(o.groupId)||{}).name})}).render());var p=new n.Button({text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PAGE_DISCONNECT_BTN"),color:n.ButtonColor.PRIMARY,className:"",onclick:function t(){p.setWaiting(true);N(e,Y,se).call(e).then((function(){p.setWaiting(false)}))["catch"]((function(){p.setWaiting(false)}))}});babelHelpers.classPrivateFieldGet(this,L).appendChild(p.render());return babelHelpers.classPrivateFieldGet(this,L)}if(t&&o.isAuthUsed&&!o.hasAuth){var u=new n.Button({text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PAGE_CONNECT_BTN"),color:n.ButtonColor.PRIMARY,className:"",onclick:function t(){return N(e,D,re).call(e)}});l.appendChild(u.render());babelHelpers.classPrivateFieldGet(this,L).appendChild(new s.Alert({color:s.Alert.Color.PRIMARY,text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PAGE_CONNECT_INFO")}).render());return babelHelpers.classPrivateFieldGet(this,L)}babelHelpers.classPrivateFieldGet(this,L).appendChild(N(this,q,ce).call(this));return babelHelpers.classPrivateFieldGet(this,L)}function ce(){var e=this;if(!babelHelpers.classPrivateFieldGet(this,w)){babelHelpers.classPrivateFieldSet(this,w,i.Tag.render(P||(P=babelHelpers.taggedTemplateLiteral(["<div></div>"]))))}babelHelpers.classPrivateFieldGet(this,w).innerHTML="";if(this.getProvider().hasPages){var t=this.getAdAccountId();if(!t){babelHelpers.classPrivateFieldGet(this,w).appendChild(new s.Alert({color:s.Alert.Color.PRIMARY,text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_PAGE_CHOOSE")}).render());return babelHelpers.classPrivateFieldGet(this,w)}}if(!babelHelpers.classPrivateFieldGet(this,k)){babelHelpers.classPrivateFieldGet(this,w).appendChild(N(this,Q,pe).call(this));d.ajax.runAction("crm.api.ads.leadads.form.list",{data:{type:this.type,accountId:this.getAdAccountId()||0,proxyId:null}}).then((function(t){babelHelpers.classPrivateFieldSet(e,k,t.data.forms.map((function(e){e.id+="";return e})));N(e,q,ce).call(e)}))["catch"]((function(t){babelHelpers.classPrivateFieldSet(e,B,t.errors);babelHelpers.classPrivateFieldSet(e,k,[]);N(e,q,ce).call(e)}));return babelHelpers.classPrivateFieldGet(this,w)}if(babelHelpers.classPrivateFieldGet(this,k).length===0){babelHelpers.classPrivateFieldGet(this,w).appendChild(new s.Alert({color:s.Alert.Color.PRIMARY,text:babelHelpers.classPrivateFieldGet(this,B).length>0?babelHelpers.classPrivateFieldGet(this,B)[0].message:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_FORM_EMPTY",{"%providerName%":this.getTypeTitle()})}).render());return babelHelpers.classPrivateFieldGet(this,w)}var a=new BX.Landing.UI.Field.Dropdown({selector:"form-list",title:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_FORM"),content:this.getAdFormId(),items:[{name:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_NOT_SELECTED"),value:""}].concat(babelHelpers.toConsumableArray(babelHelpers.classPrivateFieldGet(this,k).map((function(e){return{name:e.name,value:e.id}}))))});a.subscribe("onChange",(function(){var t=a.getValue();e.getCase().form.id=t;e.getCase().form.name=(e.getAdForm(t)||{}).name;e.getCase().fieldsMapping=[];e.emit("change");N(e,Z,ue).call(e)}));babelHelpers.classPrivateFieldGet(this,w).appendChild(a.getNode());babelHelpers.classPrivateFieldGet(this,w).appendChild(N(this,Z,ue).call(this));return babelHelpers.classPrivateFieldGet(this,w)}function pe(){var e=i.Tag.render(I||(I=babelHelpers.taggedTemplateLiteral(['<div style="position: relative; min-height: 100px;"></div>'])));(new c.Loader).show(e).then((function(){}));return e}function ue(){var e,t=this;if(!babelHelpers.classPrivateFieldGet(this,S)){babelHelpers.classPrivateFieldSet(this,S,i.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(["<div></div>"]))))}babelHelpers.classPrivateFieldGet(this,S).innerHTML="";if(!this.getAdForm()){babelHelpers.classPrivateFieldGet(this,S).appendChild(new s.Alert({color:s.Alert.Color.PRIMARY,text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_FORM_CHOOSE")}).render());return babelHelpers.classPrivateFieldGet(this,S)}var a=i.Tag.render(A||(A=babelHelpers.taggedTemplateLiteral(['<div style="margin-bottom: 29px"></div>'])));new s.Alert({color:s.Alert.Color.PRIMARY,text:i.Loc.getMessage("CRM_FORM_INTEGRATION_JS_FIELD_MAP")}).renderTo(a);babelHelpers.classPrivateFieldGet(this,S).appendChild(a);if(((e=this.getAdForm())===null||e===void 0?void 0:e.fields)===undefined){babelHelpers.classPrivateFieldGet(this,S).appendChild(N(this,Q,pe).call(this));d.ajax.runAction("crm.api.ads.leadads.form.get",{data:{type:this.type,accountId:this.getAdAccountId()||0,proxyId:null,formId:this.getAdForm().id}}).then((function(e){t.getAdForm().fields=e.data.form.fields;N(t,Z,ue).call(t)}))["catch"]((function(e){babelHelpers.classPrivateFieldSet(t,B,e.errors);N(t,Z,ue).call(t)}));return babelHelpers.classPrivateFieldGet(this,S)}var l=new r.Mapper({from:{caption:this.getTypeTitle()},fields:this.fields,map:this.getAdForm().fields.map((function(e){var i=t.getCase().fieldsMapping.filter((function(t){return t.adsFieldKey===e.key}))[0];i=(i||{}).crmFieldKey||"";if(!i){i=t.getProvider().defaultMapping.filter((function(t){return t.adsFieldType.toLowerCase()===(e.type||"").toLowerCase()}))[0];i=(i||{}).crmFieldType||""}return{inputType:(e.type||"").toLowerCase(),inputCode:e.key,inputName:e.label,outputCode:i,outputName:"",data:{items:e.options||[]}}}))});var n=function e(){var i=[];t.getCase().fieldsMapping=l.getMap().map((function(e){if(e.outputCode){i.push({name:e.outputCode})}return{crmFieldKey:e.outputCode,adsFieldKey:e.inputCode,items:e.data.items||[]}})).filter((function(e){return e.crmFieldKey}));t.emit("change",{fields:i})};n();l.subscribe("change",n);babelHelpers.classPrivateFieldGet(this,S).appendChild(l.render());return babelHelpers.classPrivateFieldGet(this,S)}function he(){var e=this;d.ajax.runAction("crm.api.ads.leadads.service.checkProfile",{data:{type:this.type}}).then((function(e){}),(function(t){N(e,U,le).call(e);e.showBannerForOldProfile()}))}e.Integration=ee})(this.BX.Crm.Form=this.BX.Crm.Form||{},BX,BX,BX.Event,BX.Crm.Form,BX.Crm.Form.Fields,BX.UI,BX.UI,BX,BX,BX,BX.Seo.Ads,BX.UI.Dialogs);
//# sourceMappingURL=integration.bundle.map.js