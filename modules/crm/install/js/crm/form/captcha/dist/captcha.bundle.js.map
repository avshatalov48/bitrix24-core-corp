{"version":3,"file":"captcha.bundle.js","sources":["../src/captcha.js"],"sourcesContent":["import {Tag, Type, Loc, ajax} from 'main.core';\nimport {Layout} from \"ui.sidepanel.layout\";\nimport \"ui.notification\";\n\nexport class Captcha\n{\n\tstatic open(): Promise\n\t{\n\t\tlet resolver;\n\t\tconst promise = new Promise(resolve => {\n\t\t\tresolver = resolve;\n\t\t});\n\n\t\tconst instance = new Captcha;\n\t\tBX.SidePanel.Instance.open(\"crm.webform:captcha\", {\n\t\t\twidth: 700,\n\t\t\tcacheable: false,\n\t\t\tevents: {\n\t\t\t\tonCloseComplete: () => {\n\t\t\t\t\tresolver({...instance.getValue()});\n\t\t\t\t},\n\t\t\t},\n\t\t\tcontentCallback: () => {\n\t\t\t\treturn Layout.createContent({\n\t\t\t\t\textensions: ['crm.form.captcha', 'ui.forms', 'ui.sidepanel-content'],\n\t\t\t\t\ttitle: Loc.getMessage('CRM_FORM_CAPTCHA_JS_TITLE'),\n\t\t\t\t\tdesign: {\n\t\t\t\t\t\tsection: false,\n\t\t\t\t\t},\n\t\t\t\t\tcontent ()\n\t\t\t\t\t{\n\t\t\t\t\t\treturn instance.load();\n\t\t\t\t\t},\n\t\t\t\t\tbuttons ({SaveButton, closeButton})\n\t\t\t\t\t{\n\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\tnew SaveButton({\n\t\t\t\t\t\t\t\tonclick: btn => {\n\n\t\t\t\t\t\t\t\t\tif (!instance.canChange())\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tbtn.setDisabled(true);\n\t\t\t\t\t\t\t\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\t\t\t\t\t\t\t\tcontent: Loc.getMessage('CRM_FORM_CAPTCHA_JS_ACCESS_DENIED'),\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tbtn.setWaiting(true);\n\t\t\t\t\t\t\t\t\tinstance.save()\n\t\t\t\t\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\t\t\t\t\tbtn.setWaiting(false);\n\t\t\t\t\t\t\t\t\t\t\tBX.SidePanel.Instance.close();\n\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t\t.catch(() => {\n\t\t\t\t\t\t\t\t\t\t\tbtn.setWaiting(false);\n\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\tcloseButton\n\t\t\t\t\t\t];\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t},\n\t\t});\n\n\t\treturn promise;\n\t}\n\n\t#data: Object = {\n\t\tkey: null,\n\t\tsecret: null,\n\t\tcanChange: false,\n\t\thasDefaults: false,\n\t};\n\t#container: HTMLElement;\n\n\t#render(): HTMLElement\n\t{\n\t\tconst key = Tag.safe`${this.#data.key}`;\n\t\tconst secret = Tag.safe`${this.#data.secret}`;\n\t\tthis.#container = Tag.render`\t\t\t\t\n\t\t\t<div>\n\t\t\t\t<div class=\"ui-slider-section\" ${this.#data.hasDefaults ? '' : 'hidden'}>\n\t\t\t\t\t<div class=\"ui-slider-content-box\">\n\t\t\t\t\t\t<div class=\"ui-slider-heading-4\">${Loc.getMessage('CRM_FORM_CAPTCHA_JS_STD_TITLE')}</div>\n\t\t\t\t\t\t<div class=\"ui-alert ui-alert-success\">\n\t\t\t\t\t\t\t<span class=\"ui-alert-message\">${Loc.getMessage('CRM_FORM_CAPTCHA_JS_STD_TEXT')}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t\n\t\t\t\t<div class=\"ui-slider-section\">\n\t\t\t\t\t<div class=\"ui-slider-content-box\">\n\t\t\t\t\t\t<div class=\"ui-slider-heading-4\">${Loc.getMessage('CRM_FORM_CAPTCHA_JS_CUSTOM_TITLE')}</div>\n\t\t\t\t\t\t<p class=\"ui-slider-paragraph-2\">\n\t\t\t\t\t\t\t${Loc.getMessage('CRM_FORM_CAPTCHA_JS_CUSTOM_TEXT')}\n\t\t\t\t\t\t\t<br>\n\t\t\t\t\t\t\t<a href=\"https://www.google.com/recaptcha/about/\" target=\"_blank\">${Loc.getMessage('CRM_FORM_CAPTCHA_JS_CUSTOM_HOWTO')}</a>\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t\t\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<div class=\"ui-form-row\">\n\t\t\t\t\t\t\t<div class=\"ui-form-label\">\n\t\t\t\t\t\t\t\t<div class=\"ui-ctl-label-text\">Key</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class=\"ui-form-content\">\n\t\t\t\t\t\t\t\t<div class=\"ui-ctl ui-ctl-textbox ui-ctl-w100\">\n\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\ttype=\"text\" \n\t\t\t\t\t\t\t\t\t\tname=\"key\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"${key}\"\n\t\t\t\t\t\t\t\t\t\tclass=\"ui-ctl-element\"\n\t\t\t\t\t\t\t\t\t\tonfocus=\"this.parentElement.classList.remove('ui-ctl-danger')\"\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class=\"ui-form-row\" style=\"margin: 20px 0 0;\">\n\t\t\t\t\t\t\t<div class=\"ui-form-label\">\n\t\t\t\t\t\t\t\t<div class=\"ui-ctl-label-text\">Secret</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class=\"ui-form-content\">\n\t\t\t\t\t\t\t\t<div class=\"ui-ctl ui-ctl-textbox ui-ctl-w100\">\n\t\t\t\t\t\t\t\t\t<input \n\t\t\t\t\t\t\t\t\t\ttype=\"text\" \n\t\t\t\t\t\t\t\t\t\tname=\"secret\"\n\t\t\t\t\t\t\t\t\t\tvalue=\"${secret}\"\n\t\t\t\t\t\t\t\t\t\tclass=\"ui-ctl-element\"\n\t\t\t\t\t\t\t\t\t\tonfocus=\"this.parentElement.classList.remove('ui-ctl-danger')\"\n\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t\treturn this.#container;\n\t}\n\n\thasKeys(): boolean\n\t{\n\t\tconst data = this.#data;\n\t\treturn data.hasDefaults || (data.key && data.secret);\n\t}\n\n\tcanChange(): boolean\n\t{\n\t\treturn this.#data.canChange;\n\t}\n\n\tload(): Promise\n\t{\n\t\treturn ajax.runAction('crm.form.getCaptcha', {json: {}}).then(response => {\n\t\t\tthis.#data = response.data;\n\t\t\treturn this.#render();\n\t\t});\n\t}\n\n\tsave(): Promise\n\t{\n\t\tconst keyNode = this.#container.querySelector('input[name=\"key\"]');\n\t\tconst secretNode = this.#container.querySelector('input[name=\"secret\"]');\n\n\t\tconst key = keyNode.value || '';\n\t\tconst secret = secretNode.value || '';\n\n\t\tkeyNode.parentElement.classList.remove('ui-ctl-danger');\n\t\tsecretNode.parentElement.classList.remove('ui-ctl-danger');\n\t\tif (Type.isStringFilled(key) !== Type.isStringFilled(secret))\n\t\t{\n\t\t\tif (!key)\n\t\t\t{\n\t\t\t\tkeyNode.parentElement.classList.add('ui-ctl-danger');\n\t\t\t}\n\n\t\t\tif (!secret)\n\t\t\t{\n\t\t\t\tsecretNode.parentElement.classList.add('ui-ctl-danger');\n\t\t\t}\n\n\t\t\treturn Promise.reject();\n\t\t}\n\n\t\treturn ajax\n\t\t\t.runAction('crm.form.setCaptcha', {json: {key, secret}})\n\t\t\t.then(response => {\n\t\t\t\tthis.#data = response.data;\n\t\t\t\treturn this.#data;\n\t\t\t})\n\t\t;\n\t}\n\n\tgetValue(): {[key: string]: any}\n\t{\n\t\treturn this.#data;\n\t}\n}"],"names":["Captcha","key","secret","canChange","hasDefaults","data","ajax","runAction","json","then","response","keyNode","querySelector","secretNode","value","parentElement","classList","remove","Type","isStringFilled","add","Promise","reject","resolver","promise","resolve","instance","BX","SidePanel","Instance","open","width","cacheable","events","onCloseComplete","getValue","contentCallback","Layout","createContent","extensions","title","Loc","getMessage","design","section","content","load","buttons","SaveButton","closeButton","onclick","btn","setDisabled","UI","Notification","Center","notify","setWaiting","save","close","Tag","safe","render"],"mappings":"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"}