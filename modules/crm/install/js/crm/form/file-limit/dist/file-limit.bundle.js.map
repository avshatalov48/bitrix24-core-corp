{"version":3,"file":"file-limit.bundle.js","sources":["../src/file-limit.js"],"sourcesContent":["import {Tag, Type, Loc, ajax} from 'main.core';\nimport {Layout} from \"ui.sidepanel.layout\";\nimport {EventEmitter} from \"main.core.events\";\nimport \"ui.notification\";\n\nexport class FileLimit extends EventEmitter\n{\n\tstatic #instance: FileLimit | null = null;\n\n\t#data: Object = {\n\t\tlimitMb: undefined,\n\t\tcurrentBytes: null,\n\t\tcanChange: null,\n\t};\n\n\t#ui: Object = {\n\t\tcontainer: HTMLElement = null,\n\t\tlimit: {\n\t\t\tblock: HTMLElement = null,\n\t\t\tinput: HTMLInputElement = null,\n\t\t},\n\t\tpercentage: {\n\t\t\tblock: HTMLElement = null,\n\t\t}\n\t};\n\n\tstatic instance(): FileLimit\n\t{\n\t\tif (!FileLimit.#instance)\n\t\t{\n\t\t\tFileLimit.#instance = new FileLimit();\n\t\t}\n\n\t\treturn FileLimit.#instance;\n\t}\n\n\topen(): Promise\n\t{\n\t\tlet resolver;\n\t\tconst promise = new Promise(resolve => {\n\t\t\tresolver = resolve;\n\t\t});\n\n\t\tconst instance = FileLimit.instance();\n\t\tBX.SidePanel.Instance.open(\"crm.webform:file-limit\", {\n\t\t\twidth: 700,\n\t\t\tcacheable: false,\n\t\t\tevents: {\n\t\t\t\tonCloseComplete: () => {\n\t\t\t\t\tresolver({...instance.getValue()});\n\t\t\t\t},\n\t\t\t},\n\t\t\tcontentCallback: () => {\n\t\t\t\treturn Layout.createContent({\n\t\t\t\t\textensions: ['crm.form.file-limit', 'ui.forms', 'ui.sidepanel-content'],\n\t\t\t\t\ttitle: Loc.getMessage('CRM_FORM_FILE_LIMIT_JS_TITLE'),\n\t\t\t\t\tdesign: {\n\t\t\t\t\t\tsection: false,\n\t\t\t\t\t},\n\t\t\t\t\tcontent ()\n\t\t\t\t\t{\n\t\t\t\t\t\treturn instance.load();\n\t\t\t\t\t},\n\t\t\t\t\tbuttons ({SaveButton, closeButton})\n\t\t\t\t\t{\n\t\t\t\t\t\treturn [\n\t\t\t\t\t\t\tnew SaveButton({\n\t\t\t\t\t\t\t\tonclick: btn => {\n\t\t\t\t\t\t\t\t\tif (!instance.canChange())\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tbtn.setDisabled(true);\n\t\t\t\t\t\t\t\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\t\t\t\t\t\t\t\tcontent: Loc.getMessage('CRM_FORM_FILE_LIMIT_JS_ACCESS_DENIED'),\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tbtn.setWaiting(true);\n\t\t\t\t\t\t\t\t\tinstance.save()\n\t\t\t\t\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\t\t\t\t\tbtn.setWaiting(false);\n\t\t\t\t\t\t\t\t\t\t\tBX.SidePanel.Instance.close();\n\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t\t.catch(() => {\n\t\t\t\t\t\t\t\t\t\t\tbtn.setWaiting(false);\n\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\tcloseButton\n\t\t\t\t\t\t];\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t},\n\t\t});\n\n\t\treturn promise;\n\t}\n\n\t#render(): HTMLElement\n\t{\n\t\tconst limitMb = this.#data.limitMb;\n\n\t\tthis.#ui.percentage.block = this.#createLimitPercentageBlock();\n\n\t\tthis.#ui.limit.input = Tag.render`\n\t\t\t<input \n\t\t\t\t\ttype=\"number\" \n\t\t\t\t\tname=\"limit\"\n\t\t\t\t\tvalue=\"${limitMb}\"\n\t\t\t\t\tmin=\"1\"\n\t\t\t\t\tmaxlength=\"5\"\n\t\t\t\t\tclass=\"ui-ctl-element\"\n\t\t\t\t\tonfocus=\"this.parentElement.classList.remove('ui-ctl-danger')\"\n\t\t\t\t>\n\t\t`;\n\t\tthis.#ui.limit.block = Tag.render`\n\t\t\t<div class=\"ui-ctl ui-ctl-textbox ui-ctl-w100\">\n\t\t\t\t${this.#ui.limit.input}\n\t\t\t</div>\n\t\t`;\n\n\t\tthis.#ui.container = Tag.render`\n\t\t\t<div>\n\t\t\t\t<div class=\"ui-slider-section\">\n\t\t\t\t\t<div class=\"ui-slider-content-box\">\n\t\t\t\t\t\t<div class=\"ui-slider-heading-4\">${Loc.getMessage('CRM_FORM_FILE_LIMIT_JS_DESCRIPTION_TITLE')}</div>\n\t\t\t\t\t\t<p class=\"ui-slider-paragraph-2\">\n\t\t\t\t\t\t\t${Loc.getMessage('CRM_FORM_FILE_LIMIT_JS_DESCRIPTION_TEXT')}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t\t<div class=\"ui-form-row\">\n\t\t\t\t\t\t\t${this.#ui.percentage.block}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"ui-slider-section\">\n\t\t\t\t\t<div class=\"ui-slider-content-box\">\n\t\t\t\t\t\t<div class=\"ui-slider-heading-4\">${Loc.getMessage('CRM_FORM_FILE_LIMIT_JS_SETTING_TITLE')}</div>\n\t\t\t\t\t\t<p class=\"ui-slider-paragraph-2\">\n\t\t\t\t\t\t\t${Loc.getMessage('CRM_FORM_FILE_LIMIT_JS_SETTING_DISABLE_HINT')}\n\t\t\t\t\t\t</p>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<div class=\"ui-form-row\">\n\t\t\t\t\t\t\t<div class=\"ui-form-label\">\n\t\t\t\t\t\t\t\t<div class=\"ui-ctl-label-text\">${Loc.getMessage('CRM_FORM_FILE_LIMIT_JS_LIMIT_SETTING_TITLE')}</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class=\"ui-form-content\">\n\t\t\t\t\t\t\t\t${this.#ui.limit.block}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t\treturn this.#ui.container;\n\t}\n\n\t#createLimitPercentageBlock()\n\t{\n\t\tconst percentage = Type.isInteger(this.#data.limitMb)\n\t\t\t? Math.ceil((this.#data.currentBytes / (this.#data.limitMb * 1024 * 1024)) * 100)\n\t\t\t: 0\n\t\t;\n\n\t\tconst percentageBlock = Tag.render`\n\t\t\t<div class=\"ui-alert\"></div>\n\t\t`;\n\n\t\tif (Type.isInteger(this.#data.limitMb))\n\t\t{\n\t\t\tlet colorAlertStyle = 'ui-alert-success';\n\t\t\tif (percentage >= 95)\n\t\t\t{\n\t\t\t\tcolorAlertStyle = 'ui-alert-danger';\n\t\t\t}\n\t\t\telse if (percentage >= 85)\n\t\t\t{\n\t\t\t\tcolorAlertStyle = 'ui-alert-warning';\n\t\t\t}\n\t\t\tBX.addClass(percentageBlock, colorAlertStyle);\n\t\t\tpercentageBlock.innerText = this.#getLimitPercentageText(Math.min(percentage, 100));\n\t\t}\n\t\telse if (Type.isNull(this.#data.limitMb))\n\t\t{\n\t\t\tBX.addClass(percentageBlock, 'ui-alert-default');\n\t\t\tpercentageBlock.innerText = Loc.getMessage('CRM_FORM_FILE_LIMIT_JS_LIMIT_DISABLED');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tBX.Hide(percentageBlock)\n\t\t}\n\n\t\treturn percentageBlock;\n\t}\n\n\t#getLimitPercentageText(percentage: number): string\n\t{\n\t\tlet percentageText = Loc.getMessage('CRM_FORM_FILE_LIMIT_JS_CURRENT_LIMIT_PERCENTAGE_TEXT').replace('%percentage%', percentage);\n\t\tif (percentage >= 85)\n\t\t{\n\t\t\tpercentageText = Loc.getMessage('CRM_FORM_FILE_LIMIT_JS_CURRENT_LIMIT_USERS_MIGHT_TROUBLE').replace('%percentage%', percentage);\n\t\t}\n\t\treturn percentageText;\n\t}\n\n\tcanChange(): boolean\n\t{\n\t\treturn this.#data.canChange;\n\t}\n\n\tload(): Promise\n\t{\n\t\treturn ajax.runAction('crm.form.getFileLimit', {json: {}}).then(response => {\n\t\t\tthis.#data = response.data;\n\t\t\treturn this.#render();\n\t\t});\n\t}\n\n\tsave(): Promise\n\t{\n\t\tlet limitMb = this.#ui.limit.input.value;\n\t\tthis.#ui?.limit.block.classList.remove('ui-ctl-danger');\n\n\t\tif (\n\t\t\t(Type.isInteger(limitMb) && limitMb <= 0)\n\t\t\t|| (Type.isStringFilled(limitMb && !Type.isInteger(limitMb)))\n\t\t)\n\t\t{\n\t\t\tthis.#ui.limit.block.classList.add('ui-ctl-danger');\n\t\t\treturn Promise.reject();\n\t\t}\n\t\tlimitMb = Type.isStringFilled(limitMb)\n\t\t\t? Number(limitMb)\n\t\t\t: null\n\t\t;\n\n\t\treturn ajax\n\t\t\t.runAction('crm.form.setFileLimit', {json: {limitMb}})\n\t\t\t.then(response => {\n\t\t\t\tthis.#data = response.data;\n\t\t\t\tthis.emit('onSuccessLimitChanged', {limit: this.#data.limitMb});\n\t\t\t\treturn this.#data;\n\t\t\t})\n\t\t;\n\t}\n\n\tgetValue(): {[key: string]: any}\n\t{\n\t\treturn this.#data;\n\t}\n}"],"names":["FileLimit","limitMb","undefined","currentBytes","canChange","container","HTMLElement","limit","block","input","HTMLInputElement","percentage","resolver","promise","Promise","resolve","instance","BX","SidePanel","Instance","open","width","cacheable","events","onCloseComplete","getValue","contentCallback","Layout","createContent","extensions","title","Loc","getMessage","design","section","content","load","buttons","SaveButton","closeButton","onclick","btn","setDisabled","UI","Notification","Center","notify","setWaiting","save","then","close","ajax","runAction","json","response","data","value","classList","remove","Type","isInteger","isStringFilled","add","reject","Number","emit","EventEmitter","Tag","render","Math","ceil","percentageBlock","colorAlertStyle","addClass","innerText","min","isNull","Hide","percentageText","replace"],"mappings":"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"}