this.BX=this.BX||{};(function(exports,crm_router,main_core_events,main_popup,ui_buttons,ui_tour,ui_hint,main_core,ui_navigationpanel){"use strict";function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t);t.add(e)}function _checkPrivateRedeclaration(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var namespace=main_core.Reflection.namespace("BX.Crm");var instance=null;var ToolbarEvents=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(ToolbarEvents,"TYPE_UPDATED","TypeUpdated");babelHelpers.defineProperty(ToolbarEvents,"CATEGORIES_UPDATED","CategoriesUpdated");babelHelpers.defineProperty(ToolbarEvents,"AUTOMATED_SOLUTION_UPDATED","CategoriesUpdated");var _bindAutomationGuide=new WeakSet;var ToolbarComponent=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));_classPrivateMethodInitSpec(babelHelpers.assertThisInitialized(e),_bindAutomationGuide);e.initHints();e.setEventNamespace("BX.Crm.ToolbarComponent");main_core.Event.ready(e.bindEvents.bind(babelHelpers.assertThisInitialized(e)));return e}babelHelpers.createClass(t,[{key:"initHints",value:function e(){BX.UI.Hint.init(BX("ui-toolbar-after-title-buttons"));BX.UI.Hint.popupParameters={closeByEsc:true,autoHide:true,angle:{offset:60},offsetLeft:40}}},{key:"bindEvents",value:function e(){var t=this;var i=document.querySelector('[data-role="bx-crm-toolbar-categories-button"]');if(i){var n=BX.UI.ToolbarManager.getDefaultToolbar();var a=n.getButton(main_core.Dom.attr(i,"data-btn-uniqid"));var r=Number(i.dataset.entityTypeId);if(a.counterNode&&a.counterNode.innerText>99){a.counterNode.innerText="99+"}if(a&&r>0){this.subscribeCategoriesUpdatedEvent((function(){t.reloadCategoriesMenu(a,r,i.dataset.categoryId)}))}}_classPrivateMethodGet(this,_bindAutomationGuide,_bindAutomationGuide2).call(this)}},{key:"emitTypeUpdatedEvent",value:function e(t){this.emit(ToolbarEvents.TYPE_UPDATED,t)}},{key:"emitAutomatedSolutionUpdatedEvent",value:function e(t){this.emit(ToolbarEvents.AUTOMATED_SOLUTION_UPDATED,t)}},{key:"emitCategoriesUpdatedEvent",value:function e(t){this.emit(ToolbarEvents.CATEGORIES_UPDATED,t)}},{key:"subscribeTypeUpdatedEvent",value:function e(t){this.subscribe(ToolbarEvents.TYPE_UPDATED,t)}},{key:"subscribeCategoriesUpdatedEvent",value:function e(t){this.subscribe(ToolbarEvents.CATEGORIES_UPDATED,t)}},{key:"subscribeAutomatedSolutionUpdatedEvent",value:function e(t){this.subscribe(ToolbarEvents.AUTOMATED_SOLUTION_UPDATED,t)}},{key:"unsubscribeAutomatedSolutionUpdatedEvent",value:function e(t){this.unsubscribe(ToolbarEvents.AUTOMATED_SOLUTION_UPDATED,t)}},{key:"reloadCategoriesMenu",value:function e(t,i,n){var a=this;var r=t.getMenuWindow();if(!r){return}main_core.ajax.runAction("crm.controller.category.list",{data:{entityTypeId:i}}).then((function(e){var o=0;var s=[];var l=e.data.categories;r.menuItems.forEach((function(e){if(e.id.indexOf("toolbar-category-")!==0){s.push(e.options)}else if(e.id==="toolbar-category-all"){s.push(e.options);o=1}}));r.destroy();main_core.Event.unbindAll(t.getContainer(),"click");l.forEach((function(e){var a;if(i===BX.CrmEntityType.enumeration.deal){a="/crm/deal/category/"+e.id+"/"}else{a=crm_router.Router.Instance.getItemListUrlInCurrentView(i,e.id);a=a.toString()}s.splice(o,0,{id:"toolbar-category-"+e.id,text:main_core.Text.encode(e.name),href:a?a:null});if(e.id>0&&n>0&&Number(n)===Number(e.id)){t.setText(e.name)}o++}));var c=r.params;c.items=s;t.menuWindow=new main_popup.Menu(c);main_core.Event.bind(t.getContainer(),"click",t.menuWindow.show.bind(t.menuWindow));if(i===BX.CrmEntityType.enumeration.deal){a.reloadAddButtonMenu(l)}}))["catch"]((function(e){console.log("error trying reload categories",e.errors)}))}},{key:"reloadAddButtonMenu",value:function e(t){var i=this;var n=document.querySelector(".ui-btn-split.ui-btn-success");if(!n){return}var a=n.dataset.btnUniqid;var r=BX.UI.ToolbarManager.getDefaultToolbar();var o=r.getButton(a,"data-btn-uniqid");if(!o){return}var s=o.menuWindow;if(!s){return}var l=s.getMenuItems().map((function(e){return e.id})).filter((function(e){return main_core.Type.isInteger(e)}));var c=t.map((function(e){return e.id}));var u=l.filter((function(e){return!c.includes(e)}));var d=t.filter((function(e){return!l.includes(e.id)&&e.id>0}));if(u.length>0){u.forEach((function(e){return s.removeMenuItem(e)}))}if(d.length>0){var b=s.getMenuItems().map((function(e){return e.id})).filter((function(e){return main_core.Type.isString(e)})).at(1);d.forEach((function(e){s.addMenuItem({id:e.id,text:e.name,onclick:function(t){BX.SidePanel.Instance.open("/crm/deal/details/0/?category_id="+e.id)}.bind(i)},b)}))}}},{key:"getSettingsButton",value:function e(){var t=BX.UI.ToolbarManager.getDefaultToolbar();if(!t){return null}for(var i=0,n=Object.entries(t.getButtons());i<n.length;i++){var a=babelHelpers.slicedToArray(n[i],2),r=a[0],o=a[1];if(o.getIcon()===ui_buttons.ButtonIcon.SETTING){return o}}return null}}],[{key:"Instance",get:function e(){if(window.top!==window&&main_core.Reflection.getClass("top.BX.Crm.ToolbarComponent")){return window.top.BX.Crm.ToolbarComponent.Instance}if(instance===null){instance=new t}return instance}}]);return t}(main_core_events.EventEmitter);function _bindAutomationGuide2(){var e=document.location.hash;var t;if(e==="#robots"){var i=document.querySelector(".crm-robot-btn");if(i){t=new ui_tour.Guide({steps:[{target:i,title:main_core.Loc.getMessage("CRM_TOOLBAR_COMPONENT_ROBOTS_GUIDE_TEXT_1"),text:""}],onEvents:true})}}else if(e==="#scripts"){var n=document.querySelector(".intranet-binding-menu-btn");if(n){t=new ui_tour.Guide({steps:[{target:n,title:main_core.Loc.getMessage("CRM_TOOLBAR_COMPONENT_SCRIPTS_GUIDE_TEXT"),article:"13281632",text:""}],onEvents:true})}}if(t){t.start();t.getPopup().setAutoHide(true);t.getPopup().setClosingByEsc(true)}}namespace.ToolbarComponent=ToolbarComponent;function _classPrivateFieldInitSpec(e,t,i){_checkPrivateRedeclaration$1(e,t);t.set(e,i)}function _checkPrivateRedeclaration$1(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var namespace$1=main_core.Reflection.namespace("BX.Crm");var _id=new WeakMap;var _binding=new WeakMap;var NavigationBar=function(_NavigationPanel){babelHelpers.inherits(NavigationBar,_NavigationPanel);function NavigationBar(options){var _this;babelHelpers.classCallCheck(this,NavigationBar);if(!main_core.Type.isPlainObject(options)){throw'BX.Crm.NavigationBar: The "options" argument must be object.'}options.items=main_core.Type.isArray(options.items)?options.items:[];options.items.forEach((function(item){if(!item.hasOwnProperty("active")&&item.hasOwnProperty("isActive")){item.active=item.isActive}if(main_core.Type.isStringFilled(item.lockedCallback)){item.locked=true;item.url="";item.events={click:function click(){return eval(item.lockedCallback)}}}if(main_core.Type.isStringFilled(item.url)){item.events={click:function e(){return _this.openUrl(item.id,item.url)}}}}));_this=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(NavigationBar).call(this,{target:BX(options.id),items:options.items}));_classPrivateFieldInitSpec(babelHelpers.assertThisInitialized(_this),_id,{writable:true,value:void 0});_classPrivateFieldInitSpec(babelHelpers.assertThisInitialized(_this),_binding,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(_this),_id,options.id);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(_this),_binding,options.binding);return _this}babelHelpers.createClass(NavigationBar,[{key:"openUrl",value:function e(t,i){if(!main_core.Type.isStringFilled(i)){return}if(babelHelpers.classPrivateFieldGet(this,_binding)&&main_core.Type.isPlainObject(babelHelpers.classPrivateFieldGet(this,_binding))){var n=main_core.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,_binding).category)?babelHelpers.classPrivateFieldGet(this,_binding).category:"";var a=main_core.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,_binding).name)?babelHelpers.classPrivateFieldGet(this,_binding).name:"";var r=main_core.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,_binding).key)?babelHelpers.classPrivateFieldGet(this,_binding).key:"";if(n!==""&&a!==""&&r!==""){var o=t+":"+BX.formatDate(new Date,"YYYYMMDD");BX.userOptions.save(n,a,r,o,false)}}setTimeout((function(){window.location.href=i}),150)}}]);return NavigationBar}(ui_navigationpanel.NavigationPanel);namespace$1.NavigationBar=NavigationBar;exports.ToolbarComponent=ToolbarComponent;exports.NavigationBar=NavigationBar})(this.BX.Crm=this.BX.Crm||{},BX.Crm,BX.Event,BX.Main,BX.UI,BX.UI.Tour,BX,BX,BX.UI);
//# sourceMappingURL=toolbar-component.bundle.map.js