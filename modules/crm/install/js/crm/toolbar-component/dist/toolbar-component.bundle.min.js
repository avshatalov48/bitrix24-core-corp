this.BX=this.BX||{};(function(e,t,i,r,n,a,s,l){"use strict";var o=s.Reflection.namespace("BX.Crm");var u=null;var c=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(c,"TYPE_UPDATED","TypeUpdated");babelHelpers.defineProperty(c,"CATEGORIES_UPDATED","CategoriesUpdated");var d=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e.initHints();e.setEventNamespace("BX.Crm.ToolbarComponent");s.Event.ready(e.bindEvents.bind(babelHelpers.assertThisInitialized(e)));return e}babelHelpers.createClass(t,[{key:"initHints",value:function e(){BX.UI.Hint.init(BX("ui-toolbar-after-title-buttons"));BX.UI.Hint.popupParameters={closeByEsc:true,autoHide:true,angle:{offset:60},offsetLeft:40}}},{key:"bindEvents",value:function e(){var t=this;var i=document.querySelector('[data-role="bx-crm-toolbar-categories-button"]');if(i){var r=BX.UI.ToolbarManager.getDefaultToolbar();var n=r.getButton(s.Dom.attr(i,"data-btn-uniqid"));var a=Number(i.dataset.entityTypeId);if(n&&a>0){this.subscribeCategoriesUpdatedEvent((function(){t.reloadCategoriesMenu(n,a,i.dataset.categoryId)}))}}}},{key:"emitTypeUpdatedEvent",value:function e(t){this.emit(c.TYPE_UPDATED,t)}},{key:"emitCategoriesUpdatedEvent",value:function e(t){this.emit(c.CATEGORIES_UPDATED,t)}},{key:"subscribeTypeUpdatedEvent",value:function e(t){this.subscribe(c.TYPE_UPDATED,t)}},{key:"subscribeCategoriesUpdatedEvent",value:function e(t){this.subscribe(c.CATEGORIES_UPDATED,t)}},{key:"reloadCategoriesMenu",value:function e(t,i,a){var l=this;var o=t.getMenuWindow();if(!o){return}s.ajax.runAction("crm.controller.category.list",{data:{entityTypeId:i}}).then((function(e){var u=0;var c=[];var d=e.data.categories;o.menuItems.forEach((function(e){if(e.id.indexOf("toolbar-category-")!==0){c.push(e.options)}else if(e.id==="toolbar-category-all"){c.push(e.options);u=1}}));o.destroy();s.Event.unbindAll(t.getContainer(),"click");d.forEach((function(e){var n;if(i===BX.CrmEntityType.enumeration.deal){n="/crm/deal/category/"+e.id+"/"}else{n=r.Router.Instance.getItemListUrlInCurrentView(i,e.id);n=n.toString()}c.splice(u,0,{id:"toolbar-category-"+e.id,text:s.Text.encode(e.name),href:n?n:null});if(e.id>0&&a>0&&Number(a)===Number(e.id)){t.setText(e.name)}u++}));var b=o.params;b.items=c;t.menuWindow=new n.Menu(b);s.Event.bind(t.getContainer(),"click",t.menuWindow.show.bind(t.menuWindow));if(i===BX.CrmEntityType.enumeration.deal){l.reloadAddButtonMenu(d)}}))["catch"]((function(e){console.log("error trying reload categories",e.errors)}))}},{key:"reloadAddButtonMenu",value:function e(t){var i=this;var r=document.querySelector(".ui-btn-split.ui-btn-success");if(!r){return}var n=r.dataset.btnUniqid;var a=BX.UI.ToolbarManager.getDefaultToolbar();var l=a.getButton(n,"data-btn-uniqid");if(!l){return}var o=l.menuWindow;if(!o){return}var u=o.getMenuItems().map((function(e){return e.id})).filter((function(e){return s.Type.isInteger(e)}));var c=t.map((function(e){return e.id}));var d=u.filter((function(e){return!c.includes(e)}));var b=t.filter((function(e){return!u.includes(e.id)&&e.id>0}));if(d.length>0){d.forEach((function(e){return o.removeMenuItem(e)}))}if(b.length>0){var p=o.getMenuItems().map((function(e){return e.id})).filter((function(e){return s.Type.isString(e)})).at(1);b.forEach((function(e){o.addMenuItem({id:e.id,text:e.name,onclick:function(t){BX.SidePanel.Instance.open("/crm/deal/details/0/?category_id="+e.id)}.bind(i)},p)}))}}},{key:"getSettingsButton",value:function e(){var t=BX.UI.ToolbarManager.getDefaultToolbar();if(!t){return null}for(var r=0,n=Object.entries(t.getButtons());r<n.length;r++){var a=babelHelpers.slicedToArray(n[r],2),s=a[0],l=a[1];if(l.getIcon()===i.ButtonIcon.SETTING){return l}}return null}}],[{key:"Instance",get:function e(){if(window.top!==window&&s.Reflection.getClass("top.BX.Crm.ToolbarComponent")){return window.top.BX.Crm.ToolbarComponent.Instance}if(u===null){u=new t}return u}}]);return t}(t.EventEmitter);o.ToolbarComponent=d;function b(e,t,i){p(e,t);t.set(e,i)}function p(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var f=s.Reflection.namespace("BX.Crm");var v=new WeakMap;var m=new WeakMap;var g=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);if(!s.Type.isPlainObject(e)){throw'BX.Crm.NavigationBar: The "options" argument must be object.'}e.items=s.Type.isArray(e.items)?e.items:[];e.items.forEach((function(e){if(!e.hasOwnProperty("active")&&e.hasOwnProperty("isActive")){e.active=e.isActive}if(s.Type.isStringFilled(e.url)){e.events={click:function t(){return i.openUrl(e.id,e.url)}}}}));i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,{target:BX(e.id),items:e.items}));b(babelHelpers.assertThisInitialized(i),v,{writable:true,value:void 0});b(babelHelpers.assertThisInitialized(i),m,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),v,e.id);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(i),m,e.binding);return i}babelHelpers.createClass(t,[{key:"openUrl",value:function e(t,i){if(!s.Type.isStringFilled(i)){return}if(babelHelpers.classPrivateFieldGet(this,m)&&s.Type.isPlainObject(babelHelpers.classPrivateFieldGet(this,m))){var r=s.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,m).category)?babelHelpers.classPrivateFieldGet(this,m).category:"";var n=s.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,m).name)?babelHelpers.classPrivateFieldGet(this,m).name:"";var a=s.Type.isStringFilled(babelHelpers.classPrivateFieldGet(this,m).key)?babelHelpers.classPrivateFieldGet(this,m).key:"";if(r!==""&&n!==""&&a!==""){var l=t+":"+BX.formatDate(new Date,"YYYYMMDD");BX.userOptions.save(r,n,a,l,false)}}setTimeout((function(){window.location.href=i}),150)}}]);return t}(l.NavigationPanel);f.NavigationBar=g;e.ToolbarComponent=d;e.NavigationBar=g})(this.BX.Crm=this.BX.Crm||{},BX.Event,BX.UI,BX.Crm,BX.Main,BX,BX,BX.UI);
//# sourceMappingURL=toolbar-component.bundle.map.js