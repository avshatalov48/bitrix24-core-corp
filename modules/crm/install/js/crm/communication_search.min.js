if(typeof BX.CrmCommunicationSearch==="undefined"){BX.CrmCommunicationSearch=function(){this._id="";this._settings={};this._provider=null;this._dlg=null;this._dlgContainer=null;this._enableSearch=false;this._searchCompletionHandler=BX.delegate(this._handleSearchCompletion,this);this._onDlgCloseCallback=null;this._tabData=[];this._items=[]};BX.CrmCommunicationSearch.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._enableSearch=this.getSetting("enableSearch",false);var i=this.getSetting("entityType","").toUpperCase();this._provider=BX.CrmCommunicationSearchProvider.create(this,{entityType:i,entityId:this.getSetting("entityId",""),serviceUrl:this.getSetting("serviceUrl",""),communicationType:this.getSetting("communicationType",""),enableDataLoading:this.getSetting("enableDataLoading",true)});if(!this._provider){throw"BX.CrmCommunicationSearch. Could resolve provider for '"+i+"' entity type`."}},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},getId:function(){return this._id},getCommunicationType:function(){return this.getSetting("communicationType","")},getDefaultCommunication:function(){return this._provider?this._provider.getDefaultCommunication():null},getTab:function(t){var e=this._tabData;for(var i=0;i<e.length;i++){var n=e[i];if(n["id"]==t){return n}}return null},search:function(t){if(!this._enableSearch){return}var e=this.getSetting("serviceUrl","");if(e===""){return}var i=this.getSetting("entityType","");var n=this.getSetting("entityId","");var a=this.getSetting("communicationType","");BX.ajax({url:e,method:"POST",dataType:"json",data:{ACTION:"SEARCH_COMMUNICATIONS",ENTITY_TYPE:i,ENTITY_ID:n,COMMUNICATION_TYPE:a,NEEDLE:t},async:false,start:true,onsuccess:this._searchCompletionHandler,onfailure:this._searchCompletionHandler})},openDialog:function(t,e,i){if(BX.type.isFunction(e)){this._onDlgCloseCallback=e}if(this._dlg){return}if(!BX.type.isPlainObject(i)){i={}}i=BX.mergeEx({autoHide:this.getSetting("dialogAutoHide",false),draggable:false,offsetLeft:0,offsetTop:0,closeByEsc:true,closeIcon:{top:"13px",right:"17px"},events:{onPopupShow:function(){},onPopupClose:BX.delegate(this._handleDialogClose,this),onPopupDestroy:BX.delegate(this._handleDialogDestroy,this)},content:this._prepareDialogContent(),buttons:this._prepareDialogButtons()},i);this._dlg=new BX.PopupWindow(this._id,t,i);this._dlg.show()},closeDialog:function(){if(this._dlg){this._dlg.close()}},adjustDialogPosition:function(){if(this._dlg){this._dlg.adjustPosition()}},selectCommunication:function(t){var e=this.getSetting("selectCallback",null);if(typeof e!=="function"){return}try{e(t)}catch(i){if(typeof window.console==="object"&&typeof window.console.error==="function"){window.console.error(i)}}},isDataLoaded:function(){return this._provider&&this._provider.isDataLoaded()},prepareDataRequest:function(t){if(this._provider){this._provider.prepareDataRequest(t)}},processDataResponse:function(t){if(this._provider){this._provider.processDataResponse(t)}},_handleDialogClose:function(t){if(this._onDlgCloseCallback){try{this._onDlgCloseCallback()}catch(t){}}if(this._dlg){this._dlg.destroy()}},_handleDialogDestroy:function(t){this._dlg=null},_prepareDialogContent:function(){if(!this._provider){throw"BX.CrmCommunicationSearch. Could not find provider."}var t=null;var e=[];var i=this._tabData=this._provider.prepareTabData();for(var n=0;n<i.length;n++){var a=i[n];if(!t&&a["active"]===true){t=a}e.push(this._createTabButton(a))}if(this._enableSearch){var r={id:"search",title:BX.CrmCommunicationSearch.messages["SearchTab"],active:!t};if(!t){t=r}i.push(r);e.push(this._createTabButton(r))}var s=this._prepareTabContent(t&&typeof t["items"]!="undefined"?t["items"]:[]);return this._dlgContainer=BX.create("DIV",{attrs:{className:"crm-connection-search-dlg-wrapper"},children:[BX.create("DIV",{attrs:{className:"crm-connection-search-dlg-title"},children:e}),BX.create("DIV",{attrs:{className:"crm-connection-search-dlg-content"},children:s})]})},_createTabButton:function(t){var e="crm-connection-search-dlg-button";if(t["active"]===true){e+=" crm-connection-search-dlg-button-active"}return BX.create("SPAN",{attrs:{className:e},children:[BX.create("INPUT",{attrs:{className:"crm-connection-search-dlg-tab-id",type:"hidden",value:t["id"]}}),BX.create("SPAN",{attrs:{className:"crm-connection-search-dlg-button-l"}}),BX.create("SPAN",{attrs:{className:"crm-connection-search-dlg-button-t"},text:t["title"]}),BX.create("SPAN",{attrs:{className:"crm-connection-search-dlg-button-r"}})],events:{click:BX.delegate(this._handleButtonClick,this)}})},_prepareDialogButtons:function(){return{}},_prepareNoData:function(t){var e=BX.create("DIV",{attrs:{className:"crm-connection-search-block"}});e.appendChild(BX.create("SPAN",{attrs:{className:"crm-connection-search-section"},children:[BX.create("SPAN",{attrs:{className:"crm-connection-search-title"},text:BX.CrmCommunicationSearch.messages["NoData"]})]}));t.push(e)},_prepareTabContent:function(t){this._items=[];var e=[];var i=this.getCommunicationType();if(t.length==0){this._prepareNoData(e);return e}for(var n=0;n<t.length;n++){var a=t[n];var r=a["communications"];if(r.length===0&&i!==""){continue}var s=BX.create("DIV",{attrs:{className:"crm-connection-search-block"}});e.push(s);if(r.length===0){s.appendChild(BX.create("SPAN",{attrs:{className:"crm-connection-search-section"}}));var o=BX.CrmCommunication.create(this,{type:this.getSetting("communicationType",""),entityType:a["entityType"],entityId:a["entityId"],entityTitle:a["entityTitle"],entityDescription:a["entityDescription"],value:""});this._items.push(o);s.appendChild(o.layout())}else{s.appendChild(BX.create("SPAN",{attrs:{className:"crm-connection-search-section"},children:[BX.create("SPAN",{attrs:{className:"crm-connection-search-title"},text:a["entityTitle"]}),BX.create("SPAN",{attrs:{className:"crm-connection-search-description"},text:a["entityDescription"]})]}));var c=BX.create("SPAN",{attrs:{className:"crm-connection-search-section"}});s.appendChild(c);for(var h=0;h<r.length;h++){var l=r[h];var o=BX.CrmCommunication.create(this,{type:this.getSetting("communicationType",""),entityType:a["entityType"],entityId:a["entityId"],entityTitle:a["entityTitle"],entityDescription:a["entityDescription"],value:l["value"]});this._items.push(o);c.appendChild(o.layout())}}}if(e.length===0){this._prepareNoData(e)}return e},_selectTab:function(t){var e=BX.findChildren(this._dlgContainer,{className:"crm-connection-search-dlg-button-active"},true);if(e&&e.length>0){for(var i=0;i<e.length;i++){BX.removeClass(e[i],"crm-connection-search-dlg-button-active")}}var n=BX.findChild(this._dlgContainer,{className:"crm-connection-search-dlg-tab-id",property:{value:t}},true,false);if(n){BX.addClass(n.parentNode,"crm-connection-search-dlg-button-active")}var a=BX.findChild(this._dlgContainer,{className:"crm-connection-search-dlg-content"},true,false);if(a){BX.cleanNode(a,false);var r=t!==""?this.getTab(t):null;var s=this._prepareTabContent(r&&typeof r["items"]!="undefined"?r["items"]:[]);for(var o=0;o<s.length;o++){a.appendChild(s[o])}}},_handleButtonClick:function(t){if(!this._dlgContainer){return}if(!t){t=window.event}var e=BX.findPreviousSibling(t.target,{tagName:"INPUT",className:"crm-connection-search-dlg-tab-id"},true,false);if(e){this._selectTab(e.value)}},_handleSearchCompletion:function(t){if(typeof t["DATA"]!=="undefined"&&typeof t["DATA"]["ITEMS"]!=="undefined"){var e=this.getTab("search");if(e){e["items"]=t["DATA"]["ITEMS"];this._selectTab("search")}}}};BX.CrmCommunicationSearch.create=function(t,e){var i=new BX.CrmCommunicationSearch;i.initialize(t,e);return i};BX.CrmCommunicationType={undefined:"",phone:"PHONE",email:"EMAIL"};BX.CrmCommunicationSearchProvider=function(){this._manager=null;this._settings={};this._entityType="";this._entityId="";this._commType="";this._data=[];this._items=[]};BX.CrmCommunicationSearchProvider.prototype={initialize:function(t,e){if(!t){throw"BX.CrmCommunicationSearchProvider. Manager is not defined."}this._manager=t;this._settings=e?e:{};this._entityType=this.getSetting("entityType","");this._entityId=parseInt(this.getSetting("entityId",0));this._commType=this.getSetting("communicationType","");if(this._entityType!==""&&this._entityId!==0){this._data=BX.CrmCommunicationSearchProvider.getEntityData(this._entityType,this._entityId,this._commType);if(this._data===null&&this.getSetting("enableDataLoading",true)){this._loadData()}}else{this._data={}}},getEntityType:function(){return this.getSetting("entityType","")},getDefaultCommunication:function(){if(!(BX.type.isPlainObject(this._data)&&BX.type.isArray(this._data["TABS"]))){return null}var t=this._data["TABS"];var e=this.getSetting("communicationType","");for(var i=0;i<t.length;i++){var n=t[i];var a=BX.type.isArray(n["items"])?n["items"]:[];for(var r=0;r<a.length;r++){var s=a[r];if(e===""){return BX.CrmCommunication.create(this,{type:e,entityType:s["entityType"],entityId:s["entityId"],entityTitle:"",value:s["entityTitle"]})}var o=typeof s["communications"]!="undefined"?s["communications"]:[];if(o.length>0){return BX.CrmCommunication.create(this,{type:e,entityType:s["entityType"],entityId:s["entityId"],entityTitle:s["entityTitle"],value:o[0]["value"]})}}}return null},prepareTabData:function(){var t=[];if(this._data["TABS"]){for(var e=0;e<this._data["TABS"].length;e++){t.push(this._data["TABS"][e])}}return t},getTab:function(t){var e=typeof this._data["TABS"]!="undefined"?this._data["TABS"]:[];for(var i=0;i<e.length;i++){var n=e[i];if(n["id"]==t){return n}}return null},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},prepareDataRequest:function(t){if(this._data===null&&this._entityType!==""&&this._entityId!==0){t["ENTITY_COMMUNICATIONS"]={ENTITY_TYPE:this._entityType,ENTITY_ID:this._entityId,COMMUNICATION_TYPE:this._commType}}},processDataResponse:function(t){if(this._data!==null){return}this._data=typeof t["ENTITY_COMMUNICATIONS"]!=="undefined"&&typeof t["ENTITY_COMMUNICATIONS"]["DATA"]!=="undefined"?t["ENTITY_COMMUNICATIONS"]["DATA"]:{};BX.CrmCommunicationSearchProvider.setEntityData(this._entityType,this._entityId,this._commType,this._data)},isDataLoaded:function(){return this._data!==null},_loadData:function(){var t=this.getSetting("serviceUrl","");if(this._entityType===""||this._entityId===0||t===""){return}BX.ajax({url:t,method:"POST",dataType:"json",data:{ACTION:"GET_ENTITY_COMMUNICATIONS",ENTITY_TYPE:this._entityType,ENTITY_ID:this._entityId,COMMUNICATION_TYPE:this._commType},async:false,start:true,onsuccess:BX.delegate(this._handleRequestCompletion,this),onfailure:BX.delegate(this._handleRequestError,this)})},_handleRequestCompletion:function(t){if(typeof t["DATA"]!=="undefined"){this._data=t["DATA"];BX.CrmCommunicationSearchProvider.setEntityData(this._entityType,this._entityId,this._commType,this._data)}},_handleRequestError:function(t){}};BX.CrmCommunicationSearchProvider.entityData={};BX.CrmCommunicationSearchProvider.getEntityData=function(t,e,i){if(i===""){i="PERS"}var n=t+"_"+e+"_"+i;return this.entityData.hasOwnProperty(n)?this.entityData[n]:null};BX.CrmCommunicationSearchProvider.setEntityData=function(t,e,i,n){if(i===""){i="PERS"}var a=t+"_"+e+"_"+i;this.entityData[a]=n};BX.CrmCommunicationSearchProvider.create=function(t,e){var i=new BX.CrmCommunicationSearchProvider;i.initialize(t,e);return i};BX.CrmCommunication=function(){this._settings={};this._manager=null};BX.CrmCommunication.prototype={initialize:function(t,e){if(!t){throw"BX.CrmCommunication. Manager is not defined."}this._manager=t;this._settings=e?e:{}},getSettings:function(){var t=this._settings;var e={};for(var i in t){if(t.hasOwnProperty(i)){e[i]=t[i]}}return e},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},getType:function(){return this.getSetting("type","")},getOwnerEntityType:function(){return this.getSetting("ownerEntityType","")},getOwnerEntityId:function(){return this.getSetting("ownerEntityId","")},getEntityType:function(){return this.getSetting("entityType","")},getEntityId:function(){return this.getSetting("entityId","")},getValue:function(){return this.getSetting("value","")},getEntityTitle:function(){return this.getSetting("entityTitle","")},getEntityDescription:function(){return this.getSetting("entityDescription","")},layout:function(){var t=BX.create("SPAN",{attrs:{className:"crm-connection-search-item"},events:{click:BX.delegate(this._handleClick,this)}});t.appendChild(BX.create("I"));var e=this.getSetting("value","");if(e!==""){t.appendChild(document.createTextNode(this.getSetting("value")))}else{t.appendChild(BX.create("SPAN",{attrs:{className:"crm-connection-search-title"},text:this.getSetting("entityTitle","Untitled")}));var i=this.getSetting("entityDescription","");if(i!==""){t.appendChild(BX.create("SPAN",{attrs:{className:"crm-connection-search-description"},text:i}))}}return t},_handleClick:function(t){this._manager.selectCommunication(this)}};BX.CrmCommunication.create=function(t,e){var i=new BX.CrmCommunication;i.initialize(t,e);return i};BX.CrmCommunicationSearchController=function(){this._id="";this._manager=null;this._input=null;this._value="";this._isActive=false;this._timeoutId=0;this._checkHandler=BX.delegate(this.check,this);this._keyPressHandler=BX.delegate(this.onKeyPress,this)};BX.CrmCommunicationSearchController.prototype={initialize:function(t,e){this._id=Math.random().toString();this._manager=t;this._input=e;this._value=e.value},start:function(){if(this._isActive){return}this._isActive=true;if(this._timeoutId>0){window.clearTimeout(this._timeoutId);this._timeoutId=0}BX.bind(this._input,"keyup",this._keyPressHandler)},stop:function(){if(!this._isActive){return}this._isActive=false;if(this._timeoutId>0){window.clearTimeout(this._timeoutId);this._timeoutId=0}BX.unbind(this._input,"keyup",this._keyPressHandler)},check:function(){this._timeoutId=0;if(!this._isActive){return}if(this._value!==this._input.value){this._value=this._input.value;this._timeoutId=window.setTimeout(this._checkHandler,750)}else if(this._value.length>=2){this._manager.search(this._value)}},onKeyPress:function(t){if(!this._isActive){return}if(this._timeoutId!==0){window.clearTimeout(this._timeoutId);this._timeoutId=0}this._timeoutId=window.setTimeout(this._checkHandler,375)}};BX.CrmCommunicationSearchController.create=function(t,e){var i=new BX.CrmCommunicationSearchController;i.initialize(t,e);return i}}
//# sourceMappingURL=communication_search.map.js