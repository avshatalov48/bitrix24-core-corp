BX.namespace("BX.Crm");if(typeof BX.Crm.BatchMergeManager==="undefined"){BX.Crm.BatchMergeManager=function(){this._id="";this._settings={};this._gridId="";this._entityTypeId=BX.CrmEntityType.enumeration.undefined;this._entityIds=null;this._operationHash="";this._wrapper=null;this._errors=null;this._progress=null;this._hasLayout=false;this._isRunning=false;this._progressChangeHandler=BX.delegate(this.onProgress,this);this._documentUnloadHandler=BX.delegate(this.onDocumentUnload,this)};BX.Crm.BatchMergeManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_batch_merge_mgr_"+Math.random().toString().substring(2);this._settings=e?e:{};this._gridId=BX.prop.getString(this._settings,"gridId",this._id);this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",BX.CrmEntityType.enumeration.undefined);var r=BX(BX.prop.getString(this._settings,"container",""));if(!BX.type.isElementNode(r)){throw"BX.Crm.BatchMergeManager: Could not find container."}this._wrapper=BX.create("div",{});r.appendChild(this._wrapper);this._progress=BX.AutorunProcessManager.create(this._id,{controllerActionName:"crm.api.entity.processMerge",container:this._wrapper,enableCancellation:true,title:this.getMessage("title"),timeout:1e3,stateTemplate:BX.prop.getString(this._settings,"stateTemplate","#processed# / #total#"),enableLayout:false});this._errors=[]},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.prop.getObject(this._settings,"messages",BX.Crm.BatchMergeManager.messages),t,t)},getEntityIds:function(){return this._entityIds},setEntityIds:function(t){this._entityIds=BX.type.isArray(t)?t:[]},resetEntityIds:function(){this._entityIds=[]},enableGridFilter:function(t){var e=this._gridId!==""?BX(this._gridId+"_search_container"):null;if(!e){return}if(t){BX.removeClass(e,"main-ui-disable")}else{BX.addClass(e,"main-ui-disable")}},getErrorCount:function(){return this._errors?this._errors.length:0},getErrors:function(){return this._errors?this._errors:[]},scrollInToView:function(){if(this._progress){this._progress.scrollInToView();this.refreshGridHeader()}},refreshGridHeader:function(){window.requestAnimationFrame(function(){var t=BX.Main.gridManager.getById(this._gridId);if(t&&t.instance&&t.instance.pinHeader){t.instance.pinHeader.refreshRect();t.instance.pinHeader._onScroll()}}.bind(this))},layout:function(){if(this._hasLayout){return}this._progress.layout();this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}this._progress.clearLayout();this._hasLayout=false},getState:function(){return this._progress.getState()},getProcessedItemCount:function(){return this._progress.getProcessedItemCount()},getTotalItemCount:function(){return this._progress.getTotalItemCount()},execute:function(){var t=this._id.toLowerCase();var e=BX.Crm.ConfirmationDialog.get(t);if(!e){e=BX.Crm.ConfirmationDialog.create(t,{title:this.getMessage("title"),content:this.getMessage("confirmation")})}if(!e.isOpened()){e.open().then(function(t){if(!BX.prop.getBoolean(t,"cancel",true)){this.layout();this.run();window.setTimeout(this.scrollInToView.bind(this),100)}}.bind(this))}},isRunning:function(){return this._isRunning},run:function(){if(this._isRunning){return}this._isRunning=true;BX.bind(window,"beforeunload",this._documentUnloadHandler);this.enableGridFilter(false);var t={gridId:this._gridId,entityTypeId:this._entityTypeId,extras:BX.prop.getObject(this._settings,"extras",{})};if(BX.type.isArray(this._entityIds)&&this._entityIds.length>0){t["entityIds"]=this._entityIds}BX.ajax.runAction("crm.api.entity.prepareMerge",{data:{params:t}}).then(function(t){var e=BX.prop.getString(BX.prop.getObject(t,"data",{}),"hash","");if(e===""){this.reset();return}this._operationHash=e;this._progress.setParams({hash:this._operationHash});this._progress.run();BX.addCustomEvent(this._progress,"ON_AUTORUN_PROCESS_STATE_CHANGE",this._progressChangeHandler)}.bind(this))},stop:function(){if(!this._isRunning){return}this._isRunning=false;BX.ajax.runAction("crm.api.entity.cancelMerge",{data:{params:{hash:this._operationHash}}});this.reset()},reset:function(){BX.unbind(window,"beforeunload",this._documentUnloadHandler);BX.removeCustomEvent(this._progress,"ON_AUTORUN_PROCESS_STATE_CHANGE",this._progressChangeHandler);this._isRunning=false;this._operationHash="";this._errors=[];var t=this._progress.getProcessedItemCount()>0;this._progress.reset();if(this._hasLayout){window.setTimeout(BX.delegate(this.clearLayout,this),100)}this.enableGridFilter(true);if(t){BX.Main.gridManager.reload(this._gridId)}},onDocumentUnload:function(t){return t.returnValue=this.getMessage("windowCloseConfirm")},onProgress:function(t){var e=this._progress.getState();if(e===BX.AutoRunProcessState.stopped){this.stop();return}var r=this._progress.getErrors();if(r.length>0){if(!this._errors){this._errors=r}else{this._errors=this._errors.concat(r)}}if(e===BX.AutoRunProcessState.completed){var i=this.getErrorCount();var s=this.getProcessedItemCount()-i-1;BX.addCustomEvent(window,"BX.Crm.ProcessSummaryPanel:onLayout",this._summaryLayoutHandler);BX.Crm.ProcessSummaryPanel.create(this._id,{container:this._wrapper,data:{succeededCount:s,failedCount:i,errors:this.getErrors()},messages:BX.prop.getObject(this._settings,"messages",null),numberSubstitution:"#number#",displayTimeout:1500}).layout();this.reset();window.setTimeout(function(){BX.onCustomEvent(window,"BX.Crm.BatchMergeManager:onProcessComplete",[this])}.bind(this),300)}}};if(typeof BX.Crm.BatchMergeManager.messages==="undefined"){BX.Crm.BatchMergeManager.messages={}}BX.Crm.BatchMergeManager.items={};BX.Crm.BatchMergeManager.getItem=function(t){return BX.prop.get(this.items,t,null)};BX.Crm.BatchMergeManager.create=function(t,e){var r=new BX.Crm.BatchMergeManager;r.initialize(t,e);this.items[r.getId()]=r;return r}}
//# sourceMappingURL=batch_merge.map.js