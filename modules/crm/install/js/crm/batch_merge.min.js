BX.namespace("BX.Crm");if(typeof BX.Crm.BatchMergeManager==="undefined"){BX.Crm.BatchMergeManager=function(){this._id="";this._settings={};this._gridId="";this._entityTypeId=BX.CrmEntityType.enumeration.undefined;this._entityIds=null;this._wrapper=null;this._errors=null;this._isRunning=false;this._documentUnloadHandler=BX.delegate(this.onDocumentUnload,this);this._requestCompleteHandler=BX.delegate(this.onRequestComplete,this);this._externalEventHandler=null};BX.Crm.BatchMergeManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_batch_merge_mgr_"+Math.random().toString().substring(2);this._settings=e?e:{};this._gridId=BX.prop.getString(this._settings,"gridId",this._id);this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",BX.CrmEntityType.enumeration.undefined);var n=BX(BX.prop.getString(this._settings,"container",""));if(!BX.type.isElementNode(n)){throw"BX.Crm.BatchMergeManager: Could not find container."}this._wrapper=BX.create("div",{});n.appendChild(this._wrapper);this._errors=[]},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.prop.getObject(this._settings,"messages",BX.Crm.BatchMergeManager.messages),t,t)},getEntityIds:function(){return this._entityIds},setEntityIds:function(t){this._entityIds=BX.type.isArray(t)?t:[]},resetEntityIds:function(){this._entityIds=[]},getErrors:function(){return this._errors?this._errors:[]},execute:function(){var t=this._id.toLowerCase();var e=BX.Crm.ConfirmationDialog.get(t);if(!e){e=BX.Crm.ConfirmationDialog.create(t,{title:this.getMessage("title"),content:this.getMessage("confirmation")})}if(!e.isOpened()){e.open().then(function(t){if(!BX.prop.getBoolean(t,"cancel",true)){this.startRequest()}}.bind(this))}},isRunning:function(){return this._isRunning},startRequest:function(){if(this._isRunning){return}this._isRunning=true;BX.Main.gridManager.getInstanceById(this._gridId).tableFade();BX.bind(window,"beforeunload",this._documentUnloadHandler);var t={entityTypeId:this._entityTypeId,extras:BX.prop.getObject(this._settings,"extras",{})};if(BX.type.isArray(this._entityIds)&&this._entityIds.length>0){t["entityIds"]=this._entityIds}BX.ajax.runAction("crm.api.entity.mergeBatch",{data:{params:t}}).then(this._requestCompleteHandler).catch(this._requestCompleteHandler)},onRequestComplete:function(t){BX.Main.gridManager.getInstanceById(this._gridId).tableUnfade();BX.unbind(window,"beforeunload",this._documentUnloadHandler);this._isRunning=false;this._errors=[];var e=BX.prop.getString(t,"status","");var n=BX.prop.getObject(t,"data",{});if(e==="error"){if(BX.prop.getString(n,"STATUS","")==="CONFLICT"){this.openMerger();return}var i=BX.prop.getArray(t,"errors",[]);for(var r=0,s=i.length;r<s;r++){this._errors.push(BX.prop.getString(i[r],"message"))}}this.displaySummary();if(this._errors.length===0){window.setTimeout(this.complete.bind(this),0)}},displaySummary:function(){var t=[this.getMessage("summaryCaption")];if(this._errors.length>0){t.push(this.getMessage("summaryFailed").replace(/#number#/gi,this._entityIds.length));t=t.concat(this._errors)}else{t.push(this.getMessage("summarySucceeded").replace(/#number#/gi,this._entityIds.length))}BX.UI.Notification.Center.notify({content:t.join("<br/>"),position:"top-center",autoHideDelay:5e3})},openMerger:function(){this._contextId=this._id+"_"+BX.util.getRandomString(6).toUpperCase();BX.Crm.Page.open(BX.util.add_url_param(BX.prop.getString(this._settings,"mergerUrl",""),{externalContextId:this._contextId,id:this._entityIds}));if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}},complete:function(){BX.onCustomEvent(window,"BX.Crm.BatchMergeManager:onComplete",[this]);BX.Main.gridManager.reload(this._gridId)},onDocumentUnload:function(t){return t.returnValue=this.getMessage("windowCloseConfirm")},onExternalEvent:function(t){var e=BX.prop.getString(t,"key","");if(e!=="onCrmEntityMergeComplete"){return}var n=BX.prop.getObject(t,"value",{});if(this._contextId!==BX.prop.getString(n,"context","")){return}BX.removeCustomEvent(window,"onLocalStorageSet",this._externalEventHandler);this._externalEventHandler=null;this.displaySummary();window.setTimeout(this.complete.bind(this),0)}};if(typeof BX.Crm.BatchMergeManager.messages==="undefined"){BX.Crm.BatchMergeManager.messages={}}BX.Crm.BatchMergeManager.items={};BX.Crm.BatchMergeManager.getItem=function(t){return BX.prop.get(this.items,t,null)};BX.Crm.BatchMergeManager.create=function(t,e){var n=new BX.Crm.BatchMergeManager;n.initialize(t,e);this.items[n.getId()]=n;return n}}
//# sourceMappingURL=batch_merge.map.js