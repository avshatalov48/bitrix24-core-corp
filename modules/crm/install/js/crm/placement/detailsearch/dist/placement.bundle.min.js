this.BX=this.BX||{},this.BX.Crm=this.BX.Crm||{},function(e,t){"use strict";var n=function(){function e(n,i){babelHelpers.classCallCheck(this,e),this.placementCode=t.Type.isStringFilled(n)?n:"",this.placementInterface=null,this.settings=i,this.queue=[],this.isActive=!1,this.isInited=!1;var s=BX.Reflection.getClass("BX.rest.AppLayout");(s?s.getPlacement(this.placementCode):null)?this.initialize():BX.ajax.runComponentAction("bitrix:app.placement","getComponent",{data:{placementId:this.placementCode,placementOptions:{}}}).then(function(e){var t=BX.create("DIV",{style:{display:"none",overflow:"hidden"}});document.body.appendChild(t),BX.html(t,e.data.html,{callback:function(){setTimeout(this.initialize.bind(this),10)}.bind(this)})}.bind(this),this.initialize.bind(this))}return babelHelpers.createClass(e,[{key:"initialize",value:function(){this.isInited=!0,this.placement=BX.rest?BX.rest.AppLayout.getPlacement(this.placementCode):null,this.placement&&(this.placementInterface=BX.rest.AppLayout.initializePlacement(this.placementCode),this.isActive=!0),this.executeCallbacks()}},{key:"addCallback",value:function(e){this.queue.push(e),this.executeCallbacks()}},{key:"executeCallbacks",value:function(){if(this.isInited)for(var e;(e=this.queue.shift())&&t.Type.isFunction(e);)e({success:this.isActive,placement:this.placement,placementInterface:this.placementInterface,placementEventObject:this})}}],[{key:"getCallbackFromSettings",value:function(e){var n=null;return t.Type.isPlainObject(e)&&e.hasOwnProperty("callback")&&t.Type.isFunction(e.callback)&&(n=e.callback,delete e.callback),n}},{key:"create",value:function(e,n){var i=t.Runtime.clone(n),s=this.getCallbackFromSettings(i);this.instances.has(e)||this.instances.set(e,new this(e,i));var a=this.instances.get(e);return null!==s&&a.addCallback(s),a}}]),e}();babelHelpers.defineProperty(n,"instances",new Map);var i=function(){function e(t,n){babelHelpers.classCallCheck(this,e),this.placementInfo=t,this.eventObject=n,this.menuItem=null,this.menuItemLoader=null,this.appSid=null,this.searchResults=null,this.isActive=!1,this.chaperonTimeoutId=0,this.expectedResponseTime=2e4,this.activateHandler=this.activate.bind(this),this.checkResponseHandler=this.checkResponse.bind(this),this.checkActiveHandler=this.checkActive.bind(this),this.destroyHandler=this.destroy.bind(this),BX.addCustomEvent(this.eventObject,"Placements:destroy",this.destroyHandler),BX.addCustomEvent(this.eventObject,"Placement:click",this.checkActiveHandler)}return babelHelpers.createClass(e,[{key:"activate",value:function(e){return e&&(e.hasOwnProperty("isTrusted")&&!e.isTrusted&&this.setActive(!1),BX.PreventDefault(e)),this.isActive||(BX.onCustomEvent(this.eventObject,"Placement:click",[this]),this.setActive(!0),this.find()),!1}},{key:"setActive",value:function(e){this.isActive=!!e,this.menuItem&&(this.isActive?this.menuItem.layout.item.classList.add("menu-popup-item-open"):this.menuItem.layout.item.classList.remove("menu-popup-item-open"))}},{key:"checkActive",value:function(e){e!==this&&this.setActive(!1)}},{key:"getMenuItemContainer",value:function(e){if(!this.menuItem&&(this.menuItem=e.addMenuItemInternal({id:s.MENU_ITEM_ID_PREFIX+this.placementInfo.id,text:BX.util.htmlspecialchars(this.placementInfo.title),subMenuOffsetX:27,onclick:this.activateHandler,allowHtml:!0,cacheable:!0,className:this.placementInfo.icon?"menu-popup-item-accept":""}),this.placementInfo.icon)){var t=this.menuItem.getContainer().querySelector(".menu-popup-item-icon");t.style.backgroundImage="url('"+BX.util.htmlspecialchars(this.placementInfo.icon.src)+"')",t.style.backgroundSize="contain"}return this.menuItem.getContainer()}},{key:"find",value:function(){this.showLoader();var e={placementId:this.placementInfo.id,placementOptions:null};BX.onCustomEvent(this.eventObject,"Placement:send",[e]),BX.ajax.runComponentAction("bitrix:app.layout","getComponent",{data:e}).then(function(e){if(this.menuItem){if(!(e&&e.data&&e.data.componentResult))return this.makeError(new Error("Empty response"));var t=e.data.componentResult;this.appSid=t.APP_SID,BX.addCustomEvent(this.eventObject,"Placements:found",this.checkResponseHandler);var n=BX.create("DIV",{attrs:{"data-app-sid":t.APP_SID},style:{display:"none",overflow:"hidden"}});document.body.appendChild(n),BX.html(n,e.data.html),this.chaperonTimeoutId=setTimeout(this.chaperon.bind(this),this.expectedResponseTime,this.appSid)}}.bind(this),this.makeError.bind(this))}},{key:"checkResponse",value:function(e,t){null!==this.appSid&&this.appSid===e.params.appSid&&(BX.removeCustomEvent(this.eventObject,"Placements:found",this.checkResponseHandler),this.chaperonTimeoutId>0&&(clearTimeout(this.chaperonTimeoutId),this.chaperonTimeoutId=0),this.searchResults=BX.type.isArray(t)?BX.clone(t,!0):[],this.hideLoader(),this.menuItem&&(this.searchResults.length<=0?this.menuItem.disable():this.menuItem.isDisabled()&&this.menuItem.enable()),BX.onCustomEvent(this.eventObject,"Placement:found",[this,this.searchResults]))}},{key:"chaperon",value:function(){this.chaperonTimeoutId=0,this.makeError(new Error("The placement is responding too long."))}},{key:"makeError",value:function(e){this.hideLoader(!0),BX.removeCustomEvent(this.eventObject,"Placements:found",this.checkResponseHandler),BX.onCustomEvent(this.eventObject,"Placement:errored",[this,e])}},{key:"showLoader",value:function(){this.menuItem&&(this.menuItemLoader=this.menuItemLoader||new BX.Loader({target:this.menuItem.getContainer(),size:20,mode:"inline"}),this.menuItemLoader.show(),this.menuItem.disable())}},{key:"hideLoader",value:function(e){e=!0===e,this.menuItem&&(this.menuItemLoader&&this.menuItemLoader.hide(),e&&this.menuItem.disable())}},{key:"destroy",value:function(){BX.removeCustomEvent(this.eventObject,"Placements:destroy",this.destroyHandler),BX.removeCustomEvent(this.eventObject,"Placement:click",this.checkActiveHandler),null!==this.appSid&&BX.rest.AppLayout.get(this.appSid)&&BX.rest.AppLayout.get(this.appSid).destroy(),this.menuItemLoader&&(this.menuItemLoader.destroy(),this.menuItemLoader=null),this.chaperonTimeoutId>0&&(clearTimeout(this.chaperonTimeoutId),this.chaperonTimeoutId=0),this.menuItem=null,this.searchResults=null,this.eventObject=null}}]),e}(),s=function(){function e(t){babelHelpers.classCallCheck(this,e),this.placementCode=t,this.searchParams={},this.container=BX.create("div",{props:{className:"placement-container"}}),this.containerLoader=null,this.placementList=new Map,this.firstPlacementAppId=0,this.placementInterface=null,this.placementEventObject=null,this.isInited=!1,this.isDestroyed=!1,this.isShown=!1,this.active=null,this.activeProcesses=0,this.menu=null,this.placementParams=null,this.isLoderEnabled=!0,this.restCrmShowFoundEntities=this.restCrmShowFoundEntities.bind(this),this.restCrmShowCreatedEntity=this.restCrmShowCreatedEntity.bind(this),BX.addCustomEvent(this,"Placements:destroy",this.destroy.bind(this)),n.create(this.placementCode,{callback:this.init.bind(this)})}return babelHelpers.createClass(e,[{key:"init",value:function(e){if(!0!==this.isInited&&!0!==this.isDestroyed){if(!0===e.success&&e.placement&&e.placement.param&&e.placement.param.extendedList instanceof Map){this.placementList=e.placement.param.extendedList,this.placementEventObject=e.placementEventObject;var t=e.hasOwnProperty("placementInterface"),n=t&&!e.placementInterface.hasOwnProperty("crmShowFoundEntities");t&&(this.placementInterface=n?this.initializeInterface(e.placementInterface):e.placementInterface)}this.isInited=!0,this.isShown&&this.showMenu()}}},{key:"initializeInterface",value:function(e){var t=this.placementEventObject;return e.prototype.crmShowFoundEntities=function(e){BX.onCustomEvent(t,"restCrmShowFoundEntities",[this,e.data])},e.prototype.crmShowCreatedEntity=function(e){BX.onCustomEvent(t,"restCrmShowCreatedEntity",[this,e])},e.prototype.events.push("onCrmEntityIsNeedToCreate"),e}},{key:"show",value:function(e,t,n){BX.Type.isDomNode(t)?t.parentNode.insertBefore(this.container,t):BX.Type.isDomNode(e)&&e.appendChild(this.container),this.isShown=!0,this.isLoderEnabled=!BX.prop.getBoolean(n,"hideLoader",!1),!0!==this.isInited?this.isLoderEnabled&&this.showLoader():this.showMenu()}},{key:"showLoader",value:function(){this.containerLoader=this.containerLoader||new BX.Loader({target:this.container,size:50}),this.containerLoader.show()}},{key:"hideLoader",value:function(){this.containerLoader&&this.containerLoader.hide()}},{key:"getCountryMap",value:function(e){var n=new Map,i=BX.prop.getString(BX.prop.getObject(e,"options",{}),"countries","");return t.Type.isStringFilled(i)&&/^[1-9][0-9]*(,[1-9][0-9]*)*$/.test(i)&&i.split(",").forEach((function(e){var t=parseInt(e);isNaN(t)||n.has(t)||n.set(t,!0)})),n}},{key:"showMenu",value:function(){this.isLoderEnabled&&this.hideLoader();var e={placementParams:null,currentSearchQuery:""};BX.onCustomEvent(this,"Placements:params",[e]),this.placementParams=t.Runtime.clone(e.placementParams);var n=BX.prop.getString(e,"currentSearchQuery","");if(t.Type.isObject(this.placementParams)){var s=this.placementParams.numberOfPlacements>0;if(this.refreshContainerVisibility({currentSearchQuery:n,placementParams:t.Runtime.clone(this.placementParams)}),!s)return}BX.adjust(this.container,{props:{className:"placement-container menu-popup"}}),this.replaceEvents(),this.destroyMenu(),this.menu=new BX.PopupMenuWindow({id:"someId"}),BX.onCustomEvent(this,"Placements:beforeAppendItems");var a=BX.create("div",{props:{className:"menu-popup-items"}});this.container.appendChild(a),this.firstPlacementAppId=0,this.placementList.forEach(function(e){var t=this.getCountryMap(e),n=BX.prop.getInteger(this.placementParams,"countryId",0);if(0===t.size||t.has(n)){0===this.firstPlacementAppId&&(this.firstPlacementAppId=parseInt(e.id));var s=new i(e,this);a.appendChild(s.getMenuItemContainer(this.menu))}}.bind(this)),t.Type.isObject(this.placementParams)&&this.placementParams.isPlacement&&this.placementParams.numberOfPlacements<=1&&this.setFirstPlacementMenuItemVisibility(!1)}},{key:"restCrmShowFoundEntities",value:function(e,t){BX.onCustomEvent(this,"Placements:found",[e,t])}},{key:"restCrmEntityCreate",value:function(e){this.activeProcesses++,BX.onCustomEvent("onCrmEntityIsNeedToCreate",e)}},{key:"restCrmShowCreatedEntity",value:function(e,t){this.activeProcesses--,BX.onCustomEvent(this,"Placements:select",[t])}},{key:"onPlacementHasBeenClicked",value:function(e){this.active!==e&&(this.active=e,this.activeProcesses++)}},{key:"onPlacementIsReadyToSend",value:function(e){BX.onCustomEvent(this,"Placements:searchParams",[this.searchParams]),e.placementOptions=this.searchParams}},{key:"onPlacementHasBeenFound",value:function(e,t){this.active===e&&BX.onCustomEvent(this,"Placements:setFoundItems",[e,t]),this.activeProcesses--}},{key:"onPlacementIsErrored",value:function(){this.activeProcesses--}},{key:"replaceEvents",value:function(){BX.addCustomEvent(this.placementEventObject,"restCrmShowFoundEntities",this.restCrmShowFoundEntities),BX.addCustomEvent(this.placementEventObject,"restCrmShowCreatedEntity",this.restCrmShowCreatedEntity),BX.addCustomEvent(this,"Placement:click",this.onPlacementHasBeenClicked),BX.addCustomEvent(this,"Placement:send",this.onPlacementIsReadyToSend.bind(this)),BX.addCustomEvent(this,"Placement:found",this.onPlacementHasBeenFound.bind(this)),BX.addCustomEvent(this,"Placement:errored",this.onPlacementIsErrored.bind(this)),BX.addCustomEvent(this,"Placements:active",this.onCheckActive.bind(this)),BX.addCustomEvent(this,"Placements:pick",this.restCrmEntityCreate.bind(this)),BX.addCustomEvent(this,"Placements:changeQuery",this.onChangeSearchQuery.bind(this)),BX.addCustomEvent(this,"Placements:startDefaultSearch",this.onStartDefaultSearch.bind(this))}},{key:"restoreEvents",value:function(){BX.removeAllCustomEvents(this,"Placement:click"),BX.removeAllCustomEvents(this,"Placement:send"),BX.removeAllCustomEvents(this,"Placement:found"),BX.removeAllCustomEvents(this,"Placement:errored"),BX.removeAllCustomEvents(this,"Placements:found"),BX.removeAllCustomEvents(this,"Placements:active"),BX.removeAllCustomEvents(this,"Placements:pick"),BX.removeAllCustomEvents(this,"Placements:changeQuery"),BX.removeAllCustomEvents(this,"Placements:startDefaultSearch"),BX.removeAllCustomEvents(this,"Placements:destroy"),BX.removeCustomEvent(this.placementEventObject,"restCrmShowFoundEntities",this.restCrmShowFoundEntities),BX.removeCustomEvent(this.placementEventObject,"restCrmShowCreatedEntity",this.restCrmShowCreatedEntity)}},{key:"onCheckActive",value:function(e){e.active=this.activeProcesses>0}},{key:"onPlacementsDestroy",value:function(){this.destroy()}},{key:"destroyMenu",value:function(){this.menu&&(this.menu.destroy(),this.menu=null)}},{key:"destroy",value:function(){for(var e in this.isDestroyed=!0,this.destroyMenu(),this.restoreEvents(),this.placementInterface=null,this.placementEventObject=null,this.containerLoader&&(this.containerLoader.destroy(),this.containerLoader=null),this)this.hasOwnProperty(e)&&delete this[e]}},{key:"setFirstPlacementAppId",value:function(e){this.firstPlacementAppId=parseInt(e)}},{key:"getFirstPlacementAppId",value:function(){return this.firstPlacementAppId}},{key:"getFirstPlacementMenuItemId",value:function(){var t=this.getFirstPlacementAppId();return t>0?e.MENU_ITEM_ID_PREFIX+t:""}},{key:"getFirstPlacementMenuItem",value:function(){var e=null,n=this.getFirstPlacementMenuItemId();return t.Type.isStringFilled(n)&&this.menu&&(e=this.menu.getMenuItem(n)),e}},{key:"refreshContainerVisibility",value:function(e){var t=BX.prop.getObject(e,"placementParams",{}),n=BX.prop.getInteger(t,"numberOfPlacements",0),i=n>0,s=BX.prop.getBoolean(t,"isPlacement",!1),a=BX.prop.getString(e,"currentSearchQuery",""),r=i&&(!s||s&&n>1)&&a.length>2;this.setContainerVisibility(this.container,r)}},{key:"setFirstPlacementMenuItemVisibility",value:function(e){var t=this.getFirstPlacementMenuItem();t&&this.setContainerVisibility(t.getContainer(),e)}},{key:"setContainerVisibility",value:function(e,n){t.Type.isDomNode(e)&&(n&&"none"===e.style.display?e.style.display="":n||""!==e.style.display||(e.style.display="none"))}},{key:"activateFirstPlacementMenuItem",value:function(){var e=this;setTimeout((function(){var t=e.getFirstPlacementMenuItem();t&&t.layout.text.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0}))}),0)}},{key:"onChangeSearchQuery",value:function(e){this.refreshContainerVisibility({currentSearchQuery:BX.prop.getString(e,"currentSearchQuery",""),placementParams:t.Runtime.clone(this.placementParams)})}},{key:"onStartDefaultSearch",value:function(e){t.Type.isPlainObject(e)&&e.hasOwnProperty("appId")&&(e.appId=this.getFirstPlacementAppId()),this.activateFirstPlacementMenuItem()}}]),e}();babelHelpers.defineProperty(s,"MENU_ITEM_ID_PREFIX","placement-"),e.DetailSearch=s}(this.BX.Crm.Placement=this.BX.Crm.Placement||{},BX);
//# sourceMappingURL=placement.bundle.map.js