BX.namespace("BX.Crm.Activity");(function(e){"use strict";if(typeof e.Crm.Activity.Planner!=="undefined")return;var t="data-crm-act-planner";var i="/bitrix/components/bitrix/crm.activity.planner/ajax.php?site_id="+e.message("SITE_ID");var n="/bitrix/components/bitrix/crm.activity.editor/ajax.php?siteID="+e.message("SITE_ID")+"&sessid="+e.bitrix_sessid();var a=function(e){if(typeof e==="undefined")e={};this.ajaxUrl=e.ajaxUrl||i;this.loadOffsetLeft=2;this.loadOffsetRight=2;this.PLANNER_DURATION_LIMIT=864e6;this.showError=function(e){window.alert(e)};a.Manager.put(this)};a.Manager={instances:{},listeners:{},lastId:"",put:function(e){if(!(e instanceof a))throw"activityPlanner is not instanceof Planner";var t=e.getPlannerId();this.instances[t]=e;this.lastId=t;return this},get:function(e){e=e.toString();if(typeof this.instances[e]==="undefined")return null;return this.instances[e]},getLast:function(){return this.get(this.lastId)},pop:function(e){delete this.instances[e.toString()];return this},findByChild:function(i){var n=e.findParent(i,{attr:t});if(n){return this.get(n.getAttribute(t))}return null},setCallback:function(e,t){this.listeners[e]=t;return this},fireEvent:function(e,t,i){var n=this.listeners[e];if(typeof n==="function"){n.call(i,t)}},fireGlobalEvent:function(e,t,i){this.fireEvent(e,t,i);if(window!==top&&top.BX.Crm&&top.BX.Crm.Activity&&top.BX.Crm.Activity.Planner&&top.BX.Crm.Activity.Planner.Manager){top.BX.Crm.Activity.Planner.Manager.fireEvent(e,t,i)}}};a.util={unFormatTime:function(e){var t=e.split(/[\s:]+/);if(t.length==3){var i=t[2];if(i=="pm"&&t[0]<12)t[0]=parseInt(t[0],10)+12;if(i=="am"&&t[0]==12)t[0]=0}return parseInt(t[0],10)*3600+parseInt(t[1],10)*60},formatTime:function(t){var i=e.date.convertBitrixFormat(e.message("FORMAT_DATE")).replace(/:?\s*s/,""),n=e.date.convertBitrixFormat(e.message("FORMAT_DATETIME")).replace(/:?\s*s/,""),a=e.date.format(i,t),o=e.date.format(n,t);return e.util.trim(o.replace(a,""))},convertDateTime:function(t){var i=e.message("FORMAT_DATETIME");var n=e.date.convertBitrixFormat(e.type.isNotEmptyString(i)?i:"DD.MM.YYYY HH:MI:SS");return e.date.format(n,t)},storageType:{File:1,Webdav:2,Disk:3},periodType:{min:1,hour:2,day:3},getPeriodLabels:function(t){var i=[];if(t===1)i=[e.message("CRM_ACTIVITY_PLANNER_MIN1"),e.message("CRM_ACTIVITY_PLANNER_MIN2"),e.message("CRM_ACTIVITY_PLANNER_MIN3")];else if(t===2)i=[e.message("CRM_ACTIVITY_PLANNER_HOUR1"),e.message("CRM_ACTIVITY_PLANNER_HOUR2"),e.message("CRM_ACTIVITY_PLANNER_HOUR3")];else if(t===3)i=[e.message("CRM_ACTIVITY_PLANNER_DAY1"),e.message("CRM_ACTIVITY_PLANNER_DAY2"),e.message("CRM_ACTIVITY_PLANNER_DAY3")];return i}};a.prototype.getPlannerId=function(){if(typeof this.plannerId==="undefined")this.plannerId="crm-act-planner-"+Math.round(Math.random()*1e5);return this.plannerId};a.prototype.setPopup=function(e){this.popup=e;return this};a.prototype.getPopup=function(){return this.popup};a.prototype.setPlannerNode=function(e){this.scopeNode=e;return this};a.prototype.getPlannerNode=function(){return this.scopeNode};a.prototype.getNode=function(e,t){if(!t)t=this.getPlannerNode();return t?t.querySelector('[data-role="'+e+'"]'):null};a.prototype.getNodeValue=function(e,t){var i=this.getNode(e,t);return i?i.value:null};a.prototype._createAjaxPopup=function(i,n){i["sessid"]=e.bitrix_sessid();i["PLANNER_ID"]=this.getPlannerId();var a=this;e.ajax({method:"POST",dataType:"html",url:this.ajaxUrl,data:i,onsuccess:function(i){var o=e.create("div",{style:{"min-width":"660px"}});o.innerHTML=i;o.setAttribute(t,a.getPlannerId());var r="",s=a.getNode("wrapper-container",o);if(s){r=s.getAttribute("data-title")}if(!r)r=e.message("CRM_ACTIVITY_PLANNER_PLANNING_TITLE");var l=[];if(s){l.push(new e.PopupWindowButton({text:e.message("CRM_ACTIVITY_PLANNER_SAVE"),className:"popup-window-button-accept",events:{click:function(){a.saveActivity()}}}))}l.push(new e.PopupWindowButtonLink({text:e.message("CRM_ACTIVITY_PLANNER_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}}));var d=new e.PopupWindow(a.getPlannerId(),null,{titleBar:r,content:o,closeIcon:true,contentNoPaddings:true,zIndex:-100,offsetLeft:0,offsetTop:0,closeByEsc:true,draggable:{restrict:false},overlay:{backgroundColor:"black",opacity:30},events:{onPopupClose:function(t){a.onPopupClose();t.destroy();e.onCustomEvent(window,"onActivityEditorClose",[])}},buttons:l});a.setPlannerNode(o);a.setPopup(d);n(s)}})};a.prototype._createEditSlider=function(i,n){var a=this;i["PLANNER_ID"]=this.getPlannerId();i.ajax_action="ACTIVITY_EDIT";i.activity_id=i["ID"]||0;top.BX.SidePanel.Instance.open("/bitrix/components/bitrix/crm.activity.planner/slider.php?site_id="+e.message("SITE_ID")+"&"+e.ajax.prepareData(i),{compatibleEvents:true,allowChangeHistory:false,events:{onOpen:function(e){var i=e.iframe.contentWindow.BX;if(!i){return}i.namespace("BX.Crm.Activity");if(!i.Crm.Activity.Planner){return}var n=e.iframe.contentDocument.body;var o=new i.Crm.Activity.Planner;o.plannerId=a.getPlannerId();n.setAttribute(t,o.getPlannerId());o.setPlannerNode(n);o.prepareEditLayout(n);i.addCustomEvent("OnCalendarPlannerSelectorChanged",function(e){o.skipPlannerRefresh=true;o.setStartTime(e.dateFrom);e.dateTo?o.setEndTime(e.dateTo):o.recalculateEndTime(true);o.refreshDateTimeView();o.skipPlannerRefresh=false});i.addCustomEvent("OnCalendarPlannerScaleChanged",function(e){o.updatePlanner({users:e.entrieIds,entries:e.entries,from:e.from,to:e.to,focusSelector:e.focusSelector===true})});i.addCustomEvent("onAfterActivitySave",function(t){top.BX.onCustomEvent(a,"onAfterActivitySave",t);i.Crm.Activity.Planner.Manager.fireGlobalEvent("onAfterActivitySave",{},a);e.close()});var r=o.getNode("button-save");if(r){i.bind(r,"click",function(e){e.preventDefault();o.saveActivity()})}var s=o.getNode("button-cancel");if(s){i.bind(s,"click",function(){e.close()})}var l=o.getNode("error-block"),d=o.getNode("error-block-text");if(l&&d){o.showError=function(e){d.textContent=e;i.style(l,"height","auto");i.style(l,"opacity","1");setTimeout(function(){i.style(l,"height","0");i.style(l,"opacity","0")},1500)}}}}})};a.prototype.onNotifyActivatorChange=function(t){var i=t.checked;var n=this.getNode("notify-switcher");var a=this.getNode("notify-activator-label");e[i?"addClass":"removeClass"](n,"crm-activity-popup-container-open");a.innerHTML=a.getAttribute("data-label-"+(i?"y":"n"));this.setNotify(i?15:0,i?1:0)};a.prototype.onNotifyChangeClick=function(t){var i=this;var n=e.clone(i.getNode("template-notify"));var a=i.getNode("notify-value",n);var o=i.getNode("notify-value-type",n);var r=i.getNode("field-notify-value");var s=i.getNode("field-notify-type");a.value=r.value;o.value=s.value;var l=new e.PopupWindow("crm-act-win-notify-"+Math.round(Math.random()*1e5),t,{lightShadow:true,autoHide:true,closeByEsc:true,bindOptions:{position:"bottom"},angle:{position:"top"},closeIcon:false,events:{onPopupClose:function(e){e.destroy()}},content:n});var d=i.getNode("notify-menu-save",n);e.bind(d,"click",function(){i.setNotify(a.value,o.value);l.close()});l.show();return false};a.prototype.synchronizeViewModeState=function(){var e=this.getNode("view-mode-switcher");if(e.getAttribute("data-state")==="open"){var t=this.getNode("detail-container");e.innerHTML=e.getAttribute("data-label-short");t.style.maxHeight="60px";t.style.marginTop="30px";t.style.marginBottom="15px";t.style.opacity=1}};a.prototype.onViewModeClick=function(t){var i=t.getAttribute("data-state")=="open"?1:0;var n=parseInt(t.getAttribute("data-animation-duration"))||250;var a=this.getNode("detail-container");var o={dateMaxHeight:i*60,dateMarginTop:i*30,dateMarginBottom:i*15,dateOpacity:i*100};var r={dateMaxHeight:60-i*60,dateMarginTop:30-i*30,dateMarginBottom:15-i*15,dateOpacity:100-i*100};new e.easing({duration:n,start:o,finish:r,transition:e.easing.makeEaseInOut(e.easing.transitions.quad),step:e.delegate(function(e){a.style.maxHeight=e.dateMaxHeight+"px";a.style.marginTop=e.dateMarginTop+"px";a.style.marginBottom=e.dateMarginBottom+"px";a.style.opacity=e.dateOpacity/100},t)}).animate();t.innerHTML=t.getAttribute("data-label-"+(i==0?"short":"detail"));t.setAttribute("data-state",i==0?"open":"");e.userOptions.save("crm.activity.planner","edit","view_mode",i==1?"short":"detail",false);return false};a.prototype.onAdditionalModeClick=function(t){var i=this.getNode("additional-container");e.toggleClass(i,"crm-activity-person-detail-open");e.toggleClass(t,"crm-activity-popup-info-person-link-triangle-up");e.userOptions.save("crm.activity.planner","edit","additional_mode",e.hasClass(i,"crm-activity-person-detail-open")?"open":"",false);return false};a.prototype.onDaySwitchClick=function(t){var i=new Date;var n=parseInt(t.getAttribute("data-day"));if(n>0)i.setTime(i.getTime()+n*864e5);var a=this.getNode("calendar-start-time");a.value=e.formatDate(i,e.message("FORMAT_DATE"));e.fireEvent(a,"change")};a.prototype.selectDayFromDate=function(t){var i=new Date(t.getTime());i.setHours(0,0,0,0);var n=new Date;n.setHours(0,0,0,0);var a=(i.getTime()-n.getTime())/864e5;var o=e.findChildren(this.getNode("day-switcher"),{attr:"data-day"});for(var r=0,s=o.length;r<s;++r){var l=parseInt(o[r].getAttribute("data-day"));if(l==a)e.addClass(o[r],"select-date-active");else e.removeClass(o[r],"select-date-active")}};a.prototype.onTimeSwitchClick=function(t){var i=this;if(!i.clockInstance){i.clockInstance=new e.CClockSelector({start_time:a.util.unFormatTime(t.value),node:t,callback:e.doNothing})}i.clockInstance.setNode(t);i.clockInstance.setTime(a.util.unFormatTime(t.value));i.clockInstance.setCallback(function(n){t.value=n;e.fireEvent(t,"change");i.clockInstance.closeWnd()});i.clockInstance.Show()};a.prototype.setNotify=function(e,t){e=parseInt(e);t=parseInt(t);var i=this.getNode("notify-switcher");var n=this.getNode("field-notify-value");var a=this.getNode("field-notify-type");if(e>0)i.innerHTML=this.getFormattedPeriodLabel(e,t);n.value=e;a.value=t};a.prototype.getFormattedPeriodLabel=function(e,t){var i=e+" ";var n=0;if(e>20)e=e%10;if(e==1)n=0;else if(e>1&&e<5)n=1;else n=2;var o=a.util.getPeriodLabels(t);return i+(o?o[n]:"")};a.prototype.showEdit=function(t){var i=this;if(top.BX.SidePanel){this._createEditSlider(t,i.prepareEditLayout.bind(this))}else{t["ajax_action"]="activity_edit";this._createAjaxPopup(t,i.prepareEditLayout.bind(this));e.addCustomEvent("OnCalendarPlannerSelectorChanged",function(e){i.skipPlannerRefresh=true;i.setStartTime(e.dateFrom);e.dateTo?i.setEndTime(e.dateTo):i.recalculateEndTime(true);i.refreshDateTimeView();i.skipPlannerRefresh=false});e.addCustomEvent("OnCalendarPlannerScaleChanged",function(e){i.updatePlanner({users:e.entrieIds,entries:e.entries,from:e.from,to:e.to,focusSelector:e.focusSelector===true})})}return false};a.prototype.prepareEditLayout=function(t){var i=this,n=i.getPopup();if(!t){if(n){n.show()}return}var o=this.getNodeValue("field-provider-id");i.synchronizeViewModeState();e.bind(i.getNode("view-mode-switcher"),"click",function(){i.onViewModeClick(this)});e.bind(i.getNode("additional-mode-switcher"),"click",function(){i.onAdditionalModeClick(this)});e.bind(i.getNode("priority-switcher"),"click",function(){e.toggleClass(i.getNode("priority-flame"),"crm-activity-popup-container-open");return false});var l,d,c=i.getNode("day-switcher");for(l=0,d=c.childNodes.length;l<d;++l){e.bind(c.childNodes[l],"click",function(){i.onDaySwitchClick(this)})}e.bind(i.getNode("notify-activator"),"change",function(){i.onNotifyActivatorChange(this)});e.bind(i.getNode("notify-switcher"),"click",function(){i.onNotifyChangeClick(this)});i.setNotify(i.getNode("field-notify-value").value,i.getNode("field-notify-type").value);var u=function(){e.calendar({node:this,field:this,bTime:false});return false};e.bind(i.getNode("calendar-start-time"),"click",u);e.bind(i.getNode("calendar-end-time"),"click",u);e.bind(i.getNode("clock-start-time"),"click",function(){i.onTimeSwitchClick(this)});e.bind(i.getNode("clock-end-time"),"click",function(){i.onTimeSwitchClick(this)});e.bind(i.getNode("calendar-start-time"),"change",function(){i.updateStartTime()});e.bind(i.getNode("clock-start-time"),"change",function(){i.updateStartTime()});e.bind(i.getNode("calendar-end-time"),"change",function(){i.updateEndTime()});e.bind(i.getNode("clock-end-time"),"change",function(){i.updateEndTime()});e.bind(i.getNode("duration-value"),"change",function(){i.recalculateEndTime()});e.bind(i.getNode("duration-type"),"change",function(){i.recalculateEndTime()});var p=i.getNode("storage-switcher");if(p){var h=parseInt(p.getAttribute("data-storage-type"));var m=JSON.parse(p.getAttribute("data-values"));if(h===a.util.storageType.Disk){i.createDiskUploader(m,i.getNode("storage-container"))}else{e.hide(p);e.hide(i.getNode("storage-container"))}}var g=JSON.parse(i.getNode("destination-entities").value);var f=i.getNode("template-destination-container");var v=i.getNode("template-destination-item");var y=i.getNode("deal-container");if(y){i.dealDestination=new r(y,"deal",{containerTpl:f,itemTpl:v,valueInputName:"dealId",selected:g.deal,selectOne:true})}var T=i.getNode("order-container");if(T){i.orderDestination=new r(T,"order",{containerTpl:f,itemTpl:v,valueInputName:"orderId",selected:g.order,selectOne:true})}var C=i.getNode("responsible-container");if(C){i.responsibleDestination=new r(i.getNode("responsible-container"),"responsible",{containerTpl:f,itemTpl:v,valueInputName:"responsibleId",selected:g.responsible,selectOne:true,required:true,events:{select:function(e){i.checkPlannerState(e)}}})}var _=i.getNode("communications-container");if(_){i.communications=new s(_,{entityType:i.getNodeValue("field-owner-type"),entityId:i.getNodeValue("field-owner-id"),containerTpl:f,itemTpl:v,selected:JSON.parse(i.getNode("communications-data").value),selectOne:true,communicationType:i.getNode("communications-container").getAttribute("data-communication-type")})}if(n){n.show()}var I=i.getNode("focus-on-show");if(I)e.defer(e.focus)(I);i.refreshDateTimeView()};a.prototype.onPopupClose=function(){if(this.communications){this.communications.onPlannerClose()}if(this.dealDestination){this.dealDestination.onPlannerClose()}if(this.orderDestination){this.orderDestination.onPlannerClose()}if(this.responsibleDestination){this.responsibleDestination.onPlannerClose()}};a.prototype.saveActivity=function(){var t,i=this;var n=i.getStartTime();var o=i.getEndTime();var r=this.getNodeValue("field-provider-type-id");if(n&&o&&n.getTime()>o.getTime()){this.showError(e.message("CRM_ACTIVITY_PLANNER_DATES_ERR"));return}if(this.saveInProgress)return;this.saveInProgress=true;var s=e.ajax.prepareForm(this.getNode("form")).data;var l=i.getNode("storage-switcher");if(l){var d=parseInt(l.getAttribute("data-storage-type"));if(d===a.util.storageType.Disk&&this.diskUploader){s["storageTypeID"]=a.util.storageType.Disk;s["diskfiles"]=this.diskUploader.getFileIds()}else{s["disableStorageEdit"]="Y"}}s["communications"]=i.communications?i.communications.items:[];var c=s["dealId"]||s["ownerId"]&&s["ownerType"];if(!c){for(t=0;t<s["communications"].length;++t){if(s["communications"][t]["entityId"]>0){c=true;break}}}if(!c&&r!=="CALL_LIST"){this.showError(e.message("CRM_ACTIVITY_PLANNER_NO_OWNER"));i.saveInProgress=false;return}e.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:{ajax_action:"ACTIVITY_SAVE",data:s,sessid:e.bitrix_sessid()},onsuccess:function(t){i.saveInProgress=false;if(t.SUCCESS){if(i.getPopup()){i.getPopup().close()}e.onCustomEvent(i,"onAfterActivitySave",[t.DATA.ACTIVITY]);a.Manager.fireEvent("onAfterActivitySave",{},i)}else{i.showError(t.ERRORS[0])}}})};a.prototype.getDurationValue=function(){var e=parseInt(this.getNode("duration-value").value);var t=parseInt(this.getNode("duration-type").value);if(isNaN(e))e=0;if(isNaN(t))t=1;if(t===2)e*=60;if(t===3)e*=60*24;return e*60*1e3};a.prototype.setStartTime=function(t,i){t.setSeconds(0);var n=this.getNode("field-start-time");n.value=a.util.convertDateTime(t);e.fireEvent(n,"change");if(!i){this.recalculateEndTime()}};a.prototype.getStartTime=function(){return e.parseDate(this.getNode("field-start-time").value)};a.prototype.updateStartTime=function(){var t=e.parseDate(this.getNode("calendar-start-time").value);t.setTime(t.getTime()+a.util.unFormatTime(this.getNode("clock-start-time").value)*1e3);this.setStartTime(t);this.selectDayFromDate(t)};a.prototype.setEndTime=function(t,i){t.setSeconds(0);var n=this.getNode("field-end-time");n.value=a.util.convertDateTime(t);e.fireEvent(n,"change");if(!i){this.recalculateDuration()}};a.prototype.getEndTime=function(){return e.parseDate(this.getNode("field-end-time").value)};a.prototype.updateEndTime=function(){var t=e.parseDate(this.getNode("calendar-end-time").value);t.setTime(t.getTime()+a.util.unFormatTime(this.getNode("clock-end-time").value)*1e3);this.setEndTime(t)};a.prototype.recalculateEndTime=function(e){var t=this.getStartTime();t.setTime(t.getTime()+this.getDurationValue());this.setEndTime(t,true);if(!e){this.refreshEndTimeView();this.refreshPlannerState({refreshIfShown:true})}return t};a.prototype.recalculateDuration=function(){var e=this.getEndTime();var t=this.getStartTime();var i=Math.floor((e.getTime()-t.getTime())/6e4);var n=1;if(i%1440==0){i=i/1440;n=3}else if(i%60===0){i=i/60;n=2}this.getNode("duration-value").value=i>0?i:"";this.getNode("duration-type").value=n};a.prototype.refreshStartTimeView=function(){var t=this.getStartTime();if(!t){t=new Date;var i=t.getMinutes(),n=i%5;if(n>0){t.setMinutes(i-n+(n>2?5:0))}this.setStartTime(t)}var o=this.getNode("calendar-start-time");o.value=e.formatDate(t,e.message("FORMAT_DATE"));var r=this.getNode("clock-start-time");r.value=a.util.formatTime(t);this.selectDayFromDate(t)};a.prototype.refreshEndTimeView=function(){var t=this.getEndTime();if(!t){t=this.recalculateEndTime(true)}var i=this.getNode("calendar-end-time");i.value=e.formatDate(t,e.message("FORMAT_DATE"));var n=this.getNode("clock-end-time");n.value=a.util.formatTime(t)};a.prototype.refreshDateTimeView=function(){this.refreshStartTimeView();this.refreshEndTimeView();this.recalculateDuration()};a.prototype.getPlannerContainer=function(t){return e("calendar-planner-outer"+this.getPlannerId(),true)};a.prototype.checkPlannerState=function(t){var i=this,n=864e5,a={users:[]},o=this.getStartTime(),r=this.getEndTime();if(this.checkPlannerTimeout){this.checkPlannerTimeout=!!clearTimeout(this.checkPlannerTimeout)}if(!o&&!r){this.checkPlannerTimeout=setTimeout(function(){i.checkPlannerState(t)},100);return}if(t.item&&t.item.entityId>0&&t.item.entityType=="users")a.users.push(t.item.entityId);if(o&&r&&a.users.length>0){a.from=e.formatDate(new Date(o.getTime()-n*this.loadOffsetLeft),e.message("FORMAT_DATE"));a.to=e.formatDate(new Date(o.getTime()+n*this.loadOffsetRight),e.message("FORMAT_DATE"));this.updatePlanner(a)}};a.prototype.updatePlanner=function(t){var i=this;i.ajaxProgress=true;e.ajax({method:"POST",dataType:"json",url:i.ajaxUrl,data:{sessid:e.bitrix_sessid(),ajax_action:"PLANNER_UPDATE",from:t.from,to:t.to,entries:t.users},onsuccess:function(n){var a=n.DATA||{};var o=true,r=e.hasClass(i.getPlannerContainer(),"crm-activity-popup-calendar-planner-wrap-shown");if(o){var s={show:o&&!r};if(t.entries){a.entries=t.entries;s.scaleFrom=t.from;s.scaleTo=t.to}s.loadedDataFrom=t.from;s.loadedDataTo=t.to;s.data=a;s.focusSelector=s.show?true:t.focusSelector==undefined?false:t.focusSelector;i.refreshPlannerState(s)}i.ajaxProgress=false}})};a.prototype.refreshPlannerState=function(t){var i=this;if(!window.CalendarPlanner){if(this.refreshPlannerStateTimeout)this.refreshPlannerStateTimeout=!!clearTimeout(this.refreshPlannerStateTimeout);this.refreshPlannerStateTimeout=setTimeout(function(){i.refreshPlannerState(t)},200)}if(!t||typeof t!=="object")t={};var n="calendar_planner_"+this.getPlannerId(),a,o,r={scaleType:"1hour",showTimelineDayTitle:true,compactMode:true,width:i.getPlannerContainer().clientWidth-20,minWidth:600,minHeight:104,height:104},s=e.hasClass(i.getPlannerContainer(),"crm-activity-popup-calendar-planner-wrap-shown");if(!s&&t.refreshIfShown||this.skipPlannerRefresh===true){return}if(!s&&t.show){e.addClass(i.getPlannerContainer(),"crm-activity-popup-calendar-planner-wrap-shown")}if(t.focusSelector==undefined)t.focusSelector=true;a=this.getStartTime();o=this.getEndTime();if(o.getTime()-a.getTime()>this.PLANNER_DURATION_LIMIT){this.showPlannerWarning()}if(a&&o&&a.getTime&&o.getTime&&a.getTime()<=o.getTime()&&o.getTime()-a.getTime()<=this.PLANNER_DURATION_LIMIT){if(!s&&!t.data){this.checkPlannerState()}else{e.onCustomEvent("OnCalendarPlannerDoUpdate",[{plannerId:n,config:r,focusSelector:t.focusSelector,selector:{from:a,to:o,fullDay:false,animation:true,updateScaleLimits:true},data:t.data||false,loadedDataFrom:t.loadedDataFrom,loadedDataTo:t.loadedDataTo,show:!!t.show}])}}};a.prototype.showPlannerWarning=function(t){this.warningNode=this.getPlannerContainer().appendChild(e.create("DIV",{props:{className:"crm-activity-planner-warning-wrap"},html:'<div class="ui-alert ui-alert-xs ui-alert-warning"><span class="ui-alert-message">'+e.message("CRM_ACTIVITY_PLANNER_DURATION_ERR")+"</span></div>"}));setTimeout(e.proxy(function(){if(this.warningNode){e.addClass(this.warningNode,"show")}},this),100);setTimeout(e.proxy(function(){if(this.warningNode){e.removeClass(this.warningNode,"show")}},this),4e3)};a.prototype.createDiskUploader=function(t,i){var n=this;if(!e.CrmDiskUploader){if(this.diskUploaderTimeout)this.diskUploaderTimeout=!!clearTimeout(this.diskUploaderTimeout);this.diskUploaderTimeout=setTimeout(function(){n.createDiskUploader(t,i)},100);return}n.diskUploader=e.CrmDiskUploader.create("",{msg:{diskAttachFiles:e.message("CRM_ACTIVITY_PLANNER_DISK_ATTACH_FILE"),diskAttachedFiles:e.message("CRM_ACTIVITY_PLANNER_DISK_ATTACHED_FILES"),diskSelectFile:e.message("CRM_ACTIVITY_PLANNER_DISK_SELECT_FILE"),diskSelectFileLegend:e.message("CRM_ACTIVITY_PLANNER_DISK_SELECT_FILE_LEGEND"),diskUploadFile:e.message("CRM_ACTIVITY_PLANNER_DISK_UPLOAD_FILE"),diskUploadFileLegend:e.message("CRM_ACTIVITY_PLANNER_DISK_UPLOAD_FILE_LEGEND")}});n.diskUploader.setMode(1);n.diskUploader.setValues(t);n.diskUploader.layout(i)};var o={menuId:"crm-act-pltlb",actions:[],actionNode:null,openerNode:null,setActions:function(e){if(e&&e instanceof Array){this.actions=e}},bindActionNode:function(t){this.actionNode=t;e.bind(t,"click",e.delegate(this.onDefaultActionClick,this))},bindOpenerNode:function(t){this.openerNode=t;e.bind(t,"click",e.delegate(this.onOpenerClick,this))},bindNodes:function(e){if(!e)e={};if(e.action)this.bindActionNode(e.action);if(e.opener)this.bindOpenerNode(e.opener)},onDefaultActionClick:function(t){this.executeActionById(this.getDefaultActionId());return e.PreventDefault(t)},onOpenerClick:function(t){var i=this,n,a=[];for(n=0;n<this.actions.length;++n){a.push({text:this.actions[n].text,actionId:this.actions[n].id,onclick:function(t,n){i.executeActionById(n.actionId);if(i.actionNode&&e.type.isString(n.text))i.actionNode.innerHTML=e.util.htmlspecialchars(n.text);return e.PreventDefault(t)}})}e.PopupMenu.show(this.menuId,this.openerNode,a,{autoHide:true,offsetLeft:e.pos(this.openerNode)["width"]/2,angle:{position:"top",offset:0}});return e.PreventDefault(t)},executeActionById:function(t){var i,n;t=t.toString();for(i=0;i<this.actions.length;++i){if(this.actions[i].id===t){n=this.actions[i];break}}if(n){(new e.Crm.Activity.Planner).showEdit(n.params);e.PopupMenu.destroy(this.menuId);this.setDefaultActionId(t)}},getDefaultActionId:function(){var e="";if(this.actionNode){e=this.actionNode.getAttribute("data-action-id").toString()}return e},setDefaultActionId:function(t){t=t.toString();var i=false;if(this.actionNode){var n=this.actionNode.getAttribute("data-action-id");this.actionNode.setAttribute("data-action-id",t);if(n!==t)i=true}if(i){e.userOptions.save("crm.interface.toolbar","activity_planner","default_action_id",t,false)}return this}};e.Crm.Activity.Planner=a;e.Crm.Activity.PlannerToolbar=o;var r=function(t,n,a){var o=this,r;if(!a)a={};this.bindContainer=t;this.ajaxUrl=a.ajaxUrl||i;this.itemTpl=a.itemTpl;this.data=null;this.type=n;this.dialogId="crm-aw-dest-"+n+(""+(new Date).getTime()).substr(6);this.valueInputName=a.valueInputName||"";this.selected=a.selected?e.clone(a.selected):[];this.crmTypes=a.crmTypes;this.selectOne=a.selectOne||false;this.required=a.required||false;this.events=a.events||{};this.bindContainer.appendChild(e.clone(a.containerTpl));r=this.getNode("destination-tag");e.bind(r,"focus",function(t){o.openDialog({bByFocusEvent:true});return e.PreventDefault(t)});e.bind(this.bindContainer,"click",function(t){o.openDialog();return e.PreventDefault(t)});this.addItems(this.selected);r.innerHTML=this.selected.length<=0?e.message("CRM_ACTIVITY_PLANNER_DEST_1"):e.message("CRM_ACTIVITY_PLANNER_DEST_2")};r.prototype.getNode=function(e,t){if(!t)t=this.bindContainer;return t?t.querySelector('[data-role="'+e+'"]'):null};r.prototype.getData=function(t){var i=this;if(i.ajaxProgress)return;i.ajaxProgress=true;e.ajax({method:"POST",dataType:"json",url:i.ajaxUrl,data:{sessid:e.bitrix_sessid(),ajax_action:"get_destination_data",type:i.type},onsuccess:function(e){i.data=e.DATA||{};i.ajaxProgress=false;i.initDialog(t)}})};r.prototype.initDialog=function(t){var n=this,a=this.data;if(!a){n.getData(t);return}var o={};for(var r=0;r<n.selected.length;++r){o[n.selected[r].id]=n.selected[r].entityType}var s={},l={},d=a.DEST_SORT||{};if(this.type==="responsible"){s={users:a.USERS||{},department:a.DEPARTMENT||{},departmentRelation:a.DEPARTMENT_RELATION||{}};l={users:a.LAST.USERS||{}};if(!s["departmentRelation"]){s["departmentRelation"]=e.SocNetLogDestination.buildDepartmentRelation(s["department"])}}var c=false;var u=null;if(this.type==="deal"){c=true;s={deals:a.DEALS||{}};l={deals:a.LAST.DEALS||{},crm:[]};u=i+"&ajax_action=SEARCH_DESTINATION_DEALS"}if(this.type==="order"){c=true;s={orders:a.ORDERS||{}};l={orders:a.LAST.ORDERS||{},crm:[]};u=i+"&ajax_action=SEARCH_DESTINATION_ORDERS"}if(!n.inited){n.inited=true;var p=n.getNode("destination-input");p.id=n.dialogId+"input";var h=n.getNode("destination-input-box");h.id=n.dialogId+"input-box";var m=this.getNode("destination-tag");m.id=this.dialogId+"tag";var g=n.getNode("destination-items");e.SocNetLogDestination.init({pathToAjax:u,name:n.dialogId,searchInput:n.getNode("destination-input"),extranetUser:false,bindMainPopup:{node:n.bindContainer,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:n.bindContainer,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:true,sendAjaxSearch:true,callback:{select:function(t,i,a,o){n.addItem(t,i);if(n.selectOne)e.SocNetLogDestination.closeDialog()},unSelect:e.delegate(e.SocNetLogDestination.BXfpUnSelectCallback,{formName:n.dialogId,inputContainerName:g,inputName:p.id,tagInputName:m.id,tagLink1:e.message("CRM_ACTIVITY_PLANNER_DEST_1"),tagLink2:e.message("CRM_ACTIVITY_PLANNER_DEST_2")}),openDialog:e.delegate(e.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:h.id,inputName:p.id,tagInputName:m.id}),closeDialog:e.delegate(e.SocNetLogDestination.BXfpCloseDialogCallback,{inputBoxName:h.id,inputName:p.id,tagInputName:m.id}),openSearch:e.delegate(e.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:h.id,inputName:p.id,tagInputName:m.id}),closeSearch:e.delegate(e.SocNetLogDestination.BXfpCloseSearchCallback,{inputBoxName:h.id,inputName:p.id,tagInputName:m.id})},items:s,itemsLast:l,itemsSelected:o,isCrmFeed:c,useClientDatabase:false,destSort:d,allowAddUser:false});e.bind(p,"keyup",e.delegate(e.SocNetLogDestination.BXfpSearch,{formName:n.dialogId,inputName:p.id,tagInputName:m.id}));e.bind(p,"keydown",e.delegate(e.SocNetLogDestination.BXfpSearchBefore,{formName:n.dialogId,inputName:p.id}));e.SocNetLogDestination.BXfpSetLinkName({formName:n.dialogId,tagInputName:m.id,tagLink1:e.message("CRM_ACTIVITY_PLANNER_DEST_1"),tagLink2:e.message("CRM_ACTIVITY_PLANNER_DEST_2")})}t()};r.prototype.addItem=function(t,i){var n=this;var a=this.getNode("destination-input");var o=this.getNode("destination-tag");var r=this.getNode("destination-items");var s=e.clone(this.itemTpl);if(!e.findChild(r,{attr:{"data-id":t.id}},false,false)){if(n.selectOne&&n.inited){var l=[];for(var d=0;d<r.childNodes.length;++d){l.push({itemId:r.childNodes[d].getAttribute("data-id"),itemType:r.childNodes[d].getAttribute("data-type")})}n.initDialog(function(){for(var t=0;t<l.length;++t){e.SocNetLogDestination.deleteItem(l[t].itemId,l[t].itemType,n.dialogId)}});e.cleanNode(r)}s.setAttribute("data-id",t.id);s.setAttribute("data-type",i);e.addClass(s,s.getAttribute("data-class-prefix")+(n.type=="responsible"?"users":"crm"));var c=this.getNode("text",s);var u=this.getNode("delete",s);var p=this.getNode("value",s);c.innerHTML=e.type.isString(t.name)?e.util.htmlspecialchars(t.name):"";e.bind(u,"click",function(a){if(n.selectOne&&n.required){n.openDialog()}else{n.initDialog(function(){e.SocNetLogDestination.deleteItem(t.id,i,n.dialogId);e.remove(s)})}e.PreventDefault(a)});e.bind(u,"mouseover",function(){e.addClass(this.parentNode,this.getAttribute("data-hover-class"))});e.bind(u,"mouseout",function(){e.removeClass(this.parentNode,this.getAttribute("data-hover-class"))});p.name=n.valueInputName;p.value=t.entityId;r.appendChild(s);if(!t.entityType)t.entityType=i;this.fireEvent("select",{item:t})}a.value="";o.innerHTML=e.message("CRM_ACTIVITY_PLANNER_DEST_2")};r.prototype.addItems=function(e){for(var t=0;t<e.length;++t){this.addItem(e[t],e[t].entityType)}};r.prototype.openDialog=function(t){var i=this;this.initDialog(function(){e.SocNetLogDestination.openDialog(i.dialogId,t)})};r.prototype.fireEvent=function(e,t){if(typeof this.events[e]==="function"){this.events[e].call(this,t)}};r.prototype.onPlannerClose=function(){if(this.inited){if(e.SocNetLogDestination.isOpenDialog()){e.SocNetLogDestination.closeDialog()}e.SocNetLogDestination.closeSearch()}};var s=function(t,i){this.id="crm-actpl-comm-"+(""+(new Date).getTime()).substr(6);this.items=[];var a=this;if(!i)i={};this.bindContainer=t;this.ajaxUrl=i.ajaxUrl||n;this.itemTpl=i.itemTpl;this.selectOne=i.selectOne||false;this.bindContainer.appendChild(e.clone(i.containerTpl));var o=this.getNode("destination-tag");e.bind(o,"focus",function(t){a.openDialog();return e.PreventDefault(t)});e.bind(this.bindContainer,"click",function(t){a.openDialog();return e.PreventDefault(t)});var r=e.CrmCommunicationType.undefined;if(i.communicationType==="PHONE")r=e.CrmCommunicationType.phone;if(i.communicationType==="EMAIL")r=e.CrmCommunicationType.email;if(typeof e.CrmCommunicationSearch.messages==="undefined"){e.CrmCommunicationSearch.messages={SearchTab:e.message("CRM_ACTIVITY_PLANNER_COMMUNICATION_SEARCH_TAB"),NoData:e.message("CRM_ACTIVITY_PLANNER_COMMUNICATION_SEARCH_NO_DATA")}}this._communicationSearch=e.CrmCommunicationSearch.create(this.id,{entityType:i.entityType,entityId:i.entityId,serviceUrl:a.ajaxUrl,communicationType:r,selectCallback:e.delegate(this.selectCommunication,this),enableSearch:true,enableDataLoading:true,dialogAutoHide:true});if(r===e.CrmCommunicationType.phone){var s=this.getNode("destination-input");e.bind(s,"keypress",e.delegate(this.inputKeypress,this))}this.addItems(i.selected?e.clone(i.selected):[])};s.prototype.inputKeypress=function(t){if(!t)t=window.event;if(t.keyCode!==13)return;var i=this.getNode("destination-input");if(e.type.isNotEmptyString(i.value)){var n=/^\s*\+?[\d-\s\(\)]+\s*$/;if(n.test(i.value)){this.addItem({entityId:"0",entityTitle:"",entityType:"CONTACT",type:"PHONE",value:i.value},true)}}};s.prototype.getNode=function(e,t){if(!t)t=this.bindContainer;return t?t.querySelector('[data-role="'+e+'"]'):null};s.prototype.selectCommunication=function(e){this.addItem(e.getSettings(),true)};s.prototype.addItem=function(t,i){if(t.type===null)t.type="";if(t.type===""&&t.value===null)t.value="";t.entityId=parseInt(t.entityId);for(var n=0;n<this.items.length;++n){if(this.items[n].type===t.type&&this.items[n].value===t.value&&this.items[n].entityId===t.entityId&&this.items[n].entityType===t.entityType)return}var a=this,o=this.getNode("destination-items");if(this.selectOne){this.items=[];e.cleanNode(o)}this.items.push(t);var r=e.clone(this.itemTpl);e.addClass(r,r.getAttribute("data-class-prefix")+"crm");var s=this.getNode("text",r);var l=this.getNode("delete",r);s.innerHTML=[e.type.isString(t.entityTitle)?e.util.htmlspecialchars(t.entityTitle):"",e.type.isString(t.value)?e.util.htmlspecialchars(t.value):""].join(" ");e.bind(l,"click",function(i){a.deleteItem(t);e.remove(r);e.PreventDefault(i)});e.bind(l,"mouseover",function(){e.addClass(this.parentNode,this.getAttribute("data-hover-class"))});e.bind(l,"mouseout",function(){e.removeClass(this.parentNode,this.getAttribute("data-hover-class"))});o.appendChild(r);var d=this.getNode("destination-tag");d.innerHTML=e.message("CRM_ACTIVITY_PLANNER_DEST_2");if(i)this._communicationSearch.closeDialog()};s.prototype.addItems=function(t){for(var i=0;i<t.length;++i){this.addItem(t[i],t[i].entityType)}var n=this.getNode("destination-tag");n.innerHTML=t.length<=0?e.message("CRM_ACTIVITY_PLANNER_DEST_1"):e.message("CRM_ACTIVITY_PLANNER_DEST_2")};s.prototype.deleteItem=function(e){for(var t=0;t<this.items.length;++t){if(this.items[t]===e)this.items.splice(t,1)}return this};s.prototype.openDialog=function(){var t=this.getNode("destination-input-box");var i=this.getNode("destination-input");var n=this.getNode("destination-tag");e.style(t,"display","inline-block");e.style(n,"display","none");if(!this._communicationSearchController){this._communicationSearchController=e.CrmCommunicationSearchController.create(this._communicationSearch,i);this._communicationSearchController.start()}this._communicationSearch.openDialog(this.bindContainer,e.delegate(this.closeDialog,this),{zIndex:999});e.defer(e.focus)(i)};s.prototype.closeDialog=function(){var t=this.getNode("destination-input-box");var i=this.getNode("destination-input");var n=this.getNode("destination-tag");if(this._communicationSearchController){this._communicationSearchController.stop();this._communicationSearchController=null}e.style(n,"display","inline-block");e.style(t,"display","none");i.value=""};s.prototype.onPlannerClose=function(){this._communicationSearch.closeDialog()};if(typeof e.CrmActivityProvider=="undefined"){e.addCustomEvent("Bitrix24.Slider:onMessage",function(t,i){if(!e.CrmActivityEditor)return;var n=null;if(i.action&&(n=i.action.match(/^ACTIVITY_(CREATE|DELETE)$/)))e.CrmActivityEditor.notifyActivityChange(null,n[1],{})});e.CrmActivityProvider=function(){this._settings={};this._options={};this._ttlWrapper=null;this._dlg=null;this._dlgMode=e.CrmDialogMode.view;this._dlgCfg={};this._onSaveHandlers=[];this._onDlgCloseHandlers=[];this._editor=null;this._isChanged=false;this._buttonId=e.CrmActivityDialogButton.undefined;this._owner=null;this._salt="";this._callCreationHandler=e.delegate(this._handleCallCreation,this);this._meetingCreationHandler=e.delegate(this._handleMeetingCreation,this);this._emailCreationHandler=e.delegate(this._handleEmailCreation,this);this._taskCreationHandler=e.delegate(this._handleTaskCreation,this);this._titleMenu=null;this._contentNode=null;this._activityOptions={};this._parentActivity=null};e.CrmActivityProvider.prototype={initialize:function(e,t,i,n){this._settings=e?e:{};this._editor=t;this._options=i?i:{};this._isChanged=this.getOption("markChanged",false);var a=this.getSetting("ownerType","");var o=this.getSetting("ownerID","");this._salt=Math.random().toString().substring(2);this._parentActivity=n},getMode:function(){return this._dlgMode},getSetting:function(e,t){return typeof this._settings[e]!="undefined"?this._settings[e]:t},setSetting:function(e,t){this._settings[e]=t},getOption:function(e,t){return typeof this._options[e]!="undefined"?this._options[e]:t},getMessage:function(t){return e.CrmActivityProvider.messages&&e.CrmActivityProvider.messages[t]?e.CrmActivityProvider.messages[t]:""},getType:function(){return this.getSetting("typeID",e.CrmActivityType.provider)},getId:function(){return parseInt(this.getSetting("ID","0"))},getMessageType:function(){return this.getSetting("messageType","")},getOwnerType:function(){return this.getSetting("ownerType","")},getOwnerId:function(){return this.getSetting("ownerID","")},getOriginalMessageId:function(){return this.getSetting("originalMessageID",0)},openDialog:function(t){var i=this;var n=i.getId();var o="CrmActivityProviderView"+n;i._dlgMode=t;var r={sessid:e.bitrix_sessid()};if(t==e.CrmDialogMode.edit){if(top.BX.SidePanel&&i.getType()==e.CrmActivityType.email){try{r.context=e.Crm.Page.context}catch(e){}r.ajax_action="ACTIVITY_EDIT";r.activity_id=n;r.TYPE_ID=i.getType();r.OWNER_ID=i.getOwnerId();r.OWNER_TYPE=i.getOwnerType();r.OWNER_PSID=this.getSetting("ownerPSID",0);r.FROM_ACTIVITY_ID=i.getOriginalMessageId();r.MESSAGE_TYPE=i.getMessageType();var s={COMMUNICATIONS:{}};var l=this.getSetting("communications",[]);for(var d=0;d<l.length;d++){if(l[d].entityType&&l[d].entityId){s.COMMUNICATIONS[d]={OWNER_TYPE:l[d].entityType,OWNER_ID:l[d].entityId};if(l[d].type&&l[d].value){s.COMMUNICATIONS[d].TYPE=l[d].type;s.COMMUNICATIONS[d].VALUE=l[d].value}}}r.__post_data_hash=e.util.hashCode(e.ajax.prepareData(s));var c={allowChangeHistory:false,requestMethod:"post",requestParams:s};if(i.getType()==e.CrmActivityType.email){c.typeLoader="create-mail-loader";c.width=1080}var u=this.getSetting("defaultStorageTypeId");if(u===a.util.storageType.Disk){var p=this.getSetting("diskfiles");if(e.type.isArray(p)){r["STORAGE_TYPE_ID"]=u;r["STORAGE_ELEMENT_IDS"]=p}}top.BX.SidePanel.Instance.open("/bitrix/components/bitrix/crm.activity.planner/slider.php?site_id="+e.message("SITE_ID")+"&"+e.ajax.prepareData(r),c);return}else{(new e.Crm.Activity.Planner).showEdit({ID:n})}return true}r.ajax_action="ACTIVITY_VIEW";r.activity_id=n;if(top.BX.SidePanel){var c={compatibleEvents:true,allowChangeHistory:false,events:{onOpen:function(e){var t=e.iframe.contentDocument.body;i._contentNode=t;var n=i._getNode("options");if(n){i._activityOptions=JSON.parse(n.getAttribute("data-options"));if(!i._activityOptions||typeof i._activityOptions!=="object")i._activityOptions={}}i._prepareSliderContent(e)}}};if(i.getType()==e.CrmActivityType.email){c.typeLoader="view-mail-loader";c.width=1080}top.BX.SidePanel.Instance.open("/bitrix/components/bitrix/crm.activity.planner/slider.php?site_id="+e.message("SITE_ID")+"&"+e.ajax.prepareData(r),c);return}if(e.CrmActivityProvider.dialogs[o])return;e.ajax({method:"POST",dataType:"html",url:"/bitrix/components/bitrix/crm.activity.planner/ajax.php?site_id="+e.message("SITE_ID"),data:r,onsuccess:function(t){if(e.CrmActivityProvider.dialogs[o])return;var n=e.create("div");n.innerHTML=t;i._contentNode=n;var a=i._getNode("options");if(a){i._activityOptions=JSON.parse(a.getAttribute("data-options"));if(!i._activityOptions||typeof i._activityOptions!=="object")i._activityOptions={}}i._dlg=new e.PopupWindow(o,null,{autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:true,zIndex:-12,contentNoPaddings:true,titleBar:{content:i._prepareViewDlgTitle()},events:{onPopupClose:e.delegate(function(){e.CrmActivityEditor.hideUploader(i.getSetting("uploadID",""),i.getSetting("uploadControlID",""));e.CrmActivityEditor.hideLhe(i.getSetting("lheContainerID",""));i._dlg.destroy();e.onCustomEvent(window,"onActivityEditorClose",[])},i),onPopupDestroy:e.proxy(function(){i._dlg=null;i._wrapper=null;i._ttlWrapper=null;delete e.CrmActivityProvider.dialogs[o]},i)},content:n,buttons:i._prepareViewDlgButtons()});i._prepareDialogContent();e.CrmActivityProvider.dialogs[o]=i._dlg;i._dlg.show()}})},_getNode:function(e){return this._contentNode?this._contentNode.querySelector('[data-role="'+e+'"]'):null},_prepareFieldCompleted:function(){var t=this;var i=this._getNode("field-completed");if(i){var n=this.getOption("enableInstantEdit",true);if(n){e.bind(i,"click",function(){i.disabled=true;t._editor.setActivityCompleted(t.getId(),i.checked,function(e){t._settings["completed"]=!!e["COMPLETED"];i.checked=!!e["COMPLETED"];i.disabled=false})})}else{i.disabled=true}}},_prepareCommunicationsSlider:function(){var t=this,i=this._getNode("com-slider-left");if(i){e.bind(i,"click",function(){t._changeCommunicationSlide(-1)})}var n=this._getNode("com-slider-right");if(n){e.bind(n,"click",function(){t._changeCommunicationSlide(1)})}},_prepareDialogContent:function(){var t=this._getNode("additional-switcher");var i=this._getNode("additional-fields");if(t&&i){e.bind(t,"click",function(){e.toggleClass(i,"active")})}this._prepareCommunicationsSlider();this._prepareFieldCompleted()},_prepareSliderContent:function(t){var i=this;if(i.getType()==e.CrmActivityType.email&&!i._settings["completed"]){var n=this._getNode("field-completed");var a=function(e){top.BX.removeCustomEvent(t,"SidePanel.Slider:onClose",a);top.BX.removeCustomEvent(t,"SidePanel.Slider:onDestroy",a);if(i._settings["completed"])return;n.disabled=true;i._editor.setActivityCompleted(i.getId(),true,function(e){i._settings["completed"]=!!e["COMPLETED"];n.checked=!!e["COMPLETED"];n.disabled=false})};top.BX.addCustomEvent(t,"SidePanel.Slider:onClose",a);top.BX.addCustomEvent(t,"SidePanel.Slider:onDestroy",a)}var o=this._getNode("additional-switcher");var r=this._getNode("additional-fields");if(o&&r){e.bind(o,"click",function(){if(r.offsetHeight>0&&!e.hasClass(r,"crm-activity-email-close-animation")){r.style.maxHeight=r.offsetHeight*1.5+"px";r.style.transition="max-height .12s ease-in";setTimeout(function(){r.style.display="none"},120);r.offsetHeight;r.style.maxHeight="0px";e.removeClass(r,"crm-activity-email-show-animation");e.addClass(r,"crm-activity-email-close-animation")}else{e.removeClass(r,"crm-activity-email-close-animation");e.addClass(r,"crm-activity-email-show-animation");r.style.display="";r.style.transition="";r.style.maxHeight=""}})}this._prepareCommunicationsSlider();this._prepareFieldCompleted();var s=this._getNode("field-important");if(s){var l=this.getOption("enableInstantEdit",true);if(l){var d=function(t){if(t<e.CrmActivityPriority.high){e.addClass(s,"crm-activity-planner-slider-header-icon-flame");e.removeClass(s,"crm-activity-planner-slider-header-icon-flame-active")}else{e.addClass(s,"crm-activity-planner-slider-header-icon-flame-active");e.removeClass(s,"crm-activity-planner-slider-header-icon-flame")}};e.bind(s,"click",function(){var t=e.hasClass(s,"crm-activity-planner-slider-header-icon-flame-active")?e.CrmActivityPriority.medium:e.CrmActivityPriority.high;d(t);i._editor.setActivityPriority(i.getId(),t,function(e){i._settings["priority"]=e["PRIORITY"];d(e["PRIORITY"])})})}else{s.style.cursor="default"}}var c=this._getNode("button-edit");if(c){e.bind(c,"click",function(){t.close(true,function(){(new e.Crm.Activity.Planner).showEdit({ID:i.getId()})})})}var u=this._getNode("button-close");if(u){e.bind(u,"click",function(){t.close()})}},_changeCommunicationSlide:function(e){var t=this._getNode("com-slider-nav");var i=this._getNode("com-slider-slides");if(!t||!i)return false;var n=parseInt(t.getAttribute("data-current"));var a=parseInt(t.getAttribute("data-cnt"));if(isNaN(a)||a<1)return false;if(isNaN(n)||n<1)n=1;n+=e<0?-1:1;if(n>a)n=a;if(n<1)n=1;t.setAttribute("data-current",n.toString());t.innerHTML=n.toString()+" / "+a.toString();i.style.marginLeft=((n-1)*-269).toString()+"px"},closeDialog:function(){if(this._titleMenu){this._titleMenu.removeCreateTaskListener(this._taskCreationHandler);this._titleMenu.removeCreateCallListener(this._callCreationHandler);this._titleMenu.removeCreateMeetingListener(this._meetingCreationHandler);this._titleMenu.cleanLayout()}if(!this._dlg){return}this._notifyDialogClose();this._dlg.close()},addOnSave:function(t){if(!e.type.isFunction(t)){return}for(var i=0;i<this._onSaveHandlers.length;i++){if(this._onSaveHandlers[i]==t){return}}this._onSaveHandlers.push(t)},removeOnSave:function(t){if(!e.type.isFunction(t)){return}for(var i=0;i<this._onSaveHandlers.length;i++){if(this._onSaveHandlers[i]==t){this._onSaveHandlers.splice(i,1);return}}},addOnDialogClose:function(t){if(!e.type.isFunction(t)){return}for(var i=0;i<this._onDlgCloseHandlers.length;i++){if(this._onDlgCloseHandlers[i]==t){return}}this._onDlgCloseHandlers.push(t)},removeOnDialogClose:function(t){if(!e.type.isFunction(t)){return}for(var i=0;i<this._onDlgCloseHandlers.length;i++){if(this._onDlgCloseHandlers[i]==t){this._onDlgCloseHandlers.splice(i,1);return}}},isChanged:function(){return this._isChanged},getButtonId:function(){return this._buttonId},_prepareViewDlgTitle:function(){var t=this._activityOptions.title||this.getSetting("subject","");this._titleMenu=e.CrmActivityMenu.create("",{enableTasks:this._editor.isTasksEnabled(),enableCalendarEvents:this._editor.isCalendarEventsEnabled(),enableEmails:this._editor.isEmailsEnabled()&&this.getType()!==e.CrmActivityType.email},{createTask:this._taskCreationHandler,createCall:this._callCreationHandler,createMeeting:this._meetingCreationHandler,createEmail:this._emailCreationHandler});var i=e.create("DIV",{attrs:{className:"crm-task-list-head"},children:[e.create("SPAN",{attrs:{className:"crm-task-list-head-item-left"},children:[e.create("SPAN",{text:t,props:{className:"crm-task-list-head-item-left-element"}})]})]});this._titleMenu.layout(i);if(this._activityOptions.important){i.appendChild(e.create("SPAN",{attrs:{className:"crm-task-list-head-item-right-wrap"},children:[e.create("SPAN",{attrs:{className:"crm-task-list-head-item-right"},text:e.message("CRM_ACTIVITY_PLANNER_IMPORTANT")}),e.create("SPAN",{attrs:{className:"crm-task-list-head-item-right-icon"}})]}))}return i},_notifyDialogClose:function(){for(var e=0;e<this._onDlgCloseHandlers.length;e++){try{this._onDlgCloseHandlers[e](this)}catch(e){}}},_prepareViewDlgButtons:function(){var t=[],i=this;if(this.getType()===e.CrmActivityType.email&&this._parentActivity){var n=parseInt(this.getSetting("direction",e.CrmActivityDirection.outgoing));if(n===e.CrmActivityDirection.incoming){t.push({type:"button",settings:{text:e.CrmActivityEditor.getMessage("replyDlgButton"),className:"popup-window-button-accept",events:{click:function(){i.closeDialog();i._parentActivity._handleReplyBtnClick()}}}})}t.push({type:"button",settings:{text:e.CrmActivityEditor.getMessage("forwardDlgButton"),className:"popup-window-button-accept",events:{click:function(){i.closeDialog();i._parentActivity._handleForwardBtnClick()}}}});t.push({type:"link",settings:{text:e.CrmActivityEditor.getMessage("closeDlgButton"),className:"popup-window-button-link-cancel",events:{click:e.delegate(this._handleCloseBtnClick,this)}}})}else{t.push({type:"button",settings:{text:e.CrmActivityEditor.getMessage("closeDlgButton"),className:"popup-window-button-accept",events:{click:e.delegate(this._handleCloseBtnClick,this)}}});if(this.getOption("enableEditButton",true)&&(this.getType()===e.CrmActivityType.call||this.getType()===e.CrmActivityType.meeting||this._activityOptions.isEditable===true)){t.push({type:"link",settings:{text:e.CrmActivityEditor.getMessage("editDlgButton"),className:"popup-window-button-link-cancel",events:{click:function(){(new e.Crm.Activity.Planner).showEdit({ID:i.getId()});i.closeDialog()}}}})}}return e.CrmActivityEditor.prepareDialogButtons(t)},_handleCallCreation:function(t){var i=this.getSetting("ownerType","");var n=parseInt(this.getSetting("ownerID",0));if(typeof e.Crm.Activity.Planner!=="undefined"){(new e.Crm.Activity.Planner).showEdit({TYPE_ID:e.CrmActivityType.call,OWNER_TYPE:i,OWNER_ID:n,FROM_ACTIVITY_ID:this.getId()})}},_handleMeetingCreation:function(t){var i=this.getSetting("ownerType","");var n=parseInt(this.getSetting("ownerID",0));if(typeof e.Crm.Activity.Planner!=="undefined"){(new e.Crm.Activity.Planner).showEdit({TYPE_ID:e.CrmActivityType.meeting,OWNER_TYPE:i,OWNER_ID:n,FROM_ACTIVITY_ID:this.getId()})}},_handleEmailCreation:function(t){var i={};var n=this.getSetting("ownerType","");var a=parseInt(this.getSetting("ownerID",0));if(n!==""&&a>0){i["ownerType"]=n;i["ownerID"]=a;i["ownerTitle"]=this.getSetting("ownerTitle","");i["ownerUrl"]=this.getSetting("ownerUrl","")}if(this.getSetting("ownerType","")==="DEAL"){var o=this.getSetting("communications",[]);var r=e.type.isArray(o)&&o.length>0?o[0]:null;if(r){var s=r["entityType"];if(!e.type.isNotEmptyString(s)){s=n}var l=parseInt(r["entityId"]);if(isNaN(l)||l<=0){l=a}var d=e.CrmActivityEditor.getDefaultCommunication(s,l,e.CrmCommunicationType.email,this.getSetting("serviceUrl",""));if(d){i["communications"]=[d.getSettings()]}}}this._editor.addEmail(i)},_handleTaskCreation:function(e){var t={};var i=this.getSetting("ownerType","");var n=parseInt(this.getSetting("ownerID",0));if(i!==""&&n>0){t["ownerType"]=i;t["ownerID"]=n}this._editor.addTask(t)},_handleCloseBtnClick:function(t){this._buttonId=e.CrmActivityDialogButton.cancel;this.closeDialog()}};e.CrmActivityProvider.dialogs={};e.CrmActivityProvider.sliders={};e.CrmActivityProvider.create=function(t,i,n,a){var o=new e.CrmActivityProvider;o.initialize(t,i,n,a);return o}}if(typeof e.CrmCustomActivityType=="undefined"){e.CrmCustomActivityType=function(){};e.CrmCustomActivityType.getListItems=function(t){if(!e.type.isArray(t)){t=e.CrmCustomActivityType.infos}var i=[];for(var n=0,a=t.length;n<a;n++){var o=t[n];i.push({value:o["id"],text:o["name"]})}return i};e.CrmCustomActivityType.prepareEditorParams=function(e,t){var i=this.getInfo(e);if(i!==null){t["PROVIDER_ID"]="CUST";t["PROVIDER_TYPE_ID"]=i["id"];t["NAME"]=i["name"];t["TYPE_ID"]=6}};e.CrmCustomActivityType.getInfo=function(t){for(var i=0,n=e.CrmCustomActivityType.infos.length;i<n;i++){var a=e.CrmCustomActivityType.infos[i];if(a["id"]==t){return a}}return null};if(typeof e.CrmCustomActivityType.infos==="undefined"){e.CrmCustomActivityType.infos=[]}}if(typeof e.CrmCustomActivityTypeSelector=="undefined"){e.CrmCustomActivityTypeSelector=function(){this._id="";this._settings={};this._ownerTypeId=0;this._ownerId=0;this._selectorMenu=null;this._menuItemSelectHandler=e.delegate(this.onMenuItemSelect,this)};e.CrmCustomActivityTypeSelector.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._ownerTypeId=this.getSetting("ownerTypeId",0);this._ownerId=this.getSetting("ownerId",0)},getId:function(){return this._id},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getMessage:function(t){var i=e.CrmCustomActivityTypeSelector.messages;return i.hasOwnProperty(t)?i[t]:t},openCreationDialog:function(t){var i={OWNER_TYPE_ID:this._ownerTypeId,OWNER_ID:this._ownerId};e.CrmCustomActivityType.prepareEditorParams(t,i);var n=new e.Crm.Activity.Planner;n.showEdit(i)},openMenu:function(t){if(!this._selectorMenu){var i=e.CrmCustomActivityType.getListItems();this._selectorMenu=e.CmrSelectorMenu.create(this._id,{items:i});this._selectorMenu.addOnSelectListener(this._menuItemSelectHandler)}if(!this._selectorMenu.isOpened()){this._selectorMenu.open(t)}},onMenuItemSelect:function(e,t){var i=t.getValue();if(this._selectorMenu.isOpened()){this._selectorMenu.close()}this.openCreationDialog(parseInt(i))}};if(typeof e.CrmCustomActivityTypeSelector.messages==="undefined"){e.CrmCustomActivityTypeSelector.messages={}}e.CrmCustomActivityTypeSelector.items={};e.CrmCustomActivityTypeSelector.create=function(t,i){var n=new e.CrmCustomActivityTypeSelector;n.initialize(t,i);this.items[n.getId()]=n;return n}}if(typeof e.CrmCallListHelper=="undefined"){e.CrmCallListHelper=function(){};e.CrmCallListHelper.createCallList=function(t,n){e.ajax({url:i,method:"POST",dataType:"json",data:{ajax_action:"CREATE_CALL_LIST",sessid:e.bitrix_sessid(),ENTITY_TYPE:t.entityType,ENTITY_IDS:t.entityIds,GRID_ID:t.gridId,CREATE_ACTIVITY:t.createActivity?"Y":"N"},onsuccess:function(e){if(e&&n){n(e)}},onfailure:function(e){}})};e.CrmCallListHelper.addToCallList=function(t){var n=t.context||"";var a=t.callListId||0;var o=t.entityIds?t.entityIds:[t.id];if(n==""||a==0)return;e.ajax({url:i,method:"POST",dataType:"json",data:{ajax_action:"ADD_TO_CALL_LIST",sessid:e.bitrix_sessid(),CALL_LIST_ID:a,ENTITY_TYPE:t.entityType,ENTITY_IDS:o,GRID_ID:t.gridId},onsuccess:function(t){if(t&&!t.SUCCESS&&t.ERRORS){var i=t.ERRORS.join(". \n");window.alert(i)}else if(t&&t.SUCCESS&&t.DATA){var a=t.DATA.ID;if(t.DATA&&t.DATA.MESSAGE){window.alert(t.DATA.MESSAGE)}e.localStorage.set("onCrmCallListUpdate",{callListId:a,context:n},10)}}})}}})(window.BX||window.top.BX);
//# sourceMappingURL=activity_planner.map.js