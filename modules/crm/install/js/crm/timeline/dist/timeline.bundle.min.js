this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(exports,main_core_events,currency,ui_notification,pull_client,ui_vue,main_core){"use strict";var Item={undefined:0,activity:1,creation:2,modification:3,link:4,unlink:5,mark:6,comment:7,wait:8,bizproc:9,conversion:10,sender:11,document:12,restoration:13,order:14,orderCheck:15,scoring:16,externalNotification:17,finalSummary:18,delivery:19,finalSummaryDocuments:20,storeDocument:21};var Mark={undefined:0,waiting:1,success:2,renew:3,ignored:4,failed:5};var Delivery={undefined:0,taxiEstimationRequest:1,taxiCallRequest:2,taxiCancelledByManager:3,taxiCancelledByDriver:4,taxiPerformerNotFound:5,taxiSmsProviderIssue:6,taxiReturnedFinish:7,deliveryMessage:101,deliveryCalculation:102};var Order={encourageBuyProducts:100};var EditorMode={view:1,edit:2};var types=Object.freeze({Item:Item,Mark:Mark,Delivery:Delivery,Order:Order,EditorMode:EditorMode});var Item$1=function(){function t(){babelHelpers.classCallCheck(this,t);this._id="";this._settings={};this._data={};this._container=null;this._wrapper=null;this._typeCategoryId=null;this._associatedEntityData=null;this._associatedEntityTypeId=null;this._associatedEntityId=null;this._isContextMenuShown=false;this._contextMenuButton=null;this._activityEditor=null;this._actions=[];this._actionContainer=null;this._isTerminated=false;this._vueComponent=null;this._vueComponentMountedNode=null}babelHelpers.createClass(t,[{key:"initialize",value:function t(e,i){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=i?i:{};this._container=this.getSetting("container");if(!BX.type.isPlainObject(i["data"])){throw"Item. A required parameter 'data' is missing."}this._data=i["data"];this._activityEditor=this.getSetting("activityEditor");this._vueComponent=this.getSetting("vueComponent");this.doInitialize()}},{key:"doInitialize",value:function t(){}},{key:"getId",value:function t(){return this._id}},{key:"getSetting",value:function t(e,i){return this._settings.hasOwnProperty(e)?this._settings[e]:i}},{key:"getData",value:function t(){return this._data}},{key:"setData",value:function t(e){if(BX.type.isPlainObject(e)){this._data=e;this.clearCachedData()}}},{key:"getAssociatedEntityData",value:function t(){if(this._associatedEntityData===null){this._associatedEntityData=BX.type.isPlainObject(this._data["ASSOCIATED_ENTITY"])?this._data["ASSOCIATED_ENTITY"]:{}}return this._associatedEntityData}},{key:"getAssociatedEntityTypeId",value:function t(){if(this._associatedEntityTypeId===null){this._associatedEntityTypeId=BX.prop.getInteger(this._data,"ASSOCIATED_ENTITY_TYPE_ID",0)}return this._associatedEntityTypeId}},{key:"getAssociatedEntityId",value:function t(){if(this._associatedEntityId===null){this._associatedEntityId=BX.prop.getInteger(this._data,"ASSOCIATED_ENTITY_ID",0)}return this._associatedEntityId}},{key:"setAssociatedEntityData",value:function t(e){if(!BX.type.isPlainObject(e)){e={}}this._data["ASSOCIATED_ENTITY"]=e;this.clearCachedData()}},{key:"hasPermissions",value:function t(){var e=this.getAssociatedEntityData();return BX.type.isPlainObject(e["PERMISSIONS"])}},{key:"getPermissions",value:function t(){return BX.prop.getObject(this.getAssociatedEntityData(),"PERMISSIONS",{})}},{key:"setPermissions",value:function t(e){if(!BX.type.isPlainObject(this._data["ASSOCIATED_ENTITY"])){this._data["ASSOCIATED_ENTITY"]={}}this._data["ASSOCIATED_ENTITY"]["PERMISSIONS"]=e;this.clearCachedData()}},{key:"getTextDataParam",value:function t(e){return BX.prop.getString(this._data,e,"")}},{key:"getObjectDataParam",value:function t(e){return BX.prop.getObject(this._data,e,{})}},{key:"getArrayDataParam",value:function t(e){return BX.prop.getArray(this._data,e,[])}},{key:"getTypeId",value:function t(){return Item.undefined}},{key:"getTypeCategoryId",value:function t(){if(this._typeCategoryId===null){this._typeCategoryId=BX.prop.getInteger(this._data,"TYPE_CATEGORY_ID",0)}return this._typeCategoryId}},{key:"getContainer",value:function t(){return this._container}},{key:"setContainer",value:function t(e){this._container=BX.type.isElementNode(e)?e:null}},{key:"getWrapper",value:function t(){return this._wrapper}},{key:"addWrapperClass",value:function t(e,i){if(!this._wrapper){return}BX.addClass(this._wrapper,e);if(BX.type.isNumber(i)&&i>=0){window.setTimeout(BX.delegate((function(){this.removeWrapperClass(e)}),this),i)}}},{key:"removeWrapperClass",value:function t(e,i){if(!this._wrapper){return}BX.removeClass(this._wrapper,e);if(BX.type.isNumber(i)&&i>=0){window.setTimeout(BX.delegate((function(){this.addWrapperClass(e)}),this),i)}}},{key:"layout",value:function t(e){if(!BX.type.isElementNode(this._container)){throw"Item. Container is not assigned."}this.prepareLayout(e);this.prepareActions();var i=this._actions.length;for(var s=0;s<i;s++){this._actions[s].layout()}this.showActions(i>0)}},{key:"makeVueComponent",value:function e(i,s){if(this._vueComponentMountedNode){return this._vueComponentMountedNode}if(!this._vueComponent){return null}var n=new this._vueComponent({propsData:{self:this,langMessages:t.messages,mode:s}});n.$mount();this._vueComponentMountedNode=n.$el;return this._vueComponentMountedNode}},{key:"prepareLayout",value:function t(e){}},{key:"prepareActions",value:function t(){}},{key:"showActions",value:function t(e){}},{key:"clearLayout",value:function t(){this._wrapper=BX.remove(this._wrapper)}},{key:"refreshLayout",value:function t(){var e=this._wrapper.previousSibling;this._wrapper=BX.remove(this._wrapper);this._playerWrappers={};this.layout({anchor:e})}},{key:"clearCachedData",value:function t(){this._typeCategoryId=null;this._associatedEntityData=null;this._associatedEntityTypeId=null;this._associatedEntityId=null}},{key:"isDone",value:function t(){return false}},{key:"markAsDone",value:function t(e){}},{key:"isTerminated",value:function t(){return this._isTerminated}},{key:"markAsTerminated",value:function t(e){e=!!e;if(this._isTerminated===e){return}this._isTerminated=e;if(!this._wrapper){return}if(e){BX.addClass(this._wrapper,"crm-entity-stream-section-last")}else{BX.removeClass(this._wrapper,"crm-entity-stream-section-last")}}},{key:"view",value:function t(){}},{key:"edit",value:function t(){}},{key:"fasten",value:function t(){}},{key:"unfasten",value:function t(){}},{key:"remove",value:function t(){}},{key:"cutOffText",value:function t(e,i){if(!BX.type.isNumber(i)){i=0}if(i<=0||e.length<=i){return e}var s=i-1;var n=e.substring(s).search(/\s/i);if(n>0){s+=n}return e.substring(0,s)}},{key:"prepareMultilineCutOffElements",value:function t(e,i,s){if(!BX.type.isNumber(i)){i=0}if(i<=0||e.length<=i){return[BX.util.htmlspecialchars(e).replace(/(?:\r\n|\r|\n)/g,"<br>")]}var n=i-1;var a=e.substring(n).search(/\s/i);if(a>0){n+=a}return[BX.util.htmlspecialchars(e.substring(0,n)).replace(/(?:\r\n|\r|\n)/g,"<br>")+"&hellip;&nbsp;",BX.create("A",{attrs:{className:"crm-entity-stream-content-letter-more",href:"#"},events:{click:s},text:this.getMessage("details")})]}},{key:"prepareCutOffElements",value:function t(e,i,s){if(!BX.type.isNumber(i)){i=0}if(i<=0||e.length<=i){return[BX.util.htmlspecialchars(e)]}var n=i-1;var a=e.substring(n).search(/\s/i);if(a>0){n+=a}return[BX.util.htmlspecialchars(e.substring(0,n))+"&hellip;&nbsp;",BX.create("A",{attrs:{className:"crm-entity-stream-content-letter-more",href:"#"},events:{click:s},text:this.getMessage("details")})]}},{key:"prepareAuthorLayout",value:function t(){var e=this.getObjectDataParam("AUTHOR",null);if(!e){return null}var i=BX.prop.getString(e,"SHOW_URL","");if(i===""){return null}var s=BX.create("A",{attrs:{className:"ui-icon ui-icon-common-user crm-entity-stream-content-detail-employee",href:i,target:"_blank",title:BX.prop.getString(e,"FORMATTED_NAME","")},children:[BX.create("i",{})]});var n=BX.prop.getString(e,"IMAGE_URL","");if(n!==""){s.children[0].style.backgroundImage="url('"+n+"')";s.children[0].style.backgroundSize="21px"}return s}},{key:"onActivityCreate",value:function t(e,i){}},{key:"isContextMenuEnabled",value:function t(){return false}},{key:"prepareContextMenuButton",value:function t(){this._contextMenuButton=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-context-menu"},events:{click:BX.delegate(this.onContextMenuButtonClick,this)}});return this._contextMenuButton}},{key:"onContextMenuButtonClick",value:function t(e){if(!this._isContextMenuShown){this.openContextMenu()}else{this.closeContextMenu()}}},{key:"openContextMenu",value:function t(){var e=this.prepareContextMenuItems();if(typeof IntranetExtensions!=="undefined"){e.push(IntranetExtensions)}if(e.length===0){return}BX.PopupMenu.show(this._id,this._contextMenuButton,e,{offsetTop:0,offsetLeft:16,angle:{position:"top",offset:0},events:{onPopupShow:BX.delegate(this.onContextMenuShow,this),onPopupClose:BX.delegate(this.onContextMenuClose,this),onPopupDestroy:BX.delegate(this.onContextMenuDestroy,this)}});this._contextMenu=BX.PopupMenu.currentItem}},{key:"closeContextMenu",value:function t(){if(this._contextMenu){this._contextMenu.close()}}},{key:"prepareContextMenuItems",value:function t(){return[]}},{key:"onContextMenuShow",value:function t(){this._isContextMenuShown=true;BX.addClass(this._contextMenuButton,"active")}},{key:"onContextMenuClose",value:function t(){if(this._contextMenu){this._contextMenu.popupWindow.destroy()}}},{key:"onContextMenuDestroy",value:function t(){this._isContextMenuShown=false;BX.removeClass(this._contextMenuButton,"active");this._contextMenu=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}}},{key:"getMessage",value:function e(i){var s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"getUserTimezoneOffset",value:function t(){if(!this.userTimezoneOffset){this.userTimezoneOffset=parseInt(BX.message("USER_TZ_OFFSET"));if(isNaN(this.userTimezoneOffset)){this.userTimezoneOffset=0}}return this.userTimezoneOffset}}]);return t}();babelHelpers.defineProperty(Item$1,"messages",{});var Fasten=function(){function t(){babelHelpers.classCallCheck(this,t);this._id="";this._settings={};this._initialItem=null;this._finalItem=null;this._events=null}babelHelpers.createClass(t,[{key:"initialize",value:function t(e,i){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=i?i:{};this._initialItem=this.getSetting("initialItem");this._finalItem=this.getSetting("finalItem");this._anchor=this.getSetting("anchor");this._events=this.getSetting("events",{})}},{key:"getId",value:function t(){return this._id}},{key:"getSetting",value:function t(e,i){return this._settings.hasOwnProperty(e)?this._settings[e]:i}},{key:"addFixedHistoryItem",value:function t(){var e=this._finalItem.getWrapper();BX.addClass(e,"crm-entity-stream-section-animate-start");this._anchor.parentNode.insertBefore(e,this._anchor.nextSibling);setTimeout(BX.delegate((function(){BX.removeClass(e,"crm-entity-stream-section-animate-start")}),this),0);this._finalItem.onFinishFasten()}},{key:"run",value:function t(){var e=this._initialItem.getWrapper();this._clone=e.cloneNode(true);BX.addClass(this._clone,"crm-entity-stream-section-animate-start crm-entity-stream-section-top-fixed");this._startPosition=BX.pos(e);this._clone.style.position="absolute";this._clone.style.width=this._startPosition.width+"px";var i=this._startPosition.height;var s=65;var n=18;if(i<n+s)i=n+s;this._clone.style.height=i+"px";this._clone.style.top=this._startPosition.top+"px";this._clone.style.left=this._startPosition.left+"px";this._clone.style.zIndex=960;document.body.appendChild(this._clone);setTimeout(BX.proxy((function(){BX.addClass(this._clone,"crm-entity-stream-section-casper")}),this),0);this._anchorPosition=BX.pos(this._anchor);var a={top:this._anchorPosition.top,height:i+15,opacity:1};var r=this._startPosition.top-this._anchorPosition.bottom;var o=2*(document.body.clientHeight+this._startPosition.height);if(r>o){a.top=this._startPosition.top-o;a.opacity=0}var l=Math.abs(a.top-this._startPosition.top)*2;l=l<1500?1500:l;var c=new BX.easing({duration:l,start:{top:this._startPosition.top,height:0,opacity:1},finish:a,transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(t){this._clone.style.top=t.top+"px";this._clone.style.opacity=t.opacity;this._anchor.style.height=t.height+"px"}),this),complete:BX.proxy((function(){this.finish()}),this)});c.animate()}},{key:"finish",value:function t(){this._anchor.style.height=0;this.addFixedHistoryItem();BX.remove(this._clone);if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}}}],[{key:"create",value:function e(i,s){var n=new t;n.initialize(i,s);return n}}]);return t}();var History=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._history=null;t._fixedHistory=null;t._typeId=null;t._createdTime=null;t._isFixed=false;t._headerClickHandler=BX.delegate(t.onHeaderClick,babelHelpers.assertThisInitialized(t));return t}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){this._history=this.getSetting("history");this._fixedHistory=this.getSetting("fixedHistory")}},{key:"getTypeId",value:function t(){if(this._typeId===null){this._typeId=BX.prop.getInteger(this._data,"TYPE_ID",Item.undefined)}return this._typeId}},{key:"getTitle",value:function t(){return""}},{key:"isContextMenuEnabled",value:function t(){return!this.isReadOnly()}},{key:"getCreatedTimestamp",value:function t(){return this.getTextDataParam("CREATED_SERVER")}},{key:"getCreatedTime",value:function t(){if(this._createdTime===null){var e=BX.parseDate(this.getCreatedTimestamp(),false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");this._createdTime=new Date(e.getTime()+1e3*Item$1.getUserTimezoneOffset())}return this._createdTime}},{key:"getCreatedDate",value:function t(){return BX.prop.extractDate(new Date(this.getCreatedTime().getTime()))}},{key:"getOwnerInfo",value:function t(){return this._history?this._history.getOwnerInfo():null}},{key:"getOwnerTypeId",value:function t(){return BX.prop.getInteger(this.getOwnerInfo(),"ENTITY_TYPE_ID",BX.CrmEntityType.enumeration.undefined)}},{key:"getOwnerId",value:function t(){return BX.prop.getInteger(this.getOwnerInfo(),"ENTITY_ID",0)}},{key:"isReadOnly",value:function t(){return this._history.isReadOnly()}},{key:"isEditable",value:function t(){return!this.isReadOnly()}},{key:"isDone",value:function t(){var e=this.getTypeId();if(e===Item.activity){var i=this.getAssociatedEntityData();return BX.CrmActivityStatus.isFinal(BX.prop.getInteger(i,"STATUS",0))}return false}},{key:"isFixed",value:function t(){return this._isFixed}},{key:"fasten",value:function t(e){if(this._fixedHistory._items.length>=3){if(!this.fastenLimitPopup){this.fastenLimitPopup=new BX.PopupWindow("timeline_fasten_limit_popup_"+this._id,this._switcher,{content:BX.message("CRM_TIMELINE_FASTEN_LIMIT_MESSAGE"),darkMode:true,autoHide:true,zIndex:990,angle:true,closeByEsc:true,bindOptions:{forceBindPosition:true}})}this.fastenLimitPopup.show();this.closeContextMenu();return}BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"CHANGE_FASTEN_ITEM",VALUE:"Y",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this._id},onsuccess:BX.delegate(this.onSuccessFasten,this)});this.closeContextMenu()}},{key:"onSuccessFasten",value:function t(e){if(BX.type.isNotEmptyString(e.ERROR))return;if(!this.isFixed()){this._data.IS_FIXED="Y";var i=this._fixedHistory.createItem(this._data);i._isFixed=true;this._fixedHistory.addItem(i,0);i.layout({add:false});this.refreshLayout();var s=Fasten.create("",{initialItem:this,finalItem:i,anchor:this._fixedHistory._anchor});s.run()}this.closeContextMenu()}},{key:"onFinishFasten",value:function t(e){}},{key:"unfasten",value:function t(e){BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"CHANGE_FASTEN_ITEM",VALUE:"N",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this._id},onsuccess:BX.delegate(this.onSuccessUnfasten,this)});this.closeContextMenu()}},{key:"onSuccessUnfasten",value:function t(e){if(BX.type.isNotEmptyString(e.ERROR))return;var i;var s;if(this.isFixed()){i=this;s=this._history.findItemById(this._id)}else{i=this._fixedHistory.findItemById(this._id);s=this}if(i){var n=this._fixedHistory.getItemIndex(i);i.clearAnimate();this._fixedHistory.removeItemByIndex(n);if(s){s._data.IS_FIXED="N";s.refreshLayout();BX.LazyLoad.showImages()}}}},{key:"clearAnimate",value:function t(){if(!BX.type.isDomNode(this._wrapper))return;var e=BX.pos(this._wrapper);var i=new BX.easing({duration:1e3,start:{height:e.height,opacity:1,marginBottom:15},finish:{height:0,opacity:0,marginBottom:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(t){this._wrapper.style.height=t.height+"px";this._wrapper.style.opacity=t.opacity;this._wrapper.style.marginBottom=t.marginBottom}),this),complete:BX.proxy((function(){this.clearLayout()}),this)});i.animate()}},{key:"getWrapperClassName",value:function t(){return""}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}},{key:"prepareContentDetails",value:function t(){return[]}},{key:"prepareContent",value:function t(){var e=this.getWrapperClassName();if(e!==""){e="crm-entity-stream-section crm-entity-stream-section-history"+" "+e}else{e="crm-entity-stream-section crm-entity-stream-section-history"}var i=BX.create("DIV",{attrs:{className:e}});i.appendChild(BX.create("DIV",{attrs:{className:this.getIconClassName()}}));var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})]});s.appendChild(n);s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:this.prepareContentDetails()}));var a=this.prepareAuthorLayout();if(a){s.appendChild(a)}return i}},{key:"prepareLayout",value:function t(e){var i=this.makeVueComponent(e,"history");this._wrapper=i?i:this.prepareContent();if(this._wrapper){var s=BX.type.isPlainObject(e)?BX.prop.getBoolean(e,"add",true):true;if(s){var n=BX.type.isPlainObject(e)&&BX.type.isElementNode(e["anchor"])?e["anchor"]:null;if(n&&n.nextSibling){this._container.insertBefore(this._wrapper,n.nextSibling)}else{this._container.appendChild(this._wrapper)}}this.markAsTerminated(this._history.checkItemForTermination(this))}}},{key:"onHeaderClick",value:function t(e){this.view();e.preventDefault?e.preventDefault():e.returnValue=false}},{key:"prepareTitleLayout",value:function t(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getTitle()})}},{key:"prepareFixedSwitcherLayout",value:function t(){var e=this.getTextDataParam("IS_FIXED")==="Y";this._switcher=BX.create("span",{attrs:{className:"crm-entity-stream-section-top-fixed-btn"},events:{click:e?BX.delegate(this.unfasten,this):BX.delegate(this.fasten,this)}});if(e)BX.addClass(this._switcher,"crm-entity-stream-section-top-fixed-btn-active");if(!this.isReadOnly()&&!e){var i=this._history.getManager();if(!i.isSpotlightShowed()){i.setSpotlightShowed();BX.addClass(this._switcher,"crm-entity-stream-section-top-fixed-btn-spotlight");var s=new BX.SpotLight({targetElement:this._switcher,targetVertex:"middle-center",lightMode:false,id:"CRM_TIMELINE_FASTEN_SWITCHER",zIndex:900,top:-3,left:-1,autoSave:true,content:BX.message("CRM_TIMELINE_SPOTLIGHT_FASTEN_MESSAGE")});s.show()}}return this._switcher}},{key:"prepareHeaderLayout",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});e.appendChild(this.prepareTitleLayout());e.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));return e}},{key:"onActivityCreate",value:function t(e,i){this._history.getManager().onActivityCreated(e,i)}},{key:"formatTime",value:function t(e){if(this.isFixed()){return this._fixedHistory.formatTime(e)}return this._history.formatTime(e)}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}},{key:"isCounterEnabled",value:function t(e){if(!BX.type.isDate(e)){return false}var i=new Date;i.setHours(0);i.setMinutes(0);i.setSeconds(0);i.setMilliseconds(0);i=i.getTime();var s=new Date;s.setHours(23);s.setMinutes(59);s.setSeconds(59);s.setMilliseconds(999);s=s.getTime();var n=e.getTime();return n<i||n>=i&&n<=s}}]);return e}(Item$1);var HistoryItemMixin={props:{self:{required:true,type:Object},langMessages:{required:false,type:Object}},computed:{data:function t(){return this.self._data},fields:function t(){return this.data.FIELDS?this.data.FIELDS:null},author:function t(){return this.data.AUTHOR?this.data.AUTHOR:null},createdAt:function t(){return this.self instanceof History?this.self.formatTime(this.self.getCreatedTime()):""}},methods:{getLangMessage:function t(e){return this.langMessages.hasOwnProperty(e)?this.langMessages[e]:e}}};var Product={props:{product:{required:true,type:Object},dealId:{required:true,type:Number},isAddToDealVisible:{required:true,type:Boolean}},methods:{addProductToDeal:function t(){var e=this;if(this.product.isInDeal){return}this.$emit("product-adding-to-deal");this.product.isInDeal=true;main_core.ajax.runAction("crm.timeline.encouragebuyproducts.addproducttodeal",{data:{dealId:this.dealId,productId:this.product.offerId,options:{price:this.product.price}}}).then((function(t){e.$emit("product-added-to-deal");e.product.isInDeal=true}))["catch"]((function(t){e.product.isInDeal=false}))},openDetailPage:function t(){if(BX.type.isNotEmptyString(this.product.adminLink)){var e;if(((e=this.product)===null||e===void 0?void 0:e.slider)==="N"){window.open(this.product.adminLink,"_blank")}else{BX.SidePanel.Instance.open(this.product.adminLink)}}}},computed:{isBottomAreaVisible:function t(){return this.isVariationInfoVisible||this.isPriceVisible},isVariationInfoVisible:function t(){return this.product.hasOwnProperty("variationInfo")&&this.product.variationInfo},isPriceVisible:function t(){return this.product.hasOwnProperty("price")&&this.product.hasOwnProperty("currency")&&this.product.price&&this.product.currency},price:function t(){return BX.Currency.currencyFormat(this.product.price,this.product.currency,true)},imageStyle:function t(){if(!this.product.image){return{}}return{backgroundImage:"url("+this.product.image+")"}},buttonText:function t(){return main_core.Loc.getMessage(this.product.isInDeal?"CRM_TIMELINE_ENCOURAGE_BUY_PRODUCTS_PRODUCT_IN_DEAL":"CRM_TIMELINE_ENCOURAGE_BUY_PRODUCTS_ADD_PRODUCT_TO_DEAL")}},template:'\n\t\t<li\n\t\t\t:class="{\'crm-entity-stream-advice-list-item--active\': product.isInDeal}"\n\t\t\tclass="crm-entity-stream-advice-list-item"\n\t\t>\t\n\t\t\t<div class="crm-entity-stream-advice-list-content">\n\t\t\t\t<div\t\n\t\t\t\t\t:style="imageStyle"\n\t\t\t\t\tclass="crm-entity-stream-advice-list-icon"\n\t\t\t\t>\n\t\t\t\t</div>\n\t\t\t\t<div class="crm-entity-stream-advice-list-inner">\n\t\t\t\t\t<a\n\t\t\t\t\t\t@click.prevent="openDetailPage"\n\t\t\t\t\t\thref="#"\n\t\t\t\t\t\tclass="crm-entity-stream-advice-list-name"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{product.name}}\n\t\t\t\t\t</a>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="isBottomAreaVisible"\n\t\t\t\t\t\tclass="crm-entity-stream-advice-list-desc-box"\n\t\t\t\t\t>\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tv-if="isVariationInfoVisible"\n\t\t\t\t\t\t\tclass="crm-entity-stream-advice-list-desc-name"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{product.variationInfo}}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tv-if="isPriceVisible"\n\t\t\t\t\t\t\tv-html="price"\n\t\t\t\t\t\t\tclass="crm-entity-stream-advice-list-desc-value"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div v-if="isAddToDealVisible" class="crm-entity-stream-advice-list-btn-box">\t\t\t\t\n\t\t\t\t<button\n\t\t\t\t\t@click="addProductToDeal"\n\t\t\t\t\tclass="ui-btn ui-btn-round ui-btn-xs crm-entity-stream-advice-list-btn"\n\t\t\t\t>\n\t\t\t\t\t{{buttonText}}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</li>\n\t'};function _createForOfIteratorHelper(t,e){var i=typeof Symbol!=="undefined"&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=_unsupportedIterableToArray(t))||e&&t&&typeof t.length==="number"){if(i)t=i;var s=0;var n=function t(){};return{s:n,n:function e(){if(s>=t.length)return{done:true};return{done:false,value:t[s++]}},e:function t(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,r=false,o;return{s:function e(){i=i.call(t)},n:function t(){var e=i.next();a=e.done;return e},e:function t(e){r=true;o=e},f:function t(){try{if(!a&&i["return"]!=null)i["return"]()}finally{if(r)throw o}}}}function _unsupportedIterableToArray(t,e){if(!t)return;if(typeof t==="string")return _arrayLikeToArray(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);if(i==="Object"&&t.constructor)i=t.constructor.name;if(i==="Map"||i==="Set")return Array.from(t);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return _arrayLikeToArray(t,e)}function _arrayLikeToArray(t,e){if(e==null||e>t.length)e=t.length;for(var i=0,s=new Array(e);i<e;i++){s[i]=t[i]}return s}var component=ui_vue.Vue.extend({mixins:[HistoryItemMixin],components:{product:Product},data:function t(){return{isShortList:true,shortListProductsCnt:3,isNotificationShown:false,activeRequestsCnt:0,dealId:null,products:[],isProductsGridAvailable:false}},created:function t(){var e=this;this.products=this.data.VIEWED_PRODUCTS;this.dealId=this.data.DEAL_ID;this._productsGrid=null;this.subscribeCustomEvents();BX.Crm.EntityEditor.getDefault().tapController("PRODUCT_LIST",(function(t){e.setProductsGrid(t.getProductList())}))},methods:{setProductsGrid:function t(e){this._productsGrid=e;if(this._productsGrid){this.onProductsGridChanged();this.isProductsGridAvailable=true}},showMore:function t(){this.isShortList=false;var e=document.querySelector(".crm-entity-stream-advice-list");e.style.maxHeight=950+"px"},handleProductAddingToDeal:function t(){this.activeRequestsCnt++},handleProductAddedToDeal:function t(){var e=this;if(this.activeRequestsCnt>0){this.activeRequestsCnt--}if(!(this.activeRequestsCnt===0&&this._productsGrid)){return}BX.Crm.EntityEditor.getDefault().reload();this._productsGrid.reloadGrid(false);if(!this.isNotificationShown){ui_notification.UI.Notification.Center.notify({content:main_core.Loc.getMessage("CRM_TIMELINE_ENCOURAGE_BUY_PRODUCTS_PRODUCTS_ADDED_TO_DEAL"),events:{onClose:function t(i){e.isNotificationShown=false}},actions:[{title:main_core.Loc.getMessage("CRM_TIMELINE_ENCOURAGE_BUY_PRODUCTS_EDIT_PRODUCTS"),events:{click:function t(e,i,s){BX.onCustomEvent(window,"OpenEntityDetailTab",["tab_products"]);i.close()}}}]});this.isNotificationShown=true}},subscribeCustomEvents:function t(){main_core_events.EventEmitter.subscribe("EntityProductListController",this.onProductsGridCreated);main_core_events.EventEmitter.subscribe("BX.Crm.EntityEditor:onSave",this.onProductsGridChanged)},unsubscribeCustomEvents:function t(){main_core_events.EventEmitter.unsubscribe("EntityProductListController",this.onProductsGridCreated);main_core_events.EventEmitter.unsubscribe("BX.Crm.EntityEditor:onSave",this.onProductsGridChanged)},onProductsGridCreated:function t(e){this.setProductsGrid(e.getData()[0])},onProductsGridChanged:function t(e){var i=this;if(!this._productsGrid){return}var s=this._productsGrid.products.map((function(t,e){if(!(t.hasOwnProperty("fields")&&t.fields.hasOwnProperty("OFFER_ID"))){return null}return t.fields.OFFER_ID}));var n=_createForOfIteratorHelper(this.products.entries()),a;try{var r=function t(){var e=babelHelpers.slicedToArray(a.value,2),n=e[0],r=e[1];var o=s.some((function(t){return t==r.offerId}));if(r.isInDeal===o){return"continue"}ui_vue.Vue.set(i.products,n,Object.assign({},r,{isInDeal:o}))};for(n.s();!(a=n.n()).done;){var o=r();if(o==="continue")continue}}catch(t){n.e(t)}finally{n.f()}},beforeDestroy:function t(){this.unsubscribeCustomEvents()}},computed:{visibleProducts:function t(){var e=[];var i=1;var s=_createForOfIteratorHelper(this.products),n;try{for(s.s();!(n=s.n()).done;){var a=n.value;if(this.isShortList&&i>this.shortListProductsCnt){break}e.push(a);i++}}catch(t){s.e(t)}finally{s.f()}return e},isShowMoreVisible:function t(){return this.isShortList&&this.products.length>this.shortListProductsCnt}},template:'\n\t\t<div class="crm-entity-stream-section crm-entity-stream-section-advice">\n\t\t\t<div class="crm-entity-stream-section-icon crm-entity-stream-section-icon-advice"></div>\n\t\t\t<div class="crm-entity-stream-advice-content">\n\t\t\t\t<div class="crm-entity-stream-advice-info">\n\t\t\t\t\t'.concat(main_core.Loc.getMessage("CRM_TIMELINE_ENCOURAGE_BUY_PRODUCTS_LOOK_AT_CLIENT_PRODUCTS"),"\n\t\t\t\t\t").concat(main_core.Loc.getMessage("CRM_TIMELINE_ENCOURAGE_BUY_PRODUCTS_ENCOURAGE_CLIENT_BUY_PRODUCTS"),'\n\t\t\t\t</div>\n\t\t\t\t<div class="crm-entity-stream-advice-inner">\n\t\t\t\t\t<h3 class="crm-entity-stream-advice-subtitle">\n\t\t\t\t\t\t').concat(main_core.Loc.getMessage("CRM_TIMELINE_ENCOURAGE_BUY_PRODUCTS_VIEWED_PRODUCTS"),'\n\t\t\t\t\t</h3>\n\t\t\t\t\t\x3c!--<ul class="crm-entity-stream-advice-list">--\x3e\n\t\t\t\t\t<transition-group class="crm-entity-stream-advice-list" name="list" tag="ul">\t\t\t\t\t\t\n\t\t\t\t\t\t<product\n\t\t\t\t\t\t\tv-for="product in visibleProducts"\n\t\t\t\t\t\t\tv-bind:key="product"\n\t\t\t\t\t\t\t:product="product"\n\t\t\t\t\t\t\t:dealId="dealId"\n\t\t\t\t\t\t\t:isAddToDealVisible="isProductsGridAvailable"\n\t\t\t\t\t\t\t@product-added-to-deal="handleProductAddedToDeal"\n\t\t\t\t\t\t\t@product-adding-to-deal="handleProductAddingToDeal"\n\t\t\t\t\t\t></product>\n\t\t\t\t\t</transition-group>\n\t\t\t\t\t\x3c!--</ul>--\x3e\n\t\t\t\t\t<a\n\t\t\t\t\t\tv-if="isShowMoreVisible"\n\t\t\t\t\t\t@click.prevent="showMore"\n\t\t\t\t\t\tclass="crm-entity-stream-advice-link"\n\t\t\t\t\t\thref="#"\n\t\t\t\t\t>\n\t\t\t\t\t\t').concat(main_core.Loc.getMessage("CRM_TIMELINE_ENCOURAGE_BUY_PRODUCTS_SHOW_MORE"),"\n\t\t\t\t\t</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t")});var Author={props:{author:{required:true,type:Object}},computed:{iStyle:function t(){if(!this.author.IMAGE_URL){return{}}return{"background-image":"url("+this.author.IMAGE_URL+")","background-size":"21px"}}},template:'\n\t\t<a\n\t\t\tv-if="author.SHOW_URL"\n\t\t\t:href="author.SHOW_URL"\n\t\t\ttarget="_blank"\n\t\t\t:title="author.FORMATTED_NAME"\n\t\t\tclass="ui-icon ui-icon-common-user crm-entity-stream-content-detail-employee"\n\t\t>\n\t\t\t<i :style="iStyle"></i>\t\n\t\t</a>\n\t'};var component$1=ui_vue.Vue.extend({mixins:[HistoryItemMixin],components:{author:Author},data:function t(){return{entityData:null,messageId:null,text:null,title:null,status:{name:null,semantics:null,description:null},provider:null,isRefreshing:false}},created:function t(){var e=this;this.entityData=this.self.getAssociatedEntityData();if(this.entityData["MESSAGE_INFO"]){this.setMessageInfo(this.entityData["MESSAGE_INFO"])}pull_client.PULL.subscribe({moduleId:"notifications",command:"message_update",callback:function t(i){if(i.message.ID==e.messageId){e.refresh()}}});if(this.entityData["PULL_TAG_NAME"]){pull_client.PULL.extendWatch(this.entityData["PULL_TAG_NAME"])}},methods:{setMessageInfo:function t(e){this.messageId=e["MESSAGE"]["ID"];if(e["HISTORY_ITEMS"]&&Array.isArray(e["HISTORY_ITEMS"])&&e["HISTORY_ITEMS"].length>0&&e["HISTORY_ITEMS"][0]&&e["HISTORY_ITEMS"][0]["PROVIDER_DATA"]&&e["HISTORY_ITEMS"][0]["PROVIDER_DATA"]["DESCRIPTION"]){this.provider=e["HISTORY_ITEMS"][0]["PROVIDER_DATA"]["DESCRIPTION"];this.title=this.provider+" "+main_core.Loc.getMessage("CRM_TIMELINE_NOTIFICATION_MESSAGE")}else{this.title=this.capitalizeFirstLetter(main_core.Loc.getMessage("CRM_TIMELINE_NOTIFICATION_MESSAGE"))}if(e["HISTORY_ITEMS"]&&Array.isArray(e["HISTORY_ITEMS"])&&e["HISTORY_ITEMS"].length>0&&e["HISTORY_ITEMS"][0]&&e["HISTORY_ITEMS"][0]["STATUS_DATA"]&&e["HISTORY_ITEMS"][0]["STATUS_DATA"]["DESCRIPTION"]){this.status.name=e["HISTORY_ITEMS"][0]["STATUS_DATA"]["DESCRIPTION"];this.status.semantics=e["HISTORY_ITEMS"][0]["STATUS_DATA"]["SEMANTICS"];this.status.description=e["HISTORY_ITEMS"][0]["ERROR_MESSAGE"]}this.text=e["MESSAGE"]["TEXT"]?e["MESSAGE"]["TEXT"]:main_core.Loc.getMessage("CRM_TIMELINE_NOTIFICATION_NO_MESSAGE_TEXT_2")},refresh:function t(){var e=this;if(this.isRefreshing){return}this.isRefreshing=true;main_core.ajax.runAction("crm.timeline.notification.getmessageinfo",{data:{messageId:this.messageId}}).then((function(t){e.setMessageInfo(t.data);e.isRefreshing=false}))["catch"]((function(t){e.isRefreshing=false}))},viewActivity:function t(){this.self.view()},capitalizeFirstLetter:function t(e){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:navigator.language;return e.replace(/^(?:[a-z\xB5\xDF-\xF6\xF8-\xFF\u0101\u0103\u0105\u0107\u0109\u010B\u010D\u010F\u0111\u0113\u0115\u0117\u0119\u011B\u011D\u011F\u0121\u0123\u0125\u0127\u0129\u012B\u012D\u012F\u0131\u0133\u0135\u0137\u013A\u013C\u013E\u0140\u0142\u0144\u0146\u0148\u0149\u014B\u014D\u014F\u0151\u0153\u0155\u0157\u0159\u015B\u015D\u015F\u0161\u0163\u0165\u0167\u0169\u016B\u016D\u016F\u0171\u0173\u0175\u0177\u017A\u017C\u017E-\u0180\u0183\u0185\u0188\u018C\u0192\u0195\u0199\u019A\u019E\u01A1\u01A3\u01A5\u01A8\u01AD\u01B0\u01B4\u01B6\u01B9\u01BD\u01BF\u01C5\u01C6\u01C8\u01C9\u01CB\u01CC\u01CE\u01D0\u01D2\u01D4\u01D6\u01D8\u01DA\u01DC\u01DD\u01DF\u01E1\u01E3\u01E5\u01E7\u01E9\u01EB\u01ED\u01EF\u01F0\u01F2\u01F3\u01F5\u01F9\u01FB\u01FD\u01FF\u0201\u0203\u0205\u0207\u0209\u020B\u020D\u020F\u0211\u0213\u0215\u0217\u0219\u021B\u021D\u021F\u0223\u0225\u0227\u0229\u022B\u022D\u022F\u0231\u0233\u023C\u023F\u0240\u0242\u0247\u0249\u024B\u024D\u024F-\u0254\u0256\u0257\u0259\u025B\u025C\u0260\u0261\u0263\u0265\u0266\u0268-\u026C\u026F\u0271\u0272\u0275\u027D\u0280\u0282\u0283\u0287-\u028C\u0292\u029D\u029E\u0345\u0371\u0373\u0377\u037B-\u037D\u0390\u03AC-\u03CE\u03D0\u03D1\u03D5-\u03D7\u03D9\u03DB\u03DD\u03DF\u03E1\u03E3\u03E5\u03E7\u03E9\u03EB\u03ED\u03EF-\u03F3\u03F5\u03F8\u03FB\u0430-\u045F\u0461\u0463\u0465\u0467\u0469\u046B\u046D\u046F\u0471\u0473\u0475\u0477\u0479\u047B\u047D\u047F\u0481\u048B\u048D\u048F\u0491\u0493\u0495\u0497\u0499\u049B\u049D\u049F\u04A1\u04A3\u04A5\u04A7\u04A9\u04AB\u04AD\u04AF\u04B1\u04B3\u04B5\u04B7\u04B9\u04BB\u04BD\u04BF\u04C2\u04C4\u04C6\u04C8\u04CA\u04CC\u04CE\u04CF\u04D1\u04D3\u04D5\u04D7\u04D9\u04DB\u04DD\u04DF\u04E1\u04E3\u04E5\u04E7\u04E9\u04EB\u04ED\u04EF\u04F1\u04F3\u04F5\u04F7\u04F9\u04FB\u04FD\u04FF\u0501\u0503\u0505\u0507\u0509\u050B\u050D\u050F\u0511\u0513\u0515\u0517\u0519\u051B\u051D\u051F\u0521\u0523\u0525\u0527\u0529\u052B\u052D\u052F\u0561-\u0587\u10D0-\u10FA\u10FD-\u10FF\u13F8-\u13FD\u1C80-\u1C88\u1D79\u1D7D\u1D8E\u1E01\u1E03\u1E05\u1E07\u1E09\u1E0B\u1E0D\u1E0F\u1E11\u1E13\u1E15\u1E17\u1E19\u1E1B\u1E1D\u1E1F\u1E21\u1E23\u1E25\u1E27\u1E29\u1E2B\u1E2D\u1E2F\u1E31\u1E33\u1E35\u1E37\u1E39\u1E3B\u1E3D\u1E3F\u1E41\u1E43\u1E45\u1E47\u1E49\u1E4B\u1E4D\u1E4F\u1E51\u1E53\u1E55\u1E57\u1E59\u1E5B\u1E5D\u1E5F\u1E61\u1E63\u1E65\u1E67\u1E69\u1E6B\u1E6D\u1E6F\u1E71\u1E73\u1E75\u1E77\u1E79\u1E7B\u1E7D\u1E7F\u1E81\u1E83\u1E85\u1E87\u1E89\u1E8B\u1E8D\u1E8F\u1E91\u1E93\u1E95-\u1E9B\u1EA1\u1EA3\u1EA5\u1EA7\u1EA9\u1EAB\u1EAD\u1EAF\u1EB1\u1EB3\u1EB5\u1EB7\u1EB9\u1EBB\u1EBD\u1EBF\u1EC1\u1EC3\u1EC5\u1EC7\u1EC9\u1ECB\u1ECD\u1ECF\u1ED1\u1ED3\u1ED5\u1ED7\u1ED9\u1EDB\u1EDD\u1EDF\u1EE1\u1EE3\u1EE5\u1EE7\u1EE9\u1EEB\u1EED\u1EEF\u1EF1\u1EF3\u1EF5\u1EF7\u1EF9\u1EFB\u1EFD\u1EFF-\u1F07\u1F10-\u1F15\u1F20-\u1F27\u1F30-\u1F37\u1F40-\u1F45\u1F50-\u1F57\u1F60-\u1F67\u1F70-\u1F7D\u1F80-\u1FB4\u1FB6\u1FB7\u1FBC\u1FBE\u1FC2-\u1FC4\u1FC6\u1FC7\u1FCC\u1FD0-\u1FD3\u1FD6\u1FD7\u1FE0-\u1FE7\u1FF2-\u1FF4\u1FF6\u1FF7\u1FFC\u214E\u2170-\u217F\u2184\u24D0-\u24E9\u2C30-\u2C5F\u2C61\u2C65\u2C66\u2C68\u2C6A\u2C6C\u2C73\u2C76\u2C81\u2C83\u2C85\u2C87\u2C89\u2C8B\u2C8D\u2C8F\u2C91\u2C93\u2C95\u2C97\u2C99\u2C9B\u2C9D\u2C9F\u2CA1\u2CA3\u2CA5\u2CA7\u2CA9\u2CAB\u2CAD\u2CAF\u2CB1\u2CB3\u2CB5\u2CB7\u2CB9\u2CBB\u2CBD\u2CBF\u2CC1\u2CC3\u2CC5\u2CC7\u2CC9\u2CCB\u2CCD\u2CCF\u2CD1\u2CD3\u2CD5\u2CD7\u2CD9\u2CDB\u2CDD\u2CDF\u2CE1\u2CE3\u2CEC\u2CEE\u2CF3\u2D00-\u2D25\u2D27\u2D2D\uA641\uA643\uA645\uA647\uA649\uA64B\uA64D\uA64F\uA651\uA653\uA655\uA657\uA659\uA65B\uA65D\uA65F\uA661\uA663\uA665\uA667\uA669\uA66B\uA66D\uA681\uA683\uA685\uA687\uA689\uA68B\uA68D\uA68F\uA691\uA693\uA695\uA697\uA699\uA69B\uA723\uA725\uA727\uA729\uA72B\uA72D\uA72F\uA733\uA735\uA737\uA739\uA73B\uA73D\uA73F\uA741\uA743\uA745\uA747\uA749\uA74B\uA74D\uA74F\uA751\uA753\uA755\uA757\uA759\uA75B\uA75D\uA75F\uA761\uA763\uA765\uA767\uA769\uA76B\uA76D\uA76F\uA77A\uA77C\uA77F\uA781\uA783\uA785\uA787\uA78C\uA791\uA793\uA794\uA797\uA799\uA79B\uA79D\uA79F\uA7A1\uA7A3\uA7A5\uA7A7\uA7A9\uA7B5\uA7B7\uA7B9\uA7BB\uA7BD\uA7BF\uA7C1\uA7C3\uA7C8\uA7CA\uA7D1\uA7D7\uA7D9\uA7F6\uAB53\uAB70-\uABBF\uFB00-\uFB06\uFB13-\uFB17\uFF41-\uFF5A]|\uD801[\uDC28-\uDC4F\uDCD8-\uDCFB\uDD97-\uDDA1\uDDA3-\uDDB1\uDDB3-\uDDB9\uDDBB\uDDBC]|\uD803[\uDCC0-\uDCF2]|\uD806[\uDCC0-\uDCDF]|\uD81B[\uDE60-\uDE7F]|\uD83A[\uDD22-\uDD43])/,(function(t){return t.toLocaleUpperCase(i)}))}},computed:{communication:function t(){return this.entityData["COMMUNICATION"]?this.entityData["COMMUNICATION"]:null},statusClass:function t(){return{"crm-entity-stream-content-event-process":this.status.semantics==="process","crm-entity-stream-content-event-successful":this.status.semantics==="success","crm-entity-stream-content-event-missing":this.status.semantics==="failure","crm-entity-stream-content-event-error-tip":this.isStatusError}},isStatusError:function t(){return this.status.semantics==="failure"&&!!this.status.description},statusErrorDescription:function t(){return this.isStatusError?this.status.description:""}},template:'\n\t\t<div class="crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-sms">\n\t\t\t<div class="crm-entity-stream-section-icon crm-entity-stream-section-icon-sms"></div>\n\t\t\t<div class="crm-entity-stream-section-content">\n\t\t\t\t<div class="crm-entity-stream-content-event">\n\t\t\t\t\t<div class="crm-entity-stream-content-header">\n\t\t\t\t\t\t<a\n\t\t\t\t\t\t\t@click.prevent="viewActivity"\n\t\t\t\t\t\t\thref="#"\n\t\t\t\t\t\t\tclass="crm-entity-stream-content-event-title"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{title}}\n\t\t\t\t\t\t</a>\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tv-if="status"\n\t\t\t\t\t\t\t:class="statusClass"\n\t\t\t\t\t\t\t:title="statusErrorDescription"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{status.name}}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span class="crm-entity-stream-content-event-time">{{createdAt}}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="crm-entity-stream-content-detail">\n\t\t\t\t\t\t<div class="crm-entity-stream-content-detail-sms">\n\t\t\t\t\t\t\t<div class="crm-entity-stream-content-detail-sms-status">\n\t\t\t\t\t\t\t\t'.concat(main_core.Loc.getMessage("CRM_TIMELINE_NOTIFICATION_VIA")," \n\t\t\t\t\t\t\t\t<strong>\n\t\t\t\t\t\t\t\t\t").concat(main_core.Loc.getMessage("CRM_TIMELINE_NOTIFICATION_BITRIX24"),'\n\t\t\t\t\t\t\t\t</strong>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="crm-entity-stream-content-detail-sms-fragment">\n\t\t\t\t\t\t\t\t<span>{{text}}</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-if="communication"\n\t\t\t\t\t\t\tclass="crm-entity-stream-content-detail-contact-info"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{BX.message(\'CRM_TIMELINE_SMS_TO\')}}\n\t\t\t\t\t\t\t<a v-if="communication.SHOW_URL" :href="communication.SHOW_URL">\n\t\t\t\t\t\t\t\t{{communication.TITLE}}\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t\t\t{{communication.TITLE}}\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t<span v-if="communication.VALUE">{{communication.VALUE}}</span>\n\t\t\t\t\t\t\t<template v-if="provider">\n\t\t\t\t\t\t\t\t').concat(main_core.Loc.getMessage("CRM_TIMELINE_NOTIFICATION_IN_MESSENGER"),' {{provider}}\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<author v-if="author" :author="author"></author>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\t\n\t')});var DeliveryServiceInfo={props:{deliveryService:{required:true,type:Object}},computed:{isDeliveryServiceProfile:function t(){return this.deliveryService.IS_PROFILE},deliveryServiceName:function t(){return this.isDeliveryServiceProfile?this.deliveryService.PARENT_NAME:this.deliveryService.NAME},deliveryProfileServiceName:function t(){return this.deliveryService.NAME},deliveryServiceLogoBackgroundUrl:function t(){return this.isDeliveryServiceProfile?this.deliveryService.PARENT_LOGO:this.deliveryService.LOGO;return logo?{"background-image":"url("+logo+")"}:{}}},template:'\n\t\t<div class="crm-entity-stream-content-delivery-title">\n\t\t\t<div\n\t\t\t\tv-if="isDeliveryServiceProfile && deliveryService.LOGO"\n\t\t\t\tclass="crm-entity-stream-content-delivery-icon"\n\t\t\t\t:style="{\'background-image\': \'url(\' + deliveryService.LOGO + \')\'}"\n\t\t\t>\n\t\t\t</div>\n\t\t\t<div class="crm-entity-stream-content-delivery-title-contnet">\n\t\t\t\t<div\n\t\t\t\t\tv-if="deliveryServiceLogoBackgroundUrl"\n\t\t\t\t\tclass="crm-entity-stream-content-delivery-title-logo"\n\t\t\t\t\t:style="{\'background-image\': \'url(\' + deliveryServiceLogoBackgroundUrl + \')\'}"\n\t\t\t\t></div>\n\t\t\t\t<div class="crm-entity-stream-content-delivery-title-info">\n\t\t\t\t\t<div class="crm-entity-stream-content-delivery-title-name">\n\t\t\t\t\t\t{{deliveryServiceName}}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="isDeliveryServiceProfile"\n\t\t\t\t\t\tclass="crm-entity-stream-content-delivery-title-param"\n\t\t\t\t\t>\n\t\t\t\t\t\t{{deliveryProfileServiceName}}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'};var component$2=ui_vue.Vue.extend({mixins:[HistoryItemMixin],components:{author:Author,"delivery-service-info":DeliveryServiceInfo},props:{mode:{required:true,type:String}},data:function t(){return{entityData:null,deliveryInfo:null,isRefreshing:false,isCreatingRequest:false,isCancellingRequest:false}},methods:{completeActivity:function t(){if(this.self.canComplete()){this.self.setAsDone(!this.self.isDone())}},showContextMenu:function t(e){var i=this;var s=BX.PopupMenu.create("taxi_activity_context_menu_"+this.self.getId(),e.target,[{id:"delete",text:this.getLangMessage("menuDelete"),onclick:function t(){s.close();var e="entity_timeline_deletion_"+i.self.getId()+"_confirm";var n=BX.Crm.ConfirmationDialog.get(e);if(!n){n=BX.Crm.ConfirmationDialog.create(e,{title:i.getLangMessage("removeConfirmTitle"),content:i.getLangMessage("deliveryRemove")})}n.open().then((function(t){if(t.cancel){return}i.self.remove()}),(function(t){}))}}],{autoHide:true,offsetTop:0,offsetLeft:16,angle:{position:"top",offset:0},events:{onPopupShow:function t(){return BX.addClass(e.target,"active")},onPopupClose:function t(){return BX.removeClass(e.target,"active")}}});s.show()},createDeliveryRequest:function t(){var e=this;if(this.isLocked){return}this.isCreatingRequest=true;BX.ajax.runAction("sale.deliveryrequest.create",{analyticsLabel:"saleDeliveryTaxiCall",data:{shipmentIds:this.shipmentIds,additional:{ACTIVITY_ID:this.activityId}}}).then((function(t){e.refresh((function(){e.isCreatingRequest=false}))}))["catch"]((function(t){e.isCreatingRequest=false;e.showError(t.errors.map((function(t){return t.message})).join())}))},cancelDeliveryRequest:function t(){var e=this;if(this.isLocked||!this.deliveryRequest){return}this.isCancellingRequest=true;BX.ajax.runAction("sale.deliveryrequest.execute",{data:{requestId:this.deliveryRequest["ID"],actionType:this.deliveryService["CANCEL_ACTION_CODE"]}}).then((function(t){var i=t.data;BX.ajax.runAction("crm.timeline.deliveryactivity.createcanceldeliveryrequestmessage",{data:{requestId:e.deliveryRequest["ID"],message:i.message}}).then((function(t){BX.ajax.runAction("sale.deliveryrequest.delete",{data:{requestId:e.deliveryRequest["ID"]}}).then((function(t){e.refresh((function(){e.isCancellingRequest=false}))}))["catch"]((function(t){e.isCancellingRequest=false;e.showError(t.errors.map((function(t){return t.message})).join())}))}))}))["catch"]((function(t){e.isCancellingRequest=false;e.showError(t.errors.map((function(t){return t.message})).join())}))},checkRequestStatus:function t(){BX.ajax.runAction("crm.timeline.deliveryactivity.checkrequeststatus")},startCheckingRequestStatus:function t(){var e=this;clearTimeout(this._checkRequestStatusTimeoutId);this._checkRequestStatusTimeoutId=setInterval((function(){return e.checkRequestStatus()}),30*1e3)},stopCheckingRequestStatus:function t(){clearTimeout(this._checkRequestStatusTimeoutId)},setDeliveryInfo:function t(e){this.deliveryInfo=e},refresh:function t(){var e=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(this.isRefreshing){return}this.isRefreshing=true;var s=function t(){e.isRefreshing=false;if(i){i()}};main_core.ajax.runAction("crm.timeline.deliveryactivity.getdeliveryinfo",{data:{activityId:this.activityId}}).then((function(t){e.setDeliveryInfo(t.data);s()}))["catch"]((function(t){s()}))},subscribePullEvents:function t(){var e=this;if(this._isPullSubscribed){return}pull_client.PULL.subscribe({moduleId:"crm",command:"onOrderShipmentSave",callback:function t(i){if(e.shipmentIds.some((function(t){return t==i.FIELDS.ID}))){e.refresh()}}});pull_client.PULL.subscribe({moduleId:"sale",command:"onDeliveryServiceSave",callback:function t(i){if(e.deliveryServiceIds.some((function(t){return t==i.ID}))){e.refresh()}}});pull_client.PULL.subscribe({moduleId:"sale",command:"onDeliveryRequestUpdate",callback:function t(i){if(e.deliveryRequestId==i.ID){e.refresh()}}});pull_client.PULL.subscribe({moduleId:"sale",command:"onDeliveryRequestDelete",callback:function t(i){if(e.deliveryRequestId==i.ID){e.refresh()}}});pull_client.PULL.extendWatch("SALE_DELIVERY_SERVICE");pull_client.PULL.extendWatch("CRM_ENTITY_ORDER_SHIPMENT");pull_client.PULL.extendWatch("SALE_DELIVERY_REQUEST");this._isPullSubscribed=true},callPhone:function t(e){if(this.canUseTelephony&&typeof top.BXIM!=="undefined"){top.BXIM.phoneTo(e)}else{window.location.href="tel:"+e}},isPhone:function t(e){return e.hasOwnProperty("TAGS")&&Array.isArray(e["TAGS"])&&e["TAGS"].includes("phone")},showError:function t(e){BX.loadExt("ui.notification").then((function(){BX.UI.Notification.Center.notify({content:e})}))}},created:function t(){this.entityData=this.self.getAssociatedEntityData();if(this.entityData["DELIVERY_INFO"]){this.setDeliveryInfo(this.entityData["DELIVERY_INFO"])}this.subscribePullEvents();this._checkRequestStatusTimeoutId=null;if(this.needCheckRequestStatus){this.startCheckingRequestStatus()}},computed:{activityId:function t(){return this.data.ASSOCIATED_ENTITY.ID},shipments:function t(){if(this.deliveryInfo&&this.deliveryInfo.hasOwnProperty("SHIPMENTS")&&Array.isArray(this.deliveryInfo["SHIPMENTS"])){return this.deliveryInfo["SHIPMENTS"]}return null},shipmentIds:function t(){return this.shipments?this.shipments.map((function(t){return t["ID"]})):[]},shipment:function t(){if(this.shipments&&Array.isArray(this.shipments)&&this.shipments.length>0){return this.shipments[0]}return null},expectedDeliveryPriceFormatted:function t(){return this.shipment&&this.shipment.hasOwnProperty("BASE_PRICE_DELIVERY")?this.shipment["BASE_PRICE_DELIVERY_FORMATTED"]:this.shipment["PRICE_DELIVERY_FORMATTED"]},deliveryService:function t(){if(this.deliveryInfo&&this.deliveryInfo.hasOwnProperty("DELIVERY_SERVICE")&&babelHelpers["typeof"](this.deliveryInfo["DELIVERY_SERVICE"])==="object"&&this.deliveryInfo["DELIVERY_SERVICE"]!==null){return this.deliveryInfo["DELIVERY_SERVICE"]}return null},deliveryServiceIds:function t(){if(!this.deliveryService){return null}return this.deliveryService.IDS},deliveryRequest:function t(){if(this.deliveryInfo&&this.deliveryInfo.hasOwnProperty("DELIVERY_REQUEST")&&babelHelpers["typeof"](this.deliveryInfo["DELIVERY_REQUEST"])==="object"&&this.deliveryInfo["DELIVERY_REQUEST"]!==null){return this.deliveryInfo["DELIVERY_REQUEST"]}return null},deliveryRequestId:function t(){if(this.deliveryRequest&&this.deliveryRequest.hasOwnProperty("ID")){return this.deliveryRequest["ID"]}return null},deliveryRequestProperties:function t(){if(this.deliveryRequest&&this.deliveryRequest.hasOwnProperty("EXTERNAL_PROPERTIES")&&babelHelpers["typeof"](this.deliveryRequest["EXTERNAL_PROPERTIES"])==="object"&&this.deliveryRequest["EXTERNAL_PROPERTIES"]!==null){return this.deliveryRequest["EXTERNAL_PROPERTIES"]}return null},deliveryRequestStatus:function t(){if(!this.deliveryRequest){return null}return this.deliveryRequest["EXTERNAL_STATUS"]},deliveryRequestStatusSemantic:function t(){if(!this.deliveryRequest){return null}return this.deliveryRequest["EXTERNAL_STATUS_SEMANTIC"]},isConnectedWithDeliveryRequest:function t(){return!!this.deliveryRequest},needCheckRequestStatus:function t(){return this.isConnectedWithDeliveryRequest&&this.mode==="schedule"},isSendRequestButtonVisible:function t(){return!this.isCreatingRequest&&!this.isConnectedWithDeliveryRequest},miscellaneous:function t(){if(this.deliveryInfo&&this.deliveryInfo.hasOwnProperty("MISCELLANEOUS")){return this.deliveryInfo["MISCELLANEOUS"]}return null},canUseTelephony:function t(){return this.miscellaneous&&this.miscellaneous.hasOwnProperty("CAN_USE_TELEPHONY")&&this.miscellaneous["CAN_USE_TELEPHONY"]},template:function t(){if(!this.miscellaneous||!this.miscellaneous.hasOwnProperty("TEMPLATE")){return null}return this.miscellaneous["TEMPLATE"]},cancelRequestButtonStyle:function t(){return{"ui-btn":true,"ui-btn-sm":true,"ui-btn-light-border":true,"ui-btn-wait":this.isCancellingRequest}},statusClass:function t(){return{"crm-entity-stream-content-event-process":this.deliveryRequestStatusSemantic==="process","crm-entity-stream-content-event-missing":this.deliveryRequestStatusSemantic==="error","crm-entity-stream-content-event-done":this.deliveryRequestStatusSemantic==="success"}},wrapperContainerClass:function t(){return{"crm-entity-stream-section-planned":this.mode==="schedule"}},innerWrapperContainerClass:function t(){return{"crm-entity-stream-content-event--delivery":this.mode!=="schedule"}},isLocked:function t(){return this.isRefreshing||this.isCreatingRequest||this.isCancellingRequest}},watch:{needCheckRequestStatus:function t(e){if(e){this.startCheckingRequestStatus()}else{this.stopCheckingRequestStatus()}}},template:'\n\t\t<div\n\t\t\tclass="crm-entity-stream-section crm-entity-stream-section-new"\n\t\t\t:class="wrapperContainerClass"\n\t\t>\n\t\t\t<div class="crm-entity-stream-section-icon crm-entity-stream-section-icon-new crm-entity-stream-section-icon-taxi"></div>\n\t\t\t<div\n\t\t\t\tv-if="mode === \'schedule\'"\n\t\t\t\t@click="showContextMenu"\n\t\t\t\tclass="crm-entity-stream-section-context-menu"\n\t\t\t></div>\n\t\t\t<div class="crm-entity-stream-section-content">\n\t\t\t\t<div\n\t\t\t\t\tclass="crm-entity-stream-content-event"\n\t\t\t\t\t:class="innerWrapperContainerClass"\n\t\t\t\t>\n\t\t\t\t\t<div class="crm-entity-stream-content-header">\n\t\t\t\t\t\t<span class="crm-entity-stream-content-event-title">\n\t\t\t\t\t\t\t'.concat(main_core.Loc.getMessage("TIMELINE_DELIVERY_TAXI_SERVICE"),'\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tv-if="deliveryRequestStatus && deliveryRequestStatusSemantic"\n\t\t\t\t\t\t\t:class="statusClass"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{deliveryRequestStatus}}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span class="crm-entity-stream-content-event-time">{{createdAt}}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="crm-entity-stream-content-detail crm-entity-stream-content-delivery">\n\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-row crm-entity-stream-content-delivery-row--flex">\n\t\t\t\t\t\t\t<template v-if="mode === \'schedule\'">\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tv-if="isSendRequestButtonVisible"\n\t\t\t\t\t\t\t\t\t@click="createDeliveryRequest"\n\t\t\t\t\t\t\t\t\tclass="ui-btn ui-btn-sm ui-btn-primary"\n\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t').concat(main_core.Loc.getMessage("TIMELINE_DELIVERY_CREATE_DELIVERY_REQUEST"),'\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t<span v-if="isCreatingRequest" class="crm-entity-stream-content-delivery-status">\n\t\t\t\t\t\t\t\t\t').concat(main_core.Loc.getMessage("TIMELINE_DELIVERY_CREATING_REQUEST"),'\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tv-if="isConnectedWithDeliveryRequest && deliveryService && deliveryService.IS_CANCELLABLE"\n\t\t\t\t\t\t\t\t\t@click="cancelDeliveryRequest"\n\t\t\t\t\t\t\t\t\t:class="cancelRequestButtonStyle"\n\t\t\t\t\t\t\t\t>\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t{{deliveryService.CANCEL_ACTION_NAME}}\n\t\t\t\t\t\t\t\t</span>\t\t\t\t\t\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t<delivery-service-info\n\t\t\t\t\t\t\t\tv-if="deliveryService"\n\t\t\t\t\t\t\t\t:deliveryService="deliveryService"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t</delivery-service-info>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-row">\n\t\t\t\t\t\t\t<table class="crm-entity-stream-content-delivery-order">\n\t\t\t\t\t\t\t\t<tr v-if="shipment && shipment.ADDRESS_FROM_FORMATTED && shipment.ADDRESS_TO_FORMATTED">\n\t\t\t\t\t\t\t\t\t<td colspan="2">\n\t\t\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-item">\n\t\t\t\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-value crm-entity-stream-content-delivery-order-value--sm">\n\t\t\t\t\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-box">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-box-label">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t').concat(main_core.Loc.getMessage("TIMELINE_DELIVERY_TAXI_ADDRESS_FROM"),'\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span v-html="shipment.ADDRESS_FROM_FORMATTED">\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-box">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-box-label">\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t').concat(main_core.Loc.getMessage("TIMELINE_DELIVERY_TAXI_ADDRESS_TO"),'\n\t\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span v-html="shipment.ADDRESS_TO_FORMATTED">\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\t<tr v-if="shipment">\n\t\t\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-item">\n\t\t\t\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-label">\n\t\t\t\t\t\t\t\t\t\t\t\t').concat(main_core.Loc.getMessage("TIMELINE_DELIVERY_TAXI_CLIENT_DELIVERY_PRICE"),'\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-value crm-entity-stream-content-delivery-order-value--sm">\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tv-html="shipment.PRICE_DELIVERY_FORMATTED"\n\t\t\t\t\t\t\t\t\t\t\t\t\t style="font-size: 14px; color: #333;"\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-item">\n\t\t\t\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-label">\n\t\t\t\t\t\t\t\t\t\t\t\t').concat(main_core.Loc.getMessage("TIMELINE_DELIVERY_TAXI_EXPECTED_DELIVERY_PRICE"),'\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-value crm-entity-stream-content-delivery-order-value--sm">\n\t\t\t\t\t\t\t\t\t\t\t\t<span style="font-size: 14px; color: #333; opacity: .5;">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tv-html="expectedDeliveryPriceFormatted"\n\t\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t<span v-else>\n\t\t\t\t\t\t\t\t\t\t\t\t\t').concat(main_core.Loc.getMessage("TIMELINE_DELIVERY_TAXI_EXPECTED_PRICE_NOT_RECEIVED"),'\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\t\x3c!-- Properties ---\x3e\n\t\t\t\t\t\t\t\t<tr v-for="property in deliveryRequestProperties">\n\t\t\t\t\t\t\t\t\t<td colspan="2">\n\t\t\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-item">\n\t\t\t\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-label">\n\t\t\t\t\t\t\t\t\t\t\t\t{{property.NAME}}\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-value crm-entity-stream-content-delivery-order-value--sm">\n\t\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\t\tv-if="isPhone(property)"\n\t\t\t\t\t\t\t\t\t\t\t\t\t@click="callPhone(property.VALUE)"\n\t\t\t\t\t\t\t\t\t\t\t\t\tclass="crm-entity-stream-content-delivery-link"\n\t\t\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{property.VALUE}}\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t\t<span v-else>\n\t\t\t\t\t\t\t\t\t\t\t\t\t{{property.VALUE}}\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t\t\t\x3c!-- end Properties ---\x3e\n\t\t\t\t\t\t\t</table>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div v-if="mode === \'schedule\'" class="crm-entity-stream-content-detail-planned-action">\n\t\t\t\t\t\t<input @click="completeActivity" type="checkbox" class="crm-entity-stream-planned-apply-btn">\n\t\t\t\t\t</div>\n\t\t\t\t\t<author v-if="author" :author="author">\n\t\t\t\t\t</author>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t')});var component$3=ui_vue.Vue.extend({mixins:[HistoryItemMixin],components:{author:Author,"delivery-service-info":DeliveryServiceInfo},computed:{deliveryService:function t(){if(!this.data.FIELDS.hasOwnProperty("DELIVERY_SERVICE")){return null}return this.data.FIELDS.DELIVERY_SERVICE},messageData:function t(){if(!this.data.FIELDS.hasOwnProperty("MESSAGE_DATA")){return null}return this.data.FIELDS.MESSAGE_DATA},messageTitle:function t(){if(!this.messageData){return null}return this.messageData["TITLE"]},messageDescription:function t(){if(!this.messageData){return null}return this.messageData["DESCRIPTION"]},messageStatus:function t(){if(!this.messageData){return null}return this.messageData["STATUS"]},messageStatusSemantics:function t(){if(!this.messageData){return null}return this.messageData["STATUS_SEMANTIC"]},messageStatusSemanticsClass:function t(){return{"crm-entity-stream-content-event-process":this.messageStatusSemantics==="process","crm-entity-stream-content-event-missing":this.messageStatusSemantics==="error","crm-entity-stream-content-event-done":this.messageStatusSemantics==="success"}}},template:'\n\t\t<div class="crm-entity-stream-section crm-entity-stream-section-new">\n\t\t\t<div class="crm-entity-stream-section-icon crm-entity-stream-section-icon-new crm-entity-stream-section-icon-taxi"></div>\n\t\t\t<div class="crm-entity-stream-section-content">\n\t\t\t\t<div class="crm-entity-stream-content-event">\n\t\t\t\t\t<div class="crm-entity-stream-content-header">\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tv-if="messageTitle"\n\t\t\t\t\t\t\tclass="crm-entity-stream-content-event-title"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{messageTitle}}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tv-if="messageStatus && messageStatusSemantics"\n\t\t\t\t\t\t\t:class="messageStatusSemanticsClass"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{messageStatus}}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span class="crm-entity-stream-content-event-time">\n\t\t\t\t\t\t\t<span v-html="createdAt">\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="crm-entity-stream-content-detail">\n\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-row crm-entity-stream-content-delivery-row--flex">\n\t\t\t\t\t\t\t<delivery-service-info\n\t\t\t\t\t\t\t\tv-if="deliveryService"\n\t\t\t\t\t\t\t\t:deliveryService="deliveryService"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t</delivery-service-info>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-if="messageDescription"\n\t\t\t\t\t\t\tclass="crm-entity-stream-content-delivery-description"\n\t\t\t\t\t\t\tv-html="messageDescription"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<author v-if="author" :author="author">\n\t\t\t\t\t</author>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'});var component$4=ui_vue.Vue.extend({mixins:[HistoryItemMixin],components:{author:Author,"delivery-service-info":DeliveryServiceInfo},computed:{deliveryService:function t(){if(!this.data.FIELDS.hasOwnProperty("DELIVERY_SERVICE")){return null}return this.data.FIELDS.DELIVERY_SERVICE},messageData:function t(){if(!this.data.FIELDS.hasOwnProperty("MESSAGE_DATA")){return null}return this.data.FIELDS.MESSAGE_DATA},messageTitle:function t(){if(!this.messageData){return null}return this.messageData["TITLE"]},messageDescription:function t(){if(!this.messageData){return null}return this.messageData["DESCRIPTION"]},messageStatus:function t(){if(!this.messageData){return null}return this.messageData["STATUS"]},messageStatusSemantics:function t(){if(!this.messageData){return null}return this.messageData["STATUS_SEMANTIC"]},messageStatusSemanticsClass:function t(){return{"crm-entity-stream-content-event-process":this.messageStatusSemantics==="process","crm-entity-stream-content-event-missing":this.messageStatusSemantics==="error","crm-entity-stream-content-event-done":this.messageStatusSemantics==="success"}},addressFrom:function t(){if(!this.data.FIELDS.hasOwnProperty("ADDRESS_FROM_FORMATTED")){return null}return this.data.FIELDS.ADDRESS_FROM_FORMATTED},addressTo:function t(){if(!this.data.FIELDS.hasOwnProperty("ADDRESS_TO_FORMATTED")){return null}return this.data.FIELDS.ADDRESS_TO_FORMATTED}},template:'\n\t\t<div class="crm-entity-stream-section crm-entity-stream-section-new">\n\t\t\t<div class="crm-entity-stream-section-icon crm-entity-stream-section-icon-new crm-entity-stream-section-icon-taxi"></div>\n\t\t\t\n\t\t\t<div class="crm-entity-stream-section-content">\n\t\t\t\t<div class="crm-entity-stream-content-event">\n\t\t\t\t\t<div class="crm-entity-stream-content-header">\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tv-if="messageTitle"\n\t\t\t\t\t\t\tclass="crm-entity-stream-content-event-title"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{messageTitle}}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tv-if="messageStatus && messageStatusSemantics"\n\t\t\t\t\t\t\t:class="messageStatusSemanticsClass"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{{messageStatus}}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span class="crm-entity-stream-content-event-time">\n\t\t\t\t\t\t\t<span v-html="createdAt">\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="crm-entity-stream-content-detail">\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tv-html="messageDescription"\n\t\t\t\t\t\t\tclass="crm-entity-stream-content-detail-description crm-delivery-taxi-caption"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="crm-entity-stream-content-detail-description">\n\t\t\t\t\t\t\t<div v-if="addressFrom" class="crm-entity-stream-content-delivery-order-box">\n\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-box-label">\n\t\t\t\t\t\t\t\t\t'.concat(main_core.Loc.getMessage("TIMELINE_DELIVERY_TAXI_ADDRESS_FROM"),'\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<span>{{addressFrom}}</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div v-if="addressTo" class="crm-entity-stream-content-delivery-order-box">\n\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-delivery-order-box-label">\n\t\t\t\t\t\t\t\t\t').concat(main_core.Loc.getMessage("TIMELINE_DELIVERY_TAXI_ADDRESS_TO"),'\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<span>{{addressTo}}</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<author v-if="author" :author="author">\n\t\t\t\t\t</author>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t')});var Editor=function(){function t(){babelHelpers.classCallCheck(this,t);this._id="";this._settings={};this._manager=null;this._ownerTypeId=0;this._ownerId=0;this._container=null;this._input=null;this._saveButton=null;this._cancelButton=null;this._ghostInput=null;this._saveButtonHandler=BX.delegate(this.onSaveButtonClick,this);this._cancelButtonHandler=BX.delegate(this.onCancelButtonClick,this);this._focusHandler=BX.delegate(this.onFocus,this);this._blurHandler=BX.delegate(this.onBlur,this);this._keyupHandler=BX.delegate(this.resizeForm,this);this._delayedKeyupHandler=BX.delegate((function(){setTimeout(this.resizeForm.bind(this),0)}),this);this._isVisible=true;this._hideButtonsOnBlur=true}babelHelpers.createClass(t,[{key:"initialize",value:function t(e,i){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=i?i:{};this._manager=this.getSetting("manager");if(!(this._manager instanceof Manager)){throw"Editor. Manager instance is not found."}this._ownerTypeId=this.getSetting("ownerTypeId",0);this._ownerId=this.getSetting("ownerId",0);this._container=BX(this.getSetting("container"));this._input=BX(this.getSetting("input"));this._saveButton=BX(this.getSetting("button"));this._cancelButton=BX(this.getSetting("cancelButton"));BX.bind(this._saveButton,"click",this._saveButtonHandler);if(this._cancelButton){BX.bind(this._cancelButton,"click",this._cancelButtonHandler)}BX.bind(this._input,"focus",this._focusHandler);BX.bind(this._input,"blur",this._blurHandler);BX.bind(this._input,"keyup",this._keyupHandler);BX.bind(this._input,"cut",this._delayedKeyupHandler);BX.bind(this._input,"paste",this._delayedKeyupHandler);this.doInitialize()}},{key:"doInitialize",value:function t(){}},{key:"getId",value:function t(){return this._id}},{key:"getSetting",value:function t(e,i){return this._settings.hasOwnProperty(e)?this._settings[e]:i}},{key:"setVisible",value:function t(e){e=!!e;if(this._isVisible===e){return}this._isVisible=e;this._container.style.display=e?"":"none"}},{key:"isVisible",value:function t(){return this._isVisible}},{key:"onFocus",value:function t(e){BX.addClass(this._container,"focus")}},{key:"onBlur",value:function t(e){if(!this._hideButtonsOnBlur){return}if(this._input.value===""){window.setTimeout(BX.delegate((function(){BX.removeClass(this._container,"focus");this._input.style.minHeight=""}),this),200)}}},{key:"onSaveButtonClick",value:function t(e){this.save()}},{key:"onCancelButtonClick",value:function t(){this.cancel();this._manager.processEditingCancellation(this)}},{key:"save",value:function t(){}},{key:"cancel",value:function t(){}},{key:"release",value:function t(){if(this._ghostInput){this._ghostInput=BX.remove(this._ghostInput)}}},{key:"ensureGhostCreated",value:function t(){if(this._ghostInput){return this._ghostInput}this._ghostInput=BX.create("div",{props:{className:"crm-entity-stream-content-new-comment-textarea-shadow"},text:this._input.value});this._ghostInput.style.width=this._input.offsetWidth+"px";document.body.appendChild(this._ghostInput);return this._ghostInput}},{key:"resizeForm",value:function t(){var e=this.ensureGhostCreated();var i=getComputedStyle(this._input);var s=parseInt(i.paddingBottom)+parseInt(i.paddingTop)+parseInt(i.borderTopWidth)+parseInt(i.borderBottomWidth)||0;e.innerHTML=BX.util.htmlspecialchars(this._input.value.replace(/[\r\n]{1}/g,"<br>"));this._input.style.minHeight=e.scrollHeight+s+"px"}}]);return t}();var WaitConfigurationDialog=function(){function t(){babelHelpers.classCallCheck(this,t);this._id="";this._settings={};this._type=Wait.WaitingType.undefined;this._duration=0;this._target="";this._targetDates=null;this._container=null;this._durationMeasureNode=null;this._durationInput=null;this._targetDateNode=null;this._popup=null}babelHelpers.createClass(t,[{key:"initialize",value:function t(e,i){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=i?i:{};this._type=BX.prop.getInteger(this._settings,"type",Wait.WaitingType.after);this._duration=BX.prop.getInteger(this._settings,"duration",1);this._target=BX.prop.getString(this._settings,"target","");this._targetDates=BX.prop.getArray(this._settings,"targetDates",[]);this._menuId=this._id+"_target_date_sel"}},{key:"getId",value:function t(){return this._id}},{key:"getType",value:function t(){return this._type}},{key:"setType",value:function t(e){this._type=e}},{key:"getDuration",value:function t(){return this._duration}},{key:"setDuration",value:function t(e){this._duration=e}},{key:"getTarget",value:function t(){return this._target}},{key:"setTarget",value:function t(e){this._target=e}},{key:"getMessage",value:function e(i){var s=t.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"getDurationText",value:function t(e,i){return Wait.Helper.getDurationText(e,i)}},{key:"getTargetDateCaption",value:function t(e){var i=this._targetDates.length;for(var s=0;s<i;s++){var n=this._targetDates[s];if(n["name"]===e){return n["caption"]}}return""}},{key:"open",value:function t(){this._popup=new BX.PopupWindow(this._id,null,{autoHide:true,draggable:false,bindOptions:{forceBindPosition:false},closeByEsc:true,zIndex:0,content:this.prepareDialogContent(),events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},buttons:[new BX.PopupWindowButton({text:this.getMessage("select"),className:"popup-window-button-accept",events:{click:BX.delegate(this.onSaveButtonClick,this)}}),new BX.PopupWindowButtonLink({text:BX.message("JS_CORE_WINDOW_CANCEL"),events:{click:BX.delegate(this.onCancelButtonClick,this)}})]});this._popup.show()}},{key:"close",value:function t(){if(this._popup){this._popup.close()}}},{key:"prepareDialogContent",value:function t(){var e=BX.create("div",{attrs:{className:"crm-wait-popup-select-block"}});var i=BX.create("div",{attrs:{className:"crm-wait-popup-select-wrapper"}});e.appendChild(i);this._durationInput=BX.create("input",{attrs:{type:"text",className:"crm-wait-popup-settings-input",value:this._duration},events:{keyup:BX.delegate(this.onDurationChange,this)}});this._durationMeasureNode=BX.create("span",{attrs:{className:"crm-wait-popup-settings-title"},text:this.getDurationText(this._duration,false)});if(this._type===Wait.WaitingType.after){i.appendChild(BX.create("span",{attrs:{className:"crm-wait-popup-settings-title"},text:this.getMessage("prefixTypeAfter")}));i.appendChild(this._durationInput);i.appendChild(this._durationMeasureNode)}else{i.appendChild(BX.create("span",{attrs:{className:"crm-wait-popup-settings-title"},text:this.getMessage("prefixTypeBefore")}));i.appendChild(this._durationInput);i.appendChild(this._durationMeasureNode);i.appendChild(BX.create("span",{attrs:{className:"crm-wait-popup-settings-title"},text:" "+this.getMessage("targetPrefixTypeBefore")}));this._targetDateNode=BX.create("span",{attrs:{className:"crm-automation-popup-settings-link"},text:this.getTargetDateCaption(this._target),events:{click:BX.delegate(this.toggleTargetMenu,this)}});i.appendChild(this._targetDateNode)}return e}},{key:"onDurationChange",value:function t(){var e=parseInt(this._durationInput.value);if(isNaN(e)||e<=0){e=1}this._duration=e;this._durationMeasureNode.innerHTML=BX.util.htmlspecialchars(this.getDurationText(e,false))}},{key:"toggleTargetMenu",value:function t(){if(this.isTargetMenuOpened()){this.closeTargetMenu()}else{this.openTargetMenu()}}},{key:"isTargetMenuOpened",value:function t(){return!!BX.PopupMenu.getMenuById(this._menuId)}},{key:"openTargetMenu",value:function t(){var e=[];var i=0;var s=this._targetDates.length;for(;i<s;i++){var n=this._targetDates[i];e.push({text:n["caption"],title:n["caption"],value:n["name"],onclick:BX.delegate(this.onTargetSelect,this)})}BX.PopupMenu.show(this._menuId,this._targetDateNode,e,{zIndex:200,autoHide:true,offsetLeft:BX.pos(this._targetDateNode)["width"]/2,angle:{position:"top",offset:0}})}},{key:"closeTargetMenu",value:function t(){BX.PopupMenu.destroy(this._menuId)}},{key:"onPopupShow",value:function t(e,i){}},{key:"onPopupClose",value:function t(){if(this._popup){this._popup.destroy()}this.closeTargetMenu()}},{key:"onPopupDestroy",value:function t(){if(this._popup){this._popup=null}}},{key:"onSaveButtonClick",value:function t(e){var i=BX.prop.getFunction(this._settings,"onSave",null);if(!i){return}var s={type:this._type};s["duration"]=this._duration;s["target"]=this._type===Wait.WaitingType.before?this._target:"";i(this,s)}},{key:"onCancelButtonClick",value:function t(e){var i=BX.prop.getFunction(this._settings,"onCancel",null);if(i){i(this)}}},{key:"onTargetSelect",value:function t(e,i){var s=BX.prop.getString(i,"value","");if(s!==""){this._target=s;this._targetDateNode.innerHTML=BX.util.htmlspecialchars(this.getTargetDateCaption(s))}this.closeTargetMenu();e.preventDefault?e.preventDefault():e.returnValue=false}}],[{key:"create",value:function e(i,s){var n=new t;n.initialize(i,s);return n}}]);return t}();babelHelpers.defineProperty(WaitConfigurationDialog,"messages",{});var Wait=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._serviceUrl="";t._isRequestRunning=false;t._isLocked=false;t._hideButtonsOnBlur=false;t._type=e.WaitingType.after;t._duration=1;t._target="";t._configContainer=null;t._configSelector=null;t._isMenuShown=false;t._menu=null;t._configDialog=null;return t}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){this._configContainer=BX(this.getSetting("configContainer"));this._serviceUrl=this.getSetting("serviceUrl","");var i=BX.prop.getObject(this._settings,"config",{});this._type=e.WaitingType.resolveTypeId(BX.prop.getString(i,"type",e.WaitingType.names.after));this._duration=BX.prop.getInteger(i,"duration",1);this._target=BX.prop.getString(i,"target","");this._targetDates=BX.prop.getArray(this._settings,"targetDates",[]);this.layoutConfigurationSummary()}},{key:"getDurationText",value:function t(i,s){return e.Helper.getDurationText(i,s)}},{key:"getTargetDateCaption",value:function t(e){var i=0;var s=this._targetDates.length;for(;i<s;i++){var n=this._targetDates[i];if(n["name"]===e){return n["caption"]}}return""}},{key:"onSelectorClick",value:function t(e){if(!this._isMenuShown){this.openMenu()}else{this.closeMenu()}e.preventDefault?e.preventDefault():e.returnValue=false}},{key:"openMenu",value:function t(){if(this._isMenuShown){return}var e=BX.delegate(this.onMenuItemClick,this);var i=[{id:"day_1",text:this.getMessage("oneDay"),onclick:e},{id:"day_2",text:this.getMessage("twoDays"),onclick:e},{id:"day_3",text:this.getMessage("threeDays"),onclick:e},{id:"week_1",text:this.getMessage("oneWeek"),onclick:e},{id:"week_2",text:this.getMessage("twoWeek"),onclick:e},{id:"week_3",text:this.getMessage("threeWeeks"),onclick:e}];var s={id:"custom",text:this.getMessage("custom"),items:[]};s["items"].push({id:"afterDays",text:this.getMessage("afterDays"),onclick:e});if(this._targetDates.length>0){s["items"].push({id:"beforeDate",text:this.getMessage("beforeDate"),onclick:e})}i.push(s);BX.PopupMenu.show(this._id,this._configSelector,i,{offsetTop:0,offsetLeft:36,angle:{position:"top",offset:0},events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this),onPopupDestroy:BX.delegate(this.onMenuDestroy,this)}});this._menu=BX.PopupMenu.currentItem}},{key:"closeMenu",value:function t(){if(!this._isMenuShown){return}if(this._menu){this._menu.close()}}},{key:"onMenuItemClick",value:function t(i,s){this.closeMenu();if(s.id==="afterDays"||s.id==="beforeDate"){this.openConfigDialog(s.id==="afterDays"?e.WaitingType.after:e.WaitingType.before);return}var n={type:e.WaitingType.after};if(s.id==="day_1"){n["duration"]=1}else if(s.id==="day_2"){n["duration"]=2}else if(s.id==="day_3"){n["duration"]=3}if(s.id==="week_1"){n["duration"]=7}else if(s.id==="week_2"){n["duration"]=14}else if(s.id==="week_3"){n["duration"]=21}this.saveConfiguration(n)}},{key:"openConfigDialog",value:function t(e){if(!this._configDialog){this._configDialog=WaitConfigurationDialog.create("",{targetDates:this._targetDates,onSave:BX.delegate(this.onConfigDialogSave,this),onCancel:BX.delegate(this.onConfigDialogCancel,this)})}this._configDialog.setType(e);this._configDialog.setDuration(this._duration);var i=this._target;if(i===""&&this._targetDates.length>0){i=this._targetDates[0]["name"]}this._configDialog.setTarget(i);this._configDialog.open()}},{key:"onConfigDialogSave",value:function t(e,i){this.saveConfiguration(i);this._configDialog.close()}},{key:"onConfigDialogCancel",value:function t(e){this._configDialog.close()}},{key:"onMenuShow",value:function t(){this._isMenuShown=true}},{key:"onMenuClose",value:function t(){if(this._menu&&this._menu.popupWindow){this._menu.popupWindow.destroy()}}},{key:"onMenuDestroy",value:function t(){this._isMenuShown=false;this._menu=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}}},{key:"saveConfiguration",value:function t(i){this._type=BX.prop.getInteger(i,"type",e.WaitingType.after);this._duration=BX.prop.getInteger(i,"duration",0);if(this._duration<=0){this._duration=1}this._target=this._type===e.WaitingType.before?BX.prop.getString(i,"target",""):"";var s=this._manager.getId().toLowerCase();BX.userOptions.save("crm.timeline.wait",s,"type",this._type===e.WaitingType.after?"after":"before");BX.userOptions.save("crm.timeline.wait",s,"duration",this._duration);BX.userOptions.save("crm.timeline.wait",s,"target",this._target);this.layoutConfigurationSummary()}},{key:"getSummaryHtml",value:function t(){if(this._type===e.WaitingType.before){return this.getMessage("completionTypeBefore").replace("#DURATION#",this.getDurationText(this._duration,true)).replace("#TARGET_DATE#",this.getTargetDateCaption(this._target))}return this.getMessage("completionTypeAfter").replace("#DURATION#",this.getDurationText(this._duration,true))}},{key:"getSummaryText",value:function t(){return BX.util.strip_tags(this.getSummaryHtml())}},{key:"layoutConfigurationSummary",value:function t(){this._configContainer.innerHTML=this.getSummaryHtml();this._configSelector=this._configContainer.querySelector("a");if(this._configSelector){BX.bind(this._configSelector,"click",BX.delegate(this.onSelectorClick,this))}}},{key:"postpone",value:function t(e,i,s){BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"POSTPONE_WAIT",DATA:{ID:e,OFFSET:i}},onsuccess:s})}},{key:"complete",value:function t(e,i,s){BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"COMPLETE_WAIT",DATA:{ID:e,COMPLETED:i?"Y":"N"}},onsuccess:s})}},{key:"save",value:function t(){if(this._isRequestRunning||this._isLocked){return}var e=this.getSummaryText();var i=BX.util.trim(this._input.value);if(i!==""){e+="\n"+i}var s={ID:0,typeId:this._type,duration:this._duration,targetFieldName:this._target,subject:"",description:e,completed:0,ownerType:BX.CrmEntityType.resolveName(this._ownerTypeId),ownerID:this._ownerId};BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"SAVE_WAIT",DATA:s},onsuccess:BX.delegate(this.onSaveSuccess,this),onfailure:BX.delegate(this.onSaveFailure,this)});this._isRequestRunning=this._isLocked=true}},{key:"cancel",value:function t(){this._input.value="";this._input.style.minHeight="";this.release()}},{key:"onSaveSuccess",value:function t(e){this._isRequestRunning=this._isLocked=false;var i=BX.prop.getString(e,"ERROR","");if(i!==""){alert(i);return}this._input.value="";this._input.style.minHeight="";this._manager.processEditingCompletion(this);this.release()}},{key:"onSaveFailure",value:function t(){this._isRequestRunning=this._isLocked=false}},{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);this.items[n.getId()]=n;return n}}]);return e}(Editor);babelHelpers.defineProperty(Wait,"WaitingType",{undefined:0,after:1,before:2,names:{after:"after",before:"before"},resolveTypeId:function t(e){if(e===this.names.after){return this.after}else if(e===this.names.before){return this.before}return this.undefined}});babelHelpers.defineProperty(Wait,"messages",{});babelHelpers.defineProperty(Wait,"items",{});babelHelpers.defineProperty(Wait,"Helper",{getDurationText:function t(e,i){i=!!i;var s="";var n="D";if(i){if(e%7===0){e=e/7;n="W"}}if(n==="W"){s=BX.Loc.getMessagePlural("CRM_TIMELINE_WAIT_WEEK",e)}else{s=BX.Loc.getMessagePlural("CRM_TIMELINE_WAIT_DAY",e)}if(i){s=e.toString()+" "+s}return s},getMessage:function t(e){return Wait.Helper.messages.hasOwnProperty(e)?Wait.Helper.messages[e]:e},messages:{}});var Sms=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._history=null;t._serviceUrl="";t._isRequestRunning=false;t._isLocked=false;t._senderId=null;t._from=null;t._commEntityTypeId=null;t._commEntityId=null;t._to=null;t._canUse=null;t._canSendMessage=null;t._manageUrl="";t._senders=[];t._fromList=[];t._toList=[];t._defaults={};t._communications=[];t._menu=null;t._isMenuShown=false;t._shownMenuId=null;t._documentSelector=null;t._source=null;t._paymentId=null;t._shipmentId=null;t._templateId=null;t._templatesContainer=null;t._templateFieldHintNode=null;t._templateSelectorNode=null;t._templateTemplateTitleNode=null;t._templatePreviewNode=null;t._templateSelectorMenuId="CrmTimelineSmsEditorTemplateSelector";t._templateFieldHintHandler=BX.delegate(t.onTemplateHintIconClick,babelHelpers.assertThisInitialized(t));t._templateSeletorClickHandler=BX.delegate(t.onTemplateSelectClick,babelHelpers.assertThisInitialized(t));t._selectTemplateHandler=BX.delegate(t.onSelectTemplate,babelHelpers.assertThisInitialized(t));return t}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){this._serviceUrl=BX.util.remove_url_param(this.getSetting("serviceUrl",""),["sessid","site"]);var e=BX.prop.getObject(this._settings,"config",{});this._canUse=BX.prop.getBoolean(e,"canUse",false);this._canSendMessage=BX.prop.getBoolean(e,"canSendMessage",false);this._manageUrl=BX.prop.getString(e,"manageUrl","");this._senders=BX.prop.getArray(e,"senders",[]);this._defaults=BX.prop.getObject(e,"defaults",{senderId:null,from:null});this._communications=BX.prop.getArray(e,"communications",[]);this._isSalescenterEnabled=BX.prop.getBoolean(e,"isSalescenterEnabled",false);this._isDocumentsEnabled=BX.prop.getBoolean(e,"isDocumentsEnabled",false);if(this._isDocumentsEnabled){this._documentsProvider=BX.prop.getString(e,"documentsProvider","");this._documentsValue=BX.prop.getString(e,"documentsValue","")}this._isFilesEnabled=BX.prop.getBoolean(e,"isFilesEnabled",false);if(this._isFilesEnabled){this._diskUrls=BX.prop.getObject(e,"diskUrls");this._isFilesExternalLinkEnabled=BX.prop.getBoolean(e,"isFilesExternalLinkEnabled",true)}this._senderSelectorNode=this._container.querySelector('[data-role="sender-selector"]');this._fromContainerNode=this._container.querySelector('[data-role="from-container"]');this._fromSelectorNode=this._container.querySelector('[data-role="from-selector"]');this._clientContainerNode=this._container.querySelector('[data-role="client-container"]');this._clientSelectorNode=this._container.querySelector('[data-role="client-selector"]');this._toSelectorNode=this._container.querySelector('[data-role="to-selector"]');this._messageLengthCounterWrapperNode=this._container.querySelector('[data-role="message-length-counter-wrap"]');this._messageLengthCounterNode=this._container.querySelector('[data-role="message-length-counter"]');this._salescenterStarter=this._container.querySelector('[data-role="salescenter-starter"]');this._smsDetailSwitcher=this._container.querySelector('[data-role="sms-detail-switcher"]');this._smsDetail=this._container.querySelector('[data-role="sms-detail"]');this._documentSelectorButton=this._container.querySelector('[data-role="sms-document-selector"]');this._fileSelectorButton=this._container.querySelector('[data-role="sms-file-selector"]');this._fileUploadZone=this._container.querySelector('[data-role="sms-file-upload-zone"]');this._fileUploadLabel=this._container.querySelector('[data-role="sms-file-upload-label"]');this._fileSelectorBitrix=this._container.querySelector('[data-role="sms-file-selector-bitrix"]');this._fileExternalLinkDisabledContent=this._container.querySelector('[data-role="sms-file-external-link-disabled"]');this._templatesContainer=BX(this.getSetting("templatesContainer"));if(this._templatesContainer){this._templateFieldHintNode=this._templatesContainer.querySelector('[data-role="hint"]');this._templateSelectorNode=this._templatesContainer.querySelector('[data-role="template-selector"]');this._templateTemplateTitleNode=this._templatesContainer.querySelector('[data-role="template-title"]');this._templatePreviewNode=this._templatesContainer.querySelector('[data-role="preview"]')}if(this._templateFieldHintNode){BX.bind(this._templateFieldHintNode,"click",this._templateFieldHintHandler)}if(this._templateSelectorNode){BX.bind(this._templateSelectorNode,"click",this._templateSeletorClickHandler)}if(this._canUse&&this._senders.length>0){this.initSenderSelector()}if(this._canUse&&this._canSendMessage){this.initDetailSwitcher();this.initFromSelector();this.initClientContainer();this.initClientSelector();this.initToSelector();this.initMessageLengthCounter();this.setMessageLengthCounter();if(this._isDocumentsEnabled){this.initDocumentSelector()}if(this._isFilesEnabled){this.initFileSelector()}}if(this._isSalescenterEnabled){this.initSalescenterApplication()}}},{key:"initDetailSwitcher",value:function t(){BX.bind(this._smsDetailSwitcher,"click",function(){if(this._smsDetail.classList.contains("hidden")){this._smsDetail.classList.remove("hidden");this._smsDetailSwitcher.innerText=BX.message("CRM_TIMELINE_COLLAPSE")}else{this._smsDetail.classList.add("hidden");this._smsDetailSwitcher.innerText=BX.message("CRM_TIMELINE_DETAILS")}}.bind(this))}},{key:"initSenderSelector",value:function t(){var e=this._defaults.senderId;var i=this._senders[0].canUse?this._senders[0]:null;var s=null;var n=[];var a=this.onSenderSelectorClick.bind(this);for(var r=0;r<this._senders.length;++r){if(this._senders[r].canUse&&this._senders[r].fromList.length&&(this._senders[r].id===e||!i)){i=this._senders[r]}if(this._senders[r].id==="rest"){s=this._senders[r];continue}n.push({text:this._senders[r].name,sender:this._senders[r],onclick:a,className:!this._senders[r].canUse||!this._senders[r].fromList.length?"crm-timeline-popup-menu-item-disabled menu-popup-no-icon":""})}if(s){if(s.fromList.length>0){n.push({delimiter:true});for(var o=0;o<s.fromList.length;++o){n.push({text:s.fromList[o].name,sender:s,from:s.fromList[o],onclick:a})}}n.push({delimiter:true},{text:BX.message("CRM_TIMELINE_SMS_REST_MARKETPLACE"),href:"/marketplace/category/crm_robot_sms/",target:"_blank"})}if(i){this.setSender(i)}BX.bind(this._senderSelectorNode,"click",this.openMenu.bind(this,"sender",this._senderSelectorNode,n))}},{key:"onSenderSelectorClick",value:function t(e,i){if(i.sender){if(!i.sender.canUse||!i.sender.fromList.length){var s=BX.Uri.addParam(i.sender.manageUrl,{IFRAME:"Y"});var n=BX.SidePanel.Instance.getTopSlider();var a={events:{onClose:function t(){if(n){n.reload()}},onCloseComplete:function t(){if(!n){document.location.reload()}}}};if(i.sender.id==="ednaru"){a.width=700}BX.SidePanel.Instance.open(s,a);return}this.setSender(i.sender,true);var r=i.from?i.from:i.sender.fromList[0];this.setFrom(r,true)}this._menu.close()}},{key:"setSender",value:function t(e,i){this._senderId=e.id;this._fromList=e.fromList;this._senderSelectorNode.textContent=e.shortName?e.shortName:e.name;this._templateId=null;if(e.isTemplatesBased){this.showNode(this._templatesContainer);this.hideNode(this._messageLengthCounterWrapperNode);this.hideNode(this._fileSelectorButton);this.hideNode(this._documentSelectorButton);this.hideNode(this._input);this.toggleTemplateSelectAvailability();this.toggleSaveButton();this._hideButtonsOnBlur=false;this.onFocus()}else{this.hideNode(this._templatesContainer);this.showNode(this._messageLengthCounterWrapperNode);this.showNode(this._fileSelectorButton);this.showNode(this._documentSelectorButton);this.showNode(this._input);this.setMessageLengthCounter();this._hideButtonsOnBlur=true}var s=e.id==="rest"?"hide":"show";BX[s](this._fromContainerNode);if(i){BX.userOptions.save("crm","sms_manager_editor","senderId",this._senderId)}}},{key:"showNode",value:function t(e){if(e){e.style.display=""}}},{key:"hideNode",value:function t(e){if(e){e.style.display="none"}}},{key:"initFromSelector",value:function t(){if(this._fromList.length>0){var e=this._defaults.from||this._fromList[0].id;var i=null;for(var s=0;s<this._fromList.length;++s){if(this._fromList[s].id===e||!i){i=this._fromList[s]}}if(i){this.setFrom(i)}}BX.bind(this._fromSelectorNode,"click",this.onFromSelectorClick.bind(this))}},{key:"onFromSelectorClick",value:function t(e){var i=[];var s=this.onFromSelectorItemClick.bind(this);for(var n=0;n<this._fromList.length;++n){i.push({text:this._fromList[n].name,from:this._fromList[n],onclick:s})}this.openMenu("from_"+this._senderId,this._fromSelectorNode,i,e)}},{key:"onFromSelectorItemClick",value:function t(e,i){if(i.from){this.setFrom(i.from,true)}this._menu.close()}},{key:"setFrom",value:function t(e,i){this._from=e.id;if(this._senderId==="rest"){this._senderSelectorNode.textContent=e.name}else{this._fromSelectorNode.textContent=e.name}if(i){BX.userOptions.save("crm","sms_manager_editor","from",this._from)}}},{key:"initClientContainer",value:function t(){if(this._communications.length===0){BX.hide(this._clientContainerNode)}}},{key:"initClientSelector",value:function t(){var e=[];var i=this.onClientSelectorClick.bind(this);for(var s=0;s<this._communications.length;++s){e.push({text:this._communications[s].caption,client:this._communications[s],onclick:i});if(s===0){this.setClient(this._communications[s])}}BX.bind(this._clientSelectorNode,"click",this.openMenu.bind(this,"comm",this._clientSelectorNode,e))}},{key:"onClientSelectorClick",value:function t(e,i){if(i.client){this.setClient(i.client)}this._menu.close()}},{key:"setClient",value:function t(e){this._commEntityTypeId=e.entityTypeId;this._commEntityId=e.entityId;this._clientSelectorNode.textContent=e.caption;this._toList=e.phones;this.setTo(e.phones[0])}},{key:"initToSelector",value:function t(){BX.bind(this._toSelectorNode,"click",this.onToSelectorClick.bind(this))}},{key:"onToSelectorClick",value:function t(e){var i=[];var s=this.onToSelectorItemClick.bind(this);for(var n=0;n<this._toList.length;++n){i.push({text:this._toList[n].valueFormatted||this._toList[n].value,to:this._toList[n],onclick:s})}this.openMenu("to_"+this._commEntityTypeId+"_"+this._commEntityId,this._toSelectorNode,i,e)}},{key:"onToSelectorItemClick",value:function t(e,i){if(i.to){this.setTo(i.to)}this._menu.close()}},{key:"setTo",value:function t(e){this._to=e.value;this._toSelectorNode.textContent=e.valueFormatted||e.value}},{key:"openMenu",value:function t(e,i,s,n){if(this._shownMenuId===e){return}if(this._shownMenuId!==null&&this._menu){this._menu.close();this._shownMenuId=null}BX.PopupMenu.show(this._id+e,i,s,{offsetTop:0,offsetLeft:36,angle:{position:"top",offset:0},events:{onPopupClose:BX.delegate(this.onMenuClose,this)}});this._menu=BX.PopupMenu.currentItem;n.preventDefault()}},{key:"onMenuClose",value:function t(){this._shownMenuId=null;this._menu=null}},{key:"initMessageLengthCounter",value:function t(){this._messageLengthMax=parseInt(this._messageLengthCounterNode.getAttribute("data-length-max"));BX.bind(this._input,"keyup",this.setMessageLengthCounter.bind(this));BX.bind(this._input,"cut",this.setMessageLengthCounterDelayed.bind(this));BX.bind(this._input,"paste",this.setMessageLengthCounterDelayed.bind(this))}},{key:"setMessageLengthCounterDelayed",value:function t(){setTimeout(this.setMessageLengthCounter.bind(this),0)}},{key:"setMessageLengthCounter",value:function t(){var e=this._input.value.length;this._messageLengthCounterNode.textContent=e;var i=e>=this._messageLengthMax?"addClass":"removeClass";BX[i](this._messageLengthCounterNode,"crm-entity-stream-content-sms-symbol-counter-number-overhead");this.toggleSaveButton()}},{key:"toggleSaveButton",value:function t(){var e=this.getSelectedSender();var i;if(!e||!e.isTemplatesBased){i=this._input.value.length>0}else{i=!!this._templateId}if(i){BX.removeClass(this._saveButton,"ui-btn-disabled")}else{BX.addClass(this._saveButton,"ui-btn-disabled")}}},{key:"save",value:function t(){var e=this.getSelectedSender();var i="";var s="";if(!e||!e.isTemplatesBased){i=this._input.value;if(i===""){return}}else{var n=this.getSelectedTemplate();if(!n){return}i=n.PREVIEW;s=n.ID}if(!this._communications.length){alert(BX.message("CRM_TIMELINE_SMS_ERROR_NO_COMMUNICATIONS"));return}if(this._isRequestRunning||this._isLocked){return}this._isRequestRunning=this._isLocked=true;BX.ajax({url:BX.util.add_url_param(this._serviceUrl,{action:"save_sms_message",sender:this._senderId}),method:"POST",dataType:"json",data:{site:BX.message("SITE_ID"),sessid:BX.bitrix_sessid(),source:this._source,ACTION:"SAVE_SMS_MESSAGE",SENDER_ID:this._senderId,MESSAGE_FROM:this._from,MESSAGE_TO:this._to,MESSAGE_BODY:i,MESSAGE_TEMPLATE:s,OWNER_TYPE_ID:this._ownerTypeId,OWNER_ID:this._ownerId,TO_ENTITY_TYPE_ID:this._commEntityTypeId,TO_ENTITY_ID:this._commEntityId,PAYMENT_ID:this._paymentId,SHIPMENT_ID:this._shipmentId},onsuccess:BX.delegate(this.onSaveSuccess,this),onfailure:BX.delegate(this.onSaveFailure,this)})}},{key:"cancel",value:function t(){this._input.value="";this.setMessageLengthCounter();this._input.style.minHeight="";this.release()}},{key:"onSaveSuccess",value:function t(e){this._isRequestRunning=this._isLocked=false;var i=BX.prop.getString(e,"ERROR","");if(i!==""){alert(i);return}this._input.value="";this.setMessageLengthCounter();this._input.style.minHeight="";this._manager.processEditingCompletion(this);this.release()}},{key:"onSaveFailure",value:function t(){this._isRequestRunning=this._isLocked=false}},{key:"initSalescenterApplication",value:function t(){BX.bind(this._salescenterStarter,"click",this.startSalescenterApplication.bind(this))}},{key:"startSalescenterApplication",value:function t(){BX.loadExt("salescenter.manager").then(function(){BX.Salescenter.Manager.openApplication({disableSendButton:this._canSendMessage?"":"y",context:"sms",ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,mode:this._ownerTypeId===BX.CrmEntityType.enumeration.deal?"payment_delivery":"payment"}).then(function(t){if(t&&t.get("action")){if(t.get("action")==="sendPage"&&t.get("page")&&t.get("page").url){this._input.focus();this._input.value=this._input.value+t.get("page").name+" "+t.get("page").url;this.setMessageLengthCounter()}else if(t.get("action")==="sendPayment"&&t.get("order")){this._input.focus();this._input.value=this._input.value+t.get("order").title;this.setMessageLengthCounter();this._source="order";this._paymentId=t.get("order").paymentId;this._shipmentId=t.get("order").shipmentId}}}.bind(this))}.bind(this))}},{key:"initDocumentSelector",value:function t(){BX.bind(this._documentSelectorButton,"click",this.onDocumentSelectorClick.bind(this))}},{key:"onDocumentSelectorClick",value:function t(){if(!this._documentSelector){BX.loadExt("documentgenerator.selector").then(function(){this._documentSelector=new BX.DocumentGenerator.Selector.Menu({node:this._documentSelectorButton,moduleId:"crm",provider:this._documentsProvider,value:this._documentsValue,analyticsLabelPrefix:"crmTimelineSmsEditor"});this.selectPublicUrl()}.bind(this))}else{this.selectPublicUrl()}}},{key:"selectPublicUrl",value:function t(){if(!this._documentSelector){return}this._documentSelector.show().then(function(t){if(t instanceof BX.DocumentGenerator.Selector.Template){this._documentSelector.createDocument(t).then(function(t){this.pasteDocumentUrl(t)}.bind(this))["catch"](function(t){console.error(t)}.bind(this))}else if(t instanceof BX.DocumentGenerator.Selector.Document){this.pasteDocumentUrl(t)}}.bind(this))["catch"](function(t){console.error(t)}.bind(this))}},{key:"pasteDocumentUrl",value:function t(e){this._documentSelector.getDocumentPublicUrl(e).then(function(t){this._input.focus();this._input.value=this._input.value+" "+e.getTitle()+" "+t;this.setMessageLengthCounter();this._source="document"}.bind(this))["catch"](function(t){console.error(t)}.bind(this))}},{key:"initFileSelector",value:function t(){BX.bind(this._fileSelectorButton,"click",this.onFileSelectorClick.bind(this))}},{key:"closeFileSelector",value:function t(){BX.PopupMenu.destroy("sms-file-selector")}},{key:"onFileSelectorClick",value:function t(){BX.PopupMenu.show("sms-file-selector",this._fileSelectorButton,[{text:BX.message("CRM_TIMELINE_SMS_UPLOAD_FILE"),onclick:this.uploadFile.bind(this),className:this._isFilesExternalLinkEnabled?"":"crm-entity-stream-content-sms-menu-item-with-lock"},{text:BX.message("CRM_TIMELINE_SMS_FIND_FILE"),onclick:this.findFile.bind(this),className:this._isFilesExternalLinkEnabled?"":"crm-entity-stream-content-sms-menu-item-with-lock"}])}},{key:"getFileUploadInput",value:function t(){return document.getElementById(this._fileUploadLabel.getAttribute("for"))}},{key:"uploadFile",value:function t(){this.closeFileSelector();if(this._isFilesExternalLinkEnabled){this.initDiskUF();BX.fireEvent(this.getFileUploadInput(),"click")}else{this.showFilesExternalLinkFeaturePopup()}}},{key:"findFile",value:function t(){this.closeFileSelector();if(this._isFilesExternalLinkEnabled){this.initDiskUF();BX.fireEvent(this._fileSelectorBitrix,"click")}else{this.showFilesExternalLinkFeaturePopup()}}},{key:"getLoader",value:function t(){if(!this.loader){this.loader=new BX.Loader({size:50})}return this.loader}},{key:"showLoader",value:function t(e){if(e&&!this.getLoader().isShown()){this.getLoader().show(e)}}},{key:"hideLoader",value:function t(){if(this.getLoader().isShown()){this.getLoader().hide()}}},{key:"initDiskUF",value:function t(){if(this.isDiskFileUploaderInited||!this._isFilesEnabled){return}this.isDiskFileUploaderInited=true;BX.addCustomEvent(this._fileUploadZone,"OnFileUploadSuccess",this.OnFileUploadSuccess.bind(this));BX.addCustomEvent(this._fileUploadZone,"DiskDLoadFormControllerInit",function(t){t._onUploadProgress=function(){this.showLoader(this._fileSelectorButton.parentNode.parentNode)}.bind(this)}.bind(this));BX.Disk.UF.add({UID:this._fileUploadZone.getAttribute("data-node-id"),controlName:this._fileUploadLabel.getAttribute("for"),hideSelectDialog:false,urlSelect:this._diskUrls.urlSelect,urlRenameFile:this._diskUrls.urlRenameFile,urlDeleteFile:this._diskUrls.urlDeleteFile,urlUpload:this._diskUrls.urlUpload});BX.onCustomEvent(this._fileUploadZone,"DiskLoadFormController",["show"])}},{key:"OnFileUploadSuccess",value:function t(e,i,s,n){this.hideLoader();var a=parseInt(e.element_id.replace("n",""));var r=e.element_name;this.pasteFileUrl(a,r)}},{key:"pasteFileUrl",value:function t(e,i){this.showLoader(this._fileSelectorButton.parentNode.parentNode);BX.ajax.runAction("disk.file.generateExternalLink",{analyticsLabel:"crmTimelineSmsEditorGetFilePublicUrl",data:{fileId:e}}).then(function(t){this.hideLoader();if(t.data.externalLink&&t.data.externalLink.link){this._input.focus();this._input.value=this._input.value+" "+i+" "+t.data.externalLink.link;this.setMessageLengthCounter();this._source="file"}}.bind(this))["catch"]((function(t){console.error(t.errors.pop().message)}))}},{key:"getFeaturePopup",value:function t(e){if(this.featurePopup!=null){return this.featurePopup}this.featurePopup=new BX.PopupWindow("bx-popup-crm-sms-editor-feature-popup",null,{zIndex:200,autoHide:true,closeByEsc:true,closeIcon:true,overlay:true,events:{onPopupDestroy:function(){this.featurePopup=null}.bind(this)},content:e,contentColor:"white"});return this.featurePopup}},{key:"showFilesExternalLinkFeaturePopup",value:function t(){this.getFeaturePopup(this._fileExternalLinkDisabledContent).show()}},{key:"onTemplateHintIconClick",value:function t(){if(this._senderId==="ednaru"){top.BX.Helper.show("redirect=detail&code=14214014")}}},{key:"showTemplateSelectDropdown",value:function t(e){var i=[];if(BX.Type.isArray(e)){if(e.length){e.forEach(function(t){i.push({value:t.ID,text:t.TITLE,onclick:this._selectTemplateHandler})}.bind(this));BX.PopupMenu.show({id:this._templateSelectorMenuId,bindElement:this._templateSelectorNode,items:i,angle:false,width:this._templateSelectorNode.offsetWidth})}}else if(this._senderId){var s=this._templateSelectorMenuId+"loader";var n=this._templateSelectorMenuId+"loader";BX.PopupMenu.show({id:s,bindElement:this._templateSelectorNode,items:[{html:'<div id="'+n+'"></div>'}],angle:false,width:this._templateSelectorNode.offsetWidth,height:60,events:{onDestroy:function(){this.hideLoader()}.bind(this)}});this.showLoader(BX(n));if(!this._isRequestRunning){this._isRequestRunning=true;var a=this._senderId;BX.ajax.runAction("messageservice.Sender.getTemplates",{data:{id:a,context:{module:"crm",entityTypeId:this._manager._ownerTypeId,entityId:this._manager._ownerId}}}).then(function(t){this._isRequestRunning=false;var e=this._senders.find(function(t){return t.id===a}.bind(this));if(e){e.templates=t.data.templates;this.toggleTemplateSelectAvailability();if(BX.PopupMenu.getMenuById(s)){BX.PopupMenu.getMenuById(s).close();this.showTemplateSelectDropdown(e.templates)}}}.bind(this))["catch"](function(t){this._isRequestRunning=false;if(BX.PopupMenu.getMenuById(s)){if(t&&t.errors&&t.errors[0]&&t.errors[0].message){alert(t.errors[0].message)}BX.PopupMenu.getMenuById(s).close()}}.bind(this))}}}},{key:"getSelectedSender",value:function t(){return this._senders.find(function(t){return t.id===this._senderId}.bind(this))}},{key:"getSelectedTemplate",value:function t(){var e=this.getSelectedSender();if(!this._templateId||!e||!e.templates){return null}var i=e.templates.find(function(t){return t.ID==this._templateId}.bind(this));return i?i:null}},{key:"onTemplateSelectClick",value:function t(){var e=this.getSelectedSender();if(e){this.showTemplateSelectDropdown(e.templates)}}},{key:"onSelectTemplate",value:function t(e,i){this._templateId=i.value;this.applySelectedTemplate();this.toggleSaveButton();var s=BX.PopupMenu.getMenuById(this._templateSelectorMenuId);if(s){s.close()}}},{key:"toggleTemplateSelectAvailability",value:function t(){var e=this.getSelectedSender();if(e&&BX.Type.isArray(e.templates)&&!e.templates.length){BX.addClass(this._templateSelectorNode,"ui-ctl-disabled");this._templateTemplateTitleNode.textContent=BX.message("CRM_TIMELINE_SMS_TEMPLATES_NOT_FOUND")}else{BX.removeClass(this._templateSelectorNode,"ui-ctl-disabled");this.applySelectedTemplate()}}},{key:"applySelectedTemplate",value:function t(){var e=this.getSelectedSender();if(!this._templateId||!e||!e.templates){this.hideNode(this._templatePreviewNode);this._templateTemplateTitleNode.textContent=""}else{var i=this.getSelectedTemplate();if(i){var s=BX.Text.encode(i.PREVIEW).replace(/\n/g,"<br>");this.showNode(this._templatePreviewNode);this._templatePreviewNode.innerHTML=s;this._templateTemplateTitleNode.textContent=i.TITLE}else{this.hideNode(this._templatePreviewNode);this._templateTemplateTitleNode.textContent=""}}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);e.items[n.getId()]=n;return n}}]);return e}(Editor);babelHelpers.defineProperty(Sms,"items",{});var Rest=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._interfaceInitialized=false;return t}babelHelpers.createClass(e,[{key:"action",value:function t(e){if(!this._interfaceInitialized){this._interfaceInitialized=true;this.initializeInterface()}if(e==="activity_rest_applist"){BX.rest.Marketplace.open({PLACEMENT:this.getSetting("placement","")});top.BX.addCustomEvent(top,"Rest:AppLayout:ApplicationInstall",BX.proxy(this.fireUpdateEvent,this))}else{var i=e.replace("activity_rest_","");var s=i.split("_");BX.rest.AppLayout.openApplication(s[0],{ID:this._ownerId},{PLACEMENT:this.getSetting("placement",""),PLACEMENT_ID:s[1]})}}},{key:"initializeInterface",value:function t(){if(!!top.BX.rest&&!!top.BX.rest.AppLayout){var e=this._manager._ownerTypeId,i=this._manager._ownerId;var s=top.BX.rest.AppLayout.initializePlacement(this.getSetting("placement",""));s.prototype.reloadData=function(t,s){BX.Crm.EntityEvent.fireUpdate(e,i,"");s()}}}},{key:"fireUpdateEvent",value:function t(){var e=this._manager._ownerTypeId,i=this._manager._ownerId;setTimeout((function(){console.log("fireUpdate",i,e);BX.Crm.EntityEvent.fire(BX.Crm.EntityEvent.names.invalidate,e,i,"")}),3e3)}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);e.items[n.getId()]=n;return n}}]);return e}(Editor);babelHelpers.defineProperty(Rest,"items",{});var Comment=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._history=null;t._serviceUrl="";t._postForm=null;t._editor=null;t._isRequestRunning=false;t._isLocked=false;return t}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){this._serviceUrl=this.getSetting("serviceUrl","");BX.unbind(this._input,"blur",this._blurHandler);BX.unbind(this._input,"keyup",this._keyupHandler)}},{key:"loadEditor",value:function t(){this._editorName="CrmTimeLineComment0";if(this._postForm)return;BX.ajax.runAction("crm.api.timeline.loadEditor",{data:{name:this._editorName}}).then(this.onLoadEditorSuccess.bind(this))}},{key:"onLoadEditorSuccess",value:function t(e){var i=BX.prop.getString(BX.prop.getObject(e,"data",{}),"html","");BX.html(this._editorContainer,i).then(BX.delegate(this.showEditor,this)).then(BX.delegate(this.addEvents,this))}},{key:"addEvents",value:function t(){BX.addCustomEvent(this._editorContainer.firstElementChild,"onFileIsAppended",BX.delegate((function(t,e){BX.addClass(this._saveButton,"ui-btn-disabled");BX.addClass(this._saveButton,"ui-btn-clock");this._saveButton.removeEventListener("click",this._saveButtonHandler)}),this));BX.addCustomEvent(this._editorContainer.firstElementChild,"onFileIsAdded",BX.delegate((function(t,e,i,s){BX.removeClass(this._saveButton,"ui-btn-clock");BX.removeClass(this._saveButton,"ui-btn-disabled");this._saveButton.addEventListener("click",this._saveButtonHandler)}),this))}},{key:"showEditor",value:function t(){if(LHEPostForm){window.setTimeout(BX.delegate((function(){this._postForm=LHEPostForm.getHandler(this._editorName);this._editor=BXHtmlEditor.Get(this._editorName);BX.onCustomEvent(this._postForm.eventNode,"OnShowLHE",[true])}),this),100)}}},{key:"getHistory",value:function t(){return this._history}},{key:"setHistory",value:function t(e){this._history=e}},{key:"onFocus",value:function t(e){this._input.style.display="none";if(this._editor&&this._postForm){this._postForm.eventNode.style.display="block";this._editor.Focus()}else{if(!BX.type.isDomNode(this._editorContainer)){this._editorContainer=BX.create("div",{attrs:{className:"crm-entity-stream-section-comment-editor"}});this._editorContainer.appendChild(BX.create("DIV",{attrs:{className:"crm-timeline-wait"}}));this._container.appendChild(this._editorContainer)}window.setTimeout(BX.delegate((function(){this.loadEditor()}),this),100)}BX.addClass(this._container,"focus")}},{key:"save",value:function t(){var e="";var i=[];if(this._postForm){e=this._postForm.oEditor.GetContent();this._postForm.eventNode.querySelectorAll('input[name="UF_CRM_COMMENT_FILES[]"]').forEach((function(t){i.push(t.value)}))}else{e=this._input.value}if(e===""){if(!this.emptyCommentMessage){this.emptyCommentMessage=new BX.PopupWindow("timeline_empty_new_comment_"+this._ownerId,this._saveButton,{content:BX.message("CRM_TIMELINE_EMPTY_COMMENT_MESSAGE"),darkMode:true,autoHide:true,zIndex:990,angle:{position:"top",offset:77},closeByEsc:true,bindOptions:{forceBindPosition:true}})}this.emptyCommentMessage.show();return}if(this._isRequestRunning||this._isLocked){return}this._isRequestRunning=this._isLocked=true;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"SAVE_COMMENT",TEXT:e,OWNER_TYPE_ID:this._ownerTypeId,OWNER_ID:this._ownerId,ATTACHMENTS:i},onsuccess:BX.delegate(this.onSaveSuccess,this),onfailure:BX.delegate(this.onSaveFailure,this)})}},{key:"cancel",value:function t(){this._input.value="";this._input.style.minHeight="";if(BX.type.isDomNode(this._editorContainer))this._postForm.eventNode.style.display="none";this._input.style.display="block";BX.removeClass(this._container,"focus");this.release()}},{key:"onSaveSuccess",value:function t(e){this._isRequestRunning=false;if(this._postForm){this._postForm.reinit("",{})}this.cancel();var i=BX.prop.getObject(e,"HISTORY_ITEM");var s=this._history.createItem(i);this._history.addItem(s,0);var n=this._history.createAnchor();s.layout({anchor:n});var a=BX.CrmCommentAnimation.create(s.getWrapper(),n,BX.pos(this._input),{start:BX.delegate(this.onAnimationStart,this),complete:BX.delegate(this.onAnimationComplete,this)});a.run()}},{key:"onSaveFailure",value:function t(){this._isRequestRunning=this._isLocked=false}},{key:"onAnimationStart",value:function t(){this._input.value=""}},{key:"onAnimationComplete",value:function t(){this._isLocked=false;BX.removeClass(this._container,"focus");this._input.style.minHeight="";this._manager.processEditingCompletion(this);this.release();this._history._anchor=null;this._history.refreshLayout()}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);e.items[n.getId()]=n;return n}}]);return e}(Editor);babelHelpers.defineProperty(Comment,"items",{});var Scheduled=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._schedule=null;t._deadlineNode=null;t._headerClickHandler=BX.delegate(t.onHeaderClick,babelHelpers.assertThisInitialized(t));t._setAsDoneButtonHandler=BX.delegate(t.onSetAsDoneButtonClick,babelHelpers.assertThisInitialized(t));return t}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){this._schedule=this.getSetting("schedule");if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"Scheduled. The field 'activityEditor' is not assigned."}if(this.hasPermissions()&&!this.verifyPermissions()){this.loadPermissions()}}},{key:"getTypeId",value:function t(){return Item.undefined}},{key:"verifyPermissions",value:function t(){var e=BX.prop.getInteger(this.getPermissions(),"USER_ID",0);return e<=0||e===this._schedule.getUserId()}},{key:"loadPermissions",value:function t(){BX.ajax({url:this._schedule.getServiceUrl(),method:"POST",dataType:"json",data:{ACTION:"GET_PERMISSIONS",TYPE_ID:this.getTypeId(),ID:this.getAssociatedEntityId()},onsuccess:this.onPermissionsLoad.bind(this)})}},{key:"onPermissionsLoad",value:function t(e){var i=BX.prop.getObject(e,"PERMISSIONS",null);if(!i){return}this.setPermissions(i);window.setTimeout(function(){this.refreshLayout()}.bind(this),0)}},{key:"getDeadline",value:function t(){return null}},{key:"hasDeadline",value:function t(){return BX.type.isDate(this.getDeadline())}},{key:"isCounterEnabled",value:function t(){var e=this.getDeadline();return e&&History.isCounterEnabled(e)}},{key:"getSourceId",value:function t(){return BX.prop.getInteger(this.getAssociatedEntityData(),"ID",0)}},{key:"onSetAsDoneCompleted",value:function t(e){if(!BX.prop.getBoolean(e,"COMPLETED")){return}this.markAsDone(true);this._schedule.onItemMarkedAsDone(this,{historyItemData:BX.prop.getObject(e,"HISTORY_ITEM")})}},{key:"onPosponeCompleted",value:function t(e){}},{key:"refreshDeadline",value:function t(){this._deadlineNode.innerHTML=this.formatDateTime(this.getDeadline())}},{key:"formatDateTime",value:function t(e){return this._schedule.formatDateTime(e)}},{key:"getWrapperClassName",value:function t(){return""}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon"}},{key:"isReadOnly",value:function t(){return this._schedule.isReadOnly()}},{key:"isEditable",value:function t(){return!this.isReadOnly()}},{key:"canPostpone",value:function t(){if(this.isReadOnly()){return false}var e=BX.prop.getObject(this.getAssociatedEntityData(),"PERMISSIONS",{});return BX.prop.getBoolean(e,"POSTPONE",false)}},{key:"isDone",value:function t(){return BX.CrmActivityStatus.isFinal(BX.prop.getInteger(this.getAssociatedEntityData(),"STATUS",0))}},{key:"canComplete",value:function t(){if(this.isReadOnly()){return false}var e=BX.prop.getObject(this.getAssociatedEntityData(),"PERMISSIONS",{});return BX.prop.getBoolean(e,"COMPLETE",false)}},{key:"setAsDone",value:function t(e){}},{key:"prepareContent",value:function t(e){return null}},{key:"prepareLayout",value:function t(e){var i=this.makeVueComponent(e,"schedule");this._wrapper=i?i:this.prepareContent();if(this._wrapper){var s=BX.type.isPlainObject(e)?BX.prop.getBoolean(e,"add",true):true;if(s){var n=BX.type.isPlainObject(e)&&BX.type.isElementNode(e["anchor"])?e["anchor"]:null;if(n&&n.nextSibling){this._container.insertBefore(this._wrapper,n.nextSibling)}else{this._container.appendChild(this._wrapper)}}this.markAsTerminated(this._schedule.checkItemForTermination(this))}}},{key:"onHeaderClick",value:function t(e){this.view();e.preventDefault?e.preventDefault():e.returnValue=false}},{key:"onSetAsDoneButtonClick",value:function t(e){if(this.canComplete()){this.setAsDone(!this.isDone())}}},{key:"onActivityCreate",value:function t(e,i){this._schedule.getManager().onActivityCreated(e,i)}}],[{key:"isDone",value:function t(e){var i=BX.prop.getObject(e,"ASSOCIATED_ENTITY",{});return BX.CrmActivityStatus.isFinal(BX.prop.getInteger(i,"STATUS",0))}},{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Item$1);var Action=function(){function t(){babelHelpers.classCallCheck(this,t);this._id="";this._settings={};this._container=null}babelHelpers.createClass(t,[{key:"initialize",value:function t(e,i){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=i?i:{};this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"BX.CrmTimelineAction: Could not find container."}this.doInitialize()}},{key:"doInitialize",value:function t(){}},{key:"getId",value:function t(){return this._id}},{key:"getSetting",value:function t(e,i){return this._settings.hasOwnProperty(e)?this._settings[e]:i}},{key:"layout",value:function t(){this.doLayout()}},{key:"doLayout",value:function t(){}}]);return t}();var Activity=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._activityEditor=null;t._entityData=null;t._item=null;t._isEnabled=true;return t}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){this._entityData=this.getSetting("entityData");if(!BX.type.isPlainObject(this._entityData)){throw"BX.Crm.Timeline.Actions.Activity. A required parameter 'entityData' is missing."}this._activityEditor=this.getSetting("activityEditor");if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"BX.Crm.Timeline.Actions.Activity. A required parameter 'activityEditor' is missing."}this._item=this.getSetting("item");this._isEnabled=this.getSetting("enabled",true)}},{key:"getActivityId",value:function t(){return BX.prop.getInteger(this._entityData,"ID",0)}},{key:"loadActivityCommunications",value:function t(e){this._activityEditor.getActivityCommunications(this.getActivityId(),(function(t){if(BX.type.isFunction(e)){e(t)}}),true)}},{key:"getItemData",value:function t(){return this._item?this._item.getData():null}}]);return e}(Action);var Email=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._clickHandler=BX.delegate(t.onClick,babelHelpers.assertThisInitialized(t));t._saveHandler=BX.delegate(t.onSave,babelHelpers.assertThisInitialized(t));return t}babelHelpers.createClass(e,[{key:"onClick",value:function t(e){var i={ownerType:BX.CrmEntityType.resolveName(BX.prop.getInteger(this._entityData,"OWNER_TYPE_ID",0)),ownerID:BX.prop.getInteger(this._entityData,"OWNER_ID",0),ownerUrl:BX.prop.getString(this._entityData,"OWNER_URL",""),ownerTitle:BX.prop.getString(this._entityData,"OWNER_TITLE",""),originalMessageID:BX.prop.getInteger(this._entityData,"ID",0),messageType:"RE"};if(BX.CrmActivityProvider&&top.BX.Bitrix24&&top.BX.Bitrix24.Slider){var s=this._activityEditor.addEmail(i);s.addOnSave(this._saveHandler)}else{this.loadActivityCommunications(BX.delegate((function(t){i["communications"]=BX.type.isArray(t)?t:[];i["communicationsLoaded"]=true;BX.CrmActivityEmail.prepareReply(i);var e=this._activityEditor.addEmail(i);e.addOnSave(this._saveHandler)}),this))}return BX.PreventDefault(e)}},{key:"onSave",value:function t(e,i){if(BX.type.isFunction(this._item.onActivityCreate)){this._item.onActivityCreate(e,i)}}}]);return e}(Activity);var HistoryEmail=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"doLayout",value:function t(){this._container.appendChild(BX.create("A",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}}))}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Email);var ScheduleEmail=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"doLayout",value:function t(){this._container.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}}))}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Email);var HistoryActivity=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"doInitialize",this).call(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"HistoryActivity. The field 'activityEditor' is not assigned."}}},{key:"getTitle",value:function t(){return BX.prop.getString(this.getAssociatedEntityData(),"SUBJECT","")}},{key:"getTypeDescription",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getInteger(e,"DIRECTION",0);var s=this.getTypeCategoryId();if(s===BX.CrmActivityType.email){return this.getMessage(i===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")}else if(s===BX.CrmActivityType.call){return this.getMessage(i===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")}else if(s===BX.CrmActivityType.meeting){return this.getMessage("meeting")}else if(s===BX.CrmActivityType.task){return this.getMessage("task")}else if(s===BX.CrmActivityType.provider){var n=BX.prop.getString(e,"PROVIDER_ID","");if(n==="CRM_WEBFORM"){return this.getMessage("webform")}else if(n==="CRM_SMS"){return this.getMessage("sms")}else if(n==="CRM_REQUEST"){return this.getMessage("activityRequest")}else if(n==="IMOPENLINES_SESSION"){return this.getMessage("openLine")}else if(n==="REST_APP"){return this.getMessage("restApplication")}else if(n==="VISIT_TRACKER"){return this.getMessage("visit")}else if(n==="ZOOM"){return this.getMessage("zoom")}}return""}},{key:"prepareTitleLayout",value:function t(){return BX.create("A",{attrs:{href:"#",className:"crm-entity-stream-content-event-title"},events:{click:this._headerClickHandler},text:this.getTypeDescription()})}},{key:"prepareTimeLayout",value:function t(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})}},{key:"prepareMarkLayout",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getInteger(e,"MARK_TYPE_ID",0);if(i<=0){return null}var s="";if(i===Mark.success){s="SuccessMark"}else if(i===Mark.renew){s="RenewMark"}if(s===""){return null}var n="";var a=this.getTypeCategoryId();if(a===BX.CrmActivityType.email){n=this.getMessage("email"+s)}else if(a===BX.CrmActivityType.call){n=this.getMessage("call"+s)}else if(a===BX.CrmActivityType.meeting){n=this.getMessage("meeting"+s)}else if(a===BX.CrmActivityType.task){n=this.getMessage("task"+s)}if(n===""){return null}return BX.create("SPAN",{props:{className:"crm-entity-stream-content-event-skipped"},text:n})}},{key:"prepareActions",value:function t(){if(this.isReadOnly()){return}var e=this.getTypeCategoryId();if(e===BX.CrmActivityType.email){this._actions.push(HistoryEmail.create("email",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor}))}}},{key:"prepareContextMenuItems",value:function t(){if(this._isMenuShown){return}var e=[];if(!this.isReadOnly()){if(this.isEditable()){e.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.edit,this)})}e.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id))e.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)});else e.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}return e}},{key:"view",value:function t(){this.closeContextMenu();var e=this.getAssociatedEntityData();var i=BX.prop.getInteger(e,"ID",0);if(i>0){this._activityEditor.viewActivity(i)}}},{key:"edit",value:function t(){this.closeContextMenu();var e=this.getAssociatedEntityTypeId();if(e===BX.CrmEntityType.enumeration.activity){var i=this.getAssociatedEntityData();var s=BX.prop.getInteger(i,"ID",0);if(s>0){this._activityEditor.editActivity(s)}}}},{key:"processRemoval",value:function t(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";var e=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!e){e=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getRemoveMessage()})}e.open().then(BX.delegate(this.onRemovalConfirm,this),BX.delegate(this.onRemovalCancel,this))}},{key:"getRemoveMessage",value:function t(){return this.getMessage("removeConfirm")}},{key:"onRemovalConfirm",value:function t(e){if(BX.prop.getBoolean(e,"cancel",true)){return}this.remove()}},{key:"onRemovalCancel",value:function t(){}},{key:"remove",value:function t(){var e=this.getAssociatedEntityTypeId();if(e===BX.CrmEntityType.enumeration.activity){var i=this.getAssociatedEntityData();var s=BX.prop.getInteger(i,"ID",0);if(s>0){var n=this._activityEditor;var a=n.getItemById(s);if(a){n.deleteActivity(s,true)}else{var r=BX.util.add_url_param(n.getSetting("serviceUrl",""),{id:s,action:"get_activity",ownertype:n.getSetting("ownerType",""),ownerid:n.getSetting("ownerID","")});BX.ajax({url:r,method:"POST",dataType:"json",data:{ACTION:"GET_ACTIVITY",ID:s,OWNER_TYPE:n.getSetting("ownerType",""),OWNER_ID:n.getSetting("ownerID","")},onsuccess:BX.delegate((function(t){if(typeof t["ACTIVITY"]!=="undefined"){n._handleActivityChange(t["ACTIVITY"]);window.setTimeout(BX.delegate(this.remove,this),500)}}),this),onfailure:function t(e){}})}}}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(History);babelHelpers.defineProperty(HistoryActivity,"messages",{});var Document=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getTitle",value:function t(){var e=BX.prop.getInteger(this._data,"TYPE_CATEGORY_ID",0);if(e===3){return BX.Loc.getMessage("CRM_TIMELINE_DOCUMENT_VIEWED")}return this.getMessage("document")}},{key:"prepareTitleLayout",value:function t(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:BX.delegate(this.editDocument,this)},text:this.getTitle()})]})}},{key:"prepareTitleStatusLayout",value:function t(){var e=BX.prop.getInteger(this._data,"TYPE_CATEGORY_ID",0);if(e===3){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-done"},text:BX.Loc.getMessage("CRM_TIMELINE_DOCUMENT_VIEWED_STATUS")})}if(e===2){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-sent"},text:BX.Loc.getMessage("CRM_TIMELINE_DOCUMENT_CREATED_STATUS")})}return null}},{key:"prepareTimeLayout",value:function t(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})}},{key:"isContextMenuEnabled",value:function t(){var e=BX.prop.getInteger(this._data,"TYPE_CATEGORY_ID",0);return e!==3}},{key:"prepareHeaderLayout",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});e.appendChild(this.prepareTitleLayout());var i=this.prepareTitleStatusLayout();if(i){e.appendChild(i)}e.appendChild(this.prepareTimeLayout());return e}},{key:"prepareContent",value:function t(){var e=this.getTextDataParam("COMMENT","");var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-document"}});if(this.isFixed()){BX.addClass(i,"crm-entity-stream-section-top-fixed")}i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-document"}}));if(this.isContextMenuEnabled()){i.appendChild(this.prepareContextMenuButton())}if(!this.isReadOnly()){i.appendChild(this.prepareFixedSwitcherLayout())}var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));var n=this.prepareHeaderLayout();s.appendChild(n);var a=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},html:e});var r=BX.findChildByClassName(a,"document-title-link");if(r){BX.bind(r,"click",BX.proxy(this.editDocument,this))}s.appendChild(a);var o=this.prepareAuthorLayout();if(o){s.appendChild(o)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});s.appendChild(this._actionContainer);return i}},{key:"prepareActions",value:function t(){}},{key:"showActions",value:function t(e){if(this._actionContainer){this._actionContainer.style.display=e?"":"none"}}},{key:"prepareContextMenuItems",value:function t(){var e=[];if(!this.isReadOnly()){e.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.editDocument,this)});e.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.confirmDelete,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id)){e.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)})}else{e.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}}return e}},{key:"confirmDelete",value:function t(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";var e=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!e){e=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getMessage("documentRemove")})}e.open().then(BX.delegate(this.onConfirmDelete,this),BX.DoNothing)}},{key:"onConfirmDelete",value:function t(e){if(BX.prop.getBoolean(e,"cancel",true)){return}this.deleteDocument()}},{key:"deleteDocument",value:function t(){if(this._isRequestRunning){return}this._isRequestRunning=true;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"DELETE_DOCUMENT",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this.getId()},onsuccess:BX.delegate((function(t){this._isRequestRunning=false;if(BX.type.isNotEmptyString(t.ERROR)){alert(t.ERROR)}else{var i=this._history.findItemById(this._id);if(i instanceof e){i.clearAnimate()}var s=this._fixedHistory.findItemById(this._id);if(s instanceof e){s.clearAnimate()}}}),this),onfailure:BX.delegate((function(){this._isRequestRunning=false}),this)})}},{key:"editDocument",value:function t(){var e=this.getData().DOCUMENT_ID||0;if(e>0){var i="/bitrix/components/bitrix/crm.document.view/slider.php";i=BX.util.add_url_param(i,{documentId:e});if(BX.SidePanel){BX.SidePanel.Instance.open(i,{width:980})}else{top.location.href=i}}}},{key:"updateWrapper",value:function t(){var e=this.getWrapper();if(e){var i=BX.findChildByClassName(e,"crm-entity-stream-content-detail");if(i){BX.adjust(i,{html:this.getTextDataParam("COMMENT","")});var s=BX.findChildByClassName(i,"document-title-link");if(s){BX.bind(s,"click",BX.proxy(this.editDocument,this))}}}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(HistoryActivity);var Steam=function(){function t(){babelHelpers.classCallCheck(this,t);this._id="";this._settings={};this._container=null;this._manager=null;this._activityEditor=null;this._userTimezoneOffset=null;this._serverTimezoneOffset=null;this._timeFormat="";this._year=0;this._isStubMode=false;this._userId=0;this._readOnly=false;this._serviceUrl=""}babelHelpers.createClass(t,[{key:"initialize",value:function t(e,i){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=i?i:{};this._container=BX(this.getSetting("container"));if(!BX.type.isElementNode(this._container)){throw"Timeline. Container node is not found."}this._editorContainer=BX(this.getSetting("editorContainer"));this._manager=this.getSetting("manager");if(!(this._manager instanceof Manager)){throw"Timeline. Manager instance is not found."}var s=BX.message("FORMAT_DATETIME").replace(/:SS/,"");var n=BX.message("FORMAT_DATE");this._timeFormat=BX.date.convertBitrixFormat(BX.util.trim(s.replace(n,"")));this._year=(new Date).getFullYear();this._activityEditor=this.getSetting("activityEditor");this._isStubMode=BX.prop.getBoolean(this._settings,"isStubMode",false);this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);this._userId=BX.prop.getInteger(this._settings,"userId",0);this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this.doInitialize()}},{key:"getId",value:function t(){return this._id}},{key:"getSetting",value:function t(e,i){return this._settings.hasOwnProperty(e)?this._settings[e]:i}},{key:"doInitialize",value:function t(){}},{key:"layout",value:function t(){}},{key:"isStubMode",value:function t(){return this._isStubMode}},{key:"isReadOnly",value:function t(){return this._readOnly}},{key:"getUserId",value:function t(){return this._userId}},{key:"getServiceUrl",value:function t(){return this._serviceUrl}},{key:"refreshLayout",value:function t(){}},{key:"getManager",value:function t(){return this._manager}},{key:"getOwnerInfo",value:function t(){return this._manager.getOwnerInfo()}},{key:"reload",value:function t(){var e=this.getSetting("currentUrl");var i=this.getSetting("ajaxId");if(i!==""){BX.ajax.insertToNode(BX.util.add_url_param(e,{bxajaxid:i}),"comp_"+i)}else{window.location=e}}},{key:"getUserTimezoneOffset",value:function t(){if(!this._userTimezoneOffset){this._userTimezoneOffset=parseInt(BX.message("USER_TZ_OFFSET"));if(isNaN(this._userTimezoneOffset)){this._userTimezoneOffset=0}}return this._userTimezoneOffset}},{key:"getServerTimezoneOffset",value:function t(){if(!this._serverTimezoneOffset){this._serverTimezoneOffset=parseInt(BX.message("SERVER_TZ_OFFSET"));if(isNaN(this._serverTimezoneOffset)){this._serverTimezoneOffset=0}}return this._serverTimezoneOffset}},{key:"formatTime",value:function t(e,i,s){return BX.date.format(this._timeFormat,e,i,s)}},{key:"formatDate",value:function t(e){return BX.date.format([["today","today"],["tommorow","tommorow"],["yesterday","yesterday"],["",e.getFullYear()===this._year?"j F":"j F Y"]],e)}},{key:"cutOffText",value:function t(e,i){if(!BX.type.isNumber(i)){i=0}if(i<=0||e.length<=i){return e}var s=i-1;var n=e.substring(s).search(/\s/i);if(n>0){s+=n}return e.substring(0,s)+"..."}}]);return t}();var EntityChat=function(_Stream){babelHelpers.inherits(EntityChat,_Stream);function EntityChat(){var t;babelHelpers.classCallCheck(this,EntityChat);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(EntityChat).call(this));t._data=null;t._layoutType=EntityChat.LayoutType.none;t._wrapper=null;t._contentWrapper=null;t._messageWrapper=null;t._messageDateNode=null;t._messageTexWrapper=null;t._messageTextNode=null;t._userWrapper=null;t._extraUserCounter=null;t._openChatHandler=BX.delegate(t.onOpenChat,babelHelpers.assertThisInitialized(t));return t}babelHelpers.createClass(EntityChat,[{key:"doInitialize",value:function t(){this._data=BX.prop.getObject(this._settings,"data",{})}},{key:"getData",value:function t(){return this._data}},{key:"setData",value:function t(e){this._data=BX.type.isPlainObject(e)?e:{}}},{key:"isEnabled",value:function t(){return BX.prop.getBoolean(this._data,"ENABLED",true)}},{key:"isRestricted",value:function t(){return BX.prop.getBoolean(this._data,"IS_RESTRICTED",false)}},{key:"applyLockScript",value:function applyLockScript(){var lockScript=BX.prop.getString(this._data,"LOCK_SCRIPT",null);if(BX.Type.isString(lockScript)&&lockScript!==""){eval(lockScript)}}},{key:"getChatId",value:function t(){return BX.prop.getInteger(this._data,"CHAT_ID",0)}},{key:"getUserId",value:function t(){var e=parseInt(top.BX.message("USER_ID"));return!isNaN(e)?e:0}},{key:"getMessageData",value:function t(){return BX.prop.getObject(this._data,"MESSAGE",{})}},{key:"setMessageData",value:function t(e){this._data["MESSAGE"]=BX.type.isPlainObject(e)?e:{}}},{key:"getUserInfoData",value:function t(){return BX.prop.getObject(this._data,"USER_INFOS",{})}},{key:"setUserInfoData",value:function t(e){this._data["USER_INFOS"]=BX.type.isPlainObject(e)?e:{}}},{key:"hasUserInfo",value:function t(e){return e>0&&BX.type.isPlainObject(this.getUserInfoData()[e])}},{key:"getUserInfo",value:function t(e){var i=this.getUserInfoData();return e>0&&BX.type.isPlainObject(i[e])?i[e]:null}},{key:"removeUserInfo",value:function t(e){var i=this.getUserInfoData();if(e>0&&BX.type.isPlainObject(i[e])){delete i[e]}}},{key:"setUnreadMessageCounter",value:function t(e,i){var s=this.getUserInfoData();if(e>0&&BX.type.isPlainObject(s[e])){s[e]["counter"]=i}}},{key:"layout",value:function t(){if(!this.isEnabled()||this.isStubMode()){return}this._wrapper=BX.create("div",{props:{className:"crm-entity-stream-section crm-entity-stream-section-live-im"}});this._container.appendChild(this._wrapper);this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-live-im"}}));this._contentWrapper=BX.create("div",{props:{className:"crm-entity-stream-content-live-im-detail"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-stream-section-content"},children:[BX.create("div",{props:{className:"crm-entity-stream-content-event"},children:[this._contentWrapper]})]}));this._userWrapper=BX.create("div",{props:{className:"crm-entity-stream-live-im-user-avatars"}});this._contentWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-stream-live-im-users"},children:[this._userWrapper]}));this._extraUserCounter=BX.create("div",{props:{className:"crm-entity-stream-live-im-user-counter"}});this._contentWrapper.appendChild(this._extraUserCounter);this._layoutType=EntityChat.LayoutType.none;if(this.getChatId()>0){this.renderSummary()}else{this.renderInvitation()}BX.bind(this._contentWrapper,"click",this._openChatHandler);BX.addCustomEvent("onPullEvent-im",this.onChatEvent.bind(this))}},{key:"refreshLayout",value:function t(){BX.cleanNode(this._contentWrapper);this._userWrapper=BX.create("div",{props:{className:"crm-entity-stream-live-im-user-avatars"}});this._contentWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-stream-live-im-users"},children:[this._userWrapper]}));this._extraUserCounter=BX.create("div",{props:{className:"crm-entity-stream-live-im-user-counter"}});this._contentWrapper.appendChild(this._extraUserCounter);this._layoutType=EntityChat.LayoutType.none;if(this.getChatId()>0){this.renderSummary()}else{this.renderInvitation()}}},{key:"renderInvitation",value:function t(){this._layoutType=EntityChat.LayoutType.invitation;this.refreshUsers();this._messageTextNode=BX.create("div",{props:{className:"crm-entity-stream-live-im-user-invite-text"}});this._contentWrapper.appendChild(this._messageTextNode);this._messageTextNode.innerHTML=this.getMessage("invite")}},{key:"renderSummary",value:function t(){this._layoutType=EntityChat.LayoutType.summary;this.refreshUsers();this._contentWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-stream-live-im-separator"}}));this._messageWrapper=BX.create("div",{props:{className:"crm-entity-stream-live-im-messanger"}});this._contentWrapper.appendChild(this._messageWrapper);this._messageDateNode=BX.create("div",{props:{className:"crm-entity-stream-live-im-time"}});this._messageWrapper.appendChild(this._messageDateNode);this._messageTexWraper=BX.create("div",{props:{className:"crm-entity-stream-live-im-message"}});this._messageWrapper.appendChild(this._messageTexWraper);this._messageTextNode=BX.create("div",{props:{className:"crm-entity-stream-live-im-message-text"}});this._messageTexWraper.appendChild(this._messageTextNode);this._messageCounterNode=BX.create("div",{props:{className:"crm-entity-stream-live-im-message-counter"}});this._messageWrapper.appendChild(this._messageCounterNode);this.refreshSummary()}},{key:"refreshUsers",value:function t(){BX.cleanNode(this._userWrapper);var e=this.getUserInfoData();var i=Object.values(e);if(i.length===0){this._userWrapper.appendChild(BX.create("span",{props:{className:"crm-entity-stream-live-im-user-avatar ui-icon ui-icon-common-user"},children:[BX.create("i")]}))}else{var s=i.length>=3?3:i.length;for(var n=0;n<s;n++){var a=i[n];var r=BX.create("i");var o=BX.prop.getString(a,"avatar","");if(o!==""){r.style.backgroundImage="url("+o+")"}this._userWrapper.appendChild(BX.create("span",{props:{className:"crm-entity-stream-live-im-user-avatar ui-icon ui-icon-common-user"},children:[r]}))}}if(this._layoutType===EntityChat.LayoutType.summary){if(i.length>3){this._extraUserCounter.display="";this._extraUserCounter.innerHTML="+"+(i.length-3).toString()}else{if(this._extraUserCounter.innerHTML!==""){this._extraUserCounter.innerHTML=""}this._extraUserCounter.display="none"}}else{if(this._extraUserCounter.innerHTML!==""){this._extraUserCounter.innerHTML=""}this._extraUserCounter.display="none";this._userWrapper.appendChild(BX.create("span",{props:{className:"crm-entity-stream-live-im-user-invite-btn"}}))}}},{key:"refreshSummary",value:function t(){if(this._layoutType!==EntityChat.LayoutType.summary){return}var e=this.getMessageData();var i=BX.prop.getString(e,"date","");if(i===""){this._messageDateNode.innerHTML=""}else{var s=new Date(i).getTime()/1e3+this.getServerTimezoneOffset()+this.getUserTimezoneOffset();var n=(new Date).getTime()/1e3+this.getServerTimezoneOffset()+this.getUserTimezoneOffset();this._messageDateNode.innerHTML=this.formatTime(s,n,true)}var a=BX.prop.getString(e,"text","");var r=BX.prop.getObject(e,"params",{});if(a===""){this._messageTextNode.innerHTML=""}else{if(typeof top.BX.MessengerCommon!=="undefined"){a=top.BX.MessengerCommon.purifyText(a,r)}this._messageTextNode.innerHTML=a}var o=0;var l=this.getUserId();if(l>0){o=BX.prop.getInteger(BX.prop.getObject(BX.prop.getObject(this._data,"USER_INFOS",{}),l,null),"counter",0)}this._messageCounterNode.innerHTML=o.toString();this._messageCounterNode.style.display=o>0?"":"none"}},{key:"refreshUsersAnimated",value:function t(){BX.removeClass(this._userWrapper,"crm-entity-stream-live-im-message-show");BX.addClass(this._userWrapper,"crm-entity-stream-live-im-message-hide");window.setTimeout(function(){this.refreshUsers();window.setTimeout(function(){BX.removeClass(this._userWrapper,"crm-entity-stream-live-im-message-hide");BX.addClass(this._userWrapper,"crm-entity-stream-live-im-message-show")}.bind(this),50)}.bind(this),500)}},{key:"refreshSummaryAnimated",value:function t(){BX.removeClass(this._messageWrapper,"crm-entity-stream-live-im-message-show");BX.addClass(this._messageWrapper,"crm-entity-stream-live-im-message-hide");window.setTimeout(function(){this.refreshSummary();window.setTimeout(function(){BX.removeClass(this._messageWrapper,"crm-entity-stream-live-im-message-hide");BX.addClass(this._messageWrapper,"crm-entity-stream-live-im-message-show")}.bind(this),50)}.bind(this),500)}},{key:"onOpenChat",value:function t(e){if(typeof top.BXIM==="undefined"){return}if(this.isRestricted()){this.applyLockScript();return}var i="";var s=this.getChatId();if(s>0&&this.hasUserInfo(this.getUserId())){i="chat"+s.toString()}else{var n=this.getOwnerInfo();var a=BX.prop.getInteger(n,"ENTITY_ID",0);var r=BX.prop.getString(n,"ENTITY_TYPE_NAME","");if(r!==""&&a>0){i="crm|"+r+"|"+a.toString()}}if(i!==""){top.BXIM.openMessengerSlider(i,{RECENT:"N",MENU:"N"})}}},{key:"onChatEvent",value:function t(e,i,s){var n=this.getChatId();if(n<=0||n!==BX.prop.getInteger(i,"chatId",0)){return}if(e==="chatUserAdd"){this.setUserInfoData(BX.mergeEx(this.getUserInfoData(),BX.prop.getObject(i,"users",{})));this.refreshUsersAnimated()}else if(e==="chatUserLeave"){this.removeUserInfo(BX.prop.getInteger(i,"userId",0));this.refreshUsersAnimated()}else if(e==="messageChat"){this.setMessageData(BX.prop.getObject(i,"message",{}));this.setUnreadMessageCounter(this.getUserId(),BX.prop.getInteger(i,"counter",0));this.refreshSummaryAnimated()}else if(e==="messageUpdate"||e==="messageDelete"){if(e==="messageDelete"){delete i["date"]}var a=this.getMessageData();if(BX.prop.getInteger(a,"id",0)===BX.prop.getInteger(i,"id",0)){this.setMessageData(BX.mergeEx(a,i));this.refreshSummaryAnimated()}}else if(e==="readMessageChat"){this.setUnreadMessageCounter(this.getUserId(),0);this.refreshSummaryAnimated()}else if(e==="unreadMessageChat"){this.setUnreadMessageCounter(this.getUserId(),BX.prop.getInteger(i,"counter",0));this.refreshSummaryAnimated()}}},{key:"getMessage",value:function t(e){return BX.prop.getString(EntityChat.messages,e,e)}}],[{key:"create",value:function t(e,i){var s=new EntityChat;s.initialize(e,i);EntityChat.items[s.getId()]=s;return s}}]);return EntityChat}(Steam);babelHelpers.defineProperty(EntityChat,"LayoutType",{none:0,invitation:1,summary:2});babelHelpers.defineProperty(EntityChat,"items",{});babelHelpers.defineProperty(EntityChat,"messages",{});var MenuBar=function(){function t(){babelHelpers.classCallCheck(this,t);this._id="";this._ownerInfo=null;this._container=null;this._activityEditor=null;this._commentEditor=null;this._waitEditor=null;this._smsEditor=null;this._zoomEditor=null;this._readOnly=false;this._menu=null;this._manager=null}babelHelpers.createClass(t,[{key:"initialize",value:function t(e,i){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=i?i:{};this._ownerInfo=BX.prop.getObject(this._settings,"ownerInfo");if(!this._ownerInfo){throw"MenuBar. A required parameter 'ownerInfo' is missing."}this._activityEditor=BX.prop.get(this._settings,"activityEditor",null);this._commentEditor=BX.prop.get(this._settings,"commentEditor");this._waitEditor=BX.prop.get(this._settings,"waitEditor");this._smsEditor=BX.prop.get(this._settings,"smsEditor");this._zoomEditor=BX.prop.get(this._settings,"zoomEditor");this._restEditor=BX.prop.get(this._settings,"restEditor");this._manager=BX.prop.get(this._settings,"manager");if(!(this._manager instanceof Manager)){throw"BX.CrmTimeline. Manager instance is not found."}this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);this._menu=BX.Main.interfaceButtonsManager.getById(BX.prop.getString(this._settings,"menuId",(this._ownerInfo["ENTITY_TYPE_NAME"]+"_menu").toLowerCase()));BX.addCustomEvent(this._manager.getId()+"_menu",function(t){this.setActiveItemById(t)}.bind(this));this._activeItem=this._menu.getActive()}},{key:"reset",value:function t(){var e=null;this._menu.getAllItems().forEach(function(t){if(e===null){var i=t.dataset.id;if(["comment","wait","sms","zoom"].indexOf(i)>=0&&this["_"+i+"Editor"]){e=i}}}.bind(this));this.setActiveItemById(e||"comment")}},{key:"getId",value:function t(){return this._id}},{key:"setActiveItemById",value:function t(e){if(this.processItemSelection(e)===true){var i=this._menu.getItemById(e);if(i&&this._activeItem!==i){var s=this._menu.isActiveInMoreMenu();BX.addClass(i,this._menu.classes.itemActive);if(this._menu.getItemData){var n=this._menu.getItemData(i);n["IS_ACTIVE"]=true;if(BX.type.isDomNode(this._activeItem)){BX.removeClass(this._activeItem,this._menu.classes.itemActive);var a=this._menu.getItemData(this._activeItem);a["IS_ACTIVE"]=false}}else{var r={};try{r=JSON.parse(i.dataset.item)}catch(t){r={}}r.IS_ACTIVE=true;i.dataset.item=JSON.stringify(r);var o={};if(BX.type.isDomNode(this._activeItem)){BX.removeClass(this._activeItem,this._menu.classes.itemActive);try{o=JSON.parse(this._activeItem.dataset.item)}catch(t){o={}}o.IS_ACTIVE=false;this._activeItem.dataset.item=JSON.stringify(o)}}var l=this._menu.isActiveInMoreMenu();if(l||s){var c=this._menu["getSubmenu"]?this._menu.getSubmenu():BX.PopupMenu.getMenuById("main_buttons_popup_"+String(this._ownerInfo["ENTITY_TYPE_NAME"]).toLowerCase()+"_menu");if(c){c.getMenuItems().forEach(function(t){var e=t.getContainer();if(l&&e.title===i.title){BX.addClass(e,this._menu.classes.itemActive)}else if(s&&e.title===this._activeItem.title){BX.removeClass(e,this._menu.classes.itemActive)}}.bind(this))}if(l){BX.addClass(this._menu.getMoreButton(),this._menu.classes.itemActive)}else if(s){BX.removeClass(this._menu.getMoreButton(),this._menu.classes.itemActive)}}this._activeItem=i}}this._menu.closeSubmenu()}},{key:"processItemSelection",value:function t(e){if(this._readOnly){return false}var i=null;var s=e;if(s==="call"){i=new BX.Crm.Activity.Planner;i.showEdit({TYPE_ID:BX.CrmActivityType.call,OWNER_TYPE_ID:this._ownerInfo["ENTITY_TYPE_ID"],OWNER_ID:this._ownerInfo["ENTITY_ID"]})}if(s==="meeting"){i=new BX.Crm.Activity.Planner;i.showEdit({TYPE_ID:BX.CrmActivityType.meeting,OWNER_TYPE_ID:this._ownerInfo["ENTITY_TYPE_ID"],OWNER_ID:this._ownerInfo["ENTITY_ID"]})}else if(s==="email"){this._activityEditor.addEmail({ownerType:this._ownerInfo["ENTITY_TYPE_NAME"],ownerID:this._ownerInfo["ENTITY_ID"],ownerUrl:this._ownerInfo["SHOW_URL"],ownerTitle:this._ownerInfo["TITLE"],subject:""})}else if(s==="delivery"){this._activityEditor.addDelivery({ownerType:this._ownerInfo["ENTITY_TYPE_NAME"],ownerID:this._ownerInfo["ENTITY_ID"],orderList:this._ownerInfo["ORDER_LIST"]})}else if(s==="task"){this._activityEditor.addTask({ownerType:this._ownerInfo["ENTITY_TYPE_NAME"],ownerID:this._ownerInfo["ENTITY_ID"]})}else if(["comment","wait","sms","zoom"].indexOf(s)>=0&&this["_"+s+"Editor"]){if(this._commentEditor){this._commentEditor.setVisible(s==="comment")}if(this._waitEditor){this._waitEditor.setVisible(s==="wait")}if(this._smsEditor){this._smsEditor.setVisible(s==="sms")}if(this._zoomEditor){this._zoomEditor.setVisible(s==="zoom")}return true}else if(s==="visit"){var n=this._manager.getSetting("visitParameters");n["OWNER_TYPE"]=this._ownerInfo["ENTITY_TYPE_NAME"];n["OWNER_ID"]=this._ownerInfo["ENTITY_ID"];BX.CrmActivityVisit.create(n).showEdit()}else if(s.match(/^activity_rest_/)){if(this._restEditor){this._restEditor.action(s)}}return false}}],[{key:"create",value:function e(i,s){var n=new t;n.initialize(i,s);return n}}]);return t}();var AudioPlaybackRateSelector=function(){function t(e){babelHelpers.classCallCheck(this,t);this.name=e.name||"crm-timeline-audio-playback-rate-selector";this.menuId=this.name+"-menu";if(BX.Type.isArray(e.availableRates)){this.availableRates=e.availableRates}else{this.availableRates=[1,1.5,2,3]}this.currentRate=this.normalizeRate(e.currentRate);this.textMessageCode=e.textMessageCode;this.renderedItems=[];this.players=[]}babelHelpers.createClass(t,[{key:"isRateCurrent",value:function t(e,i){return e.rate&&i===e.rate||i===e}},{key:"normalizeRate",value:function t(e){e=parseFloat(e);var i=0;var s=this.availableRates.length;for(;i<s;i++){if(this.isRateCurrent(this.availableRates[i],e)){return e}}return this.availableRates[0].rate||this.availableRates[0]}},{key:"getMenuItems",value:function t(){var e=this.getRate();return this.availableRates.map(function(t){return{text:(t.text||t)+"",html:(t.html||t)+"",className:this.isRateCurrent(t,e)?"menu-popup-item-text-active":null,onclick:function(){this.setRate(t.rate||t)}.bind(this)}}.bind(this))}},{key:"getPopup",value:function t(e){var i=BX.Main.MenuManager.getMenuById(this.menuId);if(i){var s=i.getPopupWindow();if(s){s.setBindElement(e)}}else{i=BX.Main.MenuManager.create({id:this.menuId,bindElement:e,items:this.getMenuItems(),className:"crm-audio-cap-speed-popup"})}return i}},{key:"getRate",value:function t(){return this.normalizeRate(this.currentRate)}},{key:"setRate",value:function t(e){this.getPopup().destroy();e=this.normalizeRate(e);if(this.currentRate===e){return}this.currentRate=e;BX.userOptions.save("crm",this.name,"rate",e);for(var i=0,s=this.renderedItems.length;i<s;i++){var n=this.renderedItems[i].querySelector(".crm-audio-cap-speed-text");if(n){n.innerHTML=this.getText()}}for(var a=0,r=this.players.length;a<r;a++){this.players[a].vjsPlayer.playbackRate(this.getRate())}}},{key:"getText",value:function t(){var e;if(this.textMessageCode){e=BX.Loc.getMessage(this.textMessageCode)}if(!e){e="#RATE#"}return e.replace("#RATE#","<span>"+this.getRate()+"x</span>")}},{key:"render",value:function t(){var e=BX.Dom.create("div",{attrs:{className:"crm-audio-cap-speed-wrapper"},children:[BX.Dom.create("div",{attrs:{className:"crm-audio-cap-speed"},children:[BX.Dom.create("div",{attrs:{className:"crm-audio-cap-speed-text"},html:this.getText()})]})],events:{click:function(t){t.preventDefault();this.getPopup(t.target).show()}.bind(this)}});this.renderedItems.push(e);return e}},{key:"addPlayer",value:function t(e){if(BX.Fileman.Player&&e instanceof BX.Fileman.Player){this.players.push(e)}}}]);return t}();var SchedulePostponeController=function(){function t(){babelHelpers.classCallCheck(this,t);this._item=null}babelHelpers.createClass(t,[{key:"initialize",value:function t(e,i){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=i?i:{};this._item=BX.prop.get(this._settings,"item",null)}},{key:"getTitle",value:function t(){return this.getMessage("title")}},{key:"getCommandList",value:function t(){return[{name:"postpone_hour_1",title:this.getMessage("forOneHour")},{name:"postpone_hour_2",title:this.getMessage("forTwoHours")},{name:"postpone_hour_3",title:this.getMessage("forThreeHours")},{name:"postpone_day_1",title:this.getMessage("forOneDay")},{name:"postpone_day_2",title:this.getMessage("forTwoDays")},{name:"postpone_day_3",title:this.getMessage("forThreeDays")}]}},{key:"processCommand",value:function t(e){if(e.indexOf("postpone")!==0){return false}var i=0;if(e==="postpone_hour_1"){i=3600}else if(e==="postpone_hour_2"){i=7200}else if(e==="postpone_hour_3"){i=10800}else if(e==="postpone_day_1"){i=86400}else if(e==="postpone_day_2"){i=172800}else if(e==="postpone_day_3"){i=259200}if(i>0&&this._item){this._item.postpone(i)}return true}},{key:"getMessage",value:function e(i){var s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function e(i,s){var n=new t;n.initialize(i,s);return n}}]);return t}();babelHelpers.defineProperty(SchedulePostponeController,"messages",{});var Activity$1=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._postponeController=null;return t}babelHelpers.createClass(e,[{key:"getTypeId",value:function t(){return Item.activity}},{key:"isDone",value:function t(){var e=BX.prop.getInteger(this.getAssociatedEntityData(),"STATUS");return e===BX.CrmActivityStatus.completed||e===BX.CrmActivityStatus.autoCompleted}},{key:"setAsDone",value:function t(e){e=!!e;if(this.isDone()===e){return}var i=BX.prop.getInteger(this.getAssociatedEntityData(),"ID",0);if(i>0){this._activityEditor.setActivityCompleted(i,e,BX.delegate(this.onSetAsDoneCompleted,this))}}},{key:"postpone",value:function t(e){var i=this.getSourceId();if(i>0&&e>0){this._activityEditor.postponeActivity(i,e,BX.delegate(this.onPosponeCompleted,this))}}},{key:"view",value:function t(){var e=BX.prop.getInteger(this.getAssociatedEntityData(),"ID",0);if(e>0){this._activityEditor.viewActivity(e)}}},{key:"edit",value:function t(){this.closeContextMenu();var e=this.getAssociatedEntityTypeId();if(e===BX.CrmEntityType.enumeration.activity){var i=this.getAssociatedEntityData();var s=BX.prop.getInteger(i,"ID",0);if(s>0){this._activityEditor.editActivity(s)}}}},{key:"processRemoval",value:function t(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";var e=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!e){e=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getRemoveMessage()})}e.open().then(BX.delegate(this.onRemovalConfirm,this),BX.delegate(this.onRemovalCancel,this))}},{key:"getRemoveMessage",value:function t(){return this.getMessage("removeConfirm")}},{key:"onRemovalConfirm",value:function t(e){if(BX.prop.getBoolean(e,"cancel",true)){return}this.remove()}},{key:"onRemovalCancel",value:function t(){}},{key:"remove",value:function t(){var e=this.getAssociatedEntityTypeId();if(e===BX.CrmEntityType.enumeration.activity){var i=this.getAssociatedEntityData();var s=BX.prop.getInteger(i,"ID",0);if(s>0){var n=this._activityEditor;var a=n.getItemById(s);if(a){n.deleteActivity(s,true)}else{var r=n.getSetting("ownerType","");var o=n.getSetting("ownerID","");var l=BX.util.add_url_param(n.getSetting("serviceUrl",""),{id:s,action:"get_activity",ownertype:r,ownerid:o});BX.ajax({url:l,method:"POST",dataType:"json",data:{ACTION:"GET_ACTIVITY",ID:s,OWNER_TYPE:r,OWNER_ID:o},onsuccess:BX.delegate((function(t){if(typeof t["ACTIVITY"]!=="undefined"){n._handleActivityChange(t["ACTIVITY"]);window.setTimeout(BX.delegate(this.remove,this),500)}}),this),onfailure:function t(e){}})}}}}},{key:"getDeadline",value:function t(){var e=this.getAssociatedEntityData();var i=BX.parseDate(e["DEADLINE_SERVER"],false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");if(!i){return null}return new Date(i.getTime()+1e3*Item$1.getUserTimezoneOffset())}},{key:"markAsDone",value:function t(e){e=!!e;this.getAssociatedEntityData()["STATUS"]=e?BX.CrmActivityStatus.completed:BX.CrmActivityStatus.waiting}},{key:"getPrepositionText",value:function t(e){return this.getMessage(e===BX.CrmActivityDirection.incoming?"from":"to")}},{key:"getTypeDescription",value:function t(e){return""}},{key:"isContextMenuEnabled",value:function t(){return!!this.getDeadline()&&this.canPostpone()||this.canComplete()}},{key:"prepareContent",value:function t(e){var i=this.getDeadline();var s=i?this.formatDateTime(i):this.getMessage("termless");var n=this.getAssociatedEntityData();var a=BX.prop.getInteger(n,"DIRECTION",0);var r=this.isDone();var o=BX.prop.getString(n,"SUBJECT","");var l=BX.prop.getString(n,"DESCRIPTION_RAW","");var c=BX.prop.getObject(n,"COMMUNICATION",{});var u=BX.prop.getString(c,"TITLE","");var h=BX.prop.getString(c,"SHOW_URL","");var d=BX.prop.getString(c,"TYPE","")!==""?BX.prop.getString(c,"VALUE",""):"";var p=this.getWrapperClassName();if(p!==""){p="crm-entity-stream-section crm-entity-stream-section-planned"+" "+p}else{p="crm-entity-stream-section crm-entity-stream-section-planned"}var m=BX.create("DIV",{attrs:{className:p}});var y=this.getIconClassName();if(this.isCounterEnabled()){y+=" crm-entity-stream-section-counter"}m.appendChild(BX.create("DIV",{attrs:{className:y}}));if(this.isContextMenuEnabled()){m.appendChild(this.prepareContextMenuButton())}var f=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}});m.appendChild(f);if(l!==""){l=l.replace(/^\s+/,"")}var g=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});f.appendChild(g);this._deadlineNode=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:s});var v=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});v.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getTypeDescription(a)}));var _=this.getStatusNode();if(_){v.appendChild(_)}v.appendChild(this._deadlineNode);g.appendChild(v);var I=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});g.appendChild(I);I.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:o})]}));I.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:this.cutOffText(l,128)}));var C=this.prepareDetailNodes();if(BX.type.isArray(C)){var E=0;var B=C.length;for(;E<B;E++){I.appendChild(C[E])}}var T=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});if(u!==""){T.appendChild(BX.create("SPAN",{text:this.getPrepositionText(a)+": "}));if(h!==""){T.appendChild(BX.create("A",{attrs:{href:h},text:u}))}else{T.appendChild(BX.create("SPAN",{text:u}))}}if(d!==""){var D=this.prepareCommunicationNode(d);if(D){T.appendChild(D)}}I.appendChild(T);var S=BX.create("INPUT",{attrs:{type:"checkbox",className:"crm-entity-stream-planned-apply-btn",checked:r},events:{change:this._setAsDoneButtonHandler}});if(!this.canComplete()){S.disabled=true}var X=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-planned-action"},children:[S]});g.appendChild(X);var b=this.prepareAuthorLayout();if(b){g.appendChild(b)}this._actionContainer=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-action"}});g.appendChild(this._actionContainer);return m}},{key:"getStatusNode",value:function t(){return null}},{key:"prepareCommunicationNode",value:function t(e){return BX.create("SPAN",{text:" "+e})}},{key:"prepareDetailNodes",value:function t(){return[]}},{key:"prepareContextMenuItems",value:function t(){var e=[];if(!this.isReadOnly()){if(this.isEditable()){e.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.edit,this)})}e.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)})}var i=BX.delegate(this.onContextMenuItemSelect,this);if(!this._postponeController){this._postponeController=SchedulePostponeController.create("",{item:this})}var s={id:"postpone",text:this._postponeController.getTitle(),items:[]};var n=this._postponeController.getCommandList();var a=0;var r=n.length;for(;a<r;a++){var o=n[a];s.items.push({id:o["name"],text:o["title"],onclick:i})}e.push(s);return e}},{key:"onContextMenuItemSelect",value:function t(e,i){this.closeContextMenu();if(this._postponeController){this._postponeController.processCommand(i.id)}}}]);return e}(Scheduled);var Email$1=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getWrapperClassName",value:function t(){return"crm-entity-stream-section-email"}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-email"}},{key:"prepareActions",value:function t(){if(this.isReadOnly()){return}this._actions.push(BX.CrmScheduleEmailAction.create("email",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor}))}},{key:"getTypeDescription",value:function t(e){return this.getMessage(e===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")}},{key:"getRemoveMessage",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"SUBJECT","");i=BX.util.htmlspecialchars(i);return this.getMessage("emailRemove").replace("#TITLE#",i)}},{key:"isEditable",value:function t(){return false}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Activity$1);var Call=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getWrapperClassName",value:function t(){return"crm-entity-stream-section-call"}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-call"}},{key:"prepareActions",value:function t(){if(this.isReadOnly()){return}this._actions.push(BX.CrmScheduleCallAction.create("call",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._schedule.getOwnerInfo()}))}},{key:"getTypeDescription",value:function t(e){var i=this.getAssociatedEntityData();var s=BX.prop.getObject(i,"CALL_INFO",null);var n=s!==null?BX.prop.getString(s,"CALL_TYPE_TEXT",""):"";if(n!==""){return n}return this.getMessage(e===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")}},{key:"getRemoveMessage",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getInteger(e,"DIRECTION",0);var s=BX.prop.getString(e,"SUBJECT","");var n=i===BX.CrmActivityDirection.incoming?"incomingCallRemove":"outgoingCallRemove";s=BX.util.htmlspecialchars(s);return this.getMessage(n).replace("#TITLE#",s)}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Activity$1);var CallTracker=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getStatusNode",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getObject(e,"CALL_INFO",null);if(!i){return false}if(!BX.prop.getBoolean(i,"HAS_STATUS",false)){return false}var s=BX.prop.getBoolean(i,"SUCCESSFUL",false);var n=BX.prop.getString(i,"STATUS_TEXT","");return BX.create("DIV",{attrs:{className:s?"crm-entity-stream-content-event-successful":"crm-entity-stream-content-event-missing"},text:n})}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Call);var Meeting=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getWrapperClassName",value:function t(){return""}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-meeting"}},{key:"prepareActions",value:function t(){}},{key:"getPrepositionText",value:function t(){return this.getMessage("reciprocal")}},{key:"getRemoveMessage",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"SUBJECT","");i=BX.util.htmlspecialchars(i);return this.getMessage("meetingRemove").replace("#TITLE#",i)}},{key:"getTypeDescription",value:function t(){return this.getMessage("meeting")}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Activity$1);var Task=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getWrapperClassName",value:function t(){return"crm-entity-stream-section-planned-task"}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-task"}},{key:"getTypeDescription",value:function t(){return this.getMessage("task")}},{key:"getPrepositionText",value:function t(e){return this.getMessage("reciprocal")}},{key:"getRemoveMessage",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"SUBJECT","");i=BX.util.htmlspecialchars(i);return this.getMessage("taskRemove").replace("#TITLE#",i)}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Activity$1);var StoreDocument=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getWrapperClassName",value:function t(){return"crm-entity-stream-section-planned-store-document"}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-store-document"}},{key:"getTypeDescription",value:function t(){return this.getMessage("storeDocument")}},{key:"getPrepositionText",value:function t(e){return this.getMessage("reciprocal")}},{key:"getRemoveMessage",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"SUBJECT","");i=BX.util.htmlspecialchars(i);return this.getMessage("taskRemove").replace("#TITLE#",i)}},{key:"isEditable",value:function t(){return false}},{key:"prepareContent",value:function t(e){var i=this.getDeadline();var s=i?this.formatDateTime(i):this.getMessage("termless");var n=this.getAssociatedEntityData();var a=BX.prop.getInteger(n,"DIRECTION",0);var r=this.isDone();var o=this.getWrapperClassName();if(o!==""){o="crm-entity-stream-section crm-entity-stream-section-planned"+" "+o}else{o="crm-entity-stream-section crm-entity-stream-section-planned"}var l=BX.create("DIV",{attrs:{className:o}});var c=this.getIconClassName();if(this.isCounterEnabled()){c+=" crm-entity-stream-section-counter"}l.appendChild(BX.create("DIV",{attrs:{className:c}}));if(this.isContextMenuEnabled()){l.appendChild(this.prepareContextMenuButton())}var u=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}});l.appendChild(u);var h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});u.appendChild(h);this._deadlineNode=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:s});var d=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});d.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getTypeDescription(a)}));var p=this.getStatusNode();if(p){d.appendChild(p)}d.appendChild(this._deadlineNode);h.appendChild(d);var m=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});h.appendChild(m);m.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:[BX.create("SPAN",{text:this.getMessage("storeDocumentDescription")}),BX.create("A",{attrs:{className:"crm-entity-stream-content-detail-target",href:"#"},events:{click:BX.delegate((function(t){top.BX.Helper.show("redirect=detail&code=14828480");t.preventDefault?t.preventDefault():t.returnValue=false}))},text:" "+BX.message("CRM_TIMELINE_DETAILS")})]}));var y=this.prepareDetailNodes();if(BX.type.isArray(y)){var f=0;var g=y.length;for(;f<g;f++){m.appendChild(y[f])}}var v=BX.create("INPUT",{attrs:{type:"checkbox",className:"crm-entity-stream-planned-apply-btn",checked:r},events:{change:this._setAsDoneButtonHandler}});if(!this.canComplete()){v.disabled=true}var _=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-planned-action"},children:[v]});h.appendChild(_);var I=this.prepareAuthorLayout();if(I){h.appendChild(I)}this._actionContainer=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-action"}});h.appendChild(this._actionContainer);return l}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Activity$1);var WebForm=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getWrapperClassName",value:function t(){return""}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-crmForm"}},{key:"prepareActions",value:function t(){}},{key:"getPrepositionText",value:function t(){return this.getMessage("from")}},{key:"getTypeDescription",value:function t(){return this.getMessage("webform")}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Activity$1);var Wait$1=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._postponeController=null;return t}babelHelpers.createClass(e,[{key:"getTypeId",value:function t(){return Item.wait}},{key:"getWrapperClassName",value:function t(){return"crm-entity-stream-section-wait"}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-wait"}},{key:"prepareActions",value:function t(){}},{key:"isCounterEnabled",value:function t(){return false}},{key:"getDeadline",value:function t(){var e=this.getAssociatedEntityData();var i=BX.parseDate(e["DEADLINE_SERVER"],false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");if(!i){return null}return new Date(i.getTime()+1e3*Item$1.getUserTimezoneOffset())}},{key:"isDone",value:function t(){return BX.prop.getString(this.getAssociatedEntityData(),"COMPLETED","N")==="Y"}},{key:"setAsDone",value:function t(e){e=!!e;if(this.isDone()===e){return}var i=this.getAssociatedEntityId();if(i>0){var s=this._schedule.getManager().getWaitEditor();if(s){s.complete(i,e,BX.delegate(this.onSetAsDoneCompleted,this))}}}},{key:"postpone",value:function t(e){var i=this.getAssociatedEntityId();if(i>0&&e>0){var s=this._schedule.getManager().getWaitEditor();if(s){s.postpone(i,e,BX.delegate(this.onPosponeCompleted,this))}}}},{key:"isContextMenuEnabled",value:function t(){return!!this.getDeadline()&&this.canPostpone()}},{key:"prepareContent",value:function t(){var e=this.getDeadline();var i=e?this.formatDateTime(e):this.getMessage("termless");var s=this.getAssociatedEntityData();var n=this.isDone();var a=BX.prop.getString(s,"DESCRIPTION_RAW","");var r=this.getWrapperClassName();if(r!==""){r="crm-entity-stream-section crm-entity-stream-section-planned"+" "+r}else{r="crm-entity-stream-section crm-entity-stream-section-planned"}var o=BX.create("DIV",{attrs:{className:r}});var l=this.getIconClassName();if(this.isCounterEnabled()){l+=" crm-entity-stream-section-counter"}o.appendChild(BX.create("DIV",{attrs:{className:l}}));if(this.isContextMenuEnabled()){o.appendChild(this.prepareContextMenuButton())}var c=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}});o.appendChild(c);if(a!==""){a=BX.util.trim(a);a=BX.util.strip_tags(a);a=this.cutOffText(a,512);a=BX.util.nl2br(a)}var u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});c.appendChild(u);this._deadlineNode=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:i});var h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getMessage("wait")}),this._deadlineNode]});u.appendChild(h);var d=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});u.appendChild(d);d.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},html:a}));var p=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});d.appendChild(p);var m=BX.create("INPUT",{attrs:{type:"checkbox",className:"crm-entity-stream-planned-apply-btn",checked:n},events:{change:this._setAsDoneButtonHandler}});if(!this.canComplete()){m.disabled=true}var y=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-planned-action"},children:[m]});u.appendChild(y);var f=this.prepareAuthorLayout();if(f){u.appendChild(f)}this._actionContainer=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-action"}});u.appendChild(this._actionContainer);return o}},{key:"prepareContextMenuItems",value:function t(){var e=[];var i=BX.delegate(this.onContextMenuItemSelect,this);if(!this._postponeController){this._postponeController=SchedulePostponeController.create("",{item:this})}var s={id:"postpone",text:this._postponeController.getTitle(),items:[]};var n=this._postponeController.getCommandList();var a=0;var r=n.length;for(;a<r;a++){var o=n[a];s.items.push({id:o["name"],text:o["title"],onclick:i})}e.push(s);return e}},{key:"onContextMenuItemSelect",value:function t(e,i){this.closeContextMenu();if(this._postponeController){this._postponeController.processCommand(i.id)}}},{key:"getTypeDescription",value:function t(){return this.getMessage("wait")}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Scheduled);var Request=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getWrapperClassName",value:function t(){return""}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-robot"}},{key:"getTypeDescription",value:function t(){return this.getMessage("activityRequest")}},{key:"isEditable",value:function t(){return false}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Activity$1);var Rest$1=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getWrapperClassName",value:function t(){return""}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-rest"}},{key:"prepareContent",value:function t(i){var s=babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"prepareContent",this).call(this,i);var n=this.getAssociatedEntityData();if(n["APP_TYPE"]&&n["APP_TYPE"]["ICON_SRC"]){var a=s.querySelector('[class="'+this.getIconClassName()+'"]');if(a){a.style.backgroundImage="url('"+n["APP_TYPE"]["ICON_SRC"]+"')";a.style.backgroundPosition="center center"}}return s}},{key:"getTypeDescription",value:function t(){var e=this.getAssociatedEntityData();if(e["APP_TYPE"]&&e["APP_TYPE"]["NAME"]){return e["APP_TYPE"]["NAME"]}return this.getMessage("restApplication")}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Activity$1);var OpenLine=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._clickHandler=BX.delegate(t.onClick,babelHelpers.assertThisInitialized(t));t._button=null;return t}babelHelpers.createClass(e,[{key:"getButton",value:function t(){return this._button}},{key:"onClick",value:function t(){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("openLineNotSupported"));return}var e="";var i=BX.prop.getObject(this._entityData,"COMMUNICATION",null);if(i){if(BX.prop.getString(i,"TYPE")==="IM"){e=BX.prop.getString(i,"VALUE")}}if(e!==""){window.top["BXIM"].openMessengerSlider(e,{RECENT:"N",MENU:"N"})}}},{key:"doLayout",value:function t(){this._button=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}});this._container.appendChild(this._button)}},{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Activity);babelHelpers.defineProperty(OpenLine,"messages",{});var OpenLine$1=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getWrapperClassName",value:function t(){return"crm-entity-stream-section-IM"}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-IM"}},{key:"prepareActions",value:function t(){if(this.isReadOnly()){return}this._actions.push(OpenLine.create("openline",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._schedule.getOwnerInfo()}))}},{key:"getTypeDescription",value:function t(){return this.getMessage("openLine")}},{key:"getPrepositionText",value:function t(e){return this.getMessage("reciprocal")}},{key:"prepareCommunicationNode",value:function t(e){return null}},{key:"prepareDetailNodes",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM"}});var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM-messages"}});e.appendChild(i);var s=BX.prop.getObject(this.getAssociatedEntityData(),"OPENLINE_INFO",null);if(s){var n=BX.prop.getArray(s,"MESSAGES",[]);var a=0;var r=n.length;for(;a<r;a++){var o=n[a];var l=BX.prop.getBoolean(o,"IS_EXTERNAL",true);i.appendChild(BX.create("DIV",{attrs:{className:l?"crm-entity-stream-content-detail-IM-message-incoming":"crm-entity-stream-content-detail-IM-message-outgoing"},html:BX.prop.getString(o,"MESSAGE","")}))}}return[e]}},{key:"view",value:function t(){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("openLineNotSupported"));return}var e="";var i=BX.prop.getObject(this.getAssociatedEntityData(),"COMMUNICATION",null);if(i){if(BX.prop.getString(i,"TYPE")==="IM"){e=BX.prop.getString(i,"VALUE")}}if(e!==""){window.top["BXIM"].openMessengerSlider(e,{RECENT:"N",MENU:"N"})}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Activity$1);var Zoom=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getWrapperClassName",value:function t(){return"crm-entity-stream-section-zoom"}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-zoom"}},{key:"getTypeDescription",value:function t(){return this.getMessage("zoom")}},{key:"getPrepositionText",value:function t(e){}},{key:"prepareCommunicationNode",value:function t(e){return null}},{key:"prepareContent",value:function t(e){var i=this.getDeadline();var s=i?this.formatDateTime(i):this.getMessage("termless");var n=this.getAssociatedEntityData();var a=BX.prop.getInteger(n,"DIRECTION",0);var r=this.isDone();var o=BX.prop.getString(n,"SUBJECT","");var l=BX.prop.getString(n,"DESCRIPTION_RAW","");var c=BX.prop.getObject(n,"COMMUNICATION",{});var u=BX.prop.getString(c,"TITLE","");var h=BX.prop.getString(c,"SHOW_URL","");var d=BX.prop.getString(c,"TYPE","")!==""?BX.prop.getString(c,"VALUE",""):"";var p=this.getWrapperClassName();if(p!==""){p="crm-entity-stream-section crm-entity-stream-section-planned"+" "+p}else{p="crm-entity-stream-section crm-entity-stream-section-planned"}var m=BX.create("DIV",{attrs:{className:p}});var y=this.getIconClassName();if(this.isCounterEnabled()){y+=" crm-entity-stream-section-counter"}m.appendChild(BX.create("DIV",{attrs:{className:y}}));if(this.isContextMenuEnabled()){m.appendChild(this.prepareContextMenuButton())}var f=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}});m.appendChild(f);if(l!==""){l=l.replace(/^\s+/,"")}var g=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});f.appendChild(g);this._deadlineNode=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:s});var v=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getTypeDescription(a)}),this._deadlineNode]});g.appendChild(v);var _=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});g.appendChild(_);if(n["ZOOM_INFO"]){var I=n["ZOOM_INFO"]["TOPIC"];var C=n["ZOOM_INFO"]["DURATION"];var E=BX.parseDate(n["ZOOM_INFO"]["CONF_START_TIME"],false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");var B=new Date(E.getTime()+1e3*Item$1.getUserTimezoneOffset());var T=BX.create("span",{text:this.getMessage("zoomCreatedMessage").replace("#CONFERENCE_TITLE#",I).replace("#DATE_TIME#",this.formatDateTime(B)).replace("#DURATION#",C)});var D=BX.create("A",{attrs:{href:n["ZOOM_INFO"]["CONF_URL"],target:"_blank"},text:n["ZOOM_INFO"]["CONF_URL"]});var S=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-zoom-info"},children:[T,D]});_.appendChild(S);var X=BX.create("A",{attrs:{className:"ui-link ui-link-dashed","data-url":n["ZOOM_INFO"]["CONF_URL"]},text:this.getMessage("zoomCreatedCopyInviteLink")});BX.clipboard.bindCopyClick(X,{text:n["ZOOM_INFO"]["CONF_URL"]});var b=BX.create("BUTTON",{attrs:{className:"ui-btn ui-btn-sm ui-btn-primary"},text:this.getMessage("zoomCreatedStartConference"),events:{click:function t(){window.open(n["ZOOM_INFO"]["CONF_URL"])}}});var N=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-zoom-link-wrapper"},children:[X]});_.appendChild(N);_.appendChild(b)}var k=this.prepareDetailNodes();if(BX.type.isArray(k)){var A=0;var M=k.length;for(;A<M;A++){_.appendChild(k[A])}}var O=BX.create("INPUT",{attrs:{type:"checkbox",className:"crm-entity-stream-planned-apply-btn",checked:r},events:{change:this._setAsDoneButtonHandler}});if(!this.canComplete()){O.disabled=true}var R=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-planned-action"},children:[O]});g.appendChild(R);var P=this.prepareAuthorLayout();if(P){g.appendChild(P)}this._actionContainer=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-action"}});g.appendChild(this._actionContainer);return m}},{key:"prepareDetailNodes",value:function t(){}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Activity$1);var Item$2=function(){function t(){babelHelpers.classCallCheck(this,t);this._id="";this._settings={};this._initialItem=null;this._finalItem=null;this._events=null}babelHelpers.createClass(t,[{key:"initialize",value:function t(e,i){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=i?i:{};this._initialItem=this.getSetting("initialItem");this._finalItem=this.getSetting("finalItem");this._anchor=this.getSetting("anchor");this._events=this.getSetting("events",{})}},{key:"getId",value:function t(){return this._id}},{key:"getSetting",value:function t(e,i){return this._settings.hasOwnProperty(e)?this._settings[e]:i}},{key:"run",value:function t(){this._node=this._initialItem.getWrapper();var e=BX.pos(this._node);this._initialYPosition=e.top;this._initialXPosition=e.left;this._initialWidth=this._node.offsetWidth;this._initialHeight=this._node.offsetHeight;this._anchorYPosition=BX.pos(this._anchor).top;this.createStub();this.createGhost();this.moveGhost()}},{key:"createStub",value:function t(){this._stub=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-planned crm-entity-stream-section-shadow"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon"}}),BX.create("DIV",{props:{className:"crm-entity-stream-section-content"},style:{height:this._initialHeight+"px"}})]});this._node.parentNode.insertBefore(this._stub,this._node)}},{key:"createGhost",value:function t(){this._ghostNode=this._node;this._ghostNode.style.position="absolute";this._ghostNode.style.width=this._initialWidth+"px";this._ghostNode.style.height=this._initialHeight+"px";this._ghostNode.style.top=this._initialYPosition+"px";this._ghostNode.style.left=this._initialXPosition+"px";document.body.appendChild(this._ghostNode);setTimeout(BX.proxy((function(){BX.addClass(this._ghostNode,"crm-entity-stream-section-casper")}),this),20)}},{key:"moveGhost",value:function t(){var e=this._ghostNode;var i=new BX.easing({duration:500,start:{top:this._initialYPosition},finish:{top:this._anchorYPosition},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(t){e.style.top=t.top+"px"}),this)});setTimeout(BX.proxy((function(){i.animate();e.style.boxShadow=""}),this),500);var s=new BX.easing({duration:500,start:{height:0},finish:{height:this._initialHeight+20},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(t){this._anchor.style.height=t.height+"px"}),this),complete:BX.proxy((function(){if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}this.addHistoryItem();this.removeGhost()}),this)});setTimeout((function(){s.animate()}),500)}},{key:"addHistoryItem",value:function t(){var e=this._finalItem.getWrapper();this._anchor.parentNode.insertBefore(e,this._anchor.nextSibling);this._finalItemHeight=this._anchor.offsetHeight-e.offsetHeight;this._anchor.style.height=0;e.style.marginBottom=this._finalItemHeight+"px"}},{key:"removeGhost",value:function t(){var e=this._ghostNode;var i=this._finalItem.getWrapper();e.style.overflow="hidden";var s=new BX.easing({duration:70,start:{opacity:100,height:e.offsetHeight,marginBottom:this._finalItemHeight},finish:{opacity:0,height:i.offsetHeight,marginBottom:20},step:BX.proxy((function(t){e.style.opacity=t.opacity/100;e.style.height=t.height+"px";i.style.marginBottom=t.marginBottom+"px"}),this),complete:BX.proxy((function(){e.remove();i.style.marginBottom="";this.collapseStub()}),this)});s.animate()}},{key:"collapseStub",value:function t(){var e=new BX.easing({duration:500,start:{opacity:100,height:this._initialHeight,marginBottom:15},finish:{opacity:0,height:0,marginBottom:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(t){this._stub.style.height=t.height+"px";this._stub.style.marginBottom=t.marginBottom+"px";this._stub.style.opacity=t.opacity/100}),this),complete:BX.proxy((function(){this.inited=false}),this)});e.animate()}}],[{key:"create",value:function e(i,s){var n=new t;n.initialize(i,s);return n}}]);return t}();var Shift=function(){function t(){babelHelpers.classCallCheck(this,t);this._node=null;this._anchor=null;this._nodeParent=null;this._startPosition=null;this._events=null}babelHelpers.createClass(t,[{key:"initialize",value:function t(e,i,s,n,a){this._node=e;this._shadowNode=n;this._anchor=i;this._nodeParent=e.parentNode;this._startPosition=s;this._events=BX.type.isPlainObject(a)?a:{}}},{key:"run",value:function t(){this._anchorPosition=BX.pos(this._anchor);setTimeout(BX.proxy((function(){BX.addClass(this._node,"crm-entity-stream-section-casper")}),this),0);var e=new BX.easing({duration:1500,start:{top:this._startPosition.top,height:0},finish:{top:this._anchorPosition.top,height:this._startPosition.height+20},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(t){this._node.style.top=t.top+"px";this._anchor.style.height=t.height+"px"}),this),complete:BX.proxy((function(){this.finish()}),this)});e.animate()}},{key:"finish",value:function t(){if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}if(this._shadowNode!==false);}}],[{key:"create",value:function e(i,s,n,a,r){var o=new t;o.initialize(i,s,n,a,r);return o}}]);return t}();var ItemNew=function(){function t(){babelHelpers.classCallCheck(this,t);this._id="";this._settings={};this._initialItem=null;this._finalItem=null;this._events=null}babelHelpers.createClass(t,[{key:"initialize",value:function t(e,i){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=i?i:{};this._initialItem=this.getSetting("initialItem");this._finalItem=this.getSetting("finalItem");this._anchor=this.getSetting("anchor");this._events=this.getSetting("events",{})}},{key:"getId",value:function t(){return this._id}},{key:"getSetting",value:function t(e,i){return this._settings.hasOwnProperty(e)?this._settings[e]:i}},{key:"addHistoryItem",value:function t(){var e=this._finalItem.getWrapper();this._anchor.parentNode.insertBefore(e,this._anchor.nextSibling)}},{key:"run",value:function t(){this._node=this._initialItem.getWrapper();this.createStub();BX.addClass(this._node,"crm-entity-stream-section-animate-start");this._startPosition=BX.pos(this._stub);this._node.style.position="absolute";this._node.style.width=this._startPosition.width+"px";this._node.style.height=this._startPosition.height+"px";this._node.style.top=this._startPosition.top+"px";this._node.style.left=this._startPosition.left+"px";this._node.style.zIndex=960;document.body.appendChild(this._node);var e=Shift.create(this._node,this._anchor,this._startPosition,this._stub,{complete:BX.delegate(this.finish,this)});e.run()}},{key:"createStub",value:function t(){this._stub=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-planned crm-entity-stream-section-shadow"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon"}}),BX.create("DIV",{props:{className:"crm-entity-stream-section-content"},style:{height:this._initialItem._wrapper.clientHeight+"px"}})]});this._node.parentNode.insertBefore(this._stub,this._node)}},{key:"finish",value:function t(){var e=this._stub.querySelector(".crm-entity-stream-section-content");this._anchor.style.height=0;setTimeout(BX.delegate((function(){BX.removeClass(this._node,"crm-entity-stream-section-animate-start")}),this),0);this._node.style.opacity=0;setTimeout(BX.delegate((function(){e.style.height=0;e.style.opacity=0;e.style.paddingTop=0;e.style.paddingBottom=0}),this),120);setTimeout(BX.delegate((function(){BX.remove(this._stub);BX.remove(this._node);this.addHistoryItem();if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}}),this),420)}}],[{key:"create",value:function e(i,s){var n=new t;n.initialize(i,s);return n}}]);return t}();var Schedule=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._items=[];t._history=null;t._wrapper=null;t._anchor=null;t._stub=null;t._timeFormat="";return t}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){var e=BX.message("FORMAT_DATETIME").replace(/:SS/,"");var i=BX.message("FORMAT_DATE");var s=BX.util.trim(e.replace(i,""));this._timeFormat=BX.date.convertBitrixFormat(s);if(!this.isStubMode()){var n=this.getSetting("itemData");if(!BX.type.isArray(n)){n=[]}var a,r,o;for(a=0,r=n.length;a<r;a++){o=this.createItem(n[a]);if(o){this._items.push(o)}}}}},{key:"layout",value:function t(){this._wrapper=BX.create("DIV",{});this._container.appendChild(this._wrapper);var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-planned-label"},text:this.getMessage("planned")});var i="crm-entity-stream-section crm-entity-stream-section-planned-label";this._wrapper.appendChild(BX.create("DIV",{attrs:{className:i},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[e]})]}));if(this.isStubMode()){this.addStub()}else{var s=this._items.length;if(s===0){this.addStub()}else{for(var n=0;n<s;n++){var a=this._items[n];a.setContainer(this._wrapper);a.layout()}}}this.refreshLayout();this._manager.processSheduleLayoutChange()}},{key:"refreshLayout",value:function t(){BX.onCustomEvent("Schedule:onBeforeRefreshLayout",[this]);var e=this._items.length;if(e===0){this.addStub();if(this._history&&this._history.hasContent()){BX.removeClass(this._stub,"crm-entity-stream-section-last")}else{BX.addClass(this._stub,"crm-entity-stream-section-last")}var i=this._stub.querySelector(".crm-entity-stream-section-icon");if(i){if(this._manager.isStubCounterEnabled()){BX.addClass(i,"crm-entity-stream-section-counter")}else{BX.removeClass(i,"crm-entity-stream-section-counter")}}return}var s,n;if(this._history&&this._history.hasContent()){for(s=0;s<e;s++){n=this._items[s];if(n.isTerminated()){n.markAsTerminated(false)}}}else{if(e>1){for(s=0;s<e-1;s++){n=this._items[s];if(n.isTerminated()){n.markAsTerminated(false)}}}this._items[e-1].markAsTerminated(true)}}},{key:"formatDateTime",value:function t(e){var i=new Date;return BX.date.format([["today","today, "+this._timeFormat],["tommorow","tommorow, "+this._timeFormat],["yesterday","yesterday, "+this._timeFormat],["",(e.getFullYear()===i.getFullYear()?"j F ":"j F Y ")+this._timeFormat]],e,i)}},{key:"checkItemForTermination",value:function t(e){if(this._history&&this._history.getItemCount()>0){return false}return this.getLastItem()===e}},{key:"getLastItem",value:function t(){return this._items.length>0?this._items[this._items.length-1]:null}},{key:"calculateItemIndex",value:function t(e){var i,s;var n=e.getDeadline();if(n){for(i=0,s=this._items.length;i<s;i++){var a=this._items[i].getDeadline();if(!a||n<=a){return i}}}else{var r=e.getSourceId();for(i=0,s=this._items.length;i<s;i++){if(this._items[i].getDeadline()){continue}if(r<=this._items[i].getSourceId()){return i}}}return this._items.length}},{key:"getItemCount",value:function t(){return this._items.length}},{key:"getItems",value:function t(){return this._items}},{key:"getItemByAssociatedEntity",value:function t(e,i){if(!BX.type.isNumber(e)){e=parseInt(e)}if(!BX.type.isNumber(i)){i=parseInt(i)}if(isNaN(e)||e<=0||isNaN(i)||i<=0){return null}for(var s=0,n=this._items.length;s<n;s++){var a=this._items[s];if(a.getAssociatedEntityTypeId()===e&&a.getAssociatedEntityId()===i){return a}}return null}},{key:"getItemByData",value:function t(e){if(!BX.type.isPlainObject(e)){return null}return this.getItemByAssociatedEntity(BX.prop.getInteger(e,"ASSOCIATED_ENTITY_TYPE_ID",0),BX.prop.getInteger(e,"ASSOCIATED_ENTITY_ID",0))}},{key:"getItemIndex",value:function t(e){for(var i=0,s=this._items.length;i<s;i++){if(this._items[i]===e){return i}}return-1}},{key:"getItemByIndex",value:function t(e){return e<this._items.length?this._items[e]:null}},{key:"removeItemByIndex",value:function t(e){if(e<this._items.length){this._items.splice(e,1)}}},{key:"createItem",value:function t(e){var i=BX.prop.getInteger(e,"ASSOCIATED_ENTITY_TYPE_ID",0);var s=BX.prop.getInteger(e,"ASSOCIATED_ENTITY_ID",0);var n=BX.prop.getObject(e,"ASSOCIATED_ENTITY",{});var a=BX.CrmEntityType.resolveName(i)+"_"+s.toString();if(i===BX.CrmEntityType.enumeration.wait){return Wait$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else{var r=BX.prop.getInteger(n,"TYPE_ID",0);var o=BX.prop.getString(n,"PROVIDER_ID","");if(r===BX.CrmActivityType.email){return Email$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(r===BX.CrmActivityType.call){return Call.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(r===BX.CrmActivityType.meeting){return Meeting.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(r===BX.CrmActivityType.task){return Task.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(r===BX.CrmActivityType.provider){if(o==="CRM_WEBFORM"){return WebForm.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(o==="CRM_REQUEST"){return Request.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(o==="IMOPENLINES_SESSION"){return OpenLine$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(o==="ZOOM"){return Zoom.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(o==="REST_APP"){return Rest$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(o==="CRM_DELIVERY"){return Activity$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:e,vueComponent:BX.Crm.Timeline.DeliveryActivity})}else if(o==="CRM_CALL_TRACKER"){return CallTracker.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(o==="STORE_DOCUMENT"){return StoreDocument.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:e})}}}return null}},{key:"addItem",value:function t(e,i){if(!BX.type.isNumber(i)||i<0){i=this.calculateItemIndex(e)}if(i<this._items.length){this._items.splice(i,0,e)}else{this._items.push(e)}this.removeStub();this.refreshLayout();this._manager.processSheduleLayoutChange()}},{key:"getHistory",value:function t(){return this._history}},{key:"setHistory",value:function t(e){this._history=e}},{key:"createAnchor",value:function t(e){this._anchor=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-shadow"}});if(e>=0&&e<this._items.length){this._wrapper.insertBefore(this._anchor,this._items[e].getWrapper())}else{this._wrapper.appendChild(this._anchor)}return this._anchor}},{key:"deleteItem",value:function t(e){var i=this.getItemIndex(e);if(i<0){return}e.clearLayout();this.removeItemByIndex(i);this.refreshLayout();this._manager.processSheduleLayoutChange()}},{key:"refreshItem",value:function t(e){var i=this.getItemIndex(e);if(i<0){return}this.removeItemByIndex(i);var s=this.createItem(e.getData());var n=this.calculateItemIndex(s);if(n===i){this.addItem(e,n);e.refreshLayout();e.addWrapperClass("crm-entity-stream-section-updated",1e3);return}var a=this.createAnchor(n);this.addItem(s,n);s.layout({add:false});var r=Item$2.create("",{initialItem:e,finalItem:s,anchor:a});r.run()}},{key:"transferItemToHistory",value:function t(e,i){var s=this.getItemIndex(e);if(s<0){return}this.removeItemByIndex(s);this.refreshLayout();this._manager.processSheduleLayoutChange();var n=this._history.createItem(i);this._history.addItem(n,0);n.layout({add:false});var a=ItemNew.create("",{initialItem:e,finalItem:n,anchor:this._history.createAnchor(),events:{complete:BX.delegate(this.onTransferComplete,this)}});a.run()}},{key:"onTransferComplete",value:function t(){this._history.refreshLayout();if(this._items.length===0){this.addStub()}}},{key:"onItemMarkedAsDone",value:function t(e,i){}},{key:"addStub",value:function t(){if(!this._stub){var e="crm-entity-stream-section crm-entity-stream-section-planned crm-entity-stream-section-notTask";var i="crm-entity-stream-section-icon crm-entity-stream-section-icon-info";var s=this.getMessage("stub");var n=this._manager.getOwnerTypeId();if(n===BX.CrmEntityType.enumeration.lead){s=this.getMessage("leadStub")}else if(n===BX.CrmEntityType.enumeration.deal){s=this.getMessage("dealStub")}if(this._manager.isStubCounterEnabled()){i+=" crm-entity-stream-section-counter"}this._stub=BX.create("DIV",{attrs:{className:e},children:[BX.create("DIV",{attrs:{className:i}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},text:s})]})]})]});this._wrapper.appendChild(this._stub)}if(this._history&&this._history.getItemCount()>0){BX.removeClass(this._stub,"crm-entity-stream-section-last")}else{BX.addClass(this._stub,"crm-entity-stream-section-last")}}},{key:"removeStub",value:function t(){if(this._stub){this._stub=BX.remove(this._stub)}}},{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);e.items[n.getId()]=n;return n}}]);return e}(Steam);babelHelpers.defineProperty(Schedule,"items",{});babelHelpers.defineProperty(Schedule,"messages",{});var Modification=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"getTitle",value:function t(){return this.getTextDataParam("TITLE")}},{key:"prepareContent",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-info"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}));var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var s=this.prepareHeaderLayout();var n=[];if(BX.type.isNotEmptyString(this.getTextDataParam("START_NAME"))){n.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detain-info-status"},text:this.getTextDataParam("START_NAME")}));n.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-info-separator-icon"}}))}if(BX.type.isNotEmptyString(this.getTextDataParam("FINISH_NAME"))){n.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detain-info-status"},text:this.getTextDataParam("FINISH_NAME")}))}i.appendChild(s);i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-info"},children:n})]}));var a=this.prepareAuthorLayout();if(a){i.appendChild(a)}e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));return e}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(History);babelHelpers.defineProperty(Modification,"messages",{});var Conversion=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"getTitle",value:function t(){return this.getTextDataParam("TITLE")}},{key:"prepareContent",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-convert crm-entity-stream-section-history"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-convert"}}));var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var s=this.prepareHeaderLayout();i.appendChild(s);var n=[];var a=this.getArrayDataParam("ENTITIES");var r=0;var o=a.length;for(;r<o;r++){var l=a[r];var c=void 0;if(BX.prop.getString(l,"SHOW_URL","")===""){c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-convert"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detain-convert-status"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-status-text"},text:BX.CrmEntityType.getNotFoundMessage(l["ENTITY_TYPE_ID"])})]})]})}else{c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-convert"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detain-convert-status"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-status-text"},text:l["ENTITY_TYPE_CAPTION"]})]}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-convert-separator-icon"}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detain-convert-status"},children:[BX.create("A",{attrs:{className:"crm-entity-stream-content-detail-target",href:l["SHOW_URL"]},text:l["TITLE"]})]})]})}n.push(c)}i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:n}));var u=this.prepareAuthorLayout();if(u){i.appendChild(u)}e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));return e}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(History);babelHelpers.defineProperty(Conversion,"messages",{});var Email$2=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"prepareHeaderLayout",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});e.appendChild(this.prepareTitleLayout());var i=this.getAssociatedEntityData();var s=BX.prop.getObject(i,"EMAIL_INFO",null);var n=s!==null?BX.prop.getString(s,"STATUS_TEXT",""):"";var a=s!==null?BX.prop.getBoolean(s,"STATUS_ERROR",false):false;var r=!a?"crm-entity-stream-content-event-skipped":"crm-entity-stream-content-event-missing";if(n!==""){e.appendChild(BX.create("SPAN",{props:{className:r},text:n}))}var o=this.prepareMarkLayout();if(o){e.appendChild(o)}e.appendChild(this.prepareTimeLayout());return e}},{key:"prepareContextMenuItems",value:function t(){var e=[];if(!this.isReadOnly()){e.push({id:"view",text:this.getMessage("menuView"),onclick:BX.delegate(this.view,this)});e.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id))e.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)});else e.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}return e}},{key:"reply",value:function t(){}},{key:"replyAll",value:function t(){}},{key:"forward",value:function t(){}},{key:"getRemoveMessage",value:function t(){var e=BX.util.htmlspecialchars(this.getTitle());return this.getMessage("emailRemove").replace("#TITLE#",e)}},{key:"prepareContent",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}var s=BX.prop.getObject(e,"COMMUNICATION",{});var n=BX.prop.getString(s,"TITLE","");var a=BX.prop.getString(s,"SHOW_URL","");var r=BX.prop.getString(s,"VALUE","");var o=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-email"}});o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-email"}}));if(this.isFixed())BX.addClass(o,"crm-entity-stream-section-top-fixed");var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[l]}));var c=this.prepareHeaderLayout();l.appendChild(c);if(this.isContextMenuEnabled()){l.appendChild(this.prepareContextMenuButton())}var u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email"}});l.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:[u]}));u.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));var h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email-to"}});u.appendChild(h);if(n!==""){if(a!==""){h.appendChild(BX.create("A",{attrs:{href:a},text:n}))}else{h.appendChild(BX.create("SPAN",{text:n}))}}if(r!==""){if(n!==""){h.appendChild(BX.create("SPAN",{text:" "}))}h.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-email-address"},text:r}))}u.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email-fragment"},children:this.prepareCutOffElements(i,128,this._headerClickHandler)}));var d=this.prepareAuthorLayout();if(d){l.appendChild(d)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});l.appendChild(this._actionContainer);if(!this.isReadOnly())l.appendChild(this.prepareFixedSwitcherLayout());return o}},{key:"prepareActions",value:function t(){if(this.isReadOnly()){return}this._actions.push(HistoryEmail.create("email",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor}))}},{key:"showActions",value:function t(e){if(this._actionContainer){this._actionContainer.style.display=e?"":"none"}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(HistoryActivity);var Call$1=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._clickHandler=BX.delegate(t.onClick,babelHelpers.assertThisInitialized(t));t._menu=null;t._isMenuShown=false;t._menuItems=null;return t}babelHelpers.createClass(e,[{key:"getButton",value:function t(){return null}},{key:"onClick",value:function t(e){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("telephonyNotSupported"));return}var i="";var s=this.getItemData();var n=BX.prop.getArray(s,"PHONE",[]);if(n.length===1){this.addCall(n[0]["VALUE"])}else if(n.length>1){this.showMenu()}else{var a=BX.prop.getObject(this._entityData,"COMMUNICATION",null);if(a){if(BX.prop.getString(a,"TYPE")==="PHONE"){i=BX.prop.getString(a,"VALUE");if(i){this.addCall(i)}}}}return BX.PreventDefault(e)}},{key:"showMenu",value:function t(){if(this._isMenuShown){return}this.prepareMenuItems();if(!this._menuItems||this._menuItems.length===0){return}this._menu=new BX.PopupMenuWindow(this._id,this._container,this._menuItems,{offsetTop:0,offsetLeft:16,events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this),onPopupDestroy:BX.delegate(this.onMenuDestroy,this)}});this._menu.popupWindow.show()}},{key:"closeMenu",value:function t(){if(!this._isMenuShown){return}if(this._menu){this._menu.close()}}},{key:"prepareMenuItems",value:function t(){if(this._menuItems){return}var e=this.getItemData();var i=BX.prop.getArray(e,"PHONE",[]);var s=BX.delegate(this.onMenuItemClick,this);this._menuItems=[];if(i.length===0){return}var n=0;var a=i.length;for(;n<a;n++){var r=BX.prop.getString(i[n],"VALUE");var o=BX.prop.getString(i[n],"VALUE_FORMATTED");var l=BX.prop.getString(i[n],"COMPLEX_NAME");var c=(l?l+": ":"")+(o?o:r);if(r!==""){this._menuItems.push({id:r,text:c,onclick:s})}}}},{key:"onMenuItemClick",value:function t(e,i){this.closeMenu();this.addCall(i.id)}},{key:"onMenuShow",value:function t(){this._isMenuShown=true}},{key:"onMenuClose",value:function t(){this._isMenuShown=false;this._menu.popupWindow.destroy()}},{key:"onMenuDestroy",value:function t(){this._menu=null}},{key:"addCall",value:function t(e){var i=BX.prop.getObject(this._entityData,"COMMUNICATION",null);var s=parseInt(BX.prop.getString(i,"ENTITY_TYPE_ID","0"));if(isNaN(s)){s=0}var n=parseInt(BX.prop.getString(i,"ENTITY_ID","0"));if(isNaN(n)){n=0}var a=0;var r=0;var o=BX.prop.getObject(this._settings,"ownerInfo");if(o){a=BX.prop.getInteger(o,"ENTITY_TYPE_ID",0);r=BX.prop.getInteger(o,"ENTITY_ID",0)}if(a<=0||r<=0){a=BX.prop.getInteger(this._entityData,"OWNER_TYPE_ID",0);r=BX.prop.getInteger(this._entityData,"OWNER_ID","0")}if(a<=0||r<=0){a=s;r=n}var l=parseInt(BX.prop.getString(this._entityData,"ID","0"));if(isNaN(l)){l=0}var c={ENTITY_TYPE_NAME:BX.CrmEntityType.resolveName(s),ENTITY_ID:n,AUTO_FOLD:true};if(a!==s||r!==n){c["BINDINGS"]=[{OWNER_TYPE_NAME:BX.CrmEntityType.resolveName(a),OWNER_ID:r}]}if(l>0){c["SRC_ACTIVITY_ID"]=l}window.top["BXIM"].phoneTo(e,c)}},{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}]);return e}(Activity);babelHelpers.defineProperty(Call$1,"messages",{});var HistoryCall=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._button=null;return t}babelHelpers.createClass(e,[{key:"getButton",value:function t(){return this._button}},{key:"doLayout",value:function t(){this._button=BX.create("A",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}});this._container.appendChild(this._button)}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Call$1);var ScheduleCall=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"doLayout",value:function t(){this._container.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}}))}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Call$1);var Call$2=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._playerDummyClickHandler=BX.delegate(t.onPlayerDummyClick,babelHelpers.assertThisInitialized(t));t._playerWrapper=null;t._transcriptWrapper=null;t._mediaFileInfo=null;return t}babelHelpers.createClass(e,[{key:"getTypeDescription",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getObject(e,"CALL_INFO",null);var s=i!==null?BX.prop.getString(i,"CALL_TYPE_TEXT",""):"";if(s!==""){return s}var n=BX.prop.getInteger(e,"DIRECTION",0);return this.getMessage(n===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")}},{key:"prepareHeaderLayout",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});e.appendChild(this.prepareTitleLayout());var i=this.getAssociatedEntityData();var s=BX.prop.getObject(i,"CALL_INFO",null);var n=s!==null;var a=n?BX.prop.getBoolean(s,"SUCCESSFUL",false):false;var r=n?BX.prop.getString(s,"STATUS_TEXT",""):"";if(n&&r.length){e.appendChild(BX.create("DIV",{attrs:{className:a?"crm-entity-stream-content-event-successful":"crm-entity-stream-content-event-missing"},text:r}))}e.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));return e}},{key:"prepareContent",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}var s=BX.prop.getObject(e,"COMMUNICATION",{});var n=BX.prop.getString(s,"TITLE","");var a=BX.prop.getString(s,"SHOW_URL","");var r=BX.prop.getString(s,"VALUE","");var o=BX.prop.getString(s,"FORMATTED_VALUE",r);var l=BX.prop.getObject(e,"CALL_INFO",null);var c=l!==null;var u=c?BX.prop.getString(l,"DURATION_TEXT",""):"";var h=c?BX.prop.getBoolean(l,"HAS_TRANSCRIPT",""):"";var d=c?BX.prop.getBoolean(l,"TRANSCRIPT_PENDING",""):"";var p=c?BX.prop.getString(l,"CALL_ID",""):"";var m=c?BX.prop.getString(l,"COMMENT",""):"";var y=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-call"}});y.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-call"}}));if(this.isFixed())BX.addClass(y,"crm-entity-stream-section-top-fixed");var f=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});y.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[f]}));var g=this.prepareHeaderLayout();f.appendChild(g);if(this.isContextMenuEnabled()){f.appendChild(this.prepareContextMenuButton())}var v=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});f.appendChild(v);v.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));v.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareMultilineCutOffElements(i,128,this._headerClickHandler)}));if(c){var _=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-call crm-entity-stream-content-detail-call-inline"}});v.appendChild(_);this._mediaFileInfo=BX.prop.getObject(e,"MEDIA_FILE_INFO",null);if(this._mediaFileInfo!==null){this._playerWrapper=this._history.getManager().renderAudioDummy(u,this._playerDummyClickHandler);_.appendChild(this._playerWrapper);_.appendChild(this._history.getManager().getAudioPlaybackRateSelector().render())}if(h){this._transcriptWrapper=BX.create("DIV",{attrs:{className:"crm-audio-transcript-wrap-container"},events:{click:function t(e){if(BX.Voximplant&&BX.Voximplant.Transcript){BX.Voximplant.Transcript.create({callId:p}).show()}}},children:[BX.create("DIV",{attrs:{className:"crm-audio-transcript-icon"}}),BX.create("DIV",{attrs:{className:"crm-audio-transcript-conversation"},text:BX.message("CRM_TIMELINE_CALL_TRANSCRIPT")})]});_.appendChild(this._transcriptWrapper)}else if(d){this._transcriptWrapper=BX.create("DIV",{attrs:{className:"crm-audio-transcript-wrap-container-pending"},children:[BX.create("DIV",{attrs:{className:"crm-audio-transcript-icon-pending"},html:'<svg class="crm-transcript-loader-circular" viewBox="25 25 50 50"><circle class="crm-transcript-loader-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"></circle></svg>'}),BX.create("DIV",{attrs:{className:"crm-audio-transcript-conversation"},text:BX.message("CRM_TIMELINE_CALL_TRANSCRIPT_PENDING")})]});_.appendChild(this._transcriptWrapper)}if(m){v.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:m}))}}var I=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});v.appendChild(I);if(n!==""){if(a!==""){I.appendChild(BX.create("A",{attrs:{href:a},text:n}))}else{I.appendChild(BX.create("SPAN",{text:n}))}}if(o!==""){if(n!==""){I.appendChild(BX.create("SPAN",{text:" "}))}I.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-email-address"},text:o}))}var C=this.prepareAuthorLayout();if(C){f.appendChild(C)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});f.appendChild(this._actionContainer);if(!this.isReadOnly())f.appendChild(this.prepareFixedSwitcherLayout());return y}},{key:"prepareActions",value:function t(){if(this.isReadOnly()){return}this._actions.push(HistoryCall.create("call",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._history.getOwnerInfo()}))}},{key:"getRemoveMessage",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getInteger(e,"DIRECTION",0);var s=i===BX.CrmActivityDirection.incoming?"incomingCallRemove":"outgoingCallRemove";var n=BX.util.htmlspecialchars(this.getTitle());return this.getMessage(s).replace("#TITLE#",n)}},{key:"onPlayerDummyClick",value:function t(e){var i=this._playerWrapper.querySelector(".crm-audio-cap-wrap");if(i){BX.addClass(i,"crm-audio-cap-wrap-loader")}this._history.getManager().getAudioPlaybackRateSelector().addPlayer(this._history.getManager().loadMediaPlayer("history_"+this.getId(),this._mediaFileInfo["URL"],this._mediaFileInfo["TYPE"],this._playerWrapper,this._mediaFileInfo["DURATION"],{playbackRate:this._history.getManager().getAudioPlaybackRateSelector().getRate()}))}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(HistoryActivity);var Meeting$1=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"prepareHeaderLayout",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});e.appendChild(this.prepareTitleLayout());var i=this.prepareMarkLayout();if(i){e.appendChild(i)}e.appendChild(this.prepareTimeLayout());return e}},{key:"prepareContent",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}var s=BX.prop.getObject(e,"COMMUNICATION",{});var n=BX.prop.getString(s,"TITLE","");var a=BX.prop.getString(s,"SHOW_URL","");var r=BX.prop.getString(s,"VALUE","");var o=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-meeting"}});o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-meeting"}}));if(this.isContextMenuEnabled()){o.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(o,"crm-entity-stream-section-top-fixed");var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[l]}));var c=this.prepareHeaderLayout();l.appendChild(c);var u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});l.appendChild(u);u.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));u.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(i,128,this._headerClickHandler)}));var h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});u.appendChild(h);if(n!==""){h.appendChild(BX.create("SPAN",{text:this.getMessage("reciprocal")+": "}));if(a!==""){h.appendChild(BX.create("A",{attrs:{href:a},text:n}))}else{h.appendChild(BX.create("SPAN",{text:n}))}}h.appendChild(BX.create("SPAN",{text:" "+r}));var d=this.prepareAuthorLayout();if(d){l.appendChild(d)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});l.appendChild(this._actionContainer);if(!this.isReadOnly())l.appendChild(this.prepareFixedSwitcherLayout());return o}},{key:"getRemoveMessage",value:function t(){var e=BX.util.htmlspecialchars(this.getTitle());return this.getMessage("meetingRemove").replace("#TITLE#",e)}},{key:"prepareActions",value:function t(){}},{key:"showActions",value:function t(e){if(this._actionContainer){this._actionContainer.style.display=e?"":"none"}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(HistoryActivity);var Task$1=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"prepareHeaderLayout",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});e.appendChild(this.prepareTitleLayout());var i=this.prepareMarkLayout();if(i){e.appendChild(i)}e.appendChild(this.prepareTimeLayout());return e}},{key:"prepareContent",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}var s=BX.prop.getObject(e,"COMMUNICATION",{});var n=BX.prop.getString(s,"TITLE","");var a=BX.prop.getString(s,"SHOW_URL","");var r=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-task"}});r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-task"}}));if(this.isContextMenuEnabled()){r.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(r,"crm-entity-stream-section-top-fixed");var o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[o]}));var l=this.prepareHeaderLayout();o.appendChild(l);var c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});o.appendChild(c);c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(i,128,this._headerClickHandler)}));var u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});c.appendChild(u);if(n!==""){u.appendChild(BX.create("SPAN",{text:this.getMessage("reciprocal")+": "}));if(a!==""){u.appendChild(BX.create("A",{attrs:{href:a},text:n}))}else{u.appendChild(BX.create("SPAN",{text:n}))}}var h=this.prepareAuthorLayout();if(h){o.appendChild(h)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});o.appendChild(this._actionContainer);if(!this.isReadOnly())o.appendChild(this.prepareFixedSwitcherLayout());return r}},{key:"prepareActions",value:function t(){}},{key:"getRemoveMessage",value:function t(){var e=BX.util.htmlspecialchars(this.getTitle());return this.getMessage("taskRemove").replace("#TITLE#",e)}},{key:"showActions",value:function t(e){if(this._actionContainer){this._actionContainer.style.display=e?"":"none"}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(HistoryActivity);var WebForm$1=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"prepareHeaderLayout",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});e.appendChild(this.prepareTitleLayout());e.appendChild(this.prepareTimeLayout());return e}},{key:"prepareContent",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-crmForm"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-crmForm"}}));var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));if(this.isFixed())BX.addClass(e,"crm-entity-stream-section-top-fixed");var s=this.prepareHeaderLayout();i.appendChild(s);var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});i.appendChild(n);n.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));var a=this.prepareAuthorLayout();if(a){i.appendChild(a)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});i.appendChild(this._actionContainer);if(!this.isReadOnly())i.appendChild(this.prepareFixedSwitcherLayout());return e}},{key:"prepareActions",value:function t(){}},{key:"showActions",value:function t(e){if(this._actionContainer){this._actionContainer.style.display=e?"":"none"}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(HistoryActivity);var Sms$1=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"prepareHeaderLayout",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});e.appendChild(this.prepareTitleLayout());e.appendChild(this.prepareMessageStatusLayout());e.appendChild(this.prepareTimeLayout());return e}},{key:"prepareMessageStatusLayout",value:function t(){return this._messageStatusNode=BX.create("SPAN")}},{key:"prepareContent",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getObject(e,"COMMUNICATION",{});var s=BX.prop.getString(i,"TITLE","");var n=BX.prop.getString(i,"SHOW_URL","");var a=BX.prop.getString(i,"VALUE","");var r=BX.prop.getObject(e,"SMS_INFO",{});var o="crm-entity-stream-section-sms";var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history"+" "+o}});l.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-sms"}}));if(this.isFixed())BX.addClass(l,"crm-entity-stream-section-top-fixed");var c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});l.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[c]}));var u=this.prepareHeaderLayout();c.appendChild(u);var h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});c.appendChild(h);var d=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-sms"}});if(r.senderId){var p=r.senderId;var m=r.senderShortName;if(p==="rest"&&r.fromName){m=r.fromName}var y=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-sms-status"},children:[BX.message("CRM_TIMELINE_SMS_SENDER")+" ",BX.create("STRONG",{text:m})]});if(p!=="rest"&&r.fromName){y.innerHTML+=" "+BX.message("CRM_TIMELINE_SMS_FROM")+" ";y.appendChild(BX.create("STRONG",{text:r.fromName}))}d.appendChild(y)}if(r.statusId!==""){this.setMessageStatus(r.statusId,r.errorText)}var f=BX.util.htmlspecialchars(e["DESCRIPTION_RAW"]).replace(/\r\n|\r|\n/g,"<br/>");var g=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-sms-fragment"}});g.appendChild(BX.create("SPAN",{html:f}));d.appendChild(g);h.appendChild(d);var v=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"},text:BX.message("CRM_TIMELINE_SMS_TO")+" "});h.appendChild(v);if(s!==""){if(n!==""){v.appendChild(BX.create("A",{attrs:{href:n},text:s}))}else{v.appendChild(BX.create("SPAN",{text:s}))}}v.appendChild(BX.create("SPAN",{text:" "+a}));var _=this.prepareAuthorLayout();if(_){c.appendChild(_)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});c.appendChild(this._actionContainer);if(!this.isReadOnly())c.appendChild(this.prepareFixedSwitcherLayout());return l}},{key:"prepareActions",value:function t(){}},{key:"showActions",value:function t(e){if(this._actionContainer){this._actionContainer.style.display=e?"":"none"}}},{key:"setMessageStatus",value:function t(e,i){e=parseInt(e);if(isNaN(e)||!this._messageStatusNode)return;var s=this.getSetting("smsStatusDescriptions",{});if(s.hasOwnProperty(e)){this._messageStatusNode.textContent=s[e];this.setMessageStatusErrorText(i);var n=this.getMessageStatusSemantic(e);this.setMessageStatusSemantic(n)}}},{key:"setMessageStatusSemantic",value:function t(e){var i={process:"crm-entity-stream-content-event-process",success:"crm-entity-stream-content-event-successful",failure:"crm-entity-stream-content-event-missing"};for(var s in i){var n=s===e?"addClass":"removeClass";BX[n](this._messageStatusNode,i[s])}}},{key:"setMessageStatusErrorText",value:function t(e){if(!e){this._messageStatusNode.removeAttribute("title");BX.removeClass(this._messageStatusNode,"crm-entity-stream-content-event-error-tip")}else{this._messageStatusNode.setAttribute("title",e);BX.addClass(this._messageStatusNode,"crm-entity-stream-content-event-error-tip")}}},{key:"getMessageStatusSemantic",value:function t(e){var i=this.getSetting("smsStatusSemantics",{});return i.hasOwnProperty(e)?i[e]:"failure"}},{key:"subscribe",value:function t(){if(!BX.CrmSmsWatcher)return;var e=this.getAssociatedEntityData();var i=BX.prop.getObject(e,"SMS_INFO",{});if(i.id){BX.CrmSmsWatcher.subscribeOnMessageUpdate(i.id,this.onMessageUpdate.bind(this))}}},{key:"onMessageUpdate",value:function t(e){if(e.STATUS_ID){this.setMessageStatus(e.STATUS_ID,e.EXEC_ERROR)}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);n.subscribe();return n}}]);return e}(HistoryActivity);var Request$1=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"prepareHeaderLayout",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});e.appendChild(this.prepareTitleLayout());e.appendChild(this.prepareTimeLayout());return e}},{key:"prepareContent",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-today crm-entity-stream-section-robot"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-robot"}}));if(this.isContextMenuEnabled()){s.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(s,"crm-entity-stream-section-top-fixed");var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[n]}));var a=this.prepareHeaderLayout();n.appendChild(a);var r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});n.appendChild(r);r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(i,128,this._headerClickHandler)}));var o=this.prepareAuthorLayout();if(o){n.appendChild(o)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});n.appendChild(this._actionContainer);if(!this.isReadOnly())n.appendChild(this.prepareFixedSwitcherLayout());return s}},{key:"prepareActions",value:function t(){}},{key:"showActions",value:function t(e){if(this._actionContainer){this._actionContainer.style.display=e?"":"none"}}},{key:"isEditable",value:function t(){return false}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(HistoryActivity);var OpenLine$2=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"prepareHeaderLayout",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});e.appendChild(this.prepareTitleLayout());e.appendChild(this.prepareTimeLayout());return e}},{key:"prepareContent",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}var s=BX.prop.getObject(e,"COMMUNICATION",{});var n=BX.prop.getString(s,"TITLE","");var a=BX.prop.getString(s,"SHOW_URL","");var r=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-IM"}});r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-IM"}}));if(this.isContextMenuEnabled()){r.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(r,"crm-entity-stream-section-top-fixed");var o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[o]}));var l=this.prepareHeaderLayout();o.appendChild(l);var c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});o.appendChild(c);c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));var u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM"}});c.appendChild(u);var h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM-messages"}});u.appendChild(h);var d=BX.prop.getObject(this.getAssociatedEntityData(),"OPENLINE_INFO",null);if(d){var p=BX.prop.getArray(d,"MESSAGES",[]);var m=0;var y=p.length;for(;m<y;m++){var f=p[m];var g=BX.prop.getBoolean(f,"IS_EXTERNAL",true);h.appendChild(BX.create("DIV",{attrs:{className:g?"crm-entity-stream-content-detail-IM-message-incoming":"crm-entity-stream-content-detail-IM-message-outgoing"},html:BX.prop.getString(f,"MESSAGE","")}))}}var v=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});c.appendChild(v);if(n!==""){v.appendChild(BX.create("SPAN",{text:this.getMessage("reciprocal")+": "}));if(a!==""){v.appendChild(BX.create("A",{attrs:{href:a},text:n}))}else{v.appendChild(BX.create("SPAN",{text:n}))}}var _=this.prepareAuthorLayout();if(_){o.appendChild(_)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});o.appendChild(this._actionContainer);if(!this.isReadOnly())o.appendChild(this.prepareFixedSwitcherLayout());return r}},{key:"prepareActions",value:function t(){if(this.isReadOnly()){return}this._actions.push(OpenLine.create("openline",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._history.getOwnerInfo()}))}},{key:"view",value:function t(){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("openLineNotSupported"));return}var e="";var i=BX.prop.getObject(this.getAssociatedEntityData(),"COMMUNICATION",null);if(i){if(BX.prop.getString(i,"TYPE")==="IM"){e=BX.prop.getString(i,"VALUE")}}if(e!==""){window.top["BXIM"].openMessengerSlider(e,{RECENT:"N",MENU:"N"})}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(HistoryActivity);var Rest$2=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"prepareHeaderLayout",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});e.appendChild(this.prepareTitleLayout());e.appendChild(this.prepareTimeLayout());return e}},{key:"getTypeDescription",value:function t(){var i=this.getAssociatedEntityData();if(i["APP_TYPE"]&&i["APP_TYPE"]["NAME"]){return i["APP_TYPE"]["NAME"]}return babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"getTypeDescription",this).call(this)}},{key:"prepareContent",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-today crm-entity-stream-section-rest"}});var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-rest"}});s.appendChild(n);if(e["APP_TYPE"]&&e["APP_TYPE"]["ICON_SRC"]){if(n){n.style.backgroundImage="url('"+e["APP_TYPE"]["ICON_SRC"]+"')";n.style.backgroundPosition="center center"}}if(this.isFixed())BX.addClass(s,"crm-entity-stream-section-top-fixed");var a=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[a]}));var r=this.prepareHeaderLayout();a.appendChild(r);var o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});a.appendChild(o);o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(i,128,this._headerClickHandler)}));var l=this.prepareAuthorLayout();if(l){a.appendChild(l)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});a.appendChild(this._actionContainer);if(!this.isReadOnly())a.appendChild(this.prepareFixedSwitcherLayout());return s}},{key:"prepareActions",value:function t(){}},{key:"showActions",value:function t(e){if(this._actionContainer){this._actionContainer.style.display=e?"":"none"}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(HistoryActivity);var Visit=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._playerDummyClickHandler=BX.delegate(t.onPlayerDummyClick,babelHelpers.assertThisInitialized(t));t._playerWrapper=null;t._transcriptWrapper=null;t._mediaFileInfo=null;return t}babelHelpers.createClass(e,[{key:"prepareHeaderLayout",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});e.appendChild(this.prepareTitleLayout());var i=this.getAssociatedEntityData();var s=BX.prop.getObject(i,"VISIT_INFO",{});var n=BX.prop.getInteger(s,"RECORD_LENGTH",0);var a=BX.prop.getString(s,"RECORD_LENGTH_FORMATTED_FULL","");e.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:(n>0?a+", "+BX.message("CRM_TIMELINE_VISIT_AT")+" ":"")+this.formatTime(this.getCreatedTime())}));return e}},{key:"prepareContent",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getObject(e,"COMMUNICATION",{});var s=BX.prop.getString(i,"TITLE","");var n=BX.prop.getString(i,"SHOW_URL","");var a=BX.prop.getObject(e,"VISIT_INFO",{});var r=BX.prop.getInteger(a,"RECORD_LENGTH",0);var o=BX.prop.getString(a,"RECORD_LENGTH_FORMATTED_SHORT","");var l=BX.prop.getString(a,"VK_PROFILE","");var c=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-visit"}});c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-visit"}}));var u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[u]}));var h=this.prepareHeaderLayout();u.appendChild(h);if(this.isContextMenuEnabled()){u.appendChild(this.prepareContextMenuButton())}var d=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail crm-entity-stream-content-detail-call-inline"}});u.appendChild(d);this._mediaFileInfo=BX.prop.getObject(e,"MEDIA_FILE_INFO",null);if(this._mediaFileInfo!==null&&r>0){this._playerWrapper=this._history.getManager().renderAudioDummy(o,this._playerDummyClickHandler);d.appendChild(this._playerWrapper);d.appendChild(this._history.getManager().getAudioPlaybackRateSelector().render())}var p=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});u.appendChild(p);if(s!==""){p.appendChild(document.createTextNode(BX.message("CRM_TIMELINE_VISIT_WITH")+" "));if(n!==""){p.appendChild(BX.create("A",{attrs:{href:n},text:s}))}else{p.appendChild(BX.create("SPAN",{text:s}))}}if(BX.type.isNotEmptyString(l)){p.appendChild(document.createTextNode(" "));p.appendChild(BX.create("a",{attrs:{className:"crm-entity-stream-content-detail-additional",target:"_blank",href:this.getVkProfileUrl(l)},text:BX.message("CRM_TIMELINE_VISIT_VKONTAKTE_PROFILE")}))}var m=this.prepareAuthorLayout();if(m){u.appendChild(m)}return c}},{key:"onPlayerDummyClick",value:function t(e){var i=this._playerWrapper.querySelector(".crm-audio-cap-wrap");if(i){BX.addClass(i,"crm-audio-cap-wrap-loader")}this._history.getManager().getAudioPlaybackRateSelector().addPlayer(this._history.getManager().loadMediaPlayer("history_"+this.getId(),this._mediaFileInfo["URL"],this._mediaFileInfo["TYPE"],this._playerWrapper,this._mediaFileInfo["DURATION"],{playbackRate:this._history.getManager().getAudioPlaybackRateSelector().getRate()}))}},{key:"getVkProfileUrl",value:function t(e){return"https://vk.com/"+BX.util.htmlspecialchars(e)}},{key:"view",value:function t(){if(BX.getClass("BX.Crm.Restriction.Bitrix24")&&BX.Crm.Restriction.Bitrix24.isRestricted("visit")){return BX.Crm.Restriction.Bitrix24.getHandler("visit").call()}babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"view",this).call(this)}},{key:"edit",value:function t(){if(BX.getClass("BX.Crm.Restriction.Bitrix24")&&BX.Crm.Restriction.Bitrix24.isRestricted("visit")){return BX.Crm.Restriction.Bitrix24.getHandler("visit").call()}babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"edit",this).call(this)}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(HistoryActivity);var Zoom$1=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._videoDummy=null;t._audioDummy=null;t._videoPlayer=null;t._audioPlayer=null;t._audioLengthElement=null;t._recordings=[];t._currentRecordingIndex=0;t.zoomActivitySubject=null;t._downloadWrapper=null;t._downloadSubject=null;t._downloadSubjectDetail=null;t._downloadVideoLink=null;t._downloadSeparator=null;t._downloadAudioLink=null;t._playVideoLink=null;t.detailZoomCopyVideoLink=null;return t}babelHelpers.createClass(e,[{key:"prepareHeaderLayout",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});e.appendChild(this.prepareTitleLayout());if(!this._data.hasOwnProperty("PROVIDER_DATA")||this._data["PROVIDER_DATA"]["ZOOM_EVENT_TYPE"]!=="ZOOM_CONF_JOINED"){e.appendChild(this.prepareSuccessfulLayout())}e.appendChild(this.prepareTimeLayout());return e}},{key:"prepareSuccessfulLayout",value:function t(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-successful"},text:BX.message("CRM_TIMELINE_ZOOM_SUCCESSFUL_ACTIVITY")})}},{key:"prepareTitleLayout",value:function t(){if(this._data.hasOwnProperty("PROVIDER_DATA")&&this._data["PROVIDER_DATA"]["ZOOM_EVENT_TYPE"]==="ZOOM_CONF_JOINED"){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:BX.message("CRM_TIMELINE_ZOOM_JOINED_CONFERENCE")})}else{return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:BX.message("CRM_TIMELINE_ZOOM_CONFERENCE_END")})}}},{key:"prepareContent",value:function t(){var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history"}});var s;var n=BX.prop.getObject(this.getAssociatedEntityData(),"ZOOM_INFO",null);var a=BX.prop.getString(this.getAssociatedEntityData(),"SUBJECT",null);this._recordings=BX.prop.getArray(n,"RECORDINGS",[]);i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-zoom"}}));if(this.isFixed())BX.addClass(i,"crm-entity-stream-section-top-fixed");var r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[r]}));var o=this.prepareHeaderLayout();r.appendChild(o);var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});r.appendChild(l);if(this._data.hasOwnProperty("PROVIDER_DATA")&&this._data["PROVIDER_DATA"]["ZOOM_EVENT_TYPE"]==="ZOOM_CONF_JOINED"){s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:n["CONF_URL"]})}else{s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});if(this._recordings.length>0){if(this._recordings.length>1){var c=this._recordings.map((function(t,e){return{id:e,title:BX.message("CRM_TIMELINE_ZOOM_MEETING_RECORD_PART").replace("#NUMBER#",e+1),time:t["AUDIO"]?t["AUDIO"]["LENGTH_FORMATTED"]:"",active:e===0}}));var u=new e.TabsComponent({tabs:c});u.eventEmitter.subscribe("onTabChange",this._onTabChange.bind(this));l.appendChild(u.render())}this._videoDummy=BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video-wrap"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video"},events:{click:this._onVideoDummyClick.bind(this)},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video-inner"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video-btn"},dataset:{hint:BX.message("CRM_TIMELINE_ZOOM_LOGIN_REQUIRED"),hintNoIcon:"Y"}}),BX.create("SPAN",{props:{className:"crm-entity-stream-content-detail-zoom-video-text"},text:BX.message("CRM_TIMELINE_ZOOM_CLICK_TO_WATCH")})]})]})]});BX.UI.Hint.init(this._videoDummy);this._audioDummy=this._history.getManager().renderAudioDummy("00:15",this._onAudioDummyClick.bind(this));this._audioLengthElement=this._audioDummy.querySelector(".crm-audio-cap-time");if(n["RECORDINGS"][0]["VIDEO"]){var h=n["RECORDINGS"][0]["VIDEO"]["END_DATE_TS"]*1e3+60*60*23*1e3;if(h<Date.now()){var d=BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-desc"}});this._playVideoLink=BX.create("DIV",{html:BX.message("CRM_TIMELINE_ZOOM_PLAY_LINK_VIDEO")});this._detailZoomCopyVideoLink=BX.create("A",{attrs:{className:"ui-link ui-link-dashed"},text:BX.message("CRM_TIMELINE_ZOOM_COPY_PASSWORD")});d.appendChild(this._playVideoLink);d.appendChild(this._detailZoomCopyVideoLink);s.appendChild(d)}else{s.appendChild(this._videoDummy)}}if(n["RECORDINGS"][0]["AUDIO"]){var p=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-call crm-entity-stream-content-detail-call-inline"}});p.appendChild(this._audioDummy);p.appendChild(this._history.getManager().getAudioPlaybackRateSelector().render());s.appendChild(p)}this._downloadWrapper=BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-desc"}});s.appendChild(this._downloadWrapper);this._downloadSubject=BX.create("SPAN",{props:{className:"crm-entity-stream-content-detail-zoom-desc-subject"}});this._downloadSubjectDetail=BX.create("SPAN",{props:{className:"crm-entity-stream-content-detail-zoom-desc-detail"}});this._downloadVideoLink=BX.create("A",{props:{className:"crm-entity-stream-content-detail-zoom-desc-link"},text:BX.message("CRM_TIMELINE_ZOOM_DOWNLOAD_VIDEO")});this._downloadSeparator=BX.create("SPAN",{props:{className:"crm-entity-stream-content-detail-zoom-desc-separate"},html:"&mdash;"});this._downloadAudioLink=BX.create("A",{props:{className:"crm-entity-stream-content-detail-zoom-desc-link"},text:BX.message("CRM_TIMELINE_ZOOM_DOWNLOAD_AUDIO")});this.setCurrentRecording(0)}else{this.zoomActivitySubject=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:a})]});s.appendChild(this.zoomActivitySubject);if(n["HAS_RECORDING"]==="Y"){s.appendChild(BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video-inner"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video-img"}}),BX.create("SPAN",{props:{className:"crm-entity-stream-content-detail-zoom-video-text"},text:BX.message("CRM_TIMELINE_ZOOM_MEETING_RECORD_IN_PROCESS")})]})]}))}}}if(s){l.appendChild(s)}var m=this.prepareAuthorLayout();if(m){r.appendChild(m)}return i}},{key:"_onVideoDummyClick",value:function t(){BX.UI.Hint.hide();var e=this._recordings[this._currentRecordingIndex]["VIDEO"];if(!e){return}this._videoPlayer=this._history.getManager().loadMediaPlayer("zoom_video_"+this.getId(),e["DOWNLOAD_URL"],"video/mp4",this._videoDummy,e["LENGTH"],{video:true,skin:"",width:480,height:270})}},{key:"_onAudioDummyClick",value:function t(){var e=this._recordings[this._currentRecordingIndex]["AUDIO"];if(!e){return}this._history.getManager().getAudioPlaybackRateSelector().addPlayer(this._audioPlayer=this._history.getManager().loadMediaPlayer("zoom_audio_"+this.getId(),e["DOWNLOAD_URL"],"audio/mp4",this._audioDummy,e["LENGTH"],{playbackRate:this._history.getManager().getAudioPlaybackRateSelector().getRate()}))}},{key:"_onTabChange",value:function t(e){this.setCurrentRecording(e.data.tabId)}},{key:"setCurrentRecording",value:function t(e){this._currentRecordingIndex=e;var i=this._recordings[this._currentRecordingIndex]["VIDEO"];var s=this._recordings[this._currentRecordingIndex]["AUDIO"];if(i){this._videoDummy.hidden=false;if(this._videoPlayer){this._videoPlayer.pause();this._videoPlayer.setSource(i["DOWNLOAD_URL"]);this._downloadVideoLink.href=i["DOWNLOAD_URL"]}}else{this._videoDummy.hidden=true}if(s){this._audioDummy.hidden=false;if(this._audioPlayer){this._audioPlayer.pause();this._audioPlayer.setSource(s["DOWNLOAD_URL"])}this._downloadAudioLink.href=s["DOWNLOAD_URL"];this._audioLengthElement.innerText=s["LENGTH_FORMATTED"]}else{this._audioDummy.hidden=true}BX.clean(this._downloadWrapper);if(s||i){var n=s?s["LENGTH_HUMAN"]:i["LENGTH_HUMAN"];this._downloadWrapper.appendChild(this._downloadSubject);this._downloadSubject.innerHTML=BX.util.htmlspecialchars(BX.message("CRM_TIMELINE_ZOOM_MEETING_RECORD").replace("#DURATION#",n))+" &mdash; ";this._downloadWrapper.appendChild(this._downloadSubjectDetail)}if(i){this._downloadSubjectDetail.appendChild(this._downloadVideoLink);this._downloadVideoLink.href=i["DOWNLOAD_URL"];if(s){this._downloadSubjectDetail.appendChild(this._downloadSeparator)}if(this._playVideoLink){this._playVideoLink.lastElementChild.href=i["PLAY_URL"];this._downloadVideoLink.href=i["PLAY_URL"]}if(this._detailZoomCopyVideoLink){BX.clipboard.bindCopyClick(this._detailZoomCopyVideoLink,{text:i["PASSWORD"]})}}if(s){this._downloadSubjectDetail.appendChild(this._downloadAudioLink);this._downloadAudioLink.href=s["DOWNLOAD_URL"]}}},{key:"prepareActions",value:function t(){}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);if(!window["zoom"]){window["zoom"]=[]}window["zoom"].push(n);return n}}]);return e}(HistoryActivity);Zoom$1.TabsComponent=function(){function t(e){babelHelpers.classCallCheck(this,t);this.tabs=BX.prop.getArray(e,"tabs",[]);this.elements={container:null,tabs:{}};this.eventEmitter=new BX.Event.EventEmitter(this,"Zoom.TabsComponent")}babelHelpers.createClass(t,[{key:"render",value:function t(){if(this.elements.container){return this.elements.container}this.elements.container=BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section-wrapper"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section-list"},children:this.tabs.map(this._renderTab,this)})]});return this.elements.container}},{key:"_renderTab",value:function t(e){var i=e.id;this.elements.tabs[i]=BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section"+(e.active?" crm-entity-stream-content-detail-zoom-section-active":"")},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section-inner"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section-title"},text:e.title}),BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section-time"},text:e.time})]})],events:{click:function(){this.setActiveTab(e.id)}.bind(this)}});return this.elements.tabs[i]}},{key:"setActiveTab",value:function t(e){if(!this.elements.tabs[e]){throw new Error("Tab "+e+" is not found")}for(var i in this.elements.tabs){if(!this.elements.tabs.hasOwnProperty(i)){continue}i=Number.parseInt(i,10);if(i===e){this.elements.tabs[i].classList.add("crm-entity-stream-content-detail-zoom-section-active")}else{this.elements.tabs[i].classList.remove("crm-entity-stream-content-detail-zoom-section-active")}}this.eventEmitter.emit("onTabChange",{tabId:e})}}]);return t}();var OrderCreation=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"doInitialize",this).call(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"OrderCreation. The field 'activityEditor' is not assigned."}}},{key:"getTitle",value:function t(){var e=this.getMessage(BX.CrmEntityType.resolveName(this.getAssociatedEntityTypeId()).toLowerCase());if(!BX.type.isNotEmptyString(e)){e=this.getTextDataParam("TITLE")}return e}},{key:"getWrapperClassName",value:function t(){return"crm-entity-stream-section-createOrderEntity"}},{key:"getHeaderChildren",value:function t(){var e="";var i="";var s=this.getObjectDataParam("FIELDS");if(BX.prop.get(s,"DONE")==="Y"){e=this.getMessage("done");i="crm-entity-stream-content-event-done"}else if(BX.prop.get(s,"CANCELED")==="Y"){e=this.getMessage("canceled");i="crm-entity-stream-content-event-canceled"}else{if(BX.prop.get(s,"PAID")==="Y"){e=this.getMessage("paid");i="crm-entity-stream-content-event-paid"}else if(BX.prop.get(s,"PAID")==="N"){e=this.getMessage("unpaid");i="crm-entity-stream-content-event-not-paid"}}return[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},events:{click:this._headerClickHandler},text:this.getTitle()}),BX.create("SPAN",{attrs:{className:i},text:e}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})]}},{key:"prepareContentDetails",value:function t(){var e=this.getAssociatedEntityData();var i=this.getAssociatedEntityTypeId();var s=this.getAssociatedEntityId();var n=BX.util.htmlspecialchars(BX.prop.getString(e,"TITLE",""));var a=BX.prop.getString(e,"SHOW_URL","");var r=BX.prop.getString(e,"LEGEND","");if(r!==""){n+=" "+r}var o=[];if(n!==""){if(a===""||i===this.getOwnerTypeId()&&s===this.getOwnerId()){o.push(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},html:n}))}else{o.push(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},html:n}));o.push(BX.create("A",{attrs:{href:a},text:this.getMessage("urlOrderLink")}))}}return o}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-store"}},{key:"prepareContent",value:function t(){var e="crm-entity-stream-section crm-entity-stream-section-history";var i=BX.create("DIV",{attrs:{className:e}});i.appendChild(BX.create("DIV",{attrs:{className:this.getIconClassName()}}));var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:this.getHeaderChildren()});s.appendChild(n);s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:this.prepareContentDetails()}));var a=this.prepareAuthorLayout();if(a){s.appendChild(a)}return i}},{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(History);babelHelpers.defineProperty(OrderCreation,"messages",{});var OrderModification=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"getTitle",value:function t(){return this.getTextDataParam("TITLE")}},{key:"getStatusInfo",value:function t(){var e={};var i=null;var s=null;var n=this.getTextDataParam("CHANGED_ENTITY");var a=this.getObjectDataParam("FIELDS");var r=this.getAssociatedEntityData();if(n===BX.CrmEntityType.names.order){if(BX.prop.get(a,"ORDER_CANCELED")==="Y"){i="canceled";s="not-paid"}else if(BX.prop.get(a,"ORDER_DONE")==="Y"){i="done";s="done"}else if(BX.prop.getString(r,"VIEWED","")==="Y"){i="viewed";s="done"}else if(BX.prop.getString(r,"SENT","")==="Y"){i="sent";s="sent"}}if(n===BX.CrmEntityType.names.orderpayment){var o=BX.prop.get(a,"STATUS_CODE",false);if(o){if(o==="ERROR"){i="orderPaymentError";s="payment-error"}}else if(BX.prop.getString(r,"VIEWED","")==="Y"){i="viewed";s="done"}else if(BX.prop.getString(r,"SENT","")==="Y"){i="sent";s="sent"}else{i=BX.prop.get(a,"ORDER_PAID")==="Y"?"paid":"unpaid";s=BX.prop.get(a,"ORDER_PAID")==="Y"?"paid":"not-paid"}}else if(n===BX.CrmEntityType.names.ordershipment&&BX.prop.get(a,"ORDER_DEDUCTED",false)){i=BX.prop.get(a,"ORDER_DEDUCTED")==="Y"?"deducted":"unshipped";s=BX.prop.get(a,"ORDER_DEDUCTED")==="Y"?"shipped":"not-shipped"}else if(n===BX.CrmEntityType.names.ordershipment&&BX.prop.get(a,"ORDER_ALLOW_DELIVERY",false)){i=BX.prop.get(a,"ORDER_ALLOW_DELIVERY")==="Y"?"allowedDelivery":"disallowedDelivery";s=BX.prop.get(a,"ORDER_ALLOW_DELIVERY")==="Y"?"allowed-delivery":"disallowed-delivery"}if(i){e.className="crm-entity-stream-content-event-"+s;e.message=this.getMessage(i)}return e}},{key:"getHeaderChildren",value:function t(){var e=[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},events:{click:this._headerClickHandler},text:this.getTitle()})];var i=this.getStatusInfo();if(BX.type.isNotEmptyObject(i)){e.push(BX.create("SPAN",{attrs:{className:i.className},text:i.message}))}e.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));return e}},{key:"prepareContentDetails",value:function t(){var e=this.getAssociatedEntityData();var i=this.getAssociatedEntityTypeId();var s=this.getAssociatedEntityId();var n=BX.prop.getString(e,"TITLE");var a=BX.prop.getString(e,"HTML_TITLE","");var r=BX.prop.getString(e,"SHOW_URL","");var o=[];if(n!==""){var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});if(r===""||i===this.getOwnerTypeId()&&s===this.getOwnerId()){l.appendChild(BX.create("SPAN",{text:n+" "+a}))}else{if(a===""){l.appendChild(BX.create("A",{attrs:{href:r},text:n}))}else{l.appendChild(BX.create("SPAN",{text:n+" "}));l.appendChild(BX.create("A",{attrs:{href:r},text:a}))}}var c=BX.prop.getString(e,"LEGEND");if(c!==""){l.appendChild(BX.create("SPAN",{html:" "+c}))}var u=BX.prop.getString(e,"SUBLEGEND","");if(u!==""){l.appendChild(BX.create("BR"));l.appendChild(BX.create("SPAN",{text:" "+u}))}o.push(l)}return o}},{key:"prepareViewedContentDetails",value:function t(){var e=this.getAssociatedEntityData();var i=this.getAssociatedEntityTypeId();var s=this.getAssociatedEntityId();var n=BX.prop.getString(e,"TITLE");var a=BX.prop.getString(e,"SHOW_URL","");var r=[];if(n!==""){var o=BX.prop.getString(e,"SUBLEGEND","");if(o!==""){var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:o});r.push(l)}if(i===this.getOwnerTypeId()&&s===this.getOwnerId()){r.push(BX.create("SPAN",{text:n}))}else{r.push(BX.create("A",{attrs:{href:a},text:n}))}var c=BX.prop.getString(e,"LEGEND");if(c!==""){r.push(BX.create("SPAN",{html:" "+c}))}}return r}},{key:"prepareSentContentDetails",value:function t(){var e=this.getAssociatedEntityData();var i=this.getAssociatedEntityTypeId();var s=this.getAssociatedEntityId();var n=BX.prop.getString(e,"TITLE");var a=BX.prop.getString(e,"SHOW_URL","");var r=BX.prop.getString(e,"DESTINATION_TITLE","");var o=[];if(n!==""){var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});if(a===""||i===this.getOwnerTypeId()&&s===this.getOwnerId()){l.appendChild(BX.create("SPAN",{text:n}))}else{l.appendChild(BX.create("A",{attrs:{href:a},text:n}))}var c=BX.prop.getString(e,"LEGEND");if(c!==""){l.appendChild(BX.create("SPAN",{html:" "+c}))}if(r){l.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-order-destination"},text:r}))}o.push(l);var u=BX.create("A",{attrs:{href:"#"},text:this.getMessage("orderPaymentProcess"),events:{click:BX.proxy(this.startSalescenterApplication,this)}});o.push(u)}return o}},{key:"startSalescenterApplication",value:function t(){BX.loadExt("salescenter.manager").then(function(){var t=this.getObjectDataParam("FIELDS"),e=BX.prop.get(t,"OWNER_TYPE_ID",BX.CrmEntityType.enumeration.deal);var i=BX.prop.get(t,"OWNER_ID",0);var s=BX.prop.get(t,"PAYMENT_ID",0),n=BX.prop.get(t,"SHIPMENT_ID",0),a=BX.prop.get(t,"ORDER_ID",0);if(!i){i=BX.prop.get(t,"DEAL_ID",0)}BX.Salescenter.Manager.openApplication({disableSendButton:"",context:"deal",ownerTypeId:e,ownerId:i,mode:e===BX.CrmEntityType.enumeration.deal?"payment_delivery":"payment",templateMode:"view",orderId:a,paymentId:s,shipmentId:n})}.bind(this))}},{key:"preparePaidPaymentContentDetails",value:function t(){var e=this.getAssociatedEntityData(),i=BX.prop.getString(e,"TITLE"),s=BX.prop.getString(e,"DATE",""),n=BX.prop.getString(e,"PAY_SYSTEM_NAME",""),a=BX.prop.getString(e,"SUM",""),r=BX.prop.getString(e,"CURRENCY",""),o=[];if(i!==""){var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-payment"}});l.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-payment-value"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-payment-text"},html:a}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-payment-currency"},html:r})]}));var c=BX.prop.getString(e,"LOGOTIP",null);if(c){l.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-payment-logo"},style:{backgroundImage:"url("+encodeURI(c)+")"}}))}o.push(l);var u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:[BX.create("SPAN",{text:s}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-description-info"},text:this.getMessage("orderPaySystemTitle")}),BX.create("SPAN",{text:n})]});o.push(u)}return o}},{key:"prepareContent",value:function t(){var e=this.getObjectDataParam("FIELDS"),i=BX.prop.get(e,"ORDER_PAID")==="Y",s=BX.prop.get(e,"PAY_SYSTEM_CLICK")==="Y",n=BX.prop.get(e,"MANUAL_CONTINUE_PAY")==="Y",a=BX.prop.get(e,"NEED_MANUAL_ADD_CHECK")==="Y",r=this.getAssociatedEntityTypeId();if(r===BX.CrmEntityType.enumeration.orderpayment&&i){return this.preparePaidPaymentContent()}else if(r===BX.CrmEntityType.enumeration.orderpayment&&s){return this.prepareClickedPaymentContent()}else if(r===BX.CrmEntityType.enumeration.order&&n){return this.prepareManualContinuePayContent()}else if(r===BX.CrmEntityType.enumeration.orderpayment&&a){return this.prepareManualAddCheck()}return this.prepareItemOrderContent()}},{key:"prepareItemOrderContent",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"VIEWED","")==="Y";var s=BX.prop.getString(e,"SENT","")==="Y";var n=this.getObjectDataParam("FIELDS");var a=BX.prop.get(n,"STATUS_CODE",false);var r=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history"}});r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon "+this.getIconClassName()}}));var o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:this.getHeaderChildren()});var c=null;if(i){c=this.prepareViewedContentDetails()}else if(s){c=this.prepareSentContentDetails()}else if(a==="ERROR"){c=this.prepareErrorPaymentContentDetails()}else{c=this.prepareContentDetails()}o.appendChild(l);o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:c}));var u=this.prepareAuthorLayout();if(u){o.appendChild(u)}r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[o]}));return r}},{key:"preparePaidPaymentContent",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-section"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-wallet"}}));var i=[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getMessage("orderPaymentSuccessTitle")})]})];i.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:i});var a=this.preparePaidPaymentContentDetails();s.appendChild(n);s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:a}));var r=this.prepareAuthorLayout();if(r){s.appendChild(r)}e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));return e}},{key:"prepareErrorPaymentContentDetails",value:function t(){var e=this.getAssociatedEntityData(),i=BX.prop.getString(e,"DATE",""),s=this.getObjectDataParam("FIELDS"),n=BX.prop.getString(s,"PAY_SYSTEM_NAME",""),a=BX.prop.getString(s,"STATUS_DESCRIPTION",""),r=[];var o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:[BX.create("SPAN",{text:i}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-description-info"},text:this.getMessage("orderPaySystemTitle")}),BX.create("SPAN",{text:n})]});r.push(o);var l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-payment-initiate-pay-error"},text:this.getMessage("orderPaymentStatusErrorReason").replace("#PAYSYSTEM_ERROR#",a)});r.push(l);return r}},{key:"prepareClickedPaymentContent",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon "+this.getIconClassName()}}));var i=[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]})];i.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:i});var a=this.prepareClickedPaymentContentDetails();s.appendChild(n);s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:a}));var r=this.prepareAuthorLayout();if(r){s.appendChild(r)}e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));return e}},{key:"prepareClickedPaymentContentDetails",value:function t(){var e=this.getObjectDataParam("FIELDS"),i=BX.prop.getString(e,"PAY_SYSTEM_NAME",""),s=[];if(i!==""){var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});n.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-clicked-description-info"},text:this.getMessage("orderPaymentPaySystemClick")}));n.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-clicked-description-name"},text:i}));s.push(n)}return s}},{key:"prepareManualContinuePayContent",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-advice"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-advice"}}));var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-advice-info"},text:this.getMessage("orderManualContinuePay")});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-advice-content"},children:[i]}));return e}},{key:"prepareManualAddCheck",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"SHOW_URL","");var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-advice"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-advice"}}));var n=this.getMessage("orderManualAddCheck").replace("#HREF#",i);var a=BX.create("DIV",{attrs:{className:"crm-entity-stream-advice-info"},html:n});var r=BX.create("DIV",{attrs:{className:"crm-entity-stream-advice-info"},children:[BX.create("A",{attrs:{className:"crm-entity-stream-content-detail-target",href:"#"},events:{click:BX.delegate((function(t){top.BX.Helper.show("redirect=detail&code=13742126");t.preventDefault?t.preventDefault():t.returnValue=false}))},html:this.getMessage("orderManualAddCheckHelpLink")})]});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-advice-content"},children:[a,r]}));return s}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon-store"}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(History);babelHelpers.defineProperty(OrderModification,"messages",{});var StoreDocumentCreation=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"doInitialize",this).call(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"StoreDocumentCreation. The field 'activityEditor' is not assigned."}}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}},{key:"getTitle",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"DOC_TYPE");if(i==="A"){return this.getMessage("arrivalDocument")}if(i==="S"){return this.getMessage("storeAdjustmentDocument")}if(i==="M"){return this.getMessage("movingDocument")}if(i==="D"){return this.getMessage("deductDocument")}if(i==="W"){return this.getMessage("shipmentDocument")}return""}},{key:"getWrapperClassName",value:function t(){return"crm-entity-stream-section-createStoreDocumentEntity"}},{key:"prepareContentDetails",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"TITLE","");var s=[];if(i===""){return s}var n=BX.create("span",{text:i});var a=BX.prop.getString(this._data,"TITLE_TEMPLATE","");if(a){var r=BX.prop.getString(e,"DOC_TYPE");if(r==="W"){if(this.getOwnerTypeId()===BX.CrmEntityType.enumeration.deal){var o=BX.prop.getString(this._data,"DETAIL_LINK","");var l='<a href="'+o+'">'+i+"</a>";n.innerHTML=a.replace("#TITLE#",l)}else{n.innerHTML=a.replace("#TITLE#",i)}}else{n.innerHTML=a.replace("#TITLE#",i)}}s.push(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:[n]}));return s}},{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(OrderCreation);babelHelpers.defineProperty(StoreDocumentCreation,"messages",{});var StoreDocumentModification=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"doInitialize",this).call(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"StoreDocumentModification. The field 'activityEditor' is not assigned."}}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}},{key:"getTitle",value:function t(){var e=this.getTextDataParam("ERROR");if(e==="CONDUCT"){return this.getMessage("conductError")}var i=this.getAssociatedEntityData();var s=this.getTextDataParam("FIELD");var n=BX.prop.getString(i,"DOC_TYPE");if(n==="A"){if(s==="STATUS"){return this.getMessage("arrivalDocument")}else{return this.getMessage("arrivalModification")}}if(n==="S"){if(s==="STATUS"){return this.getMessage("storeAdjustmentDocument")}else{return this.getMessage("storeAdjustmentModification")}}if(n==="M"){if(s==="STATUS"){return this.getMessage("movingDocument")}else{return this.getMessage("movingModification")}}if(n==="D"){if(s==="STATUS"){return this.getMessage("deductDocument")}else{return this.getMessage("deductModification")}}if(n==="W"){if(s==="STATUS"){return this.getMessage("shipmentDocument")}else{return this.getMessage("shipmentModification")}}return""}},{key:"getStatusInfo",value:function t(){var e={};var i=this.getTextDataParam("STATUS_TITLE");var s=this.getTextDataParam("STATUS_CLASS");{e.message=i;e.className="crm-entity-stream-content-event-"+s}return e}},{key:"getHeaderChildren",value:function t(){var e=[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},events:{click:this._headerClickHandler},text:this.getTitle()})];var i=this.getStatusInfo();if(BX.type.isNotEmptyObject(i)){e.push(BX.create("SPAN",{attrs:{className:i.className},text:i.message}))}e.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));return e}},{key:"prepareContent",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}));var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:this.getHeaderChildren()});var n=this.getAssociatedEntityData();var a=BX.prop.getString(n,"TITLE","");var r=this.getTextDataParam("ERROR");var o=[];if(r){var l=this.getTextDataParam("ERROR_MESSAGE");o.push(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:l}))}else if(a!==""){var c=BX.create("span",{text:a});var u=BX.prop.getString(this._data,"TITLE_TEMPLATE","");if(u){var h=BX.prop.getString(n,"DOC_TYPE");if(h==="W"){if(this.getOwnerTypeId()===BX.CrmEntityType.enumeration.deal){var d=BX.prop.getString(this._data,"DETAIL_LINK","");var p='<a href="'+d+'">'+a+"</a>";c.innerHTML=u.replace("#TITLE#",p)}else{c.innerHTML=u.replace("#TITLE#",a)}}else{c.innerHTML=u.replace("#TITLE#",a)}}o.push(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:[c]}))}i.appendChild(s);i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-info"},children:o})]}));var m=this.prepareAuthorLayout();if(m){i.appendChild(m)}e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));return e}},{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Modification);babelHelpers.defineProperty(StoreDocumentModification,"messages",{});var ExternalNoticeModification=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon-restApp"}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(OrderModification);var ExternalNoticeStatusModification=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"prepareContentDetails",value:function t(){var e=[];var i=[];if(BX.type.isNotEmptyString(this.getTextDataParam("START_NAME"))){i.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detain-info-status"},text:this.getTextDataParam("START_NAME")}));i.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-info-separator-icon"}}))}if(BX.type.isNotEmptyString(this.getTextDataParam("FINISH_NAME"))){i.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detain-info-status"},text:this.getTextDataParam("FINISH_NAME")}))}e.push(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-info"},children:i}));return e}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(ExternalNoticeModification);var OrderCheck=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"doInitialize",this).call(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"OrderCheck. The field 'activityEditor' is not assigned."}}},{key:"getTitle",value:function t(){var e=this.getMessage("orderCheck");var i=this.getTextDataParam("CHECK_NAME");if(i!==""){e+=' "'+i+'"'}return e}},{key:"getWrapperClassName",value:function t(){return"crm-entity-stream-section-createOrderEntity"}},{key:"getHeaderChildren",value:function t(){var e="";var i="";var s=this.getTitle();if(this.getTextDataParam("SENDED")!==""){s=this.getMessage("sendedTitle")}else{e=this.getMessage("printed");i="crm-entity-stream-content-event-successful";if(this.getTextDataParam("PRINTED")!=="Y"){e=this.getMessage("unprinted");i="crm-entity-stream-content-event-missing"}}return[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:s})]}),BX.create("SPAN",{attrs:{className:i},text:e}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})]}},{key:"prepareContentDetails",value:function t(){var e=this.getAssociatedEntityData();var i=this.getTextDataParam("TITLE");var s=BX.prop.getString(e,"SHOW_URL","");var n=[];if(i!==""){var a=this.getTextDataParam("SENDED")!=="";var r=a?"crm-entity-stream-content-detail-order":"crm-entity-stream-content-detail-description";var o=BX.create("DIV",{attrs:{className:r}});if(s!==""){o.appendChild(BX.create("A",{attrs:{href:s},events:{click:BX.delegate((function(t){BX.Crm.Page.openSlider(s,{width:500});t.preventDefault?t.preventDefault():t.returnValue=false}),this)},text:i}))}var l=this.getTextDataParam("LEGEND");var c;if(l!==""){c=BX.create("SPAN",{html:" "+l})}if(a){n.push(o);if(c){n.push(c)}}else{if(c){o.appendChild(c)}n.push(o)}}var u=this.getTextDataParam("CHECK_URL");if(u){n.push(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-payment-info"},children:[BX.create("A",{attrs:{href:u,target:"_blank"},text:this.getMessage("urlLink")})]}))}return n}},{key:"prepareContent",value:function t(){var e="crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-createOrderEntity";var i=BX.create("DIV",{attrs:{className:e}});i.appendChild(BX.create("DIV",{attrs:{className:this.getIconClassName()}}));var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:this.getHeaderChildren()});s.appendChild(n);s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:this.prepareContentDetails()}));var a=this.prepareAuthorLayout();if(a){s.appendChild(a)}return i}},{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(History);babelHelpers.defineProperty(OrderCheck,"messages",{});var FinalSummaryDocuments=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"getTitle",value:function t(){return this.getMessage("title")}},{key:"getHeaderChildren",value:function t(){var e=[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]})];e.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));return e}},{key:"createCheckBlock",value:function t(e){var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-notice"}});i.appendChild(BX.create("a",{attrs:{href:e.URL,target:"_blank"},text:e.TITLE}));return i}},{key:"prepareContent",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-payment"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon "+this.getIconClassName()}}));var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}});var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:this.getHeaderChildren()});s.appendChild(n);var a=this.getData();if(a.RESULT){var r={OWNER_ID:a.ASSOCIATED_ENTITY_ID,OWNER_TYPE_ID:a.ASSOCIATED_ENTITY_TYPE_ID,PARENT_CONTEXT:this,CONTEXT:BX.CrmEntityType.resolveName(a.ASSOCIATED_ENTITY_TYPE_ID).toLowerCase(),IS_WITH_ORDERS_MODE:false};var o=new BX.Crm.TimelineSummaryDocuments(r);var l=a.RESULT.TIMELINE_SUMMARY_OPTIONS;o.setOptions(l);var c=[o.render()];s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:c}));i.appendChild(s)}var u=this.prepareAuthorLayout();if(u){i.appendChild(u)}e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));return e}},{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon-complete"}},{key:"startSalescenterApplication",value:function t(e,i){if(i===undefined){return}BX.loadExt("salescenter.manager").then(function(){BX.Salescenter.Manager.openApplication(i)}.bind(this))}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(History);babelHelpers.defineProperty(FinalSummaryDocuments,"messages",{});var FinalSummary=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"prepareContent",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-payment"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon "+this.getIconClassName()}}));var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}});var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:this.getHeaderChildren()});s.appendChild(n);var a=this.getData();if(a.RESULT){var r={OWNER_ID:a.ASSOCIATED_ENTITY_ID,OWNER_TYPE_ID:a.ASSOCIATED_ENTITY_TYPE_ID,PARENT_CONTEXT:this,CONTEXT:BX.CrmEntityType.resolveName(a.ASSOCIATED_ENTITY_TYPE_ID).toLowerCase(),IS_WITH_ORDERS_MODE:true};var o=new BX.Crm.TimelineSummaryDocuments(r);var l=a.RESULT.TIMELINE_SUMMARY_OPTIONS;o.setOptions(l);var c=[o.render()];s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:c}));i.appendChild(s)}var u=this.prepareAuthorLayout();if(u){i.appendChild(u)}e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));return e}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(FinalSummaryDocuments);var Creation=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"doInitialize",this).call(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"Creation. The field 'activityEditor' is not assigned."}}},{key:"getTitle",value:function t(){var e=this.getAssociatedEntityTypeId();var i=this.getAssociatedEntityData();if(e===BX.CrmEntityType.enumeration.activity){var s=BX.prop.getInteger(i,"TYPE_ID");var n=this.getMessage(s===BX.CrmActivityType.task?"task":"activity");return n.replace(/#TITLE#/gi,this.cutOffText(BX.prop.getString(i,"SUBJECT")),64)}if(e===BX.CrmEntityType.enumeration.storeDocument){var a=BX.prop.getString(i,"DOC_TYPE");if(a==="A"){return this.getMessage("arrivalDocument")}if(a==="S"){return this.getMessage("storeAdjustmentDocument")}if(a==="M"){return this.getMessage("movingDocument")}if(a==="D"){return this.getMessage("deductDocument")}if(a==="W"){return this.getMessage("shipmentDocument")}return""}var r=BX.CrmEntityType.resolveName(this.getAssociatedEntityTypeId()).toLowerCase();var o=this.getMessage(r);var l=o===r;if(!BX.type.isNotEmptyString(o)||l){o=this.getTextDataParam("TITLE")}return o}},{key:"getWrapperClassName",value:function t(){return"crm-entity-stream-section-createEntity"}},{key:"prepareContent",value:function t(){var i=this.getAssociatedEntityTypeId();if(i===BX.CrmEntityType.enumeration.ordershipment||i===BX.CrmEntityType.enumeration.orderpayment){var s=this.getData();s.TYPE_CATEGORY_ID=Item.modification;if(s.hasOwnProperty("ASSOCIATED_ENTITY")){s.ASSOCIATED_ENTITY.HTML_TITLE=""}var n=this._history.createOrderEntityItem(s);return n.prepareContent()}return babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"prepareContent",this).call(this)}},{key:"prepareContentDetails",value:function t(){var e=this.getAssociatedEntityTypeId();var i=this.getAssociatedEntityId();var s=this.getAssociatedEntityData();if(e===BX.CrmEntityType.enumeration.activity){var n=BX.create("A",{attrs:{href:"#"},html:this.cutOffText(BX.prop.getString(s,"DESCRIPTION_RAW"),128)});BX.bind(n,"click",this._headerClickHandler);return[n]}var a=BX.prop.getString(s,"TITLE","");var r=BX.prop.getString(s,"HTML_TITLE","");var o=BX.prop.getString(s,"SHOW_URL","");if(e===BX.CrmEntityType.enumeration.deal&&BX.prop.getObject(s,"ORDER",null)){var l=BX.prop.getObject(s,"ORDER",null);r=this.getMessage("dealOrderTitle").replace("#ORDER_ID#",l.ID).replace("#DATE_TIME#",l.ORDER_DATE).replace("#HREF#",l.SHOW_URL).replace("#PRICE_WITH_CURRENCY#",l.SUM)}if(a!==""||r!==""){var c=[];if(o===""||e===this.getOwnerTypeId()&&i===this.getOwnerId()){var u=r!==""?{html:r}:{text:a};c.push(BX.create("SPAN",u))}else{var h={attrs:{href:o},text:a};if(r!==""){h={attrs:{href:o},html:r}}c.push(BX.create("A",h))}var d=this.getTextDataParam("LEGEND");if(d!==""){c.push(BX.create("BR"));c.push(BX.create("SPAN",{text:d}))}var p=this.getObjectDataParam("BASE");var m=BX.prop.getObject(p,"ENTITY_INFO");if(m){c.push(BX.create("BR"));c.push(BX.create("SPAN",{text:BX.prop.getString(p,"CAPTION")+": "}));c.push(BX.create("A",{attrs:{href:BX.prop.getString(m,"SHOW_URL","#")},text:BX.prop.getString(m,"TITLE","")}))}return c}return[]}},{key:"view",value:function t(){var e=this.getAssociatedEntityTypeId();if(e===BX.CrmEntityType.enumeration.activity){var i=this.getAssociatedEntityData();var s=BX.prop.getInteger(i,"ID",0);if(s>0){this._activityEditor.viewActivity(s)}}}},{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(History);babelHelpers.defineProperty(Creation,"messages",{});var Restoration=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getTitle",value:function t(){return this.getTextDataParam("TITLE")}},{key:"getWrapperClassName",value:function t(){return"crm-entity-stream-section-restoreEntity"}},{key:"prepareContentDetails",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"TITLE");return i!==""?[BX.create("SPAN",{text:i})]:[]}},{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(History);babelHelpers.defineProperty(Restoration,"messages",{});var Relation=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getTitle",value:function t(){return this.getMessage("title")}},{key:"getWrapperClassName",value:function t(){return"crm-entity-stream-section-createEntity"}},{key:"prepareContentDetails",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"SHOW_URL","");if(i.indexOf("/")!==0){i="#"}var s=this.getMessage("contentTemplate").replace("#ENTITY_TYPE_CAPTION#",BX.Text.encode(BX.prop.getString(e,"ENTITY_TYPE_CAPTION",""))).replace("#LEGEND#","").replace("#LINK#",BX.Text.encode(i)).replace("#LINK_TITLE#",BX.Text.encode(BX.prop.getString(e,"TITLE","")));var n=[];n.push(BX.create("SPAN",{html:s}));return n}}]);return e}(History);var Link=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-link"}},{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Relation);babelHelpers.defineProperty(Link,"messages",{});var Unlink=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getIconClassName",value:function t(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-unlink"}},{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Relation);babelHelpers.defineProperty(Unlink,"messages",{});var Mark$1=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"doInitialize",this).call(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"Mark. The field 'activityEditor' is not assigned."}}},{key:"getMessage",value:function t(i){var s=e.messages;if(s.hasOwnProperty(i)){return s[i]}return babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"getMessage",this).call(this,i)}},{key:"getTitle",value:function t(){var e="";var i=this.getAssociatedEntityData();var s=this.getAssociatedEntityTypeId();var n=this.getTypeCategoryId();if(s===BX.CrmEntityType.enumeration.activity){var a=BX.prop.getInteger(i,"TYPE_ID",0);var r=BX.prop.getInteger(i,"DIRECTION",0);var o=BX.prop.getString(i,"PROVIDER_ID","");if(a===BX.CrmActivityType.email){if(n===Mark.success){e=this.getMessage((r===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")+"SuccessMark")}else if(n===Mark.renew){e=this.getMessage((r===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")+"RenewMark")}}else if(a===BX.CrmActivityType.call){if(n===Mark.success){e=this.getMessage((r===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")+"SuccessMark")}else if(n===Mark.renew){e=this.getMessage((r===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")+"RenewMark")}}else if(a===BX.CrmActivityType.meeting){if(n===Mark.success){e=this.getMessage("meetingSuccessMark")}else if(n===Mark.renew){e=this.getMessage("meetingRenewMark")}}else if(a===BX.CrmActivityType.task){if(n===Mark.success){e=this.getMessage("taskSuccessMark")}else if(n===Mark.renew){e=this.getMessage("taskRenewMark")}}else if(a===BX.CrmActivityType.provider){if(o==="CRM_REQUEST"){if(n===Mark.success){e=this.getMessage("requestSuccessMark")}else if(n===Mark.renew){e=this.getMessage("requestRenewMark")}}else if(n===Mark.success){e=this.getMessage("webformSuccessMark")}else if(n===Mark.renew){e=this.getMessage("webformRenewMark")}}}else if(s===BX.CrmEntityType.enumeration.deal){if(n===Mark.success){e=this.getMessage("dealSuccessMark")}else if(n===Mark.failed){e=this.getMessage("dealFailedMark")}}else if(s===BX.CrmEntityType.enumeration.order){if(n===Mark.success){e=this.getMessage("orderSuccessMark")}else if(n===Mark.failed){e=this.getMessage("orderFailedMark")}}else{if(BX.CrmEntityType.isDefined(s)){if(n===Mark.success){e=this.getMessage("entitySuccessMark")}else if(n===Mark.failed){e=this.getMessage("entityFailedMark")}}}return e}},{key:"prepareTitleLayout",value:function t(){var e=this.getAssociatedEntityTypeId();if(e===BX.CrmEntityType.enumeration.order){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getTitle()})}else{return BX.create("A",{attrs:{href:"#",className:"crm-entity-stream-content-event-title"},events:{click:this._headerClickHandler},text:this.getTitle()})}}},{key:"prepareContent",value:function t(){var e=this.getAssociatedEntityData();var i=this.getAssociatedEntityTypeId();var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-completed"}});if(this.isFixed())BX.addClass(s,"crm-entity-stream-section-top-fixed");if(this.isContextMenuEnabled()){s.appendChild(this.prepareContextMenuButton())}var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var a=this.prepareHeaderLayout();if(i===BX.CrmEntityType.enumeration.activity){var r=BX.prop.getInteger(e,"TYPE_ID",0);var o="crm-entity-stream-section-icon";if(r===BX.CrmActivityType.email){o+=" crm-entity-stream-section-icon-email"}else if(r===BX.CrmActivityType.call){o+=" crm-entity-stream-section-icon-call"}else if(r===BX.CrmActivityType.meeting){o+=" crm-entity-stream-section-icon-meeting"}else if(r===BX.CrmActivityType.task){o+=" crm-entity-stream-section-icon-task"}else if(r===BX.CrmActivityType.provider){var l=BX.prop.getString(e,"PROVIDER_ID","");if(l==="CRM_WEBFORM"){o+=" crm-entity-stream-section-icon-crmForm"}}s.appendChild(BX.create("DIV",{attrs:{className:o}}));n.appendChild(a);var c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});n.appendChild(c);c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.cutOffText(BX.prop.getString(e,"SUBJECT",""),128)})]}));var u=this.getTextDataParam("SUMMARY");if(u!==""){c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:u}))}}else if(i===BX.CrmEntityType.enumeration.order){s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}));n.appendChild(a);n.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},text:this.cutOffText(this.getTextDataParam("MESSAGE"),128)}))}else{s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}));n.appendChild(a);var h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});var d=this.cutOffText(BX.prop.getString(e,"TITLE",""),128);if(BX.CrmEntityType.isDefined(i)){var p=BX.prop.getString(e,"SHOW_URL","");if(p.indexOf("/")!==0){p="#"}var m=this.getMessage("entityContentTemplate").replace("#ENTITY_TYPE_CAPTION#",BX.Text.encode(BX.prop.getString(e,"ENTITY_TYPE_CAPTION",""))).replace("#LINK#",BX.Text.encode(p)).replace("#LINK_TITLE#",BX.Text.encode(d));h.appendChild(BX.create("SPAN",{html:m}))}else{h.innerText=d}n.appendChild(h)}var y=this.prepareAuthorLayout();if(y){n.appendChild(y)}s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[n]}));if(!this.isReadOnly())s.appendChild(this.prepareFixedSwitcherLayout());return s}},{key:"prepareContextMenuItems",value:function t(){var e=[];if(!this.isReadOnly()){if(this.isFixed()||this._fixedHistory.findItemById(this._id))e.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)});else e.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}return e}},{key:"view",value:function t(){var e=this.getAssociatedEntityData();var i=this.getAssociatedEntityTypeId();if(i===BX.CrmEntityType.enumeration.activity){var s=BX.prop.getInteger(e,"ID",0);if(s>0){this._activityEditor.viewActivity(s)}}else{var n=BX.prop.getString(e,"SHOW_URL","");if(n!==""){BX.Crm.Page.open(n)}}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(History);babelHelpers.defineProperty(Mark$1,"messages",{});var Comment$1=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._isCollapsed=false;t._isMenuShown=false;t._isFixed=false;t._hasFiles=false;t._postForm=null;t._editor=null;t._commentMessage="";t._mode=EditorMode.view;t._streamContentEventBlock="";t._playerWrappers={};BX.Event.EventEmitter.subscribe("BX.Disk.Files:onShowFiles",BX.delegate(t.addPlayer,babelHelpers.assertThisInitialized(t)));return t}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){babelHelpers.get(babelHelpers.getPrototypeOf(e.prototype),"doInitialize",this).call(this);this._hasFiles=this.getTextDataParam("HAS_FILES")==="Y"}},{key:"getTitle",value:function t(){return this.getMessage("comment")}},{key:"onPlayerDummyClick",value:function t(e){var i=this._playerWrappers[e.id];var s=i.querySelector(".crm-audio-cap-wrap");if(s){BX.addClass(s,"crm-audio-cap-wrap-loader")}this._history.getManager().getAudioPlaybackRateSelector().addPlayer(this._history.getManager().loadMediaPlayer("history_"+this.getId()+"_"+e.id,e.url,"audio/mp3",i,null,{playbackRate:this._history.getManager().getAudioPlaybackRateSelector().getRate()}))}},{key:"addPlayer",value:function t(e){if(e.data.entityValueId===parseInt(this.getId(),10)){this.files=e.data.files;e.data.files.forEach(function(t){if(t.extension==="mp3"){if(this._playerWrappers[t.id]){return}var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-call crm-entity-stream-content-detail-call-inline"}});this._streamContentEventBlock.appendChild(e);this._playerWrappers[t.id]=this._history.getManager().renderAudioDummy(null,this.onPlayerDummyClick.bind(this,t));this._playerWrappers[t.id].firstElementChild.classList.add("crm-audio-cap-wrap-without-duration-text");e.appendChild(this._playerWrappers[t.id]);e.appendChild(this._history.getManager().getAudioPlaybackRateSelector().render())}}.bind(this))}}},{key:"prepareContent",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-comment"}});if(this.isReadOnly()){BX.addClass(e,"crm-entity-stream-section-comment-read-only")}if(this.isFixed())BX.addClass(e,"crm-entity-stream-section-top-fixed");e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-comment"}}));if(this.isContextMenuEnabled()){e.appendChild(this.prepareContextMenuButton())}this._streamContentEventBlock=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var i=this.prepareHeaderLayout();this._streamContentEventBlock.appendChild(i);if(!this.isReadOnly())e.appendChild(this.prepareFixedSwitcherLayout());var s=[];if(this._mode!==EditorMode.edit){this._commentWrapper=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});BX.html(this._commentWrapper,this.getTextDataParam("COMMENT",""));s.push(this._commentWrapper);if(!this.isReadOnly()){BX.bind(this._commentWrapper,"click",BX.delegate(this.switchToEditMode,this));BX.bind(i,"click",BX.delegate(this.switchToEditMode,this))}}else{if(!BX.type.isDomNode(this._editorContainer))this._editorContainer=BX.create("div",{attrs:{className:"crm-entity-stream-section-comment-editor"}});s.push(this._editorContainer);var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-comment-edit-btn-container"},children:[BX.create("button",{attrs:{className:"ui-btn ui-btn-xs ui-btn-primary"},html:this.getMessage("send"),events:{click:BX.delegate(this.save,this)}}),BX.create("a",{attrs:{className:"ui-btn ui-btn-xs ui-btn-link"},html:this.getMessage("cancel"),events:{click:BX.delegate(this.switchToViewMode,this)}})]});s.push(n)}this._streamContentEventBlock.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:s}));var a=this.prepareAuthorLayout();if(a){this._streamContentEventBlock.appendChild(a)}var r=this.getTextDataParam("TEXT","");var o=this.getTextDataParam("HAS_INLINE_ATTACHMENT","")==="Y";if(r.length<=128&&!o||this._mode===EditorMode.edit){this._isCollapsed=false;e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[this._streamContentEventBlock]}))}else{this._isCollapsed=true;e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content crm-entity-stream-section-content-collapsed"},children:[this._streamContentEventBlock]}));e.querySelector(".crm-entity-stream-content-event").appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content-expand-btn-container"},children:[BX.create("A",{attrs:{className:"crm-entity-stream-section-content-expand-btn",href:"#"},events:{click:BX.delegate(this.onExpandButtonClick,this)},text:this.getMessage("expand")})]}))}if(this._mode===EditorMode.view&&this._hasFiles){this._textLoaded=false;this._fileBlock=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-files-inner"},children:[BX.create("DIV",{attrs:{className:"crm-timeline-wait"}})]});e.querySelector(".crm-entity-stream-section-content").appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-files"},children:[this._fileBlock]}));BX.ready(BX.delegate((function(){window.setTimeout(BX.delegate((function(){this.loadContent(this._fileBlock,"GET_FILE_BLOCK")}),this),100)}),this))}return e}},{key:"prepareActions",value:function t(){if(this._mode===EditorMode.view&&BX.type.isDomNode(this._commentWrapper)){this.registerImages(this._commentWrapper);if(!BX.getClass("BX.Disk.apiVersion")){BX.viewElementBind(this._commentWrapper,{showTitle:true},(function(t){return BX.type.isElementNode(t)&&(t.getAttribute("data-bx-viewer")||t.getAttribute("data-bx-image"))}))}}}},{key:"loadContent",value:function t(e,i){if(!BX.type.isDomNode(e))return;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"GET_COMMENT_CONTENT",ID:this.getId(),ENTITY_TYPE_ID:this.getOwnerTypeId(),ENTITY_ID:this.getOwnerId(),TYPE:i},onsuccess:BX.delegate((function(t){if(BX.type.isNotEmptyString(t.ERROR)&&i==="GET_FILE_BLOCK"){BX.remove(e);return}if(BX.type.isNotEmptyString(t.BLOCK)){var s=BX.html(e,t.BLOCK);s.then(BX.delegate((function(){this.registerImages(e);BX.LazyLoad.showImages()}),this))}}),this)})}},{key:"loadEditor",value:function t(){this._editorName="CrmTimeLineComment"+this._id+BX.util.getRandomString(4);if(this._postForm){this._postForm.oEditor.SetContent(this._commentMessage);this._editor.ReInitIframe();return}var e={data:{id:this._id,name:this._editorName}};BX.ajax.runAction("crm.api.timeline.loadEditor",e).then(this.onLoadEditorSuccess.bind(this))["catch"](this.switchToViewMode.bind(this))}},{key:"onLoadEditorSuccess",value:function t(e){if(!BX.type.isDomNode(this._editorContainer))this._editorContainer=BX.create("div",{attrs:{className:"crm-entity-stream-section-comment-editor"}});var i=BX.prop.getString(BX.prop.getObject(e,"data",{}),"html","");BX.html(this._editorContainer,i).then(BX.delegate(this.showEditor,this))}},{key:"showEditor",value:function t(){if(LHEPostForm){window.setTimeout(BX.delegate((function(){this._postForm=LHEPostForm.getHandler(this._editorName);this._editor=BXHtmlEditor.Get(this._editorName);BX.onCustomEvent(this._postForm.eventNode,"OnShowLHE",[true]);this._commentMessage=this._postForm.oEditor.GetContent()}),this),0)}}},{key:"onFinishFasten",value:function t(){this.registerImages(this._commentWrapper);if(BX.type.isDomNode(this._fileBlock))this.registerImages(this._fileBlock);BX.LazyLoad.showImages()}},{key:"registerImages",value:function t(e){var i=e.querySelectorAll('[data-bx-viewer="image"]');var s=i.length;var n=[];if(s>0){for(var a=0;a<s;++a){if(BX.type.isDomNode(i[a])){i[a].id+=BX.util.getRandomString(4);n.push(i[a].id)}}if(n.length>0){BX.LazyLoad.registerImages(n)}}BX.LazyLoad.registerImages(n)}},{key:"toggleMode",value:function t(e){this._mode=parseInt(e);this._hasFiles=this.getTextDataParam("HAS_FILES")==="Y";this.refreshLayout();this.closeContextMenu()}},{key:"switchToViewMode",value:function t(e){this.toggleMode(EditorMode.view)}},{key:"switchToEditMode",value:function t(e){var i=e.target.tagName.toLowerCase();if(i==="a"||i==="img"||BX.hasClass(e.target,"feed-con-file-changes-link-more")||BX.hasClass(e.target,"feed-com-file-inline")||BX.type.isNotEmptyString(document.getSelection().toString())){return}this.toggleMode(EditorMode.edit);window.setTimeout(BX.delegate((function(){this.loadEditor()}),this),100)}},{key:"prepareContextMenuItems",value:function t(){if(this._isMenuShown){return}var e=[];if(!this.isReadOnly()){if(this._mode!==EditorMode.edit){e.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.switchToEditMode,this)})}else{e.push({id:"cancel",text:this.getMessage("menuCancel"),onclick:BX.delegate(this.switchToViewMode,this)})}e.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id))e.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)});else e.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}return e}},{key:"save",value:function t(e){var i=[];var s="";if(this._postForm){s=this._postForm.oEditor.GetContent();this._commentMessage=s;this._postForm.eventNode.querySelectorAll('input[name="UF_CRM_COMMENT_FILES[]"]').forEach((function(t){i.push(t.value)}))}if(!BX.type.isNotEmptyString(s)){if(!this.emptyCommentMessage){this.emptyCommentMessage=new BX.PopupWindow("timeline_empty_comment_"+this._id,e.target,{content:BX.message("CRM_TIMELINE_EMPTY_COMMENT_MESSAGE"),darkMode:true,autoHide:true,zIndex:990,angle:{position:"top",offset:77},closeByEsc:true,bindOptions:{forceBindPosition:true}})}this.emptyCommentMessage.show();return}if(this._isRequestRunning&&BX.type.isNotEmptyString(s)){return}this._isRequestRunning=true;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"UPDATE_COMMENT",ID:this.getId(),TEXT:s,OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ATTACHMENTS:i},onsuccess:BX.delegate(this.onSaveSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})}},{key:"processRemoval",value:function t(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";var e=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!e){e=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getMessage("commentRemove")})}e.open().then(BX.delegate(this.onRemovalConfirm,this),BX.delegate(this.onRemovalCancel,this))}},{key:"onRemovalConfirm",value:function t(e){if(BX.prop.getBoolean(e,"cancel",true)){return}this.remove()}},{key:"onRemovalCancel",value:function t(){}},{key:"remove",value:function t(i){if(this._isRequestRunning){return}var s=this._history._manager.getHistory();var n=s.findItemById(this._id);if(n instanceof e)n.clearAnimate();var a=this._history._manager.getFixedHistory();var r=a.findItemById(this._id);if(r instanceof e)r.clearAnimate();this._isRequestRunning=true;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"DELETE_COMMENT",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this.getId()},onsuccess:BX.delegate(this.onRemoveSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})}},{key:"onSaveSuccess",value:function t(i){this._isRequestRunning=false;var s=BX.prop.getObject(i,"HISTORY_ITEM");var n=this._fixedHistory.findItemById(this._id);if(n instanceof e){if(!BX.type.isNotEmptyString(s["IS_FIXED"]))s["IS_FIXED"]="Y";n.setData(s);n._id=BX.prop.getString(s,"ID");n.switchToViewMode()}var a=this._history.findItemById(this._id);if(a instanceof e){a.setData(s);a._id=BX.prop.getString(s,"ID");a.switchToViewMode()}this._postForm=null}},{key:"onRemoveSuccess",value:function t(e){}},{key:"onRequestFailure",value:function t(e){this._isRequestRunning=this._isLocked=false}},{key:"onExpandButtonClick",value:function t(e){if(!this._wrapper){return BX.PreventDefault(e)}var i=this._wrapper.querySelector("div.crm-entity-stream-section-content");if(!i){return BX.PreventDefault(e)}if(this._hasFiles&&BX.type.isDomNode(this._commentWrapper)&&!this._textLoaded){this._textLoaded=true;this.loadContent(this._commentWrapper,"GET_TEXT")}var s=i.querySelector(".crm-entity-stream-content-event");if(this._isCollapsed){s.style.maxHeight=s.scrollHeight+130+"px";BX.removeClass(i,"crm-entity-stream-section-content-collapsed");BX.addClass(i,"crm-entity-stream-section-content-expand");setTimeout(BX.delegate((function(){s.style.maxHeight=""}),this),300)}else{s.style.maxHeight=s.clientHeight+"px";BX.removeClass(i,"crm-entity-stream-section-content-expand");BX.addClass(i,"crm-entity-stream-section-content-collapsed");setTimeout(BX.delegate((function(){s.style.maxHeight=""}),this),0)}this._isCollapsed=!this._isCollapsed;var n=i.querySelector("a.crm-entity-stream-section-content-expand-btn");if(n){n.innerHTML=this.getMessage(this._isCollapsed?"expand":"collapse")}return BX.PreventDefault(e)}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(History);var Wait$2=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getTitle",value:function t(){return this.getMessage("wait")}},{key:"prepareTitleLayout",value:function t(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]})}},{key:"prepareTimeLayout",value:function t(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})}},{key:"prepareHeaderLayout",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});e.appendChild(this.prepareTitleLayout());e.appendChild(this.prepareTimeLayout());return e}},{key:"prepareContent",value:function t(){var e=this.getAssociatedEntityData();var i=BX.prop.getString(e,"DESCRIPTION_RAW","");if(i!==""){i=BX.util.trim(i);i=BX.util.strip_tags(i);i=BX.util.nl2br(i)}var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-wait"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-complete"}}));var n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[n]}));var a=this.prepareHeaderLayout();n.appendChild(a);var r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},html:i});n.appendChild(r);var o=this.prepareAuthorLayout();if(o){n.appendChild(o)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});n.appendChild(this._actionContainer);return s}},{key:"prepareActions",value:function t(){}},{key:"showActions",value:function t(e){if(this._actionContainer){this._actionContainer.style.display=e?"":"none"}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(HistoryActivity);var Sender=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getDataSetting",value:function t(e){var i=this.getObjectDataParam("SETTINGS")||{};return i[e]||null}},{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"getTitle",value:function t(){return this.getDataSetting("messageName")}},{key:"prepareTitleLayout",value:function t(){var e=this;return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},children:[this.isRemoved()?BX.create("SPAN",{text:this.getTitle()}):BX.create("A",{attrs:{href:""},events:{click:function t(i){if(BX.SidePanel){BX.SidePanel.Instance.open(e.getDataSetting("path"))}else{top.location.href=e.getDataSetting("path")}i.preventDefault();i.stopPropagation()}},text:this.getTitle()})]})}},{key:"prepareTimeLayout",value:function t(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})}},{key:"prepareStatusLayout",value:function t(){var e,i;if(this.getDataSetting("isError")){i=this.getMessage("error");e="crm-entity-stream-content-event-missing"}else if(this.getDataSetting("isUnsub")){i=this.getMessage("unsub");e="crm-entity-stream-content-event-missing"}else if(this.getDataSetting("isClick")){i=this.getMessage("click");e="crm-entity-stream-content-event-successful"}else{i=this.getMessage("read");e="crm-entity-stream-content-event-skipped"}return BX.create("SPAN",{attrs:{className:e},text:i})}},{key:"prepareHeaderLayout",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});e.appendChild(this.prepareTitleLayout());if(this.getDataSetting("isError")||this.getDataSetting("isRead")||this.getDataSetting("isUnsub")){e.appendChild(this.prepareStatusLayout())}e.appendChild(this.prepareTimeLayout());return e}},{key:"isRemoved",value:function t(){return!this.getDataSetting("letterTitle")}},{key:"prepareContent",value:function t(){var e=this.isRemoved()?this.getMessage("removed"):this.getMessage("title")+": "+this.getDataSetting("letterTitle");var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-wait"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-complete"}}));var s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));var n=this.prepareHeaderLayout();s.appendChild(n);var a=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},html:e});s.appendChild(a);var r=this.prepareAuthorLayout();if(r){s.appendChild(r)}return i}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(HistoryActivity);var Bizproc=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"getTitle",value:function t(){return this.getMessage("bizproc")}},{key:"prepareContent",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-bp"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-bp"}}));var i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});var s=this.prepareHeaderLayout();i.appendChild(s);i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},html:this.prepareContentTextHtml()})]}));var n=this.prepareAuthorLayout();if(n){i.appendChild(n)}e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));return e}},{key:"prepareContentTextHtml",value:function t(){var e=this.getTextDataParam("TYPE");if(e==="ACTIVITY_ERROR"){return"<strong>#TITLE#</strong>: #ERROR_TEXT#".replace("#TITLE#",BX.util.htmlspecialchars(this.getTextDataParam("ACTIVITY_TITLE"))).replace("#ERROR_TEXT#",BX.util.htmlspecialchars(this.getTextDataParam("ERROR_TEXT")))}var i=this.getTextDataParam("WORKFLOW_TEMPLATE_NAME");var s=this.getTextDataParam("WORKFLOW_STATUS_NAME");if(!i||s!=="Created"&&s!=="Completed"&&s!=="Terminated"){return BX.util.htmlspecialchars(this.getTextDataParam("COMMENT"))}var n=BX.message("CRM_TIMELINE_BIZPROC_CREATED");if(s==="Completed"){n=BX.message("CRM_TIMELINE_BIZPROC_COMPLETED")}else if(s==="Terminated"){n=BX.message("CRM_TIMELINE_BIZPROC_TERMINATED")}return BX.util.htmlspecialchars(n).replace("#NAME#","<strong>"+BX.util.htmlspecialchars(i)+"</strong>")}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(History);var Scoring=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this))}babelHelpers.createClass(e,[{key:"prepareContent",value:function t(){var e=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-scoring"},events:{click:function(){var t="/crm/ml/#entity#/#id#/detail";var e=this.getOwnerTypeId();var i=this.getOwnerId();var s;if(e===1){s="lead"}else if(e===2){s="deal"}else{return}t=t.replace("#entity#",s);t=t.replace("#id#",i);if(BX.SidePanel){BX.SidePanel.Instance.open(t,{width:840})}else{top.location.href=t}}.bind(this)}});var i=BX.prop.getObject(this._data,"SCORING_INFO",null);if(!i){return e}var s=BX.prop.getNumber(i,"SCORE",0);var n=BX.prop.getNumber(i,"SCORE_DELTA",0);s=Math.round(s*100);n=Math.round(n*100);var a=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-scoring-total-result"},text:s+"%"});var r="crm-entity-stream-content-scoring-total-icon";if(s<50){r+=" crm-entity-stream-content-scoring-total-icon-fail"}else if(s<75){r+=" crm-entity-stream-content-scoring-total-icon-middle"}else{r+=" crm-entity-stream-content-scoring-total-icon-success"}var o=BX.create("DIV",{attrs:{className:r}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-scoring-total"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-scoring-total-text"},text:BX.message("CRM_TIMELINE_SCORING_TITLE_2")}),a,o]}),BX.create("DIV",{attrs:{className:"crm-entity-stream-content-scoring-event"},children:[n!==0?BX.create("DIV",{attrs:{className:"crm-entity-stream-content-scoring-event-offset"},text:(n>0?"+":"")+n+"%"}):null]})]}));return e}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(History);var History$1=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._items=[];t._wrapper=null;t._fixedHistory=null;t._emptySection=null;t._currentDaySection=null;t._lastDaySection=null;t._lastDate=null;t._anchor=null;t._history=babelHelpers.assertThisInitialized(t);t._enableLoading=false;t._navigation=null;t._scrollHandler=null;t._loadingWaiter=null;t._filterId="";t._isFilterApplied=false;t._isFilterShown=false;t._isRequestRunning=false;t._filterButton=null;t._filterWrapper=null;t._filterResultStub=null;return t}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){this._fixedHistory=this.getSetting("fixedHistory");this._ownerTypeId=this.getSetting("ownerTypeId");this._ownerId=this.getSetting("ownerId");this._serviceUrl=this.getSetting("serviceUrl","");if(!this.isStubMode()){var e=this.getSetting("itemData");if(!BX.type.isArray(e)){e=[]}var i,s,n;for(i=0,s=e.length;i<s;i++){n=this.createItem(e[i]);if(n){this._items.push(n)}}this._navigation=this.getSetting("navigation",{});this._filterWrapper=BX("timeline-filter");this._filterId=BX.prop.getString(this._settings,"filterId",this._id);this._isFilterShown=this._filterWrapper&&BX.hasClass(this._filterWrapper,"crm-entity-stream-section-filter-show");this._isFilterApplied=BX.prop.getBoolean(this._settings,"isFilterApplied",false);BX.addCustomEvent("BX.Main.Filter:apply",this.onFilterApply.bind(this))}}},{key:"layout",value:function t(){this._wrapper=BX.create("DIV",{});this._container.appendChild(this._wrapper);var e=BX.prop.extractDate(new Date);var i,s,n;if(!this.isStubMode()){if(this._filterWrapper){var a=this._filterWrapper.querySelector(".crm-entity-stream-filter-close");if(a){BX.bind(a,"click",this.onFilterClose.bind(this))}}for(i=0,s=this._items.length;i<s;i++){n=this._items[i];n.setContainer(this._wrapper);var r=n.getCreatedDate();if(this._lastDate===null||this._lastDate.getTime()!==r.getTime()){this._lastDate=r;if(e.getTime()===r.getTime()){this._currentDaySection=this._lastDaySection=this.createCurrentDaySection();this._wrapper.appendChild(this._currentDaySection)}else{this._lastDaySection=this.createDaySection(this._lastDate);this._wrapper.appendChild(this._lastDaySection)}}n._lastDate=this._lastDate;n.layout()}this.enableLoading(this._items.length>0);this.refreshLayout()}else{this._currentDaySection=this._lastDaySection=this.createCurrentDaySection();this._wrapper.appendChild(this._currentDaySection);this._wrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-createEntity crm-entity-stream-section-last"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},text:BX.message("CRM_TIMELINE_HISTORY_STUB")})]})]})]}))}this._manager.processHistoryLayoutChange()}},{key:"refreshLayout",value:function t(){if(this._filterWrapper){if(this._wrapper.firstChild&&this._filterWrapper!==this._wrapper.firstChild){this._wrapper.insertBefore(this._filterWrapper,this._wrapper.firstChild)}else if(!this._wrapper.firstChild&&this._filterWrapper.parentNode!==this._wrapper){this._wrapper.appendChild(this._filterWrapper)}}this.adjustFilterButton();var e=this._items.length;if(e===0&&this._isFilterApplied){if(!this._filterEmptyResultSection){this._filterEmptyResultSection=this.createFilterEmptyResultSection()}this._wrapper.appendChild(this._filterEmptyResultSection);return}if(this._filterEmptyResultSection){this._filterEmptyResultSection=BX.remove(this._filterEmptyResultSection)}if(e===0){return}for(var i=0;i<e-1;i++){var s=this._items[i];if(s.isTerminated()){s.markAsTerminated(false)}}this._items[e-1].markAsTerminated(true)}},{key:"calculateItemIndex",value:function t(e){return 0}},{key:"checkItemForTermination",value:function t(e){return this.getLastItem()===e}},{key:"hasContent",value:function t(){return this._items.length>0||this._isFilterApplied||this._isStubMode}},{key:"getLastItem",value:function t(){return this._items.length>0?this._items[this._items.length-1]:null}},{key:"getItemByIndex",value:function t(e){return e<this._items.length?this._items[e]:null}},{key:"getItemCount",value:function t(){return this._items.length}},{key:"removeItemByIndex",value:function t(e){if(e<this._items.length){this._items.splice(e,1)}}},{key:"getItemIndex",value:function t(e){for(var i=0,s=this._items.length;i<s;i++){if(this._items[i]===e){return i}}return-1}},{key:"getItemsByAssociatedEntity",value:function t(e,i){if(!BX.type.isNumber(e)){e=parseInt(e)}if(!BX.type.isNumber(i)){i=parseInt(i)}if(isNaN(e)||e<=0||isNaN(i)||i<=0){return[]}var s=[];for(var n=0,a=this._items.length;n<a;n++){var r=this._items[n];if(r.getAssociatedEntityTypeId()===e&&r.getAssociatedEntityId()===i){s.push(r)}}return s}},{key:"findItemById",value:function t(e){e=e.toString();for(var i=0,s=this._items.length;i<s;i++){if(this._items[i].getId()===e){return this._items[i]}}return null}},{key:"createFilterEmptyResultSection",value:function t(){return BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-filter-empty"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-filter-empty"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-filter-empty-img"}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-filter-empty-text"},text:this.getMessage("filterEmptyResultStub")})]})]})]})}},{key:"adjustFilterButton",value:function t(){if(!this._filterWrapper){return}if(!this._isFilterShown&&this._items.length===0){if(!this._emptySection){this._emptySection=this.createEmptySection()}this._wrapper.insertBefore(this._emptySection,this._filterWrapper)}else if(this._emptySection){this._emptySection=BX.remove(this._emptySection)}if(!this._filterButton){this._filterButton=BX.create("BUTTON",{attrs:{className:"crm-entity-stream-filter-label"},text:this.getMessage("filterButtonCaption")});BX.bind(this._filterButton,"click",function(t){this.showFilter()}.bind(this))}var e=this._wrapper.querySelector(".crm-entity-stream-section-today-label, .crm-entity-stream-section-planned-label, .crm-entity-stream-section-history-label");if(e){var i=e.querySelector(".crm-entity-stream-section-content");if(i){if(this._filterButton.parentNode!==i){i.appendChild(this._filterButton)}}}if(this._isFilterApplied){BX.addClass(this._filterButton,"crm-entity-stream-filter-label-active")}else{BX.removeClass(this._filterButton,"crm-entity-stream-filter-label-active")}}},{key:"showFilter",value:function t(e){if(!this._filterWrapper){return}BX.removeClass(this._filterWrapper,"crm-entity-stream-section-filter-hide");BX.addClass(this._filterWrapper,"crm-entity-stream-section-filter-show");this._isFilterShown=true;if(BX.prop.getBoolean(e,"enableAdjust",true)){this.adjustFilterButton()}}},{key:"hideFilter",value:function t(e){if(!this._filterWrapper){return}BX.removeClass(this._filterWrapper,"crm-entity-stream-section-filter-show");BX.addClass(this._filterWrapper,"crm-entity-stream-section-filter-hide");this._isFilterShown=false;if(BX.prop.getBoolean(e,"enableAdjust",true)){this.adjustFilterButton()}}},{key:"onFilterClose",value:function t(e){this.hideFilter();window.setTimeout(function(){var t=BX.Main.filterManager.getById(this._filterId);if(t){t.resetFilter()}}.bind(this),500)}},{key:"createEmptySection",value:function t(){return BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-planned-label"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}})]})}},{key:"createCurrentDaySection",value:function t(){return BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-today-label"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-today-label"},text:this.formatDate(BX.prop.extractDate(new Date))})]})]})}},{key:"createDaySection",value:function t(e){return BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history-label"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-history-label"},text:this.formatDate(e)})]})]})}},{key:"createAnchor",value:function t(e){if(this._emptySection){this._emptySection=BX.remove(this._emptySection)}if(this._currentDaySection===null){this._currentDaySection=this.createCurrentDaySection();if(this._wrapper.firstChild){this._wrapper.insertBefore(this._currentDaySection,this._wrapper.firstChild)}else{this._wrapper.appendChild(this._currentDaySection)}}if(this._anchor===null){this._anchor=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-shadow"}});if(this._currentDaySection.nextSibling){this._wrapper.insertBefore(this._anchor,this._currentDaySection.nextSibling)}else{this._wrapper.appendChild(this._anchor)}}return this._anchor}},{key:"createActivityItem",value:function t(e){var i=BX.prop.getInteger(e,"TYPE_ID",Item.undefined);var s=BX.prop.getInteger(e,"TYPE_CATEGORY_ID",0);var n=BX.prop.getString(BX.prop.getObject(e,"ASSOCIATED_ENTITY",{}),"PROVIDER_ID","");var a="TYPE_"+s+(n?"_"+n:"");var r=new Map([["TYPE_"+BX.CrmActivityType.provider+"_CRM_NOTIFICATION",BX.Crm.Timeline.Notification],["TYPE_"+BX.CrmActivityType.provider+"_CRM_DELIVERY",BX.Crm.Timeline.DeliveryActivity]]);var o=r.has(a)?r.get(a):null;if(i!==Item.activity){return null}if(s===BX.CrmActivityType.email){return Email$2.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}if(s===BX.CrmActivityType.call){return Call$2.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(s===BX.CrmActivityType.meeting){return Meeting$1.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(s===BX.CrmActivityType.task){return Task$1.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(s===BX.CrmActivityType.provider){if(n==="CRM_WEBFORM"){return WebForm$1.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(n==="CRM_SMS"){return Sms$1.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e,smsStatusDescriptions:this._manager.getSetting("smsStatusDescriptions",{}),smsStatusSemantics:this._manager.getSetting("smsStatusSemantics",{})})}else if(n==="CRM_REQUEST"){return Request$1.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(n==="IMOPENLINES_SESSION"){return OpenLine$2.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(n==="REST_APP"){return Rest$2.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(n==="VISIT_TRACKER"){return Visit.create(e["ID"],{history:this,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(n==="CRM_DELIVERY"){return HistoryActivity.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e,vueComponent:o})}else if(n==="ZOOM"){return Zoom$1.create(e["ID"],{history:this,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(n==="CRM_CALL_TRACKER"){return Call$2.create(e["ID"],{history:this,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}}return HistoryActivity.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e,vueComponent:o})}},{key:"createOrderEntityItem",value:function t(e){var i=BX.prop.getInteger(e,"ASSOCIATED_ENTITY_TYPE_ID",0);var s=BX.prop.getInteger(e,"TYPE_CATEGORY_ID",0);if(i!==BX.CrmEntityType.enumeration.order&&i!==BX.CrmEntityType.enumeration.orderpayment&&i!==BX.CrmEntityType.enumeration.ordershipment){return null}var n={history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e};if(s===Item.creation){return OrderCreation.create(e["ID"],n)}else if(s===Item.modification){return OrderModification.create(e["ID"],n)}else if(s===Order.encourageBuyProducts){n.vueComponent=BX.Crm.Timeline.EncourageBuyProducts;return History.create(e["ID"],n)}}},{key:"createStoreDocumentItem",value:function t(e){var i=BX.prop.getInteger(e,"ASSOCIATED_ENTITY_TYPE_ID",0);var s=BX.prop.getInteger(e,"TYPE_CATEGORY_ID",0);if(i!==BX.CrmEntityType.enumeration.storeDocument&&i!==BX.CrmEntityType.enumeration.shipmentDocument){return null}var n={history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e};if(s===Item.creation){return StoreDocumentCreation.create(e["ID"],n)}else if(s===Item.modification){return StoreDocumentModification.create(e["ID"],n)}}},{key:"createExternalNotificationItem",value:function t(e){var i=BX.prop.getInteger(e,"TYPE_CATEGORY_ID",0);var s=BX.prop.getString(e,"CHANGED_FIELD_NAME","");if(i===Item.modification&&s==="STATUS_ID"){return ExternalNoticeStatusModification.create(e["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:e})}return ExternalNoticeModification.create(e["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:e})}},{key:"createDeliveryItem",value:function t(e){var i=BX.prop.getInteger(e,"TYPE_ID",Item.undefined);var s=BX.prop.getInteger(e,"TYPE_CATEGORY_ID",0);if(i!==Item.delivery){return null}var n=new Map([[Delivery.taxiEstimationRequest,BX.Crm.Delivery.Taxi.EstimationRequest],[Delivery.taxiCallRequest,BX.Crm.Delivery.Taxi.CallRequest],[Delivery.taxiCancelledByManager,BX.Crm.Delivery.Taxi.CancelledByManager],[Delivery.taxiCancelledByDriver,BX.Crm.Delivery.Taxi.CancelledByDriver],[Delivery.taxiPerformerNotFound,BX.Crm.Delivery.Taxi.PerformerNotFound],[Delivery.taxiSmsProviderIssue,BX.Crm.Delivery.Taxi.SmsProviderIssue],[Delivery.taxiReturnedFinish,BX.Crm.Delivery.Taxi.ReturnedFinish],[Delivery.deliveryMessage,BX.Crm.Timeline.DeliveryMessage],[Delivery.deliveryCalculation,BX.Crm.Timeline.DeliveryCalculation]]);if(n.has(s)){return History.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e,vueComponent:n.get(s)})}}},{key:"createItem",value:function t(e){var i=BX.prop.getInteger(e,"TYPE_ID",Item.undefined);var s=BX.prop.getInteger(e,"TYPE_CATEGORY_ID",0);if(i===Item.activity){return this.createActivityItem(e)}else if(i===Item.order){return this.createOrderEntityItem(e)}else if(i===Item.storeDocument){return this.createStoreDocumentItem(e)}else if(i===Item.externalNotification){return this.createExternalNotificationItem(e)}else if(i===Item.orderCheck){return OrderCheck.create(e["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(i===Item.finalSummary){return FinalSummary.create(e["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(i===Item.finalSummaryDocuments){return FinalSummaryDocuments.create(e["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(i===Item.creation){return Creation.create(e["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(i===Item.restoration){return Restoration.create(e["ID"],{history:this._history,container:this._wrapper,data:e})}else if(i===Item.link){return Link.create(e["ID"],{history:this,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(i===Item.unlink){return Unlink.create(e["ID"],{history:this,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(i===Item.mark){return Mark$1.create(e["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,fixedHistory:this._fixedHistory,data:e})}else if(i===Item.comment){return Comment$1.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(i===Item.wait){return Wait$2.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(i===Item.document){return Document.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(i===Item.sender){return Sender.create(e["ID"],{history:this,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(i===Item.modification){return Modification.create(e["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(i===Item.conversion){return Conversion.create(e["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(i===Item.bizproc){return Bizproc.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(i===Item.scoring){return Scoring.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}else if(i===Item.delivery){return this.createDeliveryItem(e)}return History.create(e["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:e})}},{key:"addItem",value:function t(e,i){if(!BX.type.isNumber(i)||i<0){i=this.calculateItemIndex(e)}if(i<this._items.length){this._items.splice(i,0,e)}else{this._items.push(e)}this.refreshLayout();this._manager.processHistoryLayoutChange()}},{key:"deleteItem",value:function t(e){var i=this.getItemIndex(e);if(i<0){return}e.clearLayout();this.removeItemByIndex(i);this.refreshLayout();this._manager.processHistoryLayoutChange()}},{key:"resetLayout",value:function t(){var e;for(e=this._items.length-1;e>=0;e--){this._items[e].clearLayout()}this._items=[];this._currentDaySection=this._lastDaySection=this._emptySection=this._filterEmptyResultSection=null;this._anchor=null;this._lastDate=null;var i=[];var s;for(e=0;s=this._wrapper.children[e];e++){if(s!==this._filterWrapper){i.push(s)}}for(e=0;s=i[e];e++){this._wrapper.removeChild(s)}}},{key:"onWindowScroll",value:function t(e){if(!this._loadingWaiter||!this._enableLoading||this._isRequestRunning){return}var i=this._loadingWaiter.getBoundingClientRect();if(i.top<=document.documentElement.clientHeight){this.loadItems()}}},{key:"onFilterApply",value:function t(e,i,s,n,a){if(e!==this._filterId){return}a.autoResolve=false;this._isFilterApplied=BX.prop.getString(i,"action","")==="apply";this._isRequestRunning=true;BX.CrmDataLoader.create(this._id,{serviceUrl:this.getSetting("serviceUrl",""),action:"GET_HISTORY_ITEMS",params:{GUID:this._id,OWNER_TYPE_ID:this._manager.getOwnerTypeId(),OWNER_ID:this._manager.getOwnerId()}}).load(function(t,e){this.resetLayout();this.bulkCreateItems(BX.prop.getArray(e,"HISTORY_ITEMS",[]));this.setNavigation(BX.prop.getObject(e,"HISTORY_NAVIGATION",{}));this.refreshLayout();if(this._items.length>0){this._manager.processHistoryLayoutChange()}n.fulfill();this._isRequestRunning=false}.bind(this))}},{key:"bulkCreateItems",value:function t(e){var i=e.length;if(i===0){return}if(this._filterEmptyResultSection){this._filterEmptyResultSection=BX.remove(this._filterEmptyResultSection)}var s=BX.prop.extractDate(new Date);var n,a;var r="";for(n=0;n<i;n++){var o=BX.prop.getInteger(e[n],"ID",0);if(o<=0){continue}r=BX.prop.getString(e[n],"CREATED_SERVER","");if(this.findItemById(o)!==null){continue}a=this.createItem(e[n]);this._items.push(a);var l=a.getCreatedDate();if(this._lastDate===null||this._lastDate.getTime()!==l.getTime()){this._lastDate=l;if(s.getTime()===l.getTime()){this._currentDaySection=this._lastDaySection=this.createCurrentDaySection();this._wrapper.appendChild(this._currentDaySection)}else{this._lastDaySection=this.createDaySection(this._lastDate);this._wrapper.appendChild(this._lastDaySection)}}a.layout()}}},{key:"loadItems",value:function t(){this._isRequestRunning=true;BX.CrmDataLoader.create(this._id,{serviceUrl:this.getSetting("serviceUrl",""),action:"GET_HISTORY_ITEMS",params:{GUID:this._id,OWNER_TYPE_ID:this._manager.getOwnerTypeId(),OWNER_ID:this._manager.getOwnerId(),NAVIGATION:this._navigation}}).load(function(t,e){this.bulkCreateItems(BX.prop.getArray(e,"HISTORY_ITEMS",[]));this.setNavigation(BX.prop.getObject(e,"HISTORY_NAVIGATION",{}));this.refreshLayout();if(this._items.length>0){this._manager.processHistoryLayoutChange()}this._isRequestRunning=false}.bind(this))}},{key:"getNavigation",value:function t(){return this._navigation}},{key:"setNavigation",value:function t(e){if(!BX.type.isPlainObject(e)){e={}}this._navigation=e;this.enableLoading(BX.prop.getString(this._navigation,"OFFSET_TIMESTAMP","")!=="")}},{key:"isLoadingEnabled",value:function t(){return this._enableLoading}},{key:"enableLoading",value:function t(e){e=!!e;if(this._enableLoading===e){return}this._enableLoading=e;if(this._enableLoading){if(this._items.length>0){this._loadingWaiter=this._items[this._items.length-1].getWrapper()}if(!this._scrollHandler){this._scrollHandler=BX.delegate(this.onWindowScroll,this);BX.bind(window,"scroll",this._scrollHandler)}}else{this._loadingWaiter=null;if(this._scrollHandler){BX.unbind(window,"scroll",this._scrollHandler);this._scrollHandler=null}}}},{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);e.instances[n.getId()]=n;return n}}]);return e}(Steam);babelHelpers.defineProperty(History$1,"messages",{});babelHelpers.defineProperty(History$1,"instances",{});var FixedHistory=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._items=[];t._wrapper=null;t._fixedHistory=babelHelpers.assertThisInitialized(t);t._history=babelHelpers.assertThisInitialized(t);t._isRequestRunning=false;return t}babelHelpers.createClass(e,[{key:"doInitialize",value:function t(){var e=BX.message("FORMAT_DATETIME").replace(/:SS/,"");this._timeFormat=BX.date.convertBitrixFormat(e);var i=this.getSetting("itemData");if(!BX.type.isArray(i)){i=[]}var s,n,a;for(s=0,n=i.length;s<n;s++){a=this.createItem(i[s]);a._isFixed=true;this._items.push(a)}}},{key:"setHistory",value:function t(e){this._history=e}},{key:"checkItemForTermination",value:function t(e){return false}},{key:"layout",value:function t(){this._wrapper=BX.create("DIV",{});this.createAnchor();this._container.insertBefore(this._wrapper,this._editorContainer.nextElementSibling);for(var e=0;e<this._items.length;e++){this._items[e].setContainer(this._wrapper);this._items[e].layout()}this.refreshLayout();this._manager.processHistoryLayoutChange()}},{key:"refreshLayout",value:function t(){}},{key:"formatDate",value:function t(e){}},{key:"createCurrentDaySection",value:function t(){}},{key:"createDaySection",value:function t(e){}},{key:"createAnchor",value:function t(e){this._anchor=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-fixed-anchor"}});this._wrapper.appendChild(this._anchor)}},{key:"onWindowScroll",value:function t(e){}},{key:"onItemsLoad",value:function t(e,i){}},{key:"loadItems",value:function t(){this._isRequestRunning=true;BX.CrmDataLoader.create(this._id,{serviceUrl:this.getSetting("serviceUrl",""),action:"GET_FIXED_HISTORY_ITEMS",params:{OWNER_TYPE_ID:this._manager.getOwnerTypeId(),OWNER_ID:this._manager.getOwnerId()}}).load(BX.delegate(this.onItemsLoad,this))}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);this.instances[n.getId()]=n;return n}}]);return e}(History$1);FixedHistory.instances={};var Expand=function(){function t(){babelHelpers.classCallCheck(this,t);this._node=null;this._callback=null}babelHelpers.createClass(t,[{key:"initialize",value:function t(e,i){this._node=e;this._callback=BX.type.isFunction(i)?i:null}},{key:"run",value:function t(){var e=BX.pos(this._node);this._node.style.height=0;this._node.style.opacity=0;this._node.style.overflow="hidden";new BX.easing({duration:150,start:{height:0},finish:{height:e.height},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.delegate(this.onNodeHeightStep,this),complete:BX.delegate(this.onNodeHeightComplete,this)}).animate()}},{key:"onNodeHeightStep",value:function t(e){this._node.style.height=e.height+"px"}},{key:"onNodeHeightComplete",value:function t(){this._node.style.overflow="";new BX.easing({duration:150,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.delegate(this.onNodeOpacityStep,this),complete:BX.delegate(this.onNodeOpacityComplete,this)}).animate()}},{key:"onNodeOpacityStep",value:function t(e){this._node.style.opacity=e.opacity/100}},{key:"onNodeOpacityComplete",value:function t(){this._node.style.height="";this._node.style.opacity="";if(this._callback){this._callback()}}}],[{key:"create",value:function e(i,s){var n=new t;n.initialize(i,s);return n}}]);return t}();var Manager=function(){function t(){babelHelpers.classCallCheck(this,t);this._id="";this._settings={};this._container=null;this._ownerTypeId=0;this._ownerId=0;this._ownerInfo=null;this._progressSemantics="";this._commentEditor=null;this._waitEditor=null;this._smsEditor=null;this._zoomEditor=null;this._chat=null;this._schedule=null;this._history=null;this._fixedHistory=null;this._activityEditor=null;this._menuBar=null;this._userId=0;this._readOnly=false;this._pullTagName=""}babelHelpers.createClass(t,[{key:"initialize",value:function t(e,i){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=i?i:{};this._ownerTypeId=parseInt(this.getSetting("ownerTypeId"));this._ownerId=parseInt(this.getSetting("ownerId"));this._ownerInfo=this.getSetting("ownerInfo");this._progressSemantics=BX.prop.getString(this._settings,"progressSemantics","");this._spotlightFastenShowed=this.getSetting("spotlightFastenShowed",true);this._audioPlaybackRate=parseFloat(this.getSetting("audioPlaybackRate",1));var s=this.getSetting("containerId");if(!BX.type.isNotEmptyString(s)){throw"Manager. A required parameter 'containerId' is missing."}this._container=BX(s);if(!BX.type.isElementNode(this._container)){throw"Manager. Container node is not found."}this._editorContainer=BX(this.getSetting("editorContainer"));this._userId=BX.prop.getInteger(this._settings,"userId",0);this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);var n=this.getSetting("activityEditorId");if(BX.type.isNotEmptyString(n)){this._activityEditor=BX.CrmActivityEditor.items[n];if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"BX.CrmTimeline. Activity editor instance is not found."}}var a=this.getSetting("ajaxId");var r=this.getSetting("currentUrl");var o=this.getSetting("serviceUrl");this._chat=EntityChat.create(this._id,{manager:this,container:this._container,data:this.getSetting("chatData"),isStubMode:this._ownerId<=0,readOnly:this._readOnly});this._schedule=Schedule.create(this._id,{manager:this,container:this._container,activityEditor:this._activityEditor,itemData:this.getSetting("scheduleData"),isStubMode:this._ownerId<=0,ajaxId:a,serviceUrl:o,currentUrl:r,userId:this._userId,readOnly:this._readOnly});this._fixedHistory=FixedHistory.create(this._id,{manager:this,container:this._container,editorContainer:this._editorContainer,activityEditor:this._activityEditor,itemData:this.getSetting("fixedData"),isStubMode:this._ownerId<=0,ajaxId:a,serviceUrl:o,currentUrl:r,userId:this._userId,readOnly:this._readOnly});this._history=History$1.create(this._id,{manager:this,container:this._container,fixedHistory:this._fixedHistory,activityEditor:this._activityEditor,itemData:this.getSetting("historyData"),navigation:this.getSetting("historyNavigation",{}),filterId:BX.prop.getString(this._settings,"historyFilterId",this._id),isFilterApplied:BX.prop.getBoolean(this._settings,"isHistoryFilterApplied",false),isStubMode:this._ownerId<=0,ajaxId:a,serviceUrl:o,currentUrl:r,userId:this._userId,readOnly:this._readOnly});this._schedule.setHistory(this._history);this._fixedHistory.setHistory(this._history);this._commentEditor=Comment.create(this._id,{manager:this,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,serviceUrl:this.getSetting("serviceUrl"),container:this.getSetting("editorCommentContainer"),input:this.getSetting("editorCommentInput"),editorName:this.getSetting("editorCommentEditorName"),button:this.getSetting("editorCommentButton"),cancelButton:this.getSetting("editorCommentCancelButton")});this._commentEditor.setVisible(true);this._commentEditor.setHistory(this._history);if(this._readOnly){this._commentEditor.setVisible(false)}if(BX.prop.getBoolean(this._settings,"enableWait",false)){this._waitEditor=Wait.create(this._id,{manager:this,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,serviceUrl:this.getSetting("serviceUrl"),config:this.getSetting("editorWaitConfig",{}),targetDates:this.getSetting("editorWaitTargetDates",[]),container:this.getSetting("editorWaitContainer"),configContainer:this.getSetting("editorWaitConfigContainer"),input:this.getSetting("editorWaitInput"),button:this.getSetting("editorWaitButton"),cancelButton:this.getSetting("editorWaitCancelButton")});this._waitEditor.setVisible(false)}if(BX.prop.getBoolean(this._settings,"enableSms",false)){this._smsEditor=Sms.create(this._id,{manager:this,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,serviceUrl:this.getSetting("serviceUrl"),config:this.getSetting("editorSmsConfig",{}),container:this.getSetting("editorSmsContainer"),input:this.getSetting("editorSmsInput"),templatesContainer:this.getSetting("editorSmsTemplatesContainer"),button:this.getSetting("editorSmsButton"),cancelButton:this.getSetting("editorSmsCancelButton")});this._smsEditor.setVisible(false)}if(BX.prop.getBoolean(this._settings,"enableZoom",false)&&BX.prop.getBoolean(this._settings,"statusZoom",false)){this._zoomEditor=new BX.Crm.Zoom({id:this._id,manager:this,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,container:this.getSetting("editorZoomContainer"),userId:this._userId});this._zoomEditor.setVisible(false)}if(BX.prop.getBoolean(this._settings,"enableRest",false)){this._restEditor=Rest.create(this._id,{manager:this,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,placement:BX.prop.getString(this._settings,"restPlacement","")})}this._chat.layout();this._schedule.layout();this._fixedHistory.layout();this._history.layout();this._pullTagName=BX.prop.getString(this._settings,"pullTagName","");if(this._pullTagName!==""){BX.addCustomEvent("onPullEvent-crm",BX.delegate(this.onPullEvent,this));this.extendWatch()}this._menuBar=MenuBar.create(this._id,{container:BX(this.getSetting("menuBarContainer")),menuId:this.getSetting("menuBarObjectId"),ownerInfo:this._ownerInfo,activityEditor:this._activityEditor,commentEditor:this._commentEditor,waitEditor:this._waitEditor,smsEditor:this._smsEditor,zoomEditor:this._zoomEditor,restEditor:this._restEditor,readOnly:this._readOnly,manager:this});if(!this._readOnly){this._menuBar.reset()}BX.addCustomEvent(window,"Crm.EntityProgress.Change",BX.delegate(this.onEntityProgressChange,this));BX.ready((function(){window.addEventListener("scroll",BX.throttle((function(){BX.LazyLoad.onScroll()}),80))}))}},{key:"extendWatch",value:function t(){if(BX.type.isFunction(BX.PULL)&&this._pullTagName!==""){BX.PULL.extendWatch(this._pullTagName);window.setTimeout(BX.delegate(this.extendWatch,this),6e4)}}},{key:"onPullEvent",value:function t(e,i){if(this._pullTagName!==BX.prop.getString(i,"TAG","")){return}if(e==="timeline_chat_create"){this.processChatCreate(i)}else if(e==="timeline_activity_add"){this.processActivityExternalAdd(i)}else if(e==="timeline_activity_update"){this.processActivityExternalUpdate(i)}else if(e==="timeline_activity_delete"){this.processActivityExternalDelete(i)}else if(e==="timeline_comment_add"){this.processCommentExternalAdd(i)}else if(e==="timeline_link_add"){this.processLinkExternalAdd(i)}else if(e==="timeline_link_delete"){this.processLinkExternalDelete(i)}else if(e==="timeline_document_add"){this.processLinkExternalAdd(i)}else if(e==="timeline_document_update"){this.processDocumentExternalUpdate(i)}else if(e==="timeline_document_delete"){this.processDocumentExternalDelete(i)}else if(e==="timeline_comment_update"){this.processCommentExternalUpdate(i)}else if(e==="timeline_comment_delete"){this.processCommentExternalDelete(i)}else if(e==="timeline_changed_binding"){this.processChangeBinding(i)}else if(e==="timeline_item_change_fasten"){this.processItemChangeFasten(i)}else if(e==="timeline_item_update"){this.processItemExternalUpdate(i)}else if(e==="timeline_wait_add"){this.processWaitExternalAdd(i)}else if(e==="timeline_wait_update"){this.processWaitExternalUpdate(i)}else if(e==="timeline_wait_delete"){this.processWaitExternalDelete(i)}else if(e==="timeline_bizproc_status"){this.processBizprocStatus(i)}else if(e==="timeline_scoring_add"){this.processScoringExternalAdd(i)}}},{key:"processChatCreate",value:function t(e){if(this._chat){this._chat.setData(BX.prop.getObject(e,"CHAT_DATA",{}));this._chat.refreshLayout()}}},{key:"processActivityExternalAdd",value:function t(e){var i,s,n,a,r;i=BX.prop.getObject(e,"ENTITY",null);s=BX.prop.getObject(e,"SCHEDULE_ITEM",null);n=BX.prop.getObject(e,"HISTORY_ITEM",null);if(i&&n&&!BX.type.isPlainObject(n["ASSOCIATED_ENTITY"])){n["ASSOCIATED_ENTITY"]=i}if(s!==null&&this._schedule.getItemByData(s)===null){a=this.addScheduleItem(s);a.addWrapperClass("crm-entity-stream-section-updated",1e3)}if(n!==null){r=this._history.findItemById(BX.prop.getString(n,"ID"));if(!r){r=this.addHistoryItem(n);Expand.create(r.getWrapper(),null).run()}}}},{key:"processActivityExternalUpdate",value:function t(e){var i,s,n,a,r,o;i=BX.prop.getObject(e,"ENTITY",null);s=BX.prop.getObject(e,"SCHEDULE_ITEM",null);a=BX.prop.getObject(e,"HISTORY_ITEM",null);if(i){if(a&&!BX.type.isPlainObject(a["ASSOCIATED_ENTITY"])){a["ASSOCIATED_ENTITY"]=i}var l=BX.prop.getInteger(i,"ID",0);var c=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.activity,l);for(var u=0,h=c.length;u<h;u++){r=c[u];r.setAssociatedEntityData(i);r.refreshLayout()}var d=this._fixedHistory.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.activity,l);for(var p=0,m=d.length;p<m;p++){o=d[p];o.setAssociatedEntityData(i);o.refreshLayout()}}if(s!==null){n=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.activity,BX.prop.getInteger(s,"ASSOCIATED_ENTITY_ID"));if(n){n.setData(s);if(!n.isDone()){this._schedule.refreshItem(n)}else{if(a){this._schedule.transferItemToHistory(n,a);a=null}else{this._schedule.deleteItem(n)}}}else if(!Scheduled.isDone(s)){n=this.addScheduleItem(s);n.addWrapperClass("crm-entity-stream-section-updated",1e3)}}if(a!==null){r=this._history.findItemById(BX.prop.getString(a,"ID"));if(!r){r=this.addHistoryItem(a);Expand.create(r.getWrapper(),null).run()}else{r.setData(a);r.refreshLayout();o=this._fixedHistory.findItemById(BX.prop.getString(a,"ID"));if(o){o.setData(a);o.refreshLayout()}}}}},{key:"processActivityExternalDelete",value:function t(e){var i=BX.prop.getInteger(e,"ENTITY_ID",0);var s=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.activity,i);for(var n=0,a=s.length;n<a;n++){this._history.deleteItem(s[n])}var r=this._fixedHistory.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.activity,i);for(var o=0,l=r.length;o<l;o++){this._fixedHistory.deleteItem(r[o])}var c=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.activity,i);if(c){this._schedule.deleteItem(c)}}},{key:"processCommentExternalAdd",value:function t(e){var i,s;i=BX.prop.getObject(e,"HISTORY_ITEM",null);if(i!==null){window.setTimeout(BX.delegate((function(){if(!this._history.findItemById(i["ID"])){s=this.addHistoryItem(i);Expand.create(s.getWrapper(),null).run()}}),this),1500)}}},{key:"processLinkExternalAdd",value:function t(e){var i,s;i=BX.prop.getObject(e,"HISTORY_ITEM",null);if(i!==null){s=this.addHistoryItem(i);Expand.create(s.getWrapper(),null).run()}}},{key:"processLinkExternalDelete",value:function t(e){this.processLinkExternalAdd(e)}},{key:"processCommentExternalUpdate",value:function t(e){var i=BX.prop.getInteger(e,"ENTITY_ID",0);var s=BX.prop.getObject(e,"HISTORY_ITEM",null);var n=this._history.findItemById(i);if(n instanceof Comment&&s!==null){n.setData(s);n.switchToViewMode()}var a=this._fixedHistory.findItemById(i);if(a instanceof Comment&&s!==null){a.setData(s);a.switchToViewMode()}}},{key:"processCommentExternalDelete",value:function t(e){var i=BX.prop.getInteger(e,"ENTITY_ID",0);window.setTimeout(BX.delegate((function(){var t=this._history.findItemById(i);if(t instanceof Comment){this._history.deleteItem(t)}var e=this._fixedHistory.findItemById(i);if(e instanceof Comment){this._fixedHistory.deleteItem(e)}}),this),1200)}},{key:"processDocumentExternalDelete",value:function t(e){window.setTimeout(BX.delegate((function(){var t=BX.prop.getObject(e,"HISTORY_ITEM",null);var i,s;var n=BX.prop.getInteger(t,"ASSOCIATED_ENTITY_ID",0);var a=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.document,n);for(i=0,s=a.length;i<s;i++){if(a[i]instanceof Document){this._history.deleteItem(a[i])}}a=this._fixedHistory.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.document,n);for(i=0,s=a.length;i<s;i++){if(a[i]instanceof Document){this._fixedHistory.deleteItem(a[i])}}}),this),100)}},{key:"processDocumentExternalUpdate",value:function t(e){var i=BX.prop.getObject(e,"HISTORY_ITEM",null);var s=BX.prop.getInteger(i,"ID",0);var n=this._history.findItemById(s);if(n instanceof Document&&i!==null){n.setData(i);n.updateWrapper()}var a=this._fixedHistory.findItemById(s);if(a instanceof Document&&i!==null){a.setData(i);a.updateWrapper()}}},{key:"processChangeBinding",value:function t(e){var i=BX.prop.getString(e,"OLD_ID",0);var s=BX.prop.getString(e,"NEW_ID",0);var n=this._history.findItemById(i);if(n instanceof Item$1){n._id=s;var a=n.getData();a.ID=s;n.setData(a)}var r=this._fixedHistory.findItemById(i);if(r instanceof Item$1){r._id=s;var o=r.getData();o.ID=s;r.setData(o)}}},{key:"processItemChangeFasten",value:function t(e){var i=BX.prop.getInteger(e,"ENTITY_ID",0);var s=BX.prop.getObject(e,"HISTORY_ITEM",null);window.setTimeout(BX.delegate((function(){var t=this._fixedHistory.findItemById(i);if(s["IS_FIXED"]==="N"&&t){t.onSuccessUnfasten()}else if(s["IS_FIXED"]==="Y"&&!t){var e=this._history.findItemById(i);if(e){e.onSuccessFasten()}else{var n=this._fixedHistory.createItem(this._data);n._isFixed=true;this._fixedHistory.addItem(n,0);n.layout()}}}),this),1200)}},{key:"processItemExternalUpdate",value:function t(e){var i=BX.prop.getInteger(e,"ENTITY_ID",0);var s=BX.prop.getObject(e,"HISTORY_ITEM",null);var n=this._history.findItemById(i);if(n&&s!==null){n.setData(s);n.markAsTerminated(this._history.checkItemForTermination(n));n.refreshLayout();if(n.isTerminated()){BX.addClass(n._wrapper,"crm-entity-stream-section-last")}}}},{key:"processWaitExternalAdd",value:function t(e){var i=BX.prop.getObject(e,"SCHEDULE_ITEM",null);if(i!==null){this.addScheduleItem(i)}}},{key:"processWaitExternalUpdate",value:function t(e){var i,s,n,a,r;i=BX.prop.getObject(e,"ENTITY",null);s=BX.prop.getObject(e,"SCHEDULE_ITEM",null);a=BX.prop.getObject(e,"HISTORY_ITEM",null);if(i){if(a&&!BX.type.isPlainObject(a["ASSOCIATED_ENTITY"])){a["ASSOCIATED_ENTITY"]=i}var o=BX.prop.getInteger(i,"ID",0);var l=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.wait,o);var c=0;var u=l.length;for(;c<u;c++){r=l[c];r.setAssociatedEntityData(i);r.refreshLayout()}}if(s!==null){n=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.wait,BX.prop.getInteger(s,"ASSOCIATED_ENTITY_ID"));if(!n){this.addScheduleItem(s)}else{n.setData(s);if(!n.isDone()){this._schedule.refreshItem(n)}else{if(a){this._schedule.transferItemToHistory(n,a);a=null}else{this._schedule.deleteItem(n)}}}}if(a!==null){r=this._history.findItemById(BX.prop.getString(a,"ID"));if(!r){r=this.addHistoryItem(a);Expand.create(r.getWrapper(),null).run()}else{r.setData(a);r.refreshLayout()}}}},{key:"processWaitExternalDelete",value:function t(e){var i=BX.prop.getInteger(e,"ENTITY_ID",0);var s=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.wait,i);var n=0;var a=s.length;for(;n<a;n++){this._history.deleteItem(s[n])}var r=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.wait,i);if(r){this._schedule.deleteItem(r)}}},{key:"processBizprocStatus",value:function t(e){var i,s;i=BX.prop.getObject(e,"HISTORY_ITEM",null);if(i!==null){s=this.addHistoryItem(i);Expand.create(s.getWrapper(),null).run()}}},{key:"processScoringExternalAdd",value:function t(e){var i,s;i=BX.prop.getObject(e,"HISTORY_ITEM",null);if(i!==null){s=this.addHistoryItem(i);Expand.create(s.getWrapper(),null).run()}}},{key:"onEntityProgressChange",value:function t(e,i){if(BX.prop.getInteger(i,"entityTypeId",0)!==this._ownerTypeId||BX.prop.getInteger(i,"entityId",0)!==this._ownerId){return}var s=BX.prop.getString(i,"semantics","");if(s===this._progressSemantics){return}this._progressSemantics=s;this._schedule.refreshLayout()}},{key:"getId",value:function t(){return this._id}},{key:"getSetting",value:function t(e,i){return this._settings.hasOwnProperty(e)?this._settings[e]:i}},{key:"getOwnerTypeId",value:function t(){return this._ownerTypeId}},{key:"getOwnerId",value:function t(){return this._ownerId}},{key:"getOwnerInfo",value:function t(){return this._ownerInfo}},{key:"isStubCounterEnabled",value:function t(){if(this._ownerId<=0){return false}return(this._ownerTypeId===BX.CrmEntityType.enumeration.deal||this._ownerTypeId===BX.CrmEntityType.enumeration.lead)&&this._progressSemantics==="process"}},{key:"getSchedule",value:function t(){return this._schedule}},{key:"getHistory",value:function t(){return this._history}},{key:"getFixedHistory",value:function t(){return this._fixedHistory}},{key:"getWaitEditor",value:function t(){return this._waitEditor}},{key:"getSmsEditor",value:function t(){return this._smsEditor}},{key:"processSheduleLayoutChange",value:function t(){}},{key:"processHistoryLayoutChange",value:function t(){this._schedule.refreshLayout()}},{key:"processEditingCompletion",value:function t(e){if(this._waitEditor&&e===this._waitEditor){this._waitEditor.setVisible(false);this._commentEditor.setVisible(true);this._menuBar.setActiveItemById("comment")}if(this._smsEditor&&e===this._smsEditor){this._smsEditor.setVisible(false);this._commentEditor.setVisible(true);this._menuBar.setActiveItemById("comment")}}},{key:"processEditingCancellation",value:function t(e){if(this._waitEditor&&e===this._waitEditor){this._waitEditor.setVisible(false);this._commentEditor.setVisible(true);this._menuBar.setActiveItemById("comment")}if(this._smsEditor&&e===this._smsEditor){this._smsEditor.setVisible(false);this._commentEditor.setVisible(true);this._menuBar.setActiveItemById("comment")}}},{key:"addScheduleItem",value:function t(e){var i=this._schedule.createItem(e);var s=this._schedule.calculateItemIndex(i);var n=this._schedule.createAnchor(s);this._schedule.addItem(i,s);i.layout({anchor:n});return i}},{key:"addHistoryItem",value:function t(e){var i=this._history.createItem(e);var s=this._history.calculateItemIndex(i);var n=this._history.createAnchor(s);this._history.addItem(i,s);i.layout({anchor:n});return i}},{key:"renderAudioDummy",value:function t(e,i){return BX.create("DIV",{attrs:{className:"crm-audio-cap-wrap-container"},children:[BX.create("DIV",{attrs:{className:"crm-audio-cap-wrap"},children:[BX.create("DIV",{attrs:{className:"crm-audio-cap-time"},text:e})],events:{click:i}})]})}},{key:"loadMediaPlayer",value:function t(e,i,s,n,a,r){if(!a){a=0}if(!r){r={}}var o=new BX.Fileman.Player(e,{sources:[{src:i,type:s}],isAudio:!r.video,skin:r.hasOwnProperty("skin")?r.skin:"vjs-timeline_player-skin",width:r.width||350,height:r.height||30,duration:a,playbackRate:r.playbackRate||null,onInit:function t(e){e.vjsPlayer.controlBar.removeChild("timeDivider");e.vjsPlayer.controlBar.removeChild("durationDisplay");e.vjsPlayer.controlBar.removeChild("fullscreenToggle");e.vjsPlayer.controlBar.addChild("timeDivider");e.vjsPlayer.controlBar.addChild("durationDisplay");if(!e.isPlaying()){e.play()}}});BX.cleanNode(n,false);n.appendChild(o.createElement());o.init();if(r.playbackRate>1){o.vjsPlayer.playbackRate(r.playbackRate)}return o}},{key:"onActivityCreated",value:function t(e,i){}},{key:"isSpotlightShowed",value:function t(){return this._spotlightFastenShowed}},{key:"setSpotlightShowed",value:function t(){this._spotlightFastenShowed=true}},{key:"getAudioPlaybackRateSelector",value:function t(){if(!this.audioPlaybackRateSelector){this.audioPlaybackRateSelector=new AudioPlaybackRateSelector({name:"timeline_audio_playback",currentRate:this._audioPlaybackRate,availableRates:[{rate:1,html:BX.Loc.getMessage("CRM_TIMELINE_PLAYBACK_RATE_SELECTOR_RATE_1").replace("#RATE#",'<span class="crm-audio-cap-speed-param">1x</span>')},{rate:1.5,html:BX.Loc.getMessage("CRM_TIMELINE_PLAYBACK_RATE_SELECTOR_RATE_1.5").replace("#RATE#",'<span class="crm-audio-cap-speed-param">1.5x</span>')},{rate:2,html:BX.Loc.getMessage("CRM_TIMELINE_PLAYBACK_RATE_SELECTOR_RATE_2").replace("#RATE#",'<span class="crm-audio-cap-speed-param">2x</span>')},{rate:3,html:BX.Loc.getMessage("CRM_TIMELINE_PLAYBACK_RATE_SELECTOR_RATE_3").replace("#RATE#",'<span class="crm-audio-cap-speed-param">3x</span>')}],textMessageCode:"CRM_TIMELINE_PLAYBACK_RATE_SELECTOR_TEXT"})}return this.audioPlaybackRateSelector}}],[{key:"create",value:function e(i,s){var n=new t;n.initialize(i,s);t.instances[n.getId()]=n;return n}}]);return t}();babelHelpers.defineProperty(Manager,"instances",{});var SmsWatcher={_pullTagName:"MESSAGESERVICE",_pullInited:false,_listeners:{},initPull:function t(){if(this._pullInited)return;BX.addCustomEvent("onPullEvent-messageservice",this.onPullEvent.bind(this));this.extendWatch();this._pullInited=true},subscribeOnMessageUpdate:function t(e,i){this.initPull();this._listeners[e]=i},fireExternalStatusUpdate:function t(e,i){var s=this._listeners[e];if(s){s(i)}},onPullEvent:function t(e,i){if(e==="message_update"){for(var s=0;s<i.messages.length;++s){var n=i.messages[s];this.fireExternalStatusUpdate(n["ID"],n)}}},extendWatch:function t(){if(BX.type.isFunction(BX.PULL)){BX.PULL.extendWatch(this._pullTagName);window.setTimeout(this.extendWatch.bind(this),6e4)}}};var SchedulePostpone=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t._button=null;t._clickHandler=BX.delegate(t.onClick,babelHelpers.assertThisInitialized(t));t._isMenuShown=false;t._menu=false;return t}babelHelpers.createClass(e,[{key:"doLayout",value:function t(){this._button=BX.create("DIV",{attrs:{className:this._isEnabled?"crm-entity-stream-planned-action-aside":"crm-entity-stream-planned-action-aside-disabled"},text:this.getMessage("postpone")});if(this._isEnabled){BX.bind(this._button,"click",this._clickHandler)}this._container.appendChild(this._button)}},{key:"openMenu",value:function t(){if(this._isMenuShown){return}var e=BX.delegate(this.onMenuItemClick,this);var i=[{id:"hour_1",text:this.getMessage("forOneHour"),onclick:e},{id:"hour_2",text:this.getMessage("forTwoHours"),onclick:e},{id:"hour_3",text:this.getMessage("forThreeHours"),onclick:e},{id:"day_1",text:this.getMessage("forOneDay"),onclick:e},{id:"day_2",text:this.getMessage("forTwoDays"),onclick:e},{id:"day_3",text:this.getMessage("forThreeDays"),onclick:e}];BX.PopupMenu.show(this._id,this._button,i,{offsetTop:0,offsetLeft:16,events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this),onPopupDestroy:BX.delegate(this.onMenuDestroy,this)}});this._menu=BX.PopupMenu.currentItem}},{key:"closeMenu",value:function t(){if(!this._isMenuShown){return}if(this._menu){this._menu.close()}}},{key:"onClick",value:function t(){if(!this._isEnabled){return}if(this._isMenuShown){this.closeMenu()}else{this.openMenu()}}},{key:"onMenuItemClick",value:function t(e,i){this.closeMenu();var s=0;if(i.id==="hour_1"){s=3600}else if(i.id==="hour_2"){s=7200}else if(i.id==="hour_3"){s=10800}else if(i.id==="day_1"){s=86400}else if(i.id==="day_2"){s=172800}else if(i.id==="day_3"){s=259200}if(s>0&&this._item){this._item.postpone(s)}}},{key:"onMenuShow",value:function t(){this._isMenuShown=true}},{key:"onMenuClose",value:function t(){if(this._menu&&this._menu.popupWindow){this._menu.popupWindow.destroy()}}},{key:"onMenuDestroy",value:function t(){this._isMenuShown=false;this._menu=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}}},{key:"getMessage",value:function t(i){var s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}(Activity);babelHelpers.defineProperty(SchedulePostpone,"messages",{});var Comment$2=function(){function t(){babelHelpers.classCallCheck(this,t);this._node=null;this._anchor=null;this._nodeParent=null;this._startPosition=null;this._events=null}babelHelpers.createClass(t,[{key:"initialize",value:function t(e,i,s,n){this._node=e;this._anchor=i;this._nodeParent=e.parentNode;this._startPosition=s;this._events=BX.type.isPlainObject(n)?n:{}}},{key:"run",value:function t(){BX.addClass(this._node,"crm-entity-stream-section-animate-start");this._node.style.position="absolute";this._node.style.width=this._startPosition.width+"px";this._node.style.height=this._startPosition.height+"px";this._node.style.top=this._startPosition.top-30+"px";this._node.style.left=this._startPosition.left+"px";this._node.style.opacity=0;this._node.style.zIndex=960;document.body.appendChild(this._node);var e=new BX.easing({duration:350,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(t){this._node.style.opacity=t.opacity/100}),this),complete:BX.proxy((function(){if(BX.type.isFunction(this._events["start"])){this._events["start"]()}var t=Shift.create(this._node,this._anchor,this._startPosition,false,{complete:BX.delegate(this.finish,this)});t.run()}),this)});e.animate();if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}}},{key:"finish",value:function t(){this._node.style.position="";this._node.style.width="";this._node.style.height="";this._node.style.top="";this._node.style.left="";this._node.style.opacity="";this._node.style.zIndex="";this._anchor.style.height="";this._anchor.parentNode.insertBefore(this._node,this._anchor.nextSibling);setTimeout(BX.delegate((function(){BX.removeClass(this._node,"crm-entity-stream-section-animate-start");BX.remove(this._anchor)}),this),0)}}],[{key:"create",value:function e(i,s,n,a){var r=new t;r.initialize(i,s,n,a);return r}}]);return t}();var Streams={History:History$1,FixedHistory:FixedHistory,EntityChat:EntityChat,Schedule:Schedule};var Editors={Comment:Comment,Wait:Wait,Rest:Rest,Sms:Sms};var Tools={WaitConfigurationDialog:WaitConfigurationDialog,SchedulePostponeController:SchedulePostponeController,MenuBar:MenuBar,SmsWatcher:SmsWatcher,AudioPlaybackRateSelector:AudioPlaybackRateSelector};var Actions={Activity:Activity,Call:Call$1,HistoryCall:HistoryCall,ScheduleCall:ScheduleCall,Email:Email,HistoryEmail:HistoryEmail,ScheduleEmail:ScheduleEmail,OpenLine:OpenLine,SchedulePostpone:SchedulePostpone};var ScheduledItems={Activity:Activity$1,Email:Email$1,Call:Call,CallTracker:CallTracker,Meeting:Meeting,Task:Task,StoreDocument:StoreDocument,WebForm:WebForm,Wait:Wait$1,Request:Request,Rest:Rest$1,OpenLine:OpenLine$1,Zoom:Zoom};var Items={History:History,HistoryActivity:HistoryActivity,Comment:Comment$1,Modification:Modification,Mark:Mark$1,Creation:Creation,Restoration:Restoration,Relation:Relation,Link:Link,Unlink:Unlink,Email:Email$2,Call:Call$2,Meeting:Meeting$1,Task:Task$1,WebForm:WebForm$1,Wait:Wait$2,Document:Document,Sender:Sender,Bizproc:Bizproc,Sms:Sms$1,Request:Request$1,Rest:Rest$2,OpenLine:OpenLine$2,Zoom:Zoom$1,Conversion:Conversion,Visit:Visit,Scoring:Scoring,OrderCreation:OrderCreation,OrderModification:OrderModification,StoreDocumentCreation:StoreDocumentCreation,StoreDocumentModification:StoreDocumentModification,FinalSummaryDocuments:FinalSummaryDocuments,FinalSummary:FinalSummary,ExternalNoticeModification:ExternalNoticeModification,ExternalNoticeStatusModification:ExternalNoticeStatusModification,OrderCheck:OrderCheck,ScheduledBase:Scheduled,Scheduled:ScheduledItems};var Animations={Item:Item$2,ItemNew:ItemNew,Expand:Expand,Shift:Shift,Comment:Comment$2,Fasten:Fasten};exports.EncourageBuyProducts=component;exports.Notification=component$1;exports.DeliveryActivity=component$2;exports.DeliveryMessage=component$3;exports.DeliveryCalculation=component$4;exports.Manager=Manager;exports.Stream=Steam;exports.Streams=Streams;exports.Editor=Editor;exports.Editors=Editors;exports.Tools=Tools;exports.Types=types;exports.Action=Action;exports.Actions=Actions;exports.Item=Item$1;exports.Items=Items;exports.Animations=Animations})(this.BX.Crm.Timeline=this.BX.Crm.Timeline||{},BX.Event,BX,BX,BX,BX,BX);
//# sourceMappingURL=timeline.bundle.map.js