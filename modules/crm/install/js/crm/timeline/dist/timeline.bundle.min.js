this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(exports,crm_activity_todoEditor,main_core_events,crm_datetime,crm_timeline_tools,crm_timeline_item,main_core){"use strict";let Editor=function(){function e(){babelHelpers.classCallCheck(this,e);this._id="";this._settings={};this._manager=null;this._ownerTypeId=0;this._ownerId=0;this._container=null;this._input=null;this._saveButton=null;this._cancelButton=null;this._ghostInput=null;this._saveButtonHandler=BX.delegate(this.onSaveButtonClick,this);this._cancelButtonHandler=BX.delegate(this.onCancelButtonClick,this);this._focusHandler=BX.delegate(this.onFocus,this);this._blurHandler=BX.delegate(this.onBlur,this);this._keyupHandler=BX.delegate(this.resizeForm,this);this._delayedKeyupHandler=BX.delegate((function(){setTimeout(this.resizeForm.bind(this),0)}),this);this._isVisible=true;this._hideButtonsOnBlur=true}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._manager=this.getSetting("manager");if(!(this._manager instanceof Manager)){throw"Editor. Manager instance is not found."}this._ownerTypeId=this.getSetting("ownerTypeId",0);this._ownerId=this.getSetting("ownerId",0);this._container=BX(this.getSetting("container"));this._input=BX(this.getSetting("input"));this._saveButton=BX(this.getSetting("button"));this._cancelButton=BX(this.getSetting("cancelButton"));BX.bind(this._saveButton,"click",this._saveButtonHandler);if(this._cancelButton){BX.bind(this._cancelButton,"click",this._cancelButtonHandler)}this.bindInputHandlers();this.doInitialize()}},{key:"doInitialize",value:function e(){}},{key:"bindInputHandlers",value:function e(){BX.bind(this._input,"focus",this._focusHandler);BX.bind(this._input,"blur",this._blurHandler);BX.bind(this._input,"keyup",this._keyupHandler);BX.bind(this._input,"cut",this._delayedKeyupHandler);BX.bind(this._input,"paste",this._delayedKeyupHandler)}},{key:"getId",value:function e(){return this._id}},{key:"getSetting",value:function e(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i}},{key:"setVisible",value:function e(t){t=!!t;if(this._isVisible===t){return}this._isVisible=t;if(this._container){this._container.style.display=t?"":"none"}}},{key:"isVisible",value:function e(){return this._isVisible}},{key:"onFocus",value:function e(t){BX.addClass(this._container,"focus")}},{key:"onBlur",value:function e(t){if(!this._hideButtonsOnBlur){return}if(this._input.value===""){window.setTimeout(BX.delegate((function(){BX.removeClass(this._container,"focus");this._input.style.minHeight=""}),this),200)}}},{key:"onSaveButtonClick",value:function e(t){main_core.Dom.addClass(this._saveButton,"ui-btn-wait");const i=()=>main_core.Dom.removeClass(this._saveButton,"ui-btn-wait");const s=this.save();if(s instanceof BX.Promise||s instanceof Promise){s.then((()=>i()),(()=>i()))}else{i()}}},{key:"onCancelButtonClick",value:function e(){this.cancel();this._manager.processEditingCancellation(this)}},{key:"save",value:function e(){}},{key:"cancel",value:function e(){}},{key:"release",value:function e(){if(this._ghostInput){this._ghostInput=BX.remove(this._ghostInput)}}},{key:"ensureGhostCreated",value:function e(){if(this._ghostInput){return this._ghostInput}this._ghostInput=BX.create("div",{props:{className:"crm-entity-stream-content-new-comment-textarea-shadow"},text:this._input.value});this._ghostInput.style.width=this._input.offsetWidth+"px";document.body.appendChild(this._ghostInput);return this._ghostInput}},{key:"resizeForm",value:function e(){const t=this.ensureGhostCreated();const i=getComputedStyle(this._input);const s=parseInt(i.paddingBottom)+parseInt(i.paddingTop)+parseInt(i.borderTopWidth)+parseInt(i.borderBottomWidth)||0;t.innerHTML=BX.util.htmlspecialchars(this._input.value.replace(/[\r\n]{1}/g,"<br>"));this._input.style.minHeight=t.scrollHeight+s+"px"}}]);return e}();let WaitConfigurationDialog=function(){function e(){babelHelpers.classCallCheck(this,e);this._id="";this._settings={};this._type=Wait.WaitingType.undefined;this._duration=0;this._target="";this._targetDates=null;this._container=null;this._durationMeasureNode=null;this._durationInput=null;this._targetDateNode=null;this._popup=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._type=BX.prop.getInteger(this._settings,"type",Wait.WaitingType.after);this._duration=BX.prop.getInteger(this._settings,"duration",1);this._target=BX.prop.getString(this._settings,"target","");this._targetDates=BX.prop.getArray(this._settings,"targetDates",[]);this._menuId=this._id+"_target_date_sel"}},{key:"getId",value:function e(){return this._id}},{key:"getType",value:function e(){return this._type}},{key:"setType",value:function e(t){this._type=t}},{key:"getDuration",value:function e(){return this._duration}},{key:"setDuration",value:function e(t){this._duration=t}},{key:"getTarget",value:function e(){return this._target}},{key:"setTarget",value:function e(t){this._target=t}},{key:"getMessage",value:function t(i){const s=e.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"getDurationText",value:function e(t,i){return Wait.Helper.getDurationText(t,i)}},{key:"getTargetDateCaption",value:function e(t){const i=this._targetDates.length;for(let e=0;e<i;e++){const i=this._targetDates[e];if(i["name"]===t){return i["caption"]}}return""}},{key:"open",value:function e(){this._popup=new BX.PopupWindow(this._id,null,{autoHide:true,draggable:false,bindOptions:{forceBindPosition:false},closeByEsc:true,zIndex:0,content:this.prepareDialogContent(),events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},buttons:[new BX.PopupWindowButton({text:this.getMessage("select"),className:"popup-window-button-accept",events:{click:BX.delegate(this.onSaveButtonClick,this)}}),new BX.PopupWindowButtonLink({text:BX.message("JS_CORE_WINDOW_CANCEL"),events:{click:BX.delegate(this.onCancelButtonClick,this)}})]});this._popup.show()}},{key:"close",value:function e(){if(this._popup){this._popup.close()}}},{key:"prepareDialogContent",value:function e(){const t=BX.create("div",{attrs:{className:"crm-wait-popup-select-block"}});const i=BX.create("div",{attrs:{className:"crm-wait-popup-select-wrapper"}});t.appendChild(i);this._durationInput=BX.create("input",{attrs:{type:"text",className:"crm-wait-popup-settings-input",value:this._duration},events:{keyup:BX.delegate(this.onDurationChange,this)}});this._durationMeasureNode=BX.create("span",{attrs:{className:"crm-wait-popup-settings-title"},text:this.getDurationText(this._duration,false)});if(this._type===Wait.WaitingType.after){i.appendChild(BX.create("span",{attrs:{className:"crm-wait-popup-settings-title"},text:this.getMessage("prefixTypeAfter")}));i.appendChild(this._durationInput);i.appendChild(this._durationMeasureNode)}else{i.appendChild(BX.create("span",{attrs:{className:"crm-wait-popup-settings-title"},text:this.getMessage("prefixTypeBefore")}));i.appendChild(this._durationInput);i.appendChild(this._durationMeasureNode);i.appendChild(BX.create("span",{attrs:{className:"crm-wait-popup-settings-title"},text:" "+this.getMessage("targetPrefixTypeBefore")}));this._targetDateNode=BX.create("span",{attrs:{className:"crm-automation-popup-settings-link"},text:this.getTargetDateCaption(this._target),events:{click:BX.delegate(this.toggleTargetMenu,this)}});i.appendChild(this._targetDateNode)}return t}},{key:"onDurationChange",value:function e(){let t=parseInt(this._durationInput.value);if(isNaN(t)||t<=0){t=1}this._duration=t;this._durationMeasureNode.innerHTML=BX.util.htmlspecialchars(this.getDurationText(t,false))}},{key:"toggleTargetMenu",value:function e(){if(this.isTargetMenuOpened()){this.closeTargetMenu()}else{this.openTargetMenu()}}},{key:"isTargetMenuOpened",value:function e(){return!!BX.PopupMenu.getMenuById(this._menuId)}},{key:"openTargetMenu",value:function e(){const t=[];let i=0;const s=this._targetDates.length;for(;i<s;i++){const e=this._targetDates[i];t.push({text:e["caption"],title:e["caption"],value:e["name"],onclick:BX.delegate(this.onTargetSelect,this)})}BX.PopupMenu.show(this._menuId,this._targetDateNode,t,{zIndex:200,autoHide:true,offsetLeft:BX.pos(this._targetDateNode)["width"]/2,angle:{position:"top",offset:0}})}},{key:"closeTargetMenu",value:function e(){BX.PopupMenu.destroy(this._menuId)}},{key:"onPopupShow",value:function e(t,i){}},{key:"onPopupClose",value:function e(){if(this._popup){this._popup.destroy()}this.closeTargetMenu()}},{key:"onPopupDestroy",value:function e(){if(this._popup){this._popup=null}}},{key:"onSaveButtonClick",value:function e(t){const i=BX.prop.getFunction(this._settings,"onSave",null);if(!i){return}const s={type:this._type};s["duration"]=this._duration;s["target"]=this._type===Wait.WaitingType.before?this._target:"";i(this,s)}},{key:"onCancelButtonClick",value:function e(t){const i=BX.prop.getFunction(this._settings,"onCancel",null);if(i){i(this)}}},{key:"onTargetSelect",value:function e(t,i){const s=BX.prop.getString(i,"value","");if(s!==""){this._target=s;this._targetDateNode.innerHTML=BX.util.htmlspecialchars(this.getTargetDateCaption(s))}this.closeTargetMenu();t.preventDefault?t.preventDefault():t.returnValue=false}}],[{key:"create",value:function t(i,s){const n=new e;n.initialize(i,s);return n}}]);return e}();babelHelpers.defineProperty(WaitConfigurationDialog,"messages",{});let Wait=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._serviceUrl="";e._isRequestRunning=false;e._isLocked=false;e._hideButtonsOnBlur=false;e._type=t.WaitingType.after;e._duration=1;e._target="";e._configContainer=null;e._configSelector=null;e._isMenuShown=false;e._menu=null;e._configDialog=null;return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){this._configContainer=BX(this.getSetting("configContainer"));this._serviceUrl=this.getSetting("serviceUrl","");const i=BX.prop.getObject(this._settings,"config",{});this._type=t.WaitingType.resolveTypeId(BX.prop.getString(i,"type",t.WaitingType.names.after));this._duration=BX.prop.getInteger(i,"duration",1);this._target=BX.prop.getString(i,"target","");this._targetDates=BX.prop.getArray(this._settings,"targetDates",[]);this.layoutConfigurationSummary()}},{key:"getDurationText",value:function e(i,s){return t.Helper.getDurationText(i,s)}},{key:"getTargetDateCaption",value:function e(t){let i=0;const s=this._targetDates.length;for(;i<s;i++){const e=this._targetDates[i];if(e["name"]===t){return e["caption"]}}return""}},{key:"onSelectorClick",value:function e(t){if(!this._isMenuShown){this.openMenu()}else{this.closeMenu()}t.preventDefault?t.preventDefault():t.returnValue=false}},{key:"openMenu",value:function e(){if(this._isMenuShown){return}const t=BX.delegate(this.onMenuItemClick,this);const i=[{id:"day_1",text:this.getMessage("oneDay"),onclick:t},{id:"day_2",text:this.getMessage("twoDays"),onclick:t},{id:"day_3",text:this.getMessage("threeDays"),onclick:t},{id:"week_1",text:this.getMessage("oneWeek"),onclick:t},{id:"week_2",text:this.getMessage("twoWeek"),onclick:t},{id:"week_3",text:this.getMessage("threeWeeks"),onclick:t}];const s={id:"custom",text:this.getMessage("custom"),items:[]};s["items"].push({id:"afterDays",text:this.getMessage("afterDays"),onclick:t});if(this._targetDates.length>0){s["items"].push({id:"beforeDate",text:this.getMessage("beforeDate"),onclick:t})}i.push(s);BX.PopupMenu.show(this._id,this._configSelector,i,{offsetTop:0,offsetLeft:36,angle:{position:"top",offset:0},events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this),onPopupDestroy:BX.delegate(this.onMenuDestroy,this)}});this._menu=BX.PopupMenu.currentItem}},{key:"closeMenu",value:function e(){if(!this._isMenuShown){return}if(this._menu){this._menu.close()}}},{key:"onMenuItemClick",value:function e(i,s){this.closeMenu();if(s.id==="afterDays"||s.id==="beforeDate"){this.openConfigDialog(s.id==="afterDays"?t.WaitingType.after:t.WaitingType.before);return}const n={type:t.WaitingType.after};if(s.id==="day_1"){n["duration"]=1}else if(s.id==="day_2"){n["duration"]=2}else if(s.id==="day_3"){n["duration"]=3}if(s.id==="week_1"){n["duration"]=7}else if(s.id==="week_2"){n["duration"]=14}else if(s.id==="week_3"){n["duration"]=21}this.saveConfiguration(n)}},{key:"openConfigDialog",value:function e(t){if(!this._configDialog){this._configDialog=WaitConfigurationDialog.create("",{targetDates:this._targetDates,onSave:BX.delegate(this.onConfigDialogSave,this),onCancel:BX.delegate(this.onConfigDialogCancel,this)})}this._configDialog.setType(t);this._configDialog.setDuration(this._duration);let i=this._target;if(i===""&&this._targetDates.length>0){i=this._targetDates[0]["name"]}this._configDialog.setTarget(i);this._configDialog.open()}},{key:"onConfigDialogSave",value:function e(t,i){this.saveConfiguration(i);this._configDialog.close()}},{key:"onConfigDialogCancel",value:function e(t){this._configDialog.close()}},{key:"onMenuShow",value:function e(){this._isMenuShown=true}},{key:"onMenuClose",value:function e(){if(this._menu&&this._menu.popupWindow){this._menu.popupWindow.destroy()}}},{key:"onMenuDestroy",value:function e(){this._isMenuShown=false;this._menu=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}}},{key:"saveConfiguration",value:function e(i){this._type=BX.prop.getInteger(i,"type",t.WaitingType.after);this._duration=BX.prop.getInteger(i,"duration",0);if(this._duration<=0){this._duration=1}this._target=this._type===t.WaitingType.before?BX.prop.getString(i,"target",""):"";const s=this._manager.getId().toLowerCase();BX.userOptions.save("crm.timeline.wait",s,"type",this._type===t.WaitingType.after?"after":"before");BX.userOptions.save("crm.timeline.wait",s,"duration",this._duration);BX.userOptions.save("crm.timeline.wait",s,"target",this._target);this.layoutConfigurationSummary()}},{key:"getSummaryHtml",value:function e(){if(this._type===t.WaitingType.before){return this.getMessage("completionTypeBefore").replace("#DURATION#",this.getDurationText(this._duration,true)).replace("#TARGET_DATE#",this.getTargetDateCaption(this._target))}return this.getMessage("completionTypeAfter").replace("#DURATION#",this.getDurationText(this._duration,true))}},{key:"getSummaryText",value:function e(){return BX.util.strip_tags(this.getSummaryHtml())}},{key:"layoutConfigurationSummary",value:function e(){this._configContainer.innerHTML=this.getSummaryHtml();this._configSelector=this._configContainer.querySelector("a");if(this._configSelector){BX.bind(this._configSelector,"click",BX.delegate(this.onSelectorClick,this))}}},{key:"postpone",value:function e(t,i,s){BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"POSTPONE_WAIT",DATA:{ID:t,OFFSET:i}},onsuccess:s})}},{key:"complete",value:function e(t,i,s){BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"COMPLETE_WAIT",DATA:{ID:t,COMPLETED:i?"Y":"N"}},onsuccess:s})}},{key:"save",value:function e(){if(this._isRequestRunning||this._isLocked){return}let t=this.getSummaryText();const i=BX.util.trim(this._input.value);if(i!==""){t+="\n"+i}const s={ID:0,typeId:this._type,duration:this._duration,targetFieldName:this._target,subject:"",description:t,completed:0,ownerType:BX.CrmEntityType.resolveName(this._ownerTypeId),ownerID:this._ownerId};BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"SAVE_WAIT",DATA:s},onsuccess:BX.delegate(this.onSaveSuccess,this),onfailure:BX.delegate(this.onSaveFailure,this)});this._isRequestRunning=this._isLocked=true}},{key:"cancel",value:function e(){this._input.value="";this._input.style.minHeight="";this.release()}},{key:"onSaveSuccess",value:function e(t){this._isRequestRunning=this._isLocked=false;const i=BX.prop.getString(t,"ERROR","");if(i!==""){alert(i);return}this._input.value="";this._input.style.minHeight="";this._manager.processEditingCompletion(this);this.release()}},{key:"onSaveFailure",value:function e(){this._isRequestRunning=this._isLocked=false}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);this.items[n.getId()]=n;return n}}]);return t}(Editor);babelHelpers.defineProperty(Wait,"WaitingType",{undefined:0,after:1,before:2,names:{after:"after",before:"before"},resolveTypeId:function(e){if(e===this.names.after){return this.after}else if(e===this.names.before){return this.before}return this.undefined}});babelHelpers.defineProperty(Wait,"messages",{});babelHelpers.defineProperty(Wait,"items",{});babelHelpers.defineProperty(Wait,"Helper",{getDurationText:function(e,t){t=!!t;let i="";let s="D";if(t){if(e%7===0){e=e/7;s="W"}}if(s==="W"){i=BX.Loc.getMessagePlural("CRM_TIMELINE_WAIT_WEEK",e)}else{i=BX.Loc.getMessagePlural("CRM_TIMELINE_WAIT_DAY",e)}if(t){i=e.toString()+" "+i}return i},getMessage:function(e){return Wait.Helper.messages.hasOwnProperty(e)?Wait.Helper.messages[e]:e},messages:{}});let Sms=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._history=null;e._serviceUrl="";e._isRequestRunning=false;e._isLocked=false;e._senderId=null;e._from=null;e._commEntityTypeId=null;e._commEntityId=null;e._to=null;e._canUse=null;e._canSendMessage=null;e._manageUrl="";e._senders=[];e._fromList=[];e._toList=[];e._defaults={};e._communications=[];e._menu=null;e._isMenuShown=false;e._shownMenuId=null;e._documentSelector=null;e._source=null;e._paymentId=null;e._shipmentId=null;e._compilationProductIds=[];e._templateId=null;e._templatesContainer=null;e._templateFieldHintNode=null;e._templateSelectorNode=null;e._templateTemplateTitleNode=null;e._templatePreviewNode=null;e._templateSelectorMenuId="CrmTimelineSmsEditorTemplateSelector";e._templateFieldHintHandler=BX.delegate(e.onTemplateHintIconClick,babelHelpers.assertThisInitialized(e));e._templateSeletorClickHandler=BX.delegate(e.onTemplateSelectClick,babelHelpers.assertThisInitialized(e));e._selectTemplateHandler=BX.delegate(e.onSelectTemplate,babelHelpers.assertThisInitialized(e));return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){this._serviceUrl=BX.util.remove_url_param(this.getSetting("serviceUrl",""),["sessid","site"]);const t=BX.prop.getObject(this._settings,"config",{});this._canUse=BX.prop.getBoolean(t,"canUse",false);this._canSendMessage=BX.prop.getBoolean(t,"canSendMessage",false);this._manageUrl=BX.prop.getString(t,"manageUrl","");this._senders=BX.prop.getArray(t,"senders",[]);this._defaults=BX.prop.getObject(t,"defaults",{senderId:null,from:null});this._communications=BX.prop.getArray(t,"communications",[]);this._isSalescenterEnabled=BX.prop.getBoolean(t,"isSalescenterEnabled",false);this._isDocumentsEnabled=BX.prop.getBoolean(t,"isDocumentsEnabled",false);if(this._isDocumentsEnabled){this._documentsProvider=BX.prop.getString(t,"documentsProvider","");this._documentsValue=BX.prop.getString(t,"documentsValue","")}this._isFilesEnabled=BX.prop.getBoolean(t,"isFilesEnabled",false);if(this._isFilesEnabled){this._diskUrls=BX.prop.getObject(t,"diskUrls");this._isFilesExternalLinkEnabled=BX.prop.getBoolean(t,"isFilesExternalLinkEnabled",true)}this._senderSelectorNode=this._container.querySelector('[data-role="sender-selector"]');this._fromContainerNode=this._container.querySelector('[data-role="from-container"]');this._fromSelectorNode=this._container.querySelector('[data-role="from-selector"]');this._clientContainerNode=this._container.querySelector('[data-role="client-container"]');this._clientSelectorNode=this._container.querySelector('[data-role="client-selector"]');this._toSelectorNode=this._container.querySelector('[data-role="to-selector"]');this._messageLengthCounterWrapperNode=this._container.querySelector('[data-role="message-length-counter-wrap"]');this._messageLengthCounterNode=this._container.querySelector('[data-role="message-length-counter"]');this._salescenterStarter=this._container.querySelector('[data-role="salescenter-starter"]');this._smsDetailSwitcher=this._container.querySelector('[data-role="sms-detail-switcher"]');this._smsDetail=this._container.querySelector('[data-role="sms-detail"]');this._documentSelectorButton=this._container.querySelector('[data-role="sms-document-selector"]');this._fileSelectorButton=this._container.querySelector('[data-role="sms-file-selector"]');this._fileUploadZone=this._container.querySelector('[data-role="sms-file-upload-zone"]');this._fileUploadLabel=this._container.querySelector('[data-role="sms-file-upload-label"]');this._fileSelectorBitrix=this._container.querySelector('[data-role="sms-file-selector-bitrix"]');this._fileExternalLinkDisabledContent=this._container.querySelector('[data-role="sms-file-external-link-disabled"]');this._templatesContainer=BX(this.getSetting("templatesContainer"));if(this._templatesContainer){this._templateFieldHintNode=this._templatesContainer.querySelector('[data-role="hint"]');this._templateSelectorNode=this._templatesContainer.querySelector('[data-role="template-selector"]');this._templateTemplateTitleNode=this._templatesContainer.querySelector('[data-role="template-title"]');this._templatePreviewNode=this._templatesContainer.querySelector('[data-role="preview"]')}if(this._templateFieldHintNode){BX.bind(this._templateFieldHintNode,"click",this._templateFieldHintHandler)}if(this._templateSelectorNode){BX.bind(this._templateSelectorNode,"click",this._templateSeletorClickHandler)}if(this._canUse&&this._senders.length>0){this.initSenderSelector()}if(this._canUse&&this._canSendMessage){this.initDetailSwitcher();this.initFromSelector();this.initClientContainer();this.initClientSelector();this.initToSelector();this.initMessageLengthCounter();this.setMessageLengthCounter();if(this._isDocumentsEnabled){this.initDocumentSelector()}if(this._isFilesEnabled){this.initFileSelector()}}if(this._isSalescenterEnabled){this.initSalescenterApplication()}}},{key:"initDetailSwitcher",value:function e(){BX.bind(this._smsDetailSwitcher,"click",function(){if(this._smsDetail.classList.contains("hidden")){this._smsDetail.classList.remove("hidden");this._smsDetailSwitcher.innerText=BX.message("CRM_TIMELINE_COLLAPSE")}else{this._smsDetail.classList.add("hidden");this._smsDetailSwitcher.innerText=BX.message("CRM_TIMELINE_DETAILS")}}.bind(this))}},{key:"initSenderSelector",value:function e(){const t=this._defaults.senderId;let i=this._senders[0].canUse?this._senders[0]:null;let s=null;const n=[];const a=this.onSenderSelectorClick.bind(this);for(let e=0;e<this._senders.length;++e){if(this._senders[e].canUse&&this._senders[e].fromList.length&&(this._senders[e].id===t||!i)){i=this._senders[e]}if(this._senders[e].id==="rest"){s=this._senders[e];continue}n.push({text:this._senders[e].name,sender:this._senders[e],onclick:a,className:!this._senders[e].canUse||!this._senders[e].fromList.length?"crm-timeline-popup-menu-item-disabled menu-popup-no-icon":""})}if(s){if(s.fromList.length>0){n.push({delimiter:true});for(let e=0;e<s.fromList.length;++e){n.push({text:s.fromList[e].name,sender:s,from:s.fromList[e],onclick:a})}}n.push({delimiter:true},{text:BX.message("CRM_TIMELINE_SMS_REST_MARKETPLACE"),href:"/marketplace/category/crm_robot_sms/",target:"_blank"})}if(i){this.setSender(i)}BX.bind(this._senderSelectorNode,"click",this.openMenu.bind(this,"sender",this._senderSelectorNode,n))}},{key:"onSenderSelectorClick",value:function e(t,i){if(i.sender){if(!i.sender.canUse||!i.sender.fromList.length){const e=BX.Uri.addParam(i.sender.manageUrl,{IFRAME:"Y"});const t=BX.SidePanel.Instance.getTopSlider();const s={events:{onClose:function(){if(t){t.reload()}},onCloseComplete:function(){if(!t){document.location.reload()}}}};if(i.sender.id==="ednaru"){s.width=700}BX.SidePanel.Instance.open(e,s);return}this.setSender(i.sender,true);const e=i.from?i.from:i.sender.fromList[0];this.setFrom(e,true)}this._menu.close()}},{key:"setSender",value:function e(t,i){this._senderId=t.id;this._fromList=t.fromList;this._senderSelectorNode.textContent=t.shortName?t.shortName:t.name;this._templateId=null;if(t.isTemplatesBased){this.showNode(this._templatesContainer);this.hideNode(this._messageLengthCounterWrapperNode);this.hideNode(this._fileSelectorButton);this.hideNode(this._documentSelectorButton);this.hideNode(this._input);this.toggleTemplateSelectAvailability();this.toggleSaveButton();this._hideButtonsOnBlur=false;this.onFocus()}else{this.hideNode(this._templatesContainer);this.showNode(this._messageLengthCounterWrapperNode);this.showNode(this._fileSelectorButton);this.showNode(this._documentSelectorButton);this.showNode(this._input);this.setMessageLengthCounter();this._hideButtonsOnBlur=true}const s=t.id==="rest"?"hide":"show";BX[s](this._fromContainerNode);if(i){BX.userOptions.save("crm","sms_manager_editor","senderId",this._senderId)}}},{key:"showNode",value:function e(t){if(t){t.style.display=""}}},{key:"hideNode",value:function e(t){if(t){t.style.display="none"}}},{key:"initFromSelector",value:function e(){if(this._fromList.length>0){const e=this._defaults.from||this._fromList[0].id;let t=null;for(let i=0;i<this._fromList.length;++i){if(this._fromList[i].id===e||!t){t=this._fromList[i]}}if(t){this.setFrom(t)}}BX.bind(this._fromSelectorNode,"click",this.onFromSelectorClick.bind(this))}},{key:"onFromSelectorClick",value:function e(t){const i=[];const s=this.onFromSelectorItemClick.bind(this);for(let e=0;e<this._fromList.length;++e){i.push({text:this._fromList[e].name,from:this._fromList[e],onclick:s})}this.openMenu("from_"+this._senderId,this._fromSelectorNode,i,t)}},{key:"onFromSelectorItemClick",value:function e(t,i){if(i.from){this.setFrom(i.from,true)}this._menu.close()}},{key:"setFrom",value:function e(t,i){this._from=t.id;if(this._senderId==="rest"){this._senderSelectorNode.textContent=t.name}else{this._fromSelectorNode.textContent=t.name}if(i){BX.userOptions.save("crm","sms_manager_editor","from",this._from)}}},{key:"initClientContainer",value:function e(){if(this._communications.length===0){BX.hide(this._clientContainerNode)}}},{key:"initClientSelector",value:function e(){const t=[];const i=this.onClientSelectorClick.bind(this);for(let e=0;e<this._communications.length;++e){t.push({text:this._communications[e].caption,client:this._communications[e],onclick:i});if(e===0){this.setClient(this._communications[e])}}BX.bind(this._clientSelectorNode,"click",this.openMenu.bind(this,"comm",this._clientSelectorNode,t))}},{key:"onClientSelectorClick",value:function e(t,i){if(i.client){this.setClient(i.client)}this._menu.close()}},{key:"setClient",value:function e(t){this._commEntityTypeId=t.entityTypeId;this._commEntityId=t.entityId;this._clientSelectorNode.textContent=t.caption;this._toList=t.phones;this.setTo(t.phones[0])}},{key:"initToSelector",value:function e(){BX.bind(this._toSelectorNode,"click",this.onToSelectorClick.bind(this))}},{key:"onToSelectorClick",value:function e(t){const i=[];const s=this.onToSelectorItemClick.bind(this);for(let e=0;e<this._toList.length;++e){i.push({text:this._toList[e].valueFormatted||this._toList[e].value,to:this._toList[e],onclick:s})}this.openMenu("to_"+this._commEntityTypeId+"_"+this._commEntityId,this._toSelectorNode,i,t)}},{key:"onToSelectorItemClick",value:function e(t,i){if(i.to){this.setTo(i.to)}this._menu.close()}},{key:"setTo",value:function e(t){this._to=t.value;this._toSelectorNode.textContent=t.valueFormatted||t.value}},{key:"openMenu",value:function e(t,i,s,n){if(this._shownMenuId===t){return}if(this._shownMenuId!==null&&this._menu){this._menu.close();this._shownMenuId=null}BX.PopupMenu.show(this._id+t,i,s,{offsetTop:0,offsetLeft:36,angle:{position:"top",offset:0},events:{onPopupClose:BX.delegate(this.onMenuClose,this)}});this._menu=BX.PopupMenu.currentItem;n.preventDefault()}},{key:"onMenuClose",value:function e(){this._shownMenuId=null;this._menu=null}},{key:"initMessageLengthCounter",value:function e(){this._messageLengthMax=parseInt(this._messageLengthCounterNode.getAttribute("data-length-max"));BX.bind(this._input,"keyup",this.setMessageLengthCounter.bind(this));BX.bind(this._input,"cut",this.setMessageLengthCounterDelayed.bind(this));BX.bind(this._input,"paste",this.setMessageLengthCounterDelayed.bind(this))}},{key:"setMessageLengthCounterDelayed",value:function e(){setTimeout(this.setMessageLengthCounter.bind(this),0)}},{key:"setMessageLengthCounter",value:function e(){const t=this._input.value.length;this._messageLengthCounterNode.textContent=t;const i=t>=this._messageLengthMax?"addClass":"removeClass";BX[i](this._messageLengthCounterNode,"crm-entity-stream-content-sms-symbol-counter-number-overhead");this.toggleSaveButton()}},{key:"toggleSaveButton",value:function e(){const t=this.getSelectedSender();let i;if(!t||!t.isTemplatesBased){i=this._input.value.length>0}else{i=!!this._templateId}if(i){BX.removeClass(this._saveButton,"ui-btn-disabled")}else{BX.addClass(this._saveButton,"ui-btn-disabled")}}},{key:"save",value:function e(){const t=this.getSelectedSender();let i="";let s="";if(!t||!t.isTemplatesBased){i=this._input.value;if(i===""){return}}else{const e=this.getSelectedTemplate();if(!e){return}i=e.PREVIEW;s=e.ID}if(!this._communications.length){alert(BX.message("CRM_TIMELINE_SMS_ERROR_NO_COMMUNICATIONS"));return}if(this._isRequestRunning||this._isLocked){return}this._isRequestRunning=this._isLocked=true;BX.ajax({url:BX.util.add_url_param(this._serviceUrl,{action:"save_sms_message",sender:this._senderId}),method:"POST",dataType:"json",data:{site:BX.message("SITE_ID"),sessid:BX.bitrix_sessid(),source:this._source,ACTION:"SAVE_SMS_MESSAGE",SENDER_ID:this._senderId,MESSAGE_FROM:this._from,MESSAGE_TO:this._to,MESSAGE_BODY:i,MESSAGE_TEMPLATE:s,OWNER_TYPE_ID:this._ownerTypeId,OWNER_ID:this._ownerId,TO_ENTITY_TYPE_ID:this._commEntityTypeId,TO_ENTITY_ID:this._commEntityId,PAYMENT_ID:this._paymentId,SHIPMENT_ID:this._shipmentId,COMPILATION_PRODUCT_IDS:this._compilationProductIds},onsuccess:BX.delegate(this.onSaveSuccess,this),onfailure:BX.delegate(this.onSaveFailure,this)})}},{key:"cancel",value:function e(){this._input.value="";this.setMessageLengthCounter();this._input.style.minHeight="";this.release()}},{key:"onSaveSuccess",value:function e(t){this._isRequestRunning=this._isLocked=false;const i=BX.prop.getString(t,"ERROR","");if(i!==""){alert(i);return}this._input.value="";this.setMessageLengthCounter();this._input.style.minHeight="";this._manager.processEditingCompletion(this);this.release()}},{key:"onSaveFailure",value:function e(){this._isRequestRunning=this._isLocked=false}},{key:"initSalescenterApplication",value:function e(){BX.bind(this._salescenterStarter,"click",this.startSalescenterApplication.bind(this))}},{key:"startSalescenterApplication",value:function e(){BX.loadExt("salescenter.manager").then(function(){BX.Salescenter.Manager.openApplication({disableSendButton:this._canSendMessage?"":"y",context:"sms",ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,mode:this._ownerTypeId===BX.CrmEntityType.enumeration.deal?"payment_delivery":"payment"}).then(function(e){if(e&&e.get("action")){if(e.get("action")==="sendPage"&&e.get("page")&&e.get("page").url){this._input.focus();this._input.value=this._input.value+e.get("page").name+" "+e.get("page").url;this.setMessageLengthCounter()}else if(e.get("action")==="sendPayment"&&e.get("order")){this._input.focus();this._input.value=this._input.value+e.get("order").title;this.setMessageLengthCounter();this._source="order";this._paymentId=e.get("order").paymentId;this._shipmentId=e.get("order").shipmentId}else if(e.get("action")==="sendCompilation"&&e.get("compilation")){this._input.focus();this._input.value=this._input.value+e.get("compilation").title;this.setMessageLengthCounter();this._source="deal";this._compilationProductIds=e.get("compilation").productIds}}}.bind(this))}.bind(this))}},{key:"initDocumentSelector",value:function e(){BX.bind(this._documentSelectorButton,"click",this.onDocumentSelectorClick.bind(this))}},{key:"onDocumentSelectorClick",value:function e(){if(!this._documentSelector){BX.loadExt("documentgenerator.selector").then(function(){this._documentSelector=new BX.DocumentGenerator.Selector.Menu({node:this._documentSelectorButton,moduleId:"crm",provider:this._documentsProvider,value:this._documentsValue,analyticsLabelPrefix:"crmTimelineSmsEditor"});this.selectPublicUrl()}.bind(this))}else{this.selectPublicUrl()}}},{key:"selectPublicUrl",value:function e(){if(!this._documentSelector){return}this._documentSelector.show().then(function(e){if(e instanceof BX.DocumentGenerator.Selector.Template){this._documentSelector.createDocument(e).then(function(e){this.pasteDocumentUrl(e)}.bind(this)).catch(function(e){console.error(e)}.bind(this))}else if(e instanceof BX.DocumentGenerator.Selector.Document){this.pasteDocumentUrl(e)}}.bind(this)).catch(function(e){console.error(e)}.bind(this))}},{key:"pasteDocumentUrl",value:function e(t){this._documentSelector.getDocumentPublicUrl(t).then(function(e){this._input.focus();this._input.value=this._input.value+" "+t.getTitle()+" "+e;this.setMessageLengthCounter();this._source="document"}.bind(this)).catch(function(e){console.error(e)}.bind(this))}},{key:"initFileSelector",value:function e(){BX.bind(this._fileSelectorButton,"click",this.onFileSelectorClick.bind(this))}},{key:"closeFileSelector",value:function e(){BX.PopupMenu.destroy("sms-file-selector")}},{key:"onFileSelectorClick",value:function e(){BX.PopupMenu.show("sms-file-selector",this._fileSelectorButton,[{text:BX.message("CRM_TIMELINE_SMS_UPLOAD_FILE"),onclick:this.uploadFile.bind(this),className:this._isFilesExternalLinkEnabled?"":"crm-entity-stream-content-sms-menu-item-with-lock"},{text:BX.message("CRM_TIMELINE_SMS_FIND_FILE"),onclick:this.findFile.bind(this),className:this._isFilesExternalLinkEnabled?"":"crm-entity-stream-content-sms-menu-item-with-lock"}])}},{key:"getFileUploadInput",value:function e(){return document.getElementById(this._fileUploadLabel.getAttribute("for"))}},{key:"uploadFile",value:function e(){this.closeFileSelector();if(this._isFilesExternalLinkEnabled){this.initDiskUF();BX.fireEvent(this.getFileUploadInput(),"click")}else{this.showFilesExternalLinkFeaturePopup()}}},{key:"findFile",value:function e(){this.closeFileSelector();if(this._isFilesExternalLinkEnabled){this.initDiskUF();BX.fireEvent(this._fileSelectorBitrix,"click")}else{this.showFilesExternalLinkFeaturePopup()}}},{key:"getLoader",value:function e(){if(!this.loader){this.loader=new BX.Loader({size:50})}return this.loader}},{key:"showLoader",value:function e(t){if(t&&!this.getLoader().isShown()){this.getLoader().show(t)}}},{key:"hideLoader",value:function e(){if(this.getLoader().isShown()){this.getLoader().hide()}}},{key:"initDiskUF",value:function e(){if(this.isDiskFileUploaderInited||!this._isFilesEnabled){return}this.isDiskFileUploaderInited=true;BX.addCustomEvent(this._fileUploadZone,"OnFileUploadSuccess",this.OnFileUploadSuccess.bind(this));BX.addCustomEvent(this._fileUploadZone,"DiskDLoadFormControllerInit",function(e){e._onUploadProgress=function(){this.showLoader(this._fileSelectorButton.parentNode.parentNode)}.bind(this)}.bind(this));BX.Disk.UF.add({UID:this._fileUploadZone.getAttribute("data-node-id"),controlName:this._fileUploadLabel.getAttribute("for"),hideSelectDialog:false,urlSelect:this._diskUrls.urlSelect,urlRenameFile:this._diskUrls.urlRenameFile,urlDeleteFile:this._diskUrls.urlDeleteFile,urlUpload:this._diskUrls.urlUpload});BX.onCustomEvent(this._fileUploadZone,"DiskLoadFormController",["show"])}},{key:"OnFileUploadSuccess",value:function e(t,i,s,n){this.hideLoader();const a=parseInt(t.element_id.replace("n",""));const r=t.element_name;this.pasteFileUrl(a,r)}},{key:"pasteFileUrl",value:function e(t,i){this.showLoader(this._fileSelectorButton.parentNode.parentNode);BX.ajax.runAction("disk.file.generateExternalLink",{analyticsLabel:"crmTimelineSmsEditorGetFilePublicUrl",data:{fileId:t}}).then(function(e){this.hideLoader();if(e.data.externalLink&&e.data.externalLink.link){this._input.focus();this._input.value=this._input.value+" "+i+" "+e.data.externalLink.link;this.setMessageLengthCounter();this._source="file"}}.bind(this)).catch((function(e){console.error(e.errors.pop().message)}))}},{key:"getFeaturePopup",value:function e(t){if(this.featurePopup!=null){return this.featurePopup}this.featurePopup=new BX.PopupWindow("bx-popup-crm-sms-editor-feature-popup",null,{zIndex:200,autoHide:true,closeByEsc:true,closeIcon:true,overlay:true,events:{onPopupDestroy:function(){this.featurePopup=null}.bind(this)},content:t,contentColor:"white"});return this.featurePopup}},{key:"showFilesExternalLinkFeaturePopup",value:function e(){this.getFeaturePopup(this._fileExternalLinkDisabledContent).show()}},{key:"onTemplateHintIconClick",value:function e(){if(this._senderId==="ednaru"){top.BX.Helper.show("redirect=detail&code=14214014")}}},{key:"showTemplateSelectDropdown",value:function e(t){const i=[];if(BX.Type.isArray(t)){if(t.length){t.forEach(function(e){i.push({value:e.ID,text:e.TITLE,onclick:this._selectTemplateHandler})}.bind(this));BX.PopupMenu.show({id:this._templateSelectorMenuId,bindElement:this._templateSelectorNode,items:i,angle:false,width:this._templateSelectorNode.offsetWidth})}}else if(this._senderId){const e=this._templateSelectorMenuId+"loader";const t=this._templateSelectorMenuId+"loader";BX.PopupMenu.show({id:e,bindElement:this._templateSelectorNode,items:[{html:'<div id="'+t+'"></div>'}],angle:false,width:this._templateSelectorNode.offsetWidth,height:60,events:{onDestroy:function(){this.hideLoader()}.bind(this)}});this.showLoader(BX(t));if(!this._isRequestRunning){this._isRequestRunning=true;const t=this._senderId;BX.ajax.runAction("messageservice.Sender.getTemplates",{data:{id:t,context:{module:"crm",entityTypeId:this._manager._ownerTypeId,entityId:this._manager._ownerId}}}).then(function(i){this._isRequestRunning=false;const s=this._senders.find(function(e){return e.id===t}.bind(this));if(s){s.templates=i.data.templates;this.toggleTemplateSelectAvailability();if(BX.PopupMenu.getMenuById(e)){BX.PopupMenu.getMenuById(e).close();this.showTemplateSelectDropdown(s.templates)}}}.bind(this)).catch(function(t){this._isRequestRunning=false;if(BX.PopupMenu.getMenuById(e)){if(t&&t.errors&&t.errors[0]&&t.errors[0].message){alert(t.errors[0].message)}BX.PopupMenu.getMenuById(e).close()}}.bind(this))}}}},{key:"getSelectedSender",value:function e(){return this._senders.find(function(e){return e.id===this._senderId}.bind(this))}},{key:"getSelectedTemplate",value:function e(){const t=this.getSelectedSender();if(!this._templateId||!t||!t.templates){return null}const i=t.templates.find(function(e){return e.ID==this._templateId}.bind(this));return i?i:null}},{key:"onTemplateSelectClick",value:function e(){const t=this.getSelectedSender();if(t){this.showTemplateSelectDropdown(t.templates)}}},{key:"onSelectTemplate",value:function e(t,i){this._templateId=i.value;this.applySelectedTemplate();this.toggleSaveButton();const s=BX.PopupMenu.getMenuById(this._templateSelectorMenuId);if(s){s.close()}}},{key:"toggleTemplateSelectAvailability",value:function e(){const t=this.getSelectedSender();if(t&&BX.Type.isArray(t.templates)&&!t.templates.length){BX.addClass(this._templateSelectorNode,"ui-ctl-disabled");this._templateTemplateTitleNode.textContent=BX.message("CRM_TIMELINE_SMS_TEMPLATES_NOT_FOUND")}else{BX.removeClass(this._templateSelectorNode,"ui-ctl-disabled");this.applySelectedTemplate()}}},{key:"applySelectedTemplate",value:function e(){const t=this.getSelectedSender();if(!this._templateId||!t||!t.templates){this.hideNode(this._templatePreviewNode);this._templateTemplateTitleNode.textContent=""}else{const e=this.getSelectedTemplate();if(e){const t=BX.Text.encode(e.PREVIEW).replace(/\n/g,"<br>");this.showNode(this._templatePreviewNode);this._templatePreviewNode.innerHTML=t;this._templateTemplateTitleNode.textContent=e.TITLE}else{this.hideNode(this._templatePreviewNode);this._templateTemplateTitleNode.textContent=""}}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);t.items[n.getId()]=n;return n}}]);return t}(Editor);babelHelpers.defineProperty(Sms,"items",{});let Rest=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._interfaceInitialized=false;return e}babelHelpers.createClass(t,[{key:"action",value:function e(t){if(!this._interfaceInitialized){this._interfaceInitialized=true;this.initializeInterface()}if(t==="activity_rest_applist"){BX.rest.Marketplace.open({PLACEMENT:this.getSetting("placement","")});top.BX.addCustomEvent(top,"Rest:AppLayout:ApplicationInstall",BX.proxy(this.fireUpdateEvent,this))}else{const e=t.replace("activity_rest_","");const i=e.split("_");BX.rest.AppLayout.openApplication(i[0],{ID:this._ownerId},{PLACEMENT:this.getSetting("placement",""),PLACEMENT_ID:i[1]})}}},{key:"initializeInterface",value:function e(){if(!!top.BX.rest&&!!top.BX.rest.AppLayout){const e=this._manager._ownerTypeId,t=this._manager._ownerId;const i=top.BX.rest.AppLayout.initializePlacement(this.getSetting("placement",""));i.prototype.reloadData=function(i,s){BX.Crm.EntityEvent.fireUpdate(e,t,"");s()}}}},{key:"fireUpdateEvent",value:function e(){const t=this._manager._ownerTypeId,i=this._manager._ownerId;setTimeout((function(){console.log("fireUpdate",i,t);BX.Crm.EntityEvent.fire(BX.Crm.EntityEvent.names.invalidate,t,i,"")}),3e3)}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);t.items[n.getId()]=n;return n}}]);return t}(Editor);babelHelpers.defineProperty(Rest,"items",{});let Comment=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._history=null;e._serviceUrl="";e._postForm=null;e._editor=null;e._isRequestRunning=false;e._isLocked=false;return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){this._serviceUrl=this.getSetting("serviceUrl","");BX.unbind(this._input,"blur",this._blurHandler);BX.unbind(this._input,"keyup",this._keyupHandler)}},{key:"loadEditor",value:function e(){this._editorName="CrmTimeLineComment0";if(this._postForm)return;BX.ajax.runAction("crm.api.timeline.loadEditor",{data:{name:this._editorName}}).then(this.onLoadEditorSuccess.bind(this))}},{key:"onLoadEditorSuccess",value:function e(t){const i=BX.prop.getString(BX.prop.getObject(t,"data",{}),"html","");BX.html(this._editorContainer,i).then(BX.delegate(this.showEditor,this)).then(BX.delegate(this.addEvents,this))}},{key:"addEvents",value:function e(){BX.addCustomEvent(this._editorContainer.firstElementChild,"onFileIsAppended",BX.delegate((function(e,t){BX.addClass(this._saveButton,"ui-btn-disabled");BX.addClass(this._saveButton,"ui-btn-clock");this._saveButton.removeEventListener("click",this._saveButtonHandler)}),this));BX.addCustomEvent(this._editorContainer.firstElementChild,"onFileIsAdded",BX.delegate((function(e,t,i,s){BX.removeClass(this._saveButton,"ui-btn-clock");BX.removeClass(this._saveButton,"ui-btn-disabled");this._saveButton.addEventListener("click",this._saveButtonHandler)}),this))}},{key:"showEditor",value:function e(){if(LHEPostForm){window.setTimeout(BX.delegate((function(){this._postForm=LHEPostForm.getHandler(this._editorName);this._editor=BXHtmlEditor.Get(this._editorName);BX.onCustomEvent(this._postForm.eventNode,"OnShowLHE",[true])}),this),100)}}},{key:"getHistory",value:function e(){return this._history}},{key:"setHistory",value:function e(t){this._history=t}},{key:"onFocus",value:function e(t){this._input.style.display="none";if(this._editor&&this._postForm){this._postForm.eventNode.style.display="block";this._editor.Focus()}else{if(!BX.type.isDomNode(this._editorContainer)){this._editorContainer=BX.create("div",{attrs:{className:"crm-entity-stream-section-comment-editor"}});this._editorContainer.appendChild(BX.create("DIV",{attrs:{className:"crm-timeline-wait"}}));this._container.appendChild(this._editorContainer)}window.setTimeout(BX.delegate((function(){this.loadEditor()}),this),100)}BX.addClass(this._container,"focus")}},{key:"save",value:function e(){let t="";const i=[];if(this._postForm){t=this._postForm.oEditor.GetContent();this._postForm.eventNode.querySelectorAll('input[name="UF_CRM_COMMENT_FILES[]"]').forEach((function(e){i.push(e.value)}))}else{t=this._input.value}if(t===""){if(!this.emptyCommentMessage){this.emptyCommentMessage=new BX.PopupWindow("timeline_empty_new_comment_"+this._ownerId,this._saveButton,{content:BX.message("CRM_TIMELINE_EMPTY_COMMENT_MESSAGE"),darkMode:true,autoHide:true,zIndex:990,angle:{position:"top",offset:77},closeByEsc:true,bindOptions:{forceBindPosition:true}})}this.emptyCommentMessage.show();return}if(this._isRequestRunning||this._isLocked){return}this._isRequestRunning=this._isLocked=true;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"SAVE_COMMENT",TEXT:t,OWNER_TYPE_ID:this._ownerTypeId,OWNER_ID:this._ownerId,ATTACHMENTS:i},onsuccess:BX.delegate(this.onSaveSuccess,this),onfailure:BX.delegate(this.onSaveFailure,this)})}},{key:"cancel",value:function e(){this._input.value="";this._input.style.minHeight="";if(BX.type.isDomNode(this._editorContainer))this._postForm.eventNode.style.display="none";this._input.style.display="block";BX.removeClass(this._container,"focus");this.release()}},{key:"onSaveSuccess",value:function e(t){this._isRequestRunning=false;if(this._postForm){this._postForm.reinit("",{})}this.cancel();const i=BX.prop.getObject(t,"HISTORY_ITEM");const s=this._history.createItem(i);this._history.addItem(s,0);const n=this._history.createAnchor();s.layout({anchor:n});const a=BX.CrmCommentAnimation.create(s.getWrapper(),n,BX.pos(this._input),{start:BX.delegate(this.onAnimationStart,this),complete:BX.delegate(this.onAnimationComplete,this)});a.run()}},{key:"onSaveFailure",value:function e(){this._isRequestRunning=this._isLocked=false}},{key:"onAnimationStart",value:function e(){this._input.value=""}},{key:"onAnimationComplete",value:function e(){this._isLocked=false;BX.removeClass(this._container,"focus");this._input.style.minHeight="";this._manager.processEditingCompletion(this);this.release();this._history._anchor=null;this._history.refreshLayout()}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);t.items[n.getId()]=n;return n}}]);return t}(Editor);babelHelpers.defineProperty(Comment,"items",{});function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t);t.add(e)}function _classPrivateFieldInitSpec(e,t,i){_checkPrivateRedeclaration(e,t);t.set(e,i)}function _checkPrivateRedeclaration(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var _toDoEditor=new WeakMap;var _createEditor=new WeakSet;var _onChangeDescription=new WeakSet;let ToDo=function(e){babelHelpers.inherits(t,e);function t(...e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,...e));_classPrivateMethodInitSpec(babelHelpers.assertThisInitialized(i),_onChangeDescription);_classPrivateMethodInitSpec(babelHelpers.assertThisInitialized(i),_createEditor);_classPrivateFieldInitSpec(babelHelpers.assertThisInitialized(i),_toDoEditor,{writable:true,value:null});return i}babelHelpers.createClass(t,[{key:"initialize",value:function e(i,s){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"initialize",this).call(this,i,s);_classPrivateMethodGet(this,_createEditor,_createEditor2).call(this)}},{key:"save",value:function e(){if(main_core.Dom.hasClass(this._saveButton,"ui-btn-disabled")){return false}return babelHelpers.classPrivateFieldGet(this,_toDoEditor).save().then((e=>{if(main_core.Type.isArray(e.errors)&&e.errors.length){return false}this.cancel();this._manager.processEditingCompletion(this);return true}))}},{key:"cancel",value:function e(){babelHelpers.classPrivateFieldGet(this,_toDoEditor).clearValue();main_core.Dom.removeClass(this._container,"focus");this.release()}},{key:"bindInputHandlers",value:function e(){}},{key:"setParentActivityId",value:function e(t){babelHelpers.classPrivateFieldGet(this,_toDoEditor).setParentActivityId(t)}},{key:"setDeadLine",value:function e(t){babelHelpers.classPrivateFieldGet(this,_toDoEditor).setDeadLine(t)}},{key:"setFocused",value:function e(){babelHelpers.classPrivateFieldGet(this,_toDoEditor).setFocused()}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);t.items[n.getId()]=n;return n}}]);return t}(Editor);function _createEditor2(){const e=main_core.Dom.create("div");main_core.Dom.prepend(e,this._container);babelHelpers.classPrivateFieldSet(this,_toDoEditor,new crm_activity_todoEditor.TodoEditor({container:e,defaultDescription:"",ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,events:{onFocus:this._focusHandler,onChangeDescription:_classPrivateMethodGet(this,_onChangeDescription,_onChangeDescription2).bind(this)}}));babelHelpers.classPrivateFieldGet(this,_toDoEditor).show()}function _onChangeDescription2(e){const{description:t}=e.getData();if(!t.length&&!main_core.Dom.hasClass(this._saveButton,"ui-btn-disabled")){main_core.Dom.addClass(this._saveButton,"ui-btn-disabled")}else if(t.length&&main_core.Dom.hasClass(this._saveButton,"ui-btn-disabled")){main_core.Dom.removeClass(this._saveButton,"ui-btn-disabled")}}babelHelpers.defineProperty(ToDo,"items",{});const Item={undefined:0,activity:1,creation:2,modification:3,link:4,unlink:5,mark:6,comment:7,wait:8,bizproc:9,conversion:10,sender:11,document:12,restoration:13,order:14,orderCheck:15,scoring:16,externalNotification:17,finalSummary:18,delivery:19,finalSummaryDocuments:20,storeDocument:21,productCompilation:22,signDocument:23};const Mark={undefined:0,waiting:1,success:2,renew:3,ignored:4,failed:5};const Order={encourageBuyProducts:100};const EditorMode={view:1,edit:2};var types=Object.freeze({Item:Item,Mark:Mark,Order:Order,EditorMode:EditorMode});let CompatibleItem=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._id="";e._settings={};e._data={};e._container=null;e._typeCategoryId=null;e._associatedEntityData=null;e._associatedEntityTypeId=null;e._associatedEntityId=null;e._isContextMenuShown=false;e._contextMenuButton=null;e._activityEditor=null;e._actions=[];e._actionContainer=null;e._existedStreamItemDeadLine=null;return e}babelHelpers.createClass(t,[{key:"initialize",value:function e(t,i){this._setId(t);this._settings=i?i:{};this._container=this.getSetting("container");if(!BX.type.isPlainObject(i["data"])){throw"Item. A required parameter 'data' is missing."}this._data=i["data"];this._activityEditor=this.getSetting("activityEditor");this.doInitialize()}},{key:"doInitialize",value:function e(){}},{key:"getId",value:function e(){return this._id}},{key:"getSetting",value:function e(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i}},{key:"getData",value:function e(){return this._data}},{key:"setData",value:function e(t){if(BX.type.isPlainObject(t)){this._data=t;this.clearCachedData()}}},{key:"getSort",value:function e(){var t;return(t=this._data["sort"])!==null&&t!==void 0?t:[]}},{key:"getAssociatedEntityData",value:function e(){if(this._associatedEntityData===null){this._associatedEntityData=BX.type.isPlainObject(this._data["ASSOCIATED_ENTITY"])?this._data["ASSOCIATED_ENTITY"]:{}}return this._associatedEntityData}},{key:"getAssociatedEntityTypeId",value:function e(){if(this._associatedEntityTypeId===null){this._associatedEntityTypeId=BX.prop.getInteger(this._data,"ASSOCIATED_ENTITY_TYPE_ID",0)}return this._associatedEntityTypeId}},{key:"getAssociatedEntityId",value:function e(){if(this._associatedEntityId===null){this._associatedEntityId=BX.prop.getInteger(this._data,"ASSOCIATED_ENTITY_ID",0)}return this._associatedEntityId}},{key:"setAssociatedEntityData",value:function e(t){if(!BX.type.isPlainObject(t)){t={}}const i=this._data;i.ASSOCIATED_ENTITY=t;this.setData(i)}},{key:"hasPermissions",value:function e(){const t=this.getAssociatedEntityData();return BX.type.isPlainObject(t["PERMISSIONS"])}},{key:"getPermissions",value:function e(){return BX.prop.getObject(this.getAssociatedEntityData(),"PERMISSIONS",{})}},{key:"setPermissions",value:function e(t){const i=this._data;if(!main_core.Type.isPlainObject(i.ASSOCIATED_ENTITY)){i.ASSOCIATED_ENTITY={}}i.ASSOCIATED_ENTITY.PERMISSIONS=t;this.setData(i)}},{key:"getTextDataParam",value:function e(t){return BX.prop.getString(this._data,t,"")}},{key:"getObjectDataParam",value:function e(t){return BX.prop.getObject(this._data,t,{})}},{key:"getArrayDataParam",value:function e(t){return BX.prop.getArray(this._data,t,[])}},{key:"getTypeId",value:function e(){return Item.undefined}},{key:"getTypeCategoryId",value:function e(){if(this._typeCategoryId===null){this._typeCategoryId=BX.prop.getInteger(this._data,"TYPE_CATEGORY_ID",0)}return this._typeCategoryId}},{key:"getContainer",value:function e(){return this._container}},{key:"setContainer",value:function e(t){this._container=BX.type.isElementNode(t)?t:null}},{key:"layout",value:function e(t){if(!BX.type.isElementNode(this._container)){throw"Item. Container is not assigned."}this.prepareLayout(t);this.prepareActions();const i=this._actions.length;for(let e=0;e<i;e++){this._actions[e].layout()}this.showActions(i>0)}},{key:"prepareLayout",value:function e(t){}},{key:"prepareActions",value:function e(){}},{key:"showActions",value:function e(t){}},{key:"clearCachedData",value:function e(){this._typeCategoryId=null;this._associatedEntityData=null;this._associatedEntityTypeId=null;this._associatedEntityId=null}},{key:"isDone",value:function e(){return false}},{key:"markAsDone",value:function e(t){}},{key:"view",value:function e(){}},{key:"edit",value:function e(){}},{key:"fasten",value:function e(){}},{key:"unfasten",value:function e(){}},{key:"remove",value:function e(){}},{key:"cutOffText",value:function e(t,i){if(!BX.type.isNumber(i)){i=0}if(i<=0||t.length<=i){return t}let s=i-1;const n=t.substring(s).search(/\s/i);if(n>0){s+=n}return t.substring(0,s)}},{key:"prepareMultilineCutOffElements",value:function e(t,i,s){if(!BX.type.isNumber(i)){i=0}if(i<=0||t.length<=i){return[BX.util.htmlspecialchars(t).replace(/(?:\r\n|\r|\n)/g,"<br>")]}let n=i-1;const a=t.substring(n).search(/\s/i);if(a>0){n+=a}return[BX.util.htmlspecialchars(t.substring(0,n)).replace(/(?:\r\n|\r|\n)/g,"<br>")+"&hellip;&nbsp;",BX.create("A",{attrs:{className:"crm-entity-stream-content-letter-more",href:"#"},events:{click:s},text:this.getMessage("details")})]}},{key:"prepareCutOffElements",value:function e(t,i,s){if(!BX.type.isNumber(i)){i=0}if(i<=0||t.length<=i){return[BX.util.htmlspecialchars(t)]}let n=i-1;const a=t.substring(n).search(/\s/i);if(a>0){n+=a}return[BX.util.htmlspecialchars(t.substring(0,n))+"&hellip;&nbsp;",BX.create("A",{attrs:{className:"crm-entity-stream-content-letter-more",href:"#"},events:{click:s},text:this.getMessage("details")})]}},{key:"prepareAuthorLayout",value:function e(){const t=this.getObjectDataParam("AUTHOR",null);if(!t){return null}const i=BX.prop.getString(t,"SHOW_URL","");if(i===""){return null}const s=BX.create("A",{attrs:{className:"ui-icon ui-icon-common-user crm-entity-stream-content-detail-employee",href:i,target:"_blank",title:BX.prop.getString(t,"FORMATTED_NAME","")},children:[BX.create("i",{})]});const n=BX.prop.getString(t,"IMAGE_URL","");if(n!==""){s.children[0].style.backgroundImage="url('"+encodeURI(n)+"')";s.children[0].style.backgroundSize="21px"}return s}},{key:"onActivityCreate",value:function e(t,i){}},{key:"isContextMenuEnabled",value:function e(){return false}},{key:"prepareContextMenuButton",value:function e(){this._contextMenuButton=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-context-menu"},events:{click:BX.delegate(this.onContextMenuButtonClick,this)}});return this._contextMenuButton}},{key:"onContextMenuButtonClick",value:function e(t){if(!this._isContextMenuShown){this.openContextMenu()}else{this.closeContextMenu()}}},{key:"openContextMenu",value:function e(){const t=this.prepareContextMenuItems();if(typeof IntranetExtensions!=="undefined"){t.push(IntranetExtensions)}if(t.length===0){return}BX.PopupMenu.show(this._id,this._contextMenuButton,t,{offsetTop:0,offsetLeft:16,angle:{position:"top",offset:0},events:{onPopupShow:BX.delegate(this.onContextMenuShow,this),onPopupClose:BX.delegate(this.onContextMenuClose,this),onPopupDestroy:BX.delegate(this.onContextMenuDestroy,this)}});this._contextMenu=BX.PopupMenu.currentItem}},{key:"closeContextMenu",value:function e(){if(this._contextMenu){this._contextMenu.close()}}},{key:"prepareContextMenuItems",value:function e(){return[]}},{key:"onContextMenuShow",value:function e(){this._isContextMenuShown=true;BX.addClass(this._contextMenuButton,"active")}},{key:"onContextMenuClose",value:function e(){if(this._contextMenu){this._contextMenu.popupWindow.destroy()}}},{key:"onContextMenuDestroy",value:function e(){this._isContextMenuShown=false;BX.removeClass(this._contextMenuButton,"active");this._contextMenu=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"getUserTimezoneOffset",value:function e(){return crm_datetime.TimezoneOffset.USER_TO_SERVER}}]);return t}(crm_timeline_item.Item);babelHelpers.defineProperty(CompatibleItem,"messages",{});let Fasten=function(){function e(){babelHelpers.classCallCheck(this,e);this._id="";this._settings={};this._initialItem=null;this._finalItem=null;this._events=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._initialItem=this.getSetting("initialItem");this._finalItem=this.getSetting("finalItem");this._anchor=this.getSetting("anchor");this._events=this.getSetting("events",{})}},{key:"getId",value:function e(){return this._id}},{key:"getSetting",value:function e(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i}},{key:"addFixedHistoryItem",value:function e(){const t=this._finalItem.getWrapper();BX.addClass(t,"crm-entity-stream-section-animate-start");if(this._anchor.parentNode&&t){this._anchor.parentNode.insertBefore(t,this._anchor.nextSibling)}setTimeout(BX.delegate((function(){BX.removeClass(t,"crm-entity-stream-section-animate-start")}),this),0)}},{key:"run",value:function e(){const t=this._initialItem.getWrapper();this._clone=t.cloneNode(true);BX.addClass(this._clone,"crm-entity-stream-section-animate-start crm-entity-stream-section-top-fixed");this._startPosition=BX.pos(t);this._clone.style.position="absolute";this._clone.style.width=this._startPosition.width+"px";let i=this._startPosition.height;const s=65;const n=18;if(i<n+s)i=n+s;this._clone.style.height=i+"px";this._clone.style.top=this._startPosition.top+"px";this._clone.style.left=this._startPosition.left+"px";this._clone.style.zIndex=960;document.body.appendChild(this._clone);setTimeout(BX.proxy((function(){BX.addClass(this._clone,"crm-entity-stream-section-casper")}),this),0);this._anchorPosition=BX.pos(this._anchor);const a={top:this._anchorPosition.top,height:i+15,opacity:1};const r=this._startPosition.top-this._anchorPosition.bottom;const o=2*(document.body.clientHeight+this._startPosition.height);if(r>o){a.top=this._startPosition.top-o;a.opacity=0}let l=Math.abs(a.top-this._startPosition.top)*2;l=l<1500?1500:l;const c=new BX.easing({duration:l,start:{top:this._startPosition.top,height:0,opacity:1},finish:a,transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(e){this._clone.style.top=e.top+"px";this._clone.style.opacity=e.opacity;this._anchor.style.height=e.height+"px"}),this),complete:BX.proxy((function(){this.finish()}),this)});c.animate()}},{key:"finish",value:function e(){this._anchor.style.height=0;this.addFixedHistoryItem();BX.remove(this._clone);if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}}}],[{key:"create",value:function t(i,s){const n=new e;n.initialize(i,s);return n}}]);return e}();let History=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._history=null;e._fixedHistory=null;e._typeId=null;e._createdTime=null;e._isFixed=false;e._headerClickHandler=BX.delegate(e.onHeaderClick,babelHelpers.assertThisInitialized(e));return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){this._history=this.getSetting("history");this._fixedHistory=this.getSetting("fixedHistory")}},{key:"getTypeId",value:function e(){if(this._typeId===null){this._typeId=BX.prop.getInteger(this._data,"TYPE_ID",Item.undefined)}return this._typeId}},{key:"getTitle",value:function e(){return""}},{key:"isContextMenuEnabled",value:function e(){return!this.isReadOnly()}},{key:"getCreatedTimestamp",value:function e(){return this.getTextDataParam("CREATED_SERVER")}},{key:"getCreatedTime",value:function e(){if(this._createdTime===null){const e=BX.parseDate(this.getCreatedTimestamp(),false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");this._createdTime=new crm_timeline_tools.DatetimeConverter(e).toUserTime().getValue()}return this._createdTime}},{key:"getCreatedDate",value:function e(){return BX.prop.extractDate(new Date(this.getCreatedTime().getTime()))}},{key:"getOwnerInfo",value:function e(){return this._history?this._history.getOwnerInfo():null}},{key:"getOwnerTypeId",value:function e(){return BX.prop.getInteger(this.getOwnerInfo(),"ENTITY_TYPE_ID",BX.CrmEntityType.enumeration.undefined)}},{key:"getOwnerId",value:function e(){return BX.prop.getInteger(this.getOwnerInfo(),"ENTITY_ID",0)}},{key:"isReadOnly",value:function e(){return this._history.isReadOnly()}},{key:"isEditable",value:function e(){return!this.isReadOnly()}},{key:"isDone",value:function e(){const t=this.getTypeId();if(t===Item.activity){const e=this.getAssociatedEntityData();return BX.CrmActivityStatus.isFinal(BX.prop.getInteger(e,"STATUS",0))}return false}},{key:"isFixed",value:function e(){return this._isFixed}},{key:"fasten",value:function e(t){if(this._fixedHistory._items.length>=3){if(!this.fastenLimitPopup){this.fastenLimitPopup=new BX.PopupWindow("timeline_fasten_limit_popup_"+this._id,this._switcher,{content:BX.message("CRM_TIMELINE_FASTEN_LIMIT_MESSAGE"),darkMode:true,autoHide:true,zIndex:990,angle:true,closeByEsc:true,bindOptions:{forceBindPosition:true}})}this.fastenLimitPopup.show();this.closeContextMenu();return}BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"CHANGE_FASTEN_ITEM",VALUE:"Y",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this._id}});this.closeContextMenu()}},{key:"onSuccessFasten",value:function e(t){if(t&&BX.type.isNotEmptyString(t.ERROR))return;if(!this.isFixed()){this._data.IS_FIXED="Y";const e=this._fixedHistory.createItem(this._data);e._isFixed=true;this._fixedHistory.addItem(e,0);e.layout({add:false});this.refreshLayout();const t=Fasten.create("",{initialItem:this,finalItem:e,anchor:this._fixedHistory._anchor});t.run()}this.closeContextMenu()}},{key:"unfasten",value:function e(t){BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"CHANGE_FASTEN_ITEM",VALUE:"N",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this._id}});this.closeContextMenu()}},{key:"onSuccessUnfasten",value:function e(t){if(t&&BX.type.isNotEmptyString(t.ERROR))return;let i;let s;if(this.isFixed()){i=this;s=this._history.findItemById(this._id)}else{i=this._fixedHistory.findItemById(this._id);s=this}if(i){const e=this._fixedHistory.getItemIndex(i);i.clearAnimate();this._fixedHistory.removeItemByIndex(e);if(s){s._data.IS_FIXED="N";s.refreshLayout();BX.LazyLoad.showImages()}}}},{key:"clearAnimate",value:function e(){if(!BX.type.isDomNode(this._wrapper))return;const t=BX.pos(this._wrapper);const i=new BX.easing({duration:1e3,start:{height:t.height,opacity:1,marginBottom:15},finish:{height:0,opacity:0,marginBottom:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(e){this._wrapper.style.height=e.height+"px";this._wrapper.style.opacity=e.opacity;this._wrapper.style.marginBottom=e.marginBottom}),this),complete:BX.proxy((function(){this.clearLayout()}),this)});i.animate()}},{key:"getWrapperClassName",value:function e(){return""}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}},{key:"prepareContentDetails",value:function e(){return[]}},{key:"prepareContent",value:function e(){let t=this.getWrapperClassName();if(t!==""){t="crm-entity-stream-section crm-entity-stream-section-history"+" "+t}else{t="crm-entity-stream-section crm-entity-stream-section-history"}const i=BX.create("DIV",{attrs:{className:t}});i.appendChild(BX.create("DIV",{attrs:{className:this.getIconClassName()}}));if(this.isContextMenuEnabled()){main_core.Dom.append(this.prepareContextMenuButton(),i)}const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})]});s.appendChild(n);s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:this.prepareContentDetails()}));const a=this.prepareAuthorLayout();if(a){s.appendChild(a)}return i}},{key:"prepareLayout",value:function e(t){this._wrapper=this.prepareContent();if(this._wrapper){const e=BX.type.isPlainObject(t)?BX.prop.getBoolean(t,"add",true):true;if(e){const e=BX.type.isPlainObject(t)&&BX.type.isElementNode(t["anchor"])?t["anchor"]:null;if(e&&e.nextSibling){this._container.insertBefore(this._wrapper,e.nextSibling)}else{this._container.appendChild(this._wrapper)}}this.markAsTerminated(this._history.checkItemForTermination(this))}}},{key:"onHeaderClick",value:function e(t){this.view();t.preventDefault?t.preventDefault():t.returnValue=false}},{key:"prepareTitleLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getTitle()})}},{key:"prepareFixedSwitcherLayout",value:function e(){const t=this.getTextDataParam("IS_FIXED")==="Y";this._switcher=BX.create("span",{attrs:{className:"crm-entity-stream-section-top-fixed-btn"},events:{click:t?BX.delegate(this.unfasten,this):BX.delegate(this.fasten,this)}});if(t)BX.addClass(this._switcher,"crm-entity-stream-section-top-fixed-btn-active");if(!this.isReadOnly()&&!t){const e=this._history.getManager();if(!e.isSpotlightShowed()){e.setSpotlightShowed();BX.addClass(this._switcher,"crm-entity-stream-section-top-fixed-btn-spotlight");const t=new BX.SpotLight({targetElement:this._switcher,targetVertex:"middle-center",lightMode:false,id:"CRM_TIMELINE_FASTEN_SWITCHER",zIndex:900,top:-3,left:-1,autoSave:true,content:BX.message("CRM_TIMELINE_SPOTLIGHT_FASTEN_MESSAGE")});t.show()}}return this._switcher}},{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());const i=this.getStatusNode();if(main_core.Type.isDomNode(i)){main_core.Dom.append(i,t)}t.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));return t}},{key:"getStatusNode",value:function e(){return null}},{key:"onActivityCreate",value:function e(t,i){this._history.getManager().onActivityCreated(t,i)}},{key:"formatTime",value:function e(t){if(this.isFixed()){return this._fixedHistory.formatTime(t)}return this._history.formatTime(t)}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}},{key:"isCounterEnabled",value:function e(t){if(!BX.type.isDate(t)){return false}let i=new Date;i.setHours(0);i.setMinutes(0);i.setSeconds(0);i.setMilliseconds(0);i=i.getTime();let s=new Date;s.setHours(23);s.setMinutes(59);s.setSeconds(59);s.setMilliseconds(999);s=s.getTime();const n=t.getTime();return n<i||n>=i&&n<=s}}]);return t}(CompatibleItem);let Scheduled=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._schedule=null;e._deadlineNode=null;e._headerClickHandler=BX.delegate(e.onHeaderClick,babelHelpers.assertThisInitialized(e));e._setAsDoneButtonHandler=BX.delegate(e.onSetAsDoneButtonClick,babelHelpers.assertThisInitialized(e));return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){this._schedule=this.getSetting("schedule");if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"Scheduled. The field 'activityEditor' is not assigned."}if(this.hasPermissions()&&!this.verifyPermissions()){this.loadPermissions()}}},{key:"getTypeId",value:function e(){return Item.undefined}},{key:"verifyPermissions",value:function e(){const t=BX.prop.getInteger(this.getPermissions(),"USER_ID",0);return t<=0||t===this._schedule.getUserId()}},{key:"loadPermissions",value:function e(){BX.ajax({url:this._schedule.getServiceUrl(),method:"POST",dataType:"json",data:{ACTION:"GET_PERMISSIONS",TYPE_ID:this.getTypeId(),ID:this.getAssociatedEntityId()},onsuccess:this.onPermissionsLoad.bind(this)})}},{key:"onPermissionsLoad",value:function e(t){const i=BX.prop.getObject(t,"PERMISSIONS",null);if(!i){return}this.setPermissions(i);window.setTimeout(function(){this.refreshLayout()}.bind(this),0)}},{key:"getDeadline",value:function e(){return null}},{key:"hasDeadline",value:function e(){return BX.type.isDate(this.getDeadline())}},{key:"isCounterEnabled",value:function e(){if(this.isDone()){return this._existedStreamItemDeadLine&&History.isCounterEnabled(this._existedStreamItemDeadLine)}const t=this.getDeadline();return t&&History.isCounterEnabled(t)}},{key:"isIncomingChannel",value:function e(){return false}},{key:"getSourceId",value:function e(){return BX.prop.getInteger(this.getAssociatedEntityData(),"ID",0)}},{key:"onSetAsDoneCompleted",value:function e(t){if(!BX.prop.getBoolean(t,"COMPLETED")){return}this.markAsDone(true);this._schedule.onItemMarkedAsDone(this,{historyItemData:BX.prop.getObject(t,"HISTORY_ITEM")})}},{key:"onPosponeCompleted",value:function e(t){}},{key:"refreshDeadline",value:function e(){this._deadlineNode.innerHTML=this.formatDateTime(this.getDeadline())}},{key:"formatDateTime",value:function e(t){return this._schedule.formatDateTime(t)}},{key:"getWrapperClassName",value:function e(){return""}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon"}},{key:"isReadOnly",value:function e(){return this._schedule.isReadOnly()}},{key:"isEditable",value:function e(){return!this.isReadOnly()}},{key:"canPostpone",value:function e(){if(this.isReadOnly()){return false}if(this.isIncomingChannel()){return false}const t=BX.prop.getObject(this.getAssociatedEntityData(),"PERMISSIONS",{});return BX.prop.getBoolean(t,"POSTPONE",false)}},{key:"isDone",value:function e(){return BX.CrmActivityStatus.isFinal(BX.prop.getInteger(this.getAssociatedEntityData(),"STATUS",0))}},{key:"canComplete",value:function e(){if(this.isReadOnly()){return false}const t=BX.prop.getObject(this.getAssociatedEntityData(),"PERMISSIONS",{});return BX.prop.getBoolean(t,"COMPLETE",false)}},{key:"setAsDone",value:function e(t){}},{key:"prepareContent",value:function e(t){return null}},{key:"prepareLayout",value:function e(t){this._wrapper=this.prepareContent();if(this._wrapper){const e=BX.type.isPlainObject(t)?BX.prop.getBoolean(t,"add",true):true;if(e){const e=BX.type.isPlainObject(t)&&BX.type.isElementNode(t["anchor"])?t["anchor"]:null;if(e&&e.nextSibling){this._container.insertBefore(this._wrapper,e.nextSibling)}else{this._container.appendChild(this._wrapper)}}this.markAsTerminated(this._schedule.checkItemForTermination(this))}}},{key:"onHeaderClick",value:function e(t){this.view();t.preventDefault?t.preventDefault():t.returnValue=false}},{key:"onSetAsDoneButtonClick",value:function e(t){if(this.canComplete()){this.setAsDone(!this.isDone())}}},{key:"onActivityCreate",value:function e(t,i){this._schedule.getManager().onActivityCreated(t,i)}}],[{key:"isDone",value:function e(t){const i=BX.prop.getObject(t,"ASSOCIATED_ENTITY",{});return BX.CrmActivityStatus.isFinal(BX.prop.getInteger(i,"STATUS",0))}},{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(CompatibleItem);let Action=function(){function e(){babelHelpers.classCallCheck(this,e);this._id="";this._settings={};this._container=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"BX.CrmTimelineAction: Could not find container."}this.doInitialize()}},{key:"doInitialize",value:function e(){}},{key:"getId",value:function e(){return this._id}},{key:"getSetting",value:function e(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i}},{key:"layout",value:function e(){this.doLayout()}},{key:"doLayout",value:function e(){}}]);return e}();let Activity=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._activityEditor=null;e._entityData=null;e._item=null;e._isEnabled=true;return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){this._entityData=this.getSetting("entityData");if(!BX.type.isPlainObject(this._entityData)){throw"BX.Crm.Timeline.Actions.Activity. A required parameter 'entityData' is missing."}this._activityEditor=this.getSetting("activityEditor");if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"BX.Crm.Timeline.Actions.Activity. A required parameter 'activityEditor' is missing."}this._item=this.getSetting("item");this._isEnabled=this.getSetting("enabled",true)}},{key:"getActivityId",value:function e(){return BX.prop.getInteger(this._entityData,"ID",0)}},{key:"loadActivityCommunications",value:function e(t){this._activityEditor.getActivityCommunications(this.getActivityId(),(function(e){if(BX.type.isFunction(t)){t(e)}}),true)}},{key:"getItemData",value:function e(){return this._item?this._item.getData():null}}]);return t}(Action);let Email=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._clickHandler=BX.delegate(e.onClick,babelHelpers.assertThisInitialized(e));e._saveHandler=BX.delegate(e.onSave,babelHelpers.assertThisInitialized(e));return e}babelHelpers.createClass(t,[{key:"onClick",value:function e(t){const i={ownerType:BX.CrmEntityType.resolveName(BX.prop.getInteger(this._entityData,"OWNER_TYPE_ID",0)),ownerID:BX.prop.getInteger(this._entityData,"OWNER_ID",0),ownerUrl:BX.prop.getString(this._entityData,"OWNER_URL",""),ownerTitle:BX.prop.getString(this._entityData,"OWNER_TITLE",""),originalMessageID:BX.prop.getInteger(this._entityData,"ID",0),messageType:"RE"};if(BX.CrmActivityProvider&&top.BX.Bitrix24&&top.BX.Bitrix24.Slider){const e=this._activityEditor.addEmail(i);e.addOnSave(this._saveHandler)}else{this.loadActivityCommunications(BX.delegate((function(e){i["communications"]=BX.type.isArray(e)?e:[];i["communicationsLoaded"]=true;BX.CrmActivityEmail.prepareReply(i);const t=this._activityEditor.addEmail(i);t.addOnSave(this._saveHandler)}),this))}return BX.PreventDefault(t)}},{key:"onSave",value:function e(t,i){if(BX.type.isFunction(this._item.onActivityCreate)){this._item.onActivityCreate(t,i)}}}]);return t}(Activity);let HistoryEmail=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"doLayout",value:function e(){this._container.appendChild(BX.create("A",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}}))}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Email);let ScheduleEmail=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"doLayout",value:function e(){this._container.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}}))}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Email);let HistoryActivity=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"doInitialize",this).call(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"HistoryActivity. The field 'activityEditor' is not assigned."}}},{key:"getTitle",value:function e(){return BX.prop.getString(this.getAssociatedEntityData(),"SUBJECT","")}},{key:"getTypeDescription",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getInteger(t,"DIRECTION",0);const s=this.getTypeCategoryId();if(s===BX.CrmActivityType.email){return this.getMessage(i===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")}else if(s===BX.CrmActivityType.call){return this.getMessage(i===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")}else if(s===BX.CrmActivityType.meeting){return this.getMessage("meeting")}else if(s===BX.CrmActivityType.task){return this.getMessage("task")}else if(s===BX.CrmActivityType.provider){const e=BX.prop.getString(t,"PROVIDER_ID","");if(e==="CRM_WEBFORM"){return this.getMessage("webform")}else if(e==="CRM_SMS"){return this.getMessage("sms")}else if(e==="CRM_REQUEST"){return this.getMessage("activityRequest")}else if(e==="IMOPENLINES_SESSION"){return this.getMessage("openLine")}else if(e==="REST_APP"){return this.getMessage("restApplication")}else if(e==="VISIT_TRACKER"){return this.getMessage("visit")}else if(e==="ZOOM"){return this.getMessage("zoom")}}return""}},{key:"prepareTitleLayout",value:function e(){return BX.create("A",{attrs:{href:"#",className:"crm-entity-stream-content-event-title"},events:{click:this._headerClickHandler},text:this.getTypeDescription()})}},{key:"prepareTimeLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})}},{key:"prepareMarkLayout",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getInteger(t,"MARK_TYPE_ID",0);if(i<=0){return null}let s="";if(i===Mark.success){s="SuccessMark"}else if(i===Mark.renew){s="RenewMark"}if(s===""){return null}let n="";const a=this.getTypeCategoryId();if(a===BX.CrmActivityType.email){n=this.getMessage("email"+s)}else if(a===BX.CrmActivityType.call){n=this.getMessage("call"+s)}else if(a===BX.CrmActivityType.meeting){n=this.getMessage("meeting"+s)}else if(a===BX.CrmActivityType.task){n=this.getMessage("task"+s)}if(n===""){return null}return BX.create("SPAN",{props:{className:"crm-entity-stream-content-event-skipped"},text:n})}},{key:"prepareActions",value:function e(){if(this.isReadOnly()){return}const t=this.getTypeCategoryId();if(t===BX.CrmActivityType.email){this._actions.push(HistoryEmail.create("email",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor}))}}},{key:"prepareContextMenuItems",value:function e(){if(this._isMenuShown){return}const t=[];if(!this.isReadOnly()){if(this.isEditable()){t.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.edit,this)})}t.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id))t.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)});else t.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}return t}},{key:"view",value:function e(){this.closeContextMenu();const t=this.getAssociatedEntityData();const i=BX.prop.getInteger(t,"ID",0);if(i>0){this._activityEditor.viewActivity(i)}}},{key:"edit",value:function e(){this.closeContextMenu();const t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.activity){const e=this.getAssociatedEntityData();const t=BX.prop.getInteger(e,"ID",0);if(t>0){this._activityEditor.editActivity(t)}}}},{key:"processRemoval",value:function e(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";let t=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!t){t=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getRemoveMessage()})}t.open().then(BX.delegate(this.onRemovalConfirm,this),BX.delegate(this.onRemovalCancel,this))}},{key:"getRemoveMessage",value:function e(){return this.getMessage("removeConfirm")}},{key:"onRemovalConfirm",value:function e(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this.remove()}},{key:"onRemovalCancel",value:function e(){}},{key:"remove",value:function e(){const t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.activity){const e=this.getAssociatedEntityData();const t=BX.prop.getInteger(e,"ID",0);if(t>0){const e=this._activityEditor;const i=e.getItemById(t);if(i){e.deleteActivity(t,true)}else{const i=BX.util.add_url_param(e.getSetting("serviceUrl",""),{id:t,action:"get_activity",ownertype:e.getSetting("ownerType",""),ownerid:e.getSetting("ownerID","")});BX.ajax({url:i,method:"POST",dataType:"json",data:{ACTION:"GET_ACTIVITY",ID:t,OWNER_TYPE:e.getSetting("ownerType",""),OWNER_ID:e.getSetting("ownerID","")},onsuccess:BX.delegate((function(t){if(typeof t["ACTIVITY"]!=="undefined"){e._handleActivityChange(t["ACTIVITY"]);window.setTimeout(BX.delegate(this.remove,this),500)}}),this),onfailure:function(e){}})}}}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);babelHelpers.defineProperty(HistoryActivity,"messages",{});let Document=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getTitle",value:function e(){const t=BX.prop.getInteger(this._data,"TYPE_CATEGORY_ID",0);if(t===3){return BX.Loc.getMessage("CRM_TIMELINE_DOCUMENT_VIEWED")}return this.getMessage("document")}},{key:"prepareTitleLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:BX.delegate(this.editDocument,this)},text:this.getTitle()})]})}},{key:"prepareTitleStatusLayout",value:function e(){const t=BX.prop.getInteger(this._data,"TYPE_CATEGORY_ID",0);if(t===3){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-done"},text:BX.Loc.getMessage("CRM_TIMELINE_DOCUMENT_VIEWED_STATUS")})}if(t===2){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-sent"},text:BX.Loc.getMessage("CRM_TIMELINE_DOCUMENT_CREATED_STATUS")})}return null}},{key:"prepareTimeLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})}},{key:"isContextMenuEnabled",value:function e(){const t=BX.prop.getInteger(this._data,"TYPE_CATEGORY_ID",0);return t!==3}},{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());const i=this.prepareTitleStatusLayout();if(i){t.appendChild(i)}t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContent",value:function e(){const t=this.getTextDataParam("COMMENT","");const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-document"}});if(this.isFixed()){BX.addClass(i,"crm-entity-stream-section-top-fixed")}i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-document"}}));if(this.isContextMenuEnabled()){i.appendChild(this.prepareContextMenuButton())}if(!this.isReadOnly()){i.appendChild(this.prepareFixedSwitcherLayout())}const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));const n=this.prepareHeaderLayout();s.appendChild(n);const a=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},html:t});const r=BX.findChildByClassName(a,"document-title-link");if(r){BX.bind(r,"click",BX.proxy(this.editDocument,this))}s.appendChild(a);const o=this.prepareAuthorLayout();if(o){s.appendChild(o)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});s.appendChild(this._actionContainer);return i}},{key:"prepareActions",value:function e(){}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}},{key:"prepareContextMenuItems",value:function e(){const t=[];if(!this.isReadOnly()){t.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.editDocument,this)});t.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.confirmDelete,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id)){t.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)})}else{t.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}}return t}},{key:"confirmDelete",value:function e(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";let t=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!t){t=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getMessage("documentRemove")})}t.open().then(BX.delegate(this.onConfirmDelete,this),BX.DoNothing)}},{key:"onConfirmDelete",value:function e(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this.deleteDocument()}},{key:"deleteDocument",value:function e(){if(this._isRequestRunning){return}this._isRequestRunning=true;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"DELETE_DOCUMENT",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this.getId()},onsuccess:BX.delegate((function(e){this._isRequestRunning=false;if(BX.type.isNotEmptyString(e.ERROR)){alert(e.ERROR)}else{const e=this._history.findItemById(this._id);if(e instanceof t){e.clearAnimate()}const i=this._fixedHistory.findItemById(this._id);if(i instanceof t){i.clearAnimate()}}}),this),onfailure:BX.delegate((function(){this._isRequestRunning=false}),this)})}},{key:"editDocument",value:function e(){const t=this.getData().DOCUMENT_ID||0;if(t>0){let e="/bitrix/components/bitrix/crm.document.view/slider.php";e=BX.util.add_url_param(e,{documentId:t});if(BX.SidePanel){BX.SidePanel.Instance.open(e,{width:1060})}else{top.location.href=e}}}},{key:"updateWrapper",value:function e(){const t=this.getWrapper();if(t){const e=BX.findChildByClassName(t,"crm-entity-stream-content-detail");if(e){BX.adjust(e,{html:this.getTextDataParam("COMMENT","")});const t=BX.findChildByClassName(e,"document-title-link");if(t){BX.bind(t,"click",BX.proxy(this.editDocument,this))}}}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Item$1=function(){function e(){babelHelpers.classCallCheck(this,e);this._id="";this._settings={};this._initialItem=null;this._finalItem=null;this._events=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._initialItem=this.getSetting("initialItem");this._finalItem=this.getSetting("finalItem");this._anchor=this.getSetting("anchor");this._events=this.getSetting("events",{})}},{key:"getId",value:function e(){return this._id}},{key:"getSetting",value:function e(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i}},{key:"run",value:function e(){this._node=this._initialItem.getWrapper();const t=BX.pos(this._node);this._initialYPosition=t.top;this._initialXPosition=t.left;this._initialWidth=this._node.offsetWidth;this._initialHeight=this._node.offsetHeight;this._anchorYPosition=BX.pos(this._anchor).top;this.createStub();this.createGhost();this.moveGhost()}},{key:"createStub",value:function e(){this._stub=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-planned crm-entity-stream-section-shadow"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon"}}),BX.create("DIV",{props:{className:"crm-entity-stream-section-content"},style:{height:this._initialHeight+"px"}})]});this._node.parentNode.insertBefore(this._stub,this._node)}},{key:"createGhost",value:function e(){this._ghostNode=this._node;this._ghostNode.style.position="absolute";this._ghostNode.style.width=this._initialWidth+"px";this._ghostNode.style.height=this._initialHeight+"px";this._ghostNode.style.top=this._initialYPosition+"px";this._ghostNode.style.left=this._initialXPosition+"px";document.body.appendChild(this._ghostNode);setTimeout(BX.proxy((function(){BX.addClass(this._ghostNode,"crm-entity-stream-section-casper")}),this),20)}},{key:"moveGhost",value:function e(){const t=this._ghostNode;const i=new BX.easing({duration:500,start:{top:this._initialYPosition},finish:{top:this._anchorYPosition},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(e){t.style.top=e.top+"px"}),this)});setTimeout(BX.proxy((function(){i.animate();t.style.boxShadow=""}),this),500);const s=new BX.easing({duration:500,start:{height:0},finish:{height:this._initialHeight+20},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(e){this._anchor.style.height=e.height+"px"}),this),complete:BX.proxy((function(){if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}this.addHistoryItem();this.removeGhost()}),this)});setTimeout((function(){s.animate()}),500)}},{key:"addHistoryItem",value:function e(){const t=this._finalItem.getWrapper();this._anchor.parentNode.insertBefore(t,this._anchor.nextSibling);this._finalItemHeight=this._anchor.offsetHeight-t.offsetHeight;this._anchor.style.height=0;t.style.marginBottom=this._finalItemHeight+"px"}},{key:"removeGhost",value:function e(){const t=this._ghostNode;const i=this._finalItem.getWrapper();t.style.overflow="hidden";const s=new BX.easing({duration:70,start:{opacity:100,height:t.offsetHeight,marginBottom:this._finalItemHeight},finish:{opacity:0,height:i.offsetHeight,marginBottom:20},step:BX.proxy((function(e){t.style.opacity=e.opacity/100;t.style.height=e.height+"px";i.style.marginBottom=e.marginBottom+"px"}),this),complete:BX.proxy((function(){t.remove();i.style.marginBottom="";this.collapseStub()}),this)});s.animate()}},{key:"collapseStub",value:function e(){const t=new BX.easing({duration:500,start:{opacity:100,height:this._initialHeight,marginBottom:15},finish:{opacity:0,height:0,marginBottom:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(e){this._stub.style.height=e.height+"px";this._stub.style.marginBottom=e.marginBottom+"px";this._stub.style.opacity=e.opacity/100}),this),complete:BX.proxy((function(){this.inited=false}),this)});t.animate()}}],[{key:"create",value:function t(i,s){const n=new e;n.initialize(i,s);return n}}]);return e}();let Shift=function(){function e(){babelHelpers.classCallCheck(this,e);this._node=null;this._anchor=null;this._nodeParent=null;this._startPosition=null;this._events=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i,s,n,a){this._node=t;this._shadowNode=n;this._anchor=i;this._nodeParent=t.parentNode;this._startPosition=s;this._events=BX.type.isPlainObject(a)?a:{}}},{key:"run",value:function e(){this._anchorPosition=BX.pos(this._anchor);setTimeout(BX.proxy((function(){BX.addClass(this._node,"crm-entity-stream-section-casper")}),this),0);const t=new BX.easing({duration:1500,start:{top:this._startPosition.top,height:0},finish:{top:this._anchorPosition.top,height:this._startPosition.height+20},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(e){this._node.style.top=e.top+"px";this._anchor.style.height=e.height+"px"}),this),complete:BX.proxy((function(){this.finish()}),this)});t.animate()}},{key:"finish",value:function e(){if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}if(this._shadowNode!==false);}}],[{key:"create",value:function t(i,s,n,a,r){const o=new e;o.initialize(i,s,n,a,r);return o}}]);return e}();let ItemNew=function(){function e(){babelHelpers.classCallCheck(this,e);this._id="";this._settings={};this._initialItem=null;this._finalItem=null;this._events=null;this._areAnimatedItemsVisible=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._initialItem=this.getSetting("initialItem");this._finalItem=this.getSetting("finalItem");this._anchor=this.getSetting("anchor");this._events=this.getSetting("events",{})}},{key:"getId",value:function e(){return this._id}},{key:"getSetting",value:function e(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i}},{key:"addHistoryItem",value:function e(){const t=this._finalItem.getWrapper();this._anchor.parentNode.insertBefore(t,this._anchor.nextSibling)}},{key:"run",value:function e(){this._node=this._initialItem.getWrapper();this._areAnimatedItemsVisible=this._node.offsetParent!==null;if(this._areAnimatedItemsVisible){this.createStub();BX.addClass(this._node,"crm-entity-stream-section-animate-start");this._startPosition=BX.pos(this._stub);this._node.style.position="absolute";this._node.style.width=this._startPosition.width+"px";this._node.style.height=this._startPosition.height+"px";this._node.style.top=this._startPosition.top+"px";this._node.style.left=this._startPosition.left+"px";this._node.style.zIndex=960;document.body.appendChild(this._node);const e=Shift.create(this._node,this._anchor,this._startPosition,this._stub,{complete:BX.delegate(this.finish,this)});e.run()}else{this.finish()}}},{key:"createStub",value:function e(){this._stub=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-planned crm-entity-stream-section-shadow"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon"}}),BX.create("DIV",{props:{className:"crm-entity-stream-section-content"},style:{height:this._initialItem._wrapper.clientHeight+"px"}})]});this._node.parentNode.insertBefore(this._stub,this._node)}},{key:"finish",value:function e(){this._anchor.style.height=0;if(this._areAnimatedItemsVisible){const e=this._stub.querySelector(".crm-entity-stream-section-content");setTimeout(BX.delegate((function(){BX.removeClass(this._node,"crm-entity-stream-section-animate-start")}),this),0);this._node.style.opacity=0;setTimeout(BX.delegate((function(){e.style.height=0;e.style.opacity=0;e.style.paddingTop=0;e.style.paddingBottom=0}),this),120)}setTimeout(BX.delegate((function(){if(this._areAnimatedItemsVisible){BX.remove(this._stub)}BX.remove(this._node);this.addHistoryItem();if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}}),this),420)}}],[{key:"create",value:function t(i,s){const n=new e;n.initialize(i,s);return n}}]);return e}();let Steam=function(){function e(){babelHelpers.classCallCheck(this,e);this._id="";this._settings={};this._container=null;this._manager=null;this._activityEditor=null;this._timeFormat="";this._year=0;this._isStubMode=false;this._userId=0;this._readOnly=false;this._streamType=crm_timeline_item.StreamType.history;this._anchor=null;this._serviceUrl=""}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._container=BX(this.getSetting("container"));if(!BX.type.isElementNode(this._container)){throw"Timeline. Container node is not found."}this._editorContainer=BX(this.getSetting("editorContainer"));this._manager=this.getSetting("manager");if(!(this._manager instanceof Manager)){throw"Timeline. Manager instance is not found."}const s=BX.message("FORMAT_DATETIME").replace(/:SS/,"");const n=BX.message("FORMAT_DATE");this._timeFormat=BX.date.convertBitrixFormat(BX.util.trim(s.replace(n,"")));this._year=(new Date).getFullYear();this._activityEditor=this.getSetting("activityEditor");this._isStubMode=BX.prop.getBoolean(this._settings,"isStubMode",false);this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);this._userId=BX.prop.getInteger(this._settings,"userId",0);this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this.doInitialize()}},{key:"getId",value:function e(){return this._id}},{key:"isScheduleStream",value:function e(){return this.getStreamType()===crm_timeline_item.StreamType.scheduled}},{key:"isFixedHistoryStream",value:function e(){return this.getStreamType()===crm_timeline_item.StreamType.pinned}},{key:"isHistoryStream",value:function e(){return this.getStreamType()===crm_timeline_item.StreamType.history}},{key:"getSetting",value:function e(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i}},{key:"doInitialize",value:function e(){}},{key:"layout",value:function e(){}},{key:"isStubMode",value:function e(){return this._isStubMode}},{key:"isReadOnly",value:function e(){return this._readOnly}},{key:"getUserId",value:function e(){return this._userId}},{key:"getServiceUrl",value:function e(){return this._serviceUrl}},{key:"getAnchor",value:function e(){return this._anchor}},{key:"getStreamType",value:function e(){return this._streamType}},{key:"refreshLayout",value:function e(){}},{key:"getManager",value:function e(){return this._manager}},{key:"getOwnerInfo",value:function e(){return this._manager.getOwnerInfo()}},{key:"reload",value:function e(){const t=this.getSetting("currentUrl");const i=this.getSetting("ajaxId");if(i!==""){BX.ajax.insertToNode(BX.util.add_url_param(t,{bxajaxid:i}),"comp_"+i)}else{window.location=t}}},{key:"getUserTimezoneOffset",value:function e(){return crm_datetime.TimezoneOffset.USER_TO_SERVER}},{key:"getServerTimezoneOffset",value:function e(){return crm_datetime.TimezoneOffset.SERVER_TO_UTC}},{key:"formatTime",value:function e(t,i,s){return BX.date.format(this._timeFormat,t,i,s)}},{key:"formatDate",value:function e(t){return BX.date.format([["today","today"],["tommorow","tommorow"],["yesterday","yesterday"],["",t.getFullYear()===this._year?crm_datetime.Format.DAY_MONTH_FORMAT:crm_datetime.Format.LONG_DATE_FORMAT]],t)}},{key:"cutOffText",value:function e(t,i){if(!BX.type.isNumber(i)){i=0}if(i<=0||t.length<=i){return t}let s=i-1;const n=t.substring(s).search(/\s/i);if(n>0){s+=n}return t.substring(0,s)+"..."}},{key:"getItems",value:function e(){return[]}},{key:"setItems",value:function e(t){throw new Error("Stream.setItems() must be overridden")}},{key:"getLastItem",value:function e(){const t=this.getItems();return t.length>0?t[t.length-1]:null}},{key:"findItemById",value:function e(t){t=t.toString();return this.getItems().find((e=>e.getId()===t))||null}},{key:"getItemIndex",value:function e(t){return this.getItems().findIndex((e=>e===t))}},{key:"removeItemByIndex",value:function e(t){const i=this.getItems();if(t<i.length){i.splice(t,1);this.setItems(i)}}},{key:"createItem",value:function e(t){throw new Error("Stream.createItem() must be overridden")}},{key:"createItemCopy",value:function e(t){if(t instanceof crm_timeline_item.ConfigurableItem){return t.clone()}return this.createItem(t.getData())}},{key:"refreshItem",value:function e(t,i=true,s){const n=this.getItemIndex(t);if(n<0){return Promise.resolve()}this.removeItemByIndex(n);let a=false;let r=0;let o;if(this.isScheduleStream()){o=this.createItemCopy(t);r=this.calculateItemIndex(o);a=r!==n}if(!a){this.addItem(t,r);t.refreshLayout();if(i){return this.animateItemAdding(t)}return Promise.resolve()}const l=this.createAnchor(r);this.addItem(o,r);if(s){o.layout({add:false});return new Promise((e=>{const i=Item$1.create("",{initialItem:t,finalItem:o,anchor:l,events:{complete:()=>{t.destroy();e()}}});i.run()}))}else{o.layout({anchor:l});t.destroy();return Promise.resolve()}}},{key:"calculateItemIndex",value:function e(t){return 0}},{key:"createAnchor",value:function e(t){return null}},{key:"addItem",value:function e(t,i){throw new Error("Stream.addItem() must be overridden")}},{key:"deleteItem",value:function e(t){throw new Error("Stream.deleteItem() must be overridden")}},{key:"deleteItemAnimated",value:function e(t){if(!main_core.Type.isDomNode(t.getWrapper())){this.deleteItem(t);return Promise.resolve()}return new Promise((e=>{const i=main_core.Dom.getPosition(t.getWrapper());const s=new BX.easing({duration:1e3,start:{height:i.height,opacity:1,marginBottom:15},finish:{height:0,opacity:0,marginBottom:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:e=>{main_core.Dom.style(t.getWrapper(),{height:e.height+"px",opacity:e.opacity,marginBottom:e.marginBottom})},complete:()=>{this.deleteItem(t);e()}});s.animate()}))}},{key:"moveItemToStream",value:function e(t,i,s){this.removeItemByIndex(this.getItemIndex(t));if(this.getItems().length>0){this.refreshLayout()}return new Promise((e=>{const n=ItemNew.create("",{initialItem:t,finalItem:s,anchor:i.createAnchor(),events:{complete:()=>{this.refreshLayout();i.refreshLayout();e()}}});n.run()}))}},{key:"animateItemAdding",value:function e(t){return Promise.resolve()}}]);return e}();let EntityChat=function(_Stream){babelHelpers.inherits(EntityChat,_Stream);function EntityChat(){var e;babelHelpers.classCallCheck(this,EntityChat);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(EntityChat).call(this));e._data=null;e._layoutType=EntityChat.LayoutType.none;e._wrapper=null;e._contentWrapper=null;e._messageWrapper=null;e._messageDateNode=null;e._messageTexWrapper=null;e._messageTextNode=null;e._userWrapper=null;e._extraUserCounter=null;e._openChatHandler=BX.delegate(e.onOpenChat,babelHelpers.assertThisInitialized(e));return e}babelHelpers.createClass(EntityChat,[{key:"doInitialize",value:function e(){this._data=BX.prop.getObject(this._settings,"data",{})}},{key:"getData",value:function e(){return this._data}},{key:"setData",value:function e(t){this._data=BX.type.isPlainObject(t)?t:{}}},{key:"isEnabled",value:function e(){return BX.prop.getBoolean(this._data,"ENABLED",true)}},{key:"isRestricted",value:function e(){return BX.prop.getBoolean(this._data,"IS_RESTRICTED",false)}},{key:"applyLockScript",value:function applyLockScript(){const lockScript=BX.prop.getString(this._data,"LOCK_SCRIPT",null);if(BX.Type.isString(lockScript)&&lockScript!==""){eval(lockScript)}}},{key:"getChatId",value:function e(){return BX.prop.getInteger(this._data,"CHAT_ID",0)}},{key:"getUserId",value:function e(){const t=parseInt(top.BX.message("USER_ID"));return!isNaN(t)?t:0}},{key:"getMessageData",value:function e(){return BX.prop.getObject(this._data,"MESSAGE",{})}},{key:"setMessageData",value:function e(t){this._data["MESSAGE"]=BX.type.isPlainObject(t)?t:{}}},{key:"getUserInfoData",value:function e(){return BX.prop.getObject(this._data,"USER_INFOS",{})}},{key:"setUserInfoData",value:function e(t){this._data["USER_INFOS"]=BX.type.isPlainObject(t)?t:{}}},{key:"hasUserInfo",value:function e(t){return t>0&&BX.type.isPlainObject(this.getUserInfoData()[t])}},{key:"getUserInfo",value:function e(t){const i=this.getUserInfoData();return t>0&&BX.type.isPlainObject(i[t])?i[t]:null}},{key:"removeUserInfo",value:function e(t){const i=this.getUserInfoData();if(t>0&&BX.type.isPlainObject(i[t])){delete i[t]}}},{key:"setUnreadMessageCounter",value:function e(t,i){const s=this.getUserInfoData();if(t>0&&BX.type.isPlainObject(s[t])){s[t]["counter"]=i}}},{key:"layout",value:function e(){if(!this.isEnabled()||this.isStubMode()){return}this._wrapper=BX.create("div",{props:{className:"crm-entity-stream-section crm-entity-stream-section-live-im"}});this._container.appendChild(this._wrapper);this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-live-im"}}));this._contentWrapper=BX.create("div",{props:{className:"crm-entity-stream-content-live-im-detail"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-stream-section-content"},children:[BX.create("div",{props:{className:"crm-entity-stream-content-event"},children:[this._contentWrapper]})]}));this._userWrapper=BX.create("div",{props:{className:"crm-entity-stream-live-im-user-avatars"}});this._contentWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-stream-live-im-users"},children:[this._userWrapper]}));this._extraUserCounter=BX.create("div",{props:{className:"crm-entity-stream-live-im-user-counter"}});this._contentWrapper.appendChild(this._extraUserCounter);this._layoutType=EntityChat.LayoutType.none;if(this.getChatId()>0){this.renderSummary()}else{this.renderInvitation()}BX.bind(this._contentWrapper,"click",this._openChatHandler);BX.addCustomEvent("onPullEvent-im",this.onChatEvent.bind(this))}},{key:"refreshLayout",value:function e(){BX.cleanNode(this._contentWrapper);this._userWrapper=BX.create("div",{props:{className:"crm-entity-stream-live-im-user-avatars"}});this._contentWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-stream-live-im-users"},children:[this._userWrapper]}));this._extraUserCounter=BX.create("div",{props:{className:"crm-entity-stream-live-im-user-counter"}});this._contentWrapper.appendChild(this._extraUserCounter);this._layoutType=EntityChat.LayoutType.none;if(this.getChatId()>0){this.renderSummary()}else{this.renderInvitation()}}},{key:"renderInvitation",value:function e(){this._layoutType=EntityChat.LayoutType.invitation;this.refreshUsers();this._messageTextNode=BX.create("div",{props:{className:"crm-entity-stream-live-im-user-invite-text"}});this._contentWrapper.appendChild(this._messageTextNode);this._messageTextNode.innerHTML=this.getMessage("invite")}},{key:"renderSummary",value:function e(){this._layoutType=EntityChat.LayoutType.summary;this.refreshUsers();this._contentWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-stream-live-im-separator"}}));this._messageWrapper=BX.create("div",{props:{className:"crm-entity-stream-live-im-messanger"}});this._contentWrapper.appendChild(this._messageWrapper);this._messageDateNode=BX.create("div",{props:{className:"crm-entity-stream-live-im-time"}});this._messageWrapper.appendChild(this._messageDateNode);this._messageTexWraper=BX.create("div",{props:{className:"crm-entity-stream-live-im-message"}});this._messageWrapper.appendChild(this._messageTexWraper);this._messageTextNode=BX.create("div",{props:{className:"crm-entity-stream-live-im-message-text"}});this._messageTexWraper.appendChild(this._messageTextNode);this._messageCounterNode=BX.create("div",{props:{className:"crm-entity-stream-live-im-message-counter"}});this._messageWrapper.appendChild(this._messageCounterNode);this.refreshSummary()}},{key:"refreshUsers",value:function e(){BX.cleanNode(this._userWrapper);const t=this.getUserInfoData();const i=Object.values(t);if(i.length===0){this._userWrapper.appendChild(BX.create("span",{props:{className:"crm-entity-stream-live-im-user-avatar ui-icon ui-icon-common-user"},children:[BX.create("i")]}))}else{const e=i.length>=3?3:i.length;for(let t=0;t<e;t++){const e=i[t];const s=BX.create("i");const n=BX.prop.getString(e,"avatar","");if(n!==""){s.style.backgroundImage="url("+encodeURI(n)+")"}this._userWrapper.appendChild(BX.create("span",{props:{className:"crm-entity-stream-live-im-user-avatar ui-icon ui-icon-common-user"},children:[s]}))}}if(this._layoutType===EntityChat.LayoutType.summary){if(i.length>3){this._extraUserCounter.display="";this._extraUserCounter.innerHTML="+"+(i.length-3).toString()}else{if(this._extraUserCounter.innerHTML!==""){this._extraUserCounter.innerHTML=""}this._extraUserCounter.display="none"}}else{if(this._extraUserCounter.innerHTML!==""){this._extraUserCounter.innerHTML=""}this._extraUserCounter.display="none";this._userWrapper.appendChild(BX.create("span",{props:{className:"crm-entity-stream-live-im-user-invite-btn"}}))}}},{key:"refreshSummary",value:function e(){if(this._layoutType!==EntityChat.LayoutType.summary){return}const t=this.getMessageData();const i=BX.prop.getString(t,"date","");if(i===""){this._messageDateNode.innerHTML=""}else{const e=new Date(i).getTime()/1e3+this.getServerTimezoneOffset()+this.getUserTimezoneOffset();const t=(new Date).getTime()/1e3+this.getServerTimezoneOffset()+this.getUserTimezoneOffset();this._messageDateNode.innerHTML=this.formatTime(e,t,true)}let s=BX.prop.getString(t,"text","");const n=BX.prop.getObject(t,"params",{});if(s===""){this._messageTextNode.innerHTML=""}else{if(typeof top.BX.MessengerCommon!=="undefined"){s=top.BX.MessengerCommon.purifyText(s,n)}this._messageTextNode.innerHTML=s}let a=0;const r=this.getUserId();if(r>0){a=BX.prop.getInteger(BX.prop.getObject(BX.prop.getObject(this._data,"USER_INFOS",{}),r,null),"counter",0)}this._messageCounterNode.innerHTML=a.toString();this._messageCounterNode.style.display=a>0?"":"none"}},{key:"refreshUsersAnimated",value:function e(){BX.removeClass(this._userWrapper,"crm-entity-stream-live-im-message-show");BX.addClass(this._userWrapper,"crm-entity-stream-live-im-message-hide");window.setTimeout(function(){this.refreshUsers();window.setTimeout(function(){BX.removeClass(this._userWrapper,"crm-entity-stream-live-im-message-hide");BX.addClass(this._userWrapper,"crm-entity-stream-live-im-message-show")}.bind(this),50)}.bind(this),500)}},{key:"refreshSummaryAnimated",value:function e(){BX.removeClass(this._messageWrapper,"crm-entity-stream-live-im-message-show");BX.addClass(this._messageWrapper,"crm-entity-stream-live-im-message-hide");window.setTimeout(function(){this.refreshSummary();window.setTimeout(function(){BX.removeClass(this._messageWrapper,"crm-entity-stream-live-im-message-hide");BX.addClass(this._messageWrapper,"crm-entity-stream-live-im-message-show")}.bind(this),50)}.bind(this),500)}},{key:"onOpenChat",value:function e(t){if(typeof top.BXIM==="undefined"){return}if(this.isRestricted()){this.applyLockScript();return}let i="";const s=this.getChatId();if(s>0&&this.hasUserInfo(this.getUserId())){i="chat"+s.toString()}else{const e=this.getOwnerInfo();const t=BX.prop.getInteger(e,"ENTITY_ID",0);const s=BX.prop.getString(e,"ENTITY_TYPE_NAME","");if(s!==""&&t>0){i="crm|"+s+"|"+t.toString()}}if(i!==""){top.BXIM.openMessengerSlider(i,{RECENT:"N",MENU:"N"})}}},{key:"onChatEvent",value:function e(t,i,s){const n=this.getChatId();if(n<=0||n!==BX.prop.getInteger(i,"chatId",0)){return}if(t==="chatUserAdd"){this.setUserInfoData(BX.mergeEx(this.getUserInfoData(),BX.prop.getObject(i,"users",{})));this.refreshUsersAnimated()}else if(t==="chatUserLeave"){this.removeUserInfo(BX.prop.getInteger(i,"userId",0));this.refreshUsersAnimated()}else if(t==="messageChat"){this.setMessageData(BX.prop.getObject(i,"message",{}));this.setUnreadMessageCounter(this.getUserId(),BX.prop.getInteger(i,"counter",0));this.refreshSummaryAnimated()}else if(t==="messageUpdate"||t==="messageDelete"){if(t==="messageDelete"){delete i["date"]}const e=this.getMessageData();if(BX.prop.getInteger(e,"id",0)===BX.prop.getInteger(i,"id",0)){this.setMessageData(BX.mergeEx(e,i));this.refreshSummaryAnimated()}}else if(t==="readMessageChat"){this.setUnreadMessageCounter(this.getUserId(),0);this.refreshSummaryAnimated()}else if(t==="unreadMessageChat"){this.setUnreadMessageCounter(this.getUserId(),BX.prop.getInteger(i,"counter",0));this.refreshSummaryAnimated()}}},{key:"getMessage",value:function e(t){return BX.prop.getString(EntityChat.messages,t,t)}}],[{key:"create",value:function e(t,i){const s=new EntityChat;s.initialize(t,i);EntityChat.items[s.getId()]=s;return s}}]);return EntityChat}(Steam);babelHelpers.defineProperty(EntityChat,"LayoutType",{none:0,invitation:1,summary:2});babelHelpers.defineProperty(EntityChat,"items",{});babelHelpers.defineProperty(EntityChat,"messages",{});let MenuBar=function(){function e(){babelHelpers.classCallCheck(this,e);this._id="";this._ownerInfo=null;this._container=null;this._activityEditor=null;this._commentEditor=null;this._todoEditor=null;this._waitEditor=null;this._smsEditor=null;this._zoomEditor=null;this._readOnly=false;this._menu=null;this._manager=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._ownerInfo=BX.prop.getObject(this._settings,"ownerInfo");if(!this._ownerInfo){throw"MenuBar. A required parameter 'ownerInfo' is missing."}this._activityEditor=BX.prop.get(this._settings,"activityEditor",null);this._commentEditor=BX.prop.get(this._settings,"commentEditor");this._todoEditor=BX.prop.get(this._settings,"todoEditor");this._waitEditor=BX.prop.get(this._settings,"waitEditor");this._smsEditor=BX.prop.get(this._settings,"smsEditor");this._zoomEditor=BX.prop.get(this._settings,"zoomEditor");this._restEditor=BX.prop.get(this._settings,"restEditor");this._manager=BX.prop.get(this._settings,"manager");if(!(this._manager instanceof Manager)){throw"BX.CrmTimeline. Manager instance is not found."}this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);this._menu=BX.Main.interfaceButtonsManager.getById(BX.prop.getString(this._settings,"menuId",(this._ownerInfo["ENTITY_TYPE_NAME"]+"_menu").toLowerCase()));BX.addCustomEvent(this._manager.getId()+"_menu",function(e){this.setActiveItemById(e)}.bind(this));this._activeItem=this._menu.getActive()}},{key:"reset",value:function e(){let t=null;this._menu.getAllItems().forEach(function(e){if(t===null){const i=e.dataset.id;if(["comment","wait","sms","zoom","todo"].indexOf(i)>=0&&this["_"+i+"Editor"]){t=i}}}.bind(this));this.setActiveItemById(t||"todo")}},{key:"getId",value:function e(){return this._id}},{key:"getActiveItem",value:function e(){return this._activeItem}},{key:"getTodoEditor",value:function e(){return this._todoEditor}},{key:"setActiveItemById",value:function e(t){if(this.processItemSelection(t)===true){const e=this._menu.getItemById(t);if(e&&this._activeItem!==e){const t=this._menu.isActiveInMoreMenu();BX.addClass(e,this._menu.classes.itemActive);if(this._menu.getItemData){const t=this._menu.getItemData(e);t["IS_ACTIVE"]=true;if(BX.type.isDomNode(this._activeItem)){BX.removeClass(this._activeItem,this._menu.classes.itemActive);const e=this._menu.getItemData(this._activeItem);e["IS_ACTIVE"]=false}}else{let t={};try{t=JSON.parse(e.dataset.item)}catch(e){t={}}t.IS_ACTIVE=true;e.dataset.item=JSON.stringify(t);let i={};if(BX.type.isDomNode(this._activeItem)){BX.removeClass(this._activeItem,this._menu.classes.itemActive);try{i=JSON.parse(this._activeItem.dataset.item)}catch(e){i={}}i.IS_ACTIVE=false;this._activeItem.dataset.item=JSON.stringify(i)}}const i=this._menu.isActiveInMoreMenu();if(i||t){const s=this._menu["getSubmenu"]?this._menu.getSubmenu():BX.PopupMenu.getMenuById("main_buttons_popup_"+String(this._ownerInfo["ENTITY_TYPE_NAME"]).toLowerCase()+"_menu");if(s){s.getMenuItems().forEach(function(s){const n=s.getContainer();if(i&&n.title===e.title){BX.addClass(n,this._menu.classes.itemActive)}else if(t&&n.title===this._activeItem.title){BX.removeClass(n,this._menu.classes.itemActive)}}.bind(this))}if(i){BX.addClass(this._menu.getMoreButton(),this._menu.classes.itemActive)}else if(t){BX.removeClass(this._menu.getMoreButton(),this._menu.classes.itemActive)}}this._activeItem=e}}this._menu.closeSubmenu()}},{key:"processItemSelection",value:function e(t){if(this._readOnly){return false}let i=null;const s=t;if(s==="call"){i=new BX.Crm.Activity.Planner;i.showEdit({TYPE_ID:BX.CrmActivityType.call,OWNER_TYPE_ID:this._ownerInfo["ENTITY_TYPE_ID"],OWNER_ID:this._ownerInfo["ENTITY_ID"]})}if(s==="meeting"){i=new BX.Crm.Activity.Planner;i.showEdit({TYPE_ID:BX.CrmActivityType.meeting,OWNER_TYPE_ID:this._ownerInfo["ENTITY_TYPE_ID"],OWNER_ID:this._ownerInfo["ENTITY_ID"]})}else if(s==="email"){this._activityEditor.addEmail({ownerType:this._ownerInfo["ENTITY_TYPE_NAME"],ownerID:this._ownerInfo["ENTITY_ID"],ownerUrl:this._ownerInfo["SHOW_URL"],ownerTitle:this._ownerInfo["TITLE"],subject:""})}else if(s==="delivery"){this._activityEditor.addDelivery({ownerType:this._ownerInfo["ENTITY_TYPE_NAME"],ownerID:this._ownerInfo["ENTITY_ID"],orderList:this._ownerInfo["ORDER_LIST"]})}else if(s==="task"){this._activityEditor.addTask({ownerType:this._ownerInfo["ENTITY_TYPE_NAME"],ownerID:this._ownerInfo["ENTITY_ID"]})}else if(["comment","wait","sms","zoom","todo"].indexOf(s)>=0&&this["_"+s+"Editor"]){if(this._commentEditor){this._commentEditor.setVisible(s==="comment")}if(this._todoEditor){this._todoEditor.setVisible(s==="todo")}if(this._waitEditor){this._waitEditor.setVisible(s==="wait")}if(this._smsEditor){this._smsEditor.setVisible(s==="sms")}if(this._zoomEditor){this._zoomEditor.setVisible(s==="zoom")}return true}else if(s==="visit"){const e=this._manager.getSetting("visitParameters");e["OWNER_TYPE"]=this._ownerInfo["ENTITY_TYPE_NAME"];e["OWNER_ID"]=this._ownerInfo["ENTITY_ID"];BX.CrmActivityVisit.create(e).showEdit()}else if(s.match(/^activity_rest_/)){if(this._restEditor){this._restEditor.action(s)}}return false}},{key:"getMenuItems",value:function e(){return this._menu.getAllItems()}}],[{key:"create",value:function t(i,s){const n=new e;n.initialize(i,s);return n}}]);return e}();let AudioPlaybackRateSelector=function(){function e(t){babelHelpers.classCallCheck(this,e);this.name=t.name||"crm-timeline-audio-playback-rate-selector";this.menuId=this.name+"-menu";if(BX.Type.isArray(t.availableRates)){this.availableRates=t.availableRates}else{this.availableRates=[1,1.5,2,3]}this.currentRate=this.normalizeRate(t.currentRate);this.textMessageCode=t.textMessageCode;this.renderedItems=[];this.players=[]}babelHelpers.createClass(e,[{key:"isRateCurrent",value:function e(t,i){return t.rate&&i===t.rate||i===t}},{key:"normalizeRate",value:function e(t){t=parseFloat(t);let i=0;const s=this.availableRates.length;for(;i<s;i++){if(this.isRateCurrent(this.availableRates[i],t)){return t}}return this.availableRates[0].rate||this.availableRates[0]}},{key:"getMenuItems",value:function e(){const t=this.getRate();return this.availableRates.map(function(e){return{text:(e.text||e)+"",html:(e.html||e)+"",className:this.isRateCurrent(e,t)?"menu-popup-item-text-active":null,onclick:function(){this.setRate(e.rate||e)}.bind(this)}}.bind(this))}},{key:"getPopup",value:function e(t){let i=BX.Main.MenuManager.getMenuById(this.menuId);if(i){const e=i.getPopupWindow();if(e){e.setBindElement(t)}}else{i=BX.Main.MenuManager.create({id:this.menuId,bindElement:t,items:this.getMenuItems(),className:"crm-audio-cap-speed-popup"})}return i}},{key:"getRate",value:function e(){return this.normalizeRate(this.currentRate)}},{key:"setRate",value:function e(t){this.getPopup().destroy();t=this.normalizeRate(t);if(this.currentRate===t){return}this.currentRate=t;BX.userOptions.save("crm",this.name,"rate",t);for(let e=0,t=this.renderedItems.length;e<t;e++){const t=this.renderedItems[e].querySelector(".crm-audio-cap-speed-text");if(t){t.innerHTML=this.getText()}}for(let e=0,t=this.players.length;e<t;e++){this.players[e].vjsPlayer.playbackRate(this.getRate())}}},{key:"getText",value:function e(){let t;if(this.textMessageCode){t=BX.Loc.getMessage(this.textMessageCode)}if(!t){t="#RATE#"}return t.replace("#RATE#","<span>"+this.getRate()+"x</span>")}},{key:"render",value:function e(){const t=BX.Dom.create("div",{attrs:{className:"crm-audio-cap-speed-wrapper"},children:[BX.Dom.create("div",{attrs:{className:"crm-audio-cap-speed"},children:[BX.Dom.create("div",{attrs:{className:"crm-audio-cap-speed-text"},html:this.getText()})]})],events:{click:function(e){e.preventDefault();this.getPopup(e.target).show()}.bind(this)}});this.renderedItems.push(t);return t}},{key:"addPlayer",value:function e(t){if(BX.Fileman.Player&&t instanceof BX.Fileman.Player){this.players.push(t)}}}]);return e}();let SchedulePostponeController=function(){function e(){babelHelpers.classCallCheck(this,e);this._item=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._item=BX.prop.get(this._settings,"item",null)}},{key:"getTitle",value:function e(){return this.getMessage("title")}},{key:"getCommandList",value:function e(){return[{name:"postpone_hour_1",title:this.getMessage("forOneHour")},{name:"postpone_hour_2",title:this.getMessage("forTwoHours")},{name:"postpone_hour_3",title:this.getMessage("forThreeHours")},{name:"postpone_day_1",title:this.getMessage("forOneDay")},{name:"postpone_day_2",title:this.getMessage("forTwoDays")},{name:"postpone_day_3",title:this.getMessage("forThreeDays")}]}},{key:"processCommand",value:function e(t){if(t.indexOf("postpone")!==0){return false}let i=0;if(t==="postpone_hour_1"){i=3600}else if(t==="postpone_hour_2"){i=7200}else if(t==="postpone_hour_3"){i=10800}else if(t==="postpone_day_1"){i=86400}else if(t==="postpone_day_2"){i=172800}else if(t==="postpone_day_3"){i=259200}if(i>0&&this._item){this._item.postpone(i)}return true}},{key:"getMessage",value:function t(i){const s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function t(i,s){const n=new e;n.initialize(i,s);return n}}]);return e}();babelHelpers.defineProperty(SchedulePostponeController,"messages",{});let Activity$1=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._postponeController=null;return e}babelHelpers.createClass(t,[{key:"getTypeId",value:function e(){return Item.activity}},{key:"isDone",value:function e(){const t=BX.prop.getInteger(this.getAssociatedEntityData(),"STATUS");return t===BX.CrmActivityStatus.completed||t===BX.CrmActivityStatus.autoCompleted}},{key:"setAsDone",value:function e(t){t=!!t;if(this.isDone()===t){return}const i=BX.prop.getInteger(this.getAssociatedEntityData(),"ID",0);if(i>0){this._activityEditor.setActivityCompleted(i,t,BX.delegate(this.onSetAsDoneCompleted,this))}}},{key:"postpone",value:function e(t){const i=this.getSourceId();if(i>0&&t>0){this._activityEditor.postponeActivity(i,t,BX.delegate(this.onPosponeCompleted,this))}}},{key:"view",value:function e(){const t=BX.prop.getInteger(this.getAssociatedEntityData(),"ID",0);if(t>0){this._activityEditor.viewActivity(t)}}},{key:"edit",value:function e(){this.closeContextMenu();const t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.activity){const e=this.getAssociatedEntityData();const t=BX.prop.getInteger(e,"ID",0);if(t>0){this._activityEditor.editActivity(t)}}}},{key:"processRemoval",value:function e(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";let t=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!t){t=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getRemoveMessage()})}t.open().then(BX.delegate(this.onRemovalConfirm,this),BX.delegate(this.onRemovalCancel,this))}},{key:"getRemoveMessage",value:function e(){return this.getMessage("removeConfirm")}},{key:"onRemovalConfirm",value:function e(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this.remove()}},{key:"onRemovalCancel",value:function e(){}},{key:"remove",value:function e(){const t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.activity){const e=this.getAssociatedEntityData();const t=BX.prop.getInteger(e,"ID",0);if(t>0){const e=this._activityEditor;const i=e.getItemById(t);if(i){e.deleteActivity(t,true)}else{const i=e.getSetting("ownerType","");const s=e.getSetting("ownerID","");const n=BX.util.add_url_param(e.getSetting("serviceUrl",""),{id:t,action:"get_activity",ownertype:i,ownerid:s});BX.ajax({url:n,method:"POST",dataType:"json",data:{ACTION:"GET_ACTIVITY",ID:t,OWNER_TYPE:i,OWNER_ID:s},onsuccess:BX.delegate((function(t){if(typeof t["ACTIVITY"]!=="undefined"){e._handleActivityChange(t["ACTIVITY"]);window.setTimeout(BX.delegate(this.remove,this),500)}}),this),onfailure:function(e){}})}}}}},{key:"getDeadline",value:function e(){const t=this.getAssociatedEntityData();const i=BX.parseDate(t["DEADLINE_SERVER"],false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");if(!i){return null}return new crm_timeline_tools.DatetimeConverter(i).toUserTime().getValue()}},{key:"getCreatedDate",value:function e(){const t=this.getAssociatedEntityData();const i=BX.parseDate(t["CREATED_SERVER"],false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");if(!i){return null}return new crm_timeline_tools.DatetimeConverter(i).toUserTime().getValue()}},{key:"isIncomingChannel",value:function e(){if(this.isDone()){return false}const t=this.getAssociatedEntityData();return t.hasOwnProperty("IS_INCOMING_CHANNEL")&&t.IS_INCOMING_CHANNEL==="Y"}},{key:"markAsDone",value:function e(t){t=!!t;this.getAssociatedEntityData()["STATUS"]=t?BX.CrmActivityStatus.completed:BX.CrmActivityStatus.waiting}},{key:"getPrepositionText",value:function e(t){return this.getMessage(t===BX.CrmActivityDirection.incoming?"from":"to")}},{key:"getTypeDescription",value:function e(t){return""}},{key:"isContextMenuEnabled",value:function e(){return!!this.getDeadline()&&this.canPostpone()||this.canComplete()}},{key:"prepareContent",value:function e(t){let i="";const s=this.isIncomingChannel();if(s){i=this.formatDateTime(this.getCreatedDate())}else{const e=this.getDeadline();i=e?this.formatDateTime(e):this.getMessage("termless")}const n=this.getAssociatedEntityData();const a=BX.prop.getInteger(n,"DIRECTION",0);const r=this.isDone();const o=BX.prop.getString(n,"SUBJECT","");let l=BX.prop.getString(n,"DESCRIPTION_RAW","");const c=BX.prop.getObject(n,"COMMUNICATION",{});const h=BX.prop.getString(c,"TITLE","");const u=BX.prop.getString(c,"SHOW_URL","");const d=BX.prop.getString(c,"TYPE","")!==""?BX.prop.getString(c,"VALUE",""):"";let p=this.getWrapperClassName();if(p!==""){p=this._schedule.getItemClassName()+" "+p}else{p=this._schedule.getItemClassName()}const m=BX.create("DIV",{attrs:{className:p}});let y=this.getIconClassName();if(this.isCounterEnabled()){y+=" crm-entity-stream-section-counter"}if(s){y+=" crm-entity-stream-section-counter --incoming-counter"}m.appendChild(BX.create("DIV",{attrs:{className:y}}));if(this.isContextMenuEnabled()){m.appendChild(this.prepareContextMenuButton())}const g=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}});m.appendChild(g);if(l!==""){l=l.replace(/^\s+/,"")}const _=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});g.appendChild(_);this._deadlineNode=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:i});const f=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});f.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getTypeDescription(a)}));const I=this.getStatusNode();if(I){f.appendChild(I)}f.appendChild(this._deadlineNode);_.appendChild(f);const C=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});_.appendChild(C);C.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:o})]}));C.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:this.cutOffText(l,128)}));const v=this.prepareDetailNodes();if(BX.type.isArray(v)){let e=0;const t=v.length;for(;e<t;e++){C.appendChild(v[e])}}const B=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});if(h!==""){B.appendChild(BX.create("SPAN",{text:this.getPrepositionText(a)+": "}));if(u!==""){B.appendChild(BX.create("A",{attrs:{href:u},text:h}))}else{B.appendChild(BX.create("SPAN",{text:h}))}}if(d!==""){const e=this.prepareCommunicationNode(d);if(e){B.appendChild(e)}}C.appendChild(B);const E=BX.create("INPUT",{attrs:{type:"checkbox",className:"crm-entity-stream-planned-apply-btn",checked:r},events:{change:this._setAsDoneButtonHandler}});if(!this.canComplete()){E.disabled=true}const X=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-planned-action"},children:[E]});_.appendChild(X);const T=this.prepareAuthorLayout();if(T){_.appendChild(T)}this._actionContainer=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-action"}});_.appendChild(this._actionContainer);return m}},{key:"getStatusNode",value:function e(){return null}},{key:"prepareCommunicationNode",value:function e(t){return BX.create("SPAN",{text:" "+t})}},{key:"prepareDetailNodes",value:function e(){return[]}},{key:"prepareContextMenuItems",value:function e(){const t=[];if(!this.isReadOnly()){if(this.isEditable()){t.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.edit,this)})}t.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)})}if(this.canPostpone()){const e=BX.delegate(this.onContextMenuItemSelect,this);if(!this._postponeController){this._postponeController=SchedulePostponeController.create("",{item:this})}const i={id:"postpone",text:this._postponeController.getTitle(),items:[]};const s=this._postponeController.getCommandList();let n=0;const a=s.length;for(;n<a;n++){const t=s[n];i.items.push({id:t["name"],text:t["title"],onclick:e})}t.push(i)}return t}},{key:"onContextMenuItemSelect",value:function e(t,i){this.closeContextMenu();if(this._postponeController){this._postponeController.processCommand(i.id)}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Scheduled);let Email$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-email"}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-email"}},{key:"prepareActions",value:function e(){if(this.isReadOnly()){return}this._actions.push(BX.CrmScheduleEmailAction.create("email",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor}))}},{key:"getTypeDescription",value:function e(t){return this.getMessage(t===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")}},{key:"getRemoveMessage",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"SUBJECT","");i=BX.util.htmlspecialchars(i);return this.getMessage("emailRemove").replace("#TITLE#",i)}},{key:"isEditable",value:function e(){return false}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let Call=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-call"}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-call"}},{key:"prepareActions",value:function e(){if(this.isReadOnly()){return}this._actions.push(BX.CrmScheduleCallAction.create("call",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._schedule.getOwnerInfo()}))}},{key:"getTypeDescription",value:function e(t){const i=this.getAssociatedEntityData();const s=BX.prop.getObject(i,"CALL_INFO",null);const n=s!==null?BX.prop.getString(s,"CALL_TYPE_TEXT",""):"";if(n!==""){return n}return this.getMessage(t===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")}},{key:"getRemoveMessage",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getInteger(t,"DIRECTION",0);let s=BX.prop.getString(t,"SUBJECT","");const n=i===BX.CrmActivityDirection.incoming?"incomingCallRemove":"outgoingCallRemove";s=BX.util.htmlspecialchars(s);return this.getMessage(n).replace("#TITLE#",s)}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let CallTracker=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getStatusNode",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getObject(t,"CALL_INFO",null);if(!i){return false}if(!BX.prop.getBoolean(i,"HAS_STATUS",false)){return false}const s=BX.prop.getBoolean(i,"SUCCESSFUL",false);const n=BX.prop.getString(i,"STATUS_TEXT","");return BX.create("DIV",{attrs:{className:s?"crm-entity-stream-content-event-successful":"crm-entity-stream-content-event-missing"},text:n})}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Call);let Meeting=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return""}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-meeting"}},{key:"prepareActions",value:function e(){}},{key:"getPrepositionText",value:function e(){return this.getMessage("reciprocal")}},{key:"getRemoveMessage",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"SUBJECT","");i=BX.util.htmlspecialchars(i);return this.getMessage("meetingRemove").replace("#TITLE#",i)}},{key:"getTypeDescription",value:function e(){return this.getMessage("meeting")}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let Task=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-planned-task"}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-task"}},{key:"getTypeDescription",value:function e(){return this.getMessage("task")}},{key:"getPrepositionText",value:function e(t){return this.getMessage("reciprocal")}},{key:"getRemoveMessage",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"SUBJECT","");i=BX.util.htmlspecialchars(i);return this.getMessage("taskRemove").replace("#TITLE#",i)}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let WebForm=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return""}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-crmForm"}},{key:"prepareActions",value:function e(){}},{key:"getPrepositionText",value:function e(){return this.getMessage("from")}},{key:"getTypeDescription",value:function e(){return this.getMessage("webform")}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let Wait$1=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._postponeController=null;return e}babelHelpers.createClass(t,[{key:"getTypeId",value:function e(){return Item.wait}},{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-wait"}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-wait"}},{key:"prepareActions",value:function e(){}},{key:"isCounterEnabled",value:function e(){return false}},{key:"getDeadline",value:function e(){const t=this.getAssociatedEntityData();const i=BX.parseDate(t["DEADLINE_SERVER"],false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");if(!i){return null}return new crm_timeline_tools.DatetimeConverter(i).toUserTime().getValue()}},{key:"isDone",value:function e(){return BX.prop.getString(this.getAssociatedEntityData(),"COMPLETED","N")==="Y"}},{key:"setAsDone",value:function e(t){t=!!t;if(this.isDone()===t){return}const i=this.getAssociatedEntityId();if(i>0){const e=this._schedule.getManager().getWaitEditor();if(e){e.complete(i,t,BX.delegate(this.onSetAsDoneCompleted,this))}}}},{key:"postpone",value:function e(t){const i=this.getAssociatedEntityId();if(i>0&&t>0){const e=this._schedule.getManager().getWaitEditor();if(e){e.postpone(i,t,BX.delegate(this.onPosponeCompleted,this))}}}},{key:"isContextMenuEnabled",value:function e(){return!!this.getDeadline()&&this.canPostpone()}},{key:"prepareContent",value:function e(){const t=this.getDeadline();const i=t?this.formatDateTime(t):this.getMessage("termless");const s=this.getAssociatedEntityData();const n=this.isDone();let a=BX.prop.getString(s,"DESCRIPTION_RAW","");let r=this.getWrapperClassName();if(r!==""){r="crm-entity-stream-section crm-entity-stream-section-planned"+" "+r}else{r="crm-entity-stream-section crm-entity-stream-section-planned"}const o=BX.create("DIV",{attrs:{className:r}});let l=this.getIconClassName();if(this.isCounterEnabled()){l+=" crm-entity-stream-section-counter"}o.appendChild(BX.create("DIV",{attrs:{className:l}}));if(this.isContextMenuEnabled()){o.appendChild(this.prepareContextMenuButton())}const c=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}});o.appendChild(c);if(a!==""){a=BX.util.trim(a);a=BX.util.strip_tags(a);a=this.cutOffText(a,512);a=BX.util.nl2br(a)}const h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});c.appendChild(h);this._deadlineNode=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:i});const u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getMessage("wait")}),this._deadlineNode]});h.appendChild(u);const d=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});h.appendChild(d);d.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},html:a}));const p=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});d.appendChild(p);const m=BX.create("INPUT",{attrs:{type:"checkbox",className:"crm-entity-stream-planned-apply-btn",checked:n},events:{change:this._setAsDoneButtonHandler}});if(!this.canComplete()){m.disabled=true}const y=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-planned-action"},children:[m]});h.appendChild(y);const g=this.prepareAuthorLayout();if(g){h.appendChild(g)}this._actionContainer=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-action"}});h.appendChild(this._actionContainer);return o}},{key:"prepareContextMenuItems",value:function e(){const t=[];const i=BX.delegate(this.onContextMenuItemSelect,this);if(!this._postponeController){this._postponeController=SchedulePostponeController.create("",{item:this})}const s={id:"postpone",text:this._postponeController.getTitle(),items:[]};const n=this._postponeController.getCommandList();let a=0;const r=n.length;for(;a<r;a++){const e=n[a];s.items.push({id:e["name"],text:e["title"],onclick:i})}t.push(s);return t}},{key:"onContextMenuItemSelect",value:function e(t,i){this.closeContextMenu();if(this._postponeController){this._postponeController.processCommand(i.id)}}},{key:"getTypeDescription",value:function e(){return this.getMessage("wait")}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Scheduled);let Request=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return""}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-robot"}},{key:"getTypeDescription",value:function e(){return this.getMessage("activityRequest")}},{key:"isEditable",value:function e(){return false}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let Rest$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return""}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-rest"}},{key:"prepareContent",value:function e(i){const s=babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"prepareContent",this).call(this,i);const n=this.getAssociatedEntityData();if(n["APP_TYPE"]&&n["APP_TYPE"]["ICON_SRC"]){const e=s.querySelector("."+this.getIconClassName().replace(/\s+/g,"."));if(e){e.style.backgroundImage="url('"+n["APP_TYPE"]["ICON_SRC"]+"')";e.style.backgroundPosition="center center";e.style.backgroundSize="cover";e.style.backgroundColor="transparent"}}return s}},{key:"getTypeDescription",value:function e(){const t=this.getAssociatedEntityData();if(t["APP_TYPE"]&&t["APP_TYPE"]["NAME"]){return t["APP_TYPE"]["NAME"]}return this.getMessage("restApplication")}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let OpenLine=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._clickHandler=BX.delegate(e.onClick,babelHelpers.assertThisInitialized(e));e._button=null;return e}babelHelpers.createClass(t,[{key:"getButton",value:function e(){return this._button}},{key:"onClick",value:function e(){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("openLineNotSupported"));return}let t="";const i=BX.prop.getObject(this._entityData,"COMMUNICATION",null);if(i){if(BX.prop.getString(i,"TYPE")==="IM"){t=BX.prop.getString(i,"VALUE")}}if(t!==""){window.top["BXIM"].openMessengerSlider(t,{RECENT:"N",MENU:"N"})}}},{key:"doLayout",value:function e(){this._button=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}});this._container.appendChild(this._button)}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity);babelHelpers.defineProperty(OpenLine,"messages",{});let OpenLine$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-IM"}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-IM"}},{key:"prepareActions",value:function e(){if(this.isReadOnly()){return}this._actions.push(OpenLine.create("openline",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._schedule.getOwnerInfo()}))}},{key:"getTypeDescription",value:function e(){return this.getMessage("openLine")}},{key:"getPrepositionText",value:function e(t){return this.getMessage("reciprocal")}},{key:"prepareCommunicationNode",value:function e(t){return null}},{key:"prepareDetailNodes",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM"}});const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM-messages"}});t.appendChild(i);const s=BX.prop.getObject(this.getAssociatedEntityData(),"OPENLINE_INFO",null);if(s){const e=BX.prop.getArray(s,"MESSAGES",[]);let t=0;const n=e.length;for(;t<n;t++){const s=e[t];const n=BX.prop.getBoolean(s,"IS_EXTERNAL",true);i.appendChild(BX.create("DIV",{attrs:{className:n?"crm-entity-stream-content-detail-IM-message-incoming":"crm-entity-stream-content-detail-IM-message-outgoing"},html:BX.prop.getString(s,"MESSAGE","")}))}}return[t]}},{key:"view",value:function e(){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("openLineNotSupported"));return}let t="";const i=BX.prop.getObject(this.getAssociatedEntityData(),"COMMUNICATION",null);if(i){if(BX.prop.getString(i,"TYPE")==="IM"){t=BX.prop.getString(i,"VALUE")}}if(t!==""){window.top["BXIM"].openMessengerSlider(t,{RECENT:"N",MENU:"N"})}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let Zoom=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-zoom"}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-zoom"}},{key:"getTypeDescription",value:function e(){return this.getMessage("zoom")}},{key:"getPrepositionText",value:function e(t){}},{key:"prepareCommunicationNode",value:function e(t){return null}},{key:"prepareContent",value:function e(t){const i=this.getDeadline();const s=i?this.formatDateTime(i):this.getMessage("termless");const n=this.getAssociatedEntityData();const a=BX.prop.getInteger(n,"DIRECTION",0);const r=this.isDone();const o=BX.prop.getString(n,"SUBJECT","");let l=BX.prop.getString(n,"DESCRIPTION_RAW","");const c=BX.prop.getObject(n,"COMMUNICATION",{});const h=BX.prop.getString(c,"TITLE","");const u=BX.prop.getString(c,"SHOW_URL","");const d=BX.prop.getString(c,"TYPE","")!==""?BX.prop.getString(c,"VALUE",""):"";let p=this.getWrapperClassName();if(p!==""){p="crm-entity-stream-section crm-entity-stream-section-planned"+" "+p}else{p="crm-entity-stream-section crm-entity-stream-section-planned"}const m=BX.create("DIV",{attrs:{className:p}});let y=this.getIconClassName();if(this.isCounterEnabled()){y+=" crm-entity-stream-section-counter"}m.appendChild(BX.create("DIV",{attrs:{className:y}}));if(this.isContextMenuEnabled()){m.appendChild(this.prepareContextMenuButton())}const g=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}});m.appendChild(g);if(l!==""){l=l.replace(/^\s+/,"")}const _=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});g.appendChild(_);this._deadlineNode=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:s});const f=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getTypeDescription(a)}),this._deadlineNode]});_.appendChild(f);const I=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});_.appendChild(I);if(n["ZOOM_INFO"]){const e=n["ZOOM_INFO"]["TOPIC"];const t=n["ZOOM_INFO"]["DURATION"];const i=BX.parseDate(n["ZOOM_INFO"]["CONF_START_TIME"],false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");const s=new crm_timeline_tools.DatetimeConverter(i).toUserTime().toDatetimeString({delimiter:", "});const a=BX.create("span",{text:this.getMessage("zoomCreatedMessage").replace("#CONFERENCE_TITLE#",e).replace("#DATE_TIME#",s).replace("#DURATION#",t)});const r=BX.create("A",{attrs:{href:n["ZOOM_INFO"]["CONF_URL"],target:"_blank"},text:n["ZOOM_INFO"]["CONF_URL"]});const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-zoom-info"},children:[a,r]});I.appendChild(o);const l=BX.create("A",{attrs:{className:"ui-link ui-link-dashed","data-url":n["ZOOM_INFO"]["CONF_URL"]},text:this.getMessage("zoomCreatedCopyInviteLink")});BX.clipboard.bindCopyClick(l,{text:n["ZOOM_INFO"]["CONF_URL"]});const c=BX.create("BUTTON",{attrs:{className:"ui-btn ui-btn-sm ui-btn-primary"},text:this.getMessage("zoomCreatedStartConference"),events:{click:function(){window.open(n["ZOOM_INFO"]["CONF_URL"])}}});const h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-zoom-link-wrapper"},children:[l]});I.appendChild(h);I.appendChild(c)}const C=this.prepareDetailNodes();if(BX.type.isArray(C)){let e=0;const t=C.length;for(;e<t;e++){I.appendChild(C[e])}}const v=BX.create("INPUT",{attrs:{type:"checkbox",className:"crm-entity-stream-planned-apply-btn",checked:r},events:{change:this._setAsDoneButtonHandler}});if(!this.canComplete()){v.disabled=true}const B=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-planned-action"},children:[v]});_.appendChild(B);const E=this.prepareAuthorLayout();if(E){_.appendChild(E)}this._actionContainer=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-action"}});_.appendChild(this._actionContainer);return m}},{key:"prepareDetailNodes",value:function e(){}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let Schedule=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._items=[];e._history=null;e._wrapper=null;e._anchor=null;e._stub=null;return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){if(!this.isStubMode()){let e=this.getSetting("itemData");if(!BX.type.isArray(e)){e=[]}let t,i,s;for(t=0,i=e.length;t<i;t++){s=this.createItem(e[t]);if(s){this._items.push(s)}}}}},{key:"layout",value:function e(){this._wrapper=BX.create("DIV",{});this._container.appendChild(this._wrapper);const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-planned-label"},text:this.getMessage("planned")});const i="crm-entity-stream-section crm-entity-stream-section-planned-label";this._wrapper.appendChild(BX.create("DIV",{attrs:{className:i},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[t]})]}));if(this.isStubMode()){this.addStub()}else{const e=this._items.length;if(e===0){this.addStub()}else{for(let t=0;t<e;t++){const e=this._items[t];e.setContainer(this._wrapper);e.layout()}}}this.refreshLayout();this._manager.processSheduleLayoutChange()}},{key:"refreshLayout",value:function e(){BX.onCustomEvent("Schedule:onBeforeRefreshLayout",[this]);const t=this._items.length;if(t===0){this.addStub();if(this._history&&this._history.hasContent()){BX.removeClass(this._stub,"crm-entity-stream-section-last")}else{BX.addClass(this._stub,"crm-entity-stream-section-last")}const e=this._stub.querySelector(".crm-entity-stream-section-icon");if(e){if(this._manager.isStubCounterEnabled()){BX.addClass(e,"crm-entity-stream-section-counter")}else{BX.removeClass(e,"crm-entity-stream-section-counter")}}return}let i,s;if(this._history&&this._history.hasContent()){for(i=0;i<t;i++){s=this._items[i];if(s.isTerminated()){s.markAsTerminated(false)}}}else{if(t>1){for(i=0;i<t-1;i++){s=this._items[i];if(s.isTerminated()){s.markAsTerminated(false)}}}this._items[t-1].markAsTerminated(true)}}},{key:"formatDateTime",value:function e(t){return new crm_timeline_tools.DatetimeConverter(t).toDatetimeString({delimiter:", "})}},{key:"checkItemForTermination",value:function e(t){if(this._history&&this._history.getItemCount()>0){return false}return this.getLastItem()===t}},{key:"getItems",value:function e(){return this._items}},{key:"setItems",value:function e(t){this._items=t}},{key:"calculateItemIndex",value:function e(t){const i=t.getSort();for(let e=0;e<this._items.length;e++){const t=this._items[e].getSort();for(let s=0;s<t.length;s++){if(i.length<=s||i[s]!==t[s]){if(i[s]<t[s]){return e}break}}}return this._items.length}},{key:"getItemCount",value:function e(){return this._items.length}},{key:"getItemByAssociatedEntity",value:function e(t,i){if(!BX.type.isNumber(t)){t=parseInt(t)}if(!BX.type.isNumber(i)){i=parseInt(i)}if(isNaN(t)||t<=0||isNaN(i)||i<=0){return null}for(let e=0,s=this._items.length;e<s;e++){const s=this._items[e];if(s.getAssociatedEntityTypeId()===t&&s.getAssociatedEntityId()===i){return s}}return null}},{key:"getItemByData",value:function e(t){if(!BX.type.isPlainObject(t)){return null}return this.getItemByAssociatedEntity(BX.prop.getInteger(t,"ASSOCIATED_ENTITY_TYPE_ID",0),BX.prop.getInteger(t,"ASSOCIATED_ENTITY_ID",0))}},{key:"getItemByIndex",value:function e(t){return t<this._items.length?this._items[t]:null}},{key:"createItem",value:function e(t){const i=BX.prop.getInteger(t,"ASSOCIATED_ENTITY_TYPE_ID",0);const s=BX.prop.getInteger(t,"ASSOCIATED_ENTITY_ID",0);const n=BX.prop.getObject(t,"ASSOCIATED_ENTITY",{});let a=BX.CrmEntityType.resolveName(i)+"_"+s.toString();if(t.hasOwnProperty("type")){a=t.id;return crm_timeline_item.ConfigurableItem.create(a,{timelineId:this.getId(),container:this.getWrapper(),itemClassName:this.getItemClassName(),isReadOnly:this.isReadOnly(),currentUser:this._manager.getCurrentUser(),ownerTypeId:this._manager.getOwnerTypeId(),ownerId:this._manager.getOwnerId(),streamType:this.getStreamType(),data:t})}if(i===BX.CrmEntityType.enumeration.wait){return Wait$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else{const e=BX.prop.getInteger(n,"TYPE_ID",0);const i=BX.prop.getString(n,"PROVIDER_ID","");if(e===BX.CrmActivityType.email){return Email$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmActivityType.call){return Call.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmActivityType.meeting){return Meeting.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmActivityType.task){return Task.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmActivityType.provider){if(i==="CRM_WEBFORM"){return WebForm.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i==="CRM_REQUEST"){return Request.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i==="IMOPENLINES_SESSION"){return OpenLine$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i==="ZOOM"){return Zoom.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i==="REST_APP"){return Rest$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i==="CRM_CALL_TRACKER"){return CallTracker.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}}}return null}},{key:"getWrapper",value:function e(){return this._wrapper}},{key:"getItemClassName",value:function e(){return"crm-entity-stream-section crm-entity-stream-section-planned"}},{key:"getStreamType",value:function e(){return crm_timeline_item.StreamType.scheduled}},{key:"addItem",value:function e(t,i){if(!BX.type.isNumber(i)||i<0){i=this.calculateItemIndex(t)}if(i<this._items.length){this._items.splice(i,0,t)}else{this._items.push(t)}this.removeStub();this.refreshLayout();this._manager.processSheduleLayoutChange()}},{key:"getHistory",value:function e(){return this._history}},{key:"setHistory",value:function e(t){this._history=t}},{key:"createAnchor",value:function e(t){this._anchor=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-shadow"}});if(t>=0&&t<this._items.length){this._wrapper.insertBefore(this._anchor,this._items[t].getWrapper())}else{this._wrapper.appendChild(this._anchor)}return this._anchor}},{key:"deleteItem",value:function e(t){const i=this.getItemIndex(t);if(i<0){return}t.clearLayout();this.removeItemByIndex(i);this.refreshLayout();this._manager.processSheduleLayoutChange()}},{key:"transferItemToHistory",value:function e(t,i){const s=this.getItemIndex(t);if(s<0){return}this.removeItemByIndex(s);this.refreshLayout();this._manager.processSheduleLayoutChange();const n=this._history.createItem(i);this._history.addItem(n,0);n.layout({add:false});const a=ItemNew.create("",{initialItem:t,finalItem:n,anchor:this._history.createAnchor(),events:{complete:BX.delegate(this.onTransferComplete,this)}});a.run()}},{key:"onTransferComplete",value:function e(){this._history.refreshLayout();if(this._items.length===0){this.addStub()}}},{key:"onItemMarkedAsDone",value:function e(t,i){}},{key:"addStub",value:function e(){if(!this._stub){let e="crm-entity-stream-section crm-entity-stream-section-planned crm-entity-stream-section-notTask";let t="crm-entity-stream-section-icon crm-entity-stream-section-icon-info";const i=this.getManager().getSetting("enableTodo",false);if(i&&!this.isReadOnly()){e+=" --active"}let s=this.getMessage("stub");const n=this._manager.getOwnerTypeId();if(n===BX.CrmEntityType.enumeration.lead){s=this.getMessage("leadStub")}else if(n===BX.CrmEntityType.enumeration.deal){s=this.getMessage("dealStub")}if(this._manager.isStubCounterEnabled()){t+=" crm-entity-stream-section-counter"}this._stub=BX.create("DIV",{attrs:{className:e},children:[BX.create("DIV",{attrs:{className:t}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-title"},text:this.getMessage("stubTitle")}),BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},text:s})]})]})]});if(i&&!this.isReadOnly()){BX.bind(this._stub,"click",BX.delegate(this.focusOnTodoEditor,this))}this._wrapper.appendChild(this._stub)}if(this._history&&this._history.getItemCount()>0){BX.removeClass(this._stub,"crm-entity-stream-section-last")}else{BX.addClass(this._stub,"crm-entity-stream-section-last")}}},{key:"removeStub",value:function e(){if(this._stub){this._stub=BX.remove(this._stub)}}},{key:"focusOnTodoEditor",value:function e(){const t=this.getManager().getMenuBar();t.setActiveItemById("todo");const i=t.getTodoEditor();i.setFocused()}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"animateItemAdding",value:function e(t){t.addWrapperClass("crm-entity-stream-section-updated",1e3);return Promise.resolve()}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);t.items[n.getId()]=n;return n}}]);return t}(Steam);babelHelpers.defineProperty(Schedule,"items",{});babelHelpers.defineProperty(Schedule,"messages",{});let Modification=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"getTitle",value:function e(){return this.getTextDataParam("TITLE")}},{key:"prepareContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-info"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}));const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const s=this.prepareHeaderLayout();const n=[];if(BX.type.isNotEmptyString(this.getTextDataParam("START_NAME"))){n.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detain-info-status"},text:this.getTextDataParam("START_NAME")}));n.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-info-separator-icon"}}))}if(BX.type.isNotEmptyString(this.getTextDataParam("FINISH_NAME"))){n.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detain-info-status"},text:this.getTextDataParam("FINISH_NAME")}))}i.appendChild(s);i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-info"},children:n})]}));const a=this.prepareAuthorLayout();if(a){i.appendChild(a)}t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));return t}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);babelHelpers.defineProperty(Modification,"messages",{});let Conversion=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"getTitle",value:function e(){return this.getTextDataParam("TITLE")}},{key:"prepareContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-convert crm-entity-stream-section-history"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-convert"}}));const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const s=this.prepareHeaderLayout();i.appendChild(s);const n=[];const a=this.getArrayDataParam("ENTITIES");let r=0;const o=a.length;for(;r<o;r++){const e=a[r];let t;if(BX.prop.getString(e,"SHOW_URL","")===""){t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-convert"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detain-convert-status"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-status-text"},text:BX.CrmEntityType.getNotFoundMessage(e["ENTITY_TYPE_ID"])})]})]})}else{t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-convert"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detain-convert-status"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-status-text"},text:e["ENTITY_TYPE_CAPTION"]})]}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-convert-separator-icon"}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detain-convert-status"},children:[BX.create("A",{attrs:{className:"crm-entity-stream-content-detail-target",href:e["SHOW_URL"]},text:e["TITLE"]})]})]})}n.push(t)}i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:n}));const l=this.prepareAuthorLayout();if(l){i.appendChild(l)}t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));return t}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);babelHelpers.defineProperty(Conversion,"messages",{});let Email$2=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());const i=this.getAssociatedEntityData();const s=BX.prop.getObject(i,"EMAIL_INFO",null);const n=s!==null?BX.prop.getString(s,"STATUS_TEXT",""):"";const a=s!==null?BX.prop.getBoolean(s,"STATUS_ERROR",false):false;const r=!a?"crm-entity-stream-content-event-skipped":"crm-entity-stream-content-event-missing";if(n!==""){t.appendChild(BX.create("SPAN",{props:{className:r},text:n}))}const o=this.prepareMarkLayout();if(o){t.appendChild(o)}t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContextMenuItems",value:function e(){const t=[];if(!this.isReadOnly()){t.push({id:"view",text:this.getMessage("menuView"),onclick:BX.delegate(this.view,this)});t.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id))t.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)});else t.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}return t}},{key:"reply",value:function e(){}},{key:"replyAll",value:function e(){}},{key:"forward",value:function e(){}},{key:"getRemoveMessage",value:function e(){const t=BX.util.htmlspecialchars(this.getTitle());return this.getMessage("emailRemove").replace("#TITLE#",t)}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}const s=BX.prop.getObject(t,"COMMUNICATION",{});const n=BX.prop.getString(s,"TITLE","");const a=BX.prop.getString(s,"SHOW_URL","");const r=BX.prop.getString(s,"VALUE","");const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-email"}});o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-email"}}));if(this.isFixed())BX.addClass(o,"crm-entity-stream-section-top-fixed");const l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[l]}));const c=this.prepareHeaderLayout();l.appendChild(c);if(this.isContextMenuEnabled()){l.appendChild(this.prepareContextMenuButton())}const h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email"}});l.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:[h]}));h.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));const u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email-to"}});h.appendChild(u);if(n!==""){if(a!==""){u.appendChild(BX.create("A",{attrs:{href:a},text:n}))}else{u.appendChild(BX.create("SPAN",{text:n}))}}if(r!==""){if(n!==""){u.appendChild(BX.create("SPAN",{text:" "}))}u.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-email-address"},text:r}))}h.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email-fragment"},children:this.prepareCutOffElements(i,128,this._headerClickHandler)}));const d=this.prepareAuthorLayout();if(d){l.appendChild(d)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});l.appendChild(this._actionContainer);if(!this.isReadOnly())l.appendChild(this.prepareFixedSwitcherLayout());return o}},{key:"prepareActions",value:function e(){if(this.isReadOnly()){return}this._actions.push(HistoryEmail.create("email",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor}))}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Call$1=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._clickHandler=BX.delegate(e.onClick,babelHelpers.assertThisInitialized(e));e._menu=null;e._isMenuShown=false;e._menuItems=null;return e}babelHelpers.createClass(t,[{key:"getButton",value:function e(){return null}},{key:"onClick",value:function e(t){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("telephonyNotSupported"));return}let i="";const s=this.getItemData();const n=BX.prop.getArray(s,"PHONE",[]);if(n.length===1){this.addCall(n[0]["VALUE"])}else if(n.length>1){this.showMenu()}else{const e=BX.prop.getObject(this._entityData,"COMMUNICATION",null);if(e){if(BX.prop.getString(e,"TYPE")==="PHONE"){i=BX.prop.getString(e,"VALUE");if(i){this.addCall(i)}}}}return BX.PreventDefault(t)}},{key:"showMenu",value:function e(){if(this._isMenuShown){return}this.prepareMenuItems();if(!this._menuItems||this._menuItems.length===0){return}this._menu=new BX.PopupMenuWindow(this._id,this._container,this._menuItems,{offsetTop:0,offsetLeft:16,events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this),onPopupDestroy:BX.delegate(this.onMenuDestroy,this)}});this._menu.popupWindow.show()}},{key:"closeMenu",value:function e(){if(!this._isMenuShown){return}if(this._menu){this._menu.close()}}},{key:"prepareMenuItems",value:function e(){if(this._menuItems){return}const t=this.getItemData();const i=BX.prop.getArray(t,"PHONE",[]);const s=BX.delegate(this.onMenuItemClick,this);this._menuItems=[];if(i.length===0){return}let n=0;const a=i.length;for(;n<a;n++){const e=BX.prop.getString(i[n],"VALUE");const t=BX.prop.getString(i[n],"VALUE_FORMATTED");const a=BX.prop.getString(i[n],"COMPLEX_NAME");const r=(a?a+": ":"")+(t?t:e);if(e!==""){this._menuItems.push({id:e,text:r,onclick:s})}}}},{key:"onMenuItemClick",value:function e(t,i){this.closeMenu();this.addCall(i.id)}},{key:"onMenuShow",value:function e(){this._isMenuShown=true}},{key:"onMenuClose",value:function e(){this._isMenuShown=false;this._menu.popupWindow.destroy()}},{key:"onMenuDestroy",value:function e(){this._menu=null}},{key:"addCall",value:function e(t){const i=BX.prop.getObject(this._entityData,"COMMUNICATION",null);let s=parseInt(BX.prop.getString(i,"ENTITY_TYPE_ID","0"));if(isNaN(s)){s=0}let n=parseInt(BX.prop.getString(i,"ENTITY_ID","0"));if(isNaN(n)){n=0}let a=0;let r=0;const o=BX.prop.getObject(this._settings,"ownerInfo");if(o){a=BX.prop.getInteger(o,"ENTITY_TYPE_ID",0);r=BX.prop.getInteger(o,"ENTITY_ID",0)}if(a<=0||r<=0){a=BX.prop.getInteger(this._entityData,"OWNER_TYPE_ID",0);r=BX.prop.getInteger(this._entityData,"OWNER_ID","0")}if(a<=0||r<=0){a=s;r=n}let l=parseInt(BX.prop.getString(this._entityData,"ID","0"));if(isNaN(l)){l=0}const c={ENTITY_TYPE_NAME:BX.CrmEntityType.resolveName(s),ENTITY_ID:n,AUTO_FOLD:true};if(a!==s||r!==n){c["BINDINGS"]=[{OWNER_TYPE_NAME:BX.CrmEntityType.resolveName(a),OWNER_ID:r}]}if(l>0){c["SRC_ACTIVITY_ID"]=l}window.top["BXIM"].phoneTo(t,c)}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}]);return t}(Activity);babelHelpers.defineProperty(Call$1,"messages",{});let HistoryCall=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._button=null;return e}babelHelpers.createClass(t,[{key:"getButton",value:function e(){return this._button}},{key:"doLayout",value:function e(){this._button=BX.create("A",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}});this._container.appendChild(this._button)}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Call$1);let ScheduleCall=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"doLayout",value:function e(){this._container.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}}))}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Call$1);let Call$2=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._playerDummyClickHandler=BX.delegate(e.onPlayerDummyClick,babelHelpers.assertThisInitialized(e));e._playerWrapper=null;e._transcriptWrapper=null;e._mediaFileInfo=null;return e}babelHelpers.createClass(t,[{key:"getTypeDescription",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getObject(t,"CALL_INFO",null);const s=i!==null?BX.prop.getString(i,"CALL_TYPE_TEXT",""):"";if(s!==""){return s}const n=BX.prop.getInteger(t,"DIRECTION",0);return this.getMessage(n===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")}},{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());const i=this.getAssociatedEntityData();const s=BX.prop.getObject(i,"CALL_INFO",null);const n=s!==null;const a=n?BX.prop.getBoolean(s,"SUCCESSFUL",false):false;const r=n?BX.prop.getString(s,"STATUS_TEXT",""):"";if(n&&r.length){t.appendChild(BX.create("DIV",{attrs:{className:a?"crm-entity-stream-content-event-successful":"crm-entity-stream-content-event-missing"},text:r}))}t.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));return t}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}const s=BX.prop.getObject(t,"COMMUNICATION",{});const n=BX.prop.getString(s,"TITLE","");const a=BX.prop.getString(s,"SHOW_URL","");const r=BX.prop.getString(s,"VALUE","");const o=BX.prop.getString(s,"FORMATTED_VALUE",r);const l=BX.prop.getObject(t,"CALL_INFO",null);const c=l!==null;const h=c?BX.prop.getString(l,"DURATION_TEXT",""):"";const u=c?BX.prop.getBoolean(l,"HAS_TRANSCRIPT",""):"";const d=c?BX.prop.getBoolean(l,"TRANSCRIPT_PENDING",""):"";const p=c?BX.prop.getString(l,"CALL_ID",""):"";const m=c?BX.prop.getString(l,"COMMENT",""):"";const y=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-call"}});y.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-call"}}));if(this.isFixed())BX.addClass(y,"crm-entity-stream-section-top-fixed");const g=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});y.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[g]}));const _=this.prepareHeaderLayout();g.appendChild(_);if(this.isContextMenuEnabled()){g.appendChild(this.prepareContextMenuButton())}const f=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});g.appendChild(f);f.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));f.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareMultilineCutOffElements(i,128,this._headerClickHandler)}));if(c){const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-call crm-entity-stream-content-detail-call-inline"}});f.appendChild(e);this._mediaFileInfo=BX.prop.getObject(t,"MEDIA_FILE_INFO",null);if(this._mediaFileInfo!==null){this._playerWrapper=this._history.getManager().renderAudioDummy(h,this._playerDummyClickHandler);e.appendChild(this._playerWrapper);e.appendChild(this._history.getManager().getAudioPlaybackRateSelector().render())}if(u){this._transcriptWrapper=BX.create("DIV",{attrs:{className:"crm-audio-transcript-wrap-container"},events:{click:function(e){if(BX.Voximplant&&BX.Voximplant.Transcript){BX.Voximplant.Transcript.create({callId:p}).show()}}},children:[BX.create("DIV",{attrs:{className:"crm-audio-transcript-icon"}}),BX.create("DIV",{attrs:{className:"crm-audio-transcript-conversation"},text:BX.message("CRM_TIMELINE_CALL_TRANSCRIPT")})]});e.appendChild(this._transcriptWrapper)}else if(d){this._transcriptWrapper=BX.create("DIV",{attrs:{className:"crm-audio-transcript-wrap-container-pending"},children:[BX.create("DIV",{attrs:{className:"crm-audio-transcript-icon-pending"},html:'<svg class="crm-transcript-loader-circular" viewBox="25 25 50 50"><circle class="crm-transcript-loader-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"></circle></svg>'}),BX.create("DIV",{attrs:{className:"crm-audio-transcript-conversation"},text:BX.message("CRM_TIMELINE_CALL_TRANSCRIPT_PENDING")})]});e.appendChild(this._transcriptWrapper)}if(m){f.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:m}))}}const I=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});f.appendChild(I);if(n!==""){if(a!==""){I.appendChild(BX.create("A",{attrs:{href:a},text:n}))}else{I.appendChild(BX.create("SPAN",{text:n}))}}if(o!==""){if(n!==""){I.appendChild(BX.create("SPAN",{text:" "}))}I.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-email-address"},text:o}))}const C=this.prepareAuthorLayout();if(C){g.appendChild(C)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});g.appendChild(this._actionContainer);if(!this.isReadOnly()){g.appendChild(this.prepareFixedSwitcherLayout())}return y}},{key:"prepareActions",value:function e(){if(this.isReadOnly()){return}this._actions.push(HistoryCall.create("call",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._history.getOwnerInfo()}))}},{key:"getRemoveMessage",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getInteger(t,"DIRECTION",0);const s=i===BX.CrmActivityDirection.incoming?"incomingCallRemove":"outgoingCallRemove";const n=BX.util.htmlspecialchars(this.getTitle());return this.getMessage(s).replace("#TITLE#",n)}},{key:"onPlayerDummyClick",value:function e(t){const i=this._playerWrapper.querySelector(".crm-audio-cap-wrap");if(i){BX.addClass(i,"crm-audio-cap-wrap-loader")}this._history.getManager().getAudioPlaybackRateSelector().addPlayer(this._history.getManager().loadMediaPlayer("history_"+this.getId(),this._mediaFileInfo["URL"],this._mediaFileInfo["TYPE"],this._playerWrapper,this._mediaFileInfo["DURATION"],{playbackRate:this._history.getManager().getAudioPlaybackRateSelector().getRate()}))}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Meeting$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());const i=this.prepareMarkLayout();if(i){t.appendChild(i)}t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}const s=BX.prop.getObject(t,"COMMUNICATION",{});const n=BX.prop.getString(s,"TITLE","");const a=BX.prop.getString(s,"SHOW_URL","");const r=BX.prop.getString(s,"VALUE","");const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-meeting"}});o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-meeting"}}));if(this.isContextMenuEnabled()){o.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(o,"crm-entity-stream-section-top-fixed");const l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[l]}));const c=this.prepareHeaderLayout();l.appendChild(c);const h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});l.appendChild(h);h.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));h.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(i,128,this._headerClickHandler)}));const u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});h.appendChild(u);if(n!==""){u.appendChild(BX.create("SPAN",{text:this.getMessage("reciprocal")+": "}));if(a!==""){u.appendChild(BX.create("A",{attrs:{href:a},text:n}))}else{u.appendChild(BX.create("SPAN",{text:n}))}}u.appendChild(BX.create("SPAN",{text:" "+r}));const d=this.prepareAuthorLayout();if(d){l.appendChild(d)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});l.appendChild(this._actionContainer);if(!this.isReadOnly())l.appendChild(this.prepareFixedSwitcherLayout());return o}},{key:"getRemoveMessage",value:function e(){const t=BX.util.htmlspecialchars(this.getTitle());return this.getMessage("meetingRemove").replace("#TITLE#",t)}},{key:"prepareActions",value:function e(){}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Task$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());const i=this.prepareMarkLayout();if(i){t.appendChild(i)}t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}const s=BX.prop.getObject(t,"COMMUNICATION",{});const n=BX.prop.getString(s,"TITLE","");const a=BX.prop.getString(s,"SHOW_URL","");const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-task"}});r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-task"}}));if(this.isContextMenuEnabled()){r.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(r,"crm-entity-stream-section-top-fixed");const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[o]}));const l=this.prepareHeaderLayout();o.appendChild(l);const c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});o.appendChild(c);c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(i,128,this._headerClickHandler)}));const h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});c.appendChild(h);if(n!==""){h.appendChild(BX.create("SPAN",{text:this.getMessage("reciprocal")+": "}));if(a!==""){h.appendChild(BX.create("A",{attrs:{href:a},text:n}))}else{h.appendChild(BX.create("SPAN",{text:n}))}}const u=this.prepareAuthorLayout();if(u){o.appendChild(u)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});o.appendChild(this._actionContainer);if(!this.isReadOnly())o.appendChild(this.prepareFixedSwitcherLayout());return r}},{key:"prepareActions",value:function e(){}},{key:"getRemoveMessage",value:function e(){const t=BX.util.htmlspecialchars(this.getTitle());return this.getMessage("taskRemove").replace("#TITLE#",t)}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let WebForm$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-crmForm"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-crmForm"}}));const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));if(this.isFixed())BX.addClass(t,"crm-entity-stream-section-top-fixed");const s=this.prepareHeaderLayout();i.appendChild(s);const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});i.appendChild(n);n.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));const a=this.prepareAuthorLayout();if(a){i.appendChild(a)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});i.appendChild(this._actionContainer);if(!this.isReadOnly())i.appendChild(this.prepareFixedSwitcherLayout());return t}},{key:"prepareActions",value:function e(){}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Request$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-today crm-entity-stream-section-robot"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-robot"}}));if(this.isContextMenuEnabled()){s.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(s,"crm-entity-stream-section-top-fixed");const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[n]}));const a=this.prepareHeaderLayout();n.appendChild(a);const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});n.appendChild(r);r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(i,128,this._headerClickHandler)}));const o=this.prepareAuthorLayout();if(o){n.appendChild(o)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});n.appendChild(this._actionContainer);if(!this.isReadOnly())n.appendChild(this.prepareFixedSwitcherLayout());return s}},{key:"prepareActions",value:function e(){}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}},{key:"isEditable",value:function e(){return false}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let OpenLine$2=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}const s=BX.prop.getObject(t,"COMMUNICATION",{});const n=BX.prop.getString(s,"TITLE","");const a=BX.prop.getString(s,"SHOW_URL","");const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-IM"}});r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-IM"}}));if(this.isContextMenuEnabled()){r.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(r,"crm-entity-stream-section-top-fixed");const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[o]}));const l=this.prepareHeaderLayout();o.appendChild(l);const c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});o.appendChild(c);c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));const h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM"}});c.appendChild(h);const u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM-messages"}});h.appendChild(u);const d=BX.prop.getObject(this.getAssociatedEntityData(),"OPENLINE_INFO",null);if(d){const e=BX.prop.getArray(d,"MESSAGES",[]);let t=0;const i=e.length;for(;t<i;t++){const i=e[t];const s=BX.prop.getBoolean(i,"IS_EXTERNAL",true);u.appendChild(BX.create("DIV",{attrs:{className:s?"crm-entity-stream-content-detail-IM-message-incoming":"crm-entity-stream-content-detail-IM-message-outgoing"},html:BX.prop.getString(i,"MESSAGE","")}))}}const p=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});c.appendChild(p);if(n!==""){p.appendChild(BX.create("SPAN",{text:this.getMessage("reciprocal")+": "}));if(a!==""){p.appendChild(BX.create("A",{attrs:{href:a},text:n}))}else{p.appendChild(BX.create("SPAN",{text:n}))}}const m=this.prepareAuthorLayout();if(m){o.appendChild(m)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});o.appendChild(this._actionContainer);if(!this.isReadOnly())o.appendChild(this.prepareFixedSwitcherLayout());return r}},{key:"prepareActions",value:function e(){if(this.isReadOnly()){return}this._actions.push(OpenLine.create("openline",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._history.getOwnerInfo()}))}},{key:"view",value:function e(){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("openLineNotSupported"));return}let t="";const i=BX.prop.getObject(this.getAssociatedEntityData(),"COMMUNICATION",null);if(i){if(BX.prop.getString(i,"TYPE")==="IM"){t=BX.prop.getString(i,"VALUE")}}if(t!==""){window.top["BXIM"].openMessengerSlider(t,{RECENT:"N",MENU:"N"})}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Rest$2=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t}},{key:"getTypeDescription",value:function e(){const i=this.getAssociatedEntityData();if(i["APP_TYPE"]&&i["APP_TYPE"]["NAME"]){return i["APP_TYPE"]["NAME"]}return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"getTypeDescription",this).call(this)}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-today crm-entity-stream-section-rest"}});const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-rest"}});s.appendChild(n);if(t["APP_TYPE"]&&t["APP_TYPE"]["ICON_SRC"]){if(n){n.style.backgroundImage="url('"+t["APP_TYPE"]["ICON_SRC"]+"')";n.style.backgroundPosition="center center";n.style.backgroundSize="cover";n.style.backgroundColor="transparent"}}if(this.isFixed())BX.addClass(s,"crm-entity-stream-section-top-fixed");const a=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[a]}));const r=this.prepareHeaderLayout();a.appendChild(r);const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});a.appendChild(o);o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(i,128,this._headerClickHandler)}));const l=this.prepareAuthorLayout();if(l){a.appendChild(l)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});a.appendChild(this._actionContainer);if(!this.isReadOnly())a.appendChild(this.prepareFixedSwitcherLayout());return s}},{key:"prepareActions",value:function e(){}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Visit=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._playerDummyClickHandler=BX.delegate(e.onPlayerDummyClick,babelHelpers.assertThisInitialized(e));e._playerWrapper=null;e._transcriptWrapper=null;e._mediaFileInfo=null;return e}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());const i=this.getAssociatedEntityData();const s=BX.prop.getObject(i,"VISIT_INFO",{});const n=BX.prop.getInteger(s,"RECORD_LENGTH",0);const a=BX.prop.getString(s,"RECORD_LENGTH_FORMATTED_FULL","");t.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:(n>0?a+", "+BX.message("CRM_TIMELINE_VISIT_AT")+" ":"")+this.formatTime(this.getCreatedTime())}));return t}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getObject(t,"COMMUNICATION",{});const s=BX.prop.getString(i,"TITLE","");const n=BX.prop.getString(i,"SHOW_URL","");const a=BX.prop.getObject(t,"VISIT_INFO",{});const r=BX.prop.getInteger(a,"RECORD_LENGTH",0);const o=BX.prop.getString(a,"RECORD_LENGTH_FORMATTED_SHORT","");const l=BX.prop.getString(a,"VK_PROFILE","");const c=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-visit"}});c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-visit"}}));const h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[h]}));const u=this.prepareHeaderLayout();h.appendChild(u);if(this.isContextMenuEnabled()){h.appendChild(this.prepareContextMenuButton())}const d=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail crm-entity-stream-content-detail-call-inline"}});h.appendChild(d);this._mediaFileInfo=BX.prop.getObject(t,"MEDIA_FILE_INFO",null);if(this._mediaFileInfo!==null&&r>0){this._playerWrapper=this._history.getManager().renderAudioDummy(o,this._playerDummyClickHandler);d.appendChild(this._playerWrapper);d.appendChild(this._history.getManager().getAudioPlaybackRateSelector().render())}const p=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});h.appendChild(p);if(s!==""){p.appendChild(document.createTextNode(BX.message("CRM_TIMELINE_VISIT_WITH")+" "));if(n!==""){p.appendChild(BX.create("A",{attrs:{href:n},text:s}))}else{p.appendChild(BX.create("SPAN",{text:s}))}}if(BX.type.isNotEmptyString(l)){p.appendChild(document.createTextNode(" "));p.appendChild(BX.create("a",{attrs:{className:"crm-entity-stream-content-detail-additional",target:"_blank",href:this.getVkProfileUrl(l)},text:BX.message("CRM_TIMELINE_VISIT_VKONTAKTE_PROFILE")}))}const m=this.prepareAuthorLayout();if(m){h.appendChild(m)}return c}},{key:"onPlayerDummyClick",value:function e(t){const i=this._playerWrapper.querySelector(".crm-audio-cap-wrap");if(i){BX.addClass(i,"crm-audio-cap-wrap-loader")}this._history.getManager().getAudioPlaybackRateSelector().addPlayer(this._history.getManager().loadMediaPlayer("history_"+this.getId(),this._mediaFileInfo["URL"],this._mediaFileInfo["TYPE"],this._playerWrapper,this._mediaFileInfo["DURATION"],{playbackRate:this._history.getManager().getAudioPlaybackRateSelector().getRate()}))}},{key:"getVkProfileUrl",value:function e(t){return"https://vk.com/"+BX.util.htmlspecialchars(t)}},{key:"view",value:function e(){if(BX.getClass("BX.Crm.Restriction.Bitrix24")&&BX.Crm.Restriction.Bitrix24.isRestricted("visit")){return BX.Crm.Restriction.Bitrix24.getHandler("visit").call()}babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"view",this).call(this)}},{key:"edit",value:function e(){if(BX.getClass("BX.Crm.Restriction.Bitrix24")&&BX.Crm.Restriction.Bitrix24.isRestricted("visit")){return BX.Crm.Restriction.Bitrix24.getHandler("visit").call()}babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"edit",this).call(this)}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Zoom$1=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._videoDummy=null;e._audioDummy=null;e._videoPlayer=null;e._audioPlayer=null;e._audioLengthElement=null;e._recordings=[];e._currentRecordingIndex=0;e.zoomActivitySubject=null;e._downloadWrapper=null;e._downloadSubject=null;e._downloadSubjectDetail=null;e._downloadVideoLink=null;e._downloadSeparator=null;e._downloadAudioLink=null;e._playVideoLink=null;e.detailZoomCopyVideoLink=null;return e}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());if(!this._data.hasOwnProperty("PROVIDER_DATA")||this._data["PROVIDER_DATA"]["ZOOM_EVENT_TYPE"]!=="ZOOM_CONF_JOINED"){t.appendChild(this.prepareSuccessfulLayout())}t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareSuccessfulLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-successful"},text:BX.message("CRM_TIMELINE_ZOOM_SUCCESSFUL_ACTIVITY")})}},{key:"prepareTitleLayout",value:function e(){if(this._data.hasOwnProperty("PROVIDER_DATA")&&this._data["PROVIDER_DATA"]["ZOOM_EVENT_TYPE"]==="ZOOM_CONF_JOINED"){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:BX.message("CRM_TIMELINE_ZOOM_JOINED_CONFERENCE")})}else{return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:BX.message("CRM_TIMELINE_ZOOM_CONFERENCE_END")})}}},{key:"prepareContent",value:function e(){const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history"}});let s;const n=BX.prop.getObject(this.getAssociatedEntityData(),"ZOOM_INFO",null);const a=BX.prop.getString(this.getAssociatedEntityData(),"SUBJECT",null);this._recordings=BX.prop.getArray(n,"RECORDINGS",[]);i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-zoom"}}));if(this.isFixed())BX.addClass(i,"crm-entity-stream-section-top-fixed");const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[r]}));const o=this.prepareHeaderLayout();r.appendChild(o);const l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});r.appendChild(l);if(this._data.hasOwnProperty("PROVIDER_DATA")&&this._data["PROVIDER_DATA"]["ZOOM_EVENT_TYPE"]==="ZOOM_CONF_JOINED"){s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:n["CONF_URL"]})}else{s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});if(this._recordings.length>0){if(this._recordings.length>1){const e=this._recordings.map((function(e,t){return{id:t,title:BX.message("CRM_TIMELINE_ZOOM_MEETING_RECORD_PART").replace("#NUMBER#",t+1),time:e["AUDIO"]?e["AUDIO"]["LENGTH_FORMATTED"]:"",active:t===0}}));const i=new t.TabsComponent({tabs:e});i.eventEmitter.subscribe("onTabChange",this._onTabChange.bind(this));l.appendChild(i.render())}this._videoDummy=BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video-wrap"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video"},events:{click:this._onVideoDummyClick.bind(this)},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video-inner"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video-btn"},dataset:{hint:BX.message("CRM_TIMELINE_ZOOM_LOGIN_REQUIRED"),hintNoIcon:"Y"}}),BX.create("SPAN",{props:{className:"crm-entity-stream-content-detail-zoom-video-text"},text:BX.message("CRM_TIMELINE_ZOOM_CLICK_TO_WATCH")})]})]})]});BX.UI.Hint.init(this._videoDummy);this._audioDummy=this._history.getManager().renderAudioDummy("00:15",this._onAudioDummyClick.bind(this));this._audioLengthElement=this._audioDummy.querySelector(".crm-audio-cap-time");if(n["RECORDINGS"][0]["VIDEO"]){const e=n["RECORDINGS"][0]["VIDEO"]["END_DATE_TS"]*1e3+60*60*23*1e3;if(e<Date.now()){const e=BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-desc"}});this._playVideoLink=BX.create("DIV",{html:BX.message("CRM_TIMELINE_ZOOM_PLAY_LINK_VIDEO")});this._detailZoomCopyVideoLink=BX.create("A",{attrs:{className:"ui-link ui-link-dashed"},text:BX.message("CRM_TIMELINE_ZOOM_COPY_PASSWORD")});e.appendChild(this._playVideoLink);e.appendChild(this._detailZoomCopyVideoLink);s.appendChild(e)}else{s.appendChild(this._videoDummy)}}if(n["RECORDINGS"][0]["AUDIO"]){const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-call crm-entity-stream-content-detail-call-inline"}});e.appendChild(this._audioDummy);e.appendChild(this._history.getManager().getAudioPlaybackRateSelector().render());s.appendChild(e)}this._downloadWrapper=BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-desc"}});s.appendChild(this._downloadWrapper);this._downloadSubject=BX.create("SPAN",{props:{className:"crm-entity-stream-content-detail-zoom-desc-subject"}});this._downloadSubjectDetail=BX.create("SPAN",{props:{className:"crm-entity-stream-content-detail-zoom-desc-detail"}});this._downloadVideoLink=BX.create("A",{props:{className:"crm-entity-stream-content-detail-zoom-desc-link"},text:BX.message("CRM_TIMELINE_ZOOM_DOWNLOAD_VIDEO")});this._downloadSeparator=BX.create("SPAN",{props:{className:"crm-entity-stream-content-detail-zoom-desc-separate"},html:"&mdash;"});this._downloadAudioLink=BX.create("A",{props:{className:"crm-entity-stream-content-detail-zoom-desc-link"},text:BX.message("CRM_TIMELINE_ZOOM_DOWNLOAD_AUDIO")});this.setCurrentRecording(0)}else{this.zoomActivitySubject=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:a})]});s.appendChild(this.zoomActivitySubject);if(n["HAS_RECORDING"]==="Y"){s.appendChild(BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video-inner"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video-img"}}),BX.create("SPAN",{props:{className:"crm-entity-stream-content-detail-zoom-video-text"},text:BX.message("CRM_TIMELINE_ZOOM_MEETING_RECORD_IN_PROCESS")})]})]}))}}}if(s){l.appendChild(s)}const c=this.prepareAuthorLayout();if(c){r.appendChild(c)}return i}},{key:"_onVideoDummyClick",value:function e(){BX.UI.Hint.hide();const t=this._recordings[this._currentRecordingIndex]["VIDEO"];if(!t){return}this._videoPlayer=this._history.getManager().loadMediaPlayer("zoom_video_"+this.getId(),t["DOWNLOAD_URL"],"video/mp4",this._videoDummy,t["LENGTH"],{video:true,skin:"",width:480,height:270})}},{key:"_onAudioDummyClick",value:function e(){const t=this._recordings[this._currentRecordingIndex]["AUDIO"];if(!t){return}this._history.getManager().getAudioPlaybackRateSelector().addPlayer(this._audioPlayer=this._history.getManager().loadMediaPlayer("zoom_audio_"+this.getId(),t["DOWNLOAD_URL"],"audio/mp4",this._audioDummy,t["LENGTH"],{playbackRate:this._history.getManager().getAudioPlaybackRateSelector().getRate()}))}},{key:"_onTabChange",value:function e(t){this.setCurrentRecording(t.data.tabId)}},{key:"setCurrentRecording",value:function e(t){this._currentRecordingIndex=t;const i=this._recordings[this._currentRecordingIndex]["VIDEO"];const s=this._recordings[this._currentRecordingIndex]["AUDIO"];if(i){this._videoDummy.hidden=false;if(this._videoPlayer){this._videoPlayer.pause();this._videoPlayer.setSource(i["DOWNLOAD_URL"]);this._downloadVideoLink.href=i["DOWNLOAD_URL"]}}else{this._videoDummy.hidden=true}if(s){this._audioDummy.hidden=false;if(this._audioPlayer){this._audioPlayer.pause();this._audioPlayer.setSource(s["DOWNLOAD_URL"])}this._downloadAudioLink.href=s["DOWNLOAD_URL"];this._audioLengthElement.innerText=s["LENGTH_FORMATTED"]}else{this._audioDummy.hidden=true}BX.clean(this._downloadWrapper);if(s||i){const e=s?s["LENGTH_HUMAN"]:i["LENGTH_HUMAN"];this._downloadWrapper.appendChild(this._downloadSubject);this._downloadSubject.innerHTML=BX.util.htmlspecialchars(BX.message("CRM_TIMELINE_ZOOM_MEETING_RECORD").replace("#DURATION#",e))+" &mdash; ";this._downloadWrapper.appendChild(this._downloadSubjectDetail)}if(i){this._downloadSubjectDetail.appendChild(this._downloadVideoLink);this._downloadVideoLink.href=i["DOWNLOAD_URL"];if(s){this._downloadSubjectDetail.appendChild(this._downloadSeparator)}if(this._playVideoLink){this._playVideoLink.lastElementChild.href=i["PLAY_URL"];this._downloadVideoLink.href=i["PLAY_URL"]}if(this._detailZoomCopyVideoLink){BX.clipboard.bindCopyClick(this._detailZoomCopyVideoLink,{text:i["PASSWORD"]})}}if(s){this._downloadSubjectDetail.appendChild(this._downloadAudioLink);this._downloadAudioLink.href=s["DOWNLOAD_URL"]}}},{key:"prepareActions",value:function e(){}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);if(!window["zoom"]){window["zoom"]=[]}window["zoom"].push(n);return n}}]);return t}(HistoryActivity);Zoom$1.TabsComponent=function(){function e(t){babelHelpers.classCallCheck(this,e);this.tabs=BX.prop.getArray(t,"tabs",[]);this.elements={container:null,tabs:{}};this.eventEmitter=new BX.Event.EventEmitter(this,"Zoom.TabsComponent")}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.container){return this.elements.container}this.elements.container=BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section-wrapper"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section-list"},children:this.tabs.map(this._renderTab,this)})]});return this.elements.container}},{key:"_renderTab",value:function e(t){const i=t.id;this.elements.tabs[i]=BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section"+(t.active?" crm-entity-stream-content-detail-zoom-section-active":"")},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section-inner"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section-title"},text:t.title}),BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section-time"},text:t.time})]})],events:{click:function(){this.setActiveTab(t.id)}.bind(this)}});return this.elements.tabs[i]}},{key:"setActiveTab",value:function e(t){if(!this.elements.tabs[t]){throw new Error("Tab "+t+" is not found")}for(let e in this.elements.tabs){if(!this.elements.tabs.hasOwnProperty(e)){continue}e=Number.parseInt(e,10);if(e===t){this.elements.tabs[e].classList.add("crm-entity-stream-content-detail-zoom-section-active")}else{this.elements.tabs[e].classList.remove("crm-entity-stream-content-detail-zoom-section-active")}}this.eventEmitter.emit("onTabChange",{tabId:t})}}]);return e}();let OrderModification=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"getTitle",value:function e(){return this.getTextDataParam("TITLE")}},{key:"getStatusInfo",value:function e(){const t={};let i=null;let s=null;const n=this.getTextDataParam("CHANGED_ENTITY");const a=this.getObjectDataParam("FIELDS");const r=this.getAssociatedEntityData();if(n===BX.CrmEntityType.names.order){if(BX.prop.get(a,"ORDER_CANCELED")==="Y"){i="canceled";s="not-paid"}else if(BX.prop.get(a,"ORDER_DONE")==="Y"){i="done";s="done"}else if(BX.prop.getString(r,"VIEWED","")==="Y"){i="viewed";s="done"}else if(BX.prop.getString(r,"SENT","")==="Y"){i="sent";s="sent"}}if(n===BX.CrmEntityType.names.orderpayment){const e=BX.prop.get(a,"STATUS_CODE",false);if(e){if(e==="ERROR"){i="orderPaymentError";s="payment-error"}}else if(BX.prop.getString(r,"VIEWED","")==="Y"){i="viewed";s="done"}else if(BX.prop.getString(r,"SENT","")==="Y"){i="sent";s="sent"}else{i=BX.prop.get(a,"ORDER_PAID")==="Y"?"paid":"unpaid";s=BX.prop.get(a,"ORDER_PAID")==="Y"?"paid":"not-paid"}}else if(n===BX.CrmEntityType.names.ordershipment&&BX.prop.get(a,"ORDER_DEDUCTED",false)){i=BX.prop.get(a,"ORDER_DEDUCTED")==="Y"?"deducted":"unshipped";s=BX.prop.get(a,"ORDER_DEDUCTED")==="Y"?"shipped":"not-shipped"}else if(n===BX.CrmEntityType.names.ordershipment&&BX.prop.get(a,"ORDER_ALLOW_DELIVERY",false)){i=BX.prop.get(a,"ORDER_ALLOW_DELIVERY")==="Y"?"allowedDelivery":"disallowedDelivery";s=BX.prop.get(a,"ORDER_ALLOW_DELIVERY")==="Y"?"allowed-delivery":"disallowed-delivery"}if(i){t.className="crm-entity-stream-content-event-"+s;t.message=this.getMessage(i)}return t}},{key:"getHeaderChildren",value:function e(){const t=[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},events:{click:this._headerClickHandler},text:this.getTitle()})];const i=this.getStatusInfo();if(BX.type.isNotEmptyObject(i)){t.push(BX.create("SPAN",{attrs:{className:i.className},text:i.message}))}t.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));return t}},{key:"prepareContentDetails",value:function e(){const t=this.getAssociatedEntityData();const i=this.getAssociatedEntityTypeId();const s=this.getAssociatedEntityId();const n=BX.prop.getString(t,"TITLE");const a=BX.prop.getString(t,"HTML_TITLE","");const r=BX.prop.getString(t,"SHOW_URL","");const o=[];if(n!==""){const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});if(r===""||i===this.getOwnerTypeId()&&s===this.getOwnerId()){e.appendChild(BX.create("SPAN",{text:n+" "+a}))}else{if(a===""){e.appendChild(BX.create("A",{attrs:{href:r},text:n}))}else{e.appendChild(BX.create("SPAN",{text:n+" "}));e.appendChild(BX.create("A",{attrs:{href:r},text:a}))}}const l=BX.prop.getString(t,"LEGEND");if(l!==""){e.appendChild(BX.create("SPAN",{html:" "+l}))}const c=BX.prop.getString(t,"SUBLEGEND","");if(c!==""){e.appendChild(BX.create("BR"));e.appendChild(BX.create("SPAN",{text:" "+c}))}o.push(e)}return o}},{key:"prepareViewedContentDetails",value:function e(){const t=this.getAssociatedEntityData();const i=this.getAssociatedEntityTypeId();const s=this.getAssociatedEntityId();const n=BX.prop.getString(t,"TITLE");const a=BX.prop.getString(t,"SHOW_URL","");const r=[];if(n!==""){const e=BX.prop.getString(t,"SUBLEGEND","");if(e!==""){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:e});r.push(t)}if(i===this.getOwnerTypeId()&&s===this.getOwnerId()){r.push(BX.create("SPAN",{text:n}))}else{r.push(BX.create("A",{attrs:{href:a},text:n}))}const o=BX.prop.getString(t,"LEGEND");if(o!==""){r.push(BX.create("SPAN",{html:" "+o}))}}return r}},{key:"prepareSentContentDetails",value:function e(){const t=this.getAssociatedEntityData();const i=this.getAssociatedEntityTypeId();const s=this.getAssociatedEntityId();const n=BX.prop.getString(t,"TITLE");const a=BX.prop.getString(t,"SHOW_URL","");const r=BX.prop.getString(t,"DESTINATION_TITLE","");const o=[];if(n!==""){const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});if(a===""||i===this.getOwnerTypeId()&&s===this.getOwnerId()){e.appendChild(BX.create("SPAN",{text:n}))}else{e.appendChild(BX.create("A",{attrs:{href:a},text:n}))}const l=BX.prop.getString(t,"LEGEND");if(l!==""){e.appendChild(BX.create("SPAN",{html:" "+l}))}if(r){e.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-order-destination"},text:r}))}o.push(e);const c=BX.create("A",{attrs:{href:"#"},text:this.getMessage("orderPaymentProcess"),events:{click:BX.proxy(this.startSalescenterApplication,this)}});o.push(c)}return o}},{key:"startSalescenterApplication",value:function e(){BX.loadExt("salescenter.manager").then(function(){const e=this.getObjectDataParam("FIELDS"),t=BX.prop.get(e,"OWNER_TYPE_ID",BX.CrmEntityType.enumeration.deal);let i=BX.prop.get(e,"OWNER_ID",0);const s=BX.prop.get(e,"PAYMENT_ID",0),n=BX.prop.get(e,"SHIPMENT_ID",0),a=BX.prop.get(e,"ORDER_ID",0);if(!i){i=BX.prop.get(e,"DEAL_ID",0)}BX.Salescenter.Manager.openApplication({disableSendButton:"",context:"deal",ownerTypeId:t,ownerId:i,mode:t===BX.CrmEntityType.enumeration.deal?"payment_delivery":"payment",templateMode:"view",orderId:a,paymentId:s,shipmentId:n})}.bind(this))}},{key:"preparePaidPaymentContentDetails",value:function e(){const t=this.getAssociatedEntityData(),i=BX.prop.getString(t,"TITLE"),s=BX.prop.getString(t,"DATE",""),n=BX.prop.getString(t,"PAY_SYSTEM_NAME",""),a=BX.prop.getString(t,"SUM",""),r=BX.prop.getString(t,"CURRENCY",""),o=[];if(i!==""){const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-payment"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-payment-value"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-payment-text"},html:a}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-payment-currency"},html:r})]}));const i=BX.prop.getString(t,"LOGOTIP",null);if(i){e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-payment-logo"},style:{backgroundImage:"url("+encodeURI(i)+")"}}))}o.push(e);const l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:[BX.create("SPAN",{text:s}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-description-info"},text:this.getMessage("orderPaySystemTitle")}),BX.create("SPAN",{text:n})]});o.push(l)}return o}},{key:"prepareContent",value:function e(){const t=this.getObjectDataParam("FIELDS"),i=BX.prop.get(t,"ORDER_PAID")==="Y",s=BX.prop.get(t,"PAY_SYSTEM_CLICK")==="Y",n=BX.prop.get(t,"MANUAL_CONTINUE_PAY")==="Y",a=BX.prop.get(t,"NEED_MANUAL_ADD_CHECK")==="Y",r=this.getAssociatedEntityTypeId();if(r===BX.CrmEntityType.enumeration.orderpayment&&i){return this.preparePaidPaymentContent()}else if(r===BX.CrmEntityType.enumeration.orderpayment&&s){return this.prepareClickedPaymentContent()}else if(r===BX.CrmEntityType.enumeration.order&&n){return this.prepareManualContinuePayContent()}else if(r===BX.CrmEntityType.enumeration.orderpayment&&a){return this.prepareManualAddCheck()}return this.prepareItemOrderContent()}},{key:"prepareItemOrderContent",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getString(t,"VIEWED","")==="Y";const s=BX.prop.getString(t,"SENT","")==="Y";const n=this.getObjectDataParam("FIELDS");const a=BX.prop.get(n,"STATUS_CODE",false);const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history"}});r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon "+this.getIconClassName()}}));const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:this.getHeaderChildren()});let c=null;if(i){c=this.prepareViewedContentDetails()}else if(s){c=this.prepareSentContentDetails()}else if(a==="ERROR"){c=this.prepareErrorPaymentContentDetails()}else{c=this.prepareContentDetails()}o.appendChild(l);o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:c}));const h=this.prepareAuthorLayout();if(h){o.appendChild(h)}r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[o]}));return r}},{key:"preparePaidPaymentContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-wallet"}}));const i=[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getMessage("orderPaymentSuccessTitle")})]})];i.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:i});const a=this.preparePaidPaymentContentDetails();s.appendChild(n);s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:a}));const r=this.prepareAuthorLayout();if(r){s.appendChild(r)}t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));return t}},{key:"prepareErrorPaymentContentDetails",value:function e(){const t=this.getAssociatedEntityData(),i=BX.prop.getString(t,"DATE",""),s=this.getObjectDataParam("FIELDS"),n=BX.prop.getString(s,"PAY_SYSTEM_NAME",""),a=BX.prop.getString(s,"STATUS_DESCRIPTION",""),r=[];const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:[BX.create("SPAN",{text:i}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-description-info"},text:this.getMessage("orderPaySystemTitle")}),BX.create("SPAN",{text:n})]});r.push(o);const l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-payment-initiate-pay-error"},text:this.getMessage("orderPaymentStatusErrorReason").replace("#PAYSYSTEM_ERROR#",a)});r.push(l);return r}},{key:"prepareClickedPaymentContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon "+this.getIconClassName()}}));const i=[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]})];i.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:i});const a=this.prepareClickedPaymentContentDetails();s.appendChild(n);s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:a}));const r=this.prepareAuthorLayout();if(r){s.appendChild(r)}t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));return t}},{key:"prepareClickedPaymentContentDetails",value:function e(){const t=this.getObjectDataParam("FIELDS"),i=BX.prop.getString(t,"PAY_SYSTEM_NAME",""),s=[];if(i!==""){const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});e.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-clicked-description-info"},text:this.getMessage("orderPaymentPaySystemClick")}));e.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-clicked-description-name"},text:i}));s.push(e)}return s}},{key:"prepareManualContinuePayContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-advice"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-advice"},children:[BX.create("i")]}));const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-advice-info"},text:this.getMessage("orderManualContinuePay")});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-advice-content"},children:[i]}));return t}},{key:"prepareManualAddCheck",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getString(t,"SHOW_URL","");const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-advice"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-advice"}}));const n=this.getMessage("orderManualAddCheck").replace("#HREF#",i);const a=BX.create("DIV",{attrs:{className:"crm-entity-stream-advice-info"},html:n});const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-advice-info"},children:[BX.create("A",{attrs:{className:"crm-entity-stream-content-detail-target",href:"#"},events:{click:BX.delegate((function(e){top.BX.Helper.show("redirect=detail&code=13742126");e.preventDefault?e.preventDefault():e.returnValue=false}))},html:this.getMessage("orderManualAddCheckHelpLink")})]});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-advice-content"},children:[a,r]}));return s}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon-store"}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);babelHelpers.defineProperty(OrderModification,"messages",{});let ExternalNoticeModification=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon-restApp"}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(OrderModification);let ExternalNoticeStatusModification=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareContentDetails",value:function e(){const t=[];const i=[];if(BX.type.isNotEmptyString(this.getTextDataParam("START_NAME"))){i.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detain-info-status"},text:this.getTextDataParam("START_NAME")}));i.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-info-separator-icon"}}))}if(BX.type.isNotEmptyString(this.getTextDataParam("FINISH_NAME"))){i.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detain-info-status"},text:this.getTextDataParam("FINISH_NAME")}))}t.push(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-info"},children:i}));return t}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(ExternalNoticeModification);let Creation=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"doInitialize",this).call(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"Creation. The field 'activityEditor' is not assigned."}}},{key:"getTitle",value:function e(){const t=this.getAssociatedEntityTypeId();const i=this.getAssociatedEntityData();if(t===BX.CrmEntityType.enumeration.activity){const e=BX.prop.getInteger(i,"TYPE_ID");const t=this.getMessage(e===BX.CrmActivityType.task?"task":"activity");return t.replace(/#TITLE#/gi,this.cutOffText(BX.prop.getString(i,"SUBJECT")),64)}if(t===BX.CrmEntityType.enumeration.storeDocument){const e=BX.prop.getString(i,"DOC_TYPE");if(e==="A"){return this.getMessage("arrivalDocument")}if(e==="S"){return this.getMessage("storeAdjustmentDocument")}if(e==="M"){return this.getMessage("movingDocument")}if(e==="D"){return this.getMessage("deductDocument")}if(e==="W"){return this.getMessage("shipmentDocument")}return""}const s=BX.CrmEntityType.resolveName(this.getAssociatedEntityTypeId()).toLowerCase();let n=this.getMessage(s);const a=n===s;if(!BX.type.isNotEmptyString(n)||a){n=this.getTextDataParam("TITLE")}return n}},{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-createEntity"}},{key:"prepareContent",value:function e(){const i=this.getAssociatedEntityTypeId();if(i===BX.CrmEntityType.enumeration.ordershipment||i===BX.CrmEntityType.enumeration.orderpayment){const e=this.getData();e.TYPE_CATEGORY_ID=Item.modification;if(e.hasOwnProperty("ASSOCIATED_ENTITY")){e.ASSOCIATED_ENTITY.HTML_TITLE=""}const t=this._history.createOrderEntityItem(e);return t.prepareContent()}return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"prepareContent",this).call(this)}},{key:"prepareContentDetails",value:function e(){const t=this.getAssociatedEntityTypeId();const i=this.getAssociatedEntityId();const s=this.getAssociatedEntityData();if(t===BX.CrmEntityType.enumeration.activity){const e=BX.create("A",{attrs:{href:"#"},html:this.cutOffText(BX.prop.getString(s,"DESCRIPTION_RAW"),128)});BX.bind(e,"click",this._headerClickHandler);return[e]}const n=BX.prop.getString(s,"TITLE","");let a=BX.prop.getString(s,"HTML_TITLE","");const r=BX.prop.getString(s,"SHOW_URL","");if(t===BX.CrmEntityType.enumeration.deal&&BX.prop.getObject(s,"ORDER",null)){const e=BX.prop.getObject(s,"ORDER",null);a=this.getMessage("dealOrderTitle").replace("#ORDER_ID#",e.ID).replace("#DATE_TIME#",e.ORDER_DATE).replace("#HREF#",e.SHOW_URL).replace("#PRICE_WITH_CURRENCY#",e.SUM)}if(n!==""||a!==""){const e=[];if(r===""||t===this.getOwnerTypeId()&&i===this.getOwnerId()){const t=a!==""?{html:a}:{text:n};e.push(BX.create("SPAN",t))}else{let t={attrs:{href:r},text:n};if(a!==""){t={attrs:{href:r},html:a}}e.push(BX.create("A",t))}const s=this.getTextDataParam("LEGEND");if(s!==""){e.push(BX.create("BR"));e.push(BX.create("SPAN",{text:s}))}const o=this.getObjectDataParam("BASE");const l=BX.prop.getObject(o,"ENTITY_INFO");if(l){e.push(BX.create("BR"));e.push(BX.create("SPAN",{text:BX.prop.getString(o,"CAPTION")+": "}));e.push(BX.create("A",{attrs:{href:BX.prop.getString(l,"SHOW_URL","#")},text:BX.prop.getString(l,"TITLE","")}))}return e}return[]}},{key:"view",value:function e(){const t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.activity){const e=this.getAssociatedEntityData();const t=BX.prop.getInteger(e,"ID",0);if(t>0){this._activityEditor.viewActivity(t)}}}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);babelHelpers.defineProperty(Creation,"messages",{});let Restoration=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getTitle",value:function e(){return this.getTextDataParam("TITLE")}},{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-restoreEntity"}},{key:"prepareContentDetails",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getString(t,"TITLE");return i!==""?[BX.create("SPAN",{text:i})]:[]}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);babelHelpers.defineProperty(Restoration,"messages",{});let Relation=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getTitle",value:function e(){return this.getMessage("title")}},{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-createEntity"}},{key:"prepareContentDetails",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"SHOW_URL","");if(i.indexOf("/")!==0){i="#"}const s=this.getMessage("contentTemplate").replace("#ENTITY_TYPE_CAPTION#",BX.Text.encode(BX.prop.getString(t,"ENTITY_TYPE_CAPTION",""))).replace("#LEGEND#","").replace("#LINK#",BX.Text.encode(i)).replace("#LINK_TITLE#",BX.Text.encode(BX.prop.getString(t,"TITLE","")));const n=[];n.push(BX.create("SPAN",{html:s}));return n}}]);return t}(History);let Link=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-link"}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Relation);babelHelpers.defineProperty(Link,"messages",{});let Unlink=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-unlink"}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Relation);babelHelpers.defineProperty(Unlink,"messages",{});let Mark$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"doInitialize",this).call(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"Mark. The field 'activityEditor' is not assigned."}}},{key:"getMessage",value:function e(i){const s=t.messages;if(s.hasOwnProperty(i)){return s[i]}return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"getMessage",this).call(this,i)}},{key:"getTitle",value:function e(){let t="";const i=this.getAssociatedEntityData();const s=this.getAssociatedEntityTypeId();const n=this.getTypeCategoryId();if(s===BX.CrmEntityType.enumeration.activity){const e=BX.prop.getInteger(i,"TYPE_ID",0);const s=BX.prop.getInteger(i,"DIRECTION",0);const a=BX.prop.getString(i,"PROVIDER_ID","");if(e===BX.CrmActivityType.email){if(n===Mark.success){t=this.getMessage((s===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")+"SuccessMark")}else if(n===Mark.renew){t=this.getMessage((s===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")+"RenewMark")}}else if(e===BX.CrmActivityType.call){if(n===Mark.success){t=this.getMessage((s===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")+"SuccessMark")}else if(n===Mark.renew){t=this.getMessage((s===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")+"RenewMark")}}else if(e===BX.CrmActivityType.meeting){if(n===Mark.success){t=this.getMessage("meetingSuccessMark")}else if(n===Mark.renew){t=this.getMessage("meetingRenewMark")}}else if(e===BX.CrmActivityType.task){if(n===Mark.success){t=this.getMessage("taskSuccessMark")}else if(n===Mark.renew){t=this.getMessage("taskRenewMark")}}else if(e===BX.CrmActivityType.provider){if(a==="CRM_REQUEST"){if(n===Mark.success){t=this.getMessage("requestSuccessMark")}else if(n===Mark.renew){t=this.getMessage("requestRenewMark")}}else if(n===Mark.success){t=this.getMessage("webformSuccessMark")}else if(n===Mark.renew){t=this.getMessage("webformRenewMark")}}}else if(s===BX.CrmEntityType.enumeration.deal){if(n===Mark.success){t=this.getMessage("dealSuccessMark")}else if(n===Mark.failed){t=this.getMessage("dealFailedMark")}}else if(s===BX.CrmEntityType.enumeration.order){if(n===Mark.success){t=this.getMessage("orderSuccessMark")}else if(n===Mark.failed){t=this.getMessage("orderFailedMark")}}else{if(BX.CrmEntityType.isDefined(s)){if(n===Mark.success){t=this.getMessage("entitySuccessMark")}else if(n===Mark.failed){t=this.getMessage("entityFailedMark")}}}return t}},{key:"prepareTitleLayout",value:function e(){const t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.order){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getTitle()})}else{return BX.create("A",{attrs:{href:"#",className:"crm-entity-stream-content-event-title"},events:{click:this._headerClickHandler},text:this.getTitle()})}}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();const i=this.getAssociatedEntityTypeId();const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-completed"}});if(this.isFixed())BX.addClass(s,"crm-entity-stream-section-top-fixed");if(this.isContextMenuEnabled()){s.appendChild(this.prepareContextMenuButton())}const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const a=this.prepareHeaderLayout();if(i===BX.CrmEntityType.enumeration.activity){const e=BX.prop.getInteger(t,"TYPE_ID",0);let i="crm-entity-stream-section-icon";if(e===BX.CrmActivityType.email){i+=" crm-entity-stream-section-icon-email"}else if(e===BX.CrmActivityType.call){i+=" crm-entity-stream-section-icon-call"}else if(e===BX.CrmActivityType.meeting){i+=" crm-entity-stream-section-icon-meeting"}else if(e===BX.CrmActivityType.task){i+=" crm-entity-stream-section-icon-task"}else if(e===BX.CrmActivityType.provider){const e=BX.prop.getString(t,"PROVIDER_ID","");if(e==="CRM_WEBFORM"){i+=" crm-entity-stream-section-icon-crmForm"}}s.appendChild(BX.create("DIV",{attrs:{className:i}}));n.appendChild(a);const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});n.appendChild(r);r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.cutOffText(BX.prop.getString(t,"SUBJECT",""),128)})]}));const o=this.getTextDataParam("SUMMARY");if(o!==""){r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:o}))}}else if(i===BX.CrmEntityType.enumeration.order){s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}));n.appendChild(a);n.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},text:this.cutOffText(this.getTextDataParam("MESSAGE"),128)}))}else{s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}));n.appendChild(a);const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});const r=this.cutOffText(BX.prop.getString(t,"TITLE",""),128);if(BX.CrmEntityType.isDefined(i)){let i=BX.prop.getString(t,"SHOW_URL","");if(i.indexOf("/")!==0){i="#"}const s=this.getMessage("entityContentTemplate").replace("#ENTITY_TYPE_CAPTION#",BX.Text.encode(BX.prop.getString(t,"ENTITY_TYPE_CAPTION",""))).replace("#LINK#",BX.Text.encode(i)).replace("#LINK_TITLE#",BX.Text.encode(r));e.appendChild(BX.create("SPAN",{html:s}))}else{e.innerText=r}n.appendChild(e)}const r=this.prepareAuthorLayout();if(r){n.appendChild(r)}s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[n]}));if(!this.isReadOnly())s.appendChild(this.prepareFixedSwitcherLayout());return s}},{key:"prepareContextMenuItems",value:function e(){const t=[];if(!this.isReadOnly()){if(this.isFixed()||this._fixedHistory.findItemById(this._id))t.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)});else t.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}return t}},{key:"view",value:function e(){const t=this.getAssociatedEntityData();const i=this.getAssociatedEntityTypeId();if(i===BX.CrmEntityType.enumeration.activity){const e=BX.prop.getInteger(t,"ID",0);if(e>0){this._activityEditor.viewActivity(e)}}else{const e=BX.prop.getString(t,"SHOW_URL","");if(e!==""){BX.Crm.Page.open(e)}}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);babelHelpers.defineProperty(Mark$1,"messages",{});let Comment$1=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._isCollapsed=false;e._isMenuShown=false;e._isFixed=false;e._hasFiles=false;e._postForm=null;e._editor=null;e._commentMessage="";e._mode=EditorMode.view;e._streamContentEventBlock="";e._playerWrappers={};BX.Event.EventEmitter.subscribe("BX.Disk.Files:onShowFiles",BX.delegate(e.addPlayer,babelHelpers.assertThisInitialized(e)));return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"doInitialize",this).call(this);this._hasFiles=this.getTextDataParam("HAS_FILES")==="Y"}},{key:"getTitle",value:function e(){return this.getMessage("comment")}},{key:"onPlayerDummyClick",value:function e(t){const i=this._playerWrappers[t.id];const s=i.querySelector(".crm-audio-cap-wrap");if(s){BX.addClass(s,"crm-audio-cap-wrap-loader")}this._history.getManager().getAudioPlaybackRateSelector().addPlayer(this._history.getManager().loadMediaPlayer("history_"+this.getId()+"_"+t.id,t.url,"audio/mp3",i,null,{playbackRate:this._history.getManager().getAudioPlaybackRateSelector().getRate()}))}},{key:"addPlayer",value:function e(t){if(t.data.entityValueId===parseInt(this.getId(),10)){this.files=t.data.files;t.data.files.forEach(function(e){if(e.extension==="mp3"){if(this._playerWrappers[e.id]){return}const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-call crm-entity-stream-content-detail-call-inline"}});this._streamContentEventBlock.appendChild(t);this._playerWrappers[e.id]=this._history.getManager().renderAudioDummy(null,this.onPlayerDummyClick.bind(this,e));this._playerWrappers[e.id].firstElementChild.classList.add("crm-audio-cap-wrap-without-duration-text");t.appendChild(this._playerWrappers[e.id]);t.appendChild(this._history.getManager().getAudioPlaybackRateSelector().render())}}.bind(this))}}},{key:"prepareContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-comment"}});if(this.isReadOnly()){BX.addClass(t,"crm-entity-stream-section-comment-read-only")}if(this.isFixed())BX.addClass(t,"crm-entity-stream-section-top-fixed");t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-comment"}}));if(this.isContextMenuEnabled()){t.appendChild(this.prepareContextMenuButton())}this._streamContentEventBlock=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const i=this.prepareHeaderLayout();this._streamContentEventBlock.appendChild(i);if(!this.isReadOnly())t.appendChild(this.prepareFixedSwitcherLayout());const s=[];if(this._mode!==EditorMode.edit){this._commentWrapper=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});BX.html(this._commentWrapper,this.getTextDataParam("COMMENT",""));s.push(this._commentWrapper);if(!this.isReadOnly()){BX.bind(this._commentWrapper,"click",BX.delegate(this.switchToEditMode,this));BX.bind(i,"click",BX.delegate(this.switchToEditMode,this))}}else{if(!BX.type.isDomNode(this._editorContainer))this._editorContainer=BX.create("div",{attrs:{className:"crm-entity-stream-section-comment-editor"}});s.push(this._editorContainer);const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-comment-edit-btn-container"},children:[BX.create("button",{attrs:{className:"ui-btn ui-btn-xs ui-btn-primary"},html:this.getMessage("send"),events:{click:BX.delegate(this.save,this)}}),BX.create("a",{attrs:{className:"ui-btn ui-btn-xs ui-btn-link"},html:this.getMessage("cancel"),events:{click:BX.delegate(this.switchToViewMode,this)}})]});s.push(e)}this._streamContentEventBlock.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:s}));const n=this.prepareAuthorLayout();if(n){this._streamContentEventBlock.appendChild(n)}const a=this.getTextDataParam("TEXT","");const r=this.getTextDataParam("HAS_INLINE_ATTACHMENT","")==="Y";if(a.length<=128&&!r||this._mode===EditorMode.edit){this._isCollapsed=false;t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[this._streamContentEventBlock]}))}else{this._isCollapsed=true;t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content crm-entity-stream-section-content-collapsed"},children:[this._streamContentEventBlock]}));t.querySelector(".crm-entity-stream-content-event").appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content-expand-btn-container"},children:[BX.create("A",{attrs:{className:"crm-entity-stream-section-content-expand-btn",href:"#"},events:{click:BX.delegate(this.onExpandButtonClick,this)},text:this.getMessage("expand")})]}))}if(this._mode===EditorMode.view&&this._hasFiles){this._textLoaded=false;this._fileBlock=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-files-inner"},children:[BX.create("DIV",{attrs:{className:"crm-timeline-wait"}})]});t.querySelector(".crm-entity-stream-section-content").appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-files"},children:[this._fileBlock]}));BX.ready(BX.delegate((function(){window.setTimeout(BX.delegate((function(){this.loadContent(this._fileBlock,"GET_FILE_BLOCK")}),this),100)}),this))}return t}},{key:"prepareActions",value:function e(){if(this._mode===EditorMode.view&&BX.type.isDomNode(this._commentWrapper)){this.registerImages(this._commentWrapper);if(!BX.getClass("BX.Disk.apiVersion")){BX.viewElementBind(this._commentWrapper,{showTitle:true},(function(e){return BX.type.isElementNode(e)&&(e.getAttribute("data-bx-viewer")||e.getAttribute("data-bx-image"))}))}}}},{key:"loadContent",value:function e(t,i){if(!BX.type.isDomNode(t))return;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"GET_COMMENT_CONTENT",ID:this.getId(),ENTITY_TYPE_ID:this.getOwnerTypeId(),ENTITY_ID:this.getOwnerId(),TYPE:i},onsuccess:BX.delegate((function(e){if(BX.type.isNotEmptyString(e.ERROR)&&i==="GET_FILE_BLOCK"){BX.remove(t);return}if(BX.type.isNotEmptyString(e.BLOCK)){const i=BX.html(t,e.BLOCK);i.then(BX.delegate((function(){this.registerImages(t);BX.LazyLoad.showImages()}),this))}}),this)})}},{key:"loadEditor",value:function e(){this._editorName="CrmTimeLineComment"+this._id+BX.util.getRandomString(4);if(this._postForm){this._postForm.oEditor.SetContent(this._commentMessage);this._editor.ReInitIframe();return}const t={data:{id:this._id,name:this._editorName}};BX.ajax.runAction("crm.api.timeline.loadEditor",t).then(this.onLoadEditorSuccess.bind(this)).catch(this.switchToViewMode.bind(this))}},{key:"onLoadEditorSuccess",value:function e(t){if(!BX.type.isDomNode(this._editorContainer))this._editorContainer=BX.create("div",{attrs:{className:"crm-entity-stream-section-comment-editor"}});const i=BX.prop.getString(BX.prop.getObject(t,"data",{}),"html","");BX.html(this._editorContainer,i).then(BX.delegate(this.showEditor,this))}},{key:"showEditor",value:function e(){if(LHEPostForm){window.setTimeout(BX.delegate((function(){this._postForm=LHEPostForm.getHandler(this._editorName);this._editor=BXHtmlEditor.Get(this._editorName);BX.onCustomEvent(this._postForm.eventNode,"OnShowLHE",[true]);this._commentMessage=this._postForm.oEditor.GetContent()}),this),0)}}},{key:"registerImages",value:function e(t){const i=t.querySelectorAll('[data-bx-viewer="image"]');const s=i.length;const n=[];if(s>0){for(let e=0;e<s;++e){if(BX.type.isDomNode(i[e])){i[e].id+=BX.util.getRandomString(4);n.push(i[e].id)}}if(n.length>0){BX.LazyLoad.registerImages(n)}}BX.LazyLoad.registerImages(n)}},{key:"toggleMode",value:function e(t){this._mode=parseInt(t);this._hasFiles=this.getTextDataParam("HAS_FILES")==="Y";this.refreshLayout();this.closeContextMenu()}},{key:"switchToViewMode",value:function e(t){this.toggleMode(EditorMode.view)}},{key:"switchToEditMode",value:function e(t){const i=t.target.tagName.toLowerCase();if(i==="a"||i==="img"||BX.hasClass(t.target,"feed-con-file-changes-link-more")||BX.hasClass(t.target,"feed-com-file-inline")||BX.type.isNotEmptyString(document.getSelection().toString())){return}this.toggleMode(EditorMode.edit);window.setTimeout(BX.delegate((function(){this.loadEditor()}),this),100)}},{key:"prepareContextMenuItems",value:function e(){if(this._isMenuShown){return}const t=[];if(!this.isReadOnly()){if(this._mode!==EditorMode.edit){t.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.switchToEditMode,this)})}else{t.push({id:"cancel",text:this.getMessage("menuCancel"),onclick:BX.delegate(this.switchToViewMode,this)})}t.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id))t.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)});else t.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}return t}},{key:"save",value:function e(t){const i=[];let s="";if(this._postForm){s=this._postForm.oEditor.GetContent();this._commentMessage=s;this._postForm.eventNode.querySelectorAll('input[name="UF_CRM_COMMENT_FILES[]"]').forEach((function(e){i.push(e.value)}))}if(!BX.type.isNotEmptyString(s)){if(!this.emptyCommentMessage){this.emptyCommentMessage=new BX.PopupWindow("timeline_empty_comment_"+this._id,t.target,{content:BX.message("CRM_TIMELINE_EMPTY_COMMENT_MESSAGE"),darkMode:true,autoHide:true,zIndex:990,angle:{position:"top",offset:77},closeByEsc:true,bindOptions:{forceBindPosition:true}})}this.emptyCommentMessage.show();return}if(this._isRequestRunning&&BX.type.isNotEmptyString(s)){return}this._isRequestRunning=true;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"UPDATE_COMMENT",ID:this.getId(),TEXT:s,OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ATTACHMENTS:i},onsuccess:BX.delegate(this.onSaveSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})}},{key:"processRemoval",value:function e(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";let t=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!t){t=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getMessage("commentRemove")})}t.open().then(BX.delegate(this.onRemovalConfirm,this),BX.delegate(this.onRemovalCancel,this))}},{key:"onRemovalConfirm",value:function e(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this.remove()}},{key:"onRemovalCancel",value:function e(){}},{key:"remove",value:function e(i){if(this._isRequestRunning){return}const s=this._history._manager.getHistory();const n=s.findItemById(this._id);if(n instanceof t)n.clearAnimate();const a=this._history._manager.getFixedHistory();const r=a.findItemById(this._id);if(r instanceof t)r.clearAnimate();this._isRequestRunning=true;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"DELETE_COMMENT",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this.getId()},onsuccess:BX.delegate(this.onRemoveSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})}},{key:"refreshLayout",value:function e(){this._playerWrappers={};babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"refreshLayout",this).call(this)}},{key:"onSaveSuccess",value:function e(i){this._isRequestRunning=false;const s=BX.prop.getObject(i,"HISTORY_ITEM");const n=this._fixedHistory.findItemById(this._id);if(n instanceof t){if(!BX.type.isNotEmptyString(s["IS_FIXED"]))s["IS_FIXED"]="Y";n.setData(s);n._id=BX.prop.getString(s,"ID");n.switchToViewMode()}const a=this._history.findItemById(this._id);if(a instanceof t){a.setData(s);a._id=BX.prop.getString(s,"ID");a.switchToViewMode()}this._postForm=null}},{key:"onRemoveSuccess",value:function e(t){}},{key:"onRequestFailure",value:function e(t){this._isRequestRunning=this._isLocked=false}},{key:"onExpandButtonClick",value:function e(t){if(!this._wrapper){return BX.PreventDefault(t)}const i=this._wrapper.querySelector("div.crm-entity-stream-section-content");if(!i){return BX.PreventDefault(t)}if(this._hasFiles&&BX.type.isDomNode(this._commentWrapper)&&!this._textLoaded){this._textLoaded=true;this.loadContent(this._commentWrapper,"GET_TEXT")}const s=i.querySelector(".crm-entity-stream-content-event");if(this._isCollapsed){s.style.maxHeight=s.scrollHeight+130+"px";BX.removeClass(i,"crm-entity-stream-section-content-collapsed");BX.addClass(i,"crm-entity-stream-section-content-expand");setTimeout(BX.delegate((function(){s.style.maxHeight=""}),this),300)}else{s.style.maxHeight=s.clientHeight+"px";BX.removeClass(i,"crm-entity-stream-section-content-expand");BX.addClass(i,"crm-entity-stream-section-content-collapsed");setTimeout(BX.delegate((function(){s.style.maxHeight=""}),this),0)}this._isCollapsed=!this._isCollapsed;const n=i.querySelector("a.crm-entity-stream-section-content-expand-btn");if(n){n.innerHTML=this.getMessage(this._isCollapsed?"expand":"collapse")}return BX.PreventDefault(t)}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);let Wait$2=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getTitle",value:function e(){return this.getMessage("wait")}},{key:"prepareTitleLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]})}},{key:"prepareTimeLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})}},{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=BX.util.trim(i);i=BX.util.strip_tags(i);i=BX.util.nl2br(i)}const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-wait"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-complete"}}));const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[n]}));const a=this.prepareHeaderLayout();n.appendChild(a);const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},html:i});n.appendChild(r);const o=this.prepareAuthorLayout();if(o){n.appendChild(o)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});n.appendChild(this._actionContainer);return s}},{key:"prepareActions",value:function e(){}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Sender=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getDataSetting",value:function e(t){const i=this.getObjectDataParam("SETTINGS")||{};return i[t]||null}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"getTitle",value:function e(){return this.getDataSetting("messageName")}},{key:"prepareTitleLayout",value:function e(){const t=this;return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},children:[this.isRemoved()?BX.create("SPAN",{text:this.getTitle()}):BX.create("A",{attrs:{href:""},events:{click:function(e){if(BX.SidePanel){BX.SidePanel.Instance.open(t.getDataSetting("path"))}else{top.location.href=t.getDataSetting("path")}e.preventDefault();e.stopPropagation()}},text:this.getTitle()})]})}},{key:"prepareTimeLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})}},{key:"prepareStatusLayout",value:function e(){let t,i;if(this.getDataSetting("isError")){i=this.getMessage("error");t="crm-entity-stream-content-event-missing"}else if(this.getDataSetting("isUnsub")){i=this.getMessage("unsub");t="crm-entity-stream-content-event-missing"}else if(this.getDataSetting("isClick")){i=this.getMessage("click");t="crm-entity-stream-content-event-successful"}else{i=this.getMessage("read");t="crm-entity-stream-content-event-skipped"}return BX.create("SPAN",{attrs:{className:t},text:i})}},{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());if(this.getDataSetting("isError")||this.getDataSetting("isRead")||this.getDataSetting("isUnsub")){t.appendChild(this.prepareStatusLayout())}t.appendChild(this.prepareTimeLayout());return t}},{key:"isRemoved",value:function e(){return!this.getDataSetting("letterTitle")}},{key:"prepareContent",value:function e(){const t=this.isRemoved()?this.getMessage("removed"):this.getMessage("title")+": "+this.getDataSetting("letterTitle");const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-wait"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-complete"}}));const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));const n=this.prepareHeaderLayout();s.appendChild(n);const a=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},html:t});s.appendChild(a);const r=this.prepareAuthorLayout();if(r){s.appendChild(r)}return i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Bizproc=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getTitle",value:function e(){const t=this.getTextDataParam("TYPE");if(t==="AUTOMATION_DEBUG_INFORMATION"){return this.getMessage("automationDebugger")}return this.getMessage("bizproc")}},{key:"prepareContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-bp"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-bp"}}));const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const s=this.prepareHeaderLayout();i.appendChild(s);i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},html:this.prepareContentTextHtml()})]}));const n=this.prepareAuthorLayout();if(n){i.appendChild(n)}t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));return t}},{key:"prepareContentTextHtml",value:function e(){const t=this.getTextDataParam("TYPE");if(t==="ACTIVITY_ERROR"){return"<strong>#TITLE#</strong>: #ERROR_TEXT#".replace("#TITLE#",BX.util.htmlspecialchars(this.getTextDataParam("ACTIVITY_TITLE"))).replace("#ERROR_TEXT#",BX.util.htmlspecialchars(this.getTextDataParam("ERROR_TEXT")))}else if(t==="AUTOMATION_DEBUG_INFORMATION"){return BX.Text.encode(this.getTextDataParam("AUTOMATION_DEBUG_TEXT"))}const i=this.getTextDataParam("WORKFLOW_TEMPLATE_NAME");const s=this.getTextDataParam("WORKFLOW_STATUS_NAME");if(!i||s!=="Created"&&s!=="Completed"&&s!=="Terminated"){return BX.util.htmlspecialchars(this.getTextDataParam("COMMENT"))}let n=BX.message("CRM_TIMELINE_BIZPROC_CREATED");if(s==="Completed"){n=BX.message("CRM_TIMELINE_BIZPROC_COMPLETED")}else if(s==="Terminated"){n=BX.message("CRM_TIMELINE_BIZPROC_TERMINATED")}return BX.util.htmlspecialchars(n).replace("#NAME#","<strong>"+BX.util.htmlspecialchars(i)+"</strong>")}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);let Scoring=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-scoring"},events:{click:function(){let e="/crm/ml/#entity#/#id#/detail";const t=this.getOwnerTypeId();const i=this.getOwnerId();let s;if(t===1){s="lead"}else if(t===2){s="deal"}else{return}e=e.replace("#entity#",s);e=e.replace("#id#",i);if(BX.SidePanel){BX.SidePanel.Instance.open(e,{width:840})}else{top.location.href=e}}.bind(this)}});const i=BX.prop.getObject(this._data,"SCORING_INFO",null);if(!i){return t}let s=BX.prop.getNumber(i,"SCORE",0);let n=BX.prop.getNumber(i,"SCORE_DELTA",0);s=Math.round(s*100);n=Math.round(n*100);const a=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-scoring-total-result"},text:s+"%"});let r="crm-entity-stream-content-scoring-total-icon";if(s<50){r+=" crm-entity-stream-content-scoring-total-icon-fail"}else if(s<75){r+=" crm-entity-stream-content-scoring-total-icon-middle"}else{r+=" crm-entity-stream-content-scoring-total-icon-success"}const o=BX.create("DIV",{attrs:{className:r}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-scoring-total"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-scoring-total-text"},text:BX.message("CRM_TIMELINE_SCORING_TITLE_2")}),a,o]}),BX.create("DIV",{attrs:{className:"crm-entity-stream-content-scoring-event"},children:[n!==0?BX.create("DIV",{attrs:{className:"crm-entity-stream-content-scoring-event-offset"},text:(n>0?"+":"")+n+"%"}):null]})]}));return t}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);let Expand=function(){function e(){babelHelpers.classCallCheck(this,e);this._node=null;this._callback=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._node=t;this._callback=BX.type.isFunction(i)?i:null}},{key:"run",value:function e(){const t=BX.pos(this._node);this._node.style.height=0;this._node.style.opacity=0;this._node.style.overflow="hidden";new BX.easing({duration:150,start:{height:0},finish:{height:t.height},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.delegate(this.onNodeHeightStep,this),complete:BX.delegate(this.onNodeHeightComplete,this)}).animate()}},{key:"onNodeHeightStep",value:function e(t){this._node.style.height=t.height+"px"}},{key:"onNodeHeightComplete",value:function e(){this._node.style.overflow="";new BX.easing({duration:150,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.delegate(this.onNodeOpacityStep,this),complete:BX.delegate(this.onNodeOpacityComplete,this)}).animate()}},{key:"onNodeOpacityStep",value:function e(t){this._node.style.opacity=t.opacity/100}},{key:"onNodeOpacityComplete",value:function e(){this._node.style.height="";this._node.style.opacity="";if(this._callback){this._callback()}}}],[{key:"create",value:function t(i,s){const n=new e;n.initialize(i,s);return n}}]);return e}();let History$1=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._items=[];e._wrapper=null;e._fixedHistory=null;e._emptySection=null;e._currentDaySection=null;e._lastDaySection=null;e._lastDate=null;e._anchor=null;e._history=babelHelpers.assertThisInitialized(e);e._enableLoading=false;e._navigation=null;e._scrollHandler=null;e._loadingWaiter=null;e._filterId="";e._isFilterApplied=false;e._isFilterShown=false;e._isRequestRunning=false;e._filterButton=null;e._filterWrapper=null;e._filterResultStub=null;return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){this._fixedHistory=this.getSetting("fixedHistory");this._ownerTypeId=this.getSetting("ownerTypeId");this._ownerId=this.getSetting("ownerId");this._serviceUrl=this.getSetting("serviceUrl","");if(!this.isStubMode()){let e=this.getSetting("itemData");if(!BX.type.isArray(e)){e=[]}let t,i,s;for(t=0,i=e.length;t<i;t++){s=this.createItem(e[t]);if(s){this._items.push(s)}}this._navigation=this.getSetting("navigation",{});this._filterWrapper=BX("timeline-filter");this._filterId=BX.prop.getString(this._settings,"filterId",this._id);this._isFilterShown=this._filterWrapper&&BX.hasClass(this._filterWrapper,"crm-entity-stream-section-filter-show");this._isFilterApplied=BX.prop.getBoolean(this._settings,"isFilterApplied",false);BX.addCustomEvent("BX.Main.Filter:apply",this.onFilterApply.bind(this))}}},{key:"layout",value:function e(){this._wrapper=BX.create("DIV",{});this._container.appendChild(this._wrapper);const t=BX.prop.extractDate(new Date);let i,s,n;if(!this.isStubMode()){if(this._filterWrapper){const e=this._filterWrapper.querySelector(".crm-entity-stream-filter-close");if(e){BX.bind(e,"click",this.onFilterClose.bind(this))}}for(i=0,s=this._items.length;i<s;i++){n=this._items[i];n.setContainer(this._wrapper);const e=n.getCreatedDate();if(this._lastDate===null||this._lastDate.getTime()!==e.getTime()){this._lastDate=e;if(t.getTime()===e.getTime()){this._currentDaySection=this._lastDaySection=this.createCurrentDaySection();this._wrapper.appendChild(this._currentDaySection)}else{this._lastDaySection=this.createDaySection(this._lastDate);this._wrapper.appendChild(this._lastDaySection)}}n._lastDate=this._lastDate;n.layout()}this.enableLoading(this._items.length>0);this.refreshLayout()}else{this._currentDaySection=this._lastDaySection=this.createCurrentDaySection();this._wrapper.appendChild(this._currentDaySection);this._wrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-createEntity crm-entity-stream-section-last"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},text:BX.message("CRM_TIMELINE_HISTORY_STUB")})]})]})]}))}this._manager.processHistoryLayoutChange()}},{key:"refreshLayout",value:function e(){if(this._filterWrapper){if(this._wrapper.firstChild&&this._filterWrapper!==this._wrapper.firstChild){this._wrapper.insertBefore(this._filterWrapper,this._wrapper.firstChild)}else if(!this._wrapper.firstChild&&this._filterWrapper.parentNode!==this._wrapper){this._wrapper.appendChild(this._filterWrapper)}}this.adjustFilterButton();const t=this._items.length;if(t===0&&this._isFilterApplied){if(!this._filterEmptyResultSection){this._filterEmptyResultSection=this.createFilterEmptyResultSection()}this._wrapper.appendChild(this._filterEmptyResultSection);return}if(this._filterEmptyResultSection){this._filterEmptyResultSection=BX.remove(this._filterEmptyResultSection)}if(t===0){return}for(let e=0;e<t-1;e++){const t=this._items[e];if(t.isTerminated()){t.markAsTerminated(false)}}this._items[t-1].markAsTerminated(true)}},{key:"calculateItemIndex",value:function e(t){return 0}},{key:"checkItemForTermination",value:function e(t){return this.getLastItem()===t}},{key:"hasContent",value:function e(){return this._items.length>0||this._isFilterApplied||this._isStubMode}},{key:"getItems",value:function e(){return this._items}},{key:"setItems",value:function e(t){this._items=t}},{key:"getItemByIndex",value:function e(t){return t<this._items.length?this._items[t]:null}},{key:"getItemCount",value:function e(){return this._items.length}},{key:"getItemsByAssociatedEntity",value:function e(t,i){if(!BX.type.isNumber(t)){t=parseInt(t)}if(!BX.type.isNumber(i)){i=parseInt(i)}if(isNaN(t)||t<=0||isNaN(i)||i<=0){return[]}const s=[];for(let e=0,n=this._items.length;e<n;e++){const n=this._items[e];if(n.getAssociatedEntityTypeId()===t&&n.getAssociatedEntityId()===i){s.push(n)}}return s}},{key:"createFilterEmptyResultSection",value:function e(){return BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-filter-empty"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-filter-empty"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-filter-empty-img"}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-filter-empty-text"},text:this.getMessage("filterEmptyResultStub")})]})]})]})}},{key:"adjustFilterButton",value:function e(){if(!this._filterWrapper){return}if(!this._isFilterShown&&this._items.length===0){if(!this._emptySection){this._emptySection=this.createEmptySection()}this._wrapper.insertBefore(this._emptySection,this._filterWrapper)}else if(this._emptySection){this._emptySection=BX.remove(this._emptySection)}if(!this._filterButton){this._filterButton=BX.create("BUTTON",{attrs:{className:"crm-entity-stream-filter-label"},text:this.getMessage("filterButtonCaption")});BX.bind(this._filterButton,"click",function(e){this.showFilter()}.bind(this))}const t=this._wrapper.querySelector(".crm-entity-stream-section-today-label, .crm-entity-stream-section-planned-label, .crm-entity-stream-section-history-label");if(t){const e=t.querySelector(".crm-entity-stream-section-content");if(e){if(this._filterButton.parentNode!==e){e.appendChild(this._filterButton)}}}if(this._isFilterApplied){BX.addClass(this._filterButton,"crm-entity-stream-filter-label-active")}else{BX.removeClass(this._filterButton,"crm-entity-stream-filter-label-active")}}},{key:"showFilter",value:function e(t){if(!this._filterWrapper){return}BX.removeClass(this._filterWrapper,"crm-entity-stream-section-filter-hide");BX.addClass(this._filterWrapper,"crm-entity-stream-section-filter-show");this._isFilterShown=true;if(BX.prop.getBoolean(t,"enableAdjust",true)){this.adjustFilterButton()}}},{key:"hideFilter",value:function e(t){if(!this._filterWrapper){return}BX.removeClass(this._filterWrapper,"crm-entity-stream-section-filter-show");BX.addClass(this._filterWrapper,"crm-entity-stream-section-filter-hide");this._isFilterShown=false;if(BX.prop.getBoolean(t,"enableAdjust",true)){this.adjustFilterButton()}}},{key:"onFilterClose",value:function e(t){this.hideFilter();window.setTimeout(function(){const e=BX.Main.filterManager.getById(this._filterId);if(e){e.resetFilter()}}.bind(this),500)}},{key:"createEmptySection",value:function e(){return BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-planned-label"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}})]})}},{key:"createCurrentDaySection",value:function e(){let t=this.formatDate(BX.prop.extractDate(new Date));t=t[0].toUpperCase()+t.substring(1);return BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-today-label"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-today-label"},text:t})]})]})}},{key:"createDaySection",value:function e(t){let i=this.formatDate(t);i=i[0].toUpperCase()+i.substring(1);return BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history-label"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-history-label"},text:i})]})]})}},{key:"createAnchor",value:function e(t){if(this._emptySection){this._emptySection=BX.remove(this._emptySection)}if(this._currentDaySection===null){this._currentDaySection=this.createCurrentDaySection();if(this._wrapper.firstChild){this._wrapper.insertBefore(this._currentDaySection,this._wrapper.firstChild)}else{this._wrapper.appendChild(this._currentDaySection)}}if(this._anchor===null){this._anchor=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-shadow"}});if(this._currentDaySection.nextSibling){this._wrapper.insertBefore(this._anchor,this._currentDaySection.nextSibling)}else{this._wrapper.appendChild(this._anchor)}}return this._anchor}},{key:"createActivityItem",value:function e(t){const i=BX.prop.getInteger(t,"TYPE_ID",Item.undefined);const s=BX.prop.getInteger(t,"TYPE_CATEGORY_ID",0);const n=BX.prop.getString(BX.prop.getObject(t,"ASSOCIATED_ENTITY",{}),"PROVIDER_ID","");if(i!==Item.activity){return null}if(s===BX.CrmActivityType.email){return Email$2.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}if(s===BX.CrmActivityType.call){return Call$2.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(s===BX.CrmActivityType.meeting){return Meeting$1.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(s===BX.CrmActivityType.task){return Task$1.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(s===BX.CrmActivityType.provider){if(n==="CRM_WEBFORM"){return WebForm$1.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(n==="CRM_REQUEST"){return Request$1.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(n==="IMOPENLINES_SESSION"){return OpenLine$2.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(n==="REST_APP"){return Rest$2.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(n==="VISIT_TRACKER"){return Visit.create(t["ID"],{history:this,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(n==="ZOOM"){return Zoom$1.create(t["ID"],{history:this,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(n==="CRM_CALL_TRACKER"){return Call$2.create(t["ID"],{history:this,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}}return HistoryActivity.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}},{key:"createExternalNotificationItem",value:function e(t){const i=BX.prop.getInteger(t,"TYPE_CATEGORY_ID",0);const s=BX.prop.getString(t,"CHANGED_FIELD_NAME","");if(i===Item.modification&&s==="STATUS_ID"){return ExternalNoticeStatusModification.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:t})}return ExternalNoticeModification.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:t})}},{key:"createItem",value:function e(t){if(t.hasOwnProperty("type")){return crm_timeline_item.ConfigurableItem.create(t.id,{timelineId:this.getId(),container:this.getWrapper(),itemClassName:this.getItemClassName(),useShortTimeFormat:this.getStreamType()===crm_timeline_item.StreamType.history,isReadOnly:this.isReadOnly(),currentUser:this._manager.getCurrentUser(),ownerTypeId:this._manager.getOwnerTypeId(),ownerId:this._manager.getOwnerId(),streamType:this.getStreamType(),data:t})}const i=BX.prop.getInteger(t,"TYPE_ID",Item.undefined);const s=BX.prop.getInteger(t,"TYPE_CATEGORY_ID",0);if(i===Item.activity){return this.createActivityItem(t)}else if(i===Item.externalNotification){return this.createExternalNotificationItem(t)}else if(i===Item.creation){return Creation.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.restoration){return Restoration.create(t["ID"],{history:this._history,container:this._wrapper,data:t})}else if(i===Item.link){return Link.create(t["ID"],{history:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.unlink){return Unlink.create(t["ID"],{history:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.mark){return Mark$1.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,fixedHistory:this._fixedHistory,data:t})}else if(i===Item.comment){return Comment$1.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.wait){return Wait$2.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.document){return Document.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.sender){return Sender.create(t["ID"],{history:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.modification){return Modification.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.conversion){return Conversion.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.bizproc){return Bizproc.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.scoring){return Scoring.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}return History.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}},{key:"getWrapper",value:function e(){return this._wrapper}},{key:"getItemClassName",value:function e(){return"crm-entity-stream-section crm-entity-stream-section-history"}},{key:"addItem",value:function e(t,i){if(!BX.type.isNumber(i)||i<0){i=this.calculateItemIndex(t)}if(i<this._items.length){this._items.splice(i,0,t)}else{this._items.push(t)}this.refreshLayout();this._manager.processHistoryLayoutChange()}},{key:"deleteItem",value:function e(t){const i=this.getItemIndex(t);if(i<0){return}t.clearLayout();this.removeItemByIndex(i);this.refreshLayout();this._manager.processHistoryLayoutChange()}},{key:"resetLayout",value:function e(){let t;for(t=this._items.length-1;t>=0;t--){this._items[t].clearLayout()}this._items=[];this._currentDaySection=this._lastDaySection=this._emptySection=this._filterEmptyResultSection=null;this._anchor=null;this._lastDate=null;const i=[];let s;for(t=0;s=this._wrapper.children[t];t++){if(s!==this._filterWrapper){i.push(s)}}for(t=0;s=i[t];t++){this._wrapper.removeChild(s)}}},{key:"onWindowScroll",value:function e(t){if(!this._loadingWaiter||!this._enableLoading||this._isRequestRunning){return}const i=this._loadingWaiter.getBoundingClientRect();if(i.top<=document.documentElement.clientHeight){this.loadItems()}}},{key:"onFilterApply",value:function e(t,i,s,n,a){if(t!==this._filterId){return}a.autoResolve=false;this._isFilterApplied=BX.prop.getString(i,"action","")==="apply";this._isRequestRunning=true;BX.CrmDataLoader.create(this._id,{serviceUrl:this.getSetting("serviceUrl",""),action:"GET_HISTORY_ITEMS",params:{GUID:this._id,OWNER_TYPE_ID:this._manager.getOwnerTypeId(),OWNER_ID:this._manager.getOwnerId()}}).load(function(e,t){this.resetLayout();this.bulkCreateItems(BX.prop.getArray(t,"HISTORY_ITEMS",[]));this.setNavigation(BX.prop.getObject(t,"HISTORY_NAVIGATION",{}));this.refreshLayout();if(this._items.length>0){this._manager.processHistoryLayoutChange()}n.fulfill();this._isRequestRunning=false}.bind(this))}},{key:"bulkCreateItems",value:function e(t){const i=t.length;if(i===0){return}if(this._filterEmptyResultSection){this._filterEmptyResultSection=BX.remove(this._filterEmptyResultSection)}const s=BX.prop.extractDate(new Date);let n,a;for(n=0;n<i;n++){const e=BX.prop.getInteger(t[n],"id",BX.prop.getInteger(t[n],"ID",0));if(e<=0){continue}if(this.findItemById(e)!==null){continue}a=this.createItem(t[n]);this._items.push(a);const i=a.getCreatedDate();if(this._lastDate===null||this._lastDate.getTime()!==i.getTime()){this._lastDate=i;if(s.getTime()===i.getTime()){this._currentDaySection=this._lastDaySection=this.createCurrentDaySection();this._wrapper.appendChild(this._currentDaySection)}else{this._lastDaySection=this.createDaySection(this._lastDate);this._wrapper.appendChild(this._lastDaySection)}}a.layout()}}},{key:"loadItems",value:function e(){this._isRequestRunning=true;BX.CrmDataLoader.create(this._id,{serviceUrl:this.getSetting("serviceUrl",""),action:"GET_HISTORY_ITEMS",params:{GUID:this._id,OWNER_TYPE_ID:this._manager.getOwnerTypeId(),OWNER_ID:this._manager.getOwnerId(),NAVIGATION:this._navigation}}).load(function(e,t){this.bulkCreateItems(BX.prop.getArray(t,"HISTORY_ITEMS",[]));this.setNavigation(BX.prop.getObject(t,"HISTORY_NAVIGATION",{}));this.refreshLayout();if(this._items.length>0){this._manager.processHistoryLayoutChange()}this._isRequestRunning=false}.bind(this))}},{key:"getNavigation",value:function e(){return this._navigation}},{key:"setNavigation",value:function e(t){if(!BX.type.isPlainObject(t)){t={}}this._navigation=t;this.enableLoading(BX.prop.getString(this._navigation,"OFFSET_TIMESTAMP","")!=="")}},{key:"isLoadingEnabled",value:function e(){return this._enableLoading}},{key:"enableLoading",value:function e(t){t=!!t;if(this._enableLoading===t){return}this._enableLoading=t;if(this._enableLoading){if(this._items.length>0){this._loadingWaiter=this._items[this._items.length-1].getWrapper()}if(!this._scrollHandler){this._scrollHandler=BX.delegate(this.onWindowScroll,this);BX.bind(window,"scroll",this._scrollHandler)}}else{this._loadingWaiter=null;if(this._scrollHandler){BX.unbind(window,"scroll",this._scrollHandler);this._scrollHandler=null}}}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"animateItemAdding",value:function e(t){return new Promise((e=>{Expand.create(t.getWrapper(),e).run()}))}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);t.instances[n.getId()]=n;return n}}]);return t}(Steam);babelHelpers.defineProperty(History$1,"messages",{});babelHelpers.defineProperty(History$1,"instances",{});let FixedHistory=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._items=[];e._wrapper=null;e._fixedHistory=babelHelpers.assertThisInitialized(e);e._history=babelHelpers.assertThisInitialized(e);e._isRequestRunning=false;return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){const t=BX.message("FORMAT_DATETIME").replace(/:SS/,"");this._timeFormat=BX.date.convertBitrixFormat(t);let i=this.getSetting("itemData");if(!BX.type.isArray(i)){i=[]}let s,n,a;for(s=0,n=i.length;s<n;s++){a=this.createItem(i[s]);a._isFixed=true;this._items.push(a)}}},{key:"setHistory",value:function e(t){this._history=t}},{key:"checkItemForTermination",value:function e(t){return false}},{key:"layout",value:function e(){this._wrapper=BX.create("DIV",{});this.createAnchor();this._container.insertBefore(this._wrapper,this._editorContainer.nextElementSibling);for(let e=0;e<this._items.length;e++){this._items[e].setContainer(this._wrapper);this._items[e].layout()}this.refreshLayout();this._manager.processHistoryLayoutChange()}},{key:"refreshLayout",value:function e(){}},{key:"formatDate",value:function e(t){}},{key:"createCurrentDaySection",value:function e(){}},{key:"createDaySection",value:function e(t){}},{key:"createAnchor",value:function e(t){this._anchor=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-fixed-anchor"}});this._wrapper.appendChild(this._anchor)}},{key:"onWindowScroll",value:function e(t){}},{key:"onItemsLoad",value:function e(t,i){}},{key:"loadItems",value:function e(){this._isRequestRunning=true;BX.CrmDataLoader.create(this._id,{serviceUrl:this.getSetting("serviceUrl",""),action:"GET_FIXED_HISTORY_ITEMS",params:{OWNER_TYPE_ID:this._manager.getOwnerTypeId(),OWNER_ID:this._manager.getOwnerId()}}).load(BX.delegate(this.onItemsLoad,this))}},{key:"addItem",value:function e(i,s){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"addItem",this).call(this,i,s);if(i instanceof CompatibleItem){i._isFixed=true}}},{key:"getItemClassName",value:function e(){return"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-top-fixed"}},{key:"getStreamType",value:function e(){return crm_timeline_item.StreamType.pinned}}],[{key:"create",value:function e(i,s){let n=new t;n.initialize(i,s);this.instances[n.getId()]=n;return n}}]);return t}(History$1);FixedHistory.instances={};function _classPrivateMethodInitSpec$1(e,t){_checkPrivateRedeclaration$1(e,t);t.add(e)}function _classPrivateFieldInitSpec$1(e,t,i){_checkPrivateRedeclaration$1(e,t);t.set(e,i)}function _checkPrivateRedeclaration$1(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$1(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var _scheduleStream=new WeakMap;var _fixedHistoryStream=new WeakMap;var _historyStream=new WeakMap;var _itemsQueue=new WeakMap;var _itemsQueueProcessing=new WeakMap;var _reloadingMessagesQueue=new WeakMap;var _ownerTypeId=new WeakMap;var _ownerId=new WeakMap;var _itemDataShouldBeReloaded=new WeakSet;var _addToQueue=new WeakSet;var _processQueueItem=new WeakSet;var _addItem=new WeakSet;var _updateItem=new WeakSet;var _deleteItem=new WeakSet;var _moveItem=new WeakSet;var _pinItem=new WeakSet;var _unpinItem=new WeakSet;var _getStreamByName=new WeakSet;var _fetchItems=new WeakSet;let PullActionProcessor=function(){function e(t){babelHelpers.classCallCheck(this,e);_classPrivateMethodInitSpec$1(this,_fetchItems);_classPrivateMethodInitSpec$1(this,_getStreamByName);_classPrivateMethodInitSpec$1(this,_unpinItem);_classPrivateMethodInitSpec$1(this,_pinItem);_classPrivateMethodInitSpec$1(this,_moveItem);_classPrivateMethodInitSpec$1(this,_deleteItem);_classPrivateMethodInitSpec$1(this,_updateItem);_classPrivateMethodInitSpec$1(this,_addItem);_classPrivateMethodInitSpec$1(this,_processQueueItem);_classPrivateMethodInitSpec$1(this,_addToQueue);_classPrivateMethodInitSpec$1(this,_itemDataShouldBeReloaded);_classPrivateFieldInitSpec$1(this,_scheduleStream,{writable:true,value:null});_classPrivateFieldInitSpec$1(this,_fixedHistoryStream,{writable:true,value:null});_classPrivateFieldInitSpec$1(this,_historyStream,{writable:true,value:null});_classPrivateFieldInitSpec$1(this,_itemsQueue,{writable:true,value:[]});_classPrivateFieldInitSpec$1(this,_itemsQueueProcessing,{writable:true,value:false});_classPrivateFieldInitSpec$1(this,_reloadingMessagesQueue,{writable:true,value:[]});_classPrivateFieldInitSpec$1(this,_ownerTypeId,{writable:true,value:void 0});_classPrivateFieldInitSpec$1(this,_ownerId,{writable:true,value:void 0});if(!main_core.Type.isObject(t.scheduleStream)||!main_core.Type.isObject(t.fixedHistoryStream)||!main_core.Type.isObject(t.historyStream)){throw new Error(`params scheduleStream, fixedHistoryStream and historyStream are required`)}if(!main_core.Type.isNumber(t.ownerTypeId)||!main_core.Type.isNumber(t.ownerId)){throw new Error("params ownerTypeId and ownerId are required")}babelHelpers.classPrivateFieldSet(this,_scheduleStream,t.scheduleStream);babelHelpers.classPrivateFieldSet(this,_fixedHistoryStream,t.fixedHistoryStream);babelHelpers.classPrivateFieldSet(this,_historyStream,t.historyStream);babelHelpers.classPrivateFieldSet(this,_ownerTypeId,t.ownerTypeId);babelHelpers.classPrivateFieldSet(this,_ownerId,t.ownerId)}babelHelpers.createClass(e,[{key:"processAction",value:function e(t){if(_classPrivateMethodGet$1(this,_itemDataShouldBeReloaded,_itemDataShouldBeReloaded2).call(this,t)){babelHelpers.classPrivateFieldGet(this,_reloadingMessagesQueue).push(t);_classPrivateMethodGet$1(this,_fetchItems,_fetchItems2).call(this)}else{_classPrivateMethodGet$1(this,_addToQueue,_addToQueue2).call(this,t)}}}]);return e}();function _itemDataShouldBeReloaded2(e){const{item:t}=e;if(!t){return false}const i=main_core.Loc.getMessage("LANGUAGE_ID").toLowerCase();const s=BX.prop.getString(t,"languageId",i).toLowerCase();const n=BX.prop.getBoolean(t,"canBeReloaded",true);return s!==i&&n}function _addToQueue2(e){babelHelpers.classPrivateFieldGet(this,_itemsQueue).push(e);if(!babelHelpers.classPrivateFieldGet(this,_itemsQueueProcessing)){_classPrivateMethodGet$1(this,_processQueueItem,_processQueueItem2).call(this)}}function _processQueueItem2(){if(!babelHelpers.classPrivateFieldGet(this,_itemsQueue).length){babelHelpers.classPrivateFieldSet(this,_itemsQueueProcessing,false);return}babelHelpers.classPrivateFieldSet(this,_itemsQueueProcessing,true);const e=babelHelpers.classPrivateFieldGet(this,_itemsQueue).shift();const t=_classPrivateMethodGet$1(this,_getStreamByName,_getStreamByName2).call(this,e.stream);const i=[];switch(e.action){case"add":i.push(_classPrivateMethodGet$1(this,_addItem,_addItem2).call(this,e.id,e.item,t));break;case"update":i.push(_classPrivateMethodGet$1(this,_updateItem,_updateItem2).call(this,e.id,e.item,t,false,true));if(t.isHistoryStream()){i.push(_classPrivateMethodGet$1(this,_updateItem,_updateItem2).call(this,e.id,e.item,babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream),false,true))}break;case"delete":i.push(_classPrivateMethodGet$1(this,_deleteItem,_deleteItem2).call(this,e.id,t));if(t.isHistoryStream()){i.push(_classPrivateMethodGet$1(this,_deleteItem,_deleteItem2).call(this,e.id,babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream)))}break;case"move":const s=_classPrivateMethodGet$1(this,_getStreamByName,_getStreamByName2).call(this,e.params.fromStream);i.push(_classPrivateMethodGet$1(this,_moveItem,_moveItem2).call(this,e.params.fromId,s,e.id,t,e.item));break;case"changePinned":if(_classPrivateMethodGet$1(this,_getStreamByName,_getStreamByName2).call(this,e.params.fromStream).isHistoryStream()){i.push(_classPrivateMethodGet$1(this,_pinItem,_pinItem2).call(this,e.id,e.item))}else{i.push(_classPrivateMethodGet$1(this,_unpinItem,_unpinItem2).call(this,e.id,e.item))}}Promise.all(i).then((()=>{_classPrivateMethodGet$1(this,_processQueueItem,_processQueueItem2).call(this)}))}function _addItem2(e,t,i){const s=i.findItemById(e);if(s){return Promise.resolve()}const n=i.createItem(t);if(!n){return Promise.resolve()}const a=i.calculateItemIndex(n);const r=i.createAnchor(a);i.addItem(n,a);n.layout({anchor:r});return i.animateItemAdding(n)}function _updateItem2(e,t,i,s=true,n){const a=BX.prop.getString(t["ASSOCIATED_ENTITY"],"COMPLETED")==="Y";const r=i.findItemById(e);if(!r){return Promise.resolve()}if(r instanceof CompatibleItem&&a){r._existedStreamItemDeadLine=r.getDeadline()}r.setData(t);return i.refreshItem(r,s,n)}function _deleteItem2(e,t){const i=t.findItemById(e);if(i){return t.deleteItemAnimated(i)}return Promise.resolve()}function _moveItem2(e,t,i,s,n){const a=t.findItemById(e);if(!a){return _classPrivateMethodGet$1(this,_addItem,_addItem2).call(this,i,n,s)}const r=s.findItemById(i);if(a&&r){return _classPrivateMethodGet$1(this,_deleteItem,_deleteItem2).call(this,e,t)}const o=s.createItem(n);s.addItem(o,s.calculateItemIndex(o));o.layout({add:false});return t.moveItemToStream(a,s,o)}function _pinItem2(e,t){if(babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream).findItemById(e)){return Promise.resolve()}const i=babelHelpers.classPrivateFieldGet(this,_historyStream).findItemById(e);if(!i){return _classPrivateMethodGet$1(this,_addItem,_addItem2).call(this,e,t,babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream))}if(i instanceof CompatibleItem){i.onSuccessFasten();return Promise.resolve()}else{return _classPrivateMethodGet$1(this,_updateItem,_updateItem2).call(this,e,t,babelHelpers.classPrivateFieldGet(this,_historyStream),false,false).then((()=>{const e=babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream).createItem(t);babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream).addItem(e,0);e.layout({add:false});return new Promise((t=>{const s=Fasten.create("",{initialItem:i,finalItem:e,anchor:babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream).getAnchor(),events:{complete:t}});s.run()}))}))}}function _unpinItem2(e,t){const i=babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream).findItemById(e);if(i instanceof CompatibleItem){i.onSuccessUnfasten();return Promise.resolve()}else{return _classPrivateMethodGet$1(this,_updateItem,_updateItem2).call(this,e,t,babelHelpers.classPrivateFieldGet(this,_historyStream),false,false).then((()=>_classPrivateMethodGet$1(this,_deleteItem,_deleteItem2).call(this,e,babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream))))}}function _getStreamByName2(e){switch(e){case"scheduled":return babelHelpers.classPrivateFieldGet(this,_scheduleStream);case"fixedHistory":return babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream);case"history":return babelHelpers.classPrivateFieldGet(this,_historyStream)}throw new Error(`Stream "${e}" not found`)}function _fetchItems2(){setTimeout((()=>{const e=main_core.clone(babelHelpers.classPrivateFieldGet(this,_reloadingMessagesQueue));babelHelpers.classPrivateFieldSet(this,_reloadingMessagesQueue,[]);const t=[];const i=[];e.forEach((e=>{const s=e.stream==="scheduled"?t:i;s.push(e.id)}));if(e.length){const s={activityIds:t,historyIds:i,ownerTypeId:babelHelpers.classPrivateFieldGet(this,_ownerTypeId),ownerId:babelHelpers.classPrivateFieldGet(this,_ownerId)};main_core.ajax.runAction("crm.timeline.item.load",{data:s}).then((t=>{e.forEach((e=>{if(t.data[e.id]){e.item=t.data[e.id]}_classPrivateMethodGet$1(this,_addToQueue,_addToQueue2).call(this,e)}))})).catch((t=>{console.error(t);e.forEach((e=>_classPrivateMethodGet$1(this,_addToQueue,_addToQueue2).call(this,e)))}))}}),1500)}function _classPrivateFieldInitSpec$2(e,t,i){_checkPrivateRedeclaration$2(e,t);t.set(e,i)}function _checkPrivateRedeclaration$2(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classStaticPrivateFieldSpecSet(e,t,i,s){_classCheckPrivateStaticAccess(e,t);_classCheckPrivateStaticFieldDescriptor(i,"set");_classApplyDescriptorSet(e,i,s);return s}function _classApplyDescriptorSet(e,t,i){if(t.set){t.set.call(e,i)}else{if(!t.writable){throw new TypeError("attempted to set read only private field")}t.value=i}}function _classStaticPrivateFieldSpecGet(e,t,i){_classCheckPrivateStaticAccess(e,t);_classCheckPrivateStaticFieldDescriptor(i,"get");return _classApplyDescriptorGet(e,i)}function _classCheckPrivateStaticFieldDescriptor(e,t){if(e===undefined){throw new TypeError("attempted to "+t+" private static field before its declaration")}}function _classCheckPrivateStaticAccess(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function _classApplyDescriptorGet(e,t){if(t.get){return t.get.call(e)}return t.value}var _itemPullActionProcessor=new WeakMap;let Manager=function(){function e(){babelHelpers.classCallCheck(this,e);_classPrivateFieldInitSpec$2(this,_itemPullActionProcessor,{writable:true,value:null});this._id="";this._settings={};this._container=null;this._ownerTypeId=0;this._ownerId=0;this._ownerInfo=null;this._progressSemantics="";this._commentEditor=null;this._todoEditor=null;this._waitEditor=null;this._smsEditor=null;this._zoomEditor=null;this._chat=null;this._schedule=null;this._history=null;this._fixedHistory=null;this._activityEditor=null;this._menuBar=null;this._userId=0;this._readOnly=false;this._currentUser=null;this._pullTagName=""}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._ownerTypeId=parseInt(this.getSetting("ownerTypeId"));this._ownerId=parseInt(this.getSetting("ownerId"));this._ownerInfo=this.getSetting("ownerInfo");this._progressSemantics=BX.prop.getString(this._settings,"progressSemantics","");this._spotlightFastenShowed=this.getSetting("spotlightFastenShowed",true);this._audioPlaybackRate=parseFloat(this.getSetting("audioPlaybackRate",1));const s=this.getSetting("containerId");if(!BX.type.isNotEmptyString(s)){throw"Manager. A required parameter 'containerId' is missing."}this._container=BX(s);if(!BX.type.isElementNode(this._container)){throw"Manager. Container node is not found."}this._editorContainer=BX(this.getSetting("editorContainer"));this._userId=BX.prop.getInteger(this._settings,"userId",0);this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);this._currentUser=BX.prop.getObject(this._settings,"currentUser",null);const n=this.getSetting("activityEditorId");if(BX.type.isNotEmptyString(n)){this._activityEditor=BX.CrmActivityEditor.items[n];if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"BX.CrmTimeline. Activity editor instance is not found."}}const a=this.getSetting("ajaxId");const r=this.getSetting("currentUrl");const o=this.getSetting("serviceUrl");this._chat=EntityChat.create(this._id,{manager:this,container:this._container,data:this.getSetting("chatData"),isStubMode:this._ownerId<=0,readOnly:this._readOnly});this._schedule=Schedule.create(this._id,{manager:this,container:this._container,activityEditor:this._activityEditor,itemData:this.getSetting("scheduleData"),templates:this.getSetting("templates"),isStubMode:this._ownerId<=0,ajaxId:a,serviceUrl:o,currentUrl:r,userId:this._userId,readOnly:this._readOnly});this._fixedHistory=FixedHistory.create(this._id,{manager:this,container:this._container,editorContainer:this._editorContainer,activityEditor:this._activityEditor,itemData:this.getSetting("fixedData"),templates:this.getSetting("templates"),isStubMode:this._ownerId<=0,ajaxId:a,serviceUrl:o,currentUrl:r,userId:this._userId,readOnly:this._readOnly});this._history=History$1.create(this._id,{manager:this,container:this._container,fixedHistory:this._fixedHistory,activityEditor:this._activityEditor,itemData:this.getSetting("historyData"),templates:this.getSetting("templates"),navigation:this.getSetting("historyNavigation",{}),filterId:BX.prop.getString(this._settings,"historyFilterId",this._id),isFilterApplied:BX.prop.getBoolean(this._settings,"isHistoryFilterApplied",false),isStubMode:this._ownerId<=0,ajaxId:a,serviceUrl:o,currentUrl:r,userId:this._userId,readOnly:this._readOnly});this._schedule.setHistory(this._history);this._fixedHistory.setHistory(this._history);var l=BX.prop.getBoolean(this._settings,"enableTodo",false);this._commentEditor=Comment.create(this._id,{manager:this,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,serviceUrl:this.getSetting("serviceUrl"),container:this.getSetting("editorCommentContainer"),input:this.getSetting("editorCommentInput"),editorName:this.getSetting("editorCommentEditorName"),button:this.getSetting("editorCommentButton"),cancelButton:this.getSetting("editorCommentCancelButton")});this._commentEditor.setVisible(!l&&!this._readOnly);this._commentEditor.setHistory(this._history);if(l){this._todoEditor=ToDo.create(this._id,{manager:this,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,container:this.getSetting("editorTodoContainer"),button:this.getSetting("editorTodoButton"),cancelButton:this.getSetting("editorTodoCancelButton")});this._todoEditor.setVisible(!this._readOnly)}if(BX.prop.getBoolean(this._settings,"enableWait",false)){this._waitEditor=Wait.create(this._id,{manager:this,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,serviceUrl:this.getSetting("serviceUrl"),config:this.getSetting("editorWaitConfig",{}),targetDates:this.getSetting("editorWaitTargetDates",[]),container:this.getSetting("editorWaitContainer"),configContainer:this.getSetting("editorWaitConfigContainer"),input:this.getSetting("editorWaitInput"),button:this.getSetting("editorWaitButton"),cancelButton:this.getSetting("editorWaitCancelButton")});this._waitEditor.setVisible(false)}if(BX.prop.getBoolean(this._settings,"enableSms",false)){this._smsEditor=Sms.create(this._id,{manager:this,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,serviceUrl:this.getSetting("serviceUrl"),config:this.getSetting("editorSmsConfig",{}),container:this.getSetting("editorSmsContainer"),input:this.getSetting("editorSmsInput"),templatesContainer:this.getSetting("editorSmsTemplatesContainer"),button:this.getSetting("editorSmsButton"),cancelButton:this.getSetting("editorSmsCancelButton")});this._smsEditor.setVisible(false)}if(BX.prop.getBoolean(this._settings,"enableZoom",false)&&BX.prop.getBoolean(this._settings,"statusZoom",false)){this._zoomEditor=new BX.Crm.Zoom({id:this._id,manager:this,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,container:this.getSetting("editorZoomContainer"),userId:this._userId});this._zoomEditor.setVisible(false)}if(BX.prop.getBoolean(this._settings,"enableRest",false)){this._restEditor=Rest.create(this._id,{manager:this,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,placement:BX.prop.getString(this._settings,"restPlacement","")})}this._chat.layout();this._schedule.layout();this._fixedHistory.layout();this._history.layout();this._pullTagName=BX.prop.getString(this._settings,"pullTagName","");if(this._pullTagName!==""){BX.addCustomEvent("onPullEvent-crm",BX.delegate(this.onPullEvent,this));this.extendWatch();babelHelpers.classPrivateFieldSet(this,_itemPullActionProcessor,new PullActionProcessor({scheduleStream:this._schedule,fixedHistoryStream:this._fixedHistory,historyStream:this._history,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId}))}this._menuBar=MenuBar.create(this._id,{container:BX(this.getSetting("menuBarContainer")),menuId:this.getSetting("menuBarObjectId"),ownerInfo:this._ownerInfo,activityEditor:this._activityEditor,commentEditor:this._commentEditor,todoEditor:this._todoEditor,waitEditor:this._waitEditor,smsEditor:this._smsEditor,zoomEditor:this._zoomEditor,restEditor:this._restEditor,readOnly:this._readOnly,manager:this});if(!this._readOnly){this._menuBar.reset()}BX.addCustomEvent(window,"Crm.EntityProgress.Change",BX.delegate(this.onEntityProgressChange,this));BX.ready((function(){window.addEventListener("scroll",BX.throttle((function(){BX.LazyLoad.onScroll()}),80))}))}},{key:"extendWatch",value:function e(){if(BX.type.isFunction(BX.PULL)&&this._pullTagName!==""){BX.PULL.extendWatch(this._pullTagName);window.setTimeout(BX.delegate(this.extendWatch,this),6e4)}}},{key:"onPullEvent",value:function e(t,i){if(this._pullTagName!==BX.prop.getString(i,"TAG","")){return}if(t==="timeline_item_action"){babelHelpers.classPrivateFieldGet(this,_itemPullActionProcessor).processAction(i);return}if(t==="timeline_chat_create"){this.processChatCreate(i)}else if(t==="timeline_activity_add"){this.processActivityExternalAdd(i)}else if(t==="timeline_activity_update"){this.processActivityExternalUpdate(i)}else if(t==="timeline_activity_delete"){this.processActivityExternalDelete(i)}else if(t==="timeline_comment_add"){this.processCommentExternalAdd(i)}else if(t==="timeline_comment_update"){this.processCommentExternalUpdate(i)}else if(t==="timeline_comment_delete"){this.processCommentExternalDelete(i)}else if(t==="timeline_changed_binding"){this.processChangeBinding(i)}else if(t==="timeline_item_update"){this.processItemExternalUpdate(i)}else if(t==="timeline_wait_add"){this.processWaitExternalAdd(i)}else if(t==="timeline_wait_update"){this.processWaitExternalUpdate(i)}else if(t==="timeline_wait_delete"){this.processWaitExternalDelete(i)}else if(t==="timeline_bizproc_status"){this.processBizprocStatus(i)}else if(t==="timeline_scoring_add"){this.processScoringExternalAdd(i)}}},{key:"processChatCreate",value:function e(t){if(this._chat){this._chat.setData(BX.prop.getObject(t,"CHAT_DATA",{}));this._chat.refreshLayout()}}},{key:"processActivityExternalAdd",value:function e(t){let i,s,n,a,r;i=BX.prop.getObject(t,"ENTITY",null);s=BX.prop.getObject(t,"SCHEDULE_ITEM",null);n=BX.prop.getObject(t,"HISTORY_ITEM",null);if(i&&n&&!BX.type.isPlainObject(n["ASSOCIATED_ENTITY"])){n["ASSOCIATED_ENTITY"]=i}if(s!==null&&this._schedule.getItemByData(s)===null){a=this.addScheduleItem(s);a.addWrapperClass("crm-entity-stream-section-updated",1e3)}if(n!==null){r=this._history.findItemById(BX.prop.getString(n,"ID"));if(!r){r=this.addHistoryItem(n);Expand.create(r.getWrapper(),null).run()}}}},{key:"processActivityExternalUpdate",value:function e(t){let i,s,n,a,r,o;i=BX.prop.getObject(t,"ENTITY",null);s=BX.prop.getObject(t,"SCHEDULE_ITEM",null);a=BX.prop.getObject(t,"HISTORY_ITEM",null);if(i){if(a&&!BX.type.isPlainObject(a["ASSOCIATED_ENTITY"])){a["ASSOCIATED_ENTITY"]=i}const e=BX.prop.getInteger(i,"ID",0);const t=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.activity,e);for(let e=0,s=t.length;e<s;e++){r=t[e];r.setAssociatedEntityData(i);r.refreshLayout()}const s=this._fixedHistory.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.activity,e);for(let e=0,t=s.length;e<t;e++){o=s[e];o.setAssociatedEntityData(i);o.refreshLayout()}}if(s!==null){n=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.activity,BX.prop.getInteger(s,"ASSOCIATED_ENTITY_ID"));if(n){n.setData(s);if(!n.isDone()){this._schedule.refreshItem(n)}else{if(a){this._schedule.transferItemToHistory(n,a);a=null}else{this._schedule.deleteItem(n)}}}else if(!Scheduled.isDone(s)){n=this.addScheduleItem(s);n.addWrapperClass("crm-entity-stream-section-updated",1e3)}}if(a!==null){r=this._history.findItemById(BX.prop.getString(a,"ID"));if(!r){r=this.addHistoryItem(a);Expand.create(r.getWrapper(),null).run()}else{r.setData(a);r.refreshLayout();o=this._fixedHistory.findItemById(BX.prop.getString(a,"ID"));if(o){o.setData(a);o.refreshLayout()}}}}},{key:"processActivityExternalDelete",value:function e(t){const i=BX.prop.getInteger(t,"ENTITY_ID",0);const s=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.activity,i);for(let e=0,t=s.length;e<t;e++){this._history.deleteItem(s[e])}const n=this._fixedHistory.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.activity,i);for(let e=0,t=n.length;e<t;e++){this._fixedHistory.deleteItem(n[e])}const a=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.activity,i);if(a){this._schedule.deleteItem(a)}}},{key:"processCommentExternalAdd",value:function e(t){let i,s;i=BX.prop.getObject(t,"HISTORY_ITEM",null);if(i!==null){window.setTimeout(BX.delegate((function(){if(!this._history.findItemById(i["ID"])){s=this.addHistoryItem(i);Expand.create(s.getWrapper(),null).run()}}),this),1500)}}},{key:"processCommentExternalUpdate",value:function e(t){const i=BX.prop.getInteger(t,"ENTITY_ID",0);const s=BX.prop.getObject(t,"HISTORY_ITEM",null);const n=this._history.findItemById(i);if(n instanceof Comment&&s!==null){n.setData(s);n.switchToViewMode()}const a=this._fixedHistory.findItemById(i);if(a instanceof Comment&&s!==null){a.setData(s);a.switchToViewMode()}}},{key:"processCommentExternalDelete",value:function e(t){const i=BX.prop.getInteger(t,"ENTITY_ID",0);window.setTimeout(BX.delegate((function(){const e=this._history.findItemById(i);if(e instanceof Comment){this._history.deleteItem(e)}const t=this._fixedHistory.findItemById(i);if(t instanceof Comment){this._fixedHistory.deleteItem(t)}}),this),1200)}},{key:"processChangeBinding",value:function e(t){const i=BX.prop.getString(t,"OLD_ID",0);const s=BX.prop.getString(t,"NEW_ID",0);const n=this._history.findItemById(i);if(n instanceof crm_timeline_item.Item){n._id=s;const e=n.getData();e.ID=s;n.setData(e)}const a=this._fixedHistory.findItemById(i);if(a instanceof crm_timeline_item.Item){a._id=s;const e=a.getData();e.ID=s;a.setData(e)}}},{key:"processItemExternalUpdate",value:function e(t){const i=BX.prop.getInteger(t,"ENTITY_ID",0);const s=BX.prop.getObject(t,"HISTORY_ITEM",null);const n=this._history.findItemById(i);if(n&&s!==null){n.setData(s);n.markAsTerminated(this._history.checkItemForTermination(n));n.refreshLayout();if(n.isTerminated()){BX.addClass(n._wrapper,"crm-entity-stream-section-last")}}}},{key:"processWaitExternalAdd",value:function e(t){const i=BX.prop.getObject(t,"SCHEDULE_ITEM",null);if(i!==null){this.addScheduleItem(i)}}},{key:"processWaitExternalUpdate",value:function e(t){let i,s,n,a,r;i=BX.prop.getObject(t,"ENTITY",null);s=BX.prop.getObject(t,"SCHEDULE_ITEM",null);a=BX.prop.getObject(t,"HISTORY_ITEM",null);if(i){if(a&&!BX.type.isPlainObject(a["ASSOCIATED_ENTITY"])){a["ASSOCIATED_ENTITY"]=i}const e=BX.prop.getInteger(i,"ID",0);const t=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.wait,e);let s=0;const n=t.length;for(;s<n;s++){r=t[s];r.setAssociatedEntityData(i);r.refreshLayout()}}if(s!==null){n=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.wait,BX.prop.getInteger(s,"ASSOCIATED_ENTITY_ID"));if(!n){this.addScheduleItem(s)}else{n.setData(s);if(!n.isDone()){this._schedule.refreshItem(n)}else{if(a){this._schedule.transferItemToHistory(n,a);a=null}else{this._schedule.deleteItem(n)}}}}if(a!==null){r=this._history.findItemById(BX.prop.getString(a,"ID"));if(!r){r=this.addHistoryItem(a);Expand.create(r.getWrapper(),null).run()}else{r.setData(a);r.refreshLayout()}}}},{key:"processWaitExternalDelete",value:function e(t){const i=BX.prop.getInteger(t,"ENTITY_ID",0);const s=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.wait,i);let n=0;const a=s.length;for(;n<a;n++){this._history.deleteItem(s[n])}const r=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.wait,i);if(r){this._schedule.deleteItem(r)}}},{key:"processBizprocStatus",value:function e(t){let i,s;i=BX.prop.getObject(t,"HISTORY_ITEM",null);if(i!==null){s=this.addHistoryItem(i);Expand.create(s.getWrapper(),null).run()}}},{key:"processScoringExternalAdd",value:function e(t){let i,s;i=BX.prop.getObject(t,"HISTORY_ITEM",null);if(i!==null){s=this.addHistoryItem(i);Expand.create(s.getWrapper(),null).run()}}},{key:"onEntityProgressChange",value:function e(t,i){if(BX.prop.getInteger(i,"entityTypeId",0)!==this._ownerTypeId||BX.prop.getInteger(i,"entityId",0)!==this._ownerId){return}const s=BX.prop.getString(i,"semantics","");if(s===this._progressSemantics){return}this._progressSemantics=s;this._schedule.refreshLayout()}},{key:"getId",value:function e(){return this._id}},{key:"getSetting",value:function e(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i}},{key:"getOwnerTypeId",value:function e(){return this._ownerTypeId}},{key:"getOwnerId",value:function e(){return this._ownerId}},{key:"getOwnerInfo",value:function e(){return this._ownerInfo}},{key:"isStubCounterEnabled",value:function e(){if(this.getSetting("enableTodo",false)){return false}if(this._ownerId<=0){return false}return(this._ownerTypeId===BX.CrmEntityType.enumeration.deal||this._ownerTypeId===BX.CrmEntityType.enumeration.lead)&&this._progressSemantics==="process"}},{key:"getSchedule",value:function e(){return this._schedule}},{key:"getHistory",value:function e(){return this._history}},{key:"getFixedHistory",value:function e(){return this._fixedHistory}},{key:"getWaitEditor",value:function e(){return this._waitEditor}},{key:"getSmsEditor",value:function e(){return this._smsEditor}},{key:"getTodoEditor",value:function e(){return this._todoEditor}},{key:"getMenuBar",value:function e(){return this._menuBar}},{key:"processSheduleLayoutChange",value:function e(){}},{key:"processHistoryLayoutChange",value:function e(){this._schedule.refreshLayout()}},{key:"switchToDefaultEditor",value:function e(t){let i=Array.from(this._menuBar.getMenuItems()).reduce(((e,t)=>{if(e){return e}const i=t.dataset.id;if(["comment","wait","sms","zoom","todo"].indexOf(i)>=0){return i}return null}),null);const s={comment:this._commentEditor,wait:this._waitEditor,sms:this._smsEditor,zoom:this._zoomEditor,todo:this._todoEditor};let n;if(s.hasOwnProperty(i)&&s[i]&&s[i].setVisible){n=s[i]}else if(this._todoEditor){n=this._todoEditor;i="todo"}else{n=this._commentEditor;i="comment"}if(t!==n&&t.setVisible){t.setVisible(false)}n.setVisible(true);this._menuBar.setActiveItemById(i)}},{key:"processEditingCompletion",value:function e(t){this.switchToDefaultEditor(t)}},{key:"processEditingCancellation",value:function e(t){this.switchToDefaultEditor(t)}},{key:"addScheduleItem",value:function e(t){const i=this._schedule.createItem(t);const s=this._schedule.calculateItemIndex(i);const n=this._schedule.createAnchor(s);this._schedule.addItem(i,s);i.layout({anchor:n});return i}},{key:"addHistoryItem",value:function e(t){const i=this._history.createItem(t);const s=this._history.calculateItemIndex(i);const n=this._history.createAnchor(s);this._history.addItem(i,s);i.layout({anchor:n});return i}},{key:"renderAudioDummy",value:function e(t,i){return BX.create("DIV",{attrs:{className:"crm-audio-cap-wrap-container"},children:[BX.create("DIV",{attrs:{className:"crm-audio-cap-wrap"},children:[BX.create("DIV",{attrs:{className:"crm-audio-cap-time"},text:t})],events:{click:i}})]})}},{key:"loadMediaPlayer",value:function e(t,i,s,n,a,r){if(!a){a=0}if(!r){r={}}const o=new BX.Fileman.Player(t,{sources:[{src:i,type:s}],isAudio:!r.video,skin:r.hasOwnProperty("skin")?r.skin:"vjs-timeline_player-skin",width:r.width||350,height:r.height||30,duration:a,playbackRate:r.playbackRate||null,onInit:function(e){e.vjsPlayer.controlBar.removeChild("timeDivider");e.vjsPlayer.controlBar.removeChild("durationDisplay");e.vjsPlayer.controlBar.removeChild("fullscreenToggle");e.vjsPlayer.controlBar.addChild("timeDivider");e.vjsPlayer.controlBar.addChild("durationDisplay");if(!e.isPlaying()){e.play()}}});BX.cleanNode(n,false);n.appendChild(o.createElement());o.init();if(r.playbackRate>1){o.vjsPlayer.playbackRate(r.playbackRate)}return o}},{key:"onActivityCreated",value:function e(t,i){}},{key:"isSpotlightShowed",value:function e(){return this._spotlightFastenShowed}},{key:"setSpotlightShowed",value:function e(){this._spotlightFastenShowed=true}},{key:"getCurrentUser",value:function e(){return this._currentUser}},{key:"getAudioPlaybackRateSelector",value:function e(){if(!this.audioPlaybackRateSelector){this.audioPlaybackRateSelector=new AudioPlaybackRateSelector({name:"timeline_audio_playback",currentRate:this._audioPlaybackRate,availableRates:[{rate:1,html:BX.Loc.getMessage("CRM_TIMELINE_PLAYBACK_RATE_SELECTOR_RATE_1").replace("#RATE#",'<span class="crm-audio-cap-speed-param">1x</span>')},{rate:1.5,html:BX.Loc.getMessage("CRM_TIMELINE_PLAYBACK_RATE_SELECTOR_RATE_1.5").replace("#RATE#",'<span class="crm-audio-cap-speed-param">1.5x</span>')},{rate:2,html:BX.Loc.getMessage("CRM_TIMELINE_PLAYBACK_RATE_SELECTOR_RATE_2").replace("#RATE#",'<span class="crm-audio-cap-speed-param">2x</span>')},{rate:3,html:BX.Loc.getMessage("CRM_TIMELINE_PLAYBACK_RATE_SELECTOR_RATE_3").replace("#RATE#",'<span class="crm-audio-cap-speed-param">3x</span>')}],textMessageCode:"CRM_TIMELINE_PLAYBACK_RATE_SELECTOR_TEXT"})}return this.audioPlaybackRateSelector}},{key:"hasScheduledItems",value:function e(){return this._schedule.getItems().length>0}}],[{key:"create",value:function t(i,s){const n=new e;n.initialize(i,s);e.instances[n.getId()]=n;return n}},{key:"getDefault",value:function t(){return _classStaticPrivateFieldSpecGet(e,e,_defaultInstance)}},{key:"setDefault",value:function t(i){_classStaticPrivateFieldSpecSet(e,e,_defaultInstance,i)}},{key:"getById",value:function t(i){return e.instances[i]||null}}]);return e}();var _defaultInstance={writable:true,value:null};babelHelpers.defineProperty(Manager,"instances",{});let SchedulePostpone=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._button=null;e._clickHandler=BX.delegate(e.onClick,babelHelpers.assertThisInitialized(e));e._isMenuShown=false;e._menu=false;return e}babelHelpers.createClass(t,[{key:"doLayout",value:function e(){this._button=BX.create("DIV",{attrs:{className:this._isEnabled?"crm-entity-stream-planned-action-aside":"crm-entity-stream-planned-action-aside-disabled"},text:this.getMessage("postpone")});if(this._isEnabled){BX.bind(this._button,"click",this._clickHandler)}this._container.appendChild(this._button)}},{key:"openMenu",value:function e(){if(this._isMenuShown){return}const t=BX.delegate(this.onMenuItemClick,this);const i=[{id:"hour_1",text:this.getMessage("forOneHour"),onclick:t},{id:"hour_2",text:this.getMessage("forTwoHours"),onclick:t},{id:"hour_3",text:this.getMessage("forThreeHours"),onclick:t},{id:"day_1",text:this.getMessage("forOneDay"),onclick:t},{id:"day_2",text:this.getMessage("forTwoDays"),onclick:t},{id:"day_3",text:this.getMessage("forThreeDays"),onclick:t}];BX.PopupMenu.show(this._id,this._button,i,{offsetTop:0,offsetLeft:16,events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this),onPopupDestroy:BX.delegate(this.onMenuDestroy,this)}});this._menu=BX.PopupMenu.currentItem}},{key:"closeMenu",value:function e(){if(!this._isMenuShown){return}if(this._menu){this._menu.close()}}},{key:"onClick",value:function e(){if(!this._isEnabled){return}if(this._isMenuShown){this.closeMenu()}else{this.openMenu()}}},{key:"onMenuItemClick",value:function e(t,i){this.closeMenu();let s=0;if(i.id==="hour_1"){s=3600}else if(i.id==="hour_2"){s=7200}else if(i.id==="hour_3"){s=10800}else if(i.id==="day_1"){s=86400}else if(i.id==="day_2"){s=172800}else if(i.id==="day_3"){s=259200}if(s>0&&this._item){this._item.postpone(s)}}},{key:"onMenuShow",value:function e(){this._isMenuShown=true}},{key:"onMenuClose",value:function e(){if(this._menu&&this._menu.popupWindow){this._menu.popupWindow.destroy()}}},{key:"onMenuDestroy",value:function e(){this._isMenuShown=false;this._menu=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity);babelHelpers.defineProperty(SchedulePostpone,"messages",{});let Comment$2=function(){function e(){babelHelpers.classCallCheck(this,e);this._node=null;this._anchor=null;this._nodeParent=null;this._startPosition=null;this._events=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i,s,n){this._node=t;this._anchor=i;this._nodeParent=t.parentNode;this._startPosition=s;this._events=BX.type.isPlainObject(n)?n:{}}},{key:"run",value:function e(){BX.addClass(this._node,"crm-entity-stream-section-animate-start");this._node.style.position="absolute";this._node.style.width=this._startPosition.width+"px";this._node.style.height=this._startPosition.height+"px";this._node.style.top=this._startPosition.top-30+"px";this._node.style.left=this._startPosition.left+"px";this._node.style.opacity=0;this._node.style.zIndex=960;document.body.appendChild(this._node);const t=new BX.easing({duration:350,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(e){this._node.style.opacity=e.opacity/100}),this),complete:BX.proxy((function(){if(BX.type.isFunction(this._events["start"])){this._events["start"]()}const e=Shift.create(this._node,this._anchor,this._startPosition,false,{complete:BX.delegate(this.finish,this)});e.run()}),this)});t.animate();if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}}},{key:"finish",value:function e(){this._node.style.position="";this._node.style.width="";this._node.style.height="";this._node.style.top="";this._node.style.left="";this._node.style.opacity="";this._node.style.zIndex="";this._anchor.style.height="";this._anchor.parentNode.insertBefore(this._node,this._anchor.nextSibling);setTimeout(BX.delegate((function(){BX.removeClass(this._node,"crm-entity-stream-section-animate-start");BX.remove(this._anchor)}),this),0)}}],[{key:"create",value:function t(i,s,n,a){const r=new e;r.initialize(i,s,n,a);return r}}]);return e}();const Streams={History:History$1,FixedHistory:FixedHistory,EntityChat:EntityChat,Schedule:Schedule};const Editors={Comment:Comment,Wait:Wait,Rest:Rest,Sms:Sms};const Tools={WaitConfigurationDialog:WaitConfigurationDialog,SchedulePostponeController:SchedulePostponeController,MenuBar:MenuBar,AudioPlaybackRateSelector:AudioPlaybackRateSelector};const Actions={Activity:Activity,Call:Call$1,HistoryCall:HistoryCall,ScheduleCall:ScheduleCall,Email:Email,HistoryEmail:HistoryEmail,ScheduleEmail:ScheduleEmail,OpenLine:OpenLine,SchedulePostpone:SchedulePostpone};const ScheduledItems={Activity:Activity$1,Email:Email$1,Call:Call,CallTracker:CallTracker,Meeting:Meeting,Task:Task,WebForm:WebForm,Wait:Wait$1,Request:Request,Rest:Rest$1,OpenLine:OpenLine$1,Zoom:Zoom};const Items={History:History,HistoryActivity:HistoryActivity,Comment:Comment$1,Modification:Modification,Mark:Mark$1,Creation:Creation,Restoration:Restoration,Relation:Relation,Link:Link,Unlink:Unlink,Email:Email$2,Call:Call$2,Meeting:Meeting$1,Task:Task$1,WebForm:WebForm$1,Wait:Wait$2,Document:Document,Sender:Sender,Bizproc:Bizproc,Request:Request$1,Rest:Rest$2,OpenLine:OpenLine$2,Zoom:Zoom$1,Conversion:Conversion,Visit:Visit,Scoring:Scoring,ExternalNoticeModification:ExternalNoticeModification,ExternalNoticeStatusModification:ExternalNoticeStatusModification,ScheduledBase:Scheduled,Scheduled:ScheduledItems};const Animations={Item:Item$1,ItemNew:ItemNew,Expand:Expand,Shift:Shift,Comment:Comment$2,Fasten:Fasten};exports.Manager=Manager;exports.Stream=Steam;exports.Streams=Streams;exports.Editor=Editor;exports.Editors=Editors;exports.Tools=Tools;exports.Types=types;exports.Action=Action;exports.Actions=Actions;exports.Items=Items;exports.Animations=Animations;exports.CompatibleItem=CompatibleItem})(this.BX.Crm.Timeline=this.BX.Crm.Timeline||{},BX.Crm.Activity,BX.Event,BX.Crm.DateTime,BX.Crm.Timeline,BX.Crm.Timeline,BX);
//# sourceMappingURL=timeline.bundle.map.js