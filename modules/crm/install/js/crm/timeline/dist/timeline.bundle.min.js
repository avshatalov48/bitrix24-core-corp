this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(exports,rest_client,ui_analytics,main_date,ui_buttons,ui_vue3,main_loader,crm_field_colorSelector,ui_vue3_directives_hint,main_popup,ui_label,ui_hint,ui_cnt,ui_notification,crm_timeline_item,main_core,crm_timeline_tools,main_core_events){"use strict";let _=e=>e,_t;function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t);t.add(e)}function _classPrivateFieldInitSpec(e,t,i){_checkPrivateRedeclaration(e,t);t.set(e,i)}function _checkPrivateRedeclaration(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var _overlay=new WeakMap;var _startHeight=new WeakMap;var _node=new WeakMap;var _callback=new WeakMap;var _isNodeVisible=new WeakSet;let Expand=function(){function e(){babelHelpers.classCallCheck(this,e);_classPrivateMethodInitSpec(this,_isNodeVisible);_classPrivateFieldInitSpec(this,_overlay,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_startHeight,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_node,{writable:true,value:void 0});_classPrivateFieldInitSpec(this,_callback,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,_node,null);babelHelpers.classPrivateFieldSet(this,_callback,null);babelHelpers.classPrivateFieldSet(this,_overlay,null);babelHelpers.classPrivateFieldSet(this,_startHeight,0)}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i,s){babelHelpers.classPrivateFieldSet(this,_node,t);babelHelpers.classPrivateFieldSet(this,_callback,BX.type.isFunction(i)?i:null);babelHelpers.classPrivateFieldSet(this,_startHeight,(s===null||s===void 0?void 0:s.startHeight)||0)}},{key:"run",value:function e(){if(_classPrivateMethodGet(this,_isNodeVisible,_isNodeVisible2).call(this,babelHelpers.classPrivateFieldGet(this,_node))===false){if(babelHelpers.classPrivateFieldGet(this,_callback)){babelHelpers.classPrivateFieldGet(this,_callback).call(this)}return}requestAnimationFrame((()=>{const e=main_core.Dom.getPosition(babelHelpers.classPrivateFieldGet(this,_node));const t=getComputedStyle(babelHelpers.classPrivateFieldGet(this,_node));const i=parseInt(t.getPropertyValue("padding-top"),10);const s=parseInt(t.getPropertyValue("padding-bottom"),10);const n=parseInt(t.getPropertyValue("margin-bottom"),10);const a=babelHelpers.classPrivateFieldGet(this,_startHeight);main_core.Dom.style(babelHelpers.classPrivateFieldGet(this,_node),{height:`${a}px`,overflowY:"clip",position:"relative",padding:0,marginBottom:0});requestAnimationFrame((()=>{main_core.Dom.style(babelHelpers.classPrivateFieldGet(this,_node),"transition","transition: height 220ms ease, opacity 220ms ease, background-color 220ms ease");babelHelpers.classPrivateFieldSet(this,_overlay,main_core.Tag.render(_t||(_t=_`<div class="crm-timeline__card_overlay crm-timeline__card-scope"></div>`)));main_core.Dom.append(babelHelpers.classPrivateFieldGet(this,_overlay),babelHelpers.classPrivateFieldGet(this,_node));setTimeout((()=>{new BX.easing({duration:400,start:{height:a,overlayOpacity:0,paddingTop:0,paddingBottom:0,marginBottom:0},finish:{height:e.height,overlayOpacity:50,paddingTop:i,paddingBottom:s,marginBottom:n},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:this.onNodeHeightStep.bind(this),complete:this.onNodeHeightComplete.bind(this)}).animate()}),200)}))}))}},{key:"onNodeHeightStep",value:function e(t){main_core.Dom.style(babelHelpers.classPrivateFieldGet(this,_overlay),"opacity",1-t.overlayOpacity/100);main_core.Dom.style(babelHelpers.classPrivateFieldGet(this,_node),{height:`${t.height}px`,paddingTop:`${t.paddingTop}px`,paddingBottom:`${t.paddingBottom}px`,marginBottom:`${t.marginBottom}px`})}},{key:"onNodeHeightComplete",value:function e(){setTimeout((()=>{main_core.bindOnce(babelHelpers.classPrivateFieldGet(this,_overlay),"transitionend",(()=>{main_core.Dom.remove(babelHelpers.classPrivateFieldGet(this,_overlay));babelHelpers.classPrivateFieldSet(this,_overlay,null);const e=main_core.Dom.style(babelHelpers.classPrivateFieldGet(this,_node),"--crm-timeline__card-color-background");main_core.Dom.style(babelHelpers.classPrivateFieldGet(this,_node),null);if(main_core.Type.isStringFilled(e)){main_core.Dom.style(babelHelpers.classPrivateFieldGet(this,_node),"--crm-timeline__card-color-background",e)}}));main_core.Dom.style(babelHelpers.classPrivateFieldGet(this,_overlay),"opacity",0);if(babelHelpers.classPrivateFieldGet(this,_callback)){babelHelpers.classPrivateFieldGet(this,_callback).call(this)}}),400)}}],[{key:"create",value:function t(i,s,n){const a=new e;a.initialize(i,s,n);return a}}]);return e}();function _isNodeVisible2(e){const t=main_core.Dom.getPosition(babelHelpers.classPrivateFieldGet(this,_node));return t.width!==0&&t.height!==0}const Item={undefined:0,activity:1,creation:2,modification:3,link:4,unlink:5,mark:6,comment:7,wait:8,bizproc:9,conversion:10,sender:11,document:12,restoration:13,order:14,orderCheck:15,scoring:16,externalNotification:17,finalSummary:18,delivery:19,finalSummaryDocuments:20,storeDocument:21,productCompilation:22,signDocument:23};const Mark={undefined:0,waiting:1,success:2,renew:3,ignored:4,failed:5};const Order={encourageBuyProducts:100};const EditorMode={view:1,edit:2};var types=Object.freeze({Item:Item,Mark:Mark,Order:Order,EditorMode:EditorMode});let CompatibleItem=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._id="";e._settings={};e._data={};e._container=null;e._typeCategoryId=null;e._associatedEntityData=null;e._associatedEntityTypeId=null;e._associatedEntityId=null;e._isContextMenuShown=false;e._contextMenuButton=null;e._activityEditor=null;e._actions=[];e._actionContainer=null;e._existedStreamItemDeadLine=null;return e}babelHelpers.createClass(t,[{key:"initialize",value:function e(t,i){this._setId(t);this._settings=i?i:{};this._container=this.getSetting("container");if(!BX.type.isPlainObject(i["data"])){throw"Item. A required parameter 'data' is missing."}this._data=i["data"];this._activityEditor=this.getSetting("activityEditor");this.doInitialize()}},{key:"doInitialize",value:function e(){}},{key:"getId",value:function e(){return this._id}},{key:"getSetting",value:function e(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i}},{key:"getData",value:function e(){return this._data}},{key:"setData",value:function e(t){if(BX.type.isPlainObject(t)){this._data=t;this.clearCachedData()}}},{key:"getSort",value:function e(){var t;return(t=this._data["sort"])!==null&&t!==void 0?t:[]}},{key:"getAssociatedEntityData",value:function e(){if(this._associatedEntityData===null){this._associatedEntityData=BX.type.isPlainObject(this._data["ASSOCIATED_ENTITY"])?this._data["ASSOCIATED_ENTITY"]:{}}return this._associatedEntityData}},{key:"getAssociatedEntityTypeId",value:function e(){if(this._associatedEntityTypeId===null){this._associatedEntityTypeId=BX.prop.getInteger(this._data,"ASSOCIATED_ENTITY_TYPE_ID",0)}return this._associatedEntityTypeId}},{key:"getAssociatedEntityId",value:function e(){if(this._associatedEntityId===null){this._associatedEntityId=BX.prop.getInteger(this._data,"ASSOCIATED_ENTITY_ID",0)}return this._associatedEntityId}},{key:"setAssociatedEntityData",value:function e(t){if(!BX.type.isPlainObject(t)){t={}}const i=this._data;i.ASSOCIATED_ENTITY=t;this.setData(i)}},{key:"hasPermissions",value:function e(){const t=this.getAssociatedEntityData();return BX.type.isPlainObject(t["PERMISSIONS"])}},{key:"getPermissions",value:function e(){return BX.prop.getObject(this.getAssociatedEntityData(),"PERMISSIONS",{})}},{key:"setPermissions",value:function e(t){const i=this._data;if(!main_core.Type.isPlainObject(i.ASSOCIATED_ENTITY)){i.ASSOCIATED_ENTITY={}}i.ASSOCIATED_ENTITY.PERMISSIONS=t;this.setData(i)}},{key:"getTextDataParam",value:function e(t){return BX.prop.getString(this._data,t,"")}},{key:"getObjectDataParam",value:function e(t){return BX.prop.getObject(this._data,t,{})}},{key:"getArrayDataParam",value:function e(t){return BX.prop.getArray(this._data,t,[])}},{key:"getTypeId",value:function e(){return Item.undefined}},{key:"getTypeCategoryId",value:function e(){if(this._typeCategoryId===null){this._typeCategoryId=BX.prop.getInteger(this._data,"TYPE_CATEGORY_ID",0)}return this._typeCategoryId}},{key:"getContainer",value:function e(){return this._container}},{key:"setContainer",value:function e(t){this._container=BX.type.isElementNode(t)?t:null}},{key:"layout",value:function e(t){if(!BX.type.isElementNode(this._container)){throw"Item. Container is not assigned."}this.prepareLayout(t);this.prepareActions();const i=this._actions.length;for(let e=0;e<i;e++){this._actions[e].layout()}this.showActions(i>0)}},{key:"prepareLayout",value:function e(t){}},{key:"prepareActions",value:function e(){}},{key:"showActions",value:function e(t){}},{key:"clearCachedData",value:function e(){this._typeCategoryId=null;this._associatedEntityData=null;this._associatedEntityTypeId=null;this._associatedEntityId=null}},{key:"isDone",value:function e(){return false}},{key:"markAsDone",value:function e(t){}},{key:"view",value:function e(){}},{key:"edit",value:function e(){}},{key:"fasten",value:function e(){}},{key:"unfasten",value:function e(){}},{key:"remove",value:function e(){}},{key:"cutOffText",value:function e(t,i){if(!BX.type.isNumber(i)){i=0}if(i<=0||t.length<=i){return t}let s=i-1;const n=t.substring(s).search(/\s/i);if(n>0){s+=n}return t.substring(0,s)}},{key:"prepareMultilineCutOffElements",value:function e(t,i,s){if(!BX.type.isNumber(i)){i=0}if(i<=0||t.length<=i){return[BX.util.htmlspecialchars(t).replace(/(?:\r\n|\r|\n)/g,"<br>")]}let n=i-1;const a=t.substring(n).search(/\s/i);if(a>0){n+=a}return[BX.util.htmlspecialchars(t.substring(0,n)).replace(/(?:\r\n|\r|\n)/g,"<br>")+"&hellip;&nbsp;",BX.create("A",{attrs:{className:"crm-entity-stream-content-letter-more",href:"#"},events:{click:s},text:this.getMessage("details")})]}},{key:"prepareCutOffElements",value:function e(t,i,s){if(!BX.type.isNumber(i)){i=0}if(i<=0||t.length<=i){return[BX.util.htmlspecialchars(t)]}let n=i-1;const a=t.substring(n).search(/\s/i);if(a>0){n+=a}return[BX.util.htmlspecialchars(t.substring(0,n))+"&hellip;&nbsp;",BX.create("A",{attrs:{className:"crm-entity-stream-content-letter-more",href:"#"},events:{click:s},text:this.getMessage("details")})]}},{key:"prepareAuthorLayout",value:function e(){const t=this.getObjectDataParam("AUTHOR",null);if(!t){return null}const i=BX.prop.getString(t,"SHOW_URL","");if(i===""){return null}const s=BX.create("A",{attrs:{className:"ui-icon ui-icon-common-user crm-entity-stream-content-detail-employee",href:i,target:"_blank",title:BX.prop.getString(t,"FORMATTED_NAME","")},children:[BX.create("i",{})]});const n=BX.prop.getString(t,"IMAGE_URL","");if(n!==""){s.children[0].style.backgroundImage="url('"+encodeURI(n)+"')";s.children[0].style.backgroundSize="21px"}return s}},{key:"onActivityCreate",value:function e(t,i){}},{key:"isContextMenuEnabled",value:function e(){return false}},{key:"prepareContextMenuButton",value:function e(){this._contextMenuButton=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-context-menu"},events:{click:BX.delegate(this.onContextMenuButtonClick,this)}});return this._contextMenuButton}},{key:"onContextMenuButtonClick",value:function e(t){if(!this._isContextMenuShown){this.openContextMenu()}else{this.closeContextMenu()}}},{key:"openContextMenu",value:function e(){const t=this.prepareContextMenuItems();if(typeof IntranetExtensions!=="undefined"){t.push(IntranetExtensions)}if(t.length===0){return}BX.PopupMenu.show(this._id,this._contextMenuButton,t,{offsetTop:0,offsetLeft:16,angle:{position:"top",offset:0},events:{onPopupShow:BX.delegate(this.onContextMenuShow,this),onPopupClose:BX.delegate(this.onContextMenuClose,this),onPopupDestroy:BX.delegate(this.onContextMenuDestroy,this)}});this._contextMenu=BX.PopupMenu.currentItem}},{key:"closeContextMenu",value:function e(){if(this._contextMenu){this._contextMenu.close()}}},{key:"prepareContextMenuItems",value:function e(){return[]}},{key:"onContextMenuShow",value:function e(){this._isContextMenuShown=true;BX.addClass(this._contextMenuButton,"active")}},{key:"onContextMenuClose",value:function e(){if(this._contextMenu){this._contextMenu.popupWindow.destroy()}}},{key:"onContextMenuDestroy",value:function e(){this._isContextMenuShown=false;BX.removeClass(this._contextMenuButton,"active");this._contextMenu=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"getUserTimezoneOffset",value:function e(){return main_date.Timezone.Offset.USER_TO_SERVER}}]);return t}(crm_timeline_item.Item);babelHelpers.defineProperty(CompatibleItem,"messages",{});let Fasten=function(){function e(){babelHelpers.classCallCheck(this,e);this._id="";this._settings={};this._initialItem=null;this._finalItem=null;this._events=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._initialItem=this.getSetting("initialItem");this._finalItem=this.getSetting("finalItem");this._anchor=this.getSetting("anchor");this._events=this.getSetting("events",{})}},{key:"getId",value:function e(){return this._id}},{key:"getSetting",value:function e(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i}},{key:"addFixedHistoryItem",value:function e(){const t=this._finalItem.getWrapper();BX.addClass(t,"crm-entity-stream-section-animate-start");if(this._anchor.parentNode&&t){this._anchor.parentNode.insertBefore(t,this._anchor.nextSibling)}setTimeout(BX.delegate((function(){BX.removeClass(t,"crm-entity-stream-section-animate-start")}),this),0)}},{key:"run",value:function e(){const t=this._initialItem.getWrapper();this._clone=t.cloneNode(true);BX.addClass(this._clone,"crm-entity-stream-section-animate-start crm-entity-stream-section-top-fixed");this._startPosition=BX.pos(t);this._clone.style.position="absolute";this._clone.style.width=this._startPosition.width+"px";let i=this._startPosition.height;const s=65;const n=18;if(i<n+s)i=n+s;this._clone.style.height=i+"px";this._clone.style.top=this._startPosition.top+"px";this._clone.style.left=this._startPosition.left+"px";this._clone.style.zIndex=960;document.body.appendChild(this._clone);setTimeout(BX.proxy((function(){BX.addClass(this._clone,"crm-entity-stream-section-casper")}),this),0);this._anchorPosition=BX.pos(this._anchor);const a={top:this._anchorPosition.top,height:i+15,opacity:1};const r=this._startPosition.top-this._anchorPosition.bottom;const o=2*(document.body.clientHeight+this._startPosition.height);if(r>o){a.top=this._startPosition.top-o;a.opacity=0}let l=Math.abs(a.top-this._startPosition.top)*2;l=l<1500?1500:l;const c=new BX.easing({duration:l,start:{top:this._startPosition.top,height:0,opacity:1},finish:a,transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(e){this._clone.style.top=e.top+"px";this._clone.style.opacity=e.opacity;this._anchor.style.height=e.height+"px"}),this),complete:BX.proxy((function(){this.finish()}),this)});c.animate()}},{key:"finish",value:function e(){this._anchor.style.height=0;this.addFixedHistoryItem();BX.remove(this._clone);if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}}}],[{key:"create",value:function t(i,s){const n=new e;n.initialize(i,s);return n}}]);return e}();let History=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._history=null;e._fixedHistory=null;e._typeId=null;e._createdTime=null;e._isFixed=false;e._headerClickHandler=BX.delegate(e.onHeaderClick,babelHelpers.assertThisInitialized(e));return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){this._history=this.getSetting("history");this._fixedHistory=this.getSetting("fixedHistory")}},{key:"getTypeId",value:function e(){if(this._typeId===null){this._typeId=BX.prop.getInteger(this._data,"TYPE_ID",Item.undefined)}return this._typeId}},{key:"getTitle",value:function e(){return""}},{key:"isContextMenuEnabled",value:function e(){return!this.isReadOnly()}},{key:"getCreatedTimestamp",value:function e(){return this.getTextDataParam("CREATED_SERVER")}},{key:"getCreatedTime",value:function e(){if(this._createdTime===null){const e=BX.parseDate(this.getCreatedTimestamp(),false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");this._createdTime=new crm_timeline_tools.DatetimeConverter(e).toUserTime().getValue()}return this._createdTime}},{key:"getCreatedDate",value:function e(){return BX.prop.extractDate(new Date(this.getCreatedTime().getTime()))}},{key:"getOwnerInfo",value:function e(){return this._history?this._history.getOwnerInfo():null}},{key:"getOwnerTypeId",value:function e(){return BX.prop.getInteger(this.getOwnerInfo(),"ENTITY_TYPE_ID",BX.CrmEntityType.enumeration.undefined)}},{key:"getOwnerId",value:function e(){return BX.prop.getInteger(this.getOwnerInfo(),"ENTITY_ID",0)}},{key:"isReadOnly",value:function e(){return this._history.isReadOnly()}},{key:"isEditable",value:function e(){return!this.isReadOnly()}},{key:"isDone",value:function e(){const t=this.getTypeId();if(t===Item.activity){const e=this.getAssociatedEntityData();return BX.CrmActivityStatus.isFinal(BX.prop.getInteger(e,"STATUS",0))}return false}},{key:"isFixed",value:function e(){return this._isFixed}},{key:"fasten",value:function e(t){if(this._fixedHistory._items.length>=3){if(!this.fastenLimitPopup){this.fastenLimitPopup=new BX.PopupWindow("timeline_fasten_limit_popup_"+this._id,this._switcher,{content:BX.message("CRM_TIMELINE_FASTEN_LIMIT_MESSAGE"),darkMode:true,autoHide:true,zIndex:990,angle:true,closeByEsc:true,bindOptions:{forceBindPosition:true}})}this.fastenLimitPopup.show();this.closeContextMenu();return}BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"CHANGE_FASTEN_ITEM",VALUE:"Y",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this._id}});this.closeContextMenu()}},{key:"onSuccessFasten",value:function e(t){if(t&&BX.type.isNotEmptyString(t.ERROR))return;if(!this.isFixed()){this._data.IS_FIXED="Y";const e=this._fixedHistory.createItem(this._data);e._isFixed=true;this._fixedHistory.addItem(e,0);e.layout({add:false});this.refreshLayout();const t=Fasten.create("",{initialItem:this,finalItem:e,anchor:this._fixedHistory._anchor});t.run()}this.closeContextMenu()}},{key:"unfasten",value:function e(t){BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"CHANGE_FASTEN_ITEM",VALUE:"N",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this._id}});this.closeContextMenu()}},{key:"onSuccessUnfasten",value:function e(t){if(t&&BX.type.isNotEmptyString(t.ERROR))return;let i;let s;if(this.isFixed()){i=this;s=this._history.findItemById(this._id)}else{i=this._fixedHistory.findItemById(this._id);s=this}if(i){const e=this._fixedHistory.getItemIndex(i);i.clearAnimate();this._fixedHistory.removeItemByIndex(e);if(s){s._data.IS_FIXED="N";s.refreshLayout();BX.LazyLoad.showImages()}}}},{key:"clearAnimate",value:function e(){if(!BX.type.isDomNode(this._wrapper))return;const t=BX.pos(this._wrapper);const i=new BX.easing({duration:1e3,start:{height:t.height,opacity:1,marginBottom:15},finish:{height:0,opacity:0,marginBottom:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(e){this._wrapper.style.height=e.height+"px";this._wrapper.style.opacity=e.opacity;this._wrapper.style.marginBottom=e.marginBottom}),this),complete:BX.proxy((function(){this.clearLayout()}),this)});i.animate()}},{key:"getWrapperClassName",value:function e(){return""}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}},{key:"prepareContentDetails",value:function e(){return[]}},{key:"prepareContent",value:function e(){let t=this.getWrapperClassName();if(t!==""){t="crm-entity-stream-section crm-entity-stream-section-history"+" "+t}else{t="crm-entity-stream-section crm-entity-stream-section-history"}const i=BX.create("DIV",{attrs:{className:t}});i.appendChild(BX.create("DIV",{attrs:{className:this.getIconClassName()}}));if(this.isContextMenuEnabled()){main_core.Dom.append(this.prepareContextMenuButton(),i)}const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})]});s.appendChild(n);s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:this.prepareContentDetails()}));const a=this.prepareAuthorLayout();if(a){s.appendChild(a)}return i}},{key:"prepareLayout",value:function e(t){this._wrapper=this.prepareContent();if(this._wrapper){const e=BX.type.isPlainObject(t)?BX.prop.getBoolean(t,"add",true):true;if(e){const e=BX.type.isPlainObject(t)&&BX.type.isElementNode(t["anchor"])?t["anchor"]:null;if(e&&e.nextSibling){this._container.insertBefore(this._wrapper,e.nextSibling)}else{this._container.appendChild(this._wrapper)}}this.markAsTerminated(this._history.checkItemForTermination(this))}}},{key:"onHeaderClick",value:function e(t){this.view();t.preventDefault?t.preventDefault():t.returnValue=false}},{key:"prepareTitleLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getTitle()})}},{key:"prepareFixedSwitcherLayout",value:function e(){const t=this.getTextDataParam("IS_FIXED")==="Y";this._switcher=BX.create("span",{attrs:{className:"crm-entity-stream-section-top-fixed-btn"},events:{click:t?BX.delegate(this.unfasten,this):BX.delegate(this.fasten,this)}});if(t)BX.addClass(this._switcher,"crm-entity-stream-section-top-fixed-btn-active");if(!this.isReadOnly()&&!t){const e=this._history.getManager();if(!e.isSpotlightShowed()){e.setSpotlightShowed();BX.addClass(this._switcher,"crm-entity-stream-section-top-fixed-btn-spotlight");const t=new BX.SpotLight({targetElement:this._switcher,targetVertex:"middle-center",lightMode:false,id:"CRM_TIMELINE_FASTEN_SWITCHER",zIndex:900,top:-3,left:-1,autoSave:true,content:BX.message("CRM_TIMELINE_SPOTLIGHT_FASTEN_MESSAGE")});t.show()}}return this._switcher}},{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());const i=this.getStatusNode();if(main_core.Type.isDomNode(i)){main_core.Dom.append(i,t)}t.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));return t}},{key:"getStatusNode",value:function e(){return null}},{key:"onActivityCreate",value:function e(t,i){this._history.getManager().onActivityCreated(t,i)}},{key:"formatTime",value:function e(t){if(this.isFixed()){return this._fixedHistory.formatTime(t)}return this._history.formatTime(t)}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}},{key:"isCounterEnabled",value:function e(t){if(!BX.type.isDate(t)){return false}let i=new Date;i.setHours(0);i.setMinutes(0);i.setSeconds(0);i.setMilliseconds(0);i=i.getTime();let s=new Date;s.setHours(23);s.setMinutes(59);s.setSeconds(59);s.setMilliseconds(999);s=s.getTime();const n=t.getTime();return n<i||n>=i&&n<=s}},{key:"isCounterEnabledByLightTime",value:function e(t){if(!BX.type.isDate(t)){return false}const i=(new Date).getTime();const s=t.getTime();return s<i}}]);return t}(CompatibleItem);let Scheduled=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._schedule=null;e._deadlineNode=null;e._headerClickHandler=BX.delegate(e.onHeaderClick,babelHelpers.assertThisInitialized(e));e._setAsDoneButtonHandler=BX.delegate(e.onSetAsDoneButtonClick,babelHelpers.assertThisInitialized(e));return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){this._schedule=this.getSetting("schedule");if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"Scheduled. The field 'activityEditor' is not assigned."}if(this.hasPermissions()&&!this.verifyPermissions()){this.loadPermissions()}}},{key:"getTypeId",value:function e(){return Item.undefined}},{key:"verifyPermissions",value:function e(){const t=BX.prop.getInteger(this.getPermissions(),"USER_ID",0);return t<=0||t===this._schedule.getUserId()}},{key:"loadPermissions",value:function e(){BX.ajax({url:this._schedule.getServiceUrl(),method:"POST",dataType:"json",data:{ACTION:"GET_PERMISSIONS",TYPE_ID:this.getTypeId(),ID:this.getAssociatedEntityId()},onsuccess:this.onPermissionsLoad.bind(this)})}},{key:"onPermissionsLoad",value:function e(t){const i=BX.prop.getObject(t,"PERMISSIONS",null);if(!i){return}this.setPermissions(i);window.setTimeout(function(){this.refreshLayout()}.bind(this),0)}},{key:"getDeadline",value:function e(){return null}},{key:"getLightTime",value:function e(){return null}},{key:"hasDeadline",value:function e(){return BX.type.isDate(this.getDeadline())}},{key:"isCounterEnabled",value:function e(){if(this.isDone()){return this._existedStreamItemDeadLine&&History.isCounterEnabledByLightTime(this._existedStreamItemDeadLine)}const t=this.getLightTime();return t&&History.isCounterEnabledByLightTime(t)}},{key:"isIncomingChannel",value:function e(){return false}},{key:"getSourceId",value:function e(){return BX.prop.getInteger(this.getAssociatedEntityData(),"ID",0)}},{key:"onSetAsDoneCompleted",value:function e(t){if(!BX.prop.getBoolean(t,"COMPLETED")){return}this.markAsDone(true);this._schedule.onItemMarkedAsDone(this,{historyItemData:BX.prop.getObject(t,"HISTORY_ITEM")})}},{key:"onPosponeCompleted",value:function e(t){}},{key:"refreshDeadline",value:function e(){this._deadlineNode.innerHTML=this.formatDateTime(this.getDeadline())}},{key:"formatDateTime",value:function e(t){return this._schedule.formatDateTime(t)}},{key:"getWrapperClassName",value:function e(){return""}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon"}},{key:"isReadOnly",value:function e(){return this._schedule.isReadOnly()}},{key:"isEditable",value:function e(){return!this.isReadOnly()}},{key:"canPostpone",value:function e(){if(this.isReadOnly()){return false}if(this.isIncomingChannel()){return false}const t=BX.prop.getObject(this.getAssociatedEntityData(),"PERMISSIONS",{});return BX.prop.getBoolean(t,"POSTPONE",false)}},{key:"isDone",value:function e(){return BX.CrmActivityStatus.isFinal(BX.prop.getInteger(this.getAssociatedEntityData(),"STATUS",0))}},{key:"canComplete",value:function e(){if(this.isReadOnly()){return false}const t=BX.prop.getObject(this.getAssociatedEntityData(),"PERMISSIONS",{});return BX.prop.getBoolean(t,"COMPLETE",false)}},{key:"setAsDone",value:function e(t){}},{key:"prepareContent",value:function e(t){return null}},{key:"prepareLayout",value:function e(t){this._wrapper=this.prepareContent();if(this._wrapper){const e=BX.type.isPlainObject(t)?BX.prop.getBoolean(t,"add",true):true;if(e){const e=BX.type.isPlainObject(t)&&BX.type.isElementNode(t["anchor"])?t["anchor"]:null;if(e&&e.nextSibling){this._container.insertBefore(this._wrapper,e.nextSibling)}else{this._container.appendChild(this._wrapper)}}this.markAsTerminated(this._schedule.checkItemForTermination(this))}}},{key:"onHeaderClick",value:function e(t){this.view();t.preventDefault?t.preventDefault():t.returnValue=false}},{key:"onSetAsDoneButtonClick",value:function e(t){if(this.canComplete()){this.setAsDone(!this.isDone())}}},{key:"onActivityCreate",value:function e(t,i){this._schedule.getManager().onActivityCreated(t,i)}}],[{key:"isDone",value:function e(t){const i=BX.prop.getObject(t,"ASSOCIATED_ENTITY",{});return BX.CrmActivityStatus.isFinal(BX.prop.getInteger(i,"STATUS",0))}},{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(CompatibleItem);let Item$1=function(){function e(){babelHelpers.classCallCheck(this,e);this._id="";this._settings={};this._initialItem=null;this._finalItem=null;this._events=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._initialItem=this.getSetting("initialItem");this._finalItem=this.getSetting("finalItem");this._anchor=this.getSetting("anchor");this._events=this.getSetting("events",{})}},{key:"getId",value:function e(){return this._id}},{key:"getSetting",value:function e(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i}},{key:"run",value:function e(){this._node=this._initialItem.getWrapper();const t=BX.pos(this._node);this._initialYPosition=t.top;this._initialXPosition=t.left;this._initialWidth=this._node.offsetWidth;this._initialHeight=this._node.offsetHeight;this._anchorYPosition=BX.pos(this._anchor).top;this.createStub();this.createGhost();this.moveGhost()}},{key:"createStub",value:function e(){this._stub=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-planned crm-entity-stream-section-shadow"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-section-content"},style:{height:this._initialHeight+"px"}})]});this._node.parentNode.insertBefore(this._stub,this._node)}},{key:"createGhost",value:function e(){this._ghostNode=this._node;this._ghostNode.style.position="absolute";this._ghostNode.style.width=this._initialWidth+"px";this._ghostNode.style.height=this._initialHeight+"px";this._ghostNode.style.top=this._initialYPosition+"px";this._ghostNode.style.left=this._initialXPosition+"px";document.body.appendChild(this._ghostNode);setTimeout(BX.proxy((function(){BX.addClass(this._ghostNode,"crm-entity-stream-section-casper")}),this),20)}},{key:"moveGhost",value:function e(){const t=this._ghostNode;const i=new BX.easing({duration:500,start:{top:this._initialYPosition},finish:{top:this._anchorYPosition},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(e){t.style.top=e.top+"px"}),this)});setTimeout(BX.proxy((function(){i.animate();t.style.boxShadow=""}),this),500);const s=new BX.easing({duration:500,start:{height:0},finish:{height:this._initialHeight+20},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(e){this._anchor.style.height=e.height+"px"}),this),complete:BX.proxy((function(){if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}this.addHistoryItem();this.removeGhost()}),this)});setTimeout((function(){s.animate()}),500)}},{key:"addHistoryItem",value:function e(){const t=this._finalItem.getWrapper();this._anchor.parentNode.insertBefore(t,this._anchor.nextSibling);this._finalItemHeight=this._anchor.offsetHeight-t.offsetHeight;this._anchor.style.height=0;t.style.marginBottom=this._finalItemHeight+"px"}},{key:"removeGhost",value:function e(){const t=this._ghostNode;const i=this._finalItem.getWrapper();t.style.overflow="hidden";const s=new BX.easing({duration:70,start:{opacity:100,height:t.offsetHeight,marginBottom:this._finalItemHeight},finish:{opacity:0,height:i.offsetHeight,marginBottom:20},step:BX.proxy((function(e){t.style.opacity=e.opacity/100;t.style.height=e.height+"px";i.style.marginBottom=e.marginBottom+"px"}),this),complete:BX.proxy((function(){t.remove();i.style.marginBottom="";this.collapseStub()}),this)});s.animate()}},{key:"collapseStub",value:function e(){const t=new BX.easing({duration:500,start:{opacity:100,height:this._initialHeight,marginBottom:15},finish:{opacity:0,height:0,marginBottom:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(e){this._stub.style.height=e.height+"px";this._stub.style.marginBottom=e.marginBottom+"px";this._stub.style.opacity=e.opacity/100}),this),complete:BX.proxy((function(){this.inited=false}),this)});t.animate()}}],[{key:"create",value:function t(i,s){const n=new e;n.initialize(i,s);return n}}]);return e}();let Shift=function(){function e(){babelHelpers.classCallCheck(this,e);this._node=null;this._anchor=null;this._nodeParent=null;this._startPosition=null;this._events=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i,s,n,a,r){this._node=t;this._shadowNode=n;this._anchor=i;this._nodeParent=t.parentNode;this._startPosition=s;this._events=BX.type.isPlainObject(a)?a:{};this.additionalShift=r!==null&&r!==void 0?r:0}},{key:"run",value:function e(){this._anchorPosition=BX.pos(this._anchor);setTimeout(BX.proxy((function(){BX.addClass(this._node,"crm-entity-stream-section-casper")}),this),0);const t=main_core.Dom.getPosition(this._node).height;const i=parseFloat(getComputedStyle(this._node).marginBottom);const s=parseFloat(getComputedStyle(this._node).marginTop);const n=t+i+s;const a=new BX.easing({duration:600,start:{height:0},finish:{height:n},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:e=>{this._anchor.style.height=e.height+"px"}});const r=new BX.easing({duration:1e3,start:{top:this._startPosition.top},finish:{top:this._anchorPosition.top-n+this.additionalShift},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(e){this._node.style.top=e.top+"px"}),this),complete:BX.proxy((function(){this.finish()}),this)});a.animate();r.animate()}},{key:"finish",value:function e(){if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}if(this._shadowNode!==false);}}],[{key:"create",value:function t(i,s,n,a,r,o){const l=new e;l.initialize(i,s,n,a,r,o);return l}}]);return e}();const StreamType={history:0,scheduled:1,pinned:2};let ButtonState=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(ButtonState,"DEFAULT","");babelHelpers.defineProperty(ButtonState,"LOADING","loading");babelHelpers.defineProperty(ButtonState,"DISABLED","disabled");babelHelpers.defineProperty(ButtonState,"HIDDEN","hidden");babelHelpers.defineProperty(ButtonState,"AI_LOADING","ai-loading");babelHelpers.defineProperty(ButtonState,"AI_SUCCESS","ai-success");function _classPrivateFieldInitSpec$1(e,t,i){_checkPrivateRedeclaration$1(e,t);t.set(e,i)}function _checkPrivateRedeclaration$1(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var _menuOptions=new WeakMap;var _vueComponent=new WeakMap;let Menu=function(){function e(t,i,s){babelHelpers.classCallCheck(this,e);_classPrivateFieldInitSpec$1(this,_menuOptions,{writable:true,value:{}});_classPrivateFieldInitSpec$1(this,_vueComponent,{writable:true,value:{}});babelHelpers.classPrivateFieldSet(this,_vueComponent,t);babelHelpers.classPrivateFieldSet(this,_menuOptions,s||{});babelHelpers.classPrivateFieldSet(this,_menuOptions,{angle:false,cacheable:false,...babelHelpers.classPrivateFieldGet(this,_menuOptions)});babelHelpers.classPrivateFieldGet(this,_menuOptions).items=[];for(const e of i){babelHelpers.classPrivateFieldGet(this,_menuOptions).items.push(this.createMenuItem(e))}}babelHelpers.createClass(e,[{key:"show",value:function e(){main_popup.MenuManager.show(babelHelpers.classPrivateFieldGet(this,_menuOptions))}},{key:"createMenuItem",value:function e(t){if(Object.prototype.hasOwnProperty.call(t,"delimiter")&&t.delimiter){return{text:t.title||"",delimiter:true}}const i={text:t.title,value:t.title};if(main_core.Type.isStringFilled(t.state)){switch(t.state){case ButtonState.AI_LOADING:i.className="menu-popup-item-add-to-tm menu-popup-item-disabled";break;case ButtonState.AI_SUCCESS:i.className="menu-popup-item-accept menu-popup-item-disabled";break;case ButtonState.DISABLED:i.className="menu-popup-no-icon menu-popup-item-disabled";break;default:i.className=""}}if(t.icon){i.className=`menu-popup-item-${t.icon}`}if(t.menu){i.items=[];for(const e of Object.values(t.menu.items||{})){i.items.push(this.createMenuItem(e))}}else if(t.action){if(t.action.type==="redirect"){i.href=t.action.value}else if(t.action.type==="jsCode"){i.onclick=t.action.value}else{i.onclick=()=>{void this.onMenuItemClick(t)}}}return i}},{key:"onMenuItemClick",value:function e(t){const i=main_popup.MenuManager.getCurrentMenu();if(i){i.close()}void new Action(t.action).execute(babelHelpers.classPrivateFieldGet(this,_vueComponent))}}],[{key:"showMenu",value:function t(i,s,n){const a=new e(i,s,n);a.show()}}]);return e}();function _classPrivateMethodInitSpec$1(e,t){_checkPrivateRedeclaration$2(e,t);t.add(e)}function _classPrivateFieldInitSpec$2(e,t,i){_checkPrivateRedeclaration$2(e,t);t.set(e,i)}function _checkPrivateRedeclaration$2(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$1(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}const AnimationTarget={block:"block",item:"item"};const AnimationType={disable:"disable",loader:"loader"};const ActionType={JS_EVENT:"jsEvent",AJAX_ACTION:{STARTED:"ajaxActionStarted",FINISHED:"ajaxActionFinished",FAILED:"ajaxActionFailed"},isJsEvent(e){return e===this.JS_EVENT},isAjaxAction(e){return e===this.AJAX_ACTION.STARTED||e===this.AJAX_ACTION.FINISHED||e===this.AJAX_ACTION.FAILED}};Object.freeze(ActionType.AJAX_ACTION);Object.freeze(ActionType);var _type=new WeakMap;var _value=new WeakMap;var _actionParams=new WeakMap;var _animation=new WeakMap;var _analytics=new WeakMap;var _prepareRunActionParams=new WeakSet;var _prepareCallBatchParams=new WeakSet;var _prepareMenuItems=new WeakSet;var _startAnimation=new WeakSet;var _stopAnimation=new WeakSet;var _isAnimationValid=new WeakSet;var _sendAnalytics=new WeakSet;let Action=function(){function Action(e){babelHelpers.classCallCheck(this,Action);_classPrivateMethodInitSpec$1(this,_sendAnalytics);_classPrivateMethodInitSpec$1(this,_isAnimationValid);_classPrivateMethodInitSpec$1(this,_stopAnimation);_classPrivateMethodInitSpec$1(this,_startAnimation);_classPrivateMethodInitSpec$1(this,_prepareMenuItems);_classPrivateMethodInitSpec$1(this,_prepareCallBatchParams);_classPrivateMethodInitSpec$1(this,_prepareRunActionParams);_classPrivateFieldInitSpec$2(this,_type,{writable:true,value:null});_classPrivateFieldInitSpec$2(this,_value,{writable:true,value:null});_classPrivateFieldInitSpec$2(this,_actionParams,{writable:true,value:null});_classPrivateFieldInitSpec$2(this,_animation,{writable:true,value:null});_classPrivateFieldInitSpec$2(this,_analytics,{writable:true,value:null});babelHelpers.classPrivateFieldSet(this,_type,e.type);babelHelpers.classPrivateFieldSet(this,_value,e.value);babelHelpers.classPrivateFieldSet(this,_actionParams,e.actionParams);babelHelpers.classPrivateFieldSet(this,_animation,main_core.Type.isPlainObject(e.animation)?e.animation:null);babelHelpers.classPrivateFieldSet(this,_analytics,main_core.Type.isPlainObject(e.analytics)?e.analytics:null)}babelHelpers.createClass(Action,[{key:"execute",value:function execute(vueComponent){return new Promise(((resolve,reject)=>{if(this.isJsEvent()){vueComponent.$Bitrix.eventEmitter.emit("crm:timeline:item:action",{action:babelHelpers.classPrivateFieldGet(this,_value),actionType:ActionType.JS_EVENT,actionData:babelHelpers.classPrivateFieldGet(this,_actionParams),animationCallbacks:{onStart:_classPrivateMethodGet$1(this,_startAnimation,_startAnimation2).bind(this,vueComponent),onStop:_classPrivateMethodGet$1(this,_stopAnimation,_stopAnimation2).bind(this,vueComponent)}});_classPrivateMethodGet$1(this,_sendAnalytics,_sendAnalytics2).call(this);resolve(true)}else if(this.isJsCode()){_classPrivateMethodGet$1(this,_startAnimation,_startAnimation2).call(this,vueComponent);eval(babelHelpers.classPrivateFieldGet(this,_value));_classPrivateMethodGet$1(this,_stopAnimation,_stopAnimation2).call(this,vueComponent);_classPrivateMethodGet$1(this,_sendAnalytics,_sendAnalytics2).call(this);resolve(true)}else if(this.isAjaxAction()){_classPrivateMethodGet$1(this,_startAnimation,_startAnimation2).call(this,vueComponent);vueComponent.$Bitrix.eventEmitter.emit("crm:timeline:item:action",{action:babelHelpers.classPrivateFieldGet(this,_value),actionType:ActionType.AJAX_ACTION.STARTED,actionData:babelHelpers.classPrivateFieldGet(this,_actionParams)});const e={data:_classPrivateMethodGet$1(this,_prepareRunActionParams,_prepareRunActionParams2).call(this,babelHelpers.classPrivateFieldGet(this,_actionParams))};if(babelHelpers.classPrivateFieldGet(this,_analytics)){e.analytics=babelHelpers.classPrivateFieldGet(this,_analytics)}main_core.ajax.runAction(babelHelpers.classPrivateFieldGet(this,_value),e).then((e=>{_classPrivateMethodGet$1(this,_stopAnimation,_stopAnimation2).call(this,vueComponent);vueComponent.$Bitrix.eventEmitter.emit("crm:timeline:item:action",{action:babelHelpers.classPrivateFieldGet(this,_value),actionType:ActionType.AJAX_ACTION.FINISHED,actionData:babelHelpers.classPrivateFieldGet(this,_actionParams),response:e});resolve(e)}),(e=>{_classPrivateMethodGet$1(this,_stopAnimation,_stopAnimation2).call(this,vueComponent,true);ui_notification.UI.Notification.Center.notify({content:e.errors[0].message,autoHideDelay:5e3});vueComponent.$Bitrix.eventEmitter.emit("crm:timeline:item:action",{action:babelHelpers.classPrivateFieldGet(this,_value),actionType:ActionType.AJAX_ACTION.FAILED,actionParams:babelHelpers.classPrivateFieldGet(this,_actionParams),response:e});reject(e)}))}else if(this.isCallRestBatch()){_classPrivateMethodGet$1(this,_startAnimation,_startAnimation2).call(this,vueComponent);vueComponent.$Bitrix.eventEmitter.emit("crm:timeline:item:action",{action:babelHelpers.classPrivateFieldGet(this,_value),actionType:"ajaxActionStarted",actionData:babelHelpers.classPrivateFieldGet(this,_actionParams)});rest_client.rest.callBatch(_classPrivateMethodGet$1(this,_prepareCallBatchParams,_prepareCallBatchParams2).call(this,babelHelpers.classPrivateFieldGet(this,_actionParams)),(e=>{for(const t in e){const i=e[t].answer;if(i.error){_classPrivateMethodGet$1(this,_stopAnimation,_stopAnimation2).call(this,vueComponent);ui_notification.UI.Notification.Center.notify({content:i.error.error_description,autoHideDelay:5e3});vueComponent.$Bitrix.eventEmitter.emit("crm:timeline:item:action",{action:babelHelpers.classPrivateFieldGet(this,_value),actionType:"ajaxActionFailed",actionParams:babelHelpers.classPrivateFieldGet(this,_actionParams)});reject(e);return}}_classPrivateMethodGet$1(this,_stopAnimation,_stopAnimation2).call(this,vueComponent);vueComponent.$Bitrix.eventEmitter.emit("crm:timeline:item:action",{action:babelHelpers.classPrivateFieldGet(this,_value),actionType:"ajaxActionFinished",actionData:babelHelpers.classPrivateFieldGet(this,_actionParams)});resolve(e)}),true)}else if(this.isRedirect()){_classPrivateMethodGet$1(this,_startAnimation,_startAnimation2).call(this,vueComponent);const e={href:babelHelpers.classPrivateFieldGet(this,_value)};if(babelHelpers.classPrivateFieldGet(this,_actionParams)&&babelHelpers.classPrivateFieldGet(this,_actionParams).target){e.target=babelHelpers.classPrivateFieldGet(this,_actionParams).target}const t=main_core.Dom.create("a",{attrs:e,text:"",style:{display:"none"}});main_core.Dom.append(t,document.body);t.click();setTimeout((()=>main_core.Dom.remove(t)),10);_classPrivateMethodGet$1(this,_sendAnalytics,_sendAnalytics2).call(this);resolve(babelHelpers.classPrivateFieldGet(this,_value))}else if(this.isShowMenu()){Menu.showMenu(vueComponent,_classPrivateMethodGet$1(this,_prepareMenuItems,_prepareMenuItems2).call(this,babelHelpers.classPrivateFieldGet(this,_value).items,vueComponent),{id:"actionMenu",bindElement:vueComponent.$el,minWidth:vueComponent.$el.offsetWidth});_classPrivateMethodGet$1(this,_sendAnalytics,_sendAnalytics2).call(this);resolve(true)}else if(this.isShowInfoHelper()){var _BX$UI$InfoHelper;(_BX$UI$InfoHelper=BX.UI.InfoHelper)===null||_BX$UI$InfoHelper===void 0?void 0:_BX$UI$InfoHelper.show(babelHelpers.classPrivateFieldGet(this,_value));_classPrivateMethodGet$1(this,_sendAnalytics,_sendAnalytics2).call(this);resolve(true)}else{reject(false)}}))}},{key:"isJsEvent",value:function e(){return babelHelpers.classPrivateFieldGet(this,_type)==="jsEvent"}},{key:"isJsCode",value:function e(){return babelHelpers.classPrivateFieldGet(this,_type)==="jsCode"}},{key:"isAjaxAction",value:function e(){return babelHelpers.classPrivateFieldGet(this,_type)==="runAjaxAction"}},{key:"isCallRestBatch",value:function e(){return babelHelpers.classPrivateFieldGet(this,_type)==="callRestBatch"}},{key:"isRedirect",value:function e(){return babelHelpers.classPrivateFieldGet(this,_type)==="redirect"}},{key:"isShowInfoHelper",value:function e(){return babelHelpers.classPrivateFieldGet(this,_type)==="showInfoHelper"}},{key:"isShowMenu",value:function e(){return babelHelpers.classPrivateFieldGet(this,_type)==="showMenu"}},{key:"getValue",value:function e(){return babelHelpers.classPrivateFieldGet(this,_value)}},{key:"getActionParam",value:function e(t){return babelHelpers.classPrivateFieldGet(this,_actionParams)&&babelHelpers.classPrivateFieldGet(this,_actionParams).hasOwnProperty(t)?babelHelpers.classPrivateFieldGet(this,_actionParams)[t]:null}}]);return Action}();function _prepareRunActionParams2(e){const t={};if(main_core.Type.isUndefined(e)){return t}for(const i in e){const s=e[i];if(main_core.Type.isDate(s)){t[i]=main_date.DateTimeFormat.format(crm_timeline_tools.DatetimeConverter.getSiteDateTimeFormat(),s)}else if(main_core.Type.isPlainObject(s)){t[i]=_classPrivateMethodGet$1(this,_prepareRunActionParams,_prepareRunActionParams2).call(this,s)}else{t[i]=s}}return t}function _prepareCallBatchParams2(e){const t={};if(main_core.Type.isUndefined(e)){return t}for(const i in e){t[i]={method:e[i].method,params:_classPrivateMethodGet$1(this,_prepareRunActionParams,_prepareRunActionParams2).call(this,e[i].params)}}return t}function _prepareMenuItems2(e,t){return Object.values(e).filter((e=>e.state!=="hidden"&&e.scope!=="mobile"&&(!t.isReadOnly||!e.hideIfReadonly))).sort(((e,t)=>e.sort-t.sort))}function _startAnimation2(e){if(!_classPrivateMethodGet$1(this,_isAnimationValid,_isAnimationValid2).call(this)){return}if(babelHelpers.classPrivateFieldGet(this,_animation).target===AnimationTarget.item){if(babelHelpers.classPrivateFieldGet(this,_animation).type===AnimationType.disable){e.$root.setFaded(true)}if(babelHelpers.classPrivateFieldGet(this,_animation).type===AnimationType.loader){e.$root.showLoader(true)}}if(babelHelpers.classPrivateFieldGet(this,_animation).target===AnimationTarget.block){if(babelHelpers.classPrivateFieldGet(this,_animation).type===AnimationType.disable){if(main_core.Type.isFunction(e.setDisabled)){e.setDisabled(true)}}if(babelHelpers.classPrivateFieldGet(this,_animation).type===AnimationType.loader){if(main_core.Type.isFunction(e.setLoading)){e.setLoading(true)}}}}function _stopAnimation2(e,t=false){if(!_classPrivateMethodGet$1(this,_isAnimationValid,_isAnimationValid2).call(this)){return}if(babelHelpers.classPrivateFieldGet(this,_animation).forever&&!t){return}if(babelHelpers.classPrivateFieldGet(this,_animation).target===AnimationTarget.item){if(babelHelpers.classPrivateFieldGet(this,_animation).type===AnimationType.disable){e.$root.setFaded(false)}if(babelHelpers.classPrivateFieldGet(this,_animation).type===AnimationType.loader){e.$root.showLoader(false)}}if(babelHelpers.classPrivateFieldGet(this,_animation).target===AnimationTarget.block){if(babelHelpers.classPrivateFieldGet(this,_animation).type===AnimationType.disable){if(main_core.Type.isFunction(e.setDisabled)){e.setDisabled(false)}}if(babelHelpers.classPrivateFieldGet(this,_animation).type===AnimationType.loader){if(main_core.Type.isFunction(e.setLoading)){e.setLoading(false)}}}}function _isAnimationValid2(){if(!babelHelpers.classPrivateFieldGet(this,_animation)){return false}if(!AnimationTarget.hasOwnProperty(babelHelpers.classPrivateFieldGet(this,_animation).target)){return false}return AnimationType.hasOwnProperty(babelHelpers.classPrivateFieldGet(this,_animation).type)}function _sendAnalytics2(){if(babelHelpers.classPrivateFieldGet(this,_analytics)&&babelHelpers.classPrivateFieldGet(this,_analytics).hit){const e={...babelHelpers.classPrivateFieldGet(this,_analytics)};delete e.hit;ui_analytics.sendData(e)}}const Logo={props:{type:String,addIcon:String,addIconType:String,icon:String,iconType:String,backgroundUrl:String,backgroundSize:Number,inCircle:{type:Boolean,required:false,default:false},action:Object},data(){return{currentIcon:this.icon}},computed:{className(){return["crm-timeline__card-logo",`--${this.type}`,{"--clickable":this.action}]},iconClassname(){return["crm-timeline__card-logo_icon",`--${this.currentIcon}`,{"--in-circle":this.inCircle,[`--type-${this.iconType}`]:!!this.iconType&&!this.backgroundUrl,"--custom-bg":!!this.backgroundUrl}]},addIconClassname(){return["crm-timeline__card-logo_add-icon",`--type-${this.addIconType}`,`--icon-${this.addIcon}`]},iconInteriorStyle(){const e={};if(this.backgroundUrl){e.backgroundImage="url("+encodeURI(main_core.Text.encode(this.backgroundUrl))+")"}if(this.backgroundSize){e.backgroundSize=parseInt(this.backgroundSize)+"px"}return e}},watch:{icon(e){this.currentIcon=e}},methods:{executeAction(){if(!this.action){return}const e=new Action(this.action);e.execute(this)},setIcon(e){this.currentIcon=e}},template:`\n\t\t<div :class="className" @click="executeAction">\n\t\t\t<div class="crm-timeline__card-logo_content">\n\t\t\t\t<div :class="iconClassname">\n\t\t\t\t\t<i :style="iconInteriorStyle"></i>\n\t\t\t\t</div>\n\t\t\t\t<div :class="addIconClassname" v-if="addIcon">\n\t\t\t\t\t<i></i>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const CalendarIcon={props:{timestamp:{type:Number,required:true,default:0},calendarEventId:{type:Number,required:false,default:null}},computed:{date(){return this.formatUserTime("d")},month(){return this.formatUserTime("F")},dayWeek(){return this.formatUserTime("D")},time(){return this.getDateTimeConverter().toTimeString()},userTime(){return this.getDateTimeConverter().getValue()},hasCalendarEventId(){return this.calendarEventId>0}},methods:{getDateTimeConverter(){return crm_timeline_tools.DatetimeConverter.createFromServerTimestamp(this.timestamp).toUserTime()},formatUserTime(e){return main_date.DateTimeFormat.format(e,this.userTime)}},template:`\n\t\t<div class="crm-timeline__calendar-icon-container">\n\t\t\t<div v-if="hasCalendarEventId" class="crm-timeline__calendar-icon_event_icon"></div>\n\t\t\t<div class="crm-timeline__calendar-icon">\n\t\t\t\t<header class="crm-timeline__calendar-icon_top">\n\t\t\t\t\t<div class="crm-timeline__calendar-icon_bullets">\n\t\t\t\t\t\t<div class="crm-timeline__calendar-icon_bullet"></div>\n\t\t\t\t\t\t<div class="crm-timeline__calendar-icon_bullet"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</header>\n\t\t\t\t<main class="crm-timeline__calendar-icon_content">\n\t\t\t\t\t<div class="crm-timeline__calendar-icon_day">{{ date }}</div>\n\t\t\t\t\t<div class="crm-timeline__calendar-icon_month">{{ month }}</div>\n\t\t\t\t\t<div class="crm-timeline__calendar-icon_date">\n\t\t\t\t\t\t<span class="crm-timeline__calendar-icon_day-week">{{ dayWeek }}</span>\n\t\t\t\t\t\t<span class="crm-timeline__calendar-icon_time">{{ time }}</span>\n\t\t\t\t\t</div>\n\t\t\t\t</main>\n\t\t\t</div>\n\t\t</div>\n\t`};const LogoCalendar=ui_vue3.BitrixVue.cloneComponent(Logo,{components:{CalendarIcon:CalendarIcon},props:{timestamp:{type:Number,required:false,default:0},addIcon:String,addIconType:String,calendarEventId:{type:Number,required:false,default:null},backgroundColor:{type:String,required:false,default:null}},computed:{addIconClassname(){return["crm-timeline__card-logo_add-icon",`--type-${this.addIconType}`,`--icon-${this.addIcon}`]},logoStyle(){if(main_core.Type.isStringFilled(this.backgroundColor)){return{"--crm-timeline__logo-background":main_core.Text.encode(this.backgroundColor)}}return{}}},template:`\n\t\t<div \n\t\t\t:class="className"\n\t\t\t:style="logoStyle"\n\t\t\t@click="executeAction"\n\t\t>\n\t\t\t<div class="crm-timeline__card-logo_content">\n\t\t\t\t<CalendarIcon :timestamp="timestamp" :calendar-event-id="calendarEventId" />\n\t\t\t\t<div :class="addIconClassname" v-if="addIcon">\n\t\t\t\t\t<i></i>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`});const Body={components:{Logo:Logo,LogoCalendar:LogoCalendar},props:{logo:Object,blocks:Object},data(){return{blockRefs:{}}},mounted(){const e=this.$refs.blocks;if(!e||!this.visibleBlocks){return}this.visibleBlocks.forEach(((t,i)=>{if(main_core.Type.isDomNode(e[i].$el)){e[i].$el.setAttribute("data-id",t.id)}else{throw new Error('Vue component "'+t.rendererName+'" was not found')}}))},beforeUpdate(){this.blockRefs={}},computed:{visibleBlocks(){if(!main_core.Type.isPlainObject(this.blocks)){return[]}return Object.keys(this.blocks).map((e=>({id:e,...this.blocks[e]}))).filter((e=>e.scope!=="mobile")).sort(((e,t)=>{let i=e.sort===undefined?0:e.sort;let s=t.sort===undefined?0:t.sort;if(i<s){return-1}if(i>s){return 1}return 0}))},contentContainerClassname(){return["crm-timeline__card-container",{"--without-logo":!this.logo}]}},methods:{getContentBlockById(e){var t;return(t=this.blockRefs[e])!==null&&t!==void 0?t:null},getLogo(){return this.$refs.logo},saveRef(e,t){this.blockRefs[t]=e}},template:`\n\t\t<div class="crm-timeline__card-body">\n\t\t\t<div v-if="logo" class="crm-timeline__card-logo_container">\n\t\t\t\t<LogoCalendar v-if="logo.icon === 'calendar'" v-bind="logo"></LogoCalendar>\n\t\t\t\t<Logo v-else v-bind="logo" ref="logo"></Logo>\n\t\t\t</div>\n\t\t\t<div :class="contentContainerClassname">\n\t\t\t\t<div\n\t\t\t\t\tv-for="block in visibleBlocks"\n\t\t\t\t\t:key="block.id"\n\t\t\t\t\tclass="crm-timeline__card-container_block"\n\t\t\t\t>\n\t\t\t\t\t<component\n\t\t\t\t\t\t:is="block.rendererName"\n\t\t\t\t\t\tv-bind="block.properties"\n\t\t\t\t\t\t:ref="(el) => this.saveRef(el, block.id)"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};let ButtonScope=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(ButtonScope,"MOBILE","mobile");let ButtonType=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(ButtonType,"ICON","icon");babelHelpers.defineProperty(ButtonType,"PRIMARY","primary");babelHelpers.defineProperty(ButtonType,"SECONDARY","secondary");babelHelpers.defineProperty(ButtonType,"LIGHT","light");babelHelpers.defineProperty(ButtonType,"AI","ai");const BaseButton={props:{id:{type:String,required:false,default:""},title:{type:String,required:false,default:""},tooltip:{type:String,required:false,default:""},state:{type:String,required:false,default:ButtonState.DEFAULT},props:Object,action:Object},data(){return{currentState:this.state}},computed:{itemStateToButtonStateDict(){return{[ButtonState.LOADING]:ui_buttons.Button.State.WAITING,[ButtonState.DISABLED]:ui_buttons.Button.State.DISABLED,[ButtonState.AI_LOADING]:ui_buttons.Button.State.AI_WAITING}}},methods:{setDisabled(e){if(e){this.setButtonState(ButtonState.DISABLED)}else{this.setButtonState(ButtonState.DEFAULT)}},setLoading(e){if(e){this.setButtonState(ButtonState.LOADING)}else{this.setButtonState(ButtonState.DEFAULT)}},setButtonState(e){if(this.currentState!==e){this.currentState=e}},onLayoutUpdated(){this.setButtonState(this.state)},executeAction(){if(this.action&&this.currentState!==ButtonState.DISABLED&&this.currentState!==ButtonState.LOADING&&this.currentState!==ButtonState.AI_LOADING){const e=new Action(this.action);e.execute(this)}}},created(){this.$Bitrix.eventEmitter.subscribe("layout:updated",this.onLayoutUpdated)},beforeUnmount(){this.$Bitrix.eventEmitter.unsubscribe("layout:updated",this.onLayoutUpdated)},template:`<button></button>`};const Button=ui_vue3.BitrixVue.cloneComponent(BaseButton,{props:{type:{type:String,required:false,default:ButtonType.SECONDARY},iconName:{type:String,required:false,default:""},size:{type:String,required:false,default:"extra_small"},menuItems:{type:Object,required:false,default:null}},data(){return{popup:null,uiButton:Object.freeze(null),timerSecondsRemaining:0,currentState:this.state,hintText:main_core.Type.isStringFilled(this.tooltip)?main_core.Text.encode(this.tooltip):""}},computed:{itemTypeToButtonColorDict(){return{[ButtonType.PRIMARY]:ui_buttons.Button.Color.PRIMARY,[ButtonType.SECONDARY]:ui_buttons.Button.Color.LIGHT_BORDER,[ButtonType.LIGHT]:ui_buttons.Button.Color.LIGHT,[ButtonType.ICON]:ui_buttons.Button.Color.LINK,[ButtonType.AI]:ui_buttons.Button.Color.AI}},buttonContainerRef(){return this.$refs.buttonContainer}},methods:{getButtonOptions(){const e=main_core.Type.isString(this.iconName)?this.iconName.toUpperCase():"";const t=main_core.Type.isString(this.size)?this.size.toUpperCase():"extra_small";const i=this.itemTypeToButtonColorDict[this.type]||ui_buttons.Button.Color.LIGHT_BORDER;const s=this.type===ButtonType.ICON?"":this.title;return{id:this.id,round:true,dependOnTheme:false,size:ui_buttons.Button.Size[t],text:s,color:i,state:this.itemStateToButtonStateDict[this.currentState],icon:ui_buttons.Button.Icon[e],props:main_core.Type.isPlainObject(this.props)?this.props:{}}},getUiButton(){return this.uiButton},disableWithTimer(e){this.setButtonState(ButtonState.DISABLED);const t=this.getUiButton();let i=e;t.setText(this.formatSeconds(i));const s=setInterval((()=>{if(i<1){clearInterval(s);t.setText(this.title);this.setButtonState(ButtonState.DEFAULT);return}i--;t.setText(this.formatSeconds(i))}),1e3)},formatSeconds(e){const t=Math.floor(e/60);const i=e%60;const s=this.formatNumber(t);const n=this.formatNumber(i);return`${s}:${n}`},formatNumber(e){return e<10?`0${e}`:e},setButtonState(e){var t,i;this.parentSetButtonState(e);(t=this.getUiButton())===null||t===void 0?void 0:t.setState((i=this.itemStateToButtonStateDict[this.currentState])!==null&&i!==void 0?i:null)},createSplitButton(){const e=Object.keys(this.menuItems).map((e=>this.menuItems[e]));const t=this.getButtonOptions();t.menuButton={onclick:(t,i)=>{i.stopPropagation();Menu.showMenu(this,e,{id:`split-button-menu-${this.id}`,className:"crm-timeline__split-button-menu",width:230,angle:true,cacheable:false,offsetLeft:13,bindElement:this.$el.querySelector(".ui-btn-menu")})}};return new ui_buttons.SplitButton(t)},renderButton(){if(!this.buttonContainerRef){return}this.buttonContainerRef.innerHTML="";const e=this.menuItems?this.createSplitButton():new ui_buttons.Button(this.getButtonOptions());e.renderTo(this.buttonContainerRef);this.uiButton=e},setTooltip(e){this.hintText=e},showTooltip(){if(this.hintText===""){return}BX.UI.Hint.show(this.$el,this.hintText,true)},hideTooltip(){if(this.hintText===""){return}BX.UI.Hint.hide(this.$el)},isInViewport(){const e=this.$el.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&e.right<=(window.innerWidth||document.documentElement.clientWidth)},isPropEqual(e,t){return this.getButtonOptions().props[e]===t}},watch:{state(e){this.setButtonState(e)},tooltip(e){this.hintText=main_core.Type.isStringFilled(e)?main_core.Text.encode(e):""}},mounted(){this.renderButton()},updated(){this.renderButton()},template:`\n\t\t<div\n\t\t\t:class="$attrs.class"\n\t\t\tref="buttonContainer"\n\t\t\t@click="executeAction"\n\t\t\t@mouseover="showTooltip"\n\t\t\t@mouseleave="hideTooltip"\n\t\t>\n\t\t</div>\n\t`});const AdditionalButtonIcon=Object.freeze({NOTE:"note",SCRIPT:"script",PRINT:"print",DOTS:"dots"});const AdditionalButtonColor=Object.freeze({DEFAULT:"default",PRIMARY:"primary"});const AdditionalButton=ui_vue3.BitrixVue.cloneComponent(BaseButton,{props:{iconName:{type:String,required:false,default:"",validator(e){return Object.values(AdditionalButtonIcon).indexOf(e)>-1}},color:{type:String,required:false,default:AdditionalButtonColor.DEFAULT,validator(e){return Object.values(AdditionalButtonColor).indexOf(e)>-1}}},computed:{className(){return["crm-timeline__card_add-button",{[`--icon-${this.iconName}`]:this.iconName,[`--color-${this.color}`]:this.color,[`--state-${this.currentState}`]:this.currentState}]},ButtonState(){return ButtonState},loaderHtml(){const e=new main_loader.Loader({mode:"inline",size:20});e.show();return e.layout.outerHTML}},template:`\n\t\t<transition name="crm-timeline__card_add-button-fade" mode="out-in">\n\t\t\t<div\n\t\t\t\tv-if="currentState === ButtonState.LOADING"\n\t\t\t\tv-html="loaderHtml"\n\t\t\t\tclass="crm-timeline__card_add-button"\n\t\t\t></div>\n\t\t\t<div\n\t\t\t\tv-else\n\t\t\t\t:title="title"\n\t\t\t\t@click="executeAction"\n\t\t\t\t:class="className">\n\t\t\t</div>\n\t\t</transition>\n\t`});const Buttons={components:{Button:Button},props:{items:{type:Array,required:false,default:()=>[]}},methods:{getButtonById(e){const t=this.$refs.buttons;return this.items.reduce(((i,s,n)=>{if(i){return i}if(s.id===e){return t[n]}return null}),null)}},template:`\n\t\t\t<div class="crm-timeline__card-action_buttons">\n\t\t\t\t<Button class="crm-timeline__card-action-btn" v-for="item in items" v-bind="item" ref="buttons" />\n\t\t\t</div>\n\t\t`};const MenuId="timeline-more-button-menu";const Menu$1={components:{AdditionalButton:AdditionalButton},props:{buttons:Array,items:Object},inject:["isReadOnly"],computed:{isMenuFilled(){const e=this.menuItems;return e.length>0},itemsArray(){if(!this.items){return[]}return Object.values(this.items).filter((e=>e.state!=="hidden"&&e.scope!=="mobile"&&(!this.isReadOnly||!e.hideIfReadonly))).sort(((e,t)=>e.sort-t.sort))},menuItems(){let e=this.buttons;if(this.buttons.length&&this.itemsArray.length){e.push({delimiter:true})}e=[...e,...this.itemsArray];return e},buttonProps(){return{color:AdditionalButtonColor.DEFAULT,icon:AdditionalButtonIcon.DOTS}}},beforeUnmount(){const e=main_popup.MenuManager.getMenuById(MenuId);if(e){e.destroy()}},methods:{showMenu(){Menu.showMenu(this,this.menuItems,{id:MenuId,className:"crm-timeline__card_more-menu",width:230,angle:false,cacheable:false,bindElement:this.$el})}},template:`\n\t\t<div v-if="isMenuFilled" class="crm-timeline__card-action_menu-item" @click="showMenu">\n\t\t\t<AdditionalButton iconName="dots" color="default"></AdditionalButton>\n\t\t</div>\n\t`};const Footer={components:{Buttons:Buttons,Menu:Menu$1,Button:Button,AdditionalButton:AdditionalButton},props:{buttons:Object,menu:Object,additionalButtons:{type:Object,required:false,default:()=>({})},maxBaseButtonsCount:{type:Number,required:false,default:3}},inject:["isReadOnly"],computed:{containerClassname(){return["crm-timeline__card-action",{"--no-margin-top":this.baseButtons.length<1}]},baseButtons(){return this.visibleAndSortedButtons.slice(0,this.maxBaseButtonsCount)},moreButtons(){return this.visibleAndSortedButtons.slice(this.maxBaseButtonsCount)},visibleAndSortedButtons(){return this.visibleButtons.sort(this.buttonsSorter)},visibleAndSortedAdditionalButtons(){return this.visibleAdditionalButtons.sort(this.buttonsSorter)},visibleButtons(){if(!main_core.Type.isPlainObject(this.buttons)){return[]}return this.buttons?Object.keys(this.buttons).map((e=>({id:e,...this.buttons[e]}))).filter(this.visibleButtonsFilter):[]},visibleAdditionalButtons(){return this.additionalButtonsArray?Object.values(this.additionalButtonsArray).filter(this.visibleButtonsFilter):[]},additionalButtonsArray(){return Object.entries(this.additionalButtons).map((([e,t])=>({id:e,type:ButtonType.ICON,...t})))},hasMenu(){return this.moreButtons.length||main_core.Type.isPlainObject(this.menu)&&Object.keys(this.menu).length}},methods:{visibleButtonsFilter(e){return e.state!==ButtonState.HIDDEN&&e.scope!==ButtonScope.MOBILE&&(!this.isReadOnly||!e.hideIfReadonly)},buttonsSorter(e,t){return(e===null||e===void 0?void 0:e.sort)-(t===null||t===void 0?void 0:t.sort)},getButtonById(e){if(this.$refs.buttons){const t=this.$refs.buttons.getButtonById(e);if(t){return t}}if(this.$refs.additionalButtons){return this.visibleAndSortedAdditionalButtons.reduce(((t,i,s)=>{if(t){return t}if(i.id===e){return buttons[s]}return null}),null)}return null},getMenu(){if(this.$refs.menu){return this.$refs.menu}return null}},template:`\n\t\t<div :class="containerClassname">\n\t\t\t<div class="crm-timeline__card-action_menu">\n\t\t\t\t<div\n\t\t\t\t\tv-for="button in visibleAndSortedAdditionalButtons"\n\t\t\t\t\t:key="button.id"\n\t\t\t\t\tclass="crm-timeline__card-action_menu-item"\n\t\t\t\t>\n\t\t\t\t\t<additional-button\n\t\t\t\t\t\tv-bind="button"\n\t\t\t\t\t>\n\t\t\t\t\t</additional-button>\n\t\t\t\t</div>\n\t\t\t\t<Menu v-if="hasMenu" :buttons="moreButtons" v-bind="menu" ref="menu"/>\n\t\t\t</div>\n\t\t\t<Buttons ref="buttons" :items="baseButtons" />\n\t\t</div>\n\t`};const ChangeStreamButton={props:{disableIfReadonly:Boolean,type:String,title:String,action:Object},data(){return{isReadonlyMode:false,isComplete:false}},inject:["isReadOnly"],mounted(){this.isReadonlyMode=this.isReadOnly},computed:{isShowPinButton(){return this.type==="pin"&&!this.isReadonlyMode},isShowUnpinButton(){return this.type==="unpin"&&!this.isReadonlyMode}},methods:{executeAction(){if(!this.action){return}this.isComplete=true;const e=new Action(this.action);e.execute(this).then((()=>{})).catch((()=>{this.isComplete=false}))},onClick(){if(this.action){const e=new Action(this.action);e.execute(this)}},setDisabled(e){if(!this.isReadonly&&!e){this.isReadonlyMode=false}if(e){this.isReadonlyMode=true}},markCheckboxUnchecked(){this.isComplete=false}},template:`\n\t\t<div class="crm-timeline__card-top_controller">\n\t\t\t<input\n\t\t\t\tv-if="type === 'complete'"\n\t\t\t\t@click="executeAction"\n\t\t\t\ttype="checkbox"\n\t\t\t\t:disabled="isReadonlyMode"\n\t\t\t\t:checked="isComplete"\n\t\t\t\tclass="crm-timeline__card-top_checkbox"\n\t\t\t/>\n\t\t\t<div\n\t\t\t\tv-else-if="isShowPinButton"\n\t\t\t\t:title="title"\n\t\t\t\t@click="executeAction"\n\t\t\t\tclass="crm-timeline__card-top_icon --pin"\n\t\t\t></div>\n\t\t\t<div\n\t\t\t\tv-else-if="isShowUnpinButton"\n\t\t\t\t:title="title"\n\t\t\t\t@click="executeAction"\n\t\t\t\tclass="crm-timeline__card-top_icon --unpin"\n\t\t\t></div>\n\t\t</div>\n\t`};const ColorSelector={directives:{hint:ui_vue3_directives_hint.hint},props:{valuesList:{type:Object,required:true},selectedValueId:{type:String,default:"default"},readOnlyMode:{type:Boolean,required:false,default:false}},data(){return{currentValueId:this.selectedValueId}},methods:{getValue(){return this.currentValueId},setValue(e){this.currentValueId=e;if(this.itemSelector){this.itemSelector.setValue(e)}},onItemSelectorValueChange({data:e}){const t=e.value;if(this.currentValueId!==t){this.currentValueId=t;this.emitEvent("ColorSelector:Change",{colorId:t})}},emitEvent(e,t){const i=new Action({type:"jsEvent",value:e,actionParams:t});i.execute(this)}},mounted(){void this.$nextTick((()=>{this.itemSelector=new crm_field_colorSelector.ColorSelector({target:this.$refs.itemSelectorRef,colorList:this.valuesList,selectedColorId:this.currentValueId,readOnlyMode:this.readOnlyMode});if(!this.readOnlyMode){main_core_events.EventEmitter.subscribe(this.itemSelector,crm_field_colorSelector.ColorSelectorEvents.EVENT_COLORSELECTOR_VALUE_CHANGE,this.onItemSelectorValueChange)}}))},computed:{hint(){if(this.readOnlyMode){return null}return{text:this.$Bitrix.Loc.getMessage("CRM_ACTIVITY_TODO_COLOR_SELECTOR_HINT"),popupOptions:{angle:{offset:30,position:"top"},offsetTop:2}}}},template:`\n\t\t<div class="crm-activity__todo-editor-v2_color-selector">\n\t\t\t<div ref="itemSelectorRef" v-hint="hint"></div>\n\t\t</div>\n\t`};const FormatDate={name:"FormatDate",props:{timestamp:{type:Number,required:true,default:0},datePlaceholder:{type:String,required:false,default:""},useShortTimeFormat:{type:Boolean,required:false,default:false},class:{type:[Array,Object,String],required:false,default:""}},computed:{formattedDate(){if(!this.timestamp){return this.datePlaceholder}const e=crm_timeline_tools.DatetimeConverter.createFromServerTimestamp(this.timestamp).toUserTime();return this.useShortTimeFormat?e.toTimeString():e.toDatetimeString({delimiter:", "})}},template:`\n\t\t<div :class="$props.class">{{ formattedDate }}</div>\n\t`};const Hint={data(){return{isMouseOnHintArea:false,hintPopup:null}},props:{icon:{type:String,required:false,default:""},textBlocks:{type:Array,required:false,default:[]}},computed:{hintContentIcon(){if(this.icon===""){return null}const e=main_core.Dom.create("i");return main_core.Dom.create("div",{attrs:{classname:this.hintContentIconClassname},children:[e]})},hintContentText(){return main_core.Dom.create("div",{attrs:{classname:"crm-timeline__hint_popup-content-text"},children:this.hintContentTextBlocks})},hintContentTextBlocks(){return this.textBlocks.map(this.getContentBlockNode)},hintContentIconClassname(){const e="crm-timeline__hint_popup-content-icon";return`${e} --${this.icon}`},hintIconClassname(){return["ui-hint","crm-timeline__header-hint",{"--active":this.hintPopup}]},hasContent(){return this.textBlocks.length>0}},methods:{getHintContent(){return main_core.Dom.create("div",{attrs:{classname:"crm-timeline__hint_popup-content"},style:{display:"flex"},children:[this.hintContentIcon,this.hintContentText]})},getPopupOptions(){return{darkMode:true,autoHide:false,content:this.getHintContent(),maxWidth:400,bindOptions:{position:"top"},animation:"fading-slide"}},getPopupPosition(){var e;const t=this.$refs.hint;const i=main_popup.Popup.getOption("angleLeftOffset");const{width:s,left:n,top:a}=main_core.Dom.getPosition(t);const{width:r}=main_core.Dom.getPosition((e=this.hintPopup)===null||e===void 0?void 0:e.getPopupContainer());return{left:n+i-(r-s)/2,top:a+15}},getPopupAngleOffset(e){const t=33;const{width:i}=main_core.Dom.getPosition(e);return(i-t)/2},onMouseEnterToPopup(){this.isMouseOnHintArea=true},onHintAreaMouseLeave(){this.isMouseOnHintArea=false;setTimeout((()=>{if(!this.isMouseOnHintArea){this.hideHintPopup()}}),400)},onMouseEnterToHint(){this.isMouseOnHintArea=true;this.showHintPopupWithDebounce()},showHintPopup(){if(!this.isMouseOnHintArea||this.hintPopup&&this.hintPopup.isShown()){return}this.hintPopup=new main_popup.Popup(this.getPopupOptions());const e=this.hintPopup.getPopupContainer();main_core.Event.bind(e,"mouseenter",this.onMouseEnterToPopup);main_core.Event.bind(e,"mouseleave",this.onHintAreaMouseLeave);this.hintPopup.show();this.hintPopup.setBindElement(this.getPopupPosition());this.hintPopup.setAngle(false);this.hintPopup.setAngle({offset:this.getPopupAngleOffset(e,this.$refs.hint)});this.hintPopup.adjustPosition();this.hintPopup.show()},showHintPopupWithDebounce(){main_core.Runtime.debounce(this.showHintPopup,300,this)()},hideHintPopup(){if(!this.hintPopup){return}this.hintPopup.close();const e=this.hintPopup.getPopupContainer();main_core.Event.unbind(e,"mouseenter",this.onMouseEnterToPopup);main_core.Event.unbind(e,"mouseleave",this.onHintAreaMouseLeave);this.hintPopup.destroy();this.hintPopup=null},hideHintPopupWithDebounce(){return main_core.Runtime.debounce(this.hideHintPopup,300,this)},getContentBlockNode(e){if(e.type==="text"){return this.getTextNode(e.options)}else if(e.type==="link"){return this.getLinkNode(e.options)}return null},getTextNode(e={}){return main_core.Dom.create("span",{text:e.text})},getLinkNode(e={}){const t=main_core.Dom.create("span",{text:e.text});main_core.Dom.addClass(t,"crm-timeline__hint_popup-content-link");t.onclick=()=>{this.executeAction(e.action)};return t},executeAction(e){if(e){const t=new Action(e);t.execute(this)}}},template:`\n\t\t<span\n\t\t\tref="hint"\n\t\t\t@click.stop.prevent\n\t\t\t@mouseenter="onMouseEnterToHint"\n\t\t\t@mouseleave="onHintAreaMouseLeave"\n\t\t\tv-if="hasContent"\n\t\t\t:class="hintIconClassname"\n\t\t>\n\t\t\t<span class="ui-hint-icon" />\n\t\t</span>\n\t`};let TagType=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(TagType,"PRIMARY","primary");babelHelpers.defineProperty(TagType,"SECONDARY","secondary");babelHelpers.defineProperty(TagType,"SUCCESS","success");babelHelpers.defineProperty(TagType,"WARNING","warning");babelHelpers.defineProperty(TagType,"FAILURE","failure");babelHelpers.defineProperty(TagType,"LAVENDER","lavender");const Tag={props:{title:{type:String,required:false,default:""},hint:{type:String,required:false,default:""},action:{type:Object,required:false,default:null},type:{type:String,required:false,default:TagType.SECONDARY},state:String},computed:{className(){return{"crm-timeline__card-status":true,"--clickable":Boolean(this.action),"--hint":Boolean(this.hint)}},tagTypeToLabelColorDict(){return{[TagType.PRIMARY]:ui_label.Label.Color.LIGHT_BLUE,[TagType.SECONDARY]:ui_label.Label.Color.LIGHT,[TagType.LAVENDER]:ui_label.Label.Color.LAVENDER,[TagType.SUCCESS]:ui_label.Label.Color.LIGHT_GREEN,[TagType.WARNING]:ui_label.Label.Color.LIGHT_YELLOW,[TagType.FAILURE]:ui_label.Label.Color.LIGHT_RED}},tagContainerRef(){return this.$refs.tag}},methods:{getLabelColorFromTagType(e){const t=e?e.toLowerCase():"";const i=this.tagTypeToLabelColorDict[t];return i||ui_label.Label.Color.LIGHT},renderTag(e){if(!e||!this.tagContainerRef){return null}const{title:t,type:i}=e;const s=t&&main_core.Type.isString(t)?t.toUpperCase():"";const n=new ui_label.Label({text:s,color:this.getLabelColorFromTagType(i),fill:true});main_core.Dom.clean(this.tagContainerRef);main_core.Dom.append(n.render(),this.tagContainerRef)},executeAction(){if(!this.action){return}const e=new Action(this.action);e.execute(this)},showTooltip(){if(this.hint===""){return}main_core.Runtime.debounce((()=>{BX.UI.Hint.show(this.$el,this.hint,true)}),50,this)()},hideTooltip(){if(this.hint===""){return}BX.UI.Hint.hide(this.$el)}},mounted(){this.renderTag({title:this.title,type:this.type})},updated(){this.renderTag({title:this.title,type:this.type})},template:`\n\t\t<div\n\t\t\tref="tag"\n\t\t\t:class="className"\n\t\t\t@mouseover="showTooltip"\n\t\t\t@mouseleave="hideTooltip"\n\t\t\t@click="executeAction"\n\t\t></div>\n\t`};const Title={props:{title:String,action:Object},inject:["isLogMessage"],computed:{className(){return["crm-timeline__card-title",{"--light":this.isLogMessage,"--action":!!this.action}]},href(){if(!this.action){return null}const e=new Action(this.action);if(e.isRedirect()){return e.getValue()}return null}},methods:{executeAction(){if(!this.action){return}const e=new Action(this.action);e.execute(this)}},template:`\n\t\t<a\n\t\t\tv-if="href"\n\t\t\t:href="href"\n\t\t\t:class="className"\n\t\t\ttabindex="0"\n\t\t\t:title="title"\n\t\t>\n\t\t\t{{title}}\n\t\t</a>\n\t\t<span\n\t\t\tv-else\n\t\t\t@click="executeAction"\n\t\t\t:class="className"\n\t\t\ttabindex="0"\n\t\t\t:title="title"\n\t\t>\n\t\t\t{{title}}\n\t\t</span>`};const User={props:{title:String,detailUrl:String,imageUrl:String},inject:["isLogMessage"],computed:{styles(){if(!this.imageUrl){return{}}return{backgroundImage:"url('"+encodeURI(main_core.Text.encode(this.imageUrl))+"')",backgroundSize:"21px"}},className(){return["ui-icon","ui-icon-common-user","crm-timeline__user-icon",{"--muted":this.isLogMessage}]}},template:`<a :class="className" :href="detailUrl"\n\t\t\t\t  target="_blank" :title="title"><i :style="styles"></i></a>`};const Header={components:{ColorSelector:ColorSelector,ChangeStreamButton:ChangeStreamButton,Title:Title,Tag:Tag,User:User,FormatDate:FormatDate,Hint:Hint},props:{title:String,titleAction:Object,date:Number,datePlaceholder:String,useShortTimeFormat:Boolean,changeStreamButton:Object|null,tags:Object,user:Object,infoHelper:Object,colorSettings:{type:Object,required:false,default:null}},inject:["isReadOnly","isLogMessage"],computed:{visibleTags(){if(!main_core.Type.isPlainObject(this.tags)){return[]}return this.tags?Object.values(this.tags).filter((e=>this.isVisibleTagFilter(e))):[]},visibleAndAscSortedTags(){const e=main_core.Runtime.clone(this.visibleTags);return e.sort(this.tagsAscSorter)},isShowDate(){return this.date||this.datePlaceholder},className(){return["crm-timeline__card-top",{"--log-message":this.isReadOnly||this.isLogMessage}]}},methods:{isVisibleTagFilter(e){return e.state!=="hidden"&&e.scope!=="mobile"&&(!this.isReadOnly||!e.hideIfReadonly)},tagsAscSorter(e,t){return e.sort-t.sort},getChangeStreamButton(){return this.$refs.changeStreamButton}},created(){this.$watch("colorSettings",(e=>{this.$refs.colorSelector.setValue(e.selectedValueId)}),{deep:true})},template:`\n\t\t<div :class="className">\n\t\t\t<div class="crm-timeline__card-top_info">\n\t\t\t\t<div class="crm-timeline__card-top_info_left">\n\t\t\t\t\t<ChangeStreamButton \n\t\t\t\t\t\tv-if="changeStreamButton" \n\t\t\t\t\t\tv-bind="changeStreamButton" \n\t\t\t\t\t\tref="changeStreamButton"\n\t\t\t\t\t/>\n\t\t\t\t\t<Title :title="title" :action="titleAction"></Title>\n\t\t\t\t\t<Hint v-if="infoHelper" v-bind="infoHelper"></Hint>\n\t\t\t\t</div>\n\t\t\t\t<div ref="tags" class="crm-timeline__card-top_info_right">\n\t\t\t\t\t<Tag\n\t\t\t\t\t\tv-for="(tag, index) in visibleAndAscSortedTags"\n\t\t\t\t\t\t:key="index"\n\t\t\t\t\t\tv-bind="tag"\n\t\t\t\t\t/>\n\t\t\t\t\t<FormatDate\n\t\t\t\t\t\tv-if="isShowDate"\n\t\t\t\t\t\t:timestamp="date"\n\t\t\t\t\t\t:use-short-time-format="useShortTimeFormat"\n\t\t\t\t\t\t:date-placeholder="datePlaceholder"\n\t\t\t\t\t\tclass="crm-timeline__card-time"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="crm-timeline__card-top_components-container">\n\t\t\t\t<ColorSelector\n\t\t\t\t\tv-if="colorSettings"\n\t\t\t\t\tref="colorSelector"\n\t\t\t\t\t:valuesList="colorSettings.valuesList"\n\t\t\t\t\t:selectedValueId="colorSettings.selectedValueId"\n\t\t\t\t\t:readOnlyMode="colorSettings.readOnlyMode"\n\t\t\t\t/>\n\t\t\t\t<User v-bind="user"></User>\n\t\t\t</div>\n\t\t</div>\n\t`};let IconBackgroundColor=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(IconBackgroundColor,"PRIMARY","primary");babelHelpers.defineProperty(IconBackgroundColor,"PRIMARY_ALT","primary_alt");babelHelpers.defineProperty(IconBackgroundColor,"FAILURE","failure");const Icon={props:{code:{type:String,required:false,default:"none"},counterType:{type:String,required:false,default:""},backgroundColorToken:{type:String,required:false,default:IconBackgroundColor.PRIMARY},backgroundUri:String,backgroundColor:{type:String,required:false,default:null}},inject:["isLogMessage"],computed:{className(){return{"crm-timeline__card_icon":true,[`--bg-${this.backgroundColorToken}`]:Boolean(this.backgroundColorToken),[`--code-${this.code}`]:Boolean(this.code)&&!this.backgroundUri,"--custom-bg":Boolean(this.backgroundUri),"--muted":this.isLogMessage}},counterNodeContainer(){return this.$refs.counter},styles(){if(!this.backgroundUri){return{}}return{backgroundImage:`url('${encodeURI(main_core.Text.encode(this.backgroundUri))}')`}},iconStyle(){if(main_core.Type.isStringFilled(this.backgroundColor)){return{"--crm-timeline-card-icon-background":main_core.Text.encode(this.backgroundColor)}}return{}}},methods:{renderCounter(){if(!this.counterType){return}main_core.Dom.clean(this.counterNodeContainer);const e=new ui_cnt.Counter({value:1,border:true,color:ui_cnt.Counter.Color[this.counterType.toUpperCase()]});e.renderTo(this.counterNodeContainer)}},mounted(){this.renderCounter()},watch:{counterType(e){void this.$nextTick((()=>{this.renderCounter()}))}},template:`\n\t\t<div :class="className" :style="iconStyle">\n\t\t\t<i :style="styles"></i>\n\t\t\t<div ref="counter" v-show="!!counterType" class="crm-timeline__card_icon_counter"></div>\n\t\t</div>\n\t`};const MarketPanel={props:{text:String,detailsText:String,detailsTextAction:Object},computed:{needShowDetailsText(){return main_core.Type.isStringFilled(this.detailsText)},href(){if(!this.detailsTextAction){return null}const e=new Action(this.detailsTextAction);if(e.isRedirect()){return e.getValue()}return null}},methods:{executeAction(){if(this.detailsTextAction){const e=new Action(this.detailsTextAction);e.execute(this)}}},template:`\n\t\t<div class="crm-timeline__card-bottom">\n\t\t<div class="crm-timeline__card-market">\n\t\t\t<div class="crm-timeline__card-market_container">\n\t\t\t\t<span class="crm-timeline__card-market_logo"></span>\n\t\t\t\t<span class="crm-timeline__card-market_text">{{ text }}</span>\n\t\t\t\t<a\n\t\t\t\t\tv-if="href && needShowDetailsText"\n\t\t\t\t\t:href="href"\n\t\t\t\t\tclass="crm-timeline__card-market_more"\n\t\t\t\t>\n\t\t\t\t\t{{detailsText}}\n\t\t\t\t</a>\n\t\t\t\t<span\n\t\t\t\t\tv-if="!href && needShowDetailsText"\n\t\t\t\t\t@click="executeAction"\n\t\t\t\t\tclass="crm-timeline__card-market_more"\n\t\t\t\t>\n\t\t\t\t{{detailsText}}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t\t<div class="crm-timeline__card-market_cross"><i></i></div>\n\t\t</div>\n\t\t</div>\n\t`};const UserPick={template:`\n\t\t<div class="ui-icon ui-icon-common-user crm-timeline__card-top_user-icon">\n\t\t\t<i></i>\n\t\t</div>\n\t`};const Item$2={components:{Icon:Icon,Header:Header,Body:Body,Footer:Footer,MarketPanel:MarketPanel,UserPick:UserPick},props:{initialLayout:Object,id:String,useShortTimeFormat:Boolean,isLogMessage:Boolean,isReadOnly:Boolean,currentUser:Object|null,onAction:Function,initialColor:{type:Object,required:false,default:null},streamType:{type:Number,required:false,default:StreamType.history}},data(){return{layout:this.initialLayout,color:this.initialColor,isFaded:false,loader:Object.freeze(null)}},provide(){var e;return{isLogMessage:Boolean((e=this.initialLayout)===null||e===void 0?void 0:e.isLogMessage),isReadOnly:this.isReadOnly,currentUser:this.currentUser}},created(){this.$Bitrix.eventEmitter.subscribe("crm:timeline:item:action",this.onActionEvent)},beforeUnmount(){this.$Bitrix.eventEmitter.unsubscribe("crm:timeline:item:action",this.onActionEvent)},methods:{onActionEvent(e){const t=e.getData();this.onAction(main_core.Runtime.clone(t))},setLayout(e){this.layout=e;this.isFaded=false;this.$Bitrix.eventEmitter.emit("layout:updated")},setColor(e){this.color=e},setFaded(e){this.isFaded=e},showLoader(e){if(e){this.setFaded(true);if(!this.loader){this.loader=new main_loader.Loader}this.loader.show(this.$el.parentNode)}else{if(this.loader){this.loader.hide()}this.setFaded(false)}},getContentBlockById(e){if(!this.$refs.body){return null}return this.$refs.body.getContentBlockById(e)},getLogo(){if(!this.$refs.body){return null}return this.$refs.body.getLogo()},getHeaderChangeStreamButton(){if(!this.$refs.header){return null}return this.$refs.header.getChangeStreamButton()},getFooterButtonById(e){if(!this.$refs.footer){return null}return this.$refs.footer.getButtonById(e)},getFooterMenu(){if(!this.$refs.footer){return null}return this.$refs.footer.getMenu()},highlightContentBlockById(e,t){if(!t){this.isFaded=false}const i=this.getContentBlockById(e);if(!i){return}if(t){this.isFaded=true;main_core.Dom.addClass(i.$el,"--highlighted")}else{this.isFaded=false;main_core.Dom.removeClass(i.$el,"--highlighted")}}},computed:{timelineCardClassname(){return{"crm-timeline__card":true,"crm-timeline__card-scope":true,"--stream-type-history":this.streamType===StreamType.history,"--stream-type-scheduled":this.streamType===StreamType.scheduled,"--stream-type-pinned":this.streamType===StreamType.pinned,"--log-message":this.isLogMessage}},timelineCardStyle(){if(main_core.Type.isPlainObject(this.color)&&this.streamType===StreamType.scheduled){return{"--crm-timeline__card-color-background":main_core.Text.encode(this.color.itemBackground)}}return{}}},template:`\n\t  \t<div class="crm-timeline__card-wrapper">\n\t\t\t<div class="crm-timeline__card_icon_container">\n\t\t\t\t<Icon v-bind="layout.icon"></Icon>\n\t\t\t</div>\n\t\t\t<div \n\t\t\t\t:data-id="id" \n\t\t\t\tref="timelineCard" \n\t\t\t\t:class="timelineCardClassname"\n\t\t\t\t:style="timelineCardStyle"\n\t\t\t>\n\t\t\t\t<div class="crm-timeline__card_fade" v-if="isFaded"></div>\n\t\t\t\t<Header \n\t\t\t\t\tv-if="layout.header"\n\t\t\t\t\tv-bind="layout.header"\n\t\t\t\t\t:use-short-time-format="useShortTimeFormat"\n\t\t\t\t\tref="header"\n\t\t\t\t/>\n\t\t\t\t<Body v-if="layout.body" v-bind="layout.body" ref="body"></Body>\n\t\t\t\t<Footer v-if="layout.footer" v-bind="layout.footer" ref="footer"></Footer>\n\t\t\t\t<MarketPanel v-if="layout.marketPanel" v-bind="layout.marketPanel"></MarketPanel>\n\t\t\t</div>\n\t\t</div>\n\t`};function _classPrivateFieldInitSpec$3(e,t,i){_checkPrivateRedeclaration$3(e,t);t.set(e,i)}function _checkPrivateRedeclaration$3(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classStaticPrivateFieldSpecGet(e,t,i){_classCheckPrivateStaticAccess(e,t);_classCheckPrivateStaticFieldDescriptor(i,"get");return _classApplyDescriptorGet(e,i)}function _classCheckPrivateStaticFieldDescriptor(e,t){if(e===undefined){throw new TypeError("attempted to "+t+" private static field before its declaration")}}function _classCheckPrivateStaticAccess(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function _classApplyDescriptorGet(e,t){if(t.get){return t.get.call(e)}return t.value}var _id=new WeakMap;let ControllerManager=function(){function e(t){babelHelpers.classCallCheck(this,e);_classPrivateFieldInitSpec$3(this,_id,{writable:true,value:null});babelHelpers.classPrivateFieldSet(this,_id,t)}babelHelpers.createClass(e,[{key:"getItemControllers",value:function t(i){const s=[];for(const t of e.getRegisteredControllers()){if(t.isItemSupported(i)){const e=new t;e.onInitialize(i);s.push(e)}}return s}}],[{key:"getInstance",value:function t(i){if(!_classStaticPrivateFieldSpecGet(this,e,_instances).hasOwnProperty(i)){_classStaticPrivateFieldSpecGet(this,e,_instances)[i]=new e(i)}return _classStaticPrivateFieldSpecGet(this,e,_instances)[i]}},{key:"registerController",value:function t(i){_classStaticPrivateFieldSpecGet(this,e,_availableControllers).push(i)}},{key:"getRegisteredControllers",value:function t(){return _classStaticPrivateFieldSpecGet(this,e,_availableControllers)}}]);return e}();var _instances={writable:true,value:{}};var _availableControllers={writable:true,value:[]};let Base=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"getDeleteActionMethod",value:function e(){return""}},{key:"getDeleteActionCfg",value:function e(t,i,s){return{data:{recordId:t,ownerTypeId:i,ownerId:s}}}},{key:"onInitialize",value:function e(t){}},{key:"onItemAction",value:function e(t,i){}},{key:"getContentBlockComponents",value:function e(t){return{}}},{key:"onAfterItemRefreshLayout",value:function e(t){}},{key:"onAfterItemLayout",value:function e(t,i){}},{key:"onBeforeItemClearLayout",value:function e(t){}},{key:"runDeleteAction",value:function e(t,i,s,n){if(n.onStart){n.onStart()}return main_core.ajax.runAction(this.getDeleteActionMethod(),this.getDeleteActionCfg(t,i,s)).then((()=>{if(n.onStop){n.onStop()}return true}),(e=>{ui_notification.UI.Notification.Center.notify({content:e.errors[0].message,autoHideDelay:5e3});if(n.onStop){n.onStop()}return true}))}},{key:"runScheduleAction",value:function e(t,i){var s,n,a;const r=(s=BX.Crm)===null||s===void 0?void 0:(n=s.Timeline)===null||n===void 0?void 0:(a=n.MenuBar)===null||a===void 0?void 0:a.getDefault();if(r){r.setActiveItemById("todo");const e=r.getItemById("todo");e.focus();e.setParentActivityId(t);e.setDeadLine(i)}}}],[{key:"isItemSupported",value:function e(t){return false}}]);return e}();let Item$3=function(){function e(){babelHelpers.classCallCheck(this,e);this._id="";this._isTerminated=false;this._wrapper=null}babelHelpers.createClass(e,[{key:"getId",value:function e(){return this._id}},{key:"_setId",value:function e(t){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4)}},{key:"setData",value:function e(t){throw new Error("Item.setData() must be overridden")}},{key:"layout",value:function e(t){throw new Error("Item.layout() must be overridden")}},{key:"refreshLayout",value:function e(){const t=this._wrapper.previousSibling;this.clearLayout();this.layout({anchor:t})}},{key:"clearLayout",value:function e(){main_core.Dom.remove(this._wrapper);this._wrapper=undefined}},{key:"destroy",value:function e(){this.clearLayout()}},{key:"getWrapper",value:function e(){return this._wrapper}},{key:"setWrapper",value:function e(t){this._wrapper=t}},{key:"addWrapperClass",value:function e(t,i){if(!this._wrapper){return}main_core.Dom.addClass(this._wrapper,t);if(main_core.Type.isNumber(i)&&i>=0){window.setTimeout(this.removeWrapperClass.bind(this,t),i)}}},{key:"removeWrapperClass",value:function e(t,i){if(!this._wrapper){return}main_core.Dom.removeClass(this._wrapper,t);if(main_core.Type.isNumber(i)&&i>=0){window.setTimeout(this.addWrapperClass.bind(this,t),i)}}},{key:"isTerminated",value:function e(){return this._isTerminated}},{key:"markAsTerminated",value:function e(t){t=!!t;if(this._isTerminated===t){return}this._isTerminated=t;if(!this._wrapper){return}if(t){main_core.Dom.addClass(this._wrapper,"crm-entity-stream-section-last")}else{main_core.Dom.removeClass(this._wrapper,"crm-entity-stream-section-last")}}},{key:"getAssociatedEntityTypeId",value:function e(){return null}},{key:"getAssociatedEntityId",value:function e(){return null}}]);return e}();function _classPrivateFieldInitSpec$4(e,t,i){_checkPrivateRedeclaration$4(e,t);t.set(e,i)}function _checkPrivateRedeclaration$4(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var _layout=new WeakMap;let Layout=function(){function e(t){babelHelpers.classCallCheck(this,e);_classPrivateFieldInitSpec$4(this,_layout,{writable:true,value:null});babelHelpers.classPrivateFieldSet(this,_layout,t)}babelHelpers.createClass(e,[{key:"asPlainObject",value:function e(){return main_core.Runtime.clone(babelHelpers.classPrivateFieldGet(this,_layout))}},{key:"getFooterMenuItemById",value:function e(t){var i,s,n,a;const r=(i=(s=babelHelpers.classPrivateFieldGet(this,_layout))===null||s===void 0?void 0:(n=s.footer)===null||n===void 0?void 0:(a=n.menu)===null||a===void 0?void 0:a.items)!==null&&i!==void 0?i:{};return r.hasOwnProperty(t)?r.id:null}},{key:"addFooterMenuItem",value:function e(t){babelHelpers.classPrivateFieldGet(this,_layout).footer=babelHelpers.classPrivateFieldGet(this,_layout).footer||{};babelHelpers.classPrivateFieldGet(this,_layout).footer.menu=babelHelpers.classPrivateFieldGet(this,_layout).footer.menu||{};babelHelpers.classPrivateFieldGet(this,_layout).footer.menu.items=babelHelpers.classPrivateFieldGet(this,_layout).footer.menu.items||{};babelHelpers.classPrivateFieldGet(this,_layout).footer.menu.items[t.id]=t}}]);return e}();function _classPrivateMethodInitSpec$2(e,t){_checkPrivateRedeclaration$5(e,t);t.add(e)}function _classPrivateFieldInitSpec$5(e,t,i){_checkPrivateRedeclaration$5(e,t);t.set(e,i)}function _checkPrivateRedeclaration$5(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$2(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var _container=new WeakMap;var _itemClassName=new WeakMap;var _type$1=new WeakMap;var _dataPayload=new WeakMap;var _timelineId=new WeakMap;var _timestamp=new WeakMap;var _sort=new WeakMap;var _useShortTimeFormat=new WeakMap;var _isReadOnly=new WeakMap;var _currentUser=new WeakMap;var _ownerTypeId=new WeakMap;var _ownerId=new WeakMap;var _controllers=new WeakMap;var _layoutComponent=new WeakMap;var _layoutApp=new WeakMap;var _layout$1=new WeakMap;var _streamType=new WeakMap;var _color=new WeakMap;var _useAnchorNextSibling=new WeakSet;var _initLayoutApp=new WeakSet;var _getLayoutAppProps=new WeakSet;var _onLayoutAppAction=new WeakSet;var _getContentBlockComponents=new WeakSet;let ConfigurableItem=function(e){babelHelpers.inherits(t,e);function t(...e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,...e));_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(i),_getContentBlockComponents);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(i),_onLayoutAppAction);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(i),_getLayoutAppProps);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(i),_initLayoutApp);_classPrivateMethodInitSpec$2(babelHelpers.assertThisInitialized(i),_useAnchorNextSibling);_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_container,{writable:true,value:null});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_itemClassName,{writable:true,value:null});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_type$1,{writable:true,value:null});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_dataPayload,{writable:true,value:null});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_timelineId,{writable:true,value:null});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_timestamp,{writable:true,value:null});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_sort,{writable:true,value:null});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_useShortTimeFormat,{writable:true,value:false});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_isReadOnly,{writable:true,value:false});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_currentUser,{writable:true,value:null});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_ownerTypeId,{writable:true,value:null});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_ownerId,{writable:true,value:null});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_controllers,{writable:true,value:null});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_layoutComponent,{writable:true,value:null});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_layoutApp,{writable:true,value:null});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_layout$1,{writable:true,value:null});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_streamType,{writable:true,value:null});_classPrivateFieldInitSpec$5(babelHelpers.assertThisInitialized(i),_color,{writable:true,value:null});return i}babelHelpers.createClass(t,[{key:"initialize",value:function e(t,i){this._setId(t);i=i||{};babelHelpers.classPrivateFieldSet(this,_timelineId,i.timelineId||"");this.setContainer(i.container||null);babelHelpers.classPrivateFieldSet(this,_itemClassName,i.itemClassName||"");if(main_core.Type.isPlainObject(i.data)){this.setData(i.data);babelHelpers.classPrivateFieldSet(this,_useShortTimeFormat,i.useShortTimeFormat||false);babelHelpers.classPrivateFieldSet(this,_isReadOnly,i.isReadOnly||false);babelHelpers.classPrivateFieldSet(this,_currentUser,i.currentUser||null);babelHelpers.classPrivateFieldSet(this,_ownerTypeId,i.ownerTypeId);babelHelpers.classPrivateFieldSet(this,_ownerId,i.ownerId);babelHelpers.classPrivateFieldSet(this,_streamType,i.streamType||crm_timeline_item.StreamType.history)}babelHelpers.classPrivateFieldSet(this,_controllers,ControllerManager.getInstance(babelHelpers.classPrivateFieldGet(this,_timelineId)).getItemControllers(this))}},{key:"setData",value:function e(t){var i;babelHelpers.classPrivateFieldSet(this,_type$1,t.type||null);babelHelpers.classPrivateFieldSet(this,_timestamp,t.timestamp||null);babelHelpers.classPrivateFieldSet(this,_sort,t.sort||[]);babelHelpers.classPrivateFieldSet(this,_layout$1,new Layout(t.layout||{}));babelHelpers.classPrivateFieldSet(this,_dataPayload,t.payload||{});babelHelpers.classPrivateFieldSet(this,_color,(i=t.color)!==null&&i!==void 0?i:null)}},{key:"getColor",value:function e(){return babelHelpers.classPrivateFieldGet(this,_color)}},{key:"getLayout",value:function e(){return babelHelpers.classPrivateFieldGet(this,_layout$1)}},{key:"getType",value:function e(){return babelHelpers.classPrivateFieldGet(this,_type$1)}},{key:"getDataPayload",value:function e(){return babelHelpers.classPrivateFieldGet(this,_dataPayload)}},{key:"layout",value:function e(t){this.setWrapper(main_core.Dom.create({tag:"div",attrs:{className:babelHelpers.classPrivateFieldGet(this,_itemClassName)}}));this.initLayoutApp(t)}},{key:"initWrapper",value:function e(){this.setWrapper(main_core.Dom.create({tag:"div",attrs:{className:babelHelpers.classPrivateFieldGet(this,_itemClassName)}}));return this._wrapper}},{key:"initLayoutApp",value:function e(t){_classPrivateMethodGet$2(this,_initLayoutApp,_initLayoutApp2).call(this);if(this.needBindToContainer(t)){const e=this.getBindToNode(t);if(e&&!_classPrivateMethodGet$2(this,_useAnchorNextSibling,_useAnchorNextSibling2).call(this,t)){main_core.Dom.insertBefore(this.getWrapper(),e)}else if(e&&e.nextSibling){main_core.Dom.insertBefore(this.getWrapper(),e.nextSibling)}else{main_core.Dom.append(this.getWrapper(),babelHelpers.classPrivateFieldGet(this,_container))}}for(const e of babelHelpers.classPrivateFieldGet(this,_controllers)){e.onAfterItemLayout(this,t)}}},{key:"needBindToContainer",value:function e(t){if(main_core.Type.isPlainObject(t)){return BX.prop.getBoolean(t,"add",true)}return true}},{key:"getBindToNode",value:function e(t){if(main_core.Type.isPlainObject(t)){return main_core.Type.isElementNode(t["anchor"])?t["anchor"]:null}return null}},{key:"refreshLayout",value:function e(){if(babelHelpers.classPrivateFieldGet(this,_layoutComponent)){babelHelpers.classPrivateFieldGet(this,_layoutComponent).setColor(this.getColor());babelHelpers.classPrivateFieldGet(this,_layoutComponent).setLayout(this.getLayout().asPlainObject());for(const e of babelHelpers.classPrivateFieldGet(this,_controllers)){e.onAfterItemRefreshLayout(this)}babelHelpers.classPrivateFieldGet(this,_layoutComponent).showLoader(false)}else{babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"refreshLayout",this).call(this)}}},{key:"getLayoutComponent",value:function e(){return babelHelpers.classPrivateFieldGet(this,_layoutComponent)}},{key:"forceRefreshLayout",value:function e(){var t;const i=(t=this.getWrapper())===null||t===void 0?void 0:t.nextSibling;this.clearLayout();this.layout({anchor:i,useAnchorNextSibling:false})}},{key:"getLayoutContentBlockById",value:function e(t){var i;return(i=babelHelpers.classPrivateFieldGet(this,_layoutComponent))===null||i===void 0?void 0:i.getContentBlockById(t)}},{key:"getLogo",value:function e(){var t;return(t=babelHelpers.classPrivateFieldGet(this,_layoutComponent))===null||t===void 0?void 0:t.getLogo()}},{key:"getLayoutFooterButtonById",value:function e(t){var i;return(i=babelHelpers.classPrivateFieldGet(this,_layoutComponent))===null||i===void 0?void 0:i.getFooterButtonById(t)}},{key:"getLayoutFooterMenu",value:function e(){var t;return(t=babelHelpers.classPrivateFieldGet(this,_layoutComponent))===null||t===void 0?void 0:t.getFooterMenu()}},{key:"getLayoutHeaderChangeStreamButton",value:function e(){var t;return(t=babelHelpers.classPrivateFieldGet(this,_layoutComponent))===null||t===void 0?void 0:t.getHeaderChangeStreamButton()}},{key:"highlightContentBlockById",value:function e(t,i){var s;(s=babelHelpers.classPrivateFieldGet(this,_layoutComponent))===null||s===void 0?void 0:s.highlightContentBlockById(t,i)}},{key:"clearLayout",value:function e(){for(const e of babelHelpers.classPrivateFieldGet(this,_controllers)){e.onBeforeItemClearLayout(this)}babelHelpers.classPrivateFieldGet(this,_layoutApp).unmount();babelHelpers.classPrivateFieldSet(this,_layoutApp,null);babelHelpers.classPrivateFieldSet(this,_layoutComponent,null);babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"clearLayout",this).call(this)}},{key:"getCreatedDate",value:function e(){const t=babelHelpers.classPrivateFieldGet(this,_timestamp)?babelHelpers.classPrivateFieldGet(this,_timestamp):Date.now()/1e3;return BX.prop.extractDate(crm_timeline_tools.DatetimeConverter.createFromServerTimestamp(t).toUserTime().getValue())}},{key:"getSourceId",value:function e(){let t=this.getId();if(!main_core.Type.isInteger(t)){t=main_core.Text.toInteger(t.replace(/^\D+/g,""))}return t}},{key:"setContainer",value:function e(t){babelHelpers.classPrivateFieldSet(this,_container,t)}},{key:"getContainer",value:function e(){return babelHelpers.classPrivateFieldGet(this,_container)}},{key:"getDeadline",value:function e(){if(!babelHelpers.classPrivateFieldGet(this,_timestamp)){return null}return crm_timeline_tools.DatetimeConverter.createFromServerTimestamp(babelHelpers.classPrivateFieldGet(this,_timestamp)).toUserTime().getValue()}},{key:"getSort",value:function e(){return babelHelpers.classPrivateFieldGet(this,_sort)}},{key:"isReadOnly",value:function e(){return babelHelpers.classPrivateFieldGet(this,_isReadOnly)}},{key:"getCurrentUser",value:function e(){return babelHelpers.classPrivateFieldGet(this,_currentUser)}},{key:"clone",value:function e(){return t.create(this.getId(),{timelineId:babelHelpers.classPrivateFieldGet(this,_timelineId),container:this.getContainer(),itemClassName:babelHelpers.classPrivateFieldGet(this,_itemClassName),useShortTimeFormat:babelHelpers.classPrivateFieldGet(this,_useShortTimeFormat),isReadOnly:babelHelpers.classPrivateFieldGet(this,_isReadOnly),currentUser:babelHelpers.classPrivateFieldGet(this,_currentUser),streamType:babelHelpers.classPrivateFieldGet(this,_streamType),data:{type:babelHelpers.classPrivateFieldGet(this,_type$1),timestamp:babelHelpers.classPrivateFieldGet(this,_timestamp),sort:babelHelpers.classPrivateFieldGet(this,_sort),layout:this.getLayout().asPlainObject()}})}},{key:"reloadFromServer",value:function e(t=false){const i={ownerTypeId:babelHelpers.classPrivateFieldGet(this,_ownerTypeId),ownerId:babelHelpers.classPrivateFieldGet(this,_ownerId)};if(babelHelpers.classPrivateFieldGet(this,_streamType)===crm_timeline_item.StreamType.history||babelHelpers.classPrivateFieldGet(this,_streamType)===crm_timeline_item.StreamType.pinned){i.historyIds=[this.getId()]}else if(babelHelpers.classPrivateFieldGet(this,_streamType)===crm_timeline_item.StreamType.scheduled){i.activityIds=[this.getId()]}else{throw new Error("Wrong stream type")}return main_core.ajax.runAction("crm.timeline.item.load",{data:i}).then((e=>{Object.values(e.data).forEach((e=>{if(e.id===this.getId()){this.setData(e);if(t){this.forceRefreshLayout()}else{this.refreshLayout()}}}));return true})).catch((e=>{console.error(e);return true}))}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Item$3);function _useAnchorNextSibling2(e){if(main_core.Type.isPlainObject(e)){return main_core.Type.isBoolean(e["useAnchorNextSibling"])?e["useAnchorNextSibling"]:true}return true}function _initLayoutApp2(){if(!babelHelpers.classPrivateFieldGet(this,_layoutApp)){babelHelpers.classPrivateFieldSet(this,_layoutApp,ui_vue3.BitrixVue.createApp(Item$2,_classPrivateMethodGet$2(this,_getLayoutAppProps,_getLayoutAppProps2).call(this)));const e=_classPrivateMethodGet$2(this,_getContentBlockComponents,_getContentBlockComponents2).call(this);for(const t in e){babelHelpers.classPrivateFieldGet(this,_layoutApp).component(t,e[t])}babelHelpers.classPrivateFieldSet(this,_layoutComponent,babelHelpers.classPrivateFieldGet(this,_layoutApp).mount(this.getWrapper()))}}function _getLayoutAppProps2(){return{initialLayout:this.getLayout().asPlainObject(),initialColor:babelHelpers.classPrivateFieldGet(this,_streamType)===crm_timeline_item.StreamType.scheduled?babelHelpers.classPrivateFieldGet(this,_color):null,id:String(this.getId()),useShortTimeFormat:babelHelpers.classPrivateFieldGet(this,_useShortTimeFormat),isReadOnly:this.isReadOnly(),currentUser:this.getCurrentUser(),streamType:babelHelpers.classPrivateFieldGet(this,_streamType),onAction:_classPrivateMethodGet$2(this,_onLayoutAppAction,_onLayoutAppAction2).bind(this)}}function _onLayoutAppAction2(e){for(const t of babelHelpers.classPrivateFieldGet(this,_controllers)){t.onItemAction(this,e)}}function _getContentBlockComponents2(){let e={};for(const t of babelHelpers.classPrivateFieldGet(this,_controllers)){e=Object.assign(e,t.getContentBlockComponents(this))}return e}let _$1=e=>e,_t$1;function _classPrivateMethodInitSpec$3(e,t){_checkPrivateRedeclaration$6(e,t);t.add(e)}function _classPrivateFieldInitSpec$6(e,t,i){_checkPrivateRedeclaration$6(e,t);t.set(e,i)}function _checkPrivateRedeclaration$6(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$3(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var _startPosition=new WeakMap;var _node$1=new WeakMap;var _anchor=new WeakMap;var _areAnimatedItemsVisible=new WeakMap;var _id$1=new WeakMap;var _initialItem=new WeakMap;var _finalItem=new WeakMap;var _events=new WeakMap;var _settings=new WeakMap;var _stub=new WeakMap;var _prepareInitialItemBeforeShift=new WeakSet;var _prepareFinalItemBeforeShift=new WeakSet;var _replaceInitialWithFinal=new WeakSet;var _makeNodeAbsoluteWithSavePosition=new WeakSet;var _makeNodeStatic=new WeakSet;var _isNodeVisible$1=new WeakSet;let ItemNew=function(){function e(){babelHelpers.classCallCheck(this,e);_classPrivateMethodInitSpec$3(this,_isNodeVisible$1);_classPrivateMethodInitSpec$3(this,_makeNodeStatic);_classPrivateMethodInitSpec$3(this,_makeNodeAbsoluteWithSavePosition);_classPrivateMethodInitSpec$3(this,_replaceInitialWithFinal);_classPrivateMethodInitSpec$3(this,_prepareFinalItemBeforeShift);_classPrivateMethodInitSpec$3(this,_prepareInitialItemBeforeShift);_classPrivateFieldInitSpec$6(this,_startPosition,{writable:true,value:void 0});_classPrivateFieldInitSpec$6(this,_node$1,{writable:true,value:void 0});_classPrivateFieldInitSpec$6(this,_anchor,{writable:true,value:void 0});_classPrivateFieldInitSpec$6(this,_areAnimatedItemsVisible,{writable:true,value:void 0});_classPrivateFieldInitSpec$6(this,_id$1,{writable:true,value:void 0});_classPrivateFieldInitSpec$6(this,_initialItem,{writable:true,value:void 0});_classPrivateFieldInitSpec$6(this,_finalItem,{writable:true,value:void 0});_classPrivateFieldInitSpec$6(this,_events,{writable:true,value:void 0});_classPrivateFieldInitSpec$6(this,_settings,{writable:true,value:void 0});_classPrivateFieldInitSpec$6(this,_stub,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,_id$1,"");babelHelpers.classPrivateFieldSet(this,_settings,{});babelHelpers.classPrivateFieldSet(this,_initialItem,null);babelHelpers.classPrivateFieldSet(this,_finalItem,null);babelHelpers.classPrivateFieldSet(this,_events,null);babelHelpers.classPrivateFieldSet(this,_areAnimatedItemsVisible,false)}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){babelHelpers.classPrivateFieldSet(this,_id$1,main_core.Type.isStringFilled(t)?t:BX.util.getRandomString(4));babelHelpers.classPrivateFieldSet(this,_settings,i||{});babelHelpers.classPrivateFieldSet(this,_initialItem,this.getSetting("initialItem"));babelHelpers.classPrivateFieldSet(this,_finalItem,this.getSetting("finalItem"));babelHelpers.classPrivateFieldSet(this,_anchor,this.getSetting("anchor"));babelHelpers.classPrivateFieldSet(this,_events,this.getSetting("events",{}));babelHelpers.classPrivateFieldSet(this,_node$1,babelHelpers.classPrivateFieldGet(this,_initialItem).getWrapper())}},{key:"getId",value:function e(){return babelHelpers.classPrivateFieldGet(this,_id$1)}},{key:"getSetting",value:function e(t,i){return Object.hasOwn(babelHelpers.classPrivateFieldGet(this,_settings),t)?babelHelpers.classPrivateFieldGet(this,_settings)[t]:i}},{key:"addHistoryItem",value:function e(){if(babelHelpers.classPrivateFieldGet(this,_finalItem).getWrapper()===null&&!(babelHelpers.classPrivateFieldGet(this,_finalItem)instanceof CompatibleItem)){babelHelpers.classPrivateFieldGet(this,_finalItem).initWrapper();babelHelpers.classPrivateFieldGet(this,_finalItem).initLayoutApp({add:false})}main_core.Dom.style(babelHelpers.classPrivateFieldGet(this,_anchor),{height:0});_classPrivateMethodGet$3(this,_makeNodeStatic,_makeNodeStatic2).call(this,babelHelpers.classPrivateFieldGet(this,_finalItem).getWrapper());main_core.Dom.insertBefore(babelHelpers.classPrivateFieldGet(this,_finalItem).getWrapper(),babelHelpers.classPrivateFieldGet(this,_anchor).nextSibling);requestAnimationFrame((()=>{main_core.Dom.style(babelHelpers.classPrivateFieldGet(this,_finalItem).getWrapper(),{opacity:1})}))}},{key:"run",value:function e(){babelHelpers.classPrivateFieldSet(this,_areAnimatedItemsVisible,_classPrivateMethodGet$3(this,_isNodeVisible$1,_isNodeVisible2$1).call(this,babelHelpers.classPrivateFieldGet(this,_node$1)));if(babelHelpers.classPrivateFieldGet(this,_areAnimatedItemsVisible)===false){this.finish();return}_classPrivateMethodGet$3(this,_prepareInitialItemBeforeShift,_prepareInitialItemBeforeShift2).call(this);_classPrivateMethodGet$3(this,_prepareFinalItemBeforeShift,_prepareFinalItemBeforeShift2).call(this);setTimeout((()=>{this.shiftAndReplaceInitialWithFinal();this.collapseStub()}),300)}},{key:"collapseStub",value:function e(){main_core.bindOnce(babelHelpers.classPrivateFieldGet(this,_stub),"transitionend",(()=>{main_core.Dom.remove(babelHelpers.classPrivateFieldGet(this,_stub))}));main_core.Dom.style(babelHelpers.classPrivateFieldGet(this,_stub),{height:0,margin:0})}},{key:"shift",value:function e(){const e=Shift.create(babelHelpers.classPrivateFieldGet(this,_node$1),babelHelpers.classPrivateFieldGet(this,_anchor),babelHelpers.classPrivateFieldGet(this,_startPosition),babelHelpers.classPrivateFieldGet(this,_stub),{complete:this.finish.bind(this)});e.run();const t=main_core.Dom.getPosition(babelHelpers.classPrivateFieldGet(this,_finalItem).getWrapper()).height-babelHelpers.classPrivateFieldGet(this,_startPosition).height;const i=Shift.create(babelHelpers.classPrivateFieldGet(this,_finalItem).getWrapper(),babelHelpers.classPrivateFieldGet(this,_anchor),main_core.Dom.getPosition(babelHelpers.classPrivateFieldGet(this,_finalItem).getWrapper()),undefined,undefined,t+1);i.run()}},{key:"shiftAndReplaceInitialWithFinal",value:function e(){this.shift();setTimeout((()=>{_classPrivateMethodGet$3(this,_replaceInitialWithFinal,_replaceInitialWithFinal2).call(this)}),100)}},{key:"addStubForInitialItem",value:function e(t){const i=babelHelpers.classPrivateFieldGet(this,_initialItem).getWrapper();babelHelpers.classPrivateFieldSet(this,_stub,main_core.Tag.render(_t$1||(_t$1=_$1`
			<div class="crm-entity-stream-section crm-entity-stream-section-planned crm-entity-stream-section-shadow">
				<div
					class="crm-entity-stream-section-content"
					style="height: ${0}px;"
				></div>
			</div>
		`),i.clientHeight));const s=main_core.Dom.getPosition(i).height;main_core.Dom.style(babelHelpers.classPrivateFieldGet(this,_stub),{height:`${s}px`,margin:getComputedStyle(i).margin,animation:"none",transition:"height 0.2s ease-in-out"});main_core.Dom.insertBefore(babelHelpers.classPrivateFieldGet(this,_stub),t)}},{key:"finish",value:function e(){if(babelHelpers.classPrivateFieldGet(this,_areAnimatedItemsVisible)){main_core.Dom.removeClass(babelHelpers.classPrivateFieldGet(this,_node$1),"crm-entity-stream-section-animate-start")}setTimeout((()=>{babelHelpers.classPrivateFieldGet(this,_initialItem).clearLayout();main_core.Dom.remove(babelHelpers.classPrivateFieldGet(this,_node$1));this.addHistoryItem();if(main_core.Type.isFunction(babelHelpers.classPrivateFieldGet(this,_events).complete)){babelHelpers.classPrivateFieldGet(this,_events).complete()}}),500)}}],[{key:"create",value:function t(i,s){const n=new e;n.initialize(i,s);return n}}]);return e}();function _prepareInitialItemBeforeShift2(){main_core.Dom.addClass(babelHelpers.classPrivateFieldGet(this,_node$1),"crm-entity-stream-section-animate-start");babelHelpers.classPrivateFieldSet(this,_startPosition,main_core.Dom.getPosition(babelHelpers.classPrivateFieldGet(this,_node$1)));_classPrivateMethodGet$3(this,_makeNodeAbsoluteWithSavePosition,_makeNodeAbsoluteWithSavePosition2).call(this,babelHelpers.classPrivateFieldGet(this,_node$1));this.addStubForInitialItem(babelHelpers.classPrivateFieldGet(this,_node$1));main_core.Dom.append(babelHelpers.classPrivateFieldGet(this,_node$1),document.body)}function _prepareFinalItemBeforeShift2(){if(!(babelHelpers.classPrivateFieldGet(this,_finalItem)instanceof CompatibleItem)){babelHelpers.classPrivateFieldGet(this,_finalItem).initWrapper();babelHelpers.classPrivateFieldGet(this,_finalItem).initLayoutApp({add:false})}main_core.Dom.style(babelHelpers.classPrivateFieldGet(this,_finalItem).getWrapper(),"opacity",0);main_core.Dom.append(babelHelpers.classPrivateFieldGet(this,_finalItem).getWrapper(),document.body);requestAnimationFrame((()=>{_classPrivateMethodGet$3(this,_makeNodeAbsoluteWithSavePosition,_makeNodeAbsoluteWithSavePosition2).call(this,babelHelpers.classPrivateFieldGet(this,_finalItem).getWrapper(),babelHelpers.classPrivateFieldGet(this,_startPosition))}))}function _replaceInitialWithFinal2(){main_core.Dom.style(babelHelpers.classPrivateFieldGet(this,_node$1),"opacity",0);main_core.Dom.style(babelHelpers.classPrivateFieldGet(this,_finalItem).getWrapper(),"opacity",.5)}function _makeNodeAbsoluteWithSavePosition2(e,t){const i=main_core.Dom.getPosition(e);const s=t||i;main_core.Dom.style(e,{position:"absolute",width:`${s.width}px`,height:`${i.height}px`,top:`${s.top}px`,left:`${s.left}px`,zIndex:960})}function _makeNodeStatic2(e){main_core.Dom.style(e,{position:null,width:null,height:null,top:null,left:null})}function _isNodeVisible2$1(e){const t=main_core.Dom.getPosition(e);return e.offsetParent!==null&&t.height>0&&t.width>0}let Steam=function(){function e(){babelHelpers.classCallCheck(this,e);this._id="";this._settings={};this._container=null;this._manager=null;this._activityEditor=null;this._timeFormat="";this._year=0;this._isStubMode=false;this._userId=0;this._readOnly=false;this._streamType=crm_timeline_item.StreamType.history;this._anchor=null;this._serviceUrl=""}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._container=BX(this.getSetting("container"));if(!BX.type.isElementNode(this._container)){throw"Timeline. Container node is not found."}this._editorContainer=BX(this.getSetting("editorContainer"));this._manager=this.getSetting("manager");if(!(this._manager instanceof Manager)){throw"Timeline. Manager instance is not found."}const s=BX.message("FORMAT_DATETIME").replace(/:SS/,"");const n=BX.message("FORMAT_DATE");this._timeFormat=BX.date.convertBitrixFormat(BX.util.trim(s.replace(n,"")));this._year=(new Date).getFullYear();this._activityEditor=this.getSetting("activityEditor");this._isStubMode=BX.prop.getBoolean(this._settings,"isStubMode",false);this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);this._userId=BX.prop.getInteger(this._settings,"userId",0);this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this.doInitialize()}},{key:"getId",value:function e(){return this._id}},{key:"isScheduleStream",value:function e(){return this.getStreamType()===crm_timeline_item.StreamType.scheduled}},{key:"isFixedHistoryStream",value:function e(){return this.getStreamType()===crm_timeline_item.StreamType.pinned}},{key:"isHistoryStream",value:function e(){return this.getStreamType()===crm_timeline_item.StreamType.history}},{key:"getSetting",value:function e(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i}},{key:"doInitialize",value:function e(){}},{key:"layout",value:function e(){}},{key:"isStubMode",value:function e(){return this._isStubMode}},{key:"isReadOnly",value:function e(){return this._readOnly}},{key:"getUserId",value:function e(){return this._userId}},{key:"getServiceUrl",value:function e(){return this._serviceUrl}},{key:"getAnchor",value:function e(){return this._anchor}},{key:"getStreamType",value:function e(){return this._streamType}},{key:"refreshLayout",value:function e(){}},{key:"getManager",value:function e(){return this._manager}},{key:"getOwnerInfo",value:function e(){return this._manager.getOwnerInfo()}},{key:"reload",value:function e(){const t=this.getSetting("currentUrl");const i=this.getSetting("ajaxId");if(i!==""){BX.ajax.insertToNode(BX.util.add_url_param(t,{bxajaxid:i}),"comp_"+i)}else{window.location=t}}},{key:"getUserTimezoneOffset",value:function e(){return main_date.Timezone.Offset.USER_TO_SERVER}},{key:"getServerTimezoneOffset",value:function e(){return main_date.Timezone.Offset.SERVER_TO_UTC}},{key:"formatTime",value:function e(t,i,s){return main_date.DateTimeFormat.format(this._timeFormat,t,i,s)}},{key:"formatDate",value:function e(t){return main_date.DateTimeFormat.format([["today","today"],["tommorow","tommorow"],["yesterday","yesterday"],["",t.getFullYear()===this._year?main_date.DateTimeFormat.getFormat("DAY_MONTH_FORMAT"):main_date.DateTimeFormat.getFormat("LONG_DATE_FORMAT")]],t)}},{key:"cutOffText",value:function e(t,i){if(!BX.type.isNumber(i)){i=0}if(i<=0||t.length<=i){return t}let s=i-1;const n=t.substring(s).search(/\s/i);if(n>0){s+=n}return t.substring(0,s)+"..."}},{key:"getItems",value:function e(){return[]}},{key:"setItems",value:function e(t){throw new Error("Stream.setItems() must be overridden")}},{key:"getLastItem",value:function e(){const t=this.getItems();return t.length>0?t[t.length-1]:null}},{key:"findItemById",value:function e(t){t=t.toString();return this.getItems().find((e=>e.getId()===t))||null}},{key:"getItemIndex",value:function e(t){return this.getItems().findIndex((e=>e===t))}},{key:"removeItemByIndex",value:function e(t){const i=this.getItems();if(t<i.length){i.splice(t,1);this.setItems(i)}}},{key:"createItem",value:function e(t){throw new Error("Stream.createItem() must be overridden")}},{key:"createItemCopy",value:function e(t){if(t instanceof crm_timeline_item.ConfigurableItem){return t.clone()}return this.createItem(t.getData())}},{key:"refreshItem",value:function e(t,i=true,s){const n=this.getItemIndex(t);if(n<0){return Promise.resolve()}this.removeItemByIndex(n);let a=false;let r=0;let o;if(this.isScheduleStream()){o=this.createItemCopy(t);r=this.calculateItemIndex(o);a=r!==n}if(!a){this.addItem(t,r);t.refreshLayout();if(i){return this.animateItemAdding(t)}return Promise.resolve()}const l=this.createAnchor(r);this.addItem(o,r);if(s){o.layout({add:false});return new Promise((e=>{const i=Item$1.create("",{initialItem:t,finalItem:o,anchor:l,events:{complete:()=>{t.destroy();e()}}});i.run()}))}else{o.layout({anchor:l});t.destroy();return Promise.resolve()}}},{key:"calculateItemIndex",value:function e(t){return 0}},{key:"createAnchor",value:function e(t){return null}},{key:"addItem",value:function e(t,i){throw new Error("Stream.addItem() must be overridden")}},{key:"deleteItem",value:function e(t){throw new Error("Stream.deleteItem() must be overridden")}},{key:"deleteItemAnimated",value:function e(t){if(!main_core.Type.isDomNode(t.getWrapper())){this.deleteItem(t);return Promise.resolve()}return new Promise((e=>{const i=main_core.Dom.getPosition(t.getWrapper());if(main_core.Dom.hasClass(t.getWrapper(),"crm-entity-stream-section-planned")){main_core.Dom.style(t.getWrapper(),{animation:"none",opacity:1})}const s=new BX.easing({duration:1e3,start:{height:i.height,opacity:1,marginBottom:15},finish:{height:0,opacity:0,marginBottom:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:e=>{main_core.Dom.style(t.getWrapper(),{height:e.height+"px",opacity:e.opacity,marginBottom:e.marginBottom})},complete:()=>{this.deleteItem(t);e()}});s.animate()}))}},{key:"moveItemToStream",value:function e(t,i,s){this.removeItemByIndex(this.getItemIndex(t));if(this.getItems().length>0){this.refreshLayout()}return new Promise((e=>{const n=ItemNew.create("",{initialItem:t,finalItem:s,anchor:i.createAnchor(),events:{complete:()=>{this.refreshLayout();i.refreshLayout();e()}}});n.run()}))}},{key:"animateItemAdding",value:function e(t){return Promise.resolve()}}]);return e}();function _classPrivateMethodInitSpec$4(e,t){_checkPrivateRedeclaration$7(e,t);t.add(e)}function _classPrivateFieldInitSpec$7(e,t,i){_checkPrivateRedeclaration$7(e,t);t.set(e,i)}function _checkPrivateRedeclaration$7(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classPrivateMethodGet$4(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var _scheduleStream=new WeakMap;var _fixedHistoryStream=new WeakMap;var _historyStream=new WeakMap;var _itemsQueue=new WeakMap;var _itemsQueueProcessing=new WeakMap;var _reloadingMessagesQueue=new WeakMap;var _ownerTypeId$1=new WeakMap;var _ownerId$1=new WeakMap;var _userId=new WeakMap;var _itemDataShouldBeReloaded=new WeakSet;var _addToQueue=new WeakSet;var _processQueueItem=new WeakSet;var _addItem=new WeakSet;var _updateItem=new WeakSet;var _deleteItem=new WeakSet;var _moveItem=new WeakSet;var _pinItem=new WeakSet;var _unpinItem=new WeakSet;var _getStreamByName=new WeakSet;var _fetchItems=new WeakSet;let PullActionProcessor=function(){function e(t){babelHelpers.classCallCheck(this,e);_classPrivateMethodInitSpec$4(this,_fetchItems);_classPrivateMethodInitSpec$4(this,_getStreamByName);_classPrivateMethodInitSpec$4(this,_unpinItem);_classPrivateMethodInitSpec$4(this,_pinItem);_classPrivateMethodInitSpec$4(this,_moveItem);_classPrivateMethodInitSpec$4(this,_deleteItem);_classPrivateMethodInitSpec$4(this,_updateItem);_classPrivateMethodInitSpec$4(this,_addItem);_classPrivateMethodInitSpec$4(this,_processQueueItem);_classPrivateMethodInitSpec$4(this,_addToQueue);_classPrivateMethodInitSpec$4(this,_itemDataShouldBeReloaded);_classPrivateFieldInitSpec$7(this,_scheduleStream,{writable:true,value:null});_classPrivateFieldInitSpec$7(this,_fixedHistoryStream,{writable:true,value:null});_classPrivateFieldInitSpec$7(this,_historyStream,{writable:true,value:null});_classPrivateFieldInitSpec$7(this,_itemsQueue,{writable:true,value:[]});_classPrivateFieldInitSpec$7(this,_itemsQueueProcessing,{writable:true,value:false});_classPrivateFieldInitSpec$7(this,_reloadingMessagesQueue,{writable:true,value:[]});_classPrivateFieldInitSpec$7(this,_ownerTypeId$1,{writable:true,value:void 0});_classPrivateFieldInitSpec$7(this,_ownerId$1,{writable:true,value:void 0});_classPrivateFieldInitSpec$7(this,_userId,{writable:true,value:void 0});if(!main_core.Type.isObject(t.scheduleStream)||!main_core.Type.isObject(t.fixedHistoryStream)||!main_core.Type.isObject(t.historyStream)){throw new Error(`params scheduleStream, fixedHistoryStream and historyStream are required`)}if(!main_core.Type.isNumber(t.ownerTypeId)||!main_core.Type.isNumber(t.ownerId)){throw new Error("params ownerTypeId and ownerId are required")}babelHelpers.classPrivateFieldSet(this,_scheduleStream,t.scheduleStream);babelHelpers.classPrivateFieldSet(this,_fixedHistoryStream,t.fixedHistoryStream);babelHelpers.classPrivateFieldSet(this,_historyStream,t.historyStream);babelHelpers.classPrivateFieldSet(this,_ownerTypeId$1,t.ownerTypeId);babelHelpers.classPrivateFieldSet(this,_ownerId$1,t.ownerId);babelHelpers.classPrivateFieldSet(this,_userId,t.userId)}babelHelpers.createClass(e,[{key:"processAction",value:function e(t){if(_classPrivateMethodGet$4(this,_itemDataShouldBeReloaded,_itemDataShouldBeReloaded2).call(this,t)){babelHelpers.classPrivateFieldGet(this,_reloadingMessagesQueue).push(t);_classPrivateMethodGet$4(this,_fetchItems,_fetchItems2).call(this)}else{_classPrivateMethodGet$4(this,_addToQueue,_addToQueue2).call(this,t)}}}]);return e}();function _itemDataShouldBeReloaded2(e){const{item:t}=e;if(!t){return false}const i=BX.prop.getBoolean(t,"canBeReloaded",true);if(!i){return false}const s=main_core.Loc.getMessage("LANGUAGE_ID").toLowerCase();const n=BX.prop.getString(t,"languageId",s).toLowerCase();if(n!==s){return true}const a=BX.prop.getArray(t,"targetUsersList",[]);return a.length>0&&!a.includes(babelHelpers.classPrivateFieldGet(this,_userId))}function _addToQueue2(e){babelHelpers.classPrivateFieldGet(this,_itemsQueue).push(e);if(!babelHelpers.classPrivateFieldGet(this,_itemsQueueProcessing)){_classPrivateMethodGet$4(this,_processQueueItem,_processQueueItem2).call(this)}}function _processQueueItem2(){if(!babelHelpers.classPrivateFieldGet(this,_itemsQueue).length){babelHelpers.classPrivateFieldSet(this,_itemsQueueProcessing,false);return}babelHelpers.classPrivateFieldSet(this,_itemsQueueProcessing,true);const e=babelHelpers.classPrivateFieldGet(this,_itemsQueue).shift();const t=_classPrivateMethodGet$4(this,_getStreamByName,_getStreamByName2).call(this,e.stream);const i=[];switch(e.action){case"add":i.push(_classPrivateMethodGet$4(this,_addItem,_addItem2).call(this,e.id,e.item,t));break;case"update":i.push(_classPrivateMethodGet$4(this,_updateItem,_updateItem2).call(this,e.id,e.item,t,false,true));if(t.isHistoryStream()){i.push(_classPrivateMethodGet$4(this,_updateItem,_updateItem2).call(this,e.id,e.item,babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream),false,true))}break;case"delete":i.push(_classPrivateMethodGet$4(this,_deleteItem,_deleteItem2).call(this,e.id,t));if(t.isHistoryStream()){i.push(_classPrivateMethodGet$4(this,_deleteItem,_deleteItem2).call(this,e.id,babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream)))}break;case"move":const s=_classPrivateMethodGet$4(this,_getStreamByName,_getStreamByName2).call(this,e.params.fromStream);i.push(_classPrivateMethodGet$4(this,_moveItem,_moveItem2).call(this,e.params.fromId,s,e.id,t,e.item));break;case"changePinned":if(_classPrivateMethodGet$4(this,_getStreamByName,_getStreamByName2).call(this,e.params.fromStream).isHistoryStream()){i.push(_classPrivateMethodGet$4(this,_pinItem,_pinItem2).call(this,e.id,e.item))}else{i.push(_classPrivateMethodGet$4(this,_unpinItem,_unpinItem2).call(this,e.id,e.item))}}Promise.all(i).then((()=>{_classPrivateMethodGet$4(this,_processQueueItem,_processQueueItem2).call(this)}))}async function _addItem2(e,t,i){const s=i.findItemById(e);if(s){return Promise.resolve()}const n=i.createItem(t);if(!n){return Promise.resolve()}const a=i.calculateItemIndex(n);const r=i.createAnchor(a);await i.addItem(n,a);n.layout({anchor:r});return i.animateItemAdding(n)}function _updateItem2(e,t,i,s=true,n){const a=BX.prop.getString(t["ASSOCIATED_ENTITY"],"COMPLETED")==="Y";const r=i.findItemById(e);if(!r){return Promise.resolve()}if(r instanceof CompatibleItem&&a){r._existedStreamItemDeadLine=r.getLightTime()}r.setData(t);return i.refreshItem(r,s,n)}function _deleteItem2(e,t){const i=t.findItemById(e);if(i){return t.deleteItemAnimated(i)}return Promise.resolve()}function _moveItem2(e,t,i,s,n){const a=t.findItemById(e);if(!a){return _classPrivateMethodGet$4(this,_addItem,_addItem2).call(this,i,n,s)}const r=s.findItemById(i);if(a&&r){return _classPrivateMethodGet$4(this,_deleteItem,_deleteItem2).call(this,e,t)}const o=s.createItem(n);s.addItem(o,s.calculateItemIndex(o));if(o instanceof CompatibleItem){o.layout({add:false})}return t.moveItemToStream(a,s,o)}function _pinItem2(e,t){if(babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream).findItemById(e)){return Promise.resolve()}const i=babelHelpers.classPrivateFieldGet(this,_historyStream).findItemById(e);if(!i){return _classPrivateMethodGet$4(this,_addItem,_addItem2).call(this,e,t,babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream))}if(i instanceof CompatibleItem){i.onSuccessFasten();return Promise.resolve()}else{const s=i.getLayoutContentBlockById("commentContentWeb");if(s){s.setIsFilesBlockDisplayed(false);s.setIsMoving()}return _classPrivateMethodGet$4(this,_updateItem,_updateItem2).call(this,e,t,babelHelpers.classPrivateFieldGet(this,_historyStream),false,false).then((()=>{const e=babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream).createItem(t);e.initWrapper();babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream).addItem(e,0);return new Promise((t=>{const n=Fasten.create("",{initialItem:i,finalItem:e,anchor:babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream).getAnchor(),events:{complete:()=>{e.initLayoutApp({add:false});if(s){s.setIsFilesBlockDisplayed();s.setIsMoving(false);const t=e.getLayoutContentBlockById("commentContentWeb");if(t){t.setIsFilesBlockDisplayed();t.setIsMoving(false)}}t()}}});n.run()}))}))}}function _unpinItem2(e,t){const i=babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream).findItemById(e);if(i instanceof CompatibleItem){i.onSuccessUnfasten();return Promise.resolve()}else{return _classPrivateMethodGet$4(this,_updateItem,_updateItem2).call(this,e,t,babelHelpers.classPrivateFieldGet(this,_historyStream),false,false).then((()=>_classPrivateMethodGet$4(this,_deleteItem,_deleteItem2).call(this,e,babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream))))}}function _getStreamByName2(e){switch(e){case"scheduled":return babelHelpers.classPrivateFieldGet(this,_scheduleStream);case"fixedHistory":return babelHelpers.classPrivateFieldGet(this,_fixedHistoryStream);case"history":return babelHelpers.classPrivateFieldGet(this,_historyStream)}throw new Error(`Stream "${e}" not found`)}function _fetchItems2(){setTimeout((()=>{const e=main_core.clone(babelHelpers.classPrivateFieldGet(this,_reloadingMessagesQueue));babelHelpers.classPrivateFieldSet(this,_reloadingMessagesQueue,[]);const t=[];const i=[];e.forEach((e=>{const s=e.stream==="scheduled"?t:i;s.push(e.id)}));if(e.length){const s={activityIds:t,historyIds:i,ownerTypeId:babelHelpers.classPrivateFieldGet(this,_ownerTypeId$1),ownerId:babelHelpers.classPrivateFieldGet(this,_ownerId$1)};main_core.ajax.runAction("crm.timeline.item.load",{data:s}).then((t=>{e.forEach((e=>{if(t.data[e.id]){e.item=t.data[e.id]}_classPrivateMethodGet$4(this,_addToQueue,_addToQueue2).call(this,e)}))})).catch((t=>{console.error(t);e.forEach((e=>_classPrivateMethodGet$4(this,_addToQueue,_addToQueue2).call(this,e)))}))}}),1500)}let EntityChat=function(_Stream){babelHelpers.inherits(EntityChat,_Stream);function EntityChat(){var e;babelHelpers.classCallCheck(this,EntityChat);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(EntityChat).call(this));e._data=null;e._layoutType=EntityChat.LayoutType.none;e._wrapper=null;e._contentWrapper=null;e._messageWrapper=null;e._messageDateNode=null;e._messageTexWrapper=null;e._messageTextNode=null;e._userWrapper=null;e._extraUserCounter=null;e.isLoading=false;e._openChatHandler=BX.delegate(e.onOpenChat,babelHelpers.assertThisInitialized(e));return e}babelHelpers.createClass(EntityChat,[{key:"doInitialize",value:function e(){this._data=BX.prop.getObject(this._settings,"data",{})}},{key:"getData",value:function e(){return this._data}},{key:"setData",value:function e(t){this._data=BX.type.isPlainObject(t)?t:{}}},{key:"isEnabled",value:function e(){return BX.prop.getBoolean(this._data,"ENABLED",true)}},{key:"isRestricted",value:function e(){return BX.prop.getBoolean(this._data,"IS_RESTRICTED",false)}},{key:"applyLockScript",value:function applyLockScript(){const lockScript=BX.prop.getString(this._data,"LOCK_SCRIPT",null);if(BX.Type.isString(lockScript)&&lockScript!==""){eval(lockScript)}}},{key:"getChatId",value:function e(){return BX.prop.getInteger(this._data,"CHAT_ID",0)}},{key:"getUserId",value:function e(){const t=parseInt(top.BX.message("USER_ID"));return!isNaN(t)?t:0}},{key:"getMessageData",value:function e(){return BX.prop.getObject(this._data,"MESSAGE",{})}},{key:"setMessageData",value:function e(t){this._data["MESSAGE"]=BX.type.isPlainObject(t)?t:{}}},{key:"getUserInfoData",value:function e(){return BX.prop.getObject(this._data,"USER_INFOS",{})}},{key:"setUserInfoData",value:function e(t){this._data["USER_INFOS"]=BX.type.isPlainObject(t)?t:{}}},{key:"hasUserInfo",value:function e(t){return t>0&&BX.type.isPlainObject(this.getUserInfoData()[t])}},{key:"getUserInfo",value:function e(t){const i=this.getUserInfoData();return t>0&&BX.type.isPlainObject(i[t])?i[t]:null}},{key:"removeUserInfo",value:function e(t){const i=this.getUserInfoData();if(t>0&&BX.type.isPlainObject(i[t])){delete i[t]}}},{key:"setUnreadMessageCounter",value:function e(t,i){const s=this.getUserInfoData();if(t>0&&BX.type.isPlainObject(s[t])){s[t]["counter"]=i}}},{key:"layout",value:function e(){if(!this.isEnabled()||this.isStubMode()){return}this._wrapper=BX.create("div",{props:{className:"crm-entity-stream-section crm-entity-stream-section-live-im"}});this._container.appendChild(this._wrapper);this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-live-im"}}));this._contentWrapper=BX.create("div",{props:{className:"crm-entity-stream-content-live-im-detail"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-stream-section-content"},children:[BX.create("div",{props:{className:"crm-entity-stream-content-event"},children:[this._contentWrapper]})]}));this._userWrapper=BX.create("div",{props:{className:"crm-entity-stream-live-im-user-avatars"}});this._contentWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-stream-live-im-users"},children:[this._userWrapper]}));this._extraUserCounter=BX.create("div",{props:{className:"crm-entity-stream-live-im-user-counter"}});this._contentWrapper.appendChild(this._extraUserCounter);this._layoutType=EntityChat.LayoutType.none;if(this.getChatId()>0){this.renderSummary()}else{this.renderInvitation()}BX.bind(this._contentWrapper,"click",this._openChatHandler);BX.addCustomEvent("onPullEvent-im",this.onChatEvent.bind(this))}},{key:"refreshLayout",value:function e(){BX.cleanNode(this._contentWrapper);this._userWrapper=BX.create("div",{props:{className:"crm-entity-stream-live-im-user-avatars"}});this._contentWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-stream-live-im-users"},children:[this._userWrapper]}));this._extraUserCounter=BX.create("div",{props:{className:"crm-entity-stream-live-im-user-counter"}});this._contentWrapper.appendChild(this._extraUserCounter);this._layoutType=EntityChat.LayoutType.none;if(this.getChatId()>0){this.renderSummary()}else{this.renderInvitation()}}},{key:"renderInvitation",value:function e(){this._layoutType=EntityChat.LayoutType.invitation;this.refreshUsers();this._messageTextNode=BX.create("div",{props:{className:"crm-entity-stream-live-im-user-invite-text"}});this._contentWrapper.appendChild(this._messageTextNode);this._messageTextNode.innerHTML=this.getMessage("invite")}},{key:"renderSummary",value:function e(){this._layoutType=EntityChat.LayoutType.summary;this.refreshUsers();this._contentWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-stream-live-im-separator"}}));this._messageWrapper=BX.create("div",{props:{className:"crm-entity-stream-live-im-messanger"}});this._contentWrapper.appendChild(this._messageWrapper);this._messageDateNode=BX.create("div",{props:{className:"crm-entity-stream-live-im-time"}});this._messageWrapper.appendChild(this._messageDateNode);this._messageTexWraper=BX.create("div",{props:{className:"crm-entity-stream-live-im-message"}});this._messageWrapper.appendChild(this._messageTexWraper);this._messageTextNode=BX.create("div",{props:{className:"crm-entity-stream-live-im-message-text"}});this._messageTexWraper.appendChild(this._messageTextNode);this._messageCounterNode=BX.create("div",{props:{className:"crm-entity-stream-live-im-message-counter"}});this._messageWrapper.appendChild(this._messageCounterNode);this.refreshSummary()}},{key:"refreshUsers",value:function e(){BX.cleanNode(this._userWrapper);const t=this.getUserInfoData();const i=Object.values(t);if(i.length===0){this._userWrapper.appendChild(BX.create("span",{props:{className:"crm-entity-stream-live-im-user-avatar ui-icon ui-icon-common-user"},children:[BX.create("i")]}))}else{const e=i.length>=3?3:i.length;for(let t=0;t<e;t++){const e=i[t];const s=BX.create("i");const n=BX.prop.getString(e,"avatar","");if(n!==""){s.style.backgroundImage="url("+encodeURI(n)+")"}this._userWrapper.appendChild(BX.create("span",{props:{className:"crm-entity-stream-live-im-user-avatar ui-icon ui-icon-common-user"},children:[s]}))}}if(this._layoutType===EntityChat.LayoutType.summary){if(i.length>3){this._extraUserCounter.display="";this._extraUserCounter.innerHTML="+"+(i.length-3).toString()}else{if(this._extraUserCounter.innerHTML!==""){this._extraUserCounter.innerHTML=""}this._extraUserCounter.display="none"}}else{if(this._extraUserCounter.innerHTML!==""){this._extraUserCounter.innerHTML=""}this._extraUserCounter.display="none";this._userWrapper.appendChild(BX.create("span",{props:{className:"crm-entity-stream-live-im-user-invite-btn"}}))}}},{key:"refreshSummary",value:function e(){if(this._layoutType!==EntityChat.LayoutType.summary){return}const t=this.getMessageData();const i=BX.prop.getString(t,"date","");if(i===""){this._messageDateNode.innerHTML=""}else{const e=new Date(i).getTime()/1e3+this.getServerTimezoneOffset()+this.getUserTimezoneOffset();const t=(new Date).getTime()/1e3+this.getServerTimezoneOffset()+this.getUserTimezoneOffset();this._messageDateNode.innerHTML=this.formatTime(e,t,true)}let s=BX.prop.getString(t,"text","");const n=BX.prop.getObject(t,"params",{});if(s===""&&!n.ATTACH&&!n.FILE_ID){this._messageTextNode.innerHTML=""}else{const e=main_core.Reflection.getClass("top.BX.MessengerCommon");const t=main_core.Reflection.getClass("top.BX.Messenger.v2.Lib.Parser");if(e){s=e.purifyText(s,n)}else if(t){s=t.purify({text:s,attach:n.ATTACH,files:typeof n.FILE_ID==="object"&&n.FILE_ID.length>0})}this._messageTextNode.innerText=s}let a=0;const r=this.getUserId();if(r>0){a=BX.prop.getInteger(BX.prop.getObject(BX.prop.getObject(this._data,"USER_INFOS",{}),r,null),"counter",0)}this._messageCounterNode.innerHTML=a.toString();this._messageCounterNode.style.display=a>0?"":"none"}},{key:"refreshUsersAnimated",value:function e(){BX.removeClass(this._userWrapper,"crm-entity-stream-live-im-message-show");BX.addClass(this._userWrapper,"crm-entity-stream-live-im-message-hide");window.setTimeout(function(){this.refreshUsers();window.setTimeout(function(){BX.removeClass(this._userWrapper,"crm-entity-stream-live-im-message-hide");BX.addClass(this._userWrapper,"crm-entity-stream-live-im-message-show")}.bind(this),50)}.bind(this),500)}},{key:"refreshSummaryAnimated",value:function e(){BX.removeClass(this._messageWrapper,"crm-entity-stream-live-im-message-show");BX.addClass(this._messageWrapper,"crm-entity-stream-live-im-message-hide");window.setTimeout(function(){this.refreshSummary();window.setTimeout(function(){BX.removeClass(this._messageWrapper,"crm-entity-stream-live-im-message-hide");BX.addClass(this._messageWrapper,"crm-entity-stream-live-im-message-show")}.bind(this),50)}.bind(this),500)}},{key:"loading",value:function e(t){if(this._contentWrapper&&this._contentWrapper.classList){if(t){main_core.Dom.addClass(this._contentWrapper,"crm-entity-chat-loading");this.isLoading=true}else{main_core.Dom.removeClass(this._contentWrapper,"crm-entity-chat-loading");this.isLoading=false}}}},{key:"onOpenChat",value:function e(t){if(main_core.Type.isUndefined(top.BX.Messenger.Public)||this.isLoading){return}if(this.isRestricted()){this.applyLockScript();return}const i=this.getOwnerInfo();const s=BX.prop.getInteger(i,"ENTITY_ID",0);const n=BX.prop.getInteger(i,"ENTITY_TYPE_ID",0);const a={data:{entityId:s,entityTypeId:n}};const r=e=>{this.loading(false);const t=e.data.chatId;top.BX.Messenger.Public.openChat(`chat${t}`)};const o=e=>{this.loading(false);const t=e.errors[0].message;BX.UI.Notification.Center.notify({content:t,autoHideDelay:5e3})};this.loading(true);BX.ajax.runAction("crm.timeline.chat.get",a).then(r,o)}},{key:"onChatEvent",value:function e(t,i,s){const n=this.getChatId();if(n<=0||n!==BX.prop.getInteger(i,"chatId",0)){return}if(t==="chatUserAdd"){this.setUserInfoData(BX.mergeEx(this.getUserInfoData(),BX.prop.getObject(i,"users",{})));this.refreshUsersAnimated()}else if(t==="chatUserLeave"){this.removeUserInfo(BX.prop.getInteger(i,"userId",0));this.refreshUsersAnimated()}else if(t==="messageChat"){this.setMessageData(BX.prop.getObject(i,"message",{}));this.setUnreadMessageCounter(this.getUserId(),BX.prop.getInteger(i,"counter",0));this.refreshSummaryAnimated()}else if(t==="messageUpdate"||t==="messageDelete"){if(t==="messageDelete"){delete i["date"]}const e=this.getMessageData();if(BX.prop.getInteger(e,"id",0)===BX.prop.getInteger(i,"id",0)){this.setMessageData(BX.mergeEx(e,i));this.refreshSummaryAnimated()}}else if(t==="readMessageChat"){this.setUnreadMessageCounter(this.getUserId(),0);this.refreshSummaryAnimated()}else if(t==="unreadMessageChat"){this.setUnreadMessageCounter(this.getUserId(),BX.prop.getInteger(i,"counter",0));this.refreshSummaryAnimated()}}},{key:"getMessage",value:function e(t){return BX.prop.getString(EntityChat.messages,t,t)}}],[{key:"create",value:function e(t,i){const s=new EntityChat;s.initialize(t,i);EntityChat.items[s.getId()]=s;return s}}]);return EntityChat}(Steam);babelHelpers.defineProperty(EntityChat,"LayoutType",{none:0,invitation:1,summary:2});babelHelpers.defineProperty(EntityChat,"items",{});babelHelpers.defineProperty(EntityChat,"messages",{});let Modification=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"getTitle",value:function e(){return this.getTextDataParam("TITLE")}},{key:"prepareContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-info"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}));const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const s=this.prepareHeaderLayout();const n=[];if(BX.type.isNotEmptyString(this.getTextDataParam("START_NAME"))){n.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detain-info-status"},text:this.getTextDataParam("START_NAME")}));n.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-info-separator-icon"}}))}if(BX.type.isNotEmptyString(this.getTextDataParam("FINISH_NAME"))){n.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detain-info-status"},text:this.getTextDataParam("FINISH_NAME")}))}i.appendChild(s);i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-info"},children:n})]}));const a=this.prepareAuthorLayout();if(a){i.appendChild(a)}t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));return t}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);babelHelpers.defineProperty(Modification,"messages",{});let Conversion=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"getTitle",value:function e(){return this.getTextDataParam("TITLE")}},{key:"prepareContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-convert crm-entity-stream-section-history"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-convert"}}));const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const s=this.prepareHeaderLayout();i.appendChild(s);const n=[];const a=this.getArrayDataParam("ENTITIES");let r=0;const o=a.length;for(;r<o;r++){const e=a[r];let t;if(BX.prop.getString(e,"SHOW_URL","")===""){t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-convert"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detain-convert-status"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-status-text"},text:BX.CrmEntityType.getNotFoundMessage(e["ENTITY_TYPE_ID"])})]})]})}else{t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-convert"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detain-convert-status"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-status-text"},text:e["ENTITY_TYPE_CAPTION"]})]}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-convert-separator-icon"}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detain-convert-status"},children:[BX.create("A",{attrs:{className:"crm-entity-stream-content-detail-target",href:e["SHOW_URL"]},text:e["TITLE"]})]})]})}n.push(t)}i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:n}));const l=this.prepareAuthorLayout();if(l){i.appendChild(l)}t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));return t}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);babelHelpers.defineProperty(Conversion,"messages",{});let Action$1=function(){function e(){babelHelpers.classCallCheck(this,e);this._id="";this._settings={};this._container=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"BX.CrmTimelineAction: Could not find container."}this.doInitialize()}},{key:"doInitialize",value:function e(){}},{key:"getId",value:function e(){return this._id}},{key:"getSetting",value:function e(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i}},{key:"layout",value:function e(){this.doLayout()}},{key:"doLayout",value:function e(){}}]);return e}();let Activity=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._activityEditor=null;e._entityData=null;e._item=null;e._isEnabled=true;return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){this._entityData=this.getSetting("entityData");if(!BX.type.isPlainObject(this._entityData)){throw"BX.Crm.Timeline.Actions.Activity. A required parameter 'entityData' is missing."}this._activityEditor=this.getSetting("activityEditor");if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"BX.Crm.Timeline.Actions.Activity. A required parameter 'activityEditor' is missing."}this._item=this.getSetting("item");this._isEnabled=this.getSetting("enabled",true)}},{key:"getActivityId",value:function e(){return BX.prop.getInteger(this._entityData,"ID",0)}},{key:"loadActivityCommunications",value:function e(t){this._activityEditor.getActivityCommunications(this.getActivityId(),(function(e){if(BX.type.isFunction(t)){t(e)}}),true)}},{key:"getItemData",value:function e(){return this._item?this._item.getData():null}}]);return t}(Action$1);let Email=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._clickHandler=BX.delegate(e.onClick,babelHelpers.assertThisInitialized(e));e._saveHandler=BX.delegate(e.onSave,babelHelpers.assertThisInitialized(e));return e}babelHelpers.createClass(t,[{key:"onClick",value:function e(t){const i={ownerType:BX.CrmEntityType.resolveName(BX.prop.getInteger(this._entityData,"OWNER_TYPE_ID",0)),ownerID:BX.prop.getInteger(this._entityData,"OWNER_ID",0),ownerUrl:BX.prop.getString(this._entityData,"OWNER_URL",""),ownerTitle:BX.prop.getString(this._entityData,"OWNER_TITLE",""),originalMessageID:BX.prop.getInteger(this._entityData,"ID",0),messageType:"RE"};if(BX.CrmActivityProvider&&top.BX.Bitrix24&&top.BX.Bitrix24.Slider){const e=this._activityEditor.addEmail(i);e.addOnSave(this._saveHandler)}else{this.loadActivityCommunications(BX.delegate((function(e){i["communications"]=BX.type.isArray(e)?e:[];i["communicationsLoaded"]=true;BX.CrmActivityEmail.prepareReply(i);const t=this._activityEditor.addEmail(i);t.addOnSave(this._saveHandler)}),this))}return BX.PreventDefault(t)}},{key:"onSave",value:function e(t,i){if(BX.type.isFunction(this._item.onActivityCreate)){this._item.onActivityCreate(t,i)}}}]);return t}(Activity);let HistoryEmail=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"doLayout",value:function e(){this._container.appendChild(BX.create("A",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}}))}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Email);let ScheduleEmail=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"doLayout",value:function e(){this._container.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}}))}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Email);let HistoryActivity=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"doInitialize",this).call(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"HistoryActivity. The field 'activityEditor' is not assigned."}}},{key:"getTitle",value:function e(){return BX.prop.getString(this.getAssociatedEntityData(),"SUBJECT","")}},{key:"getTypeDescription",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getInteger(t,"DIRECTION",0);const s=this.getTypeCategoryId();if(s===BX.CrmActivityType.email){return this.getMessage(i===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")}else if(s===BX.CrmActivityType.call){return this.getMessage(i===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")}else if(s===BX.CrmActivityType.meeting){return this.getMessage("meeting")}else if(s===BX.CrmActivityType.task){return this.getMessage("task")}else if(s===BX.CrmActivityType.provider){const e=BX.prop.getString(t,"PROVIDER_ID","");if(e==="CRM_WEBFORM"){return this.getMessage("webform")}else if(e==="CRM_SMS"){return this.getMessage("sms")}else if(e==="CRM_REQUEST"){return this.getMessage("activityRequest")}else if(e==="IMOPENLINES_SESSION"){return this.getMessage("openLine")}else if(e==="REST_APP"){return this.getMessage("restApplication")}else if(e==="VISIT_TRACKER"){return this.getMessage("visit")}else if(e==="ZOOM"){return this.getMessage("zoom")}}return""}},{key:"prepareTitleLayout",value:function e(){return BX.create("A",{attrs:{href:"#",className:"crm-entity-stream-content-event-title"},events:{click:this._headerClickHandler},text:this.getTypeDescription()})}},{key:"prepareTimeLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})}},{key:"prepareMarkLayout",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getInteger(t,"MARK_TYPE_ID",0);if(i<=0){return null}let s="";if(i===Mark.success){s="SuccessMark"}else if(i===Mark.renew){s="RenewMark"}if(s===""){return null}let n="";const a=this.getTypeCategoryId();if(a===BX.CrmActivityType.email){n=this.getMessage("email"+s)}else if(a===BX.CrmActivityType.call){n=this.getMessage("call"+s)}else if(a===BX.CrmActivityType.meeting){n=this.getMessage("meeting"+s)}else if(a===BX.CrmActivityType.task){n=this.getMessage("task"+s)}if(n===""){return null}return BX.create("SPAN",{props:{className:"crm-entity-stream-content-event-skipped"},text:n})}},{key:"prepareActions",value:function e(){if(this.isReadOnly()){return}const t=this.getTypeCategoryId();if(t===BX.CrmActivityType.email){this._actions.push(HistoryEmail.create("email",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor}))}}},{key:"prepareContextMenuItems",value:function e(){if(this._isMenuShown){return}const t=[];if(!this.isReadOnly()){if(this.isEditable()){t.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.edit,this)})}t.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id))t.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)});else t.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}return t}},{key:"view",value:function e(){this.closeContextMenu();const t=this.getAssociatedEntityData();const i=BX.prop.getInteger(t,"ID",0);if(i>0){this._activityEditor.viewActivity(i)}}},{key:"edit",value:function e(){this.closeContextMenu();const t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.activity){const e=this.getAssociatedEntityData();const t=BX.prop.getInteger(e,"ID",0);if(t>0){this._activityEditor.editActivity(t)}}}},{key:"processRemoval",value:function e(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";let t=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!t){t=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getRemoveMessage()})}t.open().then(BX.delegate(this.onRemovalConfirm,this),BX.delegate(this.onRemovalCancel,this))}},{key:"getRemoveMessage",value:function e(){return this.getMessage("removeConfirm")}},{key:"onRemovalConfirm",value:function e(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this.remove()}},{key:"onRemovalCancel",value:function e(){}},{key:"remove",value:function e(){const t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.activity){const e=this.getAssociatedEntityData();const t=BX.prop.getInteger(e,"ID",0);if(t>0){const e=this._activityEditor;const i=e.getItemById(t);if(i){e.deleteActivity(t,true)}else{const i=BX.util.add_url_param(e.getSetting("serviceUrl",""),{id:t,action:"get_activity",ownertype:e.getSetting("ownerType",""),ownerid:e.getSetting("ownerID","")});BX.ajax({url:i,method:"POST",dataType:"json",data:{ACTION:"GET_ACTIVITY",ID:t,OWNER_TYPE:e.getSetting("ownerType",""),OWNER_ID:e.getSetting("ownerID","")},onsuccess:BX.delegate((function(t){if(typeof t["ACTIVITY"]!=="undefined"){e._handleActivityChange(t["ACTIVITY"]);window.setTimeout(BX.delegate(this.remove,this),500)}}),this),onfailure:function(e){}})}}}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);babelHelpers.defineProperty(HistoryActivity,"messages",{});let Email$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());const i=this.getAssociatedEntityData();const s=BX.prop.getObject(i,"EMAIL_INFO",null);const n=s!==null?BX.prop.getString(s,"STATUS_TEXT",""):"";const a=s!==null?BX.prop.getBoolean(s,"STATUS_ERROR",false):false;const r=!a?"crm-entity-stream-content-event-skipped":"crm-entity-stream-content-event-missing";if(n!==""){t.appendChild(BX.create("SPAN",{props:{className:r},text:n}))}const o=this.prepareMarkLayout();if(o){t.appendChild(o)}t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContextMenuItems",value:function e(){const t=[];if(!this.isReadOnly()){t.push({id:"view",text:this.getMessage("menuView"),onclick:BX.delegate(this.view,this)});t.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id))t.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)});else t.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}return t}},{key:"reply",value:function e(){}},{key:"replyAll",value:function e(){}},{key:"forward",value:function e(){}},{key:"getRemoveMessage",value:function e(){const t=BX.util.htmlspecialchars(this.getTitle());return this.getMessage("emailRemove").replace("#TITLE#",t)}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}const s=BX.prop.getObject(t,"COMMUNICATION",{});const n=BX.prop.getString(s,"TITLE","");const a=BX.prop.getString(s,"SHOW_URL","");const r=BX.prop.getString(s,"VALUE","");const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-email"}});o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-email"}}));if(this.isFixed())BX.addClass(o,"crm-entity-stream-section-top-fixed");const l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[l]}));const c=this.prepareHeaderLayout();l.appendChild(c);if(this.isContextMenuEnabled()){l.appendChild(this.prepareContextMenuButton())}const u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email"}});l.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:[u]}));u.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));const h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email-to"}});u.appendChild(h);if(n!==""){if(a!==""){h.appendChild(BX.create("A",{attrs:{href:a},text:n}))}else{h.appendChild(BX.create("SPAN",{text:n}))}}if(r!==""){if(n!==""){h.appendChild(BX.create("SPAN",{text:" "}))}h.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-email-address"},text:r}))}u.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-email-fragment"},children:this.prepareCutOffElements(i,128,this._headerClickHandler)}));const d=this.prepareAuthorLayout();if(d){l.appendChild(d)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});l.appendChild(this._actionContainer);if(!this.isReadOnly())l.appendChild(this.prepareFixedSwitcherLayout());return o}},{key:"prepareActions",value:function e(){if(this.isReadOnly()){return}this._actions.push(HistoryEmail.create("email",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor}))}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Call=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._clickHandler=BX.delegate(e.onClick,babelHelpers.assertThisInitialized(e));e._menu=null;e._isMenuShown=false;e._menuItems=null;return e}babelHelpers.createClass(t,[{key:"getButton",value:function e(){return null}},{key:"onClick",value:function e(t){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("telephonyNotSupported"));return}let i="";const s=this.getItemData();const n=BX.prop.getArray(s,"PHONE",[]);if(n.length===1){this.addCall(n[0]["VALUE"])}else if(n.length>1){this.showMenu()}else{const e=BX.prop.getObject(this._entityData,"COMMUNICATION",null);if(e){if(BX.prop.getString(e,"TYPE")==="PHONE"){i=BX.prop.getString(e,"VALUE");if(i){this.addCall(i)}}}}return BX.PreventDefault(t)}},{key:"showMenu",value:function e(){if(this._isMenuShown){return}this.prepareMenuItems();if(!this._menuItems||this._menuItems.length===0){return}this._menu=new BX.PopupMenuWindow(this._id,this._container,this._menuItems,{offsetTop:0,offsetLeft:16,events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this),onPopupDestroy:BX.delegate(this.onMenuDestroy,this)}});this._menu.popupWindow.show()}},{key:"closeMenu",value:function e(){if(!this._isMenuShown){return}if(this._menu){this._menu.close()}}},{key:"prepareMenuItems",value:function e(){if(this._menuItems){return}const t=this.getItemData();const i=BX.prop.getArray(t,"PHONE",[]);const s=BX.delegate(this.onMenuItemClick,this);this._menuItems=[];if(i.length===0){return}let n=0;const a=i.length;for(;n<a;n++){const e=BX.prop.getString(i[n],"VALUE");const t=BX.prop.getString(i[n],"VALUE_FORMATTED");const a=BX.prop.getString(i[n],"COMPLEX_NAME");const r=(a?a+": ":"")+(t?t:e);if(e!==""){this._menuItems.push({id:e,text:r,onclick:s})}}}},{key:"onMenuItemClick",value:function e(t,i){this.closeMenu();this.addCall(i.id)}},{key:"onMenuShow",value:function e(){this._isMenuShown=true}},{key:"onMenuClose",value:function e(){this._isMenuShown=false;this._menu.popupWindow.destroy()}},{key:"onMenuDestroy",value:function e(){this._menu=null}},{key:"addCall",value:function e(t){const i=BX.prop.getObject(this._entityData,"COMMUNICATION",null);let s=parseInt(BX.prop.getString(i,"ENTITY_TYPE_ID","0"));if(isNaN(s)){s=0}let n=parseInt(BX.prop.getString(i,"ENTITY_ID","0"));if(isNaN(n)){n=0}let a=0;let r=0;const o=BX.prop.getObject(this._settings,"ownerInfo");if(o){a=BX.prop.getInteger(o,"ENTITY_TYPE_ID",0);r=BX.prop.getInteger(o,"ENTITY_ID",0)}if(a<=0||r<=0){a=BX.prop.getInteger(this._entityData,"OWNER_TYPE_ID",0);r=BX.prop.getInteger(this._entityData,"OWNER_ID","0")}if(a<=0||r<=0){a=s;r=n}let l=parseInt(BX.prop.getString(this._entityData,"ID","0"));if(isNaN(l)){l=0}const c={ENTITY_TYPE_NAME:BX.CrmEntityType.resolveName(s),ENTITY_ID:n,AUTO_FOLD:true};if(a!==s||r!==n){c["BINDINGS"]=[{OWNER_TYPE_NAME:BX.CrmEntityType.resolveName(a),OWNER_ID:r}]}if(l>0){c["SRC_ACTIVITY_ID"]=l}window.top["BXIM"].phoneTo(t,c)}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}]);return t}(Activity);babelHelpers.defineProperty(Call,"messages",{});let HistoryCall=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._button=null;return e}babelHelpers.createClass(t,[{key:"getButton",value:function e(){return this._button}},{key:"doLayout",value:function e(){this._button=BX.create("A",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}});this._container.appendChild(this._button)}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Call);let ScheduleCall=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"doLayout",value:function e(){this._container.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}}))}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Call);let Call$1=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._playerDummyClickHandler=BX.delegate(e.onPlayerDummyClick,babelHelpers.assertThisInitialized(e));e._playerWrapper=null;e._transcriptWrapper=null;e._mediaFileInfo=null;return e}babelHelpers.createClass(t,[{key:"getTypeDescription",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getObject(t,"CALL_INFO",null);const s=i!==null?BX.prop.getString(i,"CALL_TYPE_TEXT",""):"";if(s!==""){return s}const n=BX.prop.getInteger(t,"DIRECTION",0);return this.getMessage(n===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")}},{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());const i=this.getAssociatedEntityData();const s=BX.prop.getObject(i,"CALL_INFO",null);const n=s!==null;const a=n?BX.prop.getBoolean(s,"SUCCESSFUL",false):false;const r=n?BX.prop.getString(s,"STATUS_TEXT",""):"";if(n&&r.length){t.appendChild(BX.create("DIV",{attrs:{className:a?"crm-entity-stream-content-event-successful":"crm-entity-stream-content-event-missing"},text:r}))}t.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));return t}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}const s=BX.prop.getObject(t,"COMMUNICATION",{});const n=BX.prop.getString(s,"TITLE","");const a=BX.prop.getString(s,"SHOW_URL","");const r=BX.prop.getString(s,"VALUE","");const o=BX.prop.getString(s,"FORMATTED_VALUE",r);const l=BX.prop.getObject(t,"CALL_INFO",null);const c=l!==null;const u=c?BX.prop.getString(l,"DURATION_TEXT",""):"";const h=c?BX.prop.getBoolean(l,"HAS_TRANSCRIPT",""):"";const d=c?BX.prop.getBoolean(l,"TRANSCRIPT_PENDING",""):"";const p=c?BX.prop.getString(l,"CALL_ID",""):"";const m=c?BX.prop.getString(l,"COMMENT",""):"";const y=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-call"}});y.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-call"}}));if(this.isFixed())BX.addClass(y,"crm-entity-stream-section-top-fixed");const _=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});y.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[_]}));const f=this.prepareHeaderLayout();_.appendChild(f);if(this.isContextMenuEnabled()){_.appendChild(this.prepareContextMenuButton())}const g=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});_.appendChild(g);g.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));g.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareMultilineCutOffElements(i,128,this._headerClickHandler)}));if(c){const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-call crm-entity-stream-content-detail-call-inline"}});g.appendChild(e);this._mediaFileInfo=BX.prop.getObject(t,"MEDIA_FILE_INFO",null);if(this._mediaFileInfo!==null){this._playerWrapper=this._history.getManager().renderAudioDummy(u,this._playerDummyClickHandler);e.appendChild(this._playerWrapper);e.appendChild(this._history.getManager().getAudioPlaybackRateSelector().render())}if(h){this._transcriptWrapper=BX.create("DIV",{attrs:{className:"crm-audio-transcript-wrap-container"},events:{click:function(e){if(BX.Voximplant&&BX.Voximplant.Transcript){BX.Voximplant.Transcript.create({callId:p}).show()}}},children:[BX.create("DIV",{attrs:{className:"crm-audio-transcript-icon"}}),BX.create("DIV",{attrs:{className:"crm-audio-transcript-conversation"},text:BX.message("CRM_TIMELINE_CALL_TRANSCRIPT")})]});e.appendChild(this._transcriptWrapper)}else if(d){this._transcriptWrapper=BX.create("DIV",{attrs:{className:"crm-audio-transcript-wrap-container-pending"},children:[BX.create("DIV",{attrs:{className:"crm-audio-transcript-icon-pending"},html:'<svg class="crm-transcript-loader-circular" viewBox="25 25 50 50"><circle class="crm-transcript-loader-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"></circle></svg>'}),BX.create("DIV",{attrs:{className:"crm-audio-transcript-conversation"},text:BX.message("CRM_TIMELINE_CALL_TRANSCRIPT_PENDING")})]});e.appendChild(this._transcriptWrapper)}if(m){g.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:m}))}}const v=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});g.appendChild(v);if(n!==""){if(a!==""){v.appendChild(BX.create("A",{attrs:{href:a},text:n}))}else{v.appendChild(BX.create("SPAN",{text:n}))}}if(o!==""){if(n!==""){v.appendChild(BX.create("SPAN",{text:" "}))}v.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-email-address"},text:o}))}const I=this.prepareAuthorLayout();if(I){_.appendChild(I)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});_.appendChild(this._actionContainer);if(!this.isReadOnly()){_.appendChild(this.prepareFixedSwitcherLayout())}return y}},{key:"prepareActions",value:function e(){if(this.isReadOnly()){return}this._actions.push(HistoryCall.create("call",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._history.getOwnerInfo()}))}},{key:"getRemoveMessage",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getInteger(t,"DIRECTION",0);const s=i===BX.CrmActivityDirection.incoming?"incomingCallRemove":"outgoingCallRemove";const n=BX.util.htmlspecialchars(this.getTitle());return this.getMessage(s).replace("#TITLE#",n)}},{key:"onPlayerDummyClick",value:function e(t){const i=this._playerWrapper.querySelector(".crm-audio-cap-wrap");if(i){BX.addClass(i,"crm-audio-cap-wrap-loader")}this._history.getManager().getAudioPlaybackRateSelector().addPlayer(this._history.getManager().loadMediaPlayer("history_"+this.getId(),this._mediaFileInfo["URL"],this._mediaFileInfo["TYPE"],this._playerWrapper,this._mediaFileInfo["DURATION"],{playbackRate:this._history.getManager().getAudioPlaybackRateSelector().getRate()}))}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Meeting=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());const i=this.prepareMarkLayout();if(i){t.appendChild(i)}t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}const s=BX.prop.getObject(t,"COMMUNICATION",{});const n=BX.prop.getString(s,"TITLE","");const a=BX.prop.getString(s,"SHOW_URL","");const r=BX.prop.getString(s,"VALUE","");const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-meeting"}});o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-meeting"}}));if(this.isContextMenuEnabled()){o.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(o,"crm-entity-stream-section-top-fixed");const l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[l]}));const c=this.prepareHeaderLayout();l.appendChild(c);const u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});l.appendChild(u);u.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));u.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(i,128,this._headerClickHandler)}));const h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});u.appendChild(h);if(n!==""){h.appendChild(BX.create("SPAN",{text:this.getMessage("reciprocal")+": "}));if(a!==""){h.appendChild(BX.create("A",{attrs:{href:a},text:n}))}else{h.appendChild(BX.create("SPAN",{text:n}))}}h.appendChild(BX.create("SPAN",{text:" "+r}));const d=this.prepareAuthorLayout();if(d){l.appendChild(d)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});l.appendChild(this._actionContainer);if(!this.isReadOnly())l.appendChild(this.prepareFixedSwitcherLayout());return o}},{key:"getRemoveMessage",value:function e(){const t=BX.util.htmlspecialchars(this.getTitle());return this.getMessage("meetingRemove").replace("#TITLE#",t)}},{key:"prepareActions",value:function e(){}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Task=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());const i=this.prepareMarkLayout();if(i){t.appendChild(i)}t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}const s=BX.prop.getObject(t,"COMMUNICATION",{});const n=BX.prop.getString(s,"TITLE","");const a=BX.prop.getString(s,"SHOW_URL","");const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-task"}});r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-task"}}));if(this.isContextMenuEnabled()){r.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(r,"crm-entity-stream-section-top-fixed");const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[o]}));const l=this.prepareHeaderLayout();o.appendChild(l);const c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});o.appendChild(c);c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(i,128,this._headerClickHandler)}));const u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});c.appendChild(u);if(n!==""){u.appendChild(BX.create("SPAN",{text:this.getMessage("reciprocal")+": "}));if(a!==""){u.appendChild(BX.create("A",{attrs:{href:a},text:n}))}else{u.appendChild(BX.create("SPAN",{text:n}))}}const h=this.prepareAuthorLayout();if(h){o.appendChild(h)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});o.appendChild(this._actionContainer);if(!this.isReadOnly())o.appendChild(this.prepareFixedSwitcherLayout());return r}},{key:"prepareActions",value:function e(){}},{key:"getRemoveMessage",value:function e(){const t=BX.util.htmlspecialchars(this.getTitle());return this.getMessage("taskRemove").replace("#TITLE#",t)}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let WebForm=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-crmForm"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-crmForm"}}));const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));if(this.isFixed())BX.addClass(t,"crm-entity-stream-section-top-fixed");const s=this.prepareHeaderLayout();i.appendChild(s);const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});i.appendChild(n);n.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));const a=this.prepareAuthorLayout();if(a){i.appendChild(a)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});i.appendChild(this._actionContainer);if(!this.isReadOnly())i.appendChild(this.prepareFixedSwitcherLayout());return t}},{key:"prepareActions",value:function e(){}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Request=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-today crm-entity-stream-section-robot"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-robot"}}));if(this.isContextMenuEnabled()){s.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(s,"crm-entity-stream-section-top-fixed");const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[n]}));const a=this.prepareHeaderLayout();n.appendChild(a);const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});n.appendChild(r);r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(i,128,this._headerClickHandler)}));const o=this.prepareAuthorLayout();if(o){n.appendChild(o)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});n.appendChild(this._actionContainer);if(!this.isReadOnly())n.appendChild(this.prepareFixedSwitcherLayout());return s}},{key:"prepareActions",value:function e(){}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}},{key:"isEditable",value:function e(){return false}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let OpenLine=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._clickHandler=BX.delegate(e.onClick,babelHelpers.assertThisInitialized(e));e._button=null;return e}babelHelpers.createClass(t,[{key:"getButton",value:function e(){return this._button}},{key:"onClick",value:function e(){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("openLineNotSupported"));return}let t="";const i=BX.prop.getObject(this._entityData,"COMMUNICATION",null);if(i){if(BX.prop.getString(i,"TYPE")==="IM"){t=BX.prop.getString(i,"VALUE")}}if(t!==""){window.top["BXIM"].openMessengerSlider(t,{RECENT:"N",MENU:"N"})}}},{key:"doLayout",value:function e(){this._button=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-action-reply-btn"},events:{click:this._clickHandler}});this._container.appendChild(this._button)}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity);babelHelpers.defineProperty(OpenLine,"messages",{});let OpenLine$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}const s=BX.prop.getObject(t,"COMMUNICATION",{});const n=BX.prop.getString(s,"TITLE","");const a=BX.prop.getString(s,"SHOW_URL","");const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-IM"}});r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-IM"}}));if(this.isContextMenuEnabled()){r.appendChild(this.prepareContextMenuButton())}if(this.isFixed())BX.addClass(r,"crm-entity-stream-section-top-fixed");const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[o]}));const l=this.prepareHeaderLayout();o.appendChild(l);const c=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});o.appendChild(c);c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));const u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM"}});c.appendChild(u);const h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM-messages"}});u.appendChild(h);const d=BX.prop.getObject(this.getAssociatedEntityData(),"OPENLINE_INFO",null);if(d){const e=BX.prop.getArray(d,"MESSAGES",[]);let t=0;const i=e.length;for(;t<i;t++){const i=e[t];const s=BX.prop.getBoolean(i,"IS_EXTERNAL",true);h.appendChild(BX.create("DIV",{attrs:{className:s?"crm-entity-stream-content-detail-IM-message-incoming":"crm-entity-stream-content-detail-IM-message-outgoing"},html:BX.prop.getString(i,"MESSAGE","")}))}}const p=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});c.appendChild(p);if(n!==""){p.appendChild(BX.create("SPAN",{text:this.getMessage("reciprocal")+": "}));if(a!==""){p.appendChild(BX.create("A",{attrs:{href:a},text:n}))}else{p.appendChild(BX.create("SPAN",{text:n}))}}const m=this.prepareAuthorLayout();if(m){o.appendChild(m)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});o.appendChild(this._actionContainer);if(!this.isReadOnly())o.appendChild(this.prepareFixedSwitcherLayout());return r}},{key:"prepareActions",value:function e(){if(this.isReadOnly()){return}this._actions.push(OpenLine.create("openline",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._history.getOwnerInfo()}))}},{key:"view",value:function e(){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("openLineNotSupported"));return}let t="";const i=BX.prop.getObject(this.getAssociatedEntityData(),"COMMUNICATION",null);if(i){if(BX.prop.getString(i,"TYPE")==="IM"){t=BX.prop.getString(i,"VALUE")}}if(t!==""){window.top["BXIM"].openMessengerSlider(t,{RECENT:"N",MENU:"N"})}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Rest=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t}},{key:"getTypeDescription",value:function e(){const i=this.getAssociatedEntityData();if(i["APP_TYPE"]&&i["APP_TYPE"]["NAME"]){return i["APP_TYPE"]["NAME"]}return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"getTypeDescription",this).call(this)}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=i.replace(/^\s+/,"")}const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-today crm-entity-stream-section-rest"}});const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-rest"}});s.appendChild(n);if(t["APP_TYPE"]&&t["APP_TYPE"]["ICON_SRC"]){if(n){n.style.backgroundImage="url('"+t["APP_TYPE"]["ICON_SRC"]+"')";n.style.backgroundPosition="center center";n.style.backgroundSize="cover";n.style.backgroundColor="transparent"}}if(this.isFixed())BX.addClass(s,"crm-entity-stream-section-top-fixed");const a=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[a]}));const r=this.prepareHeaderLayout();a.appendChild(r);const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});a.appendChild(o);o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]}));o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:this.prepareCutOffElements(i,128,this._headerClickHandler)}));const l=this.prepareAuthorLayout();if(l){a.appendChild(l)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});a.appendChild(this._actionContainer);if(!this.isReadOnly())a.appendChild(this.prepareFixedSwitcherLayout());return s}},{key:"prepareActions",value:function e(){}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Visit=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._playerDummyClickHandler=BX.delegate(e.onPlayerDummyClick,babelHelpers.assertThisInitialized(e));e._playerWrapper=null;e._transcriptWrapper=null;e._mediaFileInfo=null;return e}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());const i=this.getAssociatedEntityData();const s=BX.prop.getObject(i,"VISIT_INFO",{});const n=BX.prop.getInteger(s,"RECORD_LENGTH",0);const a=BX.prop.getString(s,"RECORD_LENGTH_FORMATTED_FULL","");t.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:(n>0?a+", "+BX.message("CRM_TIMELINE_VISIT_AT")+" ":"")+this.formatTime(this.getCreatedTime())}));return t}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getObject(t,"COMMUNICATION",{});const s=BX.prop.getString(i,"TITLE","");const n=BX.prop.getString(i,"SHOW_URL","");const a=BX.prop.getObject(t,"VISIT_INFO",{});const r=BX.prop.getInteger(a,"RECORD_LENGTH",0);const o=BX.prop.getString(a,"RECORD_LENGTH_FORMATTED_SHORT","");const l=BX.prop.getString(a,"VK_PROFILE","");const c=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-visit"}});c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-visit"}}));const u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});c.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[u]}));const h=this.prepareHeaderLayout();u.appendChild(h);if(this.isContextMenuEnabled()){u.appendChild(this.prepareContextMenuButton())}const d=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail crm-entity-stream-content-detail-call-inline"}});u.appendChild(d);this._mediaFileInfo=BX.prop.getObject(t,"MEDIA_FILE_INFO",null);if(this._mediaFileInfo!==null&&r>0){this._playerWrapper=this._history.getManager().renderAudioDummy(o,this._playerDummyClickHandler);d.appendChild(this._playerWrapper);d.appendChild(this._history.getManager().getAudioPlaybackRateSelector().render())}const p=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});u.appendChild(p);if(s!==""){p.appendChild(document.createTextNode(BX.message("CRM_TIMELINE_VISIT_WITH")+" "));if(n!==""){p.appendChild(BX.create("A",{attrs:{href:n},text:s}))}else{p.appendChild(BX.create("SPAN",{text:s}))}}if(BX.type.isNotEmptyString(l)){p.appendChild(document.createTextNode(" "));p.appendChild(BX.create("a",{attrs:{className:"crm-entity-stream-content-detail-additional",target:"_blank",href:this.getVkProfileUrl(l)},text:BX.message("CRM_TIMELINE_VISIT_VKONTAKTE_PROFILE")}))}const m=this.prepareAuthorLayout();if(m){u.appendChild(m)}return c}},{key:"onPlayerDummyClick",value:function e(t){const i=this._playerWrapper.querySelector(".crm-audio-cap-wrap");if(i){BX.addClass(i,"crm-audio-cap-wrap-loader")}this._history.getManager().getAudioPlaybackRateSelector().addPlayer(this._history.getManager().loadMediaPlayer("history_"+this.getId(),this._mediaFileInfo["URL"],this._mediaFileInfo["TYPE"],this._playerWrapper,this._mediaFileInfo["DURATION"],{playbackRate:this._history.getManager().getAudioPlaybackRateSelector().getRate()}))}},{key:"getVkProfileUrl",value:function e(t){return"https://vk.com/"+BX.util.htmlspecialchars(t)}},{key:"view",value:function e(){if(BX.getClass("BX.Crm.Restriction.Bitrix24")&&BX.Crm.Restriction.Bitrix24.isRestricted("visit")){return BX.Crm.Restriction.Bitrix24.getHandler("visit").call()}babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"view",this).call(this)}},{key:"edit",value:function e(){if(BX.getClass("BX.Crm.Restriction.Bitrix24")&&BX.Crm.Restriction.Bitrix24.isRestricted("visit")){return BX.Crm.Restriction.Bitrix24.getHandler("visit").call()}babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"edit",this).call(this)}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Zoom=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._videoDummy=null;e._audioDummy=null;e._videoPlayer=null;e._audioPlayer=null;e._audioLengthElement=null;e._recordings=[];e._currentRecordingIndex=0;e.zoomActivitySubject=null;e._downloadWrapper=null;e._downloadSubject=null;e._downloadSubjectDetail=null;e._downloadVideoLink=null;e._downloadSeparator=null;e._downloadAudioLink=null;e._playVideoLink=null;e.detailZoomCopyVideoLink=null;return e}babelHelpers.createClass(t,[{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());if(!this._data.hasOwnProperty("PROVIDER_DATA")||this._data["PROVIDER_DATA"]["ZOOM_EVENT_TYPE"]!=="ZOOM_CONF_JOINED"){t.appendChild(this.prepareSuccessfulLayout())}t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareSuccessfulLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-successful"},text:BX.message("CRM_TIMELINE_ZOOM_SUCCESSFUL_ACTIVITY")})}},{key:"prepareTitleLayout",value:function e(){if(this._data.hasOwnProperty("PROVIDER_DATA")&&this._data["PROVIDER_DATA"]["ZOOM_EVENT_TYPE"]==="ZOOM_CONF_JOINED"){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:BX.message("CRM_TIMELINE_ZOOM_JOINED_CONFERENCE")})}else{return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:BX.message("CRM_TIMELINE_ZOOM_CONFERENCE_END")})}}},{key:"prepareContent",value:function e(){const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history"}});let s;const n=BX.prop.getObject(this.getAssociatedEntityData(),"ZOOM_INFO",null);const a=BX.prop.getString(this.getAssociatedEntityData(),"SUBJECT",null);this._recordings=BX.prop.getArray(n,"RECORDINGS",[]);i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-zoom"}}));if(this.isFixed())BX.addClass(i,"crm-entity-stream-section-top-fixed");const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[r]}));const o=this.prepareHeaderLayout();r.appendChild(o);const l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});r.appendChild(l);if(this._data.hasOwnProperty("PROVIDER_DATA")&&this._data["PROVIDER_DATA"]["ZOOM_EVENT_TYPE"]==="ZOOM_CONF_JOINED"){s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:n["CONF_URL"]})}else{s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});if(this._recordings.length>0){if(this._recordings.length>1){const e=this._recordings.map((function(e,t){return{id:t,title:BX.message("CRM_TIMELINE_ZOOM_MEETING_RECORD_PART").replace("#NUMBER#",t+1),time:e["AUDIO"]?e["AUDIO"]["LENGTH_FORMATTED"]:"",active:t===0}}));const i=new t.TabsComponent({tabs:e});i.eventEmitter.subscribe("onTabChange",this._onTabChange.bind(this));l.appendChild(i.render())}this._videoDummy=BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video-wrap"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video"},events:{click:this._onVideoDummyClick.bind(this)},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video-inner"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video-btn"},dataset:{hint:BX.message("CRM_TIMELINE_ZOOM_LOGIN_REQUIRED"),hintNoIcon:"Y"}}),BX.create("SPAN",{props:{className:"crm-entity-stream-content-detail-zoom-video-text"},text:BX.message("CRM_TIMELINE_ZOOM_CLICK_TO_WATCH")})]})]})]});BX.UI.Hint.init(this._videoDummy);this._audioDummy=this._history.getManager().renderAudioDummy("00:15",this._onAudioDummyClick.bind(this));this._audioLengthElement=this._audioDummy.querySelector(".crm-audio-cap-time");if(n["RECORDINGS"][0]["VIDEO"]){const e=n["RECORDINGS"][0]["VIDEO"]["END_DATE_TS"]*1e3+60*60*23*1e3;if(e<Date.now()){const e=BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-desc"}});this._playVideoLink=BX.create("DIV",{html:BX.message("CRM_TIMELINE_ZOOM_PLAY_LINK_VIDEO")});this._detailZoomCopyVideoLink=BX.create("A",{attrs:{className:"ui-link ui-link-dashed"},text:BX.message("CRM_TIMELINE_ZOOM_COPY_PASSWORD")});e.appendChild(this._playVideoLink);e.appendChild(this._detailZoomCopyVideoLink);s.appendChild(e)}else{s.appendChild(this._videoDummy)}}if(n["RECORDINGS"][0]["AUDIO"]){const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-call crm-entity-stream-content-detail-call-inline"}});e.appendChild(this._audioDummy);e.appendChild(this._history.getManager().getAudioPlaybackRateSelector().render());s.appendChild(e)}this._downloadWrapper=BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-desc"}});s.appendChild(this._downloadWrapper);this._downloadSubject=BX.create("SPAN",{props:{className:"crm-entity-stream-content-detail-zoom-desc-subject"}});this._downloadSubjectDetail=BX.create("SPAN",{props:{className:"crm-entity-stream-content-detail-zoom-desc-detail"}});this._downloadVideoLink=BX.create("A",{props:{className:"crm-entity-stream-content-detail-zoom-desc-link"},text:BX.message("CRM_TIMELINE_ZOOM_DOWNLOAD_VIDEO")});this._downloadSeparator=BX.create("SPAN",{props:{className:"crm-entity-stream-content-detail-zoom-desc-separate"},html:"&mdash;"});this._downloadAudioLink=BX.create("A",{props:{className:"crm-entity-stream-content-detail-zoom-desc-link"},text:BX.message("CRM_TIMELINE_ZOOM_DOWNLOAD_AUDIO")});this.setCurrentRecording(0)}else{this.zoomActivitySubject=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:a})]});s.appendChild(this.zoomActivitySubject);if(n["HAS_RECORDING"]==="Y"){s.appendChild(BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video-inner"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-video-img"}}),BX.create("SPAN",{props:{className:"crm-entity-stream-content-detail-zoom-video-text"},text:BX.message("CRM_TIMELINE_ZOOM_MEETING_RECORD_IN_PROCESS")})]})]}))}}}if(s){l.appendChild(s)}const c=this.prepareAuthorLayout();if(c){r.appendChild(c)}return i}},{key:"_onVideoDummyClick",value:function e(){BX.UI.Hint.hide();const t=this._recordings[this._currentRecordingIndex]["VIDEO"];if(!t){return}this._videoPlayer=this._history.getManager().loadMediaPlayer("zoom_video_"+this.getId(),t["DOWNLOAD_URL"],"video/mp4",this._videoDummy,t["LENGTH"],{video:true,skin:"",width:480,height:270})}},{key:"_onAudioDummyClick",value:function e(){const t=this._recordings[this._currentRecordingIndex]["AUDIO"];if(!t){return}this._history.getManager().getAudioPlaybackRateSelector().addPlayer(this._audioPlayer=this._history.getManager().loadMediaPlayer("zoom_audio_"+this.getId(),t["DOWNLOAD_URL"],"audio/mp4",this._audioDummy,t["LENGTH"],{playbackRate:this._history.getManager().getAudioPlaybackRateSelector().getRate()}))}},{key:"_onTabChange",value:function e(t){this.setCurrentRecording(t.data.tabId)}},{key:"setCurrentRecording",value:function e(t){this._currentRecordingIndex=t;const i=this._recordings[this._currentRecordingIndex]["VIDEO"];const s=this._recordings[this._currentRecordingIndex]["AUDIO"];if(i){this._videoDummy.hidden=false;if(this._videoPlayer){this._videoPlayer.pause();this._videoPlayer.setSource(i["DOWNLOAD_URL"]);this._downloadVideoLink.href=i["DOWNLOAD_URL"]}}else{this._videoDummy.hidden=true}if(s){this._audioDummy.hidden=false;if(this._audioPlayer){this._audioPlayer.pause();this._audioPlayer.setSource(s["DOWNLOAD_URL"])}this._downloadAudioLink.href=s["DOWNLOAD_URL"];this._audioLengthElement.innerText=s["LENGTH_FORMATTED"]}else{this._audioDummy.hidden=true}BX.clean(this._downloadWrapper);if(s||i){const e=s?s["LENGTH_HUMAN"]:i["LENGTH_HUMAN"];this._downloadWrapper.appendChild(this._downloadSubject);this._downloadSubject.innerHTML=BX.util.htmlspecialchars(BX.message("CRM_TIMELINE_ZOOM_MEETING_RECORD").replace("#DURATION#",e))+" &mdash; ";this._downloadWrapper.appendChild(this._downloadSubjectDetail)}if(i){this._downloadSubjectDetail.appendChild(this._downloadVideoLink);this._downloadVideoLink.href=i["DOWNLOAD_URL"];if(s){this._downloadSubjectDetail.appendChild(this._downloadSeparator)}if(this._playVideoLink){this._playVideoLink.lastElementChild.href=i["PLAY_URL"];this._downloadVideoLink.href=i["PLAY_URL"]}if(this._detailZoomCopyVideoLink){BX.clipboard.bindCopyClick(this._detailZoomCopyVideoLink,{text:i["PASSWORD"]})}}if(s){this._downloadSubjectDetail.appendChild(this._downloadAudioLink);this._downloadAudioLink.href=s["DOWNLOAD_URL"]}}},{key:"prepareActions",value:function e(){}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);if(!window["zoom"]){window["zoom"]=[]}window["zoom"].push(n);return n}}]);return t}(HistoryActivity);Zoom.TabsComponent=function(){function e(t){babelHelpers.classCallCheck(this,e);this.tabs=BX.prop.getArray(t,"tabs",[]);this.elements={container:null,tabs:{}};this.eventEmitter=new BX.Event.EventEmitter(this,"Zoom.TabsComponent")}babelHelpers.createClass(e,[{key:"render",value:function e(){if(this.elements.container){return this.elements.container}this.elements.container=BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section-wrapper"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section-list"},children:this.tabs.map(this._renderTab,this)})]});return this.elements.container}},{key:"_renderTab",value:function e(t){const i=t.id;this.elements.tabs[i]=BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section"+(t.active?" crm-entity-stream-content-detail-zoom-section-active":"")},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section-inner"},children:[BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section-title"},text:t.title}),BX.create("DIV",{props:{className:"crm-entity-stream-content-detail-zoom-section-time"},text:t.time})]})],events:{click:function(){this.setActiveTab(t.id)}.bind(this)}});return this.elements.tabs[i]}},{key:"setActiveTab",value:function e(t){if(!this.elements.tabs[t]){throw new Error("Tab "+t+" is not found")}for(let e in this.elements.tabs){if(!this.elements.tabs.hasOwnProperty(e)){continue}e=Number.parseInt(e,10);if(e===t){this.elements.tabs[e].classList.add("crm-entity-stream-content-detail-zoom-section-active")}else{this.elements.tabs[e].classList.remove("crm-entity-stream-content-detail-zoom-section-active")}}this.eventEmitter.emit("onTabChange",{tabId:t})}}]);return e}();let OrderModification=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"getTitle",value:function e(){return this.getTextDataParam("TITLE")}},{key:"getStatusInfo",value:function e(){const t={};let i=null;let s=null;const n=this.getTextDataParam("CHANGED_ENTITY");const a=this.getObjectDataParam("FIELDS");const r=this.getAssociatedEntityData();if(n===BX.CrmEntityType.names.order){if(BX.prop.get(a,"ORDER_CANCELED")==="Y"){i="canceled";s="not-paid"}else if(BX.prop.get(a,"ORDER_DONE")==="Y"){i="done";s="done"}else if(BX.prop.getString(r,"VIEWED","")==="Y"){i="viewed";s="done"}else if(BX.prop.getString(r,"SENT","")==="Y"){i="sent";s="sent"}}if(n===BX.CrmEntityType.names.orderpayment){const e=BX.prop.get(a,"STATUS_CODE",false);if(e){if(e==="ERROR"){i="orderPaymentError";s="payment-error"}}else if(BX.prop.getString(r,"VIEWED","")==="Y"){i="viewed";s="done"}else if(BX.prop.getString(r,"SENT","")==="Y"){i="sent";s="sent"}else{i=BX.prop.get(a,"ORDER_PAID")==="Y"?"paid":"unpaid";s=BX.prop.get(a,"ORDER_PAID")==="Y"?"paid":"not-paid"}}else if(n===BX.CrmEntityType.names.ordershipment&&BX.prop.get(a,"ORDER_DEDUCTED",false)){i=BX.prop.get(a,"ORDER_DEDUCTED")==="Y"?"deducted":"unshipped";s=BX.prop.get(a,"ORDER_DEDUCTED")==="Y"?"shipped":"not-shipped"}else if(n===BX.CrmEntityType.names.ordershipment&&BX.prop.get(a,"ORDER_ALLOW_DELIVERY",false)){i=BX.prop.get(a,"ORDER_ALLOW_DELIVERY")==="Y"?"allowedDelivery":"disallowedDelivery";s=BX.prop.get(a,"ORDER_ALLOW_DELIVERY")==="Y"?"allowed-delivery":"disallowed-delivery"}if(i){t.className="crm-entity-stream-content-event-"+s;t.message=this.getMessage(i)}return t}},{key:"getHeaderChildren",value:function e(){const t=[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},events:{click:this._headerClickHandler},text:this.getTitle()})];const i=this.getStatusInfo();if(BX.type.isNotEmptyObject(i)){t.push(BX.create("SPAN",{attrs:{className:i.className},text:i.message}))}t.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));return t}},{key:"prepareContentDetails",value:function e(){const t=this.getAssociatedEntityData();const i=this.getAssociatedEntityTypeId();const s=this.getAssociatedEntityId();const n=BX.prop.getString(t,"TITLE");const a=BX.prop.getString(t,"HTML_TITLE","");const r=BX.prop.getString(t,"SHOW_URL","");const o=[];if(n!==""){const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});if(r===""||i===this.getOwnerTypeId()&&s===this.getOwnerId()){e.appendChild(BX.create("SPAN",{text:n+" "+a}))}else{if(a===""){e.appendChild(BX.create("A",{attrs:{href:r},text:n}))}else{e.appendChild(BX.create("SPAN",{text:n+" "}));e.appendChild(BX.create("A",{attrs:{href:r},text:a}))}}const l=BX.prop.getString(t,"LEGEND");if(l!==""){e.appendChild(BX.create("SPAN",{html:" "+l}))}const c=BX.prop.getString(t,"SUBLEGEND","");if(c!==""){e.appendChild(BX.create("BR"));e.appendChild(BX.create("SPAN",{text:" "+c}))}o.push(e)}return o}},{key:"prepareViewedContentDetails",value:function e(){const t=this.getAssociatedEntityData();const i=this.getAssociatedEntityTypeId();const s=this.getAssociatedEntityId();const n=BX.prop.getString(t,"TITLE");const a=BX.prop.getString(t,"SHOW_URL","");const r=[];if(n!==""){const e=BX.prop.getString(t,"SUBLEGEND","");if(e!==""){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:e});r.push(t)}if(i===this.getOwnerTypeId()&&s===this.getOwnerId()){r.push(BX.create("SPAN",{text:n}))}else{r.push(BX.create("A",{attrs:{href:a},text:n}))}const o=BX.prop.getString(t,"LEGEND");if(o!==""){r.push(BX.create("SPAN",{html:" "+o}))}}return r}},{key:"prepareSentContentDetails",value:function e(){const t=this.getAssociatedEntityData();const i=this.getAssociatedEntityTypeId();const s=this.getAssociatedEntityId();const n=BX.prop.getString(t,"TITLE");const a=BX.prop.getString(t,"SHOW_URL","");const r=BX.prop.getString(t,"DESTINATION_TITLE","");const o=[];if(n!==""){const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});if(a===""||i===this.getOwnerTypeId()&&s===this.getOwnerId()){e.appendChild(BX.create("SPAN",{text:n}))}else{e.appendChild(BX.create("A",{attrs:{href:a},text:n}))}const l=BX.prop.getString(t,"LEGEND");if(l!==""){e.appendChild(BX.create("SPAN",{html:" "+l}))}if(r){e.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-order-destination"},text:r}))}o.push(e);const c=BX.create("A",{attrs:{href:"#"},text:this.getMessage("orderPaymentProcess"),events:{click:BX.proxy(this.startSalescenterApplication,this)}});o.push(c)}return o}},{key:"startSalescenterApplication",value:function e(){BX.loadExt("salescenter.manager").then(function(){const e=this.getObjectDataParam("FIELDS"),t=BX.prop.get(e,"OWNER_TYPE_ID",BX.CrmEntityType.enumeration.deal);let i=BX.prop.get(e,"OWNER_ID",0);const s=BX.prop.get(e,"PAYMENT_ID",0),n=BX.prop.get(e,"SHIPMENT_ID",0),a=BX.prop.get(e,"ORDER_ID",0);if(!i){i=BX.prop.get(e,"DEAL_ID",0)}BX.Salescenter.Manager.openApplication({disableSendButton:"",context:"deal",ownerTypeId:t,ownerId:i,mode:t===BX.CrmEntityType.enumeration.deal?"payment_delivery":"payment",templateMode:"view",orderId:a,paymentId:s,shipmentId:n})}.bind(this))}},{key:"preparePaidPaymentContentDetails",value:function e(){const t=this.getAssociatedEntityData(),i=BX.prop.getString(t,"TITLE"),s=BX.prop.getString(t,"DATE",""),n=BX.prop.getString(t,"PAY_SYSTEM_NAME",""),a=BX.prop.getString(t,"SUM",""),r=BX.prop.getString(t,"CURRENCY",""),o=[];if(i!==""){const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-payment"}});e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-payment-value"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-payment-text"},html:a}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-payment-currency"},html:r})]}));const i=BX.prop.getString(t,"LOGOTIP",null);if(i){e.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-payment-logo"},style:{backgroundImage:"url("+encodeURI(i)+")"}}))}o.push(e);const l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:[BX.create("SPAN",{text:s}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-description-info"},text:this.getMessage("orderPaySystemTitle")}),BX.create("SPAN",{text:n})]});o.push(l)}return o}},{key:"prepareContent",value:function e(){const t=this.getObjectDataParam("FIELDS"),i=BX.prop.get(t,"ORDER_PAID")==="Y",s=BX.prop.get(t,"PAY_SYSTEM_CLICK")==="Y",n=BX.prop.get(t,"MANUAL_CONTINUE_PAY")==="Y",a=BX.prop.get(t,"NEED_MANUAL_ADD_CHECK")==="Y",r=this.getAssociatedEntityTypeId();if(r===BX.CrmEntityType.enumeration.orderpayment&&i){return this.preparePaidPaymentContent()}else if(r===BX.CrmEntityType.enumeration.orderpayment&&s){return this.prepareClickedPaymentContent()}else if(r===BX.CrmEntityType.enumeration.order&&n){return this.prepareManualContinuePayContent()}else if(r===BX.CrmEntityType.enumeration.orderpayment&&a){return this.prepareManualAddCheck()}return this.prepareItemOrderContent()}},{key:"prepareItemOrderContent",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getString(t,"VIEWED","")==="Y";const s=BX.prop.getString(t,"SENT","")==="Y";const n=this.getObjectDataParam("FIELDS");const a=BX.prop.get(n,"STATUS_CODE",false);const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history"}});r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon "+this.getIconClassName()}}));const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:this.getHeaderChildren()});let c=null;if(i){c=this.prepareViewedContentDetails()}else if(s){c=this.prepareSentContentDetails()}else if(a==="ERROR"){c=this.prepareErrorPaymentContentDetails()}else{c=this.prepareContentDetails()}o.appendChild(l);o.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:c}));const u=this.prepareAuthorLayout();if(u){o.appendChild(u)}r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[o]}));return r}},{key:"preparePaidPaymentContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-wallet"}}));const i=[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getMessage("orderPaymentSuccessTitle")})]})];i.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:i});const a=this.preparePaidPaymentContentDetails();s.appendChild(n);s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:a}));const r=this.prepareAuthorLayout();if(r){s.appendChild(r)}t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));return t}},{key:"prepareErrorPaymentContentDetails",value:function e(){const t=this.getAssociatedEntityData(),i=BX.prop.getString(t,"DATE",""),s=this.getObjectDataParam("FIELDS"),n=BX.prop.getString(s,"PAY_SYSTEM_NAME",""),a=BX.prop.getString(s,"STATUS_DESCRIPTION",""),r=[];const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},children:[BX.create("SPAN",{text:i}),BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-description-info"},text:this.getMessage("orderPaySystemTitle")}),BX.create("SPAN",{text:n})]});r.push(o);const l=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-payment-initiate-pay-error"},text:this.getMessage("orderPaymentStatusErrorReason").replace("#PAYSYSTEM_ERROR#",a)});r.push(l);return r}},{key:"prepareClickedPaymentContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon "+this.getIconClassName()}}));const i=[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]})];i.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())}));const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:i});const a=this.prepareClickedPaymentContentDetails();s.appendChild(n);s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:a}));const r=this.prepareAuthorLayout();if(r){s.appendChild(r)}t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));return t}},{key:"prepareClickedPaymentContentDetails",value:function e(){const t=this.getObjectDataParam("FIELDS"),i=BX.prop.getString(t,"PAY_SYSTEM_NAME",""),s=[];if(i!==""){const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});e.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-clicked-description-info"},text:this.getMessage("orderPaymentPaySystemClick")}));e.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-clicked-description-name"},text:i}));s.push(e)}return s}},{key:"prepareManualContinuePayContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-advice"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-advice"},children:[BX.create("i")]}));const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-advice-info"},text:this.getMessage("orderManualContinuePay")});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-advice-content"},children:[i]}));return t}},{key:"prepareManualAddCheck",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getString(t,"SHOW_URL","");const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-advice"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-advice"}}));const n=this.getMessage("orderManualAddCheck").replace("#HREF#",i);const a=BX.create("DIV",{attrs:{className:"crm-entity-stream-advice-info"},html:n});const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-advice-info"},children:[BX.create("A",{attrs:{className:"crm-entity-stream-content-detail-target",href:"#"},events:{click:BX.delegate((function(e){top.BX.Helper.show("redirect=detail&code=13742126");e.preventDefault?e.preventDefault():e.returnValue=false}))},html:this.getMessage("orderManualAddCheckHelpLink")})]});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-advice-content"},children:[a,r]}));return s}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon-store"}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);babelHelpers.defineProperty(OrderModification,"messages",{});let ExternalNoticeModification=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon-restApp"}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(OrderModification);let ExternalNoticeStatusModification=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareContentDetails",value:function e(){const t=[];const i=[];if(BX.type.isNotEmptyString(this.getTextDataParam("START_NAME"))){i.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detain-info-status"},text:this.getTextDataParam("START_NAME")}));i.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-info-separator-icon"}}))}if(BX.type.isNotEmptyString(this.getTextDataParam("FINISH_NAME"))){i.push(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detain-info-status"},text:this.getTextDataParam("FINISH_NAME")}))}t.push(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-info"},children:i}));return t}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(ExternalNoticeModification);let Creation=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"doInitialize",this).call(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"Creation. The field 'activityEditor' is not assigned."}}},{key:"getTitle",value:function e(){const t=this.getAssociatedEntityTypeId();const i=this.getAssociatedEntityData();if(t===BX.CrmEntityType.enumeration.activity){const e=BX.prop.getInteger(i,"TYPE_ID");const t=this.getMessage(e===BX.CrmActivityType.task?"task":"activity");return t.replace(/#TITLE#/gi,this.cutOffText(BX.prop.getString(i,"SUBJECT")),64)}if(t===BX.CrmEntityType.enumeration.storeDocument){const e=BX.prop.getString(i,"DOC_TYPE");if(e==="A"){return this.getMessage("arrivalDocument")}if(e==="S"){return this.getMessage("storeAdjustmentDocument")}if(e==="M"){return this.getMessage("movingDocument")}if(e==="D"){return this.getMessage("deductDocument")}if(e==="W"){return this.getMessage("shipmentDocument")}return""}const s=BX.CrmEntityType.resolveName(this.getAssociatedEntityTypeId()).toLowerCase();let n=this.getMessage(s);const a=n===s;if(!BX.type.isNotEmptyString(n)||a){n=this.getTextDataParam("TITLE")}return n}},{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-createEntity"}},{key:"prepareContent",value:function e(){const i=this.getAssociatedEntityTypeId();if(i===BX.CrmEntityType.enumeration.ordershipment||i===BX.CrmEntityType.enumeration.orderpayment){const e=this.getData();e.TYPE_CATEGORY_ID=Item.modification;if(e.hasOwnProperty("ASSOCIATED_ENTITY")){e.ASSOCIATED_ENTITY.HTML_TITLE=""}const t=this._history.createOrderEntityItem(e);return t.prepareContent()}return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"prepareContent",this).call(this)}},{key:"prepareContentDetails",value:function e(){const t=this.getAssociatedEntityTypeId();const i=this.getAssociatedEntityId();const s=this.getAssociatedEntityData();if(t===BX.CrmEntityType.enumeration.activity){const e=BX.create("A",{attrs:{href:"#"},html:this.cutOffText(BX.prop.getString(s,"DESCRIPTION_RAW"),128)});BX.bind(e,"click",this._headerClickHandler);return[e]}const n=BX.prop.getString(s,"TITLE","");let a=BX.prop.getString(s,"HTML_TITLE","");const r=BX.prop.getString(s,"SHOW_URL","");if(t===BX.CrmEntityType.enumeration.deal&&BX.prop.getObject(s,"ORDER",null)){const e=BX.prop.getObject(s,"ORDER",null);a=this.getMessage("dealOrderTitle").replace("#ORDER_ID#",e.ID).replace("#DATE_TIME#",e.ORDER_DATE).replace("#HREF#",e.SHOW_URL).replace("#PRICE_WITH_CURRENCY#",e.SUM)}if(n!==""||a!==""){const e=[];if(r===""||t===this.getOwnerTypeId()&&i===this.getOwnerId()){const t=a!==""?{html:a}:{text:n};e.push(BX.create("SPAN",t))}else{let t={attrs:{href:r},text:n};if(a!==""){t={attrs:{href:r},html:a}}e.push(BX.create("A",t))}const s=this.getTextDataParam("LEGEND");if(s!==""){e.push(BX.create("BR"));e.push(BX.create("SPAN",{text:s}))}const o=this.getObjectDataParam("BASE");const l=BX.prop.getObject(o,"ENTITY_INFO");if(l){e.push(BX.create("BR"));e.push(BX.create("SPAN",{text:BX.prop.getString(o,"CAPTION")+": "}));e.push(BX.create("A",{attrs:{href:BX.prop.getString(l,"SHOW_URL","#")},text:BX.prop.getString(l,"TITLE","")}))}return e}return[]}},{key:"view",value:function e(){const t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.activity){const e=this.getAssociatedEntityData();const t=BX.prop.getInteger(e,"ID",0);if(t>0){this._activityEditor.viewActivity(t)}}}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);babelHelpers.defineProperty(Creation,"messages",{});let Restoration=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getTitle",value:function e(){return this.getTextDataParam("TITLE")}},{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-restoreEntity"}},{key:"prepareContentDetails",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getString(t,"TITLE");return i!==""?[BX.create("SPAN",{text:i})]:[]}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);babelHelpers.defineProperty(Restoration,"messages",{});let Relation=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getTitle",value:function e(){return this.getMessage("title")}},{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-createEntity"}},{key:"prepareContentDetails",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"SHOW_URL","");if(i.indexOf("/")!==0){i="#"}const s=this.getMessage("contentTemplate").replace("#ENTITY_TYPE_CAPTION#",BX.Text.encode(BX.prop.getString(t,"ENTITY_TYPE_CAPTION",""))).replace("#LEGEND#","").replace("#LINK#",BX.Text.encode(i)).replace("#LINK_TITLE#",BX.Text.encode(BX.prop.getString(t,"TITLE","")));const n=[];n.push(BX.create("SPAN",{html:s}));return n}}]);return t}(History);let Link=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-link"}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Relation);babelHelpers.defineProperty(Link,"messages",{});let Unlink=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-unlink"}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Relation);babelHelpers.defineProperty(Unlink,"messages",{});let Mark$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"doInitialize",this).call(this);if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"Mark. The field 'activityEditor' is not assigned."}}},{key:"getMessage",value:function e(i){const s=t.messages;if(s.hasOwnProperty(i)){return s[i]}return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"getMessage",this).call(this,i)}},{key:"getTitle",value:function e(){let t="";const i=this.getAssociatedEntityData();const s=this.getAssociatedEntityTypeId();const n=this.getTypeCategoryId();if(s===BX.CrmEntityType.enumeration.activity){const e=BX.prop.getInteger(i,"TYPE_ID",0);const s=BX.prop.getInteger(i,"DIRECTION",0);const a=BX.prop.getString(i,"PROVIDER_ID","");if(e===BX.CrmActivityType.email){if(n===Mark.success){t=this.getMessage((s===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")+"SuccessMark")}else if(n===Mark.renew){t=this.getMessage((s===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")+"RenewMark")}}else if(e===BX.CrmActivityType.call){if(n===Mark.success){t=this.getMessage((s===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")+"SuccessMark")}else if(n===Mark.renew){t=this.getMessage((s===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")+"RenewMark")}}else if(e===BX.CrmActivityType.meeting){if(n===Mark.success){t=this.getMessage("meetingSuccessMark")}else if(n===Mark.renew){t=this.getMessage("meetingRenewMark")}}else if(e===BX.CrmActivityType.task){if(n===Mark.success){t=this.getMessage("taskSuccessMark")}else if(n===Mark.renew){t=this.getMessage("taskRenewMark")}}else if(e===BX.CrmActivityType.provider){if(a==="CRM_REQUEST"){if(n===Mark.success){t=this.getMessage("requestSuccessMark")}else if(n===Mark.renew){t=this.getMessage("requestRenewMark")}}else if(n===Mark.success){t=this.getMessage("webformSuccessMark")}else if(n===Mark.renew){t=this.getMessage("webformRenewMark")}}}else if(s===BX.CrmEntityType.enumeration.deal){if(n===Mark.success){t=this.getMessage("dealSuccessMark")}else if(n===Mark.failed){t=this.getMessage("dealFailedMark")}}else if(s===BX.CrmEntityType.enumeration.order){if(n===Mark.success){t=this.getMessage("orderSuccessMark")}else if(n===Mark.failed){t=this.getMessage("orderFailedMark")}}else{if(BX.CrmEntityType.isDefined(s)){if(n===Mark.success){t=this.getMessage("entitySuccessMark")}else if(n===Mark.failed){t=this.getMessage("entityFailedMark")}}}return t}},{key:"prepareTitleLayout",value:function e(){const t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.order){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getTitle()})}else{return BX.create("A",{attrs:{href:"#",className:"crm-entity-stream-content-event-title"},events:{click:this._headerClickHandler},text:this.getTitle()})}}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();const i=this.getAssociatedEntityTypeId();const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-completed"}});if(this.isFixed())BX.addClass(s,"crm-entity-stream-section-top-fixed");if(this.isContextMenuEnabled()){s.appendChild(this.prepareContextMenuButton())}const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const a=this.prepareHeaderLayout();if(i===BX.CrmEntityType.enumeration.activity){const e=BX.prop.getInteger(t,"TYPE_ID",0);let i="crm-entity-stream-section-icon";if(e===BX.CrmActivityType.email){i+=" crm-entity-stream-section-icon-email"}else if(e===BX.CrmActivityType.call){i+=" crm-entity-stream-section-icon-call"}else if(e===BX.CrmActivityType.meeting){i+=" crm-entity-stream-section-icon-meeting"}else if(e===BX.CrmActivityType.task){i+=" crm-entity-stream-section-icon-task"}else if(e===BX.CrmActivityType.provider){const e=BX.prop.getString(t,"PROVIDER_ID","");if(e==="CRM_WEBFORM"){i+=" crm-entity-stream-section-icon-crmForm"}}s.appendChild(BX.create("DIV",{attrs:{className:i}}));n.appendChild(a);const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});n.appendChild(r);r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.cutOffText(BX.prop.getString(t,"SUBJECT",""),128)})]}));const o=this.getTextDataParam("SUMMARY");if(o!==""){r.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:o}))}}else if(i===BX.CrmEntityType.enumeration.order){s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}));n.appendChild(a);n.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},text:this.cutOffText(this.getTextDataParam("MESSAGE"),128)}))}else{s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}));n.appendChild(a);const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});const r=this.cutOffText(BX.prop.getString(t,"TITLE",""),128);if(BX.CrmEntityType.isDefined(i)){let i=BX.prop.getString(t,"SHOW_URL","");if(i.indexOf("/")!==0){i="#"}const s=this.getMessage("entityContentTemplate").replace("#ENTITY_TYPE_CAPTION#",BX.Text.encode(BX.prop.getString(t,"ENTITY_TYPE_CAPTION",""))).replace("#LINK#",BX.Text.encode(i)).replace("#LINK_TITLE#",BX.Text.encode(r));e.appendChild(BX.create("SPAN",{html:s}))}else{e.innerText=r}n.appendChild(e)}const r=this.prepareAuthorLayout();if(r){n.appendChild(r)}s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[n]}));if(!this.isReadOnly())s.appendChild(this.prepareFixedSwitcherLayout());return s}},{key:"prepareContextMenuItems",value:function e(){const t=[];if(!this.isReadOnly()){if(this.isFixed()||this._fixedHistory.findItemById(this._id))t.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)});else t.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}return t}},{key:"view",value:function e(){const t=this.getAssociatedEntityData();const i=this.getAssociatedEntityTypeId();if(i===BX.CrmEntityType.enumeration.activity){const e=BX.prop.getInteger(t,"ID",0);if(e>0){this._activityEditor.viewActivity(e)}}else{const e=BX.prop.getString(t,"SHOW_URL","");if(e!==""){BX.Crm.Page.open(e)}}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);babelHelpers.defineProperty(Mark$1,"messages",{});let Comment$1=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._isCollapsed=false;e._isMenuShown=false;e._isFixed=false;e._hasFiles=false;e._postForm=null;e._editor=null;e._commentMessage="";e._mode=EditorMode.view;e._streamContentEventBlock="";e._playerWrappers={};BX.Event.EventEmitter.subscribe("BX.Disk.Files:onShowFiles",BX.delegate(e.addPlayer,babelHelpers.assertThisInitialized(e)));return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"doInitialize",this).call(this);this._hasFiles=this.getTextDataParam("HAS_FILES")==="Y"}},{key:"getTitle",value:function e(){return this.getMessage("comment")}},{key:"onPlayerDummyClick",value:function e(t){const i=this._playerWrappers[t.id];const s=i.querySelector(".crm-audio-cap-wrap");if(s){BX.addClass(s,"crm-audio-cap-wrap-loader")}this._history.getManager().getAudioPlaybackRateSelector().addPlayer(this._history.getManager().loadMediaPlayer("history_"+this.getId()+"_"+t.id,t.url,"audio/mp3",i,null,{playbackRate:this._history.getManager().getAudioPlaybackRateSelector().getRate()}))}},{key:"addPlayer",value:function e(t){if(t.data.entityValueId===parseInt(this.getId(),10)){this.files=t.data.files;t.data.files.forEach(function(e){if(e.extension==="mp3"){if(this._playerWrappers[e.id]){return}const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-call crm-entity-stream-content-detail-call-inline"}});this._streamContentEventBlock.appendChild(t);this._playerWrappers[e.id]=this._history.getManager().renderAudioDummy(null,this.onPlayerDummyClick.bind(this,e));this._playerWrappers[e.id].firstElementChild.classList.add("crm-audio-cap-wrap-without-duration-text");t.appendChild(this._playerWrappers[e.id]);t.appendChild(this._history.getManager().getAudioPlaybackRateSelector().render())}}.bind(this))}}},{key:"prepareContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-comment"}});if(this.isReadOnly()){BX.addClass(t,"crm-entity-stream-section-comment-read-only")}if(this.isFixed())BX.addClass(t,"crm-entity-stream-section-top-fixed");t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-comment"}}));if(this.isContextMenuEnabled()){t.appendChild(this.prepareContextMenuButton())}this._streamContentEventBlock=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const i=this.prepareHeaderLayout();this._streamContentEventBlock.appendChild(i);if(!this.isReadOnly())t.appendChild(this.prepareFixedSwitcherLayout());const s=[];if(this._mode!==EditorMode.edit){this._commentWrapper=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"}});BX.html(this._commentWrapper,this.getTextDataParam("COMMENT",""));s.push(this._commentWrapper);if(!this.isReadOnly()){BX.bind(this._commentWrapper,"click",BX.delegate(this.switchToEditMode,this));BX.bind(i,"click",BX.delegate(this.switchToEditMode,this))}}else{if(!BX.type.isDomNode(this._editorContainer))this._editorContainer=BX.create("div",{attrs:{className:"crm-entity-stream-section-comment-editor"}});s.push(this._editorContainer);const e=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-comment-edit-btn-container"},children:[BX.create("button",{attrs:{className:"ui-btn ui-btn-xs ui-btn-primary"},html:this.getMessage("send"),events:{click:BX.delegate(this.save,this)}}),BX.create("a",{attrs:{className:"ui-btn ui-btn-xs ui-btn-link"},html:this.getMessage("cancel"),events:{click:BX.delegate(this.switchToViewMode,this)}})]});s.push(e)}this._streamContentEventBlock.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:s}));const n=this.prepareAuthorLayout();if(n){this._streamContentEventBlock.appendChild(n)}const a=this.getTextDataParam("TEXT","");const r=this.getTextDataParam("HAS_INLINE_ATTACHMENT","")==="Y";if(a.length<=128&&!r||this._mode===EditorMode.edit){this._isCollapsed=false;t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[this._streamContentEventBlock]}))}else{this._isCollapsed=true;t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content crm-entity-stream-section-content-collapsed"},children:[this._streamContentEventBlock]}));t.querySelector(".crm-entity-stream-content-event").appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content-expand-btn-container"},children:[BX.create("A",{attrs:{className:"crm-entity-stream-section-content-expand-btn",href:"#"},events:{click:BX.delegate(this.onExpandButtonClick,this)},text:this.getMessage("expand")})]}))}if(this._mode===EditorMode.view&&this._hasFiles){this._textLoaded=false;this._fileBlock=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-files-inner"},children:[BX.create("DIV",{attrs:{className:"crm-timeline-wait"}})]});t.querySelector(".crm-entity-stream-section-content").appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-files"},children:[this._fileBlock]}));BX.ready(BX.delegate((function(){window.setTimeout(BX.delegate((function(){this.loadContent(this._fileBlock,"GET_FILE_BLOCK")}),this),100)}),this))}return t}},{key:"prepareActions",value:function e(){if(this._mode===EditorMode.view&&BX.type.isDomNode(this._commentWrapper)){this.registerImages(this._commentWrapper);if(!BX.getClass("BX.Disk.apiVersion")){BX.viewElementBind(this._commentWrapper,{showTitle:true},(function(e){return BX.type.isElementNode(e)&&(e.getAttribute("data-bx-viewer")||e.getAttribute("data-bx-image"))}))}}}},{key:"loadContent",value:function e(t,i){if(!BX.type.isDomNode(t))return;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"GET_COMMENT_CONTENT",ID:this.getId(),ENTITY_TYPE_ID:this.getOwnerTypeId(),ENTITY_ID:this.getOwnerId(),TYPE:i},onsuccess:BX.delegate((function(e){if(BX.type.isNotEmptyString(e.ERROR)&&i==="GET_FILE_BLOCK"){BX.remove(t);return}if(BX.type.isNotEmptyString(e.BLOCK)){const i=BX.html(t,e.BLOCK);i.then(BX.delegate((function(){this.registerImages(t);BX.LazyLoad.showImages()}),this))}}),this)})}},{key:"loadEditor",value:function e(){this._editorName="CrmTimeLineComment"+this._id+BX.util.getRandomString(4);if(this._postForm){this._postForm.oEditor.SetContent(this._commentMessage);this._editor.ReInitIframe();return}const t={data:{id:this._id,name:this._editorName}};BX.ajax.runAction("crm.api.timeline.loadEditor",t).then(this.onLoadEditorSuccess.bind(this)).catch(this.switchToViewMode.bind(this))}},{key:"onLoadEditorSuccess",value:function e(t){if(!BX.type.isDomNode(this._editorContainer))this._editorContainer=BX.create("div",{attrs:{className:"crm-entity-stream-section-comment-editor"}});const i=BX.prop.getString(BX.prop.getObject(t,"data",{}),"html","");BX.html(this._editorContainer,i).then(BX.delegate(this.showEditor,this))}},{key:"showEditor",value:function e(){if(LHEPostForm){window.setTimeout(BX.delegate((function(){this._postForm=LHEPostForm.getHandler(this._editorName);this._editor=BXHtmlEditor.Get(this._editorName);BX.onCustomEvent(this._postForm.eventNode,"OnShowLHE",[true]);this._commentMessage=this._postForm.oEditor.GetContent()}),this),0)}}},{key:"registerImages",value:function e(t){const i=t.querySelectorAll('[data-bx-viewer="image"]');const s=i.length;const n=[];if(s>0){for(let e=0;e<s;++e){if(BX.type.isDomNode(i[e])){i[e].id+=BX.util.getRandomString(4);n.push(i[e].id)}}if(n.length>0){BX.LazyLoad.registerImages(n)}}BX.LazyLoad.registerImages(n)}},{key:"toggleMode",value:function e(t){this._mode=parseInt(t);this._hasFiles=this.getTextDataParam("HAS_FILES")==="Y";this.refreshLayout();this.closeContextMenu()}},{key:"switchToViewMode",value:function e(t){this.toggleMode(EditorMode.view)}},{key:"switchToEditMode",value:function e(t){const i=t.target.tagName.toLowerCase();if(i==="a"||i==="img"||BX.hasClass(t.target,"feed-con-file-changes-link-more")||BX.hasClass(t.target,"feed-com-file-inline")||BX.type.isNotEmptyString(document.getSelection().toString())){return}this.toggleMode(EditorMode.edit);window.setTimeout(BX.delegate((function(){this.loadEditor()}),this),100)}},{key:"prepareContextMenuItems",value:function e(){if(this._isMenuShown){return}const t=[];if(!this.isReadOnly()){if(this._mode!==EditorMode.edit){t.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.switchToEditMode,this)})}else{t.push({id:"cancel",text:this.getMessage("menuCancel"),onclick:BX.delegate(this.switchToViewMode,this)})}t.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id))t.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)});else t.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}return t}},{key:"save",value:function e(t){const i=[];let s="";if(this._postForm){s=this._postForm.oEditor.GetContent();this._commentMessage=s;this._postForm.eventNode.querySelectorAll('input[name="UF_CRM_COMMENT_FILES[]"]').forEach((function(e){i.push(e.value)}))}if(!BX.type.isNotEmptyString(s)){if(!this.emptyCommentMessage){this.emptyCommentMessage=new BX.PopupWindow("timeline_empty_comment_"+this._id,t.target,{content:BX.message("CRM_TIMELINE_EMPTY_COMMENT_MESSAGE"),darkMode:true,autoHide:true,zIndex:990,angle:{position:"top",offset:77},closeByEsc:true,bindOptions:{forceBindPosition:true}})}this.emptyCommentMessage.show();return}if(this._isRequestRunning&&BX.type.isNotEmptyString(s)){return}this._isRequestRunning=true;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"UPDATE_COMMENT",ID:this.getId(),TEXT:s,OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ATTACHMENTS:i},onsuccess:BX.delegate(this.onSaveSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})}},{key:"processRemoval",value:function e(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";let t=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!t){t=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getMessage("commentRemove")})}t.open().then(BX.delegate(this.onRemovalConfirm,this),BX.delegate(this.onRemovalCancel,this))}},{key:"onRemovalConfirm",value:function e(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this.remove()}},{key:"onRemovalCancel",value:function e(){}},{key:"remove",value:function e(i){if(this._isRequestRunning){return}const s=this._history._manager.getHistory();const n=s.findItemById(this._id);if(n instanceof t)n.clearAnimate();const a=this._history._manager.getFixedHistory();const r=a.findItemById(this._id);if(r instanceof t)r.clearAnimate();this._isRequestRunning=true;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"DELETE_COMMENT",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this.getId()},onsuccess:BX.delegate(this.onRemoveSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})}},{key:"refreshLayout",value:function e(){this._playerWrappers={};babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"refreshLayout",this).call(this)}},{key:"onSaveSuccess",value:function e(i){this._isRequestRunning=false;const s=BX.prop.getObject(i,"HISTORY_ITEM");const n=this._fixedHistory.findItemById(this._id);if(n instanceof t){if(!BX.type.isNotEmptyString(s["IS_FIXED"]))s["IS_FIXED"]="Y";n.setData(s);n._id=BX.prop.getString(s,"ID");n.switchToViewMode()}const a=this._history.findItemById(this._id);if(a instanceof t){a.setData(s);a._id=BX.prop.getString(s,"ID");a.switchToViewMode()}this._postForm=null}},{key:"onRemoveSuccess",value:function e(t){}},{key:"onRequestFailure",value:function e(t){this._isRequestRunning=this._isLocked=false}},{key:"onExpandButtonClick",value:function e(t){if(!this._wrapper){return BX.PreventDefault(t)}const i=this._wrapper.querySelector("div.crm-entity-stream-section-content");if(!i){return BX.PreventDefault(t)}if(this._hasFiles&&BX.type.isDomNode(this._commentWrapper)&&!this._textLoaded){this._textLoaded=true;this.loadContent(this._commentWrapper,"GET_TEXT")}const s=i.querySelector(".crm-entity-stream-content-event");if(this._isCollapsed){s.style.maxHeight=s.scrollHeight+130+"px";BX.removeClass(i,"crm-entity-stream-section-content-collapsed");BX.addClass(i,"crm-entity-stream-section-content-expand");setTimeout(BX.delegate((function(){s.style.maxHeight=""}),this),300)}else{s.style.maxHeight=s.clientHeight+"px";BX.removeClass(i,"crm-entity-stream-section-content-expand");BX.addClass(i,"crm-entity-stream-section-content-collapsed");setTimeout(BX.delegate((function(){s.style.maxHeight=""}),this),0)}this._isCollapsed=!this._isCollapsed;const n=i.querySelector("a.crm-entity-stream-section-content-expand-btn");if(n){n.innerHTML=this.getMessage(this._isCollapsed?"expand":"collapse")}return BX.PreventDefault(t)}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);let Wait=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getTitle",value:function e(){return this.getMessage("wait")}},{key:"prepareTitleLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:this.getTitle()})]})}},{key:"prepareTimeLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})}},{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContent",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"DESCRIPTION_RAW","");if(i!==""){i=BX.util.trim(i);i=BX.util.strip_tags(i);i=BX.util.nl2br(i)}const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-wait"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-complete"}}));const n=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});s.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[n]}));const a=this.prepareHeaderLayout();n.appendChild(a);const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},html:i});n.appendChild(r);const o=this.prepareAuthorLayout();if(o){n.appendChild(o)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});n.appendChild(this._actionContainer);return s}},{key:"prepareActions",value:function e(){}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Document=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getTitle",value:function e(){const t=BX.prop.getInteger(this._data,"TYPE_CATEGORY_ID",0);if(t===3){return BX.Loc.getMessage("CRM_TIMELINE_DOCUMENT_VIEWED")}return this.getMessage("document")}},{key:"prepareTitleLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:BX.delegate(this.editDocument,this)},text:this.getTitle()})]})}},{key:"prepareTitleStatusLayout",value:function e(){const t=BX.prop.getInteger(this._data,"TYPE_CATEGORY_ID",0);if(t===3){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-done"},text:BX.Loc.getMessage("CRM_TIMELINE_DOCUMENT_VIEWED_STATUS")})}if(t===2){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-sent"},text:BX.Loc.getMessage("CRM_TIMELINE_DOCUMENT_CREATED_STATUS")})}return null}},{key:"prepareTimeLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})}},{key:"isContextMenuEnabled",value:function e(){const t=BX.prop.getInteger(this._data,"TYPE_CATEGORY_ID",0);return t!==3}},{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());const i=this.prepareTitleStatusLayout();if(i){t.appendChild(i)}t.appendChild(this.prepareTimeLayout());return t}},{key:"prepareContent",value:function e(){const t=this.getTextDataParam("COMMENT","");const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-document"}});if(this.isFixed()){BX.addClass(i,"crm-entity-stream-section-top-fixed")}i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-document"}}));if(this.isContextMenuEnabled()){i.appendChild(this.prepareContextMenuButton())}if(!this.isReadOnly()){i.appendChild(this.prepareFixedSwitcherLayout())}const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));const n=this.prepareHeaderLayout();s.appendChild(n);const a=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},html:t});const r=BX.findChildByClassName(a,"document-title-link");if(r){BX.bind(r,"click",BX.proxy(this.editDocument,this))}s.appendChild(a);const o=this.prepareAuthorLayout();if(o){s.appendChild(o)}this._actionContainer=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-detail-action"}});s.appendChild(this._actionContainer);return i}},{key:"prepareActions",value:function e(){}},{key:"showActions",value:function e(t){if(this._actionContainer){this._actionContainer.style.display=t?"":"none"}}},{key:"prepareContextMenuItems",value:function e(){const t=[];if(!this.isReadOnly()){t.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.editDocument,this)});t.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.confirmDelete,this)});if(this.isFixed()||this._fixedHistory.findItemById(this._id)){t.push({id:"unfasten",text:this.getMessage("menuUnfasten"),onclick:BX.delegate(this.unfasten,this)})}else{t.push({id:"fasten",text:this.getMessage("menuFasten"),onclick:BX.delegate(this.fasten,this)})}}return t}},{key:"confirmDelete",value:function e(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";let t=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!t){t=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getMessage("documentRemove")})}t.open().then(BX.delegate(this.onConfirmDelete,this),BX.DoNothing)}},{key:"onConfirmDelete",value:function e(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this.deleteDocument()}},{key:"deleteDocument",value:function e(){if(this._isRequestRunning){return}this._isRequestRunning=true;BX.ajax({url:this._history._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"DELETE_DOCUMENT",OWNER_TYPE_ID:this.getOwnerTypeId(),OWNER_ID:this.getOwnerId(),ID:this.getId()},onsuccess:BX.delegate((function(e){this._isRequestRunning=false;if(BX.type.isNotEmptyString(e.ERROR)){alert(e.ERROR)}else{const e=this._history.findItemById(this._id);if(e instanceof t){e.clearAnimate()}const i=this._fixedHistory.findItemById(this._id);if(i instanceof t){i.clearAnimate()}}}),this),onfailure:BX.delegate((function(){this._isRequestRunning=false}),this)})}},{key:"editDocument",value:function e(){const t=this.getData().DOCUMENT_ID||0;if(t>0){let e="/bitrix/components/bitrix/crm.document.view/slider.php";e=BX.util.add_url_param(e,{documentId:t});if(BX.SidePanel){BX.SidePanel.Instance.open(e,{width:1060})}else{top.location.href=e}}}},{key:"updateWrapper",value:function e(){const t=this.getWrapper();if(t){const e=BX.findChildByClassName(t,"crm-entity-stream-content-detail");if(e){BX.adjust(e,{html:this.getTextDataParam("COMMENT","")});const t=BX.findChildByClassName(e,"document-title-link");if(t){BX.bind(t,"click",BX.proxy(this.editDocument,this))}}}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Sender=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getDataSetting",value:function e(t){const i=this.getObjectDataParam("SETTINGS")||{};return i[t]||null}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"getTitle",value:function e(){return this.getDataSetting("messageName")}},{key:"prepareTitleLayout",value:function e(){const t=this;return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},children:[this.isRemoved()?BX.create("SPAN",{text:this.getTitle()}):BX.create("A",{attrs:{href:""},events:{click:function(e){if(BX.SidePanel){BX.SidePanel.Instance.open(t.getDataSetting("path"))}else{top.location.href=t.getDataSetting("path")}e.preventDefault();e.stopPropagation()}},text:this.getTitle()})]})}},{key:"prepareTimeLayout",value:function e(){return BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:this.formatTime(this.getCreatedTime())})}},{key:"prepareStatusLayout",value:function e(){let t,i;if(this.getDataSetting("isError")){i=this.getMessage("error");t="crm-entity-stream-content-event-missing"}else if(this.getDataSetting("isUnsub")){i=this.getMessage("unsub");t="crm-entity-stream-content-event-missing"}else if(this.getDataSetting("isClick")){i=this.getMessage("click");t="crm-entity-stream-content-event-successful"}else{i=this.getMessage("read");t="crm-entity-stream-content-event-skipped"}return BX.create("SPAN",{attrs:{className:t},text:i})}},{key:"prepareHeaderLayout",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});t.appendChild(this.prepareTitleLayout());if(this.getDataSetting("isError")||this.getDataSetting("isRead")||this.getDataSetting("isUnsub")){t.appendChild(this.prepareStatusLayout())}t.appendChild(this.prepareTimeLayout());return t}},{key:"isRemoved",value:function e(){return!this.getDataSetting("letterTitle")}},{key:"prepareContent",value:function e(){const t=this.isRemoved()?this.getMessage("removed"):this.getMessage("title")+": "+this.getDataSetting("letterTitle");const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-wait"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-complete"}}));const s=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[s]}));const n=this.prepareHeaderLayout();s.appendChild(n);const a=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},html:t});s.appendChild(a);const r=this.prepareAuthorLayout();if(r){s.appendChild(r)}return i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(HistoryActivity);let Bizproc=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getTitle",value:function e(){const t=this.getTextDataParam("TYPE");if(t==="AUTOMATION_DEBUG_INFORMATION"){return this.getMessage("automationDebugger")}return this.getMessage("bizproc")}},{key:"prepareContent",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-bp"}});t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-bp"}}));const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});const s=this.prepareHeaderLayout();i.appendChild(s);i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},html:this.prepareContentTextHtml()})]}));const n=this.prepareAuthorLayout();if(n){i.appendChild(n)}t.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[i]}));return t}},{key:"prepareContentTextHtml",value:function e(){const t=this.getTextDataParam("TYPE");if(t==="ACTIVITY_ERROR"){return"<strong>#TITLE#</strong>: #ERROR_TEXT#".replace("#TITLE#",BX.util.htmlspecialchars(this.getTextDataParam("ACTIVITY_TITLE"))).replace("#ERROR_TEXT#",BX.util.htmlspecialchars(this.getTextDataParam("ERROR_TEXT")))}else if(t==="AUTOMATION_DEBUG_INFORMATION"){return BX.Text.encode(this.getTextDataParam("AUTOMATION_DEBUG_TEXT"))}const i=this.getTextDataParam("WORKFLOW_TEMPLATE_NAME");const s=this.getTextDataParam("WORKFLOW_STATUS_NAME");if(!i||s!=="Created"&&s!=="Completed"&&s!=="Terminated"){return BX.util.htmlspecialchars(this.getTextDataParam("COMMENT"))}let n=BX.message("CRM_TIMELINE_BIZPROC_CREATED");if(s==="Completed"){n=BX.message("CRM_TIMELINE_BIZPROC_COMPLETED")}else if(s==="Terminated"){n=BX.message("CRM_TIMELINE_BIZPROC_TERMINATED")}return BX.util.htmlspecialchars(n).replace("#NAME#","<strong>"+BX.util.htmlspecialchars(i)+"</strong>")}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);let Scoring=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"prepareContent",value:function e(){const t=BX.prop.getBoolean(this._data,"SCORING_IS_AVAILABLE",true);const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-scoring"},events:t?{click:function(){let e="/crm/ml/#entity#/#id#/detail";const t=this.getOwnerTypeId();const i=this.getOwnerId();let s="";if(t===1){s="lead"}else if(t===2){s="deal"}else{return}e=e.replace("#entity#",s);e=e.replace("#id#",i);if(BX.SidePanel){BX.SidePanel.Instance.open(e,{width:840})}else{top.location.href=e}}.bind(this)}:null});const s=BX.prop.getObject(this._data,"SCORING_INFO",null);if(!s){return i}let n=BX.prop.getNumber(s,"SCORE",0);let a=BX.prop.getNumber(s,"SCORE_DELTA",0);n=Math.round(n*100);a=Math.round(a*100);const r=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-scoring-total-result"},text:n+"%"});let o="crm-entity-stream-content-scoring-total-icon";if(n<50){o+=" crm-entity-stream-content-scoring-total-icon-fail"}else if(n<75){o+=" crm-entity-stream-content-scoring-total-icon-middle"}else{o+=" crm-entity-stream-content-scoring-total-icon-success"}const l=BX.create("DIV",{attrs:{className:o}});i.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-scoring-total"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-scoring-total-text"},text:BX.message("CRM_TIMELINE_SCORING_TITLE_2")}),r,l]}),BX.create("DIV",{attrs:{className:"crm-entity-stream-content-scoring-event"},children:[a!==0?BX.create("DIV",{attrs:{className:"crm-entity-stream-content-scoring-event-offset"},text:(a>0?"+":"")+a+"%"}):null]})]}));return i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(History);let History$1=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._items=[];e._wrapper=null;e._fixedHistory=null;e._emptySection=null;e._currentDaySection=null;e._lastDaySection=null;e._lastDate=null;e._anchor=null;e._history=babelHelpers.assertThisInitialized(e);e._enableLoading=false;e._navigation=null;e._scrollHandler=null;e._loadingWaiter=null;e._filterId="";e._isFilterApplied=false;e._isFilterShown=false;e._isRequestRunning=false;e._filterButton=null;e._filterWrapper=null;e._filterResultStub=null;return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){this._fixedHistory=this.getSetting("fixedHistory");this._ownerTypeId=this.getSetting("ownerTypeId");this._ownerId=this.getSetting("ownerId");this._serviceUrl=this.getSetting("serviceUrl","");if(!this.isStubMode()){let e=this.getSetting("itemData");if(!BX.type.isArray(e)){e=[]}let t,i,s;for(t=0,i=e.length;t<i;t++){s=this.createItem(e[t]);if(s){this._items.push(s)}}this._navigation=this.getSetting("navigation",{});this._filterWrapper=BX("timeline-filter");this._filterId=BX.prop.getString(this._settings,"filterId",this._id);this._isFilterShown=this._filterWrapper&&BX.hasClass(this._filterWrapper,"crm-entity-stream-section-filter-show");this._isFilterApplied=BX.prop.getBoolean(this._settings,"isFilterApplied",false);BX.addCustomEvent("BX.Main.Filter:apply",this.onFilterApply.bind(this))}}},{key:"layout",value:function e(){this._wrapper=BX.create("DIV",{});this._container.appendChild(this._wrapper);const t=BX.prop.extractDate(new Date);let i,s,n;if(!this.isStubMode()){if(this._filterWrapper){const e=this._filterWrapper.querySelector(".crm-entity-stream-filter-close");if(e){BX.bind(e,"click",this.onFilterClose.bind(this))}}for(i=0,s=this._items.length;i<s;i++){n=this._items[i];n.setContainer(this._wrapper);const e=n.getCreatedDate();if(this._lastDate===null||this._lastDate.getTime()!==e.getTime()){this._lastDate=e;if(t.getTime()===e.getTime()){this._currentDaySection=this._lastDaySection=this.createCurrentDaySection();this._wrapper.appendChild(this._currentDaySection)}else{this._lastDaySection=this.createDaySection(this._lastDate);this._wrapper.appendChild(this._lastDaySection)}}n._lastDate=this._lastDate;n.layout()}this.enableLoading(this._items.length>0);this.refreshLayout()}else{this._currentDaySection=this._lastDaySection=this.createCurrentDaySection();this._wrapper.appendChild(this._currentDaySection);this._wrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-createEntity crm-entity-stream-section-last"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-icon crm-entity-stream-section-icon-info"}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},text:BX.message("CRM_TIMELINE_HISTORY_STUB")})]})]})]}))}this._manager.processHistoryLayoutChange()}},{key:"refreshLayout",value:function e(){if(this._filterWrapper){if(this._wrapper.firstChild&&this._filterWrapper!==this._wrapper.firstChild){this._wrapper.insertBefore(this._filterWrapper,this._wrapper.firstChild)}else if(!this._wrapper.firstChild&&this._filterWrapper.parentNode!==this._wrapper){this._wrapper.appendChild(this._filterWrapper)}}this.adjustFilterButton();const t=this._items.length;if(t===0&&this._isFilterApplied){if(!this._filterEmptyResultSection){this._filterEmptyResultSection=this.createFilterEmptyResultSection()}this._wrapper.appendChild(this._filterEmptyResultSection);return}if(this._filterEmptyResultSection){this._filterEmptyResultSection=BX.remove(this._filterEmptyResultSection)}if(t===0){return}for(let e=0;e<t-1;e++){const t=this._items[e];if(t.isTerminated()){t.markAsTerminated(false)}}this._items[t-1].markAsTerminated(true)}},{key:"calculateItemIndex",value:function e(t){return 0}},{key:"checkItemForTermination",value:function e(t){return this.getLastItem()===t}},{key:"hasContent",value:function e(){return this._items.length>0||this._isFilterApplied||this._isStubMode}},{key:"getItems",value:function e(){return this._items}},{key:"setItems",value:function e(t){this._items=t}},{key:"getItemByIndex",value:function e(t){return t<this._items.length?this._items[t]:null}},{key:"getItemCount",value:function e(){return this._items.length}},{key:"getItemsByAssociatedEntity",value:function e(t,i){if(!BX.type.isNumber(t)){t=parseInt(t)}if(!BX.type.isNumber(i)){i=parseInt(i)}if(isNaN(t)||t<=0||isNaN(i)||i<=0){return[]}const s=[];for(let e=0,n=this._items.length;e<n;e++){const n=this._items[e];if(n.getAssociatedEntityTypeId()===t&&n.getAssociatedEntityId()===i){s.push(n)}}return s}},{key:"createFilterEmptyResultSection",value:function e(){return BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-filter-empty"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-filter-empty"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-filter-empty-img"}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-filter-empty-text"},text:this.getMessage("filterEmptyResultStub")})]})]})]})}},{key:"adjustFilterButton",value:function e(){if(!this._filterWrapper){return}if(!this._isFilterShown&&this._items.length===0){if(!this._emptySection){this._emptySection=this.createEmptySection()}this._wrapper.insertBefore(this._emptySection,this._filterWrapper)}else if(this._emptySection){this._emptySection=BX.remove(this._emptySection)}if(!this._filterButton){this._filterButton=BX.create("BUTTON",{attrs:{className:"crm-entity-stream-filter-label"},text:this.getMessage("filterButtonCaption")});BX.bind(this._filterButton,"click",function(e){this.showFilter()}.bind(this))}const t=this._wrapper.querySelector(".crm-entity-stream-section-today-label, .crm-entity-stream-section-planned-label, .crm-entity-stream-section-history-label");if(t){const e=t.querySelector(".crm-entity-stream-section-content");if(e){if(this._filterButton.parentNode!==e){e.appendChild(this._filterButton)}}}if(this._isFilterApplied){BX.addClass(this._filterButton,"crm-entity-stream-filter-label-active")}else{BX.removeClass(this._filterButton,"crm-entity-stream-filter-label-active")}}},{key:"showFilter",value:function e(t){if(!this._filterWrapper){return}BX.removeClass(this._filterWrapper,"crm-entity-stream-section-filter-hide");BX.addClass(this._filterWrapper,"crm-entity-stream-section-filter-show");this._isFilterShown=true;if(BX.prop.getBoolean(t,"enableAdjust",true)){this.adjustFilterButton()}}},{key:"hideFilter",value:function e(t){if(!this._filterWrapper){return}BX.removeClass(this._filterWrapper,"crm-entity-stream-section-filter-show");BX.addClass(this._filterWrapper,"crm-entity-stream-section-filter-hide");this._isFilterShown=false;if(BX.prop.getBoolean(t,"enableAdjust",true)){this.adjustFilterButton()}}},{key:"onFilterClose",value:function e(t){this.hideFilter();window.setTimeout(function(){const e=BX.Main.filterManager.getById(this._filterId);if(e){e.resetFilter()}}.bind(this),500)}},{key:"createEmptySection",value:function e(){return BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-planned-label"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}})]})}},{key:"createCurrentDaySection",value:function e(){let t=this.formatDate(BX.prop.extractDate(new Date));t=t[0].toUpperCase()+t.substring(1);return BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-today-label"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-today-label"},text:t})]})]})}},{key:"createDaySection",value:function e(t){let i=this.formatDate(t);i=i[0].toUpperCase()+i.substring(1);return BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-history-label"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-history-label"},text:i})]})]})}},{key:"createAnchor",value:function e(t){if(this._emptySection){this._emptySection=BX.remove(this._emptySection)}if(this._currentDaySection===null){this._currentDaySection=this.createCurrentDaySection();if(this._wrapper.firstChild){this._wrapper.insertBefore(this._currentDaySection,this._wrapper.firstChild)}else{this._wrapper.appendChild(this._currentDaySection)}}if(this._anchor===null){this._anchor=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-shadow"}});if(this._currentDaySection.nextSibling){this._wrapper.insertBefore(this._anchor,this._currentDaySection.nextSibling)}else{this._wrapper.appendChild(this._anchor)}}return this._anchor}},{key:"createActivityItem",value:function e(t){const i=BX.prop.getInteger(t,"TYPE_ID",Item.undefined);const s=BX.prop.getInteger(t,"TYPE_CATEGORY_ID",0);const n=BX.prop.getString(BX.prop.getObject(t,"ASSOCIATED_ENTITY",{}),"PROVIDER_ID","");if(i!==Item.activity){return null}if(s===BX.CrmActivityType.email){return Email$1.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}if(s===BX.CrmActivityType.call){return Call$1.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(s===BX.CrmActivityType.meeting){return Meeting.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(s===BX.CrmActivityType.task){return Task.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(s===BX.CrmActivityType.provider){if(n==="CRM_WEBFORM"){return WebForm.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(n==="CRM_REQUEST"){return Request.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(n==="IMOPENLINES_SESSION"){return OpenLine$1.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(n==="REST_APP"){return Rest.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(n==="VISIT_TRACKER"){return Visit.create(t["ID"],{history:this,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(n==="ZOOM"){return Zoom.create(t["ID"],{history:this,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(n==="CRM_CALL_TRACKER"){return Call$1.create(t["ID"],{history:this,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}}return HistoryActivity.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}},{key:"createExternalNotificationItem",value:function e(t){const i=BX.prop.getInteger(t,"TYPE_CATEGORY_ID",0);const s=BX.prop.getString(t,"CHANGED_FIELD_NAME","");if(i===Item.modification&&s==="STATUS_ID"){return ExternalNoticeStatusModification.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:t})}return ExternalNoticeModification.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:t})}},{key:"createItem",value:function e(t){if(t.hasOwnProperty("type")){return crm_timeline_item.ConfigurableItem.create(t.id,{timelineId:this.getId(),container:this.getWrapper(),itemClassName:this.getItemClassName(),useShortTimeFormat:this.getStreamType()===crm_timeline_item.StreamType.history,isReadOnly:this.isReadOnly(),currentUser:this._manager.getCurrentUser(),ownerTypeId:this._manager.getOwnerTypeId(),ownerId:this._manager.getOwnerId(),streamType:this.getStreamType(),data:t})}const i=BX.prop.getInteger(t,"TYPE_ID",Item.undefined);const s=BX.prop.getInteger(t,"TYPE_CATEGORY_ID",0);if(i===Item.activity){return this.createActivityItem(t)}else if(i===Item.externalNotification){return this.createExternalNotificationItem(t)}else if(i===Item.creation){return Creation.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.restoration){return Restoration.create(t["ID"],{history:this._history,container:this._wrapper,data:t})}else if(i===Item.link){return Link.create(t["ID"],{history:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.unlink){return Unlink.create(t["ID"],{history:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.mark){return Mark$1.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,fixedHistory:this._fixedHistory,data:t})}else if(i===Item.comment){return Comment$1.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.wait){return Wait.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.document){return Document.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.sender){return Sender.create(t["ID"],{history:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.modification){return Modification.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.conversion){return Conversion.create(t["ID"],{history:this._history,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.bizproc){return Bizproc.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i===Item.scoring){return Scoring.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}return History.create(t["ID"],{history:this._history,fixedHistory:this._fixedHistory,container:this._wrapper,activityEditor:this._activityEditor,data:t})}},{key:"getWrapper",value:function e(){return this._wrapper}},{key:"getItemClassName",value:function e(){return"crm-entity-stream-section crm-entity-stream-section-history"}},{key:"addItem",value:function e(t,i){if(!BX.type.isNumber(i)||i<0){i=this.calculateItemIndex(t)}if(i<this._items.length){this._items.splice(i,0,t)}else{this._items.push(t)}this.refreshLayout();this._manager.processHistoryLayoutChange()}},{key:"deleteItem",value:function e(t){const i=this.getItemIndex(t);if(i<0){return}t.clearLayout();this.removeItemByIndex(i);this.refreshLayout();this._manager.processHistoryLayoutChange()}},{key:"resetLayout",value:function e(){let t;for(t=this._items.length-1;t>=0;t--){this._items[t].clearLayout()}this._items=[];this._currentDaySection=this._lastDaySection=this._emptySection=this._filterEmptyResultSection=null;this._anchor=null;this._lastDate=null;const i=[];let s;for(t=0;s=this._wrapper.children[t];t++){if(s!==this._filterWrapper){i.push(s)}}for(t=0;s=i[t];t++){this._wrapper.removeChild(s)}}},{key:"onWindowScroll",value:function e(t){if(!this._loadingWaiter||!this._enableLoading||this._isRequestRunning){return}const i=this._loadingWaiter.getBoundingClientRect();if(i.top<=document.documentElement.clientHeight){this.loadItems()}}},{key:"onFilterApply",value:function e(t,i,s,n,a){if(t!==this._filterId){return}a.autoResolve=false;this._isFilterApplied=BX.prop.getString(i,"action","")==="apply";this._isRequestRunning=true;BX.CrmDataLoader.create(this._id,{serviceUrl:this.getSetting("serviceUrl",""),action:"GET_HISTORY_ITEMS",params:{GUID:this._id,OWNER_TYPE_ID:this._manager.getOwnerTypeId(),OWNER_ID:this._manager.getOwnerId()}}).load(function(e,t){this.resetLayout();this.bulkCreateItems(BX.prop.getArray(t,"HISTORY_ITEMS",[]));this.setNavigation(BX.prop.getObject(t,"HISTORY_NAVIGATION",{}));this.refreshLayout();if(this._items.length>0){this._manager.processHistoryLayoutChange()}n.fulfill();this._isRequestRunning=false}.bind(this))}},{key:"bulkCreateItems",value:function e(t){const i=t.length;if(i===0){return}if(this._filterEmptyResultSection){this._filterEmptyResultSection=BX.remove(this._filterEmptyResultSection)}const s=BX.prop.extractDate(new Date);let n,a;for(n=0;n<i;n++){const e=BX.prop.getInteger(t[n],"id",BX.prop.getInteger(t[n],"ID",0));if(e<=0){continue}if(this.findItemById(e)!==null){continue}a=this.createItem(t[n]);this._items.push(a);const i=a.getCreatedDate();if(this._lastDate===null||this._lastDate.getTime()!==i.getTime()){this._lastDate=i;if(s.getTime()===i.getTime()){this._currentDaySection=this._lastDaySection=this.createCurrentDaySection();this._wrapper.appendChild(this._currentDaySection)}else{this._lastDaySection=this.createDaySection(this._lastDate);this._wrapper.appendChild(this._lastDaySection)}}a.layout()}}},{key:"loadItems",value:function e(){this._isRequestRunning=true;BX.CrmDataLoader.create(this._id,{serviceUrl:this.getSetting("serviceUrl",""),action:"GET_HISTORY_ITEMS",params:{GUID:this._id,OWNER_TYPE_ID:this._manager.getOwnerTypeId(),OWNER_ID:this._manager.getOwnerId(),NAVIGATION:this._navigation}}).load(function(e,t){this.bulkCreateItems(BX.prop.getArray(t,"HISTORY_ITEMS",[]));this.setNavigation(BX.prop.getObject(t,"HISTORY_NAVIGATION",{}));this.refreshLayout();if(this._items.length>0){this._manager.processHistoryLayoutChange()}this._isRequestRunning=false}.bind(this))}},{key:"getNavigation",value:function e(){return this._navigation}},{key:"setNavigation",value:function e(t){if(!BX.type.isPlainObject(t)){t={}}this._navigation=t;this.enableLoading(BX.prop.getString(this._navigation,"OFFSET_TIMESTAMP","")!=="")}},{key:"isLoadingEnabled",value:function e(){return this._enableLoading}},{key:"enableLoading",value:function e(t){t=!!t;if(this._enableLoading===t){return}this._enableLoading=t;if(this._enableLoading){if(this._items.length>0){this._loadingWaiter=this._items[this._items.length-1].getWrapper()}if(!this._scrollHandler){this._scrollHandler=BX.delegate(this.onWindowScroll,this);BX.bind(window,"scroll",this._scrollHandler)}}else{this._loadingWaiter=null;if(this._scrollHandler){BX.unbind(window,"scroll",this._scrollHandler);this._scrollHandler=null}}}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"animateItemAdding",value:function e(t){return new Promise((e=>{Expand.create(t.getWrapper(),e).run()}))}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);t.instances[n.getId()]=n;return n}}]);return t}(Steam);babelHelpers.defineProperty(History$1,"messages",{});babelHelpers.defineProperty(History$1,"instances",{});let FixedHistory=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._items=[];e._wrapper=null;e._fixedHistory=babelHelpers.assertThisInitialized(e);e._history=babelHelpers.assertThisInitialized(e);e._isRequestRunning=false;return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){const t=BX.message("FORMAT_DATETIME").replace(/:SS/,"");this._timeFormat=BX.date.convertBitrixFormat(t);let i=this.getSetting("itemData");if(!BX.type.isArray(i)){i=[]}let s,n,a;for(s=0,n=i.length;s<n;s++){a=this.createItem(i[s]);a._isFixed=true;this._items.push(a)}}},{key:"setHistory",value:function e(t){this._history=t}},{key:"checkItemForTermination",value:function e(t){return false}},{key:"layout",value:function e(){this._wrapper=BX.create("DIV",{});this.createAnchor();this._container.insertBefore(this._wrapper,this._editorContainer.nextElementSibling);for(let e=0;e<this._items.length;e++){this._items[e].setContainer(this._wrapper);this._items[e].layout()}this.refreshLayout();this._manager.processHistoryLayoutChange()}},{key:"refreshLayout",value:function e(){}},{key:"formatDate",value:function e(t){}},{key:"createCurrentDaySection",value:function e(){}},{key:"createDaySection",value:function e(t){}},{key:"createAnchor",value:function e(t){this._anchor=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-fixed-anchor"}});this._wrapper.appendChild(this._anchor)}},{key:"onWindowScroll",value:function e(t){}},{key:"onItemsLoad",value:function e(t,i){}},{key:"loadItems",value:function e(){this._isRequestRunning=true;BX.CrmDataLoader.create(this._id,{serviceUrl:this.getSetting("serviceUrl",""),action:"GET_FIXED_HISTORY_ITEMS",params:{OWNER_TYPE_ID:this._manager.getOwnerTypeId(),OWNER_ID:this._manager.getOwnerId()}}).load(BX.delegate(this.onItemsLoad,this))}},{key:"addItem",value:function e(i,s){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"addItem",this).call(this,i,s);if(i instanceof CompatibleItem){i._isFixed=true}}},{key:"getItemClassName",value:function e(){return"crm-entity-stream-section crm-entity-stream-section-history crm-entity-stream-section-top-fixed"}},{key:"getStreamType",value:function e(){return crm_timeline_item.StreamType.pinned}}],[{key:"create",value:function e(i,s){let n=new t;n.initialize(i,s);this.instances[n.getId()]=n;return n}}]);return t}(History$1);FixedHistory.instances={};let SchedulePostponeController=function(){function e(){babelHelpers.classCallCheck(this,e);this._item=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._item=BX.prop.get(this._settings,"item",null)}},{key:"getTitle",value:function e(){return this.getMessage("title")}},{key:"getCommandList",value:function e(){return[{name:"postpone_hour_1",title:this.getMessage("forOneHour")},{name:"postpone_hour_2",title:this.getMessage("forTwoHours")},{name:"postpone_hour_3",title:this.getMessage("forThreeHours")},{name:"postpone_day_1",title:this.getMessage("forOneDay")},{name:"postpone_day_2",title:this.getMessage("forTwoDays")},{name:"postpone_day_3",title:this.getMessage("forThreeDays")}]}},{key:"processCommand",value:function e(t){if(t.indexOf("postpone")!==0){return false}let i=0;if(t==="postpone_hour_1"){i=3600}else if(t==="postpone_hour_2"){i=7200}else if(t==="postpone_hour_3"){i=10800}else if(t==="postpone_day_1"){i=86400}else if(t==="postpone_day_2"){i=172800}else if(t==="postpone_day_3"){i=259200}if(i>0&&this._item){this._item.postpone(i)}return true}},{key:"getMessage",value:function t(i){const s=e.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function t(i,s){const n=new e;n.initialize(i,s);return n}}]);return e}();babelHelpers.defineProperty(SchedulePostponeController,"messages",{});let Activity$1=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._postponeController=null;return e}babelHelpers.createClass(t,[{key:"getTypeId",value:function e(){return Item.activity}},{key:"isDone",value:function e(){const t=BX.prop.getInteger(this.getAssociatedEntityData(),"STATUS");return t===BX.CrmActivityStatus.completed||t===BX.CrmActivityStatus.autoCompleted}},{key:"setAsDone",value:function e(t){t=!!t;if(this.isDone()===t){return}const i=BX.prop.getInteger(this.getAssociatedEntityData(),"ID",0);if(i>0){this._activityEditor.setActivityCompleted(i,t,BX.delegate(this.onSetAsDoneCompleted,this))}}},{key:"postpone",value:function e(t){const i=this.getSourceId();if(i>0&&t>0){this._activityEditor.postponeActivity(i,t,BX.delegate(this.onPosponeCompleted,this))}}},{key:"view",value:function e(){const t=BX.prop.getInteger(this.getAssociatedEntityData(),"ID",0);if(t>0){this._activityEditor.viewActivity(t)}}},{key:"edit",value:function e(){this.closeContextMenu();const t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.activity){const e=this.getAssociatedEntityData();const t=BX.prop.getInteger(e,"ID",0);if(t>0){this._activityEditor.editActivity(t)}}}},{key:"processRemoval",value:function e(){this.closeContextMenu();this._detetionConfirmDlgId="entity_timeline_deletion_"+this.getId()+"_confirm";let t=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!t){t=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("removeConfirmTitle"),content:this.getRemoveMessage()})}t.open().then(BX.delegate(this.onRemovalConfirm,this),BX.delegate(this.onRemovalCancel,this))}},{key:"getRemoveMessage",value:function e(){return this.getMessage("removeConfirm")}},{key:"onRemovalConfirm",value:function e(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this.remove()}},{key:"onRemovalCancel",value:function e(){}},{key:"remove",value:function e(){const t=this.getAssociatedEntityTypeId();if(t===BX.CrmEntityType.enumeration.activity){const e=this.getAssociatedEntityData();const t=BX.prop.getInteger(e,"ID",0);if(t>0){const e=this._activityEditor;const i=e.getItemById(t);if(i){e.deleteActivity(t,true)}else{const i=e.getSetting("ownerType","");const s=e.getSetting("ownerID","");const n=BX.util.add_url_param(e.getSetting("serviceUrl",""),{id:t,action:"get_activity",ownertype:i,ownerid:s});BX.ajax({url:n,method:"POST",dataType:"json",data:{ACTION:"GET_ACTIVITY",ID:t,OWNER_TYPE:i,OWNER_ID:s},onsuccess:BX.delegate((function(t){if(typeof t["ACTIVITY"]!=="undefined"){e._handleActivityChange(t["ACTIVITY"]);window.setTimeout(BX.delegate(this.remove,this),500)}}),this),onfailure:function(e){}})}}}}},{key:"getDeadline",value:function e(){const t=this.getAssociatedEntityData();const i=BX.parseDate(t["DEADLINE_SERVER"],false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");if(!i){return null}return new crm_timeline_tools.DatetimeConverter(i).toUserTime().getValue()}},{key:"getLightTime",value:function e(){const t=this.getAssociatedEntityData();const i=BX.parseDate(t["LIGHT_TIME_SERVER"],false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");if(!i){return null}return new crm_timeline_tools.DatetimeConverter(i).toUserTime().getValue()}},{key:"getCreatedDate",value:function e(){const t=this.getAssociatedEntityData();const i=BX.parseDate(t["CREATED_SERVER"],false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");if(!i){return null}return new crm_timeline_tools.DatetimeConverter(i).toUserTime().getValue()}},{key:"isIncomingChannel",value:function e(){if(this.isDone()){return false}const t=this.getAssociatedEntityData();return t.hasOwnProperty("IS_INCOMING_CHANNEL")&&t.IS_INCOMING_CHANNEL==="Y"}},{key:"markAsDone",value:function e(t){t=!!t;this.getAssociatedEntityData()["STATUS"]=t?BX.CrmActivityStatus.completed:BX.CrmActivityStatus.waiting}},{key:"getPrepositionText",value:function e(t){return this.getMessage(t===BX.CrmActivityDirection.incoming?"from":"to")}},{key:"getTypeDescription",value:function e(t){return""}},{key:"isContextMenuEnabled",value:function e(){return!!this.getDeadline()&&this.canPostpone()||this.canComplete()}},{key:"prepareContent",value:function e(t){let i="";const s=this.isIncomingChannel();if(s){i=this.formatDateTime(this.getCreatedDate())}else{const e=this.getDeadline();i=e?this.formatDateTime(e):this.getMessage("termless")}const n=this.getAssociatedEntityData();const a=BX.prop.getInteger(n,"DIRECTION",0);const r=this.isDone();const o=BX.prop.getString(n,"SUBJECT","");let l=BX.prop.getString(n,"DESCRIPTION_RAW","");const c=BX.prop.getObject(n,"COMMUNICATION",{});const u=BX.prop.getString(c,"TITLE","");const h=BX.prop.getString(c,"SHOW_URL","");const d=BX.prop.getString(c,"TYPE","")!==""?BX.prop.getString(c,"VALUE",""):"";let p=this.getWrapperClassName();if(p!==""){p=this._schedule.getItemClassName()+" "+p}else{p=this._schedule.getItemClassName()}const m=BX.create("DIV",{attrs:{className:p}});let y=this.getIconClassName();if(this.isCounterEnabled()){y+=" crm-entity-stream-section-counter"}if(s){y+=" crm-entity-stream-section-counter --incoming-counter"}m.appendChild(BX.create("DIV",{attrs:{className:y}}));if(this.isContextMenuEnabled()){m.appendChild(this.prepareContextMenuButton())}const _=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}});m.appendChild(_);if(l!==""){l=l.replace(/^\s+/,"")}const f=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});_.appendChild(f);this._deadlineNode=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:i});const g=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"}});g.appendChild(BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getTypeDescription(a)}));const v=this.getStatusNode();if(v){g.appendChild(v)}g.appendChild(this._deadlineNode);f.appendChild(g);const I=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});f.appendChild(I);I.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-title"},children:[BX.create("A",{attrs:{href:"#"},events:{click:this._headerClickHandler},text:o})]}));I.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},text:this.cutOffText(l,128)}));const b=this.prepareDetailNodes();if(BX.type.isArray(b)){let e=0;const t=b.length;for(;e<t;e++){I.appendChild(b[e])}}const C=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});if(u!==""){C.appendChild(BX.create("SPAN",{text:this.getPrepositionText(a)+": "}));if(h!==""){C.appendChild(BX.create("A",{attrs:{href:h},text:u}))}else{C.appendChild(BX.create("SPAN",{text:u}))}}if(d!==""){const e=this.prepareCommunicationNode(d);if(e){C.appendChild(e)}}I.appendChild(C);const B=BX.create("INPUT",{attrs:{type:"checkbox",className:"crm-entity-stream-planned-apply-btn",checked:r},events:{change:this._setAsDoneButtonHandler}});if(!this.canComplete()){B.disabled=true}const T=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-planned-action"},children:[B]});f.appendChild(T);const S=this.prepareAuthorLayout();if(S){f.appendChild(S)}this._actionContainer=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-action"}});f.appendChild(this._actionContainer);return m}},{key:"getStatusNode",value:function e(){return null}},{key:"prepareCommunicationNode",value:function e(t){return BX.create("SPAN",{text:" "+t})}},{key:"prepareDetailNodes",value:function e(){return[]}},{key:"prepareContextMenuItems",value:function e(){const t=[];if(!this.isReadOnly()){if(this.isEditable()){t.push({id:"edit",text:this.getMessage("menuEdit"),onclick:BX.delegate(this.edit,this)})}t.push({id:"remove",text:this.getMessage("menuDelete"),onclick:BX.delegate(this.processRemoval,this)})}if(this.canPostpone()){const e=BX.delegate(this.onContextMenuItemSelect,this);if(!this._postponeController){this._postponeController=SchedulePostponeController.create("",{item:this})}const i={id:"postpone",text:this._postponeController.getTitle(),items:[]};const s=this._postponeController.getCommandList();let n=0;const a=s.length;for(;n<a;n++){const t=s[n];i.items.push({id:t["name"],text:t["title"],onclick:e})}t.push(i)}return t}},{key:"onContextMenuItemSelect",value:function e(t,i){this.closeContextMenu();if(this._postponeController){this._postponeController.processCommand(i.id)}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Scheduled);let Call$2=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-call"}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-call"}},{key:"prepareActions",value:function e(){if(this.isReadOnly()){return}this._actions.push(BX.CrmScheduleCallAction.create("call",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._schedule.getOwnerInfo()}))}},{key:"getTypeDescription",value:function e(t){const i=this.getAssociatedEntityData();const s=BX.prop.getObject(i,"CALL_INFO",null);const n=s!==null?BX.prop.getString(s,"CALL_TYPE_TEXT",""):"";if(n!==""){return n}return this.getMessage(t===BX.CrmActivityDirection.incoming?"incomingCall":"outgoingCall")}},{key:"getRemoveMessage",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getInteger(t,"DIRECTION",0);let s=BX.prop.getString(t,"SUBJECT","");const n=i===BX.CrmActivityDirection.incoming?"incomingCallRemove":"outgoingCallRemove";s=BX.util.htmlspecialchars(s);return this.getMessage(n).replace("#TITLE#",s)}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let CallTracker=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getStatusNode",value:function e(){const t=this.getAssociatedEntityData();const i=BX.prop.getObject(t,"CALL_INFO",null);if(!i){return false}if(!BX.prop.getBoolean(i,"HAS_STATUS",false)){return false}const s=BX.prop.getBoolean(i,"SUCCESSFUL",false);const n=BX.prop.getString(i,"STATUS_TEXT","");return BX.create("DIV",{attrs:{className:s?"crm-entity-stream-content-event-successful":"crm-entity-stream-content-event-missing"},text:n})}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Call$2);let Email$2=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-email"}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-email"}},{key:"prepareActions",value:function e(){if(this.isReadOnly()){return}this._actions.push(BX.CrmScheduleEmailAction.create("email",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor}))}},{key:"getTypeDescription",value:function e(t){return this.getMessage(t===BX.CrmActivityDirection.incoming?"incomingEmail":"outgoingEmail")}},{key:"getRemoveMessage",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"SUBJECT","");i=BX.util.htmlspecialchars(i);return this.getMessage("emailRemove").replace("#TITLE#",i)}},{key:"isEditable",value:function e(){return false}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let Meeting$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return""}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-meeting"}},{key:"prepareActions",value:function e(){}},{key:"getPrepositionText",value:function e(){return this.getMessage("reciprocal")}},{key:"getRemoveMessage",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"SUBJECT","");i=BX.util.htmlspecialchars(i);return this.getMessage("meetingRemove").replace("#TITLE#",i)}},{key:"getTypeDescription",value:function e(){return this.getMessage("meeting")}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let OpenLine$2=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-IM"}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-IM"}},{key:"prepareActions",value:function e(){if(this.isReadOnly()){return}this._actions.push(OpenLine.create("openline",{item:this,container:this._actionContainer,entityData:this.getAssociatedEntityData(),activityEditor:this._activityEditor,ownerInfo:this._schedule.getOwnerInfo()}))}},{key:"getTypeDescription",value:function e(){return this.getMessage("openLine")}},{key:"getPrepositionText",value:function e(t){return this.getMessage("reciprocal")}},{key:"prepareCommunicationNode",value:function e(t){return null}},{key:"prepareDetailNodes",value:function e(){const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM"}});const i=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-IM-messages"}});t.appendChild(i);const s=BX.prop.getObject(this.getAssociatedEntityData(),"OPENLINE_INFO",null);if(s){const e=BX.prop.getArray(s,"MESSAGES",[]);let t=0;const n=e.length;for(;t<n;t++){const s=e[t];const n=BX.prop.getBoolean(s,"IS_EXTERNAL",true);i.appendChild(BX.create("DIV",{attrs:{className:n?"crm-entity-stream-content-detail-IM-message-incoming":"crm-entity-stream-content-detail-IM-message-outgoing"},html:BX.prop.getString(s,"MESSAGE","")}))}}return[t]}},{key:"view",value:function e(){if(typeof window.top["BXIM"]==="undefined"){window.alert(this.getMessage("openLineNotSupported"));return}let t="";const i=BX.prop.getObject(this.getAssociatedEntityData(),"COMMUNICATION",null);if(i){if(BX.prop.getString(i,"TYPE")==="IM"){t=BX.prop.getString(i,"VALUE")}}if(t!==""){window.top["BXIM"].openMessengerSlider(t,{RECENT:"N",MENU:"N"})}}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let Request$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return""}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-robot"}},{key:"getTypeDescription",value:function e(){return this.getMessage("activityRequest")}},{key:"isEditable",value:function e(){return false}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let Rest$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return""}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-rest"}},{key:"prepareContent",value:function e(i){const s=babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"prepareContent",this).call(this,i);const n=this.getAssociatedEntityData();if(n["APP_TYPE"]&&n["APP_TYPE"]["ICON_SRC"]){const e=s.querySelector("."+this.getIconClassName().replace(/\s+/g,"."));if(e){e.style.backgroundImage="url('"+n["APP_TYPE"]["ICON_SRC"]+"')";e.style.backgroundPosition="center center";e.style.backgroundSize="cover";e.style.backgroundColor="transparent"}}return s}},{key:"getTypeDescription",value:function e(){const t=this.getAssociatedEntityData();if(t["APP_TYPE"]&&t["APP_TYPE"]["NAME"]){return t["APP_TYPE"]["NAME"]}return this.getMessage("restApplication")}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let Task$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-planned-task"}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-task"}},{key:"getTypeDescription",value:function e(){return this.getMessage("task")}},{key:"getPrepositionText",value:function e(t){return this.getMessage("reciprocal")}},{key:"getRemoveMessage",value:function e(){const t=this.getAssociatedEntityData();let i=BX.prop.getString(t,"SUBJECT","");i=BX.util.htmlspecialchars(i);return this.getMessage("taskRemove").replace("#TITLE#",i)}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let Wait$1=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._postponeController=null;return e}babelHelpers.createClass(t,[{key:"getTypeId",value:function e(){return Item.wait}},{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-wait"}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-wait"}},{key:"prepareActions",value:function e(){}},{key:"isCounterEnabled",value:function e(){return false}},{key:"getDeadline",value:function e(){const t=this.getAssociatedEntityData();const i=BX.parseDate(t["DEADLINE_SERVER"],false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");if(!i){return null}return new crm_timeline_tools.DatetimeConverter(i).toUserTime().getValue()}},{key:"isDone",value:function e(){return BX.prop.getString(this.getAssociatedEntityData(),"COMPLETED","N")==="Y"}},{key:"setAsDone",value:function e(t){t=!!t;if(this.isDone()===t){return}const i=this.getAssociatedEntityId();if(i>0){var s,n,a;const e=(s=BX.Crm.Timeline)===null||s===void 0?void 0:(n=s.MenuBar)===null||n===void 0?void 0:(a=n.getDefault())===null||a===void 0?void 0:a.getItemById("wait");if(e){e.complete(i,t,BX.delegate(this.onSetAsDoneCompleted,this))}}}},{key:"postpone",value:function e(t){const i=this.getAssociatedEntityId();if(i>0&&t>0){var s,n,a;const e=(s=BX.Crm.Timeline)===null||s===void 0?void 0:(n=s.MenuBar)===null||n===void 0?void 0:(a=n.getDefault())===null||a===void 0?void 0:a.getItemById("wait");if(e){e.postpone(i,t,BX.delegate(this.onPosponeCompleted,this))}}}},{key:"isContextMenuEnabled",value:function e(){return!!this.getDeadline()&&this.canPostpone()}},{key:"prepareContent",value:function e(){const t=this.getDeadline();const i=t?this.formatDateTime(t):this.getMessage("termless");const s=this.getAssociatedEntityData();const n=this.isDone();let a=BX.prop.getString(s,"DESCRIPTION_RAW","");let r=this.getWrapperClassName();if(r!==""){r="crm-entity-stream-section crm-entity-stream-section-planned"+" "+r}else{r="crm-entity-stream-section crm-entity-stream-section-planned"}const o=BX.create("DIV",{attrs:{className:r}});let l=this.getIconClassName();if(this.isCounterEnabled()){l+=" crm-entity-stream-section-counter"}o.appendChild(BX.create("DIV",{attrs:{className:l}}));if(this.isContextMenuEnabled()){o.appendChild(this.prepareContextMenuButton())}const c=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}});o.appendChild(c);if(a!==""){a=BX.util.trim(a);a=BX.util.strip_tags(a);a=this.cutOffText(a,512);a=BX.util.nl2br(a)}const u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});c.appendChild(u);this._deadlineNode=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:i});const h=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getMessage("wait")}),this._deadlineNode]});u.appendChild(h);const d=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});u.appendChild(d);d.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-description"},html:a}));const p=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-contact-info"}});d.appendChild(p);const m=BX.create("INPUT",{attrs:{type:"checkbox",className:"crm-entity-stream-planned-apply-btn",checked:n},events:{change:this._setAsDoneButtonHandler}});if(!this.canComplete()){m.disabled=true}const y=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-planned-action"},children:[m]});u.appendChild(y);const _=this.prepareAuthorLayout();if(_){u.appendChild(_)}this._actionContainer=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-action"}});u.appendChild(this._actionContainer);return o}},{key:"prepareContextMenuItems",value:function e(){const t=[];const i=BX.delegate(this.onContextMenuItemSelect,this);if(!this._postponeController){this._postponeController=SchedulePostponeController.create("",{item:this})}const s={id:"postpone",text:this._postponeController.getTitle(),items:[]};const n=this._postponeController.getCommandList();let a=0;const r=n.length;for(;a<r;a++){const e=n[a];s.items.push({id:e["name"],text:e["title"],onclick:i})}t.push(s);return t}},{key:"onContextMenuItemSelect",value:function e(t,i){this.closeContextMenu();if(this._postponeController){this._postponeController.processCommand(i.id)}}},{key:"getTypeDescription",value:function e(){return this.getMessage("wait")}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Scheduled);let WebForm$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return""}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-crmForm"}},{key:"prepareActions",value:function e(){}},{key:"getPrepositionText",value:function e(){return this.getMessage("from")}},{key:"getTypeDescription",value:function e(){return this.getMessage("webform")}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let Zoom$1=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this))}babelHelpers.createClass(t,[{key:"getWrapperClassName",value:function e(){return"crm-entity-stream-section-zoom"}},{key:"getIconClassName",value:function e(){return"crm-entity-stream-section-icon crm-entity-stream-section-icon-zoom"}},{key:"getTypeDescription",value:function e(){return this.getMessage("zoom")}},{key:"getPrepositionText",value:function e(t){}},{key:"prepareCommunicationNode",value:function e(t){return null}},{key:"prepareContent",value:function e(t){const i=this.getDeadline();const s=i?this.formatDateTime(i):this.getMessage("termless");const n=this.getAssociatedEntityData();const a=BX.prop.getInteger(n,"DIRECTION",0);const r=this.isDone();const o=BX.prop.getString(n,"SUBJECT","");let l=BX.prop.getString(n,"DESCRIPTION_RAW","");const c=BX.prop.getObject(n,"COMMUNICATION",{});const u=BX.prop.getString(c,"TITLE","");const h=BX.prop.getString(c,"SHOW_URL","");const d=BX.prop.getString(c,"TYPE","")!==""?BX.prop.getString(c,"VALUE",""):"";let p=this.getWrapperClassName();if(p!==""){p="crm-entity-stream-section crm-entity-stream-section-planned"+" "+p}else{p="crm-entity-stream-section crm-entity-stream-section-planned"}const m=BX.create("DIV",{attrs:{className:p}});let y=this.getIconClassName();if(this.isCounterEnabled()){y+=" crm-entity-stream-section-counter"}m.appendChild(BX.create("DIV",{attrs:{className:y}}));if(this.isContextMenuEnabled()){m.appendChild(this.prepareContextMenuButton())}const _=BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"}});m.appendChild(_);if(l!==""){l=l.replace(/^\s+/,"")}const f=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"}});_.appendChild(f);this._deadlineNode=BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-time"},text:s});const g=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-header"},children:[BX.create("SPAN",{attrs:{className:"crm-entity-stream-content-event-title"},text:this.getTypeDescription(a)}),this._deadlineNode]});f.appendChild(g);const v=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"}});f.appendChild(v);if(n["ZOOM_INFO"]){const e=n["ZOOM_INFO"]["TOPIC"];const t=n["ZOOM_INFO"]["DURATION"];const i=BX.parseDate(n["ZOOM_INFO"]["CONF_START_TIME"],false,"YYYY-MM-DD","YYYY-MM-DD HH:MI:SS");const s=new crm_timeline_tools.DatetimeConverter(i).toUserTime().toDatetimeString({delimiter:", "});const a=BX.create("span",{text:this.getMessage("zoomCreatedMessage").replace("#CONFERENCE_TITLE#",e).replace("#DATE_TIME#",s).replace("#DURATION#",t)});const r=BX.create("A",{attrs:{href:n["ZOOM_INFO"]["CONF_URL"],target:"_blank"},text:n["ZOOM_INFO"]["CONF_URL"]});const o=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-zoom-info"},children:[a,r]});v.appendChild(o);const l=BX.create("A",{attrs:{className:"ui-link ui-link-dashed","data-url":n["ZOOM_INFO"]["CONF_URL"]},text:this.getMessage("zoomCreatedCopyInviteLink")});BX.clipboard.bindCopyClick(l,{text:n["ZOOM_INFO"]["CONF_URL"]});const c=BX.create("BUTTON",{attrs:{className:"ui-btn ui-btn-sm ui-btn-primary"},text:this.getMessage("zoomCreatedStartConference"),events:{click:function(){window.open(n["ZOOM_INFO"]["CONF_URL"])}}});const u=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-zoom-link-wrapper"},children:[l]});v.appendChild(u);v.appendChild(c)}const I=this.prepareDetailNodes();if(BX.type.isArray(I)){let e=0;const t=I.length;for(;e<t;e++){v.appendChild(I[e])}}const b=BX.create("INPUT",{attrs:{type:"checkbox",className:"crm-entity-stream-planned-apply-btn",checked:r},events:{change:this._setAsDoneButtonHandler}});if(!this.canComplete()){b.disabled=true}const C=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-planned-action"},children:[b]});f.appendChild(C);const B=this.prepareAuthorLayout();if(B){f.appendChild(B)}this._actionContainer=BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail-action"}});f.appendChild(this._actionContainer);return m}},{key:"prepareDetailNodes",value:function e(){}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity$1);let _$2=e=>e,_t$2;let Schedule=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._items=[];e._history=null;e._wrapper=null;e._anchor=null;e._stub=null;return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){if(!this.isStubMode()){let e=this.getSetting("itemData");if(!BX.type.isArray(e)){e=[]}let t,i,s;for(t=0,i=e.length;t<i;t++){s=this.createItem(e[t]);if(s){this._items.push(s)}}}}},{key:"layout",value:function e(){this._wrapper=BX.create("DIV",{});this._container.appendChild(this._wrapper);const t=BX.create("DIV",{attrs:{className:"crm-entity-stream-planned-label"},text:this.getMessage("planned")});const i="crm-entity-stream-section crm-entity-stream-section-planned-label";this._wrapper.appendChild(BX.create("DIV",{attrs:{className:i},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[t]})]}));if(this.isStubMode()){this.addStub()}else{const e=this._items.length;if(e===0){this.addStub()}else{for(let t=0;t<e;t++){const e=this._items[t];e.setContainer(this._wrapper);e.layout()}}}this.refreshLayout();this._manager.processSheduleLayoutChange()}},{key:"refreshLayout",value:function e(){BX.onCustomEvent("Schedule:onBeforeRefreshLayout",[this]);const t=this._items.length;if(t===0){this.addStub();if(this._history&&this._history.hasContent()){BX.removeClass(this._stub,"crm-entity-stream-section-last")}else{BX.addClass(this._stub,"crm-entity-stream-section-last")}const e=this._stub.querySelector(".crm-entity-stream-section-icon");if(e){if(this._manager.isStubCounterEnabled()){BX.addClass(e,"crm-entity-stream-section-counter")}else{BX.removeClass(e,"crm-entity-stream-section-counter")}}return}let i,s;if(this._history&&this._history.hasContent()){for(i=0;i<t;i++){s=this._items[i];if(s.isTerminated()){s.markAsTerminated(false)}}}else{if(t>1){for(i=0;i<t-1;i++){s=this._items[i];if(s.isTerminated()){s.markAsTerminated(false)}}}this._items[t-1].markAsTerminated(true)}}},{key:"formatDateTime",value:function e(t){return new crm_timeline_tools.DatetimeConverter(t).toDatetimeString({delimiter:", "})}},{key:"checkItemForTermination",value:function e(t){if(this._history&&this._history.getItemCount()>0){return false}return this.getLastItem()===t}},{key:"getItems",value:function e(){return this._items}},{key:"setItems",value:function e(t){this._items=t}},{key:"calculateItemIndex",value:function e(t){const i=t.getSort();for(let e=0;e<this._items.length;e++){const t=this._items[e].getSort();for(let s=0;s<t.length;s++){if(i.length<=s||i[s]!==t[s]){if(i[s]<t[s]){return e}break}}}return this._items.length}},{key:"getItemCount",value:function e(){return this._items.length}},{key:"getItemByAssociatedEntity",value:function e(t,i){if(!BX.type.isNumber(t)){t=parseInt(t)}if(!BX.type.isNumber(i)){i=parseInt(i)}if(isNaN(t)||t<=0||isNaN(i)||i<=0){return null}for(let e=0,s=this._items.length;e<s;e++){const s=this._items[e];if(s.getAssociatedEntityTypeId()===t&&s.getAssociatedEntityId()===i){return s}}return null}},{key:"getItemByData",value:function e(t){if(!BX.type.isPlainObject(t)){return null}return this.getItemByAssociatedEntity(BX.prop.getInteger(t,"ASSOCIATED_ENTITY_TYPE_ID",0),BX.prop.getInteger(t,"ASSOCIATED_ENTITY_ID",0))}},{key:"getItemByIndex",value:function e(t){return t<this._items.length?this._items[t]:null}},{key:"createItem",value:function e(t){const i=BX.prop.getInteger(t,"ASSOCIATED_ENTITY_TYPE_ID",0);const s=BX.prop.getInteger(t,"ASSOCIATED_ENTITY_ID",0);const n=BX.prop.getObject(t,"ASSOCIATED_ENTITY",{});let a=BX.CrmEntityType.resolveName(i)+"_"+s.toString();if(t.hasOwnProperty("type")){a=t.id;return crm_timeline_item.ConfigurableItem.create(a,{timelineId:this.getId(),container:this.getWrapper(),itemClassName:this.getItemClassName(),isReadOnly:this.isReadOnly(),currentUser:this._manager.getCurrentUser(),ownerTypeId:this._manager.getOwnerTypeId(),ownerId:this._manager.getOwnerId(),streamType:this.getStreamType(),data:t})}if(i===BX.CrmEntityType.enumeration.wait){return Wait$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else{const e=BX.prop.getInteger(n,"TYPE_ID",0);const i=BX.prop.getString(n,"PROVIDER_ID","");if(e===BX.CrmActivityType.email){return Email$2.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmActivityType.call){return Call$2.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmActivityType.meeting){return Meeting$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmActivityType.task){return Task$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(e===BX.CrmActivityType.provider){if(i==="CRM_WEBFORM"){return WebForm$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i==="CRM_REQUEST"){return Request$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i==="IMOPENLINES_SESSION"){return OpenLine$2.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i==="ZOOM"){return Zoom$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i==="REST_APP"){return Rest$1.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}else if(i==="CRM_CALL_TRACKER"){return CallTracker.create(a,{schedule:this,container:this._wrapper,activityEditor:this._activityEditor,data:t})}}}return null}},{key:"getWrapper",value:function e(){return this._wrapper}},{key:"getItemClassName",value:function e(){return"crm-entity-stream-section crm-entity-stream-section-planned"}},{key:"getStreamType",value:function e(){return crm_timeline_item.StreamType.scheduled}},{key:"addItem",value:async function e(t,i){if(!BX.type.isNumber(i)||i<0){i=this.calculateItemIndex(t)}if(i<this._items.length){this._items.splice(i,0,t)}else{this._items.push(t)}await this.removeStub();this.refreshLayout();this._manager.processSheduleLayoutChange()}},{key:"getHistory",value:function e(){return this._history}},{key:"setHistory",value:function e(t){this._history=t}},{key:"createAnchor",value:function e(t){this._anchor=BX.create("DIV",{attrs:{className:"crm-entity-stream-section crm-entity-stream-section-shadow"}});if(t>=0&&t<this._items.length){this._wrapper.insertBefore(this._anchor,this._items[t].getWrapper())}else{this._wrapper.appendChild(this._anchor)}return this._anchor}},{key:"deleteItem",value:function e(t){const i=this.getItemIndex(t);if(i<0){return}t.clearLayout();this.removeItemByIndex(i);this.refreshLayout();this._manager.processSheduleLayoutChange()}},{key:"transferItemToHistory",value:function e(t,i){const s=this.getItemIndex(t);if(s<0){return}this.removeItemByIndex(s);this.refreshLayout();this._manager.processSheduleLayoutChange();const n=this._history.createItem(i);this._history.addItem(n,0);n.layout({add:false});const a=ItemNew.create("",{initialItem:t,finalItem:n,anchor:this._history.createAnchor(),events:{complete:BX.delegate(this.onTransferComplete,this)}});a.run()}},{key:"onTransferComplete",value:function e(){this._history.refreshLayout();if(this._items.length===0){this.addStub()}}},{key:"onItemMarkedAsDone",value:function e(t,i){}},{key:"addStub",value:function e(){if(!this._stub){var t,i,s;const e=!!((t=BX.Crm.Timeline)!==null&&t!==void 0&&(i=t.MenuBar)!==null&&i!==void 0&&(s=i.getDefault())!==null&&s!==void 0&&s.getItemById("todo"));this.createStub();if(e&&!this.isReadOnly()){BX.bind(this._stub,"click",BX.delegate(this.focusOnTodoEditor,this))}const n=this._wrapper.querySelector(".crm-entity-stream-section.crm-entity-stream-section-planned-label");main_core.Dom.style(this._stub,{opacity:0,overflow:"hidden"});main_core.Dom.insertAfter(this._stub,n);const a=main_core.Dom.getPosition(this._stub).height;main_core.Dom.style(this._stub,{height:0,marginBottom:0});requestAnimationFrame((()=>{main_core.Dom.style(this._stub,{opacity:1,height:a?`${a}px`:null,marginBottom:"15px",overflow:null})}))}if(this._history&&this._history.getItemCount()>0){BX.removeClass(this._stub,"crm-entity-stream-section-last")}else{BX.addClass(this._stub,"crm-entity-stream-section-last")}}},{key:"createStub",value:function e(){var t,i,s;let n="crm-entity-stream-section crm-entity-stream-section-planned crm-entity-stream-section-notTask";let a="crm-entity-stream-section-icon crm-entity-stream-section-icon-info";const r=!!((t=BX.Crm.Timeline)!==null&&t!==void 0&&(i=t.MenuBar)!==null&&i!==void 0&&(s=i.getDefault())!==null&&s!==void 0&&s.getItemById("todo"));if(r&&!this.isReadOnly()){n+=" --active"}let o=this.getMessage("stub");const l=this._manager.getOwnerTypeId();if(l===BX.CrmEntityType.enumeration.lead){o=this.getMessage("leadStub")}else if(l===BX.CrmEntityType.enumeration.deal){o=this.getMessage("dealStub")}if(this._manager.isStubCounterEnabled()){a+=" crm-entity-stream-section-counter"}this._stub=BX.create("DIV",{attrs:{className:n},children:[BX.create("DIV",{attrs:{className:a}}),BX.create("DIV",{attrs:{className:"crm-entity-stream-section-content"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-event"},children:[BX.create("DIV",{attrs:{className:"crm-entity-stream-content-title"},text:this.getMessage("stubTitle")}),BX.create("DIV",{attrs:{className:"crm-entity-stream-content-detail"},text:o})]})]})]})}},{key:"removeStub",value:function e(){return new Promise(((e,t)=>{const i=main_core.Dom.getPosition(this._stub).height!==0;if(this._stub&&i){const t=main_core.Tag.render(_t$2||(_t$2=_$2`<div class="crm-entity-stream-section-content-overlay"></div>`));main_core.Dom.style(t,"opacity",0);main_core.bindOnce(t,"transitionend",(()=>{main_core.Dom.style(this._stub,"position","absolute");setTimeout((()=>{main_core.Dom.remove(this._stub);this._stub=null}),200);e(true)}));const i=this._stub.querySelector(".crm-entity-stream-section-content");main_core.Dom.append(t,i);setTimeout((()=>{main_core.Dom.style(t,"opacity",1)}),50)}else{main_core.Dom.remove(this._stub);this._stub=null;e(true)}}))}},{key:"focusOnTodoEditor",value:function e(){const t=BX.Crm.Timeline.MenuBar.getDefault();if(t){t.setActiveItemById("todo");const e=t.getItemById("todo");e===null||e===void 0?void 0:e.focus()}}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}},{key:"animateItemAdding",value:function e(t){if(this._stub){const e=this._stub?this._stub.offsetHeight:73;const i=t instanceof crm_timeline_item.ConfigurableItem?t.getLayoutComponent().$refs.timelineCard:t.getWrapper();return new Promise((t=>{Expand.create(i,t,{startHeight:e}).run()}))}return new Promise((e=>{Expand.create(t.getWrapper(),e,{}).run()}))}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);t.items[n.getId()]=n;return n}}]);return t}(Steam);babelHelpers.defineProperty(Schedule,"items",{});babelHelpers.defineProperty(Schedule,"messages",{});let AudioPlaybackRateSelector=function(){function e(t){babelHelpers.classCallCheck(this,e);this.name=t.name||"crm-timeline-audio-playback-rate-selector";this.menuId=this.name+"-menu";if(BX.Type.isArray(t.availableRates)){this.availableRates=t.availableRates}else{this.availableRates=[1,1.5,2,3]}this.currentRate=this.normalizeRate(t.currentRate);this.textMessageCode=t.textMessageCode;this.renderedItems=[];this.players=[]}babelHelpers.createClass(e,[{key:"isRateCurrent",value:function e(t,i){return t.rate&&i===t.rate||i===t}},{key:"normalizeRate",value:function e(t){t=parseFloat(t);let i=0;const s=this.availableRates.length;for(;i<s;i++){if(this.isRateCurrent(this.availableRates[i],t)){return t}}return this.availableRates[0].rate||this.availableRates[0]}},{key:"getMenuItems",value:function e(){const t=this.getRate();return this.availableRates.map(function(e){return{text:(e.text||e)+"",html:(e.html||e)+"",className:this.isRateCurrent(e,t)?"menu-popup-item-text-active":null,onclick:function(){this.setRate(e.rate||e)}.bind(this)}}.bind(this))}},{key:"getPopup",value:function e(t){let i=BX.Main.MenuManager.getMenuById(this.menuId);if(i){const e=i.getPopupWindow();if(e){e.setBindElement(t)}}else{i=BX.Main.MenuManager.create({id:this.menuId,bindElement:t,items:this.getMenuItems(),className:"crm-audio-cap-speed-popup"})}return i}},{key:"getRate",value:function e(){return this.normalizeRate(this.currentRate)}},{key:"setRate",value:function e(t){this.getPopup().destroy();t=this.normalizeRate(t);if(this.currentRate===t){return}this.currentRate=t;BX.userOptions.save("crm",this.name,"rate",t);for(let e=0,t=this.renderedItems.length;e<t;e++){const t=this.renderedItems[e].querySelector(".crm-audio-cap-speed-text");if(t){t.innerHTML=this.getText()}}for(let e=0,t=this.players.length;e<t;e++){this.players[e].vjsPlayer.playbackRate(this.getRate())}}},{key:"getText",value:function e(){let t;if(this.textMessageCode){t=BX.Loc.getMessage(this.textMessageCode)}if(!t){t="#RATE#"}return t.replace("#RATE#","<span>"+this.getRate()+"x</span>")}},{key:"render",value:function e(){const t=BX.Dom.create("div",{attrs:{className:"crm-audio-cap-speed-wrapper"},children:[BX.Dom.create("div",{attrs:{className:"crm-audio-cap-speed"},children:[BX.Dom.create("div",{attrs:{className:"crm-audio-cap-speed-text"},html:this.getText()})]})],events:{click:function(e){e.preventDefault();this.getPopup(e.target).show()}.bind(this)}});this.renderedItems.push(t);return t}},{key:"addPlayer",value:function e(t){if(BX.Fileman.Player&&t instanceof BX.Fileman.Player){this.players.push(t)}}}]);return e}();function _classPrivateFieldInitSpec$8(e,t,i){_checkPrivateRedeclaration$8(e,t);t.set(e,i)}function _checkPrivateRedeclaration$8(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function _classStaticPrivateFieldSpecSet(e,t,i,s){_classCheckPrivateStaticAccess$1(e,t);_classCheckPrivateStaticFieldDescriptor$1(i,"set");_classApplyDescriptorSet(e,i,s);return s}function _classApplyDescriptorSet(e,t,i){if(t.set){t.set.call(e,i)}else{if(!t.writable){throw new TypeError("attempted to set read only private field")}t.value=i}}function _classStaticPrivateFieldSpecGet$1(e,t,i){_classCheckPrivateStaticAccess$1(e,t);_classCheckPrivateStaticFieldDescriptor$1(i,"get");return _classApplyDescriptorGet$1(e,i)}function _classCheckPrivateStaticFieldDescriptor$1(e,t){if(e===undefined){throw new TypeError("attempted to "+t+" private static field before its declaration")}}function _classCheckPrivateStaticAccess$1(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function _classApplyDescriptorGet$1(e,t){if(t.get){return t.get.call(e)}return t.value}var _itemPullActionProcessor=new WeakMap;let Manager=function(){function e(){babelHelpers.classCallCheck(this,e);_classPrivateFieldInitSpec$8(this,_itemPullActionProcessor,{writable:true,value:null});this._id="";this._settings={};this._container=null;this._ownerTypeId=0;this._ownerId=0;this._ownerInfo=null;this._progressSemantics="";this._chat=null;this._schedule=null;this._history=null;this._fixedHistory=null;this._activityEditor=null;this._userId=0;this._readOnly=false;this._currentUser=null;this._pingSettings=null;this._calendarSettings=null;this._colorSettings=null;this._pullTagName=""}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._ownerTypeId=parseInt(this.getSetting("ownerTypeId"));this._ownerId=parseInt(this.getSetting("ownerId"));this._ownerInfo=this.getSetting("ownerInfo");this._progressSemantics=BX.prop.getString(this._settings,"progressSemantics","");this._spotlightFastenShowed=this.getSetting("spotlightFastenShowed",true);this._audioPlaybackRate=parseFloat(this.getSetting("audioPlaybackRate",1));const s=this.getSetting("containerId");if(!BX.type.isNotEmptyString(s)){throw"Manager. A required parameter 'containerId' is missing."}this._container=BX(s);if(!BX.type.isElementNode(this._container)){throw"Manager. Container node is not found."}this._editorContainer=BX(this.getSetting("editorContainer"));this._userId=BX.prop.getInteger(this._settings,"userId",0);this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);this._currentUser=BX.prop.getObject(this._settings,"currentUser",null);this._pingSettings=BX.prop.getObject(this._settings,"pingSettings",null);this._calendarSettings=BX.prop.getObject(this._settings,"calendarSettings",null);this._colorSettings=BX.prop.getObject(this._settings,"colorSettings",null);const n=this.getSetting("activityEditorId");if(BX.type.isNotEmptyString(n)){this._activityEditor=BX.CrmActivityEditor.items[n];if(!(this._activityEditor instanceof BX.CrmActivityEditor)){throw"BX.CrmTimeline. Activity editor instance is not found."}}const a=this.getSetting("ajaxId");const r=this.getSetting("currentUrl");const o=this.getSetting("serviceUrl");this._chat=EntityChat.create(this._id,{manager:this,container:this._container,data:this.getSetting("chatData"),isStubMode:this._ownerId<=0,readOnly:this._readOnly});this._schedule=Schedule.create(this._id,{manager:this,container:this._container,activityEditor:this._activityEditor,itemData:this.getSetting("scheduleData"),templates:this.getSetting("templates"),isStubMode:this._ownerId<=0,ajaxId:a,serviceUrl:o,currentUrl:r,userId:this._userId,readOnly:this._readOnly});this._fixedHistory=FixedHistory.create(this._id,{manager:this,container:this._container,editorContainer:this._editorContainer,activityEditor:this._activityEditor,itemData:this.getSetting("fixedData"),templates:this.getSetting("templates"),isStubMode:this._ownerId<=0,ajaxId:a,serviceUrl:o,currentUrl:r,userId:this._userId,readOnly:this._readOnly});this._history=History$1.create(this._id,{manager:this,container:this._container,fixedHistory:this._fixedHistory,activityEditor:this._activityEditor,itemData:this.getSetting("historyData"),templates:this.getSetting("templates"),navigation:this.getSetting("historyNavigation",{}),filterId:BX.prop.getString(this._settings,"historyFilterId",this._id),isFilterApplied:BX.prop.getBoolean(this._settings,"isHistoryFilterApplied",false),isStubMode:this._ownerId<=0,ajaxId:a,serviceUrl:o,currentUrl:r,userId:this._userId,readOnly:this._readOnly});this._schedule.setHistory(this._history);this._fixedHistory.setHistory(this._history);this._chat.layout();this._schedule.layout();this._fixedHistory.layout();this._history.layout();this._pullTagName=BX.prop.getString(this._settings,"pullTagName","");if(this._pullTagName!==""){BX.addCustomEvent("onPullEvent-crm",BX.delegate(this.onPullEvent,this));this.extendWatch();babelHelpers.classPrivateFieldSet(this,_itemPullActionProcessor,new PullActionProcessor({scheduleStream:this._schedule,fixedHistoryStream:this._fixedHistory,historyStream:this._history,ownerTypeId:this._ownerTypeId,ownerId:this._ownerId,userId:this._userId}))}BX.addCustomEvent(window,"Crm.EntityProgress.Change",BX.delegate(this.onEntityProgressChange,this));BX.ready((function(){window.addEventListener("scroll",BX.throttle((function(){BX.LazyLoad.onScroll()}),80))}))}},{key:"extendWatch",value:function e(){if(BX.type.isFunction(BX.PULL)&&this._pullTagName!==""){BX.PULL.extendWatch(this._pullTagName);window.setTimeout(BX.delegate(this.extendWatch,this),6e4)}}},{key:"onPullEvent",value:function e(t,i){if(this._pullTagName!==BX.prop.getString(i,"TAG","")){return}if(t==="timeline_item_action"){babelHelpers.classPrivateFieldGet(this,_itemPullActionProcessor).processAction(i);return}if(t==="timeline_chat_create"){this.processChatCreate(i)}else if(t==="timeline_activity_add"){this.processActivityExternalAdd(i)}else if(t==="timeline_activity_update"){this.processActivityExternalUpdate(i)}else if(t==="timeline_activity_delete"){this.processActivityExternalDelete(i)}else if(t==="timeline_comment_add"){this.processCommentExternalAdd(i)}else if(t==="timeline_comment_update"){this.processCommentExternalUpdate(i)}else if(t==="timeline_comment_delete"){this.processCommentExternalDelete(i)}else if(t==="timeline_changed_binding"){this.processChangeBinding(i)}else if(t==="timeline_item_update"){this.processItemExternalUpdate(i)}else if(t==="timeline_wait_add"){this.processWaitExternalAdd(i)}else if(t==="timeline_wait_update"){this.processWaitExternalUpdate(i)}else if(t==="timeline_wait_delete"){this.processWaitExternalDelete(i)}else if(t==="timeline_bizproc_status"){this.processBizprocStatus(i)}else if(t==="timeline_scoring_add"){this.processScoringExternalAdd(i)}}},{key:"processChatCreate",value:function e(t){if(this._chat){this._chat.setData(BX.prop.getObject(t,"CHAT_DATA",{}));this._chat.refreshLayout()}}},{key:"processActivityExternalAdd",value:function e(t){let i,s,n,a,r;i=BX.prop.getObject(t,"ENTITY",null);s=BX.prop.getObject(t,"SCHEDULE_ITEM",null);n=BX.prop.getObject(t,"HISTORY_ITEM",null);if(i&&n&&!BX.type.isPlainObject(n["ASSOCIATED_ENTITY"])){n["ASSOCIATED_ENTITY"]=i}if(s!==null&&this._schedule.getItemByData(s)===null){a=this.addScheduleItem(s);a.addWrapperClass("crm-entity-stream-section-updated",1e3)}if(n!==null){r=this._history.findItemById(BX.prop.getString(n,"ID"));if(!r){r=this.addHistoryItem(n);Expand.create(r.getWrapper(),null).run()}}}},{key:"processActivityExternalUpdate",value:function e(t){let i,s,n,a,r,o;i=BX.prop.getObject(t,"ENTITY",null);s=BX.prop.getObject(t,"SCHEDULE_ITEM",null);a=BX.prop.getObject(t,"HISTORY_ITEM",null);if(i){if(a&&!BX.type.isPlainObject(a["ASSOCIATED_ENTITY"])){a["ASSOCIATED_ENTITY"]=i}const e=BX.prop.getInteger(i,"ID",0);const t=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.activity,e);for(let e=0,s=t.length;e<s;e++){r=t[e];r.setAssociatedEntityData(i);r.refreshLayout()}const s=this._fixedHistory.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.activity,e);for(let e=0,t=s.length;e<t;e++){o=s[e];o.setAssociatedEntityData(i);o.refreshLayout()}}if(s!==null){n=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.activity,BX.prop.getInteger(s,"ASSOCIATED_ENTITY_ID"));if(n){n.setData(s);if(!n.isDone()){this._schedule.refreshItem(n)}else{if(a){this._schedule.transferItemToHistory(n,a);a=null}else{this._schedule.deleteItem(n)}}}else if(!Scheduled.isDone(s)){n=this.addScheduleItem(s);n.addWrapperClass("crm-entity-stream-section-updated",1e3)}}if(a!==null){r=this._history.findItemById(BX.prop.getString(a,"ID"));if(!r){r=this.addHistoryItem(a);Expand.create(r.getWrapper(),null).run()}else{r.setData(a);r.refreshLayout();o=this._fixedHistory.findItemById(BX.prop.getString(a,"ID"));if(o){o.setData(a);o.refreshLayout()}}}}},{key:"processActivityExternalDelete",value:function e(t){const i=BX.prop.getInteger(t,"ENTITY_ID",0);const s=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.activity,i);for(let e=0,t=s.length;e<t;e++){this._history.deleteItem(s[e])}const n=this._fixedHistory.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.activity,i);for(let e=0,t=n.length;e<t;e++){this._fixedHistory.deleteItem(n[e])}const a=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.activity,i);if(a){this._schedule.deleteItem(a)}}},{key:"processCommentExternalAdd",value:function e(t){let i,s;i=BX.prop.getObject(t,"HISTORY_ITEM",null);if(i!==null){window.setTimeout(BX.delegate((function(){if(!this._history.findItemById(i["ID"])){s=this.addHistoryItem(i);Expand.create(s.getWrapper(),null).run()}}),this),1500)}}},{key:"processCommentExternalUpdate",value:function e(t){const i=BX.prop.getInteger(t,"ENTITY_ID",0);const s=BX.prop.getObject(t,"HISTORY_ITEM",null);const n=this._history.findItemById(i);if(n instanceof Comment&&s!==null){n.setData(s);n.switchToViewMode()}const a=this._fixedHistory.findItemById(i);if(a instanceof Comment&&s!==null){a.setData(s);a.switchToViewMode()}}},{key:"processCommentExternalDelete",value:function e(t){const i=BX.prop.getInteger(t,"ENTITY_ID",0);window.setTimeout(BX.delegate((function(){const e=this._history.findItemById(i);if(e instanceof Comment){this._history.deleteItem(e)}const t=this._fixedHistory.findItemById(i);if(t instanceof Comment){this._fixedHistory.deleteItem(t)}}),this),1200)}},{key:"processChangeBinding",value:function e(t){const i=BX.prop.getString(t,"OLD_ID",0);const s=BX.prop.getString(t,"NEW_ID",0);const n=this._history.findItemById(i);if(n instanceof crm_timeline_item.Item){n._id=s;const e=n.getData();e.ID=s;n.setData(e)}const a=this._fixedHistory.findItemById(i);if(a instanceof crm_timeline_item.Item){a._id=s;const e=a.getData();e.ID=s;a.setData(e)}}},{key:"processItemExternalUpdate",value:function e(t){const i=BX.prop.getInteger(t,"ENTITY_ID",0);const s=BX.prop.getObject(t,"HISTORY_ITEM",null);const n=this._history.findItemById(i);if(n&&s!==null){n.setData(s);n.markAsTerminated(this._history.checkItemForTermination(n));n.refreshLayout();if(n.isTerminated()){BX.addClass(n._wrapper,"crm-entity-stream-section-last")}}}},{key:"processWaitExternalAdd",value:function e(t){const i=BX.prop.getObject(t,"SCHEDULE_ITEM",null);if(i!==null){this.addScheduleItem(i)}}},{key:"processWaitExternalUpdate",value:function e(t){let i,s,n,a,r;i=BX.prop.getObject(t,"ENTITY",null);s=BX.prop.getObject(t,"SCHEDULE_ITEM",null);a=BX.prop.getObject(t,"HISTORY_ITEM",null);if(i){if(a&&!BX.type.isPlainObject(a["ASSOCIATED_ENTITY"])){a["ASSOCIATED_ENTITY"]=i}const e=BX.prop.getInteger(i,"ID",0);const t=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.wait,e);let s=0;const n=t.length;for(;s<n;s++){r=t[s];r.setAssociatedEntityData(i);r.refreshLayout()}}if(s!==null){n=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.wait,BX.prop.getInteger(s,"ASSOCIATED_ENTITY_ID"));if(!n){this.addScheduleItem(s)}else{n.setData(s);if(!n.isDone()){this._schedule.refreshItem(n)}else{if(a){this._schedule.transferItemToHistory(n,a);a=null}else{this._schedule.deleteItem(n)}}}}if(a!==null){r=this._history.findItemById(BX.prop.getString(a,"ID"));if(!r){r=this.addHistoryItem(a);Expand.create(r.getWrapper(),null).run()}else{r.setData(a);r.refreshLayout()}}}},{key:"processWaitExternalDelete",value:function e(t){const i=BX.prop.getInteger(t,"ENTITY_ID",0);const s=this._history.getItemsByAssociatedEntity(BX.CrmEntityType.enumeration.wait,i);let n=0;const a=s.length;for(;n<a;n++){this._history.deleteItem(s[n])}const r=this._schedule.getItemByAssociatedEntity(BX.CrmEntityType.enumeration.wait,i);if(r){this._schedule.deleteItem(r)}}},{key:"processBizprocStatus",value:function e(t){let i,s;i=BX.prop.getObject(t,"HISTORY_ITEM",null);if(i!==null){s=this.addHistoryItem(i);Expand.create(s.getWrapper(),null).run()}}},{key:"processScoringExternalAdd",value:function e(t){let i,s;i=BX.prop.getObject(t,"HISTORY_ITEM",null);if(i!==null){s=this.addHistoryItem(i);Expand.create(s.getWrapper(),null).run()}}},{key:"onEntityProgressChange",value:function e(t,i){if(BX.prop.getInteger(i,"entityTypeId",0)!==this._ownerTypeId||BX.prop.getInteger(i,"entityId",0)!==this._ownerId){return}const s=BX.prop.getString(i,"semantics","");if(s===this._progressSemantics){return}this._progressSemantics=s;this._schedule.refreshLayout()}},{key:"getId",value:function e(){return this._id}},{key:"getSetting",value:function e(t,i){return this._settings.hasOwnProperty(t)?this._settings[t]:i}},{key:"getOwnerTypeId",value:function e(){return this._ownerTypeId}},{key:"getOwnerId",value:function e(){return this._ownerId}},{key:"getOwnerInfo",value:function e(){return this._ownerInfo}},{key:"isStubCounterEnabled",value:function e(){return false}},{key:"getSchedule",value:function e(){return this._schedule}},{key:"getHistory",value:function e(){return this._history}},{key:"getFixedHistory",value:function e(){return this._fixedHistory}},{key:"processSheduleLayoutChange",value:function e(){}},{key:"processHistoryLayoutChange",value:function e(){this._schedule.refreshLayout()}},{key:"addScheduleItem",value:function e(t){const i=this._schedule.createItem(t);const s=this._schedule.calculateItemIndex(i);const n=this._schedule.createAnchor(s);this._schedule.addItem(i,s);i.layout({anchor:n});return i}},{key:"addHistoryItem",value:function e(t){const i=this._history.createItem(t);const s=this._history.calculateItemIndex(i);const n=this._history.createAnchor(s);this._history.addItem(i,s);i.layout({anchor:n});return i}},{key:"renderAudioDummy",value:function e(t,i){return BX.create("DIV",{attrs:{className:"crm-audio-cap-wrap-container"},children:[BX.create("DIV",{attrs:{className:"crm-audio-cap-wrap"},children:[BX.create("DIV",{attrs:{className:"crm-audio-cap-time"},text:t})],events:{click:i}})]})}},{key:"loadMediaPlayer",value:function e(t,i,s,n,a,r){if(!a){a=0}if(!r){r={}}const o=new BX.Fileman.Player(t,{sources:[{src:i,type:s}],isAudio:!r.video,skin:r.hasOwnProperty("skin")?r.skin:"vjs-timeline_player-skin",width:r.width||350,height:r.height||30,duration:a,playbackRate:r.playbackRate||null,onInit:function(e){e.vjsPlayer.controlBar.removeChild("timeDivider");e.vjsPlayer.controlBar.removeChild("durationDisplay");e.vjsPlayer.controlBar.removeChild("fullscreenToggle");e.vjsPlayer.controlBar.addChild("timeDivider");e.vjsPlayer.controlBar.addChild("durationDisplay");if(!e.isPlaying()){e.play()}}});BX.cleanNode(n,false);n.appendChild(o.createElement());o.init();if(r.playbackRate>1){o.vjsPlayer.playbackRate(r.playbackRate)}return o}},{key:"onActivityCreated",value:function e(t,i){}},{key:"isSpotlightShowed",value:function e(){return this._spotlightFastenShowed}},{key:"setSpotlightShowed",value:function e(){this._spotlightFastenShowed=true}},{key:"getCurrentUser",value:function e(){if(BX.type.isObjectLike(this._currentUser)&&this._userId>0){this._currentUser.userId=this._userId}return this._currentUser}},{key:"getPingSettings",value:function e(){if(BX.type.isObjectLike(this._pingSettings)&&Object.keys(this._pingSettings).length>0){return this._pingSettings}return null}},{key:"getCalendarSettings",value:function e(){if(BX.type.isObjectLike(this._calendarSettings)&&Object.keys(this._calendarSettings).length>0){return this._calendarSettings}return null}},{key:"getColorSettings",value:function e(){if(BX.type.isObjectLike(this._colorSettings)&&Object.keys(this._colorSettings).length>0){return this._colorSettings}return null}},{key:"getAudioPlaybackRateSelector",value:function e(){if(!this.audioPlaybackRateSelector){this.audioPlaybackRateSelector=new AudioPlaybackRateSelector({name:"timeline_audio_playback",currentRate:this._audioPlaybackRate,availableRates:[{rate:1,html:BX.Loc.getMessage("CRM_TIMELINE_PLAYBACK_RATE_SELECTOR_RATE_1").replace("#RATE#",'<span class="crm-audio-cap-speed-param">1x</span>')},{rate:1.5,html:BX.Loc.getMessage("CRM_TIMELINE_PLAYBACK_RATE_SELECTOR_RATE_1.5").replace("#RATE#",'<span class="crm-audio-cap-speed-param">1.5x</span>')},{rate:2,html:BX.Loc.getMessage("CRM_TIMELINE_PLAYBACK_RATE_SELECTOR_RATE_2").replace("#RATE#",'<span class="crm-audio-cap-speed-param">2x</span>')},{rate:3,html:BX.Loc.getMessage("CRM_TIMELINE_PLAYBACK_RATE_SELECTOR_RATE_3").replace("#RATE#",'<span class="crm-audio-cap-speed-param">3x</span>')}],textMessageCode:"CRM_TIMELINE_PLAYBACK_RATE_SELECTOR_TEXT"})}return this.audioPlaybackRateSelector}},{key:"hasScheduledItems",value:function e(){return this._schedule.getItems().length>0}}],[{key:"create",value:function t(i,s){const n=new e;n.initialize(i,s);e.instances[n.getId()]=n;return n}},{key:"getDefault",value:function t(){return _classStaticPrivateFieldSpecGet$1(e,e,_defaultInstance)}},{key:"setDefault",value:function t(i){_classStaticPrivateFieldSpecSet(e,e,_defaultInstance,i)}},{key:"getById",value:function t(i){return e.instances[i]||null}}]);return e}();var _defaultInstance={writable:true,value:null};babelHelpers.defineProperty(Manager,"instances",{});let WorkflowEventManager=function(){function e(t){babelHelpers.classCallCheck(this,e);this.hasRunningWorkflow=t.hasRunningWorkflow;this.hasWaitingWorkflowTask=t.hasWaitingWorkflowTask;this.workflowTaskActivityId=t.workflowTaskActivityId;this.workflowFirstTourClosed=t.workflowFirstTourClosed;this.workflowTaskStatusTitle=t.workflowTaskStatusTitle;this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){this.handleRunningWorkflow();this.handleWaitingWorkflowTask();this.subscribeToTimelineEvents();this.subscribeToPullEvents()}},{key:"handleRunningWorkflow",value:function e(){if(!this.hasRunningWorkflow){return}this.runFirstAutomationTour()}},{key:"runFirstAutomationTour",value:function e(){if(!document.querySelector(".bp_starter")){return}main_core_events.EventEmitter.emit("BX.Crm.Timeline.Bizproc::onAfterWorkflowStarted",{stepId:"on-after-started-workflow",target:".bp_starter"})}},{key:"handleWaitingWorkflowTask",value:function e(){if(!this.hasWaitingWorkflowTask){return}if(this.workflowFirstTourClosed){this.runSecondAutomationTour(`ACTIVITY_${this.workflowTaskActivityId}`)}else{main_core_events.EventEmitter.subscribe("UI.Tour.Guide:onFinish",(e=>{var t,i,s;const n=e.data;const a=n===null||n===void 0?void 0:(t=n.guide)===null||t===void 0?void 0:(i=t.steps)===null||i===void 0?void 0:(s=i[0])===null||s===void 0?void 0:s.id;if(a==="on-after-started-workflow"){this.runSecondAutomationTour(`ACTIVITY_${this.workflowTaskActivityId}`)}}))}}},{key:"runSecondAutomationTour",value:function e(t=null){if(!t){return}const i=document.querySelector(`div[data-id="${t}"]`);if(i&&this.isElementInViewport(i)){main_core_events.EventEmitter.emit("BX.Crm.Timeline.Bizproc::onAfterCreatedTask",{stepId:"on-after-created-task",target:i.querySelector(".crm-timeline__card-status")})}}},{key:"subscribeToTimelineEvents",value:function e(){main_core_events.EventEmitter.subscribe("BX.Crm.Timeline.Items.Bizproc:onAfterItemLayout",(e=>{var t;const i=e.data;if((i===null||i===void 0?void 0:(t=i.options)===null||t===void 0?void 0:t.add)===false){return}const s=(i===null||i===void 0?void 0:i.type)==="BizprocWorkflowStarted";if(s){this.runFirstAutomationTour()}const n=(i===null||i===void 0?void 0:i.type)==="Activity:BizprocTask";if(i!==null&&i!==void 0&&i.target&&this.isElementInViewport(i===null||i===void 0?void 0:i.target)&&n){main_core_events.EventEmitter.subscribe("UI.Tour.Guide:onFinish",(e=>{var t,s,n;const a=e.data;const r=a===null||a===void 0?void 0:(t=a.guide)===null||t===void 0?void 0:(s=t.steps)===null||s===void 0?void 0:(n=s[0])===null||n===void 0?void 0:n.id;const o=i===null||i===void 0?void 0:i.target.querySelector(".crm-timeline__card");const l=o.getAttribute("data-id");if(r==="on-after-started-workflow"&&l){this.runSecondAutomationTour(l)}}))}}))}},{key:"subscribeToPullEvents",value:function e(){main_core_events.EventEmitter.subscribe("onPullEvent-crm",(e=>{var t,i,s;const n=(t=e.data)===null||t===void 0?void 0:t[1];const a=(n===null||n===void 0?void 0:n.action)==="update";const r=n===null||n===void 0?void 0:(i=n.item)===null||i===void 0?void 0:i.layout;const o=(n===null||n===void 0?void 0:(s=n.item)===null||s===void 0?void 0:s.type)==="Activity:BizprocTask";const l=n===null||n===void 0?void 0:n.id;if(a&&r&&l&&o){var c,u,h;const e=document.querySelector(`div[data-id="${l}"]`);const t=(r===null||r===void 0?void 0:(c=r.header)===null||c===void 0?void 0:(u=c.tags)===null||u===void 0?void 0:(h=u.status)===null||h===void 0?void 0:h.title)===this.workflowTaskStatusTitle;if(t&&e){main_core_events.EventEmitter.emit("BX.Crm.Timeline.Bizproc::onAfterCompletedTask",{stepId:"on-after-completed-task",target:e.querySelector(".crm-timeline__card-top_checkbox")})}}}))}},{key:"isElementInViewport",value:function e(t){const i=t.getBoundingClientRect();return i.bottom>0&&i.top<(window.innerHeight||document.documentElement.clientHeight)}}]);return e}();let SchedulePostpone=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._button=null;e._clickHandler=BX.delegate(e.onClick,babelHelpers.assertThisInitialized(e));e._isMenuShown=false;e._menu=false;return e}babelHelpers.createClass(t,[{key:"doLayout",value:function e(){this._button=BX.create("DIV",{attrs:{className:this._isEnabled?"crm-entity-stream-planned-action-aside":"crm-entity-stream-planned-action-aside-disabled"},text:this.getMessage("postpone")});if(this._isEnabled){BX.bind(this._button,"click",this._clickHandler)}this._container.appendChild(this._button)}},{key:"openMenu",value:function e(){if(this._isMenuShown){return}const t=BX.delegate(this.onMenuItemClick,this);const i=[{id:"hour_1",text:this.getMessage("forOneHour"),onclick:t},{id:"hour_2",text:this.getMessage("forTwoHours"),onclick:t},{id:"hour_3",text:this.getMessage("forThreeHours"),onclick:t},{id:"day_1",text:this.getMessage("forOneDay"),onclick:t},{id:"day_2",text:this.getMessage("forTwoDays"),onclick:t},{id:"day_3",text:this.getMessage("forThreeDays"),onclick:t}];BX.PopupMenu.show(this._id,this._button,i,{offsetTop:0,offsetLeft:16,events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this),onPopupDestroy:BX.delegate(this.onMenuDestroy,this)}});this._menu=BX.PopupMenu.currentItem}},{key:"closeMenu",value:function e(){if(!this._isMenuShown){return}if(this._menu){this._menu.close()}}},{key:"onClick",value:function e(){if(!this._isEnabled){return}if(this._isMenuShown){this.closeMenu()}else{this.openMenu()}}},{key:"onMenuItemClick",value:function e(t,i){this.closeMenu();let s=0;if(i.id==="hour_1"){s=3600}else if(i.id==="hour_2"){s=7200}else if(i.id==="hour_3"){s=10800}else if(i.id==="day_1"){s=86400}else if(i.id==="day_2"){s=172800}else if(i.id==="day_3"){s=259200}if(s>0&&this._item){this._item.postpone(s)}}},{key:"onMenuShow",value:function e(){this._isMenuShown=true}},{key:"onMenuClose",value:function e(){if(this._menu&&this._menu.popupWindow){this._menu.popupWindow.destroy()}}},{key:"onMenuDestroy",value:function e(){this._isMenuShown=false;this._menu=null;if(typeof BX.PopupMenu.Data[this._id]!=="undefined"){delete BX.PopupMenu.Data[this._id]}}},{key:"getMessage",value:function e(i){const s=t.messages;return s.hasOwnProperty(i)?s[i]:i}}],[{key:"create",value:function e(i,s){const n=new t;n.initialize(i,s);return n}}]);return t}(Activity);babelHelpers.defineProperty(SchedulePostpone,"messages",{});let Comment$2=function(){function e(){babelHelpers.classCallCheck(this,e);this._node=null;this._anchor=null;this._nodeParent=null;this._startPosition=null;this._events=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i,s,n){this._node=t;this._anchor=i;this._nodeParent=t.parentNode;this._startPosition=s;this._events=BX.type.isPlainObject(n)?n:{}}},{key:"run",value:function e(){BX.addClass(this._node,"crm-entity-stream-section-animate-start");this._node.style.position="absolute";this._node.style.width=this._startPosition.width+"px";this._node.style.height=this._startPosition.height+"px";this._node.style.top=this._startPosition.top-30+"px";this._node.style.left=this._startPosition.left+"px";this._node.style.opacity=0;this._node.style.zIndex=960;document.body.appendChild(this._node);const t=new BX.easing({duration:350,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:BX.proxy((function(e){this._node.style.opacity=e.opacity/100}),this),complete:BX.proxy((function(){if(BX.type.isFunction(this._events["start"])){this._events["start"]()}const e=Shift.create(this._node,this._anchor,this._startPosition,false,{complete:BX.delegate(this.finish,this)});e.run()}),this)});t.animate();if(BX.type.isFunction(this._events["complete"])){this._events["complete"]()}}},{key:"finish",value:function e(){this._node.style.position="";this._node.style.width="";this._node.style.height="";this._node.style.top="";this._node.style.left="";this._node.style.opacity="";this._node.style.zIndex="";this._anchor.style.height="";this._anchor.parentNode.insertBefore(this._node,this._anchor.nextSibling);setTimeout(BX.delegate((function(){BX.removeClass(this._node,"crm-entity-stream-section-animate-start");BX.remove(this._anchor)}),this),0)}}],[{key:"create",value:function t(i,s,n,a){const r=new e;r.initialize(i,s,n,a);return r}}]);return e}();const Streams={History:History$1,FixedHistory:FixedHistory,EntityChat:EntityChat,Schedule:Schedule};const Tools={SchedulePostponeController:SchedulePostponeController,AudioPlaybackRateSelector:AudioPlaybackRateSelector,WorkflowEventManager:WorkflowEventManager};const Actions={Activity:Activity,Call:Call,HistoryCall:HistoryCall,ScheduleCall:ScheduleCall,Email:Email,HistoryEmail:HistoryEmail,ScheduleEmail:ScheduleEmail,OpenLine:OpenLine,SchedulePostpone:SchedulePostpone};const ScheduledItems={Activity:Activity$1,Email:Email$2,Call:Call$2,CallTracker:CallTracker,Meeting:Meeting$1,Task:Task$1,WebForm:WebForm$1,Wait:Wait$1,Request:Request$1,Rest:Rest$1,OpenLine:OpenLine$2,Zoom:Zoom$1};const Items={History:History,HistoryActivity:HistoryActivity,Comment:Comment$1,Modification:Modification,Mark:Mark$1,Creation:Creation,Restoration:Restoration,Relation:Relation,Link:Link,Unlink:Unlink,Email:Email$1,Call:Call$1,Meeting:Meeting,Task:Task,WebForm:WebForm,Wait:Wait,Document:Document,Sender:Sender,Bizproc:Bizproc,Request:Request,Rest:Rest,OpenLine:OpenLine$1,Zoom:Zoom,Conversion:Conversion,Visit:Visit,Scoring:Scoring,ExternalNoticeModification:ExternalNoticeModification,ExternalNoticeStatusModification:ExternalNoticeStatusModification,ScheduledBase:Scheduled,Scheduled:ScheduledItems};const Animations={Item:Item$1,ItemNew:ItemNew,Expand:Expand,Shift:Shift,Comment:Comment$2,Fasten:Fasten};exports.Manager=Manager;exports.Stream=Steam;exports.Streams=Streams;exports.Tools=Tools;exports.Types=types;exports.Action=Action$1;exports.Actions=Actions;exports.Items=Items;exports.Animations=Animations;exports.CompatibleItem=CompatibleItem})(this.BX.Crm.Timeline=this.BX.Crm.Timeline||{},BX,BX.UI.Analytics,BX.Main,BX.UI,BX.Vue3,BX,BX.Crm.Field,BX.Vue3.Directives,BX.Main,BX.UI,BX,BX.UI,BX,BX.Crm.Timeline,BX,BX.Crm.Timeline,BX.Event);
//# sourceMappingURL=timeline.bundle.map.js