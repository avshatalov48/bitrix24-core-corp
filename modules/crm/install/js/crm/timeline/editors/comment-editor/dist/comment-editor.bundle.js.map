{"version":3,"file":"comment-editor.bundle.js","sources":["../src/comment-editor.js"],"sourcesContent":["import { ajax as Ajax, Runtime, Text, Type } from 'main.core';\nimport { Loader } from \"main.loader\";\nimport { UI } from \"ui.notification\";\n\nexport class CommentEditor\n{\n\t#commentId: Number = null;\n\t#editorName: String = null;\n\t#editorContainer: HTMLElement = null;\n\t#editor: Object = null;\n\t#postForm: Object = null;\n\t#commentMessage: String = '';\n\t#loader: ?Loader;\n\n\tconstructor(commentId: Number)\n\t{\n\t\tif (commentId <= 0)\n\t\t{\n\t\t\tthrow new Error('Comment ID must be specified');\n\t\t}\n\n\t\tthis.#commentId = Text.toInteger(commentId);\n\t\tthis.#editorName = 'CrmTimeLineComment' + this.#commentId + BX.util.getRandomString(4);\n\t}\n\n\tshow(editorContainer: HTMLElement): void\n\t{\n\t\tthis.#editorContainer = Type.isDomNode(editorContainer) ? editorContainer : null;\n\t\tif (!this.#editorContainer)\n\t\t{\n\t\t\tthrow new Error('Editor container must be specified');\n\t\t}\n\n\t\tif (this.#postForm)\n\t\t{\n\t\t\tthis.#postForm.oEditor.SetContent(this.#commentMessage);\n\t\t\tthis.#editor.ReInitIframe();\n\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#showLoader(true);\n\n\t\tAjax.runAction('crm.api.timeline.loadEditor', {\n\t\t\tdata: {\n\t\t\t\tid: this.#commentId,\n\t\t\t\tname: this.#editorName\n\t\t\t}\n\t\t}).then(result => {\n\t\t\tconst assets = result.data.assets;\n\t\t\tconst assetsToLoad = [\n\t\t\t\t...assets.hasOwnProperty('css')\n\t\t\t\t\t? assets.css\n\t\t\t\t\t: [],\n\t\t\t\t...assets.hasOwnProperty('js')\n\t\t\t\t\t? assets.js\n\t\t\t\t\t: [],\n\t\t\t];\n\n\t\t\tBX.load(assetsToLoad, () => {\n\t\t\t\tif (assets.hasOwnProperty('string'))\n\t\t\t\t{\n\t\t\t\t\tPromise\n\t\t\t\t\t\t.all(assets.string.map((stringValue) => Runtime.html(null, stringValue)))\n\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\tthis.#onEditorHtmlLoad(result);\n\t\t\t\t\t\t})\n\t\t\t\t\t;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.#onEditorHtmlLoad(result);\n\t\t\t\t}\n\t\t\t});\n\t\t}).catch(result => {\n\t\t\tthis.#onRunRequestError(result);\n\t\t});\n\t}\n\n\tgetContent(): String\n\t{\n\t\tlet content = '';\n\n\t\tif (this.#postForm)\n\t\t{\n\t\t\tcontent = this.#postForm.oEditor.GetContent().trim();\n\n\t\t\tthis.#commentMessage = content;\n\t\t}\n\n\t\tif (!Type.isStringFilled(content))\n\t\t{\n\t\t\tUI.Notification.Center.notify({\n\t\t\t\tcontent: BX.message('CRM_TIMELINE_EMPTY_COMMENT_MESSAGE')\n\t\t\t});\n\t\t}\n\n\t\treturn content;\n\t}\n\n\tgetHtmlContent(): String\n\t{\n\t\tlet content = '';\n\n\t\tif (this.#postForm)\n\t\t{\n\t\t\tcontent =this.#postForm.oEditor.currentViewName === 'wysiwyg'\n\t\t\t\t? this.#postForm.oEditor.iframeView.GetValue()\n\t\t\t\t: this.#postForm.oEditor.content;\n\t\t}\n\n\t\treturn content;\n\t}\n\n\tgetAttachments(): Array\n\t{\n\t\tlet attachmentList = [];\n\n\t\tif (this.#postForm)\n\t\t{\n\t\t\tthis.#postForm.eventNode\n\t\t\t\t.querySelectorAll('input[name=\"UF_CRM_COMMENT_FILES[]\"]')\n\t\t\t\t.forEach(input => attachmentList.push(input.value))\n\t\t\t;\n\t\t}\n\n\t\treturn attachmentList;\n\t}\n\n\t#onEditorHtmlLoad(result: Object): void\n\t{\n\t\tif (Type.isObject(result) && Type.isObject(result.data) && Type.isStringFilled(result.data.html))\n\t\t{\n\t\t\tthis.#showLoader(false);\n\n\t\t\tRuntime.html(this.#editorContainer, result.data.html).then(() => {\n\t\t\t\tif (LHEPostForm)\n\t\t\t\t{\n\t\t\t\t\tsetTimeout(this.#showEditor.bind(this), 0);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#onRunRequestError(result);\n\t\t}\n\t}\n\n\t#onRunRequestError(result: Object): void\n\t{\n\t\tthis.#showLoader(false);\n\n\t\tif (Type.isObject(result) && Type.isArray(result.errors) && result.errors.length > 0)\n\t\t{\n\t\t\tUI.Notification.Center.notify({\n\t\t\t\tcontent: result.errors[0].message,\n\t\t\t\tautoHideDelay: 5000,\n\t\t\t});\n\t\t}\n\n\t\tif (result.status !== 'success')\n\t\t{\n\t\t\tthrow new Error('Unable to load editor component');\n\t\t}\n\t}\n\n\t#showEditor(): void\n\t{\n\t\tthis.#postForm = LHEPostForm.getHandler(this.#editorName);\n\t\tthis.#editor = BXHtmlEditor.Get(this.#editorName);\n\n\t\tBX.onCustomEvent(this.#postForm.eventNode, 'OnShowLHE', [true]);\n\n\t\tthis.#commentMessage = this.#postForm.oEditor.GetContent();\n\n\t\tif (this.#editor.dom)\n\t\t{\n\t\t\tthis.#editor.dom.textareaCont.style.opacity = 1;\n\t\t\tthis.#editor.dom.iframeCont.style.opacity = 1;\n\t\t}\n\n\t\tsetTimeout(() => { this.#editor.Focus(true); }, 100);\n\t}\n\n\t#showLoader(showLoader: boolean): void\n\t{\n\t\tif (showLoader)\n\t\t{\n\t\t\tif (!this.#loader && Loader)\n\t\t\t{\n\t\t\t\tthis.#loader = new Loader({size: 45, offset: { top: '1%' }});\n\t\t\t}\n\n\t\t\tthis.#loader.show(this.#editorContainer);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif (!this.#loader && Loader)\n\t\t\t{\n\t\t\t\tthis.#loader.hide();\n\t\t\t}\n\t\t}\n\t}\n}\n"],"names":["CommentEditor","constructor","commentId","Error","Text","toInteger","BX","util","getRandomString","show","editorContainer","Type","isDomNode","oEditor","SetContent","ReInitIframe","Ajax","runAction","data","id","name","then","result","assets","assetsToLoad","hasOwnProperty","css","js","load","Promise","all","string","map","stringValue","Runtime","html","catch","getContent","content","GetContent","trim","isStringFilled","UI","Notification","Center","notify","message","getHtmlContent","currentViewName","iframeView","GetValue","getAttachments","attachmentList","eventNode","querySelectorAll","forEach","input","push","value","isObject","LHEPostForm","setTimeout","bind","isArray","errors","length","autoHideDelay","status","getHandler","BXHtmlEditor","Get","onCustomEvent","dom","textareaCont","style","opacity","iframeCont","Focus","showLoader","Loader","size","offset","top","hide"],"mappings":"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"}