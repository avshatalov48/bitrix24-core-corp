{"version":3,"file":"comment-editor.bundle.js","sources":["../src/comment-editor.js"],"sourcesContent":["import { ajax as Ajax, Dom, Loc, Runtime, Text, Type } from 'main.core';\nimport { Loader } from 'main.loader';\nimport { UI } from 'ui.notification';\n\nexport class CommentEditor\n{\n\t#commentId: Number = null;\n\t#editorName: String = null;\n\t#editorContainer: HTMLElement = null;\n\t#editor: Object = null;\n\t#postForm: Object = null;\n\t#commentMessage: String = '';\n\t#loader: ?Loader;\n\n\tconstructor(commentId: Number)\n\t{\n\t\tif (commentId <= 0)\n\t\t{\n\t\t\tthrow new Error('Comment ID must be specified');\n\t\t}\n\n\t\tthis.#commentId = Text.toInteger(commentId);\n\t\tthis.#editorName = `CrmTimeLineComment${this.#commentId}${Text.getRandom(4)}`;\n\t}\n\n\tshow(editorContainer: HTMLElement): void\n\t{\n\t\tthis.#editorContainer = Type.isDomNode(editorContainer) ? editorContainer : null;\n\t\tif (!this.#editorContainer)\n\t\t{\n\t\t\tthrow new Error('Editor container must be specified');\n\t\t}\n\n\t\tif (this.#postForm)\n\t\t{\n\t\t\tthis.#postForm.oEditor.SetContent(this.#commentMessage);\n\t\t\tthis.#editor.ReInitIframe();\n\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#showLoader(true);\n\n\t\tAjax.runAction('crm.api.timeline.loadEditor', {\n\t\t\tdata: {\n\t\t\t\tid: this.#commentId,\n\t\t\t\tname: this.#editorName,\n\t\t\t},\n\t\t}).then((result) => {\n\t\t\tconst assets = result.data.assets;\n\t\t\tconst assetsToLoad = [\n\t\t\t\t...Object.prototype.hasOwnProperty.call(assets, 'css')\n\t\t\t\t\t? assets.css\n\t\t\t\t\t: [],\n\t\t\t\t...Object.prototype.hasOwnProperty.call(assets, 'js')\n\t\t\t\t\t? assets.js\n\t\t\t\t\t: [],\n\t\t\t];\n\n\t\t\t// eslint-disable-next-line @bitrix24/bitrix24-rules/no-bx\n\t\t\tBX.load(assetsToLoad, () => {\n\t\t\t\tif (Object.prototype.hasOwnProperty.call(assets, 'string'))\n\t\t\t\t{\n\t\t\t\t\tvoid Promise\n\t\t\t\t\t\t.all(assets.string.map((stringValue) => Runtime.html(null, stringValue)))\n\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\tthis.#onEditorHtmlLoad(result);\n\t\t\t\t\t\t})\n\t\t\t\t\t;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.#onEditorHtmlLoad(result);\n\t\t\t\t}\n\t\t\t});\n\t\t}).catch((result) => this.#onRunRequestError(result));\n\t}\n\n\tgetContent(): String\n\t{\n\t\tlet content = '';\n\n\t\tif (this.#postForm)\n\t\t{\n\t\t\tcontent = this.#postForm.oEditor.GetContent().trim();\n\n\t\t\tthis.#commentMessage = content;\n\t\t}\n\n\t\tif (!Type.isStringFilled(content))\n\t\t{\n\t\t\tUI.Notification.Center.notify({\n\t\t\t\tcontent: Loc.getMessage('CRM_TIMELINE_EMPTY_COMMENT_MESSAGE'),\n\t\t\t});\n\t\t}\n\n\t\treturn content;\n\t}\n\n\tgetHtmlContent(): String\n\t{\n\t\tlet content = '';\n\n\t\tif (this.#postForm)\n\t\t{\n\t\t\tcontent = this.#postForm.oEditor.currentViewName === 'wysiwyg'\n\t\t\t\t? this.#postForm.oEditor.iframeView.GetValue()\n\t\t\t\t: this.#postForm.oEditor.content;\n\t\t}\n\n\t\treturn content;\n\t}\n\n\tgetAttachments(): Array\n\t{\n\t\tconst attachmentList = [];\n\n\t\tif (this.#postForm)\n\t\t{\n\t\t\tthis.#postForm.eventNode\n\t\t\t\t.querySelectorAll('input[name=\"UF_CRM_COMMENT_FILES[]\"]')\n\t\t\t\t.forEach((input) => attachmentList.push(input.value))\n\t\t\t;\n\t\t}\n\n\t\treturn attachmentList;\n\t}\n\n\tgetAttachmentsAllowEditOptions(attachmentList: Array): Object\n\t{\n\t\tif (!Type.isArrayFilled(attachmentList))\n\t\t{\n\t\t\treturn {};\n\t\t}\n\n\t\tconst options = {};\n\n\t\tif (this.#postForm)\n\t\t{\n\t\t\tattachmentList.forEach((id: number | string) => {\n\t\t\t\tconst selectorName = `input[name=\"CRM_TIMELINE_DISK_ATTACHED_OBJECT_ALLOW_EDIT[${id}]\"`;\n\t\t\t\tconst selector = this.#postForm.eventNode.querySelector(selectorName);\n\t\t\t\tif (selector)\n\t\t\t\t{\n\t\t\t\t\toptions[id] = selector.value;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn options;\n\t}\n\n\t#onEditorHtmlLoad(result: Object): void\n\t{\n\t\tif (Type.isObject(result) && Type.isObject(result.data) && Type.isStringFilled(result.data.html))\n\t\t{\n\t\t\tthis.#showLoader(false);\n\n\t\t\tvoid Runtime.html(this.#editorContainer, result.data.html).then(() => {\n\t\t\t\t// eslint-disable-next-line no-undef\n\t\t\t\tif (LHEPostForm)\n\t\t\t\t{\n\t\t\t\t\tsetTimeout(this.#showEditor.bind(this), 0);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#onRunRequestError(result);\n\t\t}\n\t}\n\n\t#onRunRequestError(result: Object): void\n\t{\n\t\tthis.#showLoader(false);\n\n\t\tif (Type.isObject(result) && Type.isArray(result.errors) && result.errors.length > 0)\n\t\t{\n\t\t\tUI.Notification.Center.notify({\n\t\t\t\tcontent: result.errors[0].message,\n\t\t\t\tautoHideDelay: 5000,\n\t\t\t});\n\t\t}\n\n\t\tif (result.status !== 'success')\n\t\t{\n\t\t\tthrow new Error('Unable to load editor component');\n\t\t}\n\t}\n\n\t#showEditor(): void\n\t{\n\t\t// eslint-disable-next-line no-undef\n\t\tthis.#postForm = LHEPostForm.getHandler(this.#editorName);\n\t\t// eslint-disable-next-line no-undef\n\t\tthis.#editor = BXHtmlEditor.Get(this.#editorName);\n\n\t\t// eslint-disable-next-line @bitrix24/bitrix24-rules/no-bx\n\t\tBX.onCustomEvent(this.#postForm.eventNode, 'OnShowLHE', [true]);\n\n\t\tthis.#commentMessage = this.#postForm.oEditor.GetContent();\n\n\t\tif (this.#editor.dom)\n\t\t{\n\t\t\tDom.style(this.#editor.dom.textareaCont, {\n\t\t\t\topacity: 1,\n\t\t\t});\n\t\t\tDom.style(this.#editor.dom.iframeCont, {\n\t\t\t\topacity: 1,\n\t\t\t});\n\t\t}\n\n\t\tsetTimeout(() => {\n\t\t\tthis.#editor.Focus(true);\n\t\t}, 100);\n\t}\n\n\t#showLoader(showLoader: boolean): void\n\t{\n\t\tif (showLoader)\n\t\t{\n\t\t\tif (!this.#loader && Loader)\n\t\t\t{\n\t\t\t\tthis.#loader = new Loader({\n\t\t\t\t\tsize: 45,\n\t\t\t\t\toffset: {\n\t\t\t\t\t\ttop: '1%',\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis.#loader.show(this.#editorContainer);\n\t\t}\n\t\telse if (!this.#loader && Loader)\n\t\t{\n\t\t\tthis.#loader.hide();\n\t\t}\n\t}\n}\n"],"names":["CommentEditor","constructor","commentId","Error","Text","toInteger","getRandom","show","editorContainer","Type","isDomNode","oEditor","SetContent","ReInitIframe","Ajax","runAction","data","id","name","then","result","assets","assetsToLoad","Object","prototype","hasOwnProperty","call","css","js","BX","load","Promise","all","string","map","stringValue","Runtime","html","catch","getContent","content","GetContent","trim","isStringFilled","UI","Notification","Center","notify","Loc","getMessage","getHtmlContent","currentViewName","iframeView","GetValue","getAttachments","attachmentList","eventNode","querySelectorAll","forEach","input","push","value","getAttachmentsAllowEditOptions","isArrayFilled","options","selectorName","selector","querySelector","isObject","LHEPostForm","setTimeout","bind","isArray","errors","length","message","autoHideDelay","status","getHandler","BXHtmlEditor","Get","onCustomEvent","dom","Dom","style","textareaCont","opacity","iframeCont","Focus","showLoader","Loader","size","offset","top","hide"],"mappings":"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"}