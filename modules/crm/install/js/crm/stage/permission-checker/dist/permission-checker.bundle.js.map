{"version":3,"file":"permission-checker.bundle.js","sources":["../src/permission-checker.js"],"sourcesContent":["import { Loc } from 'main.core';\nimport 'ui.notification';\nimport { StageModel } from 'crm.stage-model';\n\nconst SEMANTICS_TRANSLATE_RULES = {\n\tprocess: null,\n\tsuccess: 'S',\n\tfailure: 'F',\n\tapology: 'F',\n};\n\nexport class PermissionChecker\n{\n\t#stages: Map<string, StageModel>;\n\n\tconstructor(stages: Map<string, StageModel>)\n\t{\n\t\tthis.#stages = stages;\n\t}\n\n\tisHasPermissionToMove(fromStatusId: string, toStatusId: string): boolean\n\t{\n\t\tif (fromStatusId === toStatusId)\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\tconst targetStage = this.#stages.get(toStatusId);\n\t\tif (!targetStage)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (targetStage.isAllowedMoveToAnyStage())\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\tconst stage = this.#stages.get(fromStatusId);\n\t\tif (!stage)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn (stage.getStagesToMove()?.includes(toStatusId) ?? false)\n\t\t\t|| (stage.isAllowedMoveToAnyStage())\n\t\t;\n\t}\n\n\tisHasPermissionToMoveAtLeastOneFailureStage(fromStatusId: string): boolean\n\t{\n\t\treturn this.getStages()\n\t\t\t.some((stage) => {\n\t\t\t\treturn stage.isFailure()\n\t\t\t\t\t&& this.isHasPermissionToMove(fromStatusId, stage.getStatusId())\n\t\t\t})\n\t\t;\n\t}\n\n\tisHasPermissionToMoveSuccessStage(fromStatusId: string): boolean\n\t{\n\t\treturn this.getStages()\n\t\t\t.some((stage) => {\n\t\t\t\treturn stage.isSuccess()\n\t\t\t\t\t&& this.isHasPermissionToMove(fromStatusId, stage.getStatusId())\n\t\t\t\t;\n\t\t\t})\n\t\t;\n\t}\n\n\tisHasPermissionToMoveAtLeastOneTerminationStage(fromStatusId: string): boolean\n\t{\n\t\treturn this.isHasPermissionToMoveSuccessStage(fromStatusId)\n\t\t\t|| this.isHasPermissionToMoveAtLeastOneFailureStage(fromStatusId)\n\t\t;\n\t}\n\n\tshowMissPermissionError(): void\n\t{\n\t\tBX.UI.Notification.Center.notify({\n\t\t\tcontent: Loc.getMessage('CRM_STAGE_MISS_PERMISSION_TO_MOVE_STAGE'),\n\t\t\tautoHideDelay: 2000,\n\t\t});\n\t}\n\n\tgetStages(): Array<StageModel>\n\t{\n\t\treturn [...this.#stages.values()];\n\t}\n\n\tstatic createFromStageModels(stages: Array<StageModel>): PermissionChecker\n\t{\n\t\tconst stagesMap = new Map();\n\n\t\tstages.forEach((stage) => {\n\t\t\tstagesMap.set(stage.getStatusId(), stage);\n\t\t});\n\n\t\treturn new PermissionChecker(stagesMap);\n\t}\n\n\tstatic createFromStageInfos(stageInfos: Array<Object>): PermissionChecker\n\t{\n\t\tconst stageModels = [];\n\n\t\tstageInfos.forEach((stageInfo) => {\n\t\t\tconst stageModelSemantics = SEMANTICS_TRANSLATE_RULES[stageInfo.semantics];\n\n\t\t\tconst stageModelData = { ...stageInfo };\n\t\t\tstageModelData.semantics = stageModelSemantics;\n\t\t\tstageModelData.statusId = stageInfo.id;\n\n\t\t\tconst stageModel = new StageModel(stageModelData);\n\t\t\tstageModels.push(stageModel);\n\t\t});\n\n\t\treturn PermissionChecker.createFromStageModels(stageModels);\n\t}\n}\n"],"names":["SEMANTICS_TRANSLATE_RULES","process","success","failure","apology","PermissionChecker","constructor","stages","Object","writable","value","babelHelpers","isHasPermissionToMove","fromStatusId","toStatusId","targetStage","get","isAllowedMoveToAnyStage","stage","getStagesToMove","_stage$getStagesToMov2","includes","isHasPermissionToMoveAtLeastOneFailureStage","this","getStages","some","isFailure","getStatusId","isHasPermissionToMoveSuccessStage","isSuccess","isHasPermissionToMoveAtLeastOneTerminationStage","showMissPermissionError","BX","UI","Notification","Center","notify","content","Loc","getMessage","autoHideDelay","values","[object Object]","stagesMap","Map","forEach","set","stageInfos","stageModels","stageInfo","stageModelSemantics","semantics","stageModelData","statusId","id","stageModel","StageModel","push","createFromStageModels"],"mappings":"+EAIA,MAAMA,EAA4B,CACjCC,QAAS,KACTC,QAAS,IACTC,QAAS,IACTC,QAAS,KACR,uDAEK,MAAMC,EAIZC,YAAYC,GACZC,8BAAAC,YAAAC,eACCC,mDAAeJ,EAGhBK,sBAAsBC,EAAsBC,GAC5C,QACC,GAAID,IAAiBC,EAEpB,OAAO,EAGR,MAAMC,EAAcJ,mDAAaK,IAAIF,GACrC,IAAKC,EAEJ,OAAO,EAGR,GAAIA,EAAYE,0BAEf,OAAO,EAGR,MAAMC,EAAQP,mDAAaK,IAAIH,GAC/B,QAAKK,sBAKGA,EAAMC,0BAANC,EAAyBC,SAASP,QACrCI,EAAMD,2BAIZK,4CAA4CT,GAE3C,OAAOU,KAAKC,YACVC,KAAMP,GACCA,EAAMQ,aACTH,KAAKX,sBAAsBC,EAAcK,EAAMS,gBAKtDC,kCAAkCf,GAEjC,OAAOU,KAAKC,YACVC,KAAMP,GACCA,EAAMW,aACTN,KAAKX,sBAAsBC,EAAcK,EAAMS,gBAMtDG,gDAAgDjB,GAE/C,OAAOU,KAAKK,kCAAkCf,IAC1CU,KAAKD,4CAA4CT,GAItDkB,0BAECC,GAAGC,GAAGC,aAAaC,OAAOC,OAAO,CAChCC,QAASC,MAAIC,WAAW,2CACxBC,cAAe,MAIjBhB,YAEC,MAAO,IAAIb,mDAAa8B,UAGzBC,6BAA6BnC,GAE5B,MAAMoC,EAAY,IAAIC,IAMtB,OAJArC,EAAOsC,QAAS3B,IACfyB,EAAUG,IAAI5B,EAAMS,cAAeT,KAG7B,IAAIb,EAAkBsC,GAG9BD,4BAA4BK,GAE3B,MAAMC,EAAc,GAapB,OAXAD,EAAWF,QAASI,IACnB,MAAMC,EAAsBlD,EAA0BiD,EAAUE,WAE1DC,EAAiB,IAAKH,GAC5BG,EAAeD,UAAYD,EAC3BE,EAAeC,SAAWJ,EAAUK,GAEpC,MAAMC,EAAa,IAAIC,aAAWJ,GAClCJ,EAAYS,KAAKF,KAGXlD,EAAkBqD,sBAAsBV"}