BX.EncodingHandler=function(){var e=function(){};e.prototype.handleEncodings=function(e){var t=e.formId;var r=e.file;var n=e.resultEncodingElementId;if(!r||r.name.substring(r.name.lastIndexOf(".")+1).toLowerCase()!=="csv"){BX.submit(BX(t),"next");return}var a=new FileReader;a.readAsBinaryString(r);a.onload=BX.delegate(function(a){var o=a.target.result;if(this.checkStringOnUtf8(o)){BX(n).value="UTF-8";BX.submit(BX(t),"next")}else{this.getPopupWithEncodings(e,r)}},this)};e.prototype.checkStringOnUtf8=function(e){var t=this.unpackBinaryString(e);var r=0;var n=0;t.forEach(function(e){var t=e&192;if(t===128){if(r===192)n++;else if((r&128)===0)n--}else if(r===192){n--}r=t});return n>0};e.prototype.unpackBinaryString=function(e){var t=[];for(var r=0;r<e.length;r++){var n=e.charCodeAt(r);t.push(n&255)}return t};e.prototype.getPopupWithEncodings=function(t,r){var n=t.charsets;var a=t.formId;var o=t.resultEncodingElementId;this._readers={};n.forEach(BX.delegate(function(t){this._readers[t]=new FileReader;this._readers[t].readAsText(r,t);this._readers[t].onload=BX.delegate(function(){var t=this.getEncodedResults();if(t)e.prototype.createPopup(t,a,o)},this)},this))};e.prototype.getEncodedResults=function(){var e=true;Object.keys(this._readers).forEach(BX.delegate(function(t){if(this._readers[t].readyState!==2)e=false},this));if(e){var t={};Object.keys(this._readers).forEach(BX.delegate(function(e){t[e]=this._readers[e].result},this));return t}return e};e.prototype.createPopup=function(e,t,r){var n=[];var a=50;Object.keys(e).forEach(function(s){var i=e[s].substring(0,a);var c=BX.create("label",{props:{className:"popup-window-label"},text:s});var l=BX.create("button",{props:{className:"popup-window-custom-button"},text:i,events:{click:function(){o.close();BX(r).value=s;BX.submit(BX(t),"next")}}});var u=BX.create("tr",{children:[BX.create("td",{props:{className:"popup-window-table-col-left"},children:[c]}),BX.create("td",{children:[l]})]});n.push(u)});var o=new BX.PopupWindow("popup_window",null,{content:BX.create("table",{children:n}),closeByEsc:true,closeIcon:false,autoHide:true,titleBar:{content:BX.create("label",{props:{className:"popup-window-custom-title"},html:BX.message("CRM_IMPORT_CSV_POPUP_WINDOW_TITLE")})},overlay:{backgroundColor:"#000",opacity:50},draggable:false,events:{onPopupClose:function(){this.destroy()}}});o.show()};return e}();