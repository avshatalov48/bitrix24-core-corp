this.BX=this.BX||{};(function(e,s,t,i,l,a,r){"use strict";function o(e,s,t){if(r.Type.isNil(e)){return e}return n(e,s,t)}function n(e,s,t){if(e instanceof s){return e}throw new Error(`Expected ${t} be an instance of ${s.name}, got ${c(e)} instead`)}function b(e,s){if(r.Type.isStringFilled(e)||r.Type.isNil(e)){return e}throw new Error(`Expected ${s} be either non-empty string or null, got ${c(e)} instead`)}function c(e){if(r.Type.isObject(e)&&!r.Type.isPlainObject(e)){var s;return(e==null?void 0:(s=e.constructor)==null?void 0:s.name)||"unknown"}return typeof e}const d=r.Extension.getSettings("crm.push-crm-settings").get("createTimeAliases",{});const v={};for(const e in d){v[e]={column:d[e],order:"desc"}}Object.freeze(v);var p=babelHelpers.classPrivateFieldLooseKey("entityTypeId");var u=babelHelpers.classPrivateFieldLooseKey("grid");var P=babelHelpers.classPrivateFieldLooseKey("disableLastActivitySort");var h=babelHelpers.classPrivateFieldLooseKey("enableLastActivitySort");var L=babelHelpers.classPrivateFieldLooseKey("isColumnExists");var y=babelHelpers.classPrivateFieldLooseKey("isColumnShowed");var H=babelHelpers.classPrivateFieldLooseKey("isColumnSortable");var F=babelHelpers.classPrivateFieldLooseKey("getShowedColumnList");var B=babelHelpers.classPrivateFieldLooseKey("setSortOrder");var f=babelHelpers.classPrivateFieldLooseKey("showColumn");class T{constructor(e,s){Object.defineProperty(this,f,{value:w});Object.defineProperty(this,B,{value:A});Object.defineProperty(this,F,{value:_});Object.defineProperty(this,H,{value:I});Object.defineProperty(this,y,{value:C});Object.defineProperty(this,L,{value:m});Object.defineProperty(this,h,{value:S});Object.defineProperty(this,P,{value:g});Object.defineProperty(this,p,{writable:true,value:void 0});Object.defineProperty(this,u,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,p)[p]=r.Text.toInteger(e);babelHelpers.classPrivateFieldLooseBase(this,u)[u]=n(s,BX.Main.grid,"grid")}isLastActivitySortSupported(){return babelHelpers.classPrivateFieldLooseBase(this,L)[L]("LAST_ACTIVITY_TIME")}isLastActivitySortEnabled(){const e=babelHelpers.classPrivateFieldLooseBase(this,u)[u].getUserOptions().getCurrentOptions();const s=e.last_sort_by;const t=e.last_sort_order;return(s==null?void 0:s.toLowerCase())==="last_activity_time"&&(t==null?void 0:t.toLowerCase())==="desc"}toggleLastActivitySort(){if(this.isLastActivitySortEnabled()){babelHelpers.classPrivateFieldLooseBase(this,P)[P]()}else{babelHelpers.classPrivateFieldLooseBase(this,h)[h]()}}}async function g(){const e=v[babelHelpers.classPrivateFieldLooseBase(this,p)[p]];let s;if(r.Type.isPlainObject(e)&&babelHelpers.classPrivateFieldLooseBase(this,L)[L](e.column)&&babelHelpers.classPrivateFieldLooseBase(this,H)[H](e.column)){s=e.column;if(!babelHelpers.classPrivateFieldLooseBase(this,y)[y](s)){await babelHelpers.classPrivateFieldLooseBase(this,f)[f](s)}babelHelpers.classPrivateFieldLooseBase(this,B)[B](s,e.order)}else{s=babelHelpers.classPrivateFieldLooseBase(this,F)[F]().find((e=>e!=="LAST_ACTIVITY_TIME"&&babelHelpers.classPrivateFieldLooseBase(this,H)[H](e)))}babelHelpers.classPrivateFieldLooseBase(this,u)[u].sortByColumn(s)}async function S(){if(!babelHelpers.classPrivateFieldLooseBase(this,y)[y]("LAST_ACTIVITY_TIME")){await babelHelpers.classPrivateFieldLooseBase(this,f)[f]("LAST_ACTIVITY_TIME")}babelHelpers.classPrivateFieldLooseBase(this,B)[B]("LAST_ACTIVITY_TIME","desc");babelHelpers.classPrivateFieldLooseBase(this,u)[u].sortByColumn("LAST_ACTIVITY_TIME")}function m(e){return babelHelpers.classPrivateFieldLooseBase(this,u)[u].getParam("COLUMNS_ALL",{}).hasOwnProperty(e)}function C(e){return babelHelpers.classPrivateFieldLooseBase(this,F)[F]().includes(e)}function I(e){const s=babelHelpers.classPrivateFieldLooseBase(this,u)[u].getColumnByName(e);return!!(s&&s.sort!==false)}function _(){return babelHelpers.classPrivateFieldLooseBase(this,u)[u].getSettingsWindow().getShowedColumns()}function A(e,s){babelHelpers.classPrivateFieldLooseBase(this,u)[u].getColumnByName(e).sort_order=s}function w(e){return new Promise(((s,t)=>{if(!babelHelpers.classPrivateFieldLooseBase(this,L)[L](e)){t(`Column ${e} does not exists`);return}if(babelHelpers.classPrivateFieldLooseBase(this,y)[y](e)){t(`Column ${e} is showed already`);return}const i=babelHelpers.classPrivateFieldLooseBase(this,u)[u].getSettingsWindow().getItems().find((s=>s.getId()===e));i==null?void 0:i.select();const l=babelHelpers.classPrivateFieldLooseBase(this,F)[F]();l.push(e);babelHelpers.classPrivateFieldLooseBase(this,u)[u].getSettingsWindow().saveColumns(l,s)}))}const E=r.Reflection.getClass("BX.CrmEntityType");const M="menu-popup-item-accept";const O="menu-popup-item-none";var j=babelHelpers.classPrivateFieldLooseKey("entityTypeId");var K=babelHelpers.classPrivateFieldLooseKey("rootMenu");var R=babelHelpers.classPrivateFieldLooseKey("targetItemId");var X=babelHelpers.classPrivateFieldLooseKey("kanbanController");var Y=babelHelpers.classPrivateFieldLooseKey("restriction");var N=babelHelpers.classPrivateFieldLooseKey("gridController");var V=babelHelpers.classPrivateFieldLooseKey("todoSkipMenu");var k=babelHelpers.classPrivateFieldLooseKey("isSetSortRequestRunning");var x=babelHelpers.classPrivateFieldLooseKey("smartActivityNotificationSupported");var G=babelHelpers.classPrivateFieldLooseKey("bindEvents");var $=babelHelpers.classPrivateFieldLooseKey("shouldShowPushCrmSettings");var U=babelHelpers.classPrivateFieldLooseKey("getItems");var W=babelHelpers.classPrivateFieldLooseKey("shouldShowLastActivitySortToggle");var q=babelHelpers.classPrivateFieldLooseKey("getLastActivitySortToggle");var z=babelHelpers.classPrivateFieldLooseKey("isLastActivitySortEnabled");var D=babelHelpers.classPrivateFieldLooseKey("handleLastActivitySortToggleClick");var J=babelHelpers.classPrivateFieldLooseKey("shouldShowTodoSkipMenu");class Q{constructor(e){Object.defineProperty(this,J,{value:re});Object.defineProperty(this,D,{value:ae});Object.defineProperty(this,z,{value:le});Object.defineProperty(this,q,{value:ie});Object.defineProperty(this,W,{value:te});Object.defineProperty(this,U,{value:se});Object.defineProperty(this,$,{value:ee});Object.defineProperty(this,G,{value:Z});Object.defineProperty(this,j,{writable:true,value:void 0});Object.defineProperty(this,K,{writable:true,value:void 0});Object.defineProperty(this,R,{writable:true,value:void 0});Object.defineProperty(this,X,{writable:true,value:void 0});Object.defineProperty(this,Y,{writable:true,value:void 0});Object.defineProperty(this,N,{writable:true,value:null});Object.defineProperty(this,V,{writable:true,value:void 0});Object.defineProperty(this,k,{writable:true,value:false});Object.defineProperty(this,x,{writable:true,value:false});babelHelpers.classPrivateFieldLooseBase(this,j)[j]=r.Text.toInteger(e.entityTypeId);babelHelpers.classPrivateFieldLooseBase(this,x)[x]=r.Text.toBoolean(e.smartActivityNotificationSupported);if(E&&!E.isDefined(babelHelpers.classPrivateFieldLooseBase(this,j)[j])){throw new Error(`Provided entityTypeId is invalid: ${babelHelpers.classPrivateFieldLooseBase(this,j)[j]}`)}babelHelpers.classPrivateFieldLooseBase(this,K)[K]=n(e.rootMenu,i.Menu,"params.rootMenu");babelHelpers.classPrivateFieldLooseBase(this,R)[R]=b(e.targetItemId,"params.targetItemId");babelHelpers.classPrivateFieldLooseBase(this,X)[X]=o(e.controller,l.SettingsController,"params.controller");babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]=o(e.restriction,a.Restriction,"params.restriction");if(r.Reflection.getClass("BX.Main.grid")&&e.grid){babelHelpers.classPrivateFieldLooseBase(this,N)[N]=new T(babelHelpers.classPrivateFieldLooseBase(this,j)[j],e.grid)}babelHelpers.classPrivateFieldLooseBase(this,V)[V]=new t.TodoNotificationSkipMenu({entityTypeId:babelHelpers.classPrivateFieldLooseBase(this,j)[j],selectedValue:b(e.todoCreateNotificationSkipPeriod,"params.todoCreateNotificationSkipPeriod")});babelHelpers.classPrivateFieldLooseBase(this,G)[G]()}}function Z(){const e=t=>{const i=t.getTarget();if(i.getId()!==babelHelpers.classPrivateFieldLooseBase(this,K)[K].getId()){return}s.EventEmitter.unsubscribe(s.EventEmitter.GLOBAL_TARGET,"onPopupShow",e);if(!babelHelpers.classPrivateFieldLooseBase(this,$)[$]()){return}const l=babelHelpers.classPrivateFieldLooseBase(this,K)[K].addMenuItem({text:r.Loc.getMessage("CRM_PUSH_CRM_SETTINGS_MENU_ITEM_TEXT"),items:[{id:"stub"}]},babelHelpers.classPrivateFieldLooseBase(this,R)[R]);l.subscribe("SubMenu:onShow",(e=>{var s;const t=e.getTarget();for(const e of babelHelpers.classPrivateFieldLooseBase(this,U)[U]()){var i;(i=t.getSubMenu())==null?void 0:i.addMenuItem(e)}(s=t.getSubMenu())==null?void 0:s.removeMenuItem("stub")}))};s.EventEmitter.subscribe(s.EventEmitter.GLOBAL_TARGET,"onPopupShow",e)}function ee(){return babelHelpers.classPrivateFieldLooseBase(this,U)[U]().length>0}function se(){const e=[];if(babelHelpers.classPrivateFieldLooseBase(this,W)[W]()){e.push(babelHelpers.classPrivateFieldLooseBase(this,q)[q]())}if(babelHelpers.classPrivateFieldLooseBase(this,J)[J]()){e.push(...babelHelpers.classPrivateFieldLooseBase(this,V)[V].getItems())}return e}function te(){var e,s,t;const i=((e=babelHelpers.classPrivateFieldLooseBase(this,X)[X])==null?void 0:e.getCurrentSettings().isTypeSupported(l.Type.BY_LAST_ACTIVITY_TIME))&&((s=babelHelpers.classPrivateFieldLooseBase(this,Y)[Y])==null?void 0:s.isSortTypeChangeAvailable());return!!(i||(t=babelHelpers.classPrivateFieldLooseBase(this,N)[N])!=null&&t.isLastActivitySortSupported())}function ie(){return{text:r.Loc.getMessage("CRM_PUSH_CRM_SETTINGS_SORT_TOGGLE_TEXT"),disabled:babelHelpers.classPrivateFieldLooseBase(this,k)[k],className:babelHelpers.classPrivateFieldLooseBase(this,z)[z]()?M:O,onclick:babelHelpers.classPrivateFieldLooseBase(this,D)[D].bind(this)}}function le(){if(babelHelpers.classPrivateFieldLooseBase(this,X)[X]){return babelHelpers.classPrivateFieldLooseBase(this,X)[X].getCurrentSettings().getCurrentType()===l.Type.BY_LAST_ACTIVITY_TIME}if(babelHelpers.classPrivateFieldLooseBase(this,N)[N]){return babelHelpers.classPrivateFieldLooseBase(this,N)[N].isLastActivitySortEnabled()}return false}function ae(e,s){var t,i;(t=s.getMenuWindow())==null?void 0:(i=t.getRootMenuWindow())==null?void 0:i.close();s.disable();if(babelHelpers.classPrivateFieldLooseBase(this,X)[X]){if(babelHelpers.classPrivateFieldLooseBase(this,k)[k]){return}babelHelpers.classPrivateFieldLooseBase(this,k)[k]=true;const e=babelHelpers.classPrivateFieldLooseBase(this,X)[X].getCurrentSettings();let t;if(e.getCurrentType()===l.Type.BY_LAST_ACTIVITY_TIME){t=e.getSupportedTypes().find((e=>e!==l.Type.BY_LAST_ACTIVITY_TIME))}else{t=l.Type.BY_LAST_ACTIVITY_TIME}babelHelpers.classPrivateFieldLooseBase(this,X)[X].setCurrentSortType(t).then((()=>{})).catch((()=>{})).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,k)[k]=false;s.enable()}))}else if(babelHelpers.classPrivateFieldLooseBase(this,N)[N]){babelHelpers.classPrivateFieldLooseBase(this,N)[N].toggleLastActivitySort();s.enable()}else{console.error("Can not handle last activity toggle click")}}function re(){return babelHelpers.classPrivateFieldLooseBase(this,x)[x]}const oe=r.Reflection.namespace("BX.Crm");oe.PushCrmSettings=Q;e.PushCrmSettings=Q})(this.BX.Crm=this.BX.Crm||{},BX.Event,BX.Crm.Activity,BX.Main,BX.CRM.Kanban,BX.CRM.Kanban,BX);
//# sourceMappingURL=push-crm-settings.bundle.map.js