this.BX=this.BX||{};(function(e,s,t,i,l,a,r,o){"use strict";function n(e,s,t){if(o.Type.isNil(e)){return e}return b(e,s,t)}function b(e,s,t){if(e instanceof s){return e}throw new Error(`Expected ${t} be an instance of ${s.name}, got ${d(e)} instead`)}function c(e,s){if(o.Type.isStringFilled(e)||o.Type.isNil(e)){return e}throw new Error(`Expected ${s} be either non-empty string or null, got ${d(e)} instead`)}function d(e){if(o.Type.isObject(e)&&!o.Type.isPlainObject(e)){var s;return(e==null?void 0:(s=e.constructor)==null?void 0:s.name)||"unknown"}return typeof e}const v=o.Extension.getSettings("crm.push-crm-settings").get("createTimeAliases",{});const p={};for(const e in v){p[e]={column:v[e],order:"desc"}}Object.freeze(p);var u=babelHelpers.classPrivateFieldLooseKey("entityTypeId");var P=babelHelpers.classPrivateFieldLooseKey("grid");var h=babelHelpers.classPrivateFieldLooseKey("disableLastActivitySort");var L=babelHelpers.classPrivateFieldLooseKey("enableLastActivitySort");var y=babelHelpers.classPrivateFieldLooseKey("isColumnExists");var H=babelHelpers.classPrivateFieldLooseKey("isColumnShowed");var F=babelHelpers.classPrivateFieldLooseKey("isColumnSortable");var B=babelHelpers.classPrivateFieldLooseKey("getShowedColumnList");var f=babelHelpers.classPrivateFieldLooseKey("setSortOrder");var g=babelHelpers.classPrivateFieldLooseKey("showColumn");class T{constructor(e,s){Object.defineProperty(this,g,{value:O});Object.defineProperty(this,f,{value:A});Object.defineProperty(this,B,{value:w});Object.defineProperty(this,F,{value:_});Object.defineProperty(this,H,{value:C});Object.defineProperty(this,y,{value:I});Object.defineProperty(this,L,{value:m});Object.defineProperty(this,h,{value:S});Object.defineProperty(this,u,{writable:true,value:void 0});Object.defineProperty(this,P,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,u)[u]=o.Text.toInteger(e);babelHelpers.classPrivateFieldLooseBase(this,P)[P]=b(s,BX.Main.grid,"grid")}isLastActivitySortSupported(){return babelHelpers.classPrivateFieldLooseBase(this,y)[y]("LAST_ACTIVITY_TIME")}isLastActivitySortEnabled(){const e=babelHelpers.classPrivateFieldLooseBase(this,P)[P].getUserOptions().getCurrentOptions();const s=e.last_sort_by;const t=e.last_sort_order;return(s==null?void 0:s.toLowerCase())==="last_activity_time"&&(t==null?void 0:t.toLowerCase())==="desc"}toggleLastActivitySort(){if(this.isLastActivitySortEnabled()){babelHelpers.classPrivateFieldLooseBase(this,h)[h]()}else{babelHelpers.classPrivateFieldLooseBase(this,L)[L]()}}}async function S(){const e=p[babelHelpers.classPrivateFieldLooseBase(this,u)[u]];let s;if(o.Type.isPlainObject(e)&&babelHelpers.classPrivateFieldLooseBase(this,y)[y](e.column)&&babelHelpers.classPrivateFieldLooseBase(this,F)[F](e.column)){s=e.column;if(!babelHelpers.classPrivateFieldLooseBase(this,H)[H](s)){await babelHelpers.classPrivateFieldLooseBase(this,g)[g](s)}babelHelpers.classPrivateFieldLooseBase(this,f)[f](s,e.order)}else{s=babelHelpers.classPrivateFieldLooseBase(this,B)[B]().find((e=>e!=="LAST_ACTIVITY_TIME"&&babelHelpers.classPrivateFieldLooseBase(this,F)[F](e)))}babelHelpers.classPrivateFieldLooseBase(this,P)[P].sortByColumn(s)}async function m(){if(!babelHelpers.classPrivateFieldLooseBase(this,H)[H]("LAST_ACTIVITY_TIME")){await babelHelpers.classPrivateFieldLooseBase(this,g)[g]("LAST_ACTIVITY_TIME")}babelHelpers.classPrivateFieldLooseBase(this,f)[f]("LAST_ACTIVITY_TIME","desc");babelHelpers.classPrivateFieldLooseBase(this,P)[P].sortByColumn("LAST_ACTIVITY_TIME")}function I(e){return babelHelpers.classPrivateFieldLooseBase(this,P)[P].getParam("COLUMNS_ALL",{}).hasOwnProperty(e)}function C(e){return babelHelpers.classPrivateFieldLooseBase(this,B)[B]().includes(e)}function _(e){const s=babelHelpers.classPrivateFieldLooseBase(this,P)[P].getColumnByName(e);return!!(s&&s.sort!==false)}function w(){return babelHelpers.classPrivateFieldLooseBase(this,P)[P].getSettingsWindow().getShowedColumns()}function A(e,s){babelHelpers.classPrivateFieldLooseBase(this,P)[P].getColumnByName(e).sort_order=s}function O(e){return new Promise(((s,t)=>{if(!babelHelpers.classPrivateFieldLooseBase(this,y)[y](e)){t(`Column ${e} does not exists`);return}if(babelHelpers.classPrivateFieldLooseBase(this,H)[H](e)){t(`Column ${e} is showed already`);return}const i=babelHelpers.classPrivateFieldLooseBase(this,P)[P].getSettingsWindow().getItems().find((s=>s.getId()===e));i==null?void 0:i.select();const l=babelHelpers.classPrivateFieldLooseBase(this,B)[B]();l.push(e);babelHelpers.classPrivateFieldLooseBase(this,P)[P].getSettingsWindow().saveColumns(l,s)}))}const M=o.Reflection.getClass("BX.CrmEntityType");const E="menu-popup-item-accept";const j="menu-popup-item-none";var K=babelHelpers.classPrivateFieldLooseKey("entityTypeId");var X=babelHelpers.classPrivateFieldLooseKey("pingSettings");var R=babelHelpers.classPrivateFieldLooseKey("rootMenu");var Y=babelHelpers.classPrivateFieldLooseKey("targetItemId");var N=babelHelpers.classPrivateFieldLooseKey("kanbanController");var V=babelHelpers.classPrivateFieldLooseKey("restriction");var k=babelHelpers.classPrivateFieldLooseKey("gridController");var x=babelHelpers.classPrivateFieldLooseKey("todoSkipMenu");var G=babelHelpers.classPrivateFieldLooseKey("todoPingSettingsMenu");var $=babelHelpers.classPrivateFieldLooseKey("isSetSortRequestRunning");var U=babelHelpers.classPrivateFieldLooseKey("smartActivityNotificationSupported");var W=babelHelpers.classPrivateFieldLooseKey("bindEvents");var q=babelHelpers.classPrivateFieldLooseKey("shouldShowPushCrmSettings");var z=babelHelpers.classPrivateFieldLooseKey("getItems");var D=babelHelpers.classPrivateFieldLooseKey("shouldShowLastActivitySortToggle");var J=babelHelpers.classPrivateFieldLooseKey("getLastActivitySortToggle");var Q=babelHelpers.classPrivateFieldLooseKey("isLastActivitySortEnabled");var Z=babelHelpers.classPrivateFieldLooseKey("handleLastActivitySortToggleClick");var ee=babelHelpers.classPrivateFieldLooseKey("shouldShowTodoSkipMenu");var se=babelHelpers.classPrivateFieldLooseKey("shouldShowTodoPingSettingsMenu");class te{constructor(e){Object.defineProperty(this,se,{value:de});Object.defineProperty(this,ee,{value:ce});Object.defineProperty(this,Z,{value:be});Object.defineProperty(this,Q,{value:ne});Object.defineProperty(this,J,{value:oe});Object.defineProperty(this,D,{value:re});Object.defineProperty(this,z,{value:ae});Object.defineProperty(this,q,{value:le});Object.defineProperty(this,W,{value:ie});Object.defineProperty(this,K,{writable:true,value:void 0});Object.defineProperty(this,X,{writable:true,value:void 0});Object.defineProperty(this,R,{writable:true,value:void 0});Object.defineProperty(this,Y,{writable:true,value:void 0});Object.defineProperty(this,N,{writable:true,value:void 0});Object.defineProperty(this,V,{writable:true,value:void 0});Object.defineProperty(this,k,{writable:true,value:null});Object.defineProperty(this,x,{writable:true,value:void 0});Object.defineProperty(this,G,{writable:true,value:void 0});Object.defineProperty(this,$,{writable:true,value:false});Object.defineProperty(this,U,{writable:true,value:false});babelHelpers.classPrivateFieldLooseBase(this,K)[K]=o.Text.toInteger(e.entityTypeId);babelHelpers.classPrivateFieldLooseBase(this,X)[X]=o.Type.isPlainObject(e.pingSettings)?e.pingSettings:{};babelHelpers.classPrivateFieldLooseBase(this,U)[U]=o.Text.toBoolean(e.smartActivityNotificationSupported);if(M&&!M.isDefined(babelHelpers.classPrivateFieldLooseBase(this,K)[K])){throw new Error(`Provided entityTypeId is invalid: ${babelHelpers.classPrivateFieldLooseBase(this,K)[K]}`)}babelHelpers.classPrivateFieldLooseBase(this,R)[R]=b(e.rootMenu,l.Menu,"params.rootMenu");babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]=c(e.targetItemId,"params.targetItemId");babelHelpers.classPrivateFieldLooseBase(this,N)[N]=n(e.controller,a.SettingsController,"params.controller");babelHelpers.classPrivateFieldLooseBase(this,V)[V]=n(e.restriction,r.Restriction,"params.restriction");if(o.Reflection.getClass("BX.Main.grid")&&e.grid){babelHelpers.classPrivateFieldLooseBase(this,k)[k]=new T(babelHelpers.classPrivateFieldLooseBase(this,K)[K],e.grid)}babelHelpers.classPrivateFieldLooseBase(this,x)[x]=new t.TodoNotificationSkipMenu({entityTypeId:babelHelpers.classPrivateFieldLooseBase(this,K)[K],selectedValue:c(e.todoCreateNotificationSkipPeriod,"params.todoCreateNotificationSkipPeriod")});if(Object.keys(babelHelpers.classPrivateFieldLooseBase(this,X)[X]).length>0){babelHelpers.classPrivateFieldLooseBase(this,G)[G]=new i.TodoPingSettingsMenu({entityTypeId:babelHelpers.classPrivateFieldLooseBase(this,K)[K],settings:babelHelpers.classPrivateFieldLooseBase(this,X)[X]})}babelHelpers.classPrivateFieldLooseBase(this,W)[W]()}}function ie(){const e=t=>{const i=t.getTarget();if(i.getId()!==babelHelpers.classPrivateFieldLooseBase(this,R)[R].getId()){return}s.EventEmitter.unsubscribe(s.EventEmitter.GLOBAL_TARGET,"onPopupShow",e);if(!babelHelpers.classPrivateFieldLooseBase(this,q)[q]()){return}const l=babelHelpers.classPrivateFieldLooseBase(this,R)[R].addMenuItem({text:o.Loc.getMessage("CRM_PUSH_CRM_SETTINGS_MENU_ITEM_TEXT"),items:[{id:"stub"}]},babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]);l.subscribe("SubMenu:onShow",(e=>{var s;const t=e.getTarget();for(const e of babelHelpers.classPrivateFieldLooseBase(this,z)[z]()){var i;(i=t.getSubMenu())==null?void 0:i.addMenuItem(e)}(s=t.getSubMenu())==null?void 0:s.removeMenuItem("stub")}))};s.EventEmitter.subscribe(s.EventEmitter.GLOBAL_TARGET,"onPopupShow",e)}function le(){return babelHelpers.classPrivateFieldLooseBase(this,z)[z]().length>0}function ae(){const e=[];if(babelHelpers.classPrivateFieldLooseBase(this,D)[D]()){e.push(babelHelpers.classPrivateFieldLooseBase(this,J)[J]())}if(babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]()){e.push(...babelHelpers.classPrivateFieldLooseBase(this,x)[x].getItems())}if(babelHelpers.classPrivateFieldLooseBase(this,se)[se]()){var s;e.push(...(s=babelHelpers.classPrivateFieldLooseBase(this,G)[G])==null?void 0:s.getItems())}return e}function re(){var e,s,t;const i=((e=babelHelpers.classPrivateFieldLooseBase(this,N)[N])==null?void 0:e.getCurrentSettings().isTypeSupported(a.Type.BY_LAST_ACTIVITY_TIME))&&((s=babelHelpers.classPrivateFieldLooseBase(this,V)[V])==null?void 0:s.isSortTypeChangeAvailable());return!!(i||(t=babelHelpers.classPrivateFieldLooseBase(this,k)[k])!=null&&t.isLastActivitySortSupported())}function oe(){return{text:o.Loc.getMessage("CRM_PUSH_CRM_SETTINGS_SORT_TOGGLE_TEXT"),disabled:babelHelpers.classPrivateFieldLooseBase(this,$)[$],className:babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]()?E:j,onclick:babelHelpers.classPrivateFieldLooseBase(this,Z)[Z].bind(this)}}function ne(){if(babelHelpers.classPrivateFieldLooseBase(this,N)[N]){return babelHelpers.classPrivateFieldLooseBase(this,N)[N].getCurrentSettings().getCurrentType()===a.Type.BY_LAST_ACTIVITY_TIME}if(babelHelpers.classPrivateFieldLooseBase(this,k)[k]){return babelHelpers.classPrivateFieldLooseBase(this,k)[k].isLastActivitySortEnabled()}return false}function be(e,s){var t,i;(t=s.getMenuWindow())==null?void 0:(i=t.getRootMenuWindow())==null?void 0:i.close();s.disable();if(babelHelpers.classPrivateFieldLooseBase(this,N)[N]){if(babelHelpers.classPrivateFieldLooseBase(this,$)[$]){return}babelHelpers.classPrivateFieldLooseBase(this,$)[$]=true;const e=babelHelpers.classPrivateFieldLooseBase(this,N)[N].getCurrentSettings();let t;if(e.getCurrentType()===a.Type.BY_LAST_ACTIVITY_TIME){t=e.getSupportedTypes().find((e=>e!==a.Type.BY_LAST_ACTIVITY_TIME))}else{t=a.Type.BY_LAST_ACTIVITY_TIME}babelHelpers.classPrivateFieldLooseBase(this,N)[N].setCurrentSortType(t).then((()=>{})).catch((()=>{})).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,$)[$]=false;s.enable()}))}else if(babelHelpers.classPrivateFieldLooseBase(this,k)[k]){babelHelpers.classPrivateFieldLooseBase(this,k)[k].toggleLastActivitySort();s.enable()}else{console.error("Can not handle last activity toggle click")}}function ce(){return babelHelpers.classPrivateFieldLooseBase(this,U)[U]}function de(){return babelHelpers.classPrivateFieldLooseBase(this,G)[G]&&babelHelpers.classPrivateFieldLooseBase(this,D)[D]()}const ve=o.Reflection.namespace("BX.Crm");ve.PushCrmSettings=te;e.PushCrmSettings=te})(this.BX.Crm=this.BX.Crm||{},BX.Event,BX.Crm.Activity,BX.Crm.Activity,BX.Main,BX.CRM.Kanban,BX.CRM.Kanban,BX);
//# sourceMappingURL=push-crm-settings.bundle.map.js