this.BX=this.BX||{};(function(t,e,n,i,r,a){"use strict";function s(){var t=babelHelpers.taggedTemplateLiteral(['<div class="zoom-error-message ui-alert ui-alert-danger ui-alert-icon-danger">\n\t\t\t\t<span class="ui-alert-message">',"</span>\n\t\t\t</div>"]);s=function e(){return t};return t}function o(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-timeline-zoom-editor">\n\t\t\t\t',"\n\t\t\t</div>"]);o=function e(){return t};return t}function l(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span onclick="','" class="ui-btn ui-btn-xs ui-btn-light-border">\n\t\t\t\t\t',"\n\t\t\t\t</span>\n\t\t\t"]);l=function e(){return t};return t}function c(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<button onclick="','" class="ui-btn ui-btn-xs ui-btn-primary">\n\t\t\t\t\t',"\n\t\t\t\t</button>\n\t\t\t"]);c=function e(){return t};return t}function u(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-entity-stream-content-zoom-btn-container">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"]);u=function e(){return t};return t}function d(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-entity-stream-content-zoom-planner-container"></div>\n\t\t\t']);d=function e(){return t};return t}function m(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-entity-stream-content-new-zoom">\n\t\t\t\t\t<div class="crm-entity-stream-content-new-zoom-inner">\n\t\t\t\t\t\t<div class="crm-entity-stream-content-new-zoom-field">\n\t\t\t\t\t\t\t<div class="crm-entity-stream-content-new-zoom-field-inner">\n\t\t\t\t\t\t\t\t<label for="" class="crm-entity-stream-content-new-zoom-field-label">','</label>\n\t\t\t\t\t\t\t\t<div class="ui-ctl ui-ctl-sm ui-ctl-w100 ui-ctl-textbox">\n\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="crm-entity-stream-content-new-zoom-field">\n\t\t\t\t\t\t\t<div class="crm-entity-stream-content-new-zoom-field-block">\n\t\t\t\t\t\t\t\t<label for="" class="crm-entity-stream-content-new-zoom-field-label">','</label>\n\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-new-zoom-field-control">\n\t\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t\t\t",'\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="crm-entity-stream-content-new-zoom-field-block">\n\t\t\t\t\t\t\t\t<label for="" class="crm-entity-stream-content-new-zoom-field-label">','</label>\n\t\t\t\t\t\t\t\t<div class="crm-entity-stream-content-new-zoom-field-control">\n\t\t\t\t\t\t\t\t\t<div class="ui-ctl ui-ctl-sm crm-entity-stream-content-new-zoom-field-xs">\n\t\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="ui-ctl ui-ctl-sm ui-ctl-after-icon ui-ctl-dropdown crm-entity-stream-content-new-zoom-field-sm">\n\t\t\t\t\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<br>\n\t\t\t\t\t\t","\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"]);m=function e(){return t};return t}function h(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<select class="ui-ctl-element">\n\t\t\t\t\t<option value="m">','</option>\n\t\t\t\t\t<option value="h">',"</option>\n\t\t\t\t</select>\n\t\t\t"]);h=function e(){return t};return t}function v(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input type="text" class="ui-ctl-element" value="30">\n\t\t\t']);v=function e(){return t};return t}function f(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input type="text" class="ui-ctl-element" value="','">\n\t\t\t']);f=function e(){return t};return t}function g(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-ctl-element">12:00</div>\n\t\t\t']);g=function e(){return t};return t}function p(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-ctl ui-ctl-sm ui-ctl-after-icon ui-ctl-dropdown crm-entity-stream-content-new-zoom-field-sm">\n\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"]);p=function e(){return t};return t}function T(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input type="text" class="ui-ctl-element">\n\t\t\t']);T=function e(){return t};return t}function b(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-ctl ui-ctl-sm ui-ctl-after-icon ui-ctl-date">\n\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-calendar"></div>\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"]);b=function e(){return t};return t}var E=function(t){babelHelpers.inherits(i,t);function i(t){var n;babelHelpers.classCallCheck(this,i);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this,t));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"TITLE","Zoom");babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"error",false);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"errorMessages",[]);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"cache",new e.Cache.MemoryCache);n.containerId=t.container;n.manager=t.manager;n.userId=+t.userId;n.setEventNamespace("BX.UI.Timeline.ZoomEditor");e.Dom.append(n.getFormContainer(),BX(n.containerId));e.Event.bind(n.getDateContainer(),"click",function(t){n.onDateFieldClick(t)});e.Event.bind(n.getTimeContainer(),"click",function(){n.onTimeSwitchClick(n.getTimeInputField())});e.Event.bind(n.getDateContainer(),"change",function(){n.onUpdateDateTime()});e.Event.bind(n.getTimeContainer(),"change",function(){n.onUpdateDateTime()});e.Event.bind(n.getDurationInputField(),"change",function(){n.onUpdateDateTime()});e.Event.bind(n.getDurationTypeInputField(),"change",function(){n.onUpdateDateTime()});return n}babelHelpers.createClass(i,[{key:"getTitle",value:function t(){return this.TITLE}},{key:"getStartDateTime",value:function t(){var e=BX.parseDate(this.getDateInputField().value).getTime()+this.unFormatTime(this.getTimeInputField().textContent)*1e3;return new Date(e)}},{key:"getEndDateTime",value:function t(){var e=+this.getDurationInputField().value;var n=this.getDurationTypeInputField().value;if(n==="h"){e*=60*60*1e3}else{e*=60*1e3}var i=new Date;i.setTime(this.getStartDateTime().getTime()+e);return i}},{key:"onUpdateDateTime",value:function t(){this.planner.updateSelector(this.getStartDateTime(),this.getEndDateTime(),false)}},{key:"onDateFieldClick",value:function t(e){BX.calendar({node:e.currentTarget,field:this.getDateInputField(),bTime:false});return false}},{key:"onTimeSwitchClick",value:function t(e){var n=this;if(!this.clockInstance){this.clockInstance=new BX.CClockSelector({start_time:this.unFormatTime(e.textContent),node:e,callback:BX.doNothing})}this.clockInstance.setNode(e);this.clockInstance.setTime(this.unFormatTime(e.textContent));this.clockInstance.setCallback(function(t){e.textContent=t;BX.fireEvent(e,"change");n.clockInstance.closeWnd()});this.clockInstance.Show()}},{key:"formatTime",value:function t(e){var n=BX.date.convertBitrixFormat(BX.message("FORMAT_DATE")).replace(/:?\s*s/,""),i=BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME")).replace(/:?\s*s/,""),r=BX.date.format(n,e),a=BX.date.format(i,e);return BX.util.trim(a.replace(r,""))}},{key:"unFormatTime",value:function t(e){var n=e.split(/[\s:]+/);if(n.length==3){var i=n[2];if(i=="pm"&&n[0]<12)n[0]=parseInt(n[0],10)+12;if(i=="am"&&n[0]==12)n[0]=0}return parseInt(n[0],10)*3600+parseInt(n[1],10)*60}},{key:"getDateContainer",value:function t(){var n=this;return this.cache.remember("startDateContainer",function(){return e.Tag.render(b(),n.getDateInputField())})}},{key:"getDateInputField",value:function t(){return this.cache.remember("startDateInputField",function(){return e.Tag.render(T())})}},{key:"getTimeContainer",value:function t(){var n=this;return this.cache.remember("startTimeContainer",function(){return e.Tag.render(p(),n.getTimeInputField())})}},{key:"getTimeInputField",value:function t(){return this.cache.remember("startTimeInputField",function(){return e.Tag.render(g())})}},{key:"getTitleInputField",value:function t(){return this.cache.remember("titleInputField",function(){return e.Tag.render(f(),e.Loc.getMessage("CRM_ZOOM_NEW_CONFERENCE_TITLE_PLACEHOLDER"))})}},{key:"getDurationInputField",value:function t(){return this.cache.remember("durationInputField",function(){return e.Tag.render(v())})}},{key:"getDurationTypeInputField",value:function t(){return this.cache.remember("durationTypeInputField",function(){return e.Tag.render(h(),e.Loc.getMessage("CRM_ZOOM_NEW_CONFERENCE_DURATION_MINUTES"),e.Loc.getMessage("CRM_ZOOM_NEW_CONFERENCE_DURATION_HOURS"))})}},{key:"getFormContainer",value:function t(){var n=this;return this.cache.remember("formContainer",function(){return e.Tag.render(m(),e.Loc.getMessage("CRM_ZOOM_NEW_CONFERENCE_TITLE"),n.getTitleInputField(),e.Loc.getMessage("CRM_ZOOM_NEW_CONFERENCE_DATE_CAPTION"),n.getDateContainer(),n.getTimeContainer(),e.Loc.getMessage("CRM_ZOOM_NEW_CONFERENCE_DURATION_CAPTION"),n.getDurationInputField(),n.getDurationTypeInputField(),n.renderPlanner())})}},{key:"renderPlanner",value:function t(){return this.cache.remember("plannerContainer",function(){return e.Tag.render(d())})}},{key:"renderButtons",value:function t(){var n=this;return this.cache.remember("buttonsContainer",function(){return e.Tag.render(u(),n.renderSaveButton(),n.renderCancelButton())})}},{key:"renderSaveButton",value:function t(){var n=this;return this.cache.remember("saveButton",function(){return e.Tag.render(c(),n.save.bind(n),e.Loc.getMessage("UI_BUTTONS_CREATE_BTN_TEXT"))})}},{key:"refreshStartTimeView",value:function t(){var e=new Date;var n=e.getMinutes();var i=n%5;var r=5;if(i>0){e.setMinutes(n-i+r)}this.getDateInputField().value=BX.formatDate(e,BX.message("FORMAT_DATE"));this.getTimeInputField().innerHTML=this.formatTime(e)}},{key:"renderCancelButton",value:function t(){var n=this;return this.cache.remember("cancelButton",function(){return e.Tag.render(l(),n.cancel.bind(n),e.Loc.getMessage("UI_TIMELINE_EDITOR_COMMENT_CANCEL"))})}},{key:"render",value:function t(){this.refreshStartTimeView();this.initPlanner();this.layout.container=e.Tag.render(o(),this.renderButtons());return this.getContainer()}},{key:"initPlanner",value:function t(){this.planner=new r.Planner({wrap:this.renderPlanner(),showEntryName:false,showEntiesHeader:false,entriesListWidth:70});this.planner.show();this.loadPlannerData({codes:["U"+this.userId],from:a.Util.formatDate(this.getStartDateTime().getTime()-a.Util.getDayLength()*3),to:a.Util.formatDate(this.getStartDateTime().getTime()+a.Util.getDayLength()*10)});this.planner.updateSelector(this.getStartDateTime(),this.getEndDateTime(),false);this.planner.subscribe("onDateChange",this.handlePlannerSelectorChanges.bind(this))}},{key:"handlePlannerSelectorChanges",value:function t(e){if(e instanceof n.BaseEvent){var i=e.getData();var r=i.dateFrom;var a=(i.dateTo-i.dateFrom)/1e3/60;var s=this.getDurationTypeInputField().value;this.getDateInputField().value=BX.formatDate(r,BX.message("FORMAT_DATE"));this.getTimeInputField().innerHTML=this.formatTime(r);if(s==="h"&&a%60===0){this.getDurationInputField().value=a/60;this.getDurationTypeInputField().value="h"}else{this.getDurationInputField().value=a;this.getDurationTypeInputField().value="m"}}}},{key:"loadPlannerData",value:function t(){var e=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.planner.showLoader();BX.ajax.runAction("calendar.api.calendarajax.updatePlanner",{data:{codes:n.codes||[],dateFrom:n.from||"",dateTo:n.to||""}}).then(function(t){e.planner.hideLoader();e.planner.update(t.data.entries,t.data.accessibility)},function(t){console.error(t.errors)})}},{key:"onFocus",value:function t(){var n=this.getContainer();if(n){e.Dom.addClass(n,"focus")}}},{key:"save",value:function t(){this.cleanError();e.Dom.addClass(this.renderSaveButton(),"ui-btn-wait");var n=this.manager.getOwnerInfo();var i=n["ENTITY_ID"];var r=n["ENTITY_TYPE_NAME"];var a=this.getDateInputField().value;var s=this.getTimeInputField().textContent;var o=this.getStartDateTime().getTime();var l=a+" "+s;var c=this.getTitleInputField().value;var u=+this.getDurationInputField().value;var d=this.getDurationTypeInputField().value;if(!e.Type.isString(c)||c===""){this.errorMessages.push("".concat(e.Loc.getMessage("CRM_ZOOM_ERROR_EMPTY_TITLE")));this.showError()}if(!e.Type.isInteger(o)||o<Date.now()){this.errorMessages.push("".concat(e.Loc.getMessage("CRM_ZOOM_ERROR_INCORRECT_DATETIME")));this.showError()}if(!e.Type.isInteger(u)||u<=0||!["h","m"].includes(d)){this.errorMessages.push("".concat(e.Loc.getMessage("CRM_ZOOM_ERROR_INCORRECT_DURATION")));this.showError()}if(!this.error){BX.ajax.runAction("crm.api.zoomUser.createConference",{data:{conferenceParams:{conferenceTitle:c,dateTimeStart:l,timestampStart:o,duration:u,durationType:d},entityId:i,entityType:r},analyticsLabel:{}}).then(function(t){e.Dom.removeClass(this.renderSaveButton(),"ui-btn-wait");this.cancel()}.bind(this),function(t){e.Dom.removeClass(this.renderSaveButton(),"ui-btn-wait");this.errorMessages.push("".concat(e.Loc.getMessage("CRM_ZOOM_CREATE_MEETING_SERVER_RETURNS_ERROR")));this.errorMessages.push(t.errors[0].message);this.showError();console.error(t.errors)}.bind(this))}}},{key:"cancel",value:function t(){this.refreshTitle();this.refreshStartTimeView();this.refreshDuration();this.planner.updateSelector(this.getStartDateTime(),this.getEndDateTime(),false);this.setVisible(false);this.manager._commentEditor.setVisible(true);this.manager._menuBar.setActiveItemById("comment")}},{key:"setVisible",value:function t(e){var n=this.getContainer();if(!e){if(n){BX.hide(n)}}else{if(!n){n=this.renderInside()}if(n){BX.show(n)}this.onFocus()}}},{key:"renderInside",value:function t(){if(e.Type.isStringFilled(this.containerId)){var n=document.querySelector("#"+this.containerId);this.render();if(e.Type.isElementNode(n)){var i=this.layout.container.firstElementChild;while(i){n.appendChild(i);i=i.nextSibling}e.Dom.remove(this.layout.container);e.Dom.addClass(n,"ui-timeline-zoom-editor");this.layout.container=n}}this.containerId=null;return this.getContainer()}},{key:"showError",value:function t(){var n="";this.errorMessages.forEach(function(t){n+=t+"\n"});if(!this.error&&n!==""){this.errorElement=e.Tag.render(s(),n);e.Dom.append(this.errorElement,this.layout.container.firstElementChild);this.error=true}e.Dom.removeClass(this.renderSaveButton(),"ui-btn-wait")}},{key:"cleanError",value:function t(){if(this.error){if(e.Type.isDomNode(this.errorElement)){e.Dom.remove(this.errorElement);this.error=false;this.errorMessages=[]}}}},{key:"refreshTitle",value:function t(){this.getTitleInputField().value=e.Loc.getMessage("CRM_ZOOM_NEW_CONFERENCE_TITLE_PLACEHOLDER")}},{key:"refreshDuration",value:function t(){this.getDurationInputField().value=30;this.getDurationTypeInputField().value="m"}}],[{key:"onNotConnectedHandler",value:function t(e){var n=document.location.href;var i="/company/personal/user/"+e+"/social_services/";BX.SidePanel.Instance.open(i,{events:{allowChangeHistory:false,onClose:function t(){top.location.href=n}}})}},{key:"onNotAvailableHandler",value:function t(){BX.UI.InfoHelper.show("limit_video_conference_zoom_crm")}}]);return i}(i.Timeline.Editor);t.Zoom=E})(this.BX.Crm=this.BX.Crm||{},BX,BX.Event,BX.UI,BX.Calendar,BX.Calendar);
//# sourceMappingURL=zoom.bundle.map.js