BX.CrmDiskUploader=function(){this._id="";this._settings={};this._messages={};this._agent=null;this._form=this._wrapper=this._switchContainer=this._container=this._fileInput=this._fileSelector=this._label=this._dropZoneWrapper=this._dropZone=this._itemContainer=null;this._mode=BX.CrmInterfaceMode.edit;this._items=[];this._fileUploadStartHandler=BX.delegate(this._onFileUploadStart,this);this._fileUploadProgressHandler=BX.delegate(this._onFileUploadProgress,this);this._fileUploadCompleteHandler=BX.delegate(this._onFileUploadComplete,this);this._fileUploadErrorHandler=BX.delegate(this._onFileUploadError,this);this._fileSelectButtonClickHandler=BX.delegate(this._onFileSelectButtonClick,this);this._fileDialogInitHandler=BX.delegate(this._onFileDialogInit,this);this._dropZoneMouseOverHandler=BX.delegate(this._onDropZoneMouseOver,this);this._dropZoneMouseOutHandler=BX.delegate(this._onDropZoneMouseOut,this);this._agentErrorHandler=BX.delegate(this._onAgentError,this);this._agentFileInputReinitHandler=BX.delegate(this._onAgentFileInputReinit,this);this._agentFileInitHandler=BX.delegate(this._onAgentFileInit,this);this._uploadFileUrl="/bitrix/tools/disk/uf.php?action=uploadfile";this._selectFileUrl="/bitrix/tools/disk/uf.php?action=selectFile";this._isShown=false;this._hasLayout=false};BX.CrmDiskUploader.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._messages=this.getSetting("msg",{})},getId:function(){return this._id},getSetting:function(e,t){return typeof this._settings[e]!="undefined"?this._settings[e]:t},getMessages:function(){return this.getSetting("msg",{})},getMessage:function(e,t){if(typeof t==="undefined"){t=""}return this._messages.hasOwnProperty(e)?this._messages[e]:t},getFileInputName:function(){return this._fileInput},getPlaceHolder:function(){return this._itemContainer},getMode:function(){return this._mode},setMode:function(e){if(this._mode===e){return}if(this._hasLayout){throw"Could not set mode while control has layout."}this._mode=e},getAgent:function(){return this._agent},getItems:function(){return this._items},getItem:function(e){for(var t=0;t<this._items.length;t++){var i=this._items[t];if(i.getId()===e){return i}}return null},hasItems:function(){return this._items.length>0},getFileIds:function(){var e=[];for(var t=0;t<this._items.length;t++){var i=this._items[t].getFileId();if(i>0){e.push(i)}}return e},getValues:function(){return this.getFileIds()},setValues:function(e){for(var t=0;t<e.length;t++){var i=e[t];var s=typeof i["ID"]!=="undefined"?parseInt(i["ID"]):0;var r=this.addItem(s.toString(),{fileId:s,name:i["NAME"],size:i["SIZE"],viewUrl:BX.type.isNotEmptyString(i["VIEW_URL"])?i["VIEW_URL"]:"",progress:100});if(this._hasLayout){r.setContainer(this._itemContainer);r.layout()}}if(this.hasItems()){this.show(true)}},clearValues:function(){this.removeAllItems()},removeItem:function(e){for(var t=0;t<this._items.length;t++){if(this._items[t]===e){e.cleanLayout();this._items.splice(t,1);return}}},removeAllItems:function(){for(var e=0;e<this._items.length;e++){this._items[e].cleanLayout()}this._items=[]},layout:function(e){var t=this._mode;if(t===BX.CrmInterfaceMode.edit){this.prepareEditLayout(e);this._agent=BX.Uploader.getInstance({id:this._id,allowUpload:"A",uploadMethod:"immediate",uploadFileUrl:this._uploadFileUrl,deleteFileOnServer:true,filesInputMultiple:true,filesInputName:this.getFileInputName(),input:this._fileInput,dropZone:this._dropZone,showImage:false,fields:{preview:{params:{width:212,height:119}}}});BX.addCustomEvent(this._agent,"onError",this._agentErrorHandler);BX.addCustomEvent(this._agent,"onFileinputIsReinited",this._agentFileInputReinitHandler);BX.addCustomEvent(this._agent,"onFileIsInited",this._agentFileInitHandler);this._container.style.display=this._isShown?"block":"none";this._switchContainer.style.display=this._isShown?"none":"block";this._label.style.display=this.hasItems()?"":"none"}else if(t===BX.CrmInterfaceMode.view){this._prepareViewLayout(e)}for(var i=0;i<this._items.length;i++){var s=this._items[i];s.setContainer(this._itemContainer);s.layout()}this._hasLayout=true},cleanLayout:function(){if(!this._hasLayout){return}if(this._agent){BX.removeCustomEvent(this._agent,"onError",this._agentErrorHandler);BX.removeCustomEvent(this._agent,"onFileinputIsReinited",this._agentFileInputReinitHandler);BX.removeCustomEvent(this._agent,"onFileIsInited",this._agentFileInitHandler)}if(this._dropZoneWrapper){BX.unbind(this._dropZoneWrapper,"mouseover",this._dropZoneMouseOverHandler);BX.unbind(this._dropZoneWrapper,"mouseout",this._dropZoneMouseOutHandler)}if(this._fileSelector){BX.unbind(this._fileSelector,"click",this._fileSelectButtonClickHandler)}if(this._wrapper){BX.cleanNode(this._wrapper,true)}for(var e=0;e<this._items.length;e++){var t=this._items[e];t.cleanLayout();t.setContainer(null)}this._form=this._wrapper=this._switchContainer=this._container=this._fileInput=this._label=this._dropZone=this._itemContainer=null;this._hasLayout=false},show:function(e){e=!!e;if(this._isShown===e){return}this._isShown=e;if(this._hasLayout){this._container.style.display=e?"block":"none";this._switchContainer.style.display=e?"none":"block"}},showLabel:function(e){if(this._hasLayout){this._label.style.display=!!e?"":"none"}},prepareEditLayout:function(e){if(!BX.type.isElementNode(e)){return}this._form=BX.create("FORM",{});e.appendChild(this._form);this._form.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"sessid",value:BX.bitrix_sessid()}}));this._switchContainer=BX.create("DIV",{attrs:{className:"bx-crm-add-file-link"},children:[BX.create("SPAN",{attrs:{className:"bx-crm-add-file-link-text"},text:this.getMessage("diskAttachFiles"),events:{click:BX.delegate(this._onSwitchButtonClick,this)}})]});this._form.appendChild(this._switchContainer);this._container=BX.create("DIV",{attrs:{className:"bx-crm-dialog-activity-diskuf-container"}});this._form.appendChild(this._container);this._container.style.height="auto";this._innerContainer=BX.create("DIV",{attrs:{className:"bx-crm-dialog-activity-diskuf-container-inner"}});this._container.appendChild(this._innerContainer);this._wrapper=BX.create("DIV",{attrs:{className:"diskuf-selectdialog"}});this._innerContainer.appendChild(this._wrapper);this._wrapper.style.display="block";this._wrapper.style.opacity="1";var t=BX.create("DIV",{attrs:{className:"diskuf-files-block"}});t.style.display="block";this._wrapper.appendChild(t);this._label=BX.create("DIV",{attrs:{className:"diskuf-label"},children:[BX.create("SPAN",{text:this.getMessage("diskAttachedFiles")+":"}),BX.create("SPAN",{attrs:{className:"diskuf-label-icon"}})]});t.appendChild(this._label);var i=BX.create("DIV",{attrs:{className:"diskuf-placeholder"}});t.appendChild(i);this._itemContainer=BX.create("TABLE",{attrs:{className:"files-list",cellspacing:"0",cellpadding:"0",border:"0"}});i.appendChild(this._itemContainer);var s=BX.create("DIV",{attrs:{className:"diskuf-extended"}});s.style.display="block";this._wrapper.appendChild(s);var r=BX.create("TABLE",{attrs:{className:"diskuf-selector-table wd-fa-add-file-light-table",cellspacing:"0",cellpadding:"0",border:"0"}});s.appendChild(r);var a=r.insertRow(-1);var n=a.insertCell(-1);n.className="wd-fa-add-file-light-cell";this._fileSelector=BX.create("DIV",{attrs:{className:"wd-fa-add-file-light-title-text diskuf-selector-link"},text:this.getMessage("diskSelectFile")});BX.bind(this._fileSelector,"click",this._fileSelectButtonClickHandler);n.appendChild(BX.create("SPAN",{attrs:{className:"wd-fa-add-file-light"},children:[BX.create("SPAN",{attrs:{className:"wd-fa-add-file-light-text"},children:[BX.create("SPAN",{attrs:{className:"wd-fa-add-file-light-title"},children:[this._fileSelector]}),BX.create("SPAN",{attrs:{className:"wd-fa-add-file-light-descript"},text:this.getMessage("diskSelectFileLegend")})]})]}));n=a.insertCell(-1);n.className="wd-fa-add-file-form-light-separate-cell";n.appendChild(BX.create("DIV",{attrs:{className:"wd-fa-add-file-form-light-spacer"}}));n=this._dropZoneWrapper=a.insertCell(-1);n.className="diskuf-selector wd-fa-add-file-light-cell wd-fa-add-file-from-main";this._fileInput=BX.create("INPUT",{attrs:{className:"diskuf-fileUploader wd-test-file-light-inp "},props:{type:"file",size:1,multiple:"multiple",name:this.getFileInputName()}});if(BX.browser.IsIE()){this._dropZone=BX.create("DIV",{attrs:{className:"wduf-selector"},children:[BX.create("SPAN",{attrs:{className:"wduf-uploader"},children:[BX.create("SPAN",{attrs:{className:"wduf-uploader-left"}}),BX.create("SPAN",{attrs:{className:"wduf-but-text"},text:this.getMessage("loadFiles")}),BX.create("SPAN",{attrs:{className:"wduf-uploader-right"}}),this._fileInput]})]})}else{this._dropZone=BX.create("DIV",{attrs:{className:"diskuf-uploader"},children:[BX.create("SPAN",{attrs:{className:"wd-fa-add-file-light"},children:[BX.create("SPAN",{attrs:{className:"wd-fa-add-file-light-text"},children:[BX.create("SPAN",{attrs:{className:"wd-fa-add-file-light-title"},children:[BX.create("SPAN",{attrs:{className:"wd-fa-add-file-light-title-text"},text:this.getMessage("diskUploadFile")})]}),BX.create("SPAN",{attrs:{className:"wd-fa-add-file-light-descript"},text:this.getMessage("diskUploadFileLegend")})]})]}),this._fileInput]})}n.appendChild(this._dropZone);BX.bind(n,"mouseover",this._dropZoneMouseOverHandler);BX.bind(n,"mouseout",this._dropZoneMouseOutHandler)},_prepareViewLayout:function(e){if(!BX.type.isElementNode(e)){return}this._form=BX.create("FORM",{});e.appendChild(this._form);this._form.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"sessid",value:BX.bitrix_sessid()}}));this._container=BX.create("DIV",{attrs:{className:"bx-crm-dialog-activity-diskuf-container"}});this._form.appendChild(this._container);this._container.style.height="auto";this._innerContainer=BX.create("DIV",{attrs:{className:"bx-crm-dialog-activity-diskuf-container-inner"}});this._container.appendChild(this._innerContainer);this._wrapper=BX.create("DIV",{attrs:{className:"diskuf-selectdialog"}});this._innerContainer.appendChild(this._wrapper);this._wrapper.style.display="block";this._wrapper.style.opacity="1";var t=BX.create("DIV",{attrs:{className:"diskuf-files-block"}});t.style.display="block";this._wrapper.appendChild(t);this._label=BX.create("DIV",{attrs:{className:"diskuf-label"},children:[BX.create("SPAN",{text:this.getMessage("diskAttachedFiles")+":"}),BX.create("SPAN",{attrs:{className:"diskuf-label-icon"}})]});t.appendChild(this._label);var i=BX.create("DIV",{attrs:{className:"diskuf-placeholder"}});t.appendChild(i);this._itemContainer=BX.create("TABLE",{attrs:{className:"files-list",cellspacing:"0",cellpadding:"0",border:"0"}});i.appendChild(this._itemContainer)},processItemDeletion:function(e){this.removeItem(e);if(!this.hasItems()){this.showLabel(false)}},_onSwitchButtonClick:function(e){this.show(true);return BX.PreventDefault(e)},_onAgentFileInputReinit:function(e){if(e||this._agent.fileInput){this._fileInput=e?e:this._agent.fileInput}},_onAgentError:function(e,t,i){},_onAgentFileInit:function(e,t,i){BX.addCustomEvent(t,"onUploadStart",this._fileUploadStartHandler);BX.addCustomEvent(t,"onUploadProgress",this._fileUploadProgressHandler);BX.addCustomEvent(t,"onUploadDone",this._fileUploadCompleteHandler);BX.addCustomEvent(t,"onUploadError",this._fileUploadErrorHandler)},addItem:function(e,t){var i=BX.CrmDiskUploaderItem.create(e,{uploader:this,container:this._itemContainer,name:BX.type.isNotEmptyString(t.name)?t.name:"",size:BX.type.isNotEmptyString(t.size)?t.size:"",fileId:BX.type.isNumber(t.fileId)?t.fileId:0,viewUrl:BX.type.isNotEmptyString(t.viewUrl)?t.viewUrl:"",progress:BX.type.isNumber(t.progress)?t.progress:0});this._items.push(i);return i},_onFileUploadStart:function(e,t,i,s){var r=this.addItem(e.id,{name:e.name,size:e.size,fileId:0,progress:parseInt(t)});r.layout()},_onFileUploadProgress:function(e,t,i,s){var r=this.getItem(e.id);if(r){if(t>=100)t=99;r.setProgress(t)}},_onFileUploadComplete:function(e,t,i,s){var r=this.getItem(e.id);if(!r){return}r.setProgress(100);BX.removeCustomEvent(e,"onUploadStart",this._fileUploadStartHandler);BX.removeCustomEvent(e,"onUploadProgress",this._fileUploadProgressHandler);BX.removeCustomEvent(e,"onUploadDone",this._fileUploadCompleteHandler);BX.removeCustomEvent(e,"onUploadError",this._fileUploadErrorHandler);var a=0;if(typeof t.file!=="undefined"){if(typeof t.file["fileId"]!=="undefined"){a=parseInt(t.file["fileId"])}else if(typeof t.file["originalId"]!=="undefined"){a=parseInt(t.file["originalId"])}}if(a>0){r.setFileId(a)}this.showLabel(true)},_onFileUploadError:function(e,t,i,s){var r=this.getItem(e.id);if(r){r.remove()}BX.removeCustomEvent(e,"onUploadStart",this._fileUploadStartHandler);BX.removeCustomEvent(e,"onUploadProgress",this._fileUploadProgressHandler);BX.removeCustomEvent(e,"onUploadDone",this._fileUploadCompleteHandler);BX.removeCustomEvent(e,"onUploadError",this._fileUploadErrorHandler)},_onFileSelectButtonClick:function(e){BX.addCustomEvent(BX.DiskFileDialog,"inited",this._fileDialogInitHandler);BX.ajax({url:this._selectFileUrl,method:"GET",timeout:30});return BX.PreventDefault(e)},_onFileDialogInit:function(e){BX.removeCustomEvent(BX.DiskFileDialog,"inited",this._fileDialogInitHandler);this.flagFileDialogInited=true;BX.DiskFileDialog.obCallback[e]={saveButton:BX.delegate(this._onFileSelect,this)};BX.DiskFileDialog.openDialog(e)},_onFileSelect:function(e,t,i){for(var s in i){if(!i.hasOwnProperty(s)){return}var r=i[s];var a=BX.type.isNotEmptyString(r["type"])?r["type"]:"";if(a!=="file"){continue}var n=BX.type.isNotEmptyString(r["id"])?r["id"]:"";if(n===""){continue}var l=/^n(\d+)$/;var o=l.exec(n);if(o&&o.length>1){var d=parseInt(o[1]);if(d>0){var h=BX.type.isNotEmptyString(r["name"])?r["name"]:n;var p=BX.type.isNotEmptyString(r["size"])?r["size"]:0;this.addItem(n,{fileId:d,name:h,size:p,progress:100}).layout()}}}},_onDropZoneMouseOver:function(e){BX.addClass(this._dropZoneWrapper,"wd-fa-add-file-light-hover")},_onDropZoneMouseOut:function(e){BX.removeClass(this._dropZoneWrapper,"wd-fa-add-file-light-hover")}};BX.CrmDiskUploader.items={};BX.CrmDiskUploader.create=function(e,t){if(!BX.type.isNotEmptyString(e)){e="BX_CRM_FILEUPLOADER_"+Math.random()}var i=new BX.CrmDiskUploader;i.initialize(e,t);this.items[e]=i;return i};BX.CrmDiskUploaderItem=function(){this._id="";this._settings={};this._fileId=0;this._name="";this._size="";this._viewUrl="";this._progress=0;this._uploader=this._container=this._wrapper=null;this._progressContainer=this._progressWrap=this._progressTerminateBtn=this._progressBar=this._progressText=this._deleteButton=null;this._deleteButtonClickHandler=BX.delegate(this._onDeleteButtonClick,this);this._hasLayout=false};BX.CrmDiskUploaderItem.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._uploader=this.getSetting("uploader");this._container=this.getSetting("container");this._fileId=parseInt(this.getSetting("fileId",0));this._name=this.getSetting("name","");this._size=this.getSetting("size","");this._viewUrl=this.getSetting("viewUrl","");this.setProgress(this.getSetting("progress",0))},getId:function(){return this._id},getSetting:function(e,t){return typeof this._settings[e]!="undefined"?this._settings[e]:t},getFileId:function(){return this._fileId},setFileId:function(e){this._fileId=e},getName:function(){return this._name},getSize:function(){return this._size},getProgress:function(){return this._progress},setProgress:function(e){e=parseInt(e);if(isNaN(e)||e<0){e=0}if(e>100){e=100}if(this._progress===e){return}this._progress=e;if(this._hasLayout){this._progressBar.style.width=this._progress+"%";this._progressText.innerHTML=this._progress+"%";this._progressWrap.style.display=e<100?"":"none"}},getContainer:function(){return this._container},setContainer:function(e){this._container=e},layout:function(){if(this._hasLayout){return}if(!this._container){throw"Error: Could not find container."}var e=this._wrapper=this._container.insertRow(-1);var t=e.insertCell(-1);t.className="files-name";if(this._viewUrl!==""){t.appendChild(BX.create("A",{attrs:{className:"files-text",href:this._viewUrl},text:this._name}))}else{t.appendChild(BX.create("SPAN",{attrs:{className:"files-text"},text:this._name}))}t=e.insertCell(-1);t.className="files-size";t.innerHTML=this._size;t=this._progressContainer=e.insertCell(-1);t.className="files-storage";this._progressWrap=BX.create("SPAN",{attrs:{className:"feed-add-post-loading-wrap"}});t.appendChild(this._progressWrap);this._progressTerminateBtn=BX.create("SPAN",{attrs:{className:"feed-add-post-loading-cancel del-but"}});BX.bind(this._progressTerminateBtn,"click",this._deleteButtonClickHandler);this._progressWrap.appendChild(BX.create("SPAN",{attrs:{className:"feed-add-post-loading"},children:[this._progressTerminateBtn]}));this._progressBar=BX.create("SPAN",{attrs:{className:"feed-add-post-load-indicator"},style:{width:this._progress+"%"}});this._progressWrap.appendChild(this._progressBar);this._progressText=BX.create("SPAN",{attrs:{className:"feed-add-post-load-number"},text:this._progress+"%"});this._progressBar.appendChild(this._progressText);if(this._progress===100){this._progressWrap.style.display="none"}t=e.insertCell(-1);t.className="files-del-btn";if(this._uploader.getMode()===BX.CrmInterfaceMode.edit){this._deleteButton=BX.create("SPAN",{attrs:{className:"del-but"}});BX.bind(this._deleteButton,"click",this._deleteButtonClickHandler);t.appendChild(this._deleteButton)}this._hasLayout=true},cleanLayout:function(){if(!this._hasLayout){return}BX.unbind(this._progressTerminateBtn,"click",this._deleteButtonClickHandler);if(this._deleteButton){BX.unbind(this._deleteButton,"click",this._deleteButtonClickHandler)}this._container.deleteRow(this._wrapper.rowIndex);this._wrapper=this._progressContainer=this._progressWrap=this._progressTerminateBtn=this._progressBar=this._progressText=this._deleteButton=null;this._hasLayout=false},remove:function(){if(this._uploader.getMode()!==BX.CrmInterfaceMode.edit){return}var e=this._uploader.getAgent();if(e){var t=e.queue.items.getItem(this._id);if(t){t.deleteFile()}}this._uploader.processItemDeletion(this)},_onDeleteButtonClick:function(e){this.remove()}};BX.CrmDiskUploaderItem.create=function(e,t){var i=new BX.CrmDiskUploaderItem;i.initialize(e,t);return i};