{"version":3,"file":"item-selector.bundle.js","sources":["../src/item-selector-button.js","../src/item-selector.js"],"sourcesContent":["import { Dom, Loc, Text } from 'main.core';\nimport { Button, ButtonOptions } from 'ui.buttons';\n\nconst DEFAULT_CLASS = 'crm-field-item-selector__add-btn';\n\nexport const ItemSelectorButtonState = Object.freeze({\n\tADD: 'add',\n\tMORE_ADD: 'more-add',\n\tCOUNTER_ADD: 'counter-add',\n});\n\nexport class ItemSelectorButton extends Button\n{\n\tconstructor(options: ButtonOptions)\n\t{\n\t\tsuper(options);\n\n\t\tDom.addClass(this.getContainer(), DEFAULT_CLASS);\n\t}\n\n\tgetDefaultOptions(): Object\n\t{\n\t\treturn {\n\t\t\tid: `item-selector-button-${Text.getRandom()}`,\n\t\t\ttext: Loc.getMessage('CRM_FIELD_ITEM_SELECTOR_DEFAULT_ADD_BUTTON_LABEL'),\n\t\t\ttag: Button.Tag.SPAN,\n\t\t\tsize: Button.Size.EXTRA_SMALL,\n\t\t\tcolor: Button.Color.LIGHT,\n\t\t\tround: true,\n\t\t\tdropdown: true,\n\t\t};\n\t}\n\n\tapplyState(state: string, counter: number = 0): void\n\t{\n\t\tswitch (state)\n\t\t{\n\t\t\tcase ItemSelectorButtonState.MORE_ADD:\n\t\t\t\tthis.setText(\n\t\t\t\t\tLoc.getMessage('CRM_FIELD_ITEM_SELECTOR_DEFAULT_MORE_BUTTON_LABEL'),\n\t\t\t\t);\n\t\t\t\tbreak;\n\t\t\tcase ItemSelectorButtonState.COUNTER_ADD:\n\t\t\t\tthis.setText(\n\t\t\t\t\tLoc.getMessage('CRM_FIELD_ITEM_SELECTOR_DEFAULT_MORE_COUNTER_BUTTON_LABEL')?.replace('#COUNTER#', counter),\n\t\t\t\t);\n\t\t\t\tbreak;\n\t\t\tcase ItemSelectorButtonState.ADD:\n\t\t\tdefault:\n\t\t\t\tthis.setText(\n\t\t\t\t\tLoc.getMessage('CRM_FIELD_ITEM_SELECTOR_DEFAULT_ADD_BUTTON_LABEL'),\n\t\t\t\t);\n\t\t\t\tbreak;\n\t\t}\n\t}\n}\n","import { Dom, Event, Runtime, Tag, Text, Type } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { MenuItem, MenuManager } from 'main.popup';\nimport { ItemSelectorButton, ItemSelectorButtonState } from './item-selector-button';\nimport { ItemSelectorOptions } from './item-selector-options';\n\nimport 'ui.design-tokens';\nimport './item-selector.css';\n\nconst MENU_ITEM_CLASS_ACTIVE = 'menu-popup-item-accept';\nconst MENU_ITEM_CLASS_INACTIVE = 'menu-popup-item-none';\n\ntype Item = {\n\tid: string | number;\n\ttitle: string;\n}\n\nexport const CompactIcons = {\n\tNONE: null,\n\tBELL: 'bell',\n};\n\nexport const Events = {\n\tEVENT_ITEMSELECTOR_OPEN: 'crm.field.itemselector:open',\n\tEVENT_ITEMSELECTOR_VALUE_CHANGE: 'crm.field.itemselector:change',\n};\n\nexport class ItemSelector\n{\n\t// options\n\t#id: ?string;\n\t#target: ?HTMLElement = null;\n\t#valuesList: Item[] = [];\n\t#selectedValues: Array<string | number> = [];\n\t#readonlyMode: boolean = false;\n\t#compactMode: boolean = false;\n\t#icon: ?string = null;\n\t#htmlItemCallback: ?Function = null;\n\t#multiple: boolean = true;\n\n\t// local\n\t#containerEl: ?HTMLElement = null;\n\t#selectedElementList: Object = {};\n\t#selectedHiddenElementList: Object = {};\n\t#selectedValueWrapperEl: ?HTMLElement = null;\n\t#valuesMenuPopup: ?Menu = null;\n\t#addButton: ?ItemSelectorButton = null;\n\t#addButtonCompact: ?HTMLElement = null;\n\n\tconstructor(params: ItemSelectorOptions)\n\t{\n\t\tthis.#assertValidParams(params);\n\n\t\tthis.#id = params.id || `item-selector-${Text.getRandom()}`;\n\t\tthis.#target = Type.isDomNode(params.target) ? params.target : null;\n\t\tthis.#valuesList = Type.isArrayFilled(params.valuesList) ? params.valuesList : [];\n\t\tthis.#selectedValues = Type.isArrayFilled(params.selectedValues) ? params.selectedValues : [];\n\t\tthis.#readonlyMode = params.readonlyMode === true;\n\t\tthis.#compactMode = params.compactMode === true;\n\n\t\tif (Type.isStringFilled(params.icon) && Object.values(CompactIcons).includes(params.icon))\n\t\t{\n\t\t\tthis.#icon = params.icon;\n\t\t}\n\n\t\tthis.#htmlItemCallback = Type.isFunction(params.htmlItemCallback) ? params.htmlItemCallback : null;\n\t\tthis.#multiple = Boolean(params.multiple ?? true);\n\n\t\tthis.#create();\n\t\tthis.#bindEvents();\n\t\tthis.#applyCurrentValue(100);\n\t}\n\n\t// region Data management\n\tgetValue(): Array\n\t{\n\t\treturn this.#selectedValues;\n\t}\n\n\tsetValue(values: Array, isEmitEvent: boolean = false): void\n\t{\n\t\tthis.clearAll();\n\n\t\tvalues.forEach((value: string) => {\n\t\t\tthis.addValue(value, isEmitEvent);\n\t\t});\n\t}\n\n\taddValue(value: mixed, isEmitEvent: boolean = false): void\n\t{\n\t\tconst rawValue = this.#valuesList.find((element: Item) => {\n\t\t\treturn element?.id?.toString() === value?.toString();\n\t\t});\n\n\t\tif (!rawValue)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.#compactMode)\n\t\t{\n\t\t\tconst itemEl: HTMLElement = Tag.render`\n\t\t\t<span class=\"crm-field-item-selector__value\">\n\t\t\t\t<span class=\"crm-field-item-selector__value-title\">\n\t\t\t\t\t${Text.encode(rawValue.title)}\n\t\t\t\t</span>\n\t\t\t</span>\n\t\t`;\n\n\t\t\tif (!this.#readonlyMode)\n\t\t\t{\n\t\t\t\tDom.append(\n\t\t\t\t\tTag.render`\n\t\t\t\t\t<span class=\"crm-field-item-selector__value-clear-icon\" data-item-selector-id=\"${rawValue.id}\"/>\n\t\t\t\t\t</span>\n\t\t\t\t`,\n\t\t\t\t\titemEl,\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tDom.append(itemEl, this.#selectedValueWrapperEl);\n\n\t\t\tconst itemElWidth = itemEl.offsetWidth;\n\n\t\t\tDom.addClass(itemEl, '--hidden');\n\n\t\t\tif (this.#isTargetOverflown(itemElWidth))\n\t\t\t{\n\t\t\t\tthis.#selectedHiddenElementList[rawValue.id] = itemEl;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.#animateAdd(itemEl); // add animation\n\t\t\t}\n\n\t\t\tthis.#selectedElementList[rawValue.id] = itemEl;\n\t\t\tthis.#applyAddButtonState(itemElWidth);\n\t\t}\n\n\t\tthis.#selectedValues.push(rawValue.id);\n\n\t\tthis.#adjustAddButtonCompact();\n\n\t\tif (isEmitEvent)\n\t\t{\n\t\t\tthis.#emitEvent();\n\t\t}\n\t}\n\n\tremoveValue(value: string | number, isEmitEvent: boolean = false): void\n\t{\n\t\tif (!this.#compactMode)\n\t\t{\n\t\t\tif (this.#selectedElementList[value] && Type.isDomNode(this.#selectedElementList[value]))\n\t\t\t{\n\t\t\t\tthis.#animateRemove(this.#selectedElementList[value]);\n\t\t\t\tDom.remove(this.#selectedElementList[value]);\n\n\t\t\t\tdelete this.#selectedElementList[value];\n\t\t\t}\n\n\t\t\tconst isHiddenElementNeedApply = this.#selectedHiddenElementList[value]\n\t\t\t\t&& Type.isDomNode(this.#selectedHiddenElementList[value])\n\t\t\t;\n\n\t\t\tif (isHiddenElementNeedApply)\n\t\t\t{\n\t\t\t\tdelete this.#selectedHiddenElementList[value];\n\t\t\t}\n\n\t\t\tif (!this.#isTargetOverflown() || isHiddenElementNeedApply)\n\t\t\t{\n\t\t\t\tconst itemEl = Object.values(this.#selectedHiddenElementList)[0];\n\t\t\t\tif (Type.isDomNode(itemEl) && !this.#isTargetOverflown(itemEl.offsetWidth))\n\t\t\t\t{\n\t\t\t\t\tthis.#animateAdd(itemEl);\n\t\t\t\t\tdelete this.#selectedHiddenElementList[Object.keys(this.#selectedHiddenElementList)[0]];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.#applyAddButtonState();\n\t\t}\n\n\t\tthis.#selectedValues = this.#selectedValues?.filter((item: string | number) => {\n\t\t\treturn item?.toString() !== value?.toString();\n\t\t});\n\n\t\tthis.#adjustAddButtonCompact();\n\n\t\tif (isEmitEvent)\n\t\t{\n\t\t\tthis.#emitEvent();\n\t\t}\n\t}\n\n\tclearAll(): void\n\t{\n\t\tif (!Type.isArrayFilled(this.#selectedValues))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#selectedValues.forEach((value) => this.removeValue(value));\n\n\t\tthis.#selectedValues = [];\n\t\tthis.#selectedElementList = {};\n\t\tthis.#selectedHiddenElementList = {};\n\n\t\tthis.#adjustAddButtonCompact();\n\t}\n\t// endregion\n\n\t// region DOM management\n\t#create(): void\n\t{\n\t\tif (!this.#target)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.#compactMode)\n\t\t{\n\t\t\tthis.#containerEl = Tag.render`<div class=\"crm-field-item-selector crm-field-item-selector__scope\"></div>`;\n\t\t\tthis.#selectedValueWrapperEl = Tag.render`<span class=\"crm-field-item-selector__values\"></span>`;\n\n\t\t\tDom.append(this.#selectedValueWrapperEl, this.#containerEl);\n\t\t}\n\n\t\tif (!this.#readonlyMode)\n\t\t{\n\t\t\tif (this.#compactMode)\n\t\t\t{\n\t\t\t\tthis.#addButtonCompact = Tag.render`\n\t\t\t\t\t<span \n\t\t\t\t\t\tclass=\"crm-field-item-selector-compact-icon ${Type.isStringFilled(this.#icon) ? `--${this.#icon}` : ''}\"\n\t\t\t\t\t></span>\n\t\t\t\t`;\n\n\t\t\t\tthis.#adjustAddButtonCompact();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.#addButton = new ItemSelectorButton();\n\n\t\t\t\tDom.append(this.#getAddButtonEl(), this.#containerEl);\n\t\t\t}\n\t\t}\n\n\t\tif (this.#compactMode)\n\t\t{\n\t\t\tDom.append(this.#getAddButtonEl(), this.#target);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.append(this.#containerEl, this.#target);\n\t\t}\n\t}\n\n\t#adjustAddButtonCompact(): void\n\t{\n\t\tif (!this.#compactMode)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (Type.isArrayFilled(this.#selectedValues))\n\t\t{\n\t\t\tDom.removeClass(this.#addButtonCompact, '--empty');\n\t\t}\n\t\telse\n\t\t{\n\t\t\tDom.addClass(this.#addButtonCompact, '--empty');\n\t\t}\n\t}\n\n\t#getAddButtonEl(): ?HTMLElement\n\t{\n\t\treturn (\n\t\t\tthis.#compactMode\n\t\t\t\t? this.#addButtonCompact\n\t\t\t\t: this.#addButton?.getContainer()\n\t\t);\n\t}\n\n\t#animateAdd(element: HTMLElement): void\n\t{\n\t\tDom.removeClass(element, ['--hidden', '--removing']);\n\t\tDom.addClass(element, '--adding');\n\t}\n\n\t#animateRemove(element: HTMLElement): void\n\t{\n\t\tDom.removeClass(element, '--adding');\n\t\tDom.addClass(element, '--removing');\n\t}\n\n\t#applyAddButtonState(portion: number = 0): void\n\t{\n\t\tif (!Type.isDomNode(this.#getAddButtonEl()))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst hiddenElementsCnt = Object.keys(this.#selectedHiddenElementList).length;\n\n\t\tif (this.#selectedValues.length === 0)\n\t\t{\n\t\t\tthis.#addButton.applyState(ItemSelectorButtonState.ADD);\n\t\t}\n\t\telse if (this.#isTargetOverflown(portion) && hiddenElementsCnt > 0)\n\t\t{\n\t\t\tthis.#addButton.applyState(ItemSelectorButtonState.COUNTER_ADD, hiddenElementsCnt);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#addButton.applyState(ItemSelectorButtonState.MORE_ADD);\n\t\t}\n\t}\n\t// endregion\n\n\t// region Event handlers\n\t#bindEvents(): void\n\t{\n\t\tif (Type.isDomNode(this.#addButtonCompact))\n\t\t{\n\t\t\tEvent.bind(this.#addButtonCompact, 'click', this.#onShowPopup.bind(this));\n\t\t}\n\t\telse if (Type.isDomNode(this.#getAddButtonEl()))\n\t\t{\n\t\t\tEvent.bind(this.#getAddButtonEl(), 'click', this.#onShowPopup.bind(this));\n\t\t}\n\n\t\tif (Type.isDomNode(this.#selectedValueWrapperEl))\n\t\t{\n\t\t\tEvent.bind(this.#selectedValueWrapperEl, 'click', this.#onRemoveValue.bind(this));\n\t\t}\n\n\t\tEvent.unbind(window, 'resize', this.#onWindowResize);\n\t\tEvent.bind(window, 'resize', this.#onWindowResize.bind(this));\n\t}\n\n\t#onShowPopup(event: Event): void\n\t{\n\t\tconst menuItems = this.#getPreparedMenuItems();\n\n\t\t// @todo temporary, need other fix\n\t\tconst angle = this.#compactMode ? { offset: 29, position: 'top' } : true;\n\n\t\tconst menuParams = {\n\t\t\tcloseByEsc: true,\n\t\t\tautoHide: true,\n\t\t\toffsetLeft: this.#getAddButtonEl().offsetWidth - 16,\n\t\t\tangle,\n\t\t\tcacheable: false,\n\t\t};\n\n\t\tthis.#valuesMenuPopup = MenuManager.create(this.#id, this.#getAddButtonEl(), menuItems, menuParams);\n\t\tthis.#valuesMenuPopup.show();\n\n\t\tEventEmitter.emit(this, Events.EVENT_ITEMSELECTOR_OPEN);\n\t}\n\n\t#getPreparedMenuItems(): []\n\t{\n\t\treturn this.#valuesList.map((item: Item) => this.#getPreparedMenuItem(item));\n\t}\n\n\t#getPreparedMenuItem(item: Item): Object\n\t{\n\t\tconst menuItem = {\n\t\t\tid: `item-selector-menu-id-${item.id}`,\n\t\t\tclassName: this.#isValueSelected(item.id) ? MENU_ITEM_CLASS_ACTIVE : MENU_ITEM_CLASS_INACTIVE,\n\t\t\tonclick: this.#onMenuItemClick.bind(this, item.id),\n\t\t};\n\n\t\tif (this.#htmlItemCallback)\n\t\t{\n\t\t\tmenuItem.html = this.#htmlItemCallback(item);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tmenuItem.html = Text.encode(item.title);\n\t\t}\n\n\t\treturn menuItem;\n\t}\n\n\t#onRemoveValue(event: Event): void\n\t{\n\t\tconst target = event.target || event.srcElement;\n\t\tconst itemIdToRemove = target.getAttribute('data-item-selector-id');\n\t\tif (Type.isNull(itemIdToRemove))\n\t\t{\n\t\t\treturn; // nothing to do\n\t\t}\n\n\t\tif (this.#isValueSelected(itemIdToRemove))\n\t\t{\n\t\t\tthis.removeValue(itemIdToRemove, true);\n\t\t}\n\t}\n\n\t#onMenuItemClick(value: mixed, event: PointerEvent, item: MenuItem): void\n\t{\n\t\tif (!this.#multiple)\n\t\t{\n\t\t\tthis.clearAll();\n\n\t\t\tthis.#valuesMenuPopup.menuItems.forEach((menuItem: MenuItem) => {\n\t\t\t\tDom.removeClass(menuItem.getContainer(), MENU_ITEM_CLASS_ACTIVE);\n\t\t\t});\n\n\t\t\tthis.#valuesMenuPopup.close();\n\t\t}\n\n\t\tif (this.#isValueSelected(value))\n\t\t{\n\t\t\tthis.removeValue(value, true);\n\n\t\t\tDom.removeClass(item.getContainer(), MENU_ITEM_CLASS_ACTIVE);\n\t\t\tDom.addClass(item.getContainer(), MENU_ITEM_CLASS_INACTIVE);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.addValue(value, true);\n\n\t\t\tDom.removeClass(item.getContainer(), MENU_ITEM_CLASS_INACTIVE);\n\t\t\tDom.addClass(item.getContainer(), MENU_ITEM_CLASS_ACTIVE);\n\t\t}\n\t}\n\n\t#onWindowResize(): void\n\t{\n\t\tthis.#applyCurrentValue(750);\n\t}\n\n\t#emitEvent(): void\n\t{\n\t\tEventEmitter.emit(this, Events.EVENT_ITEMSELECTOR_VALUE_CHANGE, {\n\t\t\tvalue: this.getValue(),\n\t\t});\n\t}\n\t// endregion\n\n\t// region Utils\n\t#assertValidParams(params: ItemSelectorOptions): void\n\t{\n\t\tif (!Type.isPlainObject(params))\n\t\t{\n\t\t\tthrow new TypeError('BX.Crm.Field.ItemSelector: The \"params\" argument must be object');\n\t\t}\n\n\t\tif (!Type.isDomNode(params.target))\n\t\t{\n\t\t\tthrow new Error('BX.Crm.Field.ItemSelector: The \"target\" argument must be DOM node');\n\t\t}\n\n\t\tif (!Type.isArrayFilled(params.valuesList))\n\t\t{\n\t\t\tthrow new Error('BX.Crm.Field.ItemSelector: The \"valuesList\" argument must be filled');\n\t\t}\n\t}\n\n\t#applyCurrentValue(delay: number): void\n\t{\n\t\tRuntime.debounce(\n\t\t\t() => {\n\t\t\t\tthis.setValue(this.#selectedValues || []);\n\t\t\t},\n\t\t\tdelay,\n\t\t\tthis,\n\t\t)();\n\t}\n\n\t#isValueSelected(value: string | number): boolean\n\t{\n\t\treturn !Type.isUndefined(\n\t\t\tthis.#selectedValues.find((item: string | number) => item.toString() === value.toString()),\n\t\t);\n\t}\n\n\t#isTargetOverflown(portion: number = 0): boolean\n\t{\n\t\tif (this.#readonlyMode || this.#compactMode)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst targetWidth = this.#target.offsetWidth;\n\t\tconst selectedValuesWidth = this.#selectedValueWrapperEl.offsetWidth;\n\t\tconst addBtnWidth = this.#getAddButtonEl().offsetWidth;\n\t\tconst result = targetWidth - (selectedValuesWidth + addBtnWidth + portion);\n\n\t\treturn result <= 20;\n\t}\n\t// endregion\n}\n"],"names":["DEFAULT_CLASS","ItemSelectorButtonState","Object","freeze","ADD","MORE_ADD","COUNTER_ADD","ItemSelectorButton","options","Dom","addClass","getContainer","id","Text","getRandom","text","Loc","getMessage","tag","Button","Tag","SPAN","size","Size","EXTRA_SMALL","color","Color","LIGHT","round","dropdown","state","counter","setText","replace","MENU_ITEM_CLASS_ACTIVE","MENU_ITEM_CLASS_INACTIVE","CompactIcons","NONE","BELL","Events","EVENT_ITEMSELECTOR_OPEN","EVENT_ITEMSELECTOR_VALUE_CHANGE","ItemSelector","params","Type","isDomNode","target","isArrayFilled","valuesList","selectedValues","readonlyMode","compactMode","isStringFilled","icon","values","includes","isFunction","htmlItemCallback","Boolean","multiple","isEmitEvent","clearAll","forEach","value","addValue","rawValue","find","element","toString","itemEl","render","encode","title","append","itemElWidth","offsetWidth","push","remove","isHiddenElementNeedApply","keys","filter","item","removeValue","removeClass","portion","hiddenElementsCnt","length","applyState","Event","bind","unbind","window","event","menuItems","angle","offset","position","menuParams","closeByEsc","autoHide","offsetLeft","cacheable","MenuManager","create","show","EventEmitter","emit","map","menuItem","className","onclick","html","srcElement","itemIdToRemove","getAttribute","isNull","close","getValue","isPlainObject","TypeError","Error","delay","Runtime","debounce","setValue","isUndefined","targetWidth","selectedValuesWidth","addBtnWidth","result"],"mappings":"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"}