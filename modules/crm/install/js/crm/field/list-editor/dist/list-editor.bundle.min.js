this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,t,i,s,a,l,o,n,r,d){"use strict";let c=e=>e,h,u,m,b;const{MemoryCache:p}=d.Cache;var g=babelHelpers.classPrivateFieldLooseKey("cache");class v extends o.EventEmitter{constructor(e){super();Object.defineProperty(this,g,{writable:true,value:new p});this.setEventNamespace("BX.Crm.Field.ListEditor.Item");this.subscribeFromOptions(e.events);this.setOptions(e);this.onFormChange=this.onFormChange.bind(this)}setOptions(e){babelHelpers.classPrivateFieldLooseBase(this,g)[g].set("options",{...e})}getOptions(){return babelHelpers.classPrivateFieldLooseBase(this,g)[g].get("options",{})}getCustomTitleLayout(){return babelHelpers.classPrivateFieldLooseBase(this,g)[g].remember("customTitleLayout",(()=>this.getLayout().querySelector(".crm-field-list-editor-item-text-custom-title")))}getLayout(){return babelHelpers.classPrivateFieldLooseBase(this,g)[g].remember("layout",(()=>{const{data:e,categoryCaption:t}=this.getOptions();const{sourceData:i}=this.getOptions();const s=e.label||i.caption;const a=(()=>{if(d.Type.isStringFilled(t)){return`&middot; ${d.Text.encode(t)}`}return""})();return d.Tag.render(h||(h=c`
				<div class="crm-field-list-editor-item" data-name="${0}">
					<div class="crm-field-list-editor-item-header">
						<div class="crm-field-list-editor-item-drag-button"></div>
						<div class="crm-field-list-editor-item-text">
							<div class="crm-field-list-editor-item-text-source-title">
								<span class="crm-field-list-editor-item-text-source-title-inner">${0}</span>
								<span class="crm-field-list-editor-item-text-source-title-inner">${0}</span>
							</div>
							<div class="crm-field-list-editor-item-text-custom-title">
								<div class="crm-field-list-editor-item-text-custom-title-inner">${0}</div>
							</div>
						</div>
						<div class="crm-field-list-editor-item-actions">
							<div 
								class="crm-field-list-editor-item-button-edit"
								onclick="${0}"
							></div>
							<div 
								class="crm-field-list-editor-item-button-remove"
								onclick="${0}"
							></div>
						</div>
					</div>
					<div class="crm-field-list-editor-item-body">
						${0}
					</div>
				</div>
			`),d.Text.encode(i.name),d.Text.encode(i.caption),a,d.Text.encode(s),this.onEditClick.bind(this),this.onRemoveClick.bind(this),this.getFormLayout())}))}onEditClick(e){e.preventDefault();if(!this.isOpened()){this.open()}else{this.close()}}onRemoveClick(e){e.preventDefault();this.emit("onRemove")}open(){d.Dom.addClass(this.getLayout(),"crm-field-list-editor-item-opened")}isOpened(){return d.Dom.hasClass(this.getLayout(),"crm-field-list-editor-item-opened")}close(){d.Dom.removeClass(this.getLayout(),"crm-field-list-editor-item-opened")}createTextInput(e){return d.Tag.render(u||(u=c`
			<div class="ui-form-row crm-field-list-editor-item-form-text-row">
				<div class="ui-form-label">
					<div class="ui-ctl-label-text">${0}</div>
				</div>
				<div class="ui-form-content">
					<div class="ui-ctl ui-ctl-textbox ui-ctl-w100">
						<input
							type="text"
							name="${0}"
							value="${0}"
							oninput="${0}"
							class="ui-ctl-element">	
					</div>	
				</div>
			</div>
		`),e.label,e.name,e.value,this.onFormChange)}createCheckbox(e){return d.Tag.render(m||(m=c`
			<div class="ui-form-row crm-field-list-editor-item-form-checkbox-row">
				<div class="ui-form-content">
					<label class="ui-ctl ui-ctl-checkbox">
						<input 
							type="checkbox" 
							name="${0}"
							class="ui-ctl-element"
							onchange="${0}"
							${0}
						>
						<div class="ui-ctl-label-text">${0}</div>
					</label>	
				</div>
			</div>
		`),e.name,this.onFormChange,e.checked?"checked":"",e.label)}getAllInputs(){return[...this.getLayout().querySelectorAll(".ui-ctl-element")]}getValue(){return this.getAllInputs().reduce(((e,t)=>{e[t.name]=t.type==="checkbox"?t.checked:t.value;return e}),{...this.getOptions().data})}onFormChange(){const e=this.getValue();this.getCustomTitleLayout().textContent=e.caption||e.label;this.emit("onChange")}getFormControls(){return babelHelpers.classPrivateFieldLooseBase(this,g)[g].remember("formControls",(()=>{const e=Object.entries(this.getOptions().editable);const{data:t}=this.getOptions();return e.map((([e,i])=>{if(i.type==="string"){return this.createTextInput({name:e,label:i.label,value:t[e]})}return this.createCheckbox({name:e,label:i.label,checked:t[e]})}))}))}getFormLayout(){return babelHelpers.classPrivateFieldLooseBase(this,g)[g].remember("formLayout",(()=>d.Tag.render(b||(b=c`
				<div class="crm-field-list-editor-item-form">
					<div class="ui-form">
						${0}
					</div>
				</div>
			`),this.getFormControls())))}}const{MemoryCache:y}=d.Cache;var f=babelHelpers.classPrivateFieldLooseKey("instance");var L=babelHelpers.classPrivateFieldLooseKey("cache");class F{constructor(){Object.defineProperty(this,L,{writable:true,value:new y})}static getInstance(){if(!babelHelpers.classPrivateFieldLooseBase(F,f)[f]){babelHelpers.classPrivateFieldLooseBase(F,f)[f]=new F}return babelHelpers.classPrivateFieldLooseBase(F,f)[f]}getFieldsList(){return babelHelpers.classPrivateFieldLooseBase(this,L)[L].remember("fieldsList",(()=>new Promise(((e,t)=>{d.ajax.runAction("crm.api.form.field.list",{json:{}}).then((i=>{var s;if(d.Type.isPlainObject(i==null?void 0:(s=i.data)==null?void 0:s.tree)){e(i.data.tree)}else{t(i)}})).catch((e=>{t(e)}))}))))}getFieldsSet(e){return new Promise(((t,i)=>{d.ajax.runAction("crm.api.fieldset.get",{json:{id:e}}).then((e=>{if(d.Type.isPlainObject(e==null?void 0:e.data)){t(e.data)}else{i(e)}})).catch((e=>{i(e)}))}))}saveFieldsSet(e){return new Promise(((t,i)=>{d.ajax.runAction("crm.api.fieldset.set",{json:{options:e}}).then((e=>{if(d.Type.isPlainObject(e==null?void 0:e.data)){t(e)}else{i(e)}})).catch((e=>{i(e)}))}))}}Object.defineProperty(F,f,{writable:true,value:null});let C=e=>e,P,T,B;const{MemoryCache:I}=d.Cache;var D=babelHelpers.classPrivateFieldLooseKey("cache");var O=babelHelpers.classPrivateFieldLooseKey("loadPromise");var w=babelHelpers.classPrivateFieldLooseKey("defaultOptions");var E=babelHelpers.classPrivateFieldLooseKey("adjustSliderDragAndDropOffsets");class x extends o.EventEmitter{constructor(e={}){super();Object.defineProperty(this,E,{value:H});Object.defineProperty(this,D,{writable:true,value:new I});Object.defineProperty(this,O,{writable:true,value:void 0});this.setEventNamespace("BX.Crm.Field.ListEditor");this.subscribeFromOptions(e.events);this.setTitle(e.title||"");this.onWindowResize=this.onWindowResize.bind(this);this.setOptions({...babelHelpers.classPrivateFieldLooseBase(x,w)[w],...e});this.onDebounceChange=d.Runtime.debounce(this.onDebounceChange,this.getOptions().debouncingDelay,this);this.draggable=new i.Draggable({container:this.getListContainer(),draggable:".crm-field-list-editor-item",dragElement:".crm-field-list-editor-item-drag-button",offset:{x:-800},context:window.top});this.draggable.subscribe("end",this.onSortEnd.bind(this));this.showLoader();babelHelpers.classPrivateFieldLooseBase(this,O)[O]=Promise.all([this.loadFieldsDictionary(),this.loadValue()]).then((([e,t])=>{if(d.Type.isPlainObject(e)){this.setFieldsDictionary(e)}else{console.error("BX.Crm.Field.ListEditor: Invalid fields dictionary")}if(d.Type.isPlainObject(t)){this.setClientEntityTypeId(t.clientEntityTypeId);this.setEntityTypeId(t.entityTypeId);if(d.Type.isStringFilled(t.title)&&!d.Type.isStringFilled(this.getTitle())){this.setTitle(t.title)}if(d.Type.isArrayFilled(t.fields)){t.fields.forEach((e=>{this.addItem({sourceData:this.getFieldByName(e.name),data:e})}))}}else{console.error("BX.Crm.Field.ListEditor: Invalid value")}this.hideLoader()}))}setData(e){babelHelpers.classPrivateFieldLooseBase(this,D)[D].set("data",{...e})}getData(){return babelHelpers.classPrivateFieldLooseBase(this,D)[D].get("data",{})}setTitle(e){babelHelpers.classPrivateFieldLooseBase(this,D)[D].set("title",e)}getTitle(){return babelHelpers.classPrivateFieldLooseBase(this,D)[D].get("title","")}setClientEntityTypeId(e){babelHelpers.classPrivateFieldLooseBase(this,D)[D].set("clientEntityTypeId",e)}getClientEntityTypeId(){return babelHelpers.classPrivateFieldLooseBase(this,D)[D].get("clientEntityTypeId")}setEntityTypeId(e){babelHelpers.classPrivateFieldLooseBase(this,D)[D].set("entityTypeId",e)}getEntityTypeId(){return babelHelpers.classPrivateFieldLooseBase(this,D)[D].get("entityTypeId")}getLoader(){return babelHelpers.classPrivateFieldLooseBase(this,D)[D].remember("loader",(()=>new l.Loader({target:this.getLayout()})))}showLoader(){d.Dom.addClass(this.getLayout(),"crm-field-list-editor-state-load");void this.getLoader().show()}hideLoader(){d.Dom.removeClass(this.getLayout(),"crm-field-list-editor-state-load");void this.getLoader().hide()}setOptions(e){babelHelpers.classPrivateFieldLooseBase(this,D)[D].set("options",{...e})}getOptions(){return babelHelpers.classPrivateFieldLooseBase(this,D)[D].get("options",{})}setFieldsDictionary(e){babelHelpers.classPrivateFieldLooseBase(this,D)[D].set("fieldsDictionary",e)}getFieldsDictionary(){return babelHelpers.classPrivateFieldLooseBase(this,D)[D].get("fieldsDictionary",[])}getListContainer(){return babelHelpers.classPrivateFieldLooseBase(this,D)[D].remember("listContainer",(()=>d.Tag.render(P||(P=C`
				<div class="crm-field-list-editor-list"></div>
			`))))}getLayout(){return babelHelpers.classPrivateFieldLooseBase(this,D)[D].remember("layout",(()=>d.Tag.render(T||(T=C`
				<div class="crm-field-list-editor">
					${0}
					<div class="crm-field-list-editor-footer">
						<span 
							class="ui-link ui-link-dashed"
							onclick="${0}"
						>
							${0}
						</span>
					</div>
				</div>
			`),this.getListContainer(),this.onAddFieldClick.bind(this),d.Loc.getMessage("CRM_FIELD_LIST_EDITOR_ADD_FIELD_BUTTON_LABEL"))))}renderTo(e){if(!d.Type.isDomNode(e)){console.error("target is not a DOM element")}d.Dom.append(this.getLayout(),e)}loadFieldsDictionary(){return F.getInstance().getFieldsList()}loadValue(){return F.getInstance().getFieldsSet(this.getOptions().setId).then((e=>e.options))}getItems(){return babelHelpers.classPrivateFieldLooseBase(this,D)[D].remember("items",[])}setItems(e){babelHelpers.classPrivateFieldLooseBase(this,D)[D].set("items",e)}addItem(e){const t=this.getItems();const i=t.some((t=>t.getOptions().data.name===e.data.name));if(!i){const i=new v({...e,categoryCaption:this.getCategoryCaption(e.data.name),editable:this.getOptions().editable,events:{onChange:()=>{this.onChange()},onRemove:this.onRemoveItemClick.bind(this)}});t.push(i);d.Dom.append(i.getLayout(),this.getListContainer())}}onRemoveItemClick(e){const t=e.getTarget();d.Dom.remove(t.getLayout());this.setItems(this.getItems().filter((e=>e!==t)));this.onChange()}getFieldByName(e){const t=this.getFieldsDictionary();return Object.values(t).reduce(((t,i)=>{if(!t){return i.FIELDS.find((t=>t.name===e))}return t}),null)}getCategoryCaption(e){const t=this.getFieldsDictionary();return Object.values(t).reduce(((t,i)=>{if(!t){const t=i.FIELDS.some((t=>t.name===e));if(t){return i.CAPTION}}return t}),"")}showFieldsPanel(e){const i=t.FieldsPanel.getInstance();d.Dom.append(i.layout,window.top.document.body);return i.show(e)}onAddFieldClick(e){e.preventDefault();const i={...this.getOptions().fieldsPanelOptions,disabledFields:this.getValue().map((e=>e.name))};this.showFieldsPanel(i).then((e=>{this.setFieldsDictionary(t.FieldsPanel.getInstance().getCrmFields());return e})).then((e=>{e.forEach((e=>{const t=this.getFieldByName(e);if(!d.Type.isString(t.label)&&d.Type.isString(t.caption)){t.label=t.caption}this.addItem({sourceData:t,data:t});this.onChange()}))}))}onChange(){this.emit("onChange");this.onDebounceChange()}onDebounceChange(){if(this.getOptions().autoSave){void this.save()}this.emit("onDebounceChange")}save(){return F.getInstance().saveFieldsSet({id:this.getOptions().setId,entityTypeId:this.getEntityTypeId(),clientEntityTypeId:this.getClientEntityTypeId(),...this.getData(),fields:this.getValue()}).then((()=>{this.emit("onSave")}))}getValue(){return this.getItems().map((e=>e.getValue()))}onWindowResize(){babelHelpers.classPrivateFieldLooseBase(this,E)[E]()}showSlider(){const e=[];if(!this.getOptions().autoSave){e.push(new a.SaveButton({onclick:e=>{e.setWaiting(true);this.save().then((()=>{e.setWaiting(false);BX.SidePanel.Instance.close()}))}}))}BX.SidePanel.Instance.open("crm:field-list-editor",{width:600,contentCallback:()=>babelHelpers.classPrivateFieldLooseBase(this,O)[O].then((()=>s.Layout.createContent({extensions:["crm.field.list-editor"],title:this.getTitle(),content:()=>this.getLayout(),buttons:({cancelButton:t})=>[...e,t]}))).catch((({errors:e})=>s.Layout.createContent({extensions:["ui.sidepanel-content"],design:{section:false},content:()=>{const t=d.Loc.getMessage("CRM_FIELD_LIST_EDITOR_ERROR_LOAD");const i=((e||[])[0]||{}).message||"Unknown error";return d.Tag.render(B||(B=C`
								<div class="ui-slider-no-access">
									<div class="ui-slider-no-access-inner">
										<div class="ui-slider-no-access-title">${0}</div>
										<div class="ui-slider-no-access-subtitle">${0}</div>
										<div class="ui-slider-no-access-img">
											<div class="ui-slider-no-access-img-inner"></div>
										</div>
									</div>
								</div>
							`),d.Text.encode(t),d.Text.encode(i))},buttons:({closeButton:e})=>[e]}))),events:{onOpenComplete:()=>{const e=setTimeout((()=>{clearTimeout(e);babelHelpers.classPrivateFieldLooseBase(this,E)[E]()}),500);d.Event.bind(window,"resize",this.onWindowResize)},onClose:()=>{d.Event.unbind(window,"resize",this.onWindowResize)}}})}onSortEnd(){const e=[...this.getListContainer().children];this.getItems().sort(((t,i)=>{const s=e.findIndex((e=>t.getLayout()===e));const a=e.findIndex((e=>i.getLayout()===e));return s-a}));this.onChange()}}function H(){const e=this.getLayout().closest(".ui-sidepanel-layout");if(d.Type.isDomNode(e)){const t=-e.getBoundingClientRect().left;this.draggable.setOptions({...this.draggable.getOptions(),offset:{x:t}})}}Object.defineProperty(x,w,{writable:true,value:{setId:0,autoSave:true,fieldsPanelOptions:{},debouncingDelay:500}});e.Backend=F;e.ListEditor=x})(this.BX.Crm.Field=this.BX.Crm.Field||{},BX.Landing.UI.Panel,BX.UI.DragAndDrop,BX.UI.SidePanel,BX.UI,BX,BX.Event,BX,BX,BX);
//# sourceMappingURL=list-editor.bundle.map.js