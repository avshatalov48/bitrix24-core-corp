BX.namespace("BX.Crm");BX.Crm.RequisitePresetSelectorClass=function(){var t=function(t){this.id=BX.type.isNotEmptyString(t["id"])?t["id"]:"";if(this.id===""){this.id=BX.type.isNotEmptyString(t["containerId"])?t["containerId"]:"crm_requisite_preset_sel"}this.editor=t.editor;this.container=t.container;this.nextNode=BX.type.isElementNode(t.nextNode)?t.nextNode:null;this.position=BX.type.isNotEmptyString(t.position)?t.position:"";this.content=null;this.requisiteEntityTypeId=t.requisiteEntityTypeId;this.requisiteEntityId=t.requisiteEntityId;this.presetList=t.presetList;this.presetLastSelectedId=parseInt(t.presetLastSelectedId);this.ajaxUrl="/bitrix/components/bitrix/crm.requisite.edit/settings.php";this.requisiteEditHandler=t.requisiteEditHandler;this.curPreset={id:0,title:""};this.curPresetName="";this.labelElement=null;this.buttonElement=null;this._menuId="ps_menu_"+this.id;this._isMenuShown=false;this._buttonClickHandler=BX.delegate(this.onButtonClick,this);this._menuIiemClickHandler=BX.delegate(this.onMenuItemClick,this);this._menuCloseHandler=BX.delegate(this.onMenuClose,this);if(this.presetList.length>0){if(this.presetLastSelectedId<=0)this.curPreset=this.presetList[0];else{for(var e=0;e<this.presetList.length;e++){if(this.presetList[e]["id"]&&this.presetList[e]["id"]==this.presetLastSelectedId){this.curPreset=this.presetList[e];break}}if(this.curPreset["id"]===0){this.curPreset=this.presetList[0];setTimeout(BX.delegate(this.saveLastSelectedPresetId,this),100)}}}this.buildContent()};t.prototype={buildContent:function(){if(this.container){this.labelElement=BX.create("SPAN",{text:this.curPreset["title"]});this.buttonElement=BX.create("SPAN",{attrs:{className:"crm-offer-requisite-option-arrow"}});this.content=BX.create("SPAN",{attrs:{className:"crm-offer-requisite-option"},children:[BX.create("SPAN",{attrs:{className:"crm-offer-requisite-option-caption"},text:this.getMessage("presetSelectorText")+":"}),BX.create("SPAN",{attrs:{className:"crm-offer-requisite-option-text",title:this.getMessage("presetSelectorTitle")},events:{click:BX.delegate(this.onSelectorClick,this)},children:[BX.create("SPAN",{children:[this.labelElement]})]}),this.buttonElement]});this.ajust();if(this.buttonElement){if(this.presetList.length>1){BX.bind(this.buttonElement,"click",this._buttonClickHandler)}else{this.buttonElement.style.display="none"}}}},selectPreset:function(t){if(this.labelElement){if(this.curPreset["id"]!=t["id"]){this.curPreset=t;this.presetLastSelectedId=t["id"];BX.setTextContent(this.labelElement,t["title"]);setTimeout(BX.delegate(this.saveLastSelectedPresetId,this),100)}}},getMessage:function(t){return this.editor?this.editor.getMessage(t):t},getNextNode:function(){return this.nextNode},setNextNode:function(t){t=BX.type.isElementNode(t)?t:null;if(this.nextNode!==t){this.nextNode=t;this.ajust()}},ajust:function(){if(!this.container){return}if(this.container===this.content.parentNode){this.container.removeChild(this.content)}if(this.position==="top"){if(this.container.firstChild){this.container.insertBefore(this.content,this.container.firstChild)}else{this.container.appendChild(this.content)}}else{if(this.container&&this.nextNode){this.container.insertBefore(this.content,this.nextNode)}else{this.container.appendChild(this.content)}}},showError:function(t){alert(t)},onButtonClick:function(t){this.showMenu()},showMenu:function(){if(this._isMenuShown){return}var t=[];for(var e=0;e<this.presetList.length;e++){var i=this.presetList[e];t.push({text:BX.util.htmlspecialchars(i["title"]),value:i["id"],href:"#",className:"crm-convert-item",onclick:this._menuIiemClickHandler})}if(typeof BX.PopupMenu.Data[this._menuId]!=="undefined"){BX.PopupMenu.Data[this._menuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._menuId]}var s=this.buttonElement;var n=BX.pos(s);BX.PopupMenu.show(this._menuId,s,t,{autoHide:true,offsetLeft:n["width"]/2,angle:{position:"top",offset:0},events:{onPopupClose:this._menuCloseHandler}});this._isMenuShown=true},closeMenu:function(){if(!this._isMenuShown){return}BX.PopupMenu.destroy(this._menuId);this._isMenuShown=false},onMenuClose:function(){this._isMenuShown=false},onMenuItemClick:function(t,e){var i={id:0,title:""};for(var s=0;s<this.presetList.length;s++){if(this.presetList[s]["id"]&&this.presetList[s]["id"]==e["value"]){i=this.presetList[s];break}}this.selectPreset(i);this.closeMenu();return BX.PreventDefault(t)},onSelectorClick:function(t){this.closeMenu();if(this.requisiteEditHandler){if(parseInt(this.curPreset["id"])<=0){this.showError(this.getMessage("errPresetNotSelected"))}else{this.requisiteEditHandler(this.requisiteEntityTypeId,this.requisiteEntityId,this.curPreset["id"],0)}}return BX.PreventDefault(t)},saveLastSelectedPresetId:function(){var t=BX.util.add_url_param(this.ajaxUrl,{sessid:BX.bitrix_sessid()});var e={action:"savelastselectedpreset",requisiteEntityTypeId:this.requisiteEntityTypeId,presetId:this.presetLastSelectedId};BX.ajax.post(t,e)}};return t}();BX.Crm.RequisitePopupFormManagerClass=function(){var t=function(t){this._random=Math.random().toString().substring(2);this._index="RequisitePopupFormManager_"+this._random;this.editor=t.editor;this.blockArea=t.blockArea;this.requisiteEntityTypeId=t.requisiteEntityTypeId;this.requisiteEntityId=t.requisiteEntityId;this.requisiteId=t.requisiteId;this.requisiteData=t.requisiteData;this.requisiteDataSign=t.requisiteDataSign;this.presetId=t.presetId;this.multiAddressEditor=null;this.requisiteAjaxUrl=BX.type.isNotEmptyString(t.requisiteAjaxUrl)?t.requisiteAjaxUrl:"";this.requisitePopupAjaxUrl=t.requisitePopupAjaxUrl;this.isRequestRunning=false;this.wrapper=null;this.popup=null;this.saveButton=null;this.cancelButton=null;this.formId="";this.formSettingManager=null;this.formCreateHandler=BX.delegate(this.onFormCreate,this);this.editorPopupDestroyCallback=t.popupDestroyCallback;this.blockIndex=BX.type.isNumber(t.blockIndex)&&t.blockIndex>=0||BX.type.isNotEmptyString(t.blockIndex)?parseInt(t.blockIndex):-1;this.afterRequisiteEditCallback=t.afterRequisiteEditCallback;this.copyMode=!!t.copyMode;this.readOnlyMode=!!t.readOnlyMode;this.saveBtnClickLockObject=null;this.doSaveHandler=BX.delegate(this.onDoSave,this);this.register()};t.prototype={getWrapperNode:function(){return this.wrapper},getMessage:function(t){return this.editor?this.editor.getMessage(t):t},getFieldControl:function(t){var e=document.getElementsByName(t);return e.length>0?e[0]:null},setFormId:function(t){this.formId=BX.type.isNotEmptyString(t)?t:""},getFormId:function(){return this.formId},setFieldValue:function(t,e){var i=this.getFieldControl(t);if(i!==null){i.value=e}},setupFields:function(t){var e=document.querySelectorAll('input[type="text"][data-requisite="field"],textarea[data-requisite="field"]');for(var i=0;i<e.length;i++){e[i].value=""}for(var s in t){if(!t.hasOwnProperty(s)){continue}if(s!=="RQ_ADDR"){this.setFieldValue(s,t[s])}else if(this.multiAddressEditor){var n=t[s];for(var r in n){if(!n.hasOwnProperty(r)){continue}var o=n[r];var a=parseInt(r);var u=this.multiAddressEditor.getItemByTypeId(a);if(u===null){u=this.multiAddressEditor.createItem(a,this.formId)}u.setup(o)}}}},openPopup:function(){if(!this.popup){this.startLoadRequest()}},closePopup:function(){if(this.popup){this.popup.close()}},reloadPopup:function(){if(this.popup){this.startReloadRequest()}},startLoadRequest:function(){if(this.isRequestRunning){return}this.isRequestRunning=true;var t="";if(this.requisiteId>0){t+="&etype="+BX.util.urlencode(this.requisiteEntityTypeId>0?this.requisiteEntityTypeId:0)+"&eid="+BX.util.urlencode(this.requisiteEntityId>0?this.requisiteEntityId:0)+"&requisite_id="+BX.util.urlencode(this.requisiteId);if(this.copyMode)t+="&copy=1"}else{t+="&etype="+BX.util.urlencode(this.requisiteEntityTypeId>0?this.requisiteEntityTypeId:0)+"&eid="+BX.util.urlencode(this.requisiteEntityId>0?this.requisiteEntityId:0)+"&pid="+BX.util.urlencode(this.presetId>0?this.presetId:0)+"&requisite_data="+BX.util.urlencode(BX.type.isNotEmptyString(this.requisiteData)?this.requisiteData:"")+"&requisite_data_sign="+BX.util.urlencode(BX.type.isNotEmptyString(this.requisiteDataSign)?this.requisiteDataSign:"")}if(BX.type.isNotEmptyString(this._index))t+="&popup_manager_id="+this._index;BX.ajax({url:this.requisitePopupAjaxUrl+t,method:"POST",dataType:"html",data:{},prepareData:true,onsuccess:BX.delegate(this.onLoadRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})},startReloadRequest:function(){if(this.isRequestRunning){return}this.isRequestRunning=true;var t=this.formSettingManager.getForm();t.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"reload",value:"Y"}}));var e="";if(this.requisiteId>0){e+="&requisite_id="+BX.util.urlencode(this.requisiteId);if(this.copyMode)e+="&copy=1"}else{e+="&etype="+BX.util.urlencode(this.requisiteEntityTypeId>0?this.requisiteEntityTypeId:0)+"&eid="+BX.util.urlencode(this.requisiteEntityId>0?this.requisiteEntityId:0)+"&pid="+BX.util.urlencode(this.presetId>0?this.presetId:0)}if(BX.type.isNotEmptyString(this._index))e+="&popup_manager_id="+this._index;BX.ajax.submitAjax(t,{url:this.requisitePopupAjaxUrl+e,method:"POST",data:{},onsuccess:BX.delegate(this.onReloadRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})},startFormSubmitRequest:function(t){if(this.isRequestRunning){return}this.isRequestRunning=true;var e=this.formSettingManager.getForm();e["save"]=e.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"save",value:"Y"}}));var i="";if(this.requisiteId>0){i+="&requisite_id="+BX.util.urlencode(this.requisiteId);if(this.copyMode)i+="&copy=1"}else{i+="&etype="+BX.util.urlencode(this.requisiteEntityTypeId>0?this.requisiteEntityTypeId:0)+"&eid="+BX.util.urlencode(this.requisiteEntityId>0?this.requisiteEntityId:0)+"&pid="+BX.util.urlencode(this.presetId>0?this.presetId:0)}if(BX.type.isNotEmptyString(this._index))i+="&popup_manager_id="+this._index;BX.ajax.submitAjax(e,{url:this.requisitePopupAjaxUrl+i,method:"POST",onsuccess:BX.delegate(this.onFormSubmitRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})},onLoadRequestSuccess:function(t){this.isRequestRunning=false;BX.addCustomEvent(window,"CrmRequisiteEditFormCreate",this.formCreateHandler);BX.addCustomEvent(window,"CrmFormSettingManagerCreate",BX.delegate(this.onFormManagerCreate,this));this.popup=new BX.PopupWindow("test_form_popup",null,{overlay:{opacity:82},autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},closeByEsc:false,closeIcon:{top:"10px",right:"15px"},zIndex:996-1100,titleBar:this.getMessage("popupTitle"),events:{onPopupShow:BX.delegate(this.opPopupShow,this),onPopupClose:BX.delegate(this.opPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},content:this.preparePopupContent(t),buttons:this.prepareButtons()});this.popup.show()},onReloadRequestSuccess:function(t){this.isRequestRunning=false;if(this.wrapper){this.wrapper.innerHTML=t}},onFormSubmitRequestSuccess:function(t){BX.onCustomEvent("CrmRequisitePopupFormManagerClosePopup",[this]);this.setFormId("");BX.addCustomEvent(window,"CrmRequisiteEditFormCreate",this.formCreateHandler);this.isRequestRunning=false;if(!this.wrapper)return;this.wrapper.innerHTML=t;var e=null,i=null,s=0,n=null,r=null,o=false;if(e=BX(this._index.toString()+"_response")){if(i=BX.findChild(e,{tag:"input",attr:{type:"hidden",name:"REQUISITE_ID"}},false,false)){s=parseInt(i.value);if(n=BX.findChild(e,{tag:"input",attr:{type:"hidden",name:"REQUISITE_DATA"}},false,false)){if(r=BX.findChild(e,{tag:"input",attr:{type:"hidden",name:"REQUISITE_DATA_SIGN"}},false,false)){if(n.value&&r.value){var a=n.value;var u=r.value;if(this.blockArea){if(a&&u){if(this.blockIndex>=0)this.blockArea.updateBlock(this.blockIndex,s,a,u);else this.blockArea.addBlock(s,a,u)}}if(typeof this.afterRequisiteEditCallback==="function"){this.afterRequisiteEditCallback(s,a,u)}o=true}}}}}if(o)window.setTimeout(BX.delegate(this.closePopup,this),1e3)},onRequestFailure:function(t){BX.onCustomEvent("CrmRequisitePopupFormManagerClosePopup",[this]);this.isRequestRunning=false},onFormCreate:function(t){BX.removeCustomEvent(window,"CrmRequisiteEditFormCreate",this.formCreateHandler);this.bindToForm(t["form"])},bindToForm:function(t){this.formId=t.getFormId();if(this.saveButton&&BX.type.isNotEmptyString(this.formId)){var e=this.saveButton.render();if(BX.type.isElementNode(e))e.setAttribute("id",this.formId+"_save")}if(this.cancelButton&&BX.type.isNotEmptyString(this.formId)){var i=this.cancelButton.render();if(BX.type.isElementNode(i))i.setAttribute("id",this.formId+"_cancel")}if(this.requisiteAjaxUrl===""){return}if(!t.isClientResolutionEnabled()){return}var s=t.getCountryId();var n="";var r="";switch(s){case 1:n=BX.Crm.RequisiteFieldType.itin;r="RQ_INN";break;case 14:n=BX.Crm.RequisiteFieldType.sro;r="RQ_EDRPOU";break}if(r.length>0){var o=this.getFieldControl(r);if(o){BX.Crm.RequisiteFieldController.create(r,{countryId:s,typeId:n,input:o,serviceUrl:this.requisiteAjaxUrl,callbacks:{onFieldsLoad:BX.delegate(this.setupFields,this)}})}}var a=BX.CrmMultipleAddressEditor.getItemsByFormId(this.formId);if(a.length>0){this.multiAddressEditor=a[0];BX.addCustomEvent(this.multiAddressEditor,"CrmMultipleAddressItemCreated",BX.delegate(this.onAddressCreate,this))}},preparePopupContent:function(t){this.wrapper=BX.create("DIV",{html:t});return this.wrapper},prepareButtons:function(){var t=[];if(!this.readOnlyMode){t.push(this.saveButton=new BX.PopupWindowButton({text:this.getMessage("popupSaveBtnTitle"),className:"popup-window-button-accept",events:{click:BX.delegate(this.onSaveBtnClick,this)}}))}t.push(this.cancelButton=new BX.PopupWindowButtonLink({text:this.getMessage("popupCancelBtnTitle"),className:"popup-window-button-link-cancel",events:{click:BX.delegate(this.onCloseBtnClick,this)}}));return t},opPopupShow:function(){},opPopupClose:function(){BX.onCustomEvent("CrmRequisitePopupFormManagerClosePopup",[this]);if(this.popup){this.wrapper=BX.remove(this.wrapper);this.popup.destroy()}},onPopupDestroy:function(){this.popup=null;if(typeof this.editorPopupDestroyCallback==="function")this.editorPopupDestroyCallback()},onSaveBtnClick:function(t){var e=[];BX.onCustomEvent("CrmDupControllerRequisiteFind",[this,e]);if(e.length<=0)this.saveBtnClickLockObject=this;else this.saveBtnClickLockObject=e[0];BX.addCustomEvent("CrmRequisitePopupFormManagerDoSave",this.doSaveHandler);if(this.saveBtnClickLockObject===this){BX.onCustomEvent("CrmRequisitePopupFormManagerDoSave",[this,true])}else{BX.onCustomEvent(this.saveBtnClickLockObject,"CrmRequisitePopupFormManagerSaveLock")}},onDoSave:function(t,e){if(t!==null&&typeof t==="object"&&t===this.saveBtnClickLockObject&&BX.type.isBoolean(e)){BX.removeCustomEvent("CrmRequisitePopupFormManagerDoSave",this.doSaveHandler);this.saveBtnClickLockObject=null;if(e){this.startFormSubmitRequest()}}},onCloseBtnClick:function(t){this.closePopup()},onFormManagerCreate:function(t){this.formSettingManager=t;BX.addCustomEvent(this.formSettingManager,"CrmFormSettingManagerReloadForm",BX.delegate(this.onFormReload,this))},onFormReload:function(t,e){if(this.formSettingManager!==t){return}e["cancel"]=true;this.reloadPopup()},onAddressCreate:function(t,e){},register:function(){BX.Crm[this._index]=this},unregister:function(){delete BX.Crm[this._index]},destroy:function(){BX.removeCustomEvent("CrmRequisitePopupFormManagerDoSave",this.doSaveHandler);this.unregister()}};return t}();if(typeof BX.setTextContent==="undefined"){BX.setTextContent=function(t,e){if(t){if(t.textContent!==undefined)t.textContent=e;else t.innerText=e}}}BX.Crm.RequisiteFieldType={undefined:"",itin:"itin",sro:"sro"};if(typeof BX.Crm.RequisiteFieldController==="undefined"){BX.Crm.RequisiteFieldController=function(){this._id="";this._settings={};this._countryId=0;this._typeId=BX.Crm.RequisiteFieldType.undefined;this._input=null;this._value="";this._needle="";this._timeoutId=0;this._keyPressHandler=BX.delegate(this.onKeyPress,this);this._timeoutHandler=BX.delegate(this.onTimeout,this);this._serviceUrl="";this._isRequestRunning=false;this._dialog=null};BX.Crm.RequisiteFieldController.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_requisite_form_manager";this._settings=e?e:{};this._countryId=this.getSetting("countryId",0);this._typeId=this.getSetting("typeId",BX.Crm.RequisiteFieldType.undefined);this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"BX.Crm.RequisiteFieldController: Could not find 'serviceUrl' parameter in settings."}this._input=this.getSetting("input");if(!BX.type.isElementNode(this._input)){throw"BX.Crm.RequisiteFieldController: Could not fild 'input' parameter in settings."}this._input.autocomplete="off";BX.bind(this._input,"keyup",this._keyPressHandler)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},validate:function(){var t=false;if(this._typeId===BX.Crm.RequisiteFieldType.itin){this._needle=this._value.replace(/[^0-9]/g,"");if(this._countryId===1){return this._needle.length===10||this._needle.length===12}return this._needle.length===9}else if(this._typeId===BX.Crm.RequisiteFieldType.sro){this._needle=this._value.replace(/[^0-9]/g,"");if(this._countryId===14){return this._needle.length===8}}return t},search:function(){if(this._dialog){this._dialog.close()}this.startSearchRequest()},openDialog:function(t){this.closeDialog();var e=BX.type.isArray(t["ITEMS"])?t["ITEMS"]:[];this._dialog=BX.Crm.ExternalRequisiteDialog.create(this._id,{items:e,anchor:this._input,callbacks:this.getSetting("callbacks")});this._dialog.open();if(e.length===0){window.setTimeout(BX.delegate(this.closeDialog,this),1e3)}},closeDialog:function(){if(this._dialog){this._dialog.close()}},startSearchRequest:function(){if(this._isRequestRunning){return}this._isRequestRunning=true;BX.addClass(BX.findParent(this._input,{className:"crm-offer-info-data-wrap"},1),"search-inp-loading");BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"RESOLVE_EXTERNAL_CLIENT",PROPERTY_TYPE_ID:this._typeId,PROPERTY_VALUE:this._needle,COUNTRY_ID:this._countryId},onsuccess:BX.delegate(this.onSearchRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})},onKeyPress:function(t){t=t||window.event;var e=t.keyCode;if(e===13||e===27||e>=37&&e<=40||e>=112&&e<=123){return}if(this._value===this._input.value){return}this._value=this._input.value;if(this._timeoutId>0){window.clearTimeout(this._timeoutId);this._timeoutId=0}this._timeoutId=window.setTimeout(this._timeoutHandler,1e3)},onTimeout:function(){if(this._timeoutId<=0){return}this._timeoutId=0;if(this.validate()){this._value="";this.search()}},onSearchRequestSuccess:function(t){this._isRequestRunning=false;BX.removeClass(BX.findParent(this._input,{className:"crm-offer-info-data-wrap"},1),"search-inp-loading");this.openDialog(BX.type.isPlainObject(t["DATA"])?t["DATA"]:{})},onRequestFailure:function(t){this._isRequestRunning=false;BX.removeClass(BX.findParent(this._input,{className:"crm-offer-info-data-wrap"},1),"search-inp-loading")}};BX.Crm.RequisiteFieldController.create=function(t,e){var i=new BX.Crm.RequisiteFieldController;i.initialize(t,e);return i}}if(typeof BX.Crm.ExternalRequisiteDialog==="undefined"){BX.Crm.ExternalRequisiteDialog=function(){this._id="";this._settings={};this._callbacks={};this._anchor=null;this._dialog=null;this._itemData=null;this._items=[]};BX.Crm.ExternalRequisiteDialog.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_ext_requisite_dlg";this._settings=e?e:{};this._itemData=this.getSetting("items");if(!BX.type.isArray(this._itemData)){throw"BX.Crm.ExternalRequisiteDialog: Could not fild 'items' parameter in settings."}var i=this.getSetting("callbacks");if(BX.type.isPlainObject(i)){this._callbacks=i}this._anchor=this.getSetting("anchor")},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.Crm.ExternalRequisiteDialog.messages;return e.hasOwnProperty(t)?e[t]:t},open:function(){var t=this.getId();if(BX.Crm.ExternalRequisiteDialog.windows[t]){BX.Crm.ExternalRequisiteDialog.windows[t].destroy()}this._dialog=new BX.PopupWindow(this._id,this._anchor,{autoHide:true,draggable:false,bindOptions:{forceBindPosition:true},closeByEsc:true,zIndex:0,content:this.prepareContent(),events:{onPopupShow:BX.delegate(this.onDialogShow,this),onPopupClose:BX.delegate(this.onDialogClose,this),onPopupDestroy:BX.delegate(this.onDialogDestroy,this)}});BX.Crm.ExternalRequisiteDialog.windows[t]=this._dialog;this._dialog.show()},close:function(){if(this._dialog){this._dialog.close()}},processItemSelection:function(t){if(BX.type.isFunction(this._callbacks["onFieldsLoad"])){this._callbacks["onFieldsLoad"](t.getFields())}this.close()},prepareContent:function(){var t=BX.pos(this._anchor)["width"];var e=this._itemData.length;if(e>0){var i=BX.create("UL",{attrs:{className:"popup-search-result"},style:{width:t.toString()+"px",display:"block"}});for(var s=0;s<e;s++){var n=BX.Crm.ExternalRequisiteDialogItem.create("",{data:this._itemData[s],container:i,dialog:this});n.layout();this._items.push(n)}return i}else{return BX.create("DIV",{attrs:{className:"popup-search-result-empty"},style:{width:t.toString()+"px"},text:this.getMessage("searchResultNotFound")})}},onDialogShow:function(){},onDialogClose:function(){if(this._dialog){this._dialog.destroy()}},onDialogDestroy:function(){if(this._dialog){this._dialog=null}}};if(typeof BX.Crm.ExternalRequisiteDialog.messages==="undefined"){BX.Crm.ExternalRequisiteDialog.messages={}}BX.Crm.ExternalRequisiteDialog.items={};BX.Crm.ExternalRequisiteDialog.windows={};BX.Crm.ExternalRequisiteDialog.create=function(t,e){var i=new BX.Crm.ExternalRequisiteDialog;i.initialize(t,e);BX.Crm.ExternalRequisiteDialog.items[i.getId()]=i;return i}}if(typeof BX.Crm.ExternalRequisiteDialogItem==="undefined"){BX.Crm.ExternalRequisiteDialogItem=function(){this._id="";this._settings={};this._dialog=null;this._data=null;this._container=null;this._element=null;this._onClickHandler=BX.delegate(this.onClick,this);this._hasLayout=false};BX.Crm.ExternalRequisiteDialogItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_ext_requisite_dlg_item";this._settings=e?e:{};this._dialog=this.getSetting("dialog");if(!this._dialog){throw"BX.Crm.ExternalRequisiteDialogItem: Could not fild 'dialog' parameter in settings."}this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"BX.Crm.ExternalRequisiteDialogItem: Could not fild 'container' parameter in settings."}this._data=this.getSetting("data");if(!BX.type.isPlainObject(this._data)){throw"BX.Crm.ExternalRequisiteDialogItem: Could not fild 'data' parameter in settings."}},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getCaption:function(){return BX.type.isNotEmptyString(this._data["caption"])?this._data["caption"]:""},getFields:function(){return BX.type.isPlainObject(this._data["fields"])?this._data["fields"]:{}},layout:function(){if(this._hasLayout){return}this._element=BX.create("LI",{attrs:{className:"popup-search-result-item"},events:{click:this._onClickHandler},children:[BX.create("SPAN",{text:this.getCaption()})]});this._container.appendChild(this._element);this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}BX.remove(this._element);this._element=null;this._hasLayout=false},onClick:function(t){this._dialog.processItemSelection(this);return BX.PreventDefault(t)}};BX.Crm.ExternalRequisiteDialogItem.create=function(t,e){var i=new BX.Crm.ExternalRequisiteDialogItem;i.initialize(t,e);return i}}if(typeof BX.Crm.RequisiteEditFormManager==="undefined"){BX.Crm.RequisiteEditFormManager=function(){this._id="";this._settings={};this._crmRequisiteEditFormGetParamsHandler=BX.delegate(this.onCrmRequisiteEditFormGetParams,this);this._requisitePopupCloseHandler=BX.delegate(this.onRequisitePopupClose,this)};BX.Crm.RequisiteEditFormManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_rq_edit_form_manager_"+Math.random().toString().substring(2);this._settings=e?e:{};this._bind();var i=BX.clone(this._settings);i["form"]=this;BX.onCustomEvent("CrmRequisiteEditFormCreate",[i])},destroy:function(){this._unbind()},getId:function(){return this._id},getSetting:function(t,e){return BX.prop.get(this._settings,t,e)},getFormId:function(){return BX.prop.getString(this._settings,"formId","")},getCountryId:function(){return BX.prop.getInteger(this._settings,"countryId",0)},isClientResolutionEnabled:function(){return BX.prop.getBoolean(this._settings,"enableClientResolution",false)},_bind:function(){BX.addCustomEvent("CrmRequisiteEditFormGetParams",this._crmRequisiteEditFormGetParamsHandler);BX.addCustomEvent("CrmRequisitePopupFormManagerClosePopup",this._requisitePopupCloseHandler)},_unbind:function(){BX.removeCustomEvent("CrmRequisiteEditFormGetParams",this._crmRequisiteEditFormGetParamsHandler);BX.removeCustomEvent("CrmRequisitePopupFormManagerClosePopup",this._requisitePopupCloseHandler)},onCrmRequisiteEditFormGetParams:function(t){if(BX.type.isFunction(t))t(this._settings)},onRequisitePopupClose:function(t){var e="";if(t instanceof BX.Crm.RequisitePopupFormManagerClass){e=t.getFormId();if(BX.type.isNotEmptyString(e)){e=e.replace(/[^a-z0-9_]/gi,"");if(e===this._id)BX.Crm.RequisiteEditFormManager.delete(this._id)}}}};BX.Crm.RequisiteEditFormManager.items={};BX.Crm.RequisiteEditFormManager.create=function(t,e){var i=new BX.Crm.RequisiteEditFormManager;i.initialize(t,e);BX.Crm.RequisiteEditFormManager.items[t]=i;return i};BX.Crm.RequisiteEditFormManager.delete=function(t){if(BX.Crm.RequisiteEditFormManager.items.hasOwnProperty(t)){BX.Crm.RequisiteEditFormManager.items[t].destroy();delete BX.Crm.RequisiteEditFormManager.items[t]}}}