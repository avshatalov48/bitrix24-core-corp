BX.namespace("BX.Crm");BX.Crm.RequisitePresetSelectorClass=function(){var e=function(e){this.id=BX.type.isNotEmptyString(e["id"])?e["id"]:"";if(this.id===""){this.id=BX.type.isNotEmptyString(e["containerId"])?e["containerId"]:"crm_requisite_preset_sel"}this.editor=e.editor;this.container=e.container;this.nextNode=BX.type.isElementNode(e.nextNode)?e.nextNode:null;this.position=BX.type.isNotEmptyString(e.position)?e.position:"";this.content=null;this.requisiteEntityTypeId=e.requisiteEntityTypeId;this.requisiteEntityId=e.requisiteEntityId;this.presetList=e.presetList;this.presetLastSelectedId=parseInt(e.presetLastSelectedId);this.ajaxUrl="/bitrix/components/bitrix/crm.requisite.edit/settings.php";this.requisiteEditHandler=e.requisiteEditHandler;this.curPreset={id:0,title:""};this.curPresetName="";this.labelElement=null;this.buttonElement=null;this._menuId="ps_menu_"+this.id;this._isMenuShown=false;this._buttonClickHandler=BX.delegate(this.onButtonClick,this);this._menuIiemClickHandler=BX.delegate(this.onMenuItemClick,this);this._menuCloseHandler=BX.delegate(this.onMenuClose,this);if(this.presetList.length>0){if(this.presetLastSelectedId<=0)this.curPreset=this.presetList[0];else{for(var t=0;t<this.presetList.length;t++){if(this.presetList[t]["id"]&&this.presetList[t]["id"]==this.presetLastSelectedId){this.curPreset=this.presetList[t];break}}if(this.curPreset["id"]===0){this.curPreset=this.presetList[0];setTimeout(BX.delegate(this.saveLastSelectedPresetId,this),100)}}}this.buildContent()};e.prototype={buildContent:function(){if(this.container){this.labelElement=BX.create("SPAN",{text:this.curPreset["title"]});this.buttonElement=BX.create("SPAN",{attrs:{className:"crm-offer-requisite-option-arrow"}});this.content=BX.create("SPAN",{attrs:{className:"crm-offer-requisite-option"},children:[BX.create("SPAN",{attrs:{className:"crm-offer-requisite-option-caption"},text:this.getMessage("presetSelectorText")+":"}),BX.create("SPAN",{attrs:{className:"crm-offer-requisite-option-text",title:this.getMessage("presetSelectorTitle")},events:{click:BX.delegate(this.onSelectorClick,this)},children:[BX.create("SPAN",{children:[this.labelElement]})]}),this.buttonElement]});this.ajust();if(this.buttonElement){if(this.presetList.length>1){BX.bind(this.buttonElement,"click",this._buttonClickHandler)}else{this.buttonElement.style.display="none"}}}},selectPreset:function(e){if(this.labelElement){if(this.curPreset["id"]!=e["id"]){this.curPreset=e;this.presetLastSelectedId=e["id"];BX.setTextContent(this.labelElement,e["title"]);setTimeout(BX.delegate(this.saveLastSelectedPresetId,this),100)}}},getMessage:function(e){return this.editor?this.editor.getMessage(e):e},getNextNode:function(){return this.nextNode},setNextNode:function(e){e=BX.type.isElementNode(e)?e:null;if(this.nextNode!==e){this.nextNode=e;this.ajust()}},ajust:function(){if(!this.container){return}if(this.container===this.content.parentNode){this.container.removeChild(this.content)}if(this.position==="top"){if(this.container.firstChild){this.container.insertBefore(this.content,this.container.firstChild)}else{this.container.appendChild(this.content)}}else{if(this.container&&this.nextNode){this.container.insertBefore(this.content,this.nextNode)}else{this.container.appendChild(this.content)}}},showError:function(e){alert(e)},onButtonClick:function(e){this.showMenu()},showMenu:function(){if(this._isMenuShown){return}var e=[];for(var t=0;t<this.presetList.length;t++){var i=this.presetList[t];e.push({text:BX.util.htmlspecialchars(i["title"]),value:i["id"],href:"#",className:"crm-convert-item",onclick:this._menuIiemClickHandler})}if(typeof BX.PopupMenu.Data[this._menuId]!=="undefined"){BX.PopupMenu.Data[this._menuId].popupWindow.destroy();delete BX.PopupMenu.Data[this._menuId]}var s=this.buttonElement;var n=BX.pos(s);BX.PopupMenu.show(this._menuId,s,e,{autoHide:true,offsetLeft:n["width"]/2,angle:{position:"top",offset:0},events:{onPopupClose:this._menuCloseHandler}});this._isMenuShown=true},closeMenu:function(){if(!this._isMenuShown){return}BX.PopupMenu.destroy(this._menuId);this._isMenuShown=false},onMenuClose:function(){this._isMenuShown=false},onMenuItemClick:function(e,t){var i={id:0,title:""};for(var s=0;s<this.presetList.length;s++){if(this.presetList[s]["id"]&&this.presetList[s]["id"]==t["value"]){i=this.presetList[s];break}}this.selectPreset(i);this.closeMenu();return BX.PreventDefault(e)},onSelectorClick:function(e){this.closeMenu();if(this.requisiteEditHandler){if(parseInt(this.curPreset["id"])<=0){this.showError(this.getMessage("errPresetNotSelected"))}else{this.requisiteEditHandler(this.requisiteEntityTypeId,this.requisiteEntityId,this.curPreset["id"],0)}}return BX.PreventDefault(e)},saveLastSelectedPresetId:function(){var e=BX.util.add_url_param(this.ajaxUrl,{sessid:BX.bitrix_sessid()});var t={action:"savelastselectedpreset",requisiteEntityTypeId:this.requisiteEntityTypeId,presetId:this.presetLastSelectedId};BX.ajax.post(e,t)}};return e}();BX.Crm.RequisitePopupFormManagerClass=function(){var e=function(e){this._random=Math.random().toString().substring(2);this._index="RequisitePopupFormManager_"+this._random;this.editor=e.editor;this.blockArea=e.blockArea;this.requisiteEntityTypeId=e.requisiteEntityTypeId;this.requisiteEntityId=e.requisiteEntityId;this.requisiteId=e.requisiteId;this.requisiteData=e.requisiteData;this.requisiteDataSign=e.requisiteDataSign;this.presetId=e.presetId;this.multiAddressEditor=null;this.requisiteAjaxUrl=BX.type.isNotEmptyString(e.requisiteAjaxUrl)?e.requisiteAjaxUrl:"";this.requisitePopupAjaxUrl=e.requisitePopupAjaxUrl;this.isRequestRunning=false;this.wrapper=null;this.popup=null;this.saveButton=null;this.cancelButton=null;this.formId="";this.formSettingManager=null;this.formCreateHandler=BX.delegate(this.onFormCreate,this);this.editorPopupDestroyCallback=e.popupDestroyCallback;this.blockIndex=BX.type.isNumber(e.blockIndex)&&e.blockIndex>=0||BX.type.isNotEmptyString(e.blockIndex)?parseInt(e.blockIndex):-1;this.afterRequisiteEditCallback=e.afterRequisiteEditCallback;this.copyMode=!!e.copyMode;this.readOnlyMode=!!e.readOnlyMode;this.saveBtnClickLockObject=null;this.doSaveHandler=BX.delegate(this.onDoSave,this);this._requisiteExternalSearchManager=null;this.register()};e.prototype={getWrapperNode:function(){return this.wrapper},getMessage:function(e){return this.editor?this.editor.getMessage(e):e},getFieldControl:function(e){var t=document.getElementsByName(e);return t.length>0?t[0]:null},setFormId:function(e){this.formId=BX.type.isNotEmptyString(e)?e:""},getFormId:function(){return this.formId},setFieldValue:function(e,t){var i=this.getFieldControl(e);if(i!==null){i.value=t}},setupFields:function(e){var t=document.querySelectorAll('input[type="text"][data-requisite="field"],textarea[data-requisite="field"]');for(var i=0;i<t.length;i++){t[i].value=""}for(var s in e){if(!e.hasOwnProperty(s)){continue}if(s!=="RQ_ADDR"){this.setFieldValue(s,e[s])}else if(this.multiAddressEditor){var n=e[s];for(var r in n){if(!n.hasOwnProperty(r)){continue}var a=n[r];var o=parseInt(r);var l=this.multiAddressEditor.getItemByTypeId(o);if(l===null){l=this.multiAddressEditor.createItem(o,this.formId)}l.setup(a)}}}},openPopup:function(){if(!this.popup){this.startLoadRequest()}},closePopup:function(){if(this.popup){this.popup.close()}},reloadPopup:function(){if(this.popup){this.startReloadRequest()}},startLoadRequest:function(){if(this.isRequestRunning){return}this.isRequestRunning=true;var e="";if(this.requisiteId>0){e+="&etype="+BX.util.urlencode(this.requisiteEntityTypeId>0?this.requisiteEntityTypeId:0)+"&eid="+BX.util.urlencode(this.requisiteEntityId>0?this.requisiteEntityId:0)+"&requisite_id="+BX.util.urlencode(this.requisiteId);if(this.copyMode)e+="&copy=1"}else{e+="&etype="+BX.util.urlencode(this.requisiteEntityTypeId>0?this.requisiteEntityTypeId:0)+"&eid="+BX.util.urlencode(this.requisiteEntityId>0?this.requisiteEntityId:0)+"&pid="+BX.util.urlencode(this.presetId>0?this.presetId:0)+"&requisite_data="+BX.util.urlencode(BX.type.isNotEmptyString(this.requisiteData)?this.requisiteData:"")+"&requisite_data_sign="+BX.util.urlencode(BX.type.isNotEmptyString(this.requisiteDataSign)?this.requisiteDataSign:"")}if(BX.type.isNotEmptyString(this._index))e+="&popup_manager_id="+this._index;BX.ajax({url:this.requisitePopupAjaxUrl+e,method:"POST",dataType:"html",data:{},prepareData:true,onsuccess:BX.delegate(this.onLoadRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})},startReloadRequest:function(){if(this.isRequestRunning){return}this.isRequestRunning=true;var e=this.formSettingManager.getForm();e.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"reload",value:"Y"}}));var t="";if(this.requisiteId>0){t+="&requisite_id="+BX.util.urlencode(this.requisiteId);if(this.copyMode)t+="&copy=1"}else{t+="&etype="+BX.util.urlencode(this.requisiteEntityTypeId>0?this.requisiteEntityTypeId:0)+"&eid="+BX.util.urlencode(this.requisiteEntityId>0?this.requisiteEntityId:0)+"&pid="+BX.util.urlencode(this.presetId>0?this.presetId:0)}if(BX.type.isNotEmptyString(this._index))t+="&popup_manager_id="+this._index;BX.ajax.submitAjax(e,{url:this.requisitePopupAjaxUrl+t,method:"POST",data:{},onsuccess:BX.delegate(this.onReloadRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})},startFormSubmitRequest:function(e){if(this.isRequestRunning){return}this.isRequestRunning=true;var t=this.formSettingManager.getForm();t["save"]=t.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"save",value:"Y"}}));var i="";if(this.requisiteId>0){i+="&requisite_id="+BX.util.urlencode(this.requisiteId);if(this.copyMode)i+="&copy=1"}else{i+="&etype="+BX.util.urlencode(this.requisiteEntityTypeId>0?this.requisiteEntityTypeId:0)+"&eid="+BX.util.urlencode(this.requisiteEntityId>0?this.requisiteEntityId:0)+"&pid="+BX.util.urlencode(this.presetId>0?this.presetId:0)}if(BX.type.isNotEmptyString(this._index))i+="&popup_manager_id="+this._index;BX.ajax.submitAjax(t,{url:this.requisitePopupAjaxUrl+i,method:"POST",onsuccess:BX.delegate(this.onFormSubmitRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})},onLoadRequestSuccess:function(e){this.isRequestRunning=false;BX.addCustomEvent(window,"CrmRequisiteEditFormCreate",this.formCreateHandler);BX.addCustomEvent(window,"CrmFormSettingManagerCreate",BX.delegate(this.onFormManagerCreate,this));this.popup=new BX.PopupWindow("test_form_popup",null,{overlay:{opacity:82},autoHide:false,draggable:true,offsetLeft:0,offsetTop:0,bindOptions:{forceBindPosition:false},closeByEsc:false,closeIcon:{top:"10px",right:"15px"},zIndex:996-1100,titleBar:this.getMessage("popupTitle"),events:{onPopupShow:BX.delegate(this.opPopupShow,this),onPopupClose:BX.delegate(this.opPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},content:this.preparePopupContent(e),buttons:this.prepareButtons()});this.popup.show()},onReloadRequestSuccess:function(e){this.isRequestRunning=false;if(this.wrapper){this.wrapper.innerHTML=e}},onFormSubmitRequestSuccess:function(e){BX.onCustomEvent("CrmRequisitePopupFormManagerClosePopup",[this]);this.setFormId("");BX.addCustomEvent(window,"CrmRequisiteEditFormCreate",this.formCreateHandler);this.isRequestRunning=false;if(!this.wrapper)return;this.wrapper.innerHTML=e;var t=null,i=null,s=0,n=null,r=null,a=false;t=BX(this._index.toString()+"_response");if(t){i=BX.findChild(t,{tag:"input",attr:{type:"hidden",name:"REQUISITE_ID"}},false,false);if(i){s=parseInt(i.value);n=BX.findChild(t,{tag:"input",attr:{type:"hidden",name:"REQUISITE_DATA"}},false,false);if(n){r=BX.findChild(t,{tag:"input",attr:{type:"hidden",name:"REQUISITE_DATA_SIGN"}},false,false);if(r){if(n.value&&r.value){var o=n.value;var l=r.value;if(this.blockArea){if(o&&l){if(this.blockIndex>=0)this.blockArea.updateBlock(this.blockIndex,s,o,l);else this.blockArea.addBlock(s,o,l)}}if(typeof this.afterRequisiteEditCallback==="function"){this.afterRequisiteEditCallback(s,o,l)}a=true}}}}}if(a){window.setTimeout(BX.delegate(this.closePopup,this),1e3)}},onRequestFailure:function(e){BX.onCustomEvent("CrmRequisitePopupFormManagerClosePopup",[this]);this.isRequestRunning=false},onFormCreate:function(e){BX.removeCustomEvent(window,"CrmRequisiteEditFormCreate",this.formCreateHandler);this.bindToForm(e["form"])},bindToForm:function(e){this.destroyRequisiteExternalSearchManager();if(typeof e==="object"&&e!==null){this.formId=e.getFormId();if(this.saveButton&&BX.type.isNotEmptyString(this.formId)){var t=this.saveButton.render();if(BX.type.isElementNode(t))t.setAttribute("id",this.formId+"_save")}if(this.cancelButton&&BX.type.isNotEmptyString(this.formId)){var i=this.cancelButton.render();if(BX.type.isElementNode(i))i.setAttribute("id",this.formId+"_cancel")}if(this.requisiteAjaxUrl===""){return}if(!e.isClientResolutionEnabled()){return}var s=e.getCountryId();var n="";var r="";switch(s){case 1:n=BX.Crm.RequisiteFieldType.itin;r="RQ_INN";break;case 14:n=BX.Crm.RequisiteFieldType.sro;r="RQ_EDRPOU";break}var a=e.getSetting("externalRequisiteSearchConfig",null);var o=BX.type.isPlainObject(a)&&a.hasOwnProperty("enabled")&&a["enabled"];var l=[];var d;if(r.length>0){var u=this.getFieldControl(r);if(u){d=BX.Crm.RequisiteFieldController.create(r,{countryId:s,typeId:n,input:u,serviceUrl:this.requisiteAjaxUrl,callbacks:{onFieldsLoad:BX.delegate(this.setupFields,this)}});if(o){l.push({fieldId:"REQUISITE."+a["requisitePseudoId"]+"."+r,controller:d})}}}this.destroyRequisiteExternalSearchManager();if(o){a["containerId"]="form_"+this.formId;a["countryId"]=s;a["addressOriginatorId"]="";a["defaultFieldControllers"]=l;this._requisiteExternalSearchManager=BX.Crm.RequisiteExternalSearchManager.create(null,a)}}var h=BX.CrmMultipleAddressEditor.getItemsByFormId(this.formId);if(h.length>0){this.multiAddressEditor=h[0];BX.addCustomEvent(this.multiAddressEditor,"CrmMultipleAddressItemCreated",BX.delegate(this.onAddressCreate,this))}},preparePopupContent:function(e){this.wrapper=BX.create("DIV",{html:e});return this.wrapper},prepareButtons:function(){var e=[];if(!this.readOnlyMode){e.push(this.saveButton=new BX.PopupWindowButton({text:this.getMessage("popupSaveBtnTitle"),className:"popup-window-button-accept",events:{click:BX.delegate(this.onSaveBtnClick,this)}}))}e.push(this.cancelButton=new BX.PopupWindowButtonLink({text:this.getMessage("popupCancelBtnTitle"),className:"popup-window-button-link-cancel",events:{click:BX.delegate(this.onCloseBtnClick,this)}}));return e},destroyRequisiteExternalSearchManager:function(){if(this._requisiteExternalSearchManager){BX.Crm.RequisiteExternalSearchManager.delete(this._requisiteExternalSearchManager.getId());this._requisiteExternalSearchManager=null}},opPopupShow:function(){},opPopupClose:function(){BX.onCustomEvent("CrmRequisitePopupFormManagerClosePopup",[this]);if(this.popup){this.wrapper=BX.remove(this.wrapper);this.popup.destroy()}},onPopupDestroy:function(){this.popup=null;if(typeof this.editorPopupDestroyCallback==="function")this.editorPopupDestroyCallback()},onSaveBtnClick:function(e){var t=[];this.destroyRequisiteExternalSearchManager();BX.onCustomEvent("CrmDupControllerRequisiteFind",[this,t]);if(t.length<=0)this.saveBtnClickLockObject=this;else this.saveBtnClickLockObject=t[0];BX.addCustomEvent("CrmRequisitePopupFormManagerDoSave",this.doSaveHandler);if(this.saveBtnClickLockObject===this){BX.onCustomEvent("CrmRequisitePopupFormManagerDoSave",[this,true])}else{BX.onCustomEvent(this.saveBtnClickLockObject,"CrmRequisitePopupFormManagerSaveLock")}},onDoSave:function(e,t){if(e!==null&&typeof e==="object"&&e===this.saveBtnClickLockObject&&BX.type.isBoolean(t)){BX.removeCustomEvent("CrmRequisitePopupFormManagerDoSave",this.doSaveHandler);this.saveBtnClickLockObject=null;if(t){this.startFormSubmitRequest()}}},onCloseBtnClick:function(e){this.closePopup()},onFormManagerCreate:function(e){this.formSettingManager=e;BX.addCustomEvent(this.formSettingManager,"CrmFormSettingManagerReloadForm",BX.delegate(this.onFormReload,this))},onFormReload:function(e,t){if(this.formSettingManager!==e){return}t["cancel"]=true;this.reloadPopup()},onAddressCreate:function(e,t){},register:function(){BX.Crm[this._index]=this},unregister:function(){delete BX.Crm[this._index]},destroy:function(){BX.removeCustomEvent("CrmRequisitePopupFormManagerDoSave",this.doSaveHandler);this.destroyRequisiteExternalSearchManager();this.unregister()}};return e}();if(typeof BX.setTextContent==="undefined"){BX.setTextContent=function(e,t){if(e){if(e.textContent!==undefined)e.textContent=t;else e.innerText=t}}}BX.Crm.RequisiteFieldType={undefined:"",itin:"itin",sro:"sro"};if(typeof BX.Crm.RequisiteFieldController==="undefined"){BX.Crm.RequisiteFieldController=function(){this._id="";this._settings={};this._countryId=0;this._typeId=BX.Crm.RequisiteFieldType.undefined;this._input=null;this._value="";this._needle="";this._timeoutId=0;this._keyPressHandler=BX.delegate(this.onKeyPress,this);this._timeoutHandler=BX.delegate(this.onTimeout,this);this._inputAutocomplete="";this._serviceUrl="";this._isRequestRunning=false;this._isActive=false;this._dialog=null};BX.Crm.RequisiteFieldController.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:"crm_requisite_form_manager";this._settings=t?t:{};this._countryId=this.getSetting("countryId",0);this._typeId=this.getSetting("typeId",BX.Crm.RequisiteFieldType.undefined);this._serviceUrl=this.getSetting("serviceUrl","");if(!BX.type.isNotEmptyString(this._serviceUrl)){throw"BX.Crm.RequisiteFieldController: Could not find 'serviceUrl' parameter in settings."}this._input=this.getSetting("input");if(!BX.type.isElementNode(this._input)){throw"BX.Crm.RequisiteFieldController: Could not fild 'input' parameter in settings."}this.activate()},getId:function(){return this._id},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},validate:function(){var e=false;if(this._typeId===BX.Crm.RequisiteFieldType.itin){this._needle=this._value.replace(/[^0-9]/g,"");if(this._countryId===1){return this._needle.length===10||this._needle.length===12}return this._needle.length===9}else if(this._typeId===BX.Crm.RequisiteFieldType.sro){this._needle=this._value.replace(/[^0-9]/g,"");if(this._countryId===14){return this._needle.length===8}}return e},search:function(){if(!this._isActive){return}if(this._dialog){this._dialog.close()}this.startSearchRequest()},openDialog:function(e){if(!this._isActive){return}this.closeDialog();var t=BX.type.isPlainObject(e["SELECT_PARAMS"])?e["SELECT_PARAMS"]:{};var i=BX.type.isArray(e["ITEMS"])?e["ITEMS"]:[];this._dialog=BX.Crm.ExternalRequisiteDialog.create(this._id,{items:i,anchor:this._input,callbacks:this.getSetting("callbacks"),selectParams:t});this._dialog.open();if(i.length===0){window.setTimeout(BX.delegate(this.closeDialog,this),1e3)}},showLoader:function(){BX.addClass(BX.findParent(this._input,{className:"crm-offer-info-data-wrap"},1),"search-inp-loading")},hideLoader:function(){BX.removeClass(BX.findParent(this._input,{className:"crm-offer-info-data-wrap"},1),"search-inp-loading")},closeDialog:function(){if(this._dialog){this._dialog.close()}},startSearchRequest:function(){if(!this._isActive||this._isRequestRunning){return}this._isRequestRunning=true;this.showLoader();BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"RESOLVE_EXTERNAL_CLIENT",PROPERTY_TYPE_ID:this._typeId,PROPERTY_VALUE:this._needle,COUNTRY_ID:this._countryId},onsuccess:BX.delegate(this.onSearchRequestSuccess,this),onfailure:BX.delegate(this.onRequestFailure,this)})},onKeyPress:function(e){if(!this._isActive){return}e=e||window.event;var t=e.keyCode;if(t===13||t===27||t>=37&&t<=40||t>=112&&t<=123){return}if(this._value===this._input.value){return}this._value=this._input.value;if(this._timeoutId>0){window.clearTimeout(this._timeoutId);this._timeoutId=0}this._timeoutId=window.setTimeout(this._timeoutHandler,1e3)},onTimeout:function(){if(!this._isActive||this._timeoutId<=0){return}this._timeoutId=0;if(this.validate()){this._value="";this.search()}},onSearchRequestSuccess:function(e){if(!this._isActive){return}this._isRequestRunning=false;this.hideLoader();this.openDialog(BX.type.isPlainObject(e["DATA"])?e["DATA"]:{})},onRequestFailure:function(e){if(!this._isActive){return}this._isRequestRunning=false;this.hideLoader()},isActive:function(){return this._isActive},bindHandlers:function(){BX.bind(this._input,"keyup",this._keyPressHandler)},activate:function(){this._inputAutocomplete=this._input.autocomplete;this._input.autocomplete="off";this.bindHandlers();this._isActive=true},unbindHandlers:function(){BX.unbind(this._input,"keyup",this._keyPressHandler)},deactivate:function(){this._isActive=false;if(this._timeoutId>0){window.clearTimeout(this._timeoutId);this._timeoutId=0}this.unbindHandlers();this._input.autocomplete=this._inputAutocomplete;this.closeDialog();this._dialog=null;if(this._isRequestRunning){this.hideLoader();this._isRequestRunning=false}},destroy:function(){this.deactivate();this._id="";this._settings={};this._countryId=0;this._typeId=BX.Crm.RequisiteFieldType.undefined;this._input=null;this._value="";this._needle="";this._inputAutocomplete="";this._serviceUrl="";this._dialog=null}};BX.Crm.RequisiteFieldController.create=function(e,t){var i=new BX.Crm.RequisiteFieldController;i.initialize(e,t);return i}}if(typeof BX.Crm.ExternalRequisiteDialog==="undefined"){BX.Crm.ExternalRequisiteDialog=function(){this._id="";this._settings={};this._callbacks={};this._anchor=null;this._dialog=null;this._itemData=null;this._items=[];this._selectParams=null;this._isResultSelected=false};BX.Crm.ExternalRequisiteDialog.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:"crm_ext_requisite_dlg";this._settings=t?t:{};this._itemData=this.getSetting("items");if(!BX.type.isArray(this._itemData)){throw"BX.Crm.ExternalRequisiteDialog: Could not fild 'items' parameter in settings."}var i=this.getSetting("callbacks");if(BX.type.isPlainObject(i)){this._callbacks=i}this._anchor=this.getSetting("anchor");this._selectParams=this.getSetting("selectParams",null)},getId:function(){return this._id},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getMessage:function(e){var t=BX.Crm.ExternalRequisiteDialog.messages;return t.hasOwnProperty(e)?t[e]:e},open:function(){var e=this.getId();if(BX.Crm.ExternalRequisiteDialog.windows[e]){BX.Crm.ExternalRequisiteDialog.windows[e].destroy()}this._dialog=new BX.PopupWindow(this._id,this._anchor,{autoHide:true,draggable:false,bindOptions:{forceBindPosition:true},closeByEsc:true,zIndex:0,content:this.prepareContent(),events:{onPopupShow:BX.delegate(this.onDialogShow,this),onPopupClose:BX.delegate(this.onDialogClose,this),onPopupDestroy:BX.delegate(this.onDialogDestroy,this)}});BX.Crm.ExternalRequisiteDialog.windows[e]=this._dialog;this._dialog.show()},close:function(){if(this._dialog){this._dialog.close()}},processItemSelection:function(e){var t;this._isResultSelected=true;if(BX.type.isFunction(this._callbacks["onFieldsLoad"])){t=BX.type.isPlainObject(this._selectParams)?this._selectParams:{};t["index"]=e.getIndex();this._callbacks["onFieldsLoad"](e.getFields(),t)}this.close()},prepareContent:function(){var e=BX.pos(this._anchor)["width"];var t=this._itemData.length;if(t>0){var i=BX.create("UL",{attrs:{className:"popup-search-result"},style:{display:"block"}});for(var s=0;s<t;s++){var n=BX.Crm.ExternalRequisiteDialogItem.create("",{index:s,data:this._itemData[s],container:i,dialog:this});n.layout();this._items.push(n)}return i}else{return BX.create("DIV",{attrs:{className:"popup-search-result-empty"},style:{width:e.toString()+"px"},text:this.getMessage("searchResultNotFound")})}},onDialogShow:function(){},onDialogClose:function(){if(this._dialog){if(!this._isResultSelected&&BX.type.isFunction(this._callbacks["onFieldsLoadCancel"])){this._callbacks["onFieldsLoadCancel"](this.getId(),this._selectParams)}this._dialog.destroy()}},onDialogDestroy:function(){if(this._dialog){this._dialog=null}}};if(typeof BX.Crm.ExternalRequisiteDialog.messages==="undefined"){BX.Crm.ExternalRequisiteDialog.messages={}}BX.Crm.ExternalRequisiteDialog.items={};BX.Crm.ExternalRequisiteDialog.windows={};BX.Crm.ExternalRequisiteDialog.create=function(e,t){var i=new BX.Crm.ExternalRequisiteDialog;i.initialize(e,t);BX.Crm.ExternalRequisiteDialog.items[i.getId()]=i;return i}}if(typeof BX.Crm.ExternalRequisiteDialogItem==="undefined"){BX.Crm.ExternalRequisiteDialogItem=function(){this._id="";this._settings={};this._dialog=null;this._data=null;this._container=null;this._element=null;this._onClickHandler=BX.delegate(this.onClick,this);this._hasLayout=false};BX.Crm.ExternalRequisiteDialogItem.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:"crm_ext_requisite_dlg_item";this._settings=t?t:{};this._dialog=this.getSetting("dialog");if(!this._dialog){throw"BX.Crm.ExternalRequisiteDialogItem: Could not fild 'dialog' parameter in settings."}this._container=this.getSetting("container");if(!BX.type.isElementNode(this._container)){throw"BX.Crm.ExternalRequisiteDialogItem: Could not fild 'container' parameter in settings."}this._data=this.getSetting("data");if(!BX.type.isPlainObject(this._data)){throw"BX.Crm.ExternalRequisiteDialogItem: Could not fild 'data' parameter in settings."}},getId:function(){return this._id},getIndex:function(){var e;e=parseInt(this.getSetting("index",-1));if(isNaN(e)||e<0){e=-1}return e},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getCaption:function(){return BX.type.isNotEmptyString(this._data["caption"])?this._data["caption"]:""},getFields:function(){return BX.type.isPlainObject(this._data["fields"])?this._data["fields"]:{}},layout:function(){if(this._hasLayout){return}this._element=BX.create("LI",{attrs:{className:"popup-search-result-item"},events:{click:this._onClickHandler},children:[BX.create("SPAN",{text:this.getCaption()})]});this._container.appendChild(this._element);this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}BX.remove(this._element);this._element=null;this._hasLayout=false},onClick:function(e){this._dialog.processItemSelection(this);return BX.PreventDefault(e)}};BX.Crm.ExternalRequisiteDialogItem.create=function(e,t){var i=new BX.Crm.ExternalRequisiteDialogItem;i.initialize(e,t);return i}}if(typeof BX.Crm.RequisiteEditFormManager==="undefined"){BX.Crm.RequisiteEditFormManager=function(){this._id="";this._settings={};this._crmRequisiteEditFormGetParamsHandler=BX.delegate(this.onCrmRequisiteEditFormGetParams,this);this._requisitePopupCloseHandler=BX.delegate(this.onRequisitePopupClose,this)};BX.Crm.RequisiteEditFormManager.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:"crm_rq_edit_form_manager_"+Math.random().toString().substring(2);this._settings=t?t:{};this._bind();var i=BX.clone(this._settings);i["form"]=this;BX.onCustomEvent("CrmRequisiteEditFormCreate",[i])},destroy:function(){this._unbind()},getId:function(){return this._id},getSetting:function(e,t){return BX.prop.get(this._settings,e,t)},getFormId:function(){return BX.prop.getString(this._settings,"formId","")},getCountryId:function(){return BX.prop.getInteger(this._settings,"countryId",0)},isClientResolutionEnabled:function(){return BX.prop.getBoolean(this._settings,"enableClientResolution",false)},_bind:function(){BX.addCustomEvent("CrmRequisiteEditFormGetParams",this._crmRequisiteEditFormGetParamsHandler);BX.addCustomEvent("CrmRequisitePopupFormManagerClosePopup",this._requisitePopupCloseHandler)},_unbind:function(){BX.removeCustomEvent("CrmRequisiteEditFormGetParams",this._crmRequisiteEditFormGetParamsHandler);BX.removeCustomEvent("CrmRequisitePopupFormManagerClosePopup",this._requisitePopupCloseHandler)},onCrmRequisiteEditFormGetParams:function(e){if(BX.type.isFunction(e))e(this._settings)},onRequisitePopupClose:function(e){var t="";if(e instanceof BX.Crm.RequisitePopupFormManagerClass){t=e.getFormId();if(BX.type.isNotEmptyString(t)){t=t.replace(/[^a-z0-9_]/gi,"");if(t===this._id)BX.Crm.RequisiteEditFormManager.delete(this._id)}}}};BX.Crm.RequisiteEditFormManager.items={};BX.Crm.RequisiteEditFormManager.create=function(e,t){var i=new BX.Crm.RequisiteEditFormManager;i.initialize(e,t);BX.Crm.RequisiteEditFormManager.items[e]=i;return i};BX.Crm.RequisiteEditFormManager.delete=function(e){if(BX.Crm.RequisiteEditFormManager.items.hasOwnProperty(e)){BX.Crm.RequisiteEditFormManager.items[e].destroy();delete BX.Crm.RequisiteEditFormManager.items[e]}}}if(typeof BX.Crm.RequisiteExternalSearchApplication==="undefined"){BX.Crm.RequisiteExternalSearchApplication=function(){this._random="";this._id="";this._lastId="";this._settings={};this._manager=null;this._loadCallback=null;this._closeCallback=null;this._appId="";this._placementId=0;this._placementCode="";this._placementOptions={};this._container=null;this._contentContainer=null;this._maxTimeout=0;this._subscription=[];this._stateMap={destoyed:0,initialized:1,loaded:2,fieldsChangeRequest:3,closed:4};this._stateArr=[];var e;for(e in this._stateMap){if(this._stateMap.hasOwnProperty(e)){this._stateArr[this._stateMap[e]]=e}}this._state=this._stateMap["destoyed"]};BX.Crm.RequisiteExternalSearchApplication.prototype={initialize:function(e,t){if(this._id!==""){this.destroy()}this._random=Math.random().toString().substring(2);this._id=BX.type.isNotEmptyString(e)?e:"crm_rq_ext_search_app_"+this._random;this._lastId=this._id;this._settings=t?t:{};var i=this.getSetting("handler",null);if(BX.type.isPlainObject(i)){if(i.hasOwnProperty("APP_ID")){this._appId=parseInt(i["APP_ID"])}if(i.hasOwnProperty("ID")){this._placementId=parseInt(i["ID"])}if(i.hasOwnProperty("CODE")){this._placementCode=i["CODE"]}this._placementOptions={instanceId:this.getId(),entityTypeId:this.getSetting("entityTypeId",0),entityId:this.getSetting("entityId",0),presetId:this.getSetting("presetId",0),countryId:this.getSetting("countryId",0),requisiteId:this.getSetting("requisiteId",0),handler:i}}var s=this.getSetting("manager",null);if(s!==null&&typeof s==="object"){this._manager=s}var n=this.getSetting("loadCallback",null);if(typeof n==="function"){this._loadCallback=n}var r=this.getSetting("closeCallback",null);if(typeof r==="function"){this._closeCallback=r}var a;var o=this.getSetting("containerId","");if(BX.type.isNotEmptyString(o)){a=BX(o);if(BX.type.isDomNode(a)){this._container=a}}if(this._container){this._contentContainer=this._container.appendChild(BX.create("div",{attrs:{id:this.getId(),style:"display: none;"}}))}this.setState("initialized")},_clear:function(){this._random="";this._id="";this._settings={};this._manager=null;this._loadCallback=null;this._closeCallback=null;this._appId="";this._placementId=0;this._placementCode="";this._placementOptions={};if(BX.type.isDomNode(this._contentContainer)){BX.remove(this._contentContainer)}this._container=null;this._contentContainer=null;this._maxTimeout=0;this._subscription=[]},destroy:function(){var e=this.getState();if(e!=="closed"&&e!=="destoyed"){this.close()}this._unbind();this._clear();e=this.getState();if(e!=="destoyed"){this.setState("destoyed")}},getId:function(){return this._id},getSetting:function(e,t){return BX.prop.get(this._settings,e,t)},_bind:function(){},_unbind:function(){},getStateId:function(){return this._state},getState:function(){return this._stateArr[this._state]},setState:function(e){if(!this._stateMap.hasOwnProperty(e)){return false}this._state=this._stateMap[e];return true},getMaxTimeout:function(e){return this._maxTimeout},setMaxTimeout:function(e){var t=parseInt(e);if(t>=1e3&&t<=3e4){this._maxTimeout=t}},setReadyState:function(){var e;e=false;if(this.getState()==="initialized"){e=this.onLoad()}return e},setSubscription:function(e){var t,i;t=false;if(BX.type.isArray(e)){if(this._manager){i=this.getState();if(i==="loaded"||i==="fieldsChangeRequest"){this._manager.setSubscription(this._id,e);t=true}}}return t},getValues:function(e){var t,i;t=[];if(BX.type.isArray(e)&&e.length>0&&this._manager){i=this.getState();if(i==="loaded"||i==="fieldsChangeRequest"){t=this._manager.getValues(this.getId(),e)}}return t},setResultReady:function(e){var t;t=false;if(this.getState()==="fieldsChangeRequest"&&this._manager){t=this._manager.setResultReady(this._id,e)}return t},setResult:function(e,t){var i,s;i=false;if(this.getState()==="fieldsChangeRequest"&&this._manager){i=this._manager.setResult(this._id,e,t)}return i},getAppId:function(){return this._appId},getPlacementId:function(){return this._placementId},getPlacementCode:function(){return this._placementCode},getPlacementOptions:function(){return this._placementOptions},getContentContainer:function(){return this._contentContainer},isDestroyed:function(){return this.getState()==="destroyed"},load:function(){var e=BX.message("REST_APPLICATION_URL").replace("#id#",this.getAppId());e=BX.util.add_url_param(e,{_r:Math.random()});var t={ID:this.getAppId(),PLACEMENT:this.getPlacementCode(),PLACEMENT_ID:this.getPlacementId(),PLACEMENT_OPTIONS:this.getPlacementOptions(),SHOW_LOADER:"N",POPUP:1};var i=new BX.Promise;i.then(function(e){var i=new top.BX.Promise;BX.ajax.post(e,{sessid:BX.bitrix_sessid(),site:BX.message("SITE_ID"),PARAMS:{template:"",params:t}},function(e){i.fulfill(e)});return i}).then(function(e){if(this.isDestroyed()){return}if(BX.type.isNotEmptyString(e)){this.getContentContainer().innerHTML=e}}.bind(this),function(e){this.destroy();BX.debug("error",e)});i.fulfill(e);top.BX.addCustomEvent(top,"Rest:AppLayout:ApplicationInstall",function(e,t){this.load()})},addAddress:function(e,t){var i;i=false;if(this.getState()==="fieldsChangeRequest"&&this._manager){i=this._manager.addAddress(e,this.getId(),t)}return i},removeAddress:function(e,t){var i;i=this.getState()==="fieldsChangeRequest";if(i&&this._manager){i=this._manager.removeAddress(e,this.getId(),t)}return i},addBankDetail:function(e){var t;t=0;if(this.getState()==="fieldsChangeRequest"&&this._manager){t=this._manager.addBankDetail(e,this.getId())}return t},removeBankDetail:function(e,t){var i;i=0;if(this.getState()==="fieldsChangeRequest"&&this._manager){i=this._manager.removeBankDetail(e,this.getId(),t)}return i},close:function(){BX.onCustomEvent("onCrmRequisiteEditFormApplicationClose",[{instanceId:this._lastId}]);this.onClose()},onLoad:function(){var e=this.setState("loaded");if(e){if(this._loadCallback){this._loadCallback(this._id)}}return e},onFieldsChange:function(e,t){var i;i=BX.type.isNotEmptyString(e)&&BX.type.isArray(t)&&t.length>0;if(i){if(this.getState()==="loaded"){i=this.setState("fieldsChangeRequest")}}if(i){BX.onCustomEvent("onCrmRequisiteEditFormFieldChange",[{instanceId:this.getId(),token:e,fields:t}])}return i},onCancelFieldsChange:function(){var e;e=false;if(this.getState()==="fieldsChangeRequest"){e=this.setState("loaded")}return e},onFieldsRemove:function(e){var t,i;t=BX.type.isArray(e)&&e.length>0;if(t){i=this.getState();if(i!=="loaded"&&i!=="fieldsChangeRequest"){t=false}}if(t){BX.onCustomEvent("onCrmRequisiteEditFormFieldRemove",[{instanceId:this.getId(),fields:e}])}return t},onFormAddressAdd:function(e,t){var i,s;i=e>0&&BX.type.isArray(t)&&t.length>0;if(i){s=this.getState();if(s!=="loaded"&&s!=="fieldsChangeRequest"){i=false}}if(i){BX.onCustomEvent("onCrmRequisiteEditFormAddressAdd",[{instanceId:this.getId(),typeId:e,fields:t}])}return i},onFormAddressRemove:function(e,t){var i,s;i=e>0&&BX.type.isArray(t)&&t.length>0;if(i){s=this.getState();if(s!=="loaded"&&s!=="fieldsChangeRequest"){i=false}}if(i){BX.onCustomEvent("onCrmRequisiteEditFormAddressRemove",[{instanceId:this.getId(),typeId:e,fields:t}])}return i},onFormBankDetailAdd:function(e,t){var i,s;i=(BX.type.isNotEmptyString(e)||BX.type.isNumber(e)&&e>0)&&BX.type.isArray(t)&&t.length>0;if(i){s=this.getState();if(s!=="loaded"&&s!=="fieldsChangeRequest"){i=false}}if(i){BX.onCustomEvent("onCrmRequisiteEditFormBankDetailAdd",[{instanceId:this.getId(),id:e,fields:t}])}return i},onFormBankDetailRemove:function(e,t){var i,s;i=(BX.type.isNotEmptyString(e)||BX.type.isNumber(e)&&e>0)&&BX.type.isArray(t)&&t.length>0;if(i){s=this.getState();if(s!=="loaded"&&s!=="fieldsChangeRequest"){i=false}}if(i){BX.onCustomEvent("onCrmRequisiteEditFormBankDetailRemove",[{instanceId:this.getId(),id:e,fields:t}])}return i},onFormResultSelect:function(e,t){var i;i=false;if(this.getState()==="fieldsChangeRequest"){i=this.setState("loaded")}if(i){BX.onCustomEvent("onCrmRequisiteEditFormResultSelect",[{instanceId:this.getId(),token:e,index:t}])}return i},onFormResultCancel:function(e){var t;t=false;if(this.getState()==="fieldsChangeRequest"){t=this.setState("loaded")}if(t){BX.onCustomEvent("onCrmRequisiteEditFormResultCancel",[{instanceId:this.getId(),token:e}])}return t},onClose:function(){var e,t;e=false;t=this.getState();if(t!=="closed"&&t!=="destoyed"){this.setState("closed");if(this._closeCallback){this._closeCallback(this._id)}e=true}return e}};BX.Crm.RequisiteExternalSearchApplication.items={};BX.Crm.RequisiteExternalSearchApplication.create=function(e,t){var i=new BX.Crm.RequisiteExternalSearchApplication;i.initialize(e,t);BX.Crm.RequisiteExternalSearchApplication.items[i.getId()]=i;return i};BX.Crm.RequisiteExternalSearchApplication.check=function(e){return BX.Crm.RequisiteExternalSearchApplication.items.hasOwnProperty(e)};BX.Crm.RequisiteExternalSearchApplication.get=function(e){if(BX.Crm.RequisiteExternalSearchApplication.items.hasOwnProperty(e)){return BX.Crm.RequisiteExternalSearchApplication.items[e]}return null};BX.Crm.RequisiteExternalSearchApplication.delete=function(e){if(BX.Crm.RequisiteExternalSearchApplication.items.hasOwnProperty(e)){BX.Crm.RequisiteExternalSearchApplication.items[e].destroy();delete BX.Crm.RequisiteExternalSearchApplication.items[e]}}}if(typeof BX.Crm.RequisiteExternalSearchManager==="undefined"){BX.Crm.RequisiteExternalSearchManager=function(){this._clear()};BX.Crm.RequisiteExternalSearchManager.prototype={_clear:function(){this._id="";this._settings={};this._placementInterface=null;this._formContainerId="";this._formContainer=null;this._formSettingManager=null;this._addressEditors=[];this._apps=[];this._subscriptionMap={};if(!this._loadAppHandler){this._loadAppHandler=BX.delegate(this.onLoadApplication,this)}if(!this._closeAppHandler){this._closeAppHandler=BX.delegate(this.onCloseApplication,this)}if(!this._searchResultHandler){this._searchResultHandler=BX.delegate(this.onResultSelect,this)}if(!this._searchResultCancelHandler){this._searchResultCancelHandler=BX.delegate(this.onResultCancel,this)}if(!this._fieldRemoveHandler){this._fieldRemoveHandler=BX.delegate(this.onFormFieldRemove,this)}if(!this._addressAddHandler){this._addressAddHandler=BX.delegate(this.onFormAddressAdd,this)}if(!this._addressRemoveHandler){this._addressRemoveHandler=BX.delegate(this.onFormAddressRemove,this)}if(!this._bankDetailAddHandler){this._bankDetailAddHandler=BX.delegate(this.onFormBankDetailAdd,this)}if(!this._bankDetailRemoveHandler){this._bankDetailRemoveHandler=BX.delegate(this.onFormBankDetailRemove,this)}this._isRequestRunning=false;this._clearRequestContext()},_clearRequestContext:function(){this._requestContext={token:"",fieldId:"",needle:"",appIdList:[],timeout:5e3,timeoutId:null,onSuccessHandler:null,onFailureHandler:null,firstResponseAppId:""}},initialize:function(e,t){var i,s,n,r;if(this._id!==""){this.destroy()}this._id=BX.type.isNotEmptyString(e)?e:"crm_rq_ext_search_"+Math.random().toString().substring(2);this._settings=t?t:{};i=this.getSetting("formId","");if(BX.type.isNotEmptyString(i)){s=i.toLowerCase();this._formContainerId="container_"+s;this._formContainer=BX(this._formContainerId);if(typeof BX.CrmFormSettingManager!=="undefined"&&BX.CrmFormSettingManager.items.hasOwnProperty(s)){this._formSettingManager=BX.CrmFormSettingManager.items[s]}if(typeof BX.CrmMultipleAddressEditor!=="undefined"){this._addressEditors=BX.CrmMultipleAddressEditor.getItemsByFormId(i)}}this._bind();n=this.getSetting("handlers",null);if(BX.type.isArray(n)&&n.length>0){for(r=0;r<n.length;r++){if(BX.type.isPlainObject(n[r])){if(r===0){this.initializeInterface()}this.loadApplication(n[r])}}}},destroy:function(){var e,t;for(e=0;e<this._apps.length;e++){BX.Crm.RequisiteExternalSearchApplication.delete(this._apps[e].getId())}this._unbind();this._clear()},getId:function(){return this._id},getSetting:function(e,t){return BX.prop.get(this._settings,e,t)},setSetting:function(e,t){this._settings[e]=t},_bind:function(){var e;if(this._formSettingManager){BX.addCustomEvent(this._formSettingManager,"CrmFormSettingManagerRemoveField",this._fieldRemoveHandler)}if(BX.type.isArray(this._addressEditors)){for(e=0;e<this._addressEditors.length;e++){BX.addCustomEvent(this._addressEditors[e],"CrmMultipleAddressItemCreated",this._addressAddHandler);BX.addCustomEvent(this._addressEditors[e],"CrmMultipleAddressItemMarkAsDeleted",this._addressRemoveHandler)}}BX.addCustomEvent("CrmFormBankDetailBlockCreate",this._bankDetailAddHandler);BX.addCustomEvent("CrmFormBankDetailBlockRemove",this._bankDetailRemoveHandler)},_unbind:function(){if(this._formSettingManager){BX.removeCustomEvent(this._formSettingManager,"CrmFormSettingManagerRemoveField",this._fieldRemoveHandler)}if(BX.type.isArray(this._addressEditors)){for(i=0;i<this._addressEditors.length;i++){BX.removeCustomEvent(this._addressEditors[i],"CrmMultipleAddressItemCreated",this._addressAddHandler);BX.removeCustomEvent(this._addressEditors[i],"CrmMultipleAddressItemMarkAsDeleted",this._addressRemoveHandler)}}BX.removeCustomEvent("CrmFormBankDetailBlockCreate",this._bankDetailAddHandler);BX.removeCustomEvent("CrmFormBankDetailBlockRemove",this._bankDetailRemoveHandler)},initializeInterface:function(){var e=this;var t=this.getSetting("placementCode","");if(!!BX.rest&&!!BX.rest.AppLayout){this._placementInterface=BX.rest.AppLayout.initializePlacement(t);this._placementInterface.prototype.setReadyState=function(e,t){var i=false;if(BX.type.isPlainObject(e)&&e.hasOwnProperty("instanceId")){var s=e["instanceId"];var n=BX.Crm.RequisiteExternalSearchApplication.get(s);if(n){if(e.hasOwnProperty("maxTimeout")){n.setMaxTimeout(e["maxTimeout"])}i=n.setReadyState()}}if(typeof t==="function"){t(i)}};this._placementInterface.prototype.setSubscription=function(e,t){var i=false;if(BX.type.isPlainObject(e)&&e.hasOwnProperty("instanceId")&&e.hasOwnProperty("fields")&&BX.type.isArray(e["fields"])){var s=BX.Crm.RequisiteExternalSearchApplication.get(e["instanceId"]);if(s){i=s.setSubscription(e["fields"])}}if(typeof t==="function"){t(i)}};this._placementInterface.prototype.getValues=function(e,t){var i=[];if(BX.type.isPlainObject(e)&&e.hasOwnProperty("instanceId")&&e.hasOwnProperty("fields")&&BX.type.isArray(e["fields"])){var s=BX.Crm.RequisiteExternalSearchApplication.get(e["instanceId"]);if(s){i=s.getValues(e["fields"])}}if(typeof t==="function"){t(i)}};this._placementInterface.prototype.setResultReady=function(e,t){var i=false;if(BX.type.isPlainObject(e)&&e.hasOwnProperty("instanceId")&&BX.type.isNotEmptyString(e["instanceId"])&&e.hasOwnProperty("token")&&BX.type.isNotEmptyString(e["token"])){var s=BX.Crm.RequisiteExternalSearchApplication.get(e["instanceId"]);if(s){i=s.setResultReady(e["token"])}}if(typeof t==="function"){t(i)}};this._placementInterface.prototype.setResult=function(e,t){var i=false;if(BX.type.isPlainObject(e)&&e.hasOwnProperty("instanceId")&&BX.type.isNotEmptyString(e["instanceId"])&&e.hasOwnProperty("token")&&BX.type.isNotEmptyString(e["token"])&&e.hasOwnProperty("result")&&BX.type.isArray(e["result"])){var s=BX.Crm.RequisiteExternalSearchApplication.get(e["instanceId"]);if(s){i=s.setResult(e["token"],e["result"])}}if(typeof t==="function"){t(i)}};this._placementInterface.prototype.setClosedState=function(e,t){var i=false;if(BX.type.isPlainObject(e)&&e.hasOwnProperty("instanceId")){var s=BX.Crm.RequisiteExternalSearchApplication.get(e["instanceId"]);if(s){i=s.onClose()}}if(typeof t==="function"){t(i)}};this._placementInterface.prototype.events.push("onCrmRequisiteEditFormFieldMapInit");this._placementInterface.prototype.events.push("onCrmRequisiteEditFormFieldChange");this._placementInterface.prototype.events.push("onCrmRequisiteEditFormFieldRemove");this._placementInterface.prototype.events.push("onCrmRequisiteEditFormAddressAdd");this._placementInterface.prototype.events.push("onCrmRequisiteEditFormAddressRemove");this._placementInterface.prototype.events.push("onCrmRequisiteEditFormApplicationClose");this._placementInterface.prototype.events.push("onCrmRequisiteEditFormBankDetailAdd");this._placementInterface.prototype.events.push("onCrmRequisiteEditFormBankDetailRemove");this._placementInterface.prototype.events.push("onCrmRequisiteEditFormResultSelect");this._placementInterface.prototype.events.push("onCrmRequisiteEditFormResultCancel")}},loadApplication:function(e){var t=BX.Crm.RequisiteExternalSearchApplication.create(null,{containerId:this._formContainerId,entityTypeId:this.getSetting("entityTypeId",0),entityId:this.getSetting("entityId",0),presetId:this.getSetting("presetId",0),countryId:this.getSetting("countryId",0),requisiteId:this.getSetting("requisitePseudoId",0),handler:e,manager:this,loadCallback:this._loadAppHandler,closeCallback:this._closeAppHandler});this._apps.push(t);t.load()},onLoadApplication:function(e){BX.onCustomEvent("onCrmRequisiteEditFormFieldMapInit",[{instanceId:e,fields:this.getSetting("fields",[]),fieldMap:this.getSetting("fieldMap",[])}])},onCloseApplication:function(e){var t,i;this.clearSubscriptionByApplication(e);t=BX.Crm.RequisiteExternalSearchApplication.get(e);if(t){i=this._apps.indexOf(t);if(i>=0){this._apps.splice(i,1)}}},clearSubscriptionByApplication:function(e){var t,i,s;for(t in this._subscriptionMap){if(this._subscriptionMap.hasOwnProperty(t)){s=this._subscriptionMap[t];i=s.indexOf(e);if(i>=0){s.splice(i,1)}if(s.length<=0){this.deleteFieldController(t);this.activateDefaultFieldController(t)}}}},clearSubscriptionByFields:function(e){var t;if(BX.type.isArray(e)){for(t=0;t<e.length;t++){if(this._subscriptionMap.hasOwnProperty(e[t])){delete this._subscriptionMap[e[t]];this.deleteFieldController(e[t]);this.activateDefaultFieldController(e[t])}}}},setSubscription:function(e,t){if(BX.type.isArray(t)&&t.length>0&&BX.Crm.RequisiteExternalSearchApplication.check(e)){var i,s,n,r,a,o,l;r=[];a=[];o=[];for(n in this._subscriptionMap){if(this._subscriptionMap.hasOwnProperty(n)){if(this._subscriptionMap[n].indexOf(e)>=0&&r.indexOf(n)<0){r.push(n)}}}for(i=0;i<r.length;i++){if(t.indexOf(r[i])<0&&o.indexOf(r[i])<0){o.push(r[i])}}for(i=0;i<t.length;i++){if(r.indexOf(t[i])<0&&a.indexOf(t[i])<0){a.push(t[i])}}var d=this.getSetting("fields",[]);if(BX.type.isArray(d)&&d.length>0){for(i=0;i<d.length;i++){n=d[i]["id"];if(a.indexOf(n)>=0){if(d[i]["active"]){if(this._subscriptionMap.hasOwnProperty(n)){if(this._subscriptionMap[n].indexOf(e)<0){this._subscriptionMap[n].push(e)}}else{this._subscriptionMap[n]=[e];this.deactivateDefaultFieldController(n);this.createFieldController(d[i])}}}else if(o.indexOf(n)>=0){l=this._subscriptionMap[n];if(l.indexOf(e)>=0){l.splice(index,1)}if(l.length<=0){this.deleteFieldController(n);this.activateDefaultFieldController(n)}}}}}},getValues:function(e,t){var i,s,n,r;i=[];if(this._formContainer&&BX.type.isArray(t)&&t.length>0){r=this.getSetting("fields",[]);if(BX.type.isArray(r)&&r.length>0){for(s=0;s<r.length;s++){for(n=0;n<t.length;n++){if(r[s]["id"]===t[n]){i.push({fieldId:t[n],value:this.getFieldValue(r[s])})}}}}}return i},checkToken:function(e,t){var i=false;if(!BX.type.isString(t)){t=""}if(BX.type.isNotEmptyString(e)&&this._isRequestRunning&&this._requestContext["token"]===e){if(this._requestContext["firstResponseAppId"]===""||t===""){this._requestContext["firstResponseAppId"]=t}if(this._requestContext["firstResponseAppId"]===t){i=true}}return i},setResultReady:function(e,t){var i,s,n;i=this.checkToken(t,e);return i},setResult:function(e,t,i){var s,n;s=this.checkToken(t,e);if(s){if(this._requestContext["timeoutId"]!==null){window.clearTimeout(this._requestContext["timeoutId"]);this._requestContext["timeoutId"]=null}for(n=0;n<i.length;n++){i[n]["caption"]=i[n]["TITLE"];i[n]["fields"]={fields:i[n]["FIELDS"]};delete i[n]["TITLE"];delete i[n]["FIELDS"]}this._requestContext["onSuccessHandler"]({DATA:{SELECT_PARAMS:{token:t,appId:e},ITEMS:i}})}return s},getSubscribedAppsByFieldId:function(e){var t=[];if(this._subscriptionMap.hasOwnProperty(e)){if(BX.type.isArray(this._subscriptionMap[e])){t=this._subscriptionMap[e]}}return t},getFieldControl:function(e){var t,i,s;t=null;if(BX.type.isPlainObject(e)&&e.hasOwnProperty("id")&&e.hasOwnProperty("formId")&&e.hasOwnProperty("inputType")&&this._formContainer){i="[name="+e["formId"].replace(/([\["':-=/\\\]])/g,"\\$1")+"]";switch(e["inputType"]){case"text":case"checkbox":i="input[type="+e["inputType"]+"]"+i;break;case"textarea":i="textarea"+i;break;default:i=null}if(i){s=this._formContainer.querySelector(i);if(s){t=s}}}return t},activateDefaultFieldController:function(e){var t,i;i=this.getSetting("defaultFieldControllers",[]);if(BX.type.isArray(i)){for(t=0;t<i.length;t++){if(i[t]["fieldId"]===e){if(!i[t]["controller"].isActive()){i[t]["controller"].activate()}}}}},deactivateDefaultFieldController:function(e){var t,i;i=this.getSetting("defaultFieldControllers",[]);if(BX.type.isArray(i)){for(t=0;t<i.length;t++){if(i[t]["fieldId"]===e){if(i[t]["controller"].isActive()){i[t]["controller"].deactivate()}}}}},createFieldController:function(e){var t,i,s;t=false;s=this.getFieldControl(e);if(s){BX.Crm.RequisiteExternalSearchFieldController.create(this.getFieldControllerId(e["id"]),{manager:this,fieldId:e["id"],fieldType:e["dataType"],input:s,callbacks:{onFieldsLoad:this._searchResultHandler,onFieldsLoadCancel:this._searchResultCancelHandler}});t=true}return t},deleteFieldController:function(e){var t;t=this.getFieldControllerId(e);BX.Crm.RequisiteExternalSearchFieldController.delete(t)},getFieldControllerId:function(e){return this._id+"."+e},startSearchRequest:function(e,t,i,s){if(BX.type.isFunction(s)){var n,r,a,o,l,d,u,h,p;n=false;if(!this._isRequestRunning&&BX.type.isFunction(i)){r=this.getSubscribedAppsByFieldId(e);if(r.length>0){n=true;u="bxcrmrqextst"+Math.random().toString().substring(2);this._isRequestRunning=true;this._requestContext["token"]=u;this._requestContext["fieldId"]=e;this._requestContext["needle"]=t;this._requestContext["onSuccessHandler"]=i;this._requestContext["onFailureHandler"]=s;h=0;d=[{fieldId:e,value:t}];for(l=0;l<r.length;l++){o=r[l];this._requestContext["appIdList"].push(o);window.setTimeout(function(e,t,i){return function(){var s=BX.Crm.RequisiteExternalSearchApplication.get(e);if(s){s.onFieldsChange(t,i)}}}(o,u,d));a=BX.Crm.RequisiteExternalSearchApplication.get(o);if(a){p=a.getMaxTimeout();if(p>0&&p>h){h=p}}}if(h>0){this._requestContext["timeout"]=h}this._requestContext["timeoutId"]=window.setTimeout(function(e,t){return function(){e.onRequestTimeout(t)}}(this,u),this._requestContext["timeout"])}}if(!n){s()}}},onRequestTimeout:function(e){var t,i,s;if(this._isRequestRunning&&this.checkToken(e)){this._isRequestRunning=false;i=this._requestContext["appIdList"];for(t=0;t<i.length;t++){s=BX.Crm.RequisiteExternalSearchApplication.get(i[t]);if(s){s.onCancelFieldsChange()}}this._requestContext["onFailureHandler"]();this._clearRequestContext()}},getAddressTypeIndex:function(){var e,t,i,s,n,r;e=[];t=this.getSetting("fields",[]);if(BX.type.isArray(t)){i=new RegExp("^REQUISITE\\.n?\\d+\\.RQ_ADDR\\.(\\d+)\\.\\w+$");for(s=0;s<t.length;s++){n=i.exec(t[s]["id"]);if(n){r=parseInt(n[1]);if(!isNaN(r)&&r>0){if(e.indexOf(r)<0){e.push(r)}}}}}return e},getBankDetailIdIndex:function(){var e,t,i,s,n,r;e=[];i=this.getSetting("fields",[]);if(BX.type.isArray(i)){s=new RegExp("^REQUISITE\\.n?\\d+\\.BANK_DETAILS\\.(n?\\d+)\\.\\w+$");for(t=0;t<i.length;t++){n=s.exec(i[t]["id"]);if(n){r=parseInt(n[1]);if(isNaN(r)||r<0){r=n[1]}if(e.indexOf(r)<0){e.push(r)}}}}return e},addBlocksAsNeeded:function(e,t,i){var s,n,r,a,o,l,d,u,h;d=this.getAddressTypeIndex();u=this.getBankDetailIdIndex();if(BX.type.isArray(i)){for(s=0;s<i.length;s++){if(i[s].hasOwnProperty("id")&&BX.type.isArray(i[s]["value"])){if(i[s]["id"]==="RQ_ADDR"){a=i[s]["value"];for(n=0;n<a.length;n++){o=a[n];for(r=0;r<o.length;r++){if(o[r].hasOwnProperty("id")&&o[r].hasOwnProperty("value")&&o[r]["id"]==="TYPE_ID"){l=parseInt(o[r]["value"]);if(!isNaN(l)&&l>0&&d.indexOf(l)<0){if(this.addAddress(e,t,l)){d.push(l)}}break}}}}else if(i[s]["id"]==="BANK_DETAILS"){a=i[s]["value"];if(a.length>u.length){for(n=u.length;n<a.length;n++){h=this.addBankDetail(e,t);if(BX.type.isNumber(h)&&h>0||BX.type.isNotEmptyString(h)){u.push(h)}}}}}}}return{addressTypeIndex:d,bankDetailIdIndex:u}},onResultSelect:function(e,t){var i,s,n,r,a,o,l,d,u,h,p,c,f,m,g,_;if(this._isRequestRunning&&BX.type.isPlainObject(e)&&e.hasOwnProperty("fields")&&BX.type.isArray(e["fields"])&&e["fields"].length>0&&BX.type.isPlainObject(t)&&t.hasOwnProperty("appId")&&t.hasOwnProperty("token")&&t.hasOwnProperty("index")&&this.checkToken(t["token"],t["appId"])){i=e["fields"];s=this.addBlocksAsNeeded(t["token"],t["appId"],i);if(BX.type.isPlainObject(s)&&s.hasOwnProperty("addressTypeIndex")&&BX.type.isArray(s["addressTypeIndex"])&&s.hasOwnProperty("bankDetailIdIndex")&&BX.type.isArray(s["bankDetailIdIndex"])){c=s["addressTypeIndex"];f=s["bankDetailIdIndex"];o=this.getSetting("requisitePseudoId",0);if(BX.type.isNumber(o)&&o>0||BX.type.isNotEmptyString(o)){l=[];d=[];for(n=0;n<i.length;n++){if(i[n].hasOwnProperty("id")&&BX.type.isArray(i[n]["value"])){if(i[n]["id"]==="RQ_ADDR"){u=i[n]["value"];for(r=0;r<u.length;r++){p=0;h=u[r];for(a=0;a<h.length;a++){if(h[a].hasOwnProperty("id")&&h[a].hasOwnProperty("value")){if(h[a]["id"]==="TYPE_ID"){p=parseInt(h[a]["value"]);break}}}if(!isNaN(p)&&p>0&&c.indexOf(p)>=0){for(a=0;a<h.length;a++){if(h[a].hasOwnProperty("id")&&h[a].hasOwnProperty("value")){if(h[a]["id"]!=="TYPE_ID"){l.push("REQUISITE."+o+".RQ_ADDR."+p+"."+h[a]["id"]);d.push(h[a]["value"])}}}}}}else if(i[n]["id"]==="BANK_DETAILS"){u=i[n]["value"];for(r=0;r<u.length;r++){if(f.hasOwnProperty(r)){m=f[r];h=u[r];for(a=0;a<h.length;a++){if(h[a].hasOwnProperty("id")&&h[a].hasOwnProperty("value")){l.push("REQUISITE."+o+".BANK_DETAILS."+m+"."+h[a]["id"]);d.push(h[a]["value"])}}}}}}else{l.push("REQUISITE."+o+"."+i[n]["id"]);d.push(i[n]["value"])}}}}g=this.getSetting("fields",[]);if(BX.type.isArray(g)&&g.length>0){for(n=0;n<g.length;n++){for(r=0;r<l.length;r++){if(g[n]["id"]===l[r]&&g[n]["changeable"]){this.setFieldValue(g[n],d[r])}}}}_=BX.Crm.RequisiteExternalSearchApplication.get(t["appId"]);if(_){_.onFormResultSelect(t["token"],t["index"])}this._isRequestRunning=false;this._clearRequestContext()}},onResultCancel:function(e,t){if(this._isRequestRunning&&BX.type.isPlainObject(t)&&t.hasOwnProperty("appId")&&t.hasOwnProperty("token")&&this.checkToken(t["token"],t["appId"])){app=BX.Crm.RequisiteExternalSearchApplication.get(t["appId"]);if(app){app.onFormResultCancel(t["token"])}this._isRequestRunning=false;this._clearRequestContext()}},getFieldValue:function(e){var t,i;switch(e["inputType"]){case"text":case"textarea":t="";break;case"checkbox":t=false;break;default:t=null}i=this.getFieldControl(e);if(i){switch(e["inputType"]){case"text":case"textarea":t=i.value;break;case"checkbox":t=i.checked;break;default:}}return t},setFieldValue:function(e,t){var i;i=this.getFieldControl(e);if(i){switch(e["inputType"]){case"text":case"textarea":i.value=t;break;case"checkbox":i.checked=!!t;break;default:}}},getFieldSettingsById:function(e){var t=null;var i,s;i=this.getSetting("fields",[]);if(BX.type.isArray(i)&&i.length>0){for(s=0;s<i.length;s++){if(i[s]["id"]===e){t=i[s];break}}}return t},getFieldSettingsByFormId:function(e){var t=null;var i,s;i=this.getSetting("fields",[]);if(BX.type.isArray(i)&&i.length>0){for(s=0;s<i.length;s++){if(i[s]["formId"]===e){t=i[s];break}}}return t},filterExistingFields:function(e){var t,i,s,n;t=[];if(BX.type.isArray(e)){i={};s=this.getSetting("fields",[]);if(BX.type.isArray(s)){for(n=0;n<s.length;n++){if(!i.hasOwnProperty(s[n]["id"])){i[s[n]["id"]]=true}}}for(n=0;n<e.length;n++){if(BX.type.isPlainObject(e[n])&&e[n].hasOwnProperty("id")&&!i.hasOwnProperty(e[n]["id"])){t.push(e[n])}}}return t},getFieldsByIdPrefix:function(e){var t,s;t=[];s=this.getSetting("fields",[]);if(BX.type.isArray(s)){for(i=0;i<s.length;i++){if(s[i]["id"].length>e.length&&s[i]["id"].substr(0,e.length)===e){t.push(s[i]["id"])}}}return t},appendFields:function(e){var t;if(BX.type.isArray(e)&&e.length>0){t=this.getSetting("fields",[]);if(BX.type.isArray(t)){this.setSetting("fields",t.concat(e))}}},removeFields:function(e){var t,i;if(BX.type.isArray(e)&&e.length>0){t=this.getSetting("fields",[]);if(BX.type.isArray(t)){for(i=0;i<t.length;i++){if(e.indexOf(t[i]["id"])>=0){t.splice(i--,1)}}}}},addAddress:function(e,t,s){var n;n=this.checkToken(e,t);if(n){if(!BX.type.isNumber(s)){s=parseInt(s)}if(!isNaN(s)&&s>0){if(BX.type.isArray(this._addressEditors)){for(i=0;i<this._addressEditors.length;i++){n=!!this._addressEditors[i].createItem(s,this.getSetting("addressOriginatorId",""),true);if(!n){break}}}}}return n},removeAddress:function(e,t,s){var n,r;n=this.checkToken(e,t);if(n){if(!BX.type.isNumber(s)){s=parseInt(s)}if(!isNaN(s)&&s>0){if(BX.type.isArray(this._addressEditors)){for(i=0;i<this._addressEditors.length;i++){r=this._addressEditors[i].getItemByTypeId(s);if(r){r.markAsDeleted();n=this._addressEditors[i].removeItem(r)}if(!n){break}}}}}return n},addBankDetail:function(e,t){var i,s,n;i=0;if(this.checkToken(e,t)){s=this.getSetting("bankDetailAreaId","");if(BX.type.isNotEmptyString(s)&&typeof BX.Crm.RequisiteBankDetailsArea!=="undefined"&&BX.Crm.RequisiteBankDetailsArea.items&&BX.Crm.RequisiteBankDetailsArea.items.hasOwnProperty(s)){n=BX.Crm.RequisiteBankDetailsArea.items[s];i=n.addBlock()}}return i},removeBankDetail:function(e,t,i){var s,n,r,a;s=false;if(this.checkToken(e,t)&&(BX.type.isNumber(i)&&i>0||BX.type.isNotEmptyString(i))){n=this.getSetting("bankDetailAreaId","");if(BX.type.isNotEmptyString(n)&&typeof BX.Crm.RequisiteBankDetailsArea!=="undefined"&&BX.Crm.RequisiteBankDetailsArea.items&&BX.Crm.RequisiteBankDetailsArea.items.hasOwnProperty(n)){r=BX.Crm.RequisiteBankDetailsArea.items[n];a=r.getBlockByPseudoId(i);if(a){a.markAsDeleted();s=true}}}return s},onFormFieldRemove:function(e){var t,i;t=this.getFieldSettingsByFormId(e);if(t){this.clearSubscriptionByFields([t["id"]]);for(i=0;i<this._apps.length;i++){this._apps[i].onFieldsRemove([t["id"]])}}},onFormAddressAdd:function(e,t){var i,s,n,r;r=[];if(e!==null&&t!==null&&typeof e==="object"&&typeof t==="object"){i=parseInt(t.getTypeId());if(i>0){s=e.getScheme();if(BX.type.isArray(s)){for(n=0;n<s.length;n++){if(s[n]["type"]==="text"||s[n]["type"]==="multilinetext"){r.push({id:"REQUISITE."+this.getSetting("requisitePseudoId","n0")+".RQ_ADDR."+i+"."+s[n]["name"],formId:e.prepareQualifiedName(s[n]["name"],{typeId:i}),name:e.getFieldLabel(s[n]["name"]),inputType:s[n]["type"]==="multilinetext"?"textarea":"text",dataType:"string",active:true,changeable:true})}}r=this.filterExistingFields(r);this.appendFields(r);for(n=0;n<this._apps.length;n++){this._apps[n].onFormAddressAdd(i,r)}}}}},onFormAddressRemove:function(e,t){var i,s,n,r,a;if(e!==null&&t!==null&&typeof e==="object"&&typeof t==="object"){i=parseInt(t.getTypeId());if(i>0){a="REQUISITE."+this.getSetting("requisitePseudoId","n0")+".RQ_ADDR."+i+".";r=this.getFieldsByIdPrefix(a);this.clearSubscriptionByFields(r);this.removeFields(r);for(n=0;n<this._apps.length;n++){this._apps[n].onFormAddressRemove(i,r)}}}},onFormBankDetailAdd:function(e){var t,i,s,n;if(BX.type.isPlainObject(e)&&e.hasOwnProperty("bankDetailBlock")&&e["bankDetailBlock"]!==null&&typeof e["bankDetailBlock"]==="object"&&e.hasOwnProperty("formId")&&BX.type.isNotEmptyString(e["formId"])&&e.hasOwnProperty("bankDetailPseudoId")&&(BX.type.isNotEmptyString(e["bankDetailPseudoId"])||BX.type.isNumber(e["bankDetailPseudoId"])&&e["bankDetailPseudoId"]>0)&&e["formId"]===this.getSetting("formId","")){t=e["bankDetailBlock"];i=e["bankDetailBlock"].getFieldList();if(BX.type.isArray(i)){s=[];for(n=0;n<i.length;n++){if(i[n]["type"]==="text"||i[n]["type"]==="textarea"){s.push({id:"REQUISITE."+this.getSetting("requisitePseudoId","n0")+".BANK_DETAILS."+e["bankDetailPseudoId"]+"."+i[n]["name"],formId:t.resolveFieldInputName(i[n]["name"]),name:i[n]["title"],inputType:i[n]["type"],dataType:"string",active:i[n]["name"]!=="NAME",changeable:true})}}s=this.filterExistingFields(s);this.appendFields(s);for(n=0;n<this._apps.length;n++){this._apps[n].onFormBankDetailAdd(e["bankDetailPseudoId"],s)}}}},onFormBankDetailRemove:function(e){var t,i,s,n,r;if(e!==null&&typeof e==="object"){t=e.getPseudoId();if(BX.type.isNotEmptyString(t)||BX.type.isNumber(t)&&t>0){r="REQUISITE."+this.getSetting("requisitePseudoId","n0")+".BANK_DETAILS."+t+".";n=this.getFieldsByIdPrefix(r);this.clearSubscriptionByFields(n);this.removeFields(n);for(s=0;s<this._apps.length;s++){this._apps[s].onFormBankDetailRemove(t,n)}}}}};BX.Crm.RequisiteExternalSearchManager.items={};BX.Crm.RequisiteExternalSearchManager.create=function(e,t){var i=new BX.Crm.RequisiteExternalSearchManager;i.initialize(e,t);BX.Crm.RequisiteExternalSearchManager.items[i.getId()]=i;return i};BX.Crm.RequisiteExternalSearchManager.delete=function(e){if(BX.Crm.RequisiteExternalSearchManager.items.hasOwnProperty(e)){BX.Crm.RequisiteExternalSearchManager.items[e].destroy();delete BX.Crm.RequisiteExternalSearchManager.items[e]}}}if(typeof BX.Crm.RequisiteExternalSearchFieldController==="undefined"){BX.Crm.RequisiteExternalSearchFieldController=function(){BX.Crm.RequisiteExternalSearchFieldController.superclass.constructor.apply(this);this._manager=null;this._onSearchSuccessHandler=BX.delegate(this.onSearchRequestSuccess,this);this._onSearchFailureHandler=BX.delegate(this.onRequestFailure,this);this._onChangeHandler=BX.delegate(this.onChange,this)};BX.extend(BX.Crm.RequisiteExternalSearchFieldController,BX.Crm.RequisiteFieldController);BX.Crm.RequisiteExternalSearchFieldController.prototype.initialize=function(e,t){this._id=BX.type.isNotEmptyString(e)?e:"crm_rq_ext_search_fld_cntrlr"+Math.random().toString().substring(2);this._settings=t?t:{};this._countryId=this.getSetting("countryId",0);this._typeId=BX.Crm.RequisiteFieldType.undefined;this._manager=this.getSetting("manager",null);if(!(this._manager instanceof BX.Crm.RequisiteExternalSearchManager)){throw"BX.Crm.RequisiteExternalSearchFieldController: Could not fild 'manager' parameter in settings."}this._fieldId=this.getSetting("fieldId",null);if(!BX.type.isNotEmptyString(this._fieldId)){throw"BX.Crm.RequisiteExternalSearchFieldController: Could not fild 'fieldId' parameter in settings."}this._fieldType=this.getSetting("fieldType","string");this._serviceUrl="";this._input=this.getSetting("input");if(!BX.type.isElementNode(this._input)){throw"BX.Crm.RequisiteExternalSearchFieldController: Could not fild 'input' parameter in settings."}this.activate()};BX.Crm.RequisiteExternalSearchFieldController.prototype.bindHandlers=function(){BX.Crm.RequisiteExternalSearchFieldController.superclass.bindHandlers.apply(this);if((this._fieldType==="datetime"||this._fieldType==="boolean")&&BX.type.isFunction(this._onChangeHandler)){BX.bind(this._input,"change",this._onChangeHandler)}};BX.Crm.RequisiteExternalSearchFieldController.prototype.unbindHandlers=function(){BX.Crm.RequisiteExternalSearchFieldController.superclass.unbindHandlers.apply(this);if((this._fieldType==="datetime"||this._fieldType==="boolean")&&BX.type.isFunction(this._onChangeHandler)){BX.unbind(this._input,"change",this._onChangeHandler)}};BX.Crm.RequisiteExternalSearchFieldController.prototype.onChange=function(e){if(!this._isActive){return}e=e||window.event;if(this._fieldType==="boolean"){if(this._value===this._input.checked){return}this._value=this._input.checked}else{if(this._value===this._input.value){return}this._value=this._input.value}if(this._timeoutId>0){window.clearTimeout(this._timeoutId);this._timeoutId=0}this._timeoutId=window.setTimeout(this._timeoutHandler,1e3)};BX.Crm.RequisiteExternalSearchFieldController.prototype.validate=function(){var e;e=false;this._needle=this._value;switch(this._fieldType){case"boolean":e=BX.type.isBoolean(this._needle);break;default:e=BX.type.isNotEmptyString(this._needle)}return e};BX.Crm.RequisiteExternalSearchFieldController.prototype.startSearchRequest=function(){if(!this._isActive||this._isRequestRunning){return}this._isRequestRunning=true;this.showLoader();this._manager.startSearchRequest(this._fieldId,this._needle,this._onSearchSuccessHandler,this._onSearchFailureHandler)};BX.Crm.RequisiteExternalSearchFieldController.items={};BX.Crm.RequisiteExternalSearchFieldController.create=function(e,t){var i=new BX.Crm.RequisiteExternalSearchFieldController;i.initialize(e,t);BX.Crm.RequisiteExternalSearchFieldController.items[i.getId()]=i;return i};BX.Crm.RequisiteExternalSearchFieldController.check=function(e){return BX.Crm.RequisiteExternalSearchFieldController.items.hasOwnProperty(e)};BX.Crm.RequisiteExternalSearchFieldController.get=function(e){if(BX.Crm.RequisiteExternalSearchFieldController.check(e)){return BX.Crm.RequisiteExternalSearchFieldController.items[e]}return null};BX.Crm.RequisiteExternalSearchFieldController.delete=function(e){if(BX.Crm.RequisiteExternalSearchFieldController.items.hasOwnProperty(e)){BX.Crm.RequisiteExternalSearchFieldController.items[e].destroy();delete BX.Crm.RequisiteExternalSearchFieldController.items[e]}}}
//# sourceMappingURL=requisite.map.js