BX.namespace("BX.Crm");if(typeof BX.Crm.BatchConversionManager==="undefined"){BX.Crm.BatchConversionManager=function(){this._id="";this._settings={};this._gridId="";this._config=null;this._entityIds=null;this._enableUserFieldCheck=true;this._enableConfigCheck=true;this._filter=null;this._serviceUrl="";this._containerId="";this._errors=null;this._progress=null;this._hasLayout=false;this._succeededItemCount=0;this._failedItemCount=0;this._isRunning=false;this._messages=null;this._loadExtensionsPromise=null;this._progressChangeHandler=BX.delegate(this.onProgress,this);this._documentUnloadHandler=BX.delegate(this.onDocumentUnload,this)};BX.Crm.BatchConversionManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"crm_batch_conversion_mgr_"+Math.random().toString().substring(2);this._settings=e?e:{};this._gridId=BX.prop.getString(this._settings,"gridId",this._id);this._config=BX.prop.getObject(this._settings,"config",{});this._entityIds=BX.prop.getArray(this._settings,"entityIds",[]);this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");if(this._serviceUrl===""){throw"BX.Crm.BatchConversionManager. Could not find 'serviceUrl' parameter in settings."}this._containerId=BX.prop.getString(this._settings,"container","");if(this._containerId===""){throw"BX.Crm.BatchConversionManager: Could not find container."}this._progress=BX.AutorunProcessManager.create(this._id,{serviceUrl:this._serviceUrl,actionName:"PROCESS_BATCH_CONVERSION",container:this._containerId,enableCancellation:true,title:this.getMessage("title"),stateTemplate:BX.prop.getString(this._settings,"stateTemplate","#processed# / #total#"),enableLayout:false});this._errors=[];this._loadExtensionsPromise=BX.Runtime.loadExtension("crm.integration.analytics","ui.analytics").catch((t=>{console.error("Could not load analytics extensions",t);throw t}))},getId:function(){return this._id},getConfig:function(){return this._config},setConfig:function(t){this._config=BX.type.isPlainObject(t)?t:{}},getEntityIds:function(){return this._entityIds},setEntityIds:function(t){this._entityIds=BX.type.isArray(t)?t:[]},getFilter:function(){return this._filter},setFilter:function(t){this._filter=BX.type.isPlainObject(t)?t:null},isUserFieldCheckEnabled:function(){return this._enableUserFieldCheck},enableUserFieldCheck:function(t){this._enableUserFieldCheck=t},isConfigCheckEnabled:function(){return this._enableConfigCheck},enableConfigCheck:function(t){this._enableConfigCheck=t},getMessage:function(t){if(this._messages&&BX.prop.getString(this._messages,t,null)){return BX.prop.getString(this._messages,t,t)}var e=BX.prop.getObject(this._settings,"messages",BX.Crm.BatchConversionManager.messages);return BX.prop.getString(e,t,t)},layout:function(){if(this._hasLayout){return}this._progress.layout();this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}this._progress.clearLayout();this._hasLayout=false},getState:function(){return this._progress.getState()},getProcessedItemCount:function(){return this._progress.getProcessedItemCount()},getTotalItemCount:function(){return this._progress.getTotalItemCount()},execute:function(){var t={GRID_ID:this._gridId,CONFIG:this._config,ENABLE_CONFIG_CHECK:this._enableConfigCheck?"Y":"N",ENABLE_USER_FIELD_CHECK:this._enableUserFieldCheck?"Y":"N"};if(this._filter!==null){t["FILTER"]=this._filter}else{t["IDS"]=this._entityIds}var e={ACTION:"PREPARE_BATCH_CONVERSION",PARAMS:t,sessid:BX.bitrix_sessid()};this.sendAnalyticsData("attempt");BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:e,onsuccess:BX.delegate(this.onPrepare,this)})},sendAnalyticsData(t){if(!BX.CrmEntityType.isDefined(this._settings.entityTypeId)){return}this._loadExtensionsPromise.then((e=>{Object.keys(this._config).forEach((s=>{if(this._config[s].active==="Y"){const i=e.Builder.Entity.ConvertBatchEvent.createDefault(this._settings.entityTypeId,BX.CrmEntityType.resolveId(s));if(BX.Type.isPlainObject(this._settings.analytics)){if(BX.Type.isStringFilled(this._settings.analytics.c_section)){i.setSection(this._settings.analytics.c_section)}if(BX.Type.isStringFilled(this._settings.analytics.c_sub_section)){i.setSubSection(this._settings.analytics.c_sub_section)}if(BX.Type.isStringFilled(this._settings.analytics.c_element)){i.setElement(this._settings.analytics.c_element)}}i.setStatus(t);e.sendData(i.buildData())}}))}))},onPrepare:function(t){var e=t["DATA"];var s=BX.prop.getString(e,"STATUS","");this._config=BX.prop.getObject(e,"CONFIG",{});if(e.hasOwnProperty("messages")&&BX.Type.isPlainObject(e.messages)){this._messages=e.messages;if(!BX.CrmLeadConverter.messages){BX.CrmLeadConverter.messages={}}BX.CrmLeadConverter.messages=Object.assign(BX.CrmLeadConverter.messages,e.messages)}if(s==="ERROR"){this.sendAnalyticsData("error");var i=BX.prop.getArray(e,"ERRORS",[]);var n=BX.Crm.NotificationDialog.create("batch_conversion_error",{title:this.getMessage("title"),content:i.join("<br/>")});n.open();return}if(s==="REQUIRES_SYNCHRONIZATION"){var r=BX.CrmLeadConverter.getCurrent().createSynchronizationEditor(this._id,this._config,BX.prop.getArray(e,"FIELD_NAMES",[]));r.addClosingListener(BX.delegate(this.onSynchronizationEditorClose,this));r.show();return}this.layout();this.run()},run:function(){if(this._isRunning){return}this._isRunning=true;this._progress.setParams({GRID_ID:this._gridId,CONFIG:this._config});this._progress.run();BX.addCustomEvent(this._progress,"ON_AUTORUN_PROCESS_STATE_CHANGE",this._progressChangeHandler);BX.bind(window,"beforeunload",this._documentUnloadHandler)},stop:function(){if(!this._isRunning){return}this._isRunning=false;this.sendAnalyticsData("cancel");BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:{ACTION:"STOP_BATCH_CONVERSION",PARAMS:{GRID_ID:this._gridId}},onsuccess:BX.delegate(this.onStop,this)})},onStop:function(t){this.reset();window.setTimeout(function(){BX.onCustomEvent(window,"BX.Crm.BatchConversionManager:onStop",[this])}.bind(this),300)},reset:function(){this._progress.reset();BX.removeCustomEvent(this._progress,"ON_AUTORUN_PROCESS_STATE_CHANGE",this._progressChangeHandler);BX.unbind(window,"beforeunload",this._documentUnloadHandler);if((this._succeededItemCount>0||this._failedItemCount>0)&&BX.getClass("BX.Main.gridManager")){BX.Main.gridManager.reload(this._gridId)}this._succeededItemCount=this._failedItemCount=0;this._isRunning=false;if(this._hasLayout){window.setTimeout(BX.delegate(this.clearLayout,this),100)}this._errors=[]},getSucceededItemCount:function(){return this._succeededItemCount},getFailedItemCount:function(){return this._failedItemCount},getErrors:function(){return this._errors},onDocumentUnload:function(t){return t.returnValue=this.getMessage("windowCloseConfirm")},onSynchronizationEditorClose:function(t,e){if(BX.prop.getBoolean(e,"isCanceled",false)){this.sendAnalyticsData("cancel");this.clearLayout();return}this._config=t.getConfig();this.run()},onProgress:function(t){var e=this._progress.getState();if(e===BX.AutoRunProcessState.stopped){this.stop();return}var s=this._progress.getErrors();if(s.length===0){this._succeededItemCount++}else{if(!this._errors){this._errors=s}else{this._errors=this._errors.concat(s)}this._failedItemCount++;this.sendAnalyticsData("error")}if(e===BX.AutoRunProcessState.completed){this.sendAnalyticsData("success");BX.Crm.ProcessSummaryPanel.create(this._id,{container:this._containerId,data:{succeededCount:this.getSucceededItemCount(),failedCount:this.getFailedItemCount(),errors:this.getErrors()},messages:BX.prop.getObject(this._settings,"messages",null),numberSubstitution:"#number_leads#"}).layout();this.reset();window.setTimeout(function(){BX.onCustomEvent(window,"BX.Crm.BatchConversionManager:onProcessComplete",[this])}.bind(this),300)}}};if(typeof BX.Crm.BatchConversionManager.messages==="undefined"){BX.Crm.BatchConversionManager.messages={}}BX.Crm.BatchConversionManager.items={};BX.Crm.BatchConversionManager.getItem=function(t){return BX.prop.get(this.items,t,null)};BX.Crm.BatchConversionManager.create=function(t,e){var s=new BX.Crm.BatchConversionManager;s.initialize(t,e);this.items[s.getId()]=s;return s}}
//# sourceMappingURL=batch_conversion.map.js