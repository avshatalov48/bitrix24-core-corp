{"version":3,"file":"channel-selector.bundle.js","sources":["../src/channel-selector.js"],"sourcesContent":["import { Router } from 'crm.router';\nimport { Dom, Loc, Reflection, Tag, Text, Type } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { Loader } from 'main.loader';\nimport { Menu, MenuItem, MenuManager } from 'main.popup';\nimport 'ui.icons.service';\nimport { Menu as MenuConfigurable } from 'ui.menu-configurable';\nimport 'ui.notification';\n\nconst CrmActivityEditor = Reflection.namespace('BX.CrmActivityEditor');\nconst UserOptions = Reflection.namespace('BX.userOptions');\nconst NotificationCenter = Reflection.namespace('BX.UI.Notification.Center');\n\nconst CHANNEL_TYPE_PHONE = 'PHONE';\nconst CHANNEL_TYPE_EMAIL = 'EMAIL';\nconst CHANNEL_TYPE_IM = 'IM';\n\nconst MAX_VISIBLE_ITEMS = 4;\nconst MARKET_LINK = 'category/crm_robot_sms/';\n\nconst LINK_IN_MESSAGE_PLACEHOLDER = '#LINK#';\n\nexport type ChannelSelectorParameters = {\n\tid: ?string,\n\ttitle: ?string,\n\tdocumentTitle: ?string,\n\tbody: ?string,\n\tfullBody?: string,\n\tentityTypeId: number,\n\tentityId: number,\n\tchannels: Array<ChannelData>,\n\tcommunications: Object<string, CommunicationData>,\n\tlink: ?string,\n\tisLinkObtainable: boolean,\n\tfiles: Array<number>,\n\tstorageTypeId: ?number,\n\tactivityEditorId: ?string,\n\tsmsUrl: ?string,\n\tisCombineMessageWithLink?: boolean,\n\tisInsertLinkInMessage?: boolean,\n\thasVisibleChannels: boolean,\n\tchannelIcons: Array<string>,\n\tcontactCenterUrl: ?string,\n\ttemplateCode?: string,\n};\n\nexport type ChannelData = {\n\tid: string,\n\ttitle: string,\n\ttype: string,\n\tisAvailable: boolean,\n\tisHidden: ?boolean,\n\ticon: ?string,\n\ttemplateCode?: string,\n\ttemplatePlaceholders?: Object<string, string>,\n\tcategoryTitle?: string,\n}\n\nexport type CommunicationData = {\n\tENTITY_ID: string,\n\tELEMENT_ID: number,\n\tTYPE_ID: string,\n\tVALUE: string,\n};\n\nconst items = new Map();\n\n/**\n * @memberof BX.Crm.ChannelSelector\n */\nexport class List extends EventEmitter\n{\n\tlayout: {\n\t\tcontainer: HTMLElement,\n\t\tlist: HTMLElement,\n\t\ttitle: HTMLElement,\n\t\tsettings: HTMLElement,\n\t\tfooter: HTMLElement,\n\t\tlink: ?HTMLElement,\n\t\tchannels: Object<string,HTMLElement>,\n\t};\n\n\ttitle: string;\n\tdocumentTitle: string;\n\tbody: string;\n\tfullBody: string;\n\t#link: string;\n\tisLinkObtainable: boolean;\n\tentityTypeId: number;\n\tentityId: number;\n\tchannels: Array<ChannelData>;\n\tfiles: Array<number>;\n\tstorageTypeId: number;\n\tactivityEditorId: string;\n\tsmsUrl: string;\n\tisCombineMessageWithLink: boolean = true;\n\t#isInsertLinkInMessage: boolean = false;\n\tcommunications: Object<string, CommunicationData>;\n\t#loader: ?Loader;\n\t#getLinkPromise: ?Promise;\n\t#menu: Menu;\n\t#menuConfigurable: MenuConfigurable;\n\n\tconstructor(parameters: ChannelSelectorParameters)\n\t{\n\t\tsuper();\n\t\tthis.title = Type.isStringFilled(parameters.title) ? parameters.title : Loc.getMessage('CRM_CHANNEL_SELECTOR_DEFAULT_TITLE');\n\t\tthis.documentTitle = String(parameters.documentTitle);\n\t\tthis.body = String(parameters.body);\n\t\tthis.fullBody = String(parameters.fullBody);\n\t\tthis.#link = String(parameters.link);\n\t\tthis.isLinkObtainable = Text.toBoolean(parameters.isLinkObtainable);\n\t\tthis.entityTypeId = Text.toInteger(parameters.entityTypeId);\n\t\tthis.entityId = Text.toInteger(parameters.entityId);\n\t\tthis.id = Type.isStringFilled(parameters.id) ? parameters.id : this.entityTypeId + '_' + this.entityId + '_' + Math.random().toString().substring(2)\n\t\tthis.storageTypeId = Text.toInteger(parameters.storageTypeId);\n\t\tthis.files = Type.isArray(parameters.files) ? parameters.files : [];\n\t\tthis.activityEditorId = String(parameters.activityEditorId);\n\t\tthis.smsUrl = String(parameters.smsUrl);\n\t\tthis.isCombineMessageWithLink = Type.isBoolean(parameters.isCombineMessageWithLink) ? parameters.isCombineMessageWithLink : true;\n\t\tthis.#isInsertLinkInMessage = Type.isBoolean(parameters.isInsertLinkInMessage) ? parameters.isInsertLinkInMessage : false;\n\t\tthis.templateCode = parameters.templateCode ?? null;\n\t\tthis.setChannels(parameters.channels);\n\t\tthis.communications = Type.isPlainObject(parameters.communications) ? parameters.communications : {};\n\t\tthis.hasVisibleChannels = Text.toBoolean(parameters.hasVisibleChannels);\n\t\tthis.channelIcons = Type.isArray(parameters.channelIcons) ? parameters.channelIcons : [];\n\t\tthis.contactCenterUrl = Type.isStringFilled(parameters.contactCenterUrl) ? parameters.contactCenterUrl : '/contact_center/';\n\t\tthis.layout = {\n\t\t\tchannels: {},\n\t\t};\n\t\tthis.setEventNamespace('BX.Crm.ChannelSelector.List');\n\n\t\tif (items.size === 0)\n\t\t{\n\t\t\titems.set('default', this);\n\t\t}\n\t\titems.set(this.id, this);\n\t}\n\n\tsetChannels(channels: Array<ChannelData>)\n\t{\n\t\tthis.channels = [];\n\t\tif (Type.isArray(channels))\n\t\t{\n\t\t\tchannels.forEach((channel: ChannelData) => {\n\t\t\t\tthis.channels.push(channel);\n\t\t\t});\n\t\t}\n\n\t\treturn this;\n\t}\n\n\trender(): HTMLElement\n\t{\n\t\tif (this.layout.container)\n\t\t{\n\t\t\treturn this.layout.container;\n\t\t}\n\t\tthis.layout.title = Tag.render`<div class=\"crm__channel-selector--title\">${Text.encode(this.title)}</div>`;\n\t\tif (this.#link || this.isLinkObtainable)\n\t\t{\n\t\t\tthis.layout.link = Tag.render`<input type=\"text\" class=\"crm__channel-selector--footer-link-hidden\" value=\"${Text.encode(this.#link)}\" />`\n\t\t\t// class=\"crm__channel-selector--footer --disabled\"\n\t\t\tthis.layout.footer = Tag.render`<div class=\"crm__channel-selector--footer\" onclick=\"${this.#handleFooterClick.bind(this)}\">\n\t\t\t\t<div class=\"crm__channel-selector--footer-copy-link\">\n\t\t\t\t\t<span class=\"crm__channel-selector--footer-text\">${Loc.getMessage('CRM_CHANNEL_FOOTER_TITLE')}</span>\n\t\t\t\t\t${this.layout.link}\n\t\t\t\t</div>\n\t\t\t</div>`\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.layout.footer = null;\n\t\t}\n\n\t\tthis.layout.settings = null;\n\t\tif (this.hasVisibleChannels)\n\t\t{\n\t\t\tthis.layout.settings = Tag.render`<button class=\"ui-btn ui-btn-xs ui-btn-link ui-btn-icon-setting crm__channel-selector--setting-btn\" onclick=\"${this.#handleSettingsClick.bind(this)}\"></button>`;\n\t\t\tthis.layout.list = Tag.render`<div class=\"crm__channel-selector--list\"></div>`;\n\n\t\t\tthis.channels.forEach((channel: ChannelData) => {\n\t\t\t\tconst channelNode = this.renderChannel(channel);\n\t\t\t\tif (channelNode)\n\t\t\t\t{\n\t\t\t\t\tthis.layout.channels[channel.id] = channelNode;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.layout.list = Tag.render`<div class=\"crm__channel-selector--body\">\n\t\t\t<div class=\"crm__channel-selector--networks\">\n\t\t\t\t<div class=\"crm__channel-selector--networks-title\">${Loc.getMessage('CRM_CHANNEL_SELECTOR_NO_ACTIVE_CHANNELS_TEXT')}</div>\n\t\t\t\t<div class=\"crm__channel-selector--networks-block\">\n\t\t\t\t\t${this.channelIcons.map(icon => Tag.render`<span class=\"crm__channel-selector--network-link --${icon}\" onclick=\"${this.#openContactCenter.bind(this)}\"></span>`)}\n\t\t\t\t\t<span class=\"crm__channel-selector--network-link --link\" onclick=\"${this.#openContactCenter.bind(this)}\">+ 15</span>\n\t\t\t\t</div>\n\t\t\t\t<span class=\"ui-btn ui-btn-xs ui-btn-primary ui-btn-no-caps ui-btn-round\" onclick=\"${this.#openContactCenter.bind(this)};\">${Loc.getMessage('CRM_CHANNEL_SELECTOR_ACTIVATE_CHANNELS')}</span>\n\t\t\t</div>\n\t\t</div>`\n\t\t}\n\n\t\tthis.layout.container = Tag.render`<div class=\"crm__channel-selector--container\">\n\t\t\t<div class=\"crm__channel-selector--header\">\n\t\t\t\t${this.layout.title}\n\t\t\t\t${this.layout.settings}\n\t\t\t</div>\n\t\t\t${this.layout.list}\n\t\t</div>`;\n\n\t\tif (this.layout.footer)\n\t\t{\n\t\t\tthis.layout.container.appendChild(this.layout.footer);\n\t\t}\n\n\t\tthis.adjustAppearance();\n\n\t\treturn this.layout.container;\n\t}\n\n\trenderChannel(channel: ChannelData): HTMLElement\n\t{\n\t\tconst channelHandler = (() => {\n\t\t\tthis.#handleChannelClick(channel);\n\t\t});\n\n\t\tconst icon = List.getChannelIcon(channel);\n\n\t\treturn Tag.render`<div \n\t\t\tclass=\"crm__channel-selector--channel\"\n\t\t\tonclick=\"${channelHandler}\"\n\t\t>\n\t\t\t${(icon ? Tag.render`<div class=\"crm__channel-selector--channel-icon ${icon}\"></div>` : '')}\n\t\t\t${this.renderChannelMainTitle(channel)}\n\t\t\t${this.renderChannelTitle(channel)}\n\t\t\t<div class=\"crm__channel-selector--channel-helper\">\n\t\t\t\t<span class=\"crm__channel-selector--channel-helper-text\">${Loc.getMessage('CRM_CHANNEL_SELECTOR_SEND_BUTTON')}</span>\n\t\t\t</div>\n\t\t</div>`;\n\t}\n\n\trenderChannelMainTitle(channel: ChannelData): HTMLElement\n\t{\n\t\treturn Tag.render`<div class=\"crm__channel-selector--channel-main-title\">\n\t\t\t${Text.encode(channel.categoryTitle ?? channel.title)}\n\t\t</div>`;\n\t}\n\n\trenderChannelTitle(channel: ChannelData): ?HTMLElement\n\t{\n\t\tif (!channel.categoryTitle)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\treturn Tag.render`<div class=\"crm__channel-selector--channel-title\">\n\t\t\t${Text.encode(channel.title)}\n\t\t</div>`;\n\t}\n\n\tadjustAppearance(): void\n\t{\n\t\tif (this.hasVisibleChannels)\n\t\t{\n\t\t\tDom.clean(this.layout.list);\n\t\t\tlet allChannelsAreHidden = true;\n\t\t\tthis.channels.forEach((channel: ChannelData) =>\n\t\t\t{\n\t\t\t\tconst node = this.layout.channels[channel.id];\n\t\t\t\tif (node)\n\t\t\t\t{\n\t\t\t\t\tthis.layout.list.append(node);\n\t\t\t\t\tif (this.#isChannelAvailable(channel))\n\t\t\t\t\t{\n\t\t\t\t\t\tDom.removeClass(node, 'crm__channel-selector--channel-disabled');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tDom.addClass(node, 'crm__channel-selector--channel-disabled');\n\t\t\t\t\t}\n\t\t\t\t\tif (channel.isHidden)\n\t\t\t\t\t{\n\t\t\t\t\t\tDom.addClass(node, 'crm__channel-selector--channel-hidden');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tDom.removeClass(node, 'crm__channel-selector--channel-hidden');\n\t\t\t\t\t\tallChannelsAreHidden = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t\tif (allChannelsAreHidden)\n\t\t\t{\n\t\t\t\tDom.addClass(this.layout.list, '--empty');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tDom.removeClass(this.layout.list, '--empty');\n\t\t\t}\n\t\t}\n\t}\n\n\t#getChannelById(id: string): ?ChannelData\n\t{\n\t\treturn this.channels.find(channel => channel.id === id);\n\t}\n\n\t#isChannelAvailable(channel: ChannelData): boolean\n\t{\n\t\tif (!channel.isAvailable)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\t\tconst hasLink = this.isLinkObtainable || Boolean(this.#link);\n\t\tconst hasFiles = CrmActivityEditor && this.storageTypeId > 0 && this.files.length > 0;\n\t\tif (channel.type === CHANNEL_TYPE_PHONE || channel.type === CHANNEL_TYPE_IM)\n\t\t{\n\t\t\treturn hasLink;\n\t\t}\n\t\tif (channel.type === CHANNEL_TYPE_EMAIL)\n\t\t{\n\t\t\treturn hasLink || hasFiles;\n\t\t}\n\t\tif (\n\t\t\tchannel.type === CHANNEL_TYPE_EMAIL\n\t\t\t&& !CrmActivityEditor?.items[this.activityEditorId]\n\t\t)\n\t\t{\n\t\t\tconsole.log('Email channel is disabled because the CrmActivityEditor instance is not found');\n\t\t\treturn false;\n\t\t}\n\n\t\treturn channel.isAvailable;\n\t}\n\n\t#getLink(): Promise<string>\n\t{\n\t\tif (this.#link)\n\t\t{\n\t\t\treturn Promise.resolve(this.#link);\n\t\t}\n\t\tif (!this.isLinkObtainable)\n\t\t{\n\t\t\treturn Promise.reject();\n\t\t}\n\t\tif (this.#getLinkPromise)\n\t\t{\n\t\t\treturn this.#getLinkPromise;\n\t\t}\n\t\tthis.#getLinkPromise = new Promise((resolve, reject) => {\n\t\t\tthis.#showLoader();\n\t\t\tthis.emitAsync('getLink').then((result: Array) => {\n\t\t\t\tresult.forEach((link) => {\n\t\t\t\t\tthis.setLink(link);\n\t\t\t\t});\n\t\t\t\tif (!this.#link)\n\t\t\t\t{\n\t\t\t\t\treject();\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tresolve(this.#link);\n\t\t\t\t}\n\t\t\t}).catch(reject)\n\t\t\t.finally(() => {\n\t\t\t\tthis.#getLinkPromise = null;\n\t\t\t\tthis.#hideLoader();\n\t\t\t});\n\t\t});\n\n\t\treturn this.#getLinkPromise;\n\t}\n\n\t#handleFooterClick(): void\n\t{\n\t\tif (!this.layout.link)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tthis.#getLink().then((link) => {\n\t\t\tthis.layout.link.value = link;\n\t\t\tthis.layout.link.focus();\n\t\t\tthis.layout.link.setSelectionRange(0, this.layout.link.value.length);\n\t\t\tdocument.execCommand(\"copy\");\n\n\t\t\tthis.#showNotice(Loc.getMessage('CRM_CHANNEL_PUBLIC_LINK_COPIED_NOTIFICATION_MESSAGE'));\n\t\t}).catch((reason: ?string) => {\n\t\t\tthis.#showGetLinkErrorNotification(this.layout.footer, reason);\n\t\t});\n\t}\n\n\t#handleSettingsClick(): void\n\t{\n\t\tconst event = new BaseEvent();\n\t\tthis.emit('onSettingsClick', event);\n\t\tif (event.isDefaultPrevented())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#openMenu();\n\t}\n\n\t#openMenu(): void\n\t{\n\t\tthis.#getMenu().show();\n\t}\n\n\t#getMenuItemsInViewMode(): Array\n\t{\n\t\tconst settingsItems = [];\n\t\tthis.channels.forEach((channel: ChannelData) => {\n\t\t\tif (channel.isHidden)\n\t\t\t{\n\t\t\t\tsettingsItems.push({\n\t\t\t\t\ttext: channel.title,\n\t\t\t\t\tid: channel.id,\n\t\t\t\t\tonclick: () => {\n\t\t\t\t\t\tthis.#handleChannelClick(channel);\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tsettingsItems.push({\n\t\t\tdelimiter: true,\n\t\t});\n\t\tsettingsItems.push({\n\t\t\ttext: Loc.getMessage('CRM_CHANNEL_SELECTOR_CHOOSE_FROM_MARKET'),\n\t\t\tid: 'market',\n\t\t\thref: Loc.getMessage('MARKET_BASE_PATH') + MARKET_LINK,\n\t\t\tonclick: (event: PointerEvent, item: MenuItem) => {\n\t\t\t\tconst menu = item.getMenuWindow()?.getRootMenuWindow() || item.getMenuWindow();\n\t\t\t\tmenu?.close();\n\t\t\t},\n\t\t});\n\n\t\tsettingsItems.push({\n\t\t\tdelimiter: true\n\t\t});\n\t\tsettingsItems.push({\n\t\t\ttext: Loc.getMessage('CRM_COMMON_ACTION_CONFIG'),\n\t\t\tid: 'configure',\n\t\t\tonclick: this.#switchMenuToEditMode.bind(this),\n\t\t});\n\n\t\treturn settingsItems;\n\t}\n\n\t#getMenu(): Menu\n\t{\n\t\tif (!this.#menu)\n\t\t{\n\t\t\tthis.#menu = MenuManager.create({\n\t\t\t\tid: this.id + '-settings-popup',\n\t\t\t\tbindElement: this.layout.settings,\n\t\t\t\titems: this.#getMenuItemsInViewMode(),\n\t\t\t});\n\t\t}\n\n\t\treturn this.#menu;\n\t}\n\n\t#switchMenuToEditMode(): void\n\t{\n\t\tthis.#getMenu().close();\n\t\tthis.#getMenuConfigurable().open().then((result) => {\n\t\t\tif (result.isCanceled)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (Type.isArray(result.items))\n\t\t\t{\n\t\t\t\tthis.#saveSettings(result.items);\n\t\t\t\tthis.#openMenu();\n\t\t\t}\n\t\t});\n\t}\n\n\t#saveSettings(items: Array<{id: string, isHidden: boolean}>): void\n\t{\n\t\tconst channels = [];\n\t\titems.forEach((item) => {\n\t\t\tconst channel = this.#getChannelById(item.id);\n\t\t\tif (channel)\n\t\t\t{\n\t\t\t\tchannel.isHidden = item.isHidden;\n\t\t\t\tchannels.push(channel);\n\t\t\t}\n\t\t});\n\t\tthis.setChannels(channels);\n\t\tthis.adjustAppearance();\n\t\tthis.#menu.destroy();\n\t\tthis.#menu = null;\n\n\t\tUserOptions.save(\"crm\", \"channel-selector\", \"items\", JSON.stringify(items));\n\t}\n\n\t#switchMenuToViewMode(): void\n\t{\n\t\tthis.#menuConfigurable?.close();\n\t\tthis.#getMenu().show();\n\t}\n\n\t#getMenuItemsInEditMode(): Array\n\t{\n\t\tconst items = [];\n\t\tthis.channels.forEach((channel: ChannelData) => {\n\t\t\titems.push({\n\t\t\t\ttext: channel.title,\n\t\t\t\tid: channel.id,\n\t\t\t\tisHidden: channel.isHidden,\n\t\t\t});\n\t\t});\n\n\t\treturn items;\n\t}\n\n\t#getMenuConfigurable(): MenuConfigurable\n\t{\n\t\tconst items = this.#getMenuItemsInEditMode();\n\t\tif (!this.#menuConfigurable)\n\t\t{\n\t\t\tthis.#menuConfigurable = new MenuConfigurable({\n\t\t\t\titems,\n\t\t\t\tbindElement: this.layout.settings,\n\t\t\t\tmaxVisibleItems: MAX_VISIBLE_ITEMS,\n\t\t\t});\n\t\t\tthis.#menuConfigurable.subscribe('Cancel', () => {\n\t\t\t\tthis.#openMenu();\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#menuConfigurable.setItems(items);\n\t\t}\n\n\t\treturn this.#menuConfigurable;\n\t}\n\n\t#showGetLinkErrorNotification(bindElement: HTMLElement, text: ?string)\n\t{\n\t\tif (!Type.isStringFilled(text))\n\t\t{\n\t\t\ttext = Loc.getMessage('CRM_CHANNEL_PUBLIC_LINK_NOT_AVAILABLE_NOTIFICATION_MESSAGE');\n\t\t}\n\n\t\tthis.#showNotice(text);\n\t}\n\n\t#showNotice(content: string)\n\t{\n\t\tif (NotificationCenter)\n\t\t{\n\t\t\tNotificationCenter.notify({\n\t\t\t\tcontent,\n\t\t\t});\n\t\t}\n\t};\n\n\t#handleChannelClick(channel: ChannelData): void\n\t{\n\t\tconst event = new BaseEvent();\n\t\tevent.setData({channel, communications: this.communications[channel.type]});\n\t\tthis.emit('onChannelClick', event);\n\n\t\tif (event.isDefaultPrevented())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.#isChannelAvailable(channel))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (channel.type === CHANNEL_TYPE_EMAIL)\n\t\t{\n\t\t\tthis.sendEmail(channel);\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (channel.type === CHANNEL_TYPE_PHONE)\n\t\t{\n\t\t\tthis.sendSms(channel);\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (channel.type === CHANNEL_TYPE_IM)\n\t\t{\n\t\t\tthis.openMessenger(channel);\n\t\t}\n\t}\n\n\tsetFiles(files: number[]): this\n\t{\n\t\tthis.files = Type.isArray(files) ? files : [];\n\n\t\tthis.adjustAppearance();\n\n\t\treturn this;\n\t}\n\n\tsetLink(link: string): this\n\t{\n\t\tthis.#link = link ?? null;\n\n\t\tthis.adjustAppearance();\n\n\t\treturn this;\n\t}\n\n\tsendEmail(channel: ChannelData): void\n\t{\n\t\tif (this.files.length <= 0 || Number(this.storageTypeId) <= 0)\n\t\t{\n\t\t\tconst channelNode = this.layout.channels[channel.id];\n\t\t\tthis.#getLink().then((link) => {\n\t\t\t\tCrmActivityEditor?.items[this.activityEditorId]?.addEmail({\n\t\t\t\t\tsubject: this.documentTitle,\n\t\t\t\t\tbody: Loc.getMessage('CRM_CHANNEL_SELECTOR_MESSAGE_WITH_LINK', {\n\t\t\t\t\t\t'#MESSAGE#': this.documentTitle,\n\t\t\t\t\t\t'#LINK#': link,\n\t\t\t\t\t}),\n\t\t\t\t});\n\t\t\t}).catch((reason) => {\n\t\t\t\tthis.#showGetLinkErrorNotification(channelNode, reason);\n\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tCrmActivityEditor?.items[this.activityEditorId]?.addEmail({\n\t\t\t\tsubject: this.documentTitle,\n\t\t\t\tdiskfiles: this.files,\n\t\t\t\tstorageTypeID: this.storageTypeId,\n\t\t\t});\n\t\t}\n\t}\n\n\tsendSms(channel: ChannelData): void\n\t{\n\t\tconst channelNode = this.layout.channels[channel.id];\n\t\tif (!this.smsUrl)\n\t\t{\n\t\t\tthis.#showGetLinkErrorNotification(channelNode, 'No sms url');\n\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#getLink().then((link) => {\n\t\t\tconst requestParams = {\n\t\t\t\tentityTypeId: this.entityTypeId,\n\t\t\t\tentityId: this.entityId,\n\t\t\t\ttext: this.#getSmsText(channel, link),\n\t\t\t\tproviderId: channel.id,\n\t\t\t\tisProviderFixed: 'N',\n\t\t\t\tcanUseBitrix24Provider: 'Y',\n\t\t\t};\n\n\t\t\tif (channel.templateCode)\n\t\t\t{\n\t\t\t\trequestParams.templateCode = channel.templateCode;\n\t\t\t\trequestParams.templatePlaceholders = channel.templatePlaceholders;\n\t\t\t\trequestParams.templatePlaceholders.DOCUMENT_URL = link;\n\t\t\t\trequestParams.isEditable = 'N';\n\t\t\t}\n\n\t\t\tRouter.openSlider(this.smsUrl, {\n\t\t\t\twidth: 443,\n\t\t\t\trequestMethod: 'post',\n\t\t\t\trequestParams,\n\t\t\t});\n\t\t}).catch((reason) => {\n\t\t\tthis.#showGetLinkErrorNotification(channelNode, reason);\n\t\t});\n\t}\n\n\t#getSmsText(channel: ChannelData, link: string): string\n\t{\n\t\tconst message = (channel.id === 'bitrix24' && this.fullBody) ? this.fullBody : this.body;\n\t\tif (this.isCombineMessageWithLink)\n\t\t{\n\t\t\treturn Loc.getMessage('CRM_CHANNEL_SELECTOR_MESSAGE_WITH_LINK', {\n\t\t\t\t'#MESSAGE#': message,\n\t\t\t\t'#LINK#': link,\n\t\t\t});\n\t\t}\n\n\t\tif (this.#isInsertLinkInMessage)\n\t\t{\n\t\t\treturn message.replace(LINK_IN_MESSAGE_PLACEHOLDER, link);\n\t\t}\n\n\t\treturn message;\n\t}\n\n\topenMessenger(channel: ChannelData): void\n\t{\n\t\tif (!top.BXIM)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tif (!this.communications[channel.type])\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\ttop.BXIM.openMessenger(this.communications[channel.type].VALUE, {RECENT: \"N\", MENU: \"N\"});\n\t}\n\n\t#openContactCenter(): void\n\t{\n\t\tRouter.openSlider(this.contactCenterUrl).then(() => {\n\t\t\tlocation.reload();\n\t\t});\n\t}\n\n\tgetId(): string\n\t{\n\t\treturn this.id;\n\t}\n\n\tstatic getDefault(): ?List\n\t{\n\t\treturn items.get('default');\n\t}\n\n\tstatic getById(id: string): ?List\n\t{\n\t\treturn items.get(id);\n\t}\n\n\t#showLoader(): void\n\t{\n\t\tconst loader = this.#getLoader();\n\t\tif (loader)\n\t\t{\n\t\t\tloader.show(this.layout.container);\n\t\t}\n\t}\n\n\t#hideLoader(): void\n\t{\n\t\tconst loader = this.#getLoader();\n\t\tif (loader)\n\t\t{\n\t\t\tloader.hide();\n\t\t}\n\t}\n\n\t#getLoader(): ?Loader\n\t{\n\t\tif(!this.#loader && Loader)\n\t\t{\n\t\t\tthis.#loader = new Loader({size: 100, offset: {left: \"35%\", top: \"-25%\"}});\n\t\t}\n\n\t\treturn this.#loader;\n\t}\n\n\tstatic getChannelIcon(channel: ChannelData): ?string\n\t{\n\t\treturn (channel.icon || List.getIconByChannelId(channel.id));\n\t}\n\n\tstatic getIconByChannelId(id: string): ?string\n\t{\n\t\tif (id === 'bitrix24')\n\t\t{\n\t\t\treturn '--service-bitrix24';\n\t\t}\n\n\t\tif (id === CHANNEL_TYPE_EMAIL)\n\t\t{\n\t\t\treturn '--service-email';\n\t\t}\n\n\t\tif (id === CHANNEL_TYPE_IM)\n\t\t{\n\t\t\treturn '--service-livechat';\n\t\t}\n\n\t\tif (id === 'twilio')\n\t\t{\n\t\t\treturn '--service-whatsapp';\n\t\t}\n\n\t\tif (id === 'ednaru' || id === 'ednaruimhpx')\n\t\t{\n\t\t\treturn '--service-edna';\n\t\t}\n\n\t\treturn '--service-sms';\n\t}\n}\n"],"names":["CrmActivityEditor","Reflection","namespace","UserOptions","NotificationCenter","CHANNEL_TYPE_PHONE","CHANNEL_TYPE_EMAIL","CHANNEL_TYPE_IM","MAX_VISIBLE_ITEMS","MARKET_LINK","LINK_IN_MESSAGE_PLACEHOLDER","items","Map","List","EventEmitter","constructor","parameters","isCombineMessageWithLink","title","Type","isStringFilled","Loc","getMessage","documentTitle","String","body","fullBody","link","isLinkObtainable","Text","toBoolean","entityTypeId","toInteger","entityId","id","Math","random","toString","substring","storageTypeId","files","isArray","activityEditorId","smsUrl","isBoolean","isInsertLinkInMessage","templateCode","setChannels","channels","communications","isPlainObject","hasVisibleChannels","channelIcons","contactCenterUrl","layout","setEventNamespace","size","set","forEach","channel","push","render","container","Tag","encode","footer","bind","settings","list","channelNode","renderChannel","map","icon","appendChild","adjustAppearance","channelHandler","getChannelIcon","renderChannelMainTitle","renderChannelTitle","categoryTitle","Dom","clean","allChannelsAreHidden","node","append","removeClass","addClass","isHidden","setFiles","setLink","sendEmail","length","Number","then","addEmail","subject","catch","reason","diskfiles","storageTypeID","sendSms","requestParams","text","providerId","isProviderFixed","canUseBitrix24Provider","templatePlaceholders","DOCUMENT_URL","isEditable","Router","openSlider","width","requestMethod","openMessenger","top","BXIM","type","VALUE","RECENT","MENU","getId","getDefault","get","getById","getIconByChannelId","find","isAvailable","hasLink","Boolean","hasFiles","console","log","Promise","resolve","reject","emitAsync","result","finally","value","focus","setSelectionRange","document","execCommand","event","BaseEvent","emit","isDefaultPrevented","show","settingsItems","onclick","delimiter","href","item","menu","getMenuWindow","getRootMenuWindow","close","MenuManager","create","bindElement","open","isCanceled","destroy","save","JSON","stringify","MenuConfigurable","maxVisibleItems","subscribe","setItems","content","notify","setData","message","replace","location","reload","loader","hide","Loader","offset","left"],"mappings":"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"}