this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,s,t,i,l,a,r){"use strict";let n=e=>e,o,c,h,d,b,u,v,p,y,L;const f=s.Reflection.namespace("BX.CrmActivityEditor");const P=s.Reflection.namespace("BX.userOptions");const m=s.Reflection.namespace("BX.UI.Notification.Center");const H="PHONE";const F="EMAIL";const _="IM";const B=4;const g=new Map;var C=babelHelpers.classPrivateFieldLooseKey("link");var E=babelHelpers.classPrivateFieldLooseKey("loader");var I=babelHelpers.classPrivateFieldLooseKey("getLinkPromise");var T=babelHelpers.classPrivateFieldLooseKey("menu");var M=babelHelpers.classPrivateFieldLooseKey("menuConfigurable");var O=babelHelpers.classPrivateFieldLooseKey("renderChannel");var N=babelHelpers.classPrivateFieldLooseKey("getChannelById");var k=babelHelpers.classPrivateFieldLooseKey("isChannelAvailable");var A=babelHelpers.classPrivateFieldLooseKey("getLink");var S=babelHelpers.classPrivateFieldLooseKey("handleFooterClick");var j=babelHelpers.classPrivateFieldLooseKey("handleSettingsClick");var K=babelHelpers.classPrivateFieldLooseKey("openMenu");var w=babelHelpers.classPrivateFieldLooseKey("getMenuItemsInViewMode");var R=babelHelpers.classPrivateFieldLooseKey("getMenu");var x=babelHelpers.classPrivateFieldLooseKey("switchMenuToEditMode");var $=babelHelpers.classPrivateFieldLooseKey("saveSettings");var X=babelHelpers.classPrivateFieldLooseKey("switchMenuToViewMode");var U=babelHelpers.classPrivateFieldLooseKey("getMenuItemsInEditMode");var D=babelHelpers.classPrivateFieldLooseKey("getMenuConfigurable");var V=babelHelpers.classPrivateFieldLooseKey("showGetLinkErrorNotification");var G=babelHelpers.classPrivateFieldLooseKey("showNotice");var q=babelHelpers.classPrivateFieldLooseKey("handleChannelClick");var z=babelHelpers.classPrivateFieldLooseKey("openContactCenter");var W=babelHelpers.classPrivateFieldLooseKey("showLoader");var J=babelHelpers.classPrivateFieldLooseKey("hideLoader");var Y=babelHelpers.classPrivateFieldLooseKey("getLoader");class Q extends i.EventEmitter{constructor(e){super();Object.defineProperty(this,Y,{value:Pe});Object.defineProperty(this,J,{value:fe});Object.defineProperty(this,W,{value:Le});Object.defineProperty(this,z,{value:ye});Object.defineProperty(this,q,{value:pe});Object.defineProperty(this,G,{value:ve});Object.defineProperty(this,V,{value:ue});Object.defineProperty(this,D,{value:be});Object.defineProperty(this,U,{value:de});Object.defineProperty(this,X,{value:he});Object.defineProperty(this,$,{value:ce});Object.defineProperty(this,x,{value:oe});Object.defineProperty(this,R,{value:ne});Object.defineProperty(this,w,{value:re});Object.defineProperty(this,K,{value:ae});Object.defineProperty(this,j,{value:le});Object.defineProperty(this,S,{value:ie});Object.defineProperty(this,A,{value:te});Object.defineProperty(this,k,{value:se});Object.defineProperty(this,N,{value:ee});Object.defineProperty(this,O,{value:Z});Object.defineProperty(this,C,{writable:true,value:void 0});Object.defineProperty(this,E,{writable:true,value:void 0});Object.defineProperty(this,I,{writable:true,value:void 0});Object.defineProperty(this,T,{writable:true,value:void 0});Object.defineProperty(this,M,{writable:true,value:void 0});this.title=s.Type.isStringFilled(e.title)?e.title:s.Loc.getMessage("CRM_CHANNEL_SELECTOR_DEFAULT_TITLE");this.body=String(e.body);babelHelpers.classPrivateFieldLooseBase(this,C)[C]=String(e.link);this.isLinkObtainable=s.Text.toBoolean(e.isLinkObtainable);this.entityTypeId=s.Text.toInteger(e.entityTypeId);this.entityId=s.Text.toInteger(e.entityId);this.id=s.Type.isStringFilled(e.id)?e.id:this.entityTypeId+"_"+this.entityId+"_"+Math.random().toString().substring(2);this.storageTypeId=s.Text.toInteger(e.storageTypeId);this.files=s.Type.isArray(e.files)?e.files:[];this.activityEditorId=String(e.activityEditorId);this.smsUrl=String(e.smsUrl);this.setChannels(e.channels);this.communications=s.Type.isPlainObject(e.communications)?e.communications:{};this.hasVisibleChannels=s.Text.toBoolean(e.hasVisibleChannels);this.channelIcons=s.Type.isArray(e.channelIcons)?e.channelIcons:[];this.contactCenterUrl=s.Type.isStringFilled(e.contactCenterUrl)?e.contactCenterUrl:"/contact_center/";this.layout={channels:{}};this.setEventNamespace("BX.Crm.ChannelSelector.List");if(g.size===0){g.set("default",this)}g.set(this.id,this)}setChannels(e){this.channels=[];if(s.Type.isArray(e)){e.forEach((e=>{this.channels.push(e)}))}return this}render(){if(this.layout.container){return this.layout.container}this.layout.title=s.Tag.render(o||(o=n`<div class="crm__channel-selector--title">${0}</div>`),s.Text.encode(this.title));if(babelHelpers.classPrivateFieldLooseBase(this,C)[C]||this.isLinkObtainable){this.layout.link=s.Tag.render(c||(c=n`<input type="text" class="crm__channel-selector--footer-link-hidden" value="${0}" />`),s.Text.encode(babelHelpers.classPrivateFieldLooseBase(this,C)[C]));this.layout.footer=s.Tag.render(h||(h=n`<div class="crm__channel-selector--footer" onclick="${0}">
				<div class="crm__channel-selector--footer-copy-link">
					<span class="crm__channel-selector--footer-text">${0}</span>
					${0}
				</div>
			</div>`),babelHelpers.classPrivateFieldLooseBase(this,S)[S].bind(this),s.Loc.getMessage("CRM_CHANNEL_FOOTER_TITLE"),this.layout.link)}else{this.layout.footer=null}this.layout.settings=null;if(this.hasVisibleChannels){this.layout.settings=s.Tag.render(d||(d=n`<button class="ui-btn ui-btn-xs ui-btn-link ui-btn-icon-setting crm__channel-selector--setting-btn" onclick="${0}"></button>`),babelHelpers.classPrivateFieldLooseBase(this,j)[j].bind(this));this.layout.list=s.Tag.render(b||(b=n`<div class="crm__channel-selector--list"></div>`));this.channels.forEach((e=>{const s=babelHelpers.classPrivateFieldLooseBase(this,O)[O](e);if(s){this.layout.channels[e.id]=s}}))}else{this.layout.list=s.Tag.render(u||(u=n`<div class="crm__channel-selector--body">
			<div class="crm__channel-selector--networks">
				<div class="crm__channel-selector--networks-title">${0}</div>
				<div class="crm__channel-selector--networks-block">
					${0}
					<span class="crm__channel-selector--network-link --link" onclick="${0}">+ 15</span>
				</div>
				<span class="ui-btn ui-btn-xs ui-btn-primary ui-btn-no-caps ui-btn-round" onclick="${0};">${0}</span>
			</div>
		</div>`),s.Loc.getMessage("CRM_CHANNEL_SELECTOR_NO_ACTIVE_CHANNELS_TEXT"),this.channelIcons.map((e=>s.Tag.render(v||(v=n`<span class="crm__channel-selector--network-link --${0}" onclick="${0}"></span>`),e,babelHelpers.classPrivateFieldLooseBase(this,z)[z].bind(this)))),babelHelpers.classPrivateFieldLooseBase(this,z)[z].bind(this),babelHelpers.classPrivateFieldLooseBase(this,z)[z].bind(this),s.Loc.getMessage("CRM_CHANNEL_SELECTOR_ACTIVATE_CHANNELS"))}this.layout.container=s.Tag.render(p||(p=n`<div class="crm__channel-selector--container">
			<div class="crm__channel-selector--header">
				${0}
				${0}
			</div>
			${0}
		</div>`),this.layout.title,this.layout.settings,this.layout.list);if(this.layout.footer){this.layout.container.appendChild(this.layout.footer)}this.adjustAppearance();return this.layout.container}adjustAppearance(){if(this.hasVisibleChannels){s.Dom.clean(this.layout.list);let e=true;this.channels.forEach((t=>{const i=this.layout.channels[t.id];if(i){this.layout.list.append(i);if(babelHelpers.classPrivateFieldLooseBase(this,k)[k](t)){s.Dom.removeClass(i,"crm__channel-selector--channel-disabled")}else{s.Dom.addClass(i,"crm__channel-selector--channel-disabled")}if(t.isHidden){s.Dom.addClass(i,"crm__channel-selector--channel-hidden")}else{s.Dom.removeClass(i,"crm__channel-selector--channel-hidden");e=false}}}));if(e){s.Dom.addClass(this.layout.list,"--empty")}else{s.Dom.removeClass(this.layout.list,"--empty")}}}setFiles(e){this.files=s.Type.isArray(e)?e:[];this.adjustAppearance();return this}setLink(e){babelHelpers.classPrivateFieldLooseBase(this,C)[C]=e!=null?e:null;this.adjustAppearance();return this}sendEmail(e){if(this.files.length<=0||Number(this.storageTypeId)<=0){const t=this.layout.channels[e.id];babelHelpers.classPrivateFieldLooseBase(this,A)[A]().then((e=>{var t;f==null?void 0:(t=f.items[this.activityEditorId])==null?void 0:t.addEmail({subject:this.body,body:s.Loc.getMessage("CRM_CHANNEL_SELECTOR_MESSAGE_WITH_LINK",{"#MESSAGE#":this.body,"#LINK#":e})})})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,V)[V](t,e)}))}else{var t;f==null?void 0:(t=f.items[this.activityEditorId])==null?void 0:t.addEmail({subject:this.body,diskfiles:this.files,storageTypeID:this.storageTypeId})}}sendSms(e){const t=this.layout.channels[e.id];if(!this.smsUrl){babelHelpers.classPrivateFieldLooseBase(this,V)[V](t,"No sms url");return}babelHelpers.classPrivateFieldLooseBase(this,A)[A]().then((t=>{l.Router.openSlider(this.smsUrl,{width:443,requestMethod:"post",requestParams:{entityTypeId:this.entityTypeId,entityId:this.entityId,text:s.Loc.getMessage("CRM_CHANNEL_SELECTOR_MESSAGE_WITH_LINK",{"#MESSAGE#":this.body,"#LINK#":t}),providerId:e.id,isProviderFixed:"Y"}})})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,V)[V](t,e)}))}openMessenger(e){if(!top.BXIM){return}if(!this.communications[e.type]){return}top.BXIM.openMessenger(this.communications[e.type].VALUE,{RECENT:"N",MENU:"N"})}getId(){return this.id}static getDefault(){return g.get("default")}static getById(e){return g.get(e)}getChannelIcon(e){let s=e.icon;if(!s){s=Q.getIconByChannelId(e.id)}return s}static getIconByChannelId(e){if(e===F){return"--service-email"}if(e===_){return"--service-livechat"}if(e==="twilio"){return"--service-whatsapp"}if(e==="ednaru"||e==="ednaruimhpx"){return"--service-edna"}return"--service-sms"}}function Z(e){const t=()=>{babelHelpers.classPrivateFieldLooseBase(this,q)[q](e)};let i=this.getChannelIcon(e);return s.Tag.render(y||(y=n`<div 
			class="crm__channel-selector--channel"
			onclick="${0}"
		>
			${0}
			<div class="crm__channel-selector--channel-text">
				${0}
			</div>
			<div class="crm__channel-selector--channel-helper">
				<span class="crm__channel-selector--channel-helper-text">${0}</span>
			</div>
		</div>`),t,i?s.Tag.render(L||(L=n`<div class="crm__channel-selector--channel-icon ${0}"></div>`),i):"",s.Text.encode(e.title),s.Loc.getMessage("CRM_CHANNEL_SELECTOR_SEND_BUTTON"))}function ee(e){return this.channels.find((s=>s.id===e))}function se(e){if(!e.isAvailable){return false}const s=this.isLinkObtainable||Boolean(babelHelpers.classPrivateFieldLooseBase(this,C)[C]);const t=f&&this.storageTypeId>0&&this.files.length>0;if(e.type===H||e.type===_){return s}if(e.type===F){return s||t}if(e.type===F&&!(f!=null&&f.items[this.activityEditorId])){console.log("Email channel is disabled because the CrmActivityEditor instance is not found");return false}return e.isAvailable}function te(){if(babelHelpers.classPrivateFieldLooseBase(this,C)[C]){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,C)[C])}if(!this.isLinkObtainable){return Promise.reject()}if(babelHelpers.classPrivateFieldLooseBase(this,I)[I]){return babelHelpers.classPrivateFieldLooseBase(this,I)[I]}babelHelpers.classPrivateFieldLooseBase(this,I)[I]=new Promise(((e,s)=>{babelHelpers.classPrivateFieldLooseBase(this,W)[W]();this.emitAsync("getLink").then((t=>{t.forEach((e=>{this.setLink(e)}));if(!babelHelpers.classPrivateFieldLooseBase(this,C)[C]){s()}else{e(babelHelpers.classPrivateFieldLooseBase(this,C)[C])}})).catch(s).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,I)[I]=null;babelHelpers.classPrivateFieldLooseBase(this,J)[J]()}))}));return babelHelpers.classPrivateFieldLooseBase(this,I)[I]}function ie(){if(!this.layout.link){return}babelHelpers.classPrivateFieldLooseBase(this,A)[A]().then((e=>{this.layout.link.value=e;this.layout.link.focus();this.layout.link.setSelectionRange(0,this.layout.link.value.length);document.execCommand("copy");babelHelpers.classPrivateFieldLooseBase(this,G)[G](s.Loc.getMessage("CRM_CHANNEL_PUBLIC_LINK_COPIED_NOTIFICATION_MESSAGE"))})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,V)[V](this.layout.footer,e)}))}function le(){const e=new i.BaseEvent;this.emit("onSettingsClick",e);if(e.isDefaultPrevented()){return}babelHelpers.classPrivateFieldLooseBase(this,K)[K]()}function ae(){babelHelpers.classPrivateFieldLooseBase(this,R)[R]().show()}function re(){const e=[];this.channels.forEach((s=>{if(s.isHidden){e.push({text:s.title,id:s.id,onclick:()=>{babelHelpers.classPrivateFieldLooseBase(this,q)[q](s)}})}}));e.push({delimiter:true});e.push({text:s.Loc.getMessage("CRM_COMMON_ACTION_CONFIG"),id:"configure",onclick:babelHelpers.classPrivateFieldLooseBase(this,x)[x].bind(this)});return e}function ne(){if(!babelHelpers.classPrivateFieldLooseBase(this,T)[T]){babelHelpers.classPrivateFieldLooseBase(this,T)[T]=t.MenuManager.create({id:this.id+"-settings-popup",bindElement:this.layout.settings,items:babelHelpers.classPrivateFieldLooseBase(this,w)[w]()})}return babelHelpers.classPrivateFieldLooseBase(this,T)[T]}function oe(){babelHelpers.classPrivateFieldLooseBase(this,R)[R]().close();babelHelpers.classPrivateFieldLooseBase(this,D)[D]().open().then((e=>{if(e.isCanceled){return}if(s.Type.isArray(e.items)){babelHelpers.classPrivateFieldLooseBase(this,$)[$](e.items);babelHelpers.classPrivateFieldLooseBase(this,K)[K]()}}))}function ce(e){const s=[];e.forEach((e=>{const t=babelHelpers.classPrivateFieldLooseBase(this,N)[N](e.id);if(t){t.isHidden=e.isHidden;s.push(t)}}));this.setChannels(s);this.adjustAppearance();babelHelpers.classPrivateFieldLooseBase(this,T)[T].destroy();babelHelpers.classPrivateFieldLooseBase(this,T)[T]=null;P.save("crm","channel-selector","items",JSON.stringify(e))}function he(){var e;(e=babelHelpers.classPrivateFieldLooseBase(this,M)[M])==null?void 0:e.close();babelHelpers.classPrivateFieldLooseBase(this,R)[R]().show()}function de(){const e=[];this.channels.forEach((s=>{e.push({text:s.title,id:s.id,isHidden:s.isHidden})}));return e}function be(){const e=babelHelpers.classPrivateFieldLooseBase(this,U)[U]();if(!babelHelpers.classPrivateFieldLooseBase(this,M)[M]){babelHelpers.classPrivateFieldLooseBase(this,M)[M]=new r.Menu({items:e,bindElement:this.layout.settings,maxVisibleItems:B});babelHelpers.classPrivateFieldLooseBase(this,M)[M].subscribe("Cancel",(()=>{babelHelpers.classPrivateFieldLooseBase(this,K)[K]()}))}else{babelHelpers.classPrivateFieldLooseBase(this,M)[M].setItems(e)}return babelHelpers.classPrivateFieldLooseBase(this,M)[M]}function ue(e,t){if(!s.Type.isStringFilled(t)){t=s.Loc.getMessage("CRM_CHANNEL_PUBLIC_LINK_NOT_AVAILABLE_NOTIFICATION_MESSAGE")}babelHelpers.classPrivateFieldLooseBase(this,G)[G](t)}function ve(e){if(m){m.notify({content:e})}}function pe(e){const s=new i.BaseEvent;s.setData({channel:e,communications:this.communications[e.type]});this.emit("onChannelClick",s);if(s.isDefaultPrevented()){return}if(!babelHelpers.classPrivateFieldLooseBase(this,k)[k](e)){return}if(e.type===F){this.sendEmail(e);return}if(e.type===H){this.sendSms(e);return}if(e.type===_){this.openMessenger(e)}}function ye(){l.Router.openSlider(this.contactCenterUrl).then((()=>{location.reload()}))}function Le(){const e=babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]();if(e){e.show(this.layout.container)}}function fe(){const e=babelHelpers.classPrivateFieldLooseBase(this,Y)[Y]();if(e){e.hide()}}function Pe(){if(!babelHelpers.classPrivateFieldLooseBase(this,E)[E]&&a.Loader){babelHelpers.classPrivateFieldLooseBase(this,E)[E]=new a.Loader({size:100,offset:{left:"35%",top:"-25%"}})}return babelHelpers.classPrivateFieldLooseBase(this,E)[E]}e.List=Q})(this.BX.Crm.ChannelSelector=this.BX.Crm.ChannelSelector||{},BX,BX.Main,BX.Event,BX.Crm,BX,BX.UI.MenuConfigurable);
//# sourceMappingURL=channel-selector.bundle.map.js