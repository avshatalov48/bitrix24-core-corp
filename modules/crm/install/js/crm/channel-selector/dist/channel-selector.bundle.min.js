this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,s,t,i,l,a,n,r){"use strict";let o=e=>e,c,d,h,b,u,v,p,y,L,f,m,P;const H=t.Reflection.namespace("BX.CrmActivityEditor");const _=t.Reflection.namespace("BX.userOptions");const g=t.Reflection.namespace("BX.UI.Notification.Center");const C="PHONE";const B="EMAIL";const F="IM";const E=4;const T="category/crm_robot_sms/";const I=new Map;var M=babelHelpers.classPrivateFieldLooseKey("link");var O=babelHelpers.classPrivateFieldLooseKey("loader");var N=babelHelpers.classPrivateFieldLooseKey("getLinkPromise");var A=babelHelpers.classPrivateFieldLooseKey("menu");var k=babelHelpers.classPrivateFieldLooseKey("menuConfigurable");var S=babelHelpers.classPrivateFieldLooseKey("getChannelById");var j=babelHelpers.classPrivateFieldLooseKey("isChannelAvailable");var K=babelHelpers.classPrivateFieldLooseKey("getLink");var w=babelHelpers.classPrivateFieldLooseKey("handleFooterClick");var R=babelHelpers.classPrivateFieldLooseKey("handleSettingsClick");var x=babelHelpers.classPrivateFieldLooseKey("openMenu");var $=babelHelpers.classPrivateFieldLooseKey("getMenuItemsInViewMode");var X=babelHelpers.classPrivateFieldLooseKey("getMenu");var U=babelHelpers.classPrivateFieldLooseKey("switchMenuToEditMode");var D=babelHelpers.classPrivateFieldLooseKey("saveSettings");var V=babelHelpers.classPrivateFieldLooseKey("switchMenuToViewMode");var G=babelHelpers.classPrivateFieldLooseKey("getMenuItemsInEditMode");var W=babelHelpers.classPrivateFieldLooseKey("getMenuConfigurable");var q=babelHelpers.classPrivateFieldLooseKey("showGetLinkErrorNotification");var z=babelHelpers.classPrivateFieldLooseKey("showNotice");var Y=babelHelpers.classPrivateFieldLooseKey("handleChannelClick");var J=babelHelpers.classPrivateFieldLooseKey("openContactCenter");var Q=babelHelpers.classPrivateFieldLooseKey("showLoader");var Z=babelHelpers.classPrivateFieldLooseKey("hideLoader");var ee=babelHelpers.classPrivateFieldLooseKey("getLoader");class se extends i.EventEmitter{constructor(e){var s;super();Object.defineProperty(this,ee,{value:He});Object.defineProperty(this,Z,{value:Pe});Object.defineProperty(this,Q,{value:me});Object.defineProperty(this,J,{value:fe});Object.defineProperty(this,Y,{value:Le});Object.defineProperty(this,z,{value:ye});Object.defineProperty(this,q,{value:pe});Object.defineProperty(this,W,{value:ve});Object.defineProperty(this,G,{value:ue});Object.defineProperty(this,V,{value:be});Object.defineProperty(this,D,{value:he});Object.defineProperty(this,U,{value:de});Object.defineProperty(this,X,{value:ce});Object.defineProperty(this,$,{value:oe});Object.defineProperty(this,x,{value:re});Object.defineProperty(this,R,{value:ne});Object.defineProperty(this,w,{value:ae});Object.defineProperty(this,K,{value:le});Object.defineProperty(this,j,{value:ie});Object.defineProperty(this,S,{value:te});Object.defineProperty(this,M,{writable:true,value:void 0});Object.defineProperty(this,O,{writable:true,value:void 0});Object.defineProperty(this,N,{writable:true,value:void 0});Object.defineProperty(this,A,{writable:true,value:void 0});Object.defineProperty(this,k,{writable:true,value:void 0});this.title=t.Type.isStringFilled(e.title)?e.title:t.Loc.getMessage("CRM_CHANNEL_SELECTOR_DEFAULT_TITLE");this.documentTitle=String(e.documentTitle);this.body=String(e.body);this.fullBody=String(e.fullBody);babelHelpers.classPrivateFieldLooseBase(this,M)[M]=String(e.link);this.isLinkObtainable=t.Text.toBoolean(e.isLinkObtainable);this.entityTypeId=t.Text.toInteger(e.entityTypeId);this.entityId=t.Text.toInteger(e.entityId);this.id=t.Type.isStringFilled(e.id)?e.id:this.entityTypeId+"_"+this.entityId+"_"+Math.random().toString().substring(2);this.storageTypeId=t.Text.toInteger(e.storageTypeId);this.files=t.Type.isArray(e.files)?e.files:[];this.activityEditorId=String(e.activityEditorId);this.smsUrl=String(e.smsUrl);this.templateCode=(s=e.templateCode)!=null?s:null;this.setChannels(e.channels);this.communications=t.Type.isPlainObject(e.communications)?e.communications:{};this.hasVisibleChannels=t.Text.toBoolean(e.hasVisibleChannels);this.channelIcons=t.Type.isArray(e.channelIcons)?e.channelIcons:[];this.contactCenterUrl=t.Type.isStringFilled(e.contactCenterUrl)?e.contactCenterUrl:"/contact_center/";this.layout={channels:{}};this.setEventNamespace("BX.Crm.ChannelSelector.List");if(I.size===0){I.set("default",this)}I.set(this.id,this)}setChannels(e){this.channels=[];if(t.Type.isArray(e)){e.forEach((e=>{this.channels.push(e)}))}return this}render(){if(this.layout.container){return this.layout.container}this.layout.title=t.Tag.render(c||(c=o`<div class="crm__channel-selector--title">${0}</div>`),t.Text.encode(this.title));if(babelHelpers.classPrivateFieldLooseBase(this,M)[M]||this.isLinkObtainable){this.layout.link=t.Tag.render(d||(d=o`<input type="text" class="crm__channel-selector--footer-link-hidden" value="${0}" />`),t.Text.encode(babelHelpers.classPrivateFieldLooseBase(this,M)[M]));this.layout.footer=t.Tag.render(h||(h=o`<div class="crm__channel-selector--footer" onclick="${0}">
				<div class="crm__channel-selector--footer-copy-link">
					<span class="crm__channel-selector--footer-text">${0}</span>
					${0}
				</div>
			</div>`),babelHelpers.classPrivateFieldLooseBase(this,w)[w].bind(this),t.Loc.getMessage("CRM_CHANNEL_FOOTER_TITLE"),this.layout.link)}else{this.layout.footer=null}this.layout.settings=null;if(this.hasVisibleChannels){this.layout.settings=t.Tag.render(b||(b=o`<button class="ui-btn ui-btn-xs ui-btn-link ui-btn-icon-setting crm__channel-selector--setting-btn" onclick="${0}"></button>`),babelHelpers.classPrivateFieldLooseBase(this,R)[R].bind(this));this.layout.list=t.Tag.render(u||(u=o`<div class="crm__channel-selector--list"></div>`));this.channels.forEach((e=>{const s=this.renderChannel(e);if(s){this.layout.channels[e.id]=s}}))}else{this.layout.list=t.Tag.render(v||(v=o`<div class="crm__channel-selector--body">
			<div class="crm__channel-selector--networks">
				<div class="crm__channel-selector--networks-title">${0}</div>
				<div class="crm__channel-selector--networks-block">
					${0}
					<span class="crm__channel-selector--network-link --link" onclick="${0}">+ 15</span>
				</div>
				<span class="ui-btn ui-btn-xs ui-btn-primary ui-btn-no-caps ui-btn-round" onclick="${0};">${0}</span>
			</div>
		</div>`),t.Loc.getMessage("CRM_CHANNEL_SELECTOR_NO_ACTIVE_CHANNELS_TEXT"),this.channelIcons.map((e=>t.Tag.render(p||(p=o`<span class="crm__channel-selector--network-link --${0}" onclick="${0}"></span>`),e,babelHelpers.classPrivateFieldLooseBase(this,J)[J].bind(this)))),babelHelpers.classPrivateFieldLooseBase(this,J)[J].bind(this),babelHelpers.classPrivateFieldLooseBase(this,J)[J].bind(this),t.Loc.getMessage("CRM_CHANNEL_SELECTOR_ACTIVATE_CHANNELS"))}this.layout.container=t.Tag.render(y||(y=o`<div class="crm__channel-selector--container">
			<div class="crm__channel-selector--header">
				${0}
				${0}
			</div>
			${0}
		</div>`),this.layout.title,this.layout.settings,this.layout.list);if(this.layout.footer){this.layout.container.appendChild(this.layout.footer)}this.adjustAppearance();return this.layout.container}renderChannel(e){const s=()=>{babelHelpers.classPrivateFieldLooseBase(this,Y)[Y](e)};const i=se.getChannelIcon(e);return t.Tag.render(L||(L=o`<div 
			class="crm__channel-selector--channel"
			onclick="${0}"
		>
			${0}
			${0}
			${0}
			<div class="crm__channel-selector--channel-helper">
				<span class="crm__channel-selector--channel-helper-text">${0}</span>
			</div>
		</div>`),s,i?t.Tag.render(f||(f=o`<div class="crm__channel-selector--channel-icon ${0}"></div>`),i):"",this.renderChannelMainTitle(e),this.renderChannelTitle(e),t.Loc.getMessage("CRM_CHANNEL_SELECTOR_SEND_BUTTON"))}renderChannelMainTitle(e){var s;return t.Tag.render(m||(m=o`<div class="crm__channel-selector--channel-main-title">
			${0}
		</div>`),t.Text.encode((s=e.categoryTitle)!=null?s:e.title))}renderChannelTitle(e){if(!e.categoryTitle){return null}return t.Tag.render(P||(P=o`<div class="crm__channel-selector--channel-title">
			${0}
		</div>`),t.Text.encode(e.title))}adjustAppearance(){if(this.hasVisibleChannels){t.Dom.clean(this.layout.list);let e=true;this.channels.forEach((s=>{const i=this.layout.channels[s.id];if(i){this.layout.list.append(i);if(babelHelpers.classPrivateFieldLooseBase(this,j)[j](s)){t.Dom.removeClass(i,"crm__channel-selector--channel-disabled")}else{t.Dom.addClass(i,"crm__channel-selector--channel-disabled")}if(s.isHidden){t.Dom.addClass(i,"crm__channel-selector--channel-hidden")}else{t.Dom.removeClass(i,"crm__channel-selector--channel-hidden");e=false}}}));if(e){t.Dom.addClass(this.layout.list,"--empty")}else{t.Dom.removeClass(this.layout.list,"--empty")}}}setFiles(e){this.files=t.Type.isArray(e)?e:[];this.adjustAppearance();return this}setLink(e){babelHelpers.classPrivateFieldLooseBase(this,M)[M]=e!=null?e:null;this.adjustAppearance();return this}sendEmail(e){if(this.files.length<=0||Number(this.storageTypeId)<=0){const s=this.layout.channels[e.id];babelHelpers.classPrivateFieldLooseBase(this,K)[K]().then((e=>{var s;H==null?void 0:(s=H.items[this.activityEditorId])==null?void 0:s.addEmail({subject:this.documentTitle,body:t.Loc.getMessage("CRM_CHANNEL_SELECTOR_MESSAGE_WITH_LINK",{"#MESSAGE#":this.documentTitle,"#LINK#":e})})})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,q)[q](s,e)}))}else{var s;H==null?void 0:(s=H.items[this.activityEditorId])==null?void 0:s.addEmail({subject:this.documentTitle,diskfiles:this.files,storageTypeID:this.storageTypeId})}}sendSms(e){const i=this.layout.channels[e.id];if(!this.smsUrl){babelHelpers.classPrivateFieldLooseBase(this,q)[q](i,"No sms url");return}babelHelpers.classPrivateFieldLooseBase(this,K)[K]().then((i=>{const l={entityTypeId:this.entityTypeId,entityId:this.entityId,text:t.Loc.getMessage("CRM_CHANNEL_SELECTOR_MESSAGE_WITH_LINK",{"#MESSAGE#":e.id==="bitrix24"&&this.fullBody?this.fullBody:this.body,"#LINK#":i}),providerId:e.id,isProviderFixed:"Y",canUseBitrix24Provider:"Y"};if(e.templateCode){l.templateCode=e.templateCode;l.templatePlaceholders=e.templatePlaceholders;l.templatePlaceholders.DOCUMENT_URL=i;l.isEditable="N"}s.Router.openSlider(this.smsUrl,{width:443,requestMethod:"post",requestParams:l})})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,q)[q](i,e)}))}openMessenger(e){if(!top.BXIM){return}if(!this.communications[e.type]){return}top.BXIM.openMessenger(this.communications[e.type].VALUE,{RECENT:"N",MENU:"N"})}getId(){return this.id}static getDefault(){return I.get("default")}static getById(e){return I.get(e)}static getChannelIcon(e){return e.icon||se.getIconByChannelId(e.id)}static getIconByChannelId(e){if(e==="bitrix24"){return"--service-bitrix24"}if(e===B){return"--service-email"}if(e===F){return"--service-livechat"}if(e==="twilio"){return"--service-whatsapp"}if(e==="ednaru"||e==="ednaruimhpx"){return"--service-edna"}return"--service-sms"}}function te(e){return this.channels.find((s=>s.id===e))}function ie(e){if(!e.isAvailable){return false}const s=this.isLinkObtainable||Boolean(babelHelpers.classPrivateFieldLooseBase(this,M)[M]);const t=H&&this.storageTypeId>0&&this.files.length>0;if(e.type===C||e.type===F){return s}if(e.type===B){return s||t}if(e.type===B&&!(H!=null&&H.items[this.activityEditorId])){console.log("Email channel is disabled because the CrmActivityEditor instance is not found");return false}return e.isAvailable}function le(){if(babelHelpers.classPrivateFieldLooseBase(this,M)[M]){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,M)[M])}if(!this.isLinkObtainable){return Promise.reject()}if(babelHelpers.classPrivateFieldLooseBase(this,N)[N]){return babelHelpers.classPrivateFieldLooseBase(this,N)[N]}babelHelpers.classPrivateFieldLooseBase(this,N)[N]=new Promise(((e,s)=>{babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]();this.emitAsync("getLink").then((t=>{t.forEach((e=>{this.setLink(e)}));if(!babelHelpers.classPrivateFieldLooseBase(this,M)[M]){s()}else{e(babelHelpers.classPrivateFieldLooseBase(this,M)[M])}})).catch(s).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,N)[N]=null;babelHelpers.classPrivateFieldLooseBase(this,Z)[Z]()}))}));return babelHelpers.classPrivateFieldLooseBase(this,N)[N]}function ae(){if(!this.layout.link){return}babelHelpers.classPrivateFieldLooseBase(this,K)[K]().then((e=>{this.layout.link.value=e;this.layout.link.focus();this.layout.link.setSelectionRange(0,this.layout.link.value.length);document.execCommand("copy");babelHelpers.classPrivateFieldLooseBase(this,z)[z](t.Loc.getMessage("CRM_CHANNEL_PUBLIC_LINK_COPIED_NOTIFICATION_MESSAGE"))})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,q)[q](this.layout.footer,e)}))}function ne(){const e=new i.BaseEvent;this.emit("onSettingsClick",e);if(e.isDefaultPrevented()){return}babelHelpers.classPrivateFieldLooseBase(this,x)[x]()}function re(){babelHelpers.classPrivateFieldLooseBase(this,X)[X]().show()}function oe(){const e=[];this.channels.forEach((s=>{if(s.isHidden){e.push({text:s.title,id:s.id,onclick:()=>{babelHelpers.classPrivateFieldLooseBase(this,Y)[Y](s)}})}}));e.push({delimiter:true});e.push({text:t.Loc.getMessage("CRM_CHANNEL_SELECTOR_CHOOSE_FROM_MARKET"),id:"market",href:t.Loc.getMessage("MARKET_BASE_PATH")+T,onclick:(e,s)=>{var t;const i=((t=s.getMenuWindow())==null?void 0:t.getRootMenuWindow())||s.getMenuWindow();i==null?void 0:i.close()}});e.push({delimiter:true});e.push({text:t.Loc.getMessage("CRM_COMMON_ACTION_CONFIG"),id:"configure",onclick:babelHelpers.classPrivateFieldLooseBase(this,U)[U].bind(this)});return e}function ce(){if(!babelHelpers.classPrivateFieldLooseBase(this,A)[A]){babelHelpers.classPrivateFieldLooseBase(this,A)[A]=a.MenuManager.create({id:this.id+"-settings-popup",bindElement:this.layout.settings,items:babelHelpers.classPrivateFieldLooseBase(this,$)[$]()})}return babelHelpers.classPrivateFieldLooseBase(this,A)[A]}function de(){babelHelpers.classPrivateFieldLooseBase(this,X)[X]().close();babelHelpers.classPrivateFieldLooseBase(this,W)[W]().open().then((e=>{if(e.isCanceled){return}if(t.Type.isArray(e.items)){babelHelpers.classPrivateFieldLooseBase(this,D)[D](e.items);babelHelpers.classPrivateFieldLooseBase(this,x)[x]()}}))}function he(e){const s=[];e.forEach((e=>{const t=babelHelpers.classPrivateFieldLooseBase(this,S)[S](e.id);if(t){t.isHidden=e.isHidden;s.push(t)}}));this.setChannels(s);this.adjustAppearance();babelHelpers.classPrivateFieldLooseBase(this,A)[A].destroy();babelHelpers.classPrivateFieldLooseBase(this,A)[A]=null;_.save("crm","channel-selector","items",JSON.stringify(e))}function be(){var e;(e=babelHelpers.classPrivateFieldLooseBase(this,k)[k])==null?void 0:e.close();babelHelpers.classPrivateFieldLooseBase(this,X)[X]().show()}function ue(){const e=[];this.channels.forEach((s=>{e.push({text:s.title,id:s.id,isHidden:s.isHidden})}));return e}function ve(){const e=babelHelpers.classPrivateFieldLooseBase(this,G)[G]();if(!babelHelpers.classPrivateFieldLooseBase(this,k)[k]){babelHelpers.classPrivateFieldLooseBase(this,k)[k]=new r.Menu({items:e,bindElement:this.layout.settings,maxVisibleItems:E});babelHelpers.classPrivateFieldLooseBase(this,k)[k].subscribe("Cancel",(()=>{babelHelpers.classPrivateFieldLooseBase(this,x)[x]()}))}else{babelHelpers.classPrivateFieldLooseBase(this,k)[k].setItems(e)}return babelHelpers.classPrivateFieldLooseBase(this,k)[k]}function pe(e,s){if(!t.Type.isStringFilled(s)){s=t.Loc.getMessage("CRM_CHANNEL_PUBLIC_LINK_NOT_AVAILABLE_NOTIFICATION_MESSAGE")}babelHelpers.classPrivateFieldLooseBase(this,z)[z](s)}function ye(e){if(g){g.notify({content:e})}}function Le(e){const s=new i.BaseEvent;s.setData({channel:e,communications:this.communications[e.type]});this.emit("onChannelClick",s);if(s.isDefaultPrevented()){return}if(!babelHelpers.classPrivateFieldLooseBase(this,j)[j](e)){return}if(e.type===B){this.sendEmail(e);return}if(e.type===C){this.sendSms(e);return}if(e.type===F){this.openMessenger(e)}}function fe(){s.Router.openSlider(this.contactCenterUrl).then((()=>{location.reload()}))}function me(){const e=babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]();if(e){e.show(this.layout.container)}}function Pe(){const e=babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]();if(e){e.hide()}}function He(){if(!babelHelpers.classPrivateFieldLooseBase(this,O)[O]&&l.Loader){babelHelpers.classPrivateFieldLooseBase(this,O)[O]=new l.Loader({size:100,offset:{left:"35%",top:"-25%"}})}return babelHelpers.classPrivateFieldLooseBase(this,O)[O]}e.List=se})(this.BX.Crm.ChannelSelector=this.BX.Crm.ChannelSelector||{},BX.Crm,BX,BX.Event,BX,BX.Main,BX,BX.UI.MenuConfigurable);
//# sourceMappingURL=channel-selector.bundle.map.js