this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(e,s,t,i,l,a,n,r){"use strict";let o=e=>e,c,h,d,b,u,p,v,y,L,f,m,P;const g=t.Reflection.namespace("BX.CrmActivityEditor");const H=t.Reflection.namespace("BX.userOptions");const C=t.Reflection.namespace("BX.UI.Notification.Center");const _="PHONE";const B="EMAIL";const F="IM";const T=4;const E="category/crm_robot_sms/";const I="#LINK#";const M=new Map;var O=babelHelpers.classPrivateFieldLooseKey("link");var N=babelHelpers.classPrivateFieldLooseKey("isInsertLinkInMessage");var k=babelHelpers.classPrivateFieldLooseKey("loader");var A=babelHelpers.classPrivateFieldLooseKey("getLinkPromise");var S=babelHelpers.classPrivateFieldLooseKey("menu");var j=babelHelpers.classPrivateFieldLooseKey("menuConfigurable");var K=babelHelpers.classPrivateFieldLooseKey("getChannelById");var w=babelHelpers.classPrivateFieldLooseKey("isChannelAvailable");var R=babelHelpers.classPrivateFieldLooseKey("getLink");var x=babelHelpers.classPrivateFieldLooseKey("handleFooterClick");var $=babelHelpers.classPrivateFieldLooseKey("handleSettingsClick");var X=babelHelpers.classPrivateFieldLooseKey("openMenu");var U=babelHelpers.classPrivateFieldLooseKey("getMenuItemsInViewMode");var D=babelHelpers.classPrivateFieldLooseKey("getMenu");var V=babelHelpers.classPrivateFieldLooseKey("switchMenuToEditMode");var W=babelHelpers.classPrivateFieldLooseKey("saveSettings");var G=babelHelpers.classPrivateFieldLooseKey("switchMenuToViewMode");var q=babelHelpers.classPrivateFieldLooseKey("getMenuItemsInEditMode");var z=babelHelpers.classPrivateFieldLooseKey("getMenuConfigurable");var J=babelHelpers.classPrivateFieldLooseKey("showGetLinkErrorNotification");var Y=babelHelpers.classPrivateFieldLooseKey("showNotice");var Q=babelHelpers.classPrivateFieldLooseKey("handleChannelClick");var Z=babelHelpers.classPrivateFieldLooseKey("getSmsText");var ee=babelHelpers.classPrivateFieldLooseKey("openContactCenter");var se=babelHelpers.classPrivateFieldLooseKey("showLoader");var te=babelHelpers.classPrivateFieldLooseKey("hideLoader");var ie=babelHelpers.classPrivateFieldLooseKey("getLoader");class le extends i.EventEmitter{constructor(e){var s;super();Object.defineProperty(this,ie,{value:Be});Object.defineProperty(this,te,{value:_e});Object.defineProperty(this,se,{value:Ce});Object.defineProperty(this,ee,{value:He});Object.defineProperty(this,Z,{value:ge});Object.defineProperty(this,Q,{value:Pe});Object.defineProperty(this,Y,{value:me});Object.defineProperty(this,J,{value:fe});Object.defineProperty(this,z,{value:Le});Object.defineProperty(this,q,{value:ye});Object.defineProperty(this,G,{value:ve});Object.defineProperty(this,W,{value:pe});Object.defineProperty(this,V,{value:ue});Object.defineProperty(this,D,{value:be});Object.defineProperty(this,U,{value:de});Object.defineProperty(this,X,{value:he});Object.defineProperty(this,$,{value:ce});Object.defineProperty(this,x,{value:oe});Object.defineProperty(this,R,{value:re});Object.defineProperty(this,w,{value:ne});Object.defineProperty(this,K,{value:ae});Object.defineProperty(this,O,{writable:true,value:void 0});this.isCombineMessageWithLink=true;Object.defineProperty(this,N,{writable:true,value:false});Object.defineProperty(this,k,{writable:true,value:void 0});Object.defineProperty(this,A,{writable:true,value:void 0});Object.defineProperty(this,S,{writable:true,value:void 0});Object.defineProperty(this,j,{writable:true,value:void 0});this.title=t.Type.isStringFilled(e.title)?e.title:t.Loc.getMessage("CRM_CHANNEL_SELECTOR_DEFAULT_TITLE");this.documentTitle=String(e.documentTitle);this.body=String(e.body);this.fullBody=String(e.fullBody);babelHelpers.classPrivateFieldLooseBase(this,O)[O]=String(e.link);this.isLinkObtainable=t.Text.toBoolean(e.isLinkObtainable);this.entityTypeId=t.Text.toInteger(e.entityTypeId);this.entityId=t.Text.toInteger(e.entityId);this.id=t.Type.isStringFilled(e.id)?e.id:this.entityTypeId+"_"+this.entityId+"_"+Math.random().toString().substring(2);this.storageTypeId=t.Text.toInteger(e.storageTypeId);this.files=t.Type.isArray(e.files)?e.files:[];this.activityEditorId=String(e.activityEditorId);this.smsUrl=String(e.smsUrl);this.isCombineMessageWithLink=t.Type.isBoolean(e.isCombineMessageWithLink)?e.isCombineMessageWithLink:true;babelHelpers.classPrivateFieldLooseBase(this,N)[N]=t.Type.isBoolean(e.isInsertLinkInMessage)?e.isInsertLinkInMessage:false;this.templateCode=(s=e.templateCode)!=null?s:null;this.setChannels(e.channels);this.communications=t.Type.isPlainObject(e.communications)?e.communications:{};this.hasVisibleChannels=t.Text.toBoolean(e.hasVisibleChannels);this.channelIcons=t.Type.isArray(e.channelIcons)?e.channelIcons:[];this.contactCenterUrl=t.Type.isStringFilled(e.contactCenterUrl)?e.contactCenterUrl:"/contact_center/";this.layout={channels:{}};this.setEventNamespace("BX.Crm.ChannelSelector.List");if(M.size===0){M.set("default",this)}M.set(this.id,this)}setChannels(e){this.channels=[];if(t.Type.isArray(e)){e.forEach((e=>{this.channels.push(e)}))}return this}render(){if(this.layout.container){return this.layout.container}this.layout.title=t.Tag.render(c||(c=o`<div class="crm__channel-selector--title">${0}</div>`),t.Text.encode(this.title));if(babelHelpers.classPrivateFieldLooseBase(this,O)[O]||this.isLinkObtainable){this.layout.link=t.Tag.render(h||(h=o`<input type="text" class="crm__channel-selector--footer-link-hidden" value="${0}" />`),t.Text.encode(babelHelpers.classPrivateFieldLooseBase(this,O)[O]));this.layout.footer=t.Tag.render(d||(d=o`<div class="crm__channel-selector--footer" onclick="${0}">
				<div class="crm__channel-selector--footer-copy-link">
					<span class="crm__channel-selector--footer-text">${0}</span>
					${0}
				</div>
			</div>`),babelHelpers.classPrivateFieldLooseBase(this,x)[x].bind(this),t.Loc.getMessage("CRM_CHANNEL_FOOTER_TITLE"),this.layout.link)}else{this.layout.footer=null}this.layout.settings=null;if(this.hasVisibleChannels){this.layout.settings=t.Tag.render(b||(b=o`<button class="ui-btn ui-btn-xs ui-btn-link ui-btn-icon-setting crm__channel-selector--setting-btn" onclick="${0}"></button>`),babelHelpers.classPrivateFieldLooseBase(this,$)[$].bind(this));this.layout.list=t.Tag.render(u||(u=o`<div class="crm__channel-selector--list"></div>`));this.channels.forEach((e=>{const s=this.renderChannel(e);if(s){this.layout.channels[e.id]=s}}))}else{this.layout.list=t.Tag.render(p||(p=o`<div class="crm__channel-selector--body">
			<div class="crm__channel-selector--networks">
				<div class="crm__channel-selector--networks-title">${0}</div>
				<div class="crm__channel-selector--networks-block">
					${0}
					<span class="crm__channel-selector--network-link --link" onclick="${0}">+ 15</span>
				</div>
				<span class="ui-btn ui-btn-xs ui-btn-primary ui-btn-no-caps ui-btn-round" onclick="${0};">${0}</span>
			</div>
		</div>`),t.Loc.getMessage("CRM_CHANNEL_SELECTOR_NO_ACTIVE_CHANNELS_TEXT"),this.channelIcons.map((e=>t.Tag.render(v||(v=o`<span class="crm__channel-selector--network-link --${0}" onclick="${0}"></span>`),e,babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].bind(this)))),babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].bind(this),babelHelpers.classPrivateFieldLooseBase(this,ee)[ee].bind(this),t.Loc.getMessage("CRM_CHANNEL_SELECTOR_ACTIVATE_CHANNELS"))}this.layout.container=t.Tag.render(y||(y=o`<div class="crm__channel-selector--container">
			<div class="crm__channel-selector--header">
				${0}
				${0}
			</div>
			${0}
		</div>`),this.layout.title,this.layout.settings,this.layout.list);if(this.layout.footer){this.layout.container.appendChild(this.layout.footer)}this.adjustAppearance();return this.layout.container}renderChannel(e){const s=()=>{babelHelpers.classPrivateFieldLooseBase(this,Q)[Q](e)};const i=le.getChannelIcon(e);return t.Tag.render(L||(L=o`<div 
			class="crm__channel-selector--channel"
			onclick="${0}"
		>
			${0}
			${0}
			${0}
			<div class="crm__channel-selector--channel-helper">
				<span class="crm__channel-selector--channel-helper-text">${0}</span>
			</div>
		</div>`),s,i?t.Tag.render(f||(f=o`<div class="crm__channel-selector--channel-icon ${0}"></div>`),i):"",this.renderChannelMainTitle(e),this.renderChannelTitle(e),t.Loc.getMessage("CRM_CHANNEL_SELECTOR_SEND_BUTTON"))}renderChannelMainTitle(e){var s;return t.Tag.render(m||(m=o`<div class="crm__channel-selector--channel-main-title">
			${0}
		</div>`),t.Text.encode((s=e.categoryTitle)!=null?s:e.title))}renderChannelTitle(e){if(!e.categoryTitle){return null}return t.Tag.render(P||(P=o`<div class="crm__channel-selector--channel-title">
			${0}
		</div>`),t.Text.encode(e.title))}adjustAppearance(){if(this.hasVisibleChannels){t.Dom.clean(this.layout.list);let e=true;this.channels.forEach((s=>{const i=this.layout.channels[s.id];if(i){this.layout.list.append(i);if(babelHelpers.classPrivateFieldLooseBase(this,w)[w](s)){t.Dom.removeClass(i,"crm__channel-selector--channel-disabled")}else{t.Dom.addClass(i,"crm__channel-selector--channel-disabled")}if(s.isHidden){t.Dom.addClass(i,"crm__channel-selector--channel-hidden")}else{t.Dom.removeClass(i,"crm__channel-selector--channel-hidden");e=false}}}));if(e){t.Dom.addClass(this.layout.list,"--empty")}else{t.Dom.removeClass(this.layout.list,"--empty")}}}setFiles(e){this.files=t.Type.isArray(e)?e:[];this.adjustAppearance();return this}setLink(e){babelHelpers.classPrivateFieldLooseBase(this,O)[O]=e!=null?e:null;this.adjustAppearance();return this}sendEmail(e){if(this.files.length<=0||Number(this.storageTypeId)<=0){const s=this.layout.channels[e.id];babelHelpers.classPrivateFieldLooseBase(this,R)[R]().then((e=>{var s;g==null?void 0:(s=g.items[this.activityEditorId])==null?void 0:s.addEmail({subject:this.documentTitle,body:t.Loc.getMessage("CRM_CHANNEL_SELECTOR_MESSAGE_WITH_LINK",{"#MESSAGE#":this.documentTitle,"#LINK#":e})})})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,J)[J](s,e)}))}else{var s;g==null?void 0:(s=g.items[this.activityEditorId])==null?void 0:s.addEmail({subject:this.documentTitle,diskfiles:this.files,storageTypeID:this.storageTypeId})}}sendSms(e){const t=this.layout.channels[e.id];if(!this.smsUrl){babelHelpers.classPrivateFieldLooseBase(this,J)[J](t,"No sms url");return}babelHelpers.classPrivateFieldLooseBase(this,R)[R]().then((t=>{const i={entityTypeId:this.entityTypeId,entityId:this.entityId,text:babelHelpers.classPrivateFieldLooseBase(this,Z)[Z](e,t),providerId:e.id,isProviderFixed:"N",canUseBitrix24Provider:"Y"};if(e.templateCode){i.templateCode=e.templateCode;i.templatePlaceholders=e.templatePlaceholders;i.templatePlaceholders.DOCUMENT_URL=t;i.isEditable="N"}s.Router.openSlider(this.smsUrl,{width:443,requestMethod:"post",requestParams:i})})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,J)[J](t,e)}))}openMessenger(e){if(!top.BXIM){return}if(!this.communications[e.type]){return}top.BXIM.openMessenger(this.communications[e.type].VALUE,{RECENT:"N",MENU:"N"})}getId(){return this.id}static getDefault(){return M.get("default")}static getById(e){return M.get(e)}static getChannelIcon(e){return e.icon||le.getIconByChannelId(e.id)}static getIconByChannelId(e){if(e==="bitrix24"){return"--service-bitrix24"}if(e===B){return"--service-email"}if(e===F){return"--service-livechat"}if(e==="twilio"){return"--service-whatsapp"}if(e==="ednaru"||e==="ednaruimhpx"){return"--service-edna"}return"--service-sms"}}function ae(e){return this.channels.find((s=>s.id===e))}function ne(e){if(!e.isAvailable){return false}const s=this.isLinkObtainable||Boolean(babelHelpers.classPrivateFieldLooseBase(this,O)[O]);const t=g&&this.storageTypeId>0&&this.files.length>0;if(e.type===_||e.type===F){return s}if(e.type===B){return s||t}if(e.type===B&&!(g!=null&&g.items[this.activityEditorId])){console.log("Email channel is disabled because the CrmActivityEditor instance is not found");return false}return e.isAvailable}function re(){if(babelHelpers.classPrivateFieldLooseBase(this,O)[O]){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,O)[O])}if(!this.isLinkObtainable){return Promise.reject()}if(babelHelpers.classPrivateFieldLooseBase(this,A)[A]){return babelHelpers.classPrivateFieldLooseBase(this,A)[A]}babelHelpers.classPrivateFieldLooseBase(this,A)[A]=new Promise(((e,s)=>{babelHelpers.classPrivateFieldLooseBase(this,se)[se]();this.emitAsync("getLink").then((t=>{t.forEach((e=>{this.setLink(e)}));if(!babelHelpers.classPrivateFieldLooseBase(this,O)[O]){s()}else{e(babelHelpers.classPrivateFieldLooseBase(this,O)[O])}})).catch(s).finally((()=>{babelHelpers.classPrivateFieldLooseBase(this,A)[A]=null;babelHelpers.classPrivateFieldLooseBase(this,te)[te]()}))}));return babelHelpers.classPrivateFieldLooseBase(this,A)[A]}function oe(){if(!this.layout.link){return}babelHelpers.classPrivateFieldLooseBase(this,R)[R]().then((e=>{this.layout.link.value=e;this.layout.link.focus();this.layout.link.setSelectionRange(0,this.layout.link.value.length);document.execCommand("copy");babelHelpers.classPrivateFieldLooseBase(this,Y)[Y](t.Loc.getMessage("CRM_CHANNEL_PUBLIC_LINK_COPIED_NOTIFICATION_MESSAGE"))})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,J)[J](this.layout.footer,e)}))}function ce(){const e=new i.BaseEvent;this.emit("onSettingsClick",e);if(e.isDefaultPrevented()){return}babelHelpers.classPrivateFieldLooseBase(this,X)[X]()}function he(){babelHelpers.classPrivateFieldLooseBase(this,D)[D]().show()}function de(){const e=[];this.channels.forEach((s=>{if(s.isHidden){e.push({text:s.title,id:s.id,onclick:()=>{babelHelpers.classPrivateFieldLooseBase(this,Q)[Q](s)}})}}));e.push({delimiter:true});e.push({text:t.Loc.getMessage("CRM_CHANNEL_SELECTOR_CHOOSE_FROM_MARKET"),id:"market",href:t.Loc.getMessage("MARKET_BASE_PATH")+E,onclick:(e,s)=>{var t;const i=((t=s.getMenuWindow())==null?void 0:t.getRootMenuWindow())||s.getMenuWindow();i==null?void 0:i.close()}});e.push({delimiter:true});e.push({text:t.Loc.getMessage("CRM_COMMON_ACTION_CONFIG"),id:"configure",onclick:babelHelpers.classPrivateFieldLooseBase(this,V)[V].bind(this)});return e}function be(){if(!babelHelpers.classPrivateFieldLooseBase(this,S)[S]){babelHelpers.classPrivateFieldLooseBase(this,S)[S]=a.MenuManager.create({id:this.id+"-settings-popup",bindElement:this.layout.settings,items:babelHelpers.classPrivateFieldLooseBase(this,U)[U]()})}return babelHelpers.classPrivateFieldLooseBase(this,S)[S]}function ue(){babelHelpers.classPrivateFieldLooseBase(this,D)[D]().close();babelHelpers.classPrivateFieldLooseBase(this,z)[z]().open().then((e=>{if(e.isCanceled){return}if(t.Type.isArray(e.items)){babelHelpers.classPrivateFieldLooseBase(this,W)[W](e.items);babelHelpers.classPrivateFieldLooseBase(this,X)[X]()}}))}function pe(e){const s=[];e.forEach((e=>{const t=babelHelpers.classPrivateFieldLooseBase(this,K)[K](e.id);if(t){t.isHidden=e.isHidden;s.push(t)}}));this.setChannels(s);this.adjustAppearance();babelHelpers.classPrivateFieldLooseBase(this,S)[S].destroy();babelHelpers.classPrivateFieldLooseBase(this,S)[S]=null;H.save("crm","channel-selector","items",JSON.stringify(e))}function ve(){var e;(e=babelHelpers.classPrivateFieldLooseBase(this,j)[j])==null?void 0:e.close();babelHelpers.classPrivateFieldLooseBase(this,D)[D]().show()}function ye(){const e=[];this.channels.forEach((s=>{e.push({text:s.title,id:s.id,isHidden:s.isHidden})}));return e}function Le(){const e=babelHelpers.classPrivateFieldLooseBase(this,q)[q]();if(!babelHelpers.classPrivateFieldLooseBase(this,j)[j]){babelHelpers.classPrivateFieldLooseBase(this,j)[j]=new r.Menu({items:e,bindElement:this.layout.settings,maxVisibleItems:T});babelHelpers.classPrivateFieldLooseBase(this,j)[j].subscribe("Cancel",(()=>{babelHelpers.classPrivateFieldLooseBase(this,X)[X]()}))}else{babelHelpers.classPrivateFieldLooseBase(this,j)[j].setItems(e)}return babelHelpers.classPrivateFieldLooseBase(this,j)[j]}function fe(e,s){if(!t.Type.isStringFilled(s)){s=t.Loc.getMessage("CRM_CHANNEL_PUBLIC_LINK_NOT_AVAILABLE_NOTIFICATION_MESSAGE")}babelHelpers.classPrivateFieldLooseBase(this,Y)[Y](s)}function me(e){if(C){C.notify({content:e})}}function Pe(e){const s=new i.BaseEvent;s.setData({channel:e,communications:this.communications[e.type]});this.emit("onChannelClick",s);if(s.isDefaultPrevented()){return}if(!babelHelpers.classPrivateFieldLooseBase(this,w)[w](e)){return}if(e.type===B){this.sendEmail(e);return}if(e.type===_){this.sendSms(e);return}if(e.type===F){this.openMessenger(e)}}function ge(e,s){const i=e.id==="bitrix24"&&this.fullBody?this.fullBody:this.body;if(this.isCombineMessageWithLink){return t.Loc.getMessage("CRM_CHANNEL_SELECTOR_MESSAGE_WITH_LINK",{"#MESSAGE#":i,"#LINK#":s})}if(babelHelpers.classPrivateFieldLooseBase(this,N)[N]){return i.replace(I,s)}return i}function He(){s.Router.openSlider(this.contactCenterUrl).then((()=>{location.reload()}))}function Ce(){const e=babelHelpers.classPrivateFieldLooseBase(this,ie)[ie]();if(e){e.show(this.layout.container)}}function _e(){const e=babelHelpers.classPrivateFieldLooseBase(this,ie)[ie]();if(e){e.hide()}}function Be(){if(!babelHelpers.classPrivateFieldLooseBase(this,k)[k]&&l.Loader){babelHelpers.classPrivateFieldLooseBase(this,k)[k]=new l.Loader({size:100,offset:{left:"35%",top:"-25%"}})}return babelHelpers.classPrivateFieldLooseBase(this,k)[k]}e.List=le})(this.BX.Crm.ChannelSelector=this.BX.Crm.ChannelSelector||{},BX.Crm,BX,BX.Event,BX,BX.Main,BX,BX.UI.MenuConfigurable);
//# sourceMappingURL=channel-selector.bundle.map.js