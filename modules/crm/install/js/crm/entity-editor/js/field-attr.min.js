BX.namespace("BX.Crm");if(typeof BX.Crm.EntityFieldAttributeType==="undefined"){BX.Crm.EntityFieldAttributeType=BX.UI.EntityFieldAttributeType}if(typeof BX.Crm.EntityFieldAttributePhaseGroupType==="undefined"){BX.Crm.EntityFieldAttributePhaseGroupType=BX.UI.EntityFieldAttributePhaseGroupType}if(typeof BX.Crm.EntityFieldAttributeManager==="undefined"){BX.Crm.EntityFieldAttributeManager=function(){this._id="";this._settings=null;this._entityTypeId=BX.CrmEntityType.enumeration.undefined;this._entityScope=""};BX.Crm.EntityFieldAttributeManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",BX.CrmEntityType.enumeration.undefined);this._entityScope=BX.prop.getString(this._settings,"entityScope","")},isPermitted:function(){return BX.prop.getBoolean(this._settings,"isPermitted",true)},isPhaseDependent:function(){return BX.prop.getBoolean(this._settings,"isPhaseDependent",true)},getEntityPhases:function(){var t=BX.prop.getArray(this._settings,"entityPhases",null);if(t){return t}var e;if(typeof BX.CrmProgressManager!=="undefined"&&BX.CrmProgressManager.hasOwnProperty("current")){e=BX.CrmProgressManager.current.resolve(this._entityTypeId)}return e?e.getInfos(this._entityScope):[]},areMultiTypePhasesEnabled:function(){if(typeof BX.CrmProgressManager!=="undefined"&&BX.CrmProgressManager.hasOwnProperty("current")){return BX.CrmProgressManager.current.isMultiType(this._entityTypeId)}return false},createFieldConfigurator:function(t,e){return BX.Crm.EntityFieldAttributeConfigurator.create(this._id,{typeId:e,phases:this.getEntityPhases(),areMultiTypePhasesEnabled:this.areMultiTypePhasesEnabled(),captions:BX.prop.getObject(this._settings,"captions",{}),config:t?t.getAttributeConfiguration(e):null,isPermitted:this.isPermitted(),isPhaseDependent:this.isPhaseDependent(),isAttrConfigButtonHidden:BX.prop.getBoolean(this._settings,"isAttrConfigButtonHidden",false),lockScript:BX.prop.getString(this._settings,"lockScript","")})},saveConfiguration:function(t,e){if(!this.isPermitted()){return}BX.ajax.runAction("crm.api.fieldAttribute.saveConfiguration",{data:{config:t,fieldName:e,entityTypeName:BX.CrmEntityType.resolveName(this._entityTypeId),entityScope:this._entityScope}})},removeConfiguration:function(t,e){if(!this.isPermitted()){return}BX.ajax.runAction("crm.api.fieldAttribute.removeConfiguration",{data:{type:t,fieldName:e,entityTypeName:BX.CrmEntityType.resolveName(this._entityTypeId),entityScope:this._entityScope}})}};BX.Crm.EntityFieldAttributeManager.create=function(t,e){var i=new BX.Crm.EntityFieldAttributeManager;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityFieldAttributeConfigurator==="undefined"){BX.Crm.EntityFieldAttributeConfigurator=function(){this._id="";this._settings=null;this._typeId=BX.Crm.EntityFieldAttributeType.undefined;this._fieldName="";this._config=null;this._captions=null;this._phases=null;this._groups=null;this._button=null;this._wrapper=null;this._popup=null;this._label=null;this._switchCheckBox=null;this._switchCheckBoxHandler=BX.delegate(this.onSwitchCheckBoxClick,this);this._areMultiTypePhasesEnabled=false;this._isPermitted=true;this._isPhaseDependent=true;this._isEnabled=true;this._isOpened=false;this._isChanged=false;this._closingNotifier=BX.CrmNotifier.create(this)};BX.Crm.EntityFieldAttributeConfigurator.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._isPermitted=BX.prop.getBoolean(this._settings,"isPermitted",true);this._isPhaseDependent=BX.prop.getBoolean(this._settings,"isPhaseDependent",true);this._typeId=BX.prop.getInteger(this._settings,"type",BX.Crm.EntityFieldAttributeType.required);this._fieldName=BX.prop.getString(this._settings,"fieldName","");this._captions=BX.prop.getObject(this._settings,"captions",{});this._config=BX.prop.getObject(this._settings,"config",{});var i=BX.prop.getInteger(this._config,"typeId",BX.Crm.EntityFieldAttributeType.undefined);if(i===BX.Crm.EntityFieldAttributeType.undefined){this._config.typeId=this._typeId}else if(i!==this._typeId){throw"EntityFieldAttributeConfigurator. Configuration type mismatch."}this._areMultiTypePhasesEnabled=BX.prop.getBoolean(this._settings,"areMultiTypePhasesEnabled",false);this._phases=BX.prop.getArray(this._settings,"phases",[]);var s=[];var r=[];for(var n=0,o=this._phases.length;n<o;n++){var a=this._phases[n];var h=a["semantics"];if(h==="process"||h==="success"){s.push(a)}else{r.push(a)}}this._groups={};this.createGroup("general","",[{id:"GENERAL",name:this.getCaption("GROUP_TYPE_GENERAL")}],{phaseGroupTypeId:BX.Crm.EntityFieldAttributePhaseGroupType.general});if(s.length>0){this.createGroup("pipeline",this.getCaption("GROUP_TYPE_PIPELINE"),s,{phaseGroupTypeId:BX.Crm.EntityFieldAttributePhaseGroupType.pipeline})}if(r.length>0){this.createGroup("junk",this.getCaption("GROUP_TYPE_JUNK"),r,{phaseGroupTypeId:BX.Crm.EntityFieldAttributePhaseGroupType.junk})}this._isEnabled=!this.isEmpty()},getId:function(){return this._id},getTypeId:function(){return this._typeId},getCaption:function(t){return BX.prop.getString(this._captions,t,t)},getTitle:function(){if(this._typeId===BX.Crm.EntityFieldAttributeType.required){var t=BX.prop.getBoolean(this._settings,"isAttrConfigButtonHidden",false);return this.getCaption("REQUIRED_FULL")+(t?"":":")}return""},getPhaseIndexById:function(t){for(var e=0,i=this._phases.length;e<i;e++){if(this._phases[e]["id"]===t){return e}}return-1},getPhaseInfoById:function(t){var e=this.getPhaseIndexById(t);return e>=0?this._phases[e]:null},resolvePhaseName:function(t){if(t===""){return""}var e=this.getPhaseInfoById(t);return e?BX.prop.getString(e,"name",t):t},resolvePhaseGroupType:function(t){if(t===""){return BX.Crm.EntityFieldAttributePhaseGroupType.undefined}var e=this.getPhaseInfoById(t);if(!e){return BX.Crm.EntityFieldAttributePhaseGroupType.undefined}var i=BX.prop.getString(e,"semantics","");return i==="process"||i==="success"?BX.Crm.EntityFieldAttributePhaseGroupType.pipeline:BX.Crm.EntityFieldAttributePhaseGroupType.junk},prepareLegendData:function(){var t=BX.Crm.EntityPhaseLayout.getCurrent();var e=BX.prop.getArray(this._config,"groups",[]);for(var i=0,s=e.length;i<s;i++){var r=e[i];var n=BX.prop.getArray(r,"items",[]);if(n.length>0){var o=BX.prop.getString(n[0],"startPhaseId","");var a=this.getPhaseInfoById(o);if(a){var h=BX.prop.getString(a,"color","");if(h===""){var p=BX.prop.getString(a,"semantics","");if(p!==""){h=t.getBackgroundColor(p)}}var u=BX.Crm.EntityFieldAttributeConfigurator.calculateTextColor(h);return{text:BX.prop.getString(a,"name",o),backgroundColor:h,color:u}}}}return{text:this.getCaption("GROUP_TYPE_GENERAL"),backgroundColor:"#CED4DC",color:"#333"}},adjust:function(){var t=this.isEnabled();var e=this.isEmpty();if(t&&e){this._config=this.getDefaultConfiguration()}else if(!t&&!e){this._config=this.getEmptyConfiguration()}if(this._label){this._label.innerHTML=BX.util.htmlspecialchars(this.getTitle())}if(this._button){this._button.adjust()}},setEnabled:function(t){this._isEnabled=!!t},isEnabled:function(){return this._isEnabled},isChanged:function(){return this._isChanged},isEmpty:function(){return BX.prop.getArray(this._config,"groups",[]).length===0},isCustomized:function(){var t=BX.prop.getArray(this._config,"groups",[]);for(var e=0,i=t.length;e<i;e++){var s=BX.prop.getInteger(t[e],"phaseGroupTypeId",BX.Crm.EntityFieldAttributePhaseGroupType.undefined);if(s===BX.Crm.EntityFieldAttributePhaseGroupType.undefined){continue}if(s!==BX.Crm.EntityFieldAttributePhaseGroupType.general){return true}}return false},isPermitted:function(){return this._isPermitted},isPhaseDependent:function(){return this._isPhaseDependent},runLockScript:function(){var lockScript=BX.prop.getString(this._settings,"lockScript","");if(lockScript!==""){eval(lockScript)}},getDefaultConfiguration:function(){return{typeId:this._typeId,groups:[{phaseGroupTypeId:BX.Crm.EntityFieldAttributePhaseGroupType.general}]}},getEmptyConfiguration:function(){return{typeId:this._typeId,groups:[]}},getConfiguration:function(){return this._config},acceptChanges:function(){if(!(this.isPermitted()&&this.isChanged())){return}this._config=this.getEmptyConfiguration();if(this._groups["general"].isSelected()||this._groups["pipeline"].isFullySelected()&&!this._groups["junk"].isSelected()&&!this._areMultiTypePhasesEnabled){this._config["groups"].push({phaseGroupTypeId:BX.Crm.EntityFieldAttributePhaseGroupType.general})}else{this._groups["pipeline"].acceptChanges(this._config);this._groups["junk"].acceptChanges(this._config)}this._isChanged=false},applyConfiguration:function(){for(var t in this._groups){if(!this._groups.hasOwnProperty(t)){continue}this._groups[t].applyConfiguration(this._config)}},createGroup:function(t,e,i,s){if(!this._groups){this._groups={}}this._groups[t]=BX.Crm.EntityFieldAttributePhaseGroup.create(t,{title:e,configurator:this,isReadOnly:!this.isPhaseDependent(),phases:i,phaseGroupTypeId:BX.prop.getInteger(s,"phaseGroupTypeId",BX.Crm.EntityFieldAttributePhaseGroupType.undefined)});return this._groups[t]},hasSelectedGroup:function(){for(var t in this._groups){if(!this._groups.hasOwnProperty(t)){continue}if(this._groups[t].isSelected()){return true}}return false},processGroupChange:function(t){if(!this.isPhaseDependent()){this.runLockScript();return}var e=t.getId();if(e==="general"){if(t.isSelected()){this._groups["pipeline"].setSelected(true);this._groups["junk"].setSelected(false)}else if(!this._areMultiTypePhasesEnabled){this._groups["pipeline"].setSelected(false)}}else if(e==="pipeline"){if(!this._areMultiTypePhasesEnabled){this._groups["general"].setSelected(t.isFullySelected()&&!this._groups["junk"].isSelected())}else if(!t.isFullySelected()){this._groups["general"].setSelected(false)}}else if(e==="junk"){if(t.isSelected()&&this._groups["general"].isSelected()){this._groups["general"].setSelected(false)}else if(!t.isSelected()&&this._groups["pipeline"].isFullySelected()&&!this._areMultiTypePhasesEnabled){this._groups["general"].setSelected(true)}}this.setEnabled(this.hasSelectedGroup());if(!this.isChanged()){this._isChanged=true}},addClosingListener:function(t){this._closingNotifier.addListener(t)},removeClosingListener:function(t){this._closingNotifier.removeListener(t)},open:function(t){if(this._isOpened){return}this._popup=new BX.PopupWindow(this._id,t,{autoHide:true,draggable:false,closeByEsc:true,offsetLeft:0,offsetTop:0,zIndex:BX.prop.getInteger(this._settings,"zIndex",0),bindOptions:{forceBindPosition:true},content:this.prepareContent(),events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}});this._popup.show()},close:function(){if(!this._isOpened){return}if(this._popup){this._popup.close()}},prepareContent:function(){this._wrapper=BX.create("div",{props:{className:"crm-entity-popup-field-addiction-step"}});var t=BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-container"}});this._wrapper.appendChild(t);for(var e in this._groups){if(!this._groups.hasOwnProperty(e)){continue}var i=this._groups[e];i.setContainer(t);i.layout()}return this._wrapper},onPopupShow:function(){this._isOpened=true;this.applyConfiguration()},onPopupClose:function(){if(this.isPermitted()){this.acceptChanges();if(this._switchCheckBox){this._switchCheckBox.checked=this._isEnabled}this.adjust()}if(this._popup){this._popup.destroy()}this._closingNotifier.notify([{config:this._config}])},onPopupDestroy:function(){this._isOpened=false;this._wrapper=null;this._innerWrapper=null;this._popup=null},getButton:function(){if(!this._button){this._button=BX.Crm.EntityFieldAttributeConfigButton.create(this._id,{configurator:this,isHidden:BX.prop.getBoolean(this._settings,"isAttrConfigButtonHidden",false)})}return this._button},getSwitchCheckBox:function(){return this._switchCheckBox},setSwitchCheckBox:function(t){if(this._switchCheckBox){BX.unbind(this._switchCheckBox,"click",this._switchCheckBoxHandler)}this._switchCheckBox=t;if(this._switchCheckBox){BX.bind(this._switchCheckBox,"click",this._switchCheckBoxHandler)}},getLabel:function(){return this._label},setLabel:function(t){this._label=t},onSwitchCheckBoxClick:function(t){this.setEnabled(this._switchCheckBox.checked);this.adjust()}};BX.Crm.EntityFieldAttributeConfigurator.calculateTextColor=function(t){var e,i,s;if(t>7){var r=t.split("(")[1].split(")")[0];r=r.split(",");e=parseInt(r[0]);i=parseInt(r[1]);s=parseInt(r[2])}else{if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(t)){var n=t.substring(1).split("");if(n.length===3){n=[n[0],n[0],n[1],n[1],n[2],n[2]]}n="0x"+n.join("");e=n>>16&255;i=n>>8&255;s=n&255}}var o=.21*e+.72*i+.07*s;return o<145?"#fff":"#333"};BX.Crm.EntityFieldAttributeConfigurator.create=function(t,e){var i=new BX.Crm.EntityFieldAttributeConfigurator;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityFieldAttributePhaseGroup==="undefined"){BX.Crm.EntityFieldAttributePhaseGroup=function(){this._id="";this._settings=null;this._phases=null;this._phaseGroupTypeId=BX.Crm.EntityFieldAttributePhaseGroupType.undefined;this._title="";this._isReadOnly=false;this._configurator=null;this._container=null;this._phaseCheckBoxes=null};BX.Crm.EntityFieldAttributePhaseGroup.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._phases=BX.prop.getArray(this._settings,"phases",[]);this._phaseGroupTypeId=BX.prop.getInteger(this._settings,"phaseGroupTypeId",BX.Crm.EntityFieldAttributePhaseGroupType.undefined);this._isReadOnly=BX.prop.getBoolean(this._settings,"isReadOnly",false);this._title=BX.prop.getString(this._settings,"title",this._id);this._configurator=BX.prop.get(this._settings,"configurator",null);this._container=BX.prop.getElementNode(this._settings,"container",null)},getId:function(){return this._id},getPhaseGroupTypeId:function(){return this._phaseGroupTypeId},isReadOnly:function(){return this._isReadOnly},isSelected:function(){for(var t=0,e=this._phaseCheckBoxes.length;t<e;t++){if(this._phaseCheckBoxes[t].checked){return true}}return false},isFullySelected:function(){for(var t=0,e=this._phaseCheckBoxes.length;t<e;t++){if(!this._phaseCheckBoxes[t].checked){return false}}return true},setSelected:function(t){t=!!t;for(var e=0,i=this._phaseCheckBoxes.length;e<i;e++){this._phaseCheckBoxes[e].checked=t}},applyConfiguration:function(t){this.setSelected(false);var e=BX.prop.getArray(t,"groups",[]);for(var i=0,s=e.length;i<s;i++){var r=e[i];var n=BX.prop.getArray(r,"items",[]);var o=BX.prop.getInteger(r,"phaseGroupTypeId",BX.Crm.EntityFieldAttributePhaseGroupType.undefined);if(o===BX.Crm.EntityFieldAttributePhaseGroupType.undefined&&n.length>0){o=this._configurator.resolvePhaseGroupType(BX.prop.getString(n[0],"startPhaseId",""))}if(o===BX.Crm.EntityFieldAttributePhaseGroupType.general){if(this._phaseGroupTypeId!==BX.Crm.EntityFieldAttributePhaseGroupType.junk){this.setSelected(true)}}else if(o===this._phaseGroupTypeId&&n.length>0){var a;if(this._phaseGroupTypeId===BX.Crm.EntityFieldAttributePhaseGroupType.pipeline){var h=[];for(a=0,itemQty=n.length;a<itemQty;a++){var p=BX.prop.getString(n[a],"startPhaseId","");var u=BX.prop.getString(n[a],"finishPhaseId","");if(BX.Type.isStringFilled(p)&&BX.Type.isStringFilled(u)){var l=false;var c=false;var d=[];var f;for(f=0;f<this._phases.length;f++){if(!l&&this._phases[f]["id"]===p){l=true}if(l&&!c){d.push(this._phases[f]["id"]);if(this._phases[f]["id"]===u){c=true}}}if(l&&c){for(f=0;f<d.length;f++){if(h.indexOf(d[f])<0){h.push(d[f])}}}}}for(f=0;f<h.length;f++){this.selectPhaseCheckBox(h[f])}}else if(this._phaseGroupTypeId===BX.Crm.EntityFieldAttributePhaseGroupType.junk){for(a=0,itemQty=n.length;a<itemQty;a++){this.selectPhaseCheckBox(BX.prop.getString(n[a],"startPhaseId",""))}}}}},acceptChanges:function(t){var e,i,s;var r=[];if(this._phaseGroupTypeId===BX.Crm.EntityFieldAttributePhaseGroupType.pipeline){var n;var o;var a=false;var h="";var p="";var u=this._phaseCheckBoxes.length-1;for(e=0;e<=u;e++){n=this._phaseCheckBoxes[e].checked;o=e===u?false:this._phaseCheckBoxes[e+1].checked;if(!a&&n){a=true;h=this._phaseCheckBoxes[e]["id"]}if(a&&!o){a=false;p=this._phaseCheckBoxes[e]["id"];r.push({startPhaseId:h,finishPhaseId:p})}}}else if(this._phaseGroupTypeId===BX.Crm.EntityFieldAttributePhaseGroupType.junk){for(e=0,i=this._phaseCheckBoxes.length;e<i;e++){s=this._phaseCheckBoxes[e];if(!s.checked){continue}r.push({startPhaseId:s["id"],finishPhaseId:s["id"]})}}if(r.length>0){t["groups"].push({phaseGroupTypeId:this._phaseGroupTypeId,items:r})}},getContainer:function(){return this._container},setContainer:function(t){this._container=t},createPhaseCheckBox:function(t){if(!this._phaseCheckBoxes){this._phaseCheckBoxes=[]}var e=BX.create("input",{props:{id:t,type:"checkbox"},events:{click:BX.delegate(this.onCheckBoxClick,this)}});this._phaseCheckBoxes.push(e);return e},findCheckBox:function(t){for(var e=0,i=this._phaseCheckBoxes.length;e<i;e++){var s=this._phaseCheckBoxes[e];if(s["id"]===t){return s}}return null},selectPhaseCheckBox:function(t){var e=this.findCheckBox(t);if(!e){return}e.checked=true;this.processCheckBoxChange(e,false)},layout:function(){if(!this._container){return}this._phaseCheckBoxes=[];if(this._title!==""){this._container.appendChild(BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-title"},children:[BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-title-line"}}),BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-title-text"},text:this._title}),BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-title-line"}})]}))}var t=BX.Crm.EntityPhaseLayout.getCurrent();var e=BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list"}});for(var i=0,s=this._phases.length;i<s;i++){var r=this._phases[i];var n=BX.create("label",{props:{className:"crm-entity-popup-field-addiction-step-item"},children:[this.createPhaseCheckBox(r["id"]),BX.create("span",{props:{className:"crm-entity-popup-field-addiction-step-item-text"},text:r["name"]})]});var o=BX.prop.getString(r,"color","");if(o===""){var a=BX.prop.getString(r,"semantics","");if(a!==""){o=t.getBackgroundColor(a)}}if(o!==""){n.style.backgroundColor=o;n.style.color=t.calculateTextColor(o)}else{BX.addClass(n,"crm-entity-popup-field-addiction-step-item-default")}e.appendChild(n)}this._container.appendChild(e)},onCheckBoxClick:function(t){this.processCheckBoxChange(BX.getEventTarget(t),true)},processCheckBoxChange:function(t,e){if(this._isReadOnly){t.checked=!t.checked}if(e){this._configurator.processGroupChange(this)}}};BX.Crm.EntityFieldAttributePhaseGroup.create=function(t,e){var i=new BX.Crm.EntityFieldAttributePhaseGroup;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityFieldAttributeConfigButton==="undefined"){BX.Crm.EntityFieldAttributeConfigButton=function(){this._id="";this._settings=null;this._configurator=null;this._wrapper=null;this._icon=null};BX.Crm.EntityFieldAttributeConfigButton.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._configurator=BX.prop.get(this._settings,"configurator",null)},isHidden:function(){return BX.prop.getBoolean(this._settings,"isHidden",false)},onClick:function(t){if(this._configurator.isEnabled()){this._configurator.open(this._wrapper)}},adjust:function(){var t=this._configurator.prepareLegendData();if(this._configurator.isEnabled()){BX.removeClass(this._wrapper,"crm-entity-new-field-addiction-step-disabled")}else{BX.addClass(this._wrapper,"crm-entity-new-field-addiction-step-disabled")}this._wrapper.style.backgroundColor=BX.prop.getString(t,"backgroundColor","#CED4DC");this._wrapper.style.color=BX.prop.getString(t,"color","#333");var e=this._wrapper.querySelector("span.crm-entity-new-field-addiction-step-arrow");if(e){e.style.color=BX.prop.getString(t,"color","#333")}var i=this._wrapper.querySelector("span.crm-entity-new-field-addiction-step-name");if(i){i.innerHTML=BX.util.htmlspecialchars(BX.prop.getString(t,"text","..."))}},prepareLayout:function(){var t=this._configurator.prepareLegendData();this._wrapper=BX.create("span",{props:{className:"crm-entity-new-field-addiction-step"},style:{backgroundColor:BX.prop.getString(t,"backgroundColor","#CED4DC"),color:BX.prop.getString(t,"color","#333")},children:[BX.create("span",{props:{className:"crm-entity-new-field-addiction-step-name"},text:BX.prop.getString(t,"text","")}),BX.create("span",{props:{className:"crm-entity-new-field-addiction-step-arrow"},children:[BX.create("span",{props:{className:"crm-entity-new-field-addiction-step-arrow-inner"}})]})]});if(this.isHidden()){this._wrapper.style.display="none"}BX.bind(this._wrapper,"click",BX.delegate(this.onClick,this));return[this._wrapper]}};BX.Crm.EntityFieldAttributeConfigButton.create=function(t,e){var i=new BX.Crm.EntityFieldAttributeConfigButton;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityFieldVisibilityConfigurator==="undefined"){BX.Crm.EntityFieldVisibilityConfigurator=function(){this._id="";this._settings=null;this._config=null;this._button=null;this._wrapper=null;this._label=null;this._switchCheckBox=null;this._switchCheckBoxHandler=BX.delegate(this.onSwitchCheckBoxClick,this);this._onSquareClick=BX.delegate(this.onSquareClick,this);this._isEnabled=false;this._isChanged=false;this._isPermitted=true;this._items=[];this._restriction={}};BX.Crm.EntityFieldVisibilityConfigurator.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._config=BX.prop.getObject(this.getSettings(),"config",{});this._editor=BX.prop.get(this.getSettings(),"editor",{});this._field=BX.prop.get(this.getSettings(),"field",null);this._restriction=BX.prop.getObject(this.getSettings(),"restriction",{});this._isPermitted=BX.prop.getBoolean(this._restriction,"isPermitted",true);this._squares=[];this._isEnabled=!this.isEmpty();this.initializeItems()},initializeItems:function(){this._items=[];var t=BX.prop.getObject(this._config,"accessCodes",[]);for(var e in t){this.addItem(this.createUserInfo(t[e]))}},addItem:function(t){if(this._items===null){this._items=[]}this._items.push(t);return t},createUserInfo:function(t){return{ID:t.id,FORMATTED_NAME:BX.util.htmlspecialcharsback(BX.prop.getString(t,"name",""))}},onUserFieldConfigurationSave:function(t,e){var i={};t=t||null;if(this._isChanged&&(t||(t=this.getSettings().field.getId()))){var s=this._items||[];if(!this.isEnabled()){s=[];this.removeItems()}this.saveConfiguration(s,t,e)}},getTitle:function(){return BX.Crm.EntityFieldVisibilityConfigurator.messages["titleField"]},saveConfiguration:function(t,e,i){i=i||this.getSettings().editor.getEntityTypeId();this._isChanged=BX.ajax.runAction("crm.api.userFieldVisibility.saveConfiguration",{data:{accessCodes:t.length?t:false,fieldName:e,entityTypeId:i}}).then(function(t,e){return true})},formatAccessCodesFromConfig:function(t){var e={};t.forEach(function(t,i,s){var r={id:t.ID,name:t.FORMATTED_NAME};e[t.ID]=r});return e},getId:function(){return this._id},adjust:function(){this.removeSquares();this._items.forEach(function(t,e,i){this.setSquare(t.FORMATTED_NAME,t.ID)},this);this.getButton().adjust()},getSquares:function(){return BX.Filter.Utils.getByClass(this.getButton().getSelectUserControl(),"main-ui-square",true)},removeSquares:function(){this.getSquares().forEach(BX.remove)},setSquare:function(t,e){var i=BX.decl(this.createSquareData(t,e));i.setAttribute("data-user-id",e);BX.bind(i,"click",BX.delegate(this._onSquareClick,this));var s=this.getSquares();if(!s.length){BX.prepend(i,this.getButton().getSelectUserControl())}else{BX.insertAfter(i,s[s.length-1])}},createSquareData:function(t,e){return{block:"main-ui-square",name:t,item:{_label:t,_value:e}}},onSquareClick:function(t){if(!this._isPermitted){this.runLockScript()}else{var e=t.target.parentElement;var i=e.getAttribute("data-user-id");this._isChanged=true;this.removeItem(i);this.adjust()}},setEnabled:function(t){this._isEnabled=!!t},isEnabled:function(){return this._isEnabled},isEmpty:function(){return Object.keys(BX.prop.getObject(this.getConfiguration(),"accessCodes",{})).length===0},getConfiguration:function(){return this._config},getSettings:function(){return this._settings},open:function(t){if(!this._isPermitted){this.runLockScript()}else{this.getUserSelector().open(t)}},close:function(){if(this.getUserSelector()){this.getUserSelector().close()}},prepareContent:function(){this._wrapper=BX.create("div",{props:{className:"crm-entity-popup-field-addiction-step"}});var t=BX.create("div",{props:{className:"crm-entity-popup-field-addiction-steps-list-container"}});this._wrapper.appendChild(t);return this._wrapper},getButton:function(){if(!this._button){this._button=BX.Crm.EntityFieldVisibilityConfigButton.create(this._id,{configurator:this})}return this._button},getSwitchCheckBox:function(){return this._switchCheckBox},setSwitchCheckBox:function(t){if(this._switchCheckBox){BX.unbind(this._switchCheckBox,"click",this._switchCheckBoxHandler)}this._switchCheckBox=t;if(this._switchCheckBox){BX.bind(this._switchCheckBox,"click",this._switchCheckBoxHandler)}},onSwitchCheckBoxClick:function(t){if(!this._isPermitted){this.runLockScript();this._switchCheckBox.checked=this._isEnabled}else{this._isChanged=true;this.setEnabled(this._switchCheckBox.checked);if(!this._switchCheckBox.checked){this._items=[]}this.adjust()}},runLockScript:function(){var lockScript=BX.prop.getString(this._restriction,"restrictionCallback","");if(lockScript!==""){eval(lockScript)}},getUserSelector:function(){if(!this._userSelector){this._userSelector=BX.UI.EntityEditorUserSelector.create(this._id,{callback:BX.delegate(this.processItemSelect,this)})}return this._userSelector},processItemSelect:function(t,e){this._isChanged=true;var i=BX.prop.getString(e,"id","");if(this.findItemIndexById(i)>=0){this.removeItem(i);this.adjust();return}this.addItem(this.createUserInfo(e));this.adjust()},findItemIndexById:function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e].ID===t){return e}}return-1},getItems:function(){return this._items||[]},removeItems:function(){this._items=[]},removeItem:function(t){var e=this.findItemIndexById(t);if(e>=0){this._items=BX.util.deleteFromArray(this._items,e)}},isCustomized:function(){var t=BX.prop.getObject(this._config,"accessCodes",[]);return!!Object.keys(t).length}};BX.Crm.EntityFieldVisibilityConfigurator.create=function(t,e){var i=new BX.Crm.EntityFieldVisibilityConfigurator;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityFieldVisibilityConfigButton==="undefined"){BX.Crm.EntityFieldVisibilityConfigButton=function(){this._id="";this._settings=null;this._configurator=null;this._wrapper=null;this._selectUserControl=null;this._addButton=null};BX.Crm.EntityFieldVisibilityConfigButton.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._configurator=BX.prop.get(this._settings,"configurator",null);this.adjust()},onClick:function(t){t.preventDefault();if(this._configurator.isEnabled()){this._configurator.open(this._wrapper)}},adjust:function(){if(this._configurator.isEnabled()){BX.removeClass(this._wrapper,"crm-entity-new-field-visibility-disabled");BX.Dom.show(this._wrapper)}else{BX.addClass(this._wrapper,"crm-entity-new-field-visibility-disabled");BX.Dom.hide(this._wrapper)}},prepareLayout:function(){this._addButton=BX.create("a",{props:{className:"feed-add-destination-link"},attrs:{href:"#"},text:BX.Crm.EntityFieldVisibilityConfigurator.messages["addUserButton"]});BX.bind(this._addButton,"click",BX.delegate(this.onClick,this));this._selectUserControl=BX.create("div",{props:{className:"main-ui-control-entity main-ui-control userfieldemployee-control"},dataset:{multiple:true},children:[this._addButton]});var t=BX.create("label",{text:BX.Crm.EntityFieldVisibilityConfigurator.messages["labelField"]});this._wrapper=BX.create("div",{props:{className:"crm-entity-new-field-visibility"},children:[t,this.getSelectUserControl()]});this.adjust();return[this._wrapper]},getSelectUserControl:function(){return this._selectUserControl}};BX.Crm.EntityFieldVisibilityConfigButton.create=function(t,e){var i=new BX.Crm.EntityFieldVisibilityConfigButton;i.initialize(t,e);return i}}
//# sourceMappingURL=field-attr.map.js