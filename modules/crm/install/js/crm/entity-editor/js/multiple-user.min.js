BX.namespace("BX.Crm");if(typeof BX.Crm.EntityEditorMultipleUser==="undefined"){BX.Crm.EntityEditorMultipleUser=function(){BX.Crm.EntityEditorMultipleUser.superclass.constructor.apply(this);this._input=null;this._userSelector=null;this._map=null;this._infos=null;this._items=null;this._innerWrapper=null;this._emptyState=null;this._topButton=null;this._bottomButton=null;this._topButtonClickHandler=BX.delegate(this.onTopButtonClick,this);this._bottomButtonClickHandler=BX.delegate(this.onBottomButtonClick,this)};BX.extend(BX.Crm.EntityEditorMultipleUser,BX.UI.EntityEditorField);BX.Crm.EntityEditorMultipleUser.prototype.isSingleEditEnabled=function(){return true};BX.Crm.EntityEditorMultipleUser.prototype.doInitialize=function(){this._map=this._schemeElement.getDataObjectParam("map",{});this.initializeItems()};BX.Crm.EntityEditorMultipleUser.prototype.initializeItems=function(){this._infos=this._model.getSchemeField(this._schemeElement,"infos",[]);this._items=[];for(var t=0,e=this._infos.length;t<e;t++){this.addItem(this._infos[t])}};BX.Crm.EntityEditorMultipleUser.prototype.getItemCount=function(){return this._items!==null?this._items.length:0};BX.Crm.EntityEditorMultipleUser.prototype.findItemIndexById=function(t){if(!BX.type.isNumber(t)){t=parseInt(t);if(isNaN(t)){t=0}}for(var e=0,i=this._items.length;e<i;e++){if(this._items[e].getValue()===t){return e}}return-1};BX.Crm.EntityEditorMultipleUser.prototype.findItemIndex=function(t){if(!this._items){return-1}for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1};BX.Crm.EntityEditorMultipleUser.prototype.addItem=function(t){var e=BX.Crm.EntityEditorMultipleUserItem.create("",{parent:this,data:t});if(this._items===null){this._items=[]}this._items.push(e);if(this._hasLayout){this.removeEmptyState();e.setMode(this._mode);e.setContainer(this._innerWrapper);e.layout()}return e};BX.Crm.EntityEditorMultipleUser.prototype.deleteItem=function(t){if(!this._items){return}var e=this.findItemIndex(t);if(e>=0){t.clearLayout();t.setContainer(null);this._items.splice(e,1)}};BX.Crm.EntityEditorMultipleUser.prototype.adjust=function(){if(this.isInViewMode()){return}if(this.getItemCount()===0&&this._input===null){this._input=BX.create("input",{attrs:{name:this.getDataKey(),type:"hidden"}});this._wrapper.appendChild(this._input)}else if(this.getItemCount()>0&&this._input!==null){this._input=BX.remove(this._input)}};BX.Crm.EntityEditorMultipleUser.prototype.isSingleEditEnabled=function(){return true};BX.Crm.EntityEditorMultipleUser.prototype.hasContentToDisplay=function(){if(this._mode===BX.UI.EntityEditorMode.edit){return true}return this._model.getMappedField(this._map,"data",[]).length>0};BX.Crm.EntityEditorMultipleUser.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}var e=this._schemeElement.getTitle();this._wrapper.appendChild(this.createTitleNode(e));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._innerWrapper);if(this.hasContentToDisplay()){for(var i=0,n=this._items.length;i<n;i++){var r=this._items[i];r.setMode(this._mode);r.setContainer(this._innerWrapper);r.layout()}if(this.isInEditMode()){this._bottomButton=BX.create("span",{props:{className:"crm-entity-widget-content-add-employees"},text:BX.prop.getString(this._schemeElement.getDataObjectParam("messages",{}),"addObserver",BX.message("CRM_EDITOR_ADD")),events:{click:this._bottomButtonClickHandler}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-add-field"},children:[this._bottomButton]}))}}else{this._innerWrapper.appendChild(this.getEmptyState())}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.adjust();this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorMultipleUser.prototype.getEmptyState=function(){if(!this._emptyState){this._emptyState=BX.create("span",{text:this.getMessage("isEmpty")})}return this._emptyState};BX.Crm.EntityEditorMultipleUser.prototype.removeEmptyState=function(){if(this._innerWrapper?.contains(this.getEmptyState())){this.getEmptyState().remove()}};BX.Crm.EntityEditorMultipleUser.prototype.doRegisterLayout=function(){if(this.isInEditMode()&&this.checkModeOption(BX.UI.EntityEditorModeOptions.individual)){window.setTimeout(function(){this.getSelector().open(this._bottomButton)}.bind(this),500)}};BX.Crm.EntityEditorMultipleUser.prototype.doClearLayout=function(t){this._input=null;for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];n.clearLayout();n.setContainer(null)}this._innerWrapper=null;if(this._topButton){BX.unbind(this._topButton,"click",this._topButtonClickHandler);this._topButton=null}if(this._bottomButton){BX.unbind(this._bottomButton,"click",this._bottomButtonClickHandler);this._bottomButton=null}};BX.Crm.EntityEditorMultipleUser.prototype.createTitleActionControls=function(){var t=[];if(this.isInViewMode()&&this.isEditInViewEnabled()&&!this.isReadOnly()){this._topButton=BX.create("span",{props:{className:"crm-entity-widget-content-block-title-action-btn"},text:BX.message("CRM_EDITOR_ADD"),events:{click:this._topButtonClickHandler}});t.push(this._topButton)}return t};BX.Crm.EntityEditorMultipleUser.prototype.getDataKey=function(){return BX.prop.getString(this._map,"data",this.getName())};BX.Crm.EntityEditorMultipleUser.prototype.save=function(){var t=[];var e=[];for(var i=0,n=this._items.length;i<n;i++){var r=this._items[i];t.push(r.getValue());e.push(r.getData())}this._infos=e;this._model.setMappedField(this._map,"data",t);this._model.setSchemeField(this._schemeElement,"infos",e)};BX.Crm.EntityEditorMultipleUser.prototype.fireOnBeforeSelectorEvent=function(){var event={isCanceled:false};BX.onCustomEvent(this._editor,this.eventsNamespace+":onMultipleUserBeforeSelectorOpen",[this,event]);if(!event.isCanceled){var restriction=this._schemeElement.getDataObjectParam("restriction");if(restriction&&restriction.isRestricted===true){event.isCanceled=true;if(BX.Type.isString(restriction.action)){try{eval(restriction.action)}catch(t){console.log("canceled by restriction")}}else{console.log("canceled by restriction")}}}return event};BX.Crm.EntityEditorMultipleUser.prototype.onTopButtonClick=function(t){var e=this.fireOnBeforeSelectorEvent();if(e.isCanceled){return}if(this._mode===BX.UI.EntityEditorMode.view&&this.isEditInViewEnabled()&&this.getEditor().isChanged()){this.switchToSingleEditMode()}else{this.getSelector().open(this._topButton)}};BX.Crm.EntityEditorMultipleUser.prototype.onBottomButtonClick=function(t){var e=this.fireOnBeforeSelectorEvent();if(e.isCanceled){return}this.getSelector().open(this._bottomButton)};BX.Crm.EntityEditorMultipleUser.prototype.getSelector=function(){if(!this._userSelector){this._userSelector=BX.UI.EntityEditorUserSelector.create(this._id,{callback:BX.delegate(this.processItemSelect,this)})}return this._userSelector};BX.Crm.EntityEditorMultipleUser.prototype.processItemSelect=function(t,e){if(!(this.isInEditMode()||this.isEditInViewEnabled()&&!this.isReadOnly())){return}var i=BX.prop.getInteger(e,"entityId",0);if(this.findItemIndexById(i)>=0){this._userSelector.close();return}var n={ID:i,PHOTO_URL:BX.prop.getString(e,"avatar",""),FORMATTED_NAME:BX.util.htmlspecialcharsback(BX.prop.getString(e,"name","")),WORK_POSITION:BX.util.htmlspecialcharsback(BX.prop.getString(e,"desc",""))};n["SHOW_URL"]=this._schemeElement.getDataStringParam("pathToProfile","").replace(/#user_id#/gi,n["ID"]);this.addItem(n);this._userSelector.close();this.adjust();if(this.isInEditMode()){this.markAsChanged()}else{this._editor.saveControl(this)}};BX.Crm.EntityEditorMultipleUser.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorMultipleUser.prototype.processItemDeletion=function(t){this.deleteItem(t);this.adjust();this.markAsChanged()};BX.Crm.EntityEditorMultipleUser.prototype.getRuntimeValue=function(){if(this._mode===BX.UI.EntityEditorMode.edit&&this._selectedData["id"]>0){return this._selectedData["id"]}return""};BX.Crm.EntityEditorMultipleUser.prototype.checkIfNotEmpty=function(t){return BX.type.isArrayFilled(t)};BX.Crm.EntityEditorMultipleUser.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorMultipleUser.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorMultipleUser.superclass.getMessage.apply(this,arguments)};if(typeof BX.Crm.EntityEditorMultipleUser.messages==="undefined"){BX.Crm.EntityEditorMultipleUser.messages={}}BX.Crm.EntityEditorMultipleUser.create=function(t,e){var i=new BX.Crm.EntityEditorMultipleUser;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultipleUserItem==="undefined"){BX.Crm.EntityEditorMultipleUserItem=function(){this._id="";this._settings=null;this._parent=null;this._editor=null;this._mode=BX.UI.EntityEditorMode.view;this._data=null;this._container=null;this._wrapper=null;this._photoElement=null;this._nameElement=null;this._positionElement=null;this._input=null;this._deleteButton=null;this._deleteButtonHandler=BX.delegate(this.onDeleteButtonClick,this);this._hasLayout=false};BX.Crm.EntityEditorMultipleUserItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"";this._settings=e?e:{};this._parent=BX.prop.get(this._settings,"parent",null);this._editor=this._parent.getEditor();this._data=BX.prop.getObject(this._settings,"data",{});if(BX.prop.getString(this._data,"WORK_POSITION","")=="&nbsp;"){this._data.WORK_POSITION=""}},getValue:function(){return BX.prop.getInteger(this._data,"ID",0)},getMode:function(){return this._mode},setMode:function(t){this._mode=t},getData:function(){return this._data},setData:function(t){this._data=t},getContainer:function(){return this._container},setContainer:function(t){this._container=t},getIndex:function(){return this._parent.findItemIndex(this)},layout:function(){if(this._hasLayout){return}var t=BX.prop.getInteger(this._data,"ID",0);var e=BX.prop.getString(this._data,"FORMATTED_NAME","");var i=BX.prop.getString(this._data,"WORK_POSITION","");var n=BX.prop.getString(this._data,"SHOW_URL","");var r=BX.prop.getString(this._data,"PHOTO_URL","");this._photoElement=BX.create("a",{props:{className:"crm-widget-employee-avatar-container",target:"_blank"},style:{backgroundImage:r!==""?"url('"+encodeURI(r)+"')":"",backgroundSize:r!==""?"30px":""}});this._nameElement=BX.create("a",{props:{className:"crm-widget-employee-name",target:"_blank"},text:e});if(n!==""){this._photoElement.href=n;this._nameElement.href=n}this._positionElement=BX.create("SPAN",{props:{className:"crm-widget-employee-position"},text:i});this._wrapper=BX.create("div",{props:{className:"crm-widget-employee-container"}});this._deleteButton=null;if(this._mode===BX.UI.EntityEditorMode.edit){this._deleteButton=BX.create("div",{props:{className:"crm-widget-employee-remove"},text:BX.message("CRM_EDITOR_DELETE")});BX.bind(this._deleteButton,"click",this._deleteButtonHandler);this._wrapper.appendChild(this._deleteButton)}this._wrapper.appendChild(this._photoElement);this._wrapper.appendChild(BX.create("span",{props:{className:"crm-widget-employee-info"},children:[this._nameElement,this._positionElement]}));if(this._parent.isInEditMode()){this._input=BX.create("input",{attrs:{name:this._parent.getDataKey()+"["+this.getIndex()+"]",type:"hidden",value:t}});this._wrapper.appendChild(this._input)}this._container.appendChild(this._wrapper);this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}if(this._deleteButton){BX.unbind(this._deleteButton,"click",this._deleteButtonHandler);this._deleteButton=null}this._input=null;this._photoElement=this._nameElement=this._positionElement=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},onDeleteButtonClick:function(t){this._parent.processItemDeletion(this)}};BX.Crm.EntityEditorMultipleUserItem.create=function(t,e){var i=new BX.Crm.EntityEditorMultipleUserItem;i.initialize(t,e);return i}}
//# sourceMappingURL=multiple-user.map.js