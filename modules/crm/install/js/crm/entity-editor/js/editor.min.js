BX.namespace("BX.Crm");if(typeof BX.Crm.EntityEditor==="undefined"){BX.Crm.EntityEditor=function(){BX.Crm.EntityEditor.superclass.constructor.apply(this);this._entityTypeId=0;this._dupControlManager=null;this._bizprocManager=null;this._attributeManager=null;this._afterFormSubmitHandler=BX.delegate(this.onAfterFormSubmit,this);this._cancelFormSubmitHandler=BX.delegate(this.onCancelFormSubmit,this);this._haslayout=false;this._enableCommunicationControls=true;this._enableExternalLayoutResolvers=false;this._showEmptyFields=false;this._modeChangeNotifier=null;this._controlChangeNotifier=null;this._entityCreateHandler=BX.delegate(this.onCreateHandler,this);this._entityUpdateHandler=BX.delegate(this.onEntityUpdate,this);this._toolbarMenuBuildHandler=BX.delegate(this.onInterfaceToolbarMenuBuild,this);this._configurationManagerInitializeHandler=BX.delegate(this.onConfigurationManagerInitialize,this);this._helpWrapper=null;this.eventsNamespace="BX.Crm.EntityEditor";this.pageTitleInputClassName="pagetitle-item crm-pagetitle-item"};BX.extend(BX.Crm.EntityEditor,BX.UI.EntityEditor);BX.Crm.EntityEditor.prototype.initialize=function(t,e){this._controlChangeNotifier=BX.CrmNotifier.create(this);this._modeChangeNotifier=BX.CrmNotifier.create(this);this._settings=e?e:{};this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",0);this._entityTypeName=BX.CrmEntityType.resolveName(this._entityTypeId);this._createSectionButton=BX(BX.prop.get(this._settings,"createSectionButtonId"));this._configMenuButton=BX(BX.prop.get(this._settings,"configMenuButtonId"));this._enableCommunicationControls=BX.prop.getBoolean(this._settings,"enableCommunicationControls",true);this._enableExternalLayoutResolvers=BX.prop.getBoolean(this._settings,"enableExternalLayoutResolvers",false);this._showEmptyFields=BX.prop.getBoolean(this._settings,"showEmptyFields",false);BX.Crm.EntityEditor.superclass.initialize.apply(this,[t,e]);this._modeChangeNotifier.notify([this]);if(!BX.type.isElementNode(this._container)){throw this.eventsNamespace+": Could not find settings param 'container'."}};BX.Crm.EntityEditor.prototype.initializeManagers=function(){BX.addCustomEvent("BX.UI.EntityConfigurationManager:onInitialize",this._configurationManagerInitializeHandler);BX.Crm.EntityEditor.superclass.initializeManagers.apply(this);var t=BX.prop.getObject(this._settings,"duplicateControl",{});if(!t.hasOwnProperty("form")&&this._ajaxForm){t["form"]=this._ajaxForm}this._dupControlManager=BX.Crm.EntityEditorDupManager.create(this._id.toLowerCase()+"_dup",t);this._bizprocManager=BX.prop.get(this._settings,"bizprocManager",null);if(this._bizprocManager){this._bizprocManager._editor=this}this._restPlacementTabManager=BX.prop.get(this._settings,"restPlacementTabManager",null);if(this._restPlacementTabManager){this._restPlacementTabManager._editor=this}};BX.Crm.EntityEditor.prototype.attachToEvents=function(){BX.Crm.EntityEditor.superclass.attachToEvents.apply(this);BX.addCustomEvent(window,"Crm.InterfaceToolbar.MenuBuild",this._toolbarMenuBuildHandler);BX.addCustomEvent("onCrmEntityCreate",this._entityCreateHandler);BX.addCustomEvent("onCrmEntityUpdate",this._entityUpdateHandler)};BX.Crm.EntityEditor.prototype.deattachFromEvents=function(){BX.Crm.EntityEditor.superclass.deattachFromEvents.apply(this);BX.removeCustomEvent(window,"Crm.InterfaceToolbar.MenuBuild",this._toolbarMenuBuildHandler);BX.removeCustomEvent("onCrmEntityCreate",this._entityCreateHandler);BX.removeCustomEvent("onCrmEntityUpdate",this._entityUpdateHandler);BX.removeCustomEvent("BX.UI.EntityConfigurationManager:onInitialize",this._configurationManagerInitializeHandler)};BX.Crm.EntityEditor.prototype.onConfigurationManagerInitialize=function(t,e){if(e.type==="editor"){e.configurationFieldManager=BX.Crm.EntityConfigurationManager.create(this._id,{editor:this})}};BX.Crm.EntityEditor.prototype.initializeControlsEditMode=function(){var t,e,i;for(t=0,e=this._controls.length;t<e;t++){i=this._controls[t];var n=i.getEditPriority();if(n===BX.UI.EntityEditorPriority.high){i.setMode(BX.UI.EntityEditorMode.edit,{notify:false})}}if(this.getActiveControlCount()===0){this._controls[0].setMode(BX.UI.EntityEditorMode.edit,{notify:false})}};BX.Crm.EntityEditor.prototype.release=function(){BX.Crm.EntityEditor.superclass.release.apply(this);if(this._dragContainerController){this._dragContainerController.removeDragFinishListener(this._dropHandler);this._dragContainerController.release();this._dragContainerController=null}var t,e;for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].release()}this._haslayout=false};BX.Crm.EntityEditor.prototype.clone=function(t){var e=BX(BX.prop.get(t,"wrapper"));if(!BX.type.isElementNode(e)){throw this.eventsNamespace+": Could not find param 'wrapper'."}var i=BX.prop.getString(t,"id","");if(i===""){i=BX.util.getRandomString(4)}var n=BX.create("DIV",{props:{id:i.toLowerCase()+"_container",className:"crm-entity-card-container-content"}});e.appendChild(n);var r=BX.clone(this._settings);delete r["containerId"];r["container"]=n;return BX.Crm.EntityEditor.create(i,r)};BX.Crm.EntityEditor.prototype.onCreateHandler=function(t){if(t.sender===this){BX.Crm.EntityEvent.fireCreate(this._entityTypeId,this._entityId,this._externalContextId,this.makeLocalStorageSafeObject(t))}};BX.Crm.EntityEditor.prototype.onEntityUpdate=function(t){if(t.sender===this){BX.Crm.EntityEvent.fireUpdate(this._entityTypeId,this._entityId,this._externalContextId,this.makeLocalStorageSafeObject(t))}if(this._isReleased){return}if(this._entityTypeId===BX.prop.getInteger(t,"entityTypeId",0)&&this._entityId===BX.prop.getInteger(t,"entityId",0)&&this!==BX.prop.get(t,"sender",0)){var e=BX.prop.getObject(t,"entityData",null);if(e){this._model.setData(e,{enableNotification:false});this.adjustTitle();this.adjustSize();this.refreshLayout({reset:true})}}};BX.Crm.EntityEditor.prototype.makeLocalStorageSafeObject=function(t){const e={};Object.entries(t).forEach((([t,i])=>{const n=BX.Type.isObject(i)&&!BX.Type.isPlainObject(i);if(!n){e[t]=i}}));return e};BX.Crm.EntityEditor.prototype.getEntityTypeForAction=function(){return BX.CrmEntityType.resolveAbbreviation(this._entityTypeName)};BX.Crm.EntityEditor.prototype.initializeAjaxForm=function(){BX.Crm.EntityEditor.superclass.initializeAjaxForm.apply(this);BX.addCustomEvent(this._ajaxForm,"onAfterSubmit",this._afterFormSubmitHandler);BX.addCustomEvent(this._ajaxForm,"onSubmitCancel",this._cancelFormSubmitHandler)};BX.Crm.EntityEditor.prototype.getAjaxFormConfigData=function(){return{ACTION_ENTITY_TYPE:this.getEntityTypeForAction(),ACTION_ENTITY_ID:this._entityId}};BX.Crm.EntityEditor.prototype.releaseAjaxForm=function(){BX.Crm.EntityEditor.superclass.releaseAjaxForm.apply(this);BX.removeCustomEvent(this._ajaxForm,"onSubmitCancel",this._cancelFormSubmitHandler)};BX.Crm.EntityEditor.prototype.getEntityTypeId=function(){return this._entityTypeId};BX.Crm.EntityEditor.prototype.getModel=function(){return this._model};BX.Crm.EntityEditor.prototype.isPersistent=function(){return this._entityId>0&&this._entityId===this._model.getIntegerField("ID",0)};BX.Crm.EntityEditor.prototype.isNeedToDisplayEmptyFields=function(){return this._showEmptyFields};BX.Crm.EntityEditor.prototype.areCommunicationControlsEnabled=function(){return this._enableCommunicationControls};BX.Crm.EntityEditor.prototype.getEntityCreateUrl=function(t){if(t===BX.CrmEntityType.names.contact){return BX.prop.getString(this._settings,"contactCreateUrl","")}else if(t===BX.CrmEntityType.names.company){return BX.prop.getString(this._settings,"companyCreateUrl","")}return""};BX.Crm.EntityEditor.prototype.getEntityEditUrl=function(t,e){var i="";if(t===BX.CrmEntityType.names.contact){i=BX.prop.getString(this._settings,"contactEditUrl","")}else if(t===BX.CrmEntityType.names.company){i=BX.prop.getString(this._settings,"companyEditUrl","")}if(i!==""){i=i.replace("#id#",e,"gi")}return i};BX.Crm.EntityEditor.prototype.getEntityRequisiteSelectUrl=function(t,e){var i="";if(t===BX.CrmEntityType.names.contact){i=BX.prop.getString(this._settings,"contactRequisiteSelectUrl","").replace(/#contact_id#/gi,e)}else if(t===BX.CrmEntityType.names.company){i=BX.prop.getString(this._settings,"companyRequisiteSelectUrl","").replace(/#company_id#/gi,e)}return i};BX.Crm.EntityEditor.prototype.getRequisiteEditUrl=function(t){return BX.prop.getString(this._settings,"requisiteEditUrl","").replace(/#requisite_id#/gi,t)};BX.Crm.EntityEditor.prototype.getBizprocManager=function(){return this._bizprocManager};BX.Crm.EntityEditor.prototype.getAttributeManager=function(){if(!this._attributeManager){var t=this.getAttributeManagerSettings();if(t){this._attributeManager=BX.Crm.EntityFieldAttributeManager.create(this._id,{entityTypeId:this.getEntityTypeId(),entityScope:BX.prop.getString(t,"ENTITY_SCOPE",""),isPermitted:BX.prop.getBoolean(t,"IS_PERMITTED",true),isPhaseDependent:BX.prop.getBoolean(t,"IS_PHASE_DEPENDENT",true),isAttrConfigButtonHidden:BX.prop.getBoolean(t,"IS_ATTR_CONFIG_BUTTON_HIDDEN",true),lockScript:BX.prop.getString(t,"LOCK_SCRIPT",""),captions:BX.prop.getObject(t,"CAPTIONS",{}),entityPhases:BX.prop.getArray(t,"ENTITY_PHASES",null)})}}return this._attributeManager};BX.Crm.EntityEditor.prototype.registerActiveControl=function(t){var e=this.getActiveControlIndex(t);if(e>=0){return}var i=this._mode;BX.Crm.EntityEditor.superclass.registerActiveControl.apply(this,[t]);if(i!==BX.UI.EntityEditorMode.edit&&this._mode===BX.UI.EntityEditorMode.edit){this._modeChangeNotifier.notify([this])}};BX.Crm.EntityEditor.prototype.unregisterActiveControl=function(t){var e=this.getActiveControlIndex(t);if(e<0){return}var i=this._mode;BX.Crm.EntityEditor.superclass.unregisterActiveControl.apply(this,[t]);if(i!==BX.UI.EntityEditorMode.view&&this._activeControls.length===0&&this._mode===BX.UI.EntityEditorMode.view){this._modeChangeNotifier.notify([this])}};BX.Crm.EntityEditor.prototype.createControl=function(t,e,i){i["serviceUrl"]=this._serviceUrl;i["container"]=this._formElement;i["model"]=this._model;i["editor"]=this;return BX.Crm.EntityEditorControlFactory.create(t,e,i)};BX.Crm.EntityEditor.prototype.releaseActiveControls=function(t){var e=this._mode;BX.Crm.EntityEditor.superclass.releaseActiveControls.apply(this,[t]);if(this._mode!==BX.UI.EntityEditorMode.view&&!this.getActiveControlCount()){this._mode=BX.UI.EntityEditorMode.view}if(e!==this._mode){this._modeChangeNotifier.notify([this])}};BX.Crm.EntityEditor.prototype.processControlChange=function(t,e){this._enableCloseConfirmation=true;BX.Crm.EntityEditor.superclass.processControlChange.apply(this,[t,e]);this._controlChangeNotifier.notify([e])};BX.Crm.EntityEditor.prototype.processControlRemove=function(t){if(t instanceof BX.Crm.EntityEditorField||t instanceof BX.UI.EntityEditorField||t instanceof BX.Crm.EntityEditorSubsection){this.addAvailableSchemeElement(t.getSchemeElement())}else if(t instanceof BX.Crm.EntityEditorSection){var e=t.getChildren();for(var i=0,n=e.length;i<n;i++){this.addAvailableSchemeElement(e[i].getSchemeElement())}}};BX.Crm.EntityEditor.prototype.createController=function(t){return BX.Crm.EntityEditorControllerFactory.create(BX.prop.getString(t,"type",""),BX.prop.getString(t,"name",""),{config:BX.prop.getObject(t,"config",{}),model:this._model,editor:this})};BX.Crm.EntityEditor.prototype.processControllerChange=function(t){this._enableCloseConfirmation=true;BX.Crm.EntityEditor.superclass.processControlChange.apply(this,[t])};BX.Crm.EntityEditor.prototype.tapController=function(t,e){if(BX.type.isNotEmptyString(t)&&BX.type.isFunction(e)){var i,n;for(i=0,n=this._controllers.length;i<n;i++){if(this._controllers[i]._id===t){return e.call(this,this._controllers[i])}}}};BX.Crm.EntityEditor.prototype.hasLayout=function(){return this._haslayout};BX.Crm.EntityEditor.prototype.layout=function(){var t={cancel:false};BX.onCustomEvent(window,this.eventsNamespace+":onBeforeLayout",[this,t]);if(t["cancel"]){return}this.prepareContextDataLayout(this._context,"");if(this._toolPanel){this._toolPanel.layout()}if(this._createSectionButton){if(this.isSectionCreationEnabled()){BX.bind(this._createSectionButton,"click",BX.delegate(this.onCreateSectionButtonClick,this))}else{this._createSectionButton.style.display="none"}}if(this._configMenuButton){BX.bind(this._configMenuButton,"click",BX.delegate(this.onConfigMenuButtonClick,this))}var e=BX.prop.getBoolean(this._settings,"enableInlineEditSpotlight",false);var i={edit:BX.UI.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.UI.EntityEditorMode.edit,enableBatchMode:true,owner:this}),view:BX.UI.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.UI.EntityEditorMode.view,enableBatchMode:true,owner:this})};var n,r,o;for(n=0,r=this._controls.length;n<r;n++){o=this._controls[n];var a=o.getMode();var s={userFieldLoader:i[BX.UI.EntityEditorMode.getName(a)],enableFocusGain:!this._isEmbedded};if(n===0&&e&&a===BX.UI.EntityEditorMode.view&&!this.isReadOnly()){s["lighting"]={id:BX.prop.getString(this._settings,"inlineEditSpotlightId",""),text:this.getMessage("inlineEditHint")}}o.layout(s);if(a===BX.UI.EntityEditorMode.edit){this.registerActiveControl(o)}}const l=[];for(var d in i){if(i.hasOwnProperty(d)){l.push(i[d].runBatch())}}Promise.all(l).then((()=>{BX.onCustomEvent(window,this.eventsNamespace+":onUserFieldsDeployed",[this])}));if(this.getActiveControlCount()>0){this.showToolPanel()}if(this._model.isCaptionEditable()){BX.bind(this._pageTitle,"click",BX.delegate(this.onPageTileClick,this));if(this._editPageTitleButton){BX.bind(this._editPageTitleButton,"click",BX.delegate(this.onPageTileClick,this))}}if(this._mode===BX.UI.EntityEditorMode.edit&&this._dupControlManager.isEnabled()&&!this._dupControlManager.isSingleMode()){this._dupControlManager.search()}if(this._enableBottomPanel&&this._buttonContainer){this._buttonContainer.style.display=""}this.adjustButtons();this._haslayout=true;BX.onCustomEvent(window,this.eventsNamespace+":onLayout",[this])};BX.Crm.EntityEditor.prototype.adjustTitle=function(){BX.Crm.EntityEditor.superclass.adjustTitle.apply(this);if(!this._enablePageTitleControls){return}document.title=this._model.getCaption().trim();if(BX.getClass("BX.SidePanel.Instance.updateBrowserTitle")){BX.SidePanel.Instance.updateBrowserTitle()}};BX.Crm.EntityEditor.prototype.adjustSize=function(){BX.Crm.EntityEditor.superclass.adjustSize.apply(this);if(!this._enablePageTitleControls||!this._pageTitle){return}var t=this._pageTitle.parentNode?this._pageTitle.parentNode:this._pageTitle;BX.addClass(t,"crm-pagetitle")};BX.Crm.EntityEditor.prototype.adjustButtons=function(){if(this._config.isScopeToggleEnabled()&&!this._enableBottomPanel&&this._controls.length>0){var t=this._controls[this._controls.length-1];var e=t.getChildren();var i=e[e.length-1];i.ensureButtonPanelWrapperCreated().appendChild(BX.create("span",{props:{className:this._config.getScope()===BX.UI.EntityConfigScope.common?"crm-entity-card-common":"crm-entity-card-private"},events:{click:BX.delegate(this.onConfigMenuButtonClick,this)}}))}};BX.Crm.EntityEditor.prototype.addModeChangeListener=function(t){this._modeChangeNotifier.addListener(t)};BX.Crm.EntityEditor.prototype.removeModeChangeListener=function(t){this._modeChangeNotifier.removeListener(t)};BX.Crm.EntityEditor.prototype.addControlChangeListener=function(t){this._controlChangeNotifier.addListener(t)};BX.Crm.EntityEditor.prototype.removeControlChangeListener=function(t){this._controlChangeNotifier.removeListener(t)};BX.Crm.EntityEditor.prototype.validate=function(t){var e=BX.UI.EntityAsyncValidator.create();for(var i=0,n=this._activeControls.length;i<n;i++){e.addResult(this._activeControls[i].validate(t))}for(i=0,n=this._controllers.length;i<n;i++){e.addResult(this._controllers[i].validate(t))}if(this._userFieldManager){e.addResult(this._userFieldManager.validate(t))}return e.validate()};BX.Crm.EntityEditor.prototype.getActionEventArguments=function(){var t=BX.Crm.EntityEditor.superclass.getActionEventArguments.apply(this);t["entityTypeId"]=this._entityTypeId;return t};BX.Crm.EntityEditor.prototype.closeSearchSummary=function(){const t=this.getDuplicateManager();if(t&&t._controller){t._controller._closeSearchSummary()}};BX.Crm.EntityEditor.prototype.innerCancel=function(){this.closeSearchSummary();if(this._isNew){this._enableCloseConfirmation=false}BX.Crm.EntityEditor.superclass.innerCancel.apply(this)};BX.Crm.EntityEditor.prototype.processSchemeChange=function(){};BX.Crm.EntityEditor.prototype.onSaveSuccess=function(t,e){this.closeSearchSummary();this._enableCloseConfirmation=false;BX.Crm.EntityEditor.superclass.onSaveSuccess.apply(this,[t,e])};BX.Crm.EntityEditor.prototype.prepareEventParams=function(t){const e=BX.Crm.EntityEditor.superclass.prepareEventParams.apply(this,[t]);e["entityTypeId"]=this._entityTypeId;const i=BX.prop.getObject(t,"ENTITY_INFO",null);if(i){e["entityInfo"]=i}return e};BX.Crm.EntityEditor.prototype.onAfterFormSubmit=function(t,e){this._isRequestRunning=true;if(this._toolPanel){this._toolPanel.setLocked(true)}};BX.Crm.EntityEditor.prototype.onCancelFormSubmit=function(t,e){this._isRequestRunning=false;if(this._toolPanel){this._toolPanel.setLocked(false)}};BX.Crm.EntityEditor.prototype.isDuplicateControlEnabled=function(){return this._dupControlManager.isEnabled()};BX.Crm.EntityEditor.prototype.getDuplicateManager=function(){return this._dupControlManager};BX.Crm.EntityEditor.prototype.getAttributeManagerSettings=function(){return BX.prop.getObject(this._settings,"attributeConfig",null)};BX.Crm.EntityEditor.prototype.onDrop=function(t,e,i,n){this.processDraggedItemDrop(t,e)};BX.Crm.EntityEditor.prototype.canCreateContact=function(){return BX.prop.getBoolean(this._settings,"canCreateContact",false)};BX.Crm.EntityEditor.prototype.canCreateCompany=function(){return BX.prop.getBoolean(this._settings,"canCreateCompany",false)};BX.Crm.EntityEditor.prototype.addHelpLink=function(t){if(!this._helpWrapper){this._helpWrapper=BX.create("DIV",{props:{className:"crm-entity-card-widget-help"}});this._container.append(this._helpWrapper);var e=BX.create("A",{props:{className:"crm-entity-card-widget-help-link"},text:BX.prop.getString(t,"text","For Your information")});var i=BX.prop.getString(t,"url","");if(i!==""){e.href=helpUrl;e.target="_blank"}else{e.href="#";BX.bind(e,"click",(function(e){window.top.BX.Helper.show("redirect=detail&code="+BX.prop.getString(t,"code",""));e.preventDefault()}))}this._helpWrapper.appendChild(e)}};BX.Crm.EntityEditor.prototype.getMessage=function(t){var e=BX.Crm.EntityEditor.superclass.getMessage.apply(this,[t]);if(e===t){var i=BX.Crm.EntityEditor.messages;return i.hasOwnProperty(t)?i[t]:e}return e};BX.Crm.EntityEditor.prototype.getGlobalEventName=function(t){const e={onEntityCreateError:"onCrmEntityCreateError",onEntityUpdateError:"onCrmEntityUpdateError",onEntityUpdate:"onCrmEntityUpdate",onEntityCreate:"onCrmEntityCreate",beforeEntityRedirect:"beforeCrmEntityRedirect"};return e[t]||t};BX.Crm.EntityEditor.defaultInstance=null;BX.Crm.EntityEditor.items={};BX.Crm.EntityEditor.get=function(t){return this.items.hasOwnProperty(t)?this.items[t]:null};if(typeof BX.Crm.EntityEditor.messages==="undefined"){BX.Crm.EntityEditor.messages={}}BX.Crm.EntityEditor.setDefault=function(t){BX.Crm.EntityEditor.defaultInstance=t};BX.Crm.EntityEditor.getDefault=function(){return BX.Crm.EntityEditor.defaultInstance};BX.Crm.EntityEditor.create=function(t,e){var i=new BX.Crm.EntityEditor;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EntityEditorScopeConfig==="undefined"){BX.Crm.EntityEditorScopeConfig=BX.UI.EntityEditorScopeConfig}if(typeof BX.Crm.EntityEditorModeQueue==="undefined"){BX.Crm.EntityEditorModeQueue=BX.UI.EntityEditorModeQueue}if(typeof BX.UI.EntityEditorModeSwitch==="undefined"){BX.Crm.EntityEditorModeSwitch=BX.UI.EntityEditorModeSwitch}if(typeof BX.Crm.EntityEditorVisibilityPolicy==="undefined"){BX.Crm.EntityEditorVisibilityPolicy=BX.UI.EntityEditorModeSwitch}
//# sourceMappingURL=editor.map.js