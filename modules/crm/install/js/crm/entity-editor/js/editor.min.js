BX.namespace("BX.Crm");if(typeof BX.Crm.EntityEditor==="undefined"){BX.Crm.EntityEditor=function(){this._id="";this._settings={};this._entityTypeId=0;this._entityId=0;this._userFieldManager=null;this._dupControlManager=null;this._bizprocManager=null;this._attributeManager=null;this._container=null;this._buttonContainer=null;this._createSectionButton=null;this._configMenuButton=null;this._configIcon=null;this._pageTitle=null;this._pageTitleInput=null;this._buttonWrapper=null;this._editPageTitleButton=null;this._copyPageUrlButton=null;this._formElement=null;this._ajaxForm=null;this._afterFormSubmitHandler=BX.delegate(this.onAfterFormSubmit,this);this._cancelFormSubmitHandler=BX.delegate(this.onCancelFormSubmit,this);this._controllers=null;this._controls=null;this._activeControls=null;this._toolPanel=null;this._model=null;this._scheme=null;this._config=null;this._context=null;this._contextId="";this._externalContextId="";this._mode=BX.Crm.EntityEditorMode.intermediate;this._isNew=false;this._readOnly=false;this._haslayout=false;this._enableRequiredUserFieldCheck=true;this._enableAjaxForm=true;this._enableSectionEdit=false;this._enableSectionCreation=false;this._enableModeToggle=true;this._enableVisibilityPolicy=true;this._enablePageTitleControls=true;this._enableCommunicationControls=true;this._enableToolPanel=true;this._enableBottomPanel=true;this._enableFieldsContextMenu=true;this._enableExternalLayoutResolvers=false;this._showEmptyFields=false;this._serviceUrl="";this._htmlEditorConfigs=null;this._areAvailableSchemeElementsChanged=false;this._availableSchemeElements=null;this._dragPlaceHolder=null;this._dragContainerController=null;this._dropHandler=BX.delegate(this.onDrop,this);this._pageTitleExternalClickHandler=BX.delegate(this.onPageTitleExternalClick,this);this._pageTitleKeyPressHandler=BX.delegate(this.onPageTitleKeyPress,this);this._modeChangeNotifier=null;this._controlChangeNotifier=null;this._validators=null;this._modeSwitch=null;this._delayedSaveHandle=0;this._isEmbedded=false;this._isRequestRunning=false;this._isConfigMenuShown=false;this._isReleased=false;this._enableCloseConfirmation=true;this._closeConfirmationHandler=BX.delegate(this.onCloseConfirmButtonClick,this);this._cancelConfirmationHandler=BX.delegate(this.onCancelConfirmButtonClick,this);this._sliderOpenHandler=BX.delegate(this.onSliderOpen,this);this._sliderCloseHandler=BX.delegate(this.onSliderClose,this);this._entityUpdateHandler=BX.delegate(this.onEntityUpdate,this);this._helpWrapper=null;this._dragConfig={};this._ufAccessRights={}};BX.Crm.EntityEditor.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._model=BX.prop.get(this._settings,"model",null);this._scheme=BX.prop.get(this._settings,"scheme",null);this._config=BX.prop.get(this._settings,"config",null);this._category=BX.prop.getString(this._settings,"category",null);this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this._entityTypeId=BX.prop.getInteger(this._settings,"entityTypeId",0);this._entityId=BX.prop.getInteger(this._settings,"entityId",0);this._isNew=this._entityId<=0;this._commonConfigEditUrl=BX.prop.getString(this._settings,"commonConfigEditUrl","/configs/editor/?ENTITY_TYPE_ID=#ENTITY_TYPE_ID_VALUE#&MODULE_ID=#MODULE_ID#");this._isEmbedded=BX.prop.getBoolean(this._settings,"isEmbedded",false);var i=BX.prop.get(this._settings,"container");if(!BX.type.isElementNode(i)){i=BX(BX.prop.get(this._settings,"containerId"))}this._container=i;if(!BX.type.isElementNode(i)){throw"Crm.EntityEditor: Could not find settings param 'container'."}this._parentContainer=BX.findParent(this._container,{className:"crm-entity-section"},false);this._buttonContainer=BX(BX.prop.get(this._settings,"buttonContainerId"));this._createSectionButton=BX(BX.prop.get(this._settings,"createSectionButtonId"));this._configMenuButton=BX(BX.prop.get(this._settings,"configMenuButtonId"));this._configIcon=BX(BX.prop.get(this._settings,"configIconId"));this._enableVisibilityPolicy=BX.prop.getBoolean(this._settings,"enableVisibilityPolicy",true);this._enableCommunicationControls=BX.prop.getBoolean(this._settings,"enableCommunicationControls",true);this._enablePageTitleControls=BX.prop.getBoolean(this._settings,"enablePageTitleControls",true);if(this._enablePageTitleControls){this._pageTitle=BX("pagetitle");this._buttonWrapper=BX("pagetitle_btn_wrapper");this._editPageTitleButton=BX("pagetitle_edit");this._copyPageUrlButton=BX("page_url_copy_btn")}this.adjustSize();this.adjustTitle();var n=BX.prop.getString(this._settings,"formTagName","form");this._formElement=BX.create(n,{props:{name:this._id+"_form"}});this._container.appendChild(this._formElement);this._enableRequiredUserFieldCheck=BX.prop.getBoolean(this._settings,"enableRequiredUserFieldCheck",true);this._enableAjaxForm=BX.prop.getBoolean(this._settings,"enableAjaxForm",true);if(this._enableAjaxForm){this.initializeAjaxForm()}var o=BX.prop.getObject(this._settings,"duplicateControl",{});if(this._ajaxForm){o["form"]=this._ajaxForm}this._dupControlManager=BX.Crm.EntityEditorDupManager.create(this._id.toLowerCase()+"_dup",o);this._ufAccessRights=BX.prop.getObject(this._settings,"ufAccessRights",{});this._context=BX.prop.getObject(this._settings,"context",{});this._contextId=BX.prop.getString(this._settings,"contextId","");this._externalContextId=BX.prop.getString(this._settings,"externalContextId","");this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);if(this._readOnly){this._enableSectionEdit=this._enableSectionCreation=false}else{this._enableSectionEdit=BX.prop.getBoolean(this._settings,"enableSectionEdit",false);this._enableSectionCreation=BX.prop.getBoolean(this._settings,"enableSectionCreation",false)}this._userFieldManager=BX.prop.get(this._settings,"userFieldManager",null);this._bizprocManager=BX.prop.get(this._settings,"bizprocManager",null);if(this._bizprocManager){this._bizprocManager._editor=this}this._restPlacementTabManager=BX.prop.get(this._settings,"restPlacementTabManager",null);if(this._restPlacementTabManager){this._restPlacementTabManager._editor=this}this._modeChangeNotifier=BX.CrmNotifier.create(this);this._controlChangeNotifier=BX.CrmNotifier.create(this);this._availableSchemeElements=this._scheme.getAvailableElements();this._controllers=[];this._controls=[];this._activeControls=[];this._modeSwitch=BX.Crm.EntityEditorModeSwitch.create(this._id,{editor:this});this._htmlEditorConfigs=BX.prop.getObject(this._settings,"htmlEditorConfigs",{});var r=this._scheme.getElements();var s=BX.Crm.EntityEditorMode.view;if(!this._readOnly){s=BX.Crm.EntityEditorMode.parse(BX.prop.getString(this._settings,"initialMode",""))}this._mode=s!==BX.Crm.EntityEditorMode.intermediate?s:BX.Crm.EntityEditorMode.view;this._enableModeToggle=false;if(!this._readOnly){this._enableModeToggle=BX.prop.getBoolean(this._settings,"enableModeToggle",true)}if(this._isNew&&!this._readOnly){this._mode=BX.Crm.EntityEditorMode.edit}var a,l;var h=BX.prop.getArray(this._settings,"controllers",[]);for(a=0,l=h.length;a<l;a++){var d=this.createController(h[a]);if(d){this._controllers.push(d)}}var c,u;for(a=0,l=r.length;a<l;a++){c=r[a];u=this.createControl(c.getType(),c.getName(),{schemeElement:c,mode:BX.Crm.EntityEditorMode.view});if(!u){continue}this._controls.push(u)}if(this._mode===BX.Crm.EntityEditorMode.edit&&this._controls.length>0){for(a=0,l=this._controls.length;a<l;a++){u=this._controls[a];var g=u.getEditPriority();if(g===BX.Crm.EntityEditorPriority.high){u.setMode(BX.Crm.EntityEditorMode.edit,{notify:false})}}if(this.getActiveControlCount()===0){this._controls[0].setMode(BX.Crm.EntityEditorMode.edit,{notify:false})}}this._validators=[];var f=BX.prop.getArray(this._settings,"validators",[]);for(a=0,l=f.length;a<l;a++){var p=this.createValidator(f[a]);if(p){this._validators.push(p)}}this._modeChangeNotifier.notify([this]);this._enableToolPanel=BX.prop.getBoolean(this._settings,"enableToolPanel",true);if(this._enableToolPanel){this._toolPanel=BX.Crm.EntityEditorToolPanel.create(this._id,{container:this._isEmbedded?this._formElement:document.body,editor:this,visible:false})}this._enableBottomPanel=BX.prop.getBoolean(this._settings,"enableBottomPanel",true);this._enableFieldsContextMenu=BX.prop.getBoolean(this._settings,"enableFieldsContextMenu",true);this._enableExternalLayoutResolvers=BX.prop.getBoolean(this._settings,"enableExternalLayoutResolvers",false);this._showEmptyFields=BX.prop.getBoolean(this._settings,"showEmptyFields",false);BX.addCustomEvent(window,"Crm.InterfaceToolbar.MenuBuild",BX.delegate(this.onInterfaceToolbarMenuBuild,this));this._dragConfig={};var m={};m[BX.Crm.EntityEditorMode.names.view]=m[BX.Crm.EntityEditorMode.names.edit]=BX.prop.getBoolean(this._settings,"enableSectionDragDrop",true);this._dragConfig[BX.Crm.EditorDragObjectType.section]={scope:BX.Crm.EditorDragScope.form,modes:m};var _={};_[BX.Crm.EntityEditorMode.names.view]=_[BX.Crm.EntityEditorMode.names.edit]=BX.prop.getBoolean(this._settings,"enableFieldDragDrop",true);this._dragConfig[BX.Crm.EditorDragObjectType.field]={scope:BX.Crm.EditorDragScope.form,modes:_};if(this.canChangeScheme()){this._dragContainerController=BX.Crm.EditorDragContainerController.create("editor_"+this.getId(),{charge:BX.Crm.EditorSectionDragContainer.create({editor:this}),node:this._formElement});this._dragContainerController.addDragFinishListener(this._dropHandler)}this.layout();BX.bind(window,"resize",BX.debounce(BX.delegate(this.onResize,this),50));BX.addCustomEvent("SidePanel.Slider:onOpenComplete",this._sliderOpenHandler);BX.addCustomEvent("SidePanel.Slider:onClose",this._sliderCloseHandler);BX.addCustomEvent("onCrmEntityUpdate",this._entityUpdateHandler);var C={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onInit",[this,C])},release:function(){if(this._dragContainerController){this._dragContainerController.removeDragFinishListener(this._dropHandler);this._dragContainerController.release();this._dragContainerController=null}for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].clearLayout({release:true})}for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].release()}BX.removeCustomEvent("onCrmEntityUpdate",this._entityUpdateHandler);BX.removeCustomEvent("SidePanel.Slider:onOpenComplete",this._sliderOpenHandler);BX.removeCustomEvent("SidePanel.Slider:onClose",this._sliderCloseHandler);this.releaseAjaxForm();this._container=BX.remove(this._container);this._haslayout=false;this._isReleased=true},clone:function(t){var e=BX(BX.prop.get(t,"wrapper"));if(!BX.type.isElementNode(e)){throw"Crm.EntityEditor: Could not find param 'wrapper'."}var i=BX.prop.getString(t,"id","");if(i===""){i=BX.util.getRandomString(4)}var n=BX.create("DIV",{props:{id:i.toLowerCase()+"_container",className:"crm-entity-card-container-content"}});e.appendChild(n);var o=BX.clone(this._settings);delete o["containerId"];o["container"]=n;return BX.Crm.EntityEditor.create(i,o)},onSliderOpen:function(t){this._enableCloseConfirmation=true;var e={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onOpen",[this,e])},onSliderClose:function(t){if(!this._enableCloseConfirmation){return}var e=top.BX.SidePanel.Instance.getSliderByWindow(window);if(e!==t.getSlider()){return}if(!e.isOpen()){return}if(!this.hasChangedControls()&&!this.hasChangedControllers()){return}t.denyAction();if(BX.Crm.EditorAuxiliaryDialog.isItemOpened("close_confirmation")){return}BX.Crm.EditorAuxiliaryDialog.create("close_confirmation",{title:BX.message("CRM_EDITOR_CONFIRMATION"),content:BX.message("CRM_EDITOR_CLOSE_CONFIRMATION"),zIndex:100,buttons:[{id:"close",type:BX.Crm.DialogButtonType.accept,text:BX.message("JS_CORE_WINDOW_CLOSE"),callback:this._closeConfirmationHandler},{id:"cancel",type:BX.Crm.DialogButtonType.cancel,text:BX.message("JS_CORE_WINDOW_CANCEL"),callback:this._closeConfirmationHandler}]}).open()},onCloseConfirmButtonClick:function(t){t.getDialog().close();if(t.getId()==="close"){this._enableCloseConfirmation=false;top.BX.SidePanel.Instance.getSliderByWindow(window).close()}},onCancelConfirmButtonClick:function(t){t.getDialog().close();if(t.getId()==="yes"){this.innerCancel()}},onEntityUpdate:function(t){if(this._isReleased){return}if(this._entityTypeId===BX.prop.getInteger(t,"entityTypeId",0)&&this._entityId===BX.prop.getInteger(t,"entityId",0)&&this!==BX.prop.get(t,"sender",0)){var e=BX.prop.getObject(t,"entityData",null);if(e){this._model.setData(e,{enableNotification:false});this.adjustTitle();this.adjustSize();this.refreshLayout({reset:true})}}},initializeAjaxForm:function(){if(this._ajaxForm){return}this._ajaxForm=BX.Crm.AjaxForm.create(this._id,{elementNode:this._formElement,config:{url:this._serviceUrl,method:"POST",dataType:"json",processData:true,onsuccess:BX.delegate(this.onSaveSuccess,this),data:{ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:BX.CrmEntityType.resolveAbbreviation(BX.CrmEntityType.resolveName(this._entityTypeId)),ENABLE_REQUIRED_USER_FIELD_CHECK:this._enableRequiredUserFieldCheck?"Y":"N"}}});this._formElement.setAttribute("onsubmit","return false;");BX.addCustomEvent(this._ajaxForm,"onAfterSubmit",this._afterFormSubmitHandler);BX.addCustomEvent(this._ajaxForm,"onSubmitCancel",this._cancelFormSubmitHandler)},releaseAjaxForm:function(){if(!this._ajaxForm){return}BX.removeCustomEvent(this._ajaxForm,"onAfterSubmit",this._afterFormSubmitHandler);BX.removeCustomEvent(this._ajaxForm,"onSubmitCancel",this._cancelFormSubmitHandler);this._ajaxForm=null},getId:function(){return this._id},getEntityTypeId:function(){return this._entityTypeId},getEntityTypeName:function(){return BX.CrmEntityType.resolveName(this._entityTypeId)},getEntityId:function(){return this._entityId},getOwnerInfo:function(){return this._model.getOwnerInfo()},getMode:function(){return this._mode},getModel:function(){return this._model},getContextId:function(){return this._contextId},getContext:function(){return this._context},getExternalContextId:function(){return this._externalContextId},getScheme:function(){return this._scheme},isVisible:function(){return this._container.offsetParent!==null},isVisibilityPolicyEnabled:function(){return this._enableVisibilityPolicy},isSectionEditEnabled:function(){return this._enableSectionEdit},isSectionCreationEnabled:function(){return this._enableSectionCreation&&this.canChangeScheme()},isFieldsContextMenuEnabled:function(){return this._enableFieldsContextMenu},isModeToggleEnabled:function(){return this._enableModeToggle},isPersistent:function(){return this._entityId>0&&this._entityId===this._model.getIntegerField("ID",0)},isNew:function(){return this._isNew},isReadOnly:function(){return this._readOnly},isEmbedded:function(){return this._isEmbedded},isEditInViewEnabled:function(){return this._entityId>0},isNeedToDisplayEmptyFields:function(){return this._showEmptyFields},areCommunicationControlsEnabled:function(){return this._enableCommunicationControls},prepareFieldLayoutOptions:function(t){var e=t.hasContentToDisplay();var i={isNeedToDisplay:e||this._showEmptyFields};if(this._enableExternalLayoutResolvers){var n={id:this._id,field:t,hasContent:e,showEmptyFields:this._showEmptyFields,layoutOptions:i};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onResolveFieldLayoutOptions",[this,n])}return i},getEntityCreateUrl:function(t){if(t===BX.CrmEntityType.names.contact){return BX.prop.getString(this._settings,"contactCreateUrl","")}else if(t===BX.CrmEntityType.names.company){return BX.prop.getString(this._settings,"companyCreateUrl","")}return""},getEntityEditUrl:function(t,e){var i="";if(t===BX.CrmEntityType.names.contact){i=BX.prop.getString(this._settings,"contactEditUrl","")}else if(t===BX.CrmEntityType.names.company){i=BX.prop.getString(this._settings,"companyEditUrl","")}if(i!==""){i=i.replace("#id#",e,"gi")}return i},getEntityRequisiteSelectUrl:function(t,e){var i="";if(t===BX.CrmEntityType.names.contact){i=BX.prop.getString(this._settings,"contactRequisiteSelectUrl","").replace(/#contact_id#/gi,e)}else if(t===BX.CrmEntityType.names.company){i=BX.prop.getString(this._settings,"companyRequisiteSelectUrl","").replace(/#company_id#/gi,e)}return i},getRequisiteEditUrl:function(t){return BX.prop.getString(this._settings,"requisiteEditUrl","").replace(/#requisite_id#/gi,t)},getDetailManager:function(){if(typeof BX.Crm.EntityDetailManager==="undefined"){return null}return BX.Crm.EntityDetailManager.get(BX.prop.getString(this._settings,"detailManagerId",""))},getUserFieldManager:function(){return this._userFieldManager},getBizprocManager:function(){return this._bizprocManager},getAttributeManager:function(){if(!this._attributeManager){var t=this.getAttributeManagerSettings();if(t){this._attributeManager=BX.Crm.EntityFieldAttributeManager.create(this._id,{entityTypeId:this.getEntityTypeId(),entityScope:BX.prop.getString(t,"ENTITY_SCOPE",""),isPermitted:BX.prop.getBoolean(t,"IS_PERMITTED",true),lockScript:BX.prop.getString(t,"LOCK_SCRIPT",""),captions:BX.prop.getObject(t,"CAPTIONS",{})})}}return this._attributeManager},getHtmlEditorConfig:function(t){return BX.prop.getObject(this._htmlEditorConfigs,t,null)},createValidator:function(t){t["editor"]=this;return BX.Crm.EntityEditorValidatorFactory.create(BX.prop.getString(t,"type",""),t)},getControlByIndex:function(t){return t>=0&&t<this._controls.length?this._controls[t]:null},getControlIndex:function(t){for(var e=0,i=this._controls.length;e<i;e++){if(this._controls[e]===t){return e}}return-1},getControls:function(){return this._controls},getControlCount:function(){return this._controls.length},createControl:function(t,e,i){i["serviceUrl"]=this._serviceUrl;i["container"]=this._formElement;i["model"]=this._model;i["editor"]=this;return BX.Crm.EntityEditorControlFactory.create(t,e,i)},addControlAt:function(t,e){var i={};if(e<this._controls.length){i["anchor"]=this._controls[e].getWrapper();this._controls.splice(e,0,t)}else{this._controls.push(t)}t.layout(i)},moveControl:function(t,e){var i=this._controls.length;var n=i-1;if(e<0||e>i){e=n}var o=this.getControlIndex(t);if(o<0||o===e){return false}t.clearLayout();this._controls.splice(o,1);i--;var r=e<i?this._controls[e].getWrapper():null;if(e<i){this._controls.splice(e,0,t)}else{this._controls.push(t)}if(r){t.layout({anchor:r})}else{t.layout()}this._config.moveSchemeElement(t.getSchemeElement(),e)},removeControl:function(t){var e=this.getControlIndex(t);if(e<0){return false}this.processControlRemove(t);t.clearLayout();this._controls.splice(e,1)},getControlById:function(t){for(var e=0,i=this._controls.length;e<i;e++){var n=this._controls[e];if(n.getId()===t){return n}var o=n.getChildById(t);if(o){return o}}return null},getControlByIdRecursive:function(t,e){var i;if(!e){e=this.getControls()}for(var n=0;n<e.length;n++){if(!e[n]instanceof BX.Crm.EntityEditorControl){continue}if(e[n].getId()===t){return e[n]}else if(e[n]instanceof BX.Crm.EntityEditorSection){if(i=this.getControlByIdRecursive(t,e[n].getChildren())){return i}}}return null},getAllControls:function(t){var e=[],i;if(!t){t=this.getControls()}for(var n=0;n<t.length;n++){if(t[n]instanceof BX.Crm.EntityEditorControl){if(t[n]instanceof BX.Crm.EntityEditorSection){if(i=this.getAllControls(t[n].getChildren())){e=e.concat(i)}}else{e.push(t[n])}}}return e},getActiveControlCount:function(){return this._activeControls.length},getActiveControlIndex:function(t){var e=this._activeControls.length;if(e===0){return-1}for(var i=0;i<e;i++){if(this._activeControls[i]===t){return i}}return-1},getActiveControlById:function(t,e){e=!!e;var i=this._activeControls.length;if(i===0){return null}for(var n=0;n<i;n++){var o=this._activeControls[n];if(o.getId()===t){return o}if(e){var r=o.getChildById(t);if(r){return r}}}return null},getActiveControlByIndex:function(t){return t>=0&&t<this._activeControls.length?this._activeControls[t]:null},registerActiveControl:function(t){var e=this.getActiveControlIndex(t);if(e>=0){return}this._activeControls.push(t);t.setActive(true);if(this._mode!==BX.Crm.EntityEditorMode.edit){this._mode=BX.Crm.EntityEditorMode.edit;this._modeChangeNotifier.notify([this])}},unregisterActiveControl:function(t){var e=this.getActiveControlIndex(t);if(e<0){return}this._activeControls.splice(e,1);t.setActive(false);if(this._activeControls.length===0&&this._mode!==BX.Crm.EntityEditorMode.view){this._mode=BX.Crm.EntityEditorMode.view;this._modeChangeNotifier.notify([this])}},releaseActiveControls:function(t){var e={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onRelease",[this,e]);for(var i=0,n=this._activeControls.length;i<n;i++){var o=this._activeControls[i];o.setActive(false);o.toggleMode(false,t)}this._activeControls=[];if(this._mode!==BX.Crm.EntityEditorMode.view){this._mode=BX.Crm.EntityEditorMode.view;this._modeChangeNotifier.notify([this])}},hasChangedControls:function(){for(var t=0,e=this._activeControls.length;t<e;t++){if(this._activeControls[t].isChanged()){return true}}return false},hasChangedControllers:function(){for(var t=0,e=this._controllers.length;t<e;t++){if(this._controllers[t].isChanged()){return true}}return false},isWaitingForInput:function(){if(this._mode!==BX.Crm.EntityEditorMode.edit){return false}for(var t=0,e=this._activeControls.length;t<e;t++){if(this._activeControls[t].isWaitingForInput()){return true}}return false},processControlModeChange:function(t){if(t.getMode()===BX.Crm.EntityEditorMode.edit){this.registerActiveControl(t)}else{this.unregisterActiveControl(t)}if(this.getActiveControlCount()>0){this.showToolPanel()}else{this.hideToolPanel()}},processControlChange:function(t,e){if(!this._enableCloseConfirmation){this._enableCloseConfirmation=true}this.showToolPanel();this._controlChangeNotifier.notify([e])},processControlAdd:function(t){this.removeAvailableSchemeElement(t.getSchemeElement())},processControlMove:function(t){},processControlRemove:function(t){if(t instanceof BX.Crm.EntityEditorField||t instanceof BX.Crm.EntityEditorSubsection){this.addAvailableSchemeElement(t.getSchemeElement())}else if(t instanceof BX.Crm.EntityEditorSection){var e=t.getChildren();for(var i=0,n=e.length;i<n;i++){this.addAvailableSchemeElement(e[i].getSchemeElement())}}},getAvailableSchemeElements:function(){return this._availableSchemeElements},addAvailableSchemeElement:function(t){this._availableSchemeElements.push(t);this._areAvailableSchemeElementsChanged=true;this.notifyAvailableSchemeElementsChanged()},removeAvailableSchemeElement:function(t){var e=this.getAvailableSchemeElementIndex(t);if(e<0){return}this._availableSchemeElements.splice(e,1);this._areAvailableSchemeElementsChanged=true;this.notifyAvailableSchemeElementsChanged()},getAvailableSchemeElementIndex:function(t){var e=this._availableSchemeElements;for(var i=0,n=e.length;i<n;i++){if(e[i]===t){return i}}return-1},getAvailableSchemeElementByName:function(t){var e=this._availableSchemeElements;for(var i=0,n=e.length;i<n;i++){var o=e[i];if(o.getName()===t){return o}}return null},hasAvailableSchemeElements:function(){return this._availableSchemeElements.length>0},getSchemeElementByName:function(t){return this._scheme.findElementByName(t,{isRecursive:true})},notifyAvailableSchemeElementsChanged:function(){for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].processAvailableSchemeElementsChange()}},createController:function(t){return BX.Crm.EntityEditorControllerFactory.create(BX.prop.getString(t,"type",""),BX.prop.getString(t,"name",""),{config:BX.prop.getObject(t,"config",{}),model:this._model,editor:this})},processControllerChange:function(t){if(!this._enableCloseConfirmation){this._enableCloseConfirmation=true}this.showToolPanel()},getContainer:function(){return this._container},prepareContextDataLayout:function(t,e){for(var i in t){if(!t.hasOwnProperty(i)){continue}var n=t[i];var o=i;if(BX.type.isNotEmptyString(e)){o=e+"["+o+"]"}if(BX.type.isPlainObject(n)){this.prepareContextDataLayout(n,o)}else{this._formElement.appendChild(BX.create("input",{props:{type:"hidden",name:o,value:n}}))}}},hasLayout:function(){return this._haslayout},layout:function(){var t={cancel:false};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onBeforeLayout",[this,t]);if(t["cancel"]){return}this.prepareContextDataLayout(this._context,"");if(this._toolPanel){this._toolPanel.layout()}if(this._createSectionButton){if(this.isSectionCreationEnabled()){BX.bind(this._createSectionButton,"click",BX.delegate(this.onCreateSectionButtonClick,this))}else{this._createSectionButton.style.display="none"}}if(this._configMenuButton){BX.bind(this._configMenuButton,"click",BX.delegate(this.onConfigMenuButtonClick,this))}var e=BX.prop.getBoolean(this._settings,"enableInlineEditSpotlight",false);var i={edit:BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.Crm.EntityEditorMode.edit,enableBatchMode:true,owner:this}),view:BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.Crm.EntityEditorMode.view,enableBatchMode:true,owner:this})};var n,o,r;for(n=0,o=this._controls.length;n<o;n++){r=this._controls[n];var s=r.getMode();var a={userFieldLoader:i[BX.Crm.EntityEditorMode.getName(s)],enableFocusGain:!this._isEmbedded};if(n===0&&e&&s===BX.Crm.EntityEditorMode.view){a["lighting"]={id:BX.prop.getString(this._settings,"inlineEditSpotlightId",""),text:this.getMessage("inlineEditHint")}}r.layout(a);if(s===BX.Crm.EntityEditorMode.edit){this.registerActiveControl(r)}}for(var l in i){if(i.hasOwnProperty(l)){i[l].runBatch()}}if(this.getActiveControlCount()>0){this.showToolPanel()}if(this._model.isCaptionEditable()){BX.bind(this._pageTitle,"click",BX.delegate(this.onPageTileClick,this));if(this._editPageTitleButton){BX.bind(this._editPageTitleButton,"click",BX.delegate(this.onPageTileClick,this))}}if(this._mode===BX.Crm.EntityEditorMode.edit&&this._dupControlManager.isEnabled()){this._dupControlManager.search()}if(this._enableBottomPanel&&this._buttonContainer){this._buttonContainer.style.display=""}this.adjustButtons();this._haslayout=true;BX.onCustomEvent(window,"BX.Crm.EntityEditor:onLayout",[this])},refreshLayout:function(t){var e={edit:BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.Crm.EntityEditorMode.edit,enableBatchMode:true,owner:this}),view:BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.Crm.EntityEditorMode.view,enableBatchMode:true,owner:this})};if(!BX.type.isPlainObject(t)){t={}}for(var i=0,n=this._controls.length;i<n;i++){var o=this._controls[i];var r=o.getMode();var s=BX.mergeEx(t,{userFieldLoader:e[BX.Crm.EntityEditorMode.getName(r)],enableFocusGain:!this._isEmbedded});o.refreshLayout(s)}for(var a in e){if(e.hasOwnProperty(a)){e[a].runBatch()}}this.adjustButtons();BX.onCustomEvent(window,"BX.Crm.EntityEditor:onRefreshLayout",[this])},switchControlMode:function(t,e,i){if(!this.isModeToggleEnabled()){return}if(e===BX.Crm.EntityEditorMode.view){if(t.checkModeOption(BX.Crm.EntityEditorModeOptions.saveOnExit)){this._modeSwitch.getQueue().add(t,BX.Crm.EntityEditorMode.view);this._modeSwitch.run()}else{t.setMode(e,{options:i,notify:true});t.refreshLayout()}}else{if(!BX.Crm.EntityEditorModeOptions.check(i,BX.Crm.EntityEditorModeOptions.exclusive)){t.setMode(BX.Crm.EntityEditorMode.edit,{options:i,notify:true});t.refreshLayout()}else{var n=0;for(var o=0,r=this._activeControls.length;o<r;o++){var s=this._activeControls[o];if(s.checkModeOption(BX.Crm.EntityEditorModeOptions.saveOnExit)){this._modeSwitch.getQueue().add(s,BX.Crm.EntityEditorMode.view,i);n++}}if(n>0){this._modeSwitch.getQueue().add(t,BX.Crm.EntityEditorMode.edit,i);this._modeSwitch.run()}else{t.setMode(BX.Crm.EntityEditorMode.edit,{options:i,notify:true});t.refreshLayout()}}}},switchToViewMode:function(t){this.releaseActiveControls(t);this.hideToolPanel()},switchTitleMode:function(t){if(t===BX.Crm.EntityEditorMode.edit){this._pageTitle.style.display="none";if(this._buttonWrapper){this._buttonWrapper.style.display="none"}this._pageTitleInput=BX.create("input",{props:{type:"text",className:"pagetitle-item crm-pagetitle-item",value:this._model.getCaption()}});this._pageTitle.parentNode.insertBefore(this._pageTitleInput,this._pageTitle);this._pageTitleInput.focus();window.setTimeout(BX.delegate(function(){BX.bind(document,"click",this._pageTitleExternalClickHandler);BX.bind(this._pageTitleInput,"keyup",this._pageTitleKeyPressHandler)},this),300)}else{if(this._pageTitleInput){this._pageTitleInput=BX.remove(this._pageTitleInput)}this._pageTitle.innerHTML=BX.util.htmlspecialchars(this._model.getCaption());this._pageTitle.style.display="";if(this._buttonWrapper){this._buttonWrapper.style.display=""}BX.unbind(document,"click",this._pageTitleExternalClickHandler);BX.unbind(this._pageTitleInput,"keyup",this._pageTitleKeyPressHandler);this.adjustTitle()}},adjustTitle:function(){if(!this._enablePageTitleControls){return}if(!this._buttonWrapper){return}var t=this._model.getCaption().trim();var e="";document.title=t;if(BX.getClass("BX.SidePanel.Instance.updateBrowserTitle")){BX.SidePanel.Instance.updateBrowserTitle()}var i=t.match(/\s+\S+\s*$/);if(i){e=t.substr(i["index"]);t=t.substr(0,i["index"])}else{e=t;t=""}BX.cleanNode(this._buttonWrapper);if(e!==""){this._buttonWrapper.appendChild(document.createTextNode(e))}if(this._editPageTitleButton){this._buttonWrapper.appendChild(this._editPageTitleButton)}if(this._copyPageUrlButton){this._buttonWrapper.appendChild(this._copyPageUrlButton)}this._pageTitle.innerHTML=BX.util.htmlspecialchars(t)},adjustSize:function(){if(!this._enablePageTitleControls){return}if(!this._pageTitle){return}var t=this._pageTitle.parentNode?this._pageTitle.parentNode:this._pageTitle;BX.addClass(t,"crm-pagetitle");var e=t.offsetWidth<=480&&this._model.getCaption().length>=40;if(e&&!BX.hasClass(t,"pagetitle-narrow")){BX.addClass(t,"pagetitle-narrow")}else if(!e&&BX.hasClass(t,"pagetitle-narrow")){BX.removeClass(t,"pagetitle-narrow")}},adjustButtons:function(){if(this._config.isScopeToggleEnabled()&&!this._enableBottomPanel&&this._controls.length>0){this._controls[this._controls.length-1].ensureButtonPanelWrapperCreated().appendChild(BX.create("span",{props:{className:this._config.getScope()===BX.Crm.EntityConfigScope.common?"crm-entity-card-common":"crm-entity-card-private"},events:{click:BX.delegate(this.onConfigMenuButtonClick,this)}}))}},showToolPanel:function(){if(!this._toolPanel||this._toolPanel.isVisible()){return}this._toolPanel.setVisible(true);if(this._parentContainer){this._parentContainer.style.paddingBottom="50px";document.body.style.paddingBottom="60px";document.body.style.height="auto"}},hideToolPanel:function(){if(!this._toolPanel||!this._toolPanel.isVisible()){return}this._toolPanel.setVisible(false);if(this._parentContainer){this._parentContainer.style.paddingBottom="";document.body.style.paddingBottom="";document.body.style.height=""}},showMessageDialog:function(t,e,i){var n=BX.Crm.EditorAuxiliaryDialog.create(t,{title:e,content:i,buttons:[{id:"continue",type:BX.Crm.DialogButtonType.accept,text:BX.message("CRM_EDITOR_CONTINUE"),callback:function(t){t.getDialog().close()}}]});n.open()},addModeChangeListener:function(t){this._modeChangeNotifier.addListener(t)},removeModeChangeListener:function(t){this._modeChangeNotifier.removeListener(t)},addControlChangeListener:function(t){this._controlChangeNotifier.addListener(t)},removeControlChangeListener:function(t){this._controlChangeNotifier.removeListener(t)},getMessage:function(t){var e=BX.Crm.EntityEditor.messages;return e.hasOwnProperty(t)?e[t]:t},getFormElement:function(){return this._formElement},isChanged:function(){return this._isNew||this.hasChangedControls()||this.hasChangedControllers()},savePageTitle:function(){if(!this._pageTitleInput){return}var t=BX.util.trim(this._pageTitleInput.value);if(t===""){return}this._model.setCaption(t);var e={ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:BX.CrmEntityType.resolveAbbreviation(BX.CrmEntityType.resolveName(this._entityTypeId)),PARAMS:BX.prop.getObject(this._context,"PARAMS",{})};this._model.prepareCaptionData(e);e=BX.mergeEx(e,this.prepareControllersData(e));BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:e,onsuccess:BX.delegate(this.onSaveSuccess,this)})},saveChanged:function(){if(!this._isNew&&!this.hasChangedControls()&&!this.hasChangedControllers()&&!this.isWaitingForInput()){this._modeSwitch.reset();this.releaseActiveControls();this.refreshLayout({reset:true});this.hideToolPanel()}else{this._modeSwitch.reset();this._modeSwitch.getQueue().addBatch(this._activeControls,BX.Crm.EntityEditorMode.view);this._modeSwitch.run()}},saveDelayed:function(t){if(typeof t==="undefined"){t=0}if(this._delayedSaveHandle>0){window.clearTimeout(this._delayedSaveHandle)}this._delayedSaveHandle=window.setTimeout(BX.delegate(this.save,this),t)},save:function(){if(this._toolPanel){this._toolPanel.setLocked(true)}var t=BX.Crm.EntityValidationResult.create();this.validate(t).then(BX.delegate(function(){if(this._bizprocManager){return this._bizprocManager.onBeforeSave(t)}var e=new BX.Promise;window.setTimeout(function(){e.fulfill()},0);return e},this)).then(BX.delegate(function(){if(t.getStatus()){this.innerSave();if(this._bizprocManager){this._bizprocManager.onAfterSave()}}else{if(this.isVisible()){var e=t.getTopmostField();if(e){e.focus()}}if(this._toolPanel){this._toolPanel.setLocked(false)}BX.onCustomEvent(window,"BX.Crm.EntityEditor:onFailedValidation",[this,t])}},this));if(this._delayedSaveHandle>0){this._delayedSaveHandle=0}},saveControl:function(t){if(this._entityId<=0){return}var e=BX.Crm.EntityValidationResult.create();t.validate(e);if(!e.getStatus()){return}var i={ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:BX.CrmEntityType.resolveAbbreviation(BX.CrmEntityType.resolveName(this._entityTypeId))};i=BX.mergeEx(i,this._context);t.save();t.prepareSaveData(i);i=BX.mergeEx(i,this.prepareControllersData(i));BX.ajax({method:"POST",dataType:"json",url:this._serviceUrl,data:i,onsuccess:BX.delegate(this.onSaveSuccess,this)})},prepareControllersData:function(t){if(!BX.type.isPlainObject(t)){t={}}for(var e=0,i=this._controllers.length;e<i;e++){t=this._controllers[e].onBeforesSaveControl(t)}return t},saveData:function(t){if(this._entityId<=0){return}t=BX.mergeEx(t,this._context);t=BX.mergeEx(t,{ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:BX.CrmEntityType.resolveAbbreviation(BX.CrmEntityType.resolveName(this._entityTypeId))});BX.ajax({method:"POST",dataType:"json",url:this._serviceUrl,data:t,onsuccess:BX.delegate(this.onSaveSuccess,this)})},validate:function(t){var e=BX.Crm.EntityAsyncValidator.create();for(var i=0,n=this._activeControls.length;i<n;i++){e.addResult(this._activeControls[i].validate(t))}for(i=0,n=this._controllers.length;i<n;i++){e.addResult(this._controllers[i].validate(t))}if(this._userFieldManager){e.addResult(this._userFieldManager.validate(t))}return e.validate()},isRequestRunning:function(){return this._isRequestRunning},innerSave:function(){if(this._isRequestRunning){return}var t,e;for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].onBeforeSubmit()}for(t=0,e=this._activeControls.length;t<e;t++){var i=this._activeControls[t];i.save();i.onBeforeSubmit();if(i.isSchemeChanged()){this._config.updateSchemeElement(i.getSchemeElement())}}if(this._areAvailableSchemeElementsChanged){this._scheme.setAvailableElements(this._availableSchemeElements);this._areAvailableSchemeElementsChanged=false}if(this._config&&this._config.isChanged()){this._config.save(false)}var n={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model,cancel:false};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onSave",[this,n]);var o=BX.prop.getBoolean(n,"enableCloseConfirmation",null);if(BX.type.isBoolean(o)){this._enableCloseConfirmation=o}if(n["cancel"]){return}if(this._ajaxForm){var r=this.getDetailManager();if(r){var s=r.prepareAnalyticParams(this._entityId>0?"update":"create",{embedded:this.isEmbedded()?"Y":"N"});if(s){this._ajaxForm.addUrlParams(s)}}this._ajaxForm.submit()}},cancel:function(){var t={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model,cancel:false};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onCancel",[this,t]);var e=BX.prop.getBoolean(t,"enableCloseConfirmation",null);if(BX.type.isBoolean(e)){this._enableCloseConfirmation=e}if(t["cancel"]){return}if(this.hasChangedControls()||this.hasChangedControllers()){window.setTimeout(BX.delegate(this.openCancellationConfirmationDialog,this),250);return}this.innerCancel()},innerCancel:function(){var t,e;for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].innerCancel()}this.rollback();if(this._isNew){this.refreshLayout();if(typeof top.BX.SidePanel!=="undefined"){this._enableCloseConfirmation=false;window.setTimeout(function(){var t=top.BX.SidePanel.Instance.getSliderByWindow(window);if(t&&t.isOpen()){t.close(false)}},250)}}else{this.switchToViewMode({refreshLayout:false});this.refreshLayout()}},openCancellationConfirmationDialog:function(){BX.Crm.EditorAuxiliaryDialog.create("cancel_confirmation",{title:BX.message("CRM_EDITOR_CONFIRMATION"),content:BX.message("CRM_EDITOR_CANCEL_CONFIRMATION"),buttons:[{id:"yes",type:BX.Crm.DialogButtonType.accept,text:BX.message("CRM_EDITOR_YES"),callback:this._cancelConfirmationHandler},{id:"no",type:BX.Crm.DialogButtonType.cancel,text:BX.message("CRM_EDITOR_NO"),callback:this._cancelConfirmationHandler}]}).open()},rollback:function(){this._model.rollback();var t,e;for(t=0,e=this._controllers.length;t<e;t++){this._controllers[t].rollback()}for(t=0,e=this._activeControls.length;t<e;t++){this._activeControls[t].rollback()}if(this._areAvailableSchemeElementsChanged){this._availableSchemeElements=this._scheme.getAvailableElements();this._areAvailableSchemeElementsChanged=false}},addSchemeElementAt:function(t,e){if(this._config){this._config.addSchemeElementAt(t,e)}},updateSchemeElement:function(t){if(this._config){this._config.updateSchemeElement(t)}},removeSchemeElement:function(t){if(this._config){this._config.removeSchemeElement(t)}},canChangeScheme:function(){return this._config&&this._config.isChangeable()},isSchemeChanged:function(){return this._config&&this._config.isChanged()},saveScheme:function(){return this._config&&this._config.save(false)},saveSchemeChanges:function(){this.commitSchemeChanges();return this._config&&this._config.save(false)},commitSchemeChanges:function(){for(var t=0,e=this._controls.length;t<e;t++){this._controls[t].commitSchemeChanges()}if(this._areAvailableSchemeElementsChanged){this._scheme.setAvailableElements(this._availableSchemeElements);this._areAvailableSchemeElementsChanged=false}},onSaveSuccess:function(t){this._isRequestRunning=false;if(this._enableCloseConfirmation){this._enableCloseConfirmation=false}if(this._toolPanel){this._toolPanel.setLocked(false);this._toolPanel.clearErrors()}var e=BX.prop.getObject(t,"EVENT_PARAMS",{});e["entityTypeId"]=this._entityTypeId;var i=BX.prop.getObject(t,"ENTITY_INFO",null);if(i){e["entityInfo"]=i}var n=BX.Crm.Page.getTopSlider();if(n){e["sliderUrl"]=n.getUrl()}var o=BX.prop.getObject(t,"CHECK_ERRORS",null);var r=BX.prop.getString(t,"ERROR","");if(o||r!==""){if(o){var s=null;var a=[];for(var l in o){if(!o.hasOwnProperty(l)){return}var h=this.getActiveControlById(l,true);if(h){h.showError(o[l]);if(!s){s=h}}else{a.push(o[l])}}if(s){s.scrollAnimate()}r=a.join("<br/>")}if(r!==""&&this._toolPanel){this._toolPanel.addError(r)}e["checkErrors"]=o;e["error"]=r;if(this._isNew){BX.onCustomEvent(window,"onCrmEntityCreateError",[e])}else{e["entityId"]=this._entityId;BX.onCustomEvent(window,"onCrmEntityUpdateError",[e])}this.releaseAjaxForm();this.initializeAjaxForm();return}var d=BX.prop.getObject(t,"ENTITY_DATA",null);e["entityData"]=d;e["isCancelled"]=false;if(this._isNew){this._entityId=BX.prop.getInteger(t,"ENTITY_ID",0);if(this._entityId<=0){if(this._toolPanel){this._toolPanel.addError(this.getMessage("couldNotFindEntityIdError"))}return}BX.Crm.EntityEvent.fireCreate(this._entityTypeId,this._entityId,this._externalContextId,e);e["sender"]=this;e["entityId"]=this._entityId;BX.onCustomEvent(window,"onCrmEntityCreate",[e]);if(BX.prop.getBoolean(e,"isCancelled",true)){this._entityId=0;this.rollback();this.releaseAjaxForm();this.initializeAjaxForm();return}this._isNew=false}else{BX.Crm.EntityEvent.fireUpdate(this._entityTypeId,this._entityId,this._externalContextId,e);e["sender"]=this;e["entityId"]=this._entityId;BX.onCustomEvent(window,"onCrmEntityUpdate",[e]);if(BX.prop.getBoolean(e,"isCancelled",true)){this.rollback();this.releaseAjaxForm();this.initializeAjaxForm();return}}var c=BX.prop.getString(t,"REDIRECT_URL","");var u=BX.prop.getObject(t,"EVENT_PARAMS",null);if(u){var g=BX.prop.getString(u,"name","");var f=BX.prop.getObject(u,"args",null);if(g!==""&&f!==null){if(c!==""){f["redirectUrl"]=c}BX.localStorage.set(g,f,10)}}if(this._isReleased){return}if(c!==""&&!this._isEmbedded){window.location.replace(BX.util.add_url_param(c,{IFRAME:"Y",IFRAME_TYPE:"SIDE_SLIDER"}))}else{if(BX.type.isPlainObject(d)){this._model.setData(d,{enableNotification:false})}this.adjustTitle();this.adjustSize();this.releaseAjaxForm();this.initializeAjaxForm();for(var p=0,m=this._controllers.length;p<m;p++){this._controllers[p].onAfterSave()}if(this._modeSwitch.isRunning()){this._modeSwitch.complete()}else{this.switchToViewMode({refreshLayout:false})}this.refreshLayout({reset:true});this.hideToolPanel()}},formatMoney:function(t,e,i){BX.ajax({url:BX.prop.getString(this._settings,"serviceUrl",""),method:"POST",dataType:"json",data:{ACTION:"GET_FORMATTED_SUM",CURRENCY_ID:e,SUM:t},onsuccess:i})},findOption:function(t,e){for(var i=0,n=e.length;i<n;i++){if(t===e[i].VALUE){return e[i].NAME}}return t},canChangeCommonConfiguration:function(){return this._config.isCanChangeCommonConfiguration()},prepareConfigMenuItems:function(){var t=[];var e=BX.delegate(this.onMenuItemClick,this);t.push({id:"switchToPersonalConfig",text:this.getMessage("switchToPersonalConfig"),onclick:e,className:this._config.getScope()===BX.Crm.EntityConfigScope.personal?"menu-popup-item-accept":"menu-popup-item-none"});t.push({id:"switchToCommonConfig",text:this.getMessage("switchToCommonConfig"),onclick:e,className:this._config.getScope()===BX.Crm.EntityConfigScope.common?"menu-popup-item-accept":"menu-popup-item-none"});if(this._config._userScopes){for(var i in this._config._userScopes){t.push({text:this.getMessage("checkScope").replace("#SCOPE_NAME#",this._config._userScopes[i]["NAME"]),onclick:e,attributes:{"data-id":i},className:this._config.getScope()===BX.Crm.EntityConfigScope.custom&&this._config._userScopeId===i?"menu-popup-item-accept":"menu-popup-item-none"})}}if(this.canChangeScheme()){t.push({delimiter:true});t.push({id:"resetConfig",text:this.getMessage("resetConfig"),onclick:e,className:"menu-popup-item-none"});if(BX.prop.getBoolean(this._settings,"enableSettingsForAll",false)){t.push({id:"forceCommonConfigForAllUsers",text:this.getMessage("forceCommonConfigForAllUsers"),onclick:e,className:"menu-popup-item-none"})}if(this.canChangeCommonConfiguration()){t.push({delimiter:true});t.push({id:"createConfigForCheckedUsers",text:this.getMessage("createScope"),onclick:e,className:"menu-popup-item-none"});t.push({id:"editCommonConfig",text:this.getMessage("updateScope"),onclick:e,className:"menu-popup-item-none"})}}return t},getServiceUrl:function(){return this._serviceUrl},loadCustomHtml:function(t,e,i){e["ACTION"]=t;e["ACTION_ENTITY_ID"]=this._entityId;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"html",data:e,onsuccess:i})},onAfterFormSubmit:function(t,e){this._isRequestRunning=true;if(this._toolPanel){this._toolPanel.setLocked(true)}},onCancelFormSubmit:function(t,e){this._isRequestRunning=false;if(this._toolPanel){this._toolPanel.setLocked(false)}},isDuplicateControlEnabled:function(){return this._dupControlManager.isEnabled()},getDuplicateManager:function(){return this._dupControlManager},onResize:function(t){this.adjustSize()},onPageTileClick:function(t){if(this._readOnly){return}if(this.isChanged()){this.showMessageDialog("titleEditDenied",this.getMessage("titleEdit"),this.getMessage("titleEditUnsavedChanges"));return}this.switchTitleMode(BX.Crm.EntityEditorMode.edit)},onCreateSectionButtonClick:function(t){if(!this.isSectionCreationEnabled()){return}var e=this.getControlCount();var i="user_"+BX.util.getRandomString(8).toLowerCase();var n=BX.Crm.EntitySchemeElement.create({type:"section",name:i,title:this.getMessage("newSectionTitle")});this.addSchemeElementAt(n,e);var o=this.createControl("section",i,{schemeElement:n,model:this._model,container:this._formElement});this.addControlAt(o,e);this.saveScheme();o.setMode(BX.Crm.EntityEditorMode.edit,{notify:false});o.refreshLayout();o.setTitleMode(BX.Crm.EntityEditorMode.edit);this.registerActiveControl(o)},onConfigMenuButtonClick:function(t){if(this._isConfigMenuShown){return}var e=this.prepareConfigMenuItems();if(e.length>0){BX.PopupMenu.show(this._id+"_config_menu",BX.getEventTarget(t),e,{angle:false,autoHide:true,closeByEsc:true,events:{onPopupShow:function(){this._isConfigMenuShown=true}.bind(this),onPopupClose:function(){BX.PopupMenu.destroy(this._id+"_config_menu")}.bind(this),onPopupDestroy:function(){this._isConfigMenuShown=false}.bind(this)}})}},onPageTitleExternalClick:function(t){var e=BX.getEventTarget(t);if(e!==this._pageTitleInput){this.savePageTitle();this.switchTitleMode(BX.Crm.EntityEditorMode.view)}},onPageTitleKeyPress:function(t){var e=t.keyCode;if(e===13){this.savePageTitle();this.switchTitleMode(BX.Crm.EntityEditorMode.view)}else if(e===27){this.switchTitleMode(BX.Crm.EntityEditorMode.view)}},onInterfaceToolbarMenuBuild:function(t,e){var i=BX.prop.getArray(e,"items",null);if(!i){return}var n=this.prepareConfigMenuItems();if(n.length>0){if(i.length>0){i.push({delimiter:true})}for(var o=0,r=n.length;o<r;o++){i.push(n[o])}}},getCommonConfigEditUrl:function(t,e){return this._commonConfigEditUrl.replace(/#ENTITY_TYPE_ID_VALUE#/gi,t).replace(/#MODULE_ID#/gi,e)},onMenuItemClick:function(t,e){var i=BX.prop.getString(e,"id","");switch(i){case"resetConfig":this.resetConfig();break;case"switchToPersonalConfig":this.setConfigScope(BX.Crm.EntityConfigScope.personal);break;case"switchToCommonConfig":this.setConfigScope(BX.Crm.EntityConfigScope.common);break;case"forceCommonConfigForAllUsers":this.forceCommonConfigScopeForAll();break;case"createConfigForCheckedUsers":this.createConfigScopeForCheckedUsers();break;case"editCommonConfig":BX.SidePanel.Instance.open(this.getCommonConfigEditUrl(this._config._id,this._category),{width:980});break;default:var n=BX.prop.getObject(e,"attributes","");if(n["data-id"]!==undefined){this.setConfigScope(BX.Crm.EntityConfigScope.custom,n["data-id"])}}if(e.menuWindow){e.menuWindow.close()}},setConfigScope:function(t,e){if(t===this._config.getScope()&&this._config.getScope()!==BX.Crm.EntityConfigScope.custom||t===BX.Crm.EntityConfigScope.custom&&(e===undefined||e===this._config._userScopeId)){return}this._config.setScope(t,e,this._category).then(function(){var i={id:this._id,category:this._category,scope:t,userScopeId:e,enableReload:true};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onConfigScopeChange",[this,i]);if(i["enableReload"]&&!this._isEmbedded){window.location.reload(true)}}.bind(this))},forceCommonConfigScopeForAll:function(){this._config.forceCommonScopeForAll().then(function(){var t=this._config.getScope();var e={id:this._id,scope:t,enableReload:true};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onForceCommonConfigScopeForAll",[this,e]);if(e["enableReload"]&&!this._isEmbedded&&t!==BX.Crm.EntityConfigScope.common){window.location.reload(true)}}.bind(this))},createConfigScopeForCheckedUsers:function(){var t=BX.Crm.EntityEditorScopeConfig.create(this._id+"_config",{editor:this,config:this._config.toJSON(),entityTypeId:this._config._id,isCommonConfig:true,category:this._category});t.open()},resetConfig:function(){this._config.reset(false).then(function(){var t=this._config.getScope();var e={id:this._id,scope:t,enableReload:true};BX.onCustomEvent(window,"BX.Crm.EntityEditor:onConfigReset",[this,e]);if(e["enableReload"]&&!this._isEmbedded){window.location.reload(true)}}.bind(this))},getConfigOption:function(t,e){return this._config.getOption(t,e)},setConfigOption:function(t,e){return this._config.setOption(t,e)},getAttributeManagerSettings:function(){return BX.prop.getObject(this._settings,"attributeConfig",null)},getOption:function(t,e){return BX.prop.getString(this._settings["options"],t,e)},setOption:function(t,e){if(typeof e==="undefined"||e===null){return}if(BX.prop.getString(this._settings["options"],t,null)===e){return}this._settings["options"][t]=e},getDragConfig:function(t){return BX.prop.getObject(this._dragConfig,t,{})},hasPlaceHolder:function(){return!!this._dragPlaceHolder},createPlaceHolder:function(t){var e=this.getControlCount();if(t<0||t>e){t=e>0?e:0}if(this._dragPlaceHolder){if(this._dragPlaceHolder.getIndex()===t){return this._dragPlaceHolder}this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}this._dragPlaceHolder=BX.Crm.EditorDragSectionPlaceholder.create({container:this._formElement,anchor:t<e?this._controls[t].getWrapper():null,index:t});this._dragPlaceHolder.layout();return this._dragPlaceHolder},getPlaceHolder:function(){return this._dragPlaceHolder},removePlaceHolder:function(){if(this._dragPlaceHolder){this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}},processDraggedItemDrop:function(t,e){var i=t.getCharge();if(!(i instanceof BX.Crm.EditorSectionDragContainer&&i.getEditor()===this)){return}var n=e.getContextData();var o=BX.type.isNotEmptyString(n["contextId"])?n["contextId"]:"";if(o!==BX.Crm.EditorSectionDragItem.contextId){return}var r=typeof n["charge"]!=="undefined"?n["charge"]:null;if(!(r instanceof BX.Crm.EditorSectionDragItem)){return}var s=r.getControl();if(!s){return}var a=this.getControlIndex(s);if(a<0){return}var l=this.getPlaceHolder();var h=l?l.getIndex():-1;if(h<0){return}var d=h<=a?h:h-1;if(d!==a){this.moveControl(s,d);this.saveScheme()}},onDrop:function(t,e,i,n){this.processDraggedItemDrop(t,e)},canCreateContact:function(){return BX.prop.getBoolean(this._settings,"canCreateContact",false)},canCreateCompany:function(){return BX.prop.getBoolean(this._settings,"canCreateCompany",false)},addHelpLink:function(t){if(!this._helpWrapper){this._helpWrapper=BX.create("DIV",{props:{className:"crm-entity-card-widget-help"}});this._container.append(this._helpWrapper);var e=BX.create("A",{props:{className:"crm-entity-card-widget-help-link"},text:BX.prop.getString(t,"text","For Your information")});var i=BX.prop.getString(t,"url","");if(i!==""){e.href=helpUrl;e.target="_blank"}else{e.href="#";BX.bind(e,"click",function(e){window.top.BX.Helper.show("redirect=detail&code="+BX.prop.getString(t,"code",""));e.preventDefault()})}this._helpWrapper.appendChild(e)}},getConfigScope:function(){return this._config.getScope()}};BX.Crm.EntityEditor.defaultInstance=null;BX.Crm.EntityEditor.items={};BX.Crm.EntityEditor.get=function(t){return this.items.hasOwnProperty(t)?this.items[t]:null};if(typeof BX.Crm.EntityEditor.messages==="undefined"){BX.Crm.EntityEditor.messages={}}BX.Crm.EntityEditor.setDefault=function(t){BX.Crm.EntityEditor.defaultInstance=t};BX.Crm.EntityEditor.getDefault=function(){return BX.Crm.EntityEditor.defaultInstance};BX.Crm.EntityEditor.create=function(t,e){var i=new BX.Crm.EntityEditor;i.initialize(t,e);this.items[i.getId()]=i;return i}}if(typeof BX.Crm.EntityEditorScopeConfig==="undefined"){BX.Crm.EntityEditorScopeConfig=function(){this._id="";this._settings={};this._editor={};this._config={};this._isCommonConfig=false;this._popup=null;this._selector=null;this._name="";this._items=[];this._nameInput={};this._usersInput={};this._nameInputError=null;this._usersInputError=null;this._entityId="";this._entityTypeId="";this._isOpened=false;this._closeNotifier=null;this._category=null;this._onSquareClick=BX.delegate(this.onSquareClick,this)};BX.Crm.EntityEditorScopeConfig.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=this.getSetting("editor",{});this._config=this.getSetting("config",{});this._isCommonConfig=this.getSetting("isCommonConfig",false);this._name=this.getSetting("name","");this._items=this.getSetting("items",[]);this._entityId=this.getSetting("entityId",null);this._entityTypeId=this.getSetting("entityTypeId",null);this._category=this.getSetting("category",null);this._userSelector=null},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.Crm.EntityEditorScopeConfig.messages;return e.hasOwnProperty(t)?e[t]:t},isOpened:function(){return this._isOpened},open:function(){if(this._isOpened){return}this._popup=this.createPopup();this._popup.show()},createPopup:function(){return this._popup||new BX.PopupWindow(this._id,null,{className:"crm-entity-widget-content-client-editor-popup",titleBar:this.getMessage("createScope"),closeIcon:true,autoHide:false,closeByEsc:true,padding:0,contentPadding:0,contentBackground:"none",draggable:true,minWidth:550,maxWidth:550,content:this.prepareContent(),buttons:this.prepareButtons(),events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}})},prepareContent:function(){var t=BX.create("div",{style:{padding:"0 20px"}});t.appendChild(this.prepareNameControl());t.appendChild(this.prepareUserSelectControl());return t},prepareNameControl:function(){var t=BX.create("div",{style:{paddingBottom:"25px",marginBottom:"20px",borderBottom:"1px solid #f2f2f4"}});t.appendChild(BX.create("div",{props:{className:"ui-ctl-label-text"},text:this.getMessage("scopeName")}));var e=BX.create("div",{props:{className:"ui-ctl ui-ctl-textbox ui-ctl-w100"}});this._nameInput=BX.create("input",{props:{className:"ui-ctl-element",value:this.getName(),type:"text",placeholder:this.getMessage("scopeNamePlaceholder")}});e.appendChild(this._nameInput);t.appendChild(e);return t},prepareUserSelectControl:function(){var t=BX.create("div",{style:{paddingBottom:"25px",borderBottom:"1px solid #f2f2f4"}});t.appendChild(BX.create("div",{props:{className:"ui-ctl-label-text"},text:this.getMessage("scopeMembers")}));var e=BX.create("div",{props:{className:"ui-ctl ui-ctl-textbox ui-ctl-w100"}});this._usersInput=BX.create("div",{props:{className:"ui-ctl-element main-ui-control-entity main-ui-control"},attrs:{id:"user-selector-item"},events:{click:BX.proxy(function(){this.openUserSelector(e)},this)}});e.appendChild(this._usersInput);t.appendChild(e);return t},prepareButtons:function(){return[new BX.UI.Button({text:this.getMessage("scopeSave"),tag:BX.UI.Button.Tag.LINK,color:BX.UI.Button.Color.PRIMARY,events:{click:function(t,e){e.preventDefault();this.processSave()}.bind(this)}}),new BX.UI.Button({text:this.getMessage("scopeCancel"),tag:BX.UI.Button.Tag.LINK,color:BX.UI.Button.Color.LINK,events:{click:function(t,e){e.preventDefault();this.processCancel()}.bind(this)}})]},close:function(){if(this._popup){this._popup.close()}},addCloseListener:function(t){this._closeNotifier.addListener(t)},removeCloseListener:function(t){this._closeNotifier.removeListener(t)},findItemIndexById:function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e].ID===t){return e}}return-1},removeItem:function(t){var e=this.findItemIndexById(t);if(e>=0){this._items=BX.util.deleteFromArray(this._items,e)}},adjust:function(){this.removeSquares();this._items.forEach(function(t,e,i){this.setSquare(t.FORMATTED_NAME,t.ID)},this)},addItem:function(t){if(this._items===null){this._items=[]}this._items.push(t);return t},setSquare:function(t,e){var i=BX.decl(this.createSquareData(t,e));i.setAttribute("data-user-id",e);BX.bind(i,"click",BX.delegate(this._onSquareClick,this));var n=this.getSquares();if(!n.length){BX.prepend(i,this._usersInput)}else{BX.insertAfter(i,n[n.length-1])}},getSquares:function(){return BX.Filter.Utils.getByClass(this._usersInput,"main-ui-square",true)},getItems:function(){return this._items||[]},removeItems:function(){this._items=[]},createUserInfo:function(t){return{ID:t.id,FORMATTED_NAME:BX.util.htmlspecialcharsback(BX.prop.getString(t,"name",""))}},isCustomized:function(){var t=BX.prop.getObject(this._config,"accessCodes",[]);return!!Object.keys(t).length},openUserSelector:function(t){this.getUserSelector().open(t)},getUserSelector:function(){if(!this._userSelector){this._userSelector=BX.Crm.EntityEditorUserSelector.create("user-selector-item",{callback:BX.delegate(this.processItemSelect,this),onlyUsers:false,showSearchInput:false})}return this._userSelector},processItemSelect:function(t,e){var i=BX.prop.getString(e,"id","");if(this.findItemIndexById(i)>=0){this.removeItem(i);this.adjust();return}this.addItem(this.createUserInfo(e));this.adjust()},getName:function(){return this._name},setName:function(t){this._name=t},processSave:function(){this.clearErrors();this.setName(this._nameInput.value);BX.ajax.runComponentAction("bitrix:ui.form.config","save",{data:{moduleId:this._category,entityTypeId:this._entityTypeId,name:this.getName(),accessCodes:this.getItems(),config:this._config,common:"Y"}}).then(function(t){this.close();BX.Crm.EntityEditorScopeConfig.prototype.notifyShow(t);var e=parseInt(t.data,10);this._editor.setConfigScope(BX.Crm.EntityConfigScope.custom,e)}.bind(this)).catch(function(t){this.fillErrors(t.data)}.bind(this))},fillErrors:function(t){if(t.name){this._nameInputError=this.createErrorElement(this._nameInput,t.name.message)}if(t.accessCodes){this._usersInputError=this.createErrorElement(this._usersInput,t.accessCodes.message)}},createErrorElement:function(t,e){var i=BX.create("div",{props:{className:"crm-entity-widget-content-error-text"}});i.innerHTML=e;t.parentNode.parentNode.appendChild(i);return i},clearErrors:function(){if(this._nameInputError){this._nameInputError.remove()}if(this._usersInputError){this._usersInputError.remove()}},notifyShow:function(t){window.top.BX.UI.Notification.Center.notify({content:this.getMessage("scopeSaved"),width:"auto"})},processCancel:function(){this.close()},onPopupShow:function(){this._isOpened=true},onPopupClose:function(){if(this._popup){this._popup.destroy()}},onPopupDestroy:function(){this._isOpened=false;this._popup=null},removeSquares:function(){this.getSquares().forEach(BX.remove)},createSquareData:function(t,e){return{block:"main-ui-square",name:t,item:{_label:t,_value:e}}},onSquareClick:function(t){t.preventDefault();var e=t.target.parentElement;var i=e.getAttribute("data-user-id");this.removeItem(i);this.adjust()}};if(BX.Crm.EntityEditorScopeConfig.messages===undefined){BX.Crm.EntityEditorScopeConfig.messages={}}BX.Crm.EntityEditorScopeConfig.create=function(t,e){var i=new BX.Crm.EntityEditorScopeConfig;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorModeQueue==="undefined"){BX.Crm.EntityEditorModeQueue=function(){this._id="";this._settings={};this._items=[]};BX.Crm.EntityEditorModeQueue.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{}},findIndex:function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]["control"]===t){return e}}return-1},getLength:function(){return this._items.length},add:function(t,e,i){if(typeof i==="undefined"){i=BX.Crm.EntityEditorModeOptions.none}var n=this.findIndex(t);if(n>=0){this._items[n]={control:t,mode:e,options:i}}else{this._items.push({control:t,mode:e,options:i})}},addBatch:function(t,e,i){for(var n=0,o=t.length;n<o;n++){this.add(t[n],e,i)}},remove:function(t){var e=this.findIndex(t);if(e>=0){this._items.splice(e,1)}},clear:function(){this._items=[]},process:function(){var t=this._items.length;if(t===0){return 0}for(var e=0;e<t;e++){var i=this._items[e];i["control"].setMode(i["mode"],{options:i["options"],notify:true})}return t}};BX.Crm.EntityEditorModeQueue.create=function(t,e){var i=new BX.Crm.EntityEditorModeQueue;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorModeSwitch==="undefined"){BX.Crm.EntityEditorModeSwitch=function(){this._id="";this._settings={};this._queue=null;this._isRunning=false;this._runHandle=0};BX.Crm.EntityEditorModeSwitch.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor");this._queue=BX.Crm.EntityEditorModeQueue.create(this._id,{})},getQueue:function(){return this._queue},reset:function(){this._queue.clear();this._isRunning=false},isRunning:function(){return this._isRunning},run:function(){if(this._isRunning){return}if(this._runHandle>0){window.clearTimeout(this._runHandle)}this._runHandle=window.setTimeout(BX.delegate(this.doRun,this),50)},doRun:function(){this._editor.saveDelayed();this._isRunning=true;this._runHandle=0},complete:function(){this._queue.process();this.reset()}};BX.Crm.EntityEditorModeSwitch.create=function(t,e){var i=new BX.Crm.EntityEditorModeSwitch;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorVisibilityPolicy==="undefined"){BX.Crm.EntityEditorVisibilityPolicy={always:0,view:1,edit:2,parse:function(t){t=t.toLowerCase();if(t==="view"){return this.view}else if(t==="edit"){return this.edit}return this.always},checkVisibility:function(t){var e=t.getMode();var i=t.getVisibilityPolicy();if(i===this.view){return e===BX.Crm.EntityEditorMode.view}else if(i===this.edit){return e===BX.Crm.EntityEditorMode.edit}return true}}}
//# sourceMappingURL=editor.map.js