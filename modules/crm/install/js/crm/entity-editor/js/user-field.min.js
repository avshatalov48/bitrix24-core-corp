BX.namespace("BX.Crm");if(typeof BX.Crm.EntityUserFieldType==="undefined"){BX.Crm.EntityUserFieldType={string:"string",integer:"integer",double:"double",boolean:"boolean",money:"money",date:"date",datetime:"datetime",enumeration:"enumeration",employee:"employee",crm:"crm",crmStatus:"crm_status",file:"file",url:"url"}}if(typeof BX.Crm.EntityUserFieldManager==="undefined"){BX.Crm.EntityUserFieldManager=function(){this._id="";this._settings={};this._entityId=0;this._fieldEntityId="";this._enableCreation=false;this._creationSignature="";this._creationUrl="";this._activeFields={};this._validationResult=null;this._validationPromise=null;this._config=null};BX.Crm.EntityUserFieldManager.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._entityId=BX.prop.getInteger(this._settings,"entityId",0);this._fieldEntityId=BX.prop.getString(this._settings,"fieldEntityId","");this._enableCreation=BX.prop.getBoolean(this._settings,"enableCreation",false);this._creationSignature=BX.prop.getString(this._settings,"creationSignature","");this._creationPageUrl=BX.prop.getString(this._settings,"creationPageUrl","")},isCreationEnabled:function(){return this._enableCreation},isModificationEnabled:function(){return this._enableCreation},getDefaultFieldLabel:function(t){if(t==="string"){return this.getMessage("stringLabel")}else if(t==="double"){return this.getMessage("doubleLabel")}else if(t==="money"){return this.getMessage("moneyLabel")}else if(t==="datetime"){return this.getMessage("datetimeLabel")}else if(t==="enumeration"){return this.getMessage("enumerationLabel")}else if(t==="file"){return this.getMessage("fileLabel")}return this.getMessage("label")},getMessage:function(t){var e=BX.Crm.EntityUserFieldManager.messages;return e.hasOwnProperty(t)?e[t]:t},getAdditionalTypeList:function(){return BX.Crm.EntityUserFieldManager.additionalTypeList},getTypeInfos:function(){var t=[];t.push({name:"string",title:this.getMessage("stringTitle"),legend:this.getMessage("stringLegend")});t.push({name:"enumeration",title:this.getMessage("enumerationTitle"),legend:this.getMessage("enumerationLegend")});t.push({name:"datetime",title:this.getMessage("datetimeTitle"),legend:this.getMessage("datetimeLegend")});t.push({name:"address",title:this.getMessage("addressTitle"),legend:this.getMessage("addressLegend")});if(this._fieldEntityId==="CRM_LEAD"||this._fieldEntityId==="CRM_DEAL"){t.push({name:"resourcebooking",title:this.getMessage("resourcebookingTitle"),legend:this.getMessage("resourcebookingLegend")})}t.push({name:"url",title:this.getMessage("urlTitle"),legend:this.getMessage("urlLegend")});t.push({name:"file",title:this.getMessage("fileTitle"),legend:this.getMessage("fileLegend")});t.push({name:"money",title:this.getMessage("moneyTitle"),legend:this.getMessage("moneyLegend")});t.push({name:"boolean",title:this.getMessage("booleanTitle"),legend:this.getMessage("booleanLegend")});t.push({name:"double",title:this.getMessage("doubleTitle"),legend:this.getMessage("doubleLegend")});var e=this.getAdditionalTypeList();for(var i=0;i<e.length;i++){t.push({name:e[i].USER_TYPE_ID,title:e[i].TITLE,legend:e[i].LEGEND})}t.push({name:"custom",title:this.getMessage("customTitle"),legend:this.getMessage("customLegend")});return t},getCreationPageUrl:function(){return this._creationPageUrl},createField:function(t,e){if(!this._enableCreation){return}var i=BX.prop.getString(t,"USER_TYPE_ID","");if(i===""){i=BX.Crm.EntityUserFieldType.string}if(!BX.type.isNotEmptyString(t["EDIT_FORM_LABEL"])){t["EDIT_FORM_LABEL"]=this.getDefaultFieldLabel(i)}if(!BX.type.isNotEmptyString(t["LIST_COLUMN_LABEL"])){t["LIST_COLUMN_LABEL"]=t["EDIT_FORM_LABEL"]}if(!BX.type.isNotEmptyString(t["LIST_FILTER_LABEL"])){t["LIST_FILTER_LABEL"]=t["LIST_COLUMN_LABEL"]}this.addFieldLabel("EDIT_FORM_LABEL",t["EDIT_FORM_LABEL"],t);this.addFieldLabel("LIST_COLUMN_LABEL",t["LIST_COLUMN_LABEL"],t);this.addFieldLabel("LIST_FILTER_LABEL",t["LIST_FILTER_LABEL"],t);var r=new BX.Promise;var n=function(t){r.fulfill(t)};if(!BX.type.isNotEmptyString(t["FIELD"])){t["FIELD"]="UF_CRM_"+(new Date).getTime().toString()}t["ENTITY_ID"]=this._fieldEntityId;t["SIGNATURE"]=this._creationSignature;if(!BX.type.isNotEmptyString(t["MULTIPLE"])){t["MULTIPLE"]="N"}if(!BX.type.isNotEmptyString(t["MANDATORY"])){t["MANDATORY"]="N"}if(i===BX.Crm.EntityUserFieldType.file){t["SHOW_FILTER"]="N";t["SHOW_IN_LIST"]="N"}else{if(i===BX.Crm.EntityUserFieldType.employee||i===BX.Crm.EntityUserFieldType.crm||i===BX.Crm.EntityUserFieldType.crmStatus){t["SHOW_FILTER"]="I"}else{t["SHOW_FILTER"]="E"}t["SHOW_IN_LIST"]="Y"}if(i===BX.Crm.EntityUserFieldType.enumeration){if(!t.hasOwnProperty("SETTINGS")){t["SETTINGS"]={}}t["SETTINGS"]["DISPLAY"]="UI"}if(i===BX.Crm.EntityUserFieldType.boolean){if(!t.hasOwnProperty("SETTINGS")){t["SETTINGS"]={}}t["SETTINGS"]["LABEL_CHECKBOX"]=t["EDIT_FORM_LABEL"]}if(i===BX.Crm.EntityUserFieldType.double){if(!t.hasOwnProperty("SETTINGS")){t["SETTINGS"]={}}t["SETTINGS"]["PRECISION"]=2}if(e===BX.Crm.EntityEditorMode.view){BX.Main.UF.ViewManager.add({FIELDS:[t]},n)}else{BX.Main.UF.EditManager.add({FIELDS:[t]},n)}return r},updateField:function(t,e){t["ENTITY_ID"]=this._fieldEntityId;t["SIGNATURE"]=this._creationSignature;if(BX.type.isNotEmptyString(t["EDIT_FORM_LABEL"])){this.addFieldLabel("EDIT_FORM_LABEL",t["EDIT_FORM_LABEL"],t)}if(BX.type.isNotEmptyString(t["LIST_COLUMN_LABEL"])){this.addFieldLabel("LIST_COLUMN_LABEL",t["LIST_COLUMN_LABEL"],t)}if(BX.type.isNotEmptyString(t["LIST_FILTER_LABEL"])){this.addFieldLabel("LIST_FILTER_LABEL",t["LIST_FILTER_LABEL"],t)}var i=new BX.Promise;var r=function(t){i.fulfill(t)};if(e===BX.Crm.EntityEditorMode.view){BX.Main.UF.ViewManager.update({FIELDS:[t]},r)}else{BX.Main.UF.EditManager.update({FIELDS:[t]},r)}return i},resolveFieldName:function(t){return BX.prop.getString(t,"FIELD","")},addFieldLabel:function(t,e,i){var r=BX.prop.getArray(this._settings,"languages",[]);if(r.length===0){i[t]=e;return}i[t]={};for(var n=0,s=r.length;n<s;n++){var o=r[n];i[t][o["LID"]]=e}},prepareSchemeElementSettings:function(t){var e=BX.prop.getString(t,"FIELD","");if(e===""){return null}if(BX.prop.getString(t,"USER_TYPE_ID","")===""){t["USER_TYPE_ID"]="string"}if(BX.prop.getString(t,"ENTITY_ID","")===""){t["ENTITY_ID"]=this._fieldEntityId}if(BX.prop.getInteger(t,"ENTITY_VALUE_ID",0)<=0){t["ENTITY_VALUE_ID"]=this._entityId}return{name:e,originalTitle:BX.prop.getString(t,"EDIT_FORM_LABEL",e),title:BX.prop.getString(t,"EDIT_FORM_LABEL",e),type:"userField",required:BX.prop.getString(t,"MANDATORY","N")==="Y",data:{fieldInfo:t}}},createSchemeElement:function(t){return BX.Crm.EntitySchemeElement.create(this.prepareSchemeElementSettings(t))},updateSchemeElement:function(t,e){var i=this.prepareSchemeElementSettings(e);i["title"]=t.getTitle();t.mergeSettings(i)},registerActiveField:function(t){var e=t.getName();this._activeFields[e]=t;BX.Main.UF.EditManager.registerField(e,t.getFieldInfo(),t.getFieldNode())},unregisterActiveField:function(t){var e=t.getName();if(this._activeFields.hasOwnProperty(e)){delete this._activeFields[e]}BX.Main.UF.EditManager.unRegisterField(e)},validate:function(t){var e=[];for(var i in this._activeFields){if(this._activeFields.hasOwnProperty(i)){e.push(i)}}if(e.length>0){this._validationResult=t;BX.Main.UF.EditManager.validate(e,BX.delegate(this.onValidationComplete,this))}else{window.setTimeout(BX.delegate(function(){if(this._validationPromise){this._validationPromise.fulfill();this._validationPromise=null}},this),0)}this._validationPromise=new BX.Promise;return this._validationPromise},onValidationComplete:function(t){var e;for(e in this._activeFields){if(this._activeFields.hasOwnProperty(e)){this._activeFields[e].clearError()}}for(e in t){if(!t.hasOwnProperty(e)){continue}if(this._activeFields.hasOwnProperty(e)){var i=this._activeFields[e];i.showError(t[e]);this._validationResult.addError(BX.Crm.EntityValidationError.create({field:i}))}}if(this._validationPromise){this._validationPromise.fulfill()}this._validationResult=null;this._validationPromise=null}};if(typeof BX.Crm.EntityUserFieldManager.messages==="undefined"){BX.Crm.EntityUserFieldManager.messages={}}BX.Crm.EntityUserFieldManager.items={};BX.Crm.EntityUserFieldManager.create=function(t,e){var i=new BX.Crm.EntityUserFieldManager;i.initialize(t,e);this.items[t]=i;return i}}if(typeof BX.Crm.EntityUserFieldLayoutLoader==="undefined"){BX.Crm.EntityUserFieldLayoutLoader=function(){this._id="";this._settings={};this._mode=BX.Crm.EntityEditorMode.view;this._enableBatchMode=true;this._owner=null;this._items=[]};BX.Crm.EntityUserFieldLayoutLoader.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._mode=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.view);this._enableBatchMode=BX.prop.getBoolean(this._settings,"enableBatchMode",true);this._owner=BX.prop.get(this._settings,"owner",null)},getId:function(){return this._id},getOwner:function(){return this._owner},addItem:function(t){this._items.push(t)},run:function(){if(!this._enableBatchMode){this.startRequest()}},runBatch:function(){if(this._enableBatchMode){this.startRequest()}},startRequest:function(){if(this._items.length===0){return}var t=[];for(var e=0,i=this._items.length;e<i;e++){if(BX.prop.getString(this._items[e],"name","")!==""){t.push(BX.prop.getObject(this._items[e],"field",{}))}}if(t.length===0){return}var r={FIELDS:t,FORM:this._id,CONTEXT:"CRM_EDITOR"};if(this._mode===BX.Crm.EntityEditorMode.view){BX.Main.UF.Manager.getView(r,BX.delegate(this.onRequestComplete,this))}else{BX.Main.UF.Manager.getEdit(r,BX.delegate(this.onRequestComplete,this))}},onRequestComplete:function(t){for(var e=0,i=this._items.length;e<i;e++){var r=this._items[e];var n=BX.prop.getString(r,"name","");var s=BX.prop.getFunction(r,"callback",null);if(n!==""&&s!==null){s(BX.prop.getObject(t,n,{}))}}}};BX.Crm.EntityUserFieldLayoutLoader.create=function(t,e){var i=new BX.Crm.EntityUserFieldLayoutLoader;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUserFieldConfigurator==="undefined"){BX.Crm.EntityEditorUserFieldConfigurator=function(){BX.Crm.EntityEditorUserFieldConfigurator.superclass.constructor.apply(this);this._field=null;this._typeId="";this._isLocked=false;this._labelInput=null;this._saveButton=null;this._cancelButton=null;this._isTimeEnabledCheckBox=null;this._isRequiredCheckBox=null;this._isUserAccessCheckBox=null;this._isMultipleCheckBox=null;this._showAlwaysCheckBox=null;this._enumItemWrapper=null;this._enumItemContainer=null;this._enumButtonWrapper=null;this._optionWrapper=null;this._userSelector=null;this._enumItems=null;this._mandatoryConfigurator=null;this._visibilityConfigurator=null};BX.extend(BX.Crm.EntityEditorUserFieldConfigurator,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorUserFieldConfigurator.prototype.doInitialize=function(){BX.Crm.EntityEditorUserFieldConfigurator.superclass.doInitialize.apply(this);this._field=BX.prop.get(this._settings,"field",null);if(this._field&&!(this._field instanceof BX.Crm.EntityEditorUserField)){throw"EntityEditorUserFieldConfigurator. The 'field' param must be EntityEditorUserField."}this._mandatoryConfigurator=BX.prop.get(this._settings,"mandatoryConfigurator",null);this._visibilityConfigurator=BX.prop.get(this._settings,"visibilityConfigurator",null);this._typeId=BX.prop.getString(this._settings,"typeId","");this._enumItems=[]};BX.Crm.EntityEditorUserFieldConfigurator.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorUserFieldConfigurator.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorUserFieldConfigurator.prototype.layout=function(t){if(this._hasLayout){return}if(this._mode===BX.Crm.EntityEditorMode.view){throw"EntityEditorUserFieldConfigurator. View mode is not supported by this control type."}var e=this._field===null;var i=this.getMessage("labelField");var r=this._editor.getUserFieldManager();var n=this._field?this._field.getTitle():r.getDefaultFieldLabel(this._typeId);this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-new-fields"}});this._labelInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",type:"text",value:n}});this._saveButton=BX.create("span",{props:{className:"ui-btn ui-btn-primary"},text:BX.message("CRM_EDITOR_SAVE"),events:{click:BX.delegate(this.onSaveButtonClick,this)}});this._cancelButton=BX.create("span",{props:{className:"ui-btn ui-btn-light-border"},text:BX.message("CRM_EDITOR_CANCEL"),events:{click:BX.delegate(this.onCancelButtonClick,this)}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:i})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._labelInput]})]})]}));if(this._typeId==="enumeration"){this._wrapper.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}));this._enumItemWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});this._wrapper.appendChild(this._enumItemWrapper);this._enumItemWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:this.getMessage("enumItems")})]}));this._enumItemContainer=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._enumItemWrapper.appendChild(this._enumItemContainer);this._enumButtonWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-add-field"}});this._enumItemWrapper.appendChild(this._enumButtonWrapper);this._enumButtonWrapper.appendChild(BX.create("span",{props:{className:"crm-entity-widget-content-add-field"},events:{click:BX.delegate(this.onEnumerationItemAddButtonClick,this)},text:this.getMessage("add")}));if(this._field){var s=this._field.getFieldInfo();var o=BX.prop.getArray(s,"ENUM",[]);for(var a=0,l=o.length;a<l;a++){this.createEnumerationItem(o[a])}}this.createEnumerationItem()}this._optionWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-checkbox"},children:[this._optionWrapper]}));var d=0;if(e&&(this._typeId==="datetime"||this._typeId==="date")){this._isTimeEnabledCheckBox=this.createOption({caption:this.getMessage("enableTime")});d++}if(this._typeId==="datetime"){this._useTimezoneCheckBox=this.createOption({caption:BX.Crm.EntityEditorFieldConfigurator.messages["useTimezone"]});this._useTimezoneCheckBox.checked=e?false:this._field.getFieldSettings().USE_TIMEZONE==="Y";d++}if(this._typeId!=="boolean"){if(this._mandatoryConfigurator){this._isRequiredCheckBox=this.createOption({caption:this._mandatoryConfigurator.getTitle()+":",labelSettings:{props:{className:"crm-entity-new-field-addiction-label"}},containerSettings:{style:{alignItems:"center"}},elements:this._mandatoryConfigurator.getButton().prepareLayout()});this._isRequiredCheckBox.checked=this._field&&this._field.isRequired()||this._mandatoryConfigurator.isCustomized();this._mandatoryConfigurator.setSwitchCheckBox(this._isRequiredCheckBox);this._mandatoryConfigurator.setLabel(this._isRequiredCheckBox.nextSibling);this._mandatoryConfigurator.setEnabled(this._isRequiredCheckBox.checked);this._mandatoryConfigurator.adjust()}else{this._isRequiredCheckBox=this.createOption({caption:this.getMessage("isRequiredField")});this._isRequiredCheckBox.checked=this._field&&this._field.isRequired()}d++;if(e){this._isMultipleCheckBox=this.createOption({caption:this.getMessage("isMultipleField")});d++}}this._showAlwaysCheckBox=this.createOption({caption:this.getMessage("showAlways"),help:{code:"7046149"}});this._showAlwaysCheckBox.checked=e?BX.prop.getBoolean(this._settings,"showAlways",true):this._field.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways);d++;if(this._visibilityConfigurator){this._visibilityUserFieldCheckbox=this.createOption({caption:this._visibilityConfigurator.getTitle(),containerSettings:{style:{alignItems:"center"}},elements:this._visibilityConfigurator.getButton().prepareLayout(),wrapperClass:"crm-entity-widget-content-block-field-container-block"});this._visibilityUserFieldCheckbox.checked=this._visibilityConfigurator.isCustomized();this._visibilityConfigurator.setSwitchCheckBox(this._visibilityUserFieldCheckbox);this._visibilityConfigurator.setEnabled(this._visibilityUserFieldCheckbox.checked);this._visibilityConfigurator.adjust();d++}if(d>0){this._wrapper.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}))}this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-new-fields-btn-container"},children:[this._saveButton,this._cancelButton]}));this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorUserFieldConfigurator.prototype.clearLayout=function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._labelInput=null;this._saveButton=null;this._cancelButton=null;this._isTimeEnabledCheckBox=null;this._isRequiredCheckBox=null;this._isMultipleCheckBox=null;this._showAlwaysCheckBox=null;this._enumItemWrapper=null;this._enumButtonWrapper=null;this._enumItemContainer=null;this._optionWrapper=null;this._enumItems=[];this._hasLayout=false};BX.Crm.EntityEditorUserFieldConfigurator.prototype.onEnumerationItemAddButtonClick=function(t){this.createEnumerationItem().focus()};BX.Crm.EntityEditorUserFieldConfigurator.prototype.createEnumerationItem=function(t){var e=BX.Crm.EntityEditorUserFieldListItem.create("",{configurator:this,container:this._enumItemContainer,data:t});this._enumItems.push(e);e.layout();return e};BX.Crm.EntityEditorUserFieldConfigurator.prototype.removeEnumerationItem=function(t){for(var e=0,i=this._enumItems.length;e<i;e++){if(this._enumItems[e]===t){this._enumItems[e].clearLayout();this._enumItems.splice(e,1);break}}};BX.Crm.EntityEditorUserFieldConfigurator.prototype.createOption=function(t){var e=BX.create("input",{props:{type:"checkbox"}});var i=BX.create("label",{children:[e,BX.create("span",{text:BX.prop.getString(t,"caption","")})]});var r=BX.prop.getObject(t,"labelSettings",null);if(r){BX.adjust(i,r)}var n=BX.prop.getObject(t,"help",null);if(n){var s=BX.create("a",{props:{className:"crm-entity-new-field-helper-icon"}});var o=BX.prop.getString(n,"url","");if(o!==""){s.href=o;s.target="_blank"}else{s.href="#";BX.bind(s,"click",function(t){window.top.BX.Helper.show("redirect=detail&code="+BX.prop.getString(n,"code",""));t.preventDefault()})}i.appendChild(s)}var a=[i];var l=BX.prop.getArray(t,"elements",[]);for(var d=0,p=l.length;d<p;d++){a.push(l[d])}var h=BX.prop.getString(t,"wrapperClass","");var u=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container "+h},children:a});var c=BX.prop.getObject(t,"containerSettings",null);if(c){BX.adjust(u,c)}this._optionWrapper.appendChild(u);return e};BX.Crm.EntityEditorUserFieldConfigurator.prototype.onSaveButtonClick=function(t){if(this._isLocked){return}if(this._mandatoryConfigurator){if(this._mandatoryConfigurator.isChanged()){this._mandatoryConfigurator.acceptChanges()}this._mandatoryConfigurator.close()}var e={typeId:this._typeId,label:this._labelInput.value};if(this._field){e["field"]=this._field;if(this._isRequiredCheckBox){e["mandatory"]=this._isRequiredCheckBox.checked}}else{if(this._typeId==="boolean"){e["multiple"]=false}else{if(this._isMultipleCheckBox){e["multiple"]=this._isMultipleCheckBox.checked}e["mandatory"]=this._isRequiredCheckBox.checked}if(this._typeId==="datetime"){e["enableTime"]=this._isTimeEnabledCheckBox.checked}}if(this._typeId==="datetime"){e["settings"]=[];e["settings"].USE_TIMEZONE=this._useTimezoneCheckBox.checked?"Y":"N"}if(this._typeId==="enumeration"){e["enumeration"]=[];var i=[];for(var r=0,n=this._enumItems.length;r<n;r++){var s=this._enumItems[r].prepareData();if(!s){continue}var o=BX.util.hashCode(s["VALUE"]);if(BX.util.in_array(o,i)){continue}i.push(o);s["SORT"]=(e["enumeration"].length+1)*100;e["enumeration"].push(s)}}e["showAlways"]=this._showAlwaysCheckBox.checked;BX.onCustomEvent(this,"onSave",[this,e])};BX.Crm.EntityEditorUserFieldConfigurator.prototype.onCancelButtonClick=function(t){if(this._isLocked){return}var e={typeId:this._typeId};if(this._field){e["field"]=this._field}BX.onCustomEvent(this,"onCancel",[this,e])};BX.Crm.EntityEditorUserFieldConfigurator.prototype.setLocked=function(t){t=!!t;if(this._isLocked===t){return}this._isLocked=t;if(this._isLocked){BX.addClass(this._saveButton,"ui-btn-clock")}else{BX.removeClass(this._saveButton,"ui-btn-clock")}};BX.Crm.EntityEditorUserFieldConfigurator.prototype.getField=function(){return this._field};if(typeof BX.Crm.EntityEditorUserFieldConfigurator.messages==="undefined"){BX.Crm.EntityEditorUserFieldConfigurator.messages={}}BX.Crm.EntityEditorUserFieldConfigurator.create=function(t,e){var i=new BX.Crm.EntityEditorUserFieldConfigurator;i.initialize(t,e);return i};BX.onCustomEvent(window,"BX.Crm.EntityEditorUserFieldConfigurator:onDefine")}if(typeof BX.Crm.EntityEditorUserFieldListItem==="undefined"){BX.Crm.EntityEditorUserFieldListItem=function(){this._id="";this._settings=null;this._data=null;this._configurator=null;this._container=null;this._labelInput=null;this._hasLayout=false};BX.Crm.EntityEditorUserFieldListItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=BX.type.isPlainObject(e)?e:{};this._data=BX.prop.getObject(this._settings,"data",{});this._configurator=BX.prop.get(this._settings,"configurator");this._container=BX.prop.getElementNode(this._settings,"container")},layout:function(){if(this._hasLayout){return}this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"}});this._labelInput=BX.create("input",{props:{className:"crm-entity-widget-content-input",type:"input",value:BX.prop.getString(this._data,"VALUE","")}});this._wrapper.appendChild(this._labelInput);this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-remove-block"},events:{click:BX.delegate(this.onDeleteButtonClick,this)}}));var t=BX.prop.getElementNode(this._settings,"anchor");if(t){this._container.insertBefore(this._wrapper,t)}else{this._container.appendChild(this._wrapper)}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},focus:function(){if(this._labelInput){this._labelInput.focus()}},prepareData:function(){var t=this._labelInput?BX.util.trim(this._labelInput.value):"";if(t===""){return null}var e={VALUE:t};var i=BX.prop.getInteger(this._data,"ID",0);if(i>0){e["ID"]=i}var r=BX.prop.getString(this._data,"XML_ID","");if(i>0){e["XML_ID"]=r}return e},onDeleteButtonClick:function(t){this._configurator.removeEnumerationItem(this)}};BX.Crm.EntityEditorUserFieldListItem.create=function(t,e){var i=new BX.Crm.EntityEditorUserFieldListItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUserField==="undefined"){BX.Crm.EntityEditorUserField=function(){BX.Crm.EntityEditorUserField.superclass.constructor.apply(this);this._innerWrapper=null;this._isLoaded=false;this._focusOnLoad=false};BX.extend(BX.Crm.EntityEditorUserField,BX.Crm.EntityEditorField);BX.Crm.EntityEditorUserField.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorUserField.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorUserField.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorUserField.prototype.doInitialize=function(){BX.Crm.EntityEditorUserField.superclass.doInitialize.apply(this);this._manager=this._editor.getUserFieldManager()};BX.Crm.EntityEditorUserField.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorUserField.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorUserField.prototype.getOptions=function(){return this._schemeElement.getDataParam("options",{})};BX.Crm.EntityEditorUserField.prototype.getFieldInfo=function(){return this._schemeElement.getDataParam("fieldInfo",{})};BX.Crm.EntityEditorUserField.prototype.getFieldType=function(){return BX.prop.getString(this.getFieldInfo(),"USER_TYPE_ID","")};BX.Crm.EntityEditorUserField.prototype.getFieldSettings=function(){return BX.prop.getObject(this.getFieldInfo(),"SETTINGS",{})};BX.Crm.EntityEditorUserField.prototype.isMultiple=function(){return BX.prop.getString(this.getFieldInfo(),"MULTIPLE","N")==="Y"};BX.Crm.EntityEditorUserField.prototype.getEntityValueId=function(){return BX.prop.getString(this.getFieldInfo(),"ENTITY_VALUE_ID","")};BX.Crm.EntityEditorUserField.prototype.getFieldValue=function(){var t=this.getValue();var e=BX.prop.getArray(t,"VALUE",null);if(e===null){e=BX.prop.getString(t,"VALUE","")}return e};BX.Crm.EntityEditorUserField.prototype.getFieldSignature=function(){return BX.prop.getString(this.getValue(),"SIGNATURE","")};BX.Crm.EntityEditorUserField.prototype.isTitleEnabled=function(){var t=this.getFieldInfo();var e=BX.prop.getString(t,"USER_TYPE_ID","");if(e!=="boolean"){return true}return BX.prop.getString(BX.prop.getObject(t,"SETTINGS",{}),"DISPLAY","")!=="CHECKBOX"};BX.Crm.EntityEditorUserField.prototype.getFieldNode=function(){return this._innerWrapper};BX.Crm.EntityEditorUserField.prototype.doGetEditPriority=function(){return BX.prop.get(BX.prop.getObject(this.getFieldInfo(),"SETTINGS"),"DEFAULT_VALUE")?BX.Crm.EntityEditorPriority.high:BX.Crm.EntityEditorPriority.normal};BX.Crm.EntityEditorUserField.prototype.checkIfNotEmpty=function(t){if(BX.prop.getBoolean(t,"IS_EMPTY",false)){return false}var e;if(this.getFieldType()===BX.Crm.EntityUserFieldType.boolean){e=BX.prop.getString(t,"VALUE","");return e!==""}e=BX.prop.getArray(t,"VALUE",null);if(e===null){e=BX.prop.getString(t,"VALUE","")}return BX.type.isArray(e)?e.length>0:e!==""};BX.Crm.EntityEditorUserField.prototype.getValue=function(t){if(t===undefined){t=null}if(!this._model){return t}return this._model.getField(this.getName(),t)};BX.Crm.EntityEditorUserField.prototype.hasContentToDisplay=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){return true}return this.checkIfNotEmpty(this.getValue())};BX.Crm.EntityEditorUserField.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getName();var i=this.getTitle();var r=this.getFieldInfo();var n=this.getValue();var s=BX.prop.getString(n,"SIGNATURE","");this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var o=this.getFieldType();if(o===BX.Crm.EntityUserFieldType.string){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-text")}else if(o===BX.Crm.EntityUserFieldType.integer||o===BX.Crm.EntityUserFieldType.double){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-number")}else if(o===BX.Crm.EntityUserFieldType.money){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-money")}else if(o===BX.Crm.EntityUserFieldType.date||o===BX.Crm.EntityUserFieldType.datetime){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-date")}else if(o===BX.Crm.EntityUserFieldType.boolean){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-checkbox")}else if(o===BX.Crm.EntityUserFieldType.enumeration){BX.addClass(this._wrapper,this.isMultiple()?"crm-entity-widget-content-block-field-custom-multiselect":"crm-entity-widget-content-block-field-custom-select")}else if(o===BX.Crm.EntityUserFieldType.file){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-file")}else if(o===BX.Crm.EntityUserFieldType.url){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-custom-link")}this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){if(this.isTitleEnabled()){this._wrapper.appendChild(this.createTitleNode(i))}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}})}else{this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}})}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);if(this.hasContentToDisplay()){var a=BX.prop.getString(t,"html","");if(a===""){a=BX.prop.getString(BX.prop.getObject(n,"HTML",{}),BX.Crm.EntityEditorMode.getName(this._mode).toUpperCase(),"")}if(a!==""){this.setupContentHtml(a);this._hasLayout=true}else{this._isLoaded=false;var l=null;if(!this.isInSingleEditMode()){l=BX.prop.get(t,"userFieldLoader",null)}if(!l){l=BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:this._mode,enableBatchMode:false})}var d=BX.clone(r);d["SIGNATURE"]=s;if(o===BX.Crm.EntityUserFieldType.file&&BX.type.isObject(d["ADDITIONAL"])){var p=BX.prop.getString(BX.prop.getObject(n,"EXTRAS",{}),"OWNER_TOKEN","");if(p!==""){d["ADDITIONAL"]["URL_TEMPLATE"]+="&owner_token="+encodeURIComponent(p)}}if(this.checkIfNotEmpty(n)){var h=BX.prop.getArray(n,"VALUE",null);if(h===null){h=BX.prop.getString(n,"VALUE","")}d["VALUE"]=h}this.adjustFieldParams(d,true);l.addItem({name:e,field:d,callback:BX.delegate(this.onLayoutLoaded,this)});l.run()}}else{this._innerWrapper.appendChild(document.createTextNode(this.getMessage("isEmpty")));this._hasLayout=true}};BX.Crm.EntityEditorUserField.prototype.doRegisterLayout=function(){};BX.Crm.EntityEditorUserField.prototype.adjustFieldParams=function(t,e){var i=this.getFieldType();if(i===BX.Crm.EntityUserFieldType.boolean){if(!BX.type.isPlainObject(t["SETTINGS"])){t["SETTINGS"]={}}t["SETTINGS"]["LABEL_CHECKBOX"]=this.getTitle()}if(e&&typeof t["VALUE"]!=="undefined"&&this._mode===BX.Crm.EntityEditorMode.edit&&BX.prop.getInteger(t,"ENTITY_VALUE_ID")<=0){t["ENTITY_VALUE_ID"]=1}};BX.Crm.EntityEditorUserField.prototype.doClearLayout=function(t){this._innerWrapper=null};BX.Crm.EntityEditorUserField.prototype.validate=function(){return true};BX.Crm.EntityEditorUserField.prototype.save=function(){};BX.Crm.EntityEditorUserField.prototype.focus=function(){if(this._mode!==BX.Crm.EntityEditorMode.edit){return}if(this._isLoaded){this.doFocus()}else{this._focusOnLoad=true}};BX.Crm.EntityEditorUserField.prototype.doFocus=function(){BX.Main.UF.Factory.focus(this.getName())};BX.Crm.EntityEditorUserField.prototype.setupContentHtml=function(t){if(this._innerWrapper){BX.html(this._innerWrapper,t).then(function(){this.onLayoutSuccess();this._isLoaded=true;if(this._focusOnLoad===true){this.doFocus();this._focusOnLoad=false}}.bind(this))}};BX.Crm.EntityEditorUserField.prototype.doSetActive=function(){if(!this._isActive){this._manager.unregisterActiveField(this)}};BX.Crm.EntityEditorUserField.prototype.rollback=function(){this._manager.unregisterActiveField(this)};BX.Crm.EntityEditorUserField.prototype.onLayoutSuccess=function(){if(this._isActive){this._manager.registerActiveField(this)}window.setTimeout(function(){BX.bindDelegate(this._innerWrapper,"bxchange",{tag:["input","select","textarea"]},this._changeHandler)}.bind(this),200);var t=this.getFieldType();if(t===BX.Crm.EntityUserFieldType.employee){var e=this._innerWrapper.querySelector(".feed-add-destination-link");if(e){BX.bind(e,"click",BX.delegate(this.onEmployeeSelectorOpen,this))}}if(t===BX.Crm.EntityUserFieldType.boolean){if(this._mode===BX.Crm.EntityEditorMode.edit&&!this.checkIfNotEmpty(this.getValue())){this.markAsChanged()}}if(!this._hasLayout){this._hasLayout=true}BX.removeCustomEvent(window,"onCrmEntityEditorUserFieldExternalChanged",BX.proxy(this.userFieldExternalChangedHandler,this));BX.addCustomEvent(window,"onCrmEntityEditorUserFieldExternalChanged",BX.proxy(this.userFieldExternalChangedHandler,this));BX.removeCustomEvent(window,"onCrmEntityEditorUserFieldSetValidator",BX.proxy(this.userFieldSetValidatorHandler,this));BX.addCustomEvent(window,"onCrmEntityEditorUserFieldSetValidator",BX.proxy(this.userFieldSetValidatorHandler,this))};BX.Crm.EntityEditorUserField.prototype.processContextMenuCommand=function(t,e){if(e==="moveAddrToRequisite"){this.showUfAddrConverterPopup()}BX.Crm.EntityEditorUserField.superclass.processContextMenuCommand.apply(this,[t,e])};BX.Crm.EntityEditorUserField.prototype.showUfAddrConverterPopup=function(){var t=this.getFieldInfo();var e="crmUfAddrConvPopup_"+t["ENTITY_ID"]+"_"+t["ENTITY_VALUE_ID"]+"_"+t["FIELD"];var i=this.getMessage("moveAddrToRequisiteHtml");var r=window.body;var n=this.getWrapper();var s=BX.Main.PopupManager.create(e,r,{cacheable:false,closeIcon:true,offsetLeft:15,lightShadow:true,overlay:true,titleBar:this.getMessage("moveAddrToRequisite"),draggable:true,closeByEsc:true,maxHeight:window.innerHeight-50,width:n.clientWidth,content:i,buttons:[new BX.UI.Button({text:this.getMessage("moveAddrToRequisiteBtnStart"),className:"ui-btn ui-btn-primary",events:{click:function(){s.close();var e=function(t){var e=BX.prop.getString(t,"status","");var i=BX.prop.getObject(t,"data",{});var r=[];var n;var s;if(e==="error"){n=BX.prop.getArray(t,"errors",[]);for(s=0;s<n.length;s++){r.push(BX.prop.getString(n[s],"message"))}}if(r.length>0){BX.UI.Notification.Center.notify({content:r.join("<br>"),position:"top-center",autoHideDelay:1e4})}else{this.hide();BX.UI.Notification.Center.notify({content:this.getMessage("moveAddrToRequisiteStartSuccess"),position:"top-center",autoHideDelay:1e4})}}.bind(this);BX.ajax.runAction("crm.requisite.converter.ufAddressConvert",{data:{entityTypeId:t["ENTITY_ID"],fieldName:t["FIELD"]}}).then(e,e)}.bind(this)}}),new BX.UI.Button({text:this.getMessage("moveAddrToRequisiteBtnCancel"),className:"ui-btn ui-btn-link",events:{click:function(){s.close()}.bind(this)}})]});s.show()};BX.Crm.EntityEditorUserField.prototype.prepareContextMenuItems=function(){var t=BX.Crm.EntityEditorUserField.superclass.prepareContextMenuItems.apply(this);var e=this.getOptions();if(BX.type.isPlainObject(e)&&e.hasOwnProperty("canActivateUfAddressConverter")&&e["canActivateUfAddressConverter"]==="Y"){t.push({value:"moveAddrToRequisite",text:this.getMessage("moveAddrToRequisite")})}return t};BX.Crm.EntityEditorUserField.prototype.userFieldExternalChangedHandler=function(t){if(t==this._id&&BX.type.isFunction(this._changeHandler)){this._changeHandler()}};BX.Crm.EntityEditorUserField.prototype.userFieldSetValidatorHandler=function(t,e){if(t==this._id&&BX.type.isFunction(e)){this.validate=e}};BX.Crm.EntityEditorUserField.prototype.onLayoutLoaded=function(t){var e=BX.prop.getString(t,"HTML","");if(e!==""){this.setupContentHtml(e);this._hasLayout=true;this.raiseLayoutEvent()}};BX.Crm.EntityEditorUserField.prototype.onEmployeeSelectorOpen=function(t){var e=BX.getEventTarget(t);if(!e){return}};BX.Crm.EntityEditorUserField.create=function(t,e){var i=new BX.Crm.EntityEditorUserField;i.initialize(t,e);return i};if(typeof BX.Crm.EntityEditorUserField.messages==="undefined"){BX.Crm.EntityEditorUserField.messages={}}}
//# sourceMappingURL=user-field.map.js