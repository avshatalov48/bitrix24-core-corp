BX.namespace("BX.Crm");if(typeof BX.Crm.EntityEditorControl==="undefined"){BX.Crm.EntityEditorControl=BX.UI.EntityEditorControl}if(typeof BX.Crm.EntityEditorField==="undefined"){BX.Crm.EntityEditorField=function(){BX.Crm.EntityEditorField.superclass.constructor.apply(this);this.eventsNamespace="BX.Crm.EntityEditorField"};BX.extend(BX.Crm.EntityEditorField,BX.UI.EntityEditorField);if(typeof BX.Crm.EntityEditorField.messages==="undefined"){BX.Crm.EntityEditorField.messages={}}}if(typeof BX.Crm.EntityEditorSection==="undefined"){BX.Crm.EntityEditorSection=function(){BX.Crm.EntityEditorSection.superclass.constructor.apply(this);this.eventsNamespace="BX.Crm.EntityEditorSection"};BX.extend(BX.Crm.EntityEditorSection,BX.UI.EntityEditorSection);BX.Crm.EntityEditorSection.prototype.createFieldConfigurator=function(t){if(!BX.type.isPlainObject(t)){throw"EntityEditorSection: The 'params' argument must be object."}t.mandatoryConfigurator=null;var e=BX.prop.get(t,"field",null);var i=this._editor.getAttributeManager();if(i){this._mandatoryConfigurator=i.createFieldConfigurator(e,BX.UI.EntityFieldAttributeType.required);t.mandatoryConfigurator=this._mandatoryConfigurator}var n=e?e.getData():null;if(this.getEditor().canChangeCommonConfiguration()){this._visibilityConfigurator=BX.Crm.EntityFieldVisibilityConfigurator.create(this._id,{editor:e?e._editor:null,config:e?BX.prop.getObject(n,"visibilityConfigs",null):null,field:e?e:null,restriction:this._editor.getRestriction("userFieldAccessRights")});t.visibilityConfigurator=this._visibilityConfigurator}else{this._visibilityConfigurator=null}this._fieldConfigurator=this.getConfigurationFieldManager().createFieldConfigurator(t,this);this.addChild(this._fieldConfigurator,{related:e,scrollIntoView:true});if(this._fieldConfigurator instanceof BX.UI.EntityEditorUserFieldConfigurator){this._mandatoryConfigurator=t.mandatoryConfigurator;BX.addCustomEvent(this._fieldConfigurator,"onSave",BX.delegate(this.onUserFieldConfigurationSave,this));BX.addCustomEvent(this._fieldConfigurator,"onCancel",BX.delegate(this.onFieldConfigurationCancel,this))}else{BX.addCustomEvent(this._fieldConfigurator,"onSave",BX.delegate(this.onFieldConfigurationSave,this));BX.addCustomEvent(this._fieldConfigurator,"onCancel",BX.delegate(this.onFieldConfigurationCancel,this))}};BX.Crm.EntityEditorSection.create=function(t,e){var i=new BX.Crm.EntityEditorSection;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorText==="undefined"){BX.Crm.EntityEditorText=function(){BX.Crm.EntityEditorText.superclass.constructor.apply(this);this.eventsNamespace="BX.Crm.EntityEditorText"};BX.extend(BX.Crm.EntityEditorText,BX.UI.EntityEditorText);BX.Crm.EntityEditorText.prototype.getEditModeHtmlNodes=function(){var t=BX.Crm.EntityEditorText.superclass.getEditModeHtmlNodes.apply(this);if(this._editor.isDuplicateControlEnabled()){var e=this.getDuplicateControlConfig();if(e){if(!BX.type.isPlainObject(e["field"])){e["field"]={}}e["field"]["id"]=this.getId();e["field"]["element"]=this._input;this._editor.getDuplicateManager().registerField(e)}}return t};BX.Crm.EntityEditorText.prototype.doClearLayout=function(t){if(this._editor.isDuplicateControlEnabled()){var e=this.getDuplicateControlConfig();if(e){if(!BX.type.isPlainObject(e["field"])){e["field"]={}}e["field"]["id"]=this.getId();this._editor.getDuplicateManager().unregisterField(e)}}BX.Crm.EntityEditorText.superclass.doClearLayout.apply(this,[t])};BX.Crm.EntityEditorText.create=function(t,e){var i=new BX.Crm.EntityEditorText;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorNumber==="undefined"){BX.Crm.EntityEditorNumber=BX.UI.EntityEditorNumber}if(typeof BX.Crm.EntityEditorDatetime==="undefined"){BX.Crm.EntityEditorDatetime=BX.UI.EntityEditorDatetime}if(typeof BX.Crm.EntityEditorBoolean==="undefined"){BX.Crm.EntityEditorBoolean=BX.UI.EntityEditorBoolean}if(typeof BX.Crm.EntityEditorList==="undefined"){BX.Crm.EntityEditorList=BX.UI.EntityEditorList}if(typeof BX.Crm.EntityEditorHtml==="undefined"){BX.Crm.EntityEditorHtml=BX.UI.EntityEditorHtml}if(typeof BX.Crm.EntityEditorMoney==="undefined"){BX.Crm.EntityEditorMoney=function(){BX.Crm.EntityEditorMoney.superclass.constructor.apply(this);this._amountManualInput=null;this._amountClickHandler=BX.delegate(this.onAmountClick,this);this._changeAmountEditModeListener=null;this._hasRelatedProducts=false;this.classPrefix="crm-";this.wrapperClassName="crm-entity-widget-content-block-field-money crm-entity-widget-participants-block"};BX.extend(BX.Crm.EntityEditorMoney,BX.UI.EntityEditorMoney);BX.Crm.EntityEditorMoney.prototype.doInitialize=function(){this._changeAmountEditModeListener=BX.CrmNotifier.create(this)};BX.Crm.EntityEditorMoney.prototype.getAmountValue=function(t){if(this._mode===BX.UI.EntityEditorMode.edit&&this._amountValue){return this._amountValue.value}return this.getValue(t)};BX.Crm.EntityEditorMoney.prototype.getManualOpportunityValue=function(){if(this._mode===BX.UI.EntityEditorMode.edit&&this._amountManualInput){return this._amountManualInput.value}return this.getManualOpportunity()};BX.Crm.EntityEditorMoney.prototype.setHasRelatedProducts=function(t){this._hasRelatedProducts=!!t};BX.Crm.EntityEditorMoney.prototype.layout=function(t){if(this._hasLayout){return}this._amountManualInput=null;BX.Crm.EntityEditorMoney.superclass.layout.apply(this,[t]);var e=this.getManualOpportunity();var i=e!=null;if(i&&this._inputWrapper){this._amountManualInput=BX.create("input",{attrs:{name:"IS_MANUAL_OPPORTUNITY",type:"hidden",value:e}});BX.bind(this._inputWrapper,"click",this._amountClickHandler);this._inputWrapper.appendChild(this._amountManualInput)}if(this._mode===BX.UI.EntityEditorMode.view){if(this._innerWrapper&&BX.Type.isElementNode(this._innerWrapper.firstChild)){this._innerWrapper.firstChild.classList.add("crm-entity-widget-content-block-inner-text");this._innerWrapper.firstChild.classList.add("crm-entity-widget-content-block-inner-text-pay")}if(this._sumElement){this._sumElement.classList.add("crm-entity-widget-content-block-wallet")}}};BX.Crm.EntityEditorMoney.prototype.refreshLayout=function(t){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Crm.EntityEditorMoney.superclass.refreshLayout.apply(this,arguments);return}if(this._mode===BX.UI.EntityEditorMode.edit&&this._amountInput){if(this.getManualOpportunity()!=="Y"){var e=this._currencyEditor?this._currencyEditor.currency:this._model.getField(this.getCurrencyFieldName());if(!BX.type.isNotEmptyString(e)){e=BX.Currency.Editor.getBaseCurrencyId()}var i=this.getAmountFieldName();var n=this._model.getField(i);n=BX.Currency.Editor.trimTrailingZeros(n,e);this._amountValue.value=n;this._amountInput.value=BX.Currency.Editor.getFormattedValue(n,e)}this._amountInput.disabled=this._model.isFieldLocked(i);if(this._amountManualInput){this._amountManualInput.value=this.getManualOpportunity()}}else if(this._mode===BX.UI.EntityEditorMode.view&&this._sumElement){this._sumElement.innerHTML=this.renderMoney()}};BX.Crm.EntityEditorMoney.prototype.getManualOpportunity=function(){return this._model.getField("IS_MANUAL_OPPORTUNITY",null)};BX.Crm.EntityEditorMoney.prototype.isContextMenuEnabled=function(){if(BX.Crm.EntityEditorMoney.superclass.isContextMenuEnabled.apply(this,arguments)){return true}return this.isLimitedContextMenuEnabled()};BX.Crm.EntityEditorMoney.prototype.isLimitedContextMenuEnabled=function(){return this._editor.isFieldsContextMenuEnabled()&&!this._editor.canChangeScheme()&&!this.getEditor().isReadOnly()&&this.getManualOpportunity()==="Y"};BX.Crm.EntityEditorMoney.prototype.doPrepareContextMenuItems=function(t){if(this.getManualOpportunity()==="Y"){var e=this.isLimitedContextMenuEnabled();if(e){t.splice(0,t.length)}else{t.push({delimiter:true})}t.push({text:BX.Crm.EntityEditorMoney.messages.manualOpportunitySetAutomatic,onclick:BX.delegate((function(){if(this._mode!==BX.UI.EntityEditorMode.edit){this.switchToSingleEditMode()}this._changeAmountEditModeListener.notify([false]);this.closeContextMenu()}),this)})}return t};BX.Crm.EntityEditorMoney.prototype.onAmountValueChange=function(t){if(this._amountValue){var e=parseFloat(this._amountValue.value);e=BX.Type.isNumber(e)?e:0;var i=parseFloat(t);i=BX.Type.isNumber(i)?i:0;if(e===i){return}this._amountValue.value=t}var n=this.getManualOpportunity();var r=n!=null;if(r&&this._amountManualInput){var s=t.length?parseFloat(t):0;s=isNaN(s)?0:s;if(s>0&&this._amountManualInput.value==="N"){this._amountManualInput.value="Y"}if(s===0&&this._amountManualInput.value==="Y"&&!this._hasRelatedProducts){this._amountManualInput.value="N"}}};BX.Crm.EntityEditorMoney.prototype.addChangeAmountEditModeListener=function(t){this._changeAmountEditModeListener.addListener(t)};BX.Crm.EntityEditorMoney.prototype.onAmountClick=function(t){if(t.target===this._amountInput&&this._model.isFieldLocked(this.getAmountFieldName())){this._changeAmountEditModeListener.notify([true])}};BX.Crm.EntityEditorMoney.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getAmountFieldName()&&BX.prop.getString(t,"name","")!=="IS_MANUAL_OPPORTUNITY"){return}this.refreshLayout();if(BX.prop.getString(t,"name","")==="IS_MANUAL_OPPORTUNITY"){if(this._amountInput&&!this._amountInput.disabled){this._amountInput.focus()}}};BX.Crm.EntityEditorMoney.prototype.renderMoney=function(){var t=this._schemeElement.getData();var e=this._model.getField(BX.prop.getString(t,"formattedWithCurrency"),"");var i=this._model.getField(BX.prop.getString(t,"formatted"),"");var n=BX.Currency.Editor.trimTrailingZeros(i,this._selectedCurrencyValue);return e.replace(i,'<span class="crm-entity-widget-content-block-colums-right">'+n+"</span>")};BX.Crm.EntityEditorMoney.create=function(t,e){var i=new BX.Crm.EntityEditorMoney;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMoneyPay==="undefined"){BX.Crm.EntityEditorMoneyPay=function(){BX.Crm.EntityEditorMoneyPay.superclass.constructor.apply(this);this._payButton=null;this._isPayButtonVisible=null;this._paymentDocumentsControl=null};BX.Crm.EntityEditorMoneyPay.create=function(t,e){var i=new BX.Crm.EntityEditorMoneyPay;i.initialize(t,e);return i};BX.extend(BX.Crm.EntityEditorMoneyPay,BX.Crm.EntityEditorMoney);BX.Crm.EntityEditorMoneyPay.prototype.doInitialize=function(){BX.Crm.EntityEditorMoneyPay.superclass.doInitialize.apply(this);this._isPayButtonVisible=BX.prop.getBoolean(this._schemeElement._options,"isPayButtonVisible",true);this._isPayButtonControlVisible=this._model.getField("IS_PAY_BUTTON_CONTROL_VISIBLE","Y")==="Y";var t=BX.prop.getInteger(this.getModel()._settings,"entityTypeId",0);var e=this._model.getField("IS_COPY_MODE",false);var i=this._schemeElement.getDataBooleanParam("isShowPaymentDocuments",false);if(!e&&i){var n={IS_USED_INVENTORY_MANAGEMENT:this._model.getField("IS_USED_INVENTORY_MANAGEMENT",false),IS_INVENTORY_MANAGEMENT_RESTRICTED:this._model.getField("IS_INVENTORY_MANAGEMENT_RESTRICTED",false),OWNER_TYPE_ID:t,OWNER_ID:this._model.getField("ID")?parseInt(this._model.getField("ID")):0,CONTEXT:this.getModel().getOwnerInfo().ownerType.toLowerCase(),IS_DELIVERY_AVAILABLE:this._schemeElement.getDataBooleanParam("isDeliveryAvailable",false),PARENT_CONTEXT:this,PHRASES:this._schemeElement.getDataObjectParam("paymentDocumentsPhrases",{}),IS_WITH_ORDERS_MODE:this._schemeElement.getDataBooleanParam("isWithOrdersMode",false)};this._paymentDocumentsControl=new BX.Crm.EntityEditorPaymentDocuments(n)}};BX.Crm.EntityEditorMoneyPay.prototype.renderPayButton=function(){var t=BX.create("button",{props:{className:"crm-entity-widget-content-block-inner-pay-button ui-btn ui-btn-sm ui-btn-primary"},text:this.getMessage("payButtonLabel"),attrs:{type:"button"}});BX.bind(t,"click",BX.delegate((function(){var t=this.getLatestOrderId();this.startSalescenterApplication(t)}),this));BX.bind(t,"mousedown",(function(t){BX.PreventDefault(t)}));t.style.display=this._isPayButtonVisible?"":"none";return t};BX.Crm.EntityEditorMoneyPay.prototype.layout=function(t){BX.Crm.EntityEditorMoneyPay.superclass.layout.apply(this,arguments);if(this._mode===BX.UI.EntityEditorMode.view&&this.isNeedToDisplay()&&!this.getEditor().isEmbedded()){this._payButton=this.renderPayButton();if(BX.Type.isElementNode(this._innerWrapper.firstChild)){this._innerWrapper.firstChild.appendChild(this._payButton)}else{BX.Dom.clean(this._innerWrapper);this._innerWrapper.appendChild(this._payButton)}if(this._paymentDocumentsControl){this._wrapper.appendChild(this._paymentDocumentsControl.render());this._paymentDocumentsControl.reloadModel()}}};BX.Crm.EntityEditorMoneyPay.prototype.startSalescenterApplication=function(t,e){if(t===undefined){t=0}if(e===undefined){var i=BX.prop.getInteger(this.getModel()._settings,"entityTypeId",0);var n=this.getModel().getOwnerInfo();e={disableSendButton:this._schemeElement.getDataStringParam("disableSendButton",""),context:"deal",templateMode:"create",mode:i===BX.CrmEntityType.enumeration.deal?"payment_delivery":"payment",analyticsLabel:"salescenterClickButtonPay",ownerTypeId:i,ownerId:n.ownerID,orderId:t}}BX.loadExt("salescenter.manager").then(function(){BX.Salescenter.Manager.openApplication(e).then(function(t){if(t){if(t.get("deal")||t.get("order")||t.get("entity")){this._editor.reload()}var e=this.getModel().getEntityTypeId(),i=null;if(t.get("entity")){i=t.get("entity")}else if(e===BX.CrmEntityType.enumeration.deal){i=t.get("deal")}if(i&&i.PRODUCT_LIST){this._editor.tapController("PRODUCT_ROW_PROXY",(function(t){if(t._externalEditor){t._externalEditor.reinitialize(i.PRODUCT_LIST)}}));this._editor.tapController("PRODUCT_LIST",(function(t){t.reinitializeProductList()}))}var n=t.get("order");if(n&&n.id&&BX.CrmActivityDelivery){var r=BX.CrmActivityDelivery.getInstance();r.rememberCurrentOrder(n.id)}}}.bind(this))}.bind(this))};BX.Crm.EntityEditorMoneyPay.prototype.doPrepareContextMenuItems=function(t){var e=this;BX.Crm.EntityEditorMoneyPay.superclass.doPrepareContextMenuItems.apply(this,arguments);if(!e._isPayButtonControlVisible){return}t.unshift({text:e._isPayButtonVisible?this.getMessage("hidePayButton"):this.getMessage("showPayButton"),onclick:function(){e._isPayButtonVisible=!e._isPayButtonVisible;e._schemeElement._options.isPayButtonVisible=e._isPayButtonVisible;e._payButton.style.display=e._isPayButtonVisible?"":"none";e.markSchemeAsChanged();e.saveScheme();e.closeContextMenu()}})};BX.Crm.EntityEditorMoneyPay.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorMoneyPay.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorMoneyPay.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorMoneyPay.prototype.getLatestOrderId=function(){var t=this._model.getField("ORDER_LIST",[]);var e=0;if(t.length&&t.length>0){t.map((function(t){e=Math.max(e,parseInt(t.ORDER_ID))}))}return e}}if(typeof BX.Crm.EntityEditorImage==="undefined"){BX.Crm.EntityEditorImage=function(){BX.Crm.EntityEditorImage.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorImage,BX.UI.EntityEditorImage);BX.Crm.EntityEditorImage.prototype.loadInput=function(){this._editor.loadCustomHtml("RENDER_IMAGE_INPUT",{FIELD_NAME:this.getDataKey()},BX.delegate(this.onEditorHtmlLoad,this))};BX.Crm.EntityEditorImage.prototype.onEditorHtmlLoad=function(t){if(this._mode===BX.UI.EntityEditorMode.edit&&this._innerWrapper){this._innerWrapper.innerHTML=t;BX.addCustomEvent(window,"onAfterPopupShow",this._dialogShowHandler);BX.addCustomEvent(window,"onPopupClose",this._dialogCloseHandler);window.setTimeout(BX.delegate(this.bindFileEvents,this),500)}};BX.Crm.EntityEditorImage.create=function(t,e){var i=new BX.Crm.EntityEditorImage;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUser==="undefined"){BX.Crm.EntityEditorUser=function(){BX.Crm.EntityEditorUser.superclass.constructor.apply(this);this._input=null;this._editButton=null;this._photoElement=null;this._nameElement=null;this._positionElement=null;this._userSelector=null;this._selectedData={};this._editButtonClickHandler=BX.delegate(this.onEditBtnClick,this)};BX.extend(BX.Crm.EntityEditorUser,BX.UI.EntityEditorField);BX.Crm.EntityEditorUser.prototype.isSingleEditEnabled=function(){return true};BX.Crm.EntityEditorUser.prototype.getRelatedDataKeys=function(){return[this.getDataKey(),this._schemeElement.getDataStringParam("formated",""),this._schemeElement.getDataStringParam("position",""),this._schemeElement.getDataStringParam("showUrl",""),this._schemeElement.getDataStringParam("photoUrl","")]};BX.Crm.EntityEditorUser.prototype.hasContentToDisplay=function(){return true};BX.Crm.EntityEditorUser.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this._schemeElement.getName();var i=this._schemeElement.getTitle();var n=this._model.getField(e);var r=this._model.getSchemeField(this._schemeElement,"formated","");var s=this._model.getSchemeField(this._schemeElement,"position","");var o=this._model.getSchemeField(this._schemeElement,"showUrl","","");var a=this._model.getSchemeField(this._schemeElement,"photoUrl","");this._photoElement=BX.create("a",{props:{className:"crm-widget-employee-avatar-container",target:"_blank"},style:{backgroundImage:BX.type.isNotEmptyString(a)?"url('"+a+"')":"",backgroundSize:BX.type.isNotEmptyString(a)?"30px":""}});this._nameElement=BX.create("a",{props:{className:"crm-widget-employee-name",target:"_blank"},text:r});if(o!==""){this._photoElement.href=o;this._nameElement.href=o}this._positionElement=BX.create("SPAN",{props:{className:"crm-widget-employee-position"},text:s});if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));var l=BX.create("div",{props:{className:"crm-widget-employee-container"}});this._editButton=null;this._input=null;if(this._mode===BX.UI.EntityEditorMode.edit||this.isEditInViewEnabled()&&!this.isReadOnly()){this._input=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._wrapper.appendChild(this._input);this._editButton=BX.create("span",{props:{className:"crm-widget-employee-change"},text:this.getMessage("change")});BX.bind(this._editButton,"click",this._editButtonClickHandler);l.appendChild(this._editButton)}l.appendChild(this._photoElement);l.appendChild(BX.create("span",{props:{className:"crm-widget-employee-info"},children:[this._nameElement,this._positionElement]}));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[l]}));if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorUser.prototype.doRegisterLayout=function(){if(this.isInEditMode()&&this.checkModeOption(BX.UI.EntityEditorModeOptions.individual)){window.setTimeout(BX.delegate(this.openSelector,this),0)}};BX.Crm.EntityEditorUser.prototype.doClearLayout=function(t){this._input=null;this._editButton=null;this._photoElement=null;this._nameElement=null;this._positionElement=null};BX.Crm.EntityEditorUser.prototype.onEditBtnClick=function(t){if(this._mode===BX.UI.EntityEditorMode.view&&this.isEditInViewEnabled()&&this.getEditor().isChanged()){this.switchToSingleEditMode()}else{this.openSelector()}};BX.Crm.EntityEditorUser.prototype.openSelector=function(){if(!this._userSelector){this._userSelector=BX.UI.EntityEditorUserSelector.create(this._id,{callback:BX.delegate(this.processItemSelect,this)})}this._userSelector.open(this._editButton)};BX.Crm.EntityEditorUser.prototype.processItemSelect=function(t,e){var i=this._mode===BX.UI.EntityEditorMode.view;var n=this.isEditInViewEnabled();if(i&&!n){return}this._selectedData={id:BX.prop.getInteger(e,"entityId",0),photoUrl:BX.prop.getString(e,"avatar",""),formattedNameHtml:BX.prop.getString(e,"name",""),positionHtml:BX.prop.getString(e,"desc","")};this._input.value=this._selectedData["id"];this._photoElement.style.backgroundImage=this._selectedData["photoUrl"]!==""?"url('"+this._selectedData["photoUrl"]+"')":"";this._photoElement.style.backgroundSize=this._selectedData["photoUrl"]!==""?"30px":"";this._nameElement.innerHTML=this._selectedData["formattedNameHtml"];this._positionElement.innerHTML=this._selectedData["positionHtml"];this._userSelector.close();if(!i){this.markAsChanged()}else{this._editor.saveControl(this)}};BX.Crm.EntityEditorUser.prototype.save=function(){var t=this._schemeElement.getData();if(this._selectedData["id"]>0){var e=this._selectedData["id"];this._model.setField(BX.prop.getString(t,"formated"),BX.util.htmlspecialcharsback(this._selectedData["formattedNameHtml"]));this._model.setField(BX.prop.getString(t,"position"),this._selectedData["positionHtml"]!=="&nbsp;"?BX.util.htmlspecialcharsback(this._selectedData["positionHtml"]):"");this._model.setField(BX.prop.getString(t,"showUrl"),BX.prop.getString(t,"pathToProfile").replace(/#user_id#/gi,e));this._model.setField(BX.prop.getString(t,"photoUrl"),this._selectedData["photoUrl"]);this._model.setField(this.getName(),e)}};BX.Crm.EntityEditorUser.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorUser.prototype.getRuntimeValue=function(){if(this._mode===BX.UI.EntityEditorMode.edit&&this._selectedData["id"]>0){return this._selectedData["id"]}return""};BX.Crm.EntityEditorUser.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorUser.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorUser.superclass.getMessage.apply(this,arguments)};if(typeof BX.Crm.EntityEditorUser.messages==="undefined"){BX.Crm.EntityEditorUser.messages={}}BX.Crm.EntityEditorUser.create=function(t,e){var i=new BX.Crm.EntityEditorUser;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorAddress==="undefined"){BX.Crm.EntityEditorAddress=function(){BX.Crm.EntityEditorAddress.superclass.constructor.apply(this);this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorAddress,BX.Crm.EntityEditorField);BX.Crm.EntityEditorAddress.prototype.getModeSwitchType=function(t){var e=BX.UI.EntityEditorModeSwitchType.common;if(t===BX.UI.EntityEditorMode.edit){e|=BX.UI.EntityEditorModeSwitchType.button|BX.UI.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorAddress.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorAddress.prototype.hasContentToDisplay=function(){return this._mode===BX.UI.EntityEditorMode.edit||this.getViewHtml()!==""};BX.Crm.EntityEditorAddress.prototype.getViewHtml=function(){var t=this._schemeElement.getDataStringParam("view","");if(t===""){t=this._schemeElement.getName()+"_HML"}return this._model.getStringField(t,"")};BX.Crm.EntityEditorAddress.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this._schemeElement.getName();var i=this.getTitle();var n=this._schemeElement.getDataObjectParam("fields",{});var r=this._schemeElement.getDataObjectParam("labels",{});this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));if(this._mode===BX.UI.EntityEditorMode.edit){var s=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner-address"}});this._innerWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[s]})]});for(var o in n){if(!n.hasOwnProperty(o)){return}var a=n[o];var l=BX.prop.getString(r,o,o);this.layoutField(o,a,l,s)}BX.bindDelegate(s,"bxchange",{tag:["input","textarea"]},this._changeHandler)}else{if(this.hasContentToDisplay()){this._innerWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner-text"},html:this.getViewHtml()})]})}else{this._innerWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorAddress.prototype.layoutField=function(t,e,i,n){var r=BX.prop.getString(e,"NAME",t);var s=this._model.getStringField(r,"");n.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:i})]}));if(BX.prop.getBoolean(e,"IS_MULTILINE",false)){n.appendChild(BX.create("textarea",{props:{className:"crm-entity-widget-content-input",name:r,value:s}}))}else{n.appendChild(BX.create("input",{props:{className:"crm-entity-widget-content-input",name:r,type:"text",value:s}}))}};BX.Crm.EntityEditorAddress.prototype.doClearLayout=function(t){this._innerWrapper=null};BX.Crm.EntityEditorAddress.create=function(t,e){var i=new BX.Crm.EntityEditorAddress;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultifieldItem==="undefined"){BX.Crm.EntityEditorMultifieldItem=function(){this._id="";this._settings={};this._parent=null;this._editor=null;this._mode=BX.UI.EntityEditorMode.view;this._data=null;this._typeId="";this._valueTypeItems=null;this._container=null;this._wrapper=null;this._valueInput=null;this._valueTypeInput=null;this._valueTypeSelector=null;this._deleteButton=null;this._deleteButtonHandler=BX.delegate(this.onDeleteButtonClick,this);this._isJunked=false;this._hasLayout=false};BX.Crm.EntityEditorMultifieldItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._parent=BX.prop.get(this._settings,"parent",null);this._editor=this._parent.getEditor();this._mode=BX.prop.getInteger(this._settings,"mode",BX.UI.EntityEditorMode.view);this._typeId=BX.prop.getString(this._settings,"typeId","");this._data=BX.prop.getObject(this._settings,"data",{});this._valueTypeItems=BX.prop.getArray(this._settings,"valueTypeItems",[]);this._container=BX.prop.getElementNode(this._settings,"container",null)},getId:function(){return this._id},isEmpty:function(){return BX.util.trim(this.getValue())===""},getTypeId:function(){return this._typeId},getValue:function(){return BX.prop.getString(this._data,"VALUE","")},getValueId:function(){return BX.prop.getString(this._data,"ID","")},getValueTypeId:function(){var t=BX.prop.getString(this._data,"VALUE_TYPE","");return t!==""?t:this.getDefaultValueTypeId()},getDefaultValueTypeId:function(){return this._valueTypeItems.length>0?BX.prop.getString(this._valueTypeItems[0],"VALUE"):""},getViewData:function(){return BX.prop.getObject(this._data,"VIEW_DATA",{})},resolveValueTypeName:function(t){if(t===""){return""}for(var e=0,i=this._valueTypeItems.length;e<i;e++){var n=this._valueTypeItems[e];if(t===BX.prop.getString(n,"VALUE","")){return BX.prop.getString(n,"NAME",t)}}return t},prepareControlName:function(t){return this.getTypeId()+"["+this.getValueId()+"]"+"["+t+"]"},getMode:function(){return this._mode},setMode:function(t){this._mode=t},getContainer:function(){return this._container},setContainer:function(t){this._container=t;if(this._hasLayout){this.clearLayout()}},focus:function(){if(this._valueInput){BX.focus(this._valueInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._valueInput)}},layout:function(){if(this._hasLayout){return}this._valueInput=null;this._valueTypeInput=null;this._valueTypeSelector=null;this._deleteButton=null;var t=this.getValueTypeId();var e=this.getValue();this._wrapper=BX.create("div");this._container.appendChild(this._wrapper);if(this._mode===BX.UI.EntityEditorMode.edit){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-container crm-entity-widget-content-block-field-container-double");this._valueInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",name:this.prepareControlName("VALUE"),type:"text",value:e}});BX.bind(this._valueInput,"input",BX.delegate(this.onValueChange,this));this._wrapper.appendChild(this._valueInput);this._valueTypeInput=BX.create("input",{attrs:{name:this.prepareControlName("VALUE_TYPE"),type:"hidden",value:t}});this._wrapper.appendChild(this._valueTypeInput);this._valueTypeSelector=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:this.resolveValueTypeName(t),events:{click:BX.delegate(this.onValueTypeSelectorClick,this)}});this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-select"},children:[this._valueTypeSelector]}));this._deleteButton=BX.create("div",{attrs:{className:"crm-entity-widget-content-remove-block"}});this._wrapper.appendChild(this._deleteButton);BX.bind(this._deleteButton,"click",this._deleteButtonHandler);if(this._editor.isDuplicateControlEnabled()){var i=this._parent.getDuplicateControlConfig();if(i){if(!BX.type.isPlainObject(i["field"])){i["field"]={}}i["field"]["id"]=this.getValueId();i["field"]["element"]=this._valueInput;this._editor.getDuplicateManager().registerField(i)}}}else if(this._mode===BX.UI.EntityEditorMode.view&&!this.isEmpty()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-mutlifield");var n=this.getViewData();var r=BX.prop.getString(n,"value","");if(r===""){r=BX.util.htmlspecialchars(e)}this._wrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-type"},text:this.resolveValueTypeName(t)}));var s=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-value"},html:r});this._wrapper.appendChild(s);if(this._parent.getMultifieldType()==="EMAIL"){var o=s.querySelector("a.crm-entity-email");if(o){BX.bind(o,"click",BX.delegate(this.onEmailClick,this))}}}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}if(this._editor.isDuplicateControlEnabled()){var t=this._parent.getDuplicateControlConfig();if(t){if(!BX.type.isPlainObject(t["field"])){t["field"]={}}t["field"]["id"]=this.getValueId();this._editor.getDuplicateManager().unregisterField(t)}}this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},adjust:function(){if(this._hasLayout){this._wrapper.style.display=this._isJunked?"none":""}},onValueChange:function(t){this._parent.processItemChange(this)},onValueTypeSelectorClick:function(t){var e=[];for(var i=0,n=this._valueTypeItems.length;i<n;i++){var r=this._valueTypeItems[i];e.push({text:r["NAME"],value:r["VALUE"],onclick:BX.delegate(this.onValueTypeSelect,this)})}BX.addClass(this._valueTypeSelector,"active");BX.PopupMenu.destroy(this._id);BX.PopupMenu.show(this._id,this._valueTypeSelector,e,{angle:false,width:this._valueTypeSelector.offsetWidth+"px",events:{onPopupClose:BX.delegate(this.onValueTypeMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._valueTypeSelector)["width"])},onValueTypeMenuClose:function(t){BX.removeClass(this._valueTypeSelector,"active")},onValueTypeSelect:function(t,e){BX.removeClass(this._valueTypeSelector,"active");this._valueTypeInput.value=e.value;this._valueTypeSelector.innerHTML=BX.util.htmlspecialchars(e.text);this._parent.processItemChange(this);BX.PopupMenu.destroy(this._id)},isJunked:function(){return this._isJunked},markAsJunked:function(t){t=!!t;if(this._isJunked!==t){this._isJunked=t;if(this._isJunked){this._valueInput.value=""}this.adjust()}},onEmailClick:function(t){if(BX.CrmActivityEditor){var e=this._editor.getOwnerInfo();var i={ownerType:e["ownerType"],ownerID:e["ownerID"],communications:[{entityType:e["ownerType"],entityId:e["ownerID"],type:"EMAIL",value:this.getValue()}]};BX.CrmActivityEditor.addEmail(i)}return BX.PreventDefault(t)},onDeleteButtonClick:function(t){this._parent.processItemDeletion(this)}};BX.Crm.EntityEditorMultifieldItem.create=function(t,e){var i=new BX.Crm.EntityEditorMultifieldItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultifieldItemPhone==="undefined"){BX.Crm.EntityEditorMultifieldItemPhone=function(){BX.Crm.EntityEditorMultifieldItemPhone.superclass.constructor.apply(this);this._maskedPhone=null;this._maskedValueInput=null;this._countryFlagNode=null};BX.extend(BX.Crm.EntityEditorMultifieldItemPhone,BX.Crm.EntityEditorMultifieldItem);BX.Crm.EntityEditorMultifieldItemPhone.prototype.layout=function(){var t=this;if(this._hasLayout){return}this._valueInput=null;this._valueTypeInput=null;this._valueTypeSelector=null;var e=this.getValueTypeId();var i=this.getValue();this._wrapper=BX.create("div");this._container.appendChild(this._wrapper);if(this._mode===BX.UI.EntityEditorMode.edit){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-container crm-entity-widget-content-block-field-container-double");this._valueInput=BX.create("input",{attrs:{name:this.prepareControlName("VALUE"),type:"hidden",value:i}});this._wrapper.appendChild(this._valueInput);this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-input-phone-wrapper"},children:[this._countryFlagNode=BX.create("span",{props:{className:"crm-entity-widget-content-country-flag"}}),this._maskedValueInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input crm-entity-widget-content-input-phone",type:"text",value:i}})]}));this._maskedPhone=new BX.PhoneNumber.Input({node:this._maskedValueInput,flagNode:this._countryFlagNode,flagSize:24,onChange:function(e){t._valueInput.value=e.value;t.onValueChange()}});this._valueTypeInput=BX.create("input",{attrs:{name:this.prepareControlName("VALUE_TYPE"),type:"hidden",value:e}});this._wrapper.appendChild(this._valueTypeInput);this._valueTypeSelector=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:this.resolveValueTypeName(e),events:{click:BX.delegate(this.onValueTypeSelectorClick,this)}});this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-select"},children:[this._valueTypeSelector]}));this._deleteButton=BX.create("div",{attrs:{className:"crm-entity-widget-content-remove-block"}});this._wrapper.appendChild(this._deleteButton);BX.bind(this._deleteButton,"click",this._deleteButtonHandler);if(this._editor.isDuplicateControlEnabled()){var n=this._parent.getDuplicateControlConfig();if(n){if(!BX.type.isPlainObject(n["field"])){n["field"]={}}n["field"]["id"]=this.getValueId();n["field"]["element"]=this._maskedValueInput;this._editor.getDuplicateManager().registerField(n)}}}else if(this._mode===BX.UI.EntityEditorMode.view&&!this.isEmpty()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-mutlifield");var r=this.getViewData();var s=BX.prop.getString(r,"value","");if(s===""){s=BX.util.htmlspecialchars(i)}this._wrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-type"},text:this.resolveValueTypeName(e)}));this._wrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-value"},html:s}))}this._hasLayout=true};BX.Crm.EntityEditorMultifieldItemPhone.prototype.focus=function(){if(this._maskedValueInput){BX.focus(this._maskedValueInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._maskedValueInput)}};BX.Crm.EntityEditorMultifieldItemPhone.create=function(t,e){var i=new BX.Crm.EntityEditorMultifieldItemPhone;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultifield==="undefined"){BX.Crm.EntityEditorMultifield=function(){BX.Crm.EntityEditorMultifield.superclass.constructor.apply(this);this._items=null;this._itemWrapper=null};BX.extend(BX.Crm.EntityEditorMultifield,BX.Crm.EntityEditorField);BX.Crm.EntityEditorMultifield.prototype.doInitialize=function(){this.initializeItems()};BX.Crm.EntityEditorMultifield.prototype.initializeItems=function(){var t=this.getName();var e=this._model.getField(t,[]);if(e.length===0){e.push({ID:"n0"})}for(var i=0,n=e.length;i<n;i++){this.addItem(e[i])}};BX.Crm.EntityEditorMultifield.prototype.findItemIndex=function(t){if(!this._items){return-1}for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1};BX.Crm.EntityEditorMultifield.prototype.resetItems=function(){if(this._hasLayout){for(var t=0,e=this._items.length;t<e;t++){this._items[t].clearLayout()}}this._items=[]};BX.Crm.EntityEditorMultifield.prototype.deleteItem=function(t){if(!this._items){return}var e=this.findItemIndex(t);if(e>=0){this._items[e].markAsJunked(true)}};BX.Crm.EntityEditorMultifield.prototype.reset=function(){this.resetItems();this.initializeItems()};BX.Crm.EntityEditorMultifield.prototype.hasContentToDisplay=function(){if(this._mode===BX.UI.EntityEditorMode.edit){return true}var t=this._items.length;if(t===0){return false}for(var e=0;e<t;e++){if(!this._items[e].isEmpty()){return true}}return false};BX.Crm.EntityEditorMultifield.prototype.getModeSwitchType=function(t){var e=BX.UI.EntityEditorModeSwitchType.common;if(t===BX.UI.EntityEditorMode.edit){e|=BX.UI.EntityEditorModeSwitchType.button|BX.UI.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorMultifield.prototype.getContentWrapper=function(){return this._itemWrapper};BX.Crm.EntityEditorMultifield.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorMultifield.prototype.prepareItemsLayout=function(){for(var t=0,e=this._items.length;t<e;t++){var i=this._items[t];i.setMode(this._mode);i.setContainer(this._itemWrapper);i.layout()}};BX.Crm.EntityEditorMultifield.prototype.getModeSwitchType=function(t){var e=BX.UI.EntityEditorModeSwitchType.common;if(t===BX.UI.EntityEditorMode.edit){e|=BX.UI.EntityEditorModeSwitchType.button|BX.UI.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorMultifield.prototype.getContentWrapper=function(){return this._itemWrapper};BX.Crm.EntityEditorMultifield.prototype.focus=function(){if(this._items&&this._items.length>0){this._items[this._items.length-1].focus()}};BX.Crm.EntityEditorMultifield.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-multifield"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}this._itemWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._itemWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._itemWrapper);if(this.hasContentToDisplay()){this.prepareItemsLayout()}else if(this._mode===BX.UI.EntityEditorMode.view){this._itemWrapper.appendChild(document.createTextNode(this.getMessage("isEmpty")))}if(this._mode===BX.UI.EntityEditorMode.edit){this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-add-field"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-add-field"},text:this.getMessage("add"),events:{click:BX.delegate(this.onAddButtonClick,this)}})]}))}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorMultifield.prototype.doClearLayout=function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];n.clearLayout();n.setContainer(null)}this._itemWrapper=null};BX.Crm.EntityEditorMultifield.prototype.refreshLayout=function(t){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Crm.EntityEditorMultifield.superclass.refreshLayout.apply(this,arguments);return}this.resetItems();BX.cleanNode(this._itemWrapper);this.initializeItems();if(this.hasContentToDisplay()){this.prepareItemsLayout()}else if(this._mode===BX.UI.EntityEditorMode.view){this._itemWrapper.appendChild(document.createTextNode(this.getMessage("isEmpty")))}};BX.Crm.EntityEditorMultifield.prototype.getMultifieldType=function(){return this._schemeElement.getDataStringParam("type","")};BX.Crm.EntityEditorMultifield.prototype.addItem=function(t){var e;var i=this._schemeElement.getName();if(i==="PHONE"){e=BX.Crm.EntityEditorMultifieldItemPhone.create("",{parent:this,typeId:this._schemeElement.getName(),valueTypeItems:this._schemeElement.getDataArrayParam("items",[]),data:t})}else{e=BX.Crm.EntityEditorMultifieldItem.create("",{parent:this,typeId:this._schemeElement.getName(),valueTypeItems:this._schemeElement.getDataArrayParam("items",[]),data:t})}if(this._items===null){this._items=[]}this._items.push(e);if(this._hasLayout){e.setMode(this._mode);e.setContainer(this._itemWrapper);e.layout()}return e};BX.Crm.EntityEditorMultifield.prototype.onAddButtonClick=function(t){this.addItem({ID:"n"+this._items.length.toString()})};BX.Crm.EntityEditorMultifield.prototype.processItemChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorMultifield.prototype.processItemDeletion=function(t){this.deleteItem(t);this.markAsChanged()};BX.Crm.EntityEditorMultifield.create=function(t,e){var i=new BX.Crm.EntityEditorMultifield;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorProductRowSummary==="undefined"){BX.Crm.EntityEditorProductRowSummary=function(){BX.Crm.EntityEditorProductRowSummary.superclass.constructor.apply(this);this._loader=null;this._productsContainer=null;this._previousData=[];this._itemCount=0;this._totalCount=0;this._showAllProducts=false;this._moreButton=null;this._moreButtonRow=null;this._TotalsRow=null;this._moreButtonClickHandler=BX.delegate(this._onMoreButtonClick,this);this._visibleItemsLimit=5;this._showInTabItemsLimit=10};BX.extend(BX.Crm.EntityEditorProductRowSummary,BX.Crm.EntityEditorField);BX.Crm.EntityEditorProductRowSummary.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorProductRowSummary.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorProductRowSummary.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorProductRowSummary.prototype.clearLayout=function(t){if(this.checkIfNeedClearLayout(t)){return BX.Crm.EntityEditorProductRowSummary.superclass.clearLayout.apply(this,arguments)}this._hasLayout=false};BX.Crm.EntityEditorProductRowSummary.prototype.layout=function(t){if(this._hasLayout){return}var e=this.checkIfNeedClearLayout(t);if(e){this.ensureWrapperCreated({});this.adjustWrapper()}var i=this.getValue();if(!BX.type.isPlainObject(i)){return}var n=this.getTitle();var r=BX.prop.getArray(i,"items",[]);this._totalCount=BX.prop.getInteger(i,"count",0);this._itemCount=r.length;var s=this._itemCount;var o=this._showAllProducts?this._showInTabItemsLimit-1:this._visibleItemsLimit;var a=0;if(s>o){a=this._totalCount-o;s=o}if(e){if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(n));this._productsContainer=BX.create("div",{props:{className:"crm-entity-widget-content-block-products-list"}})}else{BX.cleanNode(this._productsContainer)}var l=BX.prop.getBoolean(t,"isRefreshViewModeLayout",false);if(!e&&l){r=this.addAnimationInfo(r,s,o);s=r.length}for(var d=0;d<s;d++){this.addProductRow(r[d])}this._moreButton=null;if(a>0){this.addMoreButton(a)}this.addTotalRow(i["total"]);if(e){this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-products"},children:[this._productsContainer]}));if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}}this.registerLayout(t);this._hasLayout=true;this._previousData=i};BX.Crm.EntityEditorProductRowSummary.prototype.checkIfNeedClearLayout=function(t){return!BX.prop.getBoolean(t,"preservePosition",false)||!BX.prop.getBoolean(t,"isRefreshViewModeLayout",false)};BX.Crm.EntityEditorProductRowSummary.prototype.addAnimationInfo=function(t,e,i){var n=[];var r=BX.prop.getArray(this._previousData,"items",[]);var s=this.extractSameProducts(r,t);for(var o=0;o<e;o++){if(r.length>o&&!this.isProductInList(r[o],s)){r[o].animation="out";n.push(r[o])}if(!this.isProductInList(t[o],s)){t[o].animation="in"}n.push(t[o])}for(o=e;o<r.length;o++){if(o>i){break}if(!this.isProductInList(r[o],s)){r[o].animation="out";n.push(r[o])}}return n};BX.Crm.EntityEditorProductRowSummary.prototype.extractSameProducts=function(t,e){var i=[];for(var n=0;n<t.length;n++){for(var r=0;r<e.length;r++){if(this.areProductsEqual(t[n],e[r])){i.push(t[n])}}}return i};BX.Crm.EntityEditorProductRowSummary.prototype.isProductInList=function(t,e){for(var i=0;i<e.length;i++){if(this.areProductsEqual(t,e[i])){return true}}return false};BX.Crm.EntityEditorProductRowSummary.prototype.areProductsEqual=function(t,e){return t["PRODUCT_NAME"]===e["PRODUCT_NAME"]};BX.Crm.EntityEditorProductRowSummary.prototype.addMoreButton=function(t){var e=BX.create("div",{props:{className:"crm-entity-widget-content-block-products-item"}});this._moreButtonRow=e;this._productsContainer.appendChild(e);var i=BX.create("div",{props:{className:"crm-entity-widget-content-block-products-item-name"}});e.appendChild(i);this._moreButton=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-products-show-more"},events:{click:this._moreButtonClickHandler},text:this.getMessage("notShown").replace(/#COUNT#/gi,t.toString())});i.appendChild(this._moreButton);e.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-products-price"}}))};BX.Crm.EntityEditorProductRowSummary.prototype.addTotalRow=function(t){var e=BX.create("div",{props:{className:"crm-entity-widget-content-block-products-item"}});this._TotalsRow=e;this._productsContainer.appendChild(e);var i=BX.create("div",{props:{className:"crm-entity-widget-content-block-products-item-name"},html:this.getMessage("total")});e.appendChild(i);var n=BX.create("div",{props:{className:"crm-entity-widget-content-block-products-price"},html:t});e.appendChild(n)};BX.Crm.EntityEditorProductRowSummary.prototype._onMoreButtonClick=function(t){if(this._totalCount>=this._showInTabItemsLimit){BX.onCustomEvent(window,"OpenEntityDetailTab",["tab_products"]);return}BX.remove(this._moreButtonRow);BX.remove(this._TotalsRow);this._showAllProducts=true;var e=this.getValue();var i=BX.prop.getArray(e,"items",[]);for(var n=this._visibleItemsLimit;n<this._itemCount;n++){var r=BX.clone(i[n]);r.animation="in";this.addProductRow(r)}this.addTotalRow(e["total"])};BX.Crm.EntityEditorProductRowSummary.prototype.doClearLayout=function(){this._productsContainer=null;this._moreButton=null;this._moreButtonRow=null;this._TotalsRow=null};BX.Crm.EntityEditorProductRowSummary.prototype.addProductRow=function(t){var e=BX.create("div",{props:{className:"crm-entity-widget-content-block-products-item"}});var i=BX.prop.getString(t,"animation",null);switch(i){case"in":e.className+=" crm-entity-widget-content-block-products-in";setTimeout((function(){if(BX.Type.isDomNode(e)){BX.Dom.removeClass(e,"crm-entity-widget-content-block-products-in")}}),1e3);break;case"out":e.className+=" crm-entity-widget-content-block-products-out";setTimeout((function(){if(BX.Type.isDomNode(e)){BX.Dom.remove(e)}}),1e3);break}this._productsContainer.appendChild(e);var n=BX.create("div",{props:{className:"crm-entity-widget-content-block-products-item-name"}});var r=BX.prop.getString(t,"URL","");if(r!==""){n.appendChild(BX.create("a",{attrs:{target:"_blank",href:r},text:t["PRODUCT_NAME"]}))}else{n.innerHTML=BX.util.htmlspecialchars(t["PRODUCT_NAME"])}e.appendChild(n);var s=BX.create("div",{props:{className:"crm-entity-widget-content-block-products-price"}});e.appendChild(s);s.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-products-price-value"},html:t["SUM"]}))};if(typeof BX.Crm.EntityEditorProductRowSummary.messages==="undefined"){BX.Crm.EntityEditorProductRowSummary.messages={}}BX.Crm.EntityEditorProductRowSummary.create=function(t,e){var i=new BX.Crm.EntityEditorProductRowSummary;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorFileStorage==="undefined"){BX.Crm.EntityEditorFileStorage=function(){BX.Crm.EntityEditorFileStorage.superclass.constructor.apply(this);this._uploaderName="entity_editor_storage_"+this._id.toLowerCase();this._dataContainer=null;this._uploaderContainer=null;this._uploader=null};BX.extend(BX.Crm.EntityEditorFileStorage,BX.Crm.EntityEditorField);BX.Crm.EntityEditorFileStorage.prototype.getStorageTypeId=function(){return this._model.getIntegerField("STORAGE_TYPE_ID",BX.UI.EditorFileStorageType.undefined)};BX.Crm.EntityEditorFileStorage.prototype.getStorageElementInfos=function(){var t=this.getStorageTypeId();if(t===BX.UI.EditorFileStorageType.diskfile){return this._model.getArrayField(this._schemeElement.getDataStringParam("diskFileInfo","DISK_FILES"),[])}return[]};BX.Crm.EntityEditorFileStorage.prototype.hasContentToDisplay=function(){return this.getStorageElementInfos().length>0};BX.Crm.EntityEditorFileStorage.prototype.getModeSwitchType=function(){return BX.UI.EntityEditorModeSwitchType.content};BX.Crm.EntityEditorFileStorage.prototype.getContentWrapper=function(){return this._uploaderContainer};BX.Crm.EntityEditorFileStorage.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-filestorage"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));if(this._mode===BX.UI.EntityEditorMode.edit){this._dataContainer=BX.create("DIV",{});this._wrapper.appendChild(this._dataContainer)}this._uploaderContainer=BX.create("DIV",{attrs:{className:"bx-crm-dialog-activity-webdav-container"}});this._wrapper.appendChild(this._uploaderContainer);this.registerLayout(t);var e=this.getStorageTypeId();if(e===BX.UI.EditorFileStorageType.diskfile){var i=this.getDiskUploader();i.cleanLayout();i.setMode(this._mode);i.clearValues();i.setValues(this.getStorageElementInfos());i.layout(this._uploaderContainer)}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.subscribeOnUploaderChange();this._hasLayout=true};BX.Crm.EntityEditorFileStorage.prototype.doClearLayout=function(t){this._dataContainer=this._uploaderContainer=null;this.unSubscribeOnUploaderChange()};BX.Crm.EntityEditorFileStorage.prototype.getDiskUploader=function(){if(this._uploader){return this._uploader}if(typeof BX.CrmDiskUploader!=="undefined"&&typeof BX.CrmDiskUploader.items[this._uploaderName]!=="undefined"){this._uploader=BX.CrmDiskUploader.items[this._uploaderName]}if(!this._uploader){this._uploader=BX.CrmDiskUploader.create(this._uploaderName,{msg:{diskAttachFiles:this.getMessage("diskAttachFiles"),diskAttachedFiles:this.getMessage("diskAttachedFiles"),diskSelectFile:this.getMessage("diskSelectFile"),diskSelectFileLegend:this.getMessage("diskSelectFileLegend"),diskUploadFile:this.getMessage("diskUploadFile"),diskUploadFileLegend:this.getMessage("diskUploadFileLegend")}})}return this._uploader};BX.Crm.EntityEditorFileStorage.prototype.subscribeOnUploaderChange=function(){if(this._uploader){this._uploader.subscribe("addItem",this._changeHandler);this._uploader.subscribe("removeItem",this._changeHandler)}};BX.Crm.EntityEditorFileStorage.prototype.unSubscribeOnUploaderChange=function(){if(this._uploader){this._uploader.unsubscribe("addItem",this._changeHandler);this._uploader.unsubscribe("removeItem",this._changeHandler)}};BX.Crm.EntityEditorFileStorage.prototype.getDiskUploaderValues=function(){var t=BX.CrmDiskUploader.items[this._uploaderName];return t?t.getFileIds():[]};BX.Crm.EntityEditorFileStorage.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorFileStorage.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorFileStorage.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorFileStorage.prototype.save=function(){var t=this.getStorageTypeId();if(t===BX.UI.EditorFileStorageType.diskfile){this._model.setField(this._schemeElement.getDataStringParam("storageElementIds","STORAGE_ELEMENT_IDS"),this.getDiskUploaderValues())}};BX.Crm.EntityEditorFileStorage.prototype.onBeforeSubmit=function(){if(!this._dataContainer){return}BX.cleanNode(this._dataContainer,false);this._dataContainer.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:this._schemeElement.getDataStringParam("storageTypeId","STORAGE_TYPE_ID"),value:this.getStorageTypeId()}}));var t=this._schemeElement.getDataStringParam("storageElementIds","STORAGE_ELEMENT_IDS");var e=this._model.getArrayField(t,[]);if(e.length>0){for(var i=0,n=e.length;i<n;i++){this._dataContainer.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:t+"[]",value:e[i]}}))}}else{this._dataContainer.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:t,value:""}}))}};if(typeof BX.Crm.EntityEditorFileStorage.messages==="undefined"){BX.Crm.EntityEditorFileStorage.messages={}}BX.Crm.EntityEditorFileStorage.create=function(t,e){var i=new BX.Crm.EntityEditorFileStorage;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorCustom==="undefined"){BX.Crm.EntityEditorCustom=BX.UI.EntityEditorCustom}if(typeof BX.Crm.EntityEditorHidden==="undefined"){BX.Crm.EntityEditorHidden=function(){BX.Crm.EntityEditorHidden.superclass.constructor.apply(this);this._input=null;this._view=null};BX.extend(BX.Crm.EntityEditorHidden,BX.UI.EntityEditorText);BX.Crm.EntityEditorHidden.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-text"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));if(this.hasContentToDisplay()){if(this.getLineCount()>1){this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},html:BX.util.nl2br(BX.util.htmlspecialchars(n))})}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:n})}}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}if(this._mode===BX.UI.EntityEditorMode.edit){this._input=BX.create("input",{props:{id:"crm-entity-widget-content-input",name:e,type:"hidden",value:n}});this._innerWrapper.appendChild(this._input)}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorHidden.create=function(t,e){var i=new BX.Crm.EntityEditorHidden;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityBindingTracker==="undefined"){BX.Crm.EntityBindingTracker=function(){this._id="";this._settings={};this._boundEntityInfos=null;this._unboundEntityInfos=null};BX.Crm.EntityBindingTracker.prototype={initialize:function(){this._boundEntityInfos=[];this._unboundEntityInfos=[]},bind:function(t){if(this.findIndex(t,this._boundEntityInfos)>=0){return}var e=this.findIndex(t,this._unboundEntityInfos);if(e>=0){this._unboundEntityInfos.splice(e,1)}else{this._boundEntityInfos.push(t)}},unbind:function(t){if(this.findIndex(t,this._unboundEntityInfos)>=0){return}var e=this.findIndex(t,this._boundEntityInfos);if(e>=0){this._boundEntityInfos.splice(e,1)}else{this._unboundEntityInfos.push(t)}},getBoundEntities:function(){return this._boundEntityInfos},getUnboundEntities:function(){return this._unboundEntityInfos},isBound:function(t){return this.findIndex(t,this._boundEntityInfos)>=0},isUnbound:function(t){return this.findIndex(t,this._unboundEntityInfos)>=0},reset:function(){this._boundEntityInfos=[];this._unboundEntityInfos=[]},findIndex:function(t,e){var i=t.getId();for(var n=0,r=e.length;n<r;n++){if(i===e[n].getId()){return n}}return-1}};BX.Crm.EntityBindingTracker.create=function(){var t=new BX.Crm.EntityBindingTracker;t.initialize();return t}}if(typeof BX.Crm.EntityEditorSubsection==="undefined"){BX.Crm.EntityEditorSubsection=function(){BX.Crm.EntityEditorSubsection.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorSubsection,BX.Crm.EntityEditorSection);BX.Crm.EntityEditorSubsection.prototype.initialize=function(t,e){BX.Crm.EntityEditorSubsection.superclass.initialize.call(this,t,e);this.initializeFromModel()};BX.Crm.EntityEditorSubsection.prototype.ensureWrapperCreated=function(t){if(!this._wrapper){this._wrapper=BX.create("div")}return this._wrapper};BX.Crm.EntityEditorSubsection.prototype.layout=function(t){this._contentContainer=BX.create("div");var e=this._mode===BX.UI.EntityEditorMode.view;this.ensureWrapperCreated();this.layoutTitle();this._wrapper.appendChild(this._contentContainer);var i=false;for(var n=0,r=this._fields.length;n<r;n++){this.layoutChild(this._fields[n]);if(!i&&this._fields[n].isContextMenuEnabled()){i=true}}if(i){BX.addClass(this._contentContainer,"ui-entity-editor-section-content-padding-right")}this._addChildButton=this._createChildButton=null;if(this.isDragEnabled()){this._dragContainerController=BX.Crm.EditorDragContainerController.create("section_"+this.getId(),{charge:BX.Crm.EditorFieldDragContainer.create({section:this,context:this._draggableContextId}),node:this._wrapper});this._dragContainerController.addDragFinishListener(this._dropHandler);this.initializeDragDropAbilities()}this._addChildButton=this._createChildButton=null;if(!e){this.createButtonPanel();this._contentContainer.appendChild(this._buttonPanelWrapper)}this._hasLayout=true;this.registerLayout(t)};BX.Crm.EntityEditorSubsection.prototype.getChildDragScope=function(){return BX.UI.EditorDragScope.parent};BX.Crm.EntityEditorSubsection.prototype.createButtonPanel=function(){this._buttonPanelWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}})};BX.Crm.EntityEditorSubsection.prototype.layoutChild=function(t){t.setContainer(this._contentContainer);t.setDraggableContextId(this._draggableContextId);this.setChildVisible(t);t.releaseLayout();t.layout();if(this._mode!==BX.UI.EntityEditorMode.view&&t.isHeading()){t.focus()}};BX.Crm.EntityEditorSubsection.prototype.setChildVisible=function(t){t.setVisible(BX.prop.getBoolean(t._schemeElement._settings,"isVisible",true))};BX.Crm.EntityEditorSubsection.prototype.isDragEnabled=function(){return false};BX.Crm.EntityEditorSubsection.prototype.layoutTitle=function(){};BX.Crm.EntityEditorSubsection.prototype.isCreationEnabled=function(){return false};BX.Crm.EntityEditorSubsection.prototype.isContextMenuEnabled=function(){return false};BX.Crm.EntityEditorSubsection.prototype.isRequired=function(){return true};BX.Crm.EntityEditorSubsection.prototype.isNeedToDisplay=function(){return true};BX.Crm.EntityEditorSubsection.prototype.getRuntimeValue=function(){var t=[];for(var e=0;e<this.getChildCount();e++){var i=this._fields[e].getRuntimeValue();if(BX.type.isArray(i)){for(var n in i){if(i.hasOwnProperty(n)){t[n]=i[n]}}}else{t[this._fields[e].getName()]=i}}return t};BX.Crm.EntityEditorSubsection.prototype.createDragButton=function(){if(!this._dragButton){this._dragButton=BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn"}})]})}return this._dragButton};BX.Crm.EntityEditorSubsection.prototype.initializeDragDropAbilities=function(){if(this._dragItem){return}this._dragItem=BX.UI.EditorDragItemController.create("field_"+this.getId(),{charge:BX.UI.EditorFieldDragItem.create({control:this,contextId:this._draggableContextId,scope:this.getDragScope()}),node:this.createDragButton(),showControlInDragMode:false,ghostOffset:{x:0,y:0}})};BX.Crm.EntityEditorSubsection.prototype.processChildControlChange=function(t,e){if(this._isChanged){return}this.markAsChanged(e)};BX.Crm.EntityEditorSubsection.create=function(t,e){var i=new BX.Crm.EntityEditorSubsection;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRecurring==="undefined"){BX.Crm.EntityEditorRecurring=function(){BX.Crm.EntityEditorRecurring.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorRecurring,BX.Crm.EntityEditorSubsection);BX.Crm.EntityEditorRecurring.prototype.initialize=function(t,e){BX.Crm.EntityEditorRecurring.superclass.initialize.call(this,t,e);var i=this._schemeElement.getData();this._schemeFieldData=BX.prop.getObject(i,"fieldData",{});this._enableRecurring=BX.prop.getBoolean(this._schemeElement._settings,"enableRecurring",true);this._recurringModel=this._model.getField(this.getName())};BX.Crm.EntityEditorRecurring.prototype.initializeFromModel=function(){BX.Crm.EntityEditorRecurring.superclass.initializeFromModel.call(this);var t=this;for(var e=0,i=this._fields.length;e<i;e++){this._fields[e].getValue=function(e){if(!BX.type.isNotEmptyString(e)){e=this.getName()}return t.getRecurringFieldValue(e)}}};BX.Crm.EntityEditorRecurring.prototype.getRecurringModel=function(){var t=this.getParent();if(t instanceof BX.Crm.EntityEditorRecurring){return t.getRecurringModel()}return this._recurringModel};BX.Crm.EntityEditorRecurring.prototype.isContextMenuEnabled=function(){return BX.Crm.EntityEditorSubsection.superclass.isContextMenuEnabled.call(this)};BX.Crm.EntityEditorRecurring.prototype.isNeedToDisplay=function(){return false};BX.Crm.EntityEditorRecurring.prototype.isRequired=function(){return this._schemeElement&&this._schemeElement.isRequired()};BX.Crm.EntityEditorRecurring.prototype.prepareContextMenuItems=function(){var t=[];t.push({value:"hide",text:this.getMessage("hide")});return t};BX.Crm.EntityEditorRecurring.prototype.processContextMenuCommand=function(t,e){if(e==="hide"){window.setTimeout(BX.delegate(this.hide,this),500)}else if(this._parent&&this._parent.hasAdditionalMenu()){this._parent.processChildAdditionalMenuCommand(this,e)}this.closeContextMenu()};BX.Crm.EntityEditorRecurring.prototype.isDragEnabled=function(){return BX.Crm.EntityEditorSubsection.superclass.isDragEnabled.call(this)};BX.Crm.EntityEditorRecurring.prototype.getDragObjectType=function(){return BX.UI.EditorDragObjectType.field};BX.Crm.EntityEditorRecurring.prototype.hasContentToDisplay=function(){return true};BX.Crm.EntityEditorRecurring.prototype.getRecurringMode=function(){var t=this.getParent();if(t instanceof BX.Crm.EntityEditorRecurring){return t.getRecurringMode()}return this.getRecurringFieldValue("RECURRING[MODE]")};BX.Crm.EntityEditorRecurring.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRecurring.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorRecurring.prototype.processChildControlChange=function(t,e){var i=t.getName();var n=false;var r=t.getValue();var s=t.getRuntimeValue();if(r!==s){switch(i){case"RECURRING[MODE]":case"RECURRING[MULTIPLE_TYPE_LIMIT]":case"RECURRING[BEGINDATE_TYPE]":case"RECURRING[CLOSEDATE_TYPE]":n=true;break;case"RECURRING[MULTIPLE_TYPE]":if(r===this.getSchemeFieldValue("MULTIPLE_CUSTOM")||s===this.getSchemeFieldValue("MULTIPLE_CUSTOM")){n=true}}}var o=this.getRecurringModel();this.setChangedValue(i,s,o);BX.Crm.EntityEditorRecurring.superclass.processChildControlChange.call(this,t,e);if(n){this.refreshLayout()}};BX.Crm.EntityEditorRecurring.prototype.setChangedValue=function(t,e,i){if(typeof e==="object"){for(var n in e){if(e.hasOwnProperty(n)){this.setChangedValue(n,e[n],i)}}}else{i[t]=e}};BX.Crm.EntityEditorRecurring.prototype.layout=function(t){this._contentContainer=BX.create("div");if(this.isMainSubsection()){this._contentContainer.classList.add("crm-entity-widget-content")}var e=this._mode===BX.UI.EntityEditorMode.view;this.ensureWrapperCreated();this.layoutTitle();this._wrapper.appendChild(this._contentContainer);if(e){var i=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-click-editable"},children:[this.createTitleNode(this.getTitle())]});this._contentContainer.appendChild(i);var n=BX.create("div");var r=this._schemeElement.getData();if(this._schemeElement._promise instanceof BX.Promise){this.loadViewText();this._schemeElement._promise.then(BX.proxy((function(){n.classList="crm-entity-widget-content-block-inner";n.innerHTML=BX.util.htmlspecialchars(r.view.text);i.innerHTML="";i.appendChild(n);this._schemeElement._promise=null}),this))}else if(BX.type.isNotEmptyString(r.view.text)){n.classList="crm-entity-widget-content-block-inner";n.innerHTML=r.view.text;i.appendChild(n)}if(this._enableRecurring){BX.bind(n,"click",BX.delegate(this.toggle,this))}if(this.isContextMenuEnabled()){i.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){i.appendChild(this.createDragButton());this.initializeDragDropAbilities()}}else if(!this._enableRecurring){var i=BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[this.createTitleNode(this.getMessage("modeTitle"))]});var s=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{type:"text",props:{className:"crm-entity-widget-content-input",disabled:"disabled"},text:this.getMessage("notRepeat"),events:{click:BX.delegate(this.showLicencePopup,this)}})]});i.appendChild(s);var o=BX.create("button",{props:{className:"crm-entity-widget-content-block-locked-icon"},events:{click:BX.delegate(this.showLicencePopup,this)}});i.appendChild(o);this._contentContainer.appendChild(i)}else{for(var a=0,l=this._fields.length;a<l;a++){this._fields[a].isDragEnabled=function(){return false};this.layoutChild(this._fields[a])}}this._addChildButton=this._createChildButton=null;this._hasLayout=true;this.registerLayout(t)};BX.Crm.EntityEditorRecurring.prototype.createTitleNode=function(t){var e=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:t})]});return e};BX.Crm.EntityEditorRecurring.prototype.setChildVisible=function(t){var e=false;var i=t.getName();var n=this.getRecurringMode();if(i==="RECURRING[MODE]"){e=true}else if(n===this.getSchemeFieldValue("SINGLE_EXECUTION")){switch(i){case"SINGLE_PARAMS":case"RECURRING[BEGINDATE_TYPE]":case"RECURRING[CLOSEDATE_TYPE]":case"SUBTITLE_NEW_ORDER_PARAMS":case"NEW_BEGINDATE":case"NEW_CLOSEDATE":case"RECURRING[CATEGORY_ID]":e=true;break;case"OFFSET_BEGINDATE":if(this.getRecurringFieldValue("RECURRING[BEGINDATE_TYPE]")===this.getSchemeFieldValue("CALCULATED_FIELD_VALUE")){e=true}break;case"OFFSET_CLOSEDATE":if(this.getRecurringFieldValue("RECURRING[CLOSEDATE_TYPE]")===this.getSchemeFieldValue("CALCULATED_FIELD_VALUE")){e=true}break}}else if(n===this.getSchemeFieldValue("MULTIPLE_EXECUTION")){switch(i){case"MULTIPLE_PARAMS":case"RECURRING[MULTIPLE_TYPE]":case"RECURRING[CATEGORY_ID]":case"RECURRING[MULTIPLE_DATE_START]":case"MULTIPLE_LIMIT":case"RECURRING[MULTIPLE_TYPE_LIMIT]":case"SUBTITLE_NEW_ORDER_PARAMS":case"NEW_BEGINDATE":case"NEW_CLOSEDATE":case"RECURRING[BEGINDATE_TYPE]":case"RECURRING[CLOSEDATE_TYPE]":e=true;break;case"MULTIPLE_CUSTOM":if(this.getRecurringFieldValue("RECURRING[MULTIPLE_TYPE]")===this.getSchemeFieldValue("MULTIPLE_CUSTOM")){e=true}break;case"RECURRING[MULTIPLE_DATE_LIMIT]":if(this.getRecurringFieldValue("RECURRING[MULTIPLE_TYPE_LIMIT]")===this.getSchemeFieldValue("LIMITED_BY_DATE")){e=true}break;case"RECURRING[MULTIPLE_TIMES_LIMIT]":if(this.getRecurringFieldValue("RECURRING[MULTIPLE_TYPE_LIMIT]")===this.getSchemeFieldValue("LIMITED_BY_TIMES")){e=true}break;case"OFFSET_BEGINDATE":if(this.getRecurringFieldValue("RECURRING[BEGINDATE_TYPE]")===this.getSchemeFieldValue("CALCULATED_FIELD_VALUE")){e=true}break;case"OFFSET_CLOSEDATE":if(this.getRecurringFieldValue("RECURRING[CLOSEDATE_TYPE]")===this.getSchemeFieldValue("CALCULATED_FIELD_VALUE")){e=true}break}}t.setVisible(e)};BX.Crm.EntityEditorRecurring.prototype.getRecurringFieldValue=function(t){return BX.prop.get(this.getRecurringModel(),t)};BX.Crm.EntityEditorRecurring.prototype.getSchemeFieldValue=function(t){return BX.prop.get(this._schemeFieldData,t,"")};BX.Crm.EntityEditorRecurring.prototype.isMainSubsection=function(){return!(this.getParent()instanceof BX.Crm.EntityEditorRecurring)};BX.Crm.EntityEditorRecurring.prototype.onBeforeSubmit=function(){if(this.isMainSubsection()){this._wrapper.appendChild(BX.create("input",{props:{type:"hidden",name:"IS_RECURRING",value:this._model.getStringField("IS_RECURRING")==="Y"?"Y":"N"}}))}};BX.Crm.EntityEditorRecurring.prototype.save=function(){if(this.isMainSubsection()){this._schemeElement._promise=new BX.Promise}};BX.Crm.EntityEditorRecurring.prototype.loadViewText=function(){var t=this._schemeElement.getData();if(BX.type.isPlainObject(t.loaders)&&BX.type.isNotEmptyString(t.loaders["url"])&&BX.type.isNotEmptyString(t.loaders["action"])){BX.ajax({url:t.loaders["url"],method:"POST",dataType:"json",data:{ACTION:t.loaders["action"],PARAMS:{ID:this._model.getField("ID")}},onsuccess:BX.delegate(this.onEntityHintLoad,this)})}};BX.Crm.EntityEditorRecurring.prototype.onEntityHintLoad=function(t){var e=BX.prop.getObject(t,"DATA",null);if(!e){return}if(BX.type.isNotEmptyString(e.HINT)){this._schemeElement._data.view.text=e.HINT}if(this._schemeElement._promise instanceof BX.Promise){this._schemeElement._promise.fulfill();this._schemeElement._promise=null}};BX.Crm.EntityEditorRecurring.prototype.showLicencePopup=function(e){e.preventDefault();if(!B24||!B24["licenseInfoPopup"]){return}var layoutData=this._schemeElement.getData();var restrictionScript=layoutData.restrictScript;if(BX.type.isNotEmptyString(restrictionScript)){eval(restrictionScript)}};BX.Crm.EntityEditorRecurring.create=function(t,e){var i=new BX.Crm.EntityEditorRecurring;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRecurringCustomRowField==="undefined"){BX.Crm.EntityEditorRecurringCustomRowField=function(){BX.Crm.EntityEditorRecurringCustomRowField.superclass.constructor.apply(this);this._amountInput=null;this._selectInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null;this._selectedValue="";this._selectClickHandler=BX.delegate(this.onSelectorClick,this);this._isMesureMenuOpened=false};BX.extend(BX.Crm.EntityEditorRecurringCustomRowField,BX.Crm.EntityEditorField);BX.Crm.EntityEditorRecurringCustomRowField.prototype.getModeSwitchType=function(t){var e=BX.UI.EntityEditorModeSwitchType.common;if(t===BX.UI.EntityEditorMode.edit){e|=BX.UI.EntityEditorModeSwitchType.button|BX.UI.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorRecurringCustomRowField.prototype.focus=function(){if(this._amountInput){BX.focus(this._amountInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._amountInput)}};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getValue=function(t){if(!this._model){return""}return this._model.getStringField(this.getAmountFieldName(),t!==undefined?t:"")};BX.Crm.EntityEditorRecurringCustomRowField.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-recurring-custom"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getTitle();var i=this.getData();var n=this.getSelectFieldName();this._selectedValue=this.getValue(n);var r=BX.prop.getArray(BX.prop.getObject(i,"select"),"items");var s="";if(!this._selectedValue){var o=r.length>0?r[0]:null;if(o){this._selectedValue=o["VALUE"];s=o["NAME"]}}else{s=this._editor.findOption(this._selectedValue,r)}var a=this.getAmountFieldName();var l=this.getValue(a);this._amountInput=null;this._selectInput=null;this._selectContainer=null;this._innerWrapper=null;this._sumElement=null;if(this._mode===BX.UI.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(e));this._amountInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",name:a,type:"text",value:l}});BX.bind(this._amountInput,"input",this._changeHandler);this._selectInput=BX.create("input",{attrs:{name:n,type:"hidden",value:this._selectedValue}});this._selectContainer=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:s});BX.bind(this._selectContainer,"click",this._selectClickHandler);this._inputWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-input-wrapper"},children:[this._amountInput,this._selectInput,BX.create("div",{props:{className:"crm-entity-widget-content-block-select"},children:[this._selectContainer]})]});this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"},children:[this._inputWrapper]})}this._wrapper.appendChild(this._innerWrapper);this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRecurringCustomRowField.prototype.doClearLayout=function(t){BX.PopupMenu.destroy(this._id);this._amountInput=null;this._selectInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getAmountFieldName=function(){return this._schemeElement.getDataStringParam("amount","")};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getSelectFieldName=function(){return BX.prop.getString(this._schemeElement.getDataObjectParam("select",{}),"name","")};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onSelectorClick=function(t){this.openListMenu()};BX.Crm.EntityEditorRecurringCustomRowField.prototype.openListMenu=function(){if(this._isListMenuOpened){return}var t=this._schemeElement.getData();var e=BX.prop.getArray(BX.prop.getObject(t,"select"),"items");var i=0;var n=[];while(i<e.length){n.push({text:e[i]["NAME"],value:e[i]["VALUE"],onclick:BX.delegate(this.onSelectItem,this)});i++}BX.PopupMenu.show(this._id,this._selectContainer,n,{angle:false,width:this._selectContainer.offsetWidth+"px",events:{onPopupShow:BX.delegate(this.onListMenuOpen,this),onPopupClose:BX.delegate(this.onListMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._selectContainer)["width"])};BX.Crm.EntityEditorRecurringCustomRowField.prototype.closeListMenu=function(){if(!this._isListMenuOpened){return}var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onListMenuOpen=function(){BX.addClass(this._selectContainer,"active");this._isListMenuOpened=true};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onListMenuClose=function(){BX.PopupMenu.destroy(this._id);BX.removeClass(this._selectContainer,"active");this._isListMenuOpened=false};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onSelectItem=function(t,e){this.closeListMenu();this._selectedValue=this._selectInput.value=e.value;this._selectContainer.innerHTML=BX.util.htmlspecialchars(e.text);this.markAsChanged({fieldName:this.getSelectFieldName(),fieldValue:this._selectedValue})};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getRuntimeValue=function(){var t=[];if(this._mode===BX.UI.EntityEditorMode.edit){if(this._amountInput){t[this.getAmountFieldName()]=this._amountInput.value}t[this.getSelectFieldName()]=this._selectedValue;return t}return""};BX.Crm.EntityEditorRecurringCustomRowField.prototype.save=function(){this._model.setField(this.getSelectFieldName(),this._selectedValue);if(this._amountInput){this._model.setField(this.getAmountFieldName(),this._amountInput.value)}};BX.Crm.EntityEditorRecurringCustomRowField.create=function(t,e){var i=new BX.Crm.EntityEditorRecurringCustomRowField;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRecurringSingleField==="undefined"){BX.Crm.EntityEditorRecurringSingleField=function(){BX.Crm.EntityEditorRecurringSingleField.superclass.constructor.apply(this);this._dateInput=null};BX.extend(BX.Crm.EntityEditorRecurringSingleField,BX.Crm.EntityEditorRecurringCustomRowField);BX.Crm.EntityEditorRecurringSingleField.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-recurring-single"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getTitle();var i=this.getData();var n=this.getAmountFieldName();var r=this.getValue(n);var s=this.getSelectFieldName();this._selectedValue=this.getValue(s);var o=this.getDateFieldName();this._dateValue=this.getValue(o);var a=BX.prop.getArray(BX.prop.getObject(i,"select"),"items");var l="";if(!this._selectedValue){var d=a.length>0?a[0]:null;if(d){this._selectedValue=d["VALUE"];l=d["NAME"]}}else{l=this._editor.findOption(this._selectedValue,a)}this._amountInput=null;this._selectInput=null;this._selectContainer=null;this._innerWrapper=null;this._sumElement=null;if(this._mode===BX.UI.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(e));this._amountInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",name:n,type:"text",value:r}});BX.bind(this._amountInput,"input",this._changeHandler);this._selectInput=BX.create("input",{attrs:{name:s,type:"hidden",value:this._selectedValue}});this._selectContainer=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:l});this._dateInput=BX.create("input",{style:{display:"inline-block"},props:{name:o,className:"crm-entity-widget-content-input crm-entity-widget-content-input-date",value:this._dateValue},events:{click:function(){BX.calendar({node:this,field:this,bTime:false})},change:BX.delegate((function(t){this.markAsChanged()}),this)}});BX.bind(this._selectContainer,"click",this._selectClickHandler);this._inputWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-input-wrapper"},children:[this._amountInput,this._selectInput,BX.create("div",{props:{className:"crm-entity-widget-content-block-select"},children:[this._selectContainer]}),BX.create("span",{text:this.getMessage("until")}),this._dateInput]});this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"},children:[this._inputWrapper]})}this._wrapper.appendChild(this._innerWrapper);this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getDateFieldName=function(){return this._schemeElement.getDataStringParam("date","")};BX.Crm.EntityEditorRecurringSingleField.prototype.getRuntimeValue=function(){var t=[];if(this._mode===BX.UI.EntityEditorMode.edit){if(this._amountInput){t[this.getAmountFieldName()]=this._amountInput.value}t[this.getSelectFieldName()]=this._selectedValue;t[this.getDateFieldName()]=this._dateInput.value;return t}return""};BX.Crm.EntityEditorRecurringSingleField.prototype.save=function(){var t=this._schemeElement.getData();this._model.setField(BX.prop.getString(BX.prop.getObject(t,"select"),"name"),this._selectedValue);if(this._amountInput){this._model.setField(BX.prop.getString(t,"amount"),this._amountInput.value)}if(this._dateInput){this._model.setField(BX.prop.getString(t,"date"),this._dateInput.value)}};BX.Crm.EntityEditorRecurringSingleField.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRecurringSingleField.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorRecurringSingleField.create=function(t,e){var i=new BX.Crm.EntityEditorRecurringSingleField;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorPhone==="undefined"){BX.Crm.EntityEditorPhone=function(){BX.Crm.EntityEditorPhone.superclass.constructor.apply(this);this._dateInput=null};BX.extend(BX.Crm.EntityEditorPhone,BX.UI.EntityEditorText);BX.Crm.EntityEditorPhone.prototype.getEditModeHtmlNodes=function(){var t=this.getValue();this._input=BX.create("input",{props:{type:"hidden",value:t}});if(!this.isVirtual()){this._input.name=this.getName()}this._countryFlagNode=BX.create("span",{props:{className:"crm-entity-widget-content-country-flag"}});this._maskedPhoneInput=BX.create("input",{props:{type:"text",className:"crm-entity-widget-content-input crm-entity-widget-content-input-phone",autocomplete:"nope"}});this._maskedPhone=new BX.PhoneNumber.Input({node:this._maskedPhoneInput,flagNode:this._countryFlagNode,flagSize:24,onChange:BX.delegate(this.onPhoneNumberChange,this)});this._maskedPhone.setValue(t);var e=this.isNewEntity()?this.getCreationPlaceholder():this.getChangePlaceholder();if(e!==""){this._maskedPhoneInput.setAttribute("placeholder",e)}return[BX.create("div",{props:{className:"ui-ctl-w100"},children:[this._countryFlagNode,this._maskedPhoneInput,this._input]})]};BX.Crm.EntityEditorPhone.prototype.getViewModeHtmlNodes=function(){var t=this.getValue();var e=new BX.PhoneNumber;e.setRawNumber(t);return[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},text:e.format()})]};BX.Crm.EntityEditorPhone.prototype.doClearLayout=function(t){BX.Crm.EntityEditorPhone.superclass.doClearLayout.apply(this,arguments);this._maskedPhoneInput=null;this._maskedPhone=null};BX.Crm.EntityEditorPhone.prototype.focus=function(){if(!this._maskedPhoneInput){return}BX.focus(this._maskedPhoneInput);BX.Crm.EditorTextHelper.getCurrent().setPositionAtEnd(this._maskedPhoneInput)};BX.Crm.EntityEditorPhone.prototype.onPhoneNumberChange=function(t){if(!this._input){return}if(this._input.value!==t.value){this._input.value=t.value;this.onChange(t)}};BX.Crm.EntityEditorPhone.prototype.setRawRuntimeValue=function(t){BX.Crm.EntityEditorPhone.superclass.setRawRuntimeValue.apply(this,arguments);if(this._mode===BX.UI.EntityEditorMode.edit&&this._maskedPhone){this._maskedPhone.setValue(t)}};BX.Crm.EntityEditorPhone.prototype.getInputElement=function(){return this._maskedPhoneInput};BX.Crm.EntityEditorPhone.create=function(t,e){var i=new BX.Crm.EntityEditorPhone;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRequisiteSelector==="undefined"){BX.Crm.EntityEditorRequisiteSelector=function(){BX.Crm.EntityEditorRequisiteSelector.superclass.constructor.apply(this);this._requisiteId=0;this._bankDetailId=0;this._itemWrappers={};this._itemButtons={};this._itemBankDetailButtons={}};BX.extend(BX.Crm.EntityEditorRequisiteSelector,BX.Crm.EntityEditorField);BX.Crm.EntityEditorRequisiteSelector.prototype.doInitialize=function(){this._requisiteId=this._model.getIntegerField("REQUISITE_ID",0);this._bankDetailId=this._model.getIntegerField("BANK_DETAIL_ID",0)};BX.Crm.EntityEditorRequisiteSelector.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRequisiteSelector.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorRequisiteSelector.prototype.getPrefix=function(){return this._id.toLowerCase()+"_"};BX.Crm.EntityEditorRequisiteSelector.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getData();this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:this._requisiteId,bankDetailId:this._bankDetailId,data:BX.prop.getArray(e,"data",{})});var i=this._requisiteInfo.getItems();this._wrapper=BX.create("div",{props:{className:"crm-entity-requisites-slider-wrapper"}});var n=BX.create("div",{props:{className:"crm-entity-requisites-slider-content"}});this._wrapper.appendChild(n);var r=BX.create("div",{props:{className:"crm-entity-requisites-slider-widget-content"}});n.appendChild(r);var s=BX.create("div",{props:{className:"crm-entity-requisites-select-container"}});r.appendChild(s);for(var o=0,a=i.length;o<a;o++){s.appendChild(this.prepareItemLayout(i[o]))}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRequisiteSelector.prototype.getItemData=function(t){var e=this._requisiteInfo.getItems();for(var i=0,n=e.length;i<n;i++){var r=e[i];if(t===BX.prop.getInteger(r,"requisiteId",0)){return r}}return null};BX.Crm.EntityEditorRequisiteSelector.prototype.prepareItemLayout=function(t){var e=BX.prop.getObject(t,"viewData",null);if(!e){return}var i=BX.prop.getBoolean(t,"selected",false);var n=this.getPrefix();var r=BX.prop.getInteger(t,"requisiteId",0);var s=BX.create("label",{props:{className:"crm-entity-requisites-select-item"}});s.appendChild(BX.create("strong",{text:BX.prop.getString(e,"title","")}));if(i){BX.addClass(s,"crm-entity-requisites-select-item-selected")}this._itemWrappers[r]=s;var o,a;var l=BX.prop.getArray(e,"fields",[]);for(o=0,a=l.length;o<a;o++){var d=l[o];var p=BX.prop.getString(d,"title","");var h=BX.prop.getString(d,"textValue","");if(p!==""&&h!==""){s.appendChild(BX.create("br"));s.appendChild(BX.create("span",{text:p+": "+h}))}}var u=BX.create("input",{props:{type:"radio",name:n+"requisite",checked:i,className:"crm-entity-requisites-select-item-field"},attrs:{"data-requisiteid":r}});s.appendChild(u);this._itemButtons[r]=u;BX.bind(u,"change",BX.delegate(this.onItemChange,this));var c=BX.prop.getArray(t,"bankDetailViewDataList",[]);if(c.length>0){var y=BX.create("span",{props:{className:"crm-entity-requisites-select-item-bank-requisites-container"}});s.appendChild(y);y.appendChild(BX.create("span",{props:{className:"crm-entity-requisites-select-item-bank-requisites-title"},html:this.getMessage("bankDetails")}));var m=BX.create("span",{props:{className:"crm-entity-requisites-select-item-bank-requisites-field-container"}});y.appendChild(m);this._itemBankDetailButtons[r]={};for(o=0,a=c.length;o<a;o++){var E=c[o];var g=BX.prop.getInteger(E,"pseudoId",0);var _=BX.prop.getObject(E,"viewData",null);if(!_){continue}var f=i&&BX.prop.getBoolean(E,"selected",false);var C=BX.create("label",{props:{className:"crm-entity-requisites-select-item-bank-requisites-field-item"}});m.appendChild(C);var B=BX.create("input",{props:{type:"radio",name:n+"bankrequisite"+r,checked:f,className:"crm-entity-requisites-select-item-bank-requisites-field"},attrs:{"data-requisiteid":r,"data-bankdetailid":g}});C.appendChild(B);BX.bind(B,"change",BX.delegate(this.onItemBankDetailChange,this));this._itemBankDetailButtons[r][g]=B;C.appendChild(document.createTextNode(BX.prop.getString(_,"title","")))}s.appendChild(BX.create("span",{style:{display:"block",clear:"both"}}))}return s};BX.Crm.EntityEditorRequisiteSelector.prototype.clearLayout=function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._itemWrappers={};this._itemButtons={};this._itemBankDetailButtons={};this._hasLayout=false};BX.Crm.EntityEditorRequisiteSelector.prototype.save=function(){this._model.setField("REQUISITE_ID",this._requisiteId,{originator:this});this._model.setField("BANK_DETAIL_ID",this._bankDetailId,{originator:this})};BX.Crm.EntityEditorRequisiteSelector.prototype.onItemChange=function(t){var e=BX.getEventTarget(t);if(!e.checked){return}var i=parseInt(e.getAttribute("data-requisiteid"));if(isNaN(i)||i<=0){return}this._requisiteId=i;this._bankDetailId=0;var n=this.getItemData(this._requisiteId);var r=BX.prop.getArray(n,"bankDetailViewDataList",[]);for(var s=0,o=r.length;s<o;s++){var a=r[s];var l=BX.prop.getInteger(a,"pseudoId",0);if(l>0&&BX.prop.getBoolean(a,"selected",false)){this._bankDetailId=l;break}}for(var d in this._itemWrappers){if(!this._itemWrappers.hasOwnProperty(d)){continue}var p=this._itemWrappers[d];var h=this._requisiteId===parseInt(d);if(h){BX.addClass(p,"crm-entity-requisites-select-item-selected")}else{BX.removeClass(p,"crm-entity-requisites-select-item-selected")}if(this._itemButtons.hasOwnProperty(d)){var u=this._itemButtons[d];if(u.checked!==h){u.checked=h}}if(this._itemBankDetailButtons.hasOwnProperty(d)){var c=this._itemBankDetailButtons[d];for(var y in c){if(!c.hasOwnProperty(y)){continue}var m=h&&this._bankDetailId===parseInt(y);var E=c[y];if(E.checked!==m){E.checked=m}}}}this.markAsChanged()};BX.Crm.EntityEditorRequisiteSelector.prototype.onItemBankDetailChange=function(t){var e=BX.getEventTarget(t);if(!e.checked){return}var i=parseInt(e.getAttribute("data-requisiteid"));if(isNaN(i)||i<=0){return}if(this._requisiteId!==i){return}var n=parseInt(e.getAttribute("data-bankdetailid"));if(isNaN(n)||n<=0){return}this._bankDetailId=n};if(typeof BX.Crm.EntityEditorRequisiteSelector.messages==="undefined"){BX.Crm.EntityEditorRequisiteSelector.messages={}}BX.Crm.EntityEditorRequisiteSelector.create=function(t,e){var i=new BX.Crm.EntityEditorRequisiteSelector;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRequisiteListItem==="undefined"){BX.Crm.EntityEditorRequisiteListItem=function(){this._id="";this._settings=null;this._owner=null;this._mode=BX.UI.EntityEditorModeintermediate;this._data=null;this._requisiteId=0;this._container=null;this._wrapper=null;this._innerWrapper=null;this._editButton=null;this._deleteButton=null;this._hasLayout=false};BX.Crm.EntityEditorRequisiteListItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=BX.type.isPlainObject(e)?e:{};this._owner=BX.prop.get(this._settings,"owner",null);this._mode=BX.prop.getInteger(this._settings,"mode",BX.UI.EntityEditorModeintermediate);this._data=BX.prop.getObject(this._settings,"data",{});this._requisiteId=BX.prop.getInteger(this._data,"requisiteId",0);this._container=BX.prop.getElementNode(this._settings,"container")},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.Crm.EntityEditorRequisiteListItem.messages,t,t)},getRequisiteId:function(){return this._requisiteId},getData:function(){return this._data},setData:function(t){this._data=t},layout:function(t){if(this._hasLayout){return}var e=BX.prop.getObject(this._data,"viewData",null);if(!e){e={}}var i=this._mode===BX.UI.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-container crm-entity-widget-client-requisites-container-opened"}});this._innerWrapper=BX.create("dl",{props:{className:"crm-entity-widget-client-requisites-list"}});this.prepareViewLayout(e,["RQ_ADDR"]);this.prepareFieldViewLayout(e,"RQ_ADDR");var n=BX.prop.getArray(this._data,"bankDetailViewDataList",[]);for(var r=0,s=n.length;r<s;r++){var o=n[r];if(!BX.prop.getBoolean(o,"isDeleted",false)){this.prepareViewLayout(BX.prop.getObject(o,"viewData",null),[])}}if(!i){this._deleteButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-remove-icon"},events:{click:BX.delegate(this.onRemoveButtonClick,this)}});this._editButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-edit-icon"},events:{click:BX.delegate(this.onEditButtonClick,this)}})}this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-inner-container"},children:[this._deleteButton,this._editButton,this._innerWrapper]}));var a=BX.prop.getElementNode(t,"anchor",null);if(a){this._container.insertBefore(this._wrapper,a)}else{this._container.appendChild(this._wrapper)}this._hasLayout=true},prepareViewLayout:function(t,e){if(!t){return}var i=BX.prop.getString(t,"title","");if(i!==""){this._innerWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:i}))}var n,r;var s={};if(BX.type.isArray(e)){for(n=0,r=e.length;n<r;n++){s[e[n]]=true}}var o=[];var a=BX.prop.getArray(t,"fields",[]);for(n=0,r=a.length;n<r;n++){var l=a[n];var d=BX.prop.getString(l,"name","");if(s.hasOwnProperty(d)){continue}var p=BX.prop.getString(l,"title","");var h=BX.prop.getString(l,"textValue","");if(p!==""&&h!==""){o.push(p+": "+h)}}this._innerWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:o.join(", ")}))},prepareFieldViewLayout:function(t,e){if(!t){return}var i=BX.prop.getArray(t,"fields",[]);for(var n=0,r=i.length;n<r;n++){var s=i[n];var o=BX.prop.getString(s,"name","");if(o!==e){continue}var a=BX.prop.getString(s,"title","");var l=BX.prop.getString(s,"textValue","");if(a===""||l===""){continue}this._innerWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:a}));this._innerWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:l}))}},clearLayout:function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._innerWrapper=null;this._editButton=null;this._deleteButton=null;this._hasLayout=false},getContainer:function(){return this._container},setContainer:function(t){this._container=t},getWrapper:function(){return this._wrapper},prepareData:function(){var t=this._labelInput?BX.util.trim(this._labelInput.value):"";if(t===""){return null}var e={VALUE:t};var i=BX.prop.getInteger(this._data,"ID",0);if(i>0){e["ID"]=i}var n=BX.prop.getString(this._data,"XML_ID","");if(i>0){e["XML_ID"]=n}return e},onEditButtonClick:function(t){this._owner.onEditItem(this)},onRemoveButtonClick:function(t){var e=BX.UI.EditorAuxiliaryDialog.create(this._id,{title:this.getMessage("deleteTitle"),content:this.getMessage("deleteConfirm"),buttons:[{id:"accept",type:BX.Crm.DialogButtonType.accept,text:BX.message("CRM_EDITOR_DELETE"),callback:BX.delegate(this.onRemovalConfirmationDialogButtonClick,this)},{id:"cancel",type:BX.Crm.DialogButtonType.cancel,text:BX.message("CRM_EDITOR_CANCEL"),callback:BX.delegate(this.onRemovalConfirmationDialogButtonClick,this)}]});e.open();this._owner.onOpenItemRemovalConfirmation(this)},onRemovalConfirmationDialogButtonClick:function(t){var e=t.getDialog();if(t.getId()==="accept"){this._owner.onRemoveItem(this)}e.close();this._owner.onCloseItemRemovalConfirmation(this)}};if(typeof BX.Crm.EntityEditorRequisiteListItem.messages==="undefined"){BX.Crm.EntityEditorRequisiteListItem.messages={}}BX.Crm.EntityEditorRequisiteListItem.create=function(t,e){var i=new BX.Crm.EntityEditorRequisiteListItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRequisiteList==="undefined"){BX.Crm.EntityEditorRequisiteList=function(){BX.Crm.EntityEditorRequisiteList.superclass.constructor.apply(this);this._items=null;this._data=null;this._externalContext=null;this._externalEventHandler=null;this._createButton=null;this._dataInputs={};this._dataSignInputs={};this._itemWrapper=null;this._dataWrapper=null;this._isPresetMenuOpened=false;this._newItemIndex=-1;this._sliderUrls={}};BX.extend(BX.Crm.EntityEditorRequisiteList,BX.Crm.EntityEditorField);BX.Crm.EntityEditorRequisiteList.prototype.doInitialize=function(){this.initializeFromModel()};BX.Crm.EntityEditorRequisiteList.prototype.initializeFromModel=function(){var t=this.getValue();this._data=BX.type.isArray(t)?BX.clone(t,true):[];var e,i;for(e=0,i=this._data.length;e<i;e++){this.prepareRequisiteData(this._data[e])}this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:0,bankDetailId:0,data:this._data})};BX.Crm.EntityEditorRequisiteList.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.initializeFromModel();this.refreshLayout()};BX.Crm.EntityEditorRequisiteList.prototype.reset=function(){this.initializeFromModel();for(var t in this._sliderUrls){if(this._sliderUrls.hasOwnProperty(t)){BX.Crm.Page.removeSlider(this._sliderUrls[t])}}this._sliderUrls={}};BX.Crm.EntityEditorRequisiteList.prototype.rollback=function(){if(this.isChanged()){this.reset()}};BX.Crm.EntityEditorRequisiteList.prototype.doSetMode=function(t){this.rollback()};BX.Crm.EntityEditorRequisiteList.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRequisiteList.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorRequisiteList.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorRequisiteList.prototype.prepareDataInputName=function(t,e){return this.getName()+"["+t.toString()+"]"+"["+e+"]"};BX.Crm.EntityEditorRequisiteList.prototype.prepareRequisiteData=function(t){var e=BX.prop.getInteger(t,"requisiteId",0);var i=BX.prop.getString(t,"pseudoId","");if(e>0){t["key"]=e.toString();t["isNew"]=false;t["isChanged"]=BX.prop.getBoolean(t,"isChanged",false)}else{t["key"]=i;t["isNew"]=true;t["isChanged"]=BX.prop.getBoolean(t,"isChanged",true)}t["isDeleted"]=false};BX.Crm.EntityEditorRequisiteList.prototype.findRequisiteDataIndexByKey=function(t){for(var e=0,i=this._data.length;e<i;e++){if(BX.prop.getString(this._data[e],"key",0)===t){return e}}return-1};BX.Crm.EntityEditorRequisiteList.prototype.getRequisiteDataByKey=function(t){var e=this.findRequisiteDataIndexByKey(t);return e>=0?this._data[e]:null};BX.Crm.EntityEditorRequisiteList.prototype.setupRequisiteData=function(t){var e=BX.prop.getString(t,"key","");if(e===""){return}var i=this.findRequisiteDataIndexByKey(e);if(i>=0){this._data[i]=t}else{this._data.push(t)}this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:0,bankDetailId:0,data:this._data})};BX.Crm.EntityEditorRequisiteList.prototype.refreshRequisiteDataInputs=function(){if(!this._hasLayout){return}BX.cleanNode(this._dataWrapper);for(var t=0,e=this._data.length;t<e;t++){var i=this._data[t];var n=BX.prop.getString(i,"key","");if(n===""){continue}var r=BX.prop.getBoolean(i,"isChanged",false);var s=BX.prop.getBoolean(i,"isDeleted",false);if(!r&&!s){continue}if(s){this._dataWrapper.appendChild(BX.create("input",{props:{type:"hidden",name:this.prepareDataInputName(n,"DELETED"),value:"Y"}}))}else{var o=BX.prop.getString(i,"requisiteDataSign","");if(o!==""){this._dataWrapper.appendChild(BX.create("input",{props:{type:"hidden",name:this.prepareDataInputName(n,"SIGN"),value:o}}))}var a=BX.prop.getString(i,"requisiteData","");if(a!==""){this._dataWrapper.appendChild(BX.create("input",{props:{type:"hidden",name:this.prepareDataInputName(n,"DATA"),value:a}}))}}}};BX.Crm.EntityEditorRequisiteList.prototype.hasContentToDisplay=function(){if(this._mode===BX.UI.EntityEditorMode.edit){return true}return this._requisiteInfo&&this._requisiteInfo.getItems().length>0};BX.Crm.EntityEditorRequisiteList.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();this._items=[];if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}var e,i;var n=this._requisiteInfo.getItems();for(e=0,i=n.length;e<i;e++){var r=n[e];var s=BX.Crm.EntityEditorRequisiteListItem.create(BX.prop.getString(r,"key",""),{owner:this,mode:this._mode,data:r});this._items.push(s)}if(this.isInEditMode()){this._dataWrapper=BX.create("div");this._wrapper.appendChild(this._dataWrapper);this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._itemWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-requisites"}});this._wrapper.appendChild(this._itemWrapper);for(e=0,i=this._items.length;e<i;e++){this._items[e].setContainer(this._itemWrapper);this._items[e].layout()}this._createButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-add-btn"},text:BX.message("CRM_EDITOR_ADD")});this._itemWrapper.appendChild(this._createButton);BX.bind(this._createButton,"click",BX.delegate(this.onCreateButtonClick,this))}else{this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._itemWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-colums-block"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[this._itemWrapper]}));this._wrapper.appendChild(this._itemWrapper);for(e=0,i=this._items.length;e<i;e++){this._items[e].setContainer(this._itemWrapper);this._items[e].layout()}}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRequisiteList.prototype.doClearLayout=function(t){if(this._items){for(var e=0,i=this._items.length;e<i;e++){this._items[e].clearLayout()}}this._items=[];this._itemWrapper=null;this._createButton=null};BX.Crm.EntityEditorRequisiteList.prototype.getItemByIndex=function(t){return t>=0&&t<=this._items.length-1?this._items[t]:null};BX.Crm.EntityEditorRequisiteList.prototype.getItemById=function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(n.getId()===t){return n}}return null};BX.Crm.EntityEditorRequisiteList.prototype.getItemCount=function(){return this._items.length};BX.Crm.EntityEditorRequisiteList.prototype.getItemIndex=function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1};BX.Crm.EntityEditorRequisiteList.prototype.removeItemByIndex=function(t){if(t<this._items.length){this._items.splice(t,1)}};BX.Crm.EntityEditorRequisiteList.prototype.removeItem=function(t){var e=this.getItemIndex(t);if(e<0){return}var i=this.getRequisiteDataByKey(t.getId());if(i){i["isDeleted"]=true}t.clearLayout();this.removeItemByIndex(e);this.refreshRequisiteDataInputs();this.markAsChanged()};BX.Crm.EntityEditorRequisiteList.prototype.openEditor=function(t){var e=BX.prop.getInteger(t,"requisiteId",0);var i=this._editor.getContextId();var n={etype:this._editor.getEntityTypeId(),eid:this._editor.getEntityId(),external_context_id:i};var r=BX.prop.getInteger(t,"presetId",0);if(r>0){n["pid"]=r}var s="";if(e<=0){this._newItemIndex++;s="n"+this._newItemIndex.toString();n["pseudo_id"]=s}var o=BX.util.add_url_param(this._editor.getRequisiteEditUrl(e),n);if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}if(!this._externalContext){this._externalContext={}}if(e>0){this._externalContext[e]={requisiteId:e,url:o}}else{this._externalContext[s]={pseudoId:s,url:o}}if(e>0){this._sliderUrls[e]=o}BX.Crm.Page.openSlider(o,{width:950})};BX.Crm.EntityEditorRequisiteList.prototype.onEditItem=function(t){this.openEditor({requisiteId:t.getRequisiteId()})};BX.Crm.EntityEditorRequisiteList.prototype.onRemoveItem=function(t){this.removeItem(t)};BX.Crm.EntityEditorRequisiteList.prototype.onOpenItemRemovalConfirmation=function(t){if(this._singleEditController){this._singleEditController.setActiveDelayed(false)}};BX.Crm.EntityEditorRequisiteList.prototype.onCloseItemRemovalConfirmation=function(t){if(this._singleEditController){this._singleEditController.setActiveDelayed(true)}};BX.Crm.EntityEditorRequisiteList.prototype.onExternalEvent=function(t){var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";if(e!=="BX.Crm.RequisiteSliderEditor:onSave"){return}var i=BX.type.isPlainObject(t["value"])?t["value"]:{};var n=BX.prop.getString(i,"context","");if(n!==this._editor.getContextId()){return}var r=BX.prop.getInteger(i,"presetId",0);var s=BX.prop.getString(i,"pseudoId","");var o=BX.prop.getInteger(i,"requisiteId",0);var a=BX.prop.getString(i,"requisiteDataSign","");var l=BX.prop.getString(i,"requisiteData","");var d={entityTypeId:this._editor.getEntityTypeId(),entityId:this._editor.getEntityId(),presetId:r,pseudoId:s,requisiteId:o,requisiteData:l,requisiteDataSign:a,isChanged:true};this.prepareRequisiteData(d);this.setupRequisiteData(d);this.refreshRequisiteDataInputs();this.markAsChanged();var p=BX.prop.getString(d,"key","");var h=BX.prop.getObject(this._externalContext,p,null);if(!h){return}var u=this.getItemById(p);var c;if(u){u.setData(d);u.clearLayout();c={};var y=this.getItemIndex(u);if(y<this.getItemCount()-1){c["anchor"]=this.getItemByIndex(y+1).getWrapper()}else if(this._createButton){c["anchor"]=this._createButton}u.layout(c)}else{u=BX.Crm.EntityEditorRequisiteListItem.create(p,{owner:this,mode:this._mode,data:d,container:this._itemWrapper});this._items.push(u);c={};if(this._createButton){c["anchor"]=this._createButton}u.layout(c)}var m=BX.prop.getString(h,"url","");if(m!==""){BX.Crm.Page.closeSlider(m,true)}delete this._externalContext[o]};BX.Crm.EntityEditorRequisiteList.prototype.onCreateButtonClick=function(t){this.togglePresetMenu()};BX.Crm.EntityEditorRequisiteList.prototype.togglePresetMenu=function(){if(this._isPresetMenuOpened){this.closePresetMenu()}else{this.openPresetMenu()}};BX.Crm.EntityEditorRequisiteList.prototype.openPresetMenu=function(){if(this._isPresetMenuOpened){return}var t=[];var e=BX.prop.getArray(this._schemeElement.getData(),"presets");for(var i=0,n=e.length;i<n;i++){var r=e[i];var s=BX.prop.getString(r,"VALUE",i);var o=BX.prop.getString(r,"NAME",s);t.push({text:o,value:s,onclick:BX.delegate(this.onPresetSelect,this)})}BX.PopupMenu.show(this._id,this._createButton,t,{angle:false,events:{onPopupShow:BX.delegate(this.onPresetMenuShow,this),onPopupClose:BX.delegate(this.onPresetMenuClose,this)}})};BX.Crm.EntityEditorRequisiteList.prototype.closePresetMenu=function(){if(!this._isPresetMenuOpened){return}var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorRequisiteList.prototype.onPresetMenuShow=function(){this._isPresetMenuOpened=true};BX.Crm.EntityEditorRequisiteList.prototype.onPresetMenuClose=function(){BX.PopupMenu.destroy(this._id);this._isPresetMenuOpened=false};BX.Crm.EntityEditorRequisiteList.prototype.onPresetSelect=function(t,e){this.openEditor({presetId:e.value});this.closePresetMenu()};BX.Crm.EntityEditorRequisiteList.prototype.save=function(){};if(typeof BX.Crm.EntityEditorRequisiteList.messages==="undefined"){BX.Crm.EntityEditorRequisiteList.messages={}}BX.Crm.EntityEditorRequisiteList.create=function(t,e){var i=new BX.Crm.EntityEditorRequisiteList;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorEntityRequisitePanel==="undefined"){BX.Crm.ClientEditorEntityRequisitePanel=function(){this._id="";this._settings={};this._editor=null;this._entityInfo=null;this._requisiteInfo=null;this._mode=BX.UI.EntityEditorModeintermediate;this._selectedRequisiteId=0;this._selectedBankDetailId=0;this._container=null;this._wrapper=null;this._contentWrapper=null;this._requisiteInput=null;this._bankDetailInput=null;this._toggleButton=null;this._editButton=null;this._toggleButtonHandler=BX.delegate(this.onToggleButtonClick,this);this._editButtonHandler=BX.delegate(this.onEditButtonClick,this);this._isExpanded=false;this._hasLayout=false;this._externalEventHandler=BX.delegate(this.onExternalEvent,this);this._changeNotifier=null};BX.Crm.ClientEditorEntityRequisitePanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor");this._container=BX.prop.getElementNode(this._settings,"container",null);this._mode=BX.prop.getInteger(this._settings,"mode",0);this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);this._requisiteInfo=BX.prop.get(this._settings,"requisiteInfo",null);this._selectedRequisiteId=this._requisiteInfo.getRequisiteId();this._selectedBankDetailId=this._requisiteInfo.getBankDetailId();this._changeNotifier=BX.CrmNotifier.create(this);if(BX.Crm.ClientEditorEntityRequisitePanel.options.hasOwnProperty(this._id)){this._isExpanded=BX.prop.getBoolean(BX.Crm.ClientEditorEntityRequisitePanel.options[this._id],"expanded",false)}},getMessage:function(t){var e=BX.Crm.ClientEditorEntityRequisitePanel.messages;return e.hasOwnProperty(t)?e[t]:t},getContainer:function(){return this._container},setContainer:function(t){this._container=t},isExpanded:function(){return this._isExpanded},setExpanded:function(t){t=!!t;if(this._isExpanded===t){return}this._isExpanded=t;if(!BX.Crm.ClientEditorEntityRequisitePanel.options.hasOwnProperty(this._id)){BX.Crm.ClientEditorEntityRequisitePanel.options[this._id]={}}BX.Crm.ClientEditorEntityRequisitePanel.options[this._id]["expanded"]=this._isExpanded;if(t){BX.addClass(this._wrapper,"crm-entity-widget-client-requisites-container-opened")}else{BX.removeClass(this._wrapper,"crm-entity-widget-client-requisites-container-opened")}},toggle:function(){this.setExpanded(!this._isExpanded)},addChangeListener:function(t){this._changeNotifier.addListener(t)},removeChangeListener:function(t){this._changeNotifier.removeListener(t)},layout:function(){if(this._hasLayout){return}var t=null;var e=null;var i=this._selectedRequisiteId;var n=this._selectedBankDetailId;if(i>0){t=this._requisiteInfo.getItemById(i)}if(!t){t=this._requisiteInfo.getSelectedItem()}if(!t){t=this._requisiteInfo.getFirstItem()}if(t){if(n>0){e=this._requisiteInfo.getItemBankDetailById(i,n)}if(!e){e=this._requisiteInfo.getSelectedItemBankDetail(i)}if(!e){e=this._requisiteInfo.getFirstItemBankDetail(i)}}var r=this._mode===BX.UI.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-container"}});this._container.appendChild(this._wrapper);if(this._isExpanded){BX.addClass(this._wrapper,"crm-entity-widget-client-requisites-container-opened")}if(!r){this._requisiteInput=BX.create("input",{props:{type:"hidden",name:"REQUISITE_ID",value:i}});this._wrapper.appendChild(this._requisiteInput);this._bankDetailInput=BX.create("input",{props:{type:"hidden",name:"BANK_DETAIL_ID",value:n}});this._wrapper.appendChild(this._bankDetailInput)}if(t){this._toggleButton=BX.create("a",{props:{className:"crm-entity-widget-client-requisites-show-btn"},text:this.getMessage("toggle").toLowerCase()});this._wrapper.appendChild(this._toggleButton);BX.bind(this._toggleButton,"click",this._toggleButtonHandler);var s=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-inner-container"}});this._wrapper.appendChild(s);if(!r){this._editButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-edit-icon"}});this._editButton.setAttribute("data-editor-control-type","button");s.appendChild(this._editButton);BX.bind(this._editButton,"click",this._editButtonHandler)}this._contentWrapper=BX.create("dl",{props:{className:"crm-entity-widget-client-requisites-list"}});s.appendChild(this._contentWrapper);var o=BX.prop.getObject(t,"viewData",null);this.prepareItemView(o,["RQ_ADDR"]);this.prepareItemFieldView(o,"RQ_ADDR");if(e){this.prepareItemView(BX.prop.getObject(e,"viewData",null))}}this._hasLayout=true},prepareItemView:function(t,e){if(!t){return}var i=BX.prop.getString(t,"title","");if(i!==""){this._contentWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:i}))}var n,r;var s={};if(BX.type.isArray(e)){for(n=0,r=e.length;n<r;n++){s[e[n]]=true}}var o=[];var a=BX.prop.getArray(t,"fields",[]);for(n=0,r=a.length;n<r;n++){var l=a[n];var d=BX.prop.getString(l,"name","");if(s.hasOwnProperty(d)){continue}var p=BX.prop.getString(l,"title","");var h=BX.prop.getString(l,"textValue","");if(p!==""&&h!==""){o.push(p+": "+h)}}this._contentWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:o.join(", ")}))},prepareItemFieldView:function(t,e){if(!t){return}var i=BX.prop.getArray(t,"fields",[]);for(var n=0,r=i.length;n<r;n++){var s=i[n];var o=BX.prop.getString(s,"name","");if(o!==e){continue}var a=BX.prop.getString(s,"title","");var l=BX.prop.getString(s,"textValue","");if(a===""||l===""){continue}this._contentWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:a}));this._contentWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:l}))}},clearLayout:function(){if(!this._hasLayout){return}if(this._toggleButton){BX.unbind(this._toggleButton,"click",this._toggleButtonHandler);this._toggleButton=null}if(this._editButton){BX.unbind(this._editButton,"click",this._editButtonHandler);this._editButton=null}this._isExpanded=false;this._requisiteInput=null;this._bankDetailInput=null;this._contentWrapper=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},refreshLayout:function(){var t=this.isExpanded();this.clearLayout();this.layout();this.setExpanded(t)},getRuntimeValue:function(){return{REQUISITE_ID:this._selectedRequisiteId,BANK_DETAIL_ID:this._selectedBankDetailId}},onToggleButtonClick:function(t){this.toggle();return BX.eventReturnFalse(t)},onEditButtonClick:function(t){if(!this._editor){return}var e=BX.prop.getString(this._settings,"requisiteSelectUrl","");if(e===""&&BX.type.isFunction(this._editor.getEntityRequisiteSelectUrl)){e=this._editor.getEntityRequisiteSelectUrl(this._entityInfo.getTypeName(),this._entityInfo.getId())}if(e!==""){e=BX.util.add_url_param(e,{external_context_id:this._editor.getContextId(),requisite_id:this._selectedRequisiteId,bank_detail_id:this._selectedBankDetailId});BX.Crm.Page.openSlider(e);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}BX.eventCancelBubble(t)},onExternalEvent:function(t){if(this._mode===BX.UI.EntityEditorMode.view){return}var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";var i=BX.type.isPlainObject(t["value"])?t["value"]:{};if(!(this._editor&&this._editor.getContextId()===BX.prop.getString(i,"context"))){return}if(e==="BX.Crm.EntityRequisiteSelector:onCancel"){BX.removeCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}else if(e==="BX.Crm.EntityRequisiteSelector:onSave"){BX.removeCustomEvent(window,"onLocalStorageSet",this._externalEventHandler);var n=BX.prop.getInteger(i,"requisiteId");if(n>0){this._selectedRequisiteId=n;if(this._requisiteInput){this._requisiteInput.value=this._selectedRequisiteId}}var r=BX.prop.getInteger(i,"bankDetailId");if(r){this._selectedBankDetailId=r;if(this._bankDetailInput){this._bankDetailInput.value=this._selectedBankDetailId}}this._changeNotifier.notify([{requisiteId:this._selectedRequisiteId,bankDetailId:this._selectedBankDetailId}]);this.refreshLayout()}}};if(typeof BX.Crm.ClientEditorEntityRequisitePanel.messages==="undefined"){BX.Crm.ClientEditorEntityRequisitePanel.messages={}}BX.Crm.ClientEditorEntityRequisitePanel.options={};BX.Crm.ClientEditorEntityRequisitePanel.create=function(t,e){var i=new BX.Crm.ClientEditorEntityRequisitePanel;i.initialize(t,e);return i}}if(typeof BX.Crm.RequisiteNavigator==="undefined"){BX.Crm.RequisiteNavigator=function(){this._id=null;this._settings={};this._requisite=null;this._bankDetail=null;this._bankDetailList=null;this._closingNotifier=null;this._nextButton=null;this._nextButtonHandler=BX.delegate(this.onNextButtonClick,this);this._wrapper=null;this._innerWrapper=null;this._titleContainer=null;this._contentContainer=null;this._bankDetailContainer=null;this._popup=null;this._isOpened=false;this._isExpanded=true;this._hasLayout=false};BX.Crm.RequisiteNavigator.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._requisiteInfo=BX.prop.get(e,"requisiteInfo");var i=this._requisiteInfo.getRequisiteId();var n=this._requisiteInfo.getBankDetailId();this._requisite=i>0?this._requisiteInfo.getItemById(i):null;if(!this._requisite){this._requisite=this._requisiteInfo.getSelectedItem()}if(!this._requisite){this._requisite=this._requisiteInfo.getFirstItem()}if(this._requisite){this._bankDetailList=this._requisiteInfo.getItemBankDetailList(i);if(this._bankDetailList){if(n>0){this._bankDetail=this._bankDetailList.getItemById(n)}if(!this._bankDetail){this._bankDetail=this._bankDetailList.getSelectedItem()}if(!this._bankDetail){this._bankDetail=this._bankDetailList.getFirstItem()}}}this._closingNotifier=BX.CrmNotifier.create(this)},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.Crm.RequisiteNavigator.messages,t,t)},addClosingListener:function(t){this._closingNotifier.addListener(t)},removeClosingListener:function(t){this._closingNotifier.removeListener(t)},isOpened:function(){return this._isOpened},open:function(t){if(this._isOpened){return}var e=0,i=0;if(BX.type.isElementNode(t)){e=t.offsetWidth+15;i=-(t.offsetHeight+30)}this._popup=new BX.PopupWindow(this._id,t,{autoHide:true,draggable:false,offsetLeft:e,offsetTop:i,noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},content:this.prepareContent()});this._popup.show()},close:function(){if(!this._isOpened){return}if(this._popup){this._popup.close()}},prepareContent:function(){this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-wrap"}});this._titleContainer=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-box"}});this._wrapper.appendChild(this._titleContainer);this._requisiteTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-wrapper"}});this._titleContainer.appendChild(this._requisiteTitleWrapper);this._nextButton=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-arrow-right"},children:[BX.create("div",{props:{className:"crm-entity-widget-client-requisites-arrow-right-item"}})]});this._titleContainer.appendChild(this._nextButton);BX.bind(this._nextButton,"click",this._nextButtonHandler);this._contentWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-box crm-entity-widget-client-requisites-box-active"}});this._wrapper.appendChild(this._contentWrapper);this._contentInnerWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-box-inner"}});this._contentWrapper.appendChild(this._contentInnerWrapper);this._requisiteWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-list-container"}});this._contentInnerWrapper.appendChild(this._requisiteWrapper);this._bankDetailWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-list-container"}});this._contentInnerWrapper.appendChild(this._bankDetailWrapper);this.renderRequisites();return this._wrapper},renderTitleFields:function(t,e){for(var i=0,n=t.length;i<n;i++){var r=t[i];var s=BX.prop.getString(r,"title","");var o=BX.prop.getString(r,"textValue","");if(s===""||o===""){continue}e.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-desc"},text:s}));e.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-content"},children:[BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-content-item"},text:o})]}))}},renderContentFields:function(t,e,i){var n=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-list"}});i.appendChild(n);var r=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-item"}});n.appendChild(r);r.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-name"},text:e}));var s=[];for(var o=0,a=t.length;o<a;o++){var l=t[o];var d=BX.prop.getString(l,"title","");var p=BX.prop.getString(l,"textValue","");if(d!==""&&p!==""){s.push(d+": "+p)}}if(s.length>0){r.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-value"},text:s.join(", ")}))}else{BX.addClass(n,"crm-entity-widget-client-requisites-empty-value");r.appendChild(document.createTextNode(this.getMessage("stub")))}},renderRequisites:function(){BX.cleanNode(this._requisiteTitleWrapper);BX.cleanNode(this._requisiteWrapper);this._nextButton.style.display=this._requisiteInfo.getItemCount()>1?"":"none";if(this._requisite){var t=BX.prop.getObject(this._requisite,"viewData",{});var e=BX.prop.getArray(t,"fields",[]);var i=[];var n=[];for(var r=0,s=e.length;r<s;r++){var o=e[r];var a=BX.prop.getString(o,"name","");if(a==="RQ_ADDR"){i.push(o)}else{n.push(o)}}this._requisiteTitleWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-title"},text:BX.prop.getString(t,"title","")}));this.renderTitleFields(i,this._requisiteTitleWrapper);this.renderContentFields(n,"",this._requisiteWrapper);this.renderBankDetails()}},renderBankDetails:function(){BX.cleanNode(this._bankDetailWrapper);if(this._bankDetailList&&this._bankDetail){var t=BX.prop.getObject(this._bankDetail,"viewData",{});this.renderContentFields(BX.prop.getArray(t,"fields",[]),BX.prop.getString(t,"title",""),this._bankDetailWrapper);var e=this._bankDetailList.getItemCount();if(e>1){var i=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-control-box"}});this._bankDetailWrapper.appendChild(i);i.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-control-value"},text:this.getMessage("legend").replace(/#NUMBER#/gi,this._bankDetailList.getItemIndex(this._bankDetail)+1).toString().replace(/#TOTAL#/gi,e.toString())}));i.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-control-btn"},html:this.getMessage("next")+"&rarr;",events:{click:BX.delegate(this.onNextBankDetailButtonClick,this)}}))}}},getSelectedItemId:function(){return this._requisite?BX.CrmEntityRequisiteInfo.resolveItemId(this._requisite):0},getSelectedBankDetailId:function(){return this._bankDetail?BX.CrmEntityBankDetailList.resolveItemId(this._bankDetail):0},showNextItem:function(){if(!(this._requisiteInfo&&this._requisite)){return}var t=this._requisiteInfo.getItemCount();if(t===0){return}var e=this._requisiteInfo.getItemIndex(this._requisite);if(e<0){e=0}e++;if(e===t){e=0}this._requisite=this._requisiteInfo.getItemByIndex(e);if(this._requisite){var i=BX.CrmEntityRequisiteInfo.resolveItemId(this._requisite);this._bankDetailList=this._requisiteInfo.getItemBankDetailList(i);if(this._bankDetailList){this._bankDetail=this._bankDetailList.getSelectedItem();if(!this._bankDetail){this._bankDetail=this._bankDetailList.getFirstItem()}}}this.renderRequisites()},showNextBankDetail:function(){if(!(this._bankDetailList&&this._bankDetail)){return}var t=this._bankDetailList.getItemCount();if(t===0){return}var e=this._bankDetailList.getItemIndex(this._bankDetail);if(e<0){e=0}e++;if(e===t){e=0}this._bankDetail=this._bankDetailList.getItemByIndex(e);this.renderBankDetails()},onPopupShow:function(){this._isOpened=true},onPopupClose:function(){if(this._popup){this._popup.destroy()}this._closingNotifier.notify([{requisiteId:this.getSelectedItemId(),bankDetailId:this.getSelectedBankDetailId()}])},onPopupDestroy:function(){this._isOpened=false;this._wrapper=null;this._innerWrapper=null;this._popup=null},onNextButtonClick:function(t){this.showNextItem()},onNextBankDetailButtonClick:function(t){this.showNextBankDetail()}};BX.Crm.RequisiteNavigator.options={};if(typeof BX.Crm.RequisiteNavigator.messages==="undefined"){BX.Crm.RequisiteNavigator.messages={}}BX.Crm.RequisiteNavigator.create=function(t,e){var i=new BX.Crm.RequisiteNavigator;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorClientLight==="undefined"){BX.Crm.EntityEditorClientLight=function(){BX.Crm.EntityEditorClientLight.superclass.constructor.apply(this);this._map=null;this._info=null;this._primaryLoaderConfig=null;this._secondaryLoaderConfig=null;this._dataElements=null;this._companyInfos=null;this._contactInfos=null;this._enableCompanyMultiplicity=false;this._companyTitleWrapper=null;this._contactTitleWrapper=null;this._companySearchBoxes=null;this._contactSearchBoxes=null;this._companyPanels=null;this._contactPanels=null;this._companyWrapper=null;this._contactWrapper=null;this._addCompanyButton=null;this._addContactButton=null;this._innerWrapper=null;this._layoutType=BX.Crm.EntityEditorClientLayoutType.undefined;this._visibleClientFields=null;this._enableLayoutTypeChange=false;this._enableQuickEdit=null;this._companyNameChangeHandler=BX.delegate(this.onCompanyNameChange,this);this._companyChangeHandler=BX.delegate(this.onCompanyChange,this);this._companyDeletionHandler=BX.delegate(this.onCompanyDelete,this);this._companyResetHandler=BX.delegate(this.onCompanyReset,this);this._contactNameChangeHandler=BX.delegate(this.onContactNameChange,this);this._contactChangeHandler=BX.delegate(this.onContactChange,this);this._contactDeletionHandler=BX.delegate(this.onContactDelete,this);this._contactResetHandler=BX.delegate(this.onContactReset,this);this._requisiteChangeHandler=BX.delegate(this.onRequisiteChange,this);this._multifieldChangeHandler=BX.delegate(this.onMultifieldChange,this)};BX.extend(BX.Crm.EntityEditorClientLight,BX.Crm.EntityEditorField);BX.Crm.EntityEditorClientLight.prototype.doInitialize=function(){BX.Crm.EntityEditorClientLight.superclass.doInitialize.apply(this);this._map=this._schemeElement.getDataObjectParam("map",{});this.initializeFromModel()};BX.Crm.EntityEditorClientLight.prototype.initializeFromModel=function(){this._companyInfos=BX.Collection.create();this._contactInfos=BX.Collection.create();this._info=this._model.getSchemeField(this._schemeElement,"info",{});this.initializeEntityInfos(BX.prop.getArray(this._info,"COMPANY_DATA",[]),this._companyInfos);this.initializeEntityInfos(BX.prop.getArray(this._info,"CONTACT_DATA",[]),this._contactInfos);this._enableCompanyMultiplicity=this._schemeElement.getDataBooleanParam("enableCompanyMultiplicity",false);var t=this._schemeElement.getDataObjectParam("loaders",{});this._primaryLoaderConfig=BX.prop.getObject(t,"primary",{});this._secondaryLoaderConfig=BX.prop.getObject(t,"secondary",{});this._enableLayoutTypeChange=true;var e=this._schemeElement.getDataStringParam("fixedLayoutType","");if(e!==""){var i=BX.Crm.EntityEditorClientLayoutType.resolveId(e);if(i!==BX.Crm.EntityEditorClientLayoutType.undefined){this._layoutType=i;this._enableLayoutTypeChange=false}}};BX.Crm.EntityEditorClientLight.prototype.initializeEntityInfos=function(t,e){for(var i=0,n=t.length;i<n;i++){var r=BX.CrmEntityInfo.create(t[i]);if(r.getId()>0){e.add(r)}}};BX.Crm.EntityEditorClientLight.prototype.createDataElement=function(t,e){var i=BX.prop.getString(this._map,t,"");if(i===""){return}var n=BX.create("input",{attrs:{name:i,type:"hidden"}});if(BX.type.isNotEmptyString(e)){n.value=e}if(!this._dataElements){this._dataElements={}}this._dataElements[t]=n;if(this._wrapper){this._wrapper.appendChild(n)}};BX.Crm.EntityEditorClientLight.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorClientLight.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorClientLight.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorClientLight.prototype.getOwnerTypeName=function(){return this._editor.getEntityTypeName()};BX.Crm.EntityEditorClientLight.prototype.getOwnerTypeId=function(){return this._editor.getEntityTypeId()};BX.Crm.EntityEditorClientLight.prototype.getOwnerId=function(){return this._editor.getEntityId()};BX.Crm.EntityEditorClientLight.prototype.hasCompanies=function(){return this._companyInfos!==null&&this._companyInfos.length()>0};BX.Crm.EntityEditorClientLight.prototype.hasContacts=function(){return this._contactInfos!==null&&this._contactInfos.length()>0};BX.Crm.EntityEditorClientLight.prototype.addCompany=function(t){if(t instanceof BX.CrmEntityInfo){if(!this._companyInfos){this._companyInfos=BX.Collection.create()}this._companyInfos.add(t)}};BX.Crm.EntityEditorClientLight.prototype.removeCompany=function(t){if(this._companyInfos&&t instanceof BX.CrmEntityInfo){this._companyInfos.remove(t)}};BX.Crm.EntityEditorClientLight.prototype.addContact=function(t){if(t instanceof BX.CrmEntityInfo){if(!this._contactInfos){this._contactInfos=BX.Collection.create()}this._contactInfos.add(t)}};BX.Crm.EntityEditorClientLight.prototype.removeContact=function(t){if(this._contactInfos&&t instanceof BX.CrmEntityInfo){this._contactInfos.remove(t)}};BX.Crm.EntityEditorClientLight.prototype.hasContentToDisplay=function(){return this.hasCompanies()||this._contactInfos!==null&&this._contactInfos.length()>0};BX.Crm.EntityEditorClientLight.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorClientLight.prototype.getModeSwitchType=function(t){var e=BX.UI.EntityEditorModeSwitchType.common;if(t===BX.UI.EntityEditorMode.edit){e|=BX.UI.EntityEditorModeSwitchType.button|BX.UI.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorClientLight.prototype.reset=function(){this.initializeFromModel()};BX.Crm.EntityEditorClientLight.prototype.rollback=function(){if(this.isChanged()){this.initializeFromModel()}};BX.Crm.EntityEditorClientLight.prototype.getEntityCreateUrl=function(t){return this._editor.getEntityCreateUrl(t)};BX.Crm.EntityEditorClientLight.prototype.getEntityEditUrl=function(t,e){return this._editor.getEntityEditUrl(t,e)};BX.Crm.EntityEditorClientLight.prototype.doSetMode=function(t){this.rollback()};BX.Crm.EntityEditorClientLight.prototype.doPrepareContextMenuItems=function(t){t.push({delimiter:true});if(this._enableLayoutTypeChange){var e=this.getLayoutType();if(e===BX.Crm.EntityEditorClientLayoutType.companyContact||e===BX.Crm.EntityEditorClientLayoutType.contactCompany){t.push({value:"set_layout_contact",text:this.getMessage("disableCompany")});t.push({value:"set_layout_company",text:this.getMessage("disableContact")})}else if(e===BX.Crm.EntityEditorClientLayoutType.company){t.push({value:"set_layout_company_contact",text:this.getMessage("enableContact")})}else if(e===BX.Crm.EntityEditorClientLayoutType.contact){t.push({value:"set_layout_contact_company",text:this.getMessage("enableCompany")})}if(this.isClientFieldVisible("ADDRESS")){t.push({value:"hide_client_field_address",text:this.getMessage("disableAddress")})}else{t.push({value:"show_client_field_address",text:this.getMessage("enableAddress")})}if(this.isClientFieldVisible("REQUISITES")){t.push({value:"hide_client_field_requisites",text:this.getMessage("disableRequisites")})}else{t.push({value:"show_client_field_requisites",text:this.getMessage("enableRequisites")})}if(e===BX.Crm.EntityEditorClientLayoutType.companyContact){t.push({delimiter:true});t.push({value:"set_layout_contact_company",text:this.getMessage("displayContactAtFirst")})}else if(e===BX.Crm.EntityEditorClientLayoutType.contactCompany){t.push({delimiter:true});t.push({value:"set_layout_company_contact",text:this.getMessage("displayCompanyAtFirst")})}t.push({delimiter:true})}if(this.isQuickEditEnabled()){t.push({value:"disable_quick_edit",text:this.getMessage("disableQuickEdit")})}else{t.push({value:"enable_quick_edit",text:this.getMessage("enableQuickEdit")})}};BX.Crm.EntityEditorClientLight.prototype.processContextMenuCommand=function(t,e){if(e==="set_layout_contact_company"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.contactCompany)}.bind(this),100)}else if(e==="set_layout_company_contact"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.companyContact)}.bind(this),100)}else if(e==="set_layout_contact"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.contact)}.bind(this),100)}else if(e==="set_layout_company"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.company)}.bind(this),100)}else if(e==="hide_client_field_address"){window.setTimeout(function(){this.setClientFieldVisible("ADDRESS",false)}.bind(this),100)}else if(e==="show_client_field_address"){window.setTimeout(function(){this.setClientFieldVisible("ADDRESS",true)}.bind(this),100)}else if(e==="hide_client_field_requisites"){window.setTimeout(function(){this.setClientFieldVisible("REQUISITES",false)}.bind(this),100)}else if(e==="show_client_field_requisites"){window.setTimeout(function(){this.setClientFieldVisible("REQUISITES",true)}.bind(this),100)}else if(e==="disable_quick_edit"){this.enableQuickEdit(false)}else if(e==="enable_quick_edit"){this.enableQuickEdit(true)}BX.Crm.EntityEditorClientLight.superclass.processContextMenuCommand.apply(this,arguments)};BX.Crm.EntityEditorClientLight.prototype.isQuickEditEnabled=function(){if(this._enableQuickEdit===null){this._enableQuickEdit=this._editor.getConfigOption("enableQuickEdit","Y")==="Y"}return this._enableQuickEdit};BX.Crm.EntityEditorClientLight.prototype.enableQuickEdit=function(t){t=!!t;if(this._enableQuickEdit===null){this._enableQuickEdit=this._editor.getConfigOption("enableQuickEdit","Y")==="Y"}if(this._enableQuickEdit===t){return}this._enableQuickEdit=t;this._editor.setConfigOption("enableQuickEdit",t?"Y":"N");var e,i;if(this._companySearchBoxes){for(e=0,i=this._companySearchBoxes.length;e<i;e++){this._companySearchBoxes[e].enableQuickEdit(t)}}if(this._contactSearchBoxes){for(e=0,i=this._contactSearchBoxes.length;e<i;e++){this._contactSearchBoxes[e].enableQuickEdit(t)}}};BX.Crm.EntityEditorClientLight.prototype.isCompanyEnabled=function(){var t=this.getLayoutType();return t===BX.Crm.EntityEditorClientLayoutType.contactCompany||t===BX.Crm.EntityEditorClientLayoutType.companyContact||t===BX.Crm.EntityEditorClientLayoutType.company};BX.Crm.EntityEditorClientLight.prototype.isContactEnabled=function(){var t=this.getLayoutType();return t===BX.Crm.EntityEditorClientLayoutType.contactCompany||t===BX.Crm.EntityEditorClientLayoutType.companyContact||t===BX.Crm.EntityEditorClientLayoutType.contact};BX.Crm.EntityEditorClientLight.prototype.getLayoutType=function(){if(this._layoutType<=0){var t=this._editor.getConfigOption("client_layout","");var e=parseInt(t);if(isNaN(e)||e<=0){e=BX.Crm.EntityEditorClientLayoutType.companyContact}this._layoutType=e}return this._layoutType};BX.Crm.EntityEditorClientLight.prototype.setLayoutType=function(t){if(!BX.type.isNumber(t)){t=parseInt(t)}if(isNaN(t)||t<=0){return}if(t===this._layoutType){return}this._layoutType=t;this._editor.setConfigOption("client_layout",t);this.refreshLayout()};BX.Crm.EntityEditorClientLight.prototype.loadClientVisibleFields=function(){var t=this._editor.getConfigOption("client_visible_fields",null);if(BX.Type.isString(t)){t=t.split(",")}else{t=["ADDRESS","REQUISITES"]}return t};BX.Crm.EntityEditorClientLight.prototype.isClientFieldVisible=function(t){if(!BX.Type.isArray(this._visibleClientFields)){this._visibleClientFields=this.loadClientVisibleFields()}return this._visibleClientFields.indexOf(t)>-1};BX.Crm.EntityEditorClientLight.prototype.setClientFieldVisible=function(t,e){if(!BX.Type.isArray(this._visibleClientFields)){this._visibleClientFields=this.loadClientVisibleFields()}if(e&&this._visibleClientFields.indexOf(t)===-1){this._visibleClientFields.push(t)}if(!e&&this._visibleClientFields.indexOf(t)>-1){this._visibleClientFields.splice(this._visibleClientFields.indexOf(t),1)}this._editor.setConfigOption("client_visible_fields",this._visibleClientFields.join(","));this.refreshLayout()};BX.Crm.EntityEditorClientLight.prototype.getClientVisibleFieldsList=function(t){var e=this.getClientEditorFieldsParams(t);var i=["PHONE","EMAIL"];if(this.isClientFieldVisible("ADDRESS")&&e.hasOwnProperty("ADDRESS")){i.push("ADDRESS")}if(this.isClientFieldVisible("REQUISITES")&&e.hasOwnProperty("REQUISITES")){i.push("REQUISITES")}return i};BX.Crm.EntityEditorClientLight.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));if(!this.hasContentToDisplay()&&this.isInViewMode()){this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-inner"},text:this.getMessage("isEmpty")});this._wrapper.appendChild(this._innerWrapper)}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._innerWrapper);var e=this.getLayoutType();if(this.isInEditMode()){var i=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"}});this._innerWrapper.appendChild(i);this._innerContainer=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container-inner"}});i.appendChild(this._innerContainer)}else{BX.addClass(this._wrapper,"crm-entity-widget-participants-block");BX.addClass(this._innerWrapper,"crm-entity-widget-inner")}if(this.isContactEnabled()&&this.isCompanyEnabled()){if(e===BX.Crm.EntityEditorClientLayoutType.contactCompany){this.renderContact();this.renderCompany()}else if(e===BX.Crm.EntityEditorClientLayoutType.companyContact){this.renderCompany();this.renderContact()}}else{if(this.isContactEnabled()){this.renderContact()}if(this.isCompanyEnabled()){this.renderCompany()}}}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._entityEditParams={};this._hasLayout=true};BX.Crm.EntityEditorClientLight.prototype.createAdditionalWrapperBlock=function(){};BX.Crm.EntityEditorClientLight.prototype.switchToSingleEditMode=function(t){this._entityEditParams={};if(this.isInViewMode()&&this.isQuickEditEnabled()&&BX.type.isElementNode(t)){var e=false;if(BX.isParentForNode(this._companyTitleWrapper,t)){e=true;this._entityEditParams["enableCompany"]=true;this._entityEditParams["companyIndex"]=0}if(!e&&BX.isParentForNode(this._contactTitleWrapper,t)){e=true;this._entityEditParams["enableContact"]=true;this._entityEditParams["contactIndex"]=0}var i,n;if(!e&&this._companyPanels!==null){for(i=0,n=this._companyPanels.length;i<n;i++){if(this._companyPanels[i].checkOwership(t)){e=true;this._entityEditParams["enableCompany"]=true;this._entityEditParams["companyIndex"]=i;break}}}if(!e&&this._contactPanels!==null){for(i=0,n=this._contactPanels.length;i<n;i++){if(this._contactPanels[i].checkOwership(t)){e=true;this._entityEditParams["enableContact"]=true;this._entityEditParams["contactIndex"]=i;break}}}if(!BX.prop.getBoolean(this._entityEditParams,"enableCompany",false)&&!BX.prop.getBoolean(this._entityEditParams,"enableContact",false)){var r=this.getLayoutType();if(r===BX.Crm.EntityEditorClientLayoutType.contact||r===BX.Crm.EntityEditorClientLayoutType.contactCompany){this._entityEditParams["enableContact"]=true;this._entityEditParams["contactIndex"]=0}else if(r===BX.Crm.EntityEditorClientLayoutType.company||r===BX.Crm.EntityEditorClientLayoutType.companyContact){this._entityEditParams["enableCompany"]=true}}}BX.Crm.EntityEditorClientLight.superclass.switchToSingleEditMode.apply(this,arguments)};BX.Crm.EntityEditorClientLight.prototype.getEntityInitialMode=function(t){if(!this.isQuickEditEnabled()){return BX.Crm.EntityEditorClientMode.select}if(!this.checkModeOption(BX.UI.EntityEditorModeOptions.individual)){return BX.Crm.EntityEditorClientMode.edit}return BX.prop.getBoolean(this._entityEditParams,t===BX.CrmEntityType.enumeration.contact?"enableContact":"enableCompany",false)?BX.Crm.EntityEditorClientMode.edit:BX.Crm.EntityEditorClientMode.select};BX.Crm.EntityEditorClientLight.prototype.resolveDataTagName=function(t){var e=this._schemeElement.getDataArrayParam("compound",null);if(BX.type.isArray(e)){for(var i=0,n=e.length;i<n;i++){if(BX.prop.getString(e[i],"entityTypeName","")===t){return BX.prop.getString(e[i],"tagName","")}}}return""};BX.Crm.EntityEditorClientLight.prototype.renderContact=function(){var t=this._schemeElement.getDataStringParam("contactLegend","");if(t===""){t=BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.contact)}this.removeContactAllSearchBoxes();this.removeContactAllPanels();if(this.isInEditMode()){this._contactWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-inner-row"}});this._innerContainer.appendChild(this._contactWrapper);this._contactTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},text:t})]});this._contactWrapper.appendChild(this._contactTitleWrapper);this._addContactButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-add"},text:this.getMessage("addParticipant")});this._contactWrapper.appendChild(this._addContactButton);BX.bind(this._addContactButton,"click",BX.delegate(this.onContactAddButtonClick,this));this._contactSearchBoxes=[];if(this._contactInfos.length()>0){var e=this.getEntityInitialMode(BX.CrmEntityType.enumeration.contact);var i=this._contactInfos.length()>1?-2:-1;var n=e===BX.Crm.EntityEditorClientMode.edit?BX.prop.getInteger(this._entityEditParams,"contactIndex",i):i;for(var r=0,s=this._contactInfos.length();r<s;r++){var o=e;if(o===BX.Crm.EntityEditorClientMode.edit&&!(n===r||n===-1)){o=BX.Crm.EntityEditorClientMode.select}this.addContactSearchBox(this.createContactSearchBox({entityInfo:this._contactInfos.get(r),mode:o}))}}else{this.addContactSearchBox(this.createContactSearchBox())}}else if(this._contactInfos.length()>0&&this.isContactEnabled()){this._contactTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-title"}});var a=BX.create("span",{props:{className:"crm-entity-widget-content-subtitle-text"},children:[BX.create("span",{text:t})]});this._contactTitleWrapper.appendChild(a);if(!this.isReadOnly()){a.appendChild(BX.create("span",{props:{className:"crm-entity-card-widget-title-edit-icon"}}))}var l=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-container"}});this._innerWrapper.appendChild(l);l.appendChild(this._contactTitleWrapper);var d=this.resolveDataTagName(BX.CrmEntityType.names.contact);if(d===""){d="CONTACT_IDS"}var p=BX.create("div",{props:{className:"crm-entity-widget-before-action"},attrs:{"data-field-tag":d}});l.appendChild(p);this._contactPanels=[];for(r=0,s=this._contactInfos.length();r<s;r++){var h=this._contactInfos.get(r);var u=this._schemeElement.getDataBooleanParam("useExternalRequisiteBinding",false);var c={editor:this,entityInfo:h,loaderConfig:BX.prop.getObject(this._primaryLoaderConfig,h.getTypeName(),null),enableEntityTypeCaption:false,enableRequisite:false,enableCommunications:this._editor.areCommunicationControlsEnabled(),enableAddress:this.isClientFieldVisible("ADDRESS"),enableTooltip:this._schemeElement.getDataBooleanParam("enableTooltip",true)&&this.isClientFieldVisible("REQUISITES"),mode:BX.UI.EntityEditorMode.view,clientEditorFieldsParams:this.getClientEditorFieldsParams(h.getTypeName()),canChangeDefaultRequisite:!u,useExternalRequisiteBinding:u};var y=r===0&&!(this.isCompanyEnabled()&&this.hasCompanies());if(y){c["enableRequisite"]=true;c["requisiteBinding"]=this._model.getField("REQUISITE_BINDING",{});c["requisiteSelectUrl"]=this._editor.getEntityRequisiteSelectUrl(BX.CrmEntityType.names.contact,h.getId());c["requisiteMode"]=BX.UI.EntityEditorMode.edit}if(u){c["canChangeDefaultRequisite"]=y}var m=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+h.getId().toString(),c);this._contactPanels.push(m);m.setContainer(l);m.layout();if(y){m.addRequisiteChangeListener(this._requisiteChangeHandler)}m.addRequisiteListChangeListener(this.onRequisiteListChange.bind(this))}}};BX.Crm.EntityEditorClientLight.prototype.renderCompany=function(){var t=this._schemeElement.getDataStringParam("companyLegend","");if(t===""){t=BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.company)}this.removeCompanyAllSearchBoxes();this.removeCompanyAllPanels();if(this.isInEditMode()){this._companyWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-inner-row"}});this._innerContainer.appendChild(this._companyWrapper);this._companyTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},text:t})]});this._companyWrapper.appendChild(this._companyTitleWrapper);if(this._enableCompanyMultiplicity){this._addCompanyButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-add"},text:this.getMessage("addParticipant")});this._companyWrapper.appendChild(this._addCompanyButton);BX.bind(this._addCompanyButton,"click",BX.delegate(this.onCompanyAddButtonClick,this))}this._companySearchBoxes=[];if(this._companyInfos.length()>0){var e=this.getEntityInitialMode(BX.CrmEntityType.enumeration.company);var i=this._companyInfos.length()>1?-2:-1;var n=e===BX.Crm.EntityEditorClientMode.edit?BX.prop.getInteger(this._entityEditParams,"companyIndex",i):i;for(var r=0,s=this._companyInfos.length();r<s;r++){var o=e;if(o===BX.Crm.EntityEditorClientMode.edit&&!(n===r||n===-1)){o=BX.Crm.EntityEditorClientMode.select}this.addCompanySearchBox(this.createCompanySearchBox({entityInfo:this._companyInfos.get(r),mode:o}))}}else{this.addCompanySearchBox(this.createCompanySearchBox())}}else if(this.isCompanyEnabled()&&this._companyInfos.length()>0){this._companyTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-title"}});var a=BX.create("span",{props:{className:"crm-entity-widget-content-subtitle-text"},children:[BX.create("span",{text:t})]});this._companyTitleWrapper.appendChild(a);if(!this.isReadOnly()){a.appendChild(BX.create("span",{props:{className:"crm-entity-card-widget-title-edit-icon"}}))}var l=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-container"}});this._innerWrapper.appendChild(l);l.appendChild(this._companyTitleWrapper);var d=this.resolveDataTagName(BX.CrmEntityType.names.company);if(d===""){d=this._enableCompanyMultiplicity?"COMPANY_IDS":"COMPANY_ID"}var p=BX.create("div",{props:{className:"crm-entity-widget-before-action"},attrs:{"data-field-tag":d}});l.appendChild(p);this._companyPanels=[];for(r=0,s=this._companyInfos.length();r<s;r++){var h=this._companyInfos.get(r);var u=this._schemeElement.getDataBooleanParam("useExternalRequisiteBinding",false);var c={editor:this,entityInfo:h,loaderConfig:BX.prop.getObject(this._primaryLoaderConfig,h.getTypeName(),null),enableEntityTypeCaption:false,enableRequisite:false,enableCommunications:this._editor.areCommunicationControlsEnabled(),enableAddress:this.isClientFieldVisible("ADDRESS"),enableTooltip:this._schemeElement.getDataBooleanParam("enableTooltip",true)&&this.isClientFieldVisible("REQUISITES"),mode:BX.UI.EntityEditorMode.view,clientEditorFieldsParams:this.getClientEditorFieldsParams(h.getTypeName()),canChangeDefaultRequisite:!u,useExternalRequisiteBinding:u};var y=r===0;if(y){c["requisiteBinding"]=this._model.getField("REQUISITE_BINDING",{});c["requisiteSelectUrl"]=this._editor.getEntityRequisiteSelectUrl(BX.CrmEntityType.names.company,h.getId());c["requisiteMode"]=BX.UI.EntityEditorMode.edit}if(u){c["canChangeDefaultRequisite"]=y}var m=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+h.getId().toString(),c);this._companyPanels.push(m);m.setContainer(l);m.layout();if(y){m.addRequisiteChangeListener(this._requisiteChangeHandler)}m.addRequisiteListChangeListener(this.onRequisiteListChange.bind(this))}}};BX.Crm.EntityEditorClientLight.prototype.createCompanySearchBox=function(t){var e=BX.prop.get(t,"entityInfo",null);if(e!==null&&!(e instanceof BX.CrmEntityInfo)){e=null}var i=this._editor.canCreateCompany();if(i){i=BX.prop.getBoolean(this._schemeElement.getDataObjectParam("creation",{}),BX.CrmEntityType.names.company.toLowerCase(),true)}return BX.Crm.EntityEditorClientSearchBox.create(this._id,{entityTypeId:BX.CrmEntityType.enumeration.company,entityTypeName:BX.CrmEntityType.names.company,entityInfo:e,enableCreation:i,enableDeletion:false,enableQuickEdit:this.isQuickEditEnabled(),mode:BX.prop.getInteger(t,"mode",BX.Crm.EntityEditorClientMode.select),editor:this._editor,loaderConfig:this._primaryLoaderConfig,lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastCompanyInfos",[]),container:this._companyWrapper,placeholder:this.getMessage("companySearchPlaceholder"),parentField:this,clientEditorEnabled:this._schemeElement.getData().hasOwnProperty("clientEditorFieldsParams"),clientEditorFields:this.getClientVisibleFieldsList(BX.CrmEntityType.names.company),clientEditorFieldsParams:this.getClientEditorFieldsParams(BX.CrmEntityType.names.company),requisiteBinding:this._model.getField("REQUISITE_BINDING",{}),isRequired:this.isRequired()||this.isRequiredByAttribute(),enableMyCompanyOnly:this._schemeElement.getDataBooleanParam("enableMyCompanyOnly",false),enableRequisiteSelection:this._schemeElement.getDataBooleanParam("enableRequisiteSelection",false)})};BX.Crm.EntityEditorClientLight.prototype.addCompanySearchBox=function(t,e){if(!BX.type.isPlainObject(e)){e={}}this._companySearchBoxes.push(t);var i=BX.prop.getObject(e,"layoutOptions",{});if(this._addCompanyButton){i["anchor"]=this._addCompanyButton}t.layout(i);t.addResetListener(this._companyResetHandler);t.addTitleChangeListener(this._companyNameChangeHandler);t.addChangeListener(this._companyChangeHandler);t.addDeletionListener(this._companyDeletionHandler);t.addMultifieldChangeListener(this._multifieldChangeHandler);var n=this._companySearchBoxes.length>1;for(var r=0,s=this._companySearchBoxes.length;r<s;r++){this._companySearchBoxes[r].enableDeletion(n)}return t};BX.Crm.EntityEditorClientLight.prototype.removeCompanySearchBox=function(t){var e=this.findCompanySearchBoxIndex(t);if(e<0){return}t.removeResetListener(this._companyResetHandler);t.removeTitleChangeListener(this._companyNameChangeHandler);t.removeChangeListener(this._companyChangeHandler);t.removeDeletionListener(this._companyDeletionHandler);t.removeMultifieldChangeListener(this._multifieldChangeHandler);t.clearLayout();this._companySearchBoxes.splice(e,1);var i=this._companySearchBoxes.length>1;for(var n=0,r=this._companySearchBoxes.length;n<r;n++){this._companySearchBoxes[n].enableDeletion(i)}};BX.Crm.EntityEditorClientLight.prototype.findCompanySearchBoxIndex=function(t){for(var e=0,i=this._companySearchBoxes.length;e<i;e++){if(t===this._companySearchBoxes[e]){return e}}return-1};BX.Crm.EntityEditorClientLight.prototype.createContactSearchBox=function(t){var e=BX.prop.get(t,"entityInfo",null);if(e!==null&&!(e instanceof BX.CrmEntityInfo)){e=null}var i=this._editor.canCreateContact();if(i){i=BX.prop.getBoolean(this._schemeElement.getDataObjectParam("creation",{}),BX.CrmEntityType.names.contact.toLowerCase(),true)}var n=this._schemeElement.getDataBooleanParam("enableRequisiteSelection",false)&&this._contactSearchBoxes.length===0&&(!this._companyInfos||this._companyInfos.length()===0);return BX.Crm.EntityEditorClientSearchBox.create(this._id,{entityTypeId:BX.CrmEntityType.enumeration.contact,entityTypeName:BX.CrmEntityType.names.contact,entityInfo:e,enableCreation:i,enableDeletion:BX.prop.getBoolean(t,"enableDeletion",true),enableQuickEdit:this.isQuickEditEnabled(),mode:BX.prop.getInteger(t,"mode",BX.Crm.EntityEditorClientMode.select),editor:this._editor,loaderConfig:this._primaryLoaderConfig,lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastContactInfos",[]),container:this._contactWrapper,placeholder:this.getMessage("contactSearchPlaceholder"),parentField:this,clientEditorEnabled:this._schemeElement.getData().hasOwnProperty("clientEditorFieldsParams"),clientEditorFields:this.getClientVisibleFieldsList(BX.CrmEntityType.names.contact),clientEditorFieldsParams:this.getClientEditorFieldsParams(BX.CrmEntityType.names.contact),requisiteBinding:this._model.getField("REQUISITE_BINDING",{}),isRequired:this.isRequired()||this.isRequiredByAttribute(),enableRequisiteSelection:n})};BX.Crm.EntityEditorClientLight.prototype.addContactSearchBox=function(t,e){if(!BX.type.isPlainObject(e)){e={}}this._contactSearchBoxes.push(t);var i=BX.prop.getObject(e,"layoutOptions",{});if(this._addContactButton){i["anchor"]=this._addContactButton}t.layout(i);t.addResetListener(this._contactResetHandler);t.addTitleChangeListener(this._contactNameChangeHandler);t.addChangeListener(this._contactChangeHandler);t.addDeletionListener(this._contactDeletionHandler);t.addMultifieldChangeListener(this._multifieldChangeHandler);var n=this._contactSearchBoxes.length>1;for(var r=0,s=this._contactSearchBoxes.length;r<s;r++){this._contactSearchBoxes[r].enableDeletion(n)}return t};BX.Crm.EntityEditorClientLight.prototype.removeContactSearchBox=function(t){var e=this.findContactSearchBoxIndex(t);if(e<0){return}var i=e===0&&t._enableRequisiteSelection&&this._contactSearchBoxes[1];t.removeResetListener(this._contactResetHandler);t.removeTitleChangeListener(this._contactNameChangeHandler);t.removeChangeListener(this._contactChangeHandler);t.removeDeletionListener(this._contactDeletionHandler);t.removeMultifieldChangeListener(this._multifieldChangeHandler);t.clearLayout();this._contactSearchBoxes.splice(e,1);var n=this._contactSearchBoxes.length>1;for(var r=0,s=this._contactSearchBoxes.length;r<s;r++){this._contactSearchBoxes[r].enableDeletion(n)}if(i){this.setRequisiteSelectionEnabledOnFirstContactSearchBox(true)}};BX.Crm.EntityEditorClientLight.prototype.removeContactAllSearchBoxes=function(){if(BX.Type.isArray(this._contactSearchBoxes)){for(var t=0,e=this._contactSearchBoxes.length;t<e;t++){var i=this._contactSearchBoxes[t];i.removeResetListener(this._contactResetHandler);i.removeTitleChangeListener(this._contactNameChangeHandler);i.removeChangeListener(this._contactChangeHandler);i.removeDeletionListener(this._contactDeletionHandler);i.removeMultifieldChangeListener(this._multifieldChangeHandler);i.clearLayout()}}this._contactSearchBoxes=[]};BX.Crm.EntityEditorClientLight.prototype.removeCompanyAllSearchBoxes=function(){if(BX.Type.isArray(this._companySearchBoxes)){for(var t=0,e=this._companySearchBoxes.length;t<e;t++){var i=this._companySearchBoxes[t];i.removeResetListener(this._companyResetHandler);i.removeTitleChangeListener(this._companyNameChangeHandler);i.removeChangeListener(this._companyChangeHandler);i.removeDeletionListener(this._companyDeletionHandler);i.removeMultifieldChangeListener(this._multifieldChangeHandler);i.clearLayout()}}this._companySearchBoxes=[]};BX.Crm.EntityEditorClientLight.prototype.removeCompanyAllPanels=function(){if(BX.Type.isArray(this._companyPanels)){for(var t=0,e=this._companyPanels.length;t<e;t++){var i=this._companyPanels[t];i.clearLayout()}}this._companyPanels=[]};BX.Crm.EntityEditorClientLight.prototype.removeContactAllPanels=function(){if(BX.Type.isArray(this._contactPanels)){for(var t=0,e=this._contactPanels.length;t<e;t++){var i=this._contactPanels[t];i.clearLayout()}}this._contactPanels=[]};BX.Crm.EntityEditorClientLight.prototype.findContactSearchBoxIndex=function(t){for(var e=0,i=this._contactSearchBoxes.length;e<i;e++){if(t===this._contactSearchBoxes[e]){return e}}return-1};BX.Crm.EntityEditorClientLight.prototype.save=function(){this._info["COMPANY_DATA"]=this.saveEntityInfos(this._companySearchBoxes,this._companyInfos);this._info["CONTACT_DATA"]=this.saveEntityInfos(this._contactSearchBoxes,this._contactInfos)};BX.Crm.EntityEditorClientLight.prototype.saveEntityInfos=function(t,e){var i,n;if(t!==null){for(i=0,n=t.length;i<n;i++){if(t[i].isNeedToSave()){t[i].save()}}}var r=[];if(e!==null){var s=e.getItems();for(i=0,n=s.length;i<n;i++){r.push(s[i].getSettings())}}return r};BX.Crm.EntityEditorClientLight.prototype.validate=function(t){var e=!this.hasCompanies()&&!this.hasContacts();var i=this.isRequired()||this.isRequiredByAttribute();var n=!i||!e;if(!n){this.addValidationErrorToResult(t);return false}var r=BX.UI.EntityAsyncValidator.create();var s=this.validateSearchBoxes(this._companySearchBoxes,r,t);var o=this.validateSearchBoxes(this._contactSearchBoxes,r,t);if(!s&&!o&&i){this.addValidationErrorToResult(t);return false}return r.validate()};BX.Crm.EntityEditorClientLight.prototype.addValidationErrorToResult=function(t){t.addError(BX.UI.EntityValidationError.create({field:this}));this.showRequiredFieldError(this.getContentWrapper())};BX.Crm.EntityEditorClientLight.prototype.validateSearchBoxes=function(t,e,i){var n=false;var r;if(BX.Type.isArray(t)){for(var s=0,o=t.length;s<o;s++){r=t[s].validate(i);e.addResult(r);if(r!==false){n=true}}}return n};BX.Crm.EntityEditorClientLight.prototype.doClearLayout=function(){this.releaseSearchBoxes(this._contactSearchBoxes);this.releasePanels(this._contactPanels);this.releaseSearchBoxes(this._companySearchBoxes);this.releasePanels(this._companyPanels)};BX.Crm.EntityEditorClientLight.prototype.release=function(){this.releaseSearchBoxes(this._contactSearchBoxes);this.releasePanels(this._contactPanels);this.releaseSearchBoxes(this._companySearchBoxes);this.releasePanels(this._companyPanels)};BX.Crm.EntityEditorClientLight.prototype.releaseSearchBoxes=function(t){if(!BX.Type.isArray(t)){return}for(var e=0,i=t.length;e<i;e++){t[e].release()}};BX.Crm.EntityEditorClientLight.prototype.releasePanels=function(t){if(!BX.Type.isArray(t)){return}for(var e=0,i=t.length;e<i;e++){t[e].release()}};BX.Crm.EntityEditorClientLight.prototype.getClientEditorFieldsParams=function(t){return BX.prop.getObject(this._schemeElement.getDataObjectParam("clientEditorFieldsParams",{}),t,{})};BX.Crm.EntityEditorClientLight.prototype.onContactAddButtonClick=function(t){this.addContactSearchBox(this.createContactSearchBox()).focus()};BX.Crm.EntityEditorClientLight.prototype.onCompanyAddButtonClick=function(t){if(this._enableCompanyMultiplicity){this.addCompanySearchBox(this.createCompanySearchBox()).focus()}};BX.Crm.EntityEditorClientLight.prototype.onCompanyReset=function(t,e){if(e){this.removeCompany(e);this.markAsChanged()}this.setRequisiteSelectionEnabledOnFirstContactSearchBox(true)};BX.Crm.EntityEditorClientLight.prototype.onCompanyNameChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorClientLight.prototype.onCompanyChange=function(t,e,i){var n=false;if(i){this.removeCompany(i);n=true}if(e){this.addCompany(e);n=true}if(!n){return}this.markAsChanged();this.setRequisiteSelectionEnabledOnFirstContactSearchBox(false);if(!this._enableCompanyMultiplicity){if(e.getId()>0){var r=BX.prop.getObject(this._secondaryLoaderConfig,BX.CrmEntityType.names.company,null);if(r){BX.CrmDataLoader.create(this._id,{serviceUrl:r["url"],action:r["action"],params:{PRIMARY_TYPE_NAME:BX.CrmEntityType.names.company,PRIMARY_ID:e.getId(),SECONDARY_TYPE_NAME:BX.CrmEntityType.names.contact,OWNER_TYPE_NAME:this.getOwnerTypeName()}}).load(BX.delegate(this.onContactInfosLoad,this))}}}};BX.Crm.EntityEditorClientLight.prototype.onCompanyDelete=function(t,e){if(e){this._companyInfos.remove(e);this.markAsChanged()}this.removeCompanySearchBox(t)};BX.Crm.EntityEditorClientLight.prototype.onContactChange=function(t,e,i){var n=false;if(i){this.removeContact(i);n=true}if(e){this.addContact(e);n=true}if(n){this.markAsChanged()}};BX.Crm.EntityEditorClientLight.prototype.onContactNameChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorClientLight.prototype.onContactDelete=function(t,e){if(e){this._contactInfos.remove(e);this.markAsChanged()}this.removeContactSearchBox(t)};BX.Crm.EntityEditorClientLight.prototype.onContactReset=function(t,e){if(e){this.removeContact(e);this.markAsChanged()}};BX.Crm.EntityEditorClientLight.prototype.onContactInfosLoad=function(t,e){var i,n;var r=[];var s=BX.type.isArray(e["ENTITY_INFOS"])?e["ENTITY_INFOS"]:[];for(i=0,n=s.length;i<n;i++){r.push(BX.CrmEntityInfo.create(s[i]))}this._contactInfos.removeAll();for(i=0,n=r.length;i<n;i++){this._contactInfos.add(r[i])}this.markAsChanged();this.removeContactAllSearchBoxes();if(r.length>0){for(i=0,n=r.length;i<n;i++){this.addContactSearchBox(this.createContactSearchBox({entityInfo:r[i]}))}}else{this.addContactSearchBox(this.createContactSearchBox())}};BX.Crm.EntityEditorClientLight.prototype.onRequisiteChange=function(t,e){if(this.isInEditMode()){this.markAsChanged()}else{var i;if(this._schemeElement.getDataBooleanParam("enableMyCompanyOnly",false)){i={MC_REQUISITE_ID:BX.prop.getInteger(e,"requisiteId",0),MC_BANK_DETAIL_ID:BX.prop.getInteger(e,"bankDetailId",0),MYCOMPANY_ID:this._model.getNumberField("MYCOMPANY_ID")}}else{i={REQUISITE_ID:BX.prop.getInteger(e,"requisiteId",0),BANK_DETAIL_ID:BX.prop.getInteger(e,"bankDetailId",0)}}this._editor.saveData(i);this._model.setField("REQUISITE_BINDING",null,{enableNotification:false})}};BX.Crm.EntityEditorClientLight.prototype.onRequisiteListChange=function(t,e){var i=this._schemeElement.getDataStringParam("info","");var n=this._model.getInitFieldValue(i,{});var r=BX.prop.getString(e,"entityTypeName","");var s=BX.prop.getInteger(e,"entityId",0);var o=BX.prop.getArray(e,"requisites",[]);var a=r+"_DATA";if(n.hasOwnProperty(a)&&s>0){for(var l=0;l<n[a].length;l++){var d=n[a][l];if(d.id==s){if(!d.hasOwnProperty("advancedInfo")){d.advancedInfo={}}d.advancedInfo.hasEditRequisiteData=true;d.advancedInfo.requisiteData=o;n[a][l]=d;this._model.setInitFieldValue(i,n);break}}}};BX.Crm.EntityEditorClientLight.prototype.onMultifieldChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorClientLight.prototype.prepareEntitySubmitData=function(t){if(!BX.type.isArray(t)){return[]}var e=[];for(var i=0,n=t.length;i<n;i++){var r=t[i].getEntity();if(!r){continue}var s={};var o=t[i].getMode();if(o===BX.Crm.EntityEditorClientMode.select||o===BX.Crm.EntityEditorClientMode.edit&&r.getTitle()!==""){s["id"]=r.getId()}if(o===BX.Crm.EntityEditorClientMode.create||o===BX.Crm.EntityEditorClientMode.edit&&r.getTitle()!==""){s["title"]=r.getTitle();s["multifields"]=r.getMultifields();s["requisites"]=r.getRequisitesForSave()}e.push(s)}return e};BX.Crm.EntityEditorClientLight.prototype.onBeforeSubmit=function(){var t={};if(this.isCompanyEnabled()){t["COMPANY_DATA"]=this.prepareEntitySubmitData(this._companySearchBoxes)}if(this.isContactEnabled()){t["CONTACT_DATA"]=this.prepareEntitySubmitData(this._contactSearchBoxes)}this.createDataElement("data",JSON.stringify(t))};BX.Crm.EntityEditorClientLight.prototype.setRequisiteSelectionEnabledOnFirstContactSearchBox=function(t){if(this._layoutType===BX.Crm.EntityEditorClientLayoutType.companyContact||this._layoutType===BX.Crm.EntityEditorClientLayoutType.contactCompany){for(var e=0;e<this._contactSearchBoxes.length;e++){this._contactSearchBoxes[e].setSelectRequisiteSelectionEnabled(e===0&&t)}}};if(typeof BX.Crm.EntityEditorClientLight.messages==="undefined"){BX.Crm.EntityEditorClientLight.messages={}}BX.Crm.EntityEditorClientLight.create=function(t,e){var i=new BX.Crm.EntityEditorClientLight;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorClient==="undefined"){BX.Crm.EntityEditorClient=function(){BX.Crm.EntityEditorClient.superclass.constructor.apply(this);this._info=null;this._enablePrimaryEntity=true;this._primaryEntityTypeName="";this._primaryEntityInfo=null;this._primaryEntityBindingInfos=null;this._primaryEntityEditor=null;this._secondaryEntityTypeName="";this._secondaryEntityInfos=null;this._secondaryEntityEditor=null;this._dataElements=null;this._map=null;this._bindingTracker=null;this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorClient,BX.Crm.EntityEditorField);BX.Crm.EntityEditorClient.prototype.doInitialize=function(){BX.Crm.EntityEditorClient.superclass.doInitialize.apply(this);this._map=this._schemeElement.getDataObjectParam("map",{});this.initializeFromModel()};BX.Crm.EntityEditorClient.prototype.initializeFromModel=function(){this._info=this._model.getSchemeField(this._schemeElement,"info",{});this._enablePrimaryEntity=this._schemeElement.getDataBooleanParam("enablePrimaryEntity",true);if(this._enablePrimaryEntity){var t=BX.prop.getObject(this._info,"PRIMARY_ENTITY_DATA",null);var e=t?BX.CrmEntityInfo.create(t):null;if(e){this.setPrimaryEntity(e)}else{this.setPrimaryEntityTypeName(this._schemeElement.getDataStringParam("primaryEntityTypeName",BX.CrmEntityType.names.company))}}this.setSecondaryEntityTypeName(this._schemeElement.getDataStringParam("secondaryEntityTypeName",BX.CrmEntityType.names.contact));var i=null;var n=this._schemeElement.getDataStringParam("secondaryEntityInfo","");if(n!==""){i=this._model.getField(n,[])}else{i=BX.prop.getArray(this._info,"SECONDARY_ENTITY_DATA",[])}this._secondaryEntityInfos=BX.Collection.create();this._primaryEntityBindingInfos=BX.Collection.create();var r=e&&e.getTypeName()===BX.CrmEntityType.names.company?e.getId():0;var s,o,a;for(s=0,o=i.length;s<o;s++){a=BX.CrmEntityInfo.create(i[s]);if(a.getId()<=0){continue}if(r>0&&a.checkEntityBinding(BX.CrmEntityType.names.company,r)){this._primaryEntityBindingInfos.add(a)}else{this._secondaryEntityInfos.add(a)}}this._bindingTracker=BX.Crm.EntityBindingTracker.create()};BX.Crm.EntityEditorClient.prototype.hasContentToDisplay=function(){return this._primaryEntityInfo!==null||this._secondaryEntityInfos!==null&&this._secondaryEntityInfos.length()>0};BX.Crm.EntityEditorClient.prototype.getModeSwitchType=function(t){var e=BX.UI.EntityEditorModeSwitchType.common;if(t===BX.UI.EntityEditorMode.edit){e|=BX.UI.EntityEditorModeSwitchType.button|BX.UI.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorClient.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorClient.prototype.getEntityCreateUrl=function(t){return this._editor.getEntityCreateUrl(t)};BX.Crm.EntityEditorClient.prototype.getEntityRequisiteSelectUrl=function(t,e){return this._editor.getEntityRequisiteSelectUrl(t,e)};BX.Crm.EntityEditorClient.prototype.reset=function(){this.initializeFromModel()};BX.Crm.EntityEditorClient.prototype.rollback=function(){if(this.isChanged()){this.initializeFromModel()}};BX.Crm.EntityEditorClient.prototype.doSetMode=function(t){this.rollback()};BX.Crm.EntityEditorClient.prototype.createDataElement=function(t,e){var i=BX.prop.getString(this._map,t,"");if(i===""){return}var n=BX.create("input",{attrs:{name:i,type:"hidden",value:e}});if(!this._dataElements){this._dataElements={}}this._dataElements[t]=n;if(this._wrapper){this._wrapper.appendChild(n)}};BX.Crm.EntityEditorClient.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this._schemeElement.getTitle();if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._dataElements={};if(!this.hasContentToDisplay()&&this.isInViewMode()){this._wrapper.appendChild(this.createTitleNode(e));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-clients-block"}});this._innerWrapper.appendChild(this.createTitleNode(e));if(this.isInEditMode()){if(this._enablePrimaryEntity){this.createDataElement("primaryEntityType",this.getPrimaryEntityTypeName());this.createDataElement("primaryEntityId",this.getPrimaryEntityId());this.createDataElement("unboundSecondaryEntityIds","");this.createDataElement("boundSecondaryEntityIds","")}this.createDataElement("secondaryEntityType",this.getSecondaryEntityTypeName());this.createDataElement("secondaryEntityIds",this.getAllSecondaryEntityIds().join(","))}var i=BX.create("div",{props:{className:this.isInEditMode()?"crm-entity-widget-content-block-clients":""}});this._innerWrapper.appendChild(i);var n=BX.create("div",{});i.appendChild(n);var r=this._schemeElement.getDataObjectParam("loaders",{});var s=BX.prop.getObject(r,"primary",{});var o=BX.prop.getObject(r,"secondary",{});if(this._enablePrimaryEntity){this._primaryEntityEditor=BX.Crm.PrimaryClientEditor.create(this._id+"_PRIMARY",{entityInfo:this._primaryEntityInfo,entityTypeName:this._primaryEntityTypeName,lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastPrimaryEntityInfos",[]),loaderConfig:s,requisiteBinding:this._model.getField("REQUISITE_BINDING",{}),editor:this,mode:this._mode,onChange:BX.delegate(this.onPrimaryEntityChange,this),onDelete:BX.delegate(this.onPrimaryEntityDelete,this),onBindingAdd:BX.delegate(this.onPrimaryEntityBindingAdd,this),onBindingDelete:BX.delegate(this.onPrimaryEntityBindingDelete,this),onBindingRelease:BX.delegate(this.onPrimaryEntityBindingRelease,this),container:i,achor:n});this._primaryEntityEditor.layout()}var a=BX.create("div",{props:{className:"crm-entity-widget-participants-container"}});i.appendChild(a);this._secondaryEntityEditor=BX.Crm.SecondaryClientEditor.create(this._id+"_SECONDARY",{entityInfos:this._secondaryEntityInfos.getItems(),entityTypeName:this._secondaryEntityTypeName,entityLegend:this._schemeElement.getDataStringParam("secondaryEntityLegend",""),lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastSecondaryEntityInfos",[]),primaryLoader:s,secondaryLoader:o,mode:this._mode,onAdd:BX.delegate(this.onSecondaryEntityAdd,this),onDelete:BX.delegate(this.onSecondaryEntityDelete,this),onBeforeAdd:BX.delegate(this.onSecondaryEntityBeforeAdd,this),editor:this,container:a});this._secondaryEntityEditor.layout();if(this._primaryEntityEditor){if(this.isInEditMode()){this._secondaryEntityEditor.setVisible(this._primaryEntityInfo!==null)}else{this._secondaryEntityEditor.setVisible(this._secondaryEntityInfos.length()>0)}}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorClient.prototype.doClearLayout=function(t){if(this._primaryEntityEditor){this._primaryEntityEditor.clearLayout();this._primaryEntityEditor=null}if(this._secondaryEntityEditor){this._secondaryEntityEditor.clearLayout();this._secondaryEntityEditor=null}for(var e in this._dataElements){if(this._dataElements.hasOwnProperty(e)){BX.remove(this._dataElements[e])}}this._dataElements=null;this._innerWrapper=null};BX.Crm.EntityEditorClient.prototype.getOwnerTypeName=function(){return this._editor.getEntityTypeName()};BX.Crm.EntityEditorClient.prototype.getOwnerTypeId=function(){return this._editor.getEntityTypeId()};BX.Crm.EntityEditorClient.prototype.getOwnerId=function(){return this._editor.getEntityId()};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityTypeName=function(){return this._primaryEntityTypeName};BX.Crm.EntityEditorClient.prototype.setPrimaryEntityTypeName=function(t){if(this._primaryEntityTypeName!==t){this._primaryEntityTypeName=t}};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityId=function(){return this._primaryEntityInfo?this._primaryEntityInfo.getId():0};BX.Crm.EntityEditorClient.prototype.getPrimaryEntity=function(){return this._primaryEntityInfo};BX.Crm.EntityEditorClient.prototype.setPrimaryEntity=function(t){if(t instanceof BX.CrmEntityInfo){this._primaryEntityInfo=t;this.setPrimaryEntityTypeName(t.getTypeName())}else{this._primaryEntityInfo=null}this.markAsChanged()};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityBindings=function(){return this._primaryEntityBindingInfos};BX.Crm.EntityEditorClient.prototype.getSecondaryEntityTypeName=function(){return this._secondaryEntityTypeName};BX.Crm.EntityEditorClient.prototype.setSecondaryEntityTypeName=function(t){if(this._secondaryEntityTypeName!==t){this._secondaryEntityTypeName=t}};BX.Crm.EntityEditorClient.prototype.getSecondaryEntities=function(){return this._secondaryEntityInfos.getItems()};BX.Crm.EntityEditorClient.prototype.getSecondaryEntityById=function(t){if(!this._secondaryEntityInfos){return null}return this._secondaryEntityInfos.search((function(e){return e.getId()===t}))};BX.Crm.EntityEditorClient.prototype.removeSecondaryEntity=function(t){if(this._secondaryEntityInfos){this._secondaryEntityInfos.remove(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.addSecondaryEntity=function(t){if(this._secondaryEntityInfos){this._secondaryEntityInfos.add(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityDelete=function(t,e){this.removeSecondaryEntity(e)};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityBeforeAdd=function(t,e,i){if(this._primaryEntityEditor&&this._primaryEntityInfo&&this._primaryEntityInfo.getTypeName()===BX.CrmEntityType.names.company){var n=this._primaryEntityInfo.getId();if(e.checkEntityBinding(BX.CrmEntityType.names.company,n)&&!this._bindingTracker.isUnbound(e)){this._primaryEntityEditor.addBinding(this._primaryEntityEditor.createBinding(e));i["cancel"]=true}}};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityAdd=function(t,e){this.addSecondaryEntity(e)};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityBind=function(t,e){this._secondaryEntityEditor.removeItem(this._secondaryEntityEditor.getItemById(e.getId()));if(this._primaryEntityEditor){this._primaryEntityEditor.addBinding(this._primaryEntityEditor.createBinding(e))}this._bindingTracker.bind(e)};BX.Crm.EntityEditorClient.prototype.getAllSecondaryEntityIds=function(){var t=this.getAllSecondaryEntityInfos();var e=[];for(var i=0,n=t.length;i<n;i++){e.push(t[i].getId())}return e};BX.Crm.EntityEditorClient.prototype.getAllSecondaryEntityInfos=function(){return[].concat(this._primaryEntityBindingInfos.getItems(),this._secondaryEntityInfos.getItems())};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityBindings=function(){return this._primaryEntityBindingInfos.getItems()};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityBindingById=function(t){if(!this._primaryEntityBindingInfos){return null}return this._primaryEntityBindingInfos.search((function(e){return e.getId()===t}))};BX.Crm.EntityEditorClient.prototype.addPrimaryEntityBinding=function(t){if(this._primaryEntityBindingInfos){this._primaryEntityBindingInfos.add(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.removePrimaryEntityBinding=function(t){if(this._primaryEntityBindingInfos){this._primaryEntityBindingInfos.remove(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityBindingAdd=function(t,e){this.addPrimaryEntityBinding(e)};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityBindingDelete=function(t,e){this.removePrimaryEntityBinding(e)};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityBindingRelease=function(t,e){this._bindingTracker.unbind(e);this._secondaryEntityEditor.addItem(this._secondaryEntityEditor.createItem(e))};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityDelete=function(t,e){var i=[].concat(this._primaryEntityBindingInfos.getItems(),this._secondaryEntityInfos.getItems());this._secondaryEntityInfos=BX.Collection.create();this._primaryEntityBindingInfos=BX.Collection.create();var n=null;if(i.length>0){n=i.shift()}this.setPrimaryEntity(n);this._primaryEntityEditor.setEntity(n);this._secondaryEntityEditor.setEntities(i);this._secondaryEntityEditor.setVisible(n!==null)};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityChange=function(t,e){this.setPrimaryEntity(e);if(this._primaryEntityTypeName===BX.CrmEntityType.names.company){this._bindingTracker.reset();this._primaryEntityBindingInfos=BX.Collection.create();this._secondaryEntityInfos=BX.Collection.create();this._secondaryEntityEditor.clearItems();this._secondaryEntityEditor.reloadEntities()}this._secondaryEntityEditor.setVisible(true)};BX.Crm.EntityEditorClient.prototype.save=function(){var t,e,i;var n=this._schemeElement.getDataObjectParam("map",{});if(this._enablePrimaryEntity){this._model.setMappedField(n,"primaryEntityType",this._primaryEntityTypeName);var r=this._primaryEntityInfo?this._primaryEntityInfo.getId():0;this._model.setMappedField(n,"primaryEntityId",r);if(this._primaryEntityInfo){this._info["PRIMARY_ENTITY_DATA"]=this._primaryEntityInfo.getSettings()}else{delete this._info["PRIMARY_ENTITY_DATA"]}if(r>0){var s=this._bindingTracker.getUnboundEntities();var o=[];for(t=0,e=s.length;t<e;t++){o.push(s[t].getId())}if(o.length>0){for(t=0,e=o.length;t<e;t++){i=this.getSecondaryEntityById(o[t]);if(i){i.removeEntityBinding(this._primaryEntityTypeName,r)}}}this._model.setMappedField(n,"unboundSecondaryEntityIds",o.join(","));var a=this._bindingTracker.getBoundEntities();var l=[];for(t=0,e=a.length;t<e;t++){l.push(a[t].getId())}if(l.length>0){for(t=0,e=l.length;t<e;t++){i=this.getPrimaryEntityBindingById(l[t]);if(i){i.addEntityBinding(this._primaryEntityTypeName,r)}}}this._model.setMappedField(n,"boundSecondaryEntityIds",l.join(","));this._bindingTracker.reset()}}this._model.setMappedField(n,"secondaryEntityType",this._secondaryEntityTypeName);var d=this.getAllSecondaryEntityInfos();var p=[];var h=[];for(t=0,e=d.length;t<e;t++){i=d[t];p.push(i.getSettings());h.push(i.getId())}this._model.setMappedField(n,"secondaryEntityIds",h.join(","));this._info["SECONDARY_ENTITY_DATA"]=p};BX.Crm.EntityEditorClient.prototype.onBeforeSubmit=function(){if(!this._dataElements){return}for(var t in this._dataElements){if(!this._dataElements.hasOwnProperty(t)){continue}var e=BX.prop.getString(this._map,t,"");if(e!==""){this._dataElements[t].value=this._model.getField(e,"")}}};BX.Crm.EntityEditorClient.create=function(t,e){var i=new BX.Crm.EntityEditorClient;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorEntity==="undefined"){BX.Crm.EntityEditorEntity=function(){BX.Crm.EntityEditorEntity.superclass.constructor.apply(this);this._entityTypeName="";this._entityInfo=null;this._entitySelectClickHandler=BX.delegate(this.onEntitySelectClick,this);this._entitySelectButton=null;this._entitySelector=null;this._editorWrapper=null;this._entityWrapper=null;this._dataInput=null;this._requisiteIdInput=null;this._bankDetailIdInput=null;this._skeleton=null;this._requisiteFieldNames=null;this._tooltip=null;this._requisiteList=null;this._item=null;this._requisiteEditor=null};BX.extend(BX.Crm.EntityEditorEntity,BX.Crm.EntityEditorField);BX.Crm.EntityEditorEntity.prototype.doInitialize=function(){BX.Crm.EntityEditorEntity.superclass.doInitialize.apply(this);this.initializeFromModel();if(this._schemeElement.getDataBooleanParam("enableMyCompanyOnly",false)){this._requisiteFieldNames=this._schemeElement.getDataObjectParam("requisiteFieldNames",{requisiteId:"MC_REQUISITE_ID",bankDetailId:"MC_BANK_DETAIL_ID"})}};BX.Crm.EntityEditorEntity.prototype.initializeFromModel=function(){var t=this._model.getSchemeField(this._schemeElement,"info",null);if(t){t=BX.CrmEntityInfo.create(t)}this.setEntity(t);this.setEntityTypeName(this._schemeElement.getDataStringParam("entityTypeName",""))};BX.Crm.EntityEditorEntity.prototype.initializeTooltip=function(){if(!this._entityInfo||!this._schemeElement.getDataBooleanParam("enableMyCompanyOnly",false)){return}if(!this._tooltip&&BX.Crm.EntityEditorRequisiteTooltip){this._tooltip=BX.Crm.EntityEditorRequisiteTooltip.create(this.getId()+"_rq",{readonly:true,canChangeDefaultRequisite:!this.isReadOnly()});BX.Event.EventEmitter.subscribe(this._tooltip,"onSetSelectedRequisite",this.onSetSelectedRequisite.bind(this));BX.Event.EventEmitter.subscribe(this._tooltip,"onEditRequisite",this.onEditRequisite.bind(this))}if(this._tooltip){this._requisiteList=BX.Crm.RequisiteList.create(this._entityInfo.getRequisites());this._requisiteEditor=BX.Crm.EntityEditorRequisiteEditor.create(this._id+"_rq_editor",{entityTypeId:this._entityInfo.getTypeId(),entityId:this._entityInfo.getId(),contextId:this._editor.getContextId(),requisiteEditUrl:BX.prop.get(this._editor._settings,"requisiteEditUrl")});this._tooltip.setRequisites(this._requisiteList);this._requisiteEditor.setRequisiteList(this._requisiteList)}};BX.Crm.EntityEditorEntity.prototype.bindTitleMouseEvents=function(){if(this._tooltip&&this._item&&this._item._hasLayout){BX.Event.bind(this._item.getTitleLink(),"mouseenter",this.onTitleMouseEnter.bind(this));BX.Event.bind(this._item.getTitleLink(),"mouseleave",this.onTitleMouseLeave.bind(this))}};BX.Crm.EntityEditorEntity.prototype.onTitleMouseEnter=function(){if(this._tooltip&&this._item){this._tooltip.setBindElement(this._item.getTitleLink(),this._wrapper);this._tooltip.showDebounced()}};BX.Crm.EntityEditorEntity.prototype.onTitleMouseLeave=function(){if(this._tooltip){this._tooltip.closeDebounced();this._tooltip.cancelShowDebounced()}};BX.Crm.EntityEditorEntity.prototype.onEditRequisite=function(t){var e=t.getData();var i=this._requisiteList.getById(e.id);if(i){this._requisiteEditor.open(i,{})}};BX.Crm.EntityEditorEntity.prototype.getSelectedRequisiteAndBankDetailId=function(){var t={requisiteId:0,bankDetailId:0};if(!this._requisiteList){return t}var e=this._requisiteList.getSelected();if(e){t.requisiteId=e.getRequisiteId();var i=e.getBankDetailById(e.getSelectedBankDetailId());if(i){t.bankDetailId=i.id}}return t};BX.Crm.EntityEditorEntity.prototype.onSetSelectedRequisite=function(t){var e=t.getData();var i=BX.prop.getInteger(e,"id",0);var n=BX.prop.getInteger(e,"bankDetailId",0);this._requisiteList.setSelected(i,n);if(this.getOwnerId()>0){this._editor.saveControl(this)}};BX.Crm.EntityEditorEntity.prototype.getOwnerTypeName=function(){return this._editor.getEntityTypeName()};BX.Crm.EntityEditorEntity.prototype.getOwnerTypeId=function(){return this._editor.getEntityTypeId()};BX.Crm.EntityEditorEntity.prototype.getOwnerId=function(){return this._editor.getEntityId()};BX.Crm.EntityEditorEntity.prototype.getEntityTypeName=function(){return this._entityTypeName};BX.Crm.EntityEditorEntity.prototype.setEntityTypeName=function(t){if(this._entityTypeName===t){return}this._entityTypeName=t;if(this._entitySelector){this._entitySelector=null}};BX.Crm.EntityEditorEntity.prototype.setEntity=function(t){if(this._item){if(this._hasLayout){this._item.clearLayout()}this._item=null}if(!(t instanceof BX.CrmEntityInfo)){this._entityInfo=null}else{this._entityInfo=t;this.setEntityTypeName(this._entityInfo.getTypeName());var e=this._entityInfo.getTypeId()===BX.CrmEntityType.enumeration.contact||this._entityInfo.getTypeId()===BX.CrmEntityType.enumeration.company;this._item=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+this._entityInfo.getId().toString(),{editor:this,entityInfo:this._entityInfo,enableEntityTypeCaption:false,enableRequisite:true,mode:this._mode,onDelete:BX.delegate(this.onItemDelete,this),enableCommunications:e});this.initializeTooltip();if(this._hasLayout){this._item.setContainer(this._entityWrapper);this._item.layout();this.bindTitleMouseEvents()}}};BX.Crm.EntityEditorEntity.prototype.showSkeleton=function(){if(this._item){this._item.clearLayout()}if(!this._skeleton){this._skeleton=BX.Crm.ClientEditorEntitySkeleton.create(this._id,{container:this._entityWrapper})}this._skeleton.layout()};BX.Crm.EntityEditorEntity.prototype.hideSkeleton=function(){if(this._skeleton){this._skeleton.clearLayout()}if(this._item){this._item.setContainer(this._entityWrapper);this._item.layout()}};BX.Crm.EntityEditorEntity.prototype.onItemDelete=function(t){this.setEntity(null);this.markAsChanged()};BX.Crm.EntityEditorEntity.prototype.reset=function(){this.initializeFromModel()};BX.Crm.EntityEditorEntity.prototype.rollback=function(){if(this.isChanged()){this.initializeFromModel()}};BX.Crm.EntityEditorEntity.prototype.getContentWrapper=function(){return this._entityWrapper};BX.Crm.EntityEditorEntity.prototype.getModeSwitchType=function(t){var e=BX.UI.EntityEditorModeSwitchType.common;if(t===BX.UI.EntityEditorMode.edit){e|=BX.UI.EntityEditorModeSwitchType.button|BX.UI.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorEntity.prototype.doSetMode=function(t){this.rollback();if(this._item){this._item.setMode(t)}};BX.Crm.EntityEditorEntity.prototype.layout=function(t){if(this._hasLayout){return}this.prepareLayout();var e=this._mode===BX.UI.EntityEditorMode.view;if(!e){this._entitySelectButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-select"},text:this.getMessage("select"),events:{click:this._entitySelectClickHandler}});var i=BX.create("div",{props:{className:"crm-entity-widget-clients-actions-block"},children:[this._entitySelectButton]});this._entityWrapper.appendChild(i);this.appendInputs()}this.layoutItem();if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorEntity.prototype.prepareLayout=function(){if(this._hasLayout){return}if(!this._wrapper){this._wrapper=BX.create("div",{props:{className:"ui-entity-editor-content-block"}})}this.adjustWrapper();if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this._schemeElement.getTitle()));this._editorWrapper=BX.create("div");this._wrapper.appendChild(this._editorWrapper);this._entityWrapper=BX.create("div");this._editorWrapper.appendChild(this._entityWrapper)};BX.Crm.EntityEditorEntity.prototype.appendInputs=function(){if(this._hasLayout||!this._entityWrapper){return}this._dataInput=BX.create("input",{attrs:{name:this.getName(),type:"hidden",value:this.getValue()}});this._entityWrapper.appendChild(this._dataInput);if(this._schemeElement.getDataBooleanParam("enableMyCompanyOnly",false)){this._requisiteIdInput=BX.create("input",{attrs:{name:this._requisiteFieldNames.requisiteId,type:"hidden",value:this._model.getIntegerField(this._requisiteFieldNames.requisiteId,0)}});this._bankDetailIdInput=BX.create("input",{attrs:{name:this._requisiteFieldNames.bankDetailId,type:"hidden",value:this._model.getIntegerField(this._requisiteFieldNames.bankDetailId,0)}});this._entityWrapper.appendChild(this._requisiteIdInput);this._entityWrapper.appendChild(this._bankDetailIdInput)}};BX.Crm.EntityEditorEntity.prototype.layoutItem=function(){var t=this._mode===BX.UI.EntityEditorMode.view;if(this._item){this._item.setContainer(this._entityWrapper);this._item.layout();this.bindTitleMouseEvents()}else if(t){var e=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")});this._entityWrapper.appendChild(e)}};BX.Crm.EntityEditorEntity.prototype.clearLayout=function(t){if(this._item){this._item.clearLayout()}if(!BX.prop.getBoolean(t,"preservePosition",false)){this._wrapper=BX.remove(this._wrapper)}else{BX.removeClass(this._wrapper,"ui-entity-editor-content-block-click-editable");BX.removeClass(this._wrapper,"ui-entity-editor-content-block-click-empty");this._wrapper=BX.cleanNode(this._wrapper);if(this.hasError()){this.clearError()}}this._entityWrapper=null;this._dataInput=null;this._requisiteIdInput=null;this._bankDetailIdInput=null;if(this._entitySelector){if(this._entitySelector.isOpened()){this._entitySelector.close()}this._entitySelector=null}this._hasLayout=false};BX.Crm.EntityEditorEntity.prototype.onEntitySelectClick=function(t){if(this._entitySelector&&this._entitySelector.isOpened()){this._entitySelector.close();return}if(!this._entitySelector){this._entitySelector=this.createEntitySelector()}this._entitySelector.open()};BX.Crm.EntityEditorEntity.prototype.createEntitySelector=function(){var t=this._entityTypeName;var e=this._schemeElement.getDataIntegerParam("parentEntityTypeId",null);if(e&&BX.CrmEntityType.isDynamicTypeByTypeId(e)){t="DYNAMIC"}return BX.Crm.EntitySelector.create(this._id,{target:this._entitySelectButton,entityTypeName:t,loader:this._schemeElement.getDataObjectParam("loader",null),onSelectCallback:BX.delegate(this.onEntitySelect,this),onBeforeEntityLoadCallback:BX.delegate(this.showSkeleton,this),onAfterEntityLoadCallback:BX.delegate(this.hideSkeleton,this),enableMyCompanyOnly:this._schemeElement.getDataBooleanParam("enableMyCompanyOnly",false),withRequisites:this._schemeElement.getDataBooleanParam("withRequisites",false),enableSearch:this._schemeElement.getDataBooleanParam("enableSearch",true),context:this._schemeElement.getDataStringParam("context",null),parentEntityTypeId:e})};BX.Crm.EntityEditorEntity.prototype.onEntitySelect=function(t){if(this._entitySelector){this._entitySelector.close()}if(this._entityInfo&&this._entityInfo.getId()===t.getId()){return}this.setEntity(t);this.markAsChanged()};BX.Crm.EntityEditorEntity.prototype.save=function(){this._model.setField(this.getName(),this._entityInfo?this._entityInfo.getId():0);if(this._requisiteList){var t=this.getSelectedRequisiteAndBankDetailId();this._model.setField(this._requisiteFieldNames.requisiteId,t.requisiteId);this._model.setField(this._requisiteFieldNames.bankDetailId,t.bankDetailId)}};BX.Crm.EntityEditorEntity.prototype.onBeforeSubmit=function(){if(this._dataInput){this._dataInput.value=this._model.getField(this.getName(),"")}if(this._requisiteList){if(this._requisiteIdInput){this._requisiteIdInput.value=this._model.getField(this._requisiteFieldNames.requisiteId,"")}if(this._bankDetailIdInput){this._bankDetailIdInput.value=this._model.getField(this._requisiteFieldNames.bankDetailId,"")}}};BX.Crm.EntityEditorEntity.prototype.prepareSaveData=function(t){BX.Crm.EntityEditorEntity.superclass.prepareSaveData.call(this,t);if(this._requisiteList){t[this._requisiteFieldNames.requisiteId]=this._model.getField(this._requisiteFieldNames.requisiteId,"");t[this._requisiteFieldNames.bankDetailId]=this._model.getField(this._requisiteFieldNames.bankDetailId,"")}};BX.Crm.EntityEditorEntity.prototype.getMessage=function(t){var e=BX.prop.getString(BX.Crm.EntityEditorEntity.messages,t,null);if(e){return e}return BX.Crm.EntityEditorEntity.superclass.getMessage.call(this,t)};if(typeof BX.Crm.EntityEditorEntity.messages==="undefined"){BX.Crm.EntityEditorEntity.messages={}}BX.Crm.EntityEditorEntity.create=function(t,e){var i=new BX.Crm.EntityEditorEntity;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorEntityTag==="undefined"){BX.Crm.EntityEditorEntityTag=function(){BX.Crm.EntityEditorEntityTag.superclass.constructor.apply(this);this._selectorNode=null;this._selectorSearchNode=null;this._selectorDialog=null;this._lastSearchQuery=null;this.onItemSelect=this.onItemSelect.bind(this)};BX.extend(BX.Crm.EntityEditorEntityTag,BX.Crm.EntityEditorEntity);BX.Crm.EntityEditorEntityTag.prototype.layout=function(t){if(this._hasLayout){return}var e=this._mode===BX.UI.EntityEditorMode.view;this.prepareLayout();var i="ui-ctl-before ui-icon-border";if(this._entityTypeName.toLowerCase().indexOf("dynamic")!==-1){i+=" ui-ctl-icon-crm-dynamic"}else{i+=" ui-ctl-icon-crm-"+this._entityTypeName.toLowerCase()}this._selectorNode=BX.create("div",{attrs:{className:"ui-ctl ui-ctl-before-icon crm-entity-selector-container"},children:[BX.create("div",{attrs:{className:i}})]});this._selectorSearchNode=BX.create("input",{attrs:{type:"text",className:"ui-ctl-element ui-ctl-textbox",value:this._entityInfo?this._entityInfo.getTitle():""},events:{click:function(){this.getSelectorDialog().show()}.bind(this),input:this.onSearchInput.bind(this)}});this._selectorNode.appendChild(this._selectorSearchNode);this.getSelectorDialog().setTargetNode(this._selectorSearchNode);this._editorWrapper.appendChild(this._selectorNode);if(e){BX.hide(this._selectorNode);BX.show(this._entityWrapper)}else{BX.show(this._selectorNode);BX.hide(this._entityWrapper);this.appendInputs()}this.layoutItem();if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorEntityTag.prototype.onSearchInput=function(t){var e=t.target.value;if(e!==this._lastSearchQuery){this._lastSearchQuery=e;if(e.length===0){var i=this.getSelectorDialog().getSelectedItems();if(i[0]){i[0].deselect();this.onItemDelete()}}this.getSelectorDialog().search(e)}};BX.Crm.EntityEditorEntityTag.prototype.clearLayout=function(t){this._selectorDialog=null;BX.Crm.EntityEditorEntityTag.superclass.clearLayout.call(this,t)};BX.Crm.EntityEditorEntityTag.prototype.getModeSwitchType=function(){return BX.UI.EntityEditorModeSwitchType.content};BX.Crm.EntityEditorEntityTag.prototype.getSelectorDialog=function(){if(!this._selectorDialog){var t=this._schemeElement.getDataIntegerParam("parentEntityTypeId",null);var e=BX.CrmEntityType.isDynamicTypeByTypeId(t)?"dynamic":this._entityTypeName.toLowerCase();this._selectorDialog=new BX.UI.EntitySelector.Dialog({context:this._schemeElement.getDataStringParam("context",null),targetNode:this._selectorNode,multiple:false,entities:[{id:e,dynamicLoad:true,dynamicSearch:this._schemeElement.getDataBooleanParam("enableSearch",true),options:{enableMyCompanyOnly:this._schemeElement.getDataBooleanParam("enableMyCompanyOnly",false),withRequisites:this._schemeElement.getDataBooleanParam("withRequisites",false),entityTypeId:this._schemeElement.getDataIntegerParam("parentEntityTypeId",null)}}],id:this._id,events:{"Item:onSelect":this.onItemSelect,"Item:onDeselect":function(t){this.onItemDeselect(t)}.bind(this)},clearSearchOnSelect:true,hideOnSelect:true,hideOnDeselect:true,showAvatars:false,height:200,preselectedItems:[this._entityInfo?[e,this._entityInfo.getId()]:null]})}return this._selectorDialog};BX.Crm.EntityEditorEntityTag.prototype.onItemSelect=function(t){var e;var i=t.getData().item;if(i&&i.customData){e=i.customData.get("entityInfo");if(e){e=BX.CrmEntityInfo.create(e)}}if(e){this.onEntitySelect(e);this._selectorSearchNode.value=e.getTitle()}};BX.Crm.EntityEditorEntityTag.prototype.onItemDeselect=function(t){t.getData().item.getDialog().targetNode.value="";this.onItemDelete({})};BX.Crm.EntityEditorEntityTag.prototype.getMessage=function(t){var e=BX.prop.getString(BX.Crm.EntityEditorEntityTag.messages,t,null);if(e){return e}return BX.Crm.EntityEditorEntityTag.superclass.getMessage.call(this,t)};BX.Crm.EntityEditorEntityTag.prototype.validate=function(t){if(!this.isEditable()){return true}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!(this.isRequired()||this.isRequiredByAttribute())||BX.util.trim(this._selectorSearchNode.value)!=="";if(!e){t.addError(BX.UI.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._selectorDialog)}return e};if(typeof BX.Crm.EntityEditorEntityTag.messages==="undefined"){BX.Crm.EntityEditorEntityTag.messages={}}BX.Crm.EntityEditorEntityTag.create=function(t,e){var i=new BX.Crm.EntityEditorEntityTag;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorDocumentNumber==="undefined"){BX.Crm.EntityEditorDocumentNumber=function(){BX.Crm.EntityEditorDocumentNumber.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorDocumentNumber,BX.Crm.EntityEditorText);BX.Crm.EntityEditorDocumentNumber.prototype.doPrepareContextMenuItems=function(t){BX.Crm.EntityEditorDocumentNumber.superclass.doPrepareContextMenuItems.apply(this,arguments);var e=this._schemeElement.getDataStringParam("numeratorSettingsUrl",null);if(e&&BX.SidePanel&&BX.SidePanel.Instance){t.push({delimiter:true});t.push({value:"openNumeratorSettings",text:this.getMessage("numeratorSettingsContextItem")})}};BX.Crm.EntityEditorDocumentNumber.prototype.processContextMenuCommand=function(t,e){BX.Crm.EntityEditorDocumentNumber.superclass.processContextMenuCommand.apply(this,arguments);if(e==="openNumeratorSettings"){var i=this._schemeElement.getDataStringParam("numeratorSettingsUrl",null);if(i&&BX.SidePanel&&BX.SidePanel.Instance){BX.SidePanel.Instance.open(i,{width:480})}}};BX.Crm.EntityEditorDocumentNumber.prototype.getMessage=function(t){var e=BX.prop.getString(BX.Crm.EntityEditorDocumentNumber.messages,t,null);if(e){return e}return BX.Crm.EntityEditorDocumentNumber.superclass.getMessage.call(this,t)};if(typeof BX.Crm.EntityEditorDocumentNumber.messages==="undefined"){BX.Crm.EntityEditorDocumentNumber.messages={}}BX.Crm.EntityEditorDocumentNumber.create=function(t,e){var i=new BX.Crm.EntityEditorDocumentNumber;i.initialize(t,e);return i}}
//# sourceMappingURL=control.map.js