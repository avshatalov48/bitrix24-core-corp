BX.namespace("BX.Crm");if(typeof BX.Crm.EntityEditorControl==="undefined"){BX.Crm.EntityEditorControl=function(){this._id="";this._settings={};this._editor=null;this._parent=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._modeOptions=BX.Crm.EntityEditorModeOptions.none;this._model=null;this._schemeElement=null;this._container=null;this._wrapper=null;this._dragButton=null;this._dragItem=null;this._hasLayout=false;this._isValidLayout=false;this._isVisible=true;this._isActive=false;this._isChanged=false;this._isSchemeChanged=false;this._changeHandler=BX.delegate(this.onChange,this);this._modeChangeNotifier=null;this._contextMenuButton=null;this._isContextMenuOpened=false;this._draggableContextId=""};BX.Crm.EntityEditorControl.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor",null);this._parent=BX.prop.get(this._settings,"parent",null);this._model=BX.prop.get(this._settings,"model",null);this._schemeElement=BX.prop.get(this._settings,"schemeElement",null);this._container=BX.prop.getElementNode(this._settings,"container",null);var i=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.view);if(i===BX.Crm.EntityEditorMode.edit&&this._schemeElement&&!this._schemeElement.isEditable()){i=BX.Crm.EntityEditorMode.view}this._mode=i;this.doInitialize();this.bindModel()},doInitialize:function(){},bindModel:function(){},unbindModel:function(){},getMessage:function(t){var e=BX.Crm.EntityEditorControl.messages;return e.hasOwnProperty(t)?e[t]:t},getId:function(){return this._id},getEditor:function(){return this._editor},setEditor:function(t){this._editor=t},getParentPosition:function(){var t=this.getParent();return t?t.getPosition():{top:0,right:0,bottom:0,left:0,width:0,height:0}},getParent:function(){return this._parent},setParent:function(t){this._parent=t},getSiblingByIndex:function(t){return this._editor?this._editor.getControlByIndex(t):null},getChildCount:function(){return 0},getChildById:function(t){return null},editChild:function(t){},removeChild:function(t){},getChildren:function(){return[]},editChildConfiguration:function(t){},areAttributesEnabled:function(){return this._schemeElement&&this._schemeElement.areAttributesEnabled()},getType:function(){return this._schemeElement?this._schemeElement.getType():""},getName:function(){return this._schemeElement?this._schemeElement.getName():""},getTitle:function(){if(!this._schemeElement){return""}var t=this._schemeElement.getTitle();if(t===""){t=this._schemeElement.getName()}return t},setTitle:function(t){if(!this._schemeElement){return}this._schemeElement.setTitle(t);this.refreshTitleLayout()},getOptionFlags:function(){return this._schemeElement?this._schemeElement.getOptionFlags():BX.Crm.EntityEditorControlOptions.none},setOptionFlags:function(t){if(this._schemeElement){this._schemeElement.setOptionFlags(t)}},toggleOptionFlag:function(t){var e=this.getOptionFlags();if(BX.Crm.EntityEditorControlOptions.check(e,t)){e&=~t}else{e|=t}this.setOptionFlags(e)},checkOptionFlag:function(t){return BX.Crm.EntityEditorControlOptions.check(this.getOptionFlags(),t)},getData:function(){return this._schemeElement?this._schemeElement.getData():{}},isVisible:function(){if(!this._isVisible){return false}if(this.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){return true}return BX.Crm.EntityEditorVisibilityPolicy.checkVisibility(this)},setVisible:function(t){t=!!t;if(this._isVisible===t){return}this._isVisible=t;if(this._hasLayout){this._wrapper.style.display=this._isVisible?"":"none"}},isActive:function(){return this._isActive},setActive:function(t){t=!!t;if(this._isActive===t){return}this._isActive=t;this.doSetActive()},doSetActive:function(){},isEditable:function(){return this._schemeElement&&this._schemeElement.isEditable()},isRequired:function(){return this._schemeElement&&this._schemeElement.isRequired()},isRequiredConditionally:function(){return this._schemeElement&&this._schemeElement.isRequiredConditionally()},isHeading:function(){return this._schemeElement&&this._schemeElement.isHeading()},getCreationPlaceholder:function(){return this._schemeElement?this._schemeElement.getCreationPlaceholder():""},getChangePlaceholder:function(){return this._schemeElement?this._schemeElement.getChangePlaceholder():""},isReadOnly:function(){return this._editor&&this._editor.isReadOnly()},getVisibilityPolicy:function(){if(this._editor&&!this._editor.isVisibilityPolicyEnabled()){return BX.Crm.EntityEditorVisibilityPolicy.always}return this._schemeElement&&this._schemeElement.getVisibilityPolicy()},getEditPriority:function(){return BX.Crm.EntityEditorPriority.normal},getPosition:function(){return BX.pos(this._wrapper)},focus:function(){},save:function(){},validate:function(t){return true},rollback:function(){},isDragEnabled:function(){if(!this._editor){return false}if(!this._editor.canChangeScheme()){return false}return BX.prop.getBoolean(BX.prop.getObject(this._editor.getDragConfig(this.getDragObjectType()),"modes",{}),BX.Crm.EntityEditorMode.getName(this._mode),false)},isContextMenuEnabled:function(){if(this._editor&&!(this._editor.isFieldsContextMenuEnabled()&&this._editor.canChangeScheme())){return false}return this._schemeElement.isContextMenuEnabled()},getMode:function(){return this._mode},setMode:function(t,e){if(!this.canChangeMode(t)){return}var i=BX.prop.getInteger(e,"options",BX.Crm.EntityEditorModeOptions.none);if(this._mode===t&&this._modeOptions===i){return}this.onBeforeModeChange();this._mode=t;this._modeOptions=i;this.doSetMode(this._mode);this.onAfterModeChange();if(BX.prop.getBoolean(e,"notify",false)){if(this._parent){this._parent.processChildControlModeChange(this)}else if(this._editor){this._editor.processControlModeChange(this)}}this._isSchemeChanged=false;this._isChanged=false;if(this._hasLayout){this._isValidLayout=false}},getModeChangeNotifier:function(){if(!this._modeChangeNotifier){this._modeChangeNotifier=BX.CrmNotifier.create(this)}return this._modeChangeNotifier},onBeforeModeChange:function(){},doSetMode:function(t){},onAfterModeChange:function(){if(this._modeChangeNotifier){this._modeChangeNotifier.notify()}},canChangeMode:function(t){if(t===BX.Crm.EntityEditorMode.edit){return this.isEditable()}return true},isModeToggleEnabled:function(){return this._editor.isModeToggleEnabled()},toggleMode:function(t,e){if(!this.isModeToggleEnabled()){return false}this.setMode(this._mode===BX.Crm.EntityEditorMode.view?BX.Crm.EntityEditorMode.edit:BX.Crm.EntityEditorMode.view,{notify:t});if(BX.prop.getBoolean(e,"refreshLayout",true)){this.refreshLayout()}return true},isEditInViewEnabled:function(){return this._editor&&this._editor.isEditInViewEnabled()&&this.getDataBooleanParam("enableEditInView",false)},isSingleEditEnabled:function(){return this.isModeToggleEnabled()&&this.isEditable()&&!this.getDataBooleanParam("enableEditInView",false)&&this.getDataBooleanParam("enableSingleEdit",true)},isInSingleEditMode:function(){if(!this.isInEditMode()){return false}return this.checkModeOption(BX.Crm.EntityEditorModeOptions.exclusive)||this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)},isInEditMode:function(){return this._mode===BX.Crm.EntityEditorMode.edit},isInViewMode:function(){return this._mode===BX.Crm.EntityEditorMode.view},checkModeOption:function(t){return BX.Crm.EntityEditorModeOptions.check(this._modeOptions,t)},getContextId:function(){return this._editor?this._editor.getContextId():""},getExternalContextId:function(){return this._editor?this._editor.getExternalContextId():""},processAvailableSchemeElementsChange:function(){},processChildControlModeChange:function(t){},processChildControlChange:function(t,e){},isChanged:function(){return this._isChanged},markAsChanged:function(t){if(typeof t==="undefined"){t={}}var e=BX.prop.get(t,"control",null);if(!(e&&e instanceof BX.Crm.EntityEditorControl)){e=t["control"]=this}if(!e.isInEditMode()){return}if(!this._isChanged){this._isChanged=true}this.notifyChanged(t)},isSchemeChanged:function(){return this._isSchemeChanged},markSchemeAsChanged:function(){if(this._isSchemeChanged){return}this._isSchemeChanged=true},saveScheme:function(){if(!this._isSchemeChanged){return}this.commitSchemeChanges();return this._editor.saveScheme()},commitSchemeChanges:function(){if(!this._isSchemeChanged){return}this._editor.updateSchemeElement(this._schemeElement);this._isSchemeChanged=false},getRootContainer:function(){return this._editor?this._editor.getContainer():null},getRootContainerPosition:function(){return BX.pos(this.getRootContainer())},getContainer:function(){return this._container},setContainer:function(t){this._container=t;if(this._hasLayout){this._hasLayout=false}},getWrapper:function(){return this._wrapper},enablePointerEvents:function(t){if(this._wrapper){this._wrapper.style.pointerEvents=t?"":"none"}},getModel:function(){return this._model},getSchemeElement:function(){return this._schemeElement},hasScheme:function(){return!!this._schemeElement},getDataBooleanParam:function(t,e){return this._schemeElement?this._schemeElement.getDataBooleanParam(t,e):e},hasLayout:function(){return this._hasLayout},layout:function(t){},registerLayout:function(t){if(!this._wrapper){return}this._wrapper.setAttribute("data-cid",this.getId());if(this.isInViewMode()&&this._parent&&this._parent.isInEditMode()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-readonly")}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-field-readonly")}if(typeof t==="undefined"){t={}}if(!BX.prop.getBoolean(t,"preservePosision",false)){var e=BX.prop.getElementNode(t,"anchor",null);if(e){BX.addClass(this._wrapper,"crm-entity-widget-content-hide");this._container.insertBefore(this._wrapper,e);setTimeout(BX.delegate(function(){BX.removeClass(this._wrapper,"crm-entity-widget-content-hide");BX.addClass(this._wrapper,"crm-entity-widget-content-show")},this),1);setTimeout(BX.delegate(function(){BX.removeClass(this._wrapper,"crm-entity-widget-content-show")},this),310)}else{this._container.appendChild(this._wrapper)}}this._isValidLayout=true;this.doRegisterLayout()},doRegisterLayout:function(){},refreshLayout:function(t){if(!this._hasLayout){return}this.closeContextMenu();this.clearLayout({preservePosision:true});if(!BX.type.isPlainObject(t)){t={}}if(BX.prop.getBoolean(t,"reset",false)){this.reset()}t["preservePosision"]=true;this.layout(t)},clearLayout:function(t){},refreshTitleLayout:function(){},releaseLayout:function(){this._wrapper=null},release:function(){},reset:function(){},hide:function(){if(this.isRequired()||this.isRequiredConditionally()){return}if(this._parent){BX.addClass(this._wrapper,"crm-entity-widget-content-hide");setTimeout(BX.delegate(function(){this._parent.removeChild(this)},this),350)}else{this.clearLayout()}},showMessageDialog:function(t,e,i){if(this._editor){this._editor.showMessageDialog(t,e,i)}},prepareSaveData:function(t){},onBeforeSubmit:function(){},onHideButtonClick:function(t){this.hide()},onContextButtonClick:function(t){if(!this._isContextMenuOpened){this.openContextMenu()}else{this.closeContextMenu()}},openContextMenu:function(){if(this._isContextMenuOpened){return}var t=this.prepareContextMenuItems();if(BX.type.isArray(t)&&t.length>0){var e=BX.delegate(this.onContextMenuItemSelect,this);for(var i=0,n=t.length;i<n;i++){if(typeof t[i]["onclick"]==="undefined"){t[i]["onclick"]=e}}BX.PopupMenu.show(this._id,this._contextMenuButton,t,{angle:false,events:{onPopupShow:BX.delegate(this.onContextMenuShow,this),onPopupClose:BX.delegate(this.onContextMenuClose,this)}})}},prepareContextMenuItems:function(){return[]},processContextMenuCommand:function(t,e){},closeContextMenu:function(){var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}},onContextMenuShow:function(){this._isContextMenuOpened=true},onContextMenuClose:function(){BX.PopupMenu.destroy(this._id);this._isContextMenuOpened=false},onContextMenuItemSelect:function(t,e){this.processContextMenuCommand(t,BX.prop.getString(e,"value"))},onChange:function(t){this.markAsChanged()},notifyChanged:function(t){if(typeof t==="undefined"){t={}}if(this._parent){this._parent.processChildControlChange(this,t)}else if(this._editor){this._editor.processControlChange(this,t)}},getDragObjectType:function(){return BX.Crm.EditorDragObjectType.intermediate},getChildDragObjectType:function(){return BX.Crm.EditorDragObjectType.intermediate},getDragScope:function(){if(this._parent){return this._parent.getChildDragScope()}if(!this._editor){return BX.Crm.EditorDragScope.getDefault()}return BX.prop.getInteger(this._editor.getDragConfig(this.getDragObjectType()),"scope",BX.Crm.EditorDragScope.getDefault())},getChildDragScope:function(){if(!this._editor){return BX.Crm.EditorDragScope.getDefault()}return BX.prop.getInteger(this._editor.getDragConfig(this.getChildDragObjectType()),"scope",BX.Crm.EditorDragScope.getDefault())},getDraggableContextId:function(){return this._draggableContextId},setDraggableContextId:function(t){this._draggableContextId=t},createDragButton:function(){return this._dragButton},createHideButton:function(){var t=!this.isRequired()&&!this.isRequiredConditionally();var e=BX.create("div",{props:{className:"crm-entity-widget-content-block-hide-btn",title:this.getHideButtonHint(t)}});if(t){BX.bind(e,"click",BX.delegate(this.onHideButtonClick,this))}return e},createContextMenuButton:function(){this._contextMenuButton=BX.create("div",{props:{className:"crm-entity-widget-content-block-context-menu"},events:{click:BX.delegate(this.onContextButtonClick,this)}});return this._contextMenuButton},createGhostNode:function(){return null},getHideButtonHint:function(t){return""},isWaitingForInput:function(){return false}};if(typeof BX.Crm.EntityEditorControl.messages==="undefined"){BX.Crm.EntityEditorControl.messages={}}}if(typeof BX.Crm.EntityEditorField==="undefined"){BX.Crm.EntityEditorField=function(){BX.Crm.EntityEditorField.superclass.constructor.apply(this);this._titleWrapper=null;this._singleEditButton=null;this._singleEditButtonHandler=BX.delegate(this.onSingleEditBtnClick,this);this._singleEditController=null;this._singleEditTimeoutHandle=0;this._viewController=null;this._validators=null;this._hasError=false;this._errorContainer=null;this._layoutAttributes=null;this._spotlight=null;this._dragObjectType=BX.Crm.EditorDragObjectType.field};BX.extend(BX.Crm.EntityEditorField,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorField.prototype.isNewEntity=function(){return this._editor&&this._editor.isNew()};BX.Crm.EntityEditorField.prototype.configure=function(){if(this._parent){this._parent.editChildConfiguration(this)}};BX.Crm.EntityEditorField.prototype.hasAttributeConfiguration=function(t){return this._schemeElement.hasAttributeConfiguration(t)};BX.Crm.EntityEditorField.prototype.getAttributeConfiguration=function(t){return this._schemeElement.getAttributeConfiguration(t)};BX.Crm.EntityEditorField.prototype.setAttributeConfiguration=function(t){return this._schemeElement.setAttributeConfiguration(t)};BX.Crm.EntityEditorField.prototype.removeAttributeConfiguration=function(t){return this._schemeElement.removeAttributeConfiguration(t)};BX.Crm.EntityEditorField.prototype.setVisibilityConfiguration=function(t){return this._schemeElement.setVisibilityConfiguration(t)};BX.Crm.EntityEditorField.prototype.removeVisibilityConfiguration=function(t){return this._schemeElement.removeVisibilityConfiguration(t)};BX.Crm.EntityEditorField.prototype.getDuplicateControlConfig=function(){return this._schemeElement?this._schemeElement.getDataObjectParam("duplicateControl",null):null};BX.Crm.EntityEditorField.prototype.markAsChanged=function(t){BX.Crm.EntityEditorField.superclass.markAsChanged.apply(this,arguments);if(this.hasError()){this.clearError()}var e=this.getValidators();for(var i=0,n=e.length;i<n;i++){e[i].processFieldChange(this)}};BX.Crm.EntityEditorField.prototype.bindModel=function(){this._model.addChangeListener(BX.delegate(this.onModelChange,this));this._model.addLockListener(BX.delegate(this.onModelLock,this))};BX.Crm.EntityEditorField.prototype.onBeforeModeChange=function(){this._layoutAttributes=null;if(this.isInEditMode()){this._layoutAttributes={animate:"show"}}};BX.Crm.EntityEditorField.prototype.onModelChange=function(t,e){this.processModelChange(e)};BX.Crm.EntityEditorField.prototype.onModelLock=function(t,e){this.processModelLock(e)};BX.Crm.EntityEditorField.prototype.processModelChange=function(t){};BX.Crm.EntityEditorField.prototype.processModelLock=function(t){};BX.Crm.EntityEditorField.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorField.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorField.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorField.prototype.hasContentWrapper=function(){return this.getContentWrapper()!==null};BX.Crm.EntityEditorField.prototype.getContentWrapper=function(){return null};BX.Crm.EntityEditorField.prototype.getHideButtonHint=function(t){return this.getMessage(t?"hideButtonHint":"hideButtonDisabledHint")};BX.Crm.EntityEditorField.prototype.getEditButton=function(){return this._singleEditButton};BX.Crm.EntityEditorField.prototype.ensureWrapperCreated=function(t){if(!this._wrapper){this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}})}this.createAdditionalWrapperBlock();var e=BX.prop.getArray(t,"classNames",[]);for(var i=0,n=e.length;i<n;i++){BX.addClass(this._wrapper,e[i])}return this._wrapper};BX.Crm.EntityEditorField.prototype.createAdditionalWrapperBlock=function(){if(!this._wrapper){return}var t=BX.create("div",{props:{className:"crm-entity-widget-before-action"},attrs:{"data-field-tag":this.getId()}});this._wrapper.appendChild(t)};BX.Crm.EntityEditorField.prototype.adjustWrapper=function(){if(!this._wrapper){return}if(this.isInEditMode()&&(this.checkModeOption(BX.Crm.EntityEditorModeOptions.exclusive)||this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual))){BX.addClass(this._wrapper,"crm-entity-widget-content-block-edit")}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-edit")}if(this._layoutAttributes){for(var t in this._layoutAttributes){if(this._layoutAttributes.hasOwnProperty(t)){this._wrapper.setAttribute("data-"+t,this._layoutAttributes[t])}}this._layoutAttributes=null}};BX.Crm.EntityEditorField.prototype.needShowTitle=function(){return this._schemeElement?this._schemeElement.needShowTitle():true};BX.Crm.EntityEditorField.prototype.isVirtual=function(){return this._schemeElement?this._schemeElement.isVirtual():false};BX.Crm.EntityEditorField.prototype.createTitleNode=function(t){this._titleWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-title"}});this.prepareTitleLayout(BX.type.isNotEmptyString(t)?t:this.getTitle());return this._titleWrapper};BX.Crm.EntityEditorField.prototype.prepareTitleLayout=function(t){if(!this._titleWrapper){return}var e=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:t});if(this._mode===BX.Crm.EntityEditorMode.edit){BX.addClass(this._titleWrapper,"crm-entity-widget-content-block-title-edit")}var i=this.createTitleMarker();if(i){e.appendChild(i)}this._titleWrapper.appendChild(e);var n=this.createTitleActionControls();if(n.length>0){var r=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-actions"}});this._titleWrapper.appendChild(r);for(var o=0,s=n.length;o<s;o++){r.appendChild(n[o])}}};BX.Crm.EntityEditorField.prototype.refreshTitleLayout=function(){if(!this._titleWrapper){return}BX.cleanNode(this._titleWrapper);this.prepareTitleLayout(this.getTitle())};BX.Crm.EntityEditorField.prototype.createTitleMarker=function(){if(this._mode===BX.Crm.EntityEditorMode.view){return null}if(this.isRequired()){return BX.create("span",{style:{color:"#f00",verticalAlign:"super"},text:"*"})}else if(this.isRequiredConditionally()){return BX.create("span",{text:"*"})}return null};BX.Crm.EntityEditorField.prototype.createEditButton=function(){if(!(this.isInViewMode()&&this.isSingleEditEnabled())){return null}if(!this._singleEditButton){this._singleEditButton=BX.create("span",{props:{className:"crm-entity-card-widget-title-edit-icon"}})}return this._singleEditButton};BX.Crm.EntityEditorField.prototype.createTitleActionControls=function(){return[]};BX.Crm.EntityEditorField.prototype.createDragButton=function(){if(!this._dragButton){this._dragButton=BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn"}})]})}return this._dragButton};BX.Crm.EntityEditorField.prototype.createGhostNode=function(){if(!this._wrapper){return null}var t=BX.pos(this._wrapper);var e=this._wrapper.cloneNode(true);BX.addClass(e,"crm-entity-widget-content-block-drag");e.style.width=t.width+"px";e.style.height=t.height+"px";return e};BX.Crm.EntityEditorField.prototype.clearLayout=function(t){if(!this._hasLayout){return}this.releaseLightingAbilities();BX.Crm.EntityEditorField.superclass.clearLayout.apply(this,arguments);if(!BX.type.isPlainObject(t)){t={}}this.releaseDragDropAbilities();this.releaseSwitchingAbilities();if(!BX.prop.getBoolean(t,"preservePosision",false)){this._wrapper=BX.remove(this._wrapper)}else{BX.removeClass(this._wrapper,"crm-entity-widget-content-block-click-editable");BX.removeClass(this._wrapper,"crm-entity-widget-content-block-click-empty");this._wrapper=BX.cleanNode(this._wrapper);if(this.hasError()){this.clearError()}}if(this._singleEditButton){this._singleEditButton=null}this.doClearLayout(t);this._hasLayout=false};BX.Crm.EntityEditorField.prototype.doClearLayout=function(t){};BX.Crm.EntityEditorField.prototype.registerLayout=function(t){var e=this.isVisible();var i=this.isNeedToDisplay();this._wrapper.style.display=e&&i?"":"none";this.initializeSwitchingAbilities();if(this.isInEditMode()&&this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)){window.setTimeout(BX.delegate(this.focus,this),0)}BX.Crm.EntityEditorField.superclass.registerLayout.apply(this,arguments);var n=BX.prop.getObject(t,"lighting",null);if(n){window.setTimeout(function(){this.initializeLightingAbilities(n)}.bind(this),1e3)}if(!i&&BX.prop.getBoolean(t,"notifyIfNotDisplayed",false)){BX.UI.Notification.Center.notify({content:this.getMessage("hiddenInViewMode").replace(/#TITLE#/gi,this.getTitle()),position:"top-center",autoHideDelay:5e3})}};BX.Crm.EntityEditorField.prototype.raiseLayoutEvent=function(){BX.onCustomEvent(window,"BX.Crm.EntityEditorField:onLayout",[this])};BX.Crm.EntityEditorField.prototype.hasContentToDisplay=function(){return this.hasValue()};BX.Crm.EntityEditorField.prototype.isNeedToDisplay=function(t){if(this._mode===BX.Crm.EntityEditorMode.edit||this.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){return true}if(this._editor&&BX.prop.getBoolean(t,"enableLayoutResolvers",true)){return BX.prop.getBoolean(this._editor.prepareFieldLayoutOptions(this),"isNeedToDisplay",true)}return this.hasContentToDisplay()};BX.Crm.EntityEditorField.prototype.isWaitingForInput=function(){return this.isInEditMode()&&this.isRequired()&&!this.hasValue()};BX.Crm.EntityEditorField.prototype.hide=function(){if(!(this.isRequired()||this.isRequiredConditionally())){BX.Crm.EntityEditorField.superclass.hide.apply(this,arguments)}else{this.showMessageDialog("operationDenied",this.getMessage("hideDeniedDlgTitle"),this.getMessage("hideDeniedDlgContent"))}};BX.Crm.EntityEditorField.prototype.getEditPriority=function(){var t=this.hasValue();if(!t&&(this.isRequired()||this.isRequiredConditionally())){return BX.Crm.EntityEditorPriority.high}if(!this._editor.isNew()){return BX.Crm.EntityEditorPriority.normal}return t?BX.Crm.EntityEditorPriority.high:this.doGetEditPriority()};BX.Crm.EntityEditorField.prototype.doGetEditPriority=function(){return BX.Crm.EntityEditorPriority.normal};BX.Crm.EntityEditorField.prototype.checkIfNotEmpty=function(t){if(BX.type.isString(t)){return t.trim()!==""}return t!==null&&t!==undefined};BX.Crm.EntityEditorField.prototype.setupFromModel=function(t,e){if(!t){t=this._model}if(!t){return}var i=this.getRelatedModelData(t);this._model.updateData(i,e)};BX.Crm.EntityEditorField.prototype.getRelatedModelData=function(t){if(!t){t=this._model}if(!t){return{}}var e={};var i=this.getRelatedDataKeys();for(var n=0,r=i.length;n<r;n++){var o=i[n];if(o!==""){e[o]=t.getField(o,null)}}return e};BX.Crm.EntityEditorField.prototype.getRelatedDataKeys=function(){return[this.getDataKey()]};BX.Crm.EntityEditorField.prototype.hasValue=function(){return this.checkIfNotEmpty(this.getValue())};BX.Crm.EntityEditorField.prototype.getValue=function(t){if(!this._model){return""}return this._model.getField(this.getDataKey(),t!==undefined?t:"")};BX.Crm.EntityEditorField.prototype.getStringValue=function(t){return this._model?this._model.getStringField(this.getName(),t):""};BX.Crm.EntityEditorField.prototype.getRuntimeValue=function(){return""};BX.Crm.EntityEditorField.prototype.getDataKey=function(){return this.getName()};BX.Crm.EntityEditorField.prototype.prepareSaveData=function(t){t[this.getDataKey()]=this.getValue()};BX.Crm.EntityEditorField.prototype.findValidatorIndex=function(t){if(!this._validators){return-1}for(var e=0,i=this._validators.length;e<i;e++){if(this._validators[e]===t){return e}}return-1};BX.Crm.EntityEditorField.prototype.addValidator=function(t){if(t&&this.findValidatorIndex(t)<0){if(!this._validators){this._validators=[]}this._validators.push(t)}};BX.Crm.EntityEditorField.prototype.removeValidator=function(t){if(!this._validators||!t){return}var e=this.findValidatorIndex(t);if(e>=0){this._validators.splice(e,1)}};BX.Crm.EntityEditorField.prototype.getValidators=function(){return this._validators?this._validators:[]};BX.Crm.EntityEditorField.prototype.hasValidators=function(){return this._validators&&this._validators.length>0};BX.Crm.EntityEditorField.prototype.executeValidators=function(t){if(!this._validators){return true}var e=true;for(var i=0,n=this._validators.length;i<n;i++){if(!this._validators[i].validate(t)){e=false}}return e};BX.Crm.EntityEditorField.prototype.hasError=function(){return this._hasError};BX.Crm.EntityEditorField.prototype.showError=function(t,e){if(!this._errorContainer){this._errorContainer=BX.create("div",{attrs:{className:"crm-entity-widget-content-error-text"}})}this._errorContainer.innerHTML=t;this._wrapper.appendChild(this._errorContainer);BX.addClass(this._wrapper,"crm-entity-widget-content-error");this._hasError=true};BX.Crm.EntityEditorField.prototype.showRequiredFieldError=function(t){this.showError(this.getMessage("requiredFieldError"),t)};BX.Crm.EntityEditorField.prototype.clearError=function(){if(!this._hasError){return}if(this._errorContainer&&this._errorContainer.parentNode){this._errorContainer.parentNode.removeChild(this._errorContainer)}BX.removeClass(this._wrapper,"crm-entity-widget-content-error");this._hasError=false};BX.Crm.EntityEditorField.prototype.scrollAnimate=function(){var t=BX.GetDocElement(document);var e=this._wrapper;window.setTimeout(function(){new BX.easing({duration:300,start:{position:t.scrollTop},finish:{position:BX.pos(e).top-10},step:function(e){t.scrollTop=e.position}}).animate()},0)};BX.Crm.EntityEditorField.prototype.setDragObjectType=function(t){this._dragObjectType=t};BX.Crm.EntityEditorField.prototype.getDragObjectType=function(){return this._dragObjectType};BX.Crm.EntityEditorField.prototype.initializeDragDropAbilities=function(){if(this._dragItem){return}this._dragItem=BX.Crm.EditorDragItemController.create("field_"+this.getId(),{charge:BX.Crm.EditorFieldDragItem.create({control:this,contextId:this._draggableContextId,scope:this.getDragScope()}),node:this.createDragButton(),showControlInDragMode:false,ghostOffset:{x:0,y:0}})};BX.Crm.EntityEditorField.prototype.releaseDragDropAbilities=function(){if(this._dragItem){this._dragItem.release();this._dragItem=null}};BX.Crm.EntityEditorField.prototype.initializeSwitchingAbilities=function(){if(this.isInViewMode()){if(this.isSingleEditEnabled()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-click-editable");if(!this.hasContentToDisplay()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-click-empty")}if(this._singleEditButton){BX.bind(this._singleEditButton,"click",this._singleEditButtonHandler)}}if(this.hasContentWrapper()&&BX.Crm.EntityEditorModeSwitchType.check(this.getModeSwitchType(BX.Crm.EntityEditorMode.edit),BX.Crm.EntityEditorModeSwitchType.content)){this._viewController=BX.Crm.EditorFieldViewController.create(this._id,{field:this,wrapper:this.getContentWrapper()})}}else if(this.checkModeOption(BX.Crm.EntityEditorModeOptions.exclusive)){this._singleEditController=BX.Crm.EditorFieldSingleEditController.create(this._id,{field:this})}};BX.Crm.EntityEditorField.prototype.releaseSwitchingAbilities=function(){if(this._singleEditButton){BX.unbind(this._singleEditButton,"click",this._singleEditButtonHandler)}if(this._viewController){this._viewController.release();this._viewController=null}if(this._singleEditController){this._singleEditController.release();this._singleEditController=null}};BX.Crm.EntityEditorField.prototype.initializeLightingAbilities=function(t){var e=BX.prop.getString(t,"text","");if(!BX.type.isNotEmptyString(e)){return}var i=this.getContentWrapper();if(!i){return}this._spotlight=new BX.SpotLight({id:BX.prop.getString(t,"id",""),targetElement:i,autoSave:true,content:e,targetVertex:"middle-left",zIndex:200});this._spotlight.show();var n=BX.prop.getObject(t,"events",{});for(var r in n){if(n.hasOwnProperty(r)){BX.addCustomEvent(this._spotlight,r,n[r])}}};BX.Crm.EntityEditorField.prototype.releaseLightingAbilities=function(){if(this._spotlight){this._spotlight.close();this._spotlight=null}};BX.Crm.EntityEditorField.prototype.prepareContextMenuItems=function(){var t=[];t.push({value:"hide",text:this.getMessage("hide")});t.push({value:"configure",text:this.getMessage("configure")});if(this._parent&&this._parent.hasAdditionalMenu()){var e=this._parent.getAdditionalMenu();for(var i=0;i<e.length;i++){t.push(e[i])}}t.push({value:"showAlways",text:'<label class="crm-context-menu-item-hide-empty-wrap">'+'<input type="checkbox"'+(this.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)?' checked = "true"':"")+' class="crm-context-menu-item-hide-empty-input">'+'<span class="crm-context-menu-item-hide-empty-text">'+this.getMessage("showAlways")+"</span></label>"});this.doPrepareContextMenuItems(t);return t};BX.Crm.EntityEditorField.prototype.doPrepareContextMenuItems=function(t){};BX.Crm.EntityEditorField.prototype.processContextMenuCommand=function(t,e){if(e==="showAlways"){var i=BX.getEventTarget(t);if(i&&i.tagName==="INPUT"){this.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways);if(this._parent){this._parent.processChildControlSchemeChange(this)}if(!this.isNeedToDisplay()){window.setTimeout(BX.delegate(this.clearLayout,this),500);BX.UI.Notification.Center.notify({content:this.getMessage("isHiddenDueToShowAlwaysChanged").replace(/#TITLE#/gi,this.getTitle()),position:"top-center",autoHideDelay:5e3});this.closeContextMenu()}}return}if(e==="hide"){window.setTimeout(BX.delegate(this.hide,this),500)}else if(e==="configure"){this.configure()}else if(this._parent&&this._parent.hasAdditionalMenu()){this._parent.processChildAdditionalMenuCommand(this,e)}this.closeContextMenu()};BX.Crm.EntityEditorField.prototype.onSingleEditBtnClick=function(t){if(!(this.isSingleEditEnabled()&&this._editor)){return}if(this._singleEditTimeoutHandle>0){window.clearTimeout(this._singleEditTimeoutHandle);this._singleEditTimeoutHandle=0}this._singleEditTimeoutHandle=window.setTimeout(BX.delegate(this.switchToSingleEditMode,this),250);BX.eventCancelBubble(t)};BX.Crm.EntityEditorField.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button}return e};BX.Crm.EntityEditorField.prototype.switchToSingleEditMode=function(t){if(!(this.isSingleEditEnabled()&&this._editor)){return}this._singleEditTimeoutHandle=0;if(this._editor){this._editor.switchControlMode(this,BX.Crm.EntityEditorMode.edit,BX.Crm.EntityEditorModeOptions.individual)}};if(typeof BX.Crm.EntityEditorField.messages==="undefined"){BX.Crm.EntityEditorField.messages={}}}if(typeof BX.Crm.EntityEditorSection==="undefined"){BX.Crm.EntityEditorSection=function(){BX.Crm.EntityEditorSection.superclass.constructor.apply(this);this._fields=null;this._fieldConfigurator=null;this._userFieldConfigurator=null;this._mandatoryConfigurator=null;this._visibilityConfigurator=null;this._titleWrapper=null;this._titleEditButton=null;this._titleEditHandler=BX.delegate(this.onTitleEditButtonClick,this);this._titleView=null;this._titleInput=null;this._titleMode=BX.Crm.EntityEditorMode.intermediate;this._titleInputKeyHandler=BX.delegate(this.onTitleInputKeyPress,this);this._documentClickHandler=BX.delegate(this.onExternalClick,this);this._enableToggling=true;this._toggleButton=null;this._buttonPanelWrapper=null;this._addChildButton=null;this._addChildButtonHandler=BX.delegate(this.onAddChildBtnClick,this);this._createChildButton=null;this._createChildButtonHandler=BX.delegate(this.onCreateUserFieldBtnClick,this);this._deleteButton=null;this._deleteButtonHandler=BX.delegate(this.onDeleteSectionBtnClick,this);this._detetionConfirmDlgId="section_deletion_confirm";this._childSelectMenu=null;this._fieldTypeSelectMenu=null;this._dragContainerController=null;this._dragPlaceHolder=null;this._dropHandler=BX.delegate(this.onDrop,this);this._titleActions=null;this._fieldSelector=null;this._stub=null;this._detailButton=null};BX.extend(BX.Crm.EntityEditorSection,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorSection.prototype.doSetActive=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].setActive(this._isActive)}};BX.Crm.EntityEditorSection.prototype.initialize=function(t,e){BX.Crm.EntityEditorSection.superclass.initialize.call(this,t,e);this._draggableContextId=BX.Crm.EditorFieldDragItem.contextId;if(this.getChildDragScope()===BX.Crm.EditorDragScope.parent){this._draggableContextId+="_"+this.getId()}this.initializeFromModel()};BX.Crm.EntityEditorSection.prototype.initializeFromModel=function(){var t,e;if(this._fields){for(t=0,e=this._fields.length;t<e;t++){this._fields[t].release()}}this._fields=[];var i=this._schemeElement.getElements();for(t=0,e=i.length;t<e;t++){var n=i[t];var r=this._editor.createControl(n.getType(),n.getName(),{schemeElement:n,model:this._model,parent:this});if(!r){continue}n.setParent(this._schemeElement);r.setMode(this._mode,{notify:false});this._fields.push(r)}};BX.Crm.EntityEditorSection.prototype.createDragButton=function(){if(!this._dragButton){this._dragButton=BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn"}})]})}return this._dragButton};BX.Crm.EntityEditorSection.prototype.createGhostNode=function(){if(!this._wrapper){return null}var t=BX.pos(this._wrapper);var e=BX.create("div",{props:{className:"crm-entity-card-widget-edit"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn"},children:[BX.create("div",{props:{className:"crm-entity-card-widget-draggable-btn-inner"}})]})]}),BX.create("div",{props:{className:"crm-entity-card-widget-title"},children:[BX.create("span",{props:{className:"crm-entity-card-widget-title-text"},text:this._schemeElement.getTitle()})]})]});BX.addClass(e,"crm-entity-widget-card-drag");e.style.width=t.width+"px";return e};BX.Crm.EntityEditorSection.prototype.getEditPriority=function(){for(var t=0,e=this._fields.length;t<e;t++){if(this._fields[t].getEditPriority()===BX.Crm.EntityEditorPriority.high){return BX.Crm.EntityEditorPriority.high}}return BX.Crm.EntityEditorPriority.normal};BX.Crm.EntityEditorSection.prototype.layout=function(t){var e,i;var n=this._schemeElement.getTitle();this._contentContainer=BX.create("div",{props:{className:"crm-entity-widget-content"}});var r=this._mode===BX.Crm.EntityEditorMode.view;var o=r?"crm-entity-card-widget":"crm-entity-card-widget-edit";this._enableToggling=this.isModeToggleEnabled()&&this._schemeElement.getDataBooleanParam("enableToggling",true);this._toggleButton=BX.create("span",{attrs:{className:"crm-entity-widget-hide-btn"},events:{click:BX.delegate(this.onToggleBtnClick,this)},text:this.getMessage(r?"change":"cancel")});var s=BX.prop.getString(this.getEditor()._settings,"entityDetailsUrl","");if(this.getEditor().isEmbedded()&&s.length){var a=this.getEditor().getControls().filter(function(t){return t instanceof BX.Crm.EntityEditorSection});if(a.length&&a[0]===this){this._detailButton=BX.create("a",{attrs:{className:"crm-entity-widget-detail-btn",href:s},text:this.getMessage("openDetails")})}}if(!this._enableToggling){this._toggleButton.style.display="none"}this._titleMode=BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:o}});if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._schemeElement.isTitleEnabled()){this._titleEditButton=BX.create("span",{props:{className:"crm-entity-card-widget-title-edit-icon"},events:{click:this._titleEditHandler}});if(!this._editor.isSectionEditEnabled()||!this._editor.canChangeScheme()){this._titleEditButton.style.display="none"}this._titleView=BX.create("span",{props:{className:"crm-entity-card-widget-title-text"},text:n});this._titleInput=BX.create("input",{props:{className:"crm-entity-card-widget-title-text"},style:{display:"none"}});this._titleActions=BX.create("div",{props:{className:"crm-entity-widget-actions-block"},children:[this._toggleButton]});if(this._detailButton){this._titleActions.appendChild(this._detailButton)}this._titleWrapper=BX.create("div",{props:{className:"crm-entity-card-widget-title"},children:[BX.create("div",{style:{maxWidth:"calc(100% - 30px)",minWidth:0,flex:1},children:[this._titleView,this._titleInput,this._titleEditButton]}),this._titleActions]});this._wrapper.appendChild(this._titleWrapper)}this._wrapper.appendChild(this._contentContainer);if(!BX.type.isPlainObject(t)){t={}}var l=BX.prop.getElementNode(t,"anchor",null);if(l){this._container.insertBefore(this._wrapper,l)}else{this._container.appendChild(this._wrapper)}if(r&&this._fields.length===0){this._contentContainer.appendChild(this.createStub())}var d=BX.prop.getBoolean(t,"reset",false);var h=BX.prop.get(t,"userFieldLoader",null);if(!h){h=BX.Crm.EntityUserFieldLayoutLoader.create(this._id,{mode:this._mode,enableBatchMode:true,owner:this})}var p=BX.prop.getObject(t,"lighting",null);var u=BX.prop.getBoolean(t,"enableFocusGain",true);var c=false;for(e=0,i=this._fields.length;e<i;e++){var m=this._fields[e];m.setContainer(this._contentContainer);m.setDraggableContextId(this._draggableContextId);m.releaseLayout();if(d){m.reset()}var y={userFieldLoader:h};if(!c&&p&&m.isVisible()&&m.isNeedToDisplay()){y["lighting"]=p;c=true}m.layout(y);if(u&&!r&&m.isHeading()){m.focus()}}if(h.getOwner()===this){h.runBatch()}this._addChildButton=this._createChildButton=this._deleteButton=null;if(this._editor.canChangeScheme()&&this._schemeElement.getDataBooleanParam("showButtonPanel",true)){this._buttonPanelWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});if(this._schemeElement.getDataBooleanParam("isChangeable",true)){this._addChildButton=BX.create("span",{props:{className:"crm-entity-widget-content-block-edit-action-btn"},text:this.getMessage("selectField"),events:{click:this._addChildButtonHandler}});if(!this._editor.hasAvailableSchemeElements()){this._addChildButton.style.display="none"}this._buttonPanelWrapper.appendChild(this._addChildButton);if(this._editor.getUserFieldManager().isCreationEnabled()){this._createChildButton=BX.create("span",{props:{className:"crm-entity-widget-content-block-edit-action-btn"},text:this.getMessage("createField"),events:{click:this._createChildButtonHandler}});this._buttonPanelWrapper.appendChild(this._createChildButton)}}if(this._schemeElement.getDataBooleanParam("isRemovable",true)){var E="crm-entity-widget-content-block-edit-remove-btn";if(this.isRequired()||this.isRequiredConditionally()){E="crm-entity-widget-content-block-edit-remove-btn-disabled"}this._deleteButton=BX.create("span",{props:{className:E},text:this.getMessage("deleteSection")});this._buttonPanelWrapper.appendChild(this._deleteButton);BX.bind(this._deleteButton,"click",this._deleteButtonHandler)}this._contentContainer.appendChild(this._buttonPanelWrapper)}if(this.isDragEnabled()){this._dragContainerController=BX.Crm.EditorDragContainerController.create("section_"+this.getId(),{charge:BX.Crm.EditorFieldDragContainer.create({section:this,context:this._draggableContextId}),node:this._wrapper});this._dragContainerController.addDragFinishListener(this._dropHandler);this.initializeDragDropAbilities()}var g=this._editor._controls.indexOf(this);var _={id:this._id,customNodes:[],serialNumber:g};BX.onCustomEvent(window,"BX.Crm.EntityEditorSection:onLayout",[this,_]);if(this._titleActions&&BX.type.isArray(_["customNodes"])){for(e=0,i=_["customNodes"].length;e<i;e++){var f=_["customNodes"][e];if(BX.type.isElementNode(f)){this._titleActions.appendChild(f)}}}this._hasLayout=true};BX.Crm.EntityEditorSection.prototype.clearLayout=function(t){if(!this._hasLayout){return}if(this._dragContainerController){this._dragContainerController.removeDragFinishListener(this._dropHandler);this._dragContainerController.release();this._dragContainerController=null}this.releaseDragDropAbilities();for(var e=0,i=this._fields.length;e<i;e++){var n=this._fields[e];n.clearLayout(t);n.setContainer(null);n.setDraggableContextId("")}if(this._addChildButton){BX.unbind(this._addChildButton,"click",this._addChildButtonHandler);this._addChildButton=BX.remove(this._addChildButton)}if(this._createChildButton){BX.unbind(this._createChildButton,"click",this._createChildButtonHandler);this._createChildButton=BX.remove(this._createChildButton)}if(this._deleteButton){BX.unbind(this._deleteButton,"click",this._deleteButtonHandler);this._deleteButton=BX.remove(this._deleteButton)}if(this._buttonPanelWrapper){this._buttonPanelWrapper=BX.remove(this._buttonPanelWrapper)}this._stub=null;this._titleWrapper=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false};BX.Crm.EntityEditorSection.prototype.refreshLayout=function(t){t=BX.type.isPlainObject(t)?BX.mergeEx({},t):{};var e=BX.prop.getFunction(t,"callback",null);delete t["callback"];delete t["anchor"];if(this._wrapper&&this._wrapper.nextSibling){t["anchor"]=this._wrapper.nextSibling}this.clearLayout();this.layout(t);if(e){e()}};BX.Crm.EntityEditorSection.prototype.createStub=function(){this._stub=BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-nothing-selected"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-nothing-selected-text"},text:this.getMessage("nothingSelected")})]})]});if(this.isModeToggleEnabled()){BX.bind(this._stub,"click",BX.delegate(this.onStubClick,this))}return this._stub};BX.Crm.EntityEditorSection.prototype.onStubClick=function(t){this.toggle()};BX.Crm.EntityEditorSection.prototype.hasAdditionalMenu=function(t){return false};BX.Crm.EntityEditorSection.prototype.getAdditionalMenu=function(t){return[]};BX.Crm.EntityEditorSection.prototype.processChildAdditionalMenuCommand=function(t,e){};BX.Crm.EntityEditorSection.prototype.ensureButtonPanelWrapperCreated=function(){if(!this._hasLayout){throw"EntityEditorSection: Control does not have layout."}if(!this._buttonPanelWrapper){this._buttonPanelWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});this._contentContainer.appendChild(this._buttonPanelWrapper)}return this._buttonPanelWrapper};BX.Crm.EntityEditorSection.prototype.setTitleMode=function(t){if(this._titleMode===t){return}this._titleMode=t;if(!this._schemeElement.isTitleEnabled()){return}if(this._titleMode===BX.Crm.EntityEditorMode.view){this._titleView.style.display="";this._titleInput.style.display="none";this._titleEditButton.style.display="";var e=this._titleInput.value;this._titleView.innerHTML=BX.util.htmlspecialchars(e);this._schemeElement.setTitle(e);this.markSchemeAsChanged();this.saveScheme();BX.unbind(this._titleInput,"keyup",this._titleInputKeyHandler);BX.unbind(window.document,"click",this._documentClickHandler)}else{this._titleView.style.display="none";this._titleInput.style.display="";this._titleEditButton.style.display="none";this._titleInput.value=this._schemeElement.getTitle();BX.bind(this._titleInput,"keyup",this._titleInputKeyHandler);this._titleInput.focus();window.setTimeout(BX.delegate(function(){BX.bind(window.document,"click",this._documentClickHandler)},this),100)}};BX.Crm.EntityEditorSection.prototype.toggleTitleMode=function(){this.setTitleMode(this._titleMode===BX.Crm.EntityEditorMode.view?BX.Crm.EntityEditorMode.edit:BX.Crm.EntityEditorMode.view)};BX.Crm.EntityEditorSection.prototype.onTitleEditButtonClick=function(t){if(this._editor.isSectionEditEnabled()){this.toggleTitleMode()}};BX.Crm.EntityEditorSection.prototype.onTitleInputKeyPress=function(t){if(!t){t=window.event}if(t.keyCode===13){this.toggleTitleMode()}};BX.Crm.EntityEditorSection.prototype.onExternalClick=function(t){if(!t){t=window.event}if(this._titleInput!==BX.getEventTarget(t)){this.toggleTitleMode()}};BX.Crm.EntityEditorSection.prototype.enableToggling=function(t){t=!!t;if(this._enableToggling===t){return}this._enableToggling=t;if(this._hasLayout){this._toggleButton.style.display=this._enableToggling?"":"none"}};BX.Crm.EntityEditorSection.prototype.toggle=function(){if(this._enableToggling&&this._editor){var t=this._mode===BX.Crm.EntityEditorMode.view;if(t){this.releaseActiveControls()}this._editor.switchControlMode(this,t?BX.Crm.EntityEditorMode.edit:BX.Crm.EntityEditorMode.view)}};BX.Crm.EntityEditorSection.prototype.releaseActiveControls=function(){for(var t=0,e=this._fields.length;t<e;t++){var i=this._fields[t];this._editor.unregisterActiveControl(i)}};BX.Crm.EntityEditorSection.prototype.onToggleBtnClick=function(t){this.toggle()};BX.Crm.EntityEditorSection.prototype.onBeforeModeChange=function(){this.removeFieldConfigurator();this.removeUserFieldConfigurator()};BX.Crm.EntityEditorSection.prototype.doSetMode=function(t){if(this._titleMode===BX.Crm.EntityEditorMode.edit){this.toggleTitleMode()}for(var e=0,i=this._fields.length;e<i;e++){this._fields[e].setMode(t,{notify:false})}};BX.Crm.EntityEditorSection.prototype.processAvailableSchemeElementsChange=function(){if(this._hasLayout&&BX.type.isDomNode(this._addChildButton)){this._addChildButton.style.display=this._editor.hasAvailableSchemeElements()?"":"none"}};BX.Crm.EntityEditorSection.prototype.validate=function(t){if(this._mode!==BX.Crm.EntityEditorMode.edit){return true}var e=BX.Crm.EntityAsyncValidator.create();for(var i=0,n=this._fields.length;i<n;i++){var r=this._fields[i];if(r.getMode()!==BX.Crm.EntityEditorMode.edit){continue}e.addResult(r.validate(t))}return e.validate()};BX.Crm.EntityEditorSection.prototype.commitSchemeChanges=function(){if(this._isSchemeChanged){var t=[];for(var e=0,i=this._fields.length;e<i;e++){var n=this._fields[e].getSchemeElement();if(n){t.push(n)}}this._schemeElement.setElements(t)}return BX.Crm.EntityEditorSection.superclass.commitSchemeChanges.call(this)};BX.Crm.EntityEditorSection.prototype.save=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].save()}};BX.Crm.EntityEditorSection.prototype.rollback=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].rollback()}if(this._isChanged){this.initializeFromModel();this._isChanged=false}};BX.Crm.EntityEditorSection.prototype.onBeforeSubmit=function(){for(var t=0,e=this._fields.length;t<e;t++){this._fields[t].onBeforeSubmit()}};BX.Crm.EntityEditorSection.prototype.getChildIndex=function(t){for(var e=0,i=this._fields.length;e<i;e++){if(this._fields[e]===t){return e}}return-1};BX.Crm.EntityEditorSection.prototype.addChild=function(t,e){if(!BX.type.isPlainObject(e)){e={}}var i=null;var n=BX.prop.getInteger(e,"index",-1);if(n>=0){this._fields.splice(n,0,t);if(n<this._fields.length-1){i=this._fields[n+1]}}else{this._fields.push(t);i=BX.prop.get(e,"related",null)}if(t.getParent()!==this){t.setParent(this)}if(t.hasScheme()){t.getSchemeElement().setParent(this._schemeElement)}t.setActive(this._isActive);if(this._hasLayout){t.setContainer(this._contentContainer);t.setDraggableContextId(this._draggableContextId);var r=BX.prop.getObject(e,"layout",{});if(i){r["anchor"]=i.getWrapper()}else{r["anchor"]=this._buttonPanelWrapper}if(BX.prop.getBoolean(r,"forceDisplay",false)&&!t.isNeedToDisplay()&&!t.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){t.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}t.layout(r)}if(t.hasScheme()){this._editor.processControlAdd(t);this.markSchemeAsChanged();if(BX.prop.getBoolean(e,"enableSaving",true)){this.saveScheme()}}};BX.Crm.EntityEditorSection.prototype.removeChild=function(t,e){if(!BX.type.isPlainObject(e)){e={}}var i=this.getChildIndex(t);if(i<0){return}if(t.isActive()){t.setActive(false)}this._fields.splice(i,1);var n=t.hasScheme();if(n){t.getSchemeElement().setParent(null)}if(this._hasLayout){t.clearLayout();t.setContainer(null);t.setDraggableContextId("")}if(n){this._editor.processControlRemove(t);this.markSchemeAsChanged();if(BX.prop.getBoolean(e,"enableSaving",true)){this.saveScheme()}}};BX.Crm.EntityEditorSection.prototype.moveChild=function(t,e,i){if(!BX.type.isPlainObject(i)){i={}}var n=this.getChildCount();var r=n-1;if(e<0||e>n){e=r}var o=this.getChildIndex(t);if(o<0||o===e){return false}if(this._hasLayout){t.clearLayout()}this._fields.splice(o,1);n--;var s=null;if(this._hasLayout){s=e<n?this._fields[e].getWrapper():this._buttonPanelWrapper}if(e<n){this._fields.splice(e,0,t)}else{this._fields.push(t)}if(this._hasLayout){if(s){t.layout({anchor:s})}else{t.layout()}}this._editor.processControlMove(t);this.markSchemeAsChanged();if(BX.prop.getBoolean(i,"enableSaving",true)){this.saveScheme()}return true};BX.Crm.EntityEditorSection.prototype.editChild=function(t){if(this._mode===BX.Crm.EntityEditorMode.edit){t.focus()}else if(!this.isReadOnly()){var e=true;for(var i=0,n=this._fields.length;i<n;i++){if(this._fields[i].getMode()!==this._mode){e=false;break}}if(e){this.setMode(BX.Crm.EntityEditorMode.edit,{notify:true});this.refreshLayout({callback:function(){t.focus()}})}}};BX.Crm.EntityEditorSection.prototype.getChildById=function(t){for(var e=0,i=this._fields.length;e<i;e++){var n=this._fields[e];if(n.getId()===t){return n}}return null};BX.Crm.EntityEditorSection.prototype.getChildCount=function(){return this._fields.length};BX.Crm.EntityEditorSection.prototype.getChildren=function(){return this._fields};BX.Crm.EntityEditorSection.prototype.processChildControlModeChange=function(t){if(!this.isActive()&&this._editor){this._editor.processControlModeChange(t)}};BX.Crm.EntityEditorSection.prototype.processChildControlChange=function(t,e){if(!t.isInEditMode()){return}if(typeof e==="undefined"){e={}}if(!BX.prop.get(e,"control",null)){e["control"]=t}this.markAsChanged(e);this.enableToggling(false)};BX.Crm.EntityEditorSection.prototype.processChildControlSchemeChange=function(t){this.markSchemeAsChanged();this.saveScheme()};BX.Crm.EntityEditorSection.prototype.openAddChildMenu=function(){var t=this._editor.getAvailableSchemeElements();var e=t.length;if(e===0){return}var i=[];for(var n=0;n<e;n++){var r=t[n];i.push({text:r.getTitle(),value:r.getName()})}i.push({delimiter:true});i.push({text:this.getMessage("selectFieldFromOtherSection"),value:"ACTION.TRANSFER"});var o={id:this._id,menuItems:i,button:this._addChildButton,cancel:false};BX.onCustomEvent(window,"BX.Crm.EntityEditorSection:onOpenChildMenu",[this,o]);if(o["cancel"]){return}if(this._childSelectMenu){this._childSelectMenu.setupItems(i)}else{this._childSelectMenu=BX.CmrSelectorMenu.create(this._id,{items:i});this._childSelectMenu.addOnSelectListener(BX.delegate(this.onChildSelect,this))}this._childSelectMenu.open(this._addChildButton)};BX.Crm.EntityEditorSection.prototype.onAddChildBtnClick=function(t){this.openAddChildMenu()};BX.Crm.EntityEditorSection.prototype.openTransferDialog=function(){if(!this._fieldSelector){this._fieldSelector=BX.Crm.EntityEditorFieldSelector.create(this._id,{scheme:this._editor.getScheme(),excludedNames:[this.getSchemeElement().getName()],title:this.getMessage("transferDialogTitle")});this._fieldSelector.addClosingListener(BX.delegate(this.onTransferFieldSelect,this))}this._fieldSelector.open()};BX.Crm.EntityEditorSection.prototype.onTransferFieldSelect=function(t,e){if(BX.prop.getBoolean(e,"isCanceled")){return}var i=BX.prop.getArray(e,"items");if(i.length===0){return}for(var n=0,r=i.length;n<r;n++){var o=i[n];var s=BX.prop.getString(o,"sectionName","");var a=BX.prop.getString(o,"fieldName","");var l=this._editor.getControlById(s);if(!l){continue}var d=l.getChildById(a);if(!d){continue}var h=d.getSchemeElement();l.removeChild(d,{enableSaving:false});var p=this._editor.createControl(h.getType(),h.getName(),{schemeElement:h,model:this._model,parent:this,mode:this._mode});this.addChild(p,{layout:{forceDisplay:true},enableSaving:false})}this._editor.saveSchemeChanges()};BX.Crm.EntityEditorSection.prototype.onChildSelect=function(t,e){var i={id:this._id,item:e,button:this._addChildButton,cancel:false};BX.onCustomEvent(window,"BX.Crm.EntityEditorSection:onChildMenuItemSelect",[this,i]);if(i["cancel"]){return}var n=e.getValue();if(n==="ACTION.TRANSFER"){this.openTransferDialog();return}var r=this._editor.getAvailableSchemeElementByName(n);if(!r){return}var o=this._editor.createControl(r.getType(),r.getName(),{schemeElement:r,model:this._model,parent:this,mode:this._mode});if(o){this.addChild(o,{layout:{forceDisplay:true}})}};BX.Crm.EntityEditorSection.prototype.onCreateUserFieldBtnClick=function(t){if(!this._fieldTypeSelectMenu){var e=this._editor.getUserFieldManager().getTypeInfos();var i=[];for(var n=0,r=e.length;n<r;n++){var o=e[n];i.push({value:o.name,text:o.title,legend:o.legend})}this._fieldTypeSelectMenu=BX.Crm.UserFieldTypeMenu.create(this._id,{items:i,callback:BX.delegate(this.onUserFieldTypeSelect,this)})}this._fieldTypeSelectMenu.open(this._createChildButton)};BX.Crm.EntityEditorSection.prototype.onUserFieldTypeSelect=function(t,e){this._fieldTypeSelectMenu.close();var i=e.getValue();if(i===""){return}if(i==="custom"){window.open(this._editor.getUserFieldManager().getCreationPageUrl())}else{this.removeFieldConfigurator();this.removeUserFieldConfigurator();this.createUserFieldConfigurator({typeId:i})}};BX.Crm.EntityEditorSection.prototype.createUserFieldConfigurator=function(t){if(!BX.type.isPlainObject(t)){throw"EntityEditorSection: The 'params' argument must be object."}var e="";var i=BX.prop.get(t,"field",null);if(i){if(!(i instanceof BX.Crm.EntityEditorUserField)){throw"EntityEditorSection: The 'field' param must be EntityEditorUserField."}e=i.getFieldType();i.setVisible(false)}else{e=BX.prop.get(t,"typeId",BX.Crm.EntityUserFieldType.string)}if(e==="resourcebooking"){var n={editor:this._editor,schemeElement:null,model:this._model,mode:BX.Crm.EntityEditorMode.edit,parent:this,typeId:e,field:i,showAlways:true};if(BX.Calendar&&BX.type.isFunction(BX.Calendar.ResourcebookingUserfield)){this._userFieldConfigurator=BX.Calendar.ResourcebookingUserfield.getCrmFieldConfigurator("",n)}else if(BX.Calendar&&BX.Calendar.UserField&&BX.Calendar.UserField.EntityEditorUserFieldConfigurator){this._userFieldConfigurator=BX.Calendar.UserField.EntityEditorUserFieldConfigurator.create("",n)}}else{var r=this._editor.getAttributeManager();if(r){this._mandatoryConfigurator=r.createFieldConfigurator(i,BX.Crm.EntityFieldAttributeType.required)}var o=null;var s=null;if(i){s=i.getData()}this._visibilityConfigurator=BX.Crm.EntityFieldVisibilityConfigurator.create(this._id,{editor:i?i._editor:null,config:i?BX.prop.getObject(s,"visibilityConfigs",null):null,field:i?i:null});this._userFieldConfigurator=BX.Crm.EntityEditorUserFieldConfigurator.create("",{editor:this._editor,schemeElement:null,model:this._model,mode:BX.Crm.EntityEditorMode.edit,parent:this,typeId:e,field:i,mandatoryConfigurator:this._mandatoryConfigurator,visibilityConfigurator:this._visibilityConfigurator,showAlways:true})}this.addChild(this._userFieldConfigurator,{related:i});BX.addCustomEvent(this._userFieldConfigurator,"onSave",BX.delegate(this.onUserFieldConfigurationSave,this));BX.addCustomEvent(this._userFieldConfigurator,"onCancel",BX.delegate(this.onUserFieldConfigurationCancel,this))};BX.Crm.EntityEditorSection.prototype.removeUserFieldConfigurator=function(){if(this._userFieldConfigurator){var t=this._userFieldConfigurator.getField();if(t){t.setVisible(true)}this.removeChild(this._userFieldConfigurator);this._userFieldConfigurator=null}};BX.Crm.EntityEditorSection.prototype.onUserFieldConfigurationSave=function(t,e){if(t!==this._userFieldConfigurator){return}this._userFieldConfigurator.setLocked(true);var i=BX.prop.getString(e,"typeId");if(i===BX.Crm.EntityUserFieldType.datetime&&!BX.prop.getBoolean(e,"enableTime",false)){i=BX.Crm.EntityUserFieldType.date}var n={USER_TYPE_ID:i};if(this._mandatoryConfigurator&&this._mandatoryConfigurator.isPermitted()&&this._mandatoryConfigurator.isEnabled()&&this._mandatoryConfigurator.isCustomized()){if(this._mandatoryConfigurator.isChanged()){this._mandatoryConfigurator.acceptChanges()}n["MANDATORY"]="N"}else{n["MANDATORY"]=BX.prop.getBoolean(e,"mandatory",false)?"Y":"N"}var r=BX.prop.get(e,"settings",null);if(r){n["SETTINGS"]=r}var o=BX.prop.getBoolean(e,"showAlways",null);var s=BX.prop.getString(e,"label","");var a=BX.prop.get(e,"field",null);if(a){var l=a.getTitle();if(s!==""||o!==null){a.setTitle(s);if(o!==null&&o!==a.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){a.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}this.markSchemeAsChanged();this.saveScheme()}n["FIELD"]=a.getName();n["ENTITY_VALUE_ID"]=a.getEntityValueId();if(this._editor.getConfigScope()===BX.Crm.EntityConfigScope.common&&l!==s){n["EDIT_FORM_LABEL"]=n["LIST_COLUMN_LABEL"]=n["LIST_FILTER_LABEL"]=s}n["VALUE"]=a.getFieldValue();if(i===BX.Crm.EntityUserFieldType.enumeration){n["ENUM"]=BX.prop.getArray(e,"enumeration",[])}a.adjustFieldParams(n,false);this._editor.getUserFieldManager().updateField(n,a.getMode()).then(BX.delegate(this.onUserFieldUpdate,this))}else{if(o!==null){this._editor.setOption("show_always",o?"Y":"N")}n["EDIT_FORM_LABEL"]=n["LIST_COLUMN_LABEL"]=n["LIST_FILTER_LABEL"]=BX.prop.getString(e,"label");n["MULTIPLE"]=BX.prop.getBoolean(e,"multiple",false)?"Y":"N";if(i===BX.Crm.EntityUserFieldType.enumeration){n["ENUM"]=BX.prop.getArray(e,"enumeration",[])}this._editor.getUserFieldManager().createField(n,this._mode).then(BX.delegate(this.onUserFieldCreate,this))}};BX.Crm.EntityEditorSection.prototype.onUserFieldConfigurationCancel=function(t,e){if(t!==this._userFieldConfigurator){return}this.removeUserFieldConfigurator();if(this._mandatoryConfigurator){this._mandatoryConfigurator=null}if(this._visibilityConfigurator){this._visibilityConfigurator=null}};BX.Crm.EntityEditorSection.prototype.onUserFieldCreate=function(t){if(!BX.type.isPlainObject(t)){return}this.removeUserFieldConfigurator();var e=this._editor.getUserFieldManager();for(var i in t){if(!t.hasOwnProperty(i)){continue}var n=t[i];var r=BX.prop.getObject(n,"FIELD",null);if(!r){continue}var o=e.createSchemeElement(r);if(!o){continue}this._model.registerNewField(o.getName(),{VALUE:"",SIGNATURE:BX.prop.getString(r,"SIGNATURE","")});var s=this._editor.createControl(o.getType(),o.getName(),{schemeElement:o,model:this._model,parent:this,mode:this._mode});if(this._mandatoryConfigurator&&this._mandatoryConfigurator.isPermitted()&&this._mandatoryConfigurator.isEnabled()&&this._mandatoryConfigurator.isCustomized()){var a=this._mandatoryConfigurator.getConfiguration();this._editor.getAttributeManager().saveConfiguration(a,o.getName());s.setAttributeConfiguration(a)}if(this._visibilityConfigurator){var l={accessCodes:this._visibilityConfigurator.formatAccessCodesFromConfig(this._visibilityConfigurator.getItems())};this._visibilityConfigurator.onUserFieldConfigurationSave(o.getName(),this._editor.getEntityTypeId());s.setVisibilityConfiguration(l)}var d=this._editor.getOption("show_always","Y")==="Y";if(d!==s.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){s.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}this.addChild(s,{layout:{notifyIfNotDisplayed:true,html:BX.prop.getString(n,"HTML","")}});break}if(this._mandatoryConfigurator){this._mandatoryConfigurator=null}if(this._visibilityConfigurator){this._visibilityConfigurator=null}};BX.Crm.EntityEditorSection.prototype.onUserFieldUpdate=function(t){if(!BX.type.isPlainObject(t)){return}this.removeUserFieldConfigurator();var e=this._editor.getUserFieldManager();for(var i in t){if(!t.hasOwnProperty(i)){continue}var n=t[i];var r=BX.prop.getObject(n,"FIELD",null);if(!r){continue}var o=this.getChildById(i);if(!o){continue}var s=o.getSchemeElement();if(!s){continue}if(this._mandatoryConfigurator&&this._mandatoryConfigurator.isPermitted()){if(this._mandatoryConfigurator.isEnabled()&&this._mandatoryConfigurator.isCustomized()){var a=this._mandatoryConfigurator.getConfiguration();this._editor.getAttributeManager().saveConfiguration(a,s.getName());o.setAttributeConfiguration(a)}else{var l=this._mandatoryConfigurator.getTypeId();this._editor.getAttributeManager().removeConfiguration(l,s.getName());o.removeAttributeConfiguration(l)}}if(this._visibilityConfigurator){var d={accessCodes:this._visibilityConfigurator.formatAccessCodesFromConfig(this._visibilityConfigurator.getItems())};this._visibilityConfigurator.onUserFieldConfigurationSave(s.getName(),this._editor.getEntityTypeId());o.setVisibilityConfiguration(d)}e.updateSchemeElement(s,r);var h={};var p=BX.prop.getString(n,"HTML","");if(p!==""){h["html"]=p}o.refreshLayout(h);break}if(this._mandatoryConfigurator){this._mandatoryConfigurator=null}if(this._visibilityConfigurator){this._visibilityConfigurator=null}};BX.Crm.EntityEditorSection.prototype.editChildConfiguration=function(t){this.removeFieldConfigurator();this.removeUserFieldConfigurator();if(t.getType()==="userField"&&this._editor.getUserFieldManager().isModificationEnabled()){this.createUserFieldConfigurator({field:t})}else{this.createFieldConfigurator(t)}};BX.Crm.EntityEditorSection.prototype.createFieldConfigurator=function(t){t.setVisible(false);var e=this._editor.getAttributeManager();if(e){this._mandatoryConfigurator=e.createFieldConfigurator(t,BX.Crm.EntityFieldAttributeType.required)}this._fieldConfigurator=BX.Crm.EntityEditorFieldConfigurator.create("",{editor:this._editor,schemeElement:null,model:this._model,mode:BX.Crm.EntityEditorMode.edit,parent:this,field:t,mandatoryConfigurator:this._mandatoryConfigurator});this.addChild(this._fieldConfigurator,{related:t});BX.addCustomEvent(this._fieldConfigurator,"onSave",BX.delegate(this.onFieldConfigurationSave,this));BX.addCustomEvent(this._fieldConfigurator,"onCancel",BX.delegate(this.onFieldConfigurationCancel,this))};BX.Crm.EntityEditorSection.prototype.removeFieldConfigurator=function(){if(this._fieldConfigurator){var t=this._fieldConfigurator.getField();if(t){t.setVisible(true)}this.removeChild(this._fieldConfigurator);this._fieldConfigurator=null}};BX.Crm.EntityEditorSection.prototype.onFieldConfigurationSave=function(t,e){if(t!==this._fieldConfigurator){return}var i=BX.prop.get(e,"field",null);if(!i){throw"EntityEditorSection. Could not find target field."}var n=BX.prop.getString(e,"label","");var r=BX.prop.getBoolean(e,"showAlways",null);if(n===""&&r===null){this.removeFieldConfigurator();if(this._mandatoryConfigurator){this._mandatoryConfigurator=null}return}this._fieldConfigurator.setLocked(true);i.setTitle(n);if(r!==null&&r!==i.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){i.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}this.markSchemeAsChanged();this.saveScheme().then(BX.delegate(function(){if(this._mandatoryConfigurator){if(this._mandatoryConfigurator.isPermitted()&&i.areAttributesEnabled()&&!i.isRequired()){if(this._mandatoryConfigurator.isEnabled()){if(this._mandatoryConfigurator.isChanged()){this._mandatoryConfigurator.acceptChanges()}var t=this._mandatoryConfigurator.getConfiguration();this._editor.getAttributeManager().saveConfiguration(t,i.getName());i.setAttributeConfiguration(t)}else{var e=this._mandatoryConfigurator.getTypeId();this._editor.getAttributeManager().removeConfiguration(e,i.getName());i.removeAttributeConfiguration(e)}}this._mandatoryConfigurator=null}this.removeFieldConfigurator()},this))};BX.Crm.EntityEditorSection.prototype.onFieldConfigurationCancel=function(t,e){if(t!==this._fieldConfigurator){return}var i=BX.prop.get(e,"field",null);if(!i){throw"EntityEditorSection. Could not find target field."}this.removeFieldConfigurator();if(this._mandatoryConfigurator){this._mandatoryConfigurator=null}};BX.Crm.EntityEditorSection.prototype.enablePointerEvents=function(t){if(!this._fields){return}t=!!t;for(i=0,length=this._fields.length;i<length;i++){this._fields[i].enablePointerEvents(t)}};BX.Crm.EntityEditorSection.prototype.onDeleteConfirm=function(t){if(BX.prop.getBoolean(t,"cancel",true)){return}this._editor.removeSchemeElement(this.getSchemeElement());this._editor.removeControl(this);this._editor.saveScheme()};BX.Crm.EntityEditorSection.prototype.onDeleteSectionBtnClick=function(t){if(this.isRequired()||this.isRequiredConditionally()){this.showMessageDialog("operationDenied",this.getMessage("deleteSection"),this.getMessage("deleteSectionDenied"));return}var e=BX.Crm.ConfirmationDialog.get(this._detetionConfirmDlgId);if(!e){e=BX.Crm.ConfirmationDialog.create(this._detetionConfirmDlgId,{title:this.getMessage("deleteSection"),content:this.getMessage("deleteSectionConfirm")})}e.open().then(BX.delegate(this.onDeleteConfirm,this))};BX.Crm.EntityEditorSection.prototype.getDragObjectType=function(){return BX.Crm.EditorDragObjectType.section};BX.Crm.EntityEditorSection.prototype.getChildDragObjectType=function(){return BX.Crm.EditorDragObjectType.field};BX.Crm.EntityEditorSection.prototype.hasPlaceHolder=function(){return!!this._dragPlaceHolder};BX.Crm.EntityEditorSection.prototype.createPlaceHolder=function(t){this.enablePointerEvents(false);var e=this.getChildCount();if(t<0||t>e){t=e>0?e:0}if(this._dragPlaceHolder){if(this._dragPlaceHolder.getIndex()===t){return this._dragPlaceHolder}this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}this._dragPlaceHolder=BX.Crm.EditorDragFieldPlaceholder.create({container:this._contentContainer,anchor:t<e?this._fields[t].getWrapper():this._buttonPanelWrapper,index:t});this._dragPlaceHolder.layout();return this._dragPlaceHolder};BX.Crm.EntityEditorSection.prototype.getPlaceHolder=function(){return this._dragPlaceHolder};BX.Crm.EntityEditorSection.prototype.removePlaceHolder=function(){this.enablePointerEvents(true);if(this._dragPlaceHolder){this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}};BX.Crm.EntityEditorSection.prototype.processDraggedItemDrop=function(t,e){var i=t.getCharge();if(!(i instanceof BX.Crm.EditorFieldDragContainer&&i.getSection()===this)){return}var n=e.getContextData();var r=BX.type.isNotEmptyString(n["contextId"])?n["contextId"]:"";if(r!==this.getDraggableContextId()){return}var o=this.getPlaceHolder();var s=o?o.getIndex():-1;if(s<0){return}var a=typeof n["charge"]!=="undefined"?n["charge"]:null;if(!(a instanceof BX.Crm.EditorFieldDragItem)){return}var l=a.getControl();if(!l){return}var d=l.getParent();if(d===this){var h=this.getChildIndex(l);if(h<0){return}var p=s<=h?s:s-1;if(p===h){return}this.moveChild(l,p,{enableSaving:false});this._editor.saveSchemeChanges()}else{var u=l.getSchemeElement();d.removeChild(l,{enableSaving:false});var c=this._editor.createControl(u.getType(),u.getName(),{schemeElement:u,model:this._model,parent:this,mode:this._mode});if(this._mode===BX.Crm.EntityEditorMode.view&&!c.hasContentToDisplay()&&!c.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)){c.toggleOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}this.addChild(c,{index:s,enableSaving:false});this._editor.saveSchemeChanges()}};BX.Crm.EntityEditorSection.prototype.onDrop=function(t,e,i,n){this.processDraggedItemDrop(t,e)};BX.Crm.EntityEditorSection.prototype.initializeDragDropAbilities=function(){if(this._dragItem){return}this._dragItem=BX.Crm.EditorDragItemController.create("section_"+this.getId(),{charge:BX.Crm.EditorSectionDragItem.create({control:this}),node:this.createDragButton(),showControlInDragMode:false,ghostOffset:{x:0,y:0}})};BX.Crm.EntityEditorSection.prototype.releaseDragDropAbilities=function(){if(this._dragItem){this._dragItem.release();this._dragItem=null}};BX.Crm.EntityEditorSection.prototype.isWaitingForInput=function(){for(var t=0,e=this._fields.length;t<e;t++){if(this._fields[t].isWaitingForInput()){return true}}return false};BX.Crm.EntityEditorSection.prototype.isRequired=function(){for(var t=0,e=this._fields.length;t<e;t++){if(this._fields[t].isRequired()){return true}}return false};BX.Crm.EntityEditorSection.prototype.isRequiredConditionally=function(){for(var t=0,e=this._fields.length;t<e;t++){if(this._fields[t].isRequiredConditionally()){return true}}return false};BX.Crm.EntityEditorSection.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorSection.messages;return e.hasOwnProperty(t)?e[t]:t};if(typeof BX.Crm.EntityEditorSection.messages==="undefined"){BX.Crm.EntityEditorSection.messages={}}BX.Crm.EntityEditorSection.create=function(t,e){var i=new BX.Crm.EntityEditorSection;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorText==="undefined"){BX.Crm.EntityEditorText=function(){BX.Crm.EntityEditorText.superclass.constructor.apply(this);this._input=null;this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorText,BX.Crm.EntityEditorField);BX.Crm.EntityEditorText.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorText.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorText.prototype.focus=function(){var t=this.getInputElement();if(!t){return}BX.focus(t);BX.Crm.EditorTextHelper.getCurrent().setPositionAtEnd(t)};BX.Crm.EntityEditorText.prototype.getLineCount=function(){return this._schemeElement.getDataIntegerParam("lineCount",1)};BX.Crm.EntityEditorText.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-text"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getTitle();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){if(this.needShowTitle()){this._wrapper.appendChild(this.createTitleNode(e))}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:this.getEditModeHtmlNodes()})]});if(this._editor.isDuplicateControlEnabled()){var i=this.getDuplicateControlConfig();if(i){if(!BX.type.isPlainObject(i["field"])){i["field"]={}}i["field"]["id"]=this.getId();i["field"]["element"]=this._input;this._editor.getDuplicateManager().registerField(i)}}}else{if(this.needShowTitle()){this._wrapper.appendChild(this.createTitleNode(e))}if(this.hasContentToDisplay()){this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:this.getViewModeHtmlNodes()})}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorText.prototype.getEditModeHtmlNodes=function(){var t;var e=this.getValue();var i=this.getLineCount();if(i>1){t=BX.create("textarea",{props:{className:"crm-entity-widget-content-textarea",rows:i,value:e}})}else{t=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",type:"text",value:e}})}if(!this.isVirtual()){t.name=this.getName()}var n=this.isNewEntity()?this.getCreationPlaceholder():this.getChangePlaceholder();if(n!==""){t.setAttribute("placeholder",n)}BX.bind(t,"input",this._changeHandler);this._input=t;return[t]};BX.Crm.EntityEditorText.prototype.getViewModeHtmlNodes=function(){var t=this.getValue();if(this.getLineCount()>1){return[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},html:BX.util.nl2br(BX.util.htmlspecialchars(t))})]}else{return[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},text:t})]}};BX.Crm.EntityEditorText.prototype.doClearLayout=function(t){if(this._editor.isDuplicateControlEnabled()){var e=this.getDuplicateControlConfig();if(e){if(!BX.type.isPlainObject(e["field"])){e["field"]={}}e["field"]["id"]=this.getId();this._editor.getDuplicateManager().unregisterField(e)}}this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorText.prototype.refreshLayout=function(){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Crm.EntityEditorText.superclass.refreshLayout.apply(this,arguments);return}if(this._mode===BX.Crm.EntityEditorMode.edit){this.setRawRuntimeValue(this.getValue())}else if(this._mode===BX.Crm.EntityEditorMode.view&&this._innerWrapper){this._innerWrapper.innerHTML=BX.util.htmlspecialchars(this.getValue())}};BX.Crm.EntityEditorText.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?BX.util.trim(this._input.value):""};BX.Crm.EntityEditorText.prototype.getRawRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?this._input.value:""};BX.Crm.EntityEditorText.prototype.setRawRuntimeValue=function(t){if(this._mode===BX.Crm.EntityEditorMode.edit&&this._input){this._input.value=t}};BX.Crm.EntityEditorText.prototype.getInputElement=function(){return this._input};BX.Crm.EntityEditorText.prototype.validate=function(t){var e=this.getInputElement();if(!(this._mode===BX.Crm.EntityEditorMode.edit&&e)){throw"BX.Crm.EntityEditorText. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var i=!this.isRequired()||BX.util.trim(this.getRawRuntimeValue())!=="";if(!i){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(e)}return i};BX.Crm.EntityEditorText.prototype.showError=function(t,e){var i=this.getInputElement();BX.Crm.EntityEditorText.superclass.showError.apply(this,arguments);if(i){BX.addClass(i,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorText.prototype.clearError=function(){var t=this.getInputElement();BX.Crm.EntityEditorText.superclass.clearError.apply(this);if(t){BX.removeClass(t,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorText.prototype.save=function(){this._model.setField(this.getName(),this.getRawRuntimeValue(),{originator:this})};BX.Crm.EntityEditorText.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorText.create=function(t,e){var i=new BX.Crm.EntityEditorText;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorNumber==="undefined"){BX.Crm.EntityEditorNumber=function(){BX.Crm.EntityEditorNumber.superclass.constructor.apply(this);this._input=null;this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorNumber,BX.Crm.EntityEditorField);BX.Crm.EntityEditorNumber.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorNumber.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorNumber.prototype.focus=function(){if(!this._input){return}BX.focus(this._input);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._input)};BX.Crm.EntityEditorNumber.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-number"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._input=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._input=BX.create("input",{attrs:{name:e,className:"crm-entity-widget-content-input",type:"text",value:n}});BX.bind(this._input,"input",this._changeHandler);this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-field-half-width"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._input]})]})}else{this._wrapper.appendChild(this.createTitleNode(i));if(!this.hasContentToDisplay()){n=this.getMessage("isEmpty")}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},text:n})]})}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorNumber.prototype.doClearLayout=function(t){this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorNumber.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?BX.util.trim(this._input.value):""};BX.Crm.EntityEditorNumber.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._input)){throw"BX.Crm.EntityEditorNumber. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorNumber.prototype.showError=function(t,e){BX.Crm.EntityEditorNumber.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorNumber.prototype.clearError=function(){BX.Crm.EntityEditorNumber.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorNumber.prototype.save=function(){if(this._input){this._model.setField(this.getName(),this._input.value)}};BX.Crm.EntityEditorNumber.create=function(t,e){var i=new BX.Crm.EntityEditorNumber;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorDatetime==="undefined"){BX.Crm.EntityEditorDatetime=function(){BX.Crm.EntityEditorDatetime.superclass.constructor.apply(this);this._input=null;this._inputClickHandler=BX.delegate(this.onInputClick,this);this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorDatetime,BX.Crm.EntityEditorField);BX.Crm.EntityEditorDatetime.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorDatetime.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorDatetime.prototype.focus=function(){if(this._input){BX.focus(this._input);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._input)}};BX.Crm.EntityEditorDatetime.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-date"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._input=BX.create("input",{attrs:{name:e,className:"crm-entity-widget-content-input",type:"text",value:n}});BX.bind(this._input,"click",this._inputClickHandler);BX.bind(this._input,"change",this._changeHandler);BX.bind(this._input,"input",this._changeHandler);this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-field-half-width"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._input]})]})}else{n=BX.date.format("j F Y",BX.parseDate(n));this._wrapper.appendChild(this.createTitleNode(i));if(!this.hasContentToDisplay()){n=this.getMessage("isEmpty")}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},text:n})]})}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorDatetime.prototype.doRegisterLayout=function(){if(this.isInEditMode()&&this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)&&this._input){window.setTimeout(BX.delegate(this.showCalendar,this),100)}};BX.Crm.EntityEditorDatetime.prototype.doClearLayout=function(t){this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorDatetime.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?BX.util.trim(this._input.value):""};BX.Crm.EntityEditorDatetime.prototype.onInputClick=function(t){this.showCalendar()};BX.Crm.EntityEditorDatetime.prototype.showCalendar=function(){BX.calendar({node:this._input,field:this._input,bTime:false,bSetFocus:false})};BX.Crm.EntityEditorDatetime.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._input)){throw"BX.Crm.EntityEditorDatetime. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorDatetime.prototype.showError=function(t,e){BX.Crm.EntityEditorDatetime.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorDatetime.prototype.clearError=function(){BX.Crm.EntityEditorDatetime.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorDatetime.prototype.save=function(){if(this._input){this._model.setField(this.getName(),this._input.value)}};BX.Crm.EntityEditorDatetime.create=function(t,e){var i=new BX.Crm.EntityEditorDatetime;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorBoolean==="undefined"){BX.Crm.EntityEditorBoolean=function(){BX.Crm.EntityEditorBoolean.superclass.constructor.apply(this);this._input=null;this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorBoolean,BX.Crm.EntityEditorField);BX.Crm.EntityEditorBoolean.prototype.doInitialize=function(){BX.Crm.EntityEditorBoolean.superclass.doInitialize.apply(this);this._selectedValue=this._model.getField(this._schemeElement.getName())};BX.Crm.EntityEditorBoolean.prototype.areAttributesEnabled=function(){return false};BX.Crm.EntityEditorBoolean.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorBoolean.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorBoolean.prototype.hasValue=function(){return BX.util.trim(this.getValue())!==""};BX.Crm.EntityEditorBoolean.prototype.getValue=function(t){if(!this._model){return""}if(t===undefined){t="N"}var e=this._model.getStringField(this.getName(),t);if(e!=="Y"&&e!=="N"){e="N"}return e};BX.Crm.EntityEditorBoolean.prototype.getRuntimeValue=function(){if(this._mode!==BX.Crm.EntityEditorMode.edit||!this._input)return"";var t=BX.util.trim(this._input.value);if(t!=="Y"&&t!=="N"){t="N"}return t};BX.Crm.EntityEditorBoolean.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-checkbox"]});this.adjustWrapper();var e=this.getName();var i=this.getTitle();var n=this.getValue();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(BX.create("input",{attrs:{name:e,type:"hidden",value:"N"}}));this._input=BX.create("input",{attrs:{className:"crm-entity-widget-content-checkbox",name:e,type:"checkbox",value:"Y",checked:n==="Y"}});BX.bind(this._input,"change",this._changeHandler);this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[BX.create("label",{attrs:{className:"crm-entity-widget-content-block-checkbox-label"},children:[this._input,BX.create("span",{props:{className:"crm-entity-widget-content-block-checkbox-description"},text:i})]})]})]})}else{this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},text:this.getMessage(n==="Y"?"yes":"no")})]})}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorBoolean.prototype.doClearLayout=function(t){this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorBoolean.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._input)){throw"BX.Crm.EntityEditorBoolean. Invalid validation context"}if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));BX.addClass(this._input,"crm-entity-widget-content-error");this.showRequiredFieldError(this._input)}else{BX.removeClass(this._input,"crm-entity-widget-content-error");this.clearError()}return e};BX.Crm.EntityEditorBoolean.prototype.showError=function(t,e){BX.Crm.EntityEditorBoolean.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorBoolean.prototype.clearError=function(){BX.Crm.EntityEditorBoolean.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorBoolean.prototype.save=function(){if(this._input){this._model.setField(this.getName(),this._input.checked?"Y":"N",{originator:this})}};BX.Crm.EntityEditorBoolean.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorBoolean.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorBoolean.superclass.getMessage.apply(this,arguments)};if(typeof BX.Crm.EntityEditorBoolean.messages==="undefined"){BX.Crm.EntityEditorBoolean.messages={}}BX.Crm.EntityEditorBoolean.create=function(t,e){var i=new BX.Crm.EntityEditorBoolean;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorList==="undefined"){BX.Crm.EntityEditorList=function(){BX.Crm.EntityEditorList.superclass.constructor.apply(this);this._items=null;this._input=null;this._selectContainer=null;this._selectedValue="";this._selectorClickHandler=BX.delegate(this.onSelectorClick,this);this._innerWrapper=null;this._isOpened=false};BX.extend(BX.Crm.EntityEditorList,BX.Crm.EntityEditorField);BX.Crm.EntityEditorList.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorList.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorList.prototype.checkIfNotEmpty=function(t){if(BX.type.isString(t)){t=t.trim();return t!==""&&t!=="0"}return t!==null&&t!==undefined};BX.Crm.EntityEditorList.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-select"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();var r=this.getItemByValue(n);var o=this.getDataBooleanParam("isHtml",false);var s={};if(!r){r=this.getFirstItem();if(r){n=r["VALUE"]}}this._selectedValue=n;this._selectContainer=null;this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(i));this._input=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._wrapper.appendChild(this._input);s={props:{className:"crm-entity-widget-content-select"}};if(o){s.html=r?r["NAME"]:n}else{s.text=r?r["NAME"]:n}this._selectContainer=BX.create("div",s);BX.bind(this._selectContainer,"click",this._selectorClickHandler);this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._selectContainer]})]})}else{this._wrapper.appendChild(this.createTitleNode(i));var a="";if(!this.hasContentToDisplay()){a=this.getMessage("isEmpty")}else if(r){a=r["NAME"]}else{a=n}var s={props:{className:"crm-entity-widget-content-block-inner-text"}};if(o){s.html=a}else{s.text=a}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",s)]})}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorList.prototype.doRegisterLayout=function(){if(this.isInEditMode()&&this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)&&this._selectContainer){window.setTimeout(BX.delegate(this.openMenu,this),100)}};BX.Crm.EntityEditorList.prototype.doClearLayout=function(t){this.closeMenu();this._input=null;this._selectContainer=null;this._innerWrapper=null};BX.Crm.EntityEditorList.prototype.refreshLayout=function(){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Crm.EntityEditorMoney.superclass.refreshLayout.apply(this,arguments);return}var t=this.getValue();var e=this.getItemByValue(t);var i=e?BX.prop.getString(e,"NAME",t):t;if(this._mode===BX.Crm.EntityEditorMode.edit){this._selectedValue=t;if(this._input){this._input.value=t}if(this._selectContainer){this._selectContainer.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i)}}else if(this._mode===BX.Crm.EntityEditorMode.view&&this._innerWrapper){this._innerWrapper.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i)}};BX.Crm.EntityEditorList.prototype.validate=function(t){if(this._mode!==BX.Crm.EntityEditorMode.edit){throw"BX.Crm.EntityEditorList. Invalid validation context"}if(!this.isEditable()){return true}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Crm.EntityEditorList.prototype.showError=function(t,e){BX.Crm.EntityEditorList.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorList.prototype.clearError=function(){BX.Crm.EntityEditorList.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorList.prototype.onSelectorClick=function(t){if(!this._isOpened){this.openMenu()}else{this.closeMenu()}};BX.Crm.EntityEditorList.prototype.openMenu=function(){if(this._isOpened){return}var t=[];var e=this.getItems();for(var i=0,n=e.length;i<n;i++){var r=e[i];if(!BX.prop.getBoolean(r,"IS_EDITABLE",true)){continue}var o=BX.prop.getString(r,"VALUE",i);var s=BX.prop.getString(r,"NAME",o);t.push({text:this.getDataBooleanParam("isHtml",false)?s:BX.util.htmlspecialchars(s),value:o,onclick:BX.delegate(this.onItemSelect,this)})}BX.PopupMenu.show(this._id,this._selectContainer,t,{angle:false,width:this._selectContainer.offsetWidth+"px",events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._selectContainer)["width"])};BX.Crm.EntityEditorList.prototype.closeMenu=function(){var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorList.prototype.onMenuShow=function(){BX.addClass(this._selectContainer,"active");this._isOpened=true};BX.Crm.EntityEditorList.prototype.onMenuClose=function(){BX.PopupMenu.destroy(this._id);BX.removeClass(this._selectContainer,"active");this._isOpened=false};BX.Crm.EntityEditorList.prototype.onItemSelect=function(t,e){this.closeMenu();this._selectedValue=this._input.value=e.value;var i=BX.prop.getString(this.getItemByValue(this._selectedValue),"NAME",this._selectedValue);this._selectContainer.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i);this.markAsChanged();BX.PopupMenu.destroy(this._id)};BX.Crm.EntityEditorList.prototype.getItems=function(){if(!this._items){this._items=BX.prop.getArray(this._schemeElement.getData(),"items",[])}return this._items};BX.Crm.EntityEditorList.prototype.getItemByValue=function(t){var e=this.getItems();for(var i=0,n=e.length;i<n;i++){var r=e[i];if(t===BX.prop.getString(r,"VALUE","")){return r}}return null};BX.Crm.EntityEditorList.prototype.getFirstItem=function(){var t=this.getItems();return t.length>0?t[0]:null};BX.Crm.EntityEditorList.prototype.save=function(){if(!this.isEditable()){return}this._model.setField(this.getName(),this._selectedValue)};BX.Crm.EntityEditorList.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorList.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?this._selectedValue:""};BX.Crm.EntityEditorList.create=function(t,e){var i=new BX.Crm.EntityEditorList;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorHtml==="undefined"){BX.Crm.EntityEditorHtml=function(){BX.Crm.EntityEditorHtml.superclass.constructor.apply(this);this._htmlEditorContainer=null;this._htmlEditor=null;this._isEditorInitialized=false;this._focusOnLoad=false;this._input=null;this._innerWrapper=null;this._editorInitializationHandler=BX.delegate(this.onEditorInitialized,this);this._viewClickHandler=BX.delegate(this.onViewClick,this)};BX.extend(BX.Crm.EntityEditorHtml,BX.Crm.EntityEditorField);BX.Crm.EntityEditorHtml.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorHtml.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorHtml.prototype.checkIfNotEmpty=function(t){return BX.Crm.EntityEditorHtml.isNotEmptyValue(t)};BX.Crm.EntityEditorHtml.prototype.focus=function(){if(this._htmlEditor&&this._isEditorInitialized){this._htmlEditor.Focus(true)}else{this._focusOnLoad=true}};BX.Crm.EntityEditorHtml.prototype.layout=function(t){if(this._hasLayout){return}this.release();this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-comment"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){if(!this._editor){throw"BX.Crm.EntityEditorHtml: Editor instance is required for create layout."}var r=this._editor.getHtmlEditorConfig(e);if(!r){throw"BX.Crm.EntityEditorHtml: Could not find HTML editor config."}this._htmlEditorContainer=BX(BX.prop.getString(r,"containerId"));if(!BX.type.isElementNode(this._htmlEditorContainer)){throw"BX.Crm.EntityEditorHtml: Could not find HTML editor container."}this._htmlEditor=BXHtmlEditor.Get(BX.prop.getString(r,"id"));if(!this._htmlEditor){throw"BX.Crm.EntityEditorHtml: Could not find HTML editor instance."}this._wrapper.appendChild(this.createTitleNode(i));this._input=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._wrapper.appendChild(this._input);this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._htmlEditorContainer]})]})}else{this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});if(this.hasContentToDisplay()){this._innerWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-comment"},html:n})]}));if(n.length>200){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-comment-collapsed");this._innerWrapper.appendChild(BX.create("DIV",{attrs:{className:"crm-entity-widget-content-block-field-comment-expand-btn-container"},children:[BX.create("A",{attrs:{className:"crm-entity-widget-content-block-field-comment-expand-btn",href:"#"},events:{click:BX.delegate(this.onExpandButtonClick,this)},text:this.getMessage("expand")})]}));this._isCollapsed=true}}else{this._innerWrapper.appendChild(document.createTextNode(this.getMessage("isEmpty")))}this._wrapper.appendChild(this._innerWrapper);BX.bindDelegate(this._wrapper,"mousedown",BX.delegate(this.filterViewNode,this),this._viewClickHandler)}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);if(this._mode===BX.Crm.EntityEditorMode.edit){this._isEditorInitialized=!!this._htmlEditor.inited;if(this._isEditorInitialized){this.prepareEditor()}else{BX.addCustomEvent(this._htmlEditor,"OnCreateIframeAfter",this._editorInitializationHandler);this._htmlEditor.Init()}window.top.setTimeout(BX.delegate(this.bindChangeEvent,this),1e3);this.initializeDragDropAbilities()}this._hasLayout=true};BX.Crm.EntityEditorHtml.prototype.doClearLayout=function(t){this.release();this._input=null;this._innerWrapper=null};BX.Crm.EntityEditorHtml.prototype.onExpandButtonClick=function(t){if(!this._wrapper){return BX.PreventDefault(t)}if(this._hasFiles&&BX.type.isDomNode(this._commentWrapper)&&!this._textLoaded){this._textLoaded=true;this.loadContent(this._commentWrapper,"GET_TEXT")}var e=this._wrapper.querySelector(".crm-entity-widget-content-block-inner-comment");if(this._isCollapsed){BX.defer(function(){e.style.maxHeight=e.scrollHeight+130+"px"})();setTimeout(BX.delegate(function(){BX.removeClass(this._wrapper,"crm-entity-widget-content-block-field-comment-collapsed");BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-comment-expand");e.style.maxHeight=""},this),200)}else{BX.defer(function(){e.style.maxHeight=e.clientHeight+"px"})();BX.defer(function(){BX.removeClass(this._wrapper,"crm-entity-widget-content-block-field-comment-expand");BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-comment-collapsed")},this)();setTimeout(function(){e.style.maxHeight=""},200)}this._isCollapsed=!this._isCollapsed;var i=this._wrapper.querySelector("a.crm-entity-widget-content-block-field-comment-expand-btn");if(i){i.innerHTML=this.getMessage(this._isCollapsed?"expand":"collapse")}return BX.PreventDefault(t)};BX.Crm.EntityEditorHtml.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorHtml.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorHtml.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorHtml.prototype.filterViewNode=function(t){return true};BX.Crm.EntityEditorHtml.prototype.onViewClick=function(t){var e=null;var i=BX.getEventTarget(t);if(i.tagName==="A"){e=i}else{e=BX.findParent(i,{tagName:"a"},this._wrapper)}if(e&&e.target!=="_blank"){e.target="_blank"}};BX.Crm.EntityEditorHtml.prototype.onEditorInitialized=function(){this._isEditorInitialized=true;BX.removeCustomEvent(this._htmlEditor,"OnCreateIframeAfter",this._editorInitializationHandler);this.prepareEditor()};BX.Crm.EntityEditorHtml.prototype.prepareEditor=function(){this._htmlEditorContainer.style.display="";this._htmlEditor.CheckAndReInit();this._htmlEditor.ResizeSceleton("100%",200);this._htmlEditor.SetContent(this.getStringValue(""),true);if(this._focusOnLoad){this._htmlEditor.Focus(true);this._focusOnLoad=false}};BX.Crm.EntityEditorHtml.prototype.release=function(){if(this._htmlEditorContainer){var t=BX.create("DIV",{style:{height:this._htmlEditorContainer.offsetHeight+"px",border:"1px solid #bbc4cd",boxSizing:"border-box"}});this._htmlEditorContainer.parentNode.insertBefore(t,this._htmlEditorContainer);document.body.appendChild(this._htmlEditorContainer);this._htmlEditorContainer.style.display="none";this._htmlEditorContainer=null}if(this._htmlEditor){this.unbindChangeEvent();this._htmlEditor.SetContent("");this._htmlEditor=null;this._isEditorInitialized=false}this._focusOnLoad=false};BX.Crm.EntityEditorHtml.prototype.bindChangeEvent=function(){if(this._htmlEditor){BX.addCustomEvent(this._htmlEditor,"OnContentChanged",this._changeHandler)}};BX.Crm.EntityEditorHtml.prototype.unbindChangeEvent=function(){if(this._htmlEditor){BX.removeCustomEvent(this._htmlEditor,"OnContentChanged",this._changeHandler)}};BX.Crm.EntityEditorHtml.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._htmlEditor)){throw"BX.Crm.EntityEditorHtml. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.Crm.EntityEditorHtml.isNotEmptyValue(this._htmlEditor.GetContent());if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._htmlEditorContainer)}return e};BX.Crm.EntityEditorHtml.prototype.showError=function(t,e){BX.Crm.EntityEditorHtml.superclass.showError.apply(this,arguments);if(this._htmlEditorContainer){BX.addClass(this._htmlEditorContainer,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorHtml.prototype.clearError=function(){BX.Crm.EntityEditorHtml.superclass.clearError.apply(this);if(this._htmlEditorContainer){BX.removeClass(this._htmlEditorContainer,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorHtml.prototype.save=function(){if(this._htmlEditor){var t=this._input.value=this._htmlEditor.GetContent();this._model.setField(this.getName(),t)}};BX.Crm.EntityEditorHtml.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit&&this._input?this._htmlEditor.GetContent():""};BX.Crm.EntityEditorHtml.isNotEmptyValue=function(t){return BX.util.trim(t.replace(/<br\/?>|&nbsp;/gi,""))!==""};BX.Crm.EntityEditorHtml.create=function(t,e){var i=new BX.Crm.EntityEditorHtml;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMoney==="undefined"){BX.Crm.EntityEditorMoney=function(){BX.Crm.EntityEditorMoney.superclass.constructor.apply(this);this._currencyEditor=null;this._amountInput=null;this._currencyInput=null;this._amountManualInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null;this._selectedCurrencyValue="";this._amountClickHandler=BX.delegate(this.onAmountClick,this);this._selectorClickHandler=BX.delegate(this.onSelectorClick,this);this._changeAmountEditModeListener=null;this._isCurrencyMenuOpened=false;this._hasRelatedProducts=false};BX.extend(BX.Crm.EntityEditorMoney,BX.Crm.EntityEditorField);BX.Crm.EntityEditorMoney.prototype.doInitialize=function(){this._changeAmountEditModeListener=BX.CrmNotifier.create(this)};BX.Crm.EntityEditorMoney.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorMoney.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorMoney.prototype.focus=function(){if(this._amountInput){BX.focus(this._amountInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._amountInput)}};BX.Crm.EntityEditorMoney.prototype.getValue=function(t){if(!this._model){return""}return this._model.getStringField(this.getAmountFieldName(),t!==undefined?t:"")};BX.Crm.EntityEditorMoney.prototype.getAmountValue=function(t){if(this._mode===BX.Crm.EntityEditorMode.edit&&this._amountValue){return this._amountValue.value}return this.getValue(t)};BX.Crm.EntityEditorMoney.prototype.getManualOpportunityValue=function(){if(this._mode===BX.Crm.EntityEditorMode.edit&&this._amountManualInput){return this._amountManualInput.value}return this.getManualOpportunity()};BX.Crm.EntityEditorMoney.prototype.setHasRelatedProducts=function(t){this._hasRelatedProducts=!!t};BX.Crm.EntityEditorMoney.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-money"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getTitle();var i=this.getData();var n=BX.prop.getString(i,"amount");var r=BX.prop.getString(BX.prop.getObject(i,"currency"),"name");var o=this._model.getField(BX.prop.getString(BX.prop.getObject(i,"currency"),"name",""));if(!BX.type.isNotEmptyString(o)){o=BX.Currency.Editor.getBaseCurrencyId()}this._selectedCurrencyValue=o;var s=this._editor.findOption(o,BX.prop.getArray(BX.prop.getObject(i,"currency"),"items"));var a=this.getAmountFieldName();var l=this.getCurrencyFieldName();var d=this._model.getField(a,"");var h=this._model.getField(BX.prop.getString(i,"formatted"),"");this._amountValue=null;this._amountManualInput=null;this._amountInput=null;this._currencyInput=null;this._selectContainer=null;this._innerWrapper=null;this._sumElement=null;var p=this.getManualOpportunity();var u=p!=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(e));this._amountValue=BX.create("input",{attrs:{name:n,type:"hidden",value:d}});if(u){this._amountManualInput=BX.create("input",{attrs:{name:"IS_MANUAL_OPPORTUNITY",type:"hidden",value:p}})}this._amountInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",type:"text",value:h}});BX.bind(this._amountInput,"input",this._changeHandler);if(this._model.isFieldLocked(a)){this._amountInput.disabled=true}this._currencyInput=BX.create("input",{attrs:{name:r,type:"hidden",value:o}});this._selectContainer=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:s});if(this._model.isFieldLocked(l)){this._selectContainer.disabled=true}else{BX.bind(this._selectContainer,"click",this._selectorClickHandler)}this._inputWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container crm-entity-widget-content-block-field-container-double"},children:[this._amountValue,this._amountInput,this._currencyInput,BX.create("div",{props:{className:"crm-entity-widget-content-block-select"+(this._selectContainer.disabled?"-disabled":"")},children:[this._selectContainer]})]});if(u){BX.bind(this._inputWrapper,"click",this._amountClickHandler);this._inputWrapper.appendChild(this._amountManualInput)}this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[this._inputWrapper]});this._currencyEditor=new BX.Currency.Editor({input:this._amountInput,currency:o,callback:BX.delegate(this.onAmountValueChange,this)});this._currencyEditor.changeValue()}else{this._wrapper.appendChild(this.createTitleNode(e));if(this.hasContentToDisplay()){this._sumElement=BX.create("span",{props:{className:"crm-entity-widget-content-block-wallet"}});this._sumElement.innerHTML=this.renderMoney();this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text crm-entity-widget-content-block-inner-text-pay"},children:[this._sumElement]})]})}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text crm-entity-widget-content-block-inner-text-pay"},text:this.getMessage("isEmpty")})]})}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorMoney.prototype.doClearLayout=function(t){BX.PopupMenu.destroy(this._id);if(this._currencyEditor){this._currencyEditor.clean();this._currencyEditor=null}this._amountValue=null;this._amountInput=null;this._currencyInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null};BX.Crm.EntityEditorMoney.prototype.refreshLayout=function(t){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Crm.EntityEditorMoney.superclass.refreshLayout.apply(this,arguments);return}if(this._mode===BX.Crm.EntityEditorMode.edit&&this._amountInput){if(this.getManualOpportunity()!=="Y"){var e=this._currencyEditor?this._currencyEditor.currency:this._model.getField(this.getCurrencyFieldName());if(!BX.type.isNotEmptyString(e)){e=BX.Currency.Editor.getBaseCurrencyId()}var i=this.getAmountFieldName();var n=this._model.getField(i);n=BX.Currency.Editor.trimTrailingZeros(n,e);this._amountValue.value=n;this._amountInput.value=BX.Currency.Editor.getFormattedValue(n,e)}this._amountInput.disabled=this._model.isFieldLocked(i);if(this._amountManualInput){this._amountManualInput.value=this.getManualOpportunity()}}else if(this._mode===BX.Crm.EntityEditorMode.view&&this._sumElement){this._sumElement.innerHTML=this.renderMoney()}};BX.Crm.EntityEditorMoney.prototype.getManualOpportunity=function(){return this._model.getField("IS_MANUAL_OPPORTUNITY",null)};BX.Crm.EntityEditorMoney.prototype.isContextMenuEnabled=function(){if(BX.Crm.EntityEditorMoney.superclass.isContextMenuEnabled.apply(this,arguments)){return true}return this.isLimitedContextMenuEnabled()};BX.Crm.EntityEditorMoney.prototype.isLimitedContextMenuEnabled=function(){return this._editor.isFieldsContextMenuEnabled()&&!this._editor.canChangeScheme()&&!this.getEditor().isReadOnly()&&this.getManualOpportunity()==="Y"};BX.Crm.EntityEditorMoney.prototype.doPrepareContextMenuItems=function(t){if(this.getManualOpportunity()==="Y"){var e=this.isLimitedContextMenuEnabled();if(e){t.splice(0,t.length)}else{t.push({delimiter:true})}t.push({text:BX.Crm.EntityEditorMoney.messages.manualOpportunitySetAutomatic,onclick:BX.delegate(function(){if(this._mode!==BX.Crm.EntityEditorMode.edit){this.switchToSingleEditMode()}this._changeAmountEditModeListener.notify([false]);this.closeContextMenu()},this)})}return t};BX.Crm.EntityEditorMoney.prototype.onAmountValueChange=function(t){if(this._amountValue){var e=parseFloat(this._amountValue.value);e=BX.Type.isNumber(e)?e:0;var i=parseFloat(t);i=BX.Type.isNumber(i)?i:0;if(e===i){return}this._amountValue.value=t}var n=this.getManualOpportunity();var r=n!=null;if(r&&this._amountManualInput){var o=t.length?parseFloat(t):0;o=isNaN(o)?0:o;if(o>0&&this._amountManualInput.value==="N"){this._amountManualInput.value="Y"}if(o===0&&this._amountManualInput.value==="Y"&&!this._hasRelatedProducts){this._amountManualInput.value="N"}}};BX.Crm.EntityEditorMoney.prototype.getAmountFieldName=function(){return this._schemeElement.getDataStringParam("amount","")};BX.Crm.EntityEditorMoney.prototype.getCurrencyFieldName=function(){return BX.prop.getString(this._schemeElement.getDataObjectParam("currency",{}),"name","")};BX.Crm.EntityEditorMoney.prototype.addChangeAmountEditModeListener=function(t){this._changeAmountEditModeListener.addListener(t)};BX.Crm.EntityEditorMoney.prototype.onAmountClick=function(t){if(t.target===this._amountInput&&this._model.isFieldLocked(this.getAmountFieldName())){this._changeAmountEditModeListener.notify([true])}};BX.Crm.EntityEditorMoney.prototype.onSelectorClick=function(t){this.openCurrencyMenu()};BX.Crm.EntityEditorMoney.prototype.openCurrencyMenu=function(){if(this._isCurrencyMenuOpened){return}var t=this._schemeElement.getData();var e=BX.prop.getArray(BX.prop.getObject(t,"currency"),"items");var i=0;var n=[];while(i<e.length){n.push({text:e[i]["NAME"],value:e[i]["VALUE"],onclick:BX.delegate(this.onCurrencySelect,this)});i++}BX.PopupMenu.show(this._id,this._selectContainer,n,{angle:false,width:this._selectContainer.offsetWidth+"px",events:{onPopupShow:BX.delegate(this.onCurrencyMenuOpen,this),onPopupClose:BX.delegate(this.onCurrencyMenuClose,this)}})};BX.Crm.EntityEditorMoney.prototype.closeCurrencyMenu=function(){if(!this._isCurrencyMenuOpened){return}var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorMoney.prototype.onCurrencyMenuOpen=function(){BX.addClass(this._selectContainer,"active");this._isCurrencyMenuOpened=true};BX.Crm.EntityEditorMoney.prototype.onCurrencyMenuClose=function(){BX.PopupMenu.destroy(this._id);BX.removeClass(this._selectContainer,"active");this._isCurrencyMenuOpened=false};BX.Crm.EntityEditorMoney.prototype.onCurrencySelect=function(t,e){this.closeCurrencyMenu();this._selectedCurrencyValue=this._currencyInput.value=e.value;this._selectContainer.innerHTML=BX.util.htmlspecialchars(e.text);if(this._currencyEditor){this._currencyEditor.setCurrency(this._selectedCurrencyValue)}this.markAsChanged({fieldName:this.getCurrencyFieldName(),fieldValue:this._selectedCurrencyValue})};BX.Crm.EntityEditorMoney.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getAmountFieldName()&&BX.prop.getString(t,"name","")!=="IS_MANUAL_OPPORTUNITY"){return}this.refreshLayout();if(BX.prop.getString(t,"name","")==="IS_MANUAL_OPPORTUNITY"){if(this._amountInput&&!this._amountInput.disabled){this._amountInput.focus()}}};BX.Crm.EntityEditorMoney.prototype.processModelLock=function(t){var e=BX.prop.getString(t,"name","");if(this.getAmountFieldName()===e){this.refreshLayout()}};BX.Crm.EntityEditorMoney.prototype.validate=function(t){if(!(this._mode===BX.Crm.EntityEditorMode.edit&&this._amountInput&&this._amountValue)){throw"BX.Crm.EntityEditorMoney. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._amountValue.value)!=="";if(!e){t.addError(BX.Crm.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._inputWrapper)}return e};BX.Crm.EntityEditorMoney.prototype.showError=function(t,e){BX.Crm.EntityEditorMoney.superclass.showError.apply(this,arguments);if(this._amountInput){BX.addClass(this._amountInput,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorMoney.prototype.clearError=function(){BX.Crm.EntityEditorMoney.superclass.clearError.apply(this);if(this._amountInput){BX.removeClass(this._amountInput,"crm-entity-widget-content-error")}};BX.Crm.EntityEditorMoney.prototype.getRuntimeValue=function(){var t=[];if(this._mode===BX.Crm.EntityEditorMode.edit){if(this._amountValue){t[BX.prop.getString(t,"amount")]=this._amountValue.value}t[BX.prop.getString(t,"currency")]=this._selectedCurrencyValue;return t}return""};BX.Crm.EntityEditorMoney.prototype.save=function(){var t=this._schemeElement.getData();this._model.setField(BX.prop.getString(BX.prop.getObject(t,"currency"),"name"),this._selectedCurrencyValue,{originator:this});if(this._amountValue){this._model.setField(BX.prop.getString(t,"amount"),this._amountValue.value,{originator:this});this._model.setField(BX.prop.getString(t,"formatted"),"",{originator:this});this._editor.formatMoney(this._amountValue.value,this._selectedCurrencyValue,BX.delegate(this.onMoneyFormatRequestSuccess,this))}};BX.Crm.EntityEditorMoney.prototype.onMoneyFormatRequestSuccess=function(t){var e=this._schemeElement.getData();var i=BX.type.isNotEmptyString(t["FORMATTED_SUM_WITH_CURRENCY"])?t["FORMATTED_SUM_WITH_CURRENCY"]:"";this._model.setField(BX.prop.getString(e,"formattedWithCurrency"),i);var n=BX.type.isNotEmptyString(t["FORMATTED_SUM"])?t["FORMATTED_SUM"]:"";this._model.setField(BX.prop.getString(e,"formatted"),n,{originator:this});if(this._sumElement){while(this._sumElement.firstChild){this._sumElement.removeChild(this._sumElement.firstChild)}this._sumElement.innerHTML=this.renderMoney()}};BX.Crm.EntityEditorMoney.prototype.renderMoney=function(){var t=this._schemeElement.getData();var e=this._model.getField(BX.prop.getString(t,"formattedWithCurrency"),"");var i=this._model.getField(BX.prop.getString(t,"formatted"),"");var n=BX.Currency.Editor.trimTrailingZeros(i,this._selectedCurrencyValue);return e.replace(i,'<span class="crm-entity-widget-content-block-colums-right">'+n+"</span>")};BX.Crm.EntityEditorMoney.create=function(t,e){var i=new BX.Crm.EntityEditorMoney;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMoneyPay==="undefined"){BX.Crm.EntityEditorMoneyPay=function(){BX.Crm.EntityEditorMoneyPay.superclass.constructor.apply(this);this._payButton=null};BX.Crm.EntityEditorMoneyPay.create=function(t,e){var i=new BX.Crm.EntityEditorMoneyPay;i.initialize(t,e);return i};BX.extend(BX.Crm.EntityEditorMoneyPay,BX.Crm.EntityEditorMoney);BX.Crm.EntityEditorMoneyPay.prototype.renderPayButton=function(){var t=BX.create("button",{props:{className:"crm-entity-widget-content-block-inner-pay-button ui-btn ui-btn-sm ui-btn-primary"},text:BX.Crm.EntityEditorMoneyPay.messages["payButtonLabel"]});BX.bind(t,"click",BX.delegate(this.startSalescenterApplication,this));BX.bind(t,"mousedown",function(t){BX.PreventDefault(t)});return t};BX.Crm.EntityEditorMoneyPay.prototype.layout=function(t){BX.Crm.EntityEditorMoneyPay.superclass.layout.apply(this,arguments);if(this._mode===BX.Crm.EntityEditorMode.view&&this.isNeedToDisplay()){this._payButton=this.renderPayButton();this._innerWrapper.firstChild.appendChild(this._payButton)}};BX.Crm.EntityEditorMoneyPay.prototype.startSalescenterApplication=function(){BX.loadExt("salescenter.manager").then(function(){BX.Salescenter.Manager.openApplication({disableSendButton:"",context:"deal",analyticsLabel:"salescenterClickButtonPay",ownerTypeId:BX.CrmEntityType.enumeration.deal,ownerId:this._model.getField("ID")}).then(function(t){if(t){var e=t.get("deal");if(e){if(e.PRODUCT_LIST){var i,n;for(n in this._editor._controllers){if(this._editor._controllers.hasOwnProperty(n)&&this._editor._controllers[n]._id==="PRODUCT_ROW_PROXY"){i=this._editor._controllers[n]._externalEditor;break}}if(i){i.reinitialize(e.PRODUCT_LIST)}}}}}.bind(this))}.bind(this))}}if(typeof BX.Crm.EntityEditorImage==="undefined"){BX.Crm.EntityEditorImage=function(){BX.Crm.EntityEditorImage.superclass.constructor.apply(this);this._innerWrapper=null;this._dialogShowHandler=BX.delegate(this.onDialogShow,this);this._dialogCloseHandler=BX.delegate(this.onDialogClose,this);this._fileChangeHandler=BX.delegate(this.onFileChange,this)};BX.extend(BX.Crm.EntityEditorImage,BX.Crm.EntityEditorField);BX.Crm.EntityEditorImage.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorImage.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorImage.prototype.hasContentToDisplay=function(){return this._mode===BX.Crm.EntityEditorMode.edit||this._model.getSchemeField(this._schemeElement,"showUrl","")!==""};BX.Crm.EntityEditorImage.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-file"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._editor.loadCustomHtml("RENDER_IMAGE_INPUT",{FIELD_NAME:e},BX.delegate(this.onEditorHtmlLoad,this))}else{this._wrapper.appendChild(this.createTitleNode(i));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});if(this.hasContentToDisplay()){this._innerWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-box"},children:[BX.create("img",{props:{className:"crm-entity-widget-content-block-photo",src:this._model.getSchemeField(this._schemeElement,"showUrl","")}})]}))}else{this._innerWrapper.appendChild(document.createTextNode(this.getMessage("isEmpty")))}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorImage.prototype.doClearLayout=function(t){if(this._innerWrapper){BX.removeCustomEvent(window,"onAfterPopupShow",this._dialogShowHandler);BX.removeCustomEvent(window,"onPopupClose",this._dialogCloseHandler);BX.cleanNode(this._innerWrapper);this._innerWrapper=null}this.unbindFileEvents()};BX.Crm.EntityEditorImage.prototype.onEditorHtmlLoad=function(t){if(this._mode===BX.Crm.EntityEditorMode.edit&&this._innerWrapper){this._innerWrapper.innerHTML=t;BX.addCustomEvent(window,"onAfterPopupShow",this._dialogShowHandler);BX.addCustomEvent(window,"onPopupClose",this._dialogCloseHandler);window.setTimeout(BX.delegate(this.bindFileEvents,this),500)}};BX.Crm.EntityEditorImage.prototype.bindFileEvents=function(){var t=BX.MFInput?BX.MFInput.get(this.getName().toLowerCase()+"_uploader"):null;if(t){BX.addCustomEvent(t,"onAddFile",this._fileChangeHandler);BX.addCustomEvent(t,"onDeleteFile",this._fileChangeHandler)}};BX.Crm.EntityEditorImage.prototype.unbindFileEvents=function(){var t=BX.MFInput?BX.MFInput.get(this.getName().toLowerCase()+"_uploader"):null;if(t){BX.removeCustomEvent(t,"onAddFile",this._fileChangeHandler);BX.removeCustomEvent(t,"onDeleteFile",this._fileChangeHandler)}};BX.Crm.EntityEditorImage.prototype.onDialogShow=function(t){if(t.uniquePopupId.indexOf("popupavatarEditor")!==0){return}BX.addCustomEvent(window,"onApply",this._fileChangeHandler);if(this._singleEditController){this._singleEditController.setActiveDelayed(false)}BX.bind(t.popupContainer,"click",function(t){BX.eventCancelBubble(t)})};BX.Crm.EntityEditorImage.prototype.onDialogClose=function(t){if(BX.prop.getString(t,"uniquePopupId","").indexOf("popupavatarEditor")!==0){return}BX.removeCustomEvent(window,"onApply",this._fileChangeHandler);if(this._singleEditController){this._singleEditController.setActiveDelayed(true)}};BX.Crm.EntityEditorImage.prototype.onFileChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorImage.create=function(t,e){var i=new BX.Crm.EntityEditorImage;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorUser==="undefined"){BX.Crm.EntityEditorUser=function(){BX.Crm.EntityEditorUser.superclass.constructor.apply(this);this._input=null;this._editButton=null;this._photoElement=null;this._nameElement=null;this._positionElement=null;this._userSelector=null;this._selectedData={};this._editButtonClickHandler=BX.delegate(this.onEditBtnClick,this)};BX.extend(BX.Crm.EntityEditorUser,BX.Crm.EntityEditorField);BX.Crm.EntityEditorUser.prototype.isSingleEditEnabled=function(){return true};BX.Crm.EntityEditorUser.prototype.getRelatedDataKeys=function(){return[this.getDataKey(),this._schemeElement.getDataStringParam("formated",""),this._schemeElement.getDataStringParam("position",""),this._schemeElement.getDataStringParam("showUrl",""),this._schemeElement.getDataStringParam("photoUrl","")]};BX.Crm.EntityEditorUser.prototype.hasContentToDisplay=function(){return true};BX.Crm.EntityEditorUser.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this._schemeElement.getName();var i=this._schemeElement.getTitle();var n=this._model.getField(e);var r=this._model.getSchemeField(this._schemeElement,"formated","");var o=this._model.getSchemeField(this._schemeElement,"position","");var s=this._model.getSchemeField(this._schemeElement,"showUrl","","");var a=this._model.getSchemeField(this._schemeElement,"photoUrl","");this._photoElement=BX.create("a",{props:{className:"crm-widget-employee-avatar-container",target:"_blank"},style:{backgroundImage:BX.type.isNotEmptyString(a)?"url('"+a+"')":"",backgroundSize:BX.type.isNotEmptyString(a)?"30px":""}});this._nameElement=BX.create("a",{props:{className:"crm-widget-employee-name",target:"_blank"},text:r});if(s!==""){this._photoElement.href=s;this._nameElement.href=s}this._positionElement=BX.create("SPAN",{props:{className:"crm-widget-employee-position"},text:o});if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));var l=BX.create("div",{props:{className:"crm-widget-employee-container"}});this._editButton=null;this._input=null;if(this._mode===BX.Crm.EntityEditorMode.edit||this.isEditInViewEnabled()&&!this.isReadOnly()){this._input=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._wrapper.appendChild(this._input);this._editButton=BX.create("span",{props:{className:"crm-widget-employee-change"},text:this.getMessage("change")});BX.bind(this._editButton,"click",this._editButtonClickHandler);l.appendChild(this._editButton)}l.appendChild(this._photoElement);l.appendChild(BX.create("span",{props:{className:"crm-widget-employee-info"},children:[this._nameElement,this._positionElement]}));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[l]}));if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorUser.prototype.doRegisterLayout=function(){if(this.isInEditMode()&&this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)){window.setTimeout(BX.delegate(this.openSelector,this),0)}};BX.Crm.EntityEditorUser.prototype.doClearLayout=function(t){this._input=null;this._editButton=null;this._photoElement=null;this._nameElement=null;this._positionElement=null};BX.Crm.EntityEditorUser.prototype.onEditBtnClick=function(t){if(this._mode===BX.Crm.EntityEditorMode.view&&this.isEditInViewEnabled()&&this.getEditor().isChanged()){this.switchToSingleEditMode()}else{this.openSelector()}};BX.Crm.EntityEditorUser.prototype.openSelector=function(){if(!this._userSelector){this._userSelector=BX.Crm.EntityEditorUserSelector.create(this._id,{callback:BX.delegate(this.processItemSelect,this)})}this._userSelector.open(this._editButton)};BX.Crm.EntityEditorUser.prototype.processItemSelect=function(t,e){var i=this._mode===BX.Crm.EntityEditorMode.view;var n=this.isEditInViewEnabled();if(i&&!n){return}this._selectedData={id:BX.prop.getInteger(e,"entityId",0),photoUrl:BX.prop.getString(e,"avatar",""),formattedNameHtml:BX.prop.getString(e,"name",""),positionHtml:BX.prop.getString(e,"desc","")};this._input.value=this._selectedData["id"];this._photoElement.style.backgroundImage=this._selectedData["photoUrl"]!==""?"url('"+this._selectedData["photoUrl"]+"')":"";this._photoElement.style.backgroundSize=this._selectedData["photoUrl"]!==""?"30px":"";this._nameElement.innerHTML=this._selectedData["formattedNameHtml"];this._positionElement.innerHTML=this._selectedData["positionHtml"];this._userSelector.close();if(!i){this.markAsChanged()}else{this._editor.saveControl(this)}};BX.Crm.EntityEditorUser.prototype.save=function(){var t=this._schemeElement.getData();if(this._selectedData["id"]>0){var e=this._selectedData["id"];this._model.setField(BX.prop.getString(t,"formated"),BX.util.htmlspecialcharsback(this._selectedData["formattedNameHtml"]));this._model.setField(BX.prop.getString(t,"position"),this._selectedData["positionHtml"]!=="&nbsp;"?BX.util.htmlspecialcharsback(this._selectedData["positionHtml"]):"");this._model.setField(BX.prop.getString(t,"showUrl"),BX.prop.getString(t,"pathToProfile").replace(/#user_id#/gi,e));this._model.setField(BX.prop.getString(t,"photoUrl"),this._selectedData["photoUrl"]);this._model.setField(this.getName(),e)}};BX.Crm.EntityEditorUser.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorUser.prototype.getRuntimeValue=function(){if(this._mode===BX.Crm.EntityEditorMode.edit&&this._selectedData["id"]>0){return this._selectedData["id"]}return""};BX.Crm.EntityEditorUser.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorUser.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorUser.superclass.getMessage.apply(this,arguments)};if(typeof BX.Crm.EntityEditorUser.messages==="undefined"){BX.Crm.EntityEditorUser.messages={}}BX.Crm.EntityEditorUser.create=function(t,e){var i=new BX.Crm.EntityEditorUser;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorAddress==="undefined"){BX.Crm.EntityEditorAddress=function(){BX.Crm.EntityEditorAddress.superclass.constructor.apply(this);this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorAddress,BX.Crm.EntityEditorField);BX.Crm.EntityEditorAddress.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorAddress.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorAddress.prototype.hasContentToDisplay=function(){return this._mode===BX.Crm.EntityEditorMode.edit||this.getViewHtml()!==""};BX.Crm.EntityEditorAddress.prototype.getViewHtml=function(){var t=this._schemeElement.getDataStringParam("view","");if(t===""){t=this._schemeElement.getName()+"_HML"}return this._model.getStringField(t,"")};BX.Crm.EntityEditorAddress.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this._schemeElement.getName();var i=this.getTitle();var n=this._schemeElement.getDataObjectParam("fields",{});var r=this._schemeElement.getDataObjectParam("labels",{});this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));if(this._mode===BX.Crm.EntityEditorMode.edit){var o=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner-address"}});this._innerWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[o]})]});for(var s in n){if(!n.hasOwnProperty(s)){return}var a=n[s];var l=BX.prop.getString(r,s,s);this.layoutField(s,a,l,o)}BX.bindDelegate(o,"bxchange",{tag:["input","textarea"]},this._changeHandler)}else{if(this.hasContentToDisplay()){this._innerWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner-text"},html:this.getViewHtml()})]})}else{this._innerWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorAddress.prototype.layoutField=function(t,e,i,n){var r=BX.prop.getString(e,"NAME",t);var o=this._model.getStringField(r,"");n.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:i})]}));if(BX.prop.getBoolean(e,"IS_MULTILINE",false)){n.appendChild(BX.create("textarea",{props:{className:"crm-entity-widget-content-input",name:r,value:o}}))}else{n.appendChild(BX.create("input",{props:{className:"crm-entity-widget-content-input",name:r,type:"text",value:o}}))}};BX.Crm.EntityEditorAddress.prototype.doClearLayout=function(t){this._innerWrapper=null};BX.Crm.EntityEditorAddress.create=function(t,e){var i=new BX.Crm.EntityEditorAddress;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultifieldItem==="undefined"){BX.Crm.EntityEditorMultifieldItem=function(){this._id="";this._settings={};this._parent=null;this._editor=null;this._mode=BX.Crm.EntityEditorMode.view;this._data=null;this._typeId="";this._valueTypeItems=null;this._container=null;this._wrapper=null;this._valueInput=null;this._valueTypeInput=null;this._valueTypeSelector=null;this._deleteButton=null;this._deleteButtonHandler=BX.delegate(this.onDeleteButtonClick,this);this._isJunked=false;this._hasLayout=false};BX.Crm.EntityEditorMultifieldItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._parent=BX.prop.get(this._settings,"parent",null);this._editor=this._parent.getEditor();this._mode=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.view);this._typeId=BX.prop.getString(this._settings,"typeId","");this._data=BX.prop.getObject(this._settings,"data",{});this._valueTypeItems=BX.prop.getArray(this._settings,"valueTypeItems",[]);this._container=BX.prop.getElementNode(this._settings,"container",null)},getId:function(){return this._id},isEmpty:function(){return BX.util.trim(this.getValue())===""},getTypeId:function(){return this._typeId},getValue:function(){return BX.prop.getString(this._data,"VALUE","")},getValueId:function(){return BX.prop.getString(this._data,"ID","")},getValueTypeId:function(){var t=BX.prop.getString(this._data,"VALUE_TYPE","");return t!==""?t:this.getDefaultValueTypeId()},getDefaultValueTypeId:function(){return this._valueTypeItems.length>0?BX.prop.getString(this._valueTypeItems[0],"VALUE"):""},getViewData:function(){return BX.prop.getObject(this._data,"VIEW_DATA",{})},resolveValueTypeName:function(t){if(t===""){return""}for(var e=0,i=this._valueTypeItems.length;e<i;e++){var n=this._valueTypeItems[e];if(t===BX.prop.getString(n,"VALUE","")){return BX.prop.getString(n,"NAME",t)}}return t},prepareControlName:function(t){return this.getTypeId()+"["+this.getValueId()+"]"+"["+t+"]"},getMode:function(){return this._mode},setMode:function(t){this._mode=t},getContainer:function(){return this._container},setContainer:function(t){this._container=t;if(this._hasLayout){this.clearLayout()}},focus:function(){if(this._valueInput){BX.focus(this._valueInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._valueInput)}},layout:function(){if(this._hasLayout){return}this._valueInput=null;this._valueTypeInput=null;this._valueTypeSelector=null;this._deleteButton=null;var t=this.getValueTypeId();var e=this.getValue();this._wrapper=BX.create("div");this._container.appendChild(this._wrapper);if(this._mode===BX.Crm.EntityEditorMode.edit){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-container crm-entity-widget-content-block-field-container-double");this._valueInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",name:this.prepareControlName("VALUE"),type:"text",value:e}});BX.bind(this._valueInput,"input",BX.delegate(this.onValueChange,this));this._wrapper.appendChild(this._valueInput);this._valueTypeInput=BX.create("input",{attrs:{name:this.prepareControlName("VALUE_TYPE"),type:"hidden",value:t}});this._wrapper.appendChild(this._valueTypeInput);this._valueTypeSelector=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:this.resolveValueTypeName(t),events:{click:BX.delegate(this.onValueTypeSelectorClick,this)}});this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-select"},children:[this._valueTypeSelector]}));this._deleteButton=BX.create("div",{attrs:{className:"crm-entity-widget-content-remove-block"}});this._wrapper.appendChild(this._deleteButton);BX.bind(this._deleteButton,"click",this._deleteButtonHandler);if(this._editor.isDuplicateControlEnabled()){var i=this._parent.getDuplicateControlConfig();if(i){if(!BX.type.isPlainObject(i["field"])){i["field"]={}}i["field"]["id"]=this.getValueId();i["field"]["element"]=this._valueInput;this._editor.getDuplicateManager().registerField(i)}}}else if(this._mode===BX.Crm.EntityEditorMode.view&&!this.isEmpty()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-mutlifield");var n=this.getViewData();var r=BX.prop.getString(n,"value","");if(r===""){r=BX.util.htmlspecialchars(e)}this._wrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-type"},text:this.resolveValueTypeName(t)}));var o=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-value"},html:r});this._wrapper.appendChild(o);if(this._parent.getMultifieldType()==="EMAIL"){var s=o.querySelector("a.crm-entity-email");if(s){BX.bind(s,"click",BX.delegate(this.onEmailClick,this))}}}this._hasLayout=true},clearLayout:function(){if(!this._hasLayout){return}if(this._editor.isDuplicateControlEnabled()){var t=this._parent.getDuplicateControlConfig();if(t){if(!BX.type.isPlainObject(t["field"])){t["field"]={}}t["field"]["id"]=this.getValueId();this._editor.getDuplicateManager().unregisterField(t)}}this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},adjust:function(){if(this._hasLayout){this._wrapper.style.display=this._isJunked?"none":""}},onValueChange:function(t){this._parent.processItemChange(this)},onValueTypeSelectorClick:function(t){var e=[];for(var i=0,n=this._valueTypeItems.length;i<n;i++){var r=this._valueTypeItems[i];e.push({text:r["NAME"],value:r["VALUE"],onclick:BX.delegate(this.onValueTypeSelect,this)})}BX.addClass(this._valueTypeSelector,"active");BX.PopupMenu.destroy(this._id);BX.PopupMenu.show(this._id,this._valueTypeSelector,e,{angle:false,width:this._valueTypeSelector.offsetWidth+"px",events:{onPopupClose:BX.delegate(this.onValueTypeMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._valueTypeSelector)["width"])},onValueTypeMenuClose:function(t){BX.removeClass(this._valueTypeSelector,"active")},onValueTypeSelect:function(t,e){BX.removeClass(this._valueTypeSelector,"active");this._valueTypeInput.value=e.value;this._valueTypeSelector.innerHTML=BX.util.htmlspecialchars(e.text);this._parent.processItemChange(this);BX.PopupMenu.destroy(this._id)},isJunked:function(){return this._isJunked},markAsJunked:function(t){t=!!t;if(this._isJunked!==t){this._isJunked=t;if(this._isJunked){this._valueInput.value=""}this.adjust()}},onEmailClick:function(t){if(BX.CrmActivityEditor){var e=this._editor.getOwnerInfo();var i={ownerType:e["ownerType"],ownerID:e["ownerID"],communications:[{entityType:e["ownerType"],entityId:e["ownerID"],type:"EMAIL",value:this.getValue()}]};BX.CrmActivityEditor.addEmail(i)}return BX.PreventDefault(t)},onDeleteButtonClick:function(t){this._parent.processItemDeletion(this)}};BX.Crm.EntityEditorMultifieldItem.create=function(t,e){var i=new BX.Crm.EntityEditorMultifieldItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultifieldItemPhone==="undefined"){BX.Crm.EntityEditorMultifieldItemPhone=function(){BX.Crm.EntityEditorMultifieldItemPhone.superclass.constructor.apply(this);this._maskedPhone=null;this._maskedValueInput=null;this._countryFlagNode=null};BX.extend(BX.Crm.EntityEditorMultifieldItemPhone,BX.Crm.EntityEditorMultifieldItem);BX.Crm.EntityEditorMultifieldItemPhone.prototype.layout=function(){var t=this;if(this._hasLayout){return}this._valueInput=null;this._valueTypeInput=null;this._valueTypeSelector=null;var e=this.getValueTypeId();var i=this.getValue();this._wrapper=BX.create("div");this._container.appendChild(this._wrapper);if(this._mode===BX.Crm.EntityEditorMode.edit){BX.addClass(this._wrapper,"crm-entity-widget-content-block-field-container crm-entity-widget-content-block-field-container-double");this._valueInput=BX.create("input",{attrs:{name:this.prepareControlName("VALUE"),type:"hidden",value:i}});this._wrapper.appendChild(this._valueInput);this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-input-phone-wrapper"},children:[this._countryFlagNode=BX.create("span",{props:{className:"crm-entity-widget-content-country-flag"}}),this._maskedValueInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input crm-entity-widget-content-input-phone",type:"text",value:i}})]}));this._maskedPhone=new BX.PhoneNumber.Input({node:this._maskedValueInput,flagNode:this._countryFlagNode,flagSize:24,onChange:function(e){t._valueInput.value=e.value;t.onValueChange()}});this._valueTypeInput=BX.create("input",{attrs:{name:this.prepareControlName("VALUE_TYPE"),type:"hidden",value:e}});this._wrapper.appendChild(this._valueTypeInput);this._valueTypeSelector=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:this.resolveValueTypeName(e),events:{click:BX.delegate(this.onValueTypeSelectorClick,this)}});this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-select"},children:[this._valueTypeSelector]}));this._deleteButton=BX.create("div",{attrs:{className:"crm-entity-widget-content-remove-block"}});this._wrapper.appendChild(this._deleteButton);BX.bind(this._deleteButton,"click",this._deleteButtonHandler);if(this._editor.isDuplicateControlEnabled()){var n=this._parent.getDuplicateControlConfig();if(n){if(!BX.type.isPlainObject(n["field"])){n["field"]={}}n["field"]["id"]=this.getValueId();n["field"]["element"]=this._maskedValueInput;this._editor.getDuplicateManager().registerField(n)}}}else if(this._mode===BX.Crm.EntityEditorMode.view&&!this.isEmpty()){BX.addClass(this._wrapper,"crm-entity-widget-content-block-mutlifield");var r=this.getViewData();var o=BX.prop.getString(r,"value","");if(o===""){o=BX.util.htmlspecialchars(i)}this._wrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-type"},text:this.resolveValueTypeName(e)}));this._wrapper.appendChild(BX.create("span",{attrs:{className:"crm-entity-widget-content-block-mutlifield-value"},html:o}))}this._hasLayout=true};BX.Crm.EntityEditorMultifieldItemPhone.prototype.focus=function(){if(this._maskedValueInput){BX.focus(this._maskedValueInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._maskedValueInput)}};BX.Crm.EntityEditorMultifieldItemPhone.create=function(t,e){var i=new BX.Crm.EntityEditorMultifieldItemPhone;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorMultifield==="undefined"){BX.Crm.EntityEditorMultifield=function(){BX.Crm.EntityEditorMultifield.superclass.constructor.apply(this);this._items=null;this._itemWrapper=null};BX.extend(BX.Crm.EntityEditorMultifield,BX.Crm.EntityEditorField);BX.Crm.EntityEditorMultifield.prototype.doInitialize=function(){this.initializeItems()};BX.Crm.EntityEditorMultifield.prototype.initializeItems=function(){var t=this.getName();var e=this._model.getField(t,[]);if(e.length===0){e.push({ID:"n0"})}for(var i=0,n=e.length;i<n;i++){this.addItem(e[i])}};BX.Crm.EntityEditorMultifield.prototype.findItemIndex=function(t){if(!this._items){return-1}for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1};BX.Crm.EntityEditorMultifield.prototype.resetItems=function(){if(this._hasLayout){for(var t=0,e=this._items.length;t<e;t++){this._items[t].clearLayout()}}this._items=[]};BX.Crm.EntityEditorMultifield.prototype.deleteItem=function(t){if(!this._items){return}var e=this.findItemIndex(t);if(e>=0){this._items[e].markAsJunked(true)}};BX.Crm.EntityEditorMultifield.prototype.reset=function(){this.resetItems();this.initializeItems()};BX.Crm.EntityEditorMultifield.prototype.hasContentToDisplay=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){return true}var t=this._items.length;if(t===0){return false}for(var e=0;e<t;e++){if(!this._items[e].isEmpty()){return true}}return false};BX.Crm.EntityEditorMultifield.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorMultifield.prototype.getContentWrapper=function(){return this._itemWrapper};BX.Crm.EntityEditorMultifield.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorMultifield.prototype.prepareItemsLayout=function(){for(var t=0,e=this._items.length;t<e;t++){var i=this._items[t];i.setMode(this._mode);i.setContainer(this._itemWrapper);i.layout()}};BX.Crm.EntityEditorMultifield.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorMultifield.prototype.getContentWrapper=function(){return this._itemWrapper};BX.Crm.EntityEditorMultifield.prototype.focus=function(){if(this._items&&this._items.length>0){this._items[this._items.length-1].focus()}};BX.Crm.EntityEditorMultifield.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-multifield"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}this._itemWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._itemWrapper=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._itemWrapper);if(this.hasContentToDisplay()){this.prepareItemsLayout()}else if(this._mode===BX.Crm.EntityEditorMode.view){this._itemWrapper.appendChild(document.createTextNode(this.getMessage("isEmpty")))}if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-add-field"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-add-field"},text:this.getMessage("add"),events:{click:BX.delegate(this.onAddButtonClick,this)}})]}))}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorMultifield.prototype.doClearLayout=function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];n.clearLayout();n.setContainer(null)}this._itemWrapper=null};BX.Crm.EntityEditorMultifield.prototype.refreshLayout=function(t){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Crm.EntityEditorMultifield.superclass.refreshLayout.apply(this,arguments);return}this.resetItems();BX.cleanNode(this._itemWrapper);this.initializeItems();if(this.hasContentToDisplay()){this.prepareItemsLayout()}else if(this._mode===BX.Crm.EntityEditorMode.view){this._itemWrapper.appendChild(document.createTextNode(this.getMessage("isEmpty")))}};BX.Crm.EntityEditorMultifield.prototype.getMultifieldType=function(){return this._schemeElement.getDataStringParam("type","")};BX.Crm.EntityEditorMultifield.prototype.addItem=function(t){var e;var i=this._schemeElement.getName();if(i==="PHONE"){e=BX.Crm.EntityEditorMultifieldItemPhone.create("",{parent:this,typeId:this._schemeElement.getName(),valueTypeItems:this._schemeElement.getDataArrayParam("items",[]),data:t})}else{e=BX.Crm.EntityEditorMultifieldItem.create("",{parent:this,typeId:this._schemeElement.getName(),valueTypeItems:this._schemeElement.getDataArrayParam("items",[]),data:t})}if(this._items===null){this._items=[]}this._items.push(e);if(this._hasLayout){e.setMode(this._mode);e.setContainer(this._itemWrapper);e.layout()}return e};BX.Crm.EntityEditorMultifield.prototype.onAddButtonClick=function(t){this.addItem({ID:"n"+this._items.length.toString()})};BX.Crm.EntityEditorMultifield.prototype.processItemChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorMultifield.prototype.processItemDeletion=function(t){this.deleteItem(t);this.markAsChanged()};BX.Crm.EntityEditorMultifield.create=function(t,e){var i=new BX.Crm.EntityEditorMultifield;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorFieldConfigurator==="undefined"){BX.Crm.EntityEditorFieldConfigurator=function(){BX.Crm.EntityEditorFieldConfigurator.superclass.constructor.apply(this);this._field=null;this._name=null;this._isLocked=false;this._labelInput=null;this._isRequiredCheckBox=null;this._showAlwaysCheckBox=null;this._saveButton=null;this._cancelButton=null;this._optionWrapper=null;this._mandatoryConfigurator=null};BX.extend(BX.Crm.EntityEditorFieldConfigurator,BX.Crm.EntityEditorControl);BX.Crm.EntityEditorFieldConfigurator.prototype.doInitialize=function(){BX.Crm.EntityEditorFieldConfigurator.superclass.doInitialize.apply(this);this._field=BX.prop.get(this._settings,"field",null);this._name=BX.prop.getString(this._fieldData,"name","");this._mandatoryConfigurator=BX.prop.get(this._settings,"mandatoryConfigurator",null)};BX.Crm.EntityEditorFieldConfigurator.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorFieldConfigurator.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorFieldConfigurator.prototype.layout=function(t){if(this._hasLayout){return}if(this._mode===BX.Crm.EntityEditorMode.view){throw"EntityEditorFieldConfigurator. View mode is not supported by this control type."}this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-new-fields"}});this._labelInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",type:"text",value:this._field.getTitle()}});this._saveButton=BX.create("span",{props:{className:"ui-btn ui-btn-primary"},text:BX.message("CRM_EDITOR_SAVE"),events:{click:BX.delegate(this.onSaveButtonClick,this)}});this._cancelButton=BX.create("span",{props:{className:"ui-btn ui-btn-light-border"},text:BX.message("CRM_EDITOR_CANCEL"),events:{click:BX.delegate(this.onCancelButtonClick,this)}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:this.getMessage("labelField")})]}),BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:[this._labelInput]})]})]}));this._optionWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-checkbox"},children:[this._optionWrapper]}));if(this._field.areAttributesEnabled()&&!this._field.isRequired()&&this._mandatoryConfigurator){this._isRequiredCheckBox=this.createOption({caption:this._mandatoryConfigurator.getTitle()+":",labelSettings:{props:{className:"crm-entity-new-field-addiction-label"}},containerSettings:{style:{alignItems:"center"}},elements:this._mandatoryConfigurator.getButton().prepareLayout()});this._isRequiredCheckBox.checked=!this._mandatoryConfigurator.isEmpty();this._mandatoryConfigurator.setSwitchCheckBox(this._isRequiredCheckBox);this._mandatoryConfigurator.setLabel(this._isRequiredCheckBox.nextSibling);this._mandatoryConfigurator.setEnabled(this._isRequiredCheckBox.checked);this._mandatoryConfigurator.adjust()}this._showAlwaysCheckBox=this.createOption({caption:this.getMessage("showAlways"),help:{code:"7046149"}});this._showAlwaysCheckBox.checked=this._field.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways);this._wrapper.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-new-fields-btn-container"},children:[this._saveButton,this._cancelButton]}));this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorFieldConfigurator.prototype.clearLayout=function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._labelInput=null;this._isRequiredCheckBox=null;this._showAlwaysCheckBox=null;this._saveButton=null;this._cancelButton=null;this._optionWrapper=null;this._hasLayout=false};BX.Crm.EntityEditorFieldConfigurator.prototype.onSaveButtonClick=function(t){if(this._isLocked){return}if(this._mandatoryConfigurator){if(this._mandatoryConfigurator.isChanged()){this._mandatoryConfigurator.acceptChanges()}this._mandatoryConfigurator.close()}var e={field:this._field,label:this._labelInput.value,showAlways:this._showAlwaysCheckBox.checked};BX.onCustomEvent(this,"onSave",[this,e])};BX.Crm.EntityEditorFieldConfigurator.prototype.onCancelButtonClick=function(t){if(this._isLocked){return}var e={field:this._field};BX.onCustomEvent(this,"onCancel",[this,e])};BX.Crm.EntityEditorFieldConfigurator.prototype.setLocked=function(t){t=!!t;if(this._isLocked===t){return}this._isLocked=t;if(this._isLocked){BX.addClass(this._saveButton,"ui-btn-clock")}else{BX.removeClass(this._saveButton,"ui-btn-clock")}};BX.Crm.EntityEditorFieldConfigurator.prototype.getField=function(){return this._field};BX.Crm.EntityEditorFieldConfigurator.prototype.createOption=function(t){var e=BX.create("input",{props:{type:"checkbox"}});var i=BX.create("label",{children:[e,BX.create("span",{text:BX.prop.getString(t,"caption","")})]});var n=BX.prop.getObject(t,"labelSettings",null);if(n){BX.adjust(i,n)}var r=BX.prop.getObject(t,"help",null);if(r){var o=BX.create("a",{props:{className:"crm-entity-new-field-helper-icon"}});var s=BX.prop.getString(r,"url","");if(s!==""){o.href=s;o.target="_blank"}else{o.href="#";BX.bind(o,"click",function(t){window.top.BX.Helper.show("redirect=detail&code="+BX.prop.getString(r,"code",""));t.preventDefault()})}i.appendChild(o)}var a=[i];var l=BX.prop.getArray(t,"elements",[]);for(var d=0,h=l.length;d<h;d++){a.push(l[d])}var p=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"},children:a});var u=BX.prop.getObject(t,"containerSettings",null);if(u){BX.adjust(p,u)}this._optionWrapper.appendChild(p);return e};if(typeof BX.Crm.EntityEditorFieldConfigurator.messages==="undefined"){BX.Crm.EntityEditorFieldConfigurator.messages={}}BX.Crm.EntityEditorFieldConfigurator.create=function(t,e){var i=new BX.Crm.EntityEditorFieldConfigurator;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorProductRowSummary==="undefined"){BX.Crm.EntityEditorProductRowSummary=function(){BX.Crm.EntityEditorProductRowSummary.superclass.constructor.apply(this);this._loader=null;this._table=null;this._itemCount=0;this._totalCount=0;this._moreButton=null;this._moreButtonRow=null;this._moreButtonClickHandler=BX.delegate(this._onMoreButtonClick,this)};BX.extend(BX.Crm.EntityEditorProductRowSummary,BX.Crm.EntityEditorField);BX.Crm.EntityEditorProductRowSummary.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorProductRowSummary.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorProductRowSummary.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorProductRowSummary.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({});this.adjustWrapper();var e=this.getValue();if(!BX.type.isPlainObject(e)){return}var i=this.getTitle();var n=BX.prop.getArray(e,"items",[]);this._totalCount=BX.prop.getInteger(e,"count",0);if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));this._table=BX.create("table",{props:{className:"crm-entity-widget-content-block-products-list"}});var r=this._itemCount=n.length;var o=0;if(r>5){o=this._totalCount-5;r=5}for(var s=0;s<r;s++){this.addProductRow(n[s],-1)}var a,l;this._moreButton=null;if(o>0){a=this._moreButtonRow=this._table.insertRow(-1);a.className="crm-entity-widget-content-block-products-item";l=a.insertCell(-1);l.className="crm-entity-widget-content-block-products-item-name";this._moreButton=BX.create("span",{attrs:{className:"crm-entity-widget-content-block-products-show-more"},events:{click:this._moreButtonClickHandler},text:this.getMessage("notShown").replace(/#COUNT#/gi,o.toString())});l.appendChild(this._moreButton);l=a.insertCell(-1);l.className="crm-entity-widget-content-block-products-price"}a=this._table.insertRow(-1);a.className="crm-entity-widget-content-block-products-item";l=a.insertCell(-1);l.className="crm-entity-widget-content-block-products-item-name";l.innerHTML=this.getMessage("total");l=a.insertCell(-1);l.className="crm-entity-widget-content-block-products-price";l.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-products-price-value"},html:e["total"]}));this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-products"},children:[this._table]}));if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorProductRowSummary.prototype._onMoreButtonClick=function(t){if(this._totalCount>10){BX.onCustomEvent(window,"OpenEntityDetailTab",["tab_products"]);return}this._moreButtonRow.style.display="none";var e=this.getValue();var i=BX.prop.getArray(e,"items",[]);for(var n=5;n<this._itemCount;n++){this.addProductRow(i[n],n)}};BX.Crm.EntityEditorProductRowSummary.prototype.clearLayout=function(){if(!this._hasLayout){return}this._table=null;this._moreButton=null;this._moreButtonRow=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false};BX.Crm.EntityEditorProductRowSummary.prototype.addProductRow=function(t,e){if(typeof e==="undefined"){e=-1}var i,n;i=this._table.insertRow(e);i.className="crm-entity-widget-content-block-products-item";n=i.insertCell(-1);n.className="crm-entity-widget-content-block-products-item-name";var r=BX.prop.getString(t,"URL","");if(r!==""){n.appendChild(BX.create("a",{attrs:{target:"_blank",href:r},text:t["PRODUCT_NAME"]}))}else{n.innerHTML=BX.util.htmlspecialchars(t["PRODUCT_NAME"])}n=i.insertCell(-1);n.className="crm-entity-widget-content-block-products-price";n.appendChild(BX.create("div",{attrs:{className:"crm-entity-widget-content-block-products-price-value"},html:t["SUM"]}))};if(typeof BX.Crm.EntityEditorProductRowSummary.messages==="undefined"){BX.Crm.EntityEditorProductRowSummary.messages={}}BX.Crm.EntityEditorProductRowSummary.create=function(t,e){var i=new BX.Crm.EntityEditorProductRowSummary;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorFileStorage==="undefined"){BX.Crm.EntityEditorFileStorage=function(){BX.Crm.EntityEditorFileStorage.superclass.constructor.apply(this);this._uploaderName="entity_editor_storage_"+this._id.toLowerCase();this._dataContainer=null;this._uploaderContainer=null};BX.extend(BX.Crm.EntityEditorFileStorage,BX.Crm.EntityEditorField);BX.Crm.EntityEditorFileStorage.prototype.getStorageTypeId=function(){return this._model.getIntegerField("STORAGE_TYPE_ID",BX.Crm.EditorFileStorageType.undefined)};BX.Crm.EntityEditorFileStorage.prototype.getStorageElementInfos=function(){var t=this.getStorageTypeId();if(t===BX.Crm.EditorFileStorageType.diskfile){return this._model.getArrayField(this._schemeElement.getDataStringParam("diskFileInfo","DISK_FILES"),[])}return[]};BX.Crm.EntityEditorFileStorage.prototype.hasContentToDisplay=function(){return this.getStorageElementInfos().length>0};BX.Crm.EntityEditorFileStorage.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-filestorage"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));if(this._mode===BX.Crm.EntityEditorMode.edit){this._dataContainer=BX.create("DIV",{});this._wrapper.appendChild(this._dataContainer)}this._uploaderContainer=BX.create("DIV",{attrs:{className:"bx-crm-dialog-activity-webdav-container"}});this._wrapper.appendChild(this._uploaderContainer);var e=this.getStorageTypeId();if(e===BX.Crm.EditorFileStorageType.diskfile){var i=this.prepareDiskUploader();i.setMode(this._mode);i.clearValues();i.setValues(this.getStorageElementInfos());i.layout(this._uploaderContainer)}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorFileStorage.prototype.doClearLayout=function(t){this._dataContainer=this._uploaderContainer=null};BX.Crm.EntityEditorFileStorage.prototype.prepareDiskUploader=function(){var t=null;if(typeof BX.CrmDiskUploader!=="undefined"&&typeof BX.CrmDiskUploader.items[this._uploaderName]!=="undefined"){t=BX.CrmDiskUploader.items[this._uploaderName]}if(t){t.cleanLayout()}else{t=BX.CrmDiskUploader.create(this._uploaderName,{msg:{diskAttachFiles:this.getMessage("diskAttachFiles"),diskAttachedFiles:this.getMessage("diskAttachedFiles"),diskSelectFile:this.getMessage("diskSelectFile"),diskSelectFileLegend:this.getMessage("diskSelectFileLegend"),diskUploadFile:this.getMessage("diskUploadFile"),diskUploadFileLegend:this.getMessage("diskUploadFileLegend")}})}return t};BX.Crm.EntityEditorFileStorage.prototype.getDiskUploaderValues=function(){var t=BX.CrmDiskUploader.items[this._uploaderName];return t?t.getFileIds():[]};BX.Crm.EntityEditorFileStorage.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorFileStorage.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorFileStorage.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorFileStorage.prototype.save=function(){var t=this.getStorageTypeId();if(t===BX.Crm.EditorFileStorageType.diskfile){this._model.setField(this._schemeElement.getDataStringParam("storageElementIds","STORAGE_ELEMENT_IDS"),this.getDiskUploaderValues())}};BX.Crm.EntityEditorFileStorage.prototype.onBeforeSubmit=function(){if(!this._dataContainer){return}BX.cleanNode(this._dataContainer,false);this._dataContainer.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:this._schemeElement.getDataStringParam("storageTypeId","STORAGE_TYPE_ID"),value:this.getStorageTypeId()}}));var t=this._schemeElement.getDataStringParam("storageElementIds","STORAGE_ELEMENT_IDS");var e=this._model.getArrayField(t,[]);if(e.length>0){for(var i=0,n=e.length;i<n;i++){this._dataContainer.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:t+"[]",value:e[i]}}))}}else{this._dataContainer.appendChild(BX.create("INPUT",{attrs:{type:"hidden",name:t,value:""}}))}};if(typeof BX.Crm.EntityEditorFileStorage.messages==="undefined"){BX.Crm.EntityEditorFileStorage.messages={}}BX.Crm.EntityEditorFileStorage.create=function(t,e){var i=new BX.Crm.EntityEditorFileStorage;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorCustom==="undefined"){BX.Crm.EntityEditorCustom=function(){BX.Crm.EntityEditorCustom.superclass.constructor.apply(this);this._innerWrapper=null;this._runtimeValue=null};BX.extend(BX.Crm.EntityEditorCustom,BX.Crm.EntityEditorField);BX.Crm.EntityEditorCustom.prototype.hasContentToDisplay=function(){return this.getHtmlContent()!==""};BX.Crm.EntityEditorCustom.prototype.doClearLayout=function(t){this.setRuntimeValue(this.getValue())};BX.Crm.EntityEditorCustom.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorCustom.prototype.layout=function(t){if(this._hasLayout){return}var e=this._schemeElement.getDataArrayParam("classNames",[]);e.push("crm-entity-widget-content-block-field-custom");this.ensureWrapperCreated({classNames:e});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._innerWrapper);if(this._mode===BX.Crm.EntityEditorMode.edit){BX.addClass(this._innerWrapper,"crm-entity-widget-content-block-inner-edit-mode")}var i=this.getHtmlContent();if(this._mode!==BX.Crm.EntityEditorMode.edit&&!BX.type.isNotEmptyString(i)){i=this._model.getSchemeField(this._schemeElement,"empty","")}setTimeout(BX.delegate(function(){BX.html(this._innerWrapper,i);if(this._mode===BX.Crm.EntityEditorMode.edit){BX.bindDelegate(this._innerWrapper,"bxchange",{tag:["input","select","textarea"]},this._changeHandler)}},this),0);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorCustom.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorCustom.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Crm.EntityEditorCustom.prototype.getHtmlContent=function(){return this._model.getSchemeField(this._schemeElement,this.isInEditMode()?"edit":"view","")};BX.Crm.EntityEditorCustom.prototype.setRuntimeValue=function(t){this._runtimeValue=t};BX.Crm.EntityEditorCustom.prototype.getRuntimeValue=function(){return this._mode===BX.Crm.EntityEditorMode.edit?this._runtimeValue:""};BX.Crm.EntityEditorCustom.create=function(t,e){var i=new BX.Crm.EntityEditorCustom;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorHidden==="undefined"){BX.Crm.EntityEditorHidden=function(){BX.Crm.EntityEditorHidden.superclass.constructor.apply(this);this._input=null;this._view=null};BX.extend(BX.Crm.EntityEditorHidden,BX.Crm.EntityEditorText);BX.Crm.EntityEditorHidden.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-text"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();this._input=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));if(this.hasContentToDisplay()){if(this.getLineCount()>1){this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},html:BX.util.nl2br(BX.util.htmlspecialchars(n))})}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:n})}}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}if(this._mode===BX.Crm.EntityEditorMode.edit){this._input=BX.create("input",{props:{id:"crm-entity-widget-content-input",name:e,type:"hidden",value:n}});this._innerWrapper.appendChild(this._input)}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorHidden.create=function(t,e){var i=new BX.Crm.EntityEditorHidden;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityBindingTracker==="undefined"){BX.Crm.EntityBindingTracker=function(){this._id="";this._settings={};this._boundEntityInfos=null;this._unboundEntityInfos=null};BX.Crm.EntityBindingTracker.prototype={initialize:function(){this._boundEntityInfos=[];this._unboundEntityInfos=[]},bind:function(t){if(this.findIndex(t,this._boundEntityInfos)>=0){return}var e=this.findIndex(t,this._unboundEntityInfos);if(e>=0){this._unboundEntityInfos.splice(e,1)}else{this._boundEntityInfos.push(t)}},unbind:function(t){if(this.findIndex(t,this._unboundEntityInfos)>=0){return}var e=this.findIndex(t,this._boundEntityInfos);if(e>=0){this._boundEntityInfos.splice(e,1)}else{this._unboundEntityInfos.push(t)}},getBoundEntities:function(){return this._boundEntityInfos},getUnboundEntities:function(){return this._unboundEntityInfos},isBound:function(t){return this.findIndex(t,this._boundEntityInfos)>=0},isUnbound:function(t){return this.findIndex(t,this._unboundEntityInfos)>=0},reset:function(){this._boundEntityInfos=[];this._unboundEntityInfos=[]},findIndex:function(t,e){var i=t.getId();for(var n=0,r=e.length;n<r;n++){if(i===e[n].getId()){return n}}return-1}};BX.Crm.EntityBindingTracker.create=function(){var t=new BX.Crm.EntityBindingTracker;t.initialize();return t}}if(typeof BX.Crm.UserFieldTypeMenu==="undefined"){BX.Crm.UserFieldTypeMenu=function(){this._id=null;this._settings={};this._items=null;this._isOpened=false;this._wrapper=null;this._innerWrapper=null;this._topScrollButton=null;this._bottomScrollButton=null;this._bottomButtonMouseOverHandler=BX.delegate(this.onBottomButtonMouseOver,this);this._bottomButtonMouseOutHandler=BX.delegate(this.onBottomButtonMouseOut,this);this._topButtonMouseOverHandler=BX.delegate(this.onTopButtonMouseOver,this);this._topButtonMouseOutHandler=BX.delegate(this.onTopButtonMouseOut,this);this._scrollHandler=BX.throttle(this.onScroll,100,this);this._enableScrollToBottom=false;this._enableScrollToTop=false;this._popup=null};BX.Crm.UserFieldTypeMenu.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._items=[];var i=BX.prop.getArray(e,"items");for(var n=0,r=i.length;n<r;n++){var o=i[n];o["menu"]=this;this._items.push(BX.Crm.UserFieldTypeMenuItem.create(BX.prop.getString(o,"value"),o))}},getId:function(){return this._id},isOpened:function(){return this._isOpened},open:function(t){if(this._isOpened){return}this._popup=new BX.PopupWindow(this._id,t,{autoHide:true,draggable:false,offsetLeft:0,offsetTop:0,noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},content:this.prepareContent()});this._popup.show()},close:function(){if(!this._isOpened){return}if(this._popup){this._popup.close()}},prepareContent:function(){this._wrapper=BX.create("div",{props:{className:"crm-entity-card-widget-create-field-popup"}});var t='<svg xmlns="http://www.w3.org/2000/svg" width="42" height="13" viewBox="0 0 42 13">\n'+'  <polyline fill="none" stroke="#CACDD1" stroke-width="2" points="274 98 284 78.614 274 59" transform="rotate(90 186 -86.5)" stroke-linecap="round" stroke-linejoin="round"/>\n'+"</svg>\n";this._topScrollButton=BX.create("div",{props:{className:"crm-entity-card-widget-popup-scroll-control-top"},html:t});this._wrapper.appendChild(this._topScrollButton);this._bottomScrollButton=BX.create("div",{props:{className:"crm-entity-card-widget-popup-scroll-control-bottom"},html:t});this._wrapper.appendChild(this._bottomScrollButton);this._innerWrapper=BX.create("div",{props:{className:"crm-entity-card-widget-create-field-list"}});this._wrapper.appendChild(this._innerWrapper);for(var e=0,i=this._items.length;e<i;e++){this._innerWrapper.appendChild(this._items[e].prepareContent())}return this._wrapper},adjust:function(){var t=this._innerWrapper.offsetHeight;var e=this._innerWrapper.scrollTop;var i=this._innerWrapper.scrollHeight;if(e===0){BX.addClass(this._topScrollButton,"control-hide")}else{BX.removeClass(this._topScrollButton,"control-hide")}if(e+t===i){BX.addClass(this._bottomScrollButton,"control-hide")}else{BX.removeClass(this._bottomScrollButton,"control-hide")}},onItemSelect:function(t){var e=BX.prop.getFunction(this._settings,"callback",null);if(e){e(this,t)}},onPopupShow:function(){this._isOpened=true;BX.bind(this._bottomScrollButton,"mouseover",this._bottomButtonMouseOverHandler);BX.bind(this._bottomScrollButton,"mouseout",this._bottomButtonMouseOutHandler);BX.bind(this._topScrollButton,"mouseover",this._topButtonMouseOverHandler);BX.bind(this._topScrollButton,"mouseout",this._topButtonMouseOutHandler);BX.bind(this._innerWrapper,"scroll",this._scrollHandler);window.setTimeout(this.adjust.bind(this),100)},onPopupClose:function(){if(this._popup){this._popup.destroy()}},onPopupDestroy:function(){this._isOpened=false;BX.unbind(this._bottomScrollButton,"mouseover",this._bottomButtonMouseOverHandler);BX.unbind(this._bottomScrollButton,"mouseout",this._bottomButtonMouseOutHandler);BX.unbind(this._topScrollButton,"mouseover",this._topButtonMouseOverHandler);BX.unbind(this._topScrollButton,"mouseout",this._topButtonMouseOutHandler);BX.unbind(this._innerWrapper,"scroll",this._scrollHandler);this._wrapper=null;this._innerWrapper=null;this._topScrollButton=null;this._bottomScrollButton=null;this._popup=null},onBottomButtonMouseOver:function(t){if(this._enableScrollToBottom){return}this._enableScrollToBottom=true;this._enableScrollToTop=false;(function t(){if(!this._enableScrollToBottom){return}var e=this._innerWrapper;if(e.scrollTop+e.offsetHeight!==e.scrollHeight){e.scrollTop+=3}if(e.scrollTop+e.offsetHeight===e.scrollHeight){this._enableScrollToBottom=false}else{window.setTimeout(t.bind(this),20)}}).bind(this)()},onBottomButtonMouseOut:function(){this._enableScrollToBottom=false},onTopButtonMouseOver:function(t){if(this._enableScrollToTop){return}this._enableScrollToBottom=false;this._enableScrollToTop=true;(function t(){if(!this._enableScrollToTop){return}var e=this._innerWrapper;if(e.scrollTop>0){e.scrollTop-=3}if(e.scrollTop===0){this._enableScrollToTop=false}else{window.setTimeout(t.bind(this),20)}}).bind(this)()},onTopButtonMouseOut:function(){this._enableScrollToTop=false},onScroll:function(t){this.adjust()}};BX.Crm.UserFieldTypeMenu.create=function(t,e){var i=new BX.Crm.UserFieldTypeMenu;i.initialize(t,e);return i}}if(typeof BX.Crm.UserFieldTypeMenuItem==="undefined"){BX.Crm.UserFieldTypeMenuItem=function(){this._id="";this._settings=null;this._menu="";this._value="";this._text="";this._legend=""};BX.Crm.UserFieldTypeMenuItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._menu=BX.prop.get(e,"menu");this._value=BX.prop.getString(e,"value");this._text=BX.prop.getString(e,"text");this._legend=BX.prop.getString(e,"legend")},getId:function(){return this._id},getValue:function(){return this._value},getText:function(){return this._text},getLegend:function(){return this._legend},prepareContent:function(){var t=BX.create("span",{props:{className:"crm-entity-card-widget-create-field-item"},events:{click:BX.delegate(this.onClick,this)}});t.appendChild(BX.create("span",{props:{className:"crm-entity-card-widget-create-field-item-title"},text:this._text}));t.appendChild(BX.create("span",{props:{className:"crm-entity-card-widget-create-field-item-desc"},text:this._legend}));return t},onClick:function(t){this._menu.onItemSelect(this)}};BX.Crm.UserFieldTypeMenuItem.create=function(t,e){var i=new BX.Crm.UserFieldTypeMenuItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorSubsection==="undefined"){BX.Crm.EntityEditorSubsection=function(){BX.Crm.EntityEditorSubsection.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorSubsection,BX.Crm.EntityEditorSection);BX.Crm.EntityEditorSubsection.prototype.initialize=function(t,e){BX.Crm.EntityEditorSubsection.superclass.initialize.call(this,t,e);this.initializeFromModel()};BX.Crm.EntityEditorSubsection.prototype.ensureWrapperCreated=function(t){if(!this._wrapper){this._wrapper=BX.create("div")}return this._wrapper};BX.Crm.EntityEditorSubsection.prototype.layout=function(t){this._contentContainer=BX.create("div");var e=this._mode===BX.Crm.EntityEditorMode.view;this.ensureWrapperCreated();this.layoutTitle();this._wrapper.appendChild(this._contentContainer);for(var i=0,n=this._fields.length;i<n;i++){this.layoutChild(this._fields[i])}this._addChildButton=this._createChildButton=null;if(this.isDragEnabled()){this._dragContainerController=BX.Crm.EditorDragContainerController.create("section_"+this.getId(),{charge:BX.Crm.EditorFieldDragContainer.create({section:this,context:this._draggableContextId}),node:this._wrapper});this._dragContainerController.addDragFinishListener(this._dropHandler);this.initializeDragDropAbilities()}this._addChildButton=this._createChildButton=null;if(!e){this.createButtonPanel();this._contentContainer.appendChild(this._buttonPanelWrapper)}this._hasLayout=true;this.registerLayout(t)};BX.Crm.EntityEditorSubsection.prototype.getChildDragScope=function(){return BX.Crm.EditorDragScope.parent};BX.Crm.EntityEditorSubsection.prototype.createButtonPanel=function(){this._buttonPanelWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}})};BX.Crm.EntityEditorSubsection.prototype.layoutChild=function(t){t.setContainer(this._contentContainer);t.setDraggableContextId(this._draggableContextId);this.setChildVisible(t);t.releaseLayout();t.layout();if(this._mode!==BX.Crm.EntityEditorMode.view&&t.isHeading()){t.focus()}};BX.Crm.EntityEditorSubsection.prototype.setChildVisible=function(t){t.setVisible(BX.prop.getBoolean(t._schemeElement._settings,"isVisible",true))};BX.Crm.EntityEditorSubsection.prototype.isDragEnabled=function(){return false};BX.Crm.EntityEditorSubsection.prototype.layoutTitle=function(){};BX.Crm.EntityEditorSubsection.prototype.isCreationEnabled=function(){return false};BX.Crm.EntityEditorSubsection.prototype.isContextMenuEnabled=function(){return false};BX.Crm.EntityEditorSubsection.prototype.isRequired=function(){return true};BX.Crm.EntityEditorSubsection.prototype.getRuntimeValue=function(){var t=[];for(var e=0;e<this.getChildCount();e++){var i=this._fields[e].getRuntimeValue();if(BX.type.isArray(i)){for(var n in i){if(i.hasOwnProperty(n)){t[n]=i[n]}}}else{t[this._fields[e].getName()]=i}}return t};BX.Crm.EntityEditorSubsection.prototype.createDragButton=function(){if(!this._dragButton){this._dragButton=BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn-container"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-draggable-btn"}})]})}return this._dragButton};BX.Crm.EntityEditorSubsection.prototype.initializeDragDropAbilities=function(){if(this._dragItem){return}this._dragItem=BX.Crm.EditorDragItemController.create("field_"+this.getId(),{charge:BX.Crm.EditorFieldDragItem.create({control:this,contextId:this._draggableContextId,scope:this.getDragScope()}),node:this.createDragButton(),showControlInDragMode:false,ghostOffset:{x:0,y:0}})};BX.Crm.EntityEditorSubsection.prototype.processChildControlChange=function(t,e){if(this._isChanged){return}this.markAsChanged(e)};BX.Crm.EntityEditorSubsection.create=function(t,e){var i=new BX.Crm.EntityEditorSubsection;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRecurring==="undefined"){BX.Crm.EntityEditorRecurring=function(){BX.Crm.EntityEditorRecurring.superclass.constructor.apply(this)};BX.extend(BX.Crm.EntityEditorRecurring,BX.Crm.EntityEditorSubsection);BX.Crm.EntityEditorRecurring.prototype.initialize=function(t,e){BX.Crm.EntityEditorRecurring.superclass.initialize.call(this,t,e);var i=this._schemeElement.getData();this._schemeFieldData=BX.prop.getObject(i,"fieldData",{});this._enableRecurring=BX.prop.getBoolean(this._schemeElement._settings,"enableRecurring",true);this._recurringModel=this._model.getField(this.getName())};BX.Crm.EntityEditorRecurring.prototype.initializeFromModel=function(){BX.Crm.EntityEditorRecurring.superclass.initializeFromModel.call(this);var t=this;for(var e=0,i=this._fields.length;e<i;e++){this._fields[e].getValue=function(e){if(!BX.type.isNotEmptyString(e)){e=this.getName()}return t.getRecurringFieldValue(e)}}};BX.Crm.EntityEditorRecurring.prototype.getRecurringModel=function(){var t=this.getParent();if(t instanceof BX.Crm.EntityEditorRecurring){return t.getRecurringModel()}return this._recurringModel};BX.Crm.EntityEditorRecurring.prototype.isContextMenuEnabled=function(){return BX.Crm.EntityEditorSubsection.superclass.isContextMenuEnabled.call(this)};BX.Crm.EntityEditorRecurring.prototype.isNeedToDisplay=function(){return false};BX.Crm.EntityEditorRecurring.prototype.isRequired=function(){return this._schemeElement&&this._schemeElement.isRequired()};BX.Crm.EntityEditorRecurring.prototype.prepareContextMenuItems=function(){var t=[];t.push({value:"hide",text:this.getMessage("hide")});return t};BX.Crm.EntityEditorRecurring.prototype.processContextMenuCommand=function(t,e){if(e==="hide"){window.setTimeout(BX.delegate(this.hide,this),500)}else if(this._parent&&this._parent.hasAdditionalMenu()){this._parent.processChildAdditionalMenuCommand(this,e)}this.closeContextMenu()};BX.Crm.EntityEditorRecurring.prototype.isDragEnabled=function(){return BX.Crm.EntityEditorSubsection.superclass.isDragEnabled.call(this)};BX.Crm.EntityEditorRecurring.prototype.getDragObjectType=function(){return BX.Crm.EditorDragObjectType.field};BX.Crm.EntityEditorRecurring.prototype.hasContentToDisplay=function(){return true};BX.Crm.EntityEditorRecurring.prototype.getRecurringMode=function(){var t=this.getParent();if(t instanceof BX.Crm.EntityEditorRecurring){return t.getRecurringMode()}return this.getRecurringFieldValue("RECURRING[MODE]")};BX.Crm.EntityEditorRecurring.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRecurring.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorRecurring.prototype.processChildControlChange=function(t,e){var i=t.getName();var n=false;var r=t.getValue();var o=t.getRuntimeValue();if(r!==o){switch(i){case"RECURRING[MODE]":case"RECURRING[MULTIPLE_TYPE_LIMIT]":case"RECURRING[BEGINDATE_TYPE]":case"RECURRING[CLOSEDATE_TYPE]":n=true;break;case"RECURRING[MULTIPLE_TYPE]":if(r===this.getSchemeFieldValue("MULTIPLE_CUSTOM")||o===this.getSchemeFieldValue("MULTIPLE_CUSTOM")){n=true}}}var s=this.getRecurringModel();this.setChangedValue(i,o,s);BX.Crm.EntityEditorRecurring.superclass.processChildControlChange.call(this,t,e);if(n){this.refreshLayout()}};BX.Crm.EntityEditorRecurring.prototype.setChangedValue=function(t,e,i){if(typeof e==="object"){for(var n in e){if(e.hasOwnProperty(n)){this.setChangedValue(n,e[n],i)}}}else{i[t]=e}};BX.Crm.EntityEditorRecurring.prototype.layout=function(t){this._contentContainer=BX.create("div");if(this.isMainSubsection()){this._contentContainer.classList.add("crm-entity-widget-content")}var e=this._mode===BX.Crm.EntityEditorMode.view;this.ensureWrapperCreated();this.layoutTitle();this._wrapper.appendChild(this._contentContainer);if(e){var i=BX.create("div",{props:{className:"crm-entity-widget-content-block crm-entity-widget-content-block-click-editable"},children:[this.createTitleNode(this.getTitle())]});this._contentContainer.appendChild(i);var n=BX.create("div");var r=this._schemeElement.getData();if(this._schemeElement._promise instanceof BX.Promise){this.loadViewText();this._schemeElement._promise.then(BX.proxy(function(){n.classList="crm-entity-widget-content-block-inner";n.innerHTML=BX.util.htmlspecialchars(r.view.text);i.innerHTML="";i.appendChild(n);this._schemeElement._promise=null},this))}else if(BX.type.isNotEmptyString(r.view.text)){n.classList="crm-entity-widget-content-block-inner";n.innerHTML=r.view.text;i.appendChild(n)}if(this._enableRecurring){BX.bind(n,"click",BX.delegate(this.toggle,this))}if(this.isContextMenuEnabled()){i.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){i.appendChild(this.createDragButton());this.initializeDragDropAbilities()}}else if(!this._enableRecurring){var i=BX.create("div",{props:{className:"crm-entity-widget-content-block"},children:[this.createTitleNode(this.getMessage("modeTitle"))]});var o=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[BX.create("div",{type:"text",props:{className:"crm-entity-widget-content-input",disabled:"disabled"},text:this.getMessage("notRepeat"),events:{click:BX.delegate(this.showLicencePopup,this)}})]});i.appendChild(o);var s=BX.create("button",{props:{className:"crm-entity-widget-content-block-locked-icon"},events:{click:BX.delegate(this.showLicencePopup,this)}});i.appendChild(s);this._contentContainer.appendChild(i)}else{for(var a=0,l=this._fields.length;a<l;a++){this._fields[a].isDragEnabled=function(){return false};this.layoutChild(this._fields[a])}}this._addChildButton=this._createChildButton=null;this._hasLayout=true;this.registerLayout(t)};BX.Crm.EntityEditorRecurring.prototype.createTitleNode=function(t){var e=BX.create("div",{attrs:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:t})]});return e};BX.Crm.EntityEditorRecurring.prototype.setChildVisible=function(t){var e=false;var i=t.getName();var n=this.getRecurringMode();if(i==="RECURRING[MODE]"){e=true}else if(n===this.getSchemeFieldValue("SINGLE_EXECUTION")){switch(i){case"SINGLE_PARAMS":case"RECURRING[BEGINDATE_TYPE]":case"RECURRING[CLOSEDATE_TYPE]":case"SUBTITLE_NEW_ORDER_PARAMS":case"NEW_BEGINDATE":case"NEW_CLOSEDATE":case"RECURRING[CATEGORY_ID]":e=true;break;case"OFFSET_BEGINDATE":if(this.getRecurringFieldValue("RECURRING[BEGINDATE_TYPE]")===this.getSchemeFieldValue("CALCULATED_FIELD_VALUE")){e=true}break;case"OFFSET_CLOSEDATE":if(this.getRecurringFieldValue("RECURRING[CLOSEDATE_TYPE]")===this.getSchemeFieldValue("CALCULATED_FIELD_VALUE")){e=true}break}}else if(n===this.getSchemeFieldValue("MULTIPLE_EXECUTION")){switch(i){case"MULTIPLE_PARAMS":case"RECURRING[MULTIPLE_TYPE]":case"RECURRING[CATEGORY_ID]":case"RECURRING[MULTIPLE_DATE_START]":case"MULTIPLE_LIMIT":case"RECURRING[MULTIPLE_TYPE_LIMIT]":case"SUBTITLE_NEW_ORDER_PARAMS":case"NEW_BEGINDATE":case"NEW_CLOSEDATE":case"RECURRING[BEGINDATE_TYPE]":case"RECURRING[CLOSEDATE_TYPE]":e=true;break;case"MULTIPLE_CUSTOM":if(this.getRecurringFieldValue("RECURRING[MULTIPLE_TYPE]")===this.getSchemeFieldValue("MULTIPLE_CUSTOM")){e=true}break;case"RECURRING[MULTIPLE_DATE_LIMIT]":if(this.getRecurringFieldValue("RECURRING[MULTIPLE_TYPE_LIMIT]")===this.getSchemeFieldValue("LIMITED_BY_DATE")){e=true}break;case"RECURRING[MULTIPLE_TIMES_LIMIT]":if(this.getRecurringFieldValue("RECURRING[MULTIPLE_TYPE_LIMIT]")===this.getSchemeFieldValue("LIMITED_BY_TIMES")){e=true}break;case"OFFSET_BEGINDATE":if(this.getRecurringFieldValue("RECURRING[BEGINDATE_TYPE]")===this.getSchemeFieldValue("CALCULATED_FIELD_VALUE")){e=true}break;case"OFFSET_CLOSEDATE":if(this.getRecurringFieldValue("RECURRING[CLOSEDATE_TYPE]")===this.getSchemeFieldValue("CALCULATED_FIELD_VALUE")){e=true}break}}t.setVisible(e)};BX.Crm.EntityEditorRecurring.prototype.getRecurringFieldValue=function(t){return BX.prop.get(this.getRecurringModel(),t)};BX.Crm.EntityEditorRecurring.prototype.getSchemeFieldValue=function(t){return BX.prop.get(this._schemeFieldData,t,"")};BX.Crm.EntityEditorRecurring.prototype.isMainSubsection=function(){return!(this.getParent()instanceof BX.Crm.EntityEditorRecurring)};BX.Crm.EntityEditorRecurring.prototype.onBeforeSubmit=function(){if(this.isMainSubsection()){this._wrapper.appendChild(BX.create("input",{props:{type:"hidden",name:"IS_RECURRING",value:this._model.getStringField("IS_RECURRING")==="Y"?"Y":"N"}}))}};BX.Crm.EntityEditorRecurring.prototype.save=function(){if(this.isMainSubsection()){this._schemeElement._promise=new BX.Promise}};BX.Crm.EntityEditorRecurring.prototype.loadViewText=function(){var t=this._schemeElement.getData();if(BX.type.isPlainObject(t.loaders)&&BX.type.isNotEmptyString(t.loaders["url"])&&BX.type.isNotEmptyString(t.loaders["action"])){BX.ajax({url:t.loaders["url"],method:"POST",dataType:"json",data:{ACTION:t.loaders["action"],PARAMS:{ID:this._model.getField("ID")}},onsuccess:BX.delegate(this.onEntityHintLoad,this)})}};BX.Crm.EntityEditorRecurring.prototype.onEntityHintLoad=function(t){var e=BX.prop.getObject(t,"DATA",null);if(!e){return}if(BX.type.isNotEmptyString(e.HINT)){this._schemeElement._data.view.text=e.HINT}if(this._schemeElement._promise instanceof BX.Promise){this._schemeElement._promise.fulfill();this._schemeElement._promise=null}};BX.Crm.EntityEditorRecurring.prototype.showLicencePopup=function(e){e.preventDefault();if(!B24||!B24["licenseInfoPopup"]){return}var layoutData=this._schemeElement.getData();var restrictionScript=layoutData.restrictScript;if(BX.type.isNotEmptyString(restrictionScript)){eval(restrictionScript)}};BX.Crm.EntityEditorRecurring.create=function(t,e){var i=new BX.Crm.EntityEditorRecurring;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRecurringCustomRowField==="undefined"){BX.Crm.EntityEditorRecurringCustomRowField=function(){BX.Crm.EntityEditorRecurringCustomRowField.superclass.constructor.apply(this);this._amountInput=null;this._selectInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null;this._selectedValue="";this._selectClickHandler=BX.delegate(this.onSelectorClick,this);this._isMesureMenuOpened=false};BX.extend(BX.Crm.EntityEditorRecurringCustomRowField,BX.Crm.EntityEditorField);BX.Crm.EntityEditorRecurringCustomRowField.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorRecurringCustomRowField.prototype.focus=function(){if(this._amountInput){BX.focus(this._amountInput);BX.Crm.EditorTextHelper.getCurrent().selectAll(this._amountInput)}};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getValue=function(t){if(!this._model){return""}return this._model.getStringField(this.getAmountFieldName(),t!==undefined?t:"")};BX.Crm.EntityEditorRecurringCustomRowField.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-recurring-custom"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getTitle();var i=this.getData();var n=this.getSelectFieldName();this._selectedValue=this.getValue(n);var r=BX.prop.getArray(BX.prop.getObject(i,"select"),"items");var o="";if(!this._selectedValue){var s=r.length>0?r[0]:null;if(s){this._selectedValue=s["VALUE"];o=s["NAME"]}}else{o=this._editor.findOption(this._selectedValue,r)}var a=this.getAmountFieldName();var l=this.getValue(a);this._amountInput=null;this._selectInput=null;this._selectContainer=null;this._innerWrapper=null;this._sumElement=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(e));this._amountInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",name:a,type:"text",value:l}});BX.bind(this._amountInput,"input",this._changeHandler);this._selectInput=BX.create("input",{attrs:{name:n,type:"hidden",value:this._selectedValue}});this._selectContainer=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:o});BX.bind(this._selectContainer,"click",this._selectClickHandler);this._inputWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-input-wrapper"},children:[this._amountInput,this._selectInput,BX.create("div",{props:{className:"crm-entity-widget-content-block-select"},children:[this._selectContainer]})]});this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"},children:[this._inputWrapper]})}this._wrapper.appendChild(this._innerWrapper);this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRecurringCustomRowField.prototype.doClearLayout=function(t){BX.PopupMenu.destroy(this._id);this._amountInput=null;this._selectInput=null;this._sumElement=null;this._selectContainer=null;this._inputWrapper=null;this._innerWrapper=null};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getAmountFieldName=function(){return this._schemeElement.getDataStringParam("amount","")};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getSelectFieldName=function(){return BX.prop.getString(this._schemeElement.getDataObjectParam("select",{}),"name","")};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onSelectorClick=function(t){this.openListMenu()};BX.Crm.EntityEditorRecurringCustomRowField.prototype.openListMenu=function(){if(this._isListMenuOpened){return}var t=this._schemeElement.getData();var e=BX.prop.getArray(BX.prop.getObject(t,"select"),"items");var i=0;var n=[];while(i<e.length){n.push({text:e[i]["NAME"],value:e[i]["VALUE"],onclick:BX.delegate(this.onSelectItem,this)});i++}BX.PopupMenu.show(this._id,this._selectContainer,n,{angle:false,width:this._selectContainer.offsetWidth+"px",events:{onPopupShow:BX.delegate(this.onListMenuOpen,this),onPopupClose:BX.delegate(this.onListMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(this._selectContainer)["width"])};BX.Crm.EntityEditorRecurringCustomRowField.prototype.closeListMenu=function(){if(!this._isListMenuOpened){return}var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onListMenuOpen=function(){BX.addClass(this._selectContainer,"active");this._isListMenuOpened=true};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onListMenuClose=function(){BX.PopupMenu.destroy(this._id);BX.removeClass(this._selectContainer,"active");this._isListMenuOpened=false};BX.Crm.EntityEditorRecurringCustomRowField.prototype.onSelectItem=function(t,e){this.closeListMenu();this._selectedValue=this._selectInput.value=e.value;this._selectContainer.innerHTML=BX.util.htmlspecialchars(e.text);this.markAsChanged({fieldName:this.getSelectFieldName(),fieldValue:this._selectedValue})};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getRuntimeValue=function(){var t=[];if(this._mode===BX.Crm.EntityEditorMode.edit){if(this._amountInput){t[this.getAmountFieldName()]=this._amountInput.value}t[this.getSelectFieldName()]=this._selectedValue;return t}return""};BX.Crm.EntityEditorRecurringCustomRowField.prototype.save=function(){this._model.setField(this.getSelectFieldName(),this._selectedValue);if(this._amountInput){this._model.setField(this.getAmountFieldName(),this._amountInput.value)}};BX.Crm.EntityEditorRecurringCustomRowField.create=function(t,e){var i=new BX.Crm.EntityEditorRecurringCustomRowField;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRecurringSingleField==="undefined"){BX.Crm.EntityEditorRecurringSingleField=function(){BX.Crm.EntityEditorRecurringSingleField.superclass.constructor.apply(this);this._dateInput=null};BX.extend(BX.Crm.EntityEditorRecurringSingleField,BX.Crm.EntityEditorRecurringCustomRowField);BX.Crm.EntityEditorRecurringSingleField.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-recurring-single"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getTitle();var i=this.getData();var n=this.getAmountFieldName();var r=this.getValue(n);var o=this.getSelectFieldName();this._selectedValue=this.getValue(o);var s=this.getDateFieldName();this._dateValue=this.getValue(s);var a=BX.prop.getArray(BX.prop.getObject(i,"select"),"items");var l="";if(!this._selectedValue){var d=a.length>0?a[0]:null;if(d){this._selectedValue=d["VALUE"];l=d["NAME"]}}else{l=this._editor.findOption(this._selectedValue,a)}this._amountInput=null;this._selectInput=null;this._selectContainer=null;this._innerWrapper=null;this._sumElement=null;if(this._mode===BX.Crm.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(e));this._amountInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",name:n,type:"text",value:r}});BX.bind(this._amountInput,"input",this._changeHandler);this._selectInput=BX.create("input",{attrs:{name:o,type:"hidden",value:this._selectedValue}});this._selectContainer=BX.create("div",{props:{className:"crm-entity-widget-content-select"},text:l});this._dateInput=BX.create("input",{style:{display:"inline-block"},props:{name:s,className:"crm-entity-widget-content-input crm-entity-widget-content-input-date",value:this._dateValue},events:{click:function(){BX.calendar({node:this,field:this,bTime:false})},change:BX.delegate(function(t){this.markAsChanged()},this)}});BX.bind(this._selectContainer,"click",this._selectClickHandler);this._inputWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-input-wrapper"},children:[this._amountInput,this._selectInput,BX.create("div",{props:{className:"crm-entity-widget-content-block-select"},children:[this._selectContainer]}),BX.create("span",{text:this.getMessage("until")}),this._dateInput]});this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-colums-input"},children:[this._inputWrapper]})}this._wrapper.appendChild(this._innerWrapper);this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRecurringCustomRowField.prototype.getDateFieldName=function(){return this._schemeElement.getDataStringParam("date","")};BX.Crm.EntityEditorRecurringSingleField.prototype.getRuntimeValue=function(){var t=[];if(this._mode===BX.Crm.EntityEditorMode.edit){if(this._amountInput){t[this.getAmountFieldName()]=this._amountInput.value}t[this.getSelectFieldName()]=this._selectedValue;t[this.getDateFieldName()]=this._dateInput.value;return t}return""};BX.Crm.EntityEditorRecurringSingleField.prototype.save=function(){var t=this._schemeElement.getData();this._model.setField(BX.prop.getString(BX.prop.getObject(t,"select"),"name"),this._selectedValue);if(this._amountInput){this._model.setField(BX.prop.getString(t,"amount"),this._amountInput.value)}if(this._dateInput){this._model.setField(BX.prop.getString(t,"date"),this._dateInput.value)}};BX.Crm.EntityEditorRecurringSingleField.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRecurringSingleField.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorRecurringSingleField.create=function(t,e){var i=new BX.Crm.EntityEditorRecurringSingleField;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorPhone==="undefined"){BX.Crm.EntityEditorPhone=function(){BX.Crm.EntityEditorPhone.superclass.constructor.apply(this);this._dateInput=null};BX.extend(BX.Crm.EntityEditorPhone,BX.Crm.EntityEditorText);BX.Crm.EntityEditorPhone.prototype.getEditModeHtmlNodes=function(){var t=this.getValue();this._input=BX.create("input",{props:{type:"hidden",value:t}});if(!this.isVirtual()){this._input.name=this.getName()}this._countryFlagNode=BX.create("span",{props:{className:"crm-entity-widget-content-country-flag"}});this._maskedPhoneInput=BX.create("input",{props:{type:"text",className:"crm-entity-widget-content-input crm-entity-widget-content-input-phone",autocomplete:"nope"}});this._maskedPhone=new BX.PhoneNumber.Input({node:this._maskedPhoneInput,flagNode:this._countryFlagNode,flagSize:24,onChange:BX.delegate(this.onPhoneNumberChange,this)});this._maskedPhone.setValue(t);var e=this.isNewEntity()?this.getCreationPlaceholder():this.getChangePlaceholder();if(e!==""){this._maskedPhoneInput.setAttribute("placeholder",e)}return[BX.create("div",{props:{className:"ui-ctl-w100"},children:[this._countryFlagNode,this._maskedPhoneInput,this._input]})]};BX.Crm.EntityEditorPhone.prototype.getViewModeHtmlNodes=function(){var t=this.getValue();var e=new BX.PhoneNumber;e.setRawNumber(t);return[BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-text"},text:e.format()})]};BX.Crm.EntityEditorPhone.prototype.doClearLayout=function(t){BX.Crm.EntityEditorPhone.superclass.doClearLayout.apply(this,arguments);this._maskedPhoneInput=null;this._maskedPhone=null};BX.Crm.EntityEditorPhone.prototype.focus=function(){if(!this._maskedPhoneInput){return}BX.focus(this._maskedPhoneInput);BX.Crm.EditorTextHelper.getCurrent().setPositionAtEnd(this._maskedPhoneInput)};BX.Crm.EntityEditorPhone.prototype.onPhoneNumberChange=function(t){if(!this._input){return}if(this._input.value!==t.value){this._input.value=t.value;this.onChange(t)}};BX.Crm.EntityEditorPhone.prototype.setRawRuntimeValue=function(t){BX.Crm.EntityEditorPhone.superclass.setRawRuntimeValue.apply(this,arguments);if(this._mode===BX.Crm.EntityEditorMode.edit&&this._maskedPhone){this._maskedPhone.setValue(t)}};BX.Crm.EntityEditorPhone.prototype.getInputElement=function(){return this._maskedPhoneInput};BX.Crm.EntityEditorPhone.create=function(t,e){var i=new BX.Crm.EntityEditorPhone;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRequisiteSelector==="undefined"){BX.Crm.EntityEditorRequisiteSelector=function(){BX.Crm.EntityEditorRequisiteSelector.superclass.constructor.apply(this);this._requisiteId=0;this._bankDetailId=0;this._itemWrappers={};this._itemButtons={};this._itemBankDetailButtons={}};BX.extend(BX.Crm.EntityEditorRequisiteSelector,BX.Crm.EntityEditorField);BX.Crm.EntityEditorRequisiteSelector.prototype.doInitialize=function(){this._requisiteId=this._model.getIntegerField("REQUISITE_ID",0);this._bankDetailId=this._model.getIntegerField("BANK_DETAIL_ID",0)};BX.Crm.EntityEditorRequisiteSelector.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRequisiteSelector.messages;return e.hasOwnProperty(t)?e[t]:t};BX.Crm.EntityEditorRequisiteSelector.prototype.getPrefix=function(){return this._id.toLowerCase()+"_"};BX.Crm.EntityEditorRequisiteSelector.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getData();this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:this._requisiteId,bankDetailId:this._bankDetailId,data:BX.prop.getArray(e,"data",{})});var i=this._requisiteInfo.getItems();this._wrapper=BX.create("div",{props:{className:"crm-entity-requisites-slider-wrapper"}});var n=BX.create("div",{props:{className:"crm-entity-requisites-slider-content"}});this._wrapper.appendChild(n);var r=BX.create("div",{props:{className:"crm-entity-requisites-slider-widget-content"}});n.appendChild(r);var o=BX.create("div",{props:{className:"crm-entity-requisites-select-container"}});r.appendChild(o);for(var s=0,a=i.length;s<a;s++){o.appendChild(this.prepareItemLayout(i[s]))}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRequisiteSelector.prototype.getItemData=function(t){var e=this._requisiteInfo.getItems();for(var i=0,n=e.length;i<n;i++){var r=e[i];if(t===BX.prop.getInteger(r,"requisiteId",0)){return r}}return null};BX.Crm.EntityEditorRequisiteSelector.prototype.prepareItemLayout=function(t){var e=BX.prop.getObject(t,"viewData",null);if(!e){return}var i=BX.prop.getBoolean(t,"selected",false);var n=this.getPrefix();var r=BX.prop.getInteger(t,"requisiteId",0);var o=BX.create("label",{props:{className:"crm-entity-requisites-select-item"}});o.appendChild(BX.create("strong",{text:BX.prop.getString(e,"title","")}));if(i){BX.addClass(o,"crm-entity-requisites-select-item-selected")}this._itemWrappers[r]=o;var s,a;var l=BX.prop.getArray(e,"fields",[]);for(s=0,a=l.length;s<a;s++){var d=l[s];var h=BX.prop.getString(d,"title","");var p=BX.prop.getString(d,"textValue","");if(h!==""&&p!==""){o.appendChild(BX.create("br"));o.appendChild(BX.create("span",{text:h+": "+p}))}}var u=BX.create("input",{props:{type:"radio",name:n+"requisite",checked:i,className:"crm-entity-requisites-select-item-field"},attrs:{"data-requisiteid":r}});o.appendChild(u);this._itemButtons[r]=u;BX.bind(u,"change",BX.delegate(this.onItemChange,this));var c=BX.prop.getArray(t,"bankDetailViewDataList",[]);if(c.length>0){var m=BX.create("span",{props:{className:"crm-entity-requisites-select-item-bank-requisites-container"}});o.appendChild(m);m.appendChild(BX.create("span",{props:{className:"crm-entity-requisites-select-item-bank-requisites-title"},html:this.getMessage("bankDetails")}));var y=BX.create("span",{props:{className:"crm-entity-requisites-select-item-bank-requisites-field-container"}});m.appendChild(y);this._itemBankDetailButtons[r]={};for(s=0,a=c.length;s<a;s++){var E=c[s];var g=BX.prop.getInteger(E,"pseudoId",0);var _=BX.prop.getObject(E,"viewData",null);if(!_){continue}var f=i&&BX.prop.getBoolean(E,"selected",false);var C=BX.create("label",{props:{className:"crm-entity-requisites-select-item-bank-requisites-field-item"}});y.appendChild(C);var B=BX.create("input",{props:{type:"radio",name:n+"bankrequisite"+r,checked:f,className:"crm-entity-requisites-select-item-bank-requisites-field"},attrs:{"data-requisiteid":r,"data-bankdetailid":g}});C.appendChild(B);BX.bind(B,"change",BX.delegate(this.onItemBankDetailChange,this));this._itemBankDetailButtons[r][g]=B;C.appendChild(document.createTextNode(BX.prop.getString(_,"title","")))}o.appendChild(BX.create("span",{style:{display:"block",clear:"both"}}))}return o};BX.Crm.EntityEditorRequisiteSelector.prototype.clearLayout=function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._itemWrappers={};this._itemButtons={};this._itemBankDetailButtons={};this._hasLayout=false};BX.Crm.EntityEditorRequisiteSelector.prototype.save=function(){this._model.setField("REQUISITE_ID",this._requisiteId,{originator:this});this._model.setField("BANK_DETAIL_ID",this._bankDetailId,{originator:this})};BX.Crm.EntityEditorRequisiteSelector.prototype.onItemChange=function(t){var e=BX.getEventTarget(t);if(!e.checked){return}var i=parseInt(e.getAttribute("data-requisiteid"));if(isNaN(i)||i<=0){return}this._requisiteId=i;this._bankDetailId=0;var n=this.getItemData(this._requisiteId);var r=BX.prop.getArray(n,"bankDetailViewDataList",[]);for(var o=0,s=r.length;o<s;o++){var a=r[o];var l=BX.prop.getInteger(a,"pseudoId",0);if(l>0&&BX.prop.getBoolean(a,"selected",false)){this._bankDetailId=l;break}}for(var d in this._itemWrappers){if(!this._itemWrappers.hasOwnProperty(d)){continue}var h=this._itemWrappers[d];var p=this._requisiteId===parseInt(d);if(p){BX.addClass(h,"crm-entity-requisites-select-item-selected")}else{BX.removeClass(h,"crm-entity-requisites-select-item-selected")}if(this._itemButtons.hasOwnProperty(d)){var u=this._itemButtons[d];if(u.checked!==p){u.checked=p}}if(this._itemBankDetailButtons.hasOwnProperty(d)){var c=this._itemBankDetailButtons[d];for(var m in c){if(!c.hasOwnProperty(m)){continue}var y=p&&this._bankDetailId===parseInt(m);var E=c[m];if(E.checked!==y){E.checked=y}}}}this.markAsChanged()};BX.Crm.EntityEditorRequisiteSelector.prototype.onItemBankDetailChange=function(t){var e=BX.getEventTarget(t);if(!e.checked){return}var i=parseInt(e.getAttribute("data-requisiteid"));if(isNaN(i)||i<=0){return}if(this._requisiteId!==i){return}var n=parseInt(e.getAttribute("data-bankdetailid"));if(isNaN(n)||n<=0){return}this._bankDetailId=n};if(typeof BX.Crm.EntityEditorRequisiteSelector.messages==="undefined"){BX.Crm.EntityEditorRequisiteSelector.messages={}}BX.Crm.EntityEditorRequisiteSelector.create=function(t,e){var i=new BX.Crm.EntityEditorRequisiteSelector;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRequisiteListItem==="undefined"){BX.Crm.EntityEditorRequisiteListItem=function(){this._id="";this._settings=null;this._owner=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._data=null;this._requisiteId=0;this._container=null;this._wrapper=null;this._innerWrapper=null;this._editButton=null;this._deleteButton=null;this._hasLayout=false};BX.Crm.EntityEditorRequisiteListItem.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=BX.type.isPlainObject(e)?e:{};this._owner=BX.prop.get(this._settings,"owner",null);this._mode=BX.prop.getInteger(this._settings,"mode",BX.Crm.EntityEditorMode.intermediate);this._data=BX.prop.getObject(this._settings,"data",{});this._requisiteId=BX.prop.getInteger(this._data,"requisiteId",0);this._container=BX.prop.getElementNode(this._settings,"container")},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.Crm.EntityEditorRequisiteListItem.messages,t,t)},getRequisiteId:function(){return this._requisiteId},getData:function(){return this._data},setData:function(t){this._data=t},layout:function(t){if(this._hasLayout){return}var e=BX.prop.getObject(this._data,"viewData",null);if(!e){e={}}var i=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-container crm-entity-widget-client-requisites-container-opened"}});this._innerWrapper=BX.create("dl",{props:{className:"crm-entity-widget-client-requisites-list"}});this.prepareViewLayout(e,["RQ_ADDR"]);this.prepareFieldViewLayout(e,"RQ_ADDR");var n=BX.prop.getArray(this._data,"bankDetailViewDataList",[]);for(var r=0,o=n.length;r<o;r++){var s=n[r];if(!BX.prop.getBoolean(s,"isDeleted",false)){this.prepareViewLayout(BX.prop.getObject(s,"viewData",null),[])}}if(!i){this._deleteButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-remove-icon"},events:{click:BX.delegate(this.onRemoveButtonClick,this)}});this._editButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-edit-icon"},events:{click:BX.delegate(this.onEditButtonClick,this)}})}this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-inner-container"},children:[this._deleteButton,this._editButton,this._innerWrapper]}));var a=BX.prop.getElementNode(t,"anchor",null);if(a){this._container.insertBefore(this._wrapper,a)}else{this._container.appendChild(this._wrapper)}this._hasLayout=true},prepareViewLayout:function(t,e){if(!t){return}var i=BX.prop.getString(t,"title","");if(i!==""){this._innerWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:i}))}var n,r;var o={};if(BX.type.isArray(e)){for(n=0,r=e.length;n<r;n++){o[e[n]]=true}}var s=[];var a=BX.prop.getArray(t,"fields",[]);for(n=0,r=a.length;n<r;n++){var l=a[n];var d=BX.prop.getString(l,"name","");if(o.hasOwnProperty(d)){continue}var h=BX.prop.getString(l,"title","");var p=BX.prop.getString(l,"textValue","");if(h!==""&&p!==""){s.push(h+": "+p)}}this._innerWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:s.join(", ")}))},prepareFieldViewLayout:function(t,e){if(!t){return}var i=BX.prop.getArray(t,"fields",[]);for(var n=0,r=i.length;n<r;n++){var o=i[n];var s=BX.prop.getString(o,"name","");if(s!==e){continue}var a=BX.prop.getString(o,"title","");var l=BX.prop.getString(o,"textValue","");if(a===""||l===""){continue}this._innerWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:a}));this._innerWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:l}))}},clearLayout:function(){if(!this._hasLayout){return}this._wrapper=BX.remove(this._wrapper);this._innerWrapper=null;this._editButton=null;this._deleteButton=null;this._hasLayout=false},getContainer:function(){return this._container},setContainer:function(t){this._container=t},getWrapper:function(){return this._wrapper},prepareData:function(){var t=this._labelInput?BX.util.trim(this._labelInput.value):"";if(t===""){return null}var e={VALUE:t};var i=BX.prop.getInteger(this._data,"ID",0);if(i>0){e["ID"]=i}var n=BX.prop.getString(this._data,"XML_ID","");if(i>0){e["XML_ID"]=n}return e},onEditButtonClick:function(t){this._owner.onEditItem(this)},onRemoveButtonClick:function(t){var e=BX.Crm.EditorAuxiliaryDialog.create(this._id,{title:this.getMessage("deleteTitle"),content:this.getMessage("deleteConfirm"),buttons:[{id:"accept",type:BX.Crm.DialogButtonType.accept,text:BX.message("CRM_EDITOR_DELETE"),callback:BX.delegate(this.onRemovalConfirmationDialogButtonClick,this)},{id:"cancel",type:BX.Crm.DialogButtonType.cancel,text:BX.message("CRM_EDITOR_CANCEL"),callback:BX.delegate(this.onRemovalConfirmationDialogButtonClick,this)}]});e.open();this._owner.onOpenItemRemovalConfirmation(this)},onRemovalConfirmationDialogButtonClick:function(t){var e=t.getDialog();if(t.getId()==="accept"){this._owner.onRemoveItem(this)}e.close();this._owner.onCloseItemRemovalConfirmation(this)}};if(typeof BX.Crm.EntityEditorRequisiteListItem.messages==="undefined"){BX.Crm.EntityEditorRequisiteListItem.messages={}}BX.Crm.EntityEditorRequisiteListItem.create=function(t,e){var i=new BX.Crm.EntityEditorRequisiteListItem;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorRequisiteList==="undefined"){BX.Crm.EntityEditorRequisiteList=function(){BX.Crm.EntityEditorRequisiteList.superclass.constructor.apply(this);this._items=null;this._data=null;this._externalContext=null;this._externalEventHandler=null;this._createButton=null;this._dataInputs={};this._dataSignInputs={};this._itemWrapper=null;this._dataWrapper=null;this._isPresetMenuOpened=false;this._newItemIndex=-1;this._sliderUrls={}};BX.extend(BX.Crm.EntityEditorRequisiteList,BX.Crm.EntityEditorField);BX.Crm.EntityEditorRequisiteList.prototype.doInitialize=function(){this.initializeFromModel()};BX.Crm.EntityEditorRequisiteList.prototype.initializeFromModel=function(){var t=this.getValue();this._data=BX.type.isArray(t)?BX.clone(t,true):[];var e,i;for(e=0,i=this._data.length;e<i;e++){this.prepareRequisiteData(this._data[e])}this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:0,bankDetailId:0,data:this._data})};BX.Crm.EntityEditorRequisiteList.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.initializeFromModel();this.refreshLayout()};BX.Crm.EntityEditorRequisiteList.prototype.reset=function(){this.initializeFromModel();for(var t in this._sliderUrls){if(this._sliderUrls.hasOwnProperty(t)){BX.Crm.Page.removeSlider(this._sliderUrls[t])}}this._sliderUrls={}};BX.Crm.EntityEditorRequisiteList.prototype.rollback=function(){if(this.isChanged()){this.reset()}};BX.Crm.EntityEditorRequisiteList.prototype.doSetMode=function(t){this.rollback()};BX.Crm.EntityEditorRequisiteList.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorRequisiteList.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorRequisiteList.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorRequisiteList.prototype.prepareDataInputName=function(t,e){return this.getName()+"["+t.toString()+"]"+"["+e+"]"};BX.Crm.EntityEditorRequisiteList.prototype.prepareRequisiteData=function(t){var e=BX.prop.getInteger(t,"requisiteId",0);var i=BX.prop.getString(t,"pseudoId","");if(e>0){t["key"]=e.toString();t["isNew"]=false;t["isChanged"]=BX.prop.getBoolean(t,"isChanged",false)}else{t["key"]=i;t["isNew"]=true;t["isChanged"]=BX.prop.getBoolean(t,"isChanged",true)}t["isDeleted"]=false};BX.Crm.EntityEditorRequisiteList.prototype.findRequisiteDataIndexByKey=function(t){for(var e=0,i=this._data.length;e<i;e++){if(BX.prop.getString(this._data[e],"key",0)===t){return e}}return-1};BX.Crm.EntityEditorRequisiteList.prototype.getRequisiteDataByKey=function(t){var e=this.findRequisiteDataIndexByKey(t);return e>=0?this._data[e]:null};BX.Crm.EntityEditorRequisiteList.prototype.setupRequisiteData=function(t){var e=BX.prop.getString(t,"key","");if(e===""){return}var i=this.findRequisiteDataIndexByKey(e);if(i>=0){this._data[i]=t}else{this._data.push(t)}this._requisiteInfo=BX.CrmEntityRequisiteInfo.create({requisiteId:0,bankDetailId:0,data:this._data})};BX.Crm.EntityEditorRequisiteList.prototype.refreshRequisiteDataInputs=function(){if(!this._hasLayout){return}BX.cleanNode(this._dataWrapper);for(var t=0,e=this._data.length;t<e;t++){var i=this._data[t];var n=BX.prop.getString(i,"key","");if(n===""){continue}var r=BX.prop.getBoolean(i,"isChanged",false);var o=BX.prop.getBoolean(i,"isDeleted",false);if(!r&&!o){continue}if(o){this._dataWrapper.appendChild(BX.create("input",{props:{type:"hidden",name:this.prepareDataInputName(n,"DELETED"),value:"Y"}}))}else{var s=BX.prop.getString(i,"requisiteDataSign","");if(s!==""){this._dataWrapper.appendChild(BX.create("input",{props:{type:"hidden",name:this.prepareDataInputName(n,"SIGN"),value:s}}))}var a=BX.prop.getString(i,"requisiteData","");if(a!==""){this._dataWrapper.appendChild(BX.create("input",{props:{type:"hidden",name:this.prepareDataInputName(n,"DATA"),value:a}}))}}}};BX.Crm.EntityEditorRequisiteList.prototype.hasContentToDisplay=function(){if(this._mode===BX.Crm.EntityEditorMode.edit){return true}return this._requisiteInfo&&this._requisiteInfo.getItems().length>0};BX.Crm.EntityEditorRequisiteList.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();this._items=[];if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}var e,i;var n=this._requisiteInfo.getItems();for(e=0,i=n.length;e<i;e++){var r=n[e];var o=BX.Crm.EntityEditorRequisiteListItem.create(BX.prop.getString(r,"key",""),{owner:this,mode:this._mode,data:r});this._items.push(o)}if(this.isInEditMode()){this._dataWrapper=BX.create("div");this._wrapper.appendChild(this._dataWrapper);this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._itemWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner crm-entity-widget-content-block-requisites"}});this._wrapper.appendChild(this._itemWrapper);for(e=0,i=this._items.length;e<i;e++){this._items[e].setContainer(this._itemWrapper);this._items[e].layout()}this._createButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-add-btn"},text:BX.message("CRM_EDITOR_ADD")});this._itemWrapper.appendChild(this._createButton);BX.bind(this._createButton,"click",BX.delegate(this.onCreateButtonClick,this))}else{this._wrapper.appendChild(this.createTitleNode(this.getTitle()));this._itemWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-colums-block"}});this._wrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},children:[this._itemWrapper]}));this._wrapper.appendChild(this._itemWrapper);for(e=0,i=this._items.length;e<i;e++){this._items[e].setContainer(this._itemWrapper);this._items[e].layout()}}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorRequisiteList.prototype.doClearLayout=function(t){if(this._items){for(var e=0,i=this._items.length;e<i;e++){this._items[e].clearLayout()}}this._items=[];this._itemWrapper=null;this._createButton=null};BX.Crm.EntityEditorRequisiteList.prototype.getItemByIndex=function(t){return t>=0&&t<=this._items.length-1?this._items[t]:null};BX.Crm.EntityEditorRequisiteList.prototype.getItemById=function(t){for(var e=0,i=this._items.length;e<i;e++){var n=this._items[e];if(n.getId()===t){return n}}return null};BX.Crm.EntityEditorRequisiteList.prototype.getItemCount=function(){return this._items.length};BX.Crm.EntityEditorRequisiteList.prototype.getItemIndex=function(t){for(var e=0,i=this._items.length;e<i;e++){if(this._items[e]===t){return e}}return-1};BX.Crm.EntityEditorRequisiteList.prototype.removeItemByIndex=function(t){if(t<this._items.length){this._items.splice(t,1)}};BX.Crm.EntityEditorRequisiteList.prototype.removeItem=function(t){var e=this.getItemIndex(t);if(e<0){return}var i=this.getRequisiteDataByKey(t.getId());if(i){i["isDeleted"]=true}t.clearLayout();this.removeItemByIndex(e);this.refreshRequisiteDataInputs();this.markAsChanged()};BX.Crm.EntityEditorRequisiteList.prototype.openEditor=function(t){var e=BX.prop.getInteger(t,"requisiteId",0);var i=this._editor.getContextId();var n={etype:this._editor.getEntityTypeId(),eid:this._editor.getEntityId(),external_context_id:i};var r=BX.prop.getInteger(t,"presetId",0);if(r>0){n["pid"]=r}var o="";if(e<=0){this._newItemIndex++;o="n"+this._newItemIndex.toString();n["pseudo_id"]=o}var s=BX.util.add_url_param(this._editor.getRequisiteEditUrl(e),n);if(!this._externalEventHandler){this._externalEventHandler=BX.delegate(this.onExternalEvent,this);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}if(!this._externalContext){this._externalContext={}}if(e>0){this._externalContext[e]={requisiteId:e,url:s}}else{this._externalContext[o]={pseudoId:o,url:s}}if(e>0){this._sliderUrls[e]=s}BX.Crm.Page.openSlider(s,{width:950})};BX.Crm.EntityEditorRequisiteList.prototype.onEditItem=function(t){this.openEditor({requisiteId:t.getRequisiteId()})};BX.Crm.EntityEditorRequisiteList.prototype.onRemoveItem=function(t){this.removeItem(t)};BX.Crm.EntityEditorRequisiteList.prototype.onOpenItemRemovalConfirmation=function(t){if(this._singleEditController){this._singleEditController.setActiveDelayed(false)}};BX.Crm.EntityEditorRequisiteList.prototype.onCloseItemRemovalConfirmation=function(t){if(this._singleEditController){this._singleEditController.setActiveDelayed(true)}};BX.Crm.EntityEditorRequisiteList.prototype.onExternalEvent=function(t){var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";if(e!=="BX.Crm.RequisiteSliderEditor:onSave"){return}var i=BX.type.isPlainObject(t["value"])?t["value"]:{};var n=BX.prop.getString(i,"context","");if(n!==this._editor.getContextId()){return}var r=BX.prop.getInteger(i,"presetId",0);var o=BX.prop.getString(i,"pseudoId","");var s=BX.prop.getInteger(i,"requisiteId",0);var a=BX.prop.getString(i,"requisiteDataSign","");var l=BX.prop.getString(i,"requisiteData","");var d={entityTypeId:this._editor.getEntityTypeId(),entityId:this._editor.getEntityId(),presetId:r,pseudoId:o,requisiteId:s,requisiteData:l,requisiteDataSign:a,isChanged:true};this.prepareRequisiteData(d);this.setupRequisiteData(d);this.refreshRequisiteDataInputs();this.markAsChanged();var h=BX.prop.getString(d,"key","");var p=BX.prop.getObject(this._externalContext,h,null);if(!p){return}var u=this.getItemById(h);var c;if(u){u.setData(d);u.clearLayout();c={};var m=this.getItemIndex(u);if(m<this.getItemCount()-1){c["anchor"]=this.getItemByIndex(m+1).getWrapper()}else if(this._createButton){c["anchor"]=this._createButton}u.layout(c)}else{u=BX.Crm.EntityEditorRequisiteListItem.create(h,{owner:this,mode:this._mode,data:d,container:this._itemWrapper});this._items.push(u);c={};if(this._createButton){c["anchor"]=this._createButton}u.layout(c)}var y=BX.prop.getString(p,"url","");if(y!==""){BX.Crm.Page.closeSlider(y,true)}delete this._externalContext[s]};BX.Crm.EntityEditorRequisiteList.prototype.onCreateButtonClick=function(t){this.togglePresetMenu()};BX.Crm.EntityEditorRequisiteList.prototype.togglePresetMenu=function(){if(this._isPresetMenuOpened){this.closePresetMenu()}else{this.openPresetMenu()}};BX.Crm.EntityEditorRequisiteList.prototype.openPresetMenu=function(){if(this._isPresetMenuOpened){return}var t=[];var e=BX.prop.getArray(this._schemeElement.getData(),"presets");for(var i=0,n=e.length;i<n;i++){var r=e[i];var o=BX.prop.getString(r,"VALUE",i);var s=BX.prop.getString(r,"NAME",o);t.push({text:s,value:o,onclick:BX.delegate(this.onPresetSelect,this)})}BX.PopupMenu.show(this._id,this._createButton,t,{angle:false,events:{onPopupShow:BX.delegate(this.onPresetMenuShow,this),onPopupClose:BX.delegate(this.onPresetMenuClose,this)}})};BX.Crm.EntityEditorRequisiteList.prototype.closePresetMenu=function(){if(!this._isPresetMenuOpened){return}var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Crm.EntityEditorRequisiteList.prototype.onPresetMenuShow=function(){this._isPresetMenuOpened=true};BX.Crm.EntityEditorRequisiteList.prototype.onPresetMenuClose=function(){BX.PopupMenu.destroy(this._id);this._isPresetMenuOpened=false};BX.Crm.EntityEditorRequisiteList.prototype.onPresetSelect=function(t,e){this.openEditor({presetId:e.value});this.closePresetMenu()};BX.Crm.EntityEditorRequisiteList.prototype.save=function(){};if(typeof BX.Crm.EntityEditorRequisiteList.messages==="undefined"){BX.Crm.EntityEditorRequisiteList.messages={}}BX.Crm.EntityEditorRequisiteList.create=function(t,e){var i=new BX.Crm.EntityEditorRequisiteList;i.initialize(t,e);return i}}if(typeof BX.Crm.ClientEditorEntityRequisitePanel==="undefined"){BX.Crm.ClientEditorEntityRequisitePanel=function(){this._id="";this._settings={};this._editor=null;this._entityInfo=null;this._requisiteInfo=null;this._mode=BX.Crm.EntityEditorMode.intermediate;this._selectedRequisiteId=0;this._selectedBankDetailId=0;this._container=null;this._wrapper=null;this._contentWrapper=null;this._requisiteInput=null;this._bankDetailInput=null;this._toggleButton=null;this._editButton=null;this._toggleButtonHandler=BX.delegate(this.onToggleButtonClick,this);this._editButtonHandler=BX.delegate(this.onEditButtonClick,this);this._isExpanded=false;this._hasLayout=false;this._externalEventHandler=BX.delegate(this.onExternalEvent,this);this._changeNotifier=null};BX.Crm.ClientEditorEntityRequisitePanel.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._editor=BX.prop.get(this._settings,"editor");this._container=BX.prop.getElementNode(this._settings,"container",null);this._mode=BX.prop.getInteger(this._settings,"mode",0);this._entityInfo=BX.prop.get(this._settings,"entityInfo",null);this._requisiteInfo=BX.prop.get(this._settings,"requisiteInfo",null);this._selectedRequisiteId=this._requisiteInfo.getRequisiteId();this._selectedBankDetailId=this._requisiteInfo.getBankDetailId();this._changeNotifier=BX.CrmNotifier.create(this);if(BX.Crm.ClientEditorEntityRequisitePanel.options.hasOwnProperty(this._id)){this._isExpanded=BX.prop.getBoolean(BX.Crm.ClientEditorEntityRequisitePanel.options[this._id],"expanded",false)}},getMessage:function(t){var e=BX.Crm.ClientEditorEntityRequisitePanel.messages;return e.hasOwnProperty(t)?e[t]:t},getContainer:function(){return this._container},setContainer:function(t){this._container=t},isExpanded:function(){return this._isExpanded},setExpanded:function(t){t=!!t;if(this._isExpanded===t){return}this._isExpanded=t;if(!BX.Crm.ClientEditorEntityRequisitePanel.options.hasOwnProperty(this._id)){BX.Crm.ClientEditorEntityRequisitePanel.options[this._id]={}}BX.Crm.ClientEditorEntityRequisitePanel.options[this._id]["expanded"]=this._isExpanded;if(t){BX.addClass(this._wrapper,"crm-entity-widget-client-requisites-container-opened")}else{BX.removeClass(this._wrapper,"crm-entity-widget-client-requisites-container-opened")}},toggle:function(){this.setExpanded(!this._isExpanded)},addChangeListener:function(t){this._changeNotifier.addListener(t)},removeChangeListener:function(t){this._changeNotifier.removeListener(t)},layout:function(){if(this._hasLayout){return}var t=null;var e=null;var i=this._selectedRequisiteId;var n=this._selectedBankDetailId;if(i>0){t=this._requisiteInfo.getItemById(i)}if(!t){t=this._requisiteInfo.getSelectedItem()}if(!t){t=this._requisiteInfo.getFirstItem()}if(t){if(n>0){e=this._requisiteInfo.getItemBankDetailById(i,n)}if(!e){e=this._requisiteInfo.getSelectedItemBankDetail(i)}if(!e){e=this._requisiteInfo.getFirstItemBankDetail(i)}}var r=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-container"}});this._container.appendChild(this._wrapper);if(this._isExpanded){BX.addClass(this._wrapper,"crm-entity-widget-client-requisites-container-opened")}if(!r){this._requisiteInput=BX.create("input",{props:{type:"hidden",name:"REQUISITE_ID",value:i}});this._wrapper.appendChild(this._requisiteInput);this._bankDetailInput=BX.create("input",{props:{type:"hidden",name:"BANK_DETAIL_ID",value:n}});this._wrapper.appendChild(this._bankDetailInput)}if(t){this._toggleButton=BX.create("a",{props:{className:"crm-entity-widget-client-requisites-show-btn"},text:this.getMessage("toggle").toLowerCase()});this._wrapper.appendChild(this._toggleButton);BX.bind(this._toggleButton,"click",this._toggleButtonHandler);var o=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-inner-container"}});this._wrapper.appendChild(o);if(!r){this._editButton=BX.create("span",{props:{className:"crm-entity-widget-client-requisites-edit-icon"}});this._editButton.setAttribute("data-editor-control-type","button");o.appendChild(this._editButton);BX.bind(this._editButton,"click",this._editButtonHandler)}this._contentWrapper=BX.create("dl",{props:{className:"crm-entity-widget-client-requisites-list"}});o.appendChild(this._contentWrapper);var s=BX.prop.getObject(t,"viewData",null);this.prepareItemView(s,["RQ_ADDR"]);this.prepareItemFieldView(s,"RQ_ADDR");if(e){this.prepareItemView(BX.prop.getObject(e,"viewData",null))}}this._hasLayout=true},prepareItemView:function(t,e){if(!t){return}var i=BX.prop.getString(t,"title","");if(i!==""){this._contentWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:i}))}var n,r;var o={};if(BX.type.isArray(e)){for(n=0,r=e.length;n<r;n++){o[e[n]]=true}}var s=[];var a=BX.prop.getArray(t,"fields",[]);for(n=0,r=a.length;n<r;n++){var l=a[n];var d=BX.prop.getString(l,"name","");if(o.hasOwnProperty(d)){continue}var h=BX.prop.getString(l,"title","");var p=BX.prop.getString(l,"textValue","");if(h!==""&&p!==""){s.push(h+": "+p)}}this._contentWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:s.join(", ")}))},prepareItemFieldView:function(t,e){if(!t){return}var i=BX.prop.getArray(t,"fields",[]);for(var n=0,r=i.length;n<r;n++){var o=i[n];var s=BX.prop.getString(o,"name","");if(s!==e){continue}var a=BX.prop.getString(o,"title","");var l=BX.prop.getString(o,"textValue","");if(a===""||l===""){continue}this._contentWrapper.appendChild(BX.create("dt",{props:{className:"crm-entity-widget-client-requisites-name"},text:a}));this._contentWrapper.appendChild(BX.create("dd",{props:{className:"crm-entity-widget-client-requisites-value"},text:l}))}},clearLayout:function(){if(!this._hasLayout){return}if(this._toggleButton){BX.unbind(this._toggleButton,"click",this._toggleButtonHandler);this._toggleButton=null}if(this._editButton){BX.unbind(this._editButton,"click",this._editButtonHandler);this._editButton=null}this._isExpanded=false;this._requisiteInput=null;this._bankDetailInput=null;this._contentWrapper=null;this._wrapper=BX.remove(this._wrapper);this._hasLayout=false},refreshLayout:function(){var t=this.isExpanded();this.clearLayout();this.layout();this.setExpanded(t)},getRuntimeValue:function(){return{REQUISITE_ID:this._selectedRequisiteId,BANK_DETAIL_ID:this._selectedBankDetailId}},onToggleButtonClick:function(t){this.toggle();return BX.eventReturnFalse(t)},onEditButtonClick:function(t){if(!this._editor){return}var e=BX.prop.getString(this._settings,"requisiteSelectUrl","");if(e===""&&BX.type.isFunction(this._editor.getEntityRequisiteSelectUrl)){e=this._editor.getEntityRequisiteSelectUrl(this._entityInfo.getTypeName(),this._entityInfo.getId())}if(e!==""){e=BX.util.add_url_param(e,{external_context_id:this._editor.getContextId(),requisite_id:this._selectedRequisiteId,bank_detail_id:this._selectedBankDetailId});BX.Crm.Page.openSlider(e);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}BX.eventCancelBubble(t)},onExternalEvent:function(t){if(this._mode===BX.Crm.EntityEditorMode.view){return}var e=BX.type.isNotEmptyString(t["key"])?t["key"]:"";var i=BX.type.isPlainObject(t["value"])?t["value"]:{};if(!(this._editor&&this._editor.getContextId()===BX.prop.getString(i,"context"))){return}if(e==="BX.Crm.EntityRequisiteSelector:onCancel"){BX.removeCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}else if(e==="BX.Crm.EntityRequisiteSelector:onSave"){BX.removeCustomEvent(window,"onLocalStorageSet",this._externalEventHandler);var n=BX.prop.getInteger(i,"requisiteId");if(n>0){this._selectedRequisiteId=n;if(this._requisiteInput){this._requisiteInput.value=this._selectedRequisiteId}}var r=BX.prop.getInteger(i,"bankDetailId");if(r){this._selectedBankDetailId=r;if(this._bankDetailInput){this._bankDetailInput.value=this._selectedBankDetailId}}this._changeNotifier.notify([{requisiteId:this._selectedRequisiteId,bankDetailId:this._selectedBankDetailId}]);this.refreshLayout()}}};if(typeof BX.Crm.ClientEditorEntityRequisitePanel.messages==="undefined"){BX.Crm.ClientEditorEntityRequisitePanel.messages={}}BX.Crm.ClientEditorEntityRequisitePanel.options={};BX.Crm.ClientEditorEntityRequisitePanel.create=function(t,e){var i=new BX.Crm.ClientEditorEntityRequisitePanel;i.initialize(t,e);return i}}if(typeof BX.Crm.RequisiteNavigator==="undefined"){BX.Crm.RequisiteNavigator=function(){this._id=null;this._settings={};this._requisite=null;this._bankDetail=null;this._bankDetailList=null;this._closingNotifier=null;this._nextButton=null;this._nextButtonHandler=BX.delegate(this.onNextButtonClick,this);this._wrapper=null;this._innerWrapper=null;this._titleContainer=null;this._contentContainer=null;this._bankDetailContainer=null;this._popup=null;this._isOpened=false;this._isExpanded=true;this._hasLayout=false};BX.Crm.RequisiteNavigator.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=e?e:{};this._requisiteInfo=BX.prop.get(e,"requisiteInfo");var i=this._requisiteInfo.getRequisiteId();var n=this._requisiteInfo.getBankDetailId();this._requisite=i>0?this._requisiteInfo.getItemById(i):null;if(!this._requisite){this._requisite=this._requisiteInfo.getSelectedItem()}if(!this._requisite){this._requisite=this._requisiteInfo.getFirstItem()}if(this._requisite){this._bankDetailList=this._requisiteInfo.getItemBankDetailList(i);if(this._bankDetailList){if(n>0){this._bankDetail=this._bankDetailList.getItemById(n)}if(!this._bankDetail){this._bankDetail=this._bankDetailList.getSelectedItem()}if(!this._bankDetail){this._bankDetail=this._bankDetailList.getFirstItem()}}}this._closingNotifier=BX.CrmNotifier.create(this)},getId:function(){return this._id},getMessage:function(t){return BX.prop.getString(BX.Crm.RequisiteNavigator.messages,t,t)},addClosingListener:function(t){this._closingNotifier.addListener(t)},removeClosingListener:function(t){this._closingNotifier.removeListener(t)},isOpened:function(){return this._isOpened},open:function(t){if(this._isOpened){return}var e=0,i=0;if(BX.type.isElementNode(t)){e=t.offsetWidth+15;i=-(t.offsetHeight+30)}this._popup=new BX.PopupWindow(this._id,t,{autoHide:true,draggable:false,offsetLeft:e,offsetTop:i,noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)},content:this.prepareContent()});this._popup.show()},close:function(){if(!this._isOpened){return}if(this._popup){this._popup.close()}},prepareContent:function(){this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-wrap"}});this._titleContainer=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-box"}});this._wrapper.appendChild(this._titleContainer);this._requisiteTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-wrapper"}});this._titleContainer.appendChild(this._requisiteTitleWrapper);this._nextButton=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-arrow-right"},children:[BX.create("div",{props:{className:"crm-entity-widget-client-requisites-arrow-right-item"}})]});this._titleContainer.appendChild(this._nextButton);BX.bind(this._nextButton,"click",this._nextButtonHandler);this._contentWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-box crm-entity-widget-client-requisites-box-active"}});this._wrapper.appendChild(this._contentWrapper);this._contentInnerWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-box-inner"}});this._contentWrapper.appendChild(this._contentInnerWrapper);this._requisiteWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-list-container"}});this._contentInnerWrapper.appendChild(this._requisiteWrapper);this._bankDetailWrapper=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-list-container"}});this._contentInnerWrapper.appendChild(this._bankDetailWrapper);this.renderRequisites();return this._wrapper},renderTitleFields:function(t,e){for(var i=0,n=t.length;i<n;i++){var r=t[i];var o=BX.prop.getString(r,"title","");var s=BX.prop.getString(r,"textValue","");if(o===""||s===""){continue}e.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-desc"},text:o}));e.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-content"},children:[BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-content-item"},text:s})]}))}},renderContentFields:function(t,e,i){var n=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-list"}});i.appendChild(n);var r=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-item"}});n.appendChild(r);r.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-name"},text:e}));var o=[];for(var s=0,a=t.length;s<a;s++){var l=t[s];var d=BX.prop.getString(l,"title","");var h=BX.prop.getString(l,"textValue","");if(d!==""&&h!==""){o.push(d+": "+h)}}if(o.length>0){r.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-value"},text:o.join(", ")}))}else{BX.addClass(n,"crm-entity-widget-client-requisites-empty-value");r.appendChild(document.createTextNode(this.getMessage("stub")))}},renderRequisites:function(){BX.cleanNode(this._requisiteTitleWrapper);BX.cleanNode(this._requisiteWrapper);this._nextButton.style.display=this._requisiteInfo.getItemCount()>1?"":"none";if(this._requisite){var t=BX.prop.getObject(this._requisite,"viewData",{});var e=BX.prop.getArray(t,"fields",[]);var i=[];var n=[];for(var r=0,o=e.length;r<o;r++){var s=e[r];var a=BX.prop.getString(s,"name","");if(a==="RQ_ADDR"){i.push(s)}else{n.push(s)}}this._requisiteTitleWrapper.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-info-title"},text:BX.prop.getString(t,"title","")}));this.renderTitleFields(i,this._requisiteTitleWrapper);this.renderContentFields(n,"",this._requisiteWrapper);this.renderBankDetails()}},renderBankDetails:function(){BX.cleanNode(this._bankDetailWrapper);if(this._bankDetailList&&this._bankDetail){var t=BX.prop.getObject(this._bankDetail,"viewData",{});this.renderContentFields(BX.prop.getArray(t,"fields",[]),BX.prop.getString(t,"title",""),this._bankDetailWrapper);var e=this._bankDetailList.getItemCount();if(e>1){var i=BX.create("div",{props:{className:"crm-entity-widget-client-requisites-control-box"}});this._bankDetailWrapper.appendChild(i);i.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-control-value"},text:this.getMessage("legend").replace(/#NUMBER#/gi,this._bankDetailList.getItemIndex(this._bankDetail)+1).toString().replace(/#TOTAL#/gi,e.toString())}));i.appendChild(BX.create("div",{props:{className:"crm-entity-widget-client-requisites-control-btn"},html:this.getMessage("next")+"&rarr;",events:{click:BX.delegate(this.onNextBankDetailButtonClick,this)}}))}}},getSelectedItemId:function(){return this._requisite?BX.CrmEntityRequisiteInfo.resolveItemId(this._requisite):0},getSelectedBankDetailId:function(){return this._bankDetail?BX.CrmEntityBankDetailList.resolveItemId(this._bankDetail):0},showNextItem:function(){if(!(this._requisiteInfo&&this._requisite)){return}var t=this._requisiteInfo.getItemCount();if(t===0){return}var e=this._requisiteInfo.getItemIndex(this._requisite);if(e<0){e=0}e++;if(e===t){e=0}this._requisite=this._requisiteInfo.getItemByIndex(e);if(this._requisite){var i=BX.CrmEntityRequisiteInfo.resolveItemId(this._requisite);this._bankDetailList=this._requisiteInfo.getItemBankDetailList(i);if(this._bankDetailList){this._bankDetail=this._bankDetailList.getSelectedItem();if(!this._bankDetail){this._bankDetail=this._bankDetailList.getFirstItem()}}}this.renderRequisites()},showNextBankDetail:function(){if(!(this._bankDetailList&&this._bankDetail)){return}var t=this._bankDetailList.getItemCount();if(t===0){return}var e=this._bankDetailList.getItemIndex(this._bankDetail);if(e<0){e=0}e++;if(e===t){e=0}this._bankDetail=this._bankDetailList.getItemByIndex(e);this.renderBankDetails()},onPopupShow:function(){this._isOpened=true},onPopupClose:function(){if(this._popup){this._popup.destroy()}this._closingNotifier.notify([{requisiteId:this.getSelectedItemId(),bankDetailId:this.getSelectedBankDetailId()}])},onPopupDestroy:function(){this._isOpened=false;this._wrapper=null;this._innerWrapper=null;this._popup=null},onNextButtonClick:function(t){this.showNextItem()},onNextBankDetailButtonClick:function(t){this.showNextBankDetail()}};BX.Crm.RequisiteNavigator.options={};if(typeof BX.Crm.RequisiteNavigator.messages==="undefined"){BX.Crm.RequisiteNavigator.messages={}}BX.Crm.RequisiteNavigator.create=function(t,e){var i=new BX.Crm.RequisiteNavigator;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorClientLight==="undefined"){BX.Crm.EntityEditorClientLight=function(){BX.Crm.EntityEditorClientLight.superclass.constructor.apply(this);this._map=null;this._info=null;this._primaryLoaderConfig=null;this._secondaryLoaderConfig=null;this._dataElements=null;this._companyInfos=null;this._contactInfos=null;this._enableCompanyMultiplicity=false;this._companyTitleWrapper=null;this._contactTitleWrapper=null;this._companySearchBoxes=null;this._contactSearchBoxes=null;this._companyPanels=null;this._contactPanels=null;this._companyWrapper=null;this._contactWrapper=null;this._addCompanyButton=null;this._addContactButton=null;this._innerWrapper=null;this._layoutType=BX.Crm.EntityEditorClientLayoutType.undefined;this._visibleClientFields=null;this._enableLayoutTypeChange=false;this._enableQuickEdit=null;this._companyNameChangeHandler=BX.delegate(this.onCompanyNameChange,this);this._companyChangeHandler=BX.delegate(this.onCompanyChange,this);this._companyDeletionHandler=BX.delegate(this.onCompanyDelete,this);this._companyResetHandler=BX.delegate(this.onCompanyReset,this);this._contactNameChangeHandler=BX.delegate(this.onContactNameChange,this);this._contactChangeHandler=BX.delegate(this.onContactChange,this);this._contactDeletionHandler=BX.delegate(this.onContactDelete,this);this._contactResetHandler=BX.delegate(this.onContactReset,this);this._requisiteChangeHandler=BX.delegate(this.onRequisiteChange,this);this._multifieldChangeHandler=BX.delegate(this.onMultifieldChange,this)};BX.extend(BX.Crm.EntityEditorClientLight,BX.Crm.EntityEditorField);BX.Crm.EntityEditorClientLight.prototype.doInitialize=function(){BX.Crm.EntityEditorClientLight.superclass.doInitialize.apply(this);this._map=this._schemeElement.getDataObjectParam("map",{});this.initializeFromModel()};BX.Crm.EntityEditorClientLight.prototype.initializeFromModel=function(){this._companyInfos=BX.Collection.create();this._contactInfos=BX.Collection.create();this._info=this._model.getSchemeField(this._schemeElement,"info",{});this.initializeEntityInfos(BX.prop.getArray(this._info,"COMPANY_DATA",[]),this._companyInfos);this.initializeEntityInfos(BX.prop.getArray(this._info,"CONTACT_DATA",[]),this._contactInfos);this._enableCompanyMultiplicity=this._schemeElement.getDataBooleanParam("enableCompanyMultiplicity",false);var t=this._schemeElement.getDataObjectParam("loaders",{});this._primaryLoaderConfig=BX.prop.getObject(t,"primary",{});this._secondaryLoaderConfig=BX.prop.getObject(t,"secondary",{});this._enableLayoutTypeChange=true;var e=this._schemeElement.getDataStringParam("fixedLayoutType","");if(e!==""){var i=BX.Crm.EntityEditorClientLayoutType.resolveId(e);if(i!==BX.Crm.EntityEditorClientLayoutType.undefined){this._layoutType=i;this._enableLayoutTypeChange=false}}};BX.Crm.EntityEditorClientLight.prototype.initializeEntityInfos=function(t,e){for(var i=0,n=t.length;i<n;i++){var r=BX.CrmEntityInfo.create(t[i]);if(r.getId()>0){e.add(r)}}};BX.Crm.EntityEditorClientLight.prototype.createDataElement=function(t,e){var i=BX.prop.getString(this._map,t,"");if(i===""){return}var n=BX.create("input",{attrs:{name:i,type:"hidden"}});if(BX.type.isNotEmptyString(e)){n.value=e}if(!this._dataElements){this._dataElements={}}this._dataElements[t]=n;if(this._wrapper){this._wrapper.appendChild(n)}};BX.Crm.EntityEditorClientLight.prototype.getMessage=function(t){var e=BX.Crm.EntityEditorClientLight.messages;return e.hasOwnProperty(t)?e[t]:BX.Crm.EntityEditorClientLight.superclass.getMessage.apply(this,arguments)};BX.Crm.EntityEditorClientLight.prototype.getOwnerTypeName=function(){return this._editor.getEntityTypeName()};BX.Crm.EntityEditorClientLight.prototype.getOwnerTypeId=function(){return this._editor.getEntityTypeId()};BX.Crm.EntityEditorClientLight.prototype.getOwnerId=function(){return this._editor.getEntityId()};BX.Crm.EntityEditorClientLight.prototype.hasCompanies=function(){return this._companyInfos!==null&&this._companyInfos.length()>0};BX.Crm.EntityEditorClientLight.prototype.hasContacts=function(){return this._contactInfos!==null&&this._contactInfos.length()>0};BX.Crm.EntityEditorClientLight.prototype.addCompany=function(t){if(t instanceof BX.CrmEntityInfo){if(!this._companyInfos){this._companyInfos=BX.Collection.create()}this._companyInfos.add(t)}};BX.Crm.EntityEditorClientLight.prototype.removeCompany=function(t){if(this._companyInfos&&t instanceof BX.CrmEntityInfo){this._companyInfos.remove(t)}};BX.Crm.EntityEditorClientLight.prototype.addContact=function(t){if(t instanceof BX.CrmEntityInfo){if(!this._contactInfos){this._contactInfos=BX.Collection.create()}this._contactInfos.add(t)}};BX.Crm.EntityEditorClientLight.prototype.removeContact=function(t){if(this._contactInfos&&t instanceof BX.CrmEntityInfo){this._contactInfos.remove(t)}};BX.Crm.EntityEditorClientLight.prototype.hasContentToDisplay=function(){return this.hasCompanies()||this._contactInfos!==null&&this._contactInfos.length()>0};BX.Crm.EntityEditorClientLight.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorClientLight.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorClientLight.prototype.reset=function(){this.initializeFromModel()};BX.Crm.EntityEditorClientLight.prototype.rollback=function(){if(this.isChanged()){this.initializeFromModel()}};BX.Crm.EntityEditorClientLight.prototype.getEntityCreateUrl=function(t){return this._editor.getEntityCreateUrl(t)};BX.Crm.EntityEditorClientLight.prototype.getEntityEditUrl=function(t,e){return this._editor.getEntityEditUrl(t,e)};BX.Crm.EntityEditorClientLight.prototype.doSetMode=function(t){this.rollback()};BX.Crm.EntityEditorClientLight.prototype.doPrepareContextMenuItems=function(t){t.push({delimiter:true});if(this._enableLayoutTypeChange){var e=this.getLayoutType();if(e===BX.Crm.EntityEditorClientLayoutType.companyContact||e===BX.Crm.EntityEditorClientLayoutType.contactCompany){t.push({value:"set_layout_contact",text:this.getMessage("disableCompany")});t.push({value:"set_layout_company",text:this.getMessage("disableContact")})}else if(e===BX.Crm.EntityEditorClientLayoutType.company){t.push({value:"set_layout_company_contact",text:this.getMessage("enableContact")})}else if(e===BX.Crm.EntityEditorClientLayoutType.contact){t.push({value:"set_layout_contact_company",text:this.getMessage("enableCompany")})}if(this.isClientFieldVisible("ADDRESS")){t.push({value:"hide_client_field_address",text:this.getMessage("disableAddress")})}else{t.push({value:"show_client_field_address",text:this.getMessage("enableAddress")})}if(this.isClientFieldVisible("REQUISITES")){t.push({value:"hide_client_field_requisites",text:this.getMessage("disableRequisites")})}else{t.push({value:"show_client_field_requisites",text:this.getMessage("enableRequisites")})}if(e===BX.Crm.EntityEditorClientLayoutType.companyContact){t.push({delimiter:true});t.push({value:"set_layout_contact_company",text:this.getMessage("displayContactAtFirst")})}else if(e===BX.Crm.EntityEditorClientLayoutType.contactCompany){t.push({delimiter:true});t.push({value:"set_layout_company_contact",text:this.getMessage("displayCompanyAtFirst")})}t.push({delimiter:true})}if(this.isQuickEditEnabled()){t.push({value:"disable_quick_edit",text:this.getMessage("disableQuickEdit")})}else{t.push({value:"enable_quick_edit",text:this.getMessage("enableQuickEdit")})}};BX.Crm.EntityEditorClientLight.prototype.processContextMenuCommand=function(t,e){if(e==="set_layout_contact_company"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.contactCompany)}.bind(this),100)}else if(e==="set_layout_company_contact"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.companyContact)}.bind(this),100)}else if(e==="set_layout_contact"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.contact)}.bind(this),100)}else if(e==="set_layout_company"){window.setTimeout(function(){this.setLayoutType(BX.Crm.EntityEditorClientLayoutType.company)}.bind(this),100)}else if(e==="hide_client_field_address"){window.setTimeout(function(){this.setClientFieldVisible("ADDRESS",false)}.bind(this),100)}else if(e==="show_client_field_address"){window.setTimeout(function(){this.setClientFieldVisible("ADDRESS",true)}.bind(this),100)}else if(e==="hide_client_field_requisites"){window.setTimeout(function(){this.setClientFieldVisible("REQUISITES",false)}.bind(this),100)}else if(e==="show_client_field_requisites"){window.setTimeout(function(){this.setClientFieldVisible("REQUISITES",true)}.bind(this),100)}else if(e==="disable_quick_edit"){this.enableQuickEdit(false)}else if(e==="enable_quick_edit"){this.enableQuickEdit(true)}BX.Crm.EntityEditorClientLight.superclass.processContextMenuCommand.apply(this,arguments)};BX.Crm.EntityEditorClientLight.prototype.isQuickEditEnabled=function(){if(this._enableQuickEdit===null){this._enableQuickEdit=this._editor.getConfigOption("enableQuickEdit","Y")==="Y"}return this._enableQuickEdit};BX.Crm.EntityEditorClientLight.prototype.enableQuickEdit=function(t){t=!!t;if(this._enableQuickEdit===null){this._enableQuickEdit=this._editor.getConfigOption("enableQuickEdit","Y")==="Y"}if(this._enableQuickEdit===t){return}this._enableQuickEdit=t;this._editor.setConfigOption("enableQuickEdit",t?"Y":"N");var e,i;if(this._companySearchBoxes){for(e=0,i=this._companySearchBoxes.length;e<i;e++){this._companySearchBoxes[e].enableQuickEdit(t)}}if(this._contactSearchBoxes){for(e=0,i=this._contactSearchBoxes.length;e<i;e++){this._contactSearchBoxes[e].enableQuickEdit(t)}}};BX.Crm.EntityEditorClientLight.prototype.isCompanyEnabled=function(){var t=this.getLayoutType();return t===BX.Crm.EntityEditorClientLayoutType.contactCompany||t===BX.Crm.EntityEditorClientLayoutType.companyContact||t===BX.Crm.EntityEditorClientLayoutType.company};BX.Crm.EntityEditorClientLight.prototype.isContactEnabled=function(){var t=this.getLayoutType();return t===BX.Crm.EntityEditorClientLayoutType.contactCompany||t===BX.Crm.EntityEditorClientLayoutType.companyContact||t===BX.Crm.EntityEditorClientLayoutType.contact};BX.Crm.EntityEditorClientLight.prototype.getLayoutType=function(){if(this._layoutType<=0){var t=this._editor.getConfigOption("client_layout","");var e=parseInt(t);if(isNaN(e)||e<=0){e=BX.Crm.EntityEditorClientLayoutType.companyContact}this._layoutType=e}return this._layoutType};BX.Crm.EntityEditorClientLight.prototype.setLayoutType=function(t){if(!BX.type.isNumber(t)){t=parseInt(t)}if(isNaN(t)||t<=0){return}if(t===this._layoutType){return}this._layoutType=t;this._editor.setConfigOption("client_layout",t);this.refreshLayout()};BX.Crm.EntityEditorClientLight.prototype.loadClientVisibleFields=function(){var t=this._editor.getConfigOption("client_visible_fields",null);if(BX.Type.isString(t)){t=t.split(",")}else{t=["ADDRESS","REQUISITES"]}return t};BX.Crm.EntityEditorClientLight.prototype.isClientFieldVisible=function(t){if(!BX.Type.isArray(this._visibleClientFields)){this._visibleClientFields=this.loadClientVisibleFields()}return this._visibleClientFields.indexOf(t)>-1};BX.Crm.EntityEditorClientLight.prototype.setClientFieldVisible=function(t,e){if(!BX.Type.isArray(this._visibleClientFields)){this._visibleClientFields=this.loadClientVisibleFields()}if(e&&this._visibleClientFields.indexOf(t)===-1){this._visibleClientFields.push(t)}if(!e&&this._visibleClientFields.indexOf(t)>-1){this._visibleClientFields.splice(this._visibleClientFields.indexOf(t),1)}this._editor.setConfigOption("client_visible_fields",this._visibleClientFields.join(","));this.refreshLayout()};BX.Crm.EntityEditorClientLight.prototype.getClientVisibleFieldsList=function(t){var e=this.getClientEditorFieldsParams(t);var i=["PHONE","EMAIL"];if(this.isClientFieldVisible("ADDRESS")&&e.hasOwnProperty("ADDRESS")){i.push("ADDRESS")}if(this.isClientFieldVisible("REQUISITES")&&e.hasOwnProperty("REQUISITES")){i.push("REQUISITES")}return i};BX.Crm.EntityEditorClientLight.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(this.getTitle()));if(!this.hasContentToDisplay()&&this.isInViewMode()){this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-inner"},text:this.getMessage("isEmpty")});this._wrapper.appendChild(this._innerWrapper)}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"}});this._wrapper.appendChild(this._innerWrapper);var e=this.getLayoutType();if(this.isInEditMode()){var i=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container"}});this._innerWrapper.appendChild(i);this._innerContainer=BX.create("div",{props:{className:"crm-entity-widget-content-block-field-container-inner"}});i.appendChild(this._innerContainer)}else{BX.addClass(this._wrapper,"crm-entity-widget-participants-block");BX.addClass(this._innerWrapper,"crm-entity-widget-inner")}if(this.isContactEnabled()&&this.isCompanyEnabled()){if(e===BX.Crm.EntityEditorClientLayoutType.contactCompany){this.renderContact();this.renderCompany()}else if(e===BX.Crm.EntityEditorClientLayoutType.companyContact){this.renderCompany();this.renderContact()}}else{if(this.isContactEnabled()){this.renderContact()}if(this.isCompanyEnabled()){this.renderCompany()}}}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._entityEditParams={};this._hasLayout=true};BX.Crm.EntityEditorClientLight.prototype.createAdditionalWrapperBlock=function(){};BX.Crm.EntityEditorClientLight.prototype.switchToSingleEditMode=function(t){this._entityEditParams={};if(this.isInViewMode()&&this.isQuickEditEnabled()&&BX.type.isElementNode(t)){var e=false;if(BX.isParentForNode(this._companyTitleWrapper,t)){e=true;this._entityEditParams["enableCompany"]=true;this._entityEditParams["companyIndex"]=0}if(!e&&BX.isParentForNode(this._contactTitleWrapper,t)){e=true;this._entityEditParams["enableContact"]=true;this._entityEditParams["contactIndex"]=0}var i,n;if(!e&&this._companyPanels!==null){for(i=0,n=this._companyPanels.length;i<n;i++){if(this._companyPanels[i].checkOwership(t)){e=true;this._entityEditParams["enableCompany"]=true;this._entityEditParams["companyIndex"]=i;break}}}if(!e&&this._contactPanels!==null){for(i=0,n=this._contactPanels.length;i<n;i++){if(this._contactPanels[i].checkOwership(t)){e=true;this._entityEditParams["enableContact"]=true;this._entityEditParams["contactIndex"]=i;break}}}if(!BX.prop.getBoolean(this._entityEditParams,"enableCompany",false)&&!BX.prop.getBoolean(this._entityEditParams,"enableContact",false)){var r=this.getLayoutType();if(r===BX.Crm.EntityEditorClientLayoutType.contact||r===BX.Crm.EntityEditorClientLayoutType.contactCompany){this._entityEditParams["enableContact"]=true;this._entityEditParams["contactIndex"]=0}else if(r===BX.Crm.EntityEditorClientLayoutType.company||r===BX.Crm.EntityEditorClientLayoutType.companyContact){this._entityEditParams["enableCompany"]=true}}}BX.Crm.EntityEditorClientLight.superclass.switchToSingleEditMode.apply(this,arguments)};BX.Crm.EntityEditorClientLight.prototype.getEntityInitialMode=function(t){if(!this.isQuickEditEnabled()){return BX.Crm.EntityEditorClientMode.select}if(!this.checkModeOption(BX.Crm.EntityEditorModeOptions.individual)){return BX.Crm.EntityEditorClientMode.edit}return BX.prop.getBoolean(this._entityEditParams,t===BX.CrmEntityType.enumeration.contact?"enableContact":"enableCompany",false)?BX.Crm.EntityEditorClientMode.edit:BX.Crm.EntityEditorClientMode.select};BX.Crm.EntityEditorClientLight.prototype.resolveDataTagName=function(t){var e=this._schemeElement.getDataArrayParam("compound",null);if(BX.type.isArray(e)){for(var i=0,n=e.length;i<n;i++){if(BX.prop.getString(e[i],"entityTypeName","")===t){return BX.prop.getString(e[i],"tagName","")}}}return""};BX.Crm.EntityEditorClientLight.prototype.renderContact=function(){var t=this._schemeElement.getDataStringParam("contactLegend","");if(t===""){t=BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.contact)}this.removeContactAllSearchBoxes();this.removeContactAllPanels();if(this.isInEditMode()){this._contactWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-inner-row"}});this._innerContainer.appendChild(this._contactWrapper);this._contactTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},text:t})]});this._contactWrapper.appendChild(this._contactTitleWrapper);this._addContactButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-add"},text:this.getMessage("addParticipant")});this._contactWrapper.appendChild(this._addContactButton);BX.bind(this._addContactButton,"click",BX.delegate(this.onContactAddButtonClick,this));this._contactSearchBoxes=[];if(this._contactInfos.length()>0){var e=this.getEntityInitialMode(BX.CrmEntityType.enumeration.contact);var i=this._contactInfos.length()>1?-2:-1;var n=e===BX.Crm.EntityEditorClientMode.edit?BX.prop.getInteger(this._entityEditParams,"contactIndex",i):i;for(var r=0,o=this._contactInfos.length();r<o;r++){var s=e;if(s===BX.Crm.EntityEditorClientMode.edit&&!(n===r||n===-1)){s=BX.Crm.EntityEditorClientMode.select}this.addContactSearchBox(this.createContactSearchBox({entityInfo:this._contactInfos.get(r),mode:s}))}}else{this.addContactSearchBox(this.createContactSearchBox())}}else if(this._contactInfos.length()>0&&this.isContactEnabled()){this._contactTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-title"}});var a=BX.create("span",{props:{className:"crm-entity-widget-content-subtitle-text"},children:[BX.create("span",{text:t})]});this._contactTitleWrapper.appendChild(a);if(!this.isReadOnly()){a.appendChild(BX.create("span",{props:{className:"crm-entity-card-widget-title-edit-icon"}}))}var l=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-container"}});this._innerWrapper.appendChild(l);l.appendChild(this._contactTitleWrapper);var d=this.resolveDataTagName(BX.CrmEntityType.names.contact);if(d===""){d="CONTACT_IDS"}var h=BX.create("div",{props:{className:"crm-entity-widget-before-action"},attrs:{"data-field-tag":d}});l.appendChild(h);this._contactPanels=[];for(r=0,o=this._contactInfos.length();r<o;r++){var p=this._contactInfos.get(r);var u=this._schemeElement.getDataBooleanParam("useExternalRequisiteBinding",false);var c={editor:this,entityInfo:p,loaderConfig:BX.prop.getObject(this._primaryLoaderConfig,p.getTypeName(),null),enableEntityTypeCaption:false,enableRequisite:false,enableCommunications:this._editor.areCommunicationControlsEnabled(),enableAddress:this.isClientFieldVisible("ADDRESS"),enableTooltip:this.isClientFieldVisible("REQUISITES"),mode:BX.Crm.EntityEditorMode.view,clientEditorFieldsParams:this.getClientEditorFieldsParams(p.getTypeName()),canChangeDefaultRequisite:!u,useExternalRequisiteBinding:u};var m=r===0&&!(this.isCompanyEnabled()&&this.hasCompanies());if(m){c["enableRequisite"]=true;c["requisiteBinding"]=this._model.getField("REQUISITE_BINDING",{});c["requisiteSelectUrl"]=this._editor.getEntityRequisiteSelectUrl(BX.CrmEntityType.names.contact,p.getId());c["requisiteMode"]=BX.Crm.EntityEditorMode.edit}if(u){c["canChangeDefaultRequisite"]=m}var y=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+p.getId().toString(),c);this._contactPanels.push(y);y.setContainer(l);y.layout();if(m){y.addRequisiteChangeListener(this._requisiteChangeHandler)}y.addRequisiteListChangeListener(this.onRequisiteListChange.bind(this))}}};BX.Crm.EntityEditorClientLight.prototype.renderCompany=function(){var t=this._schemeElement.getDataStringParam("companyLegend","");if(t===""){t=BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.company)}this.removeCompanyAllSearchBoxes();this.removeCompanyAllPanels();if(this.isInEditMode()){this._companyWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-inner-row"}});this._innerContainer.appendChild(this._companyWrapper);this._companyTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{props:{className:"crm-entity-widget-content-block-title-text"},text:t})]});this._companyWrapper.appendChild(this._companyTitleWrapper);if(this._enableCompanyMultiplicity){this._addCompanyButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-add"},text:this.getMessage("addParticipant")});this._companyWrapper.appendChild(this._addCompanyButton);BX.bind(this._addCompanyButton,"click",BX.delegate(this.onCompanyAddButtonClick,this))}this._companySearchBoxes=[];if(this._companyInfos.length()>0){var e=this.getEntityInitialMode(BX.CrmEntityType.enumeration.company);var i=this._companyInfos.length()>1?-2:-1;var n=e===BX.Crm.EntityEditorClientMode.edit?BX.prop.getInteger(this._entityEditParams,"companyIndex",i):i;for(var r=0,o=this._companyInfos.length();r<o;r++){var s=e;if(s===BX.Crm.EntityEditorClientMode.edit&&!(n===r||n===-1)){s=BX.Crm.EntityEditorClientMode.select}this.addCompanySearchBox(this.createCompanySearchBox({entityInfo:this._companyInfos.get(r),mode:s}))}}else{this.addCompanySearchBox(this.createCompanySearchBox())}}else if(this.isCompanyEnabled()&&this._companyInfos.length()>0){this._companyTitleWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-title"}});var a=BX.create("span",{props:{className:"crm-entity-widget-content-subtitle-text"},children:[BX.create("span",{text:t})]});this._companyTitleWrapper.appendChild(a);if(!this.isReadOnly()){a.appendChild(BX.create("span",{props:{className:"crm-entity-card-widget-title-edit-icon"}}))}var l=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner-container"}});this._innerWrapper.appendChild(l);l.appendChild(this._companyTitleWrapper);var d=this.resolveDataTagName(BX.CrmEntityType.names.company);if(d===""){d=this._enableCompanyMultiplicity?"COMPANY_IDS":"COMPANY_ID"}var h=BX.create("div",{props:{className:"crm-entity-widget-before-action"},attrs:{"data-field-tag":d}});l.appendChild(h);this._companyPanels=[];for(r=0,o=this._companyInfos.length();r<o;r++){var p=this._companyInfos.get(r);var u=this._schemeElement.getDataBooleanParam("useExternalRequisiteBinding",false);var c={editor:this,entityInfo:p,loaderConfig:BX.prop.getObject(this._primaryLoaderConfig,p.getTypeName(),null),enableEntityTypeCaption:false,enableRequisite:false,enableCommunications:this._editor.areCommunicationControlsEnabled(),enableAddress:this.isClientFieldVisible("ADDRESS"),enableTooltip:this.isClientFieldVisible("REQUISITES"),mode:BX.Crm.EntityEditorMode.view,clientEditorFieldsParams:this.getClientEditorFieldsParams(p.getTypeName()),canChangeDefaultRequisite:!u,useExternalRequisiteBinding:u};var m=r===0;if(m){c["requisiteBinding"]=this._model.getField("REQUISITE_BINDING",{});c["requisiteSelectUrl"]=this._editor.getEntityRequisiteSelectUrl(BX.CrmEntityType.names.company,p.getId());c["requisiteMode"]=BX.Crm.EntityEditorMode.edit}if(u){c["canChangeDefaultRequisite"]=m}var y=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+p.getId().toString(),c);this._companyPanels.push(y);y.setContainer(l);y.layout();if(m){y.addRequisiteChangeListener(this._requisiteChangeHandler)}y.addRequisiteListChangeListener(this.onRequisiteListChange.bind(this))}}};BX.Crm.EntityEditorClientLight.prototype.createCompanySearchBox=function(t){var e=BX.prop.get(t,"entityInfo",null);if(e!==null&&!(e instanceof BX.CrmEntityInfo)){e=null}var i=this._editor.canCreateCompany();if(i){i=BX.prop.getBoolean(this._schemeElement.getDataObjectParam("creation",{}),BX.CrmEntityType.names.company.toLowerCase(),true)}return BX.Crm.EntityEditorClientSearchBox.create(this._id,{entityTypeId:BX.CrmEntityType.enumeration.company,entityTypeName:BX.CrmEntityType.names.company,entityInfo:e,enableCreation:i,enableDeletion:false,enableQuickEdit:this.isQuickEditEnabled(),mode:BX.prop.getInteger(t,"mode",BX.Crm.EntityEditorClientMode.select),editor:this._editor,loaderConfig:this._primaryLoaderConfig,lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastCompanyInfos",[]),container:this._companyWrapper,placeholder:this.getMessage("companySearchPlaceholder"),parentField:this,clientEditorEnabled:this._schemeElement.getData().hasOwnProperty("clientEditorFieldsParams"),clientEditorFields:this.getClientVisibleFieldsList(BX.CrmEntityType.names.company),clientEditorFieldsParams:this.getClientEditorFieldsParams(BX.CrmEntityType.names.company)})};BX.Crm.EntityEditorClientLight.prototype.addCompanySearchBox=function(t,e){if(!BX.type.isPlainObject(e)){e={}}this._companySearchBoxes.push(t);var i=BX.prop.getObject(e,"layoutOptions",{});if(this._addCompanyButton){i["anchor"]=this._addCompanyButton}t.layout(i);t.addResetListener(this._companyResetHandler);t.addTitleChangeListener(this._companyNameChangeHandler);t.addChangeListener(this._companyChangeHandler);t.addDeletionListener(this._companyDeletionHandler);t.addMultifieldChangeListener(this._multifieldChangeHandler);var n=this._companySearchBoxes.length>1;for(var r=0,o=this._companySearchBoxes.length;r<o;r++){this._companySearchBoxes[r].enableDeletion(n)}return t};BX.Crm.EntityEditorClientLight.prototype.removeCompanySearchBox=function(t){var e=this.findCompanySearchBoxIndex(t);if(e<0){return}t.removeResetListener(this._companyResetHandler);t.removeTitleChangeListener(this._companyNameChangeHandler);t.removeChangeListener(this._companyChangeHandler);t.removeDeletionListener(this._companyDeletionHandler);t.removeMultifieldChangeListener(this._multifieldChangeHandler);t.clearLayout();this._companySearchBoxes.splice(e,1);var i=this._companySearchBoxes.length>1;for(var n=0,r=this._companySearchBoxes.length;n<r;n++){this._companySearchBoxes[n].enableDeletion(i)}};BX.Crm.EntityEditorClientLight.prototype.findCompanySearchBoxIndex=function(t){for(var e=0,i=this._companySearchBoxes.length;e<i;e++){if(t===this._companySearchBoxes[e]){return e}}return-1};BX.Crm.EntityEditorClientLight.prototype.createContactSearchBox=function(t){var e=BX.prop.get(t,"entityInfo",null);if(e!==null&&!(e instanceof BX.CrmEntityInfo)){e=null}var i=this._editor.canCreateContact();if(i){i=BX.prop.getBoolean(this._schemeElement.getDataObjectParam("creation",{}),BX.CrmEntityType.names.contact.toLowerCase(),true)}return BX.Crm.EntityEditorClientSearchBox.create(this._id,{entityTypeId:BX.CrmEntityType.enumeration.contact,entityTypeName:BX.CrmEntityType.names.contact,entityInfo:e,enableCreation:i,enableDeletion:BX.prop.getBoolean(t,"enableDeletion",true),enableQuickEdit:this.isQuickEditEnabled(),mode:BX.prop.getInteger(t,"mode",BX.Crm.EntityEditorClientMode.select),editor:this._editor,loaderConfig:this._primaryLoaderConfig,lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastContactInfos",[]),container:this._contactWrapper,placeholder:this.getMessage("contactSearchPlaceholder"),parentField:this,clientEditorEnabled:this._schemeElement.getData().hasOwnProperty("clientEditorFieldsParams"),clientEditorFields:this.getClientVisibleFieldsList(BX.CrmEntityType.names.contact),clientEditorFieldsParams:this.getClientEditorFieldsParams(BX.CrmEntityType.names.contact)})};BX.Crm.EntityEditorClientLight.prototype.addContactSearchBox=function(t,e){if(!BX.type.isPlainObject(e)){e={}}this._contactSearchBoxes.push(t);var i=BX.prop.getObject(e,"layoutOptions",{});if(this._addContactButton){i["anchor"]=this._addContactButton}t.layout(i);t.addResetListener(this._contactResetHandler);t.addTitleChangeListener(this._contactNameChangeHandler);t.addChangeListener(this._contactChangeHandler);t.addDeletionListener(this._contactDeletionHandler);t.addMultifieldChangeListener(this._multifieldChangeHandler);var n=this._contactSearchBoxes.length>1;for(var r=0,o=this._contactSearchBoxes.length;r<o;r++){this._contactSearchBoxes[r].enableDeletion(n)}return t};BX.Crm.EntityEditorClientLight.prototype.removeContactSearchBox=function(t){var e=this.findContactSearchBoxIndex(t);if(e<0){return}t.removeResetListener(this._contactResetHandler);t.removeTitleChangeListener(this._contactNameChangeHandler);t.removeChangeListener(this._contactChangeHandler);t.removeDeletionListener(this._contactDeletionHandler);t.removeMultifieldChangeListener(this._multifieldChangeHandler);t.clearLayout();this._contactSearchBoxes.splice(e,1);var i=this._contactSearchBoxes.length>1;for(var n=0,r=this._contactSearchBoxes.length;n<r;n++){this._contactSearchBoxes[n].enableDeletion(i)}};BX.Crm.EntityEditorClientLight.prototype.removeContactAllSearchBoxes=function(){if(BX.Type.isArray(this._contactSearchBoxes)){for(var t=0,e=this._contactSearchBoxes.length;t<e;t++){var i=this._contactSearchBoxes[t];i.removeResetListener(this._contactResetHandler);i.removeTitleChangeListener(this._contactNameChangeHandler);i.removeChangeListener(this._contactChangeHandler);i.removeDeletionListener(this._contactDeletionHandler);i.removeMultifieldChangeListener(this._multifieldChangeHandler);i.clearLayout()}}this._contactSearchBoxes=[]};BX.Crm.EntityEditorClientLight.prototype.removeCompanyAllSearchBoxes=function(){if(BX.Type.isArray(this._companySearchBoxes)){for(var t=0,e=this._companySearchBoxes.length;t<e;t++){var i=this._companySearchBoxes[t];i.removeResetListener(this._companyResetHandler);i.removeTitleChangeListener(this._companyNameChangeHandler);i.removeChangeListener(this._companyChangeHandler);i.removeDeletionListener(this._companyDeletionHandler);i.removeMultifieldChangeListener(this._multifieldChangeHandler);i.clearLayout()}}this._companySearchBoxes=[]};BX.Crm.EntityEditorClientLight.prototype.removeCompanyAllPanels=function(){if(BX.Type.isArray(this._companyPanels)){for(var t=0,e=this._companyPanels.length;t<e;t++){var i=this._companyPanels[t];i.clearLayout()}}this._companyPanels=[]};BX.Crm.EntityEditorClientLight.prototype.removeContactAllPanels=function(){if(BX.Type.isArray(this._contactPanels)){for(var t=0,e=this._contactPanels.length;t<e;t++){var i=this._contactPanels[t];i.clearLayout()}}this._contactPanels=[]};BX.Crm.EntityEditorClientLight.prototype.findContactSearchBoxIndex=function(t){for(var e=0,i=this._contactSearchBoxes.length;e<i;e++){if(t===this._contactSearchBoxes[e]){return e}}return-1};BX.Crm.EntityEditorClientLight.prototype.save=function(){this._info["COMPANY_DATA"]=this.saveEntityInfos(this._companySearchBoxes,this._companyInfos);this._info["CONTACT_DATA"]=this.saveEntityInfos(this._contactSearchBoxes,this._contactInfos)};BX.Crm.EntityEditorClientLight.prototype.saveEntityInfos=function(t,e){var i,n;if(t!==null){for(i=0,n=t.length;i<n;i++){if(t[i].isNeedToSave()){t[i].save()}}}var r=[];if(e!==null){var o=e.getItems();for(i=0,n=o.length;i<n;i++){r.push(o[i].getSettings())}}return r};BX.Crm.EntityEditorClientLight.prototype.validate=function(t){var e=BX.Crm.EntityAsyncValidator.create();this.validateSearchBoxes(this._companySearchBoxes,e,t);this.validateSearchBoxes(this._contactSearchBoxes,e,t);return e.validate()};BX.Crm.EntityEditorClientLight.prototype.validateSearchBoxes=function(t,e,i){if(BX.Type.isArray(t)){for(var n=0,r=t.length;n<r;n++){e.addResult(t[n].validate(i))}}};BX.Crm.EntityEditorClientLight.prototype.release=function(){this.releaseSearchBoxes(this._contactSearchBoxes);this.releasePanels(this._contactPanels);this.releaseSearchBoxes(this._companySearchBoxes);this.releasePanels(this._companyPanels)};BX.Crm.EntityEditorClientLight.prototype.releaseSearchBoxes=function(t){if(!BX.Type.isArray(t)){return}for(var e=0,i=t.length;e<i;e++){t[e].release()}};BX.Crm.EntityEditorClientLight.prototype.releasePanels=function(t){if(!BX.Type.isArray(t)){return}for(var e=0,i=t.length;e<i;e++){t[e].release()}};BX.Crm.EntityEditorClientLight.prototype.getClientEditorFieldsParams=function(t){return BX.prop.getObject(this._schemeElement.getDataObjectParam("clientEditorFieldsParams",{}),t,{})};BX.Crm.EntityEditorClientLight.prototype.onContactAddButtonClick=function(t){this.addContactSearchBox(this.createContactSearchBox()).focus()};BX.Crm.EntityEditorClientLight.prototype.onCompanyAddButtonClick=function(t){if(this._enableCompanyMultiplicity){this.addCompanySearchBox(this.createCompanySearchBox()).focus()}};BX.Crm.EntityEditorClientLight.prototype.onCompanyReset=function(t,e){if(e){this.removeCompany(e);this.markAsChanged()}};BX.Crm.EntityEditorClientLight.prototype.onCompanyNameChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorClientLight.prototype.onCompanyChange=function(t,e,i){var n=false;if(i){this.removeCompany(i);n=true}if(e){this.addCompany(e);n=true}if(!n){return}this.markAsChanged();if(!this._enableCompanyMultiplicity){if(e.getId()>0){var r=BX.prop.getObject(this._secondaryLoaderConfig,BX.CrmEntityType.names.company,null);if(r){BX.CrmDataLoader.create(this._id,{serviceUrl:r["url"],action:r["action"],params:{PRIMARY_TYPE_NAME:BX.CrmEntityType.names.company,PRIMARY_ID:e.getId(),SECONDARY_TYPE_NAME:BX.CrmEntityType.names.contact,OWNER_TYPE_NAME:this.getOwnerTypeName()}}).load(BX.delegate(this.onContactInfosLoad,this))}}}};BX.Crm.EntityEditorClientLight.prototype.onCompanyDelete=function(t,e){if(e){this._companyInfos.remove(e);this.markAsChanged()}this.removeCompanySearchBox(t)};BX.Crm.EntityEditorClientLight.prototype.onContactChange=function(t,e,i){var n=false;if(i){this.removeContact(i);n=true}if(e){this.addContact(e);n=true}if(n){this.markAsChanged()}};BX.Crm.EntityEditorClientLight.prototype.onContactNameChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorClientLight.prototype.onContactDelete=function(t,e){if(e){this._contactInfos.remove(e);this.markAsChanged()}this.removeContactSearchBox(t)};BX.Crm.EntityEditorClientLight.prototype.onContactReset=function(t,e){if(e){this.removeContact(e);this.markAsChanged()}};BX.Crm.EntityEditorClientLight.prototype.onContactInfosLoad=function(t,e){var i,n;var r=[];var o=BX.type.isArray(e["ENTITY_INFOS"])?e["ENTITY_INFOS"]:[];for(i=0,n=o.length;i<n;i++){r.push(BX.CrmEntityInfo.create(o[i]))}this._contactInfos.removeAll();for(i=0,n=r.length;i<n;i++){this._contactInfos.add(r[i])}this.markAsChanged();this.removeContactAllSearchBoxes();if(r.length>0){for(i=0,n=r.length;i<n;i++){this.addContactSearchBox(this.createContactSearchBox({entityInfo:r[i]}))}}else{this.addContactSearchBox(this.createContactSearchBox())}};BX.Crm.EntityEditorClientLight.prototype.onRequisiteChange=function(t,e){if(this.isInEditMode()){this.markAsChanged()}else{this._editor.saveData({REQUISITE_ID:BX.prop.getInteger(e,"requisiteId",0),BANK_DETAIL_ID:BX.prop.getInteger(e,"bankDetailId",0)})}};BX.Crm.EntityEditorClientLight.prototype.onRequisiteListChange=function(t,e){var i=this._schemeElement.getDataStringParam("info","");var n=this._model.getInitFieldValue(i,{});var r=BX.prop.getString(e,"entityTypeName","");var o=BX.prop.getInteger(e,"entityId",0);var s=BX.prop.getArray(e,"requisites",[]);var a=r+"_DATA";if(n.hasOwnProperty(a)&&o>0){for(var l=0;l<n[a].length;l++){var d=n[a][l];if(d.id==o){if(!d.hasOwnProperty("advancedInfo")){d.advancedInfo={}}d.advancedInfo.hasEditRequisiteData=true;d.advancedInfo.requisiteData=s;n[a][l]=d;this._model.setInitFieldValue(i,n);break}}}};BX.Crm.EntityEditorClientLight.prototype.onMultifieldChange=function(t){this.markAsChanged()};BX.Crm.EntityEditorClientLight.prototype.prepareEntitySubmitData=function(t){if(!BX.type.isArray(t)){return[]}var e=[];for(var i=0,n=t.length;i<n;i++){var r=t[i].getEntity();if(!r){continue}var o={};var s=t[i].getMode();if(s===BX.Crm.EntityEditorClientMode.select||s===BX.Crm.EntityEditorClientMode.edit&&r.getTitle()!==""){o["id"]=r.getId()}if(s===BX.Crm.EntityEditorClientMode.create||s===BX.Crm.EntityEditorClientMode.edit&&r.getTitle()!==""){o["title"]=r.getTitle();o["multifields"]=r.getMultifields();o["requisites"]=r.getRequisitesForSave()}e.push(o)}return e};BX.Crm.EntityEditorClientLight.prototype.onBeforeSubmit=function(){var t={};if(this.isCompanyEnabled()){t["COMPANY_DATA"]=this.prepareEntitySubmitData(this._companySearchBoxes)}if(this.isContactEnabled()){t["CONTACT_DATA"]=this.prepareEntitySubmitData(this._contactSearchBoxes)}this.createDataElement("data",JSON.stringify(t))};if(typeof BX.Crm.EntityEditorClientLight.messages==="undefined"){BX.Crm.EntityEditorClientLight.messages={}}BX.Crm.EntityEditorClientLight.create=function(t,e){var i=new BX.Crm.EntityEditorClientLight;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorClient==="undefined"){BX.Crm.EntityEditorClient=function(){BX.Crm.EntityEditorClient.superclass.constructor.apply(this);this._info=null;this._enablePrimaryEntity=true;this._primaryEntityTypeName="";this._primaryEntityInfo=null;this._primaryEntityBindingInfos=null;this._primaryEntityEditor=null;this._secondaryEntityTypeName="";this._secondaryEntityInfos=null;this._secondaryEntityEditor=null;this._dataElements=null;this._map=null;this._bindingTracker=null;this._innerWrapper=null};BX.extend(BX.Crm.EntityEditorClient,BX.Crm.EntityEditorField);BX.Crm.EntityEditorClient.prototype.doInitialize=function(){BX.Crm.EntityEditorClient.superclass.doInitialize.apply(this);this._map=this._schemeElement.getDataObjectParam("map",{});this.initializeFromModel()};BX.Crm.EntityEditorClient.prototype.initializeFromModel=function(){this._info=this._model.getSchemeField(this._schemeElement,"info",{});this._enablePrimaryEntity=this._schemeElement.getDataBooleanParam("enablePrimaryEntity",true);if(this._enablePrimaryEntity){var t=BX.prop.getObject(this._info,"PRIMARY_ENTITY_DATA",null);var e=t?BX.CrmEntityInfo.create(t):null;if(e){this.setPrimaryEntity(e)}else{this.setPrimaryEntityTypeName(this._schemeElement.getDataStringParam("primaryEntityTypeName",BX.CrmEntityType.names.company))}}this.setSecondaryEntityTypeName(this._schemeElement.getDataStringParam("secondaryEntityTypeName",BX.CrmEntityType.names.contact));var i=null;var n=this._schemeElement.getDataStringParam("secondaryEntityInfo","");if(n!==""){i=this._model.getField(n,[])}else{i=BX.prop.getArray(this._info,"SECONDARY_ENTITY_DATA",[])}this._secondaryEntityInfos=BX.Collection.create();this._primaryEntityBindingInfos=BX.Collection.create();var r=e&&e.getTypeName()===BX.CrmEntityType.names.company?e.getId():0;var o,s,a;for(o=0,s=i.length;o<s;o++){a=BX.CrmEntityInfo.create(i[o]);if(a.getId()<=0){continue}if(r>0&&a.checkEntityBinding(BX.CrmEntityType.names.company,r)){this._primaryEntityBindingInfos.add(a)}else{this._secondaryEntityInfos.add(a)}}this._bindingTracker=BX.Crm.EntityBindingTracker.create()};BX.Crm.EntityEditorClient.prototype.hasContentToDisplay=function(){return this._primaryEntityInfo!==null||this._secondaryEntityInfos!==null&&this._secondaryEntityInfos.length()>0};BX.Crm.EntityEditorClient.prototype.getModeSwitchType=function(t){var e=BX.Crm.EntityEditorModeSwitchType.common;if(t===BX.Crm.EntityEditorMode.edit){e|=BX.Crm.EntityEditorModeSwitchType.button|BX.Crm.EntityEditorModeSwitchType.content}return e};BX.Crm.EntityEditorClient.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Crm.EntityEditorClient.prototype.getEntityCreateUrl=function(t){return this._editor.getEntityCreateUrl(t)};BX.Crm.EntityEditorClient.prototype.getEntityRequisiteSelectUrl=function(t,e){return this._editor.getEntityRequisiteSelectUrl(t,e)};BX.Crm.EntityEditorClient.prototype.reset=function(){this.initializeFromModel()};BX.Crm.EntityEditorClient.prototype.rollback=function(){if(this.isChanged()){this.initializeFromModel()}};BX.Crm.EntityEditorClient.prototype.doSetMode=function(t){this.rollback()};BX.Crm.EntityEditorClient.prototype.createDataElement=function(t,e){var i=BX.prop.getString(this._map,t,"");if(i===""){return}var n=BX.create("input",{attrs:{name:i,type:"hidden",value:e}});if(!this._dataElements){this._dataElements={}}this._dataElements[t]=n;if(this._wrapper){this._wrapper.appendChild(n)}};BX.Crm.EntityEditorClient.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated();this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this._schemeElement.getTitle();if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._dataElements={};if(!this.hasContentToDisplay()&&this.isInViewMode()){this._wrapper.appendChild(this.createTitleNode(e));this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block-inner"},text:this.getMessage("isEmpty")})}else{this._innerWrapper=BX.create("div",{props:{className:"crm-entity-widget-clients-block"}});this._innerWrapper.appendChild(this.createTitleNode(e));if(this.isInEditMode()){if(this._enablePrimaryEntity){this.createDataElement("primaryEntityType",this.getPrimaryEntityTypeName());this.createDataElement("primaryEntityId",this.getPrimaryEntityId());this.createDataElement("unboundSecondaryEntityIds","");this.createDataElement("boundSecondaryEntityIds","")}this.createDataElement("secondaryEntityType",this.getSecondaryEntityTypeName());this.createDataElement("secondaryEntityIds",this.getAllSecondaryEntityIds().join(","))}var i=BX.create("div",{props:{className:this.isInEditMode()?"crm-entity-widget-content-block-clients":""}});this._innerWrapper.appendChild(i);var n=BX.create("div",{});i.appendChild(n);var r=this._schemeElement.getDataObjectParam("loaders",{});var o=BX.prop.getObject(r,"primary",{});var s=BX.prop.getObject(r,"secondary",{});if(this._enablePrimaryEntity){this._primaryEntityEditor=BX.Crm.PrimaryClientEditor.create(this._id+"_PRIMARY",{entityInfo:this._primaryEntityInfo,entityTypeName:this._primaryEntityTypeName,lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastPrimaryEntityInfos",[]),loaderConfig:o,requisiteBinding:this._model.getField("REQUISITE_BINDING",{}),editor:this,mode:this._mode,onChange:BX.delegate(this.onPrimaryEntityChange,this),onDelete:BX.delegate(this.onPrimaryEntityDelete,this),onBindingAdd:BX.delegate(this.onPrimaryEntityBindingAdd,this),onBindingDelete:BX.delegate(this.onPrimaryEntityBindingDelete,this),onBindingRelease:BX.delegate(this.onPrimaryEntityBindingRelease,this),container:i,achor:n});this._primaryEntityEditor.layout()}var a=BX.create("div",{props:{className:"crm-entity-widget-participants-container"}});i.appendChild(a);this._secondaryEntityEditor=BX.Crm.SecondaryClientEditor.create(this._id+"_SECONDARY",{entityInfos:this._secondaryEntityInfos.getItems(),entityTypeName:this._secondaryEntityTypeName,entityLegend:this._schemeElement.getDataStringParam("secondaryEntityLegend",""),lastEntityInfos:this._model.getSchemeField(this._schemeElement,"lastSecondaryEntityInfos",[]),primaryLoader:o,secondaryLoader:s,mode:this._mode,onAdd:BX.delegate(this.onSecondaryEntityAdd,this),onDelete:BX.delegate(this.onSecondaryEntityDelete,this),onBeforeAdd:BX.delegate(this.onSecondaryEntityBeforeAdd,this),editor:this,container:a});this._secondaryEntityEditor.layout();if(this._primaryEntityEditor){if(this.isInEditMode()){this._secondaryEntityEditor.setVisible(this._primaryEntityInfo!==null)}else{this._secondaryEntityEditor.setVisible(this._secondaryEntityInfos.length()>0)}}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorClient.prototype.doClearLayout=function(t){if(this._primaryEntityEditor){this._primaryEntityEditor.clearLayout();this._primaryEntityEditor=null}if(this._secondaryEntityEditor){this._secondaryEntityEditor.clearLayout();this._secondaryEntityEditor=null}for(var e in this._dataElements){if(this._dataElements.hasOwnProperty(e)){BX.remove(this._dataElements[e])}}this._dataElements=null;this._innerWrapper=null};BX.Crm.EntityEditorClient.prototype.getOwnerTypeName=function(){return this._editor.getEntityTypeName()};BX.Crm.EntityEditorClient.prototype.getOwnerTypeId=function(){return this._editor.getEntityTypeId()};BX.Crm.EntityEditorClient.prototype.getOwnerId=function(){return this._editor.getEntityId()};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityTypeName=function(){return this._primaryEntityTypeName};BX.Crm.EntityEditorClient.prototype.setPrimaryEntityTypeName=function(t){if(this._primaryEntityTypeName!==t){this._primaryEntityTypeName=t}};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityId=function(){return this._primaryEntityInfo?this._primaryEntityInfo.getId():0};BX.Crm.EntityEditorClient.prototype.getPrimaryEntity=function(){return this._primaryEntityInfo};BX.Crm.EntityEditorClient.prototype.setPrimaryEntity=function(t){if(t instanceof BX.CrmEntityInfo){this._primaryEntityInfo=t;this.setPrimaryEntityTypeName(t.getTypeName())}else{this._primaryEntityInfo=null}this.markAsChanged()};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityBindings=function(){return this._primaryEntityBindingInfos};BX.Crm.EntityEditorClient.prototype.getSecondaryEntityTypeName=function(){return this._secondaryEntityTypeName};BX.Crm.EntityEditorClient.prototype.setSecondaryEntityTypeName=function(t){if(this._secondaryEntityTypeName!==t){this._secondaryEntityTypeName=t}};BX.Crm.EntityEditorClient.prototype.getSecondaryEntities=function(){return this._secondaryEntityInfos.getItems()};BX.Crm.EntityEditorClient.prototype.getSecondaryEntityById=function(t){if(!this._secondaryEntityInfos){return null}return this._secondaryEntityInfos.search(function(e){return e.getId()===t})};BX.Crm.EntityEditorClient.prototype.removeSecondaryEntity=function(t){if(this._secondaryEntityInfos){this._secondaryEntityInfos.remove(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.addSecondaryEntity=function(t){if(this._secondaryEntityInfos){this._secondaryEntityInfos.add(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityDelete=function(t,e){this.removeSecondaryEntity(e)};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityBeforeAdd=function(t,e,i){if(this._primaryEntityEditor&&this._primaryEntityInfo&&this._primaryEntityInfo.getTypeName()===BX.CrmEntityType.names.company){var n=this._primaryEntityInfo.getId();if(e.checkEntityBinding(BX.CrmEntityType.names.company,n)&&!this._bindingTracker.isUnbound(e)){this._primaryEntityEditor.addBinding(this._primaryEntityEditor.createBinding(e));i["cancel"]=true}}};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityAdd=function(t,e){this.addSecondaryEntity(e)};BX.Crm.EntityEditorClient.prototype.onSecondaryEntityBind=function(t,e){this._secondaryEntityEditor.removeItem(this._secondaryEntityEditor.getItemById(e.getId()));if(this._primaryEntityEditor){this._primaryEntityEditor.addBinding(this._primaryEntityEditor.createBinding(e))}this._bindingTracker.bind(e)};BX.Crm.EntityEditorClient.prototype.getAllSecondaryEntityIds=function(){var t=this.getAllSecondaryEntityInfos();var e=[];for(var i=0,n=t.length;i<n;i++){e.push(t[i].getId())}return e};BX.Crm.EntityEditorClient.prototype.getAllSecondaryEntityInfos=function(){return[].concat(this._primaryEntityBindingInfos.getItems(),this._secondaryEntityInfos.getItems())};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityBindings=function(){return this._primaryEntityBindingInfos.getItems()};BX.Crm.EntityEditorClient.prototype.getPrimaryEntityBindingById=function(t){if(!this._primaryEntityBindingInfos){return null}return this._primaryEntityBindingInfos.search(function(e){return e.getId()===t})};BX.Crm.EntityEditorClient.prototype.addPrimaryEntityBinding=function(t){if(this._primaryEntityBindingInfos){this._primaryEntityBindingInfos.add(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.removePrimaryEntityBinding=function(t){if(this._primaryEntityBindingInfos){this._primaryEntityBindingInfos.remove(t);this.markAsChanged()}};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityBindingAdd=function(t,e){this.addPrimaryEntityBinding(e)};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityBindingDelete=function(t,e){this.removePrimaryEntityBinding(e)};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityBindingRelease=function(t,e){this._bindingTracker.unbind(e);this._secondaryEntityEditor.addItem(this._secondaryEntityEditor.createItem(e))};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityDelete=function(t,e){var i=[].concat(this._primaryEntityBindingInfos.getItems(),this._secondaryEntityInfos.getItems());this._secondaryEntityInfos=BX.Collection.create();this._primaryEntityBindingInfos=BX.Collection.create();var n=null;if(i.length>0){n=i.shift()}this.setPrimaryEntity(n);this._primaryEntityEditor.setEntity(n);this._secondaryEntityEditor.setEntities(i);this._secondaryEntityEditor.setVisible(n!==null)};BX.Crm.EntityEditorClient.prototype.onPrimaryEntityChange=function(t,e){this.setPrimaryEntity(e);if(this._primaryEntityTypeName===BX.CrmEntityType.names.company){this._bindingTracker.reset();this._primaryEntityBindingInfos=BX.Collection.create();this._secondaryEntityInfos=BX.Collection.create();this._secondaryEntityEditor.clearItems();this._secondaryEntityEditor.reloadEntities()}this._secondaryEntityEditor.setVisible(true)};BX.Crm.EntityEditorClient.prototype.save=function(){var t,e,i;var n=this._schemeElement.getDataObjectParam("map",{});if(this._enablePrimaryEntity){this._model.setMappedField(n,"primaryEntityType",this._primaryEntityTypeName);var r=this._primaryEntityInfo?this._primaryEntityInfo.getId():0;this._model.setMappedField(n,"primaryEntityId",r);if(this._primaryEntityInfo){this._info["PRIMARY_ENTITY_DATA"]=this._primaryEntityInfo.getSettings()}else{delete this._info["PRIMARY_ENTITY_DATA"]}if(r>0){var o=this._bindingTracker.getUnboundEntities();var s=[];for(t=0,e=o.length;t<e;t++){s.push(o[t].getId())}if(s.length>0){for(t=0,e=s.length;t<e;t++){i=this.getSecondaryEntityById(s[t]);if(i){i.removeEntityBinding(this._primaryEntityTypeName,r)}}}this._model.setMappedField(n,"unboundSecondaryEntityIds",s.join(","));var a=this._bindingTracker.getBoundEntities();var l=[];for(t=0,e=a.length;t<e;t++){l.push(a[t].getId())}if(l.length>0){for(t=0,e=l.length;t<e;t++){i=this.getPrimaryEntityBindingById(l[t]);if(i){i.addEntityBinding(this._primaryEntityTypeName,r)}}}this._model.setMappedField(n,"boundSecondaryEntityIds",l.join(","));this._bindingTracker.reset()}}this._model.setMappedField(n,"secondaryEntityType",this._secondaryEntityTypeName);var d=this.getAllSecondaryEntityInfos();var h=[];var p=[];for(t=0,e=d.length;t<e;t++){i=d[t];h.push(i.getSettings());p.push(i.getId())}this._model.setMappedField(n,"secondaryEntityIds",p.join(","));this._info["SECONDARY_ENTITY_DATA"]=h};BX.Crm.EntityEditorClient.prototype.onBeforeSubmit=function(){if(!this._dataElements){return}for(var t in this._dataElements){if(!this._dataElements.hasOwnProperty(t)){continue}var e=BX.prop.getString(this._map,t,"");if(e!==""){this._dataElements[t].value=this._model.getField(e,"")}}};BX.Crm.EntityEditorClient.create=function(t,e){var i=new BX.Crm.EntityEditorClient;i.initialize(t,e);return i}}if(typeof BX.Crm.EntityEditorEntity==="undefined"){BX.Crm.EntityEditorEntity=function(){BX.Crm.EntityEditorEntity.superclass.constructor.apply(this);this._entityTypeName="";this._entityInfo=null;this._entitySelectClickHandler=BX.delegate(this.onEntitySelectClick,this);this._entitySelectButton=null;this._entitySelector=null;this._entityWrapper=null;this._dataInput=null;this._skeleton=null};BX.extend(BX.Crm.EntityEditorEntity,BX.Crm.EntityEditorField);BX.Crm.EntityEditorEntity.prototype.doInitialize=function(){BX.Crm.EntityEditorEntity.superclass.doInitialize.apply(this);this._loaderConfig=this._schemeElement.getDataObjectParam("loader",{});this.initializeFromModel()};BX.Crm.EntityEditorEntity.prototype.initializeFromModel=function(){var t=this._model.getSchemeField(this._schemeElement,"info",null);if(t){this.setEntity(BX.CrmEntityInfo.create(t))}else{this.setEntityTypeName(this._schemeElement.getDataStringParam("entityTypeName",""))}};BX.Crm.EntityEditorEntity.prototype.getOwnerTypeName=function(){return this._editor.getEntityTypeName()};BX.Crm.EntityEditorEntity.prototype.getOwnerTypeId=function(){return this._editor.getEntityTypeId()};BX.Crm.EntityEditorEntity.prototype.getOwnerId=function(){return this._editor.getEntityId()};BX.Crm.EntityEditorEntity.prototype.getEntityTypeName=function(){return this._entityTypeName};BX.Crm.EntityEditorEntity.prototype.setEntityTypeName=function(t){if(this._entityTypeName===t){return}this._entityTypeName=t;if(this._entitySelector){this._entitySelector=null}};BX.Crm.EntityEditorEntity.prototype.setEntity=function(t){if(this._item){if(this._hasLayout){this._item.clearLayout()}this._item=null}if(!(t instanceof BX.CrmEntityInfo)){this._entityInfo=null}else{this._entityInfo=t;this.setEntityTypeName(this._entityInfo.getTypeName());this._item=BX.Crm.ClientEditorEntityPanel.create(this._id+"_"+this._entityInfo.getId().toString(),{editor:this,entityInfo:this._entityInfo,enableEntityTypeCaption:false,enableRequisite:true,mode:this._mode,onDelete:BX.delegate(this.onItemDelete,this)});if(this._hasLayout){this._item.setContainer(this._entityWrapper);this._item.layout()}}};BX.Crm.EntityEditorEntity.prototype.setupEntity=function(t){if(this._entityInfo&&this._entityInfo.getId()===t){return}this.setEntity(null);var e=BX.prop.getObject(this._loaderConfig,this._entityTypeName,null);if(e){this.showSkeleton();BX.CrmDataLoader.create(this._id,{serviceUrl:e["url"],action:e["action"],params:{ENTITY_TYPE_NAME:this._entityTypeName,ENTITY_ID:t}}).load(BX.delegate(this.onEntityInfoLoad,this))}};BX.Crm.EntityEditorEntity.prototype.showSkeleton=function(){if(!this._skeleton){this._skeleton=BX.Crm.ClientEditorEntitySkeleton.create(this._id,{container:this._entityWrapper})}this._skeleton.layout()};BX.Crm.EntityEditorEntity.prototype.hideSkeleton=function(){if(this._skeleton){this._skeleton.clearLayout()}};BX.Crm.EntityEditorEntity.prototype.onEntityInfoLoad=function(t,e){var i=BX.prop.getObject(e,"DATA",null);if(i){this.hideSkeleton();var n=BX.CrmEntityInfo.create(i);this.setEntity(n)}};BX.Crm.EntityEditorEntity.prototype.onItemDelete=function(t){this.setEntity(null)};BX.Crm.EntityEditorEntity.prototype.reset=function(){this.initializeFromModel()};BX.Crm.EntityEditorEntity.prototype.rollback=function(){if(this.isChanged()){this.initializeFromModel()}};BX.Crm.EntityEditorEntity.prototype.doSetMode=function(t){this.rollback();if(this._item){this._item.setMode(t)}};BX.Crm.EntityEditorEntity.prototype.layout=function(t){if(this._hasLayout){return}var e=this.getName();var i=this._schemeElement.getTitle();var n=this.getValue();var r=this._mode===BX.Crm.EntityEditorMode.view;this._wrapper=BX.create("div",{props:{className:"crm-entity-widget-content-block"}});if(r&&!this._item){this.registerLayout(t);this._hasLayout=true;return}var o=BX.create("div",{props:{className:"crm-entity-widget-clients-block"}});this._wrapper.appendChild(o);o.appendChild(this.createTitleNode(i));var s=BX.create("div",{props:{className:!r?"crm-entity-widget-content-block-clients":""}});o.appendChild(s);this._entityWrapper=BX.create("div",{props:{className:"crm-entity-widget-clients-container"}});s.appendChild(this._entityWrapper);if(!r){this._entitySelectButton=BX.create("span",{props:{className:"crm-entity-widget-actions-btn-select"},text:this.getMessage("select"),events:{click:this._entitySelectClickHandler}});var a=BX.create("div",{props:{className:"crm-entity-widget-clients-actions-block"},children:[this._entitySelectButton]});this._entityWrapper.appendChild(a);this._dataInput=BX.create("input",{attrs:{name:e,type:"hidden",value:n}});this._entityWrapper.appendChild(this._dataInput)}if(this._item){this._item.setContainer(this._entityWrapper);this._item.layout()}this.registerLayout(t);this._hasLayout=true};BX.Crm.EntityEditorEntity.prototype.clearLayout=function(){if(this._item){this._item.clearLayout()}this._wrapper=BX.remove(this._wrapper);this._entityWrapper=null;this._dataInput=null;if(this._entitySelector){if(this._entitySelector.isOpened()){this._entitySelector.close()}this._entitySelector=null}this._hasLayout=false};BX.Crm.EntityEditorEntity.prototype.onEntitySelectClick=function(t){if(this._entitySelector&&this._entitySelector.isOpened()){this._entitySelector.close();return}if(!this._entitySelector){this._entitySelector=BX.Crm.EntityEditorCrmSelector.create(this._id,{entityTypeIds:[BX.CrmEntityType.resolveId(this._entityTypeName)],enableMyCompanyOnly:this._schemeElement.getDataBooleanParam("enableMyCompanyOnly",false),callback:BX.delegate(this.onEntitySelect,this)})}this._entitySelector.open(this._entitySelectButton)};BX.Crm.EntityEditorEntity.prototype.onEntitySelect=function(t,e){var i=BX.prop.getInteger(e,"entityId",0);if(this._entityInfo&&this._entityInfo.getId()===i){return}this._entitySelector.close();this.setupEntity(i)};BX.Crm.EntityEditorEntity.prototype.save=function(){this._model.setField(this.getName(),this._entityInfo?this._entityInfo.getId():0)};BX.Crm.EntityEditorEntity.prototype.onBeforeSubmit=function(){if(this._dataInput){this._dataInput.value=this._model.getField(this.getName(),"")}};BX.Crm.EntityEditorEntity.prototype.getMessage=function(t){return BX.prop.getString(BX.Crm.EntityEditorEntity.messages,t,t)};if(typeof BX.Crm.EntityEditorEntity.messages==="undefined"){BX.Crm.EntityEditorEntity.messages={}}BX.Crm.EntityEditorEntity.create=function(t,e){var i=new BX.Crm.EntityEditorEntity;i.initialize(t,e);return i}}
//# sourceMappingURL=control.map.js