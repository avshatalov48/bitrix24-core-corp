{"version":3,"file":"fieldset.bundle.js","sources":["../src/fieldset.js"],"sourcesContent":["import {Loc, Tag, Dom, Type, Runtime} from \"main.core\";\nimport {EventEmitter, BaseEvent} from \"main.core.events\";\nimport './fieldset.css';\n\nexport class EntityEditorFieldsetField extends BX.UI.EntityEditorField\n{\n\tconstructor()\n\t{\n\t\tsuper();\n\t\tthis._entityEditorList = {};\n\t\tthis._entityId = null;\n\t\tthis._fieldsetContainer = null;\n\n\t\tthis._addEmptyValue = false;\n\n\t\tthis._nextIndex = 0;\n\t}\n\n\tstatic create(id, settings)\n\t{\n\t\tlet self = new this(id, settings);\n\t\tself.initialize(id, settings);\n\t\treturn self;\n\t}\n\n\tdoInitialize()\n\t{\n\t\tsuper.doInitialize();\n\t\tthis._entityId = this._editor.getId() + '_' + this.getId() + '_fields';\n\n\t\tthis._addEmptyValue = this.getDataBooleanParam(\"addEmptyValue\", false);\n\n\t\tconst nextIndex = BX.prop.getInteger(this.getSchemeElement().getData(), \"nextIndex\", 0);\n\t\tthis._nextIndex = (nextIndex > 0) ? nextIndex : 0;\n\n\t\tthis._config = BX.prop.getObject(this.getSchemeElement().getData(), \"config\", {});\n\t}\n\n\tlayout(options)\n\t{\n\t\tif (this._hasLayout)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.ensureWrapperCreated({classNames: [\"ui-entity-editor-content-block-field-fieldset-wrapper\"]});\n\t\tthis.adjustWrapper();\n\n\t\tif (!this.isNeedToDisplay())\n\t\t{\n\t\t\tthis.registerLayout(options);\n\t\t\tthis._hasLayout = true;\n\t\t\treturn;\n\t\t}\n\n\t\tthis._fieldsetContainer = Tag.render`<div class=\"ui-entity-editor-container\"></div>`;\n\t\tDom.append(this._fieldsetContainer, this._wrapper);\n\n\t\tif (this._mode === BX.UI.EntityEditorMode.edit)\n\t\t{\n\t\t\tlet addButtonPanel = this.getAddButton();\n\t\t\tDom.append(addButtonPanel, this._wrapper);\n\t\t}\n\t\tsetTimeout(() => this.initializeExistedValues(), 0);\n\n\t\tthis.registerLayout(options);\n\t\tthis._hasLayout = true;\n\t}\n\n\tclearLayout()\n\t{\n\t\tsuper.clearLayout();\n\t\tthis._entityEditorList = {};\n\t}\n\n\tcreateEntityEditor(id, values = {}, context = {})\n\t{\n\t\tlet containerId = this._entityId + '_container_' + id;\n\t\tDom.append(Tag.render`<div id=\"${containerId}\" class=\"ui-entity-editor-field-fieldset\"></div>`, this._fieldsetContainer);\n\n\t\tlet entityEditorId = this._entityId + '_' + id;\n\t\tlet prefix = this.getName() + '[' + id + ']';\n\t\tlet section = {\n\t\t\t'name': this._entityId + '_SECTION',\n\t\t\t'type': 'section',\n\t\t\t'enableToggling': false,\n\t\t\t'transferable': false,\n\t\t\t'data': {'isRemovable': false, 'enableTitle': false, 'enableToggling': false},\n\t\t\t'elements': this.prepareFieldsWithPrefix(this.getSchemeSectionElements(), prefix)\n\t\t};\n\n\t\tconst configId =\n\t\t\t(\n\t\t\t\tType.isPlainObject(this._config)\n\t\t\t\t&& this._config.hasOwnProperty(\"GUID\")\n\t\t\t\t&& Type.isStringFilled(this._config[\"GUID\"])\n\t\t\t)\n\t\t\t\t? this._config[\"GUID\"]\n\t\t\t\t: entityEditorId\n\t\t;\n\t\tlet config = BX.UI.EntityConfig.create(\n\t\t\tconfigId,\n\t\t\t{\n\t\t\t\tdata: [section],\n\t\t\t\tscope: this._editor.getConfigScope(),\n\t\t\t\tenableScopeToggle: false,\n\t\t\t\tcanUpdatePersonalConfiguration: this._editor._config._canUpdatePersonalConfiguration,\n\t\t\t\tcanUpdateCommonConfiguration: this._editor.canChangeCommonConfiguration(),\n\t\t\t\toptions: {},\n\t\t\t\tsignedParams: BX.prop.getString(this._config, 'ENTITY_CONFIG_SIGNED_PARAMS', '')\n\t\t\t}\n\t\t);\n\n\t\tconst availableFields = this.prepareFieldsWithPrefix(\n\t\t\tBX.clone(BX.prop.getArray(this._config, 'ENTITY_AVAILABLE_FIELDS', [])),\n\t\t\tprefix\n\t\t);\n\t\tlet scheme = BX.UI.EntityScheme.create(\n\t\t\tentityEditorId,\n\t\t\t{\n\t\t\t\tcurrent: [section],\n\t\t\t\tavailable: availableFields\n\t\t\t}\n\t\t);\n\n\t\tlet entityEditor = BX.UI.EntityEditor.create(\n\t\t\tentityEditorId,\n\t\t\t{\n\t\t\t\tmodel: BX.UI.EntityEditorModelFactory.create(\n\t\t\t\t\t\"\",\n\t\t\t\t\t\"\",\n\t\t\t\t\t{\n\t\t\t\t\t\tisIdentifiable: false,\n\t\t\t\t\t\tdata: this.getFieldsValues(prefix, values)\n\t\t\t\t\t}\n\t\t\t\t),\n\t\t\t\tconfig: config,\n\t\t\t\tuserFieldManager: null,\n\t\t\t\tscheme: scheme,\n\t\t\t\tcontext: context,\n\t\t\t\tcontainerId: containerId,\n\t\t\t\tserviceUrl: this._editor.getServiceUrl(),\n\t\t\t\tentityTypeName: \"\",\n\t\t\t\tentityId: 0,\n\t\t\t\tvalidators: [],\n\t\t\t\tcontrollers: [],\n\t\t\t\tdetailManagerId: \"\",\n\t\t\t\tinitialMode: BX.UI.EntityEditorMode.getName(this._mode),\n\t\t\t\tenableModeToggle: true,\n\t\t\t\tenableConfigControl: false,\n\t\t\t\tenableShowAlwaysFeauture: this.getEditor().isShowAlwaysFeautureEnabled(),\n\t\t\t\tenableVisibilityPolicy: true,\n\t\t\t\tenableToolPanel: true,\n\t\t\t\tenableBottomPanel: false,\n\t\t\t\tenableFieldsContextMenu: true,\n\t\t\t\tenablePageTitleControls: false,\n\t\t\t\treadOnly: (this._mode === BX.UI.EntityEditorMode.view),\n\t\t\t\tenableAjaxForm: false,\n\t\t\t\tenableRequiredUserFieldCheck: true,\n\t\t\t\tenableSectionEdit: false,\n\t\t\t\tenableSectionCreation: false,\n\t\t\t\tenableSectionDragDrop: true,\n\t\t\t\tenableFieldDragDrop: true,\n\t\t\t\tenableSettingsForAll: false,\n\t\t\t\tenableContextDataLayout: false,\n\t\t\t\tformTagName: 'div',\n\t\t\t\texternalContextId: \"\",\n\t\t\t\tcontextId: \"\",\n\t\t\t\toptions: {'show_always': 'Y'},\n\t\t\t\tajaxData: [],\n\t\t\t\tisEmbedded: true\n\t\t\t}\n\t\t);\n\t\tentityEditor._enableCloseConfirmation = false;\n\t\tEventEmitter.subscribe(\n\t\t\tentityEditor,\n\t\t\t'onControlChanged',\n\t\t\t(event) => {\n\t\t\t\tif (!this.isChanged())\n\t\t\t\t{\n\t\t\t\t\tthis.markAsChanged();\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\n\t\tthis.subscribeEditorEvents(\n\t\t\tentityEditor,\n\t\t\t[\n\t\t\t\t'onControlMove',\n\t\t\t\t'onFieldModify',\n\t\t\t\t'onControlAdd',\n\t\t\t\t'onControlRemove',\n\t\t\t\t'onSchemeSave',\n\t\t\t]\n\t\t);\n\n\t\tlet container = entityEditor.getContainer();\n\t\tif (Type.isDomNode(container))\n\t\t{\n\t\t\tDom.prepend(this.getDeleteButton(id), container);\n\t\t}\n\n\t\tif(values.hasOwnProperty(\"DELETED\") && values[\"DELETED\"] === 'Y')\n\t\t{\n\t\t\tthis.layoutDeletedValue(entityEditor, id);\n\t\t}\n\n\t\tBX.Crm.RequisiteDetailsManager.create({ \"entityEditorId\": entityEditorId });\n\n\t\treturn entityEditor;\n\t}\n\n\tgetCorrespondedControl(eventCode, controlId, editor)\n\t{\n\t\treturn(\n\t\t\t(eventCode === \"add\")\n\t\t\t\t? editor.getAvailableControlByCombinedId(controlId)\n\t\t\t\t: editor.getControlByCombinedIdRecursive(controlId)\n\t\t);\n\t}\n\n\tgetEditorSchemeSectionElements(editor)\n\t{\n\t\tlet elements = [];\n\n\t\tconst schemeElements = editor.getScheme().getElements();\n\t\tif (Type.isArray(schemeElements) && schemeElements.length > 0)\n\t\t{\n\t\t\tconst section = schemeElements[0];\n\t\t\tif (section && section instanceof BX.UI.EntitySchemeElement && section.getType() === \"section\")\n\t\t\t{\n\t\t\t\telements = section.getElements();\n\t\t\t}\n\t\t}\n\n\t\treturn elements;\n\t}\n\n\tprepareSectionElementsBySchemeElements(schemeElements)\n\t{\n\t\tlet elements = [];\n\n\t\tif (Type.isArray(schemeElements))\n\t\t{\n\t\t\tfor (let i = 0; i < schemeElements.length; i++)\n\t\t\t{\n\t\t\t\tconst element = {\n\t\t\t\t\t\"name\": schemeElements[i].getName(),\n\t\t\t\t\t\"title\": schemeElements[i].getTitle(),\n\t\t\t\t\t\"type\": schemeElements[i].getType(),\n\t\t\t\t\t\"required\": schemeElements[i].isRequired(),\n\t\t\t\t\t\"optionFlags\": schemeElements[i].getOptionFlags(),\n\t\t\t\t\t\"options\": schemeElements[i].getOptions()\n\t\t\t\t};\n\t\t\t\telements.push(element);\n\t\t\t}\n\t\t}\n\n\t\treturn elements;\n\t}\n\n\tsyncEditorEvent(eventName, target, params)\n\t{\n\t\tconst eventMap = {\n\t\t\t\"onControlAdd\": \"add\",\n\t\t\t\"onControlMove\": \"move\",\n\t\t\t\"onFieldModify\": \"modify\",\n\t\t\t\"onControlRemove\": \"remove\",\n\t\t\t\"onSchemeSave\": \"saveScheme\",\n\t\t};\n\n\t\tif (\n\t\t\tType.isStringFilled(eventName)\n\t\t\t&& eventMap.hasOwnProperty(eventName)\n\t\t\t&& target instanceof BX.UI.EntityEditor\n\t\t)\n\t\t{\n\t\t\tif (eventMap[eventName] === \"saveScheme\")\n\t\t\t{\n\t\t\t\tthis.setSchemeSectionElements(\n\t\t\t\t\tthis.prepareFieldsWithoutPrefix(\n\t\t\t\t\t\tthis.prepareSectionElementsBySchemeElements(\n\t\t\t\t\t\t\tthis.getEditorSchemeSectionElements(target)\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t\tthis.setSchemeAvailableElements(\n\t\t\t\t\tthis.prepareFieldsWithoutPrefix(\n\t\t\t\t\t\tthis.getEditorAvailableElements(target)\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t}\n\t\t\telse if (\n\t\t\t\tType.isArray(params)\n\t\t\t\t&& params.length > 1\n\t\t\t\t&& Type.isPlainObject(params[1])\n\t\t\t)\n\t\t\t{\n\t\t\t\tconst eventParams = params[1];\n\t\t\t\tfor (let index in this._entityEditorList)\n\t\t\t\t{\n\t\t\t\t\tif (this._entityEditorList.hasOwnProperty(index))\n\t\t\t\t\t{\n\t\t\t\t\t\tconst editor = this._entityEditorList[index];\n\t\t\t\t\t\tif (editor instanceof BX.UI.EntityEditor && editor !== target)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (eventMap[eventName] === \"modify\")\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\t\tconst field = BX.prop.get(eventParams, \"field\", null);\n\t\t\t\t\t\t\t\t\tif (field && field instanceof BX.UI.EntityEditorField)\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tconst control = this.getCorrespondedControl(\n\t\t\t\t\t\t\t\t\t\t\teventMap[eventName],\n\t\t\t\t\t\t\t\t\t\t\tfield.getId(),\n\t\t\t\t\t\t\t\t\t\t\teditor\n\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\tif (control)\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tconst label = BX.prop.getString(eventParams, \"label\", \"\");\n\t\t\t\t\t\t\t\t\t\t\tif (Type.isStringFilled(label))\n\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\tcontrol.getSchemeElement().setTitle(label);\n\t\t\t\t\t\t\t\t\t\t\t\tcontrol.refreshTitleLayout();\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\telse if (\n\t\t\t\t\t\t\t\teventParams.hasOwnProperty(\"control\")\n\t\t\t\t\t\t\t\t&& Type.isObject(eventParams[\"control\"])\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tconst options = BX.prop.getObject(eventParams, \"params\", {});\n\t\t\t\t\t\t\t\tconst controlId = eventParams[\"control\"].getId();\n\t\t\t\t\t\t\t\tconst control = this.getCorrespondedControl(eventMap[eventName], controlId, editor);\n\t\t\t\t\t\t\t\tif (control)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tif (eventMap[eventName] === \"add\")\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\t\t\t\teditor.getControlByIndex(0).addChild(\n\t\t\t\t\t\t\t\t\t\t\t\tcontrol,\n\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\tlayout: { forceDisplay: true },\n\t\t\t\t\t\t\t\t\t\t\t\t\tenableSaving: false,\n\t\t\t\t\t\t\t\t\t\t\t\t\tskipEvents: true\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse if (eventMap[eventName] === \"move\")\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tconst index = BX.prop.getInteger(options, \"index\", -1);\n\t\t\t\t\t\t\t\t\t\tif (index >= 0)\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\t\t\t\t\tcontrol.getParent().moveChild(\n\t\t\t\t\t\t\t\t\t\t\t\t\tcontrol,\n\t\t\t\t\t\t\t\t\t\t\t\t\tindex,\n\t\t\t\t\t\t\t\t\t\t\t\t\t{ enableSaving: false, skipEvents: true }\n\t\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t\t\teditor.processSchemeChange();\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\telse if (eventMap[eventName] === \"remove\")\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\t\t\t\tcontrol.hide(\n\t\t\t\t\t\t\t\t\t\t\t\t{ enableSaving: false, skipEvents: true }\n\t\t\t\t\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\t\t\t\t\teditor.processSchemeChange();\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tsubscribeEditorEvents(editor, eventNames)\n\t{\n\t\tfor (let i = 0; i < eventNames.length; i++)\n\t\t{\n\t\t\tEventEmitter.subscribe(\n\t\t\t\teditor,\n\t\t\t\t\"BX.UI.EntityEditor:\" + eventNames[i],\n\t\t\t\t(event) => {\n\t\t\t\t\tthis.syncEditorEvent(eventNames[i], event.getTarget(), event.getData());\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\t}\n\n\tunsubscribeEditorEvents(editor)\n\t{\n\t\tEventEmitter.unsubscribeAll(editor);\n\t}\n\n\tlayoutDeletedValue(entityEditor, id)\n\t{\n\t\tif (entityEditor instanceof BX.UI.EntityEditor)\n\t\t{\n\t\t\tlet container = entityEditor.getContainer();\n\t\t\tif (Type.isDomNode(container))\n\t\t\t{\n\t\t\t\tcontainer.style.display = 'none';\n\n\t\t\t\tlet inputName = `${this.getName()}[${id}][DELETED]`;\n\t\t\t\tif (!container.querySelector(`input[name=\"${inputName}\"]`))\n\t\t\t\t{\n\t\t\t\t\tDom.append(\n\t\t\t\t\t\tTag.render`<input type=\"hidden\" name=\"${inputName}\" value=\"Y\" />`,\n\t\t\t\t\t\tcontainer\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tonDeleteButtonClick(id)\n\t{\n\t\tif (this._entityEditorList.hasOwnProperty(id))\n\t\t{\n\t\t\tthis.unsubscribeEditorEvents(this._entityEditorList[id]);\n\n\t\t\tthis.layoutDeletedValue(this._entityEditorList[id], id);\n\t\t\tthis.markAsChanged();\n\t\t}\n\t}\n\n\tonAddButtonClick()\n\t{\n\t\tthis.addEmptyValue();\n\t}\n\n\taddEmptyValue(options)\n\t{\n\t\tlet value = this.getValue();\n\n\t\tlet id = 'n' + this._nextIndex++;\n\n\t\tvalue.push({\n\t\t\t'ID': id\n\t\t});\n\n\t\tthis.getModel().setField(this.getName(), value);\n\n\t\tthis._entityEditorList[id] = this.createEntityEditor(id);\n\t\tthis.markAsChanged();\n\n\t\treturn this._entityEditorList[id];\n\t}\n\n\tgetEditors()\n\t{\n\t\treturn this._entityEditorList;\n\t}\n\n\tgetSchemeSection()\n\t{\n\t\tlet section = null;\n\n\t\tconst entityScheme = BX.prop.getArray(this._config, 'ENTITY_SCHEME', []);\n\t\tif (Type.isArray(entityScheme) && entityScheme.length > 0)\n\t\t{\n\t\t\tconst column = entityScheme[0];\n\t\t\tif (\n\t\t\t\tType.isPlainObject(column)\n\t\t\t\t&& column.hasOwnProperty(\"elements\")\n\t\t\t\t&& Type.isArray(column[\"elements\"])\n\t\t\t\t&& column[\"elements\"].length > 0\n\t\t\t\t&& Type.isPlainObject(column[\"elements\"][0])\n\t\t\t)\n\t\t\t{\n\t\t\t\tsection = column[\"elements\"][0];\n\t\t\t}\n\t\t}\n\n\t\treturn section;\n\t}\n\n\tgetEditorAvailableElements(editor)\n\t{\n\t\tlet elements = [];\n\n\t\tif (editor && editor instanceof BX.UI.EntityEditor)\n\t\t{\n\t\t\tconst schemeElements = editor.getAvailableSchemeElements();\n\t\t\tfor (let i = 0; i < schemeElements.length; i++)\n\t\t\t{\n\t\t\t\tconst element = {\n\t\t\t\t\t\"name\": schemeElements[i].getName(),\n\t\t\t\t\t\"title\": schemeElements[i].getTitle(),\n\t\t\t\t\t\"type\": schemeElements[i].getType(),\n\t\t\t\t\t\"required\": schemeElements[i].isRequired(),\n\t\t\t\t};\n\t\t\t\telements.push(element)\n\t\t\t}\n\n\t\t}\n\n\t\treturn elements;\n\t}\n\n\tsetSchemeAvailableElements(availableElements)\n\t{\n\t\tthis._config[\"ENTITY_AVAILABLE_FIELDS\"] = availableElements;\n\t}\n\n\tsetSchemeSectionElements(sectionElements)\n\t{\n\t\tlet section = null;\n\n\t\tif (!Type.isArray(sectionElements))\n\t\t{\n\t\t\tsectionElements = [];\n\t\t}\n\n\t\tconst entityScheme = BX.prop.getArray(this._config, 'ENTITY_SCHEME', []);\n\t\tif (Type.isArray(entityScheme) && entityScheme.length > 0)\n\t\t{\n\t\t\tconst column = entityScheme[0];\n\t\t\tif (\n\t\t\t\tType.isPlainObject(column)\n\t\t\t\t&& column.hasOwnProperty(\"elements\")\n\t\t\t\t&& Type.isArray(column[\"elements\"])\n\t\t\t\t&& column[\"elements\"].length > 0\n\t\t\t\t&& Type.isPlainObject(column[\"elements\"][0])\n\t\t\t)\n\t\t\t{\n\t\t\t\tsection = column[\"elements\"][0];\n\t\t\t}\n\t\t}\n\n\t\tif (Type.isPlainObject(section))\n\t\t{\n\t\t\tsection[\"elements\"] = sectionElements;\n\t\t}\n\t}\n\n\tgetSchemeSectionElements()\n\t{\n\t\tlet elements = [];\n\n\t\tconst section = this.getSchemeSection();\n\t\tif (\n\t\t\tsection\n\t\t\t&& section.hasOwnProperty(\"elements\")\n\t\t\t&& Type.isArray(section[\"elements\"])\n\t\t)\n\t\t{\n\t\t\telements = Runtime.clone(section[\"elements\"]);\n\t\t}\n\n\t\treturn elements;\n\t}\n\n\tsetSchemeSectionElements(elements)\n\t{\n\t\tconst section = this.getSchemeSection();\n\t\tif (section)\n\t\t{\n\t\t\tsection[\"elements\"] = Runtime.clone(elements);\n\t\t}\n\t}\n\n\tgetFields(prefix)\n\t{\n\t\tconst fields = BX.clone(BX.prop.getArray(this.getSchemeElement().getData(), 'fields', []));\n\n\t\treturn this.prepareFieldsWithPrefix(fields, prefix);\n\t};\n\n\tprepareFieldsWithPrefix(fields, prefix)\n\t{\n\t\tfor (let index = 0; index < fields.length; index++)\n\t\t{\n\t\t\tfields[index].name = this.getFieldName(fields[index].name, prefix);\n\t\t}\n\n\t\treturn fields;\n\t}\n\n\tprepareFieldsWithoutPrefix(fields)\n\t{\n\t\tfor (let index = 0; index < fields.length; index++)\n\t\t{\n\t\t\tif (Type.isStringFilled(fields[index].name))\n\t\t\t{\n\t\t\t\tconst matches = fields[index].name.match(/\\[(\\w+)]$/);\n\t\t\t\tif (matches && matches.length > 1 && Type.isStringFilled(matches[1]))\n\t\t\t\t{\n\t\t\t\t\tfields[index].name = matches[1];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn fields;\n\t}\n\n\tgetFieldsValues(prefix, values)\n\t{\n\t\tlet result = {};\n\t\tfor (let fieldId in values)\n\t\t{\n\t\t\tresult[this.getFieldName(fieldId, prefix)] = values[fieldId];\n\t\t}\n\t\treturn result;\n\t};\n\n\tgetFieldName(originalName, prefix)\n\t{\n\t\treturn prefix + '[' + originalName + ']';\n\t}\n\n\tgetDeleteButton(id)\n\t{\n\t\treturn Tag.render`\n\t\t<div class=\"ui-entity-editor-field-fieldset-delete\">\n\t\t\t<span class=\"ui-link ui-link-secondary\" onclick=\"${this.onDeleteButtonClick.bind(this, id)}\">\n\t\t\t\t${Loc.getMessage('UI_ENTITY_EDITOR_DELETE')}\n\t\t\t</span>\n\t\t</div>`;\n\t}\n\n\tgetAddButton()\n\t{\n\t\treturn Tag.render`\n\t\t<div class=\"ui-entity-editor-content-block-add-field\">\n\t\t\t<span class=\"ui-entity-card-content-add-field\" onclick=\"${this.onAddButtonClick.bind(this)}\">\n\t\t\t\t${Loc.getMessage('UI_ENTITY_EDITOR_ADD')}\n\t\t\t</span>\n\t\t</div>`;\n\t}\n\n\tinitializeExistedValues()\n\t{\n\t\tlet existedItems = this.getValue();\n\t\tif (existedItems.length)\n\t\t{\n\t\t\tfor (let item of existedItems)\n\t\t\t{\n\t\t\t\tif (!this._entityEditorList[item.ID])\n\t\t\t\t{\n\t\t\t\t\tthis._entityEditorList[item.ID] = this.createEntityEditor(item.ID, item);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\telse if (this._mode === BX.UI.EntityEditorMode.edit && this._addEmptyValue)\n\t\t{\n\t\t\tthis.addEmptyValue();\n\t\t}\n\t}\n}\n\nEventEmitter.subscribe('BX.UI.EntityEditorControlFactory:onInitialize', (event: BaseEvent) => {\n\t\tlet data = event.getData();\n\t\tif (data[0])\n\t\t{\n\t\t\tdata[0].methods[\"fieldset\"] = (type, controlId, settings) => {\n\t\t\t\tif (type === \"fieldset\")\n\t\t\t\t{\n\t\t\t\t\treturn EntityEditorFieldsetField.create(controlId, settings);\n\t\t\t\t}\n\t\t\t\treturn null;\n\t\t\t};\n\t\t}\n\t\tevent.setData(data);\n});\n"],"names":["EntityEditorFieldsetField","_entityEditorList","_entityId","_fieldsetContainer","_addEmptyValue","_nextIndex","_editor","getId","getDataBooleanParam","nextIndex","BX","prop","getInteger","getSchemeElement","getData","_config","getObject","options","_hasLayout","ensureWrapperCreated","classNames","adjustWrapper","isNeedToDisplay","registerLayout","Tag","render","Dom","append","_wrapper","_mode","UI","EntityEditorMode","edit","addButtonPanel","getAddButton","setTimeout","initializeExistedValues","id","values","context","containerId","entityEditorId","prefix","getName","section","prepareFieldsWithPrefix","getSchemeSectionElements","configId","Type","isPlainObject","hasOwnProperty","isStringFilled","config","EntityConfig","create","data","scope","getConfigScope","enableScopeToggle","canUpdatePersonalConfiguration","_canUpdatePersonalConfiguration","canUpdateCommonConfiguration","canChangeCommonConfiguration","signedParams","getString","availableFields","clone","getArray","scheme","EntityScheme","current","available","entityEditor","EntityEditor","model","EntityEditorModelFactory","isIdentifiable","getFieldsValues","userFieldManager","serviceUrl","getServiceUrl","entityTypeName","entityId","validators","controllers","detailManagerId","initialMode","enableModeToggle","enableConfigControl","enableShowAlwaysFeauture","getEditor","isShowAlwaysFeautureEnabled","enableVisibilityPolicy","enableToolPanel","enableBottomPanel","enableFieldsContextMenu","enablePageTitleControls","readOnly","view","enableAjaxForm","enableRequiredUserFieldCheck","enableSectionEdit","enableSectionCreation","enableSectionDragDrop","enableFieldDragDrop","enableSettingsForAll","enableContextDataLayout","formTagName","externalContextId","contextId","ajaxData","isEmbedded","_enableCloseConfirmation","EventEmitter","subscribe","event","isChanged","markAsChanged","subscribeEditorEvents","container","getContainer","isDomNode","prepend","getDeleteButton","layoutDeletedValue","Crm","RequisiteDetailsManager","eventCode","controlId","editor","getAvailableControlByCombinedId","getControlByCombinedIdRecursive","elements","schemeElements","getScheme","getElements","isArray","length","EntitySchemeElement","getType","i","element","getTitle","isRequired","getOptionFlags","getOptions","push","eventName","target","params","eventMap","setSchemeSectionElements","prepareFieldsWithoutPrefix","prepareSectionElementsBySchemeElements","getEditorSchemeSectionElements","setSchemeAvailableElements","getEditorAvailableElements","eventParams","index","field","get","EntityEditorField","control","getCorrespondedControl","label","setTitle","refreshTitleLayout","isObject","getControlByIndex","addChild","layout","forceDisplay","enableSaving","skipEvents","getParent","moveChild","processSchemeChange","hide","eventNames","syncEditorEvent","getTarget","unsubscribeAll","style","display","inputName","querySelector","unsubscribeEditorEvents","addEmptyValue","value","getValue","getModel","setField","createEntityEditor","entityScheme","column","getAvailableSchemeElements","availableElements","sectionElements","getSchemeSection","Runtime","fields","name","getFieldName","matches","match","result","fieldId","originalName","onDeleteButtonClick","bind","Loc","getMessage","onAddButtonClick","existedItems","item","ID","settings","self","initialize","methods","type","setData"],"mappings":"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"}