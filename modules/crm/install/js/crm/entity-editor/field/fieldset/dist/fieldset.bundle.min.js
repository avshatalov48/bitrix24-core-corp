this.BX=this.BX||{};(function(e,t,i){"use strict";var n,r,a,o,s;function l(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=d(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var r=function e(){};return{s:r,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,o=false,s;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();a=t.done;return t},e:function e(t){o=true;s=t},f:function e(){try{if(!a&&i["return"]!=null)i["return"]()}finally{if(o)throw s}}}}function d(e,t){if(!e)return;if(typeof e==="string")return u(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return u(e,t)}function u(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}var c=function(e){babelHelpers.inherits(d,e);function d(){var e;babelHelpers.classCallCheck(this,d);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(d).call(this));e._entityEditorList={};e._entityId=null;e._fieldsetContainer=null;e._addEmptyValue=false;e._nextIndex=0;e._isDeleted=false;return e}babelHelpers.createClass(d,[{key:"doInitialize",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(d.prototype),"doInitialize",this).call(this);this._entityId=this._editor.getId()+"_"+this.getId()+"_fields";this._addEmptyValue=this.getDataBooleanParam("addEmptyValue",false);var t=BX.prop.getInteger(this.getSchemeElement().getData(),"nextIndex",0);this._nextIndex=t>0?t:0;this._config=BX.prop.getObject(this.getSchemeElement().getData(),"config",{})}},{key:"layout",value:function e(i){var r=this;if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["ui-entity-editor-content-block-field-fieldset-wrapper"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(i);this._hasLayout=true;return}this._fieldsetContainer=t.Tag.render(n||(n=babelHelpers.taggedTemplateLiteral(['<div class="ui-entity-editor-container"></div>'])));t.Dom.append(this._fieldsetContainer,this._wrapper);if(this._mode===BX.UI.EntityEditorMode.edit){var a=this.getAddButton();t.Dom.append(a,this._wrapper)}setTimeout((function(){return r.initializeExistedValues()}),0);this.registerLayout(i);this._hasLayout=true}},{key:"clearLayout",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(d.prototype),"clearLayout",this).call(this);this._entityEditorList={}}},{key:"createEntityEditor",value:function e(n){var a=this;var o=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var l=this._entityId+"_container_"+n;t.Dom.append(t.Tag.render(r||(r=babelHelpers.taggedTemplateLiteral(['<div id="','" class="ui-entity-editor-field-fieldset"></div>'])),l),this._fieldsetContainer);var d=this._entityId+"_"+n;var u=this.getName()+"["+n+"]";var c={name:this._entityId+"_SECTION",type:"section",enableToggling:false,transferable:false,data:{isRemovable:false,enableTitle:false,enableToggling:false},elements:this.prepareFieldsWithPrefix(this.getSchemeSectionElements(),u)};var f=t.Type.isPlainObject(this._config)&&this._config.hasOwnProperty("GUID")&&t.Type.isStringFilled(this._config["GUID"])?this._config["GUID"]:d;var y=BX.UI.EntityConfig.create(f,{data:[c],scope:this._editor.getConfigScope(),enableScopeToggle:false,canUpdatePersonalConfiguration:this._editor._config._canUpdatePersonalConfiguration,canUpdateCommonConfiguration:this._editor.canChangeCommonConfiguration(),options:{},signedParams:BX.prop.getString(this._config,"ENTITY_CONFIG_SIGNED_PARAMS","")});var h=this.prepareFieldsWithPrefix(BX.clone(BX.prop.getArray(this._config,"ENTITY_AVAILABLE_FIELDS",[])),u);var p=BX.UI.EntityScheme.create(d,{current:[c],available:h});var g=BX.UI.EntityEditor.create(d,{model:BX.UI.EntityEditorModelFactory.create("","",{isIdentifiable:false,data:this.getFieldsValues(u,o)}),config:y,userFieldManager:null,scheme:p,context:s,containerId:l,serviceUrl:this._editor.getServiceUrl(),entityTypeName:"",entityId:0,validators:[],controllers:[],detailManagerId:"",initialMode:BX.UI.EntityEditorMode.getName(this._mode),enableModeToggle:true,enableConfigControl:false,enableShowAlwaysFeauture:this.getEditor().isShowAlwaysFeautureEnabled(),enableVisibilityPolicy:true,enableToolPanel:true,enableBottomPanel:false,enableFieldsContextMenu:true,enablePageTitleControls:false,readOnly:this._mode===BX.UI.EntityEditorMode.view,enableAjaxForm:false,enableRequiredUserFieldCheck:true,enableSectionEdit:false,enableSectionCreation:false,enableSectionDragDrop:true,enableFieldDragDrop:true,enableSettingsForAll:false,enableContextDataLayout:false,formTagName:"div",externalContextId:"",contextId:"",options:{show_always:"Y"},ajaxData:[],isEmbedded:true});g._enableCloseConfirmation=false;var v=this.getAttributeManagerSettings();if(BX.Type.isPlainObject(v)){var E=BX.Crm.EntityFieldAttributeManager.create(g.getId()+"_ATTR_MANAGER",{entityTypeId:BX.prop.getInteger(v,"ENTITY_TYPE_ID",BX.CrmEntityType.enumeration.undefined),entityScope:BX.prop.getString(v,"ENTITY_SCOPE",""),isPermitted:BX.prop.getBoolean(v,"IS_PERMITTED",true),isPhaseDependent:BX.prop.getBoolean(v,"IS_PHASE_DEPENDENT",true),isAttrConfigButtonHidden:BX.prop.getBoolean(v,"IS_ATTR_CONFIG_BUTTON_HIDDEN",true),lockScript:BX.prop.getString(v,"LOCK_SCRIPT",""),captions:BX.prop.getObject(v,"CAPTIONS",{}),entityPhases:BX.prop.getArray(v,"ENTITY_PHASES",null)});g.setAttributeManager(E)}i.EventEmitter.subscribe(g,"onControlChanged",(function(e){if(!a.isChanged()){a.markAsChanged()}}));this.subscribeEditorEvents(g,["onControlMove","onFieldModify","onFieldModifyAttributeConfigs","onControlAdd","onControlRemove","onSchemeSave"]);var m=g.getContainer();if(t.Type.isDomNode(m)){t.Dom.prepend(this.getDeleteButton(n),m)}if(o.hasOwnProperty("DELETED")&&o["DELETED"]==="Y"){this._isDeleted=true;this.layoutDeletedValue(g,n)}BX.Crm.RequisiteDetailsManager.create({entityEditorId:d});return g}},{key:"getCorrespondedControl",value:function e(t,i,n){return t==="add"?n.getAvailableControlByCombinedId(i):n.getControlByCombinedIdRecursive(i)}},{key:"getEditorSchemeSectionElements",value:function e(i){var n=[];var r=i.getScheme().getElements();if(t.Type.isArray(r)&&r.length>0){var a=r[0];if(a&&a instanceof BX.UI.EntitySchemeElement&&a.getType()==="section"){n=a.getElements()}}return n}},{key:"prepareSectionElementsBySchemeElements",value:function e(i){var n=[];if(t.Type.isArray(i)){for(var r=0;r<i.length;r++){var a={name:i[r].getName(),title:i[r].getTitle(),type:i[r].getType(),required:i[r].isRequired(),optionFlags:i[r].getOptionFlags(),options:i[r].getOptions()};n.push(a)}}return n}},{key:"syncEditorEvent",value:function e(i,n,r){var a=this;var o={onControlAdd:"add",onControlMove:"move",onFieldModify:"modify",onFieldModifyAttributeConfigs:"modifyAttributes",onControlRemove:"remove",onSchemeSave:"saveScheme"};if(t.Type.isStringFilled(i)&&o.hasOwnProperty(i)&&n instanceof BX.UI.EntityEditor){if(o[i]==="saveScheme"){this.setSchemeSectionElements(this.prepareFieldsWithoutPrefix(this.prepareSectionElementsBySchemeElements(this.getEditorSchemeSectionElements(n))));this.setSchemeAvailableElements(this.prepareFieldsWithoutPrefix(this.getEditorAvailableElements(n)))}else if(t.Type.isArray(r)&&r.length>1&&t.Type.isPlainObject(r[1])){var s=r[1];var l=function e(){if(a._entityEditorList.hasOwnProperty(d)){var r=a._entityEditorList[d];if(r instanceof BX.UI.EntityEditor&&r!==n){if(o[i]==="modify"||o[i]==="modifyAttributes"){setTimeout((function(){var e=BX.prop.get(s,"field",null);if(e&&e instanceof BX.UI.EntityEditorField){var n=a.getCorrespondedControl(o[i],e.getId(),r);if(n){var l=false;if(o[i]==="modifyAttributes"){var d=[];var u=BX.prop.getArray(s,"attrConfigs",null);if(t.Type.isArray(u)&&u.length>0){for(var c=0,f=u.length;c<f;c++){var y=u[c];var h=BX.prop.getInteger(y,"typeId",BX.UI.EntityFieldAttributeType.undefined);if(h!==BX.UI.EntityFieldAttributeType.undefined){d.push(h);n.getSchemeElement().setAttributeConfiguration(y)}}}for(var p in BX.UI.EntityFieldAttributeType){if(BX.UI.EntityFieldAttributeType.hasOwnProperty(p)){var g=BX.UI.EntityFieldAttributeType[p];if(g!==BX.UI.EntityFieldAttributeType.undefined&&d.indexOf(g)<0){n.getSchemeElement().removeAttributeConfiguration(g)}}}l=true}else{var v=BX.prop.getString(s,"label","");if(t.Type.isStringFilled(v)){n.getSchemeElement().setTitle(v);l=true}}if(l){n.refreshTitleLayout()}}}}))}else if(s.hasOwnProperty("control")&&t.Type.isObject(s["control"])){var l=BX.prop.getObject(s,"params",{});var u=s["control"].getId();var c=a.getCorrespondedControl(o[i],u,r);if(c){if(o[i]==="add"){setTimeout((function(){r.getControlByIndex(0).addChild(c,{layout:{forceDisplay:true},enableSaving:false,skipEvents:true})}))}else if(o[i]==="move"){var f=BX.prop.getInteger(l,"index",-1);if(f>=0){setTimeout((function(){c.getParent().moveChild(c,f,{enableSaving:false,skipEvents:true});r.processSchemeChange()}))}}else if(o[i]==="remove"){setTimeout((function(){c.hide({enableSaving:false,skipEvents:true});r.processSchemeChange()}))}}}}}};for(var d in this._entityEditorList){l()}}}}},{key:"subscribeEditorEvents",value:function e(t,n){var r=this;var a=function e(a){i.EventEmitter.subscribe(t,"BX.UI.EntityEditor:"+n[a],(function(e){r.syncEditorEvent(n[a],e.getTarget(),e.getData())}))};for(var o=0;o<n.length;o++){a(o)}}},{key:"unsubscribeEditorEvents",value:function e(t){i.EventEmitter.unsubscribeAll(t)}},{key:"isDeleted",value:function e(){return this._isDeleted}},{key:"layoutDeletedValue",value:function e(i,n){if(i instanceof BX.UI.EntityEditor){var r=i.getContainer();if(t.Type.isDomNode(r)){r.style.display="none";var o="".concat(this.getName(),"[").concat(n,"][DELETED]");if(!r.querySelector('input[name="'.concat(o,'"]'))){t.Dom.append(t.Tag.render(a||(a=babelHelpers.taggedTemplateLiteral(['<input type="hidden" name="','" value="Y" />'])),o),r)}}}}},{key:"onDeleteButtonClick",value:function e(t){if(this._entityEditorList.hasOwnProperty(t)){this.unsubscribeEditorEvents(this._entityEditorList[t]);this._isDeleted=true;this.layoutDeletedValue(this._entityEditorList[t],t);this.markAsChanged()}}},{key:"onAddButtonClick",value:function e(){this.addEmptyValue()}},{key:"addEmptyValue",value:function e(t){var i=this.getValue();var n="n"+this._nextIndex++;i.push({ID:n});this.getModel().setField(this.getName(),i);this._entityEditorList[n]=this.createEntityEditor(n,{},this.prepareEntityEditorContext());this.markAsChanged();return this._entityEditorList[n]}},{key:"getEditors",value:function e(){return this._entityEditorList}},{key:"getSchemeSection",value:function e(){var i=null;var n=BX.prop.getArray(this._config,"ENTITY_SCHEME",[]);if(t.Type.isArray(n)&&n.length>0){var r=n[0];if(t.Type.isPlainObject(r)&&r.hasOwnProperty("elements")&&t.Type.isArray(r["elements"])&&r["elements"].length>0&&t.Type.isPlainObject(r["elements"][0])){i=r["elements"][0]}}return i}},{key:"getEditorAvailableElements",value:function e(t){var i=[];if(t&&t instanceof BX.UI.EntityEditor){var n=t.getAvailableSchemeElements();for(var r=0;r<n.length;r++){var a={name:n[r].getName(),title:n[r].getTitle(),type:n[r].getType(),required:n[r].isRequired()};i.push(a)}}return i}},{key:"setSchemeAvailableElements",value:function e(t){this._config["ENTITY_AVAILABLE_FIELDS"]=t}},{key:"setSchemeSectionElements",value:function e(i){var n=null;if(!t.Type.isArray(i)){i=[]}var r=BX.prop.getArray(this._config,"ENTITY_SCHEME",[]);if(t.Type.isArray(r)&&r.length>0){var a=r[0];if(t.Type.isPlainObject(a)&&a.hasOwnProperty("elements")&&t.Type.isArray(a["elements"])&&a["elements"].length>0&&t.Type.isPlainObject(a["elements"][0])){n=a["elements"][0]}}if(t.Type.isPlainObject(n)){n["elements"]=i}}},{key:"getSchemeSectionElements",value:function e(){var i=[];var n=this.getSchemeSection();if(n&&n.hasOwnProperty("elements")&&t.Type.isArray(n["elements"])){i=t.Runtime.clone(n["elements"])}return i}},{key:"setSchemeSectionElements",value:function e(i){var n=this.getSchemeSection();if(n){n["elements"]=t.Runtime.clone(i)}}},{key:"getFields",value:function e(t){var i=BX.clone(BX.prop.getArray(this.getSchemeElement().getData(),"fields",[]));return this.prepareFieldsWithPrefix(i,t)}},{key:"prepareFieldsWithPrefix",value:function e(t,i){for(var n=0;n<t.length;n++){t[n].name=this.getFieldName(t[n].name,i)}return t}},{key:"prepareFieldsWithoutPrefix",value:function e(i){for(var n=0;n<i.length;n++){if(t.Type.isStringFilled(i[n].name)){var r=i[n].name.match(/\[(\w+)]$/);if(r&&r.length>1&&t.Type.isStringFilled(r[1])){i[n].name=r[1]}}}return i}},{key:"getFieldsValues",value:function e(t,i){var n={};for(var r in i){n[this.getFieldName(r,t)]=i[r]}return n}},{key:"getFieldName",value:function e(t,i){return i+"["+t+"]"}},{key:"getDeleteButton",value:function e(i){return t.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="ui-entity-editor-field-fieldset-delete">\n\t\t\t<span class="ui-link ui-link-secondary" onclick="','">\n\t\t\t\t',"\n\t\t\t</span>\n\t\t</div>"])),this.onDeleteButtonClick.bind(this,i),t.Loc.getMessage("UI_ENTITY_EDITOR_DELETE"))}},{key:"getAddButton",value:function e(){return t.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="ui-entity-editor-content-block-add-field">\n\t\t\t<span class="ui-entity-card-content-add-field" onclick="','">\n\t\t\t\t',"\n\t\t\t</span>\n\t\t</div>"])),this.onAddButtonClick.bind(this),t.Loc.getMessage("UI_ENTITY_EDITOR_ADD"))}},{key:"initializeExistedValues",value:function e(){var t=this.getValue();if(t.length){var i=l(t),n;try{for(i.s();!(n=i.n()).done;){var r=n.value;if(!this._entityEditorList[r.ID]){this._entityEditorList[r.ID]=this.createEntityEditor(r.ID,r,this.prepareEntityEditorContext())}}}catch(e){i.e(e)}finally{i.f()}}else if(this._mode===BX.UI.EntityEditorMode.edit&&this._addEmptyValue){this.addEmptyValue()}}},{key:"getAttributeManagerSettings",value:function e(){return BX.prop.getObject(this._config,"ATTRIBUTE_CONFIG",null)}},{key:"getResolverProperty",value:function e(){return BX.prop.getObject(this._settings,"resolverProperty",null)}},{key:"getActiveControlById",value:function e(t){for(var i in this._entityEditorList){if(this._entityEditorList.hasOwnProperty(i)){var n=this._entityEditorList[i].getActiveControlById(t,true);if(n){return n}}}}},{key:"validate",value:function e(t){if(this._isDeleted||this._mode!==BX.UI.EntityEditorMode.edit){return true}var i=BX.UI.EntityAsyncValidator.create();for(var n in this._entityEditorList){if(this._entityEditorList.hasOwnProperty(n)){var r=this._entityEditorList[n];if(r.getMode()!==BX.UI.EntityEditorMode.edit){continue}i.addResult(r.validate(t))}}return i.validate()}},{key:"prepareEntityEditorContext",value:function e(){return{}}}],[{key:"create",value:function e(t,i){var n=new this(t,i);n.initialize(t,i);return n}}]);return d}(BX.UI.EntityEditorField);i.EventEmitter.subscribe("BX.UI.EntityEditorControlFactory:onInitialize",(function(e){var t=e.getData();if(t[0]){t[0].methods["fieldset"]=function(e,t,i){if(e==="fieldset"){return c.create(t,i)}return null}}e.setData(t)}));e.EntityEditorFieldsetField=c})(this.BX.Crm=this.BX.Crm||{},BX,BX.Event);
//# sourceMappingURL=fieldset.bundle.map.js