this.BX=this.BX||{};(function(e,t,i,s,n,r,a,o,l){"use strict";function u(e,t){var i;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(i=d(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var s=0;var n=function e(){};return{s:n,n:function t(){if(s>=e.length)return{done:true};return{done:false,value:e[s++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,a=false,o;return{s:function t(){i=e[Symbol.iterator]()},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){a=true;o=t},f:function e(){try{if(!r&&i.return!=null)i.return()}finally{if(a)throw o}}}}function d(e,t){if(!e)return;if(typeof e==="string")return h(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return h(e,t)}function h(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,s=new Array(t);i<t;i++){s[i]=e[i]}return s}var c=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e.setEventNamespace("BX.Crm.EntityEditorRequisiteField.RequisiteList");e._items=[];e.CHANGE_EVENT="onChange";return e}babelHelpers.createClass(t,[{key:"initialize",value:function e(t,i){if(!r.Type.isArray(t)){t=[]}var s=u(t),n;try{for(s.s();!(n=s.n()).done;){var a=n.value;var o=f.create(a);this._items.push(o)}}catch(e){s.e(e)}finally{s.f()}}},{key:"getList",value:function e(){return this._items.filter(function(e){return!e.isDeleted()})}},{key:"getListWithDeleted",value:function e(){return this._items}},{key:"isEmpty",value:function e(){return!this.getList().length}},{key:"getSelected",value:function e(){var t=this.getSelectedId();return this.getById(t)}},{key:"getSelectedId",value:function e(){var t=this.getList();if(!t.length){return null}for(var i=0;i<t.length;i++){var s=t[i];if(s.isSelected()){return i}}return 0}},{key:"getById",value:function e(t){var i=this.getList();if(null===t){return null}if(t>=0&&t<i.length){return i[t]}return null}},{key:"getByRequisiteId",value:function e(t){var i=this.getList();return i.filter(function(e){return e.getRequisiteId()==t}).reduce(function(e,t){return t},null)}},{key:"setSelected",value:function e(t,i){var s=this.getById(t);if(s){var n=u(this.getList()),a;try{for(n.s();!(a=n.n()).done;){var o=a.value;var l=o===s;o.setSelected(l);if(l){o.setSelectedBankDetails(r.Type.isNull(i)?s.getSelectedBankDetailId():i)}}}catch(e){n.e(e)}finally{n.f()}this.notifyListChanged()}}},{key:"getNewRequisiteId",value:function e(){var t=this.getList().reduce(function(e,t){var i=t.getRequisiteIdAsString();var s=i?i.match(f.newRequisitePattern):false;var n=s&&s[1]?s[1]:-1;return Math.max(e,n)},-1);return"n"+(parseInt(t)+1)}},{key:"indexOf",value:function e(t){return this._items.indexOf(t)}},{key:"add",value:function e(t){this._items.push(t);this.notifyListChanged()}},{key:"remove",value:function e(t){var i=this._items.indexOf(t);if(i>=0){this._items.splice(i,1)}this.notifyListChanged()}},{key:"removePostponed",value:function e(t){var i=this._items.indexOf(t);if(i>=0){t.setDeleted(true)}this.notifyListChanged()}},{key:"hide",value:function e(t){var i=this._items.indexOf(t);if(i>=0){t.setAddressOnly(true);t.setChanged(true)}this.notifyListChanged()}},{key:"unhide",value:function e(t){var i=this._items.indexOf(t);if(i>=0){t.setAddressOnly(false);t.setChanged(true)}this.notifyListChanged()}},{key:"notifyListChanged",value:function e(){this.emit(this.CHANGE_EVENT)}},{key:"exportToModel",value:function e(){var t=[];var i=u(this._items),s;try{for(i.s();!(s=i.n()).done;){var n=s.value;var r=n.exportToModel();t.push(babelHelpers.objectSpread({},r))}}catch(e){i.e(e)}finally{i.f()}return t}}],[{key:"create",value:function e(i,s){var n=new t;n.initialize(i,s);return n}}]);return t}(l.EventEmitter);var f=function(){function e(){babelHelpers.classCallCheck(this,e);this._data=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){if(r.Type.isPlainObject(t)){this._data=babelHelpers.objectSpread({},t);this._data.isNew=false;this._data.isChanged=false;this._data.isDeleted=false;this._data.isAddressOnly=false;this._data.formData={};this._data.addressData={};if(!r.Type.isPlainObject(this._data.autocompleteState)){this._data.autocompleteState={}}}else{this._data={isNew:true,isChanged:false,isDeleted:false,isAddressOnly:false,selected:false,presetId:null,requisiteId:BX.prop.getString(i,"newRequisiteId","n0"),requisiteData:"",requisiteDataSign:"",bankDetails:[],bankDetailIdSelected:0,addressList:{},value:{},title:"",subtitle:"",autocompleteState:{},formData:{},addressData:{}};var s=BX.prop.getObject(i,"newRequisiteExtraFields",{});this._data=babelHelpers.objectSpread({},this._data,s)}this._data.initialAddressDdta=null;this.prepareViewData(this._data)}},{key:"prepareViewData",value:function t(){try{this._data.value=this._data.requisiteData?JSON.parse(this._data.requisiteData):{}}catch(e){this._data.value={}}this._data.title="";this._data.subtitle="";if(r.Type.isPlainObject(this._data.value)&&r.Type.isPlainObject(this._data.value.viewData)){this._data.title=this._data.value.viewData.title;this._data.subtitle=this._data.value.viewData.subtitle}if(this.getRequisiteIdAsString().match(e.newRequisitePattern)){var i=BX.prop.getNumber(this.getFields(),"ID",0);if(i>0){this.setRequisiteId(i)}}this.setAddressOnly(BX.prop.getString(this.getFields(),"ADDRESS_ONLY","N")==="Y");this._data.bankDetails=[];if(r.Type.isPlainObject(this._data.value)&&r.Type.isArray(this._data.value.bankDetailViewDataList)){this._data.bankDetails=this.prepareBankDetailsList(this._data.value.bankDetailViewDataList)}this._data.addressList=babelHelpers.objectSpread({},BX.prop.getObject(this.getFields(),"RQ_ADDR",{}))}},{key:"prepareBankDetailsList",value:function e(t){var i=[];var s=u(t),n;try{for(s.s();!(n=s.n()).done;){var a=n.value;if(a.deleted){continue}if(r.Type.isPlainObject(a.viewData)){var o={title:a.viewData.title,id:a.pseudoId,value:"",selected:!!a.selected};if(r.Type.isArray(a.viewData.fields)&&a.viewData.fields.length){o.value=a.viewData.fields.filter(function(e){return r.Type.isStringFilled(e.textValue)}).map(function(e){return e.title+": "+e.textValue}).join(", ")}if(!o.value.length){o.value=o.title}i.push(o)}}}catch(e){s.e(e)}finally{s.f()}return i}},{key:"isSelected",value:function e(){if(!this._data.hasOwnProperty("justSelected")){return BX.prop.getBoolean(this._data,"selected",false)}return BX.prop.getBoolean(this._data,"justSelected",false)}},{key:"isChanged",value:function e(){return BX.prop.getBoolean(this._data,"isChanged",false)}},{key:"setChanged",value:function e(t){this._data.isChanged=!!t}},{key:"isNew",value:function e(){return BX.prop.getBoolean(this._data,"isNew",false)}},{key:"setNew",value:function e(t){this._data.isNew=!!t}},{key:"getSelectedBankDetailId",value:function e(){var t=BX.prop.getInteger(this._data,"selectedBankDetailId",-1);if(t!==-1){return t}t=this.getBankDetails().reduce(function(e,t,i){return t.selected?i:e},-1);this._data.selectedBankDetailId=t;return t>-1?t:0}},{key:"getBankDetailById",value:function e(t){var i=this.getBankDetails();if(null===t){return null}if(t>=0&&t<i.length){return i[t]}return null}},{key:"getBankDetailByBankDetailId",value:function e(t){var i=this.getBankDetails();if(null===t){return null}return i.filter(function(e){return e.id==t}).reduce(function(e,t){return t},null)}},{key:"getTitle",value:function e(){return BX.prop.getString(this._data,"title","")}},{key:"getSubtitle",value:function e(){return BX.prop.getString(this._data,"subtitle","")}},{key:"getPresetId",value:function e(){return BX.prop.getString(this._data,"presetId","0")}},{key:"getBankDetails",value:function e(){return BX.prop.getArray(this._data,"bankDetails",[])}},{key:"getRequisiteId",value:function e(){return this._data.requisiteId}},{key:"getRequisiteIdAsString",value:function e(){var t=this.getRequisiteId();t=r.Type.isNumber(t)?String(t):t;return r.Type.isStringFilled(t)?t:""}},{key:"getRequisiteData",value:function e(){return this._data.requisiteData}},{key:"getRequisiteDataSign",value:function e(){return this._data.requisiteDataSign}},{key:"getFields",value:function e(){if(r.Type.isPlainObject(this._data.value)&&r.Type.isPlainObject(this._data.value.fields)){return babelHelpers.objectSpread({},this._data.value.fields)}return{}}},{key:"getAutocompleteData",value:function e(){var t=null;var i=this.getAutocompleteState();var s=BX.prop.getObject(i,"currentItem",null);if(r.Type.isPlainObject(s)){t={title:BX.prop.getString(s,"title",""),subTitle:BX.prop.getString(s,"subTitle","")}}else if(!r.Type.isUndefined(this._data.value.viewData)&&r.Type.isArray(this._data.value.viewData.fields)){var n=this._data.value.viewData.fields;t={title:r.Type.isStringFilled(this._data.title)?this._data.title:"",subTitle:n.filter(function(e){return e.name==="RQ_INN"&&e.textValue.length}).map(function(e){return e.title+" "+e.textValue}).join("")}}return t}},{key:"setAutocompleteState",value:function e(t){this._data.autocompleteState=r.Type.isPlainObject(t)?t:{}}},{key:"getAutocompleteState",value:function e(){return this._data.autocompleteState}},{key:"getAddressList",value:function e(){return this._data.addressList}},{key:"setAddressList",value:function e(t){this._data.addressList=t}},{key:"setInitialAddressData",value:function e(t){this._data.initialAddressDdta=t}},{key:"getAddressesForSave",value:function e(){var t=r.Type.isPlainObject(this._data.initialAddressDdta)?Object.keys(this._data.initialAddressDdta):[];var i={};var s=u(t),n;try{for(s.s();!(n=s.n()).done;){var a=n.value;i[a]=""}}catch(e){s.e(e)}finally{s.f()}var o=this.getAddressData();for(var l in o){if(o.hasOwnProperty(l)&&o[l].length){i[l]=o[l]}}for(var d in i){if(r.Type.isString(i[d])&&i[d]===""){i[d]={DELETED:"Y"}}}return i}},{key:"setRequisiteId",value:function e(t){this._data.requisiteId=t}},{key:"setPresetId",value:function e(t){this._data.presetId=t}},{key:"setSelected",value:function e(t){this._data.selected=!!t;this._data.justSelected=!!t}},{key:"setRequisiteData",value:function e(t,i){this._data.requisiteData=t;if(r.Type.isStringFilled(i)){this._data.requisiteDataSign=i}this.prepareViewData()}},{key:"setDeleted",value:function e(t){this._data.isDeleted=!!t}},{key:"isDeleted",value:function e(){return this._data.isDeleted}},{key:"setAddressOnly",value:function e(t){this._data.isAddressOnly=!!t;this.setFormData(babelHelpers.objectSpread({},this.getFormData(),{ADDRESS_ONLY:t?"Y":"N"}))}},{key:"isAddressOnly",value:function e(){return this._data.isAddressOnly}},{key:"isEmptyFormData",value:function e(){return Object.keys(this._data.formData).length<=0}},{key:"getFormData",value:function e(){return this._data.formData}},{key:"setFormData",value:function e(t){this._data.formData=t}},{key:"clearFormData",value:function e(){this.setFormData({})}},{key:"isEmptyAddressData",value:function e(){return Object.keys(this._data.addressData).length<=0}},{key:"getAddressData",value:function e(){return this._data.addressData}},{key:"setAddressData",value:function e(t){this._data.addressData=t}},{key:"clearAddressData",value:function e(){this.setAddressData({})}},{key:"setSelectedBankDetails",value:function e(t){if(!r.Type.isArray(this._data.bankDetails)){return}if(r.Type.isNull(t)){t=0}for(var i=0;i<this._data.bankDetails.length;i++){this._data.bankDetails[i].selected=i===t}this._data.selectedBankDetailId=t}},{key:"clearSelectedBankDetails",value:function e(){if(!r.Type.isArray(this._data.bankDetails)){return}for(var t=0;t<this._data.bankDetails.length;t++){this._data.bankDetails[t].selected=false}}},{key:"exportToModel",value:function e(){var t=babelHelpers.objectSpread({},this._data);delete t.value;delete t.addressList;delete t.bankDetails;delete t.initialAddressDdta;delete t.isAddressOnly;return t}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}();f.newRequisitePattern=/n([0-9]+)/;var p=function(){function e(){babelHelpers.classCallCheck(this,e);this._requisiteList=null;this._entityTypeId=null;this._entityId=null;this._contextId=null;this._mode=BX.Crm.EntityEditorMode.view;this.currentSliderRequisiste=null}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._entityTypeId=BX.prop.getInteger(i,"entityTypeId",0);this._entityId=BX.prop.getInteger(i,"entityId",0);this._contextId=BX.prop.getString(i,"contextId","");this._requisiteEditUrl=BX.prop.getString(i,"requisiteEditUrl","");l.EventEmitter.subscribe("onLocalStorageSet",this.onExternalEvent.bind(this))}},{key:"setRequisiteList",value:function e(t){this._requisiteList=t}},{key:"setMode",value:function e(t){this._mode=t}},{key:"open",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(!(t instanceof f)){return}this.currentSliderRequisiste=t;var s={width:950,cacheable:false,allowChangeHistory:false,requestMethod:"post",requestParams:this.prepareSliderRequestParams(t,i)};BX.Crm.Page.openSlider(this.getSliderUrl(t),s)}},{key:"deleteRequisite",value:function e(t){var i=this;var s=this._requisiteList.getById(t);if(s){var n=babelHelpers.objectSpread({},this.prepareSliderRequestParams(s));n.sessid=BX.bitrix_sessid();n.mode="delete";n.ACTION="SAVE";BX.ajax.post(this.getSliderUrl(s),n,function(e){try{var t=JSON.parse(e);if(r.Type.isStringFilled(t.ERROR)){i.showError(t.ERROR)}else{var n=i._requisiteList.getSelected();var a=n===s;i._requisiteList.remove(s);l.EventEmitter.emit(i,"onAfterDeleteRequisite",{selectedRemoved:a})}}catch(e){}})}}},{key:"showError",value:function e(t){s.MessageBox.alert(t,r.Loc.getMessage("REQUISITE_LIST_ITEM_ERROR_CAPTION"))}},{key:"getSliderUrl",value:function e(t){var i=t.getRequisiteId();var s={etype:this._entityTypeId,eid:this._entityId,external_context_id:this._contextId};var n=t.getPresetId();if(n>0){s["pid"]=n}return BX.util.add_url_param(this.getRequisiteEditUrl(i),s)}},{key:"prepareSliderRequestParams",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var s={};var n=t.getRequisiteData();if(t.isChanged()&&r.Type.isString(n)&&n.length){s["externalData"]={data:n,sign:t.getRequisiteDataSign()}}if(t.isSelected()){var a=t.getAutocompleteState();if(Object.keys(a).length){s["AUTOCOMPLETE"]=JSON.stringify(a);s["useFormData"]="Y"}}if(!t.isEmptyFormData()){s=babelHelpers.objectSpread({},s,t.getFormData())}if(!t.isEmptyAddressData()){s=babelHelpers.objectSpread({},s,{RQ_ADDR:t.getAddressesForSave()})}s["mode"]=t.isNew()?"create":"edit";if(this.isViewMode()){s["doSave"]="Y"}if(BX.prop.getBoolean(i,"addBankDetailsItem",false)){s["addBankDetailsItem"]="Y"}var o=BX.prop.getInteger(i,"overriddenPresetId",0);if(o>0){s["PRESET_ID"]=o;s["useFormData"]="Y"}return s}},{key:"getRequisiteEditUrl",value:function e(t){return this._requisiteEditUrl.replace(/#requisite_id#/gi,t)}},{key:"getSignRequisitePromise",value:function e(t){var i=this.prepareSliderRequestParams(t);i.sessid=BX.bitrix_sessid();i.PRESET_ID=t.getPresetId();i.useFormData="Y";i.ACTION="SAVE";return BX.ajax.promise({method:"post",dataType:"json",url:this.getSliderUrl(t),data:i})}},{key:"isViewMode",value:function e(){return this._mode===BX.Crm.EntityEditorMode.view}},{key:"onExternalEvent",value:function e(t){var i=t.getData();if(!r.Type.isArray(i)){return}var s=i[0];var n=BX.prop.getString(s,"key","");if(n!=="BX.Crm.RequisiteSliderDetails:onCancelEdit"&&n!=="BX.Crm.RequisiteSliderDetails:onSave"){return}var a=BX.prop.getObject(s,"value",{});var o=BX.prop.getString(a,"contextId","");if(o!==this._contextId){return}if(n==="BX.Crm.RequisiteSliderDetails:onCancelEdit"){this.currentSliderRequisiste=null}if(n==="BX.Crm.RequisiteSliderDetails:onSave"){var u=this.currentSliderRequisiste;if(r.Type.isObject(u)){if(r.Type.isString(a.requisiteData)){u.setRequisiteData(a.requisiteData,a.requisiteDataSign);u.setAutocompleteState({});u.clearFormData();u.clearAddressData()}if(r.Type.isString(a.presetId)){u.setPresetId(a.presetId)}if(this.isViewMode()){u.setNew(false)}else{u.setChanged(true)}u.setDeleted(false);if(this._requisiteList.indexOf(u)<0){this._requisiteList.add(u)}else{this._requisiteList.notifyListChanged()}this.currentSliderRequisiste=null;l.EventEmitter.emit(this,"onAfterEditRequisite")}}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}();function g(){var e=babelHelpers.taggedTemplateLiteral(['<input type="hidden" name="REQUISITES[','][SIGN]" value="','" >']);g=function t(){return e};return e}function v(){var e=babelHelpers.taggedTemplateLiteral(["",""]);v=function t(){return e};return e}function y(){var e=babelHelpers.taggedTemplateLiteral(['<input type="hidden" name="REQUISITES[','][DATA]" value="','" >']);y=function t(){return e};return e}function _(){var e=babelHelpers.taggedTemplateLiteral(['<input type="hidden" name="REQUISITES[','][DELETED]" value="Y" >']);_=function t(){return e};return e}function m(){var e=babelHelpers.taggedTemplateLiteral(["<div></div>"]);m=function t(){return e};return e}function E(e,t){var i;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(i=b(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var s=0;var n=function e(){};return{s:n,n:function t(){if(s>=e.length)return{done:true};return{done:false,value:e[s++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,a=false,o;return{s:function t(){i=e[Symbol.iterator]()},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){a=true;o=t},f:function e(){try{if(!r&&i.return!=null)i.return()}finally{if(a)throw o}}}}function b(e,t){if(!e)return;if(typeof e==="string")return q(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return q(e,t)}function q(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,s=new Array(t);i<t;i++){s[i]=e[i]}return s}var R=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._requisiteList=null;e._requisiteEditor=null;e._requisiteFieldId=null;e._requisiteField=null;e._requisiteInitData=null;e._addressFieldId=null;e._addressField=null;e._isLoading=false;e._formInputsWrapper=null;return e}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"doInitialize",this).call(this);this._requisiteFieldId=this.getConfigStringParam("requisiteFieldId","");this._addressFieldId=this.getConfigStringParam("addressFieldId","");this.saveRequisiteInitData();l.EventEmitter.subscribe(this._editor,"onFieldInit",this.onFieldInit.bind(this));this.initRequisiteEditor();this.initRequisiteList()}},{key:"initRequisiteList",value:function e(){this._requisiteList=c.create(this._requisiteInitData);this._requisiteList.subscribe(this._requisiteList.CHANGE_EVENT,this.onChangeRequisites.bind(this));this._requisiteEditor.setRequisiteList(this._requisiteList)}},{key:"initRequisiteEditor",value:function e(){this._requisiteEditor=p.create(this._id+"_rq_editor",{entityTypeId:this._editor.getEntityTypeId(),entityId:this._editor.getEntityId(),contextId:this._editor.getContextId(),requisiteEditUrl:this._editor.getRequisiteEditUrl("#requisite_id#")});l.EventEmitter.subscribe(this._requisiteEditor,"onAfterEditRequisite",this.onRequisiteEditorAfterEdit.bind(this));l.EventEmitter.subscribe(this._requisiteEditor,"onAfterDeleteRequisite",this.onRequisiteEditorAfterDelete.bind(this))}},{key:"initRequisiteField",value:function e(){if(this._requisiteField){this._requisiteField.setRequisites(this._requisiteList)}}},{key:"initAddressField",value:function e(){if(this._addressField){var t={};var i=this._requisiteList?this._requisiteList.getSelected():null;if(i){var s=i.getAddressList();for(var n in s){if(s.hasOwnProperty(n)&&BX.prop.getString(s[n],"DELETED","N")!=="Y"){t[n]=s[n]}}}this._addressField.setAddressList(t)}}},{key:"saveRequisiteInitData",value:function e(){this._requisiteInitData=this.getRequisiteFieldValue()}},{key:"validate",value:function e(t){var i=this;var s=[];var n=E(this._requisiteList.getList()),a;try{var o=function e(){var n=a.value;if(!n.isChanged()){return"continue"}if(n.isEmptyFormData()&&n.isEmptyAddressData()){return"continue"}var o=i.signRequisiteFields(n);o.then(function(e){var s=BX.prop.getString(e,"ERROR","");var a=BX.prop.getObject(e,"ENTITY_DATA",{});var o=BX.prop.getString(a,"REQUISITE_DATA","");var l=BX.prop.getString(a,"REQUISITE_DATA_SIGN","");if(r.Type.isStringFilled(s)){t.addError(BX.Crm.EntityValidationError.create({field:i.getFirstEditModeField()}));i.showError(s)}else if(r.Type.isStringFilled(o)&&r.Type.isStringFilled(l)){n.setRequisiteData(o,l);n.clearFormData();n.clearAddressData()}else{t.addError(BX.Crm.EntityValidationError.create({field:i.getFirstEditModeField()}));i.showError(r.Loc.getMessage("CRM_EDITOR_SAVE_ERROR_CONTENT"))}return true},function(){t.addError(BX.Crm.EntityValidationError.create({field:i.getFirstEditModeField()}));i.showError(r.Loc.getMessage("CRM_EDITOR_SAVE_ERROR_CONTENT"));return new Promise(function(e,t){e()})});s.push(o)};for(n.s();!(a=n.n()).done;){var l=o();if(l==="continue")continue}}catch(e){n.e(e)}finally{n.f()}return s.length>0?Promise.all(s):null}},{key:"setSelectedRequisite",value:function e(t,i){var s=this;var n=this._editor.getEntityId();if(!n){return}var a=this._requisiteList.getById(t);if(!a||a.isNew()){return}this._requisiteList.setSelected(t,i);var o=a.getBankDetailById(a.getSelectedBankDetailId());var l=r.Type.isNull(o)?null:o.id;this.startLoading();BX.ajax.runAction("crm.requisite.settings.setSelectedEntityRequisite",{data:{entityTypeId:this._editor.getEntityTypeId(),entityId:n,requisiteId:a.getRequisiteId(),bankDetailId:l}}).then(function(e){s.stopLoading()},function(){s.stopLoading()})}},{key:"openEditor",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};this.setRequisiteInitAddrData(t);this._requisiteEditor.setMode(this._editor.getMode());this._requisiteEditor.open(t,i)}},{key:"isViewMode",value:function e(){return this._editor.getMode()===BX.Crm.EntityEditorMode.view}},{key:"setRequisiteInitAddrData",value:function e(t){var i=t.getRequisiteId();var s=this._requisiteInitData.filter(function(e){return e.requisiteId===i}).reduce(function(e,t){return t},null);if(r.Type.isPlainObject(s)){try{var n=JSON.parse(s.requisiteData);var a=BX.prop.getObject(n,"fields",{});var o=BX.prop.getObject(a,"RQ_ADDR",null);t.setInitialAddressData(o)}catch(e){t.setInitAddrData(null)}}}},{key:"getFirstEditModeField",value:function e(){if(this._requisiteField&&this._requisiteField._mode===BX.Crm.EntityEditorMode.edit){return this._requisiteField}if(this._addressField&&this._addressField._mode===BX.Crm.EntityEditorMode.edit){return this._addressField}return null}},{key:"updateRequisiteFieldModel",value:function e(){var t=this._requisiteList.exportToModel();if(this._requisiteField){this._model.setField(this._requisiteFieldId,t)}this.saveRequisiteInitData(babelHelpers.toConsumableArray(t))}},{key:"getRequisiteFieldValue",value:function e(){if(!this._requisiteFieldId){return[]}return this._model.getField(this._requisiteFieldId,[])}},{key:"addEditorFormInputs",value:function e(){this._formInputsWrapper=r.Tag.render(m());r.Dom.append(this._formInputsWrapper,this._editor.getFormElement());var t=E(this._requisiteList.getListWithDeleted()),i;try{for(t.s();!(i=t.n()).done;){var s=i.value;if(s.isDeleted()){r.Dom.append(r.Tag.render(_(),s.getRequisiteId()),this._formInputsWrapper);continue}if(!s.isChanged()){continue}var n=r.Tag.render(y(),s.getRequisiteId(),r.Tag.safe(v(),s.getRequisiteData()));var a=r.Tag.render(g(),s.getRequisiteId(),s.getRequisiteDataSign());r.Dom.append(n,this._formInputsWrapper);r.Dom.append(a,this._formInputsWrapper)}}catch(e){t.e(e)}finally{t.f()}}},{key:"removeEditorFormInputs",value:function e(){if(r.Type.isDomNode(this._formInputsWrapper)){r.Dom.remove(this._formInputsWrapper);this._formInputsWrapper=null}}},{key:"markFieldsAsChanged",value:function e(){if(this._requisiteField){this._requisiteField.markAsChanged()}if(this._addressField){this._addressField.markAsChanged()}}},{key:"rollback",value:function e(){this.initRequisiteList();this.initRequisiteField();this.initAddressField();this.updateRequisiteFieldModel()}},{key:"isLoading",value:function e(){return!!this._isLoading}},{key:"startLoading",value:function e(){this._isLoading=true}},{key:"stopLoading",value:function e(){this._isLoading=false}},{key:"showError",value:function e(t){s.MessageBox.alert(t,r.Loc.getMessage("REQUISITE_LIST_ITEM_ERROR_CAPTION"))}},{key:"prepareRequisiteByEventData",value:function e(t){var i=this._requisiteList.getById(t.id);if(!i){var s={selected:this._requisiteList.isEmpty(),presetId:t.defaultPresetId};if(t.hasOwnProperty("autocompleteState")){s.autocompleteState=t.autocompleteState}i=f.create(null,{newRequisiteId:this._requisiteList.getNewRequisiteId(),newRequisiteExtraFields:s})}else{if(t.hasOwnProperty("autocompleteState")){i.setAutocompleteState(t.autocompleteState)}}return i}},{key:"getDefaultPresetId",value:function e(){var t=this;if(this._requisiteField){return this._requisiteField.getDefaultPresetId()}else{var i=this._editor.getScheme().getAvailableElements().filter(function(e){return e.getName()===t._requisiteFieldId}).reduce(function(e,t){return t},null);if(!i){return null}var s=E(BX.prop.getArray(i.getData(),"presets",[])),n;try{for(s.s();!(n=s.n()).done;){var r=n.value;if(r.IS_DEFAULT){return r.VALUE}}}catch(e){s.e(e)}finally{s.f()}}return null}},{key:"signRequisiteFields",value:function e(t){this.setRequisiteInitAddrData(t);this._requisiteEditor.setMode(this._editor.getMode());return this._requisiteEditor.getSignRequisitePromise(t)}},{key:"onFieldInit",value:function e(t){var i=t.getData();var s=i.field;if(s){var n=s.getId();if(r.Type.isStringFilled(this._requisiteFieldId)&&n===this._requisiteFieldId){this._requisiteField=s;this.initRequisiteField();l.EventEmitter.subscribe(this._requisiteField,"onEditNew",this.onEditNewRequisite.bind(this));l.EventEmitter.subscribe(this._requisiteField,"onEditExisted",this.onEditExistedRequisite.bind(this));l.EventEmitter.subscribe(this._requisiteField,"onFinishAutocomplete",this.onFinishRequisiteAutocomplete.bind(this));l.EventEmitter.subscribe(this._requisiteField,"onClearAutocomplete",this.onClearRequisiteAutocomplete.bind(this));l.EventEmitter.subscribe(this._requisiteField,"onSetDefault",this.onSetDefaultRequisite.bind(this));l.EventEmitter.subscribe(this._requisiteField,"onDelete",this.onDeleteRequisite.bind(this));l.EventEmitter.subscribe(this._requisiteField,"onHide",this.onHideRequisite.bind(this))}if(r.Type.isStringFilled(this._addressFieldId)&&n===this._addressFieldId){this._addressField=s;this.initAddressField();l.EventEmitter.subscribe(this._addressField,"onAddressListUpdate",this.onAddressListUpdate.bind(this))}}}},{key:"onEditNewRequisite",value:function e(t){var i=t.getData();i.selected=this._requisiteList.isEmpty();var s=f.create(null,{newRequisiteId:this._requisiteList.getNewRequisiteId(),newRequisiteExtraFields:i});s.setRequisiteId(this._requisiteList.getNewRequisiteId());this.openEditor(s)}},{key:"onEditExistedRequisite",value:function e(t){var i=t.getData();var s=this._requisiteList.getById(i.id);if(s){var n=BX.prop.getObject(i,"options",{});if(r.Type.isPlainObject(n.autocompleteState)){s.setAutocompleteState(n.autocompleteState)}var a={};if(r.Type.isPlainObject(n.editorOptions)){a=n.editorOptions}this.openEditor(s,a)}}},{key:"onClearRequisiteAutocomplete",value:function e(t){var i=t.getData();var s=this._requisiteList.getById(i.id);if(s){s.clearFormData()}}},{key:"onFinishRequisiteAutocomplete",value:function e(t){var i=t.getData();var s=this.prepareRequisiteByEventData(i);var n=BX.prop.getObject(BX.prop.getObject(i,"data",{}),"fields",{});if(n.hasOwnProperty("RQ_ADDR")){if(r.Type.isPlainObject(n.RQ_ADDR)){var a=s.getAddressList();a=r.Type.isPlainObject(a)?a:{};var o=babelHelpers.objectSpread({},a,n.RQ_ADDR);s.setAddressData(o);s.setAddressList(o)}delete n.RQ_ADDR}s.setFormData(n);s.setChanged(true);s.setDeleted(false);var l=BX.prop.getInteger(n,"PRESET_ID",0);if(l>0){s.setPresetId(l)}if(this._requisiteList.indexOf(s)<0){this._requisiteList.add(s)}else{this._requisiteList.notifyListChanged()}if(s.isAddressOnly()){this._requisiteList.unhide(s)}}},{key:"onSetDefaultRequisite",value:function e(t){var i=t.getData();var s=i.id;var n=i.bankDetailId;if(this._addressField&&this._addressField.isChanged()){this._editor.cancel();return false}this.setSelectedRequisite(s,n);this.updateRequisiteFieldModel();return true}},{key:"onDeleteRequisite",value:function e(t){var i=t.getData();var s=this._requisiteList.getById(i.id);if(s){this.setRequisiteInitAddrData(s)}if(i.postponed){this._requisiteList.removePostponed(s)}else{this._requisiteEditor.setMode(this._editor.getMode());this._requisiteEditor.deleteRequisite(i.id)}}},{key:"onHideRequisite",value:function e(t){var i=t.getData();var s=this._requisiteList.getById(i.id);if(s){this._requisiteList.hide(s)}}},{key:"onChangeRequisites",value:function e(){this.initAddressField()}},{key:"onAddressListUpdate",value:function e(t){var i=t.getData();i.id=this._requisiteList.getSelectedId();i.defaultPresetId=this.getDefaultPresetId();var s=this.prepareRequisiteByEventData(i);var n={};var a=true;var o=E(i.value),l;try{for(o.s();!(l=o.n()).done;){var u=l.value;n[u.type]=u.value;if(r.Type.isStringFilled(u.value)){a=false}}}catch(e){o.e(e)}finally{o.f()}s.setAddressData(n);s.setAddressList(n);s.setChanged(true);if(!a){s.setDeleted(false)}if(this._requisiteList.indexOf(s)<0){if(!a){s.setAddressOnly(true);this._requisiteList.add(s)}}else{if(a&&s.isAddressOnly()){this._requisiteList.removePostponed(s)}this._requisiteList.notifyListChanged()}}},{key:"onBeforeSubmit",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"onBeforeSubmit",this).call(this);this.addEditorFormInputs()}},{key:"onBeforesSaveControl",value:function e(t){if(!t.hasOwnProperty("REQUISITES")){t["REQUISITES"]={}}var i=E(this._requisiteList.getListWithDeleted()),s;try{for(i.s();!(s=i.n()).done;){var n=s.value;if(!n.isChanged()&&!n.isDeleted()){continue}var r={};if(n.isDeleted()){r["DELETED"]="Y"}else{r["DATA"]=n.getRequisiteData();r["SIGN"]=n.getRequisiteDataSign()}t["REQUISITES"][n.getRequisiteId()]=r}}catch(e){i.e(e)}finally{i.f()}return t}},{key:"onAfterSave",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"onAfterSave",this).call(this);this.saveRequisiteInitData(this.getRequisiteFieldValue());this.initRequisiteList();this.initRequisiteField();this.initAddressField();this.removeEditorFormInputs()}},{key:"onRequisiteEditorAfterEdit",value:function e(){if(this.isViewMode()){this.updateRequisiteFieldModel()}this.markFieldsAsChanged()}},{key:"onRequisiteEditorAfterDelete",value:function e(t){var i=t.getData();var s=this._requisiteList.isEmpty();if(!s&&i.selectedRemoved){this.setSelectedRequisite(0,0)}this.updateRequisiteFieldModel()}}],[{key:"create",value:function e(i,s){var n=new t;n.initialize(i,s);return n}}]);return t}(BX.Crm.EntityEditorController);function D(e,t){var i;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(i=I(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var s=0;var n=function e(){};return{s:n,n:function t(){if(s>=e.length)return{done:true};return{done:false,value:e[s++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,a=false,o;return{s:function t(){i=e[Symbol.iterator]()},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){a=true;o=t},f:function e(){try{if(!r&&i.return!=null)i.return()}finally{if(a)throw o}}}}function I(e,t){if(!e)return;if(typeof e==="string")return S(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return S(e,t)}function S(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,s=new Array(t);i<t;i++){s[i]=e[i]}return s}var k=function(e){babelHelpers.inherits(t,e);function t(e,i){var s;babelHelpers.classCallCheck(this,t);s=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));s._isShown=false;s.menuId=e;s.presetList=i;return s}babelHelpers.createClass(t,[{key:"toggle",value:function e(t){if(this._isShown){this.close()}else if(t){this.show(t)}}},{key:"show",value:function e(t){var n=this;if(this._isShown){return}if(!this.presetList||!this.presetList.length){s.MessageBox.alert(r.Loc.getMessage("REQUISITE_LIST_EMPTY_PRESET_LIST"),r.Loc.getMessage("REQUISITE_LIST_ITEM_ERROR_CAPTION"));return}var a=[];var o=D(this.presetList),l;try{for(o.s();!(l=o.n()).done;){var u=l.value;a.push({text:u.name,value:u.value,onclick:this.onSelect.bind(this,u)})}}catch(e){o.e(e)}finally{o.f()}i.MenuManager.show(this.menuId,t,a,{angle:false,cacheable:false,events:{onPopupShow:function e(){n._isShown=true},onPopupClose:function e(){n._isShown=false}}})}},{key:"close",value:function e(){if(!this._isShown){return}var t=i.MenuManager.getMenuById(this.menuId);if(t){t.popupWindow.close()}}},{key:"isShown",value:function e(){return this._isShown}},{key:"onSelect",value:function e(t){this.close();this.emit("onSelect",t)}}]);return t}(l.EventEmitter);function T(){var e=babelHelpers.taggedTemplateLiteral(['<div class="crm-rq-btn-container">\n\t\t\t\t<span class="crm-rq-add-rq" onclick="','">\n\t\t\t\t\t<span class="ui-btn crm-rq-btn ui-btn-icon-custom ui-btn-primary ui-btn-round"></span> ',"\n\t\t\t\t</span>\n\t\t\t</div>"]);T=function t(){return e};return e}function L(){var e=babelHelpers.taggedTemplateLiteral(['<div class="crm-rq-org-description">',"</div>"]);L=function t(){return e};return e}function A(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="crm-rq-org-item','" onclick="','">\n\t\t\t\t\t\t<div class="crm-rq-org-info-container">\n\t\t\t\t\t\t\t<div class="crm-rq-org-name">',"</div>\n\t\t\t\t\t\t\t","\n\t\t\t\t\t\t\t","\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t"]);A=function t(){return e};return e}function C(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="crm-rq-wrapper"\n\t\t\tonmouseenter="','"\n\t\t\tonmouseleave="','">\n\t\t\t<div class="crm-rq-org-list">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t\t","\n\t\t</div>"]);C=function t(){return e};return e}function B(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t\t<label class="crm-rq-org-requisite-item" onclick="','">\n\t\t\t\t\t\t\t\t\t<input type="radio" data-requisite-id="','" data-bankdetails-id="','" class="crm-rq-org-requisite-btn" '," ",'>\n\t\t\t\t\t\t\t\t\t<span class="crm-rq-org-requisite-info">',"</span>\n\t\t\t\t\t\t\t\t</label>"]);B=function t(){return e};return e}function w(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="crm-rq-org-requisite-container">\n\t\t\t\t\t\t<div class="crm-rq-org-requisite-title">','</div>\n\t\t\t\t\t\t<div class="crm-rq-org-requisite-list">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t","\n\t\t\t\t\t</div>"]);w=function t(){return e};return e}function O(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-rq-org-requisite-btn-container">\n\t\t\t\t\t<span class="ui-link ui-link-secondary" onclick="','">','</span>\n\t\t\t\t\t<span class="ui-link ui-link-secondary" data-requisite-id="','" onclick="','">','</span>\n\t\t\t\t\t<span class="ui-link ui-link-secondary" onclick="','">',"</span>\n\t\t\t\t</div>\n\t\t\t\t"]);O=function t(){return e};return e}function F(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-rq-org-requisite-btn-container">\n\t\t\t\t\t<span class="ui-link ui-link-secondary" onclick="','">',"</span>\n\t\t\t\t</div>\n\t\t\t\t"]);F=function t(){return e};return e}function M(){var e=babelHelpers.taggedTemplateLiteral(['<div class="crm-rq-wrapper crm-rq-wrapper-loading"></div>']);M=function t(){return e};return e}var N=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=i?i:{};this._padding=BX.prop.getInteger(this._settings,"padding",20);this._showTimer=false;this._closeTimer=false;this._closeTimeout=BX.prop.getInteger(this._settings,"closeTimeout",700);this._showTimeout=BX.prop.getInteger(this._settings,"showTimeout",500);this._popupId=this._id+"_popup";this._isReadonly=BX.prop.getBoolean(this._settings,"readonly",true);this._canChangeDefaultRequisite=BX.prop.getBoolean(this._settings,"canChangeDefaultRequisite",true);this._bindElement=null;this._wrapper=null;this._requisiteList=null;this._isLoading=false;this._changeRequisistesHandler=this.onChangeRequisites.bind(this);this.presetMenu=new k(this._id+"_preset_menu",BX.prop.getArray(this._settings,"presets",[]));this.presetMenu.subscribe("onSelect",this.onAddRequisite.bind(this))}},{key:"setRequisites",value:function e(t){this._requisiteList=t;t.unsubscribe(t.CHANGE_EVENT,this._changeRequisistesHandler);t.subscribe(t.CHANGE_EVENT,this._changeRequisistesHandler);this.refreshLayout()}},{key:"setBindElement",value:function e(t,i){this._bindElement=t;if(!r.Type.isDomNode(i)){i=this._bindElement.parentNode?this._bindElement.parentNode:null}this._wrapper=i}},{key:"setLoading",value:function e(t){this._isLoading=!!t;this.refreshLayout()}},{key:"show",value:function e(){this.cancelCloseDebounced();var t=false;if(this._requisiteList&&!this._requisiteList.isEmpty()){var s=i.PopupManager.create({id:this._popupId,cacheable:false,autoHide:true,padding:this._padding,contentPadding:0,content:this.getLayout(),closeByEsc:true});s.show();this.adjustPosition();t=true}l.EventEmitter.emit(this,"onShow",{success:t})}},{key:"showDebounced",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;t=parseInt(t)>0?parseInt(t):1;this.cancelShowDebounced();this.cancelCloseDebounced();this._showTimer=setTimeout(this.show.bind(this),this._showTimeout*t)}},{key:"cancelShowDebounced",value:function e(){clearTimeout(this._showTimer)}},{key:"closeDebounced",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this.cancelShowDebounced();t=parseInt(t)>0?parseInt(t):1;this.cancelCloseDebounced();this._closeTimer=setTimeout(this.close.bind(this),this._closeTimeout*t)}},{key:"cancelCloseDebounced",value:function e(){clearTimeout(this._closeTimer)}},{key:"adjustPosition",value:function e(){var t=i.PopupManager.getPopupById(this._popupId);if(!t||!t.isShown()||!r.Type.isDomNode(this._bindElement)||!r.Type.isDomNode(this._wrapper)){return}var s=this._wrapper.getBoundingClientRect();var n=this._bindElement.getBoundingClientRect();var a=s.width-(n.left-s.left);var o=n.height/2+this._padding;var l=n.height/2;var u=t.getPopupContainer().offsetWidth;var d=t.getPopupContainer().offsetHeight;var h=n.top+d;var c=document.documentElement.clientWidth;var f=document.documentElement.clientHeight;var p=h-f;if(p>0){var g=Math.ceil(p/n.height)*n.height;if(g>n.top){g-=Math.ceil((g-n.top)/n.height)*n.height}if(n.bottom>h-g){g-=n.bottom-(h-g)+this._padding}o+=g;l+=g+this._padding}t.setBindElement(this._bindElement);if(s.left+a+u<=c){t.setAngle({position:"left",offset:l});a+=t.angle?t.angle.element.offsetWidth:0;o+=t.angle?Math.ceil(t.angle.element.offsetHeight/2):0;t.setOffset({offsetLeft:a,offsetTop:-o})}else{t.setAngle(true)}t.adjustPosition()}},{key:"close",value:function e(){var t=i.PopupManager.getPopupById(this._popupId);t?t.close():null;this.presetMenu.close()}},{key:"removeDebouncedEvents",value:function e(){this.cancelCloseDebounced();this.cancelShowDebounced()}},{key:"refreshLayout",value:function e(){var t=i.PopupManager.getPopupById(this._popupId);if(t){t.setContent(this.getLayout())}}},{key:"getLayout",value:function e(){var t=this;if(this._isLoading){var i=new a.Loader;var s=r.Tag.render(M());i.show(s);return s}var n=r.Type.isNull(this._requisiteList)?[]:this._requisiteList.getList();var o=function e(i){if(t._isReadonly){return r.Tag.render(F(),t.onEditRequisite.bind(t,i),r.Loc.getMessage("REQUISITE_TOOLTIP_SHOW_DETAILS"))}else{return r.Tag.render(O(),t.onEditRequisite.bind(t,i),r.Loc.getMessage("REQUISITE_TOOLTIP_EDIT"),i,t.onDeleteRequisite.bind(t),r.Loc.getMessage("REQUISITE_TOOLTIP_DELETE"),t.onAddBankDetails.bind(t,i),r.Loc.getMessage("REQUISITE_TOOLTIP_ADD_BANK_DETAILS"))}};var l=function e(i,s){var n=i.getBankDetails();var a=i.getSelectedBankDetailId();return n.length?r.Tag.render(w(),r.Loc.getMessage("REQUISITE_TOOLTIP_BANK_DETAILS_TITLE"),n.map(function(e,n){return r.Tag.render(B(),t.onSetSelectedBankDetails.bind(t),s,n,i.isSelected()&&n===a?" checked":"",t._canChangeDefaultRequisite?"":" disabled",e.value)}),o(s)):o(s)};return r.Tag.render(C(),this.onMouseEnter.bind(this),this.onMouseLeave.bind(this),n.map(function(e,i){return r.Tag.render(A(),e.isSelected()?" crm-rq-org-item-selected":"",t.onSetSelectedRequisite.bind(t,i),e.getTitle(),e.getSubtitle().length?r.Tag.render(L(),e.getSubtitle()):"",l(e,i))}),this._isReadonly?"":r.Tag.render(T(),this.onStartAddRequisite.bind(this),r.Loc.getMessage("REQUISITE_TOOLTIP_ADD")))}},{key:"setSelectedRequisite",value:function e(t,i){var s=this._requisiteList.getById(t);if(!s){return false}var n=this._requisiteList.getSelected();if(t===this._requisiteList.getSelectedId()){var a=n.getBankDetails();if(a.length){for(var o=0;o<a.length;o++){var u=a[o];if(r.Type.isObject(u)&&u.selected){if(o===i||r.Type.isNull(i)){return false}}}}else{return false}}l.EventEmitter.emit(this,"onSetSelectedRequisite",{id:t,bankDetailId:i});return true}},{key:"onMouseEnter",value:function e(){this.cancelCloseDebounced()}},{key:"onMouseLeave",value:function e(){if(!this.presetMenu.isShown()){this.closeDebounced(1.5)}}},{key:"onStartAddRequisite",value:function e(t){t.stopPropagation();this.presetMenu.toggle(t.target)}},{key:"onAddRequisite",value:function e(t){var i=t.getData();this.close();l.EventEmitter.emit(this,"onAddRequisite",{presetId:i.value})}},{key:"onEditRequisite",value:function e(t,i){i.stopPropagation();this.close();l.EventEmitter.emit(this,"onEditRequisite",{id:t})}},{key:"onDeleteRequisite",value:function e(t){t.stopPropagation();var i=t.target;if(r.Type.isDomNode(i)){var s=i.getAttribute("data-requisite-id");l.EventEmitter.emit(this,"onDeleteRequisite",{id:s})}}},{key:"onAddBankDetails",value:function e(t,i){i.stopPropagation();this.close();l.EventEmitter.emit(this,"onAddBankDetails",{requisiteId:t})}},{key:"onSetSelectedRequisite",value:function e(t){if(this._canChangeDefaultRequisite){this.setSelectedRequisite(t,null)}return false}},{key:"onSetSelectedBankDetails",value:function e(t){t.stopPropagation();var i=t.target;if(this._canChangeDefaultRequisite&&r.Type.isDomNode(i)){if(i.nodeName.toString().toLowerCase()!=="input"){i=i.querySelector("input");if(!r.Type.isDomNode(i)){return}}i.checked=false;var s=parseInt(i.getAttribute("data-requisite-id"));var n=parseInt(i.getAttribute("data-bankdetails-id"));this.setSelectedRequisite(s,n)}return false}},{key:"onChangeRequisites",value:function e(t){this.refreshLayout()}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}();function P(e,t){var i;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(i=X(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var s=0;var n=function e(){};return{s:n,n:function t(){if(s>=e.length)return{done:true};return{done:false,value:e[s++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,a=false,o;return{s:function t(){i=e[Symbol.iterator]()},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){a=true;o=t},f:function e(){try{if(!r&&i.return!=null)i.return()}finally{if(a)throw o}}}}function X(e,t){if(!e)return;if(typeof e==="string")return H(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return H(e,t)}function H(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,s=new Array(t);i<t;i++){s[i]=e[i]}return s}function x(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="crm-entity-widget-content-block-inner">\n\t\t\t','\n\t\t\t<div class="crm-entity-widget-content-block-add-field">\n\t\t\t\t<span class="crm-entity-widget-content-add-field" onclick="','">',"</span>\n\t\t\t</div>\n\t\t</div>"]);x=function t(){return e};return e}function j(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-entity-widget-content-block-field-container crm-entity-widget-content-block-field-requisites"></div>']);j=function t(){return e};return e}function U(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="crm-entity-widget-content-block-inner crm-entity-widget-content-block-requisites">\n\t\t\t<span class="crm-entity-widget-client-requisites-add-btn" onclick="','">',"</span>\n\t\t</div>"]);U=function t(){return e};return e}function V(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-entity-widget-content-block-inner" \n\t\t\t\tonclick="','"\n\t\t\t\tonmouseenter="','">\n\t\t\t\t\t',"\n\t\t\t</div>"]);V=function t(){return e};return e}function Q(){var e=babelHelpers.taggedTemplateLiteral(["<span></span>"]);Q=function t(){return e};return e}function W(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span class="ui-link ui-link-secondary ui-entity-editor-block-title-link"\n\t\t\t\t \tonclick="','">',"</span>"]);W=function t(){return e};return e}var Y=function(e){babelHelpers.inherits(i,e);function i(){var e;babelHelpers.classCallCheck(this,i);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this));e._domNodes={};e._requisiteList=null;e.presetMenu=null;e._autocomplete=null;e._tooltip=null;e._changeRequisistesHandler=e.onChangeRequisites.bind(babelHelpers.assertThisInitialized(e));return e}babelHelpers.createClass(i,[{key:"doInitialize",value:function e(){this._autocomplete=t.RequisiteAutocompleteField.create(this.getName(),{searchAction:"crm.requisite.entity.search",canAddRequisite:true,feedbackFormParams:BX.prop.getObject(this._schemeElement.getData(),"feedback_form",{}),enabled:true,showFeedbackLink:false});this._autocomplete.subscribe("onSelectValue",this.onSelectAutocompleteValue.bind(this));this._autocomplete.subscribe("onCreateNewItem",this.onAddRequisiteFromAutocomplete.bind(this));this._autocomplete.subscribe("onClear",this.onClearAutocompleteValue.bind(this));this.presetMenu=new k(this.getName()+"_requisite_preset_menu",this.getPresetList());this.presetMenu.subscribe("onSelect",this.onAddRequisiteFromMenu.bind(this));var i=this.getEditor().isReadOnly();this._tooltip=N.create(this.getName()+"_requisite_details",{readonly:i,canChangeDefaultRequisite:!i,presets:this.getPresetList()});l.EventEmitter.subscribe(this._tooltip,"onAddRequisite",this.onAddRequisiteFromTooltip.bind(this));l.EventEmitter.subscribe(this._tooltip,"onEditRequisite",this.onEditRequisite.bind(this));l.EventEmitter.subscribe(this._tooltip,"onDeleteRequisite",this.onDeleteRequisite.bind(this));l.EventEmitter.subscribe(this._tooltip,"onAddBankDetails",this.onAddBankDetails.bind(this));l.EventEmitter.subscribe(this._tooltip,"onSetSelectedRequisite",this.onSetSelectedRequisite.bind(this));this.updateAutocompletePlaceholder();l.EventEmitter.emit(this.getEditor(),"onFieldInit",{field:this})}},{key:"setRequisites",value:function e(t){var i=this.hasRequisites();var s=i&&this.getRequisites().isEmpty();this._requisiteList=t;t.unsubscribe(t.CHANGE_EVENT,this._changeRequisistesHandler);t.subscribe(t.CHANGE_EVENT,this._changeRequisistesHandler);this._tooltip.setRequisites(t);if(i&&!s&&!this.getRequisites().isEmpty()){this.refreshLayoutParts()}else{this.refreshLayout()}}},{key:"getRequisites",value:function e(){return this._requisiteList}},{key:"hasRequisites",value:function e(){return r.Type.isObject(this._requisiteList)}},{key:"isSingleMode",value:function e(){if(!this.hasRequisites()){return true}return this.getRequisites().getList().length<=1}},{key:"getTitle",value:function e(){var t=babelHelpers.get(babelHelpers.getPrototypeOf(i.prototype),"getTitle",this).call(this);if(this.hasRequisites()&&!this.isSingleMode()){var s=this.hasRequisites()?this.getRequisites().getSelected():null;var n=s?s.getPresetId():null;if(s&&n){var r=this.getPresetList().reduce(function(e,t){return t.value===n?t.name:e},"");if(r.length){t+=" ("+r+")"}}}return t}},{key:"createTitleActionControls",value:function e(){if(this._mode!==BX.Crm.EntityEditorMode.edit){return[]}if(!this.isAutocompleteEnabled()){return[]}return[r.Tag.render(W(),this.editDefaultRequisite.bind(this),r.Loc.getMessage("REQUISITE_LABEL_DETAILS_TEXT"))]}},{key:"isNeedToDisplay",value:function e(t){return this.hasRequisites()&&babelHelpers.get(babelHelpers.getPrototypeOf(i.prototype),"isNeedToDisplay",this).call(this,t)}},{key:"layout",value:function e(t){if(this._hasLayout){return}this._domNodes={};this.ensureWrapperCreated({classNames:["crm-entity-widget-content-block-field-requisites"]});this.adjustWrapper();this.bindWrapperEvents();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}if(this.isDragEnabled()){r.Dom.append(this.createDragButton(),this._wrapper)}r.Dom.append(this.createTitleNode(this.getTitle()),this._wrapper);if(this._mode===BX.Crm.EntityEditorMode.edit){if(this.isAutocompleteEnabled()){this._domNodes.addButton=null;r.Dom.append(this.renderAutocompleteForm(),this._wrapper)}else{this._domNodes.addButton=this.renderAddButton();r.Dom.append(this._domNodes.addButton,this._wrapper)}}else{r.Dom.append(this.renderSelectedRequisite(),this._wrapper)}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true}},{key:"bindWrapperEvents",value:function e(){if(!this.wrapperMouseEnterHandler){this.wrapperMouseEnterHandler=this.onFieldMouseEnter.bind(this)}if(!this.wrapperMouseLeaveHandler){this.wrapperMouseLeaveHandler=this.onFieldMouseLeave.bind(this)}r.Event.unbind(this._wrapper,"mouseenter",this.wrapperMouseEnterHandler);r.Event.unbind(this._wrapper,"mouseleave",this.wrapperMouseLeaveHandler);r.Event.bind(this._wrapper,"mouseenter",this.wrapperMouseEnterHandler);r.Event.bind(this._wrapper,"mouseleave",this.wrapperMouseLeaveHandler)}},{key:"refreshLayoutParts",value:function e(){this.updateSelectedRequisiteText();this.refreshTitleLayout();this.updateAutocompleteState()}},{key:"hasValue",value:function e(){if(!this.hasRequisites()){return false}var t=this.getRequisites().getList();if(t.length>1){return true}return t.length===1&&!t[0].isAddressOnly()}},{key:"isAutocompleteEnabled",value:function e(){if(!this.hasRequisites()||this.getRequisites().isEmpty()){return!!this.getClientResolverPropForPreset(this.getSelectedPresetId())}var t=this.getRequisites().getSelected();if(t.isAddressOnly()){return!!this.getClientResolverPropForPreset(this.getSelectedPresetId())}return true}},{key:"renderSelectedRequisite",value:function e(){this._domNodes.selectedRequisiteView=r.Tag.render(Q());this.updateSelectedRequisiteText();this.updateAutocompleteState();var t=r.Tag.render(V(),this.onViewStringClick.bind(this),this.onViewStringMouseEnter.bind(this),this._domNodes.selectedRequisiteView);this._tooltip.setBindElement(t,this.getEditor().getFormElement());return t}},{key:"updateSelectedRequisiteText",value:function e(){if(!this._domNodes.selectedRequisiteView){return}var t=this.hasRequisites()&&this.getRequisites().getSelected();if(this.hasValue()&&t&&t.getTitle().length){this._domNodes.selectedRequisiteView.classList.add("ui-link","ui-link-dark","ui-link-dotted");this._domNodes.selectedRequisiteView.textContent=t.getTitle()}else{this._domNodes.selectedRequisiteView.classList.remove("ui-link","ui-link-dark","ui-link-dotted");this._domNodes.selectedRequisiteView.textContent=BX.Crm.EntityEditorField.messages.isEmpty}}},{key:"renderAddButton",value:function e(){return r.Tag.render(U(),this.toggleNewRequisitePresetMenu.bind(this),r.Loc.getMessage("CRM_EDITOR_ADD"))}},{key:"renderAutocompleteForm",value:function e(){var t=r.Tag.render(j());var i=!!this.getClientResolverPropForPreset(this.getSelectedPresetId());this._autocomplete.setEnabled(i);this._autocomplete.layout(t);this.updateAutocompleteState();return r.Tag.render(x(),t,this.toggleNewRequisitePresetMenu.bind(this),r.Loc.getMessage("CRM_EDITOR_ADD"))}},{key:"updateAutocompleteState",value:function e(){var t=null;var i=this.hasRequisites()?this.getRequisites().getSelected():null;if(i&&!i.isAddressOnly()){t=i.getAutocompleteData()}this._autocomplete.setCurrentItem(t);this._autocomplete.setContext(this.getAutocompleteContext())}},{key:"updateAutocompletePlaceholder",value:function e(){var t=this.getSelectedPresetId();var i=this.getClientResolverPropForPreset(t);this._autocomplete.setEnabled(!!i);var s=BX.prop.getString(i,"TITLE");this._autocomplete.setPlaceholderText(s)}},{key:"getDefaultPresetId",value:function e(){var t=P(BX.prop.getArray(this._schemeElement.getData(),"presets",[])),i;try{for(t.s();!(i=t.n()).done;){var s=i.value;if(s.IS_DEFAULT){return s.VALUE}}}catch(e){t.e(e)}finally{t.f()}return null}},{key:"getSelectedPresetId",value:function e(){var t=this.hasRequisites()?this.getRequisites().getSelected():null;if(t){return t.getPresetId()}return this.getDefaultPresetId()}},{key:"getClientResolverPropForPreset",value:function e(t){var i=P(BX.prop.getArray(this._schemeElement.getData(),"presets",[])),s;try{for(i.s();!(s=i.n()).done;){var n=s.value;if(n.VALUE===t){return BX.prop.get(n,"CLIENT_RESOLVER_PROP",null)}}}catch(e){i.e(e)}finally{i.f()}return null}},{key:"getAutocompleteContext",value:function e(){return{presetId:this.getSelectedPresetId()}}},{key:"toggleNewRequisitePresetMenu",value:function e(t){this.presetMenu.toggle(t.target)}},{key:"getPresetList",value:function e(){var t=[];var i=P(BX.prop.getArray(this._schemeElement.getData(),"presets")),s;try{for(i.s();!(s=i.n()).done;){var n=s.value;var r=BX.prop.getString(n,"VALUE",0);var a=BX.prop.getString(n,"NAME",r);t.push({name:a,value:r})}}catch(e){i.e(e)}finally{i.f()}return t}},{key:"addRequisite",value:function e(t){l.EventEmitter.emit(this,"onEditNew",t)}},{key:"editRequisite",value:function e(t,i){l.EventEmitter.emit(this,"onEditExisted",{id:t,options:i})}},{key:"deleteRequisite",value:function e(t){this._tooltip.removeDebouncedEvents();this._tooltip.close();l.EventEmitter.emit(this,"onDelete",{id:t,postponed:this._mode===BX.Crm.EntityEditorMode.edit})}},{key:"hideRequisite",value:function e(t){this.markAsChanged();this._autocomplete.setCurrentItem(null);l.EventEmitter.emit(this,"onHide",{id:t})}},{key:"showDeleteConfirmation",value:function e(t){var i=this;BX.Crm.EditorAuxiliaryDialog.create("delete_requisite_confirmation",{title:r.Loc.getMessage("REQUISITE_LIST_ITEM_DELETE_CONFIRMATION_TITLE"),content:r.Loc.getMessage("REQUISITE_LIST_ITEM_DELETE_CONFIRMATION_CONTENT"),buttons:[{id:"yes",type:BX.Crm.DialogButtonType.accept,text:r.Loc.getMessage("CRM_EDITOR_YES"),callback:function e(s){s.getDialog().close();i.markAsChanged();i.deleteRequisite(t)}},{id:"no",type:BX.Crm.DialogButtonType.cancel,text:r.Loc.getMessage("CRM_EDITOR_NO"),callback:function e(t){t.getDialog().close()}}]}).open()}},{key:"showClearConfirmation",value:function e(t){var i=this;BX.Crm.EditorAuxiliaryDialog.create("hide_requisite_confirmation",{title:r.Loc.getMessage("REQUISITE_LIST_ITEM_HIDE_CONFIRMATION_TITLE"),content:r.Loc.getMessage("REQUISITE_LIST_ITEM_HIDE_CONFIRMATION_CONTENT"),buttons:[{id:"yes",type:BX.Crm.DialogButtonType.accept,text:r.Loc.getMessage("CRM_EDITOR_YES"),callback:function e(s){s.getDialog().close();i.hideRequisite(t)}},{id:"no",type:BX.Crm.DialogButtonType.cancel,text:r.Loc.getMessage("CRM_EDITOR_NO"),callback:function e(t){t.getDialog().close()}}]}).open()}},{key:"editDefaultRequisite",value:function e(){var t=this.hasRequisites()?this.getRequisites().getSelectedId():null;if(null!==t){this.editRequisite(t,{autocompleteState:this._autocomplete.getState()})}else{this.addRequisite({presetId:this.getDefaultPresetId(),autocompleteState:this._autocomplete.getState()})}}},{key:"onChangeRequisites",value:function e(){if(this._domNodes&&r.Type.isDomNode(this._domNodes.addButton)||this.hasRequisites()&&this.getRequisites().isEmpty()||this.hasRequisites()&&this.getRequisites().getSelected().isAddressOnly()){this.refreshLayout()}else{this.refreshLayoutParts()}this.updateAutocompletePlaceholder()}},{key:"onAddRequisiteFromMenu",value:function e(t){var i=t.getData();var s=this.hasRequisites()?this.getRequisites().getSelected():null;if(null!==s&&s.isAddressOnly()){this.editRequisite(this.getRequisites().indexOf(s),{editorOptions:{overriddenPresetId:i.value}})}else{this.addRequisite({presetId:i.value})}}},{key:"onAddRequisiteFromTooltip",value:function e(t){this.addRequisite(t.getData())}},{key:"onAddRequisiteFromAutocomplete",value:function e(){this.editDefaultRequisite()}},{key:"onEditRequisite",value:function e(t){var i=t.getData();this.editRequisite(i.id,{autocompleteState:this._autocomplete.getState()})}},{key:"onDeleteRequisite",value:function e(t){var i=t.getData();this.showDeleteConfirmation(i.id)}},{key:"onAddBankDetails",value:function e(t){var i=t.getData();this.editRequisite(i.requisiteId,{editorOptions:{addBankDetailsItem:true},autocompleteState:this._autocomplete.getState()})}},{key:"onSelectAutocompleteValue",value:function e(t){var i=t.getData();this.markAsChanged();this._autocomplete.setLoading(true);var s=this.hasRequisites()?this.getRequisites().getSelectedId():null;l.EventEmitter.emit(this,"onFinishAutocomplete",{id:s,defaultPresetId:this.getDefaultPresetId(),autocompleteState:this._autocomplete.getState(),data:i})}},{key:"onClearAutocompleteValue",value:function e(){var t=this.hasRequisites()?this.getRequisites().getSelectedId():null;if(null!==t){var i=this.getRequisites().getSelected();var s=false;var n=i.getAddressList();for(var a in n){if(n.hasOwnProperty(a)&&r.Type.isStringFilled(n[a])){s=true;break}}if(s){this.showClearConfirmation(t)}else{this.showDeleteConfirmation(t)}}}},{key:"onViewStringClick",value:function e(){if(!this.getEditor().isReadOnly()){this._tooltip.removeDebouncedEvents();this._tooltip.close();this.switchToSingleEditMode()}}},{key:"onViewStringMouseEnter",value:function e(){if(this._mode===BX.Crm.EntityEditorMode.view&&this.hasValue()){this._tooltip.showDebounced()}}},{key:"onSetSelectedRequisite",value:function e(t){var i=t.getData();if(!this.getEditor().isReadOnly()){l.EventEmitter.emit(this,"onSetDefault",i)}return false}},{key:"onFieldMouseEnter",value:function e(){if(this._mode===BX.Crm.EntityEditorMode.view&&this.hasValue()){this._tooltip.showDebounced(5)}}},{key:"onFieldMouseLeave",value:function e(){this._tooltip.closeDebounced();this._tooltip.cancelShowDebounced()}}],[{key:"create",value:function e(t,i){var s=new this(t,i);s.initialize(t,i);return s}}]);return i}(BX.Crm.EntityEditorField);var z=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"initialize",value:function e(i,s){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"initialize",this).call(this,i,s);l.EventEmitter.emit(this.getEditor(),"onFieldInit",{field:this})}},{key:"rollback",value:function e(){}},{key:"onAddressListUpdate",value:function e(i){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"onAddressListUpdate",this).call(this,i);l.EventEmitter.emit(this,"onAddressListUpdate",i)}}],[{key:"create",value:function e(t,i){var s=new this(t,i);s.initialize(t,i);return s}}]);return t}(n.EntityEditorAddressField);function G(e,t){var i;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(i=K(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var s=0;var n=function e(){};return{s:n,n:function t(){if(s>=e.length)return{done:true};return{done:false,value:e[s++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,a=false,o;return{s:function t(){i=e[Symbol.iterator]()},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){a=true;o=t},f:function e(){try{if(!r&&i.return!=null)i.return()}finally{if(a)throw o}}}}function K(e,t){if(!e)return;if(typeof e==="string")return $(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return $(e,t)}function $(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,s=new Array(t);i<t;i++){s[i]=e[i]}return s}function J(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<span class="ui-link ui-link-secondary ui-link-dotted" onmouseup="','">\n\t\t\t\t\t',"\n\t\t\t\t</span>"]);J=function t(){return e};return e}function Z(){var e=babelHelpers.taggedTemplateLiteral(['<div class="crm-entity-widget-client-address"></div>']);Z=function t(){return e};return e}var ee=function(){function e(){babelHelpers.classCallCheck(this,e);this._id="";this._entityInfo=null;this._fieldsParams=null;this._loaderConfig=null;this._addressConfig=null;this._requisiteList=null;this._requisiteEditor=null;this._readonly=true;this._requisiteEditUrl=null;this._addressContainer=null;this._formElement=null;this._showTooltipOnEntityLoad=false}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this.setEntity(BX.prop.get(i,"entityInfo",null),false);if(!this._entityInfo){throw"EntityEditorClientRequisites: EntityInfo must be instance of BX.CrmEntityInfo"}this._fieldsParams=BX.prop.get(i,"fieldsParams",null);if(!this._fieldsParams){throw"EntityEditorClientRequisites: Fields params are undefined"}this._addressConfig=BX.prop.getObject(this._fieldsParams,"ADDRESS",null);this._requisitesConfig=BX.prop.getObject(this._fieldsParams,"REQUISITES",null);if(this._requisiteList){var s=BX.prop.getObject(i,"requisiteBinding",null);if(s&&!r.Type.isUndefined(s.REQUISITE_ID)&&!r.Type.isUndefined(s.BANK_DETAIL_ID)){var n=this._requisiteList.getByRequisiteId(s.REQUISITE_ID);if(n){var a=s.BANK_DETAIL_ID>0?n.getBankDetailByBankDetailId(s.BANK_DETAIL_ID):null;this._requisiteList.setSelected(this._requisiteList.indexOf(n),a?n.getBankDetails().indexOf(a):null)}}}this._loaderConfig=BX.prop.getObject(i,"loaderConfig",null);this._readonly=BX.prop.getBoolean(i,"readonly",true);this._canChangeDefaultRequisite=BX.prop.getBoolean(i,"canChangeDefaultRequisite",true);this._requisiteEditUrl=BX.prop.getString(i,"requisiteEditUrl",null);this._formElement=BX.prop.get(i,"formElement",null);if(BX.prop.getBoolean(i,"enableTooltip",true)&&!r.Type.isNull(this._requisitesConfig)){this._tooltip=N.create(this._id+"_client_requisite_details",{readonly:this._readonly,canChangeDefaultRequisite:this._canChangeDefaultRequisite,presets:this.getRequisitesPresetList()})}this._requisiteEditor=p.create(this._id+"_rq_editor",{entityTypeId:this._entityInfo.getTypeId(),entityId:this._entityInfo.getId(),contextId:BX.prop.getString(i,"contextId",""),requisiteEditUrl:this._requisiteEditUrl});this._requisiteEditor.setRequisiteList(this._requisiteList);l.EventEmitter.subscribe(this._requisiteEditor,"onAfterEditRequisite",this.onRequisiteEditorAfterEdit.bind(this));l.EventEmitter.subscribe(this._requisiteEditor,"onAfterDeleteRequisite",this.onRequisiteEditorAfterDelete.bind(this));if(this._tooltip){l.EventEmitter.subscribe(this._tooltip,"onAddRequisite",this.onEditNewRequisite.bind(this));l.EventEmitter.subscribe(this._tooltip,"onEditRequisite",this.onEditExistedRequisite.bind(this));l.EventEmitter.subscribe(this._tooltip,"onDeleteRequisite",this.onDeleteRequisite.bind(this));l.EventEmitter.subscribe(this._tooltip,"onAddBankDetails",this.onAddBankDetails.bind(this));l.EventEmitter.subscribe(this._tooltip,"onSetSelectedRequisite",this.onSetSelectedRequisite.bind(this));l.EventEmitter.subscribe(this._tooltip,"onShow",this.onShowTooltip.bind(this))}}},{key:"setEntity",value:function e(t,i){this._entityInfo=t;if(this._entityInfo.hasEditRequisiteData()){this._requisiteList=c.create(this._entityInfo.getRequisites())}if(i){this.onChangeRequisiteList()}}},{key:"addressLayout",value:function e(t){if(!r.Type.isDomNode(t)){return}this._addressContainer=r.Tag.render(Z());r.Dom.append(this._addressContainer,t);this.doAddressLayout()}},{key:"doAddressLayout",value:function e(){if(!r.Type.isDomNode(this._addressContainer)){return}r.Dom.clean(this._addressContainer);if(!r.Type.isNull(this._addressConfig)){if(this._entityInfo.hasEditRequisiteData()){var t=this._requisiteList.getSelected();var i=t?t.getAddressList():null;if(!r.Type.isNull(i)&&Object.keys(i).length){this._addressField=o.EntityEditorBaseAddressField.create(this._entityInfo.getId(),{showFirstItemOnly:true});this._addressField.setMultiple(true);this._addressField.setTypesList(BX.prop.getObject(this._addressConfig,"types",{}));this._addressField.setValue(i);r.Dom.append(this._addressField.layout(false),this._addressContainer)}}else{var s=r.Tag.render(J(),this.onLoadAddressMouseUp.bind(this),r.Loc.getMessage("CLIENT_REQUISITES_ADDRESS_SHOW_ADDRESS"));r.Dom.append(s,this._addressContainer)}}}},{key:"showTooltip",value:function e(t){if(!this._tooltip){return}if(this._entityInfo.hasEditRequisiteData()){this._tooltip.setRequisites(this._requisiteList);if(this.isRequisiteAddressOnly()){return}}this._tooltip.setBindElement(t,this._formElement);this._tooltip.showDebounced()}},{key:"closeTooltip",value:function e(){if(!this._tooltip){return}this._tooltip.closeDebounced();this._tooltip.cancelShowDebounced();this._showTooltipOnEntityLoad=false}},{key:"release",value:function e(){if(this._addressField){this._addressField.release()}if(this._tooltip){this._tooltip.close();this._tooltip.removeDebouncedEvents()}}},{key:"loadEntity",value:function e(){if(!this._loaderConfig){return}if(r.Type.isDomNode(this._addressContainer)){var t=new a.Loader({size:19,mode:"inline"});r.Dom.clean(this._addressContainer);t.show(this._addressContainer)}BX.CrmDataLoader.create(this._id,{serviceUrl:this._loaderConfig["url"],action:this._loaderConfig["action"],params:{ENTITY_TYPE_NAME:this._entityInfo.getTypeName(),ENTITY_ID:this._entityInfo.getId(),NORMALIZE_MULTIFIELDS:"Y"}}).load(this.onEntityInfoLoad.bind(this))}},{key:"getRequisitesPresetList",value:function e(){if(r.Type.isNull(this._requisitesConfig)){return[]}var t=[];var i=G(BX.prop.getArray(this._requisitesConfig,"presets")),s;try{for(i.s();!(s=i.n()).done;){var n=s.value;var a=BX.prop.getString(n,"VALUE",0);var o=BX.prop.getString(n,"NAME",a);t.push({name:o,value:a})}}catch(e){i.e(e)}finally{i.f()}return t}},{key:"deleteRequisite",value:function e(t){if(this._tooltip){this._tooltip.removeDebouncedEvents();this._tooltip.close()}this._requisiteEditor.deleteRequisite(t)}},{key:"isRequisiteAddressOnly",value:function e(){var t=this._requisiteList.getList();return t.length===1&&t[0].isAddressOnly()}},{key:"onLoadAddressMouseUp",value:function e(t){t.stopPropagation();this.loadEntity()}},{key:"onEntityInfoLoad",value:function e(t,i){var s=BX.prop.getObject(i,"DATA",null);if(s){this.setEntity(BX.CrmEntityInfo.create(s),true);if(this._tooltip&&this._showTooltipOnEntityLoad){if(!this.isRequisiteAddressOnly()){this._tooltip.show()}this._showTooltipOnEntityLoad=false}}}},{key:"onEditNewRequisite",value:function e(t){var i=t.getData();i.selected=this._requisiteList.isEmpty();var s=f.create(null,{newRequisiteId:this._requisiteList.getNewRequisiteId(),newRequisiteExtraFields:i});s.setRequisiteId(this._requisiteList.getNewRequisiteId());this._requisiteEditor.open(s)}},{key:"onEditExistedRequisite",value:function e(t){var i=t.getData();var s=this._requisiteList.getById(i.id);if(s){this._requisiteEditor.open(s,{})}}},{key:"onDeleteRequisite",value:function e(t){var i=this;var s=t.getData();BX.Crm.EditorAuxiliaryDialog.create("delete_requisite_confirmation",{title:r.Loc.getMessage("REQUISITE_LIST_ITEM_DELETE_CONFIRMATION_TITLE"),content:r.Loc.getMessage("REQUISITE_LIST_ITEM_DELETE_CONFIRMATION_CONTENT"),buttons:[{id:"yes",type:BX.Crm.DialogButtonType.accept,text:r.Loc.getMessage("CRM_EDITOR_YES"),callback:function e(t){t.getDialog().close();i.deleteRequisite(s.id)}},{id:"no",type:BX.Crm.DialogButtonType.cancel,text:r.Loc.getMessage("CRM_EDITOR_NO"),callback:function e(t){t.getDialog().close()}}]}).open()}},{key:"onAddBankDetails",value:function e(t){var i=t.getData();var s=this._requisiteList.getById(i.requisiteId);if(s){this._requisiteEditor.open(s,{addBankDetailsItem:true})}}},{key:"onSetSelectedRequisite",value:function e(t){var i=t.getData();this._requisiteList.setSelected(i.id,i.bankDetailId);var s=this._requisiteList.getSelected();if(s){var n=s.getBankDetailById(s.getSelectedBankDetailId());var a=r.Type.isNull(n)?0:n.id;l.EventEmitter.emit(this,"onSetSelectedRequisite",{requisiteId:s.getRequisiteId(),bankDetailId:a})}}},{key:"onRequisiteEditorAfterEdit",value:function e(t){this.onChangeRequisiteList()}},{key:"onRequisiteEditorAfterDelete",value:function e(t){this.onChangeRequisiteList()}},{key:"onChangeRequisiteList",value:function e(){this.doAddressLayout();if(this._tooltip){this._tooltip.setRequisites(this._requisiteList);this._tooltip.setLoading(false)}this._requisiteEditor.setRequisiteList(this._requisiteList);var t=this._requisiteList?this._requisiteList.exportToModel():null;this._entityInfo.setRequisites(t);l.EventEmitter.emit(this,"onChangeRequisiteList",{entityTypeName:this._entityInfo.getTypeName(),entityId:this._entityInfo.getId(),requisites:this._requisiteList.exportToModel()})}},{key:"onShowTooltip",value:function e(){if(!this._entityInfo.hasEditRequisiteData()){if(this._tooltip){this._tooltip.close();this._showTooltipOnEntityLoad=true}this.loadEntity()}else if(this.isRequisiteAddressOnly()){this._tooltip.close()}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}();e.EntityEditorRequisiteField=Y;e.EntityEditorRequisiteAddressField=z;e.EntityEditorRequisiteController=R;e.EntityEditorClientRequisites=ee})(this.BX.Crm=this.BX.Crm||{},BX.Crm,BX.Main,BX.UI.Dialogs,BX.Crm,BX,BX,BX.Crm,BX.Event);
//# sourceMappingURL=requisite.bundle.map.js