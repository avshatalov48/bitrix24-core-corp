this.BX=this.BX||{};(function(e,t,n,i,a,s){"use strict";var r,l,o,c,u,d,p,h,m,f;var y=function(e){babelHelpers.inherits(i,e);function i(){var e;babelHelpers.classCallCheck(this,i);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this));e.setEventNamespace("BX.Crm.Requisite.Autocomplete");e._id="";e._settings={};e._placeholderText=null;e._isLoading=false;e._isEnabled=false;e._context={};e._currentItem=null;e._domNodes={};e._dropdown=null;e.currentSearchQueryText="";e.detailAutocompletePlacement=null;e.entitySearchPopupCloseHandler=null;e.placementsParamsHandler=null;e.searchQueryInputHandler=null;e.beforeAddPlacementItemsHandler=null;e.placementSearchParamsHandler=null;e.placementSetFoundItemsHandler=null;e.placementEntitySelectHandler=null;e.externalSearchHandler=null;e.externalSearchResultHandlerList=null;e.beforeEntitySearchPopupCloseHandler=null;e.onDocumentClickConfirm=null;e.creatingItem=null;e.clientResolverPlacementParams=null;return e}babelHelpers.createClass(i,[{key:"initialize",value:function e(t,n){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._settings=n?n:{};this._placeholderText=BX.prop.getString(this._settings,"placeholderText","");this._context=BX.prop.getObject(this._settings,"context",{});this._isEnabled=BX.prop.getBoolean(this._settings,"enabled",false);this._featureRestrictionCallback=BX.prop.getString(this._settings,"featureRestrictionCallback","");this._isPermitted=this._featureRestrictionCallback==="";this._showFeedbackLink=this._isPermitted?BX.prop.getBoolean(this._settings,"showFeedbackLink",false):false;this.clientResolverPlacementParams=this.filterclientResolverPlacementParams(BX.prop.getObject(this._settings,"clientResolverPlacementParams",null));this.externalSearchHandler=this.onExternalSearch.bind(this);this.externalSearchResultHandlerList=new Map;this.doInitialize()}},{key:"filterclientResolverPlacementParams",value:function e(n){if(!t.Type.isObject(n)){return null}return{isPlacement:BX.prop.getBoolean(n,"isPlacement",false),numberOfPlacements:BX.prop.getInteger(n,"numberOfPlacements",0),countryId:BX.prop.getInteger(n,"countryId",0),defaultAppInfo:BX.prop.getObject(n,"defaultAppInfo",{})}}},{key:"doInitialize",value:function e(){}},{key:"layout",value:function e(n){if(!t.Type.isDomNode(n)){return}this._domNodes.requisiteClearButton=t.Tag.render(r||(r=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<button class="ui-ctl-after ui-ctl-icon-clear" onclick="','"></button>'])),this.onSearchStringClear.bind(this));this._domNodes.requisiteSearchButton=t.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<button class="ui-ctl-after ui-ctl-icon-search" onclick="','"></button>'])),this.onSearchButtonClick.bind(this));var i=this._placeholderText;this._domNodes.requisiteSearchString=t.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="text" placeholder="','" class="ui-ctl-element ui-ctl-textbox" />'])),t.Text.encode(i));if(!this._isPermitted){this._domNodes.requisiteSearchString.setAttribute("onclick",this._featureRestrictionCallback)}this.refreshLayout();t.Dom.append(t.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="ui-ctl ui-ctl-w100 ui-ctl-after-icon">\n\t\t\t',"\n\t\t\t","\n\t\t\t","\n\t\t</div>"])),this._domNodes.requisiteSearchButton,this._domNodes.requisiteClearButton,this._domNodes.requisiteSearchString),n);this.initDropdown();this.refreshLayout()}},{key:"initDropdown",value:function e(){if(!this._dropdown){var i=BX.prop.getBoolean(this.clientResolverPlacementParams,"isPlacement",false);this._dropdown=new v({isDisabled:!this._isPermitted,searchAction:BX.prop.getString(this._settings,"searchAction",""),externalSearchHandler:i?this.externalSearchHandler:null,items:[],enableCreation:true,enableCreationOnBlur:true,autocompleteDelay:1500,messages:{creationLegend:t.Loc.getMessage("REQUISITE_AUTOCOMPLETE_ADD_REQUISITE"),notFound:t.Loc.getMessage("REQUISITE_AUTOCOMPLETE_NOT_FOUND")},placementParams:this.clientResolverPlacementParams});n.EventEmitter.subscribe(this._dropdown,"BX.UI.Dropdown:onSelect",this.onEntitySelect.bind(this));n.EventEmitter.subscribe(this._dropdown,"BX.UI.Dropdown:onAdd",this.onEntityAdd.bind(this));n.EventEmitter.subscribe(this._dropdown,"BX.UI.Dropdown:onReset",this.onEntityReset.bind(this));n.EventEmitter.subscribe(this._dropdown,"BX.UI.Dropdown:onBeforeSearchStart",this.onEntitySearchStart.bind(this));n.EventEmitter.subscribe(this._dropdown,"BX.UI.Dropdown:onSearchComplete",this.onEntitySearchComplete.bind(this));BX.addCustomEvent(this._dropdown,"Dropdown:onGetPopupAlertContainer",this.onGetPopupAlertContainer.bind(this));BX.addCustomEvent(this._dropdown,"Dropdown:onAfterInstallDefaultApp",this.onAfterInstallDefaultApp.bind(this))}this._dropdown.searchOptions=this._context;this._dropdown.targetElement=this._domNodes.requisiteSearchString;this._dropdown.init();this.setEnabled(this._isEnabled);this.setShowFeedbackLink(this._showFeedbackLink)}},{key:"getDropdownPopup",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(t){return this._dropdown.getPopupWindow()}return this._dropdown.popupWindow}},{key:"closeDropdownPopup",value:function e(){var t=this.getDropdownPopup();if(t){t.close()}}},{key:"setCurrentItem",value:function e(n){this._currentItem=t.Type.isPlainObject(n)?n:null;this.refreshLayout()}},{key:"setShowFeedbackLink",value:function e(t){this._showFeedbackLink=!!t;if(this._dropdown){this._dropdown.setFeedbackFormParams(this._showFeedbackLink?BX.prop.getObject(this._settings,"feedbackFormParams",{}):{})}}},{key:"refreshLayout",value:function e(){if(!t.Type.isDomNode(this._domNodes.requisiteSearchString)||!t.Type.isDomNode(this._domNodes.requisiteSearchButton)||!t.Type.isDomNode(this._domNodes.requisiteClearButton)){return}var n="";if(t.Type.isObject(this._currentItem)&&this._isPermitted){var i=[this._currentItem.title];if(t.Type.isStringFilled(this._currentItem.subTitle)){i.push(this._currentItem.subTitle)}n=i.join(", ");t.Dom.style(this._domNodes.requisiteSearchButton,"display","none");t.Dom.style(this._domNodes.requisiteClearButton,"display","");if(this._dropdown){this._dropdown.setCanAddRequisite(false)}}else{t.Dom.style(this._domNodes.requisiteClearButton,"display","none");if(this._isEnabled||!this._isPermitted){t.Dom.style(this._domNodes.requisiteSearchButton,"display","")}else{t.Dom.style(this._domNodes.requisiteSearchButton,"display","none")}if(this._dropdown){this._dropdown.setCanAddRequisite(this._isPermitted&&BX.prop.getBoolean(this._settings,"canAddRequisite",false))}}this._domNodes.requisiteSearchString.value=n;this.onSearchQueryInput();this.setLoading(false)}},{key:"getState",value:function e(){return{currentItem:this._currentItem,searchQuery:t.Type.isDomNode(this._domNodes.requisiteSearchString)?this._domNodes.requisiteSearchString.value:null,items:t.Type.isObject(this._dropdown)?this._dropdown.getItems():[]}}},{key:"setState",value:function e(n){if(!t.Type.isPlainObject(n)){return}this.setCurrentItem(t.Type.isPlainObject(n.currentItem)?n.currentItem:null);if(t.Type.isString(n.searchQuery)&&t.Type.isDomNode(this._domNodes.requisiteSearchString)&&this._isPermitted){this._domNodes.requisiteSearchString.value=n.searchQuery;this.onSearchQueryInput()}if(t.Type.isArray(n.items)){this._dropdown.setItems(n.items)}}},{key:"setContext",value:function e(n){this._context=t.Type.isPlainObject(n)?n:{};if(this._dropdown){this._dropdown.searchOptions=this._context}}},{key:"setPlaceholderText",value:function e(n){this._placeholderText=t.Type.isStringFilled(n)?n:"";if(t.Type.isDomNode(this._domNodes.requisiteSearchString)){this._domNodes.requisiteSearchString.placeholder=this._placeholderText}}},{key:"setClientResolverPlacementParams",value:function e(t){this.clientResolverPlacementParams=this.filterclientResolverPlacementParams(t);if(this._dropdown){this._dropdown.setPlacementParams(this.clientResolverPlacementParams);var n=BX.prop.getBoolean(this.clientResolverPlacementParams,"isPlacement",false);if(n){this._dropdown.setExternalSearchHandler(this.externalSearchHandler)}}}},{key:"setEnabled",value:function e(t){this._isEnabled=!!t;if(this._dropdown){this._dropdown.setMinSearchStringLength(this._isEnabled?3:99999)}}},{key:"setLoading",value:function e(n){n=!!n;if(n===this._isLoading){return}this._isLoading=n;var i=this._domNodes.requisiteSearchButton;if(t.Type.isDomNode(i)){if(n){i.classList.remove("ui-ctl-icon-search");i.classList.add("ui-ctl-icon-loader")}else{i.classList.remove("ui-ctl-icon-loader");i.classList.add("ui-ctl-icon-search")}}var a=this._domNodes.requisiteClearButton;if(t.Type.isDomNode(a)){if(n){a.classList.remove("ui-ctl-icon-clear");a.classList.add("ui-ctl-icon-loader")}else{a.classList.remove("ui-ctl-icon-loader");a.classList.add("ui-ctl-icon-clear")}}}},{key:"onSearchStringClear",value:function e(){this.emit("onClear")}},{key:"onSearchButtonClick",value:function e(){if(t.Type.isObject(this._dropdown)){this._dropdown.handleTypeInField()}}},{key:"onEntitySelect",value:function e(t){var n=t.getData();var i=n[0];var a=n[1];if(i===this._dropdown&&a["appSid"]&&!a["created"]){if(!this.creatingItem){this.creatingItem=a;a._loader=new BX.Loader({target:a.node,size:40});a.node.classList.add("client-editor-active");a.node.parentNode.classList.add("client-editor-inactive");a._loader.show();BX.onCustomEvent(this.detailAutocompletePlacement,"Placements:pick",[{appSid:a["appSid"],data:a}])}return}this.selectEntity(a)}},{key:"selectEntity",value:function e(t){if(this.creatingItem){for(var n in t){if(t.hasOwnProperty(n)){this.creatingItem[n]=t[n]}}this.creatingItem["created"]=true;this.creatingItem=null;this._dropdown.setItems([])}if(this.onDocumentClickConfirm){this.onDocumentClickConfirm.close();this.onDocumentClickConfirm=null}this.closeDropdownPopup();this.setCurrentItem(t);this.emit("onSelectValue",t)}},{key:"onEntityAdd",value:function e(t){var n=t.getData();var i=n[0];i.getPopupWindow().close();this.emit("onCreateNewItem")}},{key:"onEntityReset",value:function e(){this.setCurrentItem(null)}},{key:"onEntitySearchStart",value:function e(){this.setLoading(true);this._dropdown.setItems([])}},{key:"onExternalSearch",value:function e(){var n=this;return new Promise((function(e){if(n.detailAutocompletePlacement){var i={appId:0};BX.onCustomEvent(n.detailAutocompletePlacement,"Placements:startDefaultSearch",[i]);if(t.Type.isInteger(i["appId"])&&i["appId"]>0){if(!n.externalSearchResultHandlerList.has(i["appId"])){n.externalSearchResultHandlerList.set(i["appId"],(function(t){e(t)}))}return}}e([])}))}},{key:"initPlacement",value:function e(n,i){if(!this.detailAutocompletePlacement){var s=t.Type.isPlainObject(this.clientResolverPlacementParams)&&this.clientResolverPlacementParams.hasOwnProperty("numberOfPlacements")&&t.Type.isNumber(this.clientResolverPlacementParams["numberOfPlacements"])&&this.clientResolverPlacementParams["numberOfPlacements"]>0;if(s){this.detailAutocompletePlacement=new a.DetailSearch("CRM_REQUISITE_AUTOCOMPLETE")}if(this.detailAutocompletePlacement){var r=this.getDropdownPopup(true);if(r){this.beforeEntitySearchPopupCloseHandler=this.onBeforeEntitySearchPopupClose.bind(this,r._tryCloseByEvent.bind(r));r._tryCloseByEvent=this.beforeEntitySearchPopupCloseHandler;this.entitySearchPopupCloseHandler=this.onEntitySearchPopupClose.bind(this);BX.addCustomEvent(r,"onPopupClose",this.entitySearchPopupCloseHandler);r.show()}this.placementsParamsHandler=this.onPlacementsParams.bind(this);BX.addCustomEvent(this.detailAutocompletePlacement,"Placements:params",this.placementsParamsHandler);this.beforeAddPlacementItemsHandler=this.onBeforeAppendPlacementItems.bind(this);BX.addCustomEvent(this.detailAutocompletePlacement,"Placements:beforeAppendItems",this.beforeAddPlacementItemsHandler);this.placementSearchParamsHandler=this.onPlacamentSearchParams.bind(this);BX.addCustomEvent(this.detailAutocompletePlacement,"Placements:searchParams",this.placementSearchParamsHandler);this.placementSetFoundItemsHandler=this.onPlacementSetFoundItems.bind(this);BX.addCustomEvent(this.detailAutocompletePlacement,"Placements:setFoundItems",this.placementSetFoundItemsHandler);this.placementEntitySelectHandler=this.onPlacementEntitySelect.bind(this);BX.addCustomEvent(this.detailAutocompletePlacement,"Placements:select",this.placementEntitySelectHandler);this.detailAutocompletePlacement.show(i,i.querySelector("div.crm-rq-popup-item-add-new"),{hideLoader:true})}if(t.Type.isDomNode(this._domNodes.requisiteSearchString)){if(!this.searchQueryInputHandler){this.searchQueryInputHandler=this.onSearchQueryInput.bind(this)}this._domNodes.requisiteSearchString.addEventListener("input",this.searchQueryInputHandler);this._domNodes.requisiteSearchString.addEventListener("keyup",this.searchQueryInputHandler)}}}},{key:"onSearchQueryInput",value:function e(){if(this._domNodes.requisiteSearchString.value!==this.currentSearchQueryText){this.currentSearchQueryText=this._domNodes.requisiteSearchString.value;this.fireChangeSearchQueryEvent()}}},{key:"fireChangeSearchQueryEvent",value:function e(){if(this.detailAutocompletePlacement&&t.Type.isDomNode(this._domNodes.requisiteSearchString)){BX.onCustomEvent(this.detailAutocompletePlacement,"Placements:changeQuery",[{currentSearchQuery:this._domNodes.requisiteSearchString.value}])}}},{key:"onEntitySearchComplete",value:function e(){this.setLoading(false)}},{key:"onGetPopupAlertContainer",value:function e(t,n){this.initPlacement(t,n)}},{key:"onAfterInstallDefaultApp",value:function e(t){this.emit("onInstallDefaultApp")}},{key:"onBeforeEntitySearchPopupClose",value:function e(t,n){if(this.onDocumentClickConfirm){return BX.eventReturnFalse(n)}var i={active:false};BX.onCustomEvent(this.detailAutocompletePlacement,"Placements:active",[i]);if(i.active){BX.unbind(document,"click",this._dropdown.documentClickHandler);var a=function(e,t){BX.bind(document,"click",this._dropdown.documentClickHandler);e.close();this.onDocumentClickConfirm=null;BX.eventCancelBubble(t)}.bind(this);this.onDocumentClickConfirm=s.MessageBox.create({message:BX.message("CRM_EDITOR_PLACEMENT_CAUTION")||"Dow you want to terminate process?",buttons:s.MessageBoxButtons.OK_CANCEL,modal:true,onOk:function(e,n,i){a(e,i);this._dropdown.documentClickHandler(i);t(i)}.bind(this),onCancel:function e(t,n,i){a(t,i)}});BX.eventCancelBubble(n);this.onDocumentClickConfirm.show();return BX.eventReturnFalse(n)}t(n)}},{key:"onEntitySearchPopupClose",value:function e(){this.destroyPlacement()}},{key:"destroyPlacement",value:function e(){if(this.searchQueryInputHandler){this._domNodes.requisiteSearchString.removeEventListener("input",this.searchQueryInputHandler);this._domNodes.requisiteSearchString.removeEventListener("keyup",this.searchQueryInputHandler);this.searchQueryInputHandler=null}if(this._dropdown&&this._dropdown.hasOwnProperty("documentClickHandler")){BX.unbind(document,"click",this._dropdown.documentClickHandler)}if(this.detailAutocompletePlacement){var t=this.getDropdownPopup();if(t){BX.removeCustomEvent(t,"onPopupClose",this.entitySearchPopupCloseHandler)}this.entitySearchPopupCloseHandler=null;BX.onCustomEvent(this.detailAutocompletePlacement,"Placements:destroy");BX.removeCustomEvent(this.detailAutocompletePlacement,"Placements:params",this.placementsParamsHandler);this.placementsParamsHandler=null;BX.removeCustomEvent(this.detailAutocompletePlacement,"Placements:beforeAppendItems",this.beforeAddPlacementItemsHandler);this.beforeAddPlacementItemsHandler=null;BX.removeCustomEvent(this.detailAutocompletePlacement,"Placements:searchParams",this.placementSearchParamsHandler);this.placementSearchParamsHandler=null;BX.removeCustomEvent(this.detailAutocompletePlacement,"Placements:setFoundItems",this.placementSetFoundItemsHandler);this.placementSetFoundItemsHandler=null;BX.removeCustomEvent(this.detailAutocompletePlacement,"Placements:select",this.placementEntitySelectHandler);this.placementEntitySelectHandler=null;this.detailAutocompletePlacement=null;this.creatingItem=null;this._dropdown.setItems([])}}},{key:"onPlacementsParams",value:function e(n){if(t.Type.isObject(n)){if(this._dropdown){this._dropdown.setPlacementParams(this.clientResolverPlacementParams)}if(this.clientResolverPlacementParams){if(n.hasOwnProperty("placementParams")){n["placementParams"]=this.clientResolverPlacementParams}if(n.hasOwnProperty("currentSearchQuery")){n["currentSearchQuery"]=this._domNodes.requisiteSearchString.value}}}}},{key:"onBeforeAppendPlacementItems",value:function e(){var t=this.getDropdownPopup();if(t){BX.addClass(t.popupContainer,"client-editor-popup")}}},{key:"onPlacamentSearchParams",value:function e(t){t["searchQuery"]=this._domNodes.requisiteSearchString.value}},{key:"onPlacementSetFoundItems",value:function e(t,n){var i=[];n.forEach(function(e){i.push({id:e.id,title:e.name,appSid:t["appSid"],module:"crm",subModule:"rest",subTitle:t["title"],attributes:{phone:e.phone?[{value:e.phone}]:"",email:e.email?[{value:e.email}]:"",web:e.web?[{value:e.web}]:""}})}.bind(this));var a=parseInt(t["placementInfo"]["id"]);if(a>0&&this.externalSearchResultHandlerList.has(a)){this.externalSearchResultHandlerList.get(a)(i);this.externalSearchResultHandlerList["delete"](a)}else{this._dropdown.setItems(i)}}},{key:"onPlacementEntitySelect",value:function e(n){var i={type:n["entityType"],id:n["id"],title:n["title"],fields:n["fields"]};if(t.Type.isPlainObject(i["fields"])&&i["fields"].hasOwnProperty("RQ_ADDR")&&t.Type.isPlainObject(i["fields"]["RQ_ADDR"])){var a=function(e){var t=BX.prop.getString(e,"status","");var n=BX.prop.getObject(e,"data",{});var a=[];if(t==="error"){var s=BX.prop.getArray(e,"errors",[]);for(var r=0;r<s.length;r++){a.push(BX.prop.getString(s[r],"message"))}}if(a.length>0){BX.UI.Notification.Center.notify({content:a.join("<br>"),position:"top-center",autoHideDelay:1e4});delete i["fields"]["RQ_ADDR"]}else{i["fields"]["RQ_ADDR"]=n}this.selectEntity(i)}.bind(this);BX.ajax.runAction("crm.requisite.address.getLocationAddressJsonByFields",{data:{addresses:i["fields"]["RQ_ADDR"]}}).then(a,a)}else{this.selectEntity(i)}}}],[{key:"create",value:function e(t,n){var a=new i;a.initialize(t,n);return a}}]);return i}(n.EventEmitter);var v=function(e){babelHelpers.inherits(n,e);function n(e){var t;babelHelpers.classCallCheck(this,n);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this,e));t.feedbackFormParams=BX.prop.getObject(e,"feedbackFormParams",{});t.canAddRequisite=BX.prop.getBoolean(e,"canAddRequisite",false);t.externalSearchHandler=BX.prop.getFunction(e,"externalSearchHandler",null);t.placementParams=BX.prop.getObject(e,"placementParams",{});t.installDefaultAppHandler=t.onClickInstallDefaultApp.bind(babelHelpers.assertThisInitialized(t));t.installDefaultAppTimeout=7e3;t.afterInstallDefaultAppHandler=t.onAfterInstallDefaultApp.bind(babelHelpers.assertThisInitialized(t));t.popupAlertContainer=null;t.defaultAppInstallLoader=null;t.isDefaultAppInstalled=false;return t}babelHelpers.createClass(n,[{key:"setPlacementParams",value:function e(t){this.placementParams=t}},{key:"setExternalSearchHandler",value:function e(t){this.externalSearchHandler=t}},{key:"isTargetElementChanged",value:function e(){return false}},{key:"getItemsListContainer",value:function e(){if(!this.itemListContainer){this.itemListContainer=BX.create("div",{attrs:{className:"ui-dropdown-container rq-dropdown-container"}})}return this.itemListContainer}},{key:"setFeedbackFormParams",value:function e(n){this.feedbackFormParams=t.Type.isPlainObject(n)?n:{}}},{key:"setCanAddRequisite",value:function e(t){this.canAddRequisite=!!t}},{key:"setMinSearchStringLength",value:function e(t){this.minSearchStringLength=t}},{key:"getDefaultAppInfo",value:function e(){return BX.prop.getObject(this.placementParams,"defaultAppInfo",{})}},{key:"isDefaultAppCanInstall",value:function e(){var n=this.getDefaultAppInfo();return t.Type.isStringFilled(BX.prop.get(n,"code",""))&&t.Type.isStringFilled(BX.prop.get(n,"title",""))&&BX.prop.get(n,"isAvailable","N")==="Y"}},{key:"getPopupAlertContainer",value:function e(){if(!this.popupAlertContainer){var n=[];if(this.isDefaultAppCanInstall()){var i=t.Text.encode(this.getDefaultAppInfo()["title"]);var a=t.Text.encode(t.Loc.getMessage("REQUISITE_AUTOCOMPLETE_INSTALL"));n.push(t.Tag.render(u||(u=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="crm-rq-popup-item crm-rq-popup-item-add-new">\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tclass="crm-rq-popup-item-add-inst-app-btn"><span></span><span\n\t\t\t\t\t\t\t\tclass="crm-rq-popup-item-add-new-btn-text"><span>','</span><span\n\t\t\t\t\t\t\t\tstyle="margin-left: 20px; width: 100px;"><a\n\t\t\t\t\t\t\t\t\thref="#"\n\t\t\t\t\t\t\t\t\tonclick="','">',"</a>\n\t\t\t\t\t\t\t</span></span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>"])),i,this.installDefaultAppHandler,a))}var s=Object.keys(this.getFeedbackFormParams()).length>0;if(s){var r=t.Loc.getMessage("REQUISITE_AUTOCOMPLETE_ADVICE_NEW_SERVICE").split("#ADVICE_NEW_SERVICE_LINK#");var l=t.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['<div class="crm-rq-popup-item crm-rq-popup-item-helper"></div>'])));if(r[0]&&r[0].length){t.Dom.append(document.createTextNode(r[0]),l)}var o=t.Loc.getMessage("REQUISITE_AUTOCOMPLETE_ADVICE_NEW_SERVICE_LINK");t.Dom.append(t.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['<a href="" onclick="','">',"</a>"])),this.showFeedbackForm.bind(this),o),l);if(r[1]&&r[1].length){t.Dom.append(document.createTextNode(r[1]),l)}n.push(l)}if(this.canAddRequisite){n.push(t.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="crm-rq-popup-item crm-rq-popup-item-add-new">\n\t\t\t\t\t\t<button class="crm-rq-popup-item-add-new-btn">\n\t\t\t\t\t\t\t<span class="ui-btn crm-rq-btn ui-btn-icon-custom ui-btn-primary ui-btn-round"\n\t\t\t\t\t\t\t\tonclick="','"></span>\n\t\t\t\t\t\t\t<span class="crm-rq-popup-item-add-new-btn-text"\n\t\t\t\t\t\t\t\tonclick="','"\n\t\t\t\t\t\t\t\t>',"</span>\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>"])),this.onEmptyValueEvent.bind(this),this.onEmptyValueEvent.bind(this),BX.prop.getString(this.messages,"creationLegend")))}this.popupAlertContainer=n.length?t.Tag.render(m||(m=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-rq-popup-wrapper">\n\t\t\t\t\t<div class="crm-rq-popup-items-list">',"</div>\n\t\t\t\t</div>\n\t\t\t"])),n):t.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(["<div></div>"])));BX.onCustomEvent(this,"Dropdown:onGetPopupAlertContainer",[this,this.popupAlertContainer])}this.togglePopupAlertVisibility();return this.popupAlertContainer}},{key:"getTargetElementValue",value:function e(){if(this.targetElement!=="undefined"&&t.Type.isStringFilled(this.targetElement["value"])){return this.targetElement["value"].trim()}return""}},{key:"togglePopupAlertVisibility",value:function e(){if(t.Type.isDomNode(this.popupAlertContainer)){var n=BX.prop.getInteger(this.placementParams,"numberOfPlacements",0);var i=n>0||this.getItems().length<=0;this.popupAlertContainer.style.display=i?"":"none"}}},{key:"setItems",value:function e(t){babelHelpers.get(babelHelpers.getPrototypeOf(n.prototype),"setItems",this).call(this,[{id:1,name:"N",title:"T"}]);this.togglePopupAlertVisibility();babelHelpers.get(babelHelpers.getPrototypeOf(n.prototype),"setItems",this).call(this,t)}},{key:"getNewAlertContainer",value:function e(){return null}},{key:"disableTargetElement",value:function e(){}},{key:"getFeedbackFormParams",value:function e(){return this.feedbackFormParams}},{key:"showFeedbackForm",value:function e(t){t.preventDefault();this.getPopupWindow().close();if(!this._feedbackForm){this._feedbackForm=new BX.UI.Feedback.Form(this.getFeedbackFormParams())}this._feedbackForm.openPanel()}},{key:"searchItemsByStr",value:function e(t){if(this.externalSearchHandler){return this.externalSearchHandler().then((function(e){return e}))}return babelHelpers.get(babelHelpers.getPrototypeOf(n.prototype),"searchItemsByStr",this).call(this,t)}},{key:"onClickInstallDefaultApp",value:function e(n){var i=this;n.stopPropagation();n.preventDefault();if(this.defaultAppInstallLoader){return}if(t.Type.isDomNode(n.target)&&t.Type.isDomNode(n.target.parentNode)){var a=n.target.parentNode;t.Dom.hide(n.target);this.defaultAppInstallLoader=this.defaultAppInstallLoader||new BX.Loader({target:a,size:30,offset:{top:"-23px"}});this.defaultAppInstallLoader.show()}if(this.isDefaultAppCanInstall()){this.isDefaultAppInstalled=false;BX.loadExt("marketplace").then((function(){setTimeout((function(){if(!i.isDefaultAppInstalled){i.finalInstallDefaultApp()}}),i.installDefaultAppTimeout);top.BX.addCustomEvent(top,"Rest:AppLayout:ApplicationInstall",i.afterInstallDefaultAppHandler);BX.rest.Marketplace.install({CODE:i.placementParams["defaultAppInfo"]["code"],SILENT_INSTALL:"Y",DO_NOTHING:"Y"})}))["catch"]((function(){top.BX.removeCustomEvent(top,"Rest:AppLayout:ApplicationInstall",i.afterInstallDefaultAppHandler)}))}}},{key:"wait",value:function e(t){return new Promise((function(e){return setTimeout(e,parseInt(t))}))}},{key:"checkDefAppHandler",value:function e(){var n=BX.prop.getInteger(this.placementParams,"countryId",0);return new Promise((function(e,i){BX.ajax.runAction("crm.requisite.autocomplete.checkDefaultAppHandler",{data:{countryId:n}}).then((function(n){if(t.Type.isPlainObject(n)&&n.hasOwnProperty("data")&&n.hasOwnProperty("status")&&n["status"]==="success"&&t.Type.isBoolean(n["data"])&&n["data"]){e()}else{i()}}))}))}},{key:"awaitHandler",value:function e(t){var n=this;this.wait(t.waitTime).then((function(){n.checkDefAppHandler().then((function(){n.finalInstallDefaultAppSuccess()}))["catch"]((function(){if(--t.numberOfTimes>0){n.awaitHandler(t)}else{n.finalInstallDefaultApp()}}))}))}},{key:"onAfterInstallDefaultApp",value:function e(t,n){this.isDefaultAppInstalled=true;top.BX.removeCustomEvent(top,"Rest:AppLayout:ApplicationInstall",this.afterInstallDefaultAppHandler);var i=3;var a=Math.floor(this.installDefaultAppTimeout/i);if(!!t){this.awaitHandler({waitTime:a,numberOfTimes:3})}else{this.finalInstallDefaultApp()}}},{key:"finalInstallDefaultAppSuccess",value:function e(){BX.onCustomEvent(this,"Dropdown:onAfterInstallDefaultApp",[this]);this.finalInstallDefaultApp()}},{key:"finalInstallDefaultApp",value:function e(){if(this.defaultAppInstallLoader){this.defaultAppInstallLoader.destroy();this.defaultAppInstallLoader=null}if(this.popupWindow){this.popupWindow.close()}}}]);return n}(BX.UI.Dropdown);e.RequisiteAutocompleteField=y})(this.BX.Crm=this.BX.Crm||{},BX,BX.Event,BX,BX.Crm.Placement,BX.UI.Dialogs);
//# sourceMappingURL=autocomplete.bundle.map.js