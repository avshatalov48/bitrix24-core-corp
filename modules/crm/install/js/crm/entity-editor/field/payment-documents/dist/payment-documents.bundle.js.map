{"version":3,"file":"payment-documents.bundle.js","sources":["../src/document-manager.js","../src/entity-editor.js","../src/timeline-summary.js"],"sourcesContent":["import {Type, Uri} from \"main.core\";\n\nexport default class DocumentManager\n{\n\tstatic openRealizationDetailDocument(id, params = {})\n\t{\n\t\tlet url = DocumentManager.getRealizationDocumentDetailUrl(id, params);\n\t\tlet sliderOptions = params.hasOwnProperty('sliderOptions') ? params.sliderOptions : {};\n\t\treturn new Promise((resolve, reject) =>\n\t\t{\n\t\t\tDocumentManager.openSlider(url.toString(), sliderOptions).then((slider) =>\n\t\t\t{\n\t\t\t\tresolve(slider.getData());\n\t\t\t}).catch((reason) =>\n\t\t\t{\n\n\t\t\t});\n\t\t});\n\t}\n\n\tstatic openNewRealizationDocument(params = {})\n\t{\n\t\tlet sliderOptions = {};\n\t\tif (params.hasOwnProperty('sliderOptions'))\n\t\t{\n\t\t\tsliderOptions = params.sliderOptions;\n\t\t\tdelete params.sliderOptions;\n\t\t}\n\n\t\tlet url = DocumentManager.getNewRealizationDocumentUrl(params);\n\n\t\treturn new Promise((resolve, reject) =>\n\t\t{\n\t\t\tDocumentManager.openSlider(url.toString(), sliderOptions).then((slider) =>\n\t\t\t{\n\t\t\t\tresolve(slider.getData());\n\t\t\t}).catch((reason) =>\n\t\t\t{\n\n\t\t\t});\n\t\t});\n\t}\n\n\tstatic openSlider(url, options)\n\t{\n\t\tif (!Type.isPlainObject(options))\n\t\t{\n\t\t\toptions = {};\n\t\t}\n\n\t\toptions = {...{cacheable: false, allowChangeHistory: false, events: {}}, ...options};\n\t\treturn new Promise((resolve) =>\n\t\t{\n\t\t\tif (Type.isString(url) && url.length > 1)\n\t\t\t{\n\t\t\t\toptions.events.onClose = function(event)\n\t\t\t\t{\n\t\t\t\t\tresolve(event.getSlider());\n\t\t\t\t};\n\n\t\t\t\tBX.SidePanel.Instance.open(url, options);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tresolve();\n\t\t\t}\n\t\t});\n\t}\n\n\tstatic getRealizationDocumentDetailUrl(id, params)\n\t{\n\t\tlet url = new Uri('/shop/documents/details/sales_order/' + id + '/');\n\t\tif (Type.isPlainObject(params))\n\t\t{\n\t\t\turl.setQueryParams(params);\n\t\t}\n\n\t\treturn url;\n\t}\n\n\tstatic getNewRealizationDocumentUrl(params)\n\t{\n\t\tlet url = new Uri('/shop/documents/details/sales_order/0/?DOCUMENT_TYPE=W');\n\t\tif (Type.isPlainObject(params))\n\t\t{\n\t\t\turl.setQueryParams(params);\n\t\t}\n\n\t\treturn url;\n\t}\n}\n","// @flow\n\nimport {Tag, Loc, Type, ajax, debounce} from 'main.core';\nimport {EventEmitter} from 'main.core.events';\nimport {MenuManager} from 'main.popup';\nimport {CurrencyCore} from 'currency.currency-core';\nimport {MessageBox, MessageBoxButtons} from 'ui.dialogs.messagebox';\nimport {Label, LabelColor} from 'ui.label';\nimport DocumentManager from \"./document-manager\";\n\ndeclare var BX: {[key: string]: any};\n\ntype PaymentDocument = {\n\tID: number,\n\tORDER_ID: number,\n\tFORMATTED_DATE: string,\n\tSUM: number,\n\tTYPE: 'PAYMENT' | 'SHIPMENT' | 'SHIPMENT_DOCUMENT',\n\tPAID?: 'Y' | 'N',\n\tSTAGE?: 'NOT_PAID' | 'SENT_NO_VIEWED' | 'VIEWED_NO_PAID' | 'PAID' | 'CANCEL' | 'REFUND',\n\tDELIVERY_NAME?: string,\n\tDEDUCTED?: 'Y' | 'N',\n\tEMP_DEDUCTED_ID?: number,\n\tSTATUS?: 'Y' | 'N',\n\tWAS_CANCELLED?: 'Y' | 'N',\n\tACCOUNT_NUMBER?: string,\n};\n\ntype CheckDocument = {\n\tTYPE: 'CHECK',\n\tURL: string,\n\tTITLE: string,\n}\n\ntype OrderDocument = {\n\tID: number,\n\tACCOUNT_NUMBER: string,\n\tTITLE: string,\n\tPRICE_FORMAT: string,\n}\n\ntype CreateRealizationSliderOptions = {\n\torderId?: number,\n\tpaymentId?: number,\n};\n\ntype Phrases = {[string]: string};\n\ntype EntityEditorPaymentDocumentsOptions = {\n\tCONTEXT: string,\n\tCURRENCY_FORMAT: {},\n\tCURRENCY_ID: string,\n\tOWNER_TYPE_ID: number,\n\tOWNER_ID: number,\n\tENTITY_AMOUNT: number,\n\tDOCUMENTS: Array<PaymentDocument|CheckDocument>,\n\tORDERS: Array<OrderDocument>,\n\tORDER_IDS: Array<number>,\n\tPARENT_CONTEXT: StartsSalescenterApp,\n\tIS_DELIVERY_AVAILABLE: boolean,\n\tIS_USED_INVENTORY_MANAGEMENT: boolean,\n\tSALES_ORDERS_RIGHTS: {},\n\tIS_INVENTORY_MANAGEMENT_RESTRICTED: boolean,\n\tIS_WITH_ORDERS_MODE: boolean,\n\tPHRASES: Phrases,\n\tPAID_AMOUNT: number,\n\tTOTAL_AMOUNT: number,\n};\n\ntype Destroyable = {\n\tdestroy(): any\n};\n\ntype StartsSalescenterApp = {\n\tstartSalescenterApplication(): any\n};\n\nconst SPECIFIC_REALIZATION_ERROR_CODES = [\n\t'REALIZATION_ACCESS_DENIED',\n\t'REALIZATION_CANNOT_DELETE',\n\t'REALIZATION_ALREADY_DEDUCTED',\n\t'REALIZATION_NOT_DEDUCTED',\n\t'REALIZATION_PRODUCT_NOT_FOUND',\n\t'SHIPMENT_ACCESS_DENIED',\n\t'PAYMENT_ACCESS_DENIED',\n];\n\nconst SPECIFIC_ERROR_CODES = SPECIFIC_REALIZATION_ERROR_CODES.concat([\n\t'DEDUCTION_STORE_ERROR1',\n\t'SALE_PROVIDER_SHIPMENT_QUANTITY_NOT_ENOUGH',\n\t'SALE_SHIPMENT_EXIST_SHIPPED',\n\t'SALE_PAYMENT_DELETE_EXIST_PAID',\n\t'DDCT_DEDUCTION_QUANTITY_STORE_ERROR',\n]);\n\ntype AjaxHandler = (...args: Array<any>) => any;\n\nexport class EntityEditorPaymentDocuments\n{\n\t_options: EntityEditorPaymentDocumentsOptions;\n\t_isDeliveryAvailable: boolean;\n\t_parentContext: StartsSalescenterApp;\n\t_callContext: string;\n\t_rootNode: HTMLElement;\n\t_menus: Array<Destroyable>;\n\t_phrases: Phrases;\n\tstatic _rootNodeClass = 'crm-entity-widget-inner crm-entity-widget-inner--payment';\n\n\tconstructor(options: EntityEditorPaymentDocumentsOptions)\n\t{\n\t\tthis._options = options;\n\t\tthis._phrases = {};\n\t\tif (Type.isPlainObject(options.PHRASES))\n\t\t{\n\t\t\tthis._phrases = options.PHRASES;\n\t\t}\n\t\tthis._isDeliveryAvailable = this._options.IS_DELIVERY_AVAILABLE;\n\t\tthis._parentContext = options.PARENT_CONTEXT;\n\t\tthis._callContext = options.CONTEXT;\n\t\tthis._rootNode = Tag.render`<div class=\"${this.constructor._rootNodeClass}\"></div>`;\n\t\tthis._menus = [];\n\t\tthis._isUsedInventoryManagement = this._options.IS_USED_INVENTORY_MANAGEMENT;\n\t\tthis._salesOrderRights = this._options.SALES_ORDERS_RIGHTS;\n\t\tthis._isInventoryManagementRestricted = this._options.IS_INVENTORY_MANAGEMENT_RESTRICTED;\n\t\tthis._isWithOrdersMode = this._options.IS_WITH_ORDERS_MODE;\n\n\t\tthis._subscribeToGlobalEvents();\n\t}\n\n\thasContent(): boolean\n\t{\n\t\treturn this._docs().length > 0;\n\t}\n\n\trender(): HTMLElement\n\t{\n\t\tthis._menus.forEach(menu => menu.destroy());\n\t\tthis._rootNode.innerHTML = '';\n\t\tthis._setupCurrencyFormat();\n\n\t\tif (this._isUsedInventoryManagement || this.hasContent())\n\t\t{\n\t\t\tthis._rootNode.classList.remove('is-hidden');\n\t\t\tthis._rootNode.append(Tag.render`\n\t\t\t\t<div class=\"crm-entity-widget-content-block-inner-container\">\n\t\t\t\t\t<div class=\"crm-entity-widget-payment\">\n\t\t\t\t\t\t${this._renderTitle()}\n\t\t\t\t\t\t${this._renderDocuments()}\n\t\t\t\t\t\t${this._renderAddDocument()}\n\t\t\t\t\t\t${this._renderTotalSum()}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis._rootNode.classList.add('is-hidden');\n\t\t}\n\n\t\treturn this._rootNode;\n\t}\n\n\tsetOptions(options)\n\t{\n\t\tthis._options = options;\n\t}\n\n\treloadModel(onSuccess?: AjaxHandler, onError?: AjaxHandler)\n\t{\n\t\tif (!this._options.OWNER_ID)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst data = {\n\t\t\tdata: {\n\t\t\t\townerTypeId: this._options.OWNER_TYPE_ID,\n\t\t\t\townerId: this._options.OWNER_ID\n\t\t\t}\n\t\t};\n\n\t\tconst successCallback = response => {\n\t\t\tthis._loading(false);\n\t\t\tif (response.data) {\n\t\t\t\tthis.setOptions(response.data);\n\t\t\t\tthis.render();\n\t\t\t\tif (onSuccess && Type.isFunction(onSuccess)) {\n\t\t\t\t\tonSuccess(response);\n\t\t\t\t}\n\n\t\t\t\tthis._emitChangeDocumentsEvent();\n\n\t\t\t} else {\n\t\t\t\tthis._showCommonError();\n\t\t\t\tif (onError && Type.isFunction(onError)) {\n\t\t\t\t\tonError();\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tconst errorCallback = () => {\n\t\t\tthis._loading(false);\n\t\t\tthis._showCommonError();\n\t\t\tif (onError && Type.isFunction(onError)) {\n\t\t\t\tonError();\n\t\t\t}\n\t\t};\n\n\t\tthis._loading(true);\n\n\t\tajax.runAction('crm.api.entity.fetchPaymentDocuments', data).then(successCallback, errorCallback);\n\t}\n\n\t_renderTitle(): HTMLElement\n\t{\n\t\treturn Tag.render`\n\t\t\t<div class=\"crm-entity-widget-payment-detail\">\n\t\t\t\t<div class=\"crm-entity-widget-payment-detail-caption\">${this._getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_TITLE')}</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t_renderDocuments(): HTMLElement[]\n\t{\n\t\tconst nodes = [];\n\t\tthis._docs().forEach(doc => {\n\t\t\tif (doc.TYPE === 'PAYMENT')\n\t\t\t{\n\t\t\t\tnodes.push(this._renderPaymentDocument(doc));\n\t\t\t}\n\t\t\telse if (doc.TYPE === 'SHIPMENT')\n\t\t\t{\n\t\t\t\tnodes.push(this._renderDeliveryDocument(doc));\n\t\t\t}\n\t\t\telse if (doc.TYPE === 'SHIPMENT_DOCUMENT')\n\t\t\t{\n\t\t\t\tnodes.push(this._renderRealizationDocument(doc));\n\t\t\t}\n\t\t});\n\t\treturn nodes;\n\t}\n\n\t_renderPaymentDocument(doc: PaymentDocument): HTMLElement\n\t{\n\t\tconst title = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_PAYMENT_DATE').replace(/#DATE#/gi, doc.FORMATTED_DATE);\n\t\tconst sum = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_PAYMENT_AMOUNT').replace(/#SUM#/gi, this._renderMoney(doc.SUM));\n\t\tconst labelOptions = {\n\t\t\ttext: Loc.getMessage(`CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STAGE_${doc.STAGE}`),\n\t\t\tcustomClass: 'crm-entity-widget-payment-label',\n\t\t\tcolor: LabelColor.LIGHT,\n\t\t\tfill: true,\n\t\t};\n\t\tif (doc.STAGE && doc.STAGE === 'PAID')\n\t\t{\n\t\t\tlabelOptions.color = LabelColor.LIGHT_GREEN;\n\t\t}\n\t\telse if (doc.STAGE && doc.STAGE === 'VIEWED_NO_PAID')\n\t\t{\n\t\t\tlabelOptions.color = LabelColor.LIGHT_BLUE;\n\t\t}\n\n\t\tif (!labelOptions.text)\n\t\t{\n\t\t\tlabelOptions.text = doc.PAID === 'Y'\n\t\t\t\t? Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STAGE_PAID')\n\t\t\t\t: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STAGE_NOT_PAID');\n\t\t}\n\n\t\tlet popupMenu;\n\t\tlet menuItems = [];\n\t\tif (this._isDeliveryAvailable)\n\t\t{\n\t\t\tmenuItems.push({\n\t\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_CHOOSE_DELIVERY'),\n\t\t\t\ttitle: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_CHOOSE_DELIVERY'),\n\t\t\t\tonclick: () => this._chooseDeliverySlider(doc.ORDER_ID)\n\t\t\t});\n\t\t}\n\n\t\tconst realizationMenuItem = this._getRealizationMenuItem(\n\t\t\tLoc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_CREATE_REALIZATION'),\n\t\t\t() => this._createRealizationSlider({paymentId: doc.ID})\n\t\t);\n\t\tif (realizationMenuItem)\n\t\t{\n\t\t\tmenuItems.push(realizationMenuItem);\n\t\t}\n\n\t\tmenuItems.push({\n\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_RESEND'),\n\t\t\tonclick: () => this._resendPaymentSlider(doc.ORDER_ID, doc.ID)\n\t\t});\n\t\tmenuItems.push({\n\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_CHANGE_PAYMENT_STATUS'),\n\t\t\titems: [\n\t\t\t\t{\n\t\t\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_PAID'),\n\t\t\t\t\tclassName: (doc.PAID === 'Y') ? 'menu-popup-item-accept-sm' : '',\n\t\t\t\t\tonclick: () => {\n\t\t\t\t\t\tthis._setPaymentPaidStatus(doc, true);\n\t\t\t\t\t\tpopupMenu.close();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_NOT_PAID'),\n\t\t\t\t\tclassName: (doc.PAID === 'Y') ? '' : 'menu-popup-item-accept-sm',\n\t\t\t\t\tonclick: () => {\n\t\t\t\t\t\tthis._setPaymentPaidStatus(doc, false);\n\t\t\t\t\t\tpopupMenu.close();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t]\n\t\t});\n\n\t\tmenuItems.push({\n\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_CASHBOX_CHECKS'),\n\t\t\tonclick: () => this._openPaymentChecksListSlider(doc.ID)\n\t\t});\n\n\t\tmenuItems.push({\n\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE'),\n\t\t\tclassName: (doc.PAID === 'Y') ? 'menu-popup-no-icon crm-entity-widget-payment-menu-item-remove' : '',\n\t\t\tonclick: () => {\n\t\t\t\tif (doc.PAID === 'Y')\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t\tpopupMenu.close();\n\t\t\t\tMessageBox.show({\n\t\t\t\t\ttitle: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE_CONFIRM_TITLE'),\n\t\t\t\t\tmessage: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE_PAYMENT_CONFIRM_TEXT'),\n\t\t\t\t\tmodal: true,\n\t\t\t\t\tbuttons: MessageBoxButtons.OK_CANCEL,\n\t\t\t\t\tonOk: messageBox => {\n\t\t\t\t\t\tmessageBox.close();\n\t\t\t\t\t\tthis._removeDocument(doc);\n\t\t\t\t\t},\n\t\t\t\t\tonCancel: messageBox => {\n\t\t\t\t\t\tmessageBox.close();\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tconst openSlider = () => this._resendPaymentSlider(doc.ORDER_ID, doc.ID);\n\n\t\tconst openMenu = event => {\n\t\t\tevent.preventDefault();\n\t\t\tpopupMenu = MenuManager.create({\n\t\t\t\tid: 'payment-documents-payment-action-' + doc.ID,\n\t\t\t\tbindElement: event.target,\n\t\t\t\titems: menuItems\n\t\t\t});\n\t\t\tpopupMenu.show();\n\n\t\t\tconst removeDocumentMenuItem = popupMenu.itemsContainer.querySelector('.crm-entity-widget-payment-menu-item-remove');\n\t\t\tif (removeDocumentMenuItem)\n\t\t\t{\n\t\t\t\tremoveDocumentMenuItem.setAttribute('data-hint', Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_PAYMENT_REMOVE_TIP'));\n\t\t\t\tremoveDocumentMenuItem.setAttribute('data-hint-no-icon', '');\n\t\t\t\tBX.UI.Hint.init(popupMenu.itemsContainer);\n\t\t\t}\n\n\t\t\tthis._menus.push(popupMenu);\n\t\t};\n\n\t\treturn Tag.render`\n\t\t\t<div class=\"crm-entity-widget-payment-detail\">\n\t\t\t\t<a class=\"ui-link\" onclick=\"${openSlider}\">${title} (${sum})</a>\n\t\t\t\t<div class=\"crm-entity-widget-payment-detail-inner\">\n\t\t\t\t\t<div class=\"ui-label ui-label-md ui-label-light crm-entity-widget-payment-action\" onclick=\"${openMenu}\">\n\t\t\t\t\t\t<span class=\"ui-label-inner\">${Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_ACTIONS_MENU')}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t${(new Label(labelOptions)).render()}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t_renderDeliveryDocument(doc: PaymentDocument): HTMLElement\n\t{\n\t\tconst labelOptions = {\n\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_WAITING'),\n\t\t\tcustomClass: 'crm-entity-widget-payment-label',\n\t\t\tcolor: LabelColor.LIGHT,\n\t\t\tfill: true,\n\t\t};\n\t\tif (doc.DEDUCTED === 'Y')\n\t\t{\n\t\t\tlabelOptions.text = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_DELIVERED');\n\t\t\tlabelOptions.color = LabelColor.LIGHT_GREEN;\n\t\t}\n\t\tconst title = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_DELIVERY_DATE').replace(/#DATE#/gi, doc.FORMATTED_DATE);\n\t\tconst sum = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_PAYMENT_AMOUNT').replace(/#SUM#/gi, this._renderMoney(doc.SUM));\n\n\t\tlet popupMenu;\n\t\tlet menuItems = [\n\t\t\t{\n\t\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_CHANGE_DELIVERY_STATUS'),\n\t\t\t\titems: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_DELIVERED'),\n\t\t\t\t\t\tclassName: (doc.DEDUCTED === 'Y') ? 'menu-popup-item-accept-sm' : '',\n\t\t\t\t\t\tonclick: () => {\n\t\t\t\t\t\t\tthis._setShipmentShippedStatus(doc, true);\n\t\t\t\t\t\t\tpopupMenu.close();\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_WAITING'),\n\t\t\t\t\t\tclassName: (doc.DEDUCTED === 'Y') ? '' : 'menu-popup-item-accept-sm',\n\t\t\t\t\t\tonclick: () => {\n\t\t\t\t\t\t\tthis._setShipmentShippedStatus(doc, false);\n\t\t\t\t\t\t\tpopupMenu.close();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t},\n\t\t\t{\n\t\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE'),\n\t\t\t\tclassName: (doc.DEDUCTED === 'Y') ? 'menu-popup-no-icon crm-entity-widget-shipment-menu-item-remove' : '',\n\t\t\t\tonclick: () => {\n\t\t\t\t\tif (doc.DEDUCTED === 'Y')\n\t\t\t\t\t{\n\t\t\t\t\t\treturn false;\n\t\t\t\t\t}\n\t\t\t\t\tpopupMenu.close();\n\t\t\t\t\tMessageBox.show({\n\t\t\t\t\t\ttitle: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE_CONFIRM_TITLE'),\n\t\t\t\t\t\tmessage: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE_DELIVERY_CONFIRM_TEXT'),\n\t\t\t\t\t\tmodal: true,\n\t\t\t\t\t\tbuttons: MessageBoxButtons.OK_CANCEL,\n\t\t\t\t\t\tonOk: messageBox => {\n\t\t\t\t\t\t\tmessageBox.close();\n\t\t\t\t\t\t\tthis._removeDocument(doc);\n\t\t\t\t\t\t},\n\t\t\t\t\t\tonCancel: messageBox => {\n\t\t\t\t\t\t\tmessageBox.close();\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t];\n\n\t\tconst openSlider = () => this._viewDeliverySlider(doc.ORDER_ID, doc.ID);\n\n\t\tconst openMenu = event => {\n\t\t\tevent.preventDefault();\n\t\t\tpopupMenu = MenuManager.create({\n\t\t\t\tid: 'payment-documents-delivery-action-' + doc.ID,\n\t\t\t\tbindElement: event.target,\n\t\t\t\titems: menuItems\n\t\t\t});\n\t\t\tpopupMenu.show();\n\n\t\t\tconst removeDocumentMenuItem = popupMenu.itemsContainer.querySelector('.crm-entity-widget-shipment-menu-item-remove');\n\t\t\tif (removeDocumentMenuItem)\n\t\t\t{\n\t\t\t\tremoveDocumentMenuItem.setAttribute('data-hint', Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_REMOVE_TIP'));\n\t\t\t\tremoveDocumentMenuItem.setAttribute('data-hint-no-icon', '');\n\t\t\t\tBX.UI.Hint.init(popupMenu.itemsContainer);\n\t\t\t}\n\n\t\t\tthis._menus.push(popupMenu);\n\t\t};\n\n\t\treturn Tag.render`\n\t\t\t<div class=\"crm-entity-widget-payment-detail\">\n\t\t\t\t<a class=\"ui-link\" onclick=\"${openSlider}\">\n\t\t\t\t\t${title} (${doc.DELIVERY_NAME}, ${sum})\n\t\t\t\t</a>\n\t\t\t\t<div class=\"crm-entity-widget-payment-detail-inner\">\n\t\t\t\t\t<div class=\"ui-label ui-label-md ui-label-light crm-entity-widget-payment-action\" onclick=\"${openMenu}\">\n\t\t\t\t\t\t<span class=\"ui-label-inner\">${Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_ACTIONS_MENU')}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t${(new Label(labelOptions)).render()}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t_renderRealizationDocument(doc: PaymentDocument): HTMLElement\n\t{\n\t\tconst labelOptions = {\n\t\t\tcustomClass: 'crm-entity-widget-payment-label',\n\t\t\tfill: true,\n\t\t};\n\t\tif (doc.DEDUCTED === 'Y')\n\t\t{\n\t\t\tlabelOptions.text = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_DEDUCTED');\n\t\t\tlabelOptions.color = LabelColor.LIGHT_GREEN;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif (doc.EMP_DEDUCTED_ID)\n\t\t\t{\n\t\t\t\tlabelOptions.text = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_CANCELLED');\n\t\t\t\tlabelOptions.color = LabelColor.LIGHT_ORANGE;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tlabelOptions.text = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_DRAFT');\n\t\t\t\tlabelOptions.color = LabelColor.LIGHT;\n\t\t\t}\n\t\t}\n\n\t\tlet title = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_DATE').replace(/#DATE#/gi, doc.FORMATTED_DATE);\n\t\ttitle = title.replace(/#DOCUMENT_ID#/gi, doc.ACCOUNT_NUMBER);\n\t\ttitle = BX.util.htmlspecialchars(title);\n\n\t\tconst sum = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_AMOUNT').replace(/#SUM#/gi, this._renderMoney(doc.SUM));\n\n\t\tlet popupMenu;\n\t\tlet menuItems = [];\n\n\t\tif (this._salesOrderRights?.view)\n\t\t{\n\t\t\tif (doc.DEDUCTED === 'Y' && this._salesOrderRights?.conduct)\n\t\t\t{\n\t\t\t\tif (this._salesOrderRights?.conduct)\n\t\t\t\t{\n\t\t\t\t\tmenuItems.push({\n\t\t\t\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_CANCEL'),\n\t\t\t\t\t\tclassName: (doc.DEDUCTED === 'Y') ? '' : 'menu-popup-item-accept-sm',\n\t\t\t\t\t\tonclick: () => {\n\t\t\t\t\t\t\tthis._setRealizationDeductedStatus(doc, false);\n\t\t\t\t\t\t\tpopupMenu.close();\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t}\n\t\t\telse if (doc.DEDUCTED !== 'Y' && this._salesOrderRights?.cancel)\n\t\t\t{\n\t\t\t\tmenuItems.push({\n\t\t\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_CONDUCT'),\n\t\t\t\t\tclassName: (doc.DEDUCTED === 'Y') ? 'menu-popup-item-accept-sm' : '',\n\t\t\t\t\tonclick: () => {\n\t\t\t\t\t\tthis._setRealizationDeductedStatus(doc, true);\n\t\t\t\t\t\tpopupMenu.close();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (this._salesOrderRights?.delete)\n\t\t\t{\n\t\t\t\tmenuItems.push({\n\t\t\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE'),\n\t\t\t\t\tclassName: (doc.DEDUCTED === 'Y') ? 'menu-popup-no-icon crm-entity-widget-realization-menu-item-remove' : '',\n\t\t\t\t\tonclick: () => {\n\t\t\t\t\t\tif (doc.DEDUCTED === 'Y')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tpopupMenu.close();\n\t\t\t\t\t\tMessageBox.show({\n\t\t\t\t\t\t\ttitle: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE_CONFIRM_TITLE'),\n\t\t\t\t\t\t\tmessage: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_CONFIRM_REMOVE_TEXT'),\n\t\t\t\t\t\t\tmodal: true,\n\t\t\t\t\t\t\tbuttons: MessageBoxButtons.OK_CANCEL,\n\t\t\t\t\t\t\tonOk: messageBox => {\n\t\t\t\t\t\t\t\tmessageBox.close();\n\t\t\t\t\t\t\t\tthis._removeDocument(doc);\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonCancel: messageBox => {\n\t\t\t\t\t\t\t\tmessageBox.close();\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tconst openSlider = () => this._viewRealizationSlider(doc.ID);\n\n\t\tconst openMenu = event => {\n\t\t\tevent.preventDefault();\n\t\t\tpopupMenu = MenuManager.create({\n\t\t\t\tid: 'payment-documents-realization-action-' + doc.ID,\n\t\t\t\tbindElement: event.target,\n\t\t\t\titems: menuItems\n\t\t\t});\n\t\t\tpopupMenu.show();\n\n\t\t\tconst removeDocumentMenuItem = popupMenu.itemsContainer.querySelector('.crm-entity-widget-realization-menu-item-remove');\n\t\t\tif (removeDocumentMenuItem)\n\t\t\t{\n\t\t\t\tremoveDocumentMenuItem.setAttribute('data-hint', Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REALIZATION_REMOVE_TIP'));\n\t\t\t\tremoveDocumentMenuItem.setAttribute('data-hint-no-icon', '');\n\t\t\t\tBX.UI.Hint.init(popupMenu.itemsContainer);\n\t\t\t}\n\n\t\t\tthis._menus.push(popupMenu);\n\t\t};\n\n\n\t\tconst actionMenu =\n\t\t\tmenuItems.length > 0\n\t\t\t\t? Tag.render`\n\t\t\t\t\t<div class=\"ui-label ui-label-md ui-label-light crm-entity-widget-payment-action\" onclick=\"${openMenu}\">\n\t\t\t\t\t\t<span class=\"ui-label-inner\">${Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_ACTIONS_MENU')}</span>\n\t\t\t\t\t</div>\n\t\t\t\t`\n\t\t\t\t:''\n\t\t;\n\n\t\treturn Tag.render`\n\t\t\t<div class=\"crm-entity-widget-payment-detail\">\n\t\t\t\t<a class=\"ui-link\" onclick=\"${openSlider}\">\n\t\t\t\t\t${title} (${sum})\n\t\t\t\t</a>\n\t\t\t\t<div class=\"crm-entity-widget-payment-detail-inner\">\n\t\t\t\t\t${actionMenu}\n\t\t\t\t\t${(new Label(labelOptions)).render()}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t_renderAddDocument(): HTMLElement\n\t{\n\t\tconst latestOrderId = this._latestOrderId();\n\n\t\tlet menuItems = [\n\t\t\t{\n\t\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_DOCUMENT_TYPE_PAYMENT'),\n\t\t\t\tonclick: () => this._context().startSalescenterApplication(latestOrderId)\n\t\t\t}\n\t\t];\n\t\tif (this._isDeliveryAvailable)\n\t\t{\n\t\t\tmenuItems.push({\n\t\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_DOCUMENT_TYPE_DELIVERY'),\n\t\t\t\tonclick: () => this._createDeliverySlider(latestOrderId)\n\t\t\t});\n\t\t}\n\n\t\tconst realizationMenuItem = this._getRealizationMenuItem(\n\t\t\tLoc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_DOCUMENT_TYPE_SHIPMENT_DOCUMENT'),\n\t\t\t() => this._createRealizationSlider({orderId: latestOrderId})\n\t\t);\n\t\tif (realizationMenuItem)\n\t\t{\n\t\t\tmenuItems.push(realizationMenuItem);\n\t\t}\n\n\t\tconst openMenu = event => {\n\t\t\tevent.preventDefault();\n\t\t\tconst popupMenu = MenuManager.create({\n\t\t\t\tid: 'payment-documents-create-document-action',\n\t\t\t\tbindElement: event.target,\n\t\t\t\titems: menuItems\n\t\t\t});\n\t\t\tpopupMenu.show();\n\t\t\tthis._menus.push(popupMenu);\n\t\t};\n\n\t\treturn Tag.render`\n\t\t\t<div class=\"crm-entity-widget-payment-add-box\">\n\t\t\t\t<a href=\"#\" class=\"crm-entity-widget-payment-add\" onclick=\"${openMenu}\">\n\t\t\t\t\t+ ${Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_CREATE_DOCUMENT')}\n\t\t\t\t</a>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t_getRealizationMenuItem(text: string, onclick: Function): ?Object\n\t{\n\t\tconst isAvailableInventoryManagement = this._isUsedInventoryManagement && !this._isWithOrdersMode;\n\t\tif (isAvailableInventoryManagement && this._salesOrderRights?.modify)\n\t\t{\n\t\t\tconst menuItem = {\n\t\t\t\ttext,\n\t\t\t};\n\n\t\t\tif (this._isInventoryManagementRestricted)\n\t\t\t{\n\t\t\t\tmenuItem.onclick = () => top.BX.UI.InfoHelper.show('limit_store_crm_integration');\n\t\t\t\tmenuItem.className = 'realization-document-tariff-lock';\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tmenuItem.onclick = onclick;\n\t\t\t}\n\n\t\t\treturn menuItem;\n\t\t}\n\n\t\treturn null;\n\t}\n\n\t_renderTotalSum(): HTMLElement\n\t{\n\t\tlet totalSum = this._options.TOTAL_AMOUNT;\n\n\t\tconst node = Tag.render`\n\t\t\t<div class=\"crm-entity-widget-payment-total\">\n\t\t\t\t<span>\n\t\t\t\t\t${this._getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_TOTAL_SUM')}\n\t\t\t\t\t<span data-hint=\"${this._getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_TOTAL_SUM_TOOLTIP')}\"></span>\n\t\t\t\t</span>\n\t\t\t\t<span class=\"crm-entity-widget-payment-text\">${this._renderMoney(totalSum)}</span>\n\t\t\t</div>\n\t\t`;\n\n\t\tBX.UI.Hint.init(node);\n\n\t\treturn node;\n\t};\n\n\t_renderMoney(sum: number): string\n\t{\n\t\tconst fullPrice = CurrencyCore.currencyFormat(sum, this._options.CURRENCY_ID, true);\n\t\tconst onlyPrice = CurrencyCore.currencyFormat(sum, this._options.CURRENCY_ID, false);\n\t\tconst currency = fullPrice.replace(onlyPrice, '').trim();\n\n\t\treturn fullPrice.replace(currency, `<span class=\"crm-entity-widget-payment-currency\">${currency}</span>`);\n\t}\n\n\t_docs(): Array<PaymentDocument|CheckDocument>\n\t{\n\t\tif (this._options && this._options.DOCUMENTS && this._options.DOCUMENTS.length)\n\t\t{\n\t\t\treturn this._options.DOCUMENTS;\n\t\t}\n\n\t\treturn [];\n\t}\n\n\t_orders(): Array<OrderDocument>\n\t{\n\t\tif (this._options && this._options.ORDERS && this._options.ORDERS.length)\n\t\t{\n\t\t\treturn this._options.ORDERS;\n\t\t}\n\n\t\treturn [];\n\t}\n\n\t_context(): StartsSalescenterApp\n\t{\n\t\treturn this._parentContext;\n\t}\n\n\t_orderIds(): Array<number>\n\t{\n\t\tif (this._options && this._options.ORDER_IDS && this._options.ORDER_IDS.length)\n\t\t{\n\t\t\treturn this._options.ORDER_IDS.map(id => parseInt(id));\n\t\t}\n\t\treturn [];\n\t}\n\n\t// @todo: provide test\n\t_latestOrderId(): number\n\t{\n\t\tconst latestOrder = parseInt(Math.max(...this._orderIds()));\n\t\treturn latestOrder > 0 ? latestOrder : 0;\n\t}\n\n\t_ownerTypeId(): number\n\t{\n\t\treturn this._options.OWNER_TYPE_ID || BX.CrmEntityType.enumeration.deal;\n\t}\n\n\t_createDeliverySlider(orderId: number)\n\t{\n\t\tlet analyticsLabel = 'crmDealPaymentDocumentsCreateDeliverySlider';\n\t\tif (BX.CrmEntityType.isDynamicTypeByTypeId(this._ownerTypeId()))\n\t\t{\n\t\t\tanalyticsLabel = 'crmDynamicTypePaymentDocumentsCreateDeliverySlider';\n\t\t}\n\n\t\tconst options = {\n\t\t\tcontext: this._callContext,\n\t\t\ttemplateMode: 'create',\n\t\t\tmode: 'delivery',\n\t\t\tanalyticsLabel: analyticsLabel,\n\t\t\townerTypeId: this._ownerTypeId(),\n\t\t\townerId: this._options.OWNER_ID,\n\t\t\torderId: orderId,\n\t\t};\n\t\tthis._context().startSalescenterApplication(orderId, options);\n\t}\n\n\t_createRealizationSlider(createSliderOptions: CreateRealizationSliderOptions)\n\t{\n\t\tlet analyticsLabel = 'crmDealPaymentDocumentsCreateRealizationSlider';\n\t\tif (BX.CrmEntityType.isDynamicTypeByTypeId(this._ownerTypeId()))\n\t\t{\n\t\t\tanalyticsLabel = 'crmDynamicTypePaymentDocumentsCreateRealizationSlider';\n\t\t}\n\n\t\tconst options = {\n\t\t\tcontext: {\n\t\t\t\tOWNER_TYPE_ID: this._ownerTypeId(),\n\t\t\t\tOWNER_ID: this._options.OWNER_ID,\n\t\t\t\tORDER_ID: createSliderOptions.orderId || 0,\n\t\t\t\tPAYMENT_ID: createSliderOptions.paymentId || 0,\n\t\t\t},\n\t\t\tanalyticsLabel: analyticsLabel,\n\t\t\tdocumentType: 'W',\n\t\t\tsliderOptions: {\n\t\t\t\tcustomLeftBoundary: 0,\n\t\t\t\tloader: 'crm-entity-details-loader',\n\t\t\t\trequestMethod: 'post',\n\t\t\t}\n\t\t};\n\n\t\tDocumentManager.openNewRealizationDocument(options).then(function (result) {\n\t\t\tthis.reloadModel();\n\t\t\tthis._reloadOwner();\n\t\t}.bind(this));\n\t}\n\n\t_chooseDeliverySlider(orderId: number)\n\t{\n\t\tlet analyticsLabel = 'crmDealPaymentDocumentsChooseDeliverySlider';\n\t\tif (BX.CrmEntityType.isDynamicTypeByTypeId(this._ownerTypeId()))\n\t\t{\n\t\t\tanalyticsLabel = 'crmDynamicTypePaymentDocumentsChooseDeliverySlider';\n\t\t}\n\n\t\tconst options = {\n\t\t\tcontext: this._callContext,\n\t\t\ttemplateMode: 'create',\n\t\t\tmode: 'delivery',\n\t\t\tanalyticsLabel: analyticsLabel,\n\t\t\townerTypeId: this._ownerTypeId(),\n\t\t\townerId: this._options.OWNER_ID,\n\t\t\torderId: orderId,\n\t\t};\n\t\tthis._context().startSalescenterApplication(orderId, options);\n\t}\n\n\t_openPaymentChecksListSlider(paymentId: number)\n\t{\n\t\tBX.SidePanel.Instance.open(\n\t\t\tBX.Uri.addParam('/crm/payment/checks/list.php', {\n\t\t\t\t'owner_id': paymentId,\n\t\t\t\t'owner_type': BX.CrmEntityType.enumeration.orderpayment,\n\t\t\t}),\n\t\t\t{\n\t\t\t\twidth: 1500,\n\t\t\t\tallowChangeHistory: false,\n\t\t\t\tcacheable: false,\n\t\t\t}\n\t\t);\n\t}\n\n\t_resendPaymentSlider(orderId: number, paymentId: number)\n\t{\n\t\tlet analyticsLabel = 'crmDealPaymentDocumentsResendPaymentSlider';\n\t\tif (BX.CrmEntityType.isDynamicTypeByTypeId(this._ownerTypeId()))\n\t\t{\n\t\t\tanalyticsLabel = 'crmDynamicTypePaymentDocumentsResendPaymentSlider';\n\t\t}\n\n\t\tconst options = {\n\t\t\tdisableSendButton: '',\n\t\t\tcontext: 'deal',\n\t\t\tmode: this._ownerTypeId() === BX.CrmEntityType.enumeration.deal ? 'payment_delivery' : 'payment',\n\t\t\tanalyticsLabel: analyticsLabel,\n\t\t\ttemplateMode: 'view',\n\t\t\townerTypeId: this._ownerTypeId(),\n\t\t\townerId: this._options.OWNER_ID,\n\t\t\torderId: orderId,\n\t\t\tpaymentId: paymentId,\n\t\t};\n\t\tthis._context().startSalescenterApplication(orderId, options);\n\t}\n\n\t_viewDeliverySlider(orderId: number, shipmentId: number)\n\t{\n\t\tlet analyticsLabel = 'crmDealPaymentDocumentsViewDeliverySlider';\n\t\tif (BX.CrmEntityType.isDynamicTypeByTypeId(this._ownerTypeId()))\n\t\t{\n\t\t\tanalyticsLabel = 'crmDynamicTypePaymentDocumentsViewDeliverySlider';\n\t\t}\n\n\t\tconst options = {\n\t\t\tcontext: this._callContext,\n\t\t\ttemplateMode: 'view',\n\t\t\tmode: 'delivery',\n\t\t\tanalyticsLabel: analyticsLabel,\n\t\t\townerTypeId: this._ownerTypeId(),\n\t\t\townerId: this._options.OWNER_ID,\n\t\t\torderId: orderId,\n\t\t\tshipmentId: shipmentId,\n\t\t};\n\t\tthis._context().startSalescenterApplication(orderId, options);\n\t}\n\n\t_viewRealizationSlider(documentId: number)\n\t{\n\t\tlet analyticsLabel = 'crmDealPaymentDocumentsViewRealizationSlider';\n\t\tif (BX.CrmEntityType.isDynamicTypeByTypeId(this._ownerTypeId()))\n\t\t{\n\t\t\tanalyticsLabel = 'crmDynamicTypePaymentDocumentsViewRealizationSlider';\n\t\t}\n\n\t\tconst options = {\n\t\t\townerTypeId: this._ownerTypeId(),\n\t\t\townerId: this._options.OWNER_ID,\n\t\t\tanalyticsLabel: analyticsLabel,\n\t\t\tdocumentId: documentId,\n\t\t\tsliderOptions: {\n\t\t\t\tcustomLeftBoundary: 0,\n\t\t\t\tloader: 'crm-entity-details-loader',\n\t\t\t}\n\t\t};\n\n\t\tDocumentManager.openRealizationDetailDocument(documentId, options).then(function (result) {\n\t\t\tthis._reloadOwner();\n\t\t}.bind(this));\n\t}\n\n\t_setPaymentPaidStatus(payment: PaymentDocument, isPaid: boolean)\n\t{\n\t\tconst strPaid = isPaid ? 'Y' : 'N';\n\t\tconst stage = isPaid ? 'PAID' : 'CANCEL';\n\n\t\tif (payment.PAID && payment.PAID === strPaid) {\n\t\t\treturn;\n\t\t}\n\n\t\t// positive approach - render success first, then do actual query\n\t\tthis._docs().forEach(doc => {\n\t\t\tif (doc.TYPE === 'PAYMENT' && doc.ID === payment.ID) {\n\t\t\t\tdoc.PAID = strPaid;\n\t\t\t\tdoc.STAGE = stage;\n\t\t\t}\n\t\t});\n\t\tthis.render();\n\n\t\tconst callEventOnSuccess = response => {\n\t\t\tEventEmitter.emit('PaymentDocuments.EntityEditor:changePaymentPaidStatus', {\n\t\t\t\tentityTypeId: this._options.OWNER_TYPE_ID,\n\t\t\t\tentityId: this._options.OWNER_ID,\n\t\t\t});\n\n\t\t\tthis._emitChangeDocumentsEvent();\n\t\t};\n\t\tconst reloadModelOnError = response => {\n\t\t\tthis._showErrorOnAction(response);\n\t\t\tthis.reloadModel();\n\t\t};\n\n\t\tajax.runAction('crm.order.payment.setPaid', {\n\t\t\tdata: {\n\t\t\t\tid: payment.ID,\n\t\t\t\tvalue: strPaid,\n\t\t\t}\n\t\t}).then(callEventOnSuccess, reloadModelOnError);\n\t}\n\n\t_setShipmentShippedStatus(shipment: PaymentDocument, isShipped: boolean)\n\t{\n\t\tconst strShipped = isShipped ? 'Y' : 'N';\n\n\t\tif (shipment.DEDUCTED && shipment.DEDUCTED === strShipped) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._docs().forEach(doc => {\n\t\t\tif (doc.TYPE === 'SHIPMENT' && doc.ID === shipment.ID) {\n\t\t\t\tdoc.DEDUCTED = strShipped;\n\t\t\t}\n\t\t});\n\t\tthis.render();\n\n\t\tconst callEventOnSuccess = response => {\n\t\t\tEventEmitter.emit('PaymentDocuments.EntityEditor:changeShipmentShippedStatus', {\n\t\t\t\tentityTypeId: this._options.OWNER_TYPE_ID,\n\t\t\t\tentityId: this._options.OWNER_ID,\n\t\t\t});\n\n\t\t\tthis._emitChangeDocumentsEvent();\n\t\t};\n\t\tconst reloadModelOnError = response => {\n\t\t\tthis._showShipmentStatusError(response, shipment.ID);\n\t\t\tthis.reloadModel();\n\t\t};\n\n\t\tlet actionName = 'crm.order.shipment.setShipped';\n\t\tif (this._isUsedInventoryManagement)\n\t\t{\n\t\t\tactionName = 'crm.api.realizationdocument.setShipped';\n\t\t}\n\n\t\tajax.runAction(actionName, {\n\t\t\tdata: {\n\t\t\t\tid: shipment.ID,\n\t\t\t\tvalue: strShipped,\n\t\t\t}\n\t\t}).then(callEventOnSuccess, reloadModelOnError);\n\t}\n\n\t_setRealizationDeductedStatus(shipment: PaymentDocument, isShipped: boolean)\n\t{\n\t\tconst strShipped = isShipped ? 'Y' : 'N';\n\n\t\tif (shipment.DEDUCTED && shipment.DEDUCTED === strShipped) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._docs().forEach(doc => {\n\t\t\tif (doc.TYPE === 'SHIPMENT_DOCUMENT' && doc.ID === shipment.ID) {\n\t\t\t\tdoc.DEDUCTED = strShipped;\n\t\t\t}\n\t\t});\n\t\tthis.render();\n\n\t\tconst callEventOnSuccess = response => {\n\t\t\tEventEmitter.emit('PaymentDocuments.EntityEditor:changeRealizationDeductedStatus', {\n\t\t\t\tentityTypeId: this._options.OWNER_TYPE_ID,\n\t\t\t\tentityId: this._options.OWNER_ID,\n\t\t\t});\n\n\t\t\tthis._emitChangeDocumentsEvent();\n\t\t};\n\t\tconst reloadModelOnError = response => {\n\t\t\tthis._showErrorOnAction(response);\n\t\t\tthis.reloadModel();\n\t\t};\n\n\t\tajax.runAction('crm.api.realizationdocument.setShipped', {\n\t\t\tdata: {\n\t\t\t\tid: shipment.ID,\n\t\t\t\tvalue: strShipped,\n\t\t\t}\n\t\t}).then(callEventOnSuccess, reloadModelOnError);\n\t}\n\n\t_removeDocument(doc: PaymentDocument)\n\t{\n\t\tlet action;\n\t\tlet data = {\n\t\t\tid: doc.ID\n\t\t};\n\n\t\taction = this._resolveRemoveDocumentActionName(doc.TYPE);\n\t\tif (!action)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (doc.TYPE === 'SHIPMENT_DOCUMENT') {\n\t\t\tdata.value = 'N';\n\t\t}\n\n\t\t// positive approach - render success first, then do actual query\n\t\tthis._options.DOCUMENTS = this._options.DOCUMENTS.filter(item => {\n\t\t\treturn !(item.TYPE === doc.TYPE && item.ID === doc.ID);\n\t\t});\n\t\tthis.render();\n\n\t\tconst onSuccess = response => {\n\t\t\tthis._reloadOwner();\n\t\t\tthis._emitChangeDocumentsEvent();\n\t\t};\n\t\tconst reloadModelOnError = response => {\n\t\t\tthis._showErrorOnAction(response);\n\t\t\tthis.reloadModel();\n\t\t};\n\n\t\tajax.runAction(action, {\n\t\t\tdata: data\n\t\t}).then(onSuccess, reloadModelOnError);\n\t}\n\n\t_resolveRemoveDocumentActionName(type: string)\n\t{\n\t\tlet action = '';\n\n\t\tif (type === 'PAYMENT') {\n\t\t\taction = 'crm.order.payment.delete';\n\t\t} else if (type === 'SHIPMENT') {\n\t\t\taction = 'crm.order.shipment.delete';\n\t\t} else if (type === 'SHIPMENT_DOCUMENT') {\n\t\t\taction = 'crm.api.realizationdocument.setRealization';\n\t\t}\n\n\t\treturn action;\n\t}\n\n\t_showShipmentStatusError(response, shipmentId)\n\t{\n\t\tlet showCommonError = true;\n\n\t\tif (this._isUsedInventoryManagement)\n\t\t{\n\t\t\tresponse.errors.forEach(error => {\n\t\t\t\tif (SPECIFIC_ERROR_CODES.indexOf(error.code) > -1) {\n\t\t\t\t\tshowCommonError = false;\n\n\t\t\t\t\tlet notifyMessage = error.message;\n\t\t\t\t\tif (SPECIFIC_REALIZATION_ERROR_CODES.indexOf(error.code) === -1)\n\t\t\t\t\t{\n\t\t\t\t\t\tnotifyMessage = BX.util.htmlspecialchars(notifyMessage);\n\t\t\t\t\t}\n\n\t\t\t\t\tBX.UI.Notification.Center.notify({\n\t\t\t\t\t\tcontent: notifyMessage,\n\t\t\t\t\t\tactions: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\ttitle: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_OPEN_REALIZATION_DOCUMENT'),\n\t\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\t\tclick: (event, balloon, action) =>\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tthis._viewRealizationSlider(shipmentId);\n\t\t\t\t\t\t\t\t\t\tballoon.close();\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t],\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (showCommonError)\n\t\t{\n\t\t\tthis._showCommonError();\n\t\t}\n\t}\n\n\t_showErrorOnAction(response)\n\t{\n\t\tlet showCommonError = true;\n\n\t\tresponse.errors.forEach(error => {\n\t\t\tif (SPECIFIC_ERROR_CODES.indexOf(error.code) > -1) {\n\t\t\t\tshowCommonError = false;\n\t\t\t\tthis._showSpecificError(error.code, error.message);\n\t\t\t}\n\t\t});\n\n\t\tif (showCommonError)\n\t\t{\n\t\t\tthis._showCommonError();\n\t\t}\n\t}\n\n\t_showSpecificError(code, message)\n\t{\n\t\tlet notifyMessage = message;\n\t\tif (SPECIFIC_REALIZATION_ERROR_CODES.indexOf(code) === -1)\n\t\t{\n\t\t\tnotifyMessage = BX.util.htmlspecialchars(notifyMessage);\n\t\t}\n\n\t\tBX.UI.Notification.Center.notify({\n\t\t\tcontent: notifyMessage\n\t\t});\n\t}\n\n\t_showCommonError()\n\t{\n\t\tBX.UI.Notification.Center.notify({\n\t\t\tcontent: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_COMMON_ERROR')\n\t\t});\n\t}\n\n\t_loading(isLoading: boolean)\n\t{\n\t\tif (this._rootNode && this._rootNode.classList)\n\t\t{\n\t\t\tif (isLoading)\n\t\t\t{\n\t\t\t\tthis._rootNode.classList.add('is-loading');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis._rootNode.classList.remove('is-loading');\n\t\t\t}\n\t\t}\n\t}\n\n\t_emitChangeDocumentsEvent()\n\t{\n\t\tEventEmitter.emit('PaymentDocuments.EntityEditor:changeDocuments', {\n\t\t\tentityTypeId: this._options.OWNER_TYPE_ID,\n\t\t\tentityId: this._options.OWNER_ID\n\t\t});\n\t}\n\n\t_subscribeToGlobalEvents()\n\t{\n\t\tconst events = [\n\t\t\t'salescenter.app:onshipmentcreated',\n\t\t\t'salescenter.app:onpaymentcreated',\n\t\t\t'salescenter.app:onpaymentresend'\n\t\t];\n\t\tconst timeout = 500;\n\t\tconst reloadWidget = debounce(() => {\n\t\t\tthis.reloadModel();\n\t\t}, timeout);\n\t\tconst inCompatMode = {compatMode: true};\n\n\t\tlet sliderJustClosed = false;\n\n\t\tEventEmitter.subscribe('SidePanel.Slider:onMessage', event => {\n\t\t\tconst eventId = event.getEventId();\n\t\t\tif (events.indexOf(eventId) > -1) {\n\t\t\t\treloadWidget();\n\t\t\t\tsliderJustClosed = true;\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tsliderJustClosed = false;\n\t\t\t\t}, 2000);\n\t\t\t}\n\t\t}, inCompatMode);\n\n\t\tEventEmitter.subscribe('oncrmentityupdate', () => {\n\t\t\treloadWidget();\n\t\t}, inCompatMode);\n\n\t\tEventEmitter.subscribe('onPullEvent-crm', (command, params) => {\n\t\t\tif (command !== 'onOrderSave' || sliderJustClosed)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\treloadWidget();\n\t\t}, inCompatMode);\n\n\t\tEventEmitter.subscribe('onPullEvent-salescenter', (command, params) => {\n\t\t\tif (command !== 'onOrderPaymentViewed')\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tlet orderId = false;\n\t\t\tconst orderIds = this._orderIds();\n\t\t\tif (params && params.ORDER_ID)\n\t\t\t{\n\t\t\t\torderId = parseInt(params.ORDER_ID);\n\t\t\t\tif (orderIds.indexOf(orderId) > -1)\n\t\t\t\t{\n\t\t\t\t\treloadWidget();\n\t\t\t\t}\n\t\t\t}\n\t\t}, inCompatMode);\n\t}\n\n\t_setupCurrencyFormat()\n\t{\n\t\tif (this._options)\n\t\t{\n\t\t\tif (this._options.CURRENCY_ID && this._options.CURRENCY_FORMAT)\n\t\t\t{\n\t\t\t\tCurrencyCore.setCurrencyFormat(this._options.CURRENCY_ID, this._options.CURRENCY_FORMAT);\n\t\t\t}\n\t\t}\n\t}\n\n\t_reloadOwner()\n\t{\n\t\tif (this._parentContext instanceof BX.Crm.EntityEditorMoneyPay)\n\t\t{\n\t\t\tthis._parentContext._editor.reload();\n\t\t\tthis._parentContext._editor.tapController('PRODUCT_LIST', function(controller) {\n\t\t\t\tcontroller.reinitializeProductList();\n\t\t\t});\n\t\t}\n\t}\n\n\t_getMessage(phrase): ?string\n\t{\n\t\tif (Type.isPlainObject(this._phrases) && Type.isString(this._phrases[phrase]))\n\t\t{\n\t\t\tphrase = this._phrases[phrase];\n\t\t}\n\n\t\treturn Loc.getMessage(phrase);\n\t}\n}\n","import {Loc, Tag} from 'main.core';\nimport {EventEmitter} from 'main.core.events';\nimport {Label, LabelColor} from 'ui.label';\nimport {EntityEditorPaymentDocuments} from './entity-editor';\nimport {CurrencyCore} from 'currency.currency-core';\n\nexport class TimelineSummaryDocuments extends EntityEditorPaymentDocuments\n{\n\tstatic _rootNodeClass = 'crm-entity-stream-content-detail-table crm-entity-stream-content-documents-table';\n\n\trender(): HTMLElement {\n\t\tthis._menus.forEach((menu) => menu.destroy());\n\t\tthis._rootNode.innerHTML = '';\n\t\tthis._setupCurrencyFormat();\n\n\t\tif (this.hasContent())\n\t\t{\n\t\t\tthis._filterSuccessfulDocuments();\n\t\t\tthis._rootNode.classList.remove('is-hidden');\n\n\t\t\tif (this._isWithOrdersMode)\n\t\t\t{\n\t\t\t\tthis._renderDocumentWithOrdersMode();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis._renderDocumentWithoutOrdersMode();\n\t\t\t}\n\n\t\t\tlet checkExists = this._isCheckExists();\n\t\t\tif (checkExists)\n\t\t\t{\n\t\t\t\tthis._rootNode.append(Tag.render`\n\t\t\t\t\t<div class=\"crm-entity-stream-content-document-table-group\">\n\t\t\t\t\t\t${this._renderChecksDocument()}\n\t\t\t\t\t</div>\n\t\t\t\t`);\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis._rootNode.classList.add('is-hidden');\n\t\t}\n\n\t\tEventEmitter.emit('PaymentDocuments:render', [this]);\n\n\t\treturn this._rootNode;\n\t}\n\n\t_renderDocumentWithOrdersMode()\n\t{\n\t\tlet orderDocument = Tag.render`<div></div>`;\n\n\t\tthis._orders().forEach(order => {\n\t\t\tlet documents = this._renderDocumentsByOrder(order.ID);\n\t\t\tif (documents.length > 0)\n\t\t\t{\n\t\t\t\torderDocument.append(this._renderOrderDetailBlock(order));\n\t\t\t\tdocuments.forEach(document => {\n\t\t\t\t\torderDocument.append(document);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tthis._rootNode.append(Tag.render`\n\t\t\t<div>\n\t\t\t\t${orderDocument}\n\t\t\t\t<div class=\"crm-entity-stream-content-document-table-group\">\n\t\t\t\t\t${this._renderEntityTotalSum()}\n\t\t\t\t\t${this._renderEntityPaidSum()}\n\t\t\t\t</div>\n\t\t\t\t<div class=\"crm-entity-stream-content-document-table-group\">\n\t\t\t\t\t${this._renderTotalSum()}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`);\n\t}\n\n\t_renderDocumentWithoutOrdersMode()\n\t{\n\t\tthis._rootNode.append(Tag.render`\n\t\t\t<div>\n\t\t\t\t${this._renderDocuments()}\n\t\t\t\t<div class=\"crm-entity-stream-content-document-table-group\">\n\t\t\t\t\t${this._renderEntityTotalSum()}\n\t\t\t\t\t${this._renderEntityPaidSum()}\n\t\t\t\t</div>\n\t\t\t\t<div class=\"crm-entity-stream-content-document-table-group\">\n\t\t\t\t\t${this._renderTotalSum()}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`);\n\t}\n\n\t_renderDocumentsByOrder(orderId: number): HTMLElement[]\n\t{\n\t\tconst nodes = [];\n\n\t\tlet orderDocs = this._docs().filter((item) => {\n\t\t\treturn item.ORDER_ID === orderId;\n\t\t});\n\n\t\torderDocs.forEach(doc => {\n\t\t\tif (doc.TYPE === 'PAYMENT')\n\t\t\t{\n\t\t\t\tnodes.push(this._renderPaymentDocument(doc));\n\t\t\t}\n\t\t\telse if (doc.TYPE === 'SHIPMENT')\n\t\t\t{\n\t\t\t\tnodes.push(this._renderDeliveryDocument(doc));\n\t\t\t}\n\t\t\telse if (doc.TYPE === 'SHIPMENT_DOCUMENT')\n\t\t\t{\n\t\t\t\tnodes.push(this._renderRealizationDocument(doc));\n\t\t\t}\n\t\t});\n\n\t\treturn nodes;\n\t}\n\n\t_renderEntityTotalSum() {\n\t\tlet phrase = 'CRM_ENTITY_ED_PAYMENT_DOCUMENTS_DEAL_SUM';\n\t\tif (Number(this._options.OWNER_TYPE_ID) === BX.CrmEntityType.enumeration.smartinvoice)\n\t\t{\n\t\t\tphrase = 'CRM_ENTITY_ED_PAYMENT_DOCUMENTS_INVOICE_SUM';\n\t\t}\n\n\t\treturn Tag.render`\n\t\t\t<div class=\"crm-entity-stream-content-detail-table-row crm-entity-stream-content-document-table-row\">\n\t\t\t\t<div class=\"crm-entity-stream-content-detail-description\">\n\t\t\t\t\t${Loc.getMessage(phrase)}\n\t\t\t\t</div>\n\t\t\t\t<div class=\"crm-entity-stream-content-detail-cost\">\n\t\t\t\t\t<span>\n\t\t\t\t\t\t${this._renderMoney(this._options.ENTITY_AMOUNT)}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t_renderEntityPaidSum() {\n\t\treturn Tag.render`\n\t\t\t<div class=\"crm-entity-stream-content-detail-table-row crm-entity-stream-content-document-table-row\">\n\t\t\t\t<div class=\"crm-entity-stream-content-detail-description\">\n\t\t\t\t\t${Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_ENTITY_PAID_SUM')}\n\t\t\t\t</div>\n\t\t\t\t<div class=\"crm-entity-stream-content-detail-cost\">\n\t\t\t\t\t<span>\n\t\t\t\t\t\t${this._renderMoney(this._options.PAID_AMOUNT)}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t_renderPaymentDocument(doc: PaymentDocument): HTMLElement\n\t{\n\t\tconst title = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_PAYMENT_DATE').replace(/#DATE#/gi, doc.FORMATTED_DATE);\n\t\tconst sum = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_PAYMENT_AMOUNT').replace(/#SUM#/gi, this._renderMoney(doc.SUM));\n\t\tconst labelOptions = {\n\t\t\ttext: Loc.getMessage(`CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STAGE_${doc.STAGE}`),\n\t\t\tcustomClass: 'crm-entity-widget-payment-label',\n\t\t\tcolor: LabelColor.LIGHT,\n\t\t\tfill: true,\n\t\t};\n\t\tif (doc.STAGE && doc.STAGE === 'PAID')\n\t\t{\n\t\t\tlabelOptions.color = LabelColor.LIGHT_GREEN;\n\t\t}\n\t\telse if (doc.STAGE && doc.STAGE === 'VIEWED_NO_PAID')\n\t\t{\n\t\t\tlabelOptions.color = LabelColor.LIGHT_BLUE;\n\t\t}\n\n\t\tif (!labelOptions.text)\n\t\t{\n\t\t\tlabelOptions.text = doc.PAID === 'Y'\n\t\t\t\t? Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STAGE_PAID')\n\t\t\t\t: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STAGE_NOT_PAID');\n\t\t}\n\n\t\tconst openSlider = () => this._resendPaymentSlider(doc.ORDER_ID, doc.ID);\n\n\t\treturn Tag.render`\n\t\t\t<div class=\"crm-entity-stream-content-detail-table-row\">\n\t\t\t\t<div class=\"crm-entity-stream-content-document-description\">\n\t\t\t\t\t<a class=\"ui-link\" onclick=\"${openSlider}\">${title} (${sum})</a>\n\t\t\t\t\t<span class=\"crm-entity-stream-content-document-description__label\">\n\t\t\t\t\t\t${(new Label(labelOptions)).render()}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t_renderDeliveryDocument(doc: PaymentDocument): HTMLElement\n\t{\n\t\tconst labelOptions = {\n\t\t\ttext: Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_WAITING'),\n\t\t\tcustomClass: 'crm-entity-widget-payment-label',\n\t\t\tcolor: LabelColor.LIGHT,\n\t\t\tfill: true,\n\t\t};\n\t\tif (doc.DEDUCTED === 'Y')\n\t\t{\n\t\t\tlabelOptions.text = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_DELIVERED');\n\t\t\tlabelOptions.color = LabelColor.LIGHT_GREEN;\n\t\t}\n\t\tconst title = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_DELIVERY_DATE').replace(/#DATE#/gi, doc.FORMATTED_DATE);\n\t\tconst sum = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_PAYMENT_AMOUNT').replace(/#SUM#/gi, this._renderMoney(doc.SUM));\n\n\t\tconst openSlider = () => this._viewDeliverySlider(doc.ORDER_ID, doc.ID);\n\n\t\treturn Tag.render`\n\t\t\t<div class=\"crm-entity-stream-content-detail-table-row\">\n\t\t\t\t<div class=\"crm-entity-stream-content-document-description\">\n\t\t\t\t\t<a class=\"ui-link\" onclick=\"${openSlider}\">\n\t\t\t\t\t\t${title} (${doc.DELIVERY_NAME}, ${sum})\n\t\t\t\t\t</a>\n\t\t\t\t\t<span class=\"crm-entity-stream-content-document-description__label\">\n\t\t\t\t\t\t${(new Label(labelOptions)).render()}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t_renderRealizationDocument(doc: PaymentDocument): HTMLElement\n\t{\n\t\tconst labelOptions = {\n\t\t\tfill: true,\n\t\t\tcustomClass: 'crm-entity-widget-payment-label',\n\t\t};\n\t\tif (doc.DEDUCTED === 'Y')\n\t\t{\n\t\t\tlabelOptions.text = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_DEDUCTED');\n\t\t\tlabelOptions.color = LabelColor.LIGHT_GREEN;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif (doc.EMP_DEDUCTED_ID)\n\t\t\t{\n\t\t\t\tlabelOptions.text = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_CANCELLED');\n\t\t\t\tlabelOptions.color = LabelColor.LIGHT_ORANGE;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tlabelOptions.text = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_DRAFT');\n\t\t\t\tlabelOptions.color = LabelColor.LIGHT;\n\t\t\t}\n\t\t}\n\n\t\tlet title = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_DATE').replace(/#DATE#/gi, doc.FORMATTED_DATE);\n\t\ttitle = title.replace(/#DOCUMENT_ID#/gi, doc.ACCOUNT_NUMBER);\n\t\ttitle = BX.util.htmlspecialchars(title);\n\n\t\tconst sum = Loc.getMessage('CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_AMOUNT').replace(/#SUM#/gi, this._renderMoney(doc.SUM));\n\n\t\tconst openSlider = () => this._viewRealizationSlider(doc.ID);\n\n\t\treturn Tag.render`\n\t\t\t<div class=\"crm-entity-stream-content-detail-table-row\">\n\t\t\t\t<div class=\"crm-entity-stream-content-document-description\">\n\t\t\t\t\t<a class=\"ui-link\" onclick=\"${openSlider}\">\n\t\t\t\t\t\t${title} (${sum})\n\t\t\t\t\t</a>\n\t\t\t\t\t<span class=\"crm-entity-stream-content-document-description__label\">\n\t\t\t\t\t\t${(new Label(labelOptions)).render()}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t_renderTotalSum(): HTMLElement\n\t{\n\t\tlet phrase = 'CRM_ENTITY_ED_PAYMENT_DOCUMENTS_TOTAL_SUM';\n\t\tif (Number(this._options.OWNER_TYPE_ID) === BX.CrmEntityType.enumeration.smartinvoice)\n\t\t{\n\t\t\tphrase = 'CRM_ENTITY_ED_PAYMENT_DOCUMENTS_TOTAL_INVOICE_SUM';\n\t\t}\n\n\t\treturn Tag.render`\n\t\t\t<div class=\"crm-entity-stream-content-detail-table-row crm-entity-stream-content-detail-table-row-total\">\n\t\t\t\t<div class=\"crm-entity-stream-content-detail-description\">\n\t\t\t\t\t<span>\n\t\t\t\t\t\t${Loc.getMessage(phrase)}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"crm-entity-stream-content-detail-cost\">\n\t\t\t\t\t<span>\n\t\t\t\t\t\t${this._renderTotalMoney(this._options.TOTAL_AMOUNT)}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t_renderTotalMoney(sum: number): string\n\t{\n\t\tlet fullPrice = CurrencyCore.currencyFormat(sum, this._options.CURRENCY_ID, true);\n\t\tconst onlyPrice = CurrencyCore.currencyFormat(sum, this._options.CURRENCY_ID, false);\n\t\tconst currency = fullPrice.replace(onlyPrice, '').trim();\n\n\t\tfullPrice = fullPrice.replace(currency, `<span class=\"crm-entity-widget-payment-currency\">${currency}</span>`);\n\t\tfullPrice = fullPrice.replace(onlyPrice, `<b>${onlyPrice}</b>`);\n\n\t\treturn fullPrice;\n\t}\n\n\t_renderChecksDocument(): HTMLElement[]\n\t{\n\t\tconst nodes = [];\n\n\t\tthis._docs().forEach(doc => {\n\t\t\tif (doc.TYPE === 'CHECK')\n\t\t\t{\n\t\t\t\tnodes.push(this._renderCheckDocument(doc));\n\t\t\t}\n\t\t});\n\n\t\treturn nodes;\n\t}\n\n\t_renderCheckDocument(doc: CheckDocument): HTMLElement\n\t{\n\t\tlet link;\n\n\t\tif (doc.URL)\n\t\t{\n\t\t\tlink = Tag.render`<a href=\"${doc.URL}\" target=\"_blank\">${doc.TITLE}</a>`;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tlink = Tag.render`<span>${doc.TITLE}</span>`;\n\t\t}\n\n\t\treturn Tag.render`<div class=\"crm-entity-stream-content-detail-notice\">${link}</div>`;\n\t}\n\n\t_renderOrderDetailBlock(doc: OrderDocument): HTMLElement\n\t{\n\t\treturn Tag.render`\n\t\t\t<div class=\"crm-entity-stream-content-document-table-order-group crm-entity-stream-content-detail-table-row\">\n\t\t\t\t<div class=\"crm-entity-stream-content-detail-description\">\n\t\t\t\t\t<span>${doc.TITLE}</span>\n\t\t\t\t</div>\n\t\t\t\t<div class=\"crm-entity-stream-content-detail-cost\">\n\t\t\t\t\t<span class=\"crm-entity-stream-content-detail-cost-current\">${doc.PRICE_FORMAT}</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\t}\n\n\t_filterSuccessfulDocuments()\n\t{\n\t\tthis._options.DOCUMENTS = this._options.DOCUMENTS.filter((item) => {\n\t\t\treturn (\n\t\t\t\t(item.TYPE === 'PAYMENT' && item.PAID === 'Y')\n\t\t\t\t|| (item.TYPE === 'SHIPMENT' && item.DEDUCTED === 'Y')\n\t\t\t\t|| (item.TYPE === 'SHIPMENT_DOCUMENT' && item.DEDUCTED === 'Y')\n\t\t\t\t|| (item.TYPE === 'CHECK' && item.STATUS === 'Y')\n\t\t\t);\n\t\t});\n\t}\n\n\t_isCheckExists()\n\t{\n\t\tlet checks = this._options.DOCUMENTS.filter((item) => {\n\t\t\treturn item.TYPE === 'CHECK' && item.STATUS === 'Y';\n\t\t});\n\n\t\treturn checks.length > 1;\n\t}\n}"],"names":["DocumentManager","id","params","url","getRealizationDocumentDetailUrl","sliderOptions","hasOwnProperty","Promise","resolve","reject","openSlider","toString","then","slider","getData","reason","getNewRealizationDocumentUrl","options","Type","isPlainObject","cacheable","allowChangeHistory","events","isString","length","onClose","event","getSlider","BX","SidePanel","Instance","open","Uri","setQueryParams","SPECIFIC_REALIZATION_ERROR_CODES","SPECIFIC_ERROR_CODES","concat","EntityEditorPaymentDocuments","_options","_phrases","PHRASES","_isDeliveryAvailable","IS_DELIVERY_AVAILABLE","_parentContext","PARENT_CONTEXT","_callContext","CONTEXT","_rootNode","Tag","render","constructor","_rootNodeClass","_menus","_isUsedInventoryManagement","IS_USED_INVENTORY_MANAGEMENT","_salesOrderRights","SALES_ORDERS_RIGHTS","_isInventoryManagementRestricted","IS_INVENTORY_MANAGEMENT_RESTRICTED","_isWithOrdersMode","IS_WITH_ORDERS_MODE","_subscribeToGlobalEvents","_docs","forEach","menu","destroy","innerHTML","_setupCurrencyFormat","hasContent","classList","remove","append","_renderTitle","_renderDocuments","_renderAddDocument","_renderTotalSum","add","onSuccess","onError","OWNER_ID","data","ownerTypeId","OWNER_TYPE_ID","ownerId","successCallback","response","_loading","setOptions","isFunction","_emitChangeDocumentsEvent","_showCommonError","errorCallback","ajax","runAction","_getMessage","nodes","doc","TYPE","push","_renderPaymentDocument","_renderDeliveryDocument","_renderRealizationDocument","title","Loc","getMessage","replace","FORMATTED_DATE","sum","_renderMoney","SUM","labelOptions","text","STAGE","customClass","color","LabelColor","LIGHT","fill","LIGHT_GREEN","LIGHT_BLUE","PAID","popupMenu","menuItems","onclick","_chooseDeliverySlider","ORDER_ID","realizationMenuItem","_getRealizationMenuItem","_createRealizationSlider","paymentId","ID","_resendPaymentSlider","items","className","_setPaymentPaidStatus","close","_openPaymentChecksListSlider","MessageBox","show","message","modal","buttons","MessageBoxButtons","OK_CANCEL","onOk","messageBox","_removeDocument","onCancel","openMenu","preventDefault","MenuManager","create","bindElement","target","removeDocumentMenuItem","itemsContainer","querySelector","setAttribute","UI","Hint","init","Label","DEDUCTED","_setShipmentShippedStatus","_viewDeliverySlider","DELIVERY_NAME","EMP_DEDUCTED_ID","LIGHT_ORANGE","ACCOUNT_NUMBER","util","htmlspecialchars","view","conduct","_setRealizationDeductedStatus","cancel","_viewRealizationSlider","actionMenu","latestOrderId","_latestOrderId","_context","startSalescenterApplication","_createDeliverySlider","orderId","isAvailableInventoryManagement","modify","menuItem","top","InfoHelper","totalSum","TOTAL_AMOUNT","node","fullPrice","CurrencyCore","currencyFormat","CURRENCY_ID","onlyPrice","currency","trim","DOCUMENTS","ORDERS","ORDER_IDS","map","parseInt","latestOrder","Math","max","_orderIds","CrmEntityType","enumeration","deal","analyticsLabel","isDynamicTypeByTypeId","_ownerTypeId","context","templateMode","mode","createSliderOptions","PAYMENT_ID","documentType","customLeftBoundary","loader","requestMethod","openNewRealizationDocument","result","reloadModel","_reloadOwner","bind","addParam","orderpayment","width","disableSendButton","shipmentId","documentId","openRealizationDetailDocument","payment","isPaid","strPaid","stage","callEventOnSuccess","EventEmitter","emit","entityTypeId","entityId","reloadModelOnError","_showErrorOnAction","value","shipment","isShipped","strShipped","_showShipmentStatusError","actionName","action","_resolveRemoveDocumentActionName","filter","item","type","showCommonError","errors","error","indexOf","code","notifyMessage","Notification","Center","notify","content","actions","click","balloon","_showSpecificError","isLoading","timeout","reloadWidget","debounce","inCompatMode","compatMode","sliderJustClosed","subscribe","eventId","getEventId","setTimeout","command","orderIds","CURRENCY_FORMAT","setCurrencyFormat","Crm","EntityEditorMoneyPay","_editor","reload","tapController","controller","reinitializeProductList","phrase","TimelineSummaryDocuments","_filterSuccessfulDocuments","_renderDocumentWithOrdersMode","_renderDocumentWithoutOrdersMode","checkExists","_isCheckExists","_renderChecksDocument","orderDocument","_orders","order","documents","_renderDocumentsByOrder","_renderOrderDetailBlock","document","_renderEntityTotalSum","_renderEntityPaidSum","orderDocs","Number","smartinvoice","ENTITY_AMOUNT","PAID_AMOUNT","_renderTotalMoney","_renderCheckDocument","link","URL","TITLE","PRICE_FORMAT","STATUS","checks"],"mappings":"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"}