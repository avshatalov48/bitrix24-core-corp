this.BX=this.BX||{};(function(t,e,n,i,r,a,o){"use strict";var s=function(){function t(){babelHelpers.classCallCheck(this,t)}babelHelpers.createClass(t,null,[{key:"openRealizationDetailDocument",value:function e(n){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var r=t.getRealizationDocumentDetailUrl(n,i);var a=i.hasOwnProperty("sliderOptions")?i.sliderOptions:{};return new Promise(function(e,n){t.openSlider(r.toString(),a).then(function(t){e(t.getData())}).catch(function(t){})})}},{key:"openNewRealizationDocument",value:function e(){var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i={};if(n.hasOwnProperty("sliderOptions")){i=n.sliderOptions;delete n.sliderOptions}var r=t.getNewRealizationDocumentUrl(n);return new Promise(function(e,n){t.openSlider(r.toString(),i).then(function(t){e(t.getData())}).catch(function(t){})})}},{key:"openSlider",value:function t(e,n){if(!a.Type.isPlainObject(n)){n={}}n=babelHelpers.objectSpread({},{cacheable:false,allowChangeHistory:false,events:{}},n);return new Promise(function(t){if(a.Type.isString(e)&&e.length>1){n.events.onClose=function(e){t(e.getSlider())};BX.SidePanel.Instance.open(e,n)}else{t()}})}},{key:"getRealizationDocumentDetailUrl",value:function t(e,n){var i=new a.Uri("/shop/documents/details/sales_order/"+e+"/");if(a.Type.isPlainObject(n)){i.setQueryParams(n)}return i}},{key:"getNewRealizationDocumentUrl",value:function t(e){var n=new a.Uri("/shop/documents/details/sales_order/0/?DOCUMENT_TYPE=W");if(a.Type.isPlainObject(e)){n.setQueryParams(e)}return n}}]);return t}();function _(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-entity-widget-payment-total">\n\t\t\t\t<span>\n\t\t\t\t\t','\n\t\t\t\t\t<span data-hint="','"></span>\n\t\t\t\t</span>\n\t\t\t\t<span class="crm-entity-widget-payment-text">',"</span>\n\t\t\t</div>\n\t\t"]);_=function e(){return t};return t}function c(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-entity-widget-payment-add-box">\n\t\t\t\t<a href="#" class="crm-entity-widget-payment-add" onclick="','">\n\t\t\t\t\t+ ',"\n\t\t\t\t</a>\n\t\t\t</div>\n\t\t"]);c=function e(){return t};return t}function l(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-entity-widget-payment-detail">\n\t\t\t\t<a class="ui-link" onclick="','">\n\t\t\t\t\t'," (",')\n\t\t\t\t</a>\n\t\t\t\t<div class="crm-entity-widget-payment-detail-inner">\n\t\t\t\t\t<div class="ui-label ui-label-md ui-label-light crm-entity-widget-payment-action" onclick="','">\n\t\t\t\t\t\t<span class="ui-label-inner">',"</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);l=function e(){return t};return t}function E(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-entity-widget-payment-detail">\n\t\t\t\t<a class="ui-link" onclick="','">\n\t\t\t\t\t'," (",", ",')\n\t\t\t\t</a>\n\t\t\t\t<div class="crm-entity-widget-payment-detail-inner">\n\t\t\t\t\t<div class="ui-label ui-label-md ui-label-light crm-entity-widget-payment-action" onclick="','">\n\t\t\t\t\t\t<span class="ui-label-inner">',"</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);E=function e(){return t};return t}function T(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-entity-widget-payment-detail">\n\t\t\t\t<a class="ui-link" onclick="','">'," (",')</a>\n\t\t\t\t<div class="crm-entity-widget-payment-detail-inner">\n\t\t\t\t\t<div class="ui-label ui-label-md ui-label-light crm-entity-widget-payment-action" onclick="','">\n\t\t\t\t\t\t<span class="ui-label-inner">',"</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);T=function e(){return t};return t}function u(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-entity-widget-payment-detail">\n\t\t\t\t<div class="crm-entity-widget-payment-detail-caption">',"</div>\n\t\t\t</div>\n\t\t"]);u=function e(){return t};return t}function d(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="crm-entity-widget-content-block-inner-container">\n\t\t\t\t\t<div class="crm-entity-widget-payment">\n\t\t\t\t\t\t',"\n\t\t\t\t\t\t","\n\t\t\t\t\t\t","\n\t\t\t\t\t\t","\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"]);d=function e(){return t};return t}function D(){var t=babelHelpers.taggedTemplateLiteral(['<div class="','"></div>']);D=function e(){return t};return t}var M=["REALIZATION_ACCESS_DENIED","REALIZATION_CANNOT_DELETE","REALIZATION_ALREADY_DEDUCTED","REALIZATION_NOT_DEDUCTED","REALIZATION_PRODUCT_NOT_FOUND","SHIPMENT_ACCESS_DENIED","PAYMENT_ACCESS_DENIED"];var m=M.concat(["DEDUCTION_STORE_ERROR1","SALE_PROVIDER_SHIPMENT_QUANTITY_NOT_ENOUGH","SALE_SHIPMENT_EXIST_SHIPPED","SALE_PAYMENT_DELETE_EXIST_PAID","DDCT_DEDUCTION_QUANTITY_STORE_ERROR"]);var N=function(){function t(e){babelHelpers.classCallCheck(this,t);this._options=e;this._phrases={};if(a.Type.isPlainObject(e.PHRASES)){this._phrases=e.PHRASES}this._isDeliveryAvailable=this._options.IS_DELIVERY_AVAILABLE;this._parentContext=e.PARENT_CONTEXT;this._callContext=e.CONTEXT;this._rootNode=a.Tag.render(D(),this.constructor._rootNodeClass);this._menus=[];this._isUsedInventoryManagement=this._options.IS_USED_INVENTORY_MANAGEMENT;this._isInventoryManagementRestricted=this._options.IS_INVENTORY_MANAGEMENT_RESTRICTED;this._subscribeToGlobalEvents()}babelHelpers.createClass(t,[{key:"hasContent",value:function t(){return this._docs().length>0}},{key:"render",value:function t(){this._menus.forEach(function(t){return t.destroy()});this._rootNode.innerHTML="";this._setupCurrencyFormat();if(this._isUsedInventoryManagement||this.hasContent()){this._rootNode.classList.remove("is-hidden");this._rootNode.append(a.Tag.render(d(),this._renderTitle(),this._renderDocuments(),this._renderAddDocument(),this._renderTotalSum()))}else{this._rootNode.classList.add("is-hidden")}return this._rootNode}},{key:"setOptions",value:function t(e){this._options=e}},{key:"reloadModel",value:function t(e,n){var i=this;if(!this._options.OWNER_ID){return}var r={data:{ownerTypeId:this._options.OWNER_TYPE_ID,ownerId:this._options.OWNER_ID}};var o=function t(r){i._loading(false);if(r.data){i.setOptions(r.data);i.render();if(e&&a.Type.isFunction(e)){e(r)}}else{i._showCommonError();if(n&&a.Type.isFunction(n)){n()}}};var s=function t(){i._loading(false);i._showCommonError();if(n&&a.Type.isFunction(n)){n()}};this._loading(true);a.ajax.runAction("crm.api.entity.fetchPaymentDocuments",r).then(o,s)}},{key:"_renderTitle",value:function t(){return a.Tag.render(u(),this._getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_TITLE"))}},{key:"_renderDocuments",value:function t(){var e=this;var n=[];this._docs().forEach(function(t){if(t.TYPE==="PAYMENT"){n.push(e._renderPaymentDocument(t))}else if(t.TYPE==="SHIPMENT"){n.push(e._renderDeliveryDocument(t))}else if(t.TYPE==="SHIPMENT_DOCUMENT"){n.push(e._renderRealizationDocument(t))}});return n}},{key:"_renderPaymentDocument",value:function t(e){var i=this;var s=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_PAYMENT_DATE").replace(/#DATE#/gi,e.FORMATTED_DATE);var _=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_PAYMENT_AMOUNT").replace(/#SUM#/gi,this._renderMoney(e.SUM));var c={text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STAGE_".concat(e.STAGE)),customClass:"crm-entity-widget-payment-label",color:o.LabelColor.LIGHT,fill:true};if(e.STAGE&&e.STAGE==="PAID"){c.color=o.LabelColor.LIGHT_GREEN}else if(e.STAGE&&e.STAGE==="VIEWED_NO_PAID"){c.color=o.LabelColor.LIGHT_BLUE}if(!c.text){c.text=e.PAID==="Y"?a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STAGE_PAID"):a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STAGE_NOT_PAID")}var l;var E=[];if(this._isDeliveryAvailable){E.push({text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_CHOOSE_DELIVERY"),title:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_CHOOSE_DELIVERY"),onclick:function t(){return i._chooseDeliverySlider(e.ORDER_ID)}})}E.push({text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_RESEND"),onclick:function t(){return i._resendPaymentSlider(e.ORDER_ID,e.ID)}});E.push({text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_CHANGE_PAYMENT_STATUS"),items:[{text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_PAID"),className:e.PAID==="Y"?"menu-popup-item-accept-sm":"",onclick:function t(){i._setPaymentPaidStatus(e,true);l.close()}},{text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_NOT_PAID"),className:e.PAID==="Y"?"":"menu-popup-item-accept-sm",onclick:function t(){i._setPaymentPaidStatus(e,false);l.close()}}]});E.push({text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE"),className:e.PAID==="Y"?"menu-popup-no-icon crm-entity-widget-payment-menu-item-remove":"",onclick:function t(){if(e.PAID==="Y"){return false}l.close();r.MessageBox.show({title:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE_CONFIRM_TITLE"),message:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE_PAYMENT_CONFIRM_TEXT"),modal:true,buttons:r.MessageBoxButtons.OK_CANCEL,onOk:function t(n){n.close();i._removeDocument(e)},onCancel:function t(e){e.close()}})}});var u=function t(){return i._resendPaymentSlider(e.ORDER_ID,e.ID)};var d=function t(r){r.preventDefault();l=n.MenuManager.create({id:"payment-documents-payment-action-"+e.ID,bindElement:r.target,items:E});l.show();var o=l.itemsContainer.querySelector(".crm-entity-widget-payment-menu-item-remove");if(o){o.setAttribute("data-hint",a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_PAYMENT_REMOVE_TIP"));o.setAttribute("data-hint-no-icon","");BX.UI.Hint.init(l.itemsContainer)}i._menus.push(l)};return a.Tag.render(T(),u,s,_,d,a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_ACTIONS_MENU"),new o.Label(c).render())}},{key:"_renderDeliveryDocument",value:function t(e){var i=this;var s={text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_WAITING"),customClass:"crm-entity-widget-payment-label",color:o.LabelColor.LIGHT,fill:true};if(e.DEDUCTED==="Y"){s.text=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_DELIVERED");s.color=o.LabelColor.LIGHT_GREEN}var _=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_DELIVERY_DATE").replace(/#DATE#/gi,e.FORMATTED_DATE);var c=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_PAYMENT_AMOUNT").replace(/#SUM#/gi,this._renderMoney(e.SUM));var l;var T=[{text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_CHANGE_DELIVERY_STATUS"),items:[{text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_DELIVERED"),className:e.DEDUCTED==="Y"?"menu-popup-item-accept-sm":"",onclick:function t(){i._setShipmentShippedStatus(e,true);l.close()}},{text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_WAITING"),className:e.DEDUCTED==="Y"?"":"menu-popup-item-accept-sm",onclick:function t(){i._setShipmentShippedStatus(e,false);l.close()}}]},{text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE"),className:e.DEDUCTED==="Y"?"menu-popup-no-icon crm-entity-widget-shipment-menu-item-remove":"",onclick:function t(){if(e.DEDUCTED==="Y"){return false}l.close();r.MessageBox.show({title:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE_CONFIRM_TITLE"),message:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE_DELIVERY_CONFIRM_TEXT"),modal:true,buttons:r.MessageBoxButtons.OK_CANCEL,onOk:function t(n){n.close();i._removeDocument(e)},onCancel:function t(e){e.close()}})}}];var u=function t(){return i._viewDeliverySlider(e.ORDER_ID,e.ID)};var d=function t(r){r.preventDefault();l=n.MenuManager.create({id:"payment-documents-delivery-action-"+e.ID,bindElement:r.target,items:T});l.show();var o=l.itemsContainer.querySelector(".crm-entity-widget-shipment-menu-item-remove");if(o){o.setAttribute("data-hint",a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_REMOVE_TIP"));o.setAttribute("data-hint-no-icon","");BX.UI.Hint.init(l.itemsContainer)}i._menus.push(l)};return a.Tag.render(E(),u,_,e.DELIVERY_NAME,c,d,a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_ACTIONS_MENU"),new o.Label(s).render())}},{key:"_renderRealizationDocument",value:function t(e){var i=this;var s={customClass:"crm-entity-widget-payment-label",fill:true};if(e.DEDUCTED==="Y"){s.text=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_DEDUCTED");s.color=o.LabelColor.LIGHT_GREEN}else{if(e.EMP_DEDUCTED_ID){s.text=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_CANCELLED");s.color=o.LabelColor.LIGHT_ORANGE}else{s.text=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_DRAFT");s.color=o.LabelColor.LIGHT}}var _=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_DATE").replace(/#DATE#/gi,e.FORMATTED_DATE);_=_.replace(/#DOCUMENT_ID#/gi,e.ACCOUNT_NUMBER);_=BX.util.htmlspecialchars(_);var c=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_AMOUNT").replace(/#SUM#/gi,this._renderMoney(e.SUM));var E;var T=[];if(e.DEDUCTED==="Y"){T.push({text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_CANCEL"),className:e.DEDUCTED==="Y"?"":"menu-popup-item-accept-sm",onclick:function t(){i._setRealizationDeductedStatus(e,false);E.close()}})}else{T.push({text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_CONDUCT"),className:e.DEDUCTED==="Y"?"menu-popup-item-accept-sm":"",onclick:function t(){i._setRealizationDeductedStatus(e,true);E.close()}})}T.push({text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE"),className:e.DEDUCTED==="Y"?"menu-popup-no-icon crm-entity-widget-realization-menu-item-remove":"",onclick:function t(){if(e.DEDUCTED==="Y"){return false}E.close();r.MessageBox.show({title:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REMOVE_CONFIRM_TITLE"),message:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_CONFIRM_REMOVE_TEXT"),modal:true,buttons:r.MessageBoxButtons.OK_CANCEL,onOk:function t(n){n.close();i._removeDocument(e)},onCancel:function t(e){e.close()}})}});var u=function t(){return i._viewRealizationSlider(e.ID)};var d=function t(r){r.preventDefault();E=n.MenuManager.create({id:"payment-documents-realization-action-"+e.ID,bindElement:r.target,items:T});E.show();var o=E.itemsContainer.querySelector(".crm-entity-widget-realization-menu-item-remove");if(o){o.setAttribute("data-hint",a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_REALIZATION_REMOVE_TIP"));o.setAttribute("data-hint-no-icon","");BX.UI.Hint.init(E.itemsContainer)}i._menus.push(E)};return a.Tag.render(l(),u,_,c,d,a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_ACTIONS_MENU"),new o.Label(s).render())}},{key:"_renderAddDocument",value:function t(){var e=this;var i=this._latestOrderId();var r=[{text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_DOCUMENT_TYPE_PAYMENT"),onclick:function t(){return e._context().startSalescenterApplication(i)}}];if(this._isDeliveryAvailable){r.push({text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_DOCUMENT_TYPE_DELIVERY"),onclick:function t(){return e._createDeliverySlider(i)}})}if(this._isUsedInventoryManagement){var o={text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_DOCUMENT_TYPE_SHIPMENT_DOCUMENT")};if(this._isInventoryManagementRestricted){o.onclick=function(){return top.BX.UI.InfoHelper.show("limit_store_crm_integration")};o.className="realization-document-tariff-lock"}else{o.onclick=function(){return e._createRealizationSlider(i)}}r.push(o)}var s=function t(i){i.preventDefault();var a=n.MenuManager.create({id:"payment-documents-create-document-action",bindElement:i.target,items:r});a.show();e._menus.push(a)};return a.Tag.render(c(),s,a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_CREATE_DOCUMENT"))}},{key:"_calculateTotalSum",value:function t(){var e=parseFloat(this._options.ENTITY_AMOUNT);this._docs().forEach(function(t){if(t.TYPE==="PAYMENT"){if(t.PAID&&t.PAID==="Y"){e-=parseFloat(t.SUM)}}});if(e<0){e=0}return e}},{key:"_renderTotalSum",value:function t(){var e=this._calculateTotalSum();var n=a.Tag.render(_(),this._getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_TOTAL_SUM"),this._getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_TOTAL_SUM_TOOLTIP"),this._renderMoney(e));BX.UI.Hint.init(n);return n}},{key:"_renderMoney",value:function t(e){var n=i.CurrencyCore.currencyFormat(e,this._options.CURRENCY_ID,true);var r=i.CurrencyCore.currencyFormat(e,this._options.CURRENCY_ID,false);var a=n.replace(r,"").trim();return n.replace(a,'<span class="crm-entity-widget-payment-currency">'.concat(a,"</span>"))}},{key:"_docs",value:function t(){if(this._options&&this._options.DOCUMENTS&&this._options.DOCUMENTS.length){return this._options.DOCUMENTS}return[]}},{key:"_context",value:function t(){return this._parentContext}},{key:"_orderIds",value:function t(){if(this._options&&this._options.ORDER_IDS&&this._options.ORDER_IDS.length){return this._options.ORDER_IDS.map(function(t){return parseInt(t)})}return[]}},{key:"_latestOrderId",value:function t(){var e=parseInt(Math.max.apply(Math,babelHelpers.toConsumableArray(this._orderIds())));return e>0?e:0}},{key:"_ownerTypeId",value:function t(){return this._options.OWNER_TYPE_ID||BX.CrmEntityType.enumeration.deal}},{key:"_createDeliverySlider",value:function t(e){var n="crmDealPaymentDocumentsCreateDeliverySlider";if(BX.CrmEntityType.isDynamicTypeByTypeId(this._ownerTypeId())){n="crmDynamicTypePaymentDocumentsCreateDeliverySlider"}var i={context:this._callContext,templateMode:"create",mode:"delivery",analyticsLabel:n,ownerTypeId:this._ownerTypeId(),ownerId:this._options.OWNER_ID,orderId:e};this._context().startSalescenterApplication(e,i)}},{key:"_createRealizationSlider",value:function t(e){var n="crmDealPaymentDocumentsCreateRealizationSlider";if(BX.CrmEntityType.isDynamicTypeByTypeId(this._ownerTypeId())){n="crmDynamicTypePaymentDocumentsCreateRealizationSlider"}var i={context:{OWNER_TYPE_ID:this._ownerTypeId(),OWNER_ID:this._options.OWNER_ID,ORDER_ID:e},analyticsLabel:n,documentType:"W",sliderOptions:{customLeftBoundary:0,loader:"crm-entity-details-loader",requestMethod:"post"}};s.openNewRealizationDocument(i).then(function(t){this.reloadModel();this._reloadOwner()}.bind(this))}},{key:"_chooseDeliverySlider",value:function t(e){var n="crmDealPaymentDocumentsChooseDeliverySlider";if(BX.CrmEntityType.isDynamicTypeByTypeId(this._ownerTypeId())){n="crmDynamicTypePaymentDocumentsChooseDeliverySlider"}var i={context:this._callContext,templateMode:"create",mode:"delivery",analyticsLabel:n,ownerTypeId:this._ownerTypeId(),ownerId:this._options.OWNER_ID,orderId:e};this._context().startSalescenterApplication(e,i)}},{key:"_resendPaymentSlider",value:function t(e,n){var i="crmDealPaymentDocumentsResendPaymentSlider";if(BX.CrmEntityType.isDynamicTypeByTypeId(this._ownerTypeId())){i="crmDynamicTypePaymentDocumentsResendPaymentSlider"}var r={disableSendButton:"",context:"deal",mode:this._ownerTypeId()===BX.CrmEntityType.enumeration.deal?"payment_delivery":"payment",analyticsLabel:i,templateMode:"view",ownerTypeId:this._ownerTypeId(),ownerId:this._options.OWNER_ID,orderId:e,paymentId:n};this._context().startSalescenterApplication(e,r)}},{key:"_viewDeliverySlider",value:function t(e,n){var i="crmDealPaymentDocumentsViewDeliverySlider";if(BX.CrmEntityType.isDynamicTypeByTypeId(this._ownerTypeId())){i="crmDynamicTypePaymentDocumentsViewDeliverySlider"}var r={context:this._callContext,templateMode:"view",mode:"delivery",analyticsLabel:i,ownerTypeId:this._ownerTypeId(),ownerId:this._options.OWNER_ID,orderId:e,shipmentId:n};this._context().startSalescenterApplication(e,r)}},{key:"_viewRealizationSlider",value:function t(e){var n="crmDealPaymentDocumentsViewRealizationSlider";if(BX.CrmEntityType.isDynamicTypeByTypeId(this._ownerTypeId())){n="crmDynamicTypePaymentDocumentsViewRealizationSlider"}var i={ownerTypeId:this._ownerTypeId(),ownerId:this._options.OWNER_ID,analyticsLabel:n,documentId:e,sliderOptions:{customLeftBoundary:0,loader:"crm-entity-details-loader"}};s.openRealizationDetailDocument(e,i).then(function(t){this._reloadOwner()}.bind(this))}},{key:"_setPaymentPaidStatus",value:function t(e,n){var i=this;var r=n?"Y":"N";var o=n?"PAID":"CANCEL";if(e.PAID&&e.PAID===r){return}this._docs().forEach(function(t){if(t.TYPE==="PAYMENT"&&t.ID===e.ID){t.PAID=r;t.STAGE=o}});this.render();var s=function t(e){};var _=function t(e){i._showErrorOnAction(e);i.reloadModel()};var c="sale.payment.setpaid";if(this._isUsedInventoryManagement){c="crm.order.payment.setPaid"}a.ajax.runAction(c,{data:{id:e.ID,value:r}}).then(s,_)}},{key:"_setShipmentShippedStatus",value:function t(e,n){var i=this;var r=n?"Y":"N";if(e.DEDUCTED&&e.DEDUCTED===r){return}this._docs().forEach(function(t){if(t.TYPE==="SHIPMENT"&&t.ID===e.ID){t.DEDUCTED=r}});this.render();var o=function t(e){};var s=function t(n){i._showShipmentStatusError(n,e.ID);i.reloadModel()};var _="sale.shipment.setshipped";if(this._isUsedInventoryManagement){_="crm.api.realizationdocument.setShipped"}a.ajax.runAction(_,{data:{id:e.ID,value:r}}).then(o,s)}},{key:"_setRealizationDeductedStatus",value:function t(e,n){var i=this;var r=n?"Y":"N";if(e.DEDUCTED&&e.DEDUCTED===r){return}this._docs().forEach(function(t){if(t.TYPE==="SHIPMENT_DOCUMENT"&&t.ID===e.ID){t.DEDUCTED=r}});this.render();var o=function t(e){};var s=function t(e){i._showErrorOnAction(e);i.reloadModel()};a.ajax.runAction("crm.api.realizationdocument.setShipped",{data:{id:e.ID,value:r}}).then(o,s)}},{key:"_removeDocument",value:function t(e){var n=this;var i;var r={id:e.ID};i=this._resolveRemoveDocumentActionName(e.TYPE);if(!i){return}if(e.TYPE==="SHIPMENT_DOCUMENT"){r.value="N"}this._options.DOCUMENTS=this._options.DOCUMENTS.filter(function(t){return!(t.TYPE===e.TYPE&&t.ID===e.ID)});this.render();var o=function t(e){n._reloadOwner()};var s=function t(e){n._showErrorOnAction(e);n.reloadModel()};a.ajax.runAction(i,{data:r}).then(o,s)}},{key:"_resolveRemoveDocumentActionName",value:function t(e){var n="sale";if(this._isUsedInventoryManagement){n="crm.order"}var i="";if(e==="PAYMENT"){i=n+".payment.delete"}else if(e==="SHIPMENT"){i=n+".shipment.delete"}else if(e==="SHIPMENT_DOCUMENT"){i="crm.api.realizationdocument.setRealization"}return i}},{key:"_showShipmentStatusError",value:function t(e,n){var i=this;var r=true;if(this._isUsedInventoryManagement){e.errors.forEach(function(t){if(m.indexOf(t.code)>-1){r=false;var e=t.message;if(M.indexOf(t.code)===-1){e=BX.util.htmlspecialchars(e)}BX.UI.Notification.Center.notify({content:e,actions:[{title:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_OPEN_REALIZATION_DOCUMENT"),events:{click:function t(e,r,a){i._viewRealizationSlider(n);r.close()}}}]})}})}if(r){this._showCommonError()}}},{key:"_showErrorOnAction",value:function t(e){var n=this;var i=true;e.errors.forEach(function(t){if(m.indexOf(t.code)>-1){i=false;n._showSpecificError(t.code,t.message)}});if(i){this._showCommonError()}}},{key:"_showSpecificError",value:function t(e,n){var i=n;if(M.indexOf(e)===-1){i=BX.util.htmlspecialchars(i)}BX.UI.Notification.Center.notify({content:i})}},{key:"_showCommonError",value:function t(){BX.UI.Notification.Center.notify({content:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_COMMON_ERROR")})}},{key:"_loading",value:function t(e){if(this._rootNode&&this._rootNode.classList){if(e){this._rootNode.classList.add("is-loading")}else{this._rootNode.classList.remove("is-loading")}}}},{key:"_subscribeToGlobalEvents",value:function t(){var n=this;var i=["salescenter.app:onshipmentcreated","salescenter.app:onpaymentcreated","salescenter.app:onpaymentresend"];var r=500;var o=a.debounce(function(){n.reloadModel()},r);var s={compatMode:true};var _=false;e.EventEmitter.subscribe("SidePanel.Slider:onMessage",function(t){var e=t.getEventId();if(i.indexOf(e)>-1){o();_=true;setTimeout(function(){_=false},2e3)}},s);e.EventEmitter.subscribe("oncrmentityupdate",function(){o()},s);e.EventEmitter.subscribe("onPullEvent-crm",function(t,e){if(t!=="onOrderSave"||_){return}o()},s);e.EventEmitter.subscribe("onPullEvent-salescenter",function(t,e){if(t!=="onOrderPaymentViewed"){return}var i=false;var r=n._orderIds();if(e&&e.ORDER_ID){i=parseInt(e.ORDER_ID);if(r.indexOf(i)>-1){o()}}},s)}},{key:"_setupCurrencyFormat",value:function t(){if(this._options){if(this._options.CURRENCY_ID&&this._options.CURRENCY_FORMAT){i.CurrencyCore.setCurrencyFormat(this._options.CURRENCY_ID,this._options.CURRENCY_FORMAT)}}}},{key:"_reloadOwner",value:function t(){if(this._parentContext instanceof BX.Crm.EntityEditorMoneyPay){this._parentContext._editor.reload();this._parentContext._editor.tapController("PRODUCT_LIST",function(t){t.reinitializeProductList()})}}},{key:"_getMessage",value:function t(e){if(a.Type.isPlainObject(this._phrases)&&a.Type.isString(this._phrases[e])){e=this._phrases[e]}return a.Loc.getMessage(e)}}]);return t}();babelHelpers.defineProperty(N,"_rootNodeClass","crm-entity-widget-inner crm-entity-widget-inner--payment");function p(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-entity-stream-content-detail-table-row">\n\t\t\t\t<div class="crm-entity-stream-content-detail-description">\n\t\t\t\t\t<span>\n\t\t\t\t\t\t','\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="crm-entity-stream-content-detail-cost">\n\t\t\t\t\t<span>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);p=function e(){return t};return t}function C(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-entity-stream-content-detail-table-row">\n\t\t\t\t<div class="crm-entity-stream-content-document-description">\n\t\t\t\t\t<a class="ui-link" onclick="','">\n\t\t\t\t\t\t'," (",")\n\t\t\t\t\t</a>\n\t\t\t\t\t",'\n\t\t\t\t</div>\n\t\t\t\t<div class="crm-entity-stream-content-detail-cost">\n\t\t\t\t\t<span>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);C=function e(){return t};return t}function y(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-entity-stream-content-detail-table-row">\n\t\t\t\t<div class="crm-entity-stream-content-document-description">\n\t\t\t\t\t<a class="ui-link" onclick="','">\n\t\t\t\t\t\t'," (",")\n\t\t\t\t\t</a>\n\t\t\t\t\t",'\n\t\t\t\t</div>\n\t\t\t\t<div class="crm-entity-stream-content-detail-cost">\n\t\t\t\t\t<span>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);y=function e(){return t};return t}function v(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-entity-stream-content-detail-table-row">\n\t\t\t\t<div class="crm-entity-stream-content-document-description">\n\t\t\t\t\t<a class="ui-link" onclick="','">',"</a>\n\t\t\t\t\t",'\n\t\t\t\t</div>\n\t\t\t\t<div class="crm-entity-stream-content-detail-cost">\n\t\t\t\t\t<span>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);v=function e(){return t};return t}function I(){var t=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t<div>\n\t\t\t\t\t","\n\t\t\t\t\t","\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"]);I=function e(){return t};return t}function f(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-entity-stream-content-detail-table-row crm-entity-stream-content-document-table-row">\n\t\t\t\t<div class="crm-entity-stream-content-detail-description">\n\t\t\t\t\t','\n\t\t\t\t</div>\n\t\t\t\t<div class="crm-entity-stream-content-detail-cost">\n\t\t\t\t\t<span>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);f=function e(){return t};return t}var h=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).apply(this,arguments))}babelHelpers.createClass(e,[{key:"_renderDealTotalSum",value:function t(){var e="CRM_ENTITY_ED_PAYMENT_DOCUMENTS_DEAL_SUM";if(Number(this._options.OWNER_TYPE_ID)===BX.CrmEntityType.enumeration.smartinvoice){e="CRM_ENTITY_ED_PAYMENT_DOCUMENTS_INVOICE_SUM"}return a.Tag.render(f(),a.Loc.getMessage(e),this._renderMoney(this._options.ENTITY_AMOUNT))}},{key:"render",value:function t(){this._menus.forEach(function(t){return t.destroy()});this._rootNode.innerHTML="";this._setupCurrencyFormat();if(this.hasContent()){this._filterSuccessfulDocuments();this._rootNode.classList.remove("is-hidden");this._rootNode.append(a.Tag.render(I(),this._renderDealTotalSum(),this._renderDocuments(),this._renderTotalSum()))}else{this._rootNode.classList.add("is-hidden")}return this._rootNode}},{key:"_renderPaymentDocument",value:function t(e){var n=this;var i=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_PAYMENT_DATE").replace(/#DATE#/gi,e.FORMATTED_DATE);var r={text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STAGE_".concat(e.STAGE)),customClass:"crm-entity-widget-payment-label",color:o.LabelColor.LIGHT,fill:true};if(e.STAGE&&e.STAGE==="PAID"){r.color=o.LabelColor.LIGHT_GREEN}else if(e.STAGE&&e.STAGE==="VIEWED_NO_PAID"){r.color=o.LabelColor.LIGHT_BLUE}if(!r.text){r.text=e.PAID==="Y"?a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STAGE_PAID"):a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STAGE_NOT_PAID")}var s=function t(){return n._resendPaymentSlider(e.ORDER_ID,e.ID)};return a.Tag.render(v(),s,i,new o.Label(r).render(),this._renderMoney(e.SUM))}},{key:"_renderDeliveryDocument",value:function t(e){var n=this;var i={text:a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_WAITING"),customClass:"crm-entity-widget-payment-label",color:o.LabelColor.LIGHT,fill:true};if(e.DEDUCTED==="Y"){i.text=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_STATUS_DELIVERED");i.color=o.LabelColor.LIGHT_GREEN}var r=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_DELIVERY_DATE").replace(/#DATE#/gi,e.FORMATTED_DATE);var s=function t(){return n._viewDeliverySlider(e.ORDER_ID,e.ID)};return a.Tag.render(y(),s,r,e.DELIVERY_NAME,new o.Label(i).render(),this._renderMoney(e.SUM))}},{key:"_renderRealizationDocument",value:function t(e){var n=this;var i={fill:true,customClass:"crm-entity-widget-payment-label"};if(e.DEDUCTED==="Y"){i.text=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_DEDUCTED");i.color=o.LabelColor.LIGHT_GREEN}else{if(e.EMP_DEDUCTED_ID){i.text=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_CANCELLED");i.color=o.LabelColor.LIGHT_ORANGE}else{i.text=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_STATUS_DRAFT");i.color=o.LabelColor.LIGHT}}var r=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_DATE").replace(/#DATE#/gi,e.FORMATTED_DATE);r=r.replace(/#DOCUMENT_ID#/gi,e.ACCOUNT_NUMBER);r=BX.util.htmlspecialchars(r);var s=a.Loc.getMessage("CRM_ENTITY_ED_PAYMENT_DOCUMENTS_SHIPMENT_DOCUMENT_AMOUNT").replace(/#SUM#/gi,this._renderMoney(e.SUM));var _=function t(){return n._viewRealizationSlider(e.ID)};return a.Tag.render(C(),_,r,s,new o.Label(i).render(),this._renderMoney(e.SUM))}},{key:"_renderTotalSum",value:function t(){var e=this._calculateTotalSum();var n="CRM_ENTITY_ED_PAYMENT_DOCUMENTS_TOTAL_SUM";if(Number(this._options.OWNER_TYPE_ID)===BX.CrmEntityType.enumeration.smartinvoice){n="CRM_ENTITY_ED_PAYMENT_DOCUMENTS_TOTAL_INVOICE_SUM"}return a.Tag.render(p(),a.Loc.getMessage(n),this._renderMoney(e))}},{key:"_filterSuccessfulDocuments",value:function t(){this._options.DOCUMENTS=this._options.DOCUMENTS.filter(function(t){return t.TYPE==="PAYMENT"&&t.PAID==="Y"||t.TYPE==="SHIPMENT"&&t.DEDUCTED==="Y"||t.TYPE==="SHIPMENT_DOCUMENT"&&t.DEDUCTED==="Y"})}}]);return e}(N);babelHelpers.defineProperty(h,"_rootNodeClass","crm-entity-stream-content-detail-table crm-entity-stream-content-documents-table");t.EntityEditorPaymentDocuments=N;t.TimelineSummaryDocuments=h})(this.BX.Crm=this.BX.Crm||{},BX.Event,BX.Main,BX.Currency,BX.UI.Dialogs,BX,BX.UI);
//# sourceMappingURL=payment-documents.bundle.map.js