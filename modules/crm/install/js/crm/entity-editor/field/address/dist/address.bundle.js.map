{"version":3,"file":"address.bundle.js","sources":["../src/address.js"],"sourcesContent":["import {EntityEditorBaseAddressField} from \"crm.entity-editor.field.address.base\";\nimport {Event, Tag, Dom, Type} from \"main.core\";\nimport {EventEmitter} from \"main.core.events\";\n\nexport class EntityEditorAddressField extends BX.Crm.EntityEditorField\n{\n\tconstructor()\n\t{\n\t\tsuper();\n\t\tthis._field = null;\n\t\tthis._isMultiple = null;\n\t\tthis._autocompleteEnabled = false;\n\t\tthis._restrictionsCallback = null;\n\t}\n\n\tinitialize(id, settings)\n\t{\n\t\tsuper.initialize(id, settings);\n\n\t\tlet params = this._schemeElement.getData();\n\t\tthis._isMultiple = BX.prop.getBoolean(params, \"multiple\", false);\n\n\t\tthis._autocompleteEnabled = BX.prop.getBoolean(params, \"autocompleteEnabled\", false);\n\t\tif (!this._autocompleteEnabled)\n\t\t{\n\t\t\tthis._restrictionsCallback = BX.prop.getString(params, \"featureRestrictionCallback\", '');\n\t\t}\n\n\t\tsettings = Type.isPlainObject(settings) ? settings : {};\n\t\tsettings.crmCompatibilityMode = true;\n\t\tsettings.enableAutocomplete = this._autocompleteEnabled;\n\t\tthis._field = EntityEditorBaseAddressField.create(id, settings);\n\t\tthis._field.setMultiple(this._isMultiple);\n\t\tif (this._isMultiple)\n\t\t{\n\t\t\tthis._field.setTypesList(BX.prop.getObject(params, \"types\", {}));\n\t\t}\n\t\tEventEmitter.subscribe(this._field, 'onUpdate', this.onAddressListUpdate.bind(this));\n\t\tEventEmitter.subscribe(this._field, 'onStartLoadAddress', this.onStartLoadAddress.bind(this));\n\t\tEventEmitter.subscribe(this._field, 'onAddressLoaded', this.onAddressLoaded.bind(this));\n\t\tEventEmitter.subscribe(this._field, 'onError', this.onError.bind(this));\n\n\t\tthis.initializeFromModel();\n\t}\n\n\tsetupFromModel(model, options)\n\t{\n\t\tsuper.setupFromModel(model, options);\n\t\tthis.initializeFromModel();\n\t}\n\n\tinitializeFromModel()\n\t{\n\t\tthis.setAddressList(this.getValue(this._isMultiple ? {} : \"\"));\n\t}\n\n\tsetAddressList(addressList)\n\t{\n\t\tif (this._field.setValue(addressList))\n\t\t{\n\t\t\tthis.refreshLayout();\n\t\t}\n\t}\n\n\tlayout(options)\n\t{\n\t\tif (this._hasLayout)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.ensureWrapperCreated({classNames: [\"crm-entity-widget-content-block-field-address\"]});\n\t\tthis.adjustWrapper();\n\n\t\tif (!this.isNeedToDisplay())\n\t\t{\n\t\t\tthis.registerLayout(options);\n\t\t\tthis._hasLayout = true;\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.isDragEnabled())\n\t\t{\n\t\t\tDom.append(this.createDragButton(), this._wrapper);\n\t\t}\n\n\t\tDom.append(this.createTitleNode(this.getTitle()), this._wrapper);\n\n\t\tif (!this.hasValue() && this._mode === BX.Crm.EntityEditorMode.view)\n\t\t{\n\t\t\tDom.append(\n\t\t\t\tTag.render`\n\t\t\t\t\t<div class=\"crm-entity-widget-content-block-inner\" onclick=\"${this.onViewModeClick.bind(this)}\">\n\t\t\t\t\t\t${BX.Crm.EntityEditorField.messages.isEmpty}\n\t\t\t\t\t</div>`,\n\t\t\t\tthis._wrapper\n\t\t\t);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tlet fieldContainer = this._field.layout(this._mode === BX.Crm.EntityEditorMode.edit);\n\t\t\tfieldContainer.classList.add('crm-entity-widget-content-block-inner');\n\t\t\tif (this._mode === BX.Crm.EntityEditorMode.view)\n\t\t\t{\n\t\t\t\tEvent.bind(fieldContainer, 'click', this.onViewModeClick.bind(this));\n\t\t\t}\n\t\t\tDom.append(fieldContainer, this._wrapper);\n\t\t}\n\n\t\tif (this.isContextMenuEnabled())\n\t\t{\n\t\t\tthis._wrapper.appendChild(this.createContextMenuButton());\n\t\t}\n\n\t\tif (this.isDragEnabled())\n\t\t{\n\t\t\tthis.initializeDragDropAbilities();\n\t\t}\n\n\t\tthis.registerLayout(options);\n\t\tthis._hasLayout = true;\n\t}\n\n\tdoClearLayout(options)\n\t{\n\t\tif (BX.prop.getBoolean(options, \"release\", false))\n\t\t{\n\t\t\tthis._field.release();\n\t\t}\n\t}\n\n\thasValue()\n\t{\n\t\tif (!Type.isObject(this._field))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\t\treturn this._isMultiple ?\n\t\t\t!!(this._field.getValue().filter((item) => Type.isStringFilled(item.value)).length) :\n\t\t\t!!this._field.getValue();\n\t}\n\n\tcreateTitleMarker()\n\t{\n\t\tif(this._mode === BX.Crm.EntityEditorMode.view)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tif (this._restrictionsCallback && this._restrictionsCallback.length)\n\t\t{\n\t\t\tlet lockIcon = Tag.render` <span class=\"tariff-lock\"></span>`;\n\t\t\tlockIcon.setAttribute('onclick', this._restrictionsCallback);\n\t\t\treturn lockIcon;\n\t\t}\n\n\t\treturn super.createTitleMarker();\n\t}\n\n\trollback()\n\t{\n\t\tthis.initializeFromModel();\n\t}\n\n\tsave()\n\t{\n\t\tif (this.isVirtual())\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tif (!Type.isDomNode(this._wrapper))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._isMultiple)\n\t\t{\n\t\t\tlet fieldNamePrefix = this.getName();\n\t\t\tfor (let address of this._field.getValue())\n\t\t\t{\n\t\t\t\tlet type = address.type;\n\t\t\t\tlet value = address.value;\n\t\t\t\tlet name = `${fieldNamePrefix}[${type}]`;\n\n\t\t\t\tlet node = Tag.render`<input type=\"hidden\">`;\n\t\t\t\tnode.name = name;\n\t\t\t\tnode.value = value;\n\t\t\t\tDom.append(node, this._wrapper);\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\tlet address = this._field.getValue();\n\t\t\tlet node = Tag.render`<input type=\"hidden\">`;\n\t\t\tnode.name = this.getName();\n\t\t\tnode.value = (address ? address : \"\");\n\t\t\tDom.append(node, this._wrapper);\n\t\t}\n\t}\n\n\tonViewModeClick()\n\t{\n\t\tif (!this.getEditor().isReadOnly())\n\t\t{\n\t\t\tthis.switchToSingleEditMode();\n\t\t}\n\t}\n\n\tonAddressListUpdate(event)\n\t{\n\t\tthis.markAsChanged();\n\t}\n\n\tonStartLoadAddress()\n\t{\n\t\tlet toolPanel = this.getEditor()._toolPanel;\n\t\tif (toolPanel)\n\t\t{\n\t\t\ttoolPanel.setLocked(true);\n\t\t}\n\t}\n\n\tonAddressLoaded()\n\t{\n\t\tlet toolPanel = this.getEditor()._toolPanel;\n\t\tif (toolPanel)\n\t\t{\n\t\t\ttoolPanel.setLocked(false);\n\t\t}\n\t}\n\n\tonError(event)\n\t{\n\t\tconst data = event.getData();\n\t\tthis.showError(data.error);\n\n\t\tconst toolPanel = this.getEditor()._toolPanel;\n\t\tif (toolPanel)\n\t\t{\n\t\t\ttoolPanel.setLocked(false);\n\t\t}\n\t}\n\n\tstatic create(id, settings)\n\t{\n\t\tlet self = new this(id, settings);\n\t\tself.initialize(id, settings);\n\t\treturn self;\n\t}\n}\n"],"names":["EntityEditorAddressField","_field","_isMultiple","_autocompleteEnabled","_restrictionsCallback","id","settings","params","_schemeElement","getData","BX","prop","getBoolean","getString","Type","isPlainObject","crmCompatibilityMode","enableAutocomplete","EntityEditorBaseAddressField","create","setMultiple","setTypesList","getObject","EventEmitter","subscribe","onAddressListUpdate","bind","onStartLoadAddress","onAddressLoaded","onError","initializeFromModel","model","options","setAddressList","getValue","addressList","setValue","refreshLayout","_hasLayout","ensureWrapperCreated","classNames","adjustWrapper","isNeedToDisplay","registerLayout","isDragEnabled","Dom","append","createDragButton","_wrapper","createTitleNode","getTitle","hasValue","_mode","Crm","EntityEditorMode","view","Tag","render","onViewModeClick","EntityEditorField","messages","isEmpty","fieldContainer","layout","edit","classList","add","Event","isContextMenuEnabled","appendChild","createContextMenuButton","initializeDragDropAbilities","release","isObject","filter","item","isStringFilled","value","length","lockIcon","setAttribute","isVirtual","isDomNode","fieldNamePrefix","getName","address","type","name","node","getEditor","isReadOnly","switchToSingleEditMode","event","markAsChanged","toolPanel","_toolPanel","setLocked","data","showError","error","self","initialize"],"mappings":"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"}