{"version":3,"file":"address.bundle.js","sources":["../src/address.js"],"sourcesContent":["import {EntityEditorBaseAddressField} from \"crm.entity-editor.field.address.base\";\nimport {Tag, Dom, Type} from \"main.core\";\nimport {EventEmitter} from \"main.core.events\";\n\nexport class EntityEditorUiAddressField extends BX.UI.EntityEditorField\n{\n\tconstructor()\n\t{\n\t\tsuper();\n\t\tthis._field = null;\n\t\tthis._autocompleteEnabled = false;\n\t\tthis._restrictionsCallback = null;\n\t}\n\n\tinitialize(id, settings)\n\t{\n\t\tsuper.initialize(id, settings);\n\t\tlet params = this._schemeElement.getData();\n\n\t\tthis._autocompleteEnabled = BX.prop.getBoolean(params, \"autocompleteEnabled\", false);\n\t\tif (!this._autocompleteEnabled)\n\t\t{\n\t\t\tthis._restrictionsCallback = BX.prop.getString(params, \"featureRestrictionCallback\", '');\n\t\t}\n\t\tsettings.enableAutocomplete = this._autocompleteEnabled;\n\t\tsettings.hideDefaultAddressType = true;\n\t\tsettings.addressZoneConfig = BX.prop.getObject(params, \"addressZoneConfig\", {});\n\t\tsettings.defaultAddressTypeByCategory = BX.prop.getInteger(params, \"defaultAddressTypeByCategory\", 0);\n\t\tthis._field = EntityEditorBaseAddressField.create(id, settings);\n\t\tthis._field.setMultiple(true);\n\t\tthis._field.setTypesList(BX.prop.getObject(params, \"types\", {}));\n\t\tEventEmitter.subscribe(this._field, 'onUpdate', this.onAddressListUpdate.bind(this));\n\t\tEventEmitter.subscribe(this._field, 'onStartLoadAddress', this.onStartLoadAddress.bind(this));\n\t\tEventEmitter.subscribe(this._field, 'onAddressLoaded', this.onAddressLoaded.bind(this));\n\t\tEventEmitter.subscribe(this._field, 'onError', this.onError.bind(this));\n\t\tthis._valueNode = null;\n\t\tthis._modelTypes = [];\n\n\t\tthis.initializeFromModel();\n\t}\n\n\tinitializeFromModel()\n\t{\n\t\tlet value = this.prepareValue(this.getValue());\n\t\tthis._modelTypes = Object.keys(value);\n\t\tthis._field.setValue(value);\n\t}\n\n\tprepareValue(value)\n\t{\n\t\treturn Type.isPlainObject(value) ? value : {};\n\t}\n\n\tonBeforeSubmit()\n\t{\n\n\t\tif (!Type.isDomNode(this._valueNode))\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tDom.clean(this._valueNode);\n\n\t\tlet values = {};\n\t\tfor (let type of this._modelTypes)\n\t\t{\n\t\t\tvalues[type] = \"\";\n\t\t}\n\t\tfor (let address of this._field.getValue())\n\t\t{\n\t\t\tif (address.value.length)\n\t\t\t{\n\t\t\t\tvalues[address.type] = address.value;\n\t\t\t}\n\t\t}\n\n\t\tlet fieldNamePrefix = this.getName();\n\t\tfor (let type in values)\n\t\t{\n\t\t\tif (!values.hasOwnProperty(type))\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tlet value = values[type];\n\t\t\tlet name ='';\n\t\t\tif (Type.isStringFilled(value))\n\t\t\t{\n\t\t\t\tname = `${fieldNamePrefix}[${type}]`;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tname = `${fieldNamePrefix}[${type}][DELETED]`;\n\t\t\t\tvalue = 'Y';\n\t\t\t}\n\n\t\t\tlet node = Tag.render`<input type=\"hidden\">`;\n\t\t\tnode.name = name;\n\t\t\tnode.value = value;\n\t\t\tDom.append(node, this._valueNode);\n\t\t}\n\t}\n\n\trefreshLayout(options)\n\t{\n\t\tthis.initializeFromModel();\n\t\tsuper.refreshLayout(options);\n\t}\n\n\tlayout(options)\n\t{\n\t\tif (this._hasLayout)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.ensureWrapperCreated({classNames: [\"ui-entity-editor-content-block-field-address crm-entity-widget-content-block\"]});\n\t\tthis.adjustWrapper();\n\n\t\tif (!this.isNeedToDisplay())\n\t\t{\n\t\t\tthis.registerLayout(options);\n\t\t\tthis._hasLayout = true;\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.isDragEnabled())\n\t\t{\n\t\t\tDom.append(this.createDragButton(), this._wrapper);\n\t\t}\n\n\t\tDom.append(this.createTitleNode(this.getTitle()), this._wrapper);\n\n\t\tlet fieldContainer = this._field.layout(this._mode === BX.UI.EntityEditorMode.edit);\n\t\tfieldContainer.classList.add('ui-entity-editor-content-block');\n\t\tthis._wrapper.appendChild(fieldContainer);\n\n\t\tthis._valueNode = Tag.render`<span></span>`;\n\t\tthis._wrapper.appendChild(this._valueNode);\n\n\t\tif (this.isContextMenuEnabled())\n\t\t{\n\t\t\tthis._wrapper.appendChild(this.createContextMenuButton());\n\t\t}\n\n\t\tif (this.isDragEnabled())\n\t\t{\n\t\t\tthis.initializeDragDropAbilities();\n\t\t}\n\n\t\tthis.registerLayout(options);\n\t\tthis._hasLayout = true;\n\t}\n\n\tcreateTitleMarker()\n\t{\n\t\tif(this._mode === BX.UI.EntityEditorMode.view)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tif (this._restrictionsCallback && this._restrictionsCallback.length)\n\t\t{\n\t\t\tlet lockIcon = Tag.render` <span class=\"tariff-lock\"></span>`;\n\t\t\tlockIcon.setAttribute('onclick', this._restrictionsCallback);\n\t\t\treturn lockIcon;\n\t\t}\n\n\t\treturn super.createTitleMarker();\n\t}\n\n\tonAddressListUpdate()\n\t{\n\t\tthis.markAsChanged();\n\t}\n\n\tonStartLoadAddress()\n\t{\n\t\tlet toolPanel = this.getEditor()._toolPanel;\n\t\tif (toolPanel)\n\t\t{\n\t\t\ttoolPanel.setLocked(true);\n\t\t}\n\t}\n\n\tonAddressLoaded()\n\t{\n\t\tlet toolPanel = this.getEditor()._toolPanel;\n\t\tif (toolPanel)\n\t\t{\n\t\t\ttoolPanel.setLocked(false);\n\t\t}\n\t}\n\n\tonError(event)\n\t{\n\t\tconst data = event.getData();\n\t\tthis.showError(data.error);\n\n\t\tconst toolPanel = this.getEditor()._toolPanel;\n\t\tif (toolPanel)\n\t\t{\n\t\t\ttoolPanel.setLocked(false);\n\t\t}\n\t}\n\n\tstatic onInitializeEditorControlFactory(event)\n\t{\n\t\tlet data = event.getData();\n\t\tif (data[0])\n\t\t{\n\t\t\tdata[0].methods[\"crm_address\"] = (type, controlId, settings) =>\n\t\t\t{\n\t\t\t\tif (type === \"crm_address\")\n\t\t\t\t{\n\t\t\t\t\treturn EntityEditorUiAddressField.create(controlId, settings);\n\t\t\t\t}\n\t\t\t\treturn null;\n\t\t\t};\n\t\t}\n\t\tevent.setData(data);\n\t}\n\n\tstatic create(id, settings)\n\t{\n\t\tlet self = new this(id, settings);\n\t\tself.initialize(id, settings);\n\t\treturn self;\n\t}\n}\n\nEventEmitter.subscribe('BX.UI.EntityEditorControlFactory:onInitialize', EntityEditorUiAddressField.onInitializeEditorControlFactory);"],"names":["EntityEditorUiAddressField","_field","_autocompleteEnabled","_restrictionsCallback","id","settings","params","_schemeElement","getData","BX","prop","getBoolean","getString","enableAutocomplete","hideDefaultAddressType","addressZoneConfig","getObject","defaultAddressTypeByCategory","getInteger","EntityEditorBaseAddressField","create","setMultiple","setTypesList","EventEmitter","subscribe","onAddressListUpdate","bind","onStartLoadAddress","onAddressLoaded","onError","_valueNode","_modelTypes","initializeFromModel","value","prepareValue","getValue","Object","keys","setValue","Type","isPlainObject","isDomNode","Dom","clean","values","type","address","length","fieldNamePrefix","getName","hasOwnProperty","name","isStringFilled","node","Tag","render","append","options","_hasLayout","ensureWrapperCreated","classNames","adjustWrapper","isNeedToDisplay","registerLayout","isDragEnabled","createDragButton","_wrapper","createTitleNode","getTitle","fieldContainer","layout","_mode","UI","EntityEditorMode","edit","classList","add","appendChild","isContextMenuEnabled","createContextMenuButton","initializeDragDropAbilities","view","lockIcon","setAttribute","markAsChanged","toolPanel","getEditor","_toolPanel","setLocked","event","data","showError","error","methods","controlId","setData","self","initialize","EntityEditorField","onInitializeEditorControlFactory"],"mappings":"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"}