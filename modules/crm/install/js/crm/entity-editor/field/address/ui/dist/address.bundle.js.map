{"version":3,"file":"address.bundle.js","sources":["../src/address.js"],"sourcesContent":["import {EntityEditorBaseAddressField} from \"crm.entity-editor.field.address.base\";\nimport {Tag, Dom, Type} from \"main.core\";\nimport {EventEmitter} from \"main.core.events\";\n\nexport class EntityEditorUiAddressField extends BX.UI.EntityEditorField\n{\n\tconstructor()\n\t{\n\t\tsuper();\n\t\tthis._field = null;\n\t\tthis._autocompleteEnabled = false;\n\t\tthis._restrictionsCallback = null;\n\t}\n\n\tinitialize(id, settings)\n\t{\n\t\tsuper.initialize(id, settings);\n\t\tlet params = this._schemeElement.getData();\n\n\t\tthis._autocompleteEnabled = BX.prop.getBoolean(params, \"autocompleteEnabled\", false);\n\t\tif (!this._autocompleteEnabled)\n\t\t{\n\t\t\tthis._restrictionsCallback = BX.prop.getString(params, \"featureRestrictionCallback\", '');\n\t\t}\n\t\tsettings.enableAutocomplete = this._autocompleteEnabled;\n\t\tsettings.hideDefaultAddressType = true;\n\t\tsettings.addressZoneConfig = BX.prop.getObject(params, \"addressZoneConfig\", {});\n\t\tthis._field = EntityEditorBaseAddressField.create(id, settings);\n\t\tthis._field.setMultiple(true);\n\t\tthis._field.setTypesList(BX.prop.getObject(params, \"types\", {}));\n\t\tEventEmitter.subscribe(this._field, 'onUpdate', this.onAddressListUpdate.bind(this));\n\t\tEventEmitter.subscribe(this._field, 'onStartLoadAddress', this.onStartLoadAddress.bind(this));\n\t\tEventEmitter.subscribe(this._field, 'onAddressLoaded', this.onAddressLoaded.bind(this));\n\t\tEventEmitter.subscribe(this._field, 'onError', this.onError.bind(this));\n\t\tthis._valueNode = null;\n\t\tthis._modelTypes = [];\n\n\t\tthis.initializeFromModel();\n\t}\n\n\tinitializeFromModel()\n\t{\n\t\tlet value = this.prepareValue(this.getValue());\n\t\tthis._modelTypes = Object.keys(value);\n\t\tthis._field.setValue(value);\n\t}\n\n\tprepareValue(value)\n\t{\n\t\treturn Type.isPlainObject(value) ? value : {};\n\t}\n\n\tonBeforeSubmit()\n\t{\n\n\t\tif (!Type.isDomNode(this._valueNode))\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tDom.clean(this._valueNode);\n\n\t\tlet values = {};\n\t\tfor (let type of this._modelTypes)\n\t\t{\n\t\t\tvalues[type] = \"\";\n\t\t}\n\t\tfor (let address of this._field.getValue())\n\t\t{\n\t\t\tif (address.value.length)\n\t\t\t{\n\t\t\t\tvalues[address.type] = address.value;\n\t\t\t}\n\t\t}\n\n\t\tlet fieldNamePrefix = this.getName();\n\t\tfor (let type in values)\n\t\t{\n\t\t\tif (!values.hasOwnProperty(type))\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tlet value = values[type];\n\t\t\tlet name ='';\n\t\t\tif (Type.isStringFilled(value))\n\t\t\t{\n\t\t\t\tname = `${fieldNamePrefix}[${type}]`;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tname = `${fieldNamePrefix}[${type}][DELETED]`;\n\t\t\t\tvalue = 'Y';\n\t\t\t}\n\n\t\t\tlet node = Tag.render`<input type=\"hidden\">`;\n\t\t\tnode.name = name;\n\t\t\tnode.value = value;\n\t\t\tDom.append(node, this._valueNode);\n\t\t}\n\t}\n\n\trefreshLayout(options)\n\t{\n\t\tthis.initializeFromModel();\n\t\tsuper.refreshLayout(options);\n\t}\n\n\tlayout(options)\n\t{\n\t\tif (this._hasLayout)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.ensureWrapperCreated({classNames: [\"ui-entity-editor-content-block-field-address crm-entity-widget-content-block\"]});\n\t\tthis.adjustWrapper();\n\n\t\tif (!this.isNeedToDisplay())\n\t\t{\n\t\t\tthis.registerLayout(options);\n\t\t\tthis._hasLayout = true;\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.isDragEnabled())\n\t\t{\n\t\t\tDom.append(this.createDragButton(), this._wrapper);\n\t\t}\n\n\t\tDom.append(this.createTitleNode(this.getTitle()), this._wrapper);\n\n\t\tlet fieldContainer = this._field.layout(this._mode === BX.UI.EntityEditorMode.edit);\n\t\tfieldContainer.classList.add('ui-entity-editor-content-block');\n\t\tthis._wrapper.appendChild(fieldContainer);\n\n\t\tthis._valueNode = Tag.render`<span></span>`;\n\t\tthis._wrapper.appendChild(this._valueNode);\n\n\t\tif (this.isContextMenuEnabled())\n\t\t{\n\t\t\tthis._wrapper.appendChild(this.createContextMenuButton());\n\t\t}\n\n\t\tif (this.isDragEnabled())\n\t\t{\n\t\t\tthis.initializeDragDropAbilities();\n\t\t}\n\n\t\tthis.registerLayout(options);\n\t\tthis._hasLayout = true;\n\t}\n\n\tcreateTitleMarker()\n\t{\n\t\tif(this._mode === BX.UI.EntityEditorMode.view)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tif (this._restrictionsCallback && this._restrictionsCallback.length)\n\t\t{\n\t\t\tlet lockIcon = Tag.render` <span class=\"tariff-lock\"></span>`;\n\t\t\tlockIcon.setAttribute('onclick', this._restrictionsCallback);\n\t\t\treturn lockIcon;\n\t\t}\n\n\t\treturn super.createTitleMarker();\n\t}\n\n\tonAddressListUpdate()\n\t{\n\t\tthis.markAsChanged();\n\t}\n\n\tonStartLoadAddress()\n\t{\n\t\tlet toolPanel = this.getEditor()._toolPanel;\n\t\tif (toolPanel)\n\t\t{\n\t\t\ttoolPanel.setLocked(true);\n\t\t}\n\t}\n\n\tonAddressLoaded()\n\t{\n\t\tlet toolPanel = this.getEditor()._toolPanel;\n\t\tif (toolPanel)\n\t\t{\n\t\t\ttoolPanel.setLocked(false);\n\t\t}\n\t}\n\n\tonError(event)\n\t{\n\t\tconst data = event.getData();\n\t\tthis.showError(data.error);\n\n\t\tconst toolPanel = this.getEditor()._toolPanel;\n\t\tif (toolPanel)\n\t\t{\n\t\t\ttoolPanel.setLocked(false);\n\t\t}\n\t}\n\n\tstatic onInitializeEditorControlFactory(event)\n\t{\n\t\tlet data = event.getData();\n\t\tif (data[0])\n\t\t{\n\t\t\tdata[0].methods[\"crm_address\"] = (type, controlId, settings) =>\n\t\t\t{\n\t\t\t\tif (type === \"crm_address\")\n\t\t\t\t{\n\t\t\t\t\treturn EntityEditorUiAddressField.create(controlId, settings);\n\t\t\t\t}\n\t\t\t\treturn null;\n\t\t\t};\n\t\t}\n\t\tevent.setData(data);\n\t}\n\n\tstatic create(id, settings)\n\t{\n\t\tlet self = new this(id, settings);\n\t\tself.initialize(id, settings);\n\t\treturn self;\n\t}\n}\n\nEventEmitter.subscribe('BX.UI.EntityEditorControlFactory:onInitialize', EntityEditorUiAddressField.onInitializeEditorControlFactory);"],"names":["EntityEditorUiAddressField","_field","_autocompleteEnabled","_restrictionsCallback","id","settings","params","_schemeElement","getData","BX","prop","getBoolean","getString","enableAutocomplete","hideDefaultAddressType","addressZoneConfig","getObject","EntityEditorBaseAddressField","create","setMultiple","setTypesList","EventEmitter","subscribe","onAddressListUpdate","bind","onStartLoadAddress","onAddressLoaded","onError","_valueNode","_modelTypes","initializeFromModel","value","prepareValue","getValue","Object","keys","setValue","Type","isPlainObject","isDomNode","Dom","clean","values","type","address","length","fieldNamePrefix","getName","hasOwnProperty","name","isStringFilled","node","Tag","render","append","options","_hasLayout","ensureWrapperCreated","classNames","adjustWrapper","isNeedToDisplay","registerLayout","isDragEnabled","createDragButton","_wrapper","createTitleNode","getTitle","fieldContainer","layout","_mode","UI","EntityEditorMode","edit","classList","add","appendChild","isContextMenuEnabled","createContextMenuButton","initializeDragDropAbilities","view","lockIcon","setAttribute","markAsChanged","toolPanel","getEditor","_toolPanel","setLocked","event","data","showError","error","methods","controlId","setData","self","initialize","EntityEditorField","onInitializeEditorControlFactory"],"mappings":";;;;;;;;;;;KAIaA,0BAAb;GAAA;;GAEC,sCACA;KAAA;;KAAA;KACC;KACA,MAAKC,MAAL,GAAc,IAAd;KACA,MAAKC,oBAAL,GAA4B,KAA5B;KACA,MAAKC,qBAAL,GAA6B,IAA7B;KAJD;;;GAHD;KAAA;KAAA,2BAUYC,EAVZ,EAUgBC,QAVhB,EAWC;OACC,mHAAiBD,EAAjB,EAAqBC,QAArB;;OACA,IAAIC,MAAM,GAAG,KAAKC,cAAL,CAAoBC,OAApB,EAAb;;OAEA,KAAKN,oBAAL,GAA4BO,EAAE,CAACC,IAAH,CAAQC,UAAR,CAAmBL,MAAnB,EAA2B,qBAA3B,EAAkD,KAAlD,CAA5B;;OACA,IAAI,CAAC,KAAKJ,oBAAV,EACA;SACC,KAAKC,qBAAL,GAA6BM,EAAE,CAACC,IAAH,CAAQE,SAAR,CAAkBN,MAAlB,EAA0B,4BAA1B,EAAwD,EAAxD,CAA7B;;;OAEDD,QAAQ,CAACQ,kBAAT,GAA8B,KAAKX,oBAAnC;OACAG,QAAQ,CAACS,sBAAT,GAAkC,IAAlC;OACAT,QAAQ,CAACU,iBAAT,GAA6BN,EAAE,CAACC,IAAH,CAAQM,SAAR,CAAkBV,MAAlB,EAA0B,mBAA1B,EAA+C,EAA/C,CAA7B;OACA,KAAKL,MAAL,GAAcgB,gEAA4B,CAACC,MAA7B,CAAoCd,EAApC,EAAwCC,QAAxC,CAAd;;OACA,KAAKJ,MAAL,CAAYkB,WAAZ,CAAwB,IAAxB;;OACA,KAAKlB,MAAL,CAAYmB,YAAZ,CAAyBX,EAAE,CAACC,IAAH,CAAQM,SAAR,CAAkBV,MAAlB,EAA0B,OAA1B,EAAmC,EAAnC,CAAzB;;OACAe,6BAAY,CAACC,SAAb,CAAuB,KAAKrB,MAA5B,EAAoC,UAApC,EAAgD,KAAKsB,mBAAL,CAAyBC,IAAzB,CAA8B,IAA9B,CAAhD;OACAH,6BAAY,CAACC,SAAb,CAAuB,KAAKrB,MAA5B,EAAoC,oBAApC,EAA0D,KAAKwB,kBAAL,CAAwBD,IAAxB,CAA6B,IAA7B,CAA1D;OACAH,6BAAY,CAACC,SAAb,CAAuB,KAAKrB,MAA5B,EAAoC,iBAApC,EAAuD,KAAKyB,eAAL,CAAqBF,IAArB,CAA0B,IAA1B,CAAvD;OACAH,6BAAY,CAACC,SAAb,CAAuB,KAAKrB,MAA5B,EAAoC,SAApC,EAA+C,KAAK0B,OAAL,CAAaH,IAAb,CAAkB,IAAlB,CAA/C;OACA,KAAKI,UAAL,GAAkB,IAAlB;OACA,KAAKC,WAAL,GAAmB,EAAnB;OAEA,KAAKC,mBAAL;;;KAjCF;KAAA,sCAqCC;OACC,IAAIC,KAAK,GAAG,KAAKC,YAAL,CAAkB,KAAKC,QAAL,EAAlB,CAAZ;OACA,KAAKJ,WAAL,GAAmBK,MAAM,CAACC,IAAP,CAAYJ,KAAZ,CAAnB;;OACA,KAAK9B,MAAL,CAAYmC,QAAZ,CAAqBL,KAArB;;;KAxCF;KAAA,6BA2CcA,KA3Cd,EA4CC;OACC,OAAOM,cAAI,CAACC,aAAL,CAAmBP,KAAnB,IAA4BA,KAA5B,GAAoC,EAA3C;;;KA7CF;KAAA,iCAiDC;OAEC,IAAI,CAACM,cAAI,CAACE,SAAL,CAAe,KAAKX,UAApB,CAAL,EACA;SACC;;;OAEDY,aAAG,CAACC,KAAJ,CAAU,KAAKb,UAAf;OAEA,IAAIc,MAAM,GAAG,EAAb;;OARD,2CASkB,KAAKb,WATvB;;;OAAA;SASC,oDACA;WAAA,IADSc,KACT;WACCD,MAAM,CAACC,KAAD,CAAN,GAAe,EAAf;;;SAXF;;SAAA;;;OAAA,4CAaqB,KAAK1C,MAAL,CAAYgC,QAAZ,EAbrB;;;OAAA;SAaC,uDACA;WAAA,IADSW,OACT;;WACC,IAAIA,OAAO,CAACb,KAAR,CAAcc,MAAlB,EACA;aACCH,MAAM,CAACE,OAAO,CAACD,IAAT,CAAN,GAAuBC,OAAO,CAACb,KAA/B;;;;SAjBH;;SAAA;;;OAqBC,IAAIe,eAAe,GAAG,KAAKC,OAAL,EAAtB;;OACA,KAAK,IAAIJ,IAAT,IAAiBD,MAAjB,EACA;SACC,IAAI,CAACA,MAAM,CAACM,cAAP,CAAsBL,IAAtB,CAAL,EACA;WACC;;;SAED,IAAIZ,KAAK,GAAGW,MAAM,CAACC,IAAD,CAAlB;SACA,IAAIM,IAAI,GAAE,EAAV;;SACA,IAAIZ,cAAI,CAACa,cAAL,CAAoBnB,KAApB,CAAJ,EACA;WACCkB,IAAI,aAAMH,eAAN,cAAyBH,IAAzB,MAAJ;UAFD,MAKA;WACCM,IAAI,aAAMH,eAAN,cAAyBH,IAAzB,eAAJ;WACAZ,KAAK,GAAG,GAAR;;;SAGD,IAAIoB,IAAI,GAAGC,aAAG,CAACC,MAAP,wGAAR;SACAF,IAAI,CAACF,IAAL,GAAYA,IAAZ;SACAE,IAAI,CAACpB,KAAL,GAAaA,KAAb;SACAS,aAAG,CAACc,MAAJ,CAAWH,IAAX,EAAiB,KAAKvB,UAAtB;;;;KA5FH;KAAA,8BAgGe2B,OAhGf,EAiGC;OACC,KAAKzB,mBAAL;OACA,sHAAoByB,OAApB;;;KAnGF;KAAA,uBAsGQA,OAtGR,EAuGC;OACC,IAAI,KAAKC,UAAT,EACA;SACC;;;OAGD,KAAKC,oBAAL,CAA0B;SAACC,UAAU,EAAE,CAAC,8EAAD;QAAvC;OACA,KAAKC,aAAL;;OAEA,IAAI,CAAC,KAAKC,eAAL,EAAL,EACA;SACC,KAAKC,cAAL,CAAoBN,OAApB;SACA,KAAKC,UAAL,GAAkB,IAAlB;SACA;;;OAGD,IAAI,KAAKM,aAAL,EAAJ,EACA;SACCtB,aAAG,CAACc,MAAJ,CAAW,KAAKS,gBAAL,EAAX,EAAoC,KAAKC,QAAzC;;;OAGDxB,aAAG,CAACc,MAAJ,CAAW,KAAKW,eAAL,CAAqB,KAAKC,QAAL,EAArB,CAAX,EAAkD,KAAKF,QAAvD;;OAEA,IAAIG,cAAc,GAAG,KAAKlE,MAAL,CAAYmE,MAAZ,CAAmB,KAAKC,KAAL,KAAe5D,EAAE,CAAC6D,EAAH,CAAMC,gBAAN,CAAuBC,IAAzD,CAArB;;OACAL,cAAc,CAACM,SAAf,CAAyBC,GAAzB,CAA6B,gCAA7B;;OACA,KAAKV,QAAL,CAAcW,WAAd,CAA0BR,cAA1B;;OAEA,KAAKvC,UAAL,GAAkBwB,aAAG,CAACC,MAAtB;;OACA,KAAKW,QAAL,CAAcW,WAAd,CAA0B,KAAK/C,UAA/B;;OAEA,IAAI,KAAKgD,oBAAL,EAAJ,EACA;SACC,KAAKZ,QAAL,CAAcW,WAAd,CAA0B,KAAKE,uBAAL,EAA1B;;;OAGD,IAAI,KAAKf,aAAL,EAAJ,EACA;SACC,KAAKgB,2BAAL;;;OAGD,KAAKjB,cAAL,CAAoBN,OAApB;OACA,KAAKC,UAAL,GAAkB,IAAlB;;;KAhJF;KAAA,oCAoJC;OACC,IAAG,KAAKa,KAAL,KAAe5D,EAAE,CAAC6D,EAAH,CAAMC,gBAAN,CAAuBQ,IAAzC,EACA;SACC,OAAO,IAAP;;;OAGD,IAAI,KAAK5E,qBAAL,IAA8B,KAAKA,qBAAL,CAA2B0C,MAA7D,EACA;SACC,IAAImC,QAAQ,GAAG5B,aAAG,CAACC,MAAP,uHAAZ;SACA2B,QAAQ,CAACC,YAAT,CAAsB,SAAtB,EAAiC,KAAK9E,qBAAtC;SACA,OAAO6E,QAAP;;;OAGD;;;KAjKF;KAAA,sCAqKC;OACC,KAAKE,aAAL;;;KAtKF;KAAA,qCA0KC;OACC,IAAIC,SAAS,GAAG,KAAKC,SAAL,GAAiBC,UAAjC;;OACA,IAAIF,SAAJ,EACA;SACCA,SAAS,CAACG,SAAV,CAAoB,IAApB;;;;KA9KH;KAAA,kCAmLC;OACC,IAAIH,SAAS,GAAG,KAAKC,SAAL,GAAiBC,UAAjC;;OACA,IAAIF,SAAJ,EACA;SACCA,SAAS,CAACG,SAAV,CAAoB,KAApB;;;;KAvLH;KAAA,wBA2LSC,KA3LT,EA4LC;OACC,IAAMC,IAAI,GAAGD,KAAK,CAAC/E,OAAN,EAAb;OACA,KAAKiF,SAAL,CAAeD,IAAI,CAACE,KAApB;;OAEA,IAAMP,SAAS,GAAG,KAAKC,SAAL,GAAiBC,UAAnC;;OACA,IAAIF,SAAJ,EACA;SACCA,SAAS,CAACG,SAAV,CAAoB,KAApB;;;;KAnMH;KAAA,iDAuMyCC,KAvMzC,EAwMC;OACC,IAAIC,IAAI,GAAGD,KAAK,CAAC/E,OAAN,EAAX;;OACA,IAAIgF,IAAI,CAAC,CAAD,CAAR,EACA;SACCA,IAAI,CAAC,CAAD,CAAJ,CAAQG,OAAR,CAAgB,aAAhB,IAAiC,UAAChD,IAAD,EAAOiD,SAAP,EAAkBvF,QAAlB,EACjC;WACC,IAAIsC,IAAI,KAAK,aAAb,EACA;aACC,OAAO3C,0BAA0B,CAACkB,MAA3B,CAAkC0E,SAAlC,EAA6CvF,QAA7C,CAAP;;;WAED,OAAO,IAAP;UAND;;;OASDkF,KAAK,CAACM,OAAN,CAAcL,IAAd;;;KArNF;KAAA,uBAwNepF,EAxNf,EAwNmBC,QAxNnB,EAyNC;OACC,IAAIyF,IAAI,GAAG,IAAI,IAAJ,CAAS1F,EAAT,EAAaC,QAAb,CAAX;OACAyF,IAAI,CAACC,UAAL,CAAgB3F,EAAhB,EAAoBC,QAApB;OACA,OAAOyF,IAAP;;;GA5NF;CAAA,EAAgDrF,EAAE,CAAC6D,EAAH,CAAM0B,iBAAtD;AAgOA3E,8BAAY,CAACC,SAAb,CAAuB,+CAAvB,EAAwEtB,0BAA0B,CAACiG,gCAAnG;;;;;;;;"}