this.BX=this.BX||{};(function(e,t,s,i){"use strict";var a,n,r,d,o,l,u,p,h,c,y,f,v,g,_,T,b,m,A,I,L,C,k,w;function D(e,t){var s=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!s){if(Array.isArray(e)||(s=B(e))||t&&e&&typeof e.length==="number"){if(s)e=s;var i=0;var a=function e(){};return{s:a,n:function t(){if(i>=e.length)return{done:true};return{done:false,value:e[i++]}},e:function e(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n=true,r=false,d;return{s:function t(){s=s.call(e)},n:function e(){var t=s.next();n=t.done;return t},e:function e(t){r=true;d=t},f:function e(){try{if(!n&&s["return"]!=null)s["return"]()}finally{if(r)throw d}}}}function B(e,t){if(!e)return;if(typeof e==="string")return M(e,t);var s=Object.prototype.toString.call(e).slice(8,-1);if(s==="Object"&&e.constructor)s=e.constructor.name;if(s==="Map"||s==="Set")return Array.from(e);if(s==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return M(e,t)}function M(e,t){if(t==null||t>e.length)t=e.length;for(var s=0,i=new Array(t);s<t;s++){i[s]=e[s]}return i}var N=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,s){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._isMultiple=false;this._settings=s?s:{};this._typesList=[];this._availableTypesIds=[];this._allowedTypeIds=[];this._addressList=[];this._wrapper=null;this._isEditMode=true;this._showFirstItemOnly=BX.prop.getBoolean(s,"showFirstItemOnly",false);this._enableAutocomplete=BX.prop.getBoolean(s,"enableAutocomplete",true);this._hideDefaultAddressType=BX.prop.getBoolean(this._settings,"hideDefaultAddressType",false);this._showAddressTypeInViewMode=BX.prop.getBoolean(this._settings,"showAddressTypeInViewMode",false);this._addrZoneConfig=BX.prop.getObject(this._settings,"addressZoneConfig",{});this._countryId=BX.prop.getInteger(this._settings,"countryId",BX.prop.getInteger(this._addrZoneConfig,"countryId",0));this._defaultAddressType=BX.prop.getInteger(this._settings,"defaultAddressTypeByCategory",0);if(this._defaultAddressType<=0){this._defaultAddressType=BX.prop.getInteger(this._addrZoneConfig,"defaultAddressType",0)}this.updateAllowedTypes()}},{key:"setMultiple",value:function e(t){this._isMultiple=!!t}},{key:"setValue",value:function e(s){if(this._isMultiple){var i=t.Type.isPlainObject(s)?s:{};var a=Object.keys(i);var n=this._addressList.length>0&&a.length==this._addressList.length;if(n){var r=D(this._addressList),d;try{for(r.s();!(d=r.n()).done;){var o=d.value;var l=o.getType();if(!i.hasOwnProperty(l)||i[l]!==o.getValue()){n=false;break}}}catch(e){r.e(e)}finally{r.f()}}if(!n&&!a.length&&this._addressList.length===1&&!this._addressList[0].getValue().length){n=true}if(n){return false}this.removeAllAddresses();for(var u=0,p=a;u<p.length;u++){var h=p[u];this.addAddress(h,i[h])}if(!a.length){this.addAddress(this.getDefaultType(),null)}}else{this.removeAllAddresses();var c=t.Type.isStringFilled(s)?s:null;this.addAddress(null,c)}return true}},{key:"getValue",value:function e(){if(this._isMultiple){var s=[];var i=D(this._addressList),a;try{for(i.s();!(a=i.n()).done;){var n=a.value;var r=n.getValue();if(t.Type.isString(r)){s.push({type:n.getType(),value:r})}}}catch(e){i.e(e)}finally{i.f()}return s}else{if(this._addressList&&this._addressList[0]&&t.Type.isString(this._addressList[0].getValue())){return this._addressList[0].getValue()}return null}}},{key:"setTypesList",value:function e(s){this._typesList=[];if(t.Type.isPlainObject(s)){for(var i=0,a=Object.keys(s);i<a.length;i++){var n=a[i];this._typesList.push(s[n])}}this.initAvailableTypes()}},{key:"getTypesList",value:function e(){var t=[];var s=D(this._typesList),i;try{for(s.s();!(i=s.n()).done;){var a=i.value;var n=BX.prop.getString(a,"ID","");var r=BX.prop.getString(a,"DESCRIPTION","");t.push({name:r,value:n})}}catch(e){s.e(e)}finally{s.f()}return t}},{key:"setAllowedTypes",value:function e(s){this._allowedTypeIds=[];if(t.Type.isArray(s)){this._allowedTypeIds=s}}},{key:"getAllowedTypes",value:function e(){return this._allowedTypeIds}},{key:"setCountryId",value:function e(t){var s=false;t=parseInt(t);if(this._countryId!==t){s=true}this._countryId=t;if(s){this.updateAllowedTypes()}}},{key:"getCountryId",value:function e(){return this._countryId}},{key:"getAddressZoneConfig",value:function e(){return this._addrZoneConfig}},{key:"getValueTypes",value:function e(){var t=[];var s=D(this._addressList),i;try{for(s.s();!(i=s.n()).done;){var a=i.value;var n=parseInt(a.getType());if(t.indexOf(n)<0){t.push(n)}}}catch(e){s.e(e)}finally{s.f()}return t}},{key:"updateAllowedTypes",value:function e(){var s=[];var i=this.getValueTypes();var a=this.getCountryId();var n=this.getAddressZoneConfig();if(t.Type.isPlainObject(n)){if(n.hasOwnProperty("currentZoneAddressTypes")&&t.Type.isArray(n["currentZoneAddressTypes"])){var r;var d;var o=n["currentZoneAddressTypes"];for(r=0;r<o.length;r++){d=parseInt(o[r]);if(s.indexOf(d)<0){s.push(d)}}if(a>0&&n.hasOwnProperty("countryAddressTypeMap")&&t.Type.isPlainObject(n["countryAddressTypeMap"])&&n["countryAddressTypeMap"].hasOwnProperty(a)&&t.Type.isArray(n["countryAddressTypeMap"][a])){var l=n["countryAddressTypeMap"][a];for(r=0;r<l.length;r++){d=parseInt(l[r]);if(s.indexOf(d)<0){s.push(d)}}}for(r=0;r<i.length;r++){d=parseInt(i[r]);if(s.indexOf(d)<0){s.push(d)}}}}this._allowedTypeIds=s;var u=D(this._addressList),p;try{for(u.s();!(p=u.n()).done;){var h=p.value;h.setAllowedTypesIds(babelHelpers.toConsumableArray(this._allowedTypeIds))}}catch(e){u.e(e)}finally{u.f()}}},{key:"getDefaultType",value:function e(){var t=this._defaultAddressType.toString();if(t>0&&this._availableTypesIds.indexOf(t)>=0&&this._allowedTypeIds.indexOf(parseInt(t))>=0){return t}var s=D(this._typesList),i;try{for(s.s();!(i=s.n()).done;){var a=i.value;var n=BX.prop.getString(a,"ID","");var r=BX.prop.getString(a,"IS_DEFAULT",false);if(r&&this._availableTypesIds.indexOf(n)>=0&&this._allowedTypeIds.indexOf(parseInt(n))>=0){return n}}}catch(e){s.e(e)}finally{s.f()}var d=D(this._typesList),o;try{for(d.s();!(o=d.n()).done;){var l=o.value;var u=BX.prop.getString(l,"ID","");if(this._availableTypesIds.indexOf(u)>=0&&this._allowedTypeIds.indexOf(parseInt(u))>=0){return u}}}catch(e){d.e(e)}finally{d.f()}return null}},{key:"layout",value:function e(s){this._isEditMode=s;this._wrapper=t.Tag.render(a||(a=babelHelpers.taggedTemplateLiteral(['<div class="crm-address-control-wrap ','"></div>'])),this._isEditMode?"crm-address-control-wrap-edit":"");this.refreshLayout();return this._wrapper}},{key:"refreshLayout",value:function e(){t.Dom.clean(this._wrapper);var s=true;var i=D(this._addressList),a;try{for(i.s();!(a=i.n()).done;){var d=a.value;d.setEditMode(this._isEditMode);if(!this._isEditMode&&this._showFirstItemOnly&&s>1){var o=t.Tag.render(r||(r=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span class="ui-link ui-link-secondary ui-link-dotted" onmouseup="','"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>"])),this.onShowMoreMouseUp.bind(this),t.Loc.getMessage("CRM_ADDRESS_SHOW_ALL"));t.Dom.append(o,this._wrapper);break}else{t.Dom.append(d.layout(),this._wrapper)}s++}}catch(e){i.e(e)}finally{i.f()}if(this._isEditMode&&this._isMultiple&&!t.Type.isNull(this.getDefaultType())){var l=BX.prop.getBoolean(this._settings,"crmCompatibilityMode",false);var u=l?"crm-entity-widget-content-block-add-field":"ui-entity-widget-content-block-add-field";var p=l?"crm-entity-widget-content-add-field":"ui-entity-editor-content-add-lnk";t.Dom.append(t.Tag.render(n||(n=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="','"><span class="','" onclick="','">',"</span></div>\n\t\t\t"])),u,p,this.onAddNewAddress.bind(this),t.Loc.getMessage("CRM_ADDRESS_ADD")),this._wrapper)}}},{key:"release",value:function e(){t.Dom.clean(this._wrapper);this.removeAllAddresses()}},{key:"removeAllAddresses",value:function e(){var t=this._addressList.map((function(e){return e.getId()}));var s=D(t),i;try{for(s.s();!(i=s.n()).done;){var a=i.value;this.removeAddress(a)}}catch(e){s.e(e)}finally{s.f()}}},{key:"addAddress",value:function e(s){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var a=new S(t.Text.getRandom(8),{typesList:this.getTypesList(),availableTypesIds:babelHelpers.toConsumableArray(this._availableTypesIds),allowedTypesIds:babelHelpers.toConsumableArray(this._allowedTypeIds),canChangeType:this._isMultiple,enableAutocomplete:this._enableAutocomplete,showAddressTypeInViewMode:this._isMultiple&&this._showAddressTypeInViewMode,type:s,value:i});a.subscribe("onUpdateAddress",this.onUpdateAddress.bind(this));a.subscribe("onUpdateAddressType",this.onUpdateAddressType.bind(this));a.subscribe("onDelete",this.onDeleteAddress.bind(this));a.subscribe("onStartLoadAddress",this.onStartLoadAddress.bind(this));a.subscribe("onAddressLoaded",this.onAddressLoaded.bind(this));a.subscribe("onAddressDataInputting",this.onAddressDataInputting.bind(this));a.subscribe("onError",this.onError.bind(this));a.subscribe("onCopyAddress",this.onCopyAddress.bind(this));this.updateAvailableTypes(s,null);this._addressList.push(a);this.updateAllowedTypes();this.updateTypeSelectorVisibility(this._addressList.length>1);return a}},{key:"removeAddress",value:function e(t){var s=this.getAddressById(t);if(s){var i=s.getType();this._addressList.splice(this._addressList.indexOf(s),1);this.updateAvailableTypes(null,i);this.updateAllowedTypes();this.updateTypeSelectorVisibility(this._addressList.length>1);s.destroy()}}},{key:"getAddressById",value:function e(t){return this._addressList.filter((function(e){return e.getId()===t})).reduce((function(e,t){return e?e:t}),null)}},{key:"initAvailableTypes",value:function e(){this._availableTypesIds=[];var t=D(this._typesList),s;try{for(t.s();!(s=t.n()).done;){var i=s.value;this._availableTypesIds.push(BX.prop.getString(i,"ID",""))}}catch(e){t.e(e)}finally{t.f()}}},{key:"updateAvailableTypes",value:function e(s,i){if(!t.Type.isNull(i)&&this._availableTypesIds.indexOf(i)<0){this._availableTypesIds.push(i)}if(!t.Type.isNull(s)&&this._availableTypesIds.indexOf(s)>=0){this._availableTypesIds.splice(this._availableTypesIds.indexOf(s),1)}var a=D(this._addressList),n;try{for(a.s();!(n=a.n()).done;){var r=n.value;r.setAvailableTypesIds(babelHelpers.toConsumableArray(this._availableTypesIds))}}catch(e){a.e(e)}finally{a.f()}}},{key:"updateTypeSelectorVisibility",value:function e(t){if(!this._hideDefaultAddressType){return}var s=D(this._addressList),i;try{for(s.s();!(i=s.n()).done;){var a=i.value;a.setTypeSelectorVisibility(t)}}catch(e){s.e(e)}finally{s.f()}}},{key:"emitUpdateEvent",value:function e(){s.EventEmitter.emit(this,"onUpdate",{value:this.getValue()})}},{key:"onAddNewAddress",value:function e(){this.addAddress(this.getDefaultType());this.refreshLayout()}},{key:"onUpdateAddress",value:function e(t){this.emitUpdateEvent()}},{key:"onDeleteAddress",value:function e(t){var s=t.getData();var i=s.id;if(this._addressList.length<=1){var a=this.getAddressById(i);if(a){a.clearValue()}return}this.removeAddress(i);this.refreshLayout()}},{key:"onUpdateAddressType",value:function e(t){var s=t.getData();var i=s.prevType;var a=s.type;this.updateAvailableTypes(a,i);this.updateAllowedTypes();this.emitUpdateEvent()}},{key:"onShowMoreMouseUp",value:function e(t){t.stopPropagation();this._showFirstItemOnly=false;this.refreshLayout();return false}},{key:"onStartLoadAddress",value:function e(t){s.EventEmitter.emit(this,"onStartLoadAddress")}},{key:"onAddressLoaded",value:function e(t){s.EventEmitter.emit(this,"onAddressLoaded")}},{key:"onAddressDataInputting",value:function e(t){s.EventEmitter.emit(this,"onAddressDataInputting")}},{key:"onError",value:function e(t){s.EventEmitter.emit(this,"onError",t)}},{key:"onCopyAddress",value:function e(t){var s=this;var i=t.getData();var a=this.getAddressById(i.sourceId);if(!a){return}var n=a.getValue();if(!n.length){return}var r=function e(t){var a=i.destinationTypes[t];var r=s._addressList.filter((function(e){return e.getType()==a})).reduce((function(e,t){return e?e:t}),null);if(r){r.setValue(n)}else{r=s.addAddress(a,n)}r.markAsNew();s.refreshLayout()};for(var d=0;d<i.destinationTypes.length;d++){r(d)}this.emitUpdateEvent()}},{key:"resetView",value:function e(){var t=D(this._addressList),s;try{for(t.s();!(s=t.n()).done;){var i=s.value;i.resetView()}}catch(e){t.e(e)}finally{t.f()}}}],[{key:"create",value:function t(s,i){var a=new e;a.initialize(s,i);return a}}]);return e}();var S=function(e){babelHelpers.inherits(s,e);function s(e,i){var a;babelHelpers.classCallCheck(this,s);a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(s).call(this));a.setEventNamespace("BX.Crm.AddressItem");a._id=e;a._value=BX.prop.getString(i,"value","");a._isTypesMenuOpened=false;a._typesList=BX.prop.getArray(i,"typesList",[]);a._availableTypesIds=BX.prop.getArray(i,"availableTypesIds",[]);a._allowedTypesIds=BX.prop.getArray(i,"allowedTypesIds",[]);a._canChangeType=BX.prop.getBoolean(i,"canChangeType",false);a.typesMenuId="address_type_menu_"+a._id;a._type=BX.prop.getString(i,"type","");a._isEditMode=true;a._isTypeSelectorVisible=BX.prop.getBoolean(i,"isTypeSelectorVisible",true);a._isAutocompleteEnabled=BX.prop.getBoolean(i,"enableAutocomplete",true);a._showAddressTypeInViewMode=BX.prop.getBoolean(i,"showAddressTypeInViewMode",true);a._showDetails=!a._isAutocompleteEnabled||BX.prop.getBoolean(i,"showDetails",false);a._isLoading=false;a._icon=null;a._isDropdownLoading=false;a._addressWidget=null;a._wrapper=null;a._domNodes={};a._selectedCopyDestinations=[];a._isLocationModuleInstalled=!t.Type.isUndefined(BX.Location)&&!t.Type.isUndefined(BX.Location.Core)&&!t.Type.isUndefined(BX.Location.Widget);a.initializeAddressWidget();return a}babelHelpers.createClass(s,[{key:"initializeAddressWidget",value:function e(){if(!this._isLocationModuleInstalled){return}var s=this.getValue();var i=null;if(t.Type.isStringFilled(s)){try{i=new BX.Location.Core.Address(JSON.parse(s))}catch(e){}}var a=new BX.Location.Widget.Factory;this._addressWidget=a.createAddressWidget({address:i,mode:this._isEditMode?BX.Location.Core.ControlMode.edit:BX.Location.Core.ControlMode.view,popupBindOptions:{position:"right"}});this._addressWidget.subscribeOnStateChangedEvent(this.onAddressWidgetChangedState.bind(this));this._addressWidget.subscribeOnAddressChangedEvent(this.onAddressChanged.bind(this));this._addressWidget.subscribeOnFeatureEvent(this.onFeatureEvent.bind(this));this._addressWidget.subscribeOnErrorEvent(this.onError.bind(this))}},{key:"getId",value:function e(){return this._id}},{key:"getType",value:function e(){return this._type}},{key:"getValue",value:function e(){return this._value}},{key:"setValue",value:function e(t){this.destroy();this._value=t;this.initializeAddressWidget()}},{key:"markAsNew",value:function e(){var t=this.getAddress();if(t){t.id=0;t.clearLinks()}this._value=t?t.toJson():""}},{key:"setEditMode",value:function e(s){this._isEditMode=!!s;if(!t.Type.isNull(this._addressWidget)){this._addressWidget.mode=s?BX.Location.Core.ControlMode.edit:BX.Location.Core.ControlMode.view}}},{key:"setAvailableTypesIds",value:function e(t){this._availableTypesIds=t}},{key:"setAllowedTypesIds",value:function e(t){this._allowedTypesIds=t}},{key:"getTypeListByIds",value:function e(s){var i=[];if(t.Type.isArray(s)&&s.length>0){var a={};var n=D(this._typesList),r;try{for(n.s();!(r=n.n()).done;){var d=r.value;a["a"+d.value]=d}}catch(e){n.e(e)}finally{n.f()}var o=D(s),l;try{for(o.s();!(l=o.n()).done;){var u=l.value;var p="a"+u;if(a.hasOwnProperty(p)){i.push(a[p])}}}catch(e){o.e(e)}finally{o.f()}}return i}},{key:"layout",value:function e(){if(t.Type.isNull(this._addressWidget)){this._wrapper=t.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(["<div>Location module is not installed</div>"])));return this._wrapper}var s={};var i=this.convertAddressToString(this.getAddress());if(this._isEditMode){this._wrapper=this.getEditHtml(i);s.mode=BX.Location.Core.ControlMode.edit;s.inputNode=this._domNodes.searchInput;s.mapBindElement=this._domNodes.searchInput;s.fieldsContainer=this._domNodes.detailsContainer;s.controlWrapper=this._domNodes.addressContainer}else{this._wrapper=this.getViewHtml(i);s.mode=BX.Location.Core.ControlMode.view;s.mapBindElement=this._wrapper}s.controlWrapper=this._domNodes.addressContainer;this._addressWidget.render(s);return this._wrapper}},{key:"openTypesMenu",value:function e(s){var a=this;if(this._isTypesMenuOpened){return}var n=[];var r=babelHelpers.toConsumableArray(this._allowedTypesIds);var d=parseInt(this._type);if(r.indexOf(d)<0){r.push(d)}var o=D(this.getTypeListByIds(r)),l;try{for(o.s();!(l=o.n()).done;){var u=l.value;var p=d===parseInt(u.value);if(this._availableTypesIds.indexOf(u.value)<0&&!p){continue}n.push({text:u.name,value:u.value,onclick:this.onChangeType.bind(this)})}}catch(e){o.e(e)}finally{o.f()}i.MenuManager.show(this.typesMenuId,s,n,{angle:false,cacheable:false,events:{onPopupShow:function e(){a._isTypesMenuOpened=true},onPopupClose:function e(){a._isTypesMenuOpened=false}}});var h=i.MenuManager.getMenuById(this.typesMenuId);if(h&&t.Type.isDomNode(this._domNodes.addressTypeSelector)&&this._domNodes.addressTypeSelector.offsetWidth>200){h.getPopupWindow().setWidth(this._domNodes.addressTypeSelector.offsetWidth)}}},{key:"closeTypesMenu",value:function e(){var t=i.MenuManager.getMenuById(this.typesMenuId);if(t){t.close()}}},{key:"setTypeSelectorVisibility",value:function e(t){this._isTypeSelectorVisible=!!t}},{key:"getEditHtml",value:function e(s){this._domNodes.typeName=t.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['<div class="ui-ctl-element"></div>'])));this._domNodes.searchInput=t.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="text" class="ui-ctl-element ui-ctl-textbox" value="','" ',">"])),s,this._isAutocompleteEnabled?"":"readonly");this._domNodes.icon=t.Tag.render(u||(u=babelHelpers.taggedTemplateLiteral(["<span></span>"])));this._domNodes.addressContainer=t.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="crm-address-search-control-block">\n\t\t\t<div class="ui-ctl ui-ctl-w100 ui-ctl-after-icon">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t</div>\n\t\t</div>"])),this._domNodes.icon,this._domNodes.searchInput);this._domNodes.detailsContainer=t.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="location-fields-control-block"></div>'])));if(this._canChangeType){if(this._isTypeSelectorVisible){this._domNodes.addressTypeSelector=t.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-ctl ui-ctl-inline ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w25" onclick="','">\n\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>"])),this.onToggleTypesMenu.bind(this),this._domNodes.typeName);this._domNodes.addressTypeContainer=null;t.Dom.addClass(this._domNodes.addressContainer,["ui-ctl-inline","ui-ctl-w75"]);this._domNodes.addressContainer=t.Tag.render(y||(y=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-ctl-inline ui-ctl-w100">\n\t\t\t\t\t\t',"\n\t\t\t\t\t\t","\n\t\t\t\t\t</div>\n\t\t\t\t"])),this._domNodes.addressTypeSelector,this._domNodes.addressContainer)}else{this._domNodes.addressTypeSelector=t.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-ctl ui-ctl-w100 ui-ctl-after-icon ui-ctl-dropdown" onclick="','">\n\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>"])),this.onToggleTypesMenu.bind(this),this._domNodes.typeName);this._domNodes.addressTypeContainer=t.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="location-fields-control-block crm-address-type-block">\n\t\t\t\t\t\t<div class="ui-entity-editor-content-block ui-entity-editor-field-text">\n\t\t\t\t\t\t\t<div class="ui-entity-editor-block-title">\n\t\t\t\t\t\t\t\t<label class="ui-entity-editor-block-title-text">',"</label>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t","\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>"])),t.Loc.getMessage("CRM_ADDRESS_TYPE"),this._domNodes.addressTypeSelector)}this.refreshTypeName()}this.refreshIcon();this._domNodes.detailsToggler=t.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(['<span class="ui-link ui-link-secondary ui-entity-editor-block-title-link" onclick="','"></span>'])),this.onToggleDetailsVisibility.bind(this));if(this._canChangeType){this._domNodes.copyButton=t.Tag.render(_||(_=babelHelpers.taggedTemplateLiteral(['<span class="ui-link ui-link-secondary ui-entity-editor-block-title-link" onclick="','">',"</span>"])),this.onCopyButtonClick.bind(this),t.Loc.getMessage("CRM_ADDRESS_COPY1"))}this.refreshCopyButtonVisibility();this.setDetailsVisibility(this._showDetails);var i=t.Tag.render(T||(T=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-address-control-item">\n\t\t\t\t<div class="crm-address-control-mode-switch">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t\t","\n\t\t\t\t","\n\t\t\t</div>"])),this._domNodes.copyButton?this._domNodes.copyButton:"",this._domNodes.detailsToggler,this._domNodes.addressContainer,this._domNodes.detailsContainer);if(this._canChangeType&&t.Type.isDomNode(this._domNodes.addressTypeContainer)){t.Dom.append(this._domNodes.addressTypeContainer,i)}return i}},{key:"getViewHtml",value:function e(s){var i=this;this._domNodes.addressContainer=t.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-entity-editor-content-block-text">\n\t\t\t\t<span class="ui-link ui-link-dark ui-link-dotted">',"</span>\n\t\t\t</div>"])),s);var a="";if(this._showAddressTypeInViewMode){var n=this._typesList.filter((function(e){return e.value==i._type})).map((function(e){return e.name})).join("");a=t.Tag.render(m||(m=babelHelpers.taggedTemplateLiteral(['<span class="ui-link ui-link-secondary">',":</span>"])),t.Text.encode(n))}return t.Tag.render(A||(A=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-address-control-item">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t</div>"])),a,this._domNodes.addressContainer)}},{key:"refreshTypeName",value:function e(){var s=this;if(t.Type.isDomNode(this._domNodes.typeName)){var i=this._typesList.filter((function(e){return e.value===s._type})).map((function(e){return e.name})).join("");this._domNodes.typeName.textContent=i;this._domNodes.typeName.title=i}}},{key:"refreshIcon",value:function e(){var s=this.getNewIcon();if(this._icon!==s){var i=this._domNodes.icon;if(t.Type.isDomNode(i)){var a;if(s==="loading"){a=t.Tag.render(I||(I=babelHelpers.taggedTemplateLiteral(['<span class="ui-ctl-after ui-ctl-icon-loader"></span>'])))}else{if(s==="clear"){a=t.Tag.render(L||(L=babelHelpers.taggedTemplateLiteral(['<button type="button" class="ui-ctl-after ui-ctl-icon-clear" onclick="','"></button>'])),this.onDelete.bind(this))}else if(s==="search"){a=t.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(['<span class="ui-ctl-after ','"></span>'])),this._isAutocompleteEnabled?"ui-ctl-icon-search":"")}}t.Dom.replace(i,a);this._domNodes.icon=a}this._icon=s}}},{key:"getNewIcon",value:function e(){if(this._isLoading){return"loading"}else{return this.getAddress()?"clear":"search"}}},{key:"refreshCopyButtonVisibility",value:function e(){var s=this._domNodes.copyButton;if(t.Type.isDomNode(s)){var i=!!this.getAddress();t.Dom.style(s,"display",i?"":"none")}}},{key:"convertAddressToString",value:function e(t){if(!t){return""}return t.toString(this.getAddressFormat())}},{key:"getAddress",value:function e(){return t.Type.isNull(this._addressWidget)?null:this._addressWidget.address}},{key:"getAddressFormat",value:function e(){return t.Type.isNull(this._addressWidget)?null:this._addressWidget.addressFormat}},{key:"clearValue",value:function e(){if(!t.Type.isNull(this._addressWidget)){this._addressWidget.resetView();this._addressWidget.address=null}if(t.Type.isDomNode(this._domNodes.searchInput)){this._domNodes.searchInput.value=""}this._value="";this._isLoading=false;this.refreshIcon();this.refreshCopyButtonVisibility()}},{key:"setDetailsVisibility",value:function e(s){this._showDetails=!!s;if(this._showDetails){t.Dom.addClass(this._domNodes.detailsContainer,"visible");if(t.Type.isDomNode(this._domNodes.detailsToggler)){this._domNodes.detailsToggler.textContent=t.Loc.getMessage("CRM_ADDRESS_MODE_SHORT")}if(this._canChangeType){t.Dom.addClass(this._domNodes.addressTypeContainer,"visible")}}else{t.Dom.removeClass(this._domNodes.detailsContainer,"visible");if(t.Type.isDomNode(this._domNodes.detailsToggler)){this._domNodes.detailsToggler.textContent=t.Loc.getMessage("CRM_ADDRESS_MODE_DETAILED")}if(this._canChangeType){t.Dom.removeClass(this._domNodes.addressTypeContainer,"visible")}}}},{key:"showCopyDestinationPopup",value:function e(){var s=this;var a=i.PopupManager.create({id:this._id+"_copy_dst_popup",cacheable:false,autoHide:true,titleBar:t.Loc.getMessage("CRM_ADDRESS_COPY_TITLE"),content:this.getCopyDestinationLayout(),closeIcon:true,closeByEsc:true,buttons:[new BX.UI.Button({id:"copy",text:t.Loc.getMessage("CRM_ADDRESS_COPY2"),color:BX.UI.Button.Color.PRIMARY,state:BX.UI.ButtonState.DISABLED,onclick:function e(t){t.getContext().close();s.emit("onCopyAddress",{sourceId:s.getId(),destinationTypes:s._selectedCopyDestinations})}})]});a.show()}},{key:"getCopyDestinationLayout",value:function e(){var s=this;var i=this.getTypeListByIds(this._allowedTypesIds).filter((function(e){return e.value!==s._type}));return t.Tag.render(k||(k=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div>\n\t\t\t\t<div class="ui-title-7">',"</div>\n\t\t\t\t<div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),t.Loc.getMessage("CRM_ADDRESS_COPY_TO"),i.map((function(e){return t.Tag.render(w||(w=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-ctl ui-ctl-w100 ui-ctl-checkbox ui-ctl-xs">\n\t\t\t\t\t<label>\n\t\t\t\t\t<input onclick="','" type="checkbox" value="','">\n\t\t\t\t\t\t<span class="ui-ctl-label-text">',"</span>\n\t\t\t\t\t</label>\n\t\t\t\t\t</div>\n\t\t\t\t\t"])),s.onChangeCopyDestination.bind(s),e.value,t.Text.encode(e.name))})))}},{key:"destroy",value:function e(){if(!t.Type.isNull(this._addressWidget)){this._addressWidget.destroy()}}},{key:"onToggleDetailsVisibility",value:function e(){this.setDetailsVisibility(!this._showDetails)}},{key:"onDelete",value:function e(){this.clearValue();this.emit("onUpdateAddress",{id:this.getId(),value:this.getValue()})}},{key:"onCopyButtonClick",value:function e(){this.showCopyDestinationPopup()}},{key:"onChangeCopyDestination",value:function e(t){var s=t.target;var a=s?s.value:null;var n=s?s.checked:false;if(n&&this._selectedCopyDestinations.indexOf(a)<0){this._selectedCopyDestinations.push(a)}if(!n&&this._selectedCopyDestinations.indexOf(a)>=0){this._selectedCopyDestinations.splice(this._selectedCopyDestinations.indexOf(a),1)}var r=i.PopupManager.getPopupById(this._id+"_copy_dst_popup");if(r){var d=r.getButton("copy");if(d){d.setDisabled(!this._selectedCopyDestinations.length)}}}},{key:"onToggleTypesMenu",value:function e(t){if(this._isTypesMenuOpened){this.closeTypesMenu()}else{this.openTypesMenu(t.target)}}},{key:"onChangeType",value:function e(t,s){this.closeTypesMenu();if(this._type!==s.value){var i=this._type;this._type=s.value;this.refreshTypeName();this.emit("onUpdateAddressType",{id:this.getId(),type:this.getType(),prevType:i})}}},{key:"onAddressWidgetChangedState",value:function e(t){var s=t.getData(),i=s.state;var a=this._isLoading;this.computeIsLoading();if(a!==this._isLoading){this.refreshIcon();this.refreshCopyButtonVisibility()}if(i===BX.Location.Widget.State.DATA_LOADING){this.emit("onStartLoadAddress",{id:this.getId()})}else if(i===BX.Location.Widget.State.DATA_LOADED){this.emit("onAddressLoaded",{id:this.getId()})}else if(i===BX.Location.Widget.State.DATA_INPUTTING){this.emit("onAddressDataInputting",{id:this.getId()})}}},{key:"onAddressChanged",value:function e(s){this._isLoading=false;var i=s.getData();this._value=t.Type.isObject(i.address)?i.address.toJson():"";this.refreshIcon();this.refreshCopyButtonVisibility();this.emit("onUpdateAddress",{id:this.getId(),value:this.getValue()})}},{key:"onFeatureEvent",value:function e(t){var s=t.getData();if(s.feature instanceof BX.Location.Widget.AutocompleteFeature){this._isDropdownLoading=s.eventCode===BX.Location.Widget.AutocompleteFeature.searchStartedEvent;var i=this._isLoading;this.computeIsLoading();if(i!==this._isLoading){this.refreshIcon();this.refreshCopyButtonVisibility()}}}},{key:"onError",value:function e(t){var s=t.getData();var i=s.errors;var a=i.map((function(e){return e.message+(e.code.length?"".concat(e.code):"")})).join(", ");this._isLoading=false;this.refreshIcon();this.refreshCopyButtonVisibility();this.emit("onError",{id:this.getId(),error:a})}},{key:"computeIsLoading",value:function e(){this._isLoading=this._addressWidget.state===BX.Location.Widget.State.DATA_LOADING||this._isDropdownLoading}},{key:"resetView",value:function e(){this._addressWidget.resetView()}}]);return s}(s.EventEmitter);e.EntityEditorBaseAddressField=N})(this.BX.Crm=this.BX.Crm||{},BX,BX.Event,BX.Main);
//# sourceMappingURL=address.bundle.map.js