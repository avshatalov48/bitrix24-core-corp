this.BX=this.BX||{};(function(e,t,s,i){"use strict";function n(){var e=babelHelpers.taggedTemplateLiteral(['<span class="ui-ctl-after ','"></span>']);n=function t(){return e};return e}function r(){var e=babelHelpers.taggedTemplateLiteral(['<button class="ui-ctl-after ui-ctl-icon-clear" onclick="','"></button>']);r=function t(){return e};return e}function a(){var e=babelHelpers.taggedTemplateLiteral(['<span class="ui-ctl-after ui-ctl-icon-loader"></span>']);a=function t(){return e};return e}function d(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-address-control-item">\n\t\t\t\t',"\n\t\t\t</div>"]);d=function t(){return e};return e}function o(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-entity-editor-content-block-text">\n\t\t\t\t<span class="ui-link ui-link-dark ui-link-dotted">',"</span>\n\t\t\t</div>"]);o=function t(){return e};return e}function l(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-address-control-item">\n\t\t\t\t<div class="crm-address-control-mode-switch">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t\t","\n\t\t\t\t","\n\t\t\t</div>"]);l=function t(){return e};return e}function u(){var e=babelHelpers.taggedTemplateLiteral(['<span class="ui-link ui-link-secondary ui-entity-editor-block-title-link" onclick="','"></span>']);u=function t(){return e};return e}function h(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="location-fields-control-block crm-address-type-block">\n\t\t\t\t<div class="ui-entity-editor-content-block ui-entity-editor-field-text">\n\t\t\t\t\t<div class="ui-entity-editor-block-title">\n\t\t\t\t\t\t<label class="ui-entity-editor-block-title-text">',"</label>\n\t\t\t\t\t</div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</div>"]);h=function t(){return e};return e}function p(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-ctl ui-ctl-w100 ui-ctl-after-icon ui-ctl-dropdown" onclick="','">\n\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t',"\n\t\t\t</div>"]);p=function t(){return e};return e}function c(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="location-fields-control-block"></div>']);c=function t(){return e};return e}function v(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="crm-address-search-control-block">\n\t\t\t<div class="ui-ctl ui-ctl-w100 ui-ctl-after-icon">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t</div>\n\t\t</div>"]);v=function t(){return e};return e}function f(){var e=babelHelpers.taggedTemplateLiteral(["<span></span>"]);f=function t(){return e};return e}function y(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="text" class="ui-ctl-element ui-ctl-textbox" value="','" ',">"]);y=function t(){return e};return e}function g(){var e=babelHelpers.taggedTemplateLiteral(['<div class="ui-ctl-element"></div>']);g=function t(){return e};return e}function _(){var e=babelHelpers.taggedTemplateLiteral(["<div>Location module is not installed</div>"]);_=function t(){return e};return e}function m(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span class="ui-link ui-link-secondary ui-link-dotted" onmouseup="','"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>"]);m=function t(){return e};return e}function b(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="','"><span class="','" onclick="','">',"</span></div>\n\t\t\t"]);b=function t(){return e};return e}function T(){var e=babelHelpers.taggedTemplateLiteral(['<div class="crm-address-control-wrap ','"></div>']);T=function t(){return e};return e}function A(e,t){var s;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(s=L(e))||t&&e&&typeof e.length==="number"){if(s)e=s;var i=0;var n=function e(){};return{s:n,n:function t(){if(i>=e.length)return{done:true};return{done:false,value:e[i++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,a=false,d;return{s:function t(){s=e[Symbol.iterator]()},n:function e(){var t=s.next();r=t.done;return t},e:function e(t){a=true;d=t},f:function e(){try{if(!r&&s.return!=null)s.return()}finally{if(a)throw d}}}}function L(e,t){if(!e)return;if(typeof e==="string")return k(e,t);var s=Object.prototype.toString.call(e).slice(8,-1);if(s==="Object"&&e.constructor)s=e.constructor.name;if(s==="Map"||s==="Set")return Array.from(e);if(s==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return k(e,t)}function k(e,t){if(t==null||t>e.length)t=e.length;for(var s=0,i=new Array(t);s<t;s++){i[s]=e[s]}return i}var C=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,s){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._isMultiple=false;this._settings=s?s:{};this._typesList=[];this._availableTypesIds=[];this._addressList=[];this._wrapper=null;this._isEditMode=true;this._showFirstItemOnly=BX.prop.getBoolean(s,"showFirstItemOnly",false);this._enableAutocomplete=BX.prop.getBoolean(s,"enableAutocomplete",true)}},{key:"setMultiple",value:function e(t){this._isMultiple=!!t}},{key:"setValue",value:function e(s){if(this._isMultiple){var i=t.Type.isPlainObject(s)?s:{};var n=Object.keys(i);var r=this._addressList.length>0&&n.length==this._addressList.length;if(r){var a=A(this._addressList),d;try{for(a.s();!(d=a.n()).done;){var o=d.value;var l=o.getType();if(!i.hasOwnProperty(l)||i[l]!==o.getValue()){r=false;break}}}catch(e){a.e(e)}finally{a.f()}}if(!r&&!n.length&&this._addressList.length===1&&!this._addressList[0].getValue().length){r=true}if(r){return false}this.removeAllAddresses();for(var u=0,h=n;u<h.length;u++){var p=h[u];this.addAddress(p,i[p])}if(!n.length){this.addAddress(this.getDefaultType(),null)}}else{this.removeAllAddresses();var c=t.Type.isStringFilled(s)?s:null;this.addAddress(null,c)}return true}},{key:"getValue",value:function e(){if(this._isMultiple){var s=[];var i=A(this._addressList),n;try{for(i.s();!(n=i.n()).done;){var r=n.value;var a=r.getValue();if(t.Type.isString(a)){s.push({type:r.getType(),value:a})}}}catch(e){i.e(e)}finally{i.f()}return s}else{if(this._addressList&&this._addressList[0]&&t.Type.isString(this._addressList[0].getValue())){return this._addressList[0].getValue()}return null}}},{key:"setTypesList",value:function e(s){this._typesList=[];if(t.Type.isPlainObject(s)){for(var i=0,n=Object.keys(s);i<n.length;i++){var r=n[i];this._typesList.push(s[r])}}this.initAvailableTypes()}},{key:"getTypesList",value:function e(){var t=[];var s=A(this._typesList),i;try{for(s.s();!(i=s.n()).done;){var n=i.value;var r=BX.prop.getString(n,"ID","");var a=BX.prop.getString(n,"DESCRIPTION","");t.push({name:a,value:r})}}catch(e){s.e(e)}finally{s.f()}return t}},{key:"getDefaultType",value:function e(){var t=A(this._typesList),s;try{for(t.s();!(s=t.n()).done;){var i=s.value;var n=BX.prop.getString(i,"ID","");var r=BX.prop.getString(i,"IS_DEFAULT",false);if(r&&this._availableTypesIds.indexOf(n)>=0){return n}}}catch(e){t.e(e)}finally{t.f()}var a=A(this._typesList),d;try{for(a.s();!(d=a.n()).done;){var o=d.value;var l=BX.prop.getString(o,"ID","");if(this._availableTypesIds.indexOf(l)>=0){return l}}}catch(e){a.e(e)}finally{a.f()}return null}},{key:"layout",value:function e(s){this._isEditMode=s;this._wrapper=t.Tag.render(T(),this._isEditMode?"crm-address-control-wrap-edit":"");this.refreshLayout();return this._wrapper}},{key:"refreshLayout",value:function e(){t.Dom.clean(this._wrapper);var s=true;var i=A(this._addressList),n;try{for(i.s();!(n=i.n()).done;){var r=n.value;r.setEditMode(this._isEditMode);if(!this._isEditMode&&this._showFirstItemOnly&&s>1){var a=t.Tag.render(m(),this.onShowMoreMouseUp.bind(this),t.Loc.getMessage("CRM_ADDRESS_SHOW_ALL"));t.Dom.append(a,this._wrapper);break}else{t.Dom.append(r.layout(),this._wrapper)}s++}}catch(e){i.e(e)}finally{i.f()}if(this._isEditMode&&this._isMultiple&&!t.Type.isNull(this.getDefaultType())){var d=BX.prop.getBoolean(this._settings,"crmCompatibilityMode",false);var o=d?"crm-entity-widget-content-block-add-field":"ui-entity-widget-content-block-add-field";var l=d?"crm-entity-widget-content-add-field":"ui-entity-editor-content-add-lnk";t.Dom.append(t.Tag.render(b(),o,l,this.onAddNewAddress.bind(this),t.Loc.getMessage("CRM_ADDRESS_ADD")),this._wrapper)}}},{key:"release",value:function e(){t.Dom.clean(this._wrapper);this.removeAllAddresses()}},{key:"removeAllAddresses",value:function e(){var t=this._addressList.map(function(e){return e.getId()});var s=A(t),i;try{for(s.s();!(i=s.n()).done;){var n=i.value;this.removeAddress(n)}}catch(e){s.e(e)}finally{s.f()}}},{key:"addAddress",value:function e(s){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var n=new D(t.Text.getRandom(8),{typesList:this.getTypesList(),availableTypesIds:babelHelpers.toConsumableArray(this._availableTypesIds),canChangeType:this._isMultiple,enableAutocomplete:this._enableAutocomplete,type:s,value:i});n.subscribe("onUpdateAddress",this.onUpdateAddress.bind(this));n.subscribe("onUpdateAddressType",this.onUpdateAddressType.bind(this));n.subscribe("onDelete",this.onDeleteAddress.bind(this));n.subscribe("onStartLoadAddress",this.onStartLoadAddress.bind(this));n.subscribe("onAddressLoaded",this.onAddressLoaded.bind(this));n.subscribe("onError",this.onError.bind(this));this.updateAvailableTypes(s,null);this._addressList.push(n)}},{key:"removeAddress",value:function e(t){var s=this.getAddressById(t);if(s){var i=s.getType();this._addressList.splice(this._addressList.indexOf(s),1);this.updateAvailableTypes(null,i);s.destroy()}}},{key:"getAddressById",value:function e(t){return this._addressList.filter(function(e){return e.getId()===t}).reduce(function(e,t){return e?e:t},null)}},{key:"initAvailableTypes",value:function e(){this._availableTypesIds=[];var t=A(this._typesList),s;try{for(t.s();!(s=t.n()).done;){var i=s.value;this._availableTypesIds.push(BX.prop.getString(i,"ID",""))}}catch(e){t.e(e)}finally{t.f()}}},{key:"updateAvailableTypes",value:function e(s,i){if(!t.Type.isNull(i)&&this._availableTypesIds.indexOf(i)<0){this._availableTypesIds.push(i)}if(!t.Type.isNull(s)&&this._availableTypesIds.indexOf(s)>=0){this._availableTypesIds.splice(this._availableTypesIds.indexOf(s),1)}var n=A(this._addressList),r;try{for(n.s();!(r=n.n()).done;){var a=r.value;a.setAvailableTypesIds(babelHelpers.toConsumableArray(this._availableTypesIds))}}catch(e){n.e(e)}finally{n.f()}}},{key:"emitUpdateEvent",value:function e(){s.EventEmitter.emit(this,"onUpdate",{value:this.getValue()})}},{key:"onAddNewAddress",value:function e(){this.addAddress(this.getDefaultType());this.refreshLayout()}},{key:"onUpdateAddress",value:function e(t){this.emitUpdateEvent()}},{key:"onDeleteAddress",value:function e(t){var s=t.getData();var i=s.id;if(this._addressList.length<=1){var n=this.getAddressById(i);if(n){n.clearValue()}return}this.removeAddress(i);this.refreshLayout()}},{key:"onUpdateAddressType",value:function e(t){var s=t.getData();var i=s.prevType;var n=s.type;this.updateAvailableTypes(n,i);this.emitUpdateEvent()}},{key:"onShowMoreMouseUp",value:function e(t){t.stopPropagation();this._showFirstItemOnly=false;this.refreshLayout();return false}},{key:"onStartLoadAddress",value:function e(t){s.EventEmitter.emit(this,"onStartLoadAddress")}},{key:"onAddressLoaded",value:function e(t){s.EventEmitter.emit(this,"onAddressLoaded")}},{key:"onError",value:function e(t){s.EventEmitter.emit(this,"onError",t)}}],[{key:"create",value:function t(s,i){var n=new e;n.initialize(s,i);return n}}]);return e}();var D=function(e){babelHelpers.inherits(s,e);function s(e,i){var n;babelHelpers.classCallCheck(this,s);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(s).call(this));n.setEventNamespace("BX.Crm.AddressItem");n._id=e;n._value=BX.prop.getString(i,"value","");n._isTypesMenuOpened=false;n._typesList=BX.prop.getArray(i,"typesList",[]);n._availableTypesIds=BX.prop.getArray(i,"availableTypesIds",[]);n._canChangeType=BX.prop.getBoolean(i,"canChangeType",false);n.typesMenuId="address_type_menu_"+n._id;n._type=BX.prop.getString(i,"type","");n._isEditMode=true;n._isAutocompleteEnabled=BX.prop.getBoolean(i,"enableAutocomplete",true);n._showDetails=!n._isAutocompleteEnabled||BX.prop.getBoolean(i,"showDetails",false);n._isLoading=false;n._addressWidget=null;n._wrapper=null;n._domNodes={};n._isLocationModuleInstalled=!t.Type.isUndefined(BX.Location)&&!t.Type.isUndefined(BX.Location.Core)&&!t.Type.isUndefined(BX.Location.Widget);n.initializeAddressWidget();return n}babelHelpers.createClass(s,[{key:"initializeAddressWidget",value:function e(){if(!this._isLocationModuleInstalled){return}var s=this.getValue();var i=null;if(t.Type.isStringFilled(s)){try{i=new BX.Location.Core.Address(JSON.parse(s))}catch(e){}}var n=new BX.Location.Widget.Factory;this._addressWidget=n.createAddressWidget({address:i,mode:this._isEditMode?BX.Location.Core.ControlMode.edit:BX.Location.Core.ControlMode.view,popupBindOptions:{position:"right"}});this._addressWidget.subscribeOnStateChangedEvent(this.onAddressWidgetChangedState.bind(this));this._addressWidget.subscribeOnAddressChangedEvent(this.onAddressChanged.bind(this));this._addressWidget.subscribeOnErrorEvent(this.onError.bind(this))}},{key:"getId",value:function e(){return this._id}},{key:"getType",value:function e(){return this._type}},{key:"getValue",value:function e(){return this._value}},{key:"setEditMode",value:function e(s){this._isEditMode=!!s;if(!t.Type.isNull(this._addressWidget)){this._addressWidget.mode=s?BX.Location.Core.ControlMode.edit:BX.Location.Core.ControlMode.view}}},{key:"setAvailableTypesIds",value:function e(t){this._availableTypesIds=t}},{key:"layout",value:function e(){if(t.Type.isNull(this._addressWidget)){this._wrapper=t.Tag.render(_());return this._wrapper}var s={};var i=this.convertAddressToString(this.getAddress());if(this._isEditMode){this._wrapper=this.getEditHtml(i);s.mode=BX.Location.Core.ControlMode.edit;s.inputNode=this._domNodes.searchInput;s.mapBindElement=this._domNodes.searchInput;s.fieldsContainer=this._domNodes.detailsContainer;s.controlWrapper=this._domNodes.addressContainer}else{this._wrapper=this.getViewHtml(i);s.mode=BX.Location.Core.ControlMode.view;s.mapBindElement=this._wrapper}s.controlWrapper=this._domNodes.addressContainer;this._addressWidget.render(s);return this._wrapper}},{key:"openTypesMenu",value:function e(s){var n=this;if(this._isTypesMenuOpened){return}var r=[];var a=A(this._typesList),d;try{for(a.s();!(d=a.n()).done;){var o=d.value;var l=o.value===this._type;if(this._availableTypesIds.indexOf(o.value)<0&&!l){continue}r.push({text:o.name,value:o.value,onclick:this.onChangeType.bind(this)})}}catch(e){a.e(e)}finally{a.f()}i.MenuManager.show(this.typesMenuId,s,r,{angle:false,cacheable:false,events:{onPopupShow:function e(){n._isTypesMenuOpened=true},onPopupClose:function e(){n._isTypesMenuOpened=false}}});var u=i.MenuManager.getMenuById(this.typesMenuId);if(u&&t.Type.isDomNode(this._domNodes.addressTypeSelector)){u.getPopupWindow().setWidth(this._domNodes.addressTypeSelector.offsetWidth)}}},{key:"closeTypesMenu",value:function e(){var t=i.MenuManager.getMenuById(this.typesMenuId);if(t){t.close()}}},{key:"getEditHtml",value:function e(s){this._domNodes.typeName=t.Tag.render(g());this._domNodes.searchInput=t.Tag.render(y(),s,this._isAutocompleteEnabled?"":"readonly");this._domNodes.icon=t.Tag.render(f());this._domNodes.addressContainer=t.Tag.render(v(),this._domNodes.icon,this._domNodes.searchInput);this._domNodes.detailsContainer=t.Tag.render(c());if(this._canChangeType){this._domNodes.addressTypeSelector=t.Tag.render(p(),this.onToggleTypesMenu.bind(this),this._domNodes.typeName);this._domNodes.addressTypeContainer=t.Tag.render(h(),t.Loc.getMessage("CRM_ADDRESS_TYPE"),this._domNodes.addressTypeSelector);this.refreshTypeName()}this.refreshIcon();this._domNodes.detailsToggler=t.Tag.render(u(),this.onToggleDetailsVisibility.bind(this));this.setDetailsVisibility(this._showDetails);var i=t.Tag.render(l(),this._domNodes.detailsToggler,this._domNodes.addressContainer,this._domNodes.detailsContainer);if(this._canChangeType){t.Dom.append(this._domNodes.addressTypeContainer,i)}return i}},{key:"getViewHtml",value:function e(s){this._domNodes.addressContainer=t.Tag.render(o(),s);return t.Tag.render(d(),this._domNodes.addressContainer)}},{key:"refreshTypeName",value:function e(){var s=this;if(t.Type.isDomNode(this._domNodes.typeName)){this._domNodes.typeName.textContent=this._typesList.filter(function(e){return e.value===s._type}).map(function(e){return e.name}).join("")}}},{key:"refreshIcon",value:function e(){var s=this._domNodes.icon;if(t.Type.isDomNode(s)){var i;if(this._isLoading){i=t.Tag.render(a())}else{var d=this.getAddress();if(d){i=t.Tag.render(r(),this.onDelete.bind(this))}else{i=t.Tag.render(n(),this._isAutocompleteEnabled?"ui-ctl-icon-search":"")}}t.Dom.replace(s,i);this._domNodes.icon=i}}},{key:"convertAddressToString",value:function e(t){if(!t){return""}return t.toString(this.getAddressFormat())}},{key:"getAddress",value:function e(){return t.Type.isNull(this._addressWidget)?null:this._addressWidget.address}},{key:"getAddressFormat",value:function e(){return t.Type.isNull(this._addressWidget)?null:this._addressWidget.addressFormat}},{key:"clearValue",value:function e(){if(!t.Type.isNull(this._addressWidget)){this._addressWidget.resetView();this._addressWidget.address=null}if(t.Type.isDomNode(this._domNodes.searchInput)){this._domNodes.searchInput.value=""}this._value="";this._isLoading=false;this.refreshIcon()}},{key:"setDetailsVisibility",value:function e(s){this._showDetails=!!s;if(this._showDetails){t.Dom.addClass(this._domNodes.detailsContainer,"visible");if(t.Type.isDomNode(this._domNodes.detailsToggler)){this._domNodes.detailsToggler.textContent=t.Loc.getMessage("CRM_ADDRESS_MODE_SHORT")}if(this._canChangeType){t.Dom.addClass(this._domNodes.addressTypeContainer,"visible")}}else{t.Dom.removeClass(this._domNodes.detailsContainer,"visible");if(t.Type.isDomNode(this._domNodes.detailsToggler)){this._domNodes.detailsToggler.textContent=t.Loc.getMessage("CRM_ADDRESS_MODE_DETAILED")}if(this._canChangeType){t.Dom.removeClass(this._domNodes.addressTypeContainer,"visible")}}}},{key:"destroy",value:function e(){if(!t.Type.isNull(this._addressWidget)){this._addressWidget.destroy()}}},{key:"onToggleDetailsVisibility",value:function e(){this.setDetailsVisibility(!this._showDetails)}},{key:"onDelete",value:function e(){this.clearValue();this.emit("onUpdateAddress",{id:this.getId(),value:this.getValue()})}},{key:"onToggleTypesMenu",value:function e(t){if(this._isTypesMenuOpened){this.closeTypesMenu()}else{this.openTypesMenu(t.target)}}},{key:"onChangeType",value:function e(t,s){this.closeTypesMenu();if(this._type!==s.value){var i=this._type;this._type=s.value;this.refreshTypeName();this.emit("onUpdateAddressType",{id:this.getId(),type:this.getType(),prevType:i})}}},{key:"onAddressWidgetChangedState",value:function e(t){var s=t.getData(),i=s.state;var n=this._isLoading;this._isLoading=i===BX.Location.Widget.State.DATA_LOADING;if(n!==this._isLoading){this.refreshIcon()}if(i===BX.Location.Widget.State.DATA_LOADING){this.emit("onStartLoadAddress",{id:this.getId()})}if(i===BX.Location.Widget.State.DATA_LOADED){this.emit("onAddressLoaded",{id:this.getId()})}}},{key:"onAddressChanged",value:function e(s){this._isLoading=false;var i=s.getData();this._value=t.Type.isObject(i.address)?i.address.toJson():"";this.refreshIcon();this.emit("onUpdateAddress",{id:this.getId(),value:this.getValue()})}},{key:"onError",value:function e(t){var s=t.getData();var i=s.errors;var n=i.map(function(e){return e.message+(e.code.length?"".concat(e.code):"")}).join(", ");this._isLoading=false;this.refreshIcon();this.emit("onError",{id:this.getId(),error:n})}}]);return s}(s.EventEmitter);e.EntityEditorBaseAddressField=C})(this.BX.Crm=this.BX.Crm||{},BX,BX.Event,BX.Main);
//# sourceMappingURL=address.bundle.map.js