this.BX=this.BX||{};(function(e,t,i,s){"use strict";function n(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t<div class="ui-ctl ui-ctl-w100 ui-ctl-checkbox ui-ctl-xs">\n\t\t\t\t\t\t\t<label>\n\t\t\t\t\t\t\t\t<input onclick="','" type="checkbox" value="','">\n\t\t\t\t\t\t\t\t<span class="ui-ctl-label-text">',"</span>\n\t\t\t\t\t\t\t</label>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t"]);n=function t(){return e};return e}function r(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div>\n\t\t\t\t<div class="ui-title-7">',"</div>\n\t\t\t\t<div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);r=function t(){return e};return e}function a(){var e=babelHelpers.taggedTemplateLiteral(['<span class="ui-ctl-after ','"></span>']);a=function t(){return e};return e}function o(){var e=babelHelpers.taggedTemplateLiteral(['<button class="ui-ctl-after ui-ctl-icon-clear" onclick="','"></button>']);o=function t(){return e};return e}function d(){var e=babelHelpers.taggedTemplateLiteral(['<span class="ui-ctl-after ui-ctl-icon-loader"></span>']);d=function t(){return e};return e}function l(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-address-control-item">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t</div>"]);l=function t(){return e};return e}function u(){var e=babelHelpers.taggedTemplateLiteral(['<span class="ui-link ui-link-secondary">',":</span>"]);u=function t(){return e};return e}function p(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-entity-editor-content-block-text">\n\t\t\t\t<span class="ui-link ui-link-dark ui-link-dotted">',"</span>\n\t\t\t</div>"]);p=function t(){return e};return e}function c(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-address-control-item">\n\t\t\t\t<div class="crm-address-control-mode-switch">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t\t","\n\t\t\t\t","\n\t\t\t</div>"]);c=function t(){return e};return e}function h(){var e=babelHelpers.taggedTemplateLiteral(['<span class="ui-link ui-link-secondary ui-entity-editor-block-title-link" onclick="','">',"</span>"]);h=function t(){return e};return e}function y(){var e=babelHelpers.taggedTemplateLiteral(['<span class="ui-link ui-link-secondary ui-entity-editor-block-title-link" onclick="','"></span>']);y=function t(){return e};return e}function f(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="location-fields-control-block crm-address-type-block">\n\t\t\t\t\t\t<div class="ui-entity-editor-content-block ui-entity-editor-field-text">\n\t\t\t\t\t\t\t<div class="ui-entity-editor-block-title">\n\t\t\t\t\t\t\t\t<label class="ui-entity-editor-block-title-text">',"</label>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t","\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>"]);f=function t(){return e};return e}function v(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-ctl ui-ctl-w100 ui-ctl-after-icon ui-ctl-dropdown" onclick="','">\n\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>"]);v=function t(){return e};return e}function g(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-ctl-inline ui-ctl-w100">\n\t\t\t\t\t\t',"\n\t\t\t\t\t\t","\n\t\t\t\t\t</div>\n\t\t\t\t"]);g=function t(){return e};return e}function _(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-ctl ui-ctl-inline ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w25" onclick="','">\n\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>"]);_=function t(){return e};return e}function m(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="location-fields-control-block"></div>']);m=function t(){return e};return e}function b(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="crm-address-search-control-block">\n\t\t\t<div class="ui-ctl ui-ctl-w100 ui-ctl-after-icon">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t</div>\n\t\t</div>"]);b=function t(){return e};return e}function T(){var e=babelHelpers.taggedTemplateLiteral(["<span></span>"]);T=function t(){return e};return e}function L(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="text" class="ui-ctl-element ui-ctl-textbox" value="','" ',">"]);L=function t(){return e};return e}function A(){var e=babelHelpers.taggedTemplateLiteral(['<div class="ui-ctl-element"></div>']);A=function t(){return e};return e}function C(){var e=babelHelpers.taggedTemplateLiteral(["<div>Location module is not installed</div>"]);C=function t(){return e};return e}function k(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span class="ui-link ui-link-secondary ui-link-dotted" onmouseup="','"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>"]);k=function t(){return e};return e}function D(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="','"><span class="','" onclick="','">',"</span></div>\n\t\t\t"]);D=function t(){return e};return e}function I(){var e=babelHelpers.taggedTemplateLiteral(['<div class="crm-address-control-wrap ','"></div>']);I=function t(){return e};return e}function N(e,t){var i;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(i=B(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var s=0;var n=function e(){};return{s:n,n:function t(){if(s>=e.length)return{done:true};return{done:false,value:e[s++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,a=false,o;return{s:function t(){i=e[Symbol.iterator]()},n:function e(){var t=i.next();r=t.done;return t},e:function e(t){a=true;o=t},f:function e(){try{if(!r&&i.return!=null)i.return()}finally{if(a)throw o}}}}function B(e,t){if(!e)return;if(typeof e==="string")return M(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return M(e,t)}function M(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,s=new Array(t);i<t;i++){s[i]=e[i]}return s}var w=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,i){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._isMultiple=false;this._settings=i?i:{};this._typesList=[];this._availableTypesIds=[];this._addressList=[];this._wrapper=null;this._isEditMode=true;this._showFirstItemOnly=BX.prop.getBoolean(i,"showFirstItemOnly",false);this._enableAutocomplete=BX.prop.getBoolean(i,"enableAutocomplete",true);this._hideDefaultAddressType=BX.prop.getBoolean(this._settings,"hideDefaultAddressType",false);this._showAddressTypeInViewMode=BX.prop.getBoolean(this._settings,"showAddressTypeInViewMode",false)}},{key:"setMultiple",value:function e(t){this._isMultiple=!!t}},{key:"setValue",value:function e(i){if(this._isMultiple){var s=t.Type.isPlainObject(i)?i:{};var n=Object.keys(s);var r=this._addressList.length>0&&n.length==this._addressList.length;if(r){var a=N(this._addressList),o;try{for(a.s();!(o=a.n()).done;){var d=o.value;var l=d.getType();if(!s.hasOwnProperty(l)||s[l]!==d.getValue()){r=false;break}}}catch(e){a.e(e)}finally{a.f()}}if(!r&&!n.length&&this._addressList.length===1&&!this._addressList[0].getValue().length){r=true}if(r){return false}this.removeAllAddresses();for(var u=0,p=n;u<p.length;u++){var c=p[u];this.addAddress(c,s[c])}if(!n.length){this.addAddress(this.getDefaultType(),null)}}else{this.removeAllAddresses();var h=t.Type.isStringFilled(i)?i:null;this.addAddress(null,h)}return true}},{key:"getValue",value:function e(){if(this._isMultiple){var i=[];var s=N(this._addressList),n;try{for(s.s();!(n=s.n()).done;){var r=n.value;var a=r.getValue();if(t.Type.isString(a)){i.push({type:r.getType(),value:a})}}}catch(e){s.e(e)}finally{s.f()}return i}else{if(this._addressList&&this._addressList[0]&&t.Type.isString(this._addressList[0].getValue())){return this._addressList[0].getValue()}return null}}},{key:"setTypesList",value:function e(i){this._typesList=[];if(t.Type.isPlainObject(i)){for(var s=0,n=Object.keys(i);s<n.length;s++){var r=n[s];this._typesList.push(i[r])}}this.initAvailableTypes()}},{key:"getTypesList",value:function e(){var t=[];var i=N(this._typesList),s;try{for(i.s();!(s=i.n()).done;){var n=s.value;var r=BX.prop.getString(n,"ID","");var a=BX.prop.getString(n,"DESCRIPTION","");t.push({name:a,value:r})}}catch(e){i.e(e)}finally{i.f()}return t}},{key:"getDefaultType",value:function e(){var t=N(this._typesList),i;try{for(t.s();!(i=t.n()).done;){var s=i.value;var n=BX.prop.getString(s,"ID","");var r=BX.prop.getString(s,"IS_DEFAULT",false);if(r&&this._availableTypesIds.indexOf(n)>=0){return n}}}catch(e){t.e(e)}finally{t.f()}var a=N(this._typesList),o;try{for(a.s();!(o=a.n()).done;){var d=o.value;var l=BX.prop.getString(d,"ID","");if(this._availableTypesIds.indexOf(l)>=0){return l}}}catch(e){a.e(e)}finally{a.f()}return null}},{key:"layout",value:function e(i){this._isEditMode=i;this._wrapper=t.Tag.render(I(),this._isEditMode?"crm-address-control-wrap-edit":"");this.refreshLayout();return this._wrapper}},{key:"refreshLayout",value:function e(){t.Dom.clean(this._wrapper);var i=true;var s=N(this._addressList),n;try{for(s.s();!(n=s.n()).done;){var r=n.value;r.setEditMode(this._isEditMode);if(!this._isEditMode&&this._showFirstItemOnly&&i>1){var a=t.Tag.render(k(),this.onShowMoreMouseUp.bind(this),t.Loc.getMessage("CRM_ADDRESS_SHOW_ALL"));t.Dom.append(a,this._wrapper);break}else{t.Dom.append(r.layout(),this._wrapper)}i++}}catch(e){s.e(e)}finally{s.f()}if(this._isEditMode&&this._isMultiple&&!t.Type.isNull(this.getDefaultType())){var o=BX.prop.getBoolean(this._settings,"crmCompatibilityMode",false);var d=o?"crm-entity-widget-content-block-add-field":"ui-entity-widget-content-block-add-field";var l=o?"crm-entity-widget-content-add-field":"ui-entity-editor-content-add-lnk";t.Dom.append(t.Tag.render(D(),d,l,this.onAddNewAddress.bind(this),t.Loc.getMessage("CRM_ADDRESS_ADD")),this._wrapper)}}},{key:"release",value:function e(){t.Dom.clean(this._wrapper);this.removeAllAddresses()}},{key:"removeAllAddresses",value:function e(){var t=this._addressList.map(function(e){return e.getId()});var i=N(t),s;try{for(i.s();!(s=i.n()).done;){var n=s.value;this.removeAddress(n)}}catch(e){i.e(e)}finally{i.f()}}},{key:"addAddress",value:function e(i){var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var n=new S(t.Text.getRandom(8),{typesList:this.getTypesList(),availableTypesIds:babelHelpers.toConsumableArray(this._availableTypesIds),canChangeType:this._isMultiple,enableAutocomplete:this._enableAutocomplete,showAddressTypeInViewMode:this._isMultiple&&this._showAddressTypeInViewMode,type:i,value:s});n.subscribe("onUpdateAddress",this.onUpdateAddress.bind(this));n.subscribe("onUpdateAddressType",this.onUpdateAddressType.bind(this));n.subscribe("onDelete",this.onDeleteAddress.bind(this));n.subscribe("onStartLoadAddress",this.onStartLoadAddress.bind(this));n.subscribe("onAddressLoaded",this.onAddressLoaded.bind(this));n.subscribe("onError",this.onError.bind(this));n.subscribe("onCopyAddress",this.onCopyAddress.bind(this));this.updateAvailableTypes(i,null);this._addressList.push(n);this.updateTypeSelectorVisibility(this._addressList.length>1);return n}},{key:"removeAddress",value:function e(t){var i=this.getAddressById(t);if(i){var s=i.getType();this._addressList.splice(this._addressList.indexOf(i),1);this.updateAvailableTypes(null,s);this.updateTypeSelectorVisibility(this._addressList.length>1);i.destroy()}}},{key:"getAddressById",value:function e(t){return this._addressList.filter(function(e){return e.getId()===t}).reduce(function(e,t){return e?e:t},null)}},{key:"initAvailableTypes",value:function e(){this._availableTypesIds=[];var t=N(this._typesList),i;try{for(t.s();!(i=t.n()).done;){var s=i.value;this._availableTypesIds.push(BX.prop.getString(s,"ID",""))}}catch(e){t.e(e)}finally{t.f()}}},{key:"updateAvailableTypes",value:function e(i,s){if(!t.Type.isNull(s)&&this._availableTypesIds.indexOf(s)<0){this._availableTypesIds.push(s)}if(!t.Type.isNull(i)&&this._availableTypesIds.indexOf(i)>=0){this._availableTypesIds.splice(this._availableTypesIds.indexOf(i),1)}var n=N(this._addressList),r;try{for(n.s();!(r=n.n()).done;){var a=r.value;a.setAvailableTypesIds(babelHelpers.toConsumableArray(this._availableTypesIds))}}catch(e){n.e(e)}finally{n.f()}}},{key:"updateTypeSelectorVisibility",value:function e(t){if(!this._hideDefaultAddressType){return}var i=N(this._addressList),s;try{for(i.s();!(s=i.n()).done;){var n=s.value;n.setTypeSelectorVisibility(t)}}catch(e){i.e(e)}finally{i.f()}}},{key:"emitUpdateEvent",value:function e(){i.EventEmitter.emit(this,"onUpdate",{value:this.getValue()})}},{key:"onAddNewAddress",value:function e(){this.addAddress(this.getDefaultType());this.refreshLayout()}},{key:"onUpdateAddress",value:function e(t){this.emitUpdateEvent()}},{key:"onDeleteAddress",value:function e(t){var i=t.getData();var s=i.id;if(this._addressList.length<=1){var n=this.getAddressById(s);if(n){n.clearValue()}return}this.removeAddress(s);this.refreshLayout()}},{key:"onUpdateAddressType",value:function e(t){var i=t.getData();var s=i.prevType;var n=i.type;this.updateAvailableTypes(n,s);this.emitUpdateEvent()}},{key:"onShowMoreMouseUp",value:function e(t){t.stopPropagation();this._showFirstItemOnly=false;this.refreshLayout();return false}},{key:"onStartLoadAddress",value:function e(t){i.EventEmitter.emit(this,"onStartLoadAddress")}},{key:"onAddressLoaded",value:function e(t){i.EventEmitter.emit(this,"onAddressLoaded")}},{key:"onError",value:function e(t){i.EventEmitter.emit(this,"onError",t)}},{key:"onCopyAddress",value:function e(t){var i=this;var s=t.getData();var n=this.getAddressById(s.sourceId);if(!n){return}var r=n.getValue();if(!r.length){return}var a=function e(t){var n=s.destinationTypes[t];var a=i._addressList.filter(function(e){return e.getType()==n}).reduce(function(e,t){return e?e:t},null);if(a){a.setValue(r)}else{a=i.addAddress(n,r)}a.markAsNew();i.refreshLayout()};for(var o=0;o<s.destinationTypes.length;o++){a(o)}this.emitUpdateEvent()}},{key:"resetView",value:function e(){var t=N(this._addressList),i;try{for(t.s();!(i=t.n()).done;){var s=i.value;s.resetView()}}catch(e){t.e(e)}finally{t.f()}}}],[{key:"create",value:function t(i,s){var n=new e;n.initialize(i,s);return n}}]);return e}();var S=function(e){babelHelpers.inherits(i,e);function i(e,s){var n;babelHelpers.classCallCheck(this,i);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this));n.setEventNamespace("BX.Crm.AddressItem");n._id=e;n._value=BX.prop.getString(s,"value","");n._isTypesMenuOpened=false;n._typesList=BX.prop.getArray(s,"typesList",[]);n._availableTypesIds=BX.prop.getArray(s,"availableTypesIds",[]);n._canChangeType=BX.prop.getBoolean(s,"canChangeType",false);n.typesMenuId="address_type_menu_"+n._id;n._type=BX.prop.getString(s,"type","");n._isEditMode=true;n._isTypeSelectorVisible=BX.prop.getBoolean(s,"isTypeSelectorVisible",true);n._isAutocompleteEnabled=BX.prop.getBoolean(s,"enableAutocomplete",true);n._showAddressTypeInViewMode=BX.prop.getBoolean(s,"showAddressTypeInViewMode",true);n._showDetails=!n._isAutocompleteEnabled||BX.prop.getBoolean(s,"showDetails",false);n._isLoading=false;n._isDropdownLoading=false;n._addressWidget=null;n._wrapper=null;n._domNodes={};n._selectedCopyDestinations=[];n._isLocationModuleInstalled=!t.Type.isUndefined(BX.Location)&&!t.Type.isUndefined(BX.Location.Core)&&!t.Type.isUndefined(BX.Location.Widget);n.initializeAddressWidget();return n}babelHelpers.createClass(i,[{key:"initializeAddressWidget",value:function e(){if(!this._isLocationModuleInstalled){return}var i=this.getValue();var s=null;if(t.Type.isStringFilled(i)){try{s=new BX.Location.Core.Address(JSON.parse(i))}catch(e){}}var n=new BX.Location.Widget.Factory;this._addressWidget=n.createAddressWidget({address:s,mode:this._isEditMode?BX.Location.Core.ControlMode.edit:BX.Location.Core.ControlMode.view,popupBindOptions:{position:"right"}});this._addressWidget.subscribeOnStateChangedEvent(this.onAddressWidgetChangedState.bind(this));this._addressWidget.subscribeOnAddressChangedEvent(this.onAddressChanged.bind(this));this._addressWidget.subscribeOnFeatureEvent(this.onFeatureEvent.bind(this));this._addressWidget.subscribeOnErrorEvent(this.onError.bind(this))}},{key:"getId",value:function e(){return this._id}},{key:"getType",value:function e(){return this._type}},{key:"getValue",value:function e(){return this._value}},{key:"setValue",value:function e(t){this.destroy();this._value=t;this.initializeAddressWidget()}},{key:"markAsNew",value:function e(){var t=this.getAddress();if(t){t.id=0;t.clearLinks()}this._value=t?t.toJson():""}},{key:"setEditMode",value:function e(i){this._isEditMode=!!i;if(!t.Type.isNull(this._addressWidget)){this._addressWidget.mode=i?BX.Location.Core.ControlMode.edit:BX.Location.Core.ControlMode.view}}},{key:"setAvailableTypesIds",value:function e(t){this._availableTypesIds=t}},{key:"layout",value:function e(){if(t.Type.isNull(this._addressWidget)){this._wrapper=t.Tag.render(C());return this._wrapper}var i={};var s=this.convertAddressToString(this.getAddress());if(this._isEditMode){this._wrapper=this.getEditHtml(s);i.mode=BX.Location.Core.ControlMode.edit;i.inputNode=this._domNodes.searchInput;i.mapBindElement=this._domNodes.searchInput;i.fieldsContainer=this._domNodes.detailsContainer;i.controlWrapper=this._domNodes.addressContainer}else{this._wrapper=this.getViewHtml(s);i.mode=BX.Location.Core.ControlMode.view;i.mapBindElement=this._wrapper}i.controlWrapper=this._domNodes.addressContainer;this._addressWidget.render(i);return this._wrapper}},{key:"openTypesMenu",value:function e(i){var n=this;if(this._isTypesMenuOpened){return}var r=[];var a=N(this._typesList),o;try{for(a.s();!(o=a.n()).done;){var d=o.value;var l=d.value===this._type;if(this._availableTypesIds.indexOf(d.value)<0&&!l){continue}r.push({text:d.name,value:d.value,onclick:this.onChangeType.bind(this)})}}catch(e){a.e(e)}finally{a.f()}s.MenuManager.show(this.typesMenuId,i,r,{angle:false,cacheable:false,events:{onPopupShow:function e(){n._isTypesMenuOpened=true},onPopupClose:function e(){n._isTypesMenuOpened=false}}});var u=s.MenuManager.getMenuById(this.typesMenuId);if(u&&t.Type.isDomNode(this._domNodes.addressTypeSelector)&&this._domNodes.addressTypeSelector.offsetWidth>200){u.getPopupWindow().setWidth(this._domNodes.addressTypeSelector.offsetWidth)}}},{key:"closeTypesMenu",value:function e(){var t=s.MenuManager.getMenuById(this.typesMenuId);if(t){t.close()}}},{key:"setTypeSelectorVisibility",value:function e(t){this._isTypeSelectorVisible=!!t}},{key:"getEditHtml",value:function e(i){this._domNodes.typeName=t.Tag.render(A());this._domNodes.searchInput=t.Tag.render(L(),i,this._isAutocompleteEnabled?"":"readonly");this._domNodes.icon=t.Tag.render(T());this._domNodes.addressContainer=t.Tag.render(b(),this._domNodes.icon,this._domNodes.searchInput);this._domNodes.detailsContainer=t.Tag.render(m());if(this._canChangeType){if(this._isTypeSelectorVisible){this._domNodes.addressTypeSelector=t.Tag.render(_(),this.onToggleTypesMenu.bind(this),this._domNodes.typeName);this._domNodes.addressTypeContainer=null;t.Dom.addClass(this._domNodes.addressContainer,["ui-ctl-inline","ui-ctl-w75"]);this._domNodes.addressContainer=t.Tag.render(g(),this._domNodes.addressTypeSelector,this._domNodes.addressContainer)}else{this._domNodes.addressTypeSelector=t.Tag.render(v(),this.onToggleTypesMenu.bind(this),this._domNodes.typeName);this._domNodes.addressTypeContainer=t.Tag.render(f(),t.Loc.getMessage("CRM_ADDRESS_TYPE"),this._domNodes.addressTypeSelector)}this.refreshTypeName()}this.refreshIcon();this._domNodes.detailsToggler=t.Tag.render(y(),this.onToggleDetailsVisibility.bind(this));this._domNodes.copyButton=t.Tag.render(h(),this.onCopyButtonClick.bind(this),t.Loc.getMessage("CRM_ADDRESS_COPY1"));this.refreshCopyButtonVisibility();this.setDetailsVisibility(this._showDetails);var s=t.Tag.render(c(),this._domNodes.copyButton?this._domNodes.copyButton:"",this._domNodes.detailsToggler,this._domNodes.addressContainer,this._domNodes.detailsContainer);if(this._canChangeType&&t.Type.isDomNode(this._domNodes.addressTypeContainer)){t.Dom.append(this._domNodes.addressTypeContainer,s)}return s}},{key:"getViewHtml",value:function e(i){var s=this;this._domNodes.addressContainer=t.Tag.render(p(),i);var n="";if(this._showAddressTypeInViewMode){var r=this._typesList.filter(function(e){return e.value==s._type}).map(function(e){return e.name}).join("");n=t.Tag.render(u(),t.Text.encode(r))}return t.Tag.render(l(),n,this._domNodes.addressContainer)}},{key:"refreshTypeName",value:function e(){var i=this;if(t.Type.isDomNode(this._domNodes.typeName)){var s=this._typesList.filter(function(e){return e.value===i._type}).map(function(e){return e.name}).join("");this._domNodes.typeName.textContent=s;this._domNodes.typeName.title=s}}},{key:"refreshIcon",value:function e(){var i=this._domNodes.icon;if(t.Type.isDomNode(i)){var s;if(this._isLoading){s=t.Tag.render(d())}else{var n=this.getAddress();if(n){s=t.Tag.render(o(),this.onDelete.bind(this))}else{s=t.Tag.render(a(),this._isAutocompleteEnabled?"ui-ctl-icon-search":"")}}t.Dom.replace(i,s);this._domNodes.icon=s}}},{key:"getIconState",value:function e(){var t=!!this.getAddress();return this._isLoading.toString()+t.toString()}},{key:"refreshCopyButtonVisibility",value:function e(){var i=this._domNodes.copyButton;if(t.Type.isDomNode(i)){var s=!!this.getAddress();t.Dom.style(i,"display",s?"":"none")}}},{key:"convertAddressToString",value:function e(t){if(!t){return""}return t.toString(this.getAddressFormat())}},{key:"getAddress",value:function e(){return t.Type.isNull(this._addressWidget)?null:this._addressWidget.address}},{key:"getAddressFormat",value:function e(){return t.Type.isNull(this._addressWidget)?null:this._addressWidget.addressFormat}},{key:"clearValue",value:function e(){if(!t.Type.isNull(this._addressWidget)){this._addressWidget.resetView();this._addressWidget.address=null}if(t.Type.isDomNode(this._domNodes.searchInput)){this._domNodes.searchInput.value=""}this._value="";this._isLoading=false;this.refreshIcon();this.refreshCopyButtonVisibility()}},{key:"setDetailsVisibility",value:function e(i){this._showDetails=!!i;if(this._showDetails){t.Dom.addClass(this._domNodes.detailsContainer,"visible");if(t.Type.isDomNode(this._domNodes.detailsToggler)){this._domNodes.detailsToggler.textContent=t.Loc.getMessage("CRM_ADDRESS_MODE_SHORT")}if(this._canChangeType){t.Dom.addClass(this._domNodes.addressTypeContainer,"visible")}}else{t.Dom.removeClass(this._domNodes.detailsContainer,"visible");if(t.Type.isDomNode(this._domNodes.detailsToggler)){this._domNodes.detailsToggler.textContent=t.Loc.getMessage("CRM_ADDRESS_MODE_DETAILED")}if(this._canChangeType){t.Dom.removeClass(this._domNodes.addressTypeContainer,"visible")}}}},{key:"showCopyDestinationPopup",value:function e(){var i=this;var n=s.PopupManager.create({id:this._id+"_copy_dst_popup",cacheable:false,autoHide:true,titleBar:t.Loc.getMessage("CRM_ADDRESS_COPY_TITLE"),content:this.getCopyDestinationLayout(),closeIcon:true,closeByEsc:true,buttons:[new BX.UI.Button({id:"copy",text:t.Loc.getMessage("CRM_ADDRESS_COPY2"),color:BX.UI.Button.Color.PRIMARY,state:BX.UI.ButtonState.DISABLED,onclick:function e(t){t.getContext().close();i.emit("onCopyAddress",{sourceId:i.getId(),destinationTypes:i._selectedCopyDestinations})}})]});n.show()}},{key:"getCopyDestinationLayout",value:function e(){var i=this;var s=this._typesList.filter(function(e){return e.value!=i._type});return t.Tag.render(r(),t.Loc.getMessage("CRM_ADDRESS_COPY_TO"),s.map(function(e){return t.Tag.render(n(),i.onChangeCopyDestination.bind(i),e.value,t.Text.encode(e.name))}))}},{key:"destroy",value:function e(){if(!t.Type.isNull(this._addressWidget)){this._addressWidget.destroy()}}},{key:"onToggleDetailsVisibility",value:function e(){this.setDetailsVisibility(!this._showDetails)}},{key:"onDelete",value:function e(){this.clearValue();this.emit("onUpdateAddress",{id:this.getId(),value:this.getValue()})}},{key:"onCopyButtonClick",value:function e(){this.showCopyDestinationPopup()}},{key:"onChangeCopyDestination",value:function e(t){var i=t.target;var n=i?i.value:null;var r=i?i.checked:false;if(r&&this._selectedCopyDestinations.indexOf(n)<0){this._selectedCopyDestinations.push(n)}if(!r&&this._selectedCopyDestinations.indexOf(n)>=0){this._selectedCopyDestinations.splice(this._selectedCopyDestinations.indexOf(n),1)}var a=s.PopupManager.getPopupById(this._id+"_copy_dst_popup");if(a){var o=a.getButton("copy");if(o){o.setDisabled(!this._selectedCopyDestinations.length)}}}},{key:"onToggleTypesMenu",value:function e(t){if(this._isTypesMenuOpened){this.closeTypesMenu()}else{this.openTypesMenu(t.target)}}},{key:"onChangeType",value:function e(t,i){this.closeTypesMenu();if(this._type!==i.value){var s=this._type;this._type=i.value;this.refreshTypeName();this.emit("onUpdateAddressType",{id:this.getId(),type:this.getType(),prevType:s})}}},{key:"onAddressWidgetChangedState",value:function e(t){var i=t.getData(),s=i.state;var n=this._isLoading;this.computeIsLoading();if(n!==this._isLoading){this.refreshIcon();this.refreshCopyButtonVisibility()}if(s===BX.Location.Widget.State.DATA_LOADING){this.emit("onStartLoadAddress",{id:this.getId()})}if(s===BX.Location.Widget.State.DATA_LOADED){this.emit("onAddressLoaded",{id:this.getId()})}}},{key:"onAddressChanged",value:function e(i){var s=this.getIconState();this._isLoading=false;var n=i.getData();this._value=t.Type.isObject(n.address)?n.address.toJson():"";if(s!==this.getIconState()){this.refreshIcon()}this.refreshCopyButtonVisibility();this.emit("onUpdateAddress",{id:this.getId(),value:this.getValue()})}},{key:"onFeatureEvent",value:function e(t){var i=t.getData();if(i.feature instanceof BX.Location.Widget.AutocompleteFeature){this._isDropdownLoading=i.eventCode===BX.Location.Widget.AutocompleteFeature.searchStartedEvent;var s=this._isLoading;this.computeIsLoading();if(s!==this._isLoading){this.refreshIcon();this.refreshCopyButtonVisibility()}}}},{key:"onError",value:function e(t){var i=t.getData();var s=i.errors;var n=s.map(function(e){return e.message+(e.code.length?"".concat(e.code):"")}).join(", ");this._isLoading=false;this.refreshIcon();this.refreshCopyButtonVisibility();this.emit("onError",{id:this.getId(),error:n})}},{key:"computeIsLoading",value:function e(){this._isLoading=this._addressWidget.state===BX.Location.Widget.State.DATA_LOADING||this._isDropdownLoading}},{key:"resetView",value:function e(){this._addressWidget.resetView()}}]);return i}(i.EventEmitter);e.EntityEditorBaseAddressField=w})(this.BX.Crm=this.BX.Crm||{},BX,BX.Event,BX.Main);
//# sourceMappingURL=address.bundle.map.js