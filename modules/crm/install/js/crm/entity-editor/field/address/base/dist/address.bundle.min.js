this.BX=this.BX||{};(function(e,t,s,i){"use strict";function n(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-ctl ui-ctl-w100 ui-ctl-checkbox ui-ctl-xs">\n\t\t\t\t\t<label>\n\t\t\t\t\t<input onclick="','" type="checkbox" value="','">\n\t\t\t\t\t\t<span class="ui-ctl-label-text">',"</span>\n\t\t\t\t\t</label>\n\t\t\t\t\t</div>\n\t\t\t\t\t"]);n=function t(){return e};return e}function r(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div>\n\t\t\t\t<div class="ui-title-7">',"</div>\n\t\t\t\t<div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);r=function t(){return e};return e}function a(){var e=babelHelpers.taggedTemplateLiteral(['<span class="ui-ctl-after ','"></span>']);a=function t(){return e};return e}function o(){var e=babelHelpers.taggedTemplateLiteral(['<button class="ui-ctl-after ui-ctl-icon-clear" onclick="','"></button>']);o=function t(){return e};return e}function d(){var e=babelHelpers.taggedTemplateLiteral(['<span class="ui-ctl-after ui-ctl-icon-loader"></span>']);d=function t(){return e};return e}function l(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-address-control-item">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t</div>"]);l=function t(){return e};return e}function u(){var e=babelHelpers.taggedTemplateLiteral(['<span class="ui-link ui-link-secondary">',":</span>"]);u=function t(){return e};return e}function p(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-entity-editor-content-block-text">\n\t\t\t\t<span class="ui-link ui-link-dark ui-link-dotted">',"</span>\n\t\t\t</div>"]);p=function t(){return e};return e}function h(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-address-control-item">\n\t\t\t\t<div class="crm-address-control-mode-switch">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t\t","\n\t\t\t\t","\n\t\t\t</div>"]);h=function t(){return e};return e}function c(){var e=babelHelpers.taggedTemplateLiteral(['<span class="ui-link ui-link-secondary ui-entity-editor-block-title-link" onclick="','">',"</span>"]);c=function t(){return e};return e}function y(){var e=babelHelpers.taggedTemplateLiteral(['<span class="ui-link ui-link-secondary ui-entity-editor-block-title-link" onclick="','"></span>']);y=function t(){return e};return e}function f(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="location-fields-control-block crm-address-type-block">\n\t\t\t\t\t\t<div class="ui-entity-editor-content-block ui-entity-editor-field-text">\n\t\t\t\t\t\t\t<div class="ui-entity-editor-block-title">\n\t\t\t\t\t\t\t\t<label class="ui-entity-editor-block-title-text">',"</label>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t","\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>"]);f=function t(){return e};return e}function v(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-ctl ui-ctl-w100 ui-ctl-after-icon ui-ctl-dropdown" onclick="','">\n\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>"]);v=function t(){return e};return e}function g(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-ctl-inline ui-ctl-w100">\n\t\t\t\t\t\t',"\n\t\t\t\t\t\t","\n\t\t\t\t\t</div>\n\t\t\t\t"]);g=function t(){return e};return e}function _(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-ctl ui-ctl-inline ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w25" onclick="','">\n\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>"]);_=function t(){return e};return e}function T(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="location-fields-control-block"></div>']);T=function t(){return e};return e}function b(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="crm-address-search-control-block">\n\t\t\t<div class="ui-ctl ui-ctl-w100 ui-ctl-after-icon">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t</div>\n\t\t</div>"]);b=function t(){return e};return e}function m(){var e=babelHelpers.taggedTemplateLiteral(["<span></span>"]);m=function t(){return e};return e}function A(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="text" class="ui-ctl-element ui-ctl-textbox" value="','" ',">"]);A=function t(){return e};return e}function I(){var e=babelHelpers.taggedTemplateLiteral(['<div class="ui-ctl-element"></div>']);I=function t(){return e};return e}function L(){var e=babelHelpers.taggedTemplateLiteral(["<div>Location module is not installed</div>"]);L=function t(){return e};return e}function C(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span class="ui-link ui-link-secondary ui-link-dotted" onmouseup="','"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>"]);C=function t(){return e};return e}function k(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="','"><span class="','" onclick="','">',"</span></div>\n\t\t\t"]);k=function t(){return e};return e}function w(){var e=babelHelpers.taggedTemplateLiteral(['<div class="crm-address-control-wrap ','"></div>']);w=function t(){return e};return e}function D(e,t){var s;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(s=B(e))||t&&e&&typeof e.length==="number"){if(s)e=s;var i=0;var n=function e(){};return{s:n,n:function t(){if(i>=e.length)return{done:true};return{done:false,value:e[i++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r=true,a=false,o;return{s:function t(){s=e[Symbol.iterator]()},n:function e(){var t=s.next();r=t.done;return t},e:function e(t){a=true;o=t},f:function e(){try{if(!r&&s.return!=null)s.return()}finally{if(a)throw o}}}}function B(e,t){if(!e)return;if(typeof e==="string")return M(e,t);var s=Object.prototype.toString.call(e).slice(8,-1);if(s==="Object"&&e.constructor)s=e.constructor.name;if(s==="Map"||s==="Set")return Array.from(e);if(s==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return M(e,t)}function M(e,t){if(t==null||t>e.length)t=e.length;for(var s=0,i=new Array(t);s<t;s++){i[s]=e[s]}return i}var N=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"initialize",value:function e(t,s){this._id=BX.type.isNotEmptyString(t)?t:BX.util.getRandomString(4);this._isMultiple=false;this._settings=s?s:{};this._typesList=[];this._availableTypesIds=[];this._allowedTypeIds=[];this._addressList=[];this._wrapper=null;this._isEditMode=true;this._showFirstItemOnly=BX.prop.getBoolean(s,"showFirstItemOnly",false);this._enableAutocomplete=BX.prop.getBoolean(s,"enableAutocomplete",true);this._hideDefaultAddressType=BX.prop.getBoolean(this._settings,"hideDefaultAddressType",false);this._showAddressTypeInViewMode=BX.prop.getBoolean(this._settings,"showAddressTypeInViewMode",false);this._addrZoneConfig=BX.prop.getObject(this._settings,"addressZoneConfig",{});this._countryId=BX.prop.getInteger(this._settings,"countryId",BX.prop.getInteger(this._addrZoneConfig,"countryId",0));this._defaultAddressType=BX.prop.getInteger(this._addrZoneConfig,"defaultAddressType",0);this.updateAllowedTypes()}},{key:"setMultiple",value:function e(t){this._isMultiple=!!t}},{key:"setValue",value:function e(s){if(this._isMultiple){var i=t.Type.isPlainObject(s)?s:{};var n=Object.keys(i);var r=this._addressList.length>0&&n.length==this._addressList.length;if(r){var a=D(this._addressList),o;try{for(a.s();!(o=a.n()).done;){var d=o.value;var l=d.getType();if(!i.hasOwnProperty(l)||i[l]!==d.getValue()){r=false;break}}}catch(e){a.e(e)}finally{a.f()}}if(!r&&!n.length&&this._addressList.length===1&&!this._addressList[0].getValue().length){r=true}if(r){return false}this.removeAllAddresses();for(var u=0,p=n;u<p.length;u++){var h=p[u];this.addAddress(h,i[h])}if(!n.length){this.addAddress(this.getDefaultType(),null)}}else{this.removeAllAddresses();var c=t.Type.isStringFilled(s)?s:null;this.addAddress(null,c)}return true}},{key:"getValue",value:function e(){if(this._isMultiple){var s=[];var i=D(this._addressList),n;try{for(i.s();!(n=i.n()).done;){var r=n.value;var a=r.getValue();if(t.Type.isString(a)){s.push({type:r.getType(),value:a})}}}catch(e){i.e(e)}finally{i.f()}return s}else{if(this._addressList&&this._addressList[0]&&t.Type.isString(this._addressList[0].getValue())){return this._addressList[0].getValue()}return null}}},{key:"setTypesList",value:function e(s){this._typesList=[];if(t.Type.isPlainObject(s)){for(var i=0,n=Object.keys(s);i<n.length;i++){var r=n[i];this._typesList.push(s[r])}}this.initAvailableTypes()}},{key:"getTypesList",value:function e(){var t=[];var s=D(this._typesList),i;try{for(s.s();!(i=s.n()).done;){var n=i.value;var r=BX.prop.getString(n,"ID","");var a=BX.prop.getString(n,"DESCRIPTION","");t.push({name:a,value:r})}}catch(e){s.e(e)}finally{s.f()}return t}},{key:"setAllowedTypes",value:function e(s){this._allowedTypeIds=[];if(t.Type.isArray(s)){this._allowedTypeIds=s}}},{key:"getAllowedTypes",value:function e(){return this._allowedTypeIds}},{key:"setCountryId",value:function e(t){var s=false;t=parseInt(t);if(this._countryId!==t){s=true}this._countryId=t;if(s){this.updateAllowedTypes()}}},{key:"getCountryId",value:function e(){return this._countryId}},{key:"getAddressZoneConfig",value:function e(){return this._addrZoneConfig}},{key:"getValueTypes",value:function e(){var t=[];var s=D(this._addressList),i;try{for(s.s();!(i=s.n()).done;){var n=i.value;var r=parseInt(n.getType());if(t.indexOf(r)<0){t.push(r)}}}catch(e){s.e(e)}finally{s.f()}return t}},{key:"updateAllowedTypes",value:function e(){var s=[];var i=this.getValueTypes();var n=this.getCountryId();var r=this.getAddressZoneConfig();if(t.Type.isPlainObject(r)){if(r.hasOwnProperty("currentZoneAddressTypes")&&t.Type.isArray(r["currentZoneAddressTypes"])){var a;var o;var d=r["currentZoneAddressTypes"];for(a=0;a<d.length;a++){o=parseInt(d[a]);if(s.indexOf(o)<0){s.push(o)}}if(n>0&&r.hasOwnProperty("countryAddressTypeMap")&&t.Type.isPlainObject(r["countryAddressTypeMap"])&&r["countryAddressTypeMap"].hasOwnProperty(n)&&t.Type.isArray(r["countryAddressTypeMap"][n])){var l=r["countryAddressTypeMap"][n];for(a=0;a<l.length;a++){o=parseInt(l[a]);if(s.indexOf(o)<0){s.push(o)}}}for(a=0;a<i.length;a++){o=parseInt(i[a]);if(s.indexOf(o)<0){s.push(o)}}}}this._allowedTypeIds=s;var u=D(this._addressList),p;try{for(u.s();!(p=u.n()).done;){var h=p.value;h.setAllowedTypesIds(babelHelpers.toConsumableArray(this._allowedTypeIds))}}catch(e){u.e(e)}finally{u.f()}}},{key:"getDefaultType",value:function e(){var t=this._defaultAddressType.toString();if(t>0&&this._availableTypesIds.indexOf(t)>=0&&this._allowedTypeIds.indexOf(parseInt(t))>=0){return t}var s=D(this._typesList),i;try{for(s.s();!(i=s.n()).done;){var n=i.value;var r=BX.prop.getString(n,"ID","");var a=BX.prop.getString(n,"IS_DEFAULT",false);if(a&&this._availableTypesIds.indexOf(r)>=0&&this._allowedTypeIds.indexOf(parseInt(r))>=0){return r}}}catch(e){s.e(e)}finally{s.f()}var o=D(this._typesList),d;try{for(o.s();!(d=o.n()).done;){var l=d.value;var u=BX.prop.getString(l,"ID","");if(this._availableTypesIds.indexOf(u)>=0&&this._allowedTypeIds.indexOf(parseInt(u))>=0){return u}}}catch(e){o.e(e)}finally{o.f()}return null}},{key:"layout",value:function e(s){this._isEditMode=s;this._wrapper=t.Tag.render(w(),this._isEditMode?"crm-address-control-wrap-edit":"");this.refreshLayout();return this._wrapper}},{key:"refreshLayout",value:function e(){t.Dom.clean(this._wrapper);var s=true;var i=D(this._addressList),n;try{for(i.s();!(n=i.n()).done;){var r=n.value;r.setEditMode(this._isEditMode);if(!this._isEditMode&&this._showFirstItemOnly&&s>1){var a=t.Tag.render(C(),this.onShowMoreMouseUp.bind(this),t.Loc.getMessage("CRM_ADDRESS_SHOW_ALL"));t.Dom.append(a,this._wrapper);break}else{t.Dom.append(r.layout(),this._wrapper)}s++}}catch(e){i.e(e)}finally{i.f()}if(this._isEditMode&&this._isMultiple&&!t.Type.isNull(this.getDefaultType())){var o=BX.prop.getBoolean(this._settings,"crmCompatibilityMode",false);var d=o?"crm-entity-widget-content-block-add-field":"ui-entity-widget-content-block-add-field";var l=o?"crm-entity-widget-content-add-field":"ui-entity-editor-content-add-lnk";t.Dom.append(t.Tag.render(k(),d,l,this.onAddNewAddress.bind(this),t.Loc.getMessage("CRM_ADDRESS_ADD")),this._wrapper)}}},{key:"release",value:function e(){t.Dom.clean(this._wrapper);this.removeAllAddresses()}},{key:"removeAllAddresses",value:function e(){var t=this._addressList.map(function(e){return e.getId()});var s=D(t),i;try{for(s.s();!(i=s.n()).done;){var n=i.value;this.removeAddress(n)}}catch(e){s.e(e)}finally{s.f()}}},{key:"addAddress",value:function e(s){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var n=new S(t.Text.getRandom(8),{typesList:this.getTypesList(),availableTypesIds:babelHelpers.toConsumableArray(this._availableTypesIds),allowedTypesIds:babelHelpers.toConsumableArray(this._allowedTypeIds),canChangeType:this._isMultiple,enableAutocomplete:this._enableAutocomplete,showAddressTypeInViewMode:this._isMultiple&&this._showAddressTypeInViewMode,type:s,value:i});n.subscribe("onUpdateAddress",this.onUpdateAddress.bind(this));n.subscribe("onUpdateAddressType",this.onUpdateAddressType.bind(this));n.subscribe("onDelete",this.onDeleteAddress.bind(this));n.subscribe("onStartLoadAddress",this.onStartLoadAddress.bind(this));n.subscribe("onAddressLoaded",this.onAddressLoaded.bind(this));n.subscribe("onAddressDataInputting",this.onAddressDataInputting.bind(this));n.subscribe("onError",this.onError.bind(this));n.subscribe("onCopyAddress",this.onCopyAddress.bind(this));this.updateAvailableTypes(s,null);this._addressList.push(n);this.updateAllowedTypes();this.updateTypeSelectorVisibility(this._addressList.length>1);return n}},{key:"removeAddress",value:function e(t){var s=this.getAddressById(t);if(s){var i=s.getType();this._addressList.splice(this._addressList.indexOf(s),1);this.updateAvailableTypes(null,i);this.updateAllowedTypes();this.updateTypeSelectorVisibility(this._addressList.length>1);s.destroy()}}},{key:"getAddressById",value:function e(t){return this._addressList.filter(function(e){return e.getId()===t}).reduce(function(e,t){return e?e:t},null)}},{key:"initAvailableTypes",value:function e(){this._availableTypesIds=[];var t=D(this._typesList),s;try{for(t.s();!(s=t.n()).done;){var i=s.value;this._availableTypesIds.push(BX.prop.getString(i,"ID",""))}}catch(e){t.e(e)}finally{t.f()}}},{key:"updateAvailableTypes",value:function e(s,i){if(!t.Type.isNull(i)&&this._availableTypesIds.indexOf(i)<0){this._availableTypesIds.push(i)}if(!t.Type.isNull(s)&&this._availableTypesIds.indexOf(s)>=0){this._availableTypesIds.splice(this._availableTypesIds.indexOf(s),1)}var n=D(this._addressList),r;try{for(n.s();!(r=n.n()).done;){var a=r.value;a.setAvailableTypesIds(babelHelpers.toConsumableArray(this._availableTypesIds))}}catch(e){n.e(e)}finally{n.f()}}},{key:"updateTypeSelectorVisibility",value:function e(t){if(!this._hideDefaultAddressType){return}var s=D(this._addressList),i;try{for(s.s();!(i=s.n()).done;){var n=i.value;n.setTypeSelectorVisibility(t)}}catch(e){s.e(e)}finally{s.f()}}},{key:"emitUpdateEvent",value:function e(){s.EventEmitter.emit(this,"onUpdate",{value:this.getValue()})}},{key:"onAddNewAddress",value:function e(){this.addAddress(this.getDefaultType());this.refreshLayout()}},{key:"onUpdateAddress",value:function e(t){this.emitUpdateEvent()}},{key:"onDeleteAddress",value:function e(t){var s=t.getData();var i=s.id;if(this._addressList.length<=1){var n=this.getAddressById(i);if(n){n.clearValue()}return}this.removeAddress(i);this.refreshLayout()}},{key:"onUpdateAddressType",value:function e(t){var s=t.getData();var i=s.prevType;var n=s.type;this.updateAvailableTypes(n,i);this.updateAllowedTypes();this.emitUpdateEvent()}},{key:"onShowMoreMouseUp",value:function e(t){t.stopPropagation();this._showFirstItemOnly=false;this.refreshLayout();return false}},{key:"onStartLoadAddress",value:function e(t){s.EventEmitter.emit(this,"onStartLoadAddress")}},{key:"onAddressLoaded",value:function e(t){s.EventEmitter.emit(this,"onAddressLoaded")}},{key:"onAddressDataInputting",value:function e(t){s.EventEmitter.emit(this,"onAddressDataInputting")}},{key:"onError",value:function e(t){s.EventEmitter.emit(this,"onError",t)}},{key:"onCopyAddress",value:function e(t){var s=this;var i=t.getData();var n=this.getAddressById(i.sourceId);if(!n){return}var r=n.getValue();if(!r.length){return}var a=function e(t){var n=i.destinationTypes[t];var a=s._addressList.filter(function(e){return e.getType()==n}).reduce(function(e,t){return e?e:t},null);if(a){a.setValue(r)}else{a=s.addAddress(n,r)}a.markAsNew();s.refreshLayout()};for(var o=0;o<i.destinationTypes.length;o++){a(o)}this.emitUpdateEvent()}},{key:"resetView",value:function e(){var t=D(this._addressList),s;try{for(t.s();!(s=t.n()).done;){var i=s.value;i.resetView()}}catch(e){t.e(e)}finally{t.f()}}}],[{key:"create",value:function t(s,i){var n=new e;n.initialize(s,i);return n}}]);return e}();var S=function(e){babelHelpers.inherits(s,e);function s(e,i){var n;babelHelpers.classCallCheck(this,s);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(s).call(this));n.setEventNamespace("BX.Crm.AddressItem");n._id=e;n._value=BX.prop.getString(i,"value","");n._isTypesMenuOpened=false;n._typesList=BX.prop.getArray(i,"typesList",[]);n._availableTypesIds=BX.prop.getArray(i,"availableTypesIds",[]);n._allowedTypesIds=BX.prop.getArray(i,"allowedTypesIds",[]);n._canChangeType=BX.prop.getBoolean(i,"canChangeType",false);n.typesMenuId="address_type_menu_"+n._id;n._type=BX.prop.getString(i,"type","");n._isEditMode=true;n._isTypeSelectorVisible=BX.prop.getBoolean(i,"isTypeSelectorVisible",true);n._isAutocompleteEnabled=BX.prop.getBoolean(i,"enableAutocomplete",true);n._showAddressTypeInViewMode=BX.prop.getBoolean(i,"showAddressTypeInViewMode",true);n._showDetails=!n._isAutocompleteEnabled||BX.prop.getBoolean(i,"showDetails",false);n._isLoading=false;n._isDropdownLoading=false;n._addressWidget=null;n._wrapper=null;n._domNodes={};n._selectedCopyDestinations=[];n._isLocationModuleInstalled=!t.Type.isUndefined(BX.Location)&&!t.Type.isUndefined(BX.Location.Core)&&!t.Type.isUndefined(BX.Location.Widget);n.initializeAddressWidget();return n}babelHelpers.createClass(s,[{key:"initializeAddressWidget",value:function e(){if(!this._isLocationModuleInstalled){return}var s=this.getValue();var i=null;if(t.Type.isStringFilled(s)){try{i=new BX.Location.Core.Address(JSON.parse(s))}catch(e){}}var n=new BX.Location.Widget.Factory;this._addressWidget=n.createAddressWidget({address:i,mode:this._isEditMode?BX.Location.Core.ControlMode.edit:BX.Location.Core.ControlMode.view,popupBindOptions:{position:"right"}});this._addressWidget.subscribeOnStateChangedEvent(this.onAddressWidgetChangedState.bind(this));this._addressWidget.subscribeOnAddressChangedEvent(this.onAddressChanged.bind(this));this._addressWidget.subscribeOnFeatureEvent(this.onFeatureEvent.bind(this));this._addressWidget.subscribeOnErrorEvent(this.onError.bind(this))}},{key:"getId",value:function e(){return this._id}},{key:"getType",value:function e(){return this._type}},{key:"getValue",value:function e(){return this._value}},{key:"setValue",value:function e(t){this.destroy();this._value=t;this.initializeAddressWidget()}},{key:"markAsNew",value:function e(){var t=this.getAddress();if(t){t.id=0;t.clearLinks()}this._value=t?t.toJson():""}},{key:"setEditMode",value:function e(s){this._isEditMode=!!s;if(!t.Type.isNull(this._addressWidget)){this._addressWidget.mode=s?BX.Location.Core.ControlMode.edit:BX.Location.Core.ControlMode.view}}},{key:"setAvailableTypesIds",value:function e(t){this._availableTypesIds=t}},{key:"setAllowedTypesIds",value:function e(t){this._allowedTypesIds=t}},{key:"getTypeListByIds",value:function e(s){var i=[];if(t.Type.isArray(s)&&s.length>0){var n={};var r=D(this._typesList),a;try{for(r.s();!(a=r.n()).done;){var o=a.value;n["a"+o.value]=o}}catch(e){r.e(e)}finally{r.f()}var d=D(s),l;try{for(d.s();!(l=d.n()).done;){var u=l.value;var p="a"+u;if(n.hasOwnProperty(p)){i.push(n[p])}}}catch(e){d.e(e)}finally{d.f()}}return i}},{key:"layout",value:function e(){if(t.Type.isNull(this._addressWidget)){this._wrapper=t.Tag.render(L());return this._wrapper}var s={};var i=this.convertAddressToString(this.getAddress());if(this._isEditMode){this._wrapper=this.getEditHtml(i);s.mode=BX.Location.Core.ControlMode.edit;s.inputNode=this._domNodes.searchInput;s.mapBindElement=this._domNodes.searchInput;s.fieldsContainer=this._domNodes.detailsContainer;s.controlWrapper=this._domNodes.addressContainer}else{this._wrapper=this.getViewHtml(i);s.mode=BX.Location.Core.ControlMode.view;s.mapBindElement=this._wrapper}s.controlWrapper=this._domNodes.addressContainer;this._addressWidget.render(s);return this._wrapper}},{key:"openTypesMenu",value:function e(s){var n=this;if(this._isTypesMenuOpened){return}var r=[];var a=babelHelpers.toConsumableArray(this._allowedTypesIds);var o=parseInt(this._type);if(a.indexOf(o)<0){a.push(o)}var d=D(this.getTypeListByIds(a)),l;try{for(d.s();!(l=d.n()).done;){var u=l.value;var p=o===parseInt(u.value);if(this._availableTypesIds.indexOf(u.value)<0&&!p){continue}r.push({text:u.name,value:u.value,onclick:this.onChangeType.bind(this)})}}catch(e){d.e(e)}finally{d.f()}i.MenuManager.show(this.typesMenuId,s,r,{angle:false,cacheable:false,events:{onPopupShow:function e(){n._isTypesMenuOpened=true},onPopupClose:function e(){n._isTypesMenuOpened=false}}});var h=i.MenuManager.getMenuById(this.typesMenuId);if(h&&t.Type.isDomNode(this._domNodes.addressTypeSelector)&&this._domNodes.addressTypeSelector.offsetWidth>200){h.getPopupWindow().setWidth(this._domNodes.addressTypeSelector.offsetWidth)}}},{key:"closeTypesMenu",value:function e(){var t=i.MenuManager.getMenuById(this.typesMenuId);if(t){t.close()}}},{key:"setTypeSelectorVisibility",value:function e(t){this._isTypeSelectorVisible=!!t}},{key:"getEditHtml",value:function e(s){this._domNodes.typeName=t.Tag.render(I());this._domNodes.searchInput=t.Tag.render(A(),s,this._isAutocompleteEnabled?"":"readonly");this._domNodes.icon=t.Tag.render(m());this._domNodes.addressContainer=t.Tag.render(b(),this._domNodes.icon,this._domNodes.searchInput);this._domNodes.detailsContainer=t.Tag.render(T());if(this._canChangeType){if(this._isTypeSelectorVisible){this._domNodes.addressTypeSelector=t.Tag.render(_(),this.onToggleTypesMenu.bind(this),this._domNodes.typeName);this._domNodes.addressTypeContainer=null;t.Dom.addClass(this._domNodes.addressContainer,["ui-ctl-inline","ui-ctl-w75"]);this._domNodes.addressContainer=t.Tag.render(g(),this._domNodes.addressTypeSelector,this._domNodes.addressContainer)}else{this._domNodes.addressTypeSelector=t.Tag.render(v(),this.onToggleTypesMenu.bind(this),this._domNodes.typeName);this._domNodes.addressTypeContainer=t.Tag.render(f(),t.Loc.getMessage("CRM_ADDRESS_TYPE"),this._domNodes.addressTypeSelector)}this.refreshTypeName()}this.refreshIcon();this._domNodes.detailsToggler=t.Tag.render(y(),this.onToggleDetailsVisibility.bind(this));if(this._canChangeType){this._domNodes.copyButton=t.Tag.render(c(),this.onCopyButtonClick.bind(this),t.Loc.getMessage("CRM_ADDRESS_COPY1"))}this.refreshCopyButtonVisibility();this.setDetailsVisibility(this._showDetails);var i=t.Tag.render(h(),this._domNodes.copyButton?this._domNodes.copyButton:"",this._domNodes.detailsToggler,this._domNodes.addressContainer,this._domNodes.detailsContainer);if(this._canChangeType&&t.Type.isDomNode(this._domNodes.addressTypeContainer)){t.Dom.append(this._domNodes.addressTypeContainer,i)}return i}},{key:"getViewHtml",value:function e(s){var i=this;this._domNodes.addressContainer=t.Tag.render(p(),s);var n="";if(this._showAddressTypeInViewMode){var r=this._typesList.filter(function(e){return e.value==i._type}).map(function(e){return e.name}).join("");n=t.Tag.render(u(),t.Text.encode(r))}return t.Tag.render(l(),n,this._domNodes.addressContainer)}},{key:"refreshTypeName",value:function e(){var s=this;if(t.Type.isDomNode(this._domNodes.typeName)){var i=this._typesList.filter(function(e){return e.value===s._type}).map(function(e){return e.name}).join("");this._domNodes.typeName.textContent=i;this._domNodes.typeName.title=i}}},{key:"refreshIcon",value:function e(){var s=this._domNodes.icon;if(t.Type.isDomNode(s)){var i;if(this._isLoading){i=t.Tag.render(d())}else{var n=this.getAddress();if(n){i=t.Tag.render(o(),this.onDelete.bind(this))}else{i=t.Tag.render(a(),this._isAutocompleteEnabled?"ui-ctl-icon-search":"")}}t.Dom.replace(s,i);this._domNodes.icon=i}}},{key:"refreshCopyButtonVisibility",value:function e(){var s=this._domNodes.copyButton;if(t.Type.isDomNode(s)){var i=!!this.getAddress();t.Dom.style(s,"display",i?"":"none")}}},{key:"convertAddressToString",value:function e(t){if(!t){return""}return t.toString(this.getAddressFormat())}},{key:"getAddress",value:function e(){return t.Type.isNull(this._addressWidget)?null:this._addressWidget.address}},{key:"getAddressFormat",value:function e(){return t.Type.isNull(this._addressWidget)?null:this._addressWidget.addressFormat}},{key:"clearValue",value:function e(){if(!t.Type.isNull(this._addressWidget)){this._addressWidget.resetView();this._addressWidget.address=null}if(t.Type.isDomNode(this._domNodes.searchInput)){this._domNodes.searchInput.value=""}this._value="";this._isLoading=false;this.refreshIcon();this.refreshCopyButtonVisibility()}},{key:"setDetailsVisibility",value:function e(s){this._showDetails=!!s;if(this._showDetails){t.Dom.addClass(this._domNodes.detailsContainer,"visible");if(t.Type.isDomNode(this._domNodes.detailsToggler)){this._domNodes.detailsToggler.textContent=t.Loc.getMessage("CRM_ADDRESS_MODE_SHORT")}if(this._canChangeType){t.Dom.addClass(this._domNodes.addressTypeContainer,"visible")}}else{t.Dom.removeClass(this._domNodes.detailsContainer,"visible");if(t.Type.isDomNode(this._domNodes.detailsToggler)){this._domNodes.detailsToggler.textContent=t.Loc.getMessage("CRM_ADDRESS_MODE_DETAILED")}if(this._canChangeType){t.Dom.removeClass(this._domNodes.addressTypeContainer,"visible")}}}},{key:"showCopyDestinationPopup",value:function e(){var s=this;var n=i.PopupManager.create({id:this._id+"_copy_dst_popup",cacheable:false,autoHide:true,titleBar:t.Loc.getMessage("CRM_ADDRESS_COPY_TITLE"),content:this.getCopyDestinationLayout(),closeIcon:true,closeByEsc:true,buttons:[new BX.UI.Button({id:"copy",text:t.Loc.getMessage("CRM_ADDRESS_COPY2"),color:BX.UI.Button.Color.PRIMARY,state:BX.UI.ButtonState.DISABLED,onclick:function e(t){t.getContext().close();s.emit("onCopyAddress",{sourceId:s.getId(),destinationTypes:s._selectedCopyDestinations})}})]});n.show()}},{key:"getCopyDestinationLayout",value:function e(){var s=this;var i=this.getTypeListByIds(this._allowedTypesIds).filter(function(e){return e.value!==s._type});return t.Tag.render(r(),t.Loc.getMessage("CRM_ADDRESS_COPY_TO"),i.map(function(e){return t.Tag.render(n(),s.onChangeCopyDestination.bind(s),e.value,t.Text.encode(e.name))}))}},{key:"destroy",value:function e(){if(!t.Type.isNull(this._addressWidget)){this._addressWidget.destroy()}}},{key:"onToggleDetailsVisibility",value:function e(){this.setDetailsVisibility(!this._showDetails)}},{key:"onDelete",value:function e(){this.clearValue();this.emit("onUpdateAddress",{id:this.getId(),value:this.getValue()})}},{key:"onCopyButtonClick",value:function e(){this.showCopyDestinationPopup()}},{key:"onChangeCopyDestination",value:function e(t){var s=t.target;var n=s?s.value:null;var r=s?s.checked:false;if(r&&this._selectedCopyDestinations.indexOf(n)<0){this._selectedCopyDestinations.push(n)}if(!r&&this._selectedCopyDestinations.indexOf(n)>=0){this._selectedCopyDestinations.splice(this._selectedCopyDestinations.indexOf(n),1)}var a=i.PopupManager.getPopupById(this._id+"_copy_dst_popup");if(a){var o=a.getButton("copy");if(o){o.setDisabled(!this._selectedCopyDestinations.length)}}}},{key:"onToggleTypesMenu",value:function e(t){if(this._isTypesMenuOpened){this.closeTypesMenu()}else{this.openTypesMenu(t.target)}}},{key:"onChangeType",value:function e(t,s){this.closeTypesMenu();if(this._type!==s.value){var i=this._type;this._type=s.value;this.refreshTypeName();this.emit("onUpdateAddressType",{id:this.getId(),type:this.getType(),prevType:i})}}},{key:"onAddressWidgetChangedState",value:function e(t){var s=t.getData(),i=s.state;var n=this._isLoading;this.computeIsLoading();if(n!==this._isLoading){this.refreshIcon();this.refreshCopyButtonVisibility()}if(i===BX.Location.Widget.State.DATA_LOADING){this.emit("onStartLoadAddress",{id:this.getId()})}else if(i===BX.Location.Widget.State.DATA_LOADED){this.emit("onAddressLoaded",{id:this.getId()})}else if(i===BX.Location.Widget.State.DATA_INPUTTING){this.emit("onAddressDataInputting",{id:this.getId()})}}},{key:"onAddressChanged",value:function e(s){this._isLoading=false;var i=s.getData();this._value=t.Type.isObject(i.address)?i.address.toJson():"";this.refreshIcon();this.refreshCopyButtonVisibility();this.emit("onUpdateAddress",{id:this.getId(),value:this.getValue()})}},{key:"onFeatureEvent",value:function e(t){var s=t.getData();if(s.feature instanceof BX.Location.Widget.AutocompleteFeature){this._isDropdownLoading=s.eventCode===BX.Location.Widget.AutocompleteFeature.searchStartedEvent;var i=this._isLoading;this.computeIsLoading();if(i!==this._isLoading){this.refreshIcon();this.refreshCopyButtonVisibility()}}}},{key:"onError",value:function e(t){var s=t.getData();var i=s.errors;var n=i.map(function(e){return e.message+(e.code.length?"".concat(e.code):"")}).join(", ");this._isLoading=false;this.refreshIcon();this.refreshCopyButtonVisibility();this.emit("onError",{id:this.getId(),error:n})}},{key:"computeIsLoading",value:function e(){this._isLoading=this._addressWidget.state===BX.Location.Widget.State.DATA_LOADING||this._isDropdownLoading}},{key:"resetView",value:function e(){this._addressWidget.resetView()}}]);return s}(s.EventEmitter);e.EntityEditorBaseAddressField=N})(this.BX.Crm=this.BX.Crm||{},BX,BX.Event,BX.Main);
//# sourceMappingURL=address.bundle.map.js