this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(t,e,i,a,r){"use strict";var n,l,s,o,p;function u(t,e){c(t,e);e.add(t)}function d(t,e,i){c(t,e);e.set(t,i)}function c(t,e){if(e.has(t)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function h(t,e,i){if(!e.has(t)){throw new TypeError("attempted to get private field on non-instance")}return i}var v=new WeakMap;var g=new WeakMap;var b=new WeakMap;var y=new WeakMap;var m=new WeakMap;var f=new WeakMap;var T=new WeakMap;var P=new WeakMap;var I=new WeakMap;var E=new WeakMap;var S=new WeakSet;var B=new WeakSet;var H=function(){function t(){babelHelpers.classCallCheck(this,t);u(this,B);u(this,S);d(this,v,{writable:true,value:void 0});d(this,g,{writable:true,value:void 0});d(this,b,{writable:true,value:void 0});d(this,y,{writable:true,value:void 0});d(this,m,{writable:true,value:void 0});d(this,f,{writable:true,value:void 0});d(this,T,{writable:true,value:""});d(this,P,{writable:true,value:void 0});d(this,I,{writable:true,value:void 0});d(this,E,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,I,{phone:[],email:[]});babelHelpers.classPrivateFieldSet(this,E,{phone:[],email:[]});babelHelpers.classPrivateFieldSet(this,P,{id:0,fullName:"",profileUrl:"",photoUrl:""})}babelHelpers.createClass(t,[{key:"toPlainObject",value:function t(){return{entityTypeName:babelHelpers.classPrivateFieldGet(this,v),entityId:babelHelpers.classPrivateFieldGet(this,g),entityTypeTitle:babelHelpers.classPrivateFieldGet(this,b),entityTitle:babelHelpers.classPrivateFieldGet(this,y),isMy:babelHelpers.classPrivateFieldGet(this,m),entityUrl:babelHelpers.classPrivateFieldGet(this,f),relatedEntityTitle:babelHelpers.classPrivateFieldGet(this,T),responsible:babelHelpers.classPrivateFieldGet(this,P),communications:babelHelpers.classPrivateFieldGet(this,I),matchIndex:babelHelpers.classPrivateFieldGet(this,E)}}},{key:"addPhones",value:function t(e,i){var a=BX.prop.getArray(i,"PHONE",[]);h(this,B,k).call(this,"phone",e,a)}},{key:"addEmails",value:function t(e,i){var a=BX.prop.getArray(i,"EMAIL",[]);h(this,B,k).call(this,"email",e,a)}},{key:"entityTypeName",set:function t(e){babelHelpers.classPrivateFieldSet(this,v,e)},get:function t(){return babelHelpers.classPrivateFieldGet(this,v)}},{key:"entityId",set:function t(e){babelHelpers.classPrivateFieldSet(this,g,e)},get:function t(){return babelHelpers.classPrivateFieldGet(this,g)}},{key:"entityTypeTitle",set:function t(e){babelHelpers.classPrivateFieldSet(this,b,e)},get:function t(){return babelHelpers.classPrivateFieldGet(this,b)}},{key:"entityTitle",set:function t(e){babelHelpers.classPrivateFieldSet(this,y,e)},get:function t(){return babelHelpers.classPrivateFieldGet(this,y)}},{key:"isMy",set:function t(e){babelHelpers.classPrivateFieldSet(this,m,e)},get:function t(){return babelHelpers.classPrivateFieldGet(this,m)}},{key:"entityUrl",set:function t(e){babelHelpers.classPrivateFieldSet(this,f,e)},get:function t(){return babelHelpers.classPrivateFieldGet(this,f)}},{key:"relatedEntityTitle",set:function t(e){babelHelpers.classPrivateFieldSet(this,T,e)},get:function t(){return babelHelpers.classPrivateFieldGet(this,T)}},{key:"responsible",set:function t(e){babelHelpers.classPrivateFieldSet(this,P,e)},get:function t(){return babelHelpers.classPrivateFieldGet(this,P)}}]);return t}();function w(t,e,i){if(babelHelpers.classPrivateFieldGet(this,I)[t].indexOf(e)<0){if(i){babelHelpers.classPrivateFieldGet(this,E)[t].push(babelHelpers.classPrivateFieldGet(this,I)[t].length)}babelHelpers.classPrivateFieldGet(this,I)[t].push(e)}}function k(t,e,i){for(var a=0;a<e.length;a++){h(this,S,w).call(this,t,e[a],i.includes(a.toString()))}}var F=new WeakMap;var C=new WeakSet;var X=new WeakSet;var N=new WeakSet;var M=function(t){babelHelpers.inherits(r,t);function r(){var t;babelHelpers.classCallCheck(this,r);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(r).call(this));u(babelHelpers.assertThisInitialized(t),N);u(babelHelpers.assertThisInitialized(t),X);u(babelHelpers.assertThisInitialized(t),C);d(babelHelpers.assertThisInitialized(t),F,{writable:true,value:void 0});t.setEventNamespace("crm.entity-editor.summary-list.close");t.id="";t.popupId="";t.settings={};t.anchor=null;t.wrapper=null;t.clientSearchBox=null;t.enableEntitySelect=false;t.items=[];t.padding=0;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),F,null);return t}babelHelpers.createClass(r,[{key:"initialize",value:function t(i,a){this.id=BX.type.isNotEmptyString(i)?i:BX.util.getRandomString(4);this.popupId=this.id+"_popup";if(e.Type.isPlainObject(a)){this.settings=a;this.anchor=BX.prop.getElementNode(a,"anchor",null);this.wrapper=BX.prop.getElementNode(a,"wrapper",null);this.clientSearchBox=BX.prop.get(a,"clientSearchBox",null);this.enableEntitySelect=BX.prop.getBoolean(a,"enableEntitySelect",false)}this.padding=BX.prop.getInteger(a,"padding",11)}},{key:"show",value:function t(){var i=this;var r=a.PopupManager.create({id:this.popupId,cacheable:false,padding:this.padding,contentPadding:0,content:this.getLayout(),closeIcon:{top:"11px",right:"5px"},borderRadius:"12px",closeByEsc:false,background:h(this,C,x).call(this),animation:{closeAnimationType:"animation",showClassName:"crm-dups-popup-open",closeClassName:"crm-dups-popup-close"}});if(!babelHelpers.classPrivateFieldGet(this,F)){babelHelpers.classPrivateFieldSet(this,F,this.adjustPosition.bind(this));e.bind(window,"resize",babelHelpers.classPrivateFieldGet(this,F))}r.subscribe("onDestroy",(function(){i.emit("close",i)}));r.subscribe("onFirstShow",(function(t){t.target.getZIndexComponent().subscribe("onZIndexChange",(function(t){if(t.target.getZIndex()!==850){t.target.setZIndex(850)}}))}));r.show();this.adjustPosition()}},{key:"getController",value:function t(){var e=BX.prop.get(this.settings,"controller",null);return e instanceof BX.CrmDupController?e:null}},{key:"getTargetEntityTypeName",value:function t(){var e=this.getController();return e?e.getEntityTypeName():""}},{key:"getDuplicateData",value:function t(){var e=this.getController();return e?e.getDuplicateData():{}}},{key:"getGroup",value:function t(i){var a=e.Type.isStringFilled(i)?this.getController():null;return a?a.getGroup(i):null}},{key:"getGroupSummaryTitle",value:function t(i,a){if(e.Type.isPlainObject(a)&&a.hasOwnProperty("totalText")&&e.Type.isStringFilled(a["totalText"])){var r=this.getGroup(i);var n=r?r.getSummaryTitle():"";if(e.Type.isStringFilled(n)){return a["totalText"]+" "+n}}return""}},{key:"getLayoutData",value:function t(){var i={title:"",groups:[]};var a=this.getDuplicateData();var r=0;for(var n in a){if(!a.hasOwnProperty(n)){continue}var l=e.Type.isPlainObject(a[n])?a[n]:{};var s=e.Type.isArray(l["items"])?l["items"]:[];var o={title:this.getGroupSummaryTitle(n,l),items:[]};var p=[];for(var u=0;u<s.length;u++){var d=s[u];var c=e.Type.isArray(d["ENTITIES"])?d["ENTITIES"]:[];for(var h=0;h<c.length;h++){var v=c[h];var g=this.getEntityTypeId(v);if(!BX.CrmEntityType.isDefined(g)){continue}var b=BX.CrmEntityType.resolveName(g);var y=this.getEntityId(v);var m=false;if(!p.hasOwnProperty(b)){p[b]=[y];m=true}else{var f=p[b].indexOf(y)>=0;if(!f){p[b].push(y);m=true}}if(m){o.items.push(this.prepareItemInfo(v))}}}if(o.items.length>0){r+=o.items.length;i.groups.push(o)}}i.title=e.Loc.getMessage("DUPLICATE_SUMMARY_LIST_TOTAL_COUNT_TITLE",{"#COUNT#":r});return i}},{key:"getEntityTypeId",value:function t(i){return e.Type.isStringFilled(i["ENTITY_TYPE_ID"])?parseInt(i["ENTITY_TYPE_ID"]):0}},{key:"getEntityId",value:function t(i){return e.Type.isStringFilled(i["ENTITY_ID"])?parseInt(i["ENTITY_ID"]):0}},{key:"prepareItemInfo",value:function t(e){var i=new H;var a=this.getEntityTypeId(e);i.entityTypeName=BX.CrmEntityType.resolveName(a);i.entityId=this.getEntityId(e);i.entityTypeTitle=BX.prop.getString(e,"CATEGORY_NAME",BX.CrmEntityType.getCaption(a));i.entityTitle=BX.prop.getString(e,"TITLE","");i.isMy=a===BX.CrmEntityType.enumeration.company&&BX.prop.getString(e,"IS_MY_COMPANY","")==="Y";i.entityUrl=BX.prop.getString(e,"URL","");i.responsible={id:BX.prop.getInteger(e,"RESPONSIBLE_ID",0),fullName:BX.prop.getString(e,"RESPONSIBLE_FULL_NAME",""),profileUrl:BX.prop.getString(e,"RESPONSIBLE_URL","#"),photoUrl:BX.prop.getString(e,"RESPONSIBLE_PHOTO_URL","#")};var r=BX.prop.getObject(e,"MATCH_INDEX",{PHONE:[],EMAIL:[]});i.addPhones(BX.prop.getArray(e,"PHONE",[]),r);i.addEmails(BX.prop.getArray(e,"EMAIL",[]),r);return i.toPlainObject()}},{key:"renderItemDetails",value:function t(i){var a="";var r=i["communications"];var n=BX.prop.getObject(i,"matchIndex",{phone:[],email:[]});["phone","email"].forEach((function(t){var i=5;var l=false;if(!l&&r[t].length>i){l=true}if(r[t].length>0){for(var s=0;s<r[t].length;s++){if(s>=i){break}if(a.length>0){a+=", "}var o=n[t].includes(s);var p=e.Text.encode(r[t][s]);a+=o?'<span class="crm-dups-item-details-matched">'+p+"</span>":p}if(l){a+=", ..."}}}));return a}},{key:"getLayout",value:function t(){var i=this;var a=this.getLayoutData();if(!(e.Type.isStringFilled(a["title"])&&e.Type.isArray(a["groups"])&&a["groups"].length>0)){return""}return e.Tag.render(n||(n=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-dups-wrapper">\n\t\t\t\t<div class="crm-dups-header">','</div>\n\t\t\t\t<div class="crm-dups-list">',"</div>\n\t\t\t</div>\n\t\t"])),e.Text.encode(a["title"]),a["groups"].map((function(t){return e.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="crm-dups-group">\n\t\t\t\t\t\t<div class="crm-dups-group-header">','</div>\n\t\t\t\t\t\t<div class="crm-dups-group-items">',"</div>\n\t\t\t\t\t</div>\n\t\t\t\t"])),e.Text.encode(t["title"]),t["items"].map((function(t){return e.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t<div class="crm-dups-item">\n\t\t\t\t\t\t\t\t<div class="crm-dups-item-top">\n\t\t\t\t\t\t\t\t\t<div class="crm-dups-item-header">\n\t\t\t\t\t\t\t\t\t\t<div class="crm-dups-item-type">','</div>\n\t\t\t\t\t\t\t\t\t\t<a\n\t\t\t\t\t\t\t\t\t\t\thref="','"\n\t\t\t\t\t\t\t\t\t\t\tclass="crm-dups-item-title">','</a>\n\t\t\t\t\t\t\t\t\t\t<div class="crm-dups-item-rel-title hidden"></div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div class="crm-dups-item-details">\n\t\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t","\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t"])),e.Text.encode(t["entityTypeTitle"]),e.Text.encode(t["entityUrl"]),e.Text.encode(t["entityTitle"]),h(i,X,L).call(i,t["responsible"]),i.renderItemDetails(t),h(i,N,G).call(i,{type:t["entityTypeName"],id:t["entityId"],title:t["entityTitle"],isMy:t["isMy"]}))})))})))}},{key:"adjustPosition",value:function t(){var i=a.PopupManager.getPopupById(this.popupId);if(!i||!i.isShown()||!e.Type.isDomNode(this.anchor)||!e.Type.isDomNode(this.wrapper)){return}var r=this.wrapper.getBoundingClientRect();var n=this.anchor.getBoundingClientRect();var l=document.documentElement.getBoundingClientRect();var s=-l.top;var o=l.height-l.top;var p=-l.left+r.left+r.width+this.padding;var u=i.getPopupContainer().clientHeight;var d;var c;var h=s+n.top+n.height/2;if(h<s){d=s+n.top-this.padding;c=this.padding+n.height/2}else if(h>o){d=s+n.bottom+this.padding-u;c=u-this.padding-n.height/2}else if(u<l.height){var v=0;d=h-u/2;if(d<s){v=s-d}else if(o<d+u){v=o-d-u}d+=v;c=h-d}else{d=s;c=h-d;if(c<0){c+=u}}c-=this.padding;i.setBindElement({left:p,top:d});i.setAngle({position:"left",offset:c});i.adjustPosition();setTimeout((function(){return i.getZIndexComponent().setZIndex(850)}),0)}},{key:"isShown",value:function t(){var e=a.PopupManager.getPopupById(this.popupId);return e&&e.isShown()}},{key:"close",value:function t(){var i=a.PopupManager.getPopupById(this.popupId);i?i.close():null;e.unbind(document,"resize",babelHelpers.classPrivateFieldGet(this,F));babelHelpers.classPrivateFieldSet(this,F,null)}},{key:"onAddButtonClick",value:function t(e){if(this.clientSearchBox){i.EventEmitter.emit(this.clientSearchBox,"onSelectEntityExternal",e)}this.close()}}],[{key:"create",value:function t(e,i){var a=new r;a.initialize(e,i);return a}}]);return r}(i.EventEmitter);function x(){var t=getComputedStyle(document.body);return(t===null||t===void 0?void 0:t.getPropertyValue("--ui-color-background-primary"))||"#FFFFFF"}function L(t){var i=e.Type.isStringFilled(t["photoUrl"])&&t["photoUrl"]!=="#";var a=i?"":" no-photo";var r=i?" background: url('".concat(e.Text.encode(t["photoUrl"]),"') no-repeat center; background-size: cover;"):"";var n=e.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['<div class="crm-dups-item-photo bx-ui-tooltip-photo">\n\t\t\t<a\n\t\t\t\thref="','"\n\t\t\t\tclass="bx-ui-tooltip-info-data-photo','"\n\t\t\t\tstyle="width: 20px; height: 20px;','"\n\t\t\t\tdata-hint="','"\n\t\t\t\tdata-hint-no-icon\n\t\t\t></a>\n\t\t</div>'])),e.Text.encode(t["profileUrl"]),a,r,e.Text.encode(t["fullName"]));BX.UI.Hint.popupParameters={padding:10};BX.UI.Hint.init(n);return n}function G(t){var i=this;if(!this.enableEntitySelect||t.hasOwnProperty("isMy")&&t["isMy"]||e.Type.isPlainObject(t)&&t.hasOwnProperty("type")&&t["type"]!==this.getTargetEntityTypeName()){return""}var a=new r.Button({round:true,color:r.Button.Color.LIGHT_BORDER,size:r.Button.Size.EXTRA_SMALL,text:e.Loc.getMessage("DUPLICATE_SUMMARY_LIST_ITEM_ADD_BUTTON"),context:{type:t["type"],id:t["id"],title:BX.prop.getString(t,"title","")},onclick:function t(e,a){a.stopPropagation();i.onAddButtonClick(e.getContext())}});return e.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['<div class="crm-dups-item-add-btn">',"</div>"])),a.render())}t.SummaryList=M})(this.BX.Crm.Duplicate=this.BX.Crm.Duplicate||{},BX,BX.Event,BX.Main,BX.UI);
//# sourceMappingURL=summary-list.bundle.map.js