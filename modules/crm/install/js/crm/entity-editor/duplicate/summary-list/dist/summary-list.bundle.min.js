this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};(function(t,e,i,a,n){"use strict";var r,s,l,o;function p(t,e){c(t,e);e.add(t)}function u(t,e,i){c(t,e);e.set(t,i)}function c(t,e){if(e.has(t)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function d(t,e,i){if(!e.has(t)){throw new TypeError("attempted to get private field on non-instance")}return i}var h=new WeakMap;var v=new WeakMap;var y=new WeakMap;var g=new WeakMap;var b=new WeakMap;var m=new WeakMap;var f=new WeakMap;var T=new WeakMap;var P=new WeakSet;var I=new WeakSet;var E=function(){function t(){babelHelpers.classCallCheck(this,t);p(this,I);p(this,P);u(this,h,{writable:true,value:void 0});u(this,v,{writable:true,value:void 0});u(this,y,{writable:true,value:void 0});u(this,g,{writable:true,value:void 0});u(this,b,{writable:true,value:void 0});u(this,m,{writable:true,value:void 0});u(this,f,{writable:true,value:""});u(this,T,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,T,{phone:[],email:[]})}babelHelpers.createClass(t,[{key:"toPlainObject",value:function t(){return{entityTypeName:babelHelpers.classPrivateFieldGet(this,h),entityId:babelHelpers.classPrivateFieldGet(this,v),entityTypeTitle:babelHelpers.classPrivateFieldGet(this,y),entityTitle:babelHelpers.classPrivateFieldGet(this,g),isMy:babelHelpers.classPrivateFieldGet(this,b),entityUrl:babelHelpers.classPrivateFieldGet(this,m),relatedEntityTitle:babelHelpers.classPrivateFieldGet(this,f),communications:babelHelpers.classPrivateFieldGet(this,T)}}},{key:"addPhones",value:function t(e){d(this,I,w).call(this,"phone",e)}},{key:"addEmails",value:function t(e){d(this,I,w).call(this,"email",e)}},{key:"entityTypeName",set:function t(e){babelHelpers.classPrivateFieldSet(this,h,e)},get:function t(){return babelHelpers.classPrivateFieldGet(this,h)}},{key:"entityId",set:function t(e){babelHelpers.classPrivateFieldSet(this,v,e)},get:function t(){return babelHelpers.classPrivateFieldGet(this,v)}},{key:"entityTypeTitle",set:function t(e){babelHelpers.classPrivateFieldSet(this,y,e)},get:function t(){return babelHelpers.classPrivateFieldGet(this,y)}},{key:"entityTitle",set:function t(e){babelHelpers.classPrivateFieldSet(this,g,e)},get:function t(){return babelHelpers.classPrivateFieldGet(this,g)}},{key:"isMy",set:function t(e){babelHelpers.classPrivateFieldSet(this,b,e)},get:function t(){return babelHelpers.classPrivateFieldGet(this,b)}},{key:"entityUrl",set:function t(e){babelHelpers.classPrivateFieldSet(this,m,e)},get:function t(){return babelHelpers.classPrivateFieldGet(this,m)}},{key:"relatedEntityTitle",set:function t(e){babelHelpers.classPrivateFieldSet(this,f,e)},get:function t(){return babelHelpers.classPrivateFieldGet(this,f)}}]);return t}();function S(t,e){if(babelHelpers.classPrivateFieldGet(this,T)[t].indexOf(e)<0){babelHelpers.classPrivateFieldGet(this,T)[t].push(e)}}function w(t,e){for(var i=0;i<e.length;i++){d(this,P,S).call(this,t,e[i])}}var B=new WeakMap;var H=new WeakSet;var k=new WeakSet;var C=function(t){babelHelpers.inherits(n,t);function n(){var t;babelHelpers.classCallCheck(this,n);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this));p(babelHelpers.assertThisInitialized(t),k);p(babelHelpers.assertThisInitialized(t),H);u(babelHelpers.assertThisInitialized(t),B,{writable:true,value:void 0});t.setEventNamespace("crm.entity-editor.summary-list.close");t.id="";t.popupId="";t.settings={};t.anchor=null;t.wrapper=null;t.clientSearchBox=null;t.enableEntitySelect=false;t.items=[];t.padding=0;babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(t),B,null);return t}babelHelpers.createClass(n,[{key:"initialize",value:function t(i,a){this.id=BX.type.isNotEmptyString(i)?i:BX.util.getRandomString(4);this.popupId=this.id+"_popup";if(e.Type.isPlainObject(a)){this.settings=a;this.anchor=BX.prop.getElementNode(a,"anchor",null);this.wrapper=BX.prop.getElementNode(a,"wrapper",null);this.clientSearchBox=BX.prop.get(a,"clientSearchBox",null);this.enableEntitySelect=BX.prop.getBoolean(a,"enableEntitySelect",false)}this.padding=BX.prop.getInteger(a,"padding",14)}},{key:"show",value:function t(){var i=this;var n=a.PopupManager.create({id:this.popupId,cacheable:false,padding:this.padding,contentPadding:0,content:this.getLayout(),closeIcon:{top:"10px",right:"5px"},closeByEsc:false,background:d(this,H,F).call(this),animation:{closeAnimationType:"animation",showClassName:"crm-dups-popup-open",closeClassName:"crm-dups-popup-close"}});if(!babelHelpers.classPrivateFieldGet(this,B)){babelHelpers.classPrivateFieldSet(this,B,this.adjustPosition.bind(this));e.bind(window,"resize",babelHelpers.classPrivateFieldGet(this,B))}n.subscribe("onDestroy",(function(){i.emit("close",i)}));n.subscribe("onFirstShow",(function(t){t.target.getZIndexComponent().subscribe("onZIndexChange",(function(t){if(t.target.getZIndex()!==850){t.target.setZIndex(850)}}))}));n.show();this.adjustPosition()}},{key:"getController",value:function t(){var e=BX.prop.get(this.settings,"controller",null);return e instanceof BX.CrmDupController?e:null}},{key:"getTargetEntityTypeName",value:function t(){var e=this.getController();return e?e.getEntityTypeName():""}},{key:"getDuplicateData",value:function t(){var e=this.getController();return e?e.getDuplicateData():{}}},{key:"getGroup",value:function t(i){var a=e.Type.isStringFilled(i)?this.getController():null;return a?a.getGroup(i):null}},{key:"getGroupSummaryTitle",value:function t(i,a){if(e.Type.isPlainObject(a)&&a.hasOwnProperty("totalText")&&e.Type.isStringFilled(a["totalText"])){var n=this.getGroup(i);var r=n?n.getSummaryTitle():"";if(e.Type.isStringFilled(r)){return a["totalText"]+" "+r}}return""}},{key:"getLayoutData",value:function t(){var i={title:"",groups:[]};var a=this.getDuplicateData();var n=0;for(var r in a){if(!a.hasOwnProperty(r)){continue}var s=e.Type.isPlainObject(a[r])?a[r]:{};var l=e.Type.isArray(s["items"])?s["items"]:[];var o={title:this.getGroupSummaryTitle(r,s),items:[]};var p=[];for(var u=0;u<l.length;u++){var c=l[u];var d=e.Type.isArray(c["ENTITIES"])?c["ENTITIES"]:[];for(var h=0;h<d.length;h++){var v=d[h];var y=this.getEntityTypeId(v);if(!BX.CrmEntityType.isDefined(y)){continue}var g=BX.CrmEntityType.resolveName(y);var b=this.getEntityId(v);var m=false;if(!p.hasOwnProperty(g)){p[g]=[b];m=true}else{var f=p[g].indexOf(b)>=0;if(!f){p[g].push(b);m=true}}if(m){o.items.push(this.prepareItemInfo(v))}}}if(o.items.length>0){n+=o.items.length;i.groups.push(o)}}i.title=e.Loc.getMessage("DUPLICATE_SUMMARY_LIST_TOTAL_COUNT_TITLE",{"#COUNT#":n});return i}},{key:"getEntityTypeId",value:function t(i){return e.Type.isStringFilled(i["ENTITY_TYPE_ID"])?parseInt(i["ENTITY_TYPE_ID"]):0}},{key:"getEntityId",value:function t(i){return e.Type.isStringFilled(i["ENTITY_ID"])?parseInt(i["ENTITY_ID"]):0}},{key:"prepareItemInfo",value:function t(e){var i=new E;var a=this.getEntityTypeId(e);i.entityTypeName=BX.CrmEntityType.resolveName(a);i.entityId=this.getEntityId(e);i.entityTypeTitle=BX.CrmEntityType.getCaption(a);i.entityTitle=BX.prop.getString(e,"TITLE","");i.isMy=a===BX.CrmEntityType.enumeration.company&&BX.prop.getString(e,"IS_MY_COMPANY","")==="Y";i.entityUrl=BX.prop.getString(e,"URL","");i.addPhones(BX.prop.getArray(e,"PHONE",[]));i.addEmails(BX.prop.getArray(e,"EMAIL",[]));return i.toPlainObject()}},{key:"renderItemDetails",value:function t(e){var i="";var a=e["communications"];var n=false;["phone","email"].forEach((function(t){if(!n&&a[t].length>5){n=true}if(a[t].length>0){for(var e=0;e<a[t].length;e++){if(i.length>0){i+=", "}i+=a[t][e]}}}));if(n){i+=", ..."}return i}},{key:"getLayout",value:function t(){var i=this;var a=this.getLayoutData();if(!(e.Type.isStringFilled(a["title"])&&e.Type.isArray(a["groups"])&&a["groups"].length>0)){return""}return e.Tag.render(r||(r=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-dups-wrapper">\n\t\t\t\t<div class="crm-dups-header">','</div>\n\t\t\t\t<div class="crm-dups-list">',"</div>\n\t\t\t</div>\n\t\t"])),e.Text.encode(a["title"]),a["groups"].map((function(t){return e.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="crm-dups-group">\n\t\t\t\t\t\t<div class="crm-dups-group-header">','</div>\n\t\t\t\t\t\t<div class="crm-dups-group-items">',"</div>\n\t\t\t\t\t</div>\n\t\t\t\t"])),e.Text.encode(t["title"]),t["items"].map((function(t){return e.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t<div class="crm-dups-item">\n\t\t\t\t\t\t\t\t<div class="crm-dups-item-top">\n\t\t\t\t\t\t\t\t\t<div class="crm-dups-item-header">\n\t\t\t\t\t\t\t\t\t\t<div class="crm-dups-item-type">','</div>\n\t\t\t\t\t\t\t\t\t\t<a\n\t\t\t\t\t\t\t\t\t\t\thref="','"\n\t\t\t\t\t\t\t\t\t\t\tclass="crm-dups-item-title">','</a>\n\t\t\t\t\t\t\t\t\t\t<div class="crm-dups-item-rel-title hidden"></div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div class="crm-dups-item-details">\n\t\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t"])),e.Text.encode(t["entityTypeTitle"]),e.Text.encode(t["entityUrl"]),e.Text.encode(t["entityTitle"]),d(i,k,M).call(i,{type:t["entityTypeName"],id:t["entityId"],title:t["entityTitle"],isMy:t["isMy"]}),e.Text.encode(i.renderItemDetails(t)))})))})))}},{key:"adjustPosition",value:function t(){var i=a.PopupManager.getPopupById(this.popupId);if(!i||!i.isShown()||!e.Type.isDomNode(this.anchor)||!e.Type.isDomNode(this.wrapper)){return}var n=this.wrapper.getBoundingClientRect();var r=this.anchor.getBoundingClientRect();var s=document.documentElement.getBoundingClientRect();var l=-s.top;var o=s.height-s.top;var p=-s.left+n.left+n.width+this.padding;var u=i.getPopupContainer().clientHeight;var c;var d;var h=l+r.top+r.height/2;if(h<l){c=l+r.top-this.padding;d=this.padding+r.height/2}else if(h>o){c=l+r.bottom+this.padding-u;d=u-this.padding-r.height/2}else if(u<s.height){var v=0;c=h-u/2;if(c<l){v=l-c}else if(o<c+u){v=o-c-u}c+=v;d=h-c}else{c=l;d=h-c;if(d<0){d+=u}}d-=this.padding;i.setBindElement({left:p,top:c});i.setAngle({position:"left",offset:d});i.adjustPosition();setTimeout((function(){return i.getZIndexComponent().setZIndex(850)}),0)}},{key:"isShown",value:function t(){var e=a.PopupManager.getPopupById(this.popupId);return e&&e.isShown()}},{key:"close",value:function t(){var i=a.PopupManager.getPopupById(this.popupId);i?i.close():null;e.unbind(document,"resize",babelHelpers.classPrivateFieldGet(this,B));babelHelpers.classPrivateFieldSet(this,B,null)}},{key:"onAddButtonClick",value:function t(e){if(this.clientSearchBox){i.EventEmitter.emit(this.clientSearchBox,"onSelectEntityExternal",e)}this.close()}}],[{key:"create",value:function t(e,i){var a=new n;a.initialize(e,i);return a}}]);return n}(i.EventEmitter);function F(){var t=getComputedStyle(document.body);return(t===null||t===void 0?void 0:t.getPropertyValue("--ui-color-palette-gray-03"))||"#F5F7F8"}function M(t){var i=this;if(!this.enableEntitySelect||t.hasOwnProperty("isMy")&&t["isMy"]||e.Type.isPlainObject(t)&&t.hasOwnProperty("type")&&t["type"]!==this.getTargetEntityTypeName()){return""}var a=new n.Button({round:true,color:n.Button.Color.LIGHT_BORDER,size:n.Button.Size.EXTRA_SMALL,text:e.Loc.getMessage("DUPLICATE_SUMMARY_LIST_ITEM_ADD_BUTTON"),context:{type:t["type"],id:t["id"],title:BX.prop.getString(t,"title","")},onclick:function t(e,a){a.stopPropagation();i.onAddButtonClick(e.getContext())}});return e.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['<div class="crm-dups-item-add-btn">',"</div>"])),a.render())}t.SummaryList=C})(this.BX.Crm.Duplicate=this.BX.Crm.Duplicate||{},BX,BX.Event,BX.Main,BX.UI);
//# sourceMappingURL=summary-list.bundle.map.js