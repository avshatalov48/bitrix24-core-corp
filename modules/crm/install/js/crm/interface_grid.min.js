if(typeof BX.CrmInterfaceGridManager=="undefined"){BX.CrmInterfaceGridManager=function(){this._id="";this._settings={};this._messages={};this._enableIterativeDeletion=false;this._toolbarMenu=null;this._applyButtonClickHandler=BX.delegate(this._handleFormApplyButtonClick,this);this._setFilterFieldsHandler=BX.delegate(this._onSetFilterFields,this);this._getFilterFieldsHandler=BX.delegate(this._onGetFilterFields,this);this._deletionProcessDialog=null};BX.CrmInterfaceGridManager.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._makeBindings();BX.ready(BX.delegate(this._bindOnGridReload,this));BX.addCustomEvent(window,"CrmInterfaceToolbarMenuShow",BX.delegate(this._onToolbarMenuShow,this));BX.addCustomEvent(window,"CrmInterfaceToolbarMenuClose",BX.delegate(this._onToolbarMenuClose,this));BX.addCustomEvent(window,"BXInterfaceGridCheckColumn",BX.delegate(this._onGridColumnCheck,this));this._messages=this.getSetting("messages",{});this._enableIterativeDeletion=!!this.getSetting("enableIterativeDeletion",false);if(this._enableIterativeDeletion){BX.addCustomEvent(window,"BXInterfaceGridDeleteRow",BX.delegate(this._onGridRowDelete,this))}},_onGridColumnCheck:function(e,t){if(this._toolbarMenu){t["columnMenu"]=this._toolbarMenu.GetMenuByItemId(t["targetElement"].id)}},_onGridRowDelete:function(e,t){var i=BX.type.isNotEmptyString(t["gridId"])?t["gridId"]:"";if(i===""||i!==this.getGridId()){return}t["cancel"]=true;BX.defer(BX.delegate(this.openDeletionDialog,this))({gridId:i,ids:t["selectedIds"],processAll:t["forAll"]})},_onToolbarMenuShow:function(e,t){this._toolbarMenu=t["menu"];t["items"]=this.getGridJsObject().settingsMenu},_onToolbarMenuClose:function(e,t){if(t["menu"]===this._toolbarMenu){this._toolbarMenu=null;this.getGridJsObject().SaveColumns()}},getId:function(){return this._id},reinitialize:function(){this._makeBindings();BX.onCustomEvent(window,"BXInterfaceGridManagerReinitialize",[this])},_makeBindings:function(){var e=this.getForm();if(e){BX.unbind(e["apply"],"click",this._applyButtonClickHandler);BX.bind(e["apply"],"click",this._applyButtonClickHandler)}BX.ready(BX.delegate(this._bindOnSetFilterFields,this))},_bindOnGridReload:function(){BX.addCustomEvent(window,"BXInterfaceGridAfterReload",BX.delegate(this._makeBindings,this))},_bindOnSetFilterFields:function(){var e=this.getGridJsObject();BX.removeCustomEvent(e,"AFTER_SET_FILTER_FIELDS",this._setFilterFieldsHandler);BX.addCustomEvent(e,"AFTER_SET_FILTER_FIELDS",this._setFilterFieldsHandler);BX.removeCustomEvent(e,"AFTER_GET_FILTER_FIELDS",this._getFilterFieldsHandler);BX.addCustomEvent(e,"AFTER_GET_FILTER_FIELDS",this._getFilterFieldsHandler)},registerFilter:function(e){BX.addCustomEvent(e,"AFTER_SET_FILTER_FIELDS",BX.delegate(this._onSetFilterFields,this));BX.addCustomEvent(e,"AFTER_GET_FILTER_FIELDS",BX.delegate(this._onGetFilterFields,this))},_onSetFilterFields:function(e,t,i){var n=this.getSetting("filterFields",null);if(!BX.type.isArray(n)){return}var r=t.name.indexOf("flt_settings")===0;var o=n.length;var a=null;var s="";for(var d=0;d<o;d++){var l=n[d];var c=BX.type.isNotEmptyString(l["id"])?l["id"]:"";var u=BX.type.isNotEmptyString(l["typeName"])?l["typeName"].toUpperCase():"";var g=l["params"]?l["params"]:{};if(u==="USER"){var h=g["data"]?g["data"]:{};this._setElementByFilter(h[r?"settingsElementId":"elementId"],h["paramName"],i);var p=g["search"]?g["search"]:{};this._setElementByFilter(p[r?"settingsElementId":"elementId"],p["paramName"],i)}}},_setElementByFilter:function(e,t,i){var n=BX.type.isNotEmptyString(e)?BX(e):null;if(BX.type.isElementNode(n)){n.value=BX.type.isNotEmptyString(t)&&i[t]?i[t]:""}},_onGetFilterFields:function(e,t,i){var n=this.getSetting("filterFields",null);if(!BX.type.isArray(n)){return}var r=t.name.indexOf("flt_settings")===0;var o=n.length;for(var a=0;a<o;a++){var s=n[a];var d=BX.type.isNotEmptyString(s["id"])?s["id"]:"";var l=BX.type.isNotEmptyString(s["typeName"])?s["typeName"].toUpperCase():"";var c=s["params"]?s["params"]:{};if(l==="USER"){var u=c["data"]?c["data"]:{};this._setFilterByElement(u[r?"settingsElementId":"elementId"],u["paramName"],i);var g=c["search"]?c["search"]:{};this._setFilterByElement(g[r?"settingsElementId":"elementId"],g["paramName"],i)}}},_setFilterByElement:function(e,t,i){var n=BX.type.isNotEmptyString(e)?BX(e):null;if(BX.type.isElementNode(n)&&BX.type.isNotEmptyString(t)){i[t]=n.value}},getSetting:function(e,t){return typeof this._settings[e]!="undefined"?this._settings[e]:t},getMessage:function(e){return this._messages.hasOwnProperty(e)?this._messages[e]:e},getOwnerType:function(){return this.getSetting("ownerType","")},getForm:function(){return document.forms[this.getSetting("formName","")]},getGridId:function(){return this.getSetting("gridId","")},getGrid:function(){return BX(this.getSetting("gridId",""))},getGridJsObject:function(){var e=this.getSetting("gridId","");return BX.type.isNotEmptyString(e)?window["bxGrid_"+e]:null},getAllRowsCheckBox:function(){return BX(this.getSetting("allRowsCheckBoxId",""))},getEditor:function(){var e=this.getSetting("activityEditorId","");return BX.CrmActivityEditor.items[e]?BX.CrmActivityEditor.items[e]:null},reload:function(){var e=this.getSetting("gridId");if(!BX.type.isNotEmptyString(e)){return false}var t=window["bxGrid_"+e];if(!t||!BX.type.isFunction(t.Reload)){return false}t.Reload();return true},getServiceUrl:function(){return this.getSetting("serviceUrl","/bitrix/components/bitrix/crm.activity.editor/ajax.php")},getListServiceUrl:function(){return this.getSetting("listServiceUrl","")},_loadCommunications:function(e,t,i){BX.ajax({url:this.getServiceUrl(),method:"POST",dataType:"json",data:{ACTION:"GET_ENTITIES_DEFAULT_COMMUNICATIONS",COMMUNICATION_TYPE:e,ENTITY_TYPE:this.getOwnerType(),ENTITY_IDS:t,GRID_ID:this.getSetting("gridId","")},onsuccess:function(e){if(e&&e["DATA"]&&i){i(e["DATA"])}},onfailure:function(e){}})},_onEmailDataLoaded:function(e){var t={};if(e){var i=BX.type.isArray(e["ITEMS"])?e["ITEMS"]:[];if(i.length>0){var n=e["ENTITY_TYPE"]?e["ENTITY_TYPE"]:"";var r=t["communications"]=[];for(var o=0;o<i.length;o++){var a=i[o];r.push({type:"EMAIL",entityTitle:"",entityType:n,entityId:a["entityId"],value:a["value"]})}}}this.addEmail(t)},_onCallDataLoaded:function(e){var t={};if(e){var i=BX.type.isArray(e["ITEMS"])?e["ITEMS"]:[];if(i.length>0){var n=e["ENTITY_TYPE"]?e["ENTITY_TYPE"]:"";var r=t["communications"]=[];var o=i[0];r.push({type:"PHONE",entityTitle:"",entityType:n,entityId:o["entityId"],value:o["value"]});t["ownerType"]=n;t["ownerID"]=o["entityId"]}}this.addCall(t)},_onMeetingDataLoaded:function(e){var t={};if(e){var i=BX.type.isArray(e["ITEMS"])?e["ITEMS"]:[];if(i.length>0){var n=e["ENTITY_TYPE"]?e["ENTITY_TYPE"]:"";var r=t["communications"]=[];var o=i[0];r.push({type:"",entityTitle:"",entityType:n,entityId:o["entityId"],value:o["value"]});t["ownerType"]=n;t["ownerID"]=o["entityId"]}}this.addMeeting(t)},_onDeletionProcessStateChange:function(e){if(e!==this._deletionProcessDialog||e.getState()!==BX.CrmLongRunningProcessState.completed){return}this._deletionProcessDialog.close();this.reload()},_handleFormApplyButtonClick:function(e){var t=this.getForm();if(!t){return true}var i=t.elements["action_button_"+this.getSetting("gridId","")];if(!i){return}var n=i.value;if(n==="subscribe"){var r=this.getAllRowsCheckBox();var o=[];if(!(r&&r.checked)){var a=BX.findChildren(this.getGrid(),{tagName:"INPUT",attribute:{type:"checkbox"}},true);if(a){for(var s=0;s<a.length;s++){var d=a[s];if(d.id.indexOf("ID")==0&&d.checked){o.push(d.value)}}}}if(n==="subscribe"){this._loadCommunications("EMAIL",o,BX.delegate(this._onEmailDataLoaded,this));return BX.PreventDefault(e)}}return true},openDeletionDialog:function(e){var t=BX.util.getRandomString(12);var i={CONTEXT_ID:t,GRID_ID:e["gridId"],ENTITY_TYPE_NAME:this.getOwnerType(),USER_FILTER_HASH:this.getSetting("userFilterHash","")};var n=e["processAll"];var r=e["ids"];if(n){i["PROCESS_ALL"]="Y"}else{i["ENTITY_IDS"]=r}i.sessid=BX.bitrix_sessid();this._deletionProcessDialog=BX.CrmLongRunningProcessDialog.create(t,{serviceUrl:this.getListServiceUrl(),action:"DELETE",params:i,title:this.getMessage("deletionDialogTitle"),summary:this.getMessage("deletionDialogSummary")});BX.addCustomEvent(this._deletionProcessDialog,"ON_STATE_CHANGE",BX.delegate(this._onDeletionProcessStateChange,this));this._deletionProcessDialog.show();this._deletionProcessDialog.start()},addEmail:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}t.addEmail(e)},addCall:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}BX.namespace("BX.Crm.Activity");if(typeof BX.Crm.Activity.Planner!=="undefined"){(new BX.Crm.Activity.Planner).showEdit({TYPE_ID:BX.CrmActivityType.call,OWNER_TYPE:e["ownerType"],OWNER_ID:e["ownerID"]});return}t.addCall(e)},addMeeting:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}BX.namespace("BX.Crm.Activity");if(typeof BX.Crm.Activity.Planner!=="undefined"){(new BX.Crm.Activity.Planner).showEdit({TYPE_ID:BX.CrmActivityType.meeting,OWNER_TYPE:e["ownerType"],OWNER_ID:e["ownerID"]});return}t.addMeeting(e)},addTask:function(e){var t=this.getEditor();if(!t){return}e=e?e:{};if(typeof e["ownerID"]!=="undefined"){e["ownerType"]=this.getOwnerType()}t.addTask(e)},viewActivity:function(e,t){var i=this.getEditor();if(i){i.viewActivity(e,t)}}};BX.CrmInterfaceGridManager.items={};BX.CrmInterfaceGridManager.create=function(e,t){var i=new BX.CrmInterfaceGridManager;i.initialize(e,t);this.items[e]=i;BX.onCustomEvent(this,"CREATED",[i]);return i};BX.CrmInterfaceGridManager.addEmail=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addEmail(t)}};BX.CrmInterfaceGridManager.addCall=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addCall(t)}};BX.CrmInterfaceGridManager.addMeeting=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addMeeting(t)}};BX.CrmInterfaceGridManager.addTask=function(e,t){if(typeof this.items[e]!=="undefined"){this.items[e].addTask(t)}};BX.CrmInterfaceGridManager.viewActivity=function(e,t,i){if(typeof this.items[e]!=="undefined"){this.items[e].viewActivity(t,i)}};BX.CrmInterfaceGridManager.showPopup=function(e,t,i){BX.PopupMenu.show(e,t,i,{offsetTop:0,offsetLeft:-30})};BX.CrmInterfaceGridManager.reloadGrid=function(e){var t=window["bxGrid_"+e];if(!t||!BX.type.isFunction(t.Reload)){return false}t.Reload();return true};BX.CrmInterfaceGridManager.applyFilter=function(e,t){var i=window["bxGrid_"+e];if(!i||!BX.type.isFunction(i.Reload)){return false}i.ApplyFilter(t);return true};BX.CrmInterfaceGridManager.clearFilter=function(e){var t=window["bxGrid_"+e];if(!t||!BX.type.isFunction(t.ClearFilter)){return false}t.ClearFilter();return true};BX.CrmInterfaceGridManager.menus={};BX.CrmInterfaceGridManager.createMenu=function(e,t,i){i=parseInt(i);var n=new PopupMenu(e,!isNaN(i)?i:1010);if(BX.type.isArray(t)){n.settingsMenu=t}this.menus[e]=n};BX.CrmInterfaceGridManager.showMenu=function(e,t){var i=this.menus[e];if(typeof i!=="undefined"){i.ShowMenu(t,i.settingsMenu,false,false)}};BX.CrmInterfaceGridManager.expandEllipsis=function(e){if(!BX.type.isDomNode(e)){return false}var t=BX.findNextSibling(e,{class:"bx-crm-text-cut-on"});if(t){BX.removeClass(t,"bx-crm-text-cut-on");BX.addClass(t,"bx-crm-text-cut-off");t.style.display=""}e.style.display="none";return true}}BX.CrmUIGridMenuCommand={undefined:"",createEvent:"CREATE_EVENT",createActivity:"CREATE_ACTIVITY",remove:"REMOVE",exclude:"EXCLUDE"};if(typeof BX.CrmUIGridExtension==="undefined"){BX.CrmUIGridExtension=function(){this._id="";this._settings={};this._rowCountLoader=null;this._loaderData=null;this._moveToCaregoryPopup=null;this._reloadHandle=0;this._processDialog=null;this.typeListFields=[]};BX.CrmUIGridExtension.prototype={initialize:function(e,t){this._id=e;this._settings=t?t:{};this._gridReloadHandler=BX.delegate(this.onGridReload,this);this._gridBeforeRequestHandler=BX.delegate(this.onGridDataRequest,this);this._entityConvertHandler=BX.delegate(this.onEntityConvert,this);this._singleEntityConvertHandler=BX.delegate(this.onSingleEntityConvert,this);this._externalEventHandler=BX.delegate(this.onExternalEvent,this);this.initializeRowCountLoader();BX.addCustomEvent(window,"Grid::updated",this._gridReloadHandler);this._loaderData=this.getSetting("loaderData",null);if(BX.type.isPlainObject(this._loaderData)){BX.addCustomEvent(window,"Grid::beforeRequest",this._gridBeforeRequestHandler)}BX.addCustomEvent(window,"Crm.EntityConverter.Converted",this._entityConvertHandler);BX.addCustomEvent(window,"Crm.EntityConverter.SingleConverted",this._singleEntityConvertHandler);BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)},destroy:function(){BX.removeCustomEvent(window,"Grid::updated",this._gridReloadHandler);BX.removeCustomEvent(window,"Grid::beforeRequest",this._gridBeforeRequestHandler);BX.removeCustomEvent(window,"Crm.EntityConverter.Converted",this._entityConvertHandler);BX.removeCustomEvent(window,"Crm.EntityConverter.SingleConverted",this._singleEntityConvertHandler);BX.removeCustomEvent(window,"onLocalStorageSet",this._externalEventHandler);this.releaseRowCountLoader()},getId:function(){return this._id},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},getActivityServiceUrl:function(){return this.getSetting("activityServiceUrl","")},getTaskCreateUrl:function(){return this.getSetting("taskCreateUrl","")},getOwnerTypeName:function(){return this.getSetting("ownerTypeName","")},getGridId:function(){return this.getSetting("gridId","")},getGrid:function(){var e=this.getSetting("gridId","");if(e===""){return null}var t=BX.Main.gridManager.getById(e);return BX.type.isPlainObject(t)&&t["instance"]!=="undefined"?t["instance"]:null},reloadGrid:function(){BX.Main.gridManager.reload(this.getGridId())},getReloadCallback:function(){return BX.delegate(this.reloadGrid,this)},getActivityEditor:function(){var e=this.getSetting("activityEditorId","");return BX.CrmActivityEditor.items[e]?BX.CrmActivityEditor.items[e]:null},getMessage:function(e){var t=BX.CrmUIGridExtension.messages;return t.hasOwnProperty(e)?t[e]:e},getCheckBoxValue:function(e){var t=this.getControl(e);return t&&t.checked},getControl:function(e){return BX(e+"_"+this.getGridId())},getPanelControl:function(e){return BX(e+"_"+this.getGridId()+"_control")},prepareAction:function(e,t){if(e==="assign_to"){BX.CrmUserSearchPopup.deletePopup(this._id);BX.CrmUserSearchPopup.create(this._id,{searchInput:BX(t["searchInputId"]),dataInput:BX(t["dataInputId"]),componentName:t["componentName"]},0)}},onDeletionComplete:function(){BX.UI.Notification.Center.notify({content:this.getMessage("deletionWarning"),actions:[{title:this.getMessage("goToDetails"),events:{click:function(e,t,i){t.close();if(window.top.BX.Helper){window.top.BX.Helper.show("redirect=detail&code=8969825")}}}}],autoHideDelay:5e3})},processMenuCommand:function(e,t){this.getGrid().closeActionsMenu();var i=this.getGridId();var n;if(e===BX.CrmUIGridMenuCommand.createEvent){var r=BX.type.isNotEmptyString(t["entityTypeName"])?t["entityTypeName"]:"";var o=BX.type.isNumber(t["entityId"])?t["entityId"]:0;this.createCustomEvent(r,o)}else if(e===BX.CrmUIGridMenuCommand.createActivity){var a=BX.type.isNumber(t["typeId"])?t["typeId"]:BX.CrmActivityType.undefined;var s=BX.type.isPlainObject(t["settings"])?t["settings"]:{};this.createActivity(a,s)}else if(e===BX.CrmUIGridMenuCommand.remove){n=BX.Crm.ConfirmationDialog.create(this._id+"_REMOVE",{title:this.getMessage("deletionDialogTitle"),content:this.getMessage("deletionDialogMessage")});n.open().then(function(e){if(BX.prop.getBoolean(e,"cancel",true)){return}var n=BX.type.isNotEmptyString(t["pathToRemove"])?t["pathToRemove"]:"";if(n!==""){this.onDeletionComplete();BX.Main.gridManager.reload(i,n)}}.bind(this))}else if(e===BX.CrmUIGridMenuCommand.exclude){n=BX.Crm.ConfirmationDialog.create(this._id+"_EXCLUDE",{title:this.getMessage("exclusionDialogTitle"),content:this.getMessage("exclusionDialogMessage")+" <a href=\"javascript: top.BX.Helper.show('redirect=detail&code=7362845');\">"+this.getMessage("exclusionDialogMessageHelp")+"</a>"});n.open().then((function(e){if(BX.prop.getBoolean(e,"cancel",true)){return}var n=BX.type.isNotEmptyString(t["pathToExclude"])?t["pathToExclude"]:"";if(n!==""){BX.Main.gridManager.reload(i,n)}}))}},processActionChange:function(e){var t=this.getControl("actallrows");if(!t){return}if(e==="delete"){this.applyAction("delete");return}if(e==="assign_to"||e==="set_status"||e==="set_stage"||e==="mark_as_opened"||e==="mark_as_completed"||e==="mark_as_not_completed"||e==="export"||e==="exclude"||e==="convert"||e==="refresh_account"||e==="create_call_list"||e==="sender_letter_add"||e==="sender_segment_add"){t.disabled=false}else{t.checked=false;t.disabled=true}},applyAction:function(e){var t=this.getGrid();if(!t){return}var i=this.getCheckBoxValue("actallrows");var n=t.getRows().getSelectedIds();if(n.length===0&&!i){return}if(e==="edit"){return this.applyEditAction(t)}if(e==="tasks"){return this.openTaskCreateForm(n)}if(e==="merge"){return this.applyMergeAction(n)}if(e==="delete"){return this.applyDeleteAction(n,i)}if(e==="sender_letter_add"){return this.applySenderLetterAddAction(t,n,i)}if(e==="sender_segment_add"){return this.applySenderSegmentAddAction(t,n,i)}if(e==="create_call_list"){return this.createCallList(false)}if(e==="convert"){return this.applyConvertAction(n,i)}if(e==="refresh_account"){return this.applyRefreshAccountAction(t,i)}if(e==="export"&&i){return this.setAllContactsExport()}t.sendSelected()},applyEditAction:function(e){BX.Runtime.loadExtension("crm.entity-list.panel").then((({loadEnumsGridEditData:t})=>t(e,BX.CrmEntityType.resolveId(this.getSetting("ownerTypeName")),this.getSetting("categoryId",null)))).finally((()=>e.editSelected()))},applyMergeAction:function(e){const t=BX.Crm.BatchMergeManager.getItem(this.getGridId());if(t&&!t.isRunning()&&e.length>1){t.setEntityIds(e);t.execute()}},applyDeleteAction:function(e,t){const i=BX.Crm.BatchDeletionManager.getItem(this.getGridId());if(!i&&i.isRunning()){return}if(t){i.resetEntityIds()}else{i.setEntityIds(e)}i.execute();if(this._batchDeletionCompleteHandler){return}this._batchDeletionCompleteHandler=BX.delegate(this.onDeletionComplete,this);BX.addCustomEvent(window,"BX.Crm.BatchDeletionManager:onProcessComplete",this._batchDeletionCompleteHandler)},applySenderLetterAddAction(e,t,i){console.error("applySenderLetterAddAction is deprecated",this)},applySenderSegmentAddAction:function(e,t,i){console.error("applySenderSegmentAddAction is deprecated",this)},applyConvertAction:function(e,t){console.error("applyConvertAction is deprecated",this)},applyRefreshAccountAction:function(e,t){if(t){BX.addCustomEvent(window,"Grid::updated",function(e){if(this.getGrid()===e){window.setTimeout((()=>window.location.reload()),0)}}.bind(this))}e.sendSelected()},processApplyButtonClick:function(){this.applyAction(BX.data(this.getPanelControl("action_button"),"value"))},setAllContactsExport:function(){console.error("setAllContactsExport is deprecated",this)},saveEntitiesToSegment:function(e,t,i,n,r){BX.ajax.runAction("crm.integration.sender.segment.upload",{data:{segmentId:e,entityTypeName:t,entities:i,gridId:n}}).then((function(e){if(e.data.hasOwnProperty("errors")){alert(e.data.errors.join("<br>"));return}if(!r){return}r.apply(this,[e.data])}))},createCallList:function(e){var t=this.getGrid();if(!t){return}BX.Runtime.loadExtension("crm.entity-list.panel").then((({createCallListAndShowAlertOnErrors:i})=>{i(BX.CrmEntityType.resolveId(this.getOwnerTypeName()),t.getRows().getSelectedIds(),e,this.getGridId(),this.getCheckBoxValue("actallrows"))}))},updateCallList:function(e,t){var i=this.getGrid();if(!i){return}var n=this.getCheckBoxValue("actallrows");var r=i.getRows().getSelectedIds();if(r.length===0&&!n){return}BX.CrmCallListHelper.addToCallList({callListId:e,context:t,entityType:this.getOwnerTypeName(),entityIds:n?[]:r,gridId:this.getGridId()})},createCustomEvent:function(e,t){var i=new BX.CDialog({content_url:BX.util.add_url_param("/bitrix/components/bitrix/crm.event.add/box.php",{FORM_TYPE:"LIST",ENTITY_TYPE:e,ENTITY_ID:t}),width:498,height:245,resizable:false});i.Show()},createEmailFor:function(e){if(!e){return}var t=e["ENTITY_TYPE"]?e["ENTITY_TYPE"]:"";var i=BX.type.isArray(e["ITEMS"])?e["ITEMS"]:[];var n={};n["messageType"]="BATCH";n["communications"]=[];for(var r=0;r<i.length;r++){n["communications"].push({type:"EMAIL",entityTitle:"",entityType:t,entityId:i[r]["entityId"],value:i[r]["value"]})}this.createActivity(BX.CrmActivityType.email,n)},createActivity:function(e,t){BX.namespace("BX.Crm.Activity");e=parseInt(e);if(isNaN(e)){e=BX.CrmActivityType.undefined}t=t?t:{};if(BX.type.isNumber(t["ownerID"])){t["ownerType"]=this.getOwnerTypeName()}if(e===BX.CrmActivityType.call||e===BX.CrmActivityType.meeting){if(typeof BX.Crm.Activity.Planner!=="undefined"){var i=new BX.Crm.Activity.Planner;i.showEdit({TYPE_ID:e,OWNER_TYPE:t["ownerType"],OWNER_ID:t["ownerID"]})}}else{var n=this.getActivityEditor();if(n){if(e===BX.CrmActivityType.email){n.addEmail(t)}else if(e===BX.CrmActivityType.task){n.addTask(t)}}}},viewActivity:function(e,t){var i=this.getActivityEditor();if(i){i.viewActivity(e,t)}},openTaskCreateForm:function(e){var t=this.getOwnerTypeName();var i=[];for(var n=0,r=e.length;n<r;n++){i.push(BX.CrmEntityType.prepareEntityKey(t,e[n]))}window.open(this.getTaskCreateUrl().replace("#ENTITY_KEYS#",i.join(";")))},loadCommunications:function(e,t,i){BX.ajax({url:this.getActivityServiceUrl(),method:"POST",dataType:"json",data:{ACTION:"GET_ENTITIES_DEFAULT_COMMUNICATIONS",COMMUNICATION_TYPE:e,ENTITY_TYPE:this.getOwnerTypeName(),ENTITY_IDS:t,GRID_ID:this.getGridId()},onsuccess:function(e){if(e&&e["DATA"]&&i){i(e["DATA"])}},onfailure:function(e){}})},mergeRequestParams:function(e,t){for(var i in t){if(t.hasOwnProperty(i)){e[i]=t[i]}}return e},initializeRowCountLoader:function(){var e=this.getGridId();var t=e.toLowerCase();var i=BX(t+"_row_count");var n=BX(t+"_row_count_wrapper");if(BX.type.isDomNode(i)&&BX.type.isDomNode(n)){this._rowCountLoader=BX.CrmHtmlLoader.create(t+"_row_count",{action:"GET_ROW_COUNT",params:{GRID_ID:e},serviceUrl:this.getSetting("serviceUrl"),button:i,wrapper:n})}},onGridDataRequest:function(e,t){if(t["gridId"]!==this.getGridId()){return}var i=this._loaderData;if(i.url!==""&&t.url===""){t.url=i.url}if(i.method!==""){t.method=i.method}if(BX.type.isPlainObject(i.data)){if(BX.type.isPlainObject(t.data)){t.data=this.mergeRequestParams(t.data,i.data)}else{t.data=i.data}}},onGridReload:function(){this.releaseRowCountLoader();this.initializeRowCountLoader();this.typeListFields=[]},releaseRowCountLoader:function(){if(this._rowCountLoader){this._rowCountLoader.release();this._rowCountLoader=null}},executeGridRequest:function(){var e=this.getGrid();if(e){e.sendSelected()}},openMoveToCategoryDialog:function(){this._moveToCaregoryPopup=new BX.PopupWindow(this.getGridId(),null,{autoHide:false,draggable:true,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{top:"10px",right:"15px"},zIndex:0,titleBar:this.getMessage("moveToCategoryDialogTitle"),content:this.getMessage("moveToCategoryDialogMessage"),className:"crm-text-popup",lightShadow:true,buttons:[new BX.PopupWindowButton({text:BX.message("JS_CORE_WINDOW_CONTINUE"),className:"popup-window-button-accept",events:{click:BX.delegate((function(){this.closeMoveToCaregoryDialog();this.executeGridRequest()}),this)}}),new BX.PopupWindowButtonLink({text:BX.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:BX.delegate((function(){this.closeMoveToCaregoryDialog()}),this)}})]});this._moveToCaregoryPopup.show()},closeMoveToCaregoryDialog:function(){if(this._moveToCaregoryPopup){this._moveToCaregoryPopup.close();this._moveToCaregoryPopup.destroy();this._moveToCaregoryPopup=null}},onEntityConvert:function(e,t){if(this.getOwnerTypeName()===BX.prop.getString(t,"entityTypeName")){BX.Main.gridManager.reload(this.getGridId())}},onSingleEntityConvert:function(e){if(e.getData().entityTypeName===this.getOwnerTypeName()){BX.Main.gridManager.reload(this.getGridId())}},onExternalEvent:function(e){var t=BX.prop.getString(e,"key","");if(t!=="onCrmEntityCreate"&&t!=="onCrmEntityUpdate"&&t!=="onCrmEntityDelete"&&t!=="onCrmEntityConvert"){return}var i=BX.prop.getObject(e,"value",{});if(BX.SidePanel&&BX.SidePanel.Instance){var n=BX.prop.getString(i,"sliderUrl","");if(n!==""&&!BX.SidePanel.Instance.getSlider(n)){return}}if(BX.prop.getString(i,"entityTypeName","")===this.getOwnerTypeName()){if(this._reloadHandle){window.clearTimeout(this._reloadHandle);this._reloadHandle=0}this._reloadHandle=window.setTimeout(BX.delegate(this.reloadGrid,this),1e3)}}};if(typeof BX.CrmUIGridExtension.messages==="undefined"){BX.CrmUIGridExtension.messages={}}BX.CrmUIGridExtension.processActionChange=function(e,t){if(this.items.hasOwnProperty(e)){this.items[e].processActionChange(t)}};BX.CrmUIGridExtension.processApplyButtonClick=function(e){if(this.items.hasOwnProperty(e)){this.items[e].processApplyButtonClick()}};BX.CrmUIGridExtension.prepareAction=function(e,t,i){if(this.items.hasOwnProperty(e)){this.items[e].prepareAction(t,i)}};BX.CrmUIGridExtension.applyAction=function(e,t){if(this.items.hasOwnProperty(e)){this.items[e].applyAction(t)}};BX.CrmUIGridExtension.processMenuCommand=function(e,t,i){if(this.items.hasOwnProperty(e)){this.items[e].processMenuCommand(t,i)}};BX.CrmUIGridExtension.createActivity=function(e,t,i){if(this.items.hasOwnProperty(e)){this.items[e].createActivity(t,i)}};BX.CrmUIGridExtension.viewActivity=function(e,t,i){if(this.items.hasOwnProperty(e)){this.items[e].viewActivity(t,i)}};BX.CrmUIGridExtension.showActivityAddingPopupFromMenu=function(e,t,i,n,r,o){if(!BX.Main||!BX.Main.MenuManager||!BX.Main.MenuManager.Data){return}const a=Object.keys(BX.Main.MenuManager.Data);if(!BX.Type.isArrayFilled(a)){return}const s=BX.Main.MenuManager.Data[a[0]];if(s&&s.bindElement){BX.CrmUIGridExtension.showActivityAddingPopup(s.bindElement,e,t,i,n,r,o);s.close()}};BX.CrmUIGridExtension.showActivityAddingPopup=function(e,t,i,n,r,o,a){BX.Dom.addClass(e,"--active");const s=`${i}_${n}`;BX.Runtime.loadExtension("crm.activity.adding-popup").then((function(d){if(!BX.CrmUIGridExtension.activityAddingPopup.hasOwnProperty(s)){BX.CrmUIGridExtension.activityAddingPopup[s]=new d.AddingPopup(i,n,r,o,{events:{onClose:function(){BX.Dom.removeClass(e,"--active")},onSave:function(){var e=BX.CrmUIGridExtension.getById(t);if(e){e.reloadGrid()}}},context:{analytics:a,source:BX.Crm.Activity.TodoEditorV2.AnalyticsSubSection.list}})}BX.CrmUIGridExtension.activityAddingPopup[s].show()}))};BX.CrmUIGridExtension.createCallList=function(e,t){if(this.items.hasOwnProperty(e)){this.items[e].createCallList(t)}};BX.CrmUIGridExtension.updateCallList=function(e,t,i){if(this.items.hasOwnProperty(e)){this.items[e].updateCallList(t,i)}};BX.CrmUIGridExtension.contextMenus={};BX.CrmUIGridExtension.createContextMenu=function(e,t,i){i=parseInt(i);var n=new PopupMenu(e,!isNaN(i)?i:1010);if(BX.type.isArray(t)){n.settingsMenu=t}this.contextMenus[e]=n};BX.CrmUIGridExtension.showContextMenu=function(e,t){if(this.contextMenus.hasOwnProperty(e)){var i=this.contextMenus[e];i.ShowMenu(t,i.settingsMenu,false,false)}};BX.CrmUIGridExtension.items={};BX.CrmUIGridExtension.activityAddingPopup={};BX.CrmUIGridExtension.create=function(e,t){if(t.hasOwnProperty("destroyPreviousExtension")&&t.destroyPreviousExtension&&this.items.hasOwnProperty(e)&&this.items[e]instanceof BX.CrmUIGridExtension){this.items[e].destroy()}var i=new BX.CrmUIGridExtension;i.initialize(e,t);this.items[e]=i;return i};BX.CrmUIGridExtension.getCountRow=function(e,t){fetch(t,{method:"POST",headers:{"Content-Type":"application/json"}}).then((e=>e.json())).then((t=>{const i=t.DATA.TEXT;const n=document.getElementById(`${e}_row_count_wrapper`);if(n){n.textContent=i}})).catch((e=>{console.error("Error executing request:",e)}))};BX.CrmUIGridExtension.getById=function(e){if(this.items.hasOwnProperty(e)){return this.items[e]}return null}}
//# sourceMappingURL=interface_grid.map.js