if(typeof BX.CrmInterfaceGridManager=="undefined"){BX.CrmInterfaceGridManager=function(){this._id="";this._settings={};this._messages={};this._enableIterativeDeletion=false;this._toolbarMenu=null;this._applyButtonClickHandler=BX.delegate(this._handleFormApplyButtonClick,this);this._setFilterFieldsHandler=BX.delegate(this._onSetFilterFields,this);this._getFilterFieldsHandler=BX.delegate(this._onGetFilterFields,this);this._deletionProcessDialog=null};BX.CrmInterfaceGridManager.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._makeBindings();BX.ready(BX.delegate(this._bindOnGridReload,this));BX.addCustomEvent(window,"CrmInterfaceToolbarMenuShow",BX.delegate(this._onToolbarMenuShow,this));BX.addCustomEvent(window,"CrmInterfaceToolbarMenuClose",BX.delegate(this._onToolbarMenuClose,this));BX.addCustomEvent(window,"BXInterfaceGridCheckColumn",BX.delegate(this._onGridColumnCheck,this));this._messages=this.getSetting("messages",{});this._enableIterativeDeletion=!!this.getSetting("enableIterativeDeletion",false);if(this._enableIterativeDeletion){BX.addCustomEvent(window,"BXInterfaceGridDeleteRow",BX.delegate(this._onGridRowDelete,this))}},_onGridColumnCheck:function(t,e){if(this._toolbarMenu){e["columnMenu"]=this._toolbarMenu.GetMenuByItemId(e["targetElement"].id)}},_onGridRowDelete:function(t,e){var i=BX.type.isNotEmptyString(e["gridId"])?e["gridId"]:"";if(i===""||i!==this.getGridId()){return}e["cancel"]=true;BX.defer(BX.delegate(this.openDeletionDialog,this))({gridId:i,ids:e["selectedIds"],processAll:e["forAll"]})},_onToolbarMenuShow:function(t,e){this._toolbarMenu=e["menu"];e["items"]=this.getGridJsObject().settingsMenu},_onToolbarMenuClose:function(t,e){if(e["menu"]===this._toolbarMenu){this._toolbarMenu=null;this.getGridJsObject().SaveColumns()}},getId:function(){return this._id},reinitialize:function(){this._makeBindings();BX.onCustomEvent(window,"BXInterfaceGridManagerReinitialize",[this])},_makeBindings:function(){var t=this.getForm();if(t){BX.unbind(t["apply"],"click",this._applyButtonClickHandler);BX.bind(t["apply"],"click",this._applyButtonClickHandler)}BX.ready(BX.delegate(this._bindOnSetFilterFields,this))},_bindOnGridReload:function(){BX.addCustomEvent(window,"BXInterfaceGridAfterReload",BX.delegate(this._makeBindings,this))},_bindOnSetFilterFields:function(){var t=this.getGridJsObject();BX.removeCustomEvent(t,"AFTER_SET_FILTER_FIELDS",this._setFilterFieldsHandler);BX.addCustomEvent(t,"AFTER_SET_FILTER_FIELDS",this._setFilterFieldsHandler);BX.removeCustomEvent(t,"AFTER_GET_FILTER_FIELDS",this._getFilterFieldsHandler);BX.addCustomEvent(t,"AFTER_GET_FILTER_FIELDS",this._getFilterFieldsHandler)},registerFilter:function(t){BX.addCustomEvent(t,"AFTER_SET_FILTER_FIELDS",BX.delegate(this._onSetFilterFields,this));BX.addCustomEvent(t,"AFTER_GET_FILTER_FIELDS",BX.delegate(this._onGetFilterFields,this))},_onSetFilterFields:function(t,e,i){var n=this.getSetting("filterFields",null);if(!BX.type.isArray(n)){return}var r=e.name.indexOf("flt_settings")===0;var s=n.length;var o=null;var a="";for(var l=0;l<s;l++){var d=n[l];var c=BX.type.isNotEmptyString(d["id"])?d["id"]:"";var u=BX.type.isNotEmptyString(d["typeName"])?d["typeName"].toUpperCase():"";var h=d["params"]?d["params"]:{};if(u==="USER"){var g=h["data"]?h["data"]:{};this._setElementByFilter(g[r?"settingsElementId":"elementId"],g["paramName"],i);var p=h["search"]?h["search"]:{};this._setElementByFilter(p[r?"settingsElementId":"elementId"],p["paramName"],i)}}},_setElementByFilter:function(t,e,i){var n=BX.type.isNotEmptyString(t)?BX(t):null;if(BX.type.isElementNode(n)){n.value=BX.type.isNotEmptyString(e)&&i[e]?i[e]:""}},_onGetFilterFields:function(t,e,i){var n=this.getSetting("filterFields",null);if(!BX.type.isArray(n)){return}var r=e.name.indexOf("flt_settings")===0;var s=n.length;for(var o=0;o<s;o++){var a=n[o];var l=BX.type.isNotEmptyString(a["id"])?a["id"]:"";var d=BX.type.isNotEmptyString(a["typeName"])?a["typeName"].toUpperCase():"";var c=a["params"]?a["params"]:{};if(d==="USER"){var u=c["data"]?c["data"]:{};this._setFilterByElement(u[r?"settingsElementId":"elementId"],u["paramName"],i);var h=c["search"]?c["search"]:{};this._setFilterByElement(h[r?"settingsElementId":"elementId"],h["paramName"],i)}}},_setFilterByElement:function(t,e,i){var n=BX.type.isNotEmptyString(t)?BX(t):null;if(BX.type.isElementNode(n)&&BX.type.isNotEmptyString(e)){i[e]=n.value}},getSetting:function(t,e){return typeof this._settings[t]!="undefined"?this._settings[t]:e},getMessage:function(t){return this._messages.hasOwnProperty(t)?this._messages[t]:t},getOwnerType:function(){return this.getSetting("ownerType","")},getForm:function(){return document.forms[this.getSetting("formName","")]},getGridId:function(){return this.getSetting("gridId","")},getGrid:function(){return BX(this.getSetting("gridId",""))},getGridJsObject:function(){var t=this.getSetting("gridId","");return BX.type.isNotEmptyString(t)?window["bxGrid_"+t]:null},getAllRowsCheckBox:function(){return BX(this.getSetting("allRowsCheckBoxId",""))},getEditor:function(){var t=this.getSetting("activityEditorId","");return BX.CrmActivityEditor.items[t]?BX.CrmActivityEditor.items[t]:null},reload:function(){var t=this.getSetting("gridId");if(!BX.type.isNotEmptyString(t)){return false}var e=window["bxGrid_"+t];if(!e||!BX.type.isFunction(e.Reload)){return false}e.Reload();return true},getServiceUrl:function(){return this.getSetting("serviceUrl","/bitrix/components/bitrix/crm.activity.editor/ajax.php")},getListServiceUrl:function(){return this.getSetting("listServiceUrl","")},_loadCommunications:function(t,e,i){BX.ajax({url:this.getServiceUrl(),method:"POST",dataType:"json",data:{ACTION:"GET_ENTITIES_DEFAULT_COMMUNICATIONS",COMMUNICATION_TYPE:t,ENTITY_TYPE:this.getOwnerType(),ENTITY_IDS:e,GRID_ID:this.getSetting("gridId","")},onsuccess:function(t){if(t&&t["DATA"]&&i){i(t["DATA"])}},onfailure:function(t){}})},_onEmailDataLoaded:function(t){var e={};if(t){var i=BX.type.isArray(t["ITEMS"])?t["ITEMS"]:[];if(i.length>0){var n=t["ENTITY_TYPE"]?t["ENTITY_TYPE"]:"";var r=e["communications"]=[];for(var s=0;s<i.length;s++){var o=i[s];r.push({type:"EMAIL",entityTitle:"",entityType:n,entityId:o["entityId"],value:o["value"]})}}}this.addEmail(e)},_onCallDataLoaded:function(t){var e={};if(t){var i=BX.type.isArray(t["ITEMS"])?t["ITEMS"]:[];if(i.length>0){var n=t["ENTITY_TYPE"]?t["ENTITY_TYPE"]:"";var r=e["communications"]=[];var s=i[0];r.push({type:"PHONE",entityTitle:"",entityType:n,entityId:s["entityId"],value:s["value"]});e["ownerType"]=n;e["ownerID"]=s["entityId"]}}this.addCall(e)},_onMeetingDataLoaded:function(t){var e={};if(t){var i=BX.type.isArray(t["ITEMS"])?t["ITEMS"]:[];if(i.length>0){var n=t["ENTITY_TYPE"]?t["ENTITY_TYPE"]:"";var r=e["communications"]=[];var s=i[0];r.push({type:"",entityTitle:"",entityType:n,entityId:s["entityId"],value:s["value"]});e["ownerType"]=n;e["ownerID"]=s["entityId"]}}this.addMeeting(e)},_onDeletionProcessStateChange:function(t){if(t!==this._deletionProcessDialog||t.getState()!==BX.CrmLongRunningProcessState.completed){return}this._deletionProcessDialog.close();this.reload()},_handleFormApplyButtonClick:function(t){var e=this.getForm();if(!e){return true}var i=e.elements["action_button_"+this.getSetting("gridId","")];if(!i){return}var n=i.value;if(n==="subscribe"){var r=this.getAllRowsCheckBox();var s=[];if(!(r&&r.checked)){var o=BX.findChildren(this.getGrid(),{tagName:"INPUT",attribute:{type:"checkbox"}},true);if(o){for(var a=0;a<o.length;a++){var l=o[a];if(l.id.indexOf("ID")==0&&l.checked){s.push(l.value)}}}}if(n==="subscribe"){this._loadCommunications("EMAIL",s,BX.delegate(this._onEmailDataLoaded,this));return BX.PreventDefault(t)}}return true},openDeletionDialog:function(t){var e=BX.util.getRandomString(12);var i={CONTEXT_ID:e,GRID_ID:t["gridId"],ENTITY_TYPE_NAME:this.getOwnerType(),USER_FILTER_HASH:this.getSetting("userFilterHash","")};var n=t["processAll"];var r=t["ids"];if(n){i["PROCESS_ALL"]="Y"}else{i["ENTITY_IDS"]=r}this._deletionProcessDialog=BX.CrmLongRunningProcessDialog.create(e,{serviceUrl:this.getListServiceUrl(),action:"DELETE",params:i,title:this.getMessage("deletionDialogTitle"),summary:this.getMessage("deletionDialogSummary")});BX.addCustomEvent(this._deletionProcessDialog,"ON_STATE_CHANGE",BX.delegate(this._onDeletionProcessStateChange,this));this._deletionProcessDialog.show();this._deletionProcessDialog.start()},addEmail:function(t){var e=this.getEditor();if(!e){return}t=t?t:{};if(typeof t["ownerID"]!=="undefined"){t["ownerType"]=this.getOwnerType()}e.addEmail(t)},addCall:function(t){var e=this.getEditor();if(!e){return}t=t?t:{};if(typeof t["ownerID"]!=="undefined"){t["ownerType"]=this.getOwnerType()}BX.namespace("BX.Crm.Activity");if(typeof BX.Crm.Activity.Planner!=="undefined"){(new BX.Crm.Activity.Planner).showEdit({TYPE_ID:BX.CrmActivityType.call,OWNER_TYPE:t["ownerType"],OWNER_ID:t["ownerID"]});return}e.addCall(t)},addMeeting:function(t){var e=this.getEditor();if(!e){return}t=t?t:{};if(typeof t["ownerID"]!=="undefined"){t["ownerType"]=this.getOwnerType()}BX.namespace("BX.Crm.Activity");if(typeof BX.Crm.Activity.Planner!=="undefined"){(new BX.Crm.Activity.Planner).showEdit({TYPE_ID:BX.CrmActivityType.meeting,OWNER_TYPE:t["ownerType"],OWNER_ID:t["ownerID"]});return}e.addMeeting(t)},addTask:function(t){var e=this.getEditor();if(!e){return}t=t?t:{};if(typeof t["ownerID"]!=="undefined"){t["ownerType"]=this.getOwnerType()}e.addTask(t)},viewActivity:function(t,e){var i=this.getEditor();if(i){i.viewActivity(t,e)}}};BX.CrmInterfaceGridManager.items={};BX.CrmInterfaceGridManager.create=function(t,e){var i=new BX.CrmInterfaceGridManager;i.initialize(t,e);this.items[t]=i;BX.onCustomEvent(this,"CREATED",[i]);return i};BX.CrmInterfaceGridManager.addEmail=function(t,e){if(typeof this.items[t]!=="undefined"){this.items[t].addEmail(e)}};BX.CrmInterfaceGridManager.addCall=function(t,e){if(typeof this.items[t]!=="undefined"){this.items[t].addCall(e)}};BX.CrmInterfaceGridManager.addMeeting=function(t,e){if(typeof this.items[t]!=="undefined"){this.items[t].addMeeting(e)}};BX.CrmInterfaceGridManager.addTask=function(t,e){if(typeof this.items[t]!=="undefined"){this.items[t].addTask(e)}};BX.CrmInterfaceGridManager.viewActivity=function(t,e,i){if(typeof this.items[t]!=="undefined"){this.items[t].viewActivity(e,i)}};BX.CrmInterfaceGridManager.showPopup=function(t,e,i){BX.PopupMenu.show(t,e,i,{offsetTop:0,offsetLeft:-30})};BX.CrmInterfaceGridManager.reloadGrid=function(t){var e=window["bxGrid_"+t];if(!e||!BX.type.isFunction(e.Reload)){return false}e.Reload();return true};BX.CrmInterfaceGridManager.applyFilter=function(t,e){var i=window["bxGrid_"+t];if(!i||!BX.type.isFunction(i.Reload)){return false}i.ApplyFilter(e);return true};BX.CrmInterfaceGridManager.clearFilter=function(t){var e=window["bxGrid_"+t];if(!e||!BX.type.isFunction(e.ClearFilter)){return false}e.ClearFilter();return true};BX.CrmInterfaceGridManager.menus={};BX.CrmInterfaceGridManager.createMenu=function(t,e,i){i=parseInt(i);var n=new PopupMenu(t,!isNaN(i)?i:1010);if(BX.type.isArray(e)){n.settingsMenu=e}this.menus[t]=n};BX.CrmInterfaceGridManager.showMenu=function(t,e){var i=this.menus[t];if(typeof i!=="undefined"){i.ShowMenu(e,i.settingsMenu,false,false)}};BX.CrmInterfaceGridManager.expandEllipsis=function(t){if(!BX.type.isDomNode(t)){return false}var e=BX.findNextSibling(t,{class:"bx-crm-text-cut-on"});if(e){BX.removeClass(e,"bx-crm-text-cut-on");BX.addClass(e,"bx-crm-text-cut-off");e.style.display=""}t.style.display="none";return true}}BX.CrmUIGridMenuCommand={undefined:"",createEvent:"CREATE_EVENT",createActivity:"CREATE_ACTIVITY",remove:"REMOVE",exclude:"EXCLUDE"};if(typeof BX.CrmUIFilterEntitySelector==="undefined"){BX.CrmUIFilterEntitySelector=function(){this._id="";this._settings={};this._fieldId="";this._control=null;this._entitySelector=null;this._filterOpenHandler=BX.delegate(this.onCustomEntitySelectorOpen,this);this._filterCloseHandler=BX.delegate(this.onCustomEntitySelectorClose,this)};BX.CrmUIFilterEntitySelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._fieldId=this.getSetting("fieldId","");BX.addCustomEvent(window,"BX.Main.Filter:customEntityFocus",this._filterOpenHandler);BX.addCustomEvent(window,"BX.Main.Filter:customEntityBlur",this._filterCloseHandler)},release:function(){BX.removeCustomEvent(window,"BX.Main.Filter:customEntityFocus",this._filterOpenHandler);BX.removeCustomEvent(window,"BX.Main.Filter:customEntityBlur",this._filterCloseHandler)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getSearchInput:function(){return this._control?this._control.getLabelNode():null},onCustomEntitySelectorOpen:function(t){var e=t.getId();if(this._fieldId!==e){this._control=null;this.close()}else{this._control=t;this.closeSiblings();this.open()}},onCustomEntitySelectorClose:function(t){if(this._fieldId===t.getId()){this._control=null;this.close()}},onSelect:function(t,e){if(!this._control){return}var i=[];var n={};for(var r in e){if(!e.hasOwnProperty(r)){continue}var s=e[r];for(var o=0,a=s.length;o<a;o++){var l=s[o];i.push(l["title"]);if(typeof n[r]==="undefined"){n[r]=[]}n[r].push(l["entityId"])}}this._control.setData(i.join(", "),JSON.stringify(n))},open:function(){if(!this._entitySelector){this._entitySelector=BX.CrmEntitySelector.create(this._id,{entityTypeNames:this.getSetting("entityTypeNames",[]),isMultiple:this.getSetting("isMultiple",false),title:this.getSetting("title","")});BX.addCustomEvent(this._entitySelector,"BX.CrmEntitySelector:select",BX.delegate(this.onSelect,this))}this._entitySelector.open(this.getSearchInput());if(this._control){this._control.setPopupContainer(this._entitySelector.getPopup()["contentContainer"])}},close:function(){if(this._entitySelector){this._entitySelector.close();if(this._control){this._control.setPopupContainer(null)}}},closeSiblings:function(){var t=BX.CrmUIFilterEntitySelector.items;for(var e in t){if(t.hasOwnProperty(e)&&t[e]!==this){t[e].close()}}}};BX.CrmUIFilterEntitySelector.items={};BX.CrmUIFilterEntitySelector.remove=function(t){var e=BX.prop.get(this.items,t,null);if(e){e.release();delete this.items[t]}};BX.CrmUIFilterEntitySelector.create=function(t,e){var i=new BX.CrmUIFilterEntitySelector(t,e);i.initialize(t,e);BX.CrmUIFilterEntitySelector.items[i.getId()]=i;return i}}if(typeof BX.CrmEntitySelector==="undefined"){BX.CrmEntitySelector=function(){this._id="";this._settings={};this._entityTypeNames=[];this._isMultiple=false;this._entityInfos=null;this._entitySelectHandler=BX.delegate(this.onEntitySelect,this)};BX.CrmEntitySelector.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this._entityTypeNames=this.getSetting("entityTypeNames",[]);this._isMultiple=this.getSetting("isMultiple",false);this._entityInfos=[]},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getMessage:function(t){var e=BX.CrmEntitySelector.messages;return e.hasOwnProperty(t)?e[t]:t},isOpened:function(){return obCrm[this._id].popup instanceof BX.PopupWindow&&obCrm[this._id].popup.isShown()},open:function(t){if(typeof obCrm[this._id]==="undefined"){var e=[];for(var i=0,n=this._entityTypeNames.length;i<n;i++){e.push(this._entityTypeNames[i].toLowerCase())}obCrm[this._id]=new CRM(this._id,null,null,this._id,this._entityInfos,false,this._isMultiple,e,{contact:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.contact),company:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.company),invoice:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.invoice),quote:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.quote),lead:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.lead),deal:BX.CrmEntityType.getCaptionByName(BX.CrmEntityType.names.deal),ok:this.getMessage("selectButton"),cancel:BX.message("JS_CORE_WINDOW_CANCEL"),close:BX.message("JS_CORE_WINDOW_CLOSE"),wait:BX.message("JS_CORE_LOADING"),noresult:this.getMessage("noresult"),search:this.getMessage("search"),last:this.getMessage("last")},true);obCrm[this._id].Init();obCrm[this._id].AddOnSaveListener(this._entitySelectHandler)}if(!(obCrm[this._id].popup instanceof BX.PopupWindow&&obCrm[this._id].popup.isShown())){if(!BX.type.isDomNode(t)){t=BX.prop.getElementNode(this._settings,"anchor",null)}obCrm[this._id].Open({closeIcon:{top:"10px",right:"15px"},closeByEsc:true,autoHide:false,gainFocus:false,anchor:t,titleBar:this.getSetting("title","")})}},close:function(){if(typeof obCrm[this._id]!=="undefined"){obCrm[this._id].RemoveOnSaveListener(this._entitySelectHandler);obCrm[this._id].Clear();delete obCrm[this._id]}},getPopup:function(){return typeof obCrm[this._id]!=="undefined"?obCrm[this._id].popup:null},onEntitySelect:function(t){this.close();var e={};this._entityInfos=[];for(var i in t){if(!t.hasOwnProperty(i)){continue}var n=t[i];if(!BX.type.isPlainObject(n)){continue}var r=i.toUpperCase();for(var s in n){if(!n.hasOwnProperty(s)){continue}var o=n[s];this._entityInfos.push({id:o["id"],type:o["type"],title:o["title"],desc:o["desc"],url:o["url"],image:o["image"],selected:"Y"});var a=BX.type.isNotEmptyString(o["id"])?parseInt(o["id"]):0;if(a>0){if(typeof e[r]==="undefined"){e[r]=[]}e[r].push({entityTypeName:r,entityId:a,title:BX.type.isNotEmptyString(o["title"])?o["title"]:"["+a+"]"})}}}BX.onCustomEvent(this,"BX.CrmEntitySelector:select",[this,e])}};if(typeof BX.CrmEntitySelector.messages==="undefined"){BX.CrmEntitySelector.messages={}}BX.CrmEntitySelector.closeAll=function(){for(var t in this.items){if(this.items.hasOwnProperty(t)){this.items[t].close()}}};BX.CrmEntitySelector.items={};BX.CrmEntitySelector.create=function(t,e){var i=new BX.CrmEntitySelector(t,e);i.initialize(t,e);BX.CrmEntitySelector.items[i.getId()]=i;return i}}if(typeof BX.CrmUIGridExtension==="undefined"){BX.CrmUIGridExtension=function(){this._id="";this._settings={};this._rowCountLoader=null;this._loaderData=null;this._moveToCaregoryPopup=null;this._reloadHandle=0;this._processDialog=null};BX.CrmUIGridExtension.prototype={initialize:function(t,e){this._id=t;this._settings=e?e:{};this.initializeRowCountLoader();BX.addCustomEvent(window,"Grid::updated",BX.delegate(this.onGridReload,this));this._loaderData=this.getSetting("loaderData",null);if(BX.type.isPlainObject(this._loaderData)){BX.addCustomEvent(window,"Grid::beforeRequest",BX.delegate(this.onGridDataRequest,this))}BX.addCustomEvent(window,"BX.CrmEntityCounterPanel:applyFilter",BX.delegate(this.onApplyCounterFilter,this));BX.addCustomEvent(window,"Crm.EntityConverter.Converted",BX.delegate(this.onEntityConvert,this));BX.addCustomEvent(window,"onLocalStorageSet",BX.delegate(this.onExternalEvent,this))},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},getActivityServiceUrl:function(){return this.getSetting("activityServiceUrl","")},getTaskCreateUrl:function(){return this.getSetting("taskCreateUrl","")},getOwnerTypeName:function(){return this.getSetting("ownerTypeName","")},getGridId:function(){return this.getSetting("gridId","")},getGrid:function(){var t=this.getSetting("gridId","");if(t===""){return null}var e=BX.Main.gridManager.getById(t);return BX.type.isPlainObject(e)&&e["instance"]!=="undefined"?e["instance"]:null},reloadGrid:function(){BX.Main.gridManager.reload(this.getGridId())},getReloadCallback:function(){return BX.delegate(this.reloadGrid,this)},getActivityEditor:function(){var t=this.getSetting("activityEditorId","");return BX.CrmActivityEditor.items[t]?BX.CrmActivityEditor.items[t]:null},getMessage:function(t){var e=BX.CrmUIGridExtension.messages;return e.hasOwnProperty(t)?e[t]:t},getCheckBoxValue:function(t){var e=this.getControl(t);return e&&e.checked},getControl:function(t){return BX(t+"_"+this.getGridId())},getPanelControl:function(t){return BX(t+"_"+this.getGridId()+"_control")},prepareAction:function(t,e){if(t==="assign_to"){BX.CrmUserSearchPopup.deletePopup(this._id);BX.CrmUserSearchPopup.create(this._id,{searchInput:BX(e["searchInputId"]),dataInput:BX(e["dataInputId"]),componentName:e["componentName"]},0)}},processMenuCommand:function(t,e){this.getGrid().closeActionsMenu();var i=this.getGridId();var n;if(t===BX.CrmUIGridMenuCommand.createEvent){var r=BX.type.isNotEmptyString(e["entityTypeName"])?e["entityTypeName"]:"";var s=BX.type.isNumber(e["entityId"])?e["entityId"]:0;this.createCustomEvent(r,s)}else if(t===BX.CrmUIGridMenuCommand.createActivity){var o=BX.type.isNumber(e["typeId"])?e["typeId"]:BX.CrmActivityType.undefined;var a=BX.type.isPlainObject(e["settings"])?e["settings"]:{};this.createActivity(o,a)}else if(t===BX.CrmUIGridMenuCommand.remove){n=BX.Crm.ConfirmationDialog.create(this._id+"_REMOVE",{title:this.getMessage("deletionDialogTitle"),content:this.getMessage("deletionDialogMessage")});n.open().then(function(t){if(BX.prop.getBoolean(t,"cancel",true)){return}var n=BX.type.isNotEmptyString(e["pathToRemove"])?e["pathToRemove"]:"";if(n!==""){BX.Main.gridManager.reload(i,n)}})}else if(t===BX.CrmUIGridMenuCommand.exclude){n=BX.Crm.ConfirmationDialog.create(this._id+"_EXCLUDE",{title:this.getMessage("exclusionDialogTitle"),content:this.getMessage("exclusionDialogMessage")+" <a href=\"javascript: top.BX.Helper.show('redirect=detail&code=7362845');\">"+this.getMessage("exclusionDialogMessageHelp")+"</a>"});n.open().then(function(t){if(BX.prop.getBoolean(t,"cancel",true)){return}var n=BX.type.isNotEmptyString(e["pathToExclude"])?e["pathToExclude"]:"";if(n!==""){BX.Main.gridManager.reload(i,n)}})}},processActionChange:function(t){var e=this.getControl("actallrows");if(!e){return}if(t==="delete"){this.applyAction("delete");return}if(t==="assign_to"||t==="set_status"||t==="set_stage"||t==="mark_as_opened"||t==="mark_as_completed"||t==="mark_as_not_completed"||t==="export"||t==="exclude"||t==="convert"||t==="refresh_account"||t==="create_call_list"){e.disabled=false}else{e.checked=false;e.disabled=true}},applyAction:function(t){var e=this.getGrid();if(!e){return}var i=this.getCheckBoxValue("actallrows");var n=e.getRows().getSelectedIds();if(n.length===0&&!i){return}if(t==="tasks"){this.openTaskCreateForm(n)}else if(t==="delete"){var r=BX.Crm.BatchDeletionManager.getItem(this.getGridId());if(r&&!r.isRunning()){if(!i){r.setEntityIds(n)}else{r.resetEntityIds()}r.execute()}}else if(t==="sender_letter_add"){var s=e.actionPanel.getValues();var o=(s.SENDER_LETTER_AVAILABLE_CODES||"").split(",");if(!BX.util.in_array(s.SENDER_LETTER_CODE,o)&&BX.getClass("BX.Sender.B24License")){BX.Sender.B24License.showMailingPopup();return}this.saveEntitiesToSegment(null,this.getOwnerTypeName(),n,function(t){BX.SidePanel.Instance.open(s.SENDER_PATH_TO_LETTER_ADD.replace("#code#",s.SENDER_LETTER_CODE).replace("#segment_id#",t.id),{cacheable:false})})}else if(t==="sender_segment_add"){var a=e.actionPanel.getValues();this.saveEntitiesToSegment(a.SENDER_SEGMENT_ID,this.getOwnerTypeName(),n,function(t){if(!BX.UI&&!BX.UI.Notification){return}if(!t.textSuccess){return}BX.UI.Notification.Center.notify({content:t.textSuccess,autoHideDelay:5e3})});e.disableActionsPanel()}else if(t==="create_call_list"){this.createCallList(false)}else if(t==="convert"){var l=BX.Crm.BatchConversionManager.getItem(this.getGridId());if(l){var d=BX.CrmLeadConversionScheme.dealcontactcompany;var c=document.getElementsByName("CONVERSION_SCHEME_ID");if(c.length>0){d=BX.data(c[0],"value")}l.setConfig(BX.CrmLeadConversionScheme.createConfig(d));if(!i){l.setEntityIds(n)}l.execute()}}else if(t==="refresh_account"){if(i){BX.addCustomEvent(window,"Grid::updated",function(t){if(this.getGrid()===t){window.setTimeout(function(){window.location.reload()},0)}}.bind(this))}e.sendSelected()}else if(t==="export"&&i){this.setAllContactsExport()}else{e.sendSelected()}},processApplyButtonClick:function(){this.applyAction(BX.data(this.getPanelControl("action_button"),"value"))},setAllContactsExport:function(){var t=this.getGrid();if(!t){return}var e=t.getId();var i=t.prepareSortUrl({});i=BX.util.add_url_param(i,{grid_id:e,internal:"true",grid_action:"showpage",bxajaxid:t.getAjaxId(),sessid:BX.bitrix_sessid(),AJAX_CALL:"Y"});var n=this.getCheckBoxValue("actallrows");var r=t.getRows().getSelectedIds();var s=[];s["action_button_"+e]="export";s["ACTION_EXPORT"]="Y";s["action_token_"+e]="c"+Date.now();s["action_all_rows_"+e]=n?"Y":"N";var o="processContactsExport"+e+"Dialog";this._processDialog=BX.CrmLongRunningProcessDialog.create(o,{serviceUrl:i,action:"EXPORT",params:{rows:r,controls:s},title:this.getMessage("processExportDialogTitle"),summary:this.getMessage("processExportDialogSummary"),isSummaryHtml:false});BX.addCustomEvent(this._processDialog,"ON_STATE_CHANGE",BX.delegate(this.onStateChangeAllContactsExport,this));this._processDialog.show()},onStateChangeAllContactsExport:function(t){if(t.getState()===BX.CrmLongRunningProcessState.completed){if(this._processDialog){this._processDialog.close();this._processDialog=null}this.reloadGrid()}},saveEntitiesToSegment:function(t,e,i,n){BX.ajax.runAction("crm.integration.sender.segment.upload",{data:{segmentId:t,entityTypeName:e,entities:i}}).then(function(t){if(!n){return}n.apply(this,[t.data])})},createCallList:function(t){var e=this.getGrid();if(!e)return;var i=this.getCheckBoxValue("actallrows");var n=e.getRows().getSelectedIds();BX.CrmCallListHelper.createCallList({entityType:this.getOwnerTypeName(),entityIds:i?[]:n,gridId:this.getGridId(),createActivity:t},function(e){if(!BX.type.isPlainObject(e))return;if(!e.SUCCESS&&e.ERRORS){var i=e.ERRORS.join(". \n");window.alert(i)}else if(e.SUCCESS&&e.DATA){var n=e.DATA;if(n.RESTRICTION){if(B24.licenseInfoPopup){B24.licenseInfoPopup.show("ivr-limit-popup",n.RESTRICTION.HEADER,n.RESTRICTION.CONTENT)}}else{var r=n.ID;if(t&&BXIM){BXIM.startCallList(r,{})}else{(new BX.Crm.Activity.Planner).showEdit({PROVIDER_ID:"CALL_LIST",PROVIDER_TYPE_ID:"CALL_LIST",ASSOCIATED_ENTITY_ID:r})}}}})},updateCallList:function(t,e){var i=this.getGrid();if(!i){return}var n=this.getCheckBoxValue("actallrows");var r=i.getRows().getSelectedIds();if(r.length===0&&!n){return}BX.CrmCallListHelper.addToCallList({callListId:t,context:e,entityType:this.getOwnerTypeName(),entityIds:n?[]:r,gridId:this.getGridId()})},createCustomEvent:function(t,e){var i=new BX.CDialog({content_url:BX.util.add_url_param("/bitrix/components/bitrix/crm.event.add/box.php",{FORM_TYPE:"LIST",ENTITY_TYPE:t,ENTITY_ID:e}),width:498,height:245,resizable:false});i.Show()},createEmailFor:function(t){if(!t){return}var e=t["ENTITY_TYPE"]?t["ENTITY_TYPE"]:"";var i=BX.type.isArray(t["ITEMS"])?t["ITEMS"]:[];var n={};n["messageType"]="BATCH";n["communications"]=[];for(var r=0;r<i.length;r++){n["communications"].push({type:"EMAIL",entityTitle:"",entityType:e,entityId:i[r]["entityId"],value:i[r]["value"]})}this.createActivity(BX.CrmActivityType.email,n)},createActivity:function(t,e){BX.namespace("BX.Crm.Activity");t=parseInt(t);if(isNaN(t)){t=BX.CrmActivityType.undefined}e=e?e:{};if(BX.type.isNumber(e["ownerID"])){e["ownerType"]=this.getOwnerTypeName()}if(t===BX.CrmActivityType.call||t===BX.CrmActivityType.meeting){if(typeof BX.Crm.Activity.Planner!=="undefined"){var i=new BX.Crm.Activity.Planner;i.showEdit({TYPE_ID:t,OWNER_TYPE:e["ownerType"],OWNER_ID:e["ownerID"]})}}else{var n=this.getActivityEditor();if(n){if(t===BX.CrmActivityType.email){n.addEmail(e)}else if(t===BX.CrmActivityType.task){n.addTask(e)}}}},viewActivity:function(t,e){var i=this.getActivityEditor();if(i){i.viewActivity(t,e)}},openTaskCreateForm:function(t){var e=this.getOwnerTypeName();var i=[];for(var n=0,r=t.length;n<r;n++){i.push(BX.CrmEntityType.prepareEntityKey(e,t[n]))}window.open(this.getTaskCreateUrl().replace("#ENTITY_KEYS#",i.join(";")))},loadCommunications:function(t,e,i){BX.ajax({url:this.getActivityServiceUrl(),method:"POST",dataType:"json",data:{ACTION:"GET_ENTITIES_DEFAULT_COMMUNICATIONS",COMMUNICATION_TYPE:t,ENTITY_TYPE:this.getOwnerTypeName(),ENTITY_IDS:e,GRID_ID:this.getGridId()},onsuccess:function(t){if(t&&t["DATA"]&&i){i(t["DATA"])}},onfailure:function(t){}})},mergeRequestParams:function(t,e){for(var i in e){if(e.hasOwnProperty(i)){t[i]=e[i]}}return t},initializeRowCountLoader:function(){var t=this.getGridId();var e=t.toLowerCase();var i=BX(e+"_row_count");var n=BX(e+"_row_count_wrapper");if(BX.type.isDomNode(i)&&BX.type.isDomNode(n)){this._rowCountLoader=BX.CrmHtmlLoader.create(e+"_row_count",{action:"GET_ROW_COUNT",params:{GRID_ID:t},serviceUrl:this.getSetting("serviceUrl"),button:i,wrapper:n})}},onGridDataRequest:function(t,e){if(e["gridId"]!==this.getGridId()){return}var i=this._loaderData;if(i.url!==""&&e.url===""){e.url=i.url}if(i.method!==""){e.method=i.method}if(BX.type.isPlainObject(i.data)){if(BX.type.isPlainObject(e.data)){e.data=this.mergeRequestParams(e.data,i.data)}else{e.data=i.data}}},onGridReload:function(){if(this._rowCountLoader){this._rowCountLoader.release();this._rowCountLoader=null}this.initializeRowCountLoader()},onApplyCounterFilter:function(t,e){setTimeout(BX.delegate(function(){this.setFilter({ASSIGNED_BY_ID:{0:e["userId"]},ASSIGNED_BY_ID_label:[e["userName"]],ACTIVITY_COUNTER:{0:e["counterTypeId"]}})},this),0);e["cancel"]=true},setFilter:function(t){var e=BX.Main.filterManager.getById(this.getGridId());var i=e.getApi();i.setFields(t);i.apply()},executeGridRequest:function(){var t=this.getGrid();if(t){t.sendSelected()}},openMoveToCategoryDialog:function(){this._moveToCaregoryPopup=new BX.PopupWindow(this.getGridId(),null,{autoHide:false,draggable:true,bindOptions:{forceBindPosition:false},closeByEsc:true,closeIcon:{top:"10px",right:"15px"},zIndex:0,titleBar:this.getMessage("moveToCategoryDialogTitle"),content:this.getMessage("moveToCategoryDialogMessage"),className:"crm-text-popup",lightShadow:true,buttons:[new BX.PopupWindowButton({text:BX.message("JS_CORE_WINDOW_CONTINUE"),className:"popup-window-button-accept",events:{click:BX.delegate(function(){this.closeMoveToCaregoryDialog();this.executeGridRequest()},this)}}),new BX.PopupWindowButtonLink({text:BX.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:BX.delegate(function(){this.closeMoveToCaregoryDialog()},this)}})]});this._moveToCaregoryPopup.show()},closeMoveToCaregoryDialog:function(){if(this._moveToCaregoryPopup){this._moveToCaregoryPopup.close();this._moveToCaregoryPopup.destroy();this._moveToCaregoryPopup=null}},onEntityConvert:function(t,e){if(this.getOwnerTypeName()===BX.prop.getString(e,"entityTypeName")){BX.Main.gridManager.reload(this.getGridId())}},onExternalEvent:function(t){var e=BX.prop.getString(t,"key","");if(e!=="onCrmEntityCreate"&&e!=="onCrmEntityUpdate"&&e!=="onCrmEntityDelete"&&e!=="onCrmEntityConvert"){return}var i=BX.prop.getObject(t,"value",{});if(BX.SidePanel&&BX.SidePanel.Instance){var n=BX.prop.getString(i,"sliderUrl","");if(n!==""&&!BX.SidePanel.Instance.getSlider(n)){return}}if(BX.prop.getString(i,"entityTypeName","")===this.getOwnerTypeName()){if(this._reloadHandle){window.clearTimeout(this._reloadHandle);this._reloadHandle=0}this._reloadHandle=window.setTimeout(BX.delegate(this.reloadGrid,this),1e3)}}};if(typeof BX.CrmUIGridExtension.messages==="undefined"){BX.CrmUIGridExtension.messages={}}BX.CrmUIGridExtension.processActionChange=function(t,e){if(this.items.hasOwnProperty(t)){this.items[t].processActionChange(e)}};BX.CrmUIGridExtension.processApplyButtonClick=function(t){if(this.items.hasOwnProperty(t)){this.items[t].processApplyButtonClick()}};BX.CrmUIGridExtension.prepareAction=function(t,e,i){if(this.items.hasOwnProperty(t)){this.items[t].prepareAction(e,i)}};BX.CrmUIGridExtension.applyAction=function(t,e){if(this.items.hasOwnProperty(t)){this.items[t].applyAction(e)}};BX.CrmUIGridExtension.processMenuCommand=function(t,e,i){if(this.items.hasOwnProperty(t)){this.items[t].processMenuCommand(e,i)}};BX.CrmUIGridExtension.createActivity=function(t,e,i){if(this.items.hasOwnProperty(t)){this.items[t].createActivity(e,i)}};BX.CrmUIGridExtension.viewActivity=function(t,e,i){if(this.items.hasOwnProperty(t)){this.items[t].viewActivity(e,i)}};BX.CrmUIGridExtension.createCallList=function(t,e){if(this.items.hasOwnProperty(t)){this.items[t].createCallList(e)}};BX.CrmUIGridExtension.updateCallList=function(t,e,i){if(this.items.hasOwnProperty(t)){this.items[t].updateCallList(e,i)}};BX.CrmUIGridExtension.contextMenus={};BX.CrmUIGridExtension.createContextMenu=function(t,e,i){i=parseInt(i);var n=new PopupMenu(t,!isNaN(i)?i:1010);if(BX.type.isArray(e)){n.settingsMenu=e}this.contextMenus[t]=n};BX.CrmUIGridExtension.showContextMenu=function(t,e){if(this.contextMenus.hasOwnProperty(t)){var i=this.contextMenus[t];i.ShowMenu(e,i.settingsMenu,false,false)}};BX.CrmUIGridExtension.items={};BX.CrmUIGridExtension.create=function(t,e){var i=new BX.CrmUIGridExtension;i.initialize(t,e);this.items[t]=i;return i}}
//# sourceMappingURL=interface_grid.map.js