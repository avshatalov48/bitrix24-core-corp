{"version":3,"file":"filter-dependent-fields.bundle.js","sources":["../src/activity-fast-search-mutator.js","../src/filter-dependent-fields.js"],"sourcesContent":["import { Runtime, Type, Loc } from 'main.core';\nimport { UI } from 'ui.notification';\nimport type { FilterFieldMutator } from './filter-field-mutator';\n\n/**\n * if the filter contains any activity fast search fields and, if the \"CREATED\" field is not already present,\n * add it to the filter.\n */\nexport class ActivityFastSearchMutator implements FilterFieldMutator\n{\n\t#notifyFn = Runtime.throttle(() => {\n\t\tUI.Notification.Center.notify({\n\t\t\tcontent: Loc.getMessage('CRM_ACTIVITY_FASTSEARCH_CREATED_ADDED'),\n\t\t\tautoHideDelay: 5000,\n\t\t});\n\t}, 4000);\n\n\tmutate(fields: {[k: string]: any}, oldFields: {[k: string]: any}): [{[k: string]: any}, boolean]\n\t{\n\t\tconst isOldFilterHasCreatedField = Boolean(oldFields.ACTIVITY_FASTSEARCH_CREATED);\n\t\tlet isFilterHasActivityFields = false;\n\n\t\tfor (const fieldName of Object.keys(fields))\n\t\t{\n\t\t\tif (!Object.prototype.hasOwnProperty.call(fields, fieldName))\n\t\t\t{\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (this.#checkActivityFields(fields, fieldName))\n\t\t\t{\n\t\t\t\tisFilterHasActivityFields = true;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (\n\t\t\tisFilterHasActivityFields\n\t\t\t&& !fields.ACTIVITY_FASTSEARCH_CREATED\n\t\t)\n\t\t{\n\t\t\tif (isOldFilterHasCreatedField)\n\t\t\t{\n\t\t\t\tthis.#notifyFn();\n\t\t\t}\n\n\t\t\treturn [{\n\t\t\t\t...fields,\n\t\t\t\tACTIVITY_FASTSEARCH_CREATED: '365',\n\t\t\t}, true];\n\t\t}\n\n\t\treturn [fields, false];\n\t}\n\n\t#checkActivityFields(fields: object, fieldName: string): boolean {\n\t\tif (fieldName.indexOf('ACTIVITY_FASTSEARCH_') !== 0)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!fields[fieldName])\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (fields[fieldName] === 'NONE')\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn !(Type.isArray(fields[fieldName]) && fields[fieldName].length === 0);\n\t}\n}\n","import { Type } from 'main.core';\nimport { ActivityFastSearchMutator } from './activity-fast-search-mutator';\nimport type { FilterFieldMutator } from './filter-field-mutator';\n\n/**\n * FilterDependentFields extension provide functionality to manipulate filter fields before then send to the backend.\n * You can create your own mutator and add it to the list. Just implement the FilterFieldMutator interface and\n * add instance to the #mutators array.\n */\nexport class FilterDependentFields\n{\n\t#mutators: FilterFieldMutator[] = [];\n\n\t#oldFields: {[k: string]: any} = '';\n\n\tinitialize(): void\n\t{\n\t\tBX.Event.EventEmitter.subscribe('BX.Main.Filter:beforeApply', this.#onBeforeApply.bind(this));\n\n\t\tthis.#mutators = [\n\t\t\tnew ActivityFastSearchMutator(),\n\t\t];\n\n\t\tconst filterManager = this.getFilterManager();\n\t\tif (filterManager)\n\t\t{\n\t\t\tthis.#oldFields = filterManager.getFilterFieldsValues();\n\t\t}\n\t}\n\n\t#onBeforeApply(event)\n\t{\n\t\tconst filterManager = this.getFilterManager();\n\n\t\tif (!filterManager)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst api = filterManager.getApi();\n\n\t\tlet currentFields = filterManager.getFilterFieldsValues();\n\n\t\tlet isFilterModified = false;\n\n\t\tfor (const mutator of this.#mutators)\n\t\t{\n\t\t\tlet hasChanges = false;\n\t\t\t[currentFields, hasChanges] = mutator.mutate(currentFields, this.#oldFields);\n\n\t\t\tif (hasChanges)\n\t\t\t{\n\t\t\t\tisFilterModified = true;\n\t\t\t}\n\t\t}\n\n\t\tif (!isFilterModified)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tapi.setFields(currentFields);\n\n\t\tthis.#oldFields = currentFields;\n\t}\n\n\tgetFilterManager(): ?BX.Main.Filter\n\t{\n\t\tif (!Type.isObject(BX.Main.filterManager || !Type.isFunction(BX.Main.filterManager)))\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst filters = Object.prototype.hasOwnProperty.call(BX.Main.filterManager, 'getList')\n\t\t\t? BX.Main.filterManager.getList()\n\t\t\t: Object.values(BX.Main.filterManager.data);\n\n\t\treturn (Type.isArray(filters) && filters.length > 0) ? filters[0] : null;\n\t}\n}\n"],"names":["ActivityFastSearchMutator","babelHelpers","_classPrivateFieldInitSpec","writable","value","Runtime","throttle","UI","Notification","Center","notify","content","Loc","getMessage","autoHideDelay","key","fields","oldFields","isOldFilterHasCreatedField","Boolean","ACTIVITY_FASTSEARCH_CREATED","isFilterHasActivityFields","Object","keys","fieldName","prototype","hasOwnProperty","call","this","indexOf","Type","isArray","length","FilterDependentFields","BX","Event","EventEmitter","subscribe","_classPrivateMethodGet","bind","filterManager","getFilterManager","getFilterFieldsValues","isObject","Main","isFunction","filters","getList","values","data","event","_step","api","getApi","currentFields","isFilterModified","mutator","mutate","_iterator","setFields"],"mappings":"02BACqC,gCAOxBA,aAAyB,qBAAAC,6FAAAC,SAAAC,YAAAC,MAEzBC,UAAQC,UAAS,WAC5BC,KAAGC,aAAaC,OAAOC,OAAO,CAC7BC,QAASC,MAAIC,WAAW,yCACxBC,cAAe,QAEd,OAsCF,OAtCOb,6BAAAc,aAAAX,eAEDY,EAA4BC,GAKlC,IAHA,IAAMC,EAA6BC,QAAQF,EAAUG,6BACjDC,GAA4B,QAERC,OAAOC,KAAKP,kBACpC,CADK,IAAMQ,OAEV,GAAKF,OAAOG,UAAUC,eAAeC,KAAKX,EAAQQ,MAK9CI,eAAAA,KAA0BZ,EAAQQ,GACtC,CACCH,GAA4B,EAC5B,OAIF,OACCA,IACIL,EAAOI,6BAGPF,GAEHjB,+CAAA2B,MAGM,QACHZ,OACHI,4BAA6B,SAC3B,IAGG,CAACJ,GAAQ,YAqBjB,WAlBqBA,EAAgBQ,GACpC,OAAkD,IAA9CA,EAAUK,QAAQ,4BAKjBb,EAAOQ,KAKc,SAAtBR,EAAOQ,MAKFM,OAAKC,QAAQf,EAAOQ,KAA4C,IAA7BR,EAAOQ,GAAWQ,orCCtEW,8CAQ9DC,aAAqB,qBAAAhC,2DAAAC,UAAAC,YAAAC,MAEC,KAAEF,UAAAC,YAAAC,MAEH,KAgEhC,OAhEkCH,6BAAAc,iBAAAX,iBAIlC8B,GAAGC,MAAMC,aAAaC,UAAU,yIAA8BC,WAAoBC,KAAKX,OAEvF3B,yCAAiB,CAChB,IAAID,IAGL,IAAMwC,EAAgBZ,KAAKa,mBACvBD,GAEHvC,yCAAkBuC,EAAcE,4BAEjC3B,uBAAAX,iBAuCA,IAAK0B,OAAKa,SAAST,GAAGU,KAAKJ,gBAAkBV,OAAKe,WAAWX,GAAGU,KAAKJ,gBAEpE,OAAO,KAGR,IAAMM,EAAUxB,OAAOG,UAAUC,eAAeC,KAAKO,GAAGU,KAAKJ,cAAe,WACzEN,GAAGU,KAAKJ,cAAcO,UACtBzB,OAAO0B,OAAOd,GAAGU,KAAKJ,cAAcS,MAEvC,OAAQnB,OAAKC,QAAQe,IAAYA,EAAQd,OAAS,EAAKc,EAAQ,GAAK,cAErE,WAhDeI,GAEd,IAAMV,EAAgBZ,KAAKa,mBAE3B,GAAKD,EAAL,CAKA,IAM0BW,EANpBC,EAAMZ,EAAca,SAEtBC,EAAgBd,EAAcE,wBAE9Ba,GAAmB,wCAED3B,SAAI,IAA1B,2BACA,CAAA,IADW4B,YAGoBA,EAAQC,OAAOH,oCAAe1B,2CAA3D0B,cAIAC,GAAmB,aAEpBG,eAAAA,MAEIH,IAILH,EAAIO,UAAUL,GAEdrD,yCAAkBqD"}