this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};this.BX.Crm.Report=this.BX.Crm.Report||{};this.BX.Crm.Report.Tracking=this.BX.Crm.Report.Tracking||{};(function(t,e,r,i,a,n){"use strict";function o(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-report-tracking-panel">\n\t\t\t\t<div class="crm-report-tracking-panel-title">\n\t\t\t\t\t<div class="crm-report-tracking-panel-title-name">\n\t\t\t\t\t\t<div class="crm-report-tracking-panel-title-line">\n\t\t\t\t\t\t\t<div data-role="title"></div>\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div data-role="selector"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="crm-report-tracking-panel-body">\n\t\t\t\t\t<div data-role="loader" class="crm-report-tracking-panel-loader">\n\t\t\t\t\t\t<div data-role="loader/text" class="crm-report-tracking-panel-loader-text"></div>\n\t\t\t\t\t\t<div data-role="loader/bar" class="crm-report-tracking-panel-loader-bar"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div data-role="grid"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t']);o=function e(){return t};return t}var l=function(){function t(e){babelHelpers.classCallCheck(this,t);babelHelpers.defineProperty(this,"ui",{container:null,loader:null,loaderText:null,loaderProgressBar:null,loaderActive:false,grid:null});this.load(e)}babelHelpers.createClass(t,[{key:"load",value:function t(e){var r=this;var i=e.sourceId,a=e.from,n=e.to,o=e.parentId,l=o===void 0?0:o,d=e.level,s=d===void 0?0:d,c=e.gridId;this.gridId=c=c||"crm-report-tracking-ad-l".concat(s);this.filter={sourceId:i,from:a,to:n,parentId:l,level:s,gridId:c};BX.SidePanel.Instance.open("crm:api.tracking.ad.report"+"-".concat(i,"-").concat(s),{cacheable:false,contentCallback:function t(){var e=r.createUiContainer(s);r.build();return e}})}},{key:"build",value:function t(){var e=this;this.showLoader();if(this.filter.level){this.loadGrid();return}BX.ajax.runAction("crm.api.tracking.ad.report.build",{json:babelHelpers.objectSpread({},this.filter)}).then(function(t){var r=t.data;if(r.label){e.setLoaderText(r.label)}if(r.complete){e.loadGrid()}else{e.build()}})}},{key:"loadGrid",value:function t(){var e=this;BX.ajax.runAction("crm.api.tracking.ad.report.getGrid",{data:babelHelpers.objectSpread({},this.filter)}).then(function(t){var r=t.data;a.EventEmitter.subscribe(window,"Grid::beforeRequest",e.onBeforeGridRequest.bind(e));i.Runtime.html(e.getNode("grid"),r.html);e.initActivators();e.hideLoader();if(!e.filter.level){var o={content:i.Loc.getMessage("CRM_REPORT_TRACKING_AD_REPORT_SETTINGS_HINT"),zIndex:5e3,maxWidth:300,offsetLeft:-315,offsetTop:-30,animation:"fading",darkMode:true,bindElement:e.ui.hint};var l=new n.Popup(o);l.show();setTimeout(function(){return l.destroy()},7e3)}})}},{key:"initActivators",value:function e(){var r=this;this.getNodes("grid/activator").forEach(function(e){var a=JSON.parse(e.dataset.options);i.Event.bind(e,"click",function(){new t(babelHelpers.objectSpread({},r.filter,{level:a.level,parentId:a.parentId,gridId:r.filter.gridId+"-lvl"+a.level}))})});var a=this.getNode("grid/selector/title");var o=this.getNode("grid/selector");if(o){var l=this.getNode("selector");if(l.children.length>0){o.parentElement.removeChild(o);a.parentElement.removeChild(a);return}o.dataset.role="";a.dataset.role="";l.appendChild(a);l.appendChild(o);i.Event.bind(o,"click",function(){var t=JSON.parse(o.dataset.options);var e=new n.Menu({bindElement:o,zIndex:3010,items:t.items.map(function(t){return{text:i.Text.encode(t.title),onclick:function i(){e.close();o.textContent=t.title;r.filter.parentId=t.parentId;r.filter.level=t.level;r.filter.sourceId=t.sourceId;r.build()}}})});e.show()})}}},{key:"createUiContainer",value:function t(e){var r=i.Tag.render(o(),e?"":'<div data-role="hint" class="ui-hint-icon crm-report-tracking-panel-hint"></div>');this.ui.container=r;this.ui.title=this.getNode("title");this.ui.hint=this.getNode("hint");this.ui.loader=this.getNode("loader");this.ui.loaderText=this.getNode("loader/text");this.ui.grid=this.getNode("grid");var a=new BX.UI.ProgressBar({value:0,maxValue:100,statusType:"none",column:true});if(this.ui.hint){this.ui.hint.addEventListener("click",function(){return BX.Helper.show("redirect=detail&code=12526974")})}this.getNode("loader/bar").appendChild(a.getContainer());this.ui.loaderProgressBar=a;this.setLoaderText(i.Loc.getMessage("CRM_REPORT_TRACKING_AD_REPORT_BUILD"));this.setTitle(i.Loc.getMessage("CRM_REPORT_TRACKING_AD_REPORT_TITLE_"+this.filter.level));return r}},{key:"setLoaderText",value:function t(e){this.ui.loaderProgressBar.setValue(0);this.ui.loaderProgressBar.setTextBefore(e)}},{key:"animateLoader",value:function t(){var e=this;if(!this.ui.loaderActive){return}var r=this.ui.loaderProgressBar;var i=parseInt(r.getValue())+1;if(i<=95){r.update(i)}setTimeout(function(){return e.animateLoader()},100)}},{key:"showLoader",value:function t(){var e=this;if(!this.ui.loaderActive){setTimeout(function(){return e.animateLoader()},100)}this.ui.loaderActive=true;this.ui.loader.style.display=""}},{key:"hideLoader",value:function t(){var e=this.ui.loaderProgressBar;if(e){e.update(0)}this.ui.loaderActive=false;this.ui.loader.style.display="none"}},{key:"setTitle",value:function t(e){return this.ui.title.textContent=e}},{key:"getNode",value:function t(e){return this.ui.container.querySelector('[data-role="'.concat(e,'"]'))}},{key:"getNodes",value:function t(e){return Array.from(this.ui.container.querySelectorAll('[data-role="'.concat(e,'"]')))}},{key:"onBeforeGridRequest",value:function t(e,r){var i=this;r.sessid=BX.bitrix_sessid();r.method="POST";if(!r.url){var a=Object.keys(this.filter).forEach(function(t){return t+"="+i.filter[t]});r.url="/bitrix/services/main/ajax.php?action=crm.api.tracking.ad.grid.report.get&"+a}r.data=babelHelpers.objectSpread({},r.data)}}],[{key:"open",value:function e(r){if(window===top){return Promise.resolve(new t(r))}return top.BX.Runtime.loadExtension("crm.report.tracking.ad.report").then(function(){return new top.BX.Crm.Report.Tracking.Ad.Report(r)})}}]);return t}();t.Report=l})(this.BX.Crm.Report.Tracking.Ad=this.BX.Crm.Report.Tracking.Ad||{},BX,BX,BX,BX.Event,BX.Main);
//# sourceMappingURL=report.bundle.map.js