this.BX=this.BX||{};this.BX.Crm=this.BX.Crm||{};this.BX.Crm.Report=this.BX.Crm.Report||{};this.BX.Crm.Report.Tracking=this.BX.Crm.Report.Tracking||{};(function(t,e,r,i,n,a,o){"use strict";var s;function l(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,i)}return r}function d(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?l(Object(r),!0).forEach((function(e){babelHelpers.defineProperty(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}var c=function(){function t(e){babelHelpers.classCallCheck(this,t);babelHelpers.defineProperty(this,"ui",{container:null,loader:null,loaderText:null,loaderProgressBar:null,loaderActive:false,error:null,errorText:null,errorClose:null,grid:null});babelHelpers.defineProperty(this,"loaded",false);babelHelpers.defineProperty(this,"statusButtonClassName","crm-tracking-report-source-status-disabled");this.load(e)}babelHelpers.createClass(t,[{key:"load",value:function t(e){var r=this;var i=e.sourceId,n=e.from,a=e.to,o=e.parentId,s=o===void 0?0:o,l=e.level,d=l===void 0?0:l,c=e.gridId;this.gridId=c=c||"crm-report-tracking-ad-l".concat(d);this.filter={sourceId:i,from:n,to:a,parentId:s,level:d,gridId:c};BX.SidePanel.Instance.open("crm:api.tracking.ad.report"+"-".concat(i,"-").concat(d),{cacheable:false,contentCallback:function t(){var e=r.createUiContainer(d);r.build();return e}})}},{key:"build",value:function t(){var e=this;this.showLoader();if(this.filter.level){this.loadGrid();return}BX.ajax.runAction("crm.api.tracking.ad.report.build",{json:d({},this.filter)}).then((function(t){var r=t.data;if(r.label){e.setLoaderText(r.label)}if(r.complete){e.loadGrid()}else{e.build()}}))["catch"]((function(t){var r=t.errors;e.showError(r[0])}))}},{key:"changeStatus",value:function t(e,r){var i=this;this.showLoader();BX.ajax.runAction("crm.api.tracking.ad.report.changeStatus",{json:{id:e,status:r}}).then((function(){i.loadGrid()}))["catch"]((function(t){var e=t.errors;i.showError(e[0])}))}},{key:"loadGrid",value:function t(){var e=this;BX.ajax.runAction("crm.api.tracking.ad.report.getGrid",{data:d({},this.filter)}).then((function(t){var r=t.data;a.EventEmitter.subscribe(window,"Grid::beforeRequest",e.onBeforeGridRequest.bind(e));n.Runtime.html(e.getNode("grid"),r.html);e.initActivators();e.hideLoader();e.loaded=true;if(!e.filter.level){var i={content:n.Loc.getMessage("CRM_REPORT_TRACKING_AD_REPORT_SETTINGS_HINT"),zIndex:5e3,maxWidth:300,offsetLeft:-315,offsetTop:-30,animation:"fading",darkMode:true,bindElement:e.ui.hint};var s=new o.Popup(i);s.show();setTimeout((function(){return s.destroy()}),1e4)}}))}},{key:"initActivators",value:function e(){var r=this;this.getNodes("grid/activator").forEach((function(e){var i=JSON.parse(e.dataset.options);var a=e.previousElementSibling;if(a){i.enabled?a.classList.remove(r.statusButtonClassName):a.classList.add(r.statusButtonClassName);n.Event.bind(a,"click",(function(){var t=new o.Menu({bindElement:a,zIndex:3010,items:[{text:n.Text.encode(n.Loc.getMessage("CRM_REPORT_TRACKING_AD_REPORT_STATUS_ENABLED")),onclick:function e(){r.changeStatus(i.parentId,true);t.close()}},{text:n.Text.encode(n.Loc.getMessage("CRM_REPORT_TRACKING_AD_REPORT_STATUS_PAUSE")),onclick:function e(){r.changeStatus(i.parentId,false);t.close()}}]});t.show()}))}if(i.level===null||i.level===undefined){return}n.Event.bind(e,"click",(function(){new t(d(d({},r.filter),{},{level:i.level,parentId:i.parentId,gridId:r.filter.gridId+"-lvl"+i.level}))}))}));var i=this.getNode("grid/selector/title");var a=this.getNode("grid/selector");if(a){var s=this.getNode("selector");if(s.children.length>0){a.parentElement.removeChild(a);i.parentElement.removeChild(i);return}a.dataset.role="";i.dataset.role="";s.appendChild(i);s.appendChild(a);n.Event.bind(a,"click",(function(){var t=JSON.parse(a.dataset.options);var e=new o.Menu({bindElement:a,zIndex:3010,items:t.items.map((function(t){return{text:n.Text.encode(t.title),onclick:function i(){e.close();a.textContent=t.title;r.filter.parentId=t.parentId;r.filter.level=t.level;r.filter.sourceId=t.sourceId;r.build()}}}))});e.show()}))}}},{key:"createUiContainer",value:function t(e){var r=this;var i=n.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="crm-report-tracking-panel">\n\t\t\t\t<div class="crm-report-tracking-panel-title">\n\t\t\t\t\t<div class="crm-report-tracking-panel-title-name">\n\t\t\t\t\t\t<div class="crm-report-tracking-panel-title-line">\n\t\t\t\t\t\t\t<div data-role="title"></div>\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div data-role="selector"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="crm-report-tracking-panel-body">\n\t\t\t\t\t<div data-role="loader" class="crm-report-tracking-panel-loader">\n\t\t\t\t\t\t<div data-role="loader/text" class="crm-report-tracking-panel-loader-text"></div>\n\t\t\t\t\t\t<div data-role="loader/bar" class="crm-report-tracking-panel-loader-bar">\n\t\t\t\t\t\t\t<div data-role="error" class="ui-alert ui-alert-danger" style="display: none;">\n\t\t\t\t\t\t\t\t<span class="ui-alert-message">\n\t\t\t\t\t\t\t\t\t<strong>',':</strong>\n\t\t\t\t\t\t\t\t\t<span data-role="error/text"></span>\n\t\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div style="text-align: center;">\n\t\t\t\t\t\t\t\t<button \n\t\t\t\t\t\t\t\t\tdata-role="error/close" \n\t\t\t\t\t\t\t\t\tclass="ui-btn ui-btn-light-border"\n\t\t\t\t\t\t\t\t\tstyle="display: none;"\n\t\t\t\t\t\t\t\t>','</button>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div data-role="grid"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),e?"":'<div data-role="hint" class="ui-hint-icon crm-report-tracking-panel-hint"></div>',n.Loc.getMessage("CRM_REPORT_TRACKING_AD_REPORT_ERROR_TITLE"),n.Loc.getMessage("CRM_REPORT_TRACKING_AD_REPORT_CLOSE"));this.ui.container=i;this.ui.title=this.getNode("title");this.ui.hint=this.getNode("hint");this.ui.loader=this.getNode("loader");this.ui.loaderText=this.getNode("loader/text");this.ui.error=this.getNode("error");this.ui.errorText=this.getNode("error/text");this.ui.errorClose=this.getNode("error/close");this.ui.grid=this.getNode("grid");var a=new BX.UI.ProgressBar({value:0,maxValue:100,statusType:"none",column:true});if(this.ui.hint){this.ui.hint.addEventListener("click",(function(){return BX.Helper.show("redirect=detail&code=12526974")}))}if(this.ui.errorClose){this.ui.errorClose.addEventListener("click",(function(){if(r.loaded){r.hideError()}else{BX.SidePanel.Instance.close()}}))}this.getNode("loader/bar").insertBefore(a.getContainer(),this.getNode("loader/bar").children[0]);this.ui.loaderProgressBar=a;this.setLoaderText(n.Loc.getMessage("CRM_REPORT_TRACKING_AD_REPORT_BUILD"));this.setTitle(n.Loc.getMessage("CRM_REPORT_TRACKING_AD_REPORT_TITLE_"+this.filter.level));return i}},{key:"setLoaderText",value:function t(e){this.ui.loaderProgressBar.setValue(0);this.ui.loaderProgressBar.setTextBefore(e)}},{key:"animateLoader",value:function t(){var e=this;if(!this.ui.loaderActive){return}var r=this.ui.loaderProgressBar;var i=parseInt(r.getValue())+1;if(i<=95){r.update(i)}setTimeout((function(){return e.animateLoader()}),100)}},{key:"showError",value:function t(e){this.ui.errorClose.style.display="";this.ui.error.style.display="";this.ui.errorText.textContent=e.message;this.ui.loaderProgressBar.getContainer().style.display="none"}},{key:"hideError",value:function t(){this.ui.errorClose.style.display="none";this.ui.error.style.display="none";this.ui.errorText.textContent="";this.ui.loaderProgressBar.getContainer().style.display="";this.hideLoader()}},{key:"showLoader",value:function t(){var e=this;if(!this.ui.loaderActive){setTimeout((function(){return e.animateLoader()}),100)}this.ui.loaderActive=true;this.ui.loader.style.display=""}},{key:"hideLoader",value:function t(){var e=this.ui.loaderProgressBar;if(e){e.update(0)}this.ui.loaderActive=false;this.ui.loader.style.display="none"}},{key:"setTitle",value:function t(e){return this.ui.title.textContent=e}},{key:"getNode",value:function t(e){return this.ui.container.querySelector('[data-role="'.concat(e,'"]'))}},{key:"getNodes",value:function t(e){return Array.from(this.ui.container.querySelectorAll('[data-role="'.concat(e,'"]')))}},{key:"onBeforeGridRequest",value:function t(e,r){var i=this;r.sessid=BX.bitrix_sessid();r.method="POST";if(!r.url){var n=Object.keys(this.filter).forEach((function(t){return t+"="+i.filter[t]}));r.url="/bitrix/services/main/ajax.php?action=crm.api.tracking.ad.grid.report.get&"+n}r.data=d({},r.data)}}],[{key:"open",value:function e(r){if(window===top){return Promise.resolve(new t(r))}return top.BX.Runtime.loadExtension("crm.report.tracking.ad.report").then((function(){return new top.BX.Crm.Report.Tracking.Ad.Report(r)}))}}]);return t}();t.Report=c})(this.BX.Crm.Report.Tracking.Ad=this.BX.Crm.Report.Tracking.Ad||{},BX,BX.UI,BX,BX,BX.Event,BX.Main);
//# sourceMappingURL=report.bundle.map.js