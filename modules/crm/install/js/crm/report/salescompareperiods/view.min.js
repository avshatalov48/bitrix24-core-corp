(function(){"use strict";BX.namespace("BX.Crm.Report.Dashboard.Content");BX.Crm.Report.Dashboard.Content.SalesComparePeriods={filter:null,timePeriodField:null,previousPeriodField:null,init:function(e){setTimeout(function(){this.filter=BX.Main.filterManager.getById(e);if(this.filter){this.filter.getEmitter().subscribe("BX.Filter.Field:init",this.onFilterFieldInit.bind(this))}else{console.error("Filter "+e+" is not found")}}.bind(this),500)},renderBalloon:function(e,t){var a=e.dataContext.balloon;a.amountCurrentFormatted=a.amountCurrentFormatted||"&mdash;";a.amountPrevFormatted=a.amountPrevFormatted||"&mdash;";return'<div class="crm-report-sales-dynamics-modal" style="border-color: #F7CC00;">'+'     <div class="crm-report-sales-dynamics-modal-title">'+BX.util.htmlspecialchars(a.dateCurrent)+" &sol; "+BX.util.htmlspecialchars(a.datePrev)+"    </div>"+'    <div class="crm-report-sales-dynamics-modal-main">'+'        <div class="crm-report-sales-dynamics-modal-subtitle">'+BX.message("CRM_REPORT_SALES_COMPARE_CURRENT_PERIOD")+"</div>"+'        <div class="crm-report-sales-dynamics-modal-content">'+'            <div class="crm-report-sales-dynamics-modal-value">'+a.amountCurrentFormatted+"            </div>"+this.renderPercentBlock(a.amountCurrent,a.amountPrev)+"        </div>"+'        <div class="crm-report-sales-dynamics-modal-subtitle">'+BX.message("CRM_REPORT_SALES_COMPARE_PREV_PERIOD")+"</div>"+'        <div class="crm-report-sales-dynamics-modal-content">'+'            <div class="crm-report-sales-dynamics-modal-value">'+a.amountPrevFormatted+"            </div>"+"        </div>"+"    </div>"+"</div>"},renderPercentBlock:function(e,t){var a;e=+e||0;t=+t||0;if(e===0||t===0){return'<div style="color:grey;">&mdash;</div>'}else{a=e/t-1}var r="crm-report-sales-dynamics-modal-percent-value";var s=Math.round(a*100);if(s>0){r+=" green"}else{r+=" red"}s=(s>0?"+":"")+s.toString();return'<div class="'+r+'">'+s+"%</div>"},onFilterFieldInit:function(e){var t=e.data.field;if(t.id==="TIME_PERIOD"){this.timePeriodField=t;t.subscribe("BX.Filter.Field:change",this.onTimePeriodChange.bind(this))}else if(t.id==="PREVIOUS_PERIOD"){this.previousPeriodField=t}},onTimePeriodChange:function(e){var t=this.preparePreviousPeriodValue(e.data.value);this.previousPeriodField.setValue(t)},preparePreviousPeriodValue:function(e){var t={_datesel:"",_from:"",_to:""};var a=new Date;var r=[1,1,1,2,2,2,3,3,3,4,4,4];var s=BX.date.convertBitrixFormat(BX.message("FORMAT_DATE"));switch(e._datesel){case"CURRENT_WEEK":t._datesel="LAST_WEEK";break;case"CURRENT_MONTH":t._datesel="LAST_MONTH";break;case"CURRENT_QUARTER":t._datesel="QUARTER";var i=r[a.getMonth()];if(i==1){t._quarter=4;t._year=a.getFullYear()-1}else{t._quarter=3;t._year=a.getFullYear()}break;case"QUARTER":t._datesel="QUARTER";if(e._quarter==1){t._quarter=4;t._year=e._year-1}else{t._quarter=e._quarter-1;t._year=e._year}break;case"LAST_7_DAYS":t._datesel="RANGE";this.setPreviousPeriodDates(7,t);break;case"LAST_30_DAYS":t._datesel="RANGE";this.setPreviousPeriodDates(30,t);break;case"LAST_60_DAYS":t._datesel="RANGE";this.setPreviousPeriodDates(60,t);break;case"LAST_90_DAYS":t._datesel="RANGE";this.setPreviousPeriodDates(90,t);break;case"LAST_WEEK":t._datesel="RANGE";var o=new Date;o.setDate(o.getDate()-o.getDay()+1-14);var l=new Date(o.valueOf());l.setDate(l.getDate()+6);t._from=BX.date.format(s,o);t._to=BX.date.format(s,l);break;case"LAST_MONTH":t._datesel="MONTH";if(a.getMonth()<=1){t._month=10+a.getMonth();t._year=a.getFullYear()-1}else{t._month=a.getMonth()-1;t._year=a.getFullYear()}break;case"MONTH":t._datesel="MONTH";t._month=a.getMonth()===0?11:a.getMonth();t._year=a.getMonth()===0?a.getFullYear()-1:a.getFullYear();break;case"YEAR":t._datesel="YEAR";t._year=a.getFullYear()-1;break;case"RANGE":t._datesel="RANGE";break}for(var d in t){if(t.hasOwnProperty(d)){t[d]=t[d].toString()}}return t},setPreviousPeriodDates:function(e,t){var a=BX.date.convertBitrixFormat(BX.message("FORMAT_DATE"));var r=new Date;r.setDate(r.getDate()-e*2+1);t._from=BX.date.format(a,r);var s=new Date;s.setDate(s.getDate()-e+1);t._to=BX.date.format(a,s)}}})();
//# sourceMappingURL=view.map.js