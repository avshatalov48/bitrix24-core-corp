{"version":3,"file":"call-message.bundle.js","sources":["../src/call-message.js"],"sourcesContent":["import { hint } from 'ui.vue3.directives.hint';\n\nimport { Type, Loc } from 'main.core';\n\nimport { MessageHeader } from 'im.v2.component.message.elements';\nimport { BaseMessage } from 'im.v2.component.message.base';\nimport { DateCode, DateFormatter } from 'im.v2.lib.date-formatter';\nimport { CallManager } from 'im.v2.lib.call';\nimport { Messenger } from 'im.public';\nimport { ChatType } from 'im.v2.const';\nimport { Analytics } from 'call.lib.analytics';\n\nimport './css/call-message.css';\n\nimport type { ImModelMessage } from 'im.v2.model';\nimport type { ImModelChat } from 'im.v2.model';\n\ntype ComponentParams = {\n\tmessageType: $Values<typeof MESSAGE_TYPE>,\n\tmessageText: string,\n\tcallId: number,\n\tinitiatorId: number,\n}\n\nconst MESSAGE_TYPE = {\n\tstart: 'START',\n\tfinish: 'FINISH',\n\tdeclined: 'DECLINED',\n\tbusy: 'BUSY',\n\tmissed: 'MISSED',\n}\n\n// @vue/component\nexport const CallMessage = {\n\tname: 'CallMessage',\n\tcomponents: { BaseMessage, MessageHeader },\n\tdirectives: { hint },\n\tprops:\n\t{\n\t\titem: {\n\t\t\ttype: Object,\n\t\t\trequired: true,\n\t\t},\n\t\tdialogId: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\twithTitle: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: true,\n\t\t},\n\t},\n\tdata(): Object\n\t{\n\t\treturn {\n\t\t\tshowHint: false,\n\t\t};\n\t},\n\tcreated()\n\t{\n\t\tthis.hintTimeout = null\n\t},\n\tcomputed:\n\t{\n\t\tmessage(): ImModelMessage\n\t\t{\n\t\t\treturn this.item;\n\t\t},\n\t\tcomponentParams(): ComponentParams\n\t\t{\n\t\t\treturn this.item.componentParams;\n\t\t},\n\t\tmessageIconClasses(): [string]\n\t\t{\n\t\t\tconst result = ['bx-call-message__icon'];\n\n\t\t\tswitch (this.componentParams.messageType)\n\t\t\t{\n\t\t\t\tcase MESSAGE_TYPE.start:\n\t\t\t\t\tresult.push('bx-call-message__icon--secondary');\n\t\t\t\t\tbreak;\n\t\t\t\tcase MESSAGE_TYPE.finish:\n\t\t\t\t\tresult.push('bx-call-message__icon--primary');\n\t\t\t\t\tbreak;\n\t\t\t\tcase MESSAGE_TYPE.declined:\n\t\t\t\tcase MESSAGE_TYPE.busy:\n\t\t\t\tcase MESSAGE_TYPE.missed:\n\t\t\t\t\tresult.push('bx-call-message__icon--danger');\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tresult.push('bx-call-message__icon--secondary');\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\treturn result;\n\t\t},\n\t\tmessageText(): string\n\t\t{\n\t\t\treturn this.componentParams.messageText\n\t\t},\n\t\tformattedDate(): string\n\t\t{\n\t\t\treturn DateFormatter.formatByCode(this.message.date, DateCode.shortTimeFormat);\n\t\t},\n\t\tcurrentCall()\n\t\t{\n\t\t\treturn CallManager.getInstance().getCurrentCall();\n\t\t},\n\t\thasActiveCurrentCall(): boolean\n\t\t{\n\t\t\treturn CallManager.getInstance().hasActiveCurrentCall(this.dialogId);\n\t\t},\n\t\thasActiveAnotherCall(): boolean\n\t\t{\n\t\t\treturn CallManager.getInstance().hasActiveAnotherCall(this.dialogId);\n\t\t},\n\t\tdialog(): ImModelChat\n\t\t{\n\t\t\treturn this.$store.getters['chats/get'](this.dialogId, true);\n\t\t},\n\t\tisConference(): boolean\n\t\t{\n\t\t\treturn this.dialog.type === ChatType.videoconf;\n\t\t},\n\t\thintContent(): Object | null\n\t\t{\n\t\t\tif (!this.showHint)\n\t\t\t{\n\t\t\t\treturn null;\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\ttext: this.loc('CALL_MESSAGE_HAS_ACTIVE_CALL_HINT'),\n\t\t\t\tpopupOptions: {\n\t\t\t\t\tbindOptions: {\n\t\t\t\t\t\tposition: 'top',\n\t\t\t\t\t},\n\t\t\t\t\tangle: { position: 'bottom' },\n\t\t\t\t\ttargetContainer: document.body,\n\t\t\t\t\toffsetLeft: 65,\n\t\t\t\t\toffsetTop: 0,\n\t\t\t\t},\n\t\t\t};\n\t\t},\n\t},\n\tmethods:\n\t{\n\t\tloc(phraseCode: string, replacements: {[p: string]: string} = {}): string\n\t\t{\n\t\t\treturn Loc.getMessage(phraseCode, replacements);\n\t\t},\n\t\tonMessageClick()\n\t\t{\n\t\t\tif (this.hasActiveAnotherCall)\n\t\t\t{\n\t\t\t\tthis.showHint = true;\n\t\t\t\tclearTimeout(this.hintTimeout);\n\t\t\t\tthis.hintTimeout = setTimeout(() => this.showHint = false, 10000);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.componentParams.messageType === MESSAGE_TYPE.start\n\t\t\t\t? Analytics.getInstance().onStartCallMessageClick({ dialog: this.dialog })\n\t\t\t\t: Analytics.getInstance().onFinishCallMessageClick({ dialog: this.dialog });\n\n\t\t\tthis.isConference\n\t\t\t\t? Messenger.openConference({ code: this.dialog.public.code })\n\t\t\t\t: Messenger.startVideoCall(this.dialogId);\n\t\t},\n\t},\n\ttemplate: `\n\t\t<BaseMessage\n\t\t\t:dialogId=\"dialogId\"\n\t\t\t:item=\"item\"\n\t\t\t:withContextMenu=\"false\"\n\t\t\t:withBackground=\"true\"\n\t\t\t:withReactions=\"false\"\n\t\t\tclass=\"bx-call-message__scope\"\n\t\t>\n\t\t\t<div class=\"bx-call-message__container\">\n\t\t\t\t<div class=\"bx-call-message__content-wrapper\">\n\t\t\t\t\t<MessageHeader :withTitle=\"withTitle\" :item=\"item\" />\n\t\t\t\t\t<div :key=\"showHint\" class=\"bx-call-message__content\" v-hint=\"hintContent\" @click=\"onMessageClick\">\n\t\t\t\t\t\t<div :class=\"messageIconClasses\"></div>\n\t\t\t\t\t\t<div class=\"bx-call-message__text-container\">\n\t\t\t\t\t\t\t<div class=\"bx-call-message__text\">{{ messageText }}</div>\n\t\t\t\t\t\t\t<div class=\"bx-im-message-status__date bx-call-message__date\">\n\t\t\t\t\t\t\t\t{{ formattedDate }}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</BaseMessage>\n\t`,\n};\n"],"names":["MESSAGE_TYPE","start","finish","declined","busy","missed","CallMessage","name","components","BaseMessage","MessageHeader","directives","hint","props","item","type","Object","required","dialogId","String","withTitle","Boolean","default","data","showHint","created","hintTimeout","computed","message","componentParams","messageIconClasses","result","messageType","push","messageText","formattedDate","DateFormatter","formatByCode","date","DateCode","shortTimeFormat","currentCall","CallManager","getInstance","getCurrentCall","hasActiveCurrentCall","hasActiveAnotherCall","dialog","$store","getters","isConference","ChatType","videoconf","hintContent","text","loc","popupOptions","bindOptions","position","angle","targetContainer","document","body","offsetLeft","offsetTop","methods","phraseCode","replacements","Loc","getMessage","onMessageClick","clearTimeout","setTimeout","Analytics","onStartCallMessageClick","onFinishCallMessageClick","Messenger","openConference","code","public","startVideoCall","template"],"mappings":"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"}