this.BX=this.BX||{};(function(e,t,n,r){"use strict";var a=function(){function e(t){babelHelpers.classCallCheck(this,e);this.data=t}babelHelpers.createClass(e,[{key:"getId",value:function e(){return parseInt(this.data.id)}},{key:"getName",value:function e(){return this.data.name}}],[{key:"create",value:function t(n){if(r.Type.isPlainObject(n)&&parseInt(n.id)>0&&r.Type.isString(n.name)){return new e(n)}return null}}]);return e}();var i=function(){function e(t){babelHelpers.classCallCheck(this,e);this.data=t}babelHelpers.createClass(e,[{key:"getId",value:function e(){return parseInt(this.data.id)}},{key:"getTitle",value:function e(){return this.data.title}},{key:"getPublicUrl",value:function e(){return this.data.publicUrl}}],[{key:"create",value:function t(n){if(r.Type.isPlainObject(n)&&parseInt(n.id)>0&&r.Type.isString(n.title)){return new e(n)}return null}}]);return e}();var o=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"progress",false);babelHelpers.defineProperty(this,"templates",null);babelHelpers.defineProperty(this,"documents",null);babelHelpers.defineProperty(this,"analyticsLabelPrefix","documentgeneratorSelector");babelHelpers.defineProperty(this,"isDocumentsLimitReached",false);if(r.Type.isPlainObject(t)){if(r.Type.isDomNode(t.node)){this.node=t.node}if(r.Type.isString(t.moduleId)){this.moduleId=t.moduleId}if(r.Type.isString(t.provider)){this.provider=t.provider}if(r.Type.isString(t.analyticsLabelPrefix)){this.analyticsLabelPrefix=t.analyticsLabelPrefix}if(r.Type.isString(t.value)||r.Type.isNumber(t.value)){this.value=t.value}}}babelHelpers.createClass(e,[{key:"isValid",value:function e(){return r.Type.isString(this.moduleId)&&this.moduleId.length>0&&r.Type.isString(this.provider)&&this.provider.length>0&&!r.Type.isNil(this.value)}},{key:"createDocument",value:function e(t){var n=this;return new Promise(function(e,o){if(n.progress){o("loading")}if(n.isValid()&&t instanceof a){n.progress=true;n.showLoader();BX.DocumentGenerator.Document.askAboutUsingPreviousDocumentNumber(n.provider,t.getId(),n.value,function(a){var s={templateId:t.getId(),providerClassName:n.provider,value:n.value,values:{}};if(a){s.values.DocumentNumber=a}r.ajax.runAction("documentgenerator.document.add",{data:s,analyticsLabel:n.analyticsLabelPrefix+"CreateDocument"}).then(function(t){n.progress=false;n.hideLoader();var a=i.create(t.data.document);if(a){if(r.Type.isArray(n.documents)){n.documents.unshift(a)}e(a)}else{o("error trying create document object")}}).catch(function(e){n.progress=false;n.hideLoader();o(n.getErrorMessageFromResponse(e))})},function(){n.progress=false;n.hideLoader()})}else{o("error trying generate document")}})}},{key:"getDocumentPublicUrl",value:function e(t){var n=this;return new Promise(function(e,a){if(!(t instanceof i)){a("wrong document");return}if(r.Type.isString(t.getPublicUrl())&&t.getPublicUrl().length>0){e(t.getPublicUrl())}else{if(n.progress){a("loading")}else{n.progress=true;n.showLoader();r.ajax.runAction("documentgenerator.document.enablePublicUrl",{data:{id:t.getId(),status:1},analyticsLabel:n.analyticsLabelPrefix+"GetPublicUrl"}).then(function(r){n.progress=false;n.hideLoader();t.data.publicUrl=r.data.publicUrl;e(t.getPublicUrl())}).catch(function(e){n.progress=false;n.hideLoader();a(n.getErrorMessageFromResponse(e))})}}})}},{key:"show",value:function e(){var t=this;var r=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;return new Promise(function(e,a){if(!r){r=t.node}t.getTemplates().then(function(a){n.PopupMenu.show(t.getPopupMenuId(),r,t.prepareTemplatesList(a,function(r){var a=n.PopupMenu.getMenuById(t.getPopupMenuId());if(a){a.destroy()}e(r)}),{offsetLeft:0,offsetTop:0,closeByEsc:true})}).catch(function(e){if(e!=="loading"){a(e)}})})}},{key:"getTemplates",value:function e(){var t=this;return new Promise(function(e,n){if(!t.isValid()){n("wrong data");return}if(t.templates===null){if(t.progress){n("loading");return}t.progress=true;t.showLoader();r.ajax.runAction("documentgenerator.api.document.getButtonTemplates",{data:{moduleId:t.moduleId,provider:t.provider,value:t.value},analyticsLabel:t.analyticsLabelPrefix+"LoadTemplates"}).then(function(n){t.progress=false;t.hideLoader();t.parseButtonResponse(n);e(t.templates)}).catch(function(e){t.progress=false;t.hideLoader();n(t.getErrorMessageFromResponse(e))})}else{e(t.templates)}})}},{key:"getDocuments",value:function e(t){var n=this;return new Promise(function(e,a){if(n.progress){a("loading");return}if(n.documents===null){n.documents=[];n.progress=true;n.showLoader(t);r.ajax.runAction("documentgenerator.document.list",{data:{select:["id","number","title"],filter:{provider:n.provider.replace(/\\/g,"\\\\"),value:n.value},order:{id:"desc"}},analyticsLabel:n.analyticsLabelPrefix+"LoadDocuments"}).then(function(t){n.progress=false;n.hideLoader();t.data.documents.forEach(function(e){var t=i.create(e);if(t){n.documents.push(t)}});e(n.documents)}).catch(function(e){n.progress=false;n.hideLoader();a(n.getErrorMessageFromResponse(e))})}else{e(n.documents)}})}},{key:"prepareTemplatesList",value:function e(t,n){var a=this;var i=[];if(this.isDocumentsLimitReached){i.push({text:r.Loc.getMessage("DOCGEN_SELECTOR_MENU_DOCUMENTS_LIMIT_REACHED_ADD"),className:"documentgenerator-selector-menu-item-with-lock",onclick:function e(){a.showTariffPopup();n(null)}})}else if(r.Type.isArray(t)&&r.Type.isFunction(n)){t.forEach(function(e){i.push({text:e.getName(),onclick:function t(){n(e)}})})}if(i.length>0){i.push({delimiter:true})}var o=this;i.push({text:r.Loc.getMessage("DOCGEN_SELECTOR_MENU_DOCUMENTS"),cacheable:true,events:{onSubMenuShow:function e(){var t=this;if(this.isSubmenuLoaded){return}this.isSubmenuLoaded=true;var a=this.getSubMenu();var i=a.getMenuItem("loading");o.getDocuments(i.getLayout().text).then(function(e){if(e.length<=0){if(i){i.getLayout().text.innerText=r.Loc.getMessage("DOCGEN_SELECTOR_MENU_DOCUMENTS_EMPTY")}}else{a.removeMenuItem("loading");var o=[];e.forEach(function(e){o.push({text:e.getTitle(),onclick:function t(){n(e)}})});t.addSubMenu(o);t.showSubMenu()}}).catch(function(e){if(i){i.getLayout().text.innerText=e}})}},items:[{id:"loading",text:r.Loc.getMessage("DOCGEN_SELECTOR_MENU_DOCUMENTS_LOADING")}]});return i}},{key:"parseButtonResponse",value:function e(t){var n=this;this.templates=[];if(t.data&&t.data.isDocumentsLimitReached){this.isDocumentsLimitReached=t.data.isDocumentsLimitReached}if(t.data&&t.data.templates&&r.Type.isArray(t.data.templates)){t.data.templates.forEach(function(e){var t=a.create(e);if(t){n.templates.push(t)}})}return this.templates}},{key:"getErrorMessageFromResponse",value:function e(t){var n="";if(t.errors&&r.Type.isArray(t.errors)){t.errors.forEach(function(e){var t=e.message;if(n.length>0){n+=", "}n+=t})}return n}},{key:"getLoader",value:function e(){if(!this.loader){this.loader=new t.Loader({size:50})}return this.loader}},{key:"showLoader",value:function e(t){if(!r.Type.isDomNode(t)){t=this.node}if(t&&!this.getLoader().isShown()){this.getLoader().show(t)}}},{key:"hideLoader",value:function e(){if(this.getLoader().isShown()){this.getLoader().hide()}}},{key:"getPopupMenuId",value:function e(){return"documentgenerator-selector-popup-menu"}},{key:"showTariffPopup",value:function e(){var t=this;this.getFeatureContent().then(function(e){t.getFeaturePopup(e).show()}).catch(function(e){console.error(e)})}},{key:"getFeaturePopup",value:function e(t){var r=this;if(this.featurePopup!=null){return this.featurePopup}this.featurePopup=new n.PopupWindow("bx-popup-documentgenerator-popup",null,{zIndex:200,autoHide:true,closeByEsc:true,closeIcon:true,overlay:true,events:{onPopupDestroy:function e(){r.featurePopup=null}},content:t,contentColor:"white"});return this.featurePopup}},{key:"getFeatureContent",value:function e(){var t=this;return new Promise(function(e,n){if(t.featureContent){e(t.featureContent);return}r.ajax.runAction("documentgenerator.document.getFeature").then(function(n){t.featureContent=document.createElement("div");t.getFeaturePopup(t.featureContent);r.Runtime.html(t.featureContent,n.data.html,{htmlFirst:true}).then(function(){e(t.featureContent)})}).catch(function(e){n(t.getErrorMessageFromResponse(e))})})}}]);return e}();var s={Menu:o,Template:a,Document:i};e.Selector=s})(this.BX.DocumentGenerator=this.BX.DocumentGenerator||{},BX,BX,BX);
//# sourceMappingURL=selector.bundle.map.js