(function(){BX.namespace("BX.DocumentGenerator");BX.DocumentGenerator.UploadTemplate={currentUrl:null,fileInputNode:"upload-template-button",fileInputTextNode:"upload-template-text",fileInputDropZone:"upload-template-dragndrop-zone",providerBlockNode:"add-template-provider-block",nameBlockNode:"add-template-name-block",activeBlockNode:"add-template-active-block",userBlockNode:"add-template-user-block",numeratorSelectNode:"docs-template-num-select",numeratorBlockNode:"add-template-numerator-block",regionBlockNode:"add-template-region-block",fileBlockNode:"upload-template-file-block",uploadBlockNode:"upload-template-upload-block",buttonsBlockNode:"add-template-buttons-block",saveButton:"add-template-save-button",cancelButton:"add-template-cancel-button",progressMessageNode:"upload-template-progress-message",errorMessageNode:"upload-template-error-message",successMessageNode:"upload-template-success-message",fileId:null,userSelectorId:"add-template-users",userListContainer:"add-template-user-list-container",providers:{},providerSelectorId:"add-template-providers",providerListContainer:"add-template-providers-container",providerListShowContainer:"container-add-template-providers",providerListPopupContainer:"container-add-template-providers-popup",regionSelectorId:"docs-template-region-select",nameInputNode:"add-template-name-input",activeInputNode:"add-template-active-input",stampsInputNode:"add-template-stamps-input",deleteFileNode:"upload-template-delete-file",templateId:null,moduleId:"",downloadUrl:null,defaultCode:null,popupConfirm:null,loader:null,progress:false,regions:{},addRegionUrl:null,addRegionNode:"docs-template-region-create-btn",editRegionNode:"docs-template-region-edit-btn",closeDragZoneNode:"upload-template-dragndrop-cancel"};BX.DocumentGenerator.UploadTemplate.initUploader=function(e){var t=BX.Uploader.getInstance({id:"template-add",streams:1,uploadFileUrl:e,uploadMethod:"immediate",showImage:false,sortItems:false,input:BX(this.fileInputNode),dropZone:BX(this.fileInputDropZone),uploadFormData:"N",allowUploadExt:"docx"});this.setInputNodeAcceptAttribute();BX.addCustomEvent(t,"onFileinputIsReinited",this.setInputNodeAcceptAttribute);BX.addCustomEvent(t,"onFileIsInited",this.initFile);BX.addCustomEvent(t,"onFileIsUploaded",this.onFileUploadDone);BX.addCustomEvent(t,"onFileIsUploadedWithError",this.onUploadError);return t};BX.DocumentGenerator.UploadTemplate.init=function(e){BX.hide(BX(this.fileInputNode));var t=BX.SidePanel.Instance.getTopSlider();if(t){this.currentUrl=t.getUrl()}if(e.uploadUrl){this.uploader=this.initUploader(e.uploadUrl)}this.addRegionUrl=e.addRegionUrl||null;this.downloadUrl=e.downloadUrl||null;this.defaultCode=e.defaultCode||null;BX.bind(BX("upload-template-download-file"),"click",BX.proxy(function(e){e.preventDefault();if(this.downloadUrl){window.open(this.downloadUrl,"_blank")}},this));BX.bind(BX("upload-template-reinstall"),"click",BX.proxy(function(e){if(this.progress){return}e.preventDefault();if(this.defaultCode){if(this.popupConfirm){this.popupConfirm.destroy()}this.popupConfirm=new BX.PopupWindow("crm-document-reinstall-template-popup",null,{zIndex:200,autoHide:true,closeByEsc:true,buttons:[new BX.PopupWindowButton({text:BX.message("DOCGEN_TEMPLATE_ADD_INSTALL"),className:"popup-window-button-accept",events:{click:BX.proxy(this.reinstallTemplate,this)}}),new BX.PopupWindowButtonLink({text:BX.message("DOCGEN_TEMPLATE_ADD_CANCEL"),className:"popup-window-button-decline",events:{click:function(){this.popupWindow.close()}}})],overlay:true,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){this.popupConfirm=null},this)},content:BX.message("DOCGEN_TEMPLATE_ADD_REINSTALL_CONFIRM"),titleBar:BX.message("DOCGEN_TEMPLATE_ADD_REINSTALL_CONFIRM_TITLE"),contentColor:"white"});this.popupConfirm.show()}},this));BX.bind(BX(this.fileInputTextNode),"click",BX.proxy(function(){BX.fireEvent(BX(this.fileInputNode),"click")},this));BX.bind(BX(this.cancelButton),"click",this.onClickCancel);BX.addCustomEvent("SidePanel.Slider:onCloseComplete",this.onSliderClose);this.initUserSelector();this.initProviderSelector();BX.bind(BX(this.saveButton),"click",BX.proxy(this.onClickSave,this));var o=BX.util.add_url_param("/bitrix/components/bitrix/main.numerator.edit/slider.php",{NUMERATOR_TYPE:"DOCUMENT"});BX.bind(BX("docs-template-numerator-edit-btn"),"click",BX.proxy(function(e){e.preventDefault();var t=BX.util.add_url_param(o,{ID:BX(this.numeratorSelectNode).value});if(BX.SidePanel){BX.SidePanel.Instance.open(t,{width:480})}else{location.href=t}},this));BX.bind(BX("docs-template-numerator-create-btn"),"click",BX.proxy(function(e){e.preventDefault();if(BX.SidePanel){BX.SidePanel.Instance.open(o,{width:480,cacheable:false})}else{location.href=o}},this));if(this.addRegionUrl){BX.bind(BX(this.addRegionNode),"click",BX.proxy(function(e){e.preventDefault();if(BX.SidePanel){BX.SidePanel.Instance.open(this.addRegionUrl,{width:480,cacheable:false,events:{onClose:BX.DocumentGenerator.UploadTemplate.reloadRegions}})}else{location.href=this.addRegionUrl}},this))}BX.bind(BX(this.deleteFileNode),"click",BX.proxy(function(){BX.show(BX(this.uploadBlockNode));BX.hide(BX(this.fileBlockNode));if(this.fileId>0){BX.show(BX(this.closeDragZoneNode))}else{BX.hide(BX(this.closeDragZoneNode))}},this));BX.bind(BX(this.closeDragZoneNode),"click",BX.proxy(function(){BX.show(BX(this.fileBlockNode));BX.hide(BX(this.uploadBlockNode))},this));BX.bind(BX(this.regionSelectorId),"change",BX.proxy(function(){if(this.regions[BX(this.regionSelectorId).value]&&this.regions[BX(this.regionSelectorId).value].id>0){BX.show(BX(this.editRegionNode))}else{BX.hide(BX(this.editRegionNode))}},this));BX.bind(BX(this.editRegionNode),"click",BX.proxy(function(e){e.preventDefault();var t,o=false;if(this.regions[BX(this.regionSelectorId).value]&&this.regions[BX(this.regionSelectorId).value].id>0){o=this.regions[BX(this.regionSelectorId).value].id}if(o){t=BX.util.add_url_param(this.addRegionUrl,{id:o})}else{t=this.addRegionUrl}if(BX.SidePanel){BX.SidePanel.Instance.open(t,{width:480,cacheable:false,events:{onClose:BX.DocumentGenerator.UploadTemplate.reloadRegions}})}else{location.href=t}},this))};BX.DocumentGenerator.UploadTemplate.initFile=function(e,t){if(!BX.DocumentGenerator.UploadTemplate.templateId){BX.DocumentGenerator.UploadTemplate.deletePreviousFile()}BX.addCustomEvent(t,"onUploadStart",BX.DocumentGenerator.UploadTemplate.onUploadProgress);BX.addCustomEvent(t,"onUploadProgress",BX.DocumentGenerator.UploadTemplate.onUploadProgress);BX.hide(BX(BX.DocumentGenerator.UploadTemplate.successMessageNode))};BX.DocumentGenerator.UploadTemplate.removeFileEvents=function(e){BX.removeCustomEvent(e,"onUploadStart",BX.DocumentGenerator.UploadTemplate.onUploadProgress);BX.removeCustomEvent(e,"onUploadProgress",BX.DocumentGenerator.UploadTemplate.onUploadProgress)};BX.DocumentGenerator.UploadTemplate.onUploadProgress=function(){BX(BX.DocumentGenerator.UploadTemplate.progressMessageNode).innerText=BX.message("DOCGEN_TEMPLATE_ADD_PROGRESS");BX.show(BX(BX.DocumentGenerator.UploadTemplate.progressMessageNode));BX.hide(BX(BX.DocumentGenerator.UploadTemplate.errorMessageNode))};BX.DocumentGenerator.UploadTemplate.onFileUploadDone=function(e,t,o){BX(BX.DocumentGenerator.UploadTemplate.progressMessageNode).innerText=BX.message("DOCGEN_TEMPLATE_ADD_COMPLETE");BX.show(BX(BX.DocumentGenerator.UploadTemplate.progressMessageNode));BX.hide(BX(BX.DocumentGenerator.UploadTemplate.errorMessageNode));if(o.status==="uploaded"){BX.DocumentGenerator.UploadTemplate.fileId=o.file.FILE_ID;if(!BX(BX.DocumentGenerator.UploadTemplate.nameInputNode).value){BX(BX.DocumentGenerator.UploadTemplate.nameInputNode).value=o.file.name}BX("upload-template-file-name").innerText=t.name||"";BX("upload-template-file-size").innerText=t.size||"";BX.show(BX(BX.DocumentGenerator.UploadTemplate.providerBlockNode));BX.show(BX(BX.DocumentGenerator.UploadTemplate.nameBlockNode));BX.show(BX(BX.DocumentGenerator.UploadTemplate.activeBlockNode));BX.show(BX(BX.DocumentGenerator.UploadTemplate.userBlockNode));BX.show(BX(BX.DocumentGenerator.UploadTemplate.buttonsBlockNode));BX.show(BX(BX.DocumentGenerator.UploadTemplate.regionBlockNode));BX.show(BX(BX.DocumentGenerator.UploadTemplate.numeratorBlockNode));BX.show(BX(BX.DocumentGenerator.UploadTemplate.fileBlockNode));BX.hide(BX(BX.DocumentGenerator.UploadTemplate.uploadBlockNode))}};BX.DocumentGenerator.UploadTemplate.onUploadError=function(e,t,o){BX.DocumentGenerator.UploadTemplate.removeFileEvents(t);BX.DocumentGenerator.UploadTemplate.showUploadError(o.error)};BX.DocumentGenerator.UploadTemplate.showUploadError=function(e){if(e){BX(BX.DocumentGenerator.UploadTemplate.errorMessageNode).innerHTML=e}BX.show(BX(BX.DocumentGenerator.UploadTemplate.errorMessageNode));BX.hide(BX(BX.DocumentGenerator.UploadTemplate.progressMessageNode))};BX.DocumentGenerator.UploadTemplate.setInputNodeAcceptAttribute=function(){BX(BX.DocumentGenerator.UploadTemplate.fileInputNode).setAttribute("accept","application/vnd.openxmlformats-officedocument.wordprocessingml.document")};BX.DocumentGenerator.UploadTemplate.onClickCancel=function(e){e.preventDefault();var t=BX.SidePanel.Instance.getTopSlider();if(t){t.close()}};BX.DocumentGenerator.UploadTemplate.onClickSave=function(e){e.preventDefault();var t=[];if(!this.fileId){t.push(BX.message("DOCGEN_TEMPLATE_ADD_ERROR_FILE"))}var o=this.providerSelector.getValue();if(!o||o.length===0){t.push(BX.message("DOCGEN_TEMPLATE_ADD_ERROR_PROVIDER"))}var a="N",r="N";if(BX(this.activeInputNode).checked){a="Y"}if(BX(this.stampsInputNode).checked){r="Y"}var n=BX(this.nameInputNode).value;if(!n||n.length<1){t.push(BX.message("DOCGEN_TEMPLATE_ADD_ERROR_NAME"))}var l=this.userSelector.getValue();if(t.length>0){this.showUploadError(t.join("<br />"))}else{BX.hide(BX(this.errorMessageNode));this.startProgress();var i,d,p;p={fields:{fileId:this.fileId,providers:o,name:n,numeratorId:BX(this.numeratorSelectNode).value,users:l,active:a,withStamps:r,moduleId:this.moduleId,region:BX(this.regionSelectorId).value}};if(this.templateId>0){i="editTemplate";d="documentgenerator.api.template.update";p.id=this.templateId}else{i="addTemplate";d="documentgenerator.api.template.add"}BX.ajax.runAction(d,{analyticsLabel:i,data:p}).then(function(e){BX.DocumentGenerator.UploadTemplate.stopProgress();BX.DocumentGenerator.UploadTemplate.reInitForm();var t=BX.SidePanel.Instance.getTopSlider();if(t){BX.SidePanel.Instance.postMessage(t,"documentgenerator-add-template",{templateId:e.data.template.id});t.close()}else{BX.show(BX(BX.DocumentGenerator.UploadTemplate.successMessageNode))}},function(e){BX.DocumentGenerator.UploadTemplate.stopProgress();BX.DocumentGenerator.UploadTemplate.showUploadError(e.errors.pop().message)})}};BX.DocumentGenerator.UploadTemplate.deletePreviousFile=function(e){if(!BX.type.isFunction(e)){e=BX.DoNothing}if(BX.DocumentGenerator.UploadTemplate.fileId){BX.ajax.runAction("documentgenerator.api.file.delete",{data:{fileId:BX.DocumentGenerator.UploadTemplate.fileId}}).then(e)}else{e()}};BX.DocumentGenerator.UploadTemplate.onSliderClose=function(e){var t=e.getSlider();if(t.getUrl()===BX.DocumentGenerator.UploadTemplate.currentUrl){BX.DocumentGenerator.UploadTemplate.reInitForm()}};BX.DocumentGenerator.UploadTemplate.reInitForm=function(){if(!BX.DocumentGenerator.UploadTemplate.templateId){BX.DocumentGenerator.UploadTemplate.deletePreviousFile();BX.DocumentGenerator.UploadTemplate.fileId=null;BX(BX.DocumentGenerator.UploadTemplate.nameInputNode).value="";BX.DocumentGenerator.UploadTemplate.providerSelector.purge();BX.DocumentGenerator.UploadTemplate.userSelector.purge();try{BX.hide(BX(BX.DocumentGenerator.UploadTemplate.errorMessageNode));BX.hide(BX(BX.DocumentGenerator.UploadTemplate.progressMessageNode));BX.hide(BX(BX.DocumentGenerator.UploadTemplate.providerBlockNode));BX.hide(BX(BX.DocumentGenerator.UploadTemplate.nameBlockNode));BX.hide(BX(BX.DocumentGenerator.UploadTemplate.activeBlockNode));BX.hide(BX(BX.DocumentGenerator.UploadTemplate.userBlockNode));BX.hide(BX(BX.DocumentGenerator.UploadTemplate.numeratorBlockNode));BX.hide(BX(BX.DocumentGenerator.UploadTemplate.buttonsBlockNode));BX.hide(BX(BX.DocumentGenerator.UploadTemplate.regionBlockNode));BX.hide(BX(BX.DocumentGenerator.UploadTemplate.fileBlockNode));BX.show(BX(BX.DocumentGenerator.UploadTemplate.uploadBlockNode))}catch(e){}}};BX.DocumentGenerator.UploadTemplate.initProviderPopup=function(){var e,t=this.providerSelector.getValue();var o=BX.DocumentGenerator.UploadTemplate;var a='<div class="menu-popup"><div class="menu-popup-items">';for(var r in o.providers){e="";if(o.providers.hasOwnProperty(r)){if(t.indexOf(r)!==-1){e=" checked"}a+='<span class="docs-template-load-popup-item">'+'<input class="docs-template-load-popup-input" type="checkbox"'+e+' id="provider-check-'+r+'" value="'+o.providers[r].CLASS+'" onchange="BX.DocumentGenerator.UploadTemplate.onChangeProvider(this);">'+'<label class="docs-template-load-popup-label" for="provider-check-'+r+'">'+o.providers[r].NAME+"</label>"+"</span>"}}a+="</div></div>";o.providerPopup=new BX.PopupWindow(o.providerListPopupContainer,BX(o.providerBlockNode),{content:a,className:"docs-template-load-providers-popup",autoHide:true,closeByEsc:true,offsetLeft:0,offsetTop:5});BX.bind(BX(o.providerListShowContainer),"click",BX.proxy(function(){this.providerPopup.show()},o))};BX.DocumentGenerator.UploadTemplate.onChangeProvider=function(e){if(e.checked){BX.DocumentGenerator.UploadTemplate.providerSelector.add(e.value,e.nextSibling.innerText)}else{BX.DocumentGenerator.UploadTemplate.providerSelector.delete(e.value)}};BX.DocumentGenerator.UploadTemplate.initProviderSelector=function(){BX.DocumentGenerator.UploadTemplate.providerSelector=new BX.DocumentGenerator.UploadTemplate.Selector({id:BX.DocumentGenerator.UploadTemplate.providerSelectorId,multiple:true,onAfterDelete:BX.DocumentGenerator.UploadTemplate.unsetProviderCheckbox})};BX.DocumentGenerator.UploadTemplate.initUserSelector=function(){BX.DocumentGenerator.UploadTemplate.userSelector=new BX.DocumentGenerator.UploadTemplate.Selector({id:BX.DocumentGenerator.UploadTemplate.userSelectorId,multiple:true,onAfterDelete:BX.DocumentGenerator.UploadTemplate.deleteFromSocNetLogDest});BX.onCustomEvent(window,"BX.DocumentGenerator.UploadTemplate:init",[{id:BX.DocumentGenerator.UploadTemplate.userSelectorId,openDialogWhenInit:false,single:false}])};BX.DocumentGenerator.UploadTemplate.openUserSelector=function(e){BX.onCustomEvent(window,"BX.DocumentGenerator.UploadTemplate:open",[{id:BX.DocumentGenerator.UploadTemplate.userSelectorId,contId:e,bindId:e,tagId:BX.DocumentGenerator.UploadTemplate.userSelectorId,bindNode:e}])};BX.DocumentGenerator.UploadTemplate.onSelectUser=function(e){var t=e.id;BX.DocumentGenerator.UploadTemplate.userSelector.add(t,BX.util.htmlspecialcharsback(e.name))};BX.DocumentGenerator.UploadTemplate.onUnSelectUser=function(e){var t=e.id;BX.DocumentGenerator.UploadTemplate.userSelector.delete(t)};BX.DocumentGenerator.UploadTemplate.unsetProviderCheckbox=function(){var e=BX.DocumentGenerator.UploadTemplate.providerSelector.getValue();for(var t in BX.DocumentGenerator.UploadTemplate.providers){if(BX.DocumentGenerator.UploadTemplate.providers.hasOwnProperty(t)){if(BX("provider-check-"+t).checked&&e.indexOf(t)===-1){BX("provider-check-"+t).checked=false}}}};BX.DocumentGenerator.UploadTemplate.deleteFromSocNetLogDest=function(){var e=BX.DocumentGenerator.UploadTemplate.userSelector.getValue();var t=BX.SocNetLogDestination.obItemsSelected[BX.DocumentGenerator.UploadTemplate.userSelectorId];for(var o in t){if(t.hasOwnProperty(o)){if(e.indexOf(o)===-1){delete t[o]}}}};BX.DocumentGenerator.UploadTemplate.setTemplateData=function(e){this.templateId=e.ID;this.fileId=e.FILE_ID;if(BX.type.isArray(e["PROVIDERS"])){for(var t=0;t<e["PROVIDERS"].length;t++){this.providerSelector.add(e["PROVIDERS"][t]["CLASS"],e["PROVIDERS"][t]["NAME"])}}};BX.DocumentGenerator.UploadTemplate.reinstallTemplate=function(){this.popupConfirm.destroy();this.startProgress();BX.ajax.runAction("documentgenerator.api.template.installDefault",{data:{code:this.defaultCode}}).then(function(e){BX.DocumentGenerator.UploadTemplate.fileId=e.data.template.fileId;BX.DocumentGenerator.UploadTemplate.stopProgress();BX.hide(BX(BX.DocumentGenerator.UploadTemplate.errorMessageNode));var t=new BX.PopupWindow("crm-document-reinstall-template-popup-success",null,{zIndex:200,closeIcon:false,autoHide:true,closeByEsc:true,overlay:true,events:{onPopupClose:function(){this.destroy()}},titleBar:BX.message("DOCGEN_TEMPLATE_ADD_REINSTALL_SUCCESS"),contentColor:"white"});t.show()},function(e){BX.DocumentGenerator.UploadTemplate.stopProgress();BX.DocumentGenerator.UploadTemplate.showUploadError(e.errors.pop().message)})};BX.DocumentGenerator.UploadTemplate.Selector=function(e){this.multiple=e.multiple===true;this.values=[];this.id=e.id||BX.util.hashCode(Math.random().toString());this.itemsContainerId="container-"+this.id;this.itemContainerClass="docs-template-load-block-section-inner";this.itemNameClass="docs-template-load-block-section-name";this.itemDeleteClass="docs-template-load-block-delete";this.onAfterDelete=BX.type.isFunction(e.onAfterDelete)?e.onAfterDelete:BX.DoNothing};BX.DocumentGenerator.UploadTemplate.Selector.prototype.add=function(e,t){if(!e){return}var o=this.values.indexOf(e);if(o!==-1){return}if(!this.multiple){for(var a=0;a<this.values.length;a++){this.delete(this.values[a])}}this.values.push(e);t=t||e;BX.append(BX.create("span",{props:{className:this.itemContainerClass},attrs:{id:"item-"+this.id+e},children:[BX.create("span",{props:{className:this.itemNameClass},text:t}),BX.create("span",{props:{className:this.itemDeleteClass},events:{click:BX.proxy(function(){this.delete(e)},this)}})],events:{click:function(e){e.stopPropagation()}}}),BX(this.itemsContainerId))};BX.DocumentGenerator.UploadTemplate.Selector.prototype.delete=function(e){if(!e){return}var t=this.values.indexOf(e);if(t===-1){return}this.values.splice(t,1);BX.remove(BX("item-"+this.id+e));this.onAfterDelete()};BX.DocumentGenerator.UploadTemplate.Selector.prototype.getValue=function(){this.values=BX.util.array_unique(this.values);if(!this.multiple){return this.values[0]}return this.values.slice()};BX.DocumentGenerator.UploadTemplate.Selector.prototype.purge=function(){var e=this.getValue();if(this.multiple){for(var t=0;t<e.length;t++){this.delete(e[t])}}else{this.delete(e)}};BX.DocumentGenerator.UploadTemplate.getLoader=function(){if(!this.loader){this.loader=new BX.Loader({size:150})}return this.loader};BX.DocumentGenerator.UploadTemplate.startProgress=function(){if(!this.getLoader().isShown()){this.getLoader().show(BX(BX.DocumentGenerator.UploadTemplate.nameBlockNode).parentNode)}BX(this.saveButton).disabled=true;this.progress=true};BX.DocumentGenerator.UploadTemplate.stopProgress=function(){this.getLoader().hide();BX(this.saveButton).disabled=false;this.progress=false};BX.DocumentGenerator.UploadTemplate.reloadRegions=function(){BX.DocumentGenerator.UploadTemplate.startProgress();BX.ajax.runAction("documentgenerator.region.list").then(function(e){BX.DocumentGenerator.UploadTemplate.stopProgress();var t,o=[],a,r;t=BX(BX.DocumentGenerator.UploadTemplate.regionSelectorId).value;if(BX.type.isNotEmptyObject(e.data.regions)){BX.DocumentGenerator.UploadTemplate.regions=e.data.regions;var n=[];var l=[];for(a in e.data.regions){if(e.data.regions.hasOwnProperty(a)){if(parseInt(a)>0){l.push(e.data.regions[a])}else{n.push(e.data.regions[a])}}}for(r=0;r<n.length;r++){o.push(n[r])}for(r=0;r<l.length;r++){o.push(l[r])}}BX.cleanNode(BX(BX.DocumentGenerator.UploadTemplate.regionSelectorId),false);for(r=0;r<o.length;r++){var i={value:o[r]["code"]};if(t===o[r]["code"]){i["selected"]="selected"}BX(BX.DocumentGenerator.UploadTemplate.regionSelectorId).appendChild(BX.create("option",{attrs:i,text:o[r]["title"]}))}},function(e){BX.DocumentGenerator.UploadTemplate.stopProgress();BX.DocumentGenerator.UploadTemplate.showUploadError(e.errors.pop().message)})}})(window);
//# sourceMappingURL=script.map.js