(function(){BX.namespace("BX.DocumentGenerator");BX.DocumentGenerator.Perms={main:null,accessTable:null,accessTableBody:null,accessTableLastRow:null,rolesTableBody:null,rolesTableLastRow:null,isPermissionsFeatureEnabled:true};BX.DocumentGenerator.Perms.init=function(e,t){if(t.isPermissionsFeatureEnabled===false){this.isPermissionsFeatureEnabled=t.isPermissionsFeatureEnabled}this.main=e;this.accessTable=this.main.querySelector("table.docgen-role-access-table");this.accessTableBody=this.accessTable.querySelector("tbody");this.accessTableLastRow=this.main.querySelector("tr.docgen-access-table-last-row");this.rolesTableBody=this.main.querySelector("table.docgen-roles-table tbody");this.rolesTableLastRow=this.main.querySelector("tr.docgen-roles-table-last-row");BX.Access.Init({other:{disabled:true}});BX.bindDelegate(this.main,"click",{className:"docgen-delete-role"},BX.proxy(this.onDeleteRole,this));BX.bindDelegate(this.main,"click",{className:"docgen-delete-access"},BX.proxy(this.onDeleteAccess,this));BX.bindDelegate(this.main,"click",{className:"docgen-add-access"},BX.proxy(this.onAddAccess,this));BX.bindDelegate(this.main,"change",{className:"docgen-select-role"},BX.proxy(this.onSelectRole,this));BX.bindDelegate(this.main,"click",{className:"docgen-edit-role"},BX.proxy(this.onEditRole,this));BX.addCustomEvent("SidePanel.Slider:onMessage",BX.proxy(function(e){if(e.getEventId()==="documentgenerator-add-role"){var t=e.getData();var o=t.role;if(BX.type.isNotEmptyObject(o)){var r=BX("docgen-new-role-row").innerHTML;r=this.replaceTemplateData(r,{ID:parseInt(o.id),NAME:BX.Text.encode(o.name),EDIT_URL:this.getEditRoleUrl(o.id)});var a=BX.create("tr",{html:r});a.dataset.roleId=o.id;this.rolesTableBody.insertBefore(a,this.rolesTableLastRow);BX.DocumentGenerator.Perms.updateRoleFields()}}},this))};BX.DocumentGenerator.Perms.onDeleteRole=function(e){e.preventDefault();e.stopPropagation();var t=e.target;var o=t.dataset.roleId;var r=document.querySelectorAll('*[data-role-id="'+o+'"]');this.confirm(BX.message("DOCGEN_SETTINGS_PERMS_ROLE_DELETE"),BX.message("DOCGEN_SETTINGS_PERMS_ROLE_DELETE_CONFIRM"),function(e){if(!e.confirmed)return;if(!BX.DocumentGenerator.Perms.isPermissionsFeatureEnabled){BX.DocumentGenerator.Perms.showPermissionsFeaturePopup();return}var t="docgenDeleteRole";var a="documentgenerator.api.role.delete";BX.showWait();BX.ajax.runAction(a,{analyticsLabel:t,data:{id:o}}).then(function(){BX.closeWait();for(var e=0;e<r.length;e++){BX.remove(r[e])}},function(e){BX.closeWait();BX.DocumentGenerator.Perms.showError(e.errors.pop().message)})})};BX.DocumentGenerator.Perms.onDeleteAccess=function(e){e.preventDefault();e.stopPropagation();var t=e.target;var o=t.dataset.accessCode;var r=this.accessTable.querySelectorAll('tr[data-access-code="'+o+'"]');for(var a=0;a<r.length;a++){BX.remove(r[a])}};BX.DocumentGenerator.Perms.onAddAccess=function(e){var t={};var o=this.accessTable.rows.length;for(var r=0;r<o;r++){if(this.accessTable.rows[r].dataset.accessCode){t[this.accessTable.rows[r].dataset.accessCode]=true}}BX.Access.SetSelected(t,"documentgeneratorPerms");BX.Access.ShowForm({bind:"documentgeneratorPerms",callback:function(e){var t;var o;for(var r in e){for(var a in e[r]){t=BX.Access.GetProviderName(e[r][a].provider);o=e[r][a].name;BX.DocumentGenerator.Perms.renderNewAccessCode(a,t,o,1)}}}})};BX.DocumentGenerator.Perms.renderNewAccessCode=function(e,t,o,r){e=BX.Text.encode(e);t=BX.Text.encode(t);o=BX.Text.encode(o);r=parseInt(e);var a=BX("docgen-new-access-row").innerHTML;a=this.replaceTemplateData(a,{PROVIDER:t,NAME:o,ACCESS_CODE:e});var n=BX.create("tr",{html:a});n.dataset.roleId=r;n.dataset.accessCode=e;BX.DocumentGenerator.Perms.updateRoleSelect(n.querySelector("select"),BX.DocumentGenerator.Perms.getRoles());n.querySelector("select").value=r;this.accessTableBody.insertBefore(n,this.accessTableLastRow)};BX.DocumentGenerator.Perms.onSelectRole=function(e){var t=e.target;var o=t.value;var r=t.dataset.accessCode;var a=this.main.querySelector("tr[data-access-code="+r+"]");if(a){a.dataset.roleId=o}};BX.DocumentGenerator.Perms.confirm=function(e,t,o){var r={confirmed:false};var a=this.main.id+"-confirm-popup";var n=new BX.PopupWindow(a,null,{content:t,titleBar:e,closeByEsc:true,buttons:[new BX.PopupWindowButton({text:BX.message("DOCGEN_SETTINGS_PERMS_ROLE_OK"),className:"popup-window-button-accept",events:{click:function(){n.close();r.confirmed=true;if(BX.type.isFunction(o)){o(r)}}}}),new BX.PopupWindowButtonLink({text:BX.message("DOCGEN_SETTINGS_PERMS_ROLE_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){n.close();r.confirmed=false;if(BX.type.isFunction(o)){o(r)}}}})]});n.show()};BX.DocumentGenerator.Perms.onEditRole=function(e){e.preventDefault();e.stopPropagation();if(BX.SidePanel){BX.SidePanel.Instance.open(e.target.href,{width:780,cacheable:false})}else{location.href=e.target.href}};BX.DocumentGenerator.Perms.save=function(){if(!BX.DocumentGenerator.Perms.isPermissionsFeatureEnabled){BX.DocumentGenerator.Perms.showPermissionsFeaturePopup();BX("ui-button-panel-save").disabled=false;setTimeout(function(){BX.removeClass(BX("ui-button-panel-save"),"ui-btn-wait");BX.removeClass(BX("ui-button-panel-close"),"ui-btn-wait")},100);return}var e=[];var t=this.accessTable.querySelectorAll("tr");var o=t.length;for(var r=1;r<o-1;r++){e.push({accessCode:t[r].dataset.accessCode,roleId:t[r].dataset.roleId})}BX.ajax.runAction("documentgenerator.api.role.fillAccesses",{analyticsLabel:"docgenFillAccesses",data:{accesses:e}}).then(function(){BX.DocumentGenerator.Perms.close()},function(e){BX.DocumentGenerator.Perms.showError(e.errors.pop().message);BX("ui-button-panel-save").disabled=false;setTimeout(function(){BX.removeClass(BX("ui-button-panel-save"),"ui-btn-wait");BX.removeClass(BX("ui-button-panel-close"),"ui-btn-wait")},100)})};BX.DocumentGenerator.Perms.close=function(){BX.fireEvent(BX("ui-button-panel-close"),"click");BX.removeClass(BX("ui-button-panel-save"),"ui-btn-wait");BX.removeClass(BX("ui-button-panel-close"),"ui-btn-wait")};BX.DocumentGenerator.Perms.showError=function(e){var t=new BX.UI.Alert({color:BX.UI.Alert.Color.DANGER,icon:BX.UI.Alert.Icon.DANGER,text:e});BX.adjust(BX("perms-alert-container"),{html:""});BX.append(t.getContainer(),BX("perms-alert-container"))};BX.DocumentGenerator.Perms.replaceTemplateData=function(e,t){if(!BX.type.isPlainObject(t))return e;return e.replace(/#(\w+?)#/g,function(e,o){if(t.hasOwnProperty(o))return t[o];else return e})};BX.DocumentGenerator.Perms.getEditRoleUrl=function(e){var t=this.rolesTableBody.querySelector(".docgen-edit-role a").href;return BX.util.add_url_param(t,{roleId:e})};BX.DocumentGenerator.Perms.showPermissionsFeaturePopup=function(){top.BX.UI.InfoHelper.show("limit_crm_document_access_permissions")};BX.DocumentGenerator.Perms.getRoles=function(){var e={};var t=this.rolesTableBody.querySelectorAll("tr");for(var o=1,r=t.length-1;o<r;o++){e[t[o].dataset.roleId]=t[o].children[0].innerText}return e};BX.DocumentGenerator.Perms.updateRoleFields=function(){var e=BX.DocumentGenerator.Perms.getRoles();var t=this.accessTableBody.querySelectorAll(".docgen-select-role");for(var o=0,r=t.length;o<r;o++){BX.DocumentGenerator.Perms.updateRoleSelect(t[o],e)}};BX.DocumentGenerator.Perms.updateRoleSelect=function(e,t){var o={};var r=e.children;var a;for(var n=0,s=r.length;n<s;n++){a=r[n].dataset.roleId;if(!t[a]){BX.remove(r[n])}else{o[a]=r[n].innerText}}var i;for(a in t){if(t.hasOwnProperty(a)&&!o.hasOwnProperty(a)){i=BX.create("option",{attrs:{title:t[a],value:a,"data-role-id":a},text:t[a]});e.appendChild(i)}}};BX.DocumentGenerator.Role={isPermissionsFeatureEnabled:true};BX.DocumentGenerator.Role.init=function(e){if(e.isPermissionsFeatureEnabled===false){this.isPermissionsFeatureEnabled=e.isPermissionsFeatureEnabled}};BX.DocumentGenerator.Role.save=function(){if(!BX.DocumentGenerator.Role.isPermissionsFeatureEnabled){BX.DocumentGenerator.Perms.showPermissionsFeaturePopup();BX("ui-button-panel-save").disabled=false;setTimeout(function(){BX.removeClass(BX("ui-button-panel-save"),"ui-btn-wait");BX.removeClass(BX("ui-button-panel-close"),"ui-btn-wait")},100);return}var e=BX("docs-role").querySelector("form");var t={fields:{permissions:{}}},o,r=e.length,a,n;for(o=0;o<r;o++){if(e.elements[o].name==="id"){t.id=e.elements[o].value}else if(e.elements[o].name.indexOf("permissions")===0){if(!t.fields.permissions[e.elements[o].dataset.entity]){t.fields.permissions[e.elements[o].dataset.entity]={}}t.fields.permissions[e.elements[o].dataset.entity][e.elements[o].dataset.action]=e.elements[o].value}else{t.fields[e.elements[o].name]=e.elements[o].value}}if(t.id>0){a="documentgenerator.api.role.update";n="docgenAddRole"}else{a="documentgenerator.api.role.add";n="docgenUpdateRole"}BX.ajax.runAction(a,{analyticsLabel:n,data:t}).then(function(e){if(BX.SidePanel&&a==="documentgenerator.api.role.add"){var t=BX.SidePanel.Instance.getTopSlider();if(t){BX.SidePanel.Instance.postMessage(t,"documentgenerator-add-role",{role:e.data.role})}}BX.DocumentGenerator.Role.close()},function(e){BX.DocumentGenerator.Role.showError(e.errors.pop().message);BX("ui-button-panel-save").disabled=false;setTimeout(function(){BX.removeClass(BX("ui-button-panel-save"),"ui-btn-wait");BX.removeClass(BX("ui-button-panel-close"),"ui-btn-wait")},100)})};BX.DocumentGenerator.Role.close=function(){BX.fireEvent(BX("ui-button-panel-close"),"click");BX.removeClass(BX("ui-button-panel-save"),"ui-btn-wait");BX.removeClass(BX("ui-button-panel-close"),"ui-btn-wait")};BX.DocumentGenerator.Role.showError=function(e){var t=new BX.UI.Alert({color:BX.UI.Alert.Color.DANGER,icon:BX.UI.Alert.Icon.DANGER,text:e});BX.adjust(BX("role-alert-container"),{html:""});BX.append(t.getContainer(),BX("role-alert-container"))}})(window);
//# sourceMappingURL=script.map.js