(function(e){if(!!e.BX.OpenLinesConfigEdit)return;var t=null;e.BX.OpenLinesConfigEdit={init:function(){BX.imolTrialHandler.init();BX.OpenLinesConfigEdit.addEventForTooltip();BX.OpenLinesConfigEdit.bindEvents();BX.OpenLinesConfigEdit.onLoad()},initDestination:function(e,n,a){if(t===null)t=new i(a);t.setInput(BX(e.destInputNode),n.destInputName);t.setUserDataInput(BX(e.userDataInputNode),n.userDataInputName);t.setDefaultUserDataInput(BX(e.defaultUserDataInputNode))},sendUsersData:function(){if(t!==null){var i=t.params.selectedForMessage;BX.SidePanel.Instance.postMessage(e,"ImOpenlines:reloadUsersList",i)}},addEventForTooltip:function(){BX.UI.Hint.init(BX("imopenlines-field-container"))},getUrlParam:function(t,i){if(t.charAt(0)==="/"){t=e.location.protocol+"//"+e.location.host+t}var n=new URL(t);var a=n.searchParams.get(i);return BX.util.htmlspecialchars(a)},getPageParam:function(e){return this.getUrlParam(e,"PAGE")},visualReload:function(e){var t=document.querySelectorAll("[data-imol-page]");for(var i=0;i<t.length;i++){if((t[i].dataset.imolPage===e||!t[i].classList.contains("invisible"))&&!(t[i].dataset.imolPage===e&&!t[i].classList.contains("invisible"))){BX.animationHandler.smoothShowHide(t[i]);if(t[i].dataset.imolPage===e){var n=BX(t[i]).querySelector("[data-imol-title]");var a=n.dataset.imolTitle.toString();if(BX("pagetitle")&&a!==""){BX("pagetitle").innerHTML=a}}}}},reloadHandler:function(e){e.preventDefault();var t=BX.proxy_context;var i=this.getPageParam(t.getAttribute("href").toString());this.changeHistoryPage(i);this.visualReload(i)},changeHistory:function(t){var i=BX("imol_config_edit_form").getAttribute("action");if(i.charAt(0)==="/"){i=e.location.protocol+"//"+e.location.host+i}var n=new URL(i);var a;for(var o in t){a=BX.util.htmlspecialchars(t[o]);n.searchParams.set(o,a)}var s=n.href;top.window.history.replaceState({},"",s);BX("imol_config_edit_form").setAttribute("action",s)},changeHistoryPage:function(e){var t={PAGE:e};this.changeHistory(t)},changeRatingRequest:function(e){var t={"rating-request":e};this.changeHistory(t)},botButtonAction:function(e){e.preventDefault();BX.rest.Marketplace.open({PLACEMENT:"OPENLINE_BOT"});top.BX.addCustomEvent(top,"Rest:AppLayout:ApplicationInstall",function(e,t){t.redirect=false;BX.OpenLinesConfigEdit.botAddHandler()})},botAddHandler:function(){e.location.reload()},actionClose:function(){BX.OpenLinesConfigEdit.toggleSelectFormOrText(BX("imol_action_close"),BX("imol_action_close_form"),BX("imol_action_close_text"))},actionAutoClose:function(){BX.OpenLinesConfigEdit.toggleSelectFormOrText(BX("imol_action_auto_close"),BX("imol_action_auto_close_form"),BX("imol_action_auto_close_text"))},changeNoAnswerValue:function(e){var t=BX("imol_no_answer_rule_hidden");if(!!t){if(t.value=="queue"&&e.options[e.selectedIndex].value!="evenly"){t.value="text"}}if(e.options[e.selectedIndex].value=="all"){BX.animationHandler.fadeSlideToggleByClass(BX("imol_limitation_max_chat_block"),false);BX("imol_queue_time_title").innerHTML=BX.message("IMOL_CONFIG_EDIT_NA_TIME_NEW")}else if(BX("imol_queue_time_title").innerHTML!=BX.message("IMOL_CONFIG_EDIT_QUEUE_TIME")){BX.animationHandler.fadeSlideToggleByClass(BX("imol_limitation_max_chat_block"),true);BX("imol_queue_time_title").innerHTML=BX.message("IMOL_CONFIG_EDIT_QUEUE_TIME")}},toggleCrmBlock:function(){BX.animationHandler.fadeSlideToggleByClass(BX("imol_crm_block"))},toggleCheckOnlineBlock:function(){BX.animationHandler.fadeSlideToggleByClass(BX("imol_check_online_block"))},toggleCrmSourceRule:function(){var e=BX("imol_crm_create");if(e.options[e.selectedIndex].value!="none"){BX.animationHandler.fadeSlideToggleByClass(BX("imol_crm_source_rule"),true)}else{BX.animationHandler.fadeSlideToggleByClass(BX("imol_crm_source_rule"),false)}},toggleQueueSettingsBlock:function(e){e.preventDefault();BX.animationHandler.fadeSlideToggleByClass(BX("imol_queue_settings_block"))},toggleAutoMessageBlock:function(){BX.animationHandler.fadeSlideToggleByClass(BX("imol_action_welcome"))},toggleAgreementBlock:function(){BX.animationHandler.fadeSlideToggleByClass(BX("imol_agreement_message_block"))},toggleVoteBlock:function(){BX.animationHandler.fadeSlideToggleByClass(BX("imol_vote_message_block"));var e=BX(this).checked===true?"Y":"N";BX.OpenLinesConfigEdit.changeRatingRequest(e)},toggleBotBlock:function(){BX.animationHandler.fadeSlideToggleByClass(BX("imol_welcome_bot_block"))},toggleQueueUsersBlock:function(){BX.OpenLinesConfigEdit.toggleSelectOperatorData(BX("imol_operator_data"),BX("users_for_queue_data"),BX("default_user_data"))},toggleWorkersTimeBlock:function(e){BX.animationHandler.fadeSlideToggleByClass(BX("imol_workers_time_block"))},toggleWorktimeBlock:function(){BX.animationHandler.fadeSlideToggleByClass(BX("imol_worktime_block"))},toggleNoAnswerRule:function(){BX.OpenLinesConfigEdit.toggleSelectFormText(BX("imol_no_answer_rule"),BX("imol_no_answer_rule_form_form"),BX("imol_no_answer_rule_text"))},toggleQueueMaxChat:function(){BX.animationHandler.fadeSlideToggleByClass(BX("imol_max_chat"))},toggleWorktimeDayoffRule:function(){BX.OpenLinesConfigEdit.toggleSelectFormText(BX("imol_worktime_dayoff_rule"),BX("imol_worktime_dayoff_rule_form"),BX("imol_worktime_dayoff_rule_text"))},toggleSelectFormText:function(e,t,i){if(!!e){if(e.options[e.selectedIndex].value=="form"){BX.animationHandler.fadeSlideToggleByClass(t,true);BX.animationHandler.fadeSlideToggleByClass(i,true)}else if(e.options[e.selectedIndex].value=="text"){BX.animationHandler.fadeSlideToggleByClass(t,false);BX.animationHandler.fadeSlideToggleByClass(i,true)}else{BX.animationHandler.fadeSlideToggleByClass(t,false);BX.animationHandler.fadeSlideToggleByClass(i,false)}}},toggleSelectFormOrText:function(e,t,i){if(!!e){if(e.options[e.selectedIndex].value=="form"){BX.animationHandler.fadeSlideToggleByClass(t,true);BX.animationHandler.fadeSlideToggleByClass(i,false)}else if(e.options[e.selectedIndex].value=="text"||e.options[e.selectedIndex].value=="quality"){BX.animationHandler.fadeSlideToggleByClass(t,false);BX.animationHandler.fadeSlideToggleByClass(i,true)}else{BX.animationHandler.fadeSlideToggleByClass(t,false);BX.animationHandler.fadeSlideToggleByClass(i,false)}}},toggleSelectOperatorData:function(e,t,i){if(e.options[e.selectedIndex].value=="queue"){BX.animationHandler.fadeSlideToggleByClass(t,true);BX.animationHandler.fadeSlideToggleByClass(i,false)}else if(e.options[e.selectedIndex].value=="hide"){BX.animationHandler.fadeSlideToggleByClass(i,true);BX.animationHandler.fadeSlideToggleByClass(t,false)}else{BX.animationHandler.fadeSlideToggleByClass(i,false);BX.animationHandler.fadeSlideToggleByClass(t,false)}},toggleExtraContainer:function(){BX.toggleClass(BX("imol_extra_btn"),["imopenlines-extra-btn-container-active",""]);BX.toggleClass(BX("imol_extra_container"),["ui-form-border-bottom",""]);BX.animationHandler.fadeSlideToggleByClass(BX("imol_setting_container"));var e=BX.hasClass(BX("imol_extra_btn"),"imopenlines-extra-btn-container-active")?"Y":"N";BX("imol_config_opened").setAttribute("value",e)},toggleBoolInputValue:function(e){e.value=e.value==="Y"?"N":"Y"},openQuickAnswers:function(t){var i=t.dataset.url;i.toString();if(i!=""){e.open(i,"_blank")}},bindEvents:function(){BX.bind(BX("imol_config_edit_form"),"submit",BX.OpenLinesConfigEdit.sendUsersData);BX.bind(BX("imol_crm_create"),"change",BX.OpenLinesConfigEdit.toggleCrmSourceRule);BX.bind(BX("imol_extra_btn"),"click",BX.OpenLinesConfigEdit.toggleExtraContainer);BX.bind(BX("imol_no_answer_rule"),"change",BX.OpenLinesConfigEdit.toggleNoAnswerRule);BX.bind(BX("imol_worktime_dayoff_rule"),"change",BX.OpenLinesConfigEdit.toggleWorktimeDayoffRule);BX.bind(BX("imol_queue_settings_link"),"click",BX.OpenLinesConfigEdit.toggleQueueSettingsBlock);BX.bind(BX("imol_workers_time_link"),"click",BX.OpenLinesConfigEdit.toggleWorkersTimeBlock);BX.bind(BX("imol_agreement_message"),"change",BX.OpenLinesConfigEdit.toggleAgreementBlock);BX.bind(BX("imol_vote_message"),"change",BX.OpenLinesConfigEdit.toggleVoteBlock);BX.bind(BX("imol_crm_checkbox"),"change",BX.OpenLinesConfigEdit.toggleCrmBlock);BX.bind(BX("imol_operator_data"),"change",BX.OpenLinesConfigEdit.toggleQueueUsersBlock);BX.bind(BX("imol_check_online"),"change",BX.OpenLinesConfigEdit.toggleCheckOnlineBlock);BX.bind(BX("imol_welcome_message"),"change",BX.OpenLinesConfigEdit.toggleAutoMessageBlock);BX.bind(BX("imol_worktime_checkbox"),"change",BX.OpenLinesConfigEdit.toggleWorktimeBlock);BX.bind(BX("imol_action_close"),"change",BX.OpenLinesConfigEdit.actionClose);BX.bind(BX("imol_action_auto_close"),"change",BX.OpenLinesConfigEdit.actionAutoClose);BX.bind(BX("imol_queue_type"),"change",function(e){BX.OpenLinesConfigEdit.changeNoAnswerValue(this)});BX.bind(BX("imol_limitation_max_chat"),"change",BX.OpenLinesConfigEdit.toggleQueueMaxChat);BX.bind(BX("imol_quick_answer_manage"),"click",function(e){e.preventDefault();BX.OpenLinesConfigEdit.openQuickAnswers(this)});BX.bindDelegate(document.body,"click",{className:"ui-sidepanel-menu-link"},BX.proxy(this.reloadHandler,this))},onLoad:function(){BX.OpenLinesConfigEdit.toggleNoAnswerRule();BX.OpenLinesConfigEdit.actionClose();BX.OpenLinesConfigEdit.actionAutoClose();BX.OpenLinesConfigEdit.toggleWorktimeDayoffRule()}};e.BX.imolTrialHandler={openPopup:function(e,t){if(typeof B24!="undefined"&&typeof B24.licenseInfoPopup!="undefined"){B24.licenseInfoPopup.show(e,BX.message("IMOL_CONFIG_EDIT_POPUP_LIMITED_TITLE"),t)}else{alert(t)}},openPopupQueueAll:function(){BX.imolTrialHandler.openPopup("imol_queue_all",BX.message("IMOL_CONFIG_EDIT_POPUP_LIMITED_QUEUE_ALL_NEW"))},openPopupQueueVote:function(){BX.imolTrialHandler.openPopup("imol_vote",BX.message("IMOL_CONFIG_EDIT_POPUP_LIMITED_VOTE"))},init:function(){BX.bind(BX("imol_queue_all"),"click",BX.imolTrialHandler.openPopupQueueAll);BX.bind(BX("imol_vote"),"click",BX.imolTrialHandler.openPopupQueueVote)}};e.BX.animationHandler={animations:[],animate:function(e){e=e||{};var t=e.node||null;var i=new BX.Promise;e.transition=e.transition||BX.easing.transitions.linear;if(!BX.type.isElementNode(t)){i.reject();return i}var n=e.duration||300;var a=null;for(var o in BX.animationHandler.animations){if(BX.animationHandler.animations[o].node==t){a=BX.animationHandler.animations[o];break}}if(a===null){var s=new BX.easing({duration:n,start:e.start,finish:e.finish,transition:e.transition,step:e.step,complete:function(){for(var n in BX.animationHandler.animations){if(BX.animationHandler.animations[n].node==t){BX.animationHandler.animations[n].easing=null;BX.animationHandler.animations[n].node=null;BX.animationHandler.animations.splice(n,1);break}}t=null;a=null;e.complete.call(this);if(i){i.fulfill()}}});a={node:t,easing:s};a.easing.animate();BX.animationHandler.animations.push(a)}else{a.easing.stop(true);e.duplicate.call(this);if(i){i.reject()}}return i},animateShowHide:function(e){e=e||{};var t=e.node||null;e.transition=e.transition||BX.easing.transitions.linear;if(!BX.type.isElementNode(t)){var i=new BX.Promise;i.reject();return i}var n=BX.hasClass(t,"invisible");var a=typeof e.way=="undefined"||e.way===null?n:!!e.way;if(n!=a){var i=new BX.Promise;i.resolve();return i}var o=e.toShow||{};var s=e.toHide||{};return BX.animationHandler.animate({node:t,duration:e.duration,start:!a?o:s,finish:a?o:s,transition:e.transition,complete:function(){BX[!a?"addClass":"removeClass"](t,"invisible");t.style.cssText="";if(BX.type.isFunction(e.complete)){e.complete.call(this)}},duplicate:function(){BX[a?"addClass":"removeClass"](t,"invisible");t.style.cssText="";if(BX.type.isFunction(e.duplicate)){e.duplicate.call(this)}},step:function(e){if(typeof e.opacity!="undefined"){t.style.opacity=e.opacity/100}if(typeof e.height!="undefined"){t.style.height=e.height+"px"}if(typeof e.width!="undefined"){t.style.width=e.width+"px"}}})},fadeSlideToggleByClass:function(e,t,i,n){return BX.animationHandler.animateShowHide({node:e,duration:i,toShow:{opacity:100,height:BX.animationHandler.getInvisibleSize(e).height},toHide:{opacity:0,height:0},complete:n,way:t})},getInvisibleSize:function(e){var t=BX.hasClass(e,"invisible");if(t){BX.removeClass(e,"invisible")}var i=BX.pos(e);if(t){BX.addClass(e,"invisible")}return i},smoothScroll:function(e){var t=BX.GetWindowScrollPos().scrollTop,i=BX.pos(e).top-Math.round(BX.GetWindowInnerSize().innerHeight/2),n=t<i,a=Math.abs(i-t),o=Math.round(a/100)>20?20:Math.round(a/100),s=4*o,r=n?t+s:t-s,l=0;if(n){for(var d=t;d<i;d+=s){setTimeout("window.scrollTo(0,"+r+")",l*o);r+=s;if(r>i){r=i}l++}}else{for(var d=t;d>i;d-=s){setTimeout("window.scrollTo(0,"+r+")",l*o);r-=s;if(r<i){r=i}l++}}},smoothShowHide:function(e){if(!e.classList.contains("imopenlines-page-show")){setTimeout(function(){BX.removeClass(e,"invisible")},100);BX.animationHandler.smoothShow(e)}else{BX.animationHandler.smoothHide(e);BX.addClass(e,"invisible")}},smoothShow:function(e){BX.removeClass(e,"imopenlines-page-hide");BX.addClass(e,"imopenlines-page-show")},smoothHide:function(e){BX.removeClass(e,"imopenlines-page-show");BX.addClass(e,"imopenlines-page-hide")}};var i=function(e,t){this.p=!!e.queue?e.queue:{};if(!!e.queue["SELECTED"]){var i={},n,a;for(n in e.queue["SELECTED"]){if(e.queue["SELECTED"].hasOwnProperty(n)&&typeof e.queue["SELECTED"][n]=="object"){for(a in e.queue["SELECTED"][n]){if(e.queue["SELECTED"][n].hasOwnProperty(a)){if(n=="USERS")i["U"+e.queue["SELECTED"][n][a]]="users";else if(n=="SG")i["SG"+e.queue["SELECTED"][n][a]]="sonetgroups";else if(n=="DR")i["DR"+e.queue["SELECTED"][n][a]]="department"}}}}this.p["SELECTED"]=i}this.id=this.p["LINE_ID"];this.nodes={};this.defaultOperator=e.defaultOperator||{};this.nodesType={destInput:[],userDataInput:[],defaultUserDataInput:""};this.ajaxUrl="/bitrix/components/bitrix/imopenlines.lines.edit/ajax.php";var o=function(e,t){var i={},n,a,s;if(t[e]){for(s in t[e]){if(t[e].hasOwnProperty(s)){n=t[e][s];a=[];if(t[n]&&t[n].length>0)a=o(n,t);i[n]={id:n,type:"category",items:a}}}}return i},s=function(e){var t={},i;for(var n in e){if(e.hasOwnProperty(n)){i=e[n]["parent"];if(!t[i])t[i]=[];t[i][t[i].length]=n}}return o("DR0",t)};if(true||t=="users"){this.params={name:null,searchInput:null,extranetUser:this.p["EXTRANET_USER"]=="Y",bindMainPopup:{node:null,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:null,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:true,callback:{select:BX.delegate(this.select,this),unSelect:BX.delegate(this.unSelect,this),openDialog:BX.delegate(this.openDialog,this),closeDialog:BX.delegate(this.closeDialog,this),openSearch:BX.delegate(this.openDialog,this),closeSearch:BX.delegate(this.closeSearch,this)},items:{users:!!this.p["USERS"]?this.p["USERS"]:{},groups:{},sonetgroups:{},department:!!this.p["DEPARTMENT"]?this.p["DEPARTMENT"]:{},departmentRelation:!!this.p["DEPARTMENT"]?s(this.p["DEPARTMENT"]):{},contacts:{},companies:{},leads:{},deals:{}},itemsLast:{users:!!this.p["LAST"]&&!!this.p["LAST"]["USERS"]?this.p["LAST"]["USERS"]:{},sonetgroups:{},department:{},groups:{},contacts:{},companies:{},leads:{},deals:{},crm:[]},queueItems:!!this.p["QUEUE_USERS_FIELDS"]?BX.clone(this.p["QUEUE_USERS_FIELDS"]):{},itemsSelected:!!this.p["SELECTED"]?BX.clone(this.p["SELECTED"]):{},isCrmFeed:false,destSort:!!this.p["DEST_SORT"]?BX.clone(this.p["DEST_SORT"]):{}};this.params.selectedForMessage=BX.clone(this.params.itemsSelected)}};i.prototype={setInput:function(e,t){e=BX(e);if(!!e&&!e.hasAttribute("bx-destination-id")){var i="destination"+(""+(new Date).getTime()).substr(6),a;e.setAttribute("bx-destination-id",i);a=new n(i,e,t);this.nodes[i]=e;this.nodesType.destInput.push(i);BX.defer_proxy(function(){params=this.params;params.name=a.id;params.searchInput=a.nodes.input;params.bindMainPopup.node=a.nodes.container;params.bindSearchPopup.node=a.nodes.container;BX.SocNetLogDestination.init(params)},this)()}},setUserDataInput:function(e,t){e=BX(e);if(!!e&&!e.hasAttribute("bx-destination-id")){var i="data-destination"+(""+(new Date).getTime()).substr(6),n;e.setAttribute("bx-destination-id",i);n=new a(i,e,t);this.nodes[i]=e;this.nodesType.userDataInput.push(i);BX.defer_proxy(function(){params=this.params;params.name=n.id;params.searchInput=n.nodes.input;params.bindMainPopup.node=n.nodes.container;params.bindSearchPopup.node=n.nodes.container;BX.SocNetLogDestination.init(params)},this)()}},setDefaultUserDataInput:function(e){e=BX(e);if(!!e){var t=this.createDefaultUserDataInputNode(this.defaultOperator);var i=BX.findChild(t,{attr:{id:"button-avatar-user-default-user"}},true);var n=BX.findChild(t,{attr:{id:"input-avatar-user-default-user"}},true);var a=BX.findChild(t,{attr:{id:"input-avatar-file-id-user-default-user"}},true);if(!!i&&!!n){var o=function(){this.currentAvatarNode=i;this.currentAvatarInputNode=n;this.currentAvatarFileIdInputNode=a;this.showAvatarPopup()};BX.bind(i,"click",BX.delegate(o,this))}e.appendChild(t)}},showAvatarPopup:function(){if(!this.avatarPopup){var e=BX("imol_user_data_avatar_upload");this.avatarEditor=new o({caller:this,context:e});BX.addCustomEvent(this.avatarEditor,"onClose",BX.delegate(this.showAvatarPopup,this));BX.addCustomEvent(this.avatarEditor,"onSelect",BX.delegate(this.onSelectAvatar,this));this.avatarPopup=BX.PopupWindowManager.create("imol_user_edit_avatar",null,{autoHide:true,lightShadow:true,overlay:true,closeIcon:true,closeByEsc:true,angle:true,content:e})}this.avatarEditor.markCurrentAvatar(this.currentAvatarInputNode.value);this.avatarPopup.setBindElement(this.currentAvatarNode);this.avatarPopup.show()},onSelectAvatar:function(e,t){if(e){this.currentAvatarNode.style["background-image"]="url("+e+")";this.currentAvatarInputNode.value=e;this.currentAvatarFileIdInputNode.value=t}this.avatarPopup.close()},select:function(t,i,n,a,o){var s=i,r="S";if(i=="groups"){s="all-users"}else if(BX.util.in_array(i,["contacts","companies","leads","deals"])){s="crm"}if(i=="sonetgroups"){r="SG"}else if(i=="groups"){r="UA"}else if(i=="users"){r="U"}else if(i=="department"){r="DR"}else if(i=="contacts"){r="CRMCONTACT"}else if(i=="companies"){r="CRMCOMPANY"}else if(i=="leads"){r="CRMLEAD"}else if(i=="deals"){r="CRMDEAL"}var l=a?" bx-destination-undelete":"";l+=i=="sonetgroups"&&typeof e["arExtranetGroupID"]!="undefined"&&BX.util.in_array(t.entityId,e["arExtranetGroupID"])?" bx-destination-extranet":"";var d=s+l;var u={item:t,type:i,bUndeleted:a,classPostfix:d,prefix:r};var c=!!this.params.queueItems[u.item.id]?this.params.queueItems[u.item.id]:{};this.params.selectedForMessage[u.item.id]=u.item;this.selectDestInputNodes(u);this.selectUserDataInputNodes(u,c)},createDestInputNode:function(e){var t=BX("dest_input_template").innerHTML;var i=t.replace(new RegExp("%data_id%","g"),e.item.id).replace(new RegExp("%user_name_default%","g"),e.item.name).replace(new RegExp("%dest_input_container_class%","g"),"bx-destination bx-destination-"+e.classPostfix);var n=BX.create("DIV");n.innerHTML=i;n=n.children[0];if(!e.bUndeleted){n.appendChild(BX.create("span",{props:{className:"imopenlines-remove-btn"},events:{click:BX.delegate(function(t){this.deleteItem(e.item.id,e.type);BX.PreventDefault(t)},this),mouseover:function(){BX.addClass(this.parentNode,"bx-destination-hover")},mouseout:function(){BX.removeClass(this.parentNode,"bx-destination-hover")}}}))}return n},createUserDataInputNode:function(e,t){var i=!!t.USER_NAME?BX.util.htmlspecialchars(t.USER_NAME):e.item.name,n=!!t.USER_WORK_POSITION?BX.util.htmlspecialchars(t.USER_WORK_POSITION):"",a=!!t.USER_AVATAR?BX.util.htmlspecialchars(t.USER_AVATAR):e.item.avatar,o=!!t.USER_AVATAR_ID?BX.util.htmlspecialchars(t.USER_AVATAR_ID):null;var s=BX("user_data_input_template").innerHTML;var r=s.replace(new RegExp("%data_id%","g"),e.item.id).replace(new RegExp("%user_name_default%","g"),e.item.name).replace(new RegExp("%user_avatar_default%","g"),e.item.avatar.replace(/ /,"%20")).replace(new RegExp("%user_name%","g"),i).replace(new RegExp("%user_work_position%","g"),n).replace(new RegExp("%user_avatar%","g"),a).replace(new RegExp("%user_avatar_show%","g"),a.replace(/ /,"%20")).replace(new RegExp("%user_avatar_file_id%","g"),o).replace(new RegExp("%user_data_input_container_class%","g"),"imopenlines-form-settings-user").replace(new RegExp("background-image: url\\(\\)","g"),"");var l=BX.create("DIV");l.innerHTML=r;l=l.children[0];if(!e.bUndeleted){l.appendChild(BX.create("span",{props:{className:"imopenlines-form-settings-user-delete"},events:{click:BX.delegate(function(t){this.deleteItem(e.item.id,e.type);BX.PreventDefault(t)},this),mouseover:function(){BX.addClass(this.parentNode,"bx-destination-hover")},mouseout:function(){BX.removeClass(this.parentNode,"bx-destination-hover")}}}))}return l},createDefaultUserDataInputNode:function(e){var t=!!e.NAME?BX.util.htmlspecialchars(e.NAME):"",i=!!e.AVATAR?BX.util.htmlspecialchars(e.AVATAR):"",n=!!e.AVATAR_ID?BX.util.htmlspecialchars(e.AVATAR_ID):null;var a=BX("default_user_data_input_template").innerHTML;var o=a.replace(new RegExp("%user_name%","g"),t).replace(new RegExp("%user_avatar%","g"),i).replace(new RegExp("%user_avatar_show%","g"),i.replace(/ /,"%20")).replace(new RegExp("%user_avatar_file_id%","g"),n).replace(new RegExp("background-image: url\\(\\)","g"),"");var s=BX.create("DIV");s.innerHTML=o;s=s.children[0];return s},selectDestInputNodes:function(e){this.nodesType.destInput.forEach(BX.delegate(function(t){var i=this.createDestInputNode(e);BX.onCustomEvent(this.nodes[t],"select",[e.item,i,e.prefix])},this))},selectUserDataInputNodes:function(e,t){this.nodesType.userDataInput.forEach(BX.delegate(function(i){var n=this.createUserDataInputNode(e,t);BX.onCustomEvent(this.nodes[i],"select",[e.item,n,e.prefix])},this))},unSelect:function(e,t,i,n){delete this.params.selectedForMessage[e.id];this.nodesEvent("unSelect",[e])},deleteItem:function(e,t){for(var i in this.nodes){BX.SocNetLogDestination.deleteItem(e,t,i)}},openDialog:function(e){BX.onCustomEvent(this.nodes[e],"openDialog",[])},closeDialog:function(e){if(!BX.SocNetLogDestination.isOpenSearch()){BX.onCustomEvent(this.nodes[e],"closeDialog",[]);this.disableBackspace()}},closeSearch:function(e){if(!BX.SocNetLogDestination.isOpenSearch()){BX.onCustomEvent(this.nodes[e],"closeSearch",[]);this.disableBackspace()}},disableBackspace:function(){if(BX.SocNetLogDestination.backspaceDisable||BX.SocNetLogDestination.backspaceDisable!==null)BX.unbind(e,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.bind(e,"keydown",BX.SocNetLogDestination.backspaceDisable=function(e){if(e.keyCode==8){BX.PreventDefault(e);return false}return true});setTimeout(function(){BX.unbind(e,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.SocNetLogDestination.backspaceDisable=null},5e3)},nodesEvent:function(e,t){for(var i in this.nodes){BX.onCustomEvent(this.nodes[i],e,t)}},sendActionRequest:function(e,t,i,n){i=i||null;n=n||BX.proxy(this.showErrorPopup,this);t=t||{};if(t instanceof FormData){t.append("action",e);t.append("configId",this.id);t.append("sessid",BX.bitrix_sessid())}else{t.action=e;t.configId=this.id;t.sessid=BX.bitrix_sessid()}BX.ajax.runComponentAction("bitrix:imopenlines.lines.edit",e,{mode:"ajax",data:t}).then(BX.proxy(function(e){e=e||{};if(e.error){n.apply(this,[e])}else if(i){i.apply(this,[e])}},this)).then(BX.proxy(function(e){var t={error:true,text:e.error};n.apply(this,[t])},this))}};var n=function(e,t,i){this.node=t;this.id=e;this.inputName=i;this.node.appendChild(BX.create("SPAN",{props:{className:"bx-destination-wrap"},html:['<span id="',this.id,'-container"><span class="bx-destination-wrap-item"></span></span>','<span class="bx-destination-input-box" id="',this.id,'-input-box">','<input type="text" value="" class="bx-destination-input" id="',this.id,'-input">',"</span>",'<a href="#" class="bx-destination-add" id="',this.id,'-add-button"></a>'].join("")}));BX.defer_proxy(this.bind,this)()};n.prototype={bind:function(){this.nodes={inputBox:BX(this.id+"-input-box"),input:BX(this.id+"-input"),container:BX(this.id+"-container"),button:BX(this.id+"-add-button")};BX.bind(this.nodes.input,"keyup",BX.proxy(this.search,this));BX.bind(this.nodes.input,"keydown",BX.proxy(this.searchBefore,this));BX.bind(this.nodes.button,"click",BX.proxy(function(e){BX.SocNetLogDestination.openDialog(this.id,{bindNode:this.nodes.inputBox});BX.PreventDefault(e)},this));BX.bind(this.nodes.container,"click",BX.proxy(function(e){BX.SocNetLogDestination.openDialog(this.id,{bindNode:this.nodes.inputBox});BX.PreventDefault(e)},this));this.onChangeDestination();BX.addCustomEvent(this.node,"select",BX.proxy(this.select,this));BX.addCustomEvent(this.node,"unSelect",BX.proxy(this.unSelect,this));BX.addCustomEvent(this.node,"delete",BX.proxy(this.delete,this));BX.addCustomEvent(this.node,"openDialog",BX.proxy(this.openDialog,this));BX.addCustomEvent(this.node,"closeDialog",BX.proxy(this.closeDialog,this));BX.addCustomEvent(this.node,"closeSearch",BX.proxy(this.closeSearch,this))},select:function(e,t,i){if(BX.message("LM_BUSINESS_USERS_ON")=="Y"&&BX.message("LM_BUSINESS_USERS").split(",").indexOf(e.id)==-1){BX.SocNetLogDestination.closeDialog(this.id);BX.imolTrialHandler.openPopup("imol_queue",BX.message("LM_BUSINESS_USERS_TEXT"));return false}if(!BX.findChild(this.nodes.container,{attr:{"data-id":e.id}},false,false)){t.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"CONFIG["+this.inputName+"]"+"["+i+"][]",value:e.id}}));this.nodes.container.appendChild(t)}this.onChangeDestination()},unSelect:function(e){var t=BX.findChildren(this.nodes.container,{attribute:{"data-id":""+e.id+""}},true);if(t!==null){for(var i=0;i<t.length;i++)BX.remove(t[i])}this.onChangeDestination()},onChangeDestination:function(){var e=[];var t=BX.findChildrenByClassName(this.nodes.container,"bx-destination",false);for(var i=0;i<t.length;i++){e.push({id:t[i].getAttribute("data-id").substr(1),name:t[i].innerText})}BX.onCustomEvent("onChangeDestination",[e]);this.nodes.input.innerHTML="";this.nodes.button.innerHTML=BX.SocNetLogDestination.getSelectedCount(this.id)<=0?BX.message("LM_ADD1"):BX.message("LM_ADD2")},openDialog:function(){BX.style(this.nodes.inputBox,"display","inline-block");BX.style(this.nodes.button,"display","none");BX.focus(this.nodes.input)},closeDialog:function(){if(this.nodes.input.value.length<=0){BX.style(this.nodes.inputBox,"display","none");BX.style(this.nodes.button,"display","inline-block");this.nodes.input.value=""}},closeSearch:function(){if(this.nodes.input.value.length>0){BX.style(this.nodes.inputBox,"display","none");BX.style(this.nodes.button,"display","inline-block");this.nodes.input.value=""}},searchBefore:function(e){if(e.keyCode==8&&this.nodes.input.value.length<=0){BX.SocNetLogDestination.sendEvent=false;BX.SocNetLogDestination.deleteLastItem(this.id)}return true},search:function(e){if(e.keyCode==16||e.keyCode==17||e.keyCode==18||e.keyCode==20||e.keyCode==244||e.keyCode==224||e.keyCode==91)return false;if(e.keyCode==13){BX.SocNetLogDestination.selectFirstSearchItem(this.id);return true}if(e.keyCode==27){this.nodes.input.value="";BX.style(this.nodes.button,"display","inline")}else{BX.SocNetLogDestination.search(this.nodes.input.value,true,this.id,"",{bindNode:this.nodes.inputBox})}if(!BX.SocNetLogDestination.isOpenDialog()&&this.nodes.input.value.length<=0){BX.SocNetLogDestination.openDialog(this.id,{bindNode:this.nodes.inputBox})}else if(BX.SocNetLogDestination.sendEvent&&BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.closeDialog()}if(e.keyCode==8){BX.SocNetLogDestination.sendEvent=true}return true}};var a=function(e,i,n){this.node=i;this.id=e;this.inputName=n;this.caller=t;this.node.appendChild(BX.create("SPAN",{props:{id:this.id+"-container"}}));this.node.appendChild(BX.create("SPAN",{props:{className:"bx-destination-input-box",id:this.id+"-input-box"},html:['<input type="text" value="" class="bx-destination-input" id="'+this.id+'-input">']}));this.node.appendChild(BX.create("A",{props:{href:"#",className:"imopenlines-form-settings-user-link",id:this.id+"-add-button"}}));BX.defer_proxy(this.bind,this)()};a.prototype={bind:function(){this.nodes={inputBox:BX(this.id+"-input-box"),input:BX(this.id+"-input"),container:BX(this.id+"-container"),button:BX(this.id+"-add-button")};BX.bind(this.nodes.input,"keyup",BX.proxy(this.search,this));BX.bind(this.nodes.input,"keydown",BX.proxy(this.searchBefore,this));BX.bind(this.nodes.button,"click",BX.proxy(function(e){BX.SocNetLogDestination.openDialog(this.id,{bindNode:this.nodes.button});BX.PreventDefault(e)},this));this.onChangeDestination();BX.addCustomEvent(this.node,"select",BX.proxy(this.select,this));BX.addCustomEvent(this.node,"unSelect",BX.proxy(this.unSelect,this));BX.addCustomEvent(this.node,"delete",BX.proxy(this.delete,this));BX.addCustomEvent(this.node,"openDialog",BX.proxy(this.openDialog,this));BX.addCustomEvent(this.node,"closeDialog",BX.proxy(this.closeDialog,this));BX.addCustomEvent(this.node,"closeSearch",BX.proxy(this.closeSearch,this))},select:function(e,t,i){if(BX.message("LM_BUSINESS_USERS_ON")=="Y"&&BX.message("LM_BUSINESS_USERS").split(",").indexOf(e.id)==-1){BX.SocNetLogDestination.closeDialog(this.id);BX.imolTrialHandler.openPopup("imol_queue",BX.message("LM_BUSINESS_USERS_TEXT"));return false}if(!BX.findChild(this.nodes.container,{attr:{"data-id":e.id}},false,false)){var n=BX.findChildren(t,{className:"imopenlines-form-settings-user-input"},true);if(n!==null){var a;for(var o=0;o<n.length;o++){a="CONFIG["+this.inputName+"]"+"["+i+"]["+e.id+"]["+n[o].name+"]";n[o].setAttribute("name",a)}}var s=BX.findChild(t,{attr:{id:"button-avatar-user-"+e.id}},true);var r=BX.findChild(t,{attr:{id:"input-avatar-user-"+e.id}},true);var l=BX.findChild(t,{attr:{id:"input-avatar-file-id-user-"+e.id}},true);if(!!s&&!!r){var d=function(){this.currentAvatarNode=s;this.currentAvatarInputNode=r;this.currentAvatarFileIdInputNode=l;this.showAvatarPopup()};BX.bind(s,"click",BX.delegate(d,this))}this.nodes.container.appendChild(t)}this.onChangeDestination()},unSelect:function(e){var t=BX.findChildren(this.nodes.container,{attribute:{"data-id":""+e.id+""}},true);if(t!==null){for(var i=0;i<t.length;i++)BX.remove(t[i])}this.onChangeDestination()},onChangeDestination:function(){var e=[];var t=BX.findChildrenByClassName(this.nodes.container,"imopenlines-form-settings-user",false);for(var i=0;i<t.length;i++){e.push({id:t[i].getAttribute("data-id").substr(1),name:t[i].innerText})}BX.onCustomEvent("onChangeDestination",[e]);this.nodes.input.innerHTML="";this.nodes.button.innerHTML=BX.SocNetLogDestination.getSelectedCount(this.id)<=0?BX.message("LM_ADD1"):BX.message("LM_ADD2")},showAvatarPopup:function(){if(!this.avatarPopup){var e=BX("imol_user_data_avatar_upload");this.avatarEditor=new o({caller:this.caller,context:e});BX.addCustomEvent(this.avatarEditor,"onClose",BX.delegate(this.showAvatarPopup,this));BX.addCustomEvent(this.avatarEditor,"onSelect",BX.delegate(this.onSelectAvatar,this));this.avatarPopup=BX.PopupWindowManager.create("imol_user_edit_avatar",null,{autoHide:true,lightShadow:true,overlay:true,closeIcon:true,closeByEsc:true,angle:true,content:e})}this.avatarEditor.markCurrentAvatar(this.currentAvatarInputNode.value);this.avatarPopup.setBindElement(this.currentAvatarNode);this.avatarPopup.show()},onSelectAvatar:function(e,t){if(e){this.currentAvatarNode.style["background-image"]="url("+e+")";this.currentAvatarInputNode.value=e;this.currentAvatarFileIdInputNode.value=t}this.avatarPopup.close()}};var o=function(e){this.caller=e.caller;this.context=e.context;this.init()};o.prototype={init:function(){this.editButtonNode=this.context.querySelector("[data-imopenlines-user-photo-edit]");BX.bind(this.editButtonNode,"click",BX.delegate(this.show,this));this.avatarContainer=this.context.querySelector("[data-imopenlines-user-photo-edit-avatars]");this.attributeCarouselNext="dataimopenlines-user-photo-edit-avatar-next";this.attributeCarouselPrev="data-imopenlines-user-photo-edit-avatar-prev";this.attributeAvatar="data-imopenlines-user-photo-edit-avatar-item";this.attributeAvatarRemove="data-remove";this.attributeFileId="data-file-id";this.attributePath="data-path";this.attributeView="data-view";this.getAllAvatarNodes().forEach(this.initAvatar,this)},createAvatarNode:function(e,t){var i=BX("user_data_avatar_template");i=i.innerHTML;e=BX.util.htmlspecialchars(e);t=BX.util.htmlspecialchars(t);i=i.replace("%file_id%",e).replace("%path%",t).replace("%path%",t);var n=BX.create("DIV");n.innerHTML=i;n=n.children[0];return n},initAvatar:function(e){var t=e.querySelector("["+this.attributeView+"]");t=t||e;BX.bind(t,"click",BX.delegate(function(){this.selectAvatar(e)},this));var i=e.getAttribute(this.attributeFileId);if(i){var n=e.querySelector("["+this.attributeAvatarRemove+"]");BX.bind(n,"click",BX.delegate(function(){this.removeFile(i,e)},this))}},selectAvatar:function(e){var t=e.getAttribute(this.attributePath);var i=e.getAttribute(this.attributeFileId);BX.onCustomEvent(this,"onSelect",[t,i])},initCarousel:function(){if(!this.carouselNextNode){this.carouselNextNode=this.context.querySelector("["+this.attributeCarouselNext+"]");this.carouselPrevNode=this.context.querySelector("["+this.attributeCarouselPrev+"]");BX.bind(this.carouselNextNode,"click",BX.delegate(function(){this.turnCarousel("next")},this));BX.bind(this.carouselPrevNode,"click",BX.delegate(function(){this.turnCarousel("prev")},this))}var e=this.getUserAvatarNodes();var t=Math.round(100/e.length);e.forEach(function(e){e.style.width=t+"%"},this);this.avatarContainer.style.width="calc(66px * "+e.length+")";this.turnCarousel("start")},turnCarousel:function(e){var t=this.getUserAvatarNodes();var i;var n=66;var a=-n*(t.length-3);var o=this.avatarContainer.style.left.toString();o=parseInt(o.replace("px",""));if(isNaN(o))o=0;switch(e){case"prev":i=o+n;break;case"start":i=0;break;case"end":i=1e5;break;case"next":default:i=o-n;break}if(i>=0){i=0}else if(i<a){i=a}this.carouselPrevNode.style.display=i==0||t.length<=3?"none":"";this.carouselNextNode.style.display=i==a||t.length<=3?"none":"";this.avatarContainer.style.left=i+(i==0?"":"px")},markCurrentAvatar:function(e){var t="selected";this.getAllAvatarNodes().forEach(function(i){var n=i.getAttribute(this.attributePath);if(n==e){BX.addClass(i,t)}else{BX.removeClass(i,t)}},this);this.getUserAvatarNodes().forEach(function(e,i){if(i>2&&BX.hasClass(e,t)){this.avatarContainer.insertBefore(e,this.avatarContainer.children[0])}},this)},getUserAvatarNodeByFileId:function(e){return this.avatarContainer.querySelector("["+this.attributeFileId+'="'+e+'"]')},getUserAvatarNodes:function(){return BX.convert.nodeListToArray(this.avatarContainer.querySelectorAll("["+this.attributeAvatar+"]"))},getAllAvatarNodes:function(){return BX.convert.nodeListToArray(this.context.querySelectorAll("["+this.attributeAvatar+"]"))},showLoader:function(){BX.addClass(this.editButtonNode,"loader")},hideLoader:function(){BX.removeClass(this.editButtonNode,"loader")},onFileAdded:function(e){if(!e.error&&!!e.data.path){var t=this.createAvatarNode(e.data.fileId,e.data.path);if(this.avatarContainer.children.length>0){this.avatarContainer.insertBefore(t,this.avatarContainer.children[0])}else{this.avatarContainer.appendChild(t)}this.initAvatar(t);this.selectAvatar(t);this.hideLoader()}},onFileRemoved:function(e){if(e.fileId&&e.fileId>0){var t=this.getUserAvatarNodeByFileId(e.fileId)}if(e.error){this.caller.showErrorPopup(e);if(t){t.style.display=""}}else{BX.remove(t)}this.initCarousel();this.hideLoader()},addFile:function(e){if(!e||e.size<=0){return}this.showLoader();var t=new FormData;t.append("avatarFile",e);this.caller.sendActionRequest("addAvatarFile",t,BX.proxy(this.onFileAdded,this),BX.proxy(function(e){e=e||{error:true};this.onFileAdded(e)},this))},removeFile:function(e,t){this.showLoader();t.style.display="none";this.caller.sendActionRequest("removeAvatarFile",{fileId:e},BX.proxy(this.onFileRemoved,this))},show:function(){if(!this.editor){this.initEditor()}this.editor.show();BX.addCustomEvent(this.editor.popup,"onPopupClose",BX.proxy(this.onEditorPopupClose,this))},onEditorPopupClose:function(){BX.onCustomEvent(this,"onClose",[]);BX.removeCustomEvent(this.editor.popup,"onPopupClose",BX.proxy(this.onEditorPopupClose,this))},initEditor:function(){this.editor=new BX.AvatarEditor;BX.addCustomEvent(this.editor,"onApply",BX.delegate(function(e){if(!e){return}this.addFile(e)},this))}}})(window);
//# sourceMappingURL=script.map.js