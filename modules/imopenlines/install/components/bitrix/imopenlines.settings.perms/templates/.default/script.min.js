BX.ViPermissionEdit=function(e){this.elements={main:e,accessTable:null,accessTableBody:null,accessTableLastRow:null};this.ajaxUrl="/bitrix/components/bitrix/imopenlines.settings.perms/ajax.php";this.init()};BX.ViPermissionEdit.prototype={init:function(){this.elements.accessTable=this.elements.main.querySelector("table.bx-vi-js-role-access-table");this.elements.accessTableBody=this.elements.accessTable.querySelector("tbody");this.elements.accessTableLastRow=this.elements.main.querySelector("tr.bx-vi-js-access-table-last-row");this.bindHandlers();BX.Access.Init({other:{disabled:true}})},bindHandlers:function(){var e=this.elements.main.querySelectorAll(".bx-vi-js-delete-role");var t=this.elements.main.querySelectorAll(".bx-vi-js-delete-access");var s=this.elements.main.querySelectorAll(".bx-vi-js-add-access");var n=this.elements.main.querySelectorAll(".bx-vi-js-select-role");for(var i=0;i<e.length;i++){e[i].removeEventListener("click",this.handleDeleteRoleClick.bind(this));e[i].addEventListener("click",this.handleDeleteRoleClick.bind(this))}for(i=0;i<t.length;i++){t[i].removeEventListener("click",this.handleDeleteAccessClick.bind(this));t[i].addEventListener("click",this.handleDeleteAccessClick.bind(this))}for(i=0;i<s.length;i++){s[i].removeEventListener("click",this.handleAddAccessClick.bind(this));s[i].addEventListener("click",this.handleAddAccessClick.bind(this))}for(i=0;i<n.length;i++){n[i].removeEventListener("change",this.handleSelectRoleChange.bind(this));n[i].addEventListener("change",this.handleSelectRoleChange.bind(this))}BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(function(e){if(e.getEventId()==="ImOpenLines:reloadRoles"){document.location.reload()}},this))},handleDeleteRoleClick:function(e){e.preventDefault();e.stopPropagation();var t=e.target;var s=t.dataset.roleId;var n=this;var i=document.querySelectorAll('*[data-role-id="'+s+'"]');n.confirm(BX.message("IMOL_PERM_ROLE_DELETE"),BX.message("IMOL_PERM_ROLE_DELETE_CONFIRM"),function(e){if(!e.confirmed)return;BX.showWait();BX.ajax({url:n.ajaxUrl,method:"POST",dataType:"json",data:{action:"deleteRole",roleId:s,sessid:BX.bitrix_sessid()},onsuccess:function(e){BX.closeWait();if(!e||e.ERROR){n.notify(BX.message("IMOL_PERM_ERROR"),BX.message("IMOL_PERM_ROLE_DELETE_ERROR"));return}for(var t=0;t<i.length;t++){BX.remove(i[t])}},onfailure:function(){BX.closeWait();n.notify(BX.message("IMOL_PERM_ERROR"),BX.message("IMOL_PERM_ROLE_DELETE_ERROR"))}})})},handleAddAccessClick:function(){var e=this;var t={};var s=this.elements.accessTable.rows.length;for(var n=0;n<s;n++){if(this.elements.accessTable.rows[n].dataset.accessCode){t[this.elements.accessTable.rows[n].dataset.accessCode]=true}}BX.Access.SetSelected(t,"imopenlinesPerms");BX.Access.ShowForm({bind:"imopenlinesPerms",callback:function(t){var s;var n;for(var i in t){for(var a in t[i]){s=BX.Access.GetProviderName(t[i][a].provider);n=t[i][a].name;e.renderNewAccessCode(a,s,n,1)}}e.bindHandlers()}})},handleDeleteAccessClick:function(e){e.preventDefault();e.stopPropagation();var t=e.target;var s=t.dataset.accessCode;var n=this.elements.accessTable.querySelectorAll('tr[data-access-code="'+s+'"]');for(var i=0;i<n.length;i++){BX.remove(n[i])}},handleSelectRoleChange:function(e){var t=e.target;var s=t.value;var n=t.dataset.accessCode;var i=this.elements.main.querySelector("tr[data-access-code="+n+"]");if(i){i.dataset.roleId=s}},renderNewAccessCode:function(e,t,s,n){var i=BX("bx-vi-new-access-row").innerHTML;i=this.__replaceAll(i,{PROVIDER:t,NAME:s,ACCESS_CODE:e});var a=BX.create("tr",{html:i});a.dataset.roleId=n;a.dataset.accessCode=e;a.querySelector("select").value=n;this.elements.accessTableBody.insertBefore(a,this.elements.accessTableLastRow)},confirm:function(e,t,s){var n={confirmed:false};var i=this.elements.main.id+"-confirm-popup";var a=new BX.PopupWindow(i,null,{content:t,titleBar:e,closeByEsc:true,buttons:[new BX.PopupWindowButton({text:BX.message("IMOL_PERM_ROLE_OK"),className:"popup-window-button-accept",events:{click:function(){a.close();n.confirmed=true;if(BX.type.isFunction(s)){s(n)}}}}),new BX.PopupWindowButtonLink({text:BX.message("IMOL_PERM_ROLE_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){a.close();n.confirmed=false;if(BX.type.isFunction(s)){s(n)}}}})]});a.show()},notify:function(e,t,s){var n=this.elements.main.id+"-notify-popup";var i=new BX.PopupWindow(n,null,{content:t,titleBar:e,closeByEsc:true,buttons:[new BX.PopupWindowButton({text:"Ok",className:"popup-window-button-accept",events:{click:function(){i.close();if(BX.type.isFunction(s)){s({})}}}})]});i.show()},__replaceAll:function(e,t){if(!BX.type.isPlainObject(t))return e;var s=e.replace(/#(\w+?)#/g,function(e,s,n){if(t.hasOwnProperty(s))return t[s];else return e});return s}};
//# sourceMappingURL=script.map.js