BX.ready((function(){BX.PULL.extendWatch("IMOL_STATISTICS");BX.addCustomEvent("onPullEvent-imopenlines",(function(e,t){if(e=="voteHead"){if(typeof t.voteValue!=="undefined"){var n=BX("ol-vote-head-placeholder-"+t.sessionId);if(n){BX.cleanNode(n);n.appendChild(BX.MessengerCommon.linesVoteHeadNodes(t.sessionId,t.voteValue,true))}}if(typeof t.commentValue!=="undefined"){var i=BX("ol-comment-head-placeholder-"+t.sessionId);if(i){BX.cleanNode(i);i.appendChild(BX.MessengerCommon.linesCommentHeadNodes(t.sessionId,t.commentValue,true,"statistics"))}}}}));BX.namespace("BX.OpenLines");if(typeof BX.OpenLines.Actions==="undefined"){BX.OpenLines.Actions={actionController:"imopenlines.session.groupactions",gridId:null,filterId:null,transferDialog:null,transferItems:null,transferInputId:null,transferInputName:null,init:function(e,t){this.gridId=e;this.filterId=t.filterId;this.transferItems=t.transfer.items;this.transferInputId=t.transfer.inputId;this.transferInputName=t.transfer.inputName},initTransferDialogSelector:function(){if(!this.transferDialog){this.transferDialog=new BX.UI.EntitySelector.Dialog({targetNode:BX(this.transferInputId),context:this.getGridInstance(),multiple:false,entities:[{id:"user",options:{intranetUsersOnly:true,inviteEmployeeLink:false}},{id:"department",dynamicLoad:true,dynamicSearch:true,options:{inviteEmployeeLink:false,selectMode:"users"}}],tabs:[{id:"open-lines",title:BX.message("OL_COMPONENT_SESSION_GROUP_ACTION_OPEN_LINES_TITLE")}],items:this.transferItems,events:{"Item:onSelect":BX.proxy((function(){var e="";var t=this.getSelectedItemTransfer();if(t){e=t.title.text}this.setValueTransferInput(e)}),this),"Item:onDeselect":BX.proxy((function(){this.setValueTransferInput("")}),this)}})}BX(this.transferInputId).addEventListener("click",(function(){BX.OpenLines.Actions.transferDialog.show()}));BX.lastChild(BX(this.transferInputId)).addEventListener("input",(function(){BX.OpenLines.Actions.transferDialog.show();BX.OpenLines.Actions.transferDialog.search(this.value)}))},destroyTransferDialogSelector:function(){if(!!this.transferDialog){BX(this.transferInputId).removeEventListener("click",(function(){BX.OpenLines.Actions.transferDialog.show()}));BX(this.transferInputId).removeEventListener("input",(function(){BX.OpenLines.Actions.transferDialog.show();BX.OpenLines.Actions.transferDialog.search(this.value)}));this.transferDialog.destroy();delete this.transferDialog}},setValueTransferInput:function(e){if(!e){e=""}var t=BX.findChild(BX(this.transferInputId),{tag:"input",name:this.transferInputName});if(!!t){t.value=e}},getSelectedItemTransfer:function(){var e=null;if(!!this.transferDialog){this.transferDialog.getSelectedItems().forEach(BX.proxy((function(t){e=t}),this))}return e},getGridInstance:function(){var e=this.gridId;if(e!==null){var t=BX.Main.gridManager.getById(e);return BX.type.isPlainObject(t)&&t["instance"]!=="undefined"?t["instance"]:null}return null},refreshGrid:function(){window.requestAnimationFrame(function(){var e=BX.Main.gridManager.getInstanceById(this.gridId);if(e){e.reload()}}.bind(this))},getPanelControl:function(e){return BX(e+"_"+this.gridId+"_control")},getCheckBoxValue:function(e){var t=this.getControl(e);return t&&t.checked},getControl:function(e){return BX(e+"_"+this.gridId)},applyAction:function(e){var t=this.getGridInstance();if(t){var n=this.getCheckBoxValue("actallrows");var i=t.getRows().getSelectedIds();if(i.length!==0||n){var s={idsSession:i};if(n){s.forAll="Y";s.filterId=this.filterId}if(e==="spam"){this.runCloseSpam(s)}else if(e==="close"){this.runClose(s)}else if(e==="transfer"){var r=null;if(this.getSelectedItemTransfer()){if(this.getSelectedItemTransfer().entityId==="user"){r=this.getSelectedItemTransfer().id}else if(this.getSelectedItemTransfer().entityId==="open-line"){r="queue"+this.getSelectedItemTransfer().id}}if(r!==null){s.transferId=r;this.runTransfer(s)}if(!!this.transferInputId){this.destroyTransferDialogSelector()}}}}},confirmGroupAction:function(e){if(this.gridId===null){this.gridId=e}this.applyAction(BX.data(this.getPanelControl("action_button"),"value"))},runAction:function(e,t){var n={data:null,errors:null};BX.ajax.runAction(e,{data:t}).then((function(e){n.data=e.data}),(function(e){n.errors=e.errors}));return n},runStepProcess:function(e,t,n){var i=new BX.UI.StepProcessing.Process({id:"OpenLinesGroupActions",controller:this.actionController,messages:{DialogTitle:BX.message("LIST_GROUP_ACTION_TITLE"),DialogSummary:BX.message("LIST_GROUP_ACTION_SUMMARY")},showButtons:{start:true,stop:true,close:true},dialogMaxWidth:600});if("forAll"in t){delete t.idsSession;delete t.forAll;i.addQueueAction({title:n,action:"getdialog",handlers:{StepCompleted:function(e,t){if(e===BX.UI.StepProcessing.ProcessResultStatus.completed){var n=this.getParam("fields")||[];n.idsChat=[];n.idsSession=[];if(t.sessions){t.sessions.forEach((function(e){n.idsChat.push(e.chatId);n.idsSession.push(e.sessionId)}))}if(t.TOTAL_ITEMS){n.totalItems=parseInt(t.TOTAL_ITEMS)}this.setParam("fields",n)}}}})}i.setHandler(BX.UI.StepProcessing.ProcessCallback.StateChanged,(function(e,t){if(e===BX.UI.StepProcessing.ProcessResultStatus.completed){BX.OpenLines.Actions.refreshGrid();this.closeDialog()}})).setHandler(BX.UI.StepProcessing.ProcessCallback.RequestStop,(function(e){setTimeout(BX.delegate((function(){BX.OpenLines.Actions.refreshGrid();this.closeDialog()}),this),2e3)})).addQueueAction({title:n,action:e,handlers:{StepCompleted:function(e,t){if(e===BX.UI.StepProcessing.ProcessResultStatus.progress){var n=this.getParam("fields")||[];if(t.TOTAL_ITEMS){n.totalItems=parseInt(t.TOTAL_ITEMS)}if(t.PROCESSED_ITEMS){n.processedItems=parseInt(t.PROCESSED_ITEMS)}this.setParam("fields",n)}}}}).setParam("fields",t).showDialog();return i},runClose:function(e){this.runStepProcess("close",e,BX.message("LIST_GROUP_ACTION_CLOSE"))},runCloseSpam:function(e){this.runStepProcess("closespam",e,BX.message("LIST_GROUP_ACTION_SPAM"))},runTransfer:function(e){this.runStepProcess("transfer",e,BX.message("LIST_GROUP_ACTION_TRANSFER"))},close:function(e){this.runAction(this.actionController+".close",{fields:{idsChat:[e]}});this.refreshGrid()},closeSpam:function(e){this.runAction(this.actionController+".closespam",{fields:{idsChat:[e]}});this.refreshGrid()},getChatSessionForAll:function(){var e=[];BX.ajax.runAction(this.actionController+".getdialog",{data:{}}).then((function(t){if(t.data){t.data.forEach((function(t){e.push(t.chatId)}))}e=t.data}),(function(e){}));return e}}}if(typeof BX.OpenLines.GridActions==="undefined"){BX.OpenLines.GridActions={gridId:null,groupSelector:null,registeredTimerNodes:{},defaultPresetId:"",initPopupBaloon:function(e,t,n){this.groupSelector=null;BX.bind(BX(t+"_control"),"click",BX.delegate((function(){if(!this.groupSelector){this.groupSelector.bindEvent("item-selected",BX.delegate((function(e){BX(t+"_control").value=BX.util.htmlspecialcharsback(e.nameFormatted)||"";BX(n+"_control").value=e.id||"";this.groupSelector.close()}),this))}this.groupSelector.open()}),this))},applyAction:function(e){var t=this.getGrid();if(t){var n=this.getCheckBoxValue("actallrows");var i=t.getRows().getSelectedIds();if(i.length!==0||n){if(e==="close"){this.refreshGrid()}else if(e==="spam"){}}}},confirmGroupAction:function(e){if(this.gridId===null){this.gridId=e}this.applyAction(BX.data(this.getPanelControl("action_button"),"value"))},getPanelControl:function(e){return BX(e+"_"+this.gridId+"_control")},getGrid:function(){var e=this.gridId;if(e!==null){var t=BX.Main.gridManager.getById(e);return BX.type.isPlainObject(t)&&t["instance"]!=="undefined"?t["instance"]:null}return null},getCheckBoxValue:function(e){var t=this.getControl(e);return t&&t.checked},getControl:function(e){return BX(e+"_"+this.gridId)},refreshGrid:function(){window.requestAnimationFrame(function(){var e=BX.Main.gridManager.getInstanceById(this.gridId);if(e){e.reload()}}.bind(this))}}}if(typeof BX.OpenLines.Configuration==="undefined"){BX.OpenLines.Configuration={configurationSlider:null,configurationButton:null,configurationMenu:null,ufFieldListUrl:null,init:function(e){this.configurationSlider=null;this.configurationButton=e.configurationButton;this.ufFieldListUrl=e.ufFieldListUrl;BX.bind(this.configurationButton,"click",this.showConfigurationMenu.bind(this))},showConfigurationMenu:function(){if(!this.configurationMenu){var e=[];e.push({text:BX.message("CONFIGURATION_UF_TITLE"),className:"menu-popup-no-icon",onclick:function(){this.configurationMenu.popupWindow.close();this.openConfigurationSlider()}.bind(this)});this.configurationMenu=new BX.PopupMenuWindow("ol-stat-configuration-control-menu",this.configurationButton,e,{closeByEsc:true,autoHide:true,cacheable:false,events:{onDestroy:function(){this.configurationMenu=null}.bind(this)}})}this.configurationMenu.toggle()},openConfigurationSlider:function(){this.configurationSlider=BX.SidePanel.Instance;this.configurationSlider.open(this.ufFieldListUrl,{cacheable:false,allowChangeHistory:false,requestMethod:"post",requestParams:{sessid:BX.bitrix_sessid()},width:990})}}}if(typeof BX.OpenLines.GridFilter==="undefined"){BX.OpenLines.GridFilter={filter:null,linkId:null,linkButton:null,filterId:null,filterUrl:null,init:function(e){this.filterId=e.filterId;this.linkId=e.linkId;this.filter=BX.Main.filterManager.getById(this.filterId);if(!!this.filter&&this.filter instanceof BX.Main.Filter){this.linkButton=new BX.UI.Button({text:BX.message("FILTER_SHARE_URL"),size:BX.UI.Button.Size.MEDIUM,color:BX.UI.Button.Color.LIGHT_BORDER,icon:BX.UI.Button.Icon.SHARE,tag:BX.UI.Button.Tag.SPAN,onclick:this.copyLink.bind(this)});var t=this.filter.getPresetButtonsContainer().querySelector(".main-ui-filter-field-button-inner");this.linkButton.renderTo(t)}},copyLink:function(){var e=BX(this.linkId);if(e){if(window.BX.clipboard.copy(e.href)){BX.UI.Notification.Center.notify({content:BX.message("FILTER_SHARE_URL_DONE"),autoHideDelay:2e3})}}}}}}));
//# sourceMappingURL=script.map.js