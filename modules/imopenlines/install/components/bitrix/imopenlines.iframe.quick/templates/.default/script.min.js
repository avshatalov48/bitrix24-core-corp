window.frameCommunication={timeout:{}};quickAnswersManager=function(e,t){this.PAGE_SIZE=10;this.searchInput=BX("quick-search-input");this.searchTimeoutId=0;this.searchOffset=0;this.resultContainer=BX("quick-result");this.searchContainer=BX("quick-search-container");this.editIdContainer=BX("quick-edit-id");this.infoContainer=BX("quick-info-container");this.searchNotificationContainer=BX("quick-search-notification");this.searchSectionId=0;this.sections=e.sections||{};this.editSectionListContainer=BX("edit-category-list");this.editCurrentSectionNameContainer=BX("quick-edit-category");this.searchSectionsContainer=BX("search_category_list");this.getButtonsManager=function(){return BX.Main.interfaceButtonsManager.getById("search_category_list")};this.editSectionsContainer=BX("quick-edit-section-select");this.editContainer=BX("quick-edit-container");this.editTextarea=BX("quick-edit-text");this.editCancelButton=BX("quick-edit-cancel");this.editSaveButton=BX("quick-edit-save");this.editSectionId=0;this.editNotificationContainer=BX("quick-edit-result");this.hiddenClassName="quick-hidden";this.ajaxUrl=e.ajaxUrl;this.allUrl=e.allUrl;this.searchTimeout=e.searchTimeout||500;this.allCount=e.allCount||0;this.lineId=e.lineId;this.actionInProgress=false;this.answers={};this.freshId=0;this.init(t);if(this.allCount===0){this.showInfo()}else{this.showSearch();this.search()}};quickAnswersManager.prototype.init=function(e){this.frameCommunicationInit();BX.bind(BX("quick-all-url"),"click",BX.delegate(this.openAllUrl,this));BX.bind(BX("quick-info-all-url"),"click",BX.delegate(this.openAllUrl,this));BX.bind(BX("quick-create-message"),"click",BX.delegate(this.createMessage,this));BX.bind(BX("quick-info-create-message"),"click",BX.delegate(this.createMessage,this));BX.bind(this.searchInput,"keyup",BX.delegate(this.onSearchInputType,this));BX.bind(this.editTextarea,"keyup",BX.delegate(this.onEditTextareaType,this));BX.bind(this.editCancelButton,"click",BX.delegate(function(){this.showSearch();this.search()},this));BX.bindDelegate(this.editSectionListContainer,"click",{className:"imopenlines-iframe-quick-category-item"},BX.delegate(function(e){this.setEditSection(e.target.getAttribute("data-id"))},this));BX.bind(this.editCurrentSectionNameContainer,"click",BX.delegate(function(){if(BX.hasClass(this.editSectionsContainer,"imopenlines-iframe-quick-edit-active")){BX.removeClass(this.editSectionsContainer,"imopenlines-iframe-quick-edit-active");BX.unbind(this.editSectionsContainer,"click",this.cancelBubble);BX.unbind(window,"click",BX.proxy(this.closeEditSectionsList,this))}else{BX.addClass(this.editSectionsContainer,"imopenlines-iframe-quick-edit-active");BX.bind(this.editSectionsContainer,"click",this.cancelBubble);BX.bind(window,"click",BX.proxy(this.closeEditSectionsList,this))}},this));BX.bind(this.editSaveButton,"click",BX.delegate(function(){if(this.editTextarea.value.length>0){this.editSave()}},this));this.sectionsByIndex=[];for(var t in this.sections){if(this.sections.hasOwnProperty(t)){this.sectionsByIndex.push(t)}}if(BX.type.isFunction(e)){e()}};quickAnswersManager.prototype.frameCommunicationInit=function(){if(typeof window.postMessage==="function"){BX.bind(window,"message",BX.proxy(function(e){var t={};try{t=JSON.parse(e.data)}catch(e){}if(t.action==="init"){frameCommunication.uniqueLoadId=t.uniqueLoadId;frameCommunication.postMessageSource=e.source;frameCommunication.postMessageOrigin=e.origin}},this))}};quickAnswersManager.prototype.frameCommunicationSend=function(e){e["uniqueLoadId"]=frameCommunication.uniqueLoadId;var t=JSON.stringify(e);if(!frameCommunication.postMessageOrigin){clearTimeout(frameCommunication.timeout[t]);frameCommunication.timeout[t]=setTimeout(function(){this.frameCommunicationSend(e)},10);return true}if(typeof window.postMessage==="function"){if(frameCommunication.postMessageSource){frameCommunication.postMessageSource.postMessage(t,frameCommunication.postMessageOrigin)}}};quickAnswersManager.prototype.search=function(e){e=e!==false;if(e){this.searchHideMessage()}this.showSearchProgress();var t=this.getSearchSection();var i=this.searchInput.value;var s=false;BX.ajax({url:this.ajaxUrl,method:"POST",data:{action:"search",search:i,sectionId:t,offset:this.searchOffset,lang:BX.message("LANG"),sessid:BX.bitrix_sessid(),lineId:this.lineId},timeout:60,dataType:"json",processData:true,onsuccess:BX.proxy(function(a){this.hideSearchProgress();this.hideSearchNotFound();a=a||{};if(this.searchOffset===0){BX.cleanNode(this.resultContainer)}if(a.result&&a.result.length>0){this.allCount=a.allCount||a.result.length;BX.removeClass(this.resultContainer,this.hiddenClassName);this.renderResults(a.result);if(this.allCount>this.searchOffset+a.result.length){this.resultContainer.appendChild(BX.create("span",{attrs:{id:"quick-result-item-more"},props:{className:"quick-result-item-more"},events:{click:BX.proxy(function(){this.searchOffset+=this.PAGE_SIZE;this.search()},this)},text:BX.message("MORE")}))}else{BX.remove(BX("quick-result-item-more"))}}else if(this.searchOffset>0){BX.removeClass(this.resultContainer,this.hiddenClassName);BX.remove(BX("quick-result-item-more"))}else{if(t===0&&i.length===0){s=true}else{this.showSearchNotFound()}}if(s){this.showInfo()}else{this.showSearch(e)}},this)})};quickAnswersManager.prototype.showSearchProgress=function(){BX.removeClass(BX("quick-search-progress"),this.hiddenClassName);BX.addClass(this.resultContainer,this.hiddenClassName);BX.addClass(BX("quick-search-not-found"),this.hiddenClassName)};quickAnswersManager.prototype.hideSearchProgress=function(){BX.addClass(BX("quick-search-progress"),this.hiddenClassName)};quickAnswersManager.prototype.showSearchNotFound=function(){BX.removeClass(BX("quick-search-not-found"),this.hiddenClassName);BX.addClass(this.resultContainer,this.hiddenClassName);BX.addClass(BX("quick-search-progress"),this.hiddenClassName)};quickAnswersManager.prototype.hideSearchNotFound=function(){BX.addClass(BX("quick-search-not-found"),this.hiddenClassName)};quickAnswersManager.prototype.getSearchSection=function(){return this.searchSectionId};quickAnswersManager.prototype.setSearchSection=function(e,t){if(this.searchSectionId===e){return}t=!!t;this.searchSectionId=e;if(t){this.searchOffset=0;this.search()}this.renderSearchSections()};quickAnswersManager.prototype.renderSearchSections=function(){this._markActive(this.searchSectionsContainer,"imopenlines-iframe-quick-menu-item","main-buttons-item-active",this.searchSectionId)};quickAnswersManager.prototype._markActive=function(e,t,i,s){var a=BX.findChildren(e,{className:t});var n=0;for(var r in a){if(a.hasOwnProperty(r)){if(a[r].getAttribute("data-id")){n=parseInt(a[r].getAttribute("data-id"));if(n===s){BX.addClass(a[r],i)}else{BX.removeClass(a[r],i)}}}}};quickAnswersManager.prototype.renderResults=function(e){var t=this;for(var i=0;i<e.length;i++){if(e.hasOwnProperty(i)){this.answers[e[i].id]=e[i];BX.append(BX.create("div",{attrs:{className:"imopenlines-iframe-quick-result-block"+(this.freshId==e[i].id?" imopenlines-iframe-quick-result-block-fresh":"")},children:[BX.create("div",{attrs:{"data-bx-item-id":e[i].id,"data-bx-item-text":e[i].text,className:"imopenlines-iframe-quick-result-item"},html:e[i].name,events:{click:function(){t.putMessage(this.getAttribute("data-bx-item-text"),this.getAttribute("data-bx-item-id"))}}}),BX.create("a",{attrs:{"data-bx-item-id":e[i].id,className:"imopenlines-iframe-quick-result-edit"},events:{click:function(e){e.preventDefault();t.editMessage(this.getAttribute("data-bx-item-id"));return false}}})]}),this.resultContainer)}}if(this.freshId>0){setTimeout(BX.delegate(function(){var e=BX.findChildByClassName(this.resultContainer,"imopenlines-iframe-quick-result-block-fresh");if(e){var t=e.getBoundingClientRect();var i=t.top-this.resultContainer.offsetTop+this.resultContainer.scrollTop;if(i>0){new BX.easing({duration:1e3,start:{scroll:0},finish:{scroll:i},transition:BX.easing.makeEaseInOut(BX.easing.transitions.quart),step:BX.delegate(function(e){this.resultContainer.scrollTo(0,e.scroll)},this),complete:function(){BX.removeClass(e,"imopenlines-iframe-quick-result-block-fresh")}}).animate()}this.freshId=0}},this),200)}};quickAnswersManager.prototype.openAllUrl=function(){window.open(this.allUrl,"_blank")};quickAnswersManager.prototype.putMessage=function(e,t){if(t>0){BX.ajax({url:this.ajaxUrl,method:"POST",data:{action:"rating",id:t,sessid:BX.bitrix_sessid(),lineId:this.lineId}})}this.frameCommunicationSend({action:"put",message:e});this.frameCommunicationSend({action:"close"})};quickAnswersManager.prototype.editMessage=function(e){this.actionInProgress=false;BX.addClass(this.editNotificationContainer,this.hiddenClassName);BX.removeClass(this.editTextarea,"imopenlines-iframe-quick-edit-textarea-result");BX.removeClass(this.editContainer,this.hiddenClassName);BX.addClass(this.searchContainer,this.hiddenClassName);BX.addClass(this.infoContainer,this.hiddenClassName);this.editTextarea.focus();if(!e){this.editTextarea.value="";this.editIdContainer.value=0;this.setEditSection(0);this.editSaveButton.innerText=BX.message("IMOL_QUICK_ANSWERS_EDIT_CREATE");BX.removeClass(this.editSaveButton,"imopenlines-iframe-quick-edit-save");BX.addClass(this.editSaveButton,"imopenlines-iframe-quick-edit-cancel");this.setEditSection(this.searchSectionId)}else{if(this.answers[e]){this.editTextarea.value=this.answers[e].text;this.editIdContainer.value=e;this.setEditSection(this.answers[e].section);this.editSaveButton.innerText=BX.message("IMOL_QUICK_ANSWERS_EDIT_UPDATE");BX.addClass(this.editSaveButton,"imopenlines-iframe-quick-edit-save");BX.removeClass(this.editSaveButton,"imopenlines-iframe-quick-edit-cancel")}}};quickAnswersManager.prototype.createMessage=function(){this.editMessage(0)};quickAnswersManager.prototype.setEditSection=function(e){this.editSectionId=e;this.editCurrentSectionNameContainer.innerText=this.sections[this.editSectionId].NAME;this._markActive(this.editSectionListContainer,"imopenlines-iframe-quick-category-item","imopenlines-iframe-quick-category-item-selected",this.editSectionId)};quickAnswersManager.prototype.onSearchInputType=function(e,t){if(e.ctrlKey||e.altKey||e.keyCode===17||e.keyCode===18||e.keyCode===16){return false}this.showSearchProgress();var i=this.searchTimeout;if(t===true){i=15}if(e.keyCode===27){if(this.searchInput.value){this.searchInput.value=""}else{this.frameCommunicationSend({action:"close"});return false}}clearTimeout(this.searchTimeoutId);this.searchTimeoutId=setTimeout(BX.delegate(function(){this.searchOffset=0;this.search()},this),i)};quickAnswersManager.prototype.cancelBubble=function(e){e=e||window.event;if(e.stopPropagation){e.stopPropagation()}else{e.cancelBubble=true}};quickAnswersManager.prototype.closeEditSectionsList=function(){BX.removeClass(this.editSectionsContainer,"imopenlines-iframe-quick-edit-active");BX.unbind(this.editSectionsContainer,"click",this.cancelBubble);BX.unbind(window,"click",BX.proxy(this.closeEditSectionsList,this))};quickAnswersManager.prototype.editSave=function(){if(this.actionInProgress===true){return}this.actionInProgress=true;BX.addClass(this.editNotificationContainer,this.hiddenClassName);BX.removeClass(this.editTextarea,"imopenlines-iframe-quick-edit-textarea-result");BX.removeClass(this.editSectionsContainer,"imopenlines-iframe-quick-edit-active");var e=this.editTextarea.value;var t=parseInt(this.editIdContainer.value);if(e.length===0){this.editShowMessage(BX.message("IMOL_QUICK_ANSWERS_EDIT_ERROR_EMPTY_TEXT"));return false}var i=this.editSectionId;BX.ajax({url:this.ajaxUrl,method:"POST",data:{action:"edit",text:e,id:t,sectionId:i,lang:BX.message("LANG"),sessid:BX.bitrix_sessid(),lineId:this.lineId},timeout:60,dataType:"json",processData:true,onsuccess:BX.proxy(function(e){this.actionInProgress=false;if(!e.error){if(e.id&&e.id>0){this.freshId=e.id}if(t===0){this.allCount++;this.setLastPage()}this.showSearch();this.search(false);this.searchShowMessage(false);BX.addClass(this.editNotificationContainer,this.hiddenClassName);BX.removeClass(this.editTextarea,"imopenlines-iframe-quick-edit-textarea-result")}else{this.editShowMessage(e.text)}BX.addClass(this.editSaveButton,"imopenlines-iframe-quick-edit-save");BX.removeClass(this.editSaveButton,"imopenlines-iframe-quick-edit-cancel")},this)});return false};quickAnswersManager.prototype.searchShowMessage=function(e){if(e){this.searchNotificationContainer.innerHTML=e}BX.removeClass(this.searchNotificationContainer,this.hiddenClassName);BX.addClass(this.resultContainer,"imopenlines-iframe-quick-result-with-message")};quickAnswersManager.prototype.searchHideMessage=function(){BX.addClass(this.searchNotificationContainer,this.hiddenClassName);BX.removeClass(this.resultContainer,"imopenlines-iframe-quick-result-with-message")};quickAnswersManager.prototype.editShowMessage=function(e){if(e){this.editNotificationContainer.innerHTML=e}BX.removeClass(this.editNotificationContainer,this.hiddenClassName);BX.addClass(this.editTextarea,"imopenlines-iframe-quick-edit-textarea-result")};quickAnswersManager.prototype.showInfo=function(){BX.removeClass(this.infoContainer,this.hiddenClassName);BX.addClass(this.editContainer,this.hiddenClassName);BX.addClass(this.searchContainer,this.hiddenClassName);this.hideSearchNotFound();this.hideSearchProgress()};quickAnswersManager.prototype.showSearch=function(e){e=e!==false;BX.addClass(this.infoContainer,this.hiddenClassName);BX.addClass(this.editContainer,this.hiddenClassName);BX.removeClass(this.searchContainer,this.hiddenClassName);BX.removeClass(this.editSectionsContainer,"imopenlines-iframe-quick-edit-active");this.searchInput.focus();setTimeout(BX.delegate(this.getButtonsManager().adjustMoreButtonPosition,this),100);setTimeout(BX.delegate(this.bindMenuEvents,this),200);if(e){this.searchHideMessage()}};quickAnswersManager.prototype.onEditTextareaType=function(e){if(e.ctrlKey&&e.keyCode===13){this.editSave();return}if(e.keyCode===27){this.showSearch();this.search()}if(this.editTextarea.value.length===0){BX.removeClass(this.editSaveButton,"imopenlines-iframe-quick-edit-save");BX.addClass(this.editSaveButton,"imopenlines-iframe-quick-edit-cancel")}else{BX.addClass(this.editSaveButton,"imopenlines-iframe-quick-edit-save");BX.removeClass(this.editSaveButton,"imopenlines-iframe-quick-edit-cancel")}};quickAnswersManager.prototype.setLastPage=function(){if(this.allCount>this.searchOffset){this.searchOffset=Math.floor(this.allCount/this.PAGE_SIZE)*this.PAGE_SIZE}};quickAnswersManager.prototype._getPopupWindowItems=function(){var e=BX("menu-popup-main_buttons_popup_search_category_list");if(e){return e.firstChild.firstChild.firstChild.children}return null};quickAnswersManager.prototype.bindMenuEvents=function(){if(!this.getSearchSectionsMenuMoreButton()){return}BX.unbind(this.getSearchSectionsMenuMoreButton(),"click");BX.bind(this.getSearchSectionsMenuMoreButton(),"click",BX.delegate(function(){this.getButtonsManager().showSubmenu();setTimeout(BX.delegate(function(){var e=this._getPopupWindowItems();var t=e.length;for(var i=0,s=0;i<t;i++,s++){if(e[i].tagName!="A"){s--;continue}if(this.sectionsByIndex.hasOwnProperty(s)){e[i].setAttribute("data-id",this.sectionsByIndex[s]);BX.unbindAll(e[i]);BX.bind(e[i],"click",BX.delegate(function(e){var t;if(e.target.tagName!="A"){var i=BX.findParent(e.target,{className:"main-buttons-submenu-item"});if(i){t=i.getAttribute("data-id")}}else{t=e.target.getAttribute("data-id")}t=t||0;this.setSearchSection(t,true)},this))}}},this),100)},this))};quickAnswersManager.prototype.getSearchSectionsMenuMoreButton=function(){return BX("search_category_list_more_button")};