{"version":3,"file":"registry.bundle.js","sources":["../src/recent/recent.js","../src/session/session.js","../src/queue/queue.js","../src/const/handlers.js"],"sourcesContent":["import { Type } from 'main.core';\n\nimport { Messenger } from 'im.public';\nimport { Layout } from 'im.v2.const';\nimport { LayoutManager } from 'im.v2.lib.layout';\nimport { Core } from 'im.v2.application.core';\nimport { Logger } from 'im.v2.lib.logger';\n\nimport type {\n\tChatHideParams, MessageAddParams,\n\tReadMessageParams,\n\tUnreadMessageParams,\n} from 'im.v2.provider.pull';\nimport type { ChatUserLeaveParams } from 'imopenlines.v2.provider.pull';\n\nexport class LinesPullHandler\n{\n\tconstructor()\n\t{\n\t\tthis.store = Core.getStore();\n\t}\n\n\tgetModuleId(): string\n\t{\n\t\treturn 'im';\n\t}\n\n\thandleMessage(params, extra)\n\t{\n\t\tthis.handleMessageAdd(params, extra);\n\t}\n\n\thandleMessageChat(params)\n\t{\n\t\tthis.handleMessageAdd(params);\n\t\tthis.updateUnloadedLinesCounter(params);\n\t}\n\n\thandleMessageAdd(params: MessageAddParams)\n\t{\n\t\tif (!params.lines)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst userId = Core.getUserId();\n\t\tconst userInChat = params.userInChat[params.chatId];\n\n\t\tconst isClosed = params.lines.isClosed;\n\n\t\tif (userInChat.includes(userId) && !isClosed)\n\t\t{\n\t\t\tvoid this.store.dispatch('recentOpenLines/set', {\n\t\t\t\tid: params.dialogId,\n\t\t\t\tmessageId: params.message.id,\n\t\t\t\tsessionId: params.lines.id,\n\t\t\t});\n\t\t}\n\n\t\tvoid this.store.dispatch('sessions/set', {\n\t\t\t...params.lines,\n\t\t\tchatId: params.chatId,\n\t\t\tstatus: params.lines.statusGroup,\n\t\t});\n\t}\n\n\thandleReadMessageChat(params: ReadMessageParams)\n\t{\n\t\tthis.updateUnloadedLinesCounter(params);\n\t}\n\n\thandleUnreadMessageChat(params: UnreadMessageParams)\n\t{\n\t\tthis.updateUnloadedLinesCounter(params);\n\t}\n\n\thandleChatHide(params: ChatHideParams)\n\t{\n\t\tthis.updateUnloadedLinesCounter({\n\t\t\tdialogId: params.dialogId,\n\t\t\tchatId: params.chatId,\n\t\t\tlines: params.lines,\n\t\t\tcounter: 0,\n\t\t});\n\n\t\tconst recentItem = this.store.getters['recentOpenLines/get'](params.dialogId);\n\n\t\tif (!recentItem)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tvoid this.store.dispatch('recentOpenLines/delete', {\n\t\t\tid: params.dialogId,\n\t\t});\n\t}\n\n\tupdateUnloadedLinesCounter(params: {\n\t\tdialogId: string,\n\t\tchatId: number,\n\t\tcounter: number,\n\t\tlines: ?Object<string, any>,\n\t})\n\t{\n\t\tconst { dialogId, chatId, counter, lines } = params;\n\t\tif (!lines || Type.isUndefined(counter))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tLogger.warn('LinesPullHandler: updateUnloadedLinesCounter:', { dialogId, chatId, counter });\n\t\tvoid this.store.dispatch('counters/setUnloadedLinesCounters', { [chatId]: counter });\n\t}\n\n\thandleChatUserLeave(params: ChatUserLeaveParams)\n\t{\n\t\tconst recentItem = this.store.getters['recentOpenLines/get'](params.dialogId);\n\t\tconst chatIsOpened = Core.getStore().getters['application/isLinesChatOpen'](params.dialogId);\n\n\t\tconst userId = Core.getUserId();\n\n\t\tif (chatIsOpened && params.userId === userId)\n\t\t{\n\t\t\tvoid Messenger.openLines();\n\t\t\tLayoutManager.getInstance().setLastOpenedElement(Layout.openlinesV2.name, '');\n\t\t}\n\n\t\tif (!recentItem || params.userId !== Core.getUserId())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tvoid this.store.dispatch('recentOpenLines/delete', {\n\t\t\tid: params.dialogId,\n\t\t});\n\t}\n}\n","import { Core } from 'im.v2.application.core';\n\nimport type { SessionUpdateParams } from '../types/session';\n\nexport class SessionPullHandler\n{\n\tconstructor()\n\t{\n\t\tthis.store = Core.getStore();\n\t}\n\n\tgetModuleId(): string\n\t{\n\t\treturn 'imopenlines';\n\t}\n\n\thandleUpdateSessionStatus(params: SessionUpdateParams): void\n\t{\n\t\tconst sessionItem = params.session;\n\n\t\tconst isClosed = sessionItem.isClosed;\n\n\t\tif (!isClosed)\n\t\t{\n\t\t\tvoid this.store.dispatch('recentOpenLines/set', {\n\t\t\t\tid: params.chat.dialogId,\n\t\t\t\tmessageId: params.message.id,\n\t\t\t\tsessionId: sessionItem.id,\n\t\t\t});\n\t\t}\n\n\t\tvoid this.store.dispatch('sessions/set', sessionItem);\n\t}\n}\n","import { Core } from 'im.v2.application.core';\n\nimport type { QueueUpdateParams } from '../types/queue';\n\nexport class QueuePullHandler\n{\n\tconstructor()\n\t{\n\t\tthis.store = Core.getStore();\n\t}\n\n\tgetModuleId(): string\n\t{\n\t\treturn 'imopenlines';\n\t}\n\n\thandleQueueItemUpdate(params: QueueUpdateParams)\n\t{\n\t\tvoid this.store.dispatch('queue/set', params);\n\t}\n\n\thandleQueueItemDelete(params: QueueUpdateParams)\n\t{\n\t\tvoid this.store.dispatch('queue/delete', params.id);\n\t}\n}\n","import { LinesPullHandler } from '../recent/recent';\nimport { SessionPullHandler } from '../session/session';\nimport { QueuePullHandler } from '../queue/queue';\n\nexport const OpenLinesHandlers = [\n\tLinesPullHandler,\n\tSessionPullHandler,\n\tQueuePullHandler,\n];\n"],"names":["LinesPullHandler","constructor","store","Core","getStore","getModuleId","handleMessage","params","extra","handleMessageAdd","handleMessageChat","updateUnloadedLinesCounter","lines","userId","getUserId","userInChat","chatId","isClosed","includes","dispatch","id","dialogId","messageId","message","sessionId","status","statusGroup","handleReadMessageChat","handleUnreadMessageChat","handleChatHide","counter","recentItem","getters","Type","isUndefined","Logger","warn","handleChatUserLeave","chatIsOpened","Messenger","openLines","LayoutManager","getInstance","setLastOpenedElement","Layout","openlinesV2","name","SessionPullHandler","handleUpdateSessionStatus","sessionItem","session","chat","QueuePullHandler","handleQueueItemUpdate","handleQueueItemDelete","OpenLinesHandlers"],"mappings":"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"}