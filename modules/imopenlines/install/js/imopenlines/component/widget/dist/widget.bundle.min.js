(function(t,e,i,o,s,n,a,r,l,c,d,h,g,u,m,f,p,v,w,b,y,C,x,S,I,D,M){"use strict";function k(t){var e=[];for(var i in t){if(t.hasOwnProperty(i)){e.push(t[i])}}return e}var T=Object.freeze({none:"none",like:"like",dislike:"dislike"});var L=Object.freeze({russian:"ru",ukraine:"ua",world:"en"});var E=Object.freeze({none:"none",like:"like",smile:"smile",consent:"consent",welcome:"welcome",offline:"offline",history:"history"});var _=Object.freeze({topLeft:1,topMiddle:2,topBottom:3,bottomLeft:6,bottomMiddle:5,bottomRight:4});var A=Object.freeze({1:"top-left",2:"top-center",3:"top-right",6:"bottom-left",5:"bottom-center",4:"bottom-right"});var F=Object.freeze({configLoaded:"configLoaded",widgetOpen:"widgetOpen",widgetClose:"widgetClose",sessionStart:"sessionStart",sessionOperatorChange:"sessionOperatorChange",sessionFinish:"sessionFinish",operatorMessage:"operatorMessage",userForm:"userForm",userMessage:"userMessage",userFile:"userFile",userVote:"userVote",every:"every"});var H=k(F);var R=Object.freeze({widgetUserRegister:"imopenlines.widget.user.register",widgetConfigGet:"imopenlines.widget.config.get",widgetDialogGet:"imopenlines.widget.dialog.get",widgetUserGet:"imopenlines.widget.user.get",widgetUserConsentApply:"imopenlines.widget.user.consent.apply",widgetVoteSend:"imopenlines.widget.vote.send",widgetActionSend:"imopenlines.widget.action.send",pullServerTime:"server.time",pullConfigGet:"pull.config.get"});var U=k(R);var B=Object.freeze({guest:"guest"});var O=Object.freeze({new:0,skip:5,answer:10,client:20,clientAfterOperator:25,operator:40,waitClient:50,close:60,spam:65,duplicate:69,silentlyClose:75});var N=Object.freeze({requestShowForm:"IMOL.Widget:requestShowForm"});var P=function(t){babelHelpers.inherits(e,t);function e(){babelHelpers.classCallCheck(this,e);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).apply(this,arguments))}babelHelpers.createClass(e,[{key:"getName",value:function t(){return"widget"}},{key:"getState",value:function t(){return{common:{configId:0,configName:"",host:this.getVariable("common.host",location.protocol+"//"+location.host),pageMode:this.getVariable("common.pageMode",false),copyright:this.getVariable("common.copyright",true),copyrightUrl:this.getVariable("common.copyrightUrl","https://bitrix24.com"),location:this.getVariable("common.location",_.bottomRight),styles:{backgroundColor:this.getVariable("styles.backgroundColor","#17a3ea"),iconColor:this.getVariable("styles.iconColor","#ffffff")},vote:{enable:false,beforeFinish:true,messageText:this.getVariable("vote.messageText",""),messageLike:this.getVariable("vote.messageLike",""),messageDislike:this.getVariable("vote.messageDislike","")},textMessages:{bxLivechatOnlineLine1:this.getVariable("textMessages.bxLivechatOnlineLine1",""),bxLivechatOnlineLine2:this.getVariable("textMessages.bxLivechatOnlineLine2",""),bxLivechatOffline:this.getVariable("textMessages.bxLivechatOffline",""),bxLivechatTitle:""},online:false,operators:[],connectors:[],showForm:E.none,showed:false,reopen:false,dragged:false,textareaHeight:0,widgetHeight:0,widgetWidth:0,showConsent:false,consentUrl:"",dialogStart:false,watchTyping:false,showSessionId:false,crmFormsSettings:{useWelcomeForm:false,welcomeFormId:0,welcomeFormSec:"",welcomeFormDelay:false,welcomeFormFilled:false,successText:"",errorText:""}},dialog:{sessionId:0,sessionClose:true,sessionStatus:0,userVote:T.none,closeVote:false,userConsent:false,operatorChatId:0,operator:{id:0,name:"",firstName:"",lastName:"",workPosition:"",avatar:"",online:false}},user:{id:-1,hash:"",name:"",firstName:"",lastName:"",avatar:"",email:"",phone:"",www:"",gender:"M",position:""}}}},{key:"getStateSaveException",value:function t(){return{common:{host:null,pageMode:null,copyright:null,copyrightUrl:null,styles:null,dragged:null,showed:null,showConsent:null,showForm:null}}}},{key:"getMutations",value:function t(){var e=this;return{common:function t(i,o){if(typeof o.configId==="number"){i.common.configId=o.configId}if(typeof o.configName==="string"){i.common.configName=o.configName}if(typeof o.online==="boolean"){i.common.online=o.online}if(w.Utils.types.isPlainObject(o.vote)){if(typeof o.vote.enable==="boolean"){i.common.vote.enable=o.vote.enable}if(typeof o.vote.beforeFinish==="boolean"){i.common.vote.beforeFinish=o.vote.beforeFinish}if(typeof o.vote.messageText==="string"){i.common.vote.messageText=o.vote.messageText}if(typeof o.vote.messageLike==="string"){i.common.vote.messageLike=o.vote.messageLike}if(typeof o.vote.messageDislike==="string"){i.common.vote.messageDislike=o.vote.messageDislike}}if(w.Utils.types.isPlainObject(o.textMessages)){if(typeof o.textMessages.bxLivechatOnlineLine1==="string"&&o.textMessages.bxLivechatOnlineLine1!==""){i.common.textMessages.bxLivechatOnlineLine1=o.textMessages.bxLivechatOnlineLine1}if(typeof o.textMessages.bxLivechatOnlineLine2==="string"&&o.textMessages.bxLivechatOnlineLine2!==""){i.common.textMessages.bxLivechatOnlineLine2=o.textMessages.bxLivechatOnlineLine2}if(typeof o.textMessages.bxLivechatOffline==="string"&&o.textMessages.bxLivechatOffline!==""){i.common.textMessages.bxLivechatOffline=o.textMessages.bxLivechatOffline}if(typeof o.textMessages.bxLivechatTitle==="string"&&o.textMessages.bxLivechatTitle!==""){i.common.textMessages.bxLivechatTitle=o.textMessages.bxLivechatTitle}}if(typeof o.dragged==="boolean"){i.common.dragged=o.dragged}if(typeof o.textareaHeight==="number"){i.common.textareaHeight=o.textareaHeight}if(typeof o.widgetHeight==="number"){i.common.widgetHeight=o.widgetHeight}if(typeof o.widgetWidth==="number"){i.common.widgetWidth=o.widgetWidth}if(typeof o.showConsent==="boolean"){i.common.showConsent=o.showConsent}if(typeof o.consentUrl==="string"){i.common.consentUrl=o.consentUrl}if(typeof o.showed==="boolean"){i.common.showed=o.showed;o.reopen=w.Utils.device.isMobile()?false:o.showed}if(typeof o.reopen==="boolean"){i.common.reopen=o.reopen}if(typeof o.copyright==="boolean"){i.common.copyright=o.copyright}if(typeof o.dialogStart==="boolean"){i.common.dialogStart=o.dialogStart}if(typeof o.watchTyping==="boolean"){i.common.watchTyping=o.watchTyping}if(typeof o.showSessionId==="boolean"){i.common.showSessionId=o.showSessionId}if(o.operators instanceof Array){i.common.operators=o.operators}if(o.connectors instanceof Array){i.common.connectors=o.connectors}if(typeof o.showForm==="string"&&typeof E[o.showForm]!=="undefined"){if(o.showForm===E.like&&!!i.dialog.closeVote){o.showForm=E.none}i.common.showForm=o.showForm}if(typeof o.location==="number"&&typeof A[o.location]!=="undefined"){if(i.common.location!==o.location){i.common.widgetHeight=0;i.common.widgetWidth=0;i.common.location=o.location}}if(w.Utils.types.isPlainObject(o.crmFormsSettings)){if(typeof o.crmFormsSettings.useWelcomeForm==="string"){i.common.crmFormsSettings.useWelcomeForm=o.crmFormsSettings.useWelcomeForm==="Y"}if(typeof o.crmFormsSettings.welcomeFormId==="string"){i.common.crmFormsSettings.welcomeFormId=o.crmFormsSettings.welcomeFormId}if(typeof o.crmFormsSettings.welcomeFormSec==="string"){i.common.crmFormsSettings.welcomeFormSec=o.crmFormsSettings.welcomeFormSec}if(typeof o.crmFormsSettings.welcomeFormDelay==="string"){i.common.crmFormsSettings.welcomeFormDelay=o.crmFormsSettings.welcomeFormDelay==="Y"}if(typeof o.crmFormsSettings.successText==="string"&&o.crmFormsSettings.successText!==""){i.common.crmFormsSettings.successText=o.crmFormsSettings.successText}if(typeof o.crmFormsSettings.errorText==="string"&&o.crmFormsSettings.errorText!==""){i.common.crmFormsSettings.errorText=o.crmFormsSettings.errorText}}if(e.isSaveNeeded({common:o})){e.saveState(i)}},dialog:function t(i,o){if(typeof o.sessionId==="number"){i.dialog.sessionId=o.sessionId}if(typeof o.sessionClose==="boolean"){i.dialog.sessionClose=o.sessionClose}if(typeof o.sessionStatus==="number"){i.dialog.sessionStatus=o.sessionStatus}if(typeof o.userConsent==="boolean"){i.dialog.userConsent=o.userConsent}if(typeof o.userVote==="string"&&typeof o.userVote!=="undefined"){i.dialog.userVote=o.userVote}if(typeof o.closeVote==="boolean"){i.dialog.closeVote=o.closeVote;if(!!o.closeVote&&i.common.showForm===E.like){i.common.showForm=E.none}}if(typeof o.operatorChatId==="number"){i.dialog.operatorChatId=o.operatorChatId}if(w.Utils.types.isPlainObject(o.operator)){if(typeof o.operator.id==="number"){i.dialog.operator.id=o.operator.id}if(typeof o.operator.name==="string"||typeof o.operator.name==="number"){i.dialog.operator.name=o.operator.name.toString()}if(typeof o.operator.lastName==="string"||typeof o.operator.lastName==="number"){i.dialog.operator.lastName=o.operator.lastName.toString()}if(typeof o.operator.firstName==="string"||typeof o.operator.firstName==="number"){i.dialog.operator.firstName=o.operator.firstName.toString()}if(typeof o.operator.workPosition==="string"||typeof o.operator.workPosition==="number"){i.dialog.operator.workPosition=o.operator.workPosition.toString()}if(typeof o.operator.avatar==="string"){if(!o.operator.avatar||o.operator.avatar.startsWith("http")){i.dialog.operator.avatar=o.operator.avatar}else{i.dialog.operator.avatar=i.common.host+o.operator.avatar}}if(typeof o.operator.online==="boolean"){i.dialog.operator.online=o.operator.online}}if(e.isSaveNeeded({dialog:o})){e.saveState(i)}},user:function t(i,o){if(typeof o.id==="number"){i.user.id=o.id}if(typeof o.hash==="string"&&o.hash!==i.user.hash){i.user.hash=o.hash;f.Cookie.set(null,"LIVECHAT_HASH",o.hash,{expires:365*86400,path:"/"})}if(typeof o.name==="string"||typeof o.name==="number"){i.user.name=o.name.toString()}if(typeof o.firstName==="string"||typeof o.firstName==="number"){i.user.firstName=o.firstName.toString()}if(typeof o.lastName==="string"||typeof o.lastName==="number"){i.user.lastName=o.lastName.toString()}if(typeof o.avatar==="string"){i.user.avatar=o.avatar}if(typeof o.email==="string"){i.user.email=o.email}if(typeof o.phone==="string"||typeof o.phone==="number"){i.user.phone=o.phone.toString()}if(typeof o.www==="string"){i.user.www=o.www}if(typeof o.gender==="string"){i.user.gender=o.gender}if(typeof o.position==="string"){i.user.position=o.position}if(e.isSaveNeeded({user:o})){e.saveState(i)}}}}},{key:"getActions",value:function t(){var e=this;return{show:function t(e){var i=e.commit;i("common",{showed:true})},setVoteDateFinish:function t(i,o){var s=i.commit,n=i.dispatch,a=i.state;if(!o){clearTimeout(e.setVoteDateTimeout);s("dialog",{closeVote:false});return true}var r=new Date(o).getTime()-(new Date).getTime();var l=1e4;clearTimeout(e.setVoteDateTimeout);if(o){if(r&&!a.dialog.closeVote){s("dialog",{closeVote:false})}var c=r;if(r>l){c=l}e.setVoteDateTimeout=setTimeout(function t(){c=new Date(o).getTime()-(new Date).getTime();if(c>0){if(c>l){c=l}setTimeout(t,c)}else{s("dialog",{closeVote:true})}},c)}}}}}]);return e}(D.VuexBuilderModel);var W=function(){function t(e){babelHelpers.classCallCheck(this,t);this.queryAuthRestore=false;this.setAuthId(B.guest);this.restClient=new c.RestClient({endpoint:e.endpoint,queryParams:this.queryParams,cors:true})}babelHelpers.createClass(t,[{key:"setAuthId",value:function t(e){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";if(babelHelpers.typeof(this.queryParams)!=="object"){this.queryParams={}}if(e==B.guest||typeof e==="string"&&e.match(/^[a-f0-9]{32}$/)){this.queryParams.livechat_auth_id=e}else{console.error("%LiveChatRestClient.setAuthId: auth is not correct (%c".concat(e,"%c)"),"color: black;","font-weight: bold; color: red","color: black");return false}if(e==B.guest&&typeof i==="string"&&i.match(/^[a-f0-9]{32}$/)){this.queryParams.livechat_custom_auth_id=i}return true}},{key:"getAuthId",value:function t(){if(babelHelpers.typeof(this.queryParams)!=="object"){this.queryParams={}}return this.queryParams.livechat_auth_id||null}},{key:"callMethod",value:function t(e,i,o,s){var n=this;var a=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;if(!a){a=w.Utils.getLogTrackingParams({name:e})}var r=new BX.Promise;this.restClient.callMethod(e,i,null,s,a).then(function(t){n.queryAuthRestore=false;r.fulfill(t)}).catch(function(t){var o=t.error();if(o.ex.error=="LIVECHAT_AUTH_WIDGET_USER"){n.setAuthId(o.ex.hash);if(e===R.widgetUserRegister){console.warn("BX.LiveChatRestClient: ".concat(o.ex.error_description," (").concat(o.ex.error,")"));n.queryAuthRestore=false;r.reject(t);return false}if(!n.queryAuthRestore){console.warn("BX.LiveChatRestClient: your auth-token has expired, send query with a new token");n.queryAuthRestore=true;n.restClient.callMethod(e,i,null,s,a).then(function(t){n.queryAuthRestore=false;r.fulfill(t)}).catch(function(t){n.queryAuthRestore=false;r.reject(t)});return false}}n.queryAuthRestore=false;r.reject(t)});return r}},{key:"callBatch",value:function t(e,i,o,s,n){var a=this;var r=function t(r){for(var l in e){if(!e.hasOwnProperty(l)){continue}var c=r[l].error();if(c&&c.ex.error=="LIVECHAT_AUTH_WIDGET_USER"){a.setAuthId(c.ex.hash);if(l===R.widgetUserRegister){console.warn("BX.LiveChatRestClient: ".concat(c.ex.error_description," (").concat(c.ex.error,")"));a.queryAuthRestore=false;i(r);return false}if(!a.queryAuthRestore){console.warn("BX.LiveChatRestClient: your auth-token has expired, send query with a new token");a.queryAuthRestore=true;a.restClient.callBatch(e,i,o,s,n);return false}}}a.queryAuthRestore=false;i(r);return true};return this.restClient.callBatch(e,r,o,s,n)}}]);return t}();var V=function(t){babelHelpers.inherits(e,t);function e(){var t;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,i));t.widget=i.widget;return t}babelHelpers.createClass(e,[{key:"handleImopenlinesWidgetConfigGetSuccess",value:function t(e){this.store.commit("widget/common",{configId:e.configId,configName:e.configName,vote:e.vote,textMessages:e.textMessages,operators:e.operators||[],online:e.online,consentUrl:e.consentUrl,connectors:e.connectors||[],watchTyping:e.watchTyping,showSessionId:e.showSessionId,crmFormsSettings:e.crmFormsSettings});this.store.commit("application/set",{disk:e.disk});this.widget.addLocalize(e.serverVariables);p.LocalStorage.set(this.widget.getSiteId(),0,"serverVariables",e.serverVariables||{})}},{key:"handleImopenlinesWidgetUserRegisterSuccess",value:function t(e){this.widget.restClient.setAuthId(e.hash);var i=[];if(typeof this.store.state.messages.collection[this.controller.application.getChatId()]!=="undefined"){i=this.store.state.messages.collection[this.controller.application.getChatId()]}this.store.commit("messages/initCollection",{chatId:e.chatId,messages:i});this.store.commit("dialogues/initCollection",{dialogId:e.dialogId,fields:{entityType:"LIVECHAT",type:"livechat"}});this.store.commit("application/set",{dialog:{chatId:e.chatId,dialogId:"chat"+e.chatId}})}},{key:"handleImopenlinesWidgetUserGetSuccess",value:function t(e){this.store.commit("widget/user",{id:e.id,hash:e.hash,name:e.name,firstName:e.firstName,lastName:e.lastName,phone:e.phone,avatar:e.avatar,email:e.email,www:e.www,gender:e.gender,position:e.position});this.store.dispatch("users/set",[{id:e.id,name:e.name,firstName:e.firstName,lastName:e.lastName,avatar:e.avatar,gender:e.gender,workPosition:e.position}]);this.store.commit("application/set",{common:{userId:e.id}})}},{key:"handleImopenlinesWidgetDialogGetSuccess",value:function t(e){this.store.commit("messages/initCollection",{chatId:e.chatId});this.store.commit("widget/dialog",e);this.store.commit("application/set",{dialog:{chatId:e.chatId,dialogId:"chat"+e.chatId,diskFolderId:e.diskFolderId}});this.store.dispatch("widget/setVoteDateFinish",e.dateCloseVote)}},{key:"handleImDialogMessagesGetInitSuccess",value:function t(e){this.handleImDialogMessagesGetSuccess(e)}},{key:"handleImDialogMessagesGetSuccess",value:function t(e){if(e.messages&&e.messages.length>0&&!this.widget.isDialogStart()){this.store.commit("widget/common",{dialogStart:true});this.store.commit("widget/dialog",{userConsent:true})}}},{key:"handleImMessageAddSuccess",value:function t(e,i){this.widget.messagesQueue=this.widget.messagesQueue.filter(function(t){return t.id!=i.id});this.widget.sendEvent({type:F.userMessage,data:{id:e,text:i.text}})}},{key:"handleImMessageAddError",value:function t(e,i){this.widget.messagesQueue=this.widget.messagesQueue.filter(function(t){return t.id!=i.id})}},{key:"handleImDiskFileCommitSuccess",value:function t(e,i){this.widget.messagesQueue=this.widget.messagesQueue.filter(function(t){return t.id!=i.id});this.widget.sendEvent({type:F.userFile,data:{}})}}]);return e}(d.BaseRestHandler);var X=function(){babelHelpers.createClass(t,[{key:"getModuleId",value:function t(){return"im"}}],[{key:"create",value:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return new this(e)}}]);function t(e){babelHelpers.classCallCheck(this,t);this.controller=e.controller;this.store=e.store;this.widget=e.widget}babelHelpers.createClass(t,[{key:"handleMessageChat",value:function t(e,i,o){if(e.message.senderId!=this.controller.application.getUserId()){this.widget.sendEvent({type:F.operatorMessage,data:e});if(!this.store.state.widget.common.showed&&!this.widget.onceShowed){this.widget.onceShowed=true;this.widget.open()}}}}]);return t}();var q=function(){babelHelpers.createClass(t,null,[{key:"create",value:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return new this(e)}}]);function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,t);this.controller=e.controller;this.store=e.store;this.widget=e.widget}babelHelpers.createClass(t,[{key:"getModuleId",value:function t(){return"imopenlines"}},{key:"handleSessionStart",value:function t(e,i,o){this.store.commit("widget/dialog",{sessionId:e.sessionId,sessionClose:false,sessionStatus:0,userVote:T.none});this.store.dispatch("widget/setVoteDateFinish","");this.widget.sendEvent({type:F.sessionStart,data:{sessionId:e.sessionId}})}},{key:"handleSessionOperatorChange",value:function t(e,i,o){this.store.commit("widget/dialog",{operator:e.operator,operatorChatId:e.operatorChatId});this.widget.sendEvent({type:F.sessionOperatorChange,data:{operator:e.operator}})}},{key:"handleSessionStatus",value:function t(e,i,o){this.store.commit("widget/dialog",{sessionId:e.sessionId,sessionStatus:e.sessionStatus,sessionClose:e.sessionClose});this.widget.sendEvent({type:F.sessionStatus,data:{sessionId:e.sessionId,sessionStatus:e.sessionStatus}});if(e.sessionClose){this.widget.sendEvent({type:F.sessionFinish,data:{sessionId:e.sessionId,sessionStatus:e.sessionStatus}});if(!e.spam){this.store.commit("widget/dialog",{operator:{name:"",firstName:"",lastName:"",workPosition:"",avatar:"",online:false}})}}}},{key:"handleSessionDateCloseVote",value:function t(e,i,o){this.store.dispatch("widget/setVoteDateFinish",e.dateCloseVote)}}]);return t}();var z=function(){function t(){var e=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,t);this.params=i;this.template=null;this.rootNode=this.params.node||document.createElement("div");this.messagesQueue=[];this.ready=true;this.widgetDataRequested=false;this.offline=false;this.inited=false;this.initEventFired=false;this.restClient=null;this.userRegisterData={};this.customData=[];this.options={checkSameDomain:true};this.subscribers={};this.configRequestXhr=null;this.initParams().then(function(){return e.initRestClient()}).then(function(){return e.initPullClient()}).then(function(){return e.initCore()}).then(function(){return e.initWidget()}).then(function(){return e.initUploader()}).then(function(){return e.initComplete()})}babelHelpers.createClass(t,[{key:"initParams",value:function t(){this.code=this.params.code||"";this.host=this.params.host||"";this.language=this.params.language||"en";this.copyright=this.params.copyright!==false;this.copyrightUrl=this.copyright&&this.params.copyrightUrl?this.params.copyrightUrl:"";this.buttonInstance=babelHelpers.typeof(this.params.buttonInstance)==="object"&&this.params.buttonInstance!==null?this.params.buttonInstance:null;this.pageMode=babelHelpers.typeof(this.params.pageMode)==="object"&&this.params.pageMode;if(this.pageMode){this.pageMode.useBitrixLocalize=this.params.pageMode.useBitrixLocalize===true;this.pageMode.placeholder=document.getElementById(this.params.pageMode.placeholder)}if(typeof this.code==="string"){if(this.code.length<=0){console.warn("%cLiveChatWidget.constructor: code is not correct (%c".concat(this.code,"%c)"),"color: black;","font-weight: bold; color: red","color: black");this.ready=false}}if(typeof this.host==="string"){if(this.host.length<=0||!this.host.startsWith("http")){console.warn("%cLiveChatWidget.constructor: host is not correct (%c".concat(this.host,"%c)"),"color: black;","font-weight: bold; color: red","color: black");this.ready=false}}if(this.pageMode&&this.pageMode.placeholder){this.rootNode=this.pageMode.placeholder}else{if(document.body.firstChild){document.body.insertBefore(this.rootNode,document.body.firstChild)}else{document.body.appendChild(this.rootNode)}}this.localize=this.pageMode&&this.pageMode.useBitrixLocalize?window.BX.message:{};if(babelHelpers.typeof(this.params.localize)==="object"){this.addLocalize(this.params.localize)}var e=p.LocalStorage.get(this.getSiteId(),0,"serverVariables",false);if(e){this.addLocalize(e)}return new Promise(function(t,e){return t()})}},{key:"initRestClient",value:function t(){this.restClient=new W({endpoint:this.host+"/rest"});return new Promise(function(t,e){return t()})}},{key:"initPullClient",value:function t(){this.pullClient=new g.PullClient({serverEnabled:true,userId:0,siteId:this.getSiteId(),restClient:this.restClient,skipStorageInit:true,configTimestamp:0,skipCheckRevision:true,getPublicListMethod:"imopenlines.widget.operator.get"});this.pullClientInited=false;return new Promise(function(t,e){return t()})}},{key:"initCore",value:function t(){var e=this;var i={common:{host:this.getHost(),pageMode:this.pageMode!==false,copyright:this.copyright,copyrightUrl:this.copyrightUrl},vote:{messageText:this.getLocalize("BX_LIVECHAT_VOTE_TITLE"),messageLike:this.getLocalize("BX_LIVECHAT_VOTE_PLUS_TITLE"),messageDislike:this.getLocalize("BX_LIVECHAT_VOTE_MINUS_TITLE")},textMessages:{bxLivechatOnlineLine1:this.getLocalize("BX_LIVECHAT_ONLINE_LINE_1"),bxLivechatOnlineLine2:this.getLocalize("BX_LIVECHAT_ONLINE_LINE_2"),bxLivechatOffline:this.getLocalize("BX_LIVECHAT_OFFLINE")}};if(w.Utils.types.isPlainObject(this.params.styles)&&(this.params.styles.backgroundColor||this.params.styles.iconColor)){i.styles={};if(this.params.styles.backgroundColor){i.styles.backgroundColor=this.params.styles.backgroundColor}if(this.params.styles.iconColor){i.styles.iconColor=this.params.styles.iconColor}}this.controller=new m.Controller({host:this.getHost(),siteId:this.getSiteId(),userId:0,languageId:this.language,pull:{client:this.pullClient},rest:{client:this.restClient},localize:this.localize,vuexBuilder:{database:!w.Utils.browser.isIe(),databaseName:"imol/widget",databaseType:D.VuexBuilder.DatabaseType.localStorage,models:[P.create().setVariables(i)]}});return new Promise(function(t,i){e.controller.ready().then(function(){return t()})})}},{key:"initWidget",value:function t(){if(this.isUserRegistered()){this.restClient.setAuthId(this.getUserHash())}else{this.restClient.setAuthId(B.guest)}if(this.params.location&&typeof A[this.params.location]!=="undefined"){this.controller.getStore().commit("widget/common",{location:this.params.location})}this.controller.application.setPrepareFilesBeforeSaveFunction(this.prepareFileData.bind(this));this.controller.addRestAnswerHandler(V.create({widget:this,store:this.controller.getStore(),controller:this.controller}));return new Promise(function(t,e){return t()})}},{key:"initUploader",value:function t(){var e=this;this.uploader=new v.Uploader({generatePreview:true,sender:{host:this.host,customHeaders:{"Livechat-Auth-Id":this.getUserHash()},actionUploadChunk:"imopenlines.widget.disk.upload",actionCommitFile:"imopenlines.widget.disk.commit",actionRollbackUpload:"imopenlines.widget.disk.rollbackUpload"}});this.uploader.subscribe("onStartUpload",function(t){var i=t.getData();b.Logger.log("Uploader: onStartUpload",i);e.controller.getStore().dispatch("files/update",{chatId:e.getChatId(),id:i.id,fields:{status:S.FileStatus.upload,progress:0}})});this.uploader.subscribe("onProgress",function(t){var i=t.getData();b.Logger.log("Uploader: onProgress",i);e.controller.getStore().dispatch("files/update",{chatId:e.getChatId(),id:i.id,fields:{status:S.FileStatus.upload,progress:i.progress===100?99:i.progress}})});this.uploader.subscribe("onSelectFile",function(t){var i=t.getData();var o=i.file;b.Logger.log("Uploader: onSelectFile",i);var s="file";if(o.type.toString().startsWith("image")){s="image"}else if(o.type.toString().startsWith("video")){s="video"}e.controller.getStore().dispatch("files/add",{chatId:e.getChatId(),authorId:e.getUserId(),name:i.file.name,type:s,extension:o.name.split(".").splice(-1)[0],size:i.file.size,image:!i.previewData?false:{width:i.previewDataWidth,height:i.previewDataHeight},status:S.FileStatus.upload,progress:0,authorName:e.controller.application.getCurrentUser().name,urlPreview:i.previewData?URL.createObjectURL(i.previewData):""}).then(function(t){e.addMessage("",{id:t,source:i,previewBlob:i.previewData})})});this.uploader.subscribe("onComplete",function(t){var i=t.getData();b.Logger.log("Uploader: onComplete",i);e.controller.getStore().dispatch("files/update",{chatId:e.getChatId(),id:i.id,fields:{status:S.FileStatus.wait,progress:100}});var o=e.messagesQueue.find(function(t){return t.file.id===i.id});var s=e.controller.getStore().getters["files/get"](e.getChatId(),o.file.id,true).type;e.fileCommit({chatId:e.getChatId(),uploadId:i.result.data.file.id,messageText:o.text,messageId:o.id,fileId:o.file.id,fileType:s},o)});this.uploader.subscribe("onUploadFileError",function(t){var i=t.getData();b.Logger.log("Uploader: onUploadFileError",i);var o=e.messagesQueue.find(function(t){return t.file.id===i.id});if(typeof o==="undefined"){return}e.fileError(e.getChatId(),o.file.id,o.id)});this.uploader.subscribe("onCreateFileError",function(t){var i=t.getData();b.Logger.log("Uploader: onCreateFileError",i);var o=e.messagesQueue.find(function(t){return t.file.id===i.id});e.fileError(e.getChatId(),o.file.id,o.id)});return new Promise(function(t,e){return t()})}},{key:"initComplete",value:function t(){window.dispatchEvent(new CustomEvent("onBitrixLiveChat",{detail:{widget:this,widgetCode:this.code,widgetHost:this.host}}));if(this.callStartFlag){this.start()}if(this.pageMode||this.callOpenFlag){this.open()}return new Promise(function(t,e){return t()})}},{key:"requestWidgetData",value:function t(){var e=this;if(!this.isReady()){console.error("LiveChatWidget.start: widget code or host is not specified");return false}this.widgetDataRequested=true;if(!this.isUserRegistered()&&(this.userRegisterData.hash||this.getUserHashCookie())){this.requestData();this.inited=true;this.fireInitEvent()}else if(this.isConfigDataLoaded()&&this.isUserRegistered()){this.requestData();this.inited=true;this.fireInitEvent()}else{this.controller.restClient.callMethod(R.widgetConfigGet,{code:this.code},function(t){e.configRequestXhr=t}).then(function(t){e.configRequestXhr=null;e.clearError();e.controller.executeRestAnswer(R.widgetConfigGet,t);if(!e.inited){e.inited=true;e.fireInitEvent()}}).catch(function(t){e.configRequestXhr=null;e.setError(t.error().ex.error,t.error().ex.error_description)});if(this.isConfigDataLoaded()){this.inited=true;this.fireInitEvent()}}}},{key:"requestData",value:function t(){var e=this;b.Logger.log("requesting data from widget");if(this.requestDataSend){return true}this.requestDataSend=true;if(this.configRequestXhr){this.configRequestXhr.abort()}var i=babelHelpers.defineProperty({},R.widgetConfigGet,[R.widgetConfigGet,{code:this.code}]);if(this.isUserRegistered()){i[R.widgetDialogGet]=[R.widgetDialogGet,{config_id:this.getConfigId(),trace_data:this.getCrmTraceData(),custom_data:this.getCustomData()}];i[S.RestMethodHandler.imChatGet]=[S.RestMethod.imChatGet,{dialog_id:"$result["+R.widgetDialogGet+"][dialogId]"}];i[S.RestMethodHandler.imDialogMessagesGetInit]=[S.RestMethod.imDialogMessagesGet,{chat_id:"$result["+R.widgetDialogGet+"][chatId]",limit:this.controller.application.getRequestMessageLimit(),convert_text:"Y"}]}else{i[R.widgetUserRegister]=[R.widgetUserRegister,babelHelpers.objectSpread({config_id:"$result["+R.widgetConfigGet+"][configId]"},this.getUserRegisterFields())];i[S.RestMethodHandler.imChatGet]=[S.RestMethod.imChatGet,{dialog_id:"$result["+R.widgetUserRegister+"][dialogId]"}];if(this.userRegisterData.hash||this.getUserHashCookie()){i[R.widgetDialogGet]=[R.widgetDialogGet,{config_id:"$result["+R.widgetConfigGet+"][configId]",trace_data:this.getCrmTraceData(),custom_data:this.getCustomData()}];i[S.RestMethodHandler.imDialogMessagesGetInit]=[S.RestMethod.imDialogMessagesGet,{chat_id:"$result["+R.widgetDialogGet+"][chatId]",limit:this.controller.application.getRequestMessageLimit(),convert_text:"Y"}]}if(this.isUserAgreeConsent()){i[R.widgetUserConsentApply]=[R.widgetUserConsentApply,{config_id:"$result["+R.widgetConfigGet+"][configId]",consent_url:location.href}]}}i[R.pullServerTime]=[R.pullServerTime,{}];i[R.pullConfigGet]=[R.pullConfigGet,{CACHE:"N"}];i[R.widgetUserGet]=[R.widgetUserGet,{}];this.controller.restClient.callBatch(i,function(t){if(!t){e.requestDataSend=false;e.setError("EMPTY_RESPONSE","Server returned an empty response.");return false}var i=t[R.widgetConfigGet];if(i&&i.error()){e.requestDataSend=false;e.setError(i.error().ex.error,i.error().ex.error_description);return false}e.controller.executeRestAnswer(R.widgetConfigGet,i);var o=t[R.widgetUserGet];if(o.error()){e.requestDataSend=false;e.setError(o.error().ex.error,o.error().ex.error_description);return false}e.controller.executeRestAnswer(R.widgetUserGet,o);var s=t[S.RestMethodHandler.imChatGet];if(s.error()){e.requestDataSend=false;e.setError(s.error().ex.error,s.error().ex.error_description);return false}e.controller.executeRestAnswer(S.RestMethodHandler.imChatGet,s);var n=t[R.widgetDialogGet];if(n){if(n.error()){e.requestDataSend=false;e.setError(n.error().ex.error,n.error().ex.error_description);return false}e.controller.executeRestAnswer(R.widgetDialogGet,n)}var a=t[S.RestMethodHandler.imDialogMessagesGetInit];if(a){if(a.error()){e.requestDataSend=false;e.setError(a.error().ex.error,a.error().ex.error_description);return false}e.controller.getStore().dispatch("dialogues/saveDialog",{dialogId:e.controller.application.getDialogId(),chatId:e.controller.application.getChatId()});e.controller.executeRestAnswer(S.RestMethodHandler.imDialogMessagesGetInit,a)}var r=t[R.widgetUserRegister];if(r){if(r.error()){e.requestDataSend=false;e.setError(r.error().ex.error,r.error().ex.error_description);return false}e.controller.executeRestAnswer(R.widgetUserRegister,r)}var l=0;var c=t[R.pullServerTime];if(c&&!c.error()){l=Math.floor(((new Date).getTime()-new Date(c.data()).getTime())/1e3)}var d=null;var h=t[R.pullConfigGet];if(h&&!h.error()){d=h.data();d.server.timeShift=l}e.startPullClient(d).then(function(){e.processSendMessages()}).catch(function(t){e.setError(t.ex.error,t.ex.error_description)});e.requestDataSend=false},false,false,w.Utils.getLogTrackingParams({name:"widget.init.config",dialog:this.controller.application.getDialogData()}))}},{key:"prepareFileData",value:function t(e){var i=this;if(!w.Utils.types.isArray(e)){return e}return e.map(function(t){var e=(window.md5||C.md5)(i.getUserId()+"|"+t.id+"|"+i.getUserHash());var o="livechat_auth_id="+e+"&livechat_user_id="+i.getUserId();if(t.urlPreview){t.urlPreview=t.urlPreview+"&"+o}if(t.urlShow){t.urlShow=t.urlShow+"&"+o}if(t.urlDownload){t.urlDownload=t.urlDownload+"&"+o}return t})}},{key:"checkBrowserVersion",value:function t(){if(w.Utils.platform.isIos()){var e=w.Utils.platform.getIosVersion();if(e&&e<=10){return false}}return true}},{key:"isSameDomain",value:function t(){if(typeof BX==="undefined"||!BX.isReady){return false}if(!this.options.checkSameDomain){return false}return this.host.lastIndexOf("."+location.hostname)>-1}},{key:"startPullClient",value:function t(e){var i=this;var o=new BX.Promise;if(!this.getUserId()||!this.getSiteId()||!this.restClient){o.reject({ex:{error:"WIDGET_NOT_LOADED",error_description:"Widget is not loaded."}});return o}if(this.pullClientInited){if(!this.pullClient.isConnected()){this.pullClient.scheduleReconnect()}o.resolve(true);return o}this.controller.userId=this.getUserId();this.pullClient.userId=this.getUserId();this.pullClient.configTimestamp=e?e.server.config_timestamp:0;this.pullClient.skipStorageInit=false;this.pullClient.storage=g.PullClient.StorageManager({userId:this.getUserId(),siteId:this.getSiteId()});this.pullClient.subscribe(new X({store:this.controller.getStore(),controller:this.controller,widget:this}));this.pullClient.subscribe(new q({store:this.controller.getStore(),controller:this.controller,widget:this}));this.pullClient.subscribe({type:g.PullClient.SubscriptionType.Status,callback:this.eventStatusInteraction.bind(this)});this.pullConnectedFirstTime=this.pullClient.subscribe({type:g.PullClient.SubscriptionType.Status,callback:function t(e){if(e.status===g.PullClient.PullStatus.Online){o.resolve(true);i.pullConnectedFirstTime()}}});if(this.template){this.template.$Bitrix.PullClient.set(this.pullClient)}this.pullClient.start(babelHelpers.objectSpread({},e,{skipReconnectToLastSession:true})).catch(function(){o.reject({ex:{error:"PULL_CONNECTION_ERROR",error_description:"Pull is not connected."}})});this.pullClientInited=true;return o}},{key:"stopPullClient",value:function t(){if(this.pullClient){this.pullClient.stop(g.PullClient.CloseReasons.MANUAL,"Closed manually")}}},{key:"recoverPullConnection",value:function t(){this.pullClient.restart(g.PullClient.CloseReasons.MANUAL,"Restart after click by connection status button.")}},{key:"eventStatusInteraction",value:function t(e){var i=this;if(e.status===g.PullClient.PullStatus.Online){this.offline=false;if(this.pullRequestMessage){this.controller.pullBaseHandler.option.skip=true;b.Logger.warn("Requesting getDialogUnread after going online");x.EventEmitter.emitAsync(S.EventType.dialog.requestUnread,{chatId:this.controller.application.getChatId()}).then(function(){x.EventEmitter.emit(S.EventType.dialog.scrollOnStart,{chatId:i.controller.application.getChatId()});i.controller.pullBaseHandler.option.skip=false;i.processSendMessages()}).catch(function(){i.controller.pullBaseHandler.option.skip=false});this.pullRequestMessage=false}else{this.readMessage();this.processSendMessages()}}else if(e.status===g.PullClient.PullStatus.Offline){this.pullRequestMessage=true;this.offline=true}}},{key:"attachTemplate",value:function t(){if(this.template){this.controller.getStore().commit("widget/common",{showed:true});return true}this.rootNode.innerHTML="";this.rootNode.appendChild(document.createElement("div"));var e=this;return this.controller.createVue(e,{el:this.rootNode.firstChild,template:"<bx-livechat/>",beforeCreate:function t(){e.sendEvent({type:F.widgetOpen,data:{}});e.template=this;if(I.ZIndexManager!==undefined){var i=I.ZIndexManager.getOrAddStack(document.body);i.setBaseIndex(1e6);this.$bitrix.Data.set("zIndexStack",i)}},destroyed:function t(){e.sendEvent({type:F.widgetClose,data:{}});e.template=null;e.templateAttached=false;e.rootNode.innerHTML=""}}).then(function(){return new Promise(function(t,e){return t()})})}},{key:"detachTemplate",value:function t(){if(!this.template){return true}this.template.$destroy();return true}},{key:"mutateTemplateComponent",value:function t(e,i){return M.Vue.mutateComponent(e,i)}},{key:"addMessage",value:function t(){var e=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var o=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!i&&!o){return false}var s=this.controller.getStore().getters["dialogues/getQuoteId"](this.controller.application.getDialogId());if(s){var n=this.controller.getStore().getters["messages/getMessage"](this.controller.application.getChatId(),s);if(n){var a=null;if(n.authorId){a=this.controller.getStore().getters["users/get"](n.authorId)}var r=this.controller.getStore().getters["files/getList"](this.controller.application.getChatId());var l=[];l.push("-".repeat(54));l.push((a&&a.name?a.name:this.getLocalize("BX_LIVECHAT_SYSTEM_MESSAGE"))+" ["+w.Utils.date.format(n.date,null,this.getLocalize())+"]");l.push(w.Utils.text.quote(n.text,n.params,r,this.getLocalize()));l.push("-".repeat(54));l.push(i);i=l.join("\n");this.quoteMessageClear()}}b.Logger.warn("addMessage",i,o);if(!this.controller.application.isUnreadMessagesLoaded()){this.sendMessage({id:0,text:i,file:o});this.processSendMessages();return true}var c={};if(o){c.FILE_ID=[o.id]}this.controller.getStore().dispatch("messages/add",{chatId:this.getChatId(),authorId:this.getUserId(),text:i,params:c,sending:!o}).then(function(t){if(!e.isDialogStart()){e.controller.getStore().commit("widget/common",{dialogStart:true})}x.EventEmitter.emit(S.EventType.dialog.scrollToBottom,{chatId:e.getChatId(),cancelIfScrollChange:true});e.messagesQueue.push({id:t,text:i,file:o,sending:false});if(e.getChatId()){e.processSendMessages()}else{e.requestData()}});return true}},{key:"uploadFile",value:function t(e){if(!e){return false}if(!this.getChatId()){this.requestData()}this.uploader.addFilesFromEvent(e)}},{key:"cancelUploadFile",value:function t(e){var i=this;var o=this.messagesQueue.find(function(t){return t.file&&t.file.id===e});if(o){this.uploader.deleteTask(e);if(o.xhr){o.xhr.abort()}this.controller.getStore().dispatch("messages/delete",{chatId:this.getChatId(),id:o.id}).then(function(){i.controller.getStore().dispatch("files/delete",{chatId:i.getChatId(),id:o.file.id});i.messagesQueue=i.messagesQueue.filter(function(t){return t.id!==o.id})})}}},{key:"processSendMessages",value:function t(){var e=this;if(!this.getDiskFolderId()){this.requestDiskFolderId().then(function(){e.processSendMessages()}).catch(function(){b.Logger.warn("uploadFile","Error get disk folder id");return false});return false}if(this.offline){return false}this.messagesQueue.filter(function(t){return!t.sending}).forEach(function(t){t.sending=true;if(t.file){e.sendMessageWithFile(t)}else{e.sendMessage(t)}});return true}},{key:"sendMessage",value:function t(e){var i=this;this.controller.application.stopWriting();var o=this.controller.getStore().getters["dialogues/getQuoteId"](this.getDialogId());if(o){var s=this.controller.getStore().getters["messages/getMessage"](this.getChatId(),o);if(s){var n=this.controller.getStore().getters["users/get"](s.authorId);var a=[];a.push("------------------------------------------------------");a.push(n.name?n.name:this.getLocalize("BX_LIVECHAT_SYSTEM_MESSAGE"));a.push(s.text);a.push("------------------------------------------------------");a.push(e.text);e.text=a.join("\n");this.quoteMessageClear()}}e.chatId=this.getChatId();this.controller.restClient.callMethod(S.RestMethod.imMessageAdd,{TEMPLATE_ID:e.id,CHAT_ID:e.chatId,MESSAGE:e.text},null,null,w.Utils.getLogTrackingParams({name:S.RestMethod.imMessageAdd,data:{timMessageType:"text"},dialog:this.getDialogData()})).then(function(t){i.controller.executeRestAnswer(S.RestMethodHandler.imMessageAdd,t,e)}).catch(function(t){i.controller.executeRestAnswer(S.RestMethodHandler.imMessageAdd,t,e)});return true}},{key:"sendMessageWithFile",value:function t(e){this.controller.application.stopWriting();var i=this.getDiskFolderId();e.chatId=this.getChatId();this.uploader.senderOptions.customHeaders["Livechat-Dialog-Id"]=this.getDialogId();this.uploader.senderOptions.customHeaders["Livechat-Auth-Id"]=this.getUserHash();this.uploader.addTask({taskId:e.file.id,fileData:e.file.source.file,fileName:e.file.source.file.name,generateUniqueName:true,diskFolderId:i,previewBlob:e.file.previewBlob,chunkSize:this.localize.isCloud?v.Uploader.CLOUD_MAX_CHUNK_SIZE:v.Uploader.BOX_MIN_CHUNK_SIZE})}},{key:"fileError",value:function t(e,i){var o=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;this.controller.getStore().dispatch("files/update",{chatId:e,id:i,fields:{status:S.FileStatus.error,progress:0}});if(o){this.controller.getStore().dispatch("messages/actionError",{chatId:e,id:o,retry:false})}}},{key:"requestDiskFolderId",value:function t(){var e=this;if(this.requestDiskFolderPromise){return this.requestDiskFolderPromise}this.requestDiskFolderPromise=new Promise(function(t,i){if(e.flagRequestDiskFolderIdSended||e.getDiskFolderId()){e.flagRequestDiskFolderIdSended=false;t();return true}e.flagRequestDiskFolderIdSended=true;e.controller.restClient.callMethod(S.RestMethod.imDiskFolderGet,{chat_id:e.controller.application.getChatId()}).then(function(i){e.controller.executeRestAnswer(S.RestMethodHandler.imDiskFolderGet,i);e.flagRequestDiskFolderIdSended=false;t()}).catch(function(t){e.flagRequestDiskFolderIdSended=false;e.controller.executeRestAnswer(S.RestMethodHandler.imDiskFolderGet,t);i()})});return this.requestDiskFolderPromise}},{key:"fileCommit",value:function t(e,i){var o=this;this.controller.restClient.callMethod(S.RestMethod.imDiskFileCommit,{chat_id:e.chatId,upload_id:e.uploadId,message:e.messageText,template_id:e.messageId,file_template_id:e.fileId},null,null,w.Utils.getLogTrackingParams({name:S.RestMethod.imDiskFileCommit,data:{timMessageType:e.fileType},dialog:this.getDialogData()})).then(function(t){o.controller.executeRestAnswer(S.RestMethodHandler.imDiskFileCommit,t,i)}).catch(function(t){o.controller.executeRestAnswer(S.RestMethodHandler.imDiskFileCommit,t,i)});return true}},{key:"getDialogHistory",value:function t(e){var i=this;var o=arguments.length>1&&arguments[1]!==undefined?arguments[1]:this.controller.application.getRequestMessageLimit();this.controller.restClient.callMethod(S.RestMethod.imDialogMessagesGet,{CHAT_ID:this.getChatId(),LAST_ID:e,LIMIT:o,CONVERT_TEXT:"Y"}).then(function(t){i.controller.executeRestAnswer(S.RestMethodHandler.imDialogMessagesGet,t);i.template.$emit(S.EventType.dialog.requestHistoryResult,{count:t.data().messages.length})}).catch(function(t){i.template.$emit(S.EventType.dialog.requestHistoryResult,{error:t.error().ex})})}},{key:"getDialogUnread",value:function t(e){var i=this;var o=arguments.length>1&&arguments[1]!==undefined?arguments[1]:this.controller.application.getRequestMessageLimit();var s=new BX.Promise;if(!e){e=this.controller.getStore().getters["messages/getLastId"](this.controller.application.getChatId())}if(!e){this.template.$emit(S.EventType.dialog.requestUnreadResult,{error:{error:"LAST_ID_EMPTY",error_description:"LastId is empty."}});s.reject();return s}this.controller.application.readMessage(e,true,true).then(function(){var t;var n=(t={},babelHelpers.defineProperty(t,S.RestMethodHandler.imDialogRead,[S.RestMethod.imDialogRead,{dialog_id:i.getDialogId(),message_id:e}]),babelHelpers.defineProperty(t,S.RestMethodHandler.imChatGet,[S.RestMethod.imChatGet,{dialog_id:i.getDialogId()}]),babelHelpers.defineProperty(t,S.RestMethodHandler.imDialogMessagesGetUnread,[S.RestMethod.imDialogMessagesGet,{chat_id:i.getChatId(),first_id:e,limit:o,convert_text:"Y"}]),t);i.controller.restClient.callBatch(n,function(t){if(!t){i.template.$emit(S.EventType.dialog.requestUnreadResult,{error:{error:"EMPTY_RESPONSE",error_description:"Server returned an empty response."}});s.reject();return false}var e=t[S.RestMethodHandler.imChatGet];if(!e.error()){i.controller.executeRestAnswer(S.RestMethodHandler.imChatGet,e)}var o=t[S.RestMethodHandler.imDialogMessagesGetUnread];if(o.error()){i.template.$emit(S.EventType.dialog.requestUnreadResult,{error:o.error().ex})}else{i.controller.executeRestAnswer(S.RestMethodHandler.imDialogMessagesGetUnread,o);i.template.$emit(S.EventType.dialog.requestUnreadResult,{firstMessageId:o.data().messages.length>0?o.data().messages[0].id:0,count:o.data().messages.length})}s.fulfill(t)},false,false,w.Utils.getLogTrackingParams({name:S.RestMethodHandler.imDialogMessagesGetUnread,dialog:i.getDialogData()}))});return s}},{key:"retrySendMessage",value:function t(e){if(this.messagesQueue.find(function(t){return t.id===e.id})){return false}this.messagesQueue.push({id:e.id,text:e.text,sending:false});this.controller.application.setSendingMessageFlag(e.id);this.processSendMessages()}},{key:"readMessage",value:function t(e){if(this.offline){return false}return this.controller.application.readMessage(e)}},{key:"reactMessage",value:function t(e,i){this.controller.application.reactMessage(e,i.type,i.action)}},{key:"execMessageKeyboardCommand",value:function t(e){if(e.action==="ACTION"&&e.params.action==="LIVECHAT"){var i=e.params,o=i.dialogId,s=i.messageId;var n=JSON.parse(e.params.value);var a=parseInt(n.SESSION_ID);if(a!==this.getSessionId()||this.isSessionClose()){alert(this.localize.BX_LIVECHAT_ACTION_EXPIRED);return false}this.controller.restClient.callMethod(R.widgetActionSend,{MESSAGE_ID:s,DIALOG_ID:o,ACTION_VALUE:e.params.value});return true}if(e.action!=="COMMAND"){return false}var r=e.params,l=r.dialogId,c=r.messageId,d=r.botId,h=r.command,g=r.params;this.controller.restClient.callMethod(S.RestMethod.imMessageCommand,{MESSAGE_ID:c,DIALOG_ID:l,BOT_ID:d,COMMAND:h,COMMAND_PARAMS:g});return true}},{key:"quoteMessageClear",value:function t(){this.controller.getStore().dispatch("dialogues/update",{dialogId:this.controller.application.getDialogId(),fields:{quoteId:0}})}},{key:"sendDialogVote",value:function t(e){var i=this;if(!this.getSessionId()){return false}this.controller.restClient.callMethod(R.widgetVoteSend,{SESSION_ID:this.getSessionId(),ACTION:e}).catch(function(t){i.controller.getStore().commit("widget/dialog",{userVote:T.none})});this.sendEvent({type:F.userVote,data:{vote:e}})}},{key:"getHtmlHistory",value:function t(){var e=this.getChatId();if(e<=0){console.error("Incorrect chatId value")}var i={chatId:this.getChatId()};this.requestControllerAction("imopenlines.widget.history.download",i).then(function(t){var e=t.headers.get("Content-Type");if(e.startsWith("application/json")){return t.json()}return t.blob()}).then(function(t){if(t instanceof Blob){var i=window.URL.createObjectURL(t);var o=document.createElement("a");o.href=i;o.download=e+".html";document.body.appendChild(o);o.click();o.remove()}else if(t.hasOwnProperty("errors")){console.error(t.errors[0])}else{console.error("Unknown error.")}}).catch(function(){return console.error("Fetch error.")})}},{key:"requestControllerAction",value:function t(e,i){var o=this.host?this.host:"";var s="/bitrix/services/main/ajax.php";var n=new URL(s,o);n.searchParams.set("action",e);var a=new FormData;for(var r in i){if(i.hasOwnProperty(r)){a.append(r,i[r])}}return fetch(n,{method:"POST",headers:{"Livechat-Auth-Id":this.getUserHash()},body:a})}},{key:"sendConsentDecision",value:function t(e){e=e===true;this.controller.getStore().commit("widget/dialog",{userConsent:e});if(e&&this.isUserRegistered()){this.controller.restClient.callMethod(R.widgetUserConsentApply,{config_id:this.getConfigId(),consent_url:location.href})}}},{key:"start",value:function t(){if(!this.controller||!this.controller.getStore()){this.callStartFlag=true;return true}if(this.isSessionActive()){this.requestWidgetData()}return true}},{key:"open",value:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};clearTimeout(this.openTimeout);if(!this.controller.getStore()){this.callOpenFlag=true;return true}if(!e.openFromButton&&this.buttonInstance){this.buttonInstance.wm.showById("openline_livechat")}if(!this.checkBrowserVersion()){this.setError("OLD_BROWSER_LOCALIZED",this.localize.BX_LIVECHAT_OLD_BROWSER)}else if(w.Utils.versionCompare(M.Vue.version(),"2.1")<0){alert(this.localize.BX_LIVECHAT_OLD_VUE);console.error("LiveChatWidget.error: OLD_VUE_VERSION (".concat(this.localize.BX_LIVECHAT_OLD_VUE_DEV.replace("#CURRENT_VERSION#",M.Vue.version()),")"));return false}else if(this.isSameDomain()){this.setError("LIVECHAT_SAME_DOMAIN",this.localize.BX_LIVECHAT_SAME_DOMAIN)}else if(!this.isWidgetDataRequested()){this.requestWidgetData()}this.attachTemplate()}},{key:"close",value:function t(){if(this.pageMode){return false}if(this.buttonInstance){this.buttonInstance.onWidgetClose()}this.detachTemplate()}},{key:"showNotification",value:function t(e){if(!this.controller||!this.controller.getStore()){console.error("LiveChatWidget.showNotification: method can be called after fired event - onBitrixLiveChat");return false}}},{key:"fireInitEvent",value:function t(){if(this.initEventFired){return true}this.sendEvent({type:F.configLoaded,data:{}});if(this.controller.getStore().state.widget.common.reopen){this.open()}this.initEventFired=true;return true}},{key:"isReady",value:function t(){return this.ready}},{key:"isInited",value:function t(){return this.inited}},{key:"isUserRegistered",value:function t(){return!!this.getUserHash()}},{key:"isConfigDataLoaded",value:function t(){return this.controller.getStore().state.widget.common.configId}},{key:"isWidgetDataRequested",value:function t(){return this.widgetDataRequested}},{key:"isChatLoaded",value:function t(){return this.controller.getStore().state.application.dialog.chatId>0}},{key:"isSessionActive",value:function t(){return!this.controller.getStore().state.widget.dialog.sessionClose}},{key:"isUserAgreeConsent",value:function t(){return this.controller.getStore().state.widget.dialog.userConsent}},{key:"getCrmTraceData",value:function t(){var e="";if(!this.buttonInstance){return e}if(typeof this.buttonInstance.getTrace!=="function"){e=this.buttonInstance.getTrace()}else if(typeof this.buttonInstance.b24Tracker!=="undefined"&&typeof this.buttonInstance.b24Tracker.guest!=="undefined"){e=this.buttonInstance.b24Tracker.guest.getTrace()}return e}},{key:"getCustomData",value:function t(){var e=[];if(this.customData.length>0){e=this.customData}else{e=[{MESSAGE:this.localize.BX_LIVECHAT_EXTRA_SITE+": [URL]"+location.href+"[/URL]"}]}return JSON.stringify(e)}},{key:"isUserLoaded",value:function t(){return this.controller.getStore().state.widget.user.id>0}},{key:"getSiteId",value:function t(){return this.host.replace(/(http.?:\/\/)|([:.\\\/])/gm,"")+this.code}},{key:"getHost",value:function t(){return this.host}},{key:"getConfigId",value:function t(){return this.controller.getStore().state.widget.common.configId}},{key:"isDialogStart",value:function t(){return this.controller.getStore().state.widget.common.dialogStart}},{key:"getChatId",value:function t(){return this.controller.getStore().state.application.dialog.chatId}},{key:"getDialogId",value:function t(){return this.controller.getStore().state.application.dialog.dialogId}},{key:"getDiskFolderId",value:function t(){return this.controller.getStore().state.application.dialog.diskFolderId}},{key:"getDialogData",value:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:this.getDialogId();return this.controller.getStore().state.dialogues.collection[e]}},{key:"getSessionId",value:function t(){return this.controller.getStore().state.widget.dialog.sessionId}},{key:"isSessionClose",value:function t(){return this.controller.getStore().state.widget.dialog.sessionClose}},{key:"getUserHash",value:function t(){return this.controller.getStore().state.widget.user.hash}},{key:"getUserHashCookie",value:function t(){var e="";var i=f.Cookie.get(null,"LIVECHAT_HASH");if(typeof i==="string"&&i.match(/^[a-f0-9]{32}$/)){e=i}else{var o=f.Cookie.get(this.getSiteId(),"LIVECHAT_HASH");if(typeof o==="string"&&o.match(/^[a-f0-9]{32}$/)){e=o}}return e}},{key:"getUserId",value:function t(){return this.controller.getStore().state.widget.user.id}},{key:"getUserData",value:function t(){if(!this.controller||!this.controller.getStore()){console.error("LiveChatWidget.getUserData: method can be called after fired event - onBitrixLiveChat");return false}return this.controller.getStore().state.widget.user}},{key:"getUserRegisterFields",value:function t(){return{name:this.userRegisterData.name||"",last_name:this.userRegisterData.lastName||"",avatar:this.userRegisterData.avatar||"",email:this.userRegisterData.email||"",www:this.userRegisterData.www||"",gender:this.userRegisterData.gender||"",position:this.userRegisterData.position||"",user_hash:this.userRegisterData.hash||this.getUserHashCookie()||"",consent_url:this.controller.getStore().state.widget.common.consentUrl?location.href:"",trace_data:this.getCrmTraceData(),custom_data:this.getCustomData()}}},{key:"getWidgetLocationCode",value:function t(){return A[this.controller.getStore().state.widget.common.location]}},{key:"setUserRegisterData",value:function t(e){if(!this.controller||!this.controller.getStore()){console.error("LiveChatWidget.getUserData: method can be called after fired event - onBitrixLiveChat");return false}var i=["hash","name","lastName","avatar","email","www","gender","position"];if(!w.Utils.types.isPlainObject(e)){console.error("%cLiveChatWidget.setUserData: params is not a object","color: black;");return false}for(var o in this.userRegisterData){if(!this.userRegisterData.hasOwnProperty(o)){continue}if(!e[o]){delete this.userRegisterData[o]}}for(var s in e){if(!e.hasOwnProperty(s)){continue}if(i.indexOf(s)===-1){console.warn("%cLiveChatWidget.setUserData: user field is not set, because you are trying to set an unknown field (%c".concat(s,"%c)"),"color: black;","font-weight: bold; color: red","color: black");continue}this.userRegisterData[s]=e[s]}if(this.userRegisterData.hash&&this.getUserHash()&&this.userRegisterData.hash!==this.getUserHash()){this.setNewAuthToken(this.userRegisterData.hash)}}},{key:"setNewAuthToken",value:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";this.controller.getStoreBuilder().clearModelState();f.Cookie.set(null,"LIVECHAT_HASH","",{expires:365*86400,path:"/"});this.controller.restClient.setAuthId(B.guest,e)}},{key:"setOption",value:function t(e,i){this.options[e]=i;return true}},{key:"setCustomData",value:function t(e){if(!this.controller||!this.controller.getStore()){console.error("LiveChatWidget.getUserData: method can be called after fired event - onBitrixLiveChat");return false}var i=[];if(e instanceof Array){e.forEach(function(t){if(t&&babelHelpers.typeof(t)==="object"){i.push(t)}});if(i.length<=0){console.error("LiveChatWidget.setCustomData: params is empty");return false}}else{if(!e){return false}i=[{MESSAGE:e}]}this.customData=this.customData.concat(i);return true}},{key:"setError",value:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";console.error("LiveChatWidget.error: ".concat(e," (").concat(i,")"));var o="";if(e==="LIVECHAT_AUTH_FAILED"){o=this.getLocalize("BX_LIVECHAT_AUTH_FAILED").replace("#LINK_START#",'<a href="javascript:void();" onclick="location.reload()">').replace("#LINK_END#","</a>");this.setNewAuthToken()}else if(e==="LIVECHAT_AUTH_PORTAL_USER"){o=this.getLocalize("BX_LIVECHAT_PORTAL_USER_NEW").replace("#LINK_START#",'<a href="'+this.host+'">').replace("#LINK_END#","</a>")}else if(e==="LIVECHAT_SAME_DOMAIN"){o=this.getLocalize("BX_LIVECHAT_SAME_DOMAIN");var s=this.getLocalize("BX_LIVECHAT_SAME_DOMAIN_LINK");if(s){o+='<br><br><a href="'+s+'">'+this.getLocalize("BX_LIVECHAT_SAME_DOMAIN_MORE")+"</a>"}}else if(e.endsWith("LOCALIZED")){o=i}this.controller.getStore().commit("application/set",{error:{active:true,code:e,description:o}})}},{key:"clearError",value:function t(){this.controller.getStore().commit("application/set",{error:{active:false,code:"",description:""}})}},{key:"subscribe",value:function t(e){if(!w.Utils.types.isPlainObject(e)){console.error("%cLiveChatWidget.subscribe: params is not a object","color: black;");return false}if(!H.includes(e.type)){console.error("%cLiveChatWidget.subscribe: subscription type is not correct (%c".concat(e.type,"%c)"),"color: black;","font-weight: bold; color: red","color: black");return false}if(typeof e.callback!=="function"){console.error("%cLiveChatWidget.subscribe: callback is not a function (%c".concat(babelHelpers.typeof(e.callback),"%c)"),"color: black;","font-weight: bold; color: red","color: black");return false}if(typeof this.subscribers[e.type]==="undefined"){this.subscribers[e.type]=[]}this.subscribers[e.type].push(e.callback);return function(){this.subscribers[e.type]=this.subscribers[e.type].filter(function(t){return t!==e.callback})}.bind(this)}},{key:"sendEvent",value:function t(e){e=e||{};if(!e.type){return false}if(babelHelpers.typeof(e.data)!=="object"||!e.data){e.data={}}if(this.subscribers[e.type]instanceof Array&&this.subscribers[e.type].length>0){this.subscribers[e.type].forEach(function(t){return t(e.data)})}if(this.subscribers[F.every]instanceof Array&&this.subscribers[F.every].length>0){this.subscribers[F.every].forEach(function(t){return t({type:e.type,data:e.data})})}return true}},{key:"addLocalize",value:function t(e){if(babelHelpers.typeof(e)!=="object"||!e){return false}for(var i in e){if(e.hasOwnProperty(i)){this.localize[i]=e[i]}}return true}},{key:"getLocalize",value:function t(e){var i="";if(typeof e==="undefined"){return this.localize}else if(typeof this.localize[e.toString()]==="undefined"){console.warn("LiveChatWidget.getLocalize: message with code '".concat(e.toString(),"' is undefined."))}else{i=this.localize[e]}return i}}]);return t}();var G=function(){function t(e){babelHelpers.classCallCheck(this,t);this.developerInfo="Do not use private methods.";this.__privateMethods__=new z(e);this.__createLegacyMethods()}babelHelpers.createClass(t,[{key:"open",value:function t(e){return this.__privateMethods__.open(e)}},{key:"close",value:function t(){return this.__privateMethods__.close()}},{key:"showNotification",value:function t(e){return this.__privateMethods__.showNotification(e)}},{key:"getUserData",value:function t(){return this.__privateMethods__.getUserData()}},{key:"setUserRegisterData",value:function t(e){return this.__privateMethods__.setUserRegisterData(e)}},{key:"setCustomData",value:function t(e){return this.__privateMethods__.setCustomData(e)}},{key:"mutateTemplateComponent",value:function t(e,i){return this.__privateMethods__.mutateTemplateComponent(e,i)}},{key:"addLocalize",value:function t(e){return this.__privateMethods__.addLocalize(e)}},{key:"subscribe",value:function t(e){return this.__privateMethods__.subscribe(e)}},{key:"start",value:function t(){return this.__privateMethods__.start()}},{key:"__createLegacyMethods",value:function t(){var e=this;if(typeof window.BX.LiveChat==="undefined"){var i=document.createElement("a");i.href=this.__privateMethods__.host;var o=i.protocol+"//"+i.hostname+(i.port&&i.port!="80"&&i.port!="443"?":"+i.port:"");window.BX.LiveChat={openLiveChat:function t(){e.open({openFromButton:true})},closeLiveChat:function t(){e.close()},addEventListener:function t(i,s,n){if(s==="message"){e.subscribe({type:F.userMessage,callback:function t(e){n({origin:o,data:JSON.stringify({action:"sendMessage"}),event:e})}})}else{console.warn("Method BX.LiveChat.addEventListener is not supported, user new format for subscribe.")}},setCookie:function t(){},getCookie:function t(){},sourceDomain:o}}if(typeof window.BxLiveChatInit==="function"){var s=window.BxLiveChatInit();if(s.user){this.__privateMethods__.setUserRegisterData(s.user)}if(s.firstMessage){this.__privateMethods__.setCustomData(s.firstMessage)}}if(window.BxLiveChatLoader instanceof Array){window.BxLiveChatLoader.forEach(function(t){return t()})}return true}}]);return t}();M.BitrixVue.component("bx-livechat",{mixins:[y.DialogCore,y.TextareaCore,y.TextareaUploadFile,y.DialogReadMessages,y.DialogClickOnCommand,y.DialogClickOnUserName,y.DialogClickOnKeyboardButton,y.DialogClickOnMessageMenu,y.DialogClickOnMessageRetry,y.DialogSetMessageReaction,y.DialogClickOnUploadCancel],data:function t(){return{viewPortMetaSiteNode:null,viewPortMetaWidgetNode:null,storedMessage:"",storedFile:null,widgetMinimumHeight:435,widgetMinimumWidth:340,widgetBaseHeight:557,widgetBaseWidth:435,widgetMargin:50,widgetAvailableHeight:0,widgetAvailableWidth:0,widgetCurrentHeight:0,widgetCurrentWidth:0,widgetDrag:false,textareaFocused:false,textareaDrag:false,textareaHeight:100,textareaMinimumHeight:100,textareaMaximumHeight:w.Utils.device.isMobile()?200:300,zIndexStackInstance:null,welcomeFormFilled:false}},created:function t(){b.Logger.warn("bx-livechat created");this.onCreated();document.addEventListener("keydown",this.onWindowKeyDown);if(!w.Utils.device.isMobile()&&!this.widget.common.pageMode){window.addEventListener("resize",this.getAvailableSpaceFunc=w.Utils.throttle(this.getAvailableSpace,50))}x.EventEmitter.subscribe(N.requestShowForm,this.onRequestShowForm)},mounted:function t(){if(this.widget.user.id>0){this.welcomeFormFilled=true}this.zIndexStackInstance=this.$Bitrix.Data.get("zIndexStack");if(this.zIndexStackInstance&&!!this.$refs.widgetWrapper){this.zIndexStackInstance.register(this.$refs.widgetWrapper)}},beforeDestroy:function t(){if(this.zIndexStackInstance){this.zIndexStackInstance.unregister(this.$refs.widgetWrapper)}document.removeEventListener("keydown",this.onWindowKeyDown);if(!w.Utils.device.isMobile()&&!this.widget.common.pageMode){window.removeEventListener("resize",this.getAvailableSpaceFunc)}x.EventEmitter.unsubscribe(N.requestShowForm,this.onRequestShowForm);this.onTextareaDragEventRemove()},computed:babelHelpers.objectSpread({FormType:function t(){return E},VoteType:function t(){return T},DeviceType:function t(){return S.DeviceType},EventType:function t(){return S.EventType},showTextarea:function t(){var e=this.widget.common.crmFormsSettings;if(!e.useWelcomeForm||!e.welcomeFormId){return true}else{if(e.welcomeFormDelay){return true}else{return this.welcomeFormFilled}}},showWelcomeForm:function t(){return this.widget.common.crmFormsSettings.useWelcomeForm&&!this.widget.common.crmFormsSettings.welcomeFormDelay&&this.widget.common.crmFormsSettings.welcomeFormId&&!this.welcomeFormFilled},textareaHeightStyle:function t(){return{flex:"0 0 "+this.textareaHeight+"px"}},textareaBottomMargin:function t(){if(!this.widget.common.copyright&&!this.isBottomLocation){return{marginBottom:"5px"}}return""},widgetBaseSizes:function t(){return{width:this.widgetBaseWidth,height:this.widgetBaseHeight}},widgetHeightStyle:function t(){if(w.Utils.device.isMobile()||this.widget.common.pageMode){return}if(this.widgetAvailableHeight<this.widgetBaseSizes.height||this.widgetAvailableHeight<this.widgetCurrentHeight){this.widgetCurrentHeight=Math.max(this.widgetAvailableHeight,this.widgetMinimumHeight)}return this.widgetCurrentHeight+"px"},widgetWidthStyle:function t(){if(w.Utils.device.isMobile()||this.widget.common.pageMode){return}if(this.widgetAvailableWidth<this.widgetBaseSizes.width||this.widgetAvailableWidth<this.widgetCurrentWidth){this.widgetCurrentWidth=Math.max(this.widgetAvailableWidth,this.widgetMinimumWidth)}return this.widgetCurrentWidth+"px"},userSelectStyle:function t(){return this.widgetDrag?"none":"auto"},isBottomLocation:function t(){return[_.bottomLeft,_.bottomMiddle,_.bottomRight].includes(this.widget.common.location)},isLeftLocation:function t(){return[_.bottomLeft,_.topLeft,_.topMiddle].includes(this.widget.common.location)},localize:function t(){return M.BitrixVue.getFilteredPhrases("BX_LIVECHAT_",this)},widgetMobileDisabled:function t(e){if(e.application.device.type===S.DeviceType.mobile){if(navigator.userAgent.toString().includes("iPad"));else if(e.application.device.orientation===S.DeviceOrientation.horizontal){if(navigator.userAgent.toString().includes("iPhone")){return true}else{return!(babelHelpers.typeof(window.screen)==="object"&&window.screen.availHeight>=800)}}}return false},widgetClassName:function t(e){var i=["bx-livechat-wrapper"];i.push("bx-livechat-show");if(e.widget.common.pageMode){i.push("bx-livechat-page-mode")}else{i.push("bx-livechat-position-"+A[e.widget.common.location])}if(e.application.common.languageId===L.russian){i.push("bx-livechat-logo-ru")}else if(e.application.common.languageId===L.ukraine){i.push("bx-livechat-logo-ua")}else{i.push("bx-livechat-logo-en")}if(!e.widget.common.online){i.push("bx-livechat-offline-state")}if(e.widget.common.dragged){i.push("bx-livechat-drag-n-drop")}if(e.widget.common.dialogStart){i.push("bx-livechat-chat-start")}if(e.widget.dialog.operator.name&&!(e.application.device.type===S.DeviceType.mobile&&e.application.device.orientation===S.DeviceOrientation.horizontal)){i.push("bx-livechat-has-operator")}if(w.Utils.device.isMobile()){i.push("bx-livechat-mobile")}else if(w.Utils.browser.isSafari()){i.push("bx-livechat-browser-safari")}else if(w.Utils.browser.isIe()){i.push("bx-livechat-browser-ie")}if(w.Utils.platform.isMac()){i.push("bx-livechat-mac")}else{i.push("bx-livechat-custom-scroll")}if(e.widget.common.styles.backgroundColor&&w.Utils.isDarkColor(e.widget.common.styles.iconColor)){i.push("bx-livechat-bright-header")}return i.join(" ")},showMessageDialog:function t(){return this.messageCollection.length>0}},D.Vuex.mapState({widget:function t(e){return e.widget},application:function t(e){return e.application},dialog:function t(e){return e.dialogues.collection[e.application.dialog.dialogId]},messageCollection:function t(e){return e.messages.collection[e.application.dialog.chatId]}})),watch:{sessionClose:function t(e){b.Logger.log("sessionClose change",e)},dialogInited:function t(e){return false}},methods:{getRestClient:function t(){return this.$Bitrix.RestClient.get()},getApplication:function t(){return this.$Bitrix.Application.get()},onSendMessage:function t(e){var i=e.data;i.focus=i.focus!==false;if(this.widget.common.showForm===E.smile){this.$store.commit("widget/common",{showForm:E.none})}if(!this.widget.dialog.userConsent&&this.widget.common.consentUrl){if(i.text){this.storedMessage=i.text}this.showConsentWidow();return false}i.text=i.text?i.text:this.storedMessage;if(!i.text){return false}this.hideForm();this.getApplication().addMessage(i.text);if(i.focus){x.EventEmitter.emit(S.EventType.textarea.setFocus)}return true},close:function t(e){if(this.widget.common.pageMode){return false}this.onBeforeClose();this.$store.commit("widget/common",{showed:false})},getAvailableSpace:function t(){if(this.isBottomLocation){var e=this.$refs.widgetWrapper.getBoundingClientRect().bottom;var i=window.innerHeight-e;this.widgetAvailableHeight=window.innerHeight-this.widgetMargin-i}else{var o=this.$refs.widgetWrapper.getBoundingClientRect().top;this.widgetAvailableHeight=window.innerHeight-this.widgetMargin-o}this.widgetAvailableWidth=window.innerWidth-this.widgetMargin*2},showLikeForm:function t(){if(this.offline){return false}clearTimeout(this.showFormTimeout);if(!this.widget.common.vote.enable){return false}if(this.widget.dialog.sessionClose&&this.widget.dialog.userVote!==T.none){return false}this.$store.commit("widget/common",{showForm:E.like})},onOpenMenu:function t(e){this.getApplication().getHtmlHistory()},hideForm:function t(){clearTimeout(this.showFormTimeout);if(this.widget.common.showForm!==E.none){this.$store.commit("widget/common",{showForm:E.none})}},showConsentWidow:function t(){this.$store.commit("widget/common",{showConsent:true})},agreeConsentWidow:function t(){this.$store.commit("widget/common",{showConsent:false});this.getApplication().sendConsentDecision(true);if(this.storedMessage||this.storedFile){if(this.storedMessage){this.onSendMessage({data:{focus:this.application.device.type!==S.DeviceType.mobile}});this.storedMessage=""}if(this.storedFile){this.onTextareaFileSelected();this.storedFile=""}}else if(this.widget.common.showForm===E.none){x.EventEmitter.emit(S.EventType.textarea.setFocus)}},disagreeConsentWidow:function t(){this.$store.commit("widget/common",{showForm:E.none});this.$store.commit("widget/common",{showConsent:false});this.getApplication().sendConsentDecision(false);if(this.storedMessage){x.EventEmitter.emit(S.EventType.textarea.insertText,{text:this.storedMessage,focus:this.application.device.type!==S.DeviceType.mobile});this.storedMessage=""}if(this.storedFile){this.storedFile=""}if(this.application.device.type!==S.DeviceType.mobile){x.EventEmitter.emit(S.EventType.textarea.setFocus)}},logEvent:function t(e){for(var i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++){o[s-1]=arguments[s]}b.Logger.info.apply(b.Logger,[e].concat(o))},onCreated:function t(){var e=this;if(w.Utils.device.isMobile()){var i=Array.from(document.head.getElementsByTagName("meta")).filter(function(t){return t.name==="viewport"})[0];if(i){this.viewPortMetaSiteNode=i;document.head.removeChild(this.viewPortMetaSiteNode)}else{var o=document.body.offsetWidth;if(o<window.innerWidth){o=window.innerWidth}if(o<1024){o=1024}this.viewPortMetaSiteNode=document.createElement("meta");this.viewPortMetaSiteNode.setAttribute("name","viewport");this.viewPortMetaSiteNode.setAttribute("content","width=".concat(o,", initial-scale=1.0, user-scalable=1"))}if(!this.viewPortMetaWidgetNode){this.viewPortMetaWidgetNode=document.createElement("meta");this.viewPortMetaWidgetNode.setAttribute("name","viewport");this.viewPortMetaWidgetNode.setAttribute("content","width=device-width, initial-scale=1.0, user-scalable=0");document.head.appendChild(this.viewPortMetaWidgetNode)}document.body.classList.add("bx-livechat-mobile-state");if(w.Utils.browser.isSafariBased()){document.body.classList.add("bx-livechat-mobile-safari-based")}setTimeout(function(){e.$store.dispatch("widget/show")},50)}else{this.$store.dispatch("widget/show").then(function(){e.widgetCurrentHeight=e.widgetBaseSizes.height;e.widgetCurrentWidth=e.widgetBaseSizes.width;e.getAvailableSpace();e.widgetCurrentHeight=e.widget.common.widgetHeight||e.widgetCurrentHeight;e.widgetCurrentWidth=e.widget.common.widgetWidth||e.widgetCurrentWidth})}this.textareaHeight=this.widget.common.textareaHeight||this.textareaHeight;this.$store.commit("files/initCollection",{chatId:this.getApplication().getChatId()});this.$store.commit("messages/initCollection",{chatId:this.getApplication().getChatId()});this.$store.commit("dialogues/initCollection",{dialogId:this.getApplication().getDialogId(),fields:{entityType:"LIVECHAT",type:"livechat"}})},onBeforeClose:function t(){if(w.Utils.device.isMobile()){document.body.classList.remove("bx-livechat-mobile-state");if(w.Utils.browser.isSafariBased()){document.body.classList.remove("bx-livechat-mobile-safari-based")}if(this.viewPortMetaWidgetNode){document.head.removeChild(this.viewPortMetaWidgetNode);this.viewPortMetaWidgetNode=null}if(this.viewPortMetaSiteNode){document.head.appendChild(this.viewPortMetaSiteNode);this.viewPortMetaSiteNode=null}}},onAfterClose:function t(){this.getApplication().close()},onRequestShowForm:function t(e){var i=this;var o=e.data;clearTimeout(this.showFormTimeout);if(o.type===E.like){if(o.delayed){this.showFormTimeout=setTimeout(function(){i.showLikeForm()},5e3)}else{this.showLikeForm()}}},onDialogRequestHistory:function t(e){this.getApplication().getDialogHistory(e.lastId)},onDialogRequestUnread:function t(e){this.getApplication().getDialogUnread(e.lastId)},onClickOnUserName:function t(e){var i=e.data;x.EventEmitter.emit(S.EventType.textarea.insertText,{text:i.user.name+", "})},onClickOnUploadCancel:function t(e){var i=e.data;this.getApplication().cancelUploadFile(i.file.id)},onClickOnKeyboardButton:function t(e){var i=e.data;this.getApplication().execMessageKeyboardCommand(i)},onClickOnCommand:function t(e){var i=e.data;if(i.type==="put"){x.EventEmitter.emit(S.EventType.textarea.insertText,{text:i.value+" "})}else if(i.type==="send"){this.getApplication().addMessage(i.value)}else{b.Logger.warn("Unprocessed command",i)}},onClickOnMessageMenu:function t(e){var i=e.data;b.Logger.warn("Message menu:",i)},onClickOnMessageRetry:function t(e){var i=e.data;b.Logger.warn("Message retry:",i);this.getApplication().retrySendMessage(i.message)},onReadMessage:function t(e){var i=e.data;this.getApplication().readMessage(i.id)},onSetMessageReaction:function t(e){var i=e.data;this.getApplication().reactMessage(i.message.id,i.reaction)},onClickOnDialog:function t(e){var i=e.data;if(this.widget.common.showForm!==E.none){this.$store.commit("widget/common",{showForm:E.none})}},onTextareaKeyUp:function t(e){var i=e.data;if(this.widget.common.watchTyping&&this.widget.dialog.sessionId&&!this.widget.dialog.sessionClose&&this.widget.dialog.operator.id&&this.widget.dialog.operatorChatId&&this.$Bitrix.PullClient.get().isPublishingEnabled()){var o=C.md5(this.widget.dialog.sessionId+"/"+this.application.dialog.chatId+"/"+this.widget.user.id);this.$Bitrix.PullClient.get().sendMessage([this.widget.dialog.operator.id],"imopenlines","linesMessageWrite",{text:i.text,infoString:o,operatorChatId:this.widget.dialog.operatorChatId})}},onTextareaFocus:function t(e){var i=this;var o=e.data;if(this.widget.common.copyright&&this.application.device.type===S.DeviceType.mobile){this.widget.common.copyright=false}if(w.Utils.device.isMobile()){clearTimeout(this.onTextareaFocusScrollTimeout);this.onTextareaFocusScrollTimeout=setTimeout(function(){document.addEventListener("scroll",i.onWindowScroll)},1e3)}this.textareaFocused=true},onTextareaBlur:function t(e){var i=this;var o=e.data;if(!this.widget.common.copyright&&this.widget.common.copyright!==this.getApplication().copyright){this.widget.common.copyright=this.getApplication().copyright;this.$nextTick(function(){x.EventEmitter.emit(S.EventType.dialog.scrollToBottom,{chatId:i.chatId,force:true})})}if(w.Utils.device.isMobile()){clearTimeout(this.onTextareaFocusScrollTimeout);document.removeEventListener("scroll",this.onWindowScroll)}this.textareaFocused=false},onTextareaStartDrag:function t(e){if(this.textareaDrag){return}b.Logger.log("Livechat: textarea drag started");this.textareaDrag=true;e=e.changedTouches?e.changedTouches[0]:e;this.textareaDragCursorStartPoint=e.clientY;this.textareaDragHeightStartPoint=this.textareaHeight;this.onTextareaDragEventAdd();x.EventEmitter.emit(S.EventType.textarea.setBlur,true)},onTextareaContinueDrag:function t(e){if(!this.textareaDrag){return}e=e.changedTouches?e.changedTouches[0]:e;this.textareaDragCursorControlPoint=e.clientY;var i=Math.max(Math.min(this.textareaDragHeightStartPoint+this.textareaDragCursorStartPoint-this.textareaDragCursorControlPoint,this.textareaMaximumHeight),this.textareaMinimumHeight);b.Logger.log("Livechat: textarea drag","new: "+i,"curr: "+this.textareaHeight);if(this.textareaHeight!==i){this.textareaHeight=i}},onTextareaStopDrag:function t(){if(!this.textareaDrag){return}b.Logger.log("Livechat: textarea drag ended");this.textareaDrag=false;this.onTextareaDragEventRemove();this.$store.commit("widget/common",{textareaHeight:this.textareaHeight});x.EventEmitter.emit(S.EventType.dialog.scrollToBottom,{chatId:this.chatId,force:true})},onTextareaDragEventAdd:function t(){document.addEventListener("mousemove",this.onTextareaContinueDrag);document.addEventListener("touchmove",this.onTextareaContinueDrag);document.addEventListener("touchend",this.onTextareaStopDrag);document.addEventListener("mouseup",this.onTextareaStopDrag);document.addEventListener("mouseleave",this.onTextareaStopDrag)},onTextareaDragEventRemove:function t(){document.removeEventListener("mousemove",this.onTextareaContinueDrag);document.removeEventListener("touchmove",this.onTextareaContinueDrag);document.removeEventListener("touchend",this.onTextareaStopDrag);document.removeEventListener("mouseup",this.onTextareaStopDrag);document.removeEventListener("mouseleave",this.onTextareaStopDrag)},onTextareaFileSelected:function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},i=e.data;var o=null;if(i&&i.fileChangeEvent&&i.fileChangeEvent.target.files.length>0){o=i.fileChangeEvent}else{o=this.storedFile}if(!o){return false}if(!this.widget.dialog.userConsent&&this.widget.common.consentUrl){this.storedFile=i.fileChangeEvent;this.showConsentWidow();return false}this.getApplication().uploadFile(o)},onTextareaAppButtonClick:function t(e){var i=e.data;if(i.appId===E.smile){if(this.widget.common.showForm===E.smile){this.$store.commit("widget/common",{showForm:E.none})}else{this.$store.commit("widget/common",{showForm:E.smile})}}else{x.EventEmitter.emit(S.EventType.textarea.setFocus)}},onTextareaEdit:function t(e){var i=e.data;this.logEvent("edit message",i)},onPullRequestConfig:function t(e){this.getApplication().recoverPullConnection()},onSmilesSelectSmile:function t(e){x.EventEmitter.emit(S.EventType.textarea.insertText,{text:e.text})},onSmilesSelectSet:function t(){x.EventEmitter.emit(S.EventType.textarea.setFocus)},onWidgetStartDrag:function t(e){if(this.widgetDrag){return}this.widgetDrag=true;e=e.changedTouches?e.changedTouches[0]:e;this.widgetDragCursorStartPointY=e.clientY;this.widgetDragCursorStartPointX=e.clientX;this.widgetDragHeightStartPoint=this.widgetCurrentHeight;this.widgetDragWidthStartPoint=this.widgetCurrentWidth;this.onWidgetDragEventAdd()},onWidgetContinueDrag:function t(e){if(!this.widgetDrag){return}e=e.changedTouches?e.changedTouches[0]:e;this.widgetDragCursorControlPointY=e.clientY;this.widgetDragCursorControlPointX=e.clientX;var i=0;if(this.isBottomLocation){i=Math.max(Math.min(this.widgetDragHeightStartPoint+this.widgetDragCursorStartPointY-this.widgetDragCursorControlPointY,this.widgetAvailableHeight),this.widgetMinimumHeight)}else{i=Math.max(Math.min(this.widgetDragHeightStartPoint-this.widgetDragCursorStartPointY+this.widgetDragCursorControlPointY,this.widgetAvailableHeight),this.widgetMinimumHeight)}var o=0;if(this.isLeftLocation){o=Math.max(Math.min(this.widgetDragWidthStartPoint-this.widgetDragCursorStartPointX+this.widgetDragCursorControlPointX,this.widgetAvailableWidth),this.widgetMinimumWidth)}else{o=Math.max(Math.min(this.widgetDragWidthStartPoint+this.widgetDragCursorStartPointX-this.widgetDragCursorControlPointX,this.widgetAvailableWidth),this.widgetMinimumWidth)}if(this.widgetCurrentHeight!==i){this.widgetCurrentHeight=i}if(this.widgetCurrentWidth!==o){this.widgetCurrentWidth=o}},onWidgetStopDrag:function t(){if(!this.widgetDrag){return}this.widgetDrag=false;this.onWidgetDragEventRemove();this.$store.commit("widget/common",{widgetHeight:this.widgetCurrentHeight,widgetWidth:this.widgetCurrentWidth})},onWidgetDragEventAdd:function t(){document.addEventListener("mousemove",this.onWidgetContinueDrag);document.addEventListener("mouseup",this.onWidgetStopDrag);document.addEventListener("mouseleave",this.onWidgetStopDrag)},onWidgetDragEventRemove:function t(){document.removeEventListener("mousemove",this.onWidgetContinueDrag);document.removeEventListener("mouseup",this.onWidgetStopDrag);document.removeEventListener("mouseleave",this.onWidgetStopDrag)},onWindowKeyDown:function t(e){if(e.keyCode===27){if(this.widget.common.showForm!==E.none){this.$store.commit("widget/common",{showForm:E.none})}else if(this.widget.common.showConsent){this.disagreeConsentWidow()}else{this.close()}e.preventDefault();e.stopPropagation();x.EventEmitter.emit(S.EventType.textarea.setFocus)}},onWindowScroll:function t(e){clearTimeout(this.onWindowScrollTimeout);this.onWindowScrollTimeout=setTimeout(function(){x.EventEmitter.emit(S.EventType.textarea.setBlur,true)},50)},onWelcomeFormSendSuccess:function t(){this.welcomeFormFilled=true},onWelcomeFormSendError:function t(e){console.error("onWelcomeFormSendError",e);this.welcomeFormFilled=true}},template:'\n\t\t<transition enter-active-class="bx-livechat-show" leave-active-class="bx-livechat-close" @after-leave="onAfterClose">\n\t\t\t<div :class="widgetClassName" v-if="widget.common.showed" :style="{height: widgetHeightStyle, width: widgetWidthStyle, userSelect: userSelectStyle}" ref="widgetWrapper">\n\t\t\t\t<div class="bx-livechat-box">\n\t\t\t\t\t<div v-if="isBottomLocation" class="bx-livechat-widget-resize-handle" @mousedown="onWidgetStartDrag"></div>\n\t\t\t\t\t<bx-livechat-head :isWidgetDisabled="widgetMobileDisabled" @like="showLikeForm" @openMenu="onOpenMenu" @close="close"/>\n\t\t\t\t\t<template v-if="widgetMobileDisabled">\n\t\t\t\t\t\t<bx-livechat-body-orientation-disabled/>\n\t\t\t\t\t</template>\n\t\t\t\t\t<template v-else-if="application.error.active">\n\t\t\t\t\t\t<bx-livechat-body-error/>\n\t\t\t\t\t</template>\n\t\t\t\t\t<template v-else-if="!widget.common.configId">\n\t\t\t\t\t\t<div class="bx-livechat-body" key="loading-body">\n\t\t\t\t\t\t\t<bx-livechat-body-loading/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</template>\n\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t<div v-show="!widget.common.dialogStart" class="bx-livechat-body" :class="{\'bx-livechat-body-with-scroll\': showWelcomeForm}" key="welcome-body">\n\t\t\t\t\t\t\t<bx-imopenlines-form\n\t\t\t\t\t\t\t  v-show="showWelcomeForm"\n\t\t\t\t\t\t\t  @formSendSuccess="onWelcomeFormSendSuccess"\n\t\t\t\t\t\t\t  @formSendError="onWelcomeFormSendError"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<template v-if="!showWelcomeForm">\n\t\t\t\t\t\t\t\t<bx-livechat-body-operators/>\n\t\t\t\t\t\t\t\t<keep-alive include="bx-livechat-smiles">\n\t\t\t\t\t\t\t\t\t<template v-if="widget.common.showForm === FormType.smile">\n\t\t\t\t\t\t\t\t\t\t<bx-livechat-smiles @selectSmile="onSmilesSelectSmile" @selectSet="onSmilesSelectSet"/>\n\t\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t</keep-alive>\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<template v-if="widget.common.dialogStart">\n\t\t\t\t\t\t\t<bx-pull-component-status :canReconnect="true" @reconnect="onPullRequestConfig"/>\n\t\t\t\t\t\t\t<div :class="[\'bx-livechat-body\', {\'bx-livechat-body-with-message\': showMessageDialog}]" key="with-message">\n\t\t\t\t\t\t\t\t<template v-if="showMessageDialog">\n\t\t\t\t\t\t\t\t\t<div class="bx-livechat-dialog">\n\t\t\t\t\t\t\t\t\t\t<bx-im-component-dialog\n\t\t\t\t\t\t\t\t\t\t\t:userId="application.common.userId"\n\t\t\t\t\t\t\t\t\t\t\t:dialogId="application.dialog.dialogId"\n\t\t\t\t\t\t\t\t\t\t\t:messageLimit="application.dialog.messageLimit"\n\t\t\t\t\t\t\t\t\t\t\t:enableReactions="true"\n\t\t\t\t\t\t\t\t\t\t\t:enableDateActions="false"\n\t\t\t\t\t\t\t\t\t\t\t:enableCreateContent="false"\n\t\t\t\t\t\t\t\t\t\t\t:enableGestureQuote="true"\n\t\t\t\t\t\t\t\t\t\t\t:enableGestureMenu="true"\n\t\t\t\t\t\t\t\t\t\t\t:showMessageAvatar="false"\n\t\t\t\t\t\t\t\t\t\t\t:showMessageMenu="false"\n\t\t\t\t\t\t\t\t\t\t\t:skipDataRequest="true"\n\t\t\t\t\t\t\t\t\t\t\t:showLoadingState="false"\n\t\t\t\t\t\t\t\t\t\t\t:showEmptyState="false"\n\t\t\t\t\t\t\t\t\t\t />\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t\t\t\t<bx-livechat-body-loading/>\n\t\t\t\t\t\t\t\t</template>\n\n\t\t\t\t\t\t\t\t<keep-alive include="bx-livechat-smiles">\n\t\t\t\t\t\t\t\t\t<template v-if="widget.common.showForm === FormType.like && widget.common.vote.enable">\n\t\t\t\t\t\t\t\t\t\t<bx-livechat-form-vote/>\n\t\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t\t<template v-else-if="widget.common.showForm === FormType.welcome">\n\t\t\t\t\t\t\t\t\t\t<bx-livechat-form-welcome/>\n\t\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t\t<template v-else-if="widget.common.showForm === FormType.offline">\n\t\t\t\t\t\t\t\t\t\t<bx-livechat-form-offline/>\n\t\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t\t<template v-else-if="widget.common.showForm === FormType.history">\n\t\t\t\t\t\t\t\t\t\t<bx-livechat-form-history/>\n\t\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t\t<template v-else-if="widget.common.showForm === FormType.smile">\n\t\t\t\t\t\t\t\t\t\t<bx-livechat-smiles @selectSmile="onSmilesSelectSmile" @selectSet="onSmilesSelectSet"/>\n\t\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t</keep-alive>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t\t<div v-if="showTextarea" class="bx-livechat-textarea" :style="[textareaHeightStyle, textareaBottomMargin]" ref="textarea">\n\t\t\t\t\t\t\t<div class="bx-livechat-textarea-resize-handle" @mousedown="onTextareaStartDrag" @touchstart="onTextareaStartDrag"></div>\n\t\t\t\t\t\t\t<bx-im-component-textarea\n\t\t\t\t\t\t\t\t:siteId="application.common.siteId"\n\t\t\t\t\t\t\t\t:userId="application.common.userId"\n\t\t\t\t\t\t\t\t:dialogId="application.dialog.dialogId"\n\t\t\t\t\t\t\t\t:writesEventLetter="3"\n\t\t\t\t\t\t\t\t:enableEdit="true"\n\t\t\t\t\t\t\t\t:enableCommand="false"\n\t\t\t\t\t\t\t\t:enableMention="false"\n\t\t\t\t\t\t\t\t:enableFile="application.disk.enabled"\n\t\t\t\t\t\t\t\t:autoFocus="application.device.type !== DeviceType.mobile"\n\t\t\t\t\t\t\t\t:styles="{button: {backgroundColor: widget.common.styles.backgroundColor, iconColor: widget.common.styles.iconColor}}"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div v-if="!widget.common.copyright && !isBottomLocation" class="bx-livechat-nocopyright-resize-wrap" style="position: relative;">\n\t\t\t\t\t\t\t<div class="bx-livechat-widget-resize-handle" @mousedown="onWidgetStartDrag"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<bx-livechat-form-consent @agree="agreeConsentWidow" @disagree="disagreeConsentWidow"/>\n\t\t\t\t\t\t<template v-if="widget.common.copyright">\n\t\t\t\t\t\t\t<div class="bx-livechat-copyright">\n\t\t\t\t\t\t\t\t<template v-if="widget.common.copyrightUrl">\n\t\t\t\t\t\t\t\t\t<a class="bx-livechat-copyright-link" :href="widget.common.copyrightUrl" target="_blank">\n\t\t\t\t\t\t\t\t\t\t<span class="bx-livechat-logo-name">{{localize.BX_LIVECHAT_COPYRIGHT_TEXT}}</span>\n\t\t\t\t\t\t\t\t\t\t<span class="bx-livechat-logo-icon"></span>\n\t\t\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t\t\t\t<span class="bx-livechat-logo-name">{{localize.BX_LIVECHAT_COPYRIGHT_TEXT}}</span>\n\t\t\t\t\t\t\t\t\t<span class="bx-livechat-logo-icon"></span>\n\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t<div v-if="!isBottomLocation" class="bx-livechat-widget-resize-handle" @mousedown="onWidgetStartDrag"></div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</template>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</transition>\n\t'});M.BitrixVue.component("bx-livechat-body-error",{computed:babelHelpers.objectSpread({},D.Vuex.mapState({application:function t(e){return e.application}})),template:'\n\t\t<div class="bx-livechat-body" key="error-body">\n\t\t\t<div class="bx-livechat-warning-window">\n\t\t\t\t<div class="bx-livechat-warning-icon"></div>\n\t\t\t\t<template v-if="application.error.description"> \n\t\t\t\t\t<div class="bx-livechat-help-title bx-livechat-help-title-sm bx-livechat-warning-msg" v-html="application.error.description"></div>\n\t\t\t\t</template> \n\t\t\t\t<template v-else>\n\t\t\t\t\t<div class="bx-livechat-help-title bx-livechat-help-title-md bx-livechat-warning-msg">{{$Bitrix.Loc.getMessage(\'BX_LIVECHAT_ERROR_TITLE\')}}</div>\n\t\t\t\t\t<div class="bx-livechat-help-title bx-livechat-help-title-sm bx-livechat-warning-msg">{{$Bitrix.Loc.getMessage(\'BX_LIVECHAT_ERROR_DESC\')}}</div>\n\t\t\t\t</template> \n\t\t\t</div>\n\t\t</div>\n\t'});M.BitrixVue.component("bx-livechat-head",{props:{isWidgetDisabled:{default:false}},methods:{close:function t(e){this.$emit("close")},like:function t(e){this.$emit("like")},openMenu:function t(e){this.$emit("openMenu",e)}},computed:babelHelpers.objectSpread({VoteType:function t(){return T},chatId:function t(){if(this.application){return this.application.dialog.chatId}},customBackgroundStyle:function t(e){return e.widget.common.styles.backgroundColor?"background-color: "+e.widget.common.styles.backgroundColor+"!important;":""},customBackgroundOnlineStyle:function t(e){return e.widget.common.styles.backgroundColor?"border-color: "+e.widget.common.styles.backgroundColor+"!important;":""},showName:function t(e){return e.widget.dialog.operator.firstName||e.widget.dialog.operator.lastName},voteActive:function t(e){if(!!e.widget.dialog.closeVote){return false}if(!e.widget.common.vote.beforeFinish&&e.widget.dialog.sessionStatus<O.waitClient){return false}if(!e.widget.dialog.sessionClose||e.widget.dialog.sessionClose&&e.widget.dialog.userVote===T.none){return true}if(e.widget.dialog.sessionClose&&e.widget.dialog.userVote!==T.none){return true}return false},chatTitle:function t(e){return e.widget.common.textMessages.bxLivechatTitle||e.widget.common.configName||this.localize.BX_LIVECHAT_TITLE},operatorName:function t(e){if(!this.showName)return"";return e.widget.dialog.operator.firstName?e.widget.dialog.operator.firstName:e.widget.dialog.operator.name},operatorDescription:function t(e){if(!this.showName){return""}var i=e.widget.dialog.operator.workPosition?e.widget.dialog.operator.workPosition:this.localize.BX_LIVECHAT_USER;if(e.widget.common.showSessionId&&e.widget.dialog.sessionId>=0){return this.localize.BX_LIVECHAT_OPERATOR_POSITION_AND_SESSION_ID.replace("#POSITION#",i).replace("#ID#",e.widget.dialog.sessionId)}return this.localize.BX_LIVECHAT_OPERATOR_POSITION_ONLY.replace("#POSITION#",i)},localize:function t(){return M.BitrixVue.getFilteredPhrases("BX_LIVECHAT_",this)},ie11:function t(){return I.Browser.isIE11()}},D.Vuex.mapState({widget:function t(e){return e.widget},application:function t(e){return e.application}})),watch:{showName:function t(e){var i=this;if(e){setTimeout(function(){i.$root.$emit(S.EventType.dialog.scrollToBottom,{chatId:i.chatId})},300)}}},template:'\n\t\t<div class="bx-livechat-head-wrap">\n\t\t\t<template v-if="isWidgetDisabled">\n\t\t\t\t<div class="bx-livechat-head" :style="customBackgroundStyle">\n\t\t\t\t\t<div class="bx-livechat-title">{{chatTitle}}</div>\n\t\t\t\t\t<div class="bx-livechat-control-box">\n\t\t\t\t\t\t<button v-if="!widget.common.pageMode" class="bx-livechat-control-btn bx-livechat-control-btn-close" :title="localize.BX_LIVECHAT_CLOSE_BUTTON" @click="close"></button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\t\n\t\t\t</template>\n\t\t\t<template v-else-if="application.error.active">\n\t\t\t\t<div class="bx-livechat-head" :style="customBackgroundStyle">\n\t\t\t\t\t<div class="bx-livechat-title">{{chatTitle}}</div>\n\t\t\t\t\t<div class="bx-livechat-control-box">\n\t\t\t\t\t\t<button v-if="!widget.common.pageMode" class="bx-livechat-control-btn bx-livechat-control-btn-close" :title="localize.BX_LIVECHAT_CLOSE_BUTTON" @click="close"></button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t\t<template v-else-if="!widget.common.configId">\n\t\t\t\t<div class="bx-livechat-head" :style="customBackgroundStyle">\n\t\t\t\t\t<div class="bx-livechat-title">{{chatTitle}}</div>\n\t\t\t\t\t<div class="bx-livechat-control-box">\n\t\t\t\t\t\t<button v-if="!widget.common.pageMode" class="bx-livechat-control-btn bx-livechat-control-btn-close" :title="localize.BX_LIVECHAT_CLOSE_BUTTON" @click="close"></button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</template>\t\t\t\n\t\t\t<template v-else>\n\t\t\t\t<div class="bx-livechat-head" :style="customBackgroundStyle">\n\t\t\t\t\t<template v-if="!showName">\n\t\t\t\t\t\t<div class="bx-livechat-title">{{chatTitle}}</div>\n\t\t\t\t\t</template>\n\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t<div class="bx-livechat-user bx-livechat-status-online">\n\t\t\t\t\t\t\t<template v-if="widget.dialog.operator.avatar">\n\t\t\t\t\t\t\t\t<div class="bx-livechat-user-icon" :style="\'background-image: url(\'+encodeURI(widget.dialog.operator.avatar)+\')\'">\n\t\t\t\t\t\t\t\t\t<div v-if="widget.dialog.operator.online" class="bx-livechat-user-status" :style="customBackgroundOnlineStyle"></div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t\t\t<div class="bx-livechat-user-icon">\n\t\t\t\t\t\t\t\t\t<div v-if="widget.dialog.operator.online" class="bx-livechat-user-status" :style="customBackgroundOnlineStyle"></div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="bx-livechat-user-info">\n\t\t\t\t\t\t\t<div class="bx-livechat-user-name">{{operatorName}}</div>\n\t\t\t\t\t\t\t<div class="bx-livechat-user-position">{{operatorDescription}}</div>\t\t\t\t\t\t\t\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</template>\n\t\t\t\t\t<div class="bx-livechat-control-box">\n\t\t\t\t\t\t<span class="bx-livechat-control-box-active" v-if="widget.common.dialogStart && widget.dialog.sessionId">\n\t\t\t\t\t\t\t<button v-if="widget.common.vote.enable && voteActive" :class="\'bx-livechat-control-btn bx-livechat-control-btn-like bx-livechat-dialog-vote-\'+(widget.dialog.userVote)" :title="localize.BX_LIVECHAT_VOTE_BUTTON" @click="like"></button>\n\t\t\t\t\t\t\t<button\n\t\t\t\t\t\t\t\tv-if="!ie11 && application.dialog.chatId > 0"\n\t\t\t\t\t\t\t\tclass="bx-livechat-control-btn bx-livechat-control-btn-menu"\n\t\t\t\t\t\t\t\t@click="openMenu"\n\t\t\t\t\t\t\t\t:title="localize.BX_LIVECHAT_DOWNLOAD_HISTORY"\n\t\t\t\t\t\t\t></button>\n\t\t\t\t\t\t</span>\t\n\t\t\t\t\t\t<button v-if="!widget.common.pageMode" class="bx-livechat-control-btn bx-livechat-control-btn-close" :title="localize.BX_LIVECHAT_CLOSE_BUTTON" @click="close"></button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t</div>\n\t'});M.BitrixVue.component("bx-livechat-body-loading",{template:'\n\t\t<div class="bx-livechat-loading-window">\n\t\t\t<svg class="bx-livechat-loading-circular" viewBox="25 25 50 50">\n\t\t\t\t<circle class="bx-livechat-loading-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/>\n\t\t\t\t<circle class="bx-livechat-loading-inner-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/>\n\t\t\t</svg>\n\t\t\t<h3 class="bx-livechat-help-title bx-livechat-help-title-md bx-livechat-loading-msg">{{$Bitrix.Loc.getMessage(\'BX_LIVECHAT_LOADING\')}}</h3>\n\t\t</div>\n\t'});M.BitrixVue.component("bx-livechat-body-operators",{computed:babelHelpers.objectSpread({},D.Vuex.mapState({widget:function t(e){return e.widget}})),template:'\n\t\t<div class="bx-livechat-help-container">\n\t\t\t<transition name="bx-livechat-animation-fade">\n\t\t\t\t<h2 v-if="widget.common.online" key="online" class="bx-livechat-help-title bx-livechat-help-title-lg">{{widget.common.textMessages.bxLivechatOnlineLine1}}<div class="bx-livechat-help-subtitle">{{widget.common.textMessages.bxLivechatOnlineLine2}}</div></h2>\n\t\t\t\t<h2 v-else key="offline" class="bx-livechat-help-title bx-livechat-help-title-sm">{{widget.common.textMessages.bxLivechatOffline}}</h2>\n\t\t\t</transition>\t\n\t\t\t<div class="bx-livechat-help-user">\n\t\t\t\t<template v-for="operator in widget.common.operators">\n\t\t\t\t\t<div class="bx-livechat-user" :key="operator.id">\n\t\t\t\t\t\t<template v-if="operator.avatar">\n\t\t\t\t\t\t\t<div class="bx-livechat-user-icon" :style="\'background-image: url(\'+encodeURI(operator.avatar)+\')\'"></div>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t\t<div class="bx-livechat-user-icon"></div>\n\t\t\t\t\t\t</template>\t\n\t\t\t\t\t\t<div class="bx-livechat-user-info">\n\t\t\t\t\t\t\t<div class="bx-livechat-user-name">{{operator.firstName? operator.firstName: operator.name}}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\t\n\t\t\t</div>\n\t\t</div>\n\t'});M.BitrixVue.component("bx-livechat-body-orientation-disabled",{template:'\n\t\t<div class="bx-livechat-body" key="orientation-head">\n\t\t\t<div class="bx-livechat-mobile-orientation-box">\n\t\t\t\t<div class="bx-livechat-mobile-orientation-icon"></div>\n\t\t\t\t<div class="bx-livechat-mobile-orientation-text">{{$Bitrix.Loc.getMessage(\'BX_LIVECHAT_MOBILE_ROTATE\')}}</div>\n\t\t\t</div>\n\t\t</div>\n\t'});M.BitrixVue.component("bx-livechat-form-consent",{computed:babelHelpers.objectSpread({},D.Vuex.mapState({widget:function t(e){return e.widget}})),methods:{agree:function t(e){this.$emit("agree",{event:e})},disagree:function t(e){this.$emit("disagree",{event:e})},onShow:function t(e,i){e.classList.add("bx-livechat-consent-window-show");i()},onHide:function t(e,i){e.classList.remove("bx-livechat-consent-window-show");e.classList.add("bx-livechat-consent-window-close");setTimeout(function(){i()},400)},onKeyDown:function t(e){if(e.keyCode==9){if(e.target===this.$refs.iframe){if(e.shiftKey){this.$refs.cancel.focus()}else{this.$refs.success.focus()}}else if(e.target===this.$refs.success){if(e.shiftKey){this.$refs.iframe.focus()}else{this.$refs.cancel.focus()}}else if(e.target===this.$refs.cancel){if(e.shiftKey){this.$refs.success.focus()}else{this.$refs.iframe.focus()}}e.preventDefault()}else if(e.keyCode==39||e.keyCode==37){if(e.target.nextElementSibling){e.target.nextElementSibling.focus()}else if(e.target.previousElementSibling){e.target.previousElementSibling.focus()}e.preventDefault()}}},directives:{focus:{inserted:function t(e,i){e.focus()}}},template:'\n\t\t<transition @enter="onShow" @leave="onHide">\n\t\t\t<template v-if="widget.common.showConsent && widget.common.consentUrl">\n\t\t\t\t<div class="bx-livechat-consent-window">\n\t\t\t\t\t<div class="bx-livechat-consent-window-title">{{$Bitrix.Loc.getMessage(\'BX_LIVECHAT_CONSENT_TITLE\')}}</div>\n\t\t\t\t\t<div class="bx-livechat-consent-window-content">\n\t\t\t\t\t\t<iframe class="bx-livechat-consent-window-content-iframe" ref="iframe" frameborder="0" marginheight="0"  marginwidth="0" allowtransparency="allow-same-origin" seamless="true" :src="widget.common.consentUrl" @keydown="onKeyDown"></iframe>\n\t\t\t\t\t</div>\t\t\t\t\t\t\t\t\n\t\t\t\t\t<div class="bx-livechat-consent-window-btn-box">\n\t\t\t\t\t\t<button class="bx-livechat-btn bx-livechat-btn-success" ref="success" @click="agree" @keydown="onKeyDown" v-focus>{{$Bitrix.Loc.getMessage(\'BX_LIVECHAT_CONSENT_AGREE\')}}</button>\n\t\t\t\t\t\t<button class="bx-livechat-btn bx-livechat-btn-cancel" ref="cancel" @click="disagree" @keydown="onKeyDown">{{$Bitrix.Loc.getMessage(\'BX_LIVECHAT_CONSENT_DISAGREE\')}}</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t</transition>\n\t'});M.BitrixVue.component("bx-livechat-form-vote",{computed:babelHelpers.objectSpread({VoteType:function t(){return T}},D.Vuex.mapState({widget:function t(e){return e.widget}})),methods:{userVote:function t(e){this.$store.commit("widget/common",{showForm:E.none});this.$store.commit("widget/dialog",{userVote:e});this.$Bitrix.Application.get().sendDialogVote(e)},hideForm:function t(e){this.$parent.hideForm()}},template:'\n\t\t<transition enter-active-class="bx-livechat-consent-window-show" leave-active-class="bx-livechat-form-close">\n\t\t\t<div class="bx-livechat-alert-box bx-livechat-form-rate-show" key="vote">\n\t\t\t\t<div class="bx-livechat-alert-close" @click="hideForm"></div>\n\t\t\t\t<div class="bx-livechat-alert-rate-box">\n\t\t\t\t\t<h4 class="bx-livechat-alert-title bx-livechat-alert-title-mdl">{{widget.common.vote.messageText}}</h4>\n\t\t\t\t\t<div class="bx-livechat-btn-box">\n\t\t\t\t\t\t<button class="bx-livechat-btn bx-livechat-btn-like" @click="userVote(VoteType.like)" :title="widget.common.vote.messageLike"></button>\n\t\t\t\t\t\t<button class="bx-livechat-btn bx-livechat-btn-dislike" @click="userVote(VoteType.dislike)" :title="widget.common.vote.messageDislike"></button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</transition>\t\n\t'});M.Vue.cloneComponent("bx-livechat-smiles","bx-smiles",{methods:{hideForm:function t(e){this.$parent.hideForm()}},template:'\n\t\t<transition enter-active-class="bx-livechat-consent-window-show" leave-active-class="bx-livechat-form-close">\n\t\t\t<div class="bx-livechat-alert-box bx-livechat-alert-box-zero-padding bx-livechat-form-show" key="vote">\n\t\t\t\t<div class="bx-livechat-alert-close" @click="hideForm"></div>\n\t\t\t\t<div class="bx-livechat-alert-smiles-box">\n\t\t\t\t\t#PARENT_TEMPLATE#\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</transition>\n\t'});BX.LiveChatWidget=G;BX.LiveChatWidget.VoteType=T;BX.LiveChatWidget.SubscriptionType=F;BX.LiveChatWidget.LocationStyle=A;BX.LiveChatWidget.Cookie=f.Cookie;window.dispatchEvent(new CustomEvent("onBitrixLiveChatSourceLoaded",{detail:{}}))})(this.window=this.window||{},BX,window,window,BX.Messenger,window,BX,window,window,BX,BX.Messenger.Provider.Rest,BX,BX,BX.Ui.Vue.Components.Crm,BX.Messenger,BX.Messenger.Lib,BX.Messenger.Lib,BX.Messenger.Lib,BX.Messenger.Lib,BX.Messenger.Lib,BX.Messenger.Mixin,BX,BX.Event,BX.Messenger.Const,BX,BX,BX);
//# sourceMappingURL=widget.bundle.map.js