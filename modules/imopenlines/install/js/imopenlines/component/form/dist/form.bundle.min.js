(function(t,e,i){"use strict";function r(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,r)}return i}function n(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?r(Object(i),!0).forEach((function(e){babelHelpers.defineProperty(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):r(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}var o="Openlines";var s="livechat";e.BitrixVue.component("bx-imopenlines-form",{props:{message:{type:Object,required:false}},data:function t(){return{formSuccess:false,formError:false}},mounted:function t(){if(this.filledFormFlag){this.formSuccess=true}},computed:n({chatId:function t(){return this.application.dialog.chatId},formId:function t(){if(this.message){return String(this.message.params.CRM_FORM_ID)}if(this.widget.common.crmFormsSettings.welcomeFormId){return this.widget.common.crmFormsSettings.welcomeFormId}return""},formSec:function t(){if(this.message){return this.message.params.CRM_FORM_SEC}if(this.widget.common.crmFormsSettings.welcomeFormSec){return this.widget.common.crmFormsSettings.welcomeFormSec}return""},showForm:function t(){return this.formId&&this.formSec&&!this.formSuccess&&!this.formError},filledFormFlag:function t(){if(this.message){return this.message.params.CRM_FORM_FILLED==="Y"}return false},messageCount:function t(){return this.dialog.messageCount}},i.Vuex.mapState({widget:function t(e){return e.widget},application:function t(e){return e.application},dialog:function t(e){return e.dialogues.collection[e.application.dialog.dialogId]}})),watch:{filledFormFlag:function t(e){if(e===true&&!this.formSuccess){this.formSuccess=true}},chatId:function t(e){if(e!==0&&this.widgetInitPromiseResolve){this.widgetInitPromiseResolve()}}},methods:{getCrmBindings:function t(){var e=this;return new Promise((function(t,i){e.$Bitrix.RestClient.get().callMethod("imopenlines.widget.crm.bindings.get",{OPENLINES_CODE:e.buildOpenlinesCode()}).then(t)["catch"](i)}))},onBeforeFormSubmit:function t(e){if(this.signedEntities&&this.signedEntities!==""){e.sign=this.signedEntities}},onFormSubmit:function t(e){var i=this;this.eventData=e;this.eventData.promise=this.eventData.promise.then((function(){return new Promise((function(t){if(i.chatId===0){new Promise((function(t,e){i.widgetInitPromiseResolve=t})).then((function(){i.setFormProperties();return t()}));i.getApplication().requestData()}else{if(i.widget.common.crmFormsSettings.welcomeFormDelay){i.getCrmBindings().then((function(e){i.signedEntities=e.data();i.setFormProperties();return t()}))["catch"]((function(t){console.error("Error getting CRM bindings",t)}))}else{i.setFormProperties();return t()}}}))}))},setFormProperties:function t(){if(!this.eventData){return false}this.eventData.form.setProperty("eventNamePostfix",o);this.eventData.form.setProperty("openlinesCode",this.buildOpenlinesCode());if(this.message){var e;this.eventData.form.setProperty("messageId",this.message.id);this.eventData.form.setProperty("isWelcomeForm",(e=this.message.params.IS_WELCOME_FORM)!==null&&e!==void 0?e:"N")}else{this.eventData.form.setProperty("isWelcomeForm","Y")}},buildOpenlinesCode:function t(){var e=0;if(this.dialog.entityId!==""){e=this.dialog.entityId.split("|")[0]}var i=this.dialog.chatId||0;var r=this.application.common.userId||0;return"".concat(s,"|").concat(e,"|").concat(i,"|").concat(r)},onFormSendSuccess:function t(){if(!this.message){this.$store.commit("widget/common",{dialogStart:true})}this.$emit("formSendSuccess");this.formSuccess=true},onFormSendError:function t(e){this.formError=true;this.$emit("formSendError",{error:e})},getSuccessText:function t(){return this.widget.common.crmFormsSettings.successText},getErrorText:function t(){return this.widget.common.crmFormsSettings.errorText},getApplication:function t(){return this.$Bitrix.Application.get()}},template:'\n\t\t<div class="bx-im-message bx-im-message-without-menu bx-im-message-without-avatar bx-imopenlines-form-wrapper">\n\t\t\t<div v-show="showForm" class="bx-imopenlines-form-content">\n\t\t\t\t<bx-crm-form\n\t\t\t\t\t:id="formId"\n\t\t\t\t\t:sec="formSec"\n\t\t\t\t\t:address="widget.common.host"\n\t\t\t\t\t:lang="application.common.languageId"\n\t\t\t\t\t@form:submit:post:before="onBeforeFormSubmit"\n\t\t\t\t\t@form:submit="onFormSubmit"\n\t\t\t\t\t@form:send:success="onFormSendSuccess"\n\t\t\t\t\t@form:send:error="onFormSendError"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div v-show="formSuccess" class="bx-imopenlines-form-result-container bx-imopenlines-form-success">\n\t\t\t\t<div class="bx-imopenlines-form-result-icon"></div>\n\t\t\t\t<div class="bx-imopenlines-form-result-title">\n\t\t\t\t\t{{ getSuccessText() }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div v-show="formError" class="bx-imopenlines-form-result-container bx-imopenlines-form-error">\n\t\t\t\t<div class="bx-imopenlines-form-result-icon"></div>\n\t\t\t\t<div class="bx-imopenlines-form-result-title">\n\t\t\t\t\t{{ getErrorText() }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t'})})(this.window=this.window||{},BX,BX);
//# sourceMappingURL=form.bundle.map.js