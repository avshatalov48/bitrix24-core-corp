{"version":3,"file":"form.bundle.js","sources":["../src/form.js"],"sourcesContent":["/**\n * Bitrix Messenger\n * Form Vue component\n *\n * @package bitrix\n * @subpackage im\n * @copyright 2001-2019 Bitrix\n */\n\nimport { BitrixVue } from \"ui.vue\";\nimport { Vuex } from \"ui.vue.vuex\";\nimport './form.css';\n\nconst EVENT_POSTFIX = 'Openlines';\nconst LIVECHAT_PREFIX = 'livechat';\n\nBitrixVue.component('bx-imopenlines-form',\n{\n\tprops: {\n\t\tmessage: {\n\t\t\ttype: Object,\n\t\t\trequired: false\n\t\t}\n\t},\n\tdata: function() {\n\t\treturn {\n\t\t\tformSuccess: false,\n\t\t\tformError: false\n\t\t}\n\t},\n\tmounted()\n\t{\n\t\tif (this.filledFormFlag)\n\t\t{\n\t\t\tthis.formSuccess = true;\n\t\t}\n\t},\n\tcomputed:\n\t{\n\t\tchatId()\n\t\t{\n\t\t\treturn this.application.dialog.chatId;\n\t\t},\n\t\tformId()\n\t\t{\n\t\t\tif (this.message)\n\t\t\t{\n\t\t\t\treturn String(this.message.params.CRM_FORM_ID);\n\t\t\t}\n\n\t\t\tif (this.widget.common.crmFormsSettings.welcomeFormId)\n\t\t\t{\n\t\t\t\treturn this.widget.common.crmFormsSettings.welcomeFormId;\n\t\t\t}\n\n\t\t\treturn '';\n\t\t},\n\t\tformSec()\n\t\t{\n\t\t\tif (this.message)\n\t\t\t{\n\t\t\t\treturn this.message.params.CRM_FORM_SEC;\n\t\t\t}\n\n\t\t\tif (this.widget.common.crmFormsSettings.welcomeFormSec)\n\t\t\t{\n\t\t\t\treturn this.widget.common.crmFormsSettings.welcomeFormSec;\n\t\t\t}\n\n\t\t\treturn '';\n\t\t},\n\t\tshowForm()\n\t\t{\n\t\t\treturn this.formId && this.formSec && !this.formSuccess && !this.formError;\n\t\t},\n\t\tfilledFormFlag()\n\t\t{\n\t\t\tif (this.message)\n\t\t\t{\n\t\t\t\treturn this.message.params.CRM_FORM_FILLED === 'Y';\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t\tmessageCount()\n\t\t{\n\t\t\treturn this.dialog.messageCount;\n\t\t},\n\t\t...Vuex.mapState({\n\t\t\twidget: state => state.widget,\n\t\t\tapplication: state => state.application,\n\t\t\tdialog: state => state.dialogues.collection[state.application.dialog.dialogId]\n\t\t}),\n\t},\n\twatch:\n\t{\n\t\tfilledFormFlag(newValue)\n\t\t{\n\t\t\tif (newValue === true && !this.formSuccess)\n\t\t\t{\n\t\t\t\tthis.formSuccess = true;\n\t\t\t}\n\t\t},\n\t\tchatId(newValue)\n\t\t{\n\t\t\t// chatId > 0 means chat and user were initialized\n\t\t\tif (newValue !== 0 && this.widgetInitPromiseResolve)\n\t\t\t{\n\t\t\t\tthis.widgetInitPromiseResolve();\n\t\t\t}\n\t\t}\n\t},\n\tmethods:\n\t{\n\t\tgetCrmBindings()\n\t\t{\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis.$Bitrix.RestClient.get().callMethod('imopenlines.widget.crm.bindings.get', {\n\t\t\t\t\t'OPENLINES_CODE':  this.buildOpenlinesCode()\n\t\t\t\t}).then(resolve).catch(reject);\n\t\t\t});\n\t\t},\n\t\tonBeforeFormSubmit(eventData)\n\t\t{\n\t\t\tif (this.signedEntities && this.signedEntities !== '')\n\t\t\t{\n\t\t\t\teventData.sign = this.signedEntities;\n\t\t\t}\n\t\t},\n\t\tonFormSubmit(eventData)\n\t\t{\n\t\t\tthis.eventData = eventData;\n\t\t\t// redefine form promise so we can send form manually later\n\t\t\tthis.eventData.promise = this.eventData.promise.then(() => new Promise(resolve => {\n\t\t\t\tif (this.chatId === 0)\n\t\t\t\t{\n\t\t\t\t\t// promise we resolve after user and chat are inited, resolve method is saved to use in chatId watcher\n\t\t\t\t\tnew Promise((widgetResolve, widgetReject) => {\n\t\t\t\t\t\tthis.widgetInitPromiseResolve = widgetResolve;\n\t\t\t\t\t}).then(() => {\n\t\t\t\t\t\tthis.setFormProperties();\n\t\t\t\t\t\treturn resolve();\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.getApplication().requestData();\n\t\t\t\t}\n\t\t\t\t// we have user and chat so we can just resolve form promise instantly\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t// request current crm bindings and attach them to form\n\t\t\t\t\tif (this.widget.common.crmFormsSettings.welcomeFormDelay)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getCrmBindings().then((result) => {\n\t\t\t\t\t\t\tthis.signedEntities = result.data();\n\n\t\t\t\t\t\t\tthis.setFormProperties();\n\t\t\t\t\t\t\treturn resolve();\n\t\t\t\t\t\t}).catch((error) => {\n\t\t\t\t\t\t\tconsole.error('Error getting CRM bindings', error);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.setFormProperties();\n\t\t\t\t\t\treturn resolve();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}));\n\t\t},\n\t\tsetFormProperties()\n\t\t{\n\t\t\tif (!this.eventData)\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tthis.eventData.form.setProperty('eventNamePostfix', EVENT_POSTFIX);\n\t\t\tthis.eventData.form.setProperty('openlinesCode', this.buildOpenlinesCode());\n\t\t\tif (this.message)\n\t\t\t{\n\t\t\t\tthis.eventData.form.setProperty('messageId', this.message.id);\n\t\t\t\tthis.eventData.form.setProperty('isWelcomeForm', this.message.params.IS_WELCOME_FORM ?? 'N');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.eventData.form.setProperty('isWelcomeForm', 'Y');\n\t\t\t}\n\t\t},\n\t\tbuildOpenlinesCode()\n\t\t{\n\t\t\tlet configId = 0;\n\t\t\tif (this.dialog.entityId !== '')\n\t\t\t{\n\t\t\t\tconfigId = this.dialog.entityId.split('|')[0];\n\t\t\t}\n\t\t\tconst chatId = this.dialog.chatId || 0;\n\t\t\tconst userId = this.application.common.userId || 0;\n\n\t\t\treturn `${LIVECHAT_PREFIX}|${configId}|${chatId}|${userId}`;\n\t\t},\n\t\tonFormSendSuccess()\n\t\t{\n\t\t\tif (!this.message)\n\t\t\t{\n\t\t\t\tthis.$store.commit('widget/common', {dialogStart: true});\n\t\t\t}\n\n\t\t\tthis.$emit('formSendSuccess');\n\t\t\tthis.formSuccess = true;\n\t\t},\n\t\tonFormSendError(error)\n\t\t{\n\t\t\tthis.formError = true;\n\t\t\tthis.$emit('formSendError', {error});\n\t\t},\n\t\tgetSuccessText()\n\t\t{\n\t\t\treturn this.widget.common.crmFormsSettings.successText;\n\t\t},\n\t\tgetErrorText()\n\t\t{\n\t\t\treturn this.widget.common.crmFormsSettings.errorText;\n\t\t},\n\t\tgetApplication()\n\t\t{\n\t\t\treturn this.$Bitrix.Application.get();\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-message bx-im-message-without-menu bx-im-message-without-avatar bx-imopenlines-form-wrapper\">\n\t\t\t<div v-show=\"showForm\" class=\"bx-imopenlines-form-content\">\n\t\t\t\t<bx-crm-form\n\t\t\t\t\t:id=\"formId\"\n\t\t\t\t\t:sec=\"formSec\"\n\t\t\t\t\t:address=\"widget.common.host\"\n\t\t\t\t\t:lang=\"application.common.languageId\"\n\t\t\t\t\t@form:submit:post:before=\"onBeforeFormSubmit\"\n\t\t\t\t\t@form:submit=\"onFormSubmit\"\n\t\t\t\t\t@form:send:success=\"onFormSendSuccess\"\n\t\t\t\t\t@form:send:error=\"onFormSendError\"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div v-show=\"formSuccess\" class=\"bx-imopenlines-form-result-container bx-imopenlines-form-success\">\n\t\t\t\t<div class=\"bx-imopenlines-form-result-icon\"></div>\n\t\t\t\t<div class=\"bx-imopenlines-form-result-title\">\n\t\t\t\t\t{{ getSuccessText() }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div v-show=\"formError\" class=\"bx-imopenlines-form-result-container bx-imopenlines-form-error\">\n\t\t\t\t<div class=\"bx-imopenlines-form-result-icon\"></div>\n\t\t\t\t<div class=\"bx-imopenlines-form-result-title\">\n\t\t\t\t\t{{ getErrorText() }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`\n});\n"],"names":["EVENT_POSTFIX","LIVECHAT_PREFIX","BitrixVue","component","props","message","type","Object","required","data","formSuccess","formError","mounted","filledFormFlag","computed","chatId","application","dialog","formId","String","params","CRM_FORM_ID","widget","common","crmFormsSettings","welcomeFormId","formSec","CRM_FORM_SEC","welcomeFormSec","showForm","CRM_FORM_FILLED","messageCount","Vuex","mapState","state","dialogues","collection","dialogId","watch","newValue","widgetInitPromiseResolve","methods","getCrmBindings","Promise","resolve","reject","$Bitrix","RestClient","get","callMethod","buildOpenlinesCode","then","onBeforeFormSubmit","eventData","signedEntities","sign","onFormSubmit","promise","widgetResolve","widgetReject","setFormProperties","getApplication","requestData","welcomeFormDelay","result","error","console","form","setProperty","id","IS_WELCOME_FORM","configId","entityId","split","userId","onFormSendSuccess","$store","commit","dialogStart","$emit","onFormSendError","getSuccessText","successText","getErrorText","errorText","Application","template"],"mappings":";;;;;;IAaA,IAAMA,aAAa,GAAG,WAAtB;IACA,IAAMC,eAAe,GAAG,UAAxB;AAEAC,oBAAS,CAACC,SAAV,CAAoB,qBAApB,EACA;IACCC,EAAAA,KAAK,EAAE;IACNC,IAAAA,OAAO,EAAE;IACRC,MAAAA,IAAI,EAAEC,MADE;IAERC,MAAAA,QAAQ,EAAE;IAFF;IADH,GADR;IAOCC,EAAAA,IAAI,EAAE,gBAAW;IAChB,WAAO;IACNC,MAAAA,WAAW,EAAE,KADP;IAENC,MAAAA,SAAS,EAAE;IAFL,KAAP;IAIA,GAZF;IAaCC,EAAAA,OAbD,qBAcC;IACC,QAAI,KAAKC,cAAT,EACA;IACC,WAAKH,WAAL,GAAmB,IAAnB;IACA;IACD,GAnBF;IAoBCI,EAAAA,QAAQ;IAEPC,IAAAA,MAFO,oBAGP;IACC,aAAO,KAAKC,WAAL,CAAiBC,MAAjB,CAAwBF,MAA/B;IACA,KALM;IAMPG,IAAAA,MANO,oBAOP;IACC,UAAI,KAAKb,OAAT,EACA;IACC,eAAOc,MAAM,CAAC,KAAKd,OAAL,CAAae,MAAb,CAAoBC,WAArB,CAAb;IACA;;IAED,UAAI,KAAKC,MAAL,CAAYC,MAAZ,CAAmBC,gBAAnB,CAAoCC,aAAxC,EACA;IACC,eAAO,KAAKH,MAAL,CAAYC,MAAZ,CAAmBC,gBAAnB,CAAoCC,aAA3C;IACA;;IAED,aAAO,EAAP;IACA,KAnBM;IAoBPC,IAAAA,OApBO,qBAqBP;IACC,UAAI,KAAKrB,OAAT,EACA;IACC,eAAO,KAAKA,OAAL,CAAae,MAAb,CAAoBO,YAA3B;IACA;;IAED,UAAI,KAAKL,MAAL,CAAYC,MAAZ,CAAmBC,gBAAnB,CAAoCI,cAAxC,EACA;IACC,eAAO,KAAKN,MAAL,CAAYC,MAAZ,CAAmBC,gBAAnB,CAAoCI,cAA3C;IACA;;IAED,aAAO,EAAP;IACA,KAjCM;IAkCPC,IAAAA,QAlCO,sBAmCP;IACC,aAAO,KAAKX,MAAL,IAAe,KAAKQ,OAApB,IAA+B,CAAC,KAAKhB,WAArC,IAAoD,CAAC,KAAKC,SAAjE;IACA,KArCM;IAsCPE,IAAAA,cAtCO,4BAuCP;IACC,UAAI,KAAKR,OAAT,EACA;IACC,eAAO,KAAKA,OAAL,CAAae,MAAb,CAAoBU,eAApB,KAAwC,GAA/C;IACA;;IAED,aAAO,KAAP;IACA,KA9CM;IA+CPC,IAAAA,YA/CO,0BAgDP;IACC,aAAO,KAAKd,MAAL,CAAYc,YAAnB;IACA;IAlDM,KAmDJC,gBAAI,CAACC,QAAL,CAAc;IAChBX,IAAAA,MAAM,EAAE,gBAAAY,KAAK;IAAA,aAAIA,KAAK,CAACZ,MAAV;IAAA,KADG;IAEhBN,IAAAA,WAAW,EAAE,qBAAAkB,KAAK;IAAA,aAAIA,KAAK,CAAClB,WAAV;IAAA,KAFF;IAGhBC,IAAAA,MAAM,EAAE,gBAAAiB,KAAK;IAAA,aAAIA,KAAK,CAACC,SAAN,CAAgBC,UAAhB,CAA2BF,KAAK,CAAClB,WAAN,CAAkBC,MAAlB,CAAyBoB,QAApD,CAAJ;IAAA;IAHG,GAAd,CAnDI,CApBT;IA6ECC,EAAAA,KAAK,EACL;IACCzB,IAAAA,cADD,0BACgB0B,QADhB,EAEC;IACC,UAAIA,QAAQ,KAAK,IAAb,IAAqB,CAAC,KAAK7B,WAA/B,EACA;IACC,aAAKA,WAAL,GAAmB,IAAnB;IACA;IACD,KAPF;IAQCK,IAAAA,MARD,kBAQQwB,QARR,EASC;IACC;IACA,UAAIA,QAAQ,KAAK,CAAb,IAAkB,KAAKC,wBAA3B,EACA;IACC,aAAKA,wBAAL;IACA;IACD;IAfF,GA9ED;IA+FCC,EAAAA,OAAO,EACP;IACCC,IAAAA,cADD,4BAEC;IAAA;;IACC,aAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;IACvC,QAAA,KAAI,CAACC,OAAL,CAAaC,UAAb,CAAwBC,GAAxB,GAA8BC,UAA9B,CAAyC,qCAAzC,EAAgF;IAC/E,4BAAmB,KAAI,CAACC,kBAAL;IAD4D,SAAhF,EAEGC,IAFH,CAEQP,OAFR,WAEuBC,MAFvB;IAGA,OAJM,CAAP;IAKA,KARF;IASCO,IAAAA,kBATD,8BASoBC,SATpB,EAUC;IACC,UAAI,KAAKC,cAAL,IAAuB,KAAKA,cAAL,KAAwB,EAAnD,EACA;IACCD,QAAAA,SAAS,CAACE,IAAV,GAAiB,KAAKD,cAAtB;IACA;IACD,KAfF;IAgBCE,IAAAA,YAhBD,wBAgBcH,SAhBd,EAiBC;IAAA;;IACC,WAAKA,SAAL,GAAiBA,SAAjB,CADD;;IAGC,WAAKA,SAAL,CAAeI,OAAf,GAAyB,KAAKJ,SAAL,CAAeI,OAAf,CAAuBN,IAAvB,CAA4B;IAAA,eAAM,IAAIR,OAAJ,CAAY,UAAAC,OAAO,EAAI;IACjF,cAAI,MAAI,CAAC7B,MAAL,KAAgB,CAApB,EACA;IACC;IACA,gBAAI4B,OAAJ,CAAY,UAACe,aAAD,EAAgBC,YAAhB,EAAiC;IAC5C,cAAA,MAAI,CAACnB,wBAAL,GAAgCkB,aAAhC;IACA,aAFD,EAEGP,IAFH,CAEQ,YAAM;IACb,cAAA,MAAI,CAACS,iBAAL;;IACA,qBAAOhB,OAAO,EAAd;IACA,aALD;;IAOA,YAAA,MAAI,CAACiB,cAAL,GAAsBC,WAAtB;IACA,WAXD;IAAA,eAcA;IACC;IACA,gBAAI,MAAI,CAACxC,MAAL,CAAYC,MAAZ,CAAmBC,gBAAnB,CAAoCuC,gBAAxC,EACA;IACC,cAAA,MAAI,CAACrB,cAAL,GAAsBS,IAAtB,CAA2B,UAACa,MAAD,EAAY;IACtC,gBAAA,MAAI,CAACV,cAAL,GAAsBU,MAAM,CAACvD,IAAP,EAAtB;;IAEA,gBAAA,MAAI,CAACmD,iBAAL;;IACA,uBAAOhB,OAAO,EAAd;IACA,eALD,WAKS,UAACqB,KAAD,EAAW;IACnBC,gBAAAA,OAAO,CAACD,KAAR,CAAc,4BAAd,EAA4CA,KAA5C;IACA,eAPD;IAQA,aAVD,MAYA;IACC,cAAA,MAAI,CAACL,iBAAL;;IACA,qBAAOhB,OAAO,EAAd;IACA;IACD;IACD,SAlC0D,CAAN;IAAA,OAA5B,CAAzB;IAmCA,KAvDF;IAwDCgB,IAAAA,iBAxDD,+BAyDC;IACC,UAAI,CAAC,KAAKP,SAAV,EACA;IACC,eAAO,KAAP;IACA;;IAED,WAAKA,SAAL,CAAec,IAAf,CAAoBC,WAApB,CAAgC,kBAAhC,EAAoDpE,aAApD;IACA,WAAKqD,SAAL,CAAec,IAAf,CAAoBC,WAApB,CAAgC,eAAhC,EAAiD,KAAKlB,kBAAL,EAAjD;;IACA,UAAI,KAAK7C,OAAT,EACA;IAAA;;IACC,aAAKgD,SAAL,CAAec,IAAf,CAAoBC,WAApB,CAAgC,WAAhC,EAA6C,KAAK/D,OAAL,CAAagE,EAA1D;IACA,aAAKhB,SAAL,CAAec,IAAf,CAAoBC,WAApB,CAAgC,eAAhC,2BAAiD,KAAK/D,OAAL,CAAae,MAAb,CAAoBkD,eAArE,yEAAwF,GAAxF;IACA,OAJD,MAMA;IACC,aAAKjB,SAAL,CAAec,IAAf,CAAoBC,WAApB,CAAgC,eAAhC,EAAiD,GAAjD;IACA;IACD,KA1EF;IA2EClB,IAAAA,kBA3ED,gCA4EC;IACC,UAAIqB,QAAQ,GAAG,CAAf;;IACA,UAAI,KAAKtD,MAAL,CAAYuD,QAAZ,KAAyB,EAA7B,EACA;IACCD,QAAAA,QAAQ,GAAG,KAAKtD,MAAL,CAAYuD,QAAZ,CAAqBC,KAArB,CAA2B,GAA3B,EAAgC,CAAhC,CAAX;IACA;;IACD,UAAM1D,MAAM,GAAG,KAAKE,MAAL,CAAYF,MAAZ,IAAsB,CAArC;IACA,UAAM2D,MAAM,GAAG,KAAK1D,WAAL,CAAiBO,MAAjB,CAAwBmD,MAAxB,IAAkC,CAAjD;IAEA,uBAAUzE,eAAV,cAA6BsE,QAA7B,cAAyCxD,MAAzC,cAAmD2D,MAAnD;IACA,KAtFF;IAuFCC,IAAAA,iBAvFD,+BAwFC;IACC,UAAI,CAAC,KAAKtE,OAAV,EACA;IACC,aAAKuE,MAAL,CAAYC,MAAZ,CAAmB,eAAnB,EAAoC;IAACC,UAAAA,WAAW,EAAE;IAAd,SAApC;IACA;;IAED,WAAKC,KAAL,CAAW,iBAAX;IACA,WAAKrE,WAAL,GAAmB,IAAnB;IACA,KAhGF;IAiGCsE,IAAAA,eAjGD,2BAiGiBf,KAjGjB,EAkGC;IACC,WAAKtD,SAAL,GAAiB,IAAjB;IACA,WAAKoE,KAAL,CAAW,eAAX,EAA4B;IAACd,QAAAA,KAAK,EAALA;IAAD,OAA5B;IACA,KArGF;IAsGCgB,IAAAA,cAtGD,4BAuGC;IACC,aAAO,KAAK3D,MAAL,CAAYC,MAAZ,CAAmBC,gBAAnB,CAAoC0D,WAA3C;IACA,KAzGF;IA0GCC,IAAAA,YA1GD,0BA2GC;IACC,aAAO,KAAK7D,MAAL,CAAYC,MAAZ,CAAmBC,gBAAnB,CAAoC4D,SAA3C;IACA,KA7GF;IA8GCvB,IAAAA,cA9GD,4BA+GC;IACC,aAAO,KAAKf,OAAL,CAAauC,WAAb,CAAyBrC,GAAzB,EAAP;IACA;IAjHF,GAhGD;IAmNCsC,EAAAA,QAAQ;IAnNT,CADA;;;;"}