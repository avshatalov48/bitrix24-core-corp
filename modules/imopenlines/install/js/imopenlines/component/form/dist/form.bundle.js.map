{"version":3,"file":"form.bundle.js","sources":["../src/form.js"],"sourcesContent":["/**\n * Bitrix Messenger\n * Form Vue component\n *\n * @package bitrix\n * @subpackage im\n * @copyright 2001-2019 Bitrix\n */\n\nimport { BitrixVue } from \"ui.vue\";\nimport { Vuex } from \"ui.vue.vuex\";\nimport './form.css';\nimport 'ui.fonts.opensans';\n\nconst EVENT_POSTFIX = 'Openlines';\nconst LIVECHAT_PREFIX = 'livechat';\n\nBitrixVue.component('bx-imopenlines-form',\n{\n\tprops: {\n\t\tmessage: {\n\t\t\ttype: Object,\n\t\t\trequired: false\n\t\t}\n\t},\n\tdata: function() {\n\t\treturn {\n\t\t\tformSuccess: false,\n\t\t\tformError: false\n\t\t}\n\t},\n\tmounted()\n\t{\n\t\tif (this.filledFormFlag)\n\t\t{\n\t\t\tthis.formSuccess = true;\n\t\t}\n\t},\n\tcomputed:\n\t{\n\t\tchatId()\n\t\t{\n\t\t\treturn this.application.dialog.chatId;\n\t\t},\n\t\tformId()\n\t\t{\n\t\t\tif (this.message)\n\t\t\t{\n\t\t\t\treturn String(this.message.params.CRM_FORM_ID);\n\t\t\t}\n\n\t\t\tif (this.widget.common.crmFormsSettings.welcomeFormId)\n\t\t\t{\n\t\t\t\treturn this.widget.common.crmFormsSettings.welcomeFormId;\n\t\t\t}\n\n\t\t\treturn '';\n\t\t},\n\t\tformSec()\n\t\t{\n\t\t\tif (this.message)\n\t\t\t{\n\t\t\t\treturn this.message.params.CRM_FORM_SEC;\n\t\t\t}\n\n\t\t\tif (this.widget.common.crmFormsSettings.welcomeFormSec)\n\t\t\t{\n\t\t\t\treturn this.widget.common.crmFormsSettings.welcomeFormSec;\n\t\t\t}\n\n\t\t\treturn '';\n\t\t},\n\t\tshowForm()\n\t\t{\n\t\t\treturn this.formId && this.formSec && !this.formSuccess && !this.formError;\n\t\t},\n\t\tfilledFormFlag()\n\t\t{\n\t\t\tif (this.message)\n\t\t\t{\n\t\t\t\treturn this.message.params.CRM_FORM_FILLED === 'Y';\n\t\t\t}\n\n\t\t\treturn false;\n\t\t},\n\t\tmessageCount()\n\t\t{\n\t\t\treturn this.dialog.messageCount;\n\t\t},\n\t\t...Vuex.mapState({\n\t\t\twidget: state => state.widget,\n\t\t\tapplication: state => state.application,\n\t\t\tdialog: state => state.dialogues.collection[state.application.dialog.dialogId]\n\t\t}),\n\t},\n\twatch:\n\t{\n\t\tfilledFormFlag(newValue)\n\t\t{\n\t\t\tif (newValue === true && !this.formSuccess)\n\t\t\t{\n\t\t\t\tthis.formSuccess = true;\n\t\t\t}\n\t\t},\n\t\tchatId(newValue)\n\t\t{\n\t\t\t// chatId > 0 means chat and user were initialized\n\t\t\tif (newValue !== 0 && this.widgetInitPromiseResolve)\n\t\t\t{\n\t\t\t\tthis.widgetInitPromiseResolve();\n\t\t\t}\n\t\t}\n\t},\n\tmethods:\n\t{\n\t\tgetCrmBindings()\n\t\t{\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis.$Bitrix.RestClient.get().callMethod('imopenlines.widget.crm.bindings.get', {\n\t\t\t\t\t'OPENLINES_CODE':  this.buildOpenlinesCode()\n\t\t\t\t}).then(resolve).catch(reject);\n\t\t\t});\n\t\t},\n\t\tonBeforeFormSubmit(eventData)\n\t\t{\n\t\t\tif (this.signedEntities && this.signedEntities !== '')\n\t\t\t{\n\t\t\t\teventData.sign = this.signedEntities;\n\t\t\t}\n\t\t},\n\t\tonFormSubmit(eventData)\n\t\t{\n\t\t\tthis.eventData = eventData;\n\t\t\t// redefine form promise so we can send form manually later\n\t\t\tthis.eventData.promise = this.eventData.promise.then(() => new Promise(resolve => {\n\t\t\t\tif (this.chatId === 0)\n\t\t\t\t{\n\t\t\t\t\t// promise we resolve after user and chat are inited, resolve method is saved to use in chatId watcher\n\t\t\t\t\tnew Promise((widgetResolve, widgetReject) => {\n\t\t\t\t\t\tthis.widgetInitPromiseResolve = widgetResolve;\n\t\t\t\t\t}).then(() => {\n\t\t\t\t\t\tthis.setFormProperties();\n\t\t\t\t\t\treturn resolve();\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.getApplication().requestData();\n\t\t\t\t}\n\t\t\t\t// we have user and chat so we can just resolve form promise instantly\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t// request current crm bindings and attach them to form\n\t\t\t\t\tif (this.widget.common.crmFormsSettings.welcomeFormDelay)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.getCrmBindings().then((result) => {\n\t\t\t\t\t\t\tthis.signedEntities = result.data();\n\n\t\t\t\t\t\t\tthis.setFormProperties();\n\t\t\t\t\t\t\treturn resolve();\n\t\t\t\t\t\t}).catch((error) => {\n\t\t\t\t\t\t\tconsole.error('Error getting CRM bindings', error);\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.setFormProperties();\n\t\t\t\t\t\treturn resolve();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}));\n\t\t},\n\t\tsetFormProperties()\n\t\t{\n\t\t\tif (!this.eventData)\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tthis.eventData.form.setProperty('eventNamePostfix', EVENT_POSTFIX);\n\t\t\tthis.eventData.form.setProperty('openlinesCode', this.buildOpenlinesCode());\n\t\t\tif (this.message)\n\t\t\t{\n\t\t\t\tthis.eventData.form.setProperty('messageId', this.message.id);\n\t\t\t\tthis.eventData.form.setProperty('isWelcomeForm', this.message.params.IS_WELCOME_FORM ?? 'N');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.eventData.form.setProperty('isWelcomeForm', 'Y');\n\t\t\t}\n\t\t},\n\t\tbuildOpenlinesCode()\n\t\t{\n\t\t\tlet configId = 0;\n\t\t\tif (this.dialog.entityId !== '')\n\t\t\t{\n\t\t\t\tconfigId = this.dialog.entityId.split('|')[0];\n\t\t\t}\n\t\t\tconst chatId = this.dialog.chatId || 0;\n\t\t\tconst userId = this.application.common.userId || 0;\n\n\t\t\treturn `${LIVECHAT_PREFIX}|${configId}|${chatId}|${userId}`;\n\t\t},\n\t\tonFormSendSuccess()\n\t\t{\n\t\t\tif (!this.message)\n\t\t\t{\n\t\t\t\tthis.$store.commit('widget/common', {dialogStart: true});\n\t\t\t}\n\n\t\t\tthis.$emit('formSendSuccess');\n\t\t\tthis.formSuccess = true;\n\t\t},\n\t\tonFormSendError(error)\n\t\t{\n\t\t\tthis.formError = true;\n\t\t\tthis.$emit('formSendError', {error});\n\t\t},\n\t\tgetSuccessText()\n\t\t{\n\t\t\treturn this.widget.common.crmFormsSettings.successText;\n\t\t},\n\t\tgetErrorText()\n\t\t{\n\t\t\treturn this.widget.common.crmFormsSettings.errorText;\n\t\t},\n\t\tgetApplication()\n\t\t{\n\t\t\treturn this.$Bitrix.Application.get();\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-message bx-im-message-without-menu bx-im-message-without-avatar bx-imopenlines-form-wrapper\">\n\t\t\t<div v-show=\"showForm\" class=\"bx-imopenlines-form-content\">\n\t\t\t\t<bx-crm-form\n\t\t\t\t\t:id=\"formId\"\n\t\t\t\t\t:sec=\"formSec\"\n\t\t\t\t\t:address=\"widget.common.host\"\n\t\t\t\t\t:lang=\"application.common.languageId\"\n\t\t\t\t\t@form:submit:post:before=\"onBeforeFormSubmit\"\n\t\t\t\t\t@form:submit=\"onFormSubmit\"\n\t\t\t\t\t@form:send:success=\"onFormSendSuccess\"\n\t\t\t\t\t@form:send:error=\"onFormSendError\"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div v-show=\"formSuccess\" class=\"bx-imopenlines-form-result-container bx-imopenlines-form-success\">\n\t\t\t\t<div class=\"bx-imopenlines-form-result-icon\"></div>\n\t\t\t\t<div class=\"bx-imopenlines-form-result-title\">\n\t\t\t\t\t{{ getSuccessText() }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div v-show=\"formError\" class=\"bx-imopenlines-form-result-container bx-imopenlines-form-error\">\n\t\t\t\t<div class=\"bx-imopenlines-form-result-icon\"></div>\n\t\t\t\t<div class=\"bx-imopenlines-form-result-title\">\n\t\t\t\t\t{{ getErrorText() }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`\n});\n"],"names":["EVENT_POSTFIX","LIVECHAT_PREFIX","BitrixVue","component","props","message","type","Object","required","data","formSuccess","formError","mounted","filledFormFlag","computed","chatId","application","dialog","formId","String","params","CRM_FORM_ID","widget","common","crmFormsSettings","welcomeFormId","formSec","CRM_FORM_SEC","welcomeFormSec","showForm","CRM_FORM_FILLED","messageCount","Vuex","mapState","state","dialogues","collection","dialogId","watch","newValue","widgetInitPromiseResolve","methods","getCrmBindings","Promise","resolve","reject","$Bitrix","RestClient","get","callMethod","buildOpenlinesCode","then","onBeforeFormSubmit","eventData","signedEntities","sign","onFormSubmit","promise","widgetResolve","widgetReject","setFormProperties","getApplication","requestData","welcomeFormDelay","result","error","console","form","setProperty","id","IS_WELCOME_FORM","configId","entityId","split","userId","onFormSendSuccess","$store","commit","dialogStart","$emit","onFormSendError","getSuccessText","successText","getErrorText","errorText","Application","template"],"mappings":"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"}