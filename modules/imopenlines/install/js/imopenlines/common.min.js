(function(){BX.namespace("BX.OpenLines");if(typeof BX.OpenlinesLongRunningProcessState==="undefined"){BX.OpenlinesLongRunningProcessState={intermediate:0,running:1,completed:2,stoped:3,error:4}}if(typeof BX.OpenlinesLongRunningProcessDialog==="undefined"){BX.OpenlinesLongRunningProcessDialog=function(){this._id="";this._settings={};this._serviceUrl="";this._method="POST";this._params={};this._option={};this._dlg=null;this._buttons={};this._summary=null;this._progressUI=null;this._progressbar=null;this._isSummaryHtml=false;this._isShown=false;this._state=BX.OpenlinesLongRunningProcessState.intermediate;this._cancelRequest=false;this._requestIsRunning=false;this._networkErrorCount=0;this._requestHandler=null};BX.OpenlinesLongRunningProcessDialog.prototype={initialize:function(t,e){this._id=BX.type.isNotEmptyString(t)?t:"openlines_long_run_proc_"+Math.random().toString().substring(2);this._settings=e?e:{};this._method=this.getSetting("method","POST");this._serviceUrl=this.getSetting("serviceUrl","");this._action=this.getSetting("action","");if(!BX.type.isNotEmptyString(this._action)){throw"BX.OpenlinesLongRunningProcess. Could not find action."}this._params=this.getSetting("params");if(!this._params){this._params={}}this._isSummaryHtml=!!this.getSetting("isSummaryHtml",false);if(typeof BX.UI!="undefined"&&typeof BX.UI.ProgressBar!="undefined"){this._progressUI=new BX.UI.ProgressBar({statusType:BX.UI.ProgressBar.Status.COUNTER,size:BX.UI.ProgressBar.Size.LARGE,fill:true})}this._requestHandler=this.getSetting("requestHandler",null)},getId:function(){return this._id},getSetting:function(t,e){return this._settings.hasOwnProperty(t)?this._settings[t]:e},setSetting:function(t,e){this._settings[t]=e},getMessage:function(t){return BX.OpenlinesLongRunningProcessDialog.messages&&BX.OpenlinesLongRunningProcessDialog.messages.hasOwnProperty(t)?BX.OpenlinesLongRunningProcessDialog.messages[t]:""},getState:function(){return this._state},getServiceUrl:function(){return this._serviceUrl},getAction:function(){return this._action},setAction:function(t){this._action=t},getParams:function(){return this._params},show:function(){if(this._isShown){return}this._dlg=BX.PopupWindowManager.create(this._id.toLowerCase(),this._anchor,{className:"bx-openlines-dialog-wrap bx-openlines-dialog-long-run-proc",autoHide:false,bindOptions:{forceBindPosition:false},buttons:this._prepareDialogButtons(),closeByEsc:false,closeIcon:false,content:this._prepareDialogContent(),draggable:true,events:{onPopupClose:BX.delegate(this._onDialogClose,this)},offsetLeft:0,offsetTop:0,titleBar:this.getSetting("title",""),overlay:true});if(!this._dlg.isShown()){this._dlg.show()}this._isShown=this._dlg.isShown()},close:function(){if(!this._isShown){return}if(this._dlg){this._dlg.close()}this._isShown=false},start:function(){if(this._state===BX.OpenlinesLongRunningProcessState.intermediate||this._state===BX.OpenlinesLongRunningProcessState.stoped||this._state===BX.OpenlinesLongRunningProcessState.completed){this._startRequest()}},stop:function(){if(this._state===BX.OpenlinesLongRunningProcessState.running){this._stopRequest()}},_prepareDialogContent:function(){var t=this.getSetting("summary","");var e={attrs:{className:"bx-openlines-dialog-long-run-proc-summary"}};if(this._isSummaryHtml){e["html"]=t}else{e["text"]=t}this._summary=BX.create("DIV",e);if(this._progressUI){this._progressbar=BX.create("DIV",{attrs:{className:"bx-openlines-dialog-long-run-proc-progressbar"},style:{display:"none"},children:[this._progressUI.getContainer()]})}var s=[this._summary];if(this._progressbar)s.push(this._progressbar);return BX.create("DIV",{attrs:{className:"bx-openlines-dialog-long-run-proc-popup"},children:s})},_prepareDialogButtons:function(){this._buttons={};var t=this.getMessage("startButton");this._buttons["start"]=new BX.PopupWindowButton({text:t!==""?t:"Start",className:"popup-window-button-accept",events:{click:BX.delegate(this._handleStartButtonClick,this)}});var e=this.getMessage("stopButton");this._buttons["stop"]=new BX.PopupWindowButton({text:e!==""?e:"Stop",className:"popup-window-button-disable",events:{click:BX.delegate(this._handleStopButtonClick,this)}});var s=this.getMessage("closeButton");this._buttons["close"]=new BX.PopupWindowButtonLink({text:s!==""?s:"Close",className:"popup-window-button-link-cancel",events:{click:BX.delegate(this._handleCloseButtonClick,this)}});return[this._buttons["start"],this._buttons["stop"],this._buttons["close"]]},_onDialogClose:function(t){if(this._dlg){this._dlg.destroy();this._dlg=null}this._setState(BX.OpenlinesLongRunningProcessState.intermediate);this._buttons={};this._summary=null;this._isShown=false;BX.onCustomEvent(this,"ON_CLOSE",[this])},_handleStartButtonClick:function(){var t=typeof this._buttons["start"]!=="undefined"?this._buttons["start"]:null;if(t){var e=BX.data(t.buttonNode,"disabled");if(e===true){return}}this.start()},_handleStopButtonClick:function(){var t=typeof this._buttons["stop"]!=="undefined"?this._buttons["stop"]:null;if(t){var e=BX.data(t.buttonNode,"disabled");if(e===true){return}}this.stop()},_handleCloseButtonClick:function(){if(this._state!==BX.OpenlinesLongRunningProcessState.running){this._dlg.close()}},_lockButton:function(t,e){var s=typeof this._buttons[t]!=="undefined"?this._buttons[t]:null;if(!s){return}if(!!e){BX.removeClass(s.buttonNode,"popup-window-button-accept");BX.addClass(s.buttonNode,"popup-window-button-disable");s.buttonNode.disabled=true;BX.data(s.buttonNode,"disabled",true)}else{BX.removeClass(s.buttonNode,"popup-window-button-disable");BX.addClass(s.buttonNode,"popup-window-button-accept");s.buttonNode.disabled=false;BX.data(s.buttonNode,"disabled",false)}},_showButton:function(t,e){var s=typeof this._buttons[t]!=="undefined"?this._buttons[t]:null;if(s){s.buttonNode.style.display=!!e?"":"none"}},_setSummary:function(t,e){e=!!e;if(this._summary){if(e)this._summary.innerHTML=t;else this._summary.innerHTML=BX.util.htmlspecialchars(t)}},_setProgressBar:function(t,e){if(this._progressUI){if(BX.type.isNumber(e)&&BX.type.isNumber(t)&&t>0){BX.show(this._progressbar);this._progressUI.setMaxValue(t);this._progressUI.update(e)}else{BX.hide(this._progressbar)}}},_setState:function(t){if(this._state===t){return}this._state=t;if(t===BX.OpenlinesLongRunningProcessState.intermediate||t===BX.OpenlinesLongRunningProcessState.stoped){this._lockButton("start",false);this._lockButton("stop",true);this._showButton("close",true)}else if(t===BX.OpenlinesLongRunningProcessState.running){this._lockButton("start",true);this._lockButton("stop",false);this._showButton("close",false)}else if(t===BX.OpenlinesLongRunningProcessState.completed||t===BX.OpenlinesLongRunningProcessState.error){this._lockButton("start",true);this._lockButton("stop",true);this._showButton("close",true)}if(this._progressUI){if(t===BX.OpenlinesLongRunningProcessState.completed){BX.hide(this._progressbar)}if(t===BX.OpenlinesLongRunningProcessState.error){this._progressUI.setColor(BX.UI.ProgressBar.Color.DANGER)}}BX.onCustomEvent(this,"ON_STATE_CHANGE",[this])},_startRequest:function(){if(this._requestIsRunning){return}this._requestIsRunning=true;this._setState(BX.OpenlinesLongRunningProcessState.running);var t=BX.clone(this._params);BX.ajax.runComponentAction("bitrix:imopenlines.statistics.detail",this._action,{data:t,method:this._method}).then(BX.delegate(this._onRequestSuccess,this),BX.delegate(this._onRequestFailure,this))},_stopRequest:function(){if(this._cancelRequest){return}this._cancelRequest=true;this._requestIsRunning=false;this._setState(BX.OpenlinesLongRunningProcessState.stoped);var t;t=BX.clone(this._params);BX.ajax.runComponentAction("bitrix:imopenlines.statistics.detail","cancel",{data:t,method:this._method}).then(BX.delegate(this._onRequestSuccess,this),BX.delegate(this._onRequestFailure,this))},_onRequestSuccess:function(t){this._requestIsRunning=false;if(!t){this._setSummary(this.getMessage("requestError"));this._setState(BX.OpenlinesLongRunningProcessState.error);return}if(BX.type.isArray(t["errors"])&&t["errors"].length>0){var e=t["errors"][t["errors"].length-1];this._setState(BX.OpenlinesLongRunningProcessState.error);this._setSummary(e.message);return}t=t["data"];if(typeof this._requestHandler=="function"){this._requestHandler.call(this,t)}this._networkErrorCount=0;var s=BX.type.isNotEmptyString(t["STATUS"])?t["STATUS"]:"";var n=BX.type.isNotEmptyString(t["SUMMARY"])?t["SUMMARY"]:"";var i=false;if(!BX.type.isNotEmptyString(n)){n=BX.type.isNotEmptyString(t["SUMMARY_HTML"])?t["SUMMARY_HTML"]:"";i=true}if(s==="PROGRESS"){var o=BX.type.isNumber(t["PROCESSED_ITEMS"])?t["PROCESSED_ITEMS"]:0;var r=BX.type.isNumber(t["TOTAL_ITEMS"])?t["TOTAL_ITEMS"]:0;if(r>0){this._setProgressBar(r,o)}if(n!==""){this._setSummary(n,i)}if(this._cancelRequest){this._setState(BX.OpenlinesLongRunningProcessState.stoped);this._cancelRequest=false}else{var a=BX.type.isNotEmptyString(t["NEXT_ACTION"])?t["NEXT_ACTION"]:"";if(a!==""){this._action=a}window.setTimeout(BX.delegate(this._startRequest,this),200)}return}if(s==="NOT_REQUIRED"||s==="COMPLETED"){this._setState(BX.OpenlinesLongRunningProcessState.completed);if(n!==""){this._setSummary(n,i)}}else{this._setSummary(this.getMessage("requestError"));this._setState(BX.OpenlinesLongRunningProcessState.error)}if(this._cancelRequest){this._cancelRequest=false}},_onRequestFailure:function(t){this._requestIsRunning=false;if(BX.type.isArray(t["errors"])&&t["errors"].length>0){var e=t["errors"][t["errors"].length-1];if(e.code==="NETWORK_ERROR"){this._networkErrorCount++;if(this._networkErrorCount<=2){window.setTimeout(BX.delegate(this._startRequest,this),15e3);return}}this._setSummary(e.message)}else{this._setSummary(this.getMessage("requestError"))}this._setState(BX.OpenlinesLongRunningProcessState.error)}};if(typeof BX.OpenlinesLongRunningProcessDialog.messages=="undefined"){BX.OpenlinesLongRunningProcessDialog.messages={}}BX.OpenlinesLongRunningProcessDialog.items={};BX.OpenlinesLongRunningProcessDialog.create=function(t,e){var s=new BX.OpenlinesLongRunningProcessDialog;s.initialize(t,e);this.items[s.getId()]=s;return s}}})();
//# sourceMappingURL=common.map.js