jn.define("stafftrack/map",((e,t,s)=>{const{PureComponent:i}=e("layout/pure-component");const{Color:o,Corner:n,Indent:a}=e("tokens");const{downloadImages:r}=e("asset-manager");const{withCurrentDomain:l}=e("utils/url");const{Type:d}=e("type");const{Loc:c}=e("loc");const{showToast:h}=e("toast");const{outline:{alert:u}}=e("assets/icons");const{Line:g}=e("utils/skeleton");const{Haptics:p}=e("haptics");const{confirmDefaultAction:m}=e("alert");const{Switcher:f,SwitcherMode:S}=e("ui-system/blocks/switcher");const{ChipButton:I,ChipButtonDesign:C,ChipButtonMode:M}=e("ui-system/blocks/chips/chip-button");const{Text5:w,Text4:y}=e("ui-system/typography/text");const{Icon:L}=e("ui-system/blocks/icon");const{TextField:G}=e("ui-system/typography/text-field");const{LocationMenu:b}=e("stafftrack/map/location-menu");const{DisabledGeoUserEnum:A,showDisabledGeoAhaMoment:T}=e("stafftrack/map/disabled-geo-aha");const{ShiftAjax:E}=e("stafftrack/ajax");const{LocationEnum:O}=e("stafftrack/model/shift");const{Analytics:R}=e("stafftrack/analytics");const{SettingsManager:x}=e("stafftrack/data-managers/settings-manager");const D="/bitrix/mobileapp/stafftrackmobile/extensions/stafftrack/map/images/";const F=`${D}blurred-map-${Random.getInt(1,10)}.png`;void r([F]);const k=jnExtensionData.get("stafftrack:map").locationList;const _=Application.getPlatform()==="ios";class U extends i{constructor(e){super(e);this.layoutWidget=this.props.layoutWidget||PageManager;this.state={mapLoading:false,readOnly:this.props.readOnly||false,sendGeo:this.getDefaultSendGeo(),location:this.props.location||O.OFFICE.getValue(),signedGeoImageUrl:null,signedAddressString:null,geoImageUrl:this.props.geoImageUrl||F,addressString:this.props.address||null,customLocationRaw:this.props.customLocation||null,keyboardShow:false};this.locationChipRef=null;this.locationMenu=null;this.textFieldRef=null;this.switcherRef=null;this.openSelector=this.openSelector.bind(this);this.onSwitcherClick=this.onSwitcherClick.bind(this);this.handleOnChange=this.handleOnChange.bind(this);this.handleOnBlur=this.handleOnBlur.bind(this);this.handleOnFocus=this.handleOnFocus.bind(this);if(d.isStringFilled(this.props.geoImageUrl)){void r([this.props.geoImageUrl])}}get isFirstHelpViewed(){return this.props.isFirstHelpViewed??true}get isUserAdmin(){return this.props.userInfo?.isAdmin}getDefaultSendGeo(){if(d.isNil(this.props.sendGeo)){return x.isGeoEnabled()}return x.isGeoEnabled()&&this.props.sendGeo}componentDidMount(){if(this.state.sendGeo===true){this.handleUserGeo()}}componentDidUpdate(e,t){super.componentDidUpdate(e,t);if(t.location!==this.state.location&&this.isCustomLocationSelected()){this.textFieldRef?.focus()}}render(){return View({},this.state.sendGeo&&!this.state.mapLoading&&this.renderMapContent(),!this.state.sendGeo&&!this.state.mapLoading&&this.renderLocationContent(),this.state.mapLoading&&this.renderMapSkeleton(),!this.state.readOnly&&this.renderSwitcher())}renderLocationContent(){return View({},this.renderLocationImage(),this.isCustomLocationSelected()&&this.renderLocationCustomInput())}renderLocationImage(){return View({style:{position:"relative",justifyContent:"center",alignItems:"center"}},this.renderRandomMapImage(),this.renderChip())}renderLocationCustomInput(){return View({style:{borderColor:this.state.keyboardShow?o.accentMainPrimary.toHex():o.bgSeparatorPrimary.toHex(),borderWidth:1,borderRadius:n.M.toNumber(),marginTop:a.L.toNumber(),paddingHorizontal:a.L.toNumber(),paddingVertical:a.M.toNumber()}},this.renderTextField())}renderTextField(){return G({testId:"stafftrack-map-custom-location-input",value:this.state.customLocationRaw,placeholder:k[this.state.location].fullName,placeholderTextColor:o.base4.toHex(),maxLength:63,onChangeText:this.handleOnChange,onBlur:this.handleOnBlur,onFocus:this.handleOnFocus,ref:e=>{this.textFieldRef=e}})}blur(){this.textFieldRef?.blur()}handleOnChange(e){this.state.customLocationRaw=e}handleOnBlur(){this.setState({keyboardShow:false});if(this.props.onBlurText){this.props.onBlurText()}}handleOnFocus(){this.setState({keyboardShow:true});if(this.props.onFocusText){this.props.onFocusText()}}renderRandomMapImage(){return Image({testId:"stafftrack-map-random-image",style:{width:"100%",height:100,borderRadius:4},resizeMode:"cover",uri:encodeURI(l(F))})}renderChip(){return View({style:{position:"absolute",borderRadius:n.XL.toNumber(),marginHorizontal:a.L.toNumber()},ref:e=>{this.locationChipRef=e}},I({icon:this.getLocationIconType(this.state.location),design:this.state.readOnly?C.GREY:C.BLACK,mode:M.OUTLINE,dropdown:!this.state.readOnly,text:this.getLocationText(this.state.location),onClick:this.openSelector,style:{backgroundColor:o.bgPrimary.toHex()},testId:"stafftrack-location-chip"}))}renderMapContent(){return View({},this.renderMapImage(),this.isGeoMode()&&this.renderAddressString())}renderMapImage(){return View({style:{position:"relative",justifyContent:"center",alignItems:"center"}},Image({testId:"stafftrack-map-image",style:{width:"100%",height:100,borderRadius:4},resizeMode:"cover",uri:encodeURI(l(this.state.geoImageUrl))}),this.isGeoMode()&&this.renderPinIcon())}renderPinIcon(){return Image({style:{position:"absolute",width:17,height:23},svg:{content:N}})}renderAddressString(){return View({style:{marginTop:a.L.toNumber()}},w({numberOfLines:2,ellipsize:"end",text:c.getMessage("M_STAFFTRACK_MAP_ADDRESS",{"#ADDRESS#":this.state.addressString}),color:o.base4,testId:"stafftrack-map-address"}))}renderSwitcher(){return View({style:{flexDirection:"row",alignItems:"center",paddingTop:a.L.toNumber()},onClick:this.onSwitcherClick,ref:e=>{this.switcherRef=e}},f({onClick:this.onSwitcherClick,useState:false,mode:S.SOLID,checked:this.state.sendGeo,style:{marginRight:a.L.toNumber()},testId:"stafftrack-map-switcher"}),y({text:c.getMessage("M_STAFFTRACK_MAP_SEND_GEO"),color:o.base3}))}renderMapSkeleton(){return View({style:{flexDirection:"column"}},this.renderMapImageSkeleton())}renderMapImageSkeleton(){return View({style:{flexDirection:"row"}},View({style:{width:"100%"}},g(null,100,0,0,n.S.toNumber())))}openSelector(){if(this.state.readOnly){return}this.locationMenu??=new b({layoutWidget:this.layoutWidget,targetElementRef:this.locationChipRef,locationList:k,onItemSelected:e=>{this.selectLocationItem(e)}});this.locationMenu.show(this.locationChipRef)}selectLocationItem(e){this.setState({location:e})}getLocationText(e){switch(e){case O.REMOTELY.getValue():case O.OFFICE.getValue():case O.HOME.getValue():case O.OUTSIDE.getValue():case O.CUSTOM.getValue():return k[e].fullName;default:return e}}getLocationIconType(e){switch(e){case O.REMOTELY.getValue():return L.EARTH;case O.OFFICE.getValue():return L.COMPANY;case O.HOME.getValue():return L.HOME;case O.OUTSIDE.getValue():return L.MAP;default:return null}}async handleUserGeo(){if(!d.isNil(this.state.addressString)||this.state.readOnly){return}let e=true;clearTimeout(this.loaderTimeout);this.loaderTimeout=setTimeout((()=>{if(e){this.setState({mapLoading:true})}}),100);const t=await this.requestGeoPosition();if(d.isObject(t)&&t.code){const{code:s,message:i}=t;if(this.isFirstHelpViewed===false&&_){this.handleErrorGeoDefinition()}else if(s===1){this.handleDisabledGeo()}else{this.handleErrorGeoDefinition()}console.error(i);e=false;return}const{latitude:s,longitude:i}=t;const o=await this.getGeoInfo(s,i);e=false;if(!d.isNil(o.error)){if(o.error==="Source is not specified"){this.handleErrorGeoDefinition(c.getMessage("M_STAFFTRACK_MAP_GEO_SOURCE_NOT_SPECIFIED"))}else{this.handleErrorGeoDefinition()}return}if(d.isNil(o.geoImageUrl)||d.isNil(o.addressString)){this.handleErrorGeoDefinition();return}const{signedGeoImageUrl:n,signedAddressString:a,geoImageUrl:r,addressString:l}=o;this.setState({sendGeo:true,mapLoading:false,signedGeoImageUrl:n,signedAddressString:a,geoImageUrl:r,addressString:l})}async requestGeoPosition(){try{return await device.getLocation({accuracy:"approximate"})}catch(e){return e}}async getGeoInfo(e,t){const{data:s,errors:i}=await E.getGeoInfo({latitude:e,longitude:t});if(!d.isNil(i)&&d.isArrayFilled(i)){const{message:e}=i[0];return{error:e}}return s}handleDisabledGeo(){m({title:c.getMessage("M_STAFFTRACK_MAP_GEO_DISABLED_TITLE"),description:c.getMessage("M_STAFFTRACK_MAP_GEO_DISABLED_DESCRIPTION"),actionButtonText:c.getMessage("M_STAFFTRACK_MAP_GEO_DISABLED_ACTION"),onAction:()=>{Application.openSettings()}});p.notifyWarning();this.setState({sendGeo:false,mapLoading:false})}handleErrorGeoDefinition(e=c.getMessage("M_STAFFTRACK_MAP_GEO_ERROR_DEFINITION")){h({message:e,svg:{content:u()},backgroundColor:o.accentMainAlert.toHex()});p.notifyFailure();this.setState({sendGeo:false,mapLoading:false})}onSwitcherClick(){if(this.state.mapLoading){return}if(!x.isGeoEnabled()){T({layoutWidget:this.layoutWidget,targetRef:this.switcherRef,type:this.isUserAdmin?A.ADMIN:A.REGULAR});return}const e=!this.state.sendGeo;R.sendSetupGeo(e);p.impactLight();if(e===true&&d.isNil(this.state.addressString)){this.handleUserGeo()}else{this.setState({sendGeo:e})}}getLocation(){return this.isGeoMode()?null:this.getLocationData()}getAddress(){return this.isGeoMode()?this.state.signedAddressString:null}getGeoImage(){return this.isGeoMode()?this.state.signedGeoImageUrl:F}isGeoMode(){return this.state.sendGeo&&this.state.addressString}isCustomLocationSelected(){return!this.state.sendGeo&&this.state.location===O.CUSTOM.getValue()}getLocationData(){return this.isCustomLocationSelected()?this.state.customLocationRaw:this.state.location}}const N=`<svg width="17" height="23" viewBox="0 0 17 23" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M8.70847 0.666992C4.38817 0.666992 0.916504 4.1373 0.916504 8.45896C0.916504 13.0204 5.546 19.3875 7.66813 22.0665C8.20579 22.7453 9.20591 22.7405 9.73875 22.058C11.8563 19.3456 16.5004 12.8914 16.5004 8.45896C16.5004 4.1373 13.0288 0.666992 8.70847 0.666992ZM8.70847 11.9996C6.72563 11.9996 5.16642 10.4418 5.16642 8.4576C5.16642 6.47476 6.72427 4.91555 8.70847 4.91555C10.6913 4.91555 12.2505 6.4734 12.2505 8.4576C12.2505 10.4418 10.6913 11.9996 8.70847 11.9996Z" fill="${o.accentMainAlert.toHex()}"/></svg>`;s.exports={MapView:U}}));
//# sourceMappingURL=extension.map.js