jn.define("stafftrack/user-statistics",((t,e,s)=>{const{Type:o}=t("type");const{Loc:i}=t("loc");const{BottomSheet:n}=t("bottom-sheet");const{debounce:a}=t("utils/function");const{Color:r,Indent:h}=t("tokens");const{showToast:c}=t("toast");const{outline:{send:d,cross:l}}=t("assets/icons");const{Haptics:u}=t("haptics");const{Box:f}=t("ui-system/layout/box");const{Area:S}=t("ui-system/layout/area");const{IconView:g,Icon:C}=t("ui-system/blocks/icon");const{Button:p}=t("ui-system/form/buttons/button");const{H4:m}=t("ui-system/typography/heading");const{ShiftManager:T}=t("stafftrack/data-managers/shift-manager");const{UserLinkStatisticsAjax:y}=t("stafftrack/ajax");const{DateHelper:w}=t("stafftrack/date-helper");const{Calendar:M}=t("stafftrack/user-statistics/calendar");const{CalendarHeader:k}=t("stafftrack/user-statistics/calendar-header");const{MonthSelector:_}=t("stafftrack/user-statistics/month-selector");const{ShiftView:I}=t("stafftrack/shift-view");const{Analytics:R,StatsOpenEnum:A}=t("stafftrack/analytics");const{PureComponent:D}=t("layout/pure-component");class L extends D{constructor(t){super(t);this.refs={layoutWidget:this.props.layoutWidget||PageManager,calendarHeaderRef:null,calendarRef:null};this.todayMonthCode=w.getMonthCode(new Date);this.monthCode=this.props.monthCode??this.todayMonthCode;this.shifts=[];this.isLoading=true;this.onMonthSwitched=this.onMonthSwitched.bind(this);this.onDateSelected=a(this.onDateSelected,50,this);this.onDataUpdated=this.onDataUpdated.bind(this);this.showDialogSelector=this.showDialogSelector.bind(this);void this.update(this.monthCode);if(t.myCheckins===false){R.sendStatisticsOpen(A.COLLEAGUE)}else{R.sendStatisticsOpen(A.PERSONAL)}}componentDidMount(){T.on("updated",this.onDataUpdated)}componentWillUnmount(){T.off("updated",this.onDataUpdated)}onDataUpdated(){void this.update(this.monthCode)}get user(){return this.props.user}update(t){this.setMonthCode(t);if(T.hasUserShiftsForMonth(this.user.id,t)){const e=T.getCachedUserShiftsForMonth(this.user.id,t);this.setShifts(e);this.setLoading(false);return}return this.load(t)}async load(t){this.loaderStart=null;clearTimeout(this.loaderTimeout);this.loaderTimeout=setTimeout((()=>{if(this.requestSent){this.loaderStart=Date.now();this.setLoading(true)}}),300);this.requestSent=true;const e=await T.getUserShiftsForMonth(this.user.id,t);this.requestSent=false;let s=0;if(this.loaderStart){const t=Date.now()-this.loaderStart;s=Math.max(0,300-t)}if(s>0){setTimeout((()=>{if(this.monthCode===t){this.setShifts(e);this.setLoading(false)}}),s)}else if(this.monthCode===t){this.setShifts(e);this.setLoading(false)}}setLoading(t){this.isLoading=t;this.refs.calendarHeaderRef?.setLoading(t)}setMonthCode(t){this.monthCode=t;this.refs.monthSelectorRef?.setMonthCode(t)}setShifts(t){this.shifts=t;this.refs.calendarHeaderRef?.setShiftCount(t.filter((t=>t.isWorkingStatus())).length);this.refs.calendarRef?.setShifts(t)}show(t=PageManager){void new n({component:this}).setParentWidget(t).disableContentSwipe().setMediumPositionPercent(65).setBackgroundColor(r.bgSecondary.toHex()).open().then((t=>{this.refs.layoutWidget=t}))}render(){return f({backgroundColor:r.bgSecondary},this.renderHeader(),this.renderCalendar(),this.renderShareButton())}renderHeader(){return S({style:{flexDirection:"row",alignItems:"center"},isFirst:true},g({icon:C.ARROW_TO_THE_LEFT,size:24,color:r.base4,onClick:()=>this.refs.layoutWidget.close()}),m({numberOfLines:1,ellipsize:"end",text:this.props.myCheckins===false?i.getMessage("M_STAFFTRACK_USER_STATISTICS_USER_CHECKINS"):i.getMessage("M_STAFFTRACK_USER_STATISTICS_MY_CHECKINS"),style:{flex:1,marginLeft:h.XL.toNumber()}}),new _({monthCode:this.monthCode,onPick:t=>{this.refs.calendarRef.setMonth(t);void this.update(t)},ref:t=>{this.refs.monthSelectorRef=t}}))}renderCalendar(){return S({isFirst:true},new k({user:this.user,shiftCount:this.shifts.filter((t=>t.isWorkingStatus())).length,isLoading:this.isLoading,ref:t=>{this.refs.calendarHeaderRef=t}}),new M({shifts:this.shifts,onMonthSwitched:this.onMonthSwitched,onDateSelected:this.onDateSelected,ref:t=>{this.refs.calendarRef=t}}))}onMonthSwitched(t){const e=new Date(t*1e3);const s=w.getMonthCode(e);void this.update(s)}async onDateSelected(t){const e=new Date(t*1e3);const s=w.getMonthCode(e);await this.update(s);const o=w.getDayCode(e);const i=this.shifts.find((t=>{const e=w.getDayCode(t.getShiftDate());return e===o}));this.closeToast();if(i){this.openShiftView(i)}else{this.showToastNoCheckIn()}}openShiftView(t){const{user:e}=this.props;const s=new I({shift:t,user:e});s.show(this.refs.layoutWidget);u.impactLight()}showToastNoCheckIn(){this.previousToast=c({message:i.getMessage("M_STAFFTRACK_USER_STATISTICS_NO_CHECKIN"),svg:{content:l()},backgroundColor:r.bgContentInapp.toHex()},this.layoutWidget);u.notifyWarning()}closeToast(){this.previousToast?.close()}renderShareButton(){if(this.props.myCheckins===false){return null}return S({isFirst:true},p({leftIcon:C.SHARE,text:i.getMessage("M_STAFFTRACK_USER_STATISTICS_SHARE"),color:r.baseWhiteFixed,backgroundColor:r.accentMainPrimary,stretched:true,testId:"stafftrack-user-statistics-share",onClick:this.showDialogSelector}))}async showDialogSelector(){const{DialogSelector:t}=await requireLazy("im:messenger/api/dialog-selector");const e=new t;e.show({title:i.getMessage("M_STAFFTRACK_USER_STATISTICS_CHOOSE_CHAT"),layout:this.refs.layoutWidget}).then((t=>this.sendLink(t))).catch((t=>console.error(t)))}async sendLink(t){const{dialogId:e,name:s}=t;if(o.isNil(e)||o.isNil(s)){return}const i=currentDomain+this.getUserStatisticsUrl();const n=await y.send(e,i);if(n.status==="success"){this.showToastChecksInSent()}}getUserStatisticsUrl(){return`/check-in/statistics/${this.user.id}/${this.user.hash}/?month=${this.monthCode}`}showToastChecksInSent(){c({message:i.getMessage("M_STAFFTRACK_USER_STATISTICS_CHECKINS_SENT_V2"),svg:{content:d()},backgroundColor:r.bgContentInapp.toHex()},this.layoutWidget);u.notifySuccess()}}s.exports={UserStatistics:L}}));
//# sourceMappingURL=extension.map.js