(function(){"use strict";if(BX.SalecenterPaySystem)return;BX.SalecenterPaySystem={init:function(t){this.slider=null;this.paySystemHandler=t.paySystemHandler;this.paySystemMode=t.paySystemMode;this.paySystemId=t.paySystemId;this.containerNode=BX(t.containerId);this.buttonSaveNode=BX(t.buttonSaveId);this.formId=t.formId;this.auth=t.auth;this.errorMessageNode=BX(t.errorMessageId);this.paySystemFormData=[];this.checkedAuthStatus=false;this.uiNodes={avatar:this.containerNode.querySelector("[data-bx-salescenter-auth-avatar]"),name:this.containerNode.querySelector("[data-bx-salescenter-auth-name]"),link:this.containerNode.querySelector("[data-bx-salescenter-auth-link]"),logout:this.containerNode.querySelector("[data-bx-salescenter-auth-logout]")};this.showBlockByAuth();this.bindEvents()},bindEvents:function(){BX.bind(BX("bx-salescenter-add-button"),"click",BX.proxy(this.openSlider,this));BX.bind(BX("bx-salescenter-connect-button"),"click",BX.proxy(this.openPopup,this));BX.bind(BX("LOGOTIP"),"bxchange",BX.proxy(this.showLogotip,this));BX.bind(this.buttonSaveNode,"click",BX.proxy(this.savePaySystemAction,this));BX.bind(this.uiNodes.logout,"click",BX.proxy(this.logoutAction,this));BX.addCustomEvent(window,"seo-client-auth-result",BX.proxy(this.checkAuthStatusAction,this));BX.addCustomEvent("onPopupOpen",BX.proxy(this.onPopupOpenHandler,this));BX.addCustomEvent("SidePanel.Slider:onLoad",BX.proxy(this.onLoadSlider,this));BX.addCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.onCloseSlider,this))},onLoadSlider:function(t){this.slider=t.slider;top.BX.addCustomEvent("AdminSidePanel:onSendRequest",BX.proxy(this.onSendAdminSidePanelRequest.bind(this,this.slider)));var e=this.getSliderDocument(this.slider);this.formData=this.getAllFormDataJson(e)},onCloseSlider:function(t){this.onCloseSliderPopup(t)},openPopup:function(t){var e;if(this.auth&&this.auth.URL){e=BX.util.popup(this.auth.URL,800,600);if(e){BX.onCustomEvent("onPopupOpen",[e])}}},onPopupOpenHandler:function(t){var e=this,s=setInterval(function(){if(t.closed){clearInterval(s);if(e.checkedAuthStatus===false){e.checkAuthStatusAction()}}},1e3)},logoutAction:function(){BX.ajax.runComponentAction("bitrix:salescenter.paysystem","logoutProfile",{mode:"ajax"}).then(function(t){this.toggleLogoutBlock()}.bind(this),function(t){this.showErrorPopup(t.errors)}.bind(this))},checkAuthStatusAction:function(t){t.reload=false;this.checkedAuthStatus=true;BX.ajax.runComponentAction("bitrix:salescenter.paysystem","getProfileStatus",{mode:"ajax"}).then(function(t){this.toggleAuthBlock(t.data.profile)}.bind(this),function(t){this.showErrorPopup(t.errors)}.bind(this))},toggleAuthBlock:function(t){if(t){this.setProfileData(t);this.showBlock(["profile","settings","form"])}else{this.showBlock(["settings","form"])}},toggleLogoutBlock:function(){this.showBlock(["auth"])},setProfileData:function(t){if(this.uiNodes.avatar){this.uiNodes.avatar.style["background-image"]="url("+t.PICTURE+")"}if(this.uiNodes.name){this.uiNodes.name.innerText=t.NAME}if(this.uiNodes.link){if(t.LINK){this.uiNodes.link.setAttribute("href",t.LINK)}else{this.uiNodes.link.removeAttribute("href")}}},showBlock:function(t){t=BX.type.isArray(t)?t:[t];var e="data-bx-salescenter-block";var s=this.containerNode.querySelectorAll("["+e+"]");s=BX.convert.nodeListToArray(s);s.forEach(function(s){var i=s.getAttribute(e);var n=BX.util.in_array(i,t);s.style.display=n?"block":"none"},this)},showBlockByAuth:function(){if(this.auth.HAS_AUTH){if(this.auth.PROFILE){this.setProfileData(this.auth.PROFILE);this.showBlock(["profile","settings","form"])}else{this.showBlock(["settings","form"])}}else{if(this.auth.PROFILE){this.setProfileData(this.auth.PROFILE);this.showBlock(["profile","settings","form"])}else{if(this.auth.CAN_AUTH){this.showBlock(["auth"])}else{this.showBlock(["settings","form"])}}}},openSlider:function(){var t={allowChangeHistory:false,events:{onLoad:function(t){var e=t.getSlider();this.updatePaySystemForm(e)}.bind(this),onClose:function(t){var e=t.getSlider(),s;s=this.getPaySystemFormData(e);this.updateCommonSettingsForm(s)}.bind(this),onDestroy:function(t){if(this.paySystemId>0){var e=t.getSlider(),s;s=this.getPaySystemFormData(e);this.updateCommonSettingsForm(s)}else{this.closeSlider()}}.bind(this)}};BX.SidePanel.Instance.open(this.getConnectPath(),t)},closeSlider:function(){var t=BX("salescenter-form-is-saved");if(t){t.value="y"}if(this.slider){this.slider.close()}},getConnectPath:function(){var t="/shop/settings/sale_pay_system_edit/?publicSidePanel=Y";if(this.paySystemId>0){t+="&ID="+this.paySystemId}else if(this.paySystemHandler){t+="&ACTION_FILE="+this.paySystemHandler;if(this.paySystemMode){t+="&PS_MODE="+this.paySystemMode}}return t},savePaySystemAction:function(t){t.preventDefault();var e,s;if(this.paySystemId>0){e="salescenterUpdatePaymentSystem"}else{e="salescenterAddPaymentSystem"}if(this.paySystemMode&&this.paySystemHandler==="yandexcheckout"){s=this.paySystemMode}else{s=this.paySystemHandler}BX.ajax.runComponentAction("bitrix:salescenter.paysystem","savePaySystem",{mode:"ajax",data:this.getSaveData(),analyticsLabel:{analyticsLabel:e,type:s}}).then(function(t){BX.removeClass(this.buttonSaveNode,"ui-btn-wait");this.closeSlider()}.bind(this),function(t){BX.removeClass(this.buttonSaveNode,"ui-btn-wait");this.showError(t.errors)}.bind(this))},getSaveData:function(){var t=this.getAllFormData(document);for(var e in this.paySystemFormData){if(this.paySystemFormData.hasOwnProperty(e)){if(this.isObject(this.paySystemFormData[e])){t.append(e,JSON.stringify(this.paySystemFormData[e]))}else{t.append(e,this.paySystemFormData[e])}}}if(this.paySystemFormData.hasOwnProperty("NAME")){t.append("NAME",t.get("NAME"));t.append("DESCRIPTION",t.get("DESCRIPTION"));t.append("IS_CASH",t.get("IS_CASH"));t.append("CAN_PRINT_CHECK",t.get("CAN_PRINT_CHECK"))}return t},updatePaySystemForm:function(t){var e,s,i,n,o;e=this.getSliderDocument(t);o=this.getCommonSettingsFormData();if(this.paySystemId>0){this.setPaySystemFormFields(e,o)}else{i=e.getElementById("LOGOTIP").closest("span").firstChild;n=this.elementObserver(i,function(t){this.setPaySystemFormFields(e,o);n.disconnect()}.bind(this));var a=e.getElementById("ACTION_FILE");if(a){s=new Event("change");a.dispatchEvent(s)}}},setPaySystemFormFields:function(t,e){var s,i,n,o,a,r,l;n=t.getElementById("PSA_NAME");if(n&&e.NAME){n.value=e.NAME}o=t.getElementById("NAME");if(o&&e.NAME){o.value=e.NAME}r=t.getElementsByName("IS_CASH");if(r&&e.IS_CASH){r[0].value=e.IS_CASH}l=t.getElementById("CAN_PRINT_CHECK");if(l&&e.CAN_PRINT_CHECK){l.checked=e.CAN_PRINT_CHECK==="Y"}s=t.getElementById("ACTION_FILE");if(s){s.closest("tr").style.display="none"}i=t.getElementById("PS_MODE");if(i){i.closest("tr").style.display="none"}},getPaySystemFormData:function(t){var e,s;e=this.getSliderDocument(t);s=this.getAllFormDataList(e);return s},updateCommonSettingsForm:function(t){var e,s,i,n;e=BX("NAME");s=BX("DESCRIPTION");i=BX("IS_CASH");n=BX("CAN_PRINT_CHECK");if(e&&t.NAME){e.value=t.NAME}if(s&&t.DESCRIPTION){s.value=t.DESCRIPTION}if(i&&t.IS_CASH){i.value=t.IS_CASH}if(n){n.checked=!!(t.CAN_PRINT_CHECK&&t.CAN_PRINT_CHECK==="Y")}this.paySystemFormData=t},getCommonSettingsFormData:function(){var t;t=this.getAllFormDataList(document);return t},onSendAdminSidePanelRequest:function(t,e){if(e.indexOf("action=delete")!==-1){t.close()}},elementObserver:function(t,e){if(!window.MutationObserver){return}var s={attributes:true,childList:true,characterData:true};var i=new MutationObserver(function(t){t.forEach(function(t){e(t)})});i.observe(t,s);return i},getAllFormDataJson:function(t){var e=this.getAllFormDataList(t);return e?JSON.stringify(e):""},getAllFormData:function(t){var e=new FormData,s=this.getAllFormDataList(t);for(var i in s){if(s.hasOwnProperty(i)){if(this.isObject(s[i])){e.append(i,JSON.stringify(s[i]))}else{e.append(i,s[i])}}}return e},getAllFormDataList:function(t){var e={},s,i,n;if(!t){return e}n=t.getElementsByTagName("form");for(s=0;s<n.length;s++){var o=this.getFormData(n[s]);for(i in o){if(o.hasOwnProperty(i)){e[i]=o[i]}}}return e},getFormData:function(t){var e=BX.ajax.prepareForm(t),s;for(s in e.data){if(e.data.hasOwnProperty(s)&&s===""){delete e.data[s]}}return!!e&&e.data?e.data:{}},showErrorPopup:function(t){var e,s=[];t.forEach(function(t){s.push(BX.create("p",{text:t.message}))});if(!s.length){return}e=BX.create("div",{children:s});var i=new BX.PopupWindow("paysystem_error_popup_"+BX.util.getRandomString(),null,{autoHide:false,draggable:false,closeByEsc:true,offsetLeft:0,offsetTop:0,zIndex:1e4,bindOptions:{forceBindPosition:true},titleBar:BX.message("SALESCENTER_SP_ERROR_POPUP_TITLE"),content:e,buttons:[new BX.PopupWindowButton({id:"close",text:BX.message("SALESCENTER_SP_BUTTON_CLOSE"),events:{click:function(){i.close()}}})],events:{onPopupClose:function(){this.destroy()},onPopupDestroy:function(){i=null}}});i.show()},showError:function(t){var e="";t.forEach(function(t){e+=t.message+"<br>"});if(this.errorMessageNode&&e){this.errorMessageNode.parentNode.style.display="block";this.errorMessageNode.innerHTML=e}},getSliderDocument:function(t){var e,s;e=t.iframe;s=e.contentDocument||e.contentWindow.document;return s},showLogotip:function(t){if(t.currentTarget.files&&t.currentTarget.files[0]){var e=new FileReader;e.onload=function(t){BX("salescenter-img-preload").src=t.target.result};e.readAsDataURL(t.currentTarget.files[0])}},onCloseSliderPopup:function(t){var e=this.getSliderDocument(t.slider);var s=e.getElementById("salescenter-form-is-saved");if(s&&s.value==="y"){return true}var i=this.getAllFormDataJson(e);if(this.formData===i||this.isClose===true){this.isClose=false;return false}t.action=false;this.popup=new BX.PopupWindow("salescenter_sp_slider_close_confirmation",null,{autoHide:false,draggable:false,closeByEsc:false,offsetLeft:0,offsetTop:0,zIndex:t.slider.zIndex+100,bindOptions:{forceBindPosition:true},titleBar:BX.message("SALESCENTER_SP_POPUP_TITLE"),content:BX.message("SALESCENTER_SP_POPUP_CONTENT"),buttons:[new BX.PopupWindowButton({text:BX.message("SALESCENTER_SP_POPUP_BUTTON_CLOSE"),className:"ui-btn ui-btn-success",events:{click:BX.delegate(this.onCloseConfirmButtonClick.bind(this,"close"))}}),new BX.PopupWindowButtonLink({text:BX.message("SALESCENTER_SP_POPUP_BUTTON_CANCEL"),className:"ui-btn ui-btn-link",events:{click:BX.delegate(this.onCloseConfirmButtonClick.bind(this,"cancel"))}})],events:{onPopupClose:function(){this.destroy()}}});this.popup.show();return false},onCloseConfirmButtonClick:function(t){this.popup.close();if(BX.SidePanel.Instance.getTopSlider()){BX.SidePanel.Instance.getTopSlider().focus()}if(t==="close"){this.isClose=true;BX.SidePanel.Instance.getTopSlider().close()}},isObject:function(t){return t&&typeof t==="object"&&t.constructor===Object},remove:function(t){var e=t.target;t.preventDefault();if(this.paySystemId>0&&confirm(BX.message("SALESCENTER_SP_PAYSYSTEM_DELETE_CONFIRM"))){var s;if(this.paySystemMode&&this.paySystemHandler==="yandexcheckout"){s=this.paySystemMode}else{s=this.paySystemHandler}BX.ajax.runComponentAction("bitrix:salescenter.paysystem","deletePaySystem",{mode:"ajax",data:{paySystemId:this.paySystemId},analyticsLabel:{analyticsLabel:"salescenterDeletePaymentSystem",type:s}}).then(function(){BX.removeClass(e,"ui-btn-wait");this.closeSlider()}.bind(this),function(t){BX.removeClass(e,"ui-btn-wait");this.showError(t.errors)}.bind(this))}else{setTimeout(function(){BX.removeClass(e,"ui-btn-wait")},100)}}}})(window);
//# sourceMappingURL=script.map.js