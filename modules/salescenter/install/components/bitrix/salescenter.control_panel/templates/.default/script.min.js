(function(){"use strict";BX.namespace("BX.Salescenter.ControlPanel");BX.Salescenter.ControlPanel.init=function(e){this.panelGrid=e.panelGrid;this.selfFolderUrl="/shop/settings/";if(BX.SidePanel.Instance){BX.SidePanel.Instance.bindAnchors({rules:[{condition:[BX.Salescenter.ControlPanel.selfFolderUrl+"sale_delivery_service_edit/",this.selfFolderUrl+"sale_pay_system_edit/"],handler:BX.Salescenter.ControlPanel.adjustSidePanelOpener},{condition:["/shop/orders/details/(\\d+)/","/shop/orders/payment/details/(\\d+)/","/shop/orders/shipment/details/(\\d+)/"]},{condition:["/crm/configs/sale/"]}]})}if(!top.window["adminSidePanel"]||!BX.is_subclass_of(top.window["adminSidePanel"],top.BX.adminSidePanel)){top.window["adminSidePanel"]=new top.BX.adminSidePanel({publicMode:true})}};BX.Salescenter.ControlPanel.adjustSidePanelOpener=function(e,t){if(BX.SidePanel.Instance){var n=t.url.indexOf("IFRAME=Y&IFRAME_TYPE=SIDE_SLIDER")>=0;if(!n||n&&!BX.SidePanel.Instance.getTopSlider()){e.preventDefault();t.url=BX.util.add_url_param(t.url,{publicSidePanel:"Y"});BX.SidePanel.Instance.open(t.url,{allowChangeHistory:false})}}};BX.Salescenter.ControlPanel.showMenu=function(e,t){BX.PopupMenu.show(t.id,e.layout.content,t.items,{offsetLeft:0,offsetTop:0,closeByEsc:true,className:"salescenter-panel-menu"})};BX.Salescenter.ControlPanel.reloadStoreChatsMenu=function(){BX.Salescenter.ControlPanel.hideMenu("store-chat-menu");var e=BX.Salescenter.ControlPanel.getSalesChatItem();if(e){delete e.data.menu}BX.Salescenter.ControlPanel.hideMenu("store-sms-menu");var t=BX.Salescenter.ControlPanel.getSalesSmsItem();if(t){delete t.data.menu}};BX.Salescenter.ControlPanel.hideMenu=function(e){BX.PopupMenu.destroy(e)};BX.Salescenter.ControlPanel.getSalesChatItem=function(){return this.panelGrid.getItem("store-chats")};BX.Salescenter.ControlPanel.getSalesSmsItem=function(){return this.panelGrid.getItem("store-sms")};BX.Salescenter.ControlPanel.connectShop=function(e){var t=BX.Salescenter.ControlPanel.getSalesChatItem();var n=BX.Salescenter.ControlPanel.getSalesSmsItem();if(!t){return}BX.Salescenter.Manager.startConnection(e).then(function(){BX.Salescenter.Manager.loadConfig().then(function(e){if(e.isSiteExists){BX.Salescenter.Manager.showAfterConnectPopup();this.itemSelected=true;this.setSelected();BX.Salescenter.ControlPanel.reloadStoreChatsMenu();if(n){n.itemSelected=true;n.setSelected()}}}.bind(t))}.bind(t))};BX.Salescenter.ControlPanel.Item=function(e){BX.TileGrid.Item.apply(this,arguments);this.title=e.title;this.image=e.image;this.itemSelected=e.itemSelected;this.itemSelectedColor=e.itemSelectedColor;this.itemSelectedImage=e.itemSelectedImage;this.comingSoon=e.comingSoon||false;this.layout={container:null,image:null,title:null,clipTitle:null,company:null,controls:null,buttonAction:null,price:null};this.data=e.data||{}};BX.Salescenter.ControlPanel.Item.prototype={__proto__:BX.TileGrid.Item.prototype,constructor:BX.TileGrid.Item,getContent:function(){if(this.layout.container)return this.layout.container;this.layout.container=BX.create("div",{props:{className:"salescenter-item"},children:[BX.create("div",{props:{className:"salescenter-item-content"},children:[this.getImage(),this.getTitle(),this.getStatus(),this.getLabel()]})],events:{click:function(){if(!this.comingSoon){this.onClick()}}.bind(this)}});this.setSelected();this.setDisabled();return this.layout.container},getImage:function(){if(this.layout.image)return this.layout.image;this.layout.image=BX.create("div",{props:{className:"salescenter-item-image"},style:{backgroundImage:this.image?"url("+this.image+")":null}});return this.layout.image},getStatus:function(){if(!this.itemSelected||this.comingSoon)return;this.layout.itemSelected=BX.create("div",{props:{className:"salescenter-item-status-selected"}});return this.layout.itemSelected},getLabel:function(){if(!this.comingSoon)return;this.layout.itemLabel=BX.create("div",{props:{className:"salescenter-item-label"},children:[BX.create("span",{props:{className:"salescenter-item-label-text"},text:BX.message("SALESCENTER_CONTROL_PANEL_ITEM_LABEL_COMMING_SOON")})]});return this.layout.itemLabel},setDisabled:function(){if(!this.comingSoon)return;var e=this.layout.container.querySelector(".salescenter-item-content");var t=e.parentNode;BX.addClass(t,"salescenter-item-disabled")},setSelected:function(){if(!this.itemSelected||this.comingSoon)return;var e=this.layout.container.querySelector(".salescenter-item-content");var t=e.parentNode;BX.addClass(t,"salescenter-item-selected");BX.adjust(this.layout.image,{style:{backgroundImage:this.itemSelectedImage?"url("+this.itemSelectedImage+")":this.image}});if(this.itemSelectedColor){BX.adjust(t,{style:{backgroundColor:this.itemSelectedColor?this.itemSelectedColor:null}})}this.layout.itemSelected=BX.create("div",{props:{className:"salescenter-item-status-selected"}});e.appendChild(this.layout.itemSelected)},setUnselected:function(){if(this.itemSelected){return}var e=this.layout.container.querySelector(".salescenter-item-content");var t=e.parentNode;BX.removeClass(t,"salescenter-item-selected");BX.adjust(this.layout.image,{style:{backgroundImage:"url("+this.image+")"}});BX.adjust(t,{style:{backgroundColor:null}});var n=t.querySelector(".salescenter-item-status-selected");if(n){n.parentNode.removeChild(n)}},getTitle:function(){if(this.layout.title)return this.layout.title;this.layout.title=BX.create("div",{props:{className:"salescenter-item-title"},html:this.title});return this.layout.title},afterRender:function(){},onClick:function(){var e={};if(this.id==="store-chats"){if(!this.itemSelected){BX.Salescenter.ControlPanel.connectShop({context:"salescenter_chat"})}else{if(!this.data.menu){BX.ajax.runComponentAction("bitrix:salescenter.control_panel","getChatTileMenu",{mode:"class"}).then(function(e){if(e.data.items&&e.data.items.length>0){this.data.menu=e.data;BX.Salescenter.ControlPanel.showMenu(this,this.data.menu)}else{this.itemSelected=false;BX.Salescenter.Manager.isSiteExists=false;BX.Salescenter.Manager.isSitePublished=false;this.setUnselected();this.onClick();var t=BX.Salescenter.ControlPanel.getSalesSmsItem();if(t){t.itemSelected=false;t.setUnselected()}}}.bind(this))}else{BX.Salescenter.ControlPanel.showMenu(this,this.data.menu)}}}else if(this.id==="store-sms"){if(!this.itemSelected){BX.Salescenter.ControlPanel.connectShop({context:"salescenter_sms"})}else{if(!this.data.menu){BX.ajax.runComponentAction("bitrix:salescenter.control_panel","getSmsTileMenu",{mode:"class"}).then(function(e){if(e.data.items&&e.data.items.length>0){this.data.menu=e.data;BX.Salescenter.ControlPanel.showMenu(this,this.data.menu)}else{this.itemSelected=false;BX.Salescenter.Manager.isSiteExists=false;BX.Salescenter.Manager.isSitePublished=false;this.setUnselected();this.onClick();var t=BX.Salescenter.ControlPanel.getSalesChatItem();if(t){t.itemSelected=false;t.setUnselected()}}}.bind(this))}else{BX.Salescenter.ControlPanel.showMenu(this,this.data.menu)}}}else if(this.data.type==="paysystem"){BX.Salescenter.Manager.addAnalyticAction({analyticsLabel:"salescenterClickPaymentTile",isConnected:this.itemSelected?"y":"n",type:this.data.paySystemType});this.formData="";e={allowChangeHistory:false,width:1e3,events:{onClose:function(e){var t=e.getSlider();var n=[];if(this.data.additionalParams){n=this.data.additionalParams}this.setPaySystemItemHandler(t,this.data.paySystemType,n)}.bind(this)}};if(!this.itemSelected&&!this.data.showMenu){BX.SidePanel.Instance.open(this.data.connectPath,e)}else{this.showItemMenu(this,{sliderOptions:e})}}else if(this.data.type==="cashbox"){this.formData="";e={allowChangeHistory:false,width:1e3,events:{onLoad:function(e){var t=e.getSlider();this.formData=this.getAllFormData(t)}.bind(this),onClose:function(e){if(this.onCloseSlider(e)){this.reloadCashboxItem(this.data.handler)}}.bind(this)}};if(!this.itemSelected&&!this.data.showMenu){BX.SidePanel.Instance.open(this.data.connectPath,e)}else{this.showItemMenu(this,{sliderOptions:e})}}else if(this.data.type==="delivery"){this.formData="";e={allowChangeHistory:false,events:{onLoad:function(e){var t=e.getSlider();this.formData=this.getAllFormData(t);if(t.isOpen()&&t.url.indexOf("CREATE")>-1){this.prepareDeliveryForm(t)}else{var n=this.data.connectPath;this.setDeliveryListAddButton(t,n)}}.bind(this),onClose:function(e){this.onCloseSlider(e);var t=e.getSlider();this.setDeliveryItemHandler(t)}.bind(this),onDestroy:function(e){var t=e.getSlider();this.setDeliveryItemHandler(t)}.bind(this)}};if(!this.itemSelected&&!this.data.showMenu){BX.SidePanel.Instance.open(this.data.connectPath,e)}else{this.showItemMenu(this,{sliderOptions:e})}}else if(this.data.type==="delivery_extra"||this.data.type==="paysystem_extra"){e={allowChangeHistory:false,events:{onClose:function(e){top.BX.onCustomEvent("SalescenterPaysystemPanelReload")}}};BX.SidePanel.Instance.open(this.data.connectPath,e)}else if(this.data.type==="userconsent"){e={allowChangeHistory:false,events:{onClose:function(e){var t=e.getSlider();this.setUserConsentItemHandler()}.bind(this)}};if(!this.itemSelected){BX.SidePanel.Instance.open(this.data.connectPath,e)}else{this.showItemMenu(this,{sliderOptions:e})}}},showItemMenu:function(e,t){var n=[],s,a=e.layout.container,i="salescenter-item-menu-"+BX.util.getRandomString(),l;e.sliderOptions={};if(t.sliderOptions){e.sliderOptions=t.sliderOptions}for(s in e.data.menuItems){if(e.data.menuItems.hasOwnProperty(s)){if(e.data.menuItems[s].DELIMITER){n.push({delimiter:true})}else if(e.data.menuItems[s].FILTER){l=e.data.menuItems[s].FILTER;n.push({text:e.data.menuItems[s].NAME,link:e.data.menuItems[s].LINK,onclick:function(t,n){e.moreTabsMenu.close();BX.ajax.runComponentAction("bitrix:salescenter.control_panel","setDeliveryListFilter",{mode:"class",data:{filter:l}}).then(function(t){BX.SidePanel.Instance.open(n.options.link,e.sliderOptions)})}})}else{n.push({text:e.data.menuItems[s].NAME,link:e.data.menuItems[s].LINK,onclick:function(t,n){e.moreTabsMenu.close();BX.SidePanel.Instance.open(n.options.link,e.sliderOptions)}})}}}e.moreTabsMenu=BX.PopupMenu.create(i,a,n,{autoHide:true,offsetLeft:0,offsetTop:0,closeByEsc:true,events:{onPopupClose:function(){e.moreTabsMenu.popupWindow.destroy();BX.PopupMenu.destroy(i)},onPopupDestroy:function(){e.moreTabsMenu=null}}});e.moreTabsMenu.popupWindow.show()},prepareDeliveryForm:function(e){var t,n,s,a,i;t=e.iframe;n=t.contentDocument||t.contentWindow.document;s=n.getElementsByName("NAME")[0];if(s){s.value=this.title}if(this.id==="pickup"){i=n.getElementsByName("STORES_SHOW")[0];if(i){i.checked=true;var l=new Event("change");i.dispatchEvent(l)}}},setDeliveryListAddButton:function(e,t){var n,s,a,i,l,o;n=e.iframe;s=n.contentDocument||n.contentWindow.document;a=s.getElementsByClassName("ui-btn-double ui-btn-primary");if(a){i=a[0].getElementsByClassName("ui-btn-main")[0];if(i){o=i.innerText;l=BX.create("a",{props:{className:"ui-btn-main",href:t},text:o});a[0].replaceChild(l,i)}}},setPaySystemItemHandler:function(e,t,n){var s,a,i,l,o,r;s=e.iframe;a=s.contentDocument||s.contentWindow.document;r=new URL(window.location.href+e.url);i=r.searchParams.get("ID");l=r.searchParams.get("ACTION_FILE");if(!l&&t){l=t}o=r.searchParams.get("PS_MODE");if(i||l){this.reloadPaySystemItem(i,l,o,n)}},reloadPaySystemItem:function(e,t,n,s){var a=this;BX.ajax.runComponentAction("bitrix:salescenter.control_panel","reloadPaySystemItem",{mode:"class",data:{paySystemId:e,actionFile:t,psMode:n,additionalParams:s}}).then(function(e){a.itemSelected=e.data.itemSelected;if(a.itemSelected){a.setSelected()}else{a.setUnselected()}a.data.menuItems=e.data.menuItems;a.data.showMenu=e.data.showMenu})},reloadCashboxItem:function(e){var t=this;BX.ajax.runComponentAction("bitrix:salescenter.control_panel","reloadCashboxItem",{mode:"class",data:{handler:e}}).then(function(e){t.itemSelected=e.data.itemSelected;if(t.itemSelected){t.setSelected()}else{t.setUnselected()}t.data.menuItems=e.data.menuItems;t.data.showMenu=e.data.showMenu})},setDeliveryItemHandler:function(e){var t,n,s,a,i;t=e.iframe;n=t.contentDocument||t.contentWindow.document;i=new URL(window.location.href+e.url);s=i.searchParams.get("CLASS_NAME");a=i.searchParams.get("SERVICE_TYPE");this.reloadDeliveryItem(s,a)},reloadDeliveryItem:function(e,t){var n=this;BX.ajax.runComponentAction("bitrix:salescenter.control_panel","reloadDeliveryItem",{mode:"class",data:{className:e,serviceType:t}}).then(function(e){if(e.data.menuItems&&e.data.menuItems.length>0){n.itemSelected=e.data.itemSelected;if(n.itemSelected){n.setSelected()}else{n.setUnselected()}n.data.menuItems=e.data.menuItems;n.data.showMenu=e.data.showMenu}})},setUserConsentItemHandler:function(){this.reloadUserConsentItem()},reloadUserConsentItem:function(){var e=this;BX.ajax.runComponentAction("bitrix:salescenter.control_panel","reloadUserConsent",{mode:"class"}).then(function(t){e.itemSelected=t.data.itemSelected;if(e.itemSelected){e.setSelected()}else{e.setUnselected()}e.data.menuItems=t.data.menuItems})},getSliderDocument:function(e){var t,n;t=e.iframe;n=t.contentDocument||t.contentWindow.document;return n},getAllFormData:function(e){var t=this.getSliderDocument(e);var n=t.getElementsByTagName("form");if(n&&n.length>0){var s=BX.ajax.prepareForm(n[0]),a;for(a in s.data){if(s.data.hasOwnProperty(a)&&a===""){delete s.data[a]}}return!!s&&s.data?JSON.stringify(s.data):""}return""},onCloseSlider:function(e){var t=this.getSliderDocument(e.slider);var n=t.getElementById("salescenter-form-is-saved");if(n&&n.value==="y"){return true}var s=this.getAllFormData(e.slider);if(this.formData===s||this.isClose===true){this.isClose=false;return false}e.action=false;this.popup=new BX.PopupWindow("salescenter_slider_close_confirmation",null,{autoHide:false,draggable:false,closeByEsc:false,offsetLeft:0,offsetTop:0,zIndex:e.slider.zIndex+100,bindOptions:{forceBindPosition:true},titleBar:BX.message("SALESCENTER_CONTROL_PANEL_POPUP_TITLE"),content:BX.message("SALESCENTER_CONTROL_PANEL_POPUP_CONTENT"),buttons:[new BX.PopupWindowButton({text:BX.message("SALESCENTER_CONTROL_PANEL_POPUP_BUTTON_CLOSE"),className:"ui-btn ui-btn-success",events:{click:BX.delegate(this.onCloseConfirmButtonClick.bind(this,"close"))}}),new BX.PopupWindowButtonLink({text:BX.message("SALESCENTER_CONTROL_PANEL_POPUP_BUTTON_CANCEL"),className:"ui-btn ui-btn-link",events:{click:BX.delegate(this.onCloseConfirmButtonClick.bind(this,"cancel"))}})],events:{onPopupClose:function(){this.destroy()}}});this.popup.show();return false},onCloseConfirmButtonClick:function(e){this.popup.close();if(BX.SidePanel.Instance.getTopSlider()){BX.SidePanel.Instance.getTopSlider().focus()}if(e==="close"){this.isClose=true;BX.SidePanel.Instance.getTopSlider().close()}}}})();
//# sourceMappingURL=script.map.js