(function(t){t.BX.namespace("BX.Sender.Message");if(BX.Sender.Message.Tester){return}var e=BX.Sender.Helper;function i(){}i.prototype.classNameBtnWait="ui-btn-wait";i.prototype.eventNameSend="sender-message-test-send";i.prototype.init=function(t){this.context=BX(t.containerId);this.id=t.id;this.actionUri=t.actionUri;this.mess=t.mess||{};this.ajaxAction=new BX.AjaxAction(this.actionUri);this.messageCode=t.messageCode;this.lastRecipients=t.lastRecipients;this.type=t.type;this.types=t.types;this.button=e.getNode("test-button",this.context);this.result=e.getNode("test-result",this.context);this.buttonValidation=e.getNode("test-validation-button",this.context);this.enablePhoneVerification=t.enablePhoneVerification;this.initSelector();if(this.button&&this.result){BX.bind(this.button,"click",function(){if(this.enablePhoneVerification){BX.Bitrix24.PhoneVerify.getInstance().startVerify({callback:t=>{if(t){this.send("test",this.result,this.button)}},mandatory:false})}else{this.send("test",this.result,this.button)}}.bind(this))}if(this.buttonValidation&&this.result){BX.bind(this.buttonValidation,"click",function(){if(this.enablePhoneVerification){BX.Bitrix24.PhoneVerify.getInstance().startVerify({callback:t=>{if(t){this.send("consent",this.result,this.buttonValidation)}}})}else{this.send("consent",this.result,this.buttonValidation)}}.bind(this))}};i.prototype.validate=function(t){switch(this.type){case this.types.mail:return this.validateEmail(t);break;case this.types.phone:return this.validatePhone(t);break}return true};i.prototype.initSelector=function(){this.selector=BX.Sender.UI.TileSelector.getById(this.id);if(!this.selector){throw new Error("Tile selector `"+this.id+"` not found.")}BX.addCustomEvent(this.selector,this.selector.events.search,this.onSearch.bind(this));BX.addCustomEvent(this.selector,this.selector.events.buttonSelect,this.onButtonSelect.bind(this));BX.addCustomEvent(this.selector,this.selector.events.buttonSelectFirst,this.onButtonSelectFirst.bind(this))};i.prototype.onButtonSelect=function(){var t="";switch(this.type){case this.types.mail:t=this.mess.searchTitleMail;break;case this.types.phone:t=this.mess.searchTitlePhone;break}this.selector.showSearcher(t)};i.prototype.onButtonSelectFirst=function(){var t=[{id:"last",name:this.mess.categoryLast,items:this.lastRecipients.map((function(t){return{id:t,name:t,data:{}}}))}];this.selector.setSearcherData(t)};i.prototype.onSearch=function(t){(t||"").split(",").forEach((function(t){t=t.trim();if(!t||!this.validate(t)){return}this.selector.addTile(t,{},t)}),this)};i.prototype.validateEmail=function(t){return null!==t.match(/^[\w\.\d-_]+@[\w\.\d-_]+\.\w{2,15}$/i)};i.prototype.validatePhone=function(t){return null!==t.match(/^[\+]?[\d]{4,25}$/i)};i.prototype.printResult=function(t,e,i,s){s=s||{isSuccess:null};var n;if(s.isSuccess===null){n=""}else if(!s.isSuccess){if(s.errorCode){n="";var o=this;var r=new BX.Sender.ErrorHandler;r.onError(s.errorCode,{text:s.resultErrors.join("\n")},(function(){o.send("test",e,i)}),(function(){}))}else{n=s.resultErrors?s.resultErrors.join("\n"):""}}else if(this.messageCode==="mail"){n=t?this.mess.consentSuccess:this.mess.testSuccess}else{n=this.mess.testSuccessPhone}e.textContent=n;this.removeWaitingIndicator(i)};i.prototype.removeWaitingIndicator=function(t){BX.removeClass(t,this.classNameBtnWait)};i.prototype.addWaitingIndicator=function(t){BX.addClass(t,this.classNameBtnWait)};i.prototype.convertDataFromPostToJson=function(t){for(var e in t){if(!t.hasOwnProperty(e)){continue}if(!/[\[]+/.test(e)){continue}var i=e.split("[").map((function(t){return t.replace("]","")}));i.reduce((function(t,e){if(!t[e]||!BX.type.isPlainObject(t[e])){t[e]={}}return t[e]}),t);i.reduce((function(i,s){if(!BX.type.isPlainObject(i[s])){return}if(!BX.type.isNotEmptyObject(i[s])){i[s]=t[e];return}return i[s]}),t);t[e]=null}return t};i.prototype.send=function(t,e,i){var s=this.selector.getTilesId().map((function(t){return t.trim()})).filter((function(t){return t.length>0}));if(s.length===0){this.printResult(null,e,i,{isSuccess:false,resultErrors:[this.mess.testEmpty]});return}var n={id:null,data:{}},o=t==="consent";BX.onCustomEvent(this,this.eventNameSend,[n]);this.printResult(o,e,i,null);this.addWaitingIndicator(i);this.ajaxAction.request({action:t,onsuccess:this.printResult.bind(this,o,e,i),onfailure:this.removeWaitingIndicator.bind(this,i),data:{list:s,messageCode:this.messageCode,messageId:n.id,messageData:this.convertDataFromPostToJson(n.data)}})};BX.Sender.Message.Tester=new i})(window);
//# sourceMappingURL=script.map.js