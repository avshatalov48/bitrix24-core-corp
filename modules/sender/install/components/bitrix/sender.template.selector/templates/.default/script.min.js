(function(e){BX.namespace("BX.Sender.Template");if(BX.Sender.Template.Selector){return}var t=BX.Sender.Helper;function i(){}i.prototype.attributes={button:"data-bx-sender-tmpl-type-btn",close:"data-bx-sender-tmpl-close",item:"data-bx-sender-tmpl-item",items:"data-bx-sender-tmpl-type-items"};i.prototype.events={selectorClose:"close",categorySelect:"category-select",templateSelect:"template-select",templatePreview:"template-preview"};i.prototype.init=function(e){if(!e.containerId){return}this.container=BX(e.containerId);if(!this.container){return}this.mess=e.mess;this.actionUri=e.actionUri;this.ajaxAction=new BX.AjaxAction(this.actionUri);this.previewer=new n({selector:this});this.initGrid(e.grid);this.initControls()};i.prototype.onGridSelect=function(e){this.fireEvent(this.events.templateSelect,[{type:e.data.templateType,code:e.data.templateId,name:e.name,messageFields:e.data.messageFields,segments:e.data.segments,dispatch:e.data.dispatch}])};i.prototype.initGrid=function(e){this.grid=new BX.Sender.TileGrid({templates:{row:t.getNode("tpl-row",this.container),item:t.getNode("tpl-item",this.container),button:t.getNode("tpl-button",this.container)},rows:e.rows,items:e.items,type:e.type,mess:this.mess,container:t.getNode("draw-place",this.container)});BX.addCustomEvent(this.grid,this.grid.events.itemClick,this.onGridSelect.bind(this));this.grid.draw()};i.prototype.initControls=function(){this.closeNode=this.container.querySelector("["+this.attributes.close+"]");BX.bind(this.closeNode,"click",this.close.bind(this));BX.addCustomEvent(this,this.events.templatePreview,this.previewTemplate.bind(this))};i.prototype.fireEvent=function(t,i){BX.onCustomEvent(this,t,i);BX.onCustomEvent(e,"sender-template-selector-"+t,i)};i.prototype.close=function(){this.fireEvent(this.events.selectorClose,[this])};i.prototype.getTemplateRequestingUri=function(e){return this.ajaxAction.getRequestingUri("getTemplate",{lang:e.lang,template_type:e.type,template_id:e.code})};i.prototype.getTemplate=function(e,t){this.ajaxAction.requestHtml({action:"getTemplate",onsuccess:t,data:{lang:e.lang,template_type:e.type,template_id:e.code}})};i.prototype.previewTemplate=function(e){this.previewer.load({uri:this.getTemplateRequestingUri(e),title:e.name,template:e})};function n(e){this.selector=e.selector;this.popup=null;this.iframe=null;this.currentTemplate=null}n.prototype.getPopup=function(){if(this.popup){return this.popup}var e=BX.PopupWindowManager.create("sender-template-selector-preview",null,{titleBar:this.selector.mess.dlgPreviewTitle.replace("%name%",""),autoHide:true,lightShadow:true,closeIcon:true,closeByEsc:true,contentNoPaddings:true,overlay:{backgroundColor:"black",opacity:500}});e.setButtons([new BX.PopupWindowButton({text:this.selector.mess.dlgBtnSelect,className:"popup-window-button-accept",events:{click:this.onSelect.bind(this)}}),new BX.PopupWindowButton({text:this.selector.mess.dlgBtnCancel,events:{click:this.onCancel.bind(this)}})]);var t=BX("sender-template-selector-preview");e.setContent(t.innerHTML);this.popup=e;return this.popup};n.prototype.getFrame=function(){if(this.iframe){return this.iframe}this.iframe=this.getPopup().contentContainer.querySelector("iframe");BX.bind(this.iframe,"load",this.onFrameLoad.bind(this));return this.iframe};n.prototype.onFrameLoad=function(){this.getPopup().show()};n.prototype.onSelect=function(){this.getPopup().close();this.selector.fireEvent(this.selector.events.templateSelect,[this.currentTemplate])};n.prototype.onCancel=function(){this.getPopup().close()};n.prototype.load=function(e){this.getPopup().setTitleBar(this.selector.mess.dlgPreviewTitle.replace("%name%",e.title));this.getFrame().src=e.uri;this.currentTemplate=e.template;this.getPopup().show()};BX.Sender.Template.Selector=new i})(window);