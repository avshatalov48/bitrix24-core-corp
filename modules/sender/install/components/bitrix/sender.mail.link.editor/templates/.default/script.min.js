(function(){BX.namespace("BX.Sender.Mail");if(BX.Sender.Mail.LinkEditor){return}var t=BX.Sender.Helper;function e(){}e.prototype.init=function(e){this.context=BX(e.containerId);this.defaultValue=e.defaultValue;this.placeholders=e.placeholders||[];this.mess=e.mess;this.input=t.getNode("input",this.context);this.button=t.getNode("button",this.context);this.popupContent=t.getNode("popup-content",this.context);BX.bind(this.button,"click",this.onClick.bind(this));this.initPlaceholders();if(e.useDefault){this.setDefaultParameters();this.runPlaceholderWatcher()}};e.prototype.setDefaultParameters=function(){this.setParameters(this.getDefaultParameters())};e.prototype.initPlaceholders=function(){this.placeholders=this.placeholders.filter(function(t){if(!t.inputName){return false}t.input=document.body.querySelector('input[name="'+t.inputName+'"]');return!!t.input},this)};e.prototype.onPlaceholderWatcher=function(){if(this.placeholderWatchersStopped){return}this.canStopPlaceholderWatchers=false;this.setDefaultParameters();this.canStopPlaceholderWatchers=true};e.prototype.runPlaceholderWatcher=function(){this.placeholderWatchersStopped=false;this.placeholders.forEach(function(t){BX.bind(t.input,"bxchange",this.onPlaceholderWatcher.bind(this));BX.bind(t.input,"input",this.onPlaceholderWatcher.bind(this))},this);BX.bind(this.input,"input",this.stopPlaceholderWatcher.bind(this));BX.bind(this.input,"bxchange",this.stopPlaceholderWatcher.bind(this))};e.prototype.stopPlaceholderWatcher=function(){if(!this.canStopPlaceholderWatchers){return}this.placeholderWatchersStopped=true};e.prototype.onClick=function(){this.showPopup()};e.prototype.showPopup=function(){if(!this.popup){this.popup=BX.PopupWindowManager.create("sender-mail-link-editor-utm",this.button,{content:this.popupContent,autoHide:true,lightShadow:false,closeByEsc:true,contentColor:"white",angle:true,buttons:[new BX.PopupWindowButton({text:this.mess.accept,className:"popup-window-button-accept",events:{click:this.onPopupApply.bind(this)}}),new BX.PopupWindowButtonLink({text:this.mess.cancel,events:{click:function(){this.popupWindow.close()}}})]})}if(this.popup.isShown()){return}this.loadUtmParameters();t.changeDisplay(this.popupContent,true);this.popup.show()};e.prototype.onPopupApply=function(){this.saveUtmParameters();this.popup.close()};e.prototype.getDefaultParameters=function(){var e={};this.placeholders.forEach(function(t){if(!t.input.value){return}e[t.code]=BX.translit(t.input.value)},this);var i=t.replace(this.defaultValue,e,true);return this.parseParameters(i)};e.prototype.loadUtmParameters=function(){var e=this.getParameters();var i={};var n=false;this.getUtmNames().forEach(function(t){i[t]=e[t]||"";if(!n){n=i[t].length>0}},this);if(!n){i=this.getDefaultParameters()}this.getUtmNames().forEach(function(e){var n=i[e]||"";var r=t.getNode(e,this.popupContent);r?r.value=n:null},this)};e.prototype.saveUtmParameters=function(){var e={};this.getUtmNames().forEach(function(i){var n=t.getNode(i,this.popupContent);e[i]=n?BX.translit(n.value):""},this);this.setParameters(e)};e.prototype.getUtmNames=function(){return["utm_source","utm_medium","utm_campaign","utm_term","utm_content"]};e.prototype.setParameters=function(t){t=t||{};t=BX.mergeEx(this.getParameters(),t);var e=[];for(var i in t){if(!t.hasOwnProperty(i)){continue}if(t[i]===""||t[i]===null){continue}e.push(i+"="+encodeURIComponent(t[i]))}this.input.value=e.join("&")};e.prototype.getParameters=function(){return this.parseParameters(this.input.value)};e.prototype.parseParameters=function(t){var e={};t=t.trim();if(t.substring(0,1)==="?"){t=t.substring(1)}if(!t){return e}t.split("&").reduce(this.reduceParameter.bind(this),e);return e};e.prototype.reduceParameter=function(t,e){var i=e.split("=");if(!i[0]){return t}var n=decodeURIComponent(i[0].trim());if(!n){return t}var r=i[1].trim();if(!/%[a-zA-Z]{3,50}%/.test(r)){r=decodeURIComponent(r)}if(BX.util.in_array(n,this.getUtmNames())){r=BX.translit(r)}t[n]=r;return t};BX.Sender.Mail.LinkEditor=new e})(window);