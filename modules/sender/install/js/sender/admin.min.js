function GroupManager(e,t){var n=BX(t+"_EXISTS");var i=BX(t);var r=BX(t+"_HIDDEN");var a=BX.findChildren(i,{tag:"option"},true);if(e){var o=BX.findChildren(n,{tag:"option"},true);if(o&&o.length>0){var s=[];var l;for(var d in a){l=a[d];if(!l)continue;s.push(l.value)}var c;for(var d in o){l=o[d];if(!l||!l.selected)continue;if(!BX.util.in_array(l.value,s)){c=l.cloneNode(true);i.appendChild(c)}}}}else{var u;var f;var h=[];if(a&&a.length>0){for(var d in a){if(a[d]&&a[d].selected){h.push(a[d])}}}while(h.length>0){u=h.pop();f=u.parentNode;if(f)f.removeChild(u)}}var m;var v="";var p=[];a=BX.findChildren(i,{tag:"option"},true);for(var d in a){m=a[d];if(m&&m!="undefined"){if(m.value!="undefined"&&parseInt(m.value)>0&&!BX.util.in_array(m.value,p)){v=v+m.value+",";p.push(m.value)}}}r.value=v}function ConnectorGetHtmlForm(e){var t=document.getElementById("connector-template");var n=t.innerHTML;for(var i in e){n=n.replace(new RegExp(i,"g"),e[i])}return n}function ConnectorSettingWatch(){var e=document.getElementsByName("post_form");var t=e[e.length-1].elements;var n;for(var i in t){n=t[i];if(n&&n.name&&BX.type.isString(n.name)&&n.name.substring(0,11)=="CONNECTOR_S"){BX.unbindAll(BX(n));BX.bind(BX(n),"change",function(){ConnectorSettingGetCount(this)})}}}function ConnectorSettingShowToggle(e,t){if(e)t=BX.findParent(e,{tag:"div",className:"connector_form"},true);BX.toggleClass(t,"sender-box-list-item-hidden")}function ConnectorSettingDelete(e){var t=BX.findParent(e,{tag:"div",className:"connector_form"},true);var n=new BX.easing({duration:500,start:{height:100,opacity:100},finish:{height:0,opacity:0},transition:BX.easing.transitions.quart,step:function(e){t.style.opacity=e.opacity/100},complete:function(){BX.remove(t);ConnectorCounterSummary()}});n.animate()}function ConnectorSettingGetCount(e,t){var n;if(t){n=t}else{n=BX.findParent(e,{tag:"div",className:"connector_form"},true)}var i=document.getElementsByName("post_form");var r=i[i.length-1].elements;var a;var o=[];var s;for(var l in r){a=r[l];if(!a||!a.name||!BX.type.isString(a.name)){continue}if(a.name.substring(0,11)!="CONNECTOR_S"){continue}s=BX.findParent(a,{tag:"div",className:"connector_form"},true);if(s!=n){continue}if(a.disabled){continue}var d=o.filter(function(e){return e==a});if(d.length==0){o.push(a)}}var c=[];for(var l=0;l<o.length;l++){a=o[l];switch(a.type.toLowerCase()){case"text":case"textarea":case"password":case"number":case"hidden":case"select-one":c.push({name:a.name,value:a.value});break;case"file":break;case"radio":case"checkbox":if(a.checked){c.push({name:a.name,value:a.value})}break;case"select-multiple":var u=[];for(var f=0;f<a.options.length;f++){if(a.options[f].selected){u.push(a.options[f].value)}}if(u.length>0){c.push({name:a.name,value:u})}break;default:break}}var h={};for(var m=0;m<c.length;m++){var v=c[m];if(BX.type.isString(h[v.name])){h[v.name]=[h[v.name]]}if(BX.type.isArray(h[v.name])){if(!BX.util.in_array(v.value,h[v.name])){h[v.name].push(v.value)}}else{h[v.name]=v.value}}var p=BX.findChild(n,{className:"connector_form_counter"},true);if(p){p.innerHTML="";BX.addClass(p.parentNode,"loading")}BX.ajax({url:"sender_group_count.php",method:"POST",data:h,dataType:"json",timeout:30,async:true,processData:true,onsuccess:function(e){if(p){BX.removeClass(p.parentNode,"loading");p.innerHTML=e.COUNT;ConnectorCounterSummary()}},onfailure:function(){var e=new BX.CDialog({height:100,width:500,title:BX.message("GROUP_ADDRESS_CALC_TITLE"),content:BX.message("GROUP_ADDRESS_CALC_TEXT"),buttons:[BX.CDialog.prototype.btnClose]});e.ShowError(BX.message("GROUP_ADDRESS_CALC_ERROR"));e.Show();if(p){BX.removeClass(p.parentNode,"loading");p.innerHTML=BX.message("GROUP_ADDRESS_CALC_ERROR").toLowerCase()}}})}function addNewConnector(){var e=connectorListToAdd[BX("connector_list_to_add").value]["NAME"];var t=connectorListToAdd[BX("connector_list_to_add").value]["FORM"];t=t.replace(new RegExp("%CONNECTOR_NUM%","g"),Math.floor(Math.random()*(1e4-100+1))+100);var n=ConnectorGetHtmlForm({"%CONNECTOR_NAME%":e,"%CONNECTOR_COUNT%":"0","%CONNECTOR_FORM%":t});var i=BX.processHTML(n);var r=document.createElement("div");r.innerHTML=i.HTML;var a=BX.findChild(r,{tag:"div"});var o=BX("connector_form_container");newConnectorNodeDisplay=a.style.display;a.style.display="none";o.insertBefore(a,o.firstChild);if(i.SCRIPT.length>0){var s;for(var l in i["SCRIPT"]){s=i["SCRIPT"][l];BX.evalGlobal(s.JS)}}ConnectorSettingShowToggle(false,a);var d=new BX.easing({duration:500,start:{height:0,opacity:0},finish:{height:100,opacity:100},transition:BX.easing.transitions.quart,step:function(e){a.style.opacity=e.opacity/100;a.style.display=newConnectorNodeDisplay},complete:function(){}});d.animate();ConnectorSettingGetCount(null,a);ConnectorSettingWatch()}function ConnectorCounterSummary(){var e=0;var t=0;var n=BX("connector_form_container");var i=BX.findChildren(n,{className:"connector_form_counter"},true);for(var r in i){e=parseInt(i[r].innerHTML);if(!isNaN(e))t+=e}BX("sender_group_address_counter").innerHTML=t}function SetAddressToControl(e,t,n){var i=BX(e);if(n)i.value+=t;else i.value=t}function ProcessAddressToControl(e,t,n){t=BX.util.trim(t);var i=BX(e);var r=[];var a=[];if(i.value)r=i.value.split(",");var o=false;for(var s in r){addressFromList=BX.util.trim(r[s]);if(addressFromList==t){o=true;if(!n)a.push(addressFromList)}else{a.push(addressFromList)}}if(!o&&!n)a.push(t);i.value=a.join(", ")}function DeleteAddressFromControl(e,t){ProcessAddressToControl(e,t,true)}function AddAddressToControl(e,t){ProcessAddressToControl(e,t,false)}function SetSendType(){var e=BX("chain_send_type").value;var t=BX.findChildren(BX("chain_send_type_list_container"),{className:"sender-box-list-item"},true);for(var n in t){if(t[n].id!="chain_send_type_"+e)t[n].style.display="none";else t[n].style.display="block"}BX("SEND_TYPE").value=e;BX("sender_wizard_chain_send_type_btn").disabled=true;BX("chain_send_type").disabled=true}function DeleteSelectedSendType(e){BX.findParent(e,{className:"sender-box-list-item"}).style.display="none";BX("SEND_TYPE").value="";BX("sender_wizard_chain_send_type_btn").disabled=false;BX("chain_send_type").disabled=false}function SenderLetter(){var e;var t;var n;var i;this.init=function(e){this.container=BX(e.container);var t=BX.findChild(this.container,{className:"typearea"},true);this.id=t.getAttribute("name");this.textareaId=t.getAttribute("name");this.editorBlockContainer=BX("bx-sender-block-editor-"+this.id);var n=this;var i,r,a;n.changeTemplateList("BASE");r=BX.findChild(this.container,{className:"sender-template-btn-close"},true);if(r){BX.bind(r,"click",function(){BX.onCustomEvent(n.container,"onSenderMailingTemplateListHide")})}i=BX.findChildren(this.container,{className:"sender-template-type-selector-button"},true);for(a in i){if(!i[a])continue;r=i[a];BX.bind(r,"click",function(){var e="BASE";if(this.getAttribute&&this.getAttribute("data-bx-sender-tmpl-type")){e=this.getAttribute("data-bx-sender-tmpl-type")}n.changeTemplateList(e)})}i=BX.findChildren(this.container,{className:"sender-template-list-block-selector"},true);for(a in i){if(!i[a])continue;r=i[a];BX.bind(r,"click",function(){var e="block",t="",i="BASE",r=0,a="";if(this.getAttribute&&this.getAttribute("data-bx-sender-tmpl-type")){e=this.getAttribute("data-bx-sender-tmpl-version");t=this.getAttribute("data-bx-sender-tmpl-name");i=this.getAttribute("data-bx-sender-tmpl-type");r=this.getAttribute("data-bx-sender-tmpl-code");a=this.getAttribute("data-bx-sender-tmpl-lang")}n.setTemplate({lang:a,version:e,name:t,type:i,num:r})})}i=BX.findChildren(this.container,{className:"sender-template-message-caption-container-btn"},true);for(a in i){if(!i[a])continue;r=i[a];BX.bind(r,"click",function(){BX.onCustomEvent(n.container,"onSenderMailingTemplateListShow")})}i=BX.findChildren(this.container,{className:"sender-template-message-preview-btn"},true);for(a in i){if(!i[a])continue;r=i[a];BX.bind(r,"click",function(){if(this.getAttribute&&this.getAttribute("data-bx-sender-tmpl-type")){var e=this.getAttribute("data-bx-sender-tmpl-type");var t=this.getAttribute("data-bx-sender-tmpl-code");var n=this.getAttribute("data-bx-sender-tmpl-lang");var i="/bitrix/admin/sender_template_admin.php?action=get_template";i=i+"&lang="+n+"&template_type="+e+"&template_id="+t;BX.util.popup(i,800,800)}})}return this};this.setTemplateContainer=function(e){this.container=BX(e);return this};this.onSetTemplate=function(e){BX.addCustomEvent(this.container,"onSenderMailingTemplateSet",e)};this.setTemplate=function(e){if(!this.container)return;BX.onCustomEvent(this.container,"onSenderMailingTemplateSet");var t=false;var n=this.editorBlockContainer.style.display!=="none";var i=e.version!=="visual";var r=!!BX(this.getTextAreaAttributeId()).value;if(i&&n){t=true}if(!r||t||confirm(BX.message("SENDER_SHOW_TEMPLATE_LIST"))){this.setContent(this.textareaId,e.version,e.type,e.num,e.lang);var a=BX.findChild(this.container,{className:"sender-template-message-caption-container"},true);if(a)a.innerText=e.name;return true}else{return false}};this.changeTemplateList=function(e){if(!this.container)return;t=BX.findChild(this.container,{className:"sender-template-cont"},true);if(!t)return;var n=BX.findChildren(t,{className:"sender-template-list-type-container"},true);for(var i in n)n[i].style.display="none";var r=BX.findChild(t,{className:"sender-template-list-type-container-"+e},true);r.style.display="block";var a=BX.findChildren(t,{className:"sender-template-type-selector-button"},true);for(var o in a){if(!BX.hasClass(a[o],"sender-template-type-selector-button-type-"+e))BX.removeClass(a[o],"sender-template-type-selector-button-selected");else BX.addClass(a[o],"sender-template-type-selector-button-selected")}};this.getHtmlEditor=function(){var e=BX.findChild(this.container,{className:"typearea"},true);var t=e.getAttribute("name");return window.BXHtmlEditor.Get(t)};this.getTextAreaAttributeId=function(){var e=BX.findChild(this.container,{className:"typearea"},true);return e.getAttribute("id")};this.putMessage=function(e,t){var n=false;if(!this.container)return;var i=this.getTextAreaAttributeId();var r;if(window.BXHtmlEditor)r=this.getHtmlEditor();var a=BX(i);if(r)n=r.IsShown();if(n){if(t){r.SetContent(e,true)}else{r.InsertHtml(e)}}else{if(t){a.value=e}else{a.value+=e}BX.fireEvent(a,"change")}};this.setContent=function(e,t,n,i,r){var a="/bitrix/admin/sender_template_admin.php?action=get_template";a=a+"&lang="+r+"&template_type="+n+"&template_id="+i;var o=BX("bx-sender-block-editor-"+e);var s=o.querySelector('input[name*="TEMPLATE_TYPE"]');var l=o.querySelector('input[name*="TEMPLATE_ID"]');if(t=="block"){if(s&&l){s.value=n;l.value=i}var d=BX.BlockEditorManager.get(e);d.load(a);this.switchView(e,true)}else{BX.ajax({url:a,method:"GET",dataType:"html",data:{},onsuccess:BX.delegate(function(t){if(s&&l){s.value="";l.value=""}this.putMessage(t,true);this.switchView(e,false)},this)})}};this.switchView=function(e,t){var n=BX("bx-sender-block-editor-"+e);var i=BX("bx-sender-visual-editor-"+e);var r=BXHtmlEditor.Get(e);if(t){n.style.display="block";i.style.display="none";if(r)r.Hide()}else{i.style.display="block";if(r)r.Show();n.style.display="none"}this.isBlockCurrentEditorVersion=t}}function SenderLetterManager(){if(SenderLetterManager.instance){return SenderLetterManager.instance}this.list={};this.placeHolderList={};this.onPlaceHolderSelectorListCreate=function(e){e.placeHolderList=this.getPlaceHolderList()};this.onGetControlsMap=function(e){e.push({id:"placeholder_selector",compact:true,hidden:false,sort:1,checkWidth:false,offsetWidth:32})};this.onEditorInitedBefore=function(e){BX.addCustomEvent(e,"PlaceHolderSelectorListCreate",this.onPlaceHolderSelectorListCreate.bind(this));BX.addCustomEvent(e,"GetControlsMap",this.onGetControlsMap.bind(this))};this.onEditorParse=function(e){};this.onEditorAfterParse=function(e,t){};this.onEditorInitedAfter=function(e){e.components.SetComponentIcludeMethod("EventMessageThemeCompiler::includeComponent")};this.add=function(e,t){var n=new SenderLetter;n.id=e;n.init(t);this.list[e]=n;return n};this.get=function(e){if(this.list[e])return this.list[e];else return null};this.onSetTemplate=function(e){BX.addCustomEvent("onSenderMailingTemplateSet",e)};this.onShowTemplateList=function(e){BX.addCustomEvent("onSenderMailingTemplateListShow",e)};this.onHideTemplateList=function(e){BX.addCustomEvent("onSenderMailingTemplateListHide",e)};this.setPlaceHolderList=function(e){this.placeHolderList=e};this.getPlaceHolderList=function(){return this.placeHolderList};BX.addCustomEvent("OnEditorInitedBefore",this.onEditorInitedBefore.bind(this));BX.addCustomEvent("OnEditorInitedAfter",this.onEditorInitedAfter.bind(this));SenderLetterManager.instance=this}function SenderLetterContainer(e){if(SenderLetterContainer.instance){return SenderLetterContainer.instance}this.deleteItem=function(e){var t=new BX.easing({duration:500,start:{height:100,opacity:100},finish:{height:0,opacity:0},transition:BX.easing.transitions.quart,step:function(t){e.style.opacity=t.opacity/100},complete:BX.delegate(function(){this.removeDraggableItem(e);BX.remove(e);this.sortItems()},this)});t.animate()};this.addItem=function(e){formContainer=this.container;var t=Math.floor(Math.random()*(1e4-100+1))+100;var n=letterTemplate.FIELDS.MESSAGE;n=n.replace(new RegExp("SENDER_LETTER_TEMPLATE_MESSAGE","g"),"CHAIN_MESSAGE_"+t);n=n.replace(new RegExp("sender_letter_template_message","g"),"chain_message_"+t);n=n.replace(new RegExp("%SENDER_LETTER_TEMPLATE_BODY_NUM%","g"),t);var i=letterTemplate.BODY.replace(new RegExp("%SENDER_LETTER_TEMPLATE_BODY_NUM%","g"),t);i=i.replace(new RegExp("%SENDER_LETTER_TEMPLATE_MESSAGE%","g"),n);var r=BX.processHTML(i);var a=document.createElement("div");a.innerHTML=r.HTML;var o=BX.findChild(a,{tag:"div"});var s;if(e)s=BX.findNextSibling(e);o.style.display="none";if(s){formContainer.insertBefore(o,s)}else{formContainer.appendChild(o)}this.addListenerControlItem(o);this.setTimeText(o);this.addDraggableItem(o);this.sortItems();var l=new BX.easing({duration:500,start:{height:0,opacity:0},finish:{height:100,opacity:100},transition:BX.easing.transitions.quart,step:function(e){o.style.opacity=e.opacity/100;o.style.display="block"},complete:function(){}});l.animate();if(r.SCRIPT.length>0){var d;for(var c in r["SCRIPT"]){d=r["SCRIPT"][c];BX.evalGlobal(d.JS)}}};this.toggleShow=function(e,t,n,i){if(!e&&n){e=n.querySelector(".sender_letter_container_body")}if(!t&&n){t=n.querySelector(".sender_letter_container_button_show")}if(e&&t){if(i===null){if(e.style.display=="none")i=true;else i=false}BX.removeClass(t,"sender_letter_container_button_hide");if(i){e.style.display="";t.innerHTML=BX.message("SENDER_MAILING_TRIG_LETTER_MESSAGE_HIDE");BX.addClass(t,"sender_letter_container_button_hide")}else{e.style.display="none";t.innerHTML=BX.message("SENDER_MAILING_TRIG_LETTER_MESSAGE_SHOW")}}};this.addListenerControlItem=function(e){if(!e||!e.querySelector)return;var t=e.querySelector(".sender_letter_container_button_show");var n=e.querySelector(".sender_letter_container_body");if(t&&n){BX.bind(t,"click",BX.delegate(function(){this.toggleShow(n,t,null,null)},this))}var i=e.querySelector(".sender_letter_container_button_delete");if(i){BX.bind(i,"click",BX.delegate(function(){this.deleteItem(e)},this))}var r=e.querySelector(".sender_letter_container_subject");var a=e.querySelector(".sender_letter_container_caption");if(r&&a){BX.bind(r,"input",function(){a.textContent=r.value});BX.bind(r,"change",function(){a.textContent=r.value})}var o=e.querySelector(".sender_letter_container_time_button");if(o){BX.bind(o,"click",BX.delegate(function(){this.showTimeDialog(e,o)},this))}};this.initListenerControls=function(){var e=this.container.children;for(var t in e){this.addListenerControlItem(e[t])}};this.addDraggableItem=function(e){if(!this.dragdrop)return;this.dragdrop.addSortableItem(e);this.dragdrop.bindDragItem([e])};this.removeDraggableItem=function(e){if(!this.dragdrop)return;this.dragdrop.removeSortableItem(e)};this.initDraggableItems=function(){var e=this;this.dragdrop=BX.DragDrop.create({dragItemClassName:"sender-trigger-chain-container-letter",dragItemControlClassName:"sender_letter_container_head",sortable:{rootElem:BX("SENDER_TRIGGER_CHAIN_CONTAINER"),gagClass:"senderdrag",gagHtml:""},dragStart:function(t,n,i){e.toggleShow(null,null,n,false);BX.addClass(e.container,"sendercontdrag")},dragEnd:function(t,n,i){BX.removeClass(e.container,"sendercontdrag");e.sortItems();e.initTimeText();e.repairEditor(n)}})};this.repairEditor=function(e){var t=BX.findChild(e,{className:"typearea"},true);var n,i;var r;for(var a in t.attributes){if(!t.attributes[a])continue;r=t.attributes[a];if(r.nodeName=="id")n=r.nodeValue;else if(r.nodeName=="name")i=r.nodeValue}var o;if(window.BXHtmlEditor)o=window.BXHtmlEditor.Get(i);var s=BX(n);if(!o){return}setTimeout(function(){o.CheckAndReInit()},100)};this.initTimeText=function(){var e=this.container.children;for(var t in e){this.setTimeText(e[t])}};this.sortItems=function(){var e=this.container.children;var t;var n;var i=1;for(var r in e){if(!e[r]||!e[r].querySelectorAll)continue;t=e[r].querySelector("input.sender_letter_container_sorter[type=hidden]");n=e[r].querySelector(".sender_letter_container_sorter_text");if(t&&n){t.value=i;n.innerHTML=i;i++}}};this.showTimeDialog=function(e,t){var n=BX.PopupWindowManager.create("sender-letter-container-time-dialog",t,{darkMode:false,closeIcon:true,content:BX("SENDER_TIME_DIALOG"),className:"adm-workarea"});n.close();n.setBindElement(t);var i=BX("SENDER_TIME_DIALOG_BTN_CANCEL");var r=BX("SENDER_TIME_DIALOG_BTN_SAVE");n.close();BX.unbindAll(i);BX.bind(i,"click",function(){n.close()});BX.unbindAll(r);BX.bind(r,"click",BX.delegate(function(){this.setTimeItem(e);this.setTimeText(e);n.close()},this));this.setTimeToDialog(e);n.show()};this.setTimeText=function(e){if(!e||!e.querySelector)return;var t=e.querySelector(".sender_letter_container_time");var n=e.querySelector(".sender_letter_container_time_text");var i=e.querySelector(".sender_letter_container_time_text_first");var r=e.querySelector(".sender_letter_container_time_text_nonfirst");var a=this.convertTime(t.value);n.innerHTML=a.VALUE+" "+a.TEXT;if(this.container.children[0]==e){BX(i).style.display="";r.style.display="none"}else{BX(i).style.display="none";r.style.display=""}};this.setTimeToDialog=function(e){if(!e||!e.querySelector)return;var t=BX("SENDER_TIME_DIALOG_TYPE");var n=BX("SENDER_TIME_DIALOG_VALUE");var i=e.querySelector(".sender_letter_container_time");var r=this.convertTime(i.value);t.value=r.TYPE;n.value=r.VALUE};this.setTimeItem=function(e){if(!e||!e.querySelector)return;var t=BX("SENDER_TIME_DIALOG_TYPE");var n=BX("SENDER_TIME_DIALOG_VALUE");var i=e.querySelector(".sender_letter_container_time");i.value=this.convertTime(null,{TYPE:t.value,VALUE:n.value})};this.convertTime=function(e,t){var n;if(e!==null){e=parseInt(e);if(isNaN(e)||e==0)e=0;if(e!=0)for(n in dictionarySenderTime){if(e%dictionarySenderTime[n].VALUE===0){return{TYPE:dictionarySenderTime[n].TYPE,VALUE:e/dictionarySenderTime[n].VALUE,TEXT:dictionarySenderTime[n].TEXT}}}var i=dictionarySenderTime[dictionarySenderTime.length-1];return{TYPE:i.TYPE,VALUE:0,TEXT:i.TEXT}}else{var r=parseInt(t.VALUE);if(isNaN(r))r=0;for(n in dictionarySenderTime){if(dictionarySenderTime[n].VALUE&&dictionarySenderTime[n].TYPE==t.TYPE){return r*dictionarySenderTime[n].VALUE}}return 0}};this.container=e.container;this.initListenerControls();this.initTimeText();this.initDraggableItems();SenderLetterContainer.instance=this}