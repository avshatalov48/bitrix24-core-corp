{"version":3,"file":"personalization_selector.bundle.js","sources":["../src/personalization_selector.js"],"sourcesContent":["import {Type, MenuManager, Loc, Event} from 'main.core';\nimport {EntitySelector} from 'ui.entity-selector'\n\ndeclare type PersonalizationOptions = {\n\tbutton: Element,\n\ttargetInput: ?Element,\n\tfields: FieldItem,\n\tonItemClick: (event: BaseEvent) => void\n}\n\ndeclare type FieldItem = {\n\tid: string,\n\ttext: string,\n\ttitle: string,\n\titems: FieldItem[],\n}\n\nexport class PersonalizationSelector\n{\n\t#dialog: EntitySelector.Dialog;\n\t#menuButton: Element;\n\t#targetInput: ?Element;\n\t#onItemClick: (event: BaseEvent) => void;\n\t#fields: FieldItem[];\n\n\tconstructor(options: PersonalizationOptions)\n\t{\n\t\tthis.#menuButton = options.button;\n\t\tthis.#targetInput = options.targetInput;\n\t\tthis.#fields = options.fields;\n\t\tthis.#onItemClick = options.onItemClick || {};\n\n\t\tEvent.bind(this.#menuButton, 'click', this.openMenu.bind(this));\n\t}\n\n\tsetName(name)\n\t{\n\t\tif (Type.isString(name))\n\t\t{\n\t\t\tthis.name = name;\n\t\t}\n\t}\n\n\tgetName()\n\t{\n\t\treturn this.name;\n\t}\n\n\tonKeyDown(container, e)\n\t{\n\t\tif (e.keyCode == 45 && e.altKey === false && e.ctrlKey === false && e.shiftKey === false)\n\t\t{\n\t\t\tthis.openMenu(e);\n\t\t\te.preventDefault();\n\t\t}\n\t}\n\n\topenMenu(e)\n\t{\n\t\tif (this.#dialog)\n\t\t{\n\t\t\tthis.#dialog.show();\n\t\t\treturn;\n\t\t}\n\n\t\tlet menuItems = [];\n\t\tconst menuGroups = {\n\t\t\t'ROOT': {\n\t\t\t\ttitle: Loc.getMessage('SENDER_PERSONALIZATION_SELECTOR_ROOT'),\n\t\t\t\tentityId: 'sender',\n\t\t\t\ttabs: 'recents',\n\t\t\t\tid: 'ROOT',\n\t\t\t\tchildren: []\n\t\t\t}\n\t\t};\n\t\tthis.#prepareItem(this.#fields, menuGroups);\n\n\t\tif (Object.keys(menuGroups).length < 2)\n\t\t{\n\t\t\tif (menuGroups['ROOT']['children'].length > 0)\n\t\t\t{\n\t\t\t\tmenuItems = menuGroups['ROOT']['children'];\n\t\t\t}\n\t\t} else\n\t\t{\n\t\t\tif (menuGroups['ROOT']['children'].length > 0)\n\t\t\t{\n\t\t\t\tmenuItems.push(menuGroups['ROOT']);\n\t\t\t}\n\t\t\tdelete menuGroups['ROOT'];\n\n\t\t\tfor (let groupKey in menuGroups)\n\t\t\t{\n\t\t\t\tif (menuGroups.hasOwnProperty(groupKey) && menuGroups[groupKey]['children'].length > 0)\n\t\t\t\t{\n\t\t\t\t\tmenuItems.push(menuGroups[groupKey])\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.#dialog = new EntitySelector.Dialog({\n\t\t\ttargetNode: this.#menuButton,\n\t\t\ttagSelectorOptions: {textBoxWidth: 500},\n\t\t\twidth: 500,\n\t\t\theight: 300,\n\t\t\tmultiple: false,\n\t\t\tdropdownMode: true,\n\t\t\tenableSearch: true,\n\t\t\titems: this.injectDialogMenuTitles(menuItems.reverse()),\n\t\t\tshowAvatars: false,\n\t\t\tevents: {\n\t\t\t\t'Item:onBeforeSelect': Type.isFunction(this.#onItemClick) ? this.#onItemClick : (event) =>\n\t\t\t\t{\n\t\t\t\t\tevent.preventDefault();\n\t\t\t\t\tthis.onFieldSelect(event.getData().item.getCustomData().get('property'))\n\t\t\t\t}\n\t\t\t},\n\t\t\tcompactView: true\n\t\t});\n\n\t\tthis.#dialog.show();\n\t}\n\n\t#prepareItem(fields: FieldItem[], menuGroups: Object)\n\t{\n\t\tfields.forEach(field =>\n\t\t{\n\t\t\tlet groupKey = field.id.indexOf('.') < 0 ?\n\t\t\t\t(field.items && field.items.length > 0 ? field.id : 'ROOT')\n\t\t\t\t: field.id.split('.')[0] + '#';\n\t\t\tif (!field.text && !field.title)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!menuGroups[groupKey])\n\t\t\t{\n\t\t\t\tmenuGroups[groupKey] = {\n\t\t\t\t\ttitle: field.text || field.title,\n\t\t\t\t\tentityId: 'sender',\n\t\t\t\t\ttabs: 'recents',\n\t\t\t\t\ttabId: 'sender',\n\t\t\t\t\tid: field.id,\n\t\t\t\t\tchildren: []\n\t\t\t\t} ;\n\t\t\t}\n\n\t\t\tif (field.items && field.items.length > 0)\n\t\t\t{\n\t\t\t\tthis.#prepareItem(field.items, menuGroups);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmenuGroups[groupKey]['children'].push({\n\t\t\t\ttitle: field.text || field.title,\n\t\t\t\tcustomData: {property: field},\n\t\t\t\tentityId: 'sender',\n\t\t\t\ttabs: 'recents',\n\t\t\t\tid: field.id,\n\t\t\t});\n\t\t});\n\t}\n\n\tinjectDialogMenuTitles(items)\n\t{\n\t\titems.forEach(parent =>\n\t\t{\n\t\t\tif (Type.isArray(parent.children))\n\t\t\t{\n\t\t\t\tparent.searchable = false;\n\t\t\t\tthis.injectDialogMenuSupertitles(parent.title, parent.children);\n\t\t\t}\n\t\t}, this);\n\t\treturn items;\n\t}\n\n\tinjectDialogMenuSupertitles(title, children)\n\t{\n\t\tchildren.forEach(function (child)\n\t\t{\n\t\t\tif (!child.supertitle)\n\t\t\t{\n\t\t\t\tchild.supertitle = title;\n\t\t\t}\n\t\t\tif (Type.isArray(child.children))\n\t\t\t{\n\t\t\t\tchild.searchable = false;\n\t\t\t\tthis.injectDialogMenuSupertitles(child.title, child.children);\n\t\t\t}\n\t\t}, this);\n\t}\n\n\tonFieldSelect(field)\n\t{\n\t\tif (!field)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#targetInput.value = this.#targetInput.value + field.id;\n\t}\n\n\tdestroy()\n\t{\n\t\tif (this.#dialog)\n\t\t{\n\t\t\tthis.#dialog.destroy();\n\t\t}\n\t}\n}\n"],"names":["PersonalizationSelector","options","button","targetInput","fields","onItemClick","Event","bind","openMenu","name","Type","isString","container","e","keyCode","altKey","ctrlKey","shiftKey","preventDefault","show","menuItems","menuGroups","title","Loc","getMessage","entityId","tabs","id","children","Object","keys","length","push","groupKey","hasOwnProperty","EntitySelector","Dialog","targetNode","tagSelectorOptions","textBoxWidth","width","height","multiple","dropdownMode","enableSearch","items","injectDialogMenuTitles","reverse","showAvatars","events","isFunction","event","onFieldSelect","getData","item","getCustomData","get","compactView","forEach","parent","isArray","searchable","injectDialogMenuSupertitles","child","supertitle","field","value","destroy","indexOf","split","text","tabId","customData","property"],"mappings":"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"}