jn.define("lists/entity-detail",((t,e,i)=>{const s=t("apptheme");const{PureComponent:a}=t("layout/pure-component");const{EventEmitter:n}=t("event-emitter");const{Loc:o}=t("loc");const{DetailTab:l}=t("lists/entity-detail/detail-tab");const{FocusManager:d}=t("layout/ui/fields/focus-manager");const{NotifyManager:r}=t("notify-manager");const h={DETAIL_TAB:"detail"};class c extends a{static open(t=PageManager,e={}){t.openWidget("layout",{modal:true,onReady:t=>{const i=e;i.layout=t;t.showComponent(new c(i))}},t)}constructor(t){super(t);this.state.iBlock={id:t.iBlockId,typeId:t.iBlockTypeId,elementName:o.getMessage("LISTSMOBILE_EXT_ENTITY_DETAIL_DETAIL_TAB_DEFAULT_TITLE")};this.state.entityId=t.entityId||0;this.uid=t.uid||Random.getString();this.iBlockSectionId=t.iBlockSectionId||0;this.socNetGroupId=t.socNetGroupId||0;this.activeTabId=t.activeTabId||h.DETAIL_TAB;this.isIBlockLoaded=false;this.isLoading=true;this.isSaving=false;this.tabViewRef=null;this.sliderRef=null;this.tabRefMap=new Map;this.eventMap=new Map;this.customEventEmitter=n.createWithUid(this.uid);BX.onViewLoaded((()=>{this.loadIBlock()}))}get layout(){return this.props.layout||layout||{}}get styles(){return{component:{backgroundColor:s.colors.bgSecondary},tabView:{height:44,marginBottom:10},tab:{tabTitle:{underlineColor:s.colors.accentMainPrimary}}}}componentDidMount(){super.componentDidMount();this.eventMap.set("DetailTab::onAfterEntityLoad",this.handleDetailCardLoaded.bind(this));this.customEventEmitter.on("DetailTab::onAfterEntityLoad",this.eventMap.get("DetailTab::onAfterEntityLoad"));this.setWidgetTitle();this.setTopButtons()}handleDetailCardLoaded(){this.setIsLoading(false)}setWidgetTitle(){this.layout.setTitle({text:this.state.iBlock.name||""})}setTopButtons(){this.layout.setLeftButtons([{svg:{content:`\n\t\t\t\t\t\t\t<svg\n\t\t\t\t\t\t\t\twidth="20"\n\t\t\t\t\t\t\t\theight="20"\n\t\t\t\t\t\t\t\tviewBox="0 0 20 20"\n\t\t\t\t\t\t\t\tfill="none"\n\t\t\t\t\t\t\t\txmlns="http://www.w3.org/2000/svg"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<path\n\t\t\t\t\t\t\t\t\tfill-rule="evenodd"\n\t\t\t\t\t\t\t\t\tclip-rule="evenodd"\n\t\t\t\t\t\t\t\t\td="M14.722 6.79175L10.9495 10.5643L9.99907 11.5L9.06666 10.5643L5.29411 6.79175L3.96289 8.12297L10.008 14.1681L16.0532 8.12297L14.722 6.79175Z"\n\t\t\t\t\t\t\t\t\tfill="#A8ADB4"\n\t\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t</svg>\n\t\t\t\t\t\t`},callback:()=>this.layout.close()}]);this.eventMap.set("right-button-save",this.handleSaveButtonClick.bind(this));this.setRightButtons()}handleSaveButtonClick(){if(this.isLoading||this.isSaving){return}this.setIsSaving(true);d.blurFocusedFieldIfHas().then((()=>this.validate())).then((()=>this.getData())).then((t=>{let e={};for(const i of t){e={...e,...i}}return e})).then((t=>this.runSave(t))).then((t=>this.processSave(t))).catch((t=>{if(Array.isArray(t.errors)){r.showErrors(t.errors)}})).finally((()=>{this.setIsSaving(false)}))}validate(){return Promise.all(this.tabRefs.map((t=>t.validate?t.validate():{})))}getData(){return Promise.all(this.tabRefs.map((t=>t.getData?t.getData():{})))}runSave(t={}){const e=t;e.IBLOCK_ID=this.state.iBlock.id;e.IBLOCK_TYPE_ID=this.state.iBlock.typeId;e.SOCNET_GROUP_ID=this.socNetGroupId;return BX.ajax.runAction("listsmobile.EntityDetails.updateEntity",{data:{id:this.state.entityId,fields:e}})}processSave(t){this.isChanged=false;this.isEditing=false;this.isSaving=false;this.isLoading=false;this.setTopButtons();this.tabRefs.forEach((e=>e.setResult?e.setResult(t):{}));if(t.data.id){this.setState({entityId:t.data.id})}}componentWillUnmount(){super.componentWillUnmount();this.customEventEmitter.off("DetailTab::onAfterEntityLoad",this.eventMap.get("DetailTab::onAfterEntityLoad"))}setIsLoading(t=true){this.isLoading=t;this.setRightButtons()}setIsSaving(t=true){this.isSaving=t;this.setRightButtons()}setRightButtons(){let t=this.state.entityId<=0?o.getMessage("LISTSMOBILE_EXT_ENTITY_DETAIL_CREATE_BUTTON_TITLE"):o.getMessage("LISTSMOBILE_EXT_ENTITY_DETAIL_CHANGE_BUTTON_TITLE");if(this.isSaving){t=this.state.entityId<=0?o.getMessage("LISTSMOBILE_EXT_ENTITY_DETAIL_CREATE_BUTTON_TITLE_PROCESSING"):o.getMessage("LISTSMOBILE_EXT_ENTITY_DETAIL_CHANGE_BUTTON_TITLE_PROCESSING")}this.layout.setRightButtons([{name:t,type:"text",color:this.isLoading||this.isSaving?s.colors.accentMainPrimary:s.colors.accentMainLinks,callback:this.eventMap.get("right-button-save")}])}loadIBlock(){if(this.isIBlockLoaded){return}this.setIsLoading(true);BX.ajax.runAction("listsmobile.EntityDetails.loadIBlock",{data:{iBlockId:this.props.iBlockId,iBlockTypeId:this.props.iBlockTypeId,socNetGroupId:this.props.socNetGroupId}}).then((t=>{const e=t.data.iBlock;e.elementName=e.elementName||this.state.iBlock.elementName;this.isIBlockLoaded=true;this.setState({iBlock:e});this.setWidgetTitle();this.setIsLoading(false)})).catch((()=>{}))}render(){return View({resizableByKeyboard:true,style:this.styles.component},this.renderTabHeader(),this.renderTabSlider())}renderTabHeader(){return TabView({style:this.styles.tabView,params:{styles:this.styles.tab,items:this.tabItems},onTabSelected:this.handleTabSelected.bind(this),ref:t=>{if(t){this.tabViewRef=t}}})}handleTabSelected(t,e){if(e){this.activeTabId=t.id;if(this.sliderRef){const e=this.tabItems.findIndex((e=>t.id===e.id));if(e>=0){this.sliderRef.scrollToPage(e,true)}}}}renderTabSlider(){if(this.isIBlockLoaded===true){return Slider({bounces:true,style:{flex:1},initPage:0,ref:t=>{if(t){this.sliderRef=t}},onPageChange:this.handleSliderPageChange.bind(this),onPageWillChange:this.handleSliderPageWillChange.bind(this)},...this.tabItems.map((t=>this.renderTab(t.id))))}return null}handleSliderPageWillChange(t,e){const i=this.tabItems[e==="right"?t+1:t-1];if(i&&i.selectable&&this.tabRefMap.has(i.id)){this.tabRefMap.get(i.id).load()}}handleSliderPageChange(t){const e=this.tabItems[t];if(e&&e.selectable){const t=this.tabViewRef.getCurrentItem();if(!t||t.id!==e.id){this.tabViewRef.setActiveItem(e.id)}}}renderTab(t){if(t===h.DETAIL_TAB){if(!this.tabRefMap.has(t)){const e=l.create({uid:this.uid,iBlock:this.state.iBlock,entityId:this.state.entityId,sectionId:this.iBlockSectionId,socNetGroupId:this.socNetGroupId,layout:this.layout});e.load();this.tabRefMap.set(t,e)}return this.tabRefMap.get(t)}return View({},Text({text:Random.getString()}))}get tabRefs(){return this.tabItems.map((({id:t})=>this.tabRefMap.get(t))).filter(Boolean)}get tabItems(){return[{id:h.DETAIL_TAB,title:this.state.iBlock.elementName,selectable:true,active:true},{id:"bp",title:o.getMessage("LISTSMOBILE_EXT_ENTITY_DETAIL_BP_TAB_DEFAULT_TITLE"),selectable:true}]}}i.exports={EntityDetail:c,EntityDetailTabs:h}}));
//# sourceMappingURL=extension.map.js