jn.define("lists/element-details",((e,t,i)=>{const s=e("apptheme");const{Loc:o}=e("loc");const{EventEmitter:r}=e("event-emitter");const{inAppUrl:n}=e("in-app-url");const{NotifyManager:l}=e("notify-manager");const{Haptics:a}=e("haptics");const{Alert:d}=e("alert");const{PureComponent:h}=e("layout/pure-component");const{FocusManager:c}=e("layout/ui/fields/focus-manager");const{EntityManager:u}=e("layout/ui/entity-editor/manager");const{CollapsibleText:m}=e("layout/ui/collapsible-text");const{Line:E}=e("utils/skeleton");class g extends h{static open(e,t=PageManager){t.openWidget("layout",{modal:true,titleParams:{text:e.title||o.getMessage("M_LISTS_ELEMENT_DETAILS_WIDGET_TITLE"),textColor:s.colors.base1,type:"dialog"},backgroundColor:s.colors.bgSecondary,backdrop:{mediumPositionPercent:90,onlyMediumPosition:true,swipeAllowed:true,swipeContentAllowed:true,horizontalSwipeAllowed:false,hideNavigationBar:false,navigationBarColor:s.colors.bgSecondary},onReady:t=>{t.showComponent(new g({layout:t,elementId:e.elementId||0,isEmbedded:e.isEmbedded||false,isNeedShowSkeleton:e.isNeedShowSkeleton!==false,uid:e.uid||null,interceptExit:e.interceptExit!==false}))}})}constructor(e){super(e);this.state={iBlockName:null,elementName:null,iBlockDescription:null,editorConfig:null,hasBPParametersOnStartUp:false,signedBpDocument:null,perms:{canEdit:false,canRead:false}};this.elementId=e.elementId||-1;this.isLoaded=false;this.isClosing=false;this.isChanged=false;this.editorRef=null;this.isReRenderEditor=false;this.scrollViewRef=null;this.scrollY=0;this.uid=e.uid||Random.getString();this.customEventEmitter=r.createWithUid(this.uid);this.isEmbedded=e.isEmbedded||false;this.isNeedShowSkeleton=e.isNeedShowSkeleton!==false;this.interceptExit=e.interceptExit!==false;this.handleChangeFields=this.handleChangeFields.bind(this);this.handleExit=this.handleExit.bind(this);this.handleScrollToInvalidField=this.handleScrollToInvalidField.bind(this);this.handleScrollToFocusedField=this.handleScrollToFocusedField.bind(this)}get layout(){return this.props.layout}componentDidMount(){super.componentDidMount();this.customEventEmitter.on("UI.EntityEditor.Field::onChangeState",this.handleChangeFields);if(!this.isEmbedded){this.customEventEmitter.on("UI.EntityEditor::onScrollToInvalidField",this.handleScrollToInvalidField).on("UI.EntityEditor::onScrollToFocusedField",this.handleScrollToFocusedField)}if(this.interceptExit){this.layout.preventBottomSheetDismiss(true);this.layout.on("preventDismiss",this.handleExit)}this.loadDetails()}componentWillUnmount(){super.componentWillUnmount();this.customEventEmitter.off("UI.EntityEditor.Field::onChangeState",this.handleChangeFields);if(!this.isEmbedded){this.customEventEmitter.off("UI.EntityEditor::onScrollToInvalidField",this.handleScrollToInvalidField).off("UI.EntityEditor::onScrollToFocusedField",this.handleScrollToFocusedField)}if(this.interceptExit){this.layout.preventBottomSheetDismiss(false);this.layout.off("preventDismiss",this.handleExit)}}loadDetails(){if(this.isLoading===true||this.isLoaded===true){return}this.isLoading=true;BX.ajax.runAction("listsmobile.ElementDetails.load",{data:{elementId:this.elementId}}).then((({data:e})=>{this.isLoaded=true;this.setState({iBlockName:String(e.iBlockName).trim(),elementName:String(e.elementName).trim(),iBlockDescription:String(e.iBlockDescription).trim(),editorConfig:e.editor,hasBPParametersOnStartUp:e.hasBPParametersOnStartUp,signedBpDocument:e.signedBpDocument,perms:Object.assign(this.state.perms,e.perms)});this.layout.setTitle({text:this.state.iBlockName||o.getMessage("M_LISTS_ELEMENT_DETAILS_WIDGET_TITLE"),type:"dialog"})})).catch((e=>{this.isLoaded=true;console.error(e.errors);if(Array.isArray(e.errors)){l.showErrors(e.errors)}})).finally((()=>{this.isLoading=false;this.customEventEmitter.emit("Lists.ElementDetails:OnAfterLoadContent")}))}handleChangeFields(){if(this.isChanged===false){this.isChanged=true;this.layout.setRightButtons([{name:o.getMessage("M_LISTS_ELEMENT_DETAILS_SAVE_BTN"),type:"text",color:s.colors.accentMainLinks,callback:this.save.bind(this)}]);this.customEventEmitter.emit("Lists.ElementDetails:onChange",[this.isChanged])}}save(){this.layout.setRightButtons([{name:o.getMessage("M_LISTS_ELEMENT_DETAILS_SAVING_BTN"),type:"text",color:s.colors.accentSoftBlue1}]);l.showLoadingIndicator().then((()=>c.blurFocusedFieldIfHas())).then((()=>this.validate())).then((()=>this.getData())).then((e=>this.addBpData(e))).then((e=>this.startSaveElement(e))).then((e=>{this.isReRenderEditor=!this.isReRenderEditor;this.setState({editorConfig:e.data.editor,elementName:e.data.elementName});this.isChanged=false;this.layout.setRightButtons([]);l.hideLoadingIndicator(true);this.customEventEmitter.emit("Lists.ElementDetails:onChange",[this.isChanged])})).catch((e=>{console.error(e);l.hideLoadingIndicator(false);if(Array.isArray(e)){l.showErrors(e)}this.isChanged=false;this.handleChangeFields()}))}validate(){return this.editorRef.validate()?Promise.resolve():Promise.reject()}getData(){return new Promise(((e,t)=>{this.editorRef.getValuesToSave().then((t=>e(t))).catch((e=>t(e)))}))}addBpData(e){return new Promise(((t,i)=>{if(this.state.hasBPParametersOnStartUp===false||this.state.signedBpDocument===null){t(e);return}void requireLazy("bizproc:workflow/required-parameters",false).then((({WorkflowRequiredParameters:e})=>e.open({signedDocument:this.state.signedBpDocument},this.props.layout))).then((({data:i})=>t(Object.assign(e,i)))).catch((e=>i(e)))}))}startSaveElement(e){return new Promise(((t,i)=>{BX.ajax.runAction("listsmobile.ElementDetails.save",{data:{elementId:this.elementId,fields:e}}).then((e=>t(e))).catch((e=>i(e.errors)))}))}handleExit(){let e=Promise.resolve();if(this.isClosing){return e}if(this.isChanged){e=e.then((()=>new Promise((e=>{this.showConfirmExit((()=>{e()}))}))))}return e.then((()=>{this.isClosing=true;this.layout.close()}))}showConfirmExit(e){a.impactLight();d.confirm(o.getMessage("M_LISTS_ELEMENT_DETAILS_CONFIRM_EXIT_TITLE"),o.getMessage("M_LISTS_ELEMENT_DETAILS_CONFIRM_EXIT_DESCRIPTION"),[{text:o.getMessage("M_LISTS_ELEMENT_DETAILS_CONFIRM_EXIT_EXIT"),type:"destructive",onPress:e},{text:o.getMessage("M_LISTS_ELEMENT_DETAILS_CONFIRM_EXIT_CONTINUE"),type:"cancel"}])}handleScrollToInvalidField(e){if(this.scrollViewRef&&e){const t=this.scrollViewRef.getPosition(e);t.y-=50;this.scrollViewRef.scrollTo({...t,animated:true})}}handleScrollToFocusedField(e){if(this.scrollViewRef&&e){const{y:t}=this.scrollViewRef.getPosition(e);if(t>this.scrollY+device.screen.height*.4){const e=t-150;this.scrollViewRef.scrollTo({y:e,animated:true})}}}render(){if(this.isEmbedded){return this.renderContent()}const e=this.isLoaded||!this.isLoaded&&this.isNeedShowSkeleton;return View({style:{flex:1,backgroundColor:s.colors.bgContentPrimary},resizableByKeyboard:true,safeArea:{bottom:true}},ScrollView({style:{flex:1},ref:e=>{this.scrollViewRef=e},onScroll:e=>{this.scrollY=e.contentOffset.y}},View({onClick:()=>c.blurFocusedFieldIfHas()},View({style:{backgroundColor:s.colors.bgContentPrimary,paddingHorizontal:e?6:0,paddingVertical:e?12:0}},this.renderContent()))))}renderContent(){return View({},View({style:{paddingHorizontal:10,borderRadius:12,backgroundColor:s.colors.bgContentPrimary}},this.renderName(),this.renderDescription()),this.renderEditor())}renderName(){if(!this.isLoaded&&this.isNeedShowSkeleton){return View({},E(159,10,10,7,12),E(196,10,12,12,12))}if(this.isLoaded&&this.state.elementName){return Text({testId:"LISTS_DETAILS_ELEMENT_NAME",style:{fontWeight:"600",fontSize:18,lineHeightMultiple:1.22,color:s.colors.base1,marginBottom:12},text:this.state.elementName})}return null}renderDescription(){if(!this.isLoaded&&this.isNeedShowSkeleton){return View({},E(307,4,15,8,12),E(278,4,11,8,12),E(307,4,11,9,12),E(175,4,11,11,12))}if(this.isLoaded&&this.state.iBlockDescription){const e=new m({bbCodeMode:true,testId:"WORKFLOW_DETAILS_DESCRIPTION",value:this.state.iBlockDescription,style:{fontWeight:"400",fontSize:14,lineHeightMultiple:1.28,color:s.colors.base2,marginBottom:12},containerStyle:{flexGrow:0},onLinkClick:({url:e})=>{n.open(e)}});if(e&&!this.canRenderEditor()){e.toggleExpand()}return e}return null}renderEditor(){if(!this.isLoaded){return this.isNeedShowSkeleton?this.renderEditorSkeleton():null}if(!this.state.perms.canRead){return this.renderTextBlockStub(o.getMessage("M_LISTS_ELEMENT_DETAILS_CANT_READ_ELEMENT"))}if(this.canRenderEditor()){if(this.isReRenderEditor){return View({},this.createEditor())}return this.createEditor()}return null}canRenderEditor(){return Boolean(this.isLoaded&&this.state.perms.canRead&&this.state.editorConfig)}renderEditorSkeleton(){return View({style:{marginTop:20,marginBottom:2,padding:11,borderRadius:12,borderWidth:1,borderColor:s.colors.bgSeparatorPrimary,backgroundColor:s.colors.bgContentSecondary}},E(70,4,11,2,12),E(140,8,14,15,12),View({style:{height:1,backgroundColor:s.colors.bgSeparatorPrimary}}),E(40,4,15,1,12),E(210,8,13,18,12))}renderTextBlockStub(e){return View({style:{borderWidth:1,borderColor:s.colors.bgSeparatorPrimary,borderRadius:12,marginVertical:12}},Text({style:{color:s.colors.base5,fontSize:14,fontWeight:"400",marginHorizontal:24,marginVertical:16,textAlign:"center"},text:e}))}createEditor(){return u.create({uid:this.uid,layout:this.layout,editorProps:this.state.editorConfig,isEmbedded:true,refCallback:e=>{this.editorRef=e},showBottomPadding:!this.isEmbedded})}}i.exports={ElementDetails:g}}));
//# sourceMappingURL=extension.map.js