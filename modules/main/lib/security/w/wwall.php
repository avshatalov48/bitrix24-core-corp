<? namespace Bitrix\Main\Security\W;$GLOBALS['____632469025']= array(base64_decode('d'.'Gl'.'tZQ=='),base64_decode('d'.'GltZQ=='),base64_decode('an'.'Nvbl'.'9kZ'.'WNvZG'.'U='),base64_decode('YXJyYXl'.'fbWVy'.'Z'.'2'.'U='),base64_decode('am9'.'pbg=='),base64_decode('a'.'m'.'9p'.'bg=='),base64_decode('a'.'m9pbg=='),base64_decode('Y'.'XJ'.'y'.'YXlfcG9w'),base64_decode('YXJyYXlfc2hpZnQ='),base64_decode('YXJyY'.'Xlfc2hpZnQ='),base64_decode('YXJyYXlfc2'.'hpZnQ='),base64_decode('Y'.'X'.'Jy'.'YXl'.'fc2h'.'pZnQ='),base64_decode('YXJ'.'yYXlf'.'bWVyZ2U='),base64_decode('aXNfYXJyYXk='),base64_decode('YXJy'.'YXlfbWVyZ2U'.'='),base64_decode(''.'aW'.'5'.'fYXJyY'.'X'.'k='),base64_decode('aW5'.'fY'.'XJyYXk'.'='),base64_decode('aW5'.'fYXJyYXk='),base64_decode('a'.'W5fY'.'XJyY'.'Xk='),base64_decode('aW'.'5f'.'YXJyYXk='),base64_decode('dGltZQ=='),base64_decode('dG'.'ltZQ=='),base64_decode('Y'.'XJyYX'.'lfbWF'.'w'),base64_decode('Z2V0X'.'2xvYWRlZF'.'9'.'leH'.'Rlbn'.'Npb25z'),base64_decode('a'.'nNv'.'bl9lbm'.'NvZGU'.'='),base64_decode('anNvb'.'l9lbmNvZG'.'U='),base64_decode('cGhw'.'dm'.'Vyc2lvb'.'g=='),base64_decode('anNv'.'bl9'.'lbmNvZGU='),base64_decode(''.'am9pbg=='));if(!function_exists(__NAMESPACE__.'\\___207977888')){function ___207977888($_1660509202){static $_1189597908= false; if($_1189597908 == false) $_1189597908=array('V'.'1dBTEx'.'fT'.'E9DSw==','c2V'.'jdX'.'Jpd'.'Hk'.'=','REF'.'UQQ='.'=','e'.'y'.'I=','V1'.'dBTExfT'.'E9DSw'.'==','c2'.'Vj'.'d'.'XJpdH'.'k=',''.'U0VDVVJ'.'J'.'VFl'.'fV1dBTE'.'xf'.'R'.'VhDRV'.'B'.'USU9O','RkF'.'J'.'TF9D'.'SEVDS0lORw==',''.'Q'.'2FuIG5vdCBleG'.'V'.'jdXRlIHd3YW'.'xsIHJ1bGVzOiA=','IFR'.'yYWNlOiA=','U'.'kV'.'RV'.'UVTVF9VUkk=','a2'.'V'.'5c'.'w'.'==','dmFsdW'.'V'.'z','U0VDVVJJVFlfV'.'1'.'dBTExf'.'T'.'U9ESUZZ','Lg='.'=','U'.'0VDVV'.'J'.'JV'.'FlfV'.'1dBTE'.'xf'.'VU5TRVQ=','Lg==','U0VDVVJJVF'.'lf'.'V'.'1d'.'BTE'.'x'.'fRVhJV'.'A'.'==','Lg==',''.'Z2xvYmFs','a2'.'V5cw==',''.'d'.'mFs'.'dWVz','Z'.'2'.'V0',''.'Z'.'2V0','cG'.'9'.'z'.'dA'.'==','c'.'G9zdA='.'=','Y29'.'va2ll','Y29v'.'a2l'.'l','cmVxd'.'WVzdA==','cmV'.'xdWVzdA==',''.'Z2xvY'.'mFs','Z2xv'.'Ym'.'Fs','bWFpbl9zZ'.'WM=','V1dB'.'TEx'.'f'.'QUNUVU'.'FM'.'SVpFX1J'.'V'.'TE'.'VT','d'.'g==','dmV'.'yc2lv'.'bg==','a'.'Q==','aXNJ'.'bnN0Y'.'WxsZ'.'WQ=',''.'dg==','aW5p','bW9'.'k'.'dWxlcw==','bGlj'.'ZW'.'5'.'zZQ='.'=',''.'cGhw','dg='.'=','ZXh'.'0','c2Vjd'.'XJp'.'dHk=','ZGI=',''.'d'.'HlwZQ'.'==','ZGI'.'=','dmVyc'.'2lvb'.'g==',''.'Z'.'GI=','dHlwZQ==','ZG'.'I=','d'.'H'.'lwZQ==','dmVy'.'c2lvb'.'g==','ZGI=','dm'.'Vyc2lvbg==','ZW52a'.'X'.'Jvbm1lbnQ=','d'.'m1fd'.'mVyc2'.'lv'.'bg==','d'.'m0=','dg==','ZW'.'52a'.'X'.'Jvbm1lbn'.'Q'.'=',''.'d'.'m1fdmVyc2lvbg==','c29ja2V0VGl'.'t'.'ZW9'.'1d'.'A==','c3RyZ'.'WFtVG'.'lt'.'ZW91dA==',''.'KCc'.'=',''.'ZGF0'.'Y'.'Q==','J'.'yw'.'g'.'J'.'w==','b'.'W9kdW'.'xl','JywgJw==','bW9'.'kdW'.'xlX3Z'.'l'.'cnN'.'pb'.'24=',''.'Jyk=','LCA=','U0VDVVJJVF'.'lfV'.'1dBT'.'E'.'x'.'fR'.'V'.'h'.'DRVBUSU9O','b'.'WFpb'.'g==','R'.'kFJTF9SRUZS'.'RVN'.'ISU5H','Q2FuIG'.'5'.'vdCB'.'yZWZyZXN'.'oIHd3Y'.'WxsIHJ1b'.'GVzOi'.'A=','IFRy'.'YWN'.'lOi'.'A'.'=','Z'.'GF'.'0YQ==','eyI'.'=','LS0tLS1C'.'RUdJ'.'TiB'.'Q'.'V'.'UJM'.'SUMgS0V'.'ZLS0tLS0=','Ck1JSUJ'.'JakFOQmdr'.'c'.'W'.'hraUc'.'5dzB'.'CQ'.'VF'.'FRkFBT0NBUTh'.'BT'.'UlJQkN'.'n'.'S'.'0N'.'BUUVBcThRR'.'T'.'BIam1I'.'Sl'.'VTd'.'F'.'dW'.'Nm4wemEKUlZvTHg'.'wM'.'kt6'.'YmZyYlMvUDZzV2F4VHp3OFNlR1R0Yl'.'RD'.'T3J'.'w'.'SGk1U'.'UY2T1J'.'5alovWHh6L0'.'tMVTFHYm'.'9mOUNaMwo0e'.'jdTa3FVdDY2a'.'WJYdk9G'.'Qng'.'0Zncv'.'QVB'.'QUkdEcXRtM'.'G5EM2Z'.'nR'.'3N1M'.'1JlUG'.'d3Mjlp'.'O'.'Ct2b'.'Tdtd'.'EJLSlVZ'.'b'.'DRyCl'.'ZwYjZz'.'Zlp'.'FVDlLRWI2'.'VDF'.'I'.'RFltR'.'X'.'Z'.'jMWhxL2lpd'.'Xl'.'4THJa'.'W'.'mk1U'.'T'.'ZVZm'.'Y'.'0VUV2VEkrNjhzc0ZS'.'a1Erb3dUUnkKZU9JTWJ'.'Ga'.'E0vV'.'VR'.'t'.'ZlZZYlRSRnk'.'yb1'.'VROFdNem'.'Eyb'.'ko'.'1U2FoemkxV'.'Ut'.'PMWpB'.'al'.'h'.'UUF'.'JyemM3'.'QWp1'.'N'.'j'.'M5'.'ajFPMApwcHFmb'.'TV4Z1dsRkFKa0hR'.'VG'.'diZ'.'G'.'Q'.'1QVdxREZRa3'.'Q5SE'.'trW'.'St'.'U'.'bmZCTEd'.'WTXZW'.'eV'.'B3V'.'EhOV1FZQXc0eHBnL3dBCl'.'p3S'.'UR'.'B'.'UUFC'.'C'.'i0tLS'.'0tRU'.'5EIFBVQkxJQyBLRVktLS0'.'tLQ'.'==');return base64_decode($_1189597908[$_1660509202]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_309873449= 'https://wwall.bitrix.info/rules.php'; protected $_20573735= true; public function handle(){ try{  $_1512370697= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1512370697)){ return;}  $_372939061= Cache::createInstance(); $_694086308= false; if($_372939061->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_54425475= $_372939061->getVars(); if($GLOBALS['____632469025'][0]()- $_54425475> round(0+10+10)){  $_647639980= Application::getConnection(); $_697858414= RuleRecordTable::getTableName(); $_647639980->truncateTable($_697858414); RuleRecordTable::cleanCache(); $_372939061->clean(___207977888(0), ___207977888(1));}} elseif($_372939061->startDataCache()){  $_372939061->endDataCache($GLOBALS['____632469025'][1]()); $_694086308= true;} foreach($_1512370697 as $_1982256729){ $_529527006= new PublicKeyCipher; $_1228805160= $_529527006->decrypt($_1982256729[___207977888(2)], static::__1336234861()); if(!str_starts_with($_1228805160, ___207977888(3))){ continue;} $_514241557= $GLOBALS['____632469025'][2]($_1228805160, true); if(!empty($_514241557)){ $_1885879945= Rule::make($_514241557); $_1649778192= $this->handleRule($_1885879945); $this->applyHandlingResults($_1649778192);}}  if($_694086308){ $_372939061->clean(___207977888(4), ___207977888(5));}} catch(\Throwable $_1622118411){ $this->logEvent( ___207977888(6), ___207977888(7), ___207977888(8). $_1622118411->getMessage(). ___207977888(9). $_1622118411->getTraceAsString());}}  public function handleRule(Rule $_1885879945): array{ $_1649778192=[]; if($_1885879945->matchPath($_SERVER[___207977888(10)])){  $_522548539= $this->getContextElements($_1885879945->getContext()); foreach($_522548539 as $_1733168455 => &$_1011126711){ $_1649778192= $GLOBALS['____632469025'][3]($_1649778192, $this->recursiveContextKeyHandle($_1733168455, $_1011126711,[], $_1885879945));}} return $_1649778192;}  public function applyHandlingResults(array $_1649778192){ $_522548539= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1649778192 as $_690632853){ $_1011126711=& $_522548539[$_690632853->getContextName()]; $_415031526= $_690632853->getRuleResult(); $_1885879945= $_690632853->getRule(); if($_415031526 instanceof ModifyResult){ if($_1885879945->getProcess() === ___207977888(11)){  static::rewriteContextKey( $_690632853->getContextName(), $_1011126711, $_690632853->getContextKey(), $_415031526->getCleanValue());} elseif($_1885879945->getProcess() === ___207977888(12)){ static::rewriteContextValue( $_690632853->getContextName(), $_1011126711, $_690632853->getContextKey(), $_415031526->getCleanValue());} $this->logEvent( ___207977888(13), $_690632853->getContextName(), $GLOBALS['____632469025'][4](___207977888(14), $_690632853->getContextKey()));} elseif($_415031526 instanceof CheckResult &&!$_415031526->isSuccess()){ if($_415031526->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_690632853->getContextName(), $_1011126711, $_690632853->getContextKey(),); $this->logEvent( ___207977888(15), $_690632853->getContextName(), $GLOBALS['____632469025'][5](___207977888(16), $_690632853->getContextKey()));} elseif($_415031526->getAction() === RuleAction::EXIT){ $this->logEvent( ___207977888(17), $_690632853->getContextName(), $GLOBALS['____632469025'][6](___207977888(18), $_690632853->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_20573735= false;} protected function rewriteContextKey($_1733168455, &$_1011126711, $_1717548717, $_1274494115){ $_1803910524= $_1717548717;  $GLOBALS['____632469025'][7]($_1803910524); $_1803910524[]= $_1274494115; if($_1733168455 === ___207977888(19)){ $_1292239884= $GLOBALS['____632469025'][8]($_1717548717); $GLOBALS['____632469025'][9]($_1803910524); if(empty($_1717548717)){ $GLOBALS[$_1274494115]= $GLOBALS[$_1292239884]; unset($GLOBALS[$_1292239884]);} else{ $_1011126711=& $GLOBALS[$_1292239884]; $_1190552747= ArrayHelper::getByNestedKey($_1011126711, $_1717548717);  ArrayHelper::setByNestedKey($_1011126711, $_1803910524, $_1190552747);  ArrayHelper::unsetByNestedKey($_1011126711, $_1717548717);}} else{ $_1190552747= ArrayHelper::getByNestedKey($_1011126711, $_1717548717);  ArrayHelper::setByNestedKey($_1011126711, $_1803910524, $_1190552747);  ArrayHelper::unsetByNestedKey($_1011126711, $_1717548717);}} protected function rewriteContextValue($_1733168455, &$_1011126711, $_158075437, $_1190552747){ if($_1733168455 === 'global'){ $_1292239884= $GLOBALS['____632469025'][10]($_158075437); if(empty($_158075437)){ $GLOBALS[$_1292239884]= $_1190552747;} else{ $_1011126711=& $GLOBALS[$_1292239884]; ArrayHelper::setByNestedKey($_1011126711, $_158075437, $_1190552747);}} else{  ArrayHelper::setByNestedKey($_1011126711, $_158075437, $_1190552747);}} protected function unsetContextValue($_1733168455, &$_1011126711, $_158075437){ if($_1733168455 === 'global'){ $_1292239884= $GLOBALS['____632469025'][11]($_158075437); if(empty($_158075437)){ unset($GLOBALS[$_1292239884]);} else{ $_1011126711=& $GLOBALS[$_1292239884]; ArrayHelper::unsetByNestedKey($_1011126711, $_158075437);}} else{ ArrayHelper::unsetByNestedKey($_1011126711, $_158075437);}}  protected function recursiveContextKeyHandle(string $_1733168455, array &$_1011126711, array $_2132722885, Rule $_1885879945): array{  $_1649778192=[]; foreach($_1011126711 as $_14852615 => $_1190552747){ $_158075437= $GLOBALS['____632469025'][12]($_2132722885,[$_14852615]); if($_1885879945->matchKey($_158075437)){  if($_1885879945->getProcess() === ___207977888(20)){ $_415031526= $_1885879945->evaluate($_14852615);} elseif($_1885879945->getProcess() === ___207977888(21)){ $_415031526= $_1885879945->evaluateValue($_1190552747);}  if(!empty($_415031526) && $_415031526 instanceof RuleResult){ $_1649778192[]= new HandlingResult($_1733168455, $_158075437, $_415031526, $_1885879945);}}  if($GLOBALS['____632469025'][13]($_1190552747)){ $_1649778192= $GLOBALS['____632469025'][14]($_1649778192, $this->recursiveContextKeyHandle( $_1733168455, $_1011126711[$_14852615], $_158075437, $_1885879945));}} return $_1649778192;} protected function getContextElements(array $_1243854534){ $_1454772089=[]; if($GLOBALS['____632469025'][15](___207977888(22), $_1243854534, true)){ $_1454772089[___207977888(23)]= &$_GET;} if($GLOBALS['____632469025'][16](___207977888(24), $_1243854534, true)){ $_1454772089[___207977888(25)]= &$_POST;} if($GLOBALS['____632469025'][17](___207977888(26), $_1243854534, true)){ $_1454772089[___207977888(27)]= &$_COOKIE;} if($GLOBALS['____632469025'][18](___207977888(28), $_1243854534, true)){ $_1454772089[___207977888(29)]= &$_REQUEST;} if($GLOBALS['____632469025'][19](___207977888(30), $_1243854534, true)){ $_1454772089[___207977888(31)]= $GLOBALS;} return $_1454772089;} public static function refreshRules(){ try{ $_1199897901= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____632469025'][20]()- $_1199897901)< static::CACHE_RULES_TTL){ return;} Option::set(___207977888(32), ___207977888(33), $GLOBALS['____632469025'][21]()); $_330575767= null;  $_628920010= $GLOBALS['____632469025'][22](function($_59349304){ return[___207977888(34) => $_59349304[___207977888(35)], ___207977888(36) => (int) $_59349304[___207977888(37)]];}, ModuleManager::getModulesFromDisk());  $_131716377=[]; foreach($GLOBALS['____632469025'][23]() as $_1333664721){ $_1967428454= new ReflectionExtension($_1333664721); $_131716377[$_1333664721]=[ ___207977888(38) => $_1967428454->getVersion(), ___207977888(39) => $_1967428454->getINIEntries()];} $_102386600=[ ___207977888(40) => $GLOBALS['____632469025'][24]($_628920010), ___207977888(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___207977888(42) => $GLOBALS['____632469025'][25]([ ___207977888(43) => $GLOBALS['____632469025'][26](), ___207977888(44) => $_131716377])]; if(Loader::includeModule(___207977888(45))){ $_1197089432= CSecuritySystemInformation::getSystemInformation(); if(isset($_1197089432[___207977888(46)][___207977888(47)]) && isset($_1197089432[___207977888(48)][___207977888(49)])){ $_102386600[___207977888(50)]=[ ___207977888(51) => $_1197089432[___207977888(52)][___207977888(53)], ___207977888(54) => $_1197089432[___207977888(55)][___207977888(56)]];} if(isset($_1197089432[___207977888(57)][___207977888(58)])){ $_102386600[___207977888(59)]=[___207977888(60) => $_1197089432[___207977888(61)][___207977888(62)]];}}  $_717283132= new HttpClient([ ___207977888(63) => round(0+1.25+1.25+1.25+1.25), ___207977888(64) => round(0+5)]); $_759675787= $_717283132->post( static::$_309873449, $_102386600); if($_717283132->getStatus() == round(0+200) &&!empty($_759675787)){ $_330575767= Json::decode($_759675787);}  if($_330575767 !== null){ $_647639980= Application::getConnection(); $_697858414= RuleRecordTable::getTableName(); if(!empty($_330575767)){ foreach($_330575767 as $_1366001572){ if(!static::checkRuleSign($_1366001572)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____632469025'][27]($_1366001572));}}}  $_647639980->truncateTable($_697858414);  if(!empty($_330575767)){ $_425052898=[]; foreach($_330575767 as $_1366001572){ $_425052898[]= ___207977888(65). $_647639980->getSqlHelper()->forSql($_1366001572[___207977888(66)]). ___207977888(67). $_647639980->getSqlHelper()->forSql($_1366001572[___207977888(68)]). ___207977888(69). $_647639980->getSqlHelper()->forSql($_1366001572[___207977888(70)]). ___207977888(71);} $_457520741= $GLOBALS['____632469025'][28](___207977888(72), $_425052898);  $_647639980->query("INSERT INTO {$_697858414} (DATA, MODULE, MODULE_VERSION) VALUES {$_457520741}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1622118411){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___207977888(73), ___207977888(74), ___207977888(75), ___207977888(76). $_1622118411->getMessage(). ___207977888(77). $_1622118411->getTraceAsString());}} protected static function checkRuleSign($_1885879945){ $_529527006= new PublicKeyCipher; $_514241557= $_529527006->decrypt($_1885879945[___207977888(78)], static::__1336234861()); return str_starts_with($_514241557, ___207977888(79));} private static function __1336234861(){ $_953137401= ''; $_953137401 .= ___207977888(80); $_953137401 .= ___207977888(81); return $_953137401;} protected function logEvent($_1506584416, $_2019549704, $_1567150099){ if($this->_20573735){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1506584416, 'main', $_2019549704, $_1567150099);}}}?>