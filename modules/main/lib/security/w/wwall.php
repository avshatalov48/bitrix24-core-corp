<? namespace Bitrix\Main\Security\W;$GLOBALS['____906454317']= array(base64_decode('dGl'.'tZ'.'Q=='),base64_decode('dG'.'lt'.'ZQ=='),base64_decode('an'.'Nvbl9'.'kZWN'.'vZGU='),base64_decode('YXJyYXlfb'.'WVyZ2U='),base64_decode('am9pbg=='),base64_decode('a'.'m9pbg=='),base64_decode('am'.'9pbg=='),base64_decode(''.'Y'.'XJyYX'.'l'.'f'.'cG9'.'w'),base64_decode(''.'YXJy'.'Y'.'Xlfc2h'.'p'.'ZnQ'.'='),base64_decode('YX'.'Jy'.'Y'.'Xlfc2h'.'p'.'Z'.'n'.'Q='),base64_decode('Y'.'X'.'JyYX'.'lfc'.'2hp'.'ZnQ='),base64_decode('Y'.'XJyYXlfc2hp'.'Zn'.'Q='),base64_decode(''.'YXJyYXlfbWVyZ2U='),base64_decode('a'.'XNfYXJyYXk'.'='),base64_decode(''.'YXJy'.'YXlfbWVyZ2U'.'='),base64_decode(''.'a'.'W5f'.'YXJyYX'.'k='),base64_decode('aW5fYXJyYXk'.'='),base64_decode('aW5fYXJyYXk'.'='),base64_decode('aW5fYXJyYXk='),base64_decode('a'.'W5fYXJyY'.'Xk='),base64_decode('dGltZQ=='),base64_decode('dGltZQ'.'=='),base64_decode('YXJy'.'YX'.'lfb'.'WFw'),base64_decode('Z2V0X2'.'xv'.'YWRlZ'.'F9leHRlbn'.'Np'.'b25z'),base64_decode('anNvbl9lb'.'mNvZG'.'U='),base64_decode('an'.'Nv'.'b'.'l'.'9lbmNvZ'.'GU'.'='),base64_decode('cG'.'h'.'wdmVyc2'.'lvbg=='),base64_decode('anN'.'v'.'b'.'l9lbmNvZ'.'G'.'U='),base64_decode('am9p'.'bg=='));if(!function_exists(__NAMESPACE__.'\\___976149028')){function ___976149028($_9201870){static $_1225113186= false; if($_1225113186 == false) $_1225113186=array('V1dBTExfTE9'.'DS'.'w==','c2V'.'j'.'dX'.'Jpd'.'Hk=','REFUQ'.'Q==','eyI=','V'.'1d'.'BT'.'ExfTE9DSw==',''.'c2V'.'jdXJp'.'dHk=','U0'.'VDVVJJVFl'.'fV1d'.'BT'.'ExfRVhDRVBUSU'.'9O',''.'Rk'.'F'.'JTF9D'.'SEVDS0lORw==','Q2'.'FuI'.'G5'.'vdCBl'.'eGVj'.'d'.'XRlI'.'Hd3YWx'.'sIHJ1bGVzOiA=',''.'IF'.'RyYWNlOi'.'A=','U'.'kVRVUVTV'.'F9V'.'Ukk=','a'.'2'.'V5cw==','dmFs'.'dWVz','U0VDVVJJ'.'VFl'.'f'.'V1dBTE'.'xfT'.'U'.'9E'.'SUZZ',''.'Lg==','U0VDVVJJ'.'VFlfV1dBTEx'.'fVU'.'5T'.'RVQ=','Lg==',''.'U0VDVVJJVF'.'lf'.'V'.'1dB'.'TExfRV'.'hJVA==','Lg==',''.'Z'.'2xvYmFs','a2V5cw==','d'.'mF'.'sdWVz',''.'Z'.'2'.'V0','Z2V0',''.'c'.'G9zdA==','cG'.'9zdA==',''.'Y2'.'9'.'v'.'a2ll','Y2'.'9v'.'a'.'2ll','cm'.'VxdW'.'Vzd'.'A==','cm'.'Vx'.'d'.'WV'.'zdA==','Z2xvYmF'.'s','Z2xvYmFs','bWF'.'pbl'.'9zZ'.'WM=',''.'V'.'1dBTE'.'x'.'f'.'Q'.'UNUVUF'.'MSVpFX1'.'JVT'.'EV'.'T',''.'dg==',''.'d'.'mVyc2lv'.'bg='.'=','aQ'.'==','aXNJbnN'.'0YW'.'xsZ'.'W'.'Q=','d'.'g==','a'.'W5p','bW9k'.'dWxlcw==','bGljZ'.'W5'.'zZQ==',''.'c'.'Ghw','dg'.'==','ZXh'.'0','c2Vjd'.'XJ'.'pdHk=',''.'ZGI=','d'.'HlwZQ'.'==','ZGI=','dmVyc2lv'.'bg==',''.'ZGI=','dHlwZ'.'Q==',''.'ZGI=','dHlwZQ==','dmVy'.'c'.'2lvbg==','ZGI'.'=','dmVy'.'c'.'2lvbg==',''.'ZW'.'52aXJvbm1lb'.'nQ=','dm1fdmVyc2'.'l'.'vb'.'g==','dm0=','dg==','ZW5'.'2aXJvbm1'.'lbnQ'.'=','dm1fd'.'mV'.'yc2l'.'vb'.'g==',''.'c29j'.'a2V'.'0VGltZW91d'.'A==','c3R'.'yZW'.'FtVG'.'ltZW'.'91'.'dA='.'=','K'.'C'.'c'.'=','ZGF0YQ==',''.'JywgJw'.'==','bW9k'.'dWxl','JywgJw='.'=','bW9'.'kdWxlX3ZlcnNpb'.'24'.'=','Jy'.'k'.'=',''.'LCA=','U0VDVVJJ'.'VFl'.'f'.'V1dBTExfRVh'.'DRVBU'.'SU9'.'O','bWFpb'.'g==','RkFJ'.'TF9'.'S'.'RUZSR'.'VNISU5H','Q2F'.'u'.'IG5vdCByZWZyZX'.'N'.'oIHd3YWxs'.'IH'.'J1'.'bGVzOiA=','I'.'F'.'RyYWNlOi'.'A=','ZGF0YQ'.'='.'=','eyI'.'=','L'.'S0'.'tLS'.'1'.'CR'.'U'.'dJTi'.'BQVU'.'JMSUM'.'gS0VZLS'.'0tLS0=',''.'Ck1JSUJ'.'JakFOQmdr'.'c'.'Wh'.'raU'.'c5d'.'z'.'BCQVF'.'FR'.'kFBT0N'.'BU'.'Th'.'BTU'.'lJ'.'QkNnS0NBU'.'UVBcThRRTB'.'Iam1ISlVTdFdWNm4wemEKUlZ'.'vTHgwMkt6'.'YmZyYlMvUDZzV2F4V'.'Hp3OFNlR1R0'.'Y'.'lRD'.'T3JwSGk1UUY'.'2T1J5alov'.'W'.'Hh'.'6L0tMVTF'.'HY'.'m9'.'mOUNa'.'Mwo0e'.'j'.'d'.'Ta3'.'FVdDY'.'2aW'.'JYdk9'.'G'.'Qng0ZncvQV'.'BQUkdEcXRt'.'MG5EM2Zn'.'R3N1M1Jl'.'U'.'Gd3M'.'jlpOCt2b'.'Td'.'tdEJLSlVZb'.'DRyClZwYjZz'.'ZlpFVDlLR'.'WI2VDFIRFltRX'.'Z'.'jMWhxL2lp'.'d'.'Xl'.'4THJa'.'Wmk1'.'UTZ'.'VZmY0'.'VUV2V'.'E'.'krN'.'jhzc0ZSa1Erb3dUUnkKZ'.'U'.'9J'.'T'.'WJGaE0v'.'VVRtZ'.'l'.'ZZ'.'YlR'.'S'.'Rnkyb'.'1VROF'.'dNe'.'mE'.'ybko1U'.'2Fo'.'e'.'mkxVUt'.'PMWpBalhUUF'.'JyemM3QWp1NjM5ajFP'.'MAp'.'w'.'cHFm'.'bTV4Z1d'.'sR'.'kFKa0hR'.'VGd'.'iZGQ1QVdx'.'REZRa'.'3Q'.'5S'.'EtrWStUbm'.'ZC'.'T'.'Ed'.'WTXZWe'.'VB3VEhOV1FZQX'.'c0'.'eHBnL'.'3dBClp3SURB'.'U'.'UFCC'.'i0tLS0t'.'RU5E'.'IFB'.'VQ'.'k'.'xJQ'.'yB'.'L'.'RVkt'.'LS'.'0t'.'LQ'.'==');return base64_decode($_1225113186[$_9201870]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_948354621= 'https://wwall.bitrix.info/rules.php'; protected $_1731733785= true; public function handle(){ try{  $_2101209728= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_2101209728)){ return;}  $_195756227= Cache::createInstance(); $_1417454432= false; if($_195756227->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1168531944= $_195756227->getVars(); if($GLOBALS['____906454317'][0]()- $_1168531944> round(0+20)){  $_1261680740= Application::getConnection(); $_1983258561= RuleRecordTable::getTableName(); $_1261680740->truncateTable($_1983258561); RuleRecordTable::cleanCache(); $_195756227->clean(___976149028(0), ___976149028(1));}} elseif($_195756227->startDataCache()){  $_195756227->endDataCache($GLOBALS['____906454317'][1]()); $_1417454432= true;} foreach($_2101209728 as $_856460327){ $_173735753= new PublicKeyCipher; $_1576765797= $_173735753->decrypt($_856460327[___976149028(2)], static::__2078980606()); if(!str_starts_with($_1576765797, ___976149028(3))){ continue;} $_92913367= $GLOBALS['____906454317'][2]($_1576765797, true); if(!empty($_92913367)){ $_1858311964= Rule::make($_92913367); $_1470362825= $this->handleRule($_1858311964); $this->applyHandlingResults($_1470362825);}}  if($_1417454432){ $_195756227->clean(___976149028(4), ___976149028(5));}} catch(\Throwable $_1751490313){ $this->logEvent( ___976149028(6), ___976149028(7), ___976149028(8). $_1751490313->getMessage(). ___976149028(9). $_1751490313->getTraceAsString());}}  public function handleRule(Rule $_1858311964): array{ $_1470362825=[]; if($_1858311964->matchPath($_SERVER[___976149028(10)])){  $_2022887346= $this->getContextElements($_1858311964->getContext()); foreach($_2022887346 as $_835653374 => &$_1604821134){ $_1470362825= $GLOBALS['____906454317'][3]($_1470362825, $this->recursiveContextKeyHandle($_835653374, $_1604821134,[], $_1858311964));}} return $_1470362825;}  public function applyHandlingResults(array $_1470362825){ $_2022887346= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1470362825 as $_980295190){ $_1604821134=& $_2022887346[$_980295190->getContextName()]; $_735149988= $_980295190->getRuleResult(); $_1858311964= $_980295190->getRule(); if($_735149988 instanceof ModifyResult){ if($_1858311964->getProcess() === ___976149028(11)){  static::rewriteContextKey( $_980295190->getContextName(), $_1604821134, $_980295190->getContextKey(), $_735149988->getCleanValue());} elseif($_1858311964->getProcess() === ___976149028(12)){ static::rewriteContextValue( $_980295190->getContextName(), $_1604821134, $_980295190->getContextKey(), $_735149988->getCleanValue());} $this->logEvent( ___976149028(13), $_980295190->getContextName(), $GLOBALS['____906454317'][4](___976149028(14), $_980295190->getContextKey()));} elseif($_735149988 instanceof CheckResult &&!$_735149988->isSuccess()){ if($_735149988->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_980295190->getContextName(), $_1604821134, $_980295190->getContextKey(),); $this->logEvent( ___976149028(15), $_980295190->getContextName(), $GLOBALS['____906454317'][5](___976149028(16), $_980295190->getContextKey()));} elseif($_735149988->getAction() === RuleAction::EXIT){ $this->logEvent( ___976149028(17), $_980295190->getContextName(), $GLOBALS['____906454317'][6](___976149028(18), $_980295190->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1731733785= false;} protected function rewriteContextKey($_835653374, &$_1604821134, $_1352516387, $_904874187){ $_36721648= $_1352516387;  $GLOBALS['____906454317'][7]($_36721648); $_36721648[]= $_904874187; if($_835653374 === ___976149028(19)){ $_1412974450= $GLOBALS['____906454317'][8]($_1352516387); $GLOBALS['____906454317'][9]($_36721648); if(empty($_1352516387)){ $GLOBALS[$_904874187]= $GLOBALS[$_1412974450]; unset($GLOBALS[$_1412974450]);} else{ $_1604821134=& $GLOBALS[$_1412974450]; $_395697219= ArrayHelper::getByNestedKey($_1604821134, $_1352516387);  ArrayHelper::setByNestedKey($_1604821134, $_36721648, $_395697219);  ArrayHelper::unsetByNestedKey($_1604821134, $_1352516387);}} else{ $_395697219= ArrayHelper::getByNestedKey($_1604821134, $_1352516387);  ArrayHelper::setByNestedKey($_1604821134, $_36721648, $_395697219);  ArrayHelper::unsetByNestedKey($_1604821134, $_1352516387);}} protected function rewriteContextValue($_835653374, &$_1604821134, $_729122972, $_395697219){ if($_835653374 === 'global'){ $_1412974450= $GLOBALS['____906454317'][10]($_729122972); if(empty($_729122972)){ $GLOBALS[$_1412974450]= $_395697219;} else{ $_1604821134=& $GLOBALS[$_1412974450]; ArrayHelper::setByNestedKey($_1604821134, $_729122972, $_395697219);}} else{  ArrayHelper::setByNestedKey($_1604821134, $_729122972, $_395697219);}} protected function unsetContextValue($_835653374, &$_1604821134, $_729122972){ if($_835653374 === 'global'){ $_1412974450= $GLOBALS['____906454317'][11]($_729122972); if(empty($_729122972)){ unset($GLOBALS[$_1412974450]);} else{ $_1604821134=& $GLOBALS[$_1412974450]; ArrayHelper::unsetByNestedKey($_1604821134, $_729122972);}} else{ ArrayHelper::unsetByNestedKey($_1604821134, $_729122972);}}  protected function recursiveContextKeyHandle(string $_835653374, array &$_1604821134, array $_1420572536, Rule $_1858311964): array{  $_1470362825=[]; foreach($_1604821134 as $_344999449 => $_395697219){ $_729122972= $GLOBALS['____906454317'][12]($_1420572536,[$_344999449]); if($_1858311964->matchKey($_729122972)){  if($_1858311964->getProcess() === ___976149028(20)){ $_735149988= $_1858311964->evaluate($_344999449);} elseif($_1858311964->getProcess() === ___976149028(21)){ $_735149988= $_1858311964->evaluateValue($_395697219);}  if(!empty($_735149988) && $_735149988 instanceof RuleResult){ $_1470362825[]= new HandlingResult($_835653374, $_729122972, $_735149988, $_1858311964);}}  if($GLOBALS['____906454317'][13]($_395697219)){ $_1470362825= $GLOBALS['____906454317'][14]($_1470362825, $this->recursiveContextKeyHandle( $_835653374, $_1604821134[$_344999449], $_729122972, $_1858311964));}} return $_1470362825;} protected function getContextElements(array $_217930434){ $_1440848837=[]; if($GLOBALS['____906454317'][15](___976149028(22), $_217930434, true)){ $_1440848837[___976149028(23)]= &$_GET;} if($GLOBALS['____906454317'][16](___976149028(24), $_217930434, true)){ $_1440848837[___976149028(25)]= &$_POST;} if($GLOBALS['____906454317'][17](___976149028(26), $_217930434, true)){ $_1440848837[___976149028(27)]= &$_COOKIE;} if($GLOBALS['____906454317'][18](___976149028(28), $_217930434, true)){ $_1440848837[___976149028(29)]= &$_REQUEST;} if($GLOBALS['____906454317'][19](___976149028(30), $_217930434, true)){ $_1440848837[___976149028(31)]= $GLOBALS;} return $_1440848837;} public static function refreshRules(){ try{ $_342704777= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____906454317'][20]()- $_342704777)< static::CACHE_RULES_TTL){ return;} Option::set(___976149028(32), ___976149028(33), $GLOBALS['____906454317'][21]()); $_1617085281= null;  $_1761366772= $GLOBALS['____906454317'][22](function($_72053782){ return[___976149028(34) => $_72053782[___976149028(35)], ___976149028(36) => (int) $_72053782[___976149028(37)]];}, ModuleManager::getModulesFromDisk());  $_692056533=[]; foreach($GLOBALS['____906454317'][23]() as $_1338476250){ $_400318483= new ReflectionExtension($_1338476250); $_692056533[$_1338476250]=[ ___976149028(38) => $_400318483->getVersion(), ___976149028(39) => $_400318483->getINIEntries()];} $_1527848928=[ ___976149028(40) => $GLOBALS['____906454317'][24]($_1761366772), ___976149028(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___976149028(42) => $GLOBALS['____906454317'][25]([ ___976149028(43) => $GLOBALS['____906454317'][26](), ___976149028(44) => $_692056533])]; if(Loader::includeModule(___976149028(45))){ $_133736138= CSecuritySystemInformation::getSystemInformation(); if(isset($_133736138[___976149028(46)][___976149028(47)]) && isset($_133736138[___976149028(48)][___976149028(49)])){ $_1527848928[___976149028(50)]=[ ___976149028(51) => $_133736138[___976149028(52)][___976149028(53)], ___976149028(54) => $_133736138[___976149028(55)][___976149028(56)]];} if(isset($_133736138[___976149028(57)][___976149028(58)])){ $_1527848928[___976149028(59)]=[___976149028(60) => $_133736138[___976149028(61)][___976149028(62)]];}}  $_1883931976= new HttpClient([ ___976149028(63) => round(0+1.6666666666667+1.6666666666667+1.6666666666667), ___976149028(64) => round(0+1.6666666666667+1.6666666666667+1.6666666666667)]); $_149520807= $_1883931976->post( static::$_948354621, $_1527848928); if($_1883931976->getStatus() == round(0+200) &&!empty($_149520807)){ $_1617085281= Json::decode($_149520807);}  if($_1617085281 !== null){ $_1261680740= Application::getConnection(); $_1983258561= RuleRecordTable::getTableName(); if(!empty($_1617085281)){ foreach($_1617085281 as $_1883006475){ if(!static::checkRuleSign($_1883006475)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____906454317'][27]($_1883006475));}}}  $_1261680740->truncateTable($_1983258561);  if(!empty($_1617085281)){ $_1565714954=[]; foreach($_1617085281 as $_1883006475){ $_1565714954[]= ___976149028(65). $_1261680740->getSqlHelper()->forSql($_1883006475[___976149028(66)]). ___976149028(67). $_1261680740->getSqlHelper()->forSql($_1883006475[___976149028(68)]). ___976149028(69). $_1261680740->getSqlHelper()->forSql($_1883006475[___976149028(70)]). ___976149028(71);} $_1310825924= $GLOBALS['____906454317'][28](___976149028(72), $_1565714954);  $_1261680740->query("INSERT INTO {$_1983258561} (DATA, MODULE, MODULE_VERSION) VALUES {$_1310825924}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1751490313){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___976149028(73), ___976149028(74), ___976149028(75), ___976149028(76). $_1751490313->getMessage(). ___976149028(77). $_1751490313->getTraceAsString());}} protected static function checkRuleSign($_1858311964){ $_173735753= new PublicKeyCipher; $_92913367= $_173735753->decrypt($_1858311964[___976149028(78)], static::__2078980606()); return str_starts_with($_92913367, ___976149028(79));} private static function __2078980606(){ $_1919580880= ''; $_1919580880 .= ___976149028(80); $_1919580880 .= ___976149028(81); return $_1919580880;} protected function logEvent($_1236258609, $_1246355234, $_570426173){ if($this->_1731733785){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1236258609, 'main', $_1246355234, $_570426173);}}}?>