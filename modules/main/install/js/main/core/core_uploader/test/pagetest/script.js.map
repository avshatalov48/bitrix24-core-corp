{"version":3,"file":"script.js","sources":["src/index.js"],"sourcesContent":["import {Tag, Event} from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\n\nconst dataURLToBlob = function(dataURL) {\n\tvar marker = ';base64,', parts, contentType, raw, rawLength;\n\tif(dataURL.indexOf(marker) === -1) {\n\t\tparts = dataURL.split(',');\n\t\tcontentType = parts[0].split(':')[1];\n\t\traw = parts[1];\n\t\treturn new Blob([raw], {type: contentType});\n\t}\n\n\tparts = dataURL.split(marker);\n\tcontentType = parts[0].split(':')[1];\n\traw = window.atob(parts[1]);\n\trawLength = raw.length;\n\n\tvar uInt8Array = new Uint8Array(rawLength);\n\n\tfor(var i = 0; i < rawLength; ++i) {\n\t\tuInt8Array[i] = raw.charCodeAt(i);\n\t}\n\n\treturn new Blob([uInt8Array], {type: contentType});\n};\n\ndescribe('BX.Uploader', () => {\n\tconst uploaderId = 'testUploader';\n\tconst filesSource = [\n\t\tnew File(\n\t\t\t[new Blob([\"<html>bad because of type</html>\"], {type: 'text/html'})],\n\t\t\t'bad.html'\n\t\t),\n\t\tnew File(\n\t\t\t[new Blob([\"hello, world\"], {type: 'text/plain'})],\n\t\t\t'good.txt'\n\t\t),\n\t\tnew File(\n\t\t\t[dataURLToBlob('data:image/png;base64,R0lGODlhDAAMAKIFAF5LAP/zxAAAANyuAP/gaP///wAAAAAAACH5BAEAAAUALAAAAAAMAAwAAAMlWLPcGjDKFYi9lxKBOaGcF35DhWHamZUW0K4mAbiwWtuf0uxFAgA7')],\n\t\t\t'good.png'\n\t\t),\n\t\tnew File(\n\t\t\t[dataURLToBlob('data:image/gif;base64,R0lGODlhFAAUAKUgAEyV9Zq98S+I7Hl7gWen9TZKiigxb4+PknuHlHd4fUSs9mad83Sr9XV5qkNZmU+N1S49dKKduuHh4cng9HBwbd7j9Dt5s3yZ1fz4/H+h1So9gH59fVtjk3+Bg1p+s7W2xv///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////yH5BAEAABkALAAAAAAUABQAAAarwIxwSCwaj8ikEklpOp+RjTRSREyu2Gukg+l2qMPDZLFgLAgMRgLT2XA7RDGZzCAQDGzJOz4B+AEXAQoQGBAbFGx8An4KDhwPGhh4hHBhEwICCpAGBR4WBxgHX0QdEwELFw4aDgUGrhwGlUMbEx8YDZwFGrqgomBCpREfuKuwkoWJQwkTFbquEK2FTclCtFlYBhUUE3vKCd/g34hS3UsHG11sv0tRU0vv8EZBADs=')],\n\t\t\t'bad.gif'\n\t\t),\n\t];\n\tlet goodFilesCounter = 0;\n\tlet goodFilesCountFromEvent = 0;\n\tfilesSource.forEach((file) => {\n\t\tif (file.name.indexOf('good') === 0) {\n\t\t\tgoodFilesCounter++;\n\t\t}\n\t});\n\tlet testFiles = null;\n\tconst events = {\n\t\tonUploaderIsInited: ({compatData: [uploaderId, uploader]}) => {\n\t\t\tif (uploaderId === 'testUploader' && uploader instanceof BX.Uploader) {\n\t\t\t\tdelete events['onUploaderIsInited'];\n\t\t\t}\n\t\t},\n\t\tonAttachFiles: ({compatData: [files, nodes]}) => {\n\t\t\ttestFiles = files;\n\t\t\tif (testFiles === filesSource) {\n\t\t\t\tconsole.log('Ura!')\n\t\t\t}\n\t\t\tdelete events['onAttachFiles'];\n\t\t},\n\t\tonItemIsAdded: ({compatData: [file, node]}) => {\n\t\t\tif (file.name.indexOf('good') === 0)\n\t\t\t{\n\t\t\t\tgoodFilesCountFromEvent++;\n\t\t\t}\n\t\t\tif (goodFilesCountFromEvent === goodFilesCounter)\n\t\t\t{\n\t\t\t\tdelete events['onItemIsAdded'];\n\t\t\t}\n\t\t},\n\t\tonPackageIsInitialized: ({\n\t\t\tcompatData: [somePostData, filesQueue],\n\t\t\tdata: {formData: formData, data: data, files: files}}) => {\n\t\t\tit('Must be fired \"onPackageIsInitialized\" with special compatibility data', () => {\n\t\t\t\tassert.equal(!!somePostData.post, true);\n\t\t\t\tassert.equal(!!somePostData.post.data, true);\n\t\t\t\tassert.equal(somePostData.post.filesCount, goodFilesCounter);\n\t\t\t\tassert.equal(!!filesQueue, true);\n\t\t\t});\n\t\t\tit('Must be fired \"onPackageIsInitialized\" with new events', () => {\n\t\t\t\tassert.equal(!!formData, true);\n\t\t\t\tassert.equal(!!data, true);\n\t\t\t\tassert.equal(!!files, true);\n\t\t\t});\n\t\t\tdelete events['onPackageIsInitialized'];\n\t\t},\n\t\tonStart: ({\n\t\t\t\t\tcompatData: [packageId, somePostData, packItem],\n\t\t\t\t\tdata: {package: packItemForNewEvents}}) => {\n\t\t\tit('Must be fired \"onStart\" with special compatibility data', () => {\n\t\t\t\tassert.equal(packageId, packItem.getId());\n\t\t\t\tassert.equal(!!somePostData.post, true);\n\t\t\t\tassert.equal(!!somePostData.post.data, true);\n\t\t\t\tassert.equal(somePostData.post.filesCount, goodFilesCounter);\n\t\t\t});\n\t\t\tit('Must be fired \"onStart\" with new events', () => {\n\t\t\t\tassert.equal(packageId, packItemForNewEvents.getId());\n\t\t\t});\n\t\t\tdelete events['onStart'];\n\t\t},\n\t\tonFinish: ({\n\t\t\tcompatData: [usedToBeStreams, packageId, packItem, response],\n\t\t\tdata: {package: packItemForNewEvents, response: responseForNewEvents}\n\t\t}) => {\n\t\t\tit('Must be fired \"onFinish\" with special compatibility data', () => {\n\t\t\t\tassert.equal(packageId, packItem.getId());\n\t\t\t});\n\t\t\tit('Must be fired \"onFinish\" with new events', () => {\n\t\t\t\tassert.equal(packageId, packItemForNewEvents.getId());\n\t\t\t});\n\t\t\tdelete events['onFinish'];\n\t\t\t//Todo make a differed test\n\t\t}\n\t}\n\tEventEmitter.subscribe(EventEmitter.GLOBAL_TARGET, 'onUploaderIsInited', events.onUploaderIsInited);\n\n\tconst input = Tag.render`<input type=\"file\" name=\"\" accept=\"image/png\">`;\n\tconst form = Tag.render`<form action=\"\">${input}</form>`;\n\tconst agent = new BX.Uploader({\n\t\tid: uploaderId,\n\t\tinput: input,\n\t\tuploadFileUrl: 'uploader.php',\n\t\tdropZone: null,\n\t\tplaceHolder: null,\n\t\tevents: events,\n\n\t\tuploadMaxFilesize: 1024,\n\t\tuploadFileWidth: 10,\n\t\tuploadFileHeight: 10,\n\t\tallowUpload: 'I',\n\t\tallowUploadExt: '.jpg png txt'\n\t});\n\n\tit('Should apply limits', () => {\n\t\tassert.equal(\n\t\t\tagent.limits['uploadFile'],\n\t\t\t'image/png, image/*, .jpg, .png, .txt');\n\t});\n\tit('Must be fired \"onUploaderIsInited\"', () => {\n\t\tassert.equal(events['onUploaderIsInited'], undefined);\n\t});\n\n\tagent.onAttach(filesSource);\n\n\tit('Must be fired \"onAttachFiles\"', () => {\n\t\tassert.equal(events['onAttachFiles'], undefined);\n\t});\n\n\tconst lengthFiles = agent.length;\n\tit(`Must be fired \"onItemIsAdded\" for ${goodFilesCounter} times`, () => {\n\t\tassert.equal(lengthFiles, goodFilesCounter);\n\t});\n\n\tagent.submit();\n});"],"names":["dataURLToBlob","dataURL","marker","parts","contentType","raw","rawLength","indexOf","split","Blob","type","window","atob","length","uInt8Array","Uint8Array","i","charCodeAt","describe","uploaderId","filesSource","File","goodFilesCounter","goodFilesCountFromEvent","forEach","file","name","testFiles","events","onUploaderIsInited","compatData","uploader","BX","Uploader","onAttachFiles","files","nodes","console","log","onItemIsAdded","node","onPackageIsInitialized","somePostData","filesQueue","data","formData","it","assert","equal","post","filesCount","onStart","packageId","packItem","packItemForNewEvents","package","getId","onFinish","usedToBeStreams","response","responseForNewEvents","EventEmitter","subscribe","GLOBAL_TARGET","input","Tag","render","form","agent","id","uploadFileUrl","dropZone","placeHolder","uploadMaxFilesize","uploadFileWidth","uploadFileHeight","allowUpload","allowUploadExt","limits","undefined","onAttach","lengthFiles","submit"],"mappings":"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"}