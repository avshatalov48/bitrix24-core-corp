(function(){if(window["BXPostFormTags"])return;var e={selector:{}};window.BXPostFormTags=function(e,t){this.popup=null;this.formID=e;this.buttonID=t;this.sharpButton=null;this.addNewLink=null;this.tagsArea=null;this.hiddenField=null;this.popupContent=null;BX.ready(BX.proxy(this.init,this))};window.BXPostFormTags.prototype.init=function(){this.sharpButton=BX(this.buttonID);this.addNewLink=BX("post-tags-add-new-"+this.formID);this.tagsArea=BX("post-tags-block-"+this.formID);this.tagsContainer=BX("post-tags-container-"+this.formID);this.hiddenField=BX("post-tags-hidden-"+this.formID);this.popupContent=BX("post-tags-popup-content-"+this.formID);this.popupInput=BX.findChild(this.popupContent,{tag:"input"});var e=BX.findChildren(this.tagsContainer,{className:"feed-add-post-del-but"},true);for(var t=0,i=e.length;t<i;t++){BX.bind(e[t],"click",BX.proxy(this.onTagDelete,{obj:this,tagBox:e[t].parentNode,tagValue:e[t].parentNode.getAttribute("data-tag")}))}BX.bind(this.sharpButton,"click",BX.proxy(this.onButtonClick,this));BX.bind(this.addNewLink,"click",BX.proxy(this.onAddNewClick,this))};window.BXPostFormTags.prototype.onTagDelete=function(){BX.remove(this.tagBox);this.obj.hiddenField.value=this.obj.hiddenField.value.replace(this.tagValue+",","").replace("  "," ")};window.BXPostFormTags.prototype.show=function(){if(this.popup===null){this.popup=new BX.PopupWindow("bx-post-tag-popup",this.addNewLink,{content:this.popupContent,lightShadow:false,offsetTop:8,offsetLeft:10,autoHide:true,angle:true,closeByEsc:true,zIndex:-840,buttons:[new BX.PopupWindowButton({text:BX.message("TAG_ADD"),events:{click:BX.proxy(this.onTagAdd,this)}})]});BX.bind(this.popupInput,"keydown",BX.proxy(this.onKeyPress,this));BX.bind(this.popupInput,"keyup",BX.proxy(this.onKeyPress,this))}this.popup.show();BX.focus(this.popupInput)};window.BXPostFormTags.prototype.addTag=function(e){var t=BX.type.isNotEmptyString(e)?e.split(","):this.popupInput.value.split(",");var i=[];for(var n=0;n<t.length;n++){var o=BX.util.trim(t[n]);if(o.length>0){var s=this.hiddenField.value.split(",");if(!BX.util.in_array(o,s)){var a;var r=BX.create("span",{children:[a=BX.create("span",{attrs:{class:"feed-add-post-del-but"}})],attrs:{class:"feed-add-post-tags"}});r.insertBefore(document.createTextNode(o),a);this.tagsContainer.insertBefore(r,this.addNewLink);BX.bind(a,"click",BX.proxy(this.onTagDelete,{obj:this,tagBox:r,tagValue:o}));this.hiddenField.value+=o+",";i.push(o)}}}return i};window.BXPostFormTags.prototype.onTagAdd=function(){this.addTag();this.popupInput.value="";this.popup.close()};window.BXPostFormTags.prototype.onAddNewClick=function(e){e=e||window.event;this.show();BX.PreventDefault(e)};window.BXPostFormTags.prototype.onButtonClick=function(e){e=e||window.event;BX.show(this.tagsArea);this.show();BX.PreventDefault(e)};window.BXPostFormTags.prototype.onKeyPress=function(e){e=e||window.event;var t=e.keyCode?e.keyCode:e.which?e.which:null;if(t==13){setTimeout(BX.proxy(this.onTagAdd,this),0)}};window.BXPostFormImportant=function(e,t,i){if(i){this.formID=e;this.buttonID=t;this.inputName=i;this.fireButton=null;this.activeBlock=null;this.hiddenField=null;BX.ready(BX.proxy(this.init,this))}return false};window.BXPostFormImportant.prototype.init=function(){this.fireButton=BX(this.buttonID);this.activeBlock=BX(this.buttonID+"-active");var e=BX(this.formID);if(e){this.hiddenField=e[this.inputName];if(this.hiddenField&&this.hiddenField.value==1){this.showActive()}}BX.bind(this.fireButton,"click",BX.proxy(function(e){e=e||window.event;this.showActive();BX.PreventDefault(e)},this));BX.bind(this.activeBlock,"click",BX.proxy(function(e){e=e||window.event;this.hideActive();BX.PreventDefault(e)},this))};window.BXPostFormImportant.prototype.showActive=function(e){BX.hide(this.fireButton);BX.show(this.activeBlock,"inline-block");if(this.hiddenField){this.hiddenField.value=1}return false};window.BXPostFormImportant.prototype.hideActive=function(e){BX.hide(this.activeBlock);BX.show(this.fireButton,"inline-block");if(this.hiddenField){this.hiddenField.value=0}return false};var t=null;window.MPFbuttonShowWait=function(e){if(e&&!BX.type.isElementNode(e))e=null;e=e||this;e=e?e.tagName=="A"?e:e.parentNode:e;if(e){BX.addClass(e,"ui-btn-clock");t=e;BX.defer(function(){e.disabled=true})()}};var i={listen:false,plus:false,text:"",bSearch:false,node:null,mode:null};BX.addCustomEvent(window,"onInitialized",function(e){if(e&&e.eventNode){BX.onCustomEvent(e.eventNode,"OnClickCancel",function(){i.node=null})}});window.onKeyDownHandler=function(e,t,o){var s=e.keyCode;if(!window["BXfpdStopMent"+o]){return true}var a=window.MPFgetSelectorId("bx-mention-"+o+"-id");if(s===t.KEY_CODES["backspace"]&&i.node){var r=BX.util.trim(t.util.GetTextContent(i.node));if(r==="+"||r==="@"||i.mode=="button"&&r.length==1){window["BXfpdStopMent"+o]()}else if(i.mode=="button"&&r.length==1){window["BXfpdStopMent"+o]()}}if(BX.util.in_array(s,[107,187])||(e.shiftKey||e.modifiers>3)&&BX.util.in_array(s,[50,43,61])||e.altKey&&BX.util.in_array(s,[76])||e.altKey&&e.ctrlKey&&BX.util.in_array(s,[81])&&e.key==="@"||e.altKey&&BX.util.in_array(s,[71,81])&&e.key==="@"||e.altKey&&BX.util.in_array(s,[50])&&e.key==="@"||typeof e.getModifierState==="function"&&!!e.getModifierState("AltGraph")&&BX.util.in_array(s,[81,50])&&typeof e.key!=="undefined"&&e.key==="@"){setTimeout(function(){var e=t.selection.GetRange(),o=t.GetIframeDoc(),s=e?e.endContainer.textContent:"",r=s?s.slice(e.endOffset-1,e.endOffset):"",d=s?s.slice(e.endOffset-2,e.endOffset-1):"";if((r=="@"||r=="+")&&(!d||BX.util.in_array(d,["+","@",",","("])||d.length==1&&BX.util.trim(d)==="")){i.listen=true;i.listenFlag=true;i.text="";i.leaveContent=true;i.mode="plus";e.setStart(e.endContainer,e.endOffset-1);e.setEnd(e.endContainer,e.endOffset);t.selection.SetSelection(e);i.node=BX.create("SPAN",{props:{id:"bx-mention-node"}},o);t.selection.Surround(i.node,e);e.setStart(i.node,1);e.setEnd(i.node,1);t.selection.SetSelection(e);if(BX.type.isNotEmptyString(a)){BX.onCustomEvent(window,"BX.MPF.MentionSelector:open",[{id:a,bindPosition:n(i.node,t)}])}}},10)}if(i.listen){var d=null;if(BX.type.isNotEmptyString(a)){d=BX.UI.SelectorManager.instances[a]}var l=false;if(d){l=d.getNavigationInstance().checkKeyboardNavigation({keyCode:s,tab:i.bSearch?"search":d?d.tabs.selected:false})}if(l){t.iframeKeyDownPreventDefault=true;e.stopPropagation();e.preventDefault()}}if(!i.listen&&i.listenFlag&&s===t.KEY_CODES["enter"]){var p=t.selection.GetRange();if(p.collapsed){var f=p.endContainer,u=t.GetIframeDoc();if(f){if(f.className!=="bxhtmled-metion"){f=BX.findParent(f,function(e){return e.className=="bxhtmled-metion"},u.body)}if(f&&f.className=="bxhtmled-metion"){t.selection.SetAfter(f)}}}}};window.onKeyUpHandler=function(e,t,o){var s=e.keyCode,a,r;if(!window["BXfpdStopMent"+o])return true;if(i.listen===true){if(s==t.KEY_CODES["escape"]){window["BXfpdStopMent"+o]()}else if(s!==t.KEY_CODES["enter"]&&s!==t.KEY_CODES["left"]&&s!==t.KEY_CODES["right"]&&s!==t.KEY_CODES["up"]&&s!==t.KEY_CODES["down"]){if(BX(i.node)){r=BX.util.trim(t.util.GetTextContent(i.node));var d=r;r=r.replace(/^[\+@]*/,"");i.bSearch=r.length>0;var l=window.MPFgetSelectorId("bx-mention-"+o+"-id");if(BX.type.isNotEmptyString(l)){var p=BX.UI.SelectorManager.instances[l];if(BX.type.isNotEmptyObject(p)){p.getSearchInstance().runSearch({text:r})}}if(i.leaveContent&&i._lastText&&d===""){window["BXfpdStopMent"+o]()}else if(i.leaveContent&&i.lastText&&d!==""&&r===""){i.bSearch=false;window["BXfpdStopMent"+o]();if(BX.type.isNotEmptyString(l)){BX.onCustomEvent(window,"BX.MPF.MentionSelector:open",[{id:l,bindPosition:n(i.node,t)}])}}i.lastText=r;i._lastText=d}else{window["BXfpdStopMent"+o]()}}}else{if(!e.shiftKey&&(s===t.KEY_CODES["space"]||s===t.KEY_CODES["escape"]||s===188||s===190)){a=t.selection.GetRange();if(a.collapsed){var f=a.endContainer,u=t.GetIframeDoc();if(f){if(f.className!=="bxhtmled-metion"){f=BX.findParent(f,function(e){return e.className=="bxhtmled-metion"},u.body)}if(f&&f.className=="bxhtmled-metion"){r=t.util.GetTextContent(f);var c=r.match(/[\s\.\,]$/);if(c||s===t.KEY_CODES["escape"]){f.innerHTML=r.replace(/[\s\.\,]$/,"");var h=BX.create("SPAN",{html:c||t.INVISIBLE_SPACE},u);t.util.InsertAfter(h,f);t.selection.SetAfter(h)}}}}}}};window.onTextareaKeyDownHandler=function(e,t,n){var o=e.keyCode;if(i.listen&&o==t.KEY_CODES["enter"]){var s=window.MPFgetSelectorId("bx-mention-"+n+"-id");if(BX.type.isNotEmptyString(s)){var a=BX.UI.SelectorManager.instances[s];if(BX.type.isNotEmptyObject(a)){a.getNavigationInstance().selectFirstItem({tab:i.bSearch?"search":a.tabs.selected})}}t.textareaKeyDownPreventDefault=true;e.stopPropagation();e.preventDefault()}};window.onTextareaKeyUpHandler=function(e,t,n){var o,s,a=e.keyCode;var r=window.MPFgetSelectorId("bx-mention-"+n+"-id");if(i.listen===true){if(a==27){window["BXfpdStopMent"+n]()}else if(a!==13){s=t.textareaView.GetValue(false);o=t.textareaView.GetCursorPosition();if(s.indexOf("+")!==-1||s.indexOf("@")!==-1){var d=s.substr(0,o),l=Math.max(d.lastIndexOf("+"),d.lastIndexOf("@"));if(l>=0){var p=d.substr(l),f=p;p=p.replace(/^[\+@]*/,"");i.bSearch=p.length>0;var u=null;if(BX.type.isNotEmptyString(r)){u=BX.UI.SelectorManager.instances[r]}if(BX.type.isNotEmptyObject(u)){u.getSearchInstance().runSearch({text:p})}if(i.leaveContent&&i._lastText&&(f===""||p==="")){window["BXfpdStopMent"+n]()}i.lastText=p;i._lastText=f}}}}else{if(a==16){var c=this;this.shiftPressed=true;if(this.shiftTimeout)this.shiftTimeout=clearTimeout(this.shiftTimeout);this.shiftTimeout=setTimeout(function(){c.shiftPressed=false},100)}if(a==107||(e.shiftKey||e.modifiers>3||this.shiftPressed)&&BX.util.in_array(a,[187,50,107,43,61])){o=t.textareaView.element.selectionStart;if(o>0){s=t.textareaView.element.value;var h=s.substr(o-1,1);if(h&&(h==="+"||h==="@")){i.listen=true;i.listenFlag=true;i.text="";i.textarea=true;i.bSearch=false;i.mode="plus";if(BX.type.isNotEmptyString(r)){BX.onCustomEvent(window,"BX.MPF.MentionSelector:open",[{id:r}])}}}}}};var n=function(e,t){var i=BX.pos(e),n=BX.pos(t.dom.areaCont),o=BX.GetWindowScrollPos(t.GetIframeDoc()),s=n.top+i.bottom-o.scrollTop+2,a=n.left+i.right-o.scrollLeft;return{top:s,left:a}};window.BxInsertMention=function(e){var t=e.item,n=e.type,o=e.formID,s=e.editorId,a=e.bNeedComa,r=LHEPostForm.getEditor(s),d;if((n==="users"||n==="emailusers")&&t&&t.entityId>0&&r){if(r.GetViewMode()=="wysiwyg"){var l=r.GetIframeDoc(),p=r.selection.GetRange(),f=BX.create("SPAN",{props:{className:"bxhtmled-metion"},text:BX.util.htmlspecialcharsback(t.name)},l);d=BX.create("SPAN",{html:a?",&nbsp;":"&nbsp;"},l);r.SetBxTag(f,{tag:"postuser",userId:t.entityId,userName:t.name,params:{value:t.entityId}});if(BX(i.node)&&i.node.parentNode){r.util.ReplaceNode(i.node,f)}else{r.selection.InsertNode(f,p)}if(f&&f.parentNode){var u=BX.findParent(f,{className:"bxhtmled-metion"},l.body);if(u){r.util.InsertAfter(f,u)}}if(f&&f.parentNode){r.util.InsertAfter(d,f);r.selection.SetAfter(d)}}else if(r.GetViewMode()=="code"&&r.bbCode){r.textareaView.Focus();var c=r.textareaView.GetValue(false),h=r.textareaView.GetCursorPosition(),B=c.substr(0,h),m=Math.max(B.lastIndexOf("+"),B.lastIndexOf("@"));if(m>=0&&h>m){r.textareaView.SetValue(c.substr(0,m)+c.substr(h));r.textareaView.element.setSelectionRange(m,m)}r.textareaView.WrapWith(false,false,"[USER="+t.entityId+"]"+t.name+"[/USER]"+(a?", ":" "))}if(e.fireAddEvent===true){BX.onCustomEvent(window,"onMentionAdd",[t])}var X=window.MPFgetSelectorId("bx-mention-"+o+"-id");if(BX.type.isNotEmptyString(X)){var w=BX.UI.SelectorManager.instances[X];if(BX.type.isNotEmptyObject(w)){if(typeof w.itemsSelected[t.id]!="undefined"){delete w.itemsSelected[t.id]}}}if(window["BXfpdStopMent"+o]){window["BXfpdStopMent"+o]()}i["text"]="";if(r.GetViewMode()=="wysiwyg"){r.Focus();r.selection.SetAfter(d)}}};window.MPFgetSelectorId=function(e){var t=false;var i=BX(e);if(!i){return t}t=i.getAttribute("data-bx-selector-id");return t};window.MPFMentionInit=function(e,t){if(t.initDestination===true){BX.addCustomEvent("onAutoSaveRestoreDestination",function(t){if(BX.type.isNotEmptyObject(t)&&BX.type.isNotEmptyObject(t.data)&&BX.type.isNotEmptyString(t.data.DEST_DATA)&&BX.type.isNotEmptyString(t.formId)&&t.formId==e&&BX.UI.EntitySelector){var i=JSON.parse(t.data.DEST_DATA);if(!Array.isArray(i)){return}var n=BX.UI.EntitySelector.Dialog.getById("oPostFormLHE_blogPostForm");if(!BX.type.isNotEmptyObject(n)){return}n.preselectedItems=i;n.setPreselectedItems(i)}});BX.addCustomEvent(window,"onMentionAdd",function(e){var t=BX.UI.EntitySelector.Dialog.getById("oPostFormLHE_blogPostForm");if(!BX.type.isNotEmptyObject(t)){return}var i="employee";if(e.isExtranet==="Y"){i="extranet"}else if(e.isEmail==="Y"){i="email"}t.addItem({avatar:e.avatar,customData:{email:e.email},entityId:"user",entityType:i,id:e.entityId,title:e.name}).select()})}window["BXfpdSelectCallbackMent"+e]=function(i){window.BxInsertMention({item:i.item,type:i.entityType.toLowerCase(),formID:e,editorId:t.editorId,fireAddEvent:t.initDestination})};window["BXfpdStopMent"+e]=function(){var t=window.MPFgetSelectorId("bx-mention-"+e+"-id");if(BX.type.isNotEmptyString(t)){var i=BX.UI.SelectorManager.instances[t];if(BX.type.isNotEmptyObject(i)){i.closeAllPopups();i.getSearchInstance().abortSearchRequest()}}};if(BX(e)){BX.addCustomEvent(BX(e),"OnUCFormAfterShow",function(t){if(!BX.type.isNotEmptyObject(t)||!BX.type.isArray(t.id)||!BX.type.isNotEmptyString(t.id[0])){return}var i=new RegExp("EVENT_(\\d+)","i");if(!i.test(t.id[0])){return}var n=window.MPFgetSelectorId("bx-mention-"+e+"-id");if(!BX.type.isNotEmptyString(n)){return}var o=BX.UI.SelectorManager.instances[n];if(!BX.type.isNotEmptyObject(o)){return}o.bindOptions.zIndex=2200})}LHEPostForm.getHandlerByFormId(e).exec(function(){var t=window.MPFgetSelectorId("bx-mention-"+e+"-id");if(t){BX.onCustomEvent(window,"BX.MPF.MentionSelector:init",[{id:t,openDialogWhenInit:false}])}});BX.ready(function(){var n=BX("bx-b-mention-"+e);var o=window.MPFgetSelectorId("bx-mention-"+e+"-id");BX.bind(n,"click",function(e){if(i.listen!==true){var s=LHEPostForm.getEditor(t.editorId),a=s.GetIframeDoc();if(s.GetViewMode()=="wysiwyg"&&a){i.listen=true;i.listenFlag=true;i.text="";i.leaveContent=false;i.mode="button";var r=s.selection.GetRange();if(BX(i.node)){BX.remove(BX(i.node))}s.InsertHtml('<span id="bx-mention-node">'+s.INVISIBLE_SPACE+"</span>",r);setTimeout(function(){if(o){BX.onCustomEvent(window,"BX.MPF.MentionSelector:open",[{id:o,bindNode:n}])}i.node=a.getElementById("bx-mention-node");if(i.node){r.setStart(i.node,0);if(i.node.firstChild&&i.node.firstChild.nodeType==3&&i.node.firstChild.nodeValue.length>0){r.setEnd(i.node,1)}else{r.setEnd(i.node,0)}s.selection.SetSelection(r)}s.Focus()},100)}else if(s.GetViewMode()=="code"){i.listen=true;i.listenFlag=true;i.text="";i.leaveContent=false;i.mode="button";setTimeout(function(){if(o){BX.onCustomEvent(window,"BX.MPF.MentionSelector:open",[{id:o,bindNode:n}])}},100)}BX.onCustomEvent(n,"mentionClick")}})})};window.BXfpdOnDialogOpen=function(){i.listen=true;i.listenFlag=true};window.BXfpdOnDialogClose=function(e){i.listen=false;setTimeout(function(){i.listenFlag=false;if(!i.listen){var t=LHEPostForm.getEditor(e.editorId);if(t){var n=t.GetIframeDoc();if(BX(i.node)){t.selection.SetAfter(i.node);if(i.leaveContent){t.util.ReplaceWithOwnChildren(i.node)}else{BX.remove(BX(i.node))}}t.Focus()}}},100)};MPFEntitySelector=function(t){this.selector=null;this.inputNode=null;this.messages={};if(!BX.type.isNotEmptyString(t.id)){return null}if(e.selector[t.id]){return e.selector[t.id]}e.selector[t.id]=this.init(t)};MPFEntitySelector.prototype.init=function(e){if(!BX.type.isPlainObject(e)){e={}}if(!BX.type.isNotEmptyString(e.id)||!BX.type.isNotEmptyString(e.tagNodeId)||!BX(e.tagNodeId)){return null}if(BX.type.isNotEmptyString(e.inputNodeId)&&BX(e.inputNodeId)){this.inputNode=BX(e.inputNodeId)}if(BX.type.isNotEmptyObject(e.messages)){this.messages=e.messages}this.selector=new BX.UI.EntitySelector.TagSelector({id:e.id,dialogOptions:{id:e.id,context:BX.type.isNotEmptyString(e.context)?e.context:null,preselectedItems:BX.type.isArray(e.preselectedItems)?e.preselectedItems:[],events:{"Item:onSelect":function(){this.recalcValue(this.selector.getDialog().getSelectedItems())}.bind(this),"Item:onDeselect":function(){this.recalcValue(this.selector.getDialog().getSelectedItems())}.bind(this)},entities:[{id:"meta-user",options:{"all-users":{title:this.messages.allUsersTitle,allowView:BX.type.isBoolean(e.allowToAll)&&e.allowToAll}}},{id:"user",options:{emailUsers:BX.type.isBoolean(e.allowSearchEmailUsers)?e.allowSearchEmailUsers:false,inviteGuestLink:BX.type.isBoolean(e.allowSearchEmailUsers)?e.allowSearchEmailUsers:false,myEmailUsers:true}},{id:"project",options:{features:{blog:["premoderate_post","moderate_post","write_post","full_post"]}}},{id:"department",options:{selectMode:"usersAndDepartments",allowFlatDepartments:false}}]},addButtonCaption:BX.message("BX_FPD_LINK_1"),addButtonCaptionMore:BX.message("BX_FPD_LINK_2")});this.selector.renderTo(document.getElementById(e.tagNodeId));return this.selector};MPFEntitySelector.prototype.recalcValue=function(e){if(!BX.type.isArray(e)||!this.inputNode){return}var t=[];e.forEach(function(e){t.push([e.entityId,e.id])});this.inputNode.value=JSON.stringify(t)};window.MPFEntitySelector=MPFEntitySelector})();
//# sourceMappingURL=script-old.map.js