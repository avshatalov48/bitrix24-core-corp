(function(){if(window.BXMainMailConfirm)return;var e={};var t=[];var i={};var a;var n={init:function(i){t=i.mailboxes;a=i.action;delete i.mailboxes;e=i},getMailboxes:function(){return t},showList:function(e,a,o){if(!BX.type.isNotEmptyString(o.placeholder)){o.placeholder=BX.message(o.required?"MAIN_MAIL_CONFIRM_MENU_UNKNOWN":"MAIN_MAIL_CONFIRM_MENU_PLACEHOLDER")}if(!(o.settings&&o.settings.length)){o.settings=[]}if(!BX.type.isFunction(o.callback)){o.callback=function(){}}if(typeof o.popupSettings!="object"){o.popupSettings={}}o.popupSettings.className="main-mail-confirm-menu-content";o.popupSettings.offsetLeft=40;o.popupSettings.angle=true;o.popupSettings.closeByEsc=true;o.popupSettings.events={onFirstShow:function(e){if(e&&e.target&&e.target.contentContainer){BX.UI.Hint.init(e.target.contentContainer)}}};i[e]=o;var l=[];var s=function(a,o){var l="apply";if(a&&a.target){var s="main-mail-confirm-menu-delete-icon";if(BX.hasClass(a.target,s)||BX.findParent(a.target,{class:s},o.layout.item)){l="delete"}if(BX.hasClass(a.target,"sender-hint")||BX.findParent(a.target,{class:"sender-hint"},o.layout.item)){l="edit"}}if("delete"==l){n.deleteSender(o.id,(function(){t=t.filter((function(e,t){return o.id!==e.id}));o.menuWindow.removeMenuItem(o.id);if(i[e].selected===o.formated){i[e].callback("",i[e].placeholder)}}))}else if("edit"===l){n.showEditForm(o.id,(function(t,a){var l=BX.util.htmlspecialchars(a);if(o.options&&o.options.mailbox){o.options.mailbox.name=t.name;o.options.mailbox.formated=a;if(o.options.mailbox.can_delete&&o.options.mailbox.id>0){l+=n.getItemIconsHtml()}}o.text=BX.util.htmlspecialchars(a);o.name=t.name;o.formated=a;o.layout.text.innerHTML=l;o.options.title=a;i[e].callback(a,BX.util.htmlspecialchars(a))}))}else{i[e].callback(o.formated,o.text);o.menuWindow.close()}};if(!o.required){l.push({text:BX.util.htmlspecialchars(o.placeholder),formated:"",onclick:s});l.push({delimiter:true})}if(t&&t.length>0){var r,d;for(var m in t){d="menu-popup-no-icon";r=BX.util.htmlspecialchars(t[m].formated);if(t[m]["can_delete"]&&t[m].id>0){r+=this.getItemIconsHtml();d="menu-popup-no-icon menu-popup-right-icon"}else if(!t[m].id&&t[m].showEditHint){r+='<span class="main-mail-confirm-menu-hint-container" data-hint="'+BX.util.htmlspecialchars(BX.message("MAIN_MAIL_CONFIRM_SMTP_SENDER_NO_EDIT_HINT"))+'"></span>';d="menu-popup-no-icon menu-popup-right-hint-icon"}l.push({html:r,mailbox:t[m],formated:t[m].formated,onclick:s,className:d,id:t[m].id})}l.push({delimiter:true})}l.push({text:BX.util.htmlspecialchars(BX.message("MAIN_MAIL_CONFIRM_MENU")),onclick:function(a,o){o.menuWindow.close();n.showForm((function(a,n){t.push({email:a.email,name:a.name,id:a.id,formated:n,can_delete:true});i[e].callback(n,BX.util.htmlspecialchars(n));BX.PopupMenu.destroy(e+"-menu")}))}});if(o.settings.length>0){l=l.concat(o.settings)}BX.PopupMenu.show(e+"-menu",a,l,o.popupSettings)},showForm:function(e,t){window.step="email";var i;window.mode=t&&t.mode?t.mode:"add";var a=new BX.PopupWindow("add_from_email",null,{titleBar:BX.message("MAIN_MAIL_CONFIRM_TITLE"),draggable:true,closeIcon:true,lightShadow:true,contentColor:"white",contentNoPaddings:true,cacheable:false,content:BX("new_from_email_dialog_content").innerHTML,buttons:this.prepareDialogButtons(null,"add",t,e)});this.prepareDialog(a)},prepareDialog:function(t){t.formFieldHint=function(e,t,i){if(!e){return}var a=BX.findParent(e,{class:"new-from-email-dialog-cell"});var n=BX.findChildByClassName(a,"new-from-email-dialog-field-hint",true);BX.removeClass(a,"new-from-email-dialog-field-error");BX.removeClass(a,"new-from-email-dialog-field-warning");switch(t){case"error":BX.addClass(a,"new-from-email-dialog-field-error");break;case"warning":BX.addClass(a,"new-from-email-dialog-field-warning");break}if(typeof i!="undefined"&&i.length>0){BX.adjust(n,{html:i});BX.show(n,"block")}else{BX.hide(n,"block")}};t.hideNotify=function(){var e=BX.findChild(t.contentContainer,{class:"new-from-email-dialog-error"},true);if(e){BX.hide(e,"block")}};t.showNotify=function(e){var i=BX.findChild(t.contentContainer,{class:"new-from-email-dialog-error"},true);if(i){i.innerHTML=e;BX.show(i,"block")}};t.switchBlock=function(i,a){var n=BX.findChildByClassName(t.contentContainer,"new-from-email-dialog-email-block",true);var o=BX.findChildByClassName(t.contentContainer,"new-from-email-dialog-code-block",true);var l,s;if("code"!=step&&"code"==i){l=n;s=o;t.buttons[0].setName(BX.message("MAIN_MAIL_CONFIRM_SAVE"));t.buttons[1].setName(BX.message("MAIN_MAIL_CONFIRM_BACK"))}else if("code"==step&&"code"!=i){l=o;s=n;t.buttons[0].setName(BX.message("smtp"==i&&e.canCheckSmtp?"MAIN_MAIL_CONFIRM_SAVE":"MAIN_MAIL_CONFIRM_GET_CODE"));t.buttons[1].setName(BX.message("MAIN_MAIL_CONFIRM_CANCEL"))}step=i;if(l&&s){if(a){s.style.position="";s.style.height="";s.style.display="";l.style.display="none"}else{l.style.height=l.offsetHeight+"px";l.offsetHeight;l.style.height="0px";s.style.position="absolute";s.style.height="";s.style.display="";var r=s.offsetHeight;s.style.height="0px";s.style.position="";s.offsetHeight;s.style.height=r+"px"}}};var i=BX.findChildByClassName(t.contentContainer,"new-from-email-dialog-smtp-link",true);var a=BX.findChildByClassName(t.contentContainer,"new-from-email-dialog-smtp-block",true);var n=BX.findChildByClassName(t.contentContainer,"new-from-email-smtp-use-limit",true);if(n){BX.bind(n,"click",(function(){var e=BX.findChildByClassName(t.contentContainer,"new-from-email-smtp-use-limit",true);var i=BX.findChildByClassName(t.contentContainer,"new-from-email-dialog-email-block",true);var a=BX.findChild(i,{attr:{"data-name":"smtp-limit"}},true);a.disabled=!e.checked}))}if(i&&a){BX.bind(i,"click",(function(i){var n=BX.findChildByClassName(t.contentContainer,"new-from-email-dialog-email-block",true);n.style.height="";if("smtp"==step){step="email";BX.hide(a,"table-row-group");t.buttons[0].setName(BX.message("MAIN_MAIL_CONFIRM_GET_CODE"))}else{step="smtp";BX.show(a,"table-row-group");t.buttons[0].setName(BX.message(e.canCheckSmtp?"MAIN_MAIL_CONFIRM_SAVE":"MAIN_MAIL_CONFIRM_GET_CODE"))}i.preventDefault()}))}if("confirm"==window.mode){t.switchBlock("code",true);t.setOverlay(true)}BX.UI.Hint.init(t.contentContainer);t.show();var o=BX.findChildByClassName(t.contentContainer,"new-from-email-dialog-email-block",true);var l=BX.findChild(o,{attr:{"data-name":"name"}},true);var s=BX.findChild(o,{attr:{"data-name":"email"}},true);if(l.value.length>0){s.focus()}else{l.focus()}},showEditForm:function(e,t){window.step="email";window.mode="edit";var i=this;var n=new BX.PopupWindow("edit_from_email",null,{titleBar:BX.message("MAIN_MAIL_CONFIRM_EDIT_TITLE"),draggable:true,closeIcon:true,lightShadow:true,contentColor:"white",contentNoPaddings:true,cacheable:false,content:BX("new_from_email_dialog_content").innerHTML,events:{onPopupShow:function(){BX.ajax({url:BX.util.add_url_param(a,{act:"info",senderId:e}),method:"GET",dataType:"json",onsuccess:function(e){var t=BX.findChildByClassName(n.contentContainer,"new-from-email-dialog-email-block",true);var a=BX.findChildByClassName(n.contentContainer,"new-from-email-dialog-smtp-link",true);var o=BX.findChildByClassName(n.contentContainer,"new-from-email-smtp-use-limit",true);var l=BX.findChild(n.contentContainer,{attr:{"data-name":"public"}},true);var s=BX.findChild(t,{attr:{"data-name":"name"}},true);var r=BX.findChild(t,{attr:{"data-name":"email"}},true);var d=BX.findChild(t,{attr:{"data-name":"smtp-server"}},true);var m=BX.findChild(t,{attr:{"data-name":"smtp-port"}},true);var u=BX.findChild(t,{attr:{"data-name":"smtp-ssl"}},true);var c=BX.findChild(t,{attr:{"data-name":"smtp-login"}},true);var f=BX.findChild(t,{attr:{"data-name":"smtp-limit"}},true);s.value=e.name||"";r.value=BX.util.htmlspecialchars(e.email);d.value=BX.util.htmlspecialchars(e.server||"");m.value=BX.util.htmlspecialchars(e.port||"");c.value=BX.util.htmlspecialchars(e.login||"");if(e.isPublic>0){l.checked=true}var p=typeof e.limit==="undefined"||e.limit===null;f.value=p?f.value:e.limit;if(!p){o.checked=true;f.disabled=false}if(e.protocol==="smtps"){u.checked=true}if(e.isOauth){i.disableSmtpFields(n.contentContainer);n.setTitleBar(BX.Loc.getMessage("MAIN_MAIL_CONFIRM_EDIT_TITLE_EMAIL",{"#EMAIL#":BX.util.htmlspecialchars(e.email)}))}if(e.server){BX.fireEvent(a,"click")}},onfailure:function(e){}})}},buttons:this.prepareDialogButtons(e,"edit",null,t)});this.prepareDialog(n)},prepareDialogButtons:function(e,t,i,n){return[new BX.PopupWindowButton({text:BX.message("MAIN_MAIL_CONFIRM_GET_CODE"),className:"popup-window-button-create",events:{click:function(o,l){var s=this;var r=s.popupWindow;if(BX.hasClass(s.buttonNode,"popup-window-button-wait"))return;var d=BX.findChildByClassName(r.contentContainer,"new-from-email-dialog-email-block",true);var m=BX.findChildByClassName(r.contentContainer,"new-from-email-dialog-code-block",true);var u=BX.findChild(d,{attr:{"data-name":"name"}},true);var c=BX.findChild(d,{attr:{"data-name":"email"}},true);var f=BX.findChild(m,{attr:{"data-name":"code"}},true);var p=BX.findChild(r.contentContainer,{attr:{"data-name":"public"}},true);var h=BX.findChild(d,{attr:{"data-name":"smtp-server"}},true);var B=BX.findChild(d,{attr:{"data-name":"smtp-port"}},true);var _=BX.findChild(d,{attr:{"data-name":"smtp-ssl"}},true);var C=BX.findChild(d,{attr:{"data-name":"smtp-login"}},true);var I=BX.findChild(d,{attr:{"data-name":"smtp-password"}},true);var X=BX.findChild(d,{attr:{"data-name":"smtp-limit"}},true);r.formFieldHint(I);if("email"==window.step||"smtp"==window.step){f.value="";var M="[=a-z0-9_+~'!$&*^`|#%/?{}-]";var g=new RegExp("^"+M+"+(\\."+M+"+)*@([a-z0-9-]+\\.)+[a-z0-9-]{2,20}$","i");if(!c.value.match(g)){r.showNotify(BX.message(c.value.length>0?"MAIN_MAIL_CONFIRM_INVALID_EMAIL":"MAIN_MAIL_CONFIRM_EMPTY_EMAIL"));return}}if("smtp"==window.step){if(!h.value.match(/^([a-z0-9-]+\.)+[a-z0-9-]{2,20}$/)){r.showNotify(BX.message(h.value.length>0?"MAIN_MAIL_CONFIRM_INVALID_SMTP_SERVER":"MAIN_MAIL_CONFIRM_EMPTY_SMTP_SERVER"));return}if(!B.value.match(/^[0-9]+$/)||B.value<1||B.value>65535){r.showNotify(BX.message(B.value.length>0?"MAIN_MAIL_CONFIRM_INVALID_SMTP_PORT":"MAIN_MAIL_CONFIRM_EMPTY_SMTP_PORT"));return}if(!(C.value.length>0)){r.showNotify(BX.message("MAIN_MAIL_CONFIRM_EMPTY_SMTP_LOGIN"));return}if(!e&&I.value.length>0){if(I.value.match(/^\^/)){r.showNotify(BX.message("MAIN_MAIL_CONFIRM_INVALID_SMTP_PASSWORD_CARET"));return}else if(I.value.match(/\x00/)){r.showNotify(BX.message("MAIN_MAIL_CONFIRM_INVALID_SMTP_PASSWORD_NULL"));return}else if(I.value.match(/^\s|\s$/)){r.formFieldHint(I,"warning",BX.message("MAIN_MAIL_CONFIRM_SPACE_SMTP_PASSWORD"))}}else if(!e){r.showNotify(BX.message("MAIN_MAIL_CONFIRM_EMPTY_SMTP_PASSWORD"));return}}if("code"==window.step){if(f.value.length==0){r.showNotify(BX.message("MAIN_MAIL_CONFIRM_EMPTY_CODE"));return}}r.hideNotify();BX.addClass(s.buttonNode,"popup-window-button-wait");var w={id:e,name:u.value,email:c.value,smtp:{},code:"",public:p.checked?p.value:""};if("smtp"==window.step){w.smtp={server:h.value,port:B.value,ssl:_.checked?_.value:"",login:C.value,password:I.value,limit:X.disabled?null:X.value}}if("code"==window.step){w.code=f.value}if(i&&i.data){for(var N in i.data){if(i.data.hasOwnProperty(N)){w[N]=i.data[N]}}}BX.ajax({url:BX.util.add_url_param(a,{act:t}),method:"POST",dataType:"json",data:w,onsuccess:function(t){BX.removeClass(s.buttonNode,"popup-window-button-wait");if(t.senderId){e=t.senderId}if(t.result=="error"){r.showNotify(t.error)}else if(("email"==window.step||"smtp"==window.step)&&!t.confirmed){r.formFieldHint(I);r.switchBlock("code")}else{s.popupWindow.close();if(n&&BX.type.isFunction(n)){var i=u.value.length>0?u.value:BX.message("MAIN_MAIL_CONFIRM_USER_FULL_NAME");n({name:i,email:c.value,id:e},i.length>0?i+" <"+c.value+">":c.value)}}},onfailure:function(){BX.removeClass(s.buttonNode,"popup-window-button-wait");r.showNotify(BX.message("MAIN_MAIL_CONFIRM_AJAX_ERROR"))}})}}}),new BX.PopupWindowButton({text:BX.message("MAIN_MAIL_CONFIRM_CANCEL"),className:"popup-window-button-link",events:{click:function(){var e=this.popupWindow;if("code"==window.step&&"confirm"!=window.mode){var t=BX.findChildByClassName(e.contentContainer,"new-from-email-dialog-smtp-block",true);e.switchBlock(t&&t.offsetHeight>0?"smtp":"email")}else{this.popupWindow.close()}}}})]},updateListCanDel:function(e){BX.ajax({url:BX.util.add_url_param(a,{act:"sendersListCanDel"}),method:"POST",dataType:"json",data:{},onsuccess:function(i){if(i.result=="error"){BX.UI.Notification.Center.notify({content:BX.message("MAIN_MAIL_DELETE_SENDER_ERROR")})}else{t=t.filter((function(e,t){if(!e.can_delete){return true}for(var a in i.mailboxes){if(i.mailboxes[a].id==e.id){return true}}return false}));BX.PopupMenu.destroy(e+"-menu")}},onfailure:function(e){BX.UI.Notification.Center.notify({content:BX.message("MAIN_MAIL_DELETE_SENDER_ERROR")})}})},deleteSender:function(e,t){BX.UI.Dialogs.MessageBox.show({message:BX.message("MAIN_MAIL_CONFIRM_DELETE_SENDER_CONFIRM"),modal:true,buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,onOk:function(i){return new Promise((function(i,n){BX.ajax({url:BX.util.add_url_param(a,{act:"delete"}),method:"POST",dataType:"json",data:{senderId:e},onsuccess:function(e){if(e.result=="error"){BX.UI.Notification.Center.notify({content:BX.message("MAIN_MAIL_DELETE_SENDER_ERROR")});n(e)}else{if(BX.type.isFunction(t)){t()}i(e)}},onfailure:function(e){BX.UI.Notification.Center.notify({content:BX.message("MAIN_MAIL_DELETE_SENDER_ERROR")});n(e)}})}))},onCancel:function(e){e.close()}})},disableSmtpFields:function(e){var t=BX.findChildByClassName(e,"new-from-email-dialog-email-block",true);var i=BX.findChild(t,{attr:{"data-name":"email"}},true);this.disableAndHide(i);var a=BX.findChild(t,{attr:{"data-name":"smtp-server"}},true);this.disableAndHide(a);var n=BX.findChild(t,{attr:{"data-name":"smtp-port"}},true);this.disableAndHide(n);var o=BX.findChild(t,{attr:{"data-name":"smtp-ssl"}},true);this.disableAndHide(o);var l=BX.findChild(t,{attr:{"data-name":"smtp-login"}},true);this.disableAndHide(l);var s=BX.findChild(t,{attr:{"data-name":"smtp-password"}},true);this.disableAndHide(s);var r=BX.findChild(t,{class:"new-from-email-dialog-smtp-warning"},true);this.hideParentDialogRow(r);var d=BX.findChild(t,{class:"new-from-email-dialog-block-content-message"},true);if(d){BX.hide(d)}},hideParentDialogRow:function(e){if(e){var t=e.closest(".new-from-email-dialog-row");if(t){BX.hide(t)}}},disableAndHide:function(e){this.hideParentDialogRow(e);this.safeDisable(e)},safeDisable:function(e){if(e){e.setAttribute("disabled","disabled")}},getItemIconsHtml:function(){return'<span class="main-mail-confirm-menu-delete-icon popup-window-close-icon popup-window-titlebar-close-icon"\t\t\t\t\t\t\t\ttitle="'+BX.util.htmlspecialchars(BX.message("MAIN_MAIL_CONFIRM_DELETE"))+'"></span>\t\t\t\t\t<span data-role="sender-hint"  class="sender-hint main-mail-edit-icon"\t\t\t\t\t\t\t\ttitle="'+BX.util.htmlspecialchars(BX.message("MAIN_MAIL_CONFIRM_EDIT"))+'"></span>'}};window.BXMainMailConfirm=n})();
//# sourceMappingURL=script.map.js