(function(){"use strict";BX.namespace("BX.Main");BX.Main.Filter=function(t,e,s,i,r,a){this.params=t;this.search=null;this.popup=null;this.presets=null;this.fields=null;this.types=s;this.dateTypes=i;this.additionalDateTypes=a;this.numberTypes=r;this.settings=new BX.Filter.Settings(e,this);this.filter=null;this.api=null;this.isAddPresetModeState=false;this.firstInit=true;this.init()};function t(t){if(BX.type.isString(t)){t=t.toLowerCase();t=t.replace(/[\-_\s]+(.)?/g,function(t,e){return e?e.toUpperCase():""});return t.substr(0,1).toLowerCase()+t.substr(1)}return t}BX.Main.Filter.prototype={init:function(){BX.bind(document,"mousedown",BX.delegate(this._onDocumentClick,this));BX.bind(document,"keydown",BX.delegate(this._onDocumentKeydown,this));BX.bind(window,"load",BX.delegate(this.onWindowLoad,this));BX.addCustomEvent("Grid::ready",BX.delegate(this._onGridReady,this));this.getSearch().updatePreset(this.getParam("CURRENT_PRESET"))},onWindowLoad:function(){this.settings.get("AUTOFOCUS")&&this.adjustFocus()},clearGet:function(){if("history"in window){var t=window.location.toString();var e=BX.util.remove_url_param(t,"apply_filter");window.history.replaceState(null,"",e)}},adjustFocus:function(){this.getSearch().adjustFocus()},_onAddPresetKeydown:function(t){if(BX.Filter.Utils.isKey(t,"enter")){this._onSaveButtonClick()}},_onDocumentKeydown:function(t){if(BX.Filter.Utils.isKey(t,"escape")){if(this.getPopup().isShown()){BX.onCustomEvent(window,"BX.Main.Filter:blur",[this]);this.closePopup();if(this.getParam("VALUE_REQUIRED_MODE")){this.restoreRemovedPreset()}if(this.getParam("VALUE_REQUIRED")){if(!this.getSearch().getSquares().length){this.getPreset().applyPinnedPreset()}}}}},getApi:function(){if(!(this.api instanceof BX.Filter.Api)){this.api=new BX.Filter.Api(this)}return this.api},addSidebarItem:function(t,e,s){var i=this.getPreset();var r=i.getContainer();var a=i.createSidebarItem(t,e,s);var n=i.getPresetNodeById(t);if(BX.type.isDomNode(n)){BX.remove(n);BX.prepend(a,r)}else{r&&r.insertBefore(a,i.getAddPresetField())}BX.bind(a,"click",BX.delegate(i._onPresetClick,i))},saveUserSettings:function(t){var e={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER_ARRAY"};var s=this.getPreset();var i=s.getCurrentPresetId();var r={};this.params["PRESETS"]=BX.clone(this.editablePresets);r.current_preset=i;s.getPresets().forEach(function(e,i){var a=s.getPresetId(e);if(a&&a!=="tmp_filter"){var n=s.getPreset(a);n.TITLE=BX.util.htmlspecialchars(BX.util.htmlspecialcharsback(n.TITLE));n.SORT=i;s.updatePresetName(e,n.TITLE);r[a]={sort:i,name:n.TITLE,fields:this.preparePresetSettingsFields(n.FIELDS),for_all:t&&!BX.type.isBoolean(n.FOR_ALL)||t&&n.FOR_ALL===true}}},this);this.saveOptions(r,e,null,t)},isForAll:function(t){var e=this.getForAllCheckbox();return BX.type.isBoolean(t)&&t||!!e&&!!e.checked},getForAllCheckbox:function(){if(!this.forAllCheckbox){this.forAllCheckbox=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classForAllCheckbox)}return this.forAllCheckbox},preparePresetSettingsFields:function(t){var e={};var s;(t||[]).forEach(function(t){switch(t.TYPE){case this.types.STRING:{e[t.NAME]=t.VALUE;break}case this.types.SELECT:{e[t.NAME]="VALUE"in t.VALUE?t.VALUE.VALUE:"";break}case this.types.MULTI_SELECT:{if(BX.type.isArray(t.VALUE)&&t.VALUE.length){t.VALUE.forEach(function(s,i){e[t.NAME]=BX.type.isPlainObject(e[t.NAME])?e[t.NAME]:{};e[t.NAME][i]=s.VALUE},this)}break}case this.types.CHECKBOX:{if(BX.type.isArray(t.VALUE)&&t.VALUE.length){t.VALUE.forEach(function(s,i){e[t.NAME]=BX.type.isPlainObject(e[t.NAME])?e[t.NAME]:{};e[t.NAME][i]=s.VALUE},this)}break}case this.types.DATE:{if(BX.type.isPlainObject(t.VALUES)){s=Object.keys(t.VALUES);e[t.NAME+"_datesel"]=t.SUB_TYPE.VALUE;s.forEach(function(s){e[t.NAME+s]=t.VALUES[s]},this)}break}case this.types.NUMBER:{if(BX.type.isPlainObject(t.VALUES)){s=Object.keys(t.VALUES);e[t.NAME+"_numsel"]=t.SUB_TYPE.VALUE;s.forEach(function(s){e[t.NAME+s]=t.VALUES[s]},this)}break}case this.types.DEST_SELECTOR:{if(BX.type.isPlainObject(t.VALUES)){e[t.NAME]=t.VALUES._value;e[t.NAME+"_label"]=t.VALUES._label}break}case this.types.CUSTOM_ENTITY:{if(BX.type.isPlainObject(t.VALUES)){e[t.NAME]=t.VALUES._value;e[t.NAME+"_label"]=t.VALUES._label}break}default:{break}}},this);return e},savePreset:function(){var t="filter_"+ +new Date;var e=BX.util.htmlspecialcharsback(this.getPreset().getAddPresetFieldInput().value);this.updatePreset(t,e,null,true,null,null,true);this.addSidebarItem(t,e);this.getPreset().applyPreset(t);this.getPreset().activatePreset(t);this.applyFilter()},updatePreset:function(t,e,s,i,r,a,n){var l=this.getFilterFieldsValues();var o=this.getPreset().getFields().map(function(t){return BX.data(t,"name")});var h=this.getPreset().getCurrentPresetData();var d={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER"};var u,c,f,p,g;var B={};B.additional={};if(t!=="tmp_filter"&&t!=="default_filter"&&!n){var E=BX.type.isArray(h.ADDITIONAL)?h.ADDITIONAL:[];E.forEach(function(t){Object.keys(l).forEach(function(e){if(e.indexOf(t.NAME)!==-1){B.additional[e]=l[e];delete l[e]}})})}u=Object.keys(l);if(!s){B.apply_filter="Y"}else{B.clear_filter="Y"}B.save="Y";B.fields=l;B.rows=o.join(",");B.preset_id=t||h.ID;if(BX.type.isNotEmptyString(e)){B.name=BX.util.htmlspecialchars(e)}else{f=this.getPreset().getPresetNodeById(B.preset_id);p=this.getPreset().getPresetInput(f);if(BX.type.isDomNode(p)&&BX.type.isNotEmptyString(p.value)){B.name=p.value}else{B.name=h.TITLE}}if((!("sort"in B)||!BX.type.isNumber(B.sort))&&i){g=this.getParam("PRESETS");B.sort=g.length+2}if(!s){u.forEach(function(t){if(BX.type.isArray(B.fields[t])){c=B.fields[t].length?{}:"";B.fields[t].forEach(function(t,e){c[e]=t},this);if(c||BX.type.isNumber(c)||BX.type.isBoolean(c)){B.fields[t]=c}}},this)}if(B.preset_id==="tmp_filter"||this.isAddPresetEnabled()||s){this.updateParams(B)}if(BX.type.isFunction(r)){r()}var m=new BX.Promise(null,this);m.setAutoResolve("fulfill",0);m.then(function(){var t=new BX.Promise(null,this);this.saveOptions(B,d,BX.proxy(t.fulfill,t));return t}).then(function(){!!a&&a()});return m},saveFieldsSort:function(){var t={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER"};var e=this.getPreset().getFields();var s={};s.preset_id="default_filter";if(BX.type.isArray(e)){s.rows=e.map(function(t){return BX.data(t,"name")});s.rows=s.rows.join(",")}this.updateParams(s);this.saveOptions(s,t)},updateParams:function(t){var e,s;var i=[];if(BX.type.isPlainObject(t)&&"preset_id"in t){e=this.getPreset().getPreset(t.preset_id);if(BX.type.isPlainObject(e)){if("name"in t&&BX.type.isNotEmptyString(t.name)){e.TITLE=t.name}if("rows"in t&&!("fields"in t)){t.fields={};t.rows.split(",").forEach(function(e){t.fields[e]=""})}if("fields"in t){e.FIELDS=this.preparePresetFields(t.fields,t.rows)}if("additional"in t&&e.ID!=="tmp_filter"){e.ADDITIONAL=this.preparePresetFields(t.additional,t.rows)}}else{s=this.getParam("PRESETS");e={ID:t.preset_id,TITLE:t.name,SORT:s.length+2,FIELDS:this.preparePresetFields(t.fields,t.rows)};s.push(e)}}},preparePresetFields:function(t,e){var s,i;var r=[];if(BX.type.isPlainObject(t)){e=BX.type.isNotEmptyString(e)?e.split(","):[];s=e.length?e:Object.keys(t);s.forEach(function(e){e=e.replace("_datesel","").replace("_numsel","");i=BX.clone(this.getFieldByName(e));if(BX.type.isPlainObject(i)){if(i.TYPE===this.types.STRING){i.VALUE=t[e]}if(i.TYPE===this.types.MULTI_SELECT){i.VALUE=this.prepareMultiSelectValue(t[e],i.ITEMS)}if(i.TYPE===this.types.SELECT||i.TYPE===this.types.CHECKBOX){i.VALUE=this.prepareSelectValue(t[e],i.ITEMS)}if(i.TYPE===this.types.DATE){i.SUB_TYPE=this.prepareSelectValue(t[e+"_datesel"],i.SUB_TYPES);i.VALUES={_from:t[e+"_from"],_to:t[e+"_to"],_days:t[e+"_days"],_month:t[e+"_month"],_quarter:t[e+"_quarter"],_year:t[e+"_year"],_allow_year:t[e+"_allow_year"]}}if(i.TYPE===this.types.CUSTOM_DATE){i.VALUE={days:Object.keys(t[e+"_days"]||{}).map(function(s){return t[e+"_days"][s]}),months:Object.keys(t[e+"_months"]||{}).map(function(s){return t[e+"_months"][s]}),years:Object.keys(t[e+"_years"]||{}).map(function(s){return t[e+"_years"][s]})}}if(i.TYPE===this.types.NUMBER){i.SUB_TYPE=this.prepareSelectValue(t[e+"_numsel"],i.SUB_TYPES);i.VALUES={_from:t[e+"_from"],_to:t[e+"_to"]}}if(i.TYPE===this.types.DEST_SELECTOR){if(typeof t[e+"_label"]!=="undefined"){i.VALUES._label=t[e+"_label"]}if(typeof t[e]!=="undefined"){i.VALUES._value=t[e]}}if(i.TYPE===this.types.CUSTOM_ENTITY){if(typeof t[e+"_label"]!=="undefined"){i.VALUES._label=t[e+"_label"]}if(typeof t[e]!=="undefined"){i.VALUES._value=t[e]}}if(i.TYPE===this.types.CUSTOM){i._VALUE=t[e]}r.push(i)}},this)}return r},prepareSelectValue:function(t,e){var s={};var i;if(BX.type.isNotEmptyString(t)&&BX.type.isArray(e)){i=this.prepareMultiSelectValue({0:t},e);s=i.length>0?i[0]:{}}else{s=e[0]}return s},prepareMultiSelectValue:function(t,e){var s=[];if(BX.type.isPlainObject(t)&&BX.type.isArray(e)){var i=Object.keys(t);var r=i.map(function(e){return t[e]});s=e.filter(function(t){return r.some(function(e){return e===t.VALUE})},this)}return s},getFieldByName:function(t){var e=this.getParam("FIELDS");e=e.filter(function(e){return e.NAME===t},this);return e.length>0?e[0]:null},confirmSaveForAll:function(){return new Promise(function(t){var e={CONFIRM:true,CONFIRM_MESSAGE:this.getParam("MAIN_UI_FILTER__CONFIRM_MESSAGE_FOR_ALL"),CONFIRM_APPLY_BUTTON:this.getParam("MAIN_UI_FILTER__CONFIRM_APPLY_FOR_ALL"),CONFIRM_CANCEL_BUTTON:this.getParam("CONFIRM_CANCEL")};this.confirmDialog(e,t)}.bind(this))},saveOptions:function(e,s,i,r){s.action=t(s.action);s.forAll=this.isForAll(r);s.commonPresetsId=this.getParam("COMMON_PRESETS_ID");s.apply_filter=e.apply_filter||"N";s.clear_filter=e.clear_filter||"N";s.with_preset=e.with_preset||"N";s.save=e.save||"N";var a={params:s,data:e};delete e.apply_filter;delete e.save;delete e.clear_filter;delete e.with_preset;if(s.forAll&&s.action==="setFilterArray"){return this.confirmSaveForAll().then(function(){return this.backend(s.action,a)}.bind(this)).then(function(){this.disableEdit();this.disableAddPreset()}.bind(this))}return this.backend(s.action,a).then(function(){BX.removeClass(this.getFindButton(),this.settings.classWaitButtonClass);BX.type.isFunction(i)&&i()}.bind(this))},backend:function(t,e){return BX.ajax.runComponentAction("bitrix:main.ui.filter",t,{mode:"ajax",data:e,analyticsLabel:{FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID")}})},prepareEvent:function(t){var e,s;if(!("path"in t)||!t.path.length){t.path=[t.target];e=0;while((s=t.path[e++].parentNode)!==null){t.path.push(s)}}return t},restoreRemovedPreset:function(){if(this.getParam("VALUE_REQUIRED_MODE")){var t=this.getParam("CURRENT_PRESET");if(BX.type.isPlainObject(t)){var e=t.ID;var s=this.getPreset().getPresetNodeById(e);this.getPreset().applyPreset(e);this.getPreset().activatePreset(s)}}},hasScrollClick:function(t){var e="clientX"in t?t.clientX:"x"in t?t.x:0;return e>=document.documentElement.offsetWidth},isUseCommonPresets:function(){return!!this.getParam("COMMON_PRESETS_ID")},isInsideFilterEvent:function(t){t=this.prepareEvent(t);return(t.path||[]).some(function(t){return BX.type.isDomNode(t)&&(BX.hasClass(t,this.settings.classFilterContainer)||BX.hasClass(t,this.settings.classSearchContainer)||BX.hasClass(t,this.settings.classDefaultPopup)||BX.hasClass(t,this.settings.classPopupOverlay))},this)},_onDocumentClick:function(t){var e=this.getPopup();if(!this.isInsideFilterEvent(t)&&!this.hasScrollClick(t)){if(e&&e.isShown()){this.closePopup();if(this.getParam("VALUE_REQUIRED_MODE")){this.restoreRemovedPreset()}if(this.getParam("VALUE_REQUIRED")){if(!this.getSearch().getSquares().length){this.getPreset().applyPinnedPreset()}}}BX.onCustomEvent(window,"BX.Main.Filter:blur",[this])}},_onAddFieldClick:function(t){var e=this.getFieldsPopup();t.stopPropagation();t.preventDefault();if(e&&!e.isShown()){this.showFieldsPopup();this.syncFields()}else{this.closeFieldListPopup()}},syncFields:function(t){if(BX.type.isPlainObject(t)){if(t.cache===false){this.fieldsPopupItems=null}}var e=this.getPreset().getFields();var s=this.getFieldsPopupItems();var i,r;if(BX.type.isArray(s)&&s.length){s.forEach(function(t){i=BX.data(t,"name").replace("_datesel","").replace("_numsel","");r=e.some(function(t){return BX.data(t,"name")===i});if(r){BX.addClass(t,this.settings.classMenuItemChecked)}else{BX.removeClass(t,this.settings.classMenuItemChecked)}},this)}},getFieldsPopupItems:function(){if(!BX.type.isArray(this.fieldsPopupItems)){var t=this.getFieldsPopup();if("contentContainer"in t&&BX.type.isDomNode(t.contentContainer)){this.fieldsPopupItems=BX.Filter.Utils.getByClass(t.contentContainer,this.settings.classMenuItem,true)}}return this.fieldsPopupItems},getFieldListContainerClassName:function(t){var e=this.settings.classPopupFieldList1Column;if(t>6&&t<12){e=this.settings.classPopupFieldList2Column}if(t>12){e=this.settings.classPopupFieldList3Column}return e},prepareFieldsDecl:function(t){return(t||[]).map(function(t){return{block:"main-ui-filter-field-list-item",label:"LABEL"in t?t.LABEL:"",id:"ID"in t?t.ID:"",name:"NAME"in t?t.NAME:"",item:t,onClick:BX.delegate(this._clickOnFieldListItem,this)}},this)},getLazyLoadFields:function(){var t=new BX.Promise;BX.ajax({method:"GET",url:this.getParam("LAZY_LOAD")["GET_LIST"],dataType:"json",onsuccess:function(e){t.fulfill(e)}});return t},getFieldsListPopupContent:function(){var t=new BX.Promise;var e=this.getParam("FIELDS");var s=BX.type.isArray(e)?e.length:0;if(this.getParam("LAZY_LOAD")){this.getLazyLoadFields().then(function(e){var s={block:this.settings.classPopupFieldList,mix:this.getFieldListContainerClassName(e.length),content:this.prepareFieldsDecl(e)};t.fulfill(BX.decl(s))}.bind(this));return t}var i={block:this.settings.classPopupFieldList,mix:this.getFieldListContainerClassName(s),content:this.prepareFieldsDecl(e)};t.fulfill(BX.decl(i));return t},getFieldLoader:function(){if(!this.fieldLoader){this.fieldLoader=new BX.Loader({mode:"custom",size:18,offset:{left:"5px",top:"5px"}})}return this.fieldLoader},_clickOnFieldListItem:function(t){var e=t.target;var s;if(!BX.hasClass(e,this.settings.classFieldListItem)){e=BX.findParent(e,{className:this.settings.classFieldListItem},true,false)}if(BX.type.isDomNode(e)){try{s=JSON.parse(BX.data(e,"item"))}catch(t){}var i=new BX.Promise;if(this.getParam("LAZY_LOAD")){this.getFieldLoader().show(e);var r=e.querySelector(".main-ui-select-inner-label");if(r){r.classList.add("main-ui-no-before")}this.getLazyLoadField(s.NAME).then(function(t){i.fulfill(t);this.getFieldLoader().hide();if(r){r.classList.remove("main-ui-no-before")}}.bind(this))}else{i.fulfill(s)}i.then(function(t){this.params.FIELDS.push(t);if(BX.hasClass(e,this.settings.classMenuItemChecked)){BX.removeClass(e,this.settings.classMenuItemChecked);this.getPreset().removeField(t)}else{if(BX.type.isPlainObject(t)){this.getPreset().addField(t);BX.addClass(e,this.settings.classMenuItemChecked);if(BX.type.isString(t.HTML)){var s=BX.create("div");this.getHiddenElement().appendChild(s);BX.html(s,t.HTML)}}}this.syncFields()}.bind(this))}},getHiddenElement:function(){if(!this.hiddenElement){this.hiddenElement=BX.create("div");document.body.appendChild(this.hiddenElement)}return this.hiddenElement},getLazyLoadField:function(t){var e=new BX.Promise;BX.ajax({method:"get",url:BX.util.add_url_param(this.getParam("LAZY_LOAD")["GET_FIELD"],{id:t}),dataType:"json",onsuccess:function(t){e.fulfill(t)}});return e},showFieldsPopup:function(){var t=this.getFieldsPopup();this.adjustFieldListPopupPosition();t.show()},closeFieldListPopup:function(){var t=this.getFieldsPopup();t.close()},adjustFieldListPopupPosition:function(){var t=this.getFieldsPopup();var e=BX.pos(this.getAddField());e.forceBindPosition=true;t.adjustPosition(e)},getFieldsPopup:function(){var t=this.getAddField();if(!this.fieldsPopup){this.fieldsPopup=new BX.PopupWindow(this.getParam("FILTER_ID")+"_fields_popup",t,{autoHide:true,offsetTop:4,offsetLeft:0,lightShadow:true,closeIcon:false,closeByEsc:false,noAllPaddings:true,zIndex:13});this.fieldsPopupLoader=new BX.Loader({target:this.fieldsPopup.contentContainer});this.fieldsPopupLoader.show();this.fieldsPopup.contentContainer.style.width="630px";this.fieldsPopup.contentContainer.style.height="330px";this.getFieldsListPopupContent().then(function(t){this.fieldsPopup.contentContainer.removeAttribute("style");this.fieldsPopupLoader.hide();this.fieldsPopup.setContent(t);this.syncFields({cache:false})}.bind(this))}return this.fieldsPopup},_onAddPresetClick:function(){this.enableAddPreset()},enableWaitSate:function(t){!!t&&BX.addClass(t,this.settings.classWaitButtonClass)},disableWaitState:function(t){!!t&&BX.removeClass(t,this.settings.classWaitButtonClass)},_onSaveButtonClick:function(){var t=!!this.getSaveForAllCheckbox()&&this.getSaveForAllCheckbox().checked;var e=this.getPreset().getAddPresetFieldInput();var s=e.parentNode.querySelector(".main-ui-filter-edit-mask");var i;function r(t){if(t.animationName==="fieldError"){t.currentTarget.removeEventListener("animationend",r);t.currentTarget.removeEventListener("oAnimationEnd",r);t.currentTarget.removeEventListener("webkitAnimationEnd",r);t.currentTarget.classList.remove("main-ui-filter-error")}}function a(t){t.addEventListener("animationend",r);t.addEventListener("oAnimationEnd",r);t.addEventListener("webkitAnimationEnd",r);t.classList.add("main-ui-filter-error");var e=new BX.Promise;e.fulfill(true);return e}this.enableWaitSate(this.getFindButton());if(this.isAddPresetEnabled()&&!t){i=e.value;if(i.length){this.savePreset();this.disableAddPreset()}else{a(s).then(function(){e.focus()})}}if(this.isEditEnabled()){var n=this.getPreset();var l=n.getPresetNodeById(n.getCurrentPresetId());var o=n.getPresetInput(l);if(o.value.length){n.updateEditablePreset(n.getCurrentPresetId());this.saveUserSettings(t);!t&&this.disableEdit()}else{var h=l.querySelector(".main-ui-filter-edit-mask");a(h).then(function(){o.focus()})}}},_onCancelButtonClick:function(){this.disableAddPreset();this.getPreset().clearAddPresetFieldInput();this.disableEdit();!!this.getSaveForAllCheckbox()&&(this.getSaveForAllCheckbox().checked=null)},_onGridReady:function(t){if(!this.grid&&t.getContainerId()===this.getParam("GRID_ID")){this.grid=t}},_onFilterMousedown:function(t){var e=t.target;if(this.getFields().isDragButton(e)){var s=BX.Filter.Utils.getByTag(e.parentNode,"input",true);(s||[]).forEach(function(t){BX.fireEvent(t,"blur")});BX.fireEvent(this.getFilter(),"click")}},_onFilterClick:function(t){var e=this.getFields();var s=this.getPreset();var i;if(e.isFieldDelete(t.target)){i=e.getField(t.target);s.removeField(i)}if(e.isFieldValueDelete(t.target)){i=e.getField(t.target);e.clearFieldValue(i)}},getButtonsContainer:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classButtonsContainer)},getSaveButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classSaveButton)},getCancelButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classCancelButton)},getFindButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classFindButton)},getResetButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classResetButton)},getAddPresetButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classAddPresetButton)},isAddPresetEnabled:function(){return this.isAddPresetModeState},enableAddPreset:function(){var t=this.getPreset();var e=t.getAddPresetField();var s=t.getAddPresetFieldInput();var i=this.getButtonsContainer();BX.show(e);BX.show(i);BX.hide(this.getPresetButtonsContainer());this.hideForAllCheckbox();if(BX.type.isDomNode(s)){s.focus()}BX.addClass(this.getSidebarControlsContainer(),this.settings.classDisabled);this.isAddPresetModeState=true},disableAddPreset:function(){var t=this.getPreset();var e=t.getAddPresetField();var s=this.getButtonsContainer();BX.hide(e);BX.hide(s);BX.show(this.getPresetButtonsContainer());this.showForAllCheckbox();t.getAddPresetFieldInput().value="";BX.removeClass(this.getSidebarControlsContainer(),this.settings.classDisabled);this.isAddPresetModeState=false},getControls:function(){var t=this.getFieldListContainer();var e=null;if(BX.type.isDomNode(t)){e=BX.Filter.Utils.getByClass(t,this.settings.classControl,true)}return e},getFilterFields:function(){var t=this.getFieldListContainer();var e=[];var s=[];if(BX.type.isDomNode(t)){e=BX.Filter.Utils.getByClass(t,this.settings.classField,true);s=BX.Filter.Utils.getByClass(t,this.settings.classFieldGroup,true);if(!BX.type.isArray(e)){e=[]}if(BX.type.isArray(s)){s.forEach(function(t){e.push(t)})}}return e},getFilterFieldsValues:function(){var t=this.getPreset().getFields();var e=this.getSearch();var s={};var i,r;s["FIND"]=e.getInput().value;if(BX.type.isArray(t)&&t.length){t.forEach(function(t){i=BX.data(t,"type");r=BX.data(t,"name");switch(i){case this.types.STRING:{this.prepareControlStringValue(s,t);break}case this.types.NUMBER:{this.prepareControlNumberValue(s,r,t);break}case this.types.DATE:{this.prepareControlDateValue(s,r,t);break}case this.types.CUSTOM_DATE:{this.prepareControlCustomDateValue(s,r,t);break}case this.types.SELECT:{this.prepareControlSelectValue(s,r,t);break}case this.types.MULTI_SELECT:{this.prepareControlMultiselectValue(s,r,t);break}case this.types.DEST_SELECTOR:{this.prepareControlCustomEntityValue(s,r,t);break}case this.types.CUSTOM:{this.prepareControlCustomValue(s,r,t);break}case this.types.CUSTOM_ENTITY:{this.prepareControlCustomEntityValue(s,r,t);break}default:{break}}},this)}return s},prepareControlCustomEntityValue:function(t,e,s){var i=this.fetchSquares(s);var r=this.fetchSquaresData(i);var a=BX.Main.ui.CustomEntity.isMultiple(s);t[e]="";t[e+"_label"]="";if(a){t[e]=[];t[e+"_label"]=[];!!r&&r.forEach(function(s){t[e].push(s._value.toString());t[e+"_label"].push(s._label.toString())})}else{if(r.length){t[e]=r[0]._value.toString();t[e+"_label"]=r[0]._label.toString()}}},fetchSquares:function(t){return!!t?BX.Filter.Utils.getByClass(t,this.settings.classSquare,true):[]},fetchSquaresData:function(t){return t.map(function(t){return JSON.parse(BX.data(t,"item"))},this)},prepareControlCustomValue:function(t,e,s){var i=BX.Filter.Utils.getByTag(s,"input",true);t[e]="";if(BX.type.isArray(i)){i.forEach(function(e){if(BX.type.isNotEmptyString(e.name)){t[e.name]=e.value}})}},prepareControlMultiselectValue:function(t,e,s){var i=BX.Filter.Utils.getByClass(s,this.settings.classMultiSelect);var r=JSON.parse(BX.data(i,"value"));t[e]="";if(BX.type.isArray(r)&&r.length){t[e]={};r.forEach(function(s,i){t[e][i]=s.VALUE})}},prepareControlSelectValue:function(t,e,s){var i=BX.Filter.Utils.getByClass(s,this.settings.classSelect);var r=JSON.parse(BX.data(i,"value"));t[e]=r.VALUE},prepareControlCustomDateValue:function(t,e,s){var i=s.querySelector('[data-name="'+e+"_days"+'"]');if(i){var r=JSON.parse(i.dataset.value);t[e+"_days"]=r.map(function(t){return t.VALUE})}var a=s.querySelector('[data-name="'+e+"_months"+'"]');if(a){var n=JSON.parse(a.dataset.value);t[e+"_months"]=n.map(function(t){return t.VALUE})}var l=s.querySelector('[data-name="'+e+"_years"+'"]');if(l){var o=JSON.parse(l.dataset.value);t[e+"_years"]=o.map(function(t){return t.VALUE})}},prepareControlDateValue:function(t,e,s){var i=BX.Filter.Utils.getByClass(s,this.settings.classSelect);var r=s.querySelector('.main-ui-select[data-name*="_allow_year"]');var a=e+this.settings.datePostfix;var n=e+this.settings.fromPostfix;var l=e+this.settings.toPostfix;var o=e+this.settings.daysPostfix;var h=e+this.settings.monthPostfix;var d=e+this.settings.quarterPostfix;var u=e+this.settings.yearPostfix;var c=e+"_allow_year";var f,p,g,B,E;t[a]="";t[n]="";t[l]="";t[o]="";t[h]="";t[d]="";t[u]="";var m=s.querySelector(".main-ui-date-input");if(m&&m.dataset.isValid==="false"){return}f=JSON.parse(BX.data(i,"value"));t[a]=f.VALUE;if(r){E=JSON.parse(BX.data(r,"value"));t[c]=E.VALUE}switch(f.VALUE){case this.dateTypes.EXACT:{p=BX.Filter.Utils.getByClass(s,this.settings.classDateInput);t[n]=p.value;t[l]=p.value;break}case this.dateTypes.QUARTER:{g=BX.Filter.Utils.getByClass(s,this.settings.classControl,true);if(BX.type.isArray(g)){g.forEach(function(e){B=BX.data(e,"name");if(B&&B.indexOf("_quarter")!==-1){t[d]=JSON.parse(BX.data(e,"value")).VALUE}if(B&&B.indexOf("_year")!==-1){t[u]=JSON.parse(BX.data(e,"value")).VALUE}},this)}break}case this.dateTypes.YEAR:{g=BX.Filter.Utils.getByClass(s,this.settings.classControl,true);if(BX.type.isArray(g)){g.forEach(function(e){B=BX.data(e,"name");if(B&&B.indexOf("_year")!==-1){t[u]=JSON.parse(BX.data(e,"value")).VALUE}},this)}break}case this.dateTypes.MONTH:{g=BX.Filter.Utils.getByClass(s,this.settings.classControl,true);if(BX.type.isArray(g)){g.forEach(function(e){B=BX.data(e,"name");if(B&&B.indexOf("_month")!==-1){t[h]=JSON.parse(BX.data(e,"value")).VALUE}if(B&&B.indexOf("_year")!==-1){t[u]=JSON.parse(BX.data(e,"value")).VALUE}},this)}break}case this.additionalDateTypes.PREV_DAY:case this.additionalDateTypes.NEXT_DAY:case this.additionalDateTypes.MORE_THAN_DAYS_AGO:case this.additionalDateTypes.AFTER_DAYS:case this.dateTypes.NEXT_DAYS:case this.dateTypes.PREV_DAYS:{var P=BX.Filter.Utils.getByClass(s,this.settings.classNumberInput);if(!!P&&P.name===o){t[o]=P.value}break}case this.dateTypes.RANGE:{p=BX.Filter.Utils.getByClass(s,this.settings.classDateInput,true);p.forEach(function(e){if(e.name===n){t[n]=e.value}else if(e.name===l){t[l]=e.value}},this);break}case"CUSTOM_DATE":{var y={};this.prepareControlCustomDateValue(y,e,s);t[e+"_days"]=y[e+"_days"];t[h]=y[e+"_months"];t[u]=y[e+"_years"];break}default:{break}}},prepareControlNumberValue:function(t,e,s){var i=BX.Filter.Utils.getByClass(s,this.settings.classNumberInput,true);var r=BX.Filter.Utils.getByClass(s,this.settings.classSelect);var a=e+this.settings.numberPostfix;var n=e+this.settings.fromPostfix;var l=e+this.settings.toPostfix;var o;t[n]="";t[l]="";o=JSON.parse(BX.data(r,"value"));t[a]=o.VALUE;i.forEach(function(e){if(e.name.indexOf(this.settings.fromPostfix)!==-1){t[n]=e.value||"";if(t[a]==="exact"){t[l]=e.value||""}}else if(e.name.indexOf(this.settings.toPostfix)!==-1){t[l]=e.value||""}},this)},prepareControlStringValue:function(t,e){var s=BX.Filter.Utils.getByClass(e,this.settings.classStringInput);var i;if(BX.type.isDomNode(s)){i=s.name;t[i]=s.value}},showGridAnimation:function(){this.grid&&this.grid.tableFade()},hideGridAnimation:function(){this.grid&&this.grid.tableUnfade()},getPresetId:function(t,e){var s=this.getPreset().getCurrentPresetId();if(!this.isEditEnabled()&&!this.isAddPresetEnabled()&&!e||s==="default_filter"&&!t){s="tmp_filter"}return s},applyFilter:function(t,e){var s=this.getPresetId(t,e);var i=this.getParam("FILTER_ID");var r=new BX.Promise(null,this);var a=this.getPreset();var n=this.getSearch();var l={autoResolve:!this.grid};var o=this;this.clearGet();this.showGridAnimation();var h=t?"clear":"apply";BX.onCustomEvent(window,"BX.Main.Filter:beforeApply",[i,{action:h},this,r]);this.updatePreset(s,null,t,null).then(function(){n.updatePreset(a.getPreset(s));if(o.getParam("VALUE_REQUIRED")){if(!n.getSquares().length){o.lastPromise=a.applyPinnedPreset()}}}).then(function(){var t={apply_filter:"Y",clear_nav:"Y"};var e=BX.delegate(r.fulfill,r);var s=BX.delegate(r.reject,r);o.grid&&o.grid.reloadTable("POST",t,e,s);BX.onCustomEvent(window,"BX.Main.Filter:apply",[i,{action:h},o,r,l]);l.autoResolve&&r.fulfill()});return r},getAddField:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classAddField)},getFieldListContainer:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classFileldControlList)},getFields:function(){if(!(this.fields instanceof BX.Filter.Fields)){this.fields=new BX.Filter.Fields(this)}return this.fields},getPreset:function(){if(!(this.presets instanceof BX.Filter.Presets)){this.presets=new BX.Filter.Presets(this)}return this.presets},resetControlData:function(t){if(BX.type.isPlainObject(t)){switch(t.TYPE){case this.types.MULTI_SELECT:{t.VALUE=[];break}case this.types.SELECT:{t.VALUE=t.ITEMS[0];break}case this.types.DATE:{t.SUB_TYPE=t.SUB_TYPES[0];t.VALUES={_from:"",_to:"",_days:"",_quarter:"",_year:""};break}case this.types.CUSTOM_DATE:{t.VALUES={days:[],months:[],years:[]};break}case this.types.NUMBER:{t.SUB_TYPE=t.SUB_TYPES[0];t.VALUES={_from:"",_to:""};break}case this.types.DEST_SELECTOR:{t.VALUES={_label:"",_value:""};break}case this.types.CUSTOM_ENTITY:{t.VALUES={_label:"",_value:""};break}case this.types.CUSTOM:{t._VALUE="";break}default:{t.VALUE=""}}}return t},clearControl:function(t){var e=this.getPreset().getField({NAME:t});var s,i;if(BX.type.isDomNode(e)){s=this.getFieldByName(t);s=this.resetControlData(s);i=this.getPreset().createControl(s);BX.insertAfter(i,e);BX.remove(e)}},clearControls:function(t){if(BX.type.isArray(t)){t.forEach(function(t){"name"in t&&this.clearControl(t.name)},this)}else if(BX.type.isPlainObject(t)&&"name"in t){this.clearControl(t.name)}},getTemplate:function(){return BX.html(BX(this.settings.generalTemplateId))},isIe:function(){if(!BX.type.isBoolean(this.ie)){this.ie=BX.hasClass(document.documentElement,"bx-ie")}return this.ie},closePopup:function(){var t=this.getPopup();var e=t.popupContainer;var s=this.settings.get("FILTER_CLOSE_DELAY");var i;setTimeout(BX.delegate(function(){if(!this.isIe()){BX.removeClass(e,this.settings.classAnimationShow);BX.addClass(e,this.settings.classAnimationClose);i=parseFloat(BX.style(e,"animation-duration"));if(BX.type.isNumber(i)){i=i*1e3}setTimeout(function(){t.close()},i)}else{t.close()}},this),s);this.closeFieldListPopup();this.adjustFocus()},showPopup:function(){var t=this.getPopup();var e;if(!t.isShown()){this.isOpened=true;var s=this.settings.get("FILTER_SHOW_DELAY");setTimeout(BX.delegate(function(){t.show();if(!this.isIe()){e=t.popupContainer;BX.removeClass(e,this.settings.classAnimationClose);BX.addClass(e,this.settings.classAnimationShow);BX.onCustomEvent(window,"BX.Main.Filter:show",[this])}},this),s)}},getSaveForAllCheckbox:function(){if(!this.saveForAllCheckbox&&!!this.getSaveForAllCheckboxContainer()){this.saveForAllCheckbox=BX.Filter.Utils.getBySelector(this.getSaveForAllCheckboxContainer(),'input[type="checkbox"]')}return this.saveForAllCheckbox},getSaveForAllCheckboxContainer:function(){if(!this.saveForAllCheckboxContainer){this.saveForAllCheckboxContainer=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classForAllCheckbox)}return this.saveForAllCheckboxContainer},showForAllCheckbox:function(){!!this.getSaveForAllCheckboxContainer()&&BX.removeClass(this.getSaveForAllCheckboxContainer(),this.settings.classHide)},hideForAllCheckbox:function(){!!this.getSaveForAllCheckboxContainer()&&BX.addClass(this.getSaveForAllCheckboxContainer(),this.settings.classHide)},getPopupBindElement:function(){if(!this.popupBindElement){var t=this.settings.get("POPUP_BIND_ELEMENT_SELECTOR");var e=null;if(BX.type.isNotEmptyString(t)){e=BX.Filter.Utils.getBySelector(document,t)}this.popupBindElement=!!e?e:this.getSearch().getContainer()}return this.popupBindElement},getPopup:function(){if(!(this.popup instanceof BX.PopupWindow)){this.popup=new BX.PopupWindow(this.getParam("FILTER_ID")+this.settings.searchContainerPostfix,this.getPopupBindElement(),{autoHide:false,offsetTop:parseInt(this.settings.get("POPUP_OFFSET_TOP")),offsetLeft:parseInt(this.settings.get("POPUP_OFFSET_LEFT")),lightShadow:true,closeIcon:false,closeByEsc:false,noAllPaddings:true,zIndex:12});this.popup.setContent(this.getTemplate());BX.bind(this.getFieldListContainer(),"keydown",BX.delegate(this._onFieldsContainerKeydown,this));BX.bind(this.getFilter(),"click",BX.delegate(this._onFilterClick,this));BX.bind(this.getAddPresetButton(),"click",BX.delegate(this._onAddPresetClick,this));BX.bind(this.getPreset().getAddPresetFieldInput(),"keydown",BX.delegate(this._onAddPresetKeydown,this));BX.bind(this.getPreset().getContainer(),"keydown",BX.delegate(this._onPresetInputKeydown,this));BX.bind(this.getSaveButton(),"click",BX.delegate(this._onSaveButtonClick,this));BX.bind(this.getCancelButton(),"click",BX.delegate(this._onCancelButtonClick,this));BX.bind(this.getFindButton(),"click",BX.delegate(this._onFindButtonClick,this));BX.bind(this.getResetButton(),"click",BX.delegate(this._onResetButtonClick,this));BX.bind(this.getAddField(),"click",BX.delegate(this._onAddFieldClick,this));BX.bind(this.getEditButton(),"click",BX.delegate(this._onEditButtonClick,this));BX.bind(this.getRestoreButton(),"click",BX.delegate(this._onRestoreButtonClick,this));BX.bind(this.getRestoreFieldsButton(),"click",BX.delegate(this._onRestoreFieldsButtonClick,this));this.getFilter().addEventListener("mousedown",BX.delegate(this._onFilterMousedown,this),true);this.getPreset().showCurrentPresetFields();this.getPreset().bindOnPresetClick()}return this.popup},_onRestoreFieldsButtonClick:function(){this.restoreDefaultFields()},restoreDefaultFields:function(){var t=this.getPreset().getPreset("default_filter",true);var e=this.getParam("PRESETS");var s=this.getPreset().getCurrentPresetId();var i={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"SET_FILTER"};var r=t.FIELDS.map(function(t){return t.NAME});var a=r.join(",");e.forEach(function(s,i){if(s.ID==="default_filter"){e[i]=BX.clone(t)}},this);if(BX.type.isArray(this.editablePresets)){this.editablePresets.forEach(function(e,s){if(e.ID==="default_filter"){this.editablePresets[s]=BX.clone(t)}},this)}this.getPreset().applyPreset(s);this.updatePreset(s);this.saveOptions({preset_id:"default_filter",rows:a,save:"Y",apply_filter:"N"},i)},getRestoreFieldsButton:function(){if(!this.restoreFieldsButton){this.restoreFieldsButton=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classRestoreFieldsButton)}return this.restoreFieldsButton},restoreFilter:function(){var t=this.getParam("DEFAULT_PRESETS");var e=this.getParam("PRESETS");var s=false;var i,r,a;if(BX.type.isArray(t)){t.sort(function(t,e){return t.SORT<e.SORT});t.forEach(function(t){s=e.some(function(e,s){if(e.ID===t.ID){i=s;return true}});if(s){e[i]=BX.clone(t)}else{e.push(BX.clone(t))}if(t.ID!=="default_filter"){this.addSidebarItem(t.ID,t.TITLE,t.PINNED);if(t.PINNED){r=t.ID}}},this)}this.saveRestoreFilter();this.disableAddPreset();this.disableEdit();if(!r){r="default_filter"}a=this.getPreset().getPresetNodeById(r);if(a){BX.fireEvent(a,"click")}},saveRestoreFilter:function(){var t={FILTER_ID:this.getParam("FILTER_ID"),GRID_ID:this.getParam("GRID_ID"),action:"RESTORE_FILTER"};var e=this.getParam("PRESETS");var s={};var i;if(BX.type.isArray(e)){e.forEach(function(t){i=t.FIELDS.map(function(t){return t.NAME});i=i.join(",");s[t.ID]={name:t.TITLE||null,sort:t.SORT,preset_id:t.ID,fields:this.prepareFields(t.FIELDS),rows:i,for_all:t.FOR_ALL}},this);this.saveOptions(s,t)}},prepareFields:function(t){var e={};var s;if(BX.type.isArray(t)){t.forEach(function(t){if(t.TYPE===this.types.SELECT){e[t.NAME]="VALUE"in t.VALUE?t.VALUE.VALUE:""}if(t.TYPE===this.types.MULTI_SELECT){t.VALUE.forEach(function(s,i){e[t.NAME]=e[t.NAME]||{};e[t.NAME][i]=s.VALUE});e[t.NAME]=e[t.NAME]||""}if(t.TYPE===this.types.DATE||t.TYPE===this.types.NUMBER){s=Object.keys(t.VALUES);s.forEach(function(s){e[t.NAME+s]=t.VALUES[s]});if(t.TYPE===this.types.DATE){e[t.NAME+"_datesel"]="VALUE"in t.SUB_TYPE?t.SUB_TYPE.VALUE:t.SUB_TYPES[0].VALUE}if(t.TYPE===this.types.NUMBER){e[t.NAME+"_numsel"]="VALUE"in t.SUB_TYPE?t.SUB_TYPE.VALUE:t.SUB_TYPES[0].VALUE}}if(t.TYPE===this.types.DEST_SELECTOR){e[t.NAME+"_label"]=t.VALUES._label;e[t.NAME+"_value"]=t.VALUES._value}if(t.TYPE===this.types.CUSTOM_ENTITY){e[t.NAME+"_label"]=t.VALUES._label;e[t.NAME+"_value"]=t.VALUES._value}},this)}return e},getRestoreButton:function(){if(!BX.type.isDomNode(this.restoreButton)){this.restoreButton=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classRestoreButton)}return this.restoreButton},_onPresetInputKeydown:function(t){if(BX.Filter.Utils.isKey(t,"enter")&&t.target.tagName==="INPUT"){BX.fireEvent(this.getSaveButton(),"click")}},_onFieldsContainerKeydown:function(t){if(BX.Filter.Utils.isKey(t,"enter")&&t.target.tagName==="INPUT"){BX.fireEvent(this.getFindButton(),"click")}},_onFindButtonClick:function(){var t=this.getPreset();var e=t.getCurrentPresetId();var s;if(e!=="tmp_filter"&&e!=="default_filter"&&!t.isPresetValuesModified(e)){var i=t.getPreset(e);var r=t.getAdditionalValues(e);var a=t.getFields().map(function(t){return BX.data(t,"name")});i.ADDITIONAL=this.preparePresetFields(r,a);i.ADDITIONAL=i.ADDITIONAL.filter(function(t){return!this.getPreset().isEmptyField(t)},this);t.applyPreset(e);s=this.applyFilter(false,e);this.closePopup()}else{t.deactivateAllPresets();s=this.applyFilter();this.closePopup()}return s},_onResetButtonClick:function(){if(this.getParam("VALUE_REQUIRED")){var t=this.getPreset().getCurrentPresetData();if(t.ADDITIONAL.length){this.closePopup()}BX.fireEvent(this.getSearch().getClearButton(),"click")}else{if(this.getParam("RESET_TO_DEFAULT_MODE")){this.getSearch().clearInput();this.getPreset().applyPinnedPreset()}else{this.resetFilter()}this.closePopup()}},resetFilter:function(t){var e=this.getSearch();var s=this.getPreset();if(!t){e.clearInput()}e.removePreset();s.deactivateAllPresets();s.resetPreset(true);e.hideClearButton();e.adjustPlaceholder();return this.applyFilter(true,true)},_onEditButtonClick:function(){if(!this.isEditEnabled()){this.enableEdit()}else{this.disableEdit()}},enableFieldsDragAndDrop:function(){var t=this.getPreset().getFields();this.fieldsList=[];if(BX.type.isArray(t)){this.fieldsList=t.map(this.registerDragItem,this)}},registerDragItem:function(t){var e=this.getDragButton(t);e.onbxdragstart=BX.delegate(this._onFieldDragStart,this);e.onbxdragstop=BX.delegate(this._onFieldDragStop,this);e.onbxdrag=BX.delegate(this._onFieldDrag,this);jsDD.registerObject(e);jsDD.registerDest(e);return t},unregisterDragItem:function(t){var e=this.getDragButton(t);jsDD.unregisterObject(e);jsDD.unregisterDest(e)},_onFieldDragStart:function(){this.dragItem=this.getFields().getField(jsDD.current_node);this.dragIndex=BX.Filter.Utils.getIndex(this.fieldsList,this.dragItem);this.dragRect=this.dragItem.getBoundingClientRect();this.offset=this.dragRect.height;this.dragStartOffset=jsDD.start_y-(this.dragRect.top+BX.scrollTop(window));BX.Filter.Utils.styleForEach(this.fieldsList,{transition:"100ms"});BX.addClass(this.dragItem,this.settings.classPresetOndrag);BX.bind(document,"mousemove",BX.delegate(this._onMouseMove,this))},_onFieldDragStop:function(){BX.unbind(document,"mousemove",BX.delegate(this._onMouseMove,this));BX.removeClass(this.dragItem,this.settings.classPresetOndrag);BX.Filter.Utils.styleForEach(this.fieldsList,{transition:"",transform:""});BX.Filter.Utils.collectionSort(this.dragItem,this.targetItem);this.fieldsList=this.getPreset().getFields();this.saveFieldsSort()},_onFieldDrag:function(){var t=this;var e,s;this.dragOffset=this.realY-this.dragRect.top-this.dragStartOffset;this.sortOffset=t.realY+BX.scrollTop(window);BX.Filter.Utils.styleForEach([this.dragItem],{transition:"0ms",transform:"translate3d(0px, "+this.dragOffset+"px, 0px)"});this.fieldsList.forEach(function(i,r){if(i){e=i.getBoundingClientRect();s=e.top+BX.scrollTop(window)+e.height/2;if(r>t.dragIndex&&t.sortOffset>s&&i.style.transform!=="translate3d(0px, "+-t.offset+"px, 0px)"&&i.style.transform!==""){t.targetItem=i;BX.style(i,"transform","translate3d(0px, "+-t.offset+"px, 0px)");BX.style(i,"transition","300ms")}if(r<t.dragIndex&&t.sortOffset<s&&i.style.transform!=="translate3d(0px, "+t.offset+"px, 0px)"&&i.style.transform!==""){t.targetItem=i;BX.style(i,"transform","translate3d(0px, "+t.offset+"px, 0px)");BX.style(i,"transition","300ms")}if((r<t.dragIndex&&t.sortOffset>s||r>t.dragIndex&&t.sortOffset<s)&&i.style.transform!=="translate3d(0px, 0px, 0px)"){if(i.style.transform!==""){t.targetItem=i}BX.style(i,"transform","translate3d(0px, 0px, 0px)");BX.style(i,"transition","300ms")}}})},disableFieldsDragAndDrop:function(){if(BX.type.isArray(this.fieldsList)&&this.fieldsList.length){this.fieldsList.map(this.unregisterDragItem,this)}},enablePresetsDragAndDrop:function(){var t,e,s,i;t=this.getPreset();e=t.getPresets();this.presetsList=[];if(BX.type.isArray(e)&&e.length){e.forEach(function(e){i=t.getPresetId(e);if(!BX.hasClass(e,this.settings.classAddPresetField)&&i!=="default_filter"&&!BX.hasClass(e,this.settings.classDefaultFilter)){s=this.getDragButton(e);s.onbxdragstart=BX.delegate(this._onDragStart,this);s.onbxdragstop=BX.delegate(this._onDragStop,this);s.onbxdrag=BX.delegate(this._onDrag,this);jsDD.registerObject(s);jsDD.registerDest(s);this.presetsList.push(e)}},this)}},getDragButton:function(t){return BX.Filter.Utils.getByClass(t,this.settings.classPresetDragButton)},disablePresetsDragAndDrop:function(){if(BX.type.isArray(this.presetsList)&&this.presetsList.length){this.presetsList.forEach(function(t){if(!BX.hasClass(t,this.settings.classAddPresetField)){jsDD.unregisterObject(t);jsDD.unregisterDest(t)}},this)}},_onDragStart:function(){this.dragItem=this.getPreset().normalizePreset(jsDD.current_node);this.dragIndex=BX.Filter.Utils.getIndex(this.presetsList,this.dragItem);this.dragRect=this.dragItem.getBoundingClientRect();this.offset=this.dragRect.height;this.dragStartOffset=jsDD.start_y-(this.dragRect.top+BX.scrollTop(window));BX.Filter.Utils.styleForEach(this.list,{transition:"100ms"});BX.addClass(this.dragItem,this.settings.classPresetOndrag);BX.bind(document,"mousemove",BX.delegate(this._onMouseMove,this))},_onMouseMove:function(t){this.realX=t.clientX;this.realY=t.clientY},getDragOffset:function(){return jsDD.x-this.startDragOffset-this.dragRect.left},_onDragStop:function(){var t,e;BX.unbind(document,"mousemove",BX.delegate(this._onMouseMove,this));BX.removeClass(this.dragItem,this.settings.classPresetOndrag);BX.Filter.Utils.styleForEach(this.presetsList,{transition:"",transform:""});BX.Filter.Utils.collectionSort(this.dragItem,this.targetItem);t=this.getPreset();e=t.getPresets();this.presetsList=[];if(BX.type.isArray(e)&&e.length){e.forEach(function(t){if(!BX.hasClass(t,this.settings.classAddPresetField)&&!BX.hasClass(t,this.settings.classDefaultFilter)){this.presetsList.push(t)}},this)}},_onDrag:function(){var t=this;var e,s;this.dragOffset=this.realY-this.dragRect.top-this.dragStartOffset;this.sortOffset=t.realY+BX.scrollTop(window);BX.Filter.Utils.styleForEach([this.dragItem],{transition:"0ms",transform:"translate3d(0px, "+this.dragOffset+"px, 0px)"});this.presetsList.forEach(function(i,r){if(i){e=i.getBoundingClientRect();s=e.top+BX.scrollTop(window)+e.height/2;if(r>t.dragIndex&&t.sortOffset>s&&i.style.transform!=="translate3d(0px, "+-t.offset+"px, 0px)"&&i.style.transform!==""){t.targetItem=i;BX.style(i,"transform","translate3d(0px, "+-t.offset+"px, 0px)");BX.style(i,"transition","300ms")}if(r<t.dragIndex&&t.sortOffset<s&&i.style.transform!=="translate3d(0px, "+t.offset+"px, 0px)"&&i.style.transform!==""){t.targetItem=i;BX.style(i,"transform","translate3d(0px, "+t.offset+"px, 0px)");BX.style(i,"transition","300ms")}if((r<t.dragIndex&&t.sortOffset>s||r>t.dragIndex&&t.sortOffset<s)&&i.style.transform!=="translate3d(0px, 0px, 0px)"){if(i.style.transform!==""){t.targetItem=i}BX.style(i,"transform","translate3d(0px, 0px, 0px)");BX.style(i,"transition","300ms")}}})},getSidebarControlsContainer:function(){if(!BX.type.isDomNode(this.sidebarControlsContainer)){this.sidebarControlsContainer=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classSidebarControlsContainer)}return this.sidebarControlsContainer},enableEdit:function(){var t=this.getPreset();var e=t.getPresets();var s;if(BX.type.isArray(e)&&e.length){e.forEach(function(e){s=t.getPresetId(e);if(!BX.hasClass(e,this.settings.classAddPresetField)&&s!=="default_filter"){BX.addClass(e,this.settings.classPresetEdit)}},this)}this.enablePresetsDragAndDrop();BX.show(this.getButtonsContainer());BX.hide(this.getPresetButtonsContainer());BX.addClass(this.getSidebarControlsContainer(),this.settings.classDisabled);this.editablePresets=BX.clone(this.getParam("PRESETS"));this.isEditEnabledState=true},disableEdit:function(){var t=this.getPreset();var e=t.getPresets();if(BX.type.isArray(e)&&e.length){e.forEach(function(t){if(!BX.hasClass(t,this.settings.classAddPresetField)){BX.removeClass(t,this.settings.classPresetEdit);this.getPreset().disableEditPresetName(t)}},this)}this.disablePresetsDragAndDrop();if(!this.isAddPresetEnabled()){BX.style(this.getButtonsContainer(),"display","")}BX.show(this.getPresetButtonsContainer());BX.removeClass(this.getSidebarControlsContainer(),this.settings.classDisabled);this.editablePresets=null;this.isEditEnabledState=false;this.applyFilter(null,true)},getPresetButtonsContainer:function(){if(!BX.type.isDomNode(this.presetButtonsContainer)){this.presetButtonsContainer=BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classPresetButtonsContainer)}return this.presetButtonsContainer},isEditEnabled:function(){return this.isEditEnabledState},getEditButton:function(){return BX.Filter.Utils.getByClass(this.getFilter(),this.settings.classEditButton)},getParam:function(t,e){return t in this.params?this.params[t]:e},getFilter:function(){return BX.Filter.Utils.getByClass(this.getPopup().contentContainer,this.settings.classFilterContainer)},getSearch:function(){if(!(this.search instanceof BX.Filter.Search)){this.search=new BX.Filter.Search(this)}return this.search},_onRestoreButtonClick:function(){var t={CONFIRM:true,CONFIRM_MESSAGE:this.getParam("CONFIRM_MESSAGE"),CONFIRM_APPLY_BUTTON:this.getParam("CONFIRM_APPLY"),CONFIRM_CANCEL_BUTTON:this.getParam("CONFIRM_CANCEL")};this.confirmDialog(t,BX.delegate(this.restoreFilter,this))},confirmDialog:function(t,e,s){if("CONFIRM"in t&&t.CONFIRM){var i=this.getParam("FILTER_ID")+"-confirm-dialog";var r='<div class="main-ui-filter-confirm-content">'+t.CONFIRM_MESSAGE+"</div>";var a="CONFIRM_TITLE"in t?t.CONFIRM_TITLE:"";var n=new BX.PopupWindowButton({text:t.CONFIRM_APPLY_BUTTON,events:{click:function(){BX.type.isFunction(e)?e():null;this.popupWindow.close();this.popupWindow.destroy()}}});var l=new BX.PopupWindowButtonLink({text:t.CONFIRM_CANCEL_BUTTON,events:{click:function(){BX.type.isFunction(s)?s():null;this.popupWindow.close();this.popupWindow.destroy()}}});var o=new BX.PopupWindow(i,null,{content:r,titleBar:a,autoHide:false,zIndex:9999,overlay:.4,offsetTop:-100,closeIcon:true,closeByEsc:true,buttons:[n,l]});BX.addCustomEvent(o,"onPopupClose",BX.delegate(function(){!!this.getSaveForAllCheckbox()&&(this.getSaveForAllCheckbox().checked=null)},this));if(!o.isShown()){o.show();var h=o.popupContainer;BX.removeClass(h,this.settings.classAnimationShow);BX.addClass(h,this.settings.classAnimationShow)}}else{BX.type.isFunction(e)?e():null}}}})();(function(){BX.Main.filterManager={data:{},push:function(t,e){if(BX.type.isNotEmptyString(t)&&e){this.data[t]=e}},getById:function(t){var e=null;if(t in this.data){e=this.data[t]}return e}}})();
//# sourceMappingURL=script.map.js