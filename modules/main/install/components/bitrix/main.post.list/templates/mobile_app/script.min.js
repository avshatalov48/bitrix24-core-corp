(function(){if(!window["BX"]||window["BX"]["MPLForm"]||!window["app"])return;var t=window["BX"];var e={entityId:0,text:"",form:{},list:{},comments:{}};function i(i){e.text=t.type.isNotEmptyString(i)?i:"";if(t["localStorage"]&&e.entityId){var n=t.localStorage.get("main.post.list/text");n=n||{};if(t.type.isNotEmptyString(e.text)){n[e.entityId]=e.text}else{delete n[e.entityId]}t.localStorage.set("main.post.list/text",n)}}function n(e){var i="";if(t["localStorage"]&&e){var n=t.localStorage.get("main.post.list/text");if(n){i=n[e]||"";delete n[e];t.localStorage.set("main.post.list/text",n)}}return i}t.addCustomEvent(window,"OnUCFormSubmit",function(){i("")});t.addCustomEvent("main.post.form/text",function(e){e=t.type.isArray(e)?e[0]:e;i(e)});var o={keyBoardIsShown:false,mention:{}};window.app.exec("enableCaptureKeyboard",true);t.addCustomEvent("onKeyboardWillShow",function(){o.keyBoardIsShown=true});t.addCustomEvent("onKeyboardDidHide",function(){o.keyBoardIsShown=false});function s(e,i,n){if(t.type.isPlainObject(n)){for(var o in n){if(n.hasOwnProperty(o)){s(e,i+"["+o+"]",n[o])}}}else if(t.type.isArray(n)){for(var a=0;a<n.length;a++){s(e,i+"[]",n[a])}}else{e.append(i,!!n?n:"")}}var a=function(t,e,i){this.id=t;this.text=e||"";this.attachments=i||[];this.node=null;this.mentions={}};a.prototype={getText:function(){return this.text}};a.getInstance=function(i,n,o){var s;if(t.type.isArray(i)&&e["comments"][i.join("-")]){s=e["comments"][i.join("-")]}else if(t.type.isArray(i)){s=new a(i,n,o);s.savedInRepoId=i.join("-");e["comments"][i.join("-")]=s}else if(t.type.isObject(i)&&t.type.isNotEmptyString(i["savedInRepoId"])&&e["comments"][i["savedInRepoId"]]){s=i}return s};a.removeInstance=function(t){if(t&&t["savedInRepoId"]){delete e["comments"][t["savedInRepoId"]]}};var r=function(i){this.bindEvents();e["form"][this.handlerId]=this;this.entitiesId={};this.comment=null;this.handlerId=i;this.handler=null;this.handlerEvents={onMPFUserIsWriting:t.delegate(this.writing,this),onMPFHasBeenDestroyed:t.delegate(this.reboot,this)};this.visible=false;this.bindHandler=t.delegate(this.bindHandler,this);t.addCustomEvent(window,"onMPFIsInitialized",this.bindHandler);if(t["MPF"])this.bindHandler(t["MPF"].getInstance(this.handlerId));this.jsCommentId=t.util.getRandomString(20)};r.prototype={bindHandler:function(e){if(e&&e.id==this.handlerId){this.handler=e;t.removeCustomEvent(window,"onMPFIsInitialized",this.bindHandler);for(var i in this.handlerEvents){if(this.handlerEvents.hasOwnProperty(i)){t.addCustomEvent(this.handler,i,this.handlerEvents[i])}}this.closeWait();t.onCustomEvent(this,"OnUCFormInit",[this])}},bindEvents:function(){this.windowEvents={OnUCReply:function(t,e,i){if(this.entitiesId[t]){var n=[t,0];e=parseInt(e);if(e>0&&i){n=this.initComment(n,"",false);n.mentions[i]="[USER="+e+"]"+i+"[/USER]";var o=this.handler&&this.handler.simpleForm?this.handler.simpleForm.writingParams["~text"]:n.text;n.text=o+(o==""?"":" ")+"[USER="+e+"]"+i+"[/USER]"+", "}this.show(n,n.text,false)}}.bind(this),OnUCAfterRecordEdit:t.delegate(function(e,i,n,o){if(this.entitiesId[e]){if(o==="EDIT"){this.show([e,i],n["messageBBCode"],n["messageFields"])}else if(o==="MODERATE"){t.onCustomEvent(window,"OnUCAfterRecordAdd",[n.messageId[0],n,{node:t("record-"+n.messageId[0]+"-"+n.messageId[1])}])}else if(n["errorMessage"]){this.showError([e,i],n["errorMessage"])}else if(n["okMessage"]){this.showNote([e,i],n["okMessage"])}}},this)};t.addCustomEvent(window,"OnUCReply",this.windowEvents.OnUCReply);t.addCustomEvent(window,"OnUCAfterRecordEdit",this.windowEvents.OnUCAfterRecordEdit)},reboot:function(e,i,n){for(var o in this.handlerEvents){if(this.handlerEvents.hasOwnProperty(o)){t.removeCustomEvent(this.handler,o,this.handlerEvents[o])}}this.bindHandler(n)},linkEntity:function(i,o){if(this.handler===null){this._linkEntity=t.delegate(function(){this.linkEntity(i,o)},this);t.addCustomEvent(this,"OnUCFormInit",this._linkEntity)}else{if(this["_linkEntity"])t.removeCustomEvent(this,"OnUCFormInit",this["_linkEntity"]);this.entitiesId[i]=o;e.entityId=i;var s=function(t){this.comment=this.reinitComment({id:[i,0],text:t});this.comment.text=t;this.handler.init(this.comment)}.bind(this);s(n(i))}},writing:function(e){t.onCustomEvent(window,"OnUCUserIsWriting",[e["id"][0],e["id"][1],this.jsCommentId])},reinitComment:function(t){var e=[t["id"][0],0],i=t["text"]||"";a.removeInstance(t);return this.initComment(e,i,[])},initComment:function(e,i,n){var o=a.getInstance(e,i,n);if(o["bound"]!=="Y"){t.addCustomEvent(o,"onCancel",this.submitClear.bind(this));t.addCustomEvent(o,"onStart",this.submitStart.bind(this));t.addCustomEvent(o,"onSubmit",this.submit.bind(this));t.addCustomEvent(o,"onError",function(t,e){this.showError(o,e);this.submitClear(o)}.bind(this));o["bound"]="Y"}return o},show:function(i,n,o){this.comment=this.initComment(i,n,o);this.jsCommentId=t.util.getRandomString(20);t.onCustomEvent(this.handler,"OnUCFormBeforeShow",[this,n,o]);e.entityId=i[0];this.handler.show(this.comment,!!o);t.onCustomEvent(this.handler,"OnUCFormAfterShow",[this,n,o]);return true},submitClear:function(i){a.removeInstance(i);this.jsCommentId=t.util.getRandomString(20);if(this.comment==i){this.comment=this.initComment([i.id[0],0],"",[]);e.entityId=i.id[0];this.handler.init(this.comment)}},submitStart:function(e,i,n){t.onCustomEvent(window,"OnUCFormBeforeSubmit",[e.id[0],e.id[1],e,this,i,n])},submit:function(e){var i=e.getText(),n=e.attachments,o=this.entitiesId[e.id[0]],a=this.handler.getForm({ENTITY_XML_ID:e.id[0],REVIEW_TEXT:i,NOREDIRECT:"Y",MODE:"RECORD",AJAX_POST:"Y",id:e.id,sessid:t.bitrix_sessid(),SITE_ID:t.message("SITE_ID"),LANGUAGE_ID:t.message("LANGUAGE_ID")}),r=new window.MobileAjaxWrapper,d=new window.FormData,m;if(e.id[1]>0){a["REVIEW_ACTION"]="EDIT";a["FILTER"]={ID:e.id[1]};a["ACTION"]="EDIT";a["ID"]=e.id[1];if(a["act"]){a["act"]="edit";a["edit_id"]=e.id[1]}}if(o["fields"]){for(m in o["fields"]){if(o["fields"].hasOwnProperty(m)){a[m]=o["fields"][m]}}}t.onCustomEvent(window,"OnUCFormSubmit",[e.id[0],e.id[1],this,a]);for(m in a){if(a.hasOwnProperty(m)){s(d,m,a[m])}}if(n){for(var l=0;l<n.length;l++){s(d,n[l]["fieldName"],n[l]["fieldValue"])}}var h=o["url"];h=t.util.add_url_param(h,{b24statAction:e.id[1]>0?"editComment":"addComment",b24statContext:"mobile"});r.Wrap({method:"POST",url:h,data:{},type:"json",processData:true,start:false,preparePost:false,callback:t.proxy(function(i){t.onCustomEvent(window,"OnUCFormResponse",[e.id[0],e.id[1],this,i,e]);if(i["errorMessage"]){this.showError(e,i["errorMessage"])}else{t.onCustomEvent(window,"OnUCAfterRecordAdd",[e.id[0],i,e])}},this),callback_failure:t.delegate(function(i){this.showError(e,t.message("INCORRECT_SERVER_RESPONSE"));t.onCustomEvent(window,"OnUCFormResponse",[e.id[0],e.id[1],this,i,e])},this)});r.xhr.send(d);this.submitClear(e)},showError:function(e,i){if(t.type.isArray(e))e=this.initComment(e,"",[]);i='<div class="feed-add-info-text"><span class="feed-add-info-icon"></span>'+"<b>"+t.message("FC_ERROR")+"</b><br />"+i+"</div>";if(e&&e.node){t.addClass(e.node,"feed-com-block-cover-undelivered");var n=typeof e.attachments=="undefined"||e.attachments.length<=0;if(!n&&t.type.isArray(e.attachments)){n=true;for(var o=0;o<e.attachments.length;o++){if(t.type.isNotEmptyString(e.attachments[o].fieldValue)||t.type.isNotEmptyString(e.attachments[o].url)){n=false;break}}}if(n){t.bind(e.node,"click",t.proxy(function(i){t.unbindAll(e.node);t.removeClass(e.node,"feed-com-block-cover-undelivered");this.handler.comment=e;this.handler.simpleForm.handleAppData(e.text,true)},this))}}else if(i){}},showNote:function(t,e){},showWait:function(){this.handler.hide();this.handler.showWait()},closeWait:function(){this.handler.closeWait()}};r.link=function(t,i){var n=i["id"];e["form"][n]=e["form"][n]||new r(n);e["form"][n].linkEntity(t,i)};window.mobileShowActions=function(i,n,s){s=s||window.event;var a=window.app.enableInVersion(14)&&window.platform=="ios"?window.BXMobileAppContext.isKeyboardShown():o.keyBoardIsShown;if(a){return true}if(s&&s.target&&s.target.tagName&&(s.target.tagName.toUpperCase()=="A"||s.target.tagName.toUpperCase()=="IMG"&&t.type.isNotEmptyString(s.target.getAttribute("data-bx-image")))){return true}t.eventCancelBubble(s);s.preventDefault();var r=t(["record",i,n].join("-")),d=[],m;if(r.getAttribute("bx-mpl-reply-show")=="Y")d.push({title:t.message("BLOG_C_REPLY"),callback:function(){e["list"][i].reply(t(["record",i,n,"reply-action"].join("-")))}});var l;if(r.getAttribute("bx-mpl-vote-id")!="#VOTE_ID#"&&window["RatingLikeComments"]&&(l=window.RatingLikeComments.getById(r.getAttribute("bx-mpl-vote-id")))&&l){l["__delegatedVoteFunc"]=l["__delegatedVoteFunc"]||t.delegate(l.vote,l);d.push({title:l.voted?t.message("BPC_MES_VOTE2"):t.message("BPC_MES_VOTE1"),callback:l["__delegatedVoteFunc"]});d.push({title:t.message("BPC_MES_VOTE"),callback:function(){window.RatingLikeComments.List(r.getAttribute("bx-mpl-vote-id"))}})}if(r.getAttribute("bx-mpl-edit-show")=="Y"){d.push({title:t.message("BPC_MES_EDIT"),callback:function(){e["list"][i].act(r.getAttribute("bx-mpl-edit-url"),n,"EDIT")}})}if(r.getAttribute("bx-mpl-moderate-show")=="Y"){var h=r.getAttribute("bx-mpl-moderate-approved")=="hidden";d.push({title:h?t.message("BPC_MES_SHOW"):t.message("BPC_MES_HIDE"),callback:function(){var o=r.getAttribute("bx-mpl-moderate-url").replace("#action#",h?"show":"hide").replace("#ACTION#",h?"SHOW":"HIDE");if(t.type.isNotEmptyString(o)){o=t.util.add_url_param(o,{b24statAction:h?"showComment":"hideComment",b24statContext:"mobile"})}e["list"][i].act(o,n,h?"SHOW":"HIDE")}})}if(r.getAttribute("bx-mpl-delete-show")=="Y")d.push({title:t.message("BPC_MES_DELETE"),callback:function(){e["list"][i].act(r.getAttribute("bx-mpl-delete-url"),n,"DELETE")}});if(r.getAttribute("bx-mpl-createtask-show")=="Y"&&typeof oMSL!="undefined"){var c=r.getAttribute("bx-mpl-comment-entity-type"),u=r.getAttribute("bx-mpl-post-entity-type");d.push({title:t.message("BPC_MES_CREATETASK"),callback:function(){oMSL.createTask({postEntityType:t.type.isNotEmptyString(u)?u:"BLOG_POST",entityType:t.type.isNotEmptyString(c)?c:"BLOG_COMMENT",entityId:n})}})}if(d.length>0){m=new window.BXMobileApp.UI.ActionSheet({buttons:d},"commentSheet");m.show()}return false};window.mobileReply=function(i,n){t.eventCancelBubble(n);n.preventDefault();e["list"][i].reply(n.target);return false};window.mobileExpand=function(e,i){t.eventCancelBubble(i);i.preventDefault();var n=t(e)?t.findChild(e.previousSibling,{className:"post-comment-text"},true):null;if(t(n)){var o=n.parentNode,s=200,a=parseInt(n.offsetHeight),r={height:s},d={height:a};t.remove(e);var m=(a-s)/(2e3-s);m=m<.3?.3:m>.8?.8:m;o.style.maxHeight=r.height+"px";o.style.overflow="hidden";new t["easing"]({duration:m*1e3,start:r,finish:d,transition:t.easing.makeEaseOut(t.easing.transitions.quart),step:function(t){o.style.maxHeight=t.height+"px";o.style.opacity=t.opacity/100},complete:function(){o.style.cssText="";o.style.maxHeight="none";t.onCustomEvent(window,"OnUCRecordWasExpanded",[o]);t.LazyLoad.showImages(true)}}).animate()}return false};window.mobileIOSVersion=function(){if(/iP(hone|od|ad)/.test(navigator.platform)){var t=navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/);return[parseInt(t[1],10),parseInt(t[2],10),parseInt(t[3]||0,10)]}else{return false}};var d=function(){t.MPL=function(i,n,o){t.MPL.superclass.constructor.apply(this,arguments);this.thumb=t.message("MPL_RECORD_THUMB");this.thumbForFile=t.message("MPL_RECORD_THUMB_FILE");t.removeCustomEvent(window,"OnUCFormBeforeShow",this.windowEvents["OnUCFormBeforeShow"]);t.removeCustomEvent(window,"OnUCFormAfterShow",this.windowEvents["OnUCFormAfterShow"]);t.removeCustomEvent(window,"OnUCFormAfterHide",this.windowEvents["OnUCFormAfterHide"]);this.windowEvents["OnUCFormBeforeSubmit"]=function(e,i,n,o,s,a){if(this.ENTITY_XML_ID===e){this.makeThumb([e,i>0?i:t.util.getRandomString(6)],n,s,a)}}.bind(this);t.addCustomEvent(window,"OnUCFormBeforeSubmit",this.windowEvents["OnUCFormBeforeSubmit"]);t.removeCustomEvent(window,"OnUCFormResponse",this.windowEvents["OnUCFormResponse"]);this.windowEvents["OnUCFormResponse"]=t.delegate(function(t,e,i,n,o){if(this.ENTITY_XML_ID===t){this.clearThumb(o)}},this);t.addCustomEvent(window,"OnUCFormResponse",this.windowEvents["OnUCFormResponse"]);t.removeCustomEvent(window,"OnUCAfterRecordAdd",this.windowEvents["OnUCAfterRecordAdd"]);this.windowEvents["OnUCAfterRecordAdd"]=function(e,i,n){if(this.ENTITY_XML_ID===e){if(n&&t(n.node)){n["node"].setAttribute("id","record-"+i["messageId"].join("-")+"-cover")}this.add(i["messageId"],i,true,"simple")}}.bind(this);t.addCustomEvent(window,"OnUCAfterRecordAdd",this.windowEvents["OnUCAfterRecordAdd"]);if(n["SHOW_POST_FORM"]=="Y"){r.link(this.ENTITY_XML_ID,o)}e["list"][this.ENTITY_XML_ID]=this;return this};t.extend(t.MPL,window["FCList"]);t.MPL.prototype.init=function(){};t.MPL.prototype.url["activity"]=t.message("SITE_DIR")+"mobile/?mobile_action=comment_activity";t.MPL.prototype.makeThumb=function(e,i,n,s){var a=i.node||t("record-"+e.join("-")+"-cover");if(!a){var r=t.type.isString(n)?n:"";r=t.util.htmlspecialchars(r).replace(/\n/gi,"<br />");r=r.replace(/\001/,"").replace(/(\[\/user\])/gi,"").replace(/\[user=(\d+)\]([^\001].+?)(\001)/gi,"$2").replace(/\001/,"[/user]");var d=window.fcParseTemplate({messageFields:{FULL_ID:e,POST_MESSAGE_TEXT:r,POST_TIMESTAMP:(new Date).getTime()/1e3}},{DATE_TIME_FORMAT:this.params.DATE_TIME_FORMAT,RIGHTS:this.rights},t.type.isArray(s)&&s.length>0?this.thumbForFile:this.thumb),m;m=t.processHTML(d,false);a=t.create("DIV",{attrs:{id:"record-"+e.join("-")+"-cover",className:"feed-com-block-cover","bx-mpl-xml-id":this.getXmlId(),"bx-mpl-entity-id":e[1],"bx-mpl-read-status":"old"},style:{opacity:0,height:0,overflow:"hidden"},html:m.HTML});this.node.newComments.appendChild(a);var l=a,h=t.pos(l),c=h.top,u=t.GetWindowInnerSize(),f=false,p=0,w=window.mobileIOSVersion();if(window.platform=="ios"&&t.type.isArray(w)){w=w[0];f=w>=11&&o.keyBoardIsShown;p=260}if(!f||c>u.innerHeight-p){window.scrollTo(0,c-p)}new t["easing"]({duration:500,start:{opacity:0,height:0},finish:{opacity:100,height:l.scrollHeight},transition:t.easing.makeEaseInOut(t.easing.transitions.quad),step:function(t){l.style.height=t.height+"px";l.style.opacity=t.opacity/100;if(!f||c+t.height>u.innerHeight-p){window.scrollTo(0,c+t.height-p)}},complete:function(){if(l.style.display!=="none"){l.style.cssText=""}}}).animate();var E=0,v=function(){E++;if(E<100){var i=t("record-"+e.join("-")+"-cover");if(i&&i.childNodes.length>0)t.ajax.processScripts(m.SCRIPT);else t.defer(v,this)()}};t.defer(v,this)()}t.addClass(a,"feed-com-block-cover-wait");i.node=a;return a};t.MPL.prototype.clearThumb=function(e){if(e&&t(e.node)){t.removeClass(e.node,"feed-com-block-cover-wait")}};t.MPL.prototype.add=function(e,i){t.MPL.superclass.add.apply(this,[e,i]);if(window["BitrixMobile"]&&window["BitrixMobile"]["LazyLoad"])setTimeout(function(){window.BitrixMobile.LazyLoad.showImages()},500)};t.MPL.prototype.markCommentAsRead=function(e){if(!this.unreadComments.has(e)){return}var i=this.unreadComments.get(e);var n=t.findChild(i,{attrs:{id:["record",this.getXmlId(),e].join("-")}},true,false);if(n){t.removeClass(n,"post-comment-block-new");t.addClass(n,"post-comment-block-old")}t.MPL.superclass.markCommentAsRead.apply(this,[e])};t.MPL.prototype.sendPagenavigation=function(){if(t(this.node.navigation)){var e=t.findChild(this.node.navigation,{className:"post-comments-button-waiter"});if(e){t.addClass(e,"post-comments-button-waiter-active")}}t.MPL.superclass.sendPagenavigation.apply(this,arguments)};t.MPL.prototype.buildPagenavigation=function(){if(t(this.node.navigation)){var e=t.findChild(this.node.navigation,{className:"post-comments-button-waiter"});if(e){t.removeClass(e,"post-comments-button-waiter-active")}}t.MPL.superclass.buildPagenavigation.apply(this,arguments)};t.MPL.prototype.completePagenavigation=function(){if(t(this.node.navigation)){var e=t.findChild(this.node.navigation,{className:"post-comments-button-waiter"});if(e){t.removeClass(e,"post-comments-button-waiter-active")}}t.MPL.superclass.completePagenavigation.apply(this,arguments)};t.MPL.prototype.showWait=function(e){var i=t("record-"+this.ENTITY_XML_ID+"-"+e+"-cover");if(e>0&&i)t.addClass(i,"feed-com-block-cover-wait")};t.MPL.prototype.closeWait=function(e){var i=t("record-"+this.ENTITY_XML_ID+"-"+e+"-cover");if(e>0&&i)t.removeClass(i,"feed-com-block-cover-wait")};t.MPL.prototype.showError=function(t,e){};t.MPL.createInstance=function(e,i,n){return new t.MPL(e,i,n)};t.MPL.getInstance=function(t){return e["list"][t]};t.addCustomEvent(window,"OnUCHasBeenDestroyed",function(t){delete e["list"][t]});t.onCustomEvent("main.post.list/mobile",["script.js"]);t.removeCustomEvent("main.post.list/default",d)};t.addCustomEvent("main.post.list/default",d);if(window["FCList"])d();BXMobileApp.addCustomEvent(window,"onPull-unicomments",function(i){var n=i.params;var o=i.command;console.log("onPull-unicomments:",o,n);if(n["AUX"]&&!t.util.in_array(n["AUX"],["createtask","fileversion"])||e["list"][n["ENTITY_XML_ID"]]<=0){return}if(o==="comment_mobile"){if(n["NEED_REQUEST"]==="Y"){}else if(n["ACTION"]==="DELETE"){t.onCustomEvent(window,"OnUCommentWasDeleted",[n["ENTITY_XML_ID"],[n["ENTITY_XML_ID"],n["ID"]],n]);t.onCustomEvent(window,"OnUCFeedChanged",[n["ID"]])}else if(n["ACTION"]==="HIDE"){t.onCustomEvent(window,"OnUCommentWasHidden",[n["ENTITY_XML_ID"],[n["ENTITY_XML_ID"],n["ID"]],n]);t.onCustomEvent(window,"OnUCFeedChanged",[n["ID"]])}else{if(n["ACTION"]==="REPLY")n["NEW"]=!n["AUTHOR"]||n["AUTHOR"]["ID"]!=t.message("USER_ID")?"Y":"N";t.onCustomEvent(window,"OnUCCommentWasPulled",[[n["ENTITY_XML_ID"],n["ID"]],{messageFields:n},n])}}else if(o==="answer"&&Number(n["USER_ID"])!==Number(t.message("USER_ID"))){t.onCustomEvent(window,"OnUCUsersAreWriting",[n["ENTITY_XML_ID"],n["USER_ID"],n["NAME"],n["AVATAR"]])}})})();
//# sourceMappingURL=script.map.js