this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(e,t,i,r){"use strict";var n,s,a;var o=function(){function e(t){babelHelpers.classCallCheck(this,e);this.groupId=t.groupId;this.taskId=t.taskId;this.epic=t.epic;this.canEdit=t.canEdit;this.dialog=null;this.node=null;this.nameNode=null;this.selectorNode=null;i.EventEmitter.subscribe("onChangeProjectLink",this.onChangeTaskProject.bind(this))}babelHelpers.createClass(e,[{key:"renderTo",value:function e(i){t.Dom.append(this.render(),i)}},{key:"render",value:function e(){this.node=t.Tag.render(n||(n=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div>\n\t\t\t\t","\n\t\t\t\t","\n\t\t\t</div>\n\t\t"])),this.renderName(),this.renderSelector());return this.node}},{key:"onChangeTaskProject",value:function e(t){var i=t.getCompatData(),r=babelHelpers.slicedToArray(i,2),n=r[0],s=r[1];this.groupId=parseInt(n,10);this.taskId=parseInt(s,10);this.epic=null;this.dialog=null;this.updateSelector(null)}},{key:"renderName",value:function e(){if(t.Type.isNull(this.epic)){return""}var i=this.convertHexToRGBA(this.epic.color,.7);var r=this.convertHexToRGBA(this.epic.color,.3);this.nameNode=t.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div\n\t\t\t\tclass="tasks-scrum__epic-selector--epic"\n\t\t\t\tstyle="background: ',"; border-color: ",';"\n\t\t\t>\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"])),r,i,t.Text.encode(this.epic.name));return this.nameNode}},{key:"renderSelector",value:function e(){this.selectorNode=t.Tag.render(a||(a=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div>\n\t\t\t\t<div class="ui-btn-link tasks-scrum__epic-selector--link">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),this.getButtonText());var i=this.selectorNode.firstElementChild;t.Event.bind(i,"click",this.onClick.bind(this,i));return this.selectorNode}},{key:"onClick",value:function e(i){var n=this;if(this.dialog){if(this.dialog.isOpen()){this.dialog.hide()}else{this.dialog.show()}return}var s=[];if(!t.Type.isNull(this.epic)){s.push(["epic-selector",this.epic.id])}this.dialog=new r.Dialog({id:t.Text.getRandom(),targetNode:this.selectorNode,width:350,height:300,multiple:false,dropdownMode:true,enableSearch:true,compactView:true,hideOnDeselect:true,context:"epic-selector-"+this.groupId,preselectedItems:s,entities:[{id:"epic-selector",options:{groupId:this.groupId},dynamicLoad:true,dynamicSearch:true}],searchOptions:{allowCreateItem:true,footerOptions:{label:t.Loc.getMessage("TSE_SELECTOR_SEARCHER_EPIC_ADD")}},events:{"Search:onItemCreateAsync":function e(t){return new Promise((function(e){var i=t.getData(),r=i.searchQuery;n.createEpic(r.getQuery()).then((function(t){var i=n.getEpicDialogItem(t);i.selected=true;i.sort=1;n.dialog.addItem(i);n.dialog.hide();e()}))}))}},tagSelectorOptions:{textBoxWidth:300}});this.dialog.subscribe("onHide",(function(){var e=n.dialog.getSelectedItems();var t=e.length?e[0].getId():0;n.changeTaskEpic(t).then((function(e){return n.updateSelector(e)}))}));this.dialog.show()}},{key:"updateSelector",value:function e(i){this.epic=i;this.selectorNode.firstElementChild.textContent=this.getButtonText();if(t.Type.isNull(i)){t.Dom.remove(this.nameNode);this.nameNode=null}else{if(t.Type.isNull(this.nameNode)){t.Dom.insertBefore(this.renderName(),this.selectorNode)}else{t.Dom.replace(this.nameNode,this.renderName())}}}},{key:"getEpicDialogItem",value:function e(t){return{id:t.id,entityId:"epic-selector",title:t.name,tabs:"recents",avatarOptions:{bgColor:t.color,bgImage:"none",borderRadius:"12px"}}}},{key:"changeTaskEpic",value:function e(i){var r=this;return t.ajax.runComponentAction("bitrix:tasks.scrum.epic.selector","changeTaskEpic",{mode:"class",data:{taskId:this.taskId,epicId:i}}).then((function(e){return e.data}))["catch"]((function(e){return r.showErrorAlert(e)}))}},{key:"createEpic",value:function e(i){var r=this;return t.ajax.runAction("bitrix:tasks.scrum.epic.createEpic",{data:{groupId:this.groupId,name:i}}).then((function(e){return e.data}))["catch"]((function(e){return r.showErrorAlert(e)}))}},{key:"getButtonText",value:function e(){if(t.Type.isNull(this.epic)){return t.Loc.getMessage("TSE_SELECTOR_ADD")}else{return t.Loc.getMessage("TSE_SELECTOR_EDIT")}}},{key:"convertHexToRGBA",value:function e(t,i){var r=t.replace("#","");if(r.length===3){r="".concat(r[0]).concat(r[0]).concat(r[1]).concat(r[1]).concat(r[2]).concat(r[2])}var n=parseInt(r.substring(0,2),16);var s=parseInt(r.substring(2,4),16);var a=parseInt(r.substring(4,6),16);return"rgba(".concat(n,",").concat(s,",").concat(a,",").concat(i,")")}},{key:"showErrorAlert",value:function e(i,r){if(t.Type.isUndefined(i.errors)){return}if(i.errors.length){var n=i.errors.shift();if(n){var s=n.code?n.code:"";var a=n.message+" "+s;var o=r?r:t.Loc.getMessage("TSE_SELECTOR_ERROR_POPUP_TITLE");top.BX.UI.Dialogs.MessageBox.alert(a,o)}}}}]);return e}();var c;var l=function(){function e(t){babelHelpers.classCallCheck(this,e);this.groupId=t.groupId;this.taskId=t.taskId;this.savedEpic=t.epic;this.inputName=t.inputName;this.selector=null;this.node=null;this.inputNode=null;i.EventEmitter.subscribe("BX.Tasks.MemberSelector:projectSelected",this.onProjectSelected.bind(this));i.EventEmitter.subscribe("BX.Tasks.Component.Task:projectPreselected",this.onProjectPreselected.bind(this))}babelHelpers.createClass(e,[{key:"renderTo",value:function e(i){this.node=i;t.Dom.addClass(this.node,"tasks-scrum-epic-edit-selector");if(this.inputName){t.Dom.append(this.renderInput(),this.node)}this.buildSelector().renderTo(this.node)}},{key:"renderInput",value:function e(){var i=this.savedEpic?parseInt(this.savedEpic.id,10):0;this.inputNode=t.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="hidden" name="','" value="','">\n\t\t'])),t.Text.encode(this.inputName),i);return this.inputNode}},{key:"buildSelector",value:function e(){var i=this;var n=[];if(this.savedEpic){n.push(["epic-selector",this.savedEpic.id]);this.updateInputValue(this.savedEpic.id)}this.selector=new r.TagSelector({multiple:false,textBoxWidth:200,dialogOptions:{width:350,height:240,dropdownMode:true,compactView:true,multiple:false,hideOnDeselect:true,context:"epic-selector-"+this.groupId,preselectedItems:n,entities:[{id:"epic-selector",options:{groupId:this.groupId},dynamicLoad:true,dynamicSearch:true}],searchOptions:{allowCreateItem:true,footerOptions:{label:t.Loc.getMessage("TSE_SELECTOR_SEARCHER_EPIC_ADD")}},items:[],events:{"Search:onItemCreateAsync":function e(t){return new Promise((function(e){var r=t.getData(),n=r.searchQuery;var s=t.getTarget();i.createEpic(n.getQuery()).then((function(t){var r=i.getEpicDialogItem(t);r.selected=true;r.sort=1;s.addItem(r);i.updateInputValue(r.id);e()}))}))},"Item:onSelect":function e(t){var r=t.getData().item;i.updateInputValue(r.getId())},"Item:onDeselect":function e(t){var r=t.getTarget();setTimeout((function(){if(r.getSelectedItems().length===0){i.updateInputValue(0)}}),50)}}}});this.selector.subscribe("onMetaEnter",(function(e){var t=e.getTarget();if(t.getDialog().isOpen()){var i=e.getData(),r=i.event;r.stopPropagation()}}));return this.selector}},{key:"onProjectSelected",value:function e(i){var r=i.getData();this.groupId=parseInt(r.ID,10);this.updateInputValue(0);this.savedEpic=null;t.Dom.clean(this.node);this.renderTo(this.node)}},{key:"onProjectPreselected",value:function e(i){var r=i.getData();this.groupId=parseInt(r.groupId,10);t.Dom.clean(this.node);this.renderTo(this.node)}},{key:"updateInputValue",value:function e(t){this.inputNode.value=parseInt(t,10)}},{key:"getEpicDialogItem",value:function e(t){return{id:t.id,entityId:"epic-selector",title:t.name,tabs:"recents",avatarOptions:{bgColor:t.color,bgImage:"none",borderRadius:"12px"}}}},{key:"createEpic",value:function e(i){var r=this;return t.ajax.runAction("bitrix:tasks.scrum.epic.createEpic",{data:{groupId:this.groupId,name:i}}).then((function(e){return e.data}))["catch"]((function(e){return r.showErrorAlert(e)}))}},{key:"showErrorAlert",value:function e(i,r){if(t.Type.isUndefined(i.errors)){return}if(i.errors.length){var n=i.errors.shift();if(n){var s=n.code?n.code:"";var a=n.message+" "+s;var o=r?r:t.Loc.getMessage("TSE_SELECTOR_ERROR_POPUP_TITLE");top.BX.UI.Dialogs.MessageBox.alert(a,o)}}}}]);return e}();var d=function(){function e(i){babelHelpers.classCallCheck(this,e);this.groupId=parseInt(i.groupId,10);this.taskId=parseInt(i.taskId,10);this.epic=t.Type.isPlainObject(i.epic)?i.epic:null;this.canEdit=i.canEdit==="Y";this.mode=i.mode==="edit"?"edit":"view";this.inputName=i.inputName}babelHelpers.createClass(e,[{key:"renderTo",value:function e(t){if(this.mode==="view"){new o({groupId:this.groupId,taskId:this.taskId,epic:this.epic,canEdit:this.canEdit}).renderTo(t)}else{new l({groupId:this.groupId,taskId:this.taskId,epic:this.epic,inputName:this.inputName}).renderTo(t)}}}]);return e}();e.EpicSelector=d})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX,BX.Event,BX.UI.EntitySelector);
//# sourceMappingURL=script.map.js