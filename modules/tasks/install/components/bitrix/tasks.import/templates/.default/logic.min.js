BX.TasksImport=function(){var e=function(e){this.timerId=null;this.fileErrors={};var r=this;var t=parseInt(e.step);var o=e.formId;this.bindElements(o,e.isFramePopup,t);window.addEventListener("resize",function(){r.setImportExampleTableContainerSize(o)},false);this.showErrors(e.errors);if(t===3){this.setImportErrorsContainerHeight(o);this.startImport(e.importFileParameters)}};e.prototype.validateFile=function(r){var t;var o=BX.message("TASKS_IMPORT_ERROR_FILE_NOT_SELECTED");var s=BX.message("TASKS_IMPORT_ERROR_FILE_WRONG_EXTENSION");if(!r){if("FILE_LABEL"in this.fileErrors&&this.fileErrors["FILE_LABEL"]===o)return false;this.fileErrors={FILE_LABEL:o};e.prototype.showErrors(this.fileErrors);return false}else if((t=r.name.substring(r.name.lastIndexOf(".")+1).toLowerCase())!=="csv"){if("FILE_LABEL"in this.fileErrors&&this.fileErrors["FILE_LABEL"]===s)return false;this.fileErrors={FILE_LABEL:s+" (."+t+")"};e.prototype.showErrors(this.fileErrors);return false}return true};e.prototype.bindElements=function(r,t,o){if(t){if(o===3)e.slider.bindClose(BX("next"));e.slider.bindClose(BX("cancel"))}else{if(o===3)BX.bind(BX("force_import_stop"),"click",function(){BX.submit(BX(r),"cancel")});BX.bind(BX("cancel"),"click",function(){BX.submit(BX(r),"cancel")})}BX.bind(BX("file"),"change",function(){var e=BX.message("TASKS_IMPORT_FILE_NOT_SELECTED");var r=BX("file").value;if(r!==""){var t=r.lastIndexOf("\\");if(t!==-1)e=r.substr(t+1)}BX("file_name").value=e;BX("hidden_from_tmp_dir").value="N"});BX.bind(BX("back"),"click",function(){BX.submit(BX(r),"back")});BX.bind(BX("stop"),"click",function(){e.prototype.stopImport()});BX.bind(BX("force_import_stop"),"click",function(){e.prototype.stopImport()})};e.prototype.setImportExampleTableContainerSize=function(e){var r=BX(e).offsetWidth;var t=r-40;BX("tasks_import_example_table_container").style.width=t+"px"};e.prototype.setImportErrorsContainerHeight=function(e){var r=BX(e).offsetHeight;BX("error_imports_messages_container").style.maxHeight=r+"px"};e.prototype.showErrors=function(e){Object.keys(e).forEach(function(r){var t=r.toLowerCase();if(document.getElementById(t+"_alert"))BX(t+"_alert").remove();if(t!=="required_fields")BX(t).className+=" tasks-field-error";var o=BX.create("div",{props:{id:t+"_alert",className:"ui-alert ui-alert-danger tasks-alerts-text",innerHTML:e[r]}});BX(t+"_container").appendChild(o)})};e.prototype.startImport=function(r){BX.ajax.runComponentAction("bitrix:tasks.import","startImport",{mode:"ajax",data:{importParameters:r}}).then(function(r){if(r.status==="error"){BX("imports_total_count").innerHTML=0;e.doFinalProgressActions("ERROR");e.showImportErrors(r.errors,true);return}var t=r.data;var o=t["IMPORTS_TOTAL_COUNT"];var s=t["SUCCESSFUL_IMPORTS"];var i=t["ERROR_IMPORTS"];var n=0;if(BX("processed_count").innerHTML==="0"){BX("progress_bar").max=o;BX("imports_total_count").innerHTML=o}if(s>0||i>0){BX("progress_bar").value+=s+i;BX("processed_count").innerHTML=BX("progress_bar").value;BX("successful_imports").innerHTML=parseInt(BX("successful_imports").innerHTML)+s;BX("error_imports").innerHTML=parseInt(BX("error_imports").innerHTML)+i;n=1e3*t["MAX_EXECUTION_TIME"]/(s+i);e.resetTimer(n);if(i>0)e.showImportErrors(t["ERROR_IMPORTS_MESSAGES"],false);if(!t["ALL_LINES_LOADED"]){if(BX("hidden_force_import_stop").value==="N"){t["ERROR_IMPORTS_MESSAGES"]=[];e.prototype.startImport(t)}else{e.doFinalProgressActions("STOPPED")}}else if(parseInt(BX("progress_bar").value)===parseInt(o)){BX("hidden_import_done").value="Y";e.doFinalProgressActions("DONE")}else{e.doFinalProgressActions("ERROR")}}else{e.doFinalProgressActions("DONE")}})};e.prototype.stopImport=function(){if(BX("hidden_import_done").value==="Y"||BX("hidden_force_import_stop").value==="Y")return;BX("hidden_force_import_stop").value="Y";BX("stop").className=BX("stop").className.replace("ui-btn-icon-stop","ui-btn-clock");BX("force_import_stop").className=BX("force_import_stop").className.replace("ui-btn-icon-stop","ui-btn-clock")};e.resetTimer=function(r){e.stopTimer();e.setTimer(r)};e.setTimer=function(r){this.timerId=setInterval(e.increaseProcessedTasksCount,r+200)};e.stopTimer=function(){if(this.timerId)clearInterval(this.timerId)};e.increaseProcessedTasksCount=function(){BX("processed_count").innerHTML=parseInt(BX("processed_count").innerHTML)+1};e.showImportErrors=function(e,r){var t="";var o=BX.message("TASKS_IMPORT_LINE");if(r){t="tasks-import-results-error-messages-danger";o=""}e.forEach(function(e){var s=BX.create("div",{text:o+(r?e.message:e),props:{className:t}});BX("error_imports_messages_container").appendChild(s)})};e.doFinalProgressActions=function(r){e.stopTimer();e.changeFooterButtons();e.setFinalFormOfForceImportStopButton(r);e.slider.bindClose(BX("force_import_stop"))};e.changeFooterButtons=function(){BX("stop").style.display="none";BX("next").style.display="inline-block";BX("back").style.display="inline-block"};e.setFinalFormOfForceImportStopButton=function(e){if(e==="DONE"){BX("force_import_stop").className=BX("force_import_stop").className.replace("ui-btn-clock","ui-btn-icon-info");if(BX("force_import_stop").className.indexOf("ui-btn-icon-info")===-1)BX("force_import_stop").className=BX("force_import_stop").className.replace("ui-btn-icon-stop","ui-btn-icon-info");BX("force_import_stop").className+=" ui-btn-success"}else if(e==="STOPPED"){BX("force_import_stop").className=BX("force_import_stop").className.replace("ui-btn-clock","ui-btn-icon-info");BX("force_import_stop").className+=" ui-btn-danger"}else if(e==="ERROR"){BX("hidden_force_import_stop").value="Y";BX("force_import_stop").className=BX("force_import_stop").className.replace("ui-btn-icon-stop","ui-btn-icon-info");BX("force_import_stop").className+=" ui-btn-danger"}BX("force_import_stop").innerHTML=BX.message("TASKS_IMPORT_"+e)};e.slider={bindClose:function(e){BX.bind(e,"click",this.close)},close:function(){window.top.BX.SidePanel.Instance.close()}};return e}();(function(){"use strict";BX.namespace("Tasks.Component");if(BX.getClass("BX.Tasks.Component.TasksImport"))return;BX.Tasks.Component.TasksImport=BX.Tasks.Component.extend({sys:{code:"import"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component)},bindEvents:function(){}}})}).call(this);
//# sourceMappingURL=logic.map.js