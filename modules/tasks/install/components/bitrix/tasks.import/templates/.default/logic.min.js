BX.TasksImport=function(){var e=function(e){this.timerId=null;this.fileErrors={};var t=this;var r=parseInt(e.step);var o=e.formId;this.bindElements(o,e.isFramePopup,r);window.addEventListener("resize",(function(){t.setImportExampleTableContainerSize(o)}),false);this.showErrors(e.errors);if(r===3){this.setImportErrorsContainerHeight(o);this.startImport(e.importFileParameters)}};e.prototype.validateFile=function(t){var r;var o=BX.message("TASKS_IMPORT_ERROR_FILE_NOT_SELECTED");var s=BX.message("TASKS_IMPORT_ERROR_FILE_WRONG_EXTENSION");if(!t){if("FILE_LABEL"in this.fileErrors&&this.fileErrors["FILE_LABEL"]===o)return false;this.fileErrors={FILE_LABEL:o};e.prototype.showErrors(this.fileErrors);return false}else if((r=t.name.substring(t.name.lastIndexOf(".")+1).toLowerCase())!=="csv"){if("FILE_LABEL"in this.fileErrors&&this.fileErrors["FILE_LABEL"]===s)return false;this.fileErrors={FILE_LABEL:s+" (."+r+")"};e.prototype.showErrors(this.fileErrors);return false}return true};e.prototype.bindElements=function(t,r,o){if(r){if(o===3)e.slider.bindClose(BX("next"));e.slider.bindClose(BX("cancel"))}else{if(o===3)BX.bind(BX("force_import_stop"),"click",(function(){BX.submit(BX(t),"cancel")}));BX.bind(BX("cancel"),"click",(function(){BX.submit(BX(t),"cancel")}))}BX.bind(BX("file"),"change",(function(){var e=BX.message("TASKS_IMPORT_FILE_NOT_SELECTED");var t=BX("file").value;if(t!==""){var r=t.lastIndexOf("\\");if(r!==-1)e=t.substr(r+1)}BX("file_name").value=e;BX("hidden_from_tmp_dir").value="N"}));BX.bind(BX("back"),"click",(function(){BX.submit(BX(t),"back")}));BX.bind(BX("stop"),"click",(function(){e.prototype.stopImport()}));BX.bind(BX("force_import_stop"),"click",(function(){e.prototype.stopImport()}))};e.prototype.setImportExampleTableContainerSize=function(e){var t=BX(e).offsetWidth;var r=t-40;BX("tasks_import_example_table_container").style.width=r+"px"};e.prototype.setImportErrorsContainerHeight=function(e){var t=BX(e).offsetHeight;BX("error_imports_messages_container").style.maxHeight=t+"px"};e.prototype.showErrors=function(e){Object.keys(e).forEach((function(t){var r=t.toLowerCase();if(document.getElementById(r+"_alert"))BX(r+"_alert").remove();if(r!=="required_fields")BX(r).className+=" tasks-field-error";var o=BX.create("div",{props:{id:r+"_alert",className:"ui-alert ui-alert-danger tasks-alerts-text",innerHTML:e[t]}});BX(r+"_container").appendChild(o)}))};e.prototype.startImport=function(t){BX.ajax.runComponentAction("bitrix:tasks.import","startImport",{mode:"ajax",data:{importParameters:t}}).then((function(t){var r=t.data;var o=r["IMPORTS_TOTAL_COUNT"];var s=r["SUCCESSFUL_IMPORTS"];var i=r["ERROR_IMPORTS"];var n=0;if(BX("processed_count").innerHTML==="0"){BX("progress_bar").max=o;BX("imports_total_count").innerHTML=o}if(s>0||i>0){BX("progress_bar").value+=s+i;BX("processed_count").innerHTML=BX("progress_bar").value;BX("successful_imports").innerHTML=parseInt(BX("successful_imports").innerHTML)+s;BX("error_imports").innerHTML=parseInt(BX("error_imports").innerHTML)+i;n=1e3*r["MAX_EXECUTION_TIME"]/(s+i);e.resetTimer(n);if(i>0){e.showImportErrors(r["ERROR_IMPORTS_MESSAGES"],false)}if(!r["ALL_LINES_LOADED"]){if(BX("hidden_force_import_stop").value==="N"){r["ERROR_IMPORTS_MESSAGES"]=[];e.prototype.startImport(r)}else{e.doFinalProgressActions("STOPPED")}}else if(parseInt(BX("progress_bar").value)===parseInt(o)){BX("hidden_import_done").value="Y";e.doFinalProgressActions("DONE")}else{e.doFinalProgressActions("ERROR")}}else{e.doFinalProgressActions("DONE")}}),(function(t){BX("imports_total_count").innerHTML=0;e.doFinalProgressActions("ERROR");e.showImportErrors(t.errors,true)}))};e.prototype.stopImport=function(){if(BX("hidden_import_done").value==="Y"||BX("hidden_force_import_stop").value==="Y")return;BX("hidden_force_import_stop").value="Y";BX("stop").className=BX("stop").className.replace("ui-btn-icon-stop","ui-btn-clock");BX("force_import_stop").className=BX("force_import_stop").className.replace("ui-btn-icon-stop","ui-btn-clock")};e.resetTimer=function(t){e.stopTimer();e.setTimer(t)};e.setTimer=function(t){this.timerId=setInterval(e.increaseProcessedTasksCount,t+200)};e.stopTimer=function(){if(this.timerId)clearInterval(this.timerId)};e.increaseProcessedTasksCount=function(){BX("processed_count").innerHTML=parseInt(BX("processed_count").innerHTML)+1};e.showImportErrors=function(e,t){var r="";var o=BX.message("TASKS_IMPORT_LINE");if(t){r="tasks-import-results-error-messages-danger";o=""}e.forEach((function(e){var s=BX.create("div",{text:o+(t?e.message:e),props:{className:r}});BX("error_imports_messages_container").appendChild(s)}))};e.doFinalProgressActions=function(t){e.stopTimer();e.changeFooterButtons();e.setFinalFormOfForceImportStopButton(t);e.slider.bindClose(BX("force_import_stop"))};e.changeFooterButtons=function(){BX("stop").style.display="none";BX("next").style.display="inline-block";BX("back").style.display="inline-block"};e.setFinalFormOfForceImportStopButton=function(e){if(e==="DONE"){BX("force_import_stop").className=BX("force_import_stop").className.replace("ui-btn-clock","ui-btn-icon-info");if(BX("force_import_stop").className.indexOf("ui-btn-icon-info")===-1)BX("force_import_stop").className=BX("force_import_stop").className.replace("ui-btn-icon-stop","ui-btn-icon-info");BX("force_import_stop").className+=" ui-btn-success"}else if(e==="STOPPED"){BX("force_import_stop").className=BX("force_import_stop").className.replace("ui-btn-clock","ui-btn-icon-info");BX("force_import_stop").className+=" ui-btn-danger"}else if(e==="ERROR"){BX("hidden_force_import_stop").value="Y";BX("force_import_stop").className=BX("force_import_stop").className.replace("ui-btn-icon-stop","ui-btn-icon-info");BX("force_import_stop").className+=" ui-btn-danger"}BX("force_import_stop").innerHTML=BX.message("TASKS_IMPORT_"+e)};e.slider={bindClose:function(e){BX.bind(e,"click",this.close)},close:function(){window.top.BX.SidePanel.Instance.close()}};return e}();(function(){"use strict";BX.namespace("Tasks.Component");if(BX.getClass("BX.Tasks.Component.TasksImport"))return;BX.Tasks.Component.TasksImport=BX.Tasks.Component.extend({sys:{code:"import"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component)},bindEvents:function(){}}})}).call(this);
//# sourceMappingURL=logic.map.js