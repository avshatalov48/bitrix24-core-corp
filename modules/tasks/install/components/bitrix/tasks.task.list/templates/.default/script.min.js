BX.namespace("BX.Tasks.Grid");BX.Tasks.GridActions={gridId:null,groupSelector:null,registeredTimerNodes:{},defaultPresetId:"",getTotalCountProceed:false,currentGroupAction:null,checkCanMove:function(){return!BX.Tasks.GridInstance||BX.Tasks.GridInstance.checkCanMove()},initPopupBalloon:function(t,e,i){this.groupSelector=null;BX.bind(BX(e+"_control"),"click",BX.delegate(function(){if(!this.groupSelector){this.groupSelector=new BX.Tasks.Integration.Socialnetwork.NetworkSelector({scope:BX(e+"_control"),id:"group-selector-"+this.gridId,mode:t,query:false,useSearch:true,useAdd:false,parent:this,popupOffsetTop:5,popupOffsetLeft:40});this.groupSelector.bindEvent("item-selected",BX.delegate(function(t){BX(e+"_control").value=BX.util.htmlspecialcharsback(t.nameFormatted)||"";BX(i+"_control").value=t.id||"";this.groupSelector.close()},this))}this.groupSelector.open()},this))},toggleFilter:function(t,e){var i=BX.Main.filterManager.getById(this.gridId);if(!i){console.log("BX.Main.filterManager not initialised");return}if(!e){i.getApi().extendFilter(t);return}var s=i.getFilterFields();Object.keys(t).forEach(function(t){s.forEach(function(e){if(e.getAttribute("data-name")===t){i.getFields().deleteField(e)}})});i.getSearch().apply()},filter:function(t){var e=BX.Main.filterManager.getById(this.gridId);if(!e){console.log("BX.Main.filterManager not initialised");return}var i=e.getFilterFieldsValues();var s=e.getApi();Object.keys(t).forEach(function(e){i[e]=t[e]});s.setFields(i);s.apply()},action:function(t,e,i){if(t==="add2Timeman"){if(BX.addTaskToPlanner){BX.addTaskToPlanner(e)}else if(window.top.BX.addTaskToPlanner){window.top.BX.addTaskToPlanner(e)}}else{this.doAction(t,e,i)}},doAction:function(t,e,i){i=i||{};i["id"]=e;this.getQuery(t).add("task."+t.toLowerCase(),i,{},BX.delegate(function(t,i){if(!t.checkHasErrors()){if(i.OPERATION=="task.delete"){BX.Tasks.Util.fireGlobalTaskEvent("DELETE",{ID:e});BX.UI.Notification.Center.notify({content:BX.message("TASKS_DELETE_SUCCESS")})}if(!this.gridId){window.location.href=window.location.href;return}if(!this.checkCanMove()){this.reloadRow(e)}}},this))},getQuery:function(t){var e=BX.message("_VIEW_TYPE");var i="/bitrix/components/bitrix/tasks.base/ajax.php?_CODE="+(t||"")+"&viewType="+e;if(!this.query){this.query=new BX.Tasks.Util.Query({url:i,autoExec:true})}return this.query},getTotalCount:function(t,e,i,s){if(this.getTotalCountProceed){return}this.getTotalCountProceed=true;var r=document.getElementById(t+"_row_count_wrapper");this.showCountLoader(r);var a=new BX.Tasks.Util.Query({url:"/bitrix/components/bitrix/tasks.task.list/ajax.php"});a.run("this.getTotalCount",{userId:e,groupId:i,parameters:JSON.stringify(s)}).then(function(t){this.hideCountLoader(r);if(t.data){t.data=typeof t.data=="number"?t.data:0;var e=r.querySelector("a");if(e){e.remove()}r.append(t.data)}this.getTotalCountProceed=false}.bind(this));a.execute()},showCountLoader:function(t){var e=t.querySelector("a");if(e){e.style.display="none"}var i=t.querySelector(".tasks-circle-loader-circular");if(i){i.style.display="inline"}},hideCountLoader:function(t){var e=t.querySelector(".tasks-circle-loader-circular");if(e){e.style.display="none"}},reloadRow:function(t){var e=BX.Main.gridManager.getById(this.gridId);if(e&&e.hasOwnProperty("instance")){e.instance.updateRow(t.toString())}},reloadGrid:function(){if(BX.Bitrix24&&BX.Bitrix24.Slider&&BX.Bitrix24.Slider.getLastOpenPage()){BX.Bitrix24.Slider.destroy(BX.Bitrix24.Slider.getLastOpenPage().getUrl())}var t=BX.Main.gridManager.getById(this.gridId);if(t&&t.hasOwnProperty("instance")){t.instance.reloadTable("POST",{apply_filter:"Y",clear_nav:"Y"})}},setCurrentGroupAction:function(t){this.currentGroupAction=t},processBeforeGroupActionSent:function(){if(this.currentGroupAction==="ping"){BX.UI.Notification.Center.notify({content:BX.message("TASKS_LIST_GROUP_ACTION_PING_NOTIFICATION")})}this.currentGroupAction=null},confirmGroupAction:function(t){BX.Tasks.confirm(BX.message("TASKS_CONFIRM_GROUP_ACTION")).then(function(){this.processBeforeGroupActionSent();BX.Main.gridManager.getById(t).instance.sendSelected()}.bind(this))},onDeadlineChangeClick:function(t,e,i){i=i||(new Date).getDate();BX.calendar({node:e,value:i,form:"",bTime:true,currentTime:Math.round(new Date/1e3)-(new Date).getTimezoneOffset()*60,bHideTimebar:true,bCompatibility:true,bCategoryTimeVisibilityOption:"tasks.bx.calendar.deadline",bTimeVisibility:BX.Tasks.GridInstance?BX.Tasks.GridInstance.calendarSettings.deadlineTimeVisibility==="Y":false,callback_after:function(t,e){return function(i){var s=BX.CJSTask.ajaxUrl;BX.CJSTask.ajaxUrl=BX.CJSTask.ajaxUrl+"&_CODE=CHANGE_DEADLINE&viewType=VIEW_MODE_LIST";BX.CJSTask.batchOperations([{operation:"CTaskItem::update()",taskData:{ID:e,DEADLINE:BX.calendar.ValueToString(i,true)}}],{callbackOnSuccess:function(t,e,i){return function(t){}}(t,e,i)});BX.CJSTask.ajaxUrl=s;if(!BX.Tasks.GridActions.checkCanMove()){BX.Tasks.GridActions.reloadRow(e)}}}(e,t)})},onMarkChangeClick:function(t,e,i){BX.TaskGradePopup.show(t,e,i,{events:{onPopupClose:this.__onGradePopupClose,onPopupChange:this.__onGradePopupChange}});BX.addClass(e,"task-grade-and-report-selected");return false},__onGradePopupClose:function(){BX.removeClass(this.bindElement,"task-grade-and-report-selected")},__onGradePopupChange:function(){this.bindElement.className="task-grade-and-report"+(this.listValue!=="NULL"?" task-grade-"+this.listItem.className:"")+(this.report?" task-in-report":"");this.bindElement.title=BX.message("TASKS_MARK")+": "+this.listItem.name;BX.Tasks.GridActions.action("update",this.id,{data:{MARK:this.listValue==="NULL"?"":this.listValue}})},renderTimerItem:function(t,e,i,s,r,a){a=a||false;var n="task-timer-inner";var o=e+r;if(s){n=n+" task-timer-play"}else if(a){n=n+" task-timer-pause"}else{n=n+" task-timer-clock"}if(i>0&&o>i){n=n+" task-timer-overdue"}return BX.create("span",{props:{id:"task-timer-block-"+t,className:"task-timer-block"},events:{click:function(t,e){return function(){if(BX.hasClass(BX("task-timer-block-inner-"+t),"task-timer-play")){BX.TasksTimerManager.stop(t)}else if(e){BX.TasksTimerManager.start(t)}}}(t,a)},children:[BX.create("span",{props:{id:"task-timer-block-inner-"+t,className:n},children:[BX.create("span",{props:{className:"task-timer-icon"}}),BX.create("span",{props:{id:"task-timer-block-value-"+t,className:"task-timer-time"},text:BX.Tasks.GridActions.renderTimerTimes(o,i,s)})]})]})},renderTimerTimes:function(t,e,i){var s="";var r=!!i;s=BX.Tasks.GridActions.renderSecondsToHHMMSS(t,r);if(e>0){s=s+" / "+BX.Tasks.GridActions.renderSecondsToHHMMSS(e,false)}return s},renderSecondsToHHMMSS:function(t,e){var i="00";var s="";var r="";var a=0;if(t>0){s+=Math.floor(t/3600);r+=Math.floor(t/60)%60}else{s+=Math.ceil(t/3600);r+=Math.ceil(t/60)%60}var n=i.substring(0,2-s.length)+s+":"+i.substring(0,2-r.length)+r;if(e){a=""+t%60;n=n+":"+i.substring(0,2-a.length)+a}return n},redrawTimerNode:function(t,e,i,s,r,a){var n=BX("task-timer-block-"+t);var o=BX.Tasks.GridActions.renderTimerItem(t,e,i,s,r,a);if(n){n.parentNode.replaceChild(o,n)}else{var d=BX("task-timer-block-container-"+t);if(d){if(this.registeredTimerNodes[t]){BX.removeCustomEvent(window,"onTaskTimerChange",this.registeredTimerNodes[t])}d.appendChild(o);if(BX("task-timer-block-"+t)){this.registeredTimerNodes[t]=this.__getTimerChangeCallback(t);BX.addCustomEvent(window,"onTaskTimerChange",this.registeredTimerNodes[t])}}}},removeTimerNode:function(t){if(this.registeredTimerNodes[t]){BX.removeCustomEvent(window,"onTaskTimerChange",this.registeredTimerNodes[t])}var e=BX("task-timer-block-"+t);if(e){e.parentNode.removeChild(e)}},__getTimerChangeCallback:function(t){var e=null;return function(i){var s=null;var r=null;if(i.action==="refresh_daemon_event"){if(Number(i.taskId)!==Number(t)){if(e==="paused"){return}s="paused"}else{if(e!=="playing"){s="playing"}BX.Tasks.GridActions.redrawTimerNode(i.taskId,i.data.TASK.TIME_SPENT_IN_LOGS,i.data.TASK.TIME_ESTIMATE,true,i.data.TIMER.RUN_TIME,true)}}else if(i.action==="start_timer"){if(Number(t)===Number(i.taskId)&&i.timerData&&Number(t)===Number(i.timerData.TASK_ID)){s="playing"}else{s="paused"}}else if(i.action==="stop_timer"){if(Number(t)==Number(i.taskId)){s="paused"}}else if(i.action==="init_timer_data"){if(i.data.TIMER){if(Number(i.data.TIMER.TASK_ID)===Number(t)){s=i.data.TIMER.TIMER_STARTED_AT>0?"playing":"paused"}else if(i.data.TIMER.TASK_ID>0){s="paused"}}}if(s!==null){r=BX("task-timer-block-inner-"+t);if(r&&!BX.hasClass(r,"task-timer-clock")){if(s==="paused"){BX.removeClass(r,"task-timer-play");BX.addClass(r,"task-timer-pause")}else if(s==="playing"){BX.removeClass(r,"task-timer-pause");BX.addClass(r,"task-timer-play")}}e=s}}}};BX(function(){"use strict";BX.Tasks.Grid=function(t){this.grid=BX.Main.gridManager.getInstanceById(t.gridId);this.userId=Number(t.userId);this.ownerId=Number(t.ownerId);this.groupId=Number(t.groupId);this.sorting=t.sorting;this.groupByGroups=t.groupByGroups==="true";this.groupBySubTasks=t.groupBySubTasks==="true";this.arParams=t.arParams;this.calendarSettings=t.calendarSettings?t.calendarSettings:{};this.taskList=new Map;this.comments=new Map;this.query=new BX.Tasks.Util.Query({url:"/bitrix/components/bitrix/tasks.task.list/ajax.php"});this.actions={taskAdd:"taskAdd",taskUpdate:"taskUpdate",taskRemove:"taskRemove",commentAdd:"commentAdd",pinChanged:"pinChanged"};this.isMyList=this.userId===this.ownerId;this.canPin=!this.groupId;this.updateCanMove();this.init(t)};BX.Tasks.Grid.prototype={init:function(t){this.bindEvents();this.fillTasksList(t.taskList);this.handleGridRows()},bindEvents:function(){var t={comment_add:this.onPullCommentAdd,comment_read_all:this.onPullCommentReadAll,task_add:this.onPullTaskAdd,task_update:this.onPullTaskUpdate,task_view:this.onPullTaskView,task_remove:this.onPullTaskRemove,user_option_changed:this.onUserOptionChanged};BX.addCustomEvent("onPullEvent-tasks",function(e,i){if(t[e]){t[e].apply(this,[i])}}.bind(this));BX.addCustomEvent("BX.Main.grid:sort",function(t,e){if(e===this.grid){this.sorting.sort={};this.sorting.sort[t.sort_by]=t.sort_order}}.bind(this));BX.addCustomEvent("BX.Main.grid:paramsUpdated",function(){this.updateCanMove();this.handleGridRows();this.taskList.clear();this.getRows().map(function(t){return t.getId()}).filter(function(t){return t!=="template_0"}).forEach(function(t){this.taskList.set(t)}.bind(this))}.bind(this));BX.addCustomEvent("BX.Tasks.Filter.group",function(t,e,i){if(this.grid===t){this[e]=i}}.bind(this))},updateCanMove:function(){this.canMove=this.isMyList&&this.sorting.sort.ACTIVITY_DATE&&this.sorting.sort.ACTIVITY_DATE==="desc"&&!this.groupByGroups&&!this.groupBySubTasks},checkCanMove:function(){return this.canMove},fillTasksList:function(t){Object.keys(t).forEach(function(t){this.taskList.set(t)}.bind(this))},handleGridRows:function(){this.getRows().forEach(function(t){var e=t.getNode();if(BX.data(e,"pinned")==="Y"){BX.addClass(e,"tasks-list-item-pinned")}else{BX.removeClass(e,"tasks-list-item-pinned")}})},onPullTaskView:function(t){if(this.userId!==Number(t.USER_ID)||!this.isRowExist(t.TASK_ID.toString())){return}this.updateActivityDateCellForTasks([t.TASK_ID])},onPullCommentReadAll:function(t){if(this.userId!==Number(t.USER_ID)||this.groupId!==Number(t.GROUP_ID)){return}this.updateActivityDateCellForTasks(Array.from(this.taskList.keys()))},updateActivityDateCellForTasks:function(t,e,i){e=e||{};i=i||{};var s={taskIds:t,data:{},arParams:this.arParams};if(e){Object.keys(e).forEach(function(t){s.data[t]=e[t]})}this.query.run("this.prepareGridRowsForTasks",s).then(function(t){if(t.data){Object.keys(t.data).forEach(function(e){if(this.isRowExist(e)){var s=this.getRowById(e);if(s.getCellById("ACTIVITY_DATE")){s.setCellsContent({ACTIVITY_DATE:t.data[e].content.ACTIVITY_DATE})}if(i.highlightRow===true){this.highlightGridRow(e)}}}.bind(this))}}.bind(this));this.query.execute()},onPullCommentAdd:function(t){if(this.checkComment(t)){var e=t.entityXmlId.split("_");if(e){this.checkTask(e[1],{action:this.actions.commentAdd,userId:Number(t.ownerId),isCompleteComment:t.isCompleteComment})}}},onPullTaskAdd:function(t){if(t.params.addCommentExists===false){this.checkTask(t.TASK_ID.toString(),{action:this.actions.taskAdd})}},onPullTaskUpdate:function(t){if(t.params.updateCommentExists===false){this.checkTask(t.TASK_ID.toString(),{action:this.actions.taskUpdate})}else if(t.params.removedParticipants.includes(this.ownerId.toString())&&(!this.groupId||this.groupId!==Number(t.AFTER.GROUP_ID))){this.removeItem(t.TASK_ID.toString())}},onPullTaskRemove:function(t){if(this.checkCanMove()){this.removeItem(t.TASK_ID.toString())}},onUserOptionChanged:function(t){if(!this.checkCanMove()||this.userId!==Number(t.USER_ID)){return}var e=t.TASK_ID.toString();switch(Number(t.OPTION)){case 1:this.onMuteChanged(e);break;case 2:if(this.canPin){this.onPinChanged(e)}break;default:break}},onMuteChanged:function(t){if(this.isRowExist(t)){var e={taskIds:[t],arParams:this.arParams};this.query.run("this.prepareGridRowsForTasks",e).then(function(t){if(t.data){Object.keys(t.data).forEach(function(e){if(this.isRowExist(e)){var i=t.data[e];var s=this.getRowById(e);s.setCellsContent({TITLE:i.content.TITLE,ACTIVITY_DATE:i.content.ACTIVITY_DATE});s.setActions(i.actions)}}.bind(this))}}.bind(this));this.query.execute()}},onPinChanged:function(t){this.placeToNearTasks(t,null,{action:this.actions.pinChanged})},placeToNearTasks:function(t,e,i){var s={taskId:t,navigation:{pageNumber:this.getPageNumber(),pageSize:this.getPageSize()},arParams:this.arParams};this.query.run("this.getNearTasks",s).then(function(s){if(s.data){var r=s.data.before;var a=s.data.after;if(r&&this.isRowExist(r)||a&&this.isRowExist(a)){var n={before:r,after:a};Object.keys(i).forEach(function(t){n[t]=i[t]});this.updateItem(t,e,n)}else{this.removeItem(t)}}}.bind(this));this.query.execute()},checkComment:function(t){var e=t.entityXmlId.split("_");if(!e){return false}var i=e[0];var s=e[1];if(i!=="TASK"){return false}if(!this.comments.has(s)){this.comments.set(s,new Set)}var r=this.comments.get(s);var a=t.messageId;var n=t.participants.map(function(t){return t.toString()});if(r.has(a)){return false}r.add(a);return n.includes(this.userId.toString())||this.groupId===t.groupId},checkTask:function(t,e){e=e||{};var i={RETURN_ACCESS:"Y"};if(e.isCompleteComment===false||e.userId===this.userId){i.SIFT_THROUGH_FILTER={userId:this.ownerId,groupId:this.groupId}}BX.ajax.runAction("tasks.task.list",{data:{filter:{ID:t},params:i}}).then(function(i){this.onCheckTaskSuccess(i,t,e)}.bind(this))},onCheckTaskSuccess:function(t,e,i){if(!t.data.tasks.length){this.removeItem(e);return}var s=t.data.tasks[0];if(this.isRowExist(e)){if(this.checkCanMove()){i.canMoveRow=i.action!==this.actions.taskUpdate;this.updateGridRow(e,s,i)}else{if(i.action===this.actions.commentAdd){var r={};r[e]=s;this.updateActivityDateCellForTasks([e],r,{highlightRow:true})}else if(i.action===this.actions.taskUpdate){this.getGrid().updateRow(e)}}}else if(this.checkCanMove()){if(i.action===this.actions.taskUpdate){this.placeToNearTasks(e,s,i)}else{this.updateItem(e,s,i)}}},updateItem:function(t,e,i){e=e||null;i=i||{};if(!this.taskList.has(t)){this.taskList.set(t);this.addGridRow(t,e,i)}else{this.updateGridRow(t,e,i)}},addGridRow:function(t,e,i){var s={taskIds:[t],data:{},arParams:this.arParams};if(e){s.data[t]=e}this.query.run("this.prepareGridRowsForTasks",s).then(function(e){if(e.data&&e.data[t]){this.getGrid().hideEmptyStub();var s=e.data[t];var r=this.getGrid().getTemplateRow();r.setId(t);r.setCellsContent(s.content);r.setActions(s.actions);r.makeCountable();r.show();this.handlePinProp(r);this.moveGridRow(t,i);this.highlightGridRow(t);this.handleGridRows();this.getGrid().bindOnRowEvents();this.getGrid().updateCounterDisplayed();this.getGrid().updateCounterSelected()}}.bind(this));this.query.execute()},updateGridRow:function(t,e,i){if(!this.isRowExist(t)){return}var s={taskIds:[t],data:{},arParams:Object.assign(this.arParams,i.arParams||{})};if(e){s.data[t]=e}this.query.run("this.prepareGridRowsForTasks",s).then(function(e){if(e.data&&e.data[t]){var s=e.data[t];var r=this.getRowById(t);r.setCellsContent(s.content);r.setActions(s.actions);this.handlePinProp(r);this.moveGridRow(t,i);this.highlightGridRow(t);this.handleGridRows();this.getGrid().bindOnRowEvents()}}.bind(this));this.query.execute()},removeItem:function(t){if(!this.isRowExist(t)){return}this.taskList.delete(t);this.highlightGridRow(t).then(function(){this.getGrid().removeRow(t)}.bind(this))},moveGridRow:function(t,e){if(e.canMoveRow===false){return}this.getGrid().getRows().reset();switch(e.action){case this.actions.pinChanged:this.moveRow(t,e.after,e.before);break;case this.actions.taskUpdate:this.moveRow(t,e.after,e.before);break;default:var i=this.getRowById(t);var s=i&&this.getRowProp(i,"pinned")==="Y";this.moveRow(t,s?0:this.getLastPinnedRowId(),this.getFirstRowId());break}},moveRow:function(t,e,i){if(e){this.getGrid().getRows().insertAfter(t,e)}else if(i){this.getGrid().getRows().insertBefore(t,i)}},getLastPinnedRowId:function(){var t=0;this.getRows().reverse().forEach(function(e){if(!t&&this.getRowProp(e,"pinned")==="Y"){t=this.getRowProp(e,"id")}}.bind(this));return t},getFirstRowId:function(){var t=this.getRows();return t.length?this.getRowProp(t[0],"id"):0},handlePinProp:function(t){var e=!!t.getCellById("TITLE").querySelector(".task-title-pin");this.setRowProp(t,"pinned",e?"Y":"N")},highlightGridRow:function(t){var e=new BX.Promise;if(this.isRowExist(t)){var i=this.getRowNodeById(t);BX.addClass(i,"task-list-item-highlighted");setTimeout(function(){BX.removeClass(i,"task-list-item-highlighted");e.fulfill()}.bind(this),1e3)}return e},getGrid:function(){return this.grid},getRows:function(){return this.getGrid().getRows().getBodyChild()},isRowExist:function(t){return this.getRowById(t)!==null},getRowById:function(t){return this.getGrid().getRows().getById(t)},getRowNodeById:function(t){return this.getRowById(t).getNode()},getRowProp:function(t,e){return BX.data(t.getNode(),e)},setRowProp:function(t,e,i){t.getNode().setAttribute("data-"+e,i)},getPageNumber:function(){var t=1;var e=this.getGrid().getContainer().querySelector(".main-grid-nav-panel");if(e){var i=e.querySelector(".main-ui-pagination");if(i){var s=i.querySelector(".main-ui-pagination-active");if(s){t=s.innerText}}}return t},getPageSize:function(){var t=50;var e=BX(this.getGrid().getContainerId()+"_"+this.getGrid().settings.get("pageSizeId"));if(e){t=BX.data(e,"value")}return t}};BX.addCustomEvent("tasksTaskEvent",BX.delegate(function(t,e){if(!BX.Tasks.GridActions.checkCanMove()){BX.Tasks.GridActions.reloadGrid()}},this));BX.addCustomEvent("SidePanel.Slider:onCloseByEsc",function(t){var e=/tasks\/task\/edit/;var i=t.getSlider().getUrl();if(e.test(i)&&!confirm(BX.message("TASKS_CLOSE_PAGE_CONFIRM"))){t.denyAction()}});BX.addCustomEvent("BX.Main.Filter:apply",function(t,e,i){var s=window.location.href;var r=new URL(s);var a=r.searchParams.get("F_STATE");var n=a==="sR"?s.replace("&F_STATE=sR",""):s;window.history.replaceState(null,null,n)}.bind(this));BX.addCustomEvent("Tasks.TopMenu:onItem",function(t,e){var i=BX.Main.filterManager.getById(BX.Tasks.GridActions.gridId);if(!i){console.log("BX.Main.filterManager not initialised");return}var s={preset_id:BX.Tasks.GridActions.defaultPresetId,additional:{ROLEID:t==="view_all"?0:t}};var r=i.getApi();r.setFilter(s,{ROLE_TYPE:"TASKS_ROLE_TYPE_"+(t===""?"view_all":t)});window.history.pushState(null,null,e)});BX.addCustomEvent("Tasks.Toolbar:onItem",function(t){var e=BX.Main.filterManager.getById(BX.Tasks.GridActions.gridId);if(!e){console.log("BX.Main.filterManager not initialised");return}var i=e.getApi();var s=e.getFilterFieldsValues();if(Number(t)===12582912||Number(t)===6291456){var r={ROLEID:s.hasOwnProperty("ROLEID")?s.ROLEID:0,PROBLEM:t};i.setFields(r);i.apply({COUNTER_TYPE:"TASKS_COUNTER_TYPE_"+t})}else{r={preset_id:BX.Tasks.GridActions.defaultPresetId,additional:{PROBLEM:t}};if(s.hasOwnProperty("ROLEID")){r.additional.ROLEID=s.ROLEID}i.setFilter(r)}});BX.Tasks.Grid.Sorting=function(t){this.grid=BX.Main.gridManager.getInstanceById(t.gridId);this.currentGroupId=t.currentGroupId;this.treeMode=t.treeMode;BX.message(t.messages);this.init();BX.addCustomEvent("BX.Main.grid:rowDragStart",this.handleRowDragStart.bind(this));BX.addCustomEvent("BX.Main.grid:rowDragMove",this.handleRowDragMove.bind(this));BX.addCustomEvent("BX.Main.grid:rowDragEnd",this.handleRowDragEnd.bind(this))};BX.Tasks.Grid.Sorting.prototype={init:function(){this.dragRow=null;this.targetRow=null;this.error=false;this.targetTask=null;this.before=true;this.newGroup=null;this.newParentId=null},getGrid:function(){return this.grid},getRow:function(t){return this.getGrid().getRows().get(t)},getRowById:function(t){return this.getGrid().getRows().getById(t)},getRows:function(){return this.getGrid().getRows().getBodyChild()},getRowProp:function(t,e){return t.getNode().dataset[e]},getRowType:function(t){return this.getRowProp(t,"type")},getRowGroupId:function(t){return this.getRowProp(t,"groupId")},handleRowDragStart:function(t,e){this.dragRow=this.getRow(t.getDragItem())},handleRowDragMove:function(t,e){this.targetRow=this.getRow(t.getTargetItem());var i=this.targetRow?this.getRowType(this.targetRow):null;this.newParentId=null;this.error=false;var s=null;if(i==="task"){var r=this.targetRow.getParentId();if(r!==this.dragRow.getParentId()){this.newParentId=r}s=this.getGroupByRow(this.targetRow);this.targetTask=this.targetRow;this.before=true}else{if(i==="group"){s=this.getPreviousGroup(this.targetRow)}else{s=this.getLastGroup()}var a=this.getClosestTask(this.targetRow);this.targetTask=a.task;this.before=a.before}this.newGroup=s.id!==this.getGroupByRow(this.dragRow).id?s:null;if(i==="task"&&this.isChildOf(this.targetTask,this.dragRow)){this.error=true}else if(this.newGroup&&(this.getRowProp(this.dragRow,"canEdit")==="false"||!this.newGroup.canCreateTasks)){this.error=true}else if(this.newParentId!==null&&this.getRowProp(this.dragRow,"canEdit")==="false"){this.error=true}this.error?t.disallowMove(BX.message("TASKS_ACCESS_DENIED")):t.allowMove()},handleRowDragEnd:function(t,e){if(!this.error){this.save()}this.init()},save:function(){var t=this.dragRow.getId();var e=this.targetTask?this.targetTask.getId():null;if(t===e){return}var i={sourceId:t,targetId:e,before:this.before,currentGroupId:this.currentGroupId};if(this.newGroup!==null){i.newGroupId=this.newGroup.id;this.setGroupId(this.dragRow,i.newGroupId)}if(this.newParentId!==null&&this.treeMode){i.newParentId=this.newParentId}var s=new BX.Tasks.Util.Query;s.run("task.sorting.move",{data:i}).then(function(t){if(!t.getErrors().isEmpty()){BX.Tasks.confirm(t.getErrors().getMessages().join(" "),function(){BX.reload()},{buttonSet:[]})}});s.execute()},getParentRow:function(t){return this.getRowById(t.getParentId())},isChildOf:function(t,e){var i=this.getParentRow(t);while(i!==null){if(i===e){return true}i=this.getParentRow(i)}return false},getGroupById:function(t){var e=this.getRows();for(var i=0;i<e.length;i++){var s=e[i];if(this.getRowType(s)==="group"&&this.getRowGroupId(s)===String(t)){return this.getGroupByRow(s)}}return this.getDefaultProject()},setGroupId:function(t,e){t.getDataset().groupId=e;var i=t.getChildren();for(var s=0;s<i.length;s++){this.setGroupId(i[s],e)}},getDefaultProject:function(){return{id:"0",canCreateTasks:true}},getGroupByRow:function(t){if(this.getRowType(t)==="group"){return{id:this.getRowGroupId(t),canCreateTasks:this.getRowProp(t,"canCreateTasks")==="true"}}else{return this.getGroupById(this.getRowGroupId(t))}},getLastGroup:function(){var t=null;var e=this.getRows();for(var i=e.length-1;i>=0;i--){var s=e[i];if(this.getRowType(s)==="group"){return this.getGroupByRow(s)}}return this.getDefaultProject()},getPreviousGroup:function(t){var e=null;var i=this.getRows();var s=false;for(var r=i.length-1;r>=0;r--){var a=i[r];if(t===a){s=true;continue}if(s&&this.getRowType(a)==="group"){return this.getGroupByRow(a)}}return this.getDefaultProject()},getClosestTask:function(t){var e=this.getRows();var i=t?t.getIndex()-1:e.length;for(var s=i-1;s>=0;s--){if(this.getRowType(e[s])==="task"&&e[s].getDepth()==="0"){return{task:e[s],before:false}}}for(s=i+1;s<e.length;s++){if(this.getRowType(e[s])==="task"&&e[s].getDepth()==="0"){return{task:e[s],before:true}}}return{task:null,before:true}}}});
//# sourceMappingURL=script.map.js