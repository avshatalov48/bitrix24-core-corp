{"version":3,"file":"script.js","sources":["src/index.js"],"sourcesContent":["import { ajax as Ajax, Runtime } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\n\nclass TaskResultMobile\n{\n\ttaskId = 0;\n\tuserId = 0;\n\titemsContentNode = null;\n\titemsNodes = null;\n\titemsWrapperNode = null;\n\tneedTutorial = false;\n\tmessages = {};\n\n\tconstructor(taskId, userId, params)\n\t{\n\t\tthis.init(taskId, userId, params);\n\t\tthis.setHeightAutoFunction = this.setHeightAuto.bind(this);\n\t}\n\n\tinit(taskId, userId, params)\n\t{\n\t\tthis.taskId = taskId;\n\t\tthis.userId = userId;\n\t\tthis.needTutorial = params.needTutorial;\n\t\tthis.messages = params.messages;\n\n\t\tthis.initExpand();\n\n\t\tBXMobileApp.addCustomEvent('onPull-tasks', this.onPush.bind(this));\n\t}\n\n\tblockResize()\n\t{\n\t\tthis.contentNode.style.height = `${this.containerNode.scrollHeight}px`;\n\t}\n\n\tinitExpand()\n\t{\n\t\tif (this.contentNode)\n\t\t{\n\t\t\tthis.blockResize();\n\t\t}\n\n\t\tthis.contentNode = document.getElementById(`mobile-tasks-result-list-container-${this.taskId}`);\n\t\tthis.containerNode = document.getElementById(`tasks-result-list-wrapper-${this.taskId}`);\n\n\t\tif (!this.containerNode)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.itemsContentNode = this.containerNode.querySelector('[data-role=\"mobile-tasks-widget--content\"]');\n\t\tthis.itemsNodes = this.containerNode.querySelectorAll('[data-role=\"mobile-tasks-widget--result-item\"]');\n\t\tthis.itemsWrapperNode = this.containerNode.querySelector('[data-role=\"mobile-tasks-widget--wrapper\"]');\n\n\t\tif (this.itemsWrapperNode && this.itemsNodes.length > 1)\n\t\t{\n\t\t\tthis.itemsNodes.length === 2\n\t\t\t\t? this.itemsContentNode.classList.add('--two-results')\n\t\t\t\t: this.itemsContentNode.classList.add('--many-results');\n\t\t}\n\n\t\tthis.itemsContentNode && this.itemsContentNode.addEventListener('click', () => {\n\t\t\tthis.itemsContentNode.classList.add('--open');\n\t\t\tthis.itemsWrapperNode.style.height = `${this.itemsWrapperNode.scrollHeight}px`;\n\t\t\tthis.itemsWrapperNode.addEventListener('transitionend', this.setHeightAutoFunction);\n\n\t\t\tif (this.contentNode && this.itemsWrapperNode.offsetHeight === 0)\n\t\t\t{\n\t\t\t\tthis.contentNode.style.height = `${this.itemsWrapperNode.scrollHeight + this.containerNode.scrollHeight}px`;\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('BX.Forum.Spoiler:toggle', this.onSpoilerToggle.bind(this));\n\t}\n\n\tonSpoilerToggle(event)\n\t{\n\t\tconst [ eventData ] = event.getCompatData();\n\n\t\tif (!eventData.node)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst targetContentNode = eventData.node.closest('.mobile-tasks-result-list-container');\n\t\tif (\n\t\t\t!targetContentNode\n\t\t\t|| !this.contentNode\n\t\t\t|| targetContentNode.id !== this.contentNode.id\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.blockResize();\n\t}\n\n\tsetHeightAuto()\n\t{\n\t\tthis.itemsWrapperNode.style.height = 'auto';\n\t\tthis.itemsWrapperNode.removeEventListener('transitionend', this.setHeightAutoFunction);\n\t};\n\n\tonPush(event)\n\t{\n\t\tconst command = event.command;\n\t\tconst params = event.params;\n\n\t\tif (command === 'comment_add')\n\t\t{\n\t\t\tthis.onCommentAdd(command, params);\n\t\t}\n\t\telse if (\n\t\t\tcommand === 'task_result_create'\n\t\t\t|| command === 'task_result_update'\n\t\t\t|| command === 'task_result_delete'\n\t\t)\n\t\t{\n\t\t\tthis.onResultUpdate(command, params);\n\t\t}\n\t}\n\n\tonResultUpdate(command, params)\n\t{\n\t\tif (\n\t\t\t!params.result\n\t\t\t|| !params.result.taskId\n\t\t\t|| params.result.taskId != this.taskId\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.reloadResults();\n\t}\n\n\tonCommentAdd(command, params)\n\t{\n\t\tif (!this.needTutorial)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (\n\t\t\t!params.taskId\n\t\t\t|| params.taskId != this.taskId\n\t\t\t|| !params.ownerId\n\t\t\t|| params.ownerId != this.userId\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\t(new BXMobileApp.UI.NotificationBar({\n\t\t\ttitle: this.messages.tutorialTitle,\n\t\t\tmessage: this.messages.tutorialMessage,\n\t\t\tcolor: \"#af000000\",\n\t\t\ttextColor: \"#ffffff\",\n\t\t\tisGlobal: true,\n\t\t\tautoHideTimeout: 6500,\n\t\t\thideOnTap: true\n\t\t}, 'copy')).show();\n\n\t\t// send ajax request to disable tutorial\n\t\tAjax.runComponentAction('bitrix:tasks.widget.result', 'disableTutorial', {\n\t\t\tmode: 'class',\n\t\t\tdata: {},\n\t\t}).then((response) => {});\n\t}\n\n\treloadResults()\n\t{\n\t\tAjax.runComponentAction('bitrix:tasks.widget.result', 'getResults', {\n\t\t\tmode: 'class',\n\t\t\tdata: {\n\t\t\t\ttaskId: this.taskId,\n\t\t\t\tmode: 'mobile',\n\t\t\t}\n\t\t}).then((response) => {\n\t\t\tif (!response.data)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.containerNode.innerHTML = response.data;\n\t\t\tRuntime.html(this.containerNode, response.data).then(() => {\n\t\t\t\tthis.initExpand();\n\t\t\t});\n\t\t});\n\t}\n}\n\nexport {\n\tTaskResultMobile,\n}\n"],"names":["TaskResultMobile","taskId","userId","params","init","setHeightAutoFunction","setHeightAuto","bind","needTutorial","messages","initExpand","BXMobileApp","addCustomEvent","onPush","contentNode","style","height","containerNode","scrollHeight","blockResize","document","getElementById","itemsContentNode","querySelector","itemsNodes","querySelectorAll","itemsWrapperNode","length","classList","add","addEventListener","offsetHeight","EventEmitter","subscribe","onSpoilerToggle","event","getCompatData","eventData","node","targetContentNode","closest","id","removeEventListener","command","onCommentAdd","onResultUpdate","result","reloadResults","ownerId","UI","NotificationBar","title","tutorialTitle","message","tutorialMessage","color","textColor","isGlobal","autoHideTimeout","hideOnTap","show","Ajax","runComponentAction","mode","data","then","response","innerHTML","Runtime","html"],"mappings":"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"}