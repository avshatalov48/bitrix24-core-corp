{"version":3,"file":"script.js","sources":["src/index.js"],"sourcesContent":["import { ajax as Ajax, Runtime, Type } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\n\nclass TaskResult\n{\n\ttaskId = null;\n\titemsContentNode = null;\n\ttargetBtnDown = null;\n\ttargetBtnUp = null;\n\titemsNodes = null;\n\titemsWrapperNode = null;\n\n\tconstructor(taskId)\n\t{\n\t\tthis.init(taskId);\n\t\tthis.setHeightAutoFunction = this.setHeightAuto.bind(this);\n\t}\n\n\tinit(taskId)\n\t{\n\t\tthis.taskId = taskId;\n\n\t\tthis.initExpand();\n\n\t\tEventEmitter.subscribe('onPullEvent-tasks', this.onPushResult.bind(this));\n\t\tEventEmitter.subscribe('BX.Livefeed:recalculateComments', this.onRecalculateLivefeedComments.bind(this));\n\t\tEventEmitter.subscribe('SidePanel.Slider:onOpenComplete', this.blockResize.bind(this));\n\t};\n\n\tblockResize()\n\t{\n\t\tthis.contentNode.style.height = `${this.containerNode.scrollHeight}px`;\n\t}\n\n\tinitExpand()\n\t{\n\t\tthis.initExpandButton();\n\n\t\tif (this.contentNode)\n\t\t{\n\t\t\tthis.blockResize();\n\t\t}\n\n\t\tthis.targetBtnDown && this.targetBtnDown.addEventListener('click', () => {\n\t\t\tthis.targetBtnDown.classList.remove('--visible');\n\t\t\tthis.targetBtnUp.classList.add('--visible');\n\n\t\t\tthis.itemsContentNode.classList.add('--open');\n\t\t\tthis.itemsWrapperNode.style.height = `${this.itemsWrapperNode.scrollHeight}px`;\n\t\t\tthis.itemsWrapperNode.addEventListener('transitionend', this.setHeightAutoFunction);\n\n\t\t\tif (this.contentNode)\n\t\t\t{\n\t\t\t\tthis.contentNode.style.height = `${this.itemsWrapperNode.scrollHeight + this.containerNode.scrollHeight}px`;\n\t\t\t}\n\t\t});\n\n\t\tthis.targetBtnUp && this.targetBtnUp.addEventListener('click', () => {\n\t\t\tthis.targetBtnUp.classList.remove('--visible');\n\t\t\tthis.targetBtnDown.classList.add('--visible');\n\n\t\t\tthis.itemsContentNode.classList.remove('--open');\n\t\t\tthis.itemsWrapperNode.style.height = `${this.itemsWrapperNode.scrollHeight}px`;\n\t\t\tthis.itemsWrapperNode.clientHeight; // it's needed, P.Rafeev magic\n\t\t\tthis.itemsWrapperNode.style.height = 0;\n\n\t\t\tif (this.contentNode)\n\t\t\t{\n\t\t\t\tthis.contentNode.style.height = `${this.itemsNodes[0].offsetHeight + 35}px`;\n\t\t\t}\n\t\t});\n\t}\n\n\tsetHeightAuto()\n\t{\n\t\tthis.itemsWrapperNode.style.height = 'auto';\n\t\tthis.itemsWrapperNode.removeEventListener('transitionend', this.setHeightAutoFunction);\n\t}\n\n\tinitExpandButton()\n\t{\n\t\tthis.contentNode = document.getElementById(`tasks-result-list-container-${this.taskId}`);\n\t\tthis.containerNode = document.getElementById(`tasks-result-list-wrapper-${this.taskId}`);\n\n\t\tif (!this.containerNode)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.itemsContentNode = this.containerNode.querySelector('[data-role=\"tasks-widget--content\"]');\n\t\tthis.targetBtnDown = this.containerNode.querySelector('[data-role=\"tasks-widget--btn-down\"]');\n\t\tthis.targetBtnUp = this.containerNode.querySelector('[data-role=\"tasks-widget--btn-up\"]');\n\t\tthis.itemsNodes = this.containerNode.querySelectorAll('[data-role=\"tasks-widget--result-item\"]');\n\t\tthis.itemsWrapperNode = this.containerNode.querySelector('[data-role=\"tasks-widget--wrapper\"]');\n\n\t\tif (\n\t\t\t!this.itemsWrapperNode\n\t\t\t|| this.itemsNodes.length <= 1\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.targetBtnDown.classList.add('--visible');\n\n\t\tthis.itemsNodes.length === 2\n\t\t\t? this.itemsContentNode.classList.add('--two-results')\n\t\t\t: this.itemsContentNode.classList.add('--many-results');\n\n\t\tEventEmitter.subscribe('BX.Forum.Spoiler:toggle', this.onSpoilerToggle.bind(this));\n\t}\n\n\tonSpoilerToggle(event)\n\t{\n\t\tconst [ eventData ] = event.getCompatData();\n\n\t\tif (!eventData.node)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst targetContentNode = eventData.node.closest('.tasks-result-list-container');\n\t\tif (\n\t\t\t!targetContentNode\n\t\t\t|| !this.contentNode\n\t\t\t|| targetContentNode.id !== this.contentNode.id\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.blockResize();\n\t}\n\n\tonPushResult(event: BaseEvent)\n\t{\n\t\tconst [ command, params ] = event.getData();\n\n\t\tif (\n\t\t\tcommand !== 'task_result_create'\n\t\t\t&& command !== 'task_result_update'\n\t\t\t&& command !== 'task_result_delete'\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (\n\t\t\t!params.result\n\t\t\t|| !params.result.taskId\n\t\t\t|| params.result.taskId != this.taskId\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.reloadResults();\n\t}\n\n\tonRecalculateLivefeedComments(event: BaseEvent)\n\t{\n\t\tconst [ data ] = event.getCompatData();\n\t\tif (!Type.isDomNode(data.rootNode))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst taskResultContainer = data.rootNode.querySelector('.tasks-result-list-container');\n\t\tif (\n\t\t\t!taskResultContainer\n\t\t\t|| taskResultContainer.id !== this.contentNode.id\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.blockResize();\n\t}\n\n\treloadResults()\n\t{\n\t\tAjax.runComponentAction('bitrix:tasks.widget.result', 'getResults', {\n\t\t\tmode: 'class',\n\t\t\tdata: {\n\t\t\t\ttaskId: this.taskId,\n\t\t\t}\n\t\t}).then(\n\t\t(response) => {\n\t\t\tif (!response.data)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.containerNode.innerHTML = response.data;\n\t\t\tRuntime.html(this.containerNode, response.data).then(() => {\n\t\t\t\tthis.initExpand();\n\t\t\t});\n\t\t});\n\t}\n\n}\n\nexport {\n\tTaskResult,\n}"],"names":["TaskResult","taskId","init","setHeightAutoFunction","setHeightAuto","bind","initExpand","EventEmitter","subscribe","onPushResult","onRecalculateLivefeedComments","blockResize","contentNode","style","height","containerNode","scrollHeight","initExpandButton","targetBtnDown","addEventListener","classList","remove","targetBtnUp","add","itemsContentNode","itemsWrapperNode","clientHeight","itemsNodes","offsetHeight","removeEventListener","document","getElementById","querySelector","querySelectorAll","length","onSpoilerToggle","event","getCompatData","eventData","node","targetContentNode","closest","id","getData","command","params","result","reloadResults","data","Type","isDomNode","rootNode","taskResultContainer","Ajax","runComponentAction","mode","then","response","innerHTML","Runtime","html"],"mappings":"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"}