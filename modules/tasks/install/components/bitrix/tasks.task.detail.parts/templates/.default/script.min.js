var tasksDetailPartsNS={tasksListAjaxUrl:"/bitrix/components/bitrix/tasks.list/ajax.php?SITE_ID="+BX.message("SITE_ID"),detailsAjaxUrl:"/bitrix/components/bitrix/tasks.task.detail/ajax.php?SITE_ID="+BX.message("SITE_ID"),responsiblePopup:null,accomplicesPopup:null,auditorsPopup:null,arAccomplices:[],arAuditors:[],timerCallback:null,insertAfterItemId:null,checklistCounter:0,loadedSelectors:{DELEGATE:null,RESPONSIBLE:null,ACCOMPLICES:null,AUDITORS:null},getSerialId:function(){var e=0;return function(){if(arguments[0]===0)e=0;return e++}}(),toggleFavorite:function(e,t){if(typeof tasksDetailsNS!="undefined"){tasksDetailsNS.toggleFavorite(e,t)}},initChecklist:function(e){if(e)return;if(typeof tasksDetailPartsNS.checkListCompletedShown=="undefined"){tasksDetailPartsNS.checkListCompletedShown=false}tasksDetailPartsNS.toggleCompletedCheckListItems(tasksDetailPartsNS.checkListCompletedShown);try{BX.bind(BX("task-detail-checklist-show-completed"),"click",tasksDetailPartsNS.showCompletedCheckListItems)}catch(e){}try{BX.bind(BX("task-detail-checklist-hide-completed"),"click",tasksDetailPartsNS.hideCompletedCheckListItems)}catch(e){}},checklistToggle:function(e,t,a,s){var i=BX("task-detail-checklist-item-"+a);if(BX.hasClass(i,"task-detail-checklist-item-processing"))return;BX.addClass(i,"task-detail-checklist-item-processing");var l=null;if(!e)l=new BX.CJSTask.Item(t);if(s.checked){if(e){BX.addClass(i,"task-detail-checklist-item-complete");BX.removeClass(i,"task-detail-checklist-item-processing");BX("task-detail-checklist-item-"+a+"-hiddenIsChecked").value="Y"}else{l.checklistComplete(a,{callbackOnSuccess:function(e){return function(t){BX.addClass(e,"task-detail-checklist-item-complete");BX.removeClass(e,"task-detail-checklist-item-processing")}}(i),callbackOnFailure:function(e,t){return function(a){BX.removeClass(e,"task-detail-checklist-item-processing");t.checked=false;tasksDetailPartsNS.recalcChecklist()}}(i,s)})}}else{if(e){BX.removeClass(i,"task-detail-checklist-item-complete");BX.removeClass(i,"task-detail-checklist-item-processing");BX("task-detail-checklist-item-"+a+"-hiddenIsChecked").value="N"}else{l.checklistRenew(a,{callbackOnSuccess:function(e){return function(t){BX.removeClass(e,"task-detail-checklist-item-complete");BX.removeClass(e,"task-detail-checklist-item-processing")}}(i),callbackOnFailure:function(e,t){return function(a){BX.removeClass(e,"task-detail-checklist-item-processing");t.checked=true;tasksDetailPartsNS.recalcChecklist()}}(i,s)})}}tasksDetailPartsNS.recalcChecklist()},checklistAddItem:function(e,t){if(BX("task-detail-checklist-add-text").disabled)return;var a=BX("task-detail-checklist-add-text").value;if(a.length==0)return;BX("task-detail-checklist-add-text").disabled=true;BX("task-detail-checklist-add-link").style.display="none";if(e){var s="xxx_"+Date.now()+"_"+tasksDetailPartsNS.getSerialId();BX("task-detail-checklist-items").appendChild(this.renderChecklistItem(e,t,s,a,false));this.initChecklistItem(e,t,s,a,false);BX("task-detail-checklist-add-text").value="";BX("task-detail-checklist-add-text").disabled=false;BX("task-detail-checklist-add-text").focus();BX("task-detail-checklist-add-link").style.display="";tasksDetailPartsNS.recalcChecklist()}else{var i=new BX.CJSTask.Item(t);i.checklistAddItem(a,{callbackOnSuccess:function(e,t,a){return function(s){var i=s.rawReply.data[0]["justCreatedId"];var l=s.rawReply.data[0]["requestedData"]["TITLE"];var n=s.rawReply.data[0]["requestedData"]["IS_COMPLETE"]==="Y";BX("task-detail-checklist-items").appendChild(e.renderChecklistItem(t,a,i,l,n));e.initChecklistItem(t,a,i,l,n);BX("task-detail-checklist-add-text").value="";BX("task-detail-checklist-add-text").disabled=false;BX("task-detail-checklist-add-text").focus();BX("task-detail-checklist-add-link").style.display="";tasksDetailPartsNS.recalcChecklist()}}(this,e,t),callbackOnFailure:function(e){BX("task-detail-checklist-add-text").disabled=false;BX("task-detail-checklist-add-link").style.display=""}})}},checklistRemoveItem:function(e,t,a){var s=BX("task-detail-checklist-item-"+a);if(BX.hasClass(s,"task-detail-checklist-item-processing"))return;BX.addClass(s,"task-detail-checklist-item-processing");if(e){BX.remove(s);tasksDetailPartsNS.recalcChecklist()}else{var i=new BX.CJSTask.Item(t);i.checklistDelete(a,{callbackOnSuccess:function(e){return function(t){BX.remove(e);tasksDetailPartsNS.recalcChecklist()}}(s),callbackOnFailure:function(e){return function(t){BX.removeClass(e,"task-detail-checklist-item-processing")}}(s)})}},checklistRename:function(e,t,a,s){if(s.length==0)return;var i=BX("task-detail-checklist-item-"+a);if(BX.hasClass(i,"task-detail-checklist-item-processing-saving"))return;BX.addClass(i,"task-detail-checklist-item-processing-saving");if(e){BX.removeClass(i,"task-detail-checklist-item-processing");BX.removeClass(i,"task-detail-checklist-item-processing-saving");BX.removeClass(i,"task-detail-checklist-item-processing-edit");BX("task-detail-checklist-item-"+a+"-title").innerHTML=BX.util.htmlspecialchars(s);BX("task-detail-checklist-item-"+a+"-hiddenTitle").value=s;window.jsDD.Enable()}else{var l=new BX.CJSTask.Item(t);l.checklistRename(a,s,{callbackOnSuccess:function(e,t,a,s){return function(e){var t=BX("task-detail-checklist-item-"+a);BX.removeClass(t,"task-detail-checklist-item-processing");BX.removeClass(t,"task-detail-checklist-item-processing-saving");BX.removeClass(t,"task-detail-checklist-item-processing-edit");BX("task-detail-checklist-item-"+a+"-title").innerHTML=BX.util.htmlspecialchars(s);window.jsDD.Enable()}}(this,t,a,s),callbackOnFailure:function(e,t,a){return function(e){var a=BX("task-detail-checklist-item-"+t);BX.removeClass(a,"task-detail-checklist-item-processing-saving");window.jsDD.Enable()}}(t,a,s)})}},checklistMoveAfterItem:function(e,t,a,s){if(!e){var i=BX("task-detail-checklist-item-"+a);if(BX.hasClass(i,"task-detail-checklist-item-processing-saving"))return;BX.addClass(i,"task-detail-checklist-item-processing-saving");if(s>0)BX.addClass(BX("task-detail-checklist-item-"+s),"task-detail-checklist-item-processing-saving");var l=new BX.CJSTask.Item(t);l.checklistMoveAfterItem(a,s,{callbackOnSuccess:function(e,t,a,s){return function(e){BX.removeClass(BX("task-detail-checklist-item-"+a),"task-detail-checklist-item-processing-saving");if(s>0)BX.removeClass(BX("task-detail-checklist-item-"+s),"task-detail-checklist-item-processing-saving")}}(this,t,a,s),callbackOnFailure:function(e,t,a){return function(e){BX.removeClass(BX("task-detail-checklist-item-"+t),"task-detail-checklist-item-processing-saving");if(a>0)BX.removeClass(BX("task-detail-checklist-item-"+a),"task-detail-checklist-item-processing-saving")}}(t,a,s)})}tasksDetailPartsNS.recalcChecklist()},checklistEditItem:function(e,t){var a=BX("task-detail-checklist-item-"+t);var s=BX("task-detail-checklist-item-"+t+"-label");if(BX.hasClass(a,"task-detail-checklist-item-processing"))return;window.jsDD.Disable();BX.addClass(a,"task-detail-checklist-item-processing");BX.addClass(a,"task-detail-checklist-item-processing-edit");BX("task-detail-checklist-item-"+t+"-editInput").focus();this.setCursorPosition(BX("task-detail-checklist-item-"+t+"-editInput"),BX("task-detail-checklist-item-"+t+"-editInput").value.length)},renderChecklistItem:function(e,t,a,s,i,l){var n="task-detail-checklist-item task-detail-checklist-allow-edit task-detail-checklist-allow-remove";if(i)n=n+" task-detail-checklist-item-complete";if(typeof l=="undefined")l={};var r=BX.create("div",{props:{id:"task-detail-checklist-item-"+a,className:n},children:[BX.create("label",{props:{id:"task-detail-checklist-item-"+a+"-label",className:"task-detail-checklist-item-label"},children:[l["readonly"]?false:BX.create("input",{props:{type:"checkbox",checked:i},events:{click:function(e,t,a,s){return function(){s.checklistToggle(e,t,a,this)}}(e,t,a,this)}}),BX.create("span",{props:{className:"task-detail-checklist-item-counter"},style:l["readonly"]?{cursor:"default"}:{},html:++tasksDetailPartsNS.checklistCounter+". "}),BX.create("span",{props:{id:"task-detail-checklist-item-"+a+"-title"},style:l["readonly"]?{cursor:"default"}:{},html:typeof l.display!="undefined"&&l.display.toString().length>0?l.display:BX.util.htmlspecialchars(s)})],events:{click:function(e){if(!e)var e=window.event;if(e){var t=e.target||e.srcElement;var a=t&&typeof t.nodeName!="undefined"&&t.nodeName=="A";var s=t&&typeof t.nodeName!="undefined"&&t.nodeName=="INPUT"&&t.checked!="undefined";if(!a&&!s){BX.PreventDefault(e)}}}}}),BX.create("input",{props:{type:"text",className:"task-detail-checklist-item-edit",id:"task-detail-checklist-item-"+a+"-editInput",maxlength:250,value:s},events:{keypress:function(e,t,a){return function(s){tasksDetailPartsNS.checklistEditOnKeyPress(s,e,t,a)}}(e,t,a)}}),BX.create("input",{props:{id:"task-detail-checklist-item-"+a+"-hiddenId",type:"hidden",name:"CHECKLIST_ITEM_ID[]",value:a}}),BX.create("input",{props:{id:"task-detail-checklist-item-"+a+"-hiddenTitle",type:"hidden",name:"CHECKLIST_ITEM_TITLE["+a+"]",value:s}}),BX.create("input",{props:{id:"task-detail-checklist-item-"+a+"-hiddenIsChecked",type:"hidden",name:"CHECKLIST_ITEM_IS_CHECKED["+a+"]",value:i?"Y":"N"}}),BX.create("span",{props:{className:"task-detail-checklist-save"},events:{click:function(e,t,a,s){return function(){var i="task-detail-checklist-item-"+a+"-editInput";s.checklistRename(e,t,a,BX(i).value)}}(e,t,a,this)}}),l["readonly"]?false:BX.create("span",{props:{className:"task-table-edit"},events:{click:function(e,t,a,s){return function(){s.checklistEditItem(t,a)}}(e,t,a,this)}}),l["readonly"]?false:BX.create("span",{props:{className:"task-table-remove"},events:{click:function(e,t,a,s){return function(){s.checklistRemoveItem(e,t,a)}}(e,t,a,this)}})]});return r},recalcChecklist:function(){var e=BX.findChildren(BX("task-detail-checklist-items"),{tagName:"input",attribute:{type:"checkbox"}},true);var t=BX.findChildren(BX("task-detail-checklist-items"),{tagName:"span",className:"task-detail-checklist-item-counter"},true);var a;var s=0;var i=0;for(a in e){if(e[a].checked)i++;s++}if(i>0){BX("task-detail-checklist-title-text").innerHTML=BX.message("TASKS_DETAIL_CHECKLIST_DETAILED").replace("#CHECKED#",i).replace("#TOTAL#",s)}else BX("task-detail-checklist-title-text").innerHTML=BX.message("TASKS_DETAIL_CHECKLIST");tasksDetailPartsNS.checklistCounter=0;for(a in t)t[a].innerHTML=++tasksDetailPartsNS.checklistCounter+". "},showCompletedCheckListItems:function(){tasksDetailPartsNS.toggleCompletedCheckListItems(true)},hideCompletedCheckListItems:function(){tasksDetailPartsNS.toggleCompletedCheckListItems(false)},toggleCompletedCheckListItems:function(e){BX[e?"removeClass":"addClass"](BX("task-detail-checklist-scope"),"task-detail-checklist-hide-completed");tasksDetailPartsNS.checkListCompletedShown=e},initChecklistItem:function(e,t,a,s,i){var l=BX("task-detail-checklist-item-"+a);l.onbxdragstart=function(){window.bxblank=this.parentNode.insertBefore(BX.create("DIV",{style:{height:tasksDetailPartsNS.getFullHeight(BX(this.id))+"px",margin:"3px 5px 3px 5px",paddingLeft:"40px"}}),this);this.style.position="absolute"};l.onbxdrag=function(e,t){var a=BX.pos(BX("task-detail-checklist-items"));t-=a.top+5;this.style.top=t+"px"};l.onbxdragstop=function(){this.parentNode.replaceChild(this,window.bxblank);this.style.position="static";var s=null;if(tasksDetailPartsNS.insertAfterItemId==="task-detail-checklist-top-land-zone")s=0;else if(tasksDetailPartsNS.insertAfterItemId.substr(0,27)==="task-detail-checklist-item-")s=parseInt(tasksDetailPartsNS.insertAfterItemId.substr(27,tasksDetailPartsNS.insertAfterItemId.length-27));if(s!==null){tasksDetailPartsNS.checklistMoveAfterItem(e,t,a,s)}};l.onbxdraghover=function(e,t,a){if(this.id===e.id)return;e.parentNode.insertBefore(window.bxblank,e.nextSibling);tasksDetailPartsNS.insertAfterItemId=window.bxblank.previousSibling.id};window.jsDD.registerDest(l);window.jsDD.registerObject(l)},setCursorPosition:function(e,t){if(e.setSelectionRange){e.setSelectionRange(t,t)}else if(e.createTextRange){var a=e.createTextRange();a.collapse(true);a.moveEnd("character",t);a.moveStart("character",t);a.select()}},checklistEditOnKeyPress:function(e,t,a,s){if(!e)var e=window.event;var i=e.keyCode||e.which;if(i!=13)return;tasksDetailPartsNS.checklistRename(t,a,s,BX("task-detail-checklist-item-"+s+"-editInput").value)},checklistSaveItem:function(e,t,a){var s=e.keyCode||e.which;if(s!=13)return;tasksDetailPartsNS.checklistAddItem(t,a)},ShowActionMenu:function(e,t,a){BX.PopupMenu.destroy(t);BX.PopupMenu.show(t,e,a,{});return false},loadUserSelectorViaAjax:function(e,t,a){var s=0;var i="N";var l=null;var n=null;var r=null;var c={};if(a){if(a.callbackOnSelect)r=a.callbackOnSelect;if(a.callbackOnReady)n=a.callbackOnReady;if(a.groupId)s=a.groupId;if(a.bindElement)l=a.bindElement;if(a.multiple)i=a.multiple}if(!tasksDetailPartsNS.loadedSelectors[e]){c={requestedObject:"intranet.user.selector.new",selectedUsersIds:t,anchorId:l,multiple:i,GROUP_ID_FOR_SITE:s,callbackOnSelect:function(e){return function(t){if(e)e(t)}}(r),onReady:function(e,t){return function(a){tasksDetailPartsNS.loadedSelectors[t]=a;if(e)e(a)}}(n,e)};if(a&&a.callbackOnChange){c.callbackOnChange=function(e){return function(t){e(t)}}(a.callbackOnChange)}BX.Tasks.lwPopup.__initSelectors([c])}else{if(n)n(tasksDetailPartsNS.loadedSelectors[e])}},ShowDelegatePopup:function(e,t,a){tasksDetailPartsNS.loadUserSelectorViaAjax("DELEGATE",null,{groupId:a,bindElement:e,callbackOnReady:function(e,t){return function(a){tasksDetailPartsNS.__ShowDelegatePopup(a.name,e,t)}}(e,t),callbackOnSelect:function(e){tasksDetailPartsNS.onDelegateChange(e)}})},__ShowDelegatePopup:function(e,t,a){delegatePopup=BX.PopupWindowManager.create("delegate-employee-popup",t,{offsetTop:1,autoHide:true,closeByEsc:true,content:BX(e+"_selector_content"),buttons:[new BX.PopupWindowButton({text:BX.message("TASKS_SELECT"),className:"popup-window-button-accept",events:{click:function(e){if(!e)e=window.event;return function(e){var t=BX.create("form",{props:{method:"POST"},style:{display:"none"},children:[BX.create("input",{props:{name:"ACTION",value:"delegate"}}),BX.create("input",{props:{name:"sessid",value:BX.message("bitrix_sessid")}}),BX.create("input",{props:{name:"ID",value:a}}),BX.create("input",{props:{name:"USER_ID",value:delegateUser}})]});document.body.appendChild(t);BX.submit(t);this.popupWindow.close()}}()}}),new BX.PopupWindowButtonLink({text:BX.message("TASKS_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(e){if(!e)e=window.event;this.popupWindow.close();BX.PreventDefault(e)}}})]});delegatePopup.show()},onDelegateChange:function(e){if(e)delegateUser=e.id},showResponsibleChangePopup:function(e,t,a,s){tasksDetailPartsNS.loadUserSelectorViaAjax("RESPONSIBLE",s,{groupId:a,bindElement:e,callbackOnReady:function(e,t){return function(t){tasksDetailPartsNS.responsiblePopup=BX.PopupWindowManager.create("responsible-employee-popup",e,{offsetTop:1,autoHide:true,closeByEsc:true,content:BX(t.name+"_selector_content")});tasksDetailPartsNS.responsiblePopup.show();BX.focus(e)}}(e,t),callbackOnSelect:function(e){tasksDetailPartsNS.onResponsibleSelect(e)}})},onDeleteClick:function(e,t){if(!e)e=window.event;BX.PreventDefault(e);if(window.top.BX.TasksIFrameInst&&window.top.BX.TasksIFrameInst.isOpened()){var a={mode:"delete",sessid:BX.message("bitrix_sessid"),id:t};BX.ajax({method:"POST",dataType:"json",url:tasksDetailPartsNS.tasksListAjaxUrl,data:a,processData:true,onsuccess:function(t){return function(a){tasksDetailPartsNS.onDeleteClick_onSuccess(e,t,a);BX.UI.Notification.Center.notify({content:BX.message("TASKS_DELETE_SUCCESS")})}}(t)})}},onDeleteClick_onSuccess:function(e,t,a){if(a&&a.length>0){}else{window.top.BX.TasksIFrameInst.close();window.top.BX.TasksIFrameInst.onTaskDeleted(t)}},getMembersAddChangeFunction:function(e,t,a,s,i){return function(l){if(!l)l=window.event;var n=null;var r=null;if(e==="AUDITORS"){n=tasksDetailPartsNS._auditorsAddChange;r=tasksDetailPartsNS.onAuditorsChange}else if(e==="ACCOMPLICES"){n=tasksDetailPartsNS._accomplicesAddChange;r=tasksDetailPartsNS.onAccomplicesChange}else throw"Unknown memberType : "+e;tasksDetailPartsNS.loadUserSelectorViaAjax(e,i,{groupId:s,multiple:"Y",bindElement:t,callbackOnReady:function(e,t,a){return function(s){a(s,e,t)}}(t,a,n),callbackOnChange:function(e){return function(t){e(t)}}(r)});BX.focus(t);BX.PreventDefault(l)}},_auditorsAddChange:function(e,t,a){tasksDetailPartsNS.arAuditors=e.arSelected;tasksDetailPartsNS.auditorsPopup=BX.PopupWindowManager.create("auditors-employee-popup",t,{autoHide:true,closeByEsc:true,content:BX(e.name+"_selector_content"),buttons:[new BX.PopupWindowButton({text:BX.message("TASKS_SELECT"),className:"popup-window-button-accept",events:{click:function(e){if(!e)e=window.event;var t=tasksDetailPartsNS.renderMembersBlock("auditors",tasksDetailPartsNS.arAuditors,this.popupWindow);BX.ajax.post(tasksDetailPartsNS.tasksListAjaxUrl,{mode:"auditors",sessid:BX.message("bitrix_sessid"),id:detailTaksID,path_to_user:BX.message("TASKS_PATH_TO_USER_PROFILE"),path_to_task:BX.message("TASKS_PATH_TO_TASK"),path_to_user_tasks_task:BX.message("TASKS_PATH_TO_USER_TASKS_TASK"),auditors:t},function(){BX.Tasks.Util.fireGlobalTaskEvent("UPDATE",{ID:detailTaksID},{STAY_AT_PAGE:true},{id:detailTaksID})});this.popupWindow.close()}}}),new BX.PopupWindowButtonLink({text:BX.message("TASKS_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(e){if(!e)e=window.event;this.popupWindow.close();BX.PreventDefault(e)}}})]});tasksDetailPartsNS.auditorsPopup.show()},_accomplicesAddChange:function(e,t,a){tasksDetailPartsNS.arAccomplices=e.arSelected;tasksDetailPartsNS.accomplicesPopup=BX.PopupWindowManager.create("assistants-employee-popup",t,{autoHide:true,closeByEsc:true,content:BX(e.name+"_selector_content"),buttons:[new BX.PopupWindowButton({text:BX.message("TASKS_SELECT"),className:"popup-window-button-accept",events:{click:function(e){if(!e)e=window.event;var t=tasksDetailPartsNS.renderMembersBlock("accomplices",tasksDetailPartsNS.arAccomplices,this.popupWindow);var a={mode:"accomplices",sessid:BX.message("bitrix_sessid"),id:detailTaksID,path_to_user:BX.message("TASKS_PATH_TO_USER_PROFILE"),path_to_task:BX.message("TASKS_PATH_TO_TASK"),accomplices:t};BX.ajax.post(tasksDetailPartsNS.tasksListAjaxUrl,a);this.popupWindow.close()}}}),new BX.PopupWindowButtonLink({text:BX.message("TASKS_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(e){if(!e)e=window.event;this.popupWindow.close();BX.PreventDefault(e)}}})]});tasksDetailPartsNS.accomplicesPopup.show()},stopWatch:function(e){var t=new BX.CJSTask.Item(e);t.stopWatch({callbackOnSuccess:function(e){var t=BX("task-detail-info-user-auditor-"+BX.message("USER_ID")+"-container");if(t)t.parentNode.removeChild(t);if(BX("task-detail-info-stop-watch"))BX("task-detail-info-stop-watch").style.display="none";if(BX("task-detail-info-start-watch-block"))BX("task-detail-info-start-watch-block").style.display="";var a=tasksDetailPartsNS.arAuditors.indexOf(BX.message("USER_ID"));if(a!=-1)tasksDetailPartsNS.arAuditors.splice(a,1);if(!tasksDetailPartsNS.isAuditorsInAuditorsBlock())BX.addClass(BX("task-detail-info-auditors"),"task-detail-info-users-empty")}(e)})},startWatch:function(e){var t=new BX.CJSTask.Item(e);t.startWatch({callbackOnSuccess:function(e){tasksDetailPartsNS.addUserToAuditorsBlock({id:BX.message("USER_ID"),name:BX.message("TASKS_LOGGED_IN_USER_FORMATTED_NAME"),position:BX.message("TASKS_LOGGED_IN_USER_WORK_POSITION")});if(BX("task-detail-info-stop-watch"))BX("task-detail-info-stop-watch").style.display="";if(BX("task-detail-info-start-watch-block"))BX("task-detail-info-start-watch-block").style.display="none"}(e)})},addUserToAuditorsBlock:function(e){if(BX("task-detail-info-user-auditor-"+e.id+"-container"))return;BX("task-detail-auditors").appendChild(tasksDetailPartsNS.RenderUser(e));BX.removeClass(BX("task-detail-info-auditors"),"task-detail-info-users-empty");tasksDetailPartsNS.arAuditors.push(e.id)},isAuditorsInAuditorsBlock:function(){var e=BX("task-detail-auditors");var t=null;for(var a=0;a<e.childNodes.length;a++){t=e.childNodes[a];if(t&&t.className&&t.className=="task-detail-info-user")return true}return false},renderMembersBlock:function(e,t,a){var s="";var l=[];if(e==="auditors"){s="auditors"}else if(e==="accomplices"){s="assistants"}div=BX("task-detail-"+s);BX.cleanNode(div);for(i=0;i<t.length;i++){if(t[i]){div.appendChild(tasksDetailPartsNS.RenderUser(t[i]));l.push(t[i].id)}}if(l.length>0){BX.removeClass(BX("task-detail-info-"+s),"task-detail-info-users-empty");BX("task-detail-info-"+s+"-add").parentNode.style.display="none";if(a)a.setBindElement(BX("task-detail-info-"+s+"-change"))}else{BX.addClass(BX("task-detail-info-"+s),"task-detail-info-users-empty");BX("task-detail-info-"+s+"-add").parentNode.style.display="block";if(a)a.setBindElement(BX("task-detail-info-"+s+"-add"))}return l},RenderUser:function(e,t){var a=[];if(t){a.push(BX.create("a",{props:{href:BX.message("TASKS_PATH_TO_USER_PROFILE").replace("#user_id#",e.id),className:"task-detail-info-user-avatar"},style:{background:e.photo?"url('"+e.photo+"') no-repeat center center":""}}))}a.push(BX.create("div",{props:{className:"task-detail-info-user-info"},children:[BX.create("div",{props:{className:"task-detail-info-user-name"},children:[BX.create("a",{props:{href:BX.message("TASKS_PATH_TO_USER_PROFILE").replace("#user_id#",e.id)},text:e.name})]}),BX.create("div",{props:{className:"task-detail-info-user-position"},text:e.position})]}));return BX.create("div",{props:{id:"task-detail-info-user-auditor-"+e.id+"-container",className:"task-detail-info-user"},children:a})},ShowGradePopupDetail:function(e,t,a){BX.TaskGradePopup.show(e,t,a,{events:{onPopupChange:tasksDetailPartsNS.__onGradePopupChangeDetail}});return false},__onGradePopupChangeDetail:function(){this.bindElement.className="task-detail-grade task-detail-grade-"+this.listItem.className;this.bindElement.childNodes[1].innerHTML=this.listItem.name;var e={mode:"mark",sessid:BX.message("bitrix_sessid"),id:this.id,mark:this.listValue};BX.ajax.post(tasksDetailPartsNS.tasksListAjaxUrl,e)},ShowPriorityPopupDetail:function(e,t,a){BX.TaskPriorityPopup.show(e,t,a,{events:{onPopupChange:tasksDetailPartsNS.__onPriorityChangeDetail}});return false},__onPriorityChangeDetail:function(){this.bindElement.className="task-detail-priority task-detail-priority-"+this.listValue;this.bindElement.childNodes[1].innerHTML=this.listItem.name;var e={mode:"priority",sessid:BX.message("bitrix_sessid"),id:this.id,path_to_user:BX.message("TASKS_PATH_TO_USER_PROFILE"),path_to_task:BX.message("TASKS_PATH_TO_TASK"),path_to_user_tasks_task:BX.message("TASKS_PATH_TO_USER_TASKS_TASK"),priority:this.listValue};BX.ajax.post(tasksDetailPartsNS.tasksListAjaxUrl,e);if(taskData.priority!=this.listValue&&window.top.BX.TasksIFrameInst){taskData.priority=this.listValue;window.top.BX.TasksIFrameInst.onTaskChanged(taskData)}},onResponsibleSelect:function(e){var t="",a=null;var s=BX.findNextSibling(tasksDetailPartsNS.responsiblePopup.bindElement,{tag:"div"});BX.cleanNode(s);s.appendChild(tasksDetailPartsNS.RenderUser(e,true));var i={mode:"responsible",sessid:BX.message("bitrix_sessid"),id:detailTaksID,path_to_user:BX.message("TASKS_PATH_TO_USER_PROFILE"),path_to_task:BX.message("TASKS_PATH_TO_TASK"),path_to_user_tasks_task:BX.message("TASKS_PATH_TO_USER_TASKS_TASK"),responsible:e.id};if(window.top!=window){if(window.top.tasksListNS&&window.top.tasksListNS.arFilter){t=window.top.tasksListNS.arFilter;a=window.top.tasksListNS.getColumnsOrder()}}if(a!==null)i["columnsOrder"]=a;BX.ajax({url:tasksDetailPartsNS.tasksListAjaxUrl,dataType:"json",method:"POST",data:i,processData:true,onsuccess:function(e){var t,a;t=BX.parseJSON(e.tasksRenderJSON);a=t.html;window.top.BX.TasksIFrameInst.onTaskChanged(t,null,null,null,a)}});if(taskData.responsibleId!=e.id&&window.top.BX.TasksIFrameInst){taskData.responsibleId=e.id;taskData.responsible=e.name}tasksDetailPartsNS.responsiblePopup.close()},onAuditorsChange:function(e){tasksDetailPartsNS.arAuditors=e},onAccomplicesChange:function(e){tasksDetailPartsNS.arAccomplices=e},ClearDeadline:function(e,t){t.style.display="none";var a=BX("task-deadline-hidden");a.value="";BX.cleanNode(a.previousSibling);var s=document.createElement("span");s.innerHTML=BX.message("TASKS_SIDEBAR_DEADLINE_NO");a.previousSibling.appendChild(s);a.previousSibling.className="webform-field-action-link";var i={mode:"deadline",sessid:BX.message("bitrix_sessid"),id:e,deadline:""};BX.ajax.post(tasksDetailPartsNS.tasksListAjaxUrl,i)},reloadRightSideBar:function(e,t){tasksDetailPartsNS.__reloadBlock(e,"right_sidebar",t)},reloadButtons:function(e){var t=BX("task-detail-buttons-div");if(t)BX.addClass(t,"task-buttons-to-be-reloaded");tasksDetailPartsNS.__reloadBlock(e,"buttons","N")},__reloadBlock:function(e,t,a){var s=null;if(t==="buttons")s=BX("task-detail-buttons-area");else if(t==="right_sidebar")s=BX("task-detail-right-sidebar");else throw"Error [0x37479de4]";BX.ajax.post(tasksDetailPartsNS.detailsAjaxUrl+"&action=render_task_detail_part",{sessid:BX.message("bitrix_sessid"),MODE:BX.message("TASKS_CONTEXT_PARTS_MODE"),INNER_HTML:"Y",BLOCK:t,IS_IFRAME:BX.message("TASKS_CONTEXT_IS_IFRAME"),PATH_TO_TEMPLATES_TEMPLATE:BX.message("TASKS_CONTEXT_PATH_TO_TEMPLATES_TEMPLATE"),PATH_TO_TASKS_TASK:BX.message("TASKS_CONTEXT_PATH_TO_TASKS_TASK"),PATH_TO_USER_PROFILE:BX.message("TASKS_CONTEXT_PATH_TO_USER_PROFILE"),NAME_TEMPLATE:BX.message("TASKS_CONTEXT_NAME_TEMPLATE"),FIRE_ON_CHANGED_EVENT:a===true?"Y":"N",TASK_ID:e},function(e){s.innerHTML=e})},doAction:function(e,t){var a=null,s,i=null,l=null;if(t==="start_timer"){BX.TasksTimerManager.start(e);return}else if(t==="stop_timer"){BX.TasksTimerManager.stop(e);return}switch(t){case"approve":a="CTaskItem::approve()";break;case"disapprove":a="CTaskItem::disapprove()";break;case"complete":a="CTaskItem::complete()";break;case"start":a="CTaskItem::startExecution()";break;case"pause":a="CTaskItem::pauseExecution()";break;case"renew":a="CTaskItem::renew()";break;case"defer":a="CTaskItem::defer()";break;default:throw"tasks module unexpected error: [0x15a49c7f] unknown actionName: "+t;return false;break}if(window.top!=window){if(window.top.tasksListNS&&window.top.tasksListNS.arFilter){l=window.top.tasksListNS.arFilter;i=window.top.tasksListNS.getColumnsOrder()}}s={operation:"tasksRenderJSON() && tasksRenderListItem()",taskData:{ID:"#RC#$arOperationsResults#-3#requestedTaskId"}};if(i!==null)s["columnsIds"]=i;if(l!==null)s["arFilter"]=l;BX.CJSTask.batchOperations([{operation:a,taskData:{ID:e}},{operation:"CTaskItem::getTaskData()",taskData:{ID:"#RC#$arOperationsResults#-1#requestedTaskId"}},{operation:"CTaskTimerManager::getLastTimer()"},s],{callbackOnSuccess:function(e){return function(t){var a,s;var i=false;var l=true;tasksDetailPartsNS.reloadButtons(e);tasksDetailPartsNS.reloadRightSideBar(e,l);BX.TasksTimerManager.reLoadInitTimerDataFromServer();if(t.status==="success"){if(t.rawReply.data[2].returnValue&&t.rawReply.data[2].returnValue.TASK_ID&&t.rawReply.data[1].returnValue.ID==t.rawReply.data[2].returnValue.TASK_ID){i=t.rawReply.data[1].returnValue}BX.TasksTimerManager.onDataRecieved({TASKS_TIMER:t.rawReply.data[2].returnValue,TASK_ON_TIMER:i});if(t.rawReply.data[3].returnValue&&t.rawReply.data[3].returnValue.tasksRenderListItem&&t.rawReply.data[3].returnValue.tasksRenderJSON){a=BX.parseJSON(t.rawReply.data[3].returnValue.tasksRenderJSON);s=t.rawReply.data[3].returnValue.tasksRenderListItem;window.top.BX.TasksIFrameInst.onTaskChanged(a,null,null,null,s)}}}}(e),callbackOnFailure:function(e){return function(t){var a=true;tasksDetailPartsNS.reloadButtons(e);tasksDetailPartsNS.reloadRightSideBar(e,a);BX.TasksTimerManager.reLoadInitTimerDataFromServer()}}(e)})},renderSecondsToHHMMSS:function(e,t){var a="00";var s=""+Math.floor(e/3600);var i=""+Math.floor(e/60)%60;var l=0;var n="";n=a.substring(0,2-s.length)+s+":"+a.substring(0,2-i.length)+i;if(t){l=""+e%60;n=n+":"+a.substring(0,2-l.length)+l}return n},initTimer:function(e,t){if(tasksDetailPartsNS.timerCallback!==null){BX.removeCustomEvent(window,"onTaskTimerChange",tasksDetailPartsNS.timerCallback);tasksDetailPartsNS.timerCallback=null}var a=null;if(t==="Y")a="playing";else if(t==="N")a="paused";tasksDetailPartsNS.timerCallback=tasksDetailPartsNS.onTaskTimerChange(e,a);BX.addCustomEvent(window,"onTaskTimerChange",tasksDetailPartsNS.timerCallback)},onTaskTimerChange:function(e,t){var a=null;var s=0;var i=0;var l=0;if(t)a=t;return function(t){var n=null;var r="";var c="";var o="";if(t.action==="refresh_daemon_event"){if(t.taskId!==e)n="paused";else{n="playing";if(s===0)s=BX("task_details_buttons_timer_"+e+"_text");if(i===0)i=BX("task-detail-spent-time-"+e);if(l===0)l=BX("task-detail-estimate-time-"+e);if(s||i||l){r=tasksDetailPartsNS.renderSecondsToHHMMSS(t.data.TASK.TIME_SPENT_IN_LOGS+t.data.TIMER.RUN_TIME,true);if(t.data.TASK.TIME_ESTIMATE>0){c=tasksDetailPartsNS.renderSecondsToHHMMSS(t.data.TASK.TIME_ESTIMATE,false);o=tasksDetailPartsNS.renderSecondsToHHMMSS(t.data.TASK.TIME_ESTIMATE,true)}if(s){if(c!=="")s.innerHTML=r+" / "+c;else s.innerHTML=r}if(i)i.innerHTML=r;if(l){if(o!=="")l.innerHTML=o;else l.innerHTML=BX.message("TASKS_SIDEBAR_NO_ESTIMATE_TIME")}}}}else if(t.action==="start_timer"){if(e==t.taskId&&t.timerData&&e==t.timerData.TASK_ID){n="playing"}else n="paused"}else if(t.action==="stop_timer"){if(e==t.taskId)n="paused"}else if(t.action==="init_timer_data"){if(t.data.TIMER){if(t.data.TIMER.TASK_ID==e){if(t.data.TIMER.TIMER_STARTED_AT>0)n="playing";else n="paused"}else if(t.data.TIMER.TASK_ID>0){n="paused"}}}if(n!==null&&n!==a){timerBlock=BX("task_details_buttons_timer_"+e);if(timerBlock){if(n==="paused")BX.removeClass(timerBlock,"task-timeman-link-green");else if(n==="playing"){if(!BX.hasClass(timerBlock,"task-timeman-link-red"))BX.addClass(timerBlock,"task-timeman-link-green")}}a=n;if(t.action==="start_timer"||t.action==="stop_timer"){tasksDetailPartsNS.reloadButtons(e);tasksDetailPartsNS.reloadRightSideBar(e,true)}}}},getFullHeight:function(e){var t,a;if(BX.browser.IsIE()){t=e.clientHeight;a=parseInt(e.currentStyle.marginTop)+parseInt(e.currentStyle.marginBottom)+"px"}else{t=document.defaultView.getComputedStyle(e,"").getPropertyValue("height");a=parseInt(document.defaultView.getComputedStyle(e,"").getPropertyValue("margin-top"))+parseInt(document.defaultView.getComputedStyle(e,"").getPropertyValue("margin-bottom"))+"px"}return parseInt(t+a)}};