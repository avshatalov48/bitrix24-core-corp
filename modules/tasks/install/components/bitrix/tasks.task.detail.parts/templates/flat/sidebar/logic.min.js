BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TaskViewSidebar!="undefined"){return}BX.Tasks.Component.TaskViewSidebar=function(t){this.layout={stagesWrap:BX("tasksStagesWrap"),stages:BX("tasksStages")};this.parameters=t||{};this.taskId=this.parameters.taskId;this.messages=this.parameters.messages||{};this.workingTime=this.parameters.workingTime||{start:{hours:0,minutes:0},end:{hours:0,minutes:0}};this.can=this.parameters.can||{};this.allowTimeTracking=this.parameters.allowTimeTracking===true;this.user=this.parameters.user||{};this.isAmAuditor=this.parameters.iAmAuditor;this.auditorCtrl=null;this.pathToTasks=this.parameters.pathToTasks;this.stageId=parseInt(this.parameters.stageId);this.stages=this.parameters.stages||{};this.query=new BX.Tasks.Util.Query;this.initDeadline();this.initReminder();this.initMark();this.initTime();this.initTags();this.initAuditorThing();this.initStages();BX.addCustomEvent(window,"tasksTaskEvent",BX.delegate(this.onTaskEvent,this));BX.addCustomEvent(window,"onChangeProjectLink",BX.delegate(this.onChangeProjectLink,this))};BX.Tasks.Component.TaskViewSidebar.prototype.initAuditorThing=function(){if(!this.can.EDIT){BX.Tasks.Util.Dispatcher.find("auditor-selector").then(function(t){this.auditorCtrl=t;t.bindControl("header-button","click",this.onToggleImAuditor.bind(this))}.bind(this))}};BX.Tasks.Component.TaskViewSidebar.prototype.initStages=function(){if(this.layout.stages&&this.stages){var t=this.parameters.can.SORT;var e=this.stages.length>0;BX.cleanNode(this.layout.stages);for(var s=0,i=this.stages.length;s<i;s++){this.layout.stages.appendChild(this.stages[s].TEXT_LAYOUT=BX.create("div",{attrs:{"data-stageId":this.stages[s].ID,title:this.stages[s].TITLE},props:{className:"task-section-status-step"},text:this.stages[s].TITLE,events:t?{click:BX.delegate(this.setStageHadnler,this)}:null,style:!t?{cursor:"default"}:null}))}if(e){BX.show(this.layout.stagesWrap);if(this.stageId>0){this.setStage(this.stageId)}else{this.setStage(this.stages[0].ID)}}else{BX.hide(this.layout.stagesWrap)}}};BX.Tasks.Component.TaskViewSidebar.prototype.onChangeProjectLink=function(t,e){t=parseInt(t);this.stageId=0;if(t===0){this.stages=[];this.initStages()}else{var s={entityId:t,entityType:"G"};this.query.run("task.stages.canmovetask",s).then(function(t){if(t.isSuccess()){this.parameters.can.SORT=t.data===true}}.bind(this));var s={entityId:t,numeric:true};this.query.run("task.stages.get",s).then(function(t){if(t.isSuccess()){this.stages=t.data;this.initStages()}}.bind(this));this.query.execute()}};BX.Tasks.Component.TaskViewSidebar.prototype.getStageData=function(t){t=parseInt(t);if(this.stages){for(var e in this.stages){if(parseInt(this.stages[e].ID)===t){return this.stages[e]}}}return null};BX.Tasks.Component.TaskViewSidebar.prototype.setStageHadnler=function(){var t=BX.data(BX.proxy_context,"stageId");this.setStage(t);this.saveStage(t)};BX.Tasks.Component.TaskViewSidebar.prototype.saveStage=function(t){t=parseInt(t);if(t===this.stageId){return}this.stageId=t;var e={id:this.taskId,stageId:t};this.query.run("task.stages.movetask",e).then(function(t){if(t.isSuccess()){BX.Tasks.Util.fireGlobalTaskEvent("UPDATE_STAGE",{ID:e.id,STAGE_ID:e.stageId},{STAY_AT_PAGE:true},{id:e.id})}}.bind(this));this.query.execute()};BX.Tasks.Component.TaskViewSidebar.prototype.setStage=function(t){var e=this.getStageData(t);t=parseInt(t);if(this.stages&&e){var s="#"+e["COLOR"];var i=true;var a;for(var n=0,r=this.stages.length;n<r;n++){a=this.stages[n].TEXT_LAYOUT;if(i){a.style.color=this.calculateTextColor(s);a.style.backgroundColor=s;a.style.borderBottomColor=s}else{a.style.backgroundColor="";a.style.borderBottomColor="#"+this.stages[n].COLOR}if(parseInt(this.stages[n].ID)===t){i=false}}}};BX.Tasks.Component.TaskViewSidebar.prototype.calculateTextColor=function(t){var e=["00c4fb","47d1e2","75d900","ffab00","ff5752","468ee5","1eae43"];var s,i,a;if(BX.util.in_array(t.toLowerCase(),e)){return"#fff"}else{var n=t.split("");if(n.length==3){n=[n[0],n[0],n[1],n[1],n[2],n[2]]}n="0x"+n.join("");s=n>>16&255;i=n>>8&255;a=n&255}var r=.21*s+.72*i+.07*a;return r<145?"#fff":"#333"};BX.Tasks.Component.TaskViewSidebar.prototype.onToggleImAuditor=function(){if(this.isAmAuditor){BX.Tasks.confirm(BX.message("TASKS_TTDP_TEMPLATE_USER_VIEW_LEAVE_AUDITOR_CONFIRM")).then(function(){this.syncAuditor()}.bind(this))}else{this.syncAuditor()}};BX.Tasks.Component.TaskViewSidebar.prototype.syncAuditor=function(){var t=this.taskId;var e=new BX.Tasks.Util.Query;e.run("task."+(this.isAmAuditor?"leaveauditor":"enterauditor"),{id:t}).then(function(t){if(t.isSuccess()){this.user.entityType="U";if(this.isAmAuditor){this.auditorCtrl.deleteItem(this.user)}else{this.auditorCtrl.addItem(this.user)}this.isAmAuditor=!this.isAmAuditor;this.auditorCtrl.setHeaderButtonLabelText(this.isAmAuditor?BX.message("TASKS_TTDP_TEMPLATE_USER_VIEW_LEAVE_AUDITOR"):BX.message("TASKS_TTDP_TEMPLATE_USER_VIEW_ENTER_AUDITOR"))}}.bind(this));e.run("task.checkcanread",{id:t}).then(function(t){if(t.isSuccess()){var e=t.getData();if(!e.READ){if(this.pathToTasks){window.document.location=this.pathToTasks}else{BX.reload()}}}}.bind(this));e.execute()};BX.Tasks.Component.TaskViewSidebar.prototype.onTaskEvent=function(t,e){e=e||{};var s=e.task||{};if(t=="UPDATE"&&s.ID==this.parameters.taskId){if(BX.type.isNotEmptyString(s.REAL_STATUS)&&BX.type.isNotEmptyString(s.STATUS_CHANGED_DATE)){this.setStatus(s.REAL_STATUS,s.STATUS_CHANGED_DATE)}}};BX.Tasks.Component.TaskViewSidebar.prototype.setStatus=function(t,e){var s=BX("task-detail-status-name");var i=BX("task-detail-status-date");s.innerHTML=BX.message("TASKS_STATUS_"+t);i.innerHTML=(t!=4&&t!=5?BX.message("TASKS_SIDEBAR_START_DATE")+" ":"")+BX.util.htmlspecialchars(e)};BX.Tasks.Component.TaskViewSidebar.prototype.initDeadline=function(){this.deadline=BX.type.isNotEmptyString(this.parameters.deadline)?this.parameters.deadline:"";this.layout.deadline=BX("task-detail-deadline");this.layout.deadlineClear=BX("task-detail-deadline-clear");if(!this.layout.deadline){return}BX.bind(this.layout.deadline,"click",BX.proxy(this.onDeadlineClick,this));BX.bind(this.layout.deadlineClear,"click",BX.proxy(this.clearDeadline,this))};BX.Tasks.Component.TaskViewSidebar.prototype.onDeadlineClick=function(t){var e=new Date;var s=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate(),this.workingTime.end.hours,this.workingTime.end.minutes));BX.calendar({node:this.layout.deadline,field:"",form:"",bTime:true,value:this.deadline?this.deadline:s,bHideTimebar:false,callback_after:BX.proxy(function(t,e){this.setDeadline(t)},this)})};BX.Tasks.Component.TaskViewSidebar.prototype.setDeadline=function(t){this.deadline=BX.calendar.ValueToString(t,true,false);this.layout.deadline.innerHTML=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME").replace(":SS","").replace("/SS","")),t,null,false);this.layout.deadlineClear.style.display="";this.updateDeadline()};BX.Tasks.Component.TaskViewSidebar.prototype.clearDeadline=function(){this.deadline="";this.layout.deadline.innerHTML=this.messages.emptyDeadline;this.layout.deadlineClear.style.display="none";this.updateDeadline()};BX.Tasks.Component.TaskViewSidebar.prototype.updateDeadline=function(){var t=new BX.Tasks.Util.Query;t.add("task.update",{id:this.taskId,data:{DEADLINE:this.deadline}},{},BX.delegate(function(){BX.onCustomEvent(window,"tasksTaskEventChangeDeadline",[this.taskId,this.deadline]);BX.Tasks.Util.fireGlobalTaskEvent("UPDATE",{ID:this.taskId},{STAY_AT_PAGE:true},{id:this.taskId,deadline:this.deadline})},this));t.execute()};BX.Tasks.Component.TaskViewSidebar.prototype.addReminder=function(){BX.onCustomEvent(window,"tasksTaskEventAddReminder",[this.layout.reminderAdd])};BX.Tasks.Component.TaskViewSidebar.prototype.initReminder=function(){this.layout.reminderAdd=BX("task-detail-reminder-add");BX.bind(this.layout.reminderAdd,"click",BX.delegate(this.addReminder,this))};BX.Tasks.Component.TaskViewSidebar.prototype.initMark=function(){if(!this.can["EDIT"]){return}this.mark=this.parameters.mark||"NULL";this.layout.mark=BX("task-detail-mark");if(this.layout.mark){BX.bind(this.layout.mark,"click",BX.proxy(this.onMarkClick,this))}};BX.Tasks.Component.TaskViewSidebar.prototype.onMarkClick=function(){BX.TaskGradePopup.show(this.taskId,this.layout.mark,{listValue:this.mark},{events:{onPopupChange:BX.proxy(this.onMarkChange,this)}})};BX.Tasks.Component.TaskViewSidebar.prototype.onMarkChange=function(){var t=BX.proxy_context;this.layout.mark.className="task-detail-sidebar-item-mark-"+t.listValue.toLowerCase();this.layout.mark.innerHTML=t.listItem.name;var e=new BX.Tasks.Util.Query;e.add("task.update",{id:this.taskId,data:{MARK:t.listValue==="NULL"?"":t.listValue}});var s=this.taskId;e.execute().then(function(){BX.Tasks.Util.fireGlobalTaskEvent("UPDATE",{ID:s},{STAY_AT_PAGE:true},{id:s})})};BX.Tasks.Component.TaskViewSidebar.prototype.initTime=function(){if(!this.allowTimeTracking){return}BX.Tasks.Util.Dispatcher.bindEvent("buttons-dayplan","task-timer-tick",BX.delegate(this.onTaskTimerTick,this))};BX.Tasks.Component.TaskViewSidebar.prototype.onTaskTimerTick=function(t,e){if(t!=this.taskId){return}var s=BX("task-detail-spent-time-"+this.taskId);if(s){s.innerHTML=BX.Tasks.Util.formatTimeAmount(e)}};BX.Tasks.Component.TaskViewSidebar.prototype.initTags=function(){BX.addCustomEvent("onTaskTagSelect",BX.proxy(this.saveTags,this))};BX.Tasks.Component.TaskViewSidebar.prototype.saveTags=function(t){var e="";for(var s=0,i=t.length;s<i;s++){if(s>0){e+=", "}e+=t[s].name}var a=new BX.Tasks.Util.Query;a.add("task.update",{id:this.taskId,data:{TAGS:e}});a.execute()}}).call(this);
//# sourceMappingURL=logic.map.js