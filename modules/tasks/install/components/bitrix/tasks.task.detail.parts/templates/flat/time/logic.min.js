BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TaskElapsedTime!="undefined"){return}BX.Tasks.Component.TaskElapsedTime=function(e,t){this.container=BX(e);if(!this.container){return}this.parameters=t||{};this.messages=this.parameters.messages||{};this.template=this.parameters.template||"";this.nameTemplate=this.parameters.nameTemplate||"";this.pathToUserProfile=this.parameters.pathToUserProfile||"";this.ajaxPendingResponse=false;this.records={};var s=BX.type.isArray(this.parameters.records)?this.parameters.records:[];for(var a=0;a<s.length;a++){var i=s[a];var r=BX(i.rowId);this.addRecord(i.id,r,i.date,i.time,i.comment)}this.layout={addLinkRow:BX.findChildByClassName(this.container,"task-time-add-link-row",true),addLink:BX.findChildByClassName(this.container,"task-dashed-link",true),sendButton:BX.findChildByClassName(this.container,"task-table-edit-ok",true),cancelButton:BX.findChildByClassName(this.container,"task-table-edit-remove",true),formRow:BX.findChildByClassName(this.container,"task-time-form-row",true),lastRow:null};this.form={};var o=this.layout.formRow.getElementsByTagName("input");for(a=0;a<o.length;a++){var n=o[a];var d=n.getAttribute("name");this.form[d]=n;BX.bind(n,"keypress",BX.proxy(this.catchEnterKey,this))}this.query=new BX.Tasks.Util.Query({url:"/bitrix/components/bitrix/tasks.task.list/ajax.php"});this.query.bindEvent("executed",BX.proxy(this.onQueryExecuted,this));BX.bind(this.layout.addLink,"click",BX.proxy(this.add,this));BX.bind(this.layout.sendButton,"click",BX.proxy(this.send,this));BX.bind(this.layout.cancelButton,"click",BX.proxy(this.cancel,this));BX.bind(this.form.date,"click",function(){BX.calendar({node:this,field:this,form:"",bTime:true,value:this.value,bHideTime:false})});BX.bind(this.container,"click",BX.proxy(this.captureClick,this))};BX.Tasks.Component.TaskElapsedTime.prototype.add=function(){this.moveForm(this.layout.addLinkRow);this.setForm("","","1","00","00","")};BX.Tasks.Component.TaskElapsedTime.prototype.edit=function(e){var t=this.getRecordById(e);if(t){this.moveForm(t.row);this.setForm(t.id,t.date,t.hours,t.minutes,t.seconds,t.comment)}};BX.Tasks.Component.TaskElapsedTime.prototype.getRecordById=function(e){if(this.records[e]){return this.records[e]}return null};BX.Tasks.Component.TaskElapsedTime.prototype.getRecordByRow=function(e){for(var t in this.records){if(this.records.hasOwnProperty(t)&&this.records[t].row===e){return this.records[t]}}return null};BX.Tasks.Component.TaskElapsedTime.prototype.addRecord=function(e,t,s,a,i){if(!e||!BX.type.isDomNode(t)){return}a=parseInt(a,10);a=BX.type.isNumber(a)?a:0;var r=this.getTime(a);this.records[e]={row:t,id:e,date:s,hours:r.hours,minutes:r.minutes,seconds:r.seconds,time:a,comment:i}};BX.Tasks.Component.TaskElapsedTime.prototype.deleteRecord=function(e){delete this.records[e]};BX.Tasks.Component.TaskElapsedTime.prototype.delete=function(e){if(this.ajaxPendingResponse){return}this.query.deleteAll();this.query.add("task.elapsedtime.delete",{id:e},{code:"task.elapsedtime.delete"});this.query.execute();this.ajaxPendingResponse=true};BX.Tasks.Component.TaskElapsedTime.prototype.send=function(){if(this.ajaxPendingResponse){return}var e=parseInt(this.form.id.value,10);var t=parseInt(this.form.hours.value,10);var s=parseInt(this.form.minutes.value,10);var a=parseInt(this.form.seconds.value,10);t=BX.type.isNumber(t)?t:0;s=BX.type.isNumber(s)?s:0;var i={COMMENT_TEXT:BX.util.trim(this.form.comment.value),CREATED_DATE:this.form.date.value,SECONDS:t*3600+s*60+a};this.enable(false);this.query.deleteAll();if(e>0){this.query.add("task.elapsedtime.update",{id:e,data:i,parameters:{RETURN_ENTITY:true}},{code:"task.elapsedtime.update"})}else{i.TASK_ID=this.parameters.taskId;this.query.add("task.elapsedtime.add",{data:i,parameters:{RETURN_ENTITY:true}},{code:"task.elapsedtime.add"})}this.query.execute();this.ajaxPendingResponse=true};BX.Tasks.Component.TaskElapsedTime.prototype.onQueryExecuted=function(e){this.ajaxPendingResponse=false;if(!e.success||!e.data){return false}for(var t in e.data){if(!e.data.hasOwnProperty(t)){continue}if(!e.data[t].SUCCESS){return false}if(t==="task.elapsedtime.add"||t==="task.elapsedtime.update"){this.cancel();this.enable();var s=e.data[t]["RESULT"]["DATA"];var a=e.data[t]["RESULT"]["CAN"];var i="";if(a["MODIFY"]){i+=" task-time-table-edit"}if(a["REMOVE"]){i+=" task-time-table-remove"}var r=s["SOURCE"];var o="";if(r==2){o=this.messages.sourceManual;i+=" task-time-table-manually"}else if(r==1){o=this.messages.sourceUndefined;i+=" task-time-table-unknown"}var n=BX.formatName({NAME:s["USER_NAME"],LAST_NAME:s["USER_LAST_NAME"],SECOND_NAME:s["USER_SECOND_NAME"],LOGIN:s["USER_LOGIN"]},this.nameTemplate,"Y");var d=s["ID"];var l=BX.formatDate(BX.parseDate(s["CREATED_DATE"]),BX.message("FORMAT_DATETIME"));var m=s["COMMENT_TEXT"];var p=s["SECONDS"];p=this.getTime(p);var h=this.pathToUserProfile.replace("#user_id#",s["USER_ID"]);var u=BX.Tasks.Util.Template.compile(this.template);var f=u.getNode({rowId:"",rowClass:i,sourceNote:o,userName:n,date:l,timeFormatted:BX.Tasks.Util.formatTimeAmount(p.time),comment:m,pathToUserProfile:h});var c=this.getRecordById(d);var T=this.layout.addLinkRow;if(c){T=BX.findNextSibling(c.row);BX.remove(c.row)}this.addRecord(d,f[0],l,p.time,m);T.parentNode.insertBefore(f[0],T)}else if(t==="task.elapsedtime.delete"){var y=e.data[t]["ARGUMENTS"]||{};var k=this.getRecordById(y.id);if(k){k.row.parentNode.removeChild(k.row);this.deleteRecord(k.id)}}}var B=this.getSummary();BX.onCustomEvent("TaskElapsedTimeUpdated",[B.hours,B.minutes,this.records,B])};BX.Tasks.Component.TaskElapsedTime.prototype.getTime=function(e){var t=e>=0?1:-1;var s=Math.floor(t*Math.floor(Math.abs(e)/3600));var a=t*Math.floor(Math.abs(e)/60)%60;return{hours:s,minutes:a,seconds:e-s*3600-a*60,time:e}};BX.Tasks.Component.TaskElapsedTime.prototype.getSummary=function(){var e=0;for(var t in this.records){if(this.records.hasOwnProperty(t)){e+=this.records[t].time}}return this.getTime(e)};BX.Tasks.Component.TaskElapsedTime.prototype.showError=function(){var e=new BX.PopupWindow("task-elapsed-time-error-popup",null,{lightShadow:true,overlay:true,buttons:[new BX.PopupWindowButton({text:BX.message("JS_CORE_WINDOW_CLOSE"),className:"",events:{click:function(){BX.reload();this.popupWindow.close()}}})]});var t=[];for(var s=0;s<arguments.length;s++){var a=arguments[s];if(BX.type.isArray(a)){t=BX.util.array_merge(t,a)}else if(BX.type.isString(a)){t.push(a)}}var i="";for(s=0;s<t.length;s++){i+=(typeof t[s].MESSAGE!=="undefined"?t[s].MESSAGE:t[s])+"<br>"}e.setContent("<div class='task-detail-error-popup' style='width: 300px; margin: 15px; color: red; word-wrap: break-word;'>"+i+"</div>");e.show()};BX.Tasks.Component.TaskElapsedTime.prototype.cancel=function(){if(this.layout.lastRow){this.layout.lastRow.style.display=""}this.layout.formRow.style.display="none";this.layout.addLinkRow.style.display=""};BX.Tasks.Component.TaskElapsedTime.prototype.setForm=function(e,t,s,a,i,r){this.form.id.value=e;this.form.date.value=t;this.form.hours.value=s;this.form.minutes.value=a;this.form.seconds.value=i;this.form.comment.value=r;this.layout.formRow.style.display="";this.form.hours.focus();this.form.hours.select()};BX.Tasks.Component.TaskElapsedTime.prototype.moveForm=function(e){var t=BX.findNextSibling(e,{tag:"tr"});if(t){e.parentNode.insertBefore(this.layout.formRow,t)}else{e.parentNode.appendChild(this.layout.formRow)}if(this.layout.lastRow){this.layout.lastRow.style.display=""}this.layout.lastRow=e;this.layout.lastRow.style.display="none"};BX.Tasks.Component.TaskElapsedTime.prototype.captureClick=function(e){e=e||window.event;var t=e.target||e.srcElement;if(!BX.type.isDomNode(t)){return}if(BX.hasClass(t,"task-table-edit")||BX.hasClass(t,"task-table-remove")){var s=BX.findParent(t,{tagName:"tr"});var a=this.getRecordByRow(s);a=a||{};if(BX.hasClass(t,"task-table-edit")){this.edit(a.id)}else if(BX.hasClass(t,"task-table-remove")){this.delete(a.id)}BX.PreventDefault(e)}};BX.Tasks.Component.TaskElapsedTime.prototype.catchEnterKey=function(e){e=e||window.event;if(e.keyCode===13){this.send();BX.PreventDefault(e)}};BX.Tasks.Component.TaskElapsedTime.prototype.enable=function(e){var t=e===false;for(var s in this.form){if(this.form.hasOwnProperty(s)){this.form[s].disabled=t}}}}).call(this);
//# sourceMappingURL=logic.map.js