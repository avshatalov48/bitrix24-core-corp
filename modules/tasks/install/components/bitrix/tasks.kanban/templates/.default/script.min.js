BX.namespace("Tasks.KanbanComponent");BX.Tasks.KanbanComponent.enableCustomSort=function(t,e){if(BX.Tasks.KanbanComponent.openedCustomSort){return}BX.Tasks.KanbanComponent.sortMenuItem=e;e.params.forEach((function(t){t.params=BX.parseJSON(t.params);t.onclick=BX.Tasks.KanbanComponent.ClickSort;e.menuWindow.addMenuItem(t)}));var n=null;e.menuWindow.menuItems.forEach((function(t){BX.removeClass(BX(t.layout.item),"menu-popup-item-accept");if(t.params&&typeof t.params.order!=="undefined"&&t.params.order==="desc"){n=t}}));BX.addClass(BX(e.layout.item),"menu-popup-item-accept");if(!n){return}BX.addClass(BX(n.layout.item),"menu-popup-item-accept");BX.ajax({method:"POST",dataType:"json",url:ajaxHandlerPath,data:{action:"setNewTaskOrder",order:n.params.order,sessid:BX.bitrix_sessid(),params:ajaxParams},onsuccess:function(t){BX.onCustomEvent(this,"onTaskSortChanged",[t])}});BX.Tasks.KanbanComponent.openedCustomSort=true};BX.Tasks.KanbanComponent.getMySortButton=function(t,e){if(typeof BX.Tasks.KanbanComponent.sortMenuItem!=="undefined"){return BX.Tasks.KanbanComponent.sortMenuItem}e.menuWindow.menuItems.forEach((function(t){if(Array.isArray(t.params)){BX.Tasks.KanbanComponent.sortMenuItem=t}}));return BX.Tasks.KanbanComponent.sortMenuItem};BX.Tasks.KanbanComponent.disableCustomSort=function(t,e){if(!BX.Tasks.KanbanComponent.openedCustomSort){return}var n=e.menuWindow.menuItems.slice(0);n.forEach((function(t){if(t.params&&typeof t.params.type!=="undefined"&&t.params.type==="sub"){e.menuWindow.removeMenuItem(t.id)}}));BX.Tasks.KanbanComponent.openedCustomSort=false};BX.Tasks.KanbanComponent.ClickSort=function(t,e){var n="desc";if(typeof e.params!=="undefined"&&typeof e.params.order!=="undefined"){n=e.params.order}if(BX.Tasks.KanbanComponent.openedCustomSort&&n==="actual"){BX.Tasks.KanbanComponent.disableCustomSort(t,e)}if(!BX.hasClass(BX(e.layout.item),"menu-popup-item-accept")){var a=e.menuWindow.menuItems;for(var i=0,o=a.length;i<o;i++){BX.removeClass(BX(a[i].layout.item),"menu-popup-item-accept")}BX.addClass(BX(e.layout.item),"menu-popup-item-accept");if(n==="asc"||n==="desc"){var s=BX.Tasks.KanbanComponent.getMySortButton(t,e);s&&BX.addClass(BX(s.layout.item),"menu-popup-item-accept")}BX.ajax({method:"POST",dataType:"json",url:ajaxHandlerPath,data:{action:"setNewTaskOrder",order:n,sessid:BX.bitrix_sessid(),params:ajaxParams},onsuccess:function(t){BX.onCustomEvent(this,"onTaskSortChanged",[t])}})}};BX.Tasks.KanbanComponent.filterId={};BX.Tasks.KanbanComponent.defaultPresetId={};BX.Tasks.KanbanComponent.onReady=function(){BX.bind(BX("tasks-popupMenuOptions"),"click",BX.delegate((function(){if(BX.data(BX("tasks-popupMenuOptions"),"disabled")===true){var t=new BX.PopupWindow("popupMenuOptionsDisabled",BX("tasks-popupMenuOptions"),{closeByEsc:true,angle:true,offsetLeft:5,darkMode:true,autoHide:true,zIndex:1e3,content:BX.message("TASKS_KANBAN_DIABLE_SORT_TOOLTIP")});t.show()}})));BX.addCustomEvent("Tasks.TopMenu:onItem",(function(t,e){var n=BX.Main.filterManager.getById(BX.Tasks.KanbanComponent.filterId);if(!n){alert("BX.Main.filterManager not initialised");return}var a={preset_id:BX.Tasks.KanbanComponent.defaultPresetId,additional:{ROLEID:t==="view_all"?0:t}};var i=n.getApi();i.setFilter(a,{ROLE_TYPE:"TASKS_ROLE_TYPE_"+(t===""?"view_all":t)});window.history.pushState(null,null,e)}));BX.addCustomEvent("Tasks.Toolbar:onItem",(function(t){var e=t.getData();if(e.counter&&e.counter.filter){e.counter.filter.toggleByField({PROBLEM:e.counter.filterValue})}}))};BX.addCustomEvent("SidePanel.Slider:onCloseByEsc",(function(t){var e=/tasks\/task\/edit/;var n=t.getSlider().getUrl();if(e.test(n)&&!confirm(BX.message("TASKS_CLOSE_PAGE_CONFIRM"))){t.denyAction()}}));BX.Tasks.KanbanComponent.TourGuideController=function(t){this.tours=t.tours;this.guide=null;this.initGuides(t)};BX.Tasks.KanbanComponent.TourGuideController.prototype={initGuides:function(t){var e=this.tours.firstTimelineTaskCreation;var n=this.tours.expiredTasksDeadlineChange;if(t.viewMode==="timeline"&&e.show){this.guide=new BX.Tasks.KanbanComponent.TourGuideController.FirstTimelineTaskCreationTourGuide(t)}else if(n.show||n.backgroundCheck){this.guide=new BX.Tasks.KanbanComponent.TourGuideController.ExpiredTasksDeadlineChangeTourGuide(t)}},getGuide:function(){return this.guide}};BX.Tasks.KanbanComponent.TourGuideController.FirstTimelineTaskCreationTourGuide=function(t){this.viewMode=t.viewMode;this.tour=t.tours.firstTimelineTaskCreation;this.popupData=this.tour.popupData;this.ajaxActionPrefix="tasks.tourguide.firsttimelinetaskcreation.";this.start()};BX.Tasks.KanbanComponent.TourGuideController.FirstTimelineTaskCreationTourGuide.prototype={start:function(){var t;var e;var n=null;function a(t){n=t}BX.addCustomEvent(Kanban,"Kanban.Grid:addItem",a);var i=function t(e){var n=this.guide.getPopup();var a=e;var i=a.offsetWidth;n.setMinWidth(i);n.setMaxWidth(i);n.setAngle({offset:i/2-11});this.guide.getPopup().getPopupContainer().style.left=BX.pos(a).left+"px"}.bind(this);this.guide=new BX.UI.Tour.Guide({steps:[{target:document.querySelectorAll(".main-kanban-column-add-item-button")[0],title:this.popupData[0].title,text:this.popupData[0].text,article:this.popupData[0].article,events:{onShow:function(){Kanban.getGridContainer().classList.add("main-kanban-aha");this.guide.getCurrentStep().getTarget().classList.add("--pulse");this.guide.getCurrentStep().getTarget().classList.add("--hover");i(this.guide.getCurrentStep().getTarget());t=function(){if(n){e=n.getContainer();this.guide.getCurrentStep().setTarget(e);this.showNextStep()}BX.removeCustomEvent(Kanban,"Kanban.Grid:removeDraftItemByEsc",t);BX.removeCustomEvent(Kanban,"Kanban.Grid:closeDraftItem",t)}.bind(this);BX.addCustomEvent(Kanban,"Kanban.Grid:removeDraftItemByEsc",t);BX.addCustomEvent(Kanban,"Kanban.Grid:closeDraftItem",t)}.bind(this),onClose:function(){Kanban.getGridContainer().classList.remove("main-kanban-aha");this.guide.getCurrentStep().getTarget().classList.remove("--pulse");this.guide.getCurrentStep().getTarget().classList.remove("--hover")}.bind(this)}},{target:null,title:this.popupData[1].title,text:this.popupData[1].text,events:{onShow:function(){i(this.guide.getCurrentStep().getTarget());n.animateAha();n.getColumn().getContainer().classList.add("main-kanban-column-aha");var t=Kanban.getColumns();BX.addCustomEvent(Kanban,"Kanban.Grid:onItemDragStart",function(){n.getColumn().getContainer().classList.remove("main-kanban-column-aha");n.unsetAnimateAha();Kanban.offAhaMode();this.guide.close();for(var e=0;e<t.length;e++){if(n.getColumn()!==t[e]&&t[e].getType()!=="PERIOD1"){t[e].onAhaMode();t[e].getContainer().classList.add("main-kanban-column-aha")}}}.bind(this));BX.addCustomEvent(Kanban,"Kanban.Grid:onItemDragStop",function(e){for(var a=0;a<t.length;a++){if(n.getColumn()!==t[a]&&t[a].getType()!=="PERIOD1"){t[a].offAhaMode();t[a].getContainer().classList.remove("main-kanban-column-aha")}}var i=e.getColumn();setTimeout(function(){if(i!==e.getColumn()){BX.ajax.runAction(this.ajaxActionPrefix+"finish")}}.bind(this))}.bind(this))}.bind(this),onClose:function(){Kanban.offAhaMode();if(!n){return}n.unsetAnimateAha();n.getColumn().getContainer().classList.remove("main-kanban-column-aha")}}}],onEvents:true});this.showNextStep()},markShowedStep:function(t){BX.ajax.runAction(this.ajaxActionPrefix+"markShowedStep",{analyticsLabel:{viewMode:this.viewMode,step:t}})},showNextStep:function(){setTimeout(function(){this.guide.showNextStep();this.markShowedStep(this.getCurrentStepIndex())}.bind(this),500)},getCurrentStepIndex:function(){return this.guide.currentStepIndex}};BX.Tasks.KanbanComponent.TourGuideController.ExpiredTasksDeadlineChangeTourGuide=function(t){this.userId=t.userId;this.viewMode=t.viewMode;this.tour=t.tours.expiredTasksDeadlineChange;this.popupData=this.tour.popupData;this.counterToCheck=this.tour.counterToCheck;this.itemId=0;this.calendarPopup=0;this.isStopped=false;this.ajaxActionPrefix="tasks.tourguide.expiredtasksdeadlinechange.";if(this.tour.show){this.start()}else if(this.tour.backgroundCheck){this.isPullListening=true}this.bindEvents()};BX.Tasks.KanbanComponent.TourGuideController.ExpiredTasksDeadlineChangeTourGuide.prototype={bindEvents:function(){var t={user_counter:this.onUserCounter.bind(this)};BX.addCustomEvent("onPullEvent-tasks",function(e,n){if(t[e]){t[e].apply(this,[n])}}.bind(this));BX.addCustomEvent("UI.Tour.Guide:onPopupClose",function(){this.stop()}.bind(this));BX.addCustomEvent("UI.Tour.Guide:onFinish",function(t){if(t.getData().guide===this.guide&&this.getCurrentStepIndex()===0){BX.addCustomEvent(Kanban,"Kanban.Grid:onRender",BX.proxy(this.onExpiredCounterKanbanReloaded,this))}}.bind(this))},onUserCounter:function(t){if(!this.isPullListening||this.userId!==Number(t.userId)){return}var e=Number(t[0].view_role_originator.expired)+Number(t[0].view_role_responsible.expired);if(e>=Number(this.counterToCheck)){this.isPullListening=false;BX.ajax.runAction(this.ajaxActionPrefix+"proceed",{analyticsLabel:{viewMode:this.viewMode}}).then(function(t){if(t.data){this.start()}}.bind(this))}},start:function(){this.guide=new BX.UI.Tour.Guide({steps:[{target:document.querySelector(".tasks-counters--item-counter"),title:this.popupData[0].title,text:this.popupData[0].text}],onEvents:true});this.showNextStep()},markShowedStep:function(t){BX.ajax.runAction(this.ajaxActionPrefix+"markShowedStep",{analyticsLabel:{viewMode:this.viewMode,step:t}})},onExpiredCounterKanbanReloaded:function(){BX.removeCustomEvent(Kanban,"Kanban.Grid:onRender",BX.proxy(this.onExpiredCounterKanbanReloaded,this));var t=".tasks-kanban-item-deadline.tasks-kanban-item-pointer";var e=Kanban.getRenderToContainer().querySelector(t);if(!this.itemId&&e){this.itemId=Number(BX.data(e.closest(".main-kanban-item"),"id"))}if(this.itemId>0&&e){this.guide.steps.push(new BX.UI.Tour.Step({target:e,title:this.popupData[1].title,text:this.popupData[1].text}));this.showNextStep();BX.addCustomEvent(Kanban,"Tasks.Kanban.Item:deadlineChangeClick",BX.proxy(this.onDeadlineChangeClick,this))}},onDeadlineChangeClick:function(t){var e=t.getData();if(this.isCorrectItem(e.itemId)&&!this.getIsStopped()){this.setCalendarPopup(e.calendar.popup)}},setCalendarPopup:function(t){if(!this.calendarPopup&&this.getCurrentStepIndex()===1){this.calendarPopup=t;BX.addCustomEvent(this.calendarPopup,"onPopupAfterClose",BX.proxy(this.onCalendarPopupClose,this))}},onCalendarPopupClose:function(){BX.removeCustomEvent(this.calendarPopup,"onPopupAfterClose",BX.proxy(this.onCalendarPopupClose,this));setTimeout(function(){BX.removeCustomEvent(Kanban,"Tasks.Kanban.Item:deadlineChanged",BX.proxy(this.onDeadlineChanged,this))}.bind(this),500);BX.addCustomEvent(Kanban,"Tasks.Kanban.Item:deadlineChanged",BX.proxy(this.onDeadlineChanged,this))},onDeadlineChanged:function(t){var e=t.getData();var n=new Date;if(e.value.getTime()>n.getTime()){BX.addCustomEvent(Kanban,"Kanban.Grid:onItemRemoved",BX.proxy(this.onItemRemoved,this))}},onItemRemoved:function(t){var e=t.getData();var n=e.itemId;if(!this.isCorrectItem(n)){return}BX.removeCustomEvent(Kanban,"Kanban.Grid:onItemRemoved",BX.proxy(this.onItemRemoved,this));if(Kanban.getItem(n)===null){this.guide.steps.push(new BX.UI.Tour.Step({title:this.popupData[2].title,text:this.popupData[2].text,buttons:[{text:this.popupData[2].buttons[0],event:function(){this.stop()}.bind(this)}]}));this.showNextStep()}},showNextStep:function(){if(this.isStopped){return}setTimeout(function(){this.guide.showNextStep();this.markShowedStep(this.getCurrentStepIndex())}.bind(this),500)},getCurrentStepIndex:function(){return this.guide.currentStepIndex},isCorrectItem:function(t){return Number(this.itemId)===Number(t)},getIsStopped:function(){return this.isStopped},stop:function(){this.isStopped=true;this.guide.close()}};
//# sourceMappingURL=script.map.js