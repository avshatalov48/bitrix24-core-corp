this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(a,e,n,t){"use strict";var s=function(a){babelHelpers.inherits(e,a);function e(){var a;babelHelpers.classCallCheck(this,e);a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));a.setEventNamespace("BX.Tasks.Scrum.KanbanManager.PullItem");return a}babelHelpers.createClass(e,[{key:"getModuleId",value:function a(){return"tasks"}},{key:"getMap",value:function a(){return{itemUpdated:this.onItemUpdated.bind(this)}}},{key:"onItemUpdated",value:function a(e){this.emit("itemUpdated",e)}}]);return e}(t.EventEmitter);var r=function(){function a(e){babelHelpers.classCallCheck(this,a);this.filterId=e.filterId;this.defaultPresetId=e.defaultPresetId;this.ajaxComponentPath=e.ajaxComponentPath;this.ajaxComponentParams=e.ajaxComponentParams}babelHelpers.createClass(a,[{key:"onClickSort",value:function a(e,n){if(!Dom.hasClass(e,"menu-popup-item-accept")){this.refreshIcons(e);this.saveSelection(n)}}},{key:"refreshIcons",value:function a(e){e.parentElement.childNodes.forEach((function(a){Dom.removeClass(a,"menu-popup-item-accept")}));Dom.addClass(e,"menu-popup-item-accept")}},{key:"saveSelection",value:function a(e){var n=this;BX.ajax.runComponentAction("bitrix:tasks.kanban","setNewTaskOrder",{mode:"class",data:{order:e?e:"desc",params:this.ajaxComponentParams}}).then((function(a){var e=a.data;BX.onCustomEvent(n,"onTaskSortChanged",[e])}))}}]);return a}();var i,o;var u=function(){function a(e){var i=this;babelHelpers.classCallCheck(this,a);this.groupId=parseInt(e.groupId,10);this.filterId=e.filterId;this.siteTemplateId=e.siteTemplateId;this.ajaxComponentPath=e.ajaxComponentPath;this.ajaxComponentParams=e.ajaxComponentParams;this.sprintSelected=e.sprintSelected;this.isActiveSprint=e.isActiveSprint;this.kanbanHeader=null;this.kanban=null;this.kanbanGroupedByParentTasks=new Map;this.parentTasks=e.parentTasks;this.kanbanComponent=new r({filterId:e.filterId,defaultPresetId:e.defaultPresetId,ajaxComponentPath:e.ajaxComponentPath,ajaxComponentParams:e.ajaxComponentParams});this.pullItem=new s({groupId:this.groupId});this.pullItem.subscribe("itemUpdated",this.onItemUpdated.bind(this));t.EventEmitter.subscribe("BX.Main.Filter:apply",(function(a){var e=a.getCompatData(),n=babelHelpers.slicedToArray(e,5),t=n[0],s=n[1],r=n[2],o=n[3],u=n[4];i.onApplyFilter(t,s,r,o,u)}));t.EventEmitter.subscribe("onTasksGroupSelectorChange",this.onChangeSprint.bind(this));n.PULL.subscribe(this.pullItem)}babelHelpers.createClass(a,[{key:"drawKanban",value:function a(e,n){var s=this;if(!this.sprintSelected){this.showNotSprintMessage(e);return}this.inputRenderTo=e;this.inputKanbanParams=n;this.drawKanbanHeader(e,n);this.drawKanbanWithoutGrouping(e,n);this.drawKanbanInGroupingMode(e,n);this.fillNeighborKanbans();this.updateHeaderColumns();this.adjustGroupHeadersWidth();t.EventEmitter.subscribe(this.kanbanHeader,"Kanban.Grid:onColumnAddedAsync",(function(){s.adjustGroupHeadersWidth()}));t.EventEmitter.subscribe(this.kanbanHeader,"Kanban.Grid:onColumnRemovedAsync",(function(){setTimeout((function(){s.adjustGroupHeadersWidth()}),200)}))}},{key:"getKanbanHeader",value:function a(){return this.kanbanHeader}},{key:"getKanban",value:function a(){return this.kanban}},{key:"getKanbansGroupedByParentTasks",value:function a(){return this.kanbanGroupedByParentTasks}},{key:"drawKanbanInGroupingMode",value:function a(n,t){var s=this;e.Dom.addClass(n,"tasks-scrum-kanban");if(this.isParentTaskGrouping()){var r=function a(){if(s.parentTasks[i]["isVisibilitySubtasks"]==="N"){delete s.parentTasks[i];if(!s.kanban.getItem(i)){s.kanban.refreshTask(i)}return"continue"}var r=s.createParentTaskKanbanNode(s.parentTasks[i]);var o=s.parentTasks[i]["completed"]==="Y";if(o){s.setTextDecorationToParentTaskName(r)}e.Dom.append(r,n);var u=r.querySelector(".tasks-scrum-kanban-group-header-tick");e.Event.bind(u,"click",(function(){s.toggleGroupingVisibility(r)}));var d=r.querySelector(".tasks-scrum-kanban-container");s.drawKanbanGroupedByParentTasks(s.parentTasks[i],d,t)};for(var i in this.parentTasks){var o=r();if(o==="continue")continue}}}},{key:"drawKanbanHeader",value:function a(n,t){var s=e.Runtime.clone(t);s.kanbanHeader=true;s.items=[];this.kanbanHeader=new BX.Tasks.Kanban.Grid(this.getKanbanParams(n,s));this.kanbanHeader.draw()}},{key:"drawKanbanWithoutGrouping",value:function a(e,n){var s=this;this.kanban=new BX.Tasks.Kanban.Grid(this.getKanbanParams(e,n));t.EventEmitter.subscribe(this.kanban,"Kanban.Grid:onAddParentTask",(function(a){var e=a.getData();s.createParentTaskKanban(e);s.fillNeighborKanbans();s.adjustGroupHeadersWidth();s.kanban.addItemsFromQueue()}));this.kanban.draw()}},{key:"drawKanbanGroupedByParentTasks",value:function a(n,s,r){var i=this;var o=parseInt(n.id,10);var u=e.Runtime.clone(r);u.columns=n.columns;u.items=n.items;u.parentTaskId=o;u.parentTaskName=n.name;u.parentTaskCompleted=n.completed==="Y";var d=new BX.Tasks.Kanban.Grid(this.getKanbanParams(s,u));d.draw();if(u.parentTaskCompleted&&!d.hasItemInProgress()){var l=d.getRenderToContainer().closest(".tasks-scrum-parent-task-kanban");this.downGroupingVisibility(l)}t.EventEmitter.subscribe(d,"Kanban.Grid:onCompleteParentTask",(function(){i.onCompleteParentTask(d)}));t.EventEmitter.subscribe(d,"Kanban.Grid:onRenewParentTask",(function(){i.onRenewParentTask(d)}));t.EventEmitter.subscribe(d,"Kanban.Grid:onProceedParentTask",(function(){i.onProceedParentTask(d)}));t.EventEmitter.subscribe(d,"Kanban.Grid:onAddItemInProgress",(function(a){var e=d.getRenderToContainer().closest(".tasks-scrum-parent-task-kanban");i.upGroupingVisibility(e)}));this.kanbanGroupedByParentTasks.set(o,d)}},{key:"fillNeighborKanbans",value:function a(){var e=this;this.addNeighborKanban(this.kanbanHeader);this.addNeighborKanban(this.kanban);this.kanbanGroupedByParentTasks.forEach((function(a){e.addNeighborKanban(a)}))}},{key:"cleanNeighborKanbans",value:function a(){var e=this;this.kanbanHeader.cleanNeighborGrids();this.kanban.cleanNeighborGrids();this.kanbanGroupedByParentTasks.forEach((function(a){e.removeParentTaskKanban(a);a.cleanNeighborGrids()}));this.kanbanGroupedByParentTasks.clear()}},{key:"updateHeaderColumns",value:function a(){this.kanbanHeader.updateTotals()}},{key:"addNeighborKanban",value:function a(e){this.kanbanHeader.addNeighborGrid(e);this.kanban.addNeighborGrid(e);this.kanbanGroupedByParentTasks.forEach((function(a){a.addNeighborGrid(e)}))}},{key:"getKanbanParams",value:function a(n,t){return{isGroupingMode:true,gridHeader:t.kanbanHeader,parentTaskId:t.parentTaskId?t.parentTaskId:0,parentTaskName:t.parentTaskName?t.parentTaskName:"",parentTaskCompleted:t.parentTaskCompleted?t.parentTaskCompleted:false,renderTo:n,itemType:"BX.Tasks.Kanban.Item",columnType:"BX.Tasks.Kanban.Column",canAddColumn:this.isActiveSprint,canEditColumn:this.isActiveSprint,canRemoveColumn:this.isActiveSprint,canSortColumn:this.isActiveSprint,canAddItem:!t.addItemInSlider&&this.isActiveSprint,canSortItem:this.isActiveSprint,bgColor:this.siteTemplateId,columns:t.columns,items:t.items,addItemTitleText:e.Loc.getMessage("KANBAN_QUICK_TASK"),addDraftItemInfo:e.Loc.getMessage("KANBAN_QUICK_TASK_ITEM_INFO"),data:{kanbanType:"K",ajaxHandlerPath:this.ajaxComponentPath,pathToTask:t.pathToTask,pathToTaskCreate:t.pathToTaskCreate,pathToUser:t.pathToUser,addItemInSlider:t.addItemInSlider,params:this.ajaxComponentParams,gridId:this.filterId,newTaskOrder:t.newTaskOrder,setClientDate:t.setClientDate,clientDate:BX.date.format(BX.date.convertBitrixFormat(e.Loc.getMessage("FORMAT_DATE"))),clientTime:BX.date.format(BX.date.convertBitrixFormat(e.Loc.getMessage("FORMAT_DATETIME"))),rights:{canAddColumn:this.isActiveSprint,canEditColumn:this.isActiveSprint,canRemoveColumn:this.isActiveSprint,canSortColumn:this.isActiveSprint,canAddItem:this.isActiveSprint,canSortItem:this.isActiveSprint},admins:t.admins},messages:{ITEM_TITLE_PLACEHOLDER:e.Loc.getMessage("KANBAN_ITEM_TITLE_PLACEHOLDER"),COLUMN_TITLE_PLACEHOLDER:e.Loc.getMessage("KANBAN_COLUMN_TITLE_PLACEHOLDER")},ownerId:t.ownerId,groupId:t.groupId,isSprintView:"Y"}}},{key:"onClickSort",value:function a(e,n){this.kanbanComponent.onClickSort(e,n)}},{key:"onApplyFilter",value:function a(e,n,t,s,r){var i=this;this.fadeOutKanbans();this.kanban.ajax("applyFilter",{}).then((function(a){var e=a.data;if(i.kanban.differentColumnCount(e)){i.kanbanHeader.getColumns().forEach((function(a){return i.kanbanHeader.removeColumn(a)}));i.kanban.getColumns().forEach((function(a){return i.kanban.removeColumn(a)}));i.refreshKanban(i.kanbanHeader,e)}i.refreshKanban(i.kanban,e);i.cleanNeighborKanbans();if(i.existsTasksGroupedBySubTasks(e)){Object.entries(e.parentTasks).forEach((function(a){var e=babelHelpers.slicedToArray(a,2),n=e[1];i.createParentTaskKanban(n)}))}i.fillNeighborKanbans();i.adjustGroupHeadersWidth();i.fadeInKanbans()}),(function(a){i.fadeInKanbans()}))}},{key:"onChangeSprint",value:function a(e){var n=this;var t=e.getCompatData(),s=babelHelpers.slicedToArray(t,1),r=s[0];var i=this.kanban.getData();i.params.SPRINT_ID=r.sprintId;this.kanban.setData(i);this.kanban.ajax("changeSprint",{}).then((function(a){var e=a.data;n.cleanNeighborKanbans();n.kanbanHeader.getColumns().forEach((function(a){return n.kanbanHeader.removeColumn(a)}));n.kanban.getColumns().forEach((function(a){return n.kanban.removeColumn(a)}));n.refreshKanban(n.kanbanHeader,e);n.refreshKanban(n.kanban,e);if(n.existsTasksGroupedBySubTasks(e)){Object.entries(e.parentTasks).forEach((function(a){var e=babelHelpers.slicedToArray(a,2),t=e[1];n.createParentTaskKanban(t)}))}n.fillNeighborKanbans();n.adjustGroupHeadersWidth()}),(function(a){}))}},{key:"onItemUpdated",value:function a(e){var n=e.getData();if(this.groupId!==n.groupId){return}var t=n.sourceId;if(this.kanban.hasItem(t)){this.kanban.refreshTask(t)}else{this.kanbanGroupedByParentTasks.forEach((function(a){if(a.hasItem(t)){a.refreshTask(t)}}))}}},{key:"refreshKanban",value:function a(e,n){e.resetPaginationPage();e.removeItems();e.loadData(n)}},{key:"refreshParentTasksKanbans",value:function a(e){var n=this;var t=[];var s=[];Object.entries(e.parentTasks).forEach((function(a){var e=babelHelpers.slicedToArray(a,2),r=e[0],i=e[1];if(n.kanbanGroupedByParentTasks.has(parseInt(r,10))){t.push(i)}else{s.push(i)}}));this.kanbanGroupedByParentTasks.forEach((function(a,t){if(!e.parentTasks[t]){n.hideParentTaskKanban(a)}}));t.forEach((function(a){var e=n.kanbanGroupedByParentTasks.get(parseInt(a.id,10));n.refreshParentTaskKanban(e,a)}));s.forEach((function(a){n.createParentTaskKanban(a)}))}},{key:"refreshParentTaskKanban",value:function a(e,n){e.resetPaginationPage();e.removeItems();var t=e.getInnerContainer().closest(".tasks-scrum-parent-task-kanban");this.showElement(t);this.upGroupingVisibility(t);e.loadData(n);if(n["completed"]==="Y"){this.downGroupingVisibility(t)}}},{key:"createParentTaskKanban",value:function a(n){var t=this;if(n.isVisibilitySubtasks==="N"){if(!this.kanban.getItem(n.id)){this.kanban.refreshTask(n.id)}return}this.parentTasks[n.id]=n;var s=this.createParentTaskKanbanNode(n);var r=n["completed"]==="Y";if(r){this.setTextDecorationToParentTaskName(s)}e.Dom.append(s,this.inputRenderTo);var i=s.querySelector(".tasks-scrum-kanban-group-header-tick");e.Event.bind(i,"click",(function(){t.toggleGroupingVisibility(s)}));var o=s.querySelector(".tasks-scrum-kanban-container");this.drawKanbanGroupedByParentTasks(n,o,this.inputKanbanParams)}},{key:"hideParentTaskKanban",value:function a(e){e.removeItems();var n=e.getInnerContainer().closest(".tasks-scrum-parent-task-kanban");this.hideElement(n)}},{key:"removeParentTaskKanban",value:function a(n){e.Dom.remove(n.getInnerContainer().closest(".tasks-scrum-parent-task-kanban"))}},{key:"fadeOutKanbans",value:function a(){this.kanban.fadeOut();this.kanbanGroupedByParentTasks.forEach((function(a){a.fadeOut()}))}},{key:"fadeInKanbans",value:function a(){this.kanban.fadeIn();this.kanbanGroupedByParentTasks.forEach((function(a){a.fadeIn()}))}},{key:"showNotSprintMessage",value:function a(n){var t=this.isActiveSprint?e.Loc.getMessage("KANBAN_NO_ACTIVE_SPRINT"):e.Loc.getMessage("KANBAN_NO_COMPLETED_SPRINT");e.Dom.append(e.Tag.render(i||(i=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-kanban__start">\n\t\t\t\t\t',"\n\t\t\t</div>\n\t\t"])),t),n)}},{key:"isParentTaskGrouping",value:function a(){return!e.Type.isArray(this.parentTasks)}},{key:"existsTasksGroupedBySubTasks",value:function a(n){return!e.Type.isArray(n.parentTasks)}},{key:"showElement",value:function a(n){e.Dom.style(n,"display","block")}},{key:"hideElement",value:function a(n){e.Dom.style(n,"display","none")}},{key:"createParentTaskKanbanNode",value:function a(n){return e.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-parent-task-kanban">\n\t\t\t\t<div class="tasks-scrum-kanban-group-header" style="background-color: #eaeaea;">\n\t\t\t\t\t<div class="tasks-scrum-kanban-group-header-tick">\n\t\t\t\t\t\t<div class="ui-btn ui-btn-sm ui-btn-light ui-btn-icon-angle-up"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-kanban-group-header-name">\n\t\t\t\t\t\t<a href="','">','</a>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-kanban-group-header-story-points" title="Story Points">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-kanban-container"></div>\n\t\t\t</div>\n\t\t'])),this.getTaskUrl(n.id),e.Text.encode(n.name),e.Text.encode(n.storyPoints))}},{key:"adjustGroupHeadersWidth",value:function a(){var n=this;var t=this.inputRenderTo.querySelectorAll(".tasks-scrum-kanban-group-header");t.forEach((function(a){e.Dom.style(a,"width",n.kanbanHeader.getColumnsWidth())}))}},{key:"upGroupingVisibility",value:function a(n){var t=n.querySelector(".tasks-scrum-kanban-group-header-tick");var s=n.querySelector(".tasks-scrum-kanban-container");e.Dom.removeClass(t.firstElementChild,"ui-btn-icon-angle-down");e.Dom.addClass(t.firstElementChild,"ui-btn-icon-angle-up");this.showElement(s)}},{key:"downGroupingVisibility",value:function a(n){var t=n.querySelector(".tasks-scrum-kanban-group-header-tick");var s=n.querySelector(".tasks-scrum-kanban-container");e.Dom.removeClass(t.firstElementChild,"ui-btn-icon-angle-up");e.Dom.addClass(t.firstElementChild,"ui-btn-icon-angle-down");this.hideElement(s)}},{key:"toggleGroupingVisibility",value:function a(n){var t=n.querySelector(".tasks-scrum-kanban-group-header-tick");var s=n.querySelector(".tasks-scrum-kanban-container");e.Dom.toggleClass(t.firstElementChild,"ui-btn-icon-angle-up");e.Dom.toggleClass(t.firstElementChild,"ui-btn-icon-angle-down");if(e.Dom.style(s,"display")!=="none"){this.hideElement(s)}else{this.showElement(s)}var r=n.querySelector(".main-kanban-grid");r.scrollLeft=this.kanban.getGridContainer().scrollLeft}},{key:"onCompleteParentTask",value:function a(e){var n=e.getRenderToContainer().closest(".tasks-scrum-parent-task-kanban");this.setTextDecorationToParentTaskName(n)}},{key:"onRenewParentTask",value:function a(e){var n=e.getRenderToContainer().closest(".tasks-scrum-parent-task-kanban");this.unsetTextDecorationToParentTaskName(n)}},{key:"onProceedParentTask",value:function a(e){if(this.kanbanGroupedByParentTasks.has(e.getParentTaskId())){this.removeParentTaskKanban(e);this.kanbanGroupedByParentTasks["delete"](e.getParentTaskId())}}},{key:"setTextDecorationToParentTaskName",value:function a(n){var t=n.querySelector(".tasks-scrum-kanban-group-header-name");e.Dom.style(t,"text-decoration","line-through")}},{key:"unsetTextDecorationToParentTaskName",value:function a(n){var t=n.querySelector(".tasks-scrum-kanban-group-header-name");e.Dom.style(t,"text-decoration",null)}},{key:"getTaskUrl",value:function a(e){return this.inputKanbanParams.pathToTask.replace("#task_id#",e)}}]);return a}();a.KanbanManager=u})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX,BX,BX.Event);
//# sourceMappingURL=script.map.js