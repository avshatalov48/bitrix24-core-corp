"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksToolbar!="undefined"){return}BX.Tasks.Component.TasksToolbar=BX.Tasks.Component.extend({sys:{code:"toolbar"},methodsStatic:{instance:{},getInstance:function(){return BX.Tasks.Component.TasksToolbar.instance},addInstance:function(e){BX.Tasks.Component.TasksToolbar.instance=e}},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);BX.Tasks.Component.TasksToolbar.addInstance(this);if(!this.option("counters")){this.rerender("")}else{this.render()}},bindEvents:function(){var e={user_counter:this.onUserCounter};BX.addCustomEvent("onPullEvent-tasks",function(t,n){if(e[t]){e[t].apply(this,[n])}}.bind(this));BX.addCustomEvent("Tasks.TopMenu:onItem",function(e){this.rerender(e)}.bind(this));BX.addCustomEvent("BX.Kanban.ChangeGroup",function(e,t){this.option("groupId",e);this.rerender("")}.bind(this))},onUserCounter:function(e){var t=Number(this.option("userId"));var n=Number(this.option("ownerId"));var o=Number(this.option("groupId"));if(!this.option("showCounters")||!e.hasOwnProperty(o)||t!==n||t!==Number(e.userId)){return}var r=this.option("filterId")||null;if(r){var s="view_all";var i=BX.Main.filterManager.getById(r);if(i){var a=i.getFilterFieldsValues();s=a.ROLEID||s}this.option("counters",this.prepareCounters(e[o][s]));this.render()}},prepareCounters:function(e){var t={total:"",expired:6291456,new_comments:12582912};var n={};Object.keys(e).forEach(function(o){n[o]={code:t[o],counter:e[o]}});return n},rerender:function(e){this.getToolbarData(e,this.render.bind(this))},getToolbarData:function(e,t){e=e||"";t=t||{};var n=this.option("ownerId");var o=this.option("groupId")||0;this.callRemote("ui.counters.get",{userId:n,type:e,groupId:o}).then(function(e){this.option("counters",e.getData());t.call(this)}.bind(this))},render:function(){var e=this.option("templates");var t=this.option("counters");var n=this.option("foreign_counters");var o=this.option("messages");var r=this.option("classes");var s=this.option("buttons");var i=[];if(typeof t.total==="object"&&"counter"in t.total&&t.total.counter>0){i.push(e.total.replace("#COUNTER#",t.total.counter).replace("#TEXT#",o.total));Object.keys(t).forEach(function(n){var a=t[n];if(a.counter>0&&n!=="total"){i.push(e.counter.replace("#COUNTER#",a.counter).replace("#COUNTER#",a.counter).replace("#COUNTER_ID#",n).replace("#COUNTER_CODE#",a.code).replace("#TEXT#",o[n+"_"+this.getPluralForm(a.counter)]).replace("#CLASS#",r[n]).replace("#BUTTON#",s[n]||""))}}.bind(this))}if(typeof n.foreign_expired==="object"&&"counter"in n.foreign_expired&&n.foreign_expired.counter>0||typeof n.foreign_comments==="object"&&"counter"in n.foreign_comments&&n.foreign_comments.counter>0){i.push(e.foreign.replace("#TEXT#",o.foreign));Object.keys(n).forEach(function(t){var a=n[t];if(a.counter>0){i.push(e.counter.replace("#COUNTER#",a.counter).replace("#COUNTER#",a.counter).replace("#COUNTER_ID#",t).replace("#COUNTER_CODE#",a.code).replace("#TEXT#",o[t+"_"+this.getPluralForm(a.counter)]).replace("#CLASS#",r[t]).replace("#BUTTON#",s[t]||""))}}.bind(this))}if(!i.length){i.push(e.empty.replace("#TEXT#",o.empty))}this.scope().innerHTML=i.join("");var a=this.option("filterId")||null;var c=this.option("roleId")||"view_all";if(a){var u=BX.Main.filterManager.getById(a);if(u){var l=u.getFilterFieldsValues();c=l.ROLEID||c}}var p=this.scope().getElementsByClassName("tasks-counter-container");Object.values(p).forEach(function(e){BX.bind(e,"click",function(e){BX.PreventDefault(e);BX.onCustomEvent("Tasks.Toolbar:onItem",[this.dataset.counterCode,window.location.href])});if(e.nextSibling&&BX.hasClass(e.nextSibling,"tasks-counter-counter-button")&&e.nextSibling.dataset.counterId==="new_comments"){BX.bind(e.nextSibling,"click",function(){BX.ajax.runAction("tasks.task.comment.readAll",{data:{groupId:this.option("groupId")||0,userId:this.option("ownerId"),role:c}})}.bind(this))}}.bind(this))},getPluralForm:function(e){var t,n;n=BX.message("LANGUAGE_ID");e=parseInt(e);if(e<0){e=-1*e}if(n){switch(n){case"de":case"en":t=e!==1?1:0;break;case"ru":case"ua":t=e%10===1&&e%100!==11?0:e%10>=2&&e%10<=4&&(e%100<10||e%100>=20)?1:2;break;default:t=1;break}}else{t=1}return t}}})}).call(this);
//# sourceMappingURL=logic.map.js