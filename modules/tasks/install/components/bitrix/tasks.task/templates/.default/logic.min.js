"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.Task!="undefined"){return}BX.Tasks.Component.Task=BX.Tasks.Util.Widget.extend({options:{removeTemplates:false,registerDispatcher:true,data:{}},constants:{PRIORITY_AVERAGE:1,PRIORITY_HIGH:2},sys:{code:"task-edit"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);this.instances.calendar=false;this.instances.query=false;this.instances.helpWindow=false;this.fireTaskEvent();if(this.option("doInit")){this.bindEvents();this.initParentTask();this.initRelatedTask();this.initReminder();this.initProjectDependence();this.initProjectPlan();this.initState();this.doSomeTricks()}this.onTitleChange();this.onResponsibleChange();this.checkNoWorkDays(this.getTaskData().MATCH_WORK_TIME==="Y")},getUser:function(){return this.option("auxData").USER},restrictMemberSelectors:function(){if(this.getUser().IS_SUPER_USER){return}this.vars.responsible=null;this.vars.originator=null;BX.Tasks.Util.Dispatcher.find(this.option("id")+"-responsible").then(function(t){this.vars.responsible=t;return BX.Tasks.Util.Dispatcher.find(this.option("id")+"-originator")}.bind(this)).then(function(t){this.vars.originator=t;var e=this.vars.responsible;this.vars.responsibleRestrLock=false;this.vars.originatorRestrLock=false;t.bindEvent("change",this.restrictResponsible.bind(this));e.bindEvent("change",this.restrictOriginator.bind(this))}.bind(this))},restrictResponsible:function(){if(this.vars.responsibleRestrLock){return}this.vars.originatorRestrLock=true;var t=this.vars.responsible;var e=this.vars.originator;var i=this.getUser().DATA;var s=e.value();var n=false;if(typeof s!="undefined"&&typeof s[0]!="undefined"){n=s[0]}if(n){s=t.value();var a=false;if(typeof s!="undefined"&&typeof s[0]!="undefined"){a=s[0]}if(n!="U"+i.ID){if(a!=i.ID){t.replaceItem(a,i)}t.readOnly(true)}else{t.readOnly(false)}}this.vars.originatorRestrLock=false},restrictOriginator:function(){if(this.vars.originatorRestrLock){return}this.vars.responsibleRestrLock=true;var t=this.vars.originator;var e=this.vars.responsible;if(t){if(e.count()>1){var i=this.getUser().DATA;var s=t.value();var n=false;if(typeof s!="undefined"&&typeof s[0]!="undefined"){n=s[0]}if(n){t.replaceItem(n,i);if(BX.hasClass(this.control("originator"),"invisible")){this.toggleBlock("originator")}}t.readOnly(true)}else{t.readOnly(false)}}this.vars.responsibleRestrLock=false},disableHints:function(){BX.Tasks.Util.hintManager.disableSeveral(this.option("auxData").HINT_STATE)},fireTaskEvent:function(){var t=this.option("componentData").EVENT_TYPE.toString().toUpperCase();var e=this.option("data").EVENT_TASK;var i=this.option("data").EVENT_TASK_UGLY;if(t&&(e||i)){BX.Tasks.Util.fireGlobalTaskEvent(t,e,this.option("componentData").EVENT_OPTIONS,i)}},doSomeTricks:function(){this.disableHints();this.replaceCmdBtn();var t=this.control("flag-replication");if(t.checked){BX.removeClass(this.control("replication-panel"),"invisible")}},replaceCmdBtn:function(){if(BX.browser.IsMac()){var t=this.control("cmd");if(t){t.innerHTML="&#8984;"}}},bindEditorEvents:function(t,e){BX.addCustomEvent(t,"OnIframeKeyup",e);BX.addCustomEvent(t,"OnTextareaKeyup",e)},setFocusOnTitle:function(t){setTimeout(function(){var e=this.control("title");if(e){t.Focus(false);e.focus();e.selectionStart=e.value.length;BX.focus()}}.bind(this),500)},isEditMode:function(){return this.option("template").EDIT_MODE},bindEvents:function(){if(!this.isEditMode()){BX.ready(BX.delegate(function(){var t=BX.delegate(this.onFormKeyDown,this);BX.bind(document,"keydown",t);var e=this.option("template").ID;var i=BXHtmlEditor.Get(e);if(i){this.bindEditorEvents(i,t);this.setFocusOnTitle(i,t)}else{BX.addCustomEvent(window,"OnEditorInitedAfter",BX.delegate(function(s){if(s!=null&&s.id==e){this.bindEditorEvents(s,t);this.setFocusOnTitle(i,t)}},this))}},this))}this.bindDelegateControl("toggler","click",this.passCtx(this.onToggleBlock));this.bindDelegateControl("flag","click",this.passCtx(this.onToggleFlag));this.bindDelegateControl("chooser","click",this.passCtx(this.onChooseBlock));this.bindDelegateControl("additional-header","click",this.passCtx(this.onToggleAdditionalBlock));this.bindDelegateControl("priority-cb","change",this.passCtx(this.onPriorityChange));this.bindDelegateControl("pin-footer","click",BX.delegate(this.onPinFooterClick,this));this.bindControl("cancel-button","click",BX.delegate(this.onCancelButtonClick,this));this.bindControl("title","keyup",BX.delegate(this.onTitleChange,this));var t=this.scope().getElementsByClassName("js-id-wg-optbar-flag-match-work-time");if(t.length){BX.bind(t[0],"change",this.passCtx(this.onWorktimeChange))}this.bindControl("form","submit",BX.delegate(this.onForumSubmit,this));this.bindDelegateControl("submit","click",this.passCtx(this.onSubmitClick));this.bindNestedControls();this.bindSliderEvents();BX.Tasks.Util.hintManager.bindHelp(this.control("options"));BX.addCustomEvent("SidePanel.Slider:onMessage",BX.delegate(function(t){if(t.getEventId()=="sonetGroupEvent"){var e=t.getData();if(BX.type.isNotEmptyString(e.code)&&e.code=="afterCreate"&&typeof e.data!="undefined"&&typeof e.data.group!="undefined"){var i=e.data.group;var s=BX.Tasks.Component.TasksWidgetMemberSelector.getInstance(this.sys.id+"-project");s.getSelector().onSelectorItemSelected({id:i.ID,entityType:"SG",networkId:"",DISPLAY:i.FIELDS.NAME})}}},this))},bindNestedControls:function(){BX.Tasks.Util.Dispatcher.bindEvent(this.option("id")+"-responsible","change",this.onResponsibleChange.bind(this));BX.Tasks.Util.Dispatcher.bindEvent(this.option("id")+"-originator","change",this.onOriginatorChange.bind(this));this.restrictMemberSelectors();this.getDispatcher().bindEvent("options-"+this.option("id"),"toggle",this.processToggleFlag.bind(this))},bindSliderEvents:function(){BX.addCustomEvent("SidePanel.Slider:onLoad",this.setEditorBeforeUnloadEvent.bind(this,true));BX.addCustomEvent("SidePanel.Slider:onClose",this.setEditorBeforeUnloadEvent.bind(this,false))},setEditorBeforeUnloadEvent:function(t){var e=this.option("template").ID;var i=BXHtmlEditor.Get(e);if(i){t?i.AllowBeforeUnloadHandler():i.DenyBeforeUnloadHandler()}},getTaskData:function(){return this.option("data").TASK},getTaskActions:function(){return this.getTaskData().ACTION},initProjectDependence:function(){var t=BX.Tasks.Util.Dispatcher.get("projectdependence-"+this.id());t.assignCalendar(this.getCalendar());t.option("task",{data:this.getTaskData()});t.load(this.getTaskData().SE_PROJECTDEPENDENCE,this.getTaskActions().SE_PROJECTDEPENDENCE)},initProjectPlan:function(){this.instances.projectPlan=new BX.Tasks.Shared.Form.ProjectPlan({scope:this.control("date-plan-manager"),parent:this,matchWorkTime:this.getTaskData().MATCH_WORK_TIME=="Y"});this.instances.projectPlan.bindEvent("change-deadline",BX.delegate(function(t){BX.Tasks.Util.Dispatcher.fireEvent("reminder-"+this.id(),"setTaskDeadLine",[t])},this))},initParentTask:function(){var t="parenttask";var e=new BX.Tasks.Component.Task.TaskItemSet({id:t+"-"+this.id(),max:1,selectorCode:t,itemFx:"horizontal",itemFxHoverDelete:true,parent:this});e.bindEvent("change",BX.delegate(function(t){this.control("parent-input").value=t.length>0?parseInt(t[0]):""},this));if(this.getTaskData().SE_PARENTTASK){e.load([this.getTaskData().SE_PARENTTASK])}this.instances[t]=e},initRelatedTask:function(){this.instances["dependson"]=new BX.Tasks.Component.Task.TaskItemSet({id:"dependson-"+this.id(),selectorCode:"dependson",itemFx:"horizontal",itemFxHoverDelete:true,parent:this});if(typeof this.getTaskData().SE_RELATEDTASK!="undefined"){this.instances["dependson"].load(this.getTaskData().SE_RELATEDTASK)}},initReminder:function(){var t=BX.Tasks.Util.Dispatcher.get("reminder-"+this.id());if(t!==null){t.load(this.getTaskData().SE_REMINDER,this.getTaskActions().SE_REMINDER);t.setTaskId(this.getTaskData().ID);t.setTaskDeadLine(this.getTaskData().DEADLINE)}},initState:function(){this.vars.state=BX.clone(this.option("state"));this.redrawState()},onPinFooterClick:function(){var t=!this.vars.state.FLAGS.FORM_FOOTER_PIN;var e=this.control("footer");if(e){BX[t?"addClass":"removeClass"](e,"pinned")}this.setState("FLAGS","FORM_FOOTER_PIN",false,t)},onPriorityChange:function(t){var e=this.control("priority");if(BX.type.isElementNode(e)){e.value=t.checked?this.PRIORITY_HIGH:this.PRIORITY_AVERAGE}},onForumSubmit:function(){var t=this.control("csrf");if(t){t.value=BX.bitrix_sessid()}this.vars.submitting=true},onSubmitClick:function(t,e){if(this.vars.submitting){BX.PreventDefault(e);return}BX.addClass(t,"ui-btn-clock");this.vars.submitting=true},submit:function(){this.control("form").submit()},onFormKeyDown:function(t){t=t||window.event;var e=false;if(BX.Tasks.Util.isEnter(t)){if((t.ctrlKey||t.metaKey)&&t.type==="keydown"){this.submit();e=true}}if(e){BX.PreventDefault(t)}},onChooseBlock:function(t){var e=this.control("chosen-blocks");var i=this.control("unchosen-blocks");if(!BX.type.isElementNode(e)||!BX.type.isElementNode(i)){return}var s=BX.data(t,"target");if(typeof s!="undefined"&&BX.type.isNotEmptyString(s)){var t=this.control(s);var n=BX.data(t,"block-name");if(BX.type.isNotEmptyString(n)&&BX.type.isElementNode(t)){var a=this.vars.state["BLOCKS"][n];if(typeof a.C!="undefined"){var o=!a.C;var r=this.control(s+"-place",o?e:i);var l=this.control(s+"-place",o?i:e);if(r){if(!o){var d=this.control("additional");if(BX.hasClass(d,"hidden")){BX.removeClass(d,"hidden")}}BX.Tasks.Util.fadeSlideToggleByClass(l,200,function(){BX.addClass(r,"invisible");BX.append(t,r);BX.Tasks.Util.fadeSlideToggleByClass(r,200);BX.removeClass(l,"invisible")})}else{BX.toggleClass(t,"pinned")}this.setState("BLOCKS",n,"C",!a.C)}}}},onToggleAdditionalBlock:function(t){var e=BX.hasClass(t,"opened");BX.toggleClass(t,"opened");this.toggleBlock("unchosen-blocks")},onToggleBlock:function(t){var e=BX.data(t,"target");if(typeof e!="undefined"&&BX.type.isNotEmptyString(e)){var i=this.toggleBlock(e);if(i&&e=="checklist"){BX.Tasks.Util.Dispatcher.find(this.id()+"-checklist").then(function(t){if(!t.count()){t.openForm()}}.bind(this))}}},toggleBlock:function(t,e){return BX.Tasks.Util.fadeSlideToggleByClass(this.control(t),e||100)},toggleOption:function(t,e){var i=this.getOptionNode(t);if(i){i.checked=!!e;this.onToggleFlag(i)}},switchOption:function(t,e){var i=this.getOptionNode(t);if(i){i.disabled=!!e}},getOptionNode:function(t){t=t.toLowerCase().replace(/_/g,"-");return this.control("flag-"+t)},onToggleFlag:function(t){var e=BX.data(t,"target");if(typeof e!="undefined"&&BX.type.isNotEmptyString(e)){var i=this.control(e);var s=BX.data(t,"flag-name");if(BX.type.isElementNode(i)){i.value=t.checked?"Y":"N"}this.processToggleFlag(s,i.value=="Y")}},processToggleFlag:function(t,e){if(t=="REPLICATE"){var i=this.control("replication-panel");if(e){BX.Tasks.Util.fadeSlideToggleByClass(i)}else{BX.Tasks.Util.fadeSlideToggleByClass(i)}this.toggleOption("SAVE_AS_TEMPLATE",e);this.switchOption("SAVE_AS_TEMPLATE",e)}if(t=="TASK_PARAM_1"){this.toggleDateParameters(e)}this.setState("FLAGS",t,false,e)},toggleDateParameters:function(t){BX[t?"addClass":"removeClass"](this.control("date-plan"),"disabled-block");BX.Tasks.Util.Dispatcher.find("options-"+this.option("id")).then(function(e){e.switchOption("MATCH_WORK_TIME",!t)}.bind(this))},onOriginatorChange:function(){BX.Tasks.Util.Dispatcher.find(this.option("id")+"-originator").then(function(t){if(t.count()&&t.value()){var e="U"+this.getUser().DATA.ID.toString()==t.value()[0].toString();BX.Tasks.Util.Dispatcher.find("options-"+this.option("id")).then(function(t){t.switchOption("ADD_TO_TIMEMAN",e)}.bind(this))}}.bind(this))},onResponsibleChange:function(){BX.Tasks.Util.Dispatcher.find(this.option("id")+"-responsible").then(function(t){if(t.count()>1){BX.Tasks.Util.hintManager.showDisposable(t.scope(),BX.message("TASKS_TASK_COMPONENT_TEMPLATE_MULTIPLE_RESPONSIBLE_NOTICE"),"TASK_EDIT_MULTIPLE_RESPONSIBLES")}else{BX.Tasks.Util.hintManager.hide("TASK_EDIT_MULTIPLE_RESPONSIBLES")}if(t.count()>0){var e=new BX.Tasks.Util.Query({autoExec:true});var i={userIds:t.value().map(function(t){return t.substring(1)})};var s=this.control("absence-message");s.style.display="none";while(s.lastChild){s.removeChild(s.lastChild)}e.add("integration.intranet.absence",i,{},BX.delegate(function(t,e){if(!t.checkHasErrors()){if(e.RESULT.length>0){var i=e.RESULT.reduce(function(t,e){return t+"<br />"+e});var n=new BX.UI.Alert({icon:BX.UI.Alert.Icon.INFO,color:BX.UI.Alert.Color.WARNING,text:i});s.appendChild(n.getContainer());s.style.display="block"}}},this))}}.bind(this))},onCancelButtonClick:function(t){if(this.option("cancelActionIsEvent")){BX.Tasks.Util.fireGlobalTaskEvent("NOOP",{},{STAY_AT_PAGE:false});BX.PreventDefault(t)}},onWorktimeChange:function(t){this.checkNoWorkDays(t.checked);this.instances.projectPlan.setMatchWorkTime(t.checked)},checkNoWorkDays:function(t){if(!t){if(BX.type.isElementNode(BX("date-plan-alert"))){BX("date-plan-alert").remove()}return false}var e=true;var i=this.getCalendar();var s=i.weekends;var n=[0,1,2,3,4,5,6];n.forEach(function(t){if(!(t in s)){e=false}});if(e&&!BX.type.isElementNode(BX("date-plan-alert"))){var a=BX.create("div",{props:{id:"date-plan-alert",className:"ui-alert ui-alert-danger"},attrs:{style:"margin-top: 10px"},children:[BX.create("span",{props:{className:"ui-alert-message"},text:BX.message("TASKS_TASK_COMPONENT_TEMPLATE_NO_WORK_DAYS_ERROR")})]});this.control("date-plan-manager").appendChild(a)}return e},onTitleChange:function(){var t=this.control("title");if(t.value.length>250){BX.addClass(t,"task-field-error")}else{BX.removeClass(t,"task-field-error")}},getCalendar:function(){if(this.instances.calendar==false){this.instances.calendar=new BX.Tasks.Calendar(BX.Tasks.Calendar.adaptSettings(this.option("auxData").COMPANY_WORKTIME))}return this.instances.calendar},getState:function(t,e,i){if(t=="BLOCKS"){return this.vars.state[t][e][i]}if(t=="FLAGS"){return this.vars.state[t][e]}},setState:function(t,e,i,s){if(!BX.type.isNotEmptyString(e)){return}if(t=="FLAGS"){var n={ALLOW_TIME_TRACKING:true,TASK_CONTROL:true,ALLOW_CHANGE_DEADLINE:true,MATCH_WORK_TIME:true,FORM_FOOTER_PIN:true};if(!(e in n)){return}}if(typeof this.vars.state[t]=="undefined"){this.vars.state[t]={}}if(typeof this.vars.state[t][e]=="undefined"){this.vars.state[t][e]={}}if(t=="BLOCKS"){this.vars.state[t][e][i]=s}if(t=="FLAGS"){this.vars.state[t][e]=s}this.submitState();this.redrawState()},submitState:function(){if(!this.instances.query){this.instances.query=new BX.Tasks.Util.Query({url:this.option("template").COMPONENTURL,autoExec:true,autoExecDelay:1500})}var t=BX.clone(this.vars.state);var e=t.FLAGS.FORM_FOOTER_PIN;delete t.FLAGS;t.FLAGS={FORM_FOOTER_PIN:e};this.instances.query.add("this.setstate",{state:t})},redrawState:function(){var t=this.control("state");if(BX.type.isElementNode(t)){var e="";if(typeof this.vars.state["BLOCKS"]!="undefined"){for(var i in this.vars.state["BLOCKS"]){var s=this.vars.state["BLOCKS"][i]["O"];var n=this.vars.state["BLOCKS"][i]["C"];if(typeof s!="undefined"){e+=this.getHTMLByTemplate("state-block",{NAME:i,TYPE:"O",VALUE:s===true||s==="true"?"1":"0"})}if(typeof n!="undefined"){e+=this.getHTMLByTemplate("state-block",{NAME:i,TYPE:"C",VALUE:n===true||n==="true"?"1":"0"})}}}if(typeof this.vars.state["FLAGS"]!="undefined"){for(var a in this.vars.state["FLAGS"]){var o=this.vars.state["FLAGS"][a];e+=this.getHTMLByTemplate("state-flag",{NAME:a,VALUE:o===true||o==="true"?"1":"0"})}}t.innerHTML=e}}}});BX.Tasks.Component.Task.UserItemSet=BX.Tasks.UserItemSet.extend({methods:{onSearchBlurred:function(){if(this.callMethod(BX.Tasks.UserItemSet,"onSearchBlurred")){this.restoreKept()}},restoreKept:function(){if(this.vars.toDelete){this.addItem(this.vars.toDelete,{checkRestrictions:false});this.vars.toDelete=false}},onSelectorItemSelected:function(t){var e=this.extractItemValue(t);if(!this.hasItem(e)){var i=this.option("max");this.addItem(t);this.vars.toDelete=false;if(i==1){this.instances.selector.close();this.onSearchBlurred()}}this.resetInput()},openAddForm:function(t,e,i){var s=this.option("min");var n=this.option("max");if(i||n==1&&(s==0||s==1)){var a=this.getItemFirst();if(a){this.vars.toDelete=a.data();this.callMethod(BX.Tasks.UserItemSet,"deleteItem",[a.value(),{checkRestrictions:false}])}}this.callMethod(BX.Tasks.UserItemSet,"openAddForm")},deleteItem:function(t){if(!this.callMethod(BX.Tasks.UserItemSet,"deleteItem",arguments)){this.openAddForm(false,false,true);return false}return true}}});BX.Tasks.Component.Task.GroupItemSet=BX.Tasks.Component.Task.UserItemSet.extend({sys:{code:"group-item-set"},methods:{extractItemDisplay:function(t){return t.NAME||BX.util.htmlspecialcharsback(t.nameFormatted)},getNSMode:function(){return"group"}}});BX.Tasks.Component.Task.TaskItemSet=BX.Tasks.PopupItemSet.extend({sys:{code:"task-item-set"},options:{itemFx:"horizontal"},methods:{construct:function(){this.callConstruct(BX.Tasks.PopupItemSet);this.instances.selector=window["O_"+this.option("selectorCode")]},extractItemDisplay:function(t){if(typeof t.DISPLAY!="undefined"){return t.DISPLAY}if(typeof t.name!="undefined"){return t.name}return t.TITLE+" ["+t.ID+"]"},extractItemValue:function(t){return typeof t.ID=="undefined"?t.id:t.ID},bindFormEvents:function(){if(typeof this.instances.selector!="undefined"&&this.instances.selector!=null&&this.instances.selector!=false){BX.addCustomEvent(this.instances.selector,"on-change",BX.delegate(this.itemsChanged,this));if(typeof this.instances.window!="undefined"){var t=this.instances.selector;BX.addCustomEvent(this.instances.window,"onAfterPopupShow",function(){setTimeout(function(){t.searchInput.focus()},100)})}}},deleteItem:function(t,e){var i=BX.type.isNumber(t)||BX.type.isString(t)?t:t.value();if(this.callMethod(BX.Tasks.PopupItemSet,"deleteItem",arguments)){this.instances.selector.unselect(i)}}}})}).call(this);
//# sourceMappingURL=logic.map.js