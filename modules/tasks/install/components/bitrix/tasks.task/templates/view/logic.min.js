"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TaskView!="undefined"){return}BX.Tasks.Component.TaskView=function(t){this.parameters=t||{};this.taskId=this.parameters.taskId;this.userId=this.parameters.userId;this.layout={favorite:BX("task-detail-favorite"),switcher:BX("task-switcher"),switcherTabs:[],elapsedTime:BX("task-switcher-elapsed-time"),effective:BX("task-switcher-effective"),createButton:BX("task-detail-create-button"),importantButton:BX("task-detail-important-button"),saveButton:BX("saveButton"),cancelButton:BX("cancelButton")};this.openTime=this.parameters.componentData.OPEN_TIME;this.analyticsData={};this.timeout=0;this.timeoutSec=2e3;this.paramsToLazyLoadTabs=t.paramsToLazyLoadTabs||{};this.listTabIdUploadedContent={};this.messages=this.parameters.messages||{};for(var e in this.messages){BX.message[e]=this.messages[e]}this.paths=this.parameters.paths||{};this.createButtonMenu=[];this.checkListChanged=false;this.showCloseConfirmation=false;BX.addCustomEvent(window,"tasksTaskEvent",this.onTaskEvent.bind(this));BX.addCustomEvent("SidePanel.Slider:onClose",this.onSliderClose.bind(this,false));BX.addCustomEvent("SidePanel.Slider:onCloseByEsc",this.onSliderClose.bind(this,true));BX.addCustomEvent(window,"OnUCCommentWasRead",this.onCommentRead.bind(this));BX.Event.EventEmitter.subscribe("BX.Tasks.CheckListItem:CheckListChanged",function(t){var e=t.data.action;var s=["addAccomplice","fileUpload","tabIn"];if(BX.util.in_array(e,s)){this.analyticsData[e]="Y"}this.toggleFooterWrap(true)}.bind(this));this.initFavorite();this.initCreateButton();this.initSwitcher();this.initViewer();this.initAjaxErrorHandler();this.initImportantButton();this.initFooterButtons();this.initCommentActionController();this.extendWatch();this.handleEvent();this.temporalCommentFix();if(!!window.mplCheckForQuote&&BX("task-detail-author-info")){BX.bind(BX("task-detail-content"),"mouseup",function(t){window.mplCheckForQuote(t,t.currentTarget,"TASK_"+this.taskId,"task-detail-author-info")}.bind(this))}};BX.Tasks.Component.TaskView.prototype.extendWatch=function(){BX.PULL.extendWatch("TASK_VIEW_"+this.taskId,true);setTimeout(function(){this.extendWatch()}.bind(this),29*60*1e3)};BX.Tasks.Component.TaskView.prototype.onSliderClose=function(t,e){if(!this.checkListChanged||typeof BX.Tasks.CheckListInstance==="undefined"){return}var s=BX.Tasks.CheckListInstance.optionManager.slider;if(!s||s!==e.getSlider()){return}if(t){var i=BX.Tasks.CheckListInstance.getTreeStructure();if(i&&i.checkActiveUpdateExist()){e.denyAction();return}}if(!this.showCloseConfirmation){this.showCloseConfirmation=true;return}e.denyAction();this.showChecklistCloseSliderPopup(s)};BX.Tasks.Component.TaskView.prototype.showChecklistCloseSliderPopup=function(t){if(!this.checklistCloseSliderPopup){this.checklistCloseSliderPopup=new BX.PopupWindow({titleBar:BX.message("TASKS_CLOSE_SLIDER_CONFIRMATION_POPUP_HEADER"),content:BX.message("TASKS_CLOSE_SLIDER_CONFIRMATION_POPUP_CONTENT"),closeIcon:false,buttons:[new BX.PopupWindowButton({text:BX.message("TASKS_CLOSE_SLIDER_CONFIRMATION_POPUP_BUTTON_CLOSE"),className:"popup-window-button-accept",events:{click:function(){this.showCloseConfirmation=false;this.checklistCloseSliderPopup.close();t.close()}.bind(this)}}),new BX.PopupWindowButton({className:"popup-window-button popup-window-button-link",text:BX.message("TASKS_CLOSE_SLIDER_CONFIRMATION_POPUP_BUTTON_CANCEL"),events:{click:function(){this.checklistCloseSliderPopup.close()}.bind(this)}})]})}this.checklistCloseSliderPopup.show()};BX.Tasks.Component.TaskView.prototype.onCommentRead=function(t,e){if(t==="TASK_"+this.taskId&&this.timeout<=0){this.timeout=setTimeout(this.readComments.bind(this),this.timeoutSec)}};BX.Tasks.Component.TaskView.prototype.readComments=function(){this.timeout=0;BX.ajax.runAction("tasks.task.view.update",{data:{taskId:this.taskId}})};BX.Tasks.Component.TaskView.prototype.temporalCommentFix=function(){BX.addCustomEvent(window,"OnUCFormResponse",(function(t,e,s){if(BX.type.isNotEmptyString(t)&&t.indexOf("TASK_")===0&&BX.proxy_context&&BX.proxy_context.jsonFailure===true){if(s&&s["handler"]&&s.handler["oEditor"]&&s.handler.oEditor["DenyBeforeUnloadHandler"]){s.handler.oEditor.DenyBeforeUnloadHandler()}BX.reload()}}))};BX.Tasks.Component.TaskView.prototype.handleEvent=function(){var t=this.parameters.componentData.EVENT_TYPE;var e=this.parameters.componentData.EVENT_OPTIONS;if(t==="ADD"){var s={action:"taskAdding",source:"addButton"};if(e.FIRST_GRID_TASK_CREATION_TOUR_GUIDE){s.tourGuide="firstGridTaskCreation"}if(e.SCOPE){s.scope=e.SCOPE}BX.ajax.runAction("tasks.analytics.hit",{analyticsLabel:s})}this.fireTaskEvent(t,e)};BX.Tasks.Component.TaskView.prototype.fireTaskEvent=function(t,e){var s=this;if(this.parameters.eventTaskUgly!=null){if(t==="ADD"){var i=window.top;i.BX.UI.Notification.Center.notify({content:BX.message("TASKS_NOTIFY_TASK_CREATED"),actions:[{title:BX.message("TASKS_NOTIFY_TASK_DO_VIEW"),events:{click:function(t,e,a){e.close();i.BX.SidePanel.Instance.open(s.parameters.eventTaskUgly.url)}}}]})}BX.Tasks.Util.fireGlobalTaskEvent(t,{ID:this.parameters.eventTaskUgly.id},{STAY_AT_PAGE:e.STAY_AT_PAGE!=false},this.parameters.eventTaskUgly)}};BX.Tasks.Component.TaskView.prototype.initImportantButton=function(){if(this.parameters.can.TASK.ACTION.EDIT){BX.bind(this.layout.importantButton,"click",BX.Tasks.passCtx(this.onImportantButtonClick,this))}};BX.Tasks.Component.TaskView.prototype.initCreateButton=function(){BX.bind(this.layout.createButton,"click",this.onCreateButtonClick.bind(this));var t=this.paths;var e=this;this.createButtonMenu=[{text:this.messages.addTask,className:"menu-popup-item menu-popup-no-icon",href:this.paths.newTask},{text:this.messages.addTaskByTemplate,className:"menu-popup-item menu-popup-no-icon menu-popup-item-submenu",cacheable:true,events:{onSubMenuShow:function(){if(this.subMenuLoaded){return}var s=this.getSubMenu();s.removeMenuItem("loading");BX.ajax.runComponentAction("bitrix:tasks.templates.list","getList",{mode:"class",data:{select:["ID","TITLE"],order:{ID:"DESC"},filter:{ZOMBIE:"N"}}}).then(function(s){this.subMenuLoaded=true;var i=t.newTask+(t.newTask.indexOf("?")!==-1?"&":"?")+"TEMPLATE=";var a=[];if(s.data.length>0){BX.Tasks.each(s.data,function(t,e){a.push({text:BX.util.htmlspecialchars(t.TITLE),href:i+t.ID})}.bind(this))}else{a.push({text:e.messages.tasksAjaxEmpty})}this.addSubMenu(a);this.showSubMenu()}.bind(this),function(t){this.subMenuLoaded=true;this.addSubMenu([{text:e.messages.tasksAjaxErrorLoad}]);this.showSubMenu()}.bind(this))}},items:[{id:"loading",text:"TASKS_AJAX_LOAD_TEMPLATES"}]},{delimiter:true},{text:this.messages.addSubTask,className:"menu-popup-item menu-popup-no-icon",href:this.paths.newSubTask},{delimiter:true},{text:this.messages.listTaskTemplates,className:"menu-popup-item menu-popup-no-icon",href:this.paths.taskTemplates,target:"_top"}]};BX.Tasks.Component.TaskView.prototype.initFooterButtons=function(){BX.bind(this.layout.saveButton,"click",this.onSaveButtonClick.bind(this));BX.bind(this.layout.cancelButton,"click",this.onCancelButtonClick.bind(this))};BX.Tasks.Component.TaskView.prototype.onSaveButtonClick=function(){if(this.isSaving){return}this.isSaving=true;BX.Tasks.CheckListInstance.activateLoading();BX.Tasks.CheckListInstance.onSave();this.saveCheckList()};BX.Tasks.Component.TaskView.prototype.saveCheckList=function(){var t=this;var e=BX.Tasks.CheckListInstance.getTreeStructure();BX.ajax.runComponentAction("bitrix:tasks.widget.checklist.new","saveChecklist",{mode:"class",data:{taskId:this.taskId,items:e.getRequestData(),params:{analyticsData:Object.assign(this.analyticsData,{checklistCount:e.getDescendantsCount()})}}}).then(function(e){var s=e.data;var i=s.PREVENT_CHECKLIST_SAVE;if(i){var a=new BX.PopupWindow({titleBar:"Warning",content:i,closeIcon:false,buttons:[new BX.PopupWindowButton({className:"popup-window-button",text:"OK",events:{click:function(){a.close();BX.Tasks.CheckListInstance.deactivateLoading();BX.removeClass(BX("saveButton"),"ui-btn-wait")}}})],events:{onPopupClose:function(){this.destroy()}}});a.show()}else{var n=s.OPEN_TIME;var o=s.TRAVERSED_ITEMS;if(o){var r=BX.Tasks.CheckListInstance.getTreeStructure();Object.keys(o).forEach((function(t){var e=r.findChild(t);if(e!=="undefined"&&e.fields.getId()===null){e.fields.setId(o[t].ID)}}))}if(n){this.openTime=n}this.analyticsData={};BX.Tasks.CheckListInstance.saveStableTreeStructure();BX.Tasks.CheckListInstance.deactivateLoading();t.toggleFooterWrap(false);this.isSaving=false}}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors);this.isSaving=false;BX.Tasks.CheckListInstance.deactivateLoading()}}.bind(this))};BX.Tasks.Component.TaskView.prototype.onCancelButtonClick=function(t){if(this.isSaving){return}var e=this;var s=new BX.PopupWindow({titleBar:BX.message("TASKS_DISABLE_CHANGES_CONFIRMATION_POPUP_HEADER"),content:BX.message("TASKS_DISABLE_CHANGES_CONFIRMATION_POPUP_CONTENT"),closeIcon:false,buttons:[new BX.PopupWindowButton({text:BX.message("TASKS_DISABLE_CHANGES_CONFIRMATION_POPUP_BUTTON_YES"),className:"popup-window-button-accept",events:{click:function(){s.close();if(BX.Tasks.CheckListInstance!=="undefined"){BX.Tasks.CheckListInstance.rerender()}e.toggleFooterWrap(false)}}}),new BX.PopupWindowButton({className:"popup-window-button popup-window-button-link",text:BX.message("TASKS_DISABLE_CHANGES_CONFIRMATION_POPUP_BUTTON_NO"),events:{click:function(){s.close()}}})],events:{onPopupClose:function(){this.destroy()}}});s.show()};BX.Tasks.Component.TaskView.prototype.onImportantButtonClick=function(t){var e=BX.data(t,"priority");var s=e==2?1:2;BX.ajax.runComponentAction("bitrix:tasks.task","setPriority",{mode:"class",data:{taskId:this.taskId,priority:s}}).then(function(e){BX.data(t,"priority",s);BX.toggleClass(t,"no")}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors)}}.bind(this))};BX.Tasks.Component.TaskView.prototype.onCreateButtonClick=function(){BX.PopupMenu.show("task-detail-create-button",this.layout.createButton,this.createButtonMenu,{angle:{position:"top",offset:40}})};BX.Tasks.Component.TaskView.prototype.onTaskEvent=function(t,e){e=e||{};var s=e.task||{};if(t=="UPDATE"&&s.ID==this.parameters.taskId){if(BX.type.isNotEmptyString(s.REAL_STATUS)){this.setStatus(s.REAL_STATUS)}}if(t==="ADD"){if(this.taskId===e.taskUgly.parentTaskId){window.location.href=this.paths.taskView}}};BX.Tasks.Component.TaskView.prototype.setStatus=function(t){var e=BX("task-detail-status-below-name");if(e){var s=BX.message("TASKS_STATUS_"+t);e.innerHTML=s.substr(0,1).toLowerCase()+s.substr(1)}};BX.Tasks.Component.TaskView.prototype.initFavorite=function(){BX.bind(this.layout.favorite,"click",BX.proxy(this.onFavoriteClick,this))};BX.Tasks.Component.TaskView.prototype.onFavoriteClick=function(){var t=BX.hasClass(this.layout.favorite,"task-detail-favorite-active")?"deleteFavorite":"addFavorite";BX.ajax.runComponentAction("bitrix:tasks.task",t,{mode:"class",data:{taskId:this.taskId}}).then(function(t){BX.toggleClass(this.layout.favorite,"task-detail-favorite-active")}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors)}}.bind(this))};BX.Tasks.Component.TaskView.prototype.initSwitcher=function(){if(!this.layout.switcher){return}var t=this.layout.switcher.getElementsByClassName("task-switcher");var e=this.layout.switcher.parentNode.getElementsByClassName("task-switcher-block");for(var s=0;s<t.length;s++){var i=t[s],a=i.dataset.id;var n=e[s];BX.bind(i,"click",BX.proxy(this.onSwitch,this));this.layout.switcherTabs.push({title:i,block:n});this.listTabIdUploadedContent[a]=false;switch(a){case"files":BX.addCustomEvent("OnUCAfterRecordAdd",BX.proxy(this.onUCAfterRecordAdd,this));break}}BX.addCustomEvent("TaskElapsedTimeUpdated",BX.proxy((function(t,e,s,i){this.layout.elapsedTime.innerText=BX.Tasks.Util.formatTimeAmount(i.time)}),this))};BX.Tasks.Component.TaskView.prototype.onSwitch=function(){var t=BX.proxy_context;if(BX.hasClass(t,"task-switcher-selected")){return false}switch(t.dataset.id){default:this.switchTabStyle(t);break;case"files":this.getTabContent(t);break}return false};BX.Tasks.Component.TaskView.prototype.getTabContent=function(t){var e=t.dataset.id;if(!this.paramsToLazyLoadTabs.hasOwnProperty(e)){return}if(this.listTabIdUploadedContent[e]){this.switchTabStyle(t)}else if(e==="files"){BX.ajax.runComponentAction("bitrix:tasks.task","getFiles",{mode:"class",data:{taskId:this.parameters.taskId}}).then(function(s){var i=s.data;if(i.asset&&i.html&&BX.type.isNotEmptyString(i.html)){BX.html(null,i.asset.join(" ")).then(function(){this.listTabIdUploadedContent[e]=true;BX("task-"+e+"-block").innerHTML=i.html;BX.ajax.processScripts(BX.processHTML(i.html).SCRIPT);this.switchTabStyle(t)}.bind(this))}}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors)}}.bind(this))}};BX.Tasks.Component.TaskView.prototype.switchTabStyle=function(t){for(var e=0;e<this.layout.switcherTabs.length;e++){var s=this.layout.switcherTabs[e].title;var i=this.layout.switcherTabs[e].block;if(s===t){BX.addClass(s,"task-switcher-selected");BX.addClass(i,"task-switcher-block-selected")}else{BX.removeClass(s,"task-switcher-selected");BX.removeClass(i,"task-switcher-block-selected")}}};BX.Tasks.Component.TaskView.prototype.onUCAfterRecordAdd=function(t,e){if(e.hasOwnProperty("messageFields")){var s=e.messageFields.UF,i;if(s&&s["UF_FORUM_MESSAGE_DOC"]){i=s["UF_FORUM_MESSAGE_DOC"];if(BX.type.isArray(i.VALUE)&&i.VALUE.length){this.listTabIdUploadedContent["files"]=false;this.setFileCount()}}}};BX.Tasks.Component.TaskView.prototype.setFileCount=function(){BX.ajax.runComponentAction("bitrix:tasks.task","getFileCount",{mode:"class",data:{taskId:this.taskId}}).then(function(t){if(t.data.fileCount){BX.findChildByClassName(BX("task-files-switcher"),"task-switcher-text-counter").innerHTML=parseInt(t.data.fileCount)}}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors)}}.bind(this))};BX.Tasks.Component.TaskView.prototype.initViewer=function(){var t=["task-detail-description","task-detail-files","task-comments-block","task-files-block"];t.forEach((function(t){var e=BX(t);if(e){var s=typeof top.BX.viewElementBind==="function"?top.BX:BX;s.viewElementBind(e,{},(function(t){return BX.type.isElementNode(t)&&(t.getAttribute("data-bx-viewer")||t.getAttribute("data-bx-image"))}))}}))};BX.Tasks.Component.TaskView.prototype.initAjaxErrorHandler=function(){BX.addCustomEvent("TaskAjaxError",(function(t){BX.Tasks.alert(t).then((function(){BX.reload()}))}))};BX.Tasks.Component.TaskView.prototype.toggleFooterWrap=function(t){var e=BX("footerWrap");var s=BX("saveButton");var i="ui-btn-wait";var a="task-footer-wrap-active";if(t){if(!BX.hasClass(e,a)){BX.addClass(e,a)}this.checkListChanged=true;this.showCloseConfirmation=true}else{if(BX.hasClass(e,a)){BX.removeClass(e,a)}BX.removeClass(s,i);this.checkListChanged=false;this.showCloseConfirmation=false}};BX.Tasks.Component.TaskView.prototype.initCommentActionController=function(){if(window.top!==window&&window.BX.Tasks.CommentActionController){window.top.BX.Tasks.CommentActionController=window.BX.Tasks.CommentActionController}if(BX.Tasks.CommentActionController){void BX.Tasks.CommentActionController.init({workHours:this.parameters.workHours,workSettings:this.parameters.workSettings})}}}).call(this);
//# sourceMappingURL=logic.map.js