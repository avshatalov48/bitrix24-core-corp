"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetRights!="undefined"){return}BX.Tasks.Component.TasksWidgetTemplateAccess=BX.Tasks.Component.extend({sys:{code:"rights"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);var e=null;BX.Tasks.each(this.option("levels"),function(t){e=t;return false});this.vars.firstLevel=e;this.vars.addedItems=[];this.getManager()},getManager:function(){return this.subInstance("items",function(){return new this.constructor.ItemManager({scope:this.scope(),preRendered:true,data:this.option("data"),parent:this})})}}});BX.Tasks.Component.TasksWidgetTemplateAccess.ItemManager=BX.Tasks.Util.ItemSet.extend({sys:{code:"rights-is"},options:{controlBind:"class",useSmartCodeNaming:true},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.ItemSet);this.preselectedItems=this.option("data")},bindItemActions:function(){this.callMethod(BX.Tasks.Util.ItemSet,"bindItemActions");this.bindOnItemEx("i-operation-title","click",this.onItemOperationClick.bind(this))},onItemOperationClick:function(e,t){var i=[];BX.Tasks.each(this.optionP("levels"),function(t){i.push({enabled:true,text:t.TITLE,onclick:this.passCtx(this.doMenuAction),itemRef:e,levelId:t.ID,levelTitle:t.TITLE})}.bind(this));BX.PopupMenu.show(this.id()+"-op-popup-"+e.value(),t,i,{angle:true,position:"right",offsetLeft:40,offsetTop:0})},doMenuAction:function(e,t,i){e.popupWindow.close();this.setItemOperation(i.itemRef,i.levelId,i.levelTitle)},setItemOperation:function(e,t,i){e.data().PERMISSION_ID=t;e.control("operation-title").innerHTML=i;e.control("operation").value=t},extractItemValue:function(e){if("VALUE"in e){return e.VALUE}e.VALUE=this.getRandomHash();return e.VALUE},prepareData:function(e){var t=this.parent().vars.firstLevel;this.setField("ID",e,"");this.setField("TITLE",e,t.TITLE);this.setField("PERMISSION_ID",e,t.ID);this.setField("MEMBER_ID",e,e.id);this.setField("MEMBER_TYPE",e,t.MEMBER_TYPE);this.setField("DISPLAY",e,function(e){if("nameFormatted"in e){return BX.util.htmlspecialcharsback(e.nameFormatted)}var t=this.option("nameTemplate");if(t){var i=BX.formatName(e,t,"Y");if(i=="Noname"){i=e.LOGIN||e.login}return i}return e.LOGIN});e.ITEM_SET_INVISIBLE="";return e},openAddForm:function(){this.getDialog().show()},getDialog:function(){if(!this.dialog){this.dialog=new BX.UI.EntitySelector.Dialog({targetNode:this.control("open-form"),enableSearch:true,multiple:true,hideOnSelect:true,context:"TASKS_RIGHTS",searchOptions:{allowCreateItem:false},preload:true,preselectedItems:this.prepareDialogItems(this.preselectedItems),entities:[{id:"user",options:{inviteGuestLink:false,inviteEmployeeLink:false}},{id:"project"},{id:"department",options:{selectMode:"usersAndDepartments"}},{id:"meta-user",options:{"all-users":true}}],events:{"Item:onSelect":function(e){this.onSelectorItemSelected(e.getData().item)}.bind(this),"Item:onDeselect":function(e){this.onSelectorItemDeselected(e.getData().item)}.bind(this)}})}return this.dialog},prepareDialogItems:function(e){var t={U:"user",SG:"project",DR:"department",UA:"meta-user"};return e.map(function(e){var i=e.MEMBER_ID;var n=t[e.MEMBER_TYPE];if(n===t.DR&&i.toString()===this.optionP("mainDepartment").ID.toString()){i="all-users";n=t.UA}return[n,i]}.bind(this))},onSelectorItemSelected:function(e){e=this.prepareItemData(e);e=this.changeAllEmployeesToMainDepartment(e);var t={U:BX.message("path_user").replace("#user_id#",e.id),SG:BX.message("path_group").replace("#group_id#",e.id),DR:BX.message("path_department").replace("#ID#",e.id)};var i=e.entityType+e.id;if(!this.isItemAdded(i)){e.MEMBER_ID=e.id;e.MEMBER_TYPE=e.entityType;e.URL=t[e.entityType];delete e.id;this.addItem(e)}},onSelectorItemDeselected:function(e){e=this.prepareItemData(e);e=this.changeAllEmployeesToMainDepartment(e);var t=e.entityType+e.id;if(this.isItemAdded(t)){var i=Object.values(this.vars.items).find(function(e){var i=e.data();return t.toString()===i.MEMBER_TYPE.toString()+i.MEMBER_ID.toString()});if(i){this.callMethod(BX.Tasks.Util.ItemSet,"deleteItem",[i]);this.deleteFromAddedItems(t)}}},prepareItemData:function(e){var t=e.getCustomData();var i=e.getEntityType();var n={user:"U",project:"SG",department:"DR","meta-user":"UA"};return{avatar:e.getAvatar(),description:t.get("position"),email:t.get("email"),entityType:n[e.getEntityId()],id:e.getId(),lastName:t.get("lastName"),name:t.get("name"),nameFormatted:BX.Text.encode(e.getTitle()),networkId:"",type:{crmemail:false,extranet:i==="extranet",email:i==="email",network:i==="network"}}},changeAllEmployeesToMainDepartment:function(e){if(e.entityType==="UA"){var t=this.optionP("mainDepartment");e.id=t.ID;e.entityType="DR";e.nameFormatted=t.NAME}return e},isItemAdded:function(e){return this.parent().vars.addedItems.includes(e)},addItem:function(e){var t=e.MEMBER_TYPE.toString()+e.MEMBER_ID.toString();this.callMethod(BX.Tasks.Util.ItemSet,"addItem",arguments);this.addToAddedItems(t)},addToAddedItems:function(e){this.parent().vars.addedItems.push(e)},deleteItem:function(e){var t=e.data();var i=t.MEMBER_TYPE.toString()+t.MEMBER_ID.toString();this.callMethod(BX.Tasks.Util.ItemSet,"deleteItem",arguments);this.deleteFromAddedItems(i);this.deleteFromPreselected(i);this.deselectDialogItem({MEMBER_ID:t.MEMBER_ID,MEMBER_TYPE:t.MEMBER_TYPE})},deleteFromAddedItems:function(e){var t=this.parent().vars.addedItems.indexOf(e);this.parent().vars.addedItems.splice(t,1)},deleteFromPreselected:function(e){var t=this.preselectedItems.findIndex(function(t){return t.MEMBER_TYPE.toString()+t.MEMBER_ID.toString()===e});if(t!==-1){this.preselectedItems.splice(t,1)}},deselectDialogItem:function(e){if(this.dialog){var t=this.getDialog().getItem(this.prepareDialogItems([e])[0]);t&&t.deselect()}}}})}).call(this);
//# sourceMappingURL=logic.map.js