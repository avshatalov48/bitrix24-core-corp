(function(){"use strict";BX.namespace("BX.Tasks");BX.Tasks.QuickForm=function(t,e){var i=BX(t);if(!i){throw"BX.Tasks.QuickForm: wrong container id"}this.parameters=e||{};this.layout={container:i,button:BX(this.parameters.button),form:BX("task-new-item-form"),responsible:BX("task-new-item-responsible"),responsibleId:BX("task-new-item-responsible-id"),deadline:BX("task-new-item-deadline"),title:BX("task-new-item-title"),projectLink:BX("task-new-item-project-link"),projectClearing:BX("task-new-item-project-clearing"),projectId:BX("task-new-item-project-id"),descriptionBlock:BX("task-new-item-description-block"),descriptionLink:BX("task-new-item-description-link"),description:BX("task-new-item-description"),saveButton:BX("task-new-item-save"),cancelButton:BX("task-new-item-cancel")};this.gridId=BX.type.isNotEmptyString(this.parameters.gridId)?this.parameters.gridId:null;this.messages=this.parameters.messages||{};this.canManageTask=this.parameters.canManageTask!==false;this.canAddMailUsers=this.parameters.canAddMailUsers===true;if(this.canManageTask){BX.bind(this.layout.title,"keypress",BX.proxy(this.fireEnterKey,this));if(this.layout.button){BX.bind(this.layout.button,"click",BX.proxy(this.handleButtonClick,this))}BX.bind(this.layout.cancelButton,"click",BX.proxy(this.hide,this));BX.bind(this.layout.saveButton,"click",BX.proxy(this.submit,this));BX.bind(this.layout.descriptionLink,"click",BX.proxy(this.toggleDescription,this));BX.bind(this.layout.deadline,"click",BX.proxy(this.calendar,this));BX.bind(this.layout.deadline,"focus",BX.proxy(this.calendar,this))}else{this.disable()}this.query=new BX.Tasks.Util.Query({url:"/bitrix/components/bitrix/tasks.task.list/ajax.php"});this.query.bindEvent("executed",BX.proxy(this.onQueryExecuted,this));this.operation="taskQuickAdd";this.errorPopup=null;this.notification=new BX.Tasks.QuickForm.Notification(this);this.projectSelector=new BX.Tasks.QuickForm.ProjectSelector("task-new-item-project-selector",this);this.userSelector=new BX.Tasks.QuickForm.UserSelector("task-new-item-user-selector",this)};BX.Tasks.QuickForm.prototype.submit=function(){var t=this.layout.title.value;if(BX.util.trim(t).length===0){return false}var e={title:t,deadline:this.layout.deadline.value,description:this.layout.description.value,project:this.layout.projectId.value,pathToTask:this.parameters.pathToTask,siteId:BX.message("SITE_ID"),nameTemplate:this.parameters.nameTemplate,getListParams:this.parameters.getListParams,ganttMode:this.parameters.ganttMode};var i=this.userSelector.getUserId();var s=this.userSelector.getUserEmail();if(i>0){e.responsibleId=i}else if(this.canAddMailUsers&&s.length){e.userEmail=s;e.userName=this.userSelector.getUserName();e.userLastName=this.userSelector.getUserLastName()}this.disable();this.fadeGrid();this.query.deleteAll();this.query.add("ui.listcontrols.add",{data:e,parameters:{}},{code:this.operation});this.query.execute()};BX.Tasks.QuickForm.prototype.onQueryExecuted=function(result){if(!result.success){return this.showError(result.clientProcessErrors,result.serverProcessErrors)}else if(!result.data[this.operation]){return this.showError("Could not process this operation.")}else if(!result.data[this.operation].SUCCESS){return this.showError(result.data[this.operation].ERRORS)}var data=result.data[this.operation].RESULT;var taskId=data["taskId"];var found=data.position&&data.position.found===true;if(found){var grid=this.getGrid();if(grid){BX.onCustomEvent(window,"onTasksQuickFormExecuted",[data]);return grid.reloadTable("GET",{},this.applyChanges.bind(this,data,found))}else if(data.task){var task=null;try{eval("result = "+data.task);task=result}catch(t){}this.insertIntoGantt(task,data.position)}}BX.onCustomEvent(window,"onTasksQuickFormExecuted",[data]);this.applyChanges(data,found)};BX.Tasks.QuickForm.prototype.applyChanges=function(t,e){var i=t["taskRaw"]&&t["taskRaw"]["TITLE"]?t["taskRaw"]["TITLE"]:"";var s=t["taskPath"];this.notification.show(t["taskId"],i,s,e);this.highlight(t["taskId"],false);this.unfadeGrid();this.enable();this.clear();this.focus()};BX.Tasks.QuickForm.prototype.insertIntoGantt=function(t,e){if(!window.ganttChart||!t){return}BX.onCustomEvent("onTaskListTaskAdd",[t]);if(t.projectId&&!ganttChart.getProjectById(t.projectId)&&this.parameters.currentGroupId===0&&this.parameters.groupByProject===true){ganttChart.addProjectFromJSON({id:t.projectId,name:t.projectName,opened:true,canCreateTasks:t.projectCanCreateTasks,canEditTasks:t.projectCanEditTasks})}var i=ganttChart.addTaskFromJSON(t);if(i.parentTaskId){var s=ganttChart.getTaskById(i.parentTaskId);if(s){s.expand()}}var o=ganttChart.getTaskById(e.nextTaskId);var a=ganttChart.getTaskById(e.prevTaskId);if(o&&o.projectId===i.projectId){ganttChart.moveTask(i.id,o.id)}else if(a&&a.projectId===i.projectId){ganttChart.moveTask(i.id,a.id,true)}};BX.Tasks.QuickForm.prototype.getNextProject=function(t,e){var i=BX.findChildrenByClassName(t,"task-list-project-item");if(!e&&i.length){return i[0]}var s=null;for(var o=0;o<i.length;o++){if(parseInt(i[o].getAttribute("data-project-id"),10)>e){s=i[o];break}}return s};BX.Tasks.QuickForm.prototype.showError=function(){if(this.errorPopup===null){this.errorPopup=new BX.PopupWindow(this.operation,null,{lightShadow:true,buttons:[new BX.PopupWindowButton({text:BX.message("JS_CORE_WINDOW_CLOSE"),className:"",events:{click:BX.proxy(this.onPopupErrorClose,this)}})]})}var t=[];for(var e=0;e<arguments.length;e++){var i=arguments[e];if(BX.type.isArray(i)){t=BX.util.array_merge(t,i)}else if(BX.type.isString(i)){t.push(i)}}var s="";for(e=0;e<t.length;e++){s+=(typeof t[e].MESSAGE!=="undefined"?t[e].MESSAGE:t[e])+"<br>"}this.errorPopup.setContent("<div class='task-new-item-error-popup'>"+s+"</div>");this.errorPopup.show()};BX.Tasks.QuickForm.prototype.fadeGrid=function(){if(this.getGrid()){this.getGrid().tableFade()}};BX.Tasks.QuickForm.prototype.unfadeGrid=function(){if(this.getGrid()){this.getGrid().tableUnfade()}};BX.Tasks.QuickForm.prototype.onPopupErrorClose=function(){this.errorPopup.close();this.unfadeGrid();this.enable();this.clear();this.focus()};BX.Tasks.QuickForm.prototype.calendar=function(t){BX.PreventDefault(t);var e=this.layout.deadline;BX.calendar({node:e,field:e.name,bTime:true,bSetFocus:false,value:BX.CJSTask.ui.getInputDateTimeValue(e),bHideTimebar:false});BX.SocNetLogDestination.closeDialog()};BX.Tasks.QuickForm.prototype.show=function(){BX.addClass(this.layout.container,"task-top-panel-righttop-open");BX.addClass(this.layout.button,"tasks-quick-form-button-active");this.focus()};BX.Tasks.QuickForm.prototype.hide=function(){BX.removeClass(this.layout.container,"task-top-panel-righttop-open");BX.removeClass(this.layout.button,"tasks-quick-form-button-active");this.notification.hide();this.focus()};BX.Tasks.QuickForm.prototype.handleButtonClick=function(t){if(BX.hasClass(this.layout.container,"task-top-panel-righttop-open")){this.hide()}else{this.show()}};BX.Tasks.QuickForm.prototype.toggleDescription=function(t){BX.toggleClass(this.layout.descriptionBlock,"task-top-panel-leftmiddle-open");if(BX.hasClass(this.layout.descriptionBlock,"task-top-panel-leftmiddle-open")){this.layout.description.focus()}else{this.focus()}BX.PreventDefault(t)};BX.Tasks.QuickForm.prototype.fireEnterKey=function(t){t=t||window.event;if(t.keyCode===13){this.submit();BX.PreventDefault(t)}};BX.Tasks.QuickForm.prototype.getGrid=function(){if(this.gridId&&BX.Main&&BX.Main.gridManager&&BX.Tasks.GridInstance&&!BX.Tasks.GridInstance.checkCanMove()){return BX.Main.gridManager.getInstanceById(this.gridId)}return null};BX.Tasks.QuickForm.prototype.disable=function(){this.layout.title.disabled=true;this.layout.deadline.disabled=true;this.layout.responsible.disabled=true;this.layout.description.disabled=true;BX.addClass(this.layout.saveButton,"ui-btn-clock")};BX.Tasks.QuickForm.prototype.enable=function(){this.layout.title.disabled=false;this.layout.deadline.disabled=false;this.layout.responsible.disabled=false;this.layout.description.disabled=false;BX.removeClass(this.layout.saveButton,"ui-btn-clock")};BX.Tasks.QuickForm.prototype.clear=function(){this.layout.title.value="";this.layout.deadline.value="";this.layout.description.value=""};BX.Tasks.QuickForm.prototype.focus=function(){this.layout.title.focus()};BX.Tasks.QuickForm.prototype.highlight=function(t,e){if(window.ganttChart){var i=ganttChart.getTaskById(t);if(i){i.highlight();if(e===true){i.scrollIntoView(false)}}}else if(this.getGrid()){var s=this.getGrid().getRows().getById(t);if(s){var o=s.getNode();BX.addClass(o,"task-list-item-highlighted");setTimeout(function(){BX.removeClass(o,"task-list-item-highlighted")},1e3);if(e===true){o.scrollIntoView(false)}}}};BX.Tasks.QuickForm.Notification=function(t){this.form=t;this.taskId=0;this.layout={block:BX("task-new-item-notification"),message:BX("task-new-item-message"),openLink:BX("task-new-item-open"),highlightLink:BX("task-new-item-highlight"),hideLink:BX("task-new-item-notification-hide")};BX.bind(this.layout.hideLink,"click",BX.proxy(this.hide,this));BX.bind(this.layout.highlightLink,"click",BX.proxy(this.highlight,this))};BX.Tasks.QuickForm.Notification.prototype.show=function(t,e,i,s){this.taskId=t;this.layout.message.innerHTML=e;this.layout.openLink.href=i;if(s){this.layout.highlightLink.style.display="inline"}else{this.layout.highlightLink.style.display="none"}BX.addClass(this.layout.block,"task-top-notification-active")};BX.Tasks.QuickForm.Notification.prototype.hide=function(){BX.removeClass(this.layout.block,"task-top-notification-active")};BX.Tasks.QuickForm.Notification.prototype.highlight=function(){this.form.highlight(this.taskId,true)};BX.Tasks.QuickForm.ProjectSelector=function(t,e){this.id=t;this.form=e;this.projectName=this.form.layout.projectLink.innerHTML;this.projectId=parseInt(this.form.layout.projectId.value,10);var i=this.form.parameters.destination||{};BX.SocNetLogDestination.init({name:t,showSearchInput:true,sendAjaxSearch:typeof i["SONETGROUPS_LIMITED"]!="undefined"&&i["SONETGROUPS_LIMITED"]=="Y",useClientDatabase:false,allowUserSearch:false,allowSonetGroupsAjaxSearch:typeof i["SONETGROUPS_LIMITED"]!="undefined"&&i["SONETGROUPS_LIMITED"]=="Y",departmentSelectDisable:true,bindMainPopup:{node:this.form.layout.projectLink},bindSearchPopup:{node:this.form.layout.projectLink},callback:{select:BX.proxy(this.onSelect,this)},items:{users:{},groups:{},department:{},departmentRelation:{},projects:i["PROJECTS"]||{},sonetgroups:i["SONETGROUPS"]||{}},itemsLast:{users:{},groups:{},department:{},projects:i["LAST"]&&i["LAST"]["PROJECTS"]?i["LAST"]["PROJECTS"]:{},sonetgroups:i["LAST"]&&i["LAST"]["SONETGROUPS"]?i["LAST"]["SONETGROUPS"]:{}},itemsSelected:{}});BX.bind(this.form.layout.projectLink,"click",BX.proxy(this.openDialog,this));BX.bind(this.form.layout.projectClearing,"click",BX.proxy(this.clearProject,this))};BX.Tasks.QuickForm.ProjectSelector.prototype.openDialog=function(t){if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(this.id)}if(t){BX.PreventDefault(t)}};BX.Tasks.QuickForm.ProjectSelector.prototype.onSelect=function(t){this.projectId=parseInt(t.entityId,10);this.projectName=t.name;this.form.layout.projectId.value=this.projectId;this.form.layout.projectLink.innerHTML=this.projectName;BX.addClass(this.form.layout.projectClearing,"task-top-panel-tab-close-active");BX.SocNetLogDestination.deleteLastItem(this.id);BX.SocNetLogDestination.closeDialog()};BX.Tasks.QuickForm.ProjectSelector.prototype.clearProject=function(){this.form.layout.projectLink.innerHTML=this.form.messages.taskInProject;this.form.layout.projectId.value=0;this.projectId=0;this.projectName="";BX.removeClass(this.form.layout.projectClearing,"task-top-panel-tab-close-active");BX.SocNetLogDestination.closeDialog()};BX.Tasks.QuickForm.UserSelector=function(t,e){this.id=t;this.form=e;this.userId=this.form.layout.responsibleId.value;this.userNameFormatted=this.form.layout.responsible.value;this.userEmail="";this.userName="";this.userLastName="";var i=this.form.parameters.destination||{};BX.SocNetLogDestination.init({name:t,searchInput:this.form.layout.responsible,departmentSelectDisable:true,bindMainPopup:{node:this.form.layout.responsible},bindSearchPopup:{node:this.form.layout.responsible},allowAddUser:this.form.canAddMailUsers,callback:{select:BX.proxy(this.onSelect,this)},items:{users:i["USERS"]||{},department:i["DEPARTMENT"]||{},departmentRelation:i["DEPARTMENT_RELATION"]||{}},itemsLast:{users:i["LAST"]&&i["LAST"]["USERS"]?i["LAST"]["USERS"]:{}},itemsSelected:i["SELECTED"]||{}});BX.addCustomEvent("BX.SocNetLogDestination:onBeforeSelectItemFocus",BX.proxy(this.onBeforeSelectItemFocus,this));BX.bind(this.form.layout.responsible,"focus",BX.proxy(this.openDialog,this));BX.bind(this.form.layout.responsible,"click",BX.proxy(this.openDialog,this));BX.bind(this.form.layout.responsible,"blur",BX.proxy(this.onBlur,this));var s={formName:this.id,inputName:this.form.layout.responsible.getAttribute("id")};BX.bind(this.form.layout.responsible,"keyup",BX.proxy(BX.SocNetLogDestination.BXfpSearch,s));BX.bind(this.form.layout.responsible,"keydown",BX.proxy(BX.SocNetLogDestination.BXfpSearchBefore,s))};BX.Tasks.QuickForm.UserSelector.prototype.getUserId=function(){return this.userId};BX.Tasks.QuickForm.UserSelector.prototype.getUserEmail=function(){return this.userEmail};BX.Tasks.QuickForm.UserSelector.prototype.getUserName=function(){return this.userName};BX.Tasks.QuickForm.UserSelector.prototype.getUserLastName=function(){return this.userLastName};BX.Tasks.QuickForm.UserSelector.prototype.openDialog=function(t){BX.calendar.get().Close();BX.PreventDefault(t);this.form.layout.responsible.value="";if(!BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.openDialog(this.id)}};BX.Tasks.QuickForm.UserSelector.prototype.onBeforeSelectItemFocus=function(t){if(t.id===this.id){t.blockFocus=true}};BX.Tasks.QuickForm.UserSelector.prototype.onSelect=function(t,e,i){this.userId=t.entityId||0;this.userNameFormatted=BX.util.htmlspecialcharsback(t.name);var s=t.params||{};this.userEmail=s.email||"";this.userName=s.name||"";this.userLastName=s.lastName||"";this.form.layout.responsible.value=this.userNameFormatted;this.form.layout.responsibleId.value=this.userId;BX.SocNetLogDestination.deleteLastItem(this.id);BX.SocNetLogDestination.closeDialog()};BX.Tasks.QuickForm.UserSelector.prototype.onBlur=function(){setTimeout(BX.proxy(function(){if(!BX.SocNetLogDestination.isOpenDialog()&&!BX.SocNetLogDestination.isOpenSearch()&&this.form.layout.responsible.value.length<=0){this.form.layout.responsible.value=this.userNameFormatted;this.form.layout.responsibleId.value=this.userId}},this),100)}})();
//# sourceMappingURL=script.map.js