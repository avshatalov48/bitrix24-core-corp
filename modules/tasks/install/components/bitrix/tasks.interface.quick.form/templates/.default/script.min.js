(function(){"use strict";BX.namespace("BX.Tasks");BX.Tasks.QuickForm=function(t,e){var s=BX(t);if(!s){throw"BX.Tasks.QuickForm: wrong container id"}this.parameters=e||{};this.layout={container:s,button:BX(this.parameters.button),form:BX("task-new-item-form"),responsible:BX("task-new-item-responsible"),responsibleId:BX("task-new-item-responsible-id"),deadline:BX("task-new-item-deadline"),title:BX("task-new-item-title"),projectLink:BX("task-new-item-project-link"),projectClearing:BX("task-new-item-project-clearing"),projectId:BX("task-new-item-project-id"),descriptionBlock:BX("task-new-item-description-block"),descriptionLink:BX("task-new-item-description-link"),description:BX("task-new-item-description"),saveButton:BX("task-new-item-save"),cancelButton:BX("task-new-item-cancel")};this.gridId=BX.type.isNotEmptyString(this.parameters.gridId)?this.parameters.gridId:null;this.messages=this.parameters.messages||{};this.canManageTask=this.parameters.canManageTask!==false;this.canAddMailUsers=this.parameters.canAddMailUsers===true;this.personalContext=Boolean(this.parameters.personalContext);this.isProjectEnabled=Boolean(this.parameters.isProjectEnabled);this.projectFeatureId=BX.type.isNotEmptyString(this.parameters.projectFeatureId)?this.parameters.projectFeatureId:"";if(this.canManageTask){BX.bind(this.layout.title,"keypress",BX.proxy(this.fireEnterKey,this));if(this.layout.button){BX.bind(this.layout.button,"click",BX.proxy(this.handleButtonClick,this))}BX.bind(this.layout.cancelButton,"click",BX.proxy(this.hide,this));BX.bind(this.layout.saveButton,"click",BX.proxy(this.submit,this));BX.bind(this.layout.descriptionLink,"click",BX.proxy(this.toggleDescription,this));BX.bind(this.layout.deadline,"click",BX.proxy(this.calendar,this));BX.bind(this.layout.deadline,"focus",BX.proxy(this.calendar,this))}else{this.disable()}this.operation="taskQuickAdd";this.errorPopup=null;this.notification=new BX.Tasks.QuickForm.Notification(this);this.projectSelector=new BX.Tasks.QuickForm.ProjectSelector("task-new-item-project-selector",this);this.userSelector=new BX.Tasks.QuickForm.UserSelector("task-new-item-user-selector",this);this.calendarSettings=this.parameters.calendarSettings?this.parameters.calendarSettings:{}};BX.Tasks.QuickForm.prototype.submit=function(){const t=this.layout.title.value;if(BX.util.trim(t).length===0){return false}const e={title:t,deadline:this.layout.deadline.value,description:this.layout.description.value,project:this.layout.projectId.value,pathToTask:this.parameters.pathToTask,siteId:BX.message("SITE_ID"),nameTemplate:this.parameters.nameTemplate,getListParams:this.parameters.getListParams,ganttMode:this.parameters.ganttMode};const s=this.userSelector.getUserId();const i=this.userSelector.getUserEmail();if(s>0){e.responsibleId=s}else if(this.canAddMailUsers&&i.length){e.userEmail=i;e.userName=this.userSelector.getUserName();e.userLastName=this.userSelector.getUserLastName()}this.disable();this.fadeGrid();BX.ajax.runComponentAction("bitrix:tasks.interface.quick.form","addTask",{mode:"class",data:{data:e},analytics:{tool:"tasks",category:"task_operations",event:"task_create",type:"task",c_section:"tasks",c_element:"quick_button",c_sub_section:this.parameters?.ganttMode?"gantt":"list",status:"success"}}).then(function(t){this.onQueryExecuted(t)}.bind(this),function(t){return this.showError(t.errors[0]?.message?t.errors[0].message:"Could not process this operation.")}.bind(this))};BX.Tasks.QuickForm.prototype.onQueryExecuted=function(response){if(response.errors&&response.errors.length){return this.showError("Could not process this operation.")}void BX.ajax.runAction("tasks.analytics.hit",{analyticsLabel:{action:"taskAdding",source:"quickForm",scope:this.parameters.scope}});var data=response.data;var found=data.position&&data.position.found===true;if(found){var grid=this.getGrid();if(grid&&BX.Tasks.GridInstance&&!BX.Tasks.GridInstance.checkCanMove()){BX.onCustomEvent(window,"onTasksQuickFormExecuted",[data]);return grid.reloadTable("GET",{},this.applyChanges.bind(this,data,found))}else if(data.task){var result=null;var task=null;try{eval("result = "+data.task);task=result}catch(t){}this.insertIntoGantt(task,data.position)}}BX.onCustomEvent(window,"onTasksQuickFormExecuted",[data]);this.applyChanges(data,found)};BX.Tasks.QuickForm.prototype.applyChanges=function(t,e){var s=t["taskRaw"]&&t["taskRaw"]["TITLE"]?t["taskRaw"]["TITLE"]:"";var i=t["taskPath"];this.notification.show(t["taskId"],s,i,e);this.highlight(t["taskId"],false);this.unfadeGrid();this.enable();this.clear(t.currentUser);this.focus()};BX.Tasks.QuickForm.prototype.insertIntoGantt=function(t,e){if(!window.ganttChart||!t){return}BX.onCustomEvent("onTaskListTaskAdd",[t]);if(t.projectId&&!ganttChart.getProjectById(t.projectId)&&this.parameters.currentGroupId===0&&this.parameters.groupByProject===true){ganttChart.addProjectFromJSON({id:t.projectId,name:t.projectName,opened:true,canCreateTasks:t.projectCanCreateTasks,canEditTasks:t.projectCanEditTasks})}var s=ganttChart.addTaskFromJSON(t);if(s.parentTaskId){var i=ganttChart.getTaskById(s.parentTaskId);if(i){i.expand()}}var o=ganttChart.getTaskById(e.nextTaskId);var a=ganttChart.getTaskById(e.prevTaskId);if(o&&o.projectId===s.projectId){ganttChart.moveTask(s.id,o.id)}else if(a&&a.projectId===s.projectId){ganttChart.moveTask(s.id,a.id,true)}};BX.Tasks.QuickForm.prototype.getNextProject=function(t,e){var s=BX.findChildrenByClassName(t,"task-list-project-item");if(!e&&s.length){return s[0]}var i=null;for(var o=0;o<s.length;o++){if(parseInt(s[o].getAttribute("data-project-id"),10)>e){i=s[o];break}}return i};BX.Tasks.QuickForm.prototype.showError=function(){if(this.errorPopup===null){this.errorPopup=new BX.PopupWindow(this.operation,null,{lightShadow:true,buttons:[new BX.PopupWindowButton({text:BX.message("JS_CORE_WINDOW_CLOSE"),className:"",events:{click:BX.proxy(this.onPopupErrorClose,this)}})]})}var t=[];for(var e=0;e<arguments.length;e++){var s=arguments[e];if(BX.type.isArray(s)){t=BX.util.array_merge(t,s)}else if(BX.type.isString(s)){t.push(s)}}var i="";for(e=0;e<t.length;e++){i+=(typeof t[e].MESSAGE!=="undefined"?t[e].MESSAGE:t[e])+"<br>"}this.errorPopup.setContent("<div class='task-new-item-error-popup'>"+i+"</div>");this.errorPopup.show()};BX.Tasks.QuickForm.prototype.fadeGrid=function(){if(this.getGrid()&&BX.Tasks.GridInstance&&!BX.Tasks.GridInstance.checkCanMove()){this.getGrid().tableFade()}};BX.Tasks.QuickForm.prototype.unfadeGrid=function(){if(this.getGrid()&&BX.Tasks.GridInstance&&!BX.Tasks.GridInstance.checkCanMove()){this.getGrid().tableUnfade()}};BX.Tasks.QuickForm.prototype.onPopupErrorClose=function(){this.errorPopup.close();this.unfadeGrid();this.enable();this.clear();this.focus()};BX.Tasks.QuickForm.prototype.calendar=function(t){BX.PreventDefault(t);var e=this.layout.deadline;BX.calendar({node:e,field:e.name,bTime:true,bSetFocus:false,bCompatibility:true,bCategoryTimeVisibilityOption:"tasks.bx.calendar.deadline",bTimeVisibility:this.calendarSettings?this.calendarSettings.deadlineTimeVisibility==="Y":false,value:BX.CJSTask.ui.getInputDateTimeValue(e),bHideTimebar:false})};BX.Tasks.QuickForm.prototype.show=function(){BX.addClass(this.layout.container,"task-top-panel-righttop-open");BX.addClass(this.layout.button,"tasks-quick-form-button-active");this.focus()};BX.Tasks.QuickForm.prototype.hide=function(){BX.removeClass(this.layout.container,"task-top-panel-righttop-open");BX.removeClass(this.layout.button,"tasks-quick-form-button-active");this.notification.hide();this.focus()};BX.Tasks.QuickForm.prototype.handleButtonClick=function(t){if(BX.hasClass(this.layout.container,"task-top-panel-righttop-open")){this.hide()}else{this.show()}};BX.Tasks.QuickForm.prototype.toggleDescription=function(t){BX.toggleClass(this.layout.descriptionBlock,"task-top-panel-leftmiddle-open");if(BX.hasClass(this.layout.descriptionBlock,"task-top-panel-leftmiddle-open")){this.layout.description.focus()}else{this.focus()}BX.PreventDefault(t)};BX.Tasks.QuickForm.prototype.fireEnterKey=function(t){t=t||window.event;if(t.keyCode===13){this.submit();BX.PreventDefault(t)}};BX.Tasks.QuickForm.prototype.getGrid=function(){if(this.gridId&&BX.Main&&BX.Main.gridManager){return BX.Main.gridManager.getInstanceById(this.gridId)}return null};BX.Tasks.QuickForm.prototype.disable=function(){this.layout.title.disabled=true;this.layout.deadline.disabled=true;this.layout.responsible.disabled=true;this.layout.description.disabled=true;BX.addClass(this.layout.saveButton,"ui-btn-clock")};BX.Tasks.QuickForm.prototype.enable=function(){this.layout.title.disabled=false;this.layout.deadline.disabled=false;this.layout.responsible.disabled=false;this.layout.description.disabled=false;BX.removeClass(this.layout.saveButton,"ui-btn-clock")};BX.Tasks.QuickForm.prototype.clear=function(t){this.layout.title.value="";this.layout.deadline.value="";this.layout.description.value="";this.personalContext&&this.projectSelector.clearProject();this.userSelector.setCurrentUser(t)};BX.Tasks.QuickForm.prototype.focus=function(){this.layout.title.focus()};BX.Tasks.QuickForm.prototype.highlight=function(t,e){if(window.ganttChart){var s=ganttChart.getTaskById(t);if(s){s.highlight();if(e===true){s.scrollIntoView(false)}}}else if(this.getGrid()){var i=this.getGrid().getRows().getById(t);if(i){var o=i.getNode();BX.addClass(o,"task-list-item-highlighted");setTimeout((function(){BX.removeClass(o,"task-list-item-highlighted")}),1e3);if(e===true){o.scrollIntoView(false)}}}};BX.Tasks.QuickForm.Notification=function(t){this.form=t;this.taskId=0;this.layout={block:BX("task-new-item-notification"),message:BX("task-new-item-message"),openLink:BX("task-new-item-open"),highlightLink:BX("task-new-item-highlight"),hideLink:BX("task-new-item-notification-hide")};BX.bind(this.layout.hideLink,"click",BX.proxy(this.hide,this));BX.bind(this.layout.highlightLink,"click",BX.proxy(this.highlight,this))};BX.Tasks.QuickForm.Notification.prototype.show=function(t,e,s,i){this.taskId=t;this.layout.message.innerHTML=e;this.layout.openLink.href=s;if(i){this.layout.highlightLink.style.display="inline"}else{this.layout.highlightLink.style.display="none"}BX.addClass(this.layout.block,"task-top-notification-active")};BX.Tasks.QuickForm.Notification.prototype.hide=function(){BX.removeClass(this.layout.block,"task-top-notification-active")};BX.Tasks.QuickForm.Notification.prototype.highlight=function(){this.form.highlight(this.taskId,true)};BX.Tasks.QuickForm.ProjectSelector=function(t,e){this.id=t;this.form=e;this.projectName=this.form.layout.projectLink.innerHTML;this.projectId=parseInt(this.form.layout.projectId.value,10);this.isProjectEnabled=Boolean(this.form.isProjectEnabled);this.projectFeatureId=BX.type.isNotEmptyString(this.form.projectFeatureId)?this.form.projectFeatureId:"";BX.bind(this.form.layout.projectLink,"click",BX.proxy(this.openDialog,this));BX.bind(this.form.layout.projectClearing,"click",BX.proxy(this.clearProject,this));this.projectDialog=new BX.UI.EntitySelector.Dialog({targetNode:this.form.layout.projectLink,enableSearch:true,multiple:false,context:"TASKS_QUICK_FORM_PROJECT",entities:[{id:"project"}],events:{"Item:onSelect":function(t){var e=t.getData().item;this.onSelect(e)}.bind(this),"Item:onDeselect":function(t){this.clearProject()}.bind(this)}})};BX.Tasks.QuickForm.ProjectSelector.prototype.openDialog=function(t){if(this.isProjectEnabled){this.projectDialog.show()}else{this.showProjectLimit()}if(t){BX.PreventDefault(t)}};BX.Tasks.QuickForm.ProjectSelector.prototype.showProjectLimit=function(){BX.Runtime.loadExtension("tasks.limit").then((t=>{const{Limit:e}=t;e.showInstance({featureId:this.projectFeatureId,limitAnalyticsLabels:{module:"tasks",source:"quickForm"}})}))};BX.Tasks.QuickForm.ProjectSelector.prototype.onSelect=function(t){this.projectId=t.getId();this.projectName=t.getTitle();this.form.layout.projectId.value=this.projectId;this.form.layout.projectLink.textContent=this.projectName;BX.addClass(this.form.layout.projectClearing,"task-top-panel-tab-close-active")};BX.Tasks.QuickForm.ProjectSelector.prototype.clearProject=function(){this.form.layout.projectLink.innerHTML=this.form.messages.taskInProject;this.form.layout.projectId.value=0;this.projectId=0;this.projectName="";BX.removeClass(this.form.layout.projectClearing,"task-top-panel-tab-close-active");this.projectDialog.deselectAll();this.projectDialog.hide()};BX.Tasks.QuickForm.UserSelector=function(t,e){this.id=t;this.form=e;this.userId=this.form.layout.responsibleId.value;this.userNameFormatted=this.form.layout.responsible.value;this.userEmail="";this.userName="";this.userLastName="";BX.bind(this.form.layout.responsible,"click",BX.proxy(this.openDialog,this));BX.bind(this.form.layout.responsible,"keyup",(function(t){BX.PreventDefault(t)}));BX.bind(this.form.layout.responsible,"keydown",(function(t){BX.PreventDefault(t)}))};BX.Tasks.QuickForm.UserSelector.prototype.getUserId=function(){return this.userId};BX.Tasks.QuickForm.UserSelector.prototype.getUserEmail=function(){return this.userEmail};BX.Tasks.QuickForm.UserSelector.prototype.getUserName=function(){return this.userName};BX.Tasks.QuickForm.UserSelector.prototype.getUserLastName=function(){return this.userLastName};BX.Tasks.QuickForm.UserSelector.prototype.openDialog=function(t){BX.calendar.get().Close();BX.PreventDefault(t);this.initDialog();this.userDialog.show()};BX.Tasks.QuickForm.UserSelector.prototype.initDialog=function(){if(this.userDialog){return}this.userDialog=new BX.UI.EntitySelector.Dialog({targetNode:this.form.layout.responsible,enableSearch:true,multiple:false,context:"TASKS_QUICK_FORM_RESPONSIBLE",preselectedItems:[["user",this.userId]],entities:[{id:"user",options:{emailUsers:true,networkUsers:this.form.parameters.networkEnabled,extranetUsers:true,inviteGuestLink:true,myEmailUsers:true,analyticsSource:"tasks"}},{id:"department"}],events:{"Item:onSelect":function(t){var e=t.getData().item;this.onSelect(e)}.bind(this),"Item:onDeselect":function(t){this.form.layout.responsible.value=""}.bind(this)}})};BX.Tasks.QuickForm.UserSelector.prototype.onBeforeSelectItemFocus=function(t){if(t.id===this.id){t.blockFocus=true}};BX.Tasks.QuickForm.UserSelector.prototype.onSelect=function(t,e,s){this.userId=t.getId();this.userNameFormatted=BX.util.htmlspecialcharsback(t.getTitle());var i=t.getCustomData();this.userEmail=i.get("email");this.userName=i.get("name");this.userLastName=i.get("lastName");this.form.layout.responsible.value=this.userNameFormatted;this.form.layout.responsibleId.value=this.userId;this.userDialog.hide()};BX.Tasks.QuickForm.UserSelector.prototype.setCurrentUser=function(t){if(!t){return}this.userId=t.id;this.userNameFormatted=t.fullName;this.form.layout.responsible.value=this.userNameFormatted;this.form.layout.responsibleId.value=this.userId;if(!this.userDialog){return}var e=this.userDialog.getItem({id:this.userId,entityId:"user"});e&&e.select();this.userDialog.hide()}})();
//# sourceMappingURL=script.map.js