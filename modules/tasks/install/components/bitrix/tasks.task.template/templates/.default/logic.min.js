"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksTaskTemplate!="undefined"){return}BX.Tasks.Component.TasksTaskTemplate=BX.Tasks.Component.extend({sys:{code:"task-template-edit"},methods:{bindEvents:function(){if(this.option("isNewUserResponsible")){this.vars.prevResponsibles=[this.option("currentUser")]}this.vars.parentType=!parseInt(this.option("template").BASE_TEMPLATE_ID)&&parseInt(this.option("template").PARENT_ID)?"task":"template";this.vars.currentLock=false;this.bindDelegateControl("flag","click",this.passCtx(this.onToggleFlag));this.bindDelegateControl("pin-footer","click",BX.delegate(this.onPinFooterClick,this));this.bindControl("form","submit",BX.delegate(this.onForumSubmit,this));BX.Tasks.Util.hintManager.bindHelp(this.scope());this.bindNestedControls();BX.addCustomEvent("TaskAjaxError",function(t){BX.Tasks.alert(t)})},toggleReplicationLock:function(t){var e=this.control("flag-replication");if(t){BX.Tasks.Util.disable(e);if(this.isFlagEnabled(e)){this.onToggleFlag(e);e.checked=false}}else{BX.Tasks.Util.enable(e)}BX.data(this.control("hint-replication"),"hint-enabled",t)},toggleBaseTemplateLock:function(t){var e=this.control("hint-base-template");if(t){this.onParentTypeClick(this.control("parent-type-option-task"));BX.addClass(e,"disabled")}else{BX.removeClass(e,"disabled")}BX.data(e,"hint-enabled",t)},switchOption:function(t,e){BX.Tasks.Util.Dispatcher.find(this.id()+"-options").then(function(i){i.switchOption(t,e)}.bind(this))},toggleTypeNewLock:function(t){if(!t&&this.isEditMode()){return}this.switchOption("TPARAM_TYPE",!t)},solveFieldOpLock:function(t,e){if(this.vars.currentLock!=false&&this.vars.currentLock!=t){return}var i=function(){this.toggleReplicationLock(false);this.toggleBaseTemplateLock(false);this.toggleTypeNewLock(false);this.vars.currentLock=false}.bind(this);if(t=="TPARAM_TYPE"){if(e==1){this.toggleReplicationLock(true);this.toggleBaseTemplateLock(true);this.vars.currentLock=t}else{i()}}else if(t=="REPLICATE"){if(e){this.toggleTypeNewLock(true);this.toggleBaseTemplateLock(true);this.vars.currentLock=t}else{i()}}else if(t=="BASE_TEMPLATE_ID"){if(e){this.toggleReplicationLock(true);this.toggleTypeNewLock(true);this.vars.currentLock=t}else{i()}}},processEditorInit:function(){if(!this.isEditMode()){BX.ready(BX.delegate(function(){var t=BX.delegate(this.onFormKeyDown,this);BX.bind(document,"keydown",t);var e=this.option("id");var i=BXHtmlEditor.Get(e);if(i){this.bindEditorEvents(i,t);this.setFocusOnTitle(i,t)}else{BX.addCustomEvent(window,"OnEditorInitedAfter",BX.delegate(function(s){if(s!=null&&s.id==e){this.bindEditorEvents(s,t);this.setFocusOnTitle(i,t)}},this))}},this))}},bindEditorEvents:function(t,e){BX.addCustomEvent(t,"OnIframeKeyup",e);BX.addCustomEvent(t,"OnTextareaKeyup",e)},bindNestedControls:function(){BX.Tasks.Util.Dispatcher.bindEvent(this.id()+"-frame","block-toggle",this.onFrameBlockToggle.bind(this));BX.Tasks.Util.Dispatcher.bindEvent(this.id()+"-responsible","change",this.onResponsibleChange.bind(this));BX.Tasks.Util.Dispatcher.bindEvent(this.id()+"-options","toggle",this.processToggleFlag.bind(this));this.bindDelegateControl("parent-type-option","click",this.passCtx(this.onParentTypeClick));this.getInstanceDispatcher("parent").then(function(t){this.subInstance("parent",t);t.bindEvent("change",this.onParentChange.bind(this))}.bind(this));this.getDeadline();this.getStartDate().bindEvent("change",function(t){this.updateEndDatePlan(t,this.getDuration().getValue())}.bind(this));this.getDuration().bindEvent("change",function(t){this.updateEndDatePlan(this.getStartDate().getValue(),t)}.bind(this))},onFrameBlockToggle:function(t,e){if(e&&t=="se_checklist"){BX.Tasks.Util.Dispatcher.find(this.id()+"-checklist").then(function(t){if(!t.count()){t.openForm()}}.bind(this))}},onResponsibleChange:function(){BX.Tasks.Util.Dispatcher.find(this.id()+"-responsible").then(function(t){if(t.count()>1){BX.Tasks.Util.hintManager.showDisposable(t.scope(),BX.message("TASKS_TASK_TEMPLATE_COMPONENT_TEMPLATE_MULTIPLE_RESPONSIBLE_NOTICE"),"TASK_EDIT_MULTIPLE_RESPONSIBLES")}else{BX.Tasks.Util.hintManager.hide("TASK_EDIT_MULTIPLE_RESPONSIBLES")}}.bind(this))},setFocusOnTitle:function(t){setTimeout(function(){var e=this.control("title");if(e){t.Focus(false);e.focus();e.selectionStart=e.value.length;BX.focus()}}.bind(this),500)},isFlagEnabled:function(t){return t.checked},onToggleFlag:function(t){var e=BX.data(t,"target");if(typeof e!="undefined"&&BX.type.isNotEmptyString(e)){var i=this.control(e);var s=BX.data(t,"flag-name");var n=BX.data(t,"yes-value")||"Y";var a=BX.data(t,"no-value")||"N";if(BX.type.isElementNode(i)){i.value=t.checked?n:a}this.processToggleFlag(s,i.value==n)}},processToggleFlag:function(t,e){if(t=="REPLICATE"){var i=this.control("replication-panel");if(e){BX.Tasks.Util.fadeSlideToggleByClass(i)}else{BX.Tasks.Util.fadeSlideToggleByClass(i)}this.solveFieldOpLock("REPLICATE",e)}else if(t=="ALLOW_TIME_TRACKING"){BX.Tasks.Util.fadeToggleByClass(this.control("timeman-estimate-time"),200)}else if(t=="TPARAM_TYPE"){BX.Tasks.Util.Dispatcher.find(this.id()+"-responsible").then(function(t){if(e){this.vars.prevResponsibles=t.export();t.replaceAll([{ID:0,NAME:BX.message("TASKS_COMMON_NEW_USER"),entityType:"U",URL:"javascript:void(0);"}]);t.readOnly(true)}else{t.replaceAll(this.vars.prevResponsibles);this.vars.prevResponsibles=null;t.readOnly(false)}}.bind(this));this.solveFieldOpLock("TPARAM_TYPE",e)}else if(t==="MATCH_WORK_TIME"){Object.keys(this.instances).forEach(function(t){if(t==="deadline"||t==="start-date"||t==="duration"){var e=this.instances[t];e.updateRealValue(e.getDisplayValue(),e.vars.unit)}},this)}},isEditMode:function(){return this.option("template").ID>0},getDeadline:function(){return this.subInstance("deadline",function(){return new BX.Tasks.Component.TasksTaskTemplate.DurationPicker({scope:this.control("deadline"),unit:this.option("deadline").UNIT,displayValue:this.option("deadline").VALUE,companyWorkTime:this.option("auxData").COMPANY_WORKTIME})})},getStartDate:function(){return this.subInstance("start-date",function(){return new BX.Tasks.Component.TasksTaskTemplate.DurationPicker({scope:this.control("start-date"),unit:this.option("startDate").UNIT,displayValue:this.option("startDate").VALUE,companyWorkTime:this.option("auxData").COMPANY_WORKTIME})})},getDuration:function(){return this.subInstance("duration",function(){return new BX.Tasks.Component.TasksTaskTemplate.DurationPicker({scope:this.control("duration"),unit:this.option("duration").UNIT,displayValue:this.option("duration").VALUE,companyWorkTime:this.option("auxData").COMPANY_WORKTIME})})},updateEndDatePlan:function(t,e){this.control("end-date-input").value=t+e},onForumSubmit:function(t){t=t||window.event;if(this.vars.submitting){BX.PreventDefault(t);return}var e=this.control("csrf");if(e){e.value=BX.bitrix_sessid()}BX.Tasks.Util.Dispatcher.call(this.id()+"-frame","showLoader");this.vars.submitting=true},onParentChange:function(t){var e=this.control("parent-type-task");var i=this.control("parent-type-template");var s=this.subInstance("parent");var n="";if(t.length){n=s.getIdByValue(t[0])}if(this.vars.parentType=="task"){i.value="";e.value=t.length?n:""}else if(this.vars.parentType=="template"){i.value=t.length?n:"";e.value="";this.solveFieldOpLock("BASE_TEMPLATE_ID",!!i.value)}},onParentTypeClick:function(t){var e=BX.data(t,"type");if(BX.hasClass(t,"disabled")){return}this.setCSSMode("type",e,this.control("parent-type"));this.vars.parentType=e;this.getInstanceDispatcher("parent").then(function(t){t.setTypes(e=="task"?{TASK:true}:{TEMPLATE:true})}.bind(this));this.control("parent-type-task").value="";this.control("parent-type-template").value=""},getInstanceDispatcher:function(t){return BX.Tasks.Util.Dispatcher.find(this.id()+"-"+t)}}});BX.Tasks.Component.TasksTaskTemplate.DurationPicker=BX.Tasks.Util.Widget.extend({sys:{code:"dateplanmanager"},options:{controlBind:"class",unit:"mins",displayValue:0,companyWorkTime:false},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);this.bindDelegateControl("unit-setter","click",this.passCtx(this.onUnitChange));if(typeof this.instances==="undefined"){this.instances={}}this.instances.calendar=false;this.vars.unit=this.option("unit");this.vars.displayValue=this.option("displayValue");this.vars.companyWorkTime=this.option("companyWorkTime");this.vars.realValue=this.calculateRealValue(this.getDisplayValue(),this.getUnit());this.bindDelegateControl("display","keypress",this.onDisplayKeydown.bind(this));this.bindDelegateControl("display","input",this.onDisplayInput.bind(this));this.bindDelegateControl("display","bxchange",this.onDisplayChange.bind(this))},onUnitChange:function(t){var e=BX.data(t,"unit");if(e){this.setCSSMode("mode-unit-selected",e);this.vars.unit=e;this.updateRealValue(this.getDisplayValue(),e)}},updateRealValue:function(t,e){t=this.calculateRealValue(t,e);var i=this.control("value");if(i){i.value=t}this.vars.realValue=t;this.fireEvent("change",[t])},calculateRealValue:function(t,e){t=parseInt(t);if(isNaN(t)){t=0}if(e=="days"){return t*(this.getMatchWorkTime()?this.getWorkDayDuration():86400)}else if(e=="hours"){return t*3600}else{return t*60}},getCalendar:function(){if(this.instances.calendar===false){this.instances.calendar=new BX.Tasks.Calendar(BX.Tasks.Calendar.adaptSettings(this.vars.companyWorkTime))}return this.instances.calendar},getWorkDayDuration:function(){var t=this.getCalendar().getWorkDayDuration();return t>0?t/1e3:86400},getMatchWorkTime:function(){var t=document.getElementsByClassName("js-id-wg-optbar-flag-match-work-time");if(t.length){return t[0].checked}return false},getDisplayValue:function(){return this.vars.displayValue},getValue:function(){return this.vars.realValue},getUnit:function(){return this.vars.unit},onDisplayChange:function(t){t=t||window.event;var e=t.target;if(e.value!=this.vars.displayValue){this.updateRealValue(e.value,this.getUnit());this.vars.displayValue=e.value}},onDisplayKeydown:function(t){t=t||window.event;var e=t.which||t.keyCode;if(event.charCode&&(e<48||e>57)){event.preventDefault()}},onDisplayInput:function(t){t=t||window.event;var e=t.target;e.value=e.value.toString().replace(/[^\d]+/,"")}}})}).call(this);