"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksTaskTemplate!="undefined"){return}BX.Tasks.Component.TasksTaskTemplate=BX.Tasks.Component.extend({sys:{code:"task-template-view"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);this.initFileView();this.checkListChanged=false;this.showCloseConfirmation=false;this.analyticsData={}},bindEvents:function(){BX.Tasks.Util.Dispatcher.bindEvent(this.id()+"-buttons","button-click",this.onButtonClick.bind(this));if(this.option("can").edit){BX.addCustomEvent("onTaskTagSelect",BX.proxy(this.syncTags,this));this.bindControl("importance-switch","click",BX.Tasks.passCtx(this.onImportantButtonClick,this))}BX.bind(BX("saveButton"),"click",this.onSaveButtonClick.bind(this));BX.bind(BX("cancelButton"),"click",this.onCancelButtonClick.bind(this));BX.bind(BX("templateViewPopupMenuOptions"),"click",this.createTemplateMenu.bind(this));BX.bind(BX("subTemplateAdd"),"click",this.onSubTemplateAddClick.bind(this));BX.addCustomEvent("TaskAjaxError",(function(t){BX.Tasks.alert(t).then((function(){BX.reload()}))}));BX.addCustomEvent("SidePanel.Slider:onClose",this.onSliderClose.bind(this));BX.Event.EventEmitter.subscribe("BX.Tasks.CheckListItem:CheckListChanged",function(t){var e=t.data.action;var s=["addAccomplice","fileUpload","tabIn"];if(BX.util.in_array(e,s)){this.analyticsData[e]="Y"}this.toggleFooterWrap(true)}.bind(this))},onSliderClose:function(t){if(!this.checkListChanged||typeof BX.Tasks.CheckListInstance==="undefined"){return}var e=BX.Tasks.CheckListInstance.optionManager.slider;if(!e||e!==t.getSlider()){return}if(!this.showCloseConfirmation){this.showCloseConfirmation=true;return}t.denyAction();this.showChecklistCloseSliderPopup(e)},showChecklistCloseSliderPopup:function(t){if(!this.checklistCloseSliderPopup){this.checklistCloseSliderPopup=new BX.PopupWindow({titleBar:BX.message("TASKS_TTV_CLOSE_SLIDER_CONFIRMATION_POPUP_HEADER"),content:BX.message("TASKS_TTV_CLOSE_SLIDER_CONFIRMATION_POPUP_CONTENT"),closeIcon:false,buttons:[new BX.PopupWindowButton({text:BX.message("TASKS_TTV_CLOSE_SLIDER_CONFIRMATION_POPUP_BUTTON_CLOSE"),className:"popup-window-button-accept",events:{click:function(){this.showCloseConfirmation=false;this.checklistCloseSliderPopup.close();t.close()}.bind(this)}}),new BX.PopupWindowButton({className:"popup-window-button popup-window-button-link",text:BX.message("TASKS_TTV_CLOSE_SLIDER_CONFIRMATION_POPUP_BUTTON_CANCEL"),events:{click:function(){this.checklistCloseSliderPopup.close()}.bind(this)}})]})}this.checklistCloseSliderPopup.show()},onImportantButtonClick:function(t){var e=this.option("data").PRIORITY;var s=e==2?1:2;BX.ajax.runComponentAction("bitrix:tasks.task.template","setPriority",{mode:"class",data:{templateId:this.option("data").ID,priority:s}}).then(function(e){if(!e.status||e.status!=="success"){this.isSaving=false;return}this.option("can").PRIORITY=s;BX.toggleClass(t,"no")}.bind(this),function(t){}.bind(this))},syncTags:function(t){t=t||[];if(t.length){var e=[];BX.Tasks.each(t,(function(t){e.push({NAME:t.name})}));t=e}BX.ajax.runComponentAction("bitrix:tasks.task.template","setTags",{mode:"class",data:{templateId:this.option("data").ID,tags:t}}).then(function(t){}.bind(this),function(t){}.bind(this))},onButtonClick:function(t){if(t==="DELETE"){BX.ajax.runComponentAction("bitrix:tasks.task.template","delete",{mode:"class",data:{templateId:this.option("data").ID}}).then(function(t){if(!t.status||t.status!=="success"){return}BX.UI.Notification.Center.notify({content:BX.message("TASKS_NOTIFY_TASK_DELETED")});window.location=this.option("backUrl")}.bind(this),function(t){}.bind(this))}},initFileView:function(){if(!this.option("publicMode")){BX.Tasks.each(this.controlAll("file-area"),(function(t){top.BX.viewElementBind(t,{},(function(t){return BX.type.isElementNode(t)&&(t.getAttribute("data-bx-viewer")||t.getAttribute("data-bx-image"))}))}))}},onSaveButtonClick:function(){if(this.isSaving){return}this.isSaving=true;BX.Tasks.CheckListInstance.activateLoading();this.saveCheckList()},onSubTemplateAddClick:function(t){if(this.option("auxData").TASK_LIMIT_EXCEEDED||this.option("auxData").TEMPLATE_SUBTASK_LIMIT_EXCEEDED){t.preventDefault();BX.UI.InfoHelper.show("limit_tasks_templates_subtasks",{isLimit:true,limitAnalyticsLabels:{module:"tasks",source:"templateView"}})}},saveCheckList:function(){var t=this;var e=BX.Tasks.CheckListInstance.getTreeStructure();BX.ajax.runComponentAction("bitrix:tasks.task.template","saveChecklist",{mode:"class",data:{templateId:this.option("data").ID,items:e.getRequestData(),params:{analyticsData:Object.assign(this.analyticsData,{checklistCount:e.getDescendantsCount()})}}}).then(function(e){if(!e.status||e.status!=="success"){this.isSaving=false;return}var s=BX.Tasks.CheckListInstance.getTreeStructure();var i=e.data.TRAVERSED_ITEMS;if(i){Object.keys(i).forEach((function(t){var e=s.findChild(t);if(e!=="undefined"&&e.fields.getId()===null){e.fields.setId(i[t].ID)}}))}BX.Tasks.CheckListInstance.saveStableTreeStructure();BX.Tasks.CheckListInstance.deactivateLoading();this.analyticsData={};t.toggleFooterWrap(false);this.isSaving=false}.bind(this),function(t){this.isSaving=false}.bind(this))},onCancelButtonClick:function(){if(this.isSaving){return}var t=this;var e=new BX.PopupWindow({titleBar:BX.message("TASKS_TTV_DISABLE_CHANGES_CONFIRMATION_POPUP_HEADER"),content:BX.message("TASKS_TTV_DISABLE_CHANGES_CONFIRMATION_POPUP_CONTENT"),closeIcon:false,buttons:[new BX.PopupWindowButton({text:BX.message("TASKS_TTV_DISABLE_CHANGES_CONFIRMATION_POPUP_BUTTON_YES"),className:"popup-window-button-accept",events:{click:function(){e.close();if(BX.Tasks.CheckListInstance!=="undefined"){BX.Tasks.CheckListInstance.rerender()}t.toggleFooterWrap(false)}}}),new BX.PopupWindowButton({className:"popup-window-button popup-window-button-link",text:BX.message("TASKS_TTV_DISABLE_CHANGES_CONFIRMATION_POPUP_BUTTON_NO"),events:{click:function(){e.close()}}})],events:{onPopupClose:function(){this.destroy()}}});e.show()},toggleFooterWrap:function(t){var e=BX("footerWrap");var s=BX("saveButton");var i="ui-btn-wait";var n="task-footer-wrap-active";if(t){if(!BX.hasClass(e,n)){BX.addClass(e,n)}this.checkListChanged=true;this.showCloseConfirmation=true}else{if(BX.hasClass(e,n)){BX.removeClass(e,n)}BX.removeClass(s,i);this.checkListChanged=false;this.showCloseConfirmation=false}},createTemplateMenu:function(){var t=[{delimiter:true,text:BX.message("TASKS_TEMPLATE_POPUP_MENU_CHECKLIST_SECTION")}];t.push({tabId:"showCompleted",text:BX.message("TASKS_TEMPLATE_POPUP_MENU_SHOW_COMPLETED"),className:"menu-popup-item-accept",onclick:function(t,e){e.getMenuWindow().close();if(typeof BX.Tasks.CheckListInstance!=="undefined"){BX.toggleClass(e.layout.item,"menu-popup-item-accept");var s=BX.Tasks.CheckListInstance.getTreeStructure();var i=s.optionManager;i.setShowCompleted(!i.getShowCompleted());s.handleTaskOptions()}}});t.push({tabId:"showOnlyMine",text:BX.message("TASKS_TEMPLATE_POPUP_MENU_SHOW_ONLY_MINE"),className:"manu-popup-item",onclick:function(t,e){e.getMenuWindow().close();if(typeof BX.Tasks.CheckListInstance!=="undefined"){BX.toggleClass(e.layout.item,"menu-popup-item-accept");var s=BX.Tasks.CheckListInstance.getTreeStructure();var i=s.optionManager;i.setShowOnlyMine(!i.getShowOnlyMine());s.handleTaskOptions()}}});var e=BX.PopupMenu.create("templatePopupMenuOptions",BX("templateViewPopupMenuOptions"),t,{closeByEsc:true,offsetLeft:BX("templateViewPopupMenuOptions").getBoundingClientRect().width/2,angle:true});e.popupWindow.show()}}})}).call(this);
//# sourceMappingURL=logic.map.js