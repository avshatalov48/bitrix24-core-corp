"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksTaskTemplate!="undefined"){return}BX.Tasks.Component.TasksTaskTemplate=BX.Tasks.Component.extend({sys:{code:"task-template-view"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);this.initFileView();this.query=new BX.Tasks.Util.Query({url:"/bitrix/components/bitrix/tasks.task.template/ajax.php"});this.checkListChanged=false;this.showCloseConfirmation=false;this.analyticsData={}},bindEvents:function(){var t=this;BX.Tasks.Util.Dispatcher.bindEvent(this.id()+"-buttons","button-click",this.onButtonClick.bind(this));if(this.option("can").edit){BX.addCustomEvent("onTaskTagSelect",BX.proxy(this.syncTags,this));this.bindControl("importance-switch","click",BX.Tasks.passCtx(this.onImportantButtonClick,this))}BX.bind(BX("saveButton"),"click",this.onSaveButtonClick.bind(this));BX.bind(BX("cancelButton"),"click",this.onCancelButtonClick.bind(this));BX.bind(BX("templateViewPopupMenuOptions"),"click",this.createTemplateMenu.bind(this));BX.addCustomEvent("TaskAjaxError",function(t){BX.Tasks.alert(t).then(function(){BX.reload()})});BX.addCustomEvent("SidePanel.Slider:onClose",function(e){if(t.checkListChanged&&typeof BX.Tasks.CheckListInstance!=="undefined"){var s=BX.Tasks.CheckListInstance.optionManager.slider;if(!s||s!==e.getSlider()){return}if(!t.showCloseConfirmation){t.showCloseConfirmation=true;return}e.denyAction();var n=new BX.PopupWindow({titleBar:BX.message("TASKS_TTV_CLOSE_SLIDER_CONFIRMATION_POPUP_HEADER"),content:BX.message("TASKS_TTV_CLOSE_SLIDER_CONFIRMATION_POPUP_CONTENT"),closeIcon:false,buttons:[new BX.PopupWindowButton({text:BX.message("TASKS_TTV_CLOSE_SLIDER_CONFIRMATION_POPUP_BUTTON_CLOSE"),className:"popup-window-button-accept",events:{click:function(){t.showCloseConfirmation=false;n.close();s.close()}}}),new BX.PopupWindowButton({className:"popup-window-button popup-window-button-link",text:BX.message("TASKS_TTV_CLOSE_SLIDER_CONFIRMATION_POPUP_BUTTON_CANCEL"),events:{click:function(){n.close()}}})],events:{onPopupClose:function(){this.destroy()}}});n.show()}});BX.Event.EventEmitter.subscribe("BX.Tasks.CheckListItem:CheckListChanged",function(t){var e=t.data.action;var s=["addAccomplice","fileUpload","tabIn"];if(BX.util.in_array(e,s)){this.analyticsData[e]="Y"}this.toggleFooterWrap(true)}.bind(this))},onImportantButtonClick:function(t){var e=this.option("data").PRIORITY;var s=e==2?1:2;this.callRemote("task.template.update",{id:this.option("data").ID,data:{PRIORITY:s}}).then(function(e){if(e.isSuccess()){this.option("can").PRIORITY=s;BX.toggleClass(t,"no")}}.bind(this))},syncTags:function(t){t=t||[];if(t.length){var e=[];BX.Tasks.each(t,function(t){e.push({NAME:t.name})});t=e}this.callRemote("task.template.update",{id:this.option("data").ID,data:{SE_TAG:t}})},onButtonClick:function(t){if(t=="DELETE"){this.callRemote("task.template.delete",{id:this.option("data").ID},{},function(){BX.UI.Notification.Center.notify({content:BX.message("TASKS_NOTIFY_TASK_DELETED")});window.location=this.option("backUrl")})}},initFileView:function(){if(!this.option("publicMode")){BX.Tasks.each(this.controlAll("file-area"),function(t){top.BX.viewElementBind(t,{},function(t){return BX.type.isElementNode(t)&&(t.getAttribute("data-bx-viewer")||t.getAttribute("data-bx-image"))})})}},onSaveButtonClick:function(){if(this.isSaving){return}this.isSaving=true;BX.Tasks.CheckListInstance.activateLoading();this.saveCheckList()},saveCheckList:function(){var t=this;var e=BX.Tasks.CheckListInstance.getTreeStructure();var s={items:e.getRequestData(),templateId:this.option("data").ID,userId:this.option("data").USER_ID,params:{analyticsData:Object.assign(this.analyticsData,{checklistCount:e.getDescendantsCount()})}};this.query.run("TasksTaskTemplateComponent.saveCheckList",s).then(function(e){if(e.isSuccess()){var s=BX.Tasks.CheckListInstance.getTreeStructure();var n=e.getData().TRAVERSED_ITEMS;if(n){Object.keys(n).forEach(function(t){var e=s.findChild(t);if(e!=="undefined"&&e.fields.getId()===null){e.fields.setId(n[t].ID)}})}BX.Tasks.CheckListInstance.saveStableTreeStructure();BX.Tasks.CheckListInstance.deactivateLoading();this.analyticsData={};t.toggleFooterWrap(false)}this.isSaving=false}.bind(this));this.query.execute()},onCancelButtonClick:function(){if(this.isSaving){return}var t=this;var e=new BX.PopupWindow({titleBar:BX.message("TASKS_TTV_DISABLE_CHANGES_CONFIRMATION_POPUP_HEADER"),content:BX.message("TASKS_TTV_DISABLE_CHANGES_CONFIRMATION_POPUP_CONTENT"),closeIcon:false,buttons:[new BX.PopupWindowButton({text:BX.message("TASKS_TTV_DISABLE_CHANGES_CONFIRMATION_POPUP_BUTTON_YES"),className:"popup-window-button-accept",events:{click:function(){e.close();if(BX.Tasks.CheckListInstance!=="undefined"){BX.Tasks.CheckListInstance.rerender()}t.toggleFooterWrap(false)}}}),new BX.PopupWindowButton({className:"popup-window-button popup-window-button-link",text:BX.message("TASKS_TTV_DISABLE_CHANGES_CONFIRMATION_POPUP_BUTTON_NO"),events:{click:function(){e.close()}}})],events:{onPopupClose:function(){this.destroy()}}});e.show()},toggleFooterWrap:function(t){var e=BX("footerWrap");var s=BX("saveButton");var n="ui-btn-wait";var i="task-footer-wrap-active";if(t){if(!BX.hasClass(e,i)){BX.addClass(e,i)}this.checkListChanged=true;this.showCloseConfirmation=true}else{if(BX.hasClass(e,i)){BX.removeClass(e,i)}BX.removeClass(s,n);this.checkListChanged=false;this.showCloseConfirmation=false}},createTemplateMenu:function(){var t=[{delimiter:true,text:BX.message("TASKS_TEMPLATE_POPUP_MENU_CHECKLIST_SECTION")}];t.push({tabId:"showCompleted",text:BX.message("TASKS_TEMPLATE_POPUP_MENU_SHOW_COMPLETED"),className:"menu-popup-item-accept",onclick:function(t,e){e.getMenuWindow().close();if(typeof BX.Tasks.CheckListInstance!=="undefined"){BX.toggleClass(e.layout.item,"menu-popup-item-accept");var s=BX.Tasks.CheckListInstance.getTreeStructure();var n=s.optionManager;n.setShowCompleted(!n.getShowCompleted());s.handleTaskOptions()}}});t.push({tabId:"showOnlyMine",text:BX.message("TASKS_TEMPLATE_POPUP_MENU_SHOW_ONLY_MINE"),className:"manu-popup-item",onclick:function(t,e){e.getMenuWindow().close();if(typeof BX.Tasks.CheckListInstance!=="undefined"){BX.toggleClass(e.layout.item,"menu-popup-item-accept");var s=BX.Tasks.CheckListInstance.getTreeStructure();var n=s.optionManager;n.setShowOnlyMine(!n.getShowOnlyMine());s.handleTaskOptions()}}});var e=BX.PopupMenu.create("templatePopupMenuOptions",BX("templateViewPopupMenuOptions"),t,{closeByEsc:true,offsetLeft:BX("templateViewPopupMenuOptions").getBoundingClientRect().width/2,angle:true});e.popupWindow.show()}}})}).call(this);
//# sourceMappingURL=logic.map.js