"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksTaskTemplate!="undefined"){return}BX.Tasks.Component.TasksTaskTemplate=BX.Tasks.Component.extend({sys:{code:"task-template-edit"},methods:{bindEvents:function(){this.analyticsData={};this.bindControl("form","submit",BX.delegate(this.onSubmitClick,this));this.bindControl("to-checklist","click",BX.delegate(this.onToCheckListClick,this));BX.bind(BX("templateEditPopupMenuOptions"),"click",this.createTemplateMenu.bind(this));BX.Tasks.Util.hintManager.bindHelp(this.scope());this.bindNestedControls();BX.addCustomEvent("TaskAjaxError",(function(e){BX.Tasks.alert(e)}));BX.Event.EventEmitter.subscribe("BX.Tasks.CheckListItem:CheckListChanged",function(e){var t=e.data.action;var s=["addAccomplice","fileUpload","tabIn"];if(BX.util.in_array(t,s)){this.analyticsData[t]="Y"}BX("checklistAnalyticsData").value=Object.keys(this.analyticsData).join(",")}.bind(this))},processEditorInit:function(){if(!this.isEditMode()){BX.ready(BX.delegate((function(){var e=BX.delegate(this.onFormKeyDown,this);BX.bind(document,"keydown",e);var t=this.option("id");var s=BXHtmlEditor.Get(t);if(s){this.bindEditorEvents(s,e);this.setFocusOnTitle(s,e)}else{BX.addCustomEvent(window,"OnEditorInitedAfter",BX.delegate((function(i){if(i!=null&&i.id==t){this.bindEditorEvents(i,e);this.setFocusOnTitle(s,e)}}),this))}}),this))}},bindEditorEvents:function(e,t){BX.addCustomEvent(e,"OnIframeKeyup",t);BX.addCustomEvent(e,"OnTextareaKeyup",t)},bindNestedControls:function(){BX.Tasks.Util.Dispatcher.bindEvent(this.id()+"-frame","block-toggle",this.onFrameBlockToggle.bind(this))},onFrameBlockToggle:function(e,t){if(e==="se_checklist"&&t){var s=BX.Tasks.CheckListInstance.getTreeStructure();if(s.getDescendantsCount()===0){BX.Tasks.CheckListInstance.addCheckList().then((function(e){e.addCheckListItem()}))}}},setFocusOnTitle:function(e){setTimeout(function(){var t=this.control("title");if(t){e.Focus(false);t.focus();t.selectionStart=t.value.length;BX.focus()}}.bind(this),500)},isFlagEnabled:function(e){return e.checked},isEditMode:function(){return this.option("template").ID>0},onSubmitClick:function(e){e=e||window.event;if(this.vars.submitting){BX.PreventDefault(e);return}var t=this.control("csrf");if(t){t.value=BX.bitrix_sessid()}BX.Tasks.Util.Dispatcher.call(this.id()+"-frame","showLoader",{IFRAME:"Y"});this.vars.submitting=true},onToCheckListClick:function(){var e=new BX.PopupWindow({bindElement:this.control("to-checklist"),content:BX.message("TASKS_TASK_TEMPLATE_COMPONENT_TEMPLATE_TO_CHECKLIST_HINT"),className:"tasks-to-checklist-popup",darkMode:true,autoHide:true,closeByEsc:true,angle:true,offsetLeft:this.control("to-checklist").offsetWidth/2,events:{onPopupClose:function(){this.destroy()}}});var t="";var s=document.getElementsByClassName("bx-html-editor")[0];var i=s.querySelector(".bxhtmled-iframe-cnt").style.display==="none";if(i){var n=s.querySelector(".bxhtmled-textarea");var o=n.selectionStart;var a=n.selectionEnd;t=n.value.substring(o,a)}else{var c=s.querySelector(".bx-editor-iframe").contentDocument;if(c.getSelection){t=c.getSelection().toString()}else if(c.selection){t=c.selection.createRange().text}}if(t!==""){var l=t.split(/\r\n|\r|\n/g);if(l.length>0){var r=new BX.PopupMenuWindow({bindElement:this.control("to-checklist"),items:this.getToCheckListPopupMenuItems(l)});r.show()}else{e.show();setTimeout((function(){e.close()}),2e3)}}else{e.show();setTimeout((function(){e.close()}),2e3)}},getToCheckListPopupMenuItems:function(e){var t=this;var s=BX.Tasks.CheckListInstance.getTreeStructure();var i=[{text:"+ "+BX.message("TASKS_TASK_TEMPLATE_COMPONENT_TEMPLATE_TO_CHECKLIST_ADD_NEW_CHECKLIST"),onclick:function(s,i){i.getMenuWindow().close();var n=t.getCheckListItemsFromTitles(e);BX.Tasks.CheckListInstance.addCheckList().then((function(e){n.forEach((function(t){e.addCheckListItem(t)}));e.handleTaskOptions();BX("checklistFromDescription").value="fromDescription"}));var o=t.scope().querySelector(".task-checklist-container");if(BX.hasClass(o,"invisible")){BX.Tasks.Util.fadeSlideToggleByClass(o,400)}}},{delimiter:true}];s.getDescendants().forEach((function(s){i.push({text:s.fields.getTitle(),onclick:function(i,n){n.getMenuWindow().close();var o=t.getCheckListItemsFromTitles(e);o.forEach((function(e){s.addCheckListItem(e)}));o[0].handleTaskOptions();BX("checklistFromDescription").value="fromDescription";var a=t.scope().querySelector(".task-checklist-container");if(BX.hasClass(a,"invisible")){BX.Tasks.Util.fadeSlideToggleByClass(a,400)}}})}));return i},getCheckListItemsFromTitles:function(e){var t=[];e.forEach((function(e){var s=BX.util.htmlspecialchars(e.trim());if(s.length>0){var i=new BX.Tasks.CheckListItem({TITLE:s});t.push(i)}}));return t},createTemplateMenu:function(){var e=[{delimiter:true,text:BX.message("TASKS_TASK_TEMPLATE_COMPONENT_TEMPLATE_POPUP_MENU_CHECKLIST_SECTION")}];e.push({tabId:"showCompleted",text:BX.message("TASKS_TASK_TEMPLATE_COMPONENT_TEMPLATE_POPUP_MENU_SHOW_COMPLETED"),className:"menu-popup-item-accept",onclick:function(e,t){t.getMenuWindow().close();if(typeof BX.Tasks.CheckListInstance!=="undefined"){BX.toggleClass(t.layout.item,"menu-popup-item-accept");var s=BX.Tasks.CheckListInstance.getTreeStructure();var i=s.optionManager;i.setShowCompleted(!i.getShowCompleted());s.handleTaskOptions()}}});e.push({tabId:"showOnlyMine",text:BX.message("TASKS_TASK_TEMPLATE_COMPONENT_TEMPLATE_POPUP_MENU_SHOW_ONLY_MINE"),className:"manu-popup-item",onclick:function(e,t){t.getMenuWindow().close();if(typeof BX.Tasks.CheckListInstance!=="undefined"){BX.toggleClass(t.layout.item,"menu-popup-item-accept");var s=BX.Tasks.CheckListInstance.getTreeStructure();var i=s.optionManager;i.setShowOnlyMine(!i.getShowOnlyMine());s.handleTaskOptions()}}});var t=BX.PopupMenu.create("templatePopupMenuOptions",BX("templateEditPopupMenuOptions"),e,{closeByEsc:true,offsetLeft:BX("templateEditPopupMenuOptions").getBoundingClientRect().width/2,angle:true});t.popupWindow.show()},getInstanceDispatcher:function(e){return BX.Tasks.Util.Dispatcher.find(this.id()+"-"+e)}}})}).call(this);
//# sourceMappingURL=logic.map.js