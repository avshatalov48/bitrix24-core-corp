"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.EmployeePlan!="undefined"){return}BX.Tasks.Component.EmployeePlan=BX.Tasks.Component.extend({options:{pageSize:15,userProfileUrl:"/company/personal/user/#user_id#/",userNameTemplate:"#NAME#",gutterOffset:300,zoomLevel:"monthday2x"},sys:{code:"empplan"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);this.vars.lastPage=1;this.vars.lastCount=0;this.vars.lastFilter=this.option("filter");this.vars.queryLock=false;this.subInstance("users",new BX.Tasks.Util.Collection({keyField:"VALUE"})).load(this.option("departmentUsers"));this.subInstance("departments",new BX.Tasks.Util.Collection({keyField:"VALUE"})).load(this.option("companyDepartments"));this.initSelectors();this.initRouter();this.initGrid();this.onSearch=BX.debounce(this.onSearch,300,this)},initSelectors:function(){var e=this.vars.lastFilter;this.subInstance("status-selector",new BX.Tasks.Util.SelectBox({scope:this.control("status-selector"),items:this.option("statusList"),selected:e.TASK.STATUS,notSelectedLabel:BX.message("TASKS_COMMON_ANY")})).bindEvent("change",BX.delegate(this.statusChanged,this));this.subInstance("department-selector",new BX.Tasks.Util.SelectBox({scope:this.control("department-selector"),items:this.subInstance("departments").export(),selected:e.MEMBER.DEPARTMENT[0],notSelectedLabel:BX.message("TASKS_COMMON_ALL")})).bindEvent("change",BX.delegate(this.departmentChanged,this));var t=this.subInstance("user-selector",new BX.Tasks.Util.ComboBox({scope:this.control("user-selector"),items:this.getDepartmentUsers(e.MEMBER.DEPARTMENT[0]),selected:e.MEMBER.USER[0],notSelectedLabel:BX.message("TASKS_COMMON_ALL")}));t.bindEvent("change",BX.delegate(this.userChanged,this));t.setFilterHandlerFabric(function(e){return{"#IX":e}});this.subInstance("range",new BX.Tasks.Component.EmployeePlan.DateRange({scope:this.control("date-range")})).bindEvent("change",BX.delegate(this.datesChanged,this))},statusChanged:function(e){if(e){this.vars.lastFilter.TASK.STATUS=e}else{delete this.vars.lastFilter.TASK.STATUS}this.onSearch()},departmentChanged:function(e){this.vars.lastFilter.MEMBER.DEPARTMENT=e?[e]:[];this.onSearch();this.updateUserSelector(e)},getDepartmentUsers:function(e){var t=t=this.subInstance("users");if(e){var s=this.subInstance("departments");var i;var n=s.getByKey(e);t=t.find(function(e,t){if(e=="DEP"){if(!t){return false}i=s.getByKey(t);if(!i){return false}return i.L>=n.L&&i.R<=n.R}},this)}return t.each(function(e){if(typeof e.IX=="undefined"){var t=e.DISPLAY.toLowerCase().split(" ").map(function(e){return e.trim()});t.push(e.VALUE.toString().trim());e.IX=t}}).export()},updateUserSelector:function(e){var t=this.subInstance("user-selector");t.clear();t.load(this.getDepartmentUsers(this.vars.lastFilter.MEMBER.DEPARTMENT[0]))},userChanged:function(e){this.vars.lastFilter.MEMBER.USER=e?[e]:[];this.onSearch()},datesChanged:function(e,t){this.vars.lastFilter.TASK.DATE_RANGE={FROM:e,TO:t};this.onSearch()},initRouter:function(){this.instances.router=new BX.Tasks.Util.Router;if(this.vars.lastFilter.FILTER_OWNER==BX.message("USER_ID")){this.updateQueryString()}},updateQueryString:function(){var e=this.vars.lastFilter;var t={};if(typeof e.FILTER_OWNER=="undefined"){t.FILTER_OWNER=BX.message("USER_ID")}else{t.FILTER_OWNER=e.FILTER_OWNER}if(e.MEMBER.DEPARTMENT[0]){t["MEMBER[DEPARTMENT][]"]=e.MEMBER.DEPARTMENT[0]}if(e.MEMBER.USER[0]){t["MEMBER[USER][]"]=e.MEMBER.USER[0]}if(e.TASK.STATUS){t["TASK[STATUS]"]=e.TASK.STATUS}t["TASK[DATE_RANGE][FROM]"]=e.TASK.DATE_RANGE.FROM;t["TASK[DATE_RANGE][TO]"]=e.TASK.DATE_RANGE.TO;this.instances.router.setQueryString(t)},initGrid:function(){var e=this.option("calendarSettings");this.instances.grid=new BX.Scheduler.View({headerText:BX.message("TASKS_EMPLOYEEPLAN_TEMPLATE_GRID_TITLE"),renderTo:this.control("result"),currentDatetime:BX.parseDate(this.option("currentDayTime")),datetimeFormat:BX.message("FORMAT_DATETIME"),dateFormat:BX.message("FORMAT_DATE"),gutterOffset:parseInt(this.option("gutterOffset"),10),zoomLevel:this.option("zoomLevel"),weekends:e.WEEK_END,holidays:e.HOLIDAYS,firstWeekDay:e.WEEK_START,worktime:e.HOURS,events:{onGutterResize:function(e){BX.userOptions.save("tasks","scheduler","gutter_offset",e)},onZoomChange:function(e){BX.userOptions.save("tasks","scheduler","zoom_level",e)}}});this.appendGridData(this.option("gridData").DATA);this.setGridVerticalCountTotal(this.option("gridData").COUNT_TOTAL);this.redrawGrid(true)},bindEvents:function(){this.bindControlThis("search","click",this.onSearch);this.bindControlThis("search-more","click",this.onSearchMore)},showTaskPopup:function(){if(BX.Tasks.Singletons.iframePopup){BX.Tasks.Singletons.iframePopup.view(this.config.entityId)}},adaptGridData:function(e){var t=e;var s=[];var i={};var n=[];var a;for(a=0;a<t.USERS.length;a++){var r=t.USERS[a];s.push({id:"U"+r.ID,name:BX.formatName({NAME:r["NAME"],LAST_NAME:r["LAST_NAME"],SECOND_NAME:r["SECOND_NAME"],LOGIN:r["LOGIN"]},this.option("userNameTemplate"),"Y"),parentId:r.DEPARTMENT_ID?"D"+r.DEPARTMENT_ID:false,parentDepartment:r.DEPARTMENT_ID?r.DEPARTMENT_ID:null,link:this.option("userProfileUrl").replace("#user_id#",r.ID)});i[r.ID]=[]}for(a=0;a<t.TASKS.length;a++){var o=t.TASKS[a];var h="0";if(o.RESPONSIBLE_ID in i){h=o.RESPONSIBLE_ID;if(!i[o.RESPONSIBLE_ID].includes(o.ID)){n.push(this.createTaskItem(o,h));i[o.RESPONSIBLE_ID].push(o.ID)}}if(o.ACCOMPLICE_ID in i){h=o.ACCOMPLICE_ID;if(!i[o.ACCOMPLICE_ID].includes(o.ID)){n.push(this.createTaskItem(o,h));i[o.ACCOMPLICE_ID].push(o.ID)}}}return{tasks:n,users:s}},createTaskItem:function(e,t){var s={id:"U"+t+"T"+e.ID,resourceId:"U"+t,entityId:e.ID,name:e.TITLE,startDate:BX.parseDate(e.START_DATE_PLAN),endDate:BX.parseDate(e.END_DATE_PLAN)};if(e.ACTION.READ){s.onclick=this.showTaskPopup}else{s.className="scheduler-event-inaccessible"}return s},resetGrid:function(){this.vars.lastPage=0;this.instances.grid.clearAll()},redrawGrid:function(e){if(!e){var t=this.instances.grid.getCurrentScrollDate();this.instances.grid.render();this.instances.grid.timeline.scrollToDate(t)}else{this.instances.grid.render()}},setGridVerticalCountTotal:function(e){if(BX.type.isNumber(e)){this.vars.lastCount=parseInt(e)}var t=this.vars.lastCount-this.vars.lastPage*this.optionInteger("pageSize")>0;BX[t?"removeClass":"addClass"](this.control("search-more"),"no-display")},getDepartments:function(){if(!this.vars.deps){this.vars.deps={};BX.Tasks.each(this.option("companyDepartments"),function(e){this.vars.deps[e.ID]=e},this)}return this.vars.deps},appendGridData:function(e){e=this.adaptGridData(e);var t=this.getDepartments();var s=[];var i=[];var n=[];var a=null;for(var r=0;r<e.users.length;r++){if(e.users[r].parentDepartment!==null&&typeof t[e.users[r].parentDepartment]!="undefined"){a=t[e.users[r].parentDepartment];s.push({id:"D"+a.ID,name:a.NAME,type:"BX.Scheduler.ResourceGroup"});i.push(e.users[r])}else{n.push(e.users[r])}}this.instances.grid.getResourceStore().load(n);this.instances.grid.getResourceStore().load(s);this.instances.grid.getResourceStore().load(i);this.instances.grid.getEventStore().load(e.tasks)},toggleSearchLoading:function(e){if(e&&this.vars.queryLock){return false}this.vars.queryLock=e;BX[e?"addClass":"removeClass"](this.control("search-more"),"ui-btn-clock");return true},onSearch:function(){this.resetGrid();this.updateQueryString();this.showNextGridPage()},onSearchMore:function(){if(!this.toggleSearchLoading(true)){return}this.showNextGridPage()},showNextGridPage:function(){this.callRemote("this.getGridRegion",{filter:this.vars.lastFilter,nav:{PAGE:this.vars.lastPage+1},parameters:{GET_COUNT_TOTAL:this.vars.lastPage==0}}).then(function(e){if(e.errors.filter({TYPE:"FATAL"}).isEmpty()){this.vars.lastPage++;this.appendGridData(e.data.DATA);this.setGridVerticalCountTotal(e.data.COUNT_TOTAL);this.toggleSearchLoading(false);this.redrawGrid()}else{BX.Tasks.alert(e.getErrors()).then(function(){BX.reload()})}})},getUserCollection:function(){if(!this.instances.d2u){this.instances.d2u=new BX.Tasks.Util.RemoteCollection({source:BX.delegate(function(e){return this.callRemote("this.getDepartmentUser",{id:e[0]})},this),transformer:function(e,t){var s=t.shift();var i={};i[s]=e;return i}})}return this.instances.d2u}}});BX.Tasks.Component.EmployeePlan.DateRange=BX.Tasks.Util.Widget.extend({sys:{code:"date-range"},options:{controlBind:"class",datePlanLimit:7776e3},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);this.instances.from=new BX.Tasks.Util.DatePicker({scope:this.control("from-container"),controlBind:"class",displayFormat:"system-short"});this.instances.to=new BX.Tasks.Util.DatePicker({scope:this.control("to-container"),controlBind:"class",displayFormat:"system-short"});this.bindEvents()},bindEvents:function(){this.bindControlThis("show","click",this.showSelector);this.instances.from.bindEvent("change",BX.delegate(function(){this.onBorderChange(true,false)},this));this.instances.to.bindEvent("change",BX.delegate(function(){this.onBorderChange(false,true)},this))},showSelector:function(){this.changeCSSFlag("active-calendar",true)},onBorderChange:function(e,t){if(this.vars.changeLock){return}var s=this.instances.from.getTimeStamp();var i=s;var n=this.instances.to.getTimeStamp();var a=n;var r=this.optionInteger("datePlanLimit");if(Math.abs(a-i)>r){if(e&&t||e){a=i+r}else if(t){i=a-r}}if(i>a){var o=a;a=i;i=o}this.vars.changeLock=true;var h=null;if(s!=i){this.instances.from.setTimeStamp(i);h=this.instances.from.scope()}if(n!=a){this.instances.to.setTimeStamp(a);h=this.instances.to.scope()}if(h){BX.Tasks.Util.hintManager.showDisposable(h,BX.message("TASKS_EMPLOYEEPLAN_TEMPLATE_DATE_AUTO_CHANGE").replace("#NUM#",90),"TASK_EMPLOYEEPLAN_DAC")}this.vars.changeLock=false;this.fireEvent("change",[this.instances.from.getValue(),this.instances.to.getValue()])}}})}).call(this);