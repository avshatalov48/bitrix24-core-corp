"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.EmployeePlan!="undefined"){return}BX.Tasks.Component.EmployeePlan=BX.Tasks.Component.extend({options:{pageSize:15,userProfileUrl:"/company/personal/user/#user_id#/",userNameTemplate:"#NAME#",gutterOffset:300,zoomLevel:"monthday2x"},sys:{code:"empplan"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);this.vars.lastPage=1;this.vars.lastCount=0;this.vars.lastFilter=this.option("filter");this.vars.queryLock=false;this.subInstance("users",new BX.Tasks.Util.Collection({keyField:"VALUE"})).load(this.option("departmentUsers"));this.subInstance("departments",new BX.Tasks.Util.Collection({keyField:"VALUE"})).load(this.option("companyDepartments"));this.initSelectors();this.initRouter();this.initGrid();this.onSearch=BX.debounce(this.onSearch,300,this)},initSelectors:function(){const t=this.vars.lastFilter;this.subInstance("status-selector",new BX.Tasks.Util.SelectBox({scope:this.control("status-selector"),items:this.option("statusList"),selected:t.TASK.STATUS,notSelectedLabel:BX.message("TASKS_COMMON_ANY")})).bindEvent("change",BX.delegate(this.statusChanged,this));this.subInstance("department-selector",new BX.Tasks.Util.SelectBox({scope:this.control("department-selector"),items:this.subInstance("departments").export(),selected:t.MEMBER.DEPARTMENT[0],notSelectedLabel:BX.message("TASKS_COMMON_ALL")})).bindEvent("change",BX.delegate(this.departmentChanged,this));const e=this.subInstance("user-selector",new BX.Tasks.Util.ComboBox({scope:this.control("user-selector"),items:this.getDepartmentUsers(t.MEMBER.DEPARTMENT[0]),selected:t.MEMBER.USER[0],notSelectedLabel:BX.message("TASKS_COMMON_ALL")}));e.bindEvent("change",BX.delegate(this.userChanged,this));e.setFilterHandlerFabric((function(t){return{"#IX":t}}));this.subInstance("range",new BX.Tasks.Component.EmployeePlan.DateRange({scope:this.control("date-range")})).bindEvent("change",BX.delegate(this.datesChanged,this))},statusChanged:function(t){if(t){this.vars.lastFilter.TASK.STATUS=t}else{delete this.vars.lastFilter.TASK.STATUS}this.onSearch()},departmentChanged:function(t){this.vars.lastFilter.MEMBER.DEPARTMENT=t?[t]:[];this.onSearch();this.updateUserSelector(t)},getDepartmentUsers:function(t){var e=e=this.subInstance("users");if(t){var s=this.subInstance("departments");var a;var i=s.getByKey(t);e=e.find((function(t,e){if(t=="DEP"){if(!e){return false}a=s.getByKey(e);if(!a){return false}return a.L>=i.L&&a.R<=i.R}}),this)}return e.each((function(t){if(typeof t.IX=="undefined"){var e=t.DISPLAY.toLowerCase().split(" ").map((function(t){return t.trim()}));e.push(t.VALUE.toString().trim());t.IX=e}})).export()},updateUserSelector:function(t){var e=this.subInstance("user-selector");e.clear();e.load(this.getDepartmentUsers(this.vars.lastFilter.MEMBER.DEPARTMENT[0]))},userChanged:function(t){this.vars.lastFilter.MEMBER.USER=t?[t]:[];this.onSearch()},datesChanged:function(t,e){this.vars.lastFilter.TASK.DATE_RANGE={FROM:t,TO:e};this.onSearch()},initRouter:function(){this.instances.router=new BX.Tasks.Util.Router;if(this.vars.lastFilter.FILTER_OWNER==BX.message("USER_ID")){this.updateQueryString()}},updateQueryString:function(){var t=this.vars.lastFilter;var e={};if(typeof t.FILTER_OWNER=="undefined"){e.FILTER_OWNER=BX.message("USER_ID")}else{e.FILTER_OWNER=t.FILTER_OWNER}if(t.MEMBER.DEPARTMENT[0]){e["MEMBER[DEPARTMENT][]"]=t.MEMBER.DEPARTMENT[0]}if(t.MEMBER.USER[0]){e["MEMBER[USER][]"]=t.MEMBER.USER[0]}if(t.TASK.STATUS){e["TASK[STATUS]"]=t.TASK.STATUS}e["TASK[DATE_RANGE][FROM]"]=t.TASK.DATE_RANGE.FROM;e["TASK[DATE_RANGE][TO]"]=t.TASK.DATE_RANGE.TO;this.instances.router.setQueryString(e)},initGrid:function(){var t=this.option("calendarSettings");this.instances.grid=new BX.Scheduler.View({headerText:BX.message("TASKS_EMPLOYEEPLAN_TEMPLATE_GRID_TITLE"),renderTo:this.control("result"),currentDatetime:BX.parseDate(this.option("currentDayTime")),datetimeFormat:BX.message("FORMAT_DATETIME"),dateFormat:BX.message("FORMAT_DATE"),gutterOffset:parseInt(this.option("gutterOffset"),10),zoomLevel:this.option("zoomLevel"),weekends:t.WEEK_END,holidays:t.HOLIDAYS,firstWeekDay:t.WEEK_START,worktime:t.HOURS,events:{onGutterResize:function(t){BX.userOptions.save("tasks","scheduler","gutter_offset",t)},onZoomChange:function(t){BX.userOptions.save("tasks","scheduler","zoom_level",t)}}});this.appendGridData(this.option("gridData").DATA);this.setGridVerticalCountTotal(this.option("gridData").COUNT_TOTAL);this.redrawGrid(true)},bindEvents:function(){this.bindControlThis("search","click",this.onSearch);this.bindControlThis("search-more","click",this.onSearchMore)},getOpenTaskPath:function(t){return this.option("pathToUserTasks").replace("#action#","view").replace("#task_id#",t)},adaptGridData:function(t){var e=t;var s=[];var a={};var i={};var n=[];var r;var o;for(r=0;r<e.USERS.length;r++){o=e.USERS[r];s.push({id:(o.DEPARTMENT_ID?"D"+o.DEPARTMENT_ID:"")+"U"+o.ID,name:BX.formatName({NAME:o["NAME"],LAST_NAME:o["LAST_NAME"],SECOND_NAME:o["SECOND_NAME"],LOGIN:o["LOGIN"]},this.option("userNameTemplate"),"Y"),parentId:o.DEPARTMENT_ID?"D"+o.DEPARTMENT_ID:false,parentDepartment:o.DEPARTMENT_ID?o.DEPARTMENT_ID:null,link:this.option("userProfileUrl").replace("#user_id#",o.ID)});a[o.ID]=[];i[o.ID]=(i[o.ID]||[]).concat(o.DEPARTMENT_ID?[o.DEPARTMENT_ID]:[])}var h;for(r=0;r<e.TASKS.length;r++){h=e.TASKS[r];if(h.RESPONSIBLE_ID in a&&!a[h.RESPONSIBLE_ID].includes(h.ID)){for(var c=0,l=i[h.RESPONSIBLE_ID];c<l.length;c++){n.push(this.createTaskItem(h,"D"+l[c]+"U"+h.RESPONSIBLE_ID))}n.push(this.createTaskItem(h,"U"+h.RESPONSIBLE_ID));a[h.RESPONSIBLE_ID].push(h.ID)}if(h.ACCOMPLICE_ID in a&&!a[h.ACCOMPLICE_ID].includes(h.ID)){for(var c=0,l=i[h.ACCOMPLICE_ID];c<l.length;c++){n.push(this.createTaskItem(h,"D"+l[c]+"U"+h.ACCOMPLICE_ID))}n.push(this.createTaskItem(h,"U"+h.ACCOMPLICE_ID));a[h.ACCOMPLICE_ID].push(h.ID)}}return{tasks:n,users:s}},createTaskItem:function(t,e){const s={id:e+"T"+t.ID,resourceId:e,entityId:t.ID,name:t.TITLE,startDate:BX.parseDate(t.START_DATE_PLAN),endDate:BX.parseDate(t.END_DATE_PLAN)};if(t.ACTION.READ){s.pathToTask=this.getOpenTaskPath(t.ID)}else{s.className="scheduler-event-inaccessible"}return s},resetGrid:function(){this.vars.lastPage=0;this.instances.grid.clearAll()},redrawGrid:function(t){if(!t){var e=this.instances.grid.getCurrentScrollDate();this.instances.grid.render();this.instances.grid.timeline.scrollToDate(e)}else{this.instances.grid.render()}},setGridVerticalCountTotal:function(t){if(BX.type.isNumber(t)){this.vars.lastCount=parseInt(t)}var e=this.vars.lastCount-this.vars.lastPage*this.optionInteger("pageSize")>0;BX[e?"removeClass":"addClass"](this.control("search-more"),"no-display")},getDepartments:function(){if(!this.vars.deps){this.vars.deps={};BX.Tasks.each(this.option("companyDepartments"),(function(t){this.vars.deps[t.ID]=t}),this)}return this.vars.deps},appendGridData:function(t){t=this.adaptGridData(t);var e=this.getDepartments();var s=[];var a=[];var i=[];var n=null;for(var r=0;r<t.users.length;r++){if(t.users[r].parentDepartment!==null&&typeof e[t.users[r].parentDepartment]!="undefined"){n=e[t.users[r].parentDepartment];s.push({id:"D"+n.ID,name:n.NAME,type:"BX.Scheduler.ResourceGroup"});a.push(t.users[r])}else{i.push(t.users[r])}}this.instances.grid.getResourceStore().load(i);this.instances.grid.getResourceStore().load(s);this.instances.grid.getResourceStore().load(a);this.instances.grid.getEventStore().load(t.tasks)},toggleSearchLoading:function(t){if(t&&this.vars.queryLock){return false}this.vars.queryLock=t;BX[t?"addClass":"removeClass"](this.control("search-more"),"ui-btn-clock");return true},onSearch:function(){this.resetGrid();this.updateQueryString();this.showNextGridPage()},onSearchMore:function(){if(!this.toggleSearchLoading(true)){return}this.showNextGridPage()},showNextGridPage:function(){BX.ajax.runComponentAction("bitrix:tasks.employee.plan","getGridRegion",{mode:"class",data:{filter:this.vars.lastFilter,nav:{PAGE:this.vars.lastPage+1},parameters:{GET_COUNT_TOTAL:this.vars.lastPage===0}}}).then(function(t){if(!t.status||t.status!=="success"){BX.reload();return}this.vars.lastPage++;this.appendGridData(t.data.DATA);this.setGridVerticalCountTotal(t.data.COUNT_TOTAL);this.toggleSearchLoading(false);this.redrawGrid()}.bind(this),function(t){BX.reload()}.bind(this))}}});BX.Tasks.Component.EmployeePlan.DateRange=BX.Tasks.Util.Widget.extend({sys:{code:"date-range"},options:{controlBind:"class",datePlanLimit:7776e3},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);this.instances.from=new BX.Tasks.Util.DatePicker({scope:this.control("from-container"),controlBind:"class",displayFormat:"system-short"});this.instances.to=new BX.Tasks.Util.DatePicker({scope:this.control("to-container"),controlBind:"class",displayFormat:"system-short"});this.bindEvents()},bindEvents:function(){this.bindControlThis("show","click",this.showSelector);this.instances.from.bindEvent("change",BX.delegate((function(){this.onBorderChange(true,false)}),this));this.instances.to.bindEvent("change",BX.delegate((function(){this.onBorderChange(false,true)}),this))},showSelector:function(){this.changeCSSFlag("active-calendar",true)},onBorderChange:function(t,e){if(this.vars.changeLock){return}var s=this.instances.from.getTimeStamp();var a=s;var i=this.instances.to.getTimeStamp();var n=i;var r=this.optionInteger("datePlanLimit");if(Math.abs(n-a)>r){if(t&&e||t){n=a+r}else if(e){a=n-r}}if(a>n){var o=n;n=a;a=o}this.vars.changeLock=true;var h=null;if(s!=a){this.instances.from.setTimeStamp(a);h=this.instances.from.scope()}if(i!=n){this.instances.to.setTimeStamp(n);h=this.instances.to.scope()}if(h){BX.Tasks.Util.hintManager.showDisposable(h,BX.message("TASKS_EMPLOYEEPLAN_TEMPLATE_DATE_AUTO_CHANGE").replace("#NUM#",90),"TASK_EMPLOYEEPLAN_DAC")}this.vars.changeLock=false;this.fireEvent("change",[this.instances.from.getValue(),this.instances.to.getValue()])}}})}).call(this);
//# sourceMappingURL=logic.map.js