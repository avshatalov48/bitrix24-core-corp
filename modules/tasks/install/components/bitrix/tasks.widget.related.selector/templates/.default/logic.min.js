"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetRelatedSelector!="undefined"){return}BX.Tasks.Component.TasksWidgetRelatedSelector=BX.Tasks.Component.extend({sys:{code:"task-sel-is"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);var t=this.getManager();t.bindEvent("change",this.onChanged.bind(this));t.bindEvent("selector-discover",this.loadSelector.bind(this));this.setTypes(this.option("types"),true)},onChanged:function(t){if(this.option("inputSpecial")){var e="";if(t[0]){e=this.subInstance("items").get(t[0]).data().ID}this.control("sole-input").value=e}this.fireEvent("change",arguments)},getIdByValue:function(t){var e=this.getManager().get(t);if(e){return e.id()}return null},deselect:function(){this.getManager().unload()},setTypes:function(t,e){this.vars.types=this.vars.types||{};if(!e&&this.vars.types.TASK==t.TASK){return}this.vars.types={};BX.Tasks.each(t,function(t,e){if(e=="TASK"||e=="TASK_TEMPLATE"){this.vars.types[e]=true}}.bind(this));this.changeTypes(t,e)},changeTypes:function(t,e){var s=this.subInstance("items");if(!e){s.unload();if(this.option("inputSpecial")){var n=BX.util.htmlspecialchars(this.option("inputPrefix")+(t.TASK?this.option("inputPostfixTask"):this.option("inputPostfixTaskTemplate")));this.control("sole-input").setAttribute("name",n)}}s.option("selectorCode",this.option(t.TASK?"selectorCodeTask":"selectorCodeTaskTemplate"));s.option("types",t);s.option("path",this.option(t.TASK?"pathTask":"pathTaskTemplate"))},loadSelector:function(t,e){e.cancelAutoResolve();var s=this.subInstance("items");var n=[];s.each(function(t){n.push(t.data().ID)});this.callRemoteTemplate("getSelector",{type:t,parameters:{COMPONENT_PARAMETERS:{MULTIPLE:this.option("max")>1?"Y":"N",NAME:s.option("selectorCode"),VALUE:n}}}).then(function(s){if(s.isSuccess()){var n=this.control("picker-content-"+t.toLowerCase());BX.html(n,s.getData()).then(function(){e.resolve()})}else{e.reject()}}.bind(this))},getManager:function(){return this.subInstance("items",function(){return new this.constructor.ItemManager({scope:this.scope(),data:this.option("data"),preRendered:true})})}}});BX.Tasks.Component.TasksWidgetRelatedSelector.ItemManager=BX.Tasks.PopupItemSet.extend({sys:{code:"task-sel"},options:{controlBind:"class",itemFx:"horizontal",selectorCode:"",itemFxHoverDelete:true,types:{}},methods:{checkSelectorLoaded:function(){return this.instances.selector&&this.instances.selector[this.getType()]},getSelector:function(){var t=new BX.Promise;var e=this.getType();this.instances.selector=this.instances.selector||{};var s=this.option("selectorCode");if(this.checkSelectorLoaded()){t.resolve(this.instances.selector[e])}else{var n=window["O_"+s];var i=function(e,s){this.bindSelectorEvents(s);t.resolve(s);this.instances.selector[e]=s};if(n){i.apply(this,[e,n])}else{var o=new BX.Promise;o.setAutoResolve(false);this.fireEvent("selector-discover",[e,o,this]);o.then(function(){var n=window["O_"+s];if(n){i.apply(this,[e,n])}else{t.reject()}}.bind(this),function(){t.reject()})}}return t},getPickerContainer:function(){return this.control("picker-content-"+this.getType().toLowerCase())},getType:function(){return this.option("types").TASK?"T":"TT"},extractItemDisplay:function(t){if(typeof t.DISPLAY!="undefined"){return t.DISPLAY}if(typeof t.name!="undefined"){return t.name}return t.TITLE},extractItemValue:function(t){t.ID=t.ID||t.id;if("VALUE"in t){return t.VALUE}return this.getType()+t.ID},prepareData:function(t){if(!("URL"in t)){t.URL=this.option("path").toString().replace("#id#",t.ID)}return t},bindSelectorEvents:function(t){BX.addCustomEvent(t,"on-change",BX.delegate(this.itemsChanged,this));if(typeof this.instances.window!="undefined"){BX.addCustomEvent(this.instances.window,"onAfterPopupShow",function(){setTimeout(function(){t.searchInput.focus()},100)})}},deleteItem:function(t,e){if(BX.type.isString(t)){t=this.get(t)}var s=t.data().ID;if(this.callMethod(BX.Tasks.PopupItemSet,"deleteItem",arguments)){if(this.checkSelectorLoaded()){this.getSelector().then(function(t){t.unselect(s)}.bind(this),function(){BX.debug("unable to get selector")})}}},getSelectionDelta:function(){var t=[];var e=[];var s=BX.clone(this.vars.temporalItems);this.each(function(t){var n=t.data().ID;if(!this.vars.temporalItems[n]){e.push(t.value())}else{delete s[n]}}.bind(this));for(var n in s){if(s[n]){t.push(n)}}return{added:t,deleted:e}}}})}).call(this);
//# sourceMappingURL=logic.map.js