"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetRelatedSelector!="undefined"){return}BX.Tasks.Component.TasksWidgetRelatedSelector=BX.Tasks.Component.extend({sys:{code:"task-sel-is"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);var t=this.getManager();t.bindEvent("change",this.onChanged.bind(this));this.setTypes(this.option("types"),true)},onChanged:function(t){this.fireEvent("change",arguments)},getIdByValue:function(t){var e=this.getManager().get(t);if(e){return e.id()}return null},setTypes:function(t,e){this.vars.types=this.vars.types||{};if(!e&&this.vars.types.TASK===t.TASK){return}this.vars.types={};BX.Tasks.each(t,function(t,e){if(e==="TASK"||e==="TASK_TEMPLATE"){this.vars.types[e]=true}}.bind(this));this.changeTypes(t,e)},changeTypes:function(t,e){var i=this.subInstance("items");if(!e){i.unload()}i.option("selectorCode",this.option(t.TASK?"selectorCodeTask":"selectorCodeTaskTemplate"));i.option("types",t);i.option("path",this.option(t.TASK?"pathTask":"pathTaskTemplate"))},getManager:function(){return this.subInstance("items",(function(){return new this.constructor.ItemManager({scope:this.scope(),data:this.option("data"),multiple:this.option("max")>1,preRendered:true,templateSubtaskLimitExceeded:this.option("templateSubtaskLimitExceeded")})}))}}});BX.Tasks.Component.TasksWidgetRelatedSelector.ItemManager=BX.Tasks.Util.ItemSet.extend({sys:{code:"task-sel"},options:{controlBind:"class",itemFx:"horizontal",selectorCode:"",itemFxHoverDelete:true,types:{}},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.ItemSet);this.preselectedItems=this.option("data")},openAddForm:function(){if(this.option("templateSubtaskLimitExceeded")){BX.Runtime.loadExtension("tasks.limit").then((t=>{const{Limit:e}=t;e.showInstance({featureId:"tasks_templates_subtasks",bindElement:null,limitAnalyticsLabels:{module:"tasks",source:"templateEdit"}})}));return}this.getDialog().show()},getDialog:function(){if(this.getType()==="T"){return this.getTasksDialog()}return this.getTemplatesDialog()},getTasksDialog:function(){if(!this.tasksDialog){this.tasksDialog=new BX.UI.EntitySelector.Dialog({targetNode:this.scope(),enableSearch:true,multiple:this.option("multiple"),dropdownMode:true,compactView:true,hideOnSelect:!this.option("multiple"),hideOnDeselect:!this.option("multiple"),context:"TASKS_TASKS",searchOptions:{allowCreateItem:false},preselectedItems:this.prepareDialogItems(this.preselectedItems),entities:[{id:"task"}],events:{"Item:onSelect":function(t){this.onSelectorItemSelected(t.getData().item)}.bind(this),"Item:onDeselect":function(t){this.onSelectorItemDeselected(t.getData().item)}.bind(this)}})}return this.tasksDialog},getTemplatesDialog:function(){if(!this.templatesDialog){this.templatesDialog=new BX.UI.EntitySelector.Dialog({targetNode:this.scope(),enableSearch:true,multiple:this.option("multiple"),dropdownMode:true,compactView:true,hideOnSelect:!this.option("multiple"),hideOnDeselect:!this.option("multiple"),context:"TASKS_TEMPLATES",searchOptions:{allowCreateItem:false},preselectedItems:this.prepareDialogItems(this.preselectedItems),entities:[{id:"task-template",options:{templateId:this.sys.parent.option("templateId")}}],events:{"Item:onSelect":function(t){this.onSelectorItemSelected(t.getData().item)}.bind(this),"Item:onDeselect":function(t){this.onSelectorItemDeselected(t.getData().item)}.bind(this)}})}return this.templatesDialog},onSelectorItemSelected:function(t){this.addItem(this.prepareItemData(t))},onSelectorItemDeselected:function(t){t=this.prepareItemData(t);var e=this.getType()+t.id;var i=Object.values(this.vars.items).find((function(t){return e.toString()===t.data().VALUE}));if(i){this.callMethod(BX.Tasks.Util.ItemSet,"deleteItem",[i])}},prepareItemData:function(t){return{id:t.getId(),name:t.getTitle()}},prepareDialogItems:function(t){var e=this.getType()==="T"?"task":"task-template";return t.map((function(t){return[e,t.ID]}))},extractItemDisplay:function(t){if(typeof t.DISPLAY!="undefined"){return t.DISPLAY}if(typeof t.name!="undefined"){return t.name}return t.TITLE},extractItemValue:function(t){t.ID=t.ID||t.id;if("VALUE"in t){return t.VALUE}return this.getType()+t.ID},getType:function(){return this.option("types").TASK?"T":"TT"},prepareData:function(t){if(!("URL"in t)){t.URL=this.option("path").toString().replace("#id#",t.ID)}return t},deleteItem:function(t,e){if(BX.type.isString(t)){t=this.get(t)}var i=t.data();this.callMethod(BX.Tasks.Util.ItemSet,"deleteItem",arguments);this.deleteFromPreselected(i);this.deselectDialogItem(i)},deleteFromPreselected:function(t){var e=this.preselectedItems.findIndex((function(e){return e.VALUE.toString()===t.VALUE.toString()}));if(e!==-1){this.preselectedItems.splice(e,1)}},deselectDialogItem:function(t){if(this.getType()==="T"&&this.tasksDialog||this.getType()==="TT"&&this.templatesDialog){var e=this.getDialog().getItem(this.prepareDialogItems([t])[0]);e&&e.deselect()}}}})}).call(this);
//# sourceMappingURL=logic.map.js