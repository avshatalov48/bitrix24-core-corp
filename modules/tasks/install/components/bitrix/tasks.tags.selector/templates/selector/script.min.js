this.BX=this.BX||{};(function(t){"use strict";BX.namespace("BX.Tasks");BX.Tasks.TagsSelector=function(t){this.tagsAreConverting=t.tagsAreConverting;this.groupId=t.groupId||0;this.taskId=t.taskId||0;this.isScrumTask=t.isScrumTask==="Y";this.templateId=t.templateId||0;this.tags=t.tags;this.userId=t.userId||0;this.entity={id:"task-tag"};if(this.taskId){this.entity.options={taskId:this.taskId};this.tags=[]}if(this.groupId){this.entity.options.groupId=this.groupId}this.bindEvents()};BX.Tasks.TagsSelector.prototype={constructor:BX.Tasks.TagsSelector,show:function t(){this.getSelector()&&this.getSelector().show()},bindEvents:function t(){var e=function t(){this.dialog.hide();this.dialog=null};var a=function t(e){this.dialog=null;this.groupId=0;if(e){this.groupId=e.data}};BX.addCustomEvent("onProjectChanged",a.bind(this));BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"tasks",command:"tag_changed",callback:e.bind(this)})},getSelector:function t(){if(!this.dialog){var e={status:false};var a=function t(){var e=BX.UI.EntitySelector.Dialog.getById("tasks-selector-task-tag-widget");e.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=false;e.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=false};var s=function t(){var e=BX.UI.EntitySelector.Dialog.getById("tasks-selector-task-tag-widget");e.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=true;e.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=true};var i=function t(e){var i=e.getData().query;if(i.trim()!==""){a()}else{s()}};var n=function t(e,a){var s=BX.UI.EntitySelector.Dialog.getById("tasks-selector-task-tag-widget");if(s.getContainer().querySelector("div.".concat(e))){return}var i=document.createElement("div");i.className=e;i.innerHTML="\n\t\t\t\t<div class='ui-alert ui-alert-xs ui-alert-danger'  \n\t\t\t\t\t<span class='ui-alert-message'>\n\t\t\t\t\t\t".concat(a,"\n\t\t\t\t\t</span> \n\t\t\t\t</div>\n\t\t\t\t");s.getFooterContainer().before(i)};var o=function t(a){var s=a.getTarget();var i=["click","keydown"];var o=function t(a){if(a.type==="keydown"){if(!((a.ctrlKey||a.metaKey)&&a.keyCode===13)){return}}var i=s.getSelectedItems().map((function(t){return t.getTitle()}));var o=s.getTagSelectorQuery();if(o.trim()===""){return}BX.ajax.runComponentAction("bitrix:tasks.tags.selector","updateTags",{mode:"class",data:{taskId:r,tagIds:i,newTag:o}}).then((function(t){if(t.data.success){e.status=true;var a=s.addItem({id:o,entityId:"task-tag",title:o,sort:1,badges:[{title:t.data.owner}]});s.getTab("all").getRootNode().addItem(a);a.select()}else{var i="tasks-selector-tag-already-exists-alert";n(i,t.data.error);var r=function t(){var e=s.getContainer().querySelector("div.".concat(i));e&&e.remove()};setTimeout(r,2e3)}}))};i.forEach((function(t){if(t==="click"){s.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").addEventListener(t,o)}else{s.getContainer().addEventListener(t,o)}}))};var r=this.taskId;var d=this.groupId;var c=this.templateId;if(r!==0){if(this.tagsAreConverting){var l=new top.BX.UI.Dialogs.MessageBox({title:BX.message("TASKS_TAG_SELECTOR_TAGS_ARE_CONVERTING_TITLE"),message:BX.message("TASKS_TAG_SELECTOR_TAGS_ARE_CONVERTING_TEXT"),buttons:top.BX.UI.Dialogs.MessageBoxButtons.OK,okCaption:BX.message("TASKS_TAG_SELECTOR_TAGS_ARE_CONVERTING_COME_BACK_LATER"),onOk:function t(){l.close()}});l.show();return}this.dialog=new BX.UI.EntitySelector.Dialog({id:"tasks-selector-task-tag-widget",targetNode:BX("task-tags-link"),enableSearch:true,width:350,height:400,multiple:true,dropdownMode:true,compactView:true,entities:[{id:"task-tag",options:{taskId:this.taskId,groupId:d}}],selectedItems:this.tags.map((function(t){return{id:BX.util.htmlspecialcharsback(t),entityId:"task-tag",title:BX.util.htmlspecialcharsback(t),tabs:"all"}})),searchOptions:{allowCreateItem:false},footer:BX.Tasks.EntitySelector.Footer,footerOptions:{userId:this.userId,taskId:this.taskId,groupId:d},clearUnavailableItems:true,events:{onLoad:function(t){t.getTarget().getFooterContainer().style.zIndex=1;o(t)}.bind(this),"Item:onSelect":function(t){this.onTagsChange(t,e)}.bind(this),onSearch:function(t){i(t)}.bind(this),"Item:onDeselect":function(t){this.onTagsChange(t,e)}.bind(this)}})}if(c!==0){this.dialog=new BX.UI.EntitySelector.Dialog({id:"tasks-widget-tag-selector-template-detail",targetNode:BX("task-tags-link"),enableSearch:true,width:350,height:400,multiple:true,dropdownMode:true,compactView:true,context:"TEMPLATE_TAG",entities:[{id:"template-tag",options:{},dynamicLoad:true,dynamicSearch:true}],selectedItems:this.tags.map((function(t){return{id:BX.util.htmlspecialcharsback(t),entityId:"template-tag",title:BX.util.htmlspecialcharsback(t),tabs:"all"}})),searchOptions:{allowCreateItem:true},events:{"Search:onItemCreateAsync":function t(e){var a=new BX.Promise;var s=e.getData().searchQuery;var i=e.getTarget();setTimeout((function(){var t=i.addItem({id:s.getQuery(),entityId:"template-tag",title:s.getQuery(),tabs:"all"});if(t){t.select()}a.fulfill()}),1e3);return a},"Item:onSelect":function(t){this.onTagsChange(t)}.bind(this),"Item:onDeselect":function(t){this.onTagsChange(t)}.bind(this)}})}}return this.dialog},onTagsChange:function t(e,a){var s=e.getData().item;s.setSort(1);this.dialog.getTab("all").getRootNode().addItem(s);var i=this.getSelector().getSelectedItems();var n=i.map((function(t){return t.getTitle()}));var o=n.join(", ");this.updateNode(o);var r=n.map((function(t){return{name:t}}));BX.onCustomEvent("onTaskTagSelect",[r]);if(typeof a!=="undefined"&&a.status){a.status=false;this.dialog.clearSearch();this.dialog.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=true;this.dialog.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=true;return}if(this.taskId){this.updateTask(n)}},updateNode:function t(e){var a=BX("task-tags-line");var s=BX("task-tags-link");BX.cleanNode(a);BX.adjust(a,{text:e});if(e.length>0){a.innerHTML+="&nbsp;&nbsp;";s.innerHTML=BX.message("TAGS_BUTTON_CHANGE")}else{s.innerHTML=BX.message("TAGS_BUTTON_ADD")}},updateTask:function t(e){BX.ajax.runComponentAction("bitrix:tasks.tags.selector","updateTags",{mode:"class",data:{taskId:this.taskId,tagIds:e}})["catch"]((function(t){if(t.errors){BX.Tasks.alert(t.errors)}}))}}})(this.BX.Tasks=this.BX.Tasks||{});
//# sourceMappingURL=script.map.js