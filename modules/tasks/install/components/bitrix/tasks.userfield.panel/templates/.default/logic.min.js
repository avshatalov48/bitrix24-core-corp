"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.UserFieldPanel!="undefined"){return}BX.Tasks.Component.UserFieldPanel=BX.Tasks.Component.extend({sys:{code:"uf-panel"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);this.instances.items=new BX.Tasks.Component.UserFieldPanel.ItemSet({scope:this.scope(),data:this.option("scheme"),itemFx:"vertical",parent:this});this.instances.items.bindEvent("item-save",BX.delegate(this.onItemSave,this));this.instances.items.bindEvent("item-hide",BX.delegate(this.onItemHide,this));this.instances.items.bindEvent("item-delete",BX.delegate(this.onItemDelete,this));this.saveState=BX.debounce(this.saveStateInstant,1200,this);this.redrawButtons()},bindEvents:function(){this.bindControlPassCtx("add-field","click",this.showAddPopup);this.bindControlPassCtx("action","click",this.showActionPopup);this.bindControlPassCtx("un-hide-field","click",this.showUnHideFieldPopup);this.bindDelegateControl("item-label-edit","keypress",this.jamEnter,this.control("new-item-place"))},jamEnter:function(e){if(BX.Tasks.Util.isEnter(e)){BX.eventReturnFalse(e)}},redrawButtons:function(){var e=false;var t=true;this.instances.items.each(function(i){if(!i.data().STATE.D){e=true}else{t=false}});this.changeCSSFlag("invisible",!e,this.control("un-hide-field"));this.changeCSSFlag("not-empty",!t,this.control("items"))},openAddForm:function(e,t,i){e.popupWindow.close();i.options=i.options||{};this.instances.items.openAddForm(i.options.code||i.code)},onItemSave:function(e,t,i){i.ENTITY_CODE=this.option("entityCode");this.callRemote("this.saveField",{id:t,data:i,parameters:{INPUT_PREFIX:this.option("inputPrefix"),RELATED_ENTITIES:this.option("relatedEntities")}}).then(function(t){if(t.isSuccess()){e.fulfill(t.getData())}else{e.reject(t.getErrors())}})},onItemHide:function(e,t){var i=this.option("user");var s=this.option("restriction").MANAGE&&i.IS_SUPER;var n=BX.message(s?"TASKS_TUFP_FIELD_HIDE_DELETE_CONFIRM":"TASKS_TUFP_FIELD_HIDE_CONFIRM");var a={id:this.code()+"-fh-confirm-v2",ctx:this,isDisposable:!s,buttonSet:s?[{text:BX.message("TASKS_COMMON_DELETE"),type:"red",code:"delete"},{text:BX.message("TASKS_COMMON_HIDE"),type:"green",code:"continue","default":true}]:false};BX.Tasks.confirm(n,null,a).then(function(i){if(i=="continue"){this.setItemStateDisplay(t,false);e.fulfill("hide")}else if(i=="delete"){return this.callRemote("this.deleteField",{id:t,parameters:{RELATED_ENTITIES:this.option("relatedEntities")}}).then(function(t){if(!t.isSuccess()){BX.Tasks.alert(t.getErrors());e.reject()}else{e.fulfill("delete")}})}}.bind(this))},onItemDelete:function(e){this.redrawButtons()},setItemStateDisplay:function(e,t,i){this.instances.items.get(e).data().STATE.D=t;this.redrawButtons();if(i){this.saveStateInstant()}else{this.saveState()}},setItemSortBefore:function(e,t){var i=[];this.instances.items.each(function(e){i.push({value:parseInt(e.value()),sort:e.data().STATE.S})});i=i.sort(function(e,t){if(e.sort>t.sort){return 1}else if(e.sort<t.sort){return-1}return 0});var s=parseInt(e.value());var n=t?parseInt(t.value()):-1;var a=1;for(var o in i){if(i.hasOwnProperty(o)){if(i[o].value!=s){if(i[o].value==n){this.instances.items.get(s).data().STATE.S=a;a=a+1}this.instances.items.get(i[o].value).data().STATE.S=a;a=a+1}}}if(n<0){this.instances.items.get(s).data().STATE.S=a}this.saveState()},saveStateInstant:function(e){this.callRemote("this.setState",{state:this.packState(),dropAll:!!e,entityCode:this.option("entityCode")},{code:"setstate"})},packState:function(){var e={};this.instances.items.each(function(t){e[t.value()]=t.data().STATE});return e},initDragNDrop:function(){if(!this.instances.dragNDrop){var e=new BX.Tasks.Util.DragAndDrop({createFlying:BX.delegate(function(e){var t=this.getItemByNode(e);return this.getNodeByTemplate("item-flying",t.data())[0]},this),autoMarkItemAfter:true,autoMarkZoneTopBottom:true});e.bindDropZone(this.control("items"));e.bindEvent("item-relocation-before",this.onDragNDropItemRelocatedBefore,this);e.bindEvent("item-relocation-after",this.onDragNDropItemRelocatedAfter,this);this.instances.dragNDrop=e;this.instances.items.each(BX.delegate(this.bindDragNDropNode,this))}},onDragNDropItemRelocatedBefore:function(e,t,i){var s=this.getItemByNode(t);if(s){e.cancelAutoResolve();s.disappear().then(function(){e.fulfill()})}},onDragNDropItemRelocatedAfter:function(e,t,i){var s=this.getItemByNode(t);if(s){e.cancelAutoResolve();s.appear().then(function(){e.fulfill()});this.setItemSortBefore(s,this.getItemByNode(i.before))}},getItemByNode:function(e){var t=null;if(e){var i=BX.data(e,"item-value");if(i){t=this.instances.items.get(i)}}return t},bindDragNDropNode:function(e){if(this.instances.dragNDrop){this.instances.dragNDrop.bindNode(e.scope(),{handle:this.controlAll("item-drag",e.scope())})}},registerItem:function(e){this.bindDragNDropNode(e);this.saveStateInstant()},doMenuAction:function(e,t,i){e.popupWindow.close();var s=i.action;if(s=="dragToggle"){i.layout.text.innerHTML=BX.message("TASKS_TUFP_DRAG_N_DROP_"+(i.enabled?"ON":"OFF"));i.enabled=!i.enabled;if(i.enabled){this.initDragNDrop()}this.changeCSSFlag("drag-mode-on",i.enabled,this.scope())}else if(s=="saveToAll"){BX.Tasks.confirm(BX.message("TASKS_TUFP_SAVE_TO_ALL_CONFIRM"),null,{isDisposable:true,id:this.code()+"-savetoall-confirm",ctx:this}).then(function(){this.saveState(true)})}},getItem:function(e){var t=new BX.Promise(null,this);var i=this.instances.items.get(e);if(i.data().NO_FIELD_HTML){this.callRemote("this.getFieldHtml",{id:e,entityCode:this.option("entityCode"),entityId:this.option("entityId"),parameters:{INPUT_PREFIX:this.option("inputPrefix"),RELATED_ENTITIES:this.option("relatedEntities")}}).then(function(e){var s="";if(e.isSuccess()){s=e.getData()}else{s='<div class="task-message-label error">'+e.getErrors().getMessages(true).join("<br />")+"</div>"}i.setFieldHtml(s);t.fulfill(i)});i.data().NO_FIELD_HTML=false}else{t.fulfill(i)}return t},unHideField:function(e){var t=BX.data(e,"id");if(BX.type.isNotEmptyString(t)){this.setItemStateDisplay(t,true,true);this.getItem(t).then(function(e){this.instances.items.showItem(e)})}if(this.instances.unHideMenu){this.instances.unHideMenu.hide()}},showActionPopup:function(e){var t=this.option("user");var i=[{action:"dragToggle",enabled:false,text:BX.message("TASKS_TUFP_DRAG_N_DROP_ON"),onclick:this.passCtx(this.doMenuAction)}];if(t.IS_SUPER){i.unshift({action:"saveToAll",text:BX.message("TASKS_TUFP_SAVE_SCHEME_TO_EVERYONE"),onclick:this.passCtx(this.doMenuAction)})}BX.PopupMenu.show(this.id()+"action",e,i,{angle:true,position:"right",offsetLeft:18,offsetTop:0})},canManage:function(){if(!this.option("restriction").MANAGE&&B24){B24.licenseInfoPopup.show(this.code(),BX.message("TASKS_TUFP_LICENSE_TITLE"),"<span>"+BX.message("TASKS_TUFP_LICENSE_BODY")+"</span>");return false}return true},showAddPopup:function(e){if(!this.canManage()){return}var t=[];var i=this.option("typesToCreate");if(BX.type.isPlainObject(i)){for(var s in i){if(i.hasOwnProperty(s)){t.push({code:s,text:i[s],title:i[s],onclick:this.passCtx(this.openAddForm)})}}}BX.PopupMenu.show(this.id()+"add",e,t,{angle:true,closeByEsc:true,position:"top",offsetLeft:40,offsetTop:5})},showUnHideFieldPopup:function(e){var t="";var i=this.subInstance("items").exportItemData();if(!i.count()){return}i.sort([["STATE.S","asc"]]).each(BX.delegate(function(e){if(!e.STATE.D){t+=this.getHTMLByTemplate("menu-item",{LABEL:e.LABEL,ID:e.ID,LABEL_EXT:e.LABEL+(e.MANDATORY?" ("+BX.message("TASKS_TUFP_FIELD_MANDATORY")+")":""),STAR_INVISIBLE:e.MANDATORY?"":"invisible"})}},this));this.control("uhmenu").innerHTML=t;if(!this.instances.unHideMenu){this.instances.unHideMenu=new BX.Tasks.Util.ScrollPanePopup({scope:this.control("un-hide-menu"),maxHeight:300,popupParameters:{angle:true,position:"top",offsetLeft:40,offsetTop:5,noAllPaddings:true}});this.instances.unHideMenu.bindDelegateControl("item","click",this.passCtx(this.unHideField))}this.instances.unHideMenu.show(e)}}});BX.Tasks.Component.UserFieldPanel.ItemSet=BX.Tasks.Util.ItemSet.extend({options:{controlBind:"class",preRendered:true,itemAppearFxSpeed:300,itemDisappearFxSpeed:300},methods:{getItemClass:function(){return BX.Tasks.Component.UserFieldPanel.ItemSet.Item},bindItemActions:function(){this.bindDelegateControl("item-hide","click",this.bindOnItem(this.hideItem));this.bindDelegateControl("item-edit","click",this.bindOnItem(this.enterEditItem));this.bindDelegateControl("item-cancel","click",this.bindOnItem(this.leaveEditItem,this.leaveEditItemNew));this.bindDelegateControl("item-save","click",this.bindOnItem(this.saveItem,this.saveItemNew));this.bindDelegateControl("item-label-edit","keypress",this.bindOnItem(this.itemLabelChanged))},hideItem:function(e){var t=new BX.Promise(null,this);this.fireEvent("item-hide",[t,e.value()]);t.then(function(t){if(t=="hide"){e.disappear()}else if(t=="delete"){this.deleteItem(e.value())}})},showItem:function(e){e.appear()},enterEditItem:function(e){if(this.parent()&&!this.parent().canManage()){return}e.toggleEditMode(true);e.initForm()},leaveEditItem:function(e){e.toggleEditMode(false)},leaveEditItemNew:function(){if(this.instances.newItem){this.instances.newItem.disappear()}},itemLabelChanged:function(e,t){if(BX.Tasks.Util.isEnter(t)){this.saveItem(e);BX.eventReturnFalse(t)}},saveItem:function(e){if(e.isLoading()){return}e.setLoading(true);e.hideErrors();var t=new BX.Promise(null,this);this.fireEvent("item-save",[t,e.value(),e.getFormData()]);t.then(function(t){e.setLoading(false);e.update({LABEL:t.LABEL,MANDATORY:t.MANDATORY!="0"});e.toggleEditMode(false)},function(t){e.setLoading(false);e.showErrors(t)})},saveItemNew:function(){if(this.instances.newItem){var e=this.instances.newItem;if(e.isLoading()){return}e.setLoading(true);e.hideErrors();var t=new BX.Promise(null,this);this.fireEvent("item-save",[t,0,e.getFormData()]);t.then(function(t){e.setLoading(false);e.update({ID:t.ID,FIELD_HTML:t.FIELD_HTML,LABEL:t.LABEL,MULTIPLE:t.MULTIPLE!="0",MANDATORY:t.MANDATORY!="0",STATE:{D:true,S:999999}});e.toggleEditMode(false).then(BX.delegate(function(){this.registerItem(e,{useAppear:false});if(this.parent()){this.parent().registerItem(e)}this.instances.newItem=null},this))},function(t){e.setLoading(false);e.showErrors(t)})}},openAddForm:function(e){var t=BX.message("TASKS_TUFP_NEW_FIELD_"+e.toUpperCase());if(this.instances.newItem){this.instances.newItem.update({USER_TYPE_ID:e,LABEL:t,DISPLAY:t})}else{this.instances.newItem=this.createItem({VALUE:"new",DISPLAY:t,LABEL:t,USER_TYPE_ID:e,MANDATORY:false,MULTIPLE:false,FIELD_HTML:this.getHTMLByTemplate("item-field-stub"),REQUIRED:"",EDIT:"edit",INVISIBLE:"invisible",DEFACEABLE:"defaceable",DISPLAY_MULTIPLE:"0"});BX.append(this.instances.newItem.scope(),this.control("new-item-place"));this.instances.newItem.toggleEditMode(true,true)}this.instances.newItem.initForm();if(!this.instances.newItem.isShown()){this.instances.newItem.appear()}}}});BX.Tasks.Component.UserFieldPanel.ItemSet.Item=BX.Tasks.Util.ItemSet.Item.extend({options:{controlBind:"class"},methods:{toggleEditMode:function(e,t){this.changeCSSFlag("edit",e);var i=new BX.Promise(null,this);var s=this.control("form-place");if(t){this.changeCSSFlag("invisible",!e,s);i.fulfill()}else{BX.Tasks.Util.fadeSlideToggleByClass(s).then(function(){i.fulfill()})}if(e){this.initForm()}return i},initForm:function(){var e=this.data();var t=this.control("multiple-edit");this.control("label-edit").value=e.DISPLAY;this.control("required-edit").checked=e.MANDATORY;t.checked=e.MULTIPLE;var i=parseInt(e.VALUE)||e.USER_TYPE_ID=="boolean";t.disabled=i;BX[i?"addClass":"removeClass"](t.parentNode,"disabled");if(e.USER_TYPE_ID=="boolean"){t.checked=false}this.control("label-edit").focus();this.hideErrors()},getFormData:function(){var e=BX.clone(this.data());e.DISPLAY=e.LABEL=this.control("label-edit").value;e.MANDATORY=this.control("required-edit").checked;e.MULTIPLE=this.control("multiple-edit").checked;return e},update:function(e){var t=this.data();if("LABEL"in e){t.LABEL=t.DISPLAY=e.LABEL}if("MANDATORY"in e){t.MANDATORY=e.MANDATORY}if("MULTIPLE"in e){t.MULTIPLE=e.MULTIPLE}if("FIELD_HTML"in e){t.FIELD_HTML=e.FIELD_HTML}if("USER_TYPE_ID"in e){t.USER_TYPE_ID=e.USER_TYPE_ID}if("STATE"in e){t.STATE=e.STATE}if("ID"in e){this.value(e.ID)}this.redraw()},redraw:function(){this.control("label").innerHTML=BX.util.htmlspecialchars(this.data().LABEL);BX[this.data().MANDATORY?"addClass":"removeClass"](this.scope(),"required");this.scope().setAttribute("data-type",this.data().USER_TYPE_ID);this.scope().setAttribute("data-multiple",this.data().MULTIPLE?"1":"0");this.scope().setAttribute("data-item-value",this.data().VALUE);this.setFieldHtml(this.data().FIELD_HTML);delete this.data().FIELD_HTML},value:function(e){if(e){this.data().ID=e}return this.callMethod(BX.Tasks.Util.ItemSet.Item,"value",arguments)},isLoading:function(){return!!this.vars.actionInProgress},setLoading:function(e){this.vars.actionInProgress=e;if(!this.vars.loading){this.vars.loading=BX.Tasks.Util.delay(function(){BX.addClass(this.control("save"),"webform-small-button-wait")},function(){BX.removeClass(this.control("save"),"webform-small-button-wait")},300,this)}if(e){this.vars.loading.call(this)}else{this.vars.loading.cancel()}},setFieldHtml:function(e){if(!e){return}e=e.replace(new RegExp("/bitrix/js/main/core/images/calendar-icon.gif","g"),"/bitrix/js/tasks/css/images/calendar.png");BX.html(this.control("field-html"),e)},hideErrors:function(){BX.Tasks.Util.hideByClass(this.control("error"))},showErrors:function(e){this.control("error").innerHTML=e.getMessages(true).join("<br />");BX.Tasks.Util.showByClass(this.control("error"))}}});BX.Tasks.Component.UserFieldPanel.ItemSet.Item.prepareData=function(e){e.VALUE=e.ID;e.DISPLAY=e.LABEL;return e}}).call(this);
//# sourceMappingURL=logic.map.js