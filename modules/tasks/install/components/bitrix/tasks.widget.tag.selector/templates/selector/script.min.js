this.BX=this.BX||{};(function(t){"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetTagSelector!="undefined"){return}BX.Tasks.Component.TasksWidgetTagSelector=BX.Tasks.Component.extend({sys:{code:"tag-sel-is"},methods:{construct:function t(){this.callConstruct(BX.Tasks.Component);this.subInstance("items",(function(){return new this.constructor.Items({scope:this.scope(),data:this.option("data"),groupId:this.option("groupId"),taskId:this.option("taskId"),userName:this.option("userName"),isScrumTask:this.option("isScrumTask")==="Y",tagsAreConverting:this.option("tagsAreConverting"),preRendered:true})}))}}});BX.Tasks.Component.TasksWidgetTagSelector.Items=BX.Tasks.Util.ItemSet.extend({sys:{code:"tag-sel"},options:{controlBind:"class",itemFx:"horizontal",itemFxHoverDelete:true,dialog:null,dialogCallback:true},methods:{bindEvents:function t(){this.callMethod(BX.Tasks.Util.ItemSet,"bindEvents");this.bindDelegateControl("form-control","click",this.passCtx(this.openAddForm));BX.addCustomEvent(window,"onTaskTagSelectAlt",this.onTagsChange.bind(this));var e=function t(e){var s=e.oldTagsNames;if(this.opts.dialog){this.opts.dialog.hide()}var a=[];this.each((function(t){a.push(t)}));var i=[];a.forEach((function(t){i.push(t.display())}));var o=e.oldTagName;var n=e.newTagName;if(!this.opts.changedItems){this.opts.changedItems=[]}a.forEach(function(t){if(o&&n!==""&&t.display()===o){this.addItem({NAME:n});this.opts.changedItems.indexOf(n)===-1&&this.opts.changedItems.push(n);var e=this.opts.changedItems.indexOf(o);this.opts.changedItems.splice(e,e);this.deleteItem(t.value());return}if(o&&n===""&&t.display()===o){var a=this.opts.changedItems.indexOf(o);this.opts.changedItems.splice(a,a);this.deleteItem(t.value());return}if(s&&s.length!==0){if(s.indexOf(t.display())!==-1){var i=this.opts.changedItems.indexOf(o);this.opts.changedItems.splice(i,i);this.deleteItem(t.value());return}else{this.opts.changedItems.indexOf(t.display())===-1&&this.opts.changedItems.push(t.display())}return}this.opts.changedItems.indexOf(t.display())===-1&&this.opts.changedItems.push(t.display())}.bind(this));this.opts.dialog=null};var s=function t(e){if(this.opts.dialog){this.selectedItems=this.opts.dialog.getSelectedItems();this.opts.dialog.hide();this.opts.dialog=null}if(!e.data.groupId||e.data.groupId.length===0){this.opts.groupId=0;this.tagOwner=this.option("userName")}else{this.opts.groupId=parseInt(e.data.groupId[0].match(/\d+/));this.tagOwner=e.data.owner}};BX.addCustomEvent("onProjectChanged",s.bind(this));BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"tasks",command:"tag_changed",callback:e.bind(this)});this.getTagSelector().load()},onTagsChange:function t(e){var s=e.getTarget();var a=e.getData().item;a.setSort(1);s.getTab("all").getRootNode().addItem(a);var i=[];this.each((function(t){i.push(t.display())}));var o=this.getTagSelector().getItems();var n=[];for(var r=0;r<o.length;r++){var d=o[r];if(d.isSelected()){n.push(d.getTitle());if(!BX.util.in_array(d.getTitle(),i)){this.addItem({NAME:d.getTitle()})}}}this.each((function(t){if(!BX.util.in_array(t.display(),n)){this.deleteItem(t.value())}}))},openAddForm:function t(e){if(this.option("tagsAreConverting")){var s=new top.BX.UI.Dialogs.MessageBox({title:BX.message("TASKS_WIDGET_TAG_SELECTOR_TAGS_ARE_CONVERTING_TITLE"),message:BX.message("TASKS_WIDGET_TAG_SELECTOR_TAGS_ARE_CONVERTING_TEXT"),buttons:top.BX.UI.Dialogs.MessageBoxButtons.OK,okCaption:BX.message("TASKS_WIDGET_TAG_SELECTOR_TAGS_ARE_CONVERTING_COME_BACK_LATER"),onOk:function t(){s.close()}});s.show();return}this.getTagSelector().show()},onItemDeleteByCross:function t(e){BX.onCustomEvent("onTaskTagDeleteByCross",[e.opts.data]);this.callMethod(BX.Tasks.Util.ItemSet,"onItemDeleteByCross",arguments);this.unselectDialogItem(e)},unselectDialogItem:function t(e){var s=this.getTagSelector();if(!s){return}this.opts.dialogCallback=false;if(babelHelpers["typeof"](e)==="object"){e=e.data()}var a=s.getItem(this.prepareTagItemData(e,s));a&&a.deselect();this.opts.dialogCallback=true},prepareItemData:function t(e){return["task-tag",e.NAME]},prepareTagItemData:function t(e,s){var a=s.getItems();var i=null;a.forEach((function(t){if(t.title.text===e.NAME){i=t.id;return}}));return{id:i,entityId:"task-tag"}},extractItemDisplay:function t(e){return e.NAME},extractItemValue:function t(e){if("VALUE"in e){return e.VALUE}return Math.abs(this.hashCode(e.NAME))},hashCode:function t(e){if(!BX.type.isNotEmptyString(e)){return 0}var s=0;for(var a=0;a<e.length;a++){var i=e.charCodeAt(a);if(i>255){i-=848}s=(s<<5)-s+i;s=s&s}return s},getTagSelector:function t(){var e=this.opts.taskId;var s=this.opts.groupId;var a=this.selectedItems;var i=this.opts.changedItems;var o=this.tagOwner;if(this.opts.groupId===0){var n=BX.UI.EntitySelector.Dialog.getById("tasksMemberSelector_project");if(n){var r=n.getSelectedItems();if(r.length!==0){this.opts.dialog=null;this.opts.groupId=r[0].id;s=this.opts.groupId}}}var d=function t(){var e=BX.UI.EntitySelector.Dialog.getById("tasksTagSelector");e.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=false;e.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=false};var l=function t(){var e=BX.UI.EntitySelector.Dialog.getById("tasksTagSelector");e.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").hidden=true;e.getFooterContainer().querySelector("#tags-widget-custom-footer-conjunction").hidden=true};var c=function t(e){var s=e.getTarget();var a=e.getData().query;if(a.trim()!==""){d()}else{l()}};var g=function t(e,s){var a=BX.UI.EntitySelector.Dialog.getById("tasksTagSelector");if(a.getContainer().querySelector("div.".concat(e))){return}var i=document.createElement("div");i.className=e;i.innerHTML="\n\t\t\t\t\t\t<div class='ui-alert ui-alert-xs ui-alert-danger'  \n\t\t\t\t\t\t\t<span class='ui-alert-message'>\n\t\t\t\t\t\t\t\t".concat(s,"\n\t\t\t\t\t\t\t</span> \n\t\t\t\t\t\t</div>\n\t\t\t\t\t");a.getFooterContainer().before(i)};var h=function t(n){var r=n.getTarget();if(i){i.forEach((function(t){var e=r.addItem({id:t,entityId:"task-tag",title:t,tabs:"all",badges:[{title:o}]});e.select()}))}if(a){a.forEach((function(t){var e=t.title.text;var s=false;r.getItems().forEach((function(t){if(t.title.text===e){s=true;t.select();t.setBadges([{title:o}])}}));if(!s){var a=r.addItem({id:t.title.text,entityId:t.entityId,title:t.title.text,tabs:"all",badges:[{title:o}]});a.select()}}))}var d=["click","keydown"];var l=function t(a){if(a.type==="keydown"){if(!((a.ctrlKey||a.metaKey)&&a.keyCode===13)){return}}var i=r.getTagSelectorQuery();if(i.trim()===""){return}BX.ajax.runComponentAction("bitrix:tasks.tag.list","addTag",{mode:"class",data:{newTag:i,taskId:e,groupId:s}}).then((function(t){if(t.data.success){var e=r.addItem({id:i,entityId:"task-tag",title:i,sort:1,badges:[{title:t.data.owner}]});r.getTab("all").getRootNode().addItem(e);e.select();r.clearSearch()}else{var s="tasks-selector-add-tag-already-exists-alert";g(s,t.data.error);var a=function t(){var e=r.getContainer().querySelector("div.".concat(s));e&&e.remove()};setTimeout(a,2e3)}}))};d.forEach((function(t){if(t==="click"){r.getFooterContainer().querySelector("#tags-widget-custom-footer-add-new").addEventListener(t,l)}else{r.getContainer().addEventListener(t,l)}}))};var u=function(){var t=document.querySelectorAll("div.task-options-item-open-inner");var e=this.control("form-control");t.forEach((function(t){if(t.contains(e)){e=t}}));return e}.bind(this);if(this.opts.dialog){return this.opts.dialog}this.opts.dialog=new BX.UI.EntitySelector.Dialog({id:"tasksTagSelector",targetNode:u(),enableSearch:true,width:350,height:400,multiple:true,dropdownMode:true,compactView:true,entities:[{id:"task-tag",options:{taskId:this.option("taskId"),groupId:this.opts.groupId}}],searchOptions:{allowCreateItem:false},footer:BX.Tasks.EntitySelector.Footer,footerOptions:{taskId:this.opts.taskId,groupId:this.opts.groupId},clearUnavailableItems:true,events:{onLoad:function(t){t.getTarget().getFooterContainer().style.zIndex=1;h(t)}.bind(this),onSearch:function(t){c(t)}.bind(this),"Item:onSelect":function(t){this.opts.dialogCallback&&this.onTagsChange(t)}.bind(this),"Item:onDeselect":function(t){this.opts.dialogCallback&&this.onTagsChange(t)}.bind(this)}});return this.opts.dialog}}})}).call(undefined)})(this.BX.Tasks=this.BX.Tasks||{});
//# sourceMappingURL=script.map.js