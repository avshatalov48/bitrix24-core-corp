"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetRights!="undefined"){return}BX.Tasks.Component.TasksWidgetAccess=BX.Tasks.Component.extend({sys:{code:"rights"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);var e=null;BX.Tasks.each(this.option("levels"),function(t){e=t;return false});this.vars.firstLevel=e;this.vars.addedItems=[];this.getManager()},getManager:function(){return this.subInstance("items",function(){return new this.constructor.ItemManager({scope:this.scope(),preRendered:true,data:this.option("data"),parent:this})})}}});BX.Tasks.Component.TasksWidgetAccess.ItemManager=BX.Tasks.Util.ItemSet.extend({sys:{code:"rights-is"},options:{controlBind:"class",useSmartCodeNaming:true},methods:{bindItemActions:function(){this.callMethod(BX.Tasks.Util.ItemSet,"bindItemActions");this.bindOnItemEx("i-operation-title","click",this.onItemOperationClick.bind(this))},onItemOperationClick:function(e,t){var n=[];BX.Tasks.each(this.optionP("levels"),function(t){n.push({enabled:true,text:t.TITLE,onclick:this.passCtx(this.doMenuAction),itemRef:e,levelId:t.ID,levelTitle:t.TITLE})}.bind(this));BX.PopupMenu.show(this.id()+"-op-popup-"+e.value(),t,n,{angle:true,position:"right",offsetLeft:40,offsetTop:0})},doMenuAction:function(e,t,n){e.popupWindow.close();this.setItemOperation(n.itemRef,n.levelId,n.levelTitle)},setItemOperation:function(e,t,n){e.data().TASK_ID=t;e.control("operation-title").innerHTML=n;e.control("operation").value=t},extractItemValue:function(e){if("VALUE"in e){return e.VALUE}e.VALUE=this.getRandomHash();return e.VALUE},prepareData:function(e){var t=this.parent().vars.firstLevel;this.setField("ID",e,"");this.setField("TITLE",e,t.TITLE);this.setField("TASK_ID",e,t.ID);this.setField("MEMBER_ID",e,e.id);this.setField("MEMBER_TYPE",e,t.MEMBER_TYPE);this.setField("DISPLAY",e,function(e){if("nameFormatted"in e){return BX.util.htmlspecialcharsback(e.nameFormatted)}var t=this.option("nameTemplate");if(t){var n=BX.formatName(e,t,"Y");if(n=="Noname"){n=e.LOGIN||e.login}return n}return e.LOGIN});e.ITEM_SET_INVISIBLE="";return e},openAddForm:function(){this.getSelector().open()},getSelector:function(){return this.subInstance("socnet",function(){var e=new BX.Tasks.Integration.Socialnetwork.NetworkSelector({scope:this.control("open-form"),id:this.id()+"socnet-sel",mode:"all",query:this.parent().getQuery(),useSearch:true,useAdd:false,controlBind:this.option("controlBind"),parent:this,popupOffsetTop:5,popupOffsetLeft:40,lastSelectedContext:"TASKS_RIGHTS"});e.bindEvent("item-selected",this.onSelectorItemSelected.bind(this));return e})},addItem:function(e){var t=e.MEMBER_TYPE.toString()+e.MEMBER_ID.toString();this.callMethod(BX.Tasks.Util.ItemSet,"addItem",arguments);this.addToAddedItems(t)},deleteItem:function(e){var t=this.getItem(e.value()).opts.data;var n=t.MEMBER_TYPE.toString()+t.MEMBER_ID.toString();var i=n;if(this.checkMainDepartmentDeselecting(t)){i="UA"}this.callMethod(BX.Tasks.Util.ItemSet,"deleteItem",arguments);this.getSelector().deselectItem(i);this.deleteFromAddedItems(n)},checkMainDepartmentDeselecting:function(e){var t=this.optionP("mainDepartment");return e.MEMBER_TYPE.toString()+e.MEMBER_ID.toString()==="DR"+t.ID},changeAllEmployeesToMainDepartment:function(e){if(e.entityType==="UA"){var t=this.optionP("mainDepartment");e.id=t.ID;e.entityType="DR";e.nameFormatted=t.NAME}return e},onSelectorItemSelected:function(e){e=this.changeAllEmployeesToMainDepartment(e);var t={U:BX.message("path_user").replace("#user_id#",e.id),SG:BX.message("path_group").replace("#group_id#",e.id),DR:BX.message("path_department").replace("#ID#",e.id)};var n=e.entityType+e.id;if(!this.isItemAdded(n)){e.MEMBER_ID=e.id;e.MEMBER_TYPE=e.entityType;e.URL=t[e.entityType];delete e.id;this.addItem(e);this.getSelector().close()}},isItemAdded:function(e){return this.parent().vars.addedItems.includes(e)},addToAddedItems:function(e){this.parent().vars.addedItems.push(e)},deleteFromAddedItems:function(e){var t=this.parent().vars.addedItems.indexOf(e);this.parent().vars.addedItems.splice(t,1)}}})}).call(this);
//# sourceMappingURL=logic.map.js