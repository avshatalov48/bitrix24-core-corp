function TasksUsers(e,s,a){this.name=e;this.multiple=s;this.arSelected=[];this.bSubordinateOnly=a;this.ajaxUrl=""}TasksUsers.arEmployees={};TasksUsers.arEmployeesData={};TasksUsers.prototype.load=function(e,s,a){function t(s){TasksUsers.arEmployees[e]=s;this.show(e)}if(null==s)s=false;if(null==a)a=false;if(e!="extranet")e=parseInt(e);var r=BX(this.name+"_employee_section_"+e);if(!r.BX_LOADED){if(TasksUsers.arEmployees[e]!=null){this.show(e)}else{var n=this.ajaxUrl+"&MODE=EMPLOYEES&SECTION_ID="+e;BX.ajax.loadJSON(n,BX.proxy(t,this))}}if(a){BX(this.name+"_employee_search_layout").scrollTop=r.offsetTop-40}BX.toggleClass(r,"company-department-opened");BX.toggleClass(BX(this.name+"_children_"+e),"company-department-children-opened")};TasksUsers.prototype.show=function(e){var s=BX(this.name+"_employee_section_"+e);var a=TasksUsers.arEmployees[e];s.BX_LOADED=true;var t=BX(this.name+"_employees_"+e);if(t){t.innerHTML="";for(var r=0;r<a.length;r++){var n;var l=false;TasksUsers.arEmployeesData[a[r].ID]={id:a[r].ID,name:a[r].NAME,sub:a[r].SUBORDINATE=="Y"?true:false,sup:a[r].SUPERORDINATE=="Y"?true:false,position:a[r].WORK_POSITION,photo:a[r].PHOTO};var i=BX.create("input",{props:{className:"tasks-hidden-input"}});if(this.multiple){i.name=this.name+"[]";i.type="checkbox"}else{i.name=this.name;i.type="radio"}var o=document.getElementsByName(i.name);var p=0;while(!l&&p<o.length){if(o[p].value==a[r].ID&&o[p].checked){l=true}p++}i.value=a[r].ID;n=BX.create("div",{props:{className:"company-department-employee"+(l?" company-department-employee-selected":"")},events:{click:BX.proxy(this.select,this)},children:[i,BX.create("div",{props:{className:"company-department-employee-avatar"},style:{background:a[r].PHOTO?"url('"+a[r].PHOTO+"') no-repeat center center":""}}),BX.create("div",{props:{className:"company-department-employee-icon"}}),BX.create("div",{props:{className:"company-department-employee-info"},children:[BX.create("div",{props:{className:"company-department-employee-name"},text:BX.util.htmlspecialcharsback(a[r].NAME)}),BX.create("div",{props:{className:"company-department-employee-position"},html:!a[r].HEAD&&!a[r].WORK_POSITION?"&nbsp;":BX.util.htmlspecialchars(a[r].WORK_POSITION)+(a[r].HEAD&&a[r].WORK_POSITION?", ":"")+(a[r].HEAD?BX.message("TASKS_EMP_HEAD"):"")})]})]});t.appendChild(n)}}};TasksUsers.prototype.select=function(e){var s;var a=0;var t=e.target||e.srcElement;if(e.currentTarget){s=e.currentTarget}else{s=t;while(!BX.hasClass(s,"finder-box-item")&&!BX.hasClass(s,"company-department-employee")){s=s.parentNode}}var r=BX.findChild(s,{tag:"input"});if(!this.multiple){var n=document.getElementsByName(this.name);for(var a=0;a<n.length;a++){if(n[a].value!=r.value){BX.removeClass(n[a].parentNode,BX.hasClass(n[a].parentNode,"finder-box-item")?"finder-box-item-selected":"company-department-employee-selected")}else{BX.addClass(n[a].parentNode,BX.hasClass(n[a].parentNode,"finder-box-item")?"finder-box-item-selected":"company-department-employee-selected")}}r.checked=true;BX.addClass(s,BX.hasClass(s,"finder-box-item")?"finder-box-item-selected":"company-department-employee-selected");var l=BX.findChild(s,{tag:"DIV",className:"finder-box-item-text"},true)||BX.findChild(s,{tag:"DIV",className:"company-department-employee-name"},true);var i=BX.util.htmlspecialcharsback(l.innerHTML);this.searchInput.value=i;this.arSelected=[];this.arSelected[r.value]={id:r.value,name:i,sub:TasksUsers.arEmployeesData[r.value].sub,sup:TasksUsers.arEmployeesData[r.value].sup,position:TasksUsers.arEmployeesData[r.value].position,photo:TasksUsers.arEmployeesData[r.value].photo}}else{var n=document.getElementsByName(this.name+"[]");if(!BX.util.in_array(r,n)){r.checked=false;BX.toggleClass(r.parentNode,BX.hasClass(r.parentNode,"finder-box-item")?"finder-box-item-selected":"company-department-employee-selected")}for(var a=0;a<n.length;a++){if(n[a].value==r.value){n[a].checked=false;BX.toggleClass(n[a].parentNode,BX.hasClass(n[a].parentNode,"finder-box-item")?"finder-box-item-selected":"company-department-employee-selected")}}if(BX.hasClass(r.parentNode,"finder-box-item-selected")||BX.hasClass(r.parentNode,"company-department-employee-selected")){r.checked=true}if(r.checked){var o=BX.findChild(BX(this.name+"_selected_users"),{className:"finder-box-selected-items"});if(!BX(this.name+"_employee_selected_"+r.value)){var p=BX.create("DIV");p.id=this.name+"_employee_selected_"+r.value;p.className="finder-box-selected-item";var l=BX.findChild(s,{tag:"DIV",className:"finder-box-item-text"},true)||BX.findChild(s,{tag:"DIV",className:"company-department-employee-name"},true);p.innerHTML='<div class="finder-box-selected-item-icon" onclick="O_'+this.name+".unselect("+r.value+', this);"></div><span class="finder-box-selected-item-text">'+l.innerHTML+"</span>";o.appendChild(p);var c=BX(this.name+"_current_count");c.innerHTML=parseInt(c.innerHTML)+1;this.arSelected[r.value]={id:r.value,name:BX.util.htmlspecialcharsback(l.innerHTML),sub:TasksUsers.arEmployeesData[r.value].sub,sup:TasksUsers.arEmployeesData[r.value].sup,position:TasksUsers.arEmployeesData[r.value].position,photo:TasksUsers.arEmployeesData[r.value].photo}}}else{BX.remove(BX(this.name+"_employee_selected_"+r.value));var c=BX(this.name+"_current_count");c.innerHTML=parseInt(c.innerHTML)-1;this.arSelected[r.value]=null}}if(!BX.util.in_array(r.value,TasksUsers.lastUsers)){TasksUsers.lastUsers.unshift(r.value);BX.userOptions.save("tasks","user_search","last_selected",TasksUsers.lastUsers.slice(0,10))}if(this.onSelect){var d=this.arSelected.pop();this.arSelected.push(d);this.onSelect(d)}if(this.onChange){this.onChange(this.arSelected)}};TasksUsers.prototype.unselect=function(e,s){var a=document.getElementsByName(this.name+(this.multiple?"[]":""));for(var t=0;t<a.length;t++){if(a[t].value==e){a[t].checked=false;BX.removeClass(a[t].parentNode,BX.hasClass(a[t].parentNode,"finder-box-item")?"finder-box-item-selected":"company-department-employee-selected")}}if(this.multiple){if(s){BX.remove(s.parentNode)}var r=BX(this.name+"_current_count");r.innerHTML=parseInt(r.innerHTML)-1}this.arSelected[e]=null;if(this.onChange){this.onChange(this.arSelected)}};TasksUsers.prototype.search=function(e){if(!e)e=window.event;function s(e){this.showResults(e)}if(this.searchInput.value.length>0){this.displayTab("search");var a=this.ajaxUrl+"&MODE=SEARCH&SEARCH_STRING="+encodeURIComponent(this.searchInput.value);if(this.bSubordinateOnly){a+="&S_ONLY=Y"}BX.ajax.loadJSON(a,BX.proxy(s,this))}};TasksUsers.prototype.showResults=function(e){var s=e;var a=BX(this.name+"_search");var t=a.getElementsByTagName("input");for(var r=0,n=t.length;r<n;r++){if(t[r].checked){BX(this.name+"_last").appendChild(t[r])}}if(a){a.innerHTML="";var l=BX.create("table",{props:{className:"finder-box-tab-columns",cellspacing:"0"},children:[BX.create("tbody")]});var i=BX.create("tr");l.firstChild.appendChild(i);var o=BX.create("td");i.appendChild(o);a.appendChild(l);for(var r=0;r<s.length;r++){var p;var c=false;TasksUsers.arEmployeesData[s[r].ID]={id:s[r].ID,name:s[r].NAME,sub:s[r].SUBORDINATE=="Y"?true:false,sup:s[r].SUPERORDINATE=="Y"?true:false,position:s[r].WORK_POSITION,photo:s[r].PHOTO};var d=BX.create("input",{props:{className:"tasks-hidden-input"}});if(this.multiple){d.name=this.name+"[]";d.type="checkbox"}else{d.name=this.name;d.type="radio"}var t=document.getElementsByName(d.name);var m=0;while(!c&&m<t.length){if(t[m].value==s[r].ID&&t[m].checked){c=true}m++}d.value=s[r].ID;var h=s[r].NAME;var u="finded_anchor_user_id_"+s[r].ID;p=BX.create("div",{props:{className:"finder-box-item"+(c?" finder-box-item-selected":""),id:u},attrs:{"bx-tooltip-user-id":s[r].ID},events:{click:BX.proxy(this.select,this)},children:[d,BX.create("div",{props:{className:"finder-box-item-text"},text:h}),BX.create("div",{props:{className:"finder-box-item-icon"}})]});o.appendChild(p);if(r==Math.ceil(s.length/2)-1){o=BX.create("td");l.firstChild.appendChild(o)}}}};TasksUsers.prototype.displayTab=function(e){BX.removeClass(BX(this.name+"_last"),"finder-box-tab-content-selected");BX.removeClass(BX(this.name+"_search"),"finder-box-tab-content-selected");BX.removeClass(BX(this.name+"_structure"),"finder-box-tab-content-selected");BX.addClass(BX(this.name+"_"+e),"finder-box-tab-content-selected");BX.removeClass(BX(this.name+"_tab_last"),"finder-box-tab-selected");BX.removeClass(BX(this.name+"_tab_search"),"finder-box-tab-selected");BX.removeClass(BX(this.name+"_tab_structure"),"finder-box-tab-selected");BX.addClass(BX(this.name+"_tab_"+e),"finder-box-tab-selected")};TasksUsers.prototype._onFocus=function(){this.searchInput.value=""};