this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(t,e,n,s,r,i){"use strict";var o=function(){function t(e){babelHelpers.classCallCheck(this,t);this.filterId=e.filterId;this.filterManager=BX.Main.filterManager.getById(this.filterId);this.bindEvents();this.updateFields()}babelHelpers.createClass(t,[{key:"bindEvents",value:function t(){s.EventEmitter.subscribe("BX.Main.Filter:apply",this.onFilterApply.bind(this))}},{key:"onFilterApply",value:function t(){this.updateFields()}},{key:"updateFields",value:function t(){this.fields=this.filterManager.getFilterFieldsValues()}},{key:"isFilteredByField",value:function t(e){if(!Object.keys(this.fields).includes(e)){return false}if(n.Type.isArray(this.fields[e])){return this.fields[e].length>0}return this.fields[e]!==""}},{key:"isFilteredByFieldValue",value:function t(e,n){return this.isFilteredByField(e)&&this.fields[e]===n}},{key:"toggleByField",value:function t(e){var n=this;var s=Object.keys(e)[0];var r=e[s];if(!this.isFilteredByFieldValue(s,r)){this.filterManager.getApi().extendFilter(babelHelpers.defineProperty({},s,r),false,{COUNTER_TYPE:"TASKS_COUNTER_TYPE_"+r});return}this.filterManager.getFilterFields().forEach((function(t){if(t.getAttribute("data-name")===s){n.filterManager.getFields().deleteField(t)}}));this.filterManager.getSearch().apply()}},{key:"getFilter",value:function t(){return this.filterManager}}]);return t}();var a,l,u,c,d;var h=function(){function t(e){babelHelpers.classCallCheck(this,t);this.count=e.count;this.name=e.name;this.type=e.type;this.color=e.color;this.filterField=e.filterField;this.filterValue=e.filterValue;this.filter=e.filter;this.$container=null;this.$innerContainer=null;this.$remove=null;this.$counter=null;this.bindEvents()}babelHelpers.createClass(t,[{key:"bindEvents",value:function t(){var e=this;s.EventEmitter.subscribe("BX.Tasks.Counters:active",(function(t){e!==t.data?e.unActive():null}))}},{key:"getCounter",value:function t(){if(!this.$counter){var e=this.count>99?"99+":this.count;this.$counter=n.Tag.render(a||(a=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="tasks-counters--item-counter-num ','">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"])),this.getCounterColor(),this.getInnerCounter(e))}return this.$counter}},{key:"getInnerCounter",value:function t(e){if(!this.$innerContainer){this.$innerContainer=n.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="tasks-counters--item-counter-num-text --stop --without-animate">',"</div>\t\t\n\t\t\t"])),e)}return this.$innerContainer}},{key:"animateCounter",value:function t(e,s){if(e>99&&s>99){return}if(s>99){s="99+"}if(e>99){e=99}if(s===0){this.getContainer().classList.add("--fade")}if(s>0){this.getContainer().classList.remove("--fade")}n.Dom.clean(this.getCounter());this.getInnerCounter().innerHTML=s;this.getCounter().appendChild(this.getInnerCounter());this.getCounter().classList.remove("--update");this.getCounter().classList.remove("--update-multi")}},{key:"getCounterColor",value:function t(){if(!this.color){return null}return"--".concat(this.color)}},{key:"updateCount",value:function t(e){if(this.count===e)return;this.animateCounter(this.count,e);this.count=e}},{key:"getRemove",value:function t(){if(!this.$remove){this.$remove=n.Tag.render(u||(u=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="tasks-counters--item-counter-remove"></div>\n\t\t\t'])))}return this.$remove}},{key:"fade",value:function t(){this.getContainer().classList.add("--fade")}},{key:"unFade",value:function t(){this.getContainer().classList.remove("--fade")}},{key:"active",value:function t(e){var r=n.Type.isDomNode(e)?e:this.getContainer();r.classList.add("--hover");s.EventEmitter.emit("BX.Tasks.Counters:active",this)}},{key:"unActive",value:function t(e){var r=n.Type.isDomNode(e)?e:this.getContainer();r.classList.remove("--hover");s.EventEmitter.emit("BX.Tasks.Counters:unActive",this)}},{key:"adjustClick",value:function t(){s.EventEmitter.emit("Tasks.Toolbar:onItem",{counter:this});if(this.$container.classList.contains("--hover")){this.unActive()}else{this.active();this.sendAnalytics()}}},{key:"getPopupMenuItemContainer",value:function t(){var e=n.Loc.getMessage("TASKS_COUNTER_OTHER_TASKS").replace("#TITLE#",this.name.toLowerCase());return n.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div>\n\t\t\t\t<div class="task-counters--popup-item">\n\t\t\t\t\t<span class="tasks-counters--item-counter-num ','">','</span>\n\t\t\t\t\t<span class="task-counters--popup-item-text">',"</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),this.getCounterColor(),this.count,e)}},{key:"getContainer",value:function t(e){if(!this.$container){this.$container=n.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="tasks-counters--item-counter ','">\n\t\t\t\t\t<div class="tasks-counters--item-counter-wrapper">\n\t\t\t\t\t\t','\n\t\t\t\t\t\t<div class="tasks-counters--item-counter-title">',"</div>\n\t\t\t\t\t\t","\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"])),Number(this.count)===0?" --fade":"",this.getCounter(),this.name,this.getRemove());if(this.filter.isFilteredByFieldValue(this.filterField,this.filterValue)){this.active(this.$container)}n.Event.bind(this.$container,"click",this.adjustClick.bind(this))}return this.$container}},{key:"sendAnalytics",value:function t(){r.sendData({tool:"tasks",category:"task_operations",type:"task",event:this.getAnalyticsEvent(),c_section:this.getAnalyticsSection(),c_element:this.getAnalyticsElement()})}},{key:"getAnalyticsEvent",value:function t(){if(E.counterTypes.expired.includes(this.type)){return"overdue_counters_on"}return"comments_counters_on"}},{key:"getAnalyticsSection",value:function t(){if(E.counterTypes.scrum.includes(this.type)){return"scrum"}if(E.counterTypes.project.includes(this.type)){return"project"}return"tasks"}},{key:"getAnalyticsElement",value:function t(){if(E.counterTypes.expired.includes(this.type)){return"overdue_counters_filter"}return"comments_counters_filter"}}]);return t}();var p,m,f,v,g,y,_,k,b;function C(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,s)}return n}function T(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?C(Object(n),!0).forEach((function(e){babelHelpers.defineProperty(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):C(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var E=function(){babelHelpers.createClass(t,null,[{key:"counterTypes",get:function t(){return{my:["expired","my_expired","originator_expired","accomplices_expired","auditor_expired","new_comments","my_new_comments","originator_new_comments","accomplices_new_comments","auditor_new_comments","projects_total_expired","projects_total_comments","sonet_total_expired","sonet_total_comments","groups_total_expired","groups_total_comments","scrum_total_comments","flow_total_expired","flow_total_comments"],other:["project_expired","project_comments","projects_foreign_expired","projects_foreign_comments","groups_foreign_expired","groups_foreign_comments","sonet_foreign_expired","sonet_foreign_comments","scrum_foreign_comments"],additional:["muted_new_comments"],expired:["expired","my_expired","originator_expired","accomplices_expired","auditor_expired","project_expired","projects_total_expired","projects_foreign_expired","groups_total_expired","groups_foreign_expired","sonet_total_expired","sonet_foreign_expired","flow_total_expired"],comment:["new_comments","my_new_comments","originator_new_comments","accomplices_new_comments","auditor_new_comments","muted_new_comments","project_comments","projects_total_comments","projects_foreign_comments","groups_total_comments","groups_foreign_comments","sonet_total_comments","sonet_foreign_comments","scrum_total_comments","scrum_foreign_comments","flow_total_comments"],project:["project_expired","projects_total_expired","projects_foreign_expired","groups_total_expired","groups_foreign_expired","sonet_total_expired","sonet_foreign_expired","project_comments","projects_total_comments","projects_foreign_comments","groups_total_comments","groups_foreign_comments","sonet_total_comments","sonet_foreign_comments"],scrum:["scrum_total_comments","scrum_foreign_comments"]}}}]);function t(e){babelHelpers.classCallCheck(this,t);this.userId=e.userId;this.targetUserId=e.targetUserId;this.groupId=e.groupId;this.counters=e.counters;this.initialCounterTypes=e.counterTypes;this.renderTo=e.renderTo;this.role=e.role;this.signedParameters=e.signedParameters;this.popupMenu=null;this.$readAll={cropped:null,layout:null};this.$more=null;this.$moreArrow=null;this.$other={cropped:null,layout:null};this.$myTaskHead=null;this.filter=new o({filterId:e.filterId});this.bindEvents();this.setData(this.counters);this.initPull()}babelHelpers.createClass(t,[{key:"isMyTaskList",value:function t(){return this.userId===this.targetUserId}},{key:"isUserTaskList",value:function t(){return Object.keys(this.otherCounters).length===0}},{key:"isProjectsTaskList",value:function t(){return this.groupId>0}},{key:"isProjectList",value:function t(){return!this.isUserTaskList()&&!this.isProjectsTaskList()}},{key:"initPull",value:function t(){var e=this;BX.PULL.subscribe({moduleId:"tasks",callback:function t(n){return e.processPullEvent(n)}});this.extendWatch()}},{key:"extendWatch",value:function t(){var e=this;if(this.isProjectsTaskList()||this.isProjectList()){var n="TASKS_PROJECTS";if(this.isProjectsTaskList()){n="TASKS_PROJECTS_".concat(this.groupId)}BX.PULL.extendWatch(n,true);setTimeout((function(){return e.extendWatch()}),29*60*1e3)}}},{key:"processPullEvent",value:function t(e){var n={user_counter:this.onUserCounter.bind(this),project_counter:this.onProjectCounter.bind(this),comment_read_all:this.onCommentReadAll.bind(this)};var s=Object.prototype.hasOwnProperty;var r=e.command,i=e.params;if(s.call(n,r)){var o=n[r];if(o){o.apply(this,[i])}}}},{key:"bindEvents",value:function t(){s.EventEmitter.subscribe("BX.Main.Filter:apply",this.onFilterApply.bind(this))}},{key:"onFilterApply",value:function t(){var e=this;this.filter.updateFields();if(this.isRoleChanged()){this.updateRole();this.updateCountersData()}else{var n=T(T({},this.myCounters),this.otherCounters);Object.values(n).forEach((function(t){if(t){e.filter.isFilteredByFieldValue(t.filterField,t.filterValue)?t.active():t.unActive()}}))}}},{key:"updateCountersData",value:function e(){var s=this;if(t.updateTimeout){t.needUpdate=true;return}t.updateTimeout=true;t.needUpdate=false;n.ajax.runComponentAction("bitrix:tasks.interface.counters","getCounters",{mode:"class",data:{groupId:this.groupId,role:this.role,counters:this.initialCounterTypes},signedParameters:this.signedParameters}).then((function(t){return s.rerender(t.data)}),(function(t){return console.log(t)}));setTimeout(function(){t.updateTimeout=false;if(t.needUpdate){this.updateCountersData()}}.bind(this),t.timeoutTTL)}},{key:"isRoleChanged",value:function t(){return this.role!==(this.filter.isFilteredByField("ROLEID")?this.filter.fields.ROLEID:"view_all")}},{key:"updateRole",value:function t(){this.role=this.filter.isFilteredByField("ROLEID")?this.filter.fields.ROLEID:"view_all"}},{key:"onCommentReadAll",value:function t(e){this.updateCountersData()}},{key:"onUserCounter",value:function e(n){var s=this;var r=Object.prototype.hasOwnProperty;if(!this.isUserTaskList()||!this.isMyTaskList()||!r.call(n,this.groupId)||this.userId!==Number(n.userId)){this.updateCountersData();return}var i=0;Object.entries(n[this.groupId][this.role]).forEach((function(e){var n=babelHelpers.slicedToArray(e,2),r=n[0],o=n[1];if(s.myCounters[r]){s.myCounters[r].updateCount(o);if(t.counterTypes.comment.includes(r)){i+=o}}else if(s.additionalCounters[r]&&t.counterTypes.comment.includes(r)){i+=o}}));if(i>0){this.$readAllInner.classList.remove("--fade")}if(n.isSonetEnabled!==undefined&&n.isSonetEnabled===false){this.updateCountersData()}}},{key:"onProjectCounter",value:function t(e){if(this.isUserTaskList()){return}this.updateCountersData()}},{key:"getCounterItem",value:function t(e){return new h({count:e.count,name:e.name,type:e.type,color:e.color,filterField:e.filterField,filterValue:e.filterValue,filter:this.filter})}},{key:"getCounterNameByType",value:function e(s){if(t.counterTypes.expired.includes(s)){return n.Loc.getMessage("TASKS_COUNTER_EXPIRED")}else if(t.counterTypes.comment.includes(s)){return n.Loc.getMessage("TASKS_COUNTER_NEW_COMMENTS")}}},{key:"setData",value:function e(n){var s=this;this.myCounters={};this.otherCounters={};this.additionalCounters={};var r=[].concat(babelHelpers.toConsumableArray(t.counterTypes.additional),babelHelpers.toConsumableArray(t.counterTypes.my),babelHelpers.toConsumableArray(t.counterTypes.other));Object.entries(n).forEach((function(e){var n=babelHelpers.slicedToArray(e,2),i=n[0],o=n[1];if(!r.includes(i)){return}var a=s.getCounterItem({type:i,name:s.getCounterNameByType(i),count:Number(o.VALUE),color:o.STYLE,filterField:o.FILTER_FIELD,filterValue:o.FILTER_VALUE});if(t.counterTypes.additional.includes(i)){s.additionalCounters[i]=a}else if(t.counterTypes.my.includes(i)){s.myCounters[i]=a}else if(t.counterTypes.other.includes(i)){s.otherCounters[i]=a}}))}},{key:"isCroppedBlock",value:function t(e){if(e)return e.classList.contains("--cropp")}},{key:"getReadAllBlock",value:function e(){var s=this;var r=T(T(T({},this.myCounters),this.otherCounters),this.additionalCounters);var i=0;Object.entries(r).forEach((function(e){var n=babelHelpers.slicedToArray(e,2),s=n[0],r=n[1];if(t.counterTypes.comment.includes(s)){i+=r.count}}));this.$readAllInner=n.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div data-role="tasks-counters--item-head-read-all" class="tasks-counters--item-head\n\t\t\t\t\t\t',' \n\t\t\t\t\t\t--action \n\t\t\t\t\t\t--read-all">\n\t\t\t\t<div class="tasks-counters--item-head-read-all--icon"></div>\n\t\t\t\t<div class="tasks-counters--item-head-read-all--text">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),i===0?"--fade":"",n.Loc.getMessage("TASKS_COUNTER_READ_ALL"));var o=this.readAllForProjects.bind(this);if(this.isUserTaskList()||this.isProjectsTaskList()&&this.role!=="view_all"){o=this.readAllByRole.bind(this)}else if(this.myCounters["scrum_total_comments"]||this.otherCounters["scrum_foreign_comments"]){o=this.readAllForScrum.bind(this)}n.Event.bind(this.$readAllInner,"click",o);n.Event.bind(this.$readAllInner,"click",(function(){return s.$readAllInner.classList.add("--fade")}));this.$readAll.layout=n.Tag.render(m||(m=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-counters--item">',"</div>\n\t\t"])),this.$readAllInner);return this.$readAll.layout}},{key:"readAllByRole",value:function t(){(new i.Controller).userComments({groupId:this.groupId,userId:this.userId,role:this.role})}},{key:"readAllForProjects",value:function e(){var n=T(T({},this.myCounters),this.otherCounters);Object.entries(n).forEach((function(e){var n=babelHelpers.slicedToArray(e,2),s=n[0],r=n[1];if(t.counterTypes.comment.includes(s)){r.updateCount(0)}}));(new i.Controller).projectComments({groupId:this.groupId})}},{key:"readAllForScrum",value:function e(){var n=T(T({},this.myCounters),this.otherCounters);Object.entries(n).forEach((function(e){var n=babelHelpers.slicedToArray(e,2),s=n[0],r=n[1];if(t.counterTypes.comment.includes(s)){r.updateCount(0)}}));(new i.Controller).scrumComments({groupId:this.groupId})}},{key:"getPopup",value:function t(){var n=this;var s=[];Object.values(this.otherCounters).forEach((function(t){var r=new e.MenuItem({html:t.getPopupMenuItemContainer().innerHTML});r.onclick=n.onPopupItemClick.bind(n,r,t);s.push(r)}));this.popupMenu=new e.Menu({bindElement:this.$moreArrow,className:"tasks-counters--scope",angle:{offset:96},autoHide:true,closeEsc:true,offsetTop:5,offsetLeft:-67,animation:"fading-slide",items:s,events:{onPopupShow:function t(){return n.$more.classList.add("--hover")},onPopupClose:function t(){n.$more.classList.remove("--hover");n.popupMenu.destroy()}}});return this.popupMenu}},{key:"onPopupItemClick",value:function t(e,n){n.adjustClick();this.popupMenu.close()}},{key:"getMoreArrow",value:function t(){if(!this.$moreArrow){this.$moreArrow=n.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="tasks-counters--item-counter-arrow"></div>\n\t\t\t'])))}return this.$moreArrow}},{key:"getMore",value:function t(){var e=this;var s=0;Object.values(this.otherCounters).forEach((function(t){s+=Number(t.count)}));var r=s>99?"99+":s;this.$moreArrow=n.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-counters--item-counter-arrow"></div>\n\t\t'])));this.$more=n.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-counters--item-counter--more">\n\t\t\t\t<div class="tasks-counters--item-counter-wrapper">\n\t\t\t\t\t<div class="tasks-counters--item-counter-title">',':</div>\n\t\t\t\t\t<div class="tasks-counters--item-counter-num">\n\t\t\t\t\t\t',"\t\t\t\t\t\t\n\t\t\t\t\t</div>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),n.Loc.getMessage("TASKS_COUNTER_MORE"),this.getInnerCounter(r),this.$moreArrow);n.Event.bind(this.$more,"click",(function(){return e.getPopup().show()}));return this.$more}},{key:"getInnerCounter",value:function t(e){if(!this.$innerContainer){this.$innerContainer=n.Tag.render(y||(y=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="tasks-counters--item-counter-num-text --stop --without-animate">',"</div>\t\t\n\t\t\t"])),e)}return this.$innerContainer}},{key:"getOther",value:function t(){if(Object.keys(this.otherCounters).length===0){return""}var e=[];Object.values(this.otherCounters).forEach((function(t){return e.push(t.getContainer())}));this.$other.cropped=this.isCroppedBlock(this.$other.layout);this.$other.layout=n.Tag.render(_||(_=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-counters--item --other ','">\n\t\t\t\t<div data-role="tasks-counters--item-head-other" class="tasks-counters--item-head">','</div>\n\t\t\t\t<div class="tasks-counters--item-content">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),this.$other.cropped?"--cropp":"",n.Loc.getMessage("TASKS_COUNTER_OTHER"),e,this.getMore());return this.$other.layout}},{key:"getContainer",value:function t(){var e=[];Object.values(this.myCounters).forEach((function(t){return e.push(t.getContainer())}));this.$myTaskHead=n.Tag.render(k||(k=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-counters--item-head">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"])),n.Loc.getMessage("TASKS_COUNTER_MY"));this.$element=n.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-counters tasks-counters--scope">\n\t\t\t\t<div class="tasks-counters--item">\n\t\t\t\t\t','\n\t\t\t\t\t<div class="tasks-counters--item-content">',"</div>\n\t\t\t\t</div>\n\t\t\t\t","\n\t\t\t\t","\n\t\t\t</div>\n\t\t"])),this.$myTaskHead,e,this.getOther(),this.isUserTaskList()&&!this.isMyTaskList()?"":this.getReadAllBlock());return this.$element}},{key:"rerender",value:function t(e){this.setData(e);this.render()}},{key:"render",value:function t(){var e=this.getContainer();var s=e.cloneNode(true);s.classList.add("task-interface-toolbar");s.style.position="fixed";s.style.opacity="0";s.style.width="auto";s.style.pointerEvents="none";document.body.appendChild(s);this.nodeWidth=s.offsetWidth;document.body.removeChild(s);n.Dom.replace(this.renderTo.firstChild,e)}}]);return t}();babelHelpers.defineProperty(E,"updateTimeout",false);babelHelpers.defineProperty(E,"needUpdate",false);babelHelpers.defineProperty(E,"timeoutTTL",5e3);t.Counters=E})(this.BX.Tasks.Counters=this.BX.Tasks.Counters||{},BX.Main,BX,BX.Event,BX.UI.Analytics,BX.Tasks.Viewed);
//# sourceMappingURL=script.map.js