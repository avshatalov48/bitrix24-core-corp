"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetReplication!="undefined"){return}var e=BX.Tasks.Util.Widget.extend({sys:{code:"timepicker"},options:{value:"",inputId:"",controlBind:"class"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);this.bindDelegateControl("display","click",this.openClock.bind(this));this.vars.formatDisplay=BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME").replace(BX.message("FORMAT_DATE"),"").replace(":SS","").replace("/SS","").trim());this.vars.formatValue=BX.date.convertBitrixFormat("HH:MI");this.setTime(this.parseTime(this.option("value")));BX.bind(BX(this.option("inputId")),"change",this.passCtx(this.onTimeChange))},openClock:function(){var e="bxShowClock_"+this.option("inputId");if(BX.type.isFunction(window[e])){window[e].call(window)}},onTimeChange:function(e){var t=this.parseTime(e.value);this.setTime(t);this.fireEvent("change",[t])},setTime:function(e){var t=3600*e.h+60*e.m;this.control("display").value=this.dateStampToString(t,this.vars.formatDisplay);this.control("value").value=this.dateStampToString(t,this.vars.formatValue)},parseTime:function(e){var t=e.toString().trim();var a=0;var i=0;var n=t.match(new RegExp("^(\\d{1,2})[^\\d]+(\\d{2})","i"));if(n){a=n[1]?parseInt(n[1]):0;i=n[2]?parseInt(n[2]):0}n=t.match(new RegExp("(am|pm)","i"));var s=n&&n[1];var r=s&&n[1].toLowerCase()=="pm";if(!isNaN(a)&&!isNaN(i)&&(a>=0&&a<=23)&&(i>=0&&i<=59)){if(s){if(r){if(a!=12){a+=12}}else{if(a==12){a=0}}}return{h:a,m:i}}return false},dateStampToString:function(e,t){return BX.date.format(t,new Date(e*1e3),false,true)}}});BX.Tasks.Component.TasksWidgetReplication=BX.Tasks.Component.extend({sys:{code:"replication"},options:{data:false},constants:{PERIOD_DAILY:"daily",PERIOD_WEEKLY:"weekly",PERIOD_MONTHLY:"monthly",PERIOD_YEARLY:"yearly",REPEAT_TILL_ENDLESS:"endless",REPEAT_TILL_TIMES:"times",REPEAT_TILL_DATE:"date",MONDAY:0,TUESDAY:1,THURSDAY:3,SUNDAY:6},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);this.vars.prevPeriod=this.getCurrentPeriod();this.onPeriodChange()},getStartDate:function(){return this.subInstance("start-date-datepicker",function(){return new BX.Tasks.Util.DatePicker({scope:this.control("start-date-datepicker"),controlBind:"class",displayFormat:"system-short",defaultTime:{H:0,M:0,S:0}})})},getEndDate:function(){return this.subInstance("end-date-datepicker",function(){return new BX.Tasks.Util.DatePicker({scope:this.control("end-date-datepicker"),controlBind:"class",displayFormat:"system-short",defaultTime:{H:0,M:0,S:0}})})},getTime:function(){return this.subInstance("creation-time",function(){return new e({scope:this.control("timepicker"),inputId:this.option("timerId"),value:this.option("data").TIME})})},bindEvents:function(){var e=BX.delegate(this.onUpdateHint,this);this.bindDelegateControl("period-type","change",BX.delegate(this.onPeriodChange,this));this.bindDelegateControl("period-type-option","click",this.passCtx(this.onSetPeriodValue));this.bindDelegateControl("day-type","change",e);BX.bindDelegate(this.scope(),"change",{tag:"select"},e);BX.bindDelegate(this.scope(),"change",{tag:"input",attr:{type:"checkbox"}},e);BX.bindDelegate(this.scope(),"change",{tag:"input",attr:{type:"radio"}},e);BX.Tasks.Util.bindInstantChange(this.control("every-day"),e);BX.Tasks.Util.bindInstantChange(this.control("daily-month-interval"),e);BX.Tasks.Util.bindInstantChange(this.control("every-week"),e);BX.Tasks.Util.bindInstantChange(this.control("monthly-day-num"),e);BX.Tasks.Util.bindInstantChange(this.control("monthly-month-num-1"),e);BX.Tasks.Util.bindInstantChange(this.control("monthly-month-num-2"),e);BX.Tasks.Util.bindInstantChange(this.control("yearly-day-num"),e);BX.Tasks.Util.bindInstantChange(this.control("times"),e);this.getStartDate().bindEvent("change",e);this.getEndDate().bindEvent("change",e);this.getTime().bindEvent("change",e);BX.Tasks.Util.hintManager.bindHelp(this.scope())},getCurrentPeriod:function(){return this.getValueString("period-type")},onSetPeriodValue:function(e){var t=BX.data(e,"type");if(BX.util.in_array(t,[this.PERIOD_DAILY,this.PERIOD_WEEKLY,this.PERIOD_MONTHLY,this.PERIOD_YEARLY])){this.control("period-type").value=t;this.onPeriodChange()}},setConstraintPanelHeight:function(e){var t=this.control("panel-"+e);if(t){var a=BX.pos(t).height;this.control("panel").style.height=a+"px"}},onPeriodChange:function(){var e=this.getCurrentPeriod();this.dropCSSFlags("period-*");this.setCSSFlag("period-"+BX.util.htmlspecialchars(e));if(this.vars.prevPeriod!=e){var t=this.control("panel-"+this.vars.prevPeriod);var a=this.control("panel-"+e);if(t&&a){this.setConstraintPanelHeight(this.vars.prevPeriod);BX.addClass(t,"nodisplay");BX.removeClass(a,"nodisplay");this.setConstraintPanelHeight(e);this.vars.prevPeriod=e}}this.onUpdateHint()},onUpdateHint:function(){var e=this.control("hint");if(!e){return}var t=this.parseTime(this.getValueString("time"));var a={PERIOD:this.getValueString("period-type"),EVERY_DAY:this.getValueInt("every-day"),WORKDAY_ONLY:this.getValueString("day-type"),DAILY_MONTH_INTERVAL:this.getValueInt("daily-month-interval"),EVERY_WEEK:this.getValueInt("every-week"),WEEK_DAYS:this.getWeekDays(-1),MONTHLY_DAY_NUM:this.getValueInt("monthly-day-num"),MONTHLY_MONTH_NUM_1:this.getValueInt("monthly-month-num-1"),MONTHLY_TYPE:this.getCheckedControlValues("monthly-type")[0],MONTHLY_WEEK_DAY_NUM:this.getValueInt("monthly-week-day-num"),MONTHLY_WEEK_DAY:this.getValueInt("monthly-week-day"),MONTHLY_MONTH_NUM_2:this.getValueInt("monthly-month-num-2"),YEARLY_TYPE:this.getCheckedControlValues("yearly-type")[0],YEARLY_DAY_NUM:this.getValueInt("yearly-day-num"),YEARLY_MONTH_1:this.getValueInt("yearly-month-1"),YEARLY_WEEK_DAY_NUM:this.getValueInt("yearly-week-day-num"),YEARLY_WEEK_DAY:this.getValueInt("yearly-week-day"),YEARLY_MONTH_2:this.getValueInt("yearly-month-2"),START_DATE:this.getStartDate().getValue(),END_DATE:this.getEndDate().getValue(),TIME:t==""?"05:00":t,TIMES:this.getValueInt("times"),REPEAT_TILL:this.getRepeatTill()};e.innerHTML=this.makeHintText(a)},makeHintText:function(e){var t=parseInt(this.option("tzOffset"));var a=BX.message("TASKS_TTDP_REPLICATION_HINT_AT_TIME").replace("#TIME#",e.TIME+" (UTC "+(t>0?"+":"")+BX.Tasks.Util.formatTimeAmount(t,"HH:MI")+")");if(e.PERIOD==this.PERIOD_DAILY){var i=e.EVERY_DAY;a+=BX.message("TASKS_TTDP_REPLICATION_DAILY_EXT").replace("#NUMBER#",i>1?" "+i:"").replace("#DAY_TYPE#",e.WORK_DAY=="Y"?" "+BX.message("TASKS_TTDP_REPLICATION_DAILY_WORK"):"");var n=e.DAILY_MONTH_INTERVAL;if(n>0){a+=BX.message("TASKS_TTDP_REPLICATION_HINT_DAILY_MONTH_INTERVAL").replace("#TIMES#",n).replace("#TIMES_PLURAL#",BX.Tasks.Util.getMessagePlural(n,"TASKS_TTDP_REPLICATION_HINT_DAILY_MONTH_INTERVAL"))}}else if(e.PERIOD==this.PERIOD_WEEKLY){var s=e.EVERY_WEEK;a+=BX.message("TASKS_TTDP_REPLICATION_WEEKLY_EXT").replace("#NUMBER#",s>1?" "+s:"");var r="";if(e.WEEK_DAYS.length==7){r=BX.message("TASKS_TTDP_REPLICATION_EVERY_DAY")}else{r=[];for(var T=0;T<e.WEEK_DAYS.length;T++){r.push(BX.message("TASKS_TTDP_REPLICATION_WD_"+e.WEEK_DAYS[T]))}r=r.join(", ")}a+=" ("+r+")"}else if(e.PERIOD==this.PERIOD_MONTHLY){if(e.MONTHLY_TYPE==1){var s=e.MONTHLY_DAY_NUM;var o=e.MONTHLY_MONTH_NUM_1;a+=BX.message("TASKS_TTDP_REPLICATION_MONTHLY_EXT_TYPE_1").replace("#DAY_NUMBER#",s).replace("#MONTH_NUMBER#",o>1?" "+o:"")}else{var _=this.getWeekDayGender(e.MONTHLY_WEEK_DAY);var l=this.getWeekDayName(e.MONTHLY_WEEK_DAY);var s=BX.message("TASKS_TTDP_REPLICATION_NUMBER_"+e.MONTHLY_WEEK_DAY_NUM+_);var E=BX.message("TASKS_TTDP_REPLICATION_EACH"+this.getWeekDayGender(e.MONTHLY_WEEK_DAY));var o=e.MONTHLY_MONTH_NUM_2;a+=BX.message("TASKS_TTDP_REPLICATION_MONTHLY_EXT_TYPE_2").replace("#EACH#",E).replace("#DAY_NUMBER#",s).replace("#WEEKDAY_NAME#",l).replace("#MONTH_NUMBER#",o>1?" "+o:"")}}else{if(e.YEARLY_TYPE==1){var s=e.YEARLY_DAY_NUM;var h=BX.message("TASKS_TTDP_REPLICATION_MONTH_"+e.YEARLY_MONTH_1);a+=BX.message("TASKS_TTDP_REPLICATION_YEARLY_EXT_TYPE_1").replace("#DAY_NUMBER#",s).replace("#MONTH_NAME#",h)}else{var _=this.getWeekDayGender(e.YEARLY_WEEK_DAY);var l=this.getWeekDayName(e.YEARLY_WEEK_DAY);var s=BX.message("TASKS_TTDP_REPLICATION_NUMBER_"+e.YEARLY_WEEK_DAY_NUM+_);var E=BX.message("TASKS_TTDP_REPLICATION_EACH"+this.getWeekDayGender(e.YEARLY_WEEK_DAY));var h=BX.message("TASKS_TTDP_REPLICATION_MONTH_"+e.YEARLY_MONTH_2);a+=BX.message("TASKS_TTDP_REPLICATION_YEARLY_EXT_TYPE_2").replace("#EACH#",E).replace("#DAY_NUMBER#",s).replace("#WEEKDAY_NAME#",l).replace("#MONTH_NAME#",h)}}var A="";var I=e.TIMES;if(e.START_DATE!=""){var c=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATE")),BX.parseDate(e.START_DATE,true),false,true);A+=BX.message("TASKS_TTDP_REPLICATION_HINT_START_CONSTRAINT").replace("#DATETIME#",c)}else{A+=BX.message("TASKS_TTDP_REPLICATION_HINT_START_CONSTRAINT_NONE")}var g=this.getRepeatTill();var u=true;if(e.END_DATE!=""&&g==this.REPEAT_TILL_DATE){var N=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATE")),BX.parseDate(e.END_DATE,true),false,true);A+=BX.message("TASKS_TTDP_REPLICATION_HINT_END_CONSTRAINT").replace("#DATETIME#",N);u=false}else if(I>0&&g==this.REPEAT_TILL_TIMES){A+=BX.message("TASKS_TTDP_REPLICATION_HINT_END_CONSTRAINT_TIMES").replace("#TIMES#",I).replace("#TIMES_PLURAL#",BX.Tasks.Util.getMessagePlural(I,"TASKS_TTDP_REPLICATION_HINT_END_CONSTRAINT_TIMES"));u=false}if(u){A+=BX.message("TASKS_TTDP_REPLICATION_HINT_END_CONSTRAINT_NONE")}return BX.message("TASKS_TTDP_REPLICATION_HINT_BASE").replace("#CONDITION#",a).replace("#CONSTRAINT#",A)},getWeekDayName:function(e){var t=this.getWeekDayGender(e);return BX.message("TASKS_TTDP_REPLICATION_WD_"+e+(t=="_F"?"_ALT":""))},getValueString:function(e){var t=this.control(e);if(BX.type.isElementNode(t)){return BX.util.htmlspecialchars(t.value.toString())}return""},getValueInt:function(e){var t=this.control(e);if(BX.type.isElementNode(t)){var a=parseInt(t.value.toString());if(isNaN(a)){return 0}return a}return 0},getCheckedControlValues:function(e){var t=[];var a=this.controlAll(e);for(var i in a){if(a[i].checked){t.push(a[i].value)}}return t},parseTime:function(e){e=e.toString().replace(/^\s+/,"").replace(/\s+$/,"");if(e.length>0){var t=e.match(/^(\d{1,2}):(\d{1,2})$/);if(t===null){return""}var a=parseInt(t[1]);var i=parseInt(t[2]);if(a>23||i>59){return""}var n=function(e){e=e.toString();if(e.length==1){return"0"+e}return e};return n(a)+":"+n(i)}return e},getRepeatTill:function(){var e=this.getCheckedControlValues("repeat-till");if(typeof e[0]=="undefined"){return this.REPEAT_TILL_ENDLESS}return e[0]},getWeekDays:function(e){var t=this.getCheckedControlValues("week-days");if(t.length==0){t.push(this.MONDAY)}else{for(var a=0;a<t.length;a++){t[a]=parseInt(t[a])+e}}return t},getWeekDayGender:function(e){if(e==this.MONDAY||e==this.TUESDAY||e==this.THURSDAY){return"_M"}if(e==this.SUNDAY){return""}return"_F"}}})}).call(this);