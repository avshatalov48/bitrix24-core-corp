this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(e,t,n,i,s,r,o){"use strict";var a=function e(){babelHelpers.classCallCheck(this,e)};babelHelpers.defineProperty(a,"SHOW_BY_HOVER","main-grid-cell-content-action-by-hover");babelHelpers.defineProperty(a,"ACTIVE","main-grid-cell-content-action-active");var u=o.Reflection.namespace("BX.Grid");u.CellActionState=a;var c=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"setOptions",value:function t(n){e.options=n}},{key:"setActionsPanel",value:function t(n){e.actionsPanel=n}},{key:"doAction",value:function t(n,i){return new Promise(function(t,s){BX.ajax.runComponentAction("bitrix:tasks.projects","processAction",{mode:"class",data:{action:n,ids:e.getActionIds(i)||[]},signedParameters:e.options.signedParameters}).then(function(){return t()},function(){return s()}).catch(function(){return s()});e.hideActionsPanel();e.unselectRows()})}},{key:"getActionIds",value:function t(n){if(n!==undefined){return[n]}var i=e.getSelectedRows();if(i.length===0){return[]}return i.map(function(e){return e.getDataset().id})}},{key:"getSelectedRows",value:function t(){return e.getGridInstance().getRows().getSelected()}},{key:"sendJoinRequest",value:function t(n){if(o.Dom.hasClass(n,"ui-btn-clock")){return}o.Dom.addClass(n,"ui-btn-clock");BX.ajax({url:n.getAttribute("bx-request-url"),method:"POST",dataType:"json",data:{ajax_request:"Y",save:"Y",sessid:BX.bitrix_sessid()},onsuccess:function e(){return o.Dom.removeClass(n,"ui-btn-clock")},onfailure:function e(){return o.Dom.removeClass(n,"ui-btn-clock")}});e.hideActionsPanel();e.unselectRows()}},{key:"sendAcceptRequest",value:function t(n,i){BX.ajax({url:i,method:"POST",dataType:"json",data:{action:"accept",max_count:1,checked_0:"Y",type_0:"INVITE_GROUP",id_0:n,type:"in",ajax_request:"Y",sessid:BX.bitrix_sessid()},onsuccess:function e(t){},onfailure:function e(t){return console.log(t)}});e.hideActionsPanel();e.unselectRows()}},{key:"sendDenyRequest",value:function t(n,i){e.sendCancelRequest(n,i)}},{key:"sendCancelRequest",value:function t(n,i){BX.ajax({url:i,method:"POST",dataType:"json",data:{action:"reject",max_count:1,checked_0:"Y",type_0:"INVITE_GROUP",id_0:n,type:"out",ajax_request:"Y",sessid:BX.bitrix_sessid()},onsuccess:function e(t){},onfailure:function e(t){return console.log(t)}});e.hideActionsPanel();e.unselectRows()}},{key:"hideActionsPanel",value:function t(){e.options.actionsPanel.hidePanel()}},{key:"unselectRows",value:function t(){e.getGridInstance().getRows().unselectAll()}},{key:"getGridInstance",value:function t(){return BX.Main.gridManager.getById(e.options.gridId).instance}},{key:"changePin",value:function t(n){var i=n.getData(),s=i.button,r=i.row;if(o.Dom.hasClass(s,a.ACTIVE)){e.doAction("unpin",r.getId()).then(function(){o.Dom.removeClass(s,a.ACTIVE);o.Dom.addClass(s,a.SHOW_BY_HOVER)})}else{e.doAction("pin",r.getId()).then(function(){o.Dom.addClass(s,a.ACTIVE);o.Dom.removeClass(s,a.SHOW_BY_HOVER)})}}},{key:"onCounterClick",value:function t(n){var i=n.getData(),s=i.row;BX.SidePanel.Instance.open(e.options.groupTaskPath.replace("#group_id#",s.getId()))}}]);return e}();var l=function(){function e(t){babelHelpers.classCallCheck(this,e);this.filter=BX.Main.filterManager.getById(t.filterId);this.init();this.bindEvents()}babelHelpers.createClass(e,[{key:"init",value:function e(){this.updateFields()}},{key:"bindEvents",value:function e(){s.EventEmitter.subscribe("BX.Main.Filter:apply",this.onFilterApply.bind(this));s.EventEmitter.subscribe("Tasks.Toolbar:onItem",this.onCounterClick.bind(this))}},{key:"onFilterApply",value:function e(){this.updateFields()}},{key:"updateFields",value:function e(){this.fields=this.filter.getFilterFieldsValues()}},{key:"onCounterClick",value:function e(t){var n=t.getData();if(n.counter&&n.counter.filter){this.toggleByField(babelHelpers.defineProperty({},n.counter.filterField,n.counter.filterValue))}}},{key:"isFilteredByField",value:function e(t){if(!Object.keys(this.fields).includes(t)){return false}if(o.Type.isArray(this.fields[t])){return this.fields[t].length>0}return this.fields[t]!==""}},{key:"isFilteredByFieldValue",value:function e(t,n){return this.isFilteredByField(t)&&this.fields[t]===n}},{key:"toggleByField",value:function e(t){var n=this;var i=Object.keys(t)[0];var s=t[i];if(!this.isFilteredByFieldValue(i,s)){this.filter.getApi().extendFilter(babelHelpers.defineProperty({},i,s));return}this.filter.getFilterFields().forEach(function(e){if(e.getAttribute("data-name")===i){n.filter.getFields().deleteField(e)}});this.filter.getSearch().apply()}}]);return e}();var d,h,p,f;var v=function(){babelHelpers.createClass(e,null,[{key:"titles",get:function e(){return{heads:o.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_TITLE_HEADS"),members:o.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_TITLE_MEMBERS")}}}]);function e(t){babelHelpers.classCallCheck(this,e);this.signedParameters=t.signedParameters}babelHelpers.createClass(e,[{key:"show",value:function e(t,n,s){var r=this;if(this.isPopupShown){this.popup.destroy()}this.currentPage=1;this.innerContainer="";this.renderedUsers=[];this.popup=i.PopupWindowManager.create({id:"projects-members-popup-menu",className:"tasks-projects-members-popup",bindElement:s,autoHide:true,closeByEsc:true,lightShadow:true,bindOptions:{position:"bottom"},animationOptions:{show:{type:"opacity-transform"},close:{type:"opacity"}},events:{onPopupDestroy:function e(){r.loader=null;r.isPopupShown=false},onPopupClose:function e(){r.popup.destroy()},onAfterPopupShow:function e(i){var s=r.renderContainer(n);var o=s.querySelector(".tasks-projects-members-popup-content");r.innerContainer=s.querySelector(".tasks-projects-members-popup-inner");i.contentContainer.appendChild(s);r.showLoader(o);r.showUsers(t,n);r.isPopupShown=true}}});this.popupScroll(t,n);this.popup.show()}},{key:"renderContainer",value:function t(n){return o.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div>\n\t\t\t\t<span class="tasks-projects-members-popup-name-title">\n\t\t\t\t\t','\n\t\t\t\t</span>\n\t\t\t\t<div class="tasks-projects-members-popup-container">\n\t\t\t\t\t<div class="tasks-projects-members-popup-content">\n\t\t\t\t\t\t<div class="tasks-projects-members-popup-content-box">\n\t\t\t\t\t\t\t<div class="tasks-projects-members-popup-inner"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),e.titles[n])}},{key:"popupScroll",value:function e(t,n){var i=this;if(!BX.type.isDomNode(this.innerContainer)){return}o.Event.bind(this.innerContainer,"scroll",function(e){var s=e.target;if(s.scrollTop>(s.scrollHeight-s.offsetHeight)/1.5){i.showUsers(t,n);o.Event.unbindAll(i.innerContainer)}})}},{key:"showUsers",value:function e(t,n){var i=this;BX.ajax.runComponentAction("bitrix:tasks.projects","getPopupMembers",{mode:"class",data:{groupId:t,type:n,page:this.currentPage},signedParameters:this.signedParameters}).then(function(e){if(e.data){i.currentPage++;i.renderUsers(e.data);i.popupScroll(t,n)}else if(!i.innerContainer.hasChildNodes()){i.innerContainer.innerText=o.Loc.getMessage("TASKS_PROJECTS_MEMBERS_POPUP_EMPTY")}i.hideLoader()},function(){return i.hideLoader()})}},{key:"renderUsers",value:function e(t){var n=this;Object.values(t).forEach(function(e){if(n.renderedUsers.indexOf(e.ID)>=0){return}n.renderedUsers.push(e.ID);n.innerContainer.appendChild(o.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<a class="tasks-projects-members-popup-item" href="','" target="_blank">\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-avatar-new">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t<span class="tasks-projects-members-popup-avatar-status-icon"></span>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<span class="tasks-projects-members-popup-name">',"</span>\n\t\t\t\t\t</a>\n\t\t\t\t"])),e["HREF"],n.getAvatar(e),e["FORMATTED_NAME"]))})}},{key:"getAvatar",value:function e(t){if(o.Type.isStringFilled(t["PHOTO"])){return o.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-icon ui-icon-common-user tasks-projects-members-popup-avatar-img">\n\t\t\t\t\t<i style="background-image: url(\'',"')\"></i>\n\t\t\t\t</div>\n\t\t\t"])),t["PHOTO"])}return o.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-icon ui-icon-common-user tasks-projects-members-popup-avatar-img"><i></i></div>\n\t\t'])))}},{key:"showLoader",value:function e(t){if(!this.loader){this.loader=new n.Loader({target:t,size:40})}void this.loader.show()}},{key:"hideLoader",value:function e(){if(this.loader){void this.loader.hide();this.loader=null}}}]);return e}();var g=function(){babelHelpers.createClass(e,null,[{key:"classes",get:function e(){return{highlighted:"task-projects-item-highlighted",pinned:"tasks-projects-row-pinned"}}}]);function e(t){babelHelpers.classCallCheck(this,e);this.pageSize=10;this.grid=BX.Main.gridManager.getInstanceById(t.gridId);this.stub=t.gridStub;this.sort=t.sort;this.actionsPanel=t.actionsPanel;this.eventsToEmit=t.eventsToEmit||{};this.items=new Map;this.fillItems(t.items);this.bindEvents();this.colorPinnedRows()}babelHelpers.createClass(e,[{key:"bindEvents",value:function e(){s.EventEmitter.subscribe("BX.Main.grid:sort",this.onColumnSort.bind(this));s.EventEmitter.subscribe("BX.Main.grid:paramsUpdated",this.onParamsUpdated.bind(this))}},{key:"onColumnSort",value:function e(t){var n=t.getData();var i=n[1];var s=n[0];if(i===this.grid){this.sort={};this.sort[s.sort_by]=s.sort_order}}},{key:"onParamsUpdated",value:function e(){var t=this.getRows().map(function(e){return e.getId()}).filter(function(e){return e!=="template_0"});var n=t.reduce(function(e,t){return babelHelpers.objectSpread({},e,babelHelpers.defineProperty({},t,null))},{});this.clearItems();this.fillItems(n);this.colorPinnedRows()}},{key:"addRow",value:function e(t,n,i){var r={id:t,columns:n.content,actions:n.actions,cellActions:n.cellActions,counters:n.counters};var a=i.moveParams||{};if(a.rowBefore){r.insertAfter=a.rowBefore}else if(a.rowAfter){r.insertBefore=a.rowAfter}else{r.append=true}if(this.items.size>this.getCurrentPage()*this.pageSize){var u=this.getLastRowId();this.removeItem(u);o.Dom.remove(this.getRowNodeById(u));this.showMoreButton()}this.hideStub();this.getRealtime().addRow(r);this.colorPinnedRows();if(this.eventsToEmit.onProjectGridRowAdd){s.EventEmitter.emit("Tasks.Projects.Grid:RowAdd",{id:t})}}},{key:"updateRow",value:function e(t,n,i){var s=this;var r=this.getRowById(t);r.setCellsContent(n.content);r.setActions(n.actions);r.setCellActions(n.cellActions);r.setCounters(n.counters);this.resetRows();this.moveRow(t,i.moveParams||{});this.highlightRow(t,i.highlightParams||{}).then(function(){return s.colorPinnedRows()},function(){});this.grid.bindOnRowEvents()}},{key:"removeRow",value:function e(t){if(!this.isRowExist(t)){return}this.grid.removeRow(t)}},{key:"moveRow",value:function e(t,n){if(n.skip){return}var i=n.rowBefore||0;var s=n.rowAfter||0;if(i){this.grid.getRows().insertAfter(t,i)}else if(s){this.grid.getRows().insertBefore(t,s)}}},{key:"highlightRow",value:function t(n,i){var s=this;i=i||{};return new Promise(function(t,r){if(!s.isRowExist(n)){r();return}if(i.skip){t();return}var a=s.getRowNodeById(n);var u=o.Dom.hasClass(a,e.classes.pinned);if(u){o.Dom.removeClass(a,e.classes.pinned)}o.Dom.addClass(a,e.classes.highlighted);setTimeout(function(){o.Dom.removeClass(a,e.classes.highlighted);if(u){o.Dom.addClass(a,e.classes.pinned)}t()},900)})}},{key:"colorPinnedRows",value:function t(){var n=this;this.getRows().forEach(function(t){var i=t.getNode();n.getIsPinned(t.getId())?o.Dom.addClass(i,e.classes.pinned):o.Dom.removeClass(i,e.classes.pinned)})}},{key:"resetRows",value:function e(){this.grid.getRows().reset()}},{key:"getRows",value:function e(){return this.grid.getRows().getBodyChild()}},{key:"getFirstRowId",value:function e(){var t=this.grid.getRows().getBodyFirstChild();return t?this.getRowProperty(t,"id"):0}},{key:"getLastRowId",value:function e(){var t=this.grid.getRows().getBodyLastChild();return t?this.getRowProperty(t,"id"):0}},{key:"getLastPinnedRowId",value:function e(){var t=this;var n=Object.values(this.getRows()).filter(function(e){return t.getIsPinned(e.getId())});var i=Object.keys(n);if(i.length>0){return n[i[i.length-1]].getId()}return 0}},{key:"getIsPinned",value:function e(t){return this.isRowExist(t)&&o.Type.isDomNode(this.getRowNodeById(t).querySelector(".main-grid-cell-content-action-pin.main-grid-cell-content-action-active"))}},{key:"getRowProperty",value:function e(t,n){return BX.data(t.getNode(),n)}},{key:"getRowById",value:function e(t){return this.grid.getRows().getById(t)}},{key:"getRowNodeById",value:function e(t){return this.getRowById(t).getNode()}},{key:"isRowExist",value:function e(t){return this.getRowById(t)!==null}},{key:"getCurrentPage",value:function e(){var t=this.grid.getContainer().querySelector(".modern-page-current");return t?t.innerText:1}},{key:"isActivityRealtimeMode",value:function e(){return this.sort.ACTIVITY_DATE&&this.sort.ACTIVITY_DATE==="desc"}},{key:"getItems",value:function e(){return Array.from(this.items.keys())}},{key:"hasItem",value:function e(t){return this.items.has(parseInt(t,10))}},{key:"addItem",value:function e(t){this.items.set(parseInt(t,10))}},{key:"removeItem",value:function e(t){this.items.delete(parseInt(t,10))}},{key:"fillItems",value:function e(t){var n=this;Object.keys(t).forEach(function(e){return n.addItem(e)})}},{key:"clearItems",value:function e(){this.items.clear()}},{key:"getRealtime",value:function e(){return this.grid.getRealtime()}},{key:"showStub",value:function e(){if(this.stub){this.getRealtime().showStub({content:this.stub})}}},{key:"hideStub",value:function e(){this.grid.hideEmptyStub()}},{key:"showMoreButton",value:function e(){this.grid.getMoreButton().getNode().style.display="inline-block"}},{key:"hideMoreButton",value:function e(){this.grid.getMoreButton().getNode().style.display="none"}}]);return e}();var m=function(){babelHelpers.createClass(e,null,[{key:"events",get:function e(){return{add:"add",update:"update",remove:"remove",userAdd:"userAdd",userUpdate:"userUpdate",userRemove:"userRemove",pinChanged:"pinChanged"}}},{key:"counterEvents",get:function e(){return["onAfterTaskAdd","onAfterTaskDelete","onAfterTaskRestore","onAfterTaskView","onAfterTaskMute","onAfterCommentAdd","onAfterCommentDelete","onProjectPermUpdate"]}},{key:"movingProjectEvents",get:function e(){return["onAfterTaskAdd","onAfterCommentAdd"]}}]);function e(t){babelHelpers.classCallCheck(this,e);this.signedParameters=t.signedParameters;this.grid=new g(t);this.timer=null;this.counterData=new Map;this.userOptions=t.userOptions}babelHelpers.createClass(e,[{key:"getModuleId",value:function e(){return"tasks"}},{key:"getMap",value:function e(){return{project_add:this.onProjectAdd.bind(this),project_update:this.onProjectUpdate.bind(this),project_remove:this.onProjectRemove.bind(this),project_user_add:this.onProjectUserAdd.bind(this),project_user_update:this.onProjectUserUpdate.bind(this),project_user_remove:this.onProjectUserRemove.bind(this),project_user_option_changed:this.onProjectUserOptionChanged.bind(this),project_counter:this.onProjectCounter.bind(this),project_read_all:this.onProjectCommentsReadAll.bind(this),comment_read_all:this.onProjectCommentsReadAll.bind(this)}}},{key:"onProjectAdd",value:function t(n){var i=this;var s={event:e.events.add,moveParams:{rowBefore:this.grid.getLastPinnedRowId(),rowAfter:this.grid.getFirstRowId()}};this.checkExistence(n.ID).then(function(e){return i.onCheckExistenceSuccess(e,n.ID,s)},function(e){return console.error(e)})}},{key:"onProjectUpdate",value:function t(n){var i=this;var s={event:e.events.update};this.checkExistence(n.ID).then(function(e){return i.onCheckExistenceSuccess(e,n.ID,s)},function(e){return console.error(e)})}},{key:"onProjectRemove",value:function e(t){this.removeRow(t.ID)}},{key:"onProjectUserAdd",value:function t(n){var i=this;var s={event:e.events.userAdd};this.checkExistence(n.GROUP_ID).then(function(e){return i.onCheckExistenceSuccess(e,n.GROUP_ID,s)},function(e){return console.error(e)})}},{key:"onProjectUserUpdate",value:function t(n){var i=this;var s={event:e.events.userUpdate};this.checkExistence(n.GROUP_ID).then(function(e){return i.onCheckExistenceSuccess(e,n.GROUP_ID,s)},function(e){return console.error(e)})}},{key:"onProjectUserRemove",value:function t(n){var i=this;var s={event:e.events.userRemove};this.checkExistence(n.GROUP_ID).then(function(e){return i.onCheckExistenceSuccess(e,n.GROUP_ID,s)},function(e){return console.error(e)})}},{key:"onProjectUserOptionChanged",value:function e(t){switch(t.OPTION){case this.userOptions.pinned:this.onProjectPinChanged(t);break;default:break}}},{key:"onProjectPinChanged",value:function t(n){var i={event:e.events.pinChanged};this.moveToDirectPlace(n.PROJECT_ID,null,i)}},{key:"onProjectCounter",value:function t(n){var i=this;var s=n.GROUP_ID;var r=n.EVENT;if(!e.counterEvents.includes(r)){return}if(!this.timer){this.timer=setTimeout(function(){i.freeCounterQueue()},1e3)}if(e.movingProjectEvents.includes(r)||!this.counterData.has(s)){this.counterData.set(s,r)}}},{key:"freeCounterQueue",value:function t(){var n=this;this.counterData.forEach(function(t,i){var s={event:t,highlightParams:{skip:true}};if(e.movingProjectEvents.includes(t)){s.moveParams={rowBefore:n.grid.getIsPinned(i)?0:n.grid.getLastPinnedRowId(),rowAfter:n.grid.getFirstRowId()};s.highlightParams={skip:false}}n.checkExistence(i).then(function(e){return n.onCheckExistenceSuccess(e,i,s)},function(e){return console.error(e)})});this.counterData.clear();this.timer=null}},{key:"onProjectCommentsReadAll",value:function e(t){var n=t.GROUP_ID;if(n){if(this.grid.isRowExist(n)){this.updateCounter([n])}}else{this.updateCounter(this.grid.getItems())}}},{key:"checkExistence",value:function e(t){var n=this;return new Promise(function(e,i){BX.ajax.runComponentAction("bitrix:tasks.projects","checkExistence",{mode:"class",data:{groupIds:[t]},signedParameters:n.signedParameters}).then(function(t){return e(t)},function(e){return i(e)})})}},{key:"onCheckExistenceSuccess",value:function t(n,i,s){if(n.data[i]===false){this.removeRow(i);return}var r=n.data[i];if(this.grid.isRowExist(i)){this.grid.isActivityRealtimeMode()?this.updateRow(i,r,s):this.moveToDirectPlace(i,r,s)}else if(this.grid.isActivityRealtimeMode()&&(e.movingProjectEvents.includes(s.event)||s.event===e.events.add)){this.updateItem(i,r,s)}else{this.moveToDirectPlace(i,r,s)}}},{key:"updateItem",value:function e(t,n,i){if(!this.grid.hasItem(t)){this.grid.addItem(t);this.addRow(t,n,i)}else{this.updateRow(t,n,i)}}},{key:"addRow",value:function e(t,n,i){var s=this;if(this.grid.isRowExist(t)){return}BX.ajax.runComponentAction("bitrix:tasks.projects","prepareGridRows",{mode:"class",data:{groupIds:[t],data:n?babelHelpers.defineProperty({},t,n):null},signedParameters:this.signedParameters}).then(function(e){return s.grid.addRow(t,e.data[t],i)})}},{key:"updateRow",value:function e(t,n,i){var s=this;if(!this.grid.isRowExist(t)){return}BX.ajax.runComponentAction("bitrix:tasks.projects","prepareGridRows",{mode:"class",data:{groupIds:[t],data:n?babelHelpers.defineProperty({},t,n):null},signedParameters:this.signedParameters}).then(function(e){return s.grid.updateRow(t,e.data[t],i)})}},{key:"removeRow",value:function e(t){this.grid.removeItem(t);this.grid.removeRow(t)}},{key:"moveToDirectPlace",value:function e(t,n,i){var s=this;i=i||{};BX.ajax.runComponentAction("bitrix:tasks.projects","findProjectPlace",{mode:"class",data:{groupId:t,currentPage:this.grid.getCurrentPage()},signedParameters:this.signedParameters}).then(function(e){var r=e.data,o=r.projectBefore,a=r.projectAfter;if(o===false&&a===false){s.removeRow(t)}else{if(o&&s.grid.isRowExist(o)||a&&s.grid.isRowExist(a)){i.moveParams={rowBefore:o,rowAfter:a}}else{i.moveParams={skip:true}}s.updateItem(t,n,i)}})}},{key:"updateCounter",value:function e(t){var n=this;BX.ajax.runComponentAction("bitrix:tasks.projects","prepareGridRows",{mode:"class",data:{groupIds:t,data:null},signedParameters:this.signedParameters}).then(function(e){var t=e.data;if(t){Object.keys(t).forEach(function(e){if(n.grid.isRowExist(e)){n.grid.getRowById(e).setCounters(t[e].counters)}})}})}}]);return e}();var k=function(){function e(t){babelHelpers.classCallCheck(this,e);t.eventsToEmit={onProjectGridRowAdd:true};this.grid=new g(t);this.signedParameters=t.signedParameters;this.popupData=t.tours.firstProjectCreation.popupData;this.projectAddButton=BX("projectAddButton");this.guide=new r.Guide({steps:[{target:this.projectAddButton,title:this.popupData[0].title,text:this.popupData[0].text,article:this.popupData[0].article}],onEvents:true});this.bindEvents()}babelHelpers.createClass(e,[{key:"bindEvents",value:function e(){s.EventEmitter.subscribe("UI.Tour.Guide:onFinish",this.onGuideFinish.bind(this));s.EventEmitter.subscribe("SidePanel.Slider:onMessage",this.onProjectSliderMessage.bind(this))}},{key:"onGuideFinish",value:function e(t){var n=t.getData(),i=n.guide;if(i===this.guide){this.projectAddButton.href=o.Uri.removeParam(this.projectAddButton.href,["PROJECT_OPTIONS"])}}},{key:"onProjectSliderMessage",value:function e(t){var n=t.getData(),i=babelHelpers.slicedToArray(n,1),r=i[0];if(r.getEventId()!=="sonetGroupEvent"){return}var o=r.getData();if(o.code!=="afterCreate"||o.data.projectOptions.tourId!==this.guide.getId()){return}var a=o.data.group.ID;if(this.grid.isRowExist(a)){this.showFinalStep(a)}else{s.EventEmitter.subscribe("Tasks.Projects.Grid:RowAdd",this.onProjectRowAdded.bind(this,a))}}},{key:"onProjectRowAdded",value:function e(t,n){var i=n.getData(),s=i.id;if(Number(s)===Number(t)){this.showFinalStep(t)}}},{key:"showFinalStep",value:function e(t){var n=this;var i=this.grid.getRowNodeById(t).querySelector(".tasks-projects-text");this.guide.steps.push(new r.Step({target:i,cursorMode:true,targetEvent:function e(){BX.SidePanel.Instance.open(i.href);setTimeout(function(){return n.guide.close()},1e3)}}));this.finish();this.showNextStep()}},{key:"start",value:function e(){this.projectAddButton.href=o.Uri.addParam(this.projectAddButton.href,{PROJECT_OPTIONS:{tourId:this.guide.getId()}});this.showNextStep()}},{key:"finish",value:function e(){BX.ajax.runAction("tasks.tourguide.firstprojectcreation.finish")}},{key:"showNextStep",value:function e(){var t=this;setTimeout(function(){return t.guide.showNextStep()},1e3)}}]);return e}();var y=function(){function e(t){babelHelpers.classCallCheck(this,e);this.tours=t.tours;this.initGuides(t)}babelHelpers.createClass(e,[{key:"initGuides",value:function e(t){if(this.tours.firstProjectCreation.show){this.firstProjectCreationTourGuide=new k(t);this.firstProjectCreationTourGuide.start()}}}]);return e}();var P=function(){function e(t){babelHelpers.classCallCheck(this,e);this.membersPopup=new v(t);this.filter=new l(t);this.tourGuideController=new y(t);c.setOptions(t);this.initPull(t)}babelHelpers.createClass(e,[{key:"initPull",value:function e(n){this.pullController=new m(n);this.pullClient=t.PULL;this.pullClient.subscribe(this.pullController)}},{key:"getMembersPopup",value:function e(){return this.membersPopup}},{key:"getFilter",value:function e(){return this.filter}}]);return e}();e.Controller=P;e.ActionsController=c})(this.BX.Tasks.Projects=this.BX.Tasks.Projects||{},BX,BX,BX.Main,BX.Event,BX.UI.Tour,BX);
//# sourceMappingURL=script.map.js