"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetMemberSelectorView!="undefined"){return}BX.Tasks.Component.TasksWidgetMemberSelectorView=BX.Tasks.Component.extend({sys:{code:"mem-sel"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);this.switchDeleteButtonShow()},bindEvents:function(){this.getManager();var e={AUDITORS:"auditor",ACCOMPLICES:"accomplice",RESPONSIBLE:"responsible",RESPONSIBLES:"responsible"};var t=this;if(this.option("role")==="AUDITORS"||this.option("role")==="ACCOMPLICES"){BX.Event.EventEmitter.subscribe("BX.Tasks.CheckListItem:"+e[this.option("role")]+"Added",(function(e){t.getManager().onSelectorItemSelected(e.data);t.onChangeByUser()}))}if(e[this.option("role")]){BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:"+e[this.option("role")]+"Selected",(function(e){t.getManager().onSelectorItemSelected(e.data);t.onChangeByUser()}));BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:"+e[this.option("role")]+"Deselected",(function(e){t.getManager().onSelectorItemDeselected(e.data);if(t.option("context")==="template"||t.option("role")==="AUDITORS"||t.option("role")==="ACCOMPLICES"){t.onChangeByUser()}}))}if(this.option("role")==="AUDITORS"){BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"tasks",command:"task_update",callback:this.onPullTask.bind(this)})}if(this.option("role")==="RESPONSIBLE"){BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"tasks",command:"task_update",callback:this.onPullTask.bind(this)})}},onPullTask:function(e,t,i){const s=this.recognizeTaskId(e);if(s!==parseInt(this.option("entityId"),10)){return}if(e.BEFORE?.RESPONSIBLE_ID!==e.AFTER?.RESPONSIBLE_ID){this.resetResponsible(s)}this.resetAuditors(e.BEFORE?.AUDITORS,e.AFTER?.AUDITORS,s)},resetAuditors(e,t,i){if(this.option("role")!=="AUDITORS"){return}let s=[];if(!e&&t){t=t.split(",").map(Number);s=t}else if(e&&t){e=e.split(",").map(Number);t=t.split(",").map(Number);s=t.filter((t=>!e.includes(t)))}if(s.length===0){return}BX.ajax.runComponentAction("bitrix:tasks.widget.member.selector","getMember",{mode:"class",data:{userIds:s,taskId:i}}).then((e=>{const i=Array.from(e.data);const s=this.getManager();const n=[];i.forEach((e=>{s.onSelectorItemSelected(e);n.push(["user",e.id])}));s.unsetDialog();s.getDialog().setPreselectedItems(n);const o=Boolean(this.option("readOnly"));if(o){const e=Number(this.option("currentUser"));if(t.includes(e)){this.setHeaderButtonLabelText(this.option("leaveAuditorMessage"));BX.Tasks.Component.TaskViewSidebarObject?.setAmIAuditorValue(true)}else{this.setHeaderButtonLabelText(this.option("enterAuditorMessage"));BX.Tasks.Component.TaskViewSidebarObject?.setAmIAuditorValue(false)}}}))},resetResponsible(e){if(this.option("role")!=="RESPONSIBLE"){return}BX.ajax.runComponentAction("bitrix:tasks.widget.member.selector","getResponsible",{mode:"class",data:{taskId:e}}).then((e=>{const t=e.data;const i=this.getManager();i.onSelectorItemSelected(t);i.unsetDialog();i.getDialog().setPreselectedItems([["user",t.id]])}))},recognizeTaskId(e){if("TASK_ID"in e){return parseInt(e.TASK_ID,10)}if("taskId"in e){return parseInt(e.taskId,10)}if("entityXmlId"in e&&e.entityXmlId.indexOf("TASK_")===0){return parseInt(e.entityXmlId.slice(5),10)}return 0},setHeaderButtonLabelText:function(e){this.control("header-button").innerHTML=BX.util.htmlspecialchars(e)},getManager:function(){return this.subInstance("mgr",(function(){var e=new this.constructor.Manager({scope:this.scope(),data:this.option("data"),nameTemplate:this.option("nameTemplate"),min:this.option("min"),max:this.option("max"),flowId:this.option("flowId"),path:this.option("path"),role:this.option("role"),taskLimitExceeded:this.option("taskLimitExceeded"),viewSelectorEnabled:this.option("viewSelectorEnabled"),taskMailUserIntegrationEnabled:this.option("taskMailUserIntegrationEnabled"),taskMailUserIntegrationFeatureId:this.option("taskMailUserIntegrationFeatureId"),networkEnabled:this.option("networkEnabled")});e.bindEvent("change-by-user",this.onChangeByUser.bind(this));return e}))},onChangeByUser:function(){if(this.option("enableSync")){var e=parseInt(this.option("entityId"));var t=this.option("entityRoute");var i=this.option("fieldName");if(!e||!t||!i){return}var s={id:e,data:{}};var n=[];var o=[];this.getManager().each((function(e){o.push(e.value());n.push({ID:e.value(),NAME:e.data().NAME,LAST_NAME:e.data().LAST_NAME,EMAIL:e.data().EMAIL})}));var r=this.getManager();BX.ajax.runComponentAction("bitrix:tasks.widget.member.selector","isAbsence",{mode:"class",data:{userIds:o}}).then(function(e){if(!e.status||e.status!=="success"){return}if(!e.data.length){return}var t=e.data.reduce((function(e,t){return e+"<br />"+t}));var i=BX.PopupWindowManager.create("popupMenuOptions",BX(r.scope()),{content:t,darkMode:true,autoHide:true,width:200});i.show()}.bind(this),function(e){}.bind(this));s.data[i]=n;this.sendSetMembersRequest(n);this.switchDeleteButtonShow()}},sendSetMembersRequest:function(e){var t={AUDITORS:"setAuditors",ACCOMPLICES:"setAccomplices",RESPONSIBLE:"setResponsible",RESPONSIBLES:"setResponsible"};var i=this.option("entityId");var s=t[this.option("role")];BX.ajax.runComponentAction("bitrix:tasks.widget.member.selector",s,{mode:"class",data:{taskId:i,context:this.option("context")??"",data:e}}).then(function(e){BX.Tasks.Util.fireGlobalTaskEvent("UPDATE",{ID:i},{STAY_AT_PAGE:true},{id:i})}.bind(this)).catch(function(e){if(e.errors){BX.Tasks.alert(e.errors)}}.bind(this))},addItem:function(e){this.getManager().addItem(e)},deleteItem:function(e){this.getManager().deleteItem(this.getManager().extractItemValue(e))},switchDeleteButtonShow:function(e){if(this.option("min")!==1){return}var t=document.getElementsByClassName("js-id-mem-sel-is-i-delete");if(e){if(t.length===2){Object.keys(t).forEach((function(e){BX.addClass(t[e],"hidden")}))}}else{if(t.length===1){BX.addClass(t[0],"hidden")}else{Object.keys(t).forEach((function(e){BX.removeClass(t[e],"hidden")}))}}}}});BX.Tasks.Component.TasksWidgetMemberSelectorView.Manager=BX.Tasks.UserItemSet.extend({dialog:null,sys:{code:"mem-sel-is"},options:{preRendered:true,autoSync:true,role:false,multiple:false,useSearch:true,forceTop:true,useAdd:true,controlBind:"class",itemFx:"vertical",useSmartCodeNaming:true},methods:{construct:function(){this.callConstruct(BX.Tasks.UserItemSet);this.fireUserTriggeredChangeDebounce=BX.debounce(this.fireUserTriggeredChangeDebounce,800);this.initDialog()},getDialog:function(){if(this.dialog){return this.dialog}this.dialog=new BX.UI.EntitySelector.Dialog({enableSearch:true,multiple:this.option("max")>1,context:"TASKS_MEMBER_SELECTOR_VIEW_"+this.option("role"),entities:this.getDialogEntities(),preselectedItems:this.getDialogSelectedItems(),undeselectedItems:this.getDialogUndeselectedItems(),dropdownMode:this.option("flowId")>0,events:{"Item:onSelect":function(e){var t=e.getData().item;var i=this.prepareUserData(t);var s={ACCOMPLICES:"accomplice",AUDITORS:"auditor",RESPONSIBLE:"responsible",RESPONSIBLES:"responsible"};BX.Event.EventEmitter.emit("BX.Tasks.MemberSelector:"+s[this.option("role")]+"Selected",i)}.bind(this),"Item:onDeselect":function(e){var t=e.getData().item;var i=this.prepareUserData(t);var s={ACCOMPLICES:"accomplice",AUDITORS:"auditor",RESPONSIBLE:"responsible",RESPONSIBLES:"responsible"};BX.Event.EventEmitter.emit("BX.Tasks.MemberSelector:"+s[this.option("role")]+"Deselected",i)}.bind(this)}});return this.dialog},initDialog:function(){var e=this.scope().getElementsByClassName("js-id-mem-sel-is-control");for(var t=0;t<e.length;t++){const i=e[t];i.addEventListener("click",function(e,t){var i=this.option("role");var s=this.option("viewSelectorEnabled");if((i==="ACCOMPLICES"||i==="AUDITORS")&&!s){BX.Runtime.loadExtension("tasks.limit").then((t=>{const{Limit:i}=t;i.showInstance({featureId:"tasks_observers_participants",limitAnalyticsLabels:{module:"tasks",source:"sidebar"},bindElement:e})}));return}this.getDialog().setTargetNode(t.target.parentNode);this.getDialog().show()}.bind(this,i))}},getDialogUndeselectedItems:function(){var e=this.option("data");var t=[];if(this.option("min")!==1||this.option("max")!==1){return}var i=null;for(var s in e){i=this.prepareItemData(e[s]);if(i){t.push(i)}}return t},getDialogSelectedItems:function(){var e=this.option("data");var t=[];var i=null;for(var s in e){i=this.prepareItemData(e[s]);if(i){t.push(i)}}return t},prepareItemData:function(e){var t=0;if(e.ID){t=e.ID}else if(e.id){t=e.id}if(t<=0){return null}var i=this.option("mode");return[i==="group"?"project":"user",t]},getDialogEntities:function(){const e=this.option("mode");const t=this.option("networkEnabled");const i=this.option("flowId");const s={flowTeam:[{id:"flow-user",options:{flowId:i},dynamicLoad:true},{id:"department"}],user:[{id:"user",options:{emailUsers:true,networkUsers:t,extranetUsers:true,inviteGuestLink:true,myEmailUsers:true,analyticsSource:"tasks",lockGuestLink:!this.option("taskMailUserIntegrationEnabled"),lockGuestLinkFeatureId:this.option("taskMailUserIntegrationFeatureId")}},{id:"department"}],group:[{id:"project"}]};if(i>0){return s["flowTeam"]}return s[e]||[]},prepareUserData:function(e){var t=this.option("role");var i=e.getCustomData();var s=e.getEntityType();var n=this.option("mode");var o={ACCOMPLICES:"A",AUDITORS:"U",RESPONSIBLE:"R"};return{AVATAR:e.avatar,DESCRIPTION:"",entityType:o[t],id:e.getId(),name:i.get("name"),lastName:i.get("lastName"),email:i.get("email"),nameFormatted:BX.Text.encode(e.getTitle()),networkId:"",url:e.getLink(),user_type:s,type:{crmemail:false,extranet:s==="extranet",email:s==="email",network:s==="network"},VALUE:(n==="group"?"SG":"U")+e.getId()}},prepareData:function(e){e=this.callMethod(BX.Tasks.UserItemSet,"prepareData",arguments);e.AVATAR_CSS=e.AVATAR?"background: url('"+encodeURI(e.AVATAR)+"') center no-repeat; background-size: 35px;":"";return e},openAddForm:function(e){var t=this.option("role");var i=this.option("viewSelectorEnabled");if((t==="ACCOMPLICES"||t==="AUDITORS")&&!i){BX.Runtime.loadExtension("tasks.limit").then((t=>{const{Limit:i}=t;i.showInstance({featureId:"tasks_observers_participants",limitAnalyticsLabels:{module:"tasks",source:"sidebar"},bindElement:e})}));return}this.callMethod(BX.Tasks.UserItemSet,"openAddForm")},onClose:function(){if(this.vars.changed){this.fireUserTriggeredChange()}this.vars.changed=false},onItemDeleteClicked:function(e){this.parent().switchDeleteButtonShow(true);var t=this.doOnItem(e,this.deleteItem);if(t){this.fireUserTriggeredChangeDebounce()}},fireUserTriggeredChangeDebounce:function(){this.fireUserTriggeredChange()},fireUserTriggeredChange:function(){this.fireEvent("change-by-user")},deleteItem:function(e,t){if(this.callMethod(BX.Tasks.UserItemSet,"deleteItem",arguments)){this.unselectDialogItem(e);return true}return false},unselectDialogItem:function(e){if(typeof e!=="object"){return}if(!this.getDialog()){return}e=this.prepareItemData(e.data());if(!e){return}var t=this.getDialog().getItem(e);t&&t.deselect()},unsetDialog(){if(this.dialog){this.dialog.destroy();this.dialog=null}}}})}).call(this);
//# sourceMappingURL=logic.map.js