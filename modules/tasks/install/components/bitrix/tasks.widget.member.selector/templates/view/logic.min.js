"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetMemberSelectorView!="undefined"){return}BX.Tasks.Component.TasksWidgetMemberSelectorView=BX.Tasks.Component.extend({sys:{code:"mem-sel"},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);this.switchDeleteButtonShow()},bindEvents:function(){this.getManager();var e={AUDITORS:"auditor",ACCOMPLICES:"accomplice",RESPONSIBLE:"responsible",RESPONSIBLES:"responsible"};var t=this;if(this.option("role")==="AUDITORS"||this.option("role")==="ACCOMPLICES"){BX.Event.EventEmitter.subscribe("BX.Tasks.CheckListItem:"+e[this.option("role")]+"Added",(function(e){t.getManager().onSelectorItemSelected(e.data);t.onChangeByUser()}))}if(e[this.option("role")]){BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:"+e[this.option("role")]+"Selected",(function(e){t.getManager().onSelectorItemSelected(e.data);t.onChangeByUser()}));BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:"+e[this.option("role")]+"Deselected",(function(e){t.getManager().onSelectorItemDeselected(e.data);if(t.option("context")==="template"||t.option("role")==="AUDITORS"||t.option("role")==="ACCOMPLICES"){t.onChangeByUser()}}))}},setHeaderButtonLabelText:function(e){this.control("header-button").innerHTML=BX.util.htmlspecialchars(e)},getManager:function(){return this.subInstance("mgr",(function(){var e=new this.constructor.Manager({scope:this.scope(),data:this.option("data"),nameTemplate:this.option("nameTemplate"),min:this.option("min"),max:this.option("max"),path:this.option("path"),role:this.option("role"),taskLimitExceeded:this.option("taskLimitExceeded"),networkEnabled:this.option("networkEnabled")});e.bindEvent("change-by-user",this.onChangeByUser.bind(this));return e}))},onChangeByUser:function(){if(this.option("enableSync")){var e=parseInt(this.option("entityId"));var t=this.option("entityRoute");var i=this.option("fieldName");if(!e||!t||!i){return}var n={id:e,data:{}};var s=[];var r=[];this.getManager().each((function(e){r.push(e.value());s.push({ID:e.value(),NAME:e.data().NAME,LAST_NAME:e.data().LAST_NAME,EMAIL:e.data().EMAIL})}));var o=this.getManager();BX.ajax.runComponentAction("bitrix:tasks.widget.member.selector","isAbsence",{mode:"class",data:{userIds:r}}).then(function(e){if(!e.status||e.status!=="success"){return}if(!e.data.length){return}var t=e.data.reduce((function(e,t){return e+"<br />"+t}));var i=BX.PopupWindowManager.create("popupMenuOptions",BX(o.scope()),{content:t,darkMode:true,autoHide:true,width:200});i.show()}.bind(this),function(e){}.bind(this));n.data[i]=s;this.sendSetMembersRequest(s);this.switchDeleteButtonShow()}},sendSetMembersRequest:function(e){var t={AUDITORS:"setAuditors",ACCOMPLICES:"setAccomplices",RESPONSIBLE:"setResponsible",RESPONSIBLES:"setResponsible"};var i=this.option("entityId");var n=t[this.option("role")];BX.ajax.runComponentAction("bitrix:tasks.widget.member.selector",n,{mode:"class",data:{taskId:i,context:this.option("context")??"",data:e}}).then(function(e){BX.Tasks.Util.fireGlobalTaskEvent("UPDATE",{ID:i},{STAY_AT_PAGE:true},{id:i})}.bind(this)).catch(function(e){if(e.errors){BX.Tasks.alert(e.errors)}}.bind(this))},addItem:function(e){this.getManager().addItem(e)},deleteItem:function(e){this.getManager().deleteItem(this.getManager().extractItemValue(e))},switchDeleteButtonShow:function(e){if(this.option("min")!==1){return}var t=document.getElementsByClassName("js-id-mem-sel-is-i-delete");if(e){if(t.length===2){Object.keys(t).forEach((function(e){BX.addClass(t[e],"hidden")}))}}else{if(t.length===1){BX.addClass(t[0],"hidden")}else{Object.keys(t).forEach((function(e){BX.removeClass(t[e],"hidden")}))}}}}});BX.Tasks.Component.TasksWidgetMemberSelectorView.Manager=BX.Tasks.UserItemSet.extend({dialog:null,sys:{code:"mem-sel-is"},options:{preRendered:true,autoSync:true,role:false,multiple:false,useSearch:true,forceTop:true,useAdd:true,controlBind:"class",itemFx:"vertical",useSmartCodeNaming:true},methods:{construct:function(){this.callConstruct(BX.Tasks.UserItemSet);this.fireUserTriggeredChangeDebounce=BX.debounce(this.fireUserTriggeredChangeDebounce,800);this.initDialog()},getDialog:function(){if(this.dialog){return this.dialog}this.dialog=new BX.UI.EntitySelector.Dialog({enableSearch:true,multiple:this.option("max")>1,context:"TASKS_MEMBER_SELECTOR_VIEW_"+this.option("role"),entities:this.getDialogEntities(),preselectedItems:this.getDialogSelectedItems(),undeselectedItems:this.getDialogUndeselectedItems(),events:{"Item:onSelect":function(e){var t=e.getData().item;var i=this.prepareUserData(t);var n={ACCOMPLICES:"accomplice",AUDITORS:"auditor",RESPONSIBLE:"responsible",RESPONSIBLES:"responsible"};BX.Event.EventEmitter.emit("BX.Tasks.MemberSelector:"+n[this.option("role")]+"Selected",i)}.bind(this),"Item:onDeselect":function(e){var t=e.getData().item;var i=this.prepareUserData(t);var n={ACCOMPLICES:"accomplice",AUDITORS:"auditor",RESPONSIBLE:"responsible",RESPONSIBLES:"responsible"};BX.Event.EventEmitter.emit("BX.Tasks.MemberSelector:"+n[this.option("role")]+"Deselected",i)}.bind(this)}});return this.dialog},initDialog:function(){var e=this.scope().getElementsByClassName("js-id-mem-sel-is-control");for(var t=0;t<e.length;t++){var i=e[t];i.addEventListener("click",function(e){var t=this.option("role");var i=this.option("taskLimitExceeded");if((t==="ACCOMPLICES"||t==="AUDITORS")&&i){BX.UI.InfoHelper.show("limit_tasks_observers_participants",{isLimit:true,limitAnalyticsLabels:{module:"tasks",source:"sidebar",subject:t==="AUDITORS"?"auditor":"accomplice"}});return}this.getDialog().setTargetNode(e);this.getDialog().show()}.bind(this))}},getDialogUndeselectedItems:function(){var e=this.option("data");var t=[];if(this.option("min")!==1||this.option("max")!==1){return}var i=null;for(var n in e){i=this.prepareItemData(e[n]);if(i){t.push(i)}}return t},getDialogSelectedItems:function(){var e=this.option("data");var t=[];var i=null;for(var n in e){i=this.prepareItemData(e[n]);if(i){t.push(i)}}return t},prepareItemData:function(e){var t=0;if(e.ID){t=e.ID}else if(e.id){t=e.id}if(t<=0){return null}var i=this.option("mode");return[i==="group"?"project":"user",t]},getDialogEntities:function(){var e=this.option("mode");var t=this.option("networkEnabled");var i=[];if(e==="user"){i=[{id:"user",options:{emailUsers:true,networkUsers:t,extranetUsers:true,inviteGuestLink:true,myEmailUsers:true}},{id:"department"}]}else if(e==="group"){i=[{id:"project"}]}return i},prepareUserData:function(e){var t=this.option("role");var i=e.getCustomData();var n=e.getEntityType();var s=this.option("mode");var r={ACCOMPLICES:"A",AUDITORS:"U",RESPONSIBLE:"R"};return{AVATAR:e.avatar,DESCRIPTION:"",entityType:r[t],id:e.getId(),name:i.get("name"),lastName:i.get("lastName"),email:i.get("email"),nameFormatted:BX.Text.encode(e.getTitle()),networkId:"",url:e.getLink(),user_type:n,type:{crmemail:false,extranet:n==="extranet",email:n==="email",network:n==="network"},VALUE:(s==="group"?"SG":"U")+e.getId()}},prepareData:function(e){e=this.callMethod(BX.Tasks.UserItemSet,"prepareData",arguments);e.AVATAR_CSS=e.AVATAR?"background: url('"+encodeURI(e.AVATAR)+"') center no-repeat; background-size: 35px;":"";return e},openAddForm:function(){var e=this.option("role");var t=this.option("taskLimitExceeded");if((e==="ACCOMPLICES"||e==="AUDITORS")&&t){BX.UI.InfoHelper.show("limit_tasks_observers_participants",{isLimit:true,limitAnalyticsLabels:{module:"tasks",source:"sidebar",subject:e==="AUDITORS"?"auditor":"accomplice"}});return}this.callMethod(BX.Tasks.UserItemSet,"openAddForm")},onClose:function(){if(this.vars.changed){this.fireUserTriggeredChange()}this.vars.changed=false},onItemDeleteClicked:function(e){this.parent().switchDeleteButtonShow(true);var t=this.doOnItem(e,this.deleteItem);if(t){this.fireUserTriggeredChangeDebounce()}},fireUserTriggeredChangeDebounce:function(){this.fireUserTriggeredChange()},fireUserTriggeredChange:function(){this.fireEvent("change-by-user")},deleteItem:function(e,t){if(this.callMethod(BX.Tasks.UserItemSet,"deleteItem",arguments)){this.unselectDialogItem(e);return true}return false},unselectDialogItem:function(e){if(typeof e!=="object"){return}if(!this.getDialog()){return}e=this.prepareItemData(e.data());if(!e){return}var t=this.getDialog().getItem(e);t&&t.deselect()}}})}).call(this);
//# sourceMappingURL=logic.map.js