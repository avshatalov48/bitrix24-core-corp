"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetMemberSelector!="undefined"){return}BX.Tasks.Component.TasksWidgetMemberSelector=BX.Tasks.Component.extend({sys:{code:"tdp-mem-sel",types:[]},methodsStatic:{instances:[],getInstance:function(e){return BX.Tasks.Component.TasksWidgetMemberSelector.instances[e]},addInstance:function(e,t){BX.Tasks.Component.TasksWidgetMemberSelector.instances[e]=t}},methods:{construct:function(){this.callConstruct(BX.Tasks.Component);BX.Tasks.Component.TasksWidgetMemberSelector.addInstance(this.id(),this);this.getSelector();if(this.option("inputSpecial")){this.getSelector().bindEvent("change",this.onChanged.bind(this))}var e=this;if(this.option("userType")==="auditor"||this.option("userType")==="accomplice"){BX.Event.EventEmitter.subscribe("BX.Tasks.CheckListItem:"+this.option("userType")+"Added",function(t){e.getSelector().onSelectorItemSelected(t.data)})}BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:"+this.option("userType")+"Selected",function(t){e.getSelector().onControlItemSelected(t.data)});BX.Event.EventEmitter.subscribe("BX.Tasks.MemberSelector:"+this.option("userType")+"Deselected",function(t){e.getSelector().onSelectorItemDeselected(t.data)})},onChanged:function(e){var t="";if(e[0]){t=this.getSelector().get(e[0]).id()}this.control("sole-input").value=t},getSelector:function(){return this.subInstance("selector",function(){var e={scope:this.scope(),hidePreviousIfSingleAndRequired:true,data:this.option("data"),max:this.option("max"),min:this.option("min"),nameTemplate:this.option("nameTemplate"),path:this.option("path"),preRendered:true,popupOffsetTop:3,popupOffsetLeft:40,readOnly:this.option("readOnly"),parent:this,userType:this.option("userType"),taskLimitExceeded:this.option("taskLimitExceeded")};var t=this.option("types");e.mode=t.USER?"user":"group";e.useAdd=!!t["USER.MAIL"]&&this.option("modulesAvailable").mail;var i=new this.constructor.ItemManager(e);i.bindEvent("change",function e(){this.fireEvent("change",[arguments[0]])}.bind(this));return i})},count:function(){return this.getSelector().count()},export:function(){return this.getSelector().exportItemData(true)},replaceItem:function(e,t){this.getSelector().replaceItem(e,t)},value:function(){return this.getSelector().value()},replaceAll:function(e){var t=this.getSelector();t.unload({itemFx:false,checkRestrictions:false});t.load(e)},readOnly:function(e){this.getSelector().readonly(e)}}});BX.Tasks.Component.TasksWidgetMemberSelector.ItemManager=BX.Tasks.UserItemSet.extend({dialog:null,dialogCallback:true,sys:{code:"tdp-mem-sel-is"},options:{controlBind:"class",itemFx:"horizontal",itemFxHoverDelete:true,prefixId:true,mode:"all",path:{},hidePreviousIfSingleAndRequired:false},methods:{construct:function(){this.callConstruct(BX.Tasks.UserItemSet);this.initDialog()},initDialog:function(){this.dialog=new BX.UI.EntitySelector.Dialog({enableSearch:true,multiple:this.option("max")>1,context:"TASKS_MEMBER_SELECTOR_EDIT_"+this.option("userType"),entities:this.getDialogEntities(),preselectedItems:this.getDialogSelectedItems(),events:{"Item:onSelect":function(e){if(this.dialogCallback===false){return}var t=e.getData().item;var i=this.prepareUserData(t);BX.Event.EventEmitter.emit("BX.Tasks.MemberSelector:"+this.option("userType")+"Selected",i)}.bind(this),"Item:onDeselect":function(e){if(this.dialogCallback===false){return}var t=e.getData().item;var i=this.prepareUserData(t);if(this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min===1&&this.count()===1){this.forceDeleteFirst()}else{BX.Event.EventEmitter.emit("BX.Tasks.MemberSelector:"+this.option("userType")+"Deselected",i)}}.bind(this),onHide:function(e){if(this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min>0&&this.count()<1){this.restoreKept()}}.bind(this)}});var e=this.scope().getElementsByClassName("js-id-tdp-mem-sel-is-control");for(var t=0;t<e.length;t++){var i=e[t];i.addEventListener("click",function(e){var t=this.option("userType");var i=this.option("taskLimitExceeded");if((t==="accomplice"||t==="auditor")&&i){BX.UI.InfoHelper.show("limit_tasks_observers_participants");return}this.dialog.setTargetNode(e);this.dialog.show()}.bind(this))}},getDialogSelectedItems:function(){var e=this.option("data");var t=[];for(var i=0;i<e.length;i++){t.push(this.prepareItemData(e[i]))}return t},getDialogUndeselectedItems:function(){var e=this.option("data");var t=[];if(this.option("min")!==1||this.option("max")!==1){return}for(var i=0;i<e.length;i++){t.push(this.prepareItemData(e[i]))}return t},getDialogEntities:function(){var e=this.option("mode");var t=[];if(e==="user"){t=[{id:"user",options:{emailUsers:true,networkUsers:true,extranetUsers:true,inviteGuestLink:true,myEmailUsers:true}},{id:"department"}]}else if(e==="group"){t=[{id:"project"}]}return t},prepareItemData:function(e){var t=0;if(typeof e==="string"){t=e.replace(/[A-Za-z]/gi,"")}else if(typeof e==="object"){if(e.ID){t=e.ID}else if(e.id){t=e.id}}var i=this.option("mode");return[i==="group"?"project":"user",t]},prepareUserData:function(e){var t=e.getCustomData();var i=e.getEntityType();var s=this.option("mode");return{AVATAR:e.avatar,DESCRIPTION:"",ENTITY_TYPE:s==="group"?"SG":"U",ID:e.getId(),NAME:t.get("name"),LAST_NAME:t.get("lastName"),EMAIL:t.get("email"),nameFormatted:BX.Text.encode(e.getTitle()),NETWORK_ID:"",URL:e.getLink(),USER_TYPE:i,type:{crmemail:false,extranet:i==="extranet",email:i==="email",network:i==="network"},VALUE:(s==="group"?"SG":"U")+e.getId()}},onSearchBlurred:function(){var e=BX("invite-email-email-user-popup");if(e!==null&&e.style.display==="block"){return}if(this.callMethod(BX.Tasks.UserItemSet,"onSearchBlurred")){if(this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min>0){this.restoreKept()}}},onSelectorItemSelected:function(e){if(this.option("hidePreviousIfSingleAndRequired")&&this.vars.constraint.min>0){this.vars.changed=true;var t=this.extractItemValue(e);if(!this.hasItem(t)){this.addItem(e);this.vars.toDelete=false;if(!this.checkCanAddItems()){this.instances.selector.close();this.onSearchBlurred()}}this.resetInput()}else{this.callMethod(BX.Tasks.UserItemSet,"onSelectorItemSelected",arguments)}},onControlItemSelected:function(e){this.callMethod(BX.Tasks.UserItemSet,"onSelectorItemSelected",arguments)},openAddForm:function(){var e=this.option("userType");var t=this.option("taskLimitExceeded");if((e==="accomplice"||e==="auditor")&&t){BX.UI.InfoHelper.show("limit_tasks_observers_participants");return}if(this.option("hidePreviousIfSingleAndRequired")){if(this.vars.constraint.min==1&&this.vars.constraint.max==1){this.forceDeleteFirst()}}this.callMethod(BX.Tasks.UserItemSet,"openAddForm")},onItemDeleteByCross:function(e){if(!this.callMethod(BX.Tasks.UserItemSet,"onItemDeleteByCross",arguments)){if(this.option("hidePreviousIfSingleAndRequired")){if(this.vars.constraint.min===1&&this.count()===1){this.forceDeleteFirst();this.dialog.setTargetNode(this.scope());this.dialog.show()}}return false}return true},forceDeleteFirst:function(){var e=this.getItemFirst();if(e){this.vars.toDelete=e.data();this.deleteItem(e.value(),{checkRestrictions:false})}},restoreKept:function(){if(this.vars.toDelete){this.addItem(this.vars.toDelete,{checkRestrictions:false});this.vars.toDelete=false}},addItem:function(e,t){this.callMethod(BX.Tasks.UserItemSet,"addItem",arguments);this.selectDialogItem(e)},deleteItem:function(e,t){if(this.callMethod(BX.Tasks.UserItemSet,"deleteItem",arguments)){this.unselectDialogItem(e);return true}return false},unselectDialogItem:function(e){if(!this.dialog){return}this.dialogCallback=false;if(typeof e==="object"){e=e.data()}var t=this.dialog.getItem(this.prepareItemData(e));t&&t.deselect();this.dialogCallback=true},selectDialogItem:function(e){if(!this.dialog){return}this.dialogCallback=false;var t=this.dialog.getItem(this.prepareItemData(e));t&&t.select(true);this.dialogCallback=true}}})}).call(this);
//# sourceMappingURL=logic.map.js