"use strict";BX.namespace("Tasks.Component");(function(){if(typeof BX.Tasks.Component.TasksWidgetMemberSelectorProjectLink!="undefined"){return}BX.Tasks.Component.TasksWidgetMemberSelectorProjectLink=BX.Tasks.Component.extend({dialog:null,sys:{code:"ms-plink"},options:{entityRoute:""},methods:{bindEvents:function(){this.bindDelegateControl("deselect","click",this.onDeSelect.bind(this));this.bindDelegateControl("control","click",this.onOpenForm.bind(this));BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"tasks",command:"task_update",callback:this.onTaskUpdated.bind(this)})},onTaskUpdated(t,e,i){const o=parseInt(t?.TASK_ID,10)===this.option("entityId");const n=!BX.Type.isUndefined(t.AFTER.GROUP_ID);if(!o||!n){return}const s=Number(this.currentItemId??0);const r=s!==t.AFTER.GROUP_ID;if(!r){return}const c=t.AFTER?.GROUP_ID;if(c===0){this.onDeSelect();return}this.reloadGroup()},reloadGroup(){BX.ajax.runComponentAction("bitrix:tasks.widget.member.selector","getTaskGroup",{mode:"class",data:{taskId:this.option("entityId")}}).then((t=>{const e=t.data;if(e===null){return}const i=new BX.UI.EntitySelector.Item({id:e.ID,title:e?.NAME,entityType:e?.TYPE??"project",entityId:"project",customData:{dialogId:e?.DIALOG_ID}});this.renderItem(i.getId(),i.getTitle(),i)}))},onDeSelect:function(){this.renderItem(0);this.saveId(0);this.getProjectDialog().deselectAll()},renderItem:function(t,e,i){t=parseInt(t);this.currentItemId=t;if(t){BX.removeClass(this.control("item"),"invisible");BX.addClass(this.control("control"),"invisible");this.control("item-link").innerHTML=BX.util.htmlspecialchars(e);this.control("item-link").setAttribute("href",this.getProjectLink(t,i));this.option("groupId",t)}else{BX.addClass(this.control("item"),"invisible");BX.removeClass(this.control("control"),"invisible")}this.rerenderTitle(i)},onOpenForm:function(){if(this.option("isProjectLimitExceeded")===true){BX.Runtime.loadExtension("tasks.limit").then((t=>{const{Limit:e}=t;e.showInstance({featureId:"socialnetwork_projects_groups"})}));return}this.getProjectDialog().show()},getProjectLink:function(t,e){if(e?.entityType==="collab"){const t=e?.getCustomData().get("dialogId");if(!t){return""}return this.option("path").collab?.replace("#DIALOG_ID#",t)}return this.option("path").SG.toString().replace("{{ID}}",t)},saveId:function(t){var e=this.option("entityRoute");if(!e){return}var i=this.option("entityId");t=parseInt(t);BX.ajax.runComponentAction("bitrix:tasks.widget.member.selector","setProject",{mode:"class",data:{taskId:i,context:this.option("context")??"",groupId:t}}).then(function(e){BX.Tasks.Util.fireGlobalTaskEvent("UPDATE",{ID:i},{STAY_AT_PAGE:true},{id:i});BX.onCustomEvent(this,"onChangeProjectLink",[t,i]);if(e.status==="success"){BX.onCustomEvent(this,"onProjectChanged",t)}}.bind(this)).catch(function(t){if(t.errors){BX.Tasks.alert(t.errors)}}.bind(this))},onSelectorItemSelected:function(t){this.renderItem(t.id,BX.util.htmlspecialcharsback(t.nameFormatted),t.item);this.saveId(t.id)},getProjectDialog:function(){if(!this.dialog){this.dialog=new BX.UI.EntitySelector.Dialog({targetNode:this.control("control"),enableSearch:true,multiple:false,context:"TASKS_PROJECTLINK",entities:[{id:"project",options:{lockProjectLink:this.option("isProjectLimitExceeded"),lockProjectLinkFeatureId:this.option("projectFeatureId"),shouldSelectDialogId:true}}],events:{"Item:onSelect":function(t){const e=t.getData().item;const i={id:e.getId(),nameFormatted:e.getTitle(),item:e};this.onSelectorItemSelected(i);BX.addClass(this.control("control"),"invisible");this.dialog.hide()}.bind(this),"Item:onDeselect":function(t){}.bind(this)}})}return this.dialog},rerenderTitle(t){const e=this.option("entityId");const i=document.querySelector(`#task-${e}-group-title`);const o=document.querySelector(`#task-${e}-group-value`);if(!i||!o){return}if(t?.entityType==="collab"){i.textContent=this.option("loc")?.type?.collab;BX.Dom.addClass(o,"--collab");return}i.textContent=this.option("loc")?.type?.group;BX.Dom.removeClass(o,"--collab")}}})}).call(this);
//# sourceMappingURL=logic.map.js