this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(e,t,n,s,r){"use strict";var a=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"sendRequest",value:function e(t,n){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return new Promise((function(e,a){s.ajax.runAction("bitrix:tasks.scrum."+t+"."+n,{data:r}).then(e,a)}))}},{key:"needUpdateTask",value:function e(t){return this.sendRequest("task","needUpdateTaskStatus",t)}},{key:"getTasks",value:function e(t){return this.sendRequest("task","getTasks",t)}},{key:"completeTask",value:function e(t){return this.sendRequest("task","completeTask",t)}},{key:"renewTask",value:function e(t){return this.sendRequest("task","renewTask",t)}},{key:"proceedParentTask",value:function e(t){return this.sendRequest("task","proceedParentTask",t)}},{key:"isParentScrumTask",value:function e(t){return this.sendRequest("task","isParentScrumTask",t)}},{key:"getData",value:function e(t){return this.sendRequest("task","getData",t)}},{key:"showErrorAlert",value:function e(t,n){if(s.Type.isUndefined(t.errors)){console.error(t);return}if(t.errors.length){var a=t.errors.shift();if(a){var o=a.code?a.code:"";var i=a.message+" "+o;var c=n?n:s.Loc.getMessage("TST_ERROR_POPUP_TITLE");r.MessageBox.alert(i,c)}}}}]);return e}();function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,s)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){babelHelpers.defineProperty(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var c=function(){function e(t){babelHelpers.classCallCheck(this,e);this.setState(t);this.requestSender=new a}babelHelpers.createClass(e,[{key:"setState",value:function t(n){this.taskId=parseInt(n.taskId,10);this.action=n.action===e.actions.complete?e.actions.complete:e.actions.renew;this.groupId=s.Type.isUndefined(n.groupId)?0:parseInt(n.groupId,10);this.parentTaskId=s.Type.isUndefined(n.parentTaskId)?0:parseInt(n.parentTaskId,10);this.performActionOnParentTask=s.Type.isUndefined(n.performActionOnParentTask)?false:n.performActionOnParentTask}},{key:"updateState",value:function e(){var t=this;return this.requestSender.getData({taskId:this.taskId}).then((function(e){t.setState(i(i({},{action:t.action,groupId:t.groupId,parentTaskId:t.parentTaskId,performActionOnParentTask:t.performActionOnParentTask}),e.data))}))}},{key:"update",value:function n(){var r=this;return this.requestSender.needUpdateTask({taskId:this.parentTaskId,action:this.action}).then((function(e){return e.data===true})).then((function(t){if(t){return r.requestSender.getTasks({groupId:r.groupId,taskIds:[r.parentTaskId,r.taskId]}).then((function(e){var t=e.data;return r.showMessage(t[r.parentTaskId],t[r.taskId])}))}else{return e.actions.skip}})).then((function(n){if(r.performActionOnParentTask){switch(n){case e.actions.complete:return r.completeTask(r.parentTaskId).then((function(){t.UI.Notification.Center.notify({content:s.Loc.getMessage("TST_PARENT_COMPLETE_NOTIFY")});return n}));case e.actions.renew:return r.renewTask(r.parentTaskId).then((function(){t.UI.Notification.Center.notify({content:s.Loc.getMessage("TST_PARENT_RENEW_NOTIFY")});return n}));case e.actions.proceed:t.UI.Notification.Center.notify({content:s.Loc.getMessage("TST_PARENT_PROCEED_NOTIFY")});return n;case e.actions.skip:return n}}else{return n}}))["catch"]((function(e){return r.requestSender.showErrorAlert(e)}))}},{key:"isParentScrumTask",value:function e(t){t=s.Type.isUndefined(t)?this.parentTaskId:t;if(!t){return new Promise((function(e){return e(false)}))}return this.requestSender.isParentScrumTask({groupId:this.groupId,taskId:t}).then((function(e){return e.data===true}))}},{key:"showMessage",value:function t(n,a){var o=this;return new Promise((function(t,i){var c=o.action===e.actions.complete;new r.MessageBox({minWidth:300,message:c?s.Loc.getMessage("TST_PARENT_COMPLETE_MESSAGE").replace(/#name#/g,s.Text.encode(n.name)):s.Loc.getMessage("TST_PARENT_RENEW_MESSAGE").replace("#name#",s.Text.encode(n.name)).replace("#sub-name#",s.Text.encode(a.name)),buttons:r.MessageBoxButtons.OK_CANCEL,okCaption:c?s.Loc.getMessage("TST_PARENT_COMPLETE_OK_CAPTION"):s.Loc.getMessage("TST_PARENT_RENEW_OK_CAPTION"),cancelCaption:c?s.Loc.getMessage("TST_PARENT_PROCEED_CAPTION"):s.Loc.getMessage("TST_PARENT_RENEW_CANCEL_CAPTION"),onOk:function n(s){if(c){o.showDod(o.parentTaskId).then((function(){s.close();t(e.actions.complete)}))["catch"]((function(){s.getOkButton().setDisabled(false)}))}else{s.close();t(e.actions.renew)}},onCancel:function n(s){s.close();if(c){o.proceedParentTask(o.parentTaskId).then((function(){t(e.actions.proceed)}))}else{t(e.actions.skip)}}}).show()}))}},{key:"showDod",value:function e(t){var s=this;return new Promise((function(e,r){var a=new n.Dod({groupId:s.groupId,taskId:t});a.subscribe("resolve",(function(){return e()}));a.subscribe("reject",(function(){return r()}));a.isNecessary().then((function(t){if(t){a.showList()}else{e()}}))}))}},{key:"completeTask",value:function e(t){return this.requestSender.completeTask({groupId:this.groupId,taskId:t})}},{key:"renewTask",value:function e(t){return this.requestSender.renewTask({groupId:this.groupId,taskId:t})}},{key:"proceedParentTask",value:function e(t){return this.requestSender.proceedParentTask({groupId:this.groupId,taskId:t})}}]);return e}();babelHelpers.defineProperty(c,"actions",{complete:"complete",renew:"renew",proceed:"proceed",skip:"skip"});e.TaskStatus=c})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX,BX.Tasks.Scrum,BX,BX.UI.Dialogs);
//# sourceMappingURL=task.status.bundle.map.js