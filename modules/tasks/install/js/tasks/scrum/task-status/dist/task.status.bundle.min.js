this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(e,t,s,n,r){"use strict";var a=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"sendRequest",value:function e(t,s){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return new Promise((function(e,a){n.ajax.runAction("bitrix:tasks.scrum."+t+"."+s,{data:r}).then(e,a)}))}},{key:"needUpdateTask",value:function e(t){return this.sendRequest("task","needUpdateTaskStatus",t)}},{key:"getTasks",value:function e(t){return this.sendRequest("task","getTasks",t)}},{key:"completeTask",value:function e(t){return this.sendRequest("task","completeTask",t)}},{key:"renewTask",value:function e(t){return this.sendRequest("task","renewTask",t)}},{key:"proceedParentTask",value:function e(t){return this.sendRequest("task","proceedParentTask",t)}},{key:"isParentScrumTask",value:function e(t){return this.sendRequest("task","isParentScrumTask",t)}},{key:"showErrorAlert",value:function e(t,s){if(n.Type.isUndefined(t.errors)){console.error(t);return}if(t.errors.length){var a=t.errors.shift();if(a){var o=a.code?a.code:"";var i=a.message+" "+o;var c=s?s:n.Loc.getMessage("TST_ERROR_POPUP_TITLE");r.MessageBox.alert(i,c)}}}}]);return e}();var o=function(){function e(t){babelHelpers.classCallCheck(this,e);this.setState(t);this.requestSender=new a}babelHelpers.createClass(e,[{key:"setState",value:function t(s){this.groupId=parseInt(s.groupId,10);this.parentTaskId=parseInt(s.parentTaskId,10);this.taskId=parseInt(s.taskId,10);this.action=s.action===e.actions.complete?e.actions.complete:e.actions.renew;this.performActionOnParentTask=n.Type.isUndefined(s.performActionOnParentTask)?false:s.performActionOnParentTask}},{key:"update",value:function s(){var r=this;return this.requestSender.needUpdateTask({taskId:this.parentTaskId,action:this.action}).then((function(e){return e.data===true})).then((function(t){if(t){return r.requestSender.getTasks({groupId:r.groupId,taskIds:[r.parentTaskId,r.taskId]}).then((function(e){var t=e.data;return r.showMessage(t[r.parentTaskId],t[r.taskId])}))}else{return e.actions.skip}})).then((function(s){if(r.performActionOnParentTask){switch(s){case e.actions.complete:return r.completeTask(r.parentTaskId).then((function(){t.UI.Notification.Center.notify({content:n.Loc.getMessage("TST_PARENT_COMPLETE_NOTIFY")});return s}));case e.actions.renew:return r.renewTask(r.parentTaskId).then((function(){t.UI.Notification.Center.notify({content:n.Loc.getMessage("TST_PARENT_RENEW_NOTIFY")});return s}));case e.actions.proceed:t.UI.Notification.Center.notify({content:n.Loc.getMessage("TST_PARENT_PROCEED_NOTIFY")});return s;case e.actions.skip:return s}}else{return s}}))["catch"]((function(e){return r.requestSender.showErrorAlert(e)}))}},{key:"isParentScrumTask",value:function e(t){return this.requestSender.isParentScrumTask({groupId:this.groupId,taskId:t}).then((function(e){return e.data===true}))}},{key:"showMessage",value:function t(s,a){var o=this;return new Promise((function(t,i){var c=o.action===e.actions.complete;new r.MessageBox({minWidth:300,message:c?n.Loc.getMessage("TST_PARENT_COMPLETE_MESSAGE").replace(/#name#/g,n.Text.encode(s.name)):n.Loc.getMessage("TST_PARENT_RENEW_MESSAGE").replace("#name#",n.Text.encode(s.name)).replace("#sub-name#",n.Text.encode(a.name)),buttons:r.MessageBoxButtons.OK_CANCEL,okCaption:c?n.Loc.getMessage("TST_PARENT_COMPLETE_OK_CAPTION"):n.Loc.getMessage("TST_PARENT_RENEW_OK_CAPTION"),cancelCaption:c?n.Loc.getMessage("TST_PARENT_PROCEED_CAPTION"):n.Loc.getMessage("TST_PARENT_RENEW_CANCEL_CAPTION"),onOk:function s(n){if(c){o.showDod(o.parentTaskId).then((function(){n.close();t(e.actions.complete)}))["catch"]((function(){n.getOkButton().setDisabled(false)}))}else{n.close();t(e.actions.renew)}},onCancel:function s(n){n.close();if(c){o.proceedParentTask(o.parentTaskId).then((function(){t(e.actions.proceed)}))}else{t(e.actions.skip)}}}).show()}))}},{key:"showDod",value:function e(t){var n=this;return new Promise((function(e,r){var a=new s.Dod({groupId:n.groupId,taskId:t});a.subscribe("resolve",(function(){return e()}));a.subscribe("reject",(function(){return r()}));a.isNecessary().then((function(t){if(t){a.showList()}else{e()}}))}))}},{key:"completeTask",value:function e(t){return this.requestSender.completeTask({groupId:this.groupId,taskId:t})}},{key:"renewTask",value:function e(t){return this.requestSender.renewTask({groupId:this.groupId,taskId:t})}},{key:"proceedParentTask",value:function e(t){return this.requestSender.proceedParentTask({groupId:this.groupId,taskId:t})}}]);return e}();babelHelpers.defineProperty(o,"actions",{complete:"complete",renew:"renew",proceed:"proceed",skip:"skip"});e.TaskStatus=o})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX,BX.Tasks.Scrum,BX,BX.UI.Dialogs);
//# sourceMappingURL=task.status.bundle.map.js