this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(e,t,n,s,i,a,r){"use strict";var o=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e.setEventNamespace("BX.Tasks.Scrum.DodSidePanel");e.sidePanelManager=BX.SidePanel.Instance;e.contentSidePanelManager=new BX.SidePanel.Manager({});e.contentSidePanels=new Set;e.bindEvents();return e}babelHelpers.createClass(t,[{key:"bindEvents",value:function e(){var t=this;a.EventEmitter.subscribe("SidePanel.Slider:onLoad",function(e){var n=e.getCompatData(),s=babelHelpers.slicedToArray(n,1),i=s[0];var a=i.getSlider();a.setCacheable(false);t.emit("onLoadSidePanel",a)});a.EventEmitter.subscribe("SidePanel.Slider:onClose",function(e){var n=e.getCompatData(),s=babelHelpers.slicedToArray(n,1),i=s[0];var a=i.getSlider();t.emit("onCloseSidePanel",a)});a.EventEmitter.subscribe("SidePanel.Slider:onCloseComplete",function(e){var n=e.getCompatData(),s=babelHelpers.slicedToArray(n,1),i=s[0];var a=i.getSlider();if(t.contentSidePanels.has(a.getUrl())){t.contentSidePanels.delete(a.getUrl());if(!t.contentSidePanels.size){t.resetBodyWidthHack();t.addEscapePressHandler()}}})}},{key:"openSidePanel",value:function e(t,n){this.applyBodyWidthHack();this.removeEscapePressHandler();this.contentSidePanelManager.open(t,n);this.contentSidePanels.add(t)}},{key:"existFrameTopSlider",value:function e(){return Boolean(this.sidePanelManager.getTopSlider())}},{key:"addEscapePressHandler",value:function e(){var t=this.sidePanelManager.getTopSlider();if(t){var n=t.getFrameWindow();n.addEventListener("keydown",t.handleFrameKeyDown)}}},{key:"removeEscapePressHandler",value:function e(){var t=this.sidePanelManager.getTopSlider();if(t){var n=t.getFrameWindow();n.removeEventListener("keydown",t.handleFrameKeyDown)}}},{key:"applyBodyWidthHack",value:function e(){if(this.existFrameTopSlider()){r.Dom.addClass(document.body,"tasks-scrum-dod-panel-padding")}}},{key:"resetBodyWidthHack",value:function e(){if(this.existFrameTopSlider()){r.Dom.removeClass(document.body,"tasks-scrum-dod-panel-padding")}}}]);return t}(a.EventEmitter);var l=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"sendRequest",value:function e(t){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};return new Promise(function(e,s){r.ajax.runAction("bitrix:tasks.scrum.service.definitionOfDoneService."+t,{data:n}).then(e,s)})}},{key:"getSettings",value:function e(t){return this.sendRequest("getSettings",t)}},{key:"getList",value:function e(t){return this.sendRequest("getList",t)}},{key:"saveList",value:function e(t){return this.sendRequest("saveList",t)}}]);return e}();function u(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form ui-form-line tasks-scrum-dod-form">\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown">\n\t\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t\t<select class="ui-ctl-element tasks-scrum-dod-types">\n\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content tasks-scrum-dod-checklist"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t']);u=function t(){return e};return e}function c(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-form ui-form-line tasks-scrum-dod-form">\n\t\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"]);c=function t(){return e};return e}var d=function(){function e(t){babelHelpers.classCallCheck(this,e);this.groupId=parseInt(t.groupId,10);this.sidePanel=new o;this.requestSender=new l;this.emptyDod=true;this.skipNotifications=false}babelHelpers.createClass(e,[{key:"showList",value:function e(t){var n=this;this.taskId=parseInt(t,10);return this.requestSender.getSettings({groupId:this.groupId,taskId:this.taskId}).then(function(e){var t=e.data;var s=t.types;n.emptyDod=s.length===0;var i=t.activeTypeId;if(n.isEmptyDod()){if(!n.skipNotifications){return Promise.resolve()}}n.setActiveTypeData(i,s);var a=n.createPopup(s);a.subscribe("onAfterShow",function(e){if(n.isEmptyDod()){return}var t=a.getContentContainer();var i=t.querySelector(".tasks-scrum-dod-types");var o=t.querySelector(".tasks-scrum-dod-checklist");r.Event.bind(i,"change",function(){var e=parseInt(i.value,10);n.setActiveTypeData(e,s);n.renderListTo(o,e).then(function(){a.adjustPosition()})});n.renderListTo(o,i.value).then(function(){a.adjustPosition()})});a.subscribe("onClose",function(){return n.onClose()});a.show();return new Promise(function(e,t){n.resolver=e;n.rejecter=t})})}},{key:"skipNotificationPopups",value:function e(){this.skipNotifications=true}},{key:"onClose",value:function e(){var t=this;if(this.isEmptyDod()){return}var n=this.getActiveTypeData();this.requestSender.saveList({typeId:n.id,taskId:this.taskId,items:this.getListItems()}).then(function(){if(t.skipNotifications){t.solve()}else{if(t.isListRequired(t.getActiveTypeData())){if(t.isAllToggled()){t.resolver()}else{t.rejecter();t.showInfoPopup()}}else{if(t.isAllToggled()){t.resolver()}else{t.showConfirmPopup()}}}})}},{key:"showInfoPopup",value:function e(){s.MessageBox.show({message:r.Loc.getMessage("TASKS_SCRUM_DOD_INFO_TEXT"),modal:true,buttons:s.MessageBoxButtons.OK})}},{key:"showConfirmPopup",value:function e(){var t=this;var n=new s.MessageBox({message:r.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_TEXT_COMPLETE"),modal:true,buttons:[new i.Button({text:r.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_COMPLETE_BUTTON_TEXT"),color:i.Button.Color.SUCCESS,events:{click:function e(){t.resolver();n.close()}}}),new i.Button({text:r.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_SAVE_BUTTON_TEXT"),color:i.Button.Color.LINK,events:{click:function e(){t.rejecter();n.close()}}})]});n.show()}},{key:"solve",value:function e(){if(this.isListRequired(this.getActiveTypeData())){if(this.isAllToggled()){this.resolver()}else{this.rejecter()}}else{this.resolver()}}},{key:"createPopup",value:function e(n){var s=[];if(this.isEmptyDod()){s.push(new i.Button({text:r.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_CLOSE_BUTTON_TEXT"),color:i.Button.Color.LINK,events:{click:function e(){return a.close()}}}))}else{s.push(new i.Button({text:this.getPopupButtonText(),color:i.Button.Color.SUCCESS,events:{click:function e(){return a.close()}}}))}var a=new t.Popup(r.Text.getRandom(),null,{titleBar:r.Loc.getMessage("TASKS_SCRUM_DOD_HEADER"),content:this.renderContent(n),contentPadding:10,contentBackground:"#f8f9fa",autoHide:true,closeByEsc:true,closeIcon:true,overlay:true,buttons:s});return a}},{key:"renderContent",value:function e(t){if(this.isEmptyDod()){return r.Tag.render(c(),r.Loc.getMessage("TASKS_SCRUM_DOD_LABEL_EMPTY"))}var n=this.getActiveTypeData();var s=function e(t){var s=n.id===t.id?"selected":"";return'<option value="'.concat(parseInt(t.id,10),'" ').concat(s,">").concat(r.Text.encode(t.name),"</option>")};return r.Tag.render(u(),r.Loc.getMessage("TASKS_SCRUM_DOD_LABEL_TYPES"),t.map(function(e){return s(e)}).join(""))}},{key:"renderListTo",value:function e(t,n){r.Dom.clean(t);var s=this.showLoader(t);return this.requestSender.getList({groupId:this.groupId,taskId:this.taskId,typeId:n}).then(function(e){s.hide();return r.Runtime.html(t,e.data.html)})}},{key:"setActiveTypeData",value:function e(t,n){var s=n.find(function(e){return e.id===t});if(s){this.activeTypeData=s}else{this.activeTypeData=n[0]}}},{key:"getActiveTypeData",value:function e(){return this.activeTypeData}},{key:"isEmptyDod",value:function e(){return this.emptyDod}},{key:"isListRequired",value:function e(t){return t.dodRequired==="Y"}},{key:"showLoader",value:function e(t){var s=r.Dom.getPosition(t);var i=new n.Loader({target:t,size:60,mode:"inline",color:"rgba(82, 92, 105, 0.9)",offset:{left:"".concat(s.width/2-30,"px")}});i.show();return i}},{key:"getListItems",value:function e(){if(typeof BX.Tasks.CheckListInstance==="undefined"){return[]}var t=BX.Tasks.CheckListInstance.getTreeStructure();return t.getRequestData()}},{key:"isAllToggled",value:function e(){if(typeof BX.Tasks.CheckListInstance==="undefined"){return false}var e=true;var t=BX.Tasks.CheckListInstance.getTreeStructure();t.getDescendants().forEach(function(t){if(!t.checkIsComplete()){e=false}});return e}},{key:"getPopupButtonText",value:function e(){if(this.skipNotifications){return r.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_SAVE_BUTTON_TEXT")}else{return r.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_COMPLETE_BUTTON_TEXT")}}}]);return e}();e.ScrumDod=d})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX.Main,BX,BX.UI.Dialogs,BX.UI,BX.Event,BX);
//# sourceMappingURL=scrum.dod.bundle.map.js