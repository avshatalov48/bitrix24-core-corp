this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(t,e,s,n,i,r,a,o,u,c,d){"use strict";var l=function(){function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,t);this.setId(e.id);this.setName(e.name);this.setSort(e.sort);this.setDodRequired(e.dodRequired);this.setParticipants(e.participants)}babelHelpers.createClass(t,[{key:"setId",value:function t(e){this.id=a.Type.isInteger(e)?parseInt(e,10):a.Type.isString(e)&&e?e:a.Text.getRandom()}},{key:"getId",value:function t(){return this.id}},{key:"setName",value:function t(e){this.name=a.Type.isString(e)?e:""}},{key:"getName",value:function t(){return this.name}},{key:"setSort",value:function t(e){this.sort=a.Type.isInteger(e)?parseInt(e,10):0}},{key:"getSort",value:function t(){return this.sort}},{key:"setDodRequired",value:function t(e){this.dodRequired=e==="Y"}},{key:"isDodRequired",value:function t(){return this.dodRequired}},{key:"setParticipants",value:function t(e){var s=this;this.participants=[];if(!a.Type.isArray(e)){return}e.forEach((function(t){s.participants.push([t.entityId,t.id])}))}},{key:"getParticipants",value:function t(){return this.participants}}]);return t}();var p=function(){function t(){babelHelpers.classCallCheck(this,t)}babelHelpers.createClass(t,[{key:"setTypes",value:function t(e){this.types=e}},{key:"getNextType",value:function t(){return this.types.values().next().value}},{key:"getTypes",value:function t(){return this.types}},{key:"addType",value:function t(e){this.types.set(e.getId(),e)}},{key:"getType",value:function t(e){return this.types.get(e)}},{key:"removeType",value:function t(e){this.types["delete"](e.getId())}}]);return t}();var v,h,g,y,f,T;var m=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t.setEventNamespace("BX.Tasks.Scrum.Dod.Tabs");t.sidePanelManager=BX.SidePanel.Instance;t.tabNodes=new Map;t.activeType=null;t.previousType=null;return t}babelHelpers.createClass(e,[{key:"setTypeStorage",value:function t(e){this.typeStorage=e}},{key:"render",value:function t(){var e=this;var s="tasks-scrum-dod-settings-container-sidebar"+" tasks-scrum-dod-settings-container-sidebar-settings";this.node=a.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="','">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"])),s,babelHelpers.toConsumableArray(this.typeStorage.getTypes().values()).map((function(t){return e.renderTab(t)})));return this.node}},{key:"isEmpty",value:function t(){return this.tabNodes.size===0}},{key:"renderTab",value:function t(e){var s=this;if(this.isEmptyType(e)){var n=a.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="sidebar-tab-link">\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-type-name">\n\t\t\t\t\t\t+ ',"\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"])),a.Loc.getMessage("TASKS_SCRUM_CREATE_TYPE"));a.Event.bind(n,"click",this.createType.bind(this));return n}else{var i=this.isActiveType(e)?"sidebar-tab sidebar-tab-active":"sidebar-tab";var r=a.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="','">\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-type-name">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-type-edit"></div>\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-type-remove"></div>\n\t\t\t\t</div>\n\t\t\t'])),i,a.Text.encode(e.getName()));this.tabNodes.set(e.getId(),r);a.Event.bind(r,"click",(function(t){var n=a.Dom.hasClass(t.target,"tasks-scrum-dod-settings-type-edit");var i=a.Dom.hasClass(t.target,"tasks-scrum-dod-settings-type-remove");if(!s.isActiveType(e)){s.switchType(e,r)}if(n){s.changeTypeName(e,r)}if(i){s.removeType(e,r)}}));return r}}},{key:"addType",value:function t(e,s){if(s){a.Dom.remove(this.tabNodes.get(s.getId()));this.tabNodes["delete"](s.getId())}var n=this.renderTab(e);a.Dom.insertBefore(n,this.node.lastElementChild);this.switchType(e,n)}},{key:"switchType",value:function t(e,s){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;this.tabNodes.forEach((function(t){a.Dom.removeClass(t,"sidebar-tab-active")}));a.Dom.addClass(s,"sidebar-tab-active");if(n&&!this.isEmpty()){this.setPreviousType(this.getActiveType())}else{this.setPreviousType(null)}this.setActiveType(e);this.emit("switchType",e)}},{key:"createType",value:function t(){var e=this;var s=new l;s.setSort(this.typeStorage.getTypes().size);this.tabNodes.forEach((function(t){a.Dom.removeClass(t,"sidebar-tab-active")}));var n=a.Tag.render(y||(y=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="sidebar-tab sidebar-tab-active">\n\t\t\t\t<input type="text" class="tasks-scrum-dod-settings-type-name-input">\n\t\t\t</div>\n\t\t'])));var i=a.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['<div class="tasks-scrum-dod-settings-type-name"></div>'])));a.Dom.insertBefore(n,this.node.lastElementChild);var r=n.querySelector("input");a.Event.bind(r,"change",(function(t){s.setName(t.target["value"]);e.emit("createType",s);i.textContent=a.Text.encode(s.getName());a.Dom.replace(r,i)}),true);a.Event.bind(r,"blur",(function(t){if(t.target["value"].trim()===""){a.Dom.remove(n)}}),true);a.Event.bind(r,"keydown",(function(t){if(t.isComposing||t.keyCode===13){r.blur()}}));r.focus();this.tabNodes.set(s.getId(),n)}},{key:"changeTypeName",value:function t(e,s){var n=this;var i=a.Tag.render(T||(T=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="text" class="tasks-scrum-dod-settings-type-name-input" value="','">\n\t\t'])),a.Text.encode(e.getName()));var r=s.querySelector(".tasks-scrum-dod-settings-type-name");a.Event.bind(i,"change",(function(t){e.setName(t.target["value"]);n.emit("changeTypeName",e);i.blur()}),true);a.Event.bind(i,"blur",(function(){r.textContent=a.Text.encode(e.getName());a.Dom.replace(i,r)}),true);a.Event.bind(i,"keydown",(function(t){if(t.isComposing||t.keyCode===13){i.blur()}}));a.Dom.replace(r,i);i.focus();i.setSelectionRange(e.getName().length,e.getName().length)}},{key:"removeType",value:function t(e,s){var n=this;var i={};var r=this.sidePanelManager.getTopSlider();if(r){i.targetContainer=r.getContainer()}new c.MessageBox({message:a.Loc.getMessage("TASKS_SCRUM_CONFIRM_TEXT_REMOVE_TYPE"),popupOptions:i,okCaption:a.Loc.getMessage("TASKS_SCRUM_BUTTON_TEXT_REMOVE"),buttons:c.MessageBoxButtons.OK_CANCEL,onOk:function t(i){n.tabNodes["delete"](e.getId());if(n.isActiveType(e)){n.setActiveType(null)}n.setPreviousType(null);a.Dom.remove(s);n.emit("removeType",e);i.close()}}).show()}},{key:"setActiveType",value:function t(e){this.activeType=e}},{key:"getActiveType",value:function t(){return this.activeType}},{key:"setPreviousType",value:function t(e){this.previousType=e}},{key:"getPreviousType",value:function t(){return this.previousType}},{key:"isActiveType",value:function t(e){return this.activeType&&this.activeType.getId()===e.getId()}},{key:"setEmptyType",value:function t(e){this.emptyType=e}},{key:"isEmptyType",value:function t(e){return e.getId()===this.emptyType.getId()}},{key:"switchToType",value:function t(e){this.switchType(e,this.tabNodes.get(e.getId()),false)}}]);return e}(o.EventEmitter);var b=function(){function t(){babelHelpers.classCallCheck(this,t)}babelHelpers.createClass(t,[{key:"sendRequest",value:function t(e,s){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return new Promise((function(t,i){a.ajax.runAction("bitrix:tasks.scrum."+e+"."+s,{data:n}).then(t,i)}))}},{key:"isNecessary",value:function t(e){return this.sendRequest("doD","isNecessary",e)}},{key:"getSettings",value:function t(e){return this.sendRequest("doD","getSettings",e)}},{key:"getChecklist",value:function t(e){return this.sendRequest("doD","getChecklist",e)}},{key:"saveSettings",value:function t(e){return this.sendRequest("doD","saveSettings",e)}},{key:"getList",value:function t(e){return this.sendRequest("doD","getList",e)}},{key:"saveList",value:function t(e){return this.sendRequest("doD","saveList",e)}},{key:"createType",value:function t(e){return this.sendRequest("type","createType",e)}},{key:"changeTypeName",value:function t(e){return this.sendRequest("type","changeTypeName",e)}},{key:"removeType",value:function t(e){return this.sendRequest("type","removeType",e)}},{key:"showErrorAlert",value:function t(e,s){if(a.Type.isUndefined(e.errors)){console.error(e);return}if(e.errors.length){var n=e.errors.shift();if(n){var i=n.code?n.code:"";var r=n.message+" "+i;var o=s?s:a.Loc.getMessage("TSD_ERROR_POPUP_TITLE");c.MessageBox.alert(r,o)}}}}]);return t}();var k,S,C,I,E;var L=function(){function t(e){var s=this;babelHelpers.classCallCheck(this,t);this.requestSender=e.requestSender;this.groupId=parseInt(e.groupId,10);this.taskId=parseInt(e.taskId,10);this.typeStorage=new p;this.tabs=new m;this.tabs.subscribe("switchType",this.onSwitchType.bind(this));this.tabs.subscribe("createType",this.onCreateType.bind(this));this.tabs.subscribe("changeTypeName",this.onChangeTypeName.bind(this));this.tabs.subscribe("removeType",this.onRemoveType.bind(this));this.changed=false;o.EventEmitter.subscribe("BX.Tasks.CheckListItem:CheckListChanged",(function(){s.setChanged()}))}babelHelpers.createClass(t,[{key:"isEmpty",value:function t(){return this.tabs.isEmpty()}},{key:"isChanged",value:function t(){return this.changed}},{key:"setChanged",value:function t(){this.changed=true}},{key:"renderContent",value:function t(){var e=this;return this.requestSender.getSettings({groupId:this.groupId}).then((function(t){var s=a.Type.isArray(t.data.types)?t.data.types:[];var n=new Map;s.forEach((function(t){var e=new l(t);n.set(e.getId(),e)}));e.typeStorage.setTypes(n);e.tabs.setTypeStorage(e.typeStorage);e.tabs.setActiveType(e.typeStorage.getNextType());e.addEmptyCreationType();return e.render()}))["catch"]((function(t){e.requestSender.showErrorAlert(t)}))}},{key:"render",value:function t(){var e=this.typeStorage.getNextType();this.node=a.Tag.render(k||(k=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-dod-settings">\n\t\t\t\t<div class="tasks-scrum-dod-settings-container">\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-container-wrap">\n\t\t\t\t\t\t<div class="tasks-scrum-dod-settings-container-shell">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t<div class="tasks-scrum-dod-settings-container-sidebar-wrapper">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),this.tabs.render(),this.renderContainer(e));return this.node}},{key:"renderContainer",value:function t(e){if(this.tabs.isEmpty()){return this.renderEmptyForm()}else{return this.renderEditingForm(e)}}},{key:"renderEditingForm",value:function t(e){return a.Tag.render(S||(S=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form">\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content ui-form-content-dod-list"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),this.renderRequiredOption(e),this.renderParticipantsSelector())}},{key:"renderEmptyForm",value:function t(){return a.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form">\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),a.Loc.getMessage("TASKS_SCRUM_CREATE_TYPE_PROMPT"))}},{key:"renderRequiredOption",value:function t(e){var s=this;var n=a.Tag.render(I||(I=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form-row">\n\t\t\t\t<label class="ui-ctl ui-ctl-checkbox">\n\t\t\t\t\t<input type="checkbox" class="ui-ctl-element ui-form-content-required-option">\n\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t"])),a.Loc.getMessage("TASKS_SCRUM_DOD_OPTIONS_REQUIRED_LABEL"));var i=n.querySelector(".ui-form-content-required-option");i.checked=e.isDodRequired();a.Event.bind(i,"click",(function(){s.setChanged();s.updateActiveType()}));return n}},{key:"renderParticipantsSelector",value:function t(){return"";return a.Tag.render(E||(E=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form-row">\n\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-user-selector"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),a.Loc.getMessage("TASKS_SCRUM_DOD_LABEL_USER_SELECTOR"))}},{key:"initParticipantsSelector",value:function t(e){var s=this.node.querySelector(".tasks-scrum-dod-settings-user-selector");if(a.Type.isNil(s)){return}var n="tasks-scrum-dod-settings-participants-selector-"+e.getId();this.participantsSelector=new r.TagSelector({id:n,dialogOptions:{id:n,context:"TASKS",preselectedItems:this.tabs.getActiveType().getParticipants(),entities:[{id:"user",options:{inviteEmployeeLink:false}},{id:"project-roles",options:{projectId:this.groupId},dynamicLoad:true}]}});this.participantsSelector.renderTo(s)}},{key:"buildEditingForm",value:function t(e){var s=this;var n=this.cleanTypeForm();a.Dom.append(this.renderEditingForm(e),n);this.initParticipantsSelector(e);var i=this.node.querySelector(".ui-form-content-dod-list");var r=this.showLoader(i);this.requestSender.getChecklist({groupId:this.groupId,typeId:e.getId()}).then((function(t){r.hide();a.Runtime.html(i,t.data.html)}))["catch"]((function(t){r.hide();s.requestSender.showErrorAlert(t)}))}},{key:"buildEmptyForm",value:function t(){var e=this.cleanTypeForm();a.Dom.append(this.renderEmptyForm(),e)}},{key:"onSwitchType",value:function t(e){var s=this;var n=e.getData();var i=this.tabs.getPreviousType();if(i){this.saveSettings(i).then((function(t){var e=t.data.type;i.setDodRequired(e.dodRequired);i.setParticipants(e.participants);s.buildEditingForm(n)}))}else{this.buildEditingForm(n)}}},{key:"onCreateType",value:function t(e){var s=this;var n=this.node.querySelector(".tasks-scrum-dod-settings-container-sidebar-wrapper");var i=this.showLoader(n);var r=e.getData();this.requestSender.createType({groupId:this.groupId,name:r.getName(),sort:r.getSort()}).then((function(t){s.setChanged();i.hide();var e=new l(t.data);s.typeStorage.addType(e);s.tabs.addType(e,r)}))["catch"]((function(t){i.hide();s.requestSender.showErrorAlert(t)}))}},{key:"onChangeTypeName",value:function t(e){var s=this;var n=e.getData();this.requestSender.changeTypeName({groupId:this.groupId,id:n.getId(),name:n.getName()}).then((function(){s.setChanged()}))["catch"]((function(t){s.requestSender.showErrorAlert(t)}))}},{key:"onRemoveType",value:function t(e){var s=this;var n=e.getData();this.requestSender.removeType({groupId:this.groupId,id:n.getId()}).then((function(){s.setChanged();s.typeStorage.removeType(n);if(s.tabs.isEmpty()){s.buildEmptyForm()}else{var t=babelHelpers.toConsumableArray(s.typeStorage.getTypes().values()).find((function(t){return!s.tabs.isEmptyType(t)}));s.tabs.switchToType(t)}}))["catch"]((function(t){s.requestSender.showErrorAlert(t)}))}},{key:"saveSettings",value:function t(e){var s=this;if(this.tabs.isEmpty()){return Promise.resolve()}var n=e?e:this.tabs.getActiveType();if(!(n instanceof l)){return Promise.resolve()}return this.requestSender.saveSettings({groupId:this.groupId,typeId:n.getId(),requiredOption:this.getRequiredOptionValue(),items:this.getChecklistItems(),participants:this.getSelectedParticipants()})["catch"]((function(t){s.requestSender.showErrorAlert(t)}))}},{key:"getChecklistItems",value:function t(){if(typeof BX.Tasks.CheckListInstance==="undefined"){return[]}var e=BX.Tasks.CheckListInstance.getTreeStructure();return e.getRequestData()}},{key:"getSelectedParticipants",value:function t(){if(a.Type.isNil(this.participantsSelector)){return[]}var e=[];this.participantsSelector.getTags().forEach((function(t){e.push({id:t.getId(),entityId:t.getEntityId()})}));return e}},{key:"getRequiredOptionValue",value:function t(){var e=this.node.querySelector(".ui-form-content-required-option");return e.checked===true?"Y":"N"}},{key:"showLoader",value:function t(e){var s=a.Dom.getPosition(e);var n=new u.Loader({target:e,size:60,mode:"inline",color:"rgba(82, 92, 105, 0.9)",offset:{left:"".concat(s.width/2-30,"px")}});n.show();return n}},{key:"getActiveType",value:function t(){return this.tabs.getActiveType()}},{key:"updateActiveType",value:function t(){var e=this.tabs.getActiveType();e.setDodRequired(this.getRequiredOptionValue())}},{key:"cleanTypeForm",value:function t(){var e=this.node.querySelector(".tasks-scrum-dod-settings-container-sidebar-wrapper");a.Dom.clean(e);return e}},{key:"addEmptyCreationType",value:function t(){var e=new l;this.tabs.setEmptyType(e);this.typeStorage.addType(e)}}]);return t}();var w,_;var A=function(t){babelHelpers.inherits(e,t);function e(t){var s;babelHelpers.classCallCheck(this,e);s=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));s.setEventNamespace("BX.Tasks.Scrum.Dod.List");s.sidePanelManager=BX.SidePanel.Instance;s.requestSender=t.requestSender;s.groupId=parseInt(t.groupId,10);s.taskId=parseInt(t.taskId,10);s.skipNotifications=a.Type.isBoolean(t.skipNotifications)?t.skipNotifications:false;s.typeStorage=new p;s.tabs=new m;s.empty=true;s.node=null;return s}babelHelpers.createClass(e,[{key:"renderContent",value:function t(){var e=this;return this.requestSender.getSettings({groupId:this.groupId,taskId:this.taskId,saveRequest:this.isSkipNotifications()?"Y":"N"}).then((function(t){var s=a.Type.isArray(t.data.types)?t.data.types:[];var n=a.Type.isInteger(t.data.activeTypeId)?parseInt(t.data.activeTypeId,10):0;e.empty=s.length===0;var i=new Map;s.forEach((function(t){var e=new l(t);i.set(e.getId(),e)}));e.typeStorage.setTypes(i);e.tabs.setTypeStorage(e.typeStorage);var r=i.get(n);if(a.Type.isUndefined(r)){e.tabs.setActiveType(e.typeStorage.getNextType())}else{e.tabs.setActiveType(r)}if(e.isEmpty()){if(!e.isSkipNotifications()){e.emit("resolve")}return e.renderEmpty()}return e.render()}))["catch"]((function(t){e.requestSender.showErrorAlert(t)}))}},{key:"renderList",value:function t(){var e=this;var s=this.node.querySelector(".tasks-scrum-dod-checklist");a.Dom.clean(s);var n=this.showLoader(s);this.requestSender.getList({groupId:this.groupId,taskId:this.taskId,typeId:this.getActiveType().getId()}).then((function(t){n.hide();a.Runtime.html(s,t.data.html)}))["catch"]((function(t){e.requestSender.showErrorAlert(t)}))}},{key:"renderEmpty",value:function t(){var e=this;var s=a.Tag.render(w||(w=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-form ui-form-line tasks-scrum-dod-form">\n\t\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"])),a.Loc.getMessage("TASKS_SCRUM_DOD_LABEL_EMPTY"));a.Event.bind(s.querySelector("span"),"click",(function(){return e.emit("showSettings")}));return s}},{key:"render",value:function t(){var e=this;var s=this.getActiveType();var n=function t(e){var n=s.getId()===e.id?"selected":"";return'<option value="'.concat(parseInt(e.id,10),'" ').concat(n,">").concat(a.Text.encode(e.name),"</option>")};this.node=a.Tag.render(_||(_=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form ui-form-line tasks-scrum-dod-form">\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown">\n\t\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t\t<select class="ui-ctl-element tasks-scrum-dod-types">\n\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content tasks-scrum-dod-checklist"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),a.Loc.getMessage("TASKS_SCRUM_DOD_LABEL_TYPES"),babelHelpers.toConsumableArray(this.typeStorage.getTypes().values()).map((function(t){return n(t)})).join(""));var i=this.node.querySelector(".tasks-scrum-dod-types");a.Event.bind(i,"change",(function(t){var s=parseInt(t.target.value,10);e.tabs.setActiveType(e.typeStorage.getType(s));e.renderList()}));return this.node}},{key:"save",value:function t(){var e=this;var s=this.getActiveType();return this.requestSender.saveList({typeId:s.getId(),taskId:this.taskId,groupId:this.groupId,items:this.getListItems()}).then((function(){if(e.isSkipNotifications()){return e.solve()}else{if(e.isListRequired(e.getActiveType())){if(e.isAllToggled()){return"resolve"}else{e.showInfoPopup();return"wait"}}else{if(e.isAllToggled()){return"resolve"}else{e.showConfirmPopup();return"wait"}}}}))["catch"]((function(t){e.requestSender.showErrorAlert(t)}))}},{key:"isSkipNotifications",value:function t(){return this.skipNotifications}},{key:"isEmpty",value:function t(){return this.empty}},{key:"getActiveType",value:function t(){return this.tabs.getActiveType()}},{key:"isListRequired",value:function t(e){return e.isDodRequired()}},{key:"solve",value:function t(){if(this.isListRequired(this.getActiveType())){if(this.isAllToggled()){return"resolve"}else{return"reject"}}else{return"resolve"}}},{key:"getListItems",value:function t(){if(typeof BX.Tasks.CheckListInstance==="undefined"){return[]}var e=BX.Tasks.CheckListInstance.getTreeStructure();return e.getRequestData()}},{key:"isAllToggled",value:function t(){if(typeof BX.Tasks.CheckListInstance==="undefined"){return false}var t=true;var e=BX.Tasks.CheckListInstance.getTreeStructure();e.getDescendants().forEach((function(e){if(e.countTotalCount()>0&&!e.checkIsComplete()){t=false}}));return t}},{key:"showInfoPopup",value:function t(){var e={};var s=this.sidePanelManager.getTopSlider();if(s){e.targetContainer=s.getContainer()}new c.MessageBox({message:a.Loc.getMessage("TASKS_SCRUM_DOD_INFO_TEXT"),popupOptions:e,buttons:c.MessageBoxButtons.OK}).show()}},{key:"showConfirmPopup",value:function t(){var e=this;var s={};var n=this.sidePanelManager.getTopSlider();if(n){s.targetContainer=n.getContainer()}var i=new c.MessageBox({popupOptions:s,message:a.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_TEXT_COMPLETE"),modal:true,buttons:[new d.Button({text:a.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_COMPLETE_BUTTON_TEXT"),color:d.Button.Color.SUCCESS,events:{click:function t(){e.emit("resolve");i.close()}}}),new d.Button({text:a.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_SAVE_BUTTON_TEXT"),color:d.Button.Color.LINK,events:{click:function t(){e.emit("reject");i.close()}}})]});i.show()}},{key:"showLoader",value:function t(e){var s=a.Dom.getPosition(e);var n=new u.Loader({target:e,size:60,mode:"inline",color:"rgba(82, 92, 105, 0.9)",offset:{left:"".concat(s.width/2-30,"px")}});n.show();return n}}]);return e}(o.EventEmitter);var R=function(t){babelHelpers.inherits(n,t);function n(t){var e;babelHelpers.classCallCheck(this,n);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this,t));e.setEventNamespace("BX.Tasks.Scrum.Dod");e.view=t.view;e.groupId=parseInt(t.groupId,10);e.taskId=parseInt(t.taskId,10);e.sidePanelManager=BX.SidePanel.Instance;e.requestSender=new b;e.settings=new L({requestSender:e.requestSender,groupId:e.groupId,taskId:e.taskId});e.list=new A({requestSender:e.requestSender,groupId:e.groupId,taskId:e.taskId,skipNotifications:t.skipNotifications});e.list.subscribe("resolve",(function(){e.emit("resolve");e.sidePanelManager.close(false)}));e.list.subscribe("reject",(function(){e.emit("reject");e.sidePanelManager.close(false)}));e.list.subscribe("showSettings",(function(){e.sidePanelManager.close(false,(function(){return e.showSettings()}))}));return e}babelHelpers.createClass(n,[{key:"isNecessary",value:function t(){var e=this;return this.requestSender.isNecessary({groupId:this.groupId,taskId:this.taskId}).then((function(t){return t.data}))["catch"]((function(t){e.requestSender.showErrorAlert(t)}))}},{key:"show",value:function t(){switch(this.view){case"settings":this.showSettings();break;case"list":this.showList();break}}},{key:"showSettings",value:function t(){var s=this;this.sidePanelManager.open("tasks-scrum-dod-settings-side-panel",{cacheable:false,width:1e3,contentCallback:function t(){return e.Layout.createContent({extensions:["tasks.scrum.dod","ui.entity-selector","tasks"],title:a.Loc.getMessage("TASKS_SCRUM_DOD_TITLE"),content:s.createSettingsContent.bind(s),design:{section:false},buttons:[]})},events:{onLoad:this.onLoadSettings.bind(this),onClose:this.onCloseSettings.bind(this),onCloseComplete:this.onCloseSettingsComplete.bind(this)}})}},{key:"showList",value:function t(){var s=this;this.sidePanelManager.open("tasks-scrum-dod-list-side-panel",{cacheable:false,width:800,contentCallback:function t(){return e.Layout.createContent({extensions:["tasks.scrum.dod","tasks"],title:a.Loc.getMessage("TASKS_SCRUM_DOD_TITLE"),content:s.createListContent.bind(s),design:{section:false},toolbar:function t(e){var n=e.Button;return[new n({color:n.Color.LIGHT_BORDER,text:a.Loc.getMessage("TASKS_SCRUM_DOD_TOOLBAR_SETTINGS"),onclick:s.showSettings.bind(s)})]},buttons:function t(e){var n=e.cancelButton,i=e.SaveButton;return[new i({text:s.getListButtonText(),onclick:s.onSaveList.bind(s)}),new d.CancelButton({onclick:function t(){s.emit("reject");s.sidePanelManager.close(false)}})]}})},events:{onLoad:this.onLoadList.bind(this)}})}},{key:"createSettingsContent",value:function t(){var e=this;return new Promise((function(t,s){e.settings.renderContent().then((function(e){t(e)}))}))}},{key:"createListContent",value:function t(){var e=this;return new Promise((function(t,s){e.list.renderContent().then((function(e){t(e)}))}))}},{key:"onLoadSettings",value:function t(){if(!this.settings.isEmpty()){this.settings.buildEditingForm(this.settings.getActiveType())}}},{key:"onLoadList",value:function t(){if(this.list.isEmpty()){return}this.list.renderList()}},{key:"onCloseSettings",value:function t(){if(this.settings.isChanged()){this.settings.saveSettings().then((function(){s.UI.Notification.Center.notify({autoHideDelay:1e3,content:a.Loc.getMessage("TASKS_SCRUM_DOD_SAVE_SETTINGS_NOTIFY")})}))["catch"]((function(){}))}}},{key:"onCloseSettingsComplete",value:function t(){var e=this.sidePanelManager.getTopSlider();if(e){if(e.getUrl()==="tasks-scrum-dod-list-side-panel"&&this.settings.isChanged()){e.reload()}}}},{key:"onSaveList",value:function t(){var e=this;if(this.list.isEmpty()){return}this.list.save().then((function(t){if(t==="resolve"){e.emit("resolve");e.sidePanelManager.close(false)}else if(t==="reject"){e.emit("reject");e.sidePanelManager.close(false)}}))}},{key:"getListButtonText",value:function t(){if(this.list.isSkipNotifications()){return a.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_SAVE_BUTTON_TEXT")}else{return a.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_COMPLETE_BUTTON_TEXT")}}}]);return n}(o.EventEmitter);t.Dod=R})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX.UI.SidePanel,BX,BX.UI,BX,BX.UI.EntitySelector,BX,BX.Event,BX,BX.UI.Dialogs,BX.UI);
//# sourceMappingURL=dod.bundle.map.js