this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(t,e,n,s,i,r,a,o,u,c){"use strict";var l=function(){function t(){babelHelpers.classCallCheck(this,t)}babelHelpers.createClass(t,[{key:"sendRequest",value:function t(e,n){var s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return new Promise((function(t,r){i.ajax.runAction("bitrix:tasks.scrum."+e+"."+n,{data:s}).then(t,r)}))}},{key:"isNecessary",value:function t(e){return this.sendRequest("doD","isNecessary",e)}},{key:"getSettings",value:function t(e){return this.sendRequest("doD","getSettings",e)}},{key:"getChecklist",value:function t(e){return this.sendRequest("doD","getChecklist",e)}},{key:"saveSettings",value:function t(e){return this.sendRequest("doD","saveSettings",e)}},{key:"getList",value:function t(e){return this.sendRequest("doD","getList",e)}},{key:"saveList",value:function t(e){return this.sendRequest("doD","saveList",e)}},{key:"createType",value:function t(e){return this.sendRequest("type","createType",e)}},{key:"changeTypeName",value:function t(e){return this.sendRequest("type","changeTypeName",e)}},{key:"removeType",value:function t(e){return this.sendRequest("type","removeType",e)}},{key:"showErrorAlert",value:function t(e,n){if(i.Type.isUndefined(e.errors)){console.error(e);return}if(e.errors.length){var s=e.errors.shift();if(s){var r=s.code?s.code:"";var a=s.message+" "+r;var u=n?n:i.Loc.getMessage("TSD_ERROR_POPUP_TITLE");o.MessageBox.alert(a,u)}}}}]);return t}();var d=function(){function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,t);this.setId(e.id);this.setName(e.name);this.setSort(e.sort);this.setDodRequired(e.dodRequired);this.setParticipants(e.participants);this.setActive(e.active==="Y")}babelHelpers.createClass(t,[{key:"setId",value:function t(e){this.id=i.Type.isInteger(e)?parseInt(e,10):i.Type.isString(e)&&e?e:i.Text.getRandom()}},{key:"getId",value:function t(){return this.id}},{key:"setName",value:function t(e){this.name=i.Type.isString(e)?e:""}},{key:"getName",value:function t(){return this.name}},{key:"setSort",value:function t(e){this.sort=i.Type.isInteger(e)?parseInt(e,10):0}},{key:"getSort",value:function t(){return this.sort}},{key:"setDodRequired",value:function t(e){this.dodRequired=e==="Y"}},{key:"isDodRequired",value:function t(){return this.dodRequired}},{key:"setActive",value:function t(e){this.active=i.Type.isBoolean(e)?e:false}},{key:"isActive",value:function t(){return this.active}},{key:"setParticipants",value:function t(e){var n=this;this.participants=[];if(!i.Type.isArray(e)){return}e.forEach((function(t){n.participants.push([t.entityId,t.id])}))}},{key:"getParticipants",value:function t(){return this.participants}}]);return t}();var p=function(){function t(){babelHelpers.classCallCheck(this,t);this.types=new Map}babelHelpers.createClass(t,[{key:"setTypes",value:function t(e){this.types=e}},{key:"getTypes",value:function t(){return this.types}},{key:"addType",value:function t(e){this.types.set(e.getId(),e)}},{key:"getType",value:function t(e){return this.types.get(e)}},{key:"removeType",value:function t(e){this.types["delete"](e.getId())}},{key:"setActiveType",value:function t(e){e=i.Type.isNil(e)?this.types.values().next().value:e;this.types.forEach((function(t){return t.setActive(e.getId()===t.getId())}))}},{key:"getActiveType",value:function t(){var e=babelHelpers.toConsumableArray(this.types.values()).find((function(t){return t.isActive()}));if(i.Type.isNil(e)){return this.types.values().next().value}return e}},{key:"isEmpty",value:function t(){return this.types.size===0}}]);return t}();var h,g,v,y,f,m;var T=function(){function t(e){var n=this;babelHelpers.classCallCheck(this,t);this.requestSender=e.requestSender;this.groupId=parseInt(e.groupId,10);this.taskId=parseInt(e.taskId,10);this.sidePanelManager=BX.SidePanel.Instance;this.typeStorage=new p;this.layoutMenu=null;this.nameInput=null;this.changed=false;r.EventEmitter.subscribe("BX.Tasks.CheckListItem:CheckListChanged",(function(){n.setChanged()}))}babelHelpers.createClass(t,[{key:"show",value:function t(){var e=this;this.sidePanelManager.open("tasks-scrum-dod-settings-side-panel",{cacheable:false,width:1e3,contentCallback:function t(){return c.Layout.createLayout({extensions:["tasks.scrum.dod","ui.entity-selector","tasks"],title:i.Loc.getMessage("TASKS_SCRUM_DOD_TITLE"),content:e.renderContent.bind(e),design:{section:false},menu:{},toolbar:function t(n){var s=n.Button;return[new s({color:s.Color.LIGHT_BORDER,text:i.Loc.getMessage("TASKS_SCRUM_DOD_BTN_CREATE_TYPE"),onclick:function t(){e.showTypeForm()}})]},buttons:[]}).then((function(t){e.layoutMenu=t.getMenu();e.layoutMenu.subscribe("click",e.onMenuItemClick.bind(e));return t.render()}))},events:{onLoad:this.onLoadSettings.bind(this),onClose:this.onCloseSettings.bind(this),onCloseComplete:this.onCloseSettingsComplete.bind(this)}})}},{key:"onLoadSettings",value:function t(){this.layoutMenu.setItems(this.getMenuItems());if(!this.isEmpty()){this.buildEditingForm(this.typeStorage.getActiveType())}}},{key:"onCloseSettings",value:function t(){if(this.isChanged()){this.saveSettings().then((function(){s.UI.Notification.Center.notify({autoHideDelay:1e3,content:i.Loc.getMessage("TASKS_SCRUM_DOD_SAVE_SETTINGS_NOTIFY")})}))["catch"]((function(){}))}}},{key:"onCloseSettingsComplete",value:function t(){var e=this.sidePanelManager.getTopSlider();if(e){if(e.getUrl()==="tasks-scrum-dod-list-side-panel"&&this.isChanged()){e.reload()}}}},{key:"isEmpty",value:function t(){return this.typeStorage.isEmpty()}},{key:"isChanged",value:function t(){return this.changed}},{key:"setChanged",value:function t(){this.changed=true}},{key:"renderContent",value:function t(){var e=this;return this.requestSender.getSettings({groupId:this.groupId}).then((function(t){var n=i.Type.isArray(t.data.types)?t.data.types:[];var s=new Map;n.forEach((function(t){var e=new d(t);s.set(e.getId(),e)}));e.typeStorage.setTypes(s);e.typeStorage.setActiveType();return e.render(e.typeStorage.getActiveType())}))["catch"]((function(t){e.requestSender.showErrorAlert(t)}))}},{key:"render",value:function t(e){this.node=i.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-dod-settings">\n\t\t\t\t<div class="tasks-scrum-dod-settings-container">\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-container-wrap">\n\t\t\t\t\t\t<div class="tasks-scrum-dod-settings-container-sidebar-wrapper">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),this.renderContainer(e));return this.node}},{key:"renderContainer",value:function t(e){if(this.typeStorage.isEmpty()){return this.renderEmptyForm()}else{return this.renderEditingForm(e)}}},{key:"renderEditingForm",value:function t(e){return i.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form">\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content ui-form-content-dod-list"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),this.renderRequiredOption(e),this.renderParticipantsSelector())}},{key:"renderEmptyForm",value:function t(){return i.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form">\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),i.Loc.getMessage("TASKS_SCRUM_CREATE_TYPE_PROMPT"))}},{key:"renderRequiredOption",value:function t(e){var n=this;var s=i.Tag.render(y||(y=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form-row">\n\t\t\t\t<label class="ui-ctl ui-ctl-checkbox">\n\t\t\t\t\t<input type="checkbox" class="ui-ctl-element ui-form-content-required-option">\n\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t"])),i.Loc.getMessage("TASKS_SCRUM_DOD_OPTIONS_REQUIRED_LABEL"));var r=s.querySelector(".ui-form-content-required-option");r.checked=e.isDodRequired();i.Event.bind(r,"click",(function(){n.setChanged();n.updateActiveType()}));return s}},{key:"renderParticipantsSelector",value:function t(){return"";return i.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form-row">\n\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-user-selector"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),i.Loc.getMessage("TASKS_SCRUM_DOD_LABEL_USER_SELECTOR"))}},{key:"renderTypeForm",value:function t(e){var n=this;var s=e?e.getName():"";this.typeFormNode=i.Tag.render(m||(m=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-dod-settings-type-form">\n\t\t\t\t<div class="ui-alert ui-alert-danger --hidden">\n\t\t\t\t\t<span class="ui-alert-message"></span>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-ctl ui-ctl-textbox ui-ctl-w100">\n\t\t\t\t\t<input\n\t\t\t\t\t\ttype="text"\n\t\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\t\tplaceholder="','"\n\t\t\t\t\t\tvalue="','"\n\t\t\t\t\t>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),i.Loc.getMessage("TASKS_SCRUM_DOD_POPUP_INPUT_PLACEHOLDER"),i.Text.encode(s));this.nameInput=this.typeFormNode.querySelector("input");i.Event.bind(this.nameInput,"keydown",(function(t){if(t.key==="Enter"){n.onOkTypeForm(e)}n.hideTypeFormError()}));return this.typeFormNode}},{key:"initParticipantsSelector",value:function t(n){var s=this.node.querySelector(".tasks-scrum-dod-settings-user-selector");if(i.Type.isNil(s)){return}var r="tasks-scrum-dod-settings-participants-selector-"+n.getId();this.participantsSelector=new e.TagSelector({id:r,dialogOptions:{id:r,context:"TASKS",preselectedItems:this.typeStorage.getActiveType().getParticipants(),entities:[{id:"user",options:{inviteEmployeeLink:false,analyticsSource:"task"}},{id:"project-roles",options:{projectId:this.groupId},dynamicLoad:true}]}});this.participantsSelector.renderTo(s)}},{key:"buildEditingForm",value:function t(e){var n=this;var s=this.cleanTypeForm();i.Dom.append(this.renderEditingForm(e),s);this.initParticipantsSelector(e);var r=this.node.querySelector(".ui-form-content-dod-list");var a=this.showLoader(r);this.requestSender.getChecklist({groupId:this.groupId,typeId:e.getId()}).then((function(t){a.hide();i.Runtime.html(r,t.data.html)}))["catch"]((function(t){a.hide();n.requestSender.showErrorAlert(t)}))}},{key:"buildEmptyForm",value:function t(){var e=this.cleanTypeForm();i.Dom.append(this.renderEmptyForm(),e)}},{key:"showTypeForm",value:function t(e){var n=this;this.typeForm=new o.MessageBox({popupOptions:this.getDefaultPopupOptions(),title:i.Type.isUndefined(e)?i.Loc.getMessage("TASKS_SCRUM_DOD_POPUP_TITLE_CREATE"):i.Loc.getMessage("TASKS_SCRUM_DOD_POPUP_TITLE_EDIT"),message:this.renderTypeForm(e),buttons:o.MessageBoxButtons.OK_CANCEL,okCaption:i.Type.isUndefined(e)?i.Loc.getMessage("TASKS_SCRUM_DOD_BTN_CREATE_TYPE"):i.Loc.getMessage("TASKS_SCRUM_DOD_BTN_SAVE"),onOk:function t(){return n.onOkTypeForm(e)}});var s=this.typeForm.getPopupWindow();s.subscribe("onAfterShow",(function(){var t=n.nameInput.value.length;n.nameInput.focus();n.nameInput.setSelectionRange(t,t)}));this.typeForm.show()}},{key:"onOkTypeForm",value:function t(e){var n=this;if(!this.nameInput.value.trim()){this.showTypeFormError(i.Loc.getMessage("TASKS_SCRUM_DOD_POPUP_EMPTY_NAME"));this.typeForm.getOkButton().setDisabled(false);return}this.typeForm.close();if(i.Type.isUndefined(e)){var s=this.typeStorage.isEmpty();this.createType(this.nameInput.value).then((function(t){if(t){n.addMenuItem(t);n.switchType(t,s)}}))}else{e.setName(this.nameInput.value);this.changeType(e).then((function(t){if(t){n.changeMenuItem(t);n.switchType(t)}}))}}},{key:"showTypeFormError",value:function t(e){var n=this.typeFormNode.querySelector(".ui-alert");n.querySelector(".ui-alert-message").textContent=e;i.Dom.removeClass(n,"--hidden")}},{key:"hideTypeFormError",value:function t(){var e=this.typeFormNode.querySelector(".ui-alert");if(!i.Dom.hasClass(e,"--hidden")){i.Dom.addClass(this.typeFormNode.querySelector(".ui-alert"),"--hidden")}}},{key:"createType",value:function t(e){var n=this;var s=this.node.querySelector(".tasks-scrum-dod-settings-container-sidebar-wrapper");var i=this.showLoader(s);return this.requestSender.createType({groupId:this.groupId,name:e,sort:this.typeStorage.getTypes().size+1}).then((function(t){n.setChanged();i.hide();var e=new d(t.data);n.typeStorage.addType(e);return e}))["catch"]((function(t){i.hide();n.requestSender.showErrorAlert(t)}))}},{key:"switchType",value:function t(e){var n=this;var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var i=this.getMenuItem(e);var r=null;if(!s){r=this.typeStorage.getActiveType();if(i.getId()===r.getId()){return}}this.typeStorage.setActiveType(e);this.setActiveMenuItem(e);if(r){this.saveSettings(r).then((function(t){var s=t.data.type;r.setDodRequired(s.dodRequired);r.setParticipants(s.participants);n.buildEditingForm(e)}))}else{this.buildEditingForm(e)}}},{key:"changeType",value:function t(e){var n=this;return this.requestSender.changeTypeName({groupId:this.groupId,id:e.getId(),name:e.getName()}).then((function(){n.setChanged();return e}))["catch"]((function(t){n.requestSender.showErrorAlert(t)}))}},{key:"removeType",value:function t(e){var n=this;return this.requestSender.removeType({groupId:this.groupId,id:e.getId()}).then((function(){n.setChanged();n.typeStorage.removeType(e);if(n.typeStorage.isEmpty()){n.buildEmptyForm();return null}else{return n.typeStorage.getActiveType()}}))["catch"]((function(t){n.requestSender.showErrorAlert(t)}))}},{key:"saveSettings",value:function t(e){var n=this;if(this.typeStorage.isEmpty()){return Promise.resolve()}var s=e?e:this.typeStorage.getActiveType();if(!(s instanceof d)){return Promise.resolve()}return this.requestSender.saveSettings({groupId:this.groupId,typeId:s.getId(),requiredOption:this.getRequiredOptionValue(),items:this.getChecklistItems(),participants:this.getSelectedParticipants()})["catch"]((function(t){n.requestSender.showErrorAlert(t)}))}},{key:"getChecklistItems",value:function t(){if(typeof BX.Tasks.CheckListInstance==="undefined"){return[]}var e=BX.Tasks.CheckListInstance.getTreeStructure();return e.getRequestData()}},{key:"getSelectedParticipants",value:function t(){if(i.Type.isNil(this.participantsSelector)){return[]}var e=[];this.participantsSelector.getTags().forEach((function(t){e.push({id:t.getId(),entityId:t.getEntityId()})}));return e}},{key:"getRequiredOptionValue",value:function t(){var e=this.node.querySelector(".ui-form-content-required-option");return e.checked===true?"Y":"N"}},{key:"showLoader",value:function t(e){var n=i.Dom.getPosition(e);var s=new a.Loader({target:e,size:60,mode:"inline",color:"rgba(82, 92, 105, 0.9)",offset:{left:"".concat(n.width/2-30,"px")}});s.show();return s}},{key:"updateActiveType",value:function t(){var e=this.typeStorage.getActiveType();e.setDodRequired(this.getRequiredOptionValue())}},{key:"cleanTypeForm",value:function t(){var e=this.node.querySelector(".tasks-scrum-dod-settings-container-sidebar-wrapper");i.Dom.clean(e);return e}},{key:"getMenuItems",value:function t(){var e=this;if(this.typeStorage.isEmpty()){return[]}var n=[];this.typeStorage.getTypes().forEach((function(t){n.push(e.getMenuItemOptions(t,n.length===0))}));return n}},{key:"addMenuItem",value:function t(e){return this.layoutMenu.add(this.getMenuItemOptions(e))}},{key:"changeMenuItem",value:function t(e){return this.layoutMenu.change(e.getId(),{label:e.getName()})}},{key:"removeMenuItem",value:function t(e){this.layoutMenu.remove(e.getId())}},{key:"getMenuItem",value:function t(e){return this.layoutMenu.get(e.getId())}},{key:"setActiveMenuItem",value:function t(e){this.getMenuItem(e).setActive()}},{key:"getMenuItemOptions",value:function t(e){var n=this;var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;return{id:e.getId(),label:e.getName(),active:s,actions:[{label:i.Loc.getMessage("TASKS_SCRUM_DOD_BTN_EDIT_TYPE"),onclick:function t(){n.showTypeForm(e)}},{label:i.Loc.getMessage("TASKS_SCRUM_DOD_BTN_REMOVE_TYPE"),onclick:function t(s){new o.MessageBox({title:i.Loc.getMessage("TASKS_SCRUM_CONFIRM_TEXT_REMOVE_TYPE_TITLE"),message:i.Loc.getMessage("TASKS_SCRUM_CONFIRM_TEXT_REMOVE_TYPE_NEW").replace("#name#",i.Text.encode(e.getName())),popupOptions:n.getDefaultPopupOptions(),okCaption:i.Loc.getMessage("TASKS_SCRUM_BUTTON_TEXT_REMOVE"),buttons:o.MessageBoxButtons.OK_CANCEL,minHeight:100,onOk:function t(s){n.removeType(e).then((function(t){n.removeMenuItem(e);if(!i.Type.isNull(t)){n.switchType(t,true)}s.close()}))}}).show()}}]}}},{key:"onMenuItemClick",value:function t(e){var n=e.getData(),s=n.item;this.switchType(this.typeStorage.getType(s.getId()))}},{key:"getDefaultPopupOptions",value:function t(){var e={};var n=this.sidePanelManager.getTopSlider();if(n){e.targetContainer=n.getContainer()}return e}}]);return t}();var S,k;var I=function(t){babelHelpers.inherits(e,t);function e(t){var n;babelHelpers.classCallCheck(this,e);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));n.setEventNamespace("BX.Tasks.Scrum.Dod.List");n.sidePanelManager=BX.SidePanel.Instance;n.requestSender=t.requestSender;n.groupId=parseInt(t.groupId,10);n.taskId=parseInt(t.taskId,10);n.skipNotifications=i.Type.isBoolean(t.skipNotifications)?t.skipNotifications:false;n.typeStorage=new p;n.empty=true;n.node=null;return n}babelHelpers.createClass(e,[{key:"show",value:function t(){var e=this;this.sidePanelManager.open("tasks-scrum-dod-list-side-panel",{cacheable:false,width:800,contentCallback:function t(){return c.Layout.createContent({extensions:["tasks.scrum.dod","tasks"],title:i.Loc.getMessage("TASKS_SCRUM_DOD_TITLE"),content:e.renderContent.bind(e),design:{section:false},toolbar:function t(n){var s=n.Button;return[new s({color:s.Color.LIGHT_BORDER,text:i.Loc.getMessage("TASKS_SCRUM_DOD_TOOLBAR_SETTINGS"),onclick:function t(){return e.emit("showSettings",false)}})]},buttons:function t(n){var s=n.cancelButton,i=n.SaveButton;return[new i({text:e.getListButtonText(),onclick:e.onSaveList.bind(e)}),new u.CancelButton({onclick:function t(){e.emit("reject");e.sidePanelManager.close(false)}})]}})},events:{onLoad:this.onLoadList.bind(this)}})}},{key:"onLoadList",value:function t(){if(this.isEmpty()){return}this.renderList()}},{key:"onSaveList",value:function t(){var e=this;if(this.isEmpty()){return}this.save().then((function(t){if(t==="resolve"){e.emit("resolve");e.sidePanelManager.close(false)}else if(t==="reject"){e.emit("reject");e.sidePanelManager.close(false)}}))}},{key:"getListButtonText",value:function t(){if(this.isSkipNotifications()){return i.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_SAVE_BUTTON_TEXT")}else{return i.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_COMPLETE_BUTTON_TEXT")}}},{key:"renderContent",value:function t(){var e=this;return this.requestSender.getSettings({groupId:this.groupId,taskId:this.taskId,saveRequest:this.isSkipNotifications()?"Y":"N"}).then((function(t){var n=i.Type.isArray(t.data.types)?t.data.types:[];var s=i.Type.isInteger(t.data.activeTypeId)?parseInt(t.data.activeTypeId,10):0;e.empty=n.length===0;var r=new Map;n.forEach((function(t){var e=new d(t);r.set(e.getId(),e)}));e.typeStorage.setTypes(r);e.typeStorage.setActiveType(r.get(s));if(e.isEmpty()){if(!e.isSkipNotifications()){e.emit("resolve")}return e.renderEmpty()}return e.render()}))["catch"]((function(t){e.requestSender.showErrorAlert(t)}))}},{key:"renderList",value:function t(){var e=this;var n=this.node.querySelector(".tasks-scrum-dod-checklist");i.Dom.clean(n);var s=this.showLoader(n);this.requestSender.getList({groupId:this.groupId,taskId:this.taskId,typeId:this.getActiveType().getId()}).then((function(t){s.hide();i.Runtime.html(n,t.data.html)}))["catch"]((function(t){e.requestSender.showErrorAlert(t)}))}},{key:"renderEmpty",value:function t(){var e=this;var n=i.Tag.render(S||(S=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-form ui-form-line tasks-scrum-dod-form">\n\t\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"])),i.Loc.getMessage("TASKS_SCRUM_DOD_LABEL_EMPTY"));i.Event.bind(n.querySelector("span"),"click",(function(){return e.emit("showSettings",true)}));return n}},{key:"render",value:function t(){var e=this;var n=this.getActiveType();var s=function t(e){var s=n.getId()===e.id?"selected":"";return'<option value="'.concat(parseInt(e.id,10),'" ').concat(s,">").concat(i.Text.encode(e.name),"</option>")};this.node=i.Tag.render(k||(k=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form ui-form-line tasks-scrum-dod-form">\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown">\n\t\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t\t<select class="ui-ctl-element tasks-scrum-dod-types">\n\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content tasks-scrum-dod-checklist"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),i.Loc.getMessage("TASKS_SCRUM_DOD_LABEL_TYPES"),babelHelpers.toConsumableArray(this.typeStorage.getTypes().values()).map((function(t){return s(t)})).join(""));var r=this.node.querySelector(".tasks-scrum-dod-types");i.Event.bind(r,"change",(function(t){var n=parseInt(t.target.value,10);e.typeStorage.setActiveType(e.typeStorage.getType(n));e.renderList()}));return this.node}},{key:"save",value:function t(){var e=this;var n=this.getActiveType();return this.requestSender.saveList({typeId:n.getId(),taskId:this.taskId,groupId:this.groupId,items:this.getListItems()}).then((function(){if(e.isSkipNotifications()){return e.solve()}else{if(e.isListRequired(e.getActiveType())){if(e.isAllToggled()){return"resolve"}else{e.showInfoPopup();return"wait"}}else{if(e.isAllToggled()){return"resolve"}else{e.showConfirmPopup();return"wait"}}}}))["catch"]((function(t){e.requestSender.showErrorAlert(t)}))}},{key:"isSkipNotifications",value:function t(){return this.skipNotifications}},{key:"isEmpty",value:function t(){return this.empty}},{key:"getActiveType",value:function t(){return this.typeStorage.getActiveType()}},{key:"isListRequired",value:function t(e){return e.isDodRequired()}},{key:"solve",value:function t(){if(this.isListRequired(this.getActiveType())){if(this.isAllToggled()){return"resolve"}else{return"reject"}}else{return"resolve"}}},{key:"getListItems",value:function t(){if(typeof BX.Tasks.CheckListInstance==="undefined"){return[]}var e=BX.Tasks.CheckListInstance.getTreeStructure();return e.getRequestData()}},{key:"isAllToggled",value:function t(){if(typeof BX.Tasks.CheckListInstance==="undefined"){return false}var t=true;var e=BX.Tasks.CheckListInstance.getTreeStructure();e.getDescendants().forEach((function(e){if(e.countTotalCount()>0&&!e.checkIsComplete()){t=false}}));return t}},{key:"showInfoPopup",value:function t(){var e={};var n=this.sidePanelManager.getTopSlider();if(n){e.targetContainer=n.getContainer()}new o.MessageBox({message:i.Loc.getMessage("TASKS_SCRUM_DOD_INFO_TEXT"),popupOptions:e,buttons:o.MessageBoxButtons.OK}).show()}},{key:"showConfirmPopup",value:function t(){var e=this;var n={};var s=this.sidePanelManager.getTopSlider();if(s){n.targetContainer=s.getContainer()}var r=new o.MessageBox({popupOptions:n,message:i.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_TEXT_COMPLETE"),modal:true,buttons:[new u.Button({text:i.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_COMPLETE_BUTTON_TEXT"),color:u.Button.Color.SUCCESS,events:{click:function t(){e.emit("resolve");r.close()}}}),new u.Button({text:i.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_SAVE_BUTTON_TEXT"),color:u.Button.Color.LINK,events:{click:function t(){e.emit("reject");r.close()}}})]});r.show()}},{key:"showLoader",value:function t(e){var n=i.Dom.getPosition(e);var s=new a.Loader({target:e,size:60,mode:"inline",color:"rgba(82, 92, 105, 0.9)",offset:{left:"".concat(n.width/2-30,"px")}});s.show();return s}}]);return e}(r.EventEmitter);var E=function(t){babelHelpers.inherits(e,t);function e(t){var n;babelHelpers.classCallCheck(this,e);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));n.setEventNamespace("BX.Tasks.Scrum.Dod");n.view=t.view;n.groupId=parseInt(t.groupId,10);n.taskId=parseInt(t.taskId,10);n.sidePanelManager=BX.SidePanel.Instance;n.requestSender=new l;n.settings=new T({requestSender:n.requestSender,groupId:n.groupId,taskId:n.taskId});n.list=new I({requestSender:n.requestSender,groupId:n.groupId,taskId:n.taskId,skipNotifications:t.skipNotifications});n.list.subscribe("resolve",(function(){n.emit("resolve");n.sidePanelManager.close(false)}));n.list.subscribe("reject",(function(){n.emit("reject");n.sidePanelManager.close(false)}));n.list.subscribe("showSettings",(function(t){var e=t.getData();if(e){n.sidePanelManager.close(false,(function(){return n.showSettings()}))}else{n.showSettings()}}));return n}babelHelpers.createClass(e,[{key:"isNecessary",value:function t(){var e=this;return this.requestSender.isNecessary({groupId:this.groupId,taskId:this.taskId}).then((function(t){return t.data}))["catch"]((function(t){e.requestSender.showErrorAlert(t)}))}},{key:"show",value:function t(){switch(this.view){case"settings":this.showSettings();break;case"list":this.showList();break}}},{key:"showSettings",value:function t(){this.settings.show()}},{key:"showList",value:function t(){this.list.show()}}]);return e}(r.EventEmitter);t.Dod=E})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX.UI.EntitySelector,BX.UI.SidePanel,BX,BX,BX.Event,BX,BX.UI.Dialogs,BX.UI,BX.UI.SidePanel);
//# sourceMappingURL=dod.bundle.map.js