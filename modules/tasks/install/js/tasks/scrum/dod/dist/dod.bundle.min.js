this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(t,e,s,i,n,r,a,o,u){"use strict";var c=function(){function t(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,t);this.setId(e.id);this.setName(e.name);this.setSort(e.sort);this.setDodRequired(e.dodRequired);this.setParticipants(e.participants)}babelHelpers.createClass(t,[{key:"setId",value:function t(e){this.id=n.Type.isInteger(e)?parseInt(e,10):n.Type.isString(e)&&e?e:n.Text.getRandom()}},{key:"getId",value:function t(){return this.id}},{key:"setName",value:function t(e){this.name=n.Type.isString(e)?e:""}},{key:"getName",value:function t(){return this.name}},{key:"setSort",value:function t(e){this.sort=n.Type.isInteger(e)?parseInt(e,10):0}},{key:"getSort",value:function t(){return this.sort}},{key:"setDodRequired",value:function t(e){this.dodRequired=e==="Y"}},{key:"isDodRequired",value:function t(){return this.dodRequired}},{key:"setParticipants",value:function t(e){var s=this;this.participants=[];if(!n.Type.isArray(e)){return}e.forEach((function(t){s.participants.push([t.entityId,t.id])}))}},{key:"getParticipants",value:function t(){return this.participants}}]);return t}();var d=function(){function t(){babelHelpers.classCallCheck(this,t)}babelHelpers.createClass(t,[{key:"setTypes",value:function t(e){this.types=e}},{key:"getNextType",value:function t(){return this.types.values().next().value}},{key:"getTypes",value:function t(){return this.types}},{key:"addType",value:function t(e){this.types.set(e.getId(),e)}},{key:"getType",value:function t(e){return this.types.get(e)}},{key:"removeType",value:function t(e){this.types["delete"](e.getId())}}]);return t}();var l,p,v,h,g,y;var f=function(t){babelHelpers.inherits(e,t);function e(){var t;babelHelpers.classCallCheck(this,e);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this));t.setEventNamespace("BX.Tasks.Scrum.Dod.Tabs");t.tabNodes=new Map;t.activeType=null;t.previousType=null;return t}babelHelpers.createClass(e,[{key:"setTypeStorage",value:function t(e){this.typeStorage=e}},{key:"render",value:function t(){var e=this;var s="tasks-scrum-dod-settings-container-sidebar"+" tasks-scrum-dod-settings-container-sidebar-settings";this.node=n.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="','">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"])),s,babelHelpers.toConsumableArray(this.typeStorage.getTypes().values()).map((function(t){return e.renderTab(t)})));return this.node}},{key:"isEmpty",value:function t(){return this.tabNodes.size===0}},{key:"renderTab",value:function t(e){var s=this;if(this.isEmptyType(e)){var i=n.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="sidebar-tab-link">\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-type-name">\n\t\t\t\t\t\t+ ',"\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"])),n.Loc.getMessage("TASKS_SCRUM_CREATE_TYPE"));n.Event.bind(i,"click",this.createType.bind(this));return i}else{var r=this.isActiveType(e)?"sidebar-tab sidebar-tab-active":"sidebar-tab";var a=n.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="','">\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-type-name">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-type-edit"></div>\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-type-remove"></div>\n\t\t\t\t</div>\n\t\t\t'])),r,n.Text.encode(e.getName()));this.tabNodes.set(e.getId(),a);n.Event.bind(a,"click",(function(t){var i=t.target.classList.contains("tasks-scrum-dod-settings-type-edit");var n=t.target.classList.contains("tasks-scrum-dod-settings-type-remove");if(!s.isActiveType(e)){s.switchType(e,a)}if(i){s.changeTypeName(e,a)}if(n){s.removeType(e,a)}}));return a}}},{key:"addType",value:function t(e,s){if(s){n.Dom.remove(this.tabNodes.get(s.getId()));this.tabNodes["delete"](s.getId())}var i=this.renderTab(e);n.Dom.insertBefore(i,this.node.lastElementChild);this.switchType(e,i)}},{key:"switchType",value:function t(e,s){var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;this.tabNodes.forEach((function(t){n.Dom.removeClass(t,"sidebar-tab-active")}));n.Dom.addClass(s,"sidebar-tab-active");if(i&&!this.isEmpty()){this.setPreviousType(this.getActiveType())}else{this.setPreviousType(null)}this.setActiveType(e);this.emit("switchType",e)}},{key:"createType",value:function t(){var e=this;var s=new c;s.setSort(this.typeStorage.getTypes().size);this.tabNodes.forEach((function(t){n.Dom.removeClass(t,"sidebar-tab-active")}));var i=n.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="sidebar-tab sidebar-tab-active">\n\t\t\t\t<input type="text" class="tasks-scrum-dod-settings-type-name-input">\n\t\t\t</div>\n\t\t'])));var r=n.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(['<div class="tasks-scrum-dod-settings-type-name"></div>'])));n.Dom.insertBefore(i,this.node.lastElementChild);var a=i.querySelector("input");n.Event.bind(a,"change",(function(t){s.setName(t.target["value"]);e.emit("createType",s);r.textContent=n.Text.encode(s.getName());n.Dom.replace(a,r)}),true);n.Event.bind(a,"blur",(function(t){if(t.target["value"].trim()===""){n.Dom.remove(i)}}),true);n.Event.bind(a,"keydown",(function(t){if(t.isComposing||t.keyCode===13){a.blur()}}));a.focus();this.tabNodes.set(s.getId(),i)}},{key:"changeTypeName",value:function t(e,s){var i=this;var r=n.Tag.render(y||(y=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="text" class="tasks-scrum-dod-settings-type-name-input" value="','">\n\t\t'])),n.Text.encode(e.getName()));var a=s.querySelector(".tasks-scrum-dod-settings-type-name");n.Event.bind(r,"change",(function(t){e.setName(t.target["value"]);i.emit("changeTypeName",e);r.blur()}),true);n.Event.bind(r,"blur",(function(){a.textContent=n.Text.encode(e.getName());n.Dom.replace(r,a)}),true);n.Event.bind(r,"keydown",(function(t){if(t.isComposing||t.keyCode===13){r.blur()}}));n.Dom.replace(a,r);r.focus();r.setSelectionRange(e.getName().length,e.getName().length)}},{key:"removeType",value:function t(e,s){var i=this;top.BX.UI.Dialogs.MessageBox.confirm(n.Loc.getMessage("TASKS_SCRUM_CONFIRM_TEXT_REMOVE_TYPE"),(function(t){i.tabNodes["delete"](e.getId());if(i.isActiveType(e)){i.setActiveType(null)}i.setPreviousType(null);n.Dom.remove(s);i.emit("removeType",e);t.close()}),n.Loc.getMessage("TASKS_SCRUM_BUTTON_TEXT_REMOVE"))}},{key:"setActiveType",value:function t(e){this.activeType=e}},{key:"getActiveType",value:function t(){return this.activeType}},{key:"setPreviousType",value:function t(e){this.previousType=e}},{key:"getPreviousType",value:function t(){return this.previousType}},{key:"isActiveType",value:function t(e){return this.activeType&&this.activeType.getId()===e.getId()}},{key:"setEmptyType",value:function t(e){this.emptyType=e}},{key:"isEmptyType",value:function t(e){return e.getId()===this.emptyType.getId()}},{key:"switchToType",value:function t(e){this.switchType(e,this.tabNodes.get(e.getId()),false)}}]);return e}(r.EventEmitter);var m=function(){function t(){babelHelpers.classCallCheck(this,t)}babelHelpers.createClass(t,[{key:"sendRequest",value:function t(e,s){var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return new Promise((function(t,n){top.BX.ajax.runAction("bitrix:tasks.scrum."+e+"."+s,{data:i}).then(t,n)}))}},{key:"isNecessary",value:function t(e){return this.sendRequest("doD","isNecessary",e)}},{key:"getSettings",value:function t(e){return this.sendRequest("doD","getSettings",e)}},{key:"getChecklist",value:function t(e){return this.sendRequest("doD","getChecklist",e)}},{key:"saveSettings",value:function t(e){return this.sendRequest("doD","saveSettings",e)}},{key:"getList",value:function t(e){return this.sendRequest("doD","getList",e)}},{key:"saveList",value:function t(e){return this.sendRequest("doD","saveList",e)}},{key:"createType",value:function t(e){return this.sendRequest("type","createType",e)}},{key:"changeTypeName",value:function t(e){return this.sendRequest("type","changeTypeName",e)}},{key:"removeType",value:function t(e){return this.sendRequest("type","removeType",e)}},{key:"showErrorAlert",value:function t(e,s){if(n.Type.isUndefined(e.errors)){console.log(e);return}if(e.errors.length){var i=e.errors.shift();if(i){var r=i.code?i.code:"";var a=i.message+" "+r;var o=s?s:n.Loc.getMessage("TSD_ERROR_POPUP_TITLE");top.BX.UI.Dialogs.MessageBox.alert(a,o)}}}}]);return t}();var T,b,k,S,I;var E=function(){function t(e){babelHelpers.classCallCheck(this,t);this.requestSender=e.requestSender;this.groupId=parseInt(e.groupId,10);this.taskId=parseInt(e.taskId,10);this.typeStorage=new d;this.tabs=new f;this.tabs.subscribe("switchType",this.onSwitchType.bind(this));this.tabs.subscribe("createType",this.onCreateType.bind(this));this.tabs.subscribe("changeTypeName",this.onChangeTypeName.bind(this));this.tabs.subscribe("removeType",this.onRemoveType.bind(this))}babelHelpers.createClass(t,[{key:"isEmpty",value:function t(){return this.tabs.isEmpty()}},{key:"renderContent",value:function t(){var e=this;return this.requestSender.getSettings({groupId:this.groupId}).then((function(t){var s=n.Type.isArray(t.data.types)?t.data.types:[];var i=new Map;s.forEach((function(t){var e=new c(t);i.set(e.getId(),e)}));e.typeStorage.setTypes(i);e.tabs.setTypeStorage(e.typeStorage);e.tabs.setActiveType(e.typeStorage.getNextType());e.addEmptyCreationType();return e.render()}))["catch"]((function(t){e.requestSender.showErrorAlert(t)}))}},{key:"render",value:function t(){var e=this.typeStorage.getNextType();this.node=n.Tag.render(T||(T=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-dod-settings">\n\t\t\t\t<div class="tasks-scrum-dod-settings-container">\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-container-wrap">\n\t\t\t\t\t\t<div class="tasks-scrum-dod-settings-container-shell">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t<div class="tasks-scrum-dod-settings-container-sidebar-wrapper">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),this.tabs.render(),this.renderContainer(e));return this.node}},{key:"renderContainer",value:function t(e){if(this.tabs.isEmpty()){return this.renderEmptyForm()}else{return this.renderEditingForm(e)}}},{key:"renderEditingForm",value:function t(e){return n.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form">\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content ui-form-content-dod-list"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),this.renderRequiredOption(e),this.renderParticipantsSelector())}},{key:"renderEmptyForm",value:function t(){return n.Tag.render(k||(k=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form">\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),n.Loc.getMessage("TASKS_SCRUM_CREATE_TYPE_PROMPT"))}},{key:"renderRequiredOption",value:function t(e){var s=this;var i=n.Tag.render(S||(S=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form-row">\n\t\t\t\t<label class="ui-ctl ui-ctl-checkbox">\n\t\t\t\t\t<input type="checkbox" class="ui-ctl-element ui-form-content-required-option">\n\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t</label>\n\t\t\t</div>\n\t\t"])),n.Loc.getMessage("TASKS_SCRUM_DOD_OPTIONS_REQUIRED_LABEL"));var r=i.querySelector(".ui-form-content-required-option");r.checked=e.isDodRequired();n.Event.bind(r,"click",(function(){s.updateActiveType()}));return i}},{key:"renderParticipantsSelector",value:function t(){return"";return n.Tag.render(I||(I=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form-row">\n\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t<div class="tasks-scrum-dod-settings-user-selector"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),n.Loc.getMessage("TASKS_SCRUM_DOD_LABEL_USER_SELECTOR"))}},{key:"initParticipantsSelector",value:function t(e){var s=this.node.querySelector(".tasks-scrum-dod-settings-user-selector");if(n.Type.isNil(s)){return}var i="tasks-scrum-dod-settings-participants-selector-"+e.getId();this.participantsSelector=new top.BX.UI.EntitySelector.TagSelector({id:i,dialogOptions:{id:i,context:"TASKS",preselectedItems:this.tabs.getActiveType().getParticipants(),entities:[{id:"user",options:{inviteEmployeeLink:false}},{id:"project-roles",options:{projectId:this.groupId},dynamicLoad:true}]}});this.participantsSelector.renderTo(s)}},{key:"buildEditingForm",value:function t(e){var s=this;var i=this.cleanTypeForm();n.Dom.append(this.renderEditingForm(e),i);this.initParticipantsSelector(e);var r=this.node.querySelector(".ui-form-content-dod-list");var a=this.showLoader(r);this.requestSender.getChecklist({groupId:this.groupId,typeId:e.getId()}).then((function(t){a.hide();top.BX.Runtime.html(r,t.data.html)}))["catch"]((function(t){a.hide();s.requestSender.showErrorAlert(t)}))}},{key:"buildEmptyForm",value:function t(){var e=this.cleanTypeForm();n.Dom.append(this.renderEmptyForm(),e)}},{key:"onSwitchType",value:function t(e){var s=this;var i=e.getData();var n=this.tabs.getPreviousType();if(n){this.saveSettings(n).then((function(t){var e=t.data.type;n.setDodRequired(e.dodRequired);n.setParticipants(e.participants);s.buildEditingForm(i)}))}else{this.buildEditingForm(i)}}},{key:"onCreateType",value:function t(e){var s=this;var i=this.node.querySelector(".tasks-scrum-dod-settings-container-sidebar-wrapper");var n=this.showLoader(i);var r=e.getData();this.requestSender.createType({groupId:this.groupId,name:r.getName(),sort:r.getSort()}).then((function(t){n.hide();var e=new c(t.data);s.typeStorage.addType(e);s.tabs.addType(e,r)}))["catch"]((function(t){n.hide();s.requestSender.showErrorAlert(t)}))}},{key:"onChangeTypeName",value:function t(e){var s=this;var i=e.getData();this.requestSender.changeTypeName({groupId:this.groupId,id:i.getId(),name:i.getName()})["catch"]((function(t){s.requestSender.showErrorAlert(t)}))}},{key:"onRemoveType",value:function t(e){var s=this;var i=e.getData();this.requestSender.removeType({groupId:this.groupId,id:i.getId()}).then((function(){s.typeStorage.removeType(i);if(s.tabs.isEmpty()){s.buildEmptyForm()}else{var t=babelHelpers.toConsumableArray(s.typeStorage.getTypes().values()).find((function(t){return!s.tabs.isEmptyType(t)}));s.tabs.switchToType(t)}}))["catch"]((function(t){s.requestSender.showErrorAlert(t)}))}},{key:"saveSettings",value:function t(e){var s=this;if(this.tabs.isEmpty()){return Promise.resolve()}var i=e?e:this.tabs.getActiveType();if(!(i instanceof c)){return Promise.resolve()}return this.requestSender.saveSettings({groupId:this.groupId,typeId:i.getId(),requiredOption:this.getRequiredOptionValue(),items:this.getChecklistItems(),participants:this.getSelectedParticipants()})["catch"]((function(t){s.requestSender.showErrorAlert(t)}))}},{key:"getChecklistItems",value:function t(){if(typeof top.BX.Tasks.CheckListInstance==="undefined"){return[]}var e=top.BX.Tasks.CheckListInstance.getTreeStructure();return e.getRequestData()}},{key:"getSelectedParticipants",value:function t(){if(n.Type.isNil(this.participantsSelector)){return[]}var e=[];this.participantsSelector.getTags().forEach((function(t){e.push({id:t.getId(),entityId:t.getEntityId()})}));return e}},{key:"getRequiredOptionValue",value:function t(){var e=this.node.querySelector(".ui-form-content-required-option");return e.checked===true?"Y":"N"}},{key:"showLoader",value:function t(e){var s=n.Dom.getPosition(e);var i=new a.Loader({target:e,size:60,mode:"inline",color:"rgba(82, 92, 105, 0.9)",offset:{left:"".concat(s.width/2-30,"px")}});i.show();return i}},{key:"getActiveType",value:function t(){return this.tabs.getActiveType()}},{key:"updateActiveType",value:function t(){var e=this.tabs.getActiveType();e.setDodRequired(this.getRequiredOptionValue())}},{key:"cleanTypeForm",value:function t(){var e=this.node.querySelector(".tasks-scrum-dod-settings-container-sidebar-wrapper");n.Dom.clean(e);return e}},{key:"addEmptyCreationType",value:function t(){var e=new c;this.tabs.setEmptyType(e);this.typeStorage.addType(e)}}]);return t}();var C,L;var w=function(t){babelHelpers.inherits(e,t);function e(t){var s;babelHelpers.classCallCheck(this,e);s=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));s.setEventNamespace("BX.Tasks.Scrum.Dod.List");s.requestSender=t.requestSender;s.groupId=parseInt(t.groupId,10);s.taskId=parseInt(t.taskId,10);s.skipNotifications=n.Type.isBoolean(t.skipNotifications)?t.skipNotifications:false;s.typeStorage=new d;s.tabs=new f;s.empty=true;s.activeTypeData=null;s.node=null;return s}babelHelpers.createClass(e,[{key:"renderContent",value:function t(){var e=this;return this.requestSender.getSettings({groupId:this.groupId,taskId:this.taskId,saveRequest:this.isSkipNotifications()?"Y":"N"}).then((function(t){var s=n.Type.isArray(t.data.types)?t.data.types:[];var i=n.Type.isInteger(t.data.activeTypeId)?parseInt(t.data.activeTypeId,10):0;e.empty=s.length===0;var r=new Map;s.forEach((function(t){var e=new c(t);r.set(e.getId(),e)}));e.typeStorage.setTypes(r);e.tabs.setTypeStorage(e.typeStorage);var a=r.get(i);if(n.Type.isUndefined(a)){e.tabs.setActiveType(e.typeStorage.getNextType())}else{e.tabs.setActiveType(a)}if(e.isEmpty()){if(!e.isSkipNotifications()){e.emit("resolve")}return e.renderEmpty()}return e.render()}))["catch"]((function(t){e.requestSender.showErrorAlert(t)}))}},{key:"renderList",value:function t(){var e=this;var s=this.node.querySelector(".tasks-scrum-dod-checklist");n.Dom.clean(s);var i=this.showLoader(s);this.requestSender.getList({groupId:this.groupId,taskId:this.taskId,typeId:this.getActiveType().getId()}).then((function(t){i.hide();top.BX.Runtime.html(s,t.data.html)}))["catch"]((function(t){e.requestSender.showErrorAlert(t)}))}},{key:"renderEmpty",value:function t(){var e=this;var s=n.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-form ui-form-line tasks-scrum-dod-form">\n\t\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"])),n.Loc.getMessage("TASKS_SCRUM_DOD_LABEL_EMPTY"));n.Event.bind(s.querySelector("span"),"click",(function(){return e.emit("showSettings")}));return s}},{key:"render",value:function t(){var e=this;var s=this.getActiveType();var i=function t(e){var i=s.getId()===e.id?"selected":"";return'<option value="'.concat(parseInt(e.id,10),'" ').concat(i,">").concat(n.Text.encode(e.name),"</option>")};this.node=n.Tag.render(L||(L=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-form ui-form-line tasks-scrum-dod-form">\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-label">\n\t\t\t\t\t\t<div class="ui-ctl-label-text">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="ui-form-content">\n\t\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown">\n\t\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t\t\t\t<select class="ui-ctl-element tasks-scrum-dod-types">\n\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t</select>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-form-row">\n\t\t\t\t\t<div class="ui-form-content tasks-scrum-dod-checklist"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),n.Loc.getMessage("TASKS_SCRUM_DOD_LABEL_TYPES"),babelHelpers.toConsumableArray(this.typeStorage.getTypes().values()).map((function(t){return i(t)})).join(""));var r=this.node.querySelector(".tasks-scrum-dod-types");n.Event.bind(r,"change",(function(t){var s=parseInt(t.target.value,10);e.tabs.setActiveType(e.typeStorage.getType(s));e.renderList()}));return this.node}},{key:"save",value:function t(){var e=this;var s=this.getActiveType();this.requestSender.saveList({typeId:s.getId(),taskId:this.taskId,groupId:this.groupId,items:this.getListItems()}).then((function(){if(e.isSkipNotifications()){e.solve()}else{if(e.isListRequired(e.getActiveType())){if(e.isAllToggled()){e.emit("resolve")}else{e.emit("reject");e.showInfoPopup()}}else{if(e.isAllToggled()){e.emit("resolve")}else{e.showConfirmPopup()}}}}))["catch"]((function(t){e.requestSender.showErrorAlert(t)}))}},{key:"isSkipNotifications",value:function t(){return this.skipNotifications}},{key:"isEmpty",value:function t(){return this.empty}},{key:"getActiveType",value:function t(){return this.tabs.getActiveType()}},{key:"isListRequired",value:function t(e){return e.isDodRequired()}},{key:"solve",value:function t(){if(this.isListRequired(this.getActiveType())){if(this.isAllToggled()){this.emit("resolve")}else{this.emit("reject")}}else{this.emit("resolve")}}},{key:"getListItems",value:function t(){if(typeof top.BX.Tasks.CheckListInstance==="undefined"){return[]}var e=top.BX.Tasks.CheckListInstance.getTreeStructure();return e.getRequestData()}},{key:"isAllToggled",value:function t(){if(typeof top.BX.Tasks.CheckListInstance==="undefined"){return false}var t=true;var e=top.BX.Tasks.CheckListInstance.getTreeStructure();e.getDescendants().forEach((function(e){if(e.countTotalCount()>0&&!e.checkIsComplete()){t=false}}));return t}},{key:"showInfoPopup",value:function t(){o.MessageBox.alert(n.Loc.getMessage("TASKS_SCRUM_DOD_INFO_TEXT"))}},{key:"showConfirmPopup",value:function t(){var e=this;var s=new o.MessageBox({message:n.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_TEXT_COMPLETE"),modal:true,buttons:[new u.Button({text:n.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_COMPLETE_BUTTON_TEXT"),color:u.Button.Color.SUCCESS,events:{click:function t(){e.emit("resolve");s.close()}}}),new u.Button({text:n.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_SAVE_BUTTON_TEXT"),color:u.Button.Color.LINK,events:{click:function t(){e.emit("reject");s.close()}}})]});s.show()}},{key:"showLoader",value:function t(e){var s=n.Dom.getPosition(e);var i=new a.Loader({target:e,size:60,mode:"inline",color:"rgba(82, 92, 105, 0.9)",offset:{left:"".concat(s.width/2-30,"px")}});i.show();return i}}]);return e}(r.EventEmitter);var q=function(t){babelHelpers.inherits(s,t);function s(t){var e;babelHelpers.classCallCheck(this,s);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(s).call(this,t));e.setEventNamespace("BX.Tasks.Scrum.Dod");e.view=t.view;e.groupId=parseInt(t.groupId,10);e.taskId=parseInt(t.taskId,10);e.sidePanelManager=BX.SidePanel.Instance;e.requestSender=new m;e.settings=new E({requestSender:e.requestSender,groupId:e.groupId,taskId:e.taskId});e.list=new w({requestSender:e.requestSender,groupId:e.groupId,taskId:e.taskId,skipNotifications:t.skipNotifications});e.list.subscribe("resolve",(function(){return e.emit("resolve")}));e.list.subscribe("reject",(function(){return e.emit("reject")}));e.list.subscribe("showSettings",(function(){e.sidePanelManager.close(false,(function(){return e.showSettings()}))}));return e}babelHelpers.createClass(s,[{key:"isNecessary",value:function t(){var e=this;return this.requestSender.isNecessary({groupId:this.groupId,taskId:this.taskId}).then((function(t){return t.data}))["catch"]((function(t){e.requestSender.showErrorAlert(t)}))}},{key:"show",value:function t(){switch(this.view){case"settings":this.showSettings();break;case"list":this.showList();break}}},{key:"showSettings",value:function t(){var s=this;this.sidePanelManager.open("tasks-scrum-dod-settings-side-panel",{cacheable:false,width:1e3,contentCallback:function t(){return e.Layout.createContent({extensions:["tasks.scrum.dod","ui.entity-selector"],title:n.Loc.getMessage("TASKS_SCRUM_DOD_TITLE"),content:s.createSettingsContent.bind(s),design:{section:false},buttons:[]})},events:{onLoad:this.onLoadSettings.bind(this),onClose:this.onCloseSettings.bind(this)}})}},{key:"showList",value:function t(){var s=this;this.sidePanelManager.open("tasks-scrum-dod-list-side-panel",{cacheable:false,width:800,contentCallback:function t(){return e.Layout.createContent({extensions:["tasks.scrum.dod"],title:n.Loc.getMessage("TASKS_SCRUM_DOD_TITLE"),content:s.createListContent.bind(s),design:{section:false},buttons:function t(e){var i=e.cancelButton,n=e.SaveButton;return[new n({text:s.getListButtonText(),onclick:s.onSaveList.bind(s)}),i]}})},events:{onLoad:this.onLoadList.bind(this)}})}},{key:"createSettingsContent",value:function t(){var e=this;return new Promise((function(t,s){e.settings.renderContent().then((function(e){t(e)}))}))}},{key:"createListContent",value:function t(){var e=this;return new Promise((function(t,s){e.list.renderContent().then((function(e){t(e)}))}))}},{key:"onLoadSettings",value:function t(){if(!this.settings.isEmpty()){this.settings.buildEditingForm(this.settings.getActiveType())}}},{key:"onLoadList",value:function t(){if(this.list.isEmpty()){return}this.list.renderList()}},{key:"onCloseSettings",value:function t(){this.settings.saveSettings().then((function(){}))["catch"]((function(){}))}},{key:"onSaveList",value:function t(){if(this.list.isEmpty()){return}this.list.save();this.sidePanelManager.close(false)}},{key:"getListButtonText",value:function t(){if(this.list.isSkipNotifications()){return n.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_SAVE_BUTTON_TEXT")}else{return n.Loc.getMessage("TASKS_SCRUM_DOD_CONFIRM_COMPLETE_BUTTON_TEXT")}}}]);return s}(r.EventEmitter);t.Dod=q})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX.UI.SidePanel,BX.UI,BX,BX,BX.Event,BX,BX.UI.Dialogs,BX.UI);
//# sourceMappingURL=dod.bundle.map.js