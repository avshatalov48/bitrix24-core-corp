this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(t,e,i,n,r){"use strict";var s=function(){function t(){babelHelpers.classCallCheck(this,t)}babelHelpers.createClass(t,[{key:"sendRequest",value:function t(e,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return new Promise(function(t,r){top.BX.ajax.runAction("bitrix:tasks.scrum."+e+"."+i,{data:n}).then(t,r)})}},{key:"showErrorAlert",value:function t(e,i){if(r.Type.isUndefined(e.errors)){console.log(e);return}if(e.errors.length){var n=e.errors.shift();if(n){var s=n.code?n.code:"";var a=n.message+" "+s;var o=i?i:r.Loc.getMessage("TSE_ERROR_POPUP_TITLE");top.BX.UI.Dialogs.MessageBox.alert(a,o)}}}}]);return t}();var a,o,c,d,l,u,p;var f=function(t){babelHelpers.inherits(f,t);function f(t){var e;babelHelpers.classCallCheck(this,f);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(f).call(this,t));e.setEventNamespace("BX.Tasks.Scrum.Epic");e.view=t.view?t.view:"";e.groupId=parseInt(t.groupId,10);e.epicId=parseInt(t.epicId,10);e.requestSender=new s;e.sidePanelManager=BX.SidePanel.Instance;e.sidePanel=null;e.id=r.Text.getRandom();e.form=null;e.formData=null;e.listData=null;e.editorHandler=null;e.defaultColor="#69dafc";e.selectedColor="";return e}babelHelpers.createClass(f,[{key:"show",value:function t(){switch(this.view){case"add":this.showAddForm();break;case"list":this.showList();break;case"view":this.showViewForm();break;case"edit":this.showEditForm();break}}},{key:"showAddForm",value:function t(){var e=this;this.sidePanelManager.open("tasks-scrum-epic-add-form-side-panel",{cacheable:false,width:800,contentCallback:function t(){return i.Layout.createContent({extensions:["tasks.scrum.epic"],title:r.Loc.getMessage("TASKS_SCRUM_ADD_EPIC_FORM_TITLE"),content:e.createAddContent.bind(e),design:{section:false},buttons:function t(i){var n=i.cancelButton,r=i.SaveButton;return[new r({onclick:e.onSaveAddForm.bind(e)}),n]}})},events:{onLoad:this.onLoadAddForm.bind(this)}})}},{key:"showList",value:function t(){var e=this;this.gridId="EntityEpicsGrid_"+this.groupId;var n="tasks-scrum-epic-list-side-panel";this.subscribeListToEvents(n);this.sidePanelManager.open(n,{cacheable:false,contentCallback:function t(){return i.Layout.createContent({extensions:["tasks.scrum.epic"],title:r.Loc.getMessage("TASKS_SCRUM_SPRINT_ADD_EPIC_LIST_TITLE"),toolbar:function t(i){var n=i.Button;return[new n({text:r.Loc.getMessage("TASKS_SCRUM_SPRINT_ADD_EPIC_LIST_TOOLBAR_BUTTON"),color:n.Color.PRIMARY,onclick:function t(){e.showAddForm()}})]},content:e.createListContent.bind(e),design:{section:false},buttons:[]})},events:{onLoad:this.onLoadList.bind(this)}})}},{key:"showViewForm",value:function t(){var n=this;this.subscribeViewToEvents();this.sidePanelManager.open("tasks-scrum-epic-view-form-side-panel",{cacheable:false,width:800,contentCallback:function t(){return new Promise(function(t,s){n.getEpic().then(function(s){var a=s.data;t(i.Layout.createContent({extensions:["tasks.scrum.epic"],title:r.Loc.getMessage("TASKS_SCRUM_VIEW_EPIC_FORM_TITLE"),content:n.createViewContent.bind(n,a),design:{section:false},buttons:function t(i){var s=i.cancelButton,o=i.SaveButton;return[new o({text:r.Loc.getMessage("TASKS_SCRUM_EPIC_EDIT_BUTTON"),onclick:function t(){n.sidePanel.close(false,function(){e.EventEmitter.emit(n.getEventNamespace()+":"+"openEdit",a.id)})}}),s]}}))})})},events:{onLoad:this.onLoadViewForm.bind(this)}})}},{key:"showEditForm",value:function t(){var e=this;this.sidePanelManager.open("tasks-scrum-epic-edit-form-side-panel",{cacheable:false,width:800,contentCallback:function t(){return i.Layout.createContent({extensions:["tasks.scrum.epic"],title:r.Loc.getMessage("TASKS_SCRUM_EDIT_EPIC_FORM_TITLE"),content:e.createEditContent.bind(e),design:{section:false},buttons:function t(i){var n=i.cancelButton,r=i.SaveButton;return[new r({onclick:e.onSaveEditForm.bind(e)}),n]}})},events:{onLoad:this.onLoadEditForm.bind(this)}})}},{key:"removeEpic",value:function t(){var i=this;return r.ajax.runAction("bitrix:tasks.scrum.epic.removeEpic",{data:{groupId:this.groupId,epicId:this.epicId}}).then(function(t){e.EventEmitter.emit(i.getEventNamespace()+":"+"afterRemove",t.data);return true}).catch(function(t){i.requestSender.showErrorAlert(t)})}},{key:"subscribeListToEvents",value:function t(i){var n=this;e.EventEmitter.subscribe(this.getEventNamespace()+":"+"afterAdd",function(){n.reloadSidePanel(i)});top.BX.Event.EventEmitter.subscribe(this.getEventNamespace()+":"+"afterEdit",function(){n.reloadSidePanel(i)})}},{key:"subscribeViewToEvents",value:function t(){var i=this;e.EventEmitter.subscribe(this.getEventNamespace()+":"+"openEdit",function(t){f.showEdit(i.groupId,t.getData())})}},{key:"reloadSidePanel",value:function t(e){if(r.Type.isUndefined(e)){this.sidePanelManager.reload()}else{var i=this.sidePanelManager.getOpenSliders();if(i.length>0){i.forEach(function(t){if(t.getUrl()===e){t.reload()}})}}}},{key:"createAddContent",value:function t(){var e=this;return new Promise(function(t,i){top.BX.ajax.runAction("bitrix:tasks.scrum.epic.getDescriptionEditor",{data:{groupId:e.groupId,editorId:e.id}}).then(function(i){e.formData=i.data;t(e.renderAddForm())}).catch(function(t){e.requestSender.showErrorAlert(t)})})}},{key:"createListContent",value:function t(){var e=this;return new Promise(function(t,i){top.BX.ajax.runAction("bitrix:tasks.scrum.epic.getList",{data:{groupId:e.groupId,gridId:e.gridId}}).then(function(i){e.listData=i.data;t(e.renderList())}).catch(function(t){e.requestSender.showErrorAlert(t)})})}},{key:"createViewContent",value:function t(e){var i=this;return new Promise(function(t,n){top.BX.ajax.runAction("bitrix:tasks.scrum.epic.getEpicFiles",{data:{groupId:i.groupId,epicId:e.id}}).then(function(n){i.epicFiles=r.Type.isUndefined(n.data.html)?"":n.data.html;t(i.renderViewForm(e))}).catch(function(t){i.requestSender.showErrorAlert(t)})})}},{key:"createEditContent",value:function t(){var e=this;return new Promise(function(t,i){e.getEpic().then(function(i){var n=i.data;top.BX.ajax.runAction("bitrix:tasks.scrum.epic.getDescriptionEditor",{data:{groupId:e.groupId,editorId:e.id,epicId:n.id,text:n.description}}).then(function(i){e.currentEpic=n;e.formData=i.data;t(e.renderEditForm(n))}).catch(function(t){e.requestSender.showErrorAlert(t)})})})}},{key:"getEpic",value:function t(){var e=this;return new Promise(function(t,i){r.ajax.runAction("bitrix:tasks.scrum.epic.getEpic",{data:{groupId:e.groupId,epicId:e.epicId}}).then(t,i)})}},{key:"onLoadAddForm",value:function t(e){this.sidePanel=e.getSlider();this.form=this.sidePanel.getContainer().querySelector(".tasks-scrum-epic-form");var i=this.form.querySelector(".tasks-scrum-epic-form-description");if(r.Type.isUndefined(this.formData.html)){return}this.renderEditor(i)}},{key:"onSaveAddForm",value:function t(){var i=this;r.ajax.runAction("bitrix:tasks.scrum.epic.createEpic",{data:this.getRequestData()}).then(function(t){i.sidePanel.close(false,function(){e.EventEmitter.emit(i.getEventNamespace()+":"+"afterAdd",t.data)})}).catch(function(t){i.requestSender.showErrorAlert(t)})}},{key:"onLoadList",value:function t(e){var i=this;this.sidePanel=e.getSlider();var n=this.sidePanel.getContainer().querySelector(".tasks-scrum-epic-list");if(r.Type.isUndefined(this.listData.html)){r.Dom.append(this.renderListBlank(),n);r.Event.bind(n.querySelector(".tasks-scrum-epics-empty-button"),"click",this.showAddForm.bind(this))}else{top.BX.Runtime.html(n,this.listData.html).then(function(){top.BX.addCustomEvent("Grid::beforeRequest",i.onBeforeGridRequest.bind(i));i.prepareTagsList(n)})}}},{key:"onLoadViewForm",value:function t(e){this.sidePanel=e.getSlider();if(this.epicFiles){var i=this.sidePanel.getContainer().querySelector(".tasks-scrum-epic-form-files");r.Runtime.html(i,this.epicFiles)}}},{key:"onLoadEditForm",value:function t(e){this.sidePanel=e.getSlider();this.form=this.sidePanel.getContainer().querySelector(".tasks-scrum-epic-form");var i=this.form.querySelector(".tasks-scrum-epic-form-description");if(r.Type.isUndefined(this.formData.html)){return}this.renderEditor(i)}},{key:"onSaveEditForm",value:function t(){var e=this;r.ajax.runAction("bitrix:tasks.scrum.epic.editEpic",{data:this.getRequestData()}).then(function(t){e.sidePanel.close(false,function(){top.BX.Event.EventEmitter.emit(e.getEventNamespace()+":"+"afterEdit",t.data)})}).catch(function(t){e.requestSender.showErrorAlert(t)})}},{key:"onBeforeGridRequest",value:function t(e,i){i.sessid=BX.bitrix_sessid();i.method="POST";if(!i.url){i.url=this.getListUrl()}i.data=babelHelpers.objectSpread({},i.data,{groupId:this.groupId,gridId:this.gridId})}},{key:"getListUrl",value:function t(){return"/bitrix/services/main/ajax.php?action=bitrix:tasks.scrum.epic.getList"}},{key:"renderAddForm",value:function t(){return r.Tag.render(a||(a=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-epic-form">\n\t\t\t\t<div class="tasks-scrum-epic-form-container">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),this.renderNameField("",this.defaultColor),this.renderDescriptionField())}},{key:"renderList",value:function t(){return r.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['<div class="tasks-scrum-epic-list"></div>'])))}},{key:"renderViewForm",value:function t(e){return r.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-epic-form">\n\t\t\t\t<div class="tasks-scrum-epic-form-container">\n\t\t\t\t\t<div class="tasks-scrum-epic-form-header">\n\t\t\t\t\t\t<div class="tasks-scrum-epic-form-header-title">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="tasks-scrum-epic-form-header-separate"></div>\n\t\t\t\t\t\t<div class="tasks-scrum-epic-header-color">\n\t\t\t\t\t\t\t<div class="tasks-scrum-epic-header-color-current" style=\n\t\t\t\t\t\t\t\t"background-color: ',';">\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-epic-form-body">\n\t\t\t\t\t\t<div class="tasks-scrum-epic-form-description">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="tasks-scrum-epic-form-files"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),r.Text.encode(e.name),r.Text.encode(e.color),e.description)}},{key:"renderEditForm",value:function t(e){this.selectedColor=e.color;return r.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-epic-form">\n\t\t\t\t<div class="tasks-scrum-epic-form-container">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),this.renderNameField(e.name,this.selectedColor),this.renderDescriptionField())}},{key:"renderNameField",value:function t(e,i){var n=this;var s=r.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-epic-form-header">\n\t\t\t\t<div class="tasks-scrum-epic-form-header-title">\n\t\t\t\t\t<input type="text" name="name" value="','" class=\n\t\t\t\t\t\t"tasks-scrum-epic-form-header-title-control" placeholder=\n\t\t\t\t\t\t"','">\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-epic-form-header-separate"></div>\n\t\t\t\t<div class="tasks-scrum-epic-header-color">\n\t\t\t\t\t<div class="tasks-scrum-epic-header-color-current" style=\n\t\t\t\t\t\t"background-color: ',';">\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum-epic-header-color-btn-angle"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t'])),r.Text.encode(e),r.Loc.getMessage("TASKS_SCRUM_SPRINT_ADD_EPIC_NAME_PLACEHOLDER"),r.Text.encode(i));var a=s.querySelector(".tasks-scrum-epic-header-color");r.Event.bind(a,"click",function(){var t=a.querySelector(".tasks-scrum-epic-header-color-current");var e=n.getColorPicker(t);e.open()});return s}},{key:"renderDescriptionField",value:function t(){return r.Tag.render(u||(u=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-epic-form-body">\n\t\t\t\t<div class="tasks-scrum-epic-form-description --editing"></div>\n\t\t\t</div>\n\t\t'])))}},{key:"renderEditor",value:function t(i){var n=this;setTimeout(function(){top.BX.Runtime.html(i,n.formData.html).then(function(){if(window.top.LHEPostForm){n.editorHandler=window.top.LHEPostForm.getHandler(n.id);e.EventEmitter.emit(n.editorHandler.eventNode,"OnShowLHE",[true]);var t=n.form.querySelector(".tasks-scrum-epic-form-description")}n.focusToName()})},300)}},{key:"renderListBlank",value:function t(){return r.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-epics-empty">\n\t\t\t\t<div class="tasks-scrum-epics-empty-first-title">\n\t\t\t\t\t','\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-epics-empty-image">\n\t\t\t\t\t<svg width="124px" height="123px" viewBox="0 0 124 123" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">\n\t\t\t\t\t\t<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" opacity="0.28">\n\t\t\t\t\t\t\t<path d="M83,105 L83,81.4375 L105,81.4375 L105,18 L17,18 L17,81.4375 L39,81.4375 L39,105 L83,105 Z M10.9411765,0 L113.058824,0 C119.101468,0 124,4.85902727 124,10.8529412 L124,112.147059 C124,118.140973 119.101468,123 113.058824,123 L10.9411765,123 C4.89853156,123 0,118.140973 0,112.147059 L0,10.8529412 C0,4.85902727 4.89853156,0 10.9411765,0 Z M44.0142862,47.0500004 L54.2142857,57.4416671 L79.7142857,32 L87,42.75 L54.2142857,75 L36,57.0833333 L44.0142862,47.0500004 Z" fill="#A8ADB4" />\n\t\t\t\t\t\t</g>\n\t\t\t\t\t</svg>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-epics-empty-second-title">\n\t\t\t\t\t','\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-epics-empty-button">\n\t\t\t\t\t<button class="ui-btn ui-btn-primary ui-btn-lg">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),r.Loc.getMessage("TASKS_SCRUM_EPICS_EMPTY_FIRST_TITLE"),r.Loc.getMessage("TASKS_SCRUM_EPICS_EMPTY_SECOND_TITLE"),r.Loc.getMessage("TASKS_SCRUM_SPRINT_ADD_EPIC_LIST_TOOLBAR_BUTTON"))}},{key:"getGrid",value:function t(){if(top.BX&&top.BX.Main&&top.BX.Main.gridManager){return top.BX.Main.gridManager.getById(this.gridId)}return null}},{key:"prepareTagsList",value:function t(e){var i=this;var n=e.querySelectorAll(".tasks-scrum-epic-grid-tags");n.forEach(function(t){var e=i.getTagsFromNode(t);r.Dom.clean(t);e.forEach(function(e){r.Dom.append(i.getTagNode(e),t)})})}},{key:"getTagsFromNode",value:function t(e){var i=[];e.childNodes.forEach(function(t){i.push(t.textContent.trim())});return i}},{key:"getTagNode",value:function t(i){var s=this;var a=new n.Label({text:i,color:n.Label.Color.TAG_LIGHT,fill:true,size:n.Label.Size.SM,customClass:""});var o=a.getContainer();r.Event.bind(o,"click",function(){s.sidePanel.close(false,function(){e.EventEmitter.emit(s.getEventNamespace()+":"+"filterByTag",i)})});return o}},{key:"getColorPicker",value:function t(e){var i=this;return new top.BX.ColorPicker({bindElement:e,defaultColor:this.defaultColor,selectedColor:this.selectedColor?this.selectedColor:this.defaultColor,onColorSelected:function t(n,r){i.selectedColor=n;e.style.backgroundColor=n},popupOptions:{className:"tasks-scrum-epic-color-popup"},allowCustomColor:false,colors:[["#aae9fc","#bbecf1","#98e1dc","#e3f299","#ffee95","#ffdd93","#dfd3b6","#e3c6bb"],["#ffad97","#ffbdbb","#ffcbd8","#ffc4e4","#c4baed","#dbdde0","#bfc5cd","#a2a8b0"]]})}},{key:"focusToName",value:function t(){var e=this;setTimeout(function(){e.form.querySelector(".tasks-scrum-epic-form-header-title-control").focus()},50)}},{key:"getRequestData",value:function t(){var e={};if(this.currentEpic){e.epicId=this.currentEpic.id}e.groupId=this.groupId;e.name=this.form.querySelector("[name=name]").value.trim();e.description=this.editorHandler.getEditor().GetContent();e.color=this.selectedColor?this.selectedColor:this.defaultColor;e.files=this.getAttachmentsFiles();return e}},{key:"getAttachmentsFiles",value:function t(){var e=this;var i=[];if(!this.editorHandler||!r.Type.isPlainObject(this.editorHandler.arFiles)||!r.Type.isPlainObject(this.editorHandler.controllers)){return i}var n=[];Object.values(this.editorHandler.arFiles).forEach(function(t){if(!n.includes(t)){n.push(t)}});n.forEach(function(t){if(e.editorHandler.controllers[t]&&r.Type.isPlainObject(e.editorHandler.controllers[t].values)){Object.keys(e.editorHandler.controllers[t].values).forEach(function(t){if(!i.includes(t)){i.push(t)}})}});return i}}],[{key:"showView",value:function t(e,i){var n=new f({view:"view",groupId:e,epicId:i});n.show()}},{key:"showEdit",value:function t(e,i){var n=new f({view:"edit",groupId:e,epicId:i});n.show()}},{key:"removeEpic",value:function t(e,i){var n=new f({view:"edit",groupId:e,epicId:i});n.removeEpic().then(function(){n.reloadSidePanel()})}}]);return f}(e.EventEmitter);t.Epic=f})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX.Event,BX.UI.SidePanel,BX.UI,BX);
//# sourceMappingURL=epic.bundle.map.js