this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(t,e,n,s,a,i){"use strict";var r=function(){function t(){babelHelpers.classCallCheck(this,t)}babelHelpers.createClass(t,[{key:"sendRequest",value:function t(e,n){var s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var i=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};return new Promise((function(t,r){a.ajax.runAction("bitrix:tasks.scrum."+e+"."+n,{data:s,analyticsLabel:i}).then(t,r)}))}},{key:"getDataForSprintCompletionForm",value:function t(e){return this.sendRequest("sprint","getDataForSprintCompletionForm",e)}},{key:"completeSprint",value:function t(e){return this.sendRequest("sprint","completeSprint",e,{scrum:"Y",action:"finish_sprint"})}},{key:"showErrorAlert",value:function t(e,n){if(a.Type.isUndefined(e.errors)){console.error(e);return}if(e.errors.length){var s=e.errors.shift();if(s){var r=s.code?s.code:"";var o=s.message+" "+r;var l=n?n:a.Loc.getMessage("TASKS_SCRUM_ERROR_TITLE_POPUP");i.MessageBox.alert(o,l)}}}}]);return t}();function o(t,e,n,s){p(t,e);d(n,"set");l(t,n,s);return s}function l(t,e,n){if(e.set){e.set.call(t,n)}else{if(!e.writable){throw new TypeError("attempted to set read only private field")}e.value=n}}function c(t,e,n){p(t,e);d(n,"get");return u(t,n)}function d(t,e){if(t===undefined){throw new TypeError("attempted to "+e+" private static field before its declaration")}}function p(t,e){if(t!==e){throw new TypeError("Private static access of wrong provenance")}}function u(t,e){if(e.get){return e.get.call(t)}return e.value}var m=function(){function t(){babelHelpers.classCallCheck(this,t)}babelHelpers.createClass(t,[{key:"setData",value:function t(e){this.data=e}},{key:"getDayMonthFormat",value:function t(){return this.data.dayMonthFormat}},{key:"getLongDateFormat",value:function t(){return this.data.longDateFormat}},{key:"getShortTimeFormat",value:function t(){return this.data.shortTimeFormat}}],[{key:"getInstance",value:function e(){if(!c(t,t,_)){o(t,t,_,new t)}return c(t,t,_)}}]);return t}();var _={writable:true,value:void 0};var v,g,T,f,k,S,b,h,P,L,M,y,R,I;var C=function(t){babelHelpers.inherits(e,t);function e(t){var n;babelHelpers.classCallCheck(this,e);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(e).call(this,t));n.setEventNamespace("BX.Tasks.Scrum.SprintCompletionForm");n.groupId=parseInt(t.groupId,10);n.sidePanelManager=BX.SidePanel.Instance;n.sidePanelId="tasks-scrum-sprint-completion-form-side-panel";n.requestSender=new r;n.node=null;n.completeButton=null;return n}babelHelpers.createClass(e,[{key:"show",value:function t(){var e=this;this.sidePanelManager.open(this.sidePanelId,{cacheable:false,width:700,contentCallback:function t(){return n.Layout.createContent({extensions:["tasks.scrum.sprint-completion-form"],title:a.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETION_FORM_TITLE"),content:e.createContent.bind(e),design:{section:false},buttons:function t(n){var s=n.cancelButton,i=n.SaveButton;return[e.completeButton=new i({text:a.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETION_FORM_BUTTON"),onclick:e.onComplete.bind(e)}),s]}})}})}},{key:"onComplete",value:function t(){var e=this;var n="backlog";var i=this.node.querySelector(".tasks-scrum__side-panel-completion--info-select");if(i){i=i.querySelector("select");n=i.value}this.completeButton.setWaiting();this.requestSender.completeSprint({groupId:this.groupId,direction:n}).then((function(t){if(s.Confetti){s.Confetti.fire({particleCount:400,spread:80,origin:{x:.7,y:.2},zIndex:e.sidePanelManager.getTopSlider().getZindex()+1}).then((function(){e.closeSidePanel();e.emit("afterComplete")}))}else{e.closeSidePanel();e.emit("afterComplete")}}))["catch"]((function(t){e.completeButton.setWaiting(false);e.requestSender.showErrorAlert(t,a.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETION_ERROR_TITLE_POPUP"))}))}},{key:"closeSidePanel",value:function t(){var e=this;var n=this.sidePanelManager.getOpenSliders();if(n.length>0){n.forEach((function(t){if(t.getUrl()===e.sidePanelId){t.close(false)}}))}}},{key:"createContent",value:function t(){var e=this;return new Promise((function(t,n){e.requestSender.getDataForSprintCompletionForm({groupId:e.groupId}).then((function(n){m.getInstance().setData(n.data.culture);t(e.render(n.data))}))["catch"]((function(t){n();e.sidePanelManager.close(false,(function(){e.requestSender.showErrorAlert(t)}))}))}))}},{key:"render",value:function t(e){var n=e.storyPoints===""?0:e.storyPoints;var s=this.getPeriodDays(e.dateStart);this.node=a.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div id="','" class="tasks-scrum__scope--side-panel-completion">\n\n\t\t\t<div class="tasks-scrum__side-panel-completion--block">\n\n\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-basic">\n\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-basic-block">\n\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-basic-title">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t",'\n\t\t\t\t</div>\n\n\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-additional">\n\n\t\t\t\t\t','\n\n\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-row">\n\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-title">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-content tasks-scrum__side-panel-completion--sprint-timing">\n\t\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--date-name-block">\n\t\t\t\t\t\t\t\t<div>',"</div>\n\t\t\t\t\t\t\t\t<div>","</div>\n\t\t\t\t\t\t\t\t",'\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--date-result-block">\n\t\t\t\t\t\t\t\t<div>',"</div>\n\t\t\t\t\t\t\t\t<div>","</div>\n\t\t\t\t\t\t\t\t",'\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-row">\n\n\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-title">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-content">\n\t\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--plan-block">\n\n\t\t\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--sprint-plans">\n\t\t\t\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--plan-block-number --percent">\n\t\t\t\t\t\t\t\t\t\t<div \n\t\t\t\t\t\t\t\t\t\t\tclass="tasks-scrum__side-panel-completion--plan-block-number-date"\n\t\t\t\t\t\t\t\t\t\t\ttitle="','"\n\t\t\t\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--plan-block-name">\n\t\t\t\t\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--plan-block-name-text">\n\t\t\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div class="ui-hint">\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tclass="ui-hint-icon"\n\t\t\t\t\t\t\t\t\t\t\t\tdata-hint="','"\n\t\t\t\t\t\t\t\t\t\t\t\tdata-hint-no-icon\n\t\t\t\t\t\t\t\t\t\t\t></span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--sprint-plans">\n\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--plan-block-name">\n\t\t\t\t\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--plan-block-name-text">\n\t\t\t\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t<div class="ui-hint">\n\t\t\t\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\t\t\t\tclass="ui-hint-icon"\n\t\t\t\t\t\t\t\t\t\t\t\tdata-hint="','"\n\t\t\t\t\t\t\t\t\t\t\t\tdata-hint-no-icon\n\t\t\t\t\t\t\t\t\t\t\t></span>\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t',"\n\n\t\t\t</div>\n\t\t"])),a.Text.getRandom(),a.Text.encode(e.name),this.renderGoal(e.info.sprintGoal),this.renderEpics(e.epics),a.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETION_FORM_TIME_ROW_LABEL"),a.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETION_FORM_DATE_START_LABEL"),a.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETION_FORM_DATE_END_LABEL"),this.renderLabelPeriodDays(s),this.getFormattedDateStart(e.dateStart),this.getFormattedDateStart(e.dateEnd),this.renderPeriodDays(s),a.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETION_FORM_PLAN_ROW_LABEL"),a.Text.encode(n),a.Text.encode(n),a.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETION_FORM_PLAN_SP"),a.Loc.getMessage("TSS_START_STORY_POINTS_HINT"),this.renderWheelCompletedStoryPoints(e),a.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETION_FORM_DONE_SP"),a.Loc.getMessage("TSS_START_STORY_POINTS_HINT"),this.renderUncompletedTasks(e));this.initHints(this.node);return this.node}},{key:"renderLabelPeriodDays",value:function t(e){if(a.Type.isNull(e)){return""}return a.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(["<div>","</div>"])),a.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETION_FORM_PERIOD_LABEL"))}},{key:"renderPeriodDays",value:function t(e){if(a.Type.isNull(e)){return""}return a.Tag.render(T||(T=babelHelpers.taggedTemplateLiteral(["<div>","</div>"])),a.Text.encode(e))}},{key:"renderGoal",value:function t(e){if(e===""){return""}return a.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum__side-panel-completion--info-basic-block">\n\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-basic-description">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),a.Text.encode(e))}},{key:"renderEpics",value:function t(e){var n=this;if(!e.length){return""}return a.Tag.render(k||(k=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum__side-panel-completion--info-row">\n\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-title">\n\t\t\t\t\t','\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-content">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),a.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETION_FORM_EPICS_ROW_LABEL"),e.map((function(t){var e=n.convertHexToRGBA(t.color,.7);var s=n.convertHexToRGBA(t.color,.3);return a.Tag.render(S||(S=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t\t<span\n\t\t\t\t\t\t\t\t\tclass="tasks-scrum__epic-label"\n\t\t\t\t\t\t\t\t\tstyle="background: ',"; border-color: ",';"\n\t\t\t\t\t\t\t\t>',"</span>"])),s,e,a.Text.encode(t.name))})))}},{key:"renderWheelCompletedStoryPoints",value:function t(e){var n=0;var s=this.calculatePercentage(e.storyPoints,e.completedStoryPoints);if(e.existsLastSprint){var i=this.calculatePercentage(e.lastStoryPoints,e.lastCompletedStoryPoints);n=parseFloat(s)-parseFloat(i)}else{n=s}var r="";if(n>0){r="tasks-scrum__side-panel-completion--plan-block-number --arrow-up --percent --success"}else{r="tasks-scrum__side-panel-completion--plan-block-number --arrow-down --percent --warning"}var o=Math.abs(n);var l=function t(e){if(e===0){return""}return a.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="tasks-scrum__side-panel-completion--progress">\n\t\t\t\t\t<span class="tasks-scrum__side-panel-completion--progress-number">','</span>\n\t\t\t\t\t<span class="tasks-scrum__side-panel-completion--progress-percent">%</span></div>\n\t\t\t\t</div>\n\t\t\t'])),e)};return a.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="','">\n\t\t\t\t<div \n\t\t\t\t\tclass="tasks-scrum__side-panel-completion--plan-block-number-date"\n\t\t\t\t\ttitle="','"\n\t\t\t\t>\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t\t","\n\t\t\t</div>\n\t\t"])),r,a.Text.encode(e.completedStoryPoints),a.Text.encode(e.completedStoryPoints),l(o))}},{key:"renderUncompletedTasks",value:function t(e){var n=this;if(e.uncompletedTasks.length===0){return""}return a.Tag.render(P||(P=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum__side-panel-completion--block">\n\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-basic">\n\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-basic-block">\n\t\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-basic-title-icon">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-basic-description">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t\t",'\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum__side-panel-completion--info-items">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),a.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETION_FORM_ACTION_ROW_LABEL"),a.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETION_FORM_ACTION_MOVE_LABEL"),this.renderMoveSelect(e.plannedSprints),e.uncompletedTasks.map((function(t){return n.renderItem(t)})))}},{key:"renderMoveSelect",value:function t(e){var n="ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w100";var s="";e.forEach((function(t){s+='<option value="'.concat(t.id,'">').concat(a.Text.encode(t.name),"</option>")}));return a.Tag.render(L||(L=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum__side-panel-completion--info-select ','">\n\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\n\t\t\t\t<select class="ui-ctl-element">\n\t\t\t\t\t<option value="backlog">\n\t\t\t\t\t\t','\n\t\t\t\t\t</option>\n\t\t\t\t\t<option value="0">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</option>\n\t\t\t\t\t","\n\t\t\t\t</select>\n\t\t\t</div>\n\t\t"])),n,a.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETION_FORM_SELECTOR_BACKLOG"),a.Loc.getMessage("TASKS_SCRUM_SPRINT_COMPLETION_FORM_SELECTOR_SPRINT"),s)}},{key:"renderItem",value:function t(e){var n=this;var s=e.responsible.photo?a.Text.encode(e.responsible.photo.src):null;var i=s?"background-image: url('".concat(encodeURI(s),"');"):"";var r=e.storyPoints===""?"--empty":"";var o=a.Tag.render(M||(M=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum__item-side-panel">\n\t\t\t\t<div class="tasks-scrum__item-side-panel--info">\n\t\t\t\t\t<div class="tasks-scrum__item-side-panel--main-info">\n\t\t\t\t\t\t<div class="tasks-scrum__item-side-panel--title">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="tasks-scrum__item-side-panel--tags">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t",'\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum__item-side-panel--responsible">\n\t\t\t\t\t<div\n\t\t\t\t\t\tclass="tasks-scrum__item-side-panel--responsible-photo ui-icon ui-icon-common-user"\n\t\t\t\t\t\ttitle="','"\n\t\t\t\t\t><i style="','"></i>\n\t\t\t\t\t</div>\n\t\t\t\t\t<span>','</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum__item-side-panel--story-points ','">\n\t\t\t\t\t<div class="tasks-scrum__item-side-panel--story-points-content">\n\t\t\t\t\t\t<div class="tasks-scrum__item-side-panel--story-points-element">\n\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),a.Text.encode(e.name),this.renderEpic(e.epic),this.renderTags(e.tags),a.Text.encode(e.responsible.name),i,a.Text.encode(e.responsible.name),r,e.storyPoints===""?"-":a.Text.encode(e.storyPoints));a.Event.bind(o,"click",(function(){return n.emit("taskClick",e.sourceId)}));return o}},{key:"renderEpic",value:function t(e){if(a.Type.isArray(e)||a.Type.isUndefined(e)){return""}return a.Tag.render(y||(y=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum__item-side-panel--epic --visible">\n\t\t\t\t<i\n\t\t\t\t\tclass="tasks-scrum__item-side-panel--epic-point"\n\t\t\t\t\tstyle="','"\n\t\t\t\t></i>\n\t\t\t\t<span>',"</span>\n\t\t\t</div>\n\t\t"])),"background-color: ".concat(e.color),a.Text.encode(e.name))}},{key:"renderTags",value:function t(e){if(e.length===0){return""}return a.Tag.render(R||(R=babelHelpers.taggedTemplateLiteral(["\n\t\t\t","\n\t\t"])),e.map((function(t){return a.Tag.render(I||(I=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="tasks-scrum__item-side-panel--hashtag --visible">#',"</div>\n\t\t\t"])),a.Text.encode(t))})))}},{key:"getFormattedDateStart",value:function t(e){return BX.date.format(m.getInstance().getLongDateFormat(),e)}},{key:"getFormattedDateEnd",value:function t(e){return BX.date.format(m.getInstance().getLongDateFormat(),e)}},{key:"getPeriodDays",value:function t(e){var n=new Date;n.setSeconds(n.getSeconds());n.setHours(0,0,0,0);var s=new Date(e*1e3);var a=new Date;if(s>=a){return null}return BX.date.format("ddiff",s,n)}},{key:"calculatePercentage",value:function t(e,n){if(e===0){return 0}var s=Math.round(n*100/e);return isNaN(s)?0:s}},{key:"convertHexToRGBA",value:function t(e,n){var s=e.replace("#","");if(s.length===3){s="".concat(s[0]).concat(s[0]).concat(s[1]).concat(s[1]).concat(s[2]).concat(s[2])}var a=parseInt(s.substring(0,2),16);var i=parseInt(s.substring(2,4),16);var r=parseInt(s.substring(4,6),16);return"rgba(".concat(a,",").concat(i,",").concat(r,",").concat(n,")")}},{key:"initHints",value:function t(e){BX.UI.Hint.popup=null;BX.UI.Hint.id="ui-hint-popup-"+ +new Date;BX.UI.Hint.init(e)}}]);return e}(e.EventEmitter);t.SprintCompletionForm=C})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX.Event,BX.UI.SidePanel,BX.UI,BX,BX.UI.Dialogs);
//# sourceMappingURL=sprint.completion.form.bundle.map.js