{"version":3,"file":"result.bundle.js","sources":["../src/result.js","../src/result-manager.js","../src/result-action.js"],"sourcesContent":["export class Result\n{\n\ttaskId: null;\n\tisClosed: false;\n\tcomments: [];\n\tcontext: null;\n\n\tconstructor(taskId: number)\n\t{\n\t\tthis.taskId = taskId;\n\t}\n\n\tsetClosed(value: boolean)\n\t{\n\t\tthis.isClosed = value;\n\t}\n\n\tsetComments(comments: [])\n\t{\n\t\tthis.comments = comments;\n\t}\n\n\tsetContext(context: string)\n\t{\n\t\tthis.context = context;\n\t}\n\n\tisResult(commentId: number)\n\t{\n\t\tif (\n\t\t\tthis.comments\n\t\t\t&& this.comments[commentId]\n\t\t)\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tpushComment(result)\n\t{\n\t\tthis.comments[result.commentId] = result;\n\t}\n\n\tdeleteComment(commentId)\n\t{\n\t\tthis.comments[commentId] && delete this.comments[commentId];\n\t}\n\n\tcanSetAsResult(commentId)\n\t{\n\t\tif (this.comments[commentId])\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tcanUnsetAsResult(commentId)\n\t{\n\t\tif (!this.comments[commentId])\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n}","import {EventEmitter} from 'main.core.events';\nimport {Result} from './result';\n\ntype initParams = {\n\ttaskId: number,\n\tcomments: [],\n\tisClosed: boolean,\n\tcontext: string\n}\n\nexport class ResultManager\n{\n\tstatic resultRegistry: Result[] = {};\n\tstatic instance = null;\n\n\tstatic getInstance()\n\t{\n\t\tif (!ResultManager.instance)\n\t\t{\n\t\t\tResultManager.instance = new ResultManager();\n\t\t}\n\t\treturn ResultManager.instance;\n\t}\n\n\tstatic showField()\n\t{\n\t\tconst node = document.getElementById('IS_TASK_RESULT');\n\t\tif (\n\t\t\t!node\n\t\t\t|| !node.closest('label')\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tnode.closest('label').classList.remove('--hidden');\n\t}\n\n\tstatic hideField()\n\t{\n\t\tconst node = document.getElementById('IS_TASK_RESULT');\n\t\tif (\n\t\t\t!node\n\t\t\t|| !node.closest('label')\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tnode.closest('label').classList.add('--hidden');\n\t}\n\n\tconstructor()\n\t{\n\t\tthis.init();\n\t}\n\n\tinit()\n\t{\n\t\tconst compatMode = {\n\t\t\tcompatMode: true\n\t\t};\n\n\t\tEventEmitter.subscribe('OnUCFormBeforeShow',(event) => {\n\t\t\tthis.onEditComment(event);\n\t\t}, compatMode);\n\n\t\tEventEmitter.subscribe('onPullEvent-tasks',(command, params) => {\n\t\t\tthis.onPushResult(command, params);\n\t\t}, compatMode);\n\n\t\tEventEmitter.subscribe('onPull-tasks',(event) => {\n\t\t\tthis.onPushResult(event.command, event.params);\n\t\t}, compatMode);\n\t}\n\n\tinitResult(params: initParams)\n\t{\n\t\tconst result = this.getResult(params.taskId);\n\t\tresult.setComments(params.comments);\n\n\t\tif (params.context)\n\t\t{\n\t\t\tresult.setContext(params.context);\n\t\t}\n\t\tif (params.isClosed)\n\t\t{\n\t\t\tresult.setClosed(true);\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tgetResult(taskId: number)\n\t{\n\t\tif (!ResultManager.resultRegistry[taskId])\n\t\t{\n\t\t\tResultManager.resultRegistry[taskId] = new Result(taskId);\n\t\t}\n\t\treturn ResultManager.resultRegistry[taskId];\n\t}\n\n\tonEditComment(event)\n\t{\n\t\tif (\n\t\t\t!event\n\t\t\t|| !event['id']\n\t\t\t|| event['id'][0].indexOf('TASK_') !== 0\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst node = document.getElementById('IS_TASK_RESULT');\n\t\tif (!node)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst taskId = +/\\d+/.exec(event['id'][0]);\n\t\tconst result = this.getResult(taskId);\n\n\t\tnode.checked = result.isResult(event['id'][1]);\n\t}\n\n\tonPushResult(command, params)\n\t{\n\t\tif (command === 'task_update')\n\t\t{\n\t\t\tconst taskId = parseInt(params.TASK_ID);\n\t\t\tconst result = this.getResult(taskId);\n\n\t\t\tif (\n\t\t\t\tparams.AFTER.STATUS\n\t\t\t\t&& (\n\t\t\t\t\tparams.AFTER.STATUS == 4\n\t\t\t\t\t|| params.AFTER.STATUS == 5\n\t\t\t\t)\n\t\t\t)\n\t\t\t{\n\t\t\t\tresult.setClosed(true);\n\t\t\t}\n\t\t\telse if (params.AFTER.STATUS)\n\t\t\t{\n\t\t\t\tresult.setClosed(false);\n\t\t\t}\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (\n\t\t\tcommand !== 'task_result_create'\n\t\t\t&& command !== 'task_result_delete'\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (\n\t\t\t!params.result\n\t\t\t|| !params.result.taskId\n\t\t\t|| !params.result.commentId\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst taskId = params.result.taskId;\n\t\tconst result = this.getResult(taskId);\n\n\t\tif (command === 'task_result_create')\n\t\t{\n\t\t\tresult.pushComment(params.result);\n\t\t}\n\t\telse if (command === 'task_result_delete')\n\t\t{\n\t\t\tresult.deleteComment(params.result.commentId);\n\t\t}\n\t}\n}","import {ajax} from 'main.core';\n\nexport class ResultAction\n{\n\tstatic instance = null;\n\n\tstatic getInstance()\n\t{\n\t\tif (!ResultAction.instance)\n\t\t{\n\t\t\tResultAction.instance = new ResultAction();\n\t\t}\n\t\treturn ResultAction.instance;\n\t}\n\n\tconstructor()\n\t{\n\n\t}\n\n\tcanCreateResult(taskId: number)\n\t{\n\t\treturn true;\n\t}\n\n\tdeleteFromComment(commentId: number)\n\t{\n\t\tajax.runComponentAction('bitrix:tasks.widget.result', 'deleteFromComment', {\n\t\t\tmode: 'class',\n\t\t\tdata: {\n\t\t\t\tcommentId: commentId\n\t\t\t}\n\t\t}).then(\n\t\t\tfunction(response)\n\t\t\t{\n\t\t\t\tif (!response.data)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t}.bind(this)\n\t\t);\n\t}\n\n\tcreateFromComment(commentId: number)\n\t{\n\t\tajax.runComponentAction('bitrix:tasks.widget.result', 'createFromComment', {\n\t\t\tmode: 'class',\n\t\t\tdata: {\n\t\t\t\tcommentId: commentId\n\t\t\t}\n\t\t}).then(\n\t\t\tfunction(response)\n\t\t\t{\n\t\t\t\tif (!response.data)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t}.bind(this)\n\t\t);\n\t}\n}"],"names":["Result","taskId","value","isClosed","comments","context","commentId","result","ResultManager","instance","node","document","getElementById","closest","classList","remove","add","init","compatMode","EventEmitter","subscribe","event","onEditComment","command","params","onPushResult","getResult","setComments","setContext","setClosed","resultRegistry","indexOf","exec","checked","isResult","parseInt","TASK_ID","AFTER","STATUS","pushComment","deleteComment","ResultAction","ajax","runComponentAction","mode","data","then","response","bind"],"mappings":"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"}