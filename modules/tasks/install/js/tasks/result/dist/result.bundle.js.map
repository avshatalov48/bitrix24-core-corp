{"version":3,"file":"result.bundle.js","sources":["../src/result.js","../src/result-manager.js","../src/result-action.js"],"sourcesContent":["export class Result\n{\n\ttaskId: null;\n\tisClosed: false;\n\tcomments: [];\n\tcontext: null;\n\n\tconstructor(taskId: number)\n\t{\n\t\tthis.taskId = taskId;\n\t}\n\n\tsetClosed(value: boolean)\n\t{\n\t\tthis.isClosed = value;\n\t}\n\n\tsetComments(comments: [])\n\t{\n\t\tthis.comments = comments;\n\t}\n\n\tsetContext(context: string)\n\t{\n\t\tthis.context = context;\n\t}\n\n\tisResult(commentId: number)\n\t{\n\t\tif (\n\t\t\tthis.comments\n\t\t\t&& this.comments[commentId]\n\t\t)\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tpushComment(result)\n\t{\n\t\tthis.comments[result.commentId] = result;\n\t}\n\n\tdeleteComment(commentId)\n\t{\n\t\tthis.comments[commentId] && delete this.comments[commentId];\n\t}\n\n\tcanSetAsResult(commentId)\n\t{\n\t\tif (this.comments[commentId])\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tcanUnsetAsResult(commentId)\n\t{\n\t\tif (!this.comments[commentId])\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.comments[commentId].status == 1)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.isClosed)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn true;\n\t}\n}","import {EventEmitter} from 'main.core.events';\nimport {Result} from './result';\n\ntype initParams = {\n\ttaskId: number,\n\tcomments: [],\n\tisClosed: boolean,\n\tcontext: string\n}\n\nexport class ResultManager\n{\n\tstatic resultRegistry: Result[] = {};\n\tstatic instance = null;\n\n\tstatic getInstance()\n\t{\n\t\tif (!ResultManager.instance)\n\t\t{\n\t\t\tResultManager.instance = new ResultManager();\n\t\t}\n\t\treturn ResultManager.instance;\n\t}\n\n\tstatic showField()\n\t{\n\t\tconst node = document.getElementById('IS_TASK_RESULT');\n\t\tif (\n\t\t\t!node\n\t\t\t|| !node.closest('label')\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tnode.closest('label').classList.remove('--hidden');\n\t}\n\n\tstatic hideField()\n\t{\n\t\tconst node = document.getElementById('IS_TASK_RESULT');\n\t\tif (\n\t\t\t!node\n\t\t\t|| !node.closest('label')\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tnode.closest('label').classList.add('--hidden');\n\t}\n\n\tconstructor()\n\t{\n\t\tthis.init();\n\t}\n\n\tinit()\n\t{\n\t\tconst compatMode = {\n\t\t\tcompatMode: true\n\t\t};\n\n\t\tEventEmitter.subscribe('OnUCFormBeforeShow',(event) => {\n\t\t\tthis.onEditComment(event);\n\t\t}, compatMode);\n\n\t\tEventEmitter.subscribe('onPullEvent-tasks',(command, params) => {\n\t\t\tthis.onPushResult(command, params);\n\t\t}, compatMode);\n\n\t\tEventEmitter.subscribe('onPull-tasks',(event) => {\n\t\t\tthis.onPushResult(event.command, event.params);\n\t\t}, compatMode);\n\t}\n\n\tinitResult(params: initParams)\n\t{\n\t\tconst result = this.getResult(params.taskId);\n\t\tresult.setComments(params.comments);\n\n\t\tif (params.context)\n\t\t{\n\t\t\tresult.setContext(params.context);\n\t\t}\n\t\tif (params.isClosed)\n\t\t{\n\t\t\tresult.setClosed(true);\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tgetResult(taskId: number)\n\t{\n\t\tif (!ResultManager.resultRegistry[taskId])\n\t\t{\n\t\t\tResultManager.resultRegistry[taskId] = new Result(taskId);\n\t\t}\n\t\treturn ResultManager.resultRegistry[taskId];\n\t}\n\n\tonEditComment(event)\n\t{\n\t\tif (\n\t\t\t!event\n\t\t\t|| !event['id']\n\t\t\t|| event['id'][0].indexOf('TASK_') !== 0\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst node = document.getElementById('IS_TASK_RESULT');\n\t\tif (!node)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst taskId = +/\\d+/.exec(event['id'][0]);\n\t\tconst result = this.getResult(taskId);\n\n\t\tnode.checked = result.isResult(event['id'][1]);\n\t}\n\n\tonPushResult(command, params)\n\t{\n\t\tif (command === 'task_update')\n\t\t{\n\t\t\tconst taskId = parseInt(params.TASK_ID);\n\t\t\tconst result = this.getResult(taskId);\n\n\t\t\tif (\n\t\t\t\tparams.AFTER.STATUS\n\t\t\t\t&& (\n\t\t\t\t\tparams.AFTER.STATUS == 4\n\t\t\t\t\t|| params.AFTER.STATUS == 5\n\t\t\t\t)\n\t\t\t)\n\t\t\t{\n\t\t\t\tresult.setClosed(true);\n\t\t\t}\n\t\t\telse if (params.AFTER.STATUS)\n\t\t\t{\n\t\t\t\tresult.setClosed(false);\n\t\t\t}\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (\n\t\t\tcommand !== 'task_result_create'\n\t\t\t&& command !== 'task_result_delete'\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (\n\t\t\t!params.result\n\t\t\t|| !params.result.taskId\n\t\t\t|| !params.result.commentId\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst taskId = params.result.taskId;\n\t\tconst result = this.getResult(taskId);\n\n\t\tif (command === 'task_result_create')\n\t\t{\n\t\t\tresult.pushComment(params.result);\n\t\t}\n\t\telse if (command === 'task_result_delete')\n\t\t{\n\t\t\tresult.deleteComment(params.result.commentId);\n\t\t}\n\t}\n}","import {ajax} from 'main.core';\n\nexport class ResultAction\n{\n\tstatic instance = null;\n\n\tstatic getInstance()\n\t{\n\t\tif (!ResultAction.instance)\n\t\t{\n\t\t\tResultAction.instance = new ResultAction();\n\t\t}\n\t\treturn ResultAction.instance;\n\t}\n\n\tconstructor()\n\t{\n\n\t}\n\n\tcanCreateResult(taskId: number)\n\t{\n\t\treturn true;\n\t}\n\n\tdeleteFromComment(commentId: number)\n\t{\n\t\tajax.runComponentAction('bitrix:tasks.widget.result', 'deleteFromComment', {\n\t\t\tmode: 'class',\n\t\t\tdata: {\n\t\t\t\tcommentId: commentId\n\t\t\t}\n\t\t}).then(\n\t\t\tfunction(response)\n\t\t\t{\n\t\t\t\tif (!response.data)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t}.bind(this)\n\t\t);\n\t}\n\n\tcreateFromComment(commentId: number)\n\t{\n\t\tajax.runComponentAction('bitrix:tasks.widget.result', 'createFromComment', {\n\t\t\tmode: 'class',\n\t\t\tdata: {\n\t\t\t\tcommentId: commentId\n\t\t\t}\n\t\t}).then(\n\t\t\tfunction(response)\n\t\t\t{\n\t\t\t\tif (!response.data)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t}.bind(this)\n\t\t);\n\t}\n}"],"names":["Result","taskId","value","isClosed","comments","context","commentId","result","status","ResultManager","instance","node","document","getElementById","closest","classList","remove","add","init","compatMode","EventEmitter","subscribe","event","onEditComment","command","params","onPushResult","getResult","setComments","setContext","setClosed","resultRegistry","indexOf","exec","checked","isResult","parseInt","TASK_ID","AFTER","STATUS","pushComment","deleteComment","ResultAction","ajax","runComponentAction","mode","data","then","response","bind"],"mappings":"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"}