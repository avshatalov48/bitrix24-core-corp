this.BX=this.BX||{};(function(t,e,a,i,s){"use strict";var o;function n(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,i)}return a}function r(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?n(Object(a),!0).forEach((function(e){babelHelpers.defineProperty(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):n(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}var l=function(){function t(e,a){var i;var s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;var o=arguments.length>3&&arguments[3]!==undefined?arguments[3]:null;var n=arguments.length>4&&arguments[4]!==undefined?arguments[4]:null;babelHelpers.classCallCheck(this,t);this.tagId=s;this.tasksCount=o;this.groupId=(i=parseInt(n,10))!==null&&i!==void 0?i:0;this.tagStorage=[];this.timeoutId=0;this.gridId="tasks_by_tag_list";this.pathToTask=e;this.pathToUser=a;this.sidePanel=null;this.listData=null;this.pullTaskCommands=["task_update","task_add","task_remove"];this.pullTagCommands=["tag_added","tag_changed"];this.sidePanelManager=BX.SidePanel.Instance;this.balloon=null;this.timeoutDelete=null;this.bindEvents()}babelHelpers.createClass(t,[{key:"bindEvents",value:function t(){var e=this;this.pullTagCommands.forEach((function(t){BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"tasks",command:t,callback:e.onPullTag.bind(e)})}));this.pullTaskCommands.forEach((function(t){BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"tasks",command:t,callback:e.onPullTask.bind(e)})}));i.EventEmitter.subscribe("Grid::beforeRequest",this.onBeforeTagsGridRequest.bind(this))}},{key:"onPullTag",value:function t(a,i,s){if(!this.getTagsGrid()){return}var o=parseInt(e.Loc.getMessage("USER_ID"),10);if(this.groupId===0&&s==="tag_added"){this.getTagsGrid().reload()}if(this.groupId!==0&&a.groupId===this.groupId){if(o!==a.userId){this.getTagsGrid().reload()}}}},{key:"onPullTask",value:function t(e,a,i){var s=this;if(!this.getTagsGrid()){return}clearTimeout(this.timeoutId);this.timeoutId=setTimeout((function(){s.getTagsGrid().reload()}),500)}},{key:"getTagsGrid",value:function t(){return BX.Main.gridManager.getInstanceById("tags_list")}},{key:"deleteTag",value:function a(i){var o=this;if(!this.getTagsGrid()){return}clearTimeout(this.timeoutDelete);if(this.balloon){this.balloon.close()}this.tagStorage.push(i);var n=false;if(this.tagStorage.length>1){n=true}var r=false;this.getTagsGrid().getRows().getById(i).hide();this.getTagsGrid().showEmptyStub();this.balloon=s.UI.Notification.Center.notify({content:this.tagStorage.length>1?e.Loc.getMessage("ALL_TAGS_SUCCESSFULLY_DELETED"):e.Loc.getMessage("TAG_IS_SUCCESSFULLY_DELETED"),autoHideDelay:t.balloonLifeTime,events:{onMouseEnter:function t(){r=true;clearTimeout(o.timeoutDelete)},onMouseLeave:function e(){r=false;o.timeoutDelete=setTimeout(l,t.balloonLifeTime)}},actions:[{title:e.Loc.getMessage("TAG_CANCEL"),events:{click:function t(e,a,i){r=true;o.tagStorage.forEach((function(t){o.getTagsGrid().getRows().getById(t).show()}));a.close()}}}]});var l=function t(){if(r){return}if(n){n=false;e.ajax.runComponentAction("bitrix:tasks.tag.list","deleteTagGroup",{mode:"class",data:{tags:o.tagStorage,groupId:o.groupId}}).then((function(t){if(t.status==="success"){o.balloon.close();o.tagStorage=[];o.getTagsGrid().reload()}}))}else{e.ajax.runComponentAction("bitrix:tasks.tag.list","deleteTag",{mode:"class",data:{tagId:i,groupId:o.groupId}}).then((function(t){if(t.status==="success"){o.balloon.close();o.tagStorage=[];o.getTagsGrid().removeRow(i)}}))}};this.timeoutDelete=setTimeout(l,t.balloonLifeTime)}},{key:"updateTag",value:function a(i){var o=this;if(!this.getTagsGrid()){return}if(this.balloon){this.balloon.close()}var n=this.getTagsGrid().container.querySelectorAll("div.main-grid-editor-container").length;if(n===1){var r=this.getTagsGrid().container.querySelector(".main-grid-row.main-grid-row-body.main-grid-row-edit").dataset.id;this.getTagsGrid().getRows().getById(r).editCancel()}this.getTagsGrid().getRows().getById(i).edit();var l="";var u="";var d="";this.getTagsGrid().container.querySelector("div.main-grid-editor-container input").addEventListener("keydown",(function(a){if(a.key==="Enter"){if(o.balloon){o.balloon.close()}u=o.getTagsGrid().getRows().getById(i).getCellById("NAME");l=o.getTagsGrid().getRows().getById(i).getEditorContainer(u).firstChild.value.trim();if(l===""){o.balloon=s.UI.Notification.Center.notify({content:e.Loc.getMessage("TAG_EMPTY_NEW_NAME"),autoHideDelay:t.balloonLifeTime});return}e.ajax.runComponentAction("bitrix:tasks.tag.list","updateTag",{mode:"class",data:{tagId:i,newName:l,groupId:o.groupId}}).then((function(t){d=t.data;return d})).then((function(a){if(!a.success){if(!a.error){o.getTagsGrid().getRows().getById(i).editCancel();return}o.balloon=s.UI.Notification.Center.notify({content:a.error,autoHideDelay:t.balloonLifeTime});return}o.getTagsGrid().updateRow(i);o.balloon=s.UI.Notification.Center.notify({content:e.Loc.getMessage("TAG_IS_SUCCESSFULLY_UPDATED"),autoHideDelay:t.balloonLifeTime})}))}}))}},{key:"groupDelete",value:function a(){var i=this;if(!this.getTagsGrid()){return}if(this.balloon){this.balloon.close()}var o=false;var n=[];var r=this.getTagsGrid().getRows().getSelected();r.forEach((function(t){n.push(t.getId());i.getTagsGrid().getRows().getById(t.getId()).hide()}));document.querySelector("div.main-grid-action-panel").className="main-grid-action-panel main-grid-disable";this.balloon=s.UI.Notification.Center.notify({content:e.Loc.getMessage("ALL_TAGS_SUCCESSFULLY_DELETED"),autoHideDelay:t.balloonLifeTime,events:{onMouseEnter:function t(){o=true;clearTimeout(i.timeoutDelete)},onMouseLeave:function e(){o=false;i.timeoutDelete=setTimeout(l,t.balloonLifeTime)}},actions:[{title:e.Loc.getMessage("TAG_CANCEL"),events:{click:function t(e,a,s){o=true;n.forEach((function(t){var e=i.getTagsGrid().getRows().getById(t);e&&e.show()}));a.close()}}}]});var l=function t(){if(o){return}e.ajax.runComponentAction("bitrix:tasks.tag.list","deleteTagGroup",{mode:"class",data:{tags:n,groupId:i.groupId}}).then((function(t){if(t.status==="success"){i.balloon.close();n.forEach((function(t){i.getTagsGrid().removeRow(t)}))}}))};this.timeoutDelete=setTimeout(l,t.balloonLifeTime)}},{key:"showTasksList",value:function t(){var i=this;this.sidePanelManager.open("tasks-tag-tasks-list-side-panel",{width:700,cacheable:false,contentCallback:function t(){return a.Layout.createContent({extensions:["tasks.tag"],title:e.Loc.getMessage("TASKS_BY_TAG_LIST"),content:i.createTasksListContent.bind(i),design:{section:false},buttons:[]})},events:{onLoad:this.onLoadTasksList.bind(this)}})}},{key:"onLoadTasksList",value:function t(a){var s=this;var o=a.getSlider();var n=o.getContainer().querySelector(".tasks-tags-tag-tasks-list");this.pullTaskCommands.forEach((function(t){BX.PULL.subscribe({type:BX.PullClient.SubscriptionType.Server,moduleId:"tasks",command:t,callback:function t(){o.destroy()}})}));e.Runtime.html(n,this.listData.html).then((function(){i.EventEmitter.subscribe("Grid::beforeRequest",s.onBeforeTaskGridRequest.bind(s))}))}},{key:"onBeforeTaskGridRequest",value:function t(e){var a=e.getCompatData(),i=babelHelpers.slicedToArray(a,2),s=i[0],o=i[1];o.sessid=BX.bitrix_sessid();o.method="POST";o.data=r(r({},o.data),{},{gridId:this.gridId,pathToTask:this.pathToTask,pathToUser:this.pathToUser,tagId:this.tagId,tasksCount:this.tasksCount})}},{key:"createTasksListContent",value:function t(){var a=this;return new Promise((function(t,i){e.ajax.runComponentAction("bitrix:tasks.tag.list","getTasksByTag",{mode:"class",data:{gridId:a.gridId,tagId:a.tagId,pathToTask:a.pathToTask,pathToUser:a.pathToUser,tasksCount:a.tasksCount}}).then((function(e){a.listData=e.data;t(a.renderTasksList())}))}))}},{key:"renderTasksList",value:function t(){return e.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['<div class="tasks-tags-tag-tasks-list"></div>'])))}},{key:"show",value:function t(e,a){var i=this;return top.BX.Runtime.loadExtension("tasks.tag").then((function(t){var s=new t["TagActions"](i.pathToTask,i.pathToUser,e,a);s.showTasksList()}))}},{key:"onLoadTagList",value:function t(){i.EventEmitter.subscribe("Grid::beforeRequest",this.onBeforeTagsGridRequest.bind(this))}},{key:"onBeforeTagsGridRequest",value:function t(e){var a=e.getCompatData(),i=babelHelpers.slicedToArray(a,2),s=i[0],o=i[1];o.sessid=BX.bitrix_sessid();o.method="POST";o.data=r(r({},o.data),{},{groupId:this.groupId})}}]);return t}();babelHelpers.defineProperty(l,"balloonLifeTime",3e3);t.TagActions=l})(this.BX.Tasks=this.BX.Tasks||{},BX,BX.UI.SidePanel,BX.Event,BX);
//# sourceMappingURL=tag.bundle.map.js