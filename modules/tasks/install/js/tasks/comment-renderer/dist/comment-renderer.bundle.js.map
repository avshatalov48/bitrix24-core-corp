{"version":3,"file":"comment-renderer.bundle.js","sources":["../src/comment-renderer.js"],"sourcesContent":["import {Type, Loc, Uri} from 'main.core';\nimport {CommentAux} from 'socialnetwork.commentaux';\n\nexport class CommentRenderer\n{\n\tstatic getCommentPart(entity): string\n\t{\n\t\tlet message = '';\n\n\t\ttry\n\t\t{\n\t\t\tmessage = Loc.getMessage(entity.CODE);\n\t\t}\n\t\tcatch (e)\n\t\t{\n\n\t\t}\n\n\t\tif (\n\t\t\t!Type.isStringFilled(message)\n\t\t\t|| !Type.isPlainObject(entity.REPLACE_LIST)\n\t\t)\n\t\t{\n\t\t\treturn message;\n\t\t}\n\n\t\tlet liveData = {};\n\t\tif (Type.isPlainObject(entity.REPLACE_LIST.LIVE_DATA))\n\t\t{\n\t\t\tliveData = entity.REPLACE_LIST.LIVE_DATA;\n\t\t\tdelete entity.REPLACE_LIST.LIVE_DATA;\n\t\t}\n\n\t\tObject.keys(entity.REPLACE_LIST).forEach((search) => {\n\t\t\tmessage = message.replace(search, entity.REPLACE_LIST[search]);\n\t\t});\n\n\t\tmessage = message.replaceAll(/\\[USER=(\\d+)\\](.+?)\\[\\/USER\\]/g, (match, id, name) => {\n\t\t\treturn CommentAux.renderEntity({\n\t\t\t\tENTITY_TYPE: 'U',\n\t\t\t\tNAME: name,\n\t\t\t\tLINK: Loc.getMessage('SONET_EXT_COMMENTAUX_USER_PATH').replace('#user_id#', id),\n\t\t\t});\n\t\t});\n\n\t\tconst userId = Number(Loc.getMessage('USER_ID'));\n\t\tconst actionList = [\n\t\t\t'EFFICIENCY',\n\t\t\t'DEADLINE',\n\t\t\t'DEADLINE_CHANGE',\n\t\t\t'TASK_APPROVE',\n\t\t\t'TASK_DISAPPROVE',\n\t\t\t'TASK_COMPLETE',\n\t\t];\n\t\tactionList.forEach((action) => {\n\t\t\tconst start = `#${action}_START#`;\n\t\t\tconst end = `#${action}_END#`;\n\n\t\t\tif (\n\t\t\t\tmessage.indexOf(start) === -1\n\t\t\t\t&& message.indexOf(end) === -1\n\t\t\t)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tswitch (action)\n\t\t\t{\n\t\t\t\tcase 'EFFICIENCY':\n\t\t\t\t\tif (liveData.EFFICIENCY_MEMBERS.includes(userId))\n\t\t\t\t\t{\n\t\t\t\t\t\tlet efficiencyUrlStart = Loc.getMessage('SONET_RENDERPARTS_EFFICIENCY_PATH');\n\t\t\t\t\t\tefficiencyUrlStart = efficiencyUrlStart.replace('#user_id#', userId);\n\t\t\t\t\t\tefficiencyUrlStart = `<a href=\"${efficiencyUrlStart}\">`;\n\n\t\t\t\t\t\tmessage = message.replace(start, efficiencyUrlStart);\n\t\t\t\t\t\tmessage = message.replace(end, '</a>');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tmessage = this.removeAnchors(message, start, end);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'DEADLINE':\n\t\t\t\t\tconst regExp = new RegExp(`${start}\\\\d+${end}`, 'g');\n\t\t\t\t\tmessage = message.replaceAll(regExp, (timestamp) => {\n\t\t\t\t\t\tif (timestamp)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttimestamp = this.removeAnchors(timestamp, start, end);\n\t\t\t\t\t\t\treturn BX.date.format(liveData.DATE_FORMAT, Number(timestamp));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\tmessage = this.removeAnchors(message, start, end);\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'DEADLINE_CHANGE':\n\t\t\t\tcase 'TASK_APPROVE':\n\t\t\t\tcase 'TASK_DISAPPROVE':\n\t\t\t\tcase 'TASK_COMPLETE':\n\t\t\t\t\tif (\n\t\t\t\t\t\t!Type.isUndefined(liveData.TASK_ID)\n\t\t\t\t\t\t&& Number(liveData.TASK_ID) > 0\n\t\t\t\t\t\t&& Object.keys(liveData.RIGHTS[action]).map(id => Number(id)).includes(userId)\n\t\t\t\t\t\t&& liveData.RIGHTS[action][userId]\n\t\t\t\t\t)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst taskActionLink = this.getTaskActionLink({\n\t\t\t\t\t\t\taction,\n\t\t\t\t\t\t\tuserId,\n\t\t\t\t\t\t\ttaskId: liveData.TASK_ID,\n\t\t\t\t\t\t\tdeadline: liveData.DEADLINE || null,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tmessage = message.replace(start, `<a href=\"${taskActionLink}\">`);\n\t\t\t\t\t\tmessage = message.replace(end, '</a>');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tmessage = this.removeAnchors(message, start, end);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tmessage = this.removeAnchors(message, start, end);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\n\t\treturn message.replace(\"\\n\", '<br>');\n\t}\n\n\tstatic getTaskActionLink(params)\n\t{\n\t\tconst actionMap = {\n\t\t\tDEADLINE_CHANGE: 'deadlineChange',\n\t\t\tTASK_APPROVE: 'taskApprove',\n\t\t\tTASK_DISAPPROVE: 'taskDisapprove',\n\t\t\tTASK_COMPLETE: 'taskComplete',\n\t\t};\n\n\t\tlet link = Loc.getMessage('SONET_RENDERPARTS_TASK_PATH');\n\t\tlink = link\n\t\t\t.replace('#user_id#', Loc.getMessage('USER_ID'))\n\t\t\t.replace('#task_id#', params.taskId)\n\t\t;\n\t\tlink = Uri.addParam(link, {commentAction: actionMap[params.action]});\n\n\t\tif (params.action === 'DEADLINE_CHANGE' && params.deadline)\n\t\t{\n\t\t\tlink = Uri.addParam(link, {deadline: params.deadline});\n\t\t}\n\n\t\treturn link;\n\t}\n\n\tstatic removeAnchors(message, start, end)\n\t{\n\t\tmessage = message.replace(start, '');\n\t\tmessage = message.replace(end, '');\n\n\t\treturn message;\n\t}\n}\n"],"names":["CommentRenderer","entity","message","Loc","getMessage","CODE","e","Type","isStringFilled","isPlainObject","REPLACE_LIST","liveData","LIVE_DATA","Object","keys","forEach","search","replace","replaceAll","match","id","name","CommentAux","renderEntity","ENTITY_TYPE","NAME","LINK","userId","Number","actionList","action","start","end","indexOf","EFFICIENCY_MEMBERS","includes","efficiencyUrlStart","removeAnchors","regExp","RegExp","timestamp","BX","date","format","DATE_FORMAT","isUndefined","TASK_ID","RIGHTS","map","taskActionLink","getTaskActionLink","taskId","deadline","DEADLINE","params","actionMap","DEADLINE_CHANGE","TASK_APPROVE","TASK_DISAPPROVE","TASK_COMPLETE","link","Uri","addParam","commentAction"],"mappings":"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"}