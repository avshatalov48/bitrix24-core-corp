{"version":3,"file":"comment-renderer.bundle.js","sources":["../src/comment-renderer.js"],"sourcesContent":["import {Type, Loc, Uri} from 'main.core';\nimport {CommentAux} from 'socialnetwork.commentaux';\n\nexport class CommentRenderer\n{\n\tstatic getCommentPart(entity): string\n\t{\n\t\tlet message = '';\n\n\t\ttry\n\t\t{\n\t\t\tmessage = Loc.getMessage(entity.CODE);\n\t\t}\n\t\tcatch (e)\n\t\t{\n\n\t\t}\n\n\t\tif (\n\t\t\t!Type.isStringFilled(message)\n\t\t\t|| !Type.isPlainObject(entity.REPLACE_LIST)\n\t\t)\n\t\t{\n\t\t\treturn message;\n\t\t}\n\n\t\tlet liveData = {};\n\t\tif (Type.isPlainObject(entity.REPLACE_LIST.LIVE_DATA))\n\t\t{\n\t\t\tliveData = entity.REPLACE_LIST.LIVE_DATA;\n\t\t\tdelete entity.REPLACE_LIST.LIVE_DATA;\n\t\t}\n\n\t\tObject.keys(entity.REPLACE_LIST).forEach((search) => {\n\t\t\tmessage = message.replace(search, entity.REPLACE_LIST[search]);\n\t\t});\n\n\t\tmessage = message.replaceAll(/\\[USER=(\\d+)\\](.+?)\\[\\/USER\\]/g, (match, id, name) => {\n\t\t\treturn CommentAux.renderEntity({\n\t\t\t\tENTITY_TYPE: 'U',\n\t\t\t\tNAME: name,\n\t\t\t\tLINK: Loc.getMessage('SONET_EXT_COMMENTAUX_USER_PATH').replace('#user_id#', id),\n\t\t\t});\n\t\t});\n\n\t\tconst userId = Number(Loc.getMessage('USER_ID'));\n\t\tconst actionList = [\n\t\t\t'EFFICIENCY',\n\t\t\t'DEADLINE',\n\t\t\t'DEADLINE_CHANGE',\n\t\t\t'TASK_APPROVE',\n\t\t\t'TASK_DISAPPROVE',\n\t\t\t'TASK_COMPLETE',\n\t\t\t'TASK_CHANGE_RESPONSIBLE',\n\t\t];\n\t\tactionList.forEach((action) => {\n\t\t\tconst start = `#${action}_START#`;\n\t\t\tconst end = `#${action}_END#`;\n\n\t\t\tif (\n\t\t\t\tmessage.indexOf(start) === -1\n\t\t\t\t&& message.indexOf(end) === -1\n\t\t\t)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tswitch (action)\n\t\t\t{\n\t\t\t\tcase 'EFFICIENCY':\n\t\t\t\t\tif (liveData.EFFICIENCY_MEMBERS.includes(userId))\n\t\t\t\t\t{\n\t\t\t\t\t\tlet efficiencyUrlStart = Loc.getMessage('SONET_RENDERPARTS_EFFICIENCY_PATH');\n\t\t\t\t\t\tefficiencyUrlStart = efficiencyUrlStart.replace('#user_id#', userId);\n\t\t\t\t\t\tefficiencyUrlStart = `<a href=\"${efficiencyUrlStart}\" target=\"_blank\">`;\n\n\t\t\t\t\t\tmessage = message.replace(start, efficiencyUrlStart);\n\t\t\t\t\t\tmessage = message.replace(end, '</a>');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tmessage = this.removeAnchors(message, start, end);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'DEADLINE':\n\t\t\t\t\tconst regExp = new RegExp(`${start}\\\\d+${end}`, 'g');\n\t\t\t\t\tmessage = message.replaceAll(regExp, (timestamp) => {\n\t\t\t\t\t\tif (timestamp)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttimestamp = this.removeAnchors(timestamp, start, end);\n\n\t\t\t\t\t\t\treturn BX.date.format(liveData.DATE_FORMAT, Number(timestamp));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t\tmessage = this.removeAnchors(message, start, end);\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase 'DEADLINE_CHANGE':\n\t\t\t\tcase 'TASK_APPROVE':\n\t\t\t\tcase 'TASK_DISAPPROVE':\n\t\t\t\tcase 'TASK_COMPLETE':\n\t\t\t\tcase 'TASK_CHANGE_RESPONSIBLE':\n\t\t\t\t\tif (\n\t\t\t\t\t\t!Type.isUndefined(liveData.TASK_ID)\n\t\t\t\t\t\t&& Number(liveData.TASK_ID) > 0\n\t\t\t\t\t\t&& Object.keys(liveData.RIGHTS[action]).map((id) => Number(id)).includes(userId)\n\t\t\t\t\t\t&& liveData.RIGHTS[action][userId]\n\t\t\t\t\t)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst taskActionLink = this.getTaskActionLink({\n\t\t\t\t\t\t\taction,\n\t\t\t\t\t\t\tuserId,\n\t\t\t\t\t\t\ttaskId: liveData.TASK_ID,\n\t\t\t\t\t\t\tdeadline: liveData.DEADLINE || null,\n\t\t\t\t\t\t});\n\t\t\t\t\t\tmessage = message.replace(start, `<a href=\"${taskActionLink}\">`);\n\t\t\t\t\t\tmessage = message.replace(end, '</a>');\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tmessage = this.removeAnchors(message, start, end);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tmessage = this.removeAnchors(message, start, end);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t});\n\n\t\treturn message.replace(\"\\n\", '<br>');\n\t}\n\n\tstatic getTaskActionLink(params)\n\t{\n\t\tconst actionMap = {\n\t\t\tDEADLINE_CHANGE: 'deadlineChange',\n\t\t\tTASK_APPROVE: 'taskApprove',\n\t\t\tTASK_DISAPPROVE: 'taskDisapprove',\n\t\t\tTASK_COMPLETE: 'taskComplete',\n\t\t\tTASK_CHANGE_RESPONSIBLE: 'taskChangeResponsible',\n\t\t};\n\n\t\tlet link = Loc.getMessage('SONET_RENDERPARTS_TASK_PATH');\n\t\tlink = link\n\t\t\t.replace('#user_id#', Loc.getMessage('USER_ID'))\n\t\t\t.replace('#task_id#', params.taskId)\n\t\t;\n\t\tlink = Uri.addParam(link, { commentAction: actionMap[params.action] });\n\n\t\tif (params.action === 'DEADLINE_CHANGE' && params.deadline)\n\t\t{\n\t\t\tlink = Uri.addParam(link, { deadline: params.deadline });\n\t\t}\n\n\t\treturn link;\n\t}\n\n\tstatic removeAnchors(message, start, end)\n\t{\n\t\tmessage = message.replace(start, '');\n\t\tmessage = message.replace(end, '');\n\n\t\treturn message;\n\t}\n}"],"names":["CommentRenderer","entity","message","Loc","getMessage","CODE","e","Type","isStringFilled","isPlainObject","REPLACE_LIST","liveData","LIVE_DATA","Object","keys","forEach","search","replace","replaceAll","match","id","name","CommentAux","renderEntity","ENTITY_TYPE","NAME","LINK","userId","Number","actionList","action","start","end","indexOf","EFFICIENCY_MEMBERS","includes","efficiencyUrlStart","removeAnchors","regExp","RegExp","timestamp","BX","date","format","DATE_FORMAT","isUndefined","TASK_ID","RIGHTS","map","taskActionLink","getTaskActionLink","taskId","deadline","DEADLINE","params","actionMap","DEADLINE_CHANGE","TASK_APPROVE","TASK_DISAPPROVE","TASK_COMPLETE","TASK_CHANGE_RESPONSIBLE","link","Uri","addParam","commentAction"],"mappings":"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"}