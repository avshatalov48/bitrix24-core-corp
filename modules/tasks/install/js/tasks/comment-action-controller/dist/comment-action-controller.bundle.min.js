this.BX=this.BX||{};(function(e,n,t){"use strict";var i=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"init",value:function n(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return new Promise(function(n){var i=[];if(!e.workHours){if(t.workHours){e.workHours=t.workHours}else{i.push(e.loadWorkHours())}}if(!e.workSettings){if(t.workSettings){e.workSettings=t.workSettings}else{i.push(e.loadWorkSettings())}}if(!i.length){n()}Promise.all(i).then(function(){return n()})})}},{key:"loadWorkHours",value:function n(){return new Promise(function(n){t.rest.callMethod("calendar.settings.get").then(function(t){var i=t.answer.result;var a=i.work_time_start,s=i.work_time_end;var o=a.split("."),r=babelHelpers.slicedToArray(o,2),u=r[0],l=r[1];var c=s.split("."),k=babelHelpers.slicedToArray(c,2),f=k[0],d=k[1];e.workHours={start:{hours:u,minutes:l},end:{hours:f,minutes:d}};n()})})}},{key:"loadWorkSettings",value:function t(){return new Promise(function(t){n.ajax.runAction("tasks.userOption.getCalendarTimeVisibilityOption").then(function(n){e.workSettings={deadlineTimeVisibility:n.data.visibility||"N"};t()})})}},{key:"isActionValid",value:function n(t){return Object.keys(e.possibleActions).includes(t)}},{key:"processLink",value:function n(t){var i=babelHelpers.slicedToArray(t.matches,5),a=i[0],s=i[1],o=i[2],r=i[3],u=i[4];if(!e.isActionValid(r)){return}if(r===e.possibleActions.deadlineChange){e.init().then(function(){e.showDeadlinePicker(t.anchor,o,u)});return}e.checkCanRun(r,o).then(function(n){if(n){e.runAjaxAction(r,o)}},function(e){return console.error(e)})}},{key:"showDeadlinePicker",value:function n(t,i,a){var s=new Date;var o=new Date(Date.UTC(s.getFullYear(),s.getMonth(),s.getDate(),e.workHours.end.hours,e.workHours.end.minutes));var r=a?new Date((Number(a)-(new Date).getTimezoneOffset()*60)*1e3):o;BX.calendar({node:t,value:r,field:"",form:"",bTime:true,currentTime:Math.round(new Date/1e3)-(new Date).getTimezoneOffset()*60,bHideTimebar:true,bCompatibility:true,bCategoryTimeVisibilityOption:"tasks.bx.calendar.deadline",bTimeVisibility:e.workSettings?e.workSettings.deadlineTimeVisibility==="Y":false,callback_after:function n(t){return e.onDeadlinePicked(t,i)}})}},{key:"onDeadlinePicked",value:function n(t,i){var a=e.possibleActions.deadlineChange;e.checkCanRun(a,i).then(function(n){if(n){e.runAjaxAction(a,i,{fields:{DEADLINE:t.toISOString()}})}},function(e){return console.error(e)})}},{key:"checkCanRun",value:function t(i,a){return new Promise(function(t,s){if(e.isAjaxRunning){t(false)}e.isAjaxRunning=true;n.ajax.runAction("tasks.task.getAccess",{data:{taskId:a}}).then(function(n){e.isAjaxRunning=false;var a=n.data.allowedActions;var s=Object.keys(a)[0];var o=e.accessActions[i];t(a&&a[s]&&a[s][o])},function(e){return s(e)})})}},{key:"runAjaxAction",value:function t(i,a){var s=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};if(e.isAjaxRunning){return}e.isAjaxRunning=true;e.showNotification(i);var o={taskId:a};n.ajax.runAction(e.ajaxActions[i],{data:babelHelpers.objectSpread({},s,o)}).then(function(){e.isAjaxRunning=false})}},{key:"showNotification",value:function t(i){n.Runtime.loadExtension("ui.notification").then(function(){BX.UI.Notification.Center.notify({content:e.actionNotificationMessages[i]})})}},{key:"possibleActions",get:function e(){return{deadlineChange:"deadlineChange",taskApprove:"taskApprove",taskDisapprove:"taskDisapprove",taskComplete:"taskComplete"}}},{key:"accessActions",get:function e(){return{deadlineChange:"CHANGE_DEADLINE",taskApprove:"APPROVE",taskDisapprove:"DISAPPROVE",taskComplete:"COMPLETE"}}},{key:"ajaxActions",get:function e(){return{deadlineChange:"tasks.task.update",taskApprove:"tasks.task.approve",taskDisapprove:"tasks.task.disapprove",taskComplete:"tasks.task.complete"}}},{key:"actionNotificationMessages",get:function e(){var t="TASKS_COMMENT_ACTION_CONTROLLER_NOTIFICATION";return{deadlineChange:n.Loc.getMessage("".concat(t,"_DEADLINE_CHANGE")),taskApprove:n.Loc.getMessage("".concat(t,"_TASK_APPROVE")),taskDisapprove:n.Loc.getMessage("".concat(t,"_TASK_DISAPPROVE")),taskComplete:n.Loc.getMessage("".concat(t,"_TASK_COMPLETE"))}}}]);return e}();babelHelpers.defineProperty(i,"workHours",null);babelHelpers.defineProperty(i,"workSettings",null);babelHelpers.defineProperty(i,"isAjaxRunning",false);e.CommentActionController=i})(this.BX.Tasks=this.BX.Tasks||{},BX,BX);
//# sourceMappingURL=comment-action-controller.bundle.map.js