this.BX=this.BX||{};(function(e,t,s,i){"use strict";class n{static get possibleActions(){return{deadlineChange:"deadlineChange",taskApprove:"taskApprove",taskDisapprove:"taskDisapprove",taskComplete:"taskComplete",taskChangeResponsible:"taskChangeResponsible"}}static get accessActions(){return{deadlineChange:"CHANGE_DEADLINE",taskApprove:"APPROVE",taskDisapprove:"DISAPPROVE",taskComplete:"COMPLETE",taskChangeResponsible:"CHANGE_RESPONSIBLE"}}static get ajaxActions(){return{deadlineChange:"tasks.task.update",taskApprove:"tasks.task.approve",taskDisapprove:"tasks.task.disapprove",taskComplete:"tasks.task.complete",taskChangeResponsible:"tasks.task.update"}}static get actionNotificationMessages(){const e="TASKS_COMMENT_ACTION_CONTROLLER_NOTIFICATION";return{deadlineChange:t.Loc.getMessage(`${e}_DEADLINE_CHANGE`),taskApprove:t.Loc.getMessage(`${e}_TASK_APPROVE`),taskDisapprove:t.Loc.getMessage(`${e}_TASK_DISAPPROVE`),taskComplete:t.Loc.getMessage(`${e}_TASK_COMPLETE`),taskChangeResponsible:t.Loc.getMessage(`${e}_TASK_CHANGE_RESPONSIBLE`)}}static init(e={}){return new Promise((t=>{const s=[];if(!n.workHours){if(e.workHours){n.workHours=e.workHours}else{s.push(n.loadWorkHours())}}if(!n.workSettings){if(e.workSettings){n.workSettings=e.workSettings}else{s.push(n.loadWorkSettings())}}if(!s.length){t()}Promise.all(s).then((()=>t()))}))}static loadWorkHours(){return new Promise((e=>{s.rest.callMethod("calendar.settings.get").then((t=>{const{result:s}=t.answer;const[i,a]=String(s.work_time_start).split(".");const[o,r]=String(s.work_time_end).split(".");n.workHours={start:{hours:i,minutes:a},end:{hours:o,minutes:r}};e()}))}))}static loadWorkSettings(){return new Promise((e=>{t.ajax.runAction("tasks.userOption.getCalendarTimeVisibilityOption").then((t=>{n.workSettings={deadlineTimeVisibility:t.data.visibility||"N"};e()}))}))}static isActionValid(e){return Object.keys(n.possibleActions).includes(e)}static processLink(e){const[t,s,i,a,o]=e.matches;if(!n.isActionValid(a)){return}if(a===n.possibleActions.deadlineChange){n.init().then((()=>{n.showDeadlinePicker(e.anchor,i,o)}));return}if(a===n.possibleActions.taskChangeResponsible){n.showResponsibleSelector(e.anchor,i);return}n.checkCanRun(a,i).then((e=>{if(e){n.runAjaxAction(a,i)}}),(e=>console.error(e)))}static showDeadlinePicker(e,s,i){const a=new Date;const o=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate(),n.workHours.end.hours,n.workHours.end.minutes));const r=i?new Date((Number(i)-(new Date).getTimezoneOffset()*60)*1e3):o;const c=t.Reflection.getClass("BX.calendar");c({node:e,value:r,field:"",form:"",bTime:true,currentTime:Math.round(new Date/1e3)-(new Date).getTimezoneOffset()*60,bHideTimebar:true,bCompatibility:true,bCategoryTimeVisibilityOption:"tasks.bx.calendar.deadline",bTimeVisibility:n.workSettings?n.workSettings.deadlineTimeVisibility==="Y":false,callback_after:e=>n.onDeadlinePicked(e,s)})}static showResponsibleSelector(e,t){const s=new i.Dialog({targetNode:e,enableSearch:true,multiple:false,cacheable:false,entities:[{id:"user",options:{intranetUsersOnly:true,emailUsers:false,inviteEmployeeLink:false,inviteGuestLink:false}}],clearSearchOnSelect:true,events:{"Item:onSelect":e=>{var i;const a=e==null?void 0:(i=e.data)==null?void 0:i.item;if(a){n.onResponsibleSelected(a.id,t)}s.hide()}}});s.show()}static onResponsibleSelected(e,t){const s=n.possibleActions.taskChangeResponsible;n.runAjaxAction(s,t,{fields:{RESPONSIBLE_ID:e}})}static onDeadlinePicked(e,t){const s=n.possibleActions.deadlineChange;n.checkCanRun(s,t).then((i=>{if(i){n.runAjaxAction(s,t,{fields:{DEADLINE:e.toISOString()}})}}),(e=>console.error(e)))}static checkCanRun(e,s){return new Promise(((i,a)=>{if(n.isAjaxRunning){i(false)}n.isAjaxRunning=true;t.ajax.runAction("tasks.task.getAccess",{data:{taskId:s}}).then((t=>{n.isAjaxRunning=false;const{allowedActions:s}=t.data;const a=Object.keys(s)[0];const o=n.accessActions[e];i(s&&s[a]&&s[a][o])}),(e=>a(e)))}))}static runAjaxAction(e,s,i={}){if(n.isAjaxRunning){return}n.isAjaxRunning=true;const a={taskId:s};i={...i,...a};if(!i.params){i.params={}}i.params.PLATFORM="web";t.ajax.runAction(n.ajaxActions[e],{data:i}).then((()=>{n.showNotification(e);n.isAjaxRunning=false}),(e=>{if(e&&e.errors){const s={MESSAGE:e.errors[0].message,DATA:{ui:"notification"}};const i=t.Reflection.getClass("BX.Tasks");i.alert([s])}n.isAjaxRunning=false}))}static showNotification(e){t.Runtime.loadExtension("ui.notification").then((()=>{const s=t.Reflection.getClass("BX.UI.Notification.Center");s.notify({content:n.actionNotificationMessages[e]})}))}}n.workHours=null;n.workSettings=null;n.isAjaxRunning=false;e.CommentActionController=n})(this.BX.Tasks=this.BX.Tasks||{},BX,BX,BX.UI.EntitySelector);
//# sourceMappingURL=comment-action-controller.bundle.map.js