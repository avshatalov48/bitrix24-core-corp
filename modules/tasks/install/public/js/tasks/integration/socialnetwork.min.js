BX.namespace("BX.Tasks.Integration");(function(){BX.Tasks.Integration.Socialnetwork={};var t={};var e=false;var i=false;BX.Tasks.Integration.Socialnetwork.NetworkSelector=BX.Tasks.Util.Widget.extend({sys:{code:"network-selector"},options:{mode:"user",query:false,useSearch:false,useAdd:false,popupOffsetTop:0,popupOffsetLeft:0,syncLast:true,lastSelectedContext:"TASKS"},methods:{getDataCache:function(){var e=this.getRole();return t[e]},construct:function(){this.callConstruct(BX.Tasks.Util.Widget);if(!("SocNetLogDestination"in BX)){throw new ReferenceError("No BX.SocNetLogDestination detected. Forgot to include socialnetwork module and/or its assets?")}this.vars.snldId=false;this.vars.intendSearch="";this.vars.last={};this.vars.intendOpen=false;this.vars.changed=false},getRole:function(){targetInput=this.control("search");role="U";if(targetInput&&targetInput.dataset&&targetInput.dataset.role){role=targetInput.dataset.role}return role},initialize:function(){if(this.dialogInitialized()){this.fireInitEvent()}else{if(!this.getDataCache()){this.fetchDestinationData()}else{this.initializeDialog()}}},dialogInitialized:function(){return this.vars.snldId!==false},open:function(){if(!this.dialogInitialized()){this.vars.intendOpen=true;this.initialize()}else if(this.vars.snldId!=i){this.vars.intendOpen=false;if(i!=false){BX.SocNetLogDestination.openDialog(this.vars.snldId)}BX.SocNetLogDestination.openDialog(this.vars.snldId);i=this.vars.snldId}},close:function(){this.vars.intendOpen=false;if(this.vars.snldId==i){BX.SocNetLogDestination.closeDialog()}},addLast:function(t){this.vars.changed=true;this.vars.last[t.id]={id:t.entityId,type:this.getEntityType(t)}},deleteLast:function(t){this.vars.changed=true;delete this.vars.last[t.id]},updateLast:function(){if(!this.option("syncLast")){return}if(!this.vars.changed){return}var t=this.vars.last;this.vars.last={};var i={};var s=0;for(var n in t){if(t.hasOwnProperty(n)){if(typeof i[t[n].type]=="undefined"){i[t[n].type]=[]}i[t[n].type].push(t[n].id);s++}}if(s>0){BX.ajax.runComponentAction("bitrix:tasks.widget.member.selector","setDestination",{mode:"class",data:{items:i,context:this.option("lastSelectedContext")}}).then(function(t){e=false}.bind(this),function(t){e=false}.bind(this))}this.vars.changed=false},fetchDestinationData:function(){if(!e){var i=this.control("search");var s={code:"get_destination_data"};s.role=this.getRole();s.groupId=0;if(i&&i.dataset&&i.dataset.groupid){s.groupId=i.dataset.groupid}e=true;BX.ajax.runComponentAction("bitrix:tasks.widget.member.selector","getDestination",{mode:"class",data:{context:this.option("lastSelectedContext")}}).then(function(i){e=false;if(!i.status||i.status!=="success"){return}role=this.getRole();t[role]=i.data;if(this.vars.intendOpen){this.open()}}.bind(this),function(t){e=false}.bind(this))}},onSelectDestination:function(t){this.addLast(t);t.params=t.params||{};var e={extranet:t.isExtranet=="Y",crmemail:t.isCrmEmail=="Y",email:t.isEmail=="Y",network:t.isNetwork=="Y"};this.fireEvent("item-selected",[{id:t.entityId,entityType:this.getEntityType(t),networkId:e.network&&t.networkId?t.networkId:"",nameFormatted:t.name||"",description:t.desc||"",avatar:t.avatar||"",name:t.params.name||"",lastName:t.params.lastName||"",email:t.email||"",type:e}])},getEntityType:function(t){var e="U";if(t.isEmail){return e}if(!t.id){return e}var i=t.id.toString().trim().match(/^[a-z]+/i);if(i&&i[0]){e=i[0]}return e},onUnSelectDestination:function(t){this.deleteLast(t);this.fireEvent("item-deselected",[{id:t.entityId,entityType:this.getEntityType(t),name:t.name}])},onOpenDialogDestination:function(t){i=t},onCloseDialogDestination:function(t){if(t==i){this.fireEvent("close");this.updateLast()}i=false},onOpenSearchDestination:function(t){i=t},onCloseSearchDestination:function(t){if(t==i){this.fireEvent("close");this.updateLast()}i=false},onOpenEmailDestination:function(t){i=t},onCloseEmailDestination:function(t){if(t==i){this.fireEvent("close");this.updateLast()}i=false},checkIsOpened:function(){return i==this.vars.snldId},deselectItem:function(t){if(this.vars.snldId!=false){BX.SocNetLogDestination.deleteItem(this.checkEntityId(t),this.option("mode"),this.vars.snldId)}},selectItem:function(t){if(this.vars.snldId!=false){BX.SocNetLogDestination.selectItem(this.vars.snldId,null,null,this.checkEntityId(t),this.option("mode"))}},checkEntityId:function(t){if(typeof t=="undefined"||t===null){return""}t=t.toString();if(t.substring(0,1)=="U"||t.substring(0,2)=="SG"||t.substring(0,2)=="DR"){return t}var e=this.option("mode")=="user";return(e?"U":"SG")+t},initializeDialog:function(){if(this.vars.snldId==false){this.vars.snldId=BX.util.hashCode(Math.random().toString());var t=this.scope();var e="name-"+this.id();var i=this.control("search");if(i){BX.adjust(i,{attrs:{input:e,id:e}})}var s=this.option("mode")=="all";var n=this.option("mode")=="user";var a=this.option("mode")=="group";var o=this.getDataCache();var r={name:this.vars.snldId,searchInput:i||null,bindMainPopup:{node:t,offsetTop:parseInt(this.option("popupOffsetTop"))+"px",offsetLeft:parseInt(this.option("popupOffsetLeft"))+"px"},bindSearchPopup:{node:t,offsetTop:parseInt(this.option("popupOffsetTop"))+"px",offsetLeft:parseInt(this.option("popupOffsetLeft"))+"px"},sendAjaxSearch:n||s||a&&(typeof o.SONETGROUPS_LIMITED!="undefined"&&o.SONETGROUPS_LIMITED=="Y"),useClientDatabase:!a,allowUserSearch:!a,allowSonetGroupsAjaxSearch:typeof o.SONETGROUPS_LIMITED!="undefined"&&o.SONETGROUPS_LIMITED=="Y",enableProjects:a,departmentSelectDisable:!s,allowAddUser:o.CAN_ADD_MAIL_USERS,allowAddSocNetGroup:false,callback:{select:BX.proxy(this.onSelectDestination,this),unSelect:BX.proxy(this.onUnSelectDestination,this),openDialog:BX.proxy(this.onOpenDialogDestination,this),closeDialog:BX.proxy(this.onCloseDialogDestination,this),openSearch:BX.proxy(this.onOpenSearchDestination,this),closeSearch:BX.proxy(this.onCloseSearchDestination,this),openEmailAdd:BX.proxy(this.onOpenEmailDestination,this),closeEmailAdd:BX.proxy(this.onCloseEmailDestination,this)}};if(this.option("useSearch")){r.showSearchInput=true}if(this.option("forceTop")){r.bindOptions={position:"top",forceTop:true}}r.items={users:n||s?o.USERS||{}:{},emails:n||s?o.EMAILS||{}:{},groups:s?{UA:{id:"UA",name:BX.message("TASKS_WIDGET_ACCESS_ALL_EMPLOYEES")}}:{},department:n||s?o.DEPARTMENT||{}:{},departmentRelation:n||s?o.DEPARTMENT_RELATION||{}:{},sonetgroups:a||s?o.SONETGROUPS||{}:{},projects:a||s?o.PROJECTS||{}:{}};r.itemsLast={users:n||s?o.LAST.USERS||{}:{},emails:n||s?o.LAST.EMAILS||{}:{},groups:s?{UA:true}:{},department:s?o.LAST.DEPARTMENT:{},sonetgroups:a||s?o.LAST.SONETGROUPS||{}:{},projects:a||s?o.LAST.PROJECTS||{}:{}};r.itemsSelected=o.SELECTED||{};r.allowSearchNetworkUsers=o.NETWORK_ENABLED;r.showVacations=o.SHOW_VACATIONS;r.usersVacation=o.USERS_VACATION||{};if(a){r.allowSearchEmailUsers=false}BX.SocNetLogDestination.init(r);if(i){var l={formName:this.vars.snldId,inputName:"name-"+this.id(),sendAjax:n||a&&(typeof o.SONETGROUPS_LIMITED!="undefined"&&o.SONETGROUPS_LIMITED=="Y")};var d=BX.clone(l);d.onPasteEvent=true;BX.bind(i,"keyup",BX.proxy(BX.SocNetLogDestination.BXfpSearch,l));BX.bind(i,"keydown",BX.proxy(BX.SocNetLogDestination.BXfpSearchBefore,l));BX.bind(i,"paste",BX.defer(BX.SocNetLogDestination.BXfpSearch,d));BX.bind(i,"click",BX.delegate(this.open,this))}}this.fireInitEvent();if(this.vars.intendOpen){this.open()}},fireInitEvent:function(){this.fireEvent("initialized")},clearDataCache:function(){t={}}}})})();
//# sourceMappingURL=socialnetwork.map.js