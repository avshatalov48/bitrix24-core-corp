(function(){if(BX.CJSTask)return;BX.CJSTask={ajaxUrl:"/bitrix/components/bitrix/tasks.iframe.popup/ajax.php?SITE_ID="+BX.message("SITE_ID"),sequenceId:0,timers:{}};BX.CJSTask.addTimeToDate=function(a,t,e){if(typeof a=="undefined"||typeof t=="undefined")return a;if(typeof e=="undefined")e={onlyIfEmpty:true};if(e.onlyIfEmpty&&(parseInt(a.getHours())!=0||parseInt(a.getMinutes())!=0))return a;if(typeof t.h!="undefined")a.setHours(parseInt(t.h));if(typeof t.m!="undefined")a.setMinutes(t.m);if(typeof t.s!="undefined")a.setSeconds(t.s);return a};BX.CJSTask.addTimeToDateTime=function(a,t,e){if(typeof a=="undefined"||typeof t=="undefined")return a;a=a.toString();if(a.length>0){var s=BX.CJSTask.addTimeToDate(BX.parseDate(a),t,e);a=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME")),s)}return a};BX.CJSTask.ui={};BX.CJSTask.ui.extractDefaultTimeFromDataAttribute=function(a){defaultTime={h:19,m:0,s:0};if(BX.type.isDomNode(a)){var t=BX.data(a,"default-hour");var e=BX.data(a,"default-minute");if(typeof t!="undefined"&&typeof e!="undefined"){defaultTime.h=parseInt(t);defaultTime.m=parseInt(e)}}return defaultTime};BX.CJSTask.ui.getInputDateTimeValue=function(a){var t=BX.CJSTask.ui.extractDefaultTimeFromDataAttribute(a);var e=new Date;curDayEveningTime=new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.h,t.m,t.s);if(!!a.value)var s=a.value;else var s=BX.date.convertToUTC(curDayEveningTime);return s};BX.CJSTask.getMessagePlural=function(a,t){var e,s;s=BX.message("LANGUAGE_ID");a=parseInt(a);if(a<0)a=-1*a;if(s){switch(s){case"de":case"en":e=a!==1?1:0;break;case"ru":case"ua":e=a%10===1&&a%100!==11?0:a%10>=2&&a%10<=4&&(a%100<10||a%100>=20)?1:2;break;default:e=1;break}}else e=1;return BX.message(t+"_PLURAL_"+e)};BX.CJSTask.fixWindow=function(a){var t=window.top;var e=window;return function(){var s=Array.prototype.slice.call(arguments);s.unshift(e,t);a.apply(this,s)}};BX.CJSTask.createItem=function(a,t){var t=t||null;var e=null;if(t.columnsIds)e=t.columnsIds;var s={sessid:BX.message("bitrix_sessid"),batch:[{operation:"CTaskItem::add()",taskData:a},{operation:"CTaskItem::getTaskData()",taskData:{ID:"#RC#$arOperationsResults#-1#justCreatedTaskId"}},{operation:"CTaskItem::getAllowedTaskActions()",taskData:{ID:"#RC#$arOperationsResults#-1#returnValue#ID"}},{operation:"NOOP"},{operation:"CTaskItem::getAllowedTaskActionsAsStrings()",taskData:{ID:"#RC#$arOperationsResults#-3#returnValue#ID"}},{operation:"tasksRenderJSON() && tasksRenderListItem()",taskData:{ID:"#RC#$arOperationsResults#-4#returnValue#ID"},columnsIds:e}]};BX.ajax({method:"POST",dataType:"json",url:BX.CJSTask.ajaxUrl,data:s,processData:true,onsuccess:function(a){var t=false;var e=false;if(a){if(a.callback)t=a.callback;if(a.callbackOnFailure)e=a.callbackOnFailure}return function(a){if(a.status==="success"&&!!t){var s={taskData:a["data"][1]["returnValue"],allowedTaskActions:a["data"][2]["returnValue"],allowedTaskActionsAsStrings:a["data"][4]["returnValue"]};var r=new BX.CJSTask.Item(a["data"][1]["returnValue"]["ID"],s);var n=BX.parseJSON(a["data"][5]["returnValue"]["tasksRenderJSON"]);var i=a["data"][5]["returnValue"]["tasksRenderListItem"];t(r,s,n,i)}else if(a.status!=="success"&&!!e){var o=[];var u=0;if(a.repliesCount>0&&a.data[a.repliesCount-1].hasOwnProperty("errors")){u=a.data[a.repliesCount-1].errors.length;for(var l=0;l<u;l++)o.push(a.data[a.repliesCount-1].errors[l]["text"])}e({rawReply:a,status:a.status,errMessages:o})}}}(t)})};BX.CJSTask.Item=function(a,t){if(!a)throw"taskId must be set";if(!(a>=1))throw"taskId must be >= 1";this.taskId=a;this.cachedData={taskData:false,allowedTaskActions:false,allowedTaskActionsAsStrings:false};if(t){if(t.taskData)this.cachedData.taskData=t.taskData;if(t.allowedTaskActions)this.cachedData.allowedTaskActions=t.allowedTaskActions;if(t.allowedTaskActionsAsStrings)this.cachedData.allowedTaskActionsAsStrings=t.allowedTaskActionsAsStrings}this.getCachedData=function(){return this.cachedData};this.refreshCache=function(a){var a=a||null;var t={sessid:BX.message("bitrix_sessid"),batch:[{operation:"CTaskItem::getTaskData()",taskData:{ID:this.taskId}},{operation:"CTaskItem::getAllowedTaskActions()",taskData:{ID:this.taskId}},{operation:"CTaskItem::getAllowedTaskActionsAsStrings()",taskData:{ID:this.taskId}}]};BX.ajax({method:"POST",dataType:"json",url:BX.CJSTask.ajaxUrl,data:t,processData:true,onsuccess:function(a,t){var e=false;if(a&&a.callback)e=a.callback;return function(a){t.cachedData={taskData:a["data"][0]["returnValue"],allowedTaskActions:a["data"][1]["returnValue"],allowedTaskActionsAsStrings:a["data"][2]["returnValue"]};if(!!e)e(t.cachedData)}}(a,this)})};this.complete=function(a){var t={sessid:BX.message("bitrix_sessid"),batch:[{operation:"CTaskItem::complete()",taskData:{ID:this.taskId}},{operation:"CTaskItem::getTaskData()",taskData:{ID:this.taskId}},{operation:"CTaskItem::getAllowedTaskActions()",taskData:{ID:"#RC#$arOperationsResults#-1#returnValue#ID"}},{operation:"CTaskItem::getAllowedTaskActionsAsStrings()",taskData:{ID:"#RC#$arOperationsResults#-2#returnValue#ID"}}]};BX.ajax({method:"POST",dataType:"json",url:BX.CJSTask.ajaxUrl,data:t,processData:true,onsuccess:function(a){var t=false;var e=false;if(a){if(a.callbackOnSuccess)t=a.callbackOnSuccess;if(a.callbackOnFailure)e=a.callbackOnFailure}return function(a){if(a.status==="success"&&!!t){var s={taskData:a["data"][1]["returnValue"],allowedTaskActions:a["data"][2]["returnValue"],allowedTaskActionsAsStrings:a["data"][3]["returnValue"]};var r=new BX.CJSTask.Item(a["data"][1]["returnValue"]["ID"],s);t(r)}else if(a.status!=="success"&&!!e){var n=[];var i=0;if(a.repliesCount>0&&a.data[a.repliesCount-1].hasOwnProperty("errors")){i=a.data[a.repliesCount-1].errors.length;for(var o=0;o<i;o++)n.push(a.data[a.repliesCount-1].errors[o]["text"])}e({rawReply:a,status:a.status,errMessages:n})}}}(a)})};this.startExecutionOrRenewAndStart=function(a){var t={sessid:BX.message("bitrix_sessid"),batch:[{operation:"CTaskItem::startExecutionOrRenewAndStart",taskData:{ID:this.taskId}},{operation:"CTaskItem::getTaskData()",taskData:{ID:this.taskId}},{operation:"CTaskItem::getAllowedTaskActions()",taskData:{ID:"#RC#$arOperationsResults#-1#returnValue#ID"}},{operation:"CTaskItem::getAllowedTaskActionsAsStrings()",taskData:{ID:"#RC#$arOperationsResults#-2#returnValue#ID"}}]};BX.ajax({method:"POST",dataType:"json",url:BX.CJSTask.ajaxUrl,data:t,processData:true,onsuccess:function(a){var t=false;var e=false;if(a){if(a.callbackOnSuccess)t=a.callbackOnSuccess;if(a.callbackOnFailure)e=a.callbackOnFailure}return function(a){if(a.status==="success"&&!!t){var s={taskData:a["data"][1]["returnValue"],allowedTaskActions:a["data"][2]["returnValue"],allowedTaskActionsAsStrings:a["data"][3]["returnValue"]};var r=new BX.CJSTask.Item(a["data"][1]["returnValue"]["ID"],s);t(r)}else if(a.status!=="success"&&!!e){var n=[];var i=0;if(a.repliesCount>0&&a.data[a.repliesCount-1].hasOwnProperty("errors")){i=a.data[a.repliesCount-1].errors.length;for(var o=0;o<i;o++)n.push(a.data[a.repliesCount-1].errors[o]["text"])}e({rawReply:a,status:a.status,errMessages:n})}}}(a)})};this.addElapsedTime=function(a,t){var e={TASK_ID:this.taskId,MINUTES:a.MINUTES,COMMENT_TEXT:a.COMMENT_TEXT};var s=BX.CJSTask.batchOperations([{operation:"CTaskItem::addElapsedTime()",elapsedTimeData:e}],t);return s};this.checklistAddItem=function(a,t){var e={TITLE:a};var s=BX.CJSTask.batchOperations([{operation:"CTaskCheckListItem::add()",checklistData:e,taskId:this.taskId}],t);return s};this.checklistRename=function(a,t,e){var s={TITLE:t};var r=BX.CJSTask.batchOperations([{operation:"CTaskCheckListItem::update()",checklistData:s,itemId:a,taskId:this.taskId}],e);return r};this.checklistComplete=function(a,t){var e=BX.CJSTask.batchOperations([{operation:"CTaskCheckListItem::complete()",itemId:a,taskId:this.taskId}],t);return e};this.checklistRenew=function(a,t){var e=BX.CJSTask.batchOperations([{operation:"CTaskCheckListItem::renew()",itemId:a,taskId:this.taskId}],t);return e};this.checklistDelete=function(a,t){var e=BX.CJSTask.batchOperations([{operation:"CTaskCheckListItem::delete()",itemId:a,taskId:this.taskId}],t);return e};this.checklistMoveAfterItem=function(a,t,e){var s=BX.CJSTask.batchOperations([{operation:"CTaskCheckListItem::moveAfterItem()",itemId:a,taskId:this.taskId,insertAfterItemId:t}],e);return s};this.stopWatch=function(a){var t=BX.CJSTask.batchOperations([{operation:"CTaskItem::stopWatch()",taskData:{ID:this.taskId}}],a);return t};this.startWatch=function(a){var t=BX.CJSTask.batchOperations([{operation:"CTaskItem::startWatch()",taskData:{ID:this.taskId}}],a);return t}};BX.CJSTask.TimerManager=function(a){if(!a)throw"taskId must be set";if(!(a>=1))throw"taskId must be >= 1";this.taskId=a;this.__private={startOrStop:function(a,t,e){var s=BX.CJSTask.batchOperations([{operation:a,taskData:{ID:t}},{operation:"CTaskItem::getTaskData()",taskData:{ID:"#RC#$arOperationsResults#-1#requestedTaskId"}},{operation:"CTaskTimerManager::getLastTimer()"}],e);return s}};this.start=function(a){var t=this.__private.startOrStop("CTaskTimerManager::start()",this.taskId,a);return t};this.stop=function(a){var t=this.__private.startOrStop("CTaskTimerManager::stop()",this.taskId,a);return t}};BX.CJSTask.setTimerCallback=function(a,t,e){if(BX.CJSTask[a]){window.clearInterval(BX.CJSTask[a]);BX.CJSTask[a]=null}if(t!==null)BX.CJSTask[a]=window.setInterval(t,e)};BX.CJSTask.formatUsersNames=function(a,t){var t=t||null;var e=null;var s=[];for(var r in a){e=a[r];s.push({operation:"CUser::FormatName()",userData:{ID:e}})}var n={sessid:BX.message("bitrix_sessid"),batch:s};BX.ajax({method:"POST",dataType:"json",url:BX.CJSTask.ajaxUrl,data:n,processData:true,onsuccess:function(a){var t=false;if(a&&a.callback)t=a.callback;return function(a){if(!!t){var e=null;var s={};var r=a["repliesCount"];for(var n=0;n<r;n++){e=a["data"][n];s["u"+e["requestedUserId"]]=e["returnValue"]}t(s)}}}(t)})};BX.CJSTask.getGroupsData=function(a,t){var t=t||null;var e=null;var s=[];for(var r in a){e=a[r];s.push({operation:"CSocNetGroup::GetByID()",groupData:{ID:e}})}var n={sessid:BX.message("bitrix_sessid"),batch:s};BX.ajax({method:"POST",dataType:"json",url:BX.CJSTask.ajaxUrl,data:n,processData:true,onsuccess:function(a){var t=false;if(a&&a.callback)t=a.callback;return function(a){if(!!t){var e=null;var s={};var r=a["repliesCount"];for(var n=0;n<r;n++){e=a["data"][n];s[e["requestedGroupId"]]=e["returnValue"]}t(s)}}}(t)})};BX.CJSTask.batchOperations=function(a,t,e){var t=t||null;var e=e||false;var s="batch_sequence_No_"+ ++BX.CJSTask.sequenceId;var r={sessid:BX.message("bitrix_sessid"),batch:a,batchId:s};BX.ajax({method:"POST",dataType:"json",url:BX.CJSTask.ajaxUrl,data:r,async:!e,processData:true,onsuccess:function(a){var t=false;var e=false;if(a){if(a.callbackOnSuccess)t=a.callbackOnSuccess;if(a.callbackOnFailure)e=a.callbackOnFailure}return function(a){if(a.status==="success"&&!!t){t({rawReply:a,status:a.status})}else if(a.status!=="success"&&!!e){var s=[];var r=0;if(a.repliesCount>0&&a.data[a.repliesCount-1].hasOwnProperty("errors")){r=a.data[a.repliesCount-1].errors.length;for(var n=0;n<r;n++)s.push(a.data[a.repliesCount-1].errors[n]["text"])}e({rawReply:a,status:a.status,errMessages:s})}}}(t)});return s}})();
//# sourceMappingURL=cjstask.map.js