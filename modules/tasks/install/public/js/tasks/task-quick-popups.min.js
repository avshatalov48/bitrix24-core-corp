(function(){if(!BX.Tasks)BX.Tasks={};if(BX.Tasks.lwPopup)return;BX.Tasks.lwPopup={ajaxUrl:"/bitrix/components/bitrix/tasks.list/ajax.php",onTaskAdded:null,onTaskAddedMultiple:null,loggedInUserId:null,loggedInUserFormattedName:null,garbageAreaId:"garbageAreaId_id",functions:{},functionsCount:0,firstRunDone:false,createForm:{objPopup:null,objTemplate:null,callbacks:{onAfterPopupCreated:null,onBeforePopupShow:null,onAfterPopupShow:null,onAfterEditorInited:null,onPopupClose:null}},anyForm:[],anyFormsCount:0,registerForm:function(e){e=e||{callbacks:{}};var t=this.anyFormsCount++;this.anyForm[t]={formIndex:t,objPopup:null,objTemplate:null,callbacks:e.callbacks};return this.anyForm[t]},__runAnyFormCallback:function(e,t,a){a=a||[];if(!this.anyForm[e])throw Error("Form with index "+e+" not exists");if(BX.Tasks.lwPopup.anyForm[e].callbacks.hasOwnProperty(t)&&BX.Tasks.lwPopup.anyForm[e].callbacks[t]!==null){BX.Tasks.lwPopup.anyForm[e].callbacks[t].apply(BX.Tasks.lwPopup.anyForm[e].objTemplate,a)}},showForm:function(e,t){t=typeof t!=="undefined"?t:{};if(!this.anyForm[e])throw Error("Form with index "+e+" not exists");var a=this.anyForm[e];BX.Tasks.lwPopup.__firstRun();var n=false;if(a.objPopup===null){this.buildForm(e,t);n=true}this.__runAnyFormCallback(e,"onBeforePopupShow",[t,{isPopupJustCreated:n}]);a.objPopup.show()},buildForm:function(e,t,a){var n=-110;t=typeof t!=="undefined"?t:{};if(typeof a!=="undefined")n=a;if(!this.anyForm[e])throw Error("Form with index "+e+" not exists");var s=this.anyForm[e];BX.Tasks.lwPopup.__firstRun();s.objPopup=new BX.PopupWindow("bx-tasks-quick-popup-anyForm-"+e,null,{zIndex:n,autoHide:false,buttons:s.objTemplate.prepareButtons(),closeByEsc:false,overlay:true,draggable:true,bindOnResize:false,titleBar:s.objTemplate.prepareTitleBar(),closeIcon:{right:"12px",top:"10px"},events:{onPopupClose:function(){BX.Tasks.lwPopup.__runAnyFormCallback(e,"onPopupClose",[])},onPopupFirstShow:function(){BX.Tasks.lwPopup.__runAnyFormCallback(e,"onPopupFirstShow",[])},onPopupShow:function(){BX.Tasks.lwPopup.__runAnyFormCallback(e,"onPopupShow",[])},onAfterPopupShow:function(){BX.Tasks.lwPopup.__runAnyFormCallback(e,"onAfterPopupShow",[])}},content:s.objTemplate.prepareContent(t)});this.__runAnyFormCallback(e,"onAfterPopupCreated",[t])},__runCreateFormCallback:function(e,t){t=t||[];if(BX.Tasks.lwPopup.createForm.callbacks.hasOwnProperty(e)&&BX.Tasks.lwPopup.createForm.callbacks[e]!==null){BX.Tasks.lwPopup.createForm.callbacks[e].apply(BX.Tasks.lwPopup.createForm.objTemplate,t)}},showCreateForm:function(e){e=typeof e!=="undefined"?e:{};BX.Tasks.lwPopup.__firstRun();if(!e.RESPONSIBLE_ID){e.RESPONSIBLE_ID=BX.Tasks.lwPopup.loggedInUserId;e["META:RESPONSIBLE_FORMATTED_NAME"]=BX.Tasks.lwPopup.loggedInUserFormattedName}else if(e.RESPONSIBLE_ID==BX.Tasks.lwPopup.loggedInUserId&&!e.hasOwnProperty("META:RESPONSIBLE_FORMATTED_NAME")){e["META:RESPONSIBLE_FORMATTED_NAME"]=BX.Tasks.lwPopup.loggedInUserFormattedName}var t=false;if(BX.Tasks.lwPopup.createForm.objPopup===null){BX.Tasks.lwPopup.createForm.objPopup=new BX.PopupWindow("bx-tasks-quick-popup-create-new-task",null,{zIndex:-110,autoHide:false,buttons:BX.Tasks.lwPopup.createForm.objTemplate.prepareButtons(),closeByEsc:false,overlay:true,draggable:true,bindOnResize:false,titleBar:BX.Tasks.lwPopup.createForm.objTemplate.prepareTitleBar(),closeIcon:{right:"12px",top:"10px"},events:{onPopupClose:function(){BX.Tasks.lwPopup.__runCreateFormCallback("onPopupClose",[])},onPopupFirstShow:function(){},onPopupShow:function(){},onAfterPopupShow:function(){if(BX("bx-panel")&&parseInt(BX.Tasks.lwPopup.createForm.objPopup.popupContainer.style.top)<147){BX.Tasks.lwPopup.createForm.objPopup.popupContainer.style.top=147+"px"}BX.Tasks.lwPopup.__runCreateFormCallback("onAfterPopupShow",[])}},content:BX.Tasks.lwPopup.createForm.objTemplate.prepareContent(e)});BX.Tasks.lwPopup.__runCreateFormCallback("onAfterPopupCreated",[e]);t=true}BX.Tasks.lwPopup.__runCreateFormCallback("onBeforePopupShow",[e,{isPopupJustCreated:t}]);BX.Tasks.lwPopup.createForm.objPopup.show()},_createTask:function(e){e=e||{};var t=false;var a=null;var n=null;var s=null;var o={};if(e.hasOwnProperty("taskData"))o=e.taskData;if(e.hasOwnProperty("onceMore"))t=e.onceMore;if(e.hasOwnProperty("columnsIds"))s=e.columnsIds;if(e.hasOwnProperty("callbackOnSuccess"))a=e.callbackOnSuccess;if(e.hasOwnProperty("callbackOnFailure"))n=e.callbackOnFailure;if(!o.hasOwnProperty("TITLE"))o.TITLE="";if(!o.hasOwnProperty("RESPONSIBLE_ID"))o.RESPONSIBLE_ID=this.loggedInUserId;BX.CJSTask.createItem(o,{columnsIds:s,callback:function(e,t){return function(a,n,s,o){var r={oTask:a,taskData:n.taskData,allowedTaskActions:n.allowedTaskActions,allowedTaskActionsAsStrings:n.allowedTaskActionsAsStrings,params:{onceMore:e}};if(t)t(r);if(BX.Tasks.lwPopup.onTaskAdded&&e===false)BX.Tasks.lwPopup.onTaskAdded(s,null,null,r,o);else if(BX.Tasks.lwPopup.onTaskAddedMultiple&&e===true)BX.Tasks.lwPopup.onTaskAddedMultiple(s,null,null,r,o)}}(t,a),callbackOnFailure:function(e){return function(t){if(e)e(t)}}(n)})},__initSelectors:function(e){var t=e.length;var a=false;BX.Tasks.lwPopup.__firstRun();for(var n=0;n<t;n++){if(e[n]["requestedObject"]==="intranet.user.selector.new"){a=true;break}}var s=null;if(a){var o=BX.Tasks.lwPopup.functionsCount++;BX.Tasks.lwPopup.functions["f"+o]=function(){};s=BX.Tasks.lwPopup.garbageAreaId+"__userSelectors_"+o+"_loadedHtml";BX(BX.Tasks.lwPopup.garbageAreaId).appendChild(BX.create("DIV",{props:{id:s}}))}var r={sessid:BX.message("bitrix_sessid"),requestsCount:t};var i=[];var l=[];for(var n=0;n<t;n++){if(e[n]["requestedObject"]==="intranet.user.selector.new")i[n]=this.__prepareUserSelectorsData(e[n]);else if(e[n]["requestedObject"]==="socialnetwork.group.selector")i[n]=this.__prepareGroupsSelectorsData(e[n]);else if(e[n]["requestedObject"]==="LHEditor")i[n]=this.__prepareLheData(e[n]);else if(e[n]["requestedObject"]==="system.field.edit::CRM"){i[n]=this.__prepareUserFieldData(e[n]);for(var u in i[n]["postData"])r[u]=i[n]["postData"][u]}else if(e[n]["requestedObject"]==="system.field.edit::WEBDAV"){i[n]=this.__prepareUserFieldDataWebdav(e[n]);for(var u in i[n]["postData"])r[u]=i[n]["postData"][u]}r["data_"+n]=i[n]["ajaxParams"];l[n]=i[n]["object"]}BX.ajax({method:"POST",dataType:"html",url:"/bitrix/components/bitrix/tasks.iframe.popup/ajax_loader.php?SITE_ID="+BX.message("SITE_ID"),data:r,processData:true,autoAuth:true,onsuccess:function(e,t,a){return function(n){if(a)BX(t).innerHTML=n;var s=e.length;for(var o=0;o<s;o++){if(e[o].hasOwnProperty("onLoadedViaAjax"))e[o].onLoadedViaAjax()}}}(l,s,a)});return l},__prepareUserFieldData:function(e){var t=BX.Tasks.lwPopup.functionsCount++;var a="OBJ_TASKS_CONTAINER_NAME_ID_"+t;var n="OBJ_TASKS_CONTAINER_DATA_ID_"+t;var s={requestedObject:"system.field.edit::CRM",userFieldName:e["userFieldName"],taskId:e["taskId"],nameContainerId:a,dataContainerId:n,values:e["value"]};var o=[];o.push.apply(o,e["value"]);BX.Tasks.lwPopup.functions["f"+t]={allParams:e,ajaxParams:s,ready:false,available:null,timeoutId:null,valuesBuffer:o,nameContainerId:a,dataContainerId:n,onLoadedViaAjax:function(){if(BX(this.nameContainerId))this.available=true;else this.available=false;if(!this.available)return false;var e=BX(this.nameContainerId).innerHTML;BX.remove(BX(this.nameContainerId));this.allParams.callbackOnRedraw(e,this.dataContainerId);this.ready=true},getValue:function(){var e=[];if(this.ready===true){var t=document.getElementsByName("UF_CRM_TASK[]");if(t){var a=t.length;for(var n=0;n<a;n++)e.push(t[n].value)}}else{e=this.valuesBuffer}return e},setValue:function(e){if(this.valuesBuffer.length===e.length){var t=this.valuesBuffer.slice().sort().join(";");var a=e.slice().sort().join(";");if(t===a)return}this.valuesBuffer=[];this.valuesBuffer.push.apply(this.valuesBuffer,e);this.__delayedSetContent(30)},__delayedSetContent:function(e){if(this.available===false)return false;if(this.ready===false){if(this.timeoutId!==null)window.clearTimeout(this.timeoutId);this.timeoutId=window.setTimeout(function(){var a=e+100;if(e<30)a=30;else if(e>500)a=500;BX.Tasks.lwPopup.functions["f"+t].__delayedSetContent(a)},e)}else{if(BX(this.nameContainerId))BX.remove(BX(this.nameContainerId));if(BX(this.dataContainerId))BX.remove(BX(this.dataContainerId));var a="";var n=this.valuesBuffer.length;for(var s=0;s<n;s++)a=a+"&UF_CRM_TASK[]="+this.valuesBuffer[s];var o={sessid:BX.message("bitrix_sessid"),requestsCount:1,data_0:this.ajaxParams};BX.ajax({method:"POST",dataType:"html",url:"/bitrix/components/bitrix/tasks.iframe.popup/ajax_loader.php?SITE_ID="+BX.message("SITE_ID")+a,data:o,processData:true,autoAuth:true,onsuccess:function(e){return function(t){BX(BX.Tasks.lwPopup.garbageAreaId).appendChild(BX.create("div",{html:t}));e.ready=true;var a=BX(e.nameContainerId).innerHTML;BX.remove(BX(e.nameContainerId));e.allParams.callbackOnRedraw(a,e.dataContainerId)}}(this)})}}};var r={object:BX.Tasks.lwPopup.functions["f"+t],ajaxParams:s,postData:{UF_CRM_TASK:e["value"]}};return r},__prepareUserFieldDataWebdav:function(e){var t=BX.Tasks.lwPopup.functionsCount++;var a="OBJ_TASKS_CONTAINER_NAME_ID_"+t;var n="OBJ_TASKS_CONTAINER_DATA_ID_"+t;var s={requestedObject:"system.field.edit::WEBDAV",userFieldName:e["userFieldName"],taskId:e["taskId"],nameContainerId:a,dataContainerId:n,values:e["value"]};var o=[];o.push.apply(o,e["value"]);BX.Tasks.lwPopup.functions["f"+t]={allParams:e,ajaxParams:s,ready:false,available:null,timeoutId:null,valuesBuffer:o,nameContainerId:a,dataContainerId:n,onLoadedViaAjax:function(){if(BX(this.nameContainerId))this.available=true;else this.available=false;if(!this.available)return false;var e=BX(this.nameContainerId).innerHTML;BX.remove(BX(this.nameContainerId));this.allParams.callbackOnRedraw(e,this.dataContainerId);this.ready=true},getValue:function(){var e=[];if(this.ready===true){var t=document.getElementsByName("UF_TASK_WEBDAV_FILES[]");if(t){var a=t.length;for(var n=0;n<a;n++)e.push(t[n].value)}}else{e=this.valuesBuffer}return e},setValue:function(e){if(this.valuesBuffer.length===e.length){var t=this.valuesBuffer.slice().sort().join(";");var a=e.slice().sort().join(";");if(t===a)return}this.valuesBuffer=[];this.valuesBuffer.push.apply(this.valuesBuffer,e);this.__delayedSetContent(30)},__delayedSetContent:function(e){if(this.available===false)return false;if(this.ready===false){if(this.timeoutId!==null)window.clearTimeout(this.timeoutId);this.timeoutId=window.setTimeout(function(){var a=e+100;if(e<30)a=30;else if(e>500)a=500;BX.Tasks.lwPopup.functions["f"+t].__delayedSetContent(a)},e)}else{if(BX(this.nameContainerId))BX.remove(BX(this.nameContainerId));if(BX(this.dataContainerId))BX.remove(BX(this.dataContainerId));var a="";var n=this.valuesBuffer.length;for(var s=0;s<n;s++)a=a+"&UF_TASK_WEBDAV_FILES[]="+this.valuesBuffer[s];var o={sessid:BX.message("bitrix_sessid"),requestsCount:1,data_0:this.ajaxParams};BX.ajax({method:"POST",dataType:"html",url:"/bitrix/components/bitrix/tasks.iframe.popup/ajax_loader.php?SITE_ID="+BX.message("SITE_ID")+a,data:o,processData:true,autoAuth:true,onsuccess:function(e){return function(t){BX(BX.Tasks.lwPopup.garbageAreaId).appendChild(BX.create("div",{html:t}));e.ready=true;var a=BX(e.nameContainerId).innerHTML;BX.remove(BX(e.nameContainerId));e.allParams.callbackOnRedraw(a,e.dataContainerId)}}(this)})}}};var r={object:BX.Tasks.lwPopup.functions["f"+t],ajaxParams:s,postData:{UF_TASK_WEBDAV_FILES:e["value"]}};return r},__prepareLheData:function(e){var t=BX.Tasks.lwPopup.functionsCount++;var a="OBJ_TASKS_LHEDITOR_NS_"+t;var n="OBJ_TASKS_ELEMENT_ID_NS_"+t;var s="OBJ_TASKS_INPUT_ID_NS_"+t;BX.Tasks.lwPopup.functions["f"+t]={allParams:e,jsObjectName:a,elementId:n,editor:null,inputId:s,content:"",getContent:function(){if(this.editor!==null){this.editor.SaveContent();return this.editor.GetContent()}else{if(BX(this.inputId))return BX(this.inputId).value;else return""}},setContent:function(e){this["content"]=e;this.__delayedSetContent(30)},__delayedSetContent:function(e){if(this.editor===null){window.setTimeout(function(){var a=e+100;if(e<30)a=30;else if(e>500)a=500;BX.Tasks.lwPopup.functions["f"+t].__delayedSetContent(a)},e)}else{if(BX.type.isString(this["content"])){this.editor.SetContent(this["content"]);if(this["content"].length==0)this.editor.ResizeSceleton(false,200);if(BX.browser.IsChrome()||BX.browser.IsIE11()||BX.browser.IsIE()){var a=BX("lwPopup-task-title");if(BX.type.isElementNode(a)){this.editor.Focus(false);a.focus()}}}}}};BX.addCustomEvent(window,"OnEditorInitedAfter",function(e,t){var a=false;return function(n){if(!a&&n.id==e.elementId){e.editor=n;var s=BX(t);s.innerHTML="";s.appendChild(n.dom.cont);a=true;setTimeout(function(){n.CheckAndReInit();n.SetContent(e["content"]);if(BX.browser.IsChrome()||BX.browser.IsIE11()||BX.browser.IsIE()){var t=BX("lwPopup-task-title");if(BX.type.isElementNode(t)){n.Focus(false);t.focus()}}},500);BX.Tasks.lwPopup.__runCreateFormCallback("onAfterEditorInited",[])}}}(BX.Tasks.lwPopup.functions["f"+t],e.attachTo));var o={object:BX.Tasks.lwPopup.functions["f"+t],ajaxParams:{requestedObject:"LHEditor",jsObjectName:a,elementId:n,inputId:s}};return o},__prepareGroupsSelectorsData:function(e){var t=BX.Tasks.lwPopup.functionsCount++;var a="OBJ_TASKS_GROUP_SELECTOR_NS_"+t;BX.Tasks.lwPopup.functions["f"+t]={allParams:e,jsObjectName:a,bindElement:e.bindElement,onLoadedViaAjax:function(){BX.bind(BX(this.bindElement),"click",function(e){return function(t){if(!t)t=window.event;var a=window[e.jsObjectName];if(a){a.popupWindow.params.zIndex=1400;a.show()}BX.PreventDefault(t)}}(this));if(this.allParams.onLoadedViaAjax)this.allParams.onLoadedViaAjax(this.jsObjectName)},setSelected:function(e){if(!window[this.jsObjectName])return;if(e.id==0){var t=null;if(window[this.jsObjectName].selected[0]){t=window[this.jsObjectName].selected[0];window[this.jsObjectName].deselect(t.id)}}else window[this.jsObjectName].select(e)},deselect:function(e){window[this.jsObjectName].deselect(e)}};var n="FUNC_TASKS_GROUP_SELECTOR_NS_"+t;window[n]=function(e){return function(t){if(e)e(t)}}(e.callbackOnSelect);var s={object:BX.Tasks.lwPopup.functions["f"+t],ajaxParams:{requestedObject:"socialnetwork.group.selector",jsObjectName:a,bindElement:e.bindElement,onSelectFuncName:n}};return s},__prepareUserSelectorsData:function(e){var t=null;var a=null;var n=0;if(e.hasOwnProperty("userInputId"))t=e.userInputId;if(e.hasOwnProperty("bindClickTo"))a=e.bindClickTo;else a=t;var s=e.callbackOnSelect;var o=e.selectedUsersIds;var r=e.anchorId;var l=e["multiple"];var u=BX.Tasks.lwPopup.functionsCount++;var p="OBJ_TASKS_USER_SELECTOR_NS_"+u;if(e.GROUP_ID_FOR_SITE)n=e.GROUP_ID_FOR_SITE;BX.Tasks.lwPopup.functions["f"+u]={allParams:e,multiple:l,popupId:p+"_popupId",bindClickTo:a,userInputId:t,anchorId:r,userPopupWindow:null,nsObjectName:p,onLoadedViaAjax:function(){var e=this;if(this.userInputId){BX.bind(BX(this.userInputId),"focus",function(t){e.showUserSelector(t)});if(BX(this.bindClickTo)){BX.bind(BX(this.bindClickTo),"click",function(t){if(!t)t=window.event;BX(e.userInputId).focus();BX.PreventDefault(t)})}}if(this.allParams.onLoadedViaAjax)this.allParams.onLoadedViaAjax();if(this.allParams.onReady){(function(e,t){var a=function(t,n,s){if(typeof window[e]==="undefined"){if(n>0){window.setTimeout(function(){a(t,n-t,s)},t)}}else{s(window[e])}};a(100,15e3,t)})("O_"+this.nsObjectName,this.allParams.onReady)}},onPopupClose:function(e){var t=window["O_"+e.nsObjectName];var a=t.arSelected.pop();if(a){t.arSelected.push(a);t.searchInput.value=a.name}},setSelectedUsers:function(e,t){var t=t||1;if(t>100)return;if(!window["O_"+this.nsObjectName]){window.setTimeout(function(e,t,a){return function(){e.setSelectedUsers(a,t+1)}}(this,t,e),50);return}var a=window["O_"+this.nsObjectName];a.setSelected(e)},showUserSelector:function(e){if(!e)e=window.event;if(this.userPopupWindow!==null&&this.userPopupWindow.popupContainer.style.display=="block"){return}var t=BX(this.anchorId);var a=null;var n=this;if(this["multiple"]==="Y"){a=[new BX.PopupWindowButton({text:this.allParams.btnSelectText,className:"popup-window-button-accept",events:{click:function(e){n.btnSelectClick(e);n.userPopupWindow.close()}}}),new BX.PopupWindowButtonLink({text:this.allParams.btnCancelText,className:"popup-window-button-link-cancel",events:{click:function(e){if(!e)e=window.event;n.userPopupWindow.close();if(e)BX.PreventDefault(e)}}})]}this.userPopupWindow=BX.PopupWindowManager.create(this.popupId,t,{offsetTop:1,autoHide:true,closeByEsc:true,content:BX(this.nsObjectName+"_selector_content"),buttons:a});if(this["multiple"]==="N"){BX.addCustomEvent(this.userPopupWindow,"onPopupClose",function(){n.onPopupClose(n)})}else{BX.addCustomEvent(this.userPopupWindow,"onAfterPopupShow",function(e){setTimeout(function(){window["O_"+n.nsObjectName].searchInput.focus()},100)})}this.userPopupWindow.show();BX(this.userPopupWindow.uniquePopupId).style.zIndex=1400;BX.focus(t);BX.PreventDefault(e)}};if(l==="N"){BX.Tasks.lwPopup.functions["f"+u].onUserSelect=function(e){var t=BX.Tasks.lwPopup.functions["f"+u];return function(a){if(t.userPopupWindow)t.userPopupWindow.close();e(a)}}(s);BX.Tasks.lwPopup.functions["f"+u].btnSelectClick=function(){}}else{BX.Tasks.lwPopup.functions["f"+u].onUserSelect=function(){};BX.Tasks.lwPopup.functions["f"+u].btnSelectClick=function(e){return function(t){if(!t)t=window.event;var a=window["O_"+this.nsObjectName].arSelected;var n=a.length;var s=[];for(i=0;i<n;i++){if(a[i])s.push(a[i])}e(s)}}(s)}var d={requestedObject:"intranet.user.selector.new",multiple:l,namespace:p,inputId:t,onSelectFunctionName:"BX.Tasks.lwPopup.functions.f"+u+".onUserSelect",GROUP_ID_FOR_SITE:n,selectedUsersIds:o};if(e.callbackOnChange){BX.Tasks.lwPopup.functions["f"+u].onUsersChange=e.callbackOnChange;d.onChangeFunctionName="BX.Tasks.lwPopup.functions.f"+u+".onUsersChange"}var c={object:BX.Tasks.lwPopup.functions["f"+u],ajaxParams:d};return c},_getDefaultTimeForInput:function(e){if(BX.type.isDomNode(e)){var t=BX.data(e,"default-time");if(typeof t!="undefined"){var a=t.toString().split(":");t={h:+a[0],m:+a[1],s:+a[2]}}else{t={h:19,m:0,s:0}}}return t},_showCalendar:function(e,t,a){if(typeof a==="undefined")var a={};var n=true;if(a.hasOwnProperty("bTime"))n=a.bTime;var s=false;if(a.hasOwnProperty("bHideTime"))s=a.bHideTime;var o=null;if(a.hasOwnProperty("callback_after"))o=a.callback_after;BX.calendar({node:e,field:t,bTime:n,value:BX.CJSTask.ui.getInputDateTimeValue(t),bHideTime:s,callback_after:o})},__firstRun:function(){if(BX.Tasks.lwPopup.firstRunDone)return;BX.Tasks.lwPopup.firstRunDone=true;var e=document.getElementsByTagName("body")[0];if(!BX(BX.Tasks.lwPopup.garbageAreaId)){e.appendChild(BX.create("DIV",{props:{id:BX.Tasks.lwPopup.garbageAreaId}}))}}}})();
//# sourceMappingURL=task-quick-popups.map.js