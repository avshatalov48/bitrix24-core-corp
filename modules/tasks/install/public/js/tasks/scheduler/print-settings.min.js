(function(){"use strict";BX.namespace("BX.Scheduler");BX.Scheduler.PrintSettings=function(t){this.timeline=t;this.printer=new BX.Scheduler.Printer(t);this.defaultFormat="A4";this.init()};BX.Scheduler.PrintSettings.prototype={init:function(){this.popupWindow=null;this.layout={content:null,errorAlert:null,errorText:null,dateFrom:null,dateTo:null,format:null,orientation:null,border:null,fitToPage:null}},show:function(){this.getPopup().show();this.getPrinter().closePrintWindow()},close:function(){this.getPopup().destroy();this.init()},handlePrintButtonClick:function(){var t=this.getPrinter();t.setFormat(this.getFormat());t.setOrientation(this.getOrientation());t.setBorder(this.getBorder());t.setDateFrom(this.getDateFrom());t.setDateTo(this.getDateTo());t.setFitToPage(this.getFitToPage());try{t.print();this.close();if(this.isChrome()){var e=new BX.Scheduler.PrintSettingsAlert(t);e.show()}}catch(t){this.showError(t.message)}},getPrinter:function(){return this.printer},showError:function(t){this.layout.content.insertBefore(this.getErrorAlert(),this.layout.content.firstElementChild);this.layout.errorText.innerHTML=t},hideError:function(){BX.remove(this.getErrorAlert())},getErrorAlert:function(){if(this.layout.errorAlert===null){this.layout.errorAlert=BX.create("div",{props:{className:"ui-alert ui-alert-danger"},children:[this.layout.errorText=BX.create("span",{props:{className:"ui-alert-message"}}),BX.create("span",{props:{className:"ui-alert-close-btn"},events:{click:function(){this.hideError()}.bind(this)}})]})}return this.layout.errorAlert},isChrome:function(){return/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor)},getPopup:function(){if(this.popupWindow!==null){return this.popupWindow}this.popupWindow=new BX.PopupWindow("scheduler-print-settings",null,{autoHide:false,closeByEsc:true,titleBar:BX.message("SCHEDULER_PRINT_SETTINGS_TITLE"),closeIcon:true,draggable:true,buttons:[new BX.PopupWindowButton({text:BX.message("SCHEDULER_PRINT_BUTTON_TITLE"),className:"popup-window-button-accept",events:{click:this.handlePrintButtonClick.bind(this)}}),new BX.PopupWindowButtonLink({text:BX.message("SCHEDULER_PRINT_CANCEL_BUTTON_TITLE"),className:"popup-window-button-link theme-dialog-button-link",events:{click:function(){this.popupWindow.close()}}})],events:{onPopupClose:function(){this.close()}.bind(this)}});this.layout.content=BX.create("div",{props:{className:"scheduler-print-settings"},children:[this.createRow([this.createField(BX.message("SCHEDULER_PRINT_DATE_FROM_TITLE"),this.getDateFromField()),this.createField(BX.message("SCHEDULER_PRINT_DATE_TO_TITLE"),this.getDateToField())]),this.createRow([this.createField(BX.message("SCHEDULER_PRINT_FORMAT_TITLE"),this.getFormatField()),this.createField(BX.message("SCHEDULER_PRINT_ORIENTATION_TITLE"),this.getOrientationField())]),this.createRow([this.createField(null,[BX.create("label",{props:{className:"scheduler-print-control-label"},children:[this.getBorderField(),BX.create("span",{text:BX.message("SCHEDULER_PRINT_BORDER_TITLE")})]}),BX.create("label",{props:{className:"scheduler-print-control-label"},children:[this.getFitToPageField(),BX.create("span",{text:BX.message("SCHEDULER_PRINT_FIT_TO_PAGE")})]})])])]});this.popupWindow.setContent(this.layout.content);return this.popupWindow},createField:function(t,e){var r=Array.isArray(e)?e:[e];return BX.create("div",{props:{className:"scheduler-print-box"},children:[BX.type.isNotEmptyString(t)?BX.create("div",{props:{className:"scheduler-print-caption"},text:t}):null].concat(r)})},createRow:function(t){return BX.create("div",{props:{className:"scheduler-print-row"},children:t})},getDateFromField:function(){if(this.layout.dateFrom===null){this.layout.dateFrom=BX.create("input",{attrs:{type:"text",readonly:"true"},props:{className:"scheduler-print-control scheduler-print-control-date",value:this.formatDate(this.printer.getViewportDateFrom())},events:{click:this.handleDateClick.bind(this)}})}return this.layout.dateFrom},getDateToField:function(){if(this.layout.dateTo===null){this.layout.dateTo=BX.create("input",{attrs:{type:"text",readonly:"true"},props:{className:"scheduler-print-control scheduler-print-control-date",value:this.formatDate(this.printer.getViewportDateTo())},events:{click:this.handleDateClick.bind(this)}})}return this.layout.dateTo},formatDate:function(t){return BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME")).replace(/:s/g,""),t,null,true)},handleDateClick:function(t){BX.calendar({node:t.currentTarget,field:t.currentTarget,bTime:true,bUseSecond:false,bSetFocus:false})},getFormatField:function(){if(this.layout.format===null){this.layout.format=BX.create("select",{props:{className:"scheduler-print-control scheduler-print-control-select"},children:Object.keys(this.printer.getPaperSizes()).map(function(t){return BX.create("option",{text:t,attrs:{value:t},props:{selected:this.defaultFormat===t}})},this)})}return this.layout.format},getOrientationField:function(){if(this.layout.orientation===null){this.layout.orientation=BX.create("select",{props:{className:"scheduler-print-control scheduler-print-control-select"},children:[BX.create("option",{text:BX.message("SCHEDULER_PRINT_PORTRAIT_TITLE"),attrs:{value:"portrait"}}),BX.create("option",{text:BX.message("SCHEDULER_PRINT_LANDSCAPE_TITLE"),attrs:{value:"landscape"}})]})}return this.layout.orientation},getBorderField:function(){if(this.layout.border===null){this.layout.border=BX.create("input",{attrs:{type:"checkbox"},props:{className:"scheduler-print-control-checkbox",checked:true}})}return this.layout.border},getFitToPageField:function(){if(this.layout.fitToPage===null){this.layout.fitToPage=BX.create("input",{attrs:{type:"checkbox"},props:{className:"scheduler-print-control-checkbox",checked:true}})}return this.layout.fitToPage},getDateFrom:function(){return BX.parseDate(this.getDateFromField().value,true)},getDateTo:function(){return BX.parseDate(this.getDateToField().value,true)},getFormat:function(){var t=this.getFormatField();return t.options[t.selectedIndex].value},getOrientation:function(){var t=this.getOrientationField();return t.options[t.selectedIndex].value},getBorder:function(){return this.getBorderField().checked},getFitToPage:function(){return this.getFitToPageField().checked}};BX.Scheduler.PrintSettingsAlert=function(t){this.printer=t;var e=this.printer.getPrintWindow();if(e){e.addEventListener("beforeprint",this.handleBeforePrint.bind(this));e.addEventListener("afterprint",this.handleAfterPrint.bind(this))}var r=setInterval(function(){if(e&&e.closed){clearInterval(r);this.close()}}.bind(this),500);this.popupWindow=null};BX.Scheduler.PrintSettingsAlert.prototype={show:function(){this.getPopup().show()},close:function(){this.getPopup().close()},getPrinter:function(){return this.printer},getPopup:function(){if(this.popupWindow!==null){return this.popupWindow}var t=this;this.popupWindow=new BX.PopupWindow("scheduler-print-settings-alert",null,{autoHide:false,closeByEsc:false,closeIcon:false,overlay:true,content:'<div class="scheduler-print-alert-container">'+BX.message("SCHEDULER_PRINT_ALERT_TEXT")+"</div>",buttons:[new BX.PopupWindowButton({text:BX.message("SCHEDULER_PRINT_ALERT_BUTTON_TITLE"),className:"popup-window-button-accept",events:{click:function(){this.popupWindow.close();t.getPrinter().closePrintWindow()}}})]});return this.popupWindow},handleBeforePrint:function(){this.show()},handleAfterPrint:function(){this.close()}}})();