BX.namespace("BX.Scheduler");BX.Scheduler.View=function(){var e=function(e){this.config=e||{};this.timeline=new BX.Scheduler.Timeline(this.config);this.eventLayout=new BX.Scheduler.EventLayout(this.timeline);this.resourceStore=new BX.Scheduler.ResourceStore;this.eventStore=new BX.Scheduler.EventStore;this.resourceStore.setEventStore(this.eventStore);this.resourceStore.setView(this);this.eventStore.setResourceStore(this.resourceStore);this.eventStore.setView(this);this.scrollDate=null;BX.addCustomEvent(this.timeline,"onBeforeZoomChange",BX.proxy(this.onBeforeZoomChange,this));BX.addCustomEvent(this.timeline,"onZoomChange",BX.proxy(this.onZoomChange,this))};e.prototype={clearAll:function(){this.resourceStore.clearAll();this.eventStore.clearAll()},getResourceStore:function(){return this.resourceStore},getEventStore:function(){return this.eventStore},render:function(){this.expandTimeline();var e=this.resourceStore.getRoot();var t=this.renderRecursive(e.getChildNodes());this.timeline.clearItems();this.timeline.clearRows();this.timeline.appendRows(t);var r=!BX.type.isDomNode(this.timeline.layout.root.parentNode);this.timeline.draw();if(r){this.timeline.autoScroll()}},renderRecursive:function(e){var t=[];for(var r=0,i=e.length;r<i;r++){var n=e[r];var s=n.getData();var o=s.renderTimelineRow();t.push(o);var a=n.getChildNodes();if(a.length){Array.prototype.push.apply(t,this.renderRecursive(a))}}return t},getEventLayout:function(){return this.eventLayout},getTimeline:function(){return this.timeline},expandTimeline:function(){var e=this.eventStore.getEvents();var t=this.timeline.getCurrentDate();var r=this.timeline.getCurrentDate();for(var i in e){var n=e[i];if(n.getStartDate()<t){t=n.getStartDate()}if(n.getEndDate()>r){r=n.getEndDate()}}this.timeline.autoExpandTimeline([t,r])},getCurrentScrollDate:function(){this.calculateScrollDate();return this.scrollDate},calculateScrollDate:function(){var e=this.timeline.layout.timeline.scrollLeft;this.scrollDate=BX.Tasks.Date.floorDate(this.timeline.getDateFromPixels(e),BX.Tasks.Date.Unit.Day)},onBeforeZoomChange:function(e){this.calculateScrollDate()},onZoomChange:function(e){this.render();if(this.scrollDate){this.timeline.scrollToDate(this.scrollDate)}BX.onCustomEvent(this,"onZoomChange",[e])}};return e}();BX.Scheduler.ResourceStore=function(){var e=function(t){e.superclass.constructor.apply(this,arguments);this.eventStore=null;this.view=null};BX.extend(e,BX.Scheduler.Tree);e.prototype.setEventStore=function(e){this.eventStore=e};e.prototype.setView=function(e){if(e instanceof BX.Scheduler.View){this.view=e}};e.prototype.getDefaultDataType=function(){return BX.Scheduler.Resource};e.prototype.onNodeAdded=function(t){e.superclass.onNodeAdded.apply(this,arguments);t.getData().view=this.view};return e}();BX.Scheduler.Resource=function(){var e=function(t){this.config=t||{};this.id=t.id||e.getUniqueId();this.name=BX.type.isNotEmptyString(t.name)?t.name:"";this.link=BX.type.isNotEmptyString(t.link)?t.link:"";this.store=null;this.view=null;this.timelineRow=new BX.Scheduler.TimelineRow;this.collapsed=true;this.layout={resource:null,arrow:null,name:null}};var t=0;e.getUniqueId=function(){return"resource-"+ ++t};e.prototype={renderTimelineRow:function(){var e=this.timelineRow.getResourceRow();var t=this.timelineRow.getEventRow();BX.cleanNode(e);BX.cleanNode(t);e.appendChild(this.renderResource());t.appendChild(this.renderEvents());return this.timelineRow},createLayout:function(){this.layout.resource=BX.create("div",{props:{className:"scheduler-resource"},children:[this.layout.arrow=BX.create("span",{props:{className:"scheduler-resource-arrow"},events:{click:BX.proxy(this.onArrowClick,this)}}),this.layout.name=BX.create("a",{props:{className:"scheduler-resource-name",href:this.link,target:"_blank"},text:this.getName()})]})},updatelayout:function(){},renderResource:function(){if(this.layout.resource===null){this.createLayout()}this.updatelayout();return this.layout.resource},renderEvents:function(){var e=this.getEvents();var t=this.getView().getEventLayout();var r=t.layoutEvents(e);var i=document.createDocumentFragment();for(var n=0;n<e.length;n++){var s=e[n];i.appendChild(s.render())}if(!this.collapsed&&r>1){BX.removeClass(this.timelineRow.getResourceRow(),"scheduler-row-resource-collapsed");BX.removeClass(this.timelineRow.getEventRow(),"scheduler-row-event-collapsed");this.timelineRow.setRowHeight(this.getTimeline().getRowHeight()*r)}else{BX.addClass(this.timelineRow.getResourceRow(),"scheduler-row-resource-collapsed");BX.addClass(this.timelineRow.getEventRow(),"scheduler-row-event-collapsed");this.timelineRow.setRowHeight(this.getTimeline().getRowHeight())}if(r>1){BX.addClass(this.layout.resource,"scheduler-resource-collapsable")}else{BX.removeClass(this.layout.resource,"scheduler-resource-collapsable")}return i},getEvents:function(){var e=this.getEventStore();return e.getResourceEvents(this.getId())},getEventStore:function(){return this.store&&this.store.eventStore},getView:function(){return this.view},getTimeline:function(){return this.view.getTimeline()},getTimelineRow:function(){return this.timelineRow},getId:function(){return this.id},getName:function(){return this.name},isCollapsed:function(){return this.collapsed},onArrowClick:function(e){this.collapsed=!this.collapsed;this.renderTimelineRow()}};return e}();BX.Scheduler.EventLayout=function(e){this.timeline=e};BX.Scheduler.EventLayout.prototype={layoutEvents:function(e){var t=0;if(!e.length){return t}e=e.slice();e.sort(this.sortEvents);while(e.length){var r=e[0];while(r){r.index=t;var i=BX.util.array_search(r,e);e.splice(i,1);r=this.getClosestEvent(r,e)}t++}return t},sortEvents:function(e,t){var r=e.getStartDate();var i=e.getEndDate();var n=t.getStartDate();var s=t.getEndDate();if(r-n===0){return i>s?-1:1}else{return r<n?-1:1}},getClosestEvent:function(e,t){var r=this.getMinGap();var i=Infinity;var n=null;var s=e.getEndDate();for(var o=0,a=t.length;o<a;o++){var u=t[o];var l=u.getStartDate()-s;if(l>=r&&l<i){n=u;i=l}}return n},getMinGap:function(){return BX.Tasks.Date.getUnitRatio(BX.Tasks.Date.Unit.Milli,this.timeline.snapUnit)}};BX.Scheduler.ResourceGroup=function(){var e=function(t){e.superclass.constructor.apply(this,arguments)};BX.extend(e,BX.Scheduler.Resource);e.prototype.renderResource=function(){return BX.create("div",{props:{className:"scheduler-resource scheduler-resource-group"},text:this.getName()})};return e}();BX.Scheduler.EventStore=function(){var e=function(e){this.config=e||{};this.resourceStore=null;this.events={};this.byIdMap={};this.view=null;this.load(this.config.data)};e.prototype={clearAll:function(){this.events={};this.byIdMap={}},setResourceStore:function(e){this.resourceStore=e},setView:function(e){if(e instanceof BX.Scheduler.View){this.view=e}},getById:function(e){return this.byIdMap[e]?this.byIdMap[e]:null},getEvents:function(){return this.byIdMap},getView:function(){return this.view},add:function(e){if(e instanceof BX.Scheduler.Event&&!this.getById(e.getId())){var t=e.getResourceId();if(t){if(!this.events[t]){this.events[t]=[]}this.events[t].push(e);this.byIdMap[e.getId()]=e;e.join(this)}}},remove:function(e){},removeByResourceId:function(e){},load:function(e){if(!BX.type.isArray(e)){return}for(var t=0;t<e.length;t++){try{var r=new BX.Scheduler.Event(e[t]);this.add(r)}catch(e){BX.debug(e)}}},getResourceEvents:function(e){return this.events[e]||[]}};return e}();BX.Scheduler.Event=function(){var e=function(t){this.config=t||{};if(!BX.type.isDate(t.startDate)){throw new Error("You must set starDate parameter.")}if(!BX.type.isDate(t.endDate)){throw new Error("You must set endDate parameter.")}this.startDate=BX.Tasks.Date.convertToUTC(t.startDate);this.endDate=BX.Tasks.Date.convertToUTC(t.endDate);this.resourceId=t.resourceId||null;this.name=t.name||"";this.className=BX.type.isNotEmptyString(t.className)?t.className:"";this.id=t.id||e.getUniqueId();this.index=0;this.onclick=BX.type.isFunction(t.onclick)?t.onclick:null;this.store=null};var t=0;e.getUniqueId=function(){return"event-"+ ++t};e.prototype={getResource:function(){var e=this.getResourceStore();if(!e){return null}var t=e.getById(this.getResourceId());return t&&t.getData()},getResourceStore:function(){return this.store&&this.store.resourceStore},getResourceId:function(){return this.resourceId},getStartDate:function(){return this.startDate},getEndDate:function(){return this.endDate},getClassName:function(){return this.className},join:function(e){this.store=e},unjoin:function(){delete this.store},getName:function(){return this.name},getId:function(){return this.id},render:function(){var e=this.getResource();var t=e.getTimeline();var r=t.getPixelsFromDate(this.getStartDate());var i=t.getPixelsFromDate(this.getEndDate());var n=2;var s=i-r;s=Math.max(s,n);var o=e.isCollapsed()?0:this.index*t.getRowHeight();var a=null;if(this.onclick!==null){a={click:BX.proxy(this.onclick,this)}}var u="scheduler-event";if(this.onclick!==null){u+=" scheduler-event-clickable"}if(this.getClassName()!==""){u+=" "+this.getClassName()}return BX.create("div",{attrs:{title:this.getName()},props:{className:u},style:{left:r+"px",top:o+"px",width:s+"px"},events:a,text:s>30?this.getName():""})}};return e}();