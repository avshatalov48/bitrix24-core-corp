this.BX=this.BX||{};this.BX.Tasks=this.BX.Tasks||{};(function(e,t,n,s){"use strict";var r=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e.setEventNamespace("BX.Tasks.Scrum.DodSidePanel");e.sidePanelManager=BX.SidePanel.Instance;e.BX=window.top.BX;e.bindEvents();return e}babelHelpers.createClass(t,[{key:"bindEvents",value:function e(){var t=this;this.BX.addCustomEvent(window.top,"SidePanel.Slider:onLoad",function(e){var n=e.getSlider();n.setCacheable(false);t.emit("onLoadSidePanel",n)});this.BX.addCustomEvent(window.top,"SidePanel.Slider:onClose",function(e){var n=e.getSlider();t.emit("onCloseSidePanel",n)})}},{key:"isPreviousSidePanelExist",value:function e(t){return Boolean(this.sidePanelManager.getPreviousSlider(t))}},{key:"reloadTopSidePanel",value:function e(){this.sidePanelManager.getTopSlider().reload()}},{key:"closeTopSidePanel",value:function e(){this.sidePanelManager.getTopSlider().close()}},{key:"reloadPreviousSidePanel",value:function e(t){var n=this.sidePanelManager.getPreviousSlider(t);n.reload()}},{key:"openSidePanelByUrl",value:function e(t){this.sidePanelManager.open(t)}},{key:"openSidePanel",value:function e(t,n){this.sidePanelManager.open(t,n)}}]);return t}(t.EventEmitter);var i=function(){function e(){babelHelpers.classCallCheck(this,e);this.BX=window.top.BX}babelHelpers.createClass(e,[{key:"sendRequest",value:function e(t){var n=this;var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};return new Promise(function(e,r){n.BX.ajax.runAction("bitrix:tasks.scrum.service.definitionOfDoneService."+t,{data:s}).then(e,r)})}},{key:"getListComponent",value:function e(t){return this.sendRequest("getItemComponent",t)}},{key:"getListOptions",value:function e(t){return this.sendRequest("getListOptions",t)}},{key:"getListButtons",value:function e(){return this.sendRequest("getTaskCompleteButtons")}},{key:"saveList",value:function e(t){return this.sendRequest("saveList",t)}},{key:"showErrorAlert",value:function e(t,r){if(n.Type.isUndefined(t.errors)){console.log(t);return}if(t.errors.length){var i=t.errors.shift();if(i){var a=i.code?i.code:"";var o=i.message+" "+a;var u=r?r:n.Loc.getMessage("TASKS_SCRUM_ERROR_TITLE_POPUP");s.MessageBox.alert(o,u)}}}}]);return e}();function a(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-alert ui-alert-danger">\n\t\t\t\t<span class="ui-alert-message">\n\t\t\t\t\t',"\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t"]);a=function t(){return e};return e}function o(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="tasks-scrum-project-side-panel">\n\t\t\t\t<div class="tasks-scrum-project-side-panel-header">\n\t\t\t\t\t<span class="tasks-scrum-project-side-panel-header-title">\n\t\t\t\t\t\t','\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="tasks-scrum-project-dod-error"></div>\n\t\t\t\t<div class="tasks-scrum-project-dod-list"></div>\n\t\t\t\t<div class="tasks-scrum-project-side-panel-buttons"></div>\n\t\t\t</div>\n\t\t']);o=function t(){return e};return e}var u=function(){function e(t){babelHelpers.classCallCheck(this,e);this.groupId=parseInt(t.groupId,10);this.sidePanel=new r;this.requestSender=new i}babelHelpers.createClass(e,[{key:"showList",value:function e(t){var s=this;return this.getListOptions().then(function(e){if(s.isRequiredToggle(e)){s.sidePanelId="tasks-scrum-dod-"+n.Text.getRandom();s.taskId=t;s.sidePanel.subscribeOnce("onLoadSidePanel",s.onLoadList.bind(s));s.sidePanel.openSidePanel(s.sidePanelId,{contentCallback:function e(){return new Promise(function(e,t){e(s.buildList())})},zIndex:1e3});return new Promise(function(e,t){s.resolver=e;s.rejecter=t})}else{return new Promise(function(e){e()})}})}},{key:"buildList",value:function e(){return n.Tag.render(o(),n.Loc.getMessage("TASKS_SCRUM_DOD_HEADER"))}},{key:"onLoadList",value:function e(t){var s=this;var r=t.getData();this.form=r.getContainer().querySelector(".tasks-scrum-project-side-panel");this.getListComponent().then(function(e){var t=s.form.querySelector(".tasks-scrum-project-dod-list");n.Runtime.html(t,e.html)}).then(function(){s.getListButtons().then(function(e){var t=s.form.querySelector(".tasks-scrum-project-side-panel-buttons");n.Runtime.html(t,e.html).then(function(){n.Event.bind(t.querySelector("[name=save]"),"click",s.onCompleteClick.bind(s,r));n.Event.bind(t.querySelector("[name=cancel]"),"click",s.onCancelClick.bind(s,r))})})})}},{key:"getListComponent",value:function e(){var t=this;return new Promise(function(e,n){t.requestSender.getListComponent({groupId:t.groupId,taskId:t.taskId}).then(function(t){e(t.data)})})}},{key:"getListOptions",value:function e(){var t=this;return new Promise(function(e,n){t.requestSender.getListOptions({groupId:t.groupId}).then(function(t){e(t.data)})})}},{key:"getListButtons",value:function e(){var t=this;return new Promise(function(e,n){t.requestSender.getListButtons().then(function(t){e(t.data)})})}},{key:"saveList",value:function e(){var t=this;return new Promise(function(e,n){t.requestSender.saveList(t.getRequestDataForSaveList()).then(function(t){e(t.data)}).catch(function(e){n(e)})})}},{key:"getRequestDataForSaveList",value:function e(){var t={};t.taskId=this.taskId;t.items=this.getListItems();return t}},{key:"getListItems",value:function e(){if(typeof BX.Tasks.CheckListInstance==="undefined"){return[]}var t=BX.Tasks.CheckListInstance.getTreeStructure();return t.getRequestData()}},{key:"onCompleteClick",value:function e(t){var n=this;if(this.isAllToggled()){this.saveList().then(function(e){t.close();n.resolver()})}else{this.removeClockIconFromButton();this.showError(this.getErrorContainer())}}},{key:"onCancelClick",value:function e(t){t.close()}},{key:"showError",value:function e(t){n.Dom.clean(this.form.querySelector(".tasks-scrum-project-dod-error"));n.Dom.append(t,this.form.querySelector(".tasks-scrum-project-dod-error"));this.form.querySelector(".tasks-scrum-project-side-panel-header").scrollIntoView(true)}},{key:"getErrorContainer",value:function e(){return n.Tag.render(a(),n.Loc.getMessage("TASKS_SCRUM_ERROR_ALL_TOGGLED"))}},{key:"isAllToggled",value:function e(){if(typeof BX.Tasks.CheckListInstance==="undefined"){return false}var e=true;var t=BX.Tasks.CheckListInstance.getTreeStructure();t.getDescendants().forEach(function(t){if(!t.checkIsComplete()){e=false}});return e}},{key:"isRequiredToggle",value:function e(t){return t.requiredOption==="Y"}},{key:"removeClockIconFromButton",value:function e(){var t=this.form.querySelector(".tasks-scrum-project-side-panel-buttons");if(t){n.Dom.removeClass(t.querySelector("[name=save]"),"ui-btn-wait")}}}]);return e}();e.ScrumDod=u})(this.BX.Tasks.Scrum=this.BX.Tasks.Scrum||{},BX.Event,BX,BX.UI.Dialogs);
//# sourceMappingURL=scrum.dod.bundle.map.js