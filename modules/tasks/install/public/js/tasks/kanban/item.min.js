(function(){"use strict";BX.namespace("BX.Tasks.Kanban");BX.Tasks.Kanban.Item=function(t){BX.Kanban.Item.apply(this,arguments);this.container=null;this.timer=null};BX.Tasks.Kanban.Item.prototype={__proto__:BX.Kanban.Item.prototype,constructor:BX.Tasks.Kanban.Item,dateFormats:{short:{en:"F j",de:"j. F",ru:"j F"},full:{en:"F j, Y",de:"j. F Y",ru:"j F Y"}},renderTime:function(t,e){var s=parseInt(t,10);var a=Math.floor(s/3600);var i=Math.floor((s-a*3600)/60);var n=s-a*3600-i*60;e=typeof e==="undefined"?true:e;if(a<10){a="0"+a}if(i<10){i="0"+i}if(n<10){n="0"+n}return a+":"+i+(e?":"+n:"")},clipTitle:function(t){var e=t;var s=e.split(" ");var a="<span>"+s[s.length-1]+"</span>";s.splice(s.length-1);e=s.join(" ")+" "+a;return e},setDataKey:function(t,e){var s=this.getData();s[t]=e},getDataKey:function(t){var e=this.getData();return e[t]},getDeadline:function(){return this.date_deadline.innerText},setStatus:function(t){var e=this.getData();BX.show(this.task_complete);BX.show(this.task_status_title);BX.style(this.task_status_title,"display","inline-block");BX.removeClass(this.task_status_title,"tasks-kanban-item-blue");BX.removeClass(this.task_status_title,"tasks-kanban-item-gray");BX.removeClass(this.task_status_title,"tasks-kanban-item-red");BX.removeClass(this.task_status_title,"tasks-kanban-item-white-blue");this.setDataKey("status",t);if(t==="deferred"){BX.addClass(this.task_status_title,"tasks-kanban-item-blue");this.task_status_title.textContent=BX.message("TASKS_KANBAN_STATUS_DEFERRED")}else if(t==="completed"||t==="completed_supposedly"){BX.hide(this.task_complete);BX.addClass(this.task_status_title,"tasks-kanban-item-gray");if(t==="completed_supposedly"){this.task_status_title.textContent=BX.message("TASKS_KANBAN_STATUS_COMPLETED_SUPPOSEDLY")}else{this.task_status_title.textContent=BX.message("TASKS_KANBAN_STATUS_COMPLETED")}}else if(t==="overdue"){BX.addClass(this.task_status_title,"tasks-kanban-item-red");this.task_status_title.textContent=BX.message("TASKS_KANBAN_STATUS_OVERDUE")}else if(t==="in_progress"){this.task_status_title.textContent=BX.message("TASKS_KANBAN_STATUS_PROGRESS")}else if(t==="pause"){this.task_status_title.textContent=BX.message("TASKS_KANBAN_STATUS_PAUSE")}else if(t==="new"){BX.addClass(this.task_status_title,"tasks-kanban-item-white-blue");this.task_status_title.textContent=BX.message("TASKS_KANBAN_STATUS_NEW")}else{BX.hide(this.task_status_title)}if(e.in_progress&&!BX.hasClass(this.task_start,"tasks-kanban-task-pause")){BX.addClass(this.task_start,"tasks-kanban-task-pause");this.task_start.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_PAUSE"))}else if(!e.in_progress){BX.removeClass(this.task_start,"tasks-kanban-task-pause");this.task_start.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_START"))}},startTask:function(){var t=this.getId();var e=this.getData();var s=e.in_progress?"pauseTask":"startTask";if(e.allow_time_tracking&&e.time_tracking){if(s==="startTask"){BX.TasksTimerManager.start(t)}else{BX.TasksTimerManager.stop(t)}}if(!e.allow_time_tracking||!e.time_tracking||s==="pauseTask"){this.getGrid().ajax({action:s,taskId:t},function(t){if(t&&!t.error){this.getGrid().updateItem(this.getId(),t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))}},completeTask:function(){var t=this.getDataKey("status");this.setStatus("completed");this.getGrid().ajax({action:"completeTask",taskId:this.getId(),columnId:this.getColumnId()},function(e){if(e&&!e.error){this.getGrid().updateItem(this.getId(),e)}else if(e){this.setStatus(t);BX.Kanban.Utils.showErrorDialog(e.error,e.fatal)}}.bind(this),function(e){this.setStatus(t);BX.Kanban.Utils.showErrorDialog("Error: "+e,true)}.bind(this))},deadlineTask:function(){var t=this.getData();var e=BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME"));BX.calendar({node:BX.proxy_context,bTime:true,currentTime:t.date_deadline?BX.date.format(e,t.date_deadline):BX.date.format(e,t.date_day_end),callback:function(t){this.getGrid().ajax({action:"deadlineTask",taskId:this.getId(),deadline:BX.date.format(e,t),columnId:this.getColumnId()},function(t){if(t&&!t.error){this.getGrid().updateItem(t.id,t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))}.bind(this)})},changeAuthorTask:function(){this.changeMemberTask("changeAuthorTask")},delegateTask:function(){this.changeMemberTask("delegateTask")},changeMemberTask:function(t){var e=this.getData();var s=new BX.Tasks.Integration.Socialnetwork.NetworkSelector({scope:BX.proxy_context,id:t+"-"+this.getId(),mode:"user",query:false,useSearch:true,useAdd:false,parent:this,popupOffsetTop:5,popupOffsetLeft:40});s.bindEvent("item-selected",BX.delegate(function(e){var a=this.getGridData();this.getGrid().ajax({action:t,taskId:this.getId(),columnId:this.getColumnId(),userId:e.id},function(t){if(t&&!t.error){this.getGrid().updateItem(t.id,t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this));s.close()},this));s.open()},getTaskUrl:function(t){return this.getGridData().pathToTask.replace("#task_id#",t)},switchClass:function(t,e,s){if(s){BX.addClass(t,e)}else{BX.removeClass(t,e)}},switchVisible:function(t,e){if(e){t.style.display=""}else{BX.hide(t)}},setFilterTag:function(){var t=BX.proxy_context.textContent.substr(1),e=this.getGridData(),s=BX.Main.filterManager.getById(e.gridId),a=s.getApi(),i=s.getFilterFieldsValues();i.TAG=t;a.setFields(i);a.apply()},render:function(){if(!this.container){this.createLayout()}var t=this.getData();var e=this.getColumn().getColor();var s=BX.util.hex2rgb(e);var a="rgba("+s.r+","+s.g+","+s.b+","+".7)";var i=t.completed||!t.allow_complete&&!t.allow_start;var n=BX.message("LANGUAGE_ID");if(n!=="en"&&n!=="de"){n="ru"}BX.style(this.container,"border-left","3px solid "+a);if(t.background){BX.style(this.containerImg,"background-image","url('"+t.background+"')");this.containerImg.setAttribute("href",this.getTaskUrl(this.getId()))}this.switchVisible(this.containerImg,t.background);this.link.innerHTML=this.clipTitle(t.name);this.link.setAttribute("href",this.getTaskUrl(this.getId()));this.switchClass(this.link,"tasks-kanban-item-title-hot",t.high);if(t.tags&&t.tags.length>0){BX.cleanNode(this.tags);for(var r=0,o=t.tags.length;r<o;r++){this.tag=BX.create("span",{text:"#"+t.tags[r],events:{click:BX.delegate(function(t){this.setFilterTag();t.stopPropagation()},this)}});this.tags.appendChild(this.tag)}}this.switchClass(this.date_deadline,"tasks-kanban-item-deadline",t.date_deadline||t.allow_change_deadline);this.switchClass(this.date_deadline,"tasks-kanban-item-set-deadline",t.allow_change_deadline&&!t.date_deadline);this.switchClass(this.date_deadline,"tasks-kanban-item-pointer",t.allow_change_deadline);this.date_deadline.setAttribute("title",BX.message(t.date_deadline?"TASKS_KANBAN_TITLE_DEADLINE":"TASKS_KANBAN_TITLE_DEADLINE_SET"));if(t.date_deadline||t.allow_change_deadline){BX.bind(this.date_deadline,"click",BX.delegate(function(t){this.deadlineTask();t.stopPropagation()},this))}else{BX.unbind(this.date_deadline,"click",BX.delegate(function(t){this.deadlineTask();t.stopPropagation()},this))}if(t.date_deadline){var l=new Date(t.date_deadline*1e3).getFullYear()===(new Date).getFullYear()?this.dateFormats["short"][n]:this.dateFormats["full"][n];t.overdue=Date.now()>t.date_deadline*1e3;this.date_deadline.textContent=BX.date.format(l,t.date_deadline)}else{this.date_deadline.textContent=""}if(t.deferred){this.setStatus("deferred")}else if(t.completed){this.setStatus("completed")}else if(t.completed_supposedly){this.setStatus("completed_supposedly")}else if(t.overdue){this.setStatus("overdue")}else if(t.in_progress){this.setStatus("in_progress")}else if(t.date_start){this.setStatus("pause")}else if(t.new){this.setStatus("new")}else{this.setStatus("")}this.switchVisible(this.task_content,t.count_comments>0||t.count_files>0||t.check_list.complete!==0||t.check_list.work!==0);this.switchVisible(this.count_comments,t.count_comments>0);this.switchClass(this.count_comments,"tasks-kanban-item-super-blue",t.log.comment>0);this.count_comments.setAttribute("href",this.getTaskUrl(this.getId())+"#updates");this.count_comments.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_COMMENTS").replace("#count#",t.count_comments));this.count_comments.textContent=t.log.comment>0?"+"+t.log.comment:t.count_comments;this.switchVisible(this.check_list,t.check_list.complete!==0||t.check_list.work!==0);this.switchClass(this.check_list,"tasks-kanban-item-super-blue",t.log.checklist>0);this.check_list.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_CHECKLIST").replace("#complete#",t.check_list.complete).replace("#all#",parseInt(t.check_list.complete)+parseInt(t.check_list.work)));this.check_list.textContent=t.log.checklist>0?"+"+t.log.checklist:t.check_list.complete+"/"+(+t.check_list.complete+ +t.check_list.work);this.switchVisible(this.count_files,t.count_files>0);this.switchClass(this.count_files,"tasks-kanban-item-super-blue",t.log.file>0);this.count_files.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_FILES").replace("#count#",t.count_files));this.count_files.textContent=t.log.file>0?"+"+t.log.file:t.count_files;if(t.author){if(this.author){BX.remove(this.author)}this.author=BX.create("div",{props:{className:"tasks-kanban-item-author",style:"cursor: pointer"}});var h;if(t.author.extranet){h="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-extranet"}else if(t.author.crm){h="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-crm"}else if(t.author.mail){h="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-mail"}else{h="tasks-kanban-item-author-avatar"}var c;!t.author.photo?c=" tasks-kanban-item-author-avatar-empty":c="";this.author.appendChild(BX.create("div",{props:{title:t.author.name,className:h+c},style:{backgroundImage:t.author.photo?"url('"+t.author.photo.src+"')":"",cursor:t.allow_edit?"pointer":"default"},events:{click:t.allow_edit?BX.delegate(function(t){this.changeAuthorTask();t.stopPropagation()},this):function(){}}}));this.user_container.appendChild(this.author)}if(t.responsible){if(this.responsible){BX.remove(this.responsible)}this.responsible=BX.create("div",{props:{className:"tasks-kanban-item-responsible",style:"cursor: pointer"}});var d;if(t.responsible.extranet){d="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-extranet"}else if(t.responsible.crm){d="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-crm"}else if(t.responsible.mail){d="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-mail"}else{d="tasks-kanban-item-author-avatar"}this.responsible.appendChild(BX.create("div",{props:{title:t.responsible.name,className:d},style:{backgroundImage:t.responsible.photo?"url('"+t.responsible.photo.src+"')":"",cursor:t.allow_delegate?"pointer":"default"},events:{click:t.allow_delegate?BX.delegate(function(t){this.delegateTask();t.stopPropagation()},this):function(){}}}));this.user_container.appendChild(this.responsible)}this.switchVisible(this.time_logs,t.time_tracking);if(t.time_tracking){this.time_logs.textContent=parseInt(t.time_estimate)>0?this.renderTime(t.time_logs)+" / "+this.renderTime(t.time_estimate,false):this.renderTime(t.time_logs)}else{this.time_logs.textContent=""}this.switchClass(this.container,"tasks-kanban-item-without-control",i);this.switchVisible(this.track_control,!i);this.switchVisible(this.task_start,t.allow_start);this.switchVisible(this.task_complete,t.allow_complete);return this.container},createLayout:function(){var t=this.getData();this.container=BX.create("div",{props:{className:"tasks-kanban-item"},events:{click:function(){if(typeof BX.Bitrix24!=="undefined"&&typeof BX.Bitrix24.PageSlider!=="undefined"){BX.Bitrix24.PageSlider.open(this.getTaskUrl(this.getId()))}}.bind(this)}});this.link=BX.create("a",{props:{className:"tasks-kanban-item-title"}});this.container.appendChild(this.link);this.tags=BX.create("span",{props:{className:"tasks-kanban-item-tags"}});this.container.appendChild(this.tags);this.containerImg=BX.create("a",{props:{className:"tasks-kanban-item-image"}});this.container.appendChild(this.containerImg);this.task_status=BX.create("div",{props:{className:"tasks-kanban-item-task-status"}});this.container.appendChild(this.task_status);this.date_deadline=BX.create("div",{props:{title:BX.message("TASKS_KANBAN_TITLE_DEADLINE")}});this.task_status.appendChild(this.date_deadline);this.task_status_title=BX.create("div",{props:{className:"tasks-kanban-item-status"}});this.task_status.appendChild(this.task_status_title);this.task_content=BX.create("div",{props:{className:"tasks-kanban-item-info"}});this.container.appendChild(this.task_content);this.count_comments=BX.create("a",{props:{className:"tasks-kanban-item-comments"},events:{click:function(t){t.stopPropagation()}}});this.task_content.appendChild(this.count_comments);this.check_list=BX.create("div",{props:{className:"tasks-kanban-item-checklist"}});this.task_content.appendChild(this.check_list);this.count_files=BX.create("div",{props:{className:"tasks-kanban-item-files"}});this.task_content.appendChild(this.count_files);this.user_container=BX.create("div",{props:{className:"tasks-kanban-item-users"}});this.container.appendChild(this.user_container);this.time_logs=BX.create("div",{props:{className:"tasks-kanban-item-timelogs"}});this.container.appendChild(this.time_logs);this.track_control=BX.create("div",{props:{className:"tasks-kanban-item-control"}});this.container.appendChild(this.track_control);this.task_start=BX.create("div",{props:{className:"tasks-kanban-task-start"},events:{click:function(t){this.startTask();t.stopPropagation()}.bind(this)}});this.track_control.appendChild(this.task_start);this.task_complete=BX.create("div",{props:{className:"tasks-kanban-task-complete",title:BX.message("TASKS_KANBAN_TITLE_COMPLETE")},events:{click:function(t){this.completeTask();t.stopPropagation()}.bind(this)}});this.track_control.appendChild(this.task_complete);this.container.appendChild(this.createShadow());this.container.addEventListener("mouseenter",function(){this.addHoverClass(this.container)}.bind(this));this.container.addEventListener("mouseleave",function(){this.removeHoverClass(this.container)}.bind(this),false)},createShadow:function(){return BX.create("div",{props:{className:"tasks-kanban-item-shadow"}})},addHoverClass:function(t){this.timer=setTimeout(function(){t.classList.add("tasks-kanban-item-hover")},150)},removeHoverClass:function(t){clearTimeout(this.timer);t.classList.remove("tasks-kanban-item-hover")}}})();
//# sourceMappingURL=item.map.js