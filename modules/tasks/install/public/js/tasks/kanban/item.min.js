(function(){"use strict";BX.namespace("BX.Tasks.Kanban");BX.Tasks.Kanban.Item=function(t){BX.Kanban.Item.apply(this,arguments);this.container=null;this.timer=null;this.isSprintView=t.isSprintView==="Y";this.networkEnabled=t.networkEnabled||false;this.storyPoints=this.data.storyPoints?this.data.storyPoints:"";this.calendarSettings=t.calendarSettings?t.calendarSettings:{}};BX.Tasks.Kanban.Item.prototype={__proto__:BX.Kanban.Item.prototype,constructor:BX.Tasks.Kanban.Item,dateFormats:{short:{en:"F j",de:"j. F",ru:"j F"},full:{en:"F j, Y",de:"j. F Y",ru:"j F Y"}},renderTime:function(t,e){var s=parseInt(t,10);var a=Math.floor(s/3600);var i=Math.floor((s-a*3600)/60);var n=s-a*3600-i*60;e=typeof e==="undefined"?true:e;if(a<10){a="0"+a}if(i<10){i="0"+i}if(n<10){n="0"+n}return a+":"+i+(e?":"+n:"")},clipTitle:function(t){var e=t;var s=e.split(" ");var a="<span>"+s[s.length-1]+"</span>";s.splice(s.length-1);e=s.join(" ")+" "+a;return e},setDataKey:function(t,e){var s=this.getData();s[t]=e},getDataKey:function(t){var e=this.getData();return e[t]},getDeadline:function(){return this.deadlineNotificationDate},setStatus:function(t){var e=this.getData();if(this.task_complete){BX.show(this.task_complete)}BX.show(this.task_status_title);BX.style(this.task_status_title,"display","inline-block");BX.removeClass(this.task_status_title,"tasks-kanban-item-blue");BX.removeClass(this.task_status_title,"tasks-kanban-item-gray");BX.removeClass(this.task_status_title,"tasks-kanban-item-red");BX.removeClass(this.task_status_title,"tasks-kanban-item-white-blue");this.setDataKey("status",t);if(t==="completed"){if(this.task_complete){BX.hide(this.task_complete)}BX.addClass(this.task_status_title,"tasks-kanban-item-gray");this.task_status_title.textContent=BX.message("TASKS_KANBAN_STATUS_COMPLETED")}else{BX.hide(this.task_status_title)}if(this.task_start&&e.in_progress&&!BX.hasClass(this.task_start,"tasks-kanban-task-pause")){BX.addClass(this.task_start,"tasks-kanban-task-pause");this.task_start.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_PAUSE"))}else if(this.task_start&&!e.in_progress){BX.removeClass(this.task_start,"tasks-kanban-task-pause");this.task_start.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_START"))}if(this.task_mute&&e.muted&&!BX.hasClass(this.task_mute,"tasks-kanban-task-muted")){BX.addClass(this.container,"tasks-kanban-task-muted");this.task_mute.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_UNMUTE"));this.task_counter.setColor(BX.UI.Counter.Color.GRAY)}else if(this.task_mute&&!e.muted){var s=e.is_expired&&!e.completed&&!e.completed_supposedly;BX.removeClass(this.container,"tasks-kanban-task-muted");this.task_mute.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_MUTE"));this.task_counter.setColor(s?BX.UI.Counter.Color.DANGER:BX.UI.Counter.Color.SUCCESS)}},muteTask:function(){var t=this.getId();var e=this.getData();var s=e.muted?"unmuteTask":"muteTask";this.getGrid().ajax({action:s,taskId:t},function(t){if(t&&!t.error){this.getGrid().updateItem(this.getId(),t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},startTask:function(){var t=this.getId();var e=this.getData();var s=e.in_progress?"pauseTask":"startTask";if(e.allow_time_tracking&&e.time_tracking){if(s==="startTask"){BX.TasksTimerManager.start(t)}else{BX.TasksTimerManager.stop(t)}}if(!e.allow_time_tracking||!e.time_tracking||s==="pauseTask"){this.getGrid().ajax({action:s,taskId:t},function(t){if(t&&!t.error){this.getGrid().updateItem(this.getId(),t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))}},completeTask:function(){var t=this.getDataKey("status");this.setStatus("completed");this.getGrid().ajax({action:"completeTask",taskId:this.getId(),columnId:this.getColumnId()},function(e){if(e&&!e.error){this.getGrid().updateItem(this.getId(),e)}else if(e){this.setStatus(t);BX.Kanban.Utils.showErrorDialog(e.error,e.fatal)}}.bind(this),function(e){this.setStatus(t);BX.Kanban.Utils.showErrorDialog("Error: "+e,true)}.bind(this))},deadlineTask:function(){var t=this.getData();var e=BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME"));var s=BX.date.format(e,t.date_deadline||t.date_day_end);var a=BX.calendar({node:BX.proxy_context,value:s,currentTime:s,bTime:true,bCompatibility:true,bCategoryTimeVisibilityOption:"tasks.bx.calendar.deadline",bTimeVisibility:this.calendarSettings?this.calendarSettings.deadlineTimeVisibility==="Y":false,callback:function(t){this.getGrid().ajax({action:"deadlineTask",taskId:this.getId(),deadline:BX.date.format(e,t),columnId:this.getColumnId()},function(t){if(t&&!t.error){this.getGrid().updateItem(t.id,t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))}.bind(this),callback_after:function(t){BX.onCustomEvent(this.getGrid(),"Tasks.Kanban.Item:deadlineChanged",{value:t})}.bind(this)});BX.onCustomEvent(this.getGrid(),"Tasks.Kanban.Item:deadlineChangeClick",{calendar:a,itemId:t.id})},changeAuthorTask:function(){this.changeMemberTask("changeAuthorTask")},delegateTask:function(){this.changeMemberTask("delegateTask")},changeMemberTask:function(t){var e=this.getData();var s=this.responsible;var a=e.responsible.id;var i="R";if(t==="changeAuthorTask"){s=this.author;a=e.author.id;i="O"}BX.loadExt("ui.entity-selector").then(function(){var n=new BX.UI.EntitySelector.Dialog({targetNode:s,enableSearch:true,multiple:false,context:"KANBAN_RESPONSIBLE_SELECTOR_"+t+e.id,preselectedItems:[["user",a]],undeselectedItems:[["user",a]],entities:[{id:"user",options:{emailUsers:true,networkUsers:this.networkEnabled,extranetUsers:true,inviteGuestLink:true,myEmailUsers:true}},{id:"department"}],events:{"Item:onSelect":function(e){var s=e.getData().item;var a=this.prepareUserData(s,i);this.getGrid().ajax({action:t,taskId:this.getId(),columnId:this.getColumnId(),userId:a.id},function(t){if(t&&!t.error){this.getGrid().updateItem(t.id,t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))}.bind(this)}});n.show()}.bind(this))},prepareUserData:function(t,e){var s=t.getCustomData();var a=t.getEntityType();return{avatar:t.avatar,description:"",entityType:e,id:t.getId(),name:s.get("name"),lastName:s.get("lastName"),email:s.get("email"),nameFormatted:BX.Text.encode(t.getTitle()),networkId:"",type:{crmemail:false,extranet:a==="extranet",email:a==="email",network:a==="network"}}},getTaskUrl:function(t){return this.getGridData().pathToTask.replace("#task_id#",t)},getStoryPoints:function(){return this.storyPoints},switchClass:function(t,e,s){if(s){BX.addClass(t,e)}else{BX.removeClass(t,e)}},switchVisible:function(t,e){if(e){t.style.display=""}else{BX.hide(t)}},onDragDrop:function(t,e,s){if(this.selectable&&this.getGrid().getSelectedItems().size>1){return this.onDragDropMultiple()}this.hideDragTarget();var a=this.getGrid().getItemByElement(t);var i=new BX.Kanban.DragEvent;i.setItem(a);i.setTargetColumn(this.getColumn());i.setTargetItem(this);BX.onCustomEvent(this.getGrid(),"Kanban.Grid:onBeforeItemMoved",[i]);if(!i.isActionAllowed()){return}var n=new BX.Promise;if(this.isSprintView&&this.getColumn().isFinishType()&&!a.getColumn().isFinishType()){if(typeof BX.Tasks.Scrum==="undefined"||typeof BX.Tasks.Scrum.ScrumDod==="undefined"){n.fulfill()}this.scrumDod=new BX.Tasks.Scrum.ScrumDod({groupId:this.getData()["groupId"]});this.scrumDod.showList(a.getId()).then(function(){n.fulfill()}.bind(this)).catch(function(){n.reject()}.bind(this))}else{n.fulfill()}n.then(function(){var t=this.getGrid().moveItem(a,this.getColumn(),this);if(t){BX.onCustomEvent(this.getGrid(),"Kanban.Grid:onItemMoved",[a,this.getColumn(),this])}}.bind(this))},setFilterTag:function(){var t=BX.proxy_context.textContent.substr(1),e=this.getGridData(),s=BX.Main.filterManager.getById(e.gridId),a=s.getApi(),i=s.getFilterFieldsValues();i.TAG=t;a.setFields(i);a.apply()},render:function(){if(!this.container){this.createLayout()}var t=this.getData();var e=this.getColumn().getColor();var s=BX.util.hex2rgb(e);var a="rgba("+s.r+","+s.g+","+s.b+","+".7)";var i=t.completed||!t.allow_complete&&!t.allow_start;var n=BX.message("LANGUAGE_ID");if(n!=="en"&&n!=="de"){n="ru"}BX.style(this.container,"border-left","3px solid "+a);if(t.background){BX.style(this.containerImg,"background-image","url('"+t.background+"')");this.containerImg.setAttribute("href",this.getTaskUrl(this.getId()))}this.switchVisible(this.containerImg,t.background);this.link.innerHTML=this.clipTitle(t.name);this.link.setAttribute("href",this.getTaskUrl(this.getId()));this.switchClass(this.link,"tasks-kanban-item-title-hot",t.high);if(t.tags&&t.tags.length>0){BX.cleanNode(this.tags);for(var r=0,o=t.tags.length;r<o;r++){this.tag=BX.create("span",{props:{className:"ui-label ui-label-tag-light ui-label-fill ui-label-sm ui-label-link"},children:[BX.create("span",{props:{className:"ui-label-inner"},text:"#"+t.tags[r],events:{click:BX.delegate(function(t){this.setFilterTag();t.stopPropagation()},this)}})]});this.tags.appendChild(this.tag)}}this.switchClass(this.date_deadline_container,"tasks-kanban-item-pointer",t.allow_change_deadline);if(t.allow_change_deadline){BX.bind(this.date_deadline_container,"click",BX.delegate(function(t){this.deadlineTask();t.stopPropagation()},this))}else{BX.unbind(this.date_deadline_container,"click",BX.delegate(function(t){this.deadlineTask();t.stopPropagation()},this))}if(!this.isSprintView){if(t.date_deadline||t.deferred||t.completed_supposedly){this.deadlineNotificationDate=t.deadline.value.replace("&minus;","-");this.date_deadline.setText(this.deadlineNotificationDate);this.date_deadline.setFill(t.deadline.fill);this.date_deadline.setColor(t.deadline.color)}else{this.deadlineNotificationDate="";this.date_deadline.setText(BX.message("TASKS_KANBAN_NO_DATE"));this.date_deadline.setFill(false);this.date_deadline.setColor(BX.UI.Label.LIGHT)}this.date_deadline.setCustomClass("tasks-kanban-item-deadline")}if(t.deferred){this.setStatus("deferred")}else if(t.completed){this.setStatus("completed")}else if(t.completed_supposedly){this.setStatus("completed_supposedly")}else if(t.overdue){this.setStatus("overdue")}else if(t.in_progress){this.setStatus("in_progress")}else if(t.date_start){this.setStatus("pause")}else if(t.new){this.setStatus("new")}else{this.setStatus("")}this.switchVisible(this.task_content,t.count_files>0||t.check_list.complete!==0||t.check_list.work!==0);if(t.counter.value>0){this.task_counter.setColor(t.counter.color);if(Number(this.task_counter.getValue())!==Number(t.counter.value)){this.task_counter.update(t.counter.value)}}this.switchVisible(this.task_counter_container,t.counter.value>0);this.switchVisible(this.check_list,t.check_list.complete!==0||t.check_list.work!==0);this.switchClass(this.check_list,"tasks-kanban-item-super-blue",t.log.checklist>0);this.check_list.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_CHECKLIST").replace("#complete#",t.check_list.complete).replace("#all#",parseInt(t.check_list.complete)+parseInt(t.check_list.work)));this.check_list.textContent=t.log.checklist>0?"+"+t.log.checklist:t.check_list.complete+"/"+(+t.check_list.complete+ +t.check_list.work);this.switchVisible(this.count_files,t.count_files>0);this.switchClass(this.count_files,"tasks-kanban-item-super-blue",t.log.file>0);this.count_files.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_FILES").replace("#count#",t.count_files));this.count_files.textContent=t.log.file>0?"+"+t.log.file:t.count_files;if(!this.isSprintView&&t.author){if(this.author){BX.remove(this.author)}this.author=BX.create("div",{props:{className:"tasks-kanban-item-author",style:"cursor: pointer"}});var l;if(t.author.extranet){l="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-extranet"}else if(t.author.crm){l="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-crm"}else if(t.author.mail){l="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-mail"}else{l="tasks-kanban-item-author-avatar"}var h;!t.author.photo?h=" tasks-kanban-item-author-avatar-empty":h="";this.author.appendChild(BX.create("div",{props:{title:t.author.name,className:l+h},style:{backgroundImage:t.author.photo?"url('"+t.author.photo.src+"')":"",cursor:t.allow_edit?"pointer":"default"},events:{click:t.allow_edit?BX.delegate(function(t){this.changeAuthorTask();t.stopPropagation()},this):function(){}}}));this.user_container.appendChild(this.author)}if(t.responsible){if(this.responsible){BX.remove(this.responsible)}var c=this.isSprintView?"tasks-kanban-item-responsible-sprint":"tasks-kanban-item-responsible";this.responsible=BX.create("div",{props:{className:c,style:"cursor: pointer"}});var d;if(t.responsible.extranet){d="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-extranet"}else if(t.responsible.crm){d="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-crm"}else if(t.responsible.mail){d="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-mail"}else{d="tasks-kanban-item-author-avatar"}this.responsible.appendChild(BX.create("div",{props:{title:t.responsible.name,className:d},style:{backgroundImage:t.responsible.photo?"url('"+t.responsible.photo.src+"')":"",cursor:t.allow_delegate?"pointer":"default"},events:{click:t.allow_delegate?BX.delegate(function(t){this.delegateTask();t.stopPropagation()},this):function(){}}}));this.user_container.appendChild(this.responsible)}this.switchVisible(this.time_logs,t.time_tracking);if(t.time_tracking){this.time_logs.textContent=parseInt(t.time_estimate)>0?this.renderTime(t.time_logs)+" / "+this.renderTime(t.time_estimate,false):this.renderTime(t.time_logs)}else{this.time_logs.textContent=""}this.switchClass(this.container,"tasks-kanban-item-without-control",i);if(this.task_start){this.switchVisible(this.task_start,!i);this.switchVisible(this.task_start,t.allow_start)}if(this.task_complete){this.switchVisible(this.task_complete,t.allow_complete)}return this.container},createLayout:function(){var t=this.getData();this.container=BX.create("div",{props:{className:"tasks-kanban-item"},events:{click:function(){if(typeof BX.Bitrix24!=="undefined"&&typeof BX.Bitrix24.PageSlider!=="undefined"){}}.bind(this)}});this.link=BX.create("a",{props:{className:t.counter.value>0?"tasks-kanban-item-title":"tasks-kanban-item-title tasks-kanban-item-title--with-counter"}});this.container.appendChild(this.link);this.tags=BX.create("span",{props:{className:"tasks-kanban-item-tags"}});this.container.appendChild(this.tags);this.task_status=BX.create("div",{props:{className:"tasks-kanban-item-task-status"}});this.container.appendChild(this.task_status);this.task_status_title=BX.create("div",{props:{className:"tasks-kanban-item-status"}});this.task_status.appendChild(this.task_status_title);this.containerImg=BX.create("a",{props:{className:"tasks-kanban-item-image"}});this.container.appendChild(this.containerImg);this.task_content=BX.create("div",{props:{className:"tasks-kanban-item-info"}});this.container.appendChild(this.task_content);if(!this.isSprintView){this.date_deadline=new BX.UI.Label({text:t.deadline.value.replace("&minus;","-"),color:t.deadline.color,fill:t.date_deadline?t.deadline.fill:false,size:BX.UI.Label.Size.SM});this.date_deadline_container=BX.create("div",{props:{className:"tasks-kanban-item-deadline"},children:[this.date_deadline.getContainer()]});this.container.appendChild(this.date_deadline_container)}this.check_list=BX.create("div",{props:{className:"tasks-kanban-item-checklist"}});this.task_content.appendChild(this.check_list);this.count_files=BX.create("div",{props:{className:"tasks-kanban-item-files"}});this.task_content.appendChild(this.count_files);this.actions_container=BX.create("div",{props:{className:"tasks-kanban-actions-container"}});this.container.appendChild(this.actions_container);this.user_container=BX.create("div",{props:{className:"tasks-kanban-item-users"}});this.actions_container.appendChild(this.user_container);this.time_logs=BX.create("div",{props:{className:"tasks-kanban-item-timelogs"}});this.actions_container.appendChild(this.time_logs);if(!this.getGrid().isScrumGrid()){this.track_control=BX.create("div",{props:{className:"tasks-kanban-item-control"}});this.container.appendChild(this.track_control);this.task_mute=BX.create("div",{props:{className:"tasks-kanban-task-mute"},events:{click:function(t){this.muteTask();t.stopPropagation()}.bind(this)}});this.track_control.appendChild(this.task_mute);this.task_start=BX.create("div",{props:{className:"tasks-kanban-task-start"},events:{click:function(t){this.startTask();t.stopPropagation()}.bind(this)}});this.track_control.appendChild(this.task_start);this.task_complete=BX.create("div",{props:{className:"tasks-kanban-task-complete",title:BX.message("TASKS_KANBAN_TITLE_COMPLETE")},events:{click:function(t){this.completeTask();t.stopPropagation()}.bind(this)}});this.track_control.appendChild(this.task_complete)}else{this.storyPointsNode=BX.create("div",{props:{className:"tasks-kanban-item-story-points",title:"Story Points"},text:this.getDataKey("storyPoints")});this.container.appendChild(this.storyPointsNode)}this.task_counter=new BX.UI.Counter({value:t.counter.value,color:t.counter.color,animate:true});this.task_counter_container=BX.create("div",{props:{className:"tasks-kanban-task-counter"},children:[this.task_counter.getContainer()]});this.container.appendChild(this.task_counter_container);this.container.appendChild(this.createShadow());this.container.addEventListener("mouseenter",function(){this.addHoverClass(this.container)}.bind(this));this.container.addEventListener("mouseleave",function(){this.removeHoverClass(this.container)}.bind(this),false)},createShadow:function(){return BX.create("div",{props:{className:"tasks-kanban-item-shadow"}})},getContainer:function(){if(this.layout.container!==null){return this.layout.container}this.layout.container=BX.create("div",{attrs:{className:"main-kanban-item","data-id":this.getId(),"data-type":"item"},children:[this.getDragTarget(),this.getBodyContainer()]});this.makeDraggable();this.makeDroppable();if(this.grid.firstRenderComplete&&!this.draftContainer){this.layout.container.classList.add("main-kanban-item-new");var t=function(){this.layout.container.classList.remove("main-kanban-item-new");this.getBodyContainer().removeEventListener("animationend",t)}.bind(this);this.getBodyContainer().addEventListener("animationend",t)}BX.addCustomEvent(this.getGrid(),"Kanban.Grid:onItemDragStart",function(){if(this.getGrid().isRealtimeMode()){this.disableDropping()}}.bind(this));BX.addCustomEvent(this.getGrid(),"Kanban.Grid:onItemDragStop",function(){if(this.getGrid().isRealtimeMode()){this.enableDropping()}}.bind(this));return this.layout.container},addHoverClass:function(t){this.timer=setTimeout(function(){t.classList.add("tasks-kanban-item-hover")},150)},removeHoverClass:function(t){clearTimeout(this.timer);t.classList.remove("tasks-kanban-item-hover")}}})();
//# sourceMappingURL=item.map.js