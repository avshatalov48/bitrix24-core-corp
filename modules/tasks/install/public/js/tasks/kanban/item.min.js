(function(){"use strict";BX.namespace("BX.Tasks.Kanban");BX.Tasks.Kanban.Item=function(t){BX.Kanban.Item.apply(this,arguments);this.container=null;this.timer=null};BX.Tasks.Kanban.Item.prototype={__proto__:BX.Kanban.Item.prototype,constructor:BX.Tasks.Kanban.Item,dateFormats:{short:{en:"F j",de:"j. F",ru:"j F"},full:{en:"F j, Y",de:"j. F Y",ru:"j F Y"}},renderTime:function(t,e){var s=parseInt(t,10);var a=Math.floor(s/3600);var i=Math.floor((s-a*3600)/60);var n=s-a*3600-i*60;e=typeof e==="undefined"?true:e;if(a<10){a="0"+a}if(i<10){i="0"+i}if(n<10){n="0"+n}return a+":"+i+(e?":"+n:"")},clipTitle:function(t){var e=t;var s=e.split(" ");var a="<span>"+s[s.length-1]+"</span>";s.splice(s.length-1);e=s.join(" ")+" "+a;return e},setDataKey:function(t,e){var s=this.getData();s[t]=e},getDataKey:function(t){var e=this.getData();return e[t]},getDeadline:function(){return this.deadlineNotificationDate},setStatus:function(t){var e=this.getData();BX.show(this.task_complete);BX.show(this.task_status_title);BX.style(this.task_status_title,"display","inline-block");BX.removeClass(this.task_status_title,"tasks-kanban-item-blue");BX.removeClass(this.task_status_title,"tasks-kanban-item-gray");BX.removeClass(this.task_status_title,"tasks-kanban-item-red");BX.removeClass(this.task_status_title,"tasks-kanban-item-white-blue");this.setDataKey("status",t);if(t==="completed"||t==="completed_supposedly"){BX.hide(this.task_complete);BX.addClass(this.task_status_title,"tasks-kanban-item-gray");if(t==="completed_supposedly"){this.task_status_title.textContent=BX.message("TASKS_KANBAN_STATUS_COMPLETED_SUPPOSEDLY")}else{this.task_status_title.textContent=BX.message("TASKS_KANBAN_STATUS_COMPLETED")}}else{BX.hide(this.task_status_title)}if(e.in_progress&&!BX.hasClass(this.task_start,"tasks-kanban-task-pause")){BX.addClass(this.task_start,"tasks-kanban-task-pause");this.task_start.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_PAUSE"))}else if(!e.in_progress){BX.removeClass(this.task_start,"tasks-kanban-task-pause");this.task_start.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_START"))}if(e.muted&&!BX.hasClass(this.task_mute,"tasks-kanban-task-muted")){BX.addClass(this.container,"tasks-kanban-task-muted");this.task_mute.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_UNMUTE"));this.task_counter.setColor(BX.UI.Counter.Color.GRAY)}else if(!e.muted){BX.removeClass(this.container,"tasks-kanban-task-muted");this.task_mute.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_MUTE"));this.task_counter.setColor(e.is_expired?BX.UI.Counter.Color.DANGER:BX.UI.Counter.Color.SUCCESS)}},muteTask:function(){var t=this.getId();var e=this.getData();var s=e.muted?"unmuteTask":"muteTask";this.getGrid().ajax({action:s,taskId:t},function(t){if(t&&!t.error){this.getGrid().updateItem(this.getId(),t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},startTask:function(){var t=this.getId();var e=this.getData();var s=e.in_progress?"pauseTask":"startTask";if(e.allow_time_tracking&&e.time_tracking){if(s==="startTask"){BX.TasksTimerManager.start(t)}else{BX.TasksTimerManager.stop(t)}}if(!e.allow_time_tracking||!e.time_tracking||s==="pauseTask"){this.getGrid().ajax({action:s,taskId:t},function(t){if(t&&!t.error){this.getGrid().updateItem(this.getId(),t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))}},completeTask:function(){var t=this.getDataKey("status");this.setStatus("completed");this.getGrid().ajax({action:"completeTask",taskId:this.getId(),columnId:this.getColumnId()},function(e){if(e&&!e.error){this.getGrid().updateItem(this.getId(),e)}else if(e){this.setStatus(t);BX.Kanban.Utils.showErrorDialog(e.error,e.fatal)}}.bind(this),function(e){this.setStatus(t);BX.Kanban.Utils.showErrorDialog("Error: "+e,true)}.bind(this))},deadlineTask:function(){var t=this.getData();var e=BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME"));var s=BX.date.format(e,t.date_deadline||t.date_day_end);BX.calendar({node:BX.proxy_context,value:s,currentTime:s,bTime:true,callback:function(t){this.getGrid().ajax({action:"deadlineTask",taskId:this.getId(),deadline:BX.date.format(e,t),columnId:this.getColumnId()},function(t){if(t&&!t.error){this.getGrid().updateItem(t.id,t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))}.bind(this)})},changeAuthorTask:function(){this.changeMemberTask("changeAuthorTask")},delegateTask:function(){this.changeMemberTask("delegateTask")},changeMemberTask:function(t){var e=this.getData();var s=new BX.Tasks.Integration.Socialnetwork.NetworkSelector({scope:BX.proxy_context,id:t+"-"+this.getId(),mode:"user",query:false,useSearch:true,useAdd:false,parent:this,popupOffsetTop:5,popupOffsetLeft:40});s.bindEvent("item-selected",BX.delegate(function(e){var a=this.getGridData();this.getGrid().ajax({action:t,taskId:this.getId(),columnId:this.getColumnId(),userId:e.id},function(t){if(t&&!t.error){this.getGrid().updateItem(t.id,t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this));s.close()},this));s.open()},getTaskUrl:function(t){return this.getGridData().pathToTask.replace("#task_id#",t)},switchClass:function(t,e,s){if(s){BX.addClass(t,e)}else{BX.removeClass(t,e)}},switchVisible:function(t,e){if(e){t.style.display=""}else{BX.hide(t)}},setFilterTag:function(){var t=BX.proxy_context.textContent.substr(1),e=this.getGridData(),s=BX.Main.filterManager.getById(e.gridId),a=s.getApi(),i=s.getFilterFieldsValues();i.TAG=t;a.setFields(i);a.apply()},render:function(){if(!this.container){this.createLayout()}var t=this.getData();var e=this.getColumn().getColor();var s=BX.util.hex2rgb(e);var a="rgba("+s.r+","+s.g+","+s.b+","+".7)";var i=t.completed||!t.allow_complete&&!t.allow_start;var n=BX.message("LANGUAGE_ID");if(n!=="en"&&n!=="de"){n="ru"}BX.style(this.container,"border-left","3px solid "+a);if(t.background){BX.style(this.containerImg,"background-image","url('"+t.background+"')");this.containerImg.setAttribute("href",this.getTaskUrl(this.getId()))}this.switchVisible(this.containerImg,t.background);this.link.innerHTML=this.clipTitle(t.name);this.link.setAttribute("href",this.getTaskUrl(this.getId()));this.switchClass(this.link,"tasks-kanban-item-title-hot",t.high);if(t.tags&&t.tags.length>0){BX.cleanNode(this.tags);for(var r=0,o=t.tags.length;r<o;r++){this.tag=BX.create("span",{props:{className:"ui-label ui-label-tag-light ui-label-fill ui-label-sm ui-label-link"},children:[BX.create("span",{props:{className:"ui-label-inner"},text:"#"+t.tags[r],events:{click:BX.delegate(function(t){this.setFilterTag();t.stopPropagation()},this)}})]});this.tags.appendChild(this.tag)}}this.switchClass(this.date_deadline_container,"tasks-kanban-item-pointer",t.allow_change_deadline);if(t.allow_change_deadline){BX.bind(this.date_deadline_container,"click",BX.delegate(function(t){this.deadlineTask();t.stopPropagation()},this))}else{BX.unbind(this.date_deadline_container,"click",BX.delegate(function(t){this.deadlineTask();t.stopPropagation()},this))}this.deadlineNotificationDate=t.date_deadline?t.deadline.value.replace("&minus;","-"):"";if(t.deferred){this.setStatus("deferred")}else if(t.completed){this.setStatus("completed")}else if(t.completed_supposedly){this.setStatus("completed_supposedly")}else if(t.overdue){this.setStatus("overdue")}else if(t.in_progress){this.setStatus("in_progress")}else if(t.date_start){this.setStatus("pause")}else if(t.new){this.setStatus("new")}else{this.setStatus("")}this.switchVisible(this.task_content,t.count_files>0||t.check_list.complete!==0||t.check_list.work!==0);this.switchVisible(this.task_counter_container,t.counter.value>0);this.switchVisible(this.check_list,t.check_list.complete!==0||t.check_list.work!==0);this.switchClass(this.check_list,"tasks-kanban-item-super-blue",t.log.checklist>0);this.check_list.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_CHECKLIST").replace("#complete#",t.check_list.complete).replace("#all#",parseInt(t.check_list.complete)+parseInt(t.check_list.work)));this.check_list.textContent=t.log.checklist>0?"+"+t.log.checklist:t.check_list.complete+"/"+(+t.check_list.complete+ +t.check_list.work);this.switchVisible(this.count_files,t.count_files>0);this.switchClass(this.count_files,"tasks-kanban-item-super-blue",t.log.file>0);this.count_files.setAttribute("title",BX.message("TASKS_KANBAN_TITLE_FILES").replace("#count#",t.count_files));this.count_files.textContent=t.log.file>0?"+"+t.log.file:t.count_files;if(t.author){if(this.author){BX.remove(this.author)}this.author=BX.create("div",{props:{className:"tasks-kanban-item-author",style:"cursor: pointer"}});var l;if(t.author.extranet){l="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-extranet"}else if(t.author.crm){l="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-crm"}else if(t.author.mail){l="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-mail"}else{l="tasks-kanban-item-author-avatar"}var h;!t.author.photo?h=" tasks-kanban-item-author-avatar-empty":h="";this.author.appendChild(BX.create("div",{props:{title:t.author.name,className:l+h},style:{backgroundImage:t.author.photo?"url('"+t.author.photo.src+"')":"",cursor:t.allow_edit?"pointer":"default"},events:{click:t.allow_edit?BX.delegate(function(t){this.changeAuthorTask();t.stopPropagation()},this):function(){}}}));this.user_container.appendChild(this.author)}if(t.responsible){if(this.responsible){BX.remove(this.responsible)}this.responsible=BX.create("div",{props:{className:"tasks-kanban-item-responsible",style:"cursor: pointer"}});var c;if(t.responsible.extranet){c="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-extranet"}else if(t.responsible.crm){c="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-crm"}else if(t.responsible.mail){c="tasks-kanban-item-author-avatar tasks-kanban-item-author-avatar-mail"}else{c="tasks-kanban-item-author-avatar"}this.responsible.appendChild(BX.create("div",{props:{title:t.responsible.name,className:c},style:{backgroundImage:t.responsible.photo?"url('"+t.responsible.photo.src+"')":"",cursor:t.allow_delegate?"pointer":"default"},events:{click:t.allow_delegate?BX.delegate(function(t){this.delegateTask();t.stopPropagation()},this):function(){}}}));this.user_container.appendChild(this.responsible)}this.switchVisible(this.time_logs,t.time_tracking);if(t.time_tracking){this.time_logs.textContent=parseInt(t.time_estimate)>0?this.renderTime(t.time_logs)+" / "+this.renderTime(t.time_estimate,false):this.renderTime(t.time_logs)}else{this.time_logs.textContent=""}this.switchClass(this.container,"tasks-kanban-item-without-control",i);this.switchVisible(this.task_start,!i);this.switchVisible(this.task_start,t.allow_start);this.switchVisible(this.task_complete,t.allow_complete);return this.container},createLayout:function(){var t=this.getData();this.container=BX.create("div",{props:{className:"tasks-kanban-item"},events:{click:function(){if(typeof BX.Bitrix24!=="undefined"&&typeof BX.Bitrix24.PageSlider!=="undefined"){}}.bind(this)}});this.link=BX.create("a",{props:{className:t.counter.value>0?"tasks-kanban-item-title":"tasks-kanban-item-title tasks-kanban-item-title--with-counter"}});this.container.appendChild(this.link);this.tags=BX.create("span",{props:{className:"tasks-kanban-item-tags"}});this.container.appendChild(this.tags);this.task_status=BX.create("div",{props:{className:"tasks-kanban-item-task-status"}});this.container.appendChild(this.task_status);this.task_status_title=BX.create("div",{props:{className:"tasks-kanban-item-status"}});this.task_status.appendChild(this.task_status_title);this.containerImg=BX.create("a",{props:{className:"tasks-kanban-item-image"}});this.container.appendChild(this.containerImg);this.task_content=BX.create("div",{props:{className:"tasks-kanban-item-info"}});this.container.appendChild(this.task_content);this.date_deadline=new BX.UI.Label({text:t.deadline.value.replace("&minus;","-"),color:t.deadline.color,fill:t.date_deadline?t.deadline.fill:false,size:BX.UI.Label.Size.SM});this.date_deadline_container=BX.create("div",{props:{className:"tasks-kanban-item-deadline"},children:[this.date_deadline.getContainer()]});this.container.appendChild(this.date_deadline_container);this.check_list=BX.create("div",{props:{className:"tasks-kanban-item-checklist"}});this.task_content.appendChild(this.check_list);this.count_files=BX.create("div",{props:{className:"tasks-kanban-item-files"}});this.task_content.appendChild(this.count_files);this.actions_container=BX.create("div",{props:{className:"tasks-kanban-actions-container"}});this.container.appendChild(this.actions_container);this.user_container=BX.create("div",{props:{className:"tasks-kanban-item-users"}});this.actions_container.appendChild(this.user_container);this.time_logs=BX.create("div",{props:{className:"tasks-kanban-item-timelogs"}});this.actions_container.appendChild(this.time_logs);this.track_control=BX.create("div",{props:{className:"tasks-kanban-item-control"}});this.container.appendChild(this.track_control);this.task_mute=BX.create("div",{props:{className:"tasks-kanban-task-mute"},events:{click:function(t){this.muteTask();t.stopPropagation()}.bind(this)}});this.track_control.appendChild(this.task_mute);this.task_start=BX.create("div",{props:{className:"tasks-kanban-task-start"},events:{click:function(t){this.startTask();t.stopPropagation()}.bind(this)}});this.track_control.appendChild(this.task_start);if(this.getGrid().isMultiSelect()){this.task_check=BX.create("div",{props:{className:"tasks-kanban-item-checkbox"},events:{click:function(){this.checked=!this.checked;this.checked?BX.addClass(this.checkedButton,"tasks-kanban-item-checkbox-checked"):BX.removeClass(this.checkedButton,"tasks-kanban-item-checkbox-checked")}.bind(this)}});this.container.appendChild(this.task_check)}this.task_complete=BX.create("div",{props:{className:"tasks-kanban-task-complete",title:BX.message("TASKS_KANBAN_TITLE_COMPLETE")},events:{click:function(t){this.completeTask();t.stopPropagation()}.bind(this)}});this.track_control.appendChild(this.task_complete);this.task_counter=new BX.UI.Counter({value:t.counter.value,color:t.counter.color,animate:true});this.task_counter_container=BX.create("div",{props:{className:"tasks-kanban-task-counter"},children:[this.task_counter.getContainer()]});this.container.appendChild(this.task_counter_container);this.container.appendChild(this.createShadow());this.container.addEventListener("mouseenter",function(){this.addHoverClass(this.container)}.bind(this));this.container.addEventListener("mouseleave",function(){this.removeHoverClass(this.container)}.bind(this),false)},createShadow:function(){return BX.create("div",{props:{className:"tasks-kanban-item-shadow"}})},getContainer:function(){if(this.layout.container!==null){return this.layout.container}this.layout.container=BX.create("div",{attrs:{className:this.grid.firstRenderComplete?"main-kanban-item main-kanban-item-new":"main-kanban-item","data-id":this.getId(),"data-type":"item"},children:[this.getDragTarget(),this.getBodyContainer()],events:{click:this.handleClick.bind(this)}});this.makeDraggable();this.makeDroppable();BX.addCustomEvent("Kanban.Grid:onItemDragStart",function(){if(this.getGrid().isRealtimeMode()){this.disableDropping()}}.bind(this));BX.addCustomEvent("Kanban.Grid:onItemDragStop",function(){if(this.getGrid().isRealtimeMode()){this.enableDropping()}}.bind(this));return this.layout.container},addHoverClass:function(t){this.timer=setTimeout(function(){t.classList.add("tasks-kanban-item-hover")},150)},removeHoverClass:function(t){clearTimeout(this.timer);t.classList.remove("tasks-kanban-item-hover")}}})();
//# sourceMappingURL=item.map.js