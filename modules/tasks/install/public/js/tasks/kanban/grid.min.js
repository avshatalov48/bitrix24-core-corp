(function(){"use strict";BX.namespace("BX.Tasks.Kanban");BX.Tasks.Kanban.Grid=function(t){BX.Kanban.Grid.apply(this,arguments);BX.addCustomEvent(this,"Kanban.Grid:onItemMoved",BX.delegate(this.onItemMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onItemAddedAsync",BX.delegate(this.onItemAddedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnMoved",BX.delegate(this.onColumnMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnUpdated",BX.delegate(this.onColumnUpdated,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnLoadAsync",BX.delegate(this.onColumnLoadAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnRemovedAsync",BX.delegate(this.onColumnRemovedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnAddedAsync",BX.delegate(this.onColumnAddedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onRender",BX.delegate(this.onGridRender,this));BX.addCustomEvent("BX.Main.Filter:apply",BX.delegate(this.onApplyFilter,this));BX.addCustomEvent("onTaskTimerChange",BX.delegate(this.onTaskTimerChange,this));BX.addCustomEvent("onTasksGroupSelectorChange",BX.delegate(this.onTasksGroupSelectorChange,this));BX.addCustomEvent("onTaskSortChanged",BX.delegate(this.onTaskSortChanged,this));BX.addCustomEvent("tasksTaskEvent",BX.delegate(this.tasksTaskEvent,this));BX.addCustomEvent("onPullEvent-im",BX.delegate(this.tasksTaskPull,this))};BX.Tasks.Kanban.Grid.prototype={__proto__:BX.Kanban.Grid.prototype,constructor:BX.Tasks.Kanban.Grid,accessNotifyDialog:null,ajax:function(t,e,a){var n=this.getAjaxHandlerPath();var i=this.getData();t.sessid=BX.bitrix_sessid();t.params=this.getData().params;if(t.action!=="undefined"){n+=n.indexOf("?")===-1?"?":"&";n+="action="+t.action;if(i.kanbanType==="TL"){n+="&timeline=Y"}else{n+="&personal="+t.params.PERSONAL}}BX.ajax({method:"POST",dataType:"json",url:n,data:t,onsuccess:e,onfailure:a})},accessNotify:function(){if(typeof BX.Intranet!=="undefined"&&typeof BX.Intranet.NotifyDialog!=="undefined"){if(this.accessNotifyDialog===null){this.accessNotifyDialog=new BX.Intranet.NotifyDialog({listUserData:[],notificationHandlerUrl:this.getAjaxHandlerPath()+"?action=notifyAdmin",popupTexts:{sendButton:BX.message("TASKS_KANBAN_NOTIFY_BUTTON"),title:BX.message("TASKS_KANBAN_NOTIFY_TITLE"),header:BX.message("TASKS_KANBAN_NOTIFY_HEADER"),description:BX.message("TASKS_KANBAN_NOTIFY_TEXT")}})}this.accessNotifyDialog.setUsersForNotify(this.getData().admins);this.accessNotifyDialog.show()}},onItemDragStart:function(t){this.setDragMode(BX.Kanban.DragMode.ITEM);var e=this.getData();var a=t.getData();if(e.kanbanType==="TL"){BX.Kanban.Grid.prototype.onItemDragStart.apply(this,arguments);this.getColumns().forEach(function(e){if(!e.canAddItems()){e.disableDropping()}else if(!a.allow_change_deadline&&e.getId()!==t.getColumn().getId()){e.disableDropping()}});var n=this.getItems();for(var i in n){if(n[i].getColumn().getId()!==t.getColumn().getId()){if(!a.allow_change_deadline||!n[i].getColumn().canAddItems()){n[i].disableDropping()}}}if(!a.allow_change_deadline){t.getDragElement().appendChild(this.createAlertBlock(BX.message("TASKS_KANBAN_ME_DISABLE_DEADLINE_PART2")))}return}if(!e.rights.canSortItem){return}BX.Kanban.Grid.prototype.onItemDragStart.apply(this,arguments)},createAlertBlock:function(t){return BX.create("div",{props:{className:"tasks-kanban-item-alert"},text:t})},addItemOrder:function(t){var e=this.getData();var a=this.getColumn(t.columnId);var n=a?a.getItems():[];if(e.newTaskOrder==="desc"){if(n.length>0){t.targetId=n[0].getId()}this.addItem(t)}else if(n.length>=a.total){this.addItem(t)}},updateItem:function(t,e,a){if(a!==true&&BX.Bitrix24&&BX.Bitrix24.Slider&&BX.Bitrix24.Slider.destroy){var n=this.getItem(t).getTaskUrl(t);BX.Bitrix24.Slider.destroy(n)}BX.Kanban.Grid.prototype.updateItem.apply(this,arguments)},onItemAddedAsync:function(t){t.push(BX.delegate(this.addTask,this))},onColumnLoadAsync:function(t){t.push(BX.delegate(this.getColumnItems,this))},onColumnRemovedAsync:function(t){t.push(BX.delegate(this.removeStage,this))},onColumnAddedAsync:function(t){t.push(BX.delegate(this.addStage,this))},getColumnItems:function(t){var e=new BX.Promise;this.ajax({action:"getColumnItems",pageId:t.getPagination().getPage()+1,columnId:t.getId()},function(t){if(t&&(BX.type.isArray(t)||BX.type.isArray(t.items))&&!t.error){e.fulfill(BX.type.isArray(t)?t:t.items)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal);e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},removeStage:function(t){var e=new BX.Promise;this.ajax({action:"modifyColumn",fields:{id:t.getId(),delete:1}},function(t){if(t&&!t.error){e.fulfill()}else if(t){e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},addStage:function(t){var e=new BX.Promise;var a=this.getPreviousColumnSibling(t);var n=a?a.getId():0;this.ajax({action:"modifyColumn",fields:{columnName:t.getName(),columnColor:t.getColor(),afterColumnId:n}},function(t){if(t&&!t.error){e.fulfill(t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal);e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},addTask:function(t){var e=new BX.Promise;var a=t.getColumn().getNextItemSibling(t);this.ajax({action:"addTask",taskName:t.getData().title,columnId:t.getColumn().getId(),beforeItemId:a?a.getId():0},function(t){if(t&&!t.error){e.fulfill(t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal);e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},onItemMoved:function(t,e,a){var n=t.getId();var i=0;var r=a?a.getId():0;var o=e?e.getId():0;var s=this.getData();if(r===0){i=e.getPreviousItemSibling(t);if(i){i=i.getId()}}this.ajax({action:"moveTask",itemId:n,columnId:o,beforeItemId:r,afterItemId:i},function(e){if(e&&!e.error){this.updateItem(n,e);if(s.kanbanType==="TL"){var a=t.getDeadline();BX.UI.Notification.Center.notify({content:a?BX.message("MAIN_KANBAN_NOTIFY_CHANGE_DEADLINE").replace("#date#",a):BX.message("MAIN_KANBAN_NOTIFY_REMOVE_DEADLINE")})}if(typeof e.data!=="undefined"&&e.data.hiddenByFilter===true){this.removeItem(t)}}else if(e){BX.Kanban.Utils.showErrorDialog(e.error,true)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},onColumnMoved:function(t,e){var a=t.getId();var n=this.getPreviousColumnSibling(t);var i=n?n.getId():0;this.ajax({action:"moveColumn",columnId:a,afterColumnId:i},function(t){if(t&&t.error){BX.Kanban.Utils.showErrorDialog(t.error,true)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},onColumnUpdated:function(t){var e=t.getId();var a=t.getName();var n=t.getColor();this.ajax({action:"modifyColumn",fields:{id:e,columnName:a,columnColor:n}},function(t){if(t&&t.error){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},getAjaxHandlerPath:function(){var t=this.getData();return BX.type.isNotEmptyString(t.ajaxHandlerPath)?t.ajaxHandlerPath:"/bitrix/components/bitrix/tasks.kanban/ajax.php"},onApplyFilter:function(t,e,a,n,i){this.fadeOut();i.autoResolve=false;this.ajax({action:"applyFilter"},function(t){this.removeItems();this.loadData(t);n.fulfill();this.fadeIn()}.bind(this),function(t){n.reject();this.fadeIn()}.bind(this))},onTaskTimerChange:function(t){if(t.taskId&&t.action==="refresh_daemon_event"&&t.data&&t.data.TIMER&&t.data.TIMER.TIMER_STARTED_AT){var e=this.getItem(t.taskId);var a=Math.floor(Date.now()/1e3);var n=parseInt(a-t.data.TIMER.TIMER_STARTED_AT);if(e){e.setDataKey("time_logs",e.getData().time_logs_start+n);e.setDataKey("in_progress",true);e.render()}}},onTasksGroupSelectorChange:function(t){var e=this.getData();e.params.GROUP_ID=t.id;if(t.sprintId){e.params.SPRINT_ID=t.sprintId}this.setData(e);var a=this.getColumns();for(var n=0,i=a.length;n<i;n++){this.removeColumn(a[n])}this.ajax({action:"changeGroup"},function(t){e.admins=t.admins;e.newTaskOrder=t.newTaskOrder;e.rights.canAddColumn=t.canAddColumn;e.rights.canEditColumn=t.canEditColumn;e.rights.canRemoveColumn=t.canRemoveColumn;e.rights.canAddItem=t.canAddItem;e.rights.canSortItem=t.canSortItem;this.setData(e);t.canAddColumn=true;t.canEditColumn=true;this.removeItems();this.loadData(t);BX.onCustomEvent(this,"onKanbanChanged",[t])}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},onTaskSortChanged:function(t){var e=this.getData();e.newTaskOrder=t.newTaskOrder;this.setData(e)},tasksTaskEvent:function(t,e){if(!(e&&e.task&&e.task.ID)){return}var a=e.task.ID;if(t==="DELETE"){this.removeItem(a)}else if(t==="UPDATE"||t==="ADD"||t==="UPDATE_STAGE"){var n=this.getItem(a);var i=this.getColumns();var r=n?n.getColumnId():i[0].getId();if(typeof e.task.STAGE_ID!=="undefined"){r=e.task.STAGE_ID}if(n||t==="ADD"){this.ajax({action:"refreshTask",taskId:a,columnId:r},function(e){if(e&&!e.error){if(t==="UPDATE_STAGE"){this.removeItem(a)}if(t==="ADD"||t==="UPDATE_STAGE"){this.addItemOrder(e)}else{this.updateItem(e.id,e,true)}}}.bind(this),function(t){}.bind(this))}}},tasksTaskPull:function(t,e){if(t==="notify"){var a=e.params?e.params:{};if(a.operation==="ADD"&&a.taskId){this.ajax({action:"newTask",taskId:a.taskId},function(t){if(t&&!t.error){this.addItemOrder(t)}}.bind(this),function(t){}.bind(this))}}},onGridRender:function(){var t=this.getGridContainer();var e=this.getColumns().reduce(function(t,e){return t+e.getContainer().offsetWidth},0);var a=e+80<t.offsetWidth;this.getRenderToContainer().classList[a?"add":"remove"]("tasks-kanban-border")},changeDemoView:function(t){var e=this.getColumns();for(var a=0,n=e.length;a<n;a++){this.removeColumn(e[a])}this.ajax({action:"changeDemoView",viewId:t},function(t){this.loadData(t)}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))}}})();
//# sourceMappingURL=grid.map.js