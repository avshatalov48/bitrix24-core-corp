(function(){"use strict";BX.namespace("BX.Tasks.Kanban");BX.Tasks.Kanban.Grid=function(t){this.ownerId=Number(t.ownerId);this.groupId=Number(t.groupId);this.groupingMode=Boolean(t.isGroupingMode);this.isSprintView=t.isSprintView==="Y";this.networkEnabled=t.networkEnabled||false;this.gridHeader=Boolean(t.gridHeader);this.parentTaskId=parseInt(t.parentTaskId,10);this.parentTaskName=t.parentTaskName;this.parentTaskCompleted=Boolean(t.parentTaskCompleted);this.neighborGrids=[];this.delayedQueueForChildGrid={};this.isBindEvents=false;BX.Kanban.Grid.apply(this,arguments);BX.addCustomEvent(this,"Kanban.Grid:onItemMoved",BX.delegate(this.onItemMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onItemAddedAsync",BX.delegate(this.onItemAddedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnMoved",BX.delegate(this.onColumnMoved,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnUpdated",BX.delegate(this.onColumnUpdated,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnLoadAsync",BX.delegate(this.onColumnLoadAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnRemovedAsync",BX.delegate(this.onColumnRemovedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnAddedAsync",BX.delegate(this.onColumnAddedAsync,this));BX.addCustomEvent(this,"Kanban.Grid:onRender",BX.delegate(this.onRender,this));BX.addCustomEvent(this,"Kanban.Grid:onRender",BX.delegate(this.onGridRender,this));BX.addCustomEvent("BX.Main.Filter:apply",BX.delegate(this.onApplyFilter,this));BX.addCustomEvent("onTaskTimerChange",BX.delegate(this.onTaskTimerChange,this));BX.addCustomEvent("onTaskSortChanged",BX.delegate(this.onTaskSortChanged,this));BX.addCustomEvent(this,"Kanban.Grid:multiSelectModeOn",BX.delegate(this.startActionPanel,this));BX.addCustomEvent(this,"Kanban.Grid:multiSelectModeOff",BX.delegate(this.stopActionPanel,this));BX.addCustomEvent(this,"Kanban.Grid:selectItem",BX.delegate(this.setTotalSelectedItems,this));BX.addCustomEvent(this,"Kanban.Grid:unSelectItem",BX.delegate(this.setTotalSelectedItems,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStart",BX.delegate(this.setKanbanDragMode,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStop",BX.delegate(this.unSetKanbanDragMode,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStart",BX.delegate(this.setKanbanRealtimeMode,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStop",BX.delegate(this.unSetKanbanRealtimeMode,this));if(this.isScrumGrid()){BX.bind(this.getGridContainer(),"scroll",BX.delegate(this.onGridScroll,this))}this.bindEvents();this.subscribeToTasksPull()};BX.Tasks.Kanban.Grid.prototype={__proto__:BX.Kanban.Grid.prototype,constructor:BX.Tasks.Kanban.Grid,accessNotifyDialog:null,ajax:function(t,e,i){var n=this.getAjaxHandlerPath();var a=this.getData();t.sessid=BX.bitrix_sessid();t.params=this.getData().params;if(t.action!=="undefined"){n+=n.indexOf("?")===-1?"?":"&";n+="action="+t.action;if(a.kanbanType==="TL"){n+="&timeline=Y"}else{n+="&personal="+t.params.PERSONAL}if(t.groupAction==="Y"){n+="&groupMode=Y"}}BX.ajax({method:"POST",dataType:"json",url:n,data:t,onsuccess:e,onfailure:i})},bindEvents:function(){if(!this.isBindEvents){BX.Event.EventEmitter.subscribe("tasks-kanban-settings-fields-view",function(){this.showFieldsSelectPopup()}.bind(this));this.isBindEvents=true}},subscribeToTasksPull(){const t={comment_read_all:this.onPullCommentReadAll,tag_changed:this.onPullTagChanged};const e={comment_add:this.onPullCommentAdd,stage_change:this.onPullStageChange,task_add:this.onPullTaskAdd,task_update:this.onPullTaskUpdate,task_view:this.onPullTaskView,task_remove:this.onPullTaskRemove};const i=this.isScrumGrid()?this.getData().params.IS_COMPLETED_SPRINT==="Y":false;if(i){return}const n={pull:new BX.Tasks.Runtime.DebouncedQueue({timeout:3e3,events:{onCommitAsync:t=>{this.getTaskDataFromQueueCollection(t.getData().poolItems,(t=>{n.event.push(t)}))}}}),event:new BX.Tasks.Runtime.DebouncedQueue({timeout:100,events:{onCommitAsync:t=>{this.emitHandlersFromQueueCollection(t.getData().poolItems,(t=>{const i=t.command;const n=t.params;const a=t.taskId;const s=t.taskData;if(e[i]){e[i].apply(this,[n,a,s])}}))}}})};BX.addCustomEvent("onPullEvent-tasks",((e,i)=>{if(this.isScrumGridHeader()){return}if(t[e]){t[e].apply(this,[i])}else{const t=this.resolveIdByEventParams(e,i);if(t>0){n.pull.push({id:t,params:i},e)}}}))},resolveIdByEventParams(t,e){const i=["comment_add","stage_change","task_add","task_update","task_view","task_remove"];if(i.includes(t)){const i=this.recognizeTaskId(e);if(i>0){return i}else{throw new Error(`taskId is not resolved for command: ${t}`)}}return 0},getTaskDataFromQueueCollection(t,e){const i=new Map;const n=this.getTaskIdsFromQueueCollection(t);const a=this.getData().params;BX.ajax.runAction("tasks.task.list",{data:{filter:{ID:n},params:{RETURN_ACCESS:"Y",SIFT_THROUGH_FILTER:{sprintKanban:this.isScrumGrid()?"Y":"N",isCompletedSprint:this.isScrumGrid()?a.IS_COMPLETED_SPRINT:"N",userId:this.ownerId,groupId:this.groupId}},start:-1}}).then((a=>{const s=[];if(a.data.tasks.length>0){a.data.tasks.forEach((t=>{s.push(parseInt(t["id"],10))}))}this.ajax({action:"refreshListTasks",taskIds:s,isScrum:this.isScrumGrid()?"Y":"N",parentId:this.getParentTaskId()},(a=>{if(BX.type.isArray(a)){a.forEach((t=>{i.set(parseInt(t["id"],10),t)}))}n.forEach((t=>{if(!i.has(t)){i.set(t,null)}}));e({params:{poolItems:t,listTaskData:i}})}),(t=>{}))}))},emitHandlersFromQueueCollection(t,e){const i=[];Object.keys(t).forEach((e=>{const n=t[e];const a=n["default"].fields.params.poolItems;const s=n["default"].fields.params.listTaskData;Object.keys(a).forEach((t=>{const e=a[t];const[n]=Object.values(e);const o=n.fields.params;const r=this.recognizeTaskId(o);const d=s.get(r);i.push({poolItem:e,taskId:r,taskData:d})}))}));const n=Object.values(i);for(let t in n){if(!n.hasOwnProperty(t)){continue}const i=n[t];const{poolItem:a,taskId:s,taskData:o}=i;const[r]=Object.values(a);const[d]=Object.keys(a);const l=r.fields.params;e({command:d,params:l,taskId:s,taskData:o})}},getTaskIdsFromQueueCollection(t){const e=[];try{for(let i in t){if(!t.hasOwnProperty(i)){continue}let[n]=Object.keys(t[i]);let[a]=Object.values(t[i]);let s=a.fields.id;if(e.includes(s)===false){e.push(s)}}}catch(t){}return e},showFieldsSelectPopup:function(){var t=this.getData();const e=new BX.UI.CheckboxList({columnCount:3,lang:{title:t.customSectionsFields.title},sections:t.customSectionsFields.sections,categories:t.customSectionsFields.categories,options:t.customSectionsFields.options,events:{onApply:t=>{this.ajax({action:"saveUserSelectedFields",fields:t.data.fields},function(){this.onApplyFilter()}.bind(this))}}});e.show()},isRealtimeMode:function(){return this.data.newTaskOrder==="actual"},getGroupId:function(){return this.groupId},accessNotify:function(){if(typeof BX.Intranet!=="undefined"&&typeof BX.Intranet.NotifyDialog!=="undefined"){if(this.accessNotifyDialog===null){this.accessNotifyDialog=new BX.Intranet.NotifyDialog({listUserData:this.getData().admins,notificationHandlerUrl:this.getAjaxHandlerPath()+"?action=notifyAdmin",popupTexts:{sendButton:BX.message("TASKS_KANBAN_NOTIFY_BUTTON"),title:BX.message("TASKS_KANBAN_NOTIFY_TITLE"),header:BX.message("TASKS_KANBAN_NOTIFY_HEADER"),description:BX.message("TASKS_KANBAN_NOTIFY_TEXT")}})}this.accessNotifyDialog.show()}},renderLayout:function(){BX.Kanban.Grid.prototype.renderLayout.apply(this,arguments);if(this.isScrumGridHeader()){this.observeScrumGridHeader()}},onItemDragStart:function(t){this.setDragMode(BX.Kanban.DragMode.ITEM);var e=this.getData();var i=t.getData();if(e.kanbanType==="TL"){BX.Kanban.Grid.prototype.onItemDragStart.apply(this,arguments);this.getColumns().forEach((function(e){if(!e.canAddItems()){e.disableDropping()}else if(!i.allow_change_deadline&&e.getId()!==t.getColumn().getId()){e.disableDropping()}}));var n=this.getItems();for(var a in n){if(n[a].getColumn().getId()!==t.getColumn().getId()){if(!i.allow_change_deadline||!n[a].getColumn().canAddItems()){n[a].disableDropping()}}}if(!i.allow_change_deadline){t.getDragElement().appendChild(this.createAlertBlock(BX.message("TASKS_KANBAN_ME_DISABLE_DEADLINE_PART2")))}return}if(!e.rights.canSortItem){return}BX.Kanban.Grid.prototype.onItemDragStart.apply(this,arguments)},createAlertBlock:function(t){return BX.create("div",{props:{className:"tasks-kanban-item-alert"},text:t})},addItemOrder:function(t){var e=this.getData();var i=null;var n=[];if(!t.columnId&&t.columns){for(var a=0,s=t.columns.length;a<s;a++){i=this.getColumn(t.columns[a]);if(i){t.columnId=i.getId()}}}if(!t.columnId){i=this.getColumns()[0];t.columnId=i.getId()}if(t.columnId&&!i){i=this.getColumn(t.columnId);if(!i){i=this.getColumns()[0];t.columnId=i.getId()}}if(i){n=i.getItems()}if(e.newTaskOrder==="desc"||this.isRealtimeMode()){if(this.isRealtimeMode()&&n.length>0){if(typeof t.data["date_activity_ts"]!=="undefined"){var o=t.data["date_activity_ts"];if(o>0){for(var a=0,s=n.length;a<s;a++){if(t.id!==n[a].getId()&&n[a].data["date_activity_ts"]<o){t.targetId=n[a].getId();break}}}}}else if(n.length>0){t.targetId=n[0].getId();if(t.targetId===t.id&&n[1]){t.targetId=n[1].getId()}}if(this.isRealtimeMode()&&this.getItem(t.id)&&i&&!i.getDraftItem()){this.updateItem(t.id,t,true);if(t.targetId){this.moveItem(t.id,t.columnId,t.targetId)}}else{this.addItem(t)}}else if(i&&n.length>=i.total){this.addItem(t)}},updateItemState(t,e){if(e){this.addItemOrder(e)}else{if(this.hasItem(t)){this.removeItem(t)}}},updateItem:function(t,e,i){if(i!==true&&BX.Bitrix24&&BX.Bitrix24.Slider&&BX.Bitrix24.Slider.destroy&&this.getItem(t)){var n=this.getItem(t).getTaskUrl(t);BX.Bitrix24.Slider.destroy(n)}BX.Kanban.Grid.prototype.updateItem.apply(this,arguments)},removeItem:function(t){var e=BX.Kanban.Grid.prototype.removeItem.apply(this,arguments);BX.onCustomEvent(this,"Kanban.Grid:onItemRemoved",{itemId:t});return e},onItemAddedAsync:function(t){t.push(BX.delegate(this.addTask,this))},onColumnLoadAsync:function(t){t.push(BX.delegate(this.getColumnItems,this))},onColumnRemovedAsync:function(t){t.push(BX.delegate(this.removeStage,this))},onColumnAddedAsync:function(t){t.push(BX.delegate(this.addStage,this))},onRender:function(t){var e=t.getData();if(t.firstRenderComplete||e["kanbanType"]!=="TL"){return}if(e["setClientDate"]===true){var i=new BX.Promise;this.fadeOut();this.ajax({action:"setClientDate",clientDate:e["clientDate"],clientTime:e["clientTime"]},function(t){this.removeItems();this.loadData(t);i.fulfill();this.fadeIn()}.bind(this))}},getColumnItems:function(t){var e=new BX.Promise;if(this.isChildScrumGrid()){e.fulfill([]);return e}this.ajax({action:"getColumnItems",pageId:t.getPagination().getPage()+1,columnId:t.getId()},function(t){if(t&&(BX.type.isArray(t)||BX.type.isArray(t.items))&&!t.error){e.fulfill(BX.type.isArray(t)?t:t.items)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal);e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},removeStage:function(t){var e=new BX.Promise;this.ajax({action:"modifyColumn",fields:{id:t.getId(),delete:1}},function(t){if(t&&!t.error){this.actionPanel=null;e.fulfill()}else if(t){e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},addStage:function(t){var e=new BX.Promise;var i=this.getPreviousColumnSibling(t);var n=i?i.getId():0;this.ajax({action:"modifyColumn",fields:{columnName:t.getName(),columnColor:t.getColor(),afterColumnId:n}},function(t){if(t&&!t.error){this.actionPanel=null;e.fulfill(t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal);e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},addItem:function(t){if(this.isScrumGrid()){var e=this.getItemType(t.type);var i=new e(t);if(!(i instanceof BX.Kanban.Item)){throw new Error("Item type must be an instance of BX.Kanban.Item")}if(this.isChildScrumGrid()){if(i instanceof BX.Tasks.Kanban.Item&&i.isCompleted()===false){BX.onCustomEvent(this,"Kanban.Grid:onAddItemInProgress")}return BX.Kanban.Grid.prototype.addItem.apply(this,arguments)}t=t||{};var n=this.getColumn(t.columnId),a;if(!n){return null}if(t.hasOwnProperty("isSubTask")&&t.isSubTask){a=false;this.getNeighborGrids().forEach(function(e){if(!e.isScrumGridHeader()){if(e.isChildTask(t["parentId"])){e.addItem(t);delete this.delayedQueueForChildGrid[t["id"]];a=true}}}.bind(this));if(!a){this.delayedQueueForChildGrid[t["id"]]=t}}else if(t.hasOwnProperty("isParentTask")&&t.isParentTask){if(t.hasOwnProperty("isVisibilitySubtasks")&&t.isVisibilitySubtasks==="N"){return BX.Kanban.Grid.prototype.addItem.apply(this,arguments)}a=false;this.getNeighborGrids().forEach(function(e){if(!e.isScrumGridHeader()){if(e.isParentTask(t["id"])){a=true}}}.bind(this));if(!a){var s=[];this.getColumns().forEach(function(t){s.push({id:t.getId(),name:t.getName(),color:t.getColor(),total:t.getTotal()})}.bind(this));BX.onCustomEvent(this,"Kanban.Grid:onAddParentTask",{id:t.id,name:t.data.name,completed:t.data.completed?"Y":"N",storyPoints:t.data.storyPoints,columnId:t.columnId,columns:s,items:[]})}}else{return BX.Kanban.Grid.prototype.addItem.apply(this,arguments)}}else{return BX.Kanban.Grid.prototype.addItem.apply(this,arguments)}},addItemsFromQueue:function(){Object.values(this.delayedQueueForChildGrid).forEach(function(t){this.addItem(t)}.bind(this))},addTask:function(t){var e=new BX.Promise;var i=t.getColumn().getNextItemSibling(t);var n=this.getData();this.ajax({action:"addTask",taskName:t.getData().title,columnId:t.getColumn().getId(),parentTaskId:this.parentTaskId,beforeItemId:n.newTaskOrder==="desc"&&i?i.getId():0},function(t){if(t&&!t.error){e.fulfill(t)}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal);e.reject(t.error)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true);e.reject("Error: "+t)}.bind(this));return e},onItemMoved:function(t,e,i){var n=t.getId();var a=0;var s=i?i.getId():0;var o=e?e.getId():0;var r=this.getData();if(s===0){a=e.getPreviousItemSibling(t);if(a){a=a.getId()}}this.ajax({action:"moveTask",itemId:n,columnId:o,beforeItemId:s,afterItemId:a},function(e){if(e&&!e.error){this.updateItem(n,e);if(r.kanbanType==="TL"){var i=t.getDeadline();BX.UI.Notification.Center.notify({content:i?BX.message("MAIN_KANBAN_NOTIFY_CHANGE_DEADLINE").replace("#date#",i):BX.message("MAIN_KANBAN_NOTIFY_REMOVE_DEADLINE")})}if(typeof e.data!=="undefined"&&e.data.hiddenByFilter===true){this.removeItem(t)}if(this.isChildScrumGrid()){top.BX.loadExt("tasks.scrum.task-status").then(function(){if(!BX.type.isUndefined(top.BX.Tasks.Scrum)&&!BX.type.isUndefined(top.BX.Tasks.Scrum.TaskStatus)){this.taskStatus=new top.BX.Tasks.Scrum.TaskStatus({groupId:this.groupId,parentTaskId:this.parentTaskId,taskId:n,action:this.getFinishColumn().getId()===o?"complete":"renew"});this.taskStatus.update().then(function(t){var e=top.BX.Tasks.Scrum.TaskStatus.actions;switch(t){case e.complete:case e.renew:case e.proceed:this.updateParentTaskStatus(t);break;case e.skip:break}}.bind(this))}}.bind(this))}}else if(e){BX.Kanban.Utils.showErrorDialog(e.error,true)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},updateParentTaskStatus:function(t){if(t==="proceed"){this.ajax({action:"proceedParentTask",taskId:this.parentTaskId},function(t){this.addItemToParentGrid(t);var e=this.getItemFromParentGrid(this.parentTaskId);if(e){this.scrollToItem(e)}setTimeout(function(){BX.onCustomEvent(this,"Kanban.Grid:onProceedParentTask",[this])}.bind(this),300)}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))}else{var e=t==="complete";this.ajax({action:e?"completeParentTask":"renewParentTask",taskId:this.parentTaskId,finishColumnId:this.getFinishColumn().getId(),newColumnId:this.getNewColumn().getId()},function(t){if(t&&!t.error){if(e){this.parentTaskCompleted=true;BX.onCustomEvent(this,"Kanban.Grid:onCompleteParentTask",[this])}else{this.parentTaskCompleted=false;BX.onCustomEvent(this,"Kanban.Grid:onRenewParentTask",[this])}}else if(t){BX.Kanban.Utils.showErrorDialog(t.error,true)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))}},getColumns:function(){return BX.Kanban.Grid.prototype.getColumns.call(this)},getFinishColumn:function(){return this.getColumns().find((function(t){return t.isFinishType()}))},getNewColumn:function(){return this.getColumns().find((function(t){return t.isNewType()}))},isParentTaskCompleted:function(){return this.parentTaskCompleted},onColumnMoved:function(t,e){var i=t.getId();var n=this.getPreviousColumnSibling(t);var a=n?n.getId():0;if(this.isScrumGridHeader()){this.moveColumnsInNeighborGrids(t,e)}this.ajax({action:"moveColumn",columnId:i,afterColumnId:a},function(t){if(t&&t.error){BX.Kanban.Utils.showErrorDialog(t.error,true)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},onColumnUpdated:function(t){var e=t.getId();var i=t.getName();var n=t.getColor();this.ajax({action:"modifyColumn",fields:{id:e,columnName:i,columnColor:n}},function(t){this.actionPanel=null;if(t&&t.error){BX.Kanban.Utils.showErrorDialog(t.error,t.fatal)}}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},getAjaxHandlerPath:function(){var t=this.getData();return BX.type.isNotEmptyString(t.ajaxHandlerPath)?t.ajaxHandlerPath:"/bitrix/components/bitrix/tasks.kanban/ajax.php"},onApplyFilter:function(t,e,i,n,a){if(this.isGroupingMode()){return}this.fadeOut();if(a){a.autoResolve=false}this.ajax({action:"applyFilter"},function(t){var e=this.getData();if(typeof t.customFields!=="undefined"){e.customFields=t.customFields}this.removeItems();this.loadData(t);if(n){n.fulfill()}this.fadeIn()}.bind(this),function(t){if(n){n.reject()}this.fadeIn()}.bind(this))},onTaskTimerChange:function(t){if(t.taskId&&t.action==="refresh_daemon_event"&&t.data&&t.data.TIMER&&t.data.TIMER.TIMER_STARTED_AT){var e=this.getItem(t.taskId);var i=Math.floor(Date.now()/1e3);var n=parseInt(i-t.data.TIMER.TIMER_STARTED_AT);if(e){e.setDataKey("time_logs",e.getData().time_logs_start+n);e.setDataKey("in_progress",true);e.render()}}},onTaskSortChanged:function(t){var e=this.getData();e.newTaskOrder=t.newTaskOrder;this.setData(e)},recognizeTaskId:function(t){var e=0;if(t.TASK_ID){e=parseInt(t.TASK_ID)}else if(t.taskId){e=parseInt(t.taskId)}else if(t["entityXmlId"]){if(t["entityXmlId"].indexOf("TASK_")===0){e=parseInt(t["entityXmlId"].substr(5))}}return e},onPullCommentReadAll(t){Object.values(this.getItems()).forEach((t=>{const e=t.data;const i=e.is_expired&&!e.completed&&!e.completed_supposedly;const n=t.task_counter;const a=n.getValue();if(a>0&&(!i||a>1)){e.counter.value=i?1:0;n.update(e.counter.value);t.render()}}))},onPullTagChanged(t){if(this.isScrumGrid()){BX.Tasks.Scrum.Kanban.onApplyFilter()}else{this.onApplyFilter()}},onPullCommentAdd(t,e,i){this.updateItemState(e,i)},onPullStageChange(t,e,i){this.updateItemState(e,i)},onPullTaskAdd:function(t,e,i){this.updateItemState(e,i)},onPullTaskUpdate(t,e,i){this.updateItemState(e,i)},onPullTaskView(t,e,i){this.updateItemState(e,i)},onPullTaskRemove(t,e){this.removeItem(e)},refreshTask:function(t){this.ajax({action:"refreshTask",taskId:t,isScrum:this.isScrumGrid()?"Y":"N",parentId:this.getParentTaskId()},function(t){if(t&&!BX.type.isArray(t)&&!t.error){this.addItemOrder(t)}}.bind(this),function(t){}.bind(this))},onGridRender:function(){var t=this.getGridContainer();var e=this.getColumns().reduce((function(t,e){return t+e.getContainer().offsetWidth}),0);var i=e+80<t.offsetWidth;this.getRenderToContainer().classList[i?"add":"remove"]("tasks-kanban-border")},changeDemoView:function(t){var e=this.getColumns();for(var i=0,n=e.length;i<n;i++){this.removeColumn(e[i])}this.ajax({action:"changeDemoView",viewId:t},function(t){this.loadData(t)}.bind(this),function(t){BX.Kanban.Utils.showErrorDialog("Error: "+t,true)}.bind(this))},initActionPanel:function(){this.actionPanel=new BX.UI.ActionPanel({renderTo:document.querySelector(".pagetitle-wrap"),removeLeftPosition:true,maxHeight:56,parentPosition:"bottom"});this.actionPanel.draw();var t=this;var e=[];var i=this.getData();if(i.kanbanType!=="TL"&&i.rights.canSortItem){var n=function(e,i){return function(){BX.Tasks.Kanban.Actions.simpleAction(t,{action:"moveTask",columnId:e,columnName:BX.util.htmlspecialchars(i)})}};this.getColumns().forEach((function(t){e.push({text:t.getName(),onclick:n(t.getId(),t.getName())})}));this.actionPanel.appendItem({id:"stage",text:BX.message("TASKS_KANBAN_PANEL_STAGE"),items:e})}this.actionPanel.appendItem({id:"complete",text:BX.message("TASKS_KANBAN_PANEL_COMPLETE"),onclick:function(){BX.UI.Dialogs.MessageBox.confirm(BX.message("TASKS_KANBAN_PANEL_CONFIRM_MESS_COMPLETE"),BX.message("TASKS_KANBAN_PANEL_CONFIRM_TITLE"),(function(e){BX.Tasks.Kanban.Actions.simpleAction(t,{action:"completeTask"});e.close()}))}});this.actionPanel.appendItem({id:"deadline",text:BX.message("TASKS_KANBAN_PANEL_DEADLINE"),onclick:function(){BX.Tasks.Kanban.Actions.deadline(t,this.layout.container);BX.PreventDefault()}});this.actionPanel.appendItem({id:"members",text:BX.message("TASKS_KANBAN_PANEL_MEMBERS"),items:[{text:BX.message("TASKS_KANBAN_PANEL_MEMBERS_RESPONSE"),onclick:function(){BX.Tasks.Kanban.Actions.member(t,this.layout.container,"delegateTask");BX.PreventDefault()}},{text:BX.message("TASKS_KANBAN_PANEL_MEMBERS_CREATED"),onclick:function(){BX.Tasks.Kanban.Actions.member(t,this.layout.container,"changeAuthorTask");BX.PreventDefault()}},{text:BX.message("TASKS_KANBAN_PANEL_MEMBERS_CORESPONSE"),onclick:function(){BX.Tasks.Kanban.Actions.member(t,this.layout.container,"addAccompliceTask");BX.PreventDefault()}},{text:BX.message("TASKS_KANBAN_PANEL_MEMBERS_AUDITOR"),onclick:function(){BX.Tasks.Kanban.Actions.member(t,this.layout.container,"addAuditorTask");BX.PreventDefault()}}]});this.actionPanel.appendItem({id:"group",text:BX.message("TASKS_KANBAN_PANEL_GROUP"),onclick:function(){BX.Tasks.Kanban.Actions.member(t,this.layout.container,"changeGroupTask","group");BX.PreventDefault()}});this.actionPanel.appendItem({id:"favorite",text:BX.message("TASKS_KANBAN_PANEL_FAVORITE"),items:[{text:BX.message("TASKS_KANBAN_PANEL_FAVORITE_ADD"),onclick:function(){BX.Tasks.Kanban.Actions.simpleAction(t,{action:"addFavoriteTask"})}},{text:BX.message("TASKS_KANBAN_PANEL_FAVORITE_REMOVE"),onclick:function(){BX.Tasks.Kanban.Actions.simpleAction(t,{action:"deleteFavoriteTask"})}}]});this.actionPanel.appendItem({id:"delete",text:BX.message("TASKS_KANBAN_PANEL_DELETE"),onclick:function(){BX.UI.Dialogs.MessageBox.confirm(BX.message("TASKS_KANBAN_PANEL_CONFIRM_MESS_DELETE"),BX.message("TASKS_KANBAN_PANEL_CONFIRM_TITLE"),(function(e){BX.Tasks.Kanban.Actions.simpleAction(t,{action:"deleteTask"});e.close()}))}})},startActionPanel:function(){if(!this.actionPanel){this.initActionPanel()}this.actionPanel.showPanel()},stopActionPanel:function(){if(!this.actionPanel){return}this.actionPanel.hidePanel()},setTotalSelectedItems:function(){if(!this.actionPanel){this.initActionPanel()}this.actionPanel.setTotalSelectedItems(this.getSelectedItems().size)},setKanbanDragMode:function(){BX.addClass(document.body,"task-kanban-drag-mode")},unSetKanbanDragMode:function(){BX.removeClass(document.body,"task-kanban-drag-mode")},setKanbanRealtimeMode:function(){if(this.isRealtimeMode()){this.getOuterContainer().classList.add("tasks-kanban-realtime-mode")}},unSetKanbanRealtimeMode:function(){if(this.isRealtimeMode()){this.getOuterContainer().classList.remove("tasks-kanban-realtime-mode")}},getGridContainer:function(){var t=BX.Kanban.Grid.prototype.getGridContainer.call(this);if(this.isScrumGridHeader()){t.style.overflow="hidden"}return t},adjustHeight:function(){if(!this.isGroupingMode()){BX.Kanban.Grid.prototype.adjustHeight.call(this)}},observeScrumGridHeader:function(){if(typeof IntersectionObserver==="undefined"){return}var t=this.getOuterContainer();var e=t.parentElement;var i=e.querySelector(".tasks-scrum-kanban-header-target-observer");if(!i){return}var n=new IntersectionObserver(function(e){if(e[0].isIntersecting===true){if(t.classList.contains("tasks-scrum-kanban-header")){t.classList.remove("tasks-scrum-kanban-header")}i.classList.remove("--with-margin")}else{if(!t.classList.contains("tasks-scrum-kanban-header")){t.classList.add("tasks-scrum-kanban-header")}i.classList.add("--with-margin")}}.bind(this),{threshold:[0]});n.observe(i)},onGridScroll:function(t){this.neighborGrids.forEach((function(e){e.getGridContainer().scrollLeft=t.target.scrollLeft}))},getEmptyStub:function(){if(this.isScrumGrid()){this.layout.emptyStub=document.createElement("div");return this.layout.emptyStub}else{return BX.Kanban.Grid.prototype.getEmptyStub.call(this)}},getLeftEar:function(){if(this.isScrumGridHeader()){this.layout.earLeft=document.createElement("div");return this.layout.earLeft}else{return BX.Kanban.Grid.prototype.getLeftEar.call(this)}},getRightEar:function(){if(this.isScrumGridHeader()){this.layout.earRight=document.createElement("div");return this.layout.earRight}else{return BX.Kanban.Grid.prototype.getRightEar.call(this)}},addNeighborGrid:function(t){if(this!==t){var e=false;this.neighborGrids.forEach((function(i){if(i===t){e=true}}));if(!e){this.neighborGrids.push(t)}}},cleanNeighborGrids:function(){this.neighborGrids=[]},getNeighborGrids:function(){return this.neighborGrids},addItemToParentGrid:function(t){this.neighborGrids.forEach((function(e){if(!e.isScrumGridHeader()&&!e.isChildScrumGrid()){e.addItemOrder(t)}}))},getItemFromParentGrid:function(t){var e=null;this.neighborGrids.forEach((function(i){if(!i.isScrumGridHeader()&&!i.isChildScrumGrid()){e=i.getItem(t)}}));return e},removeColumnsByIdFromNeighborGrids:function(t){this.neighborGrids.forEach((function(e){e.removeColumn(e.getColumn(t))}))},moveColumnsInNeighborGrids:function(t,e){this.neighborGrids.forEach(function(i){var n=i.getColumn(t.getId());var a=i.getColumn(e.getId());if(n&&a){i.moveColumn(n,a)}}.bind(this))},isScrumGridHeader:function(){return this.gridHeader},isScrumGrid:function(){return this.isSprintView},isGroupingMode:function(){return this.groupingMode},isChildScrumGrid:function(){return this.parentTaskId>0},isParentTask:function(t){return parseInt(t,10)===this.parentTaskId},getParentTaskId:function(){return this.parentTaskId},resetPaginationPage:function(){this.getColumns().forEach((function(t){t.getPagination().loadingInProgress=false;t.getPagination().page=1}))},isChildTask:function(t){return parseInt(t,10)===this.parentTaskId},updateTotals:function(){this.getColumns().forEach(function(t){var e=0;this.getNeighborGrids().forEach((function(i){e+=i.getColumn(t.getId()).getItemsCount()}));t.setTotal(e);t.render()}.bind(this))},getColumnsWidth:function(){var t=0;this.getColumns().forEach((function(e){t+=e.getContainer().offsetWidth}));return t+"px"},hasItem:function(t){t=parseInt(t,10);var e=false;Object.values(this.getItems()).forEach((function(i){if(parseInt(i.getId(),10)===t){e=true}}));return e},hasItemInProgress:function(){var t=false;Object.values(this.getItems()).forEach((function(e){if(!e.isCompleted()){t=true}}));return t},scrollToItem:function(t){var e;var i=function(){clearTimeout(e);e=setTimeout((function(){t.animate({duration:1e3,draw:function(e){t.layout.container.style.opacity=e*100+"%"},useAnimation:true}).then(function(){t.layout.container.style.opacity="100%"}.bind(this))}),100);BX.unbind(window,"scroll",i)};BX.bind(window,"scroll",i);t.getContainer().scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})}}})();
//# sourceMappingURL=grid.map.js