BX.namespace("Tasks.Util");(function(){BX.Tasks.Util.ItemSet=BX.Tasks.Util.Widget.extend({options:{min:false,max:false,preRendered:false,autoSync:false,itemFx:"none",itemAppearFxSpeed:200,itemDisappearFxSpeed:200,itemFxHoverDelete:false,useDragNDrop:false,useSmartCodeNaming:false},sys:{code:"item-set"},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Widget);BX.mergeEx(this.vars,{items:{},order:[],checkRestrictions:true,syncLock:true,idOffset:1,readonly:false});this.bindEvents();this.load(this.option("data"),{dontRender:this.option("preRendered"),loadInitial:true});this.checkConstraints()},checkConstraints:function(){var e=parseInt(this.option("min"));var t=parseInt(this.option("max"));if(isNaN(e)){e=0}if(isNaN(t)){t=Number.POSITIVE_INFINITY}if(e>t){throw new TypeError("Min constraint cannot be greater than max. Check options.")}this.vars.constraint={min:e,max:t}},bindEvents:function(){this.bindItemActions();this.bindFx();this.bindDelegateControl("open-form","click",this.passCtx(this.openAddForm));this.fireChangeDeferredEvent=BX.debounce(this.fireChangeDeferredEvent,5,this)},bindItemActions:function(){this.bindDelegateControl(this.getItemDeleteControlId(),"click",this.passCtx(this.onItemDeleteClicked))},getItemDeleteControlId:function(){return this.option("useSmartCodeNaming")?"i-delete":"item-delete"},bindFx:function(){if(this.option("itemFxHoverDelete")){this.bindDelegateControl("item-delete","mouseover",this.passCtx(this.onItemDeleteOver));this.bindDelegateControl("item-delete","mouseout",this.passCtx(this.onItemDeleteOut))}},getItemClass:function(){return BX.Tasks.Util.ItemSet.Item},getDragNDrop:function(){if(typeof BX.Tasks.Util.DragAndDrop=="undefined"){throw new ReferenceError("Optional drag-n-drop API does not seem to be included (include 'tasks_util_draganddrop' asset)")}return this.subInstance("dd",function(){var e=new BX.Tasks.Util.DragAndDrop({createFlying:BX.delegate(function(e){var t=this.getItemByNode(e);return this.getNodeByTemplate("item-flying",t.data())[0]},this),autoMarkItemAfter:true,autoMarkZoneTopBottom:true});this.bindDNDDropZones(e);e.bindEvent("item-relocation-before",this.onDragNDropItemRelocatedBefore,this);e.bindEvent("item-relocation-after",this.onDragNDropItemRelocatedAfter,this);return e})},bindDNDDropZones:function(e){e.bindDropZone(this.control("items"))},createItem:function(e,t){var i=this.getItemClass();var n=false;t=t||{};if(t.dontRender){n=(this.option("useSmartCodeNaming")?"i-":"item-")+e.VALUE}else{n=this.getNodeByTemplate("item",e)[0]}var s={scope:n,data:e,controlBind:this.option("controlBind"),parent:this};if(this.option("useSmartCodeNaming")){s.overrideCodeWith=this.code()+"-i"}return new i(s)},openAddForm:function(){},addItem:function(e,t){t=t||{};if(typeof t.itemFx=="undefined"){t.itemFx=true}var i=t.returnInstance;var n=this.getItemClass();if("extractValue"in n){e.VALUE=n.extractValue(e)}else if("extractItemValue"in this){e.VALUE=this.extractItemValue(e)}if("extractItemDisplay"in this){e.DISPLAY=this.extractItemDisplay(e)}if("prepareData"in this){e=this.prepareData(e)}else{if("prepareData"in n){e=n.prepareData.apply(this,[e])}else if("prepareDataSt"in n){e=n.prepareDataSt(e)}}if(this.has(e.VALUE)||t.checkRestrictions!==false&&!this.checkCanAddItems()){return i?null:false}if(typeof e.VALUE=="undefined"||typeof e.DISPLAY=="undefined"){return i?null:false}e.ITEM_SET_INVISIBLE="";if(this.option("itemFx")!="none"&&!t.load){e.ITEM_SET_INVISIBLE="invisible"}var s=this.createItem(e,t);if(s==null){return i?null:false}var r=this.registerItem(s,t);return i?s:r},registerItem:function(e,t){t=t||{};if(BX.type.isElementNode(e.option("scope"))){BX.append(e.scope(),this.control("items"))}e.bindEvent("delete",BX.delegate(this.deleteItem,this));this.vars.items[e.value()]=e;this.vars.order.push(e.value());this.processItemAfterCreate(e.value(),t);if("appear"in e){e.appear(t)}if(this.option("useDragNDrop")){this.getDragNDrop().bindNode(e.scope(),{handle:e.controlAll("drag-handle")})}if(!t.load){this.fireChangeEvent(t)}return true},hasItem:function(e){return typeof this.vars.items[e]!="undefined"},getItem:function(e){var t=this.vars.items[e];if(typeof t=="undefined"){return null}return t},getItemValueByNode:function(e){if(!e){return null}var t=BX.data(e,"item-value");if(!t){var i=this.controlP(this.option("useSmartCodeNaming")?"i":"item",e,this.scope());if(i){t=BX.data(i,"item-value")}}return t},getItemByNode:function(e){var t=this.getItemValueByNode(e);if(t){return this.get(t)}return null},getItemFirst:function(){if(this.vars.order.length==0){return null}var e=this.vars.order[0];return this.getItem(e)},getItemLast:function(){if(this.vars.order.length==0){return null}var e=this.vars.order[this.vars.order.length-1];return this.getItem(e)},itemCount:function(){return this.vars.order.length},onItemDestroy:function(){},deleteItem:function(e,t){t=t||{};if(typeof t.itemFx=="undefined"){t.itemFx=true}if(t.checkRestrictions!==false&&!this.checkCanDeleteItems()){return false}var i=false;if(typeof e=="object"){i=e;e=i.value()}else{i=this.vars.items[e]}if(typeof i!="undefined"){this.vars.items[e]=null;delete this.vars.items[e];for(var n in this.vars.order){if(this.vars.order.hasOwnProperty(n)){if(this.vars.order[n]==e){this.vars.order.splice(n,1);break}}}if(this.option("useDragNDrop")){this.getDragNDrop().unBindNode(i.scope())}var s=this;var r=function(){var e=this.scope();var t=this.value();this.destroy();BX.remove(e);s.onItemDestroy(t)};if("disappear"in i&&t.itemFx){i.disappear(r,t)}else{r.call(i)}this.fireChangeEvent(t);this.fireEvent("item-delete",[e]);return true}return false},replaceItem:function(e,t,i){var n={itemFx:false};BX.merge(n,i||{});n.checkRestrictions=false;if(this.deleteItem(e,n)){this.addItem(t,n)}},updateItem:function(e,t){},load:function(e,t){if(BX.type.isPlainObject(e)||BX.type.isArray(e)||e instanceof BX.Tasks.Util.Collection){if(e instanceof BX.Tasks.Util.Collection){e=e.export()}e=BX.clone(e);t=BX.clone(t)||{};t.load=true;this.vars.syncLock=true;var i=0;BX.Tasks.each(e,function(e){if(BX.type.isPlainObject(e)){if(this.addItem(e,t)){i++}}}.bind(this));if(i>0){t.doInstantUpdate=false;this.fireChangeEvent(t)}this.vars.syncLock=false}this.updateInstant()},unload:function(e){this.vars.syncLock=true;e=BX.clone(e)||{};e.unload=true;var t=BX.clone(this.vars.order);if(t.length){var i=0;BX.Tasks.each(t,function(t){if(this.deleteItem(t,e)){i++}}.bind(this));if(i>0){this.fireChangeEvent({doInstantUpdate:false})}this.vars.syncLock=false}this.updateInstant()},processItemAfterCreate:function(){},redraw:function(){var e=BX.create("div");for(var t in this.vars.order){var i=this.vars.order[t];BX.append(this.vars.items[i].scope(),e)}this.moveNodePool(e,this.control("items"));this.updateInstant()},checkCanAddItems:function(){var e=this.option("max");if(e===false){return true}return this.vars.order.length<parseInt(e)},checkCanDeleteItems:function(){var e=this.option("min");return!(this.vars.order.length==0||e!==false&&this.vars.order.length<=parseInt(e))},updateInstant:function(){this.setCSSFlagEmpty();this.setCSSFlagLimits()},setCSSFlagLimits:function(){var e=this.checkCanAddItems();var t=this.checkCanDeleteItems();this.changeCSSFlag("t-min",!t);this.changeCSSFlag("t-max",!e);this.changeCSSFlag(this.getFullBxId("min"),!t);this.changeCSSFlag(this.getFullBxId("max"),!e)},setCSSFlagEmpty:function(){var e=this.vars.order.length>0;this.changeCSSFlag("t-filled",e);this.changeCSSFlag("t-empty",!e);var t=this.getFullBxId("empty");this.dropCSSFlags(t+"-*");this.setCSSFlag(t+"-"+(e?"false":"true"))},moveNodePool:function(e,t){while(e.childNodes.length>0){BX.append(e.childNodes[0],t)}},fireChangeEvent:function(e){e=e||{};this.fireEvent("change",[this.vars.order,e]);this.fireChangeDeferredEvent(e);if(e.doInstantUpdate!==false){this.updateInstant()}},fireChangeDeferredEvent:function(e){this.fireEvent("change-deferred",[this.vars.order,e])},isEnter:function(e){e=e||window.event;return e.keyCode==13},doOnItem:function(e,t,i){if(this.vars.readonly){return false}var n=this.getItemValueByNode(e);var s=Array.prototype.slice.call(arguments);s.shift();s.shift();s.shift();if(typeof n!="undefined"&&n!==null){if(n=="new"){if(BX.type.isFunction(i)){s.unshift(e);s.unshift(null);i.apply(this,s)}}else{BX.data(e,"item-value",n);var r=this.vars.items[n];if(typeof r!="undefined"){s.unshift(e);s.unshift(this.vars.items[n]);t.apply(this,s)}}return n}return false},bindOnItemEx:function(e,t,i){this.bindDelegateControl(e,t,this.bindOnItem(i,i))},bindOnItem:function(e,t){var i=this;return function(){var n=Array.prototype.slice.call(arguments);n.unshift(t);n.unshift(e);n.unshift(this);return i.doOnItem.apply(i,n)}},onItemDeleteClicked:function(e){this.doOnItem(e,this.onItemDeleteByCross)},onItemDeleteOver:function(e){this.doOnItem(e,function(e){BX.addClass(e.scope(),"hover-delete")})},onItemDeleteOut:function(e){this.doOnItem(e,function(e){BX.removeClass(e.scope(),"hover-delete")})},onItemDeleteByCross:function(e){return this.deleteItem(e)},onDragNDropItemRelocatedBefore:function(e,t,i){var n=this.getItemByNode(t);if(n){e.cancelAutoResolve();n.disappear().then(function(){e.fulfill()})}},onDragNDropItemRelocatedAfter:function(e,t,i){var n=this.getItemByNode(t);if(n){e.cancelAutoResolve();n.appear().then(function(){e.fulfill()});this.insertItemBeforeOrder(n,this.getItemByNode(i.before));this.fireChangeEvent()}},getQuery:function(){if(!this.instances.query){this.instances.query=new BX.Tasks.Util.Query({autoExec:true})}return this.instances.query},checkCanSync:function(){return this.option("autoSync")&&!this.vars.syncLock},syncAllIfCan:function(){if(this.checkCanSync()){this.syncAll()}},syncAll:function(e){},extractItemValue:function(e){return e.ID},setField:function(e,t,i){if(!(e in t)){t[e]=BX.type.isFunction(i)?i.apply(this,[t,e]):i}},getRandomHash:function(){return Math.abs(BX.util.hashCode(Math.random().toString()+Math.random().toString()))},readonly:function(e){if(typeof e=="undefined"){return this.vars.readonly}else{e=!!e;this.changeCSSFlag("readonly",e);this.vars.readonly=e}},value:function(){return this.vars.order},first:function(){return this.getItemFirst()},last:function(){return this.getItemLast()},nth:function(e){return this.getItem(this.vars.order[e])},has:function(e){return this.hasItem(e)},get:function(e){return this.getItem(e)},getByKey:function(e){return this.get(e)},each:function(e){if(!BX.type.isFunction(e)){return}for(var t=0;t<this.vars.order.length;t++){if(!this.vars.order.hasOwnProperty(t)){continue}if(e.apply(this,[this.vars.items[this.vars.order[t]]])===false){break}}},count:function(){return this.vars.order.length},exportItemData:function(e){var t=[];this.each(function(i){var n=i.data();t.push(e?BX.clone(n):n)});var i=new BX.Tasks.Util.Collection({keyField:"VALUE"});i.load(t);return i},"export":function(){},insertItemBeforeOrder:function(e,t){var i=e.value();var n=null;if(t){n=t.value()}else{}var s=[];for(var r=0;r<this.vars.order.length;r++){if(this.vars.order.hasOwnProperty(r)){var a=this.vars.order[r];if(a==i){continue}if(a==n){s.push(i)}s.push(a)}}if(!n){s.push(i)}this.vars.order=s}}});BX.Tasks.Util.ItemSet.Item=BX.Tasks.Util.Widget.extend({sys:{code:"item-set-item"},methods:{value:function(e){if(typeof e!="undefined"){this.option("data").VALUE=e;BX.data(this.scope(),"item-value",e);this.addId(e)}else{return this.option("data").VALUE}},display:function(){return this.option("data").DISPLAY},id:function(){var e=this.option("data");return e.ID||e.id},data:function(e){if(BX.type.isPlainObject(e)){this.vars.data=e}else{if(typeof this.vars.data!="undefined"){return this.vars.data}return this.option("data")}},appear:function(e){e=e||{};var t=new BX.Promise;if(e.useAppear===false){t.fulfill();return t}if(!e.dontRender&&!e.load){var i=this.optionP("itemFx");if(i!="none"){var n="fadeToggleByClass";if(i=="horizontal"||i=="vertical"){n=i=="horizontal"?"fadeSlideHToggleByClass":"fadeSlideToggleByClass"}BX.Tasks.Util[n](this.scope(),this.optionP("itemAppearFxSpeed")).then(function(){t.fulfill()},function(){t.reject()})}else{t.fulfill()}}else{t.reject()}return t},disappear:function(e,t){var i=this.optionP("itemFx");if(i!="horizontal"&&i!="vertical"){if(BX.type.isFunction(e)){e.apply(this)}var n=new BX.Promise;n.fulfill();return n}else{return BX.Tasks.Util[i=="horizontal"?"fadeSlideHToggleByClass":"fadeSlideToggleByClass"](this.scope(),this.optionP("itemDisappearFxSpeed"),BX.delegate(e,this))}},isShown:function(){return!BX.hasClass(this.scope(),"invisible")}}});BX.Tasks.Util.ItemSet.Item.prepareData=function(e){return e}})();
//# sourceMappingURL=itemset.map.js