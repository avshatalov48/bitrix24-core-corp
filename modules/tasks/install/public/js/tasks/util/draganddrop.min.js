BX.namespace("Tasks.Util");BX.Tasks.Util.DragAndDrop=BX.Tasks.Util.Base.extend({options:{createFlying:BX.DoNothing,autoMarkItemBefore:false,autoMarkItemAfter:false,autoMarkZoneTopBottom:false},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Base);this.ctrls={zones:[],items:[],flyingNode:false,currentZoneNodeCache:false,insertNodeScope:false,prevInserNodeScope:false};this.vars={flyingOverZone:false,ghostItem:false,dragStartHandleCoords:{x:0,y:0}};BX.Tasks.Util.MouseTracker.getCoordinates();BX.bind(document,"mousemove",BX.throttle(this.trackMouse,10,this))},trackMouse:function(){if(this.ctrls.flyingNode!==false){this.stickToMouse(this.ctrls.flyingNode)}},makeFlyingNode:function(e){var t=this.option("createFlying").apply(this,[e]);if(typeof t=="undefined"||t==null){t=e}var s=BX.clone(t);BX.addClass(s,"flying");this.makeAbsolute(s,t);this.vars.dragStartHandleCoords=this.getNodeMouseOffset(e);BX.append(s,document.getElementsByTagName("body")[0]);this.stickToMouse(s);return s},makeItemGhost:function(e){BX.addClass(this.ctrls.items[e].node,"ghost");this.vars.ghostItem=e},embodyCurrentItem:function(){if(this.vars.ghostItem!==false){BX.removeClass(this.ctrls.items[this.vars.ghostItem].node,"ghost")}this.vars.ghostItem=false},makeZoneIn:function(e){this.vars.flyingOverZone=e;this.makeCurrentZoneCache();var t=this.ctrls.zones[this.vars.flyingOverZone].node;BX.addClass(t,"over")},makeCurrentZoneOut:function(){if(this.vars.flyingOverZone===false){return}var e=this.ctrls.zones[this.vars.flyingOverZone].node;this.vars.flyingOverZone=false;BX.removeClass(e,"over");this.ctrls.currentZoneNodeCache=false},makeCurrentZoneCache:function(){if(this.ctrls.currentZoneNodeCache===false&&this.vars.flyingOverZone!==false){var e=this.ctrls.zones[this.vars.flyingOverZone].node;var t=[];var s=e.childNodes;for(var o in s){if(s[o].nodeType==1&&this.checkNodeBound(s[o])){var r=BX.pos(s[o]);if(r.width&&r.height){t.push(s[o])}}}this.ctrls.currentZoneNodeCache=t}},getCurrentZoneNodeScope:function(){if(this.ctrls.currentZoneNodeCache!==false&&this.vars.flyingOverZone!==false&&this.vars.ghostItem!==false){var e=BX.Tasks.Util.MouseTracker.getCoordinates();var t=BX.pos(this.ctrls.zones[this.vars.flyingOverZone].node);var s={x:e.x-t.left,y:e.y-t.top};var o=null;for(var r in this.ctrls.currentZoneNodeCache){var n=this.ctrls.currentZoneNodeCache[r];var i=BX.pos(n);var a={x:i.left-t.left,y:i.top-t.top};var l=Math.floor(i.height/2);if(s.y<a.y+l){return{after:o,before:n}}o=n}return{after:o,before:null}}return{after:null,before:null}},bindDropZone:function(e){if(!BX.type.isElementNode(e)){throw new TypeError("Bad zone to drop to")}jsDD.registerDest(e);this.ctrls.zones.push({node:e})},unBindDropZone:function(e){if(!BX.type.isElementNode(e)){return}jsDD.unregisterDest(e);for(var t in this.ctrls.zones){if(this.ctrls.zones[t].node===node){this.ctrls.zones[t]=null;this.ctrls.zones.splice(t,1)}}},bindNode:function(e,t){if(!BX.type.isElementNode(e)){throw new TypeError("Bad item to drag")}var s=[e];if(typeof t!="undefined"&&typeof t.handle!="undefined"){if(BX.type.isElementNode(t.handle)){s=[t.handle]}else if("length"in t.handle){s=[];for(var o=0;o<t.handle.length;o++){if(BX.type.isElementNode(t.handle[o])){s.push(t.handle[o])}}}}for(var o=0;o<s.length;o++){jsDD.registerObject(s[o]);s[o].onbxdragstart=this.passCtx(this.onDragStart,this);s[o].onbxdrag=BX.throttle(this.onDrag,300,this);s[o].onbxdragstop=BX.delegate(this.onDragStop,this);s[o].onbxdraghover=BX.delegate(this.onDragHover,this);s[o].onbxdraghout=BX.delegate(this.onDragHout,this)}this.ctrls.items.push({node:e,handle:s})},unBindNode:function(e){if(!BX.type.isElementNode(e)){return}for(var t in this.ctrls.items){if(this.ctrls.items[t].node===e){var s=this.ctrls.items[t].handle;for(var o=0;o<s.length;o++){jsDD.unregisterObject(s[o]);s[o].onbxdragstart=null;s[o].onbxdrag=null;s[o].onbxdragstop=null;s[o].onbxdraghover=null;s[o].onbxdraghout=null}this.ctrls.items[t]=null;this.ctrls.items.splice(t,1);return}}},checkNodeBound:function(e){if(!BX.type.isElementNode(e)){return}for(var t in this.ctrls.items){if(this.ctrls.items[t].node===e){return true}}return false},onDragStart:function(e){var t=this.getItemIndexByHandle(e);if(typeof this.ctrls.items[t]){this.ctrls.flyingNode=this.makeFlyingNode(this.ctrls.items[t].node);this.makeItemGhost(t)}},onDrag:function(){if(this.vars.flyingOverZone!==false){var e=this.getCurrentZone().node;this.ctrls.insertNodeScope=this.getCurrentZoneNodeScope();this.toggleNodeScopeClass(this.ctrls.prevInserNodeScope,false);this.toggleNodeScopeClass(this.ctrls.insertNodeScope,true);this.toggleZoneClass(e,this.ctrls.insertNodeScope);this.ctrls.prevInserNodeScope=this.ctrls.insertNodeScope;this.fireEvent("item-flying",[e,this.ctrls.insertNodeScope])}},onDragStop:function(){if(this.vars.flyingOverZone!==false){var e=this.ctrls.zones[this.vars.flyingOverZone].node;var t=this.ctrls.items[this.vars.ghostItem].node;if(this.ctrls.insertNodeScope!==false){var s={before:this.ctrls.insertNodeScope.before,after:this.ctrls.insertNodeScope.after,zone:e};var o=s.before!=t&&s.after!=t;var r=new BX.Promise(null,this);r.setAutoResolve(true);if(o){this.fireEvent("item-relocation-before",[r,t,s])}r.then(function(){if(o){if(this.ctrls.insertNodeScope.before===null){BX.append(t,e)}else{e.insertBefore(t,s.before)}this.fireEvent("item-relocated",[t,e,s])}this.clearNodeScopeClass();this.toggleZoneClass(e);this.makeCurrentZoneOut();return true}).then(function(){var e=new BX.Promise(null,this);e.setAutoResolve(true);if(o){this.fireEvent("item-relocation-after",[e,t,s])}return e})}}this.embodyCurrentItem();if(this.ctrls.flying!==false){BX.remove(this.ctrls.flyingNode)}},onDragHover:function(e,t,s){if(BX.type.isElementNode(e)){var o=this.checkZoneIsLegal(e);if(o!==false){this.makeZoneIn(o)}}},onDragHout:function(e,t,s){if(BX.type.isElementNode(e)&&this.checkZoneIsLegal(e)!==false){this.makeCurrentZoneOut();this.clearNodeScopeClass();this.toggleZoneClass(e)}},getCurrentZone:function(){return this.ctrls.zones[this.vars.flyingOverZone]},clearNodeScopeClass:function(){this.toggleNodeScopeClass(this.ctrls.insertNodeScope,false);this.ctrls.insertNodeScope=false},toggleNodeScopeClass:function(e,t){if(e){var s=this.option("autoMarkItemBefore");var o=this.option("autoMarkItemAfter");if(t){if(o&&e.after&&!BX.hasClass(e.after,"after")){BX.addClass(e.after,"after")}if(s&&e.before&&!BX.hasClass(e.before,"before")){BX.addClass(e.before,"before")}}else{if(o&&e.after&&BX.hasClass(e.after,"after")){BX.removeClass(e.after,"after")}if(s&&e.before&&BX.hasClass(e.before,"before")){BX.removeClass(e.before,"before")}}}},toggleZoneClass:function(e,t){if(!this.option("autoMarkZoneTopBottom")){return}if(!t){t={after:true,before:true}}if(e){if(!t.after){if(!BX.hasClass(e,"top")){BX.addClass(e,"top")}}else{if(BX.hasClass(e,"top")){BX.removeClass(e,"top")}}if(!t.before){if(!BX.hasClass(e,"bottom")){BX.addClass(e,"bottom")}}else{if(BX.hasClass(e,"bottom")){BX.removeClass(e,"bottom")}}}},checkZoneIsLegal:function(e){for(var t in this.ctrls.zones){if(this.ctrls.zones[t].node===e){return t}}return false},getItemIndexByHandle:function(e){for(var t in this.ctrls.items){var s=this.ctrls.items[t].handle;for(var o=0;o<s.length;o++){if(s[o]===e){return t}}}return false},makeAbsolute:function(e,t){var s={position:"absolute",top:"100px",left:"100px",margin:0,"box-sizing":"border-box","z-index":999};var o=t.offsetWidth;if(o>0){s["width"]=o+"px"}var r=t.offsetHeight;if(r>0){s["height"]=r+"px"}BX.adjust(e,{style:s})},getNodeMouseOffset:function(e){var t=BX.pos(e);var s=BX.Tasks.Util.MouseTracker.getCoordinates();var o=s.x-t.left;var r=s.y-t.top;return{x:o,y:r}},stickToMouse:function(e){var t=BX.Tasks.Util.MouseTracker.getCoordinates();var s=this.vars.dragStartHandleCoords;BX.adjust(e,{style:{top:t.y-s.y+"px",left:t.x-s.x+"px"}})}}});
//# sourceMappingURL=draganddrop.map.js