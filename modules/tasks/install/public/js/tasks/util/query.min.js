"use strict";BX.namespace("Tasks.Util");BX.Tasks.Util.Query=BX.Tasks.Util.Base.extend({options:{url:"/bitrix/components/bitrix/tasks.base/ajax.php",autoExec:false,replaceDuplicateCode:true,autoExecDelay:100,translateBooleanToZeroOne:true,emitter:""},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Base);this.vars={batch:[],local:{}};this.autoExecute=BX.debounce(this.autoExecute,this.option("autoExecDelay"),this)},destruct:function(){this.vars=null;this.opts=null},autoExecute:function(){if(this.option("autoExec")){this.execute()}},add:function(t,e,s,r){if(typeof t=="undefined"){throw new ReferenceError("Method name was not provided")}t=t.toString();if(t.length==0){throw new ReferenceError("Method name must not be empty")}var i;if(typeof e=="undefined"||!BX.type.isPlainObject(e)){e={}}for(i in e){if(e.hasOwnProperty(i)){e[i]=this.processArguments(BX.clone(e[i]))}}if(typeof s=="undefined"||!BX.type.isPlainObject(s)){s={}}s.code=this.pickCode(s);if(this.option("replaceDuplicateCode")){for(i=0;i<this.vars.batch.length;i++){if(this.vars.batch[i].PARAMETERS.code==s.code){this.vars.batch.splice(i,1);break}}}this.vars.batch.push({OPERATION:t,ARGUMENTS:e,PARAMETERS:s});if(BX.type.isFunction(r)){r={onExecuted:r}}else{r=r||{}}r.pr=new BX.Promise(null,r.promiseCtx);this.vars.local[s.code]=r;this.autoExecute();return this},run:function(t,e,s,r,i){s=BX.type.isPlainObject(s)?s:{};s.code=this.pickCode(s);this.add(t,e,s,r);r=BX.type.isPlainObject(r)?BX.clone(r):{};r.promiseCtx=i;this.add(t,e,s,r);return this.vars.local[s.code].pr},pickCode:function(t){var e="";if(BX.type.isPlainObject(t)){e=t.code}if(!BX.type.isNotEmptyString(e)){e="op_"+this.vars.batch.length}return e},processArguments:function(t){var e=typeof t;if(e=="array"){if(t.length==0){return""}for(var s=0;s<e.length;s++){t[s]=this.processArguments(t[s])}}if(e=="object"){var r=0;for(var s in t){t[s]=this.processArguments(t[s]);r++}if(r==0){return""}}if(e=="boolean"&&this.option("translateBooleanToZeroOne")){return t===true?"1":"0"}return t},load:function(t){if(BX.type.isArray(t)){this.clear();for(var e=0;e<t.length;e++){this.add(t[e].m,t[e].args,t[e].rp)}}return this},deleteAll:function(){this.vars.batch=[];this.vars.local={};return this},clear:function(){return this.deleteAll()},execute:function(t){if(this.opts.url===false){throw new ReferenceError("URL was not provided")}if(typeof t=="undefined"){t={}}var e=new BX.Promise;t.pr=e;if(this.vars.batch.length>0){t.localVars=this.vars.local;var s=this.vars.batch;this.clear();BX.ajax({url:this.opts.url,method:"post",dataType:"json",async:true,processData:true,emulateOnload:true,start:true,data:{sessid:BX.bitrix_sessid(),SITE_ID:BX.message("SITE_ID"),EMITTER:this.option("emitter"),ACTION:s},cache:false,onsuccess:function(e){try{if(!e){e={SUCCESS:false,ERROR:[{CODE:"INTERNAL_ERROR",MESSAGE:BX.message("TASKS_ASSET_QUERY_EMPTY_RESPONSE"),TYPE:"FATAL"}],ASSET:[],DATA:{}}}var s="";if(BX.type.isArray(e.ASSET)){s=e.ASSET.join("")}BX.html(null,s).then(function(){this.processResult({success:e.SUCCESS,clientProcessErrors:[],serverProcessErrors:e.ERROR,data:e.DATA||{},response:e},t)}.bind(this))}catch(e){BX.debug(e);this.processResult({success:false,clientProcessErrors:[{CODE:"INTERNAL_ERROR",MESSAGE:BX.message("TASKS_ASSET_QUERY_QUERY_FAILED_EXCEPTION"),TYPE:"FATAL"}],serverProcessErrors:[],data:{}},t)}}.bind(this),onfailure:function(e,s){console.dir(e);console.dir(s);var r=BX.message("TASKS_ASSET_QUERY_QUERY_FAILED");if(e=="processing"){r=BX.message("TASKS_ASSET_QUERY_ILLEGAL_RESPONSE")}else if(e=="status"){r=BX.message("TASKS_ASSET_QUERY_QUERY_FAILED_STATUS").replace("#HTTP_STATUS#",s)}this.processResult({success:false,clientProcessErrors:[{CODE:"INTERNAL_ERROR",MESSAGE:r,TYPE:"FATAL",ajaxExtra:{code:e,status:s}}],serverProcessErrors:[],data:{}},t)}.bind(this)})}return e},processResult:function(t,e){this.executeDone(t,e.done,e.pr,e.localVars);this.fireEvent("executed",[t])},executeDone:function(t,e,s,r){var i=this.getErrorCollectionClass();var n=new i;var o;var a;o=t.serverProcessErrors||[];for(a=0;a<o.length;a++){n.add(o[a],"C")}o=t.clientProcessErrors||[];for(a=0;a<o.length;a++){n.add(o[a],"C")}var u=BX.clone(t.data);var l=new i(n);var c;var h=new BX.Tasks.Util.Query.Result(n,u);if(t.success){for(var f in u){if(u.hasOwnProperty(f)){c=null;c=new i(l);o=t.data[f].ERRORS||[];for(a=0;a<o.length;a++){c.add(o[a])}delete u[f].ERRORS;delete u[f].SUCCESS;if(BX.type.isFunction(r[f].onExecuted)){r[f].onExecuted.apply(this,[c,u[f]])}r[f].pr.fulfill(new BX.Tasks.Util.Query.Result(c,u[f].RESULT));c.deleteByMark("C");n.load(c)}}if(s instanceof BX.Promise){s.fulfill(h)}}else{BX.Tasks.each(r,function(t){t.pr.reject(new BX.Tasks.Util.Query.Result(l,null))});if(s instanceof BX.Promise){s.reject(h)}}if(BX.type.isFunction(e)){e.apply(this,[n,t])}if(n.checkHasErrors()){BX.onCustomEvent("TaskAjaxError",[n])}},getErrorCollectionClass:function(){return BX.Tasks.Util.Query.ErrorCollection}}});BX.Tasks.Util.Query.runOnce=function(t,e){return new this({autoExec:true}).run(t,e)};BX.Tasks.Util.Query.Result=function(t,e){this.errors=t?t:new BX.Tasks.Util.Query.ErrorCollection;this.data=e?e:{}};BX.mergeEx(BX.Tasks.Util.Query.Result.prototype,{isSuccess:function(){return this.errors.filter({TYPE:"FATAL"}).isEmpty()},getData:function(){return this.data},getErrors:function(){return this.errors}});BX.Tasks.Util.Query.ErrorCollection=function(t){this.length=0;if(typeof t!="undefined"){this.load(t)}};BX.mergeEx(BX.Tasks.Util.Query.ErrorCollection.prototype,{add:function(t,e){this[this.length++]=new BX.Tasks.Util.Query.Error(BX.clone(t),e)},load:function(t){for(var e=0;e<t.length;e++){this.add(t[e],false)}},isEmpty:function(){return!this.length},filter:function(t){var e=new this.constructor;for(var s=0;s<this.length;s++){if(this.hasOwnProperty(s)){var r=true;if(BX.type.isPlainObject(t)){if("TYPE"in t){if(this[s].getType()!=t.TYPE){r=false}}}if(r){e.add(this[s])}}}return e},getMessages:function(t){var e=[];for(var s=0;s<this.length;s++){if(this.hasOwnProperty(s)){var r=this[s].getMessage();e.push(t?BX.util.htmlspecialchars(r):r)}}return e},getByCode:function(t){if(!BX.type.isNotEmptyString(t)){return false}for(var e=0;e<this.length;e++){if(this[e].checkIsOfCode(t)){return BX.clone(this[e])}}return null},deleteByCodeAll:function(t){if(!BX.type.isNotEmptyString(t)){return}this.deleteByCondition(function(e){return e.checkIsOfCode(t)})},deleteByMark:function(t){if(!BX.type.isNotEmptyString(t)){return}this.deleteByCondition(function(e){return e.mark()==t})},deleteByCondition:function(t){var e=[];for(var s=0;s<this.length;s++){if(!t.apply(this,[this[s]])){e.push(this[s])}}this.deleteAll(false);this.load(e)},deleteAll:function(t){for(var e=0;e<this.length;e++){if(t!==false){this[e]=null}delete this[e]}this.length=0},checkHasErrors:function(){return!!this.length}});BX.Tasks.Util.Query.Error=function(t,e){for(var s in t){if(t.hasOwnProperty(s)){this[s]=BX.clone(t[s])}}this.vars={mark:e}};BX.mergeEx(BX.Tasks.Util.Query.Error.prototype,{getCode:function(){return this.CODE},getType:function(){return this.TYPE},getMessage:function(){return this.MESSAGE},checkIsOfCode:function(t){return this.CODE==t||BX.util.in_array(t,this.CODE.toString().split("."))},code:function(){return this.getCode()},mark:function(){return this.vars.mark},data:function(){if(BX.type.isPlainObject(this.DATA)){return this.DATA}return{}}});BX.Tasks.Util.Query.Iterator=BX.Tasks.Util.Base.extend({options:{url:"",timeout:500},methods:{construct:function(){this.callConstruct(BX.Tasks.Util.Base);this.reset()},getQuery:function(){return this.subInstance("query",function(){return new BX.Tasks.Util.Query({url:this.option("url"),autoExec:true,autoExecDelay:1})})},reset:function(){this.vars=this.vars||{};this.vars.running=false;this.vars.step=0;this.vars.timer=null;this.vars.ajaxRun=false;this.vars.ajaxAbort=false},setStopped:function(t){this.vars.running=false;this.fireEvent("stop",[t])},start:function(){if(this.vars.running){return}this.reset();this.vars.running=true;this.fireEvent("start");this.hit()},stop:function(){if(!this.vars.running){return}clearInterval(this.vars.timer);if(this.vars.ajaxRun){this.vars.ajaxAbort=true}else{this.setStopped()}},hit:function(){this.vars.ajaxRun=true;this.getQuery().run(this.option("handler"),{parameters:{step:this.vars.step++}}).then(BX.delegate(function(t){this.vars.ajaxRun=false;if(this.vars.ajaxAbort){this.setStopped()}else{if(t.isSuccess()){var e=new BX.Promise(null,this);this.fireEvent("hit",[e,t.getData(),t]);e.then(function(){this.vars.timer=setTimeout(BX.delegate(this.hit,this),this.optionInteger("timeout"))},function(){this.setStopped()})}else{this.fireEvent("error",[t.getErrors(),t]);this.setStopped(t.getErrors())}}},this),BX.delegate(function(t){this.fireEvent("error",[t.getErrors(),t]);this.setStopped(t.getErrors())},this))}}});BX.Tasks.Util.InputGrabber=function(){};BX.Tasks.Util.InputGrabber.grabFrom=function(t,e){var s={};if(t&&BX.type.isElementNode(t)&&t.nodeName=="FORM"){var r=0;for(var i=0;i<t.length;i++){if(t[i].name!=""&&!t[i].disabled){if(t[i].nodeName=="INPUT"&&t[i].getAttribute("type")=="checkbox"&&!t[i].checked){continue}var n=t[i].name;if(e){var o=t[i].name.toString().replace(/\]/g,"").split("[");var a=s;for(r=0;r<o.length;r++){if(typeof a[o[r]]=="undefined"){a[o[r]]=r==o.length-1?t[i].value:{}}a=a[o[r]]}}else{s[n]=t[i].value}}}return s}};