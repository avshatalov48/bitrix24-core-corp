BX.namespace("Tasks.UI");BX.Tasks.UI.DragAndDrop=BX.Tasks.Base.extend({options:{createFlying:BX.DoNothing},methods:{construct:function(){this.ctrls={zones:[],items:[],flyingNode:false,currentZoneNodeCache:false,insertNodeScope:false};this.vars={flyingOverZone:false,ghostItem:false,dragStartHandleCoords:{x:0,y:0}};BX.Tasks.UI.MouseTracker.getCoordinates();BX.bind(document,"mousemove",BX.throttle(this.trackMouse,10,this))},trackMouse:function(){if(this.ctrls.flyingNode!==false){this.stickToMouse(this.ctrls.flyingNode)}},makeFlyingNode:function(e){var t=this.option("createFlying").apply(this,[e]);if(typeof t=="undefined"||t==null){t=e}var s=BX.clone(t);BX.addClass(s,"flying");this.makeAbsolute(s,t);this.vars.dragStartHandleCoords=this.getNodeMouseOffset(e);BX.append(s,document.getElementsByTagName("body")[0]);this.stickToMouse(s);return s},makeItemGhost:function(e){BX.addClass(this.ctrls.items[e].node,"ghost");this.vars.ghostItem=e},embodyCurrentItem:function(){if(this.vars.ghostItem!==false){BX.removeClass(this.ctrls.items[this.vars.ghostItem].node,"ghost")}this.vars.ghostItem=false},makeZoneIn:function(e){this.vars.flyingOverZone=e;this.makeCurrentZoneCache();var t=this.ctrls.zones[this.vars.flyingOverZone].node;BX.addClass(t,"over")},makeCurrentZoneOut:function(){if(this.vars.flyingOverZone===false){return}var e=this.ctrls.zones[this.vars.flyingOverZone].node;this.vars.flyingOverZone=false;BX.removeClass(e,"over");this.ctrls.currentZoneNodeCache=false},makeCurrentZoneCache:function(){if(this.ctrls.currentZoneNodeCache===false&&this.vars.flyingOverZone!==false){var e=this.ctrls.zones[this.vars.flyingOverZone].node;var t=[];var s=e.childNodes;for(var n in s){if(s[n].nodeType==1){var o=BX.pos(s[n]);if(o.width&&o.height){t.push(s[n])}}}this.ctrls.currentZoneNodeCache=t}},getCurrentZoneNodeScope:function(){if(this.ctrls.currentZoneNodeCache!==false&&this.vars.flyingOverZone!==false&&this.vars.ghostItem!==false){var e=BX.Tasks.UI.MouseTracker.getCoordinates();var t=BX.pos(this.ctrls.zones[this.vars.flyingOverZone].node);var s={x:e.x-t.left,y:e.y-t.top};var n=null;for(var o in this.ctrls.currentZoneNodeCache){var r=this.ctrls.currentZoneNodeCache[o];var i=BX.pos(r);var a={x:i.left-t.left,y:i.top-t.top};var l=Math.floor(i.height/2);if(s.y<a.y+l){return{after:n,before:r}}n=r}return{after:n,before:null}}return{after:null,before:null}},bindDropZone:function(e){if(!BX.type.isElementNode(e)){throw new TypeError("Bad zone to drop to")}jsDD.registerDest(e);this.ctrls.zones.push({node:e})},unBindDropZone:function(e){if(!BX.type.isElementNode(e)){return}jsDD.unregisterDest(e);for(var t in this.ctrls.zones){if(this.ctrls.zones[t].node===node){this.ctrls.zones[t]=null;this.ctrls.zones.splice(t,1)}}},bindNode:function(e,t){if(!BX.type.isElementNode(e)){throw new TypeError("Bad item to drag")}var s=e;if(typeof t!="undefined"&&typeof t.handle!="undefined"&&BX.type.isElementNode(t.handle)){s=t.handle}jsDD.registerObject(s);s.onbxdragstart=this.passCtx(this.onDragStart,this);s.onbxdrag=BX.throttle(this.onDrag,300,this);s.onbxdragstop=BX.delegate(this.onDragStop,this);s.onbxdraghover=BX.delegate(this.onDragHover,this);s.onbxdraghout=BX.delegate(this.onDragHout,this);this.ctrls.items.push({node:e,handle:s})},unBindNode:function(e){if(!BX.type.isElementNode(e)){return}for(var t in this.ctrls.items){if(this.ctrls.items[t].node===e){var s=this.ctrls.items[t].handle;jsDD.unregisterObject(s);s.onbxdragstart=null;s.onbxdrag=null;s.onbxdragstop=null;s.onbxdraghover=null;s.onbxdraghout=null;this.ctrls.items[t]=null;this.ctrls.items.splice(t,1);return}}},onDragStart:function(e){var t=this.getItemIndexByHandle(e);if(typeof this.ctrls.items[t]){this.ctrls.flyingNode=this.makeFlyingNode(this.ctrls.items[t].node);this.makeItemGhost(t)}},onDrag:function(){if(this.vars.flyingOverZone!==false){this.ctrls.insertNodeScope=this.getCurrentZoneNodeScope()}},onDragStop:function(){if(this.vars.flyingOverZone!==false){var e=this.ctrls.zones[this.vars.flyingOverZone].node;var t=this.ctrls.items[this.vars.ghostItem].node;if(this.ctrls.insertNodeScope!==false){if(this.ctrls.insertNodeScope.before===null){BX.append(t,e)}else{e.insertBefore(t,this.ctrls.insertNodeScope.before)}this.fireEvent("item-relocated",[t,e,this.ctrls.insertNodeScope]);this.ctrls.insertNodeScope=false}this.makeCurrentZoneOut()}this.embodyCurrentItem();if(this.ctrls.flying!==false){BX.remove(this.ctrls.flyingNode)}},onDragHover:function(e,t,s){if(BX.type.isElementNode(e)){var n=this.checkZoneIsLegal(e);if(n!==false){this.makeZoneIn(n)}}},onDragHout:function(e,t,s){if(BX.type.isElementNode(e)&&this.checkZoneIsLegal(e)!==false){this.makeCurrentZoneOut()}},checkZoneIsLegal:function(e){for(var t in this.ctrls.zones){if(this.ctrls.zones[t].node===e){return t}}return false},getItemIndexByHandle:function(e){for(var t in this.ctrls.items){if(this.ctrls.items[t].handle===e){return t}}return false},makeAbsolute:function(e,t){var s={position:"absolute",top:"100px",left:"100px",margin:0,"box-sizing":"border-box","z-index":999};var n=t.offsetWidth;if(n>0){s["width"]=n+"px"}var o=t.offsetHeight;if(o>0){s["height"]=o+"px"}BX.adjust(e,{style:s})},getNodeMouseOffset:function(e){var t=BX.pos(e);var s=BX.Tasks.UI.MouseTracker.getCoordinates();var n=s.x-t.left;var o=s.y-t.top;return{x:n,y:o}},stickToMouse:function(e){var t=BX.Tasks.UI.MouseTracker.getCoordinates();var s=this.vars.dragStartHandleCoords;BX.adjust(e,{style:{top:t.y-s.y+"px",left:t.x-s.x+"px"}})}}});BX.Tasks.UI.MouseTracker=function(){this.coords={x:0,y:0};BX.bind(document,"mousemove",BX.delegate(function(e){this.coords={x:e.pageX?e.pageX:e.clientX?e.clientX+(document.documentElement.scrollLeft||document.body.scrollLeft)-document.documentElement.clientLeft:0,y:e.pageY?e.pageY:e.clientY?e.clientY+(document.documentElement.scrollTop||document.body.scrollTop)-document.documentElement.clientTop:0}},this))};BX.Tasks.UI.MouseTracker.getCoordinates=function(){BX.Tasks.UI.MouseTracker.makeInstance();return BX.clone(BX.Tasks.Instances.mouseTracker.coords)};BX.Tasks.UI.MouseTracker.makeInstance=function(){if(typeof BX.Tasks.Instances=="undefined"){BX.Tasks.Instances={}}if(typeof BX.Tasks.Instances.mouseTracker=="undefined"){BX.Tasks.Instances.mouseTracker=new BX.Tasks.UI.MouseTracker}};
//# sourceMappingURL=1.map.js