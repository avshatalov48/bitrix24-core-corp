this.BX=this.BX||{};this.BX.Intranet=this.BX.Intranet||{};(function(e,t,n,i,r,a){"use strict";function s(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<a \n\t\t\t\t\tclass="intranet-ustat-online-popup-item"\n\t\t\t\t\thref="','" \n\t\t\t\t\ttarget="_blank"\n\t\t\t\t>\n\t\t\t\t\t<span class="intranet-ustat-online-popup-avatar-new">\n\t\t\t\t\t\t<div class="ui-icon ui-icon-common-user intranet-ustat-online-popup-avatar-img">\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<span class="intranet-ustat-online-popup-avatar-status-icon"></span>\n\t\t\t\t\t</span>\n\t\t\t\t\t<span class="intranet-ustat-online-popup-name">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>\n\t\t\t\t</a>\n\t\t\t"]);s=function t(){return e};return e}function o(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t\t<span class="intranet-ustat-online-popup-name-title">\n\t\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\t<div class="intranet-ustat-online-popup-container">\n\t\t\t\t\t\t\t\t<div class="intranet-ustat-online-popup-content">\n\t\t\t\t\t\t\t\t\t<div class="intranet-ustat-online-popup-content-box">\n\t\t\t\t\t\t\t\t\t\t<div class="intranet-ustat-online-popup-inner"></div>\n\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t']);o=function t(){return e};return e}var l=function(){function e(t){var n=this;babelHelpers.classCallCheck(this,e);this.parent=t;this.signedParameters=this.parent.signedParameters;this.componentName=this.parent.componentName;this.userInnerBlockNode=this.parent.userInnerBlockNode||"";this.timemanNode=this.parent.timemanNode;this.circleNode=this.parent.circleNode||"";this.isPopupShown=false;this.popupCurrentPage={};this.renderedUsers=[];i.Event.bind(this.userInnerBlockNode,"click",function(){n.showPopup("getAllOnlineUser",n.userInnerBlockNode)});i.Event.bind(this.circleNode,"click",function(){n.showPopup("getAllOnlineUser",n.circleNode,-5)});if(this.parent.isTimemanAvailable&&i.Type.isDomNode(this.parent.timemanNode)){var r=this.timemanNode.querySelector(".js-ustat-online-timeman-opened-block");var a=this.timemanNode.querySelector(".js-ustat-online-timeman-closed-block");i.Event.bind(r,"click",function(){n.showPopup("getOpenedTimemanUser",r)});i.Event.bind(a,"click",function(){n.showPopup("getClosedTimemanUser",a)})}}babelHelpers.createClass(e,[{key:"getPopupTitle",value:function e(t){var n="";if(t==="getAllOnlineUser"){n=i.Loc.getMessage("INTRANET_USTAT_ONLINE_USERS")}else if(t==="getOpenedTimemanUser"){n=i.Loc.getMessage("INTRANET_USTAT_ONLINE_STARTED_DAY")}else if(t==="getClosedTimemanUser"){n=i.Loc.getMessage("INTRANET_USTAT_ONLINE_FINISHED_DAY")}return n}},{key:"showPopup",value:function e(t,r,a){var s=this;if(this.isPopupShown){return}if(i.Type.isUndefined(a)){a=7}this.popupCurrentPage[t]=1;this.popupInnerContainer="";this.renderedUsers=[];this.allOnlineUserPopup=new n.Popup("intranet-ustat-online-popup-".concat(i.Text.getRandom()),r,{lightShadow:true,offsetLeft:t==="getClosedTimemanUser"?-60:-22,offsetTop:a,autoHide:true,closeByEsc:true,bindOptions:{position:"bottom"},animationOptions:{show:{type:"opacity-transform"},close:{type:"opacity"}},events:{onPopupDestroy:function e(){s.isPopupShown=false},onPopupClose:function e(){s.allOnlineUserPopup.destroy()},onAfterPopupShow:function e(n){var r=i.Tag.render(o(),s.getPopupTitle(t));n.contentContainer.appendChild(r);s.popupInnerContainer=r.querySelector(".intranet-ustat-online-popup-inner");s.loader=s.showLoader({node:r.querySelector(".intranet-ustat-online-popup-content"),loader:null,size:40});s.showUsersInPopup(t);s.isPopupShown=true}},className:"intranet-ustat-online-popup"});this.popupScroll(t);this.allOnlineUserPopup.show()}},{key:"popupScroll",value:function e(t){var n=this;if(!i.Type.isDomNode(this.popupInnerContainer)){return}i.Event.bind(this.popupInnerContainer,"scroll",function(){if(n.popupInnerContainer.scrollTop>(n.popupInnerContainer.scrollHeight-n.popupInnerContainer.offsetHeight)/1.5){n.showUsersInPopup(t);i.Event.unbindAll(n.popupInnerContainer,"scroll")}})}},{key:"showUsersInPopup",value:function e(t){var n=this;if(t!=="getAllOnlineUser"&&t!=="getOpenedTimemanUser"&&t!=="getClosedTimemanUser"){return}BX.ajax.runComponentAction(this.componentName,t,{signedParameters:this.signedParameters,mode:"class",data:{pageNum:this.popupCurrentPage[t]}}).then(function(e){if(e.data){n.renderPopupUsers(e.data);n.popupCurrentPage[t]++;n.popupScroll(t)}else{if(!n.popupInnerContainer.hasChildNodes()){n.popupInnerContainer.innerText=i.Loc.getMessage("INTRANET_USTAT_ONLINE_EMPTY")}}n.hideLoader({loader:n.loader})},function(e){n.hideLoader({loader:n.loader})})}},{key:"renderPopupUsers",value:function e(t){if(!this.allOnlineUserPopup||!i.Type.isDomNode(this.popupInnerContainer)||!i.Type.isObjectLike(t)){return}for(var n in t){if(!t.hasOwnProperty(n)||this.renderedUsers.indexOf(t[n]["ID"])>=0){continue}this.renderedUsers.push(t[n]["ID"]);var r="<i></i>";if(i.Type.isString(t[n]["AVATAR"])&&t[n]["AVATAR"]){r="<i style=\"background-image: url('".concat(t[n]["AVATAR"],"')\"></i>")}var a=i.Tag.render(s(),t[n]["PATH_TO_USER_PROFILE"],r,t[n]["NAME"]);this.popupInnerContainer.appendChild(a)}}},{key:"showLoader",value:function e(t){var n=null;if(t.node){if(t.loader===null){n=new BX.Loader({target:t.node,size:t.hasOwnProperty("size")?t.size:40})}else{n=t.loader}n.show()}return n}},{key:"hideLoader",value:function e(t){if(t.loader!==null){t.loader.hide()}if(t.node){i.Dom.clean(t.node)}if(t.loader!==null){t.loader=null}}}]);return e}();function u(e,t){var n;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(n=c(e))||t&&e&&typeof e.length==="number"){if(n)e=n;var i=0;var r=function e(){};return{s:r,n:function t(){if(i>=e.length)return{done:true};return{done:false,value:e[i++]}},e:function e(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,s=false,o;return{s:function t(){n=e[Symbol.iterator]()},n:function e(){var t=n.next();a=t.done;return t},e:function e(t){s=true;o=t},f:function e(){try{if(!a&&n.return!=null)n.return()}finally{if(s)throw o}}}}function c(e,t){if(!e)return;if(typeof e==="string")return d(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor)n=e.constructor.name;if(n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return d(e,t)}function d(e,t){if(t==null||t>e.length)t=e.length;for(var n=0,i=new Array(t);n<t;n++){i[n]=e[n]}return i}var h=function(){function e(t){babelHelpers.classCallCheck(this,e);this.parent=t;this.signedParameters=this.parent.signedParameters;this.componentName=this.parent.componentName;this.isTimemanAvailable=this.parent.isTimemanAvailable;this.timemanNode=this.parent.timemanNode;this.containerNode=this.parent.ustatOnlineContainerNode;if(this.isTimemanAvailable&&i.Type.isDomNode(this.timemanNode)){this.timemanValueNodes=this.timemanNode.querySelectorAll(".intranet-ustat-online-value");this.timemanTextNodes=this.timemanNode.querySelectorAll(".js-ustat-online-timeman-text");this.resizeTimemanText();this.subscribePullEvent()}}babelHelpers.createClass(e,[{key:"resizeTimemanText",value:function e(){if(!i.Type.isDomNode(this.timemanNode)){return}var t=0;var n=0;if(i.Type.isArrayLike(this.timemanTextNodes)){var r=u(this.timemanTextNodes),a;try{for(r.s();!(a=r.n()).done;){var s=a.value;var o=s.textContent.length;t+=o}}catch(e){r.e(e)}finally{r.f()}}if(i.Type.isArrayLike(this.timemanValueNodes)){var l=u(this.timemanValueNodes),c;try{for(l.s();!(c=l.n()).done;){var d=c.value;var h=d.textContent.length;n+=h}}catch(e){l.e(e)}finally{l.f()}}if(t>=17&&n>=6||t>=19&&n>=4){i.Dom.addClass(this.timemanNode,"intranet-ustat-online-info-text-resize")}else{i.Dom.removeClass(this.timemanNode,"intranet-ustat-online-info-text-resize")}}},{key:"redrawTimeman",value:function e(t){if(t.hasOwnProperty("OPENED")){var n=this.containerNode.querySelector(".js-ustat-online-timeman-opened");if(i.Type.isDomNode(n)){n.innerHTML=t["OPENED"]}}if(t.hasOwnProperty("CLOSED")){var r=this.containerNode.querySelector(".js-ustat-online-timeman-closed");if(i.Type.isDomNode(r)){r.innerHTML=t["CLOSED"]}}this.resizeTimemanText()}},{key:"checkTimeman",value:function e(){var t=this;BX.ajax.runComponentAction(this.componentName,"checkTimeman",{signedParameters:this.signedParameters,mode:"class"}).then(function(e){if(e.data){t.redrawTimeman(e.data)}})}},{key:"subscribePullEvent",value:function e(){var t=this;r.PULL.subscribe({moduleId:"intranet",command:"timemanDayInfo",callback:function e(n){t.redrawTimeman(n)}})}}]);return e}();var p=i.Reflection.namespace("BX.Intranet");var f=function(){function e(t){var n=this;babelHelpers.classCallCheck(this,e);this.signedParameters=t.signedParameters;this.componentName=t.componentName;this.ustatOnlineContainerNode=t.ustatOnlineContainerNode||"";this.maxUserToShow=t.maxUserToShow;this.maxOnlineUserCountToday=t.maxOnlineUserCountToday;this.currentUserId=parseInt(t.currentUserId);this.isTimemanAvailable=t.isTimemanAvailable==="Y";this.isFullAnimationMode=t.isFullAnimationMode==="Y";this.limitOnlineSeconds=t.limitOnlineSeconds;this.renderingFinished=true;if(!i.Type.isDomNode(this.ustatOnlineContainerNode)){return}this.userBlockNode=this.ustatOnlineContainerNode.querySelector(".intranet-ustat-online-icon-box");this.userInnerBlockNode=this.ustatOnlineContainerNode.querySelector(".intranet-ustat-online-icon-inner");this.circleNode=this.ustatOnlineContainerNode.querySelector(".ui-graph-circle");this.timemanNode=this.ustatOnlineContainerNode.querySelector(".intranet-ustat-online-info");var r=t.users;var a=t.allOnlineUserIdToday;this.users=r.map(function(e){e.id=parseInt(e.id);e.offline_date=n.getOfflineDate(e.last_activity_date);return e});this.allOnlineUserIdToday=a.map(function(e){return parseInt(e)});this.online=[].concat(this.users);this.counter=0;this.ITEMS={obClientDb:null,obClientDbData:{},obClientDbDataSearchIndex:{},bMenuInitialized:false,initialized:{sonetgroups:false,menuitems:false},oDbSearchResult:{}};BX.Finder(false,"searchTitle",[],{},this);BX.onCustomEvent(this,"initFinderDb",[this.ITEMS,"searchTitle",null,["users"],this]);if(i.Type.isDomNode(this.ustatOnlineContainerNode)){BX.UI.Hint.init(this.ustatOnlineContainerNode)}new l(this);this.timemanObj=new h(this);var s=new Date;this.currentDate=new Date(s.getFullYear(),s.getMonth(),s.getDate()).valueOf();this.checkOnline();if(this.isFullAnimationMode){setTimeout(function(){n.subscribePullEvent()},3e3);setInterval(function(){return n.checkOnline()},6e4)}else{BX.addCustomEvent(window,"onImUpdateUstatOnline",BX.proxy(this.updateOnlineRestrictedMode,this))}}babelHelpers.createClass(e,[{key:"updateOnlineRestrictedMode",value:function e(t){this.counter=t.count;this.maxOnlineUserCountToday=t.count;this.online=t.users;this.redrawOnline()}},{key:"getOfflineDate",value:function e(t){return t?new Date(t).getTime()+parseInt(this.limitOnlineSeconds)*1e3:null}},{key:"checkOnline",value:function e(){var t=this;this.online=this.online.filter(function(e){return e&&(e.offline_date>+new Date||e.id===t.currentUserId)});var n=this.counter;if(this.online.length>0){this.counter=this.online.map(function(e){return 1}).reduce(function(e){return e+1})}else{this.counter=0}if(this.checkNewDay()||n!==this.counter){this.redrawOnline()}}},{key:"checkNewDay",value:function e(){var t=new Date;var n=new Date(t.getFullYear(),t.getMonth(),t.getDate()).valueOf();if(this.currentDate<n){this.maxOnlineUserCountToday=this.online.length;if(this.isTimemanAvailable){this.timemanObj.checkTimeman()}this.currentDate=n;return true}return false}},{key:"setUserOnline",value:function e(t){var n=this;var i=this.getNumberUserId(t.id);this.findUser(i).then(function(e){e.id=n.getNumberUserId(e.id);if(typeof t.last_activity_date!=="undefined"){e.last_activity_date=t.last_activity_date}if(e.isExtranet!=="Y"){n.setUserToLocal(e);n.checkOnline()}}).catch(function(e){})}},{key:"setUserToLocal",value:function e(t){t.offline_date=this.getOfflineDate(t.last_activity_date);this.users=this.users.filter(function(e){return e.id!==t.id});this.users.push(t);var n=false;this.online.forEach(function(e){if(e.id===t.id){n=true}});if(!n){this.online.unshift(t)}if(this.allOnlineUserIdToday.indexOf(t.id)===-1){this.allOnlineUserIdToday.push(t.id);this.maxOnlineUserCountToday++}}},{key:"setUserOnlineMultiply",value:function e(t){var n=this;var i=[];var r=0;var a=[];t.forEach(function(e){var t=parseInt(e.id);a.push(new Promise(function(e,a){n.findUser(t,true).then(function(t){r++;n.setUserToLocal(t);e()}).catch(function(n){i.push(t);e()})}))});Promise.all(a).then(function(){if(i.length<=0){return false}var e=n.maxUserToShow-r;if(e<=0){return true}i=i.slice(0,e);BX.rest.callMethod("im.user.list.get",{ID:i}).then(function(e){var t=e.data();if(!t){return false}for(var i in t){if(!t.hasOwnProperty(i)){continue}var r=t[i];if(!r){continue}var a={};a.id=parseInt(r.id);a.name=r.name;a.avatar=BX.MessengerCommon.isBlankAvatar(r.avatar)?"":r.avatar;a.last_activity_date=r.last_activity_date;n.setUserToLocal(a)}}).catch(function(e){})})}},{key:"findUser",value:function e(t){var n=this;var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;t=parseInt(t);return new Promise(function(e,r){var a=null;a=n.users.find(function(e){return e.id===t});if(a){e(a);return true}a=n.getUserFromMessenger(t);if(a){e(a);return true}n.getUserFromDb(t).then(function(t){e(t);return true}).catch(function(a){if(i){r(null);return true}n.getUserFromServer(t).then(function(t){n.addUserToDb(t);e(t)}).catch(function(e){r(null)})});return true})}},{key:"getUserFromMessenger",value:function e(t){if(typeof window.BX.MessengerCommon==="undefined"){return null}var n=BX.MessengerCommon.getUser(t);if(!n){return null}var i={id:parseInt(n.id),name:n.name,avatar:BX.MessengerCommon.isBlankAvatar(n.avatar)?"":n.avatar,last_activity_date:null};if(n.last_activity_date instanceof Date){i.last_activity_date=n.last_activity_date.toISOString()}if(typeof n.last_activity_date==="string"){i.last_activity_date=n.last_activity_date}return i}},{key:"getUserFromDb",value:function e(t){var n=this;return new Promise(function(e,i){BX.indexedDB.getValue(n.ITEMS.obClientDb,"users","U"+t).then(function(t){if(t&&babelHelpers.typeof(t)==="object"){if(t.hasOwnProperty("entityId")){t.id=n.getNumberUserId(t.entityId)}e(t)}else{e(null)}}).catch(function(e){i(null)})})}},{key:"addUserToDb",value:function e(t){t.id="U"+t.id;BX.indexedDB.addValue(this.ITEMS.obClientDb,"users",t)}},{key:"getUserFromServer",value:function e(n){return new Promise(function(e,i){if(typeof window.BX.MessengerCommon==="undefined"){e(null);return false}t.rest.callMethod("im.user.get",{id:n}).then(function(t){if(t.data()&&t.data().external_auth_id!=="__controller"){var n={};n.id=parseInt(t.data().id);n.name=t.data().name;n.avatar=BX.MessengerCommon.isBlankAvatar(t.data().avatar)?"":t.data().avatar;n.last_activity_date=t.data().last_activity_date;n.isExtranet=t.data().extranet?"Y":"N";n.active="Y";n.entityId=parseInt(t.data().id);e(n)}else{e(null)}}).catch(function(t){e(null)})})}},{key:"subscribePullEvent",value:function e(){var t=this;BX.PULL.subscribe({type:"online",callback:function e(n){if(n.command==="userStatus"){for(var i in n.params.users){if(!n.params.users.hasOwnProperty(i)){continue}t.setUserOnline(n.params.users[i])}}}})}},{key:"getNumberUserId",value:function e(t){if(!t){return}var n=String(t);n=n.replace("U","");return parseInt(n)}},{key:"isDocumentVisible",value:function e(){return document.visibilityState==="visible"}},{key:"redrawOnline",value:function e(){this.showCircleAnimation(this.circleNode,this.counter,this.maxOnlineUserCountToday);if(this.renderingFinished){this.renderingFinished=false;this.renderAllUser()}}},{key:"renderAllUser",value:function e(){var t=this;var n=[];var r=[];this.online.forEach(function(e){r.push(parseInt(e.id))});var a=r.slice(0,this.maxUserToShow);var s=this.userBlockNode.querySelectorAll(".js-ustat-online-user");if(this.online.length>100&&s.length>=this.maxUserToShow){return}for(var o in s){if(!s.hasOwnProperty(o)){continue}var l=parseInt(s[o].getAttribute("data-user-id"));if(r.indexOf(l)===-1){if(i.Type.isDomNode(s[o])){i.Dom.remove(s[o])}}else{n.push(parseInt(l))}}s=this.userBlockNode.querySelectorAll(".js-ustat-online-user");var u=s.length;var c=u!==0;this.userIndex=this.online.length;var d=function e(r){if(r>=t.maxUserToShow||r>=t.online.length){t.renderingFinished=true;return}new Promise(function(e){var s=t.online[r];if(n.indexOf(s.id)>=0){e();return}if(u<t.maxUserToShow){if(c){t.userIndex++}t.renderUser(s,c);n.push(s.id);u++;if(!c){t.userIndex=t.userIndex-1}e()}else{var o=t.userBlockNode.querySelectorAll(".js-ustat-online-user");var l=o[0];var d="";for(var h=o.length-1;h>=0;h--){if(i.Type.isDomNode(o[h])){var p=parseInt(o[h].getAttribute("data-user-id"));if(a.indexOf(p)===-1){d=o[h];break}}}if(i.Type.isDomNode(d)){var f=parseInt(d.getAttribute("data-user-id"));i.Dom.removeClass(d,"intranet-ustat-online-icon-show");if(t.isDocumentVisible()){i.Dom.addClass(d,"intranet-ustat-online-icon-hide")}t.userIndex=parseInt(l.style.zIndex);t.userIndex++;t.renderUser(s,c);n=n.filter(function(e){return e!==f});n.push(s.id);if(t.isDocumentVisible()){i.Event.bind(d,"animationend",function(t){i.Dom.remove(d);e()})}else{i.Dom.remove(d);e()}}else{e()}}}).then(function(){e(++r)})};d(0)}},{key:"renderUser",value:function e(t,n){if(!t||babelHelpers.typeof(t)!=="object"){return}var r="";if(t.avatar){r='background-image: url("'+t.avatar+'");'}var a=this.getNumberUserId(t.id);var s="ui-icon ui-icon-common-user intranet-ustat-online-icon js-ustat-online-user\n\t\t\t".concat(n&&this.isDocumentVisible()?" intranet-ustat-online-icon-show":"");this.userItem=BX.create("span",{attrs:{className:s,"data-user-id":a},style:{zIndex:this.userIndex},children:[BX.create("i",{attrs:{style:r}})]});if(n){i.Dom.prepend(this.userItem,this.userInnerBlockNode)}else{this.userInnerBlockNode.appendChild(this.userItem)}}},{key:"showCircleAnimation",value:function e(t,n,i){i=parseInt(i);n=parseInt(n);if(n<=0){n=1}if(n>i){i=n}var r=n*100/i;if(!this.circle){this.circle=new a.Circle(t,68,r,n,true);this.circle.show()}else{this.circle.updateCounter(r,n)}}}]);return e}();p.UstatOnline=f;e.UstatOnline=f})(this.BX.Intranet.UstatOnline=this.BX.Intranet.UstatOnline||{},BX,BX.Main,BX,BX,BX.UI.Graph);
//# sourceMappingURL=script.map.js