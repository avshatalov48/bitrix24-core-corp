this.BX=this.BX||{};this.BX.Intranet=this.BX.Intranet||{};(function(e,t,n,i){"use strict";var r=function(){function e(n){var i=this;babelHelpers.classCallCheck(this,e);this.parent=n;this.signedParameters=this.parent.signedParameters;this.componentName=this.parent.componentName;this.userInnerBlockNode=this.parent.userInnerBlockNode||"";this.circleNode=this.parent.circleNode||"";this.isPopupShown=false;this.popupCurrentPage={};this.renderedUsers=[];t.Event.bind(this.userInnerBlockNode,"click",function(){i.showPopup("getAllOnlineUser",i.userInnerBlockNode)});t.Event.bind(this.circleNode,"click",function(){i.showPopup("getAllOnlineUser",i.circleNode,-5)});if(this.parent.isTimemanAvailable&&t.Type.isDomNode(this.parent.timemanNode)){var r=this.parent.timemanNode.querySelector(".js-ustat-online-timeman-opened-block");var a=this.parent.timemanNode.querySelector(".js-ustat-online-timeman-closed-block");t.Event.bind(r,"click",function(){i.showPopup("getOpenedTimemanUser",r)});t.Event.bind(a,"click",function(){i.showPopup("getClosedTimemanUser",a)})}}babelHelpers.createClass(e,[{key:"getPopupTitle",value:function e(n){var i="";if(n==="getAllOnlineUser"){i=t.Loc.getMessage("INTRANET_USTAT_ONLINE_USERS")}else if(n==="getOpenedTimemanUser"){i=t.Loc.getMessage("INTRANET_USTAT_ONLINE_STARTED_DAY")}else if(n==="getClosedTimemanUser"){i=t.Loc.getMessage("INTRANET_USTAT_ONLINE_FINISHED_DAY")}return i}},{key:"showPopup",value:function e(n,i,r){if(this.isPopupShown){return}if(t.Type.isUndefined(r)){r=7}this.popupCurrentPage[n]=1;this.popupInnerContainer="";this.renderedUsers=[];this.allOnlineUserPopup=new BX.PopupWindow("intranet-ustat-online-popup",i,{lightShadow:true,offsetLeft:n==="getClosedTimemanUser"?-60:-22,offsetTop:r,autoHide:true,closeByEsc:true,bindOptions:{position:"bottom"},animationOptions:{show:{type:"opacity-transform"},close:{type:"opacity"}},events:{onPopupDestroy:function(){this.isPopupShown=false}.bind(this),onPopupClose:function e(){this.destroy()},onAfterPopupShow:function(e){var t=e.contentContainer;var i=BX.create("div",{props:{className:"intranet-ustat-online-popup-container"}});var r=BX.create("span",{props:{className:"intranet-ustat-online-popup-name-title"},text:this.getPopupTitle(n)});this.popupInnerContainer=BX.create("div",{props:{className:"intranet-ustat-online-popup-inner"}});var a=BX.create("div",{props:{className:"intranet-ustat-online-popup-content"}});var s=BX.create("div",{props:{className:"intranet-ustat-online-popup-content-box"}});t.appendChild(r);t.appendChild(i);i.appendChild(a);a.appendChild(s);s.appendChild(this.popupInnerContainer);this.loader=this.showLoader({node:a,loader:null,size:40});this.showUsersInPopup(n);this.isPopupShown=true}.bind(this)},className:"intranet-ustat-online-popup"});this.popupScroll(n);this.allOnlineUserPopup.show()}},{key:"popupScroll",value:function e(t){if(!BX.type.isDomNode(this.popupInnerContainer)){return}BX.bind(this.popupInnerContainer,"scroll",BX.delegate(function(){var e=BX.proxy_context;if(e.scrollTop>(e.scrollHeight-e.offsetHeight)/1.5){this.showUsersInPopup(t);BX.unbindAll(e)}},this))}},{key:"showUsersInPopup",value:function e(n){if(n!=="getAllOnlineUser"&&n!=="getOpenedTimemanUser"&&n!=="getClosedTimemanUser"){return}BX.ajax.runComponentAction(this.componentName,n,{signedParameters:this.signedParameters,mode:"class",data:{pageNum:this.popupCurrentPage[n]}}).then(function(e){if(e.data){this.renderPopupUsers(e.data);this.popupCurrentPage[n]++;this.popupScroll(n)}else{if(!this.popupInnerContainer.hasChildNodes()){this.popupInnerContainer.innerText=t.Loc.getMessage("INTRANET_USTAT_ONLINE_EMPTY")}}this.hideLoader({loader:this.loader})}.bind(this),function(e){this.hideLoader({loader:this.loader})}.bind(this))}},{key:"renderPopupUsers",value:function e(t){if(!this.allOnlineUserPopup||!BX.type.isDomNode(this.popupInnerContainer)){return}if(!t||babelHelpers.typeof(t)!=="object"){return}for(var n in t){if(!t.hasOwnProperty(n)){continue}if(this.renderedUsers.indexOf(t[n]["ID"])>=0){continue}this.renderedUsers.push(t[n]["ID"]);var i=void 0;if(BX.type.isNotEmptyString(t[n]["AVATAR"])){i=BX.create("div",{props:{className:"ui-icon ui-icon-common-user intranet-ustat-online-popup-avatar-img"},children:[BX.create("i",{style:{backgroundImage:"url('"+t[n]["AVATAR"]+"')"}})]})}else{i=BX.create("div",{props:{className:"ui-icon ui-icon-common-user intranet-ustat-online-popup-avatar-img"},children:[BX.create("i",{})]})}this.popupInnerContainer.appendChild(BX.create("A",{attrs:{href:t[n]["PATH_TO_USER_PROFILE"],target:"_blank"},props:{className:"intranet-ustat-online-popup-item"},children:[BX.create("SPAN",{props:{className:"intranet-ustat-online-popup-avatar-new"},children:[i,BX.create("SPAN",{props:{className:"intranet-ustat-online-popup-avatar-status-icon"}})]}),BX.create("SPAN",{props:{className:"intranet-ustat-online-popup-name"},html:t[n]["NAME"]})]}))}}},{key:"showLoader",value:function e(t){var n=null;if(t.node){if(t.loader===null){n=new BX.Loader({target:t.node,size:t.hasOwnProperty("size")?t.size:40})}else{n=t.loader}n.show()}return n}},{key:"hideLoader",value:function e(t){if(t.loader!==null){t.loader.hide()}if(t.node){BX.cleanNode(t.node)}if(t.loader!==null){t.loader=null}}}]);return e}();var a=t.Reflection.namespace("BX.Intranet");var s=function(){function e(n){var i=this;babelHelpers.classCallCheck(this,e);this.signedParameters=n.signedParameters;this.componentName=n.componentName;this.userBlockNode=n.userBlockNode||"";this.userInnerBlockNode=n.userInnerBlockNode||"";this.circleNode=n.circleNode||"";this.timemanNode=n.timemanNode||"";this.ustatOnlineContainerNode=n.ustatOnlineContainerNode||"";this.maxUserToShow=7;this.maxOnlineUserCountToday=n.maxOnlineUserCountToday;this.currentUserId=parseInt(n.currentUserId);this.isTimemanAvailable=n.isTimemanAvailable==="Y";this.limitOnlineSeconds=n.limitOnlineSeconds;this.renderingFinished=true;var a=n.users;var s=n.allOnlineUserIdToday;this.users=a.map(function(e){e.id=parseInt(e.id);e.offline_date=i.getOfflineDate(e.last_activity_date);return e});this.allOnlineUserIdToday=s.map(function(e){return parseInt(e)});this.online=[].concat(this.users);this.counter=0;this.ITEMS={obClientDb:null,obClientDbData:{},obClientDbDataSearchIndex:{},bMenuInitialized:false,initialized:{sonetgroups:false,menuitems:false},oDbSearchResult:{}};BX.Finder(false,"searchTitle",[],{},this);BX.onCustomEvent(this,"initFinderDb",[this.ITEMS,"searchTitle",null,["users"],this]);if(t.Type.isDomNode(this.ustatOnlineContainerNode)){BX.UI.Hint.init(this.ustatOnlineContainerNode)}new r(this);var o=new Date;this.currentDate=new Date(o.getFullYear(),o.getMonth(),o.getDate()).valueOf();this.checkOnline();if(this.isTimemanAvailable&&t.Type.isDomNode(this.timemanNode)){this.timemanValueNodes=this.timemanNode.querySelectorAll(".intranet-ustat-online-value");this.timemanTextNodes=this.timemanNode.querySelectorAll(".js-ustat-online-timeman-text");this.resizeTimemanText()}setTimeout(function(){i.subscribePullEvent()},3e3);setInterval(function(){return i.checkOnline()},6e4)}babelHelpers.createClass(e,[{key:"getOfflineDate",value:function e(t){return t?new Date(t).getTime()+parseInt(this.limitOnlineSeconds)*1e3:null}},{key:"checkOnline",value:function e(){var t=this;this.online=this.online.filter(function(e){return e&&(e.offline_date>+new Date||e.id===t.currentUserId)});var n=this.counter;if(this.online.length>0){this.counter=this.online.map(function(e){return 1}).reduce(function(e){return e+1})}else{this.counter=0}if(this.checkNewDay()||n!==this.counter){this.redrawOnline()}}},{key:"checkNewDay",value:function e(){var t=new Date;var n=new Date(t.getFullYear(),t.getMonth(),t.getDate()).valueOf();if(this.currentDate<n){this.maxOnlineUserCountToday=this.online.length;if(this.isTimemanAvailable){this.checkTimeman()}this.currentDate=n;return true}return false}},{key:"checkTimeman",value:function e(){BX.ajax.runComponentAction(this.componentName,"checkTimeman",{signedParameters:this.signedParameters,mode:"class"}).then(function(e){if(e.data){this.redrawTimeman(e.data)}}.bind(this),function(e){}.bind(this))}},{key:"setUserOnline",value:function e(t){var n=this;var i=this.getNumberUserId(t.id);this.findUser(i).then(function(e){e.id=n.getNumberUserId(e.id);if(typeof t.last_activity_date!=="undefined"){e.last_activity_date=t.last_activity_date}if(e.isExtranet!=="Y"){n.setUserToLocal(e);n.checkOnline()}}).catch(function(e){})}},{key:"setUserToLocal",value:function e(t){t.offline_date=this.getOfflineDate(t.last_activity_date);this.users=this.users.filter(function(e){return e.id!==t.id});this.users.push(t);var n=false;this.online.forEach(function(e){if(e.id===t.id){n=true}});if(!n){this.online.unshift(t)}if(this.allOnlineUserIdToday.indexOf(t.id)===-1){this.allOnlineUserIdToday.push(t.id);this.maxOnlineUserCountToday++}}},{key:"setUserOnlineMultiply",value:function e(t){var n=this;var i=[];var r=0;var a=[];t.forEach(function(e){var t=parseInt(e.id);a.push(new Promise(function(e,a){n.findUser(t,true).then(function(t){r++;n.setUserToLocal(t);e()}).catch(function(n){i.push(t);e()})}))});Promise.all(a).then(function(){if(i.length<=0){return false}var e=n.maxUserToShow-r;if(e<=0){return true}i=i.slice(0,e);BX.rest.callMethod("im.user.list.get",{ID:i}).then(function(e){var t=e.data();if(!t){return false}for(var i in t){if(!t.hasOwnProperty(i)){continue}var r=t[i];if(!r){continue}var a={};a.id=parseInt(r.id);a.name=r.name;a.avatar=BX.MessengerCommon.isBlankAvatar(r.avatar)?"":r.avatar;a.last_activity_date=r.last_activity_date;n.setUserToLocal(a)}}).catch(function(e){})})}},{key:"findUser",value:function e(t){var n=this;var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;t=parseInt(t);return new Promise(function(e,r){var a=null;a=n.users.find(function(e){return e.id===t});if(a){e(a);return true}a=n.getUserFromMessenger(t);if(a){e(a);return true}n.getUserFromDb(t).then(function(t){e(t);return true}).catch(function(a){if(i){r(null);return true}n.getUserFromServer(t).then(function(t){n.addUserToDb(t);e(t)}).catch(function(e){r(null)})});return true})}},{key:"getUserFromMessenger",value:function e(t){if(typeof window.BX.MessengerCommon==="undefined"){return null}var n=BX.MessengerCommon.getUser(t);if(!n){return null}var i={id:parseInt(n.id),name:n.name,avatar:BX.MessengerCommon.isBlankAvatar(n.avatar)?"":n.avatar,last_activity_date:null};if(n.last_activity_date instanceof Date){i.last_activity_date=n.last_activity_date.toISOString()}if(typeof n.last_activity_date==="string"){i.last_activity_date=n.last_activity_date}return i}},{key:"getUserFromDb",value:function e(t){var n=this;return new Promise(function(e,i){BX.indexedDB.getValue(n.ITEMS.obClientDb,"users","U"+t).then(function(t){if(t&&babelHelpers.typeof(t)==="object"){if(t.hasOwnProperty("entityId")){t.id=n.getNumberUserId(t.entityId)}e(t)}else{e(null)}}).catch(function(e){i(null)})})}},{key:"addUserToDb",value:function e(t){t.id="U"+t.id;BX.indexedDB.addValue(this.ITEMS.obClientDb,"users",t)}},{key:"getUserFromServer",value:function e(t){return new Promise(function(e,i){if(typeof window.BX.MessengerCommon==="undefined"){e(null);return false}n.rest.callMethod("im.user.get",{id:t}).then(function(t){if(t.data()&&t.data().external_auth_id!=="__controller"){var n={};n.id=parseInt(t.data().id);n.name=t.data().name;n.avatar=BX.MessengerCommon.isBlankAvatar(t.data().avatar)?"":t.data().avatar;n.last_activity_date=t.data().last_activity_date;n.isExtranet=t.data().extranet?"Y":"N";n.active="Y";n.entityId=parseInt(t.data().id);e(n)}else{e(null)}}).catch(function(t){e(null)})})}},{key:"subscribePullEvent",value:function e(){var t=this;i.PULL.subscribe({type:i.PullClient.SubscriptionType.Online,callback:function e(n){if(n.command==="userStatus"){for(var i in n.params.users){if(!n.params.users.hasOwnProperty(i)){continue}t.setUserOnline(n.params.users[i])}}}});i.PULL.subscribe({moduleId:"intranet",command:"timemanDayInfo",callback:function e(n){t.redrawTimeman(n)}})}},{key:"redrawTimeman",value:function e(t){if(t.hasOwnProperty("OPENED")){var n=document.querySelector(".js-ustat-online-timeman-opened");if(BX.type.isDomNode(n)){n.innerHTML=t["OPENED"]}}if(t.hasOwnProperty("CLOSED")){var i=document.querySelector(".js-ustat-online-timeman-closed");if(BX.type.isDomNode(i)){i.innerHTML=t["CLOSED"]}}this.resizeTimemanText()}},{key:"resizeTimemanText",value:function e(){if(!t.Type.isDomNode(this.timemanNode)){return}var n=0;var i=0;if(t.Type.isArrayLike(this.timemanTextNodes)){var r=true;var a=false;var s=undefined;try{for(var o=this.timemanTextNodes[Symbol.iterator](),l;!(r=(l=o.next()).done);r=true){var u=l.value;var d=u.textContent.length;n+=d}}catch(e){a=true;s=e}finally{try{if(!r&&o.return!=null){o.return()}}finally{if(a){throw s}}}}if(t.Type.isArrayLike(this.timemanValueNodes)){var c=true;var h=false;var p=undefined;try{for(var f=this.timemanValueNodes[Symbol.iterator](),m;!(c=(m=f.next()).done);c=true){var v=m.value;var y=v.textContent.length;i+=y}}catch(e){h=true;p=e}finally{try{if(!c&&f.return!=null){f.return()}}finally{if(h){throw p}}}}if(n>=17&&i>=6||n>=19&&i>=4){t.Dom.addClass(this.timemanNode,"intranet-ustat-online-info-text-resize")}else{t.Dom.removeClass(this.timemanNode,"intranet-ustat-online-info-text-resize")}}},{key:"getNumberUserId",value:function e(t){if(!t){return}var n=String(t);n=n.replace("U","");return parseInt(n)}},{key:"redrawOnline",value:function e(){this.showCircleAnimation(this.circleNode,this.counter,this.maxOnlineUserCountToday);if(this.renderingFinished){this.renderingFinished=false;this.renderAllUser()}}},{key:"renderAllUser",value:function e(){var n=this;var i=[];var r=[];this.online.forEach(function(e){r.push(parseInt(e.id))});var a=r.slice(0,this.maxUserToShow);var s=this.userBlockNode.querySelectorAll(".js-ustat-online-user");if(s){for(var o in s){if(!s.hasOwnProperty(o)){continue}var l=parseInt(s[o].getAttribute("data-user-id"));if(r.indexOf(l)===-1){if(t.Type.isDomNode(s[o])){t.Dom.remove(s[o])}}else{i.push(parseInt(l))}}}s=this.userBlockNode.querySelectorAll(".js-ustat-online-user");var u=s.length;var d=u!==0;this.userIndex=this.online.length;var c=function e(r){if(r>=n.maxUserToShow||r>=n.online.length){n.renderingFinished=true;return}new Promise(function(e){var s=n.online[r];if(i.indexOf(s.id)>=0){e();return}if(u<n.maxUserToShow){if(d){n.userIndex++}n.renderUser(s,d);i.push(s.id);u++;if(!d){n.userIndex=n.userIndex-1}e()}else{var o=n.userBlockNode.querySelectorAll(".js-ustat-online-user");var l=o[0];var c="";for(var h=o.length-1;h>=0;h--){if(t.Type.isDomNode(o[h])){var p=parseInt(o[h].getAttribute("data-user-id"));if(a.indexOf(p)===-1){c=o[h];break}}}if(t.Type.isDomNode(c)){var f=parseInt(c.getAttribute("data-user-id"));t.Dom.removeClass(c,"intranet-ustat-online-icon-show");t.Dom.addClass(c,"intranet-ustat-online-icon-hide");n.userIndex=parseInt(l.style.zIndex);n.userIndex++;n.renderUser(s,d);i=i.filter(function(e){return e!==f});i.push(s.id);t.Event.bind(c,"animationend",function(n){t.Dom.remove(c);e()})}else{e()}}}).then(function(){e(++r)})};c(0)}},{key:"renderUser",value:function e(n,i){if(!n||babelHelpers.typeof(n)!=="object"){return}var r="";if(n.avatar){r='background-image: url("'+n.avatar+'");'}var a=this.getNumberUserId(n.id);var s="ui-icon ui-icon-common-user intranet-ustat-online-icon js-ustat-online-user\n\t\t\t".concat(i?" intranet-ustat-online-icon-show":"");this.userItem=BX.create("span",{attrs:{className:s,"data-user-id":a},style:{zIndex:this.userIndex},children:[BX.create("i",{attrs:{style:r}})]});if(i){t.Dom.prepend(this.userItem,this.userInnerBlockNode)}else{this.userInnerBlockNode.appendChild(this.userItem)}}},{key:"showCircleAnimation",value:function e(t,n,i){i=parseInt(i);n=parseInt(n);if(n<=0){n=1}if(n>i){i=n}var r=n*100/i;if(!this.circle){this.circle=new BX.UI.Graph.Circle(t,68,r,n);this.circle.show()}else{this.circle.updateCounter(r,n)}}}]);return e}();a.UstatOnline=s})(this.BX.Intranet.UstatOnline=this.BX.Intranet.UstatOnline||{},BX,BX,BX);
//# sourceMappingURL=script.map.js