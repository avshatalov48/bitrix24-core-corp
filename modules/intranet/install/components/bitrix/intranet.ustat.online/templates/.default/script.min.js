this.BX=this.BX||{};this.BX.Intranet=this.BX.Intranet||{};(function(e,t,n,i){"use strict";var a=function(){function e(n){var i=this;babelHelpers.classCallCheck(this,e);this.parent=n;this.signedParameters=this.parent.signedParameters;this.componentName=this.parent.componentName;this.userInnerBlockNode=this.parent.userInnerBlockNode||"";this.isPopupShown=false;this.popupCurrentPage={};t.Event.bind(this.userInnerBlockNode,"click",function(){i.showPopup("getAllOnlineUser",i.userInnerBlockNode)});if(this.parent.isTimemanAvailable&&t.Type.isDomNode(this.parent.timemanNode)){var a=this.parent.timemanNode.querySelector(".js-ustat-online-timeman-opened-block");var s=this.parent.timemanNode.querySelector(".js-ustat-online-timeman-closed-block");t.Event.bind(a,"click",function(){i.showPopup("getOpenedTimemanUser",a)});t.Event.bind(s,"click",function(){i.showPopup("getClosedTimemanUser",s)})}}babelHelpers.createClass(e,[{key:"getPopupTitle",value:function e(n){var i="";if(n==="getAllOnlineUser"){i=t.Loc.getMessage("INTRANET_USTAT_ONLINE_USERS")}else if(n==="getOpenedTimemanUser"){i=t.Loc.getMessage("INTRANET_USTAT_ONLINE_STARTED_DAY")}else if(n==="getClosedTimemanUser"){i=t.Loc.getMessage("INTRANET_USTAT_ONLINE_FINISHED_DAY")}return i}},{key:"showPopup",value:function e(t,n){if(this.isPopupShown){return}this.popupCurrentPage[t]=1;this.popupInnerContainer="";this.allOnlineUserPopup=new BX.PopupWindow("intranet-ustat-online-popup",n,{lightShadow:true,offsetLeft:t==="getClosedTimemanUser"?-60:-22,offsetTop:7,autoHide:true,closeByEsc:true,bindOptions:{position:"bottom"},animationOptions:{show:{type:"opacity-transform"},close:{type:"opacity"}},events:{onPopupDestroy:function(){this.isPopupShown=false}.bind(this),onPopupClose:function e(){this.destroy()},onAfterPopupShow:function(e){var n=e.contentContainer;var i=BX.create("div",{props:{className:"intranet-ustat-online-popup-container"}});var a=BX.create("span",{props:{className:"intranet-ustat-online-popup-name-title"},text:this.getPopupTitle(t)});this.popupInnerContainer=BX.create("div",{props:{className:"intranet-ustat-online-popup-inner"}});var s=BX.create("div",{props:{className:"intranet-ustat-online-popup-content"}});var r=BX.create("div",{props:{className:"intranet-ustat-online-popup-content-box"}});n.appendChild(a);n.appendChild(i);i.appendChild(s);s.appendChild(r);r.appendChild(this.popupInnerContainer);this.loader=this.showLoader({node:s,loader:null,size:40});this.showUsersInPopup(t);this.isPopupShown=true}.bind(this)},className:"intranet-ustat-online-popup"});this.popupScroll(t);this.allOnlineUserPopup.show()}},{key:"popupScroll",value:function e(t){if(!BX.type.isDomNode(this.popupInnerContainer)){return}BX.bind(this.popupInnerContainer,"scroll",BX.delegate(function(){var e=BX.proxy_context;if(e.scrollTop>(e.scrollHeight-e.offsetHeight)/1.5){this.showUsersInPopup(t);BX.unbindAll(e)}},this))}},{key:"showUsersInPopup",value:function e(n){if(n!=="getAllOnlineUser"&&n!=="getOpenedTimemanUser"&&n!=="getClosedTimemanUser"){return}BX.ajax.runComponentAction(this.componentName,n,{signedParameters:this.signedParameters,mode:"class",data:{pageNum:this.popupCurrentPage[n]}}).then(function(e){if(e.data){this.renderPopupUsers(e.data);this.popupCurrentPage[n]++;this.popupScroll(n)}else{if(!this.popupInnerContainer.hasChildNodes()){this.popupInnerContainer.innerText=t.Loc.getMessage("INTRANET_USTAT_ONLINE_EMPTY")}}this.hideLoader({loader:this.loader})}.bind(this),function(e){this.hideLoader({loader:this.loader})}.bind(this))}},{key:"renderPopupUsers",value:function e(t){if(!this.allOnlineUserPopup||!BX.type.isDomNode(this.popupInnerContainer)){return}if(!t||babelHelpers.typeof(t)!=="object"){return}for(var n in t){if(!t.hasOwnProperty(n)){continue}var i=void 0;if(BX.type.isNotEmptyString(t[n]["AVATAR"])){i=BX.create("div",{props:{className:"ui-icon ui-icon-common-user intranet-ustat-online-popup-avatar-img"},children:[BX.create("i",{style:{backgroundImage:"url('"+t[n]["AVATAR"]+"')"}})]})}else{i=BX.create("div",{props:{className:"ui-icon ui-icon-common-user intranet-ustat-online-popup-avatar-img"},children:[BX.create("i",{})]})}this.popupInnerContainer.appendChild(BX.create("A",{attrs:{href:t[n]["PATH_TO_USER_PROFILE"],target:"_blank"},props:{className:"intranet-ustat-online-popup-item"},children:[BX.create("SPAN",{props:{className:"intranet-ustat-online-popup-avatar-new"},children:[i,BX.create("SPAN",{props:{className:"intranet-ustat-online-popup-avatar-status-icon"}})]}),BX.create("SPAN",{props:{className:"intranet-ustat-online-popup-name"},html:t[n]["NAME"]})]}))}}},{key:"showLoader",value:function e(t){var n=null;if(t.node){if(t.loader===null){n=new BX.Loader({target:t.node,size:t.hasOwnProperty("size")?t.size:40})}else{n=t.loader}n.show()}return n}},{key:"hideLoader",value:function e(t){if(t.loader!==null){t.loader.hide()}if(t.node){BX.cleanNode(t.node)}if(t.loader!==null){t.loader=null}}}]);return e}();var s=t.Reflection.namespace("BX.Intranet");var r=function(){function e(n){var i=this;babelHelpers.classCallCheck(this,e);this.signedParameters=n.signedParameters;this.componentName=n.componentName;this.userBlockNode=n.userBlockNode||"";this.userInnerBlockNode=n.userInnerBlockNode||"";this.circleNode=n.circleNode||"";this.timemanNode=n.timemanNode||"";this.ustatOnlineContainerNode=n.ustatOnlineContainerNode||"";this.maxUserToShow=7;this.maxOnlineUserCountToday=n.maxOnlineUserCountToday;this.currentUserId=parseInt(n.currentUserId);this.isTimemanAvailable=n.isTimemanAvailable==="Y";this.limitOnlineSeconds=n.limitOnlineSeconds;var s=n.users;var r=n.allOnlineUserIdToday;this.users=s.map(function(e){e.id=parseInt(e.id);e.offline_date=i.getOfflineDate(e.last_activity_date);return e});this.allOnlineUserIdToday=r.map(function(e){return parseInt(e)});this.online=[].concat(this.users);this.counter=0;this.ITEMS={obClientDb:null,obClientDbData:{},obClientDbDataSearchIndex:{},bMenuInitialized:false,initialized:{sonetgroups:false,menuitems:false},oDbSearchResult:{}};BX.Finder(false,"searchTitle",[],{},this);BX.onCustomEvent(this,"initFinderDb",[this.ITEMS,"searchTitle",null,["users"],this]);if(t.Type.isDomNode(this.ustatOnlineContainerNode)){BX.UI.Hint.init(this.ustatOnlineContainerNode)}new a(this);var o=new Date;this.currentDate=new Date(o.getFullYear(),o.getMonth(),o.getDate()).valueOf();this.checkOnline();if(this.isTimemanAvailable&&t.Type.isDomNode(this.timemanNode)){this.timemanValueNodes=this.timemanNode.querySelectorAll(".intranet-ustat-online-value");this.timemanTextNodes=this.timemanNode.querySelectorAll(".js-ustat-online-timeman-text");this.resizeTimemanText()}setTimeout(function(){i.subscribePullEvent()},3e3);setInterval(function(){return i.checkOnline()},6e4)}babelHelpers.createClass(e,[{key:"getOfflineDate",value:function e(t){return t?new Date(t).getTime()+parseInt(this.limitOnlineSeconds)*1e3:null}},{key:"checkOnline",value:function e(){var t=this;this.online=this.online.filter(function(e){return e&&(e.offline_date>+new Date||e.id===t.currentUserId)});var n=this.counter;if(this.online.length>0){this.counter=this.online.map(function(e){return 1}).reduce(function(e){return e+1})}else{this.counter=0}if(this.checkNewDay()||n!==this.counter){this.redrawOnline()}}},{key:"checkNewDay",value:function e(){var t=new Date;var n=new Date(t.getFullYear(),t.getMonth(),t.getDate()).valueOf();if(this.currentDate<n){this.maxOnlineUserCountToday=this.online.length;if(this.isTimemanAvailable){this.checkTimeman()}this.currentDate=n;return true}return false}},{key:"checkTimeman",value:function e(){BX.ajax.runComponentAction(this.componentName,"checkTimeman",{signedParameters:this.signedParameters,mode:"class"}).then(function(e){if(e.data){this.redrawTimeman(e.data)}}.bind(this),function(e){}.bind(this))}},{key:"setUserOnline",value:function e(t){var n=this;var i=parseInt(t.id);this.findUser(i).then(function(e){if(typeof t.last_activity_date!=="undefined"){e.last_activity_date=t.last_activity_date}n.setUserToLocal(e);n.checkOnline()}).catch(function(e){})}},{key:"setUserToLocal",value:function e(t){t.offline_date=this.getOfflineDate(t.last_activity_date);this.users=this.users.filter(function(e){return e.id!==t.id});this.users.push(t);var n=false;this.online.forEach(function(e){if(e.id===t.id){n=true}});if(!n){this.online.unshift(t)}if(this.allOnlineUserIdToday.indexOf(t.id)===-1){this.allOnlineUserIdToday.push(t.id);this.maxOnlineUserCountToday++}}},{key:"setUserOnlineMultiply",value:function e(t){var n=this;var i=[];var a=0;var s=[];t.forEach(function(e){var t=parseInt(e.id);s.push(new Promise(function(e,s){n.findUser(t,true).then(function(t){a++;n.setUserToLocal(t);e()}).catch(function(n){i.push(t);e()})}))});Promise.all(s).then(function(){if(i.length<=0){return false}var e=n.maxUserToShow-a;if(e<=0){return true}i=i.slice(0,e);BX.rest.callMethod("im.user.list.get",{ID:i}).then(function(e){var t=e.data();if(!t){return false}for(var i in t){if(!t.hasOwnProperty(i)){continue}var a=t[i];if(!a){continue}var s={};s.id=parseInt(a.id);s.name=a.name;s.avatar=BX.MessengerCommon.isBlankAvatar(a.avatar)?"":a.avatar;s.last_activity_date=a.last_activity_date;n.setUserToLocal(s)}}).catch(function(e){})})}},{key:"findUser",value:function e(t){var n=this;var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;t=parseInt(t);return new Promise(function(e,a){var s=null;s=n.users.find(function(e){return e.id===t});if(s){e(s);return true}s=n.getUserFromMessenger(t);if(s){e(s);return true}n.getUserFromDb(t).then(function(t){e(t);return true}).catch(function(s){if(i){a(null);return true}n.getUserFromServer(t).then(function(t){n.addUserToDb(t);e(t)}).catch(function(e){a(null)})});return true})}},{key:"getUserFromMessenger",value:function e(t){if(typeof window.BX.MessengerCommon==="undefined"){return null}var n=BX.MessengerCommon.getUser(t);if(!n){return null}var i={id:parseInt(n.id),name:n.name,avatar:BX.MessengerCommon.isBlankAvatar(n.avatar)?"":n.avatar,last_activity_date:null};if(n.last_activity_date instanceof Date){i.last_activity_date=n.last_activity_date.toISOString()}if(typeof n.last_activity_date==="string"){i.last_activity_date=n.last_activity_date}return i}},{key:"getUserFromDb",value:function e(t){var n=this;return new Promise(function(e,i){BX.indexedDB.getValue(n.ITEMS.obClientDb,"users","U"+t).then(function(t){if(t&&babelHelpers.typeof(t)==="object"){if(t.hasOwnProperty("entityId")){t.id=t.entityId}e(t)}else{e(null)}}).catch(function(e){i(null)})})}},{key:"addUserToDb",value:function e(t){t.id="U"+t.id;BX.indexedDB.addValue(this.ITEMS.obClientDb,"users",t)}},{key:"getUserFromServer",value:function e(t){return new Promise(function(e,i){if(typeof window.BX.MessengerCommon==="undefined"){e(null);return false}n.rest.callMethod("im.user.get",{id:t}).then(function(t){if(t.data()){var n={};n.id=parseInt(t.data().id);n.name=t.data().name;n.avatar=BX.MessengerCommon.isBlankAvatar(t.data().avatar)?"":t.data().avatar;n.last_activity_date=t.data().last_activity_date;n.isExtranet=t.data().extranet?"Y":"N";n.active="Y";n.entityId=parseInt(t.data().id);e(n)}else{e(null)}}).catch(function(t){e(null)})})}},{key:"subscribePullEvent",value:function e(){var t=this;i.PULL.subscribe({type:i.PullClient.SubscriptionType.Online,callback:function e(n){if(n.command==="userStatus"){for(var i in n.params.users){if(!n.params.users.hasOwnProperty(i)){continue}t.setUserOnline(n.params.users[i])}}}});i.PULL.subscribe({moduleId:"intranet",command:"timemanDayInfo",callback:function e(n){t.redrawTimeman(n)}})}},{key:"redrawTimeman",value:function e(t){if(t.hasOwnProperty("OPENED")){var n=document.querySelector(".js-ustat-online-timeman-opened");if(BX.type.isDomNode(n)){n.innerHTML=t["OPENED"]}}if(t.hasOwnProperty("CLOSED")){var i=document.querySelector(".js-ustat-online-timeman-closed");if(BX.type.isDomNode(i)){i.innerHTML=t["CLOSED"]}}this.resizeTimemanText()}},{key:"resizeTimemanText",value:function e(){if(!t.Type.isDomNode(this.timemanNode)){return}var n=0;var i=0;if(t.Type.isArrayLike(this.timemanTextNodes)){this.timemanTextNodes.forEach(function(e){var t=e.textContent.length;n+=t})}if(t.Type.isArrayLike(this.timemanValueNodes)){this.timemanValueNodes.forEach(function(e){var t=e.textContent.length;i+=t})}if(n>=17&&i>=6||n>=19&&i>=4){t.Dom.addClass(this.timemanNode,"intranet-ustat-online-info-text-resize")}else{t.Dom.removeClass(this.timemanNode,"intranet-ustat-online-info-text-resize")}}},{key:"redrawOnline",value:function e(){this.showCircleAnimation(this.circleNode,this.counter,this.maxOnlineUserCountToday);this.renderAllUser()}},{key:"renderAllUser",value:function e(){var n=this;var i=[];var a=[];this.online.forEach(function(e){a.push(parseInt(e.id))});var s=this.userBlockNode.querySelectorAll(".js-ustat-online-user");if(s){for(var r in s){if(!s.hasOwnProperty(r)){continue}var o=parseInt(s[r].getAttribute("data-user-id"));if(a.indexOf(o)===-1){if(t.Type.isDomNode(s[r])){t.Dom.remove(s[r])}}else{i.push(parseInt(o))}}}s=this.userBlockNode.querySelectorAll(".js-ustat-online-user");var l=s.length;this.online.forEach(function(e,a){if(a>=n.maxUserToShow||!e.hasOwnProperty("id")){return}if(i.indexOf(e.id)===-1){if(l<n.maxUserToShow){n.renderUser(e);l++}else{var s=n.userBlockNode.querySelector(".js-ustat-online-user");if(t.Type.isDomNode(s)){var r=parseInt(s.getAttribute("data-user-id"));t.Dom.remove(s);n.renderUser(e);i=i.filter(function(e){return e!==r});i.push(e.id)}}}})}},{key:"renderUser",value:function e(t){if(!t||babelHelpers.typeof(t)!=="object"){return}var n="";if(t.avatar){n='background-image: url("'+t.avatar+'");'}this.userItem=BX.create("span",{attrs:{className:"ui-icon ui-icon-common-user intranet-ustat-online-icon intranet-ustat-online-icon-show js-ustat-online-user","data-user-id":t.id},children:[BX.create("i",{attrs:{style:n}})]});this.userBlockNode.appendChild(this.userInnerBlockNode);this.userInnerBlockNode.appendChild(this.userItem)}},{key:"showCircleAnimation",value:function e(t,n,i){i=parseInt(i);n=parseInt(n);if(n<=0){n=1}if(n>i){i=n}var a=n*100/i;if(!this.circle){this.circle=new BX.UI.Graph.Circle(t,68,a,n);this.circle.show()}else{this.circle.updateCounter(a,n)}}}]);return e}();s.UstatOnline=r})(this.BX.Intranet.UstatOnline=this.BX.Intranet.UstatOnline||{},BX,BX,BX);
//# sourceMappingURL=script.map.js