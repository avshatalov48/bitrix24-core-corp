function JCCalendarViewMonth(){this.ID="month";this._parent=null;this.SETTINGS={};this.ENTRIES=[];if(!window._MONTH_STYLE_LOADED){BX.loadCSS("/bitrix/components/bitrix/intranet.absence.calendar.view/templates/month/view.css");window._MONTH_STYLE_LOADED=true}BX.bind(window,"resize",BX.proxy(this.__onresize,this))}JCCalendarViewMonth.prototype.__onresize=function(){this.UnloadData(true);this.__drawData()};JCCalendarViewMonth.prototype.Load=function(){this._parent.FILTER.SHORT_EVENTS="N";if(null!=this.ENTRIES&&this.ENTRIES.length>0)this.UnloadData();this.__drawLayout();this.TYPE_BGCOLORS=this._parent.TYPE_BGCOLORS;this._parent.LoadData(this.SETTINGS.DATE_START,this.SETTINGS.DATE_FINISH)};JCCalendarViewMonth.prototype.SetSettings=function(t){this.SETTINGS=t;today=new Date;if(null==this.SETTINGS.DATE_START||today>=this.SETTINGS.DATE_START&&today<=this.SETTINGS.DATE_FINISH)this.SETTINGS.DATE_START=today;this.SETTINGS.DATE_START.setDate(1);this.SETTINGS.DATE_START.setHours(0);this.SETTINGS.DATE_START.setMinutes(0);this.SETTINGS.DATE_START.setSeconds(0);this.SETTINGS.DATE_START.setMilliseconds(0);this.SETTINGS.DATE_FINISH=new Date(this.SETTINGS.DATE_START.valueOf());this.SETTINGS.DATE_FINISH.setMonth(this.SETTINGS.DATE_FINISH.getMonth()+1,1)};JCCalendarViewMonth.prototype.Unload=function(){this._parent.FILTER.SHORT_EVENTS="Y";BX.unbind(window,"resize",BX.proxy(this.__onresize,this));this.UnloadData()};JCCalendarViewMonth.prototype.UnloadData=function(t){if(null==this.ENTRIES)return;if(null==t)t=false;for(var e=0;e<this.ENTRIES.length;e++){if(null!=this.ENTRIES[e].DATA){for(var a=0;a<this.ENTRIES[e].DATA.length;a++){if(null==this.ENTRIES[e].DATA[a].VISUAL)continue;this._parent.UnRegisterEntry(this.ENTRIES[e].DATA[a]);BX.cleanNode(this.ENTRIES[e].DATA[a].VISUAL,true);this.ENTRIES[e].DATA[a].VISUAL=null}}var n=BX("bx_calendar_user_"+this.ENTRIES[e]["ID"]);if(null!=n){n.parentNode.removeChild(n);delete n}}if(!t)this.ENTRIES=null};JCCalendarViewMonth.prototype.LoadData=function(t){this.ENTRIES=t;if(BX.browser.IsIE())setTimeout(BX.proxy(this.__drawData,this),10);else this.__drawData()};JCCalendarViewMonth.prototype.changeMonth=function(t){this.SETTINGS.DATE_START.setMonth(this.SETTINGS.DATE_START.getMonth()+t);this.SETTINGS.DATE_FINISH=new Date(this.SETTINGS.DATE_START);this.SETTINGS.DATE_FINISH.setMonth(this.SETTINGS.DATE_FINISH.getMonth()+1);this.Load()};JCCalendarViewMonth.prototype.changeYear=function(t){if(t!=-1)t=1;this.SETTINGS.DATE_START.setYear(this.SETTINGS.DATE_START.getFullYear()+t);this.SETTINGS.DATE_FINISH=new Date(this.SETTINGS.DATE_START);this.SETTINGS.DATE_FINISH.setMonth(this.SETTINGS.DATE_FINISH.getMonth()+1);this.Load()};JCCalendarViewMonth.prototype.__drawLayout=function(){var t=this;var e=new Date;e.setHours(0);e.setMinutes(0);e.setSeconds(0);e.setMilliseconds(0);this._parent.CONTROLS.CALENDAR.innerHTML="";this.obTable=document.createElement("TABLE");this.obTable.className="bx-calendar-month-main-table";this.obTable.setAttribute("cellSpacing","0");this._parent.CONTROLS.CALENDAR.appendChild(this.obTable);this.obTable.appendChild(document.createElement("TBODY"));var a=this.obTable.tBodies[0].insertRow(-1);a.insertCell(-1);a.cells[0].className="bx-calendar-empty";a.cells[0].innerHTML="&nbsp;";var n=this.SETTINGS.DATE_START.getMonth();this._parent.CONTROLS.DATEROW.innerHTML='<table class="bx-calendar-month-control-table" align="center"><tr>'+'<td class="bx-calendar-month-control-text"><a href="javascript:void(0)" class="bx-calendar-month-change2">'+this._parent.MONTHS[n-2<0?n+10:n-2]+"</a></td>"+'<td class="bx-calendar-month-control-text"><a href="javascript:void(0)" class="bx-calendar-month-change1">'+this._parent.MONTHS[n-1<0?n+11:n-1]+"</a></td>"+'<td><a href="javascript:void(0)" class="bx-calendar-month-icon bx-calendar-month-back"></a></td>'+'<td class="bx-calendar-month-control-text">'+this._parent.MONTHS[this.SETTINGS.DATE_START.getMonth()]+", "+this.SETTINGS.DATE_START.getFullYear()+"</td>"+'<td><a href="javascript:void(0)" class="bx-calendar-month-icon bx-calendar-month-fwd"></a></td>'+'<td class="bx-calendar-month-control-text"><a href="javascript:void(0)" class="bx-calendar-month-change1">'+this._parent.MONTHS[n+1>11?n-11:n+1]+"</a></td>"+'<td class="bx-calendar-month-control-text"><a href="javascript:void(0)" class="bx-calendar-month-change2">'+this._parent.MONTHS[n+2>11?n-10:n+2]+"</a></td>"+"</tr></table>";var T=this._parent.CONTROLS.DATEROW.getElementsByTagName("A");T[0].onclick=function(){t.changeMonth(-2)};T[1].onclick=function(){t.changeMonth(-1)};T[2].onclick=function(){t.changeMonth(-1)};T[3].onclick=function(){t.changeMonth(1)};T[4].onclick=function(){t.changeMonth(1)};T[5].onclick=function(){t.changeMonth(2)};var i=this.SETTINGS.DATE_START.getMonth();var s=new Date(this.SETTINGS.DATE_START.valueOf());var h=this._parent.isViewRegistered("day");while(s.getMonth()==i){var E=a.insertCell(-1);E.className="bx-calendar-month-day";if(s.valueOf()==e.valueOf())E.className+=" bx-calendar-month-today";if(s.getDay()==0||s.getDay()==6)E.className+=" bx-calendar-month-holiday";var r=""+s.getDate();if(r<10)r="0"+r;if(h){var o=E.appendChild(document.createElement("A"));o.href="javascript:void(0)";o.BX_DAY=new Date(s.valueOf());o.onclick=function(){t.SETTINGS.DATE_START=this.BX_DAY;t.SETTINGS.DATE_FINISH=this.BX_DAY;t._parent.SetView("day")};o.innerHTML=r}else{E.innerHTML=r}s.setDate(s.getDate()+1)}this._parent.CONTROLS.CALENDAR.appendChild(document.createElement("BR"));this._parent.CONTROLS.CALENDAR.appendChild(document.createElement("BR"));this.obPageBar=document.createElement("DIV");this.obPageBar.style.padding="10px 10px 3px";this.obPageBar.style.fontSize="0.95em";this._parent.CONTROLS.CALENDAR.appendChild(this.obPageBar);this._parent.CONTROLS.CALENDAR.appendChild(document.createElement("BR"));this._parent.CONTROLS.CALENDAR.appendChild(document.createElement("BR"));var S=this._parent.CONTROLS.CALENDAR.appendChild(document.createElement("SPAN"));S.className="bx-month-note";S.innerHTML=this._parent.MESSAGES.INTR_ABSC_TPL_WARNING_MONTH;this._parent.CONTROLS.CALENDAR.appendChild(document.createElement("BR"));this._parent.CONTROLS.CALENDAR.appendChild(document.createElement("BR"))};JCCalendarViewMonth.prototype.__drawData=function(){var t=this;var e=this.SETTINGS.DATE_START.getMonth();var a=this.SETTINGS.DATE_START;var n=new Date(a);n.setMonth(n.getMonth()+1);n.setSeconds(n.getSeconds()-1);for(var T=0;T<(null==this.ENTRIES?0:this.ENTRIES.length);T++){for(var i=0;i<this.ENTRIES[T]["DATA"].length;i++){var s=this.ENTRIES[T]["DATA"][i]["DATE_ACTIVE_FROM"];var h=this.ENTRIES[T]["DATA"][i]["DATE_ACTIVE_TO"];if(a.valueOf()>h.valueOf()||n.valueOf()<s.valueOf()){this.ENTRIES[T]["DATA"].splice(i,1);i--}}if(this.ENTRIES[T]["DATA"].length==0&&!this._parent.FILTER.USERS_ALL){continue}var E=this.obTable.tBodies[0].insertRow(-1);E.insertCell(-1);E.cells[0].className="bx-calendar-month-first-col";E.id="bx_calendar_user_"+this.ENTRIES[T]["ID"];var r=E.cells[0].appendChild(document.createElement("DIV"));var o=this._parent.FormatName(this.SETTINGS.NAME_TEMPLATE,this.ENTRIES[T]);r.title=o;if(this.ENTRIES[T]["DETAIL_URL"]){var S=document.createElement("A");S.appendChild(document.createTextNode(o));S.href=this.ENTRIES[T]["DETAIL_URL"]}else{var S=document.createTextNode(o)}r.appendChild(S);var l=new Date(this.SETTINGS.DATE_START.valueOf());var A=new Date;A.setHours(0);A.setMinutes(0);A.setSeconds(0);A.setMilliseconds(0);while(l.getMonth()==e){var c=E.insertCell(-1);c.title=r.title;c.className="bx-calendar-month-day";if(l.valueOf()==A.valueOf())c.className+=" bx-calendar-month-today";if(l.getDay()==0||l.getDay()==6)c.className+=" bx-calendar-month-holiday";if(BX.browser.IsIE())c.innerHTML="&nbsp;";l.setDate(l.getDate()+1)}}var N=2;for(var T=0;T<(null==this.ENTRIES?0:this.ENTRIES.length);T++){var d=BX("bx_calendar_user_"+this.ENTRIES[T]["ID"]);if(d&&this.ENTRIES[T]["DATA"]){var I=BX.pos(d,true);for(var i=0;i<this.ENTRIES[T]["DATA"].length;i++){var s=this.ENTRIES[T]["DATA"][i]["DATE_ACTIVE_FROM"],h=this.ENTRIES[T]["DATA"][i]["DATE_ACTIVE_TO"];this.ENTRIES[T]["DATA"][i].VISUAL=document.createElement("DIV");this.ENTRIES[T]["DATA"][i].VISUAL.bx_color_variant=this.ENTRIES[T]["DATA"][i]["TYPE"].length?this.ENTRIES[T]["DATA"][i]["TYPE"]:"OTHER";this.ENTRIES[T]["DATA"][i].VISUAL.className="bx-calendar-entry bx-calendar-color-"+this.ENTRIES[T]["DATA"][i].VISUAL.bx_color_variant;this.ENTRIES[T]["DATA"][i].VISUAL.style.background=this.TYPE_BGCOLORS[this.ENTRIES[T]["DATA"][i]["TYPE"].length?this.ENTRIES[T]["DATA"][i]["TYPE"]:"OTHER"];this.ENTRIES[T]["DATA"][i].VISUAL.innerHTML="<nobr>"+BX.util.htmlspecialchars(this.ENTRIES[T]["DATA"][i]["NAME"])+" ("+this.ENTRIES[T]["DATA"][i]["DATE_FROM"]+" - "+this.ENTRIES[T]["DATA"][i]["DATE_TO"]+")"+"</nobr>";this.ENTRIES[T]["DATA"][i].VISUAL.__bx_user_id=this.ENTRIES[T]["ID"];this.ENTRIES[T]["DATA"][i].VISUAL.style.top=I.top+"px";var _=d.cells[a.valueOf()<s.valueOf()?s.getDate():a.getDate()];var D=d.cells[n.valueOf()<h.valueOf()?n.getDate():h.getDate()];obPos=BX.pos(_,true);var R=parseInt(obPos.left);if(_!=D)obPos=BX.pos(D,true);var p=Math.abs(parseInt(obPos.right-R-(BX.browser.IsIE()?N*2:N)));this.ENTRIES[T]["DATA"][i].VISUAL.style.left=parseInt(R)+"px";this.ENTRIES[T]["DATA"][i].VISUAL.style.width=(isNaN(p)?"20":p)+"px";this.ENTRIES[T]["DATA"][i].VISUAL.style.height=parseInt(obPos.height-2*N)+"px";this._parent.MAIN_LAYOUT.appendChild(this.ENTRIES[T]["DATA"][i].VISUAL);this._parent.RegisterEntry(this.ENTRIES[T].DATA[i])}}}if(this.SETTINGS.PAGE_COUNT>1||this.SETTINGS.PAGE_NUMBER>0){this.obPageBar.innerHTML=this._parent.MESSAGES.INTR_ABSC_TPL_PAGE_BAR+": ";for(var T=0;T<=this.SETTINGS.PAGE_NUMBER;T++){if(T==this.SETTINGS.PAGE_NUMBER){var u=document.createTextNode(T+1)}else{var u=document.createElement("A");u.href="javascript:void(0);";u.innerHTML=T+1;u.onclick=function(e){return function(){t.SETTINGS.PAGE_NUMBER=e;t.Load()}}(T)}this.obPageBar.appendChild(u);this.obPageBar.appendChild(document.createTextNode(" "));if(T==0&&this.SETTINGS.PAGE_NUMBER>=6){var u=document.createTextNode("...");this.obPageBar.appendChild(u);this.obPageBar.appendChild(document.createTextNode(" "));T=this.SETTINGS.PAGE_NUMBER-4}}if(this.SETTINGS.PAGE_COUNT-1>this.SETTINGS.PAGE_NUMBER){var u=document.createElement("A");u.href="javascript:void(0);";u.innerHTML=this._parent.MESSAGES.INTR_ABSC_TPL_PAGE_NEXT;u.onclick=function(){t.SETTINGS.PAGE_NUMBER+=1;t.Load()};this.obPageBar.appendChild(u)}}};