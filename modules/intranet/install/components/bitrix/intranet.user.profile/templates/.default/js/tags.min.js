(function(){var t=BX.namespace("BX.Intranet.UserProfile");if(t.Tags){return}t.Tags=function(t){this.init(t);return this};t.Tags.prototype={init:function(t){this.tagsLoader=null;this.tagsLoaderNode=BX("intranet-user-profile-tags-loader");this.managerInstance=t.managerInstance;this.inputNode=t.inputNode;this.tagsNode=t.tagsNode;this.popup=null;this.popupContent=null;this.defferedTags=[];this.container={input:null,inputWrapper:null};this.popupContainer=null;this.initialized=null;this.tagsUsersPopupInstanceList={};this.getTagsData();this.containerNode=BX("intranet-user-profile-tags-container");this.editLinkNode=BX("intranet-user-profile-add-tags");this.stubButtonNode=BX("intranet-user-profile-interests-stub-button");if(this.editLinkNode){BX.bind(this.editLinkNode,"click",this.show.bind(this))}if(this.stubButtonNode){BX.bind(this.stubButtonNode,"click",this.show.bind(this))}BX.bind(window,"click",function(t){if(!BX.findParent(t.target,{className:"intranet-user-profile-tags-input-wrapper"})&&!BX.findParent(t.target,{className:"intranet-user-profile-tags-popup"})&&t.target!==this.editLinkNode&&t.target!==this.stubButtonNode){if(this.defferedTags.length>0){for(var e=0;e<this.defferedTags.length;e++){this.addTag({tag:this.defferedTags[e]})}this.reindexUser();this.defferedTags=[]}this.cleanInput();BX.cleanNode(this.getInputWrapper());this.getInputWrapper().appendChild(this.getInput());this.hide();this.closePopup()}}.bind(this))},closePopup:function(){if(this.popup){this.popup.close()}},getTagsData:function(t){BX.addClass(this.tagsLoaderNode,"intranet-user-profile-loader-getdata");this.tagsLoader=this.managerInstance.showLoader({node:this.tagsLoaderNode,loader:this.tagsLoader});BX.ajax.runComponentAction(this.managerInstance.componentName,"getTagsList",{mode:"class",signedParameters:this.managerInstance.signedParameters,data:{params:{}}}).then(function(t){this.managerInstance.hideLoader({node:this.tagsLoaderNode,loader:this.tagsLoader});BX.removeClass(this.tagsLoaderNode,"intranet-user-profile-loader-getdata");if(BX.type.isNotEmptyObject(t.data)){this.showTagsList(t.data)}}.bind(this),function(t){this.managerInstance.hideLoader({node:this.tagsLoaderNode,loader:this.tagsLoader});BX.removeClass(this.tagsLoaderNode,"intranet-user-profile-loader-getdata")}.bind(this))},showTagsList:function(t,e){for(var s in t){if(!t.hasOwnProperty(s)){continue}var a=this.getTagNode({tag:s,tagData:t[s],openListSlider:true});if(e){this.tagsNode.insertBefore(a,e);BX.cleanNode(e,true)}else{this.tagsNode.appendChild(a)}}this.checkEmptyTagsList()},getTagNode:function(e){var s=BX.create("DIV",{attrs:{"bx-data-user-tag":e.tag},props:{className:"intranet-user-profile-tags-item intranet-user-profile-tags-item-new"},children:[BX.create("DIV",{props:{className:"intranet-user-profile-tags-item-title",title:e.tag},text:e.tag,events:e.openListSlider?{click:function(){BX.SidePanel.Instance.open(decodeURIComponent(this.managerInstance.urls.PathToTag).replace("#TAG#",e.tag),{cacheable:false,allowChangeHistory:true,width:1e3})}.bind(this)}:null}),this.managerInstance.isOwnProfile?BX.create("DIV",{props:{className:"intranet-user-profile-tags-item-remove"},events:{click:function(t){this.removeTag({tag:e.tag,node:s});this.reindexUser();t.stopPropagation();t.preventDefault()}.bind(this)}}):null,e.tagData?this.getTagUsersNode({tag:e.tag,checksum:e.tagData.CHECKSUM,usersObject:e.tagData.USERS}):null,e.tagData?this.getTagCounterNode(e.tagData.COUNT-e.tagData.USERS.length):null,e.tagData?BX.create("SPAN",{attrs:{id:"iup-tags-item-users-popup-container-"+e.tagData.CHECKSUM,style:"display: none;"},props:{className:"iup-tags-users-popup-cont"},children:[BX.create("SPAN",{props:{className:"iup-tags-item-users-popup-outer"},children:[BX.create("SPAN",{props:{className:"iup-tags-item-users-popup"},children:[BX.create("SPAN",{props:{className:"iup-tags-item-users-waiter"}})]}),BX.create("SPAN",{props:{className:"iup-tags-item-users-action"},children:[BX.create("SPAN",{props:{className:"ui-btn ui-btn-xs ui-btn-primary"},text:BX.message("INTRANET_USER_PROFILE_TAGS_POPUP_ADD")})]})]})]}):null]});if(e.tagData){this.tagsUsersPopupInstanceList[e.tagData.CHECKSUM]=new t.TagsUsersPopup({containerNodeId:"iup-tags-item-users-popup-container-"+e.tagData.CHECKSUM,tagsInstance:this,tag:e.tag,tagNode:s,checksum:e.tagData.CHECKSUM})}BX.bind(s,"animationend",function(){s.classList.remove("intranet-user-profile-tags-item-new")});return s},removeTag:function(t){var e=BX.type.isNotEmptyObject(t)?BX(t.node):null,s=BX.type.isNotEmptyObject(t)&&BX.type.isNotEmptyString(t.tag)?t.tag:null;if(!e||!BX.type.isNotEmptyString(s)){return}this.removeTagNode(e);BX.ajax.runComponentAction(this.managerInstance.componentName,"removeTag",{mode:"class",signedParameters:this.managerInstance.signedParameters,data:{params:{tag:t.tag}}}).then(function(t){}.bind(this),function(t){}.bind(this))},removeTagNode:function(t){t.style.opacity="0";BX.bind(t,"transitionend",function(){t.parentNode.removeChild(t);this.checkEmptyTagsList()}.bind(this))},checkEmptyTagsList:function(){this.setContainerEmpty(!this.tagsNode.hasChildNodes())},getTagUsersNode:function(t){var e=BX.create("DIV",{props:{className:"intranet-user-profile-tags-users"},events:{mouseenter:function(e){if(this.tagsUsersPopupInstanceList[t.checksum]){this.tagsUsersPopupInstanceList[t.checksum].onMouseOver({event:e})}}.bind(this),mouseleave:function(e){if(this.tagsUsersPopupInstanceList[t.checksum]){this.tagsUsersPopupInstanceList[t.checksum].onMouseOut({event:e})}}.bind(this),click:function(e){if(this.tagsUsersPopupInstanceList[t.checksum]){this.tagsUsersPopupInstanceList[t.checksum].onClick({event:e})}}.bind(this)}});for(var s=0;s<t.usersObject.length;s++){var a=t.usersObject[s];e.appendChild(BX.create("DIV",{props:{className:"intranet-user-profile-tags-user"},style:BX.type.isNotEmptyString(a.PERSONAL_PHOTO_SRC)?{backgroundImage:"url('"+a.PERSONAL_PHOTO_SRC+"')"}:null}))}return e},getTagCounterNode:function(t){return t>0?BX.create("DIV",{props:{className:"intranet-user-profile-tags-users-counter"},text:parseInt(t)}):null},addTag:function(t){BX.ajax.runComponentAction(this.managerInstance.componentName,"addTag",{mode:"class",signedParameters:this.managerInstance.signedParameters,data:{params:{tag:t.tag,userId:typeof t.userId!="undefined"?parseInt(t.userId):null}}}).then(function(e){if(BX.type.isNotEmptyObject(e.data)){this.showTagsList(e.data,BX.type.isDomNode(t.tagNode)?t.tagNode:null)}}.bind(this),function(t){}.bind(this))},reindexUser:function(t){if(!BX.type.isNotEmptyObject(t)){t={}}setTimeout(function(){BX.ajax.runComponentAction(this.managerInstance.componentName,"reindexUser",{mode:"class",signedParameters:this.managerInstance.signedParameters,data:{params:{userId:typeof t.userId!="undefined"?parseInt(t.userId):null}}}).then(function(t){}.bind(this),function(t){}.bind(this))}.bind(this),1e3)},getInputValue:function(){return this.getInput().value},cleanInput:function(){this.getInput().value=""},focusInput:function(){this.getInput().focus()},getInputWrapper:function(){if(!this.container.inputWrapper){this.container.inputWrapper=BX.create("DIV",{props:{className:"intranet-user-profile-tags-input-wrapper"}});this.container.inputWrapper.appendChild(this.getInput())}return this.container.inputWrapper},parseLongString:function(){var t=this.getInputValue();if(t===""){return false}var e=t.split(/[\s\t]+/);if(BX.type.isArray(e)&&e.length>1){for(var s=0;s<e.length;s++){if(!BX.type.isNotEmptyString(e[s])){continue}this.addDeferredTag(e[s],this.getTagNode({tag:e[s]}))}return true}return false},checkDeferredTag:function(t){return BX.util.in_array(t,this.defferedTags)},addDeferredTag:function(t,e){if(!this.checkDeferredTag(t)){this.defferedTags.push(t);this.addDeferredTagNode(e)}},addDeferredTagNode:function(t){this.cleanInput();this.getInputWrapper().insertBefore(BX.create("div",{props:{className:"intranet-user-profile-tags-input-deferred"},children:[t]}),this.getInputWrapper().children[this.getInputWrapper().children.length-1])},removeDeferredTag:function(t){if(this.defferedTags.indexOf(t)!==-1){this.defferedTags.splice(this.defferedTags.indexOf(t),1)}},removeDeferredTagNode:function(t){this.getInputWrapper().removeChild(t)},getInput:function(){if(!this.container.input){this.container.input=BX.create("INPUT",{props:{type:"text",className:"intranet-user-profile-tags-input"},events:{keydown:function(t){if(t.code&&(t.code.toLowerCase()==="enter"||t.code.toLowerCase()==="numpadenter")||t.keyCode&&t.keyCode===13){if(this.defferedTags.length===0&&this.getInputValue()===""){return}if(this.parseLongString()){return}if(this.defferedTags.length>0){for(var e=0;e<this.defferedTags.length;e++){this.addTag({tag:this.defferedTags[e]})}this.reindexUser();this.defferedTags=[]}if(this.getInputValue()!==""){this.addTag({tag:this.getInputValue()});this.reindexUser()}this.cleanInput();BX.cleanNode(this.getInputWrapper());this.getInputWrapper().appendChild(this.getInput());this.hide();this.closePopup()}else if(t.code&&t.code.toLowerCase()==="escape"||t.keyCode&&t.keyCode===27){this.hide();this.cleanInput();BX.cleanNode(this.getInputWrapper());this.getInputWrapper().appendChild(this.getInput());this.defferedTags=[];this.closePopup();t.preventDefault();t.stopPropagation()}else if(t.code&&(t.code.toLowerCase()==="arrowdown"||t.code.toLowerCase()==="arrowup")||t.keyCode&&(t.keyCode===38||t.keyCode===40)){}else if((t.code&&t.code.toLowerCase()==="space"||t.keyCode&&t.keyCode===32)&&this.getInputValue()!==""){if(!this.parseLongString()){this.addDeferredTag(this.getInputValue(),this.getTagNode({tag:this.getInputValue()}))}this.cleanInput();BX.PreventDefault(t)}else if((t.code&&t.code.toLowerCase()==="backspace"||t.keyCode&&t.keyCode===8)&&this.getInputValue()===""&&this.defferedTags.length>0){var s=this.getInputWrapper().children[this.getInputWrapper().children.length-2];this.removeDeferredTag(this.defferedTags[this.defferedTags.length-1]);this.removeDeferredTagNode(s)}}.bind(this),input:BX.debounce(function(){if(this.getInputValue()!==""){BX.ajax.runComponentAction(this.managerInstance.componentName,"searchTags",{mode:"class",signedParameters:this.managerInstance.signedParameters,data:{params:{searchString:this.getInputValue()}}}).then(function(t){if(BX.type.isNotEmptyObject(t.data)){this.getPopup({tags:t.data,mode:"search"}).show()}else{this.closePopup()}}.bind(this),function(t){this.closePopup()}.bind(this));return}this.getPopup().destroy();this.popup=null},1e3,this)}})}return this.container.input},hide:function(){this.getInputWrapper().style.height=this.getInputWrapper().offsetHeight+"px";setTimeout(function(){this.getInputWrapper().classList.remove("intranet-user-profile-tags-input-show");this.getInputWrapper().classList.add("intranet-user-profile-tags-hide");this.getInputWrapper().style.height=null;this.setContainerEditMode(false)}.bind(this));this.initialized=false},show:function(){if(!this.initialized){this.inputNode.appendChild(this.getInputWrapper())}this.getInputWrapper().classList.remove("intranet-user-profile-tags-hide");setTimeout(function(){this.setContainerEditMode(true);this.getInputWrapper().classList.add("intranet-user-profile-tags-input-show");setTimeout(function(){this.getInputWrapper().style.height="auto"}.bind(this),400)}.bind(this));this.focusInput();this.getPopularTags();this.initialized=true},getPopup:function(t){var e=this.getInput();if(!BX.type.isNotEmptyObject(t)){t={}}if(!this.popup){this.popup=new BX.PopupWindow({className:"intranet-user-profile-tags-popup",bindElement:e,width:this.getInput().offsetWidth,content:this.getPopupContainer(t),animation:"fading-slide",offsetTop:5})}else{this.popup.setContent(this.getPopupContainer(t));this.popup.setBindElement(e)}this.popup.setBindElement(e);return this.popup},getPopupContainer:function(t){this.popupContent=BX.create("div",{props:{className:"intranet-user-profile-tags-popup"},children:[this.getPopupContentEmpty(t)]});return this.popupContent},getPopularTags:function(){BX.ajax.runComponentAction(this.managerInstance.componentName,"searchTags",{mode:"class",signedParameters:this.managerInstance.signedParameters,data:{params:{}}}).then(function(t){if(BX.type.isNotEmptyObject(t.data)){setTimeout(function(){this.getPopup({tags:t.data,mode:"popular"}).show()}.bind(this),200)}}.bind(this),function(t){}.bind(this))},getPopupContentEmpty:function(t){var e=BX.type.isNotEmptyString(t.mode)?t.mode:"popular";this.popupContent=BX.create("div",{props:{className:"intranet-user-profile-tags-popup-empty-cont"}});this.popupContainer=BX.create("div",{props:{className:"intranet-user-profile-tags-popup-empty"},children:[BX.create("div",{props:{className:"intranet-user-profile-tags-popup-empty-title"},text:BX.message(e=="search"?"INTRANET_USER_PROFILE_TAGS_POPUP_SEARCH_TITLE":"INTRANET_USER_PROFILE_TAGS_POPUP_TITLE")}),this.popupContent,BX.create("div",{props:{className:"intranet-user-profile-tags-popup-empty-text"},text:BX.message("INTRANET_USER_PROFILE_TAGS_POPUP_HINT_3")})]});var s=BX.type.isNotEmptyObject(t)&&BX.type.isArray(t.tags)?t.tags:[],a=null,i=null;for(var n=0;n<s.length;n++){a=this.getTagNode({tag:s[n].NAME,tagData:s[n]});BX.bind(a,"click",function(t){i=t.currentTarget.getAttribute("bx-data-user-tag");if(BX.type.isNotEmptyString(i)){this.addDeferredTag(i,this.getTagNode({tag:i}))}this.focusInput()}.bind(this));this.popupContent.appendChild(a)}return this.popupContainer},getTagList:function(){var t=this.tags;var e=BX.create("DIV",{props:{className:"intranet-user-profile-tags-popup-list"}});for(var s=0;s<t.length;s++){var a=BX.create("DIV",{attrs:{"bx-data-user-tag":t[s].text},props:{className:"intranet-user-profile-tags-popup-list-item"},text:t[s].text,events:{click:function(t){this.addTag({tag:t.currentTarget.getAttribute("bx-data-user-tag")});this.reindexUser();this.cleanInput();this.closePopup()}.bind(this)}});e.appendChild(a)}return e},setActivePopularTag:function(t){t.classList.add("intranet-user-profile-tags-item-active")},resetActivePopularTag:function(t){t.classList.remove("intranet-user-profile-tags-item-active")},setInputValue:function(t){this.getInput().value=t},setContainerEmpty:function(t){if(this.containerNode){if(t){BX.addClass(this.containerNode,"intranet-user-profile-container-empty")}else{BX.removeClass(this.containerNode,"intranet-user-profile-container-empty")}}},setContainerEditMode:function(t){if(this.containerNode){if(t){BX.addClass(this.containerNode,"intranet-user-profile-container-editmode")}else{BX.removeClass(this.containerNode,"intranet-user-profile-container-editmode")}}}}})();
//# sourceMappingURL=tags.map.js