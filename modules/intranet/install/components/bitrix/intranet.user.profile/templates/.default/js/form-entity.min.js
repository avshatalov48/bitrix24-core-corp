(function(){"use strict";var t=BX.namespace("BX.Intranet.UserProfile");if(t.EntityEditor){return}t.EntityEditor=function(t){this.init(t)};t.EntityEditor.prototype={init:function(t){this.signedParameters=t.signedParameters;this.componentName=t.componentName;this.initialFields=t.initialFields||{};this.isCloud=t.isCloud==="Y";this.isCurrentUserAdmin=t.isCurrentUserAdmin==="Y";this.gridId=t.gridId||null;this.voximplantEnablePhones=t.voximplantEnablePhones;BX.addCustomEvent("BX.UI.EntityEditorControlFactory:onInitialize",BX.proxy(function(t,e){e.methods["timezone"]=this.userProfileEntity.bind(this);e.methods["phone"]=this.userProfileEntity.bind(this)},this));BX.addCustomEvent("BX.UI.EntityEditorAjax:onSubmit",BX.proxy(function(t){this.onAfterSubmit(t)},this));if(!this.isCloud&&this.isCurrentUserAdmin){BX.addCustomEvent(window,"BX.UI.EntityEditor:onPrepareConfigMenuItems",function(t,e){e.push({id:"intranet-fields-link",text:BX.message("INTRANET_USER_FIILDS_SETTINGS"),onclick:function(){this.showFieldsSettings()}.bind(this),className:"menu-popup-item-none"})}.bind(this));BX.addCustomEvent(window,"BX.UI.EntityEditor:onUserFieldAdd",function(t,e){if(typeof e!=="object"||!e){return}BX.ajax.runComponentAction(this.componentName,"onUserFieldAdd",{signedParameters:this.signedParameters,mode:"ajax",data:{fieldName:e["FIELD"]}}).then(function(t){},function(t){})}.bind(this))}},userProfileEntity:function(t,e,i){if(t==="timezone"){return BX.Intranet.UserProfile.EntityEditorTimezone.create(e,i)}if(t==="phone"){i.model._settings["SHOW_PHONE_ICON"]=this.voximplantEnablePhones[e]=="Y"?"Y":"N";return BX.Intranet.UserProfile.EntityEditorPhone.create(e,i)}return null},onAfterSubmit:function(t){if(this.isCloud){var e=BX.prop.getString(t,"PERSONAL_MOBILE","");if(e&&this.initialFields["PERSONAL_MOBILE"]!=e){this.showSmsPopup(e)}}var i=BX.prop.getString(t,"NAME","");var n=BX.prop.getString(t,"LAST_NAME","");if(i&&this.initialFields["NAME"]!=i||n&&this.initialFields["LAST_NAME"]!=n){this.changePageTitle(BX.prop.getString(t,"FULL_NAME",""))}this.reloadGrid()},reloadGrid:function(){if(!BX.type.isNotEmptyString(this.gridId)||!window.parent.BX.Main.gridManager){return}var t=window.parent.BX.Main.gridManager.getById(this.gridId);if(!t){return}t.instance.reload()},changePageTitle:function(t){if(!t){return}BX.html(BX("pagetitle"),t);document.title=t;if(BX.getClass("BX.SidePanel.Instance.updateBrowserTitle")){BX.SidePanel.Instance.updateBrowserTitle()}},showSmsPopup:function(t){BX.PopupWindowManager.create({id:"intranet-user-profile-sms-popup",className:"intranet-user-profile-popup",titleBar:BX.message("INTRANET_USER_PROFILE_APP_INSTALL"),maxWidth:450,contentColor:"white",content:BX.create("div",{children:[BX.create("div",{props:{className:"intranet-user-profile-popup-title"},html:BX.message("INTRANET_USER_PROFILE_APP_PHONE")}),BX.create("div",{props:{className:"ui-ctl ui-ctl-textbox ui-ctl-wa"},children:[BX.create("input",{props:{value:t,className:"ui-ctl-element",type:"text"}})]}),BX.create("div",{props:{className:"intranet-user-profile-popup-text"},html:BX.message("INTRANET_USER_PROFILE_APP_INSTALL_TEXT")})]}),closeIcon:true,contentPadding:10,buttons:[new BX.UI.CreateButton({text:BX.message("INTRANET_USER_PROFILE_APP_SEND"),className:"ui-btn-primary",events:{click:BX.proxy(function(){BX.addClass(BX.proxy_context.button,"ui-btn-wait");var e=BX.proxy_context.context;BX.ajax.runAction("intranet.controller.sms.sendsmsforapp",{data:{phone:t}}).then(function(t){e.close()}.bind(this),function(t){e.close()}.bind(this))},this)}})],events:{onPopupClose:function(){this.destroy()}}}).show()},showFieldsSettings:function(){BX.SidePanel.Instance.open("intranet:user-pfofile-fields-settings",{contentCallback:function(t){return new Promise(function(t,e){top.BX.ajax.runComponentAction(this.componentName,"fieldsSettings",{signedParameters:this.signedParameters,mode:"class",data:{}}).then(function(e){t({html:e.data.html})})}.bind(this))}.bind(this),width:600})}};BX.load(["/bitrix/js/ui/entity-editor/js/editor.js"],function(){if(typeof BX.Intranet.UserProfile.EntityEditorTimezone==="undefined"){BX.Intranet.UserProfile.EntityEditorTimezone=function(){BX.Intranet.UserProfile.EntityEditorTimezone.superclass.constructor.apply(this);this._items=null;this._inputAutoTimeZone=null;this._inputTimeZone=null;this._selectAutoTimeZone=null;this._selectTimeZone=null;this._selectContainer=null;this._selectedValue="";this._selectorClickHandler=BX.delegate(this.onSelectorClick,this);this._innerWrapper=null;this._isOpened=false};BX.Intranet.UserProfile.EntityEditorTimezone.create=function(t,e){var i=new BX.Intranet.UserProfile.EntityEditorTimezone;i.initialize(t,e);return i};BX.extend(BX.Intranet.UserProfile.EntityEditorTimezone,BX.UI.EntityEditorField);BX.Intranet.UserProfile.EntityEditorTimezone.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["ui-entity-card-content-block-field-select"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();var r=this.getTimeZoneItemByValue(n.timeZone);var o=this.getAutoTimeZoneItemByValue(n.autoTimeZone);var s=this.getDataBooleanParam("isHtml",false);var a={};var l={};this._selectedValueAutoTimeZone=n.autoTimeZone;this._selectedValueTimeZone=n.timeZone;this._selectAutoTimeZone=null;this._selectTimeZone=null;this._innerWrapper=null;if(this._mode===BX.UI.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(i));this._inputAutoTimeZone=BX.create("input",{attrs:{name:"AUTO_TIME_ZONE",type:"hidden",value:n.autoTimeZone}});this._inputTimeZone=BX.create("input",{attrs:{name:"TIME_ZONE",type:"hidden",value:n.timeZone}});this._wrapper.appendChild(this._inputAutoTimeZone);this._wrapper.appendChild(this._inputTimeZone);a={props:{className:"ui-ctl-element"}};if(s){a.html=o?o["NAME"]:n}else{a.text=o?o["NAME"]:n}this._selectAutoTimeZone=BX.create("div",a);BX.bind(this._selectAutoTimeZone,"click",BX.proxy(function(){this._selectorClickHandler("autoTimeZone")},this));l={props:{className:"ui-ctl-element"}};if(s){l.html=r?r["NAME"]:n}else{l.text=r?r["NAME"]:n}this._selectTimeZone=BX.create("div",l);BX.bind(this._selectTimeZone,"click",BX.proxy(function(){this._selectorClickHandler("timeZone")},this));var u=BX.create("div",{attrs:{className:"ui-ctl-after ui-ctl-icon-angle"}});this._selectContainerAutoTimeZone=BX.create("div",{props:{className:"ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w50"},children:[this._selectAutoTimeZone,u]});this._selectContainerTimeZone=BX.create("div",{props:{className:"ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w50",style:n.autoTimeZone!=="N"?"display: none":""},children:[this._selectTimeZone,BX.clone(u)]});this._innerWrapper=BX.create("div",{props:{className:"ui-entity-card-content-block-inner"},children:[this._selectContainerAutoTimeZone,this._selectContainerTimeZone]});this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}this.registerLayout(t);this._hasLayout=true}else{}};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getModeSwitchType=function(t){var e=BX.UI.EntityEditorModeSwitchType.common;if(t===BX.UI.EntityEditorMode.edit){e|=BX.UI.EntityEditorModeSwitchType.button|BX.UI.EntityEditorModeSwitchType.content}return e};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.checkIfNotEmpty=function(t){return t!==""&&t!=="0"};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.doRegisterLayout=function(){};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.doClearLayout=function(t){this.closeMenu();this._input=null;this._select=null;this._innerWrapper=null};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.refreshLayout=function(){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Intranet.UserProfile.EntityEditorTimezone.superclass.refreshLayout.apply(this,arguments);return}var t=this.getValue();var e=this.getItemByValue(t);var i=e?BX.prop.getString(e,"NAME",t):t;if(this._mode===BX.Intranet.UserProfile.EntityEditorMode.edit){this._selectedValue=t;if(this._input){this._input.value=t}if(this._select){this._select.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i)}}else if(this._mode===BX.Intranet.UserProfile.EntityEditorMode.view&&this._innerWrapper){this._innerWrapper.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i)}};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.validate=function(t){if(this._mode!==BX.UI.EntityEditorMode.edit){throw"BX.Intranet.UserProfile.EntityEditorTimezone. Invalid validation context"}if(!this.isEditable()){return true}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var e=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!e){t.addError(BX.Intranet.UserProfile.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return e};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.showError=function(t,e){BX.Intranet.UserProfile.EntityEditorTimezone.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"ui-entity-card-content-error")}};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.clearError=function(){BX.Intranet.UserProfile.EntityEditorTimezone.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"ui-entity-card-content-error")}};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.onSelectorClick=function(t){if(!this._isOpened){this.openMenu(t)}else{this.closeMenu(t)}};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.openMenu=function(t){if(this._isOpened){return}var e=[];if(t=="timeZone"){var i=this.getTimeZoneItems()}else{i=this.getAutoTimeZoneItems()}for(var n=0,r=i.length;n<r;n++){var o=i[n];if(!BX.prop.getBoolean(o,"IS_EDITABLE",true)){continue}var s=BX.prop.getString(o,"VALUE",n);var a=BX.prop.getString(o,"NAME",s);e.push({text:this.getDataBooleanParam("isHtml",false)?a:BX.util.htmlspecialchars(a),value:s,onclick:BX.delegate(t=="autoTimeZone"?this.onAutoTimeZoneItemSelect:this.onTimeZoneItemSelect,this)})}var l=t==="timeZone"?this._selectTimeZone:this._selectAutoTimeZone;BX.PopupMenu.show(this._id,l,e,{angle:false,width:l.offsetWidth+"px",maxHeight:300,events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(l)["width"])};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.closeMenu=function(){var t=BX.PopupMenu.getMenuById(this._id);if(t){t.popupWindow.close()}};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.onMenuShow=function(){BX.addClass(this._selectContainer,"ui-ctl-active");this._isOpened=true};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.onMenuClose=function(){BX.PopupMenu.destroy(this._id);BX.removeClass(this._selectContainer,"ui-ctl-active");this._isOpened=false};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.onAutoTimeZoneItemSelect=function(t,e){this.closeMenu();this._selectedValueAutoTimeZone=this._inputAutoTimeZone.value=e.value;var i=BX.prop.getString(this.getAutoTimeZoneItemByValue(this._selectedValueAutoTimeZone),"NAME",this._selectedValueAutoTimeZone);this._selectAutoTimeZone.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i);this.markAsChanged();BX.PopupMenu.destroy(this._id);this._selectContainerTimeZone.style.display=this._selectedValueAutoTimeZone==="N"?"block":"none"};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.onTimeZoneItemSelect=function(t,e){this.closeMenu();this._selectedValueTimeZone=this._inputTimeZone.value=e.value;var i=BX.prop.getString(this.getTimeZoneItemByValue(this._selectedValueTimeZone),"NAME",this._selectedValueTimeZone);this._selectTimeZone.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i);this.markAsChanged();BX.PopupMenu.destroy(this._id)};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getTimeZoneItems=function(){if(!this._itemsAutoTimeZone){this._itemsAutoTimeZone=BX.prop.getArray(this._schemeElement.getData(),"timezone_items",[])}return this._itemsAutoTimeZone};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getAutoTimeZoneItems=function(){if(!this._itemsTimeZone){this._itemsTimeZone=BX.prop.getArray(this._schemeElement.getData(),"auto_timezone_items",[])}return this._itemsTimeZone};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getTimeZoneItemByValue=function(t){var e=this.getTimeZoneItems();for(var i=0,n=e.length;i<n;i++){var r=e[i];if(t===BX.prop.getString(r,"VALUE","")){return r}}return null};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getAutoTimeZoneItemByValue=function(t){var e=this.getAutoTimeZoneItems();for(var i=0,n=e.length;i<n;i++){var r=e[i];if(t===BX.prop.getString(r,"VALUE","")){return r}}return null};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getFirstItem=function(){var t=this.getItems();return t.length>0?t[0]:null};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.save=function(){if(!this.isEditable()){return}var t={timeZone:this._selectedValueTimeZone,autoTimeZone:this._selectedValueAutoTimeZone};this._model.setField(this.getName(),t)};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.processModelChange=function(t){if(BX.prop.get(t,"originator",null)===this){return}if(!BX.prop.getBoolean(t,"forAll",false)&&BX.prop.getString(t,"name","")!==this.getName()){return}this.refreshLayout()};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getRuntimeValue=function(){return this._mode===BX.Intranet.UserProfile.EntityEditorMode.edit&&this._input?this._selectedValue:""}}if(typeof BX.Intranet.UserProfile.EntityEditorPhone==="undefined"){BX.Intranet.UserProfile.EntityEditorPhone=function(){BX.Intranet.UserProfile.EntityEditorPhone.superclass.constructor.apply(this);this._input=null;this._innerWrapper=null};BX.Intranet.UserProfile.EntityEditorPhone.create=function(t,e){var i=new BX.Intranet.UserProfile.EntityEditorPhone;i.initialize(t,e);return i};BX.extend(BX.Intranet.UserProfile.EntityEditorPhone,BX.UI.EntityEditorField);BX.Intranet.UserProfile.EntityEditorPhone.prototype.getModeSwitchType=function(t){var e=BX.UI.EntityEditorModeSwitchType.common;if(t===BX.UI.EntityEditorMode.edit){e|=BX.UI.EntityEditorModeSwitchType.button|BX.UI.EntityEditorModeSwitchType.content}return e};BX.Intranet.UserProfile.EntityEditorPhone.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Intranet.UserProfile.EntityEditorPhone.prototype.focus=function(){if(!this._input){return}BX.focus(this._input);BX.UI.EditorTextHelper.getCurrent().setPositionAtEnd(this._input)};BX.Intranet.UserProfile.EntityEditorPhone.prototype.layout=function(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["ui-entity-card-content-block-field-phone"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var e=this.getName();var i=this.getTitle();var n=this.getValue();var r=this.checkPhoneIcon();this._input=null;this._inputContainer=null;this._innerWrapper=null;if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}if(this._mode===BX.UI.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(i));this._inputContainer=BX.create("div",{attrs:{className:"ui-ctl ui-ctl-textbox ui-ctl-w100"}});this._input=BX.create("input",{attrs:{name:e,className:"ui-ctl-element",type:"text",value:n,id:this._id.toLowerCase()+"_text"}});this._inputContainer.appendChild(this._input);if(this.isNewEntity()){var o=this.getCreationPlaceholder();if(o!==""){this._input.setAttribute("placeholder",o)}}BX.bind(this._input,"input",this._changeHandler);this._innerWrapper=BX.create("div",{props:{className:"ui-entity-editor-content-block"},children:[this._inputContainer]})}else{this._wrapper.appendChild(this.createTitleNode(i));if(this.hasContentToDisplay()){this._innerWrapper=BX.create("div",{props:{className:"ui-entity-editor-content-block"},children:[BX.create("div",{props:{className:"ui-entity-editor-content-block-text"},children:[BX.create("span",{text:n}),r?BX.create("div",{props:{className:"intranet-user-profile-phone-icon"},events:{mouseup:function(t){t.preventDefault();t.stopPropagation();top.BXIM.phoneTo(n)}}}):""]})]})}else{this._innerWrapper=BX.create("div",{props:{className:"ui-entity-editor-content-block"},text:BX.message("UI_ENTITY_EDITOR_FIELD_EMPTY")})}}this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true};BX.Intranet.UserProfile.EntityEditorPhone.prototype.checkPhoneIcon=function(t){return this._model._settings["SHOW_PHONE_ICON"]=="Y"}}})})();
//# sourceMappingURL=form-entity.map.js