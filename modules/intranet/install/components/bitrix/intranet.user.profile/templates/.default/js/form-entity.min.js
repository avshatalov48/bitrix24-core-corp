(function(){"use strict";var e=BX.namespace("BX.Intranet.UserProfile");if(e.EntityEditor){return}e.EntityEditor=function(e){this.init(e)};e.EntityEditor.prototype={init:function(e){this.signedParameters=e.signedParameters;this.componentName=e.componentName;this.initialFields=e.initialFields||{};this.isCloud=e.isCloud==="Y";this.isCurrentUserAdmin=e.isCurrentUserAdmin==="Y";this.gridId=e.gridId||null;BX.addCustomEvent("BX.UI.EntityEditorControlFactory:onInitialize",BX.proxy(function(e,t){t.methods["timezone"]=this.userProfileEntity},this));BX.addCustomEvent("BX.UI.EntityEditorAjax:onSubmit",BX.proxy(function(e){this.onAfterSubmit(e)},this));if(!this.isCloud&&this.isCurrentUserAdmin){BX.addCustomEvent(window,"BX.UI.EntityEditor:onPrepareConfigMenuItems",function(e,t){t.push({id:"intranet-fields-link",text:BX.message("INTRANET_USER_FIILDS_SETTINGS"),onclick:function(){this.showFieldsSettings()}.bind(this),className:"menu-popup-item-none"})}.bind(this))}},userProfileEntity:function(e,t,i){if(e==="timezone"){return BX.Intranet.UserProfile.EntityEditorTimezone.create(t,i)}return null},onAfterSubmit:function(e){if(this.isCloud){var t=BX.prop.getString(e,"PERSONAL_MOBILE","");if(t&&this.initialFields["PERSONAL_MOBILE"]!=t){this.showSmsPopup(t)}}var i=BX.prop.getString(e,"NAME","");var n=BX.prop.getString(e,"LAST_NAME","");if(i&&this.initialFields["NAME"]!=i||n&&this.initialFields["LAST_NAME"]!=n){this.changePageTitle(BX.prop.getString(e,"FULL_NAME",""))}this.reloadGrid()},reloadGrid:function(){if(!BX.type.isNotEmptyString(this.gridId)||!window.parent.BX.Main.gridManager){return}var e=window.parent.BX.Main.gridManager.getById(this.gridId);if(!e){return}e.instance.reload()},changePageTitle:function(e){if(!e){return}BX.html(BX("pagetitle"),e);document.title=e;if(BX.getClass("BX.SidePanel.Instance.updateBrowserTitle")){BX.SidePanel.Instance.updateBrowserTitle()}},showSmsPopup:function(e){BX.PopupWindowManager.create({id:"intranet-user-profile-sms-popup",className:"intranet-user-profile-popup",titleBar:BX.message("INTRANET_USER_PROFILE_APP_INSTALL"),maxWidth:450,contentColor:"white",content:BX.create("div",{children:[BX.create("div",{props:{className:"intranet-user-profile-popup-title"},html:BX.message("INTRANET_USER_PROFILE_APP_PHONE")}),BX.create("div",{props:{className:"ui-ctl ui-ctl-textbox ui-ctl-wa"},children:[BX.create("input",{props:{value:e,className:"ui-ctl-element",type:"text"}})]}),BX.create("div",{props:{className:"intranet-user-profile-popup-text"},html:BX.message("INTRANET_USER_PROFILE_APP_INSTALL_TEXT")})]}),closeIcon:true,contentPadding:10,buttons:[new BX.UI.CreateButton({text:BX.message("INTRANET_USER_PROFILE_APP_SEND"),className:"ui-btn-primary",events:{click:BX.proxy(function(){BX.addClass(BX.proxy_context.button,"ui-btn-wait");var t=BX.proxy_context.context;BX.ajax.runAction("intranet.controller.sms.sendsmsforapp",{data:{phone:e}}).then(function(e){t.close()}.bind(this),function(e){t.close()}.bind(this))},this)}})],events:{onPopupClose:function(){this.destroy()}}}).show()},showFieldsSettings:function(){BX.SidePanel.Instance.open("intranet:user-pfofile-fields-settings",{contentCallback:function(e){return new Promise(function(e,t){top.BX.ajax.runComponentAction(this.componentName,"fieldsSettings",{signedParameters:this.signedParameters,mode:"class",data:{}}).then(function(t){e({html:t.data.html})})}.bind(this))}.bind(this),width:600})}};BX.load(["/bitrix/js/ui/entity-editor/js/editor.js"],function(){if(typeof BX.Intranet.UserProfile.EntityEditorTimezone==="undefined"){BX.Intranet.UserProfile.EntityEditorTimezone=function(){BX.Intranet.UserProfile.EntityEditorTimezone.superclass.constructor.apply(this);this._items=null;this._inputAutoTimeZone=null;this._inputTimeZone=null;this._selectAutoTimeZone=null;this._selectTimeZone=null;this._selectContainer=null;this._selectedValue="";this._selectorClickHandler=BX.delegate(this.onSelectorClick,this);this._innerWrapper=null;this._isOpened=false};BX.Intranet.UserProfile.EntityEditorTimezone.create=function(e,t){var i=new BX.Intranet.UserProfile.EntityEditorTimezone;i.initialize(e,t);return i};BX.extend(BX.Intranet.UserProfile.EntityEditorTimezone,BX.UI.EntityEditorField);BX.Intranet.UserProfile.EntityEditorTimezone.prototype.layout=function(e){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["ui-entity-card-content-block-field-select"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(e);this._hasLayout=true;return}var t=this.getName();var i=this.getTitle();var n=this.getValue();var o=this.getTimeZoneItemByValue(n.timeZone);var r=this.getAutoTimeZoneItemByValue(n.autoTimeZone);var s=this.getDataBooleanParam("isHtml",false);var a={};var l={};this._selectedValueAutoTimeZone=n.autoTimeZone;this._selectedValueTimeZone=n.timeZone;this._selectAutoTimeZone=null;this._selectTimeZone=null;this._innerWrapper=null;if(this._mode===BX.UI.EntityEditorMode.edit){this._wrapper.appendChild(this.createTitleNode(i));this._inputAutoTimeZone=BX.create("input",{attrs:{name:"AUTO_TIME_ZONE",type:"hidden",value:n.autoTimeZone}});this._inputTimeZone=BX.create("input",{attrs:{name:"TIME_ZONE",type:"hidden",value:n.timeZone}});this._wrapper.appendChild(this._inputAutoTimeZone);this._wrapper.appendChild(this._inputTimeZone);a={props:{className:"ui-ctl-element"}};if(s){a.html=r?r["NAME"]:n}else{a.text=r?r["NAME"]:n}this._selectAutoTimeZone=BX.create("div",a);BX.bind(this._selectAutoTimeZone,"click",BX.proxy(function(){this._selectorClickHandler("autoTimeZone")},this));l={props:{className:"ui-ctl-element"}};if(s){l.html=o?o["NAME"]:n}else{l.text=o?o["NAME"]:n}this._selectTimeZone=BX.create("div",l);BX.bind(this._selectTimeZone,"click",BX.proxy(function(){this._selectorClickHandler("timeZone")},this));var u=BX.create("div",{attrs:{className:"ui-ctl-after ui-ctl-icon-angle"}});this._selectContainerAutoTimeZone=BX.create("div",{props:{className:"ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w50"},children:[this._selectAutoTimeZone,u]});this._selectContainerTimeZone=BX.create("div",{props:{className:"ui-ctl ui-ctl-after-icon ui-ctl-dropdown ui-ctl-w50",style:n.autoTimeZone!=="N"?"display: none":""},children:[this._selectTimeZone,BX.clone(u)]});this._innerWrapper=BX.create("div",{props:{className:"ui-entity-card-content-block-inner"},children:[this._selectContainerAutoTimeZone,this._selectContainerTimeZone]});this._wrapper.appendChild(this._innerWrapper);if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}this.registerLayout(e);this._hasLayout=true}else{}};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getModeSwitchType=function(e){var t=BX.UI.EntityEditorModeSwitchType.common;if(e===BX.UI.EntityEditorMode.edit){t|=BX.UI.EntityEditorModeSwitchType.button|BX.UI.EntityEditorModeSwitchType.content}return t};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getContentWrapper=function(){return this._innerWrapper};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.checkIfNotEmpty=function(e){return e!==""&&e!=="0"};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.doRegisterLayout=function(){};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.doClearLayout=function(e){this.closeMenu();this._input=null;this._select=null;this._innerWrapper=null};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.refreshLayout=function(){if(!this._hasLayout){return}if(!this._isValidLayout){BX.Intranet.UserProfile.EntityEditorTimezone.superclass.refreshLayout.apply(this,arguments);return}var e=this.getValue();var t=this.getItemByValue(e);var i=t?BX.prop.getString(t,"NAME",e):e;if(this._mode===BX.Intranet.UserProfile.EntityEditorMode.edit){this._selectedValue=e;if(this._input){this._input.value=e}if(this._select){this._select.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i)}}else if(this._mode===BX.Intranet.UserProfile.EntityEditorMode.view&&this._innerWrapper){this._innerWrapper.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i)}};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.validate=function(e){if(this._mode!==BX.UI.EntityEditorMode.edit){throw"BX.Intranet.UserProfile.EntityEditorTimezone. Invalid validation context"}if(!this.isEditable()){return true}this.clearError();if(this.hasValidators()){return this.executeValidators(e)}var t=!this.isRequired()||BX.util.trim(this._input.value)!=="";if(!t){e.addError(BX.Intranet.UserProfile.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return t};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.showError=function(e,t){BX.Intranet.UserProfile.EntityEditorTimezone.superclass.showError.apply(this,arguments);if(this._input){BX.addClass(this._input,"ui-entity-card-content-error")}};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.clearError=function(){BX.Intranet.UserProfile.EntityEditorTimezone.superclass.clearError.apply(this);if(this._input){BX.removeClass(this._input,"ui-entity-card-content-error")}};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.onSelectorClick=function(e){if(!this._isOpened){this.openMenu(e)}else{this.closeMenu(e)}};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.openMenu=function(e){if(this._isOpened){return}var t=[];if(e=="timeZone"){var i=this.getTimeZoneItems()}else{i=this.getAutoTimeZoneItems()}for(var n=0,o=i.length;n<o;n++){var r=i[n];if(!BX.prop.getBoolean(r,"IS_EDITABLE",true)){continue}var s=BX.prop.getString(r,"VALUE",n);var a=BX.prop.getString(r,"NAME",s);t.push({text:this.getDataBooleanParam("isHtml",false)?a:BX.util.htmlspecialchars(a),value:s,onclick:BX.delegate(e=="autoTimeZone"?this.onAutoTimeZoneItemSelect:this.onTimeZoneItemSelect,this)})}var l=e==="timeZone"?this._selectTimeZone:this._selectAutoTimeZone;BX.PopupMenu.show(this._id,l,t,{angle:false,width:l.offsetWidth+"px",maxHeight:300,events:{onPopupShow:BX.delegate(this.onMenuShow,this),onPopupClose:BX.delegate(this.onMenuClose,this)}});BX.PopupMenu.currentItem.popupWindow.setWidth(BX.pos(l)["width"])};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.closeMenu=function(){var e=BX.PopupMenu.getMenuById(this._id);if(e){e.popupWindow.close()}};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.onMenuShow=function(){BX.addClass(this._selectContainer,"ui-ctl-active");this._isOpened=true};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.onMenuClose=function(){BX.PopupMenu.destroy(this._id);BX.removeClass(this._selectContainer,"ui-ctl-active");this._isOpened=false};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.onAutoTimeZoneItemSelect=function(e,t){this.closeMenu();this._selectedValueAutoTimeZone=this._inputAutoTimeZone.value=t.value;var i=BX.prop.getString(this.getAutoTimeZoneItemByValue(this._selectedValueAutoTimeZone),"NAME",this._selectedValueAutoTimeZone);this._selectAutoTimeZone.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i);this.markAsChanged();BX.PopupMenu.destroy(this._id);this._selectContainerTimeZone.style.display=this._selectedValueAutoTimeZone==="N"?"block":"none"};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.onTimeZoneItemSelect=function(e,t){this.closeMenu();this._selectedValueTimeZone=this._inputTimeZone.value=t.value;var i=BX.prop.getString(this.getTimeZoneItemByValue(this._selectedValueTimeZone),"NAME",this._selectedValueTimeZone);this._selectTimeZone.innerHTML=this.getDataBooleanParam("isHtml",false)?i:BX.util.htmlspecialchars(i);this.markAsChanged();BX.PopupMenu.destroy(this._id)};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getTimeZoneItems=function(){if(!this._itemsAutoTimeZone){this._itemsAutoTimeZone=BX.prop.getArray(this._schemeElement.getData(),"timezone_items",[])}return this._itemsAutoTimeZone};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getAutoTimeZoneItems=function(){if(!this._itemsTimeZone){this._itemsTimeZone=BX.prop.getArray(this._schemeElement.getData(),"auto_timezone_items",[])}return this._itemsTimeZone};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getTimeZoneItemByValue=function(e){var t=this.getTimeZoneItems();for(var i=0,n=t.length;i<n;i++){var o=t[i];if(e===BX.prop.getString(o,"VALUE","")){return o}}return null};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getAutoTimeZoneItemByValue=function(e){var t=this.getAutoTimeZoneItems();for(var i=0,n=t.length;i<n;i++){var o=t[i];if(e===BX.prop.getString(o,"VALUE","")){return o}}return null};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getFirstItem=function(){var e=this.getItems();return e.length>0?e[0]:null};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.save=function(){if(!this.isEditable()){return}var e={timeZone:this._selectedValueTimeZone,autoTimeZone:this._selectedValueAutoTimeZone};this._model.setField(this.getName(),e)};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.processModelChange=function(e){if(BX.prop.get(e,"originator",null)===this){return}if(!BX.prop.getBoolean(e,"forAll",false)&&BX.prop.getString(e,"name","")!==this.getName()){return}this.refreshLayout()};BX.Intranet.UserProfile.EntityEditorTimezone.prototype.getRuntimeValue=function(){return this._mode===BX.Intranet.UserProfile.EntityEditorMode.edit&&this._input?this._selectedValue:""}}})})();
//# sourceMappingURL=form-entity.map.js