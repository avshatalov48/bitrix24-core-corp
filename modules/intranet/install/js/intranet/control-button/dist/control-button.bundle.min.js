this.BX=this.BX||{};(function(t,e,n,i){"use strict";var a,s;function o(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function r(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?o(Object(n),!0).forEach((function(e){babelHelpers.defineProperty(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}var c=function(){function t(){var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,t);this.container=n.container;if(!e.Type.isDomNode(this.container)){return}this.entityType=n.entityType||"";this.entityId=n.entityId||"";if(!this.entityType||!this.entityId){return}this.items=n.items||[];this.mainItem=n.mainItem||"videocall";this.entityData=n.entityData||{};var i=n.analyticsLabel||{};if(this.items.length===0){if(this.entityType==="task"){this.items=["chat","videocall","blog_post","calendar_event"]}else if(this.entityType==="calendar_event"){this.items=["chat","videocall","blog_post","task"]}else if(this.entityType==="workgroup"){this.items=["chat","videocall"]}else{this.items=["chat","videocall","blog_post","task","calendar_event"]}}this.contextBx=window.top.BX||window.BX;this.sliderId="controlButton:".concat(this.entityType+this.entityId).concat(Math.floor(Math.random()*1e3));this.isVideoCallEnabled=e.Reflection.getClass("".concat(this.contextBx,".Call.Util"))?this.contextBx.Call.Util.isWebRTCSupported():true;this.chatLockCounter=0;if(!e.Type.isPlainObject(i)){i={}}this.analyticsLabel=r({entity:this.entityType},i);this.buttonClassName=n.buttonClassName||"";this.renderButton();this.subscribeEvents()}babelHelpers.createClass(t,[{key:"destroy",value:function t(){this.contextBx.Event.EventEmitter.unsubscribe("BX.Calendar:onEntrySave",this.onCalendarSave);this.contextBx.Event.EventEmitter.unsubscribe("SidePanel.Slider:onMessage",this.onPostSave)}},{key:"subscribeEvents",value:function t(){this.contextBx.Event.EventEmitter.subscribe("BX.Calendar:onEntrySave",this.onCalendarSave.bind(this));this.contextBx.Event.EventEmitter.subscribe("SidePanel.Slider:onMessage",this.onPostSave.bind(this))}},{key:"onCalendarSave",value:function t(e){if(e instanceof this.contextBx.Event.BaseEvent){var n=e.getData();if(n.sliderId===this.sliderId){var i={postEntityType:this.entityType.toUpperCase(),sourceEntityType:this.entityType.toUpperCase(),sourceEntityId:this.entityId,sourceEntityData:this.entityData,entityType:"CALENDAR_EVENT",entityId:n.responseData.entryId};this.addEntityComment(i)}}}},{key:"onPostSave",value:function t(e){var n=e.getCompatData(),i=babelHelpers.slicedToArray(n,1),a=i[0];if(a.getEventId()==="Socialnetwork.PostForm:onAdd"){var s=a.getData();if(s.originatorSliderId===this.sliderId){var o={postEntityType:this.entityType.toUpperCase(),sourceEntityType:this.entityType.toUpperCase(),sourceEntityId:this.entityId,sourceEntityData:this.entityData,entityType:"BLOG_POST",entityId:s.successPostId};this.addEntityComment(o)}}}},{key:"renderButton",value:function t(){var n=!this.isVideoCallEnabled||this.mainItem==="chat";var i=n?this.openChat.bind(this):this.startVideoCall.bind(this);var o=n?e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_CHAT"):e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_NAME");var r="".concat(n?"ui-btn-icon-chat-blue":"ui-btn-icon-camera-blue"," intranet-control-btn ui-btn-light-border ui-btn-icon-inline ").concat(this.buttonClassName);this.button=this.items.length>1?e.Tag.render(a||(a=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-btn-split ','">\n\t\t\t\t\t\t<button class="ui-btn-main" onclick="','">','</button>\n\t\t\t\t\t\t<button class="ui-btn-menu" onclick="','"></button> \n\t\t\t\t\t</div>\n\t\t\t\t'])),r,i,o,this.showMenu.bind(this)):e.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(['<button class="ui-btn ','" onclick="','">',"</button>"])),r,i,o);e.Dom.append(this.button,this.container)}},{key:"showLoader",value:function t(){e.Dom.addClass(this.button,"ui-btn-wait")}},{key:"hideLoader",value:function t(){e.Dom.removeClass(this.button,"ui-btn-wait")}},{key:"getAvailableItems",value:function t(){var n=this;return new Promise((function(t,i){var a=window.sessionStorage.getItem("b24-controlbutton-available-items");if(a){t(a);return}n.showLoader();e.ajax.runAction("intranet.controlbutton.getAvailableItems",{data:{}}).then((function(e){window.sessionStorage.setItem("b24-controlbutton-available-items",e.data);n.hideLoader();t(e.data)}))}))}},{key:"showMenu",value:function t(){var i=this;this.getAvailableItems().then((function(t){i.items=i.items.filter((function(e){return e&&t.indexOf(e)!==-1}));var a=[];i.items.forEach((function(t){switch(t){case"videocall":if(i.isVideoCallEnabled){a.push({text:e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_VIDEOCALL"),className:"menu-popup-item-videocall",onclick:function t(){i.startVideoCall();i.popupMenu.close()}})}break;case"chat":a.push({text:e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_CHAT"),className:"menu-popup-item-chat",onclick:function t(){i.openChat();i.popupMenu.close()}});break;case"task":a.push({text:e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_TASK"),className:"menu-popup-item-task",onclick:function t(){i.openTaskSlider();i.popupMenu.close()}});break;case"calendar_event":a.push({text:e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_MEETING"),className:"menu-popup-item-meeting",onclick:function t(){i.openCalendarSlider();i.popupMenu.close()}});break;case"blog_post":a.push({text:e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_POST"),className:"menu-popup-item-post",onclick:function t(){i.openPostSlider();i.popupMenu.close()}});break}}));i.popupMenu=new n.Menu({bindElement:i.button,items:a,offsetLeft:80,offsetTop:5});i.popupMenu.show()}))}},{key:"openChat",value:function t(){var n=this;this.showLoader();e.ajax.runAction("intranet.controlbutton.getChat",{data:{entityType:this.entityType,entityId:this.entityId,entityData:this.entityData},analyticsLabel:this.analyticsLabel}).then((function(t){if(t.data){i.Messenger.openChat("chat"+parseInt(t.data))}n.chatLockCounter=0;n.hideLoader()}),(function(t){if(t.errors[0].code==="lock_error"&&n.chatLockCounter<4){n.chatLockCounter++;n.openChat()}else{n.showHintPopup(t.errors[0].message);n.hideLoader()}}))}},{key:"startVideoCall",value:function t(){var n=this;this.showLoader();e.ajax.runAction("intranet.controlbutton.getVideoCallChat",{data:{entityType:this.entityType,entityId:this.entityId,entityData:this.entityData},analyticsLabel:this.analyticsLabel}).then((function(t){if(t.data){i.Messenger.startVideoCall("chat"+t.data,true)}n.chatLockCounter=0;n.hideLoader()}),(function(t){if(t.errors[0].code==="lock_error"&&n.chatLockCounter<4){n.chatLockCounter++;n.startVideoCall()}else{n.showHintPopup(t.errors[0].message);n.hideLoader()}}))}},{key:"addEntityComment",value:function t(n){e.ajax.runAction("socialnetwork.api.livefeed.createEntityComment",{data:{params:n}})}},{key:"openCalendarSlider",value:function t(){var n=this;this.showLoader();e.ajax.runAction("intranet.controlbutton.getCalendarLink",{data:{entityType:this.entityType,entityId:this.entityId},analyticsLabel:this.analyticsLabel}).then((function(t){var i=[];if(e.Type.isArrayLike(t.data.userIds)){i=t.data.userIds.map((function(t){return{id:parseInt(t),entityId:"user"}}))}new(window.top.BX||window.BX).Calendar.SliderLoader(0,{sliderId:n.sliderId,participantsEntityList:i,entryName:t.data.name,entryDescription:t.data.desc}).show();n.hideLoader()}))}},{key:"openTaskSlider",value:function t(){var n=this;this.showLoader();e.ajax.runAction("intranet.controlbutton.getTaskLink",{data:{entityType:this.entityType,entityId:this.entityId,entityData:this.entityData},analyticsLabel:this.analyticsLabel}).then((function(t){BX.SidePanel.Instance.open(t.data.link,{requestMethod:"post",requestParams:t.data});n.hideLoader()}))}},{key:"openPostSlider",value:function t(){var n=this;this.showLoader();e.ajax.runAction("intranet.controlbutton.getPostLink",{data:{entityType:this.entityType,entityId:this.entityId,entityData:this.entityData},analyticsLabel:this.analyticsLabel}).then((function(t){BX.SidePanel.Instance.open(t.data.link,{requestMethod:"post",requestParams:{POST_TITLE:t.data.title,POST_MESSAGE:t.data.message,destTo:t.data.destTo},data:{sliderId:n.sliderId}});n.hideLoader()}))}},{key:"showHintPopup",value:function t(i){if(!i){return}new n.Popup("inviteHint"+e.Text.getRandom(8),this.button,{content:i,zIndex:15e3,angle:true,offsetTop:0,offsetLeft:50,closeIcon:false,autoHide:true,darkMode:true,overlay:false,maxWidth:400,events:{onAfterPopupShow:function t(){setTimeout(function(){this.close()}.bind(this),5e3)}}}).show()}}]);return t}();t.ControlButton=c})(this.BX.Intranet=this.BX.Intranet||{},BX,BX.Main,BX.Messenger.v2.Lib);
//# sourceMappingURL=control-button.bundle.map.js