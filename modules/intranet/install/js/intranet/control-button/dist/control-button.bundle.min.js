this.BX=this.BX||{};(function(t,e,n,a,i){"use strict";function o(){var t=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<button\tclass="control-btn ','">\n\t\t\t\t<span class="control-btn-text" onclick="','">\n\t\t\t\t\t','\n\t\t\t\t</span>\n\t\t\t\t<span class="control-btn-arrow" onclick="','"></span>\n\t\t\t</button>\n\t\t']);o=function e(){return t};return t}var s=function(){function t(){var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,t);this.container=n.container;if(!e.Type.isDomNode(this.container)){return}this.entityType=n.entityType||"";this.entityId=n.entityId||"";if(!this.entityType||!this.entityId){return}this.items=n.items||[];this.mainItem=n.mainItem||"videocall";this.entityData=n.entityData||{};var a=n.analyticsLabel||{};if(this.items.length===0){if(this.entityType==="task"){this.items=["chat","videocall","blog_post","calendar_event"]}else if(this.entityType==="calendar_event"){this.items=["chat","videocall","blog_post","task"]}else{this.items=["chat","videocall","blog_post","task","calendar_event"]}}this.contextBx=window.top.BX||window.BX;this.sliderId="controlButton:".concat(this.entityType+this.entityId).concat(Math.floor(Math.random()*1e3));this.isVideoCallEnabled=this.contextBx.Call.Util.isWebRTCSupported();this.chatLockCounter=0;if(!e.Type.isPlainObject(a)){a={}}this.analyticsLabel=babelHelpers.objectSpread({entity:this.entityType},a);this.renderButton();this.subscribeEvents()}babelHelpers.createClass(t,[{key:"destroy",value:function t(){this.contextBx.Event.EventEmitter.unsubscribe("BX.Calendar:onEntrySave",this.onCalendarSave);this.contextBx.Event.EventEmitter.unsubscribe("SidePanel.Slider:onMessage",this.onPostSave)}},{key:"subscribeEvents",value:function t(){this.contextBx.Event.EventEmitter.subscribe("BX.Calendar:onEntrySave",this.onCalendarSave.bind(this));this.contextBx.Event.EventEmitter.subscribe("SidePanel.Slider:onMessage",this.onPostSave.bind(this))}},{key:"onCalendarSave",value:function t(e){if(e instanceof this.contextBx.Event.BaseEvent){var n=e.getData();if(n.sliderId===this.sliderId){var a={postEntityType:this.entityType.toUpperCase(),sourceEntityType:this.entityType.toUpperCase(),sourceEntityId:this.entityId,sourceEntityData:this.entityData,entityType:"CALENDAR_EVENT",entityId:n.responseData.entryId};this.addEntityComment(a)}}}},{key:"onPostSave",value:function t(e){var n=e.getCompatData(),a=babelHelpers.slicedToArray(n,1),i=a[0];if(i.getEventId()==="Socialnetwork.PostForm:onAdd"){var o=i.getData();if(o.originatorSliderId===this.sliderId){var s={postEntityType:this.entityType.toUpperCase(),sourceEntityType:this.entityType.toUpperCase(),sourceEntityId:this.entityId,sourceEntityData:this.entityData,entityType:"BLOG_POST",entityId:o.successPostId};this.addEntityComment(s)}}}},{key:"renderButton",value:function t(){var n=!this.isVideoCallEnabled||this.mainItem==="chat";this.button=e.Tag.render(o(),n?"control-btn-text-chat":"control-btn-text-video",n?this.openChat.bind(this):this.startVideoCall.bind(this),n?e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_CHAT"):e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_NAME"),this.showMenu.bind(this));e.Dom.append(this.button,this.container)}},{key:"showLoader",value:function t(){e.Dom.addClass(this.button,"control-btn--loader")}},{key:"hideLoader",value:function t(){e.Dom.removeClass(this.button,"control-btn--loader")}},{key:"getAvailableItems",value:function t(){var n=this;return new Promise(function(t,a){var i=window.sessionStorage.getItem("b24-controlbutton-available-items");if(i){t(i);return}n.showLoader();e.ajax.runAction("intranet.controlbutton.getAvailableItems",{data:{}}).then(function(e){window.sessionStorage.setItem("b24-controlbutton-available-items",e.data);n.hideLoader();t(e.data)})})}},{key:"showMenu",value:function t(){var a=this;this.getAvailableItems().then(function(t){a.items=a.items.filter(function(e){return e&&t.indexOf(e)!==-1});var i=[];a.items.forEach(function(t){switch(t){case"videocall":if(a.isVideoCallEnabled){i.push({text:e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_VIDEOCALL"),className:"menu-popup-item-videocall",onclick:function t(){a.startVideoCall();a.popupMenu.close()}})}break;case"chat":i.push({text:e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_CHAT"),className:"menu-popup-item-chat",onclick:function t(){a.openChat();a.popupMenu.close()}});break;case"task":i.push({text:e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_TASK"),className:"menu-popup-item-task",onclick:function t(){a.openTaskSlider();a.popupMenu.close()}});break;case"calendar_event":i.push({text:e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_MEETING"),className:"menu-popup-item-meeting",onclick:function t(){a.openCalendarSlider();a.popupMenu.close()}});break;case"blog_post":i.push({text:e.Loc.getMessage("INTRANET_JS_CONTROL_BUTTON_POST"),className:"menu-popup-item-post",onclick:function t(){a.openPostSlider();a.popupMenu.close()}});break}});a.popupMenu=new n.Menu({bindElement:a.button,items:i,offsetLeft:80,offsetTop:5});a.popupMenu.show()})}},{key:"openChat",value:function t(){var n=this;this.showLoader();e.ajax.runAction("intranet.controlbutton.getChat",{data:{entityType:this.entityType,entityId:this.entityId,entityData:this.entityData},analyticsLabel:this.analyticsLabel}).then(function(t){if(top.window.BXIM&&t.data){top.BXIM.openMessenger("chat"+parseInt(t.data))}n.chatLockCounter=0;n.hideLoader()},function(t){if(t.errors[0].code==="lock_error"&&n.chatLockCounter<4){n.chatLockCounter++;n.openChat()}else{n.showHintPopup(t.errors[0].message);n.hideLoader()}})}},{key:"startVideoCall",value:function t(){var n=this;this.showLoader();e.ajax.runAction("intranet.controlbutton.getVideoCallChat",{data:{entityType:this.entityType,entityId:this.entityId,entityData:this.entityData},analyticsLabel:this.analyticsLabel}).then(function(t){if(top.window.BXIM&&t.data){top.BXIM.callTo("chat"+t.data,true)}n.chatLockCounter=0;n.hideLoader()},function(t){if(t.errors[0].code==="lock_error"&&n.chatLockCounter<4){n.chatLockCounter++;n.startVideoCall()}else{n.showHintPopup(t.errors[0].message);n.hideLoader()}})}},{key:"addEntityComment",value:function t(n){e.ajax.runAction("socialnetwork.api.livefeed.createEntityComment",{data:{params:n}})}},{key:"openCalendarSlider",value:function t(){var n=this;this.showLoader();e.ajax.runAction("intranet.controlbutton.getCalendarLink",{data:{entityType:this.entityType,entityId:this.entityId},analyticsLabel:this.analyticsLabel}).then(function(t){var e=t.data.userIds.map(function(t){return{id:parseInt(t),entityId:"user"}});new(window.top.BX||window.BX).Calendar.SliderLoader(0,{sliderId:n.sliderId,participantsEntityList:e,entryName:t.data.name,entryDescription:t.data.desc}).show();n.hideLoader()})}},{key:"openTaskSlider",value:function t(){var n=this;this.showLoader();e.ajax.runAction("intranet.controlbutton.getTaskLink",{data:{entityType:this.entityType,entityId:this.entityId,entityData:this.entityData},analyticsLabel:this.analyticsLabel}).then(function(t){BX.SidePanel.Instance.open(t.data.link,{requestMethod:"post",requestParams:t.data});n.hideLoader()})}},{key:"openPostSlider",value:function t(){var n=this;this.showLoader();e.ajax.runAction("intranet.controlbutton.getPostLink",{data:{entityType:this.entityType,entityId:this.entityId,entityData:this.entityData},analyticsLabel:this.analyticsLabel}).then(function(t){BX.SidePanel.Instance.open(t.data.link,{requestMethod:"post",requestParams:{POST_TITLE:t.data.title,POST_MESSAGE:t.data.message,destTo:t.data.destTo},data:{sliderId:n.sliderId}});n.hideLoader()})}},{key:"showHintPopup",value:function t(a){if(!a){return}new n.Popup("inviteHint"+e.Text.getRandom(8),this.button,{content:a,zIndex:15e3,angle:true,offsetTop:0,offsetLeft:50,closeIcon:false,autoHide:true,darkMode:true,overlay:false,maxWidth:400,events:{onAfterPopupShow:function t(){setTimeout(function(){this.close()}.bind(this),4e3)}}}).show()}}]);return t}();t.ControlButton=s})(this.BX.Intranet=this.BX.Intranet||{},BX,BX.Main,BX,BX.Event);
//# sourceMappingURL=control-button.bundle.map.js