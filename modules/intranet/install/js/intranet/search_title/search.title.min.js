BX.namespace("BX.Intranet.SearchTitle");BX.Intranet.SearchTitle=function(arParams){var _this=this;this.arParams={AJAX_PAGE:arParams.AJAX_PAGE,CONTAINER_ID:arParams.CONTAINER_ID,INPUT_ID:arParams.INPUT_ID,MIN_QUERY_LEN:parseInt(arParams.MIN_QUERY_LEN),FORMAT:typeof arParams.FORMAT!="undefined"&&arParams.FORMAT=="json"?"json":"html",CATEGORIES_ALL:typeof arParams.CATEGORIES_ALL!="undefined"?arParams.CATEGORIES_ALL:[],USER_URL:typeof arParams.USER_URL!="undefined"?arParams.USER_URL:"",GROUP_URL:typeof arParams.GROUP_URL!="undefined"?arParams.GROUP_URL:"",WAITER_TEXT:typeof arParams.WAITER_TEXT!="undefined"?arParams.WAITER_TEXT:"",CURRENT_TS:parseInt(arParams.CURRENT_TS),GLOBAL_SEARCH_CATEGORIES:typeof arParams.GLOBAL_SEARCH_CATEGORIES=="object"?arParams.GLOBAL_SEARCH_CATEGORIES:[],MORE_USERS_URL:arParams.MORE_USERS_URL,MORE_GROUPS_URL:arParams.MORE_GROUPS_URL||"",IS_CRM_INSTALLED:arParams.IS_CRM_INSTALLED=="Y"};if(arParams.MIN_QUERY_LEN<=0)arParams.MIN_QUERY_LEN=1;this.cache=[];this.cache_key=null;this.startText="";this.currentRow=-1;this.RESULT=null;this.CONTAINER=null;this.INPUT=null;this.xhr=null;this.blockAjax=false;this.searchStarted=false;this.ITEMS={obClientDb:null,obClientDbData:{},obClientDbDataSearchIndex:{},bMenuInitialized:false,initialized:{sonetgroups:false,menuitems:false},oDbSearchResult:{}};this.searchByAjax=false;this.selectedItemDataId=null;this.timeman=null;this.userBlock=null;this.header=null;this.CreateResultWrap=function(){if(_this.RESULT==null){this.RESULT=document.body.appendChild(document.createElement("DIV"));this.RESULT.className="title-search-result title-search-result-header search-title-top-result-header"}};this.MakeResultFromClientDB=function(t,e){var s=null;var i,a,r,l,o=null;for(i=0;i<t.length;i++){var n=t[i].toLowerCase();if(typeof _this.ITEMS.oDbSearchResult[n]!="undefined"&&_this.ITEMS.oDbSearchResult[n].length>0){for(a=0;a<_this.ITEMS.oDbSearchResult[n].length;a++){l=_this.ITEMS.oDbSearchResult[n][a];o=l.substr(0,1);for(r=0;r<_this.arParams.CATEGORIES_ALL.length;r++){if(typeof _this.arParams.CATEGORIES_ALL[r].CLIENTDB_PREFIX!="undefined"&&_this.arParams.CATEGORIES_ALL[r].CLIENTDB_PREFIX==o){if(s==null){s={}}if(typeof s.CATEGORIES=="undefined"){s.CATEGORIES={}}if(typeof s.CATEGORIES[r]=="undefined"){s.CATEGORIES[r]={ITEMS:[],TITLE:_this.arParams.CATEGORIES_ALL[r].TITLE}}if(o=="U"){s.CATEGORIES[r].ITEMS.push({ICON:typeof _this.ITEMS.obClientDbData.users[l].avatar!="undefined"?_this.ITEMS.obClientDbData.users[l].avatar:"",ITEM_ID:l,MODULE_ID:"",NAME:_this.ITEMS.obClientDbData.users[l].name,PARAM1:"",URL:_this.arParams.USER_URL.replace("#user_id#",_this.ITEMS.obClientDbData.users[l].entityId),TYPE:"users"})}else if(o=="G"){if(typeof _this.ITEMS.obClientDbData.sonetgroups[l].site!="undefined"&&_this.ITEMS.obClientDbData.sonetgroups[l].site==BX.message("SITE_ID")){s.CATEGORIES[r].ITEMS.push({ICON:typeof _this.ITEMS.obClientDbData.sonetgroups[l].avatar!="undefined"?_this.ITEMS.obClientDbData.sonetgroups[l].avatar:"",ITEM_ID:l,MODULE_ID:"",NAME:_this.ITEMS.obClientDbData.sonetgroups[l].name,PARAM1:"",URL:_this.getGroupUrl(_this.ITEMS.obClientDbData.sonetgroups[l]),TYPE:"sonetgroups",IS_MEMBER:typeof _this.ITEMS.obClientDbData.sonetgroups[l].isMember!="undefined"&&_this.ITEMS.obClientDbData.sonetgroups[l].isMember=="Y"?1:0})}}else if(o=="M"){s.CATEGORIES[r].ITEMS.push({ICON:"",ITEM_ID:l,MODULE_ID:"",NAME:_this.ITEMS.obClientDbData.menuitems[l].name,PARAM1:"",URL:_this.ITEMS.obClientDbData.menuitems[l].entityId,CHAIN:typeof _this.ITEMS.obClientDbData.menuitems[l].chain!="undefined"?_this.ITEMS.obClientDbData.menuitems[l].chain:false})}break}}}}}if(s!==null){for(var h in s.CATEGORIES){if(s.CATEGORIES.hasOwnProperty(h)){s.CATEGORIES[h].ITEMS.sort(_this.resultCmp)}}}return s};this.getGroupUrl=function(t){if(!t){return""}if(t?.groupType==="collab"&&t?.chatId>0){return _this.arParams.COLLAB_URL.replace("#DIALOG_ID#",t?.dialogId)}return _this.arParams.GROUP_URL.replace("#group_id#",t?.entityId)};this.resultCmp=function(t,e){if(typeof t.TYPE!="undefined"&&typeof e.TYPE!="undefined"&&t.TYPE=="sonetgroups"&&e.TYPE=="sonetgroups"&&typeof t.IS_MEMBER!="undefined"&&typeof e.IS_MEMBER!="undefined"){if(t.IS_MEMBER==e.IS_MEMBER){if(t.NAME==e.NAME){return 0}return t.NAME<e.NAME?-1:1}return t.IS_MEMBER>e.IS_MEMBER?-1:1}else{if(t.NAME==e.NAME){return 0}return t.NAME<e.NAME?-1:1}};this.BuildResult=function(t,e){var s=[];var i=null;var a=null;var r="";var l=true;if(typeof t==="object"&&t&&typeof t.CATEGORIES!="undefined"&&BX.type.isNotEmptyObject(t.CATEGORIES)){for(var o in t.CATEGORIES){if(o=="all")continue;if(t.CATEGORIES.hasOwnProperty(o)){if(l){l=false}i=t.CATEGORIES[o];if(typeof i.ITEMS!="undefined"){var n=0;var h=false;var c=[];for(var u in i.ITEMS){if(i.ITEMS.hasOwnProperty(u)){if(n>=7){h=true;break}var f=i.ITEMS[u];if(f.TYPE=="all")continue;if(f.TYPE=="users"||f.TYPE=="sonetgroups"){r="search-title-top-block-"+f.TYPE}else{r="search-title-top-block-section"}a=this.BuildResultItem(f);c.push(a);n++}}if(c&&f){s.push(BX.create("div",{attrs:{className:"search-title-top-block "+r},children:[BX.create("div",{props:{className:"search-title-top-subtitle"},children:[BX.create("div",{props:{className:"search-title-top-subtitle-text"},html:i.TITLE})]}),BX.create("div",{props:{className:"search-title-top-list-wrap"},children:[BX.create("div",{attrs:{className:"search-title-top-list search-title-top-list-js","bx-search-block-id":f.TYPE},children:c})]})]}));if(h&&(f.TYPE=="users"||f.TYPE=="sonetgroups")){if(f.TYPE=="users"){var d=this.arParams.MORE_USERS_URL+this.INPUT.value}else if(f.TYPE=="sonetgroups"){d=this.arParams.MORE_GROUPS_URL+this.INPUT.value}var E={URL:d,ITEM_ID:f.TYPE+"_more"};var _=this.BuildMoreBlock(E);s.push(_)}}}}}}s.push(BX.create("div",{attrs:{style:"margin-bottom: 20px;"+(!e?"display:none;":""),id:"title-search-waiter"},children:[BX.create("div",{props:{className:"title-search-waiter"},children:[BX.create("span",{props:{className:"title-search-waiter-img"}}),BX.create("span",{props:{className:"title-search-waiter-text"},html:_this.arParams.WAITER_TEXT})]})]}));s=this.BuildGlobalSearchCategories(s);var m=BX.create("div",{props:{className:"search-title-top-result"},children:s});return m};this.BuildResultItem=function(t){if(!(typeof t=="object"&&t))return;if(this.selectedItemDataId==null){this.selectedItemDataId=t.ITEM_ID}var e=BX.create("div",{attrs:{className:"search-title-top-item search-title-top-item-js"+(this.selectedItemDataId==t.ITEM_ID?" search-title-top-item-selected":""),title:typeof t.CHAIN!="undefined"&&BX.type.isArray(t.CHAIN)?t.CHAIN.join(" -> "):"","bx-search-item-id":t.ITEM_ID},children:[BX.create("a",{attrs:{href:t.URL,className:"search-title-top-item-link"},dataset:{onclick:BX.Type.isStringFilled(t.ON_CLICK)?t.ON_CLICK:null},events:{click:BX.Type.isStringFilled(t.ON_CLICK)?this.invokeItemOnClick.bind(this):null},children:[t.TYPE=="users"||t.TYPE=="sonetgroups"?BX.create("span",{attrs:{style:typeof t.ICON!="undefined"&&t.ICON.length>0?"background-image: url('"+encodeURI(t.ICON)+"')":""},props:{className:"search-title-top-item-img"+(!t.ICON?" search-title-top-item-img-default-"+t.TYPE:"")}}):"",BX.create("span",{props:{className:"search-title-top-item-text"},children:[BX.create("span",{html:t.NAME})]})]}),t.TYPE=="users"?BX.create("span",{attrs:{className:"search-title-top-item-message"},events:{click:BX.proxy((function(){if(typeof BXIM!=="undefined"){BXIM.openMessenger(this.userId)}else{window.open("","","status=no,scrollbars=yes,resizable=yes,width=700,height=550,top="+Math.floor((screen.height-550)/2-14)+",left="+Math.floor((screen.width-700)/2-5));return false}}),{userId:t.ITEM_ID.substring(1)})}}):null],events:{mouseover:BX.proxy((function(){this.UnSelectAll();this.SelectItem(BX.proxy_context)}),this),mouseout:BX.proxy((function(){this.UnSelectItem(BX.proxy_context);this.selectedItemDataId=null}),this)}});return e};this.BuildMoreBlock=function(t){var e=BX.create("div",{attrs:{className:"search-title-top-block search-title-top-more-block",style:"margin-top: -35px;"},children:[BX.create("div",{props:{className:"search-title-top-list-wrap"},children:[BX.create("div",{attrs:{className:"search-title-top-list search-title-top-list-js"},children:[BX.create("div",{attrs:{className:"search-title-top-more search-title-top-item-js","bx-search-item-id":t.ITEM_ID},children:[BX.create("a",{attrs:{className:"search-title-top-more-text",href:t.URL},html:BX.message("SEARCH_MORE")})]})]})]})]});return e};this.BuildGlobalSearchCategories=function(t){var e=[];for(var s in this.arParams.GLOBAL_SEARCH_CATEGORIES){if(!this.arParams.GLOBAL_SEARCH_CATEGORIES.hasOwnProperty(s))continue;var i=this.arParams.GLOBAL_SEARCH_CATEGORIES[s].limited===true;var a={NAME:this.arParams.GLOBAL_SEARCH_CATEGORIES[s].text,URL:this.arParams.GLOBAL_SEARCH_CATEGORIES[s].url+(i?"":this.INPUT.value),ITEM_ID:s};var r=this.BuildResultItem(a);e.push(r)}var l=BX.create("div",{attrs:{className:"search-title-top-block search-title-top-block-tools",id:"search-title-block-tools"},children:[BX.create("div",{props:{className:"search-title-top-subtitle"},children:[BX.create("div",{props:{className:"search-title-top-subtitle-text"},html:BX.message("GLOBAL_SEARCH")})]}),BX.create("div",{attrs:{className:"search-title-top-list-height-wrap",id:"search-title-global-categories-height-wrap"},children:[BX.create("div",{attrs:{className:"search-title-top-list-wrap",id:"search-title-global-categories-wrap"},children:[BX.create("div",{attrs:{className:"search-title-top-list search-title-top-list-js"},children:e}),BX.create("div",{attrs:{className:"search-title-top-arrow"}})]})]})]});t.push(l);return t};this.BuildEntities=function(t){var e=[];var s=[];var i=[];var a=[];var r=[];var l=[];var o=[];const n=[];const h=new Map;var c=[];var u=[];var f=false,d=false,E=false,_=false,m=false,p=false,I=false,T=false,S=false;var B=t&&t.data&&BX.type.isArray(t.data.items)?t.data.items:[];for(var R=0;R<B.length;R++){var C=t.data.items[R];var A={NAME:BX.util.htmlspecialchars(C.title),URL:C.links.show,ITEM_ID:C.type+C.id};if(C.type==="CONTACT"){if(e.length<10){e.push(A)}else{f=true}}else if(C.type==="COMPANY"){if(s.length<10){s.push(A)}else{d=true}}else if(C.type==="DEAL"){if(i.length<10){i.push(A)}else{E=true}}else if(C.type==="LEAD"){if(a.length<10){a.push(A)}else{_=true}}else if(C.type==="QUOTE"){if(r.length<10){r.push(A)}else{I=true}}else if(C.type==="INVOICE"){if(l.length<10){l.push(A)}else{m=true}}else if(C.type==="SMART_INVOICE"){if(o.length<10){o.push(A)}else{p=true}}else if(C.module==="crm"&&C.type.indexOf("DYNAMIC_")===0){const t=C?.attributes?.customSectionTitle;if(t){if(!h.has(t)){h.set(t,[])}const e=h.get(t,t);if(e.length<10){e.push(A)}}else if(n.length<10){n.push(A)}}else if(C.module==="disk"){if(c.length<10){c.push(A)}else{T=true}}else if(C.type==="TASK"){if(u.length<10){u.push(A)}else{S=true}}}var y={};if(t&&t.data&&BX.type.isArray(t.data.limits)){t.data.limits.forEach((function(t){if(!BX.type.isPlainObject(t)){return}if(BX.type.isNotEmptyString(t.type)){y[t.type.toLowerCase()]=t}else if(BX.type.isNotEmptyString(t.module)){y[t.module.toLowerCase()]=t}}))}this.BuildEntityBlock(i,"CRM: "+BX.message("SEARCH_CRM_DEAL"),"deal",y.deal);if(E){A={URL:this.arParams.GLOBAL_SEARCH_CATEGORIES["deal"]["url"]+this.INPUT.value,ITEM_ID:"deal_more"};var v=this.BuildMoreBlock(A);BX.firstChild(_this.RESULT).insertBefore(v,BX("search-title-block-tools"))}this.BuildEntityBlock(e,"CRM: "+BX.message("SEARCH_CRM_CONTACT"),"contact",y.contact);if(f){A={URL:this.arParams.GLOBAL_SEARCH_CATEGORIES["contact"]["url"]+this.INPUT.value,ITEM_ID:"contact_more"};var v=this.BuildMoreBlock(A);BX.firstChild(_this.RESULT).insertBefore(v,BX("search-title-block-tools"))}this.BuildEntityBlock(s,"CRM: "+BX.message("SEARCH_CRM_COMPANY"),"company",y.company);if(d){A={URL:this.arParams.GLOBAL_SEARCH_CATEGORIES["company"]["url"]+this.INPUT.value,ITEM_ID:"company_more"};var v=this.BuildMoreBlock(A);BX.firstChild(_this.RESULT).insertBefore(v,BX("search-title-block-tools"))}this.BuildEntityBlock(a,"CRM: "+BX.message("SEARCH_CRM_LEAD"),"lead",y.lead);if(_){A={URL:this.arParams.GLOBAL_SEARCH_CATEGORIES["lead"]["url"]+this.INPUT.value,ITEM_ID:"lead_more"};var v=this.BuildMoreBlock(A);BX.firstChild(_this.RESULT).insertBefore(v,BX("search-title-block-tools"))}var N=BX.prop.getString(this.arParams.GLOBAL_SEARCH_CATEGORIES["invoice"],"text","");this.BuildEntityBlock(l,"CRM: "+N,"invoice",y.invoice);if(m){A={URL:this.arParams.GLOBAL_SEARCH_CATEGORIES["invoice"]["url"]+this.INPUT.value,ITEM_ID:"invoice_more"};var v=this.BuildMoreBlock(A);BX.firstChild(_this.RESULT).insertBefore(v,BX("search-title-block-tools"))}var L=BX.prop.getString(this.arParams.GLOBAL_SEARCH_CATEGORIES["smart_invoice"],"text","");this.BuildEntityBlock(o,"CRM: "+L,"smart_invoice",y["smart_invoice"]);if(p){A={URL:this.arParams.GLOBAL_SEARCH_CATEGORIES["smart_invoice"]["url"]+this.INPUT.value,ITEM_ID:"smart_invoice_more"};var v=this.BuildMoreBlock(A);BX.firstChild(_this.RESULT).insertBefore(v,BX("search-title-block-tools"))}this.BuildEntityBlock(r,"CRM: "+BX.message("SEARCH_CRM_QUOTE"),"quote",y.quote);if(I){A={URL:this.arParams.GLOBAL_SEARCH_CATEGORIES["quote"]["url"]+this.INPUT.value,ITEM_ID:"quote_more"};var v=this.BuildMoreBlock(A);BX.firstChild(_this.RESULT).insertBefore(v,BX("search-title-block-tools"))}this.BuildEntityBlock(n,"CRM: "+BX.message("SEARCH_CRM_DYNAMIC"),"dynamic");h.forEach(((t,e)=>{const s=BX.util.htmlspecialchars(e);const i=`\n\t\t\t\t<span class="search-title-top-subtitle-prefix-wrapper" title="${s}">${s}</span>:\n\t\t\t`;this.BuildEntityBlock(t,`${i} ${BX.message("SEARCH_CRM_DYNAMIC")}`,"dynamic")}));this.BuildEntityBlock(c,BX.message("SEARCH_DISK"),"disk",y.disk);if(T){A={URL:this.arParams.GLOBAL_SEARCH_CATEGORIES["disk"]["url"]+this.INPUT.value,ITEM_ID:"disk_more"};var v=this.BuildMoreBlock(A);BX.firstChild(_this.RESULT).insertBefore(v,BX("search-title-block-tools"))}this.BuildEntityBlock(u,BX.message("SEARCH_TASKS"),"task",y.task);if(S){A={URL:this.arParams.GLOBAL_SEARCH_CATEGORIES["tasks"]["url"]+this.INPUT.value,ITEM_ID:"task_more"};var v=this.BuildMoreBlock(A);BX.firstChild(_this.RESULT).insertBefore(v,BX("search-title-block-tools"))}BX("title-search-waiter").style.display="none";_this.checkSelectedItem()};this.BuildEntityBlock=function(t,e,s,i){if(t.length>0){var a=[];for(var r in t){var l=_this.BuildResultItem(t[r]);a.push(l)}if(a){this.BuildEntity(a,e,s)}}else if(BX.type.isPlainObject(i)){this.buildLimits(i,e)}};this.BuildEntity=function(t,e,s){var i=BX.create("div",{attrs:{className:"search-title-top-block search-title-top-block-section"},children:[BX.create("div",{props:{className:"search-title-top-subtitle"},children:[BX.create("div",{props:{className:"search-title-top-subtitle-text"},html:e})]}),BX.create("div",{props:{className:"search-title-top-list-wrap"},children:[BX.create("div",{attrs:{className:"search-title-top-list search-title-top-list-js","bx-search-block-id":s},children:t})]})]});BX.firstChild(_this.RESULT).insertBefore(i,BX("search-title-block-tools"))};this.buildLimits=function(t,e){var s=BX.create("div",{attrs:{className:"search-title-top-block search-title-top-block-section"},html:'<div class="search-title-top-subtitle">'+'<div class="search-title-top-subtitle-text">'+e+"</div>"+"</div>"+'<div class="search-title-top-list-wrap">'+'<div class="search-title-top-list">'+'<div class="search-title-top-list-limits">'+'<div class="search-title-top-list-limits-block">'+'<span class="search-title-top-list-limits-icon"></span>'+"</div>"+'<div class="search-title-top-list-limits-block">'+'<div class="search-title-top-list-limits-name">'+(BX.type.isString(t.title)?t.title:"")+"</div>"+'<div class="search-title-top-list-limits-content">'+(BX.type.isString(t.description)?t.description:"")+"</div>"+(BX.type.isArray(t.buttons)&&t.buttons.length>0?'<div class="ui-btn-container ui-btn-container-center">'+t.buttons.join("")+"</div>":"")+"</div>"+"</div>"+"</div>"+"</div>"});BX.firstChild(_this.RESULT).insertBefore(s,BX("search-title-block-tools"))};this.invokeItemOnClick=function(event){event.preventDefault();eval("(function() {"+event.currentTarget.dataset["onclick"]+"})();")};this.checkSelectedItem=function(){var t=BX.findChild(_this.RESULT,{className:"search-title-top-item-selected"},true);if(BX.type.isDomNode(t)&&BX("search-title-global-categories-wrap").contains(t)){var e=BX.findChild(_this.RESULT,{className:"search-title-top-item-js"},true);_this.UnSelectAll();_this.SelectItem(e)}};this.ShowResult=function(t,e,s){_this.CreateResultWrap();var i=0;var a=0;var r=0;if(BX.browser.IsIE()){i=0;a=1;r=-1;if(/MSIE 7/i.test(navigator.userAgent)){i=-1;a=-1;r=-2}}var l=BX.pos(_this.CONTAINER);l.width=l.right-l.left;_this.RESULT.style.position="absolute";_this.RESULT.style.top=l.bottom+i-1+"px";_this.RESULT.style.left=l.left+a+"px";_this.RESULT.style.width=l.width+r+"px";if(typeof _this.arParams.FORMAT!="undefined"&&_this.arParams.FORMAT=="json"){t=_this.BuildResult(t,!!e);BX.cleanNode(_this.RESULT);if(BX.type.isDomNode(t)&&t.innerHTML.length){_this.RESULT.appendChild(t);if(BX.type.isDomNode(BX("search-title-block-tools"))&&BX.type.isDomNode(BX("search-title-global-categories-wrap"))){BX.bind(BX("search-title-global-categories-wrap"),"mouseover",BX.proxy((function(){_this.toggleGlobalCategories("open")}),_this));BX.bind(BX("search-title-global-categories-wrap"),"mouseout",BX.proxy((function(){_this.toggleGlobalCategories("close")}),_this));_this.RESULT.style.display="block"}else{_this.RESULT.style.display="block"}if(s){BX("title-search-waiter").style.display="block";if(_this.arParams.IS_CRM_INSTALLED){var o=BX.ajax.runAction("crm.api.entity.search",{data:{searchQuery:this.INPUT.value,options:{scope:"index"}}});o.then(this.BuildEntities.bind(this))}var n=BX.ajax.runAction("disk.commonActions.search",{data:{searchQuery:this.INPUT.value}});n.then(this.BuildEntities.bind(this));var h=BX.ajax.runAction("tasks.task.search",{data:{searchQuery:this.INPUT.value}});h.then(this.BuildEntities.bind(this))}}}else{_this.RESULT.innerHTML=t}};this.toggleGlobalCategories=function(t){var e=BX("search-title-global-categories-wrap");var s=BX("search-title-global-categories-height-wrap");if(!BX.type.isDomNode(e)||!BX.type.isDomNode(s))return;if(t=="open"){BX.addClass(e,"search-title-top-list-wrap-hover");s.style.height=e.offsetHeight+"px"}else{var i=BX.findChild(e,{className:"search-title-top-item-selected"},true,false);if(!i){BX.removeClass(e,"search-title-top-list-wrap-hover");s.style.height=""}}};this.SyncResult=function(t,e){var s=null,i=[],a=[],r=[],l=[];e=e.toLowerCase();for(var o=0;o<_this.arParams.CATEGORIES_ALL.length;o++){if(typeof _this.arParams.CATEGORIES_ALL[o].CODE!="undefined"){if(typeof t.CATEGORIES[o]!="undefined"){if(_this.arParams.CATEGORIES_ALL[o].CODE=="custom_menuitems"){s={};for(var n=0;n<t.CATEGORIES[o].ITEMS.length;n++){s[t.CATEGORIES[o].ITEMS[n].ITEM_ID]=_this.ConvertAjaxToClientDB(t.CATEGORIES[o].ITEMS[n],"menuitems");r.push(t.CATEGORIES[o].ITEMS[n].ITEM_ID)}BX.onCustomEvent(_this,"onFinderAjaxSuccess",[s,_this.ITEMS,"menuitems"])}else if(_this.arParams.CATEGORIES_ALL[o].CODE=="custom_sonetgroups"){s={};for(n=0;n<t.CATEGORIES[o].ITEMS.length;n++){s[t.CATEGORIES[o].ITEMS[n].ITEM_ID]=_this.ConvertAjaxToClientDB(t.CATEGORIES[o].ITEMS[n],"sonetgroups");a.push(t.CATEGORIES[o].ITEMS[n].ITEM_ID)}BX.onCustomEvent(_this,"onFinderAjaxSuccess",[s,_this.ITEMS,"sonetgroups"])}else if(_this.arParams.CATEGORIES_ALL[o].CODE=="custom_users"){for(n=0;n<t.CATEGORIES[o].ITEMS.length;n++){i.push(t.CATEGORIES[o].ITEMS[n].ITEM_ID)}}}var h=0;if(_this.arParams.CATEGORIES_ALL[o].CODE=="custom_users"&&BX.type.isNotEmptyString(e)&&typeof _this.ITEMS.oDbSearchResult[e]!="undefined"&&_this.ITEMS.oDbSearchResult[e].length>0){l=[];for(h=0;h<_this.ITEMS.oDbSearchResult[e].length;h++){if(_this.ITEMS.oDbSearchResult[e][h].match(/U(\d+)/)!==null){l.push(_this.ITEMS.oDbSearchResult[e][h])}}if(l.length>0){BX.onCustomEvent("syncClientDb",[_this.ITEMS,false,l,i,"users"])}}if(_this.arParams.CATEGORIES_ALL[o].CODE=="custom_sonetgroups"&&BX.type.isNotEmptyString(e)&&typeof _this.ITEMS.oDbSearchResult[e]!="undefined"&&_this.ITEMS.oDbSearchResult[e].length>0){l=[];for(h=0;h<_this.ITEMS.oDbSearchResult[e].length;h++){if(_this.ITEMS.oDbSearchResult[e][h].match(/G(\d+)/)!==null){l.push(_this.ITEMS.oDbSearchResult[e][h])}}if(l.length>0){BX.onCustomEvent("syncClientDb",[_this.ITEMS,false,l,a,"sonetgroups"])}}if(_this.arParams.CATEGORIES_ALL[o].CODE=="custom_menuitems"&&BX.type.isNotEmptyString(e)&&typeof _this.ITEMS.oDbSearchResult[e]!="undefined"&&_this.ITEMS.oDbSearchResult[e].length>0){l=[];for(h=0;h<_this.ITEMS.oDbSearchResult[e].length;h++){if(_this.ITEMS.oDbSearchResult[e][h].match(/M\/(.+)/)!==null){l.push(_this.ITEMS.oDbSearchResult[e][h])}}if(l.length>0){BX.onCustomEvent("syncClientDb",[_this.ITEMS,false,l,r,"menuitems"])}}}}};this.ConvertAjaxToClientDB=function(t,e){var s=null;if(e=="sonetgroups"){s={id:"G"+t.ID,entityId:t.ID,name:t.NAME,avatar:t.ICON,desc:"",isExtranet:t.IS_EXTRANET?"Y":"N",site:t.SITE,checksum:t.CHECKSUM,isMember:typeof t.IS_MEMBER!="undefined"&&t.IS_MEMBER?"Y":"N"}}else if(e=="menuitems"){s={id:"M"+t.URL,entityId:t.URL,name:t.NAME,checksum:t.CHECKSUM,chain:typeof t.CHAIN!="undefined"&&BX.type.isArray(t.CHAIN)?t.CHAIN:null}}else if(e=="users"){s={id:"U"+t.ID,entityId:t.ID,name:t.NAME,login:t.LOGIN,active:t.ACTIVE,avatar:t.ICON,desc:t.DESCRIPTION,isExtranet:"N",isEmail:"N",checksum:t.CHECKSUM}}return s};this.onKeyPress=function(t){_this.CreateResultWrap();var e=BX.findChild(_this.RESULT,{tag:"div",class:"search-title-top-result"},true);if(!e)return false;var s=BX.findChildren(_this.RESULT,{className:"search-title-top-list-js"},true);switch(t){case 27:_this.RESULT.style.display="none";break;case 40:if(_this.RESULT.style.display=="none")_this.RESULT.style.display="block";var i=BX.findChildren(_this.RESULT,{className:"search-title-top-item-js"},true);if(this.selectedItemDataId===null){_this.SelectItem(i[0])}else{var a=_this.RESULT.querySelector("[bx-search-item-id='"+_this.selectedItemDataId+"']");if(!BX.type.isDomNode(a))return false;var r=BX.findParent(a,{className:"search-title-top-list-js"},true);if(!BX.type.isDomNode(r))return false;var l=BX.findChildren(r,{className:"search-title-top-item-js"},true);var o=a.offsetLeft;var n=a.offsetTop;var h=a.offsetWidth;var c=o+h;var u=[];var f=null;for(var d in l){if(l[d].offsetTop<=n){continue}else{if(f===null)f=l[d].offsetTop}if(f&&l[d].offsetTop==f){u.push(l[d])}}if(u.length>0){_this.UnSelectAll();for(d in u){if(u[d].offsetLeft+u[d].offsetWidth>o){var E=u[Number(d)+1];if(E&&E.offsetLeft<=c){var _=u[d].offsetLeft+u[d].offsetWidth-o;var m=c-E.offsetLeft;if(m>_){_this.SelectItem(E);return true}}_this.SelectItem(u[d]);return true}}_this.SelectItem(u[u.length-1]);return true}else{for(var d in s){if(s[d]==r){if(s[Number(d)+1]){_this.UnSelectAll();var p=BX.firstChild(s[Number(d)+1],{className:"search-title-top-item-js"},true);if(BX.type.isDomNode(p)){_this.SelectItem(p)}return true}}}}}return true;case 38:if(_this.RESULT.style.display=="none")_this.RESULT.style.display="block";if(this.selectedItemDataId!==null){a=_this.RESULT.querySelector("[bx-search-item-id='"+_this.selectedItemDataId+"']");if(!BX.type.isDomNode(a))return false;r=BX.findParent(a,{className:"search-title-top-list-js"},true);if(!BX.type.isDomNode(r))return false;l=BX.findChildren(r,{className:"search-title-top-item-js"},true);o=a.offsetLeft;n=a.offsetTop;h=a.offsetWidth;c=o+h;u=[];f=null;l=l.reverse();for(d in l){if(l[d].offsetTop>=n){continue}else{if(f===null)f=l[d].offsetTop}if(f&&l[d].offsetTop==f){u.push(l[d])}}u=u.reverse();if(u.length>0){_this.UnSelectAll();for(d in u){if(u[d].offsetLeft+u[d].offsetWidth>o){E=u[Number(d)+1];if(E&&E.offsetLeft<=c){_=u[d].offsetLeft+u[d].offsetWidth-o;m=c-E.offsetLeft;if(m>_){_this.SelectItem(E);return true}}_this.SelectItem(u[d]);return true}}_this.SelectItem(u[u.length-1]);return true}else{for(var d in s){if(s[d]==r){if(s[Number(d)-1]){_this.UnSelectAll();p=BX.firstChild(s[Number(d)-1],{className:"search-title-top-item-js"},true);if(BX.type.isDomNode(p)){_this.SelectItem(p)}}}}}}return true;case 39:if(this.selectedItemDataId!==null){a=_this.RESULT.querySelector("[bx-search-item-id='"+_this.selectedItemDataId+"']");if(!BX.type.isDomNode(a))return false;r=BX.findParent(a,{className:"search-title-top-list-js"},true);if(!BX.type.isDomNode(r))return false;l=BX.findChildren(r,{className:"search-title-top-item-js"},true);o=a.offsetLeft;n=a.offsetTop;for(d in l){if(l[d].offsetTop!=n)continue;if(l[d].offsetLeft>o){_this.UnSelectAll();_this.SelectItem(l[d]);return true}}}return true;case 37:if(this.selectedItemDataId!==null){a=_this.RESULT.querySelector("[bx-search-item-id='"+_this.selectedItemDataId+"']");if(!BX.type.isDomNode(a))return false;r=BX.findParent(a,{className:"search-title-top-list-js"},true);if(!BX.type.isDomNode(r))return false;l=BX.findChildren(r,{className:"search-title-top-item-js"},true);if(l){l=l.reverse()}o=a.offsetLeft;n=a.offsetTop;for(d in l){if(l[d].offsetTop!=n)continue;if(l[d].offsetLeft<o){_this.UnSelectAll();_this.SelectItem(l[d]);return true}}}return true;case 13:if(_this.RESULT.style.display=="block"&&this.selectedItemDataId!==null){a=_this.RESULT.querySelector("[bx-search-item-id='"+_this.selectedItemDataId+"']");if(BX.type.isDomNode(a)){var I=BX.findChild(a,{tag:"a"},true);BX.fireEvent(I,"click")}}return false}return false};this.UnSelectAll=function(){var t=BX.findChildren(_this.RESULT,{className:"search-title-top-item-selected"},true);for(var e=0;e<t.length;e++){_this.UnSelectItem(t[e])}};this.SelectItem=function(t){if(!BX.type.isDomNode(t))return;BX.addClass(t,"search-title-top-item-selected");_this.selectedItemDataId=t.getAttribute("bx-search-item-id");var e=BX.findParent(t,{className:"search-title-top-block-tools"},true);if(BX.type.isDomNode(e)){_this.toggleGlobalCategories("open")}};this.UnSelectItem=function(t){if(!BX.type.isDomNode(t))return;BX.removeClass(t,"search-title-top-item-selected");var e=BX.findParent(t,{className:"search-title-top-block-tools"},true);if(BX.type.isDomNode(e)){_this.toggleGlobalCategories("close")}};this.onFocusGain=function(){if(_this.RESULT&&_this.RESULT.innerHTML.length){_this.RESULT.style.display="block"}BX.onCustomEvent(this,"Intranet.Search.Title:onFocusAction",["gain"])};this.onFocusLost=function(){BX.onCustomEvent(this,"Intranet.Search.Title:onFocusAction",["lost"])};this.onKeyUp=function(t){if(!_this.searchStarted){return false}t=t||window.event;if(t.keyCode==37||t.keyCode==38||t.keyCode==39||t.keyCode==40)return;var e=BX.util.trim(_this.INPUT.value);if(e.length>=1&&(e==_this.oldValue||e==_this.oldClientValue||e==_this.startText)&&!(e==_this.oldValue&&e!=_this.oldClientValue&&_this.oldValue.length==_this.arParams.MIN_QUERY_LEN&&_this.oldClientValue.length==_this.arParams.MIN_QUERY_LEN-1)){return}if(_this.xhr){_this.xhr.abort()}if(e.length>=1){BX.removeClass(_this.CONTAINER.parentNode.parentNode,"header-search-empty");BX.addClass(_this.CONTAINER.parentNode.parentNode,"header-search-not-empty");_this.selectedItemDataId=null;_this.cache_key=_this.arParams.INPUT_ID+"|"+e;if(_this.cache[_this.cache_key]==null){_this.blockAjax=false;var s=[e];_this.oldClientValue=e;var i={searchString:e};BX.onCustomEvent("findEntityByName",[_this.ITEMS,i,{},_this.ITEMS.oDbSearchResult]);if(i.searchString!=e){s.push(i.searchString)}var a=_this.MakeResultFromClientDB(s,e);_this.searchByAjax=false;_this.ShowResult(a,e.length>=_this.arParams.MIN_QUERY_LEN);if(e.length>=_this.arParams.MIN_QUERY_LEN){_this.SendAjax(e)}}else{_this.blockAjax=true;_this.oldClientValue=e;_this.ShowResult(_this.cache[_this.cache_key],true,true)}}else{BX.addClass(_this.CONTAINER.parentNode.parentNode,"header-search-empty");BX.removeClass(_this.CONTAINER.parentNode.parentNode,"header-search-not-empty");if(_this.RESULT){_this.RESULT.style.display="none"}}};this.SendAjax=BX.debounce((function(t){if(_this.blockAjax){return}_this.oldValue=t;_this.xhr=BX.ajax({method:"POST",dataType:_this.arParams.FORMAT,url:_this.arParams.AJAX_PAGE,data:{ajax_call:"y",INPUT_ID:_this.arParams.INPUT_ID,FORMAT:_this.arParams.FORMAT,q:t},preparePost:true,onsuccess:function(e){if(typeof e!="undefined"&&e&&e.CATEGORIES!="undefined"){for(var s in e.CATEGORIES){if(e.CATEGORIES.hasOwnProperty(s)){e.CATEGORIES[s].ITEMS.sort(_this.resultCmp)}}_this.cache[_this.cache_key]=e;_this.searchByAjax=true;_this.ShowResult(e,false,true);_this.SyncResult(e,t)}}})}),1e3);this.onWindowResize=function(){if(_this.RESULT!=null){_this.ShowResult()}};this.onKeyDown=function(t){t=t||window.event;_this.searchStarted=!(t.keyCode==27||t.keyCode==40||t.keyCode==38||t.keyCode==13);if(_this.RESULT&&_this.RESULT.style.display=="block"){if(_this.onKeyPress(t.keyCode)){return BX.PreventDefault(t)}}};this.Init=function(){this.CONTAINER=BX(this.arParams.CONTAINER_ID);this.INPUT=BX(this.arParams.INPUT_ID);this.startText=this.oldValue=this.INPUT.value;BX.bind(this.INPUT,"focus",BX.proxy(this.onFocusGain,this));BX.bind(this.INPUT,"blur",BX.proxy(this.onFocusLost,this));this.INPUT.onkeydown=this.onKeyDown;BX.Finder(false,"searchTitle",[],{},_this);BX.onCustomEvent(_this,"initFinderDb",[this.ITEMS,"searchTitle",null,["users","sonetgroups","menuitems"],_this]);setTimeout((function(){_this.CheckOldStorage(_this.ITEMS.obClientDbData)}),5e3);if(!this.ITEMS.bLoadAllInitialized){BX.addCustomEvent("loadAllFinderDb",BX.delegate((function(t){this.ItemsLoadAll(t)}),this));this.ITEMS.bLoadAllInitialized=true}var t=BX.findChild(this.CONTAINER,{className:"search-title-top-delete"},true);if(BX.type.isDomNode(t)){BX.bind(t,"click",BX.proxy((function(t){this.INPUT.value="";this.onKeyUp()}),this))}BX.bind(this.INPUT,"input",BX.proxy((function(e){this.onKeyDown(e);this.onKeyUp(e);var s=BX.findChild(this.CONTAINER,{className:"header-search-icon"},true);if(BX.type.isDomNode(t)){s.style.display=this.INPUT.value!=""?"none":"block"}}),this));BX.bind(document,"click",BX.proxy(this.checkAutoHide,this))};this.checkAutoHide=function(t){if(_this.RESULT&&!_this.RESULT.contains(t.target)&&!document.forms["search-form"].contains(t.target)){setTimeout((function(){_this.RESULT.style.display="none"}),250)}};this.CheckOldStorage=function(t){if(!_this.ITEMS.obClientDb){return}var e=null;var s=60*60*24*30;var i=null;for(var a in t){if(t.hasOwnProperty(a)){if(a=="sonetgroups"||a=="menuitems"){i=false;for(var r in t[a]){if(t[a].hasOwnProperty(r)){e=t[a][r];if(typeof e.timestamp!="undefined"&&parseInt(e.timestamp)>0&&_this.arParams.CURRENT_TS>parseInt(e.timestamp)+s){i=true}break}}if(i){BX.Finder.clearEntityDb(_this.ITEMS.obClientDb,a)}}}}};this.ItemsLoadAll=function(t){if(typeof t.entity!="undefined"&&typeof this.ITEMS.initialized[t.entity]!="undefined"&&!this.ITEMS.initialized[t.entity]&&typeof t.callback=="function"){if(t.entity=="sonetgroups"||t.entity=="menuitems"){BX.ajax.runAction("intranet.searchentity.getall",{data:{entity:t.entity}}).then(function(e){if(typeof e.data.items!="undefined"){BX.onCustomEvent("onFinderAjaxLoadAll",[e.data.items,this.ITEMS,t.entity]);t.callback()}}.bind(this),(function(t){}))}this.ITEMS.initialized[t.entity]=true}};BX.ready((function(){_this.Init(arParams)}))};
//# sourceMappingURL=search.title.map.js