BX.namespace("BX.Catalog");BX.Catalog.StepOperations=function(){var t=function(t){this.errorCode=0;this.url="";this.stepOptions={ajaxSessionID:"",maxExecutionTime:0,maxOperationCounter:0};this.finish=false;this.currentState={counter:0,operationCounter:0,errorCounter:0,lastID:0};this.ajaxParams={};this.visual={startBtnID:"",stopBtnID:"",resultContID:"",errorContID:"",errorDivID:"",timeFieldID:""};this.buttons={start:null,stop:null};this.content={result:null,errors:null,errorsFrame:null,timeField:null};if(BX.type.isPlainObject(t)){if(t.url===undefined||!BX.type.isNotEmptyString(t.url))this.addError(-2);else this.url=t.url;if(BX.type.isPlainObject(t.options)){this.stepOptions.ajaxSessionID=t.options.ajaxSessionID;this.stepOptions.maxExecutionTime=t.options.maxExecutionTime;this.stepOptions.maxOperationCounter=t.options.maxOperationCounter;this.currentState.counter=t.options.counter}else{this.addError(-4)}if(BX.type.isPlainObject(t.ajaxParams))this.ajaxParams=t.ajaxParams;if(BX.type.isPlainObject(t.visual))this.visual=t.visual}else{this.addError(-1)}if(this.errorCode===0)BX.ready(BX.proxy(this.init,this))};t.prototype.init=function(){if(this.errorCode===0){if(!!this.visual.startBtnID){this.buttons.start=BX(this.visual.startBtnID);if(!this.buttons.start)this.addError(-131072)}else{this.addError(-65536)}if(!!this.visual.stopBtnID){this.buttons.stop=BX(this.visual.stopBtnID);if(!this.buttons.stop)this.addError(-524288)}else{this.addError(-262144)}this.content.timeField=BX(this.visual.timeFieldID)}if(this.errorCode===0){BX.bind(this.buttons.start,"click",BX.proxy(this.startOperation,this));BX.bind(this.buttons.stop,"click",BX.proxy(this.stopOperation,this));if(!!this.content.timeField)BX.bind(this.content.timeField,"change",BX.proxy(this.changeMaxTime,this))}};t.prototype.extendAjaxParams=function(){};t.prototype.initResultDom=function(){if(this.content.result===null){this.content.result=BX(this.visual.resultContID);this.content.errorsFrame=BX(this.visual.errorDivID);this.content.errors=BX(this.visual.errorContID)}};t.prototype.nextStep=function(){var t;for(t in this.stepOptions){if(this.stepOptions.hasOwnProperty(t))this.ajaxParams[t]=this.stepOptions[t]}for(t in this.currentState){if(this.currentState.hasOwnProperty(t))this.ajaxParams[t]=this.currentState[t]}this.ajaxParams.sessid=BX.bitrix_sessid();this.ajaxParams.lang=BX.message("LANGUAGE_ID");this.extendAjaxParams();BX.showWait();BX.ajax.loadJSON(this.url,this.ajaxParams,BX.proxy(this.nextStepResult,this))};t.prototype.nextStepResult=function(t){BX.closeWait();if(BX.type.isPlainObject(t)){this.initResultDom();this.currentState.lastID=t.lastID;this.stepOptions.maxOperationCounter=t.maxOperationCounter;this.currentState.operationCounter=parseInt(t.operationCounter,10);if(isNaN(this.currentState.operationCounter))this.currentState.operationCounter=0;this.showResult(t.message);this.currentState.errorCounter=parseInt(t.errorCounter,10);if(isNaN(this.currentState.errorCounter))this.currentState.errorCounter=0;if(this.currentState.errorCounter>0)this.showErrors(t.errors);if(this.finish)this.finishOperation();else this.checkOperation(t.finishOperation)}};t.prototype.checkOperation=function(t){if(!!t)this.finishOperation();else this.nextStep()};t.prototype.showResult=function(t){if(!!this.content.result)BX.adjust(this.content.result,{html:t,style:{display:"block"}})};t.prototype.showErrors=function(t){if(!!this.content.errors){if(BX.type.isNotEmptyString(t))this.content.errors.innerHTML=this.content.errors.innerHTML+t;BX.style(this.content.errorsFrame,"display","block")}};t.prototype.finishOperation=function(){this.currentState.operationCounter=0;this.currentState.errorCounter=0;this.currentState.lastID=0;this.buttons.start.disabled=false;this.buttons.stop.disabled=true;this.finish=false};t.prototype.startOperation=function(){if(!this.buttons.start.disabled){this.changeMaxTime();this.buttons.start.disabled=true;this.buttons.stop.disabled=false;this.nextStep()}};t.prototype.stopOperation=function(){if(!this.buttons.stop.disabled){this.buttons.start.disabled=false;this.buttons.stop.disabled=true;this.finish=true}};t.prototype.changeMaxTime=function(){var t;if(!!this.content.timeField){t=parseInt(this.content.timeField.value,10);if(!isNaN(t))this.stepOptions.maxExecutionTime=t}};t.prototype.addError=function(t){this.errorCode=this.errorCode||t};return t}();BX.Catalog.Iblocks=function(){var t=function(i){var s;this.iblocks=[];this.iblockIndex=-1;this.report=null;this.iblockContent=[];this.messages={iblockErrorTitle:""};t.superclass.constructor.apply(this,arguments);if(typeof this.visual.reportID==="undefined")this.visual.reportID="";if(BX.type.isPlainObject(i.messages)){for(s in i.messages){this.messages[s]=i.messages[s]}}};BX.extend(t,BX.Catalog.StepOperations);t.prototype.init=function(){if(this.errorCode===0){if(!!this.visual.reportID){this.report=BX(this.visual.reportID);if(!this.report)this.addError(-2097152)}else{this.addError(-1048576)}}t.superclass.init.apply(this,arguments)};t.prototype.checkIblockIndex=function(){return!(this.iblocks.length==0||this.iblockIndex<0||this.iblockIndex>=this.iblocks.length)};t.prototype.startOperation=function(){if(!this.buttons.start.disabled){this.clearOldReports();this.getIblockList()}};t.prototype.clearOldReports=function(){var t;if(this.iblockContent.length>0){for(t=0;t<this.iblockContent.length;t++){if(!!this.iblockContent[t].container){this.iblockContent[t].container=BX.cleanNode(this.iblockContent[t].container,true);this.iblockContent[t].result=null;this.iblockContent[t].errorsFrame=null;this.iblockContent[t].errors=null}}this.iblockContent.length=0}};t.prototype.createReindexReport=function(){var t;if(!this.report)return;if(this.iblockIndex>0)BX.adjust(this.iblockContent[this.iblockIndex-1].container,{style:{display:"none"}});this.iblockContent[this.iblockIndex]={container:null,result:null,errors:null,errorsFrame:null};t=this.iblocks[this.iblockIndex].ID;this.report.appendChild(BX.create("div",{props:{id:this.visual.prefix+t},html:'<div id="'+this.visual.resultContID+t+'" style="margin:0; width: 100%; display: none;"></div>'+'<div id="'+this.visual.errorDivID+t+'" style="margin:0; width: 100%; display: none;">'+'<div class="adm-info-message-wrap adm-info-message-red">'+'<div class="adm-info-message">'+'<div id="'+this.visual.errorContID+t+'"></div>'+'<div class="adm-info-message-icon"></div>'+"</div></div></div>"}))};t.prototype.getIblockList=function(){BX.showWait();BX.ajax.loadJSON(this.url,{sessid:BX.bitrix_sessid(),getIblock:"Y"},BX.proxy(this.getIblockListResult,this))};t.prototype.getIblockListResult=function(t){BX.closeWait();if(BX.type.isArray(t)){this.iblocks=t;if(this.iblocks.length>0){this.changeMaxTime();this.buttons.start.disabled=true;this.buttons.stop.disabled=false;this.iblockIndex=0;this.iblockReindex()}else{this.stopOperation()}}};t.prototype.iblockReindex=function(){if(!this.checkIblockIndex()||this.finish)return;this.createReindexReport();this.initStep();this.nextStep()};t.prototype.initStep=function(){this.currentState.iblockId=this.iblocks[this.iblockIndex].ID;this.currentState.counter=this.iblocks[this.iblockIndex].COUNT;this.currentState.operationCounter=0;this.currentState.errorCounter=0;this.currentState.lastID=0};t.prototype.initResultDom=function(){var t;if(!this.checkIblockIndex())return;if(this.iblockContent[this.iblockIndex].container===null){t=this.iblocks[this.iblockIndex].ID;this.iblockContent[this.iblockIndex].container=BX(this.visual.prefix+t);this.iblockContent[this.iblockIndex].result=BX(this.visual.resultContID+t);this.iblockContent[this.iblockIndex].errors=BX(this.visual.errorContID+t);this.iblockContent[this.iblockIndex].errorsFrame=BX(this.visual.errorDivID+t)}};t.prototype.checkOperation=function(t){if(!!t){this.iblockIndex++;if(this.iblockIndex>=this.iblocks.length||this.currentState.errorCounter>0){this.finishOperation();if(this.currentState.errorCounter==0)this.finalRequest()}else{this.createReindexReport();this.initStep();this.nextStep()}}else{BX.WindowManager.Get().adjustSizeEx();this.nextStep()}};t.prototype.showResult=function(t){if(!this.checkIblockIndex())return;if(!this.iblockContent[this.iblockIndex].container)return;if(!!this.iblockContent[this.iblockIndex].result)BX.adjust(this.iblockContent[this.iblockIndex].result,{html:t,style:{display:"block"}});BX.adjust(this.iblockContent[this.iblockIndex].container,{style:{display:"block"}});BX.adjust(this.report,{style:{display:"block"}})};t.prototype.showErrors=function(t){if(!this.checkIblockIndex())return;if(!this.iblockContent[this.iblockIndex].container)return;if(!!this.iblockContent[this.iblockIndex].errors){if(BX.type.isNotEmptyString(t))this.iblockContent[this.iblockIndex].errors.innerHTML=this.iblockContent[this.iblockIndex].errors.innerHTML+t;BX.style(this.iblockContent[this.iblockIndex].errorsFrame,"display","block")}};t.prototype.finalRequest=function(){var t=[],i;if(this.iblocks.length>0){for(i=0;i<this.iblocks.length;i++)t[t.length]=this.iblocks[i].ID;BX.ajax.get(this.url,{sessid:BX.bitrix_sessid(),finalRequest:"Y",iblockList:t})}};return t}();BX.Catalog.CatalogReindex=function(){var t=function(i){this.catalogSelect=null;t.superclass.constructor.apply(this,arguments);if(typeof this.visual.catalogSelectID==="undefined")this.visual.catalogSelectID=""};BX.extend(t,BX.Catalog.Iblocks);t.prototype.init=function(){if(this.errorCode===0){if(!!this.visual.catalogSelectID){this.catalogSelect=BX(this.visual.catalogSelectID);if(!this.catalogSelect)this.addError(-8388608)}else{this.addError(-4194304)}}t.superclass.init.apply(this,arguments)};t.prototype.getIblockList=function(){if(this.catalogSelect.selectedIndex!=-1&&this.catalogSelect.options[this.catalogSelect.selectedIndex].value!==""){BX.showWait();BX.ajax.loadJSON(this.url,{sessid:BX.bitrix_sessid(),getIblock:"Y",iblock:this.catalogSelect.options[this.catalogSelect.selectedIndex].value},BX.proxy(this.getIblockListResult,this))}};return t}();BX.Catalog.ProductSettings=function(){var t=function(i){this.checkboxList=[];t.superclass.constructor.apply(this,arguments);if(BX.type.isArray(i.checkboxList))this.checkboxList=i.checkboxList;else this.addError(-8)};BX.extend(t,BX.Catalog.Iblocks);t.prototype.init=function(){t.superclass.init.apply(this,arguments)};t.prototype.startOperation=function(){if(!this.buttons.start.disabled){this.clearOldReports();this.changeSettings()}};t.prototype.changeSettings=function(){var t={sessid:BX.bitrix_sessid(),changeSettings:"Y"},i,s;for(i=0;i<this.checkboxList.length;i++){s=BX(this.checkboxList[i]);if(s)t[s.name]=s.checked?"Y":"N";s=null}BX.showWait();BX.ajax.loadJSON(this.url,t,BX.proxy(this.changeSettingsResult,this));t=null};t.prototype.changeSettingsResult=function(t){var i={},s,e;BX.closeWait();if(!BX.type.isPlainObject(t))return;if(BX.type.isNotEmptyString(t.success)&&t.success=="Y"){if(!!top.changeProductSettings){for(s=0;s<this.checkboxList.length;s++){e=BX(this.checkboxList[s]);if(e)i[e.name]=e.checked?this.messages.status_yes:this.messages.status_no;e=null}top.changeProductSettings(i)}this.getIblockList()}else{this.stopOperation()}};t.prototype.getIblockListResult=function(t){BX.closeWait();if(BX.type.isArray(t)){this.iblocks=t;if(this.iblocks.length>0){this.changeMaxTime();this.buttons.start.disabled=true;this.buttons.stop.disabled=false;this.iblockIndex=0;this.iblockReindex()}else{BX.WindowManager.Get().AllowClose();BX.WindowManager.Get().Close()}}};t.prototype.finalRequest=function(){var t=[],i;if(this.iblocks.length>0){for(i=0;i<this.iblocks.length;i++)t[t.length]=this.iblocks[i].ID;BX.ajax.get(this.url,{sessid:BX.bitrix_sessid(),finalRequest:"Y",iblockList:t});BX.WindowManager.Get().AllowClose();BX.WindowManager.Get().Close()}};return t}();
//# sourceMappingURL=step_operations.map.js