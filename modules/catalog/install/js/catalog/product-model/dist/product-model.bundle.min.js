this.BX=this.BX||{};(function(e,t,i,l,r){"use strict";var s=function(){function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"errors",new Map);this.model=t}babelHelpers.createClass(e,[{key:"getErrors",value:function e(){return Object.fromEntries(this.errors)}},{key:"setError",value:function e(t,i){this.errors.set(t,{code:t,text:i});this.model.onErrorCollectionChange();return this}},{key:"removeError",value:function e(t){if(this.errors.has(t)){this.errors.delete(t,text)}this.model.onErrorCollectionChange();return this}},{key:"clearErrors",value:function e(){this.errors.clear();this.model.onErrorCollectionChange();return this}},{key:"hasErrors",value:function e(){return this.errors.size>0}}]);return e}();function a(e,t,i){n(e,t);t.set(e,i)}function n(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var o=new WeakMap;var u=new WeakMap;var c=new WeakMap;var h=function(){function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);a(this,o,{writable:true,value:false});a(this,u,{writable:true,value:""});a(this,c,{writable:true,value:""});this.model=t}babelHelpers.createClass(e,[{key:"isEnableFileSaving",value:function e(){return babelHelpers.classPrivateFieldGet(this,o)}},{key:"enableFileSaving",value:function e(){babelHelpers.classPrivateFieldSet(this,o,true)}},{key:"getMorePhotoValues",value:function e(){return this.morePhoto}},{key:"setMorePhotoValues",value:function e(t){this.morePhoto=l.Type.isPlainObject(t)?t:{}}},{key:"removeMorePhotoItem",value:function e(t){for(var i in this.morePhoto){var r=this.morePhoto[i];if(!l.Type.isObject(r)){r=l.Text.toInteger(r)}if(l.Type.isNumber(r)&&r===l.Text.toInteger(t)||l.Type.isObject(r)&&r.fileId===t){delete this.morePhoto[i];return true}}return false}},{key:"setPreview",value:function e(t){babelHelpers.classPrivateFieldSet(this,u,l.Type.isStringFilled(t)?t:"");return this}},{key:"setEditInput",value:function e(t){babelHelpers.classPrivateFieldSet(this,c,l.Type.isStringFilled(t)?t:"");return this}},{key:"getPreview",value:function e(){return babelHelpers.classPrivateFieldGet(this,u)||""}},{key:"getEditInput",value:function e(){return babelHelpers.classPrivateFieldGet(this,c)||""}},{key:"addMorePhotoItem",value:function e(t,i){this.morePhoto[t]=i}}]);return e}();var d=function(){function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"changedFields",new Map);babelHelpers.defineProperty(this,"fields",new Map);this.model=t}babelHelpers.createClass(e,[{key:"getFields",value:function e(){return Object.fromEntries(this.fields)}},{key:"getField",value:function e(t){return this.fields.get(t)}},{key:"setField",value:function e(t,i){var l=this.fields.get(t);this.fields.set(t,i);if(!this.changedFields.has(t)&&l!==i){this.changedFields.set(t,l)}return this}},{key:"isChanged",value:function e(){return this.changedFields.size>0}},{key:"clearChanged",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;if(l.Type.isNil(i)){this.changedFields.clear()}else{i.forEach(function(e){t.removeFromChanged(e)})}return this}},{key:"removeFromChanged",value:function e(t){this.changedFields.delete(t);return this}},{key:"getChangedFields",value:function e(){var t=this;var i={};this.fields.forEach(function(e,l){if(t.changedFields.has(l)){i[l]=e}});return babelHelpers.objectSpread({},i)}},{key:"getChangedValues",value:function e(){var t={};this.changedFields.forEach(function(e,i){t[i]=e});return babelHelpers.objectSpread({},t)}},{key:"initFields",value:function e(t){var i=this;this.fields.clear();this.clearChanged();if(l.Type.isObject(t)){Object.keys(t).forEach(function(e){i.fields.set(e,t[e])})}return this}}]);return e}();function v(e,t,i){b(e,t);t.set(e,i)}function b(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var f=new WeakMap;var p=function(){function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);v(this,f,{writable:true,value:new Map});this.model=t}babelHelpers.createClass(e,[{key:"init",value:function e(t){var i=this;Object.keys(t).forEach(function(e){var r=t[e];if(r["STORE_ID"]>0){babelHelpers.classPrivateFieldGet(i,f).set(l.Text.toNumber(r["STORE_ID"]),{AMOUNT:l.Text.toNumber(r["AMOUNT"]),QUANTITY_RESERVED:l.Text.toNumber(r["QUANTITY_RESERVED"]),STORE_ID:l.Text.toNumber(r["STORE_ID"]),STORE_TITLE:l.Text.encode(r["STORE_TITLE"])})}})}},{key:"refresh",value:function e(){var t=this;this.clear();if(this.model.getSkuId()>0){l.ajax.runAction("catalog.storeSelector.getProductStores",{json:{productId:this.model.getSkuId()}}).then(function(e){e.data.forEach(function(e){if(!l.Type.isNil(e["STORE_ID"])){babelHelpers.classPrivateFieldGet(t,f).set(l.Text.toNumber(e["STORE_ID"]),{AMOUNT:l.Text.toNumber(e["AMOUNT"]),QUANTITY_RESERVED:l.Text.toNumber(e["QUANTITY_RESERVED"]),STORE_ID:l.Text.toNumber(e["STORE_ID"]),STORE_TITLE:e["STORE_TITLE"]})}});t.model.onChangeStoreData()})}}},{key:"getStoreAmount",value:function e(t){var i;return((i=babelHelpers.classPrivateFieldGet(this,f).get(l.Text.toNumber(t)))===null||i===void 0?void 0:i.AMOUNT)||0}},{key:"getStoreReserved",value:function e(t){var i;return((i=babelHelpers.classPrivateFieldGet(this,f).get(l.Text.toNumber(t)))===null||i===void 0?void 0:i.QUANTITY_RESERVED)||0}},{key:"getStoreAvailableAmount",value:function e(t){return this.getStoreAmount(t)-this.getStoreReserved(t)}},{key:"getMaxFilledStore",value:function e(){var t={STORE_ID:0,AMOUNT:0,STORE_TITLE:"",QUANTITY_RESERVED:0};babelHelpers.classPrivateFieldGet(this,f).forEach(function(e){t=e.AMOUNT>t.AMOUNT?e:t});return t}},{key:"clear",value:function e(){babelHelpers.classPrivateFieldGet(this,f).clear();return this}}]);return e}();var g;function T(e,t){C(e,t);t.add(e)}function E(e,t,i){C(e,t);t.set(e,i)}function C(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function F(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var P=new Map;var y=new WeakMap;var I=new WeakMap;var S=new WeakMap;var k=new WeakMap;var m=new WeakMap;var N=new WeakMap;var H=new WeakMap;var O=new WeakSet;var R=new WeakSet;var A=new WeakSet;var _=function(){babelHelpers.createClass(e,null,[{key:"getById",value:function e(t){return P.get(t)||null}}]);function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);T(this,A);T(this,R);T(this,O);E(this,y,{writable:true,value:null});E(this,I,{writable:true,value:null});E(this,S,{writable:true,value:null});E(this,k,{writable:true,value:null});E(this,m,{writable:true,value:null});E(this,N,{writable:true,value:null});E(this,H,{writable:true,value:null});this.options=t||{};this.id=this.options.id||l.Text.getRandom();babelHelpers.classPrivateFieldSet(this,I,new s(this));babelHelpers.classPrivateFieldSet(this,S,new h(this));babelHelpers.classPrivateFieldSet(this,y,new d(this));babelHelpers.classPrivateFieldSet(this,k,new p(this));if(l.Type.isObject(t.fields)){this.initFields(t.fields,false)}if(l.Type.isNil(t.storeMap)){babelHelpers.classPrivateFieldGet(this,k).refresh()}else{babelHelpers.classPrivateFieldGet(this,k).init(t.storeMap)}if(l.Type.isObject(t.skuTree)){this.setSkuTree(t.skuTree)}if(l.Type.isObject(t.imageInfo));babelHelpers.classPrivateFieldSet(this,m,new i.ProductCalculator(F(this,O,w).call(this),{currencyId:this.options.currency,pricePrecision:this.options.pricePrecision||2,commonPrecision:this.options.pricePrecision||2}));babelHelpers.classPrivateFieldGet(this,m).setCalculationStrategy(new i.TaxForPriceStrategy(babelHelpers.classPrivateFieldGet(this,m)));P.set(this.id,this)}babelHelpers.createClass(e,[{key:"getOption",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;return this.options[t]||i}},{key:"setOption",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;this.options[t]=i;return this}},{key:"setSkuTree",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;babelHelpers.classPrivateFieldSet(this,H,t);return this}},{key:"clearSkuTree",value:function e(){babelHelpers.classPrivateFieldSet(this,H,null);return this}},{key:"getSkuTree",value:function e(){return babelHelpers.classPrivateFieldGet(this,H)}},{key:"getCalculator",value:function e(){return babelHelpers.classPrivateFieldGet(this,m)}},{key:"getErrorCollection",value:function e(){return babelHelpers.classPrivateFieldGet(this,I)}},{key:"getImageCollection",value:function e(){return babelHelpers.classPrivateFieldGet(this,S)}},{key:"getFields",value:function e(){return babelHelpers.classPrivateFieldGet(this,y).getFields()}},{key:"getStoreCollection",value:function e(){return babelHelpers.classPrivateFieldGet(this,k)}},{key:"getField",value:function e(t){return babelHelpers.classPrivateFieldGet(this,y).getField(t)}},{key:"setField",value:function e(t,i){babelHelpers.classPrivateFieldGet(this,y).setField(t,i);if((t==="SKU_ID"||t==="PRODUCT_ID")&&this.getSkuId()!==babelHelpers.classPrivateFieldGet(this,N)){babelHelpers.classPrivateFieldSet(this,N,this.getSkuId());if(babelHelpers.classPrivateFieldGet(this,N)>0){babelHelpers.classPrivateFieldGet(this,k).refresh()}}return this}},{key:"setFields",value:function e(t){var i=this;Object.keys(t).forEach(function(e){i.setField(e,t[e])});return this}},{key:"initFields",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;babelHelpers.classPrivateFieldGet(this,y).initFields(t);babelHelpers.classPrivateFieldSet(this,N,this.getSkuId());if(i){babelHelpers.classPrivateFieldGet(this,k).refresh()}return this}},{key:"removeField",value:function e(t){babelHelpers.classPrivateFieldGet(this,y).removeField(t);return this}},{key:"isChanged",value:function e(){return babelHelpers.classPrivateFieldGet(this,y).isChanged()}},{key:"isNew",value:function e(){return this.getOption("isNew",false)}},{key:"getSkuId",value:function e(){return this.getField("SKU_ID")||this.getProductId()}},{key:"getProductId",value:function e(){return this.getField("PRODUCT_ID")||null}},{key:"isCatalogExisted",value:function e(){return this.getSkuId()>0}},{key:"isEmpty",value:function e(){return this.getProductId()===null&&!this.isSimple()}},{key:"isSimple",value:function e(){return this.getOption("isSimpleModel",null)}},{key:"getIblockId",value:function e(){return this.getOption("iblockId",0)}},{key:"getBasePriceId",value:function e(){return this.getOption("basePriceId",0)}},{key:"getCurrency",value:function e(){return this.getOption("currency",null)}},{key:"getDetailPath",value:function e(){return this.getOption("detailPath","")}},{key:"setDetailPath",value:function e(t){this.options["detailPath"]=t||""}},{key:"showSaveNotifier",value:function t(i,r){if(!this.isCatalogExisted()){return}var s=r.title||"";var a=BX.UI.Notification.Event.getFullName("onClose");var n=BX.UI.Notification.Event.getFullName("onCancel");new Promise(function(t){var l=BX.UI.Notification.Center.getBalloonByCategory(e.SAVE_NOTIFICATION_CATEGORY);if(l&&l.getId()!==i){setTimeout(function(){l.close();setTimeout(t,400)},200)}else{t()}}).then(function(){var t=BX.UI.Notification.Center.getBalloonById(i);if(!t){var o={id:i,closeButton:true,category:e.SAVE_NOTIFICATION_CATEGORY,autoHideDelay:4e3,content:l.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(["<div>","</div>"])),s)};if(r.disableCancel!==true){o.actions=[{title:r.declineCancelTitle||l.Loc.getMessage("CATALOG_PRODUCT_MODEL_SAVING_NOTIFICATION_DECLINE_SAVE"),events:{click:function e(i,l){BX.removeAllCustomEvents(t,a);l.fireEvent("onCancel");l.close()}}}]}t=BX.UI.Notification.Center.notify(o)}BX.removeAllCustomEvents(t,a);t.addEvent("onClose",function(){var e;if(l.Type.isFunction(r===null||r===void 0?void 0:(e=r.events)===null||e===void 0?void 0:e.onSave)){r.events.onSave()}});BX.removeAllCustomEvents(t,n);t.addEvent("onCancel",function(){var e;if(l.Type.isFunction(r===null||r===void 0?void 0:(e=r.events)===null||e===void 0?void 0:e.onCancel)){r.events.onCancel()}});t.show()})}},{key:"save",value:function e(t){var i=this;if(!this.isSaveable()){return}return new Promise(function(e,l){var r;if(i.isSimple()){r=F(i,A,D).call(i)}else{r=F(i,R,G).call(i,t)}r.then(function(l){babelHelpers.classPrivateFieldGet(i,y).clearChanged(t);e(l)}).catch(l)})}},{key:"isSaveable",value:function e(){return this.getOption("isSaveable",true)&&!this.isEmpty()}},{key:"onErrorCollectionChange",value:function e(){t.EventEmitter.emit(this,"onErrorsChange")}},{key:"onChangeStoreData",value:function e(){t.EventEmitter.emit(this,"onChangeStoreData")}}],[{key:"getLastActiveSaveNotification",value:function t(){return BX.UI.Notification.Center.getBalloonByCategory(e.SAVE_NOTIFICATION_CATEGORY)}}]);return e}();function w(){var e=l.Text.toNumber(babelHelpers.classPrivateFieldGet(this,y).getField("PRICE"));var t=l.Type.isNumber(babelHelpers.classPrivateFieldGet(this,y).getField("BASE_PRICE"))?l.Text.toNumber(babelHelpers.classPrivateFieldGet(this,y).getField("BASE_PRICE")):e;return{QUANTITY:l.Text.toNumber(babelHelpers.classPrivateFieldGet(this,y).getField("QUANTITY")),BASE_PRICE:t,PRICE:e,PRICE_NETTO:t,PRICE_BRUTTO:e,PRICE_EXCLUSIVE:babelHelpers.classPrivateFieldGet(this,y).getField("PRICE_EXCLUSIVE")||e,DISCOUNT_TYPE_ID:babelHelpers.classPrivateFieldGet(this,y).getField("DISCOUNT_TYPE_ID")||i.DiscountType.PERCENTAGE,DISCOUNT_RATE:l.Text.toNumber(babelHelpers.classPrivateFieldGet(this,y).getField("DISCOUNT_RATE")),DISCOUNT_SUM:l.Text.toNumber(babelHelpers.classPrivateFieldGet(this,y).getField("DISCOUNT_SUM")),TAX_INCLUDED:babelHelpers.classPrivateFieldGet(this,y).getField("TAX_INCLUDED")||"N",TAX_RATE:l.Text.toNumber(babelHelpers.classPrivateFieldGet(this,y).getField("TAX_RATE"))||0,CUSTOMIZED:babelHelpers.classPrivateFieldGet(this,y).getField("CUSTOMIZED")||"N"}}function G(e){var t=this;if(this.getIblockId()<=0||!babelHelpers.classPrivateFieldGet(this,y).isChanged()){return}var i={};if(!l.Type.isArray(e)||e.length===0){i=babelHelpers.classPrivateFieldGet(this,y).getChangedFields()}else{var r=babelHelpers.classPrivateFieldGet(this,y).getChangedFields();Object.keys(r).forEach(function(l){if(e.includes(l)){if(l==="PRICE"||l==="BASE_PRICE"){i["PRICES"]=i["PRICES"]||{};i["PRICES"][t.getBasePriceId()]={PRICE:r[l],CURRENCY:t.getCurrency()}}else{i[l]=r[l]}}})}return l.ajax.runAction("catalog.productSelector.updateSku",{json:{id:this.getSkuId(),updateFields:i,oldFields:babelHelpers.classPrivateFieldGet(this,y).getChangedValues()}})}function D(){var e={NAME:babelHelpers.classPrivateFieldGet(this,y).getField("NAME",""),IBLOCK_ID:this.getIblockId()};var t=babelHelpers.classPrivateFieldGet(this,y).getField("BASE_PRICE",null);if(!l.Type.isNil(t)){e["PRICE"]=t}var i=babelHelpers.classPrivateFieldGet(this,y).getField("BARCODE",null);if(!l.Type.isNil(i)){e["BARCODE"]=i}e["CURRENCY"]=this.getCurrency();var r=babelHelpers.classPrivateFieldGet(this,y).getField("CURRENCY",null);if(l.Type.isStringFilled(r)){e["CURRENCY"]=r}return l.ajax.runAction("catalog.productSelector.createProduct",{json:{fields:e}})}babelHelpers.defineProperty(_,"SAVE_NOTIFICATION_CATEGORY","MODEL_SAVE");e.ProductModel=_})(this.BX.Catalog=this.BX.Catalog||{},BX.Event,BX.Catalog,BX,BX.Catalog);
//# sourceMappingURL=product-model.bundle.map.js