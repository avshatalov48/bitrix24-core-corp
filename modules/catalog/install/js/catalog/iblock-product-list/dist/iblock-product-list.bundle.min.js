this.BX=this.BX||{};(function(e,t,i){"use strict";function a(e,t){var i;if(typeof Symbol==="undefined"||e[Symbol.iterator]==null){if(Array.isArray(e)||(i=r(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var a=0;var n=function e(){};return{s:n,n:function t(){if(a>=e.length)return{done:true};return{done:false,value:e[a++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o=true,s=false,d;return{s:function t(){i=e[Symbol.iterator]()},n:function e(){var t=i.next();o=t.done;return t},e:function e(t){s=true;d=t},f:function e(){try{if(!o&&i.return!=null)i.return()}finally{if(s)throw d}}}}function r(e,t){if(!e)return;if(typeof e==="string")return n(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return n(e,t)}function n(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,a=new Array(t);i<t;i++){a[i]=e[i]}return a}var o=function(){function e(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"variations",new Map);babelHelpers.defineProperty(this,"variationsEditData",new Map);babelHelpers.defineProperty(this,"editedVariations",new Map);babelHelpers.defineProperty(this,"morePhotoChangedInputs",new Map);babelHelpers.defineProperty(this,"onSettingsWindowSaveHandler",this.handleOnSettingsWindowSave.bind(this));babelHelpers.defineProperty(this,"onChangeVariationHandler",this.handleOnChangeVariation.bind(this));babelHelpers.defineProperty(this,"onBeforeGridRequestHandler",this.handleOnBeforeGridRequest.bind(this));babelHelpers.defineProperty(this,"onFilterApplyHandler",this.handleOnFilterApply.bind(this));babelHelpers.defineProperty(this,"onSaveImageHandler",this.handleOnSaveImage.bind(this));this.gridId=i.gridId;this.rowIdMask=i.rowIdMask||"#ID#";this.variationFieldNames=i.variationFieldNames||[];this.productVariationMap=i.productVariationMap||{};this.createNewProductHref=i.createNewProductHref||"";this.showCatalogWithOffers=i.showCatalogWithOffers||false;this.addCustomClassToGrid();this.cacheSelectedVariation();t.EventEmitter.subscribe("BX.Grid.SettingsWindow:save",this.onSettingsWindowSaveHandler);t.EventEmitter.subscribe("SkuProperty::onChange",this.onChangeVariationHandler);t.EventEmitter.subscribe("Grid::beforeRequest",this.onBeforeGridRequestHandler);t.EventEmitter.subscribe("BX.Main.Filter:apply",this.onFilterApplyHandler);t.EventEmitter.subscribe("Catalog.ImageInput::save",this.onSaveImageHandler)}babelHelpers.createClass(e,[{key:"addCustomClassToGrid",value:function e(){i.Dom.addClass(this.getGrid().getContainer(),"catalog-product-grid")}},{key:"cacheSelectedVariation",value:function e(){var t=this;this.getGrid().getRows().getBodyChild().forEach(function(e){var i=e.getId();var a=t.getProductIdByRowId(i);var r=t.getCurrentVariationIdByProduct(a);if(r){t.variations.set(r,e.getNode().cloneNode(true));t.variationsEditData.set(r,e.getEditData())}})}},{key:"clearAllVariationCache",value:function e(){this.variations.clear();this.variationsEditData.clear();this.editedVariations.clear();this.morePhotoChangedInputs.clear()}},{key:"clearVariationCache",value:function e(t){this.variations.delete(t);this.variationsEditData.delete(t);this.editedVariations.delete(t)}},{key:"getGrid",value:function e(){if(!this.grid){this.grid=BX.Main.gridManager.getInstanceById(this.gridId)}return this.grid}},{key:"handleOnSettingsWindowSave",value:function e(t){var i=t.getCompatData(),a=babelHelpers.slicedToArray(i,1),r=a[0];var n=r.getSelectedColumns();this.showCatalogWithOffers=n.indexOf("CATALOG_PRODUCT")!==-1}},{key:"handleOnChangeVariation",value:function e(t){var a=this;var r=t.getData(),n=babelHelpers.slicedToArray(r,1),o=n[0];var s=i.Text.toNumber(o.PARENT_PRODUCT_ID);var d=i.Text.toNumber(o.ID);if(s<=0||d<=0){return}var l=this.getProductRow(s);if(l.isEdit()){var u=this.getEditedVariationValues(l);var h=this.getCurrentVariationIdByProduct(s);this.editedVariations.set(h,u)}if(l.isEdit()&&this.editedVariations.has(d)){var c=Object.assign(l.getEditData(),this.editedVariations.get(d));l.setEditData(c);l.editCancel();l.edit();this.productVariationMap[s]=d;return}this.getVariation(s,d).then(function(e){a.updateProductRow(s,d,e);a.productVariationMap[s]=d})}},{key:"getEditedVariationValues",value:function e(t){var a=this;var r=t.getEditorValue();var n=this.getHeadRow();var o={};var s=null;babelHelpers.toConsumableArray(t.getCells()).forEach(function(e,i){var r=n.getCellNameByCellIndex(i);if(r!=="MORE_PHOTO"){return}var o=t.getEditorContainer(e);if(o){var d=o.querySelector(".catalog-image-input-wrapper");var l=d.id;if(a.morePhotoChangedInputs.has(l)){s=a.morePhotoChangedInputs.get(l)}else{s=d.outerHTML}}});for(var d in r){if(!r.hasOwnProperty(d)||!this.variationFieldNames.includes(d)){continue}if(d==="MORE_PHOTO"&&!i.Type.isNil(s)){o[d]=s}else{o[d]=r[d]}}return o}},{key:"getVariation",value:function e(t,a){var r=this;if(this.getProductRow(t).isEdit()&&this.editedVariations.has(a)){return Promise.resolve(this.editedVariations.get(a))}if(this.variations.has(a)){return Promise.resolve(this.variations.get(a))}return new Promise(function(e){r.loadVariation(t,a,e)}).then(function(e){if(i.Type.isDomNode(e)){r.variations.set(a,e);return e}return null})}},{key:"loadVariation",value:function e(t,i,a){var r=this;var n="";var o="POST";var s={productId:t,variationId:i};this.getProductRow(t).stateLoad();this.getGrid().getData().request(n,o,s,"changeVariation",function(){var e=r.getProductRow(t);if(e){e.stateUnload();a(this.getRowById(e.getId()))}})}},{key:"getProductIdByRowId",value:function e(t){var a=new RegExp(this.rowIdMask.replace("#ID#","([0-9]+)"));var r=t.match(a);return i.Type.isArray(r)?i.Text.toNumber(r[1]):0}},{key:"getRowIdByProductId",value:function e(t){return this.rowIdMask.replace("#ID#",t)}},{key:"getProductRow",value:function e(t){var i=this.getRowIdByProductId(t);return this.getGrid().getRows().getById(i)}},{key:"getHeadRow",value:function e(){return this.getGrid().getRows().getHeadFirstChild()}},{key:"updateProductRow",value:function e(t,a,r){var n=this;if(!t||!i.Type.isDomNode(r)){return}var o=this.getHeadRow();var s=this.getProductRow(t);babelHelpers.toConsumableArray(r.cells).forEach(function(e,t){var i=o.getCellNameByCellIndex(t);if(n.variationFieldNames.includes(i)){var a=s.getCellByIndex(t);if(a){var r=s.getContentContainer(e).innerHTML;s.getContentContainer(a).innerHTML=r}}});if(this.variationsEditData.has(a)){s.setEditData(this.variationsEditData.get(a))}else{s.resetEditData();this.variationsEditData.set(a,s.getEditData())}if(s.isEdit()){s.editCancel();s.edit()}}},{key:"handleOnBeforeGridRequest",value:function e(t){var r=this;var n=t.getData(),o=babelHelpers.slicedToArray(n,2),s=o[1];var d=BX.prop.get(s,"data",{});if(!d.productId&&!d.FIELDS){this.clearAllVariationCache()}if(d.FIELDS){this.editedVariations.forEach(function(e,t){var a=r.getRowIdByProductId(t);d.FIELDS[a]=d.FIELDS[a]||{};Object.keys(e).map(function(r){if(r.indexOf("CATALOG_GROUP_")>=0){var n=r.replace("CATALOG_GROUP_","");if(!i.Type.isNil(e[r]["PRICE"])){d["CATALOG_PRICE"]=d["CATALOG_PRICE"]||{};d["CATALOG_PRICE"][t]=d["CATALOG_PRICE"][t]||{};d["CATALOG_PRICE"][t][n]=e[r]["PRICE"]["VALUE"]}if(!i.Type.isNil(e[r]["CURRENCY"])){d["CATALOG_CURRENCY"]=d["CATALOG_CURRENCY"]||{};d["CATALOG_CURRENCY"][t]=d["CATALOG_CURRENCY"][t]||{};d["CATALOG_CURRENCY"][t][n]=e[r]["CURRENCY"]["VALUE"]}}else if(r!=="MORE_PHOTO"&&r!=="MORE_PHOTO_custom"){d.FIELDS[a][r]=e[r]}});r.clearVariationCache(t)});for(var l in d.FIELDS){if(!d.FIELDS.hasOwnProperty(l)){continue}var u=this.getProductIdByRowId(l);var h=this.getCurrentVariationIdByProduct(u);var c=new RegExp(/([0-9A-Za-z_]+?(_n\d+)*)\[([A-Za-z_]+)\]/);var f=d.FIELDS[l];var v={};if(!i.Type.isNil(f["MORE_PHOTO_custom"])){for(var g in f["MORE_PHOTO_custom"]){if(!f["MORE_PHOTO_custom"].hasOwnProperty(g)){continue}var p=f["MORE_PHOTO_custom"][g];if(c.test(p.name)){var y=void 0,C=void 0;var I=p.name.match(c);var E=babelHelpers.slicedToArray(I,4);y=E[1];C=E[3];if(y&&C){v[y]=v[y]||{};v[y][C]=p.value}}else{v[p.name]=p.value}}}f["MORE_PHOTO"]=v;if(h&&this.showCatalogWithOffers){var b=this.getRowIdByProductId(h);this.clearVariationCache(h);d.FIELDS[b]={};var P=a(this.variationFieldNames),O;try{for(P.s();!(O=P.n()).done;){var m=O.value;if(!f.hasOwnProperty(m)){continue}d.FIELDS[b][m]=f[m];delete d.FIELDS[l][m]}}catch(e){P.e(e)}finally{P.f()}}}this.morePhotoChangedInputs.clear()}}},{key:"getCurrentVariationIdByProduct",value:function e(t){return t in this.productVariationMap?i.Text.toNumber(this.productVariationMap[t]):null}},{key:"handleOnFilterApply",value:function e(t){var a=t.getData();var r=a[0];var n=a[2]instanceof BX.Main.Filter?t.getData()[2]:null;if(n&&r===this.gridId){var o=this.getFilterFields(n);var s="0";if(i.Type.isArray(o)){var d=this.getFieldSectionId(o);if(d){var l=d["VALUE"];if(i.Type.isObject(l)){s=l["VALUE"]}}}this.setNewProductButtonHrefSectionId(s)}}},{key:"handleOnSaveImage",value:function e(t){var i=t.getData(),a=babelHelpers.slicedToArray(i,3),r=a[0],n=a[1],o=a[2];this.morePhotoChangedInputs.set(r,o.data.input)}},{key:"getFilterFields",value:function e(t){var a=t.getParam("PRESETS");var r=null;if(i.Type.isArray(a)){r=a.find(function(e){return e["ID"]==="tmp_filter"})}if(r){return r["FIELDS"]||null}return null}},{key:"getFieldSectionId",value:function e(t){return t.find(function(e){return e["ID"]==="field_SECTION_ID"})}},{key:"setNewProductButtonHrefSectionId",value:function e(t){var a=new i.Uri(this.createNewProductHref);a.setQueryParams({IBLOCK_SECTION_ID:t});var r=document.getElementById("create_new_product_button_"+this.gridId);if(i.Type.isDomNode(r)){r.href=a.getPath()+a.getQuery()}}}]);return e}();e.IblockProductList=o})(this.BX.Catalog=this.BX.Catalog||{},BX.Event,BX);
//# sourceMappingURL=iblock-product-list.bundle.map.js