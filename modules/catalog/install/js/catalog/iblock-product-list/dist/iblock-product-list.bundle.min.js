this.BX=this.BX||{};(function(t,e,r){"use strict";function i(t,e){var r;if(typeof Symbol==="undefined"||t[Symbol.iterator]==null){if(Array.isArray(t)||(r=a(t))||e&&t&&typeof t.length==="number"){if(r)t=r;var i=0;var n=function t(){};return{s:n,n:function e(){if(i>=t.length)return{done:true};return{done:false,value:t[i++]}},e:function t(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o=true,s=false,d;return{s:function e(){r=t[Symbol.iterator]()},n:function t(){var e=r.next();o=e.done;return e},e:function t(e){s=true;d=e},f:function t(){try{if(!o&&r.return!=null)r.return()}finally{if(s)throw d}}}}function a(t,e){if(!t)return;if(typeof t==="string")return n(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);if(r==="Object"&&t.constructor)r=t.constructor.name;if(r==="Map"||r==="Set")return Array.from(t);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return n(t,e)}function n(t,e){if(e==null||e>t.length)e=t.length;for(var r=0,i=new Array(e);r<e;r++){i[r]=t[r]}return i}function o(){var t=babelHelpers.taggedTemplateLiteral(["",""]);o=function e(){return t};return t}var s=function(){function t(){var r=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,t);babelHelpers.defineProperty(this,"variations",new Map);babelHelpers.defineProperty(this,"variationsEditData",new Map);babelHelpers.defineProperty(this,"onSettingsWindowSaveHandler",this.handleOnSettingsWindowSave.bind(this));babelHelpers.defineProperty(this,"onChangeVariationHandler",this.handleOnChangeVariation.bind(this));babelHelpers.defineProperty(this,"onBeforeGridRequestHandler",this.handleOnBeforeGridRequest.bind(this));babelHelpers.defineProperty(this,"onFilterApplyHandler",this.handleOnFilterApply.bind(this));this.gridId=r.gridId;this.rowIdMask=r.rowIdMask||"#ID#";this.variationFieldNames=r.variationFieldNames||[];this.productVariationMap=r.productVariationMap||{};this.createNewProductHref=r.createNewProductHref||"";this.showCatalogWithOffers=r.showCatalogWithOffers||false;this.addCustomClassToGrid();this.cacheSelectedVariation();e.EventEmitter.subscribe("BX.Grid.SettingsWindow:save",this.onSettingsWindowSaveHandler);e.EventEmitter.subscribe("SkuProperty::onChange",this.onChangeVariationHandler);e.EventEmitter.subscribe("Grid::beforeRequest",this.onBeforeGridRequestHandler);e.EventEmitter.subscribe("BX.Main.Filter:apply",this.onFilterApplyHandler)}babelHelpers.createClass(t,[{key:"addCustomClassToGrid",value:function t(){r.Dom.addClass(this.getGrid().getContainer(),"catalog-product-grid")}},{key:"cacheSelectedVariation",value:function t(){var e=this;this.getGrid().getRows().getBodyChild().forEach(function(t){var r=t.getId();var i=e.getProductIdByRowId(r);var a=e.getCurrentVariationIdByProduct(i);if(a){e.variations.set(a,t.getNode().cloneNode(true));e.variationsEditData.set(a,t.getEditData())}})}},{key:"clearAllVariationCache",value:function t(){this.variations.clear();this.variationsEditData.clear()}},{key:"clearVariationCache",value:function t(e){this.variations.delete(e);this.variationsEditData.delete(e)}},{key:"getGrid",value:function t(){if(!this.grid){this.grid=BX.Main.gridManager.getInstanceById(this.gridId)}return this.grid}},{key:"handleOnSettingsWindowSave",value:function t(e){var r=e.getCompatData(),i=babelHelpers.slicedToArray(r,1),a=i[0];var n=a.getSelectedColumns();this.showCatalogWithOffers=n.indexOf("CATALOG_PRODUCT")!==-1}},{key:"handleOnChangeVariation",value:function t(e){var i=this;var a=e.getData(),n=babelHelpers.slicedToArray(a,1),o=n[0];var s=r.Text.toNumber(o.PARENT_PRODUCT_ID);var d=r.Text.toNumber(o.ID);if(s<=0||d<=0){return}this.getVariation(s,d).then(function(t){i.updateProductRow(s,d,t);i.productVariationMap[s]=d})}},{key:"getVariation",value:function t(e,i){var a=this;if(this.variations.has(i)){return Promise.resolve(this.variations.get(i))}return new Promise(function(t){a.loadVariation(e,i,t)}).then(function(t){if(r.Type.isDomNode(t)){a.variations.set(i,t);return t}return null})}},{key:"loadVariation",value:function t(e,r,i){var a=this;var n="";var o="POST";var s={productId:e,variationId:r};this.getProductRow(e).stateLoad();this.getGrid().getData().request(n,o,s,"changeVariation",function(){var t=a.getProductRow(e);if(t){t.stateUnload();i(this.getRowById(t.getId()))}})}},{key:"getProductIdByRowId",value:function t(e){var i=new RegExp(this.rowIdMask.replace("#ID#","([0-9]+)"));var a=e.match(i);return r.Type.isArray(a)?r.Text.toNumber(a[1]):0}},{key:"getRowIdByProductId",value:function t(e){return this.rowIdMask.replace("#ID#",e)}},{key:"getProductRow",value:function t(e){var r=this.getRowIdByProductId(e);return this.getGrid().getRows().getById(r)}},{key:"getHeadRow",value:function t(){return this.getGrid().getRows().getHeadFirstChild()}},{key:"updateProductRow",value:function t(e,i,a){var n=this;if(!e||!r.Type.isDomNode(a)){return}var s=this.getHeadRow();var d=this.getProductRow(e);babelHelpers.toConsumableArray(a.cells).forEach(function(t,e){var i=s.getCellNameByCellIndex(e);if(n.variationFieldNames.includes(i)){var a=d.getCellByIndex(e);if(a){var l=r.Tag.render(o(),t.innerHTML);var u=d.getContentContainer(l).innerHTML;d.getContentContainer(a).innerHTML=u}}});if(this.variationsEditData.has(i)){d.setEditData(this.variationsEditData.get(i))}else{d.resetEditData();this.variationsEditData.set(i,d.getEditData())}if(d.isEdit()){d.editCancel();d.edit()}}},{key:"handleOnBeforeGridRequest",value:function t(e){var r=e.getData(),a=babelHelpers.slicedToArray(r,2),n=a[1];var o=BX.prop.get(n,"data",{});if(!o.productId&&!o.FIELDS){this.clearAllVariationCache()}if(o.FIELDS){for(var s in o.FIELDS){if(!o.FIELDS.hasOwnProperty(s)){continue}var d=this.getProductIdByRowId(s);var l=this.getCurrentVariationIdByProduct(d);if(l&&this.showCatalogWithOffers){var u=this.getRowIdByProductId(l);this.clearVariationCache(l);o.FIELDS[u]={};var c=i(this.variationFieldNames),h;try{for(c.s();!(h=c.n()).done;){var f=h.value;if(!o.FIELDS[s].hasOwnProperty(f)){continue}o.FIELDS[u][f]=o.FIELDS[s][f];delete o.FIELDS[s][f]}}catch(t){c.e(t)}finally{c.f()}}}}}},{key:"getCurrentVariationIdByProduct",value:function t(e){return e in this.productVariationMap?r.Text.toNumber(this.productVariationMap[e]):null}},{key:"handleOnFilterApply",value:function t(e){var i=e.getData();var a=i[0];var n=i[2]instanceof BX.Main.Filter?e.getData()[2]:null;if(n&&a===this.gridId){var o=this.getFilterFields(n);var s="0";if(r.Type.isArray(o)){var d=this.getFieldSectionId(o);if(d){var l=d["VALUE"];if(r.Type.isObject(l)){s=l["VALUE"]}}}this.setNewProductButtonHrefSectionId(s)}}},{key:"getFilterFields",value:function t(e){var i=e.getParam("PRESETS");var a=null;if(r.Type.isArray(i)){a=i.find(function(t){return t["ID"]==="tmp_filter"})}if(a){return a["FIELDS"]||null}return null}},{key:"getFieldSectionId",value:function t(e){return e.find(function(t){return t["ID"]==="field_SECTION_ID"})}},{key:"setNewProductButtonHrefSectionId",value:function t(e){var i=new r.Uri(this.createNewProductHref);i.setQueryParams({IBLOCK_SECTION_ID:e});var a=document.getElementById("create_new_product_button_"+this.gridId);if(r.Type.isDomNode(a)){a.href=i.getPath()+i.getQuery()}}}]);return t}();t.IblockProductList=s})(this.BX.Catalog=this.BX.Catalog||{},BX.Event,BX);
//# sourceMappingURL=iblock-product-list.bundle.map.js