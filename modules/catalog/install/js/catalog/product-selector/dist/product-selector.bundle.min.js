this.BX=this.BX||{};(function(e,t,i,n,a,r){"use strict";var l=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"TYPE","");this.id=t||r.Text.getRandom();this.config=i||{};this.setMorePhotoValues(i.morePhoto);this.setFields(i.fields)}babelHelpers.createClass(e,[{key:"getId",value:function e(){return this.id}},{key:"getProductId",value:function e(){return this.id}},{key:"isSaveable",value:function e(){return false}},{key:"setSaveable",value:function e(t){this.config.saveProductFields=t}},{key:"isNew",value:function e(){return this.getConfig("isNew",false)}},{key:"getConfig",value:function e(t,i){return BX.prop.get(this.config,t,i)}},{key:"getType",value:function e(){return this.TYPE}},{key:"getFields",value:function e(){return this.fields}},{key:"getField",value:function e(t){return BX.prop.get(this.fields,t,"")}},{key:"setFields",value:function e(t){this.fields=r.Type.isObject(t)?t:{}}},{key:"isEnableFileSaving",value:function e(){return false}},{key:"getMorePhotoValues",value:function e(){return this.morePhoto}},{key:"setMorePhotoValues",value:function e(t){this.morePhoto=r.Type.isPlainObject(t)?t:{}}},{key:"removeMorePhotoItem",value:function e(t){return false}},{key:"addMorePhotoItem",value:function e(t,i){this.morePhoto[t]=i}},{key:"getFileType",value:function e(){return this.getType()}},{key:"setFileType",value:function e(t){this.config.fileType=t||""}},{key:"getDetailPath",value:function e(){return""}},{key:"setDetailPath",value:function e(t){this.config.DETAIL_PATH=t||""}}]);return e}();function s(){var e=babelHelpers.taggedTemplateLiteral(["",""]);s=function t(){return e};return e}function o(){var e=babelHelpers.taggedTemplateLiteral(["",""]);o=function t(){return e};return e}function u(){var e=babelHelpers.taggedTemplateLiteral(['<div class="ui-ctl ui-ctl-w100 ui-ctl-after-icon"></div>']);u=function t(){return e};return e}function c(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<button\n\t\t\t\t\tclass="ui-ctl-after ui-ctl-icon-search"\n\t\t\t\t\tonclick="','"\n\t\t\t\t></button>\n\t\t\t']);c=function t(){return e};return e}function d(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<a\n\t\t\t\t\thref="','"\n\t\t\t\t\ttarget="_blank"\n\t\t\t\t\tclass="ui-ctl-after ui-ctl-icon-forward"\n\t\t\t\t></button>\n\t\t\t']);d=function t(){return e};return e}function h(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<button\n\t\t\t\t\tclass="ui-ctl-after ui-ctl-icon-clear" \n\t\t\t\t\tonclick="','"\n\t\t\t\t></button>\n\t\t\t']);h=function t(){return e};return e}function g(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input\n\t\t\t\t \ttype="hidden" \n\t\t\t\t\tname="','" \n\t\t\t\t\tvalue="','"\n\t\t\t\t>\n\t\t\t']);g=function t(){return e};return e}function p(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input type="text" \n\t\t\t\t\tclass="ui-ctl-element ui-ctl-textbox" \n\t\t\t\t\tautocomplete="off"\n\t\t\t\t\tvalue="','"\n\t\t\t\t\tplaceholder="','"\n\t\t\t\t\tonchange="','"\n\t\t\t\t>\n\t\t\t']);p=function t(){return e};return e}function f(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-ctl-tag">',"</div>\n\t\t"]);f=function t(){return e};return e}function v(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-ctl ui-ctl-textbox ui-ctl-w100">\n\t\t\t\t',"\n\t\t\t\t","\n\t\t\t\t","\n\t\t\t</div>\n\t\t"]);v=function t(){return e};return e}var I=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"cache",new r.Cache.MemoryCache);this.id=t||r.Text.getRandom();this.selector=i.selector;if(!(this.selector instanceof a.ProductSelector)){throw new Error("Product selector instance not found.")}this.model=i.model||{};this.isEnabledSearch=i.isSearchEnabled||false;this.isEnabledDetailLink=i.isEnabledDetailLink;this.inputName=i.inputName||""}babelHelpers.createClass(e,[{key:"getId",value:function e(){return this.id}},{key:"getField",value:function e(t){return this.model.getField(t)}},{key:"getValue",value:function e(){return this.getField(this.inputName)}},{key:"isSearchEnabled",value:function e(){return this.isEnabledSearch}},{key:"isEmptyModel",value:function e(){return this.model.getType()==="empty"}},{key:"toggleIcon",value:function e(t,i){if(r.Type.isDomNode(t)){r.Dom.style(t,"display",i)}}},{key:"getNameBlock",value:function e(){return r.Tag.render(v(),this.getNameTag(),this.getNameInput(),this.getHiddenNameInput())}},{key:"getNameTag",value:function e(){if(!this.model.isNew()){return""}return r.Tag.render(f(),r.Loc.getMessage("CATALOG_SELECTOR_NEW_TAG_TITLE"))}},{key:"getNameInput",value:function e(){var t=this;return this.cache.remember("nameInput",function(){return r.Tag.render(p(),r.Text.encode(t.getValue()),r.Text.encode(t.getPlaceholder()),t.handleNameInputHiddenChange.bind(t))})}},{key:"getHiddenNameInput",value:function e(){var t=this;return this.cache.remember("hiddenNameInput",function(){return r.Tag.render(g(),r.Text.encode(t.inputName),r.Text.encode(t.getValue()))})}},{key:"handleNameInputHiddenChange",value:function e(t){this.getHiddenNameInput().value=t.target.value}},{key:"getClearIcon",value:function e(){var t=this;return this.cache.remember("closeIcon",function(){return r.Tag.render(h(),t.handleClearIconClick.bind(t))})}},{key:"getArrowIcon",value:function e(){var t=this;return this.cache.remember("arrowIcon",function(){return r.Tag.render(d(),t.model.getDetailPath())})}},{key:"getSearchIcon",value:function e(){var t=this;return this.cache.remember("searchIcon",function(){return r.Tag.render(c(),t.handleSearchIconClick.bind(t))})}},{key:"layout",value:function e(){var t=r.Tag.render(u());if(!r.Type.isStringFilled(this.getValue())){this.toggleIcon(this.getClearIcon(),"none")}t.appendChild(this.getClearIcon());if(this.showDetailLink()&&r.Type.isStringFilled(this.getValue())){this.toggleIcon(this.getClearIcon(),"none");this.toggleIcon(this.getArrowIcon(),"block");t.appendChild(this.getArrowIcon())}if(this.isSearchEnabled()){var i=r.Type.isStringFilled(this.getValue())?"none":"block";this.toggleIcon(this.getSearchIcon(),i);t.appendChild(this.getSearchIcon());r.Event.bind(this.getNameInput(),"click",this.handleShowSearchDialog.bind(this));r.Event.bind(this.getNameInput(),"input",this.handleShowSearchDialog.bind(this));r.Event.bind(this.getNameInput(),"blur",this.handleNameInputBlur.bind(this));r.Event.bind(this.getNameInput(),"keydown",this.handleNameInputKeyDown.bind(this))}r.Event.bind(this.getNameInput(),"click",this.handleIconsSwitchingOnNameInput.bind(this));r.Event.bind(this.getNameInput(),"input",this.handleIconsSwitchingOnNameInput.bind(this));if(this.selector&&this.selector.isSaveable()){r.Event.bind(this.getNameInput(),"change",this.handleNameInputChange.bind(this))}t.appendChild(this.getNameBlock());return t}},{key:"showDetailLink",value:function e(){return this.isEnabledDetailLink}},{key:"getDialog",value:function e(){var t=this;return this.cache.remember("dialog",function(){return new i.Dialog({id:t.id,height:300,context:"catalog-products",targetNode:t.getNameInput(),enableSearch:false,multiple:false,dropdownMode:true,searchTabOptions:{stub:true,stubOptions:{title:r.Tag.message(o(),"CATALOG_SELECTOR_IS_EMPTY_TITLE"),subtitle:r.Tag.message(s(),"CATALOG_SELECTOR_IS_EMPTY_SUBTITLE"),arrow:true}},searchOptions:{allowCreateItem:true},events:{"Item:onSelect":t.onProductSelect.bind(t),"Search:onItemCreateAsync":t.createProduct.bind(t)},entities:[{id:"product",options:{iblockId:t.selector.getIblockId(),basePriceId:t.selector.getBasePriceId()}}]})})}},{key:"handleNameInputKeyDown",value:function e(t){var i=this.getDialog();if(t.key==="Enter"&&i.getActiveTab()===i.getSearchTab()){t.preventDefault();if(r.Browser.isMac()&&t.metaKey||t.ctrlKey){i.getSearchTab().getFooter().createItem()}}}},{key:"handleIconsSwitchingOnNameInput",value:function e(t){this.toggleIcon(this.getArrowIcon(),"none");if(r.Type.isStringFilled(t.target.value)){this.toggleIcon(this.getClearIcon(),"block");this.toggleIcon(this.getSearchIcon(),"none")}else{this.toggleIcon(this.getClearIcon(),"none");this.toggleIcon(this.getSearchIcon(),"block")}}},{key:"handleClearIconClick",value:function e(t){if(this.selector.isProductSearchEnabled()&&!this.isEmptyModel()){this.selector.clearState();this.selector.clearLayout();this.selector.layout();this.selector.searchInDialog()}else{this.getNameInput().value="";this.toggleIcon(this.getClearIcon(),"none")}this.selector.focusName();this.selector.emit("onClear",{selectorId:this.selector.getId(),rowId:this.selector.getRowId()});t.stopPropagation();t.preventDefault()}},{key:"handleNameInputChange",value:function e(t){var i=t.target.value;n.EventEmitter.emit("ProductList::onChangeFields",{rowId:this.selector.getRowId(),fields:{NAME:i}})}},{key:"focusName",value:function e(){var t=this;requestAnimationFrame(function(){return t.getNameInput().focus()})}},{key:"searchInDialog",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";if(!this.selector.isProductSearchEnabled()){return}var i=this.getDialog();if(i){i.show();i.search(t)}}},{key:"handleShowSearchDialog",value:function e(t){if(this.isEmptyModel()){this.selector.searchInDialog(t.target.value)}}},{key:"handleNameInputBlur",value:function e(t){var i=this;setTimeout(function(){i.toggleIcon(i.getClearIcon(),"none");if(i.showDetailLink()&&r.Type.isStringFilled(i.getValue())){i.toggleIcon(i.getSearchIcon(),"none");i.toggleIcon(i.getArrowIcon(),"block")}else{i.toggleIcon(i.getArrowIcon(),"none");i.toggleIcon(i.getSearchIcon(),"block")}},200)}},{key:"handleSearchIconClick",value:function e(t){this.selector.searchInDialog();this.selector.focusName();t.stopPropagation();t.preventDefault()}},{key:"onProductSelect",value:function e(t){var i=t.getData().item;i.getDialog().getTargetNode().value=i.getTitle();this.toggleIcon(this.getSearchIcon(),"none");if(this.selector){this.selector.onProductSelect(i.getId(),{saveProductFields:i.getCustomData().get("saveProductFields"),isNew:i.getCustomData().get("isNew")})}i.getDialog().hide()}},{key:"createProduct",value:function e(t){var i=this;return new Promise(function(e,n){var a=t.getData(),l=a.searchQuery;var s=t.getTarget();var o={NAME:l.getQuery(),IBLOCK_ID:i.selector.getIblockId()};s.showLoader();r.ajax.runAction("catalog.productSelector.createProduct",{json:{fields:o}}).then(function(t){s.hideLoader();var i=s.addItem({id:t.data.id,entityId:"product",title:l.getQuery(),tabs:s.getRecentTab().getId(),customData:{saveProductFields:true,isNew:true}});if(i){i.select()}s.hide();e()}).catch(function(){return n()})})}},{key:"getPlaceholder",value:function e(){return this.isSearchEnabled()&&this.isEmptyModel()?r.Loc.getMessage("CATALOG_SELECTOR_BEFORE_SEARCH_TITLE"):r.Loc.getMessage("CATALOG_SELECTOR_VIEW_NAME_TITLE")}}]);return e}();function b(){var e=babelHelpers.taggedTemplateLiteral(["<div></div>"]);b=function t(){return e};return e}var m=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,e);this.id=t||r.Text.getRandom();this.selector=i.selector||null;if(!(this.selector instanceof a.ProductSelector)){throw new Error("Product selector instance not found.")}this.config=i.config||{};this.setView(i.view);if(r.Type.isStringFilled(i.inputHtml)){this.setInputHtml(i.inputHtml)}else{this.restoreDefaultInputHtml()}this.enableSaving=i.enableSaving;this.uploaderFieldMap={};if(this.isEnabledLiveSaving()){n.EventEmitter.subscribe("onUploaderIsInited",this.onUploaderIsInitedHandler.bind(this))}}babelHelpers.createClass(e,[{key:"onUploaderIsInitedHandler",value:function e(t){var i=t.getCompatData(),a=babelHelpers.slicedToArray(i,2),l=a[0],s=a[1];if(!this.isViewMode()&&r.Type.isStringFilled(this.id)&&this.id===l){this.uploaderFieldMap={};n.EventEmitter.subscribe(s,"onFileIsDeleted",this.onFileDelete.bind(this));n.EventEmitter.subscribe(s,"onFileIsUploaded",this.onFileUpload.bind(this));n.EventEmitter.subscribe(s,"onQueueIsChanged",this.onQueueIsChanged.bind(this))}}},{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"setView",value:function e(t){this.view=r.Type.isStringFilled(t)?t:""}},{key:"setInputHtml",value:function e(t){this.inputHtml=r.Type.isStringFilled(t)?t:""}},{key:"restoreDefaultInputHtml",value:function e(){this.inputHtml="\n\t\t\t<div class='ui-image-input-container ui-image-input-img--disabled'>\n\t\t\t\t<div class='adm-fileinput-wrapper '>\n\t\t\t\t\t<div class='adm-fileinput-area mode-pict adm-fileinput-drag-area'></div>\n\t\t\t\t</div>\n\t\t\t</div>\n"}},{key:"isViewMode",value:function e(){return this.selector&&this.selector.isViewMode()}},{key:"isEnabledLiveSaving",value:function e(){return this.enableSaving}},{key:"layout",value:function e(){var t=r.Tag.render(b());r.Runtime.html(t,this.isViewMode()?this.view:this.inputHtml);return t}},{key:"onFileDelete",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,4),a=n[3];var r=a.fileId;if(this.isViewMode()||!this.selector){return}var l=this.selector.getModel().removeMorePhotoItem(r);if(l){this.save()}}},{key:"onQueueIsChanged",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,4),a=n[1],l=n[2],s=n[3];var o=s.file;if(a==="add"&&"input_name"in o&&r.Type.isNil(this.uploaderFieldMap[l])){this.uploaderFieldMap[l]=o["input_name"]}}},{key:"onFileUpload",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,3),a=n[0],l=n[2];if(!r.Type.isObject(l)||!("file"in l)||!("files"in l.file)||!("default"in l.file.files)||this.isViewMode()||!this.selector){return}var s=l["file"]["files"]["default"];var o={fileId:a,data:{name:s.name,type:s.type,tmp_name:s.path,size:s.size,error:null}};var u=this.uploaderFieldMap[a]||a;this.selector.getModel().addMorePhotoItem(u,o);this.save(true)}},{key:"save",value:function e(t){if(this.selector){this.selector.saveFiles(t)}}}]);return e}();var y=function(e){babelHelpers.inherits(t,e);function t(){var e;var i;babelHelpers.classCallCheck(this,t);for(var n=arguments.length,a=new Array(n),r=0;r<n;r++){a[r]=arguments[r]}i=babelHelpers.possibleConstructorReturn(this,(e=babelHelpers.getPrototypeOf(t)).call.apply(e,[this].concat(a)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"TYPE","empty");return i}return t}(l);var T=function(e){babelHelpers.inherits(t,e);function t(){var e;var i;babelHelpers.classCallCheck(this,t);for(var n=arguments.length,a=new Array(n),r=0;r<n;r++){a[r]=arguments[r]}i=babelHelpers.possibleConstructorReturn(this,(e=babelHelpers.getPrototypeOf(t)).call.apply(e,[this].concat(a)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"TYPE","product");return i}babelHelpers.createClass(t,[{key:"isSaveable",value:function e(){return this.getConfig("saveProductFields",false)}},{key:"getType",value:function e(){return t.TYPE}},{key:"isEnableFileSaving",value:function e(){return true}},{key:"getDetailPath",value:function e(){return this.getConfig("DETAIL_PATH","")}},{key:"removeMorePhotoItem",value:function e(t){for(var i in this.morePhoto){var n=this.morePhoto[i];if(!r.Type.isObject(n)){n=r.Text.toInteger(n)}if(r.Type.isNumber(n)&&n===r.Text.toInteger(t)||r.Type.isObject(n)&&n.fileId===t){delete this.morePhoto[i];return true}}return false}}]);return t}(l);var k=function(e){babelHelpers.inherits(t,e);function t(){var e;var i;babelHelpers.classCallCheck(this,t);for(var n=arguments.length,a=new Array(n),r=0;r<n;r++){a[r]=arguments[r]}i=babelHelpers.possibleConstructorReturn(this,(e=babelHelpers.getPrototypeOf(t)).call.apply(e,[this].concat(a)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"TYPE","sku");return i}babelHelpers.createClass(t,[{key:"getFileType",value:function e(){return this.config.fileType===T.TYPE?T.TYPE:t.TYPE}},{key:"getProductId",value:function e(){return this.getConfig("productId")}}]);return t}(T);function C(){var e=babelHelpers.taggedTemplateLiteral(['<div class="catalog-product-field-input"></div>']);C=function t(){return e};return e}function E(){var e=babelHelpers.taggedTemplateLiteral(['<span title="','">',"</span>"]);E=function t(){return e};return e}function P(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<a href="','" title="','">',"</a>\n\t\t\t"]);P=function t(){return e};return e}function S(){var e=babelHelpers.taggedTemplateLiteral(['<div class="catalog-product-img"></div>']);S=function t(){return e};return e}function w(){var e=babelHelpers.taggedTemplateLiteral(['<div class="catalog-product-field-inner"></div>']);w=function t(){return e};return e}var H=new Map;var N=function(e){babelHelpers.inherits(i,e);babelHelpers.createClass(i,null,[{key:"getById",value:function e(t){return H.get(t)||null}}]);function i(e){var t;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,i);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"mode",i.MODE_EDIT);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"cache",new r.Cache.MemoryCache);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"variationChangeHandler",t.handleVariationChange.bind(babelHelpers.assertThisInitialized(t)));t.setEventNamespace("BX.Catalog.ProductSelector");t.id=e||r.Text.getRandom();t.options=a||{};t.iblockId=r.Text.toNumber(a.iblockId);t.basePriceId=r.Text.toNumber(a.basePriceId);t.setMode(a.mode);t.model=t.createModel(a);t.model.setFields(a.fields);t.model.setMorePhotoValues(a.morePhotoValues);t.model.setDetailPath(t.getConfig("DETAIL_PATH"));t.skuTree=a.skuTree||null;t.setFileType(a.fileType);t.layout();n.EventEmitter.subscribe("ProductList::onChangeFields",r.Runtime.debounce(t.onChangeFields,500,babelHelpers.assertThisInitialized(t)));H.set(t.id,babelHelpers.assertThisInitialized(t));return t}babelHelpers.createClass(i,[{key:"createModel",value:function e(){var t;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var n=r.Text.toInteger(i.productId)||0;if(n<=0){return new y}var a=(i===null||i===void 0?void 0:(t=i.config)===null||t===void 0?void 0:t.MODEL_CONFIG)||{};var l=r.Text.toInteger(i.skuId)||0;if(l>0&&l!==n){return new k(l,babelHelpers.objectSpread({},a,{productId:n}))}return new T(n,a)}},{key:"getModel",value:function e(){return this.model}},{key:"setMode",value:function e(t){if(!r.Type.isNil(t)){this.mode=t===i.MODE_VIEW?i.MODE_VIEW:i.MODE_EDIT}}},{key:"setFileType",value:function e(t){this.fileType=t===i.SKU_TYPE?i.SKU_TYPE:i.PRODUCT_TYPE}},{key:"isViewMode",value:function e(){return this.mode===i.MODE_VIEW}},{key:"isSaveable",value:function e(){return!this.isViewMode()&&this.model.isSaveable()}},{key:"getId",value:function e(){return this.id}},{key:"getIblockId",value:function e(){return this.iblockId}},{key:"getBasePriceId",value:function e(){return this.basePriceId}},{key:"getConfig",value:function e(t,i){return BX.prop.get(this.options.config,t,i)}},{key:"getRowId",value:function e(){return this.getConfig("ROW_ID")}},{key:"getFileInput",value:function e(){if(!this.fileInput){this.fileInput=new m(this.options.fileInputId,{selector:this,view:this.options.fileView,inputHtml:this.options.fileInput,enableSaving:this.getConfig("ENABLE_IMAGE_CHANGE_SAVING",false)})}return this.fileInput}},{key:"isProductFileType",value:function e(){return this.fileType===i.PRODUCT_TYPE}},{key:"isProductSearchEnabled",value:function e(){return this.getConfig("ENABLE_SEARCH",false)&&this.getIblockId()>0}},{key:"isInputDetailLinkEnabled",value:function e(){return this.getConfig("ENABLE_INPUT_DETAIL_LINK",false)&&r.Type.isStringFilled(this.model.getDetailPath())}},{key:"getWrapper",value:function e(){this.wrapper=document.getElementById(this.id);return this.wrapper}},{key:"renderTo",value:function e(t){this.clearLayout();this.wrapper=t;this.layout()}},{key:"layout",value:function e(){var t=this.getWrapper();if(!t){return}this.defineWrapperClass(t);this.layoutImage();var i=r.Tag.render(w());t.appendChild(i);i.appendChild(this.layoutNameBlock());i.appendChild(this.getImageContainer());this.layoutSkuTree();this.subscribeToVariationChange()}},{key:"focusName",value:function e(){if(this.searchInput){this.searchInput.focusName()}return this}},{key:"searchInDialog",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";if(this.searchInput){this.searchInput.searchInDialog(t)}return this}},{key:"getImageContainer",value:function e(){return this.cache.remember("imageContainer",function(){return r.Tag.render(S())})}},{key:"layoutImage",value:function e(){this.getImageContainer().innerHTML="";this.getImageContainer().appendChild(this.getFileInput().layout());this.refreshImageSelectorId=null}},{key:"clearState",value:function e(){this.model=this.createModel();this.fileInput.setInputHtml(this.options.fileInput||"");this.skuTree=null;this.skuTreeInstance=null;this.refreshImageSelectorId=null}},{key:"clearLayout",value:function e(){var t=this.getWrapper();if(t){r.Event.unbindAll(t);t.innerHTML=""}this.unsubscribeToVariationChange()}},{key:"defineWrapperClass",value:function e(t){if(this.isViewMode()){r.Dom.addClass(t,"catalog-product-view");r.Dom.removeClass(t,"catalog-product-edit")}else{r.Dom.addClass(t,"catalog-product-edit");r.Dom.removeClass(t,"catalog-product-view")}}},{key:"getNameBlockView",value:function e(){var t=r.Text.encode(this.model.getField("NAME"));var i=r.Loc.getMessage("CATALOG_SELECTOR_VIEW_NAME_TITLE");if(this.getModel().getDetailPath()){return r.Tag.render(P(),this.getModel().getDetailPath(),i,t)}return r.Tag.render(E(),i,t)}},{key:"layoutNameBlock",value:function e(){var t=r.Tag.render(C());if(this.isViewMode()){t.appendChild(this.getNameBlockView())}else{this.searchInput=new I(this.id,{selector:this,model:this.getModel(),inputName:"NAME",isSearchEnabled:this.isProductSearchEnabled(),iblockId:this.getIblockId(),basePriceId:this.getBasePriceId(),isEnabledDetailLink:this.isInputDetailLinkEnabled()});t.appendChild(this.searchInput.layout())}return t}},{key:"updateSkuTree",value:function e(t){this.skuTree=t;this.skuTreeInstance=null}},{key:"getSkuTreeInstance",value:function e(){if(this.skuTree&&!this.skuTreeInstance){this.skuTreeInstance=new t.SkuTree({skuTree:this.skuTree,selectable:this.getConfig("ENABLE_SKU_SELECTION",true)})}return this.skuTreeInstance}},{key:"layoutSkuTree",value:function e(){var t=this.getSkuTreeInstance();var i=this.getWrapper();if(t&&i){i.appendChild(t.layout())}}},{key:"subscribeToVariationChange",value:function e(){var t=this.getSkuTreeInstance();if(t){t.subscribe("SkuProperty::onChange",this.variationChangeHandler)}}},{key:"unsubscribeToVariationChange",value:function e(){var t=this.getSkuTreeInstance();if(t){t.unsubscribe("SkuProperty::onChange",this.variationChangeHandler)}}},{key:"handleVariationChange",value:function e(t){var i=this;var n=t.getData(),a=babelHelpers.slicedToArray(n,1),l=a[0];var s=r.Text.toNumber(l.PARENT_PRODUCT_ID);var o=r.Text.toNumber(l.ID);if(s<=0||o<=0){return}this.model.setSaveable(false);this.emit("onBeforeChange",{selectorId:this.getId(),rowId:this.getRowId()});r.ajax.runAction("catalog.productSelector.getSelectedSku",{json:{variationId:o,options:{priceId:this.basePriceId,urlBuilder:this.getConfig("URL_BUILDER_CONTEXT")}}}).then(function(e){return i.processResponse(e,babelHelpers.objectSpread({},i.options.config))})}},{key:"onChangeFields",value:function e(t){var i=t.getData();if(!this.isSaveable()||i.rowId!==this.getRowId()){return}if(!r.Type.isNil(i.productId)&&i.productId!==this.getModel().getProductId()){return}var n=i.fields;var a=r.Text.toNumber(n.PRICE);if(a>0&&r.Type.isStringFilled(n.CURRENCY)){n.PRICES={};n.PRICES[this.getBasePriceId()]={PRICE:a,CURRENCY:n.CURRENCY}}this.updateProduct(n)}},{key:"updateProduct",value:function e(t){if(!r.Type.isPlainObject(t)){return}if(this.getModel().getId()<=0||this.getIblockId()<=0){return}r.ajax.runAction("catalog.productSelector.updateProduct",{json:{id:this.getModel().getId(),iblockId:this.getIblockId(),updateFields:t}})}},{key:"saveFiles",value:function e(t){var i=this;var n=this.getModel().getMorePhotoValues();if(this.submitFileTimeOut){clearTimeout(this.submitFileTimeOut)}var a=r.Text.getRandom(20);this.refreshImageSelectorId=a;this.submitFileTimeOut=setTimeout(function(){r.ajax.runAction("catalog.productSelector.saveMorePhoto",{json:{productId:i.model.getProductId(),variationId:i.model.getId(),iblockId:i.getIblockId(),imageValues:n}}).then(function(e){if(!t&&i.refreshImageSelectorId===a){return}i.getFileInput().setId(e.data.id);i.getFileInput().setInputHtml(e.data.input);i.getFileInput().setView(e.data.preview);i.getModel().setMorePhotoValues(e.data.values);i.layoutImage()})},500)}},{key:"onProductSelect",value:function e(t,i){this.emit("onBeforeChange",{selectorId:this.getId(),rowId:this.getRowId()});this.productSelectAjaxAction(t,i)}},{key:"productSelectAjaxAction",value:function e(t){var i=this;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{saveProductFields:false,isNew:false};r.ajax.runAction("catalog.productSelector.getProduct",{json:{productId:t,options:{priceId:this.basePriceId,urlBuilder:this.getConfig("URL_BUILDER_CONTEXT")}}}).then(function(e){return i.processResponse(e,babelHelpers.objectSpread({},i.options.config,n),true)})}},{key:"processResponse",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var a=(t===null||t===void 0?void 0:t.data)||null;if(a){this.changeSelectedElement(a,i)}else if(n){this.clearState()}else{this.productSelectAjaxAction(this.getModel().getProductId())}this.unsubscribeToVariationChange();this.clearLayout();this.layout();var r=(a===null||a===void 0?void 0:a.fields)||null;this.emit("onChange",{selectorId:this.id,rowId:this.getRowId(),isNew:i.isNew||false,fields:r})}},{key:"changeSelectedElement",value:function e(t,i){var n=r.Text.toInteger(t.productId);var a=this.getModel().getId()!==n;if(a){var l=r.Text.toInteger(t.skuId);if(l>0&&l!==n){i.productId=n;this.model=new k(l,i)}else{this.model=new T(n,i)}}this.getModel().setFields(t.fields);var s={id:"",input:"",preview:"",values:[]};if(r.Type.isObject(t.image)){s.id=t.image.id;s.input=t.image.input;s.preview=t.image.preview;s.values=t.image.values;this.getModel().setFileType(t.fileType)}this.getFileInput().setId(s.id);this.getFileInput().setInputHtml(s.input);this.getFileInput().setView(s.preview);this.getModel().setMorePhotoValues(s.values);if(t.detailUrl){this.getModel().setDetailPath(t.detailUrl)}if(r.Type.isObject(t.skuTree)){this.updateSkuTree(t.skuTree)}}}]);return i}(n.EventEmitter);babelHelpers.defineProperty(N,"MODE_VIEW","view");babelHelpers.defineProperty(N,"MODE_EDIT","edit");babelHelpers.defineProperty(N,"PRODUCT_TYPE","product");babelHelpers.defineProperty(N,"SKU_TYPE","sku");e.ProductSelector=N})(this.BX.Catalog=this.BX.Catalog||{},BX.Catalog.SkuTree,BX.UI.EntitySelector,BX.Event,BX.Catalog,BX);
//# sourceMappingURL=product-selector.bundle.map.js