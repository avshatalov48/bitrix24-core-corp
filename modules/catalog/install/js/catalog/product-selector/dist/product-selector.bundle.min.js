this.BX=this.BX||{};(function(e,t,i,n,a,r){"use strict";var l=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,e);this.id=t||r.Text.getRandom();this.config=i||{};this.errors={};this.setMorePhotoValues(i.morePhoto);this.setFields(i.fields)}babelHelpers.createClass(e,[{key:"getId",value:function e(){return this.id}},{key:"getProductId",value:function e(){return this.id}},{key:"isSaveable",value:function e(){return false}},{key:"setSaveable",value:function e(t){this.config.saveProductFields=t}},{key:"isNew",value:function e(){return this.getConfig("isNew",false)}},{key:"getConfig",value:function e(t,i){return BX.prop.get(this.config,t,i)}},{key:"getFields",value:function e(){return this.fields}},{key:"getField",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";return BX.prop.get(this.fields,t,i)}},{key:"setFields",value:function e(t){this.fields=r.Type.isObject(t)?t:{}}},{key:"getErrors",value:function e(){return this.errors}},{key:"setError",value:function e(t,i){this.errors[t]=i}},{key:"clearErrors",value:function e(t,i){this.errors={}}},{key:"hasErrors",value:function e(){return Object.keys(this.errors).length>0}},{key:"isEnableFileSaving",value:function e(){return false}},{key:"getMorePhotoValues",value:function e(){return this.morePhoto}},{key:"setMorePhotoValues",value:function e(t){this.morePhoto=r.Type.isPlainObject(t)?t:{}}},{key:"removeMorePhotoItem",value:function e(t){return false}},{key:"addMorePhotoItem",value:function e(t,i){this.morePhoto[t]=i}},{key:"setFileType",value:function e(t){this.config.fileType=t||""}},{key:"getDetailPath",value:function e(){return""}},{key:"setDetailPath",value:function e(t){this.config.DETAIL_PATH=t||""}}]);return e}();var s,o,u,c,d,h,g,p,f,b;var v=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"cache",new r.Cache.MemoryCache);this.id=t||r.Text.getRandom();this.selector=i.selector;if(!(this.selector instanceof a.ProductSelector)){throw new Error("Product selector instance not found.")}this.model=i.model||{};this.isEnabledSearch=i.isSearchEnabled;this.isEnabledDetailLink=i.isEnabledDetailLink;this.isEnabledEmptyProductError=i.isEnabledEmptyProductError;this.inputName=i.inputName||""}babelHelpers.createClass(e,[{key:"getId",value:function e(){return this.id}},{key:"getField",value:function e(t){return this.model.getField(t)}},{key:"getValue",value:function e(){return this.getField(this.inputName)}},{key:"isSearchEnabled",value:function e(){return this.isEnabledSearch}},{key:"toggleIcon",value:function e(t,i){if(r.Type.isDomNode(t)){r.Dom.style(t,"display",i)}}},{key:"getNameBlock",value:function e(){var t=this;return this.cache.remember("nameBlock",function(){return r.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-ctl ui-ctl-textbox ui-ctl-w100">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"])),t.getNameTag(),t.getNameInput(),t.getHiddenNameInput())})}},{key:"getNameTag",value:function e(){if(!this.model.isNew()){return""}return r.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-ctl-tag">',"</div>\n\t\t"])),r.Loc.getMessage("CATALOG_SELECTOR_NEW_TAG_TITLE"))}},{key:"getNameInput",value:function e(){var t=this;return this.cache.remember("nameInput",function(){return r.Tag.render(u||(u=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input type="text" \n\t\t\t\t\tclass="ui-ctl-element ui-ctl-textbox" \n\t\t\t\t\tautocomplete="off"\n\t\t\t\t\tvalue="','"\n\t\t\t\t\tplaceholder="','"\n\t\t\t\t\tonchange="','"\n\t\t\t\t>\n\t\t\t'])),r.Text.encode(t.getValue()),r.Text.encode(t.getPlaceholder()),t.handleNameInputHiddenChange.bind(t))})}},{key:"getHiddenNameInput",value:function e(){var t=this;return this.cache.remember("hiddenNameInput",function(){return r.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input\n\t\t\t\t \ttype="hidden" \n\t\t\t\t\tname="','" \n\t\t\t\t\tvalue="','"\n\t\t\t\t>\n\t\t\t'])),r.Text.encode(t.inputName),r.Text.encode(t.getValue()))})}},{key:"handleNameInputHiddenChange",value:function e(t){this.getHiddenNameInput().value=t.target.value}},{key:"getClearIcon",value:function e(){var t=this;return this.cache.remember("closeIcon",function(){return r.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<button\n\t\t\t\t\tclass="ui-ctl-after ui-ctl-icon-clear" \n\t\t\t\t\tonclick="','"\n\t\t\t\t></button>\n\t\t\t'])),t.handleClearIconClick.bind(t))})}},{key:"getArrowIcon",value:function e(){var t=this;return this.cache.remember("arrowIcon",function(){return r.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<a\n\t\t\t\t\thref="','"\n\t\t\t\t\ttarget="_blank"\n\t\t\t\t\tclass="ui-ctl-after ui-ctl-icon-forward"\n\t\t\t\t></button>\n\t\t\t'])),t.model.getDetailPath())})}},{key:"getSearchIcon",value:function e(){var t=this;return this.cache.remember("searchIcon",function(){return r.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<button\n\t\t\t\t\tclass="ui-ctl-after ui-ctl-icon-search"\n\t\t\t\t\tonclick="','"\n\t\t\t\t></button>\n\t\t\t'])),t.handleSearchIconClick.bind(t))})}},{key:"layout",value:function e(){var t=r.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['<div class="ui-ctl ui-ctl-w100 ui-ctl-after-icon"></div>'])));if(!r.Type.isStringFilled(this.getValue())){this.toggleIcon(this.getClearIcon(),"none")}t.appendChild(this.getClearIcon());if(this.showDetailLink()&&r.Type.isStringFilled(this.getValue())){this.toggleIcon(this.getClearIcon(),"none");this.toggleIcon(this.getArrowIcon(),"block");t.appendChild(this.getArrowIcon())}if(this.isSearchEnabled()){var i=r.Type.isStringFilled(this.getValue())?"none":"block";this.toggleIcon(this.getSearchIcon(),i);t.appendChild(this.getSearchIcon());r.Event.bind(this.getNameInput(),"click",this.handleShowSearchDialog.bind(this));r.Event.bind(this.getNameInput(),"input",this.handleShowSearchDialog.bind(this));r.Event.bind(this.getNameInput(),"blur",this.handleNameInputBlur.bind(this));r.Event.bind(this.getNameInput(),"keydown",this.handleNameInputKeyDown.bind(this))}r.Event.bind(this.getNameInput(),"click",this.handleIconsSwitchingOnNameInput.bind(this));r.Event.bind(this.getNameInput(),"input",this.handleIconsSwitchingOnNameInput.bind(this));if(this.selector&&this.selector.isSaveable()){r.Event.bind(this.getNameInput(),"change",this.handleNameInputChange.bind(this))}t.appendChild(this.getNameBlock());return t}},{key:"showDetailLink",value:function e(){return this.isEnabledDetailLink}},{key:"getDialog",value:function e(){var t=this;return this.cache.remember("dialog",function(){return new i.Dialog({id:t.id,height:300,context:"catalog-products",targetNode:t.getNameInput(),enableSearch:false,multiple:false,dropdownMode:true,searchTabOptions:{stub:true,stubOptions:{title:r.Tag.message(f||(f=babelHelpers.taggedTemplateLiteral(["",""])),"CATALOG_SELECTOR_IS_EMPTY_TITLE"),subtitle:r.Tag.message(b||(b=babelHelpers.taggedTemplateLiteral(["",""])),"CATALOG_SELECTOR_IS_EMPTY_SUBTITLE"),arrow:true}},searchOptions:{allowCreateItem:true},events:{"Item:onSelect":t.onProductSelect.bind(t),"Search:onItemCreateAsync":t.createProduct.bind(t)},entities:[{id:"product",options:{iblockId:t.selector.getIblockId(),basePriceId:t.selector.getBasePriceId()}}]})})}},{key:"handleNameInputKeyDown",value:function e(t){var i=this.getDialog();if(t.key==="Enter"&&i.getActiveTab()===i.getSearchTab()){t.preventDefault();if(r.Browser.isMac()&&t.metaKey||t.ctrlKey){i.getSearchTab().getFooter().createItem()}}}},{key:"handleIconsSwitchingOnNameInput",value:function e(t){this.toggleIcon(this.getArrowIcon(),"none");if(r.Type.isStringFilled(t.target.value)){this.toggleIcon(this.getClearIcon(),"block");this.toggleIcon(this.getSearchIcon(),"none")}else{this.toggleIcon(this.getClearIcon(),"none");this.toggleIcon(this.getSearchIcon(),"block")}}},{key:"handleClearIconClick",value:function e(t){if(this.selector.isProductSearchEnabled()&&!this.selector.isEmptyModel()){this.selector.clearState();this.selector.clearLayout();this.selector.layout();this.selector.searchInDialog()}else{this.getNameInput().value="";this.toggleIcon(this.getClearIcon(),"none")}this.selector.focusName();this.selector.emit("onClear",{selectorId:this.selector.getId(),rowId:this.selector.getRowId()});t.stopPropagation();t.preventDefault()}},{key:"handleNameInputChange",value:function e(t){var i=t.target.value;n.EventEmitter.emit("ProductList::onChangeFields",{rowId:this.selector.getRowId(),fields:{NAME:i}})}},{key:"focusName",value:function e(){var t=this;requestAnimationFrame(function(){return t.getNameInput().focus()})}},{key:"searchInDialog",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";if(!this.selector.isProductSearchEnabled()){return}var i=this.getDialog();if(i){i.show();i.search(t)}}},{key:"handleShowSearchDialog",value:function e(t){if(this.selector.isEmptyModel()||this.selector.isSimpleModel()){this.selector.searchInDialog(t.target.value)}}},{key:"handleNameInputBlur",value:function e(t){var i=this;setTimeout(function(){i.toggleIcon(i.getClearIcon(),"none");if(i.showDetailLink()&&r.Type.isStringFilled(i.getValue())){i.toggleIcon(i.getSearchIcon(),"none");i.toggleIcon(i.getArrowIcon(),"block")}else{i.toggleIcon(i.getArrowIcon(),"none");i.toggleIcon(i.getSearchIcon(),"block")}},200);if(this.isSearchEnabled()&&this.isEnabledEmptyProductError){setTimeout(function(){if(i.selector.isEmptyModel()){i.model.setError("NOT_SELECTED_PRODUCT",r.Loc.getMessage("CATALOG_SELECTOR_SELECTED_PRODUCT_TITLE"));i.selector.layoutErrors()}},200)}}},{key:"handleSearchIconClick",value:function e(t){this.selector.searchInDialog();this.selector.focusName();t.stopPropagation();t.preventDefault()}},{key:"resetModel",value:function e(t){var i=this.selector.getModel().getFields();var n=this.selector.createModel({isSimpleModel:true});this.selector.setModel(n);i["NAME"]=t;this.selector.getModel().setFields(i)}},{key:"onProductSelect",value:function e(t){var i=t.getData().item;i.getDialog().getTargetNode().value=i.getTitle();this.toggleIcon(this.getSearchIcon(),"none");this.resetModel(i.getTitle());this.selector.clearLayout();this.selector.layout();if(this.selector){this.selector.onProductSelect(i.getId(),{saveProductFields:i.getCustomData().get("saveProductFields"),isNew:i.getCustomData().get("isNew")})}i.getDialog().hide()}},{key:"createProduct",value:function e(t){var i=this;var n=t.getData(),a=n.searchQuery;this.resetModel(a.getQuery());return new Promise(function(e,n){var l=t.getTarget();var s={NAME:a.getQuery(),IBLOCK_ID:i.selector.getIblockId()};var o=i.selector.getModel().getField("PRICE",null);if(!r.Type.isNil(o)){s["PRICE"]=o}var u=i.selector.getModel().getField("CURRENCY",null);if(r.Type.isStringFilled(u)){s["CURRENCY"]=u}l.showLoader();r.ajax.runAction("catalog.productSelector.createProduct",{json:{fields:s}}).then(function(t){l.hideLoader();var i=l.addItem({id:t.data.id,entityId:"product",title:a.getQuery(),tabs:l.getRecentTab().getId(),customData:{saveProductFields:true,isNew:true}});if(i){i.select()}l.hide();e()}).catch(function(){return n()})})}},{key:"getPlaceholder",value:function e(){return this.isSearchEnabled()&&this.selector.isEmptyModel()?r.Loc.getMessage("CATALOG_SELECTOR_BEFORE_SEARCH_TITLE"):r.Loc.getMessage("CATALOG_SELECTOR_VIEW_NAME_TITLE")}}]);return e}();var I;var m=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,e);this.id=t||r.Text.getRandom();this.selector=i.selector||null;if(!(this.selector instanceof a.ProductSelector)){throw new Error("Product selector instance not found.")}this.config=i.config||{};this.setView(i.view);if(r.Type.isStringFilled(i.inputHtml)){this.setInputHtml(i.inputHtml)}else{this.restoreDefaultInputHtml()}this.enableSaving=i.enableSaving;this.uploaderFieldMap={}}babelHelpers.createClass(e,[{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"setView",value:function e(t){this.view=r.Type.isStringFilled(t)?t:""}},{key:"setInputHtml",value:function e(t){this.inputHtml=r.Type.isStringFilled(t)?t:""}},{key:"restoreDefaultInputHtml",value:function e(){this.inputHtml="\n\t\t\t<div class='ui-image-input-container ui-image-input-img--disabled'>\n\t\t\t\t<div class='adm-fileinput-wrapper '>\n\t\t\t\t\t<div class='adm-fileinput-area mode-pict adm-fileinput-drag-area'></div>\n\t\t\t\t</div>\n\t\t\t</div>\n"}},{key:"isViewMode",value:function e(){return this.selector&&this.selector.isViewMode()}},{key:"isEnabledLiveSaving",value:function e(){return this.enableSaving}},{key:"layout",value:function e(){var t=r.Tag.render(I||(I=babelHelpers.taggedTemplateLiteral(["<div></div>"])));r.Runtime.html(t,this.isViewMode()?this.view:this.inputHtml);return t}}]);return e}();var y=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return t}(l);var E=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"isSaveable",value:function e(){return this.getConfig("saveProductFields",false)}},{key:"isEnableFileSaving",value:function e(){return true}},{key:"getDetailPath",value:function e(){return this.getConfig("DETAIL_PATH","")}},{key:"removeMorePhotoItem",value:function e(t){for(var i in this.morePhoto){var n=this.morePhoto[i];if(!r.Type.isObject(n)){n=r.Text.toInteger(n)}if(r.Type.isNumber(n)&&n===r.Text.toInteger(t)||r.Type.isObject(n)&&n.fileId===t){delete this.morePhoto[i];return true}}return false}},{key:"setMorePhotoValues",value:function e(i){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"setMorePhotoValues",this).call(this,i);if(this.isEnabledEmptyImageError()&&this.morePhoto.length===0){this.setError("EMPTY_IMAGE",r.Loc.getMessage("CATALOG_SELECTOR_EMPTY_IMAGE_ERROR"))}}},{key:"isEnabledEmptyImageError",value:function e(){return this.getConfig("ENABLE_EMPTY_IMAGES_ERROR",false)}}]);return t}(l);var T=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getProductId",value:function e(){return this.getConfig("productId")}}]);return t}(E);var k=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getName",value:function e(){return this.getConfig("NAME","")}}]);return t}(l);var C,S,P,H,N,M,w;var L=new Map;var D=function(e){babelHelpers.inherits(i,e);babelHelpers.createClass(i,null,[{key:"getById",value:function e(t){return L.get(t)||null}}]);function i(e){var t;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,i);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"mode",i.MODE_EDIT);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"cache",new r.Cache.MemoryCache);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"variationChangeHandler",t.handleVariationChange.bind(babelHelpers.assertThisInitialized(t)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"onSaveImageHandler",t.onSaveImage.bind(babelHelpers.assertThisInitialized(t)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"onChangeFieldsHandler",r.Runtime.debounce(t.onChangeFields,500,babelHelpers.assertThisInitialized(t)));t.setEventNamespace("BX.Catalog.ProductSelector");t.id=e||r.Text.getRandom();a.inputFieldName=a.inputFieldName||"NAME";t.options=a||{};t.iblockId=r.Text.toNumber(a.iblockId);t.basePriceId=r.Text.toNumber(a.basePriceId);t.setMode(a.mode);t.model=t.createModel(a);t.model.setFields(a.fields);t.model.setMorePhotoValues(a.morePhotoValues);t.model.setDetailPath(t.getConfig("DETAIL_PATH"));if(t.isSimpleModel()&&t.isEnabledEmptyProductError()){t.model.setError("NOT_SELECTED_PRODUCT",r.Loc.getMessage("CATALOG_SELECTOR_SELECTED_PRODUCT_TITLE"))}t.skuTree=a.skuTree||null;t.setFileType(a.fileType);t.layout();n.EventEmitter.subscribe("ProductList::onChangeFields",t.onChangeFieldsHandler);n.EventEmitter.subscribe("Catalog.ImageInput::save",t.onSaveImageHandler);L.set(t.id,babelHelpers.assertThisInitialized(t));return t}babelHelpers.createClass(i,[{key:"createModel",value:function e(){var t;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(i.isSimpleModel){return new k}var n=r.Text.toInteger(i.productId)||0;if(n<=0){return new y}var a=(i===null||i===void 0?void 0:(t=i.config)===null||t===void 0?void 0:t.MODEL_CONFIG)||{};var l=r.Text.toInteger(i.skuId)||0;if(l>0&&l!==n){return new T(l,babelHelpers.objectSpread({},a,{productId:n}))}return new E(n,a)}},{key:"setModel",value:function e(t){this.model=t}},{key:"getModel",value:function e(){return this.model}},{key:"isEmptyModel",value:function e(){return this.getModel()instanceof y}},{key:"isSimpleModel",value:function e(){return this.getModel()instanceof k}},{key:"setMode",value:function e(t){if(!r.Type.isNil(t)){this.mode=t===i.MODE_VIEW?i.MODE_VIEW:i.MODE_EDIT}}},{key:"setFileType",value:function e(t){this.fileType=t===i.SKU_TYPE?i.SKU_TYPE:i.PRODUCT_TYPE}},{key:"isViewMode",value:function e(){return this.mode===i.MODE_VIEW}},{key:"isSaveable",value:function e(){return!this.isViewMode()&&this.model.isSaveable()}},{key:"getId",value:function e(){return this.id}},{key:"getIblockId",value:function e(){return this.iblockId}},{key:"getBasePriceId",value:function e(){return this.basePriceId}},{key:"getConfig",value:function e(t,i){return BX.prop.get(this.options.config,t,i)}},{key:"getRowId",value:function e(){return this.getConfig("ROW_ID")}},{key:"getFileInput",value:function e(){if(!this.fileInput){this.fileInput=new m(this.options.fileInputId,{selector:this,view:this.options.fileView,inputHtml:this.options.fileInput,enableSaving:this.getConfig("ENABLE_IMAGE_CHANGE_SAVING",false)})}return this.fileInput}},{key:"isProductFileType",value:function e(){return this.fileType===i.PRODUCT_TYPE}},{key:"isProductSearchEnabled",value:function e(){return this.getConfig("ENABLE_SEARCH",false)&&this.getIblockId()>0}},{key:"isImageFieldEnabled",value:function e(){return this.getConfig("ENABLE_IMAGE_INPUT",true)!==false}},{key:"isEnabledEmptyProductError",value:function e(){return this.getConfig("ENABLE_EMPTY_PRODUCT_ERROR",false)}},{key:"isEnabledChangesRendering",value:function e(){return this.getConfig("ENABLE_CHANGES_RENDERING",true)}},{key:"isInputDetailLinkEnabled",value:function e(){return this.getConfig("ENABLE_INPUT_DETAIL_LINK",false)&&r.Type.isStringFilled(this.model.getDetailPath())}},{key:"getWrapper",value:function e(){if(!this.wrapper){this.wrapper=document.getElementById(this.id)}return this.wrapper}},{key:"renderTo",value:function e(t){this.clearLayout();this.wrapper=t;this.layout()}},{key:"layout",value:function e(){var t=this;var i=this.getWrapper();if(!i){return}this.defineWrapperClass(i);var n=r.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(['<div class="catalog-product-field-inner"></div>'])));i.appendChild(n);n.appendChild(this.layoutNameBlock());if(this.isImageFieldEnabled()){if(!r.Reflection.getClass("BX.UI.ImageInput")){r.ajax.runAction("catalog.productSelector.getFileInput",{json:{iblockId:this.iblockId}}).then(function(){t.layoutImage()})}else{this.layoutImage()}n.appendChild(this.getImageContainer())}else{r.Dom.addClass(i,"catalog-product-field-no-image")}i.appendChild(this.getErrorContainer());this.layoutErrors();this.layoutSkuTree();this.subscribeToVariationChange()}},{key:"focusName",value:function e(){if(this.searchInput){this.searchInput.focusName()}return this}},{key:"searchInDialog",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";if(this.searchInput){this.searchInput.searchInDialog(t)}return this}},{key:"getImageContainer",value:function e(){return this.cache.remember("imageContainer",function(){return r.Tag.render(S||(S=babelHelpers.taggedTemplateLiteral(['<div class="catalog-product-img"></div>'])))})}},{key:"getErrorContainer",value:function e(){return this.cache.remember("errorContainer",function(){return r.Tag.render(P||(P=babelHelpers.taggedTemplateLiteral(['<div class="catalog-product-error"></div>'])))})}},{key:"layoutErrors",value:function e(){this.getErrorContainer().innerHTML="";if(!this.model.hasErrors()){return}var t=this.model.getErrors();for(var i in t){this.getErrorContainer().appendChild(r.Tag.render(H||(H=babelHelpers.taggedTemplateLiteral(['<div class="catalog-product-error-item">',"</div>"])),t[i]))}if(this.searchInput){r.Dom.addClass(this.searchInput.getNameBlock(),"ui-ctl-danger")}}},{key:"layoutImage",value:function e(){this.getImageContainer().innerHTML="";this.getImageContainer().appendChild(this.getFileInput().layout());this.refreshImageSelectorId=null}},{key:"clearState",value:function e(){this.model=this.createModel();this.fileInput.restoreDefaultInputHtml();this.skuTree=null;this.skuTreeInstance=null;this.refreshImageSelectorId=null}},{key:"clearLayout",value:function e(){var t=this.getWrapper();if(t){r.Event.unbindAll(t);t.innerHTML=""}this.unsubscribeToVariationChange()}},{key:"unsubscribeEvents",value:function e(){this.unsubscribeToVariationChange();n.EventEmitter.unsubscribe("ProductList::onChangeFields",this.onChangeFieldsHandler)}},{key:"defineWrapperClass",value:function e(t){if(this.isViewMode()){r.Dom.addClass(t,"catalog-product-view");r.Dom.removeClass(t,"catalog-product-edit")}else{r.Dom.addClass(t,"catalog-product-edit");r.Dom.removeClass(t,"catalog-product-view")}}},{key:"getNameBlockView",value:function e(){var t=r.Text.encode(this.model.getField("NAME"));var i=r.Loc.getMessage("CATALOG_SELECTOR_VIEW_NAME_TITLE");if(this.getModel().getDetailPath()){return r.Tag.render(N||(N=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<a href="','" title="','">',"</a>\n\t\t\t"])),this.getModel().getDetailPath(),i,t)}return r.Tag.render(M||(M=babelHelpers.taggedTemplateLiteral(['<span title="','">',"</span>"])),i,t)}},{key:"layoutNameBlock",value:function e(){var t=r.Tag.render(w||(w=babelHelpers.taggedTemplateLiteral(['<div class="catalog-product-field-input"></div>'])));if(this.isViewMode()){t.appendChild(this.getNameBlockView())}else{this.searchInput=new v(this.id,{selector:this,model:this.getModel(),inputName:this.options.inputFieldName,isSearchEnabled:this.isProductSearchEnabled(),isEnabledEmptyProductError:this.isEnabledEmptyProductError(),iblockId:this.getIblockId(),basePriceId:this.getBasePriceId(),isEnabledDetailLink:this.isInputDetailLinkEnabled()});t.appendChild(this.searchInput.layout())}return t}},{key:"updateSkuTree",value:function e(t){this.skuTree=t;this.skuTreeInstance=null}},{key:"getSkuTreeInstance",value:function e(){if(this.skuTree&&!this.skuTreeInstance){this.skuTreeInstance=new t.SkuTree({skuTree:this.skuTree,selectable:this.getConfig("ENABLE_SKU_SELECTION",true),hideUnselected:this.getConfig("HIDE_UNSELECTED_ITEMS",false)})}return this.skuTreeInstance}},{key:"layoutSkuTree",value:function e(){var t=this.getSkuTreeInstance();var i=this.getWrapper();if(t&&i){var n=t.layout();i.appendChild(n)}}},{key:"subscribeToVariationChange",value:function e(){var t=this.getSkuTreeInstance();if(t){t.subscribe("SkuProperty::onChange",this.variationChangeHandler)}}},{key:"unsubscribeToVariationChange",value:function e(){var t=this.getSkuTreeInstance();if(t){t.unsubscribe("SkuProperty::onChange",this.variationChangeHandler)}}},{key:"handleVariationChange",value:function e(t){var i=this;var n=t.getData(),a=babelHelpers.slicedToArray(n,1),l=a[0];var s=r.Text.toNumber(l.PARENT_PRODUCT_ID);var o=r.Text.toNumber(l.ID);if(s<=0||o<=0){return}this.model.setSaveable(false);this.emit("onBeforeChange",{selectorId:this.getId(),rowId:this.getRowId()});r.ajax.runAction("catalog.productSelector.getSelectedSku",{json:{variationId:o,options:{priceId:this.basePriceId,urlBuilder:this.getConfig("URL_BUILDER_CONTEXT")}}}).then(function(e){return i.processResponse(e,babelHelpers.objectSpread({},i.options.config))})}},{key:"onChangeFields",value:function e(t){var i=t.getData();if(!this.isSaveable()||i.rowId!==this.getRowId()){return}if(!r.Type.isNil(i.productId)&&i.productId!==this.getModel().getProductId()){return}var n=i.fields;var a=r.Text.toNumber(n.PRICE);if(a>0&&r.Type.isStringFilled(n.CURRENCY)){n.PRICES={};n.PRICES[this.getBasePriceId()]={PRICE:a,CURRENCY:n.CURRENCY}}this.updateProduct(n)}},{key:"updateProduct",value:function e(t){if(!r.Type.isPlainObject(t)){return}if(this.getModel().getId()<=0||this.getIblockId()<=0){return}r.ajax.runAction("catalog.productSelector.updateProduct",{json:{id:this.getModel().getId(),iblockId:this.getIblockId(),updateFields:t}})}},{key:"onSaveImage",value:function e(t){var i=t.getData(),n=babelHelpers.slicedToArray(i,3),a=n[1],r=n[2];if(this.isEmptyModel()||this.isSimpleModel()||a!==this.getFileInput().getId()){return}this.getFileInput().setId(r.data.id);this.getFileInput().setInputHtml(r.data.input);this.getFileInput().setView(r.data.preview);this.getModel().setMorePhotoValues(r.data.values);if(this.isImageFieldEnabled()){this.layoutImage()}}},{key:"onProductSelect",value:function e(t,i){this.emit("onBeforeChange",{selectorId:this.getId(),rowId:this.getRowId()});this.productSelectAjaxAction(t,i)}},{key:"productSelectAjaxAction",value:function e(t){var i=this;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{saveProductFields:false,isNew:false};r.ajax.runAction("catalog.productSelector.getProduct",{json:{productId:t,options:{priceId:this.basePriceId,urlBuilder:this.getConfig("URL_BUILDER_CONTEXT")}}}).then(function(e){return i.processResponse(e,babelHelpers.objectSpread({},i.options.config,n),true)})}},{key:"processResponse",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var a=(t===null||t===void 0?void 0:t.data)||null;if(a){this.changeSelectedElement(a,i)}else if(n){this.clearState()}else{this.productSelectAjaxAction(this.getModel().getProductId())}this.unsubscribeToVariationChange();if(this.isEnabledChangesRendering()){this.clearLayout();this.layout()}var r=(a===null||a===void 0?void 0:a.fields)||null;this.emit("onChange",{selectorId:this.id,rowId:this.getRowId(),isNew:i.isNew||false,fields:r})}},{key:"changeSelectedElement",value:function e(t,i){var n=r.Text.toInteger(t.productId);var a=this.getModel().getId()!==n;if(a){var l=r.Text.toInteger(t.skuId);if(l>0&&l!==n){i.productId=n;this.model=new T(l,i)}else{this.model=new E(n,i)}}this.getModel().setFields(t.fields);var s={id:"",input:"",preview:"",values:[]};if(r.Type.isObject(t.image)){s.id=t.image.id;s.input=t.image.input;s.preview=t.image.preview;s.values=t.image.values;this.getModel().setFileType(t.fileType)}this.getFileInput().setId(s.id);this.getFileInput().setInputHtml(s.input);this.getFileInput().setView(s.preview);this.getModel().setMorePhotoValues(s.values);if(t.detailUrl){this.getModel().setDetailPath(t.detailUrl)}if(r.Type.isObject(t.skuTree)){this.updateSkuTree(t.skuTree)}}}]);return i}(n.EventEmitter);babelHelpers.defineProperty(D,"MODE_VIEW","view");babelHelpers.defineProperty(D,"MODE_EDIT","edit");babelHelpers.defineProperty(D,"PRODUCT_TYPE","product");babelHelpers.defineProperty(D,"SKU_TYPE","sku");e.ProductSelector=D})(this.BX.Catalog=this.BX.Catalog||{},BX.Catalog.SkuTree,BX.UI.EntitySelector,BX.Event,BX.Catalog,BX);
//# sourceMappingURL=product-selector.bundle.map.js