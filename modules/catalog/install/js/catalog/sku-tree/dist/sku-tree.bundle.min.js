this.BX=this.BX||{};this.BX.Catalog=this.BX.Catalog||{};(function(e,t,r,i,n){"use strict";var s,a,l,u,o,c,p;var d=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"skuSelectHandler",this.handleSkuSelect.bind(this));this.parent=t.parent||null;if(!this.parent){throw new Error("Parent is not defined.")}this.property=t.property||{};this.offers=t.offers||[];this.existingValues=t.existingValues||[];this.nodeDescriptions=[];this.hideUnselected=t.hideUnselected}babelHelpers.createClass(e,[{key:"getId",value:function e(){return this.property.ID}},{key:"getSelectedSkuId",value:function e(){return this.parent.getSelectedSkuId()}},{key:"hasSkuValues",value:function e(){return this.property.VALUES.length}},{key:"renderPictureSku",value:function e(t,i){var n=r.Type.isStringFilled(t.NAME)?r.Text.encode(t.NAME):"";var o="";if(r.Type.isStringFilled(n)){o=r.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(['<span class="ui-ctl-label-text">',"</span>"])),n)}var c="";if(t.PICT&&t.PICT.SRC){var p="background-image: url('"+t.PICT.SRC+"');";c=r.Tag.render(a||(a=babelHelpers.taggedTemplateLiteral(['<span class="ui-ctl-label-img" style="','"></span>'])),p)}else if(o){o.style.paddingLeft="0"}else{o=r.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['<span class="ui-ctl-label-text">-</span>'])))}return r.Tag.render(u||(u=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<label \tclass="ui-ctl ui-ctl-radio-selector"\n\t\t\t\t\tonclick="','"\n\t\t\t\t\ttitle="','"\n\t\t\t\t\tdata-property-id="','"\n\t\t\t\t\tdata-property-value="','">\n\t\t\t\t<input type="radio"\n\t\t\t\t\tdisabled="','"\n\t\t\t\t\tname="property-',"-","-",'"\n\t\t\t\t\tclass="ui-ctl-element">\n\t\t\t\t<span class="ui-ctl-inner">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t</span>\n\t\t\t</label>\n\t\t"])),this.skuSelectHandler,n,this.getId(),t.ID,!this.parent.isSelectable(),this.getSelectedSkuId(),this.getId(),i,c,o)}},{key:"renderTextSku",value:function e(t,i){var n=r.Type.isStringFilled(t.NAME)?r.Text.encode(t.NAME):"-";return r.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<label \tclass="ui-ctl ui-ctl-radio-selector"\n\t\t\t\t\tonclick="','"\n\t\t\t\t\ttitle="','"\n\t\t\t\t\tdata-property-id="','"\n\t\t\t\t\tdata-property-value="','">\n\t\t\t\t<input type="radio"\n\t\t\t\t\tdisabled="','"\n\t\t\t\t\tname="property-',"-","-",'"\n\t\t\t\t\tclass="ui-ctl-element">\n\t\t\t\t<span class="ui-ctl-inner">\n\t\t\t\t\t<span class="ui-ctl-label-text">',"</span>\n\t\t\t\t</span>\n\t\t\t</label>\n\t\t"])),this.skuSelectHandler,n,this.getId(),t.ID,!this.parent.isSelectable(),this.getSelectedSkuId(),this.getId(),i,n)}},{key:"layout",value:function e(){if(!this.hasSkuValues()){return}this.skuList=this.renderProperties();this.toggleSkuPropertyValues();return r.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="product-item-detail-info-container">\n\t\t\t\t<div class="product-item-detail-info-container-title">','</div>\n\t\t\t\t<div class="product-item-scu-container">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),r.Text.encode(this.property.NAME),this.skuList)}},{key:"renderProperties",value:function e(){var t=this;var i=r.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['<div class="product-item-scu-list ui-ctl-spacing-right"></div>'])));this.property.VALUES.forEach((function(e){var n=e.ID;var s;var a=r.Text.getRandom();if(!n||t.existingValues.includes(n)){if(t.property.SHOW_MODE==="PICT"){r.Dom.addClass(i,"product-item-scu-list--pick-color");s=t.renderPictureSku(e,a)}else{r.Dom.addClass(i,"product-item-scu-list--pick-size");s=t.renderTextSku(e,a)}t.nodeDescriptions.push({propertyValueId:n,node:s});i.appendChild(s)}}));return i}},{key:"toggleSkuPropertyValues",value:function e(){var t=this;var i=this.parent.getSelectedSkuProperty(this.getId());var n=this.parent.getActiveSkuProperties(this.getId());this.nodeDescriptions.forEach((function(e){var s=r.Text.toNumber(e.propertyValueId);var a=e.node.querySelector('input[type="radio"]');if(i===s){a.checked=true;r.Dom.addClass(e.node,"selected")}else{a.checked=false;r.Dom.removeClass(e.node,"selected")}if(t.hideUnselected&&i!==s||!n.includes(e.propertyValueId)){r.Dom.style(e.node,{display:"none"})}else{r.Dom.style(e.node,{display:null})}}))}},{key:"handleSkuSelect",value:function e(t){var i=this;t.stopPropagation();var s=t.target.closest("[data-property-id]");if(!this.parent.isSelectable()||r.Dom.hasClass(s,"selected")){return}var a=r.Text.toNumber(s.getAttribute("data-property-id"));var l=r.Text.toNumber(s.getAttribute("data-property-value"));this.parent.setSelectedProperty(a,l);this.parent.getSelectedSku().then((function(e){n.EventEmitter.emit("SkuProperty::onChange",[e,i.property]);if(i.parent){i.parent.emit("SkuProperty::onChange",[e,i.property])}}));this.parent.toggleSkuProperties()}}]);return e}();var f;function h(e,t){var r=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=g(e))||t&&e&&typeof e.length==="number"){if(r)e=r;var i=0;var n=function e(){};return{s:n,n:function t(){if(i>=e.length)return{done:true};return{done:false,value:e[i++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s=true,a=false,l;return{s:function t(){r=r.call(e)},n:function e(){var t=r.next();s=t.done;return t},e:function e(t){a=true;l=t},f:function e(){try{if(!s&&r["return"]!=null)r["return"]()}finally{if(a)throw l}}}}function g(e,t){if(!e)return;if(typeof e==="string")return v(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return v(e,t)}function v(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,i=new Array(t);r<t;r++){i[r]=e[r]}return i}function k(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function y(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?k(Object(r),!0).forEach((function(t){babelHelpers.defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):k(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function b(e,t,r){S(e,t);return r}function S(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}var T=new Map;var I=new Map;var P=new Map;var m=function(e){babelHelpers.inherits(t,e);function t(e){var i;var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"selectedValues",{});n.setEventNamespace("BX.Catalog.SkuTree");n.id=r.Text.getRandom();n.skuTree=e.skuTree||{};n.productId=(i=n.skuTree)===null||i===void 0?void 0:i.PRODUCT_ID;n.skuTreeOffers=n.skuTree.OFFERS||[];if(!r.Type.isNil(e.skuTree.OFFERS_JSON)&&!r.Type.isArrayFilled(n.skuTreeOffers)){n.skuTreeOffers=JSON.parse(n.skuTree.OFFERS_JSON)}n.iblockId=n.skuTree.IBLOCK_ID||t.DEFAULT_IBLOCK_ID;if(!T.has(n.iblockId)){if(r.Type.isObject(n.skuTree.OFFERS_PROP)){T.set(n.iblockId,n.skuTree.OFFERS_PROP)}else{T.set(n.iblockId,{});var s=new Promise((function(e){r.ajax.runAction("catalog.skuTree.getIblockProperties",{json:{iblockId:n.iblockId}}).then((function(r){T.set(n.iblockId,r.data);e();P["delete"](b(t,t,E).call(t,n.iblockId))}))}));P.set(b(t,t,E).call(t,n.iblockId),s)}}n.selectable=e.selectable!==false;n.hideUnselected=e.hideUnselected===true;if(n.hasSku()){n.selectedValues=n.skuTree.SELECTED_VALUES||y({},n.skuTreeOffers[0].TREE)}n.existingValues=n.skuTree.EXISTING_VALUES||{};if(!r.Type.isNil(e.skuTree.EXISTING_VALUES_JSON)&&r.Type.isNil(e.skuTree.EXISTING_VALUES)){n.existingValues=JSON.parse(e.skuTree.EXISTING_VALUES_JSON)}for(var a in n.existingValues){if(n.existingValues[a].length===1&&n.existingValues[a][0]===0){delete n.existingValues[a]}}return n}babelHelpers.createClass(t,[{key:"getProperties",value:function e(){return T.get(this.iblockId)}},{key:"isSelectable",value:function e(){return this.selectable}},{key:"getSelectedValues",value:function e(){return this.selectedValues}},{key:"setSelectedProperty",value:function e(t,i){this.selectedValues[t]=r.Text.toNumber(i);var n=this.getRemainingProperties(t);if(n.length){var s=h(n),a;try{for(s.s();!(a=s.n()).done;){var l=a.value;var u=this.getFilterProperties(l);var o=this.filterSku(u);if(o.length){var c=false;var p=h(o),d;try{for(p.s();!(d=p.n()).done;){var f=d.value;if(f.TREE[l]===this.selectedValues[l]){c=true}}}catch(e){p.e(e)}finally{p.f()}if(!c){this.selectedValues[l]=o[0].TREE[l]}}}}catch(e){s.e(e)}finally{s.f()}}}},{key:"getRemainingProperties",value:function e(t){var r=[];var i=false;for(var n=0,s=Object.values(this.getProperties());n<s.length;n++){var a=s[n];if(a.ID===t){i=true}else if(i){r.push(a.ID)}}return r}},{key:"hasSku",value:function e(){return r.Type.isArrayFilled(this.skuTreeOffers)}},{key:"hasSkuProps",value:function e(){return Object.values(this.getProperties()).length>0}},{key:"getSelectedSkuId",value:function e(){var t=this;if(!this.hasSku()){return}var r=this.skuTreeOffers.filter((function(e){return JSON.stringify(e.TREE)===JSON.stringify(t.selectedValues)}))[0];return r===null||r===void 0?void 0:r.ID}},{key:"getSelectedSku",value:function e(){var i=this;return new Promise((function(e,n){var s=i.getSelectedSkuId();if(s<=0){n();return}if(I.has(s)){var a=I.get(s);e(a)}else{if(P.has(b(t,t,O).call(t,s))){P.get(b(t,t,O).call(t,s)).then((function(t){e(t)}))}else{var l=r.ajax.runAction("catalog.skuTree.getSku",{json:{skuId:s}}).then((function(r){var i=r.data;I.set(s,i);e(i);P["delete"](b(t,t,O).call(t,s),l)}));P.set(b(t,t,O).call(t,s),l)}}}))}},{key:"getActiveSkuProperties",value:function e(t){var r=[];var i=this.getFilterProperties(t);this.filterSku(i).forEach((function(e){if(!r.includes(e.TREE[t])){r.push(e.TREE[t])}}));return r}},{key:"getFilterProperties",value:function e(t){var r=[];for(var i=0,n=Object.values(this.getProperties());i<n.length;i++){var s=n[i];if(s.ID===t){break}r.push(s.ID)}return r}},{key:"filterSku",value:function e(t){if(t.length===0){return this.skuTreeOffers}var r=this.getSelectedValues();return this.skuTreeOffers.filter((function(e){var i=h(t),n;try{for(i.s();!(n=i.n()).done;){var s=n.value;if(e.TREE[s]!==r[s]){return false}}}catch(e){i.e(e)}finally{i.f()}return true}))}},{key:"getSelectedSkuProperty",value:function e(t){return r.Text.toNumber(this.selectedValues[t])}},{key:"layout",value:function e(){var i=this;var n=r.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['<div class="product-item-scu-wrapper" id="','"></div>'])),this.id);this.skuProperties=[];if(this.hasSku()){new Promise((function(e){if(P.has(b(t,t,E).call(t,i.iblockId))){P.get(b(t,t,E).call(t,i.iblockId)).then(e)}else{e()}})).then((function(){if(!i.hasSkuProps()){return}var e=i.getProperties();for(var t in e){if(e.hasOwnProperty(t)&&!r.Type.isNil(i.existingValues[t])){var s=new d({parent:i,property:e[t],existingValues:r.Type.isArray(i.existingValues[t])?i.existingValues[t]:Object.values(i.existingValues[t]),offers:i.skuTreeOffers,hideUnselected:i.hideUnselected});r.Dom.append(s.layout(),n);i.skuProperties.push(s)}}}))}return n}},{key:"toggleSkuProperties",value:function e(){this.skuProperties.forEach((function(e){return e.toggleSkuPropertyValues()}))}}]);return t}(n.EventEmitter);function E(e){return"IblockPropertiesRequest_"+e}function O(e){return"SkuFieldsRequest_"+e}babelHelpers.defineProperty(m,"DEFAULT_IBLOCK_ID",0);e.SkuTree=m})(this.BX.Catalog.SkuTree=this.BX.Catalog.SkuTree||{},BX,BX,BX.Catalog.SkuTree,BX.Event);
//# sourceMappingURL=sku-tree.bundle.map.js