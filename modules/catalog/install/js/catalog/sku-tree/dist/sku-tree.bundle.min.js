this.BX=this.BX||{};this.BX.Catalog=this.BX.Catalog||{};(function(e,t,r,i){"use strict";var n,s,a,l,u,o,c;var p=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"skuSelectHandler",this.handleSkuSelect.bind(this));this.parent=t.parent||null;if(!this.parent){throw new Error("Parent is not defined.")}this.property=t.property||{};this.offers=t.offers||[];this.existingValues=t.existingValues||[];this.nodeDescriptions=[];this.hideUnselected=t.hideUnselected}babelHelpers.createClass(e,[{key:"getId",value:function e(){return this.property.ID}},{key:"getSelectedSkuId",value:function e(){return this.parent.getSelectedSkuId()}},{key:"hasSkuValues",value:function e(){return this.property.VALUES.length}},{key:"renderPictureSku",value:function e(r,i){var u=t.Type.isStringFilled(r.NAME)?t.Text.encode(r.NAME):"";var o="";if(t.Type.isStringFilled(u)){o=t.Tag.render(n||(n=babelHelpers.taggedTemplateLiteral(['<span class="ui-ctl-label-text">',"</span>"])),u)}var c="";if(r.PICT&&r.PICT.SRC){var p="background-image: url('"+r.PICT.SRC+"');";c=t.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(['<span class="ui-ctl-label-img" style="','"></span>'])),p)}else if(o){o.style.paddingLeft="0"}else{o=t.Tag.render(a||(a=babelHelpers.taggedTemplateLiteral(['<span class="ui-ctl-label-text">-</span>'])))}return t.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<label \tclass="ui-ctl ui-ctl-radio-selector"\n\t\t\t\t\tonclick="','"\n\t\t\t\t\ttitle="','"\n\t\t\t\t\tdata-property-id="','"\n\t\t\t\t\tdata-property-value="','">\n\t\t\t\t<input type="radio"\n\t\t\t\t\tdisabled="','"\n\t\t\t\t\tname="property-',"-","-",'"\n\t\t\t\t\tclass="ui-ctl-element">\n\t\t\t\t<span class="ui-ctl-inner">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t</span>\n\t\t\t</label>\n\t\t"])),this.skuSelectHandler,u,this.getId(),r.ID,!this.parent.isSelectable(),this.getSelectedSkuId(),this.getId(),i,c,o)}},{key:"renderTextSku",value:function e(r,i){var n=t.Type.isStringFilled(r.NAME)?t.Text.encode(r.NAME):"-";return t.Tag.render(u||(u=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<label \tclass="ui-ctl ui-ctl-radio-selector"\n\t\t\t\t\tonclick="','"\n\t\t\t\t\ttitle="','"\n\t\t\t\t\tdata-property-id="','"\n\t\t\t\t\tdata-property-value="','">\n\t\t\t\t<input type="radio"\n\t\t\t\t\tdisabled="','"\n\t\t\t\t\tname="property-',"-","-",'"\n\t\t\t\t\tclass="ui-ctl-element">\n\t\t\t\t<span class="ui-ctl-inner">\n\t\t\t\t\t<span class="ui-ctl-label-text">',"</span>\n\t\t\t\t</span>\n\t\t\t</label>\n\t\t"])),this.skuSelectHandler,n,this.getId(),r.ID,!this.parent.isSelectable(),this.getSelectedSkuId(),this.getId(),i,n)}},{key:"layout",value:function e(){if(!this.hasSkuValues()){return}this.skuList=this.renderProperties();this.toggleSkuPropertyValues();return t.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="product-item-detail-info-container">\n\t\t\t\t<div class="product-item-detail-info-container-title">','</div>\n\t\t\t\t<div class="product-item-scu-container">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),t.Text.encode(this.property.NAME),this.skuList)}},{key:"renderProperties",value:function e(){var r=this;var i=t.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['<div class="product-item-scu-list ui-ctl-spacing-right"></div>'])));this.property.VALUES.forEach((function(e){var n=e.ID;var s;var a=t.Text.getRandom();if(!n||r.existingValues.includes(n)){if(r.property.SHOW_MODE==="PICT"){t.Dom.addClass(i,"product-item-scu-list--pick-color");s=r.renderPictureSku(e,a)}else{t.Dom.addClass(i,"product-item-scu-list--pick-size");s=r.renderTextSku(e,a)}r.nodeDescriptions.push({propertyValueId:n,node:s});i.appendChild(s)}}));return i}},{key:"toggleSkuPropertyValues",value:function e(){var r=this;var i=this.parent.getSelectedSkuProperty(this.getId());var n=this.parent.getActiveSkuProperties(this.getId());this.nodeDescriptions.forEach((function(e){var s=t.Text.toNumber(e.propertyValueId);var a=e.node.querySelector('input[type="radio"]');if(i===s){a.checked=true;t.Dom.addClass(e.node,"selected")}else{a.checked=false;t.Dom.removeClass(e.node,"selected")}if(r.hideUnselected&&i!==s||!n.includes(e.propertyValueId)){t.Dom.style(e.node,{display:"none"})}else{t.Dom.style(e.node,{display:null})}}))}},{key:"handleSkuSelect",value:function e(r){var n=this;r.stopPropagation();var s=r.target.closest("[data-property-id]");if(!this.parent.isSelectable()||t.Dom.hasClass(s,"selected")){return}var a=t.Text.toNumber(s.getAttribute("data-property-id"));var l=t.Text.toNumber(s.getAttribute("data-property-value"));var u=s.querySelector(".ui-ctl-inner");t.Dom.addClass(u,["ui-ctl-before","ui-ctl-icon-loader"]);this.parent.setSelectedProperty(a,l);this.parent.getSelectedSku().then((function(e){t.Dom.removeClass(u,["ui-ctl-before","ui-ctl-icon-loader"]);i.EventEmitter.emit("SkuProperty::onChange",[e,n.property]);if(n.parent){n.parent.emit("SkuProperty::onChange",[e,n.property])}}));this.parent.toggleSkuProperties()}}]);return e}();var d;function f(e,t){var r=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=h(e))||t&&e&&typeof e.length==="number"){if(r)e=r;var i=0;var n=function e(){};return{s:n,n:function t(){if(i>=e.length)return{done:true};return{done:false,value:e[i++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s=true,a=false,l;return{s:function t(){r=r.call(e)},n:function e(){var t=r.next();s=t.done;return t},e:function e(t){a=true;l=t},f:function e(){try{if(!s&&r["return"]!=null)r["return"]()}finally{if(a)throw l}}}}function h(e,t){if(!e)return;if(typeof e==="string")return v(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return v(e,t)}function v(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,i=new Array(t);r<t;r++){i[r]=e[r]}return i}function g(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function k(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?g(Object(r),!0).forEach((function(t){babelHelpers.defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):g(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function y(e,t,r){b(e,t);return r}function b(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}var S=new Map;var T=new Map;var m=new Map;var I=function(e){babelHelpers.inherits(r,e);function r(e){var i;var n;babelHelpers.classCallCheck(this,r);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(r).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"selectedValues",{});n.setEventNamespace("BX.Catalog.SkuTree");n.id=t.Text.getRandom();n.skuTree=e.skuTree||{};n.productId=(i=n.skuTree)===null||i===void 0?void 0:i.PRODUCT_ID;n.skuTreeOffers=n.skuTree.OFFERS||[];if(!t.Type.isNil(e.skuTree.OFFERS_JSON)&&!t.Type.isArrayFilled(n.skuTreeOffers)){n.skuTreeOffers=JSON.parse(n.skuTree.OFFERS_JSON)}n.iblockId=n.skuTree.IBLOCK_ID||r.DEFAULT_IBLOCK_ID;if(!S.has(n.iblockId)){if(t.Type.isObject(n.skuTree.OFFERS_PROP)){S.set(n.iblockId,n.skuTree.OFFERS_PROP)}else{S.set(n.iblockId,{});var s=new Promise((function(e){t.ajax.runAction("catalog.skuTree.getIblockProperties",{json:{iblockId:n.iblockId}}).then((function(t){S.set(n.iblockId,t.data);e();m["delete"](y(r,r,P).call(r,n.iblockId))}))}));m.set(y(r,r,P).call(r,n.iblockId),s)}}n.selectable=e.selectable!==false;n.hideUnselected=e.hideUnselected===true;if(n.hasSku()){n.selectedValues=n.skuTree.SELECTED_VALUES||k({},n.skuTreeOffers[0].TREE)}n.existingValues=n.skuTree.EXISTING_VALUES||{};if(!t.Type.isNil(e.skuTree.EXISTING_VALUES_JSON)&&t.Type.isNil(e.skuTree.EXISTING_VALUES)){n.existingValues=JSON.parse(e.skuTree.EXISTING_VALUES_JSON)}return n}babelHelpers.createClass(r,[{key:"getProperties",value:function e(){return S.get(this.iblockId)}},{key:"isSelectable",value:function e(){return this.selectable}},{key:"getSelectedValues",value:function e(){return this.selectedValues}},{key:"setSelectedProperty",value:function e(r,i){this.selectedValues[r]=t.Text.toNumber(i);var n=this.getRemainingProperties(r);if(n.length){var s=f(n),a;try{for(s.s();!(a=s.n()).done;){var l=a.value;var u=this.getFilterProperties(l);var o=this.filterSku(u);if(o.length){var c=false;var p=f(o),d;try{for(p.s();!(d=p.n()).done;){var h=d.value;if(h.TREE[l]===this.selectedValues[l]){c=true}}}catch(e){p.e(e)}finally{p.f()}if(!c){this.selectedValues[l]=o[0].TREE[l]}}}}catch(e){s.e(e)}finally{s.f()}}}},{key:"getRemainingProperties",value:function e(t){var r=[];var i=false;for(var n=0,s=Object.values(this.getProperties());n<s.length;n++){var a=s[n];if(a.ID===t){i=true}else if(i){r.push(a.ID)}}return r}},{key:"hasSku",value:function e(){return t.Type.isArrayFilled(this.skuTreeOffers)}},{key:"hasSkuProps",value:function e(){return Object.values(this.getProperties()).length>0}},{key:"getSelectedSkuId",value:function e(){var t=this;if(!this.hasSku()){return}var r=this.skuTreeOffers.filter((function(e){return JSON.stringify(e.TREE)===JSON.stringify(t.selectedValues)}))[0];return r===null||r===void 0?void 0:r.ID}},{key:"getSelectedSku",value:function e(){var i=this;return new Promise((function(e,n){var s=i.getSelectedSkuId();if(s<=0){n();return}if(T.has(s)){var a=T.get(s);e(a)}else{if(m.has(y(r,r,E).call(r,s))){m.get(y(r,r,E).call(r,s)).then((function(t){e(t)}))}else{var l=t.ajax.runAction("catalog.skuTree.getSku",{json:{skuId:s}}).then((function(t){var i=t.data;T.set(s,i);e(i);m["delete"](y(r,r,E).call(r,s),l)}));m.set(y(r,r,E).call(r,s),l)}}}))}},{key:"getActiveSkuProperties",value:function e(t){var r=[];var i=this.getFilterProperties(t);this.filterSku(i).forEach((function(e){if(!r.includes(e.TREE[t])){r.push(e.TREE[t])}}));return r}},{key:"getFilterProperties",value:function e(t){var r=[];for(var i=0,n=Object.values(this.getProperties());i<n.length;i++){var s=n[i];if(s.ID===t){break}r.push(s.ID)}return r}},{key:"filterSku",value:function e(t){if(t.length===0){return this.skuTreeOffers}var r=this.getSelectedValues();return this.skuTreeOffers.filter((function(e){var i=f(t),n;try{for(i.s();!(n=i.n()).done;){var s=n.value;if(e.TREE[s]!==r[s]){return false}}}catch(e){i.e(e)}finally{i.f()}return true}))}},{key:"getSelectedSkuProperty",value:function e(r){return t.Text.toNumber(this.selectedValues[r])}},{key:"layout",value:function e(){var i=this;var n=t.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['<div class="product-item-scu-wrapper" id="','"></div>'])),this.id);this.skuProperties=[];if(this.hasSku()){new Promise((function(e){if(m.has(y(r,r,P).call(r,i.iblockId))){m.get(y(r,r,P).call(r,i.iblockId)).then(e)}else{e()}})).then((function(){if(!i.hasSkuProps()){return}var e=i.getProperties();for(var r in e){if(e.hasOwnProperty(r)&&!t.Type.isNil(i.existingValues[r])){var s=new p({parent:i,property:e[r],existingValues:t.Type.isArray(i.existingValues[r])?i.existingValues[r]:Object.values(i.existingValues[r]),offers:i.skuTreeOffers,hideUnselected:i.hideUnselected});t.Dom.append(s.layout(),n);i.skuProperties.push(s)}}}))}return n}},{key:"toggleSkuProperties",value:function e(){this.skuProperties.forEach((function(e){return e.toggleSkuPropertyValues()}))}}]);return r}(i.EventEmitter);function P(e){return"IblockPropertiesRequest_"+e}function E(e){return"SkuFieldsRequest_"+e}babelHelpers.defineProperty(I,"DEFAULT_IBLOCK_ID",0);e.SkuTree=I})(this.BX.Catalog.SkuTree=this.BX.Catalog.SkuTree||{},BX,BX.Catalog.SkuTree,BX.Event);
//# sourceMappingURL=sku-tree.bundle.map.js