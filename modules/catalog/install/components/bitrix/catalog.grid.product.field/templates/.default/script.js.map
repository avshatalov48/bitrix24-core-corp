{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {Dom, Reflection, Type} from \"main.core\";\nimport type {BaseEvent} from \"main.core.events\";\nimport {EventEmitter} from \"main.core.events\";\nimport {ProductSelector} from 'catalog.product-selector';\n\nconst instances = new Map();\n\nclass ProductField\n{\n\tstatic EDIT_CLASS = 'catalog-grid-product-field-edit';\n\tstatic PRODUCT_MODE = 'product';\n\tstatic SKU_MODE = 'sku';\n\n\tonSelectEditHandler = this.onSelectEdit.bind(this);\n\tonCancelEditHandler = this.onCancelEdit.bind(this);\n\tonBeforeGridRequestHandler = this.onBeforeGridRequest.bind(this);\n\tonUnsubscribeEventsHandler = this.unsubscribeEvents.bind(this);\n\n\tstatic getById(id: string): ?ImageInput\n\t{\n\t\treturn instances.get(id) || null;\n\t}\n\n\tconstructor(id, settings = {})\n\t{\n\t\tthis.selector = new ProductSelector(id, settings);\n\t\tthis.componentName = settings.componentName || '';\n\t\tthis.signedParameters = settings.signedParameters || '';\n\t\tthis.rowIdMask = settings.rowIdMask || '#ID#';\n\n\t\tthis.subscribeEvents();\n\n\t\tinstances.set(id, this);\n\t}\n\n\tsubscribeEvents()\n\t{\n\t\tEventEmitter.subscribe('Grid::thereEditedRows', this.onSelectEditHandler);\n\t\tEventEmitter.subscribe('Grid::noEditedRows', this.onCancelEditHandler);\n\t\tEventEmitter.subscribe('Grid::beforeRequest', this.onBeforeGridRequestHandler);\n\t\tEventEmitter.subscribe('Grid::updated', this.onUnsubscribeEventsHandler);\n\t}\n\n\tunsubscribeEvents()\n\t{\n\t\tEventEmitter.unsubscribe('Grid::thereEditedRows', this.onSelectEditHandler);\n\t\tEventEmitter.unsubscribe('Grid::noEditedRows', this.onCancelEditHandler);\n\t\tEventEmitter.unsubscribe('Grid::beforeRequest', this.onBeforeGridRequestHandler);\n\t\tEventEmitter.unsubscribe('Grid::updated', this.onUnsubscribeEventsHandler);\n\t\tthis.selector.unsubscribeEvents();\n\t}\n\n\tgetSelector(): ProductSelector\n\t{\n\t\treturn this.selector;\n\t}\n\n\tonBeforeGridRequest(event: BaseEvent)\n\t{\n\t\tconst wrapper = this.getSelector().getWrapper();\n\t\tif (!wrapper)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst [, gridData] = event.getData();\n\t\tconst submitData = BX.prop.get(gridData, 'data', {});\n\t\tif (!submitData.FIELDS)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet productId = this.getSelector().getModel().getProductId();\n\t\tproductId = this.rowIdMask.replace('#ID#', productId);\n\n\t\tsubmitData.FIELDS[productId] = submitData.FIELDS[productId] || {};\n\n\t\tconst imageInputContainer = wrapper.querySelector('.ui-image-input-container');\n\t\tif (imageInputContainer)\n\t\t{\n\t\t\tconst inputs = imageInputContainer.querySelectorAll('input');\n\t\t\tconst values = {};\n\t\t\tconst newFilesRegExp = new RegExp(/([0-9A-Za-z_]+?(_n\\d+)*)\\[([A-Za-z_]+)\\]/);\n\t\t\tfor (let inputItem of inputs)\n\t\t\t{\n\t\t\t\tif (newFilesRegExp.test(inputItem.name))\n\t\t\t\t{\n\t\t\t\t\tlet [, fileCounter, code, fileSetting] = inputItem.name.match(newFilesRegExp);\n\t\t\t\t\tif (fileCounter && fileSetting)\n\t\t\t\t\t{\n\t\t\t\t\t\tvalues[fileCounter] = values[fileCounter] || {};\n\t\t\t\t\t\tvalues[fileCounter][fileSetting] = inputItem.value;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tvalues[inputItem.name] = inputItem.value;\n\t\t\t\t}\n\t\t\t}\n\t\t\tsubmitData.FIELDS[productId] = submitData.FIELDS[productId] || {};\n\t\t\tif (Object.keys(values).length > 0)\n\t\t\t{\n\t\t\t\tsubmitData.FIELDS[productId]['MORE_PHOTO'] = values;\n\t\t\t}\n\t\t}\n\n\t\tconst productNameInput = wrapper.querySelector('input[name=\"NAME\"]');\n\t\tif (productNameInput)\n\t\t{\n\t\t\tsubmitData.FIELDS[productId]['NAME'] = productNameInput.value;\n\t\t}\n\t}\n\n\tonCancelEdit()\n\t{\n\t\tthis.getSelector().setMode(BX.Catalog.ProductSelector.MODE_VIEW);\n\t\tthis.getSelector().clearLayout();\n\t\tthis.getSelector().layout();\n\n\t\tconst grid = BX.Main.gridManager.getInstanceById(this.getSelector().getConfig('GRID_ID'));\n\t\tif (!grid)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst row = grid.getRows().getById(this.selector.getConfig('ROW_ID'));\n\t\tif (!row)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst cell = row.getCellById('CATALOG_PRODUCT');\n\t\tif (cell)\n\t\t{\n\t\t\tDom.removeClass(row.getContentContainer(cell), ProductField.EDIT_CLASS);\n\t\t}\n\t}\n\n\tonSelectEdit()\n\t{\n\t\tif (!this.getSelector().getConfig('GRID_ID', null))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst grid = BX.Main.gridManager.getInstanceById(this.getSelector().getConfig('GRID_ID'));\n\t\tif (!grid)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst row = grid.getRows().getById(this.selector.getConfig('ROW_ID'));\n\t\tif (row && row.isEdit())\n\t\t{\n\t\t\tthis.getSelector().setMode(BX.Catalog.ProductSelector.MODE_EDIT);\n\t\t\tthis.getSelector().clearLayout();\n\t\t\tthis.getSelector().layout();\n\n\t\t\tconst cell = row.getCellById('CATALOG_PRODUCT');\n\t\t\tif (cell)\n\t\t\t{\n\t\t\t\tDom.addClass(row.getContentContainer(cell), ProductField.EDIT_CLASS);\n\t\t\t}\n\t\t}\n\t}\n}\n\nReflection.namespace('BX.Catalog.Grid').ProductField = ProductField;"],"names":["instances","Map","ProductField","id","get","settings","onSelectEdit","bind","onCancelEdit","onBeforeGridRequest","unsubscribeEvents","selector","ProductSelector","componentName","signedParameters","rowIdMask","subscribeEvents","set","EventEmitter","subscribe","onSelectEditHandler","onCancelEditHandler","onBeforeGridRequestHandler","onUnsubscribeEventsHandler","unsubscribe","event","wrapper","getSelector","getWrapper","getData","gridData","submitData","BX","prop","FIELDS","productId","getModel","getProductId","replace","imageInputContainer","querySelector","inputs","querySelectorAll","values","newFilesRegExp","RegExp","inputItem","test","name","match","fileCounter","code","fileSetting","value","Object","keys","length","productNameInput","setMode","Catalog","MODE_VIEW","clearLayout","layout","grid","Main","gridManager","getInstanceById","getConfig","row","getRows","getById","cell","getCellById","Dom","removeClass","getContentContainer","EDIT_CLASS","isEdit","MODE_EDIT","addClass","Reflection","namespace"],"mappings":"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"}