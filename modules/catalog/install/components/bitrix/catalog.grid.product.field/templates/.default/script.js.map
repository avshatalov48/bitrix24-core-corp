{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { Dom, Reflection } from 'main.core';\nimport type { BaseEvent } from 'main.core.events';\nimport { EventEmitter } from 'main.core.events';\nimport { ProductSelector } from 'catalog.product-selector';\n\nconst instances = new Map();\n\nclass ProductField\n{\n\tstatic EDIT_CLASS = 'catalog-grid-product-field-edit';\n\tstatic PRODUCT_MODE = 'product';\n\tstatic SKU_MODE = 'sku';\n\n\tonSelectEditHandler = this.onSelectEdit.bind(this);\n\tonCancelEditHandler = this.onCancelEdit.bind(this);\n\tonBeforeGridRequestHandler = this.onBeforeGridRequest.bind(this);\n\tonUnsubscribeEventsHandler = this.unsubscribeEvents.bind(this);\n\n\tstatic getById(id: string): ?ProductField\n\t{\n\t\treturn instances.get(id) || null;\n\t}\n\n\tconstructor(id, settings = {})\n\t{\n\t\tthis.selector = new ProductSelector(id, settings);\n\t\tthis.columnName = settings.columnName || 'CATALOG_PRODUCT';\n\t\tthis.componentName = settings.componentName || '';\n\t\tthis.signedParameters = settings.signedParameters || '';\n\t\tthis.rowIdMask = settings.rowIdMask || '#ID#';\n\n\t\tthis.subscribeEvents();\n\n\t\tinstances.set(id, this);\n\t}\n\n\tsubscribeEvents()\n\t{\n\t\tEventEmitter.incrementMaxListeners('Grid::thereEditedRows', 1);\n\t\tEventEmitter.incrementMaxListeners('Grid::noEditedRows', 1);\n\t\tEventEmitter.incrementMaxListeners('Grid::beforeRequest', 1);\n\t\tEventEmitter.incrementMaxListeners('Grid::updated', 1);\n\n\t\tEventEmitter.subscribe('Grid::thereEditedRows', this.onSelectEditHandler);\n\t\tEventEmitter.subscribe('Grid::noEditedRows', this.onCancelEditHandler);\n\t\tEventEmitter.subscribe('Grid::beforeRequest', this.onBeforeGridRequestHandler);\n\t\tEventEmitter.subscribe('Grid::updated', this.onUnsubscribeEventsHandler);\n\t\tEventEmitter.subscribeOnce(this.selector, 'onBeforeChange', this.onUnsubscribeEventsHandler);\n\t}\n\n\tunsubscribeEvents()\n\t{\n\t\tEventEmitter.unsubscribe('Grid::thereEditedRows', this.onSelectEditHandler);\n\t\tEventEmitter.unsubscribe('Grid::noEditedRows', this.onCancelEditHandler);\n\t\tEventEmitter.unsubscribe('Grid::beforeRequest', this.onBeforeGridRequestHandler);\n\t\tEventEmitter.unsubscribe('Grid::updated', this.onUnsubscribeEventsHandler);\n\t\tthis.selector.unsubscribeEvents();\n\t}\n\n\tgetSelector(): ProductSelector\n\t{\n\t\treturn this.selector;\n\t}\n\n\tonBeforeGridRequest(event: BaseEvent)\n\t{\n\t\tconst wrapper = this.getSelector().getWrapper();\n\t\tif (!wrapper)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst [, gridData] = event.getData();\n\t\tconst submitData = BX.prop.get(gridData, 'data', {});\n\t\tif (!submitData.FIELDS)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet productId = this.getSelector().getModel().getProductId();\n\t\tproductId = this.rowIdMask.replace('#ID#', productId);\n\n\t\tsubmitData.FIELDS[productId] = submitData.FIELDS[productId] || {};\n\n\t\tconst imageInputContainer = wrapper.querySelector('.ui-image-input-container');\n\t\tif (imageInputContainer)\n\t\t{\n\t\t\tconst inputs = imageInputContainer.querySelectorAll('input');\n\t\t\tconst values = {};\n\t\t\tconst newFilesRegExp = new RegExp(/([0-9A-Za-z_]+?(_n\\d+)*)\\[([A-Za-z_]+)\\]/);\n\t\t\tfor (let inputItem of inputs)\n\t\t\t{\n\t\t\t\tif (newFilesRegExp.test(inputItem.name))\n\t\t\t\t{\n\t\t\t\t\tlet [, fileCounter, code, fileSetting] = inputItem.name.match(newFilesRegExp);\n\t\t\t\t\tif (fileCounter && fileSetting)\n\t\t\t\t\t{\n\t\t\t\t\t\tvalues[fileCounter] = values[fileCounter] || {};\n\t\t\t\t\t\tvalues[fileCounter][fileSetting] = inputItem.value;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tvalues[inputItem.name] = inputItem.value;\n\t\t\t\t}\n\t\t\t}\n\t\t\tsubmitData.FIELDS[productId] = submitData.FIELDS[productId] || {};\n\t\t\tif (Object.keys(values).length > 0)\n\t\t\t{\n\t\t\t\tsubmitData.FIELDS[productId]['MORE_PHOTO'] = values;\n\t\t\t}\n\t\t}\n\n\t\tconst productNameInput = wrapper.querySelector('input[name=\"NAME\"]');\n\t\tif (productNameInput)\n\t\t{\n\t\t\tsubmitData.FIELDS[productId]['NAME'] = productNameInput.value;\n\t\t}\n\t}\n\n\tonCancelEdit()\n\t{\n\t\tthis.getSelector().setMode(BX.Catalog.ProductSelector.MODE_VIEW);\n\t\tthis.getSelector().clearLayout();\n\t\tthis.getSelector().layout();\n\n\t\tconst grid = BX.Main.gridManager.getInstanceById(this.getSelector().getConfig('GRID_ID'));\n\t\tif (!grid)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst row = grid.getRows().getById(this.selector.getConfig('ROW_ID'));\n\t\tif (!row)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst cell = row.getCellById(this.columnName);\n\t\tif (cell)\n\t\t{\n\t\t\tDom.removeClass(row.getContentContainer(cell), ProductField.EDIT_CLASS);\n\t\t}\n\t}\n\n\tonSelectEdit()\n\t{\n\t\tif (!this.getSelector().getConfig('GRID_ID', null))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst grid = BX.Main.gridManager.getInstanceById(this.getSelector().getConfig('GRID_ID'));\n\t\tif (!grid)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst row = grid.getRows().getById(this.selector.getConfig('ROW_ID'));\n\t\tif (row && row.isEdit())\n\t\t{\n\t\t\tthis.getSelector().setMode(BX.Catalog.ProductSelector.MODE_EDIT);\n\t\t\tthis.getSelector().clearLayout();\n\t\t\tthis.getSelector().layout();\n\n\t\t\tconst cell = row.getCellById(this.columnName);\n\t\t\tif (cell)\n\t\t\t{\n\t\t\t\tDom.addClass(row.getContentContainer(cell), ProductField.EDIT_CLASS);\n\t\t\t}\n\t\t}\n\t}\n}\n\nReflection.namespace('BX.Catalog.Grid').ProductField = ProductField;\n"],"names":["instances","Map","ProductField","id","get","settings","onSelectEdit","bind","onCancelEdit","onBeforeGridRequest","unsubscribeEvents","selector","ProductSelector","columnName","componentName","signedParameters","rowIdMask","subscribeEvents","set","EventEmitter","incrementMaxListeners","subscribe","onSelectEditHandler","onCancelEditHandler","onBeforeGridRequestHandler","onUnsubscribeEventsHandler","subscribeOnce","unsubscribe","event","wrapper","getSelector","getWrapper","getData","gridData","submitData","BX","prop","FIELDS","productId","getModel","getProductId","replace","imageInputContainer","querySelector","inputs","querySelectorAll","values","newFilesRegExp","RegExp","inputItem","test","name","match","fileCounter","code","fileSetting","value","Object","keys","length","productNameInput","setMode","Catalog","MODE_VIEW","clearLayout","layout","grid","Main","gridManager","getInstanceById","getConfig","row","getRows","getById","cell","getCellById","Dom","removeClass","getContentContainer","EDIT_CLASS","isEdit","MODE_EDIT","addClass","Reflection","namespace"],"mappings":"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"}