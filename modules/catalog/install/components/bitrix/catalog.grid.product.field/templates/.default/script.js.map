{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {Dom, Reflection, Type} from \"main.core\";\nimport type {BaseEvent} from \"main.core.events\";\nimport {EventEmitter} from \"main.core.events\";\nimport {ProductSelector} from 'catalog.product-selector';\n\nconst instances = new Map();\n\nclass ProductField\n{\n\tstatic EDIT_CLASS = 'catalog-grid-product-field-edit';\n\tstatic PRODUCT_MODE = 'product';\n\tstatic SKU_MODE = 'sku';\n\n\tonSelectEditHandler = this.onSelectEdit.bind(this);\n\tonCancelEditHandler = this.onCancelEdit.bind(this);\n\tonBeforeGridRequestHandler = this.onBeforeGridRequest.bind(this);\n\tonUnsubscribeEventsHandler = this.unsubscribeEvents.bind(this);\n\n\tstatic getById(id: string): ?ImageInput\n\t{\n\t\treturn instances.get(id) || null;\n\t}\n\n\tconstructor(id, settings = {})\n\t{\n\t\tthis.selector = new ProductSelector(id, settings);\n\t\tthis.componentName = settings.componentName || '';\n\t\tthis.signedParameters = settings.signedParameters || '';\n\t\tthis.rowIdMask = settings.rowIdMask || '#ID#';\n\n\t\tthis.subscribeEvents();\n\n\t\tinstances.set(id, this);\n\t}\n\n\tsubscribeEvents()\n\t{\n\t\tEventEmitter.subscribe('Grid::thereEditedRows', this.onSelectEditHandler);\n\t\tEventEmitter.subscribe('Grid::noEditedRows', this.onCancelEditHandler);\n\t\tEventEmitter.subscribe('Grid::beforeRequest', this.onBeforeGridRequestHandler);\n\t\tEventEmitter.subscribe('Grid::updated', this.onUnsubscribeEventsHandler);\n\t}\n\n\tunsubscribeEvents()\n\t{\n\t\tEventEmitter.unsubscribe('Grid::thereEditedRows', this.onSelectEditHandler);\n\t\tEventEmitter.unsubscribe('Grid::noEditedRows', this.onCancelEditHandler);\n\t\tEventEmitter.unsubscribe('Grid::beforeRequest', this.onBeforeGridRequestHandler);\n\t\tEventEmitter.unsubscribe('Grid::updated', this.onUnsubscribeEventsHandler);\n\t\tthis.selector.unsubscribeEvents();\n\t}\n\n\tgetSelector(): ProductSelector\n\t{\n\t\treturn this.selector;\n\t}\n\n\tonBeforeGridRequest(event: BaseEvent)\n\t{\n\t\tconst wrapper = this.getSelector().getWrapper();\n\t\tif (!wrapper)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst [, gridData] = event.getData();\n\t\tconst submitData = BX.prop.get(gridData, 'data', {});\n\t\tif (!submitData.FIELDS)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet productId = this.getSelector().getModel().getProductId();\n\t\tproductId = this.rowIdMask.replace('#ID#', productId);\n\n\t\tsubmitData.FIELDS[productId] = submitData.FIELDS[productId] || {};\n\n\t\tconst imageInputContainer = wrapper.querySelector('.ui-image-input-container');\n\t\tif (imageInputContainer)\n\t\t{\n\t\t\tconst inputs = imageInputContainer.querySelectorAll('input');\n\t\t\tconst values = {};\n\t\t\tconst newFilesRegExp = new RegExp(/([0-9A-Za-z_]+?(_n\\d+)*)\\[([A-Za-z_]+)\\]/);\n\t\t\tfor (let inputItem of inputs)\n\t\t\t{\n\t\t\t\tif (newFilesRegExp.test(inputItem.name))\n\t\t\t\t{\n\t\t\t\t\tlet [, fileCounter, code, fileSetting] = inputItem.name.match(newFilesRegExp);\n\t\t\t\t\tif (fileCounter && fileSetting)\n\t\t\t\t\t{\n\t\t\t\t\t\tvalues[fileCounter] = values[fileCounter] || {};\n\t\t\t\t\t\tvalues[fileCounter][fileSetting] = inputItem.value;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tvalues[inputItem.name] = inputItem.value;\n\t\t\t\t}\n\t\t\t}\n\t\t\tsubmitData.FIELDS[productId] = submitData.FIELDS[productId] || {};\n\t\t\tif (Object.keys(values).length > 0)\n\t\t\t{\n\t\t\t\tsubmitData.FIELDS[productId]['MORE_PHOTO'] = values;\n\t\t\t}\n\t\t}\n\n\t\tconst productNameInput = wrapper.querySelector('input[name=\"NAME\"]');\n\t\tif (productNameInput)\n\t\t{\n\t\t\tsubmitData.FIELDS[productId]['NAME'] = productNameInput.value;\n\t\t}\n\t}\n\n\tonCancelEdit()\n\t{\n\t\tthis.getSelector().setMode(BX.Catalog.ProductSelector.MODE_VIEW);\n\t\tthis.getSelector().clearLayout();\n\t\tthis.getSelector().layout();\n\n\t\tconst grid = BX.Main.gridManager.getInstanceById(this.getSelector().getConfig('GRID_ID'));\n\t\tif (!grid)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst row = grid.getRows().getById(this.selector.getConfig('ROW_ID'));\n\t\tif (!row)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst cell = row.getCellById('CATALOG_PRODUCT');\n\t\tif (cell)\n\t\t{\n\t\t\tDom.removeClass(row.getContentContainer(cell), ProductField.EDIT_CLASS);\n\t\t}\n\t}\n\n\tonSelectEdit()\n\t{\n\t\tif (!this.getSelector().getConfig('GRID_ID', null))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst grid = BX.Main.gridManager.getInstanceById(this.getSelector().getConfig('GRID_ID'));\n\t\tif (!grid)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst row = grid.getRows().getById(this.selector.getConfig('ROW_ID'));\n\t\tif (row && row.isEdit())\n\t\t{\n\t\t\tthis.getSelector().setMode(BX.Catalog.ProductSelector.MODE_EDIT);\n\t\t\tthis.getSelector().clearLayout();\n\t\t\tthis.getSelector().layout();\n\n\t\t\tconst cell = row.getCellById('CATALOG_PRODUCT');\n\t\t\tif (cell)\n\t\t\t{\n\t\t\t\tDom.addClass(row.getContentContainer(cell), ProductField.EDIT_CLASS);\n\t\t\t}\n\t\t}\n\t}\n}\n\nReflection.namespace('BX.Catalog.Grid').ProductField = ProductField;"],"names":["instances","Map","ProductField","id","get","settings","onSelectEdit","bind","onCancelEdit","onBeforeGridRequest","unsubscribeEvents","selector","ProductSelector","componentName","signedParameters","rowIdMask","subscribeEvents","set","EventEmitter","subscribe","onSelectEditHandler","onCancelEditHandler","onBeforeGridRequestHandler","onUnsubscribeEventsHandler","unsubscribe","event","wrapper","getSelector","getWrapper","getData","gridData","submitData","BX","prop","FIELDS","productId","getModel","getProductId","replace","imageInputContainer","querySelector","inputs","querySelectorAll","values","newFilesRegExp","RegExp","inputItem","test","name","match","fileCounter","code","fileSetting","value","Object","keys","length","productNameInput","setMode","Catalog","MODE_VIEW","clearLayout","layout","grid","Main","gridManager","getInstanceById","getConfig","row","getRows","getById","cell","getCellById","Dom","removeClass","getContentContainer","EDIT_CLASS","isEdit","MODE_EDIT","addClass","Reflection","namespace"],"mappings":"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"}