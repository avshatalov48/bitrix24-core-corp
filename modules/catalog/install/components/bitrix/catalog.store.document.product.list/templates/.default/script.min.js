this.BX=this.BX||{};this.BX.Catalog=this.BX.Catalog||{};this.BX.Catalog.Store=this.BX.Catalog.Store||{};(function(e,t,i,r,n,a,o,s,l,u){"use strict";l=l&&l.hasOwnProperty("default")?l["default"]:l;var d;var c=function(){function e(t){babelHelpers.classCallCheck(this,e);this.editor=t}babelHelpers.createClass(e,[{key:"load",value:function e(t,i){if(!this.hintPopup){this.hintPopup=new r.Popup("ui-hint-popup-"+this.editor.getId(),null,{darkMode:true,closeIcon:true,animation:"fading-slide"})}this.hintPopup.setBindElement(t);this.hintPopup.adjustPosition();this.hintPopup.setContent(n.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div class='ui-hint-content'>","</div>\n\t\t"])),n.Text.encode(i)));return this.hintPopup}},{key:"show",value:function e(){if(this.hintPopup){this.hintPopup.show()}}},{key:"close",value:function e(){if(this.hintPopup){this.hintPopup.close()}}}]);return e}();function h(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function g(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?h(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):h(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function f(e,t,i){v(e,t);t.set(e,i)}function v(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var p=new WeakMap;var y=function(){function e(t){babelHelpers.classCallCheck(this,e);f(this,p,{writable:true,value:{basePrice:0,finalPrice:0,extra:null,extraType:e.EXTRA_TYPE_PERCENTAGE}});babelHelpers.classPrivateFieldSet(this,p,g(g({},babelHelpers.classPrivateFieldGet(this,p)),t))}babelHelpers.createClass(e,[{key:"getBasePrice",value:function e(){return babelHelpers.classPrivateFieldGet(this,p).basePrice}},{key:"getFinalPrice",value:function e(){return babelHelpers.classPrivateFieldGet(this,p).finalPrice}},{key:"getExtra",value:function e(){return babelHelpers.classPrivateFieldGet(this,p).extra}},{key:"getExtraType",value:function e(){return babelHelpers.classPrivateFieldGet(this,p).extraType}},{key:"calculateBasePrice",value:function t(i){babelHelpers.classPrivateFieldGet(this,p).basePrice=i;babelHelpers.classPrivateFieldGet(this,p).extra=n.Text.toNumber(babelHelpers.classPrivateFieldGet(this,p).extra);if(babelHelpers.classPrivateFieldGet(this,p).extraType===e.EXTRA_TYPE_MONETARY){babelHelpers.classPrivateFieldGet(this,p).finalPrice=babelHelpers.classPrivateFieldGet(this,p).basePrice+babelHelpers.classPrivateFieldGet(this,p).extra}else{babelHelpers.classPrivateFieldGet(this,p).finalPrice=babelHelpers.classPrivateFieldGet(this,p).basePrice*(1+babelHelpers.classPrivateFieldGet(this,p).extra/100)}return this}},{key:"calculateFinalPrice",value:function t(i){babelHelpers.classPrivateFieldGet(this,p).finalPrice=i;var r=n.Text.toNumber(babelHelpers.classPrivateFieldGet(this,p).basePrice);if(r<=0){babelHelpers.classPrivateFieldGet(this,p).extraType=e.EXTRA_TYPE_MONETARY}if(babelHelpers.classPrivateFieldGet(this,p).extraType===e.EXTRA_TYPE_MONETARY){babelHelpers.classPrivateFieldGet(this,p).extra=babelHelpers.classPrivateFieldGet(this,p).finalPrice-r}else{babelHelpers.classPrivateFieldGet(this,p).extra=(babelHelpers.classPrivateFieldGet(this,p).finalPrice/r-1)*100}return this}},{key:"calculateExtra",value:function e(t){babelHelpers.classPrivateFieldGet(this,p).extra=t;if(n.Type.isNil(t)){return this}return this.calculateBasePrice(babelHelpers.classPrivateFieldGet(this,p).basePrice)}},{key:"calculateExtraType",value:function t(i){if(i!==e.EXTRA_TYPE_MONETARY){i=e.EXTRA_TYPE_PERCENTAGE}babelHelpers.classPrivateFieldGet(this,p).extraType=i;return this.calculateFinalPrice(babelHelpers.classPrivateFieldGet(this,p).finalPrice)}}]);return e}();babelHelpers.defineProperty(y,"EXTRA_TYPE_PERCENTAGE",1);babelHelpers.defineProperty(y,"EXTRA_TYPE_MONETARY",2);var E,b,m;function P(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=S(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var r=0;var n=function e(){};return{s:n,n:function t(){if(r>=e.length)return{done:true};return{done:false,value:e[r++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,o=false,s;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();a=t.done;return t},e:function e(t){o=true;s=t},f:function e(){try{if(!a&&i["return"]!=null)i["return"]()}finally{if(o)throw s}}}}function S(e,t){if(!e)return;if(typeof e==="string")return C(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return C(e,t)}function C(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,r=new Array(t);i<t;i++){r[i]=e[i]}return r}function T(e,t){I(e,t);t.add(e)}function I(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function A(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var k="EDIT";var F="SET";var R=2;var _=new WeakSet;var w=new WeakSet;var N=new WeakSet;var O=new WeakSet;var D=new WeakSet;var B=new WeakSet;var H=new WeakSet;var M=new WeakSet;var U=new WeakSet;var G=new WeakSet;var L=new WeakSet;var x=new WeakSet;var V=new WeakSet;var X=function(){function e(t,i,r,a){babelHelpers.classCallCheck(this,e);T(this,V);T(this,x);T(this,L);T(this,G);T(this,U);T(this,M);T(this,H);T(this,B);T(this,D);T(this,O);T(this,N);T(this,w);T(this,_);babelHelpers.defineProperty(this,"fields",{});babelHelpers.defineProperty(this,"storeSelectors",[]);babelHelpers.defineProperty(this,"externalActions",[]);babelHelpers.defineProperty(this,"cache",new n.Cache.MemoryCache);babelHelpers.defineProperty(this,"modeChanges",{EDIT:k,SET:F});babelHelpers.defineProperty(this,"validatingFields",new Map);this.setId(t);this.setSettings(r);this.setEditor(a);this.setModel(i,r);this.initFields(i);A(this,w,q).call(this);A(this,N,W).call(this);A(this,D,Y).call(this,this.getSettingValue("storeHeaderMap",{}));A(this,_,j).call(this);requestAnimationFrame(this.initHandlers.bind(this))}babelHelpers.createClass(e,[{key:"getNode",value:function e(){var t=this;return this.cache.remember("node",(function(){var e=t.getField("ID",0);return t.getEditorContainer().querySelector('[data-id="'+e+'"]')}))}},{key:"getSelector",value:function e(){return this.mainSelector}},{key:"getBarcodeSelector",value:function e(){return this.barcodeSelector}},{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"getSettings",value:function e(){return this.settings}},{key:"setSettings",value:function e(t){this.settings=n.Type.isPlainObject(t)?t:{}}},{key:"getSettingValue",value:function e(t,i){return this.settings.hasOwnProperty(t)?this.settings[t]:i}},{key:"setSettingValue",value:function e(t,i){this.settings[t]=i}},{key:"setEditor",value:function e(t){this.editor=t}},{key:"getEditor",value:function e(){return this.editor}},{key:"getEditorContainer",value:function e(){return this.getEditor().getContainer()}},{key:"getHintPopup",value:function e(){return this.getEditor().getHintPopup()}},{key:"initHandlers",value:function e(){var t=this.getEditor();this.getNode().querySelectorAll("input").forEach((function(e){n.Event.bind(e,"input",t.changeProductFieldHandler);n.Event.bind(e,"change",t.changeProductFieldHandler);n.Event.bind(e,"mousedown",(function(e){return e.stopPropagation()}))}));this.getNode().querySelectorAll("select").forEach((function(e){n.Event.bind(e,"change",t.changeProductFieldHandler);n.Event.bind(e,"mousedown",(function(e){return e.stopPropagation()}))}))}},{key:"initHandlersForSelectors",value:function e(){var t=this;var i=this.getEditor();var r=["MAIN_INFO","BARCODE_INFO"];var a=this.getSettingValue("storeHeaderMap",{});r=[].concat(babelHelpers.toConsumableArray(r),babelHelpers.toConsumableArray(Object.keys(a)));r.forEach((function(e){t.getNode().querySelectorAll('[data-name="'+e+'"] input[type="text"]').forEach((function(e){n.Event.bind(e,"input",i.changeProductFieldHandler);n.Event.bind(e,"change",i.changeProductFieldHandler);n.Event.bind(e,"mousedown",(function(e){return e.stopPropagation()}))}))}))}},{key:"setRowNumber",value:function e(t){this.getNode().querySelectorAll(".main-grid-row-number").forEach((function(e){e.textContent=t+"."}))}},{key:"getFields",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var i;if(!n.Type.isArrayFilled(t)){i=n.Runtime.clone(this.fields)}else{i={};var r=P(t),a;try{for(r.s();!(a=r.n()).done;){var o=a.value;i[o]=this.getField(o)}}catch(e){r.e(e)}finally{r.f()}}return i}},{key:"initFields",value:function e(t){this.getModel().initFields(t,false);this.setFields(t)}},{key:"setFields",value:function e(t){for(var i in t){if(t.hasOwnProperty(i)){this.setField(i,t[i])}}}},{key:"getField",value:function e(t,i){return this.fields.hasOwnProperty(t)?this.fields[t]:i}},{key:"setField",value:function e(t,i){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;this.fields[t]=i;if(r){this.getModel().setField(t,i)}}},{key:"getUiFieldId",value:function e(t){return this.getId()+"_"+t}},{key:"getBasePrice",value:function e(){return this.getField("BASE_PRICE",0)}},{key:"getAmount",value:function e(){return this.getField("AMOUNT",1)}},{key:"updateFieldByEvent",value:function e(t,i){var r=i.target;var n=r.type==="checkbox"?r.checked:r.value;var a=i.type==="input"||i.type==="change"?k:F;this.updateField(t,n,a)}},{key:"updateDropdownField",value:function e(t,i){this.updateField(t,i,k)}},{key:"updateField",value:function e(t,i){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:F;this.resetExternalActions();this.updateFieldValue(t,i,r);this.executeExternalActions()}},{key:"updateFieldValue",value:function e(t,i){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:F;switch(t){case"SKU_ID":this.changeProductId(i);break;case"BASE_PRICE":this.changeBasePrice(i,r);break;case"PURCHASING_PRICE":this.changePurchasingPrice(i,r);break;case"AMOUNT":this.changeAmount(i,r);break;case"MEASURE_CODE":this.changeMeasureCode(i,r);break;case"BARCODE":this.changeBarcode(i,r);break;case"STORE_FROM":case"STORE_TO":this.changeStore(i,t);break;case"STORE_FROM_TITLE":case"STORE_TO_TITLE":this.changeStoreName(i,t);break;case"NAME":case"MAIN_INFO":this.changeProductName(i,r);break;case"SORT":this.changeSort(i,r);break}}},{key:"updateFieldByName",value:function e(t,i){switch(t){case"TAX_INCLUDED":this.setTaxIncluded(i);break}}},{key:"changeProductId",value:function e(t){var i=this.parseInt(t);this.setProductId(i)}},{key:"handleCopyAction",value:function e(t,i){var r;(r=this.getEditor())===null||r===void 0?void 0:r.copyRow(this);var n=i.getMenuWindow();if(n){n.destroy()}}},{key:"handleDeleteAction",value:function e(t,i){var r;(r=this.getEditor())===null||r===void 0?void 0:r.deleteRow(this);var n=i.getMenuWindow();if(n){n.destroy()}this.unsubscribeEvents();A(this,M,z).call(this)}},{key:"unsubscribeEvents",value:function e(){this.getBarcodeSelector().unsubscribeEvents()}},{key:"handleSelectExtraPriceType",value:function e(t,i){this.changeExtraType(i.type,k);var r=i.getMenuWindow();if(r){r.destroy()}}},{key:"changeExtraType",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:F;var r="%";if(t===y.EXTRA_TYPE_MONETARY){r=this.getEditor().getCurrencyText()}else{t=y.EXTRA_TYPE_PERCENTAGE}if(t===this.getField("BASE_PRICE_EXTRA_RATE")){return}if(i===k){var a=A(this,H,Q).call(this).calculateExtraType(t);this.changeExtra(a.getExtra());this.changeBasePrice(a.getFinalPrice())}var o=this.getNode().querySelector('[data-name="BASE_PRICE_EXTRA_RATE"]');if(n.Type.isDomNode(o)){o.innerHTML=r}this.setField("BASE_PRICE_EXTRA_RATE",t)}},{key:"changeExtra",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:F;var r=n.Type.isNil(t)||t===""?null:this.parseFloat(t,this.getPricePrecision());this.setField("BASE_PRICE_EXTRA",r);if(r===null){return}if(i===k){var a=A(this,H,Q).call(this).calculateExtra(r);this.changeBasePrice(a.getFinalPrice())}else{var o=this.getNode().querySelector('[data-name="BASE_PRICE_EXTRA"]');if(n.Type.isDomNode(o)){o.value=r}}}},{key:"changeBasePrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:F;var r=this.parseFloat(t,this.getPricePrecision());this.setBasePrice(r,i)}},{key:"changePurchasingPrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:F;var r=this.parseFloat(t,this.getPricePrecision());this.setPurchasingPrice(r,i)}},{key:"changeAmount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:F;var r=this.parseFloat(t,this.getQuantityPrecision());this.setAmount(r,i)}},{key:"changeMeasureCode",value:function e(t){var i=this;var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:F;this.getEditor().getMeasures().filter((function(e){return e.CODE===t})).forEach((function(e){return i.setMeasure(e,r)}))}},{key:"changeBarcode",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:F;var r=t.toString();var n=this.getField("BARCODE")!==r;if(n&&i===F){this.setField("BARCODE",r);this.setField("DOC_BARCODE",r);this.addActionProductChange()}else if(i===k){this.setField("DOC_BARCODE",r);this.addActionProductChange()}}},{key:"changeStore",value:function e(t,i){var r=n.Text.toNumber(t);var a=this.getField(i)!==r;if(a){this.setField(i,r);this.setStoreAmount(t,i);this.addActionProductChange()}}},{key:"changeStoreName",value:function e(t,i){var r=t.toString();this.setField(i,r);this.addActionProductChange()}},{key:"changeProductName",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:F;var r=t.toString();var n=this.getField("NAME")!==r;if(n&&i===F){this.setField("NAME",r);this.addActionProductChange()}}},{key:"changeSort",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:F;var r=this.parseInt(t);if(i===F){this.setField("SORT",r)}var n=this.getField("SORT")!==r;if(n){this.addActionProductChange()}}},{key:"refreshFieldsLayout",value:function e(){var t,i,r;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];for(var a in this.fields){if(this.fields.hasOwnProperty(a)&&!n.includes(a)){this.updateUiField(a,this.fields[a])}}this.updateUiMeasure(this.getField("MEASURE_CODE"),this.getField("MEASURE_NAME"));(t=this.getSelector())===null||t===void 0?void 0:t.reloadFileInput();(i=this.getSelector())===null||i===void 0?void 0:i.layout();(r=this.getBarcodeSelector())===null||r===void 0?void 0:r.layout();this.updateUiStoreValues()}},{key:"setModel",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i="catalog_document_grid_"+this.getId();if(i){var r=u.ProductModel.getById(i);if(r){this.model=r}}if(!(this.model instanceof u.ProductModel)){this.model=new u.ProductModel({id:i,currency:this.getEditor().getCurrencyId(),iblockId:t["IBLOCK_ID"],basePriceId:t["BASE_PRICE_ID"],skuTree:n.Type.isStringFilled(t["SKU_TREE"])?JSON.parse(t["SKU_TREE"]):null,storeMap:t["STORE_AMOUNT_MAP"],fields:t});if(n.Type.isObject(t["IMAGE_INFO"])){this.model.getImageCollection().setPreview(t["IMAGE_INFO"]["preview"]);this.model.getImageCollection().setEditInput(t["IMAGE_INFO"]["input"]);this.model.getImageCollection().setMorePhotoValues(t["IMAGE_INFO"]["values"])}if(!n.Type.isNil(t["DETAIL_URL"])){this.model.setDetailPath(t["DETAIL_URL"])}}a.EventEmitter.subscribe(this.model,"onErrorsChange",n.Runtime.debounce(A(this,M,z),500,this));a.EventEmitter.subscribe(this.model,"onChangeStoreData",this.updateUiStoreValues.bind(this))}},{key:"getModel",value:function e(){return this.model}},{key:"setProductId",value:function e(t){var i=this.getField("PRODUCT_ID")!==t;if(i){this.setField("PRODUCT_ID",t);this.setField("SKU_ID",t);this.updateUiStoreValues();this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setBasePrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:F;t=Math.max(t,0);if(i===F){this.updateUiField("BASE_PRICE",t.toFixed(this.getPricePrecision()))}this.setField("BASE_PRICE",t);this.addActionProductChange();this.addActionUpdateTotal()}},{key:"updateProductStoreValues",value:function e(){var t=this;this.storeSelectors.forEach((function(e){e.setProductId(t.getModel().getSkuId())}))}},{key:"updateUiStoreValues",value:function e(){var t=this;var r=this.getSettingValue("storeHeaderMap",{});Object.keys(r).forEach((function(e){var n=r[e];var a=t.getField(n);if(n==="STORE_FROM"){var o=t.model.getStoreCollection().getStoreAmount(a);if(o<=0){var s=t.model.getStoreCollection().getMaxFilledStore();var l=i.StoreSelector.getById(t.getId()+"_"+e);if(s.AMOUNT>o&&l){l.onStoreSelect(s.STORE_ID,s.STORE_TITLE);a=s.STORE_ID}}}t.setStoreAmount(a,n)}))}},{key:"setStoreAmount",value:function e(t,i){var r=this;var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:F;if(a===F){var o;var s={_AMOUNT:function e(){return r.model.getStoreCollection().getStoreAmount(t)},_RESERVED:function e(){return r.model.getStoreCollection().getStoreReserved(t)},_AVAILABLE_AMOUNT:function e(){return r.model.getStoreCollection().getStoreAvailableAmount(t)}};for(var l in s){if(Object.hasOwnProperty.call(s,l)){var u=this.getNode().querySelector("[data-name="+i+l+"]");if(u){o=s[l]()||0;u.innerHTML=o+" "+n.Text.encode(this.getField("MEASURE_NAME"))}}}}}},{key:"setPurchasingPrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:F;t=Math.max(t,0);if(i===F){this.updateUiField("PURCHASING_PRICE",t.toFixed(this.getPricePrecision()))}this.setField("PURCHASING_PRICE",t);this.addActionProductChange();this.addActionUpdateTotal()}},{key:"setAmount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:F;if(i===F){this.updateUiInputField("AMOUNT",t)}var r=this.getField("AMOUNT")!==t;if(r){this.setField("AMOUNT",t);this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setMeasure",value:function e(t){var i=this;var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:F;if(this.model.isEmpty()){this.setField("MEASURE_CODE",t.CODE);this.setField("MEASURE_NAME",t.SYMBOL);this.updateUiMeasure(t.CODE,t.SYMBOL);return}if(r===k){this.getModel().showSaveNotifier("measureChanger_"+this.getId(),{title:n.Loc.getMessage("CATALOG_PRODUCT_MODEL_SAVING_NOTIFICATION_MEASURE_CHANGED_QUERY"),declineCancelTitle:n.Loc.getMessage("CATALOG_PRODUCT_MODEL_SAVING_NOTIFICATION_DECLINE_SAVE"),events:{onSave:function e(){i.setField("MEASURE_CODE",t.CODE);i.setField("MEASURE_NAME",t.SYMBOL);i.updateUiMeasure(i.getField("MEASURE_CODE"),i.getField("MEASURE_NAME"));i.getModel().save(["MEASURE_CODE","MEASURE_NAME"])},onCancel:function e(){i.updateUiMeasure(i.getField("MEASURE_CODE"),i.getField("MEASURE_NAME"))}}})}else{this.updateUiMeasure(t.CODE,t.SYMBOL)}this.addActionProductChange()}},{key:"getInputByFieldName",value:function e(t){var i=this.getUiFieldId(t);var r=document.getElementById(i);if(!n.Type.isElementNode(r)){r=this.getNode().querySelector('[name="'+i+'"]')}return r}},{key:"getInputWrapperByFieldName",value:function e(t){var i=this.getInputByFieldName(t);if(n.Type.isElementNode(i)){return n.Type.isElementNode(i.parentNode)?i.parentNode:i}return undefined}},{key:"updateUiInputField",value:function e(t,i){var r=this.getInputByFieldName(t);if(n.Type.isElementNode(r)){r.value=i}}},{key:"updateUiCheckboxField",value:function e(t,i){var r=this.getInputByFieldName(t);if(n.Type.isElementNode(r)){r.checked=i==="Y"}}},{key:"getMoneyFieldDropdownApi",value:function e(t){if(!n.Reflection.getClass("BX.Main.dropdownManager")){return null}return BX.Main.dropdownManager.getById(this.getId()+"_"+t+"_control")}},{key:"updateMoneyFieldUiWithDropdownApi",value:function e(t,i){if(t.getValue()===i){return}if(t.menu){t.menu.destroy()}var r=t.menu.itemsContainer.querySelector('[data-value="'+i+'"]');var n=r&&t.getMenuItem(r);if(n){t.refresh(n);t.selectItem(n)}}},{key:"updateUiMoneyField",value:function e(t,i,r){var a=this.getInputByFieldName(t);if(!n.Type.isElementNode(a)){return}a.dataset.value=i;var o=a.querySelector("span.main-dropdown-inner");if(!n.Type.isElementNode(o)){return}o.innerHTML=r}},{key:"updateUiMeasure",value:function e(t,i){this.updateUiMoneyField("MEASURE_CODE",t,n.Text.encode(i));this.updateUiStoreValues()}},{key:"updateUiHtmlField",value:function e(t,i){var r=this.getNode().querySelector('[data-name="'+t+'"]');if(n.Type.isElementNode(r)){r.innerHTML=i}}},{key:"updateUiCurrencyFields",value:function e(){var t=this;var i=this.getEditor().getCurrencyText();var r=""+this.getEditor().getCurrencyId();var a=["BASE_PRICE_CURRENCY","PURCHASING_PRICE_CURRENCY"];a.forEach((function(e){var a=[];a.push({NAME:i,VALUE:r});n.Dom.attr(t.getInputByFieldName(e),"data-items",a);t.updateUiMoneyField(e,r,i)}))}},{key:"updateUiField",value:function e(t,i){var r=this.getUiFieldName(t);if(!r){return}var n=this.getUiFieldType(t);if(!n){return}switch(n){case"input":this.updateUiInputField(r,i);break;case"money":i=BX.util.number_format(i,this.getPricePrecision(),".","");this.updateUiInputField(r,i);break;case"money_html":i=o.CurrencyCore.currencyFormat(i,this.getEditor().getCurrencyId(),true);this.updateUiHtmlField(r,i);break}}},{key:"getUiFieldName",value:function e(t){var i=null;switch(t){case"AMOUNT":case"MEASURE_CODE":case"BASE_PRICE":case"PURCHASING_PRICE":i=t;break}return i}},{key:"getUiFieldType",value:function e(t){if(t==="BASE_PRICE"||t==="PURCHASING_PRICE"){var i,r;var n=(i=this.getEditor())===null||i===void 0?void 0:i.getColumnInfo(t);if((n===null||n===void 0?void 0:(r=n.editable)===null||r===void 0?void 0:r.TYPE)==="MONEY"){return"money"}return"money_html"}else if(t==="AMOUNT"){return"input"}return null}},{key:"parseInt",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;return this.getEditor().parseInt(t,i)}},{key:"parseFloat",value:function e(t,i){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;return this.getEditor().parseFloat(t,i,r)}},{key:"getPricePrecision",value:function e(){return this.getEditor().getPricePrecision()}},{key:"getQuantityPrecision",value:function e(){return this.getEditor().getQuantityPrecision()}},{key:"getCommonPrecision",value:function e(){return this.getEditor().getCommonPrecision()}},{key:"resetExternalActions",value:function e(){this.externalActions.length=0}},{key:"addExternalAction",value:function e(t){this.externalActions.push(t)}},{key:"addActionProductChange",value:function e(){this.addExternalAction({type:this.getEditor().actions.productChange,id:this.getId()})}},{key:"addActionUpdateTotal",value:function e(){this.addExternalAction({type:this.getEditor().actions.updateTotal})}},{key:"executeExternalActions",value:function e(){if(this.externalActions.length===0){return}this.getEditor().executeActions(this.externalActions);this.resetExternalActions()}},{key:"isEmptyRow",value:function e(){return!n.Type.isStringFilled(this.getField("NAME","").trim())&&this.model.isEmpty()&&this.getBasePrice()<=0}},{key:"validate",value:function e(){var t=[];if(!A(this,V,te).call(this,this.getAmount())){A(this,x,ee).call(this,"AMOUNT",A(this,V,te));t.push(n.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_INVALID_AMOUNT"))}return t}}]);return e}();function j(){var e=this;if(this.getEditor().isReadOnly()){return}var t=this.getNode().querySelector(".main-grid-cell-action .main-grid-cell-content");if(n.Type.isDomNode(t)){var i=n.Tag.render(E||(E=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<a\n\t\t\t\t\thref="#"\n\t\t\t\t\tclass="main-grid-row-action-button"\n\t\t\t\t></a>\n\t\t\t'])));n.Event.bind(i,"click",(function(t){var a=[{text:n.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_COPY_ACTION"),onclick:e.handleCopyAction.bind(e)},{text:n.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_DELETE_ACTION"),onclick:e.handleDeleteAction.bind(e)}];r.PopupMenu.show({id:e.getId()+"_actions_popup",bindElement:i,items:a});t.preventDefault();t.stopPropagation()}));n.Dom.append(i,t)}}function q(){var e={iblockId:this.model.getIblockId(),basePriceId:this.model.getBasePriceId(),currency:this.model.getCurrency(),model:this.model,config:{ENABLE_SEARCH:true,IS_ALLOWED_CREATION_PRODUCT:this.getSettingValue("isAllowedCreationProduct",true),ENABLE_IMAGE_INPUT:true,ROLLBACK_INPUT_AFTER_CANCEL:true,ENABLE_INPUT_DETAIL_LINK:true,ROW_ID:this.getId(),ENABLE_SKU_SELECTION:true,ENABLE_EMPTY_PRODUCT_ERROR:true,RESTRICTED_PRODUCT_TYPES:[R]},mode:s.ProductSelector.MODE_EDIT};this.mainSelector=new s.ProductSelector("catalog_document_grid_"+this.getId(),e);var t=this.getNode().querySelector('[data-name="MAIN_INFO"]');if(t){var i=t.querySelector(".main-grid-row-number");if(!n.Type.isDomNode(i)){t.appendChild(n.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(['<div class="main-grid-row-number"></div>']))))}var r=t.querySelector(".main-grid-row-product-selector");if(!n.Type.isDomNode(r)){r=n.Tag.render(m||(m=babelHelpers.taggedTemplateLiteral(['<div class="main-grid-row-product-selector"></div>'])));t.appendChild(r)}this.mainSelector.renderTo(r)}a.EventEmitter.subscribe(this.mainSelector,"onBeforeCreate",A(this,U,$).bind(this))}function W(){var e={iblockId:this.model.getIblockId(),basePriceId:this.model.getBasePriceId(),currency:this.model.getCurrency(),model:this.model,inputFieldName:"BARCODE",type:s.ProductSelector.INPUT_FIELD_BARCODE,config:{ENABLE_SEARCH:true,IS_ALLOWED_CREATION_PRODUCT:this.getSettingValue("isAllowedCreationProduct",true),ENABLE_INFO_SPOTLIGHT:this.editor.getSettingValue("showBarcodeSpotlightInfo",true),ENABLE_BARCODE_QR_AUTH:this.editor.getSettingValue("showBarcodeQrAuth",true),ENABLE_IMAGE_INPUT:false,ROLLBACK_INPUT_AFTER_CANCEL:true,ENABLE_INPUT_DETAIL_LINK:false,ROW_ID:this.getId(),ENABLE_SKU_SELECTION:false,ENABLE_SKU_TREE:false,ENABLE_EMPTY_PRODUCT_ERROR:false,RESTRICTED_PRODUCT_TYPES:[R]},mode:s.ProductSelector.MODE_EDIT,scannerToken:this.getEditor().scannerToken};this.barcodeSelector=new s.ProductSelector("catalog_document_grid_"+this.getId()+"_barcode",e);var t=this.getNode().querySelector('[data-name="BARCODE_INFO"]');if(t){this.barcodeSelector.renderTo(t)}a.EventEmitter.subscribe(this.barcodeSelector,"onBeforeCreate",A(this,U,$).bind(this));a.EventEmitter.subscribe(this.barcodeSelector,"onSpotlightClose",A(this,G,J).bind(this));a.EventEmitter.subscribe(this.barcodeSelector,"onBarcodeQrClose",A(this,L,Z).bind(this))}function Y(e){var t=this;Object.keys(e).forEach((function(r){var o={inputFieldId:e[r],inputFieldTitle:e[r]+"_TITLE",config:{ENABLE_SEARCH:true,ENABLE_INPUT_DETAIL_LINK:false,ROW_ID:t.getId()},mode:i.StoreSelector.MODE_EDIT,model:t.model};var s=new i.StoreSelector(t.getId()+"_"+r,o);var l=t.getNode().querySelector('[data-name="'+r+'"]');if(s){s.renderTo(l)}a.EventEmitter.subscribe(s,"onChange",n.Runtime.debounce(A(t,B,K).bind(t),500,t));t.storeSelectors.push(s)}))}function K(e){var t=this;var i=e.getData();i.fields.forEach((function(e){t.updateField(e.NAME,e.VALUE)}))}function Q(){var e=n.Type.isNumber(this.getModel().getField("BASE_PRICE_EXTRA"))?this.getModel().getField("BASE_PRICE_EXTRA"):null;return new y({basePrice:n.Text.toNumber(this.getModel().getField("PURCHASING_PRICE")),finalPrice:n.Text.toNumber(this.getModel().getField("BASE_PRICE")),extra:e,extraType:n.Text.toNumber(this.getModel().getField("BASE_PRICE_EXTRA_RATE"))})}function z(){var e=this.getModel().getErrorCollection().getErrors();for(var t in e){if(t===s.ProductSelector.ErrorCodes.NOT_SELECTED_PRODUCT){this.getSelector().layoutErrors()}}this.getEditor().handleProductErrorsChange()}function $(e){var t=e.getData(),i=t.model;i.setField("BARCODE",this.barcodeSelector.getNameInputFilledValue());i.setField("NAME",this.mainSelector.getNameInputFilledValue())}function J(e){this.editor.closeBarcodeSpotlights()}function Z(e){this.editor.closeBarcodeQrAuths()}function ee(e,t){var i=this;var r=this.getInputByFieldName(e);var a=this.getInputWrapperByFieldName(e);if(t(r.valueAsNumber)||this.validatingFields.get(e)){return}this.validatingFields.set(e,true);a.classList.add("main-grid-editor-cell-danger");var o=function o(s){if(Boolean(t(s.target.valueAsNumber))){i.validatingFields.set(e,false);n.Event.unbind(r,"blur",o);a.classList.remove("main-grid-editor-cell-danger")}};n.Event.bind(r,"blur",o)}function te(e){return e>0}var ie=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"_settings",{});this._settings=t?t:{};this.eventHandlers={}}babelHelpers.createClass(e,[{key:"registerEventHandler",value:function e(t,i){if(!this.eventHandlers[t])this.eventHandlers[t]=[];this.eventHandlers[t].push(i);BX.addCustomEvent(this,t,i)}},{key:"fireEvent",value:function e(t,i){BX.onCustomEvent(this,t,i)}},{key:"unregisterEventHandlers",value:function e(t){if(this.eventHandlers[t]){for(var i=0;i<this.eventHandlers[t].length;i++){BX.removeCustomEvent(this,t,this.eventHandlers[t][i])}delete this.eventHandlers[t]}}}]);return e}();var re,ne,ae,oe;function se(e,t){ue(e,t);t.add(e)}function le(e,t,i){ue(e,t);t.set(e,i)}function ue(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function de(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var ce=new WeakMap;var he=new WeakMap;var ge=new WeakMap;var fe=new WeakMap;var ve=new WeakSet;var pe=new WeakSet;var ye=new WeakSet;var Ee=new WeakSet;var be=new WeakSet;var me=new WeakSet;var Pe=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var r=arguments.length>2?arguments[2]:undefined;babelHelpers.classCallCheck(this,e);se(this,me);se(this,be);se(this,Ee);se(this,ye);se(this,pe);se(this,ve);le(this,ce,{writable:true,value:void 0});le(this,he,{writable:true,value:void 0});le(this,ge,{writable:true,value:void 0});le(this,fe,{writable:true,value:new n.Cache.MemoryCache});babelHelpers.classPrivateFieldSet(this,ce,t);babelHelpers.classPrivateFieldSet(this,he,i);babelHelpers.classPrivateFieldSet(this,ge,r)}babelHelpers.createClass(e,[{key:"show",value:function e(){this.getPopup().show()}},{key:"getPopup",value:function e(){var t=this;return babelHelpers.classPrivateFieldGet(this,fe).remember("settings-popup",(function(){return new r.Popup(babelHelpers.classPrivateFieldGet(t,ge).getId()+"_"+Math.random()*100,babelHelpers.classPrivateFieldGet(t,ce),{autoHide:true,draggable:false,offsetLeft:0,offsetTop:0,angle:{position:"top",offset:43},noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,content:de(t,pe,Ce).call(t)})}))}},{key:"updateCheckboxState",value:function e(){var t=this;var i=this.getPopup().getContentContainer();babelHelpers.classPrivateFieldGet(this,he).filter((function(e){return e.action==="grid"&&n.Type.isArray(e.columns)})).forEach((function(e){var r=true;e.columns.forEach((function(e){if(!babelHelpers.classPrivateFieldGet(t,ge).getGrid().getColumnHeaderCellByName(e)){r=false}}));var a=i.querySelector('input[data-setting-id="'+e.id+'"]');if(n.Type.isDomNode(a)){a.checked=r}}))}}]);return e}();function Se(e){return babelHelpers.classPrivateFieldGet(this,he).filter((function(t){return t.id===e}))[0]}function Ce(){var e=this;var t=n.Tag.render(re||(re=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div class='ui-entity-editor-popup-create-field-list'></div>\n\t\t"])));babelHelpers.classPrivateFieldGet(this,he).forEach((function(i){t.append(de(e,ye,Te).call(e,i))}));return t}function Te(e){var t=n.Tag.render(ne||(ne=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="checkbox">\n\t\t'])));t.checked=e.checked;t.dataset.settingId=e.id;var i=n.Type.isStringFilled(e.desc)?n.Tag.render(ae||(ae=babelHelpers.taggedTemplateLiteral(['<span class="ui-entity-editor-popup-create-field-item-desc">',"</span>"])),e.desc):"";var r=n.Tag.render(oe||(oe=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<label class="ui-ctl-block ui-entity-editor-popup-create-field-item ui-ctl-w100">\n\t\t\t\t<div class="ui-ctl-w10" style="text-align: center">','</div>\n\t\t\t\t<div class="ui-ctl-w75">\n\t\t\t\t\t<span class="ui-entity-editor-popup-create-field-item-title">',"</span>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</label>\n\t\t"])),t,e.title,i);n.Event.bind(r,"change",de(this,Ee,Ie).bind(this));return r}function Ie(e){var t=de(this,ve,Se).call(this,e.target.dataset.settingId);if(!t){return}var i=e.target.checked;de(this,be,Ae).call(this,t,i)}function Ae(e,t){var i=this;var r=[];var a=babelHelpers.classPrivateFieldGet(this,ge).getGrid().getRows().getHeadFirstChild().getCells();Array.from(a).forEach((function(e){if("name"in e.dataset){r.push(e.dataset.name)}}));n.ajax.runComponentAction(babelHelpers.classPrivateFieldGet(this,ge).getComponentName(),"setGridSetting",{mode:"class",data:{signedParameters:babelHelpers.classPrivateFieldGet(this,ge).getSignedParameters(),settingId:e.id,selected:t,currentHeaders:r}}).then((function(){e.checked=t;if(e.id==="ADD_NEW_ROW_TOP"){var r=t?"top":"bottom";babelHelpers.classPrivateFieldGet(i,ge).setSettingValue("newRowPosition",r);var a=babelHelpers.classPrivateFieldGet(i,ge).changeActivePanelButtons(r);var o=a.querySelector('[data-role="product-list-settings-button"]');i.getPopup().setBindElement(o)}else{babelHelpers.classPrivateFieldGet(i,ge).reloadGrid()}i.getPopup().close();var s=t?n.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_SETTING_ENABLED"):n.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_SETTING_DISABLED");de(i,me,ke).call(i,s.replace("#NAME#",e.title),{category:"popup-settings"})}))}function ke(e,t){t=t||{};BX.UI.Notification.Center.notify({content:e,stack:t.stack||null,position:"top-right",width:"auto",category:t.category||null,autoHideDelay:t.autoHideDelay||3e3})}function Fe(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function Re(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Fe(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Fe(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function _e(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=we(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var r=0;var n=function e(){};return{s:n,n:function t(){if(r>=e.length)return{done:true};return{done:false,value:e[r++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,o=false,s;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();a=t.done;return t},e:function e(t){o=true;s=t},f:function e(){try{if(!a&&i["return"]!=null)i["return"]()}finally{if(o)throw s}}}}function we(e,t){if(!e)return;if(typeof e==="string")return Ne(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return Ne(e,t)}function Ne(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,r=new Array(t);i<t;i++){r[i]=e[i]}return r}function Oe(e,t){De(e,t);t.add(e)}function De(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function Be(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var He="template_0";var Me=2;var Ue=new WeakSet;var Ge=new WeakSet;var Le=function(){function e(t){babelHelpers.classCallCheck(this,e);Oe(this,Ge);Oe(this,Ue);babelHelpers.defineProperty(this,"products",[]);babelHelpers.defineProperty(this,"productsWasInitiated",false);babelHelpers.defineProperty(this,"cache",new n.Cache.MemoryCache);babelHelpers.defineProperty(this,"actions",{productChange:"productChange",productListChanged:"productListChanged",updateListField:"listField",updateTotal:"total"});babelHelpers.defineProperty(this,"updateFieldForList",null);babelHelpers.defineProperty(this,"productRowAddHandler",this.handleProductRowAdd.bind(this));babelHelpers.defineProperty(this,"productRowCreateHandler",this.handleProductRowCreate.bind(this));babelHelpers.defineProperty(this,"showBarcodeSettingsPopupHandler",this.handleShowBarcodeSettingsPopup.bind(this));babelHelpers.defineProperty(this,"showSettingsPopupHandler",this.handleShowSettingsPopup.bind(this));babelHelpers.defineProperty(this,"onSaveHandler",this.handleOnSave.bind(this));babelHelpers.defineProperty(this,"onEditorSubmit",this.handleEditorSubmit.bind(this));babelHelpers.defineProperty(this,"onBeforeGridRequestHandler",this.handleOnBeforeGridRequest.bind(this));babelHelpers.defineProperty(this,"onGridUpdatedHandler",this.handleOnGridUpdated.bind(this));babelHelpers.defineProperty(this,"onGridRowMovedHandler",this.handleOnGridRowMoved.bind(this));babelHelpers.defineProperty(this,"onBeforeProductChangeHandler",this.handleOnBeforeProductChange.bind(this));babelHelpers.defineProperty(this,"onProductChangeHandler",this.handleOnProductChange.bind(this));babelHelpers.defineProperty(this,"onProductClearHandler",this.handleOnProductClear.bind(this));babelHelpers.defineProperty(this,"dropdownChangeHandler",this.handleDropdownChange.bind(this));babelHelpers.defineProperty(this,"onScanEmitHandler",this.handleMobileScanEvent.bind(this));babelHelpers.defineProperty(this,"changeProductFieldHandler",this.handleFieldChange.bind(this));babelHelpers.defineProperty(this,"updateTotalDataDelayedHandler",n.Runtime.debounce(this.updateTotalDataDelayed,100,this));this.setId(t)}babelHelpers.createClass(e,[{key:"init",value:function e(){var t;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.setSettings(i);this.scannerToken=(t=this.scannerToken)!==null&&t!==void 0?t:n.Text.getRandom(16);if(this.canEdit()){this.addFirstRowIfEmpty();this.enableEdit()}this.initForm();this.initProducts();this.initGridData();this.paintColumns();a.EventEmitter.emit("DocumentProductListController",[this]);Be(this,Ue,xe).call(this);this.subscribeDomEvents();this.subscribeCustomEvents()}},{key:"subscribeDomEvents",value:function e(){var t=this;var i=this.getContainer();if(n.Type.isElementNode(i)){i.querySelectorAll('[data-role="product-list-add-button"]').forEach((function(e){n.Event.bind(e,"click",t.productRowAddHandler)}));i.querySelectorAll('[data-role="product-list-create-button"]').forEach((function(e){n.Event.bind(e,"click",t.productRowCreateHandler)}));i.querySelectorAll('[data-role="product-list-settings-button"]').forEach((function(e){n.Event.bind(e,"click",t.showSettingsPopupHandler)}));i.querySelectorAll('[data-role="product-list-barcode-settings-button"]').forEach((function(e){n.Event.bind(e,"click",t.showBarcodeSettingsPopupHandler)}))}}},{key:"unsubscribeDomEvents",value:function e(){var t=this;var i=this.getContainer();if(n.Type.isElementNode(i)){i.querySelectorAll('[data-role="product-list-select-button"]').forEach((function(e){n.Event.unbind(e,"click",t.productSelectionPopupHandler)}));i.querySelectorAll('[data-role="product-list-add-button"]').forEach((function(e){n.Event.unbind(e,"click",t.productRowCreateHandler)}));i.querySelectorAll('[data-role="product-list-barcode-settings-button"]').forEach((function(e){n.Event.unbind(e,"click",t.productRowAddHandler)}));i.querySelectorAll('[data-role="product-list-settings-button"]').forEach((function(e){n.Event.unbind(e,"click",t.showSettingsPopupHandler)}))}}},{key:"subscribeCustomEvents",value:function e(){a.EventEmitter.subscribe("BX.UI.EntityEditor:onSave",this.onSaveHandler);a.EventEmitter.subscribe("BX.UI.EntityEditorAjax:onSubmit",this.onEditorSubmit);a.EventEmitter.subscribe("Grid::beforeRequest",this.onBeforeGridRequestHandler);a.EventEmitter.subscribe("Grid::updated",this.onGridUpdatedHandler);a.EventEmitter.subscribe("Grid::rowMoved",this.onGridRowMovedHandler);a.EventEmitter.subscribe("BX.Catalog.ProductSelector:onBeforeChange",this.onBeforeProductChangeHandler);a.EventEmitter.subscribe("BX.Catalog.ProductSelector:onChange",this.onProductChangeHandler);a.EventEmitter.subscribe("BX.Catalog.ProductSelector:onClear",this.onProductClearHandler);a.EventEmitter.subscribe("Dropdown::change",this.dropdownChangeHandler);a.EventEmitter.subscribe("BarcodeScanner::onScanEmit",this.onScanEmitHandler)}},{key:"unsubscribeCustomEvents",value:function e(){a.EventEmitter.unsubscribe("BX.UI.EntityEditor:onSave",this.onSaveHandler);a.EventEmitter.unsubscribe("BX.UI.EntityEditorAjax:onSubmit",this.onEditorSubmit);a.EventEmitter.unsubscribe("Grid::beforeRequest",this.onBeforeGridRequestHandler);a.EventEmitter.unsubscribe("Grid::updated",this.onGridUpdatedHandler);a.EventEmitter.unsubscribe("Grid::rowMoved",this.onGridRowMovedHandler);a.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onBeforeChange",this.onBeforeProductChangeHandler);a.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onChange",this.onProductChangeHandler);a.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onClear",this.onProductClearHandler);a.EventEmitter.unsubscribe("Dropdown::change",this.dropdownChangeHandler);a.EventEmitter.unsubscribe("BarcodeScanner::onScanEmit",this.onScanEmitHandler)}},{key:"handleMobileScanEvent",value:function e(t){var i,r;var a=t.getData();if(this.scannerToken!==a.id||!n.Type.isStringFilled(a.barcode)){return}var o=_e(this.products),s;try{for(o.s();!(s=o.n()).done;){var l,u;var d=s.value;if(((l=d.getBarcodeSelector())===null||l===void 0?void 0:(u=l.searchInput)===null||u===void 0?void 0:u.getNameInput())===document.activeElement){var c;(c=d.getBarcodeSelector().searchInput)===null||c===void 0?void 0:c.applyScannerData(a.barcode);return}}}catch(e){o.e(e)}finally{o.f()}var h=_e(this.products),g;try{for(h.s();!(g=h.n()).done;){var f,v,p,y;var E=g.value;if(((f=E.getBarcodeSelector())===null||f===void 0?void 0:(v=f.searchInput)===null||v===void 0?void 0:v.getNameInput().value)===""&&((p=E.getSelector())===null||p===void 0?void 0:(y=p.searchInput)===null||y===void 0?void 0:y.getNameInput().value)===""){var b;(b=E.getBarcodeSelector().searchInput)===null||b===void 0?void 0:b.applyScannerData(a.barcode);return}}}catch(e){h.e(e)}finally{h.f()}var m=this.addProductRow();(i=this.getProductById(m))===null||i===void 0?void 0:(r=i.getBarcodeSelector().searchInput)===null||r===void 0?void 0:r.applyScannerData(a.barcode)}},{key:"selectProductInRow",value:function e(t,i){var r=this;if(!n.Type.isStringFilled(t)||n.Text.toNumber(i)<=0){return}requestAnimationFrame((function(){var e;(e=r.getProductSelector(t))===null||e===void 0?void 0:e.onProductSelect(i)}))}},{key:"handleOnSave",value:function e(t){var i=u.ProductModel.getLastActiveSaveNotification();if(i){i.close()}var r=[];this.products.forEach((function(e){var t={fields:Re({},e.fields),rowId:e.fields.ROW_ID};r.push(t)}));this.setSettingValue("items",r)}},{key:"handleEditorSubmit",value:function e(t){}},{key:"onInnerCancel",value:function e(){this.reloadGrid(false)}},{key:"changeActivePanelButtons",value:function e(t){var i=this.getContainer();var r=i.querySelector(".catalog-document-product-list-add-block-"+t);if(n.Type.isDomNode(r)){n.Dom.removeClass(r,"catalog-document-product-list-add-block-hidden");n.Dom.addClass(r,"catalog-document-product-list-add-block-active")}var a=t==="top"?"bottom":"top";var o=i.querySelector(".catalog-document-product-list-add-block-"+a);if(n.Type.isDomNode(o)){n.Dom.addClass(o,"catalog-document-product-list-add-block-hidden");n.Dom.removeClass(o,"catalog-document-product-list-add-block-active")}return r}},{key:"reloadGrid",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(r===null){r=!i}this.getGrid().reloadTable("POST",{useProductsFromRequest:i},(function(){return t.actionUpdateTotalData({isInternalChanging:r})}))}},{key:"handleOnBeforeGridRequest",value:function e(t){var i=this;var r=t.getCompatData(),n=babelHelpers.slicedToArray(r,2),o=n[0],s=n[1];if(!o||!o.parent||o.parent.getId()!==this.getGridId()){return}var l=!("useProductsFromRequest"in s.data);var u=l?true:s.data.useProductsFromRequest;s.url=this.getReloadUrl();s.method="POST";s.sessid=BX.bitrix_sessid();s.data=Re(Re({},s.data),{},{useProductsFromRequest:u,signedParameters:this.getSignedParameters(),products:u?this.getProductsFields():null});var d=false;if(s.data["action_button_"+s.gridId]==="delete"){d=true}this.clearEditor();if(l){a.EventEmitter.subscribeOnce("Grid::updated",(function(e){var t=e.getCompatData(),r=babelHelpers.slicedToArray(t,1),n=r[0];if(!n||n.getId()!==i.getGridId()){return}i.actionUpdateTotalData({isInternalChanging:false});if(d){i.executeActions([{type:i.actions.productListChanged}])}}))}}},{key:"handleOnGridUpdated",value:function e(t){var i=t.getCompatData(),r=babelHelpers.slicedToArray(i,1),n=r[0];if(!n||n.getId()!==this.getGridId()){return}this.getSettingsPopup().updateCheckboxState()}},{key:"handleOnGridRowMoved",value:function e(t){var i=t.getCompatData(),r=babelHelpers.slicedToArray(i,3),n=r[0],a=r[2];if(!a||a.getId()!==this.getGridId()){return}var o=this.resortProductsByIds(n);if(o){this.refreshSortFields();this.numerateRows();this.executeActions([{type:this.actions.productListChanged}])}}},{key:"initPageEventsManager",value:function e(){var t=this.getSettingValue("componentId");this.pageEventsManager=new ie({id:t})}},{key:"getPageEventsManager",value:function e(){if(!this.pageEventsManager){this.initPageEventsManager()}return this.pageEventsManager}},{key:"canEdit",value:function e(){return this.getSettingValue("allowEdit",false)===true}},{key:"enableEdit",value:function e(){var t=this.getGrid().getRows().getRows();t.forEach((function(e){if(!e.isHeadChild()&&!e.isTemplate()){e.edit()}}))}},{key:"addFirstRowIfEmpty",value:function e(){var t=this;if(this.getGrid().getRows().getCountDisplayed()===0){requestAnimationFrame((function(){return t.addProductRow()}))}}},{key:"clearEditor",value:function e(){this.unsubscribeProductsEvents();this.products=[];this.productsWasInitiated=false;this.destroySettingsPopup();this.unsubscribeDomEvents();this.unsubscribeCustomEvents();n.Event.unbindAll(this.container)}},{key:"wasProductsInitiated",value:function e(){return this.productsWasInitiated}},{key:"unsubscribeProductsEvents",value:function e(){this.products.forEach((function(e){var t=e.getSelector();if(t){t.unsubscribeEvents()}var i=e.getBarcodeSelector();if(i){i.unsubscribeEvents()}}))}},{key:"destroy",value:function e(){this.setForm(null);this.clearController();this.clearEditor()}},{key:"setController",value:function e(t){if(this.controller===t){return}if(this.controller){this.controller.clearProductList()}this.controller=t}},{key:"clearController",value:function e(){this.controller=null}},{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"getSettings",value:function e(){return this.settings}},{key:"setSettings",value:function e(t){this.settings=t?t:{}}},{key:"getSettingValue",value:function e(t,i){return this.settings.hasOwnProperty(t)?this.settings[t]:i}},{key:"setSettingValue",value:function e(t,i){this.settings[t]=i}},{key:"getComponentName",value:function e(){return this.getSettingValue("componentName","")}},{key:"getReloadUrl",value:function e(){return this.getSettingValue("reloadUrl","")}},{key:"getSignedParameters",value:function e(){return this.getSettingValue("signedParameters","")}},{key:"getContainerId",value:function e(){return this.getSettingValue("containerId","")}},{key:"getGridId",value:function e(){return this.getSettingValue("gridId","")}},{key:"getLanguageId",value:function e(){return this.getSettingValue("languageId","")}},{key:"getSiteId",value:function e(){return this.getSettingValue("siteId","")}},{key:"getCatalogId",value:function e(){return this.getSettingValue("catalogId",0)}},{key:"isReadOnly",value:function e(){return this.getSettingValue("readOnly",true)}},{key:"setReadOnly",value:function e(t){this.setSettingValue("readOnly",t)}},{key:"getCurrencyId",value:function e(){return this.getSettingValue("currencyId","")}},{key:"setCurrencyId",value:function e(t){this.setSettingValue("currencyId",t);return o.CurrencyCore.loadCurrencyFormat(t)}},{key:"changeCurrencyId",value:function e(t){var i=this;var r=this.getCurrencyId();if(r===t){return}this.setCurrencyId(t).then((function(){var e=[];i.products.forEach((function(i){i.getModel().setOption("currency",t);e.push({fields:i.getFields(),id:i.getId()})}));if(e.length>0){n.ajax.runComponentAction(i.getComponentName(),"calculateProductPrices",{mode:"class",signedParameters:i.getSignedParameters(),data:{products:e,currencyId:t,oldCurrencyId:r}}).then(i.onCalculatePricesResponse.bind(i))}var a=i.getGridEditData();var o=a[He];o["CURRENCY"]=i.getCurrencyId();var s=["BASE_PRICE","PURCHASING_PRICE"];s.forEach((function(e){if(o[e]&&o[e]["CURRENCY"]){o[e]["CURRENCY"]["VALUE"]=i.getCurrencyId()}}));i.setGridEditData(a)}))}},{key:"onCalculatePricesResponse",value:function e(t){var i=t.data;this.products.forEach((function(e){if(n.Type.isObject(i[e.getId()])){e.updateField("BASE_PRICE",i[e.getId()]["BASE_PRICE"]);e.updateField("PURCHASING_PRICE",i[e.getId()]["PURCHASING_PRICE"]);e.updateUiCurrencyFields()}}));this.updateTotalDataDelayed();this.updateTotalUiCurrency()}},{key:"updateTotalUiCurrency",value:function e(){var t=this;var i=BX(this.getSettingValue("totalBlockContainerId",null));if(n.Type.isElementNode(i)){i.querySelectorAll('[data-role="currency-wrapper"]').forEach((function(e){e.innerHTML=t.getCurrencyText()}))}}},{key:"getCurrencyText",value:function e(){var t=this.getCurrencyId();if(!n.Type.isStringFilled(t)){return""}var i=o.CurrencyCore.getCurrencyFormat(t);return i&&i.FORMAT_STRING.replace(/(^|[^&])#/,"$1").trim()||""}},{key:"getDataFieldName",value:function e(){return this.getSettingValue("dataFieldName","")}},{key:"getDataSettingsFieldName",value:function e(){var t=this.getDataFieldName();return n.Type.isStringFilled(t)?t+"_SETTINGS":""}},{key:"getPricePrecision",value:function e(){return this.getSettingValue("pricePrecision",Me)}},{key:"getQuantityPrecision",value:function e(){return this.getSettingValue("quantityPrecision",Me)}},{key:"getCommonPrecision",value:function e(){return this.getSettingValue("commonPrecision",Me)}},{key:"getMeasures",value:function e(){return this.getSettingValue("measures",[])}},{key:"getDefaultMeasure",value:function e(){return this.getSettingValue("defaultMeasure",{})}},{key:"getRowIdPrefix",value:function e(){return this.getSettingValue("rowIdPrefix","catalog_entity_product_list_")}},{key:"parseInt",value:function(e){function t(t){return e.apply(this,arguments)}t.toString=function(){return e.toString()};return t}((function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var i;var r=n.Type.isNumber(e);var a=n.Type.isStringFilled(e);if(!r&&!a){return t}if(a){e=e.replace(/^\s+|\s+$/g,"");var o=e.indexOf("-")===0;i=parseInt(e.replace(/[^\d]/g,""),10);if(isNaN(i)){i=t}else{if(o){i=-i}}}else{i=parseInt(e,10);if(isNaN(i)){i=t}}return i}))},{key:"parseFloat",value:function(e){function t(t){return e.apply(this,arguments)}t.toString=function(){return e.toString()};return t}((function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:Me;var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var r;var a=n.Type.isNumber(e);var o=n.Type.isStringFilled(e);if(!a&&!o){return i}if(o){e=e.replace(/^\s+|\s+$/g,"");var s=e.indexOf(".");var l=e.indexOf(",");var u=e.indexOf("-")===0;if(s<0&&l>=0){var d=e.substr(0,l);var c=e.length-l-1;if(c>0){d+="."+e.substr(l+1,c)}e=d}e=e.replace(/[^\d.]+/g,"");r=parseFloat(e);if(isNaN(r)){r=i}if(u){r=-r}}else{r=parseFloat(e)}if(t>=0){r=this.round(r,t)}return r}))},{key:"round",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:Me;var r=Math.pow(10,i);return Math.round(t*r)/r}},{key:"getContainer",value:function e(){var t=this;return this.cache.remember("container",(function(){return document.getElementById(t.getContainerId())}))}},{key:"initForm",value:function e(){var t=this.getSettingValue("formId","");var i=n.Type.isStringFilled(t)?BX("form_"+t):null;if(n.Type.isElementNode(i)){this.setForm(i)}}},{key:"isExistForm",value:function e(){return n.Type.isElementNode(this.getForm())}},{key:"getForm",value:function e(){return this.form}},{key:"setForm",value:function e(t){this.form=t}},{key:"initFormFields",value:function e(){var t=this.getForm();if(n.Type.isElementNode(t)){var i=this.getDataField();if(!n.Type.isElementNode(i)){this.initDataField()}var r=this.getDataSettingsField();if(!n.Type.isElementNode(r)){this.initDataSettingsField()}}}},{key:"initFormField",value:function e(t){var i=this.getForm();if(n.Type.isElementNode(i)&&n.Type.isStringFilled(t)){i.appendChild(n.Dom.create("input",{attrs:{type:"hidden",name:t}}))}}},{key:"removeFormFields",value:function e(){var t=this.getDataField();if(n.Type.isElementNode(t)){n.Dom.remove(t)}var i=this.getDataSettingsField();if(n.Type.isElementNode(i)){n.Dom.remove(i)}}},{key:"initDataField",value:function e(){this.initFormField(this.getDataFieldName())}},{key:"initDataSettingsField",value:function e(){this.initFormField(this.getDataSettingsFieldName())}},{key:"getFormField",value:function e(t){var i=this.getForm();if(n.Type.isElementNode(i)&&n.Type.isStringFilled(t)){return i.querySelector('input[name="'+t+'"]')}return null}},{key:"getDataField",value:function e(){return this.getFormField(this.getDataFieldName())}},{key:"getDataSettingsField",value:function e(){return this.getFormField(this.getDataSettingsFieldName())}},{key:"getProductCount",value:function e(){return this.products.filter((function(e){return!e.isEmptyRow()})).length}},{key:"initProducts",value:function e(){var t=this.getSettingValue("items",[]);var i=_e(t),r;try{for(i.s();!(r=i.n()).done;){var n=r.value;var a=Re({},n.fields);this.products.push(new X(n.rowId,a,this.getSettingValue("rowSettings",{}),this))}}catch(e){i.e(e)}finally{i.f()}this.numerateRows();this.productsWasInitiated=true;this.updateTotalDataDelayed()}},{key:"numerateRows",value:function e(){this.products.forEach((function(e,t){e.setRowNumber(t+1)}))}},{key:"getGrid",value:function e(){var t=this;return this.cache.remember("grid",(function(){var e=t.getGridId();if(!n.Reflection.getClass("BX.Main.gridManager.getInstanceById")){throw Error("Cannot find grid with '".concat(e,"' id."))}return BX.Main.gridManager.getInstanceById(e)}))}},{key:"initGridData",value:function e(){var t=this.getSettingValue("templateGridEditData",null);if(t){this.setGridEditData(t)}}},{key:"paintColumns",value:function e(){var t=this.getSettingValue("paintedColumns",null);var i=this.getGrid();if(i&&n.Type.isArray(t)){t.forEach((function(e){var t=i.getRows().getRows();t.forEach((function(t){var i=t.getCellById(e);if(i){n.Dom.addClass(i,"main-grid-cell-light-blue-background")}}))}))}}},{key:"getGridEditData",value:function e(){return this.getGrid().arParams.EDITABLE_DATA}},{key:"getColumnInfo",value:function e(t){var i,r;return((i=this.getGrid())===null||i===void 0?void 0:(r=i.arParams)===null||r===void 0?void 0:r.COLUMNS_ALL[t])||{}}},{key:"setGridEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA=t}},{key:"setOriginalTemplateEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA[He]=t}},{key:"handleProductErrorsChange",value:function e(){if(Be(this,Ge,Ve).call(this)){this.controller.disableSaveButton()}else{this.controller.enableSaveButton()}}},{key:"handleFieldChange",value:function e(t){var i=t.target.closest("tr");if(i&&i.hasAttribute("data-id")){var r=this.getProductById(i.getAttribute("data-id"));if(r){var a=t.target.getAttribute("data-name");if(!n.Type.isStringFilled(a)){var o=t.target.closest("td");a=this.getFieldCodeByGridCell(i,o)}if(a){r.updateFieldByEvent(a,t)}}}}},{key:"handleDropdownChange",value:function e(t){var i=t.getData(),r=babelHelpers.slicedToArray(i,5),n=r[0],a=r[4];var o=new RegExp(this.getRowIdPrefix()+"([A-Za-z0-9]+)_(\\w+)_control","i");var s=n.match(o);if(s){var l=babelHelpers.slicedToArray(s,3),u=l[1],d=l[2];var c=this.getProductById(u);if(c){c.updateDropdownField(d,a)}}}},{key:"getProductById",value:function e(t){var i=this.getRowIdPrefix()+t;return this.getProductByRowId(i)}},{key:"getProductByRowId",value:function e(t){return this.products.find((function(e){return e.getId()===t}))}},{key:"getFieldCodeByGridCell",value:function e(t,i){if(!n.Type.isDomNode(t)||!n.Type.isDomNode(i)){return null}var r=this.getGrid();if(r){var a=r.getRows().getHeadFirstChild();var o=babelHelpers.toConsumableArray(t.cells).indexOf(i);return a.getCellNameByCellIndex(o)}return null}},{key:"addProductRow",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var i=this.createGridProductRow();var r=i.getId();if(t){var n;var a=(n=this.getGrid().getRows().getById(t.getField("ID")))===null||n===void 0?void 0:n.getNode();if(a){a.parentNode.insertBefore(i.getNode(),a.nextSibling)}}this.initializeNewProductRow(r,t);this.getGrid().bindOnRowEvents();return r}},{key:"handleProductRowAdd",value:function e(){var t=this.addProductRow();this.focusProductSelector(t)}},{key:"handleProductRowCreate",value:function e(){}},{key:"handleShowBarcodeSettingsPopup",value:function e(){this.getSettingsPopup().show()}},{key:"handleShowSettingsPopup",value:function e(){this.getSettingsPopup().show()}},{key:"destroySettingsPopup",value:function e(){if(this.cache.has("settings-popup")){this.cache.get("settings-popup").getPopup().destroy();this.cache["delete"]("settings-popup")}}},{key:"getSettingsPopup",value:function e(){var t=this;return this.cache.remember("settings-popup",(function(){return new Pe(t.getContainer().querySelector('.catalog-document-product-list-add-block-active [data-role="product-list-settings-button"]'),t.getSettingValue("popupSettings",[]),t)}))}},{key:"getHintPopup",value:function e(){var t=this;return this.cache.remember("hint-popup",(function(){return new c(t)}))}},{key:"createGridProductRow",value:function e(){var t=n.Text.getRandom();var i=this.redefineTemplateEditData(t);var r=this.getGrid();var o;if(this.getSettingValue("newRowPosition")==="bottom"){o=r.appendRowEditor()}else{o=r.prependRowEditor()}var s=o.getNode();if(n.Type.isDomNode(s)){s.setAttribute("data-id",t);o.makeCountable()}if(i){this.setOriginalTemplateEditData(i)}a.EventEmitter.emit("Grid::thereEditedRows",[]);r.adjustRows();r.updateCounterDisplayed();r.updateCounterSelected();return o}},{key:"handleDeleteRow",value:function e(t,i){i.preventDefault();var r=this.getProductByRowId(t);if(r){this.deleteRow(t)}}},{key:"redefineTemplateEditData",value:function e(t){var i=this.getGridEditData();var r=i[He];var n=this.prepareCustomEditData(r,t);this.setOriginalTemplateEditData(Re(Re({},r),n));return r}},{key:"prepareCustomEditData",value:function e(t,i){var r={};var a=this.getSettingValue("templateIdMask","");for(var o in t){if(t.hasOwnProperty(o)){if(n.Type.isStringFilled(t[o])&&t[o].indexOf(a)>=0){r[o]=t[o].replace(new RegExp(a,"g"),i)}else if(n.Type.isPlainObject(t[o])){r[o]=this.prepareCustomEditData(t[o],i)}else{r[o]=t[o]}}}return r}},{key:"initializeNewProductRow",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var r={};if(i!==null){r=Object.assign(r,i===null||i===void 0?void 0:i.getFields())}else{r=Re(Re({},this.getSettingValue("templateItemFields",{})),{CURRENCY:this.getCurrencyId()})}var a=this.getRowIdPrefix()+t;r.ID=t;r.ROW_ID=t;if(n.Type.isObject(r.IMAGE_INFO)){delete r.IMAGE_INFO.input}var o=new X(a,r,this.getSettingValue("rowSettings",{}),this);if(i instanceof X){this.products.splice(1+this.products.indexOf(i),0,o);o.refreshFieldsLayout()}else if(this.getSettingValue("newRowPosition")==="bottom"){this.products.push(o)}else{this.products.unshift(o)}this.refreshSortFields();this.numerateRows();o.updateUiCurrencyFields();this.updateTotalUiCurrency();return o}},{key:"getProductSelector",value:function e(t){return this.getProductById(t).getSelector()}},{key:"focusProductSelector",value:function e(t){var i=this;requestAnimationFrame((function(){var e;(e=i.getProductSelector(t))===null||e===void 0?void 0:e.searchInDialog().focusName()}))}},{key:"handleOnBeforeProductChange",value:function e(t){var i=t.getData();var r=this.getProductByRowId(i.rowId);if(r){this.getGrid().tableFade();r.resetExternalActions()}}},{key:"handleOnProductChange",value:function e(t){var i=t.getData();var r=this.getProductByRowId(i.rowId);if(r&&i.fields){var n,a;delete i.fields.ID;r.setFields(i.fields);Object.keys(i.fields).forEach((function(e){r.updateFieldValue(e,i.fields[e])}));r.setField("IS_NEW",i.isNew?"Y":"N");(n=r.getSelector())===null||n===void 0?void 0:n.layout();(a=r.getBarcodeSelector())===null||a===void 0?void 0:a.layout();r.updateProductStoreValues();r.initHandlersForSelectors();r.executeExternalActions();this.getGrid().tableUnfade()}else{this.getGrid().tableUnfade()}}},{key:"handleOnProductClear",value:function e(t){var i=t.getData(),r=i.selectorId,n=i.rowId;var a=this.getProductByRowId(n);if(a&&a.getSelector().getId()===r){var o;a.initHandlersForSelectors();a.setMeasure(this.getDefaultMeasure());a.changePurchasingPrice(0);a.changeBasePrice(0);a.changeAmount(0);a.updateUiStoreValues();a.updateProductStoreValues();a.changeBarcode("");(o=a.getBarcodeSelector())===null||o===void 0?void 0:o.setConfig("ENABLE_SEARCH",true).layout();a.executeExternalActions()}}},{key:"compileProductData",value:function e(){if(!this.isExistForm()){return}this.initFormFields();var t=this.getDataField();var i=this.getDataSettingsField();this.cleanProductRows();if(n.Type.isElementNode(t)&&n.Type.isElementNode(i)){t.value=this.prepareProductDataValue()}}},{key:"prepareProductDataValue",value:function e(){var t="";if(this.getProductCount()){var i=[];this.products.forEach((function(e){var t=e.getFields();if(!/^[0-9]+$/.test(t["ID"])){t["ID"]=0}t["CUSTOMIZED"]="Y";i.push(t)}));t=JSON.stringify(i)}return t}},{key:"executeActions",value:function e(t){if(!n.Type.isArrayFilled(t)){return}var i=_e(t),r;try{for(i.s();!(r=i.n()).done;){var a=r.value;if(!n.Type.isPlainObject(a)||!n.Type.isStringFilled(a.type)){continue}switch(a.type){case this.actions.productChange:this.actionSendProductChange(a);break;case this.actions.productListChanged:this.actionSendProductListChanged();break;case this.actions.updateTotal:this.actionUpdateTotalData();break}}}catch(e){i.e(e)}finally{i.f()}}},{key:"actionSendProductChange",value:function e(t){if(!n.Type.isStringFilled(t.id)){return}var i=this.getProductByRowId(t.id);if(!i){return}if(this.controller){this.controller.productChange()}}},{key:"actionSendProductListChanged",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(this.controller){this.controller.productChange(t)}}},{key:"actionUpdateListField",value:function e(t){if(!n.Type.isStringFilled(t.field)||!("value"in t)){return}this.updateFieldForList=t.field;var i=_e(this.products),r;try{for(i.s();!(r=i.n()).done;){var a=r.value;a.updateFieldByName(t.field,t.value)}}catch(e){i.e(e)}finally{i.f()}this.updateFieldForList=null}},{key:"actionUpdateTotalData",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.updateTotalDataDelayedHandler(t)}},{key:"updateTotalDataDelayed",value:function e(){var t=0;var i=this.getSettingValue("totalCalculationSumField","PURCHASING_PRICE");this.products.forEach((function(e){return t+=n.Text.toNumber(e.getField(i))*n.Text.toNumber(e.getField("AMOUNT"))}));this.setTotalData({totalCost:t})}},{key:"getProductsFields",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var i=[];var r=_e(this.products),n;try{for(r.s();!(n=r.n()).done;){var a=n.value;i.push(a.getFields(t))}}catch(e){r.e(e)}finally{r.f()}return i}},{key:"setTotalData",value:function e(t){var i;var r=BX(this.getSettingValue("totalBlockContainerId",null));if(n.Type.isElementNode(r)){var a=this.getCurrencyId();var s=["totalCost"];for(var l=0,u=s;l<u.length;l++){var d=u[l];var c=r.querySelector('[data-total="'+d+'"]');if(n.Type.isElementNode(c)&&d in t){c.innerHTML=o.CurrencyCore.currencyFormat(t[d],a,false)}}}(i=this.controller)===null||i===void 0?void 0:i.setTotal(t)}},{key:"ajaxResultCommonCheck",value:function e(t){if(!n.Type.isPlainObject(t)){return false}if(!n.Type.isStringFilled(t.status)){return false}if(t.status!=="success"){return false}if(!n.Type.isPlainObject(t.data)){return false}if(!n.Type.isStringFilled(t.data.action)){return false}if(!("result"in t.data)){return false}return true}},{key:"deleteRow",value:function e(t){var i=this.getGrid().getRows().getById(t.getField("ID"));if(i){n.Dom.remove(i.getNode());this.getGrid().getRows().reset()}var r=this.products.indexOf(t);if(r>-1){this.products.splice(r,1);this.refreshSortFields();this.numerateRows()}a.EventEmitter.emit("Grid::thereEditedRows",[]);this.addFirstRowIfEmpty();this.executeActions([{type:this.actions.productListChanged},{type:this.actions.updateTotal}])}},{key:"copyRow",value:function e(t){this.addProductRow(t);this.refreshSortFields();this.numerateRows();a.EventEmitter.emit("Grid::thereEditedRows",[]);this.executeActions([{type:this.actions.productListChanged},{type:this.actions.updateTotal}])}},{key:"cleanProductRows",value:function e(){var t=this;this.products.filter((function(e){return e.isEmptyRow()})).forEach((function(e){return t.deleteRow(e)}))}},{key:"resortProductsByIds",value:function e(t){var i=false;if(n.Type.isArrayFilled(t)){this.products.sort((function(e,r){if(t.indexOf(e.getField("ID"))>t.indexOf(r.getField("ID"))){return 1}i=true;return-1}))}return i}},{key:"refreshSortFields",value:function e(){this.products.forEach((function(e,t){return e.setField("SORT",(t+1)*10,false)}))}},{key:"handleOnTabShow",value:function e(){a.EventEmitter.emit("onDemandRecalculateWrapper")}},{key:"closeBarcodeSpotlights",value:function e(){this.products.forEach((function(e){var t;(t=e.getBarcodeSelector())===null||t===void 0?void 0:t.removeSpotlight()}));this.setSettingValue("showBarcodeSpotlightInfo",false)}},{key:"closeBarcodeQrAuths",value:function e(){this.products.forEach((function(e){var t;(t=e.getBarcodeSelector())===null||t===void 0?void 0:t.removeQrAuth()}));this.setSettingValue("showBarcodeQrAuth",false)}},{key:"validate",value:function e(){if(this.getProductCount()===0){return[n.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_IS_EMPTY")]}var t=[];this.products.forEach((function(e){t=t.concat(e.validate())}));return t}}]);return e}();function xe(){this.getGrid()._clickOnRowActionsButton=function(){}}function Ve(){return this.products.filter((function(e){return e.getModel().getErrorCollection().hasErrors()})).length>0}e.Editor=Le;e.PageEventsManager=ie})(this.BX.Catalog.Store.ProductList=this.BX.Catalog.Store.ProductList||{},BX,BX.Catalog,BX.Main,BX,BX.Event,BX.Currency,BX.Catalog,BX.Catalog.DocumentCard,BX.Catalog);
//# sourceMappingURL=script.map.js