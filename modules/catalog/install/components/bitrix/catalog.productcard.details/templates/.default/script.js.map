{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { Loc, Reflection } from 'main.core';\nimport { EntityCard } from 'catalog.entity-card';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { MenuManager, Popup } from 'main.popup';\nimport { Button } from 'ui.buttons';\n\nclass ProductCard extends EntityCard\n{\n\t#isQuantityTraceNoticeShown = false;\n\n\tconstructor(id, settings = {})\n\t{\n\t\tsuper(id, settings);\n\n\t\tthis.initDocumentTypeSelector();\n\t}\n\n\tgetEntityType()\n\t{\n\t\treturn 'Product';\n\t}\n\n\tonSectionLayout(event: BaseEvent)\n\t{\n\t\tconst [section, eventData] = event.getCompatData();\n\n\t\tif (eventData.id === 'catalog_parameters')\n\t\t{\n\t\t\teventData.visible = this.isSimpleProduct && this.isCardSettingEnabled('CATALOG_PARAMETERS');\n\t\t}\n\n\t\tEventEmitter.subscribe('BX.UI.EntityEditorList:onItemSelect', (event) => {\n\t\t\tconst isQuantityTraceRestricted = !(this.isWithOrdersMode && !this.isInventoryManagementUsed);\n\t\t\tif (this.#isQuantityTraceNoticeShown || !isQuantityTraceRestricted)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst field = event.getData()[1]?.field;\n\t\t\tif (!field)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (field.getId() !== 'QUANTITY_TRACE' || field._selectedValue !== 'N')\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst popup = new Popup({\n\t\t\t\tcontent: Loc.getMessage('CPD_QUANTITY_TRACE_NOTICE'),\n\t\t\t\toverlay: true,\n\t\t\t\ttitleBar: Loc.getMessage('CPD_QUANTITY_TRACE_NOTICE_TITLE'),\n\t\t\t\tcloseByEsc: true,\n\t\t\t\tcloseIcon: true,\n\t\t\t\tbuttons: [\n\t\t\t\t\tnew Button({\n\t\t\t\t\t\ttext: Loc.getMessage('CPD_QUANTITY_TRACE_ACCEPT'),\n\t\t\t\t\t\tclassName: 'ui-btn ui-btn-md ui-btn-primary',\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\tclick: (function()\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tthis.#isQuantityTraceNoticeShown = false;\n\t\t\t\t\t\t\t\tpopup.destroy();\n\t\t\t\t\t\t\t}).bind(this),\n\t\t\t\t\t\t}\n\t\t\t\t\t}),\n\t\t\t\t],\n\t\t\t\tevents: {\n\t\t\t\t\tonAfterClose: (function () {\n\t\t\t\t\t\tthis.#isQuantityTraceNoticeShown = false;\n\t\t\t\t\t}).bind(this),\n\t\t\t\t}\n\t\t\t});\n\t\t\tpopup.show();\n\n\t\t\tthis.#isQuantityTraceNoticeShown = true;\n\t\t});\n\n\t\tsection?.getChildren().forEach((field) => {\n\t\t\tif (this.hiddenFields.includes(field?.getId()))\n\t\t\t{\n\t\t\t\tfield.setVisible(false);\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('onEntityUpdate', (event) => {\n\t\t\tconst editor = event.getData()[0]?.sender;\n\t\t\tif (!editor)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst quantityTraceValue = editor._model.getField('QUANTITY_TRACE', 'D');\n\t\t\tconst isQuantityTraceRestricted = !(this.isWithOrdersMode && !this.isInventoryManagementUsed);\n\t\t\tif (quantityTraceValue !== 'N' && isQuantityTraceRestricted)\n\t\t\t{\n\t\t\t\teditor.getControlById('QUANTITY_TRACE')?.setVisible(false);\n\t\t\t}\n\t\t});\n\t}\n\n\tonGridUpdatedHandler(event: BaseEvent)\n\t{\n\t\tsuper.onGridUpdatedHandler(event);\n\n\t\tconst [grid] = event.getCompatData();\n\t\tif ((grid && grid.getId() === this.getVariationGridId()) && (grid.getRows().getCountDisplayed() <= 0))\n\t\t{\n\t\t\tdocument.location.reload();\n\t\t}\n\t}\n\n\tonEditorAjaxSubmit(event: BaseEvent)\n\t{\n\t\tsuper.onEditorAjaxSubmit(event);\n\n\t\tconst [, response] = event.getCompatData();\n\n\t\tif (response.data)\n\t\t{\n\t\t\tif (response.data.NOTIFY_ABOUT_NEW_VARIATION)\n\t\t\t{\n\t\t\t\tthis.showNotification(Loc.getMessage('CPD_NEW_VARIATION_ADDED'));\n\t\t\t}\n\t\t}\n\t}\n\n\tinitDocumentTypeSelector()\n\t{\n\t\tlet productTypeSelector = document.getElementById(this.settings.productTypeSelector);\n\t\tlet productTypeSelectorTypes = this.settings.productTypeSelectorTypes;\n\n\t\tif (!productTypeSelector || !productTypeSelectorTypes)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet menuItems = [];\n\n\t\tObject.keys(productTypeSelectorTypes).forEach((type) => {\n\t\t\tmenuItems.push({\n\t\t\t\ttext: productTypeSelectorTypes[type],\n\t\t\t\tonclick: (e) => {\n\t\t\t\t\tlet slider = BX.SidePanel.Instance.getTopSlider();\n\t\t\t\t\tif (slider)\n\t\t\t\t\t{\n\t\t\t\t\t\tslider.url = BX.Uri.addParam(slider.getUrl(), { productTypeId: type });\n\t\t\t\t\t\tslider.requestMethod = 'post';\n\n\t\t\t\t\t\tslider.setFrameSrc();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\n\t\tlet popupMenu = MenuManager.create({\n\t\t\tid: 'productcard-product-type-selector',\n\t\t\tbindElement: productTypeSelector,\n\t\t\titems: menuItems,\n\t\t\tminWidth: productTypeSelector.offsetWidth,\n\t\t});\n\n\t\tproductTypeSelector.addEventListener('click', e => {\n\t\t\te.preventDefault();\n\t\t\tpopupMenu.show();\n\t\t});\n\t}\n}\n\nReflection.namespace('BX.Catalog').ProductCard = ProductCard;\n"],"names":["ProductCard","id","settings","initDocumentTypeSelector","event","getCompatData","section","eventData","visible","isSimpleProduct","isCardSettingEnabled","EventEmitter","subscribe","isQuantityTraceRestricted","isWithOrdersMode","isInventoryManagementUsed","field","getData","getId","_selectedValue","popup","Popup","content","Loc","getMessage","overlay","titleBar","closeByEsc","closeIcon","buttons","Button","text","className","events","click","destroy","bind","onAfterClose","show","getChildren","forEach","hiddenFields","includes","setVisible","editor","sender","quantityTraceValue","_model","getField","getControlById","grid","getVariationGridId","getRows","getCountDisplayed","document","location","reload","response","data","NOTIFY_ABOUT_NEW_VARIATION","showNotification","productTypeSelector","getElementById","productTypeSelectorTypes","menuItems","Object","keys","type","push","onclick","e","slider","BX","SidePanel","Instance","getTopSlider","url","Uri","addParam","getUrl","productTypeId","requestMethod","setFrameSrc","popupMenu","MenuManager","create","bindElement","items","minWidth","offsetWidth","addEventListener","preventDefault","EntityCard","Reflection","namespace"],"mappings":"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"}