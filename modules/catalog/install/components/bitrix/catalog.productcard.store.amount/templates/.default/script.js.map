{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {Event, Reflection, Type, Uri} from 'main.core';\nimport {EventEmitter} from 'main.core.events'\nimport {Slider} from 'catalog.store-use'\n\nclass ProductStoreGridManager\n{\n\tgrid = null;\n\ttotalWrapper = null;\n\n\tconstructor(settings = {})\n\t{\n\t\tthis.gridId = settings.gridId;\n\t\tthis.grid = BX.Main.gridManager.getInstanceById(this.gridId);\n\t\tthis.signedParameters = settings.signedParameters;\n\t\tthis.totalWrapperId = settings.totalWrapperId || null;\n\t\tthis.inventoryManagementLink = settings.inventoryManagementLink || null;\n\t\tthis.productId = settings.productId;\n\t\tthis.reservedDealsSliderLink = settings.reservedDealsSliderLink;\n\n\t\tif (this.totalWrapperId)\n\t\t{\n\t\t\tthis.totalWrapper = BX(this.totalWrapperId);\n\t\t\tthis.refreshTotalWrapper();\n\t\t}\n\n\t\tthis.subscribeEvents();\n\t\tthis.bindSliderToReservedQuantityNodes();\n\t}\n\n\tsubscribeEvents()\n\t{\n\t\tthis.onGridUpdatedHandler = this.onGridUpdated.bind(this);\n\t\tEventEmitter.subscribe('Grid::updated', this.onGridUpdatedHandler);\n\t}\n\n\tbindSliderToReservedQuantityNodes()\n\t{\n\t\tconst rows = this.grid.getRows().getRows();\n\t\trows.forEach((row) => {\n\t\t\tif (row.isBodyChild() && !row.isTemplate())\n\t\t\t{\n\t\t\t\tconst reservedQuantityNode = row.getNode().querySelector(\n\t\t\t\t\t'.main-grid-cell-content-store-amount-reserved-quantity'\n\t\t\t\t);\n\t\t\t\tif (Type.isDomNode(reservedQuantityNode))\n\t\t\t\t{\n\t\t\t\t\tEvent.bind(\n\t\t\t\t\t\treservedQuantityNode,\n\t\t\t\t\t\t'click',\n\t\t\t\t\t\tthis.openDealsWithReservedProductSlider.bind(this, this.productId, row.getId())\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\topenDealsWithReservedProductSlider(rowId, storeId = 0)\n\t{\n\t\tif (!this.reservedDealsSliderLink)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst sliderLink = new Uri(this.reservedDealsSliderLink);\n\t\tsliderLink.setQueryParam('productId', rowId);\n\t\tif (storeId > 0)\n\t\t{\n\t\t\tsliderLink.setQueryParam('storeId', storeId);\n\t\t}\n\t\tBX.SidePanel.Instance.open(sliderLink.toString(), {\n\t\t\tallowChangeHistory: false,\n\t\t\tcacheable: false\n\t\t});\n\t}\n\n\tonGridUpdated(event: BaseEvent)\n\t{\n\t\tconst [grid, eventArgs] = event.getCompatData();\n\n\t\tif (!grid || grid.getId() !== this.getGridId())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.refreshTotalWrapper();\n\t}\n\n\tgetGridId()\n\t{\n\t\treturn this.gridId;\n\t}\n\n\treloadGrid()\n\t{\n\t\tif (this.grid)\n\t\t{\n\t\t\tthis.grid.reload();\n\t\t}\n\t}\n\n\tsetTotalData(totalData)\n\t{\n\t\tfor (var propertyId in totalData)\n\t\t{\n\t\t\tif (totalData.hasOwnProperty(propertyId))\n\t\t\t{\n\t\t\t\tthis.setTotalDataBySelector(`#${propertyId}`, totalData[propertyId]);\n\t\t\t}\n\t\t}\n\t}\n\n\tsetTotalDataBySelector(selector, data)\n\t{\n\t\tif (this.totalWrapper)\n\t\t{\n\t\t\tvar totalWrapperItem = this.totalWrapper.querySelector(selector);\n\n\t\t\tif (totalWrapperItem)\n\t\t\t{\n\t\t\t\ttotalWrapperItem.innerHTML = data;\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\thideTotalData()\n\t{\n\t\tBX.hide(this.totalWrapper);\n\t}\n\n\tshowTotalData()\n\t{\n\t\tBX.show(this.totalWrapper);\n\t}\n\n\trefreshTotalWrapper()\n\t{\n\t\tif (this.totalWrapper)\n\t\t{\n\t\t\t//this.grid.tableFade();\n\t\t\tBX.ajax.runComponentAction(\n\t\t\t\t'bitrix:catalog.productcard.store.amount',\n\t\t\t\t'getStoreAmountTotal',\n\t\t\t\t{\n\t\t\t\t\tmode: 'ajax',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tsignedParameters: this.signedParameters,\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t).then(response => {\n\t\t\t\tconst amount = response.data.AMOUNT || '';\n\t\t\t\tconst quantity = response.data.QUANTITY || '';\n\t\t\t\tconst quantityReserved = response.data.QUANTITY_RESERVED || '';\n\t\t\t\tconst quantityCommon = response.data.QUANTITY_COMMON || '';\n\n\t\t\t\tif (amount || quantity || quantityCommon || quantityReserved)\n\t\t\t\t{\n\t\t\t\t\tvar totalData = {\n\t\t\t\t\t\t'total_amount': amount,\n\t\t\t\t\t\t'total_quantity': quantity,\n\t\t\t\t\t\t'total_quantity_common': quantityCommon,\n\t\t\t\t\t\t'total_quantity_reserved': quantityReserved,\n\t\t\t\t\t};\n\n\t\t\t\t\tthis.setTotalData(totalData);\n\n\t\t\t\t\tif (BX.isNodeHidden(this.totalWrapper))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.showTotalData();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.hideTotalData();\n\t\t\t\t}\n\t\t\t\t//this.grid.tableUnfade();\n\t\t\t});\n\t\t}\n\t}\n\n\topenInventoryManagementSlider()\n\t{\n\t\tif (this.inventoryManagementLink)\n\t\t{\n\t\t\tnew Slider().open(this.inventoryManagementLink,\n\t\t\t\t{\n\t\t\t\t\tdata: {\n\t\t\t\t\t\topenGridOnDone: false,\n\t\t\t\t\t},\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tonCloseComplete: function(event) {\n\t\t\t\t\t\t\tlet slider = event.getSlider();\n\t\t\t\t\t\t\tif (!slider)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (slider.getData().get('isInventoryManagementEnabled'))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\twindow.top.location.reload();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t);\n\t\t}\n\t}\n}\n\nReflection.namespace('BX.Catalog').ProductStoreGridManager = ProductStoreGridManager;"],"names":["ProductStoreGridManager","settings","gridId","grid","BX","Main","gridManager","getInstanceById","signedParameters","totalWrapperId","inventoryManagementLink","productId","reservedDealsSliderLink","totalWrapper","refreshTotalWrapper","subscribeEvents","bindSliderToReservedQuantityNodes","onGridUpdatedHandler","onGridUpdated","bind","EventEmitter","subscribe","rows","getRows","forEach","row","isBodyChild","isTemplate","reservedQuantityNode","getNode","querySelector","Type","isDomNode","Event","openDealsWithReservedProductSlider","getId","rowId","storeId","sliderLink","Uri","setQueryParam","SidePanel","Instance","open","toString","allowChangeHistory","cacheable","event","getCompatData","eventArgs","getGridId","reload","totalData","propertyId","hasOwnProperty","setTotalDataBySelector","selector","data","totalWrapperItem","innerHTML","hide","show","ajax","runComponentAction","mode","then","response","amount","AMOUNT","quantity","QUANTITY","quantityReserved","QUANTITY_RESERVED","quantityCommon","QUANTITY_COMMON","setTotalData","isNodeHidden","showTotalData","hideTotalData","Slider","openGridOnDone","events","onCloseComplete","slider","getSlider","getData","get","window","top","location","Reflection","namespace"],"mappings":";;;KAIMA;CAKL,qCACA;CAAA,QADYC,QACZ,uEADuB,EACvB;CAAA;CAAA,8CAJO,IAIP;CAAA,sDAHe,IAGf;CACC,SAAKC,MAAL,GAAcD,QAAQ,CAACC,MAAvB;CACA,SAAKC,IAAL,GAAYC,EAAE,CAACC,IAAH,CAAQC,WAAR,CAAoBC,eAApB,CAAoC,KAAKL,MAAzC,CAAZ;CACA,SAAKM,gBAAL,GAAwBP,QAAQ,CAACO,gBAAjC;CACA,SAAKC,cAAL,GAAsBR,QAAQ,CAACQ,cAAT,IAA2B,IAAjD;CACA,SAAKC,uBAAL,GAA+BT,QAAQ,CAACS,uBAAT,IAAoC,IAAnE;CACA,SAAKC,SAAL,GAAiBV,QAAQ,CAACU,SAA1B;CACA,SAAKC,uBAAL,GAA+BX,QAAQ,CAACW,uBAAxC;;CAEA,QAAI,KAAKH,cAAT,EACA;CACC,WAAKI,YAAL,GAAoBT,EAAE,CAAC,KAAKK,cAAN,CAAtB;CACA,WAAKK,mBAAL;CACA;;CAED,SAAKC,eAAL;CACA,SAAKC,iCAAL;CACA;;;;uCAGD;CACC,WAAKC,oBAAL,GAA4B,KAAKC,aAAL,CAAmBC,IAAnB,CAAwB,IAAxB,CAA5B;CACAC,MAAAA,6BAAY,CAACC,SAAb,CAAuB,eAAvB,EAAwC,KAAKJ,oBAA7C;CACA;;;yDAGD;CAAA;;CACC,UAAMK,IAAI,GAAG,KAAKnB,IAAL,CAAUoB,OAAV,GAAoBA,OAApB,EAAb;CACAD,MAAAA,IAAI,CAACE,OAAL,CAAa,UAACC,GAAD,EAAS;CACrB,YAAIA,GAAG,CAACC,WAAJ,MAAqB,CAACD,GAAG,CAACE,UAAJ,EAA1B,EACA;CACC,cAAMC,oBAAoB,GAAGH,GAAG,CAACI,OAAJ,GAAcC,aAAd,CAC5B,wDAD4B,CAA7B;;CAGA,cAAIC,cAAI,CAACC,SAAL,CAAeJ,oBAAf,CAAJ,EACA;CACCK,YAAAA,eAAK,CAACd,IAAN,CACCS,oBADD,EAEC,OAFD,EAGC,KAAI,CAACM,kCAAL,CAAwCf,IAAxC,CAA6C,KAA7C,EAAmD,KAAI,CAACR,SAAxD,EAAmEc,GAAG,CAACU,KAAJ,EAAnE,CAHD;CAKA;CACD;CACD,OAfD;CAgBA;;;wDAEkCC,OACnC;CAAA,UAD0CC,OAC1C,uEADoD,CACpD;;CACC,UAAI,CAAC,KAAKzB,uBAAV,EACA;CACC;CACA;;CAED,UAAM0B,UAAU,GAAG,IAAIC,aAAJ,CAAQ,KAAK3B,uBAAb,CAAnB;CACA0B,MAAAA,UAAU,CAACE,aAAX,CAAyB,WAAzB,EAAsCJ,KAAtC;;CACA,UAAIC,OAAO,GAAG,CAAd,EACA;CACCC,QAAAA,UAAU,CAACE,aAAX,CAAyB,SAAzB,EAAoCH,OAApC;CACA;;CACDjC,MAAAA,EAAE,CAACqC,SAAH,CAAaC,QAAb,CAAsBC,IAAtB,CAA2BL,UAAU,CAACM,QAAX,EAA3B,EAAkD;CACjDC,QAAAA,kBAAkB,EAAE,KAD6B;CAEjDC,QAAAA,SAAS,EAAE;CAFsC,OAAlD;CAIA;;;mCAEaC,OACd;CAAA,iCAC2BA,KAAK,CAACC,aAAN,EAD3B;CAAA;CAAA,UACQ7C,IADR;CAAA,UACc8C,SADd;;CAGC,UAAI,CAAC9C,IAAD,IAASA,IAAI,CAACgC,KAAL,OAAiB,KAAKe,SAAL,EAA9B,EACA;CACC;CACA;;CAED,WAAKpC,mBAAL;CACA;;;iCAGD;CACC,aAAO,KAAKZ,MAAZ;CACA;;;kCAGD;CACC,UAAI,KAAKC,IAAT,EACA;CACC,aAAKA,IAAL,CAAUgD,MAAV;CACA;CACD;;;kCAEYC,WACb;CACC,WAAK,IAAIC,UAAT,IAAuBD,SAAvB,EACA;CACC,YAAIA,SAAS,CAACE,cAAV,CAAyBD,UAAzB,CAAJ,EACA;CACC,eAAKE,sBAAL,YAAgCF,UAAhC,GAA8CD,SAAS,CAACC,UAAD,CAAvD;CACA;CACD;CACD;;;4CAEsBG,UAAUC,MACjC;CACC,UAAI,KAAK5C,YAAT,EACA;CACC,YAAI6C,gBAAgB,GAAG,KAAK7C,YAAL,CAAkBiB,aAAlB,CAAgC0B,QAAhC,CAAvB;;CAEA,YAAIE,gBAAJ,EACA;CACCA,UAAAA,gBAAgB,CAACC,SAAjB,GAA6BF,IAA7B;CACA,iBAAO,IAAP;CACA;CACD;;CACD,aAAO,KAAP;CACA;;;qCAGD;CACCrD,MAAAA,EAAE,CAACwD,IAAH,CAAQ,KAAK/C,YAAb;CACA;;;qCAGD;CACCT,MAAAA,EAAE,CAACyD,IAAH,CAAQ,KAAKhD,YAAb;CACA;;;2CAGD;CAAA;;CACC,UAAI,KAAKA,YAAT,EACA;CACC;CACAT,QAAAA,EAAE,CAAC0D,IAAH,CAAQC,kBAAR,CACC,yCADD,EAEC,qBAFD,EAGC;CACCC,UAAAA,IAAI,EAAE,MADP;CAECP,UAAAA,IAAI,EAAE;CACLjD,YAAAA,gBAAgB,EAAE,KAAKA;CADlB;CAFP,SAHD,EASEyD,IATF,CASO,UAAAC,QAAQ,EAAI;CAClB,cAAMC,MAAM,GAAGD,QAAQ,CAACT,IAAT,CAAcW,MAAd,IAAwB,EAAvC;CACA,cAAMC,QAAQ,GAAGH,QAAQ,CAACT,IAAT,CAAca,QAAd,IAA0B,EAA3C;CACA,cAAMC,gBAAgB,GAAGL,QAAQ,CAACT,IAAT,CAAce,iBAAd,IAAmC,EAA5D;CACA,cAAMC,cAAc,GAAGP,QAAQ,CAACT,IAAT,CAAciB,eAAd,IAAiC,EAAxD;;CAEA,cAAIP,MAAM,IAAIE,QAAV,IAAsBI,cAAtB,IAAwCF,gBAA5C,EACA;CACC,gBAAInB,SAAS,GAAG;CACf,8BAAgBe,MADD;CAEf,gCAAkBE,QAFH;CAGf,uCAAyBI,cAHV;CAIf,yCAA2BF;CAJZ,aAAhB;;CAOA,YAAA,MAAI,CAACI,YAAL,CAAkBvB,SAAlB;;CAEA,gBAAIhD,EAAE,CAACwE,YAAH,CAAgB,MAAI,CAAC/D,YAArB,CAAJ,EACA;CACC,cAAA,MAAI,CAACgE,aAAL;CACA;CACD,WAfD,MAiBA;CACC,YAAA,MAAI,CAACC,aAAL;CACA,WAzBiB;;CA2BlB,SApCD;CAqCA;CACD;;;qDAGD;CACC,UAAI,KAAKpE,uBAAT,EACA;CACC,YAAIqE,uBAAJ,GAAapC,IAAb,CAAkB,KAAKjC,uBAAvB,EACC;CACC+C,UAAAA,IAAI,EAAE;CACLuB,YAAAA,cAAc,EAAE;CADX,WADP;CAICC,UAAAA,MAAM,EAAE;CACPC,YAAAA,eAAe,EAAE,yBAASnC,KAAT,EAAgB;CAChC,kBAAIoC,MAAM,GAAGpC,KAAK,CAACqC,SAAN,EAAb;;CACA,kBAAI,CAACD,MAAL,EACA;CACC;CACA;;CAED,kBAAIA,MAAM,CAACE,OAAP,GAAiBC,GAAjB,CAAqB,8BAArB,CAAJ,EACA;CACCC,gBAAAA,MAAM,CAACC,GAAP,CAAWC,QAAX,CAAoBtC,MAApB;CACA;CACD;CAZM;CAJT,SADD;CAqBA;CACD;;;;;AAGFuC,qBAAU,CAACC,SAAX,CAAqB,YAArB,EAAmC3F,uBAAnC,GAA6DA,uBAA7D;;;;"}