{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {ajax, Reflection, Runtime, Text, Type} from 'main.core';\nimport {type BaseEvent, EventEmitter} from 'main.core.events';\n\nclass ImageInput\n{\n\tonUploaderIsInitedHandler = this.handleOnUploaderIsInited.bind(this);\n\n\tvalues = new Map();\n\tnewValues = new Map();\n\n\tstatic imageInputInstances = new Map();\n\n\tstatic PROCESS_STATUS = 'PROCESS';\n\tstatic WAIT_STATUS = 'WAIT';\n\n\tstatic getById(id: string): ?ImageInput\n\t{\n\t\treturn ImageInput.imageInputInstances.get(id) || null;\n\t}\n\n\tconstructor(id, options = {})\n\t{\n\t\tthis.id = id;\n\t\tthis.wrapper = BX(id);\n\t\tif (!this.wrapper)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tthis.productId = options.productId;\n\t\tthis.skuId = options.skuId;\n\t\tthis.iblockId = options.iblockId;\n\t\tthis.saveable = options.saveable;\n\t\tthis.inputId = options.inputId;\n\t\tthis.ajaxStatus = ImageInput.WAIT_STATUS;\n\t\tif (options.hideAddButton === true)\n\t\t{\n\t\t\tconst addButton = this.wrapper.querySelector('[data-role=\"image-add-button\"]');\n\t\t\tif (Type.isDomNode(addButton))\n\t\t\t{\n\t\t\t\taddButton.style.display = 'none';\n\t\t\t}\n\t\t}\n\n\t\tif (Type.isObject(options.values))\n\t\t{\n\t\t\tfor (const key in options.values)\n\t\t\t{\n\t\t\t\tif (!options.values.hasOwnProperty(key))\n\t\t\t\t{\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tthis.values.set(key, options.values[key]);\n\t\t\t}\n\t\t}\n\n\t\tif (this.isSaveable())\n\t\t{\n\t\t\tEventEmitter.subscribe('onUploaderIsInited', this.onUploaderIsInitedHandler);\n\t\t}\n\n\t\tImageInput.imageInputInstances.set(this.id, this);\n\t}\n\n\tisSaveable()\n\t{\n\t\treturn (this.saveable === true);\n\t}\n\n\thandleOnUploaderIsInited(event)\n\t{\n\t\tconst [id, uploader] = event.getCompatData();\n\t\tif (Type.isStringFilled(this.inputId) && this.inputId === id)\n\t\t{\n\t\t\tthis.uploaderFieldMap = new Map();\n\t\t\tEventEmitter.subscribe(uploader, 'onFileIsDeleted', this.onFileDelete.bind(this));\n\t\t\tEventEmitter.subscribe(uploader, 'onFileIsUploaded', this.onFileUpload.bind(this));\n\t\t\tEventEmitter.subscribe(uploader, 'onDone', this.onDone.bind(this));\n\t\t\tEventEmitter.subscribe(uploader, 'onQueueIsChanged', this.onQueueIsChanged.bind(this));\n\t\t}\n\t}\n\n\tunsubscribeEvents()\n\t{\n\t\tif (this.isSaveable())\n\t\t{\n\t\t\tEventEmitter.unsubscribe('onUploaderIsInited', this.onUploaderIsInitedHandler);\n\t\t}\n\t}\n\n\tunsubscribeImageInputEvents()\n\t{\n\t\tif (Reflection.getClass('BX.UI.ImageInput'))\n\t\t{\n\t\t\tconst imageInput = BX.UI.ImageInput.getById(this.inputId);\n\t\t\tif (imageInput)\n\t\t\t{\n\t\t\t\timageInput.unsubscribeEvents();\n\t\t\t}\n\t\t}\n\t}\n\n\tgetId()\n\t{\n\t\treturn this.id;\n\t}\n\n\tsetId(id)\n\t{\n\t\tthis.id = id;\n\t}\n\n\tonFileDelete(event: BaseEvent)\n\t{\n\t\tconst [, , , file] = event.getCompatData();\n\t\tconst inputName = file.input_name;\n\n\t\tif (Type.isNil(inputName))\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tthis.values.delete(inputName);\n\t\tif (this.isSaveable())\n\t\t{\n\t\t\tthis.save();\n\t\t}\n\t}\n\n\tonQueueIsChanged(event: BaseEvent)\n\t{\n\t\tconst [, type, itemId, uploaderItem] = event.getCompatData();\n\t\tconst image = uploaderItem.file;\n\n\t\tif (\n\t\t\ttype === 'add'\n\t\t\t&& 'input_name' in image\n\t\t\t&& Type.isNil(this.uploaderFieldMap.get(itemId))\n\t\t)\n\t\t{\n\t\t\tthis.uploaderFieldMap.set(itemId, image['input_name']);\n\t\t}\n\t}\n\n\tonDone()\n\t{\n\t\tif (this.newValues.size > 0 && this.isSaveable())\n\t\t{\n\t\t\tthis.save();\n\t\t}\n\n\t\tthis.newValues.clear();\n\t}\n\n\tonFileUpload(event: BaseEvent)\n\t{\n\t\tconst [itemId, , params] = event.getCompatData();\n\n\t\tif (\n\t\t\t!this.isSaveable()\n\t\t\t|| !Type.isObject(params)\n\t\t\t|| !('file' in params)\n\t\t\t|| !('files' in params.file)\n\t\t\t|| !('default' in params.file.files)\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst currentUploadedFile = params['file']['files']['default'];\n\t\tconst photoItem = {\n\t\t\tfileId: itemId,\n\t\t\tdata: {\n\t\t\t\tname: currentUploadedFile.name,\n\t\t\t\ttype: currentUploadedFile.type,\n\t\t\t\ttmp_name: currentUploadedFile.path,\n\t\t\t\tsize: currentUploadedFile.size,\n\t\t\t\terror: null\n\t\t\t}\n\t\t};\n\t\tconst fileFieldName = this.uploaderFieldMap.get(itemId) || itemId;\n\t\tthis.values.set(fileFieldName, photoItem);\n\t\tthis.newValues.set(fileFieldName, photoItem);\n\t}\n\n\tsave()\n\t{\n\t\tif (this.submitFileTimeOut)\n\t\t{\n\t\t\tclearTimeout(this.submitFileTimeOut);\n\t\t}\n\n\t\tconst requestId = Text.getRandom(20);\n\t\tthis.refreshImageSelectorId = requestId;\n\t\tthis.submitFileTimeOut = setTimeout(() => {\n\t\t\tconst values = {};\n\t\t\tthis.values.forEach((file, id) => {\n\t\t\t\tvalues[id] = file;\n\t\t\t});\n\n\t\t\tajax.runAction(\n\t\t\t\t'catalog.productSelector.saveMorePhoto',\n\t\t\t\t{\n\t\t\t\t\tjson: {\n\t\t\t\t\t\tproductId: this.productId,\n\t\t\t\t\t\tvariationId: this.skuId,\n\t\t\t\t\t\tiblockId: this.iblockId,\n\t\t\t\t\t\timageValues: values,\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t).then((response) => {\n\t\t\t\tif (!this.refreshImageSelectorId === requestId)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.values.clear();\n\t\t\t\tif (Type.isObject(response.data?.values))\n\t\t\t\t{\n\t\t\t\t\tfor (const key in response.data.values)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (!response.data.values.hasOwnProperty(key))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.values.set(key, response.data.values[key]);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tRuntime.html(this.wrapper, response.data.input);\n\t\t\t\tEventEmitter.emit( 'Catalog.ImageInput::save', [\n\t\t\t\t\tthis.id,\n\t\t\t\t\tthis.inputId,\n\t\t\t\t\tresponse,\n\t\t\t\t]);\n\t\t\t});\n\t\t}, 500);\n\t}\n}\n\nReflection.namespace('BX.Catalog').ImageInput = ImageInput;"],"names":["ImageInput","id","imageInputInstances","get","options","handleOnUploaderIsInited","bind","Map","wrapper","BX","productId","skuId","iblockId","saveable","inputId","ajaxStatus","WAIT_STATUS","hideAddButton","addButton","querySelector","Type","isDomNode","style","display","isObject","values","key","hasOwnProperty","set","isSaveable","EventEmitter","subscribe","onUploaderIsInitedHandler","event","getCompatData","uploader","isStringFilled","uploaderFieldMap","onFileDelete","onFileUpload","onDone","onQueueIsChanged","unsubscribe","Reflection","getClass","imageInput","UI","getById","unsubscribeEvents","file","inputName","input_name","isNil","save","type","itemId","uploaderItem","image","newValues","size","clear","params","files","currentUploadedFile","photoItem","fileId","data","name","tmp_name","path","error","fileFieldName","submitFileTimeOut","clearTimeout","requestId","Text","getRandom","refreshImageSelectorId","setTimeout","forEach","ajax","runAction","json","variationId","imageValues","then","response","Runtime","html","input","emit","namespace"],"mappings":"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"}