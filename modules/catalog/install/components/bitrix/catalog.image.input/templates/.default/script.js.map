{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import {ajax, Reflection, Runtime, Text, Type} from 'main.core';\nimport {type BaseEvent, EventEmitter} from 'main.core.events';\n\nclass ImageInput\n{\n\tonUploaderIsInitedHandler = this.handleOnUploaderIsInited.bind(this);\n\n\tvalues = new Map();\n\tnewValues = new Map();\n\n\tstatic imageInputInstances = new Map();\n\n\tstatic PROCESS_STATUS = 'PROCESS';\n\tstatic WAIT_STATUS = 'WAIT';\n\n\tstatic getById(id: string): ?ImageInput\n\t{\n\t\treturn ImageInput.imageInputInstances.get(id) || null;\n\t}\n\n\tconstructor(id, options = {})\n\t{\n\t\tthis.id = id;\n\t\tthis.wrapper = BX(id);\n\t\tthis.productId = options.productId;\n\t\tthis.skuId = options.skuId;\n\t\tthis.iblockId = options.iblockId;\n\t\tthis.saveable = options.saveable;\n\t\tthis.inputId = options.inputId;\n\t\tthis.ajaxStatus = ImageInput.WAIT_STATUS;\n\t\tif (options.hideAddButton === true)\n\t\t{\n\t\t\tconst addButton = this.wrapper.querySelector('[data-role=\"image-add-button\"]');\n\t\t\tif (Type.isDomNode(addButton))\n\t\t\t{\n\t\t\t\taddButton.style.display = 'none';\n\t\t\t}\n\t\t}\n\n\t\tif (Type.isObject(options.values))\n\t\t{\n\t\t\tfor (const key in options.values)\n\t\t\t{\n\t\t\t\tif (!options.values.hasOwnProperty(key))\n\t\t\t\t{\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tthis.values.set(key, options.values[key]);\n\t\t\t}\n\t\t}\n\n\t\tif (this.isSaveable())\n\t\t{\n\t\t\tEventEmitter.subscribe('onUploaderIsInited', this.onUploaderIsInitedHandler);\n\t\t}\n\n\t\tImageInput.imageInputInstances.set(this.id, this);\n\t}\n\n\tisSaveable()\n\t{\n\t\treturn (this.saveable === true);\n\t}\n\n\thandleOnUploaderIsInited(event)\n\t{\n\t\tconst [id, uploader] = event.getCompatData();\n\t\tif (Type.isStringFilled(this.inputId) && this.inputId === id)\n\t\t{\n\t\t\tthis.uploaderFieldMap = new Map();\n\t\t\tEventEmitter.subscribe(uploader, 'onFileIsDeleted', this.onFileDelete.bind(this));\n\t\t\tEventEmitter.subscribe(uploader, 'onFileIsUploaded', this.onFileUpload.bind(this));\n\t\t\tEventEmitter.subscribe(uploader, 'onDone', this.onDone.bind(this));\n\t\t\tEventEmitter.subscribe(uploader, 'onQueueIsChanged', this.onQueueIsChanged.bind(this));\n\t\t}\n\t}\n\n\tunsubscribeEvents()\n\t{\n\t\tif (this.isSaveable())\n\t\t{\n\t\t\tEventEmitter.unsubscribe('onUploaderIsInited', this.onUploaderIsInitedHandler);\n\t\t}\n\t}\n\n\tunsubscribeImageInputEvents()\n\t{\n\t\tif (Reflection.getClass('BX.UI.ImageInput'))\n\t\t{\n\t\t\tconst imageInput = BX.UI.ImageInput.getById(this.inputId);\n\t\t\tif (imageInput)\n\t\t\t{\n\t\t\t\timageInput.unsubscribeEvents();\n\t\t\t}\n\t\t}\n\t}\n\n\tgetId()\n\t{\n\t\treturn this.id;\n\t}\n\n\tsetId(id)\n\t{\n\t\tthis.id = id;\n\t}\n\n\tonFileDelete(event: BaseEvent)\n\t{\n\t\tconst [, , , file] = event.getCompatData();\n\t\tconst inputName = file.input_name;\n\n\t\tif (Type.isNil(inputName))\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tthis.values.delete(inputName);\n\t\tif (this.isSaveable())\n\t\t{\n\t\t\tthis.save();\n\t\t}\n\t}\n\n\tonQueueIsChanged(event: BaseEvent)\n\t{\n\t\tconst [, type, itemId, uploaderItem] = event.getCompatData();\n\t\tconst image = uploaderItem.file;\n\n\t\tif (\n\t\t\ttype === 'add'\n\t\t\t&& 'input_name' in image\n\t\t\t&& Type.isNil(this.uploaderFieldMap.get(itemId))\n\t\t)\n\t\t{\n\t\t\tthis.uploaderFieldMap.set(itemId, image['input_name']);\n\t\t}\n\t}\n\n\tonDone()\n\t{\n\t\tif (this.newValues.size > 0 && this.isSaveable())\n\t\t{\n\t\t\tthis.save();\n\t\t}\n\n\t\tthis.newValues.clear();\n\t}\n\n\tonFileUpload(event: BaseEvent)\n\t{\n\t\tconst [itemId, , params] = event.getCompatData();\n\n\t\tif (\n\t\t\t!this.isSaveable()\n\t\t\t|| !Type.isObject(params)\n\t\t\t|| !('file' in params)\n\t\t\t|| !('files' in params.file)\n\t\t\t|| !('default' in params.file.files)\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst currentUploadedFile = params['file']['files']['default'];\n\t\tconst photoItem = {\n\t\t\tfileId: itemId,\n\t\t\tdata: {\n\t\t\t\tname: currentUploadedFile.name,\n\t\t\t\ttype: currentUploadedFile.type,\n\t\t\t\ttmp_name: currentUploadedFile.path,\n\t\t\t\tsize: currentUploadedFile.size,\n\t\t\t\terror: null\n\t\t\t}\n\t\t};\n\t\tconst fileFieldName = this.uploaderFieldMap.get(itemId) || itemId;\n\t\tthis.values.set(fileFieldName, photoItem);\n\t\tthis.newValues.set(fileFieldName, photoItem);\n\t}\n\n\tsave()\n\t{\n\t\tif (this.submitFileTimeOut)\n\t\t{\n\t\t\tclearTimeout(this.submitFileTimeOut);\n\t\t}\n\n\t\tconst requestId = Text.getRandom(20);\n\t\tthis.refreshImageSelectorId = requestId;\n\t\tthis.submitFileTimeOut = setTimeout(() => {\n\t\t\tconst values = {};\n\t\t\tthis.values.forEach((file, id) => {\n\t\t\t\tvalues[id] = file;\n\t\t\t});\n\n\t\t\tajax.runAction(\n\t\t\t\t'catalog.productSelector.saveMorePhoto',\n\t\t\t\t{\n\t\t\t\t\tjson: {\n\t\t\t\t\t\tproductId: this.productId,\n\t\t\t\t\t\tvariationId: this.skuId,\n\t\t\t\t\t\tiblockId: this.iblockId,\n\t\t\t\t\t\timageValues: values,\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t).then((response) => {\n\t\t\t\tif (!this.refreshImageSelectorId === requestId)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.values.clear();\n\t\t\t\tif (Type.isObject(response.data?.values))\n\t\t\t\t{\n\t\t\t\t\tfor (const key in response.data.values)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (!response.data.values.hasOwnProperty(key))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.values.set(key, response.data.values[key]);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tRuntime.html(this.wrapper, response.data.input);\n\t\t\t\tEventEmitter.emit( 'Catalog.ImageInput::save', [\n\t\t\t\t\tthis.id,\n\t\t\t\t\tthis.inputId,\n\t\t\t\t\tresponse,\n\t\t\t\t]);\n\t\t\t});\n\t\t}, 500);\n\t}\n}\n\nReflection.namespace('BX.Catalog').ImageInput = ImageInput;"],"names":["ImageInput","id","imageInputInstances","get","options","handleOnUploaderIsInited","bind","Map","wrapper","BX","productId","skuId","iblockId","saveable","inputId","ajaxStatus","WAIT_STATUS","hideAddButton","addButton","querySelector","Type","isDomNode","style","display","isObject","values","key","hasOwnProperty","set","isSaveable","EventEmitter","subscribe","onUploaderIsInitedHandler","event","getCompatData","uploader","isStringFilled","uploaderFieldMap","onFileDelete","onFileUpload","onDone","onQueueIsChanged","unsubscribe","Reflection","getClass","imageInput","UI","getById","unsubscribeEvents","file","inputName","input_name","isNil","delete","save","type","itemId","uploaderItem","image","newValues","size","clear","params","files","currentUploadedFile","photoItem","fileId","data","name","tmp_name","path","error","fileFieldName","submitFileTimeOut","clearTimeout","requestId","Text","getRandom","refreshImageSelectorId","setTimeout","forEach","ajax","runAction","json","variationId","imageValues","then","response","Runtime","html","input","emit","namespace"],"mappings":"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"}