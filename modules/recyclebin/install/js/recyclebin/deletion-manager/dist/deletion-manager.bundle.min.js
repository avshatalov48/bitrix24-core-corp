this.BX=this.BX||{};(function(e,t,a,s,i,l){"use strict";var r,n;function c(e,t){u(e,t);t.add(e)}function o(e,t,a){u(e,t);t.set(e,a)}function u(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function b(e,t,a){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return a}var h=new WeakMap;var v=new WeakMap;var d=new WeakMap;var p=new WeakMap;var f=new WeakMap;var H=new WeakSet;var P=new WeakSet;var F=new WeakSet;var w=new WeakSet;var m=new WeakSet;var g=function(){function e(t){babelHelpers.classCallCheck(this,e);c(this,m);c(this,w);c(this,F);c(this,P);c(this,H);o(this,h,{writable:true,value:[]});o(this,v,{writable:true,value:void 0});o(this,d,{writable:true,value:void 0});o(this,p,{writable:true,value:void 0});o(this,f,{writable:true,value:void 0});var s=t.entityIds,l=t.containerId,r=t.onAfterTextClick,n=t.messages;babelHelpers.classPrivateFieldSet(this,h,s);babelHelpers.classPrivateFieldSet(this,v,l);babelHelpers.classPrivateFieldSet(this,f,n);var u=b(this,H,y).call(this);if(i.Type.isFunction(r)){u.clickAfterCallback=r}babelHelpers.classPrivateFieldSet(this,d,new a.ProgressBar(u))}babelHelpers.createClass(e,[{key:"render",value:function e(){i.Dom.append(b(this,P,k).call(this),b(this,m,C).call(this));babelHelpers.classPrivateFieldGet(this,d).renderTo(babelHelpers.classPrivateFieldGet(this,p))}},{key:"setProgress",value:function e(t){var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(a!==null){babelHelpers.classPrivateFieldGet(this,d).setMaxValue(a)}babelHelpers.classPrivateFieldGet(this,d).update(t);return this}},{key:"showResult",value:function e(t){var a=this;var s="";var l=babelHelpers.classPrivateFieldGet(this,d).getValue()-t.length;if(l>0){s+=i.Loc.getMessage(babelHelpers.classPrivateFieldGet(this,f).successCount,{"#COUNT#":l})}var r=t.length;if(r>0){if(s!==""){s+=". "}s+=i.Loc.getMessage(babelHelpers.classPrivateFieldGet(this,f).failedCount,{"#COUNT#":r});b(this,F,G).call(this,t)}babelHelpers.classPrivateFieldGet(this,d).setTextBefore(s).setClickAfterCallback((function(){return a.close()})).setTextAfter(i.Loc.getMessage("RECYCLEBIN_DM_PROGRESSBAR_CLOSE"));return this}},{key:"close",value:function e(){var t=this;var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;this.hide();if(a){this.remove();return}setTimeout((function(){return t.remove()}),400)}},{key:"remove",value:function e(){i.Dom.remove(babelHelpers.classPrivateFieldGet(this,p))}},{key:"hide",value:function e(){i.Dom.addClass(babelHelpers.classPrivateFieldGet(this,p),"--hidden")}}]);return e}();function y(){var e={value:0,maxValue:0,statusType:a.ProgressBar.Status.COUNTER,textBefore:i.Loc.getMessage(babelHelpers.classPrivateFieldGet(this,f).textBefore),textAfter:i.Loc.getMessage(babelHelpers.classPrivateFieldGet(this,f).textAfter),colorBar:"#ebcd2c",colorTrack:"#f2e59e"};if(i.Type.isArrayFilled(babelHelpers.classPrivateFieldGet(this,h))){e.maxValue=babelHelpers.classPrivateFieldGet(this,h).length}return e}function k(){if(!babelHelpers.classPrivateFieldGet(this,p)){babelHelpers.classPrivateFieldSet(this,p,i.Tag.render(r||(r=babelHelpers.taggedTemplateLiteral(['<div class="recyclebin-list-grid-panel"></div>']))))}return babelHelpers.classPrivateFieldGet(this,p)}function G(e){var t=this;e.forEach((function(e){i.Dom.append(b(t,w,S).call(t,e),babelHelpers.classPrivateFieldGet(t,p))}))}function S(e){var t=e.customData.info.title;var a=e.message;return i.Tag.render(n||(n=babelHelpers.taggedTemplateLiteral(['<div class="recyclebin-list-grid-panel-row">',": ","</div>"])),i.Text.encode(t),i.Text.encode(a))}function C(){return document.getElementById(babelHelpers.classPrivateFieldGet(this,v))}var M={intermediate:0,running:1,completed:2,stopped:3,error:4};function T(e,t,a){R(e,t);t.set(e,a)}function R(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var E=new WeakMap;var W=new WeakMap;var A=new WeakMap;var I=new WeakMap;var _=new WeakMap;var B=new WeakMap;var O=new WeakMap;var D=new WeakMap;var x=new WeakMap;var L=new WeakMap;var N=function(){function e(t,a){var s;babelHelpers.classCallCheck(this,e);T(this,E,{writable:true,value:void 0});T(this,W,{writable:true,value:void 0});T(this,A,{writable:true,value:void 0});T(this,I,{writable:true,value:void 0});T(this,_,{writable:true,value:void 0});T(this,B,{writable:true,value:[]});T(this,O,{writable:true,value:void 0});T(this,D,{writable:true,value:void 0});T(this,x,{writable:true,value:void 0});T(this,L,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,E,t);babelHelpers.classPrivateFieldSet(this,W,a);babelHelpers.classPrivateFieldSet(this,L,a.action);babelHelpers.classPrivateFieldSet(this,x,a.panel);this.emitter=a.emitter;babelHelpers.classPrivateFieldSet(this,A,(s=a.params)!==null&&s!==void 0?s:{});this.startRequest=this.startRequest.bind(this);this.closePanel=this.closePanel.bind(this);this.onRequestSuccess=this.onRequestSuccess.bind(this);this.onRequestFailure=this.onRequestFailure.bind(this)}babelHelpers.createClass(e,[{key:"setParams",value:function e(t){babelHelpers.classPrivateFieldSet(this,A,i.Runtime.merge(babelHelpers.classPrivateFieldGet(this,A),t));return this}},{key:"run",value:function e(){if(babelHelpers.classPrivateFieldGet(this,_)===M.stopped){babelHelpers.classPrivateFieldSet(this,_,M.intermediate)}this.startRequest()}},{key:"startRequest",value:function e(){var t=this;if(babelHelpers.classPrivateFieldGet(this,_)===M.stopped){return}if(babelHelpers.classPrivateFieldGet(this,I)){return}babelHelpers.classPrivateFieldSet(this,I,true);babelHelpers.classPrivateFieldSet(this,_,M.running);var a={params:i.Type.isPlainObject(babelHelpers.classPrivateFieldGet(this,A))?babelHelpers.classPrivateFieldGet(this,A):{}};i.ajax.runAction(babelHelpers.classPrivateFieldGet(this,L),{data:a}).then((function(e){var a;return t.onRequestSuccess((a=e.data)!==null&&a!==void 0?a:{})}),(function(e){var a;return t.onRequestFailure((a=e.data)!==null&&a!==void 0?a:{})}))["catch"]((function(e){console.error(e)}))}},{key:"onRequestSuccess",value:function e(t){babelHelpers.classPrivateFieldSet(this,I,false);if(babelHelpers.classPrivateFieldGet(this,_)===M.stopped){return}var a=t.status,s=t.errors,l=t.processedItems,r=t.totalItems;if(a==="ERROR"){babelHelpers.classPrivateFieldSet(this,_,M.error)}else if(a==="COMPLETED"){babelHelpers.classPrivateFieldSet(this,_,M.completed)}if(babelHelpers.classPrivateFieldGet(this,_)===M.error){console.error(babelHelpers.classPrivateFieldGet(this,B))}else{babelHelpers.classPrivateFieldSet(this,O,l!==null&&l!==void 0?l:0);babelHelpers.classPrivateFieldSet(this,D,r!==null&&r!==void 0?r:0)}if(i.Type.isArrayFilled(s)){babelHelpers.classPrivateFieldSet(this,B,[].concat(babelHelpers.toConsumableArray(babelHelpers.classPrivateFieldGet(this,B)),babelHelpers.toConsumableArray(s)))}this.refresh();if(babelHelpers.classPrivateFieldGet(this,_)===M.running){setTimeout(this.startRequest,this.getTimeout())}else if(babelHelpers.classPrivateFieldGet(this,_)===M.completed&&!i.Type.isArrayFilled(babelHelpers.classPrivateFieldGet(this,B))){setTimeout(this.closePanel,this.getTimeout())}this.emitStateChange()}},{key:"onRequestFailure",value:function e(t){babelHelpers.classPrivateFieldSet(this,I,false);babelHelpers.classPrivateFieldSet(this,_,M.error);this.refresh();this.emitStateChange()}},{key:"emitStateChange",value:function e(){this.emitter.emit("ON_AUTORUN_PROCESS_STATE_CHANGE",new l.BaseEvent({data:{state:babelHelpers.classPrivateFieldGet(this,_),processedItemCount:babelHelpers.classPrivateFieldGet(this,O),totalItemCount:babelHelpers.classPrivateFieldGet(this,D),errors:babelHelpers.classPrivateFieldGet(this,B)}}))}},{key:"refresh",value:function e(){if(babelHelpers.classPrivateFieldGet(this,_)===M.running){babelHelpers.classPrivateFieldGet(this,x).setProgress(babelHelpers.classPrivateFieldGet(this,O),babelHelpers.classPrivateFieldGet(this,D))}else if(babelHelpers.classPrivateFieldGet(this,_)===M.completed){babelHelpers.classPrivateFieldGet(this,x).setProgress(babelHelpers.classPrivateFieldGet(this,O),babelHelpers.classPrivateFieldGet(this,D)).showResult(babelHelpers.classPrivateFieldGet(this,B))}else if(babelHelpers.classPrivateFieldGet(this,_)===M.stopped){this.closePanel()}}},{key:"getTimeout",value:function e(){var t=2e3;return i.Type.isNumber(babelHelpers.classPrivateFieldGet(this,W).timeout)?babelHelpers.classPrivateFieldGet(this,W).timeout:t}},{key:"reset",value:function e(){babelHelpers.classPrivateFieldSet(this,B,[]);babelHelpers.classPrivateFieldSet(this,O,0);babelHelpers.classPrivateFieldSet(this,D,0);this.refresh()}},{key:"closePanel",value:function e(){babelHelpers.classPrivateFieldGet(this,x).close()}}]);return e}();function q(e,t){X(e,t);t.add(e)}function U(e,t,a){X(e,t);t.set(e,a)}function X(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function j(e,t,a){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return a}var V=new WeakMap;var Y=new WeakMap;var z=new WeakMap;var J=new WeakMap;var K=new WeakMap;var Q=new WeakMap;var Z=new WeakMap;var $=new WeakMap;var ee=new WeakMap;var te=new WeakSet;var ae=new WeakSet;var se=new WeakSet;var ie=new WeakSet;var le=new WeakSet;var re=function(){babelHelpers.createClass(e,null,[{key:"getInstance",value:function t(a,s){if(!e.items.has(a)){var i=new e(a,s);e.items.set(a,i)}return e.items.get(a)}}]);function e(t,a){babelHelpers.classCallCheck(this,e);q(this,le);q(this,ie);q(this,se);q(this,ae);q(this,te);babelHelpers.defineProperty(this,"id",null);U(this,V,{writable:true,value:false});U(this,Y,{writable:true,value:[]});U(this,z,{writable:true,value:void 0});U(this,J,{writable:true,value:void 0});U(this,K,{writable:true,value:null});U(this,Q,{writable:true,value:void 0});U(this,Z,{writable:true,value:void 0});U(this,$,{writable:true,value:void 0});U(this,ee,{writable:true,value:void 0});this.id=t;babelHelpers.classPrivateFieldSet(this,Q,a);this.emitter=new l.EventEmitter;this.emitter.setEventNamespace("Recyclebin.DeletionManager");this.progressChangeHandler=this.progressChangeHandler.bind(this)}babelHelpers.createClass(e,[{key:"setMessages",value:function e(t){babelHelpers.classPrivateFieldSet(this,$,t)}},{key:"getId",value:function e(){return this.id}},{key:"setEntityIds",value:function e(t){babelHelpers.classPrivateFieldSet(this,Y,t);return this}},{key:"executeRestore",value:function e(){if(this.isRunning()){return}j(this,te,ne).call(this,"restore");this.layout();this.run()}},{key:"executeDelete",value:function e(){var t=this;if(this.isRunning()){return}BX.Recyclebin.confirm(i.Loc.getMessage("RECYCLEBIN_DM_CONFIRM_REMOVE_TITLE"),null,{buttonSet:[{text:i.Loc.getMessage("RECYCLEBIN_DM_CONFIRM_REMOVE_YES"),type:"green",code:"continue",default:true}]}).then((function(){j(t,te,ne).call(t,"delete");t.layout();t.run()}))}},{key:"isRunning",value:function e(){return babelHelpers.classPrivateFieldGet(this,V)}},{key:"layout",value:function e(){if(babelHelpers.classPrivateFieldGet(this,z)){this.clearLayout()}j(this,le,be).call(this).render();babelHelpers.classPrivateFieldSet(this,z,true)}},{key:"run",value:function e(){var t,a=this;if(babelHelpers.classPrivateFieldGet(this,V)){return}(t=babelHelpers.classPrivateFieldGet(this,J))===null||t===void 0?void 0:t.reset();babelHelpers.classPrivateFieldSet(this,V,true);this.enableGridFilter(false);var s={gridId:this.id};if(i.Type.isArrayFilled(babelHelpers.classPrivateFieldGet(this,Y))){s.entityIds=babelHelpers.classPrivateFieldGet(this,Y)}i.ajax.runAction(j(this,ae,ce).call(this),{data:{params:s}}).then((function(e){var t=e.data.hash;if(!i.Type.isStringFilled(t)){a.reset();return}babelHelpers.classPrivateFieldSet(a,Z,t);j(a,ie,ue).call(a).setParams({hash:t}).run();a.emitter.subscribe("ON_AUTORUN_PROCESS_STATE_CHANGE",a.progressChangeHandler)}))["catch"]((function(e){console.error(e)}))}},{key:"getCancelActionPath",value:function e(){var t="recyclebin.api.DeletionManager";var a=babelHelpers.classPrivateFieldGet(this,ee);if(a==="delete"){return"".concat(t,".cancelDeletion")}if(a==="restore"){return"".concat(t,".cancelRestore")}throw new Error("Unknown action: ".concat(a))}},{key:"getOperationHash",value:function e(){return babelHelpers.classPrivateFieldGet(this,Z)}},{key:"reset",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;babelHelpers.classPrivateFieldSet(this,Z,null);babelHelpers.classPrivateFieldSet(this,V,false);this.emitter.unsubscribe("ON_AUTORUN_PROCESS_STATE_CHANGE",this.progressChangeHandler);if(babelHelpers.classPrivateFieldGet(this,z)&&t){window.setTimeout(this.clearLayout.bind(this),2e3)}this.enableGridFilter(true);BX.Main.gridManager.reload(this.getId())}},{key:"clearLayout",value:function e(){babelHelpers.classPrivateFieldGet(this,K).close(true);babelHelpers.classPrivateFieldSet(this,K,null);babelHelpers.classPrivateFieldSet(this,J,null);babelHelpers.classPrivateFieldSet(this,z,false)}},{key:"cancel",value:function e(){var t=this;var a=this.getOperationHash();i.ajax.runAction(this.getCancelActionPath(),{data:{params:{hash:a}}}).then((function(){t.clearLayout()}))["catch"]((function(e){console.error(e)}));j(this,le,be).call(this).hide()}},{key:"progressChangeHandler",value:function e(t){var a=t.data;var s=a.state,l=a.errors;if(s===M.completed||s===M.stopped){this.reset(!i.Type.isArrayFilled(l))}}},{key:"resetEntityIds",value:function e(){babelHelpers.classPrivateFieldSet(this,Y,[])}},{key:"enableGridFilter",value:function e(t){var a=document.getElementById("".concat(this.id,"_search_container"));if(!a){return}var s="main-ui-disable";if(t){i.Dom.removeClass(a,s)}else{i.Dom.addClass(a,s)}}}]);return e}();function ne(e){babelHelpers.classPrivateFieldSet(this,ee,e)}function ce(){var e="recyclebin.api.DeletionManager";var t=babelHelpers.classPrivateFieldGet(this,ee);if(t==="delete"){return"".concat(e,".prepareDeletion")}if(t==="restore"){return"".concat(e,".prepareRestore")}throw new Error("Unknown action: ".concat(t))}function oe(){var e="recyclebin.api.DeletionManager";var t=babelHelpers.classPrivateFieldGet(this,ee);if(t==="delete"){return"".concat(e,".processDeletion")}if(t==="restore"){return"".concat(e,".processRestore")}throw new Error("Unknown action: ".concat(t))}function ue(){if(!babelHelpers.classPrivateFieldGet(this,J)){babelHelpers.classPrivateFieldSet(this,J,new N(this.id,{action:j(this,se,oe).call(this),panel:j(this,le,be).call(this),emitter:this.emitter,params:{moduleId:babelHelpers.classPrivateFieldGet(this,Q).moduleId}}))}return babelHelpers.classPrivateFieldGet(this,J)}function be(){if(!babelHelpers.classPrivateFieldGet(this,K)){var e;var t={entityIds:babelHelpers.classPrivateFieldGet(this,Y),containerId:babelHelpers.classPrivateFieldGet(this,Q).containerId,onAfterTextClick:this.cancel.bind(this),messages:(e=babelHelpers.classPrivateFieldGet(this,$))!==null&&e!==void 0?e:[]};babelHelpers.classPrivateFieldSet(this,K,new g(t))}return babelHelpers.classPrivateFieldGet(this,K)}babelHelpers.defineProperty(re,"items",new i.Cache.MemoryCache);e.DeletionManager=re})(this.BX.Recyclebin=this.BX.Recyclebin||{},BX.Cache,BX.UI,BX,BX,BX.Event);
//# sourceMappingURL=deletion-manager.bundle.map.js