{"version":3,"file":"generator.bundle.js","sources":["../src/generator.js"],"sourcesContent":["import {ajax, Tag, Dom} from 'main.core';\nimport {EventEmitter} from 'main.core.events';\n\ntype JobData = {\n\tstep: number;\n\tstatus: 'R' | 'P' | 'F' | 'E',\n\tstatusMessage: string,\n\tformattedStatusMessage: string,\n}\n\ntype GeneratorJob = {\n\tid: number,\n\tstatusNode: HTMLDivElement,\n\tstep: number,\n\tstatus: string,\n\tstatusMessage: '',\n\tformattedStatusMessage: '',\n};\n\nexport class Generator extends EventEmitter\n{\n\tstatic STATUS_REGISTER = 'R';\n\tstatic STATUS_FINISH = 'F';\n\tstatic STATUS_ERROR = 'E';\n\n\tstatic START_STATUS = Generator.STATUS_REGISTER;\n\tstatic START_STEP = 0;\n\tstatic STATUS_CLASS = 'sitemap-status';\n\n\t#statusContainer: HTMLElement;\n\t#jobs: [GeneratorJob] = [];\n\n\t/**\n\t * @param container - HTML element for print sitemap statuses\n\t */\n\tconstructor(container: HTMLElement)\n\t{\n\t\tsuper();\n\t\tthis.#statusContainer = container;\n\t\tDom.clean(this.#statusContainer);\n\t}\n\n\tadd(sitemapId: number, jobData: ?JobData)\n\t{\n\t\t// todo: after finish not running again until page refresh. Need rerun\n\t\tif (\n\t\t\tsitemapId > 0\n\t\t\t&& !this.#jobs.find(job => job.id === sitemapId)\n\t\t)\n\t\t{\n\t\t\tconst existsStatusNode = document.getElementById(Generator.STATUS_CLASS + '-' + sitemapId);\n\t\t\tconst statusNode =\n\t\t\t\texistsStatusNode \n\t\t\t\t|| Tag.render`\n\t\t\t\t\t<div id=\"${Generator.STATUS_CLASS}-${sitemapId}\" class=\"${Generator.STATUS_CLASS}\"></div>\n\t\t\t\t`;\n\t\t\tDom.append(statusNode, this.#statusContainer);\n\n\t\t\tconst newJob: GeneratorJob = {\n\t\t\t\tid: sitemapId,\n\t\t\t\tstatusNode: statusNode,\n\t\t\t\tstep: Generator.START_STEP,\n\t\t\t\tstatus: Generator.START_STATUS,\n\t\t\t\tstatusMessage: '',\n\t\t\t\tformattedStatusMessage: '',\n\t\t\t};\n\t\t\tif (jobData)\n\t\t\t{\n\t\t\t\tObject.assign(newJob, jobData)\n\t\t\t}\n\t\t\tthis.#jobs.push(newJob);\n\n\t\t\tif (newJob.formattedStatusMessage)\n\t\t\t{\n\t\t\t\tnewJob.status !== 'E'\n\t\t\t\t\t? this.#printStatus(newJob.id, newJob.formattedStatusMessage)\n\t\t\t\t\t: this.#printError(newJob.id, newJob.formattedStatusMessage)\n\t\t\t\t;\n\t\t\t}\n\n\t\t\tthis.#do(sitemapId);\n\t\t}\n\t}\n\n\t#do(jobId: number)\n\t{\n\t\tthis.emit('onBeforeDo', jobId);\n\n\t\tajax.runAction(\n\t\t\t\"seo.api.sitemap.job.do\",\n\t\t\t{\n\t\t\t\tdata: {\n\t\t\t\t\tsitemapId: jobId,\n\t\t\t\t}\n\t\t\t},\n\t\t)\n\t\t\t.then(result => {\n\t\t\t\tthis.emit('onAfterDo', jobId);\n\n\t\t\t\tif (result && result.status === 'success')\n\t\t\t\t{\n\t\t\t\t\tconst data: JobData = result.data;\n\n\t\t\t\t\tif (data.status !== Generator.STATUS_FINISH && data.status !== Generator.STATUS_ERROR)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#do(jobId);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (data.status === Generator.STATUS_FINISH)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#printStatus(jobId, data.formattedStatusMessage);\n\t\t\t\t\t\tthis.#finish(jobId);\n\t\t\t\t\t}\n\t\t\t\t\telse if (data.status === Generator.STATUS_ERROR)\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#printError(jobId, (data.statusMessage || 'Something went wrong'));\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#printStatus(jobId, data.formattedStatusMessage);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.#printError(jobId, (result.error || 'Something went wrong'));\n\t\t\t\t}\n\t\t\t})\n\t\t\t.catch(err => {\n\t\t\t\tconst errMsg = err.errors.pop();\n\t\t\t\tthis.#printError(jobId, (errMsg ? errMsg.message : 'Something went wrong'));\n\t\t\t});\n\t}\n\n\t#finish(jobId: number)\n\t{\n\t\tthis.#jobs = this.#jobs.filter(job => job.id !== jobId);\n\t\tthis.emit('onFinish', jobId);\n\t}\n\n\t#printStatus(jobId: number, status: string)\n\t{\n\t\tconst node = this.#getStatusNode(jobId);\n\t\tconst message = Tag.render`<div>${status}</div>`;\n\t\tDom.clean(node);\n\t\tDom.append(message, node);\n\t}\n\n\t#printError(jobId: number, error: string)\n\t{\n\t\tconst node = this.#getStatusNode(jobId);\n\t\tconst message = Tag.render`<div>${error}</div>`;\n\t\tDom.clean(node);\n\t\tDom.append(message, node);\n\t}\n\n\t#getStatusNode(jobId: ?number): ?HTMLDivElement\n\t{\n\t\tconst currentJob: GeneratorJob = this.#jobs.find(job => job.id === jobId);\n\n\t\treturn currentJob ? currentJob.statusNode : null;\n\t}\n}"],"names":["Generator","EventEmitter","constructor","container","Dom","clean","add","sitemapId","jobData","find","job","id","existsStatusNode","document","getElementById","STATUS_CLASS","statusNode","Tag","render","append","newJob","step","START_STEP","status","START_STATUS","statusMessage","formattedStatusMessage","Object","assign","push","jobId","emit","ajax","runAction","data","then","result","STATUS_FINISH","STATUS_ERROR","error","catch","err","errMsg","errors","pop","message","filter","node","currentJob","STATUS_REGISTER"],"mappings":"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"}