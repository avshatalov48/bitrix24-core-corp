BX.namespace("BX.rest.Marketplace");BX.rest.Marketplace=function(){var e="/bitrix/tools/rest.php";var t="/settings/license_buy.php?product=subscr";var n=function(t,n,o){n.action=t;n.sessid=BX.bitrix_sessid();BX.ajax({dataType:"json",method:"POST",url:e,data:n,onsuccess:o,onfailure:function(e,t){o({error:e+(!!t?": "+t:"")})}})};return{install:function(e){e=e||{url:location.href};e.IFRAME=location.href.indexOf("IFRAME=Y")>0;var t=false;var o=BX.PopupWindowManager.create("BXAppInstallPopup|"+e.url,null,{autoHide:false,zIndex:0,offsetLeft:0,offsetTop:0,overlay:true,draggable:{restrict:true},closeByEsc:true,closeIcon:{right:"12px",top:"10px"},buttons:[button=new BX.PopupWindowButton({text:BX.message("REST_MP_APP_INSTALL"),className:"popup-window-button-accept",events:{click:function(){if(!t){return}if(BX("mp_tos_license")&&!BX("mp_tos_license").checked){BX("mp_detail_error").innerHTML=BX.message("MARKETPLACE_LICENSE_TOS_ERROR");return}if(BX("mp_detail_license")&&!BX("mp_detail_license").checked||BX("mp_detail_confidentiality")&&!BX("mp_detail_confidentiality").checked){BX("mp_detail_error").innerHTML=BX.message("MARKETPLACE_LICENSE_ERROR");return}if(BX.hasClass(button.buttonNode,"popup-window-button-wait")){return}var o=document.forms["left-menu-preset-form"];BX.addClass(button.buttonNode,"popup-window-button-wait");var a={code:e.CODE};if(!!e.VERSION){a.version=e.VERSION}if(!!e.CHECK_HASH){a.check_hash=e.CHECK_HASH;a.install_hash=e.INSTALL_HASH}if(!!e.FROM){a.from=e.FROM}n("install",a,BX.delegate(function(t){if(!!t.error){BX("mp_error").innerHTML=t.error+(!!t.error_description?"<br /><br />"+t.error_description:"");BX.show(BX("mp_error"))}else if(!!t.redirect&&e["REDIRECT_PRIORITY"]===true){top.location.href=t.redirect}else if(!e.IFRAME){if(!!t.redirect){top.location.href=t.redirect}else{top.location.href=BX.util.remove_url_param(top.location.href,["install"])}}else{if(t.installed){var n={};top.BX.onCustomEvent(top,"Rest:AppLayout:ApplicationInstall",[true,n],false)}if(!!t.open){BX.SidePanel.Instance.reload();top.BX.rest.AppLayout.openApplication(t.id,{})}else{BX.SidePanel.Instance.reload()}}},this))}}}),new BX.PopupWindowButtonLink({text:BX.message("REST_MP_APP_INSTALL_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})],content:'<div style="width:450px;height:230px; background: url(/bitrix/js/rest/images/loader.gif) no-repeat center;"></div>',events:{onAfterPopupShow:function(){var n=e.url||location.href;if(n.indexOf("?")>0){n+="&label=startInstall"}else{n+="?label=startInstall"}return BX.ajax({method:"POST",processData:false,url:n,data:BX.ajax.prepareData({install:1,sessid:BX.bitrix_sessid(),dataType:"json"}),onsuccess:BX.delegate(function(e){t=true;var n=BX.parseJSON(e);if(BX.type.isPlainObject(n)&&n["status"]=="success"){this.setContent(n["data"]["content"]);this.setTitleBar(n["data"]["title"])}else{this.setContent(e)}BX.defer(this.adjustPosition,this)()},this)})}}});o.show()},uninstallConfirm:function(e,t){var n=new BX.PopupWindow("mp_delete_confirm_popup",null,{content:'<div class="mp_delete_confirm"><div class="mp_delete_confirm_text">'+BX.message("REST_MP_DELETE_CONFIRM")+'</div><div class="mp_delete_confirm_cb"><input type="checkbox" name="delete_data" id="delete_data">&nbsp;<label for="delete_data">'+BX.message("REST_MP_DELETE_CONFIRM_CLEAN")+"</label></div></div>",closeByEsc:true,closeIcon:{top:"1px",right:"10px"},buttons:[new BX.PopupWindowButton({text:BX.message("REST_MP_APP_DELETE"),className:"popup-window-button-decline",events:{click:function(){BX.rest.Marketplace.uninstall(e,BX("delete_data").checked,function(e){if(e.error){n.setContent('<div class="mp_delete_confirm"><div class="mp_delete_confirm_text">'+e.error+"</div></div>");n.setButtons([new BX.PopupWindowButtonLink({text:BX.message("JS_CORE_WINDOW_CLOSE"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]);n.adjustPosition()}else{if(!!e.sliderUrl){BX.SidePanel.Instance.open(e.sliderUrl)}else{n.close();window.location.reload()}}},t)}}}),new BX.PopupWindowButtonLink({text:BX.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]});n.show()},uninstall:function(e,t,o,a){n("uninstall",{code:e,clean:t,from:a},function(e){var t={};top.BX.onCustomEvent(top,"Rest:AppLayout:ApplicationInstall",[false,t],false);if(!!o){o(e)}else{if(!!e.error){BX.UI.Notification.Center.notify({content:e.error})}else{location.reload()}}})},reinstall:function(e,t){n("reinstall",{id:e},function(e){if(!!e.error){BX.UI.Notification.Center.notify({content:e.error})}else if(!!e.redirect){BX.reload(e.redirect)}else{BX.UI.Notification.Center.notify({content:BX.message("REST_MP_APP_REINSTALLED")})}if(!!t){t()}})},buy:function(e,t){var n=[];for(var o=0;o<t.length;o++){n.push({text:t[o].TEXT,href:t[o].LINK,target:"_blank",className:"menu-popup-no-icon"})}BX.PopupMenu.show("user-menu",e,n,{offsetTop:9,offsetLeft:43,angle:true})},buySubscription:function(e){var t=BX.PopupWindowManager.create("marketplace_buy_subscription",null,{content:['\t\t<div class="rest-marketplace-popup-block">\n'+'\t\t\t<div class="rest-marketplace-popup-text-block">\n'+'\t\t\t\t<div class="rest-marketplace-popup-text">'+BX.message("REST_MP_SUBSCRIPTION_TEXT1")+"</div>\n"+'\t\t\t\t<div class="rest-marketplace-popup-text">'+BX.message("REST_MP_SUBSCRIPTION_TEXT2")+"</div>"+'\t\t\t\t<div class="rest-marketplace-popup-text">'+BX.message("REST_MP_SUBSCRIPTION_TEXT3")+"</div>\n"+"\t\t\t</div>\n"+"\t\t</div>\n"].join(),titleBar:BX.message("REST_MP_SUBSCRIPTION_TITLE"),closeIcon:true,closeByEsc:true,draggable:true,lightShadow:true,overlay:true,className:"landing-marketplace-popup-wrapper",buttons:[new BX.PopupWindowButton({text:BX.message("REST_MP_SUBSCRIPTION_BUTTON_TITLE"),className:"popup-window-button-accept",events:{click:this.openBuySubscription}}),new BX.PopupWindowButtonLink({text:BX.message("REST_MP_SUBSCRIPTION_BUTTON_TITLE2"),className:"popup-window-button-link-cancel",events:{click:function(){this.openDemoSubscription()}.bind(this)}})]}).show()},openBuySubscription:function(){top.window.location.href=t},openDemoSubscription:function(e){var t=new BX.UI.Button({color:BX.UI.Button.Color.SUCCESS,state:BX.UI.Button.State.DISABLED,text:BX.message("REST_MP_SUBSCRIPTION_BUTTON_DEMO_ACTIVE"),className:"rest-marketplace-popup-activate-subscription-btn",onclick:BX.delegate(function(){if(BX("mp_demo_subscription_license").checked){t.setState(BX.UI.Button.State.WAITING);n("activate_demo",{},function(n){if(!!n.error){BX.UI.Notification.Center.notify({content:n.error});t.setState(BX("mp_demo_subscription_license").checked?BX.UI.Button.State.ACTIVE:BX.UI.Button.State.DISABLED)}else{if(BX.type.isFunction(e)){e(n)}else{var o=BX.SidePanel.Instance.getTopSlider();if(!!o){o.reload()}else{window.location.reload()}}}})}},this)});var o=BX.PopupWindowManager.create("marketplace_demo_subscription",null,{content:BX.create("div",{props:{className:"rest-marketplace-popup-block"},children:[BX.create("div",{props:{className:"rest-marketplace-popup-text-block"},children:[BX.create("div",{props:{className:"rest-marketplace-popup-text"},text:BX.message("REST_MP_SUBSCRIPTION_DEMO_TEXT1")}),BX.create("div",{props:{className:"rest-marketplace-popup-text"},text:BX.message("REST_MP_SUBSCRIPTION_DEMO_TEXT2")}),BX.create("div",{style:{"margin-bottom":"8px","margin-top":"15px"},children:[BX.create("input",{attrs:{id:"mp_demo_subscription_license",type:"checkbox",name:"ACCEPT_SUBSCRIPTION_LICENSE",value:"Y"},events:{change:function(e){t.setState(e.target.checked?BX.UI.Button.State.ACTIVE:BX.UI.Button.State.DISABLED)}}}),BX.create("label",{attrs:{for:"mp_demo_subscription_license"},html:BX.message("REST_MP_SUBSCRIPTION_DEMO_EULA_TITLE").replace("#LINK#",BX.message("REST_MP_SUBSCRIPTION_DEMO_EULA_LINK"))})]})]})]}),titleBar:BX.message("REST_MP_SUBSCRIPTION_TITLE"),closeIcon:true,closeByEsc:true,draggable:true,lightShadow:true,overlay:true,className:"landing-marketplace-popup-wrapper",buttons:[t,new BX.PopupWindowButtonLink({text:BX.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.close()}}})]}).show()},setRights:function(e,t){BX.Access.Init({other:{disabled:false,disabled_g2:true,disabled_cr:true},groups:{disabled:true},socnetgroups:{disabled:true}});var o={app_id:e};if(!!t){o.site_id=t}n("get_app_rigths",o,function(o){BX.Access.SetSelected(o,"bind");BX.Access.ShowForm({bind:"bind",showSelected:true,callback:function(o){var a={app_id:e,rights:o};if(!!t){a.site_id=t}n("set_app_rights",a,function(e){})}})})},open:function(e,t){if(!t){t="all"}var n=BX.message("REST_MARKETPLACE_CATEGORY_URL").replace("#CODE#",t);if(!!e&&!!e.PLACEMENT){n=BX.util.add_url_param(n,{placement:e.PLACEMENT,category:t})}else{n=BX.util.add_url_param(n,{category:t})}var o=BX.SidePanel.Instance.getUrlRule(n);var a=o&&BX.type.isPlainObject(o.options)?o.options:{};a["cacheable"]=false;a["allowChangeHistory"]=false;a["requestMethod"]="post";a["requestParams"]={sessid:BX.bitrix_sessid()};BX.SidePanel.Instance.open(n,a);var s=BX.SidePanel.Instance.getTopSlider();top.BX.addCustomEvent(top,"Rest:AppLayout:ApplicationInstall",function(e,t){t.redirect=false})},bindPageAnchors:function(e){BX.ready(function(){BX.SidePanel.Instance.bindAnchors(top.BX.clone({rules:[{condition:["/marketplace/detail/","/bitrix/components/bitrix/rest.marketplace/lazyload.ajax.php"],options:{cacheable:false,allowChangeHistory:e.allowChangeHistory}}]}))})}}}();
//# sourceMappingURL=marketplace.map.js