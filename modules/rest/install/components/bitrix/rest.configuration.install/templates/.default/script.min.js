(function(){BX.namespace("BX.Rest.Configuration.Install");if(!BX.Rest.Configuration.Install){return}function t(){}t.prototype={init:function(t){this.id=t.id;this.signedParameters=t.signedParameters;this.next="";this.section=[];this.progressDescriptionContainer=BX.findChildByClassName(BX(this.id),"rest-configuration-info");this.needClearFull=t.needClearFull;this.needClearFullConfirm=t.needClearFullConfirm;this.errors=[];var e=BX.findChildByClassName(BX(this.id),"start_btn");if(e!==null){BX.bind(e,"click",BX.delegate(function(){if(this.needClearFullConfirm===true){this.showConfirmClearAll(e)}else{this.start()}},this))}else{this.start()}var s=BX.findChildByClassName(BX(this.id),"start_later_btn");if(s!==null){BX.bind(s,"click",BX.delegate(function(){this.showPopupInstallLater(s)},this))}},showPopupInstallLater:function(t){this.sendAjax("preInstallOff",{},BX.delegate(function(e){BX.UI.Dialogs.MessageBox.show({message:BX.create("p",{html:BX.message("REST_CONFIGURATION_IMPORT_PRE_INSTALL_LATER_APP_POPUP_DESCRIPTION")}),modal:true,bindElement:t,buttons:[new BX.UI.Button({text:BX.message("REST_CONFIGURATION_IMPORT_INSTALL_LATER_POPUP_CLOSE_BTN"),color:BX.UI.Button.Color.PRIMARY,onclick:function(t){t.context.close();BX.SidePanel.Instance.close()}})]})},this))},showConfirmClearAll:function(t){var e=new BX.UI.Button({color:BX.UI.Button.Color.PRIMARY,state:BX.UI.Button.State.DISABLED,text:BX.message("REST_CONFIGURATION_IMPORT_INSTALL_CONFIRM_POPUP_BTN_CONTINUE"),onclick:BX.delegate(function(t){if(!BX("CONFIGURATION_ACCEPT_CLEAR_ALL").checked){return false}t.context.close();this.start()},this)});var s=BX.create("div",{children:[BX.create("p",{text:BX.message("REST_CONFIGURATION_IMPORT_INSTALL_CONFIRM_POPUP_TEXT")}),BX.create("INPUT",{attrs:{id:"CONFIGURATION_ACCEPT_CLEAR_ALL",type:"checkbox",name:"ACCEPT_CLEAR_ALL",value:"Y"},events:{change:function(t){e.setState(this.checked?BX.UI.Button.State.ACTIVE:BX.UI.Button.State.DISABLED)}}}),BX.create("label",{attrs:{for:"CONFIGURATION_ACCEPT_CLEAR_ALL"},text:BX.message("REST_CONFIGURATION_IMPORT_INSTALL_CONFIRM_POPUP_CHECKBOX_LABEL")})]});BX.UI.Dialogs.MessageBox.show({message:s,modal:true,bindElement:t,buttons:[e,new BX.UI.Button({text:BX.message("REST_CONFIGURATION_IMPORT_INSTALL_CONFIRM_POPUP_BTN_CANCEL"),onclick:function(t){t.context.close()}})]})},setDescription:function(t){t="REST_CONFIGURATION_IMPORT_INSTALL_STEP_"+t;var e=BX.message[t]?BX.message(t):BX.message("REST_CONFIGURATION_IMPORT_INSTALL_STEP");BX.html(this.progressDescriptionContainer,e)},finish:function(){this.setDescription("FINISH");var t=BX.findChildByClassName(BX(this.id),"rest-configuration-start-icon-main");var e=BX.findChildByClassName(BX(this.id),"rest-configuration-info");BX.removeClass(t," rest-configuration-start-icon-main-loading");var s="";if(this.errors.length===0){s=BX.message("REST_CONFIGURATION_IMPORT_FINISH_DESCRIPTION");BX.addClass(t,"rest-configuration-start-icon-main-success")}else{s=BX.message("REST_CONFIGURATION_IMPORT_FINISH_ERROR_DESCRIPTION");BX.addClass(t,"rest-configuration-start-icon-main-error")}BX.cleanNode(this.progressDescriptionContainer);this.progressDescriptionContainer.appendChild(BX.create("p",{attrs:{className:""},text:s}));if(this.errors.length!==0){this.progressDescriptionContainer.appendChild(BX.create("div",{attrs:{className:"rest-configuration-links"},children:[BX.create("a",{attrs:{"data-slider-ignore-autobinding":"true",href:""},events:{click:BX.delegate(this.openPopupErrors,this)},text:BX.message("REST_CONFIGURATION_IMPORT_ERRORS_REPORT_BTN")})]}))}BX.insertAfter(BX.create("div",{attrs:{className:"rest-configuration-action-block"},children:[]}),BX.findChildByClassName(BX(this.id),"rest-configuration-start-icon-main"));var i=this;this.sendAjax("finish",{},BX.delegate(function(t){if(t.data.result===true){if(i.errors.length>0){var e=BX.findChildByClassName(BX(i.id),"rest-configuration-errors");for(var s=0;s<i.errors.length;s++){e.appendChild(BX.create("p",{text:i.errors[s]}))}}else{BX(i.id).appendChild(BX.create("p",{attrs:{className:"rest-configuration-import-finish rest-configuration-info"},html:BX.message("REST_CONFIGURATION_IMPORT_INSTALL_FINISH_TEXT")}))}}var n=[];if(!!t.data.createItemList&&t.data.createItemList.length>0){var a=t.data.createItemList;for(var s=0;s<a.length;s++){n[s]=BX.create(a[s]["TAG"],a[s]["DATA"]);this.progressDescriptionContainer.appendChild(n[s])}}top.BX.Event.EventEmitter.emit("BX.Rest.Configuration.Install:onFinish",new top.BX.Event.BaseEvent({data:{finishResponse:t.data,errors:this.errors,elementList:n}}))},this))},addErrors:function(t){for(var e=0;e<t.length;e++){this.errors.push(t[e])}},openPopupErrors:function(){var t="";this.errors.forEach(function(e){t+=e+"\r\n"});var e=BX.create("textarea",{props:{className:"rest-configuration-popup-textarea",placeholder:BX.message("REST_CONFIGURATION_IMPORT_ERRORS_POPUP_TEXT_PLACEHOLDER")},html:t});var s=BX.create("div",{children:[BX.create("div",{props:{className:"rest-configuration-popup-textarea-title"},text:BX.message("REST_CONFIGURATION_IMPORT_ERRORS_POPUP_TEXT_LABEL")}),e]});var i=BX.PopupWindowManager.create("rest-configuration-popup",null,{className:"rest-configuration-popup",titleBar:BX.message("REST_CONFIGURATION_IMPORT_ERRORS_POPUP_TITLE"),content:s,contentBackground:"transparent",contentPadding:10,minWidth:250,maxWidth:450,autoHide:true,closeIcon:true,animation:"fading-slide",buttons:[new BX.UI.Button({text:BX.message("REST_CONFIGURATION_IMPORT_ERRORS_POPUP_BTN_COPY"),color:BX.UI.Button.Color.LINK,events:{click:function(){e.select();document.execCommand("copy")}}})],onPopupClose:function(){this.destroy()}});i.show()},start:function(){BX.addClass(BX.findChildByClassName(BX(this.id),"rest-configuration-start-icon-main"),"rest-configuration-start-icon-main-loading");BX.style(BX.findChildByClassName(BX(this.id),"start-btn-block"),"display","none");this.setDescription("START");BX.style(BX.findChildByClassName(BX(this.id),"start_btn_block"),"display","none");this.sendAjax("start",{},BX.delegate(function(t){if(t.data.section.length>0){this.section=t.data.section;if(!!t.data.next&&t.data.next==="save"){this.loadManifest(0,"","export")}else{this.loadManifest(0,"","import")}}},this))},finishSave:function(){this.sendAjax("finishSave",{},BX.delegate(function(t){this.loadManifest(0,"","import")},this))},save:function(t,e){this.sendAjax("save",{code:this.section[t],step:e,next:this.next},BX.delegate(function(s){if(!!s.data){this.next=s.data.next;e++;if(this.next===false){t++;e=0}if(t>=this.section.length){this.finishSave(0,"","import")}else{this.save(t,e)}}else{this.showFatalError()}},this))},loadManifest:function(t,e,s){this.sendAjax("loadManifest",{step:t,next:e,type:s},BX.delegate(function(e){if(!!e.data){t++;if(e.data.next===false){if(s==="export"){this.save(0,0)}else{this.clear(0,0,0)}}else{this.loadManifest(t,e.data.next,s)}}else{this.showFatalError()}},this))},clear:function(t,e,s){this.setDescription("CLEAR");this.sendAjax("clear",{code:this.section[t],step:e,next:s},BX.delegate(function(i){e++;s=i.data.next;if(s===false){t++;e=0;s=0}if(t<this.section.length){this.clear(t,e,s)}else{this.import(0,0)}},this))},import:function(t,e){this.sendAjax("import",{code:this.section[t],step:e},BX.delegate(function(s){e++;if(!s.data.errors){this.setDescription(this.section[t])}if(s.data.result===true){t++;e=0}if(t<this.section.length){this.import(t,e)}else{this.finish()}},this))},showFatalError:function(t){var e=BX.findChildByClassName(BX(this.id),"rest-configuration-start-icon-main");BX.removeClass(e,"rest-configuration-start-icon-main-zip rest-configuration-start-icon-main-loading");BX.addClass(e,"rest-configuration-start-icon-main-error");BX.cleanNode(this.progressDescriptionContainer);this.progressDescriptionContainer.appendChild(BX.create("div",{attrs:{className:"rest-configuration-fatal-error-block"},children:[],text:t?t:BX.message("REST_CONFIGURATION_IMPORT_INSTALL_FATAL_ERROR")}))},sendAjax:function(t,e,s){e.clear=this.needClearFull;BX.ajax.runComponentAction("bitrix:rest.configuration.install",t,{mode:"class",signedParameters:this.signedParameters,data:e}).then(BX.delegate(function(i){if(!!i.data.exception){this.showFatalError(i.data.exception)}else{s(i)}if(!!i.data.errors){this.addErrors(i.data.errors)}if(!!i.data["notice"]){console.log({errors:i.data["notice"],action:t,data:e,response:i})}},this)).catch(function(t){this.showFatalError(false)}.bind(this))}};BX.Rest.Configuration.Install=new t})(window);
//# sourceMappingURL=script.map.js