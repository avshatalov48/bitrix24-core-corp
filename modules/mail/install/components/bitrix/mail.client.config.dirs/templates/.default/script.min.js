(function(){BX.namespace("BX.Mail.Client.Config.Dirs");BX.Mail.Client.Config.Dirs.Form=function(t){this.mailboxId=t.mailboxId;this.dirs=t.dirs;this.items={};this.maxLevelDirs=t.maxLevelDirs;this.container=t.container;this.buttonSubmit=t.buttonSubmit;this.buttonCancel=t.buttonCancel;this.itemRowSelector=t.itemRowSelector;this.subMenuSelector=t.subMenuSelector;this.itemContentSelector=t.itemContentSelector;this.checkboxSelector=t.checkboxSelector;this.levelButtonSelector=t.levelButtonSelector;this.childCounterContainerSelector=t.childCounterContainerSelector;this.syncChildCounterSelector=t.syncChildCounterSelector;this.totalChildCounterSelector=t.totalChildCounterSelector;this.urlRedirect=t.urlRedirect;this.menuDirsTypes=new BX.Mail.Client.Config.Dirs.DirsTypes({items:t.menuItemDirsTypes,dirs:t.dirs,mailboxId:t.mailboxId});this.selectAllButton=new BX.Mail.Client.Config.Dirs.SelectAllButton({container:t.dirs&&t.dirs.length>0?t.container:null,type:"prepend",className:"mail-config-dirs-button-select-all",id:"mail-dirs-dropdown-menu",updateLabel:false});this.init()};BX.Mail.Client.Config.Dirs.Form.prototype={init:function(){if(!this.container){return}this.loadData();this.addEvents()},loadData:function(){var t=this.container.querySelectorAll(":scope > "+this.itemRowSelector);for(var e=0;e<t.length;e++){var n={};n.container=t[e];n.checkbox=n.container.querySelector(this.itemContentSelector+" "+this.checkboxSelector);n.id=n.checkbox?n.checkbox.dataset.id:null;n.path=n.checkbox?n.checkbox.dataset.path:null;n.hasChild=n.checkbox?n.checkbox.dataset.haschild:false;n.level=n.checkbox?parseInt(n.checkbox.dataset.level):0;n.defaultChecked=n.checkbox?n.checkbox.checked:null;n.root=this;n.levelButton=n.container.querySelector(this.itemContentSelector+" "+this.levelButtonSelector);var i=new BX.Mail.Client.Config.Dirs.DropdownMenuItem(n);this.addItem(i)}},addEvents:function(){if(this.buttonSubmit){this.buttonSubmit.addEventListener("click",this.onSubmitForm.bind(this))}if(this.buttonCancel){this.buttonCancel.addEventListener("click",this.onCancelForm.bind(this))}if(this.selectAllButton){this.selectAllButton.getButton().addEventListener("change",this.onChangeSelectAllButton.bind(this))}},addItem:function(t){this.items[t.id]=t},onCancelForm:function(t){t.preventDefault();this.close()},onSubmitForm:function(t){t.preventDefault();var e=[];for(var n in this.items){if(!this.items[n].isModified()){continue}this.items[n].resetDefaultCheckbox();var i={};i.path=this.items[n].path;i.dirMd5=this.items[n].id;i.value=this.items[n].checkbox.checked?1:0;e.push(i)}var s=[];var o=this.menuDirsTypes.getItemsTypes();for(var l in o){if(!o.hasOwnProperty(l)){continue}var i={};i.path=o[l].path;i.dirMd5=o[l].dirMd5;i.type=l;s.push(i)}if(!e.length&&!s.length){this.close();return}BX.ajax.runComponentAction("bitrix:mail.client.config.dirs","save",{mode:"class",data:{mailboxId:this.mailboxId,dirs:e,dirsTypes:s}}).then(function(t){this.close();top.BX.SidePanel.Instance.postMessage(window,"mail-mailbox-config-dirs-success",{changed:true})}.bind(this),function(t){}.bind(this))},close:function(){var t=top.BX.SidePanel.Instance.getSliderByWindow(window);if(t){t.setCacheable(false);t.close()}else{window.location.href=this.urlRedirect}},setUnSelectAllButton:function(){if(this.selectAllButton){this.selectAllButton.setChecked(false)}},setSelectAllButton:function(){if(this.isSelectedAll()){this.selectAllButton.setChecked(true)}},onChangeSelectAllButton:function(t){this.selectAll(t.target.checked)},selectAll:function(t){for(var e in this.items){if(!this.items.hasOwnProperty(e)){continue}if(this.items[e].container.offsetHeight==0){continue}this.items[e].setCheckboxChecked(t)}},isSelectedAll:function(){for(var t in this.items){if(!this.items.hasOwnProperty(t)){continue}if(!this.items[t].isSelectedAll()){return false}}return true}};BX.Mail.Client.Config.Dirs.DropdownMenuItem=function(t){this.id=t.id;this.path=t.path;this.container=t.container;this.checkbox=t.checkbox;this.defaultChecked=t.defaultChecked;this.hasChild=t.hasChild;this.level=t.level;this.subMenuOpen=t.subMenuOpen||false;this.subMenu=t.subMenu||null;this.parent=t.parent||null;this.root=t.root;this.levelButton=new BX.Mail.Client.Config.Dirs.LevelButton({button:t.levelButton});this.subItems={};this.selectAllButton=t.hasChild?new BX.Mail.Client.Config.Dirs.SelectAllButton({container:t.container.querySelector(this.root.itemContentSelector),className:"mail-config-dirs-button-select",id:t.id,updateLabel:true}):null;this.childCounter=new BX.Mail.Client.Config.Dirs.ChildCounter({container:t.container.querySelector(this.root.childCounterContainerSelector),syncCounter:t.container.querySelector(this.root.syncChildCounterSelector),totalCounter:t.container.querySelector(this.root.totalChildCounterSelector)});this.init()};BX.Mail.Client.Config.Dirs.DropdownMenuItem.prototype={init:function(){this.loadData();this.addEvents();if(!this.hasSyncChildren()){this.hideSubmenu()}else{this.showSubmenu()}},loadData:function(){this.loadSubmenu();this.loadSubItems()},reloadData:function(t){this.removeSubmenu();this.addSubmenu(t.html);this.loadData();this.showSubmenu();this.countParentAllChildCounter()},loadSubmenu:function(){this.subMenuOpen=this.container.querySelectorAll(this.root.itemRowSelector).length>0;this.subMenu=this.container.querySelector(":scope > "+this.root.subMenuSelector)},loadSubItems:function(){if(!this.subMenu){return}var t=this.subMenu.querySelectorAll(":scope > "+this.root.itemRowSelector);for(var e=0;e<t.length;e++){var n={};n.container=t[e];n.checkbox=n.container.querySelector(this.root.itemContentSelector+" "+this.root.checkboxSelector);n.id=n.checkbox?n.checkbox.dataset.id:null;n.path=n.checkbox?n.checkbox.dataset.path:null;n.hasChild=n.checkbox?n.checkbox.dataset.haschild:false;n.level=n.checkbox?parseInt(n.checkbox.dataset.level):0;n.defaultChecked=n.checkbox?n.checkbox.checked:null;n.root=this.root;n.parent=this;n.levelButton=n.container.querySelector(this.root.itemContentSelector+" "+this.root.levelButtonSelector);var i=new BX.Mail.Client.Config.Dirs.DropdownMenuItem(n);this.addSubItem(i);this.root.addItem(i)}},addEvents:function(){this.checkbox.addEventListener("change",this.onChangeCheckbox.bind(this));if(this.levelButton&&this.levelButton.getButton()){this.levelButton.getButton().addEventListener("click",this.onClickLevelButton.bind(this))}if(this.selectAllButton&&this.selectAllButton.getButton()){this.selectAllButton.getButton().addEventListener("click",this.onClickSelectAllButton.bind(this))}},hasSyncChildren:function(){if(!this.subMenu){return false}var t=this.subMenu.querySelectorAll(this.root.itemContentSelector+" "+this.root.checkboxSelector);for(var e=0;e<t.length;e++){if(t[e].checked){return true}}return false},showSubmenu:function(){this.subMenuOpen=true;if(this.subMenu){this.subMenu.style.display="block"}this.updateLevelButton();this.updateSelectAllButton(this.isSelectedAll());if(this.selectAllButton&&this.selectAllButton.label){this.selectAllButton.label.style.display=""}},hideSubmenu:function(){this.subMenuOpen=false;if(this.subMenu){this.subMenu.style.display="none"}this.updateLevelButton();this.updateSelectAllButton(this.getCheckboxChecked());if(this.selectAllButton&&this.selectAllButton.label){this.selectAllButton.label.style.setProperty("display","none","important")}},updateLevelButton:function(){if(this.levelButton){this.levelButton.update(this.subMenuOpen)}},onClickLevelButton:function(t){t.preventDefault();this.toggleSubmenu()},toggleSubmenu:function(){if(this.subMenuOpen){this.hideSubmenu();return}if(this.level<this.root.maxLevelDirs){if(this.subMenu){this.showSubmenu()}else{this.getLevelDirs()}}},getLevelDirs:function(){var t={};t.path=this.path;t.dirMd5=this.id;this.levelButton.showLoader();BX.ajax.runComponentAction("bitrix:mail.client.config.dirs","level",{mode:"class",data:{mailboxId:this.root.mailboxId,dir:t}}).then(function(t){this.reloadData(t.data);this.levelButton.hideLoader()}.bind(this),function(t){if(t.errors&&t.errors.length>0){this.notify(t.errors.map(function(t){return t.message}).join("<br>"),5e3)}else{this.notify(BX.message("MAIL_CLIENT_AJAX_ERROR"))}this.levelButton.hideLoader()}.bind(this))},notify:function(t,e){top.BX.UI.Notification.Center.notify({autoHideDelay:e>0?e:2e3,content:t,category:"mailbox-dirs"})},onChangeCheckbox:function(t){var e=t.target.checked;this.updateSelectAllButton(e);if(!e){this.decrementParentSyncChildCounter()}else{this.incrementParentSyncChildCounter()}},updateSelectAllButton:function(t){if(t){this.setParentSelectAllButton();this.root.setSelectAllButton()}else{this.setParentUnSelectAllButton();this.root.setUnSelectAllButton()}},getCheckbox:function(){return this.checkbox},setCheckboxChecked:function(t){if(this.checkbox.checked!==t){this.checkbox.click()}},isModified:function(){return this.defaultChecked!==this.getCheckboxChecked()},resetDefaultCheckbox:function(){this.defaultChecked=this.getCheckboxChecked()},getCheckboxChecked:function(){return this.checkbox.checked},addSubItem:function(t){this.subItems[t.id]=t},removeSubItems:function(){for(var t in this.subItems){delete this.subItems[t]}},addSubmenu:function(t){if(!t){return}var e=document.createElement("div");e.className=this.root.subMenuSelector.replace(".","");e.innerHTML=t;this.container.appendChild(e)},removeSubmenu:function(){if(this.subMenu&&this.subMenu.parentNode){this.subMenu.parentNode.removeChild(this.subMenu)}this.removeSubItems()},setSelectAllButton:function(t){if(!this.selectAllButton){return}this.selectAllButton.setChecked(t)},setParentSelectAllButton:function(){if(this.isSelectedAll()){this.setSelectAllButton(true);if(this.parent){this.parent.setParentSelectAllButton()}}},setParentUnSelectAllButton:function(){this.setSelectAllButton(false);if(this.parent){this.parent.setParentUnSelectAllButton()}},isSelectedAll:function(){if(this.container.offsetHeight==0){return true}if(!this.getCheckboxChecked()){return false}for(var t in this.subItems){if(!this.subItems[t].isSelectedAll()){return false}}return true},onClickSelectAllButton:function(t){var e=t.target.checked;this.selectAll(e);if(!e){this.setParentUnSelectAllButton()}else{this.setParentSelectAllButton()}},selectAll:function(t){this.setSelectAllButton(t);this.setCheckboxChecked(t);for(var e in this.subItems){if(!this.subItems.hasOwnProperty(e)){continue}if(this.subItems[e].container.offsetHeight==0){continue}this.subItems[e].selectAll(t)}},countParentAllChildCounter:function(t){if(typeof t=="undefined"){t=true}var e=this.countSyncChildCounter(t);var n=this.countTotalChildCounter(t);this.childCounter.setSyncCounter(e);this.childCounter.setTotalCounter(n);if(this.parent){this.parent.countParentAllChildCounter(false)}},countSyncChildCounter:function(t){var e=0;for(var n in this.subItems){if(!this.subItems.hasOwnProperty(n)){continue}var i=this.subItems[n].getCheckboxChecked()?1:0;e+=this.subItems[n].childCounter.getSyncCounter()+i;if(t){e+=this.subItems[n].countSyncChildCounter(t)}}return e},countTotalChildCounter:function(t){var e=0;for(var n in this.subItems){if(!this.subItems.hasOwnProperty(n)){continue}e+=this.subItems[n].childCounter.getTotalCounter()+1;if(t){e+=this.subItems[n].countTotalChildCounter(t)}}return e},decrementParentSyncChildCounter:function(t){if(typeof t=="undefined"){t=false}if(t){this.childCounter.decrementSyncCounter()}if(this.parent){this.parent.decrementParentSyncChildCounter(true)}},incrementParentSyncChildCounter:function(t){if(typeof t=="undefined"){t=false}if(t){this.childCounter.incrementSyncCounter()}if(this.parent){this.parent.incrementParentSyncChildCounter(true)}}};BX.Mail.Client.Config.Dirs.DirsTypes=function(t){this.items=t.items;this.dirs=t.dirs;this.itemsTypes={};this.menuDropdown=null;this.cache={};this.mailboxId=t.mailboxId;this.dataId=null;this.dataType=null;this.init()};BX.Mail.Client.Config.Dirs.DirsTypes.prototype={init:function(){this.addEvents()},addEvents:function(){for(var t=0;t<this.items.length;t++){this.items[t].addEventListener("click",this.onClickMenuDropdown.bind(this))}BX.Event.EventEmitter.subscribe("BX.Main.Menu.Item:onmouseenter",function(t){var e=t.target;if(!e.dataset||!e.getMenuWindow()){return}var n=e.getMenuWindow();var i=n.getMenuItems();var s=e.dataset.path;var o=e.dataset.dirMd5;var l=e.dataset.hasChild;if(!l){return}for(var r=0;r<i.length;r++){var u=i[r];if(u.getId()===s){var h=u.hasSubMenu();if(h){u.showSubMenu();var a=u.getSubMenu();if(a){var c=a.getMenuItems();var d=false;for(var f=0;f<c.length;f++){var C=c[f];if(C.getId()==="loading"){d=true}}}if(!d){return}}this.loadLevelMenu(u,o)}}}.bind(this))},loadLevelMenu:function(t,e){var n=this.getCache(t.getId());var i=BX.Main.PopupManager.getPopupById("menu-popup-popup-submenu-"+t.getId());if(i){i.destroy()}if(n){t.destroySubMenu();t.addSubMenu(n);t.showSubMenu();return}var s={id:"loading",text:BX.message("MAIL_CLIENT_BUTTON_LOADING"),disabled:true};t.destroySubMenu();t.addSubMenu([s]);t.showSubMenu();BX.ajax.runComponentAction("bitrix:mail.client.config.dirs","level",{mode:"class",data:{mailboxId:this.mailboxId,dir:{path:t.getId(),dirMd5:e}}}).then(function(e){var n=e.data.dirs;var i=this.getDataDropdownMenu(n);this.setCache(t.getId(),i);var s=BX.Main.PopupManager.getPopupById("popup-submenu-"+t.getId());var o=t.getMenuWindow().getPopupWindow().isShown();if(s){s.destroy()}if(o){t.destroySubMenu();t.addSubMenu(i);t.showSubMenu()}}.bind(this),function(t){}.bind(this))},getCache:function(t){if(!t){return}return this.cache[t]?this.cache[t]:null},setCache:function(t,e){return this.cache[t]=e},getItemsTypes:function(){return this.itemsTypes},setItemsTypes:function(t){this.itemsTypes[this.dataType]={path:t.dataset.path,dirMd5:t.dataset.dirMd5}},onClickMenuDropdown:function(t){t.preventDefault();this.dataId=t.currentTarget.getAttribute("data-id");this.dataType=t.currentTarget.getAttribute("data-type");var e=this.getDataDropdownMenu(this.dirs);this.showMenuDropdown(e,t.target)},getDataDropdownMenu:function(t){var e=[];for(var n=0;n<t.length;n++){var i=/(HasChildren)/i.test(t[n].FLAGS);var s={};s.id=t[n].PATH;s.text=t[n].NAME;s.title=t[n].FORMATTED_NAME;s.className=t[n].IS_DISABLED?"menu-popup-no-icon mail-dirs-menu-disabled":"";s.dataset={path:t[n].PATH,dirMd5:t[n].DIR_MD5,isDisabled:t[n].IS_DISABLED,hasChild:i};s.items=t[n].CHILDREN&&t[n].CHILDREN.length?this.getDataDropdownMenu(t[n].CHILDREN):i?[{id:"loading",text:BX.message("MAIL_CLIENT_BUTTON_LOADING"),disabled:true}]:[];s.onclick=this.onClickMenuDropdownItem.bind(this);e.push(s)}return e},onClickMenuDropdownItem:function(t,e){if(e.dataset.isDisabled){t.preventDefault();return}this.setItemsTypes(e);var n=document.querySelector('[data-id="'+this.dataId+'"]');if(n){n.innerHTML=e.title}this.closeMenuDropdown()},showMenuDropdown:function(t,e){this.menuDropdown=BX.Main.MenuManager.create({id:"mail-client-config-dirs-dropdown-menu",autoHide:true,closeByEsc:true,items:t,zIndex:7001,maxHeight:400,maxWidth:200,events:{onPopupClose:function(){this.removeMenuDropdown()}.bind(this)}});this.menuDropdown.popupWindow.setBindElement(e);this.menuDropdown.show()},closeMenuDropdown:function(){if(this.menuDropdown){this.menuDropdown.close()}},removeMenuDropdown:function(){if(this.menuDropdown){BX.Main.MenuManager.destroy(this.menuDropdown.id)}}};BX.Mail.Client.Config.Dirs.LevelButton=function(t){this.button=t.button};BX.Mail.Client.Config.Dirs.LevelButton.prototype={update:function(t){if(!this.button){return}if(t){this.button.classList.remove("mail-config-dirs-plus-icon");this.button.classList.add("mail-config-dirs-minus-icon")}else{this.button.classList.remove("mail-config-dirs-minus-icon");this.button.classList.add("mail-config-dirs-plus-icon")}},getButton:function(){return this.button},showLoader:function(){if(!this.button){return}this.button.classList.add("mail-config-dirs-loader-icon")},hideLoader:function(){if(!this.button){return}this.button.classList.remove("mail-config-dirs-loader-icon")}};BX.Mail.Client.Config.Dirs.SelectAllButton=function(t){this.container=t.container;this.className=t.className;this.id="select-all-button-"+t.id;this.type=t.type;this.updateLabel=t.updateLabel;this.button=null;this.label=null;this.init()};BX.Mail.Client.Config.Dirs.SelectAllButton.prototype={init:function(){this.addButton()},addButton:function(){if(!this.container){return}var t=document.createElement("div");t.className=this.className;this.button=document.createElement("input");this.button.type="checkbox";this.button.id=this.id;this.button.className=this.className+"-input";this.label=document.createElement("label");this.label.htmlFor=this.id;this.label.className=this.className+"-label";this.label.textContent=BX.message("MAIL_CLIENT_CONFIG_DIRS_BTN_SELECT_ALL");t.appendChild(this.button);t.appendChild(this.label);if(this.type==="prepend"){this.container.prepend(t)}else{this.container.appendChild(t)}},update:function(){if(!this.updateLabel||!this.label){return}if(!this.button.checked){this.label.textContent=BX.message("MAIL_CLIENT_CONFIG_DIRS_BTN_SELECT_ALL")}else{this.label.textContent=BX.message("MAIL_CLIENT_CONFIG_DIRS_BTN_CANCEL_ALL")}},getButton:function(){return this.button},setChecked:function(t){if(!this.button){return}this.button.checked=t;this.update()}};BX.Mail.Client.Config.Dirs.ChildCounter=function(t){this.container=t.container;this.syncCounter=t.syncCounter;this.totalCounter=t.totalCounter;this.init()};BX.Mail.Client.Config.Dirs.ChildCounter.prototype={init:function(){},decrementSyncCounter:function(){var t=this.getSyncCounter();this.setSyncCounter(t-1);this.toggleCounter()},incrementSyncCounter:function(){var t=this.getSyncCounter();this.setSyncCounter(t+1);this.toggleCounter()},setSyncCounter:function(t){if(!this.syncCounter){return}this.syncCounter.textContent=t>0?t:0},getSyncCounter:function(){if(!this.syncCounter){return 0}return parseInt(this.syncCounter.textContent)},setTotalCounter:function(t){if(!this.totalCounter){return}this.totalCounter.textContent=t>0?t:0},getTotalCounter:function(){if(!this.totalCounter){return}return parseInt(this.totalCounter.textContent)},toggleCounter:function(){var t=this.getSyncCounter();if(t>0){this.showCounter()}else{this.hideCounter()}},showCounter:function(){if(!this.container){return}this.container.classList.add("show")},hideCounter:function(){if(!this.container){return}this.container.classList.remove("show")}}})();
//# sourceMappingURL=script.map.js