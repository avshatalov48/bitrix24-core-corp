(function(){BX.namespace("BX.Mail.Client.Message.List.UserInterfaceManager");BX.Mail.Client.Message.List.UserInterfaceManager=function(e){this.gridId=e.gridId;this.mailboxId=e.mailboxId;this.userHasCrmActivityPermission=e.userHasCrmActivityPermission;this.spamDir=e.spamDir;this.outcomeDir=e.outcomeDir;this.inboxDir=e.inboxDir;this.trashDir=e.trashDir;this.PATH_TO_USER_TASKS_TASK=e.PATH_TO_USER_TASKS_TASK;this.PATH_TO_USER_BLOG_POST=e.PATH_TO_USER_BLOG_POST;this.ENTITY_TYPE_NO_BIND=e.ENTITY_TYPE_NO_BIND;this.ENTITY_TYPE_CRM_ACTIVITY=e.ENTITY_TYPE_CRM_ACTIVITY;this.ENTITY_TYPE_TASKS_TASK=e.ENTITY_TYPE_TASKS_TASK;this.ENTITY_TYPE_BLOG_POST=e.ENTITY_TYPE_BLOG_POST;this.settingsMenu=e.settingsMenu;this.readActionBtnRole="read-action";this.spamActionBtnRole="spam-action";this.crmActionBtnRole="crm-action";this.hideClassName="main-ui-hide";this.mailboxMenuToggle=document.querySelector('[data-role="mailbox-current-title"]');this.settingsToggle=document.querySelector('[data-role="mail-list-settings-menu-popup-toggle"]');this.mailboxMenuCurrentUnseenCounter=document.querySelector('[data-role="unseen-total"]');this.mailboxPopupMenuId="mail-msg-list-mailbox-menu";this.UNREAD_COUNTER_TYPE="unread";this.isCurrentFolderSpam=false;this.isCurrentFolderTrash=false;this.isCurrentFolderOutcome=false;this.setLastDir();this.initMailboxes(e.mailboxMenu);this.setCurrentFolderFlags(this.getFilterInstance());this.addEventHandlers();this.updateLeftMenuCounter();this.setDefaultBtnTitles()};BX.Mail.Client.Message.List.UserInterfaceManager.prototype={initMailboxes:function(e){this.mailboxMenu=e;this.mailboxesUnseen={};for(var t=0;t<this.mailboxMenu.length;t++){if(!(this.mailboxMenu[t]&&this.mailboxMenu[t].dataset)){continue}this.mailboxesUnseen[this.mailboxMenu[t].dataset.mailboxId]=this.mailboxMenu[t].dataset.unseen}BX.Main.MenuManager.destroy(this.mailboxPopupMenuId)},addEventHandlers:function(){if(this.mailboxMenuToggle){BX.bind(this.mailboxMenuToggle,"click",BX.delegate(this.onMailboxMenuClick,this))}if(this.settingsToggle){BX.bind(this.settingsToggle,"click",BX.delegate(this.onSettingsToggleClick,this))}BX.addCustomEvent("BX.Main.Filter:apply",this.onApplyFilter.bind(this));BX.addCustomEvent("BX.UI.ActionPanel:hidePanel",this.setDefaultBtnTitles.bind(this));BX.addCustomEvent("Grid::updated",this.setDefaultBtnTitles.bind(this));BX.addCustomEvent("Grid::thereSelectedRows",this.handleGridSelectItem.bind(this));BX.addCustomEvent("Grid::allRowsSelected",this.handleGridSelectItem.bind(this));BX.addCustomEvent("SidePanel.Slider:onMessage",function(e){if(e.getEventId()==="mail-message-view"){var t=BX.findParent(document.querySelector(".mail-msg-list-cell-"+e.getData().id),{tagName:"tr"});if(t&&t.dataset.id&&t.getElementsByClassName("mail-msg-list-cell-unseen").length!==0){this.updateUnreadCounters(-1);this.onMessagesRead([t.dataset.id],{action:"markAsSeen"})}}else if(e.getEventId()==="Mail.Client.MessageCreatedSuccess"){if(this.isCurrentFolderOutcome){this.reloadGrid({})}this.resetGridSelection()}}.bind(this));BX.addCustomEvent("onPullEvent-mail",this.onBindingCreated.bind(this));this.trackActionPanelStyleChange();BX.addCustomEvent(window,"onPopupShow",function(e){if(!(e.uniquePopupId.indexOf("menu-popup-main-grid-actions-menu-")==0&&e.getPopupContainer()&&e.bindElement&&e.bindElement.parentElement)){return}this.updateRowMenuSeenBtn(e);this.updateRowMenuSpamBtn(e);this.updateRowMenuCrmBtn(e)}.bind(this))},onCrmBindingDeleted:function(e){var t=document.querySelector(".js-bind-"+e);if(!t){return}var n=this.ENTITY_TYPE_CRM_ACTIVITY;var i=t.querySelector('[data-type="'+n+'"]');if(!i){return}i.parentNode.removeChild(i);var s=t.firstChild;var a=t.lastChild;if(s&&s.dataset&&s.dataset.role==="comma-separator"){s.parentNode.removeChild(s)}if(a&&a.dataset&&a.dataset.role==="comma-separator"){a.parentNode.removeChild(a)}if(t.childElementCount===0){this.updateGridByUnbindFilter()}},onBindingCreated:function(e,t){if("messageBindingCreated"===e&&this.mailboxId==t.mailboxId){this.resetGridSelection();var n=document.querySelector(".js-bind-"+t.messageId);if(n){var i=false;var s=n.querySelectorAll("[data-type]");if(s&&s.length>0){for(var a=0;a<s.length;a++){if(s[a].dataset.type===t.entityType){i=true;break}}}if(!i){var r;switch(t.entityType){case this.ENTITY_TYPE_TASKS_TASK:r=BX.create("a",{attrs:{href:this.PATH_TO_USER_TASKS_TASK.replace("#action#","view").replace("#task_id#",t.entityId)},children:[BX.create("span",{dataset:{type:t.entityType},text:BX.message("MAIL_MESSAGE_LIST_COLUMN_BIND_TASKS_TASK")})]});break;case this.ENTITY_TYPE_BLOG_POST:r=BX.create("a",{attrs:{href:this.PATH_TO_USER_BLOG_POST.replace("#post_id#",t.entityId),onclick:"top.BX.SidePanel.Instance.open(this.href, {loader: 'socialnetwork:userblogpost'}); return false; "},children:[BX.create("span",{dataset:{type:t.entityType},text:BX.message("MAIL_MESSAGE_LIST_COLUMN_BIND_BLOG_POST")})]});break;case this.ENTITY_TYPE_CRM_ACTIVITY:if(this.userHasCrmActivityPermission){r=BX.create("span",{dataset:{role:"crm-binding-link",entityId:t.entityId,type:t.entityType},children:[BX.create("a",{attrs:{href:t.bindingEntityLink?t.bindingEntityLink:"#"},text:BX.message("MAIL_MESSAGE_LIST_COLUMN_BIND_CRM_ACTIVITY")})]});break}r=BX.create("span",{dataset:{type:t.entityType},text:BX.message("MAIL_MESSAGE_LIST_COLUMN_BIND_CRM_ACTIVITY")});break;default:break}if(r){if(s.length>0){n.appendChild(document.createTextNode(", "))}n.appendChild(r);this.updateGridByUnbindFilter()}}}}},trackActionPanelStyleChange:function(){var e=document.querySelector(".ui-action-panel");if(!e){return}var t=BX.Main.gridManager.getById(this.gridId).instance;var n=BX.create("input",{props:{type:"checkbox",disabled:t.getRows().getCountDisplayed()==0},style:{verticalAlign:"middle"}});var i=BX.create("span",{style:{display:"inline-block",height:"100%",paddingLeft:"10px"},children:[n,BX.create("span",{style:{display:"inline-block",height:"100%",verticalAlign:"middle"}})]});var s=t.getCheckAllCheckboxes.bind(t);t.getCheckAllCheckboxes=function(){var e=s();e.push(new BX.Grid.Element(n));return e};var a=t.enableCheckAllCheckboxes.bind(t);t.enableCheckAllCheckboxes=function(){setTimeout(function(){if(t.getRows().getCountDisplayed()>0){a()}},0)};t.bindOnCheckAll();e.insertBefore(i,e.firstChild)},getGridHeaderCheckbox:function(){if(this.gridHeaderCheckbox===undefined){this.gridHeaderCheckbox=document.querySelector("#"+this.gridId+"_table .main-grid-cell-head.main-grid-cell-checkbox")}return this.gridHeaderCheckbox},showElement:function(e,t){if(e&&t){e.style.display="block"}else if(e){e.classList.remove(this.hideClassName)}},hideElement:function(e,t){if(e&&t){e.style.display="none"}else if(e){e.classList.add(this.hideClassName)}},updateRowMenuSpamBtn:function(e){var t=BX.findParent(e.getPopupContainer().querySelector('[data-role^="not-spam"]'),{className:"menu-popup-item"});var n=BX.findParent(e.getPopupContainer().querySelector('[data-role^="spam"]'),{className:"menu-popup-item"});if(this.isCurrentFolderSpam){this.showElement(t,true);this.hideElement(n,true)}else{this.showElement(n,true);this.hideElement(t,true)}},updateRowMenuCrmBtn:function(e){var t=BX.findParent(e.bindElement.parentElement,{className:"main-grid-row"});if(t&&t.dataset&&t.dataset.id){var n=this.getGridInstance().getRows().getById(t.dataset.id);if(n){n.getActionsMenu()}var i=BX.findParent(e.getPopupContainer().querySelector('[data-role^="crm"]'),{className:"menu-popup-item"});var s=BX.findParent(e.getPopupContainer().querySelector('[data-role^="not-crm"]'),{className:"menu-popup-item"});var a=this.isAddToCrmActionAvailable(n.node);if(a){this.showElement(i,true);this.hideElement(s,true)}else{this.showElement(s,true);this.hideElement(i,true)}}},isAddToCrmActionAvailable:function(e){if(e){var t=e.querySelector('[class^="js-bind"]');if(t){var n=t.querySelectorAll('[data-role="crm-binding-link"]');if(n&&n.length>0){return false}}}return true},updateRowMenuSeenBtn:function(e){var t=BX.findParent(e.bindElement.parentElement,{className:"main-grid-row"});if(t&&t.dataset&&t.dataset.id){var n=this.getGridInstance().getRows().getById(t.dataset.id);if(n){n.getActionsMenu()}var i=BX.findParent(e.getPopupContainer().querySelector('[data-role^="not-read"]'),{className:"menu-popup-item"});var s=BX.findParent(e.getPopupContainer().querySelector('[data-role^="read"]'),{className:"menu-popup-item"});var a=this.isSelectedRowsHaveClass("mail-msg-list-cell-unseen",t.dataset.id)?"markAsSeen":"markAsUnseen";if(a==="markAsSeen"){this.showElement(s,true);this.hideElement(i,true)}else{this.showElement(i,true);this.hideElement(s,true)}}},onMessagesRead:function(e,t){this.changeMessageRead(e,t);this.updateGridByUnseenFilter()},updateGridByUnseenFilter:function(){var e=this.getFilterInstance();if(e.getFilterFieldsValues()&&e.getFilterFieldsValues()["IS_SEEN"]!==""){this.reloadGrid({})}},updateGridByUnbindFilter:function(){var e=this.getFilterInstance();if(e.getFilterFieldsValues()&&e.getFilterFieldsValues()["BIND"]!==""){this.reloadGrid({})}},onPopupMenuFirstShow:function(e){BX.bind(e.contentContainer,"click",function(){e.close()})},onSettingsToggleClick:function(){var e=BX.PopupMenu.create("mail-msg-list-settings-menu",this.settingsToggle,this.settingsMenu,{events:{onPopupFirstShow:this.onPopupMenuFirstShow}});e.popupWindow.isShown()?e.close():e.show()},onMailboxMenuClick:function(){var e=BX.Main.MenuManager.create(this.mailboxPopupMenuId,this.mailboxMenuToggle,this.mailboxMenu,{events:{onPopupFirstShow:this.onPopupMenuFirstShow}});e.popupWindow.isShown()?e.close():e.show()},closeMailboxMenu:function(){var e=BX.Main.MenuManager.getMenuById(this.mailboxPopupMenuId);if(e){e.close()}},updateUnreadCounters:function(e){var t=this.getCurrentFolder();this.updateTotalUnseenCounter(e);if([this.spamDir,this.trashDir].includes(t)){this.updateMailboxMenuUnseenCounter(e,false);this.updateQuickFilterUnseenCounter(e);return}this.updateMailboxMenuCurrentUnseenCounter();this.updateMailboxMenuUnseenCounter(e);this.updateQuickFilterUnseenCounter(e);this.updateLeftMenuCounter()},updateTotalUnreadCounters:function(e,t){this.setTotalUnseenCounter(e);this.setMailboxMenuCurrentUnseenCounter(e);this.setQuickFilterUnseenCounter(t);this.updateLeftMenuCounter()},updateLeftMenuCounter:function(){var e=this.getTotalUnseenCounter();if(typeof top.B24==="object"&&typeof top.B24.updateCounters==="function"&&e>0){top.B24.updateCounters({mail_unseen:e})}if(typeof top.BXIM==="object"&&typeof top.BXIM.notify==="object"){if(typeof top.BXIM.notify.counters==="object"){top.BXIM.notify.counters.mail_unseen=e}if(typeof top.BXIM.notify.updateNotifyMailCount==="function"){top.BXIM.notify.updateNotifyMailCount(e)}}},updateTotalUnseenCounter:function(e){var t=this.getTotalUnseenCounter();var n=parseInt(t)+parseInt(e);this.setTotalUnseenCounter(n)},updateMailboxUnseenCounter:function(e){this.updateMailboxMenuUnseenCounter(e)},getTotalUnseen:function(){return this.getTotalUnseenCounter()},getTotalUnseenCounter:function(){var e=this.getCurrentMailboxId();return this.mailboxesUnseen[e]||0},updateCounter:function(e,t){if(e===this.UNREAD_COUNTER_TYPE){this.updateQuickFilterUnseenCounter(t)}},changeMessageRead:function(e,t){if(t.action==="markAsSeen"){for(var n=0;n<e.length;n++){var i=this.getGridInstance().getRows().getById(e[n]);if(i&&i.node){var s=i.node.getElementsByClassName("mail-msg-list-cell-unseen");for(var a=s.length-1;a>=0;a--){s[a].classList.remove("mail-msg-list-cell-unseen")}}}}else if(t.action==="markAsUnseen"){for(var n=0;n<e.length;n++){var i=this.getGridInstance().getRows().getById(e[n]);if(i&&i.node){i.node.cells[2].classList.add("mail-msg-list-cell-unseen");i.node.cells[3].classList.add("mail-msg-list-cell-unseen")}}}},handleGridSelectItem:function(){this.updateSeenAllBtn();this.updateSeenBtn();this.updateCrmBtn();this.updateSpamBtn();var e=document.createEvent("Event");e.initEvent("resize",true,true);window.dispatchEvent(e)},disActivateBtn:function(e){this.activateBtn(e,false)},activateBtn:function(e,t){t=t===undefined||t===true;this.toggleButton(e,t);this.toggleButton("not-"+e,!t)},toggleButton:function(e,t){var n=document.querySelectorAll('[data-role^="'+e+'"]');Array.prototype.slice.call(n,0).forEach(function(e){var n=BX.findParent(e,{className:"ui-action-panel-item"});n=n?n:BX.findParent(e,{className:"main-grid-row"});t?this.showElement(n):this.hideElement(n)}.bind(this))},updateCrmBtn:function(){var e=this.getGridInstance().getRows().getSelectedIds();if(e.length!==1){this.activateBtn(this.crmActionBtnRole);return}var t=this.getGridInstance().getRows().getById(e[0]);if(!(t&&t.node)){return}var n=this.isAddToCrmActionAvailable(t.node);if(n){this.activateBtn(this.crmActionBtnRole)}else{this.disActivateBtn(this.crmActionBtnRole)}},updateSpamBtn:function(){if(this.isCurrentFolderSpam){this.disActivateBtn(this.spamActionBtnRole)}else{this.activateBtn(this.spamActionBtnRole)}},updateSeenBtn:function(){var e=this.isSelectedRowsHaveClass("mail-msg-list-cell-unseen")?"markAsSeen":"markAsUnseen";if(e==="markAsSeen"){this.activateBtn(this.readActionBtnRole)}else{this.disActivateBtn(this.readActionBtnRole)}},updateSeenAllBtn:function(){this.toggleButton("read-all-action",this.getGridInstance().getRows().getSelected().length==0)},setDefaultBtnTitles:function(e){if(e&&document.querySelectorAll('[data-role^="read-all-action"]').length==0){e.buildPanelByGroup()}var t=BX.Main.MenuManager.getMenuById("ui-action-panel-item-popup-menu");t&&t.close();this.toggleButton("read-all-action",true);this.toggleButton(this.readActionBtnRole,false);this.toggleButton("not-"+this.readActionBtnRole,false);this.activateBtn(this.crmActionBtnRole);this.updateSpamBtn();var n=document.createEvent("Event");n.initEvent("resize",true,true);window.dispatchEvent(n)},getRowMenu:function(){var e=this.getGridInstance().getRows().getSelectedIds();id=e.length?e[0]:null;var t=id?this.getGridInstance().getRows().getById(id):null;if(t){return t.getActionsMenu()}return null},onUnreadCounterClick:function(){var e=this.getFilterInstance();var t=e.getApi();t.setFields({DIR:e.getFilterFieldsValues()["DIR"],IS_SEEN:"N"});t.apply()},getFilterInstance:function(){return BX.Main.filterManager.getById(this.gridId)},onApplyFilter:function(e,t,n,i,s){if(e!==this.gridId){return}this.setCurrentFolderFlags(n);this.setDefaultBtnTitles()},setCurrentFolderFlags:function(e){var t=e.getPreset().getCurrentPresetId();this.isCurrentFolderTrash=this.trashDir!==""&&(t==="trash"||e.getFilterFieldsValues()&&e.getFilterFieldsValues()["DIR"]===this.trashDir);this.isCurrentFolderSpam=this.spamDir!==""&&(t==="spam"||e.getFilterFieldsValues()&&e.getFilterFieldsValues()["DIR"]===this.spamDir);this.isCurrentFolderOutcome=this.outcomeDir!==""&&(t==="outcome"||e.getFilterFieldsValues()&&e.getFilterFieldsValues()["DIR"]===this.outcomeDir)},getLastDir:function(){return this.lastDir},setLastDir:function(){this.lastDir=this.getCurrentFolder()},getCurrentFolder:function(){var e=this.getFilterInstance();var t=e.getFilterFieldsValues()["DIR"];return t||this.inboxDir},getCurrentMailboxId:function(){var e=document.querySelector('[data-role="mailbox-current-title"]');return e&&e.dataset&&e.dataset.mailboxId?e.dataset.mailboxId:null},setTotalUnseenCounter:function(e){var t=this.getCurrentMailboxId();this.mailboxesUnseen[t]=e},updateMailboxMenuCurrentUnseenCounter:function(){var e=this.getTotalUnseenCounter();this.setMailboxMenuCurrentUnseenCounter(e)},updateMailboxMenuUnseenCounter:function(e,t){if(typeof t=="undefined"){t=true}var n=this.getCurrentMailboxId();var i=this.getTotalUnseenCounter();if(!n){return}for(var s=0;s<this.mailboxMenu.length;s++){if(this.mailboxMenu[s]&&this.mailboxMenu[s].text&&this.mailboxMenu[s].dataset&&this.mailboxMenu[s].dataset.mailboxId==n){this.mailboxMenu[s]=this.updateMailboxMenuItemUnseenCounter(this.mailboxMenu[s],e,i,t);BX.Main.MenuManager.destroy(this.mailboxPopupMenuId);break}}},updateQuickFilterUnseenCounter:function(e){var t=this.getQuickFilterUnseenCounter();var n=parseInt(t)+parseInt(e);this.setQuickFilterUnseenCounter(n)},setQuickFilterUnseenCounter:function(e){var t=document.querySelector('[data-role="unread-counter-number"]');var n=document.querySelector('[data-role="unreadCounter"]');var i=document.querySelector('[data-role="emptyCountersTitle"]');if(!t){return}if(e>0){t.textContent=e;this.showElement(n);this.hideElement(i)}else{t.textContent="0";this.hideElement(n);this.showElement(i)}},getQuickFilterUnseenCounter:function(){var e=document.querySelector('[data-role="unread-counter-number"]');return e?e.textContent:0},setMailboxMenuCurrentUnseenCounter:function(e){this.mailboxMenuCurrentUnseenCounter.textContent=e;if(e>0){this.showElement(this.mailboxMenuCurrentUnseenCounter)}else{this.hideElement(this.mailboxMenuCurrentUnseenCounter)}},updateMailboxMenuItemUnseenCounter:function(e,t,n,i){if(i){e=this.setMailboxTitleMenuUnseenCounter(e,n)}if(!e.items){return e}e.items=this.updateMailboxSubMenuUnseenCounter(e.items,t);return e},setMailboxTitleMenuUnseenCounter:function(e,t){var n=this.hideClassName;if(t>0){n="";if(typeof e.dataset.path!="undefined"){if(e.unseen==0){n+=" mail-msg-list-menu-child-counter"}if(!e.dataset.isCounted){n+=" mail-msg-list-menu-fake-counter"}}}var i=/<span class="(main-buttons-item-counter)[\w -]*">[0-9]+<\/span>/g;var s='<span class="main-buttons-item-counter '+n+'">'+t+"</span>";if(e.text.match(i)){e.text=e.text.replace(i,s)}else{e.text+="&nbsp;"+s}e.dataset.unseen=t;return e},updateMailboxSubMenuUnseenCounter:function(e,t){var n=this.getCurrentFolder();for(var i=0;i<e.length;i++){var s=e[i].id;var a=e[i].dataset.delimiter||"";if(a&&n.indexOf(s+a)===0||n.localeCompare(s)===0){if(n.localeCompare(s)===0){e[i].unseen+=parseInt(t)}else{e[i].items_unseen+=parseInt(t)}var r=parseInt(e[i].unseen)+parseInt(e[i].items_unseen);e[i]=this.setMailboxTitleMenuUnseenCounter(e[i],r);if(!e[i].items){continue}e[i].items=this.updateMailboxSubMenuUnseenCounter(e[i].items,t)}}return e},isVisible:function(e){return e&&!e.classList.contains(this.hideClassName)}}})();
//# sourceMappingURL=user-interface-manager.map.js