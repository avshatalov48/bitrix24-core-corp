(function(){BX.namespace("BX.Mail.Client.Message.List.UserInterfaceManager");BX.Mail.Client.Message.List.UserInterfaceManager=function(e){this.gridId=e.gridId;this.mailboxId=e.mailboxId;this.userHasCrmActivityPermission=e.userHasCrmActivityPermission;this.spamDir=e.spamDir;this.outcomeDir=e.outcomeDir;this.inboxDir=e.inboxDir;this.trashDir=e.trashDir;this.PATH_TO_USER_TASKS_TASK=e.PATH_TO_USER_TASKS_TASK;this.PATH_TO_USER_BLOG_POST=e.PATH_TO_USER_BLOG_POST;this.ENTITY_TYPE_NO_BIND=e.ENTITY_TYPE_NO_BIND;this.ENTITY_TYPE_CRM_ACTIVITY=e.ENTITY_TYPE_CRM_ACTIVITY;this.ENTITY_TYPE_TASKS_TASK=e.ENTITY_TYPE_TASKS_TASK;this.ENTITY_TYPE_BLOG_POST=e.ENTITY_TYPE_BLOG_POST;this.settingsMenu=e.settingsMenu;this.readActionBtnRole="read-action";this.spamActionBtnRole="spam-action";this.crmActionBtnRole="crm-action";this.hideClassName="main-ui-hide";this.mailboxMenuToggle=document.querySelector('[data-role="mailbox-current-title"]');this.settingsToggle=document.querySelector('[data-role="mail-list-settings-menu-popup-toggle"]');this.mailboxPopupMenuId="mail-msg-list-mailbox-menu";this.isCurrentFolderSpam=false;this.isCurrentFolderTrash=false;this.isCurrentFolderOutcome=false;this.setLastDir();this.initMailboxes(e.mailboxMenu);this.setCurrentFolderFlags(this.getFilterInstance());this.addEventHandlers();this.updateLeftMenuCounter();this.setDefaultBtnTitles()};BX.Mail.Client.Message.List.UserInterfaceManager.prototype={initMailboxes:function(e){this.mailboxMenu=e;this.mailboxesUnseen={};for(var t=0;t<this.mailboxMenu.length;t++){if(!(this.mailboxMenu[t]&&this.mailboxMenu[t].dataset)){continue}this.mailboxesUnseen[this.mailboxMenu[t].dataset.mailboxId]=this.mailboxMenu[t].dataset.unseen}BX.Main.MenuManager.destroy(this.mailboxPopupMenuId)},addEventHandlers:function(){if(this.mailboxMenuToggle){BX.bind(this.mailboxMenuToggle,"click",BX.delegate(this.onMailboxMenuClick,this))}if(this.settingsToggle){BX.bind(this.settingsToggle,"click",BX.delegate(this.onSettingsToggleClick,this))}BX.addCustomEvent("BX.Main.Filter:apply",this.onApplyFilter.bind(this));BX.addCustomEvent("BX.UI.ActionPanel:hidePanel",this.setDefaultBtnTitles.bind(this));BX.addCustomEvent("BX.UI.ActionPanel:showPanel",this.setDefaultBtnOnShow.bind(this));BX.addCustomEvent("Grid::updated",function(){if(this.getGridInstance().getRows().getSelectedIds().length>0){BX.onCustomEvent(window,"Grid::thereSelectedRows")}}.bind(this));BX.addCustomEvent("Grid::thereSelectedRows",this.handleGridSelectItem.bind(this));BX.addCustomEvent("Grid::allRowsSelected",this.handleGridSelectItem.bind(this));BX.addCustomEvent("mail:openMessageForView",function(e){var t=e["id"];var i=BX.findParent(document.querySelector(".mail-msg-list-cell-"+t),{tagName:"tr"});if(i&&i.dataset.id&&i.getElementsByClassName("mail-msg-list-cell-unseen").length!==0){this.updateUnreadCounters();BX.Mail.Home.Counters.updateCounters([{name:this.getCurrentFolder(),lower:true,count:1}]);this.onMessagesRead([i.dataset.id],{action:"markAsSeen"})}}.bind(this));BX.addCustomEvent("SidePanel.Slider:onMessage",function(e){if(e.getEventId()==="Mail.Client.MessageCreatedSuccess"){if(this.isCurrentFolderOutcome){BX.Mail.Home.Grid.reloadTable()}}}.bind(this));BX.addCustomEvent("onPullEvent-mail",this.onBindingCreated.bind(this));this.trackActionPanelStyleChange();BX.addCustomEvent(window,"onPopupShow",function(e){if(!(e.uniquePopupId.indexOf("menu-popup-main-grid-actions-menu-")==0&&e.getPopupContainer()&&e.bindElement&&e.bindElement.parentElement)){return}this.updateRowMenuSeenBtn(e);this.updateRowMenuSpamBtn(e);this.updateRowMenuCrmBtn(e)}.bind(this))},onCrmBindingDeleted:function(e){var t=document.querySelector(".js-bind-"+e);if(!t){return}var i=this.ENTITY_TYPE_CRM_ACTIVITY;var n=t.querySelector('[data-type="'+i+'"]');if(!n){return}n.parentNode.removeChild(n);var a=t.firstChild;var s=t.lastChild;if(a&&a.dataset&&a.dataset.role==="comma-separator"){a.parentNode.removeChild(a)}if(s&&s.dataset&&s.dataset.role==="comma-separator"){s.parentNode.removeChild(s)}if(t.childElementCount===0){this.updateGridByUnbindFilter()}},onBindingCreated:function(e,t){if("messageBindingCreated"===e&&this.mailboxId==t.mailboxId){var i=document.querySelector(".js-bind-"+t.messageId);if(i){var n=false;var a=i.querySelectorAll("[data-type]");if(a&&a.length>0){for(var s=0;s<a.length;s++){if(a[s].dataset.type===t.entityType){n=true;break}}}if(!n){var r;switch(t.entityType){case this.ENTITY_TYPE_TASKS_TASK:r=BX.create("span",{attrs:{class:"mail-badge mail-badge-dark"},dataset:{type:t.entityType},children:[BX.create("a",{attrs:{href:this.PATH_TO_USER_TASKS_TASK.replace("#action#","view").replace("#task_id#",t.entityId),class:"mail-badge-item"},text:BX.message("MAIL_MESSAGE_LIST_COLUMN_BIND_TASKS_TASK")})]});break;case this.ENTITY_TYPE_BLOG_POST:r=BX.create("span",{attrs:{class:"mail-badge mail-badge-dark"},dataset:{type:t.entityType},children:[BX.create("a",{attrs:{class:"mail-badge-item",href:this.PATH_TO_USER_BLOG_POST.replace("#post_id#",t.entityId),onclick:"top.BX.SidePanel.Instance.open(this.href, {loader: 'socialnetwork:userblogpost'}); return false; "},text:BX.message("MAIL_MESSAGE_LIST_COLUMN_BIND_BLOG_POST")})]});break;case this.ENTITY_TYPE_CRM_ACTIVITY:if(this.userHasCrmActivityPermission){r=BX.create("span",{attrs:{class:"mail-badge mail-badge-dark"},dataset:{role:"crm-binding-link",entityId:t.entityId,type:t.entityType},children:[BX.create("a",{attrs:{class:"mail-badge-item",href:t.bindingEntityLink?t.bindingEntityLink:"#"},text:BX.message("MAIL_MESSAGE_LIST_COLUMN_BIND_CRM_ACTIVITY")})]});break}r=BX.create("span",{dataset:{type:t.entityType},text:BX.message("MAIL_MESSAGE_LIST_COLUMN_BIND_CRM_ACTIVITY")});break;default:break}if(r){i.appendChild(r);this.arrangeBindings(i);this.updateGridByUnbindFilter()}}}}},arrangeBindings:function(e){var t=e.querySelector('[data-type="'+this.ENTITY_TYPE_CRM_ACTIVITY+'"]');var i=e.querySelector('[data-type="'+this.ENTITY_TYPE_TASKS_TASK+'"]');var n=e.querySelector('[data-type="'+this.ENTITY_TYPE_BLOG_POST+'"]');if(t!==null&&e.firstElementChild!==null){e.insertBefore(t,e.firstElementChild)}if(n!==null&&i!==null){e.insertBefore(i,n)}},trackActionPanelStyleChange:function(){var e=document.querySelector(".ui-action-panel");if(!e){return}var t=BX.Main.gridManager.getById(this.gridId).instance;var i=BX.create("input",{props:{type:"checkbox",disabled:t.getRows().getCountDisplayed()==0,title:BX.message("INTERFACE_MAIL_CHECK_ALL")},style:{verticalAlign:"middle"}});BX.Mail.Home.Grid.setCheckboxNodeForCheckAll(i);var n=BX.create("span",{style:{display:"inline-block",height:"100%",paddingLeft:"10px"},children:[i,BX.create("span",{style:{display:"inline-block",height:"100%",verticalAlign:"middle"}})]});var a=t.getCheckAllCheckboxes.bind(t);t.getCheckAllCheckboxes=function(){var e=a();e.push(new BX.Grid.Element(i));return e};var s=t.enableCheckAllCheckboxes.bind(t);t.enableCheckAllCheckboxes=function(){setTimeout(function(){if(t.getRows().getCountDisplayed()>0){s()}},0)};t.bindOnCheckAll();e.insertBefore(n,e.firstChild)},getGridHeaderCheckbox:function(){if(this.gridHeaderCheckbox===undefined){this.gridHeaderCheckbox=document.querySelector("#"+this.gridId+"_table .main-grid-cell-head.main-grid-cell-checkbox")}return this.gridHeaderCheckbox},showElement:function(e,t){if(e&&t){e.style.display="block"}else if(e){e.classList.remove(this.hideClassName)}},hideElement:function(e,t){if(e&&t){e.style.display="none"}else if(e){e.classList.add(this.hideClassName)}},updateRowMenuSpamBtn:function(e){var t=BX.findParent(e.getPopupContainer().querySelector('[data-role^="not-spam"]'),{className:"menu-popup-item"});var i=BX.findParent(e.getPopupContainer().querySelector('[data-role^="spam"]'),{className:"menu-popup-item"});if(this.isCurrentFolderSpam){this.showElement(t,true);this.hideElement(i,true)}else{this.showElement(i,true);this.hideElement(t,true)}},updateRowMenuCrmBtn:function(e){var t=BX.findParent(e.bindElement.parentElement,{className:"main-grid-row"});if(t&&t.dataset&&t.dataset.id){var i=this.getGridInstance().getRows().getById(t.dataset.id);if(i){i.getActionsMenu()}var n=BX.findParent(e.getPopupContainer().querySelector('[data-role^="crm"]'),{className:"menu-popup-item"});var a=BX.findParent(e.getPopupContainer().querySelector('[data-role^="not-crm"]'),{className:"menu-popup-item"});var s=this.isAddToCrmActionAvailable(i.node);if(s){this.showElement(n,true);this.hideElement(a,true)}else{this.showElement(a,true);this.hideElement(n,true)}}},isAddToCrmActionAvailable:function(e){if(e){var t=e.querySelector('[class^="js-bind"]');if(t){var i=t.querySelectorAll('[data-role="crm-binding-link"]');if(i&&i.length>0){return false}}}return true},updateRowMenuSeenBtn:function(e){var t=BX.findParent(e.bindElement.parentElement,{className:"main-grid-row"});if(t&&t.dataset&&t.dataset.id){var i=this.getGridInstance().getRows().getById(t.dataset.id);if(i){i.getActionsMenu()}var n=BX.findParent(e.getPopupContainer().querySelector('[data-role^="not-read"]'),{className:"menu-popup-item"});var a=BX.findParent(e.getPopupContainer().querySelector('[data-role^="read"]'),{className:"menu-popup-item"});var s=this.isSelectedRowsHaveClass("mail-msg-list-cell-unseen",t.dataset.id)?"markAsSeen":"markAsUnseen";if(s==="markAsSeen"){this.showElement(a,true);this.hideElement(n,true)}else{this.showElement(n,true);this.hideElement(a,true)}}},onMessagesRead:function(e,t){this.changeMessageRead(e,t);this.updateGridByUnseenFilter()},updateGridByUnseenFilter:function(){var e=this.getFilterInstance();if(e.getFilterFieldsValues()&&e.getFilterFieldsValues()["IS_SEEN"]!==""){BX.Mail.Home.Grid.reloadTable()}},updateGridByUnbindFilter:function(){var e=this.getFilterInstance();if(e.getFilterFieldsValues()&&e.getFilterFieldsValues()["BIND"]!==""){BX.Mail.Home.Grid.reloadTable()}},onPopupMenuFirstShow:function(e){BX.bind(e.contentContainer,"click",function(){e.close()})},onSettingsToggleClick:function(){var e=BX.PopupMenu.create("mail-msg-list-settings-menu",this.settingsToggle,this.settingsMenu,{events:{onPopupFirstShow:this.onPopupMenuFirstShow}});e.popupWindow.isShown()?e.close():e.show()},onMailboxMenuClick:function(){var e=BX.Main.MenuManager.create(this.mailboxPopupMenuId,this.mailboxMenuToggle,this.mailboxMenu,{events:{onPopupFirstShow:this.onPopupMenuFirstShow}});e.popupWindow.isShown()?e.close():e.show()},closeMailboxMenu:function(){var e=BX.Main.MenuManager.getMenuById(this.mailboxPopupMenuId);if(e){e.close()}},updateUnreadCounters:function(){this.updateMailboxMenuUnseenCounter()},updateUnreadMessageMailboxesMarker:function(e){if(e)BX.Mail.Home.unreadMessageMailboxesMarker.classList.remove("mail-hidden-element");else BX.Mail.Home.unreadMessageMailboxesMarker.classList.add("mail-hidden-element")},updateTotalUnreadCounters:function(e){BX.onCustomEvent("BX.Mail.Home:updateAllCounters");this.updateUnreadMessageMailboxesMarker(e);this.setTotalUnseenCounter(e);this.updateLeftMenuCounter()},updateLeftMenuCounter:function(){var e=BX.Mail.Home.mailboxCounters.getTotalCounter();if(typeof top.B24==="object"&&typeof top.B24.updateCounters==="function"&&e>0){top.B24.updateCounters({mail_unseen:e})}if(typeof top.BXIM==="object"&&typeof top.BXIM.notify==="object"){if(typeof top.BXIM.notify.counters==="object"){top.BXIM.notify.counters.mail_unseen=e}if(typeof top.BXIM.notify.updateNotifyMailCount==="function"){top.BXIM.notify.updateNotifyMailCount(e)}}},updateMailboxUnseenCounter:function(e){this.updateMailboxMenuUnseenCounter(e)},changeMessageRead:function(e,t){if(t.action==="markAsSeen"){for(var i=0;i<e.length;i++){var n=this.getGridInstance().getRows().getById(e[i]);if(n&&n.node){var a=n.node.getElementsByClassName("mail-msg-list-cell-unseen");for(var s=a.length-1;s>=0;s--){a[s].classList.remove("mail-msg-list-cell-unseen");n.node.setAttribute("unseen","false")}}}}else if(t.action==="markAsUnseen"){for(var i=0;i<e.length;i++){var n=this.getGridInstance().getRows().getById(e[i]);if(n&&n.node){n.node.setAttribute("unseen","true");n.node.cells[2].classList.add("mail-msg-list-cell-unseen");n.node.cells[3].classList.add("mail-msg-list-cell-unseen");n.node.cells[4].classList.add("mail-msg-list-cell-unseen")}}}},handleGridSelectItem:function(){this.updateSeenBtn();this.updateCrmBtn();this.updateSpamBtn();var e=document.createEvent("Event");e.initEvent("resize",true,true);window.dispatchEvent(e)},disActivateBtn:function(e){this.activateBtn(e,false)},activateBtn:function(e,t){t=t===undefined||t===true;this.toggleButton(e,t);this.toggleButton("not-"+e,!t)},toggleButton:function(e,t){var i=document.querySelectorAll('[data-role^="'+e+'"]');Array.prototype.slice.call(i,0).forEach(function(e){var i=BX.findParent(e,{className:"ui-action-panel-item"});i=i?i:BX.findParent(e,{className:"main-grid-row"});t?this.showElement(i):this.hideElement(i)}.bind(this))},updateCrmBtn:function(){var e=this.getGridInstance().getRows().getSelectedIds();if(e.length!==1){this.activateBtn(this.crmActionBtnRole);return}var t=this.getGridInstance().getRows().getById(e[0]);if(!(t&&t.node)){return}var i=this.isAddToCrmActionAvailable(t.node);if(i){this.activateBtn(this.crmActionBtnRole)}else{this.disActivateBtn(this.crmActionBtnRole)}},updateSpamBtn:function(){if(this.isCurrentFolderSpam){this.disActivateBtn(this.spamActionBtnRole)}else{this.activateBtn(this.spamActionBtnRole)}},updateSeenBtn:function(){var e=this.isSelectedRowsHaveClass("mail-msg-list-cell-unseen")?"markAsSeen":"markAsUnseen";if(e==="markAsSeen"){this.activateBtn(this.readActionBtnRole)}else{this.disActivateBtn(this.readActionBtnRole)}},setDefaultBtnOnShow:function(e){e.items.forEach(function(e){if(e&&e instanceof BX.UI.ActionPanel.Item){if(this.getCurrentFolder()==="[Gmail]/All Mail"&&e["id"]==="deleteImmediately"){e.disable();e.layout.container.removeAttribute("onclick")}}}.bind(this))},setDefaultBtnTitles:function(e){if(e&&Array.isArray(e.items)){e.items.forEach(function(e){if(e&&e instanceof BX.UI.ActionPanel.Item){e.layout.container.removeAttribute("onclick")}})}var t=BX.Main.MenuManager.getMenuById("ui-action-panel-item-popup-menu");t&&t.close();this.toggleButton(this.readActionBtnRole,false);this.toggleButton("not-"+this.readActionBtnRole,false);this.activateBtn(this.crmActionBtnRole);this.updateSpamBtn();var i=document.createEvent("Event");i.initEvent("resize",true,true);window.dispatchEvent(i)},getRowMenu:function(){var e=this.getGridInstance().getRows().getSelectedIds();id=e.length?e[0]:null;var t=id?this.getGridInstance().getRows().getById(id):null;if(t){return t.getActionsMenu()}return null},onUnreadCounterClick:function(){var e=this.getFilterInstance();var t=e.getApi();t.setFields({DIR:e.getFilterFieldsValues()["DIR"],IS_SEEN:"N"});t.apply()},getFilterInstance:function(){return BX.Main.filterManager.getById(this.gridId)},onApplyFilter:function(e,t,i,n,a){if(e!==this.gridId){return}this.setCurrentFolderFlags(i);this.setDefaultBtnTitles()},setCurrentFolderFlags:function(e){var t=e.getPreset().getCurrentPresetId();this.isCurrentFolderTrash=this.trashDir!==""&&(t==="trash"||e.getFilterFieldsValues()&&e.getFilterFieldsValues()["DIR"]===this.trashDir);this.isCurrentFolderSpam=this.spamDir!==""&&(t==="spam"||e.getFilterFieldsValues()&&e.getFilterFieldsValues()["DIR"]===this.spamDir);this.isCurrentFolderOutcome=this.outcomeDir!==""&&(t==="outcome"||e.getFilterFieldsValues()&&e.getFilterFieldsValues()["DIR"]===this.outcomeDir)},getLastDir:function(){return this.lastDir},setLastDir:function(){BX.onCustomEvent(window,"Mail::directoryChanged");this.lastDir=this.getCurrentFolder()},getCurrentFolder:function(){var e=this.getFilterInstance();var t=e.getFilterFieldsValues()["DIR"];var i=this.inboxDir;return t||i},getCurrentMailboxId:function(){var e=document.querySelector('[data-role="mailbox-current-title"]');return e&&e.dataset&&e.dataset.mailboxId?e.dataset.mailboxId:null},setTotalUnseenCounter:function(e){var t=this.getCurrentMailboxId();this.mailboxesUnseen[t]=e},updateMailboxMenuUnseenCounter:function(){var e=this.getCurrentMailboxId();if(!e){return}for(var t=0;t<this.mailboxMenu.length;t++){if(this.mailboxMenu[t]&&this.mailboxMenu[t].html&&this.mailboxMenu[t].dataset&&this.mailboxMenu[t].dataset.mailboxId==e){this.mailboxMenu[t]=this.updateMailboxMenuItemUnseenCounter(this.mailboxMenu[t],BX.Mail.Home.Counters.getTotalCounter());BX.Main.MenuManager.destroy(this.mailboxPopupMenuId);break}}},updateMailboxMenuItemUnseenCounter:function(e,t){e=this.setMailboxTitleMenuUnseenCounter(e,t);if(!e.items){return e}return e},setMailboxTitleMenuUnseenCounter:function(e,t){var i=this.hideClassName;if(t>0){i="";if(typeof e.dataset.path!="undefined"){if(e.unseen==0){i+=" mail-msg-list-menu-child-counter"}if(!e.dataset.isCounted){i+=" mail-msg-list-menu-fake-counter"}}}var n=/<span class="(main-buttons-item-counter)[\w -]*">[0-9]+<\/span>/g;var a='<span class="main-buttons-item-counter '+i+'">'+t+"</span>";if(e.html.match(n)){e.html=e.html.replace(n,a)}else{e.html+="&nbsp;"+a}e.dataset.unseen=t;return e},isVisible:function(e){return e&&!e.classList.contains(this.hideClassName)}}})();
//# sourceMappingURL=user-interface-manager.map.js