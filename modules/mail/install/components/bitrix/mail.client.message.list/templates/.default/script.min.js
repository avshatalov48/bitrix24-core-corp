(function(){BX.namespace("BX.Mail.Client.Message.List");BX.Mail.Client.Message.List=function(e){this.gridId=e.gridId;this.mailboxId=e.mailboxId;this.canMarkSpam=e.canMarkSpam;this.canDelete=e.canDelete;this.moveBtnMailIdPrefix=e.moveBtnMailIdPrefix;this.connectedMailboxesLicenseInfo=e.connectedMailboxesLicenseInfo;this.ERROR_CODE_CAN_NOT_DELETE=e.ERROR_CODE_CAN_NOT_DELETE;this.ERROR_CODE_CAN_NOT_MARK_SPAM=e.ERROR_CODE_CAN_NOT_MARK_SPAM;this.disabledClassName="js-disabled";this.userInterfaceManager=new BX.Mail.Client.Message.List.UserInterfaceManager(e);this.userInterfaceManager.reloadGrid=this.reloadGrid.bind(this);this.userInterfaceManager.resetGridSelection=this.resetGridSelection.bind(this);this.userInterfaceManager.isSelectedRowsHaveClass=this.isSelectedRowsHaveClass.bind(this);this.userInterfaceManager.getGridInstance=this.getGridInstance.bind(this);this.cache={};this.addEventHandlers();BX.Mail.Client.Message.List[e.id]=this};BX.Mail.Client.Message.List.prototype={addEventHandlers:function(){BX.ajax.UpdatePageData=function(){};BX.addCustomEvent("onSubMenuShow",function(){var e=this.getMenuWindow().getPopupWindow().getPopupContainer();var t=null;if(e){t=BX.data(e,"grid-row-id")}BX.data(this.getSubMenu().getPopupWindow().getPopupContainer(),"grid-row-id",this.gridRowId||t)});BX.Event.EventEmitter.subscribe("BX.Main.Menu.Item:onmouseenter",function(e){var t=e.target;if(!t.dataset||!t.getMenuWindow()){return}var n=t.getMenuWindow();var s=n.getMenuItems();var i=t.dataset.path;var a=t.dataset.dirMd5;var r=t.dataset.hasChild;if(!r){return}for(var o=0;o<s.length;o++){var d=s[o];if(d.getId()===i){var l=d.hasSubMenu();if(l){d.showSubMenu();var u=d.getSubMenu();if(u){var c=u.getMenuItems();var g=false;for(var h=0;h<c.length;h++){var f=c[h];if(f.getId()==="loading"){g=true}}}if(!g){return}}this.loadLevelMenu(d,a)}}}.bind(this))},loadLevelMenu:function(e,t){var n=this.getCache(e.getId());var s=BX.Main.PopupManager.getPopupById("menu-popup-popup-submenu-"+e.getId());if(s){s.destroy()}if(n){e.destroySubMenu();e.addSubMenu(n);e.showSubMenu();return}var i={id:"loading",text:BX.message("MAIL_CLIENT_BUTTON_LOADING"),disabled:true};e.destroySubMenu();e.addSubMenu([i]);e.showSubMenu();BX.ajax.runComponentAction("bitrix:mail.client.config.dirs","level",{mode:"class",data:{mailboxId:this.mailboxId,dir:{path:e.getId(),dirMd5:t}}}).then(function(t){var n=t.data.dirs;var s=[];for(var i=0;i<n.length;i++){var a=/(HasChildren)/i.test(n[i].FLAGS);var r={id:n[i].PATH,text:n[i].NAME,dataset:{path:n[i].PATH,dirMd5:n[i].DIR_MD5,isDisabled:n[i].IS_DISABLED,hasChild:a},items:a?[{id:"loading",text:BX.message("MAIL_CLIENT_BUTTON_LOADING"),disabled:true}]:[]};s.push(r)}this.setCache(e.getId(),s);var o=BX.Main.PopupManager.getPopupById("menu-popup-popup-submenu-"+e.getId());var d=e.getMenuWindow().getPopupWindow().isShown();if(o){o.destroy()}if(d){e.destroySubMenu();e.addSubMenu(s);e.showSubMenu()}}.bind(this),function(e){}.bind(this))},showLicensePopup:function(e){B24.licenseInfoPopup.show(e,BX.message("MAIL_MAILBOX_LICENSE_CONNECTED_MAILBOXES_LIMIT_TITLE"),this.connectedMailboxesLicenseInfo)},onCrmClick:function(e){var t=this.getGridInstance().getRows().getSelected();var n=e?this.getGridInstance().getRows().getById(e):t[0];if(!(n&&n.node)){return}var s=this.userInterfaceManager.isAddToCrmActionAvailable(n.node);var i=n.node.querySelector("[data-message-id]");if(!(i.dataset&&i.dataset.messageId)){return}this.resetGridSelection();if(s){if(typeof this.isAddingToCrmInProgress!=="object"){this.isAddingToCrmInProgress={}}if(this.isAddingToCrmInProgress[e]===true){return}this.isAddingToCrmInProgress[e]=true;BX.ajax.runComponentAction("bitrix:mail.client","createCrmActivity",{mode:"ajax",data:{messageId:i.dataset.messageId},analyticsLabel:{groupCount:t.length,bindings:this.getRowsBindings([n])}}).then(function(e,t){this.isAddingToCrmInProgress[e]=false;this.notify(BX.message("MAIL_MESSAGE_LIST_NOTIFY_ADDED_TO_CRM"));this.userInterfaceManager.onBindingCreated()}.bind(this,e),function(t){this.isAddingToCrmInProgress[e]=false;if(t.errors&&t.errors.length>0){this.notify(t.errors.map(function(e){return e.message}).join("<br>"),5e3)}else{this.notify(BX.message("MAIL_MESSAGE_LIST_NOTIFY_ADD_TO_CRM_ERROR"))}}.bind(this))}else{BX.ajax.runComponentAction("bitrix:mail.client","removeCrmActivity",{mode:"ajax",data:{messageId:i.dataset.messageId},analyticsLabel:{groupCount:t.length,bindings:this.getRowsBindings([n])}}).then(function(e){this.userInterfaceManager.onCrmBindingDeleted(e.dataset.messageId);this.notify(BX.message("MAIL_MESSAGE_LIST_NOTIFY_EXCLUDED_FROM_CRM"))}.bind(this,i))}},onViewClick:function(e){if(e===undefined&&this.getGridInstance().getRows().getSelectedIds().length===0){return}BX.SidePanel.Instance.open("/mail/message/"+e,{width:1080,loader:"view-mail-loader"})},onDeleteClick:function(e){var t=this.getGridInstance().getRows().getSelected();if(e===undefined&&t.length===0){return}if(!this.canDelete){this.showDirsSlider();return}var n={analyticsLabel:{groupCount:t.length,bindings:this.getRowsBindings(e?[this.getGridInstance().getRows().getById(e)]:t)},onSuccess:function(){this.reloadGrid({})}};if(e!==undefined){n.ids=[e]}if(this.userInterfaceManager.isCurrentFolderTrash){var s=this.getConfirmDeletePopup(n);s.show()}else{this.runAction("delete",n)}},onMoveToFolderClick:function(e){var t=e.currentTarget.dataset;var n=null;var s=BX.findParent(e.currentTarget,{className:"popup-window"});if(s){n=BX.data(s,"grid-row-id")}var i=JSON.parse(t.isDisabled);var a=t.path;if(n===null&&this.getGridInstance().getRows().getSelectedIds().length===0||i){return}var r=this.getGridInstance().getRows().getSelected();var o=n?[n]:this.getGridInstance().getRows().getSelectedIds();o=this.filterRowsByClassName(this.disabledClassName,o,true);if(!o.length){return}this.resetGridSelection();this.runAction("moveToFolder",{ids:o,params:{folder:a},analyticsLabel:{groupCount:r.length,bindings:this.getRowsBindings(n?[this.getGridInstance().getRows().getById(n)]:r)}})},onReadClick:function(e){var t=this.getGridInstance().getRows().getSelected();if(e===undefined&&t.length===0){return}var n="all"==e||this.isSelectedRowsHaveClass("mail-msg-list-cell-unseen",e)?"markAsSeen":"markAsUnseen";var s=this.filterRowsByClassName("mail-msg-list-cell-unseen",e,n!=="markAsSeen");s=this.filterRowsByClassName(this.disabledClassName,s,true);if(!s.length){return}var i=function(){this.userInterfaceManager.onMessagesRead(s,{action:n});if(n==="markAsSeen"){var i=s.length;if("all"==e){i=Math.max(this.userInterfaceManager.getQuickFilterUnseenCounter(),i)}this.userInterfaceManager.updateUnreadCounters(-i)}else{this.userInterfaceManager.updateUnreadCounters(s.length)}this.resetGridSelection();if("all"==e){s["for_all"]=this.mailboxId+"-"+this.userInterfaceManager.getCurrentFolder()}this.runAction(n,{ids:s,keepRows:true,successParams:n,analyticsLabel:{groupCount:t.length,bindings:this.getRowsBindings(e?[this.getGridInstance().getRows().getById(e)]:t)},onSuccess:false});return true};if("all"==e){BX.UI.Dialogs.MessageBox.show({title:BX.message("MAIL_MESSAGE_LIST_CONFIRM_TITLE"),message:BX.message("MAIL_MESSAGE_LIST_CONFIRM_READ_ALL"),onYes:i.bind(this),buttons:BX.UI.Dialogs.MessageBoxButtons.YES_CANCEL})}else{i.apply(this)}},onSpamClick:function(e){var t=this.getGridInstance().getRows().getSelected();if(e===undefined&&t.length===0){return}if(!this.canMarkSpam){this.showDirsSlider();return}var n=this.isSelectedRowsHaveClass("js-spam",e)?"restoreFromSpam":"markAsSpam";var s=this.filterRowsByClassName("js-spam",e,n!=="restoreFromSpam");s=this.filterRowsByClassName(this.disabledClassName,s,true);if(!s.length){return}var i={analyticsLabel:{groupCount:t.length,bindings:this.getRowsBindings(e?[this.getGridInstance().getRows().getById(e)]:t)},onSuccess:function(){this.reloadGrid({})}};if(e!==undefined){i.ids=[e]}this.runAction(n,i)},getConfirmDeletePopup:function(e){return new BX.UI.Dialogs.MessageBox({title:BX.message("MAIL_MESSAGE_LIST_CONFIRM_TITLE"),message:BX.message("MAIL_MESSAGE_LIST_CONFIRM_DELETE"),buttons:[new BX.UI.Button({color:BX.UI.Button.Color.DANGER,text:BX.message("MAIL_MESSAGE_LIST_CONFIRM_DELETE_BTN"),onclick:function(t){this.runAction("delete",e);t.getContext().close()}.bind(this)}),new BX.UI.CancelButton({onclick:function(e){e.getContext().close()}})]})},resetGridSelection:function(){this.getGridInstance().getRows().unselectAll();this.getGridInstance().adjustCheckAllCheckboxes();BX.onCustomEvent("Grid::updated")},isSelectedRowsHaveClass:function(e,t){var n=this.getGridInstance().getRows().getSelectedIds();var s=n.length?n:t?[t]:[];var i=[];for(var a=0;a<s.length;a++){var r=this.getGridInstance().getRows().getById(s[a]);if(r&&r.node){var o=r.node.getElementsByClassName(e);if(o&&o.length){return true}}}return false},filterRowsByClassName:function(e,t,n){var s=[];if("all"==t){s=this.getGridInstance().getRows().getBodyChild().map(function(e){return e.getId()})}else if(Array.isArray(t)){s=t}else{var i=this.getGridInstance().getRows().getSelectedIds();s=i.length?i:t?[t]:[]}var a=[];for(var r=s.length-1;r>=0;r--){var o=this.getGridInstance().getRows().getById(s[r]);if(o&&o.node){var d=o.node.getElementsByClassName(e);if(!n&&(d&&d.length)){a.push(s[r])}else if(n&&!(d&&d.length)){a.push(s[r])}}}return a},notify:function(e,t){top.BX.UI.Notification.Center.notify({autoHideDelay:t>0?t:2e3,content:e?e:BX.message("MAIL_MESSAGE_LIST_NOTIFY_SUCCESS")})},runAction:function(e,t){t=t?t:{};var n=this.getGridInstance().getRows().getSelectedIds();if(t.ids){n=t.ids}if(!n.length&&!n.for_all){return}if(!t.keepRows){this.getGridInstance().tableFade()}var s={ids:n};if(t.params){var i=Object.keys(Object(t.params));for(var a=0,r=i.length;a<r;a++){var o=i[a];var d=Object.getOwnPropertyDescriptor(t.params,o);if(d!==undefined&&d.enumerable){s[o]=t.params[o]}}}BX.ajax.runComponentAction("bitrix:mail.client",e,{mode:"ajax",data:s,analyticsLabel:t.analyticsLabel}).then(function(s){if(t.onSuccess===false){return}if(t.onSuccess&&typeof t.onSuccess==="function"){t.onSuccess.bind(this,n,t.successParams)();return}this.onSuccessRequest(s,e)}.bind(this),function(e){t.onError&&typeof t.onError==="function"?t.onError().bind(this,e):this.onErrorRequest(e)}.bind(this))},onErrorRequest:function(e){options={};this.checkErrorRights(e.errors);options.errorMessage=e.errors[0].message;this.reloadGrid(options)},checkErrorRights:function(e){for(var t=0;t<e.length;t++){if(e[t].code===this.ERROR_CODE_CAN_NOT_DELETE){this.canDelete=false}if(e[t].code===this.ERROR_CODE_CAN_NOT_MARK_SPAM){this.canMarkSpam=false}}},onSuccessRequest:function(e,t){this.notify();this.reloadGrid({})},reloadGrid:function(e){var t=this.getGridInstance();if(t){e.apply_filter="Y";t.reloadTable("POST",e)}},showDirsSlider:function(){var e=BX.util.add_url_param("/mail/config/dirs",{mailboxId:this.mailboxId});BX.SidePanel.Instance.open(e,{width:640,cacheable:false,allowChangeHistory:false});this.canDelete=true;this.canMarkSpam=true},onDisabledGroupActionClick:function(){},onUnreadCounterClick:function(){this.userInterfaceManager.onUnreadCounterClick()},getCurrentFolder:function(){return this.userInterfaceManager.getCurrentFolder()},onDirsMenuItemClick:function(e){if(BX.data(e,"is-disabled")=="true"){return}var t=this.userInterfaceManager.getFilterInstance();var n=t.getApi();n.setFields({DIR:BX.data(e,"path")});n.apply();this.userInterfaceManager.closeMailboxMenu()},getGridInstance:function(){return BX.Main.gridManager.getById(this.gridId).instance},getRowsBindings:function(e){return BX.util.array_unique(Array.prototype.concat.apply([],e.map(function(e){if(!e||!e.node){return null}return Array.prototype.map.call(e.node.querySelectorAll('[class^="js-bind-"] [data-type]'),function(e){return e.dataset.type})})))},getCache:function(e){if(!e){return}return this.cache[e]?this.cache[e]:null},setCache:function(e,t){return this.cache[e]=t}}})();
//# sourceMappingURL=script.map.js