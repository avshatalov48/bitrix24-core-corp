(function(e,t,n,r,i,s,a){"use strict";function o(e,t,n){l(e,t);t.set(e,n)}function l(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var u=new WeakMap;var d=new WeakMap;var c=new WeakMap;var h=new WeakMap;var g=new WeakMap;var f=new WeakMap;var m=function(){function e(t){babelHelpers.classCallCheck(this,e);o(this,u,{writable:true,value:void 0});o(this,d,{writable:true,value:void 0});o(this,c,{writable:true,value:void 0});o(this,h,{writable:true,value:void 0});o(this,g,{writable:true,value:void 0});o(this,f,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,u,t)}babelHelpers.createClass(e,[{key:"setSyncButton",value:function e(t){babelHelpers.classPrivateFieldSet(this,g,t)}},{key:"getSyncButton",value:function e(){return babelHelpers.classPrivateFieldGet(this,g)}},{key:"getErrorBoxNode",value:function e(){return babelHelpers.classPrivateFieldGet(this,h)}},{key:"setErrorBoxNode",value:function e(t){babelHelpers.classPrivateFieldSet(this,h,t)}},{key:"setErrorTitleNode",value:function e(t){babelHelpers.classPrivateFieldSet(this,d,t)}},{key:"setErrorTextNode",value:function e(t){babelHelpers.classPrivateFieldSet(this,c,t)}},{key:"setErrorHintNode",value:function e(t){babelHelpers.classPrivateFieldSet(this,f,t)}},{key:"getErrorTextNode",value:function e(){return babelHelpers.classPrivateFieldGet(this,c)}},{key:"getErrorHintNode",value:function e(){return babelHelpers.classPrivateFieldGet(this,f)}},{key:"getErrorTitleNode",value:function e(){return babelHelpers.classPrivateFieldGet(this,d)}},{key:"show",value:function e(){if(this.getSyncButton()!==undefined)this.getSyncButton().setWaiting(true);babelHelpers.classPrivateFieldGet(this,u).classList.add("mail-progress-show");babelHelpers.classPrivateFieldGet(this,u).classList.remove("mail-progress-hide")}},{key:"hide",value:function e(){if(this.getSyncButton()!==undefined)this.getSyncButton().setWaiting(false);babelHelpers.classPrivateFieldGet(this,u).classList.add("mail-progress-hide");babelHelpers.classPrivateFieldGet(this,u).classList.remove("mail-progress-show")}},{key:"hideErrorBox",value:function e(){babelHelpers.classPrivateFieldGet(this,h).classList.add("mail-hidden-element");babelHelpers.classPrivateFieldGet(this,h).classList.remove("mail-visible-element")}},{key:"showErrorBox",value:function e(){babelHelpers.classPrivateFieldGet(this,h).classList.add("mail-visible-element");babelHelpers.classPrivateFieldGet(this,h).classList.remove("mail-hidden-element")}}]);return e}();function v(e,t){var n=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=C(e))||t&&e&&typeof e.length==="number"){if(n)e=n;var r=0;var i=function e(){};return{s:i,n:function t(){if(r>=e.length)return{done:true};return{done:false,value:e[r++]}},e:function e(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s=true,a=false,o;return{s:function t(){n=n.call(e)},n:function e(){var t=n.next();s=t.done;return t},e:function e(t){a=true;o=t},f:function e(){try{if(!s&&n["return"]!=null)n["return"]()}finally{if(a)throw o}}}}function C(e,t){if(!e)return;if(typeof e==="string")return p(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor)n=e.constructor.name;if(n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return p(e,t)}function p(e,t){if(t==null||t>e.length)t=e.length;for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function b(e,t,n){M(e,t);t.set(e,n)}function M(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var y=new WeakMap;var I=function(){function e(t,n){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"cachedCounters",[]);babelHelpers.defineProperty(this,"counters",[]);babelHelpers.defineProperty(this,"hiddenCountersForTotalCounter",[]);babelHelpers.defineProperty(this,"shortcuts",[]);b(this,y,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,y,t);this.setDirectory(n)}babelHelpers.createClass(e,[{key:"getCounters",value:function e(){return this.counters}},{key:"getDirPath",value:function e(t){if(t===undefined){t=""}if(this.shortcuts[t]!==undefined){return this.shortcuts[t]}return t}},{key:"getShortcut",value:function e(t){return this.getDirPath(t)}},{key:"setDirectory",value:function e(t){if(t===undefined){t=""}if(this.shortcuts[t]){this.selectedDirectory=this.shortcuts[t]}else{this.selectedDirectory=t}var n={};n[this.selectedDirectory]=this.getCounter(this.selectedDirectory);this.sendCounterUpdateEvent(n)}},{key:"setShortcut",value:function e(t,n){this.shortcuts[t]=n;this.shortcuts[n]=t}},{key:"getName",value:function e(){return babelHelpers.classPrivateFieldGet(this,y)}},{key:"setHiddenCountersForTotalCounter",value:function e(t){var n=v(t),r;try{for(n.s();!(r=n.n()).done;){var i=r.value;this.hiddenCountersForTotalCounter[i]="disabled"}}catch(e){n.e(e)}finally{n.f()}}},{key:"isHidden",value:function e(t){if(this.hiddenCountersForTotalCounter[t]==="disabled"){return true}return false}},{key:"getTotalCounter",value:function e(){var t=0;for(var n in this.counters){if(n in this.hiddenCountersForTotalCounter){continue}t+=this.counters[n]}return t}},{key:"getCounterObjects",value:function e(){return this.counters}},{key:"getCounter",value:function e(t){return this.counters[t]}},{key:"addCounter",value:function e(t,n){this.counters[t]=Number(n);return this.counters[t]}},{key:"addCounters",value:function e(t){this.cacheCounters();var n={};for(var r=0;r<t.length;r++){var i=t[r];i["count"]=Number(i["count"]);var s=i["path"];this.addCounter(s,i["count"]);if(this.shortcuts[s]){n[this.shortcuts[s]]=i["count"]}else{n[s]=i["count"]}}this.sendCounterUpdateEvent(n)}},{key:"setCounters",value:function e(t){this.addCounters(t)}},{key:"isExists",value:function e(t){return this.counters[t]!==undefined}},{key:"increaseCounter",value:function e(t){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1;this.cacheCounters();if(t in this.hiddenCountersForTotalCounter){return"hidden counters for total counter"}if(!this.isExists(t)){return"no counter"}this.counters[t]+=Number(n)}},{key:"lowerCounter",value:function e(t){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:1;this.cacheCounters();if(t in this.hiddenCountersForTotalCounter){return"hidden counters for total counter"}if(!this.isExists(t)){return"no counter"}var r=this.counters[t]-Number(n);if(r<0){return"negative value"}this.counters[t]=r}},{key:"cacheCounters",value:function e(){this.cachedCounters=[];Object.assign(this.cachedCounters,this.counters)}},{key:"restoreFromCache",value:function e(){this.counters=[];Object.assign(this.counters,this.cachedCounters);this.sendCounterUpdateEvent(this.counters)}},{key:"updateCounters",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[{name:"counter1",count:2,increase:false,lower:true},{name:"counter2",count:2,increase:true,lower:false}];this.cacheCounters();var n={};var r=false;for(var i=0;i<t.length;i++){var s=t[i];var a=s["name"];if(s["lower"]){if(this.lowerCounter(a,s["count"])==="negative value"){r=true}}if(s["increase"]&&r===false){this.increaseCounter(a,s["count"])}if(this.shortcuts[a]){n[this.shortcuts[a]]=this.getCounter(a)}else{n[a]=this.getCounter(a)}}this.sendCounterUpdateEvent(n)}},{key:"sendCounterUpdateEvent",value:function e(t){if(t===undefined){t=this.counters}if(t.length===0){return}var n=new i.BaseEvent({data:{counters:t,hidden:this.hiddenCountersForTotalCounter,selectedDirectory:this.selectedDirectory,name:this.getName(),total:this.getTotalCounter()}});i.EventEmitter.emit("BX.Mail.Home:updatingCounters",n)}}]);return e}();var S=function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{dirsWithUnseenMailCounters:{},mailboxId:"",filterId:"",systemDirs:{spam:"Spam",trash:"Trash",outcome:"Outcome",drafts:"Drafts",inbox:"Inbox"}};babelHelpers.classCallCheck(this,e);var n=document.querySelector(".mail-left-menu-wrapper");this.directoryMenu=new r.DirectoryMenu({dirsWithUnseenMailCounters:t["dirsWithUnseenMailCounters"],filterId:t["filterId"],systemDirs:t["systemDirs"]});n.append(this.directoryMenu.getNode())};var w=function(){function e(t){babelHelpers.classCallCheck(this,e);this.mailReadAllButton=t.mailReadAllButton;this.gridId=t.gridId;this.mailboxId=t.mailboxId;this.canMarkSpam=t.canMarkSpam;this.canDelete=t.canDelete;this.ERROR_CODE_CAN_NOT_DELETE=t.ERROR_CODE_CAN_NOT_DELETE;this.ERROR_CODE_CAN_NOT_MARK_SPAM=t.ERROR_CODE_CAN_NOT_MARK_SPAM;this.disabledClassName="js-disabled";this.userInterfaceManager=new BX.Mail.Client.Message.List.UserInterfaceManager(t);this.userInterfaceManager.resetGridSelection=this.resetGridSelection.bind(this);this.userInterfaceManager.isSelectedRowsHaveClass=this.isSelectedRowsHaveClass.bind(this);this.userInterfaceManager.getGridInstance=this.getGridInstance.bind(this);this.userInterfaceManager.updateCountersFromBackend=this.updateCountersFromBackend.bind(this);this.cache={};this.addEventHandlers();BX.Mail.Client.Message.List[t.id]=this}babelHelpers.createClass(e,[{key:"addEventHandlers",value:function e(){var t=this;BX.ajax.UpdatePageData=function(){};i.EventEmitter.subscribe("onSubMenuShow",(function(e){var t=e.target;var n=t.getMenuWindow().getPopupWindow().getPopupContainer();var r=null;if(n){r=BX.data(n,"grid-row-id")}BX.data(t.getSubMenu().getPopupWindow().getPopupContainer(),"grid-row-id",t.gridRowId||r)}));i.EventEmitter.subscribe("Mail::directoryChanged",(function(){t.resetGridSelection()}));i.EventEmitter.subscribe("BX.Mail.Home:updatingCounters",(function(e){if(e["data"]["name"]!=="mailboxCounters"){var n=e["data"]["counters"];BX.Mail.Home.LeftMenuNode.directoryMenu.setCounters(n);BX.Mail.Home.mailboxCounters.setCounters([{path:"unseenCountInCurrentMailbox",count:BX.Mail.Home.Counters.getTotalCounter()}])}else{t.userInterfaceManager.updateLeftMenuCounter()}}));i.EventEmitter.subscribe("BX.Main.Menu.Item:onmouseenter",function(e){var t=e.target;if(!t.dataset||!t.getMenuWindow()){return}var n=t.getMenuWindow();var r=n.getMenuItems();var i=t.dataset.path;var s=t.dataset.dirMd5;var a=t.dataset.hasChild;if(!a){return}for(var o=0;o<r.length;o++){var l=r[o];if(l.getId()===i){var u=l.hasSubMenu();if(u){l.showSubMenu();var d=l.getSubMenu();var c=false;if(d){var h=d.getMenuItems();for(var g=0;g<h.length;g++){var f=h[g];if(f.getId()==="loading"){c=true}}}if(!c){return}}this.loadLevelMenu(l,s)}}}.bind(this));var n=document.querySelectorAll(".ical-event-control-menu");for(var r=0;r<n.length;r++){n[r].addEventListener("click",this.showICalMenuDropdown.bind(this))}BX.bindDelegate(document.body,"click",{className:"ical-event-control-button"},this.onClickICalButton.bind(this))}},{key:"loadLevelMenu",value:function e(t,n){var r=this.getCache(t.getId());var i=BX.Main.PopupManager.getPopupById("menu-popup-popup-submenu-"+t.getId());if(i){i.destroy()}if(r){t.destroySubMenu();t.addSubMenu(r);t.showSubMenu();return}var a={id:"loading",text:s.Loc.getMessage("MAIL_CLIENT_BUTTON_LOADING"),disabled:true};t.destroySubMenu();t.addSubMenu([a]);t.showSubMenu();BX.ajax.runComponentAction("bitrix:mail.client.config.dirs","level",{mode:"class",data:{mailboxId:this.mailboxId,dir:{path:t.getId(),dirMd5:n}}}).then(function(e){var n=e.data.dirs;var r=[];for(var i=0;i<n.length;i++){var a=/(HasChildren)/i.test(n[i].FLAGS);var o={id:n[i].PATH,text:n[i].NAME,dataset:{path:n[i].PATH,dirMd5:n[i].DIR_MD5,isDisabled:n[i].IS_DISABLED,hasChild:a},items:a?[{id:"loading",text:s.Loc.getMessage("MAIL_CLIENT_BUTTON_LOADING"),disabled:true}]:[]};r.push(o)}this.setCache(t.getId(),r);var l=BX.Main.PopupManager.getPopupById("menu-popup-popup-submenu-"+t.getId());var u=t.getMenuWindow().getPopupWindow().isShown();if(l){l.destroy()}if(u){t.destroySubMenu();t.addSubMenu(r);t.showSubMenu()}}.bind(this),function(e){}.bind(this))}},{key:"onCrmClick",value:function e(t){var n=this.getGridInstance().getRows().getSelected();var r=t?this.getGridInstance().getRows().getById(t):n[0];if(!(r&&r.node)){return}var i=this.userInterfaceManager.isAddToCrmActionAvailable(r.node);var a=r.node.querySelector("[data-message-id]");if(!(a.dataset&&a.dataset.messageId)){return}if(t===undefined){this.resetGridSelection()}if(i){var o=r.node.querySelector(".mail-binding-crm.mail-ui-not-active");if(o){o.startWait()}if(babelHelpers["typeof"](this.isAddingToCrmInProgress)!=="object"){this.isAddingToCrmInProgress={}}if(this.isAddingToCrmInProgress[t]===true){return}this.isAddingToCrmInProgress[t]=true;BX.ajax.runComponentAction("bitrix:mail.client","createCrmActivity",{mode:"ajax",data:{messageId:a.dataset.messageId},analyticsLabel:{groupCount:n.length,bindings:this.getRowsBindings([r])}}).then(function(e){this.isAddingToCrmInProgress[e]=false;this.notify(s.Loc.getMessage("MAIL_MESSAGE_LIST_NOTIFY_ADDED_TO_CRM"))}.bind(this,t),function(e){if(o){o.stopWait()}this.isAddingToCrmInProgress[t]=false;if(e.errors&&e.errors.length>0){this.notify(e.errors.map((function(e){return e.message})).join("<br>"),5e3)}else{this.notify(s.Loc.getMessage("MAIL_MESSAGE_LIST_NOTIFY_ADD_TO_CRM_ERROR"))}}.bind(this))}else{this.userInterfaceManager.onCrmBindingDeleted(a.dataset.messageId);BX.ajax.runComponentAction("bitrix:mail.client","removeCrmActivity",{mode:"ajax",data:{messageId:a.dataset.messageId},analyticsLabel:{groupCount:n.length,bindings:this.getRowsBindings([r])}}).then(function(e){this.notify(s.Loc.getMessage("MAIL_MESSAGE_LIST_NOTIFY_EXCLUDED_FROM_CRM"))}.bind(this,a))}var l=this.getGridInstance().getRows().getSelectedIds();if(l.length===1&&l[0]===t){this.resetGridSelection()}}},{key:"onViewClick",value:function e(t){if(t===undefined&&this.getGridInstance().getRows().getSelectedIds().length===0){return}BX.SidePanel.Instance.open("/mail/message/"+t,{width:1080,loader:"view-mail-loader"})}},{key:"onDeleteImmediately",value:function e(t){var n={deleteImmediately:true};this.onDeleteClick(t,n)}},{key:"onDeleteClick",value:function e(t,n){var r=this.getGridInstance().getRows().getSelected();if(t===undefined&&r.length===0){return}if(!this.canDelete){this.showDirsSlider();return}var i={params:n!==undefined?n:{},keepRows:true,analyticsLabel:{groupCount:r.length,bindings:this.getRowsBindings(t?[this.getGridInstance().getRows().getById(t)]:r)}};var s;if(t===undefined){s=BX.Mail.Home.Grid.getSelectedIds()}else{s=[t]}s=this.filterRowsByClassName(this.disabledClassName,s,true);i.ids=s;if(this.userInterfaceManager.isCurrentFolderTrash||n!==undefined&&n["deleteImmediately"]){var a=this.getConfirmDeletePopup(i);a.show()}else{BX.Mail.Home.Grid.hideRowByIds(s);var o=this.filterRowsByClassName("mail-msg-list-cell-unseen",s).length;if(this.getCurrentFolder()!==""){BX.Mail.Home.Counters.updateCounters([{name:this.getCurrentFolder(),lower:true,count:o}])}this.runAction("delete",i,(function(){return BX.Mail.Home.Grid.reloadTable()}));if(t===undefined){this.resetGridSelection()}}}},{key:"onMoveToFolderClick",value:function e(t){var n=t.currentTarget.dataset;var r=n.path;var i=r;if(r===this.getCurrentFolder()){this.notify(s.Loc.getMessage("MESSAGES_ALREADY_EXIST_IN_FOLDER"));return}var a=undefined;var o=BX.findParent(t.currentTarget,{className:"popup-window"});if(o){a=BX.data(o,"grid-row-id")}var l=JSON.parse(n.isDisabled);if(a===undefined&&this.getGridInstance().getRows().getSelectedIds().length===0||l){return}var u=this.getGridInstance().getRows().getSelected();var d=a?[a]:this.getGridInstance().getRows().getSelectedIds();d=this.filterRowsByClassName(this.disabledClassName,d,true);if(!d.length){return}BX.onCustomEvent("Grid::updated");var c;if(a===undefined){c=BX.Mail.Home.Grid.getSelectedIds()}else{c=[a]}BX.Mail.Home.Grid.hideRowByIds(c);var h=this.filterRowsByClassName("mail-msg-list-cell-unseen",c).length;if(this.getCurrentFolder()!==""){BX.Mail.Home.Counters.updateCounters([{name:i,increase:true,count:h},{name:this.getCurrentFolder(),lower:true,count:h}])}this.runAction("moveToFolder",{keepRows:true,ids:d,params:{folder:r},analyticsLabel:{groupCount:u.length,bindings:this.getRowsBindings(a?[this.getGridInstance().getRows().getById(a)]:u)}},(function(){BX.Mail.Home.Grid.reloadTable()}));if(a===undefined){this.resetGridSelection()}}},{key:"onReadClick",value:function e(t){var n=[];var r=[];if(t===undefined){n=this.getGridInstance().getRows().getSelected();r=this.getGridInstance().getRows().getSelectedIds()}else{var i=this.getGridInstance().getRows().getSelectedIds();if(i.length===1&&i[0]===t){n=this.getGridInstance().getRows().getSelected();r=i;t=undefined}else{r=[t]}}if(t===undefined&&n.length===0){return}var s="all"==t||this.isSelectedRowsHaveClass("mail-msg-list-cell-unseen",t)?"markAsSeen":"markAsUnseen";r=this.filterRowsByClassName("mail-msg-list-cell-unseen",r,s!=="markAsSeen");r=this.filterRowsByClassName(this.disabledClassName,r,true);if(!r.length){return}var a=function e(){this.userInterfaceManager.onMessagesRead(r,{action:s});var i=this.getCurrentFolder();var a=s!=="markAsSeen"?this.isSelectedRowsHaveClass("mail-msg-list-cell-old"):0;var o=r.length-a;if(this.getCurrentFolder()!==""){if(s==="markAsSeen"){if("all"===t){o=BX.Mail.Home.Counters.getCounter(i)-a}BX.Mail.Home.Counters.updateCounters([{name:i,lower:true,count:o}])}else{BX.Mail.Home.Counters.updateCounters([{name:i,increase:true,count:o}])}}if(t===undefined){this.resetGridSelection()}if("all"==t){r["for_all"]=this.mailboxId+"-"+this.userInterfaceManager.getCurrentFolder()}this.userInterfaceManager.updateUnreadCounters();this.runAction(s,{ids:r,keepRows:true,successParams:s,analyticsLabel:{groupCount:n.length,bindings:this.getRowsBindings(t?[this.getGridInstance().getRows().getById(t)]:n)},onSuccess:function(){this.updateCountersFromBackend()}.bind(this)});return true};a.apply(this)}},{key:"onSpamClick",value:function e(t){var n=this.getGridInstance().getRows().getSelected();if(t===undefined&&n.length===0){return}if(!this.canMarkSpam){this.showDirsSlider();return}var r=this.isSelectedRowsHaveClass("js-spam",t)?"restoreFromSpam":"markAsSpam";var i=this.filterRowsByClassName("js-spam",t,r!=="restoreFromSpam");i=this.filterRowsByClassName(this.disabledClassName,i,true);if(!i.length){return}var s={keepRows:true,analyticsLabel:{groupCount:n.length,bindings:this.getRowsBindings(t?[this.getGridInstance().getRows().getById(t)]:n)}};var a;if(t===undefined){a=BX.Mail.Home.Grid.getSelectedIds()}else{a=[t]}s.ids=a;BX.Mail.Home.Grid.hideRowByIds(a);var o=this.filterRowsByClassName("mail-msg-list-cell-unseen",a).length;if(this.getCurrentFolder()!==""){if(r==="markAsSpam"){BX.Mail.Home.Counters.updateCounters([{name:this.userInterfaceManager.spamDir,increase:true,count:o},{name:this.getCurrentFolder(),lower:true,count:o}])}else{BX.Mail.Home.Counters.updateCounters([{name:this.userInterfaceManager.spamDir,lower:true,count:o},{name:this.userInterfaceManager.inboxDir,increase:true,count:o}])}}this.runAction(r,s,(function(){return BX.Mail.Home.Grid.reloadTable()}));if(t===undefined){this.resetGridSelection()}}},{key:"getConfirmDeletePopup",value:function e(t){return new BX.UI.Dialogs.MessageBox({title:s.Loc.getMessage("MAIL_MESSAGE_LIST_CONFIRM_TITLE"),message:s.Loc.getMessage("MAIL_MESSAGE_LIST_CONFIRM_DELETE"),buttons:[new BX.UI.Button({color:BX.UI.Button.Color.DANGER,text:s.Loc.getMessage("MAIL_MESSAGE_LIST_CONFIRM_DELETE_BTN"),onclick:function(e){var n=this.filterRowsByClassName("mail-msg-list-cell-unseen",t.ids).length;BX.Mail.Home.Counters.updateCounters([{name:this.getCurrentFolder(),lower:true,count:n}]);this.runAction("delete",t,(function(){return BX.Mail.Home.Grid.reloadTable()}));e.getContext().close();BX.Mail.Home.Grid.hideRowByIds(t.ids)}.bind(this)}),new BX.UI.CancelButton({onclick:function e(t){t.getContext().close()}})]})}},{key:"resetGridSelection",value:function e(){BX.onCustomEvent("Mail::resetGridSelection");this.getGridInstance().getRows().unselectAll();this.getGridInstance().adjustCheckAllCheckboxes();BX.Mail.Home.Grid.hidePanel()}},{key:"isSelectedRowsHaveClass",value:function e(t,n){var r;if(n===undefined){r=this.getGridInstance().getRows().getSelectedIds()}else{r=[n]}var i=r.length?r:n?[n]:[];var s=0;for(var a=0;a<i.length;a++){var o=this.getGridInstance().getRows().getById(i[a]);if(o&&o.node){var l=o.node.getElementsByClassName(t);if(l&&l.length){s++}}}return s}},{key:"filterRowsByClassName",value:function e(t,n,r){var i=[];if("all"==n){i=this.getGridInstance().getRows().getBodyChild().map((function(e){return e.getId()}))}else if(Array.isArray(n)){i=n}else{var s=this.getGridInstance().getRows().getSelectedIds();i=s.length?s:n?[n]:[]}var a=[];for(var o=i.length-1;o>=0;o--){var l=this.getGridInstance().getRows().getById(i[o]);if(l&&l.node){var u=l.node.getElementsByClassName(t);if(!r&&u&&u.length){a.push(i[o])}else if(r&&!(u&&u.length)){a.push(i[o])}}}return a}},{key:"notify",value:function e(t,n){top.BX.UI.Notification.Center.notify({autoHideDelay:n>0?n:2e3,content:t?t:s.Loc.getMessage("MAIL_MESSAGE_LIST_NOTIFY_SUCCESS")})}},{key:"updateCountersFromBackend",value:function e(){if(this.getCurrentFolder()===""){BX.ajax.runComponentAction("bitrix:mail.client.message.list","getDirsWithUnseenMailCounters",{mode:"class",data:{mailboxId:this.mailboxId}}).then((function(e){BX.Mail.Home.Counters.setCounters(e.data)}))}}},{key:"runAction",value:function e(t,n,r){n=n?n:{};var i=[];if(n.ids){i=n.ids}if(!i.length&&!i.for_all){return}if(!n.keepRows){this.getGridInstance().tableFade()}var s={ids:i};if(n.params){var a=Object.keys(Object(n.params));for(var o=0,l=a.length;o<l;o++){var u=a[o];var d=Object.getOwnPropertyDescriptor(n.params,u);if(d!==undefined&&d.enumerable){s[u]=n.params[u]}}}BX.ajax.runComponentAction("bitrix:mail.client",t,{mode:"ajax",data:s,analyticsLabel:n.analyticsLabel}).then(function(){if(n.onSuccess===false){return}this.updateCountersFromBackend();if(n.onSuccess&&typeof n.onSuccess==="function"){n.onSuccess.bind(this,i,n.successParams)();return}if(r===undefined){this.notify()}else{r()}}.bind(this),function(e){BX.Mail.Home.Counters.restoreFromCache();BX.Mail.Home.Grid.reloadTable();n.onError&&typeof n.onError==="function"?n.onError().bind(this,e):this.onErrorRequest(e)}.bind(this))}},{key:"onErrorRequest",value:function e(t){var n={};this.checkErrorRights(t.errors);n.errorMessage=t.errors[0].message;this.notify(n.errorMessage)}},{key:"checkErrorRights",value:function e(t){for(var n=0;n<t.length;n++){if(t[n].code===this.ERROR_CODE_CAN_NOT_DELETE){this.canDelete=false}if(t[n].code===this.ERROR_CODE_CAN_NOT_MARK_SPAM){this.canMarkSpam=false}}}},{key:"showDirsSlider",value:function e(){var t=BX.util.add_url_param("/mail/config/dirs",{mailboxId:this.mailboxId});BX.SidePanel.Instance.open(t,{width:640,cacheable:false,allowChangeHistory:false});this.canDelete=true;this.canMarkSpam=true}},{key:"onDisabledGroupActionClick",value:function e(){}},{key:"getCurrentFolder",value:function e(){return this.userInterfaceManager.getCurrentFolder()}},{key:"getGridInstance",value:function e(){return BX.Main.gridManager.getById(this.gridId).instance}},{key:"getRowsBindings",value:function e(t){return BX.util.array_unique(Array.prototype.concat.apply([],t.map((function(e){if(!e||!e.node){return null}return Array.prototype.map.call(e.node.querySelectorAll('[class^="js-bind-"] [data-type]'),(function(e){return e.dataset.type}))}))))}},{key:"getCache",value:function e(t){if(!t){return}return this.cache[t]?this.cache[t]:null}},{key:"setCache",value:function e(t,n){return this.cache[t]=n}},{key:"showICalMenuDropdown",value:function e(t){t.stopPropagation();t.preventDefault();var n=t.currentTarget.dataset.menu;if(!n){return}this.iCalMenuDropdown=BX.Main.MenuManager.create({id:"mail-client-message-list-ical-dropdown-menu",autoHide:true,closeByEsc:true,items:JSON.parse(n),zIndex:7001,maxHeight:400,maxWidth:200,angle:{position:"top",offset:40},events:{onPopupClose:function(){this.removeICalMenuDropdown()}.bind(this)}});this.iCalMenuDropdown.popupWindow.setBindElement(t.currentTarget);this.iCalMenuDropdown.show()}},{key:"removeICalMenuDropdown",value:function e(){if(this.iCalMenuDropdown){BX.Main.MenuManager.destroy(this.iCalMenuDropdown.id)}}},{key:"onClickICalButton",value:function e(t){t.stopPropagation();t.preventDefault();var n=t.target.dataset.messageid||t.target.parentNode.dataset.messageid;var r=t.target.dataset.action||t.target.parentNode.dataset.action;var i=t.target;i.classList.add("ui-btn-wait");this.removeICalMenuDropdown();this.sendICal(n,r).then(function(){i.classList.remove("ui-btn-wait");this.notify(s.Loc.getMessage(r==="cancelled"?"MAIL_MESSAGE_ICAL_NOTIFY_REJECT":"MAIL_MESSAGE_ICAL_NOTIFY_ACCEPT"))}.bind(this))["catch"](function(){i.classList.remove("ui-btn-wait");this.notify(s.Loc.getMessage("MAIL_MESSAGE_ICAL_NOTIFY_ERROR"))}.bind(this))}},{key:"sendICal",value:function e(t,n){return new Promise((function(e,r){BX.ajax.runComponentAction("bitrix:mail.client","ical",{mode:"ajax",data:{messageId:t,action:n}}).then(function(){e()}.bind(this),function(){r()}.bind(this))}))}}]);return e}();var B=s.Reflection.namespace("BX.Mail.Home");i.EventEmitter.subscribe("SidePanel.Slider:onMessage",(function(e){var t=e.getCompatData(),n=babelHelpers.slicedToArray(t,1),r=n[0];if(r.getEventId()==="mail-mailbox-config-success"){BXMailMailbox.sync(B.ProgressBar,B.Grid.getId(),false,true)}}));var E;var k;var A;var R;var _={};s.Event.ready((function(){R=document.querySelector('[data-role="mail-msg-sync-button-wrapper"]');var e=new a.Button({className:"ui-btn ui-btn-themes ui-btn-light-border mail-msg-sync-button",icon:a.Button.Icon.BUSINESS,props:{title:s.Loc.getMessage("MAIL_MESSAGE_SYNC_BTN_HINT")},onclick:function e(){BXMailMailbox.sync(B.ProgressBar,s.Loc.getMessage("MAIL_MESSAGE_GRID_ID"),false,true)}});R.append(e.getContainer());i.EventEmitter.subscribe("BX.Main.Grid:onBeforeReload",(function(e){var t=e.getCompatData(),n=babelHelpers.slicedToArray(t,1),r=n[0];if(r!=={}&&r!==undefined&&s.Loc.getMessage("MAIL_MESSAGE_GRID_ID")===r.getId()){_=r.getRows().getSelectedIds()}}));i.EventEmitter.subscribe("Grid::updated",(function(e){var t=e.getCompatData(),n=babelHelpers.slicedToArray(t,1),r=n[0];if(r!=={}&&r!==undefined&&s.Loc.getMessage("MAIL_MESSAGE_GRID_ID")===r.getId()){var a=false;B.Grid.getRows().map((function(e){if(s.Type.isFunction(_.indexOf)&&_.indexOf(e.getId())!==-1){if(e.isShown()){e.select();a=true}}}));_={};if(a){setTimeout((function(){i.EventEmitter.emit(window,"Grid::thereSelectedRows")}),0)}}}));t.Avatar.replaceTagsWithAvatars({className:"mail-ui-avatar"});E=document.getElementsByClassName("ui-slider-page")[0];k=document.querySelector('[data-role="mail-progress-bar"]');E.insertBefore(k,E.firstChild);A=document.querySelector('[data-role="error-box"]');B.ProgressBar=new m(k);B.unreadMessageMailboxesMarker=document.querySelector('[data-role="unreadMessageMailboxesMarker"]');B.ProgressBar.setSyncButton(e);B.ProgressBar.setErrorBoxNode(document.querySelector('[data-role="error-box"]'));B.ProgressBar.setErrorTextNode(document.querySelector('[data-role="error-box-text"]'));B.ProgressBar.setErrorHintNode(document.querySelector('[data-role="error-box-hint"]'));B.ProgressBar.setErrorTitleNode(document.querySelector('[data-role="error-box-title"]'))}));BX.ready((function(){B.Counters=new I("dirs",s.Loc.getMessage("DEFAULT_DIR"));B.mailboxCounters=new I("mailboxCounters");B.Grid=new n.MessageGrid(s.Loc.getMessage("MAILBOX_IS_SYNC_AVAILABILITY"))}));B.LeftMenu=S;var G=s.Reflection.namespace("BX.Mail.Client.Message");G.List=w})(this.window=this.window||{},BX.Mail,BX.Mail,BX.Mail,BX.Event,BX,BX.UI);
//# sourceMappingURL=script.map.js