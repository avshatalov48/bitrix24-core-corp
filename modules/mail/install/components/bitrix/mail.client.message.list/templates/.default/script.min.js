(function(){BX.namespace("BX.Mail.Client.Message.List");BX.Mail.Client.Message.List=function(e){this.gridId=e.gridId;this.mailboxId=e.mailboxId;this.canMarkSpam=e.canMarkSpam;this.canDelete=e.canDelete;this.moveBtnMailIdPrefix=e.moveBtnMailIdPrefix;this.connectedMailboxesLicenseInfo=e.connectedMailboxesLicenseInfo;this.ERROR_CODE_CAN_NOT_DELETE=e.ERROR_CODE_CAN_NOT_DELETE;this.ERROR_CODE_CAN_NOT_MARK_SPAM=e.ERROR_CODE_CAN_NOT_MARK_SPAM;this.disabledClassName="js-disabled";this.userInterfaceManager=new BX.Mail.Client.Message.List.UserInterfaceManager(e);this.userInterfaceManager.reloadGrid=this.reloadGrid.bind(this);this.userInterfaceManager.resetGridSelection=this.resetGridSelection.bind(this);this.userInterfaceManager.isSelectedRowsHaveClass=this.isSelectedRowsHaveClass.bind(this);this.userInterfaceManager.getGridInstance=this.getGridInstance.bind(this);this.addEventHandlers();BX.Mail.Client.Message.List[e.id]=this};BX.Mail.Client.Message.List.prototype={addEventHandlers:function(){BX.ajax.UpdatePageData=function(){};BX.addCustomEvent("onSubMenuShow",function(){BX.data(this.getSubMenu().getPopupWindow().getPopupContainer(),"grid-row-id",this.gridRowId||BX.data(this.getMenuWindow().getPopupWindow().getPopupContainer(),"grid-row-id"))})},showLicensePopup:function(e){B24.licenseInfoPopup.show(e,BX.message("MAIL_MAILBOX_LICENSE_CONNECTED_MAILBOXES_LIMIT_TITLE"),this.connectedMailboxesLicenseInfo)},onCrmClick:function(e){var t=this.getGridInstance().getRows().getSelected();var n=e?this.getGridInstance().getRows().getById(e):t[0];if(!(n&&n.node)){return}var s=this.userInterfaceManager.isAddToCrmActionAvailable(n.node);var i=n.node.querySelector("[data-message-id]");if(!(i.dataset&&i.dataset.messageId)){return}this.resetGridSelection();if(s){if(typeof this.isAddingToCrmInProgress!=="object"){this.isAddingToCrmInProgress={}}if(this.isAddingToCrmInProgress[e]===true){return}this.isAddingToCrmInProgress[e]=true;BX.ajax.runComponentAction("bitrix:mail.client","createCrmActivity",{mode:"ajax",data:{messageId:i.dataset.messageId},analyticsLabel:{groupCount:t.length,bindings:this.getRowsBindings([n])}}).then(function(e,t){this.isAddingToCrmInProgress[e]=false;this.notify(BX.message("MAIL_MESSAGE_LIST_NOTIFY_ADDED_TO_CRM"));this.userInterfaceManager.onBindingCreated()}.bind(this,e),function(t){this.isAddingToCrmInProgress[e]=false;if(t.errors&&t.errors.length>0){this.notify(t.errors.map(function(e){return e.message}).join("<br>"),5e3)}else{this.notify(BX.message("MAIL_MESSAGE_LIST_NOTIFY_ADD_TO_CRM_ERROR"))}}.bind(this))}else{BX.ajax.runComponentAction("bitrix:mail.client","removeCrmActivity",{mode:"ajax",data:{messageId:i.dataset.messageId},analyticsLabel:{groupCount:t.length,bindings:this.getRowsBindings([n])}}).then(function(e){this.userInterfaceManager.onCrmBindingDeleted(e.dataset.messageId);this.notify(BX.message("MAIL_MESSAGE_LIST_NOTIFY_EXCLUDED_FROM_CRM"))}.bind(this,i))}},onViewClick:function(e){if(e===undefined&&this.getGridInstance().getRows().getSelectedIds().length===0){return}BX.SidePanel.Instance.open("/mail/message/"+e,{width:1080})},onDeleteClick:function(e){var t=this.getGridInstance().getRows().getSelected();if(e===undefined&&t.length===0){return}if(!this.canDelete){this.showSettingsSlider();return}var n={analyticsLabel:{groupCount:t.length,bindings:this.getRowsBindings(e?[this.getGridInstance().getRows().getById(e)]:t)},onSuccess:function(){this.reloadGrid({})}};if(e!==undefined){n.ids=[e]}if(this.userInterfaceManager.isCurrentFolderTrash){var s=this.getConfirmDeletePopup(n);s.show()}else{this.runAction("delete",n)}},onMoveToFolderClick:function(e){var t=e.currentTarget.dataset;var n=null;var s=BX.findParent(e.currentTarget,{className:"popup-window"});if(s){n=BX.data(s,"grid-row-id")}var i=JSON.parse(t.isDisabled);var a=t.folderPath;if(n===null&&this.getGridInstance().getRows().getSelectedIds().length===0||i){return}var r=this.getGridInstance().getRows().getSelected();var o=n?[n]:this.getGridInstance().getRows().getSelectedIds();o=this.filterRowsByClassName(this.disabledClassName,o,true);if(!o.length){return}this.resetGridSelection();this.runAction("moveToFolder",{ids:o,params:{folder:a},analyticsLabel:{groupCount:r.length,bindings:this.getRowsBindings(n?[this.getGridInstance().getRows().getById(n)]:r)}})},onReadClick:function(e){var t=this.getGridInstance().getRows().getSelected();if(e===undefined&&t.length===0){return}var n=this.isSelectedRowsHaveClass("mail-msg-list-cell-unseen",e)?"markAsSeen":"markAsUnseen";var s=this.filterRowsByClassName("mail-msg-list-cell-unseen",e,n!=="markAsSeen");s=this.filterRowsByClassName(this.disabledClassName,s,true);if(!s.length){return}this.userInterfaceManager.onMessagesRead(s,{action:n});this.resetGridSelection();if(n==="markAsSeen"){this.userInterfaceManager.updateUnreadCounters(-s.length)}else{this.userInterfaceManager.updateUnreadCounters(s.length)}this.runAction(n,{ids:s,keepRows:true,successParams:n,analyticsLabel:{groupCount:t.length,bindings:this.getRowsBindings(e?[this.getGridInstance().getRows().getById(e)]:t)},onSuccess:false})},onSpamClick:function(e){var t=this.getGridInstance().getRows().getSelected();if(e===undefined&&t.length===0){return}if(!this.canMarkSpam){this.showSettingsSlider();return}var n=this.isSelectedRowsHaveClass("js-spam",e)?"restoreFromSpam":"markAsSpam";var s=this.filterRowsByClassName("js-spam",e,n!=="restoreFromSpam");s=this.filterRowsByClassName(this.disabledClassName,s,true);if(!s.length){return}var i={analyticsLabel:{groupCount:t.length,bindings:this.getRowsBindings(e?[this.getGridInstance().getRows().getById(e)]:t)},onSuccess:function(){this.reloadGrid({})}};if(e!==undefined){i.ids=[e]}this.runAction(n,i)},getConfirmDeletePopup:function(e){if(!this.popupConfirm){var t=[new BX.PopupWindowButton({text:BX.message("MAIL_MESSAGE_LIST_CONFIRM_CANCEL_BTN"),className:"popup-window-button-cancel",events:{click:BX.delegate(function(){this.popupConfirm.close()},this)}}),new BX.PopupWindowButton({text:BX.message("MAIL_MESSAGE_LIST_CONFIRM_DELETE_BTN"),className:"popup-window-button-decline",events:{click:BX.delegate(function(){this.runAction("delete",e);this.popupConfirm.close()},this)}})];this.popupConfirm=new BX.PopupWindow("bx-mail-message-list-popup-delete-confirm",null,{zIndex:1e3,autoHide:true,buttons:t,closeByEsc:true,titleBar:{content:BX.create("div",{html:'<span class="popup-window-titlebar-text">'+BX.message("MAIL_MESSAGE_LIST_CONFIRM_TITLE")+"</span>"})},events:{onPopupClose:function(){this.destroy()},onPopupDestroy:BX.delegate(function(){this.popupConfirm=null},this)},content:BX.create("div",{html:BX.message("MAIL_MESSAGE_LIST_CONFIRM_DELETE")})});this.popupConfirm.selectedIds=e.ids}return this.popupConfirm},resetGridSelection:function(){this.getGridInstance().getRows().unselectAll();BX.onCustomEvent("Grid::updated")},isSelectedRowsHaveClass:function(e,t){var n=this.getGridInstance().getRows().getSelectedIds();var s=n.length?n:t?[t]:[];var i=[];for(var a=0;a<s.length;a++){var r=this.getGridInstance().getRows().getById(s[a]);if(r&&r.node){var o=r.node.getElementsByClassName(e);if(o&&o.length){return true}}}return false},filterRowsByClassName:function(e,t,n){var s=[];if(Array.isArray(t)){s=t}else{var i=this.getGridInstance().getRows().getSelectedIds();s=i.length?i:t?[t]:[]}var a=[];for(var r=s.length-1;r>=0;r--){var o=this.getGridInstance().getRows().getById(s[r]);if(o&&o.node){var d=o.node.getElementsByClassName(e);if(!n&&(d&&d.length)){a.push(s[r])}else if(n&&!(d&&d.length)){a.push(s[r])}}}return a},notify:function(e,t){top.BX.UI.Notification.Center.notify({autoHideDelay:t>0?t:2e3,content:e?e:BX.message("MAIL_MESSAGE_LIST_NOTIFY_SUCCESS")})},runAction:function(e,t){t=t?t:{};var n=this.getGridInstance().getRows().getSelectedIds();if(t.ids){n=t.ids}if(!n.length){return}if(!t.keepRows){this.getGridInstance().tableFade()}var s={ids:n};if(t.params){var i=Object.keys(Object(t.params));for(var a=0,r=i.length;a<r;a++){var o=i[a];var d=Object.getOwnPropertyDescriptor(t.params,o);if(d!==undefined&&d.enumerable){s[o]=t.params[o]}}}BX.ajax.runComponentAction("bitrix:mail.client",e,{mode:"ajax",data:s,analyticsLabel:t.analyticsLabel}).then(function(s){if(t.onSuccess===false){return}if(t.onSuccess&&typeof t.onSuccess==="function"){t.onSuccess.bind(this,n,t.successParams)();return}this.onSuccessRequest(s,e)}.bind(this),function(e){t.onError&&typeof t.onError==="function"?t.onError().bind(this,e):this.onErrorRequest(e)}.bind(this))},onErrorRequest:function(e){options={};this.checkErrorRights(e.errors);options.errorMessage=e.errors[0].message;this.reloadGrid(options)},checkErrorRights:function(e){for(var t=0;t<e.length;t++){if(e[t].code===this.ERROR_CODE_CAN_NOT_DELETE){this.canDelete=false}if(e[t].code===this.ERROR_CODE_CAN_NOT_MARK_SPAM){this.canMarkSpam=false}}},onSuccessRequest:function(e,t){this.notify();this.reloadGrid({})},reloadGrid:function(e){var t=this.getGridInstance();if(t){e.apply_filter="Y";t.reloadTable("POST",e)}},showSettingsSlider:function(){var e=BX.util.add_url_param("/mail/config/edit",{id:this.mailboxId+"#mail-cfg-dirs"});BX.SidePanel.Instance.open(e,{width:760,cacheable:false,allowChangeHistory:false});this.canDelete=true;this.canMarkSpam=true},onDisabledGroupActionClick:function(){},onUnreadCounterClick:function(){this.userInterfaceManager.onUnreadCounterClick()},onDirsMenuItemClick:function(e){if(BX.data(e,"is-disabled")=="true"){return}var t=this.userInterfaceManager.getFilterInstance();var n=t.getApi();n.setFields({DIR:BX.data(e,"folder-path")});n.apply();this.userInterfaceManager.onMailboxMenuClick()},getGridInstance:function(){return BX.Main.gridManager.getById(this.gridId).instance},getRowsBindings:function(e){return BX.util.array_unique(Array.prototype.concat.apply([],e.map(function(e){return Array.prototype.map.call(e.node.querySelectorAll('[class^="js-bind-"] [data-type]'),function(e){return e.dataset.type})})))}}})();
//# sourceMappingURL=script.map.js