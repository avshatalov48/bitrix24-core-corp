{"version":3,"file":"secretary.bundle.js","sources":["../src/secretary.js"],"sourcesContent":["import {Type} from 'main.core';\n\nconst ENTITY_TYPE = 'mail';\n\nconst instances = {};\n\n/**\n * Mail Secretary\n * @see control-button.js\n */\nexport class Secretary\n{\n\t#messageId: number;\n\n\tconstructor(messageId: number)\n\t{\n\t\tthis.#messageId = messageId;\n\t\tthis.sliderId = `MailSecretary:${ENTITY_TYPE + this.#messageId}${Math.floor(Math.random() * 1000)}`;\n\t\tthis.contextBx = (window.top.BX || window.BX);\n\t\tthis.subscribe();\n\t}\n\n\tstatic getInstance(messageId: number)\n\t{\n\t\tif (Type.isUndefined(instances[messageId]))\n\t\t{\n\t\t\tinstances[messageId] = new Secretary(messageId);\n\t\t}\n\t\treturn instances[messageId];\n\t}\n\n\topenChat()\n\t{\n\t\treturn BX.ajax.runAction('mail.secretary.createChatFromMessage',\n\t\t\t{data: {messageId: this.#messageId}},\n\t\t).then(\n\t\t\t(response) => {\n\t\t\t\tif (top.window.BXIM && response.data)\n\t\t\t\t{\n\t\t\t\t\ttop.BXIM.openMessenger('chat' + parseInt(response.data));\n\t\t\t\t}\n\t\t\t},\n\t\t\t(response) => {\n\t\t\t\tthis.#displayErrors(response.errors);\n\t\t\t},\n\t\t);\n\t}\n\n\topenCalendarEvent()\n\t{\n\t\treturn BX.ajax.runAction('mail.secretary.getCalendarEventDataFromMessage',\n\t\t\t{data: {messageId: this.#messageId}}\n\t\t).then(\n\t\t\t(response) => {\n\t\t\t\t// let users = [];\n\t\t\t\t// if (Type.isArrayLike(response.data.userIds))\n\t\t\t\t// {\n\t\t\t\t// \tusers = response.data.userIds.map((userId) => {\n\t\t\t\t// \t\treturn {id: parseInt(userId), entityId: 'user'};\n\t\t\t\t// \t});\n\t\t\t\t// }\n\n\t\t\t\tnew (window.top.BX || window.BX).Calendar.SliderLoader(\n\t\t\t\t\t0,\n\t\t\t\t\t{\n\t\t\t\t\t\tsliderId: this.sliderId,\n\t\t\t\t\t\tentryName: response.data.name,\n\t\t\t\t\t\tentryDescription: response.data.desc,\n\t\t\t\t\t\t// participantsEntityList: users,\n\t\t\t\t\t}\n\t\t\t\t).show();\n\t\t\t},\n\t\t\t(response) => {\n\t\t\t\tthis.#displayErrors(response.errors);\n\t\t\t},\n\t\t);\n\t}\n\n\tonCalendarSave(event)\n\t{\n\t\tif (event instanceof this.contextBx.Event.BaseEvent)\n\t\t{\n\t\t\tconst data = event.getData();\n\n\t\t\tif (data.sliderId === this.sliderId)\n\t\t\t{\n\t\t\t\tBX.ajax.runAction('mail.secretary.onCalendarSave', {\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tmessageId: this.#messageId,\n\t\t\t\t\t\tcalendarEventId: data.responseData.entryId,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\tsubscribe()\n\t{\n\t\tthis.contextBx.Event.EventEmitter.subscribe('BX.Calendar:onEntrySave', this.onCalendarSave.bind(this));\n\t}\n\n\tdestroy()\n\t{\n\t\tthis.contextBx.Event.EventEmitter.unsubscribe('BX.Calendar:onEntrySave', this.onCalendarSave);\n\t}\n\n\t#displayErrors(errors: Array)\n\t{\n\t\tif (Type.isArray(errors))\n\t\t{\n\t\t\tlet errorMessages = [];\n\t\t\terrors.forEach((error) => {\n\t\t\t\terrorMessages.push(error.message);\n\t\t\t});\n\t\t\talert(errorMessages.join(\"\\n\"));\n\t\t}\n\t\telse\n\t\t{\n\t\t\talert(\"action can't be performed\");\n\t\t}\n\t}\n}"],"names":["ENTITY_TYPE","instances","Secretary","messageId","sliderId","Math","floor","random","contextBx","window","top","BX","subscribe","ajax","runAction","data","then","response","BXIM","openMessenger","parseInt","errors","Calendar","SliderLoader","entryName","name","entryDescription","desc","show","event","Event","BaseEvent","getData","calendarEventId","responseData","entryId","EventEmitter","onCalendarSave","bind","unsubscribe","Type","isUndefined","isArray","errorMessages","forEach","error","push","message","alert","join"],"mappings":"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"}