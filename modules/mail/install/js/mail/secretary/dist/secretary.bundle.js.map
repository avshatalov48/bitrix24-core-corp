{"version":3,"file":"secretary.bundle.js","sources":["../src/secretary.js"],"sourcesContent":["import {Type} from 'main.core';\n\nconst ENTITY_TYPE = 'mail';\n\nconst instances = {};\n\n/**\n * Mail Secretary\n * @see control-button.js\n */\nexport class Secretary\n{\n\t#messageId: number;\n\n\tconstructor(messageId: number)\n\t{\n\t\tthis.#messageId = messageId;\n\t\tthis.sliderId = `MailSecretary:${ENTITY_TYPE + this.#messageId}${Math.floor(Math.random() * 1000)}`;\n\t\tthis.contextBx = (window.top.BX || window.BX);\n\t\tthis.subscribe();\n\t}\n\n\tstatic getInstance(messageId: number)\n\t{\n\t\tif (Type.isUndefined(instances[messageId]))\n\t\t{\n\t\t\tinstances[messageId] = new Secretary(messageId);\n\t\t}\n\t\treturn instances[messageId];\n\t}\n\n\topenChat()\n\t{\n\t\treturn BX.ajax.runAction('mail.secretary.createChatFromMessage',\n\t\t\t{data: {messageId: this.#messageId}},\n\t\t).then(\n\t\t\t(response) => {\n\t\t\t\tif (top.window.BXIM && response.data)\n\t\t\t\t{\n\t\t\t\t\ttop.BXIM.openMessenger('chat' + parseInt(response.data));\n\t\t\t\t}\n\t\t\t},\n\t\t\t(response) => {\n\t\t\t\tthis.#displayErrors(response.errors);\n\t\t\t},\n\t\t);\n\t}\n\n\topenCalendarEvent()\n\t{\n\t\treturn BX.ajax.runAction('mail.secretary.getCalendarEventDataFromMessage',\n\t\t\t{data: {messageId: this.#messageId}}\n\t\t).then(\n\t\t\t(response) => {\n\t\t\t\t// let users = [];\n\t\t\t\t// if (Type.isArrayLike(response.data.userIds))\n\t\t\t\t// {\n\t\t\t\t// \tusers = response.data.userIds.map((userId) => {\n\t\t\t\t// \t\treturn {id: parseInt(userId), entityId: 'user'};\n\t\t\t\t// \t});\n\t\t\t\t// }\n\n\t\t\t\tif (response.data && response.data.isNewEvent)\n\t\t\t\t{\n\t\t\t\t\tnew (window.top.BX || window.BX).Calendar.SliderLoader(\n\t\t\t\t\t\t0,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tsliderId: this.sliderId,\n\t\t\t\t\t\t\tentryName: response.data.name,\n\t\t\t\t\t\t\tentryDescription: response.data.desc,\n\t\t\t\t\t\t\t// participantsEntityList: users,\n\t\t\t\t\t\t}\n\t\t\t\t\t).show();\n\t\t\t\t}\n\t\t\t\telse if (response.data && response.data.isIcal)\n\t\t\t\t{\n\t\t\t\t\treturn BX.ajax.runComponentAction('bitrix:mail.client', 'ical', {\n\t\t\t\t\t\tmode: 'ajax',\n\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\tmessageId: this.#messageId,\n\t\t\t\t\t\t\taction: 'question',\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t},\n\t\t\t(response) => {\n\t\t\t\tthis.#displayErrors(response.errors);\n\t\t\t},\n\t\t).then(\n\t\t\t(response) => {\n\t\t\t\tif (response.data && response.data.eventId)\n\t\t\t\t{\n\t\t\t\t\tnew (window.top.BX || window.BX).Calendar.SliderLoader(\n\t\t\t\t\t\tresponse.data.eventId\n\t\t\t\t\t).show();\n\n\t\t\t\t\tconst grid = new BX.Mail.MessageGrid();\n\t\t\t\t\tgrid.reloadTable();\n\t\t\t\t}\n\t\t\t}\n\t\t);\n\t}\n\n\tonCalendarSave(event)\n\t{\n\t\tif (event instanceof this.contextBx.Event.BaseEvent)\n\t\t{\n\t\t\tconst data = event.getData();\n\n\t\t\tif (data.sliderId === this.sliderId)\n\t\t\t{\n\t\t\t\tBX.ajax.runAction('mail.secretary.onCalendarSave', {\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tmessageId: this.#messageId,\n\t\t\t\t\t\tcalendarEventId: data.responseData.entryId,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\tsubscribe()\n\t{\n\t\tthis.contextBx.Event.EventEmitter.subscribe('BX.Calendar:onEntrySave', this.onCalendarSave.bind(this));\n\t}\n\n\tdestroy()\n\t{\n\t\tthis.contextBx.Event.EventEmitter.unsubscribe('BX.Calendar:onEntrySave', this.onCalendarSave);\n\t}\n\n\t#displayErrors(errors: Array)\n\t{\n\t\tif (Type.isArray(errors))\n\t\t{\n\t\t\tlet errorMessages = [];\n\t\t\terrors.forEach((error) => {\n\t\t\t\terrorMessages.push(error.message);\n\t\t\t});\n\t\t\talert(errorMessages.join(\"\\n\"));\n\t\t}\n\t\telse\n\t\t{\n\t\t\talert(\"action can't be performed\");\n\t\t}\n\t}\n}\n"],"names":["ENTITY_TYPE","instances","Secretary","messageId","sliderId","Math","floor","random","contextBx","window","top","BX","subscribe","ajax","runAction","data","then","response","BXIM","openMessenger","parseInt","errors","isNewEvent","Calendar","SliderLoader","entryName","name","entryDescription","desc","show","isIcal","runComponentAction","mode","action","eventId","grid","Mail","MessageGrid","reloadTable","event","Event","BaseEvent","getData","calendarEventId","responseData","entryId","EventEmitter","onCalendarSave","bind","unsubscribe","Type","isUndefined","isArray","errorMessages","forEach","error","push","message","alert","join"],"mappings":"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"}