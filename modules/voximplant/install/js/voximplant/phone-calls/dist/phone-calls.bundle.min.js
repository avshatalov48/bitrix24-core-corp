this.BX=this.BX||{};(function(e,t,i,s,n,l,a){"use strict";var o=15e3;var r=function e(){};var c=["1","2","3","4","5","6","7","8","9","*","0","#"];var h=function(){function e(t){babelHelpers.classCallCheck(this,e);if(!s.Type.isPlainObject(t)){t={}}this.bindElement=t.bindElement||null;this.offsetTop=t.offsetTop||0;this.offsetLeft=t.offsetLeft||0;this.anglePosition=t.anglePosition||"";this.angleOffset=t.angleOffset||0;this.history=t.history||[];this.selectedLineId=t.defaultLineId;this.lines=t.lines||{};this.availableLines=t.availableLines||[];this.callInterceptAllowed=t.callInterceptAllowed===true;this.zIndex=o+200;this.hideDial=t.hideDial===true;this.plusEntered=false;this.callbacks={onButtonClick:s.Type.isFunction(t.onButtonClick)?t.onButtonClick:r,onDial:s.Type.isFunction(t.onDial)?t.onDial:r,onIntercept:s.Type.isFunction(t.onIntercept)?t.onIntercept:r,onClose:s.Type.isFunction(t.onClose)?t.onClose:r};this.elements={inputContainer:null,input:null,lineSelector:null,lineName:null,interceptButton:null,historyButton:null};this.plusKeyTimeout=null;this.popup=this.createPopup()}babelHelpers.createClass(e,[{key:"createPopup",value:function e(){var t={id:"phone-call-view-popup-keypad",bindElement:this.bindElement,targetContainer:document.body,darkMode:true,closeByEsc:true,autoHide:true,zIndex:this.zIndex,content:this.render(),noAllPaddings:true,offsetTop:this.offsetTop,offsetLeft:this.offsetLeft,overlay:{backgroundColor:"white",opacity:0},events:{onPopupClose:this.onPopupClose.bind(this)}};if(this.anglePosition!==""){t.angle={position:this.anglePosition,offset:this.angleOffset}}return new l.Popup(t)}},{key:"onPopupClose",value:function e(){this.callbacks.onClose();if(this.popup){this.popup.destroy()}}},{key:"canSelectLine",value:function e(){return this.availableLines.length>1}},{key:"setSelectedLineId",value:function e(t){this.selectedLineId=t;if(this.elements.lineName){this.elements.lineName.innerText=this.getLineName(t)}}},{key:"getLineName",value:function e(t){return this.lines.hasOwnProperty(t)?this.lines[t].SHORT_NAME:""}},{key:"render",value:function e(){var t=this;return s.Dom.create("div",{props:{className:"bx-messenger-calc-wrap"},children:[s.Dom.create("div",{props:{className:"bx-messenger-calc-body"},children:[this.elements.inputContainer=s.Dom.create("div",{props:{className:"bx-messenger-calc-panel"},children:[s.Dom.create("span",{props:{className:"bx-messenger-calc-panel-delete"},events:{click:this._onDeleteButtonClick.bind(this)}}),this.elements.input=s.Dom.create("input",{attrs:{readonly:this.hideDial,type:"text",value:"",placeholder:s.Loc.getMessage(this.hideDial?"IM_PHONE_PUT_DIGIT":"IM_PHONE_PUT_NUMBER")},props:{className:"bx-messenger-calc-panel-input"},events:{keydown:this._onInputKeydown.bind(this),keyup:function e(){return t._onAfterNumberChanged()}}})]}),s.Dom.create("div",{props:{className:"bx-messenger-calc-btns-block"},children:c.map((function(e){return u(e,t._onKeyMouseDown.bind(t),t._onKeyMouseUp.bind(t))}))})]}),this.hideDial?null:s.Dom.create("div",{props:{className:"bx-messenger-call-btn-wrap"},children:[this.elements.lineSelector=!this.canSelectLine()?null:s.Dom.create("div",{props:{className:"im-phone-select-line"},children:[this.elements.lineName=s.Dom.create("span",{props:{className:"im-phone-select-line-name"},text:this.getLineName(this.selectedLineId)}),s.Dom.create("span",{props:{className:"im-phone-select-line-select"}})],events:{click:this._onLineSelectClick.bind(this)}}),s.Dom.create("span",{props:{className:"bx-messenger-call-btn-separate"},children:[s.Dom.create("span",{props:{className:"bx-messenger-call-btn"},children:[s.Dom.create("span",{props:{className:"bx-messenger-call-btn-text"},text:s.Loc.getMessage("IM_PHONE_CALL")})],events:{click:this._onDialButtonClick.bind(this)}}),this.elements.historyButton=s.Dom.create("span",{props:{className:"bx-messenger-call-btn-arrow"},events:{click:this._onShowHistoryButtonClick.bind(this)}})]}),this.elements.interceptButton=s.Dom.create("span",{props:{className:"im-phone-intercept-button"+(this.callInterceptAllowed?"":" im-phone-intercept-button-locked")},text:s.Loc.getMessage("IM_PHONE_CALL_VIEW_INTERCEPT"),events:{click:this._onInterceptButtonClick.bind(this)}})]})]})}},{key:"_onInputKeydown",value:function e(t){if(t.keyCode==13){this.callbacks.onDial({phoneNumber:this.elements.input.value,lineId:this.selectedLineId})}else if(t.keyCode==37||t.keyCode==39||t.keyCode==8||t.keyCode==107||t.keyCode==46||t.keyCode==35||t.keyCode==36);else if(t.key==="+"||t.key==="#"||t.key==="*");else if((t.keyCode==67||t.keyCode==86||t.keyCode==65||t.keyCode==88)&&(t.metaKey||t.ctrlKey));else if(t.keyCode>=48&&t.keyCode<=57&&!t.shiftKey){d(this.elements.input,t.key);t.preventDefault();this.callbacks.onButtonClick({key:t.key})}else if(t.keyCode>=96&&t.keyCode<=105&&!t.shiftKey){d(this.elements.input,t.key);t.preventDefault();this.callbacks.onButtonClick({key:t.key})}else if(!t.ctrlKey&&!t.metaKey&&!t.altKey){t.preventDefault()}}},{key:"_onAfterNumberChanged",value:function e(){this.elements.inputContainer.classList.toggle("bx-messenger-calc-panel-active",this.elements.input.value.length>0);this.elements.input.focus()}},{key:"_onDeleteButtonClick",value:function e(){this.elements.input.value=this.elements.input.value.substr(0,this.elements.input.value.length-1);this._onAfterNumberChanged()}},{key:"_onDialButtonClick",value:function e(){this.callbacks.onDial({phoneNumber:this.elements.input.value,lineId:this.selectedLineId})}},{key:"_onInterceptButtonClick",value:function e(){this.callbacks.onIntercept({interceptButton:this.elements.interceptButton})}},{key:"_onKeyMouseDown",value:function e(t){var i=this;if(t==="0"){this.plusEntered=false;this.plusKeyTimeout=setTimeout((function(){if(!i.elements.input.value.startsWith("+")){i.plusEntered=true;i.elements.input.value="+"+i.elements.input.value}}),500)}}},{key:"_onKeyMouseUp",value:function e(t){if(t==="0"){clearTimeout(this.plusKeyTimeout);if(!this.plusEntered){d(this.elements.input,"0")}this.plusEntered=false}else{d(this.elements.input,t)}this._onAfterNumberChanged();this.callbacks.onButtonClick({key:t})}},{key:"_onShowHistoryButtonClick",value:function e(){var t=this;var i=[];if(!s.Type.isArray(this.history)||this.history.length===0){return}this.history.forEach((function(e,n){i.push({id:"history_"+n,text:s.Text.encode(e),onclick:function i(){t.historySelectMenu.close();t.callbacks.onDial({phoneNumber:e,lineId:t.selectedLineId})}})}));this.historySelectMenu=new l.Menu("phoneCallViewDialHistory",this.elements.historyButton,i,{autoHide:true,offsetTop:0,offsetLeft:0,zIndex:o+300,bindOptions:{position:"top"},angle:{offset:33},closeByEsc:true,overlay:{backgroundColor:"white",opacity:0},events:{onPopupClose:function e(){return t.historySelectMenu.destroy()},onPopupDestroy:function e(){return t.historySelectMenu=null}}});this.historySelectMenu.show()}},{key:"_onLineSelectClick",value:function e(t){var i=this;var n=[];this.availableLines.forEach((function(e){n.push({id:"selectLine_"+e,text:s.Text.encode(i.getLineName(e)),onclick:function t(){i.lineSelectMenu.close();i.setSelectedLineId(e)}})}));this.lineSelectMenu=new l.Menu("phoneCallViewSelectLine",this.elements.lineSelector,n,{autoHide:true,zIndex:this.zIndex+100,closeByEsc:true,bindOptions:{position:"top"},offsetLeft:35,angle:{offset:33},overlay:{backgroundColor:"white",opacity:0},maxHeight:600,events:{onPopupClose:function e(){return i.lineSelectMenu.destroy()},onPopupDestroy:function e(){return i.lineSelectMenu=null}}});this.lineSelectMenu.show()}},{key:"show",value:function e(){if(this.popup){this.popup.show();this.elements.input.focus()}}},{key:"close",value:function e(){if(this.lineSelectMenu){this.lineSelectMenu.destroy()}if(this.historySelectMenu){this.historySelectMenu.destroy()}if(this.popup){this.popup.close()}}},{key:"destroy",value:function e(){if(this.lineSelectMenu){this.lineSelectMenu.destroy()}if(this.historySelectMenu){this.historySelectMenu.destroy()}if(this.popup){this.popup.destroy()}this.popup=null}}]);return e}();function u(e,t,i){var n;if(e=="*"){n="10"}else if(e=="#"){n="11"}else{n=e}return s.Dom.create("span",{dataset:{digit:e},props:{className:"bx-messenger-calc-btn bx-messenger-calc-btn-"+n},children:[s.Dom.create("span",{props:{className:"bx-messenger-calc-btn-num"}})],events:{mousedown:function e(i){return t(i.currentTarget.dataset.digit)},mouseup:function e(t){return i(t.currentTarget.dataset.digit)}}})}function d(e,t){if(e.selectionStart||e.selectionStart=="0"){var i=e.selectionStart;var s=e.selectionEnd;e.value=e.value.substring(0,i)+t+e.value.substring(s,e.value.length);e.selectionStart=i+t.length;e.selectionEnd=i+t.length}else{e.value+=t}}var p={addCommentButtonClick:"addCommentButtonClick",muteButtonClick:"muteButtonClick",holdButtonClick:"holdButtonClick",transferButtonClick:"transferButtonClick",cancelTransferButtonClick:"cancelTransferButtonClick",completeTransferButtonClick:"completeTransferButtonClick",hangupButtonClick:"hangupButtonClick",nextButtonClick:"nextButtonClick",skipButtonClick:"skipButtonClick",answerButtonClick:"answerButtonClick",entityChanged:"entityChanged",qualityMeterClick:"qualityMeterClick",dialpadButtonClick:"dialpadButtonClick",makeCallButtonClick:"makeCallButtonClick",notifyAdminButtonClick:"notifyAdminButtonClick",closeButtonClick:"closeButtonClick"};var m={result:"error",errorCode:"Call card is undefined"};var f=function(){function e(){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"isExternalCall",false);babelHelpers.defineProperty(this,"used",false)}babelHelpers.createClass(e,[{key:"initializePlacement",value:function e(){throw new Error("You have to implement the method initializePlacement!")}},{key:"initializeInterface",value:function e(t){throw new Error("You have to implement the method initializeInterface!")}},{key:"emitInitializeEvent",value:function e(t){throw new Error("You have to implement the method emitInitializeEvent!")}},{key:"emitEvent",value:function e(t,i){throw new Error("You have to implement the method emitEvent!")}},{key:"setCallCard",value:function e(t){this.CallCard=t;return this}},{key:"setIsExternalCall",value:function e(t){this.isExternalCall=t;return this}},{key:"isCardActive",value:function e(){return this.CallCard instanceof Z}},{key:"isUsed",value:function e(){return this.used}},{key:"initializeInterfaceEvents",value:function e(t){t.prototype.events.push("BackgroundCallCard::initialized");t.prototype.events.push("BackgroundCallCard::addCommentButtonClick");t.prototype.events.push("BackgroundCallCard::muteButtonClick");t.prototype.events.push("BackgroundCallCard::holdButtonClick");t.prototype.events.push("BackgroundCallCard::closeButtonClick");t.prototype.events.push("BackgroundCallCard::transferButtonClick");t.prototype.events.push("BackgroundCallCard::cancelTransferButtonClick");t.prototype.events.push("BackgroundCallCard::completeTransferButtonClick");t.prototype.events.push("BackgroundCallCard::hangupButtonClick");t.prototype.events.push("BackgroundCallCard::nextButtonClick");t.prototype.events.push("BackgroundCallCard::skipButtonClick");t.prototype.events.push("BackgroundCallCard::answerButtonClick");t.prototype.events.push("BackgroundCallCard::entityChanged");t.prototype.events.push("BackgroundCallCard::qualityMeterClick");t.prototype.events.push("BackgroundCallCard::dialpadButtonClick");t.prototype.events.push("BackgroundCallCard::makeCallButtonClick");t.prototype.events.push("BackgroundCallCard::notifyAdminButtonClick");return this}},{key:"getEvents",value:function e(){return p}},{key:"getListUiStates",value:function e(t,i){this.used=true;i(Object.keys(F).filter((function(e){switch(e){case"sipPhoneError":return false;case"idle":return false;case"externalCard":return false;default:return true}})))}},{key:"setUiState",value:function e(t,i){this.used=true;if(!this.isCardActive()||!this.isExternalCall){i([this.getUndefinedCallCardError()]);return}if(t&&t.uiState&&F[t.uiState]){this.CallCard.setUiState(F[t.uiState])}else{i([{result:"error",errorCode:"Invalid ui state"}]);return}if(t.uiState==="connected"){if(t.disableAutoStartTimer){this.CallCard.stopTimer();this.hideTimer()}else{this.showTimer()}}if(t.uiState!=="connected"&&!this.CallCard.isTimerStarted()){this.hideTimer()}i([])}},{key:"setMute",value:function e(t,i){this.used=true;if(!this.isCardActive()||!this.isExternalCall){i([this.getUndefinedCallCardError()]);return}if(this.CallCard.isMuted()===!!t.muted){i([]);return}if(t.muted){this.CallCard.setMuted(t.muted);BX.addClass(this.CallCard.elements.buttons.mute,"active");if(this.CallCard.isDesktop()&&this.CallCard.slave){BX.desktop.onCustomEvent(q.onMute,[])}else{this.CallCard.callbacks.mute()}}else{this.CallCard.setMuted(t.muted);BX.removeClass(this.CallCard.elements.buttons.mute,"active");if(this.CallCard.isDesktop()&&this.CallCard.slave){BX.desktop.onCustomEvent(q.onUnMute,[])}else{this.CallCard.callbacks.unmute()}}i([])}},{key:"setHold",value:function e(t,i){this.used=true;if(!this.isCardActive()||!this.isExternalCall){i([this.getUndefinedCallCardError()]);return}if(this.CallCard.isHeld()===!!t.held){i([]);return}if(t.held){this.CallCard.setHeld(t.held);BX.addClass(this.CallCard.elements.buttons.hold,"active");if(this.CallCard.isDesktop()&&this.CallCard.slave){BX.desktop.onCustomEvent(q.onHold,[])}else{this.CallCard.callbacks.hold()}}else{this.CallCard.setHeld(t.held);BX.removeClass(this.CallCard.elements.buttons.hold,"active");if(this.CallCard.isDesktop()&&this.CallCard.slave){BX.desktop.onCustomEvent(q.onUnHold,[])}else{this.CallCard.callbacks.unhold()}}i([])}},{key:"startTimer",value:function e(t,i){this.used=true;if(!this.isCardActive()||!this.isExternalCall){i([this.getUndefinedCallCardError()]);return}this.showTimer();this.CallCard.startTimer()}},{key:"stopTimer",value:function e(t,i){this.used=true;if(!this.isCardActive()||!this.isExternalCall){i([this.getUndefinedCallCardError()]);return}this.CallCard.stopTimer()}},{key:"close",value:function e(t,i){this.used=true;if(!this.isCardActive()||!this.isExternalCall){i([this.getUndefinedCallCardError()]);return}this.CallCard.close();i([]);this.CallCard=false}},{key:"setCardTitle",value:function e(t,i){this.used=true;if(!this.isCardActive()||!this.isExternalCall){i([this.getUndefinedCallCardError()]);return}this.CallCard.setTitle(t.title);i([])}},{key:"setStatusText",value:function e(t,i){this.used=true;if(!this.isCardActive()||!this.isExternalCall){i([this.getUndefinedCallCardError()]);return}this.CallCard.setStatusText(t.statusText);i([])}},{key:"showTimer",value:function e(){if(!this.CallCard.elements.timer.visible){this.CallCard.sections.timer.visible=true;this.CallCard.elements.timer.style.display="";if(this.CallCard.isFolded()){this.CallCard.unfoldedElements.timer.style.display=""}}}},{key:"hideTimer",value:function e(){if(this.CallCard.sections.timer){this.CallCard.sections.timer.visible=false}if(this.CallCard.elements.timer){this.CallCard.elements.timer.style.display="none"}this.CallCard.initialTimestamp=0}},{key:"getUndefinedCallCardError",value:function e(){return m}}]);return e}();var C={setUiState:"DesktopCallCardSetUiState",setMute:"DesktopCallCardSetMute",setHold:"DesktopCallCardSetHold",getListUiState:"DesktopCallCardGetListUiState",setCardTitle:"DesktopCallCardSetCardTitle",setStatusText:"DesktopCallCardSetStatusText",close:"DesktopCallCardClose",startTimer:"DesktopCallCardStartTimer",stopTimer:"DesktopCallCardStopTimer"};var v={addCommentButtonClick:"DesktopCallCardAddCommentButtonClick",muteButtonClick:"DesktopCallCardMuteButtonClick",holdButtonClick:"DesktopCallCardHoldButtonClick",transferButtonClick:"DesktopCallCardTransferButtonClick",cancelTransferButtonClick:"DesktopCallCardCancelTransferButtonClick",completeTransferButtonClick:"DesktopCallCardCompleteTransferButtonClick",hangupButtonClick:"DesktopCallCardHangupButtonClick",nextButtonClick:"DesktopCallCardNextButtonClick",skipButtonClick:"DesktopCallCardSkipButtonClick",answerButtonClick:"DesktopCallCardAnswerButtonClick",entityChanged:"DesktopCallCardEntityChanged",qualityMeterClick:"DesktopCallCardQualityMeterClick",dialpadButtonClick:"DesktopCallCardDialpadButtonClick",makeCallButtonClick:"DesktopCallCardMakeCallButtonClick",notifyAdminButtonClick:"DesktopCallCardNotifyAdminButtonClick"};var b=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e.eventHandlers=[];return e}babelHelpers.createClass(t,[{key:"isCardActive",value:function e(){return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"isCardActive",this).call(this)||this.CallCard!==null}},{key:"initializePlacement",value:function e(){var t=BX.rest.AppLayout.initializePlacement("PAGE_BACKGROUND_WORKER");this.initializeInterfaceMethods(t);this.initializeInterfaceEvents(t);this.addEventHandlersForEventsFromCallCard()}},{key:"initializeInterface",value:function e(t){this.initializeInterfaceMethods(t);this.addTransmitEventHandlers()}},{key:"initializeInterfaceMethods",value:function e(t){var i=this;t.prototype.CallCardGetListUiStates=function(e,t){return i.getListUiStates(e,t)};t.prototype.CallCardSetMute=function(e,t){return i.transmitSetMute(e,t)};t.prototype.CallCardSetHold=function(e,t){return i.transmitSetHold(e,t)};t.prototype.CallCardSetUiState=function(e,t){return i.transmitSetUiState(e,t)};t.prototype.CallCardSetCardTitle=function(e,t){return i.transmitSetCardTitle(e,t)};t.prototype.CallCardSetStatusText=function(e,t){return i.transmitSetStatusText(e,t)};t.prototype.CallCardClose=function(e,t){return i.transmitClose(e,t)};t.prototype.CallCardStartTimer=function(e,t){return i.transmitStartTimer(e,t)};t.prototype.CallCardStopTimer=function(e,t){return i.transmitStopTimer(e,t)}}},{key:"emitInitializeEvent",value:function e(t){if(!this.isExternalCall){return}if(this.isCallCardPage()){BXDesktopSystem.BroadcastEvent("DesktopCallCardInitialized",[t]);return}BX.onCustomEvent(window,"BackgroundCallCard::initialized",[t])}},{key:"emitEvent",value:function e(t,i){if(!this.isExternalCall){return}if(this.isCallCardPage()){var s="DesktopCallCard"+(t[0].toUpperCase()+t.slice(1));BXDesktopSystem.BroadcastEvent(s,[i])}BX.onCustomEvent(window,"BackgroundCallCard::"+t,[i])}},{key:"removeDesktopEventHandlers",value:function e(){for(var t in this.getEvents()){this.removeCustomEvents("DesktopCallCard"+(t[0].toUpperCase()+t.slice(1)))}this.removeCustomEvents("DesktopCallCardInitialized");this.removeCustomEvents("DesktopCallCardCloseButtonClick")}},{key:"addTransmitEventHandlers",value:function e(){var t=this;this.addCustomEvent(C.getListUiState,(function(e,i){return t.onTransmitHandler(e,i,t.getListUiStates)})).addCustomEvent(C.setUiState,(function(e,i){return t.onTransmitHandler(e,i,t.getCallCardPlatformWorker().setUiState)})).addCustomEvent(C.setMute,(function(e,i){return t.onTransmitHandler(e,i,t.getCallCardPlatformWorker().setMute)})).addCustomEvent(C.setHold,(function(e,i){return t.onTransmitHandler(e,i,t.getCallCardPlatformWorker().setHold)})).addCustomEvent(C.setCardTitle,(function(e,i){return t.onTransmitHandler(e,i,t.getCallCardPlatformWorker().setCardTitle)})).addCustomEvent(C.setStatusText,(function(e,i){return t.onTransmitHandler(e,i,t.getCallCardPlatformWorker().setStatusText)})).addCustomEvent(C.close,(function(e,i){return t.onTransmitHandler(e,i,t.getCallCardPlatformWorker().close)})).addCustomEvent(C.startTimer,(function(e,i){return t.onTransmitHandler(e,i,t.getCallCardPlatformWorker().startTimer)})).addCustomEvent(C.stopTimer,(function(e,i){return t.onTransmitHandler(e,i,t.getCallCardPlatformWorker().stopTimer)}))}},{key:"onTransmitHandler",value:function e(t,i,s){if(this.isCorporatePortalPage()){return}this.used=true;i=typeof i==="function"?i:BX.DoNothing;s(t,i)}},{key:"transmitSetUiState",value:function e(t,i){if(!this.isCardActive()){i([this.getUndefinedCallCardError()]);return}if(!t.hasOwnProperty("uiState")||!F[t.uiState]){i([{result:"error",errorCode:"Invalid ui state"}]);return}BXDesktopSystem.BroadcastEvent(C.setUiState,[t,BX.DoNothing]);i([])}},{key:"transmitSetMute",value:function e(t,i){if(!this.isCardActive()){i([this.getUndefinedCallCardError()]);return}if(!t.hasOwnProperty("muted")){i({result:"error",errorCode:"missing field muted"});return}BXDesktopSystem.BroadcastEvent(C.setMute,[t,BX.DoNothing]);i([])}},{key:"transmitSetHold",value:function e(t,i){if(!this.isCardActive()){i([this.getUndefinedCallCardError()]);return}if(!t.hasOwnProperty("held")){i([{result:"error",errorCode:"missing field held"}])}BXDesktopSystem.BroadcastEvent(C.setHold,[t,BX.DoNothing]);i([])}},{key:"transmitStartTimer",value:function e(t,i){if(!this.isCardActive()){i([this.getUndefinedCallCardError()]);return}BXDesktopSystem.BroadcastEvent(C.startTimer,[t,BX.DoNothing]);i([])}},{key:"transmitStopTimer",value:function e(t,i){if(!this.isCardActive()){i([this.getUndefinedCallCardError()]);return}BXDesktopSystem.BroadcastEvent(C.stopTimer,[t,BX.DoNothing]);i([])}},{key:"transmitClose",value:function e(t,i){if(!this.isCardActive()){i([this.getUndefinedCallCardError()]);return}this.CallCard=null;BXDesktopSystem.BroadcastEvent(C.close,[t,BX.DoNothing]);i([])}},{key:"transmitSetCardTitle",value:function e(t,i){if(!this.isCardActive()){i([this.getUndefinedCallCardError()]);return}if(!t.hasOwnProperty("title")){i([{result:"error",errorCode:"missing field title"}]);return}BXDesktopSystem.BroadcastEvent(C.setCardTitle,[t,BX.DoNothing]);i([])}},{key:"transmitSetStatusText",value:function e(t,i){if(!this.isCardActive()){i([this.getUndefinedCallCardError()]);return}if(!t.hasOwnProperty("statusText")){i([{result:"error",errorCode:"missing field statusText"}]);return}BXDesktopSystem.BroadcastEvent(C.setStatusText,[t,BX.DoNothing]);i([])}},{key:"addEventHandlersForEventsFromCallCard",value:function e(){var t=this;if(!this.isCorporatePortalPage()){return}var i=function e(i){t.addCustomEvent(v[i],(function(e,t){BX.onCustomEvent(window,"BackgroundCallCard::"+i,[e,t])}))};for(var s in this.getEvents()){i(s)}this.addCustomEvent("DesktopCallCardInitialized",(function(e,i){if(!t.CallCard){t.CallCard=true}BX.onCustomEvent(window,"BackgroundCallCard::initialized",[e,i])}));this.addCustomEvent("DesktopCallCardCloseButtonClick",(function(e,i){t.CallCard=null;BX.onCustomEvent(window,"BackgroundCallCard::closeButtonClick",[e,i])}))}},{key:"addCustomEvent",value:function e(t,i){var s=function e(t){var s=[];for(var n in t.detail){s.push(t.detail[n])}i.apply(window,s)};if(!this.eventHandlers[t]){this.eventHandlers[t]=[]}this.eventHandlers[t].push(s);window.addEventListener(t,s);return this}},{key:"removeCustomEvents",value:function e(t){if(!this.eventHandlers[t]){return false}this.eventHandlers[t].forEach((function(e){return window.removeEventListener(t,e)}));this.eventHandlers[t]=[]}},{key:"isCallCardPage",value:function e(){return BXDesktopWindow.GetWindowId()!==BXDesktopSystem.GetMainWindow().GetWindowId()}},{key:"isCorporatePortalPage",value:function e(){return typeof BXDesktopSystem=="undefined"&&typeof BXDesktopWindow=="undefined"}},{key:"getCallCardWindow",value:function e(){return BXWindows.find((function(e){return e.name==="callWindow"}))}},{key:"getCallCardPlatformWorker",value:function e(){var t=this.getCallCardWindow();return t.PCW.backgroundWorker.platformWorker}}]);return t}(f);var g=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"initializePlacement",value:function e(){var t=BX.rest.AppLayout.initializePlacement("PAGE_BACKGROUND_WORKER");this.initializeInterface(t);this.initializeInterfaceEvents(t)}},{key:"initializeInterface",value:function e(t){var i=this;t.prototype.CallCardSetMute=function(e,t){return i.setMute(e,t)};t.prototype.CallCardSetHold=function(e,t){return i.setHold(e,t)};t.prototype.CallCardSetUiState=function(e,t){return i.setUiState(e,t)};t.prototype.CallCardGetListUiStates=function(e,t){return i.getListUiStates(e,t)};t.prototype.CallCardSetCardTitle=function(e,t){return i.setCardTitle(e,t)};t.prototype.CallCardSetStatusText=function(e,t){return i.setStatusText(e,t)};t.prototype.CallCardClose=function(e,t){return i.close(e,t)};t.prototype.CallCardStartTimer=function(e,t){return i.startTimer(e,t)};t.prototype.CallCardStopTimer=function(e,t){return i.stopTimer(e,t)}}},{key:"emitEvent",value:function e(t,i){if(!this.isExternalCall){return}BX.onCustomEvent(window,"BackgroundCallCard::"+t,[i])}},{key:"emitInitializeEvent",value:function e(t){if(!this.isExternalCall){return}BX.onCustomEvent(window,"BackgroundCallCard::initialized",[t])}}]);return t}(f);var y=p;var k=function(){function e(){babelHelpers.classCallCheck(this,e);this.initializePlacement()}babelHelpers.createClass(e,[{key:"setCallCard",value:function e(t){this.platformWorker.CallCard=t}},{key:"initializePlacement",value:function e(){if(this.isDesktop()){this.platformWorker=new b}else{this.platformWorker=new g}this.platformWorker.initializePlacement()}},{key:"emitEvent",value:function e(t,i){this.platformWorker.emitEvent(t,i)}},{key:"removeDesktopEventHandlers",value:function e(){this.platformWorker.removeDesktopEventHandlers()}},{key:"isDesktop",value:function e(){return typeof BXDesktopSystem!=="undefined"}},{key:"isUsed",value:function e(){return this.platformWorker.isUsed()}},{key:"isActiveIntoCurrentCall",value:function e(){return this.isExternalCall&&this.isUsed()}},{key:"setExternalCall",value:function e(t){this.platformWorker.setIsExternalCall(t)}}]);return e}();var I=function e(){};var w=function(){function e(t){babelHelpers.classCallCheck(this,e);this.node=t.node;this.currentForm=null;this.callbacks={onFormLoad:s.Type.isFunction(t.onFormLoad)?t.onFormLoad:I,onFormUnLoad:s.Type.isFunction(t.onFormUnLoad)?t.onFormUnLoad:I,onFormSend:s.Type.isFunction(t.onFormSend)?t.onFormSend:I}}babelHelpers.createClass(e,[{key:"load",value:function e(t){var i=this.getFormData(t);window.Bitrix24FormLoader.load(i);this.currentForm=i}},{key:"unload",value:function e(){if(this.currentForm){window.Bitrix24FormLoader.unload(this.currentForm);this.currentForm=null}}},{key:"getFormData",value:function e(t){return{id:t.id,sec:t.secCode,type:"inline",lang:"ru",ref:window.location.href,node:this.node,handlers:{load:this._onFormLoad.bind(this),unload:this._onFormUnLoad.bind(this),send:this.onFormSend.bind(this)},options:{borders:false,logo:false}}}},{key:"_onFormLoad",value:function e(t){this.callbacks.onFormLoad(t)}},{key:"_onFormUnLoad",value:function e(t){this.callbacks.onFormUnLoad(t)}},{key:"onFormSend",value:function e(t){this.callbacks.onFormSend(t)}}]);return e}();function T(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=E(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var s=0;var n=function e(){};return{s:n,n:function t(){if(s>=e.length)return{done:true};return{done:false,value:e[s++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var l=true,a=false,o;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();l=t.done;return t},e:function e(t){a=true;o=t},f:function e(){try{if(!l&&i["return"]!=null)i["return"]()}finally{if(a)throw o}}}}function E(e,t){if(!e)return;if(typeof e==="string")return S(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return S(e,t)}function S(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,s=new Array(t);i<t;i++)s[i]=e[i];return s}var L=function(){function e(t){babelHelpers.classCallCheck(this,e);this.node=t.node;this.id=t.id;this.isDesktop=t.isDesktop;this.entityType="";this.statuses=new Map;this.elements={};this.currentStatusId=t.callListStatusId||"IN_WORK";this.currentItemIndex=t.itemIndex||0;this.callingStatusId=null;this.callingItemIndex=null;this.selectionLocked=false;this.callbacks={onError:s.Type.isFunction(t.onError)?t.onError:r,onSelectedItem:s.Type.isFunction(t.onSelectedItem)?t.onSelectedItem:r};this.showLimit=10;this.showDelta=10}babelHelpers.createClass(e,[{key:"init",value:function e(t){var i=this;if(!s.Type.isFunction(t)){t=r}this.load((function(){var e=i.statuses.get(i.currentStatusId);if(e&&e.ITEMS.length>0){i.update();i.selectItem(i.currentStatusId,i.currentItemIndex);t()}else{BX.debug("empty call list. don't know what to do")}}))}},{key:"reinit",value:function e(t){if(s.Type.isDomNode(t.node)){this.node=t.node}this.update();this.selectItem(this.currentStatusId,this.currentItemIndex);if(this.callingStatusId!==null&&this.callingItemIndex!==null){this.setCallingElement(this.callingStatusId,this.callingItemIndex)}}},{key:"load",value:function t(i){var n=this;var l={sessid:BX.bitrix_sessid(),ajax_action:"GET_CALL_LIST",callListId:this.id};BX.ajax({url:e.getAjaxUrl(),method:"POST",dataType:"json",data:l,onsuccess:function e(t){if(!t.ERROR){if(s.Type.isArray(t.STATUSES)){t.STATUSES.forEach((function(e){e.ITEMS=[];n.statuses.set(e.STATUS_ID,e)}));t.ITEMS.forEach((function(e){var t=n.statuses.get(e.STATUS_ID);if(t){t.ITEMS.push(e)}}))}n.entityType=t.ENTITY_TYPE;var l=n.statuses.get(n.currentStatusId);if(l&&l.ITEMS.length===0){n.currentStatusId=n.getNonEmptyStatusId();n.currentItemIndex=0}i()}else{console.log(t)}}})}},{key:"selectItem",value:function e(t,i){var s=this.statuses.get(this.currentStatusId).ITEMS[this.currentItemIndex]._node;BX.removeClass(s,"im-phone-call-list-customer-block-active");if(this.itemActionMenu){this.itemActionMenu.close()}this.currentStatusId=t;this.currentItemIndex=i;s=this.statuses.get(this.currentStatusId).ITEMS[this.currentItemIndex]._node;BX.addClass(s,"im-phone-call-list-customer-block-active");var n=this.statuses.get(t).ITEMS[i];if((this.entityType=="DEAL"||this.entityType=="QUOTE"||this.entityType=="INVOICE")&&n.ASSOCIATED_ENTITY){this.callbacks.onSelectedItem({type:n.ASSOCIATED_ENTITY.TYPE,id:n.ASSOCIATED_ENTITY.ID,bindings:[{type:this.entityType,id:n.ELEMENT_ID}],phones:n.ASSOCIATED_ENTITY.PHONES,statusId:t,index:i})}else{this.callbacks.onSelectedItem({type:this.entityType,id:n.ELEMENT_ID,phones:n.PHONES,statusId:t,index:i})}}},{key:"moveToNextItem",value:function e(){var t=this.currentItemIndex+1;if(t>=this.statuses.get(this.currentStatusId).ITEMS.length){t=0}this.selectItem(this.currentStatusId,t)}},{key:"setCallingElement",value:function e(t,i){this.callingStatusId=t;this.callingItemIndex=i;var s=this.statuses.get(this.callingStatusId).ITEMS[this.callingItemIndex]._node;BX.addClass(s,"im-phone-call-list-customer-block-calling");this.selectionLocked=true}},{key:"resetCallingElement",value:function e(){if(this.callingStatusId===null||this.callingItemIndex===null){return}var t=this.statuses.get(this.callingStatusId).ITEMS[this.callingItemIndex]._node;BX.removeClass(t,"im-phone-call-list-customer-block-calling");this.callingStatusId=null;this.callingItemIndex=null;this.selectionLocked=false}},{key:"update",value:function e(){s.Dom.clean(this.node);this.node.append(this.render())}},{key:"render",value:function e(){return s.Dom.create("div",{props:{className:"im-phone-call-list-container"},children:this.renderStatusBlocks()})}},{key:"renderStatusBlocks",value:function e(){var t=[];var i=T(this.statuses),s;try{for(i.s();!(s=i.n()).done;){var n=babelHelpers.slicedToArray(s.value,2),l=n[0],a=n[1];if(!a||a.ITEMS.length===0){continue}a._node=this.renderStatusBlock(a);t.push(a._node)}}catch(e){i.e(e)}finally{i.f()}return t}},{key:"renderCallListItems",value:function e(t){var i=[];var n=this.statuses.get(t);if(n._shownCount>0){if(n._shownCount>n.ITEMS.length){n._shownCount=n.ITEMS.length}}else{n._shownCount=Math.min(this.showLimit,n.ITEMS.length)}for(var l=0;l<n._shownCount;l++){i.push(this.renderCallListItem(n.ITEMS[l],t,l))}if(n.ITEMS.length>n._shownCount){n._showMoreNode=s.Dom.create("div",{props:{className:"im-phone-call-list-show-more-wrap"},children:[s.Dom.create("span",{props:{className:"im-phone-call-list-show-more-button"},dataset:{statusId:t},text:s.Loc.getMessage("IM_PHONE_CALL_LIST_MORE").replace("#COUNT#",n.ITEMS.length-n._shownCount),events:{click:this.onShowMoreClick.bind(this)}})]});i.push(n._showMoreNode)}else{n._showMoreNode=null}return i}},{key:"renderCallListItem",value:function e(t,i,n){var l=this;var a=this.statuses.get(i).NAME;var o="";if(s.Type.isArray(t.PHONES)){t.PHONES.forEach((function(e,t){if(t!==0){o+="; "}o+=s.Text.encode(e.VALUE)}))}t._node=s.Dom.create("div",{props:{className:this.currentStatusId==i&&this.currentItemIndex==n?"im-phone-call-list-customer-block im-phone-call-list-customer-block-active":"im-phone-call-list-customer-block"},children:[s.Dom.create("div",{props:{className:"im-phone-call-list-customer-block-action"},children:[s.Dom.create("span",{text:a})],events:{click:function e(i){i.preventDefault();if(l.itemActionMenu){l.itemActionMenu.close()}else{l.showItemMenu(t,i.target)}}}}),s.Dom.create("div",{props:{className:"im-phone-call-list-item-customer-name"+(t.ASSOCIATED_ENTITY?" im-phone-call-list-connection-line":"")},children:[s.Dom.create("a",{attrs:{href:t.EDIT_URL,target:"_blank"},props:{className:"im-phone-call-list-item-customer-link"},text:t.NAME,events:{click:function e(i){i.preventDefault();window.open(t.EDIT_URL)}}})]}),t.POST?s.Dom.create("div",{props:{className:"im-phone-call-list-item-customer-info"},text:t.POST}):null,t.COMPANY_TITLE?s.Dom.create("div",{props:{className:"im-phone-call-list-item-customer-info"},text:t.COMPANY_TITLE}):null,o?s.Dom.create("div",{props:{className:"im-phone-call-list-item-customer-info"},text:o}):null,t.ASSOCIATED_ENTITY?this.renderAssociatedEntity(t.ASSOCIATED_ENTITY):null],events:{click:function e(){if(!l.selectionLocked&&(l.currentStatusId!=t.STATUS_ID||l.currentItemIndex!=n)){l.selectItem(t.STATUS_ID,n)}}}});return t._node}},{key:"renderAssociatedEntity",value:function e(t){var i="";if(s.Type.isArray(t.PHONES)){t.PHONES.forEach((function(e,t){if(t!==0){i+="; "}i+=s.Text.encode(e.VALUE)}))}return s.Dom.create("div",{props:{className:"im-phone-call-list-item-customer-entity im-phone-call-list-connection-line-item"},children:[s.Dom.create("a",{attrs:{href:t.EDIT_URL,target:"_blank"},props:{className:"im-phone-call-list-item-customer-link"},text:t.NAME,events:{click:function e(i){i.preventDefault();window.open(t.EDIT_URL)}}}),s.Dom.create("div",{props:{className:"im-phone-call-list-item-customer-info"},text:t.POST}),s.Dom.create("div",{props:{className:"im-phone-call-list-item-customer-info"},text:t.COMPANY_TITLE}),i?s.Dom.create("div",{props:{className:"im-phone-call-list-item-customer-info"},text:i}):null]})}},{key:"onShowMoreClick",value:function e(t){var i=t.target.dataset.statusId;var s=this.statuses.get(i);s._shownCount+=this.showDelta;if(s._shownCount>s.ITEMS.length){s._shownCount=s.ITEMS.length}var n=this.renderStatusBlock(s);s._node.parentNode.replaceChild(n,s._node);s._node=n}},{key:"showItemMenu",value:function e(t,i){var n=this;var a=[];var r;var c=T(this.statuses),h;try{for(c.s();!(h=c.n()).done;){var u=babelHelpers.slicedToArray(h.value,2),d=u[0],p=u[1];r={id:"setStatus_"+d,text:p.NAME,onclick:this.actionMenuItemClickHandler(t.ELEMENT_ID,d).bind(this)};a.push(r)}}catch(e){c.e(e)}finally{c.f()}a.push({id:"callListItemActionMenu_delimiter",delimiter:true});a.push({id:"defer15min",text:s.Loc.getMessage("IM_PHONE_CALL_VIEW_CALL_LIST_DEFER_15_MIN"),onclick:function e(){n.itemActionMenu.close();n.setElementRank(t.ELEMENT_ID,t.RANK+35)}});a.push({id:"defer1hour",text:s.Loc.getMessage("IM_PHONE_CALL_VIEW_CALL_LIST_DEFER_HOUR"),onclick:function e(){n.itemActionMenu.close();n.setElementRank(t.ELEMENT_ID,t.RANK+185)}});a.push({id:"moveToEnd",text:s.Loc.getMessage("IM_PHONE_CALL_VIEW_CALL_LIST_TO_END"),onclick:function e(){n.itemActionMenu.close();n.setElementRank(t.ELEMENT_ID,t.RANK+5100)}});this.itemActionMenu=new l.Menu("callListItemActionMenu",i,a,{autoHide:true,offsetTop:0,offsetLeft:0,angle:{position:"top"},zIndex:o+200,events:{onPopupClose:function e(){return n.itemActionMenu.destroy()},onPopupDestroy:function e(){return n.itemActionMenu=null}}});this.itemActionMenu.show()}},{key:"actionMenuItemClickHandler",value:function e(t,i){var s=this;return function(){s.itemActionMenu.close();s.setElementStatus(t,i)}}},{key:"setElementRank",value:function e(t,i){var s=this;this.executeItemAction({action:"SET_ELEMENT_RANK",parameters:{callListId:this.id,elementId:t,rank:i},successCallback:function e(t){if(t.ITEMS){s.repopulateItems(t.ITEMS);s.update()}}})}},{key:"setElementStatus",value:function e(t,i){var s=this;this.executeItemAction({action:"SET_ELEMENT_STATUS",parameters:{callListId:this.id,elementId:t,statusId:i},successCallback:function e(t){s.repopulateItems(t.ITEMS);s.update()}})}},{key:"setWebformResult",value:function e(t,i){this.executeItemAction({action:"SET_WEBFORM_RESULT",parameters:{callListId:this.id,elementId:t,webformResultId:i}})}},{key:"executeItemAction",value:function t(i){if(!s.Type.isPlainObject(i)){i={}}if(!s.Type.isFunction(i.successCallback)){i.successCallback=r}var n={sessid:BX.bitrix_sessid(),ajax_action:i.action,parameters:i.parameters};BX.ajax({url:e.getAjaxUrl(),method:"POST",dataType:"json",data:n,onsuccess:function e(t){return i.successCallback(t)}})}},{key:"repopulateItems",value:function e(t){var i=this;var s=T(this.statuses),n;try{for(s.s();!(n=s.n()).done;){var l=babelHelpers.slicedToArray(n.value,2),a=l[0],o=l[1];o.ITEMS=[]}}catch(e){s.e(e)}finally{s.f()}t.forEach((function(e){return i.statuses.get(e.STATUS_ID).ITEMS.push(e)}));if(this.statuses.get(this.currentStatusId).ITEMS.length===0){this.currentStatusId=this.getNonEmptyStatusId();this.currentItemIndex=0}else{if(this.currentItemIndex>=this.statuses.get(this.currentStatusId).ITEMS.length){this.currentItemIndex=0}}this.selectItem(this.currentStatusId,this.currentItemIndex)}},{key:"getNonEmptyStatusId",value:function e(){var t=false;var i=T(this.statuses),s;try{for(i.s();!(s=i.n()).done;){var n=babelHelpers.slicedToArray(s.value,2),l=n[0],a=n[1];if(a.ITEMS.length>0){t=l;break}}}catch(e){i.e(e)}finally{i.f()}return t}},{key:"getCurrentElement",value:function e(){return this.statuses.get(this.currentStatusId).ITEMS[this.currentItemIndex]}},{key:"getStatusTitle",value:function e(t){var i=this.statuses.get(t).ITEMS.length;return s.Text.encode(this.statuses.get(t).NAME)+" ("+i.toString()+")"}},{key:"renderStatusBlock",value:function e(t){var i;var n;var l;var a=t.STATUS_ID;if(!t.hasOwnProperty("_folded")){t._folded=false}var o="im-phone-call-list-block";if(t.CLASS!=""){o=o+" "+t.CLASS}return s.Dom.create("div",{props:{className:o},children:[s.Dom.create("div",{props:{className:"im-phone-call-list-block-title"+(t._folded?"":" active")},children:[s.Dom.create("span",{text:this.getStatusTitle(a)}),s.Dom.create("div",{props:{className:"im-phone-call-list-block-title-arrow"}})],events:{click:function e(s){s.preventDefault();clearTimeout(i);t._folded=!t._folded;if(t._folded){BX.removeClass(s.target,"active");n.style.height=l.clientHeight.toString()+"px";i=setTimeout((function(){n.style.height=0}),50)}else{BX.addClass(s.target,"active");n.style.height=0;i=setTimeout((function(){n.style.height=l.clientHeight+"px"}),50)}}}}),n=s.Dom.create("div",{props:{className:"im-phone-call-list-items-block"},children:[l=s.Dom.create("div",{props:{className:"im-phone-call-list-items-measuring"},children:this.renderCallListItems(a)})],events:{transitionend:function e(){if(!t._folded){n.style.removeProperty("height")}}}})]})}}],[{key:"getAjaxUrl",value:function e(){return this.isDesktop?"/desktop_app/call_list.ajax.php":"/bitrix/components/bitrix/crm.activity.call_list/ajax.php"}}]);return e}();var _={};var D={onUnfold:"onUnfold"};var N=function(e){babelHelpers.inherits(t,e);function t(e){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));i.setEventNamespace("BX.VoxImplant.FoldedCallView");i.subscribeFromOptions(e.events);i.currentItem={};i.callListParams={id:0,webformId:0,webformSecCode:"",itemIndex:0,itemStatusId:"",statusList:{},entityType:""};i.node=null;i.elements={avatar:null,callButton:null,nextButton:null,unfoldButton:null};i._lsKey="bx-im-folded-call-view-data";i._lsTtl=86400;i.init();return i}babelHelpers.createClass(t,[{key:"init",value:function e(){this.load();if(this.callListParams.id>0){this.currentItem=this.callListParams.statusList[this.callListParams.itemStatusId].ITEMS[this.callListParams.itemIndex];this.render()}}},{key:"load",value:function e(){var t=BX.localStorage.get(this._lsKey);if(s.Type.isPlainObject(t)){this.callListParams=t}}},{key:"destroy",value:function e(){if(this.node){s.Dom.remove(this.node);this.node=null}BX.localStorage.remove(this._lsKey)}},{key:"store",value:function e(){BX.localStorage.set(this._lsKey,this.callListParams,this._lsTtl)}},{key:"fold",value:function e(t,i){i=i===true;this.callListParams.id=t.callListId;this.callListParams.webformId=t.webformId;this.callListParams.webformSecCode=t.webformSecCode;this.callListParams.itemIndex=t.currentItemIndex;this.callListParams.itemStatusId=t.currentItemStatusId;this.callListParams.statusList=Object.fromEntries(t.statusList);this.callListParams.entityType=t.entityType;this.currentItem=this.callListParams.statusList[this.callListParams.itemStatusId].ITEMS[this.callListParams.itemIndex];this.store();this.render(i)}},{key:"unfold",value:function e(t){var i=this;s.Dom.addClass(this.node,"im-phone-folded-call-view-unfold");this.node.addEventListener("animationend",(function(){if(i.node){s.Dom.remove(i.node);i.node=null}BX.localStorage.remove(i._lsKey);if(i.callListParams.id===0){return false}var e={};if(i.callListParams.webformId>0&&i.callListParams.webformSecCode!==""){e.webformId=i.callListParams.webformId;e.webformSecCode=i.callListParams.webformSecCode}e.callListStatusId=i.callListParams.itemStatusId;e.callListItemIndex=i.callListParams.itemIndex;e.makeCall=t;i.emit(D.onUnfold,{callListId:i.callListParams.id,callListParams:e})}))}},{key:"moveToNext",value:function e(){this.callListParams.itemIndex++;if(this.callListParams.itemIndex>=this.callListParams.statusList[this.callListParams.itemStatusId].ITEMS.length){this.callListParams.itemIndex=0}this.currentItem=this.callListParams.statusList[this.callListParams.itemStatusId].ITEMS[this.callListParams.itemIndex];this.store();this.render()}},{key:"render",value:function e(t){t=t===true;if(this.node===null){this.node=s.Dom.create("div",{props:{id:"im-phone-folded-call-view",className:"im-phone-call-wrapper im-phone-call-wrapper-fixed im-phone-call-panel"},events:{dblclick:this._onViewDblClick.bind(this)}});document.body.appendChild(this.node)}else{s.Dom.clean(this.node)}this.node.appendChild(s.Dom.create("div",{props:{className:"im-phone-call-wrapper-fixed-left"},style:t?{bottom:"-90px"}:{},children:[s.Dom.create("div",{props:{className:"im-phone-call-wrapper-fixed-user"},children:[s.Dom.create("div",{props:{className:"im-phone-call-wrapper-fixed-user-image"},children:[this.elements.avatar=s.Dom.create("div",{props:{className:"im-phone-call-wrapper-fixed-user-image-item"}})]}),s.Dom.create("div",{props:{className:"im-phone-call-wrapper-fixed-user-info"},children:this.renderUserInfo()})]})]}));this.node.appendChild(s.Dom.create("div",{props:{className:"im-phone-call-wrapper-fixed-right"},children:[s.Dom.create("div",{props:{className:"im-phone-call-wrapper-fixed-btn-container"},children:[this.elements.callButton=s.Dom.create("span",{props:{className:"im-phone-call-btn im-phone-call-btn-green"},text:s.Loc.getMessage("IM_PHONE_CALL_VIEW_FOLDED_BUTTON_CALL"),events:{click:this._onDialButtonClick.bind(this)}}),this.elements.nextButton=s.Dom.create("span",{props:{className:"im-phone-call-btn im-phone-call-btn-gray im-phone-call-btn-arrow"},text:s.Loc.getMessage("IM_PHONE_CALL_VIEW_FOLDED_BUTTON_NEXT"),events:{click:this._onNextButtonClick.bind(this)}})]})]}));this.node.appendChild(s.Dom.create("div",{props:{className:"im-phone-btn-block"},children:[this.elements.unfoldButton=s.Dom.create("div",{props:{className:"im-phone-btn-arrow"},children:[s.Dom.create("div",{props:{className:"im-phone-btn-arrow-inner"},text:s.Loc.getMessage("IM_PHONE_CALL_VIEW_UNFOLD")})],events:{click:this._onUnfoldButtonClick.bind(this)}})]}));if(_[this.currentItem.ELEMENT_ID]){this.elements.avatar.style.backgroundImage="url('"+s.Text.encode(_[this.currentItem.ELEMENT_ID])+"')"}else{this.loadAvatar(this.callListParams.entityType,this.currentItem.ELEMENT_ID)}if(t){s.Dom.addClass(this.node,"im-phone-folded-call-view-fold");this.node.addEventListener("animationend",(function(){BX.removeClass(this.node,"im-phone-folded-call-view-fold")}))}}},{key:"renderUserInfo",value:function e(){var t=[];t.push(s.Dom.create("div",{props:{className:"im-phone-call-wrapper-fixed-user-name"},text:this.currentItem.NAME}));if(this.currentItem.POST){t.push(s.Dom.create("div",{props:{className:"im-phone-call-wrapper-fixed-user-item"},text:this.currentItem.POST}))}if(this.currentItem.COMPANY_TITLE){t.push(s.Dom.create("div",{props:{className:"im-phone-call-wrapper-fixed-user-item"},text:this.currentItem.COMPANY_TITLE}))}return t}},{key:"loadAvatar",value:function e(t,i){var n=this;BX.ajax({url:L.getAjaxUrl(),method:"POST",dataType:"json",data:{sessid:BX.bitrix_sessid(),ajax_action:"GET_AVATAR",entityType:t,entityId:i},onsuccess:function e(t){if(!t.avatar){return}_[i]=t.avatar;if(n.currentItem.ELEMENT_ID==i&&n.elements.avatar){n.elements.avatar.style.backgroundImage="url('"+s.Text.encode(t.avatar)+"')"}}})}},{key:"_onViewDblClick",value:function e(t){t.preventDefault();this.unfold(false)}},{key:"_onDialButtonClick",value:function e(t){t.preventDefault();this.unfold(true)}},{key:"_onNextButtonClick",value:function e(t){t.preventDefault();this.moveToNext()}},{key:"_onUnfoldButtonClick",value:function e(t){t.preventDefault();this.unfold(false)}}]);return t}(i.EventEmitter);babelHelpers.defineProperty(N,"Events",D);function M(e,t){A(e,t);t.add(e)}function A(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function B(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var P={iframe:39};var x=new WeakSet;var V=function(){function e(t){babelHelpers.classCallCheck(this,e);M(this,x);this.parentPhoneCallView=t.parentPhoneCallView;this.closable=t.closable;this.title=t.title||"";this.window=null}babelHelpers.createClass(e,[{key:"openCallWindow",value:function e(t,i,s){var l=this;s=s||{};if(s.minSettingsWidth){this.minSettingsWidth=s.minSettingsWidth}if(s.minSettingsHeight){this.minSettingsHeight=s.minSettingsHeight}s.resizable=s.resizable===true;n.DesktopApi.createWindow("callWindow",(function(e){e.SetProperty("clientSize",{Width:s.width,Height:s.height});e.SetProperty("resizable",s.resizable);if(s.resizable&&s.hasOwnProperty("minWidth")&&s.hasOwnProperty("minHeight")){e.SetProperty("minClientSize",{Width:s.minWidth,Height:s.minHeight})}e.SetProperty("title",l.title);e.SetProperty("closable",true);var n=B(l,x,H).call(l,t,i,{});e.ExecuteCommand("html.load",n);l.window=e}))}},{key:"setClosable",value:function e(t){this.closable=t===true;if(this.window){this.window.SetProperty("closable",this.closable)}}},{key:"setTitle",value:function e(t){this.title=t;if(this.window){this.window.SetProperty("title",t)}}},{key:"addCustomEvent",value:function e(t,i){BX.desktop.addCustomEvent(t,i)}},{key:"onCustomEvent",value:function e(t,i,s){BX.desktop.onCustomEvent(t,i,s)}},{key:"resize",value:function e(t,i){BXDesktopWindow.SetProperty("clientSize",{Width:t,Height:i})}},{key:"setResizable",value:function e(t){t=t===true;BXDesktopWindow.SetProperty("resizable",t)}},{key:"setMinSize",value:function e(t,i){BXDesktopWindow.SetProperty("minClientSize",{Width:t,Height:i})}},{key:"setWindowPosition",value:function e(t){BXDesktopWindow.SetProperty("position",t)}},{key:"center",value:function e(){BXDesktopWindow.ExecuteCommand("center")}},{key:"getVersion",value:function e(t){if(typeof BXDesktopSystem=="undefined"){return 0}if(!this.clientVersion){this.clientVersion=BXDesktopSystem.GetProperty("versionParts")}return t?this.clientVersion.join("."):this.clientVersion[3]}},{key:"isFeatureSupported",value:function e(t){if(!P.hasOwnProperty(t)){return false}return this.getVersion()>=P[t]}}]);return e}();function H(e,t,i,n){e=e||"";t=t||"";n=n||"";if(this.htmlWrapperHead==null){this.htmlWrapperHead=document.head.outerHTML.replace(/BX\.PULL\.start\([^)]*\);/g,"")}if(s.Type.isDomNode(e)){e=e.outerHTML}if(s.Type.isDomNode(t)){t=t.outerHTML}if(s.Type.isStringFilled(t)){t="<script>\n\t\t\t\t\tBX.ready(function() {\n\t\t\t\t\t\t".concat(t,"\n\t\t\t\t\t});\n\t\t\t\t<\/script>")}var l="";if(i){l="\n\t\t\t\t<script>\n\t\t\t\t\tBX.ready(function() {\n\t\t\t\t\t\t\tconst backgroundWorker = new BX.Voximplant.BackgroundWorker();\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\twindow.PCW = new BX.Voximplant.PhoneCallView({\n\t\t\t\t\t\t\t\tisDesktop: true,\n\t\t\t\t\t\t\t\tslave: true, \n\t\t\t\t\t\t\t\tskipOnResize: true, \n\t\t\t\t\t\t\t\tcallId: '".concat(this.parentPhoneCallView.callId,"',\n\t\t\t\t\t\t\t\tuiState: ").concat(this.parentPhoneCallView._uiState,",\n\t\t\t\t\t\t\t\tphoneNumber: '").concat(this.parentPhoneCallView.phoneNumber,"',\n\t\t\t\t\t\t\t\tcompanyPhoneNumber: '").concat(this.parentPhoneCallView.companyPhoneNumber,"',\n\t\t\t\t\t\t\t\tdirection: '").concat(this.parentPhoneCallView.direction,"',\n\t\t\t\t\t\t\t\tfromUserId: '").concat(this.parentPhoneCallView.fromUserId,"',\n\t\t\t\t\t\t\t\ttoUserId: '").concat(this.parentPhoneCallView.toUserId,"',\n\t\t\t\t\t\t\t\tcrm: ").concat(this.parentPhoneCallView.crm,",\n\t\t\t\t\t\t\t\thasSipPhone: ").concat(this.parentPhoneCallView.hasSipPhone,",\n\t\t\t\t\t\t\t\tdeviceCall: ").concat(this.parentPhoneCallView.deviceCall,",\n\t\t\t\t\t\t\t\ttransfer: ").concat(this.parentPhoneCallView.transfer,",\n\t\t\t\t\t\t\t\tcrmEntityType: '").concat(this.parentPhoneCallView.crmEntityType,"',\n\t\t\t\t\t\t\t\tcrmEntityId: '").concat(this.parentPhoneCallView.crmEntityId,"',\n\t\t\t\t\t\t\t\tcrmActivityId: '").concat(this.parentPhoneCallView.crmActivityId,"',\n\t\t\t\t\t\t\t\tcrmActivityEditUrl: '").concat(this.parentPhoneCallView.crmActivityEditUrl,"',\n\t\t\t\t\t\t\t\tcallListId: ").concat(this.parentPhoneCallView.callListId,",\n\t\t\t\t\t\t\t\tcallListStatusId: '").concat(this.parentPhoneCallView.callListStatusId,"',\n\t\t\t\t\t\t\t\tcallListItemIndex: ").concat(this.parentPhoneCallView.callListItemIndex,",\n\t\t\t\t\t\t\t\tconfig: ").concat(this.parentPhoneCallView.config?JSON.stringify(this.parentPhoneCallView.config):"{}",",\n\t\t\t\t\t\t\t\tportalCall: ").concat(this.parentPhoneCallView.portalCall?"true":"false",",\n\t\t\t\t\t\t\t\tportalCallData: ").concat(this.parentPhoneCallView.portalCallData?JSON.stringify(this.parentPhoneCallView.portalCallData):"{}",",\n\t\t\t\t\t\t\t\tportalCallUserId: ").concat(this.parentPhoneCallView.portalCallUserId,",\n\t\t\t\t\t\t\t\twebformId: ").concat(this.parentPhoneCallView.webformId,",\n\t\t\t\t\t\t\t\twebformSecCode: '").concat(this.parentPhoneCallView.webformSecCode,"',\n\t\t\t\t\t\t\t\tbackgroundWorker: backgroundWorker,\n\t\t\t\t\t\t\t\trestApps: ").concat(this.parentPhoneCallView.restApps?JSON.stringify(this.parentPhoneCallView.restApps):"[]",",\n\t\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t<\/script>")}return'\n\t\t\t<!DOCTYPE html>\n\t\t\t<html lang="'.concat(document.documentElement.lang,'">\n\t\t\t\t').concat(this.htmlWrapperHead,'\n\t\t\t\t<body class="im-desktop im-desktop-popup ').concat(n,'">\n\t\t\t\t\t<div id="placeholder-messanger">').concat(e,"</div>\n\t\t\t\t\t").concat(l,"\n\t\t\t\t\t").concat(t,"\n\t\t\t\t</body>\n\t\t\t</html>\n\t\t")}function O(e,t,i){U(e,t);t.set(e,i)}function U(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var R={incoming:"incoming",outgoing:"outgoing",callback:"callback"};var F={incoming:1,transferIncoming:2,outgoing:3,connectingIncoming:4,connectingOutgoing:5,connected:6,transferring:7,transferFailed:8,transferConnected:9,idle:10,error:11,moneyError:12,sipPhoneError:13,redial:14,externalCard:15};var W={idle:"idle",connecting:"connecting",connected:"connected"};var X={connect:"connect",error:"error",offline:"offline",online:"online",wait:"wait"};var z={centered:"centered",spaced:"spaced"};var G={simple:"simple",crm:"crm"};var j={simple:{width:550,height:492},crm:{width:550,height:650}};var Y={height:"im-phone-call-view-height",width:"im-phone-call-view-width",callView:"bx-vox-call-view",callInited:"viInitedCall",externalCall:"viExternalCard",currentCall:"bx-vox-current-call"};var q={setTitle:"phoneCallViewSetTitle",setStatus:"phoneCallViewSetStatus",setUiState:"phoneCallViewSetUiState",setDeviceCall:"phoneCallViewSetDeviceCall",setCrmEntity:"phoneCallViewSetCrmEntity",setPortalCall:"phoneCallViewSetPortalCall",setPortalCallUserId:"phoneCallViewSetPortalCallUserId",setPortalCallQueueName:"phoneCallViewSetPortalCallQueueName",setPortalCallData:"phoneCallViewSetPortalCallData",setConfig:"phoneCallViewSetConfig",setCallState:"phoneCallViewSetCallState",reloadCrmCard:"phoneCallViewReloadCrmCard",setCallId:"phoneCallViewSetCallId",setLineNumber:"phoneCallViewSetLineNumber",setPhoneNumber:"phoneCallViewSetPhoneNumber",setCompanyPhoneNumber:"phoneCallViewSetCompanyPhoneNumber",setTransfer:"phoneCallViewSetTransfer",closeWindow:"phoneCallViewCloseWindow",onHold:"phoneCallViewOnHold",onUnHold:"phoneCallViewOnUnHold",onMute:"phoneCallViewOnMute",onUnMute:"phoneCallViewOnUnMute",onMakeCall:"phoneCallViewOnMakeCall",onCallListMakeCall:"phoneCallViewOnCallListMakeCall",onAnswer:"phoneCallViewOnAnswer",onSkip:"phoneCallViewOnSkip",onHangup:"phoneCallViewOnHangup",onClose:"phoneCallViewOnClose",onStartTransfer:"phoneCallViewOnStartTransfer",onCompleteTransfer:"phoneCallViewOnCompleteTransfer",onCancelTransfer:"phoneCallViewOnCancelTransfer",onBeforeUnload:"phoneCallViewOnBeforeUnload",onSwitchDevice:"phoneCallViewOnSwitchDevice",onQualityGraded:"phoneCallViewOnQualityGraded",onDialpadButtonClicked:"phoneCallViewOnDialpadButtonClicked",onCommentShown:"phoneCallViewOnCommentShown",onSaveComment:"phoneCallViewOnSaveComment",onSetAutoClose:"phoneCallViewOnSetAutoClose"};var K="/bitrix/js/im/images/blank.gif";var Q=new WeakMap;var J=new WeakMap;var Z=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);O(this,Q,{writable:true,value:function e(t){console.warn("#onExternalEvent",t);return;t=s.Type.isPlainObject(t)?t:{};t.key=t.key||"";var e=t.value||{};e.entityTypeName=e.entityTypeName||"";e.context=e.context||"";e.isCanceled=s.Type.isBoolean(e.isCanceled)?e.isCanceled:false;if(e.isCanceled){return}if(t.key==="onCrmEntityCreate"&&i.externalRequests[e.context]){if(i.externalRequests[e.context]){if(i.externalRequests[e.context]["type"]=="create"){i.crmEntityType=e.entityTypeName;i.crmEntityId=e.entityInfo.id;i.loadCrmCard(i.crmEntityType,i.crmEntityId)}else if(i.externalRequests[e.context]["type"]=="add"){i.loadCrmCard(i.crmEntityType,i.crmEntityId)}if(i.externalRequests[e.context]["window"]){i.externalRequests[e.context]["window"].close()}delete i.externalRequests[e.context]}}}});O(this,J,{writable:true,value:function e(){console.log("onWindowUnload call view event",location.href,n.DesktopApi.isChatWindow());i.close()}});this.id="im-phone-call-view";this.darkMode=t.darkMode===true;this.phoneNumber=t.phoneNumber||"hidden";this.lineNumber=t.lineNumber||"";this.companyPhoneNumber=t.companyPhoneNumber||"";this.direction=t.direction||R.incoming;this.fromUserId=t.fromUserId;this.toUserId=t.toUserId;this.config=t.config||{};this.callId=t.callId||"";this.callState=W.idle;this.crmEntityType=BX.prop.getString(t,"crmEntityType","");this.crmEntityId=BX.prop.getInteger(t,"crmEntityId",0);this.crmActivityId=BX.prop.getInteger(t,"crmActivityId",0);this.crmActivityEditUrl=BX.prop.getString(t,"crmActivityEditUrl","");this.crmData=BX.prop.getObject(t,"crmData",{});this.crmBindings=BX.prop.getArray(t,"crmBindings",[]);this.externalRequests={};this.portalCallData=t.portalCallData;this.portalCallUserId=t.portalCallUserId;this.portalCallQueueName=t.portalCallQueueName;this.hasSipPhone=t.hasSipPhone===true;this.deviceCall=t.deviceCall===true;this.portalCall=t.portalCall===true;this.crm=t.crm===true;this.held=false;this.muted=false;this.recording=t.recording===true;this.makeCall=t.makeCall===true;this.closable=false;this.allowAutoClose=true;this.folded=t.folded===true;this.autoFold=t.autoFold===true;this.transfer=t.transfer===true;this.title="";this._uiState=t.uiState||F.idle;this.statusText=t.statusText||"";this.progress="";this.quality=0;this.qualityPopup=null;this.qualityGrade=0;this.comment="";this.commentShown=false;this.initialTimestamp=t.initialTimestamp||0;this.timerInterval=null;this.autoCloseTimer=null;this.autoCloseTimeout=65e3;this.elements=this.getInitialElements();this.sections=this.getInitialSections();var l=this.getUiStateButtons(this._uiState);this.buttonLayout=l.layout;this.buttons=l.buttons;this.restApps=t.restApps||[];if(!s.Type.isPlainObject(t.events)){t.events={}}this.callbacks={hold:s.Type.isFunction(t.events.hold)?t.events.hold:r,unhold:s.Type.isFunction(t.events.unhold)?t.events.unhold:r,mute:s.Type.isFunction(t.events.mute)?t.events.mute:r,unmute:s.Type.isFunction(t.events.unmute)?t.events.unmute:r,makeCall:s.Type.isFunction(t.events.makeCall)?t.events.makeCall:r,callListMakeCall:s.Type.isFunction(t.events.callListMakeCall)?t.events.callListMakeCall:r,answer:s.Type.isFunction(t.events.answer)?t.events.answer:r,skip:s.Type.isFunction(t.events.skip)?t.events.skip:r,hangup:s.Type.isFunction(t.events.hangup)?t.events.hangup:r,close:s.Type.isFunction(t.events.close)?t.events.close:r,transfer:s.Type.isFunction(t.events.transfer)?t.events.transfer:r,completeTransfer:s.Type.isFunction(t.events.completeTransfer)?t.events.completeTransfer:r,cancelTransfer:s.Type.isFunction(t.events.cancelTransfer)?t.events.cancelTransfer:r,switchDevice:s.Type.isFunction(t.events.switchDevice)?t.events.switchDevice:r,qualityGraded:s.Type.isFunction(t.events.qualityGraded)?t.events.qualityGraded:r,dialpadButtonClicked:s.Type.isFunction(t.events.dialpadButtonClicked)?t.events.dialpadButtonClicked:r,saveComment:s.Type.isFunction(t.events.saveComment)?t.events.saveComment:r,notifyAdmin:s.Type.isFunction(t.events.notifyAdmin)?t.events.notifyAdmin:r};this.popup=null;this._onBeforeUnloadHandler=this._onBeforeUnload.bind(this);this._onDblClickHandler=this._onDblClick.bind(this);this._onHoldButtonClickHandler=this._onHoldButtonClick.bind(this);this._onMuteButtonClickHandler=this._onMuteButtonClick.bind(this);this._onTransferButtonClickHandler=this._onTransferButtonClick.bind(this);this._onTransferCompleteButtonClickHandler=this._onTransferCompleteButtonClick.bind(this);this._onTransferCancelButtonClickHandler=this._onTransferCancelButtonClick.bind(this);this._onDialpadButtonClickHandler=this._onDialpadButtonClick.bind(this);this._onHangupButtonClickHandler=this._onHangupButtonClick.bind(this);this._onCloseButtonClickHandler=this._onCloseButtonClick.bind(this);this._onMakeCallButtonClickHandler=this._onMakeCallButtonClick.bind(this);this._onNextButtonClickHandler=this._onNextButtonClick.bind(this);this._onRedialButtonClickHandler=this._onRedialButtonClick.bind(this);this._onFoldButtonClickHandler=this._onFoldButtonClick.bind(this);this._onAnswerButtonClickHandler=this._onAnswerButtonClick.bind(this);this._onSkipButtonClickHandler=this._onSkipButtonClick.bind(this);this._onSwitchDeviceButtonClickHandler=this._onSwitchDeviceButtonClick.bind(this);this._onQualityMeterClickHandler=this._onQualityMeterClick.bind(this);this._onPullEventCrmHandler=this._onPullEventCrm.bind(this);this.hiddenTabs=[];this.currentTabName="";this.moreTabsMenu=null;this.customTabs={};this.callListId=t.callListId||0;this.callListStatusId=t.callListStatusId||null;this.callListItemIndex=t.callListItemIndex||null;this.callListView=null;this.currentEntity=null;this.callingEntity=null;this.numberSelectMenu=null;this.webformId=t.webformId||0;this.webformSecCode=t.webformSecCode||"";this.webformLoaded=false;this.restAppLayoutLoaded=false;this.restAppLayoutLoading=false;this.restAppInterface=null;this.callWindow=null;this.slave=t.slave===true;this.skipOnResize=t.skipOnResize===true;this.desktop=new V({parentPhoneCallView:this,closable:this.callListId>0?true:this.closable});this.currentLayout=this.callListId>0?G.crm:G.simple;this.backgroundWorker=t.backgroundWorker;this.backgroundWorker.setCallCard(this);this.backgroundWorker.setExternalCall(!!t.isExternalCall);this._isDesktop=t.messengerFacade?t.messengerFacade.isDesktop():t.isDesktop===true;this.messengerFacade=t.messengerFacade;this.foldedCallView=t.foldedCallView;this.init();if(this.backgroundWorker.isDesktop()){this.backgroundWorker.removeDesktopEventHandlers()}this.backgroundWorker.platformWorker.emitInitializeEvent(this.getPlacementOptions());this.createTitle().then((function(e){return i.setTitle(e)}));if(t.hasOwnProperty("uiState")){this.setUiState(t["uiState"])}}babelHelpers.createClass(e,[{key:"getInitialElements",value:function e(){return{main:null,title:null,sections:{status:null,timer:null,crmButtons:null},avatar:null,progress:null,timer:null,status:null,commentEditorContainer:null,commentEditor:null,qualityMeter:null,crmCard:null,crmButtonsContainer:null,crmButtons:{},buttonsContainer:null,topLevelButtonsContainer:null,topButtonsContainer:null,buttons:{},sidebarContainer:null,tabsContainer:null,tabsBodyContainer:null,tabs:{callList:null,webform:null,app:null,custom:null},tabsBody:{callList:null,webform:null,app:null},moreTabs:null}}},{key:"getInitialSections",value:function e(){return{status:{visible:false},timer:{visible:false},crmButtons:{visible:false},commentEditor:{visible:false}}}},{key:"init",value:function e(){var t=this;if(n.DesktopApi.isChatWindow()&&!this.slave){console.log("Init phone call view window:",location.href);this.desktop.openCallWindow("",null,{width:this.getInitialWidth(),height:this.getInitialHeight(),resizable:this.currentLayout==G.crm,minWidth:this.elements.sidebarContainer?950:550,minHeight:650});this.bindMasterDesktopEvents();window.addEventListener("beforeunload",babelHelpers.classPrivateFieldGet(this,J));return}this.elements.main=this.createLayout();this.updateView();if(this.isDesktop()&&this.slave){document.body.appendChild(this.elements.main);this.bindSlaveDesktopEvents()}else if(!this.isDesktop()&&this.isFolded()){document.body.appendChild(this.elements.main)}else if(!this.isDesktop()){this.popup=this.createPopup();BX.addCustomEvent(window,"onLocalStorageSet",babelHelpers.classPrivateFieldGet(this,Q))}if(this.callListId>0){if(this.callListView){this.callListView.reinit({node:this.elements.tabsBody.callList})}else{this.callListView=new L({node:this.elements.tabsBody.callList,id:this.callListId,statusId:this.callListStatusId,itemIndex:this.callListItemIndex,makeCall:this.makeCall,isDesktop:this.isDesktop,onSelectedItem:this.onCallListSelectedItem.bind(this)});this.callListView.init((function(){if(t.makeCall){t._onMakeCallButtonClick()}}));this.setUiState(F.outgoing)}}else if(this.crm&&!this.isFolded()){this.loadCrmCard(this.crmEntityType,this.crmEntityId)}BX.addCustomEvent("onPullEvent-crm",this._onPullEventCrmHandler);if(!this.isDesktop()){window.addEventListener("beforeunload",this._onBeforeUnloadHandler)}}},{key:"reinit",value:function e(){this.elements=this.getInitialElements();var t=this.isDesktop()?babelHelpers.classPrivateFieldGet(this,J):this._onBeforeUnloadHandler;window.removeEventListener("beforeunload",t);BX.removeCustomEvent(window,"onLocalStorageSet",babelHelpers.classPrivateFieldGet(this,Q));BX.removeCustomEvent("onPullEvent-crm",this._onPullEventCrmHandler);this.init()}},{key:"show",value:function e(){if(!this.popup&&this.isDesktop()){return}if(!this.popup){this.reinit()}if(!this.isDesktop()&&!this.isFolded()){this.disableDocumentScroll()}this.popup.show();BX.localStorage.set(Y.callView,this.callId,86400);return this}},{key:"createPopup",value:function e(){var t=this;return new l.Popup({id:this.getId(),bindElement:null,targetContainer:document.body,content:this.elements.main,closeIcon:false,noAllPaddings:true,zIndex:o,offsetLeft:0,offsetTop:0,closeByEsc:false,draggable:{restrict:false},overlay:{backgroundColor:"black",opacity:30},events:{onPopupClose:function e(){if(t.isFolded());else{t.callbacks.close()}},onPopupDestroy:function e(){return t.popup=null}}})}},{key:"createLayout",value:function e(){if(this.isFolded()){return this.createLayoutFolded()}else if(this.currentLayout==G.crm){return this.createLayoutCrm()}else{return this.createLayoutSimple()}}},{key:"createLayoutCrm",value:function e(){var t=this;var i=s.Dom.create("div",{props:{className:"im-phone-call-top-level"},events:{dblclick:this._onDblClickHandler},children:[this.elements.topLevelButtonsContainer=s.Dom.create("div"),this.elements.phoneCallWrapper=s.Dom.create("div",{props:{className:"im-phone-call-wrapper"+(this.hasSideBar()?"":" im-phone-call-wrapper-without-sidebar")},children:[s.Dom.create("div",{props:{className:"im-phone-call-container"+(this.hasSideBar()?"":" im-phone-call-container-without-sidebar")},children:[s.Dom.create("div",{props:{className:"im-phone-call-header-container"},children:[s.Dom.create("div",{props:{className:"im-phone-call-header"},children:[this.elements.title=s.Dom.create("div",{props:{className:"im-phone-call-title-text"},html:this.renderTitle()})]})]}),this.elements.crmCard=s.Dom.create("div",{props:{className:"im-phone-call-crm-card"}}),this.elements.sections.status=s.Dom.create("div",{props:{className:"im-phone-call-section"},style:this.sections.status.visible?{}:{display:"none"},children:[s.Dom.create("div",{props:{className:"im-phone-call-status-description"},children:[this.elements.status=s.Dom.create("div",{props:{className:"im-phone-call-status-description-item"},text:this.statusText})]})]}),this.elements.sections.timer=s.Dom.create("div",{props:{className:"im-phone-call-section"},style:this.sections.timer.visible?{}:{display:"none"},children:[s.Dom.create("div",{props:{className:"im-phone-call-status-timer"},children:[s.Dom.create("div",{props:{className:"im-phone-call-status-timer-item"},children:[this.elements.timer=s.Dom.create("span")]})]})]}),this.elements.commentEditorContainer=s.Dom.create("div",{props:{className:"im-phone-call-section"},style:this.commentShown?{}:{display:"none"},children:[s.Dom.create("div",{props:{className:"im-phone-call-comments"},children:[this.elements.commentEditor=s.Dom.create("textarea",{props:{className:"im-phone-call-comments-textarea",value:this.comment,placeholder:s.Loc.getMessage("IM_PHONE_CALL_COMMENT_PLACEHOLDER")},events:{bxchange:this._onCommentChanged.bind(this)}})]})]}),this.elements.sections.crmButtons=s.Dom.create("div",{props:{className:"im-phone-call-section"},style:this.sections.crmButtons.visible?{}:{display:"none"},children:[this.elements.crmButtonsContainer=s.Dom.create("div",{props:{className:"im-phone-call-crm-buttons"}})]}),this.elements.buttonsContainer=s.Dom.create("div",{props:{className:"im-phone-call-buttons-container"}}),this.elements.topButtonsContainer=s.Dom.create("div",{props:{className:"im-phone-call-buttons-container-top"}})]})]})]});if(this.hasSideBar()){this.createSidebarLayout();if(this.elements.sidebarContainer){i.appendChild(this.elements.sidebarContainer)}setTimeout((function(){return t.checkMoreButton()}),0)}if(this.isDesktop()){i.style.position="fixed";i.style.top=0;i.style.bottom=0;i.style.left=0;i.style.right=0}else{i.style.width=this.getInitialWidth()+"px";i.style.height=this.getInitialHeight()+"px"}return i}},{key:"hasSideBar",value:function e(){if(this.isDesktop()&&!this.desktop.isFeatureSupported("iframe")){return this.callListId>0}else{return this.callListId>0||this.webformId>0||this.restApps.length>0||Object.keys(this.customTabs).length>0}}},{key:"getInitialWidth",value:function e(){var t=window.localStorage?parseInt(window.localStorage.getItem(Y.width)):0;if(this.currentLayout==G.simple){return j.simple.width}else if(this.hasSideBar()){if(t>0){return t}else{return Math.min(Math.floor(screen.width*.8),1200)}}else{return j.crm.width}}},{key:"getInitialHeight",value:function e(){var t=window.localStorage?parseInt(window.localStorage.getItem(Y.height)):0;if(this.currentLayout==G.simple){return j.simple.height}else if(t>0){return t}else{return j.crm.height}}},{key:"saveInitialSize",value:function e(t,i){if(!window.localStorage){return false}if(this.currentLayout==G.crm){window.localStorage.setItem(Y.height,i.toString());if(this.hasSideBar()){window.localStorage.setItem(Y.width,t)}}}},{key:"showSections",value:function e(t){var i=this;if(!s.Type.isArray(t)){return}t.forEach((function(e){if(i.elements.sections[e]){i.elements.sections[e].style.removeProperty("display")}if(i.sections[e]){i.sections[e].visible=true}}))}},{key:"hideSections",value:function e(t){var i=this;if(!s.Type.isArray(t)){return}t.forEach((function(e){if(i.elements.sections[e]){i.elements.sections[e].style.display="none"}if(i.sections[e]){i.sections[e].visible=false}}))}},{key:"showOnlySections",value:function e(t){if(!s.Type.isArray(t)){return}var i={};t.forEach((function(e){return i[e]=true}));for(var n in this.elements.sections){if(!this.elements.sections.hasOwnProperty(n)||!s.Type.isDomNode(this.elements.sections[n])){continue}if(i[n]){this.elements.sections[n].style.removeProperty("display");if(this.sections.hasOwnProperty(n)){this.sections[n].visible=true}}else{this.elements.sections[n].style.display="none";if(this.sections.hasOwnProperty(n)){this.sections[n].visible=false}}}}},{key:"createSidebarLayout",value:function e(){var t=this;var i=[];var n=[];if(Object.keys(this.customTabs).length>0){Object.keys(this.customTabs).forEach((function(e){var l=t.customTabs[e].id;var a=t.customTabs[e].title;var o="custom".concat(l);t.elements.tabs[o]=s.Dom.create("span",{props:{className:"im-phone-sidebar-tab"},dataset:{tabId:o,tabBodyId:"custom".concat(l)},text:s.Text.encode(a),events:{click:t._onTabHeaderClick.bind(t)}});i.push(t.elements.tabs[o]);if(!t.elements.tabsBody[o]){t.elements.tabsBody[o]=s.Dom.create("div",{props:{className:"voximplant-phone-call-".concat(o,"-container")},children:[s.Dom.create("div",{props:{className:"voximplant-phone-call-".concat(o,"-tab-content voximplant-phone-call-custom-container")}})]})}n.push(t.elements.tabsBody[o])}))}if(this.callListId>0){this.elements.tabs.callList=s.Dom.create("span",{props:{className:"im-phone-sidebar-tab"},dataset:{tabId:"callList",tabBodyId:"callList"},text:s.Loc.getMessage("IM_PHONE_CALL_VIEW_CALL_LIST_TITLE"),events:{click:this._onTabHeaderClick.bind(this)}});i.push(this.elements.tabs.callList);if(!this.elements.tabsBody.callList){this.elements.tabsBody.callList=s.Dom.create("div")}n.push(this.elements.tabsBody.callList)}if(this.webformId>0&&this.isWebformSupported()){this.elements.tabs.webform=s.Dom.create("span",{props:{className:"im-phone-sidebar-tab"},dataset:{tabId:"webform",tabBodyId:"webform"},text:s.Loc.getMessage("IM_PHONE_CALL_VIEW_WEBFORM_TITLE"),events:{click:this._onTabHeaderClick.bind(this)}});i.push(this.elements.tabs.webform);if(!this.elements.tabsBody.webform){this.elements.tabsBody.webform=s.Dom.create("div",{props:{className:"im-phone-call-form-container"}})}n.push(this.elements.tabsBody.webform);if(!this.formManager){this.formManager=new w({node:this.elements.tabsBody.webform,onFormSend:this._onFormSend.bind(this)})}}if(this.restApps.length>0&&this.isRestAppsSupported()){this.restApps.forEach((function(e){var n=e.id;var l="restApp"+n;t.elements.tabs[l]=s.Dom.create("span",{props:{className:"im-phone-sidebar-tab"},dataset:{tabId:l,tabBodyId:"app",restAppId:n},text:s.Text.encode(e.name),events:{click:t._onTabHeaderClick.bind(t)}});i.push(t.elements.tabs[l])}));if(!this.elements.tabsBody.app){this.elements.tabsBody.app=s.Dom.create("div",{props:{className:"im-phone-call-app-container"}})}n.push(this.elements.tabsBody.app)}this.elements.tabsTitleListContainer=s.Dom.create("div",{props:{className:"im-phone-sidebar-tabs-container"},children:[this.elements.tabsContainer=s.Dom.create("div",{props:{className:"im-phone-sidebar-tabs-left"},children:i}),s.Dom.create("div",{props:{className:"im-phone-sidebar-tabs-right"},children:[this.elements.moreTabs=s.Dom.create("span",{props:{className:"im-phone-sidebar-tab im-phone-sidebar-tab-more"},style:{display:"none"},dataset:{},text:s.Loc.getMessage("IM_PHONE_CALL_VIEW_MORE"),events:{click:this._onTabMoreClick.bind(this)}})]})]});this.elements.tabsBodyContainer=s.Dom.create("div",{props:{className:"im-phone-sidebar-tabs-body-container"},children:n});if(this.elements.sidebarContainer){this.elements.sidebarContainer.replaceChild(this.elements.tabsTitleListContainer,this.elements.sidebarContainer.firstChild);this.elements.sidebarContainer.replaceChild(this.elements.tabsBodyContainer,this.elements.sidebarContainer.lastChild);setTimeout((function(){return t.checkMoreButton()}),0)}else{this.elements.sidebarContainer=s.Dom.create("div",{props:{className:"im-phone-sidebar-wrap"},children:[this.elements.tabsTitleListContainer,this.elements.tabsBodyContainer]})}if(Object.keys(this.customTabs).length>0){var l=Object.keys(this.customTabs)[0];this.setActiveTab({tabId:"custom".concat(this.customTabs[l].id),tabBodyId:"custom".concat(this.customTabs[l].id),hidden:this.customTabs[l].visible})}else if(this.callListId>0){this.setActiveTab({tabId:"callList",tabBodyId:"callList"})}else if(this.webformId>0&&this.isWebformSupported()){this.setActiveTab({tabId:"webform",tabBodyId:"webform"})}else if(this.restApps.length>0&&this.isRestAppsSupported()){this.setActiveTab({tabId:"restApp"+this.restApps[0].id,tabBodyId:"app",restAppId:this.restApps[0].id})}}},{key:"createLayoutSimple",value:function e(){var t="";if(this.isPortalCall()&&this.portalCallData.hrphoto&&this.portalCallData.hrphoto[this.portalCallUserId]&&this.portalCallData.hrphoto[this.portalCallUserId]!=K){t=this.portalCallData.hrphoto[this.portalCallUserId]}var i=s.Dom.create("div",{props:{className:"im-phone-call-wrapper"},children:[s.Dom.create("div",{props:{className:"im-phone-call-container"},children:[s.Dom.create("div",{props:{className:"im-phone-calling-section"},children:[this.elements.title=s.Dom.create("div",{props:{className:"im-phone-calling-text"}})]}),s.Dom.create("div",{props:{className:"im-phone-call-section im-phone-calling-progress-section"},children:[s.Dom.create("div",{props:{className:"im-phone-calling-progress-container"},children:[s.Dom.create("div",{props:{className:"im-phone-calling-progress-container-block-l"},children:[s.Dom.create("div",{props:{className:"im-phone-calling-progress-phone"}})]}),this.elements.progress=s.Dom.create("div",{props:{className:"im-phone-calling-progress-container-block-c"}}),s.Dom.create("div",{props:{className:"im-phone-calling-progress-container-block-r"},children:[this.elements.avatar=s.Dom.create("div",{props:{className:"im-phone-calling-progress-customer"},style:s.Type.isStringFilled(t)?{"background-image":"url('"+t+"')"}:{}})]})]})]}),s.Dom.create("div",{props:{className:"im-phone-call-section"},children:[this.elements.status=s.Dom.create("div",{props:{className:"im-phone-calling-process-status"}})]}),this.elements.buttonsContainer=s.Dom.create("div",{props:{className:"im-phone-call-buttons-container"}}),this.elements.topButtonsContainer=s.Dom.create("div",{props:{className:"im-phone-call-buttons-container-top"}})]})]});i.style.width=this.getInitialWidth()+"px";i.style.height=this.getInitialHeight()+"px";return i}},{key:"createLayoutFolded",value:function e(){var t=this;return s.Dom.create("div",{props:{className:"im-phone-call-panel-mini"},style:{zIndex:o},children:[this.elements.sections.timer=this.elements.timer=s.Dom.create("div",{props:{className:"im-phone-call-panel-mini-time"},style:this.sections.timer.visible?{}:{display:"none"}}),this.elements.buttonsContainer=s.Dom.create("div",{props:{className:"im-phone-call-panel-mini-buttons"}}),s.Dom.create("div",{props:{className:"im-phone-call-panel-mini-expand"},events:{click:function e(){return t.unfold()}}})]})}},{key:"addTab",value:function e(t){var i=this;var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";if(!s){s=Math.random().toString(36).substr(2,9)}return new Promise((function(e){var n={title:t,id:s,callId:i.callId,contentContainerId:"voximplant-phone-call-".concat(s,"-container"),visible:true,visibilityChangeCallback:null,getContentContainerId:function e(){return i.elements.tabsBody["custom".concat(s)]},setContent:function e(t){i.elements.tabsBody["custom".concat(s)].replaceChild(t,i.elements.tabsBody["custom".concat(s)].firstChild)},setVisibilityChangeCallback:function e(t){this.visibilityChangeCallback=t},setTitle:function e(t){i.customTabs[s].title=t;i.elements.tabs["custom".concat(s)].innerText=t},setVisibility:function e(t){i.customTabs[s].visible=t;i.createSidebarLayout()},remove:function e(){delete i.customTabs[s];if(!i.hasSideBar()){i.elements.main.removeChild(i.elements.sidebarContainer);i.elements.sidebarContainer=null;i.resizeCallCard();return}i.createSidebarLayout()}};i.customTabs[s]=n;if(i.elements.sidebarContainer){i.createSidebarLayout()}else{i.createSidebarLayout();i.elements.main.appendChild(i.elements.sidebarContainer);i.elements.phoneCallWrapper.classList.remove("im-phone-call-wrapper-without-sidebar");i.resizeCallCard()}e(n)}))}},{key:"resizeCallCard",value:function e(){if(this.isDesktop()){this.elements.main.style.position="fixed";this.elements.main.style.top=0;this.elements.main.style.bottom=0;this.elements.main.style.left=0;this.elements.main.style.right=0}else{this.elements.main.style.width=this.getInitialWidth()+"px";this.elements.main.style.height=this.getInitialHeight()+"px"}if(this.isDesktop()){this.resizeWindow(this.getInitialWidth(),this.getInitialHeight())}this.adjust()}},{key:"setActiveTab",value:function e(t){var i=t.tabId;var n=t.tabBodyId;var l=t.restAppId||"";t.hidden=t.hidden===true;for(var a in this.elements.tabs){if(this.elements.tabs.hasOwnProperty(a)&&s.Type.isDomNode(this.elements.tabs[a])){this.elements.tabs[a].classList.toggle("im-phone-sidebar-tab-active",a==i)}}this.elements.moreTabs.classList.toggle("im-phone-sidebar-tab-active",t.hidden);for(var o in this.elements.tabsBody){if(this.elements.tabsBody.hasOwnProperty(o)&&s.Type.isDomNode(this.elements.tabsBody[o])){if(o==n){this.elements.tabsBody[o].style.removeProperty("display")}else{this.elements.tabsBody[o].style.display="none"}}}this.currentTabName=i;if(i==="webform"&&!this.webformLoaded){this.loadForm({id:this.webformId,secCode:this.webformSecCode})}if(l!==""){this.loadRestApp({id:l,callId:this.callId,node:this.elements.tabsBody.app})}}},{key:"isCurrentTabHidden",value:function e(){var t=false;for(var i=0;i<this.hiddenTabs.length;i++){if(this.hiddenTabs[i].dataset.tabId==this.currentTabName){t=true;break}}return t}},{key:"checkMoreButton",value:function e(){if(!this.elements.tabsContainer){return}var t=this.elements.tabsContainer.children;var i;this.hiddenTabs=[];for(var n=0;n<t.length;n++){i=t.item(n);if(i.offsetTop>7){this.hiddenTabs.push(i)}}if(this.hiddenTabs.length>0){this.elements.moreTabs.style.removeProperty("display")}else{this.elements.moreTabs.style.display="none"}if(this.isCurrentTabHidden()){s.Dom.addClass(this.elements.moreTabs,"im-phone-sidebar-tab-active")}else{s.Dom.removeClass(this.elements.moreTabs,"im-phone-sidebar-tab-active")}}},{key:"_onTabHeaderClick",value:function e(t){if(this.moreTabsMenu){this.moreTabsMenu.close()}this.setActiveTab({tabId:t.target.dataset.tabId,tabBodyId:t.target.dataset.tabBodyId,restAppId:t.target.dataset.restAppId||"",hidden:false})}},{key:"_onTabMoreClick",value:function e(){var t=this;if(this.hiddenTabs.length===0){return}if(this.moreTabsMenu){this.moreTabsMenu.close();return}var i=[];this.hiddenTabs.forEach((function(e){i.push({id:"selectTab_"+e.dataset.tabId,text:e.innerText,onclick:function i(){t.moreTabsMenu.close();t.setActiveTab({tabId:e.dataset.tabId,tabBodyId:e.dataset.tabBodyId,restAppId:e.dataset.restAppId||"",hidden:true})}})}));this.moreTabsMenu=new l.Menu("phoneCallViewMoreTabs",this.elements.moreTabs,i,{autoHide:true,offsetTop:0,offsetLeft:0,angle:{position:"top"},zIndex:o+100,events:{onPopupClose:function e(){return t.moreTabsMenu.destroy()},onPopupDestroy:function e(){return t.moreTabsMenu=null}}});this.moreTabsMenu.show()}},{key:"getId",value:function e(){return this.id}},{key:"createTitle",value:function e(){var t=this;var i="";return new Promise((function(e){BX.PhoneNumberParser.getInstance().parse(t.phoneNumber).then((function(n){if(t.phoneNumber=="unknown"){e(s.Loc.getMessage("IM_PHONE_CALL_VIEW_NUMBER_UNKNOWN"));return}if(t.phoneNumber=="hidden"){i=s.Loc.getMessage("IM_PHONE_HIDDEN_NUMBER")}else{i=t.phoneNumber.toString();if(n.isValid()){i=n.format();if(n.isInternational()&&i.charAt(0)!="+"){i="+"+i}}else{i=t.phoneNumber.toString()}}if(t.isCallback()){i=s.Loc.getMessage("IM_PHONE_CALLBACK_TO").replace("#PHONE#",i)}else if(t.isPortalCall()){switch(t.direction){case R.incoming:if(t.portalCallUserId){i=s.Loc.getMessage("IM_M_CALL_VOICE_FROM").replace("#USER#",t.portalCallData.users[t.portalCallUserId].name)}break;case R.outgoing:if(t.portalCallUserId){i=s.Loc.getMessage("IM_M_CALL_VOICE_TO").replace("#USER#",t.portalCallData.users[t.portalCallUserId].name)}else{i=s.Loc.getMessage("IM_M_CALL_VOICE_TO").replace("#USER#",t.portalCallQueueName)+" ("+t.phoneNumber+")"}break}}else{i=s.Loc.getMessage(t.direction===R.incoming?"IM_PHONE_CALL_VOICE_FROM":"IM_PHONE_CALL_VOICE_TO").replace("#PHONE#",i);if(t.direction===R.incoming&&t.companyPhoneNumber){i=i+", "+s.Loc.getMessage("IM_PHONE_CALL_TO_PHONE").replace("#PHONE#",t.companyPhoneNumber)}if(t.isTransfer()){i=i+" "+s.Loc.getMessage("IM_PHONE_CALL_TRANSFERED")}}e(i)}))}))}},{key:"renderTitle",value:function e(){return s.Text.encode(this.title)}},{key:"renderAvatar",value:function e(){var t="";if(this.isPortalCall()&&this.elements.avatar&&this.portalCallData.hrphoto&&this.portalCallData.hrphoto[this.portalCallUserId]&&this.portalCallData.hrphoto[this.portalCallUserId]!=K){t=this.portalCallData.hrphoto[this.portalCallUserId];s.Dom.adjust(this.elements.avatar,{style:t===""?{}:{"background-image":"url('"+t+"')"}})}}},{key:"_getCrmEditUrl",value:function e(t,i){if(!s.Type.isStringFilled(t)){return""}i=Number(i);return"/crm/"+t.toLowerCase()+"/edit/"+i.toString()+"/"}},{key:"_generateExternalContext",value:function e(){return this._getRandomString(16)}},{key:"_getRandomString",value:function e(t){var i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";var s="";for(var n=0;n<t;n++){var l=Math.floor(Math.random()*i.length);s+=i.substring(l,l+1)}return s}},{key:"setPhoneNumber",value:function e(t){this.phoneNumber=t;this.setOnSlave(q.setPhoneNumber,[t])}},{key:"setTitle",value:function e(t){this.title=t;if(this.isDesktop()){if(this.slave){BXDesktopWindow.SetProperty("title",t)}else{n.DesktopApi.emit(q.setTitle,[t])}}if(this.elements.title){this.elements.title.innerHTML=this.renderTitle()}}},{key:"getTitle",value:function e(){return this.title}},{key:"setQuality",value:function e(t){this.quality=t;if(this.elements.qualityMeter){this.elements.qualityMeter.style.width=this.getQualityMeterWidth()}}},{key:"getQualityMeterWidth",value:function e(){if(this.quality>0&&this.quality<=5){return this.quality*20+"%"}else{return"0"}}},{key:"setProgress",value:function e(t){if(this.progress===t){return}this.progress=t;if(!this.elements.progress){return}s.Dom.clean(this.elements.progress);this.elements.progress.appendChild(this.renderProgress(this.progress))}},{key:"setStatusText",value:function e(t){if(this.isDesktop()&&!this.slave){n.DesktopApi.emit(q.setStatus,[t]);return}this.statusText=t;if(this.elements.status){this.elements.status.innerText=this.statusText}}},{key:"setConfig",value:function e(t){if(!s.Type.isPlainObject(t)){return}this.config=t;if(!this.isDesktop()||this.slave){this.renderCrmButtons()}this.setOnSlave(q.setConfig,[t])}},{key:"setCallId",value:function e(t){this.callId=t;this.setOnSlave(q.setCallId,[t])}},{key:"setLineNumber",value:function e(t){this.lineNumber=t;this.setOnSlave(q.setLineNumber,[t])}},{key:"setCompanyPhoneNumber",value:function e(t){this.companyPhoneNumber=t;this.setOnSlave(q.setCompanyPhoneNumber,[t])}},{key:"setButtons",value:function e(t,i){if(!z[i]){i=z.centered}this.buttonLayout=i;this.buttons=t;this.renderButtons()}},{key:"setUiState",value:function e(t){this._uiState=t;var i=this.getUiStateButtons(t);this.buttons=i.buttons;this.buttonLayout=i.layout;switch(t){case F.incoming:this.setClosable(false);this.showOnlySections(["status"]);this.renderCrmButtons();this.stopTimer();break;case F.transferIncoming:this.setClosable(false);this.showOnlySections(["status"]);this.renderCrmButtons();this.stopTimer();break;case F.outgoing:this.setClosable(true);this.showOnlySections(["status"]);this.renderCrmButtons();this.stopTimer();this.hideCallIcon();break;case F.connectingIncoming:this.setClosable(false);this.showOnlySections(["status"]);this.renderCrmButtons();this.stopTimer();break;case F.connectingOutgoing:this.setClosable(false);this.showOnlySections(["status"]);this.renderCrmButtons();this.showCallIcon();this.stopTimer();break;case F.connected:if(this.deviceCall){this.setClosable(true)}else{this.setClosable(false)}this.showSections(["status","timer"]);this.renderCrmButtons();this.showCallIcon();this.startTimer();break;case F.transferring:this.setClosable(false);this.showSections(["status","timer"]);this.renderCrmButtons();break;case F.idle:this.setClosable(true);this.stopTimer();this.hideCallIcon();this.showOnlySections(["status"]);this.renderCrmButtons();break;case F.error:this.setClosable(true);this.stopTimer();this.hideCallIcon();break;case F.moneyError:this.setClosable(true);this.stopTimer();this.hideCallIcon();break;case F.sipPhoneError:this.setClosable(true);this.stopTimer();this.hideCallIcon();break;case F.redial:this.setClosable(true);this.stopTimer();this.hideCallIcon();break}if(this.isDesktop()&&!this.slave){n.DesktopApi.emit(q.setUiState,[t]);return}this.renderButtons()}},{key:"setCallState",value:function e(t,i){if(this.callState===t){return}this.callState=t;if(!s.Type.isPlainObject(i)){i={}}this.renderButtons();if(t===W.connected&&this.isAutoFoldAllowed()){this.fold()}BX.onCustomEvent(window,"CallCard::CallStateChanged",[t,i]);this.setOnSlave(q.setCallState,[t,i])}},{key:"isAutoFoldAllowed",value:function e(){return this.autoFold===true&&!this.isDesktop()&&!this.isFolded()&&this.restApps.length===0}},{key:"isHeld",value:function e(){return this.held}},{key:"setHeld",value:function e(t){this.held=t}},{key:"setRecording",value:function e(t){this.recording=t}},{key:"isRecording",value:function e(){return this.recording}},{key:"isMuted",value:function e(){return this.muted}},{key:"setMuted",value:function e(t){this.muted=t}},{key:"isTransfer",value:function e(){return this.transfer}},{key:"setTransfer",value:function e(t){t=t===true;if(this.transfer==t){return}this.transfer=t;this.setOnSlave(q.setTransfer,[t]);this.setUiState(this._uiState)}},{key:"isCallback",value:function e(){return this.direction===R.callback}},{key:"isPortalCall",value:function e(){return this.portalCall}},{key:"setCallback",value:function e(t,i){if(!this.callbacks.hasOwnProperty(t)){return false}this.callbacks[t]=s.Type.isFunction(i)?i:r}},{key:"setDeviceCall",value:function e(t){this.deviceCall=t;if(this.elements.buttons.sipPhone){if(t){s.Dom.addClass(this.elements.buttons.sipPhone,"active")}else{s.Dom.removeClass(this.elements.buttons.sipPhone,"active")}}if(this.isDesktop()&&!this.slave){n.DesktopApi.emit(q.setDeviceCall,[t])}}},{key:"setCrmEntity",value:function e(t){this.crmEntityType=t.type;this.crmEntityId=t.id;this.crmActivityId=t.activityId||"";this.crmActivityEditUrl=t.activityEditUrl||"";this.crmBindings=s.Type.isArray(t.bindings)?t.bindings:[];if(this.isDesktop()&&!this.slave){n.DesktopApi.emit(q.setCrmEntity,[t])}}},{key:"setCrmData",value:function e(t){if(!s.Type.isPlainObject(t)){return}this.crm=true;this.crmData=t}},{key:"loadCrmCard",value:function e(t,i){var s=this;BX.onCustomEvent(window,"CallCard::EntityChanged",[{CRM_ENTITY_TYPE:t,CRM_ENTITY_ID:i,PHONE_NUMBER:this.phoneNumber}]);this.backgroundWorker.emitEvent(y.entityChanged,{CRM_ENTITY_TYPE:t,CRM_ENTITY_ID:i,PHONE_NUMBER:this.phoneNumber});var n="Y";if(this.isCallListMode()){n="N"}BX.ajax.runAction("voximplant.callview.getCrmCard",{data:{entityType:t,entityId:i,isEnableCopilotReplacement:n}}).then((function(e){if(s.currentLayout==G.simple){s.currentLayout=G.crm;s.crm=true;var t=s.createLayoutCrm();s.elements.main.parentNode.replaceChild(t,s.elements.main);s.elements.main=t;s.setUiState(s._uiState);s.setStatusText(s.statusText)}if(s.elements.crmCard){BX.html(s.elements.crmCard,e.data.html);setTimeout((function(){if(s.isDesktop()){s.resizeWindow(s.getInitialWidth(),s.getInitialHeight())}s.adjust();s.bindCrmCardEvents()}),100)}s.renderCrmButtons()}))["catch"]((function(e){return console.error("Could not load crm card: ",e.errors[0])}))}},{key:"reloadCrmCard",value:function e(){if(this.isDesktop()&&!this.slave){n.DesktopApi.emit(q.reloadCrmCard,[])}else{this.loadCrmCard(this.crmEntityType,this.crmEntityId)}}},{key:"bindCrmCardEvents",value:function e(){if(!this.elements.crmCard){return}if(!BX.Crm||!BX.Crm.Page){return}var t=this.elements.crmCard.querySelectorAll("a[data-use-slider=Y]");for(var i=0;i<t.length;i++){BX.bind(t[i],"click",this.onCrmAnchorClick.bind(this))}}},{key:"onCrmAnchorClick",value:function e(t){if(BX.Crm.Page.isSliderEnabled(t.currentTarget.href)){if(!this.isFolded()){this.fold()}}}},{key:"setPortalCallUserId",value:function e(t){var i=this;this.portalCallUserId=t;this.setOnSlave(q.setPortalCallUserId,[t]);if(this.portalCallData&&this.portalCallData.users[this.portalCallUserId]){this.renderAvatar();this.createTitle().then((function(e){return i.setTitle(e)}))}}},{key:"setPortalCallQueueName",value:function e(t){var i=this;this.portalCallQueueName=t;this.setOnSlave(q.setPortalCallQueueName,[t]);this.createTitle().then((function(e){return i.setTitle(e)}))}},{key:"setPortalCall",value:function e(t){this.portalCall=t===true;this.setOnSlave(q.setPortalCall,[t])}},{key:"setPortalCallData",value:function e(t){this.portalCallData=t;this.setOnSlave(q.setPortalCallData,[t])}},{key:"setOnSlave",value:function e(t,i){if(this.isDesktop()&&!this.slave){n.DesktopApi.emit(t,i)}}},{key:"updateView",value:function e(){if(this.elements.title){this.elements.title.innerHTML=this.renderTitle()}if(this.elements.progress){s.Dom.clean(this.elements.progress);this.elements.progress.appendChild(this.renderProgress(this.progress))}if(this.elements.status){this.elements.status.innerText=this.statusText}this.renderButtons();this.renderTimer()}},{key:"renderProgress",value:function e(t){var i;switch(t){case X.connect:i=s.Dom.create("div",{props:{className:"bx-messenger-call-overlay-progress"},children:[s.Dom.create("img",{props:{className:"bx-messenger-call-overlay-progress-status bx-messenger-call-overlay-progress-status-anim-1"}}),s.Dom.create("img",{props:{className:"bx-messenger-call-overlay-progress-status bx-messenger-call-overlay-progress-status-anim-2"}})]});break;case X.online:i=s.Dom.create("div",{props:{className:"bx-messenger-call-overlay-progress bx-messenger-call-overlay-progress-online"},children:[s.Dom.create("img",{props:{className:"bx-messenger-call-overlay-progress-status bx-messenger-call-overlay-progress-status-anim-3"}})]});break;case X.error:t=X.offline;default:i=s.Dom.create("div",{props:{className:"bx-messenger-call-overlay-progress bx-messenger-call-overlay-progress-"+t}})}return i}},{key:"getUiStateButtons",value:function e(t){var i={buttons:[],layout:z.centered};switch(t){case F.incoming:i.buttons=["answer","skip"];break;case F.transferIncoming:i.buttons=["answer","skip"];break;case F.outgoing:i.buttons=["call"];if(this.callListId>0){i.buttons.push("next");i.buttons.push("fold");if(!this.isDesktop()){i.buttons.push("topClose")}}break;case F.connectingIncoming:i.buttons=["hangup"];break;case F.connectingOutgoing:if(this.hasSipPhone){i.buttons.push("sipPhone")}i.buttons.push("hangup");break;case F.error:if(this.hasSipPhone){i.buttons.push("sipPhone")}if(this.callListId>0){i.buttons.push("redial","next","topClose")}else{i.buttons.push("close")}break;case F.moneyError:i.buttons=["notifyAdmin","close"];break;case F.sipPhoneError:i.buttons=["sipPhone","close"];break;case F.connected:i.buttons=this.isTransfer()?[]:["hold"];if(!this.deviceCall){i.buttons.push("mute","qualityMeter")}i.buttons.push("fold");if(!this.callListId&&!this.isTransfer()){i.buttons.push("transfer")}if(this.deviceCall){i.buttons.push("close")}else{i.buttons.push("dialpad","hangup")}i.layout=z.spaced;break;case F.transferring:i.buttons=["transferComplete","transferCancel"];break;case F.transferFailed:i.buttons=["transferCancel"];break;case F.transferConnected:i.buttons=["hangup"];break;case F.idle:if(this.hasSipPhone){i.buttons=["close"]}else if(this.direction==R.incoming){i.buttons=["close"]}else if(this.direction==R.outgoing){i.buttons=["redial"];if(this.callListId>0){i.buttons.push("next");i.buttons.push("fold")}else{i.buttons.push("close")}}if(this.callListId>0&&!this.isDesktop()){i.buttons.push("topClose")}break;case F.redial:i.buttons=["redial"];break;case F.externalCard:i.buttons=["close"];i.buttons.push("fold");break}return i}},{key:"renderButtons",value:function e(){if(this.isFolded()){this.renderButtonsFolded()}else{this.renderButtonsDefault()}}},{key:"renderButtonsDefault",value:function e(){var t=this;var i=document.createDocumentFragment();var n=document.createDocumentFragment();var l=document.createDocumentFragment();var a={left:null,right:null};this.elements.buttons={};if(this.buttonLayout==z.spaced){a.left=s.Dom.create("div",{props:{className:"im-phone-call-buttons-container-left"}});a.right=s.Dom.create("div",{props:{className:"im-phone-call-buttons-container-right"}});i.appendChild(a.left);i.appendChild(a.right)}this.buttons.forEach((function(e){var o;switch(e){case"hold":o=ee("","im-phone-call-btn-hold",t._onHoldButtonClickHandler);if(t.isHeld()){s.Dom.addClass(o,"active")}if(t.buttonLayout==z.spaced){a.left.appendChild(o)}else{i.appendChild(o)}break;case"mute":o=ee("","im-phone-call-btn-mute",t._onMuteButtonClickHandler);if(t.isMuted()){s.Dom.addClass(o,"active")}if(t.buttonLayout==z.spaced){a.left.appendChild(o)}else{i.appendChild(o)}break;case"transfer":o=ee("","im-phone-call-btn-transfer",t._onTransferButtonClickHandler);if(t.buttonLayout==z.spaced){a.left.appendChild(o)}else{i.appendChild(o)}break;case"transferComplete":o=ee(s.Loc.getMessage("IM_M_CALL_BTN_TRANSFER"),"im-phone-call-btn im-phone-call-btn-blue im-phone-call-btn-arrow",t._onTransferCompleteButtonClickHandler);i.appendChild(o);break;case"transferCancel":o=ee(s.Loc.getMessage("IM_M_CALL_BTN_RETURN"),"im-phone-call-btn im-phone-call-btn-red",t._onTransferCancelButtonClickHandler);i.appendChild(o);break;case"dialpad":o=ee("","im-phone-call-btn-dialpad",t._onDialpadButtonClickHandler);if(t.buttonLayout==z.spaced){a.left.appendChild(o)}else{i.appendChild(o)}break;case"call":o=ee(s.Loc.getMessage("IM_PHONE_CALL"),"im-phone-call-btn im-phone-call-btn-green",t._onMakeCallButtonClickHandler);i.appendChild(o);break;case"answer":o=ee(s.Loc.getMessage("IM_PHONE_BTN_ANSWER"),"im-phone-call-btn im-phone-call-btn-green",t._onAnswerButtonClickHandler);i.appendChild(o);break;case"skip":o=ee(s.Loc.getMessage("IM_PHONE_BTN_BUSY"),"im-phone-call-btn im-phone-call-btn-red",t._onSkipButtonClickHandler);i.appendChild(o);break;case"hangup":o=ee(s.Loc.getMessage("IM_M_CALL_BTN_HANGUP"),"im-phone-call-btn im-phone-call-btn-red  im-phone-call-btn-tube",t._onHangupButtonClickHandler);if(t.buttonLayout==z.spaced){a.right.appendChild(o)}else{i.appendChild(o)}break;case"close":o=ee(s.Loc.getMessage("IM_M_CALL_BTN_CLOSE"),"im-phone-call-btn im-phone-call-btn-red",t._onCloseButtonClickHandler);if(t.buttonLayout==z.spaced){a.right.appendChild(o)}else{i.appendChild(o)}break;case"topClose":if(!t.isDesktop()){o=s.Dom.create("div",{props:{className:"im-phone-call-top-close-btn"},events:{click:t._onCloseButtonClickHandler}});l.appendChild(o)}break;case"notifyAdmin":o=ee(s.Loc.getMessage("IM_M_CALL_BTN_NOTIFY_ADMIN"),"im-phone-call-btn im-phone-call-btn-blue im-phone-call-btn-arrow",(function(){t.backgroundWorker.isUsed?t.backgroundWorker.emitEvent(y.notifyAdminButtonClick):t.callbacks.notifyAdmin()}));i.appendChild(o);break;case"sipPhone":o=ee("",t.deviceCall?"im-phone-call-btn-phone active":"im-phone-call-btn-phone",t._onSwitchDeviceButtonClickHandler);if(t.buttonLayout==z.spaced){a.left.appendChild(o)}else{i.appendChild(o)}break;case"qualityMeter":o=s.Dom.create("span",{props:{className:"im-phone-call-btn-signal"},events:{click:t._onQualityMeterClickHandler},children:[s.Dom.create("span",{props:{className:"im-phone-call-btn-signal-icon-container"},children:[s.Dom.create("span",{props:{className:"im-phone-call-btn-signal-background"}}),t.elements.qualityMeter=s.Dom.create("span",{props:{className:"im-phone-call-btn-signal-active"},style:{width:t.getQualityMeterWidth()}})]})]});i.appendChild(o);break;case"settings":break;case"next":o=ee(s.Loc.getMessage("IM_M_CALL_BTN_NEXT"),"im-phone-call-btn im-phone-call-btn-gray im-phone-call-btn-arrow",t._onNextButtonClickHandler);i.appendChild(o);break;case"redial":o=ee(s.Loc.getMessage("IM_M_CALL_BTN_RECALL"),"im-phone-call-btn im-phone-call-btn-green",t._onMakeCallButtonClickHandler);i.appendChild(o);break;case"fold":if(!t.isDesktop()&&t.canBeFolded()){o=s.Dom.create("div",{props:{className:"im-phone-btn-arrow"},text:s.Loc.getMessage("IM_PHONE_CALL_VIEW_FOLD"),events:{click:t._onFoldButtonClickHandler}});n.appendChild(o)}break;default:throw"Unknown button "+e}if(o){t.elements.buttons[e]=o}}));if(this.elements.buttonsContainer){s.Dom.clean(this.elements.buttonsContainer);this.elements.buttonsContainer.appendChild(i)}if(this.elements.topButtonsContainer){s.Dom.clean(this.elements.topButtonsContainer);this.elements.topButtonsContainer.appendChild(n)}if(this.elements.topLevelButtonsContainer){s.Dom.clean(this.elements.topLevelButtonsContainer);this.elements.topLevelButtonsContainer.appendChild(l)}}},{key:"renderButtonsFolded",value:function e(){var t=this;var i=document.createDocumentFragment();var n;this.elements.buttons={};this.buttons.forEach((function(e){switch(e){case"hangup":n=ee(s.Loc.getMessage("IM_M_CALL_BTN_HANGUP"),"im-phone-call-panel-mini-cancel",t._onHangupButtonClickHandler);i.appendChild(n);break;case"close":n=ee(s.Loc.getMessage("IM_M_CALL_BTN_CLOSE"),"im-phone-call-panel-mini-cancel",t._onCloseButtonClickHandler);i.appendChild(n);break}}));if(this.elements.buttonsContainer){s.Dom.clean(this.elements.buttonsContainer);this.elements.buttonsContainer.appendChild(i)}}},{key:"renderCrmButtons",value:function e(){var t=this;var i=document.createDocumentFragment();this.elements.crmButtons={};if(!this.elements.crmButtonsContainer){return}var n=["addComment"];if(this.crmEntityType=="CONTACT"){n.push("addDeal");n.push("addInvoice")}else if(this.crmEntityType=="COMPANY"){n.push("addDeal");n.push("addInvoice")}else if(!this.crmEntityType&&this.config.CRM_CREATE=="none"){n.push("addLead");n.push("addContact")}if(n.length>0){n.forEach((function(e){var n;switch(e){case"addComment":n=s.Dom.create("div",{props:{className:"im-phone-call-crm-button im-phone-call-crm-button-comment"+(t.commentShown?" im-phone-call-crm-button-active":"")},children:[t.elements.crmButtons.addCommentLabel=s.Dom.create("div",{props:{className:"im-phone-call-crm-button-item"},text:t.commentShown?s.Loc.getMessage("IM_PHONE_CALL_VIEW_SAVE"):s.Loc.getMessage("IM_PHONE_ACTION_CRM_COMMENT")})],events:{click:t._onAddCommentButtonClick.bind(t)}});break;case"addDeal":n=s.Dom.create("div",{props:{className:"im-phone-call-crm-button"},children:[s.Dom.create("div",{props:{className:"im-phone-call-crm-button-item"},text:s.Loc.getMessage("IM_PHONE_ACTION_CRM_DEAL")})],events:{click:t._onAddDealButtonClick.bind(t)}});break;case"addInvoice":n=s.Dom.create("div",{props:{className:"im-phone-call-crm-button"},children:[s.Dom.create("div",{props:{className:"im-phone-call-crm-button-item"},text:s.Loc.getMessage("IM_PHONE_ACTION_CRM_INVOICE")})],events:{click:t._onAddInvoiceButtonClick.bind(t)}});break;case"addLead":n=s.Dom.create("div",{props:{className:"im-phone-call-crm-button"},children:[s.Dom.create("div",{props:{className:"im-phone-call-crm-button-item"},text:s.Loc.getMessage("IM_CRM_BTN_NEW_LEAD")})],events:{click:t._onAddLeadButtonClick.bind(t)}});break;case"addContact":n=s.Dom.create("div",{props:{className:"im-phone-call-crm-button"},children:[s.Dom.create("div",{props:{className:"im-phone-call-crm-button-item"},text:s.Loc.getMessage("IM_CRM_BTN_NEW_CONTACT")})],events:{click:t._onAddContactButtonClick.bind(t)}});break}if(n){i.appendChild(n);t.elements.crmButtons[e]=n}}));s.Dom.clean(this.elements.crmButtonsContainer);this.elements.crmButtonsContainer.appendChild(i);this.showSections(["crmButtons"])}else{s.Dom.clean(this.elements.crmButtonsContainer);this.hideSections(["crmButtons"])}}},{key:"loadForm",value:function e(t){if(!this.formManager){return}this.formManager.load({id:t.id,secCode:t.secCode})}},{key:"unloadForm",value:function e(){if(!this.formManager){return}this.formManager.unload();s.Dom.clean(this.elements.tabsBody.webform)}},{key:"_onFormSend",value:function e(t){if(!this.callListView){return}var i=this.callListView.getCurrentElement();this.callListView.setWebformResult(i.ELEMENT_ID,t.resultId)}},{key:"loadRestApp",value:function e(t){var i=this;var n=t.id;var l=t.node;if(this.restAppLayoutLoaded){BX.rest.AppLayout.getPlacement("CALL_CARD").load(n,this.getPlacementOptions());return}if(this.restAppLayoutLoading){return}this.restAppLayoutLoading=true;BX.ajax.runAction("voximplant.callView.loadRestApp",{data:{appId:n,placementOptions:this.getPlacementOptions()}}).then((function(e){if(!i.popup&&!i.isDesktop()){return}s.Runtime.html(l,e.data.html);i.restAppLayoutLoaded=true;i.restAppLayoutLoading=false;i.restAppInterface=BX.rest.AppLayout.initializePlacement("CALL_CARD");i.initializeAppInterface(i.restAppInterface)}))}},{key:"unloadRestApps",value:function e(){if(!BX.rest||!BX.rest.AppLayout){return false}var t=BX.rest.AppLayout.getPlacement("CALL_CARD");if(this.restAppLayoutLoaded&&t){t.destroy();this.restAppLayoutLoaded=false}}},{key:"initializeAppInterface",value:function e(t){var i=this;t.prototype.events.push("CallCard::EntityChanged");t.prototype.events.push("CallCard::BeforeClose");t.prototype.events.push("CallCard::CallStateChanged");t.prototype.getStatus=function(e,t){t(i.getPlacementOptions())};t.prototype.disableAutoClose=function(e,t){i.disableAutoClose();t([])};t.prototype.enableAutoClose=function(e,t){i.enableAutoClose();t([])}}},{key:"getPlacementOptions",value:function e(){return{CALL_ID:this.callId,PHONE_NUMBER:this.phoneNumber==="unknown"?undefined:this.phoneNumber,LINE_NUMBER:this.lineNumber,LINE_NAME:this.companyPhoneNumber,CRM_ENTITY_TYPE:this.crmEntityType,CRM_ENTITY_ID:this.crmEntityId,CRM_ACTIVITY_ID:this.crmActivityId===0?undefined:this.crmActivityId,CRM_BINDINGS:this.crmBindings,CALL_DIRECTION:this.direction,CALL_STATE:this.callState,CALL_LIST_MODE:this.callListId>0}}},{key:"isUnloadAllowed",value:function e(){if(this.backgroundWorker.isActiveIntoCurrentCall()){return false}return this.folded&&(this.deviceCall||this._uiState===F.idle||this._uiState===F.error||this._uiState===F.externalCard)}},{key:"_onBeforeUnload",value:function e(t){if(!this.isUnloadAllowed()){t.returnValue=s.Loc.getMessage("IM_PHONE_CALL_VIEW_DONT_LEAVE");return s.Loc.getMessage("IM_PHONE_CALL_VIEW_DONT_LEAVE")}}},{key:"_onDblClick",value:function e(t){t.preventDefault();if(!this.isFolded()&&this.canBeFolded()){this.fold()}}},{key:"_onHoldButtonClick",value:function e(){if(this.isHeld()){this.held=false;s.Dom.removeClass(this.elements.buttons.hold,"active");if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onUnHold,[])}else{this.callbacks.unhold()}}else{this.held=true;s.Dom.addClass(this.elements.buttons.hold,"active");if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onHold,[])}else{this.callbacks.hold()}}this.backgroundWorker.emitEvent(y.holdButtonClick,this.isHeld())}},{key:"_onMuteButtonClick",value:function e(){if(this.isMuted()){this.muted=false;s.Dom.removeClass(this.elements.buttons.mute,"active");if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onUnMute,[])}else{this.callbacks.unmute()}}else{this.muted=true;s.Dom.addClass(this.elements.buttons.mute,"active");if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onMute,[])}else{this.callbacks.mute()}}this.backgroundWorker.emitEvent(y.muteButtonClick,this.isMuted())}},{key:"_onTransferButtonClick",value:function e(){var t=this;this.selectTransferTarget((function(e){t.backgroundWorker.emitEvent(y.transferButtonClick,e);if(t.isDesktop()&&t.slave){n.DesktopApi.emit(q.onStartTransfer,[e])}else{t.callbacks.transfer(e)}}))}},{key:"_onTransferCompleteButtonClick",value:function e(){this.backgroundWorker.emitEvent(y.completeTransferButtonClick);if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onCompleteTransfer,[])}else{this.callbacks.completeTransfer()}}},{key:"_onTransferCancelButtonClick",value:function e(){this.backgroundWorker.emitEvent(y.cancelTransferButtonClick);if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onCancelTransfer,[])}else{this.callbacks.cancelTransfer()}}},{key:"_onDialpadButtonClick",value:function e(){var t=this;this.keypad=new h({bindElement:this.elements.buttons.dialpad,hideDial:true,onButtonClick:function e(i){var s=i.key;if(t.isDesktop()&&t.slave){n.DesktopApi.emit(q.onDialpadButtonClicked,[s])}else{t.callbacks.dialpadButtonClicked(s)}t.backgroundWorker.emitEvent(y.dialpadButtonClick,s)},onClose:function e(){t.keypad.destroy();t.keypad=null}});this.keypad.show()}},{key:"_onHangupButtonClick",value:function e(){this.backgroundWorker.emitEvent(y.hangupButtonClick);if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onHangup,[])}else{this.callbacks.hangup()}}},{key:"_onCloseButtonClick",value:function e(){this.backgroundWorker.emitEvent(y.closeButtonClick);if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onClose,[])}else{this.close()}}},{key:"_onMakeCallButtonClick",value:function e(){var t=this;this.backgroundWorker.emitEvent(y.makeCallButtonClick);var i={};if(this.callListId>0){this.callingEntity=this.currentEntity;if(this.currentEntity.phones.length===0){this.keypad=new h({bindElement:this.elements.buttons.call?this.elements.buttons.call:null,onClose:function e(){t.keypad.destroy();t.keypad=null},onDial:function e(s){t.keypad.close();t.phoneNumber=s.phoneNumber;t.createTitle().then((function(e){return t.setTitle(e)}));i={phoneNumber:s.phoneNumber,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId,callListId:t.callListId};if(t.isDesktop()&&t.slave){n.DesktopApi.emit(q.onCallListMakeCall,[i])}else{t.callbacks.callListMakeCall(i)}}});this.keypad.show()}else if(this.currentEntity.phones.length==1){i.phoneNumber=this.currentEntity.phones[0].VALUE;i.crmEntityType=this.crmEntityType;i.crmEntityId=this.crmEntityId;i.callListId=this.callListId;if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onCallListMakeCall,[i])}else{this.callbacks.callListMakeCall(i)}}else{this.showNumberSelectMenu({bindElement:this.elements.buttons.call?this.elements.buttons.call:null,phoneNumbers:this.currentEntity.phones,onSelect:function e(s){t.closeNumberSelectMenu();t.phoneNumber=s.phoneNumber;t.createTitle().then((function(e){return t.setTitle(e)}));i={phoneNumber:s.phoneNumber,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId,callListId:t.callListId};if(t.isDesktop()&&t.slave){n.DesktopApi.emit(q.onCallListMakeCall,[i])}else{t.callbacks.callListMakeCall(i)}}})}}else{if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onMakeCall,[this.phoneNumber])}else{this.callbacks.makeCall(this.phoneNumber)}}}},{key:"_onNextButtonClick",value:function e(){if(!this.callListView){return}this.backgroundWorker.emitEvent(y.nextButtonClick);this.setUiState(F.outgoing);this.callListView.moveToNextItem();this.setStatusText("")}},{key:"_onRedialButtonClick",value:function e(t){}},{key:"_onCommentChanged",value:function e(){this.comment=this.elements.commentEditor.value;this.updateAutoCloseTimer()}},{key:"_onAddCommentButtonClick",value:function e(){this.commentShown=!this.commentShown;if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onCommentShown,[this.commentShown])}if(this.commentShown){if(this.elements.crmButtons.addComment){s.Dom.addClass(this.elements.crmButtons.addComment,"im-phone-call-crm-button-active");this.elements.crmButtons.addCommentLabel.innerText=s.Loc.getMessage("IM_PHONE_CALL_VIEW_SAVE")}if(this.elements.commentEditor){this.elements.commentEditor.value=this.comment;this.elements.commentEditor.focus()}if(this.elements.commentEditorContainer){this.elements.commentEditorContainer.style.removeProperty("display")}}else{if(this.elements.crmButtons.addComment){s.Dom.removeClass(this.elements.crmButtons.addComment,"im-phone-call-crm-button-active");this.elements.crmButtons.addCommentLabel.innerText=s.Loc.getMessage("IM_PHONE_ACTION_CRM_COMMENT")}if(this.elements.commentEditorContainer){this.elements.commentEditorContainer.style.display="none"}if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onSaveComment,[this.comment])}else{this.saveComment()}this.backgroundWorker.emitEvent(y.addCommentButtonClick,this.comment)}}},{key:"_onAddDealButtonClick",value:function e(){var t=this._getCrmEditUrl("DEAL",0);var i=this._generateExternalContext();if(this.crmEntityType==="CONTACT"){t=s.Uri.addParam(t,{contact_id:this.crmEntityId})}else if(this.crmEntityType==="COMPANY"){t=s.Uri.addParam(t,{company_id:this.crmEntityId})}t=s.Uri.addParam(t,{external_context:i});if(this.callListId>0){t=s.Uri.addParam(t,{call_list_id:this.callListId});t=s.Uri.addParam(t,{call_list_element:this.currentEntity.id})}this.externalRequests[i]={type:"add",context:i,window:window.open(t)}}},{key:"_onAddInvoiceButtonClick",value:function e(){var t=this._getCrmEditUrl("INVOICE",0);var i=this._generateExternalContext();t=s.Uri.addParam(t,{redirect:"y"});if(this.crmEntityType==="CONTACT"){t=s.Uri.addParam(t,{contact:this.crmEntityId})}else if(this.crmEntityType==="COMPANY"){t=s.Uri.addParam(t,{company:this.crmEntityId})}t=s.Uri.addParam(t,{external_context:i});if(this.callListId>0){t=s.Uri.addParam(t,{call_list_id:this.callListId});t=s.Uri.addParam(t,{call_list_element:this.currentEntity.id})}this.externalRequests[i]={type:"add",context:i,window:window.open(t)}}},{key:"_onAddLeadButtonClick",value:function e(){var t=this._getCrmEditUrl("LEAD",0);t=s.Uri.addParam(t,{phone:this.phoneNumber,origin_id:"VI_"+this.callId});window.open(t)}},{key:"_onAddContactButtonClick",value:function e(){var t=this._getCrmEditUrl("CONTACT",0);t=s.Uri.addParam(t,{phone:this.phoneNumber,origin_id:"VI_"+this.callId});window.open(t)}},{key:"_onFoldButtonClick",value:function e(){this.fold()}},{key:"_onAnswerButtonClick",value:function e(){this.backgroundWorker.emitEvent(y.answerButtonClick);if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onAnswer,[])}else{this.callbacks.answer()}}},{key:"_onSkipButtonClick",value:function e(){this.backgroundWorker.emitEvent(y.skipButtonClick);if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onSkip,[])}else{this.callbacks.skip()}}},{key:"_onSwitchDeviceButtonClick",value:function e(){if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onSwitchDevice,[{phoneNumber:this.phoneNumber}])}else{this.callbacks.switchDevice({phoneNumber:this.phoneNumber})}}},{key:"_onQualityMeterClick",value:function e(){var t=this;this.showQualityPopup({onSelect:function e(i){t.backgroundWorker.emitEvent(y.qualityMeterClick,i);t.qualityGrade=i;t.closeQualityPopup();if(t.isDesktop()&&t.slave){n.DesktopApi.emit(q.onQualityGraded,[i])}else{t.callbacks.qualityGraded(i)}}})}},{key:"_onPullEventCrm",value:function e(t,i){if(t==="external_event"){if(i.NAME==="onCrmEntityCreate"&&i.IS_CANCELED==false){var s=i.PARAMS;if(this.externalRequests[s.context]){var n=s.entityTypeName;var l=s.entityInfo.id;if(this.callListView){var a=this.callListView.getCurrentElement()}}}}}},{key:"onCallListSelectedItem",value:function e(t){var i=this;this.currentEntity=t;this.crmEntityType=t.type;this.crmEntityId=t.id;this.comment="";if(s.Type.isArray(t.bindings)){this.crmBindings=t.bindings.map((function(e){return{ENTITY_TYPE:e.type,ENTITY_ID:e.id}}))}else{this.crmBindings=[]}if(t.phones.length>0){this.phoneNumber=t.phones[0].VALUE}else{this.phoneNumber="unknown"}this.createTitle().then((function(e){return i.setTitle(e)}));this.loadCrmCard(t.type,t.id);if(this.currentTabName==="webform"){this.formManager.unload();this.formManager.load({id:this.webformId,secCode:this.webformSecCode,lang:s.Loc.getMessage("LANGUAGE_ID")})}if(this._uiState===F.redial){this.setUiState(F.outgoing)}this.updateView()}},{key:"showCallIcon",value:function e(){if(!this.callListView){return}if(!this.callingEntity){return}this.callListView.setCallingElement(this.callingEntity.statusId,this.callingEntity.index)}},{key:"hideCallIcon",value:function e(){if(!this.callListView){return}this.callListView.resetCallingElement()}},{key:"isTimerStarted",value:function e(){return!!this.timerInterval}},{key:"startTimer",value:function e(){if(this.isTimerStarted()){return}if(this.initialTimestamp===0){this.initialTimestamp=(new Date).getTime()}this.timerInterval=setInterval(this.renderTimer.bind(this),1e3);this.renderTimer()}},{key:"renderTimer",value:function e(){if(!this.elements.timer){return}var t=(new Date).getTime();var i=t-this.initialTimestamp;var n=Math.floor(i/1e3);var l=Math.floor(n/60).toString();if(l.length<2){l="0"+l}var a=(n%60).toString();if(a.length<2){a="0"+a}var o=this.isRecording()?s.Loc.getMessage("IM_PHONE_TIMER_WITH_RECORD"):s.Loc.getMessage("IM_PHONE_TIMER_WITHOUT_RECORD");if(this.isFolded()){this.elements.timer.innerText=l+":"+a}else{this.elements.timer.innerText=o.replace("#MIN#",l).replace("#SEC#",a)}}},{key:"stopTimer",value:function e(){if(!this.isTimerStarted()){return}clearInterval(this.timerInterval);this.timerInterval=null}},{key:"showQualityPopup",value:function e(t){var i=this;if(!s.Type.isPlainObject(t)){t={}}if(!s.Type.isFunction(t.onSelect)){t.onSelect=r}var n={1:null,2:null,3:null,4:null,5:null};this.qualityPopup=new l.Popup({id:"PhoneCallViewQualityGrade",bindElement:this.elements.qualityMeter,targetContainer:document.body,darkMode:true,closeByEsc:true,autoHide:true,zIndex:o+200,noAllPaddings:true,overlay:{backgroundColor:"white",opacity:0},bindOptions:{position:"top"},angle:{position:"bottom",offset:30},cacheable:false,content:s.Dom.create("div",{props:{className:"im-phone-popup-rating"},children:[s.Dom.create("div",{props:{className:"im-phone-popup-rating-title"},text:s.Loc.getMessage("IM_PHONE_CALL_VIEW_RATE_QUALITY")}),s.Dom.create("div",{props:{className:"im-phone-popup-rating-stars"},children:[n["1"]=te(1,this.qualityGrade=="1",t.onSelect),n["2"]=te(2,this.qualityGrade=="2",t.onSelect),n["3"]=te(3,this.qualityGrade=="3",t.onSelect),n["4"]=te(4,this.qualityGrade=="4",t.onSelect),n["5"]=te(5,this.qualityGrade=="5",t.onSelect)],events:{mouseover:function e(){if(n[i.qualityGrade]){s.Dom.removeClass(n[i.qualityGrade],"im-phone-popup-rating-stars-item-active")}},mouseout:function e(){if(n[i.qualityGrade]){s.Dom.addClass(n[i.qualityGrade],"im-phone-popup-rating-stars-item-active")}}}})]}),events:{onPopupClose:function e(){return i.qualityPopup=null}}});this.qualityPopup.show()}},{key:"closeQualityPopup",value:function e(){if(this.qualityPopup){this.qualityPopup.close()}}},{key:"saveComment",value:function e(){this.callbacks.saveComment({callId:this.callId,comment:this.comment})}},{key:"showNumberSelectMenu",value:function e(t){var i=this;var n=[];if(!s.Type.isPlainObject(t)){t={}}if(!s.Type.isArray(t.phoneNumbers)){return}t.onSelect=s.Type.isFunction(t.onSelect)?t.onSelect:BX.DoNothing;t.phoneNumbers.forEach((function(e){n.push({id:"number-select-"+BX.util.getRandomString(10),text:e.VALUE,onclick:function i(){t.onSelect({phoneNumber:e.VALUE})}})}));this.numberSelectMenu=new l.Menu("im-phone-call-view-number-select",t.bindElement,n,{autoHide:true,offsetTop:0,offsetLeft:40,angle:{position:"top"},zIndex:o+200,closeByEsc:true,overlay:{backgroundColor:"white",opacity:0},events:{onPopupClose:function e(){return i.numberSelectMenu.destroy()},onPopupDestroy:function e(){return i.numberSelectMenu=null}}});this.numberSelectMenu.show()}},{key:"closeNumberSelectMenu",value:function e(){if(this.numberSelectMenu){this.numberSelectMenu.close()}}},{key:"fold",value:function e(){if(!this.canBeFolded()){return false}if(this.callListId>0&&this.callState===W.idle){this.foldCallView()}else{this.foldCall()}}},{key:"unfold",value:function e(){if(!this.isDesktop()&&this.isFolded()){s.Dom.remove(this.elements.main);this.folded=false;this.elements=this.unfoldedElements;this.show()}}},{key:"foldCall",value:function e(){var t=this;if(this.isDesktop()||!this.popup){return}var i=this.popup.getPopupContainer();var n=this.popup.overlay.element;s.Dom.addClass(i,"im-phone-call-view-folding");s.Dom.addClass(n,"popup-window-overlay-im-phone-call-view-folding");setTimeout((function(){t.folded=true;t.popup.close();t.unfoldedElements=t.elements;s.Dom.removeClass(i,"im-phone-call-view-folding");s.Dom.removeClass(n,"popup-window-overlay-im-phone-call-view-folding");t.reinit();t.enableDocumentScroll()}),300)}},{key:"foldCallView",value:function e(){var t=this;var i=this.popup.getPopupContainer();var n=this.popup.overlay.element;s.Dom.addClass(i,"im-phone-call-view-folding");s.Dom.addClass(n,"popup-window-overlay-im-phone-call-view-folding");setTimeout((function(){t.close();t.foldedCallView.fold({callListId:t.callListId,webformId:t.webformId,webformSecCode:t.webformSecCode,currentItemIndex:t.callListView.currentItemIndex,currentItemStatusId:t.callListView.currentStatusId,statusList:t.callListView.statuses,entityType:t.callListView.entityType},true)}),300)}},{key:"bindSlaveDesktopEvents",value:function e(){var t=this;n.DesktopApi.subscribe(q.setTitle,this.setTitle.bind(this));n.DesktopApi.subscribe(q.setStatus,this.setStatusText.bind(this));n.DesktopApi.subscribe(q.setUiState,this.setUiState.bind(this));n.DesktopApi.subscribe(q.setDeviceCall,this.setDeviceCall.bind(this));n.DesktopApi.subscribe(q.setCrmEntity,this.setCrmEntity.bind(this));n.DesktopApi.subscribe(q.reloadCrmCard,this.reloadCrmCard.bind(this));n.DesktopApi.subscribe(q.setPortalCall,this.setPortalCall.bind(this));n.DesktopApi.subscribe(q.setPortalCallUserId,this.setPortalCallUserId.bind(this));n.DesktopApi.subscribe(q.setPortalCallQueueName,this.setPortalCallQueueName.bind(this));n.DesktopApi.subscribe(q.setPortalCallData,this.setPortalCallData.bind(this));n.DesktopApi.subscribe(q.setConfig,this.setConfig.bind(this));n.DesktopApi.subscribe(q.setCallId,this.setCallId.bind(this));n.DesktopApi.subscribe(q.setLineNumber,this.setLineNumber.bind(this));n.DesktopApi.subscribe(q.setCompanyPhoneNumber,this.setCompanyPhoneNumber.bind(this));n.DesktopApi.subscribe(q.setPhoneNumber,this.setPhoneNumber.bind(this));n.DesktopApi.subscribe(q.setTransfer,this.setTransfer.bind(this));n.DesktopApi.subscribe(q.setCallState,this.setCallState.bind(this));n.DesktopApi.subscribe(q.closeWindow,(function(){return window.close()}));BX.bind(window,"beforeunload",(function(){BX.unbindAll(window,"beforeunload");n.DesktopApi.emit(q.onBeforeUnload,[])}));BX.bind(window,"resize",s.Runtime.debounce((function(){if(t.skipOnResize){t.skipOnResize=false;return}t.saveInitialSize(window.innerWidth,window.innerHeight)}),100));BX.addCustomEvent("SidePanel.Slider:onOpen",(function(e){if(!e.getSlider().isSelfContained()){e.denyAction();window.open(e.slider.url)}}))}},{key:"bindMasterDesktopEvents",value:function e(){var t=this;n.DesktopApi.subscribe(q.onHold,(function(){return t.callbacks.hold()}));n.DesktopApi.subscribe(q.onUnHold,(function(){return t.callbacks.unhold()}));n.DesktopApi.subscribe(q.onMute,(function(){return t.callbacks.mute()}));n.DesktopApi.subscribe(q.onUnMute,(function(){return t.callbacks.unmute()}));n.DesktopApi.subscribe(q.onMakeCall,(function(e){return t.callbacks.makeCall(e)}));n.DesktopApi.subscribe(q.onCallListMakeCall,(function(e){return t.callbacks.callListMakeCall(e)}));n.DesktopApi.subscribe(q.onAnswer,(function(){return t.callbacks.answer()}));n.DesktopApi.subscribe(q.onSkip,(function(){return t.callbacks.skip()}));n.DesktopApi.subscribe(q.onHangup,(function(){return t.callbacks.hangup()}));n.DesktopApi.subscribe(q.onClose,(function(){return t.close()}));n.DesktopApi.subscribe(q.onStartTransfer,(function(e){return t.callbacks.transfer(e)}));n.DesktopApi.subscribe(q.onCompleteTransfer,(function(){return t.callbacks.completeTransfer()}));n.DesktopApi.subscribe(q.onCancelTransfer,(function(){return t.callbacks.cancelTransfer()}));n.DesktopApi.subscribe(q.onSwitchDevice,(function(e){return t.callbacks.switchDevice(e)}));n.DesktopApi.subscribe(q.onBeforeUnload,(function(){t.desktop.window=null;t.callbacks.hangup();t.callbacks.close()}));n.DesktopApi.subscribe(q.onQualityGraded,(function(e){return t.callbacks.qualityGraded(e)}));n.DesktopApi.subscribe(q.onDialpadButtonClicked,(function(e){return t.callbacks.dialpadButtonClicked(e)}));n.DesktopApi.subscribe(q.onCommentShown,(function(e){return t.commentShown=e}));n.DesktopApi.subscribe(q.onSaveComment,(function(e){t.comment=e;t.saveComment()}));n.DesktopApi.subscribe(q.onSetAutoClose,(function(e){return t.autoClose=e}))}},{key:"unbindDesktopEvents",value:function e(){for(var t in q){if(q.hasOwnProperty(t)){n.DesktopApi.unsubscribe(q[t])}}}},{key:"isDesktop",value:function e(){return this._isDesktop}},{key:"isFolded",value:function e(){return this.folded}},{key:"canBeFolded",value:function e(){return this.allowAutoClose&&(this.callState===W.connected||this.callState===W.idle&&this.callListId>0)}},{key:"getFoldedHeight",value:function e(){if(!this.folded){return 0}if(!this.elements.main){return 0}return this.elements.main.clientHeight+(this.elements.sections.status?this.elements.sections.status.clientHeight:0)}},{key:"isWebformSupported",value:function e(){return!this.isDesktop()||this.desktop.isFeatureSupported("iframe")}},{key:"isRestAppsSupported",value:function e(){return!this.isDesktop()||this.desktop.isFeatureSupported("iframe")}},{key:"setClosable",value:function e(t){t=t===true;this.closable=t;if(this.isDesktop());else if(this.popup){this.popup.setClosingByEsc(t)}}},{key:"isClosable",value:function e(){return this.closable}},{key:"adjust",value:function e(){if(this.popup){this.popup.adjustPosition()}if(this.isDesktop()&&this.slave){if(this.currentLayout==G.simple){this.desktop.setResizable(false)}else{this.desktop.setResizable(true);this.desktop.setMinSize(this.elements.sidebarContainer?900:550,650)}this.desktop.center()}}},{key:"resizeWindow",value:function e(t,i){if(!this.isDesktop()||!this.slave){return false}this.skipOnResize=true;this.desktop.resize(t,i)}},{key:"close",value:function e(){var t=this;BX.onCustomEvent(window,"CallCard::BeforeClose",[]);if(this.isFolded()&&this.elements.main){s.Dom.addClass(this.elements.main,"im-phone-call-panel-mini-closing");setTimeout((function(){s.Dom.remove(t.elements.main);t.elements=t.getInitialElements()}),300)}if(this.popup){this.popup.close()}if(this.desktop.window){n.DesktopApi.emit(q.closeWindow,[])}this.enableDocumentScroll();this.callbacks.close();BX.onCustomEvent(window,"CallCard::AfterClose",[])}},{key:"disableAutoClose",value:function e(){this.allowAutoClose=false;if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onSetAutoClose,[this.allowAutoClose])}this.renderButtons();this.updateAutoCloseTimer()}},{key:"enableAutoClose",value:function e(){this.allowAutoClose=true;if(this.isDesktop()&&this.slave){n.DesktopApi.emit(q.onSetAutoClose,[this.allowAutoClose])}this.renderButtons();if(this.autoCloseTimer){clearTimeout(this.autoCloseTimer);this.autoCloseTimer=null;this.autoCloseAfterTimeout()}}},{key:"autoClose",value:function e(){var t=this;if(this.allowAutoClose&&!this.commentShown){this.close()}else{BX.onCustomEvent(window,"CallCard::BeforeClose",[]);this.autoCloseTimer=setTimeout((function(){return t.autoCloseAfterTimeout()}),this.autoCloseTimeout)}}},{key:"autoCloseAfterTimeout",value:function e(){console.log("Auto close after timeout",this.commentShown,this.autoCloseTimer,BX.localStorage.get(Y.currentCall));if(this.commentShown){this._onAddCommentButtonClick()}if(!BX.localStorage.get(Y.currentCall)){this.close()}this.autoCloseTimer=null}},{key:"updateAutoCloseTimer",value:function e(){var t=this;if(this.autoCloseTimer){clearTimeout(this.autoCloseTimer);this.autoCloseTimer=setTimeout((function(){return t.autoCloseAfterTimeout()}),this.autoCloseTimeout)}}},{key:"disableDocumentScroll",value:function e(){var t=window.innerWidth-document.documentElement.clientWidth;document.body.style.setProperty("padding-right",t+"px");document.body.classList.add("im-phone-call-disable-scroll");var i=document.getElementById("bx-im-bar");if(i){i.style.setProperty("right",t+"px")}}},{key:"enableDocumentScroll",value:function e(){document.body.classList.remove("im-phone-call-disable-scroll");document.body.style.removeProperty("padding-right");var t=document.getElementById("bx-im-bar");if(t){t.style.removeProperty("right")}}},{key:"dispose",value:function e(){var t=this;window.removeEventListener("beforeunload",this._onBeforeUnloadHandler);BX.removeCustomEvent("onPullEvent-crm",this._onPullEventCrmHandler);this.unloadRestApps();this.unloadForm();if(this.isFolded()&&this.elements.main){s.Dom.addClass(this.elements.main,"im-phone-call-panel-mini-closing");setTimeout((function(){return s.Dom.remove(t.elements.main)}),300)}if(this.backgroundWorker){this.backgroundWorker.setCallCard(null);this.backgroundWorker=null}if(this.popup){this.popup.destroy();this.popup=null}if(this.qualityPopup){this.qualityPopup.close()}if(this.keypad){this.keypad.close()}if(this.numberSelectMenu){this.closeNumberSelectMenu()}this.enableDocumentScroll();if(this.isDesktop()){this.unbindDesktopEvents();if(this.desktop.window){n.DesktopApi.emit(q.closeWindow,[]);this.desktop.window=null}if(!this.slave){window.removeEventListener("beforeunload",babelHelpers.classPrivateFieldGet(this,J))}}else{window.removeEventListener("beforeunload",this._onBeforeUnloadHandler)}if(!BX.localStorage.get(Y.callInited)&&!BX.localStorage.get(Y.externalCall)){BX.localStorage.remove(Y.callView)}}},{key:"canBeUnloaded",value:function e(){if(this.backgroundWorker.isUsed()){return false}return this.allowAutoClose&&this.isFolded()}},{key:"isCallListMode",value:function e(){return this.callListId>0}},{key:"getState",value:function e(){return{callId:this.callId,folded:this.folded,uiState:this._uiState,phoneNumber:this.phoneNumber,companyPhoneNumber:this.companyPhoneNumber,direction:this.direction,fromUserId:this.fromUserId,toUserId:this.toUserId,statusText:this.statusText,crm:this.crm,hasSipPhone:this.hasSipPhone,deviceCall:this.deviceCall,transfer:this.transfer,crmEntityType:this.crmEntityType,crmEntityId:this.crmEntityId,crmActivityId:this.crmActivityId,crmActivityEditUrl:this.crmActivityEditUrl,callListId:this.callListId,callListStatusId:this.callListStatusId,callListItemIndex:this.callListItemIndex,config:this.config?this.config:"{}",portalCall:this.portalCall?"true":"false",portalCallData:this.portalCallData?this.portalCallData:"{}",portalCallUserId:this.portalCallUserId,webformId:this.webformId,webformSecCode:this.webformSecCode,initialTimestamp:this.initialTimestamp,crmData:this.crmData}}},{key:"selectTransferTarget",value:function e(t){var i=this;t=s.Type.isFunction(t)?t:BX.DoNothing;s.Runtime.loadExtension("ui.entity-selector").then((function(e){var s=i.backgroundWorker.isUsed()?i.getDialogConfigForBackgroundApp(t):i.getDefaultDialogConfig(t);var n=e.Dialog;var l=new n(s);l.show()}))}},{key:"getDialogConfigForBackgroundApp",value:function e(t){var i=this;return{targetNode:this.elements.buttons.transfer,multiple:false,cacheable:false,hideOnSelect:false,enableSearch:true,entities:[{id:"user",options:{inviteEmployeeLink:false,selectFields:["personalPhone","personalMobile","workPhone"]}},{id:"department"}],events:{"Item:onSelect":function e(s){s.target.deselectAll();var n=s.data.item;if(n.getEntityId()==="user"){var l=n.getCustomData();if(l.get("personalPhone")||l.get("personalMobile")||l.get("workPhone")){i.showTransferToUserMenu({userId:n.getId(),customData:Object.fromEntries(l),darkMode:i.darkMode,onSelect:function e(n){s.target.hide();t({phoneNumber:i.phoneNumber,target:n.target})}})}else{s.target.hide();t({phoneNumber:i.phoneNumber,target:n.getId()})}}}}}}},{key:"getDefaultDialogConfig",value:function e(t){var i=this;return{targetNode:this.elements.buttons.transfer,multiple:false,cacheable:false,hideOnSelect:false,enableSearch:true,entities:[{id:"user",options:{inviteEmployeeLink:false,selectFields:["personalPhone","personalMobile","workPhone"]}},{id:"department"},{id:"voximplant_group"}],events:{"Item:onSelect":function e(s){s.target.deselectAll();var n=s.data.item;if(n.getEntityId()==="user"){var l=n.getCustomData();if(l.get("personalPhone")||l.get("personalMobile")||l.get("workPhone")){i.showTransferToUserMenu({userId:n.getId(),customData:Object.fromEntries(l),darkMode:i.darkMode,onSelect:function e(i){s.target.hide();t(i)}})}else{s.target.hide();t({type:"user",target:n.getId()})}}else if(n.getEntityId()==="voximplant_group"){s.target.hide();t({type:"queue",target:n.getId()})}}}}}},{key:"showTransferToUserMenu",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=s.Type.isInteger(t.userId)?t.userId:0;var n=s.Type.isPlainObject(t.customData)?t.customData:{};var a=t.darkMode===true;var o=s.Type.isFunction(t.onSelect)?t.onSelect:r;var c;var h=function e(t){var i=t.currentTarget.dataset["type"];var s=t.currentTarget.dataset["target"];o({type:i,target:s});c.close()};var u=[{icon:"bx-messenger-menu-call-voice",text:s.Loc.getMessage("IM_PHONE_INNER_CALL"),dataset:{type:"user",target:i},onclick:h},{delimiter:true}];if(n["personalMobile"]){u.push({html:$(s.Loc.getMessage("IM_PHONE_PERSONAL_MOBILE"),s.Text.encode(n["personalMobile"])),dataset:{type:"pstn",target:n["personalMobile"]},onclick:h})}if(n["personalPhone"]){u.push({type:"call",html:$(s.Loc.getMessage("IM_PHONE_PERSONAL_PHONE"),s.Text.encode(n["personalPhone"])),dataset:{type:"pstn",target:n["personalPhone"]},onclick:h})}if(n["workPhone"]){u.push({html:$(s.Loc.getMessage("IM_PHONE_WORK_PHONE"),s.Text.encode(n["workPhone"])),dataset:{type:"pstn",target:n["workPhone"]},onclick:h})}c=new l.Menu({id:"bx-messenger-phone-transfer-menu",bindElement:null,targetContainer:document.body,darkMode:a,lightShadow:true,autoHide:true,closeByEsc:true,cacheable:false,overlay:{backgroundColor:"#FFFFFF",opacity:0},items:u});c.show()}}]);return e}();function $(e,t){return'<div class="transfer-menu-item-surtitle">'.concat(s.Text.encode(e),'</div><div class="transfer-menu-item-text">').concat(s.Text.encode(t),"</div>")}function ee(e,t,i){var n={};if(s.Type.isStringFilled(e)){n.text=e}if(s.Type.isStringFilled(t)){n.props={className:t}}if(s.Type.isFunction(i)){n.events={click:i}}return s.Dom.create("span",n)}function te(e,t,i){return s.Dom.create("div",{props:{className:"im-phone-popup-rating-stars-item "+(t?"im-phone-popup-rating-stars-item-active":"")},dataset:{grade:e},events:{click:function e(t){t.preventDefault();var s=t.currentTarget.dataset.grade;i(s)}}})}function ie(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */ie=function t(){return e};var e={},t=Object.prototype,i=t.hasOwnProperty,s=Object.defineProperty||function(e,t,i){e[t]=i.value},n="function"==typeof Symbol?Symbol:{},l=n.iterator||"@@iterator",a=n.asyncIterator||"@@asyncIterator",o=n.toStringTag||"@@toStringTag";function r(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{r({},"")}catch(e){r=function e(t,i,s){return t[i]=s}}function c(e,t,i,n){var l=t&&t.prototype instanceof d?t:d,a=Object.create(l.prototype),o=new E(n||[]);return s(a,"_invoke",{value:k(e,i,o)}),a}function h(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var u={};function d(){}function p(){}function m(){}var f={};r(f,l,(function(){return this}));var C=Object.getPrototypeOf,v=C&&C(C(S([])));v&&v!==t&&i.call(v,l)&&(f=v);var b=m.prototype=d.prototype=Object.create(f);function g(e){["next","throw","return"].forEach((function(t){r(e,t,(function(e){return this._invoke(t,e)}))}))}function y(e,t){function n(s,l,a,o){var r=h(e[s],e,l);if("throw"!==r.type){var c=r.arg,u=c.value;return u&&"object"==babelHelpers["typeof"](u)&&i.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,a,o)}),(function(e){n("throw",e,a,o)})):t.resolve(u).then((function(e){c.value=e,a(c)}),(function(e){return n("throw",e,a,o)}))}o(r.arg)}var l;s(this,"_invoke",{value:function e(i,s){function a(){return new t((function(e,t){n(i,s,e,t)}))}return l=l?l.then(a,a):a()}})}function k(e,t,i){var s="suspendedStart";return function(n,l){if("executing"===s)throw new Error("Generator is already running");if("completed"===s){if("throw"===n)throw l;return L()}for(i.method=n,i.arg=l;;){var a=i.delegate;if(a){var o=I(a,i);if(o){if(o===u)continue;return o}}if("next"===i.method)i.sent=i._sent=i.arg;else if("throw"===i.method){if("suspendedStart"===s)throw s="completed",i.arg;i.dispatchException(i.arg)}else"return"===i.method&&i.abrupt("return",i.arg);s="executing";var r=h(e,t,i);if("normal"===r.type){if(s=i.done?"completed":"suspendedYield",r.arg===u)continue;return{value:r.arg,done:i.done}}"throw"===r.type&&(s="completed",i.method="throw",i.arg=r.arg)}}}function I(e,t){var i=t.method,s=e.iterator[i];if(undefined===s)return t.delegate=null,"throw"===i&&e.iterator["return"]&&(t.method="return",t.arg=undefined,I(e,t),"throw"===t.method)||"return"!==i&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+i+"' method")),u;var n=h(s,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,u;var l=n.arg;return l?l.done?(t[e.resultName]=l.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=undefined),t.delegate=null,u):l:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,u)}function w(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function E(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(w,this),this.reset(!0)}function S(e){if(e){var t=e[l];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var s=-1,n=function t(){for(;++s<e.length;)if(i.call(e,s))return t.value=e[s],t.done=!1,t;return t.value=undefined,t.done=!0,t};return n.next=n}}return{next:L}}function L(){return{value:undefined,done:!0}}return p.prototype=m,s(b,"constructor",{value:m,configurable:!0}),s(m,"constructor",{value:p,configurable:!0}),p.displayName=r(m,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,r(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},g(y.prototype),r(y.prototype,a,(function(){return this})),e.AsyncIterator=y,e.async=function(t,i,s,n,l){void 0===l&&(l=Promise);var a=new y(c(t,i,s,n),l);return e.isGeneratorFunction(i)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},g(b),r(b,o,"Generator"),r(b,l,(function(){return this})),r(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),i=[];for(var s in t)i.push(s);return i.reverse(),function e(){for(;i.length;){var s=i.pop();if(s in t)return e.value=s,e.done=!1,e}return e.done=!0,e}},e.values=S,E.prototype={constructor:E,reset:function e(t){if(this.prev=0,this.next=0,this.sent=this._sent=undefined,this.done=!1,this.delegate=null,this.method="next",this.arg=undefined,this.tryEntries.forEach(T),!t)for(var s in this)"t"===s.charAt(0)&&i.call(this,s)&&!isNaN(+s.slice(1))&&(this[s]=undefined)},stop:function e(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function e(t){if(this.done)throw t;var s=this;function n(e,i){return o.type="throw",o.arg=t,s.next=e,i&&(s.method="next",s.arg=undefined),!!i}for(var l=this.tryEntries.length-1;l>=0;--l){var a=this.tryEntries[l],o=a.completion;if("root"===a.tryLoc)return n("end");if(a.tryLoc<=this.prev){var r=i.call(a,"catchLoc"),c=i.call(a,"finallyLoc");if(r&&c){if(this.prev<a.catchLoc)return n(a.catchLoc,!0);if(this.prev<a.finallyLoc)return n(a.finallyLoc)}else if(r){if(this.prev<a.catchLoc)return n(a.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return n(a.finallyLoc)}}}},abrupt:function e(t,s){for(var n=this.tryEntries.length-1;n>=0;--n){var l=this.tryEntries[n];if(l.tryLoc<=this.prev&&i.call(l,"finallyLoc")&&this.prev<l.finallyLoc){var a=l;break}}a&&("break"===t||"continue"===t)&&a.tryLoc<=s&&s<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=t,o.arg=s,a?(this.method="next",this.next=a.finallyLoc,u):this.complete(o)},complete:function e(t,i){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&i&&(this.next=i),u},finish:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i];if(s.finallyLoc===t)return this.complete(s.completion,s.afterLoc),T(s),u}},catch:function e(t){for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i];if(s.tryLoc===t){var n=s.completion;if("throw"===n.type){var l=n.arg;T(s)}return l}}throw new Error("illegal catch attempt")},delegateYield:function e(t,i,s){return this.delegate={iterator:S(t),resultName:i,nextLoc:s},"next"===this.method&&(this.arg=undefined),u}},e}function se(e,t){ne(e,t);t.add(e)}function ne(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function le(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var ae={callInited:"viInitedCall",externalCall:"viExternalCard",vite:"vite",dialHistory:"vox-dial-history",foldedView:"vox-folded-call-card",callView:"bx-vox-call-view",currentCall:"bx-vox-current-call"};var oe={onCallCreated:"onCallCreated",onCallConnected:"onCallConnected",onCallDestroyed:"onCallDestroyed",onDeviceCallStarted:"onDeviceCallStarted"};var re={Webrtc:"WEBRTC",Phone:"PHONE"};var ce=new WeakSet;var he=new WeakSet;var ue=new WeakSet;var de=new WeakSet;var pe=new WeakSet;var me=new WeakSet;var fe=new WeakSet;var Ce=new WeakSet;var ve=new WeakSet;var be=new WeakSet;var ge=new WeakSet;var ye=new WeakSet;var ke=new WeakSet;var Ie=new WeakSet;var we=new WeakSet;var Te=new WeakSet;var Ee=new WeakSet;var Se=new WeakSet;var Le=new WeakSet;var _e=new WeakSet;var De=new WeakSet;var Ne=new WeakSet;var Me=new WeakSet;var Ae=new WeakSet;var Be=new WeakSet;var Pe=new WeakSet;var xe=new WeakSet;var Ve=new WeakSet;var He=new WeakSet;var Oe=new WeakSet;var Ue=new WeakSet;var Re=new WeakSet;var Fe=new WeakSet;var We=new WeakSet;var Xe=new WeakSet;var ze=new WeakSet;var Ge=new WeakSet;var je=new WeakSet;var Ye=new WeakSet;var qe=new WeakSet;var Ke=new WeakSet;var Qe=new WeakSet;var Je=new WeakSet;var Ze=new WeakSet;var $e=new WeakSet;var et=new WeakSet;var tt=new WeakSet;var it=new WeakSet;var st=new WeakSet;var nt=new WeakSet;var lt=new WeakSet;var at=function(e){babelHelpers.inherits(i,e);function i(e){var t;babelHelpers.classCallCheck(this,i);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this));se(babelHelpers.assertThisInitialized(t),lt);se(babelHelpers.assertThisInitialized(t),nt);se(babelHelpers.assertThisInitialized(t),st);se(babelHelpers.assertThisInitialized(t),it);se(babelHelpers.assertThisInitialized(t),tt);se(babelHelpers.assertThisInitialized(t),et);se(babelHelpers.assertThisInitialized(t),$e);se(babelHelpers.assertThisInitialized(t),Ze);se(babelHelpers.assertThisInitialized(t),Je);se(babelHelpers.assertThisInitialized(t),Qe);se(babelHelpers.assertThisInitialized(t),Ke);se(babelHelpers.assertThisInitialized(t),qe);se(babelHelpers.assertThisInitialized(t),Ye);se(babelHelpers.assertThisInitialized(t),je);se(babelHelpers.assertThisInitialized(t),Ge);se(babelHelpers.assertThisInitialized(t),ze);se(babelHelpers.assertThisInitialized(t),Xe);se(babelHelpers.assertThisInitialized(t),We);se(babelHelpers.assertThisInitialized(t),Fe);se(babelHelpers.assertThisInitialized(t),Re);se(babelHelpers.assertThisInitialized(t),Ue);se(babelHelpers.assertThisInitialized(t),Oe);se(babelHelpers.assertThisInitialized(t),He);se(babelHelpers.assertThisInitialized(t),Ve);se(babelHelpers.assertThisInitialized(t),xe);se(babelHelpers.assertThisInitialized(t),Pe);se(babelHelpers.assertThisInitialized(t),Be);se(babelHelpers.assertThisInitialized(t),Ae);se(babelHelpers.assertThisInitialized(t),Me);se(babelHelpers.assertThisInitialized(t),Ne);se(babelHelpers.assertThisInitialized(t),De);se(babelHelpers.assertThisInitialized(t),_e);se(babelHelpers.assertThisInitialized(t),Le);se(babelHelpers.assertThisInitialized(t),Se);se(babelHelpers.assertThisInitialized(t),Ee);se(babelHelpers.assertThisInitialized(t),Te);se(babelHelpers.assertThisInitialized(t),we);se(babelHelpers.assertThisInitialized(t),Ie);se(babelHelpers.assertThisInitialized(t),ke);se(babelHelpers.assertThisInitialized(t),ye);se(babelHelpers.assertThisInitialized(t),ge);se(babelHelpers.assertThisInitialized(t),be);se(babelHelpers.assertThisInitialized(t),ve);se(babelHelpers.assertThisInitialized(t),Ce);se(babelHelpers.assertThisInitialized(t),fe);se(babelHelpers.assertThisInitialized(t),me);se(babelHelpers.assertThisInitialized(t),pe);se(babelHelpers.assertThisInitialized(t),de);se(babelHelpers.assertThisInitialized(t),ue);se(babelHelpers.assertThisInitialized(t),he);se(babelHelpers.assertThisInitialized(t),ce);t.setEventNamespace("BX.Voximplant.PhoneCallsControllerOptions");t.subscribeFromOptions(e.events);t.debug=false;t.phoneEnabled=s.Type.isBoolean(e.phoneEnabled)?e.phoneEnabled:false;t.userId=e.userId;t.userEmail=e.userEmail;t.isAdmin=e.isAdmin;var n=BX.localStorage.get(ae.dialHistory);t.dialHistory=s.Type.isArray(n)?n:[];t.availableLines=s.Type.isArray(e.availableLines)?e.availableLines:[];t.defaultLineId=s.Type.isString(e.defaultLineId)?e.defaultLineId:"";t.callInterceptAllowed=e.canInterceptCall||false;t.restApps=e.restApps;t.hasSipPhone=e.deviceActive===true;t.skipIncomingCallTimer=null;t.hasActiveCallView=false;t.readDefaults();if(s.Browser.isLocalStorageSupported()){BX.addCustomEvent(window,"onLocalStorageSet",t.storageSet.bind(babelHelpers.assertThisInitialized(t)))}BX.addCustomEvent("onPullEvent-voximplant",le(babelHelpers.assertThisInitialized(t),ue,ct).bind(babelHelpers.assertThisInitialized(t)));t.onCallConnectedHandler=le(babelHelpers.assertThisInitialized(t),We,Ut).bind(babelHelpers.assertThisInitialized(t));t.onCallDisconnectedHandler=le(babelHelpers.assertThisInitialized(t),Ne,_t).bind(babelHelpers.assertThisInitialized(t));t.onCallFailedHandler=le(babelHelpers.assertThisInitialized(t),De,Lt).bind(babelHelpers.assertThisInitialized(t));t.onProgressToneStartHandler=le(babelHelpers.assertThisInitialized(t),Me,Dt).bind(babelHelpers.assertThisInitialized(t));t.onProgressToneStopHandler=le(babelHelpers.assertThisInitialized(t),Ae,Nt).bind(babelHelpers.assertThisInitialized(t));t.messengerFacade=e.messengerFacade;t.backgroundWorker=new k;t.foldedCallView=new N({events:babelHelpers.defineProperty({},N.Events.onUnfold,(function(e){var i=e.getData();t.startCallList(i.callListId,i.callListParams)}))});t.restoreFoldedCallView();BX.garbage((function(){if(t.hasActiveCall()&&t.callView&&t.callView.canBeUnloaded()&&(t.hasExternalCall||t.deviceType==="PHONE")){BX.localStorage.set(ae.foldedView,{callId:t.callId,phoneCrm:t.phoneCrm,deviceType:t.deviceType,hasExternalCall:t.hasExternalCall,callView:t.callView.getState()},15)}}));return t}babelHelpers.createClass(i,[{key:"hasActiveCall",value:function e(){return Boolean(this._currentCall||this.callView)}},{key:"ready",value:function e(){return true}},{key:"readDefaults",value:function(){var e=babelHelpers.asyncToGenerator(ie().mark((function e(){var t=this;var i,s;return ie().wrap((function e(n){while(1)switch(n.prev=n.next){case 0:if(localStorage){n.next=2;break}return n.abrupt("return");case 2:this.defaultMicrophone=localStorage.getItem("bx-im-settings-default-microphone");this.defaultCamera=localStorage.getItem("bx-im-settings-default-camera");this.defaultSpeaker=localStorage.getItem("bx-im-settings-default-speaker");this.enableMicAutoParameters=localStorage.getItem("bx-im-settings-enable-mic-auto-parameters")!=="N";if(!(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices||!this.defaultMicrophone)){n.next=8;break}return n.abrupt("return");case 8:n.next=10;return navigator.mediaDevices.enumerateDevices();case 10:i=n.sent;s=i.filter((function(e){return e.kind==="audioinput"&&e.deviceId===t.defaultMicrophone}));this.defaultMicrophone=s.length?this.defaultMicrophone:null;case 13:case"end":return n.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"correctPhoneNumber",value:function e(t){return t.toString().replace(/[^0-9+#*;,]/g,"")}},{key:"getCallParams",value:function e(){var t=s.Type.isPlainObject(this.phoneParams)?s.Runtime.clone(this.phoneParams):{};if(this.phoneFullNumber!=this.phoneNumber){t["FULL_NUMBER"]=this.phoneFullNumber}return JSON.stringify(t)}},{key:"phoneCallFinish",value:function e(){clearInterval(this.phoneConnectedInterval);clearInterval(this.phoneCallTimeInterval);BX.localStorage.remove(ae.callInited);this.callOverlayTimer("pause");this.showCallViewBalloon();if(this.currentCall){try{this.currentCall.hangup({"X-Disconnect-Code":200,"X-Disconnect-Reason":"Normal hangup"})}catch(e){}this.currentCall=null;this.phoneLog("Call hangup call")}else{this.scheduleApiDisconnect()}if(this.keypad){this.keypad.close()}BX.localStorage.set(ae.vite,false,1);this.phoneRinging=0;this.phoneIncoming=false;this.callActive=false;this.callId="";this.hasExternalCall=false;this.deviceType=re.Webrtc;this.phoneNumber="";this.phoneNumberUser="";this.phoneParams={};this.callOverlayOptions={};this.callSelfDisabled=false;this.isMuted=false;this.isCallHold=false;this.isCallTransfer=false;this.phoneMicAccess=false;this.phoneTransferTargetType="";this.phoneTransferTargetId=0;this.phoneTransferCallId="";this.phoneTransferEnabled=false}},{key:"phoneOnAuthResult",value:function e(){if(this.deviceType==re.Phone){return false}if(this.phoneIncoming){BX.rest.callMethod("voximplant.call.sendReady",{CALL_ID:this.callId})}else if(this.callInitUserId==this.userId){le(this,_e,St).call(this)}}},{key:"scheduleApiDisconnect",value:function e(){var t=this;if(this.voximplantClient&&this.voximplantClient.connected()){setTimeout((function(){if(t.voximplantClient&&t.voximplantClient.connected()){t.voximplantClient.disconnect()}}),500)}}},{key:"holdCall",value:function e(){this.toggleCallHold(true)}},{key:"unholdCall",value:function e(){this.toggleCallHold(false)}},{key:"toggleCallHold",value:function e(t){if(!this.currentCall&&this.deviceType==re.Webrtc){return false}if(typeof t!="undefined"){this.isCallHold=!t}if(this.isCallHold){if(this.deviceType===re.Webrtc){this.currentCall.sendMessage(JSON.stringify({COMMAND:"unhold"}))}else{BX.rest.callMethod("voximplant.call.unhold",{CALL_ID:this.callId})}}else{if(this.deviceType===re.Webrtc){this.currentCall.sendMessage(JSON.stringify({COMMAND:"hold"}))}else{BX.rest.callMethod("voximplant.call.hold",{CALL_ID:this.callId})}}this.isCallHold=!this.isCallHold}},{key:"sendDTMF",value:function e(t){if(!this.currentCall){return false}this.phoneLog("Send DTMF code",this.currentCall.id(),t);this.currentCall.sendTone(t)}},{key:"startCallViaRestApp",value:function e(t,i,s){BX.rest.callMethod("voximplant.call.startViaRest",{NUMBER:t,LINE_ID:i,PARAMS:s,SHOW:"Y"})}},{key:"phoneSupport",value:function e(){return this.phoneEnabled&&(this.hasSipPhone||this.ready())}},{key:"muteCall",value:function e(){if(!this.currentCall){return false}this.isMuted=true;this.currentCall.muteMicrophone()}},{key:"unmuteCall",value:function e(){if(!this.currentCall){return false}this.isMuted=false;this.currentCall.unmuteMicrophone()}},{key:"toggleCallAudio",value:function e(){if(!this.currentCall){return false}if(this.isMuted){this.currentCall.unmuteMicrophone();this.callView.setMuted(false)}else{this.currentCall.muteMicrophone()}this.isMuted=!this.isMuted}},{key:"phoneDeviceCall",value:function e(t){var i=true;if(typeof t=="boolean"){this.messengerFacade.setLocalConfig("viDeviceCallBlock",!t);BX.localStorage.set("viDeviceCallBlock",!t,86400);if(this.callView){this.callView.setDeviceCall(t)}}else{var s=this.messengerFacade.getLocalConfig("viDeviceCallBlock");if(!s){s=BX.localStorage.get("viDeviceCallBlock")}i=this.hasSipPhone&&!s}return i}},{key:"openKeyPad",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(s.Loc.getMessage["voximplantCanMakeCalls"]=="N"){s.Runtime.loadExtension("voximplant.common").then((function(){return BX.Voximplant.openLimitSlider()}));return}this.loadPhoneLines().then((function(){return le(t,Oe,xt).call(t,i)}))}},{key:"onKeyPadDial",value:function e(t){var i={};this.closeKeyPad();if(t.lineId){i["LINE_ID"]=t.lineId}this.phoneCall(t.phoneNumber,i)}},{key:"onKeyPadIntercept",value:function e(t){var i=this;if(!this.callInterceptAllowed){this.keypad.close();if("UI"in BX&&"InfoHelper"in BX.UI){BX.UI.InfoHelper.show("limit_contact_center_telephony_intercept")}return}BX.rest.callMethod("voximplant.call.intercept").then((function(e){var n=e.data();if(!n.FOUND||n.FOUND=="Y"){i.keypad.close()}else{if(n.ERROR){i.interceptErrorPopup=new l.Popup({id:"intercept-call-error",bindElement:t.interceptButton,targetContainer:document.body,content:s.Text.encode(n.ERROR),autoHide:true,closeByEsc:true,cacheable:false,bindOptions:{position:"bottom"},angle:{offset:40},events:{onPopupClose:function e(t){return i.interceptErrorPopup=null}}});i.interceptErrorPopup.show()}}}))}},{key:"onKeyPadClose",value:function e(){this.keypad=null}},{key:"closeKeyPad",value:function e(){if(this.keypad){this.keypad.close()}}},{key:"phoneDisplayExternal",value:function e(t){var i=t.phoneNumber;this.phoneLog(i,t);this.phoneNumberUser=s.Text.encode(i);i=this.correctPhoneNumber(i);if(babelHelpers["typeof"](t)!="object"){t={}}if(this.callActive){return}if(this.callView){return}this.initiator=true;this.callInitUserId=this.userId;this.callActive=false;this.callUserId=0;this.phoneNumber=i;this.callView=new Z({callId:t.callId,config:t.config,direction:R.outgoing,phoneNumber:this.phoneNumber,statusText:s.Loc.getMessage("IM_M_CALL_ST_CONNECT"),hasSipPhone:true,deviceCall:true,portalCall:t.portalCall,portalCallUserId:t.portalCallUserId,portalCallData:t.portalCallData,portalCallQueueName:t.portalCallQueueName,crm:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId,crmData:this.phoneCrm,foldedCallView:this.foldedCallView,backgroundWorker:this.backgroundWorker,messengerFacade:this.messengerFacade,restApps:this.restApps});le(this,Xe,Rt).call(this,this.callView);this.callView.setUiState(F.idle);this.callView.setCallState(W.connected);this.callView.show()}},{key:"loadPhoneLines",value:function e(){var t=this;var i=BX.localStorage.get("bx-im-phone-lines");if(i){this.phoneLines=i;return Promise.resolve(i)}return new Promise((function(e,i){if(t.phoneLines){return e(t.phoneLines)}BX.ajax.runAction("voximplant.callView.getLines").then((function(i){t.phoneLines=i.data;BX.localStorage.set("bx-im-phone-lines",t.phoneLines,86400);{e(t.phoneLines)}}))["catch"]((function(e){console.error(e);i(e)}))}))}},{key:"isRestLine",value:function e(t){if(!this.phoneLines){throw new Error("Phone lines are not loaded. Call PhoneCallsController.loadPhoneLines prior to using this method")}if(this.phoneLines.hasOwnProperty(t)){return this.phoneLines[t].TYPE==="REST"}else{return false}}},{key:"setPhoneNumber",value:function e(t){var i=/(\+?\d+)([;#]*)([\d,]*)/.exec(t);this.phoneFullNumber=t;if(i){this.phoneNumber=i[1]}}},{key:"phoneCall",value:function e(t,i){var s=this;this.loadPhoneLines().then((function(){return le(s,Ue,Vt).call(s,t,i)}))}},{key:"showUnsupported",value:function e(){var i=new a.MessageBox({message:s.Loc.getMessage("IM_CALL_NO_WEBRT"),buttons:a.MessageBoxButtons.OK_CANCEL,okCaption:s.Loc.getMessage("IM_M_CALL_BTN_DOWNLOAD"),cancelCaption:s.Loc.getMessage("IM_NOTIFY_CONFIRM_CLOSE"),onOk:function e(){var i=t.DesktopDownload.getLinkForCurrentUser();window.open(i,"desktopApp");return true}});i.show()}},{key:"addToHistory",value:function e(t){var i=this.dialHistory;var s=i.indexOf(t);if(s===0);else if(s>0){i.splice(s,s);this.dialHistory=[t].concat(i)}else{this.dialHistory=[t].concat(i.slice(0,4))}BX.localStorage.set(ae.dialHistory,this.dialHistory,31536e3);this.messengerFacade.setLocalConfig("phone-history",this.dialHistory)}},{key:"startCallList",value:function e(t,i){t=Number(t);if(t===0||this.currentCall||this.callView||this.isCallListMode()){return false}this.foldedCallView.destroy();this.callListId=t;this.callView=new Z({crm:true,callListId:t,callListStatusId:i.callListStatusId,callListItemIndex:i.callListItemIndex,direction:R.outgoing,makeCall:i.makeCall===true,uiState:F.outgoing,webformId:i.webformId||0,webformSecCode:i.webformSecCode||"",hasSipPhone:this.hasSipPhone,deviceCall:this.phoneDeviceCall(),crmData:this.phoneCrm,foldedCallView:this.foldedCallView,backgroundWorker:this.backgroundWorker,messengerFacade:this.messengerFacade,restApps:this.restApps});le(this,Xe,Rt).call(this,this.callView);this.callView.show();return true}},{key:"isCallListMode",value:function e(){return this.callListId>0}},{key:"callListMakeCall",value:function e(t){var i=this;this.loadPhoneLines().then((function(){return le(i,Re,Ht).call(i,t)}))}},{key:"phoneIncomingAnswer",value:function e(){var t=this;this.clearSkipIncomingCallTimer();this.messengerFacade.stopRepeatSound("ringtone");this.callSelfDisabled=true;BX.rest.callMethod("voximplant.call.answer",{CALL_ID:this.callId});if(this.keypad){this.keypad.close()}this.callView.setUiState(F.connectingIncoming);this.callView.setCallState(W.connecting);this.phoneApiInit().then((function(){return BX.rest.callMethod("voximplant.call.sendReady",{CALL_ID:t.callId})}))}},{key:"phoneApiInit",value:function e(){var t=this;if(!this.phoneSupport()){return Promise.reject("Telephony is not supported")}if(this.voximplantClient&&this.voximplantClient.connected()){if(this.defaultMicrophone){this.voximplantClient.useAudioSource(this.defaultMicrophone)}if(this.defaultSpeaker){VoxImplant.Hardware.AudioDeviceManager.get().setDefaultAudioSettings({outputId:this.defaultSpeaker})}return Promise.resolve()}var i={useRTCOnly:true,micRequired:true,videoSupport:false,progressTone:false};if(this.enableMicAutoParameters===false){i.audioConstraints={optional:[{echoCancellation:false},{googEchoCancellation:false},{googEchoCancellation2:false},{googDAEchoCancellation:false},{googAutoGainControl:false},{googAutoGainControl2:false},{mozAutoGainControl:false},{googNoiseSuppression:false},{googNoiseSuppression2:false},{googHighpassFilter:false},{googTypingNoiseDetection:false},{googAudioMirroring:false}]}}return new Promise((function(e,n){BX.Voximplant.getClient({debug:t.debug,apiParameters:i}).then((function(i){t.voximplantClient=i;if(t.defaultMicrophone){t.voximplantClient.useAudioSource(t.defaultMicrophone)}if(t.defaultSpeaker){VoxImplant.Hardware.AudioDeviceManager.get().setDefaultAudioSettings({outputId:t.defaultSpeaker})}if(t.messengerFacade.isDesktop()&&s.Type.isFunction(t.voximplantClient.setLoggerCallback)){t.voximplantClient.enableSilentLogging();t.voximplantClient.setLoggerCallback((function(e){return t.phoneLog(e.label+": "+e.message)}))}t.voximplantClient.addEventListener(VoxImplant.Events.ConnectionFailed,le(t,Pe,Mt).bind(t));t.voximplantClient.addEventListener(VoxImplant.Events.ConnectionClosed,le(t,xe,At).bind(t));t.voximplantClient.addEventListener(VoxImplant.Events.IncomingCall,le(t,Le,Et).bind(t));t.voximplantClient.addEventListener(VoxImplant.Events.MicAccessResult,le(t,Ve,Bt).bind(t));t.voximplantClient.addEventListener(VoxImplant.Events.SourcesInfoUpdated,t.phoneOnInfoUpdated.bind(t));t.voximplantClient.addEventListener(VoxImplant.Events.NetStatsReceived,le(t,He,Pt).bind(t));e()}))["catch"]((function(e){BX.rest.callMethod("voximplant.call.onConnectionError",{CALL_ID:t.callId,ERROR:e});t.phoneCallFinish();t.messengerFacade.playSound("error");t.callOverlayProgress("offline");t.callAbort(s.Loc.getMessage("IM_PHONE_ERROR"));t.callView.setUiState(F.error);t.callView.setCallState(W.idle);n("Could not connect to Voximplant cloud")}))}))}},{key:"phoneOnInfoUpdated",value:function e(t){this.phoneLog("Info updated",this.voximplantClient.audioSources(),this.voximplantClient.videoSources())}},{key:"displayIncomingCall",value:function e(t){var i=this;t.isCallback=!!t.isCallback;this.phoneLog("incoming call",t);if(!this.phoneSupport()){this.showUnsupported();return false}this.phoneNumberUser=s.Text.encode(t.callerId);t.callerId=t.callerId.replace(/[^a-zA-Z0-9\.]/g,"");if(this.callActive){return false}this.initiator=true;this.callInitUserId=0;this.callActive=false;this.callUserId=0;this.phoneIncoming=true;this.callId=t.callId;this.phoneNumber=t.callerId;this.phoneParams={};var n=t.isCallback?R.callback:R.incoming;this.callView=new Z({userId:this.userId,phoneNumber:this.phoneNumber,lineNumber:t.lineNumber,companyPhoneNumber:t.companyPhoneNumber,callTitle:this.phoneNumberUser,direction:n,transfer:this.isCallTransfer,statusText:t.isCallback?s.Loc.getMessage("IM_PHONE_INVITE_CALLBACK"):s.Loc.getMessage("IM_PHONE_INVITE"),crm:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId,crmActivityId:t.crmActivityId,crmActivityEditUrl:t.crmActivityEditUrl,callId:this.callId,crmData:this.phoneCrm,foldedCallView:this.foldedCallView,backgroundWorker:this.backgroundWorker,messengerFacade:this.messengerFacade,restApps:this.restApps});le(this,Xe,Rt).call(this,this.callView);this.callView.setUiState(F.incoming);this.callView.setCallState(W.connecting);if(t.config){this.callView.setConfig(t.config)}this.callView.show();if(t.portalCall){this.callView.setPortalCall(true);this.callView.setPortalCallData(t.portalCallData);this.callView.setPortalCallUserId(t.portalCallUserId)}this.hasActiveCallView=true;this.skipIncomingCallTimer=setTimeout((function(){console.log("Skip phone call by timer");if(!i.currentCall){var e;(e=i.callView)===null||e===void 0?void 0:e._onSkipButtonClick()}i.skipIncomingCallTimer=null}),4e4)}},{key:"sendInviteTransfer",value:function e(){var t=this;if(!this.currentCall&&this.deviceType==re.Webrtc){return false}if(!this.phoneTransferTargetType||!this.phoneTransferTargetId){return false}var i={CALL_ID:this.callId,TARGET_TYPE:this.phoneTransferTargetType,TARGET_ID:this.phoneTransferTargetId};BX.rest.callMethod("voximplant.call.startTransfer",i).then((function(e){var i=e.data();if(i.SUCCESS=="Y"){t.phoneTransferEnabled=true;BX.localStorage.set(ae.vite,true,1);t.phoneTransferCallId=i.DATA.CALL.CALL_ID;t.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_TRANSFER"));t.callView.setUiState(F.transferring)}else{console.error("Could not start call transfer. Error: ",i.ERRORS)}}))}},{key:"cancelInviteTransfer",value:function e(){if(!this.currentCall&&this.deviceType==re.Webrtc){return false}this.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_ONLINE"));this.callView.setUiState(F.connected);if(this.phoneTransferCallId!==""){BX.rest.callMethod("voximplant.call.cancelTransfer",{CALL_ID:this.phoneTransferCallId})}this.phoneTransferTargetId=0;this.phoneTransferTargetType="";this.phoneTransferCallId="";this.phoneTransferEnabled=false;BX.localStorage.set(ae.vite,false,1)}},{key:"errorInviteTransfer",value:function e(t,i){if(t=="403"||t=="410"||t=="486"){this.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_TRANSFER_"+t))}else{this.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_TRANSFER_1"))}this.messengerFacade.playSound("error",true);this.callView.setUiState(F.transferFailed);this.phoneTransferTargetId=0;this.phoneTransferTargetType="";this.phoneTransferCallId="";this.phoneTransferEnabled=false;BX.localStorage.set(ae.vite,false,1)}},{key:"completeTransfer",value:function e(){BX.rest.callMethod("voximplant.call.completeTransfer",{CALL_ID:this.phoneTransferCallId})}},{key:"showExternalCall",value:function e(t){var i=this;var s;if(this.callView){return}setTimeout((function(){return BX.localStorage.set(ae.externalCall,true,5)}),100);clearInterval(this.phoneConnectedInterval);this.phoneConnectedInterval=setInterval((function(){if(i.hasExternalCall){BX.localStorage.set(ae.externalCall,true,5)}}),5e3);this.callId=t.callId;this.callActive=true;this.hasExternalCall=true;if(t.isCallback){s=R.callback}else if(t.fromUserId>0){s=R.outgoing}else{s=R.incoming}this.callView=new Z({callId:t.callId,direction:s,phoneNumber:t.phoneNumber,lineNumber:t.lineNumber,companyPhoneNumber:t.companyPhoneNumber,fromUserId:t.fromUserId,toUserId:t.toUserId,crm:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId,crmBindings:t.crmBindings,crmActivityId:t.crmActivityId,crmActivityEditUrl:t.crmActivityEditUrl,crmData:this.phoneCrm,isExternalCall:true,foldedCallView:this.foldedCallView,backgroundWorker:this.backgroundWorker,messengerFacade:this.messengerFacade,restApps:this.restApps});this.bindPhoneViewCallbacksExternalCall(this.callView);this.callView.setUiState(F.externalCard);this.callView.setCallState(W.connected);this.callView.setConfig(t.config);this.callView.show();if(t.portalCall){this.callView.setPortalCall(true);this.callView.setPortalCallData(t.portalCallData);this.callView.setPortalCallUserId(t.portalCallUserId)}}},{key:"bindPhoneViewCallbacksExternalCall",value:function e(t){var i=this;t.setCallback("close",(function(){if(i.callView){i.callView.dispose();i.closeCallViewBalloon();i.callView=null}i.hasActiveCallView=false;i.callId="";i.callActive=false;i.hasExternalCall=false;i.callSelfDisabled=false;clearInterval(i.phoneConnectedInterval);BX.localStorage.set(ae.externalCall,false)}));t.setCallback("saveComment",le(this,lt,ii).bind(this))}},{key:"hideExternalCall",value:function e(t){if(this.callView&&!this.callView.isCallListMode()){this.callView.autoClose()}}},{key:"phoneLog",value:function e(){if(this.messengerFacade.isDesktop()){var t="";for(var i=0;i<arguments.length;i++){if(BX.type.isPlainObject(arguments[i])){try{t=t+" | "+JSON.stringify(arguments[i])}catch(e){t=t+" | (circular structure)"}}else{t=t+" | "+arguments[i]}}n.DesktopApi.writeToLogFile("phone."+this.userEmail+".log",t.substring(3))}if(this.debug){if(console){try{console.log("Phone Log",JSON.stringify(arguments))}catch(e){console.log("Phone Log",arguments[0])}}}}},{key:"checkDesktop",value:function e(){if(s.Reflection.getClass("BX.Messenger.v2.Lib.DesktopManager")){return new Promise((function(e){var t=BX.Messenger.v2.Lib.DesktopManager.getInstance();t.checkStatusInDifferentContext().then((function(t){if(t===false){e()}}))}))}if(s.Reflection.getClass("BX.desktopUtils")){return new Promise((function(e){BX.desktopUtils.runningCheck((function(){}),(function(){return e()}))}))}return Promise.resolve()}},{key:"restoreFoldedCallView",value:function e(){var t=this;var i=BX.localStorage.get(ae.foldedView);if(!s.Type.isPlainObject(i)){return}this.callActive=true;this.callId=i.callId;this.phoneCrm=i.phoneCrm;this.deviceType=i.phoneCallDevice;this.hasExternalCall=i.hasExternalCall;var n=i.callView;n.foldedCallView=this.foldedCallView;n.backgroundWorker=this.backgroundWorker;n.messengerFacade=this.messengerFacade;this.callView=new Z(i.callView);if(this.hasExternalCall){this.callView.setUiState(F.externalCard);this.callView.setCallState(W.connected);this.bindPhoneViewCallbacksExternalCall(this.callView)}else{le(this,Xe,Rt).call(this,this.callView)}if(this.hasExternalCall){BX.localStorage.set(ae.externalCall,true,5);this.phoneConnectedInterval=setInterval((function(){if(t.hasExternalCall){BX.localStorage.set(ae.externalCall,true,5)}}),5e3)}BX.rest.callMethod("voximplant.call.get",{CALL_ID:this.callId})["catch"]((function(){t.callId="";t.callActive=false;t.hasExternalCall=false;t.callSelfDisabled=false;clearInterval(t.phoneConnectedInterval);BX.localStorage.set(ae.externalCall,false);if(t.callView){t.callView.dispose();t.closeCallViewBalloon();t.callView=null}t.hasActiveCallView=false}))}},{key:"displayCallQuality",value:function e(t){if(!this.currentCall||this.currentCall.state()!="CONNECTED"){return false}var i=5;if(100==t){i=5}else if(t>=99){i=4}else if(t>=97){i=3}else if(t>=95){i=2}else{i=1}this.callView.setQuality(i);return i}},{key:"callOverlayProgress",value:function e(t){if(this.callView){this.callView.setProgress(t);if(t==="offline"){this.messengerFacade.playSound("error")}}}},{key:"callOverlayStatus",value:function e(t){if(!s.Type.isStringFilled(t)){return false}if(this.callView){this.callView.setStatusText(t)}}},{key:"setCallOverlayTitle",value:function e(t){if(this.callView){this.callView.setTitle(t)}}},{key:"callOverlayTimer",value:function e(t){var i=this;t=typeof t=="undefined"?"start":t;if(t=="start"){this.phoneCallTimeInterval=setInterval((function(){return i.phoneCallTime++}),1e3)}else{clearInterval(this.phoneCallTimeInterval)}}},{key:"callAbort",value:function e(t){this.callOverlayDeleteEvents();if(t&&this.callView){if(this.callView){this.callView.setStatusText(t)}}}},{key:"callOverlayDeleteEvents",value:function e(){this.phoneCallFinish();this.clearSkipIncomingCallTimer();this.messengerFacade.stopRepeatSound("ringtone");this.messengerFacade.stopRepeatSound("dialtone");clearTimeout(this.callDialogAllowTimeout);if(this.callDialogAllow){this.callDialogAllow.close()}}},{key:"storageSet",value:function e(t){if(t.key==ae.vite){if(t.value===true||!this.callSelfDisabled){this.phoneTransferEnabled=t.value}}else if(t.key==ae.externalCall){if(t.value===false){this.hideExternalCall()}}}},{key:"getDebugInfo",value:function e(){var t,i,s;return{vInitedCall:BX.localStorage.get("vInitedCall")?"Y":"N",isDesktop:this.messengerFacade.isDesktop()?"Y":"N",appVersion:navigator.appVersion,hasActiveCall:this.messengerFacade.hasActiveCall()?"Y":"N",isCallListMode:this.isCallListMode()?this.callListId:"N",currentCall:this.currentCall?this.currentCall.id():"N",callView:this.callView?this.callView.callId:"N",callViewPopup:(t=this.callView)!==null&&t!==void 0&&t.popup?"Y":"N",hasActiveCallView:this.hasActiveCallView?"Y":"N",isFoldedCallView:(i=this.callView)!==null&&i!==void 0&&i.isFolded()?"Y":"N",voximplantClient:this.voximplantClient?(s=this.voximplantClient)===null||s===void 0?void 0:s.connected():"N"}}},{key:"showNotification",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};if(!i){i=[]}var l={content:s.Text.encode(t),position:"top-right",closeButton:true,actions:i};if(n.autoHideDelay){l.autoHideDelay=n.autoHideDelay}else{l.autoHide=false}return BX.UI.Notification.Center.notify(l)}},{key:"showCallViewBalloon",value:function e(){if(!this.openedCallViewBalloon&&this.callView){this.openedCallViewBalloon=this.showNotification(s.Loc.getMessage("VOXIMPLANT_WARN_CLOSE_CALL_VIEW"))}}},{key:"closeCallViewBalloon",value:function e(){if(this.openedCallViewBalloon){this.openedCallViewBalloon.close();this.openedCallViewBalloon=null}}},{key:"clearSkipIncomingCallTimer",value:function e(){if(this.skipIncomingCallTimer){console.log("Clear skip incoming call timer: "+this.skipIncomingCallTimer);clearTimeout(this.skipIncomingCallTimer);this.skipIncomingCallTimer=null}}},{key:"testSimple",value:function e(){var t=this;var i="test-call";this.callView=new Z({callId:i,restApps:this.restApps,foldedCallView:this.foldedCallView,backgroundWorker:this.backgroundWorker,messengerFacade:this.messengerFacade,darkMode:this.messengerFacade.isThemeDark(),events:{close:function e(){var i;console.trace("close");(i=t.callView)===null||i===void 0?void 0:i.dispose();t.callView=null},hangup:function e(){return t.callView.close()},transfer:function e(t){return console.log("transfer",t)},dialpadButtonClicked:function e(t){return console.log("dialpadButtonClicked",t)},hold:function e(){return console.log("hold")},unhold:function e(){return console.log("unhold")},mute:function e(){return console.log("mute")},unmute:function e(){return console.log("unmute")}}});this.callView.show()}},{key:"testCrm",value:function e(){}},{key:"testUser",value:function e(){this.callView=new Z({messengerFacade:this.messengerFacade})}},{key:"currentCall",get:function e(){return this._currentCall},set:function e(t){if(this._currentCall){le(this,he,rt).call(this,this._currentCall);this.emit(oe.onCallDestroyed,{call:this._currentCall})}t!==null&&t!==void 0&&t.id()?BX.localStorage.set(ae.currentCall,t===null||t===void 0?void 0:t.id(),86400):BX.localStorage.remove(ae.currentCall);this._currentCall=t;this.hasActiveCallView=Boolean(this._currentCall);if(this._currentCall){le(this,ce,ot).call(this,t);this.emit(oe.onCallCreated,{call:t})}}}]);return i}(i.EventEmitter);function ot(e){e.addEventListener(VoxImplant.CallEvents.Connected,this.onCallConnectedHandler);e.addEventListener(VoxImplant.CallEvents.Disconnected,this.onCallDisconnectedHandler);e.addEventListener(VoxImplant.CallEvents.Failed,this.onCallFailedHandler);e.addEventListener(VoxImplant.CallEvents.ProgressToneStart,this.onProgressToneStartHandler);e.addEventListener(VoxImplant.CallEvents.ProgressToneStop,this.onProgressToneStopHandler)}function rt(e){e.removeEventListener(VoxImplant.CallEvents.Connected,this.onCallConnectedHandler);e.removeEventListener(VoxImplant.CallEvents.Disconnected,this.onCallDisconnectedHandler);e.removeEventListener(VoxImplant.CallEvents.Failed,this.onCallFailedHandler);e.removeEventListener(VoxImplant.CallEvents.ProgressToneStart,this.onProgressToneStartHandler);e.removeEventListener(VoxImplant.CallEvents.ProgressToneStop,this.onProgressToneStopHandler)}function ct(e,t){var i={invite:le(this,de,ht),answer_self:le(this,pe,ut),timeout:le(this,me,dt),outgoing:le(this,fe,pt),start:le(this,Ce,mt),hold:le(this,ve,ft),unhold:le(this,be,Ct),update_crm:le(this,ge,vt),updatePortalUser:le(this,ye,bt),completeTransfer:le(this,ke,gt),phoneDeviceActive:le(this,Ie,yt),changeDefaultLineId:le(this,we,kt),replaceCallerId:le(this,Te,It),showExternalCall:le(this,Ee,wt),hideExternalCall:le(this,Se,Tt)};if(i.hasOwnProperty(e)){i[e].apply(this,[t])}}function ht(e){var t,i,s,n,l,a,o=this;if(!this.phoneSupport()){return false}var r=((t=this.callView)===null||t===void 0?void 0:t.popup)&&!((i=this.callView)!==null&&i!==void 0&&i.commentShown)&&!((s=this.callView)!==null&&s!==void 0&&s.autoCloseTimer)&&!this.hasActiveCallView;if(this.callView&&!((n=this.callView)!==null&&n!==void 0&&n.popup)&&!this.currentCall||r&&!this.currentCall||this.callView&&(l=this.callView)!==null&&l!==void 0&&l.isFolded()&&!this.currentCall||this.callView&&!this.voximplantClient||this.callView&&this.voximplantClient&&!this.voximplantClient.connected()){console.log("Close a stuck call view");le(this,tt,Zt).call(this)}if(BX.localStorage.get(ae.callView)&&(a=this.callView)!==null&&a!==void 0&&a.popup&&!Boolean(this._currentCall)&&!this.isCallListMode()&&!this.messengerFacade.hasActiveCall()){this.showCallViewBalloon()}if(this.hasActiveCall()||this.isCallListMode()||this.messengerFacade.hasActiveCall()){BX.rest.callMethod("voximplant.call.busy",{CALL_ID:e.callId,DEBUG_INFO:this.getDebugInfo()});return false}if(BX.localStorage.get(ae.callInited)||BX.localStorage.get(ae.externalCall)){return false}this.checkDesktop().then((function(){if(e.CRM&&e.CRM.FOUND){o.phoneCrm=e.CRM}else{o.phoneCrm={}}o.phonePortalCall=!!e.portalCall;if(o.phonePortalCall&&e.portalCallData){var t=e.portalCallData[e.portalCallUserId];if(t){e.callerId=t.name}e.phoneNumber=""}o.phoneCallConfig=e.config?e.config:{};o.phoneCallTime=0;o.messengerFacade.repeatSound("ringtone",5e3,true);BX.rest.callMethod("voximplant.call.sendWait",{CALL_ID:e.callId,DEBUG_INFO:o.getDebugInfo()});o.isCallTransfer=!!e.isTransfer;o.displayIncomingCall({chatId:e.chatId,callId:e.callId,callerId:e.callerId,lineNumber:e.lineNumber,companyPhoneNumber:e.phoneNumber,isCallback:e.isCallback,showCrmCard:e.showCrmCard,crmEntityType:e.crmEntityType,crmEntityId:e.crmEntityId,crmActivityId:e.crmActivityId,crmActivityEditUrl:e.crmActivityEditUrl,portalCall:e.portalCall,portalCallUserId:e.portalCallUserId,portalCallData:e.portalCallData,config:e.config})}))["catch"]((function(){}))}function ut(e){this.clearSkipIncomingCallTimer();if(this.callSelfDisabled||this.callId!=e.callId){return false}this.messengerFacade.stopRepeatSound("ringtone");this.messengerFacade.stopRepeatSound("dialtone");this.phoneCallFinish();this.callAbort();this.callView.close();this.callId=e.callId}function dt(e){this.clearSkipIncomingCallTimer();if(this.phoneTransferCallId===e.callId){return this.errorInviteTransfer(e.failedCode,e.failedReason)}else if(this.callId!=e.callId){return false}clearInterval(this.phoneConnectedInterval);BX.localStorage.remove(ae.callInited);var t=this.hasExternalCall;this.messengerFacade.stopRepeatSound("ringtone");this.messengerFacade.stopRepeatSound("dialtone");this.phoneCallFinish();this.callAbort();if(!this.callView){return}this.showCallViewBalloon();this.callView.setCallState(W.idle,{failedCode:e.failedCode});if(t&&e.failedCode==486){this.callView.setProgress(X.offline);this.callView.setStatusText(s.Loc.getMessage("IM_PHONE_ERROR_BUSY_PHONE"));this.callView.setUiState(F.sipPhoneError)}else if(t&&e.failedCode==480){this.callView.setProgress(X.error);this.callView.setStatusText(s.Loc.getMessage("IM_PHONE_ERROR_NA_PHONE"));this.callView.setUiState(F.sipPhoneError)}else{if(this.isCallListMode()){this.callView.setStatusText("");this.callView.setUiState(F.outgoing)}else{this.callView.setStatusText(s.Loc.getMessage("IM_PHONE_END"));this.callView.setUiState(F.idle);this.callView.autoClose()}}}function pt(e){var t=this;if(this.phoneNumber&&(this.phoneNumber===e.phoneNumber||e.phoneNumber.indexOf(this.phoneNumber)>=0)){this.deviceType=e.callDevice==re.Phone?re.Phone:re.Webrtc;this.phonePortalCall=!!e.portalCall;this.phoneNumber=e.phoneNumber;if(this.hasExternalCall&&this.deviceType==re.Phone){this.callView.setProgress(X.connect);this.callView.setStatusText(s.Loc.getMessage("IM_PHONE_WAIT_ANSWER"))}this.phoneCallConfig=e.config?e.config:{};this.callId=e.callId;this.phoneCallTime=0;this.phoneCrm=e.CRM;if(this.callView&&e.showCrmCard){this.callView.setCrmData(e.CRM);this.callView.setCrmEntity({type:e.crmEntityType,id:e.crmEntityId,activityId:e.crmActivityId,activityEditUrl:e.crmActivityEditUrl,bindings:e.crmBindings});this.callView.setConfig(e.config);this.callView.setCallId(e.callId);if(e.lineNumber){this.callView.setLineNumber(e.lineNumber)}if(e.lineName){this.callView.setCompanyPhoneNumber(e.lineName)}this.callView.reloadCrmCard()}if(this.callView&&this.phonePortalCall){this.callView.setPortalCall(true);this.callView.setPortalCallData(e.portalCallData);this.callView.setPortalCallUserId(e.portalCallUserId);this.callView.setPortalCallQueueName(e.portalCallQueueName)}}else if(!this.hasActiveCall()&&e.callDevice===re.Phone){this.checkDesktop().then((function(){t.deviceType=e.callDevice===re.Phone?re.Phone:re.Webrtc;t.phonePortalCall=!!e.portalCall;t.callId=e.callId;t.phoneCallTime=0;t.phoneCallConfig=e.config?e.config:{};t.phoneCrm=e.CRM;t.phoneDisplayExternal({callId:e.callId,config:e.config?e.config:{},phoneNumber:e.phoneNumber,portalCall:e.portalCall,portalCallUserId:e.portalCallUserId,portalCallData:e.portalCallData,portalCallQueueName:e.portalCallQueueName,showCrmCard:e.showCrmCard,crmEntityType:e.crmEntityType,crmEntityId:e.crmEntityId})}))["catch"]((function(){}))}}function mt(e){this.clearSkipIncomingCallTimer();if(this.phoneTransferCallId===e.callId){this.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_TRANSFER_CONNECTED"));return}if(this.callId!=e.callId){return}this.callOverlayTimer("start");this.messengerFacade.stopRepeatSound("ringtone");if(this.callId==e.callId&&this.deviceType==re.Phone&&(this.deviceType==e.callDevice||this.phonePortalCall)){le(this,We,Ut).call(this)}else if(this.callId==e.callId&&e.callDevice==re.Phone&&this.phoneIncoming){this.deviceType=re.Phone;if(this.callView){this.callView.setDeviceCall(true)}le(this,We,Ut).call(this)}if(e.CRM){this.phoneCrm=e.CRM}if(this.phoneNumber!==""){this.phoneNumberLast=this.phoneNumber;this.messengerFacade.setLocalConfig("phone_last",this.phoneNumber)}}function ft(e){if(this.callId==e.callId){this.isCallHold=true}}function Ct(e){if(this.callId==e.callId){this.isCallHold=false}}function vt(e){if(this.callId==e.callId&&e.CRM&&e.CRM.FOUND){this.phoneCrm=e.CRM;if(this.callView){this.callView.setCrmData(e.CRM);if(e.showCrmCard){this.callView.setCrmEntity({type:e.crmEntityType,id:e.crmEntityId,activityId:e.crmActivityId,activityEditUrl:e.crmActivityEditUrl,bindings:e.crmBindings});this.callView.reloadCrmCard()}}}}function bt(e){if(this.callId==e.callId&&this.callView){this.callView.setPortalCall(true);this.callView.setPortalCallData(e.portalCallData);this.callView.setPortalCallUserId(e.portalCallUserId)}}function gt(e){if(this.callId!=e.callId){return false}this.callId=e.newCallId;this.phoneTransferTargetId=0;this.phoneTransferTargetType="";this.phoneTransferCallId="";this.phoneTransferEnabled=false;BX.localStorage.set(ae.vite,false,1);this.deviceType=e.callDevice==re.Phone?re.Phone:re.Webrtc;if(this.deviceType==re.Phone){this.callView.setDeviceCall(true)}this.callView.setTransfer(false);le(this,We,Ut).call(this)}function yt(e){this.hasSipPhone=e.active=="Y"}function kt(e){this.defaultLineId=e.defaultLineId}function It(e){var t=s.Loc.getMessage("IM_PHONE_CALL_TRANSFER").replace("#PHONE#",e.callerId);this.setCallOverlayTitle(t);this.callView.setPhoneNumber(e.callerId);if(e.CRM){this.phoneCrm=e.CRM;this.callView.setCrmData(e.CRM);if(e.showCrmCard){this.callView.setCrmEntity({type:e.crmEntityType,id:e.crmEntityId,activityId:e.crmActivityId,activityEditUrl:e.crmActivityEditUrl,bindings:e.crmBindings});this.callView.reloadCrmCard()}}}function wt(e){var t=this;if(this.messengerFacade.hasActiveCall()){return false}if(BX.localStorage.get(ae.callInited)||BX.localStorage.get(ae.externalCall)){return false}this.checkDesktop().then((function(){if(e.CRM&&e.CRM.FOUND){t.phoneCrm=e.CRM}else{t.phoneCrm={}}t.showExternalCall({callId:e.callId,fromUserId:e.fromUserId,toUserId:e.toUserId,isCallback:e.isCallback,phoneNumber:e.phoneNumber,lineNumber:e.lineNumber,companyPhoneNumber:e.companyPhoneNumber,showCrmCard:e.showCrmCard,crmEntityType:e.crmEntityType,crmEntityId:e.crmEntityId,crmBindings:e.crmBindings,crmActivityId:e.crmActivityId,crmActivityEditUrl:e.crmActivityEditUrl,config:e.config,portalCall:e.portalCall,portalCallData:e.portalCallData,portalCallUserId:e.portalCallUserId})}))["catch"]((function(){}))}function Tt(e){if(this.hasActiveCall()&&this.hasExternalCall&&this.callId==e.callId){this.hideExternalCall()}}function Et(e){if(this.currentCall){return false}this.currentCall=e.call;this.currentCall.answer()}function St(){var e=this;this.phoneParams["CALLER_ID"]="";this.phoneParams["USER_ID"]=this.userId;this.phoneLog("Call params: ",this.phoneNumber,this.phoneParams);if(!this.voximplantClient.connected()){le(this,Fe,Ot).call(this);return false}this.currentCall=this.voximplantClient.call(this.phoneNumber,false,this.getCallParams());var t={NUMBER:this.phoneNumber,NUMBER_USER:s.Text.decode(this.phoneNumberUser),IM_AJAX_CALL:"Y"};BX.rest.callMethod("voximplant.call.init",t).then((function(t){var i=t.data();if(!(i.HR_PHOTO.length===0)){e.callOverlayUserId=i.DIALOG_ID}else{e.callOverlayChatId=i.DIALOG_ID.substring(4)}}))}function Lt(e){var t=e.headers||{};this.phoneLog("Call failed",e.code,e.reason);var i=s.Loc.getMessage("IM_PHONE_END");if(e.code==603){i=s.Loc.getMessage("IM_PHONE_DECLINE")}else if(e.code==380){i=s.Loc.getMessage("IM_PHONE_ERR_SIP_LICENSE")}else if(e.code==436){i=s.Loc.getMessage("IM_PHONE_ERR_NEED_RENT")}else if(e.code==438){i=s.Loc.getMessage("IM_PHONE_ERR_BLOCK_RENT")}else if(e.code==400){i=s.Loc.getMessage("IM_PHONE_ERR_LICENSE")}else if(e.code==401){i=s.Loc.getMessage("IM_PHONE_401")}else if(e.code==480||e.code==503){if(this.phoneNumber==911||this.phoneNumber==112){i=s.Loc.getMessage("IM_PHONE_NO_EMERGENCY")}else{i=s.Loc.getMessage("IM_PHONE_UNAVAILABLE")}}else if(e.code==484||e.code==404){if(this.phoneNumber==911||this.phoneNumber==112){i=s.Loc.getMessage("IM_PHONE_NO_EMERGENCY")}else{i=s.Loc.getMessage("IM_PHONE_INCOMPLETED")}}else if(e.code==402){if(t.hasOwnProperty("X-Reason")&&t["X-Reason"]==="SIP_PAYMENT_REQUIRED"){i=s.Loc.getMessage("IM_PHONE_ERR_SIP_LICENSE")}else{i=s.Loc.getMessage("IM_PHONE_NO_MONEY")+(this.isAdmin?" "+s.Loc.getMessage("IM_PHONE_PAY_URL_NEW"):"")}}else if(e.code==486&&this.phoneRinging>1){i=s.Loc.getMessage("IM_M_CALL_ST_DECLINE")}else if(e.code==486){i=s.Loc.getMessage("IM_PHONE_ERROR_BUSY")}else if(e.code==403){i=s.Loc.getMessage("IM_PHONE_403");this.phoneServer="";this.phoneLogin="";this.phoneCheckBalance=true}else if(e.code==504){i=s.Loc.getMessage("IM_PHONE_ERROR_CONNECT")}else{i=s.Loc.getMessage("IM_PHONE_ERROR")}if(e.code==408||e.code==403){this.scheduleApiDisconnect()}this.callOverlayProgress("offline");this.callAbort(i);this.callView.setUiState(F.error);this.callView.setCallState(W.idle)}function _t(e){this.phoneLog("Call disconnected",this.currentCall?this.currentCall.id():"-",this.currentCall?this.currentCall.state():"-");if(this.currentCall){this.phoneCallFinish();this.callOverlayDeleteEvents();this.callOverlayStatus(s.Loc.getMessage("IM_M_CALL_ST_END"));this.messengerFacade.playSound("stop");this.callView.setCallState(W.idle);if(this.isCallListMode()){this.callView.setUiState(F.outgoing)}else{this.callView.setStatusText(s.Loc.getMessage("IM_PHONE_END"));this.callView.setUiState(F.idle);this.callView.autoClose()}}this.scheduleApiDisconnect()}function Dt(e){if(!this.currentCall){return false}this.phoneLog("Progress tone start",this.currentCall.id());this.phoneRinging++;this.callOverlayStatus(s.Loc.getMessage("IM_PHONE_WAIT_ANSWER"))}function Nt(e){if(!this.currentCall){return false}this.phoneLog("Progress tone stop",this.currentCall.id())}function Mt(e){this.phoneLog("Connection failed");this.phoneCallFinish();this.callAbort(s.Loc.getMessage("IM_M_CALL_ERR"))}function At(e){this.phoneLog("Connection closed")}function Bt(e){this.phoneMicAccess=e.result;this.phoneLog("Mic Access Allowed",e.result);if(e.result){this.callOverlayProgress("connect");this.callOverlayStatus(s.Loc.getMessage("IM_M_CALL_ST_CONNECT"))}else{this.phoneCallFinish();this.callOverlayProgress("offline");this.callAbort(s.Loc.getMessage("IM_M_CALL_ST_NO_ACCESS"));this.callView.setUiState(F.error);this.callView.setCallState(W.idle)}}function Pt(e){if(!this.currentCall||this.currentCall.state()!="CONNECTED"){return false}var t=100-parseInt(e.stats.packetLoss);var i=this.displayCallQuality(t);this.currentCall.sendMessage(JSON.stringify({COMMAND:"meter",PACKETLOSS:e.stats.packetLoss,PERCENT:t,GRADE:i}))}function xt(e){var t=this;if(!this.phoneSupport()&&!this.isRestLine(this.defaultLineId)){this.showUnsupported();return false}if(this.hasActiveCall()||BX.localStorage.get(ae.callInited)||BX.localStorage.get(ae.externalCall)){return false}if(this.keypad){this.keypad.close();return false}this.keypad=new h({bindElement:e.bindElement,offsetTop:e.offsetTop,offsetLeft:e.offsetLeft,anglePosition:e.anglePosition,angleOffset:e.angleOffset,defaultLineId:this.defaultLineId,lines:this.phoneLines,availableLines:this.availableLines,history:this.dialHistory,callInterceptAllowed:this.callInterceptAllowed,onDial:this.onKeyPadDial.bind(this),onIntercept:this.onKeyPadIntercept.bind(this),onClose:function i(){t.onKeyPadClose();if(s.Type.isFunction(e.onClose)){e.onClose()}}});this.keypad.show()}function Vt(e){var t=this;var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(BX.localStorage.get(ae.callInited)||this.callView||this.hasActiveCall()){return false}if(!this.phoneSupport()){this.showUnsupported();return false}if(this.keypad){this.keypad.close()}if(s.Type.isStringFilled(e)){this.addToHistory(e)}var n=s.Type.isStringFilled(i["LINE_ID"])?i["LINE_ID"]:this.defaultLineId;if(this.isRestLine(n)){this.startCallViaRestApp(e,n,i);return true}this.phoneLog(e,i);this.phoneNumberUser=s.Text.encode(e);var l=e;if(babelHelpers["typeof"](i)!="object"){i={}}var o=this.correctPhoneNumber(e);if(o.length<=0){a.MessageBox.alert(s.Loc.getMessage("IM_PHONE_WRONG_NUMBER_DESC"),s.Loc.getMessage("IM_PHONE_WRONG_NUMBER"));return false}this.setPhoneNumber(o);this.initiator=true;this.callInitUserId=this.userId;this.callActive=false;this.callUserId=0;this.hasExternalCall=this.phoneDeviceCall();this.phoneParams=i;this.callView=new Z({darkMode:this.messengerFacade.isThemeDark(),phoneNumber:this.phoneFullNumber,callTitle:this.phoneNumberUser,fromUserId:this.userId,direction:R.outgoing,uiState:F.connectingOutgoing,status:s.Loc.getMessage("IM_M_CALL_ST_CONNECT"),hasSipPhone:this.hasSipPhone,deviceCall:this.hasExternalCall,crmData:this.phoneCrm,autoFold:i["AUTO_FOLD"]===true,foldedCallView:this.foldedCallView,backgroundWorker:this.backgroundWorker,messengerFacade:this.messengerFacade,restApps:this.restApps});le(this,Xe,Rt).call(this,this.callView);this.callView.show();this.messengerFacade.playSound("start");if(this.hasExternalCall){this.deviceType=re.Phone;this.callView.setProgress(X.wait);this.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_PHONE_NOTICE"));var r={NUMBER:l.toString().replace(/[^0-9+*#,;]/g,""),PARAMS:i};BX.rest.callMethod("voximplant.call.startWithDevice",r).then((function(e){var i=e.data();t.callId=i.CALL_ID;t.hasExternalCall=i.EXTERNAL===true;t.phoneCallConfig=i.CONFIG;t.callView.setProgress(X.wait);t.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_WAIT_PHONE"));t.callView.setUiState(F.connectingOutgoing);t.callView.setCallState(W.connecting);t.emit(oe.onDeviceCallStarted,{callId:i.CALL_ID,config:i.CONFIG})}))["catch"]((function(e){t.callView.setProgress(X.error);t.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_PHONE_ERROR"));t.callView.setUiState(F.error);t.callView.setCallState(W.idle)}))}else{this.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_CALL_INIT"));this.phoneApiInit().then((function(){return le(t,Fe,Ot).call(t)}))}}function Ht(e){var t=this;if(this.isRestLine(this.defaultLineId)){this.startCallViaRestApp(e.phoneNumber,this.defaultLineId,{ENTITY_TYPE:"CRM_"+e.crmEntityType,ENTITY_ID:e.crmEntityId,CALL_LIST_ID:e.callListId});return true}if(BX.localStorage.get(ae.callInited)){return false}if(this.callActive){return false}if(!this.callView){return false}this.lastCallListCallParams=e;if(!this.phoneSupport()){this.callView.setStatusText(s.Loc.getMessage("IM_CALL_NO_WEBRT"));this.callView.setUiState(F.error);this.callView.setCallState(W.idle);return false}var i=e.phoneNumber;var n=i;var l=this.correctPhoneNumber(i);if(l.length<=0){this.callView.setStatusText(s.Loc.getMessage("IM_PHONE_WRONG_NUMBER_DESC").replace("<br/>","\n"));return false}this.initiator=true;this.callInitUserId=this.userId;this.callActive=false;this.callUserId=0;this.hasExternalCall=this.phoneDeviceCall();this.setPhoneNumber(l);this.phoneParams={ENTITY_TYPE:"CRM_"+e.crmEntityType,ENTITY_ID:e.crmEntityId,CALL_LIST_ID:e.callListId};this.messengerFacade.playSound("start");if(this.hasExternalCall){this.deviceType=re.Phone;this.callView.setProgress(X.wait);this.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_PHONE_NOTICE"));this.callView.setUiState(F.connectingOutgoing);this.callView.setCallState(W.connecting);var a={NUMBER:n.toString().replace(/[^0-9+*#,;]/g,""),PARAMS:this.phoneParams};BX.rest.callMethod("voximplant.call.startWithDevice",a).then((function(e){var i=e.data();t.callId=i.CALL_ID;t.hasExternalCall=i.EXTERNAL===true;t.phoneCallConfig=i.CONFIG;t.callView.setProgress(X.wait);t.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_WAIT_PHONE"));t.callView.setUiState(F.connectingOutgoing);t.callView.setCallState(W.connecting);t.emit(oe.onDeviceCallStarted,{callId:i.CALL_ID,config:i.CONFIG})}))["catch"]((function(e){t.callView.setProgress(X.error);t.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_PHONE_ERROR"));t.callView.setUiState(F.error);t.callView.setCallState(W.idle)}))}else{this.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_CALL_INIT"));this.callView.setUiState(F.connectingOutgoing);this.callView.setCallState(W.connecting);this.phoneApiInit().then((function(){return le(t,Fe,Ot).call(t)}))}}function Ot(e){var t=this;this.phoneLog("SDK ready");e=e||{};e.delay=e.delay||false;if(!e.delay&&this.hasSipPhone){if(!this.phoneIncoming&&!this.phoneDeviceCall()){this.callOverlayProgress("wait");this.callDialogAllowTimeout=setTimeout((function(){return le(t,Fe,Ot).call(t,{delay:true})}),5e3);return false}}this.phoneLog("Connection exists");this.callView.setProgress(X.connect);this.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_CONNECT"));this.phoneOnAuthResult({result:true});this.callView.setCallState(W.connecting);if(this.phoneIncoming){this.callView.setUiState(F.connectingIncoming)}else{this.callView.setUiState(F.connectingOutgoing)}}function Ut(e){this.clearSkipIncomingCallTimer();this.messengerFacade.stopRepeatSound("ringtone",5e3);BX.localStorage.set(ae.callInited,true,7);clearInterval(this.phoneConnectedInterval);this.phoneConnectedInterval=setInterval((function(){return BX.localStorage.set(ae.callInited,true,7)}),5e3);this.phoneLog("Call connected",e);if(this.callView){BX.localStorage.set(ae.callView,this.callView.callId,86400);this.callView.setUiState(F.connected);this.callView.setCallState(W.connected);this.callView.setProgress(X.online);this.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_ONLINE"))}this.callActive=true;this.emit(oe.onCallConnected,{call:this.currentCall,isIncoming:this.phoneIncoming,isDeviceCall:this.phoneDeviceCall()})}function Rt(e){if(!e instanceof Z){return false}e.setCallback("mute",le(this,ze,Ft).bind(this));e.setCallback("unmute",le(this,Ge,Wt).bind(this));e.setCallback("hold",le(this,je,Xt).bind(this));e.setCallback("unhold",le(this,Ye,zt).bind(this));e.setCallback("answer",le(this,qe,Gt).bind(this));e.setCallback("skip",le(this,Ke,jt).bind(this));e.setCallback("hangup",le(this,Qe,Yt).bind(this));e.setCallback("transfer",le(this,Je,qt).bind(this));e.setCallback("cancelTransfer",le(this,Ze,Kt).bind(this));e.setCallback("completeTransfer",le(this,$e,Qt).bind(this));e.setCallback("callListMakeCall",le(this,et,Jt).bind(this));e.setCallback("close",le(this,tt,Zt).bind(this));e.setCallback("switchDevice",le(this,it,$t).bind(this));e.setCallback("qualityGraded",le(this,st,ei).bind(this));e.setCallback("dialpadButtonClicked",le(this,nt,ti).bind(this));e.setCallback("saveComment",le(this,lt,ii).bind(this))}function Ft(){this.muteCall()}function Wt(){this.unmuteCall()}function Xt(){this.holdCall()}function zt(){this.unholdCall()}function Gt(){this.phoneIncomingAnswer()}function jt(){BX.rest.callMethod("voximplant.call.skip",{CALL_ID:this.callId});this.phoneCallFinish();this.callAbort();this.callView.close()}function Yt(){if(this.hasExternalCall&&this.callId){BX.rest.callMethod("voximplant.call.hangupDevice",{CALL_ID:this.callId})}this.phoneCallFinish();this.messengerFacade.playSound("stop");if(!this.callView){return}this.callView.setStatusText(s.Loc.getMessage("IM_M_CALL_ST_FINISHED"));this.callView.setCallState(W.idle);if(this.isCallListMode()){this.callView.setUiState(F.outgoing);if(this.callView.isFolded()){this.callView.unfold()}}else{this.callView.close()}}function qt(e){if(e.type=="user"||e.type=="pstn"||e.type=="queue"){this.phoneTransferTargetType=e.type;this.phoneTransferTargetId=e.target;this.sendInviteTransfer()}else{console.error("Unknown transfer type",e)}}function Kt(e){this.cancelInviteTransfer(e)}function Qt(e){this.completeTransfer(e)}function Jt(e){this.callListMakeCall(e)}function Zt(){this.clearSkipIncomingCallTimer();this.messengerFacade.stopRepeatSound("ringtone");this.messengerFacade.stopRepeatSound("dialtone");this.callListId=0;if(this.callView){this.callView.dispose();this.closeCallViewBalloon();this.callView=null}this.hasActiveCallView=false;if(this.deviceType==re.Phone){this.callId="";this.callActive=false;this.hasExternalCall=false;this.callSelfDisabled=false;clearInterval(this.phoneConnectedInterval);BX.localStorage.set(ae.externalCall,false)}}function $t(e){var t=e.phoneNumber;var i=this.lastCallListCallParams;if(this.hasExternalCall&&this.callId){BX.rest.callMethod("voximplant.call.hangupDevice",{CALL_ID:this.callId})}this.phoneCallFinish();this.callAbort();this.phoneDeviceCall(!this.phoneDeviceCall());this.callView.setDeviceCall(this.phoneDeviceCall());if(this.isCallListMode()){this.callListMakeCall(i)}else{this.callView.close();this.phoneCall(t)}}function ei(e){var t={COMMAND:"gradeQuality",grade:e};if(this.currentCall){this.currentCall.sendMessage(JSON.stringify(t))}}function ti(e){this.sendDTMF(e)}function ii(e){BX.rest.callMethod("voximplant.call.saveComment",{CALL_ID:e.callId,COMMENT:e.comment})}babelHelpers.defineProperty(at,"Events",oe);BX.FoldedCallView=N;e.PhoneCallsController=at;e.PhoneCallView=Z;e.BackgroundWorker=k})(this.BX.Voximplant=this.BX.Voximplant||{},BX.Intranet,BX.Event,BX,BX.Messenger.v2.Lib,BX.Main,BX.UI.Dialogs);
//# sourceMappingURL=phone-calls.bundle.map.js