BX.ViPermissionEdit=function(e){this.elements={main:e,accessTable:null,accessTableBody:null,accessTableLastRow:null};this.ajaxUrl="/bitrix/components/bitrix/voximplant.settings.perms/ajax.php";this.init()};BX.ViPermissionEdit.prototype={init:function(){this.elements.accessTable=this.elements.main.querySelector("table.bx-vi-js-role-access-table");this.elements.accessTableBody=this.elements.accessTable.querySelector("tbody");this.elements.accessTableLastRow=this.elements.main.querySelector("tr.bx-vi-js-access-table-last-row");this.bindHandlers();BX.Access.Init({other:{disabled:true}})},bindHandlers:function(){var e=this.elements.main.querySelectorAll(".bx-vi-js-delete-role");var t=this.elements.main.querySelectorAll(".bx-vi-js-delete-access");var s=this.elements.main.querySelectorAll(".bx-vi-js-add-access");var n=this.elements.main.querySelectorAll(".bx-vi-js-select-role");for(var a=0;a<e.length;a++){e[a].removeEventListener("click",this.handleDeleteRoleClick.bind(this));e[a].addEventListener("click",this.handleDeleteRoleClick.bind(this))}for(a=0;a<t.length;a++){t[a].removeEventListener("click",this.handleDeleteAccessClick.bind(this));t[a].addEventListener("click",this.handleDeleteAccessClick.bind(this))}for(a=0;a<s.length;a++){s[a].removeEventListener("click",this.handleAddAccessClick.bind(this));s[a].addEventListener("click",this.handleAddAccessClick.bind(this))}for(a=0;a<n.length;a++){n[a].removeEventListener("change",this.handleSelectRoleChange.bind(this));n[a].addEventListener("change",this.handleSelectRoleChange.bind(this))}},handleDeleteRoleClick:function(e){e.preventDefault();e.stopPropagation();var t=e.target;var s=t.dataset.roleId;var n=this;var a=document.querySelectorAll('*[data-role-id="'+s+'"]');n.confirm(BX.message("VOXIMPLANT_PERM_ROLE_DELETE"),BX.message("VOXIMPLANT_PERM_ROLE_DELETE_CONFIRM"),function(e){if(!e.confirmed)return;BX.showWait();BX.ajax({url:n.ajaxUrl,method:"POST",dataType:"json",data:{action:"deleteRole",roleId:s,sessid:BX.bitrix_sessid()},onsuccess:function(e){BX.closeWait();if(!e||e.ERROR){n.notify(BX.message("VOXIMPLANT_PERM_ERROR"),BX.message("VOXIMPLANT_PERM_ROLE_DELETE_ERROR"));return}for(var t=0;t<a.length;t++){BX.remove(a[t])}},onfailure:function(){BX.closeWait();n.notify(BX.message("VOXIMPLANT_PERM_ERROR"),BX.message("VOXIMPLANT_PERM_ROLE_DELETE_ERROR"))}})})},handleAddAccessClick:function(){var e=this;var t={};var s=this.elements.accessTable.rows.length;for(var n=0;n<s;n++){if(this.elements.accessTable.rows[n].dataset.accessCode){t[this.elements.accessTable.rows[n].dataset.accessCode]=true}}BX.Access.SetSelected(t,"voximplantPerms");BX.Access.ShowForm({bind:"voximplantPerms",callback:function(t){var s;var n;for(var a in t){for(var i in t[a]){s=BX.Access.GetProviderName(t[a][i].provider);n=t[a][i].name;e.renderNewAccessCode(i,s,n,1)}}e.bindHandlers()}})},handleDeleteAccessClick:function(e){e.preventDefault();e.stopPropagation();var t=e.target;var s=t.dataset.accessCode;var n=this.elements.accessTable.querySelectorAll('tr[data-access-code="'+s+'"]');for(var a=0;a<n.length;a++){BX.remove(n[a])}},handleSelectRoleChange:function(e){var t=e.target;var s=t.value;var n=t.dataset.accessCode;var a=this.elements.main.querySelector("tr[data-access-code="+n+"]");if(a){a.dataset.roleId=s}},renderNewAccessCode:function(e,t,s,n){var a=BX("bx-vi-new-access-row").innerHTML;a=this.__replaceAll(a,{PROVIDER:t,NAME:s,ACCESS_CODE:e});var i=BX.create("tr",{html:a});i.dataset.roleId=n;i.dataset.accessCode=e;i.querySelector("select").value=n;this.elements.accessTableBody.insertBefore(i,this.elements.accessTableLastRow)},confirm:function(e,t,s){var n={confirmed:false};var a=this.elements.main.id+"-confirm-popup";var i=new BX.PopupWindow(a,null,{content:t,titleBar:e,closeByEsc:true,buttons:[new BX.PopupWindowButton({text:BX.message("VOXIMPLANT_PERM_ROLE_OK"),className:"popup-window-button-accept",events:{click:function(){i.close();n.confirmed=true;if(BX.type.isFunction(s)){s(n)}}}}),new BX.PopupWindowButtonLink({text:BX.message("VOXIMPLANT_PERM_ROLE_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){i.close();n.confirmed=false;if(BX.type.isFunction(s)){s(n)}}}})]});i.show()},notify:function(e,t,s){var n=this.elements.main.id+"-notify-popup";var a=new BX.PopupWindow(n,null,{content:t,titleBar:e,closeByEsc:true,buttons:[new BX.PopupWindowButton({text:"Ok",className:"popup-window-button-accept",events:{click:function(){a.close();if(BX.type.isFunction(s)){s({})}}}})]});a.show()},__replaceAll:function(e,t){if(!BX.type.isPlainObject(t))return e;var s=e.replace(/#(\w+?)#/g,function(e,s,n){if(t.hasOwnProperty(s))return t[s];else return e});return s}};
//# sourceMappingURL=script.map.js