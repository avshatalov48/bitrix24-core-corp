(function(){var t=null;BX.VoximplantStatisticDetail=function(e){t=this;this.gridContainer=e.gridContainer;this.exportButton=e.exportButton;this.exportAllowed=e.exportAllowed;this.exportType=e.exportType;this.siteId=e.exportParams.siteId;this.componentName=e.exportParams.componentName;this.sToken=e.exportParams.sToken;this.cToken="";this.token="";this.exporting=false;this.exportPopup=null;this.exportProgressBar=null;this.exportExecuteButton=null;this.exportStopButton=null;this.exportInfo=null;var o=BX.Main.gridManager.getById(this.gridContainer.id);this.grid=o.instance;this.progressBar=null;this.progressBarLine=null;this.progressBarText=null;this.init()};Object.defineProperty(BX.VoximplantStatisticDetail,"Instance",{get:function(){return t}});BX.VoximplantStatisticDetail.prototype.init=function(){this.exportButton.addEventListener("click",this.createExportPopup.bind(this));this.initPlayer()};BX.VoximplantStatisticDetail.prototype.initPlayer=function(){var t=new BX.Fileman.Player("vi_records_player",{width:10,height:10,onInit:function(t){t.vjsPlayer.on("pause",function(){var t=BX.findChildrenByClassName(this.gridContainer,"vi-player-pause");for(var e in t){BX.removeClass(t[e],"vi-player-pause")}}.bind(this))}});t.isAudio=true;var e=t.createElement();e.style.display="none";BX.insertAfter(e,this.gridContainer);t.init();BX.bindDelegate(this.gridContainer,"click",{className:"vi-player-button"},function(e){var o=BX.findChildrenByClassName(this.gridContainer,"vi-player-pause");for(var i in o){BX.removeClass(o[i],"vi-player-pause")}var s=e.srcElement||e.target;var r=s.getAttribute("data-bx-record");if(r){r={src:r,type:"audio/mp3"};var n=t.getSource();if(n&&n.indexOf(r.src)!==-1&&t.isPlaying()){t.pause()}else{t.setSource(r);t.play();BX.addClass(s,"vi-player-pause")}e.preventDefault();return false}}.bind(this))};BX.VoximplantStatisticDetail.prototype.onShowTotalClick=function(t){var e=BX.create("span",{props:{className:"main-grid-panel-content-text"}});var o=t.currentTarget;this.showTotal(e).then(function(t){o.parentElement.appendChild(e);e.innerText=t;BX.cleanNode(o,true)});t.stopPropagation();t.preventDefault()};BX.VoximplantStatisticDetail.prototype.showTotal=function(){return new Promise(function(t){BX.ajax.runComponentAction("bitrix:voximplant.statistic.detail","getRowsCount",{mode:"class"}).then(function(e){var o=e.data;t(o.rowsCount)}).catch(function(t){if(t.errors){t.errors.forEach(function(t){console.error(t.message)})}})})};BX.VoximplantStatisticDetail.prototype.startExport=function(){if(!this.exportExecuteButton.isActive()){return}this.exportExecuteButton.removeClass("ui-btn-success");this.exportExecuteButton.addClass("ui-btn-disabled ui-btn-wait");this.exportExecuteButton.setActive(false);this.exportStopButton.removeClass("ui-btn-disabled");this.exportStopButton.addClass("ui-btn ui-btn-danger-light");this.exportStopButton.setActive(true);this.exportProgressBar=new BX.UI.ProgressBar({statusType:BX.UI.ProgressBar.Status.PERCENT,size:BX.UI.ProgressBar.Size.LARGE,fill:true});this.exportInfo=BX.create("div",{props:{className:"tel-stat-export-info"}});var t=BX.create("div",{props:{className:"tel-stat-export-progress-container"},state:BX.UI.Button.State.DISABLED,children:[this.exportInfo,this.exportProgressBar.getContainer()]});this.exportExecuteButton.removeClass("ui-btn-wait");this.exportPopup.setContent(t);this.cToken="c"+Date.now();this.token=this.sToken+this.cToken;this.exporting=true;this.nextExportStep()};BX.VoximplantStatisticDetail.prototype.nextExportStep=function(){if(!this.exporting){return}var t=BX.ajax.runAction("bitrix:voximplant.export.dispatcher",{data:{SITE_ID:this.siteId,PROCESS_TOKEN:this.token,EXPORT_TYPE:this.exportType,COMPONENT_NAME:this.componentName}});t.then(function(t){var e=t.data;if(e["STATUS"]==="PROGRESS"){this.setExportProgress(e["PROCESSED_ITEMS"],e["TOTAL_ITEMS"],e["SUMMARY_HTML"]);this.nextExportStep()}else if(e["STATUS"]==="COMPLETED"){this.exportFinish(e)}}.bind(this)).catch(function(t){console.error(t.errors);this.setExportPopupMessage({exportInfo:BX.message("TEL_STAT_EXPORT_ERROR")})}.bind(this))};BX.VoximplantStatisticDetail.prototype.exportFinish=function(t){var e=t["SUMMARY_HTML"];var o=t["TOTAL_ITEMS"];var i=t["PROCESSED_ITEMS"];var s;setTimeout(function(){this.setExportProgress(i,o,e);if(t["DOWNLOAD_LINK"]!==undefined){var r=t["DOWNLOAD_LINK"];var n=t["DOWNLOAD_LINK_NAME"];var a=t["CLEAR_LINK_NAME"];s={exportInfo:e,downloadFileLinkTitle:n,removeFileLinkTitle:a,downloadFileLink:r};this.createExportFileActions(s)}else{this.setExportPopupMessage({exportInfo:e})}}.bind(this),300)};BX.VoximplantStatisticDetail.prototype.stopExport=function(){if(!this.exportStopButton.isActive()){return}this.exporting=false;var t=BX.ajax.runAction("bitrix:voximplant.export.cancel",{data:{SITE_ID:this.siteId,PROCESS_TOKEN:this.token,EXPORT_TYPE:this.exportType,COMPONENT_NAME:this.componentName}});t.then(function(t){this.setExportPopupMessage({exportInfo:t.data["SUMMARY_HTML"]})}.bind(this)).catch(function(t){console.error(t.errors);this.setExportPopupMessage({exportInfo:BX.message("TEL_STAT_EXPORT_ERROR")})}.bind(this))};BX.VoximplantStatisticDetail.prototype.createExportPopup=function(){if(!this.exportAllowed){BX.UI.InfoHelper.show("limit_contact_center_telephony_excel_export");return}this.exportButton.classList.add("ui-btn-wait");this.exportButton.classList.add("ui-btn-disabled");this.exportPopup=new BX.PopupWindow("tel-stat-export-popup",null,{zIndex:1e4,titleBar:BX.message("TEL_STAT_EXPORT_DETAIL_TO_EXCEL"),content:BX.create("div",{props:{className:"tel-stat-export-description"},text:BX.message("TEL_STAT_EXPORT_DETAIL_TO_EXCEL_DESCRIPTION")+"\n\n"+BX.message("TEL_STAT_EXPORT_DETAIL_TO_EXCEL_LONG_PROCESS")}),closeByEsc:false,closeIcon:{opacity:1},overlay:{backgroundColor:"black",opacity:500},buttons:[this.exportExecuteButton=new BX.UI.Button({text:BX.message("TEL_STAT_ACTION_EXECUTE"),id:"export-execute-btn",className:"ui-btn ui-btn-success",state:BX.UI.Button.State.ACTIVE,events:{click:function(){this.startExport()}.bind(this)}}),this.exportStopButton=new BX.UI.Button({text:BX.message("TEL_STAT_ACTION_STOP"),id:"export-stop-btn",className:"ui-btn ui-btn-disabled",state:BX.UI.Button.State.DISABLED,events:{click:function(){this.stopExport()}.bind(this)}})],events:{onPopupClose:function(){this.closeExportPopup()}.bind(this)}});this.exportPopup.show()};BX.VoximplantStatisticDetail.prototype.closeExportPopup=function(){if(!this.exporting){this.exportButton.classList.remove("ui-btn-wait");this.exportButton.classList.remove("ui-btn-disabled");this.exportPopup.destroy();return}var t=BX.ajax.runAction("bitrix:voximplant.export.cancel",{data:{SITE_ID:this.siteId,PROCESS_TOKEN:this.token,EXPORT_TYPE:this.exportType,COMPONENT_NAME:this.componentName}});t.then(function(){this.exportButton.classList.remove("ui-btn-wait");this.exportButton.classList.remove("ui-btn-disabled");this.exportPopup.destroy()}.bind(this)).catch(function(t){console.error(t.errors);this.setExportPopupMessage({exportInfo:BX.message("TEL_STAT_EXPORT_ERROR")})}.bind(this))};BX.VoximplantStatisticDetail.prototype.setExportProgress=function(t,e,o){this.exportInfo.innerHTML=o;this.exportProgressBar.setMaxValue(e);this.exportProgressBar.update(t)};BX.VoximplantStatisticDetail.prototype.createExportFileActions=function(t){var e=t.exportInfo;var o=t.downloadFileLinkTitle;var i=t.removeFileLinkTitle;var s=t.downloadFileLink;var r=BX.create("div",{props:{className:"tel-stat-export-result-container"},children:[BX.create("div",{props:{className:"tel-stat-export-info"},html:e}),new BX.UI.Button({text:o,id:"export-execute-btn",className:"ui-btn ui-btn-success",icon:BX.UI.Button.Icon.DOWNLOAD,onclick:function(){location.href=s}}).getContainer(),new BX.UI.Button({text:i,id:"export-execute-btn",className:"ui-btn",icon:BX.UI.Button.Icon.REMOVE,onclick:function(){this.removeExportFile()}.bind(this)}).getContainer()]});this.afterExportFinish(r)};BX.VoximplantStatisticDetail.prototype.setExportPopupMessage=function(t){var e=t.exportInfo;var o=BX.create("div",{props:{className:"tel-stat-export-result-container"},children:[BX.create("div",{props:{className:"tel-stat-export-message"},html:e})]});this.afterExportFinish(o)};BX.VoximplantStatisticDetail.prototype.afterExportFinish=function(t){this.exportExecuteButton.addClass("ui-btn-disabled");this.exportExecuteButton.setActive(false);this.exportStopButton.setActive(false);this.exportStopButton.removeClass("ui-btn-danger-light");this.exportStopButton.addClass("ui-btn-disabled");this.exportPopup.setContent(t)};BX.VoximplantStatisticDetail.prototype.removeExportFile=function(){var t=BX.ajax.runAction("bitrix:voximplant.export.clear",{data:{SITE_ID:this.siteId,PROCESS_TOKEN:this.token,EXPORT_TYPE:this.exportType,COMPONENT_NAME:this.componentName}});t.then(function(t){this.setExportPopupMessage({exportInfo:t.data["SUMMARY_HTML"]})}.bind(this)).catch(function(t){console.error(t.errors);this.setExportPopupMessage({exportInfo:BX.message("TEL_STAT_EXPORT_ERROR")})}.bind(this))};BX.VoximplantStatisticDetail.prototype.downloadSelectedVoxRecords=function(){var t=this.grid.getRows().getSelectedIds();var e=t.length;var o=[];for(var i=0;i<e;i++){o.push({historyId:t[i]})}this.downloadVoxRecords(o)};BX.VoximplantStatisticDetail.prototype.downloadVoxRecords=function(t){var e=t.length;var o=0;var i=this.createDownloadPopup();i.show();this.setDownloadProgress(o,e);for(var s=0;s<e;s++){var r=t[s].historyId;this.downloadRecordByHistoryId(r).then(function(){o++;this.setDownloadProgress(o,e);if(o===e){setTimeout(function(){i.destroy();this.grid.reloadTable("GET",{apply_filter:"Y",clear_nav:"Y"})}.bind(this),300)}}.bind(this)).catch(function(){i.destroy();this.grid.reloadTable("GET",{apply_filter:"Y",clear_nav:"Y"})}.bind(this))}};BX.VoximplantStatisticDetail.prototype.downloadRecordByHistoryId=function(t){return new Promise(function(e,o){BX.ajax.runComponentAction("bitrix:voximplant.statistic.detail","downloadRecord",{mode:"class",data:{historyId:t}}).then(function(){e()}).catch(function(){BX.Voximplant.alert(BX.message("TEL_STAT_ERROR"),BX.message("TEL_STAT_DOWNLOAD_VOX_RECORD_ERROR"));o()})})};BX.VoximplantStatisticDetail.prototype.createDownloadPopup=function(){var t=BX.create("div",{props:{className:"ui-progressbar-text-before"},text:BX.message("TEL_STAT_LOADING")});var e=BX.create("div",{props:{className:"ui-progressbar-bar"}});var o=BX.create("div",{props:{className:"ui-progressbar-track"},children:[e]});var i=BX.create("div",{props:{className:"ui-progressbar-text-after"}});var s=BX.create("div",{props:{className:"ui-progressbar"},children:[t,o,i]});var r=BX.create("div",{props:{className:"tel-stat-download-progress-container"},children:[s]});this.progressBar=s;this.progressBarLine=e;this.progressBarText=i;return new BX.PopupWindow("bx-voximplant-statistic-detail-download-popup",null,{zIndex:1e4,closeByEsc:false,buttons:"",overlay:true,content:r})};BX.VoximplantStatisticDetail.prototype.setDownloadProgress=function(t,e){var o=Math.round(t/e*100).toPrecision(2);this.progressBarLine.style.width=o+"%";this.progressBarText.innerHTML=t+" / "+e}})();
//# sourceMappingURL=script.map.js