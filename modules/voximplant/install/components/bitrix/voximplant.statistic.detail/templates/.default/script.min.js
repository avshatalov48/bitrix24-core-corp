(function(){var t=null;BX.VoximplantStatisticDetail=function(e){t=this;this.gridContainer=e.gridContainer;this.exportButton=e.exportButton;this.exportAllowed=e.exportAllowed;this.exportType=e.exportType;this.componentName=e.exportParams.componentName;this.exporter=null;this.recordDownloading=null;this.downloadPopup=null;var o=BX.Main.gridManager.getById(this.gridContainer.id);this.grid=o.instance;this.progressBar=null;this.progressBarLine=null;this.progressBarText=null;this.reportParams=e.reportParams;this.init()};Object.defineProperty(BX.VoximplantStatisticDetail,"Instance",{get:function(){return t}});BX.VoximplantStatisticDetail.prototype.init=function(){if(!this.reportParams["from_analytics"]){this.createDownloadHint();BX.addCustomEvent("Grid::updated",this.createDownloadHint);this.exportButton.addEventListener("click",this.showExporter.bind(this))}if(this.exportAllowed){this.initExporter()}this.initPlayer()};BX.VoximplantStatisticDetail.prototype.initPlayer=function(){var t=new BX.Fileman.Player("vi_records_player",{width:10,height:10,onInit:function(t){t.vjsPlayer.on("pause",function(){var t=BX.findChildrenByClassName(this.gridContainer,"vi-player-pause");for(var e in t){BX.removeClass(t[e],"vi-player-pause")}}.bind(this))}});t.isAudio=true;var e=t.createElement();e.style.display="none";BX.insertAfter(e,this.gridContainer);t.init();BX.bindDelegate(this.gridContainer,"click",{className:"vi-player-button"},function(e){var o=BX.findChildrenByClassName(this.gridContainer,"vi-player-pause");for(var i in o){BX.removeClass(o[i],"vi-player-pause")}var r=e.srcElement||e.target;var a=r.getAttribute("data-bx-record");if(a){a={src:a,type:"audio/mp3"};var s=t.getSource();if(s&&s.indexOf(a.src)!==-1&&t.isPlaying()){t.pause()}else{t.setSource(a);t.play();BX.addClass(r,"vi-player-pause")}e.preventDefault();return false}}.bind(this))};BX.VoximplantStatisticDetail.prototype.onShowTotalClick=function(t){var e=BX.create("span",{props:{className:"main-grid-panel-content-text"}});var o=t.currentTarget;this.showTotal(e).then(function(t){o.parentElement.appendChild(e);e.innerText=t;BX.cleanNode(o,true)});t.stopPropagation();t.preventDefault()};BX.VoximplantStatisticDetail.prototype.showTotal=function(){var t={mode:"class"};if(this.reportParams!=null){t.data=this.reportParams}return new Promise(function(e){BX.ajax.runComponentAction("bitrix:voximplant.statistic.detail","getRowsCount",t).then(function(t){var o=t.data;e(o.rowsCount)}).catch(function(t){if(t.errors){t.errors.forEach(function(t){console.error(t.message)})}})})};BX.VoximplantStatisticDetail.prototype.initExporter=function(){this.exporter=new BX.UI.StepProcessing.Process({id:"VoximplantStatisticDetailExport",controller:"bitrix:voximplant.export",messages:{DialogTitle:BX.message("TEL_STAT_EXPORT_DETAIL_TO_EXCEL"),DialogSummary:BX.message("TEL_STAT_EXPORT_DETAIL_TO_EXCEL_DESCRIPTION")+"\n\n"+BX.message("TEL_STAT_EXPORT_DETAIL_TO_EXCEL_LONG_PROCESS"),DialogStartButton:BX.message("TEL_STAT_ACTION_EXECUTE"),DialogStopButton:BX.message("TEL_STAT_ACTION_STOP"),DialogCloseButton:BX.message("TEL_STAT_ACTION_CLOSE"),RequestError:BX.message("TEL_STAT_EXPORT_ERROR")},showButtons:{start:true,stop:true,close:true},dialogMaxWidth:650});if(this.reportParams!=null){this.exporter.setParams(this.reportParams)}this.exporter.setParam("EXPORT_TYPE",this.exportType).setParam("COMPONENT_NAME",this.componentName).addQueueAction({action:"dispatcher"})};BX.VoximplantStatisticDetail.prototype.showExporter=function(){if(!this.exportAllowed){BX.UI.InfoHelper.show("limit_contact_center_telephony_excel_export");return}this.exporter.showDialog()};BX.VoximplantStatisticDetail.prototype.downloadSelectedVoxRecords=function(){var t=this.grid.getRows().getSelectedIds();var e=t.length;var o=[];for(var i=0;i<e;i++){o.push({historyId:t[i]})}BX.ajax.runComponentAction("bitrix:voximplant.statistic.detail","isRecordsAlreadyUploaded",{mode:"class",data:{historyIds:o}}).then(function(t){if(t.data){BX.Voximplant.alert(BX.message("TEL_STAT_RECORDS_ALREADY_DOWNLOADED_TITLE"),BX.message("TEL_STAT_RECORDS_ALREADY_DOWNLOADED"))}else{this.downloadVoxRecords(o)}}.bind(this)).catch(function(){BX.Voximplant.alert(BX.message("TEL_STAT_ERROR"),BX.message("TEL_STAT_DOWNLOAD_VOX_RECORD_ERROR"));reject()})};BX.VoximplantStatisticDetail.prototype.downloadVoxRecords=function(t){var e=t.length;var o=0;var i=t[o].historyId;this.downloadPopup=this.createDownloadPopup();this.downloadPopup.show();this.setDownloadProgress(o,e);this.recordDownloading=true;this.downloadVoxRecordsSequentially(i,t,o,e)};BX.VoximplantStatisticDetail.prototype.downloadVoxRecordsSequentially=function(t,e,o,i){if(!this.recordDownloading){this.downloadPopup.destroy();this.grid.reloadTable("GET",{apply_filter:"Y",clear_nav:"Y"});return}this.downloadRecordByHistoryId(t).then(function(){o++;this.setDownloadProgress(o,i);if(o===i){setTimeout(function(){this.downloadPopup.destroy();this.grid.reloadTable("GET",{apply_filter:"Y",clear_nav:"Y"});BX.Voximplant.alert(BX.message("TEL_STAT_RECORDS_ALREADY_DOWNLOADED_TITLE"),BX.message("TEL_STAT_RECORDS_DOWNLOADED_AVAILABLE"))}.bind(this),300);return}t=e[o].historyId;this.downloadVoxRecordsSequentially(t,e,o,i)}.bind(this))};BX.VoximplantStatisticDetail.prototype.downloadRecordByHistoryId=function(t){return new Promise(function(e,o){BX.ajax.runComponentAction("bitrix:voximplant.statistic.detail","downloadRecord",{mode:"class",data:{historyId:t}}).then(function(){e()}.bind(this)).catch(function(){e()}.bind(this))})};BX.VoximplantStatisticDetail.prototype.createDownloadPopup=function(){var t=BX.create("div",{props:{className:"ui-progressbar-text-before"},text:BX.message("TEL_STAT_LOADING")});var e=BX.create("div",{props:{className:"ui-progressbar-bar"}});var o=BX.create("div",{props:{className:"ui-progressbar-track"},children:[e]});var i=BX.create("div",{props:{className:"ui-progressbar-text-after"}});var r=BX.create("div",{props:{className:"ui-progressbar"},children:[t,o,i]});var a=BX.create("div",{props:{className:"tel-stat-download-progress-container"},children:[r]});this.progressBar=r;this.progressBarLine=e;this.progressBarText=i;var s=new BX.PopupWindow("bx-voximplant-statistic-detail-download-popup",null,{titleBar:BX.message("TEL_STAT_RECORDS_ALREADY_DOWNLOADED_TITLE"),content:a,buttons:[new BX.UI.Button({text:BX.message("TEL_STAT_ACTION_STOP"),id:"tel-download-cancel-btn",color:BX.UI.Button.Color.LIGHT_BORDER,onclick:function(){this.recordDownloading=false;s.destroy()}.bind(this)})],overlay:true,closeByEsc:false});return s};BX.VoximplantStatisticDetail.prototype.setDownloadProgress=function(t,e){var o=Math.round(t/e*100).toPrecision(2);this.progressBarLine.style.width=o+"%";this.progressBarText.innerHTML=t+" / "+e};BX.VoximplantStatisticDetail.prototype.createDownloadHint=function(){if(!BX("download_records_hint")){var t=BX.UI.Hint.createNode(BX.message("TEL_STAT_ACTION_VOX_DOWNLOAD_HINT"));t.setAttribute("id","download_records_hint");BX("download_records").appendChild(t)}}})();
//# sourceMappingURL=script.map.js