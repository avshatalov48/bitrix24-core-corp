"use strict";BX.namespace("BX.Voximplant");BX.Voximplant.Numbers={init:function(e){this.numbers=e.numbers?e.numbers:{};this.users=e.users?e.users:{};this.isPhoneAllowed=e.isPhoneAllowed;BX.ready(function(){BX.bind(BX("search_btn"),"click",function(){BX.submit(BX("search_form"));return false});BX.bind(BX("clear_btn"),"click",function(){BX("search_form").elements.FILTER.value="";BX.submit(BX("search_form"));return false});BX.bind(BX("option_btn"),"click",function(){var e=BX.create("SPAN",{props:{className:"wait"}});BX.addClass(BX("option_btn"),"webform-small-button-wait webform-small-button-active");this.appendChild(e);BX.ajax({method:"POST",url:BX.message("VI_NUMBERS_URL")+"option",data:{sessid:BX.bitrix_sessid(),portalNumber:BX("option_form").elements.portalNumber.value},dataType:"json",onsuccess:function(){BX.removeClass(BX("option_btn"),"webform-small-button-wait webform-small-button-active");BX.remove(e)},onfailure:function(){BX.removeClass(BX("option_btn"),"webform-small-button-wait webform-small-button-active");BX.remove(e)}});return false})})},showPhoneBlock:function(e,t){var s=document.querySelector("[data-role='vi_phone_"+t+"']");if(s&&typeof s=="object"){s.style.display=e=="Y"?"block":"none"}},getUserInfo:function(e){BX.showWait(BX("vi_numbers_dialog_"+e));BX.ajax({method:"POST",url:BX.message("VI_NUMBERS_URL")+"getInfo&USER_ID="+e,data:{sessid:BX.bitrix_sessid()},dataType:"json",onsuccess:function(t){BX.closeWait();if(t.result=="error"){var s=document.querySelector('[data-role="popup_error_'+e+'"]');if(s){s.innerHTML=t.error;s.style.display="block"}}else{var n=document.querySelector("[data-role='phone_server_"+e+"']");if(typeof n=="object"){n.innerHTML=t.call_server}n=document.querySelector("[data-role='phone_login_"+e+"']");if(typeof n=="object"){n.innerHTML=t.phone_login}n=document.querySelector("[data-role='phone_password_"+e+"']");if(typeof n=="object"){n.innerHTML=t.phone_password}if(BX("UF_VI_PHONE_PASSWORD_"+e))BX("UF_VI_PHONE_PASSWORD_"+e).value=t.phone_password;BX.Voximplant.Numbers.showPhoneBlock("Y",e)}}})},edit:function(e){var t=this;var s=this.users[e].UF_VI_BACKPHONE;var n=this.users[e].UF_PHONE_INNER;var i=this.users[e].UF_VI_PHONE=="Y";var a=[];for(var r in this.numbers){if(this.numbers.hasOwnProperty(r)){a.push(['<option value="',r,'" ',s==r?"selected":"",">",this.numbers[r],"</option>"].join(""))}}var o=[BX.create("tr",{children:[BX.create("td",{children:[BX.create("div",{attrs:{"data-role":"popup_error_"+e,className:"vi-numbers-error"}})],attrs:{colspan:"2",style:"padding: 0"}})]}),BX.create("tr",{children:[BX.create("td",{children:[BX.create("input",{attrs:{type:"hidden",name:"sessid",value:BX.bitrix_sessid()}}),BX.create("input",{attrs:{type:"hidden",name:"USER_ID",value:e}}),BX.create("span",{attrs:{style:"line-height: 20px; display: inline-block; padding: 4px 0px 8px;"},html:t.users[e].NAME_HTML})],attrs:{colspan:"2"}})]}),BX.create("tr",{children:[BX.create("td",{children:[BX.create("label",{attrs:{for:"innerphone_"+e},html:BX.message("VI_NUMBERS_GRID_CODE")+":"})]}),BX.create("td",{children:[BX.create("input",{attrs:{name:"UF_PHONE_INNER",id:"innerphone_"+e,value:n,className:"tel-set-inp",style:"width:225px;"}})]})]}),BX.create("tr",{children:[BX.create("td",{children:[BX.create("label",{attrs:{for:"s_backphone_"+e},html:BX.message("VI_NUMBERS_GRID_PHONE")+":"})]}),BX.create("td",{children:[BX.create("select",{attrs:{name:"UF_VI_BACKPHONE",id:"s_backphone_"+e,style:"width:225px;",className:"tel-set-inp"},html:a.join("")})]})]})];if(this.isPhoneAllowed){o.push(BX.create("tr",{children:[BX.create("td",{html:BX.message("VI_NUMBERS_PHONE_CONNECT")}),BX.create("td",{children:[BX.create("input",{attrs:{type:"radio",name:"UF_VI_PHONE",id:"UF_VI_PHONE_ENABLE"+e,checked:i?"checked ":"",value:"Y"},events:{change:function(){if(this.checked)t.getUserInfo(e)}}}),BX.create("label",{html:BX.message("VI_NUMBERS_PHONE_CONNECT_ON"),attrs:{for:"UF_VI_PHONE_ENABLE"+e}}),BX.create("input",{attrs:{type:"radio",name:"UF_VI_PHONE",id:"UF_VI_PHONE_DISABLE"+e,checked:!i?"checked ":"",value:"N",style:"margin-left: 10px;"},events:{change:function(){if(this.checked)BX.Voximplant.Numbers.showPhoneBlock("N",e)}}}),BX.create("label",{html:BX.message("VI_NUMBERS_PHONE_CONNECT_OFF"),attrs:{for:"UF_VI_PHONE_DISABLE"+e}})]})]}));var l=BX.create("table",{children:[BX.create("tr",{children:[BX.create("td",{html:BX.message("VI_NUMBERS_PHONE_CONNECT_INFO"),attrs:{colspan:"2"}})]}),BX.create("tr",{children:[BX.create("td",{html:BX.message("VI_NUMBERS_PHONE_CONNECT_SERVER")+":",attrs:{style:"text-align: right; width: 65px;"}}),BX.create("td",{attrs:{style:"font-weight: bold","data-role":"phone_server_"+e}})]}),BX.create("tr",{children:[BX.create("td",{html:BX.message("VI_NUMBERS_PHONE_CONNECT_LOGIN")+":",attrs:{style:"text-align: right"}}),BX.create("td",{attrs:{style:"font-weight: bold","data-role":"phone_login_"+e}})]}),BX.create("tr",{children:[BX.create("td",{html:BX.message("VI_NUMBERS_PHONE_CONNECT_PASSWORD")+":",attrs:{style:"text-align: right"}}),BX.create("td",{children:[BX.create("span",{attrs:{"data-role":"phone_password_"+e,className:"bx-vi-phone-password"}}),BX.create("input",{attrs:{type:"text",name:"UF_VI_PHONE_PASSWORD",id:"UF_VI_PHONE_PASSWORD_"+e,size:"28",style:"display:none",className:"bx-vi-phone-password-input"},events:{change:function(e){this.previousSibling.innerHTML=BX.util.htmlspecialchars(this.value)}}}),BX.create("span",{attrs:{className:"bx-vi-phone-icon bx-vi-phone-edit"},events:{click:function(){this.previousSibling.previousSibling.style.display="none";this.previousSibling.style.display="inline-block";this.style.display="none";this.nextSibling.style.display="inline-block"}}}),BX.create("span",{attrs:{className:"bx-vi-phone-icon",style:"display: none; vertical-align: top;"},html:"&times;",events:{click:function(){this.previousSibling.previousSibling.previousSibling.style.display="inline-block";this.previousSibling.previousSibling.style.display="none";this.style.display="none";this.previousSibling.style.display="inline-block"}}})],attrs:{style:"font-weight: bold; white-space: nowrap; height: 21px;"}})]})],attrs:{className:"bx-vi-phone","data-role":"vi_phone_"+e,style:"display:none;"}})}var _=BX.create("form",{children:[BX.create("table",{children:o,attrs:{className:"bx-vi-numbers-table"}})],attrs:{id:"vi_numbers_dialog_"+e}});if(this.isPhoneAllowed){_.appendChild(BX.create("div",{children:[l],attrs:{className:"bx-vi-numbers-table"}}))}BX.PopupWindowManager.create("VI_NUMBERS_POPUP_"+e,null,{autoHide:true,offsetLeft:0,offsetTop:0,overlay:true,draggable:{restrict:true},closeByEsc:true,titleBar:BX.message("VI_NUMBERS_CREATE_TITLE"),content:'<div style="width:460px; min-height:400px"></div>',events:{onAfterPopupShow:function(){this.setContent(_);if(i)t.getUserInfo(e)}},buttons:[new BX.PopupWindowButton({text:BX.message("VI_NUMBERS_SAVE"),className:"popup-window-button-accept",events:{click:function(){var s=document.querySelector('[data-role="popup_error_'+e+'"]');if(s){s.innerHTML="";s.style.display="none"}var n=BX("vi_numbers_dialog_"+e);var i=this;if(n){var a={};for(var r=0;r<n.elements.length;r++){if(n[r].name=="UF_VI_PHONE"&&!n[r].checked)continue;a[n[r].name]=n[r].value}BX.ajax({method:"POST",url:BX.message("VI_NUMBERS_URL")+"edit&USER_ID="+e,data:a,dataType:"json",onsuccess:function(n){if(n.result=="error"){if(s){s.innerHTML=n.error;s.style.display="block"}}else{t.users[e].UF_VI_BACKPHONE=n.UF_VI_BACKPHONE?n.UF_VI_BACKPHONE:"";t.users[e].UF_PHONE_INNER=n.UF_PHONE_INNER;t.users[e].UF_VI_PHONE=n.UF_VI_PHONE;if(BX("innerphone_"+e))BX("innerphone_"+e).innerHTML=n.UF_PHONE_INNER;var a=!!n.UF_VI_BACKPHONE&&!!t.numbers[n.UF_VI_BACKPHONE]?n.UF_VI_BACKPHONE:"";if(BX("backphone_"+e)){BX("backphone_"+e).innerHTML=t.numbers[a];BX("backphone_"+e+"_value").innerHTML=a}if(BX("vi_phone_"+e)){BX("vi_phone_"+e).innerHTML=n.UF_VI_PHONE=="Y"?BX.message("VI_NUMBERS_PHONE_DEVICE_ENABLE"):BX.message("VI_NUMBERS_PHONE_DEVICE_DISABLE");if(n.UF_VI_PHONE=="Y")BX.addClass(BX("vi_phone_"+e),"bx-vi-phone-enable");else BX.removeClass(BX("vi_phone_"+e),"bx-vi-phone-enable")}if(BX("vi_phone_enable_"+e))BX("vi_phone_enable_"+e).innerHTML=n.UF_VI_PHONE;i.popupWindow.destroy()}},onfailure:function(){if(s){s.innerHTML=BX.message("VI_NUMBERS_ERR_AJAX");s.style.display="block"}}})}}}}),new BX.PopupWindowButtonLink({text:BX.message("VI_NUMBERS_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){this.popupWindow.destroy()}}})]}).show()}};