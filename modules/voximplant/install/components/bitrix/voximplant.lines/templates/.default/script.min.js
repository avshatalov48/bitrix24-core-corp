(function(){BX.namespace("BX.Voximplant");var e="voximplant_lines";BX.Voximplant.Lines={init:function(e){this.isTelephonyAvailable=e.isTelephonyAvailable==="Y";BX.bind(BX("add-group"),"click",this.addGroup.bind(this))},reloadGrid:function(){if(!BX.Main||!BX.Main.gridManager){return}var t=BX.Main.gridManager.getById(e);if(!t){return}t.instance.reload()},showConfig:function(e){BX.SidePanel.Instance.open("/telephony/edit.php?ID="+e,{cacheable:false,allowChangeHistory:false,events:{onClose:this.reloadGrid.bind(this)}})},addGroup:function(){var e=new BX.Voximplant.NumberGroup({onClose:this.reloadGrid.bind(this)});e.show()},deleteGroup:function(e){BX.Voximplant.showLoader();BX.ajax.runComponentAction("bitrix:voximplant.lines","deleteGroup",{data:{id:e}}).then(function(e){BX.Voximplant.hideLoader();this.reloadGrid()}.bind(this)).catch(function(e){BX.Voximplant.hideLoader();var t=e.errors[0];BX.Voximplant.alert(BX.message("VOX_LINES_ERROR"),t.message)})},editGroup:function(e){var t=new BX.Voximplant.NumberGroup({groupId:e});t.show()},addNumberToGroup:function(e,t){BX.Voximplant.showLoader();BX.ajax.runComponentAction("bitrix:voximplant.lines","addToGroup",{data:{number:e,groupId:t}}).then(function(e){BX.Voximplant.hideLoader();this.reloadGrid()}.bind(this)).catch(function(e){BX.Voximplant.hideLoader();var t=e.errors[0];BX.Voximplant.alert(BX.message("VOX_LINES_ERROR"),t.message)})},removeNumberFromGroup:function(e){BX.Voximplant.showLoader();BX.ajax.runComponentAction("bitrix:voximplant.lines","removeFromGroup",{data:{number:e}}).then(function(e){BX.Voximplant.hideLoader();this.reloadGrid()}.bind(this)).catch(function(e){BX.Voximplant.hideLoader();var t=e.errors[0];BX.Voximplant.alert(BX.message("VOX_LINES_ERROR"),t.message)})},getCallerIdFields:function(e){return new Promise(function(t,n){BX.ajax.runAction("voximplant.callerid.get",{data:{phoneNumber:e}}).then(function(e){t(e.data)}).catch(function(e){n(e.errors[0])})})},verifyCallerId:function(e){var t=this.getCallerIdFields(e);var n=new BX.Voximplant.CallerIdSlider({dataPromise:t,onClose:this.reloadGrid.bind(this)});n.show()},deleteCallerId:function(e){var t=this;BX.Voximplant.confirm(BX.message("VOX_LINES_CONFIRM_ACTION"),BX.message("VOX_LINES_CALLERID_DELETE_CONFIRM").replace("#NUMBER#",e)).then(function(n){if(!n){return}BX.Voximplant.showLoader();BX.ajax.runAction("voximplant.callerId.delete",{data:{phoneNumber:e}}).then(function(){BX.Voximplant.hideLoader();t.reloadGrid()}).catch(function(e){BX.Voximplant.hideLoader();var t=e.errors[0];BX.Voximplant.alert(BX.message("VOX_LINES_ERROR"),t.message)})})},deleteSip:function(e){var t=this;BX.Voximplant.confirm(BX.message("VOX_LINES_CONFIRM_ACTION"),BX.message("VOX_LINES_SIP_DELETE_CONFIRM")).then(function(n){if(!n){return}BX.Voximplant.showLoader();BX.ajax.runAction("voximplant.sip.delete",{data:{id:e}}).then(function(){BX.Voximplant.hideLoader();t.reloadGrid()}).catch(function(e){BX.Voximplant.hideLoader();var t=e.errors[0];BX.Voximplant.alert(BX.message("VOX_LINES_ERROR"),t.message)})})},deleteNumber:function(e){BX.Voximplant.NumberRent.create().deleteNumber(e).then(function(){this.reloadGrid()}.bind(this))},cancelNumberDeletion:function(e){BX.Voximplant.NumberRent.create().cancelNumberDeletion(e).then(function(){this.reloadGrid()}.bind(this))}};BX.Voximplant.NumberGroup=function(e){this.slider=null;this.id=e.id||null;this.groupName="";this.selectedNumbers={};this.unassignedNumbers=[];this.elements={groupName:null,error:null,numbersContainer:null,createButton:null,cancelButton:null};this.callBacks={onClose:BX.type.isFunction(e.onClose)?e.onClose:BX.DoNothing}};BX.Voximplant.NumberGroup.prototype={fetchUnassignedNumbers:function(){return new Promise(function(e,t){BX.ajax.runComponentAction("bitrix:voximplant.lines","getUnassignedNumbers").then(function(t){this.unassignedNumbers=t.data;e()}.bind(this)).catch(function(e){console.error(e.errors[0]);t()})}.bind(this))},show:function(){BX.SidePanel.Instance.open("voximplant:number-group-add",{width:400,events:{onClose:this.onSliderClose.bind(this),onDestroy:this.onSliderDestroy.bind(this)},contentCallback:function(e){var t=new BX.Promise;this.slider=e;top.BX.loadExt("voximplant.common").then(function(){this.fetchUnassignedNumbers().then(function(){var e=this.render();t.resolve(e)}.bind(this))}.bind(this),0);return t}.bind(this)})},render:function(){return BX.createFragment([BX.create("div",{props:{className:"voximplant-slider-pagetitle-wrap"},children:[BX.create("div",{props:{className:"voximplant-slider-pagetitle"},children:[BX.create("span",{text:BX.message("VOX_LINES_ADD_NUMBER_GROUP")})]})]}),BX.create("div",{props:{className:"voximplant-container voximplant-options-popup"},children:[BX.create("h2",{props:{className:"voximplant-control-row"},children:[BX.create("div",{props:{className:"voximplant-control-title-editable"},children:[this.elements.groupName=BX.create("input",{props:{className:"voximplant-control-input"},attrs:{type:"text",value:this.groupName,placeholder:BX.message("VOX_LINES_NUMBER_GROUP_NAME")},events:{change:function(e){this.groupName=e.currentTarget.value}.bind(this)}}),BX.create("span",{props:{className:"voximplant-control-btn-edit"}})]})]}),this.elements.error=BX.create("div",{props:{className:"voximplant-control-row"}}),BX.create("div",{props:{className:"voximplant-control-row"},children:[BX.create("h5",{props:{className:"voximplant-control-title-grey-sm"},text:BX.message("VOX_LINES_SELECT_UNASSIGNED_NUMBERS")}),this.elements.numbersContainer=BX.create("div",{props:{className:"voximplant-number-group-numbers voximplant-group-create"},children:this.renderUnassignedNumbers()})]}),BX.create("div",{props:{className:"voximplant-control-row"},children:[this.elements.createButton=BX.create("button",{props:{className:"ui-btn ui-btn-primary"+(this.unassignedNumbers.length===0?" ui-btn-disabled":"")},text:BX.message("VOX_LINES_BUTTON_CREATE"),events:{click:this.onCreateButtonClick.bind(this)}}),this.elements.cancelButton=BX.create("button",{props:{className:"ui-btn ui-btn-primary"},text:BX.message("VOX_LINES_BUTTON_CANCEL"),events:{click:this.onCancelButtonClick.bind(this)}})]})]})])},renderUnassignedNumbers:function(){if(this.unassignedNumbers.length===0){return[BX.create("div",{props:{className:"ui-alert ui-alert-danger"},children:[BX.create("span",{props:{className:"ui-alert-message"},text:BX.message("VOX_LINES_NO_UNASSIGNED_NUMBERS")})]})]}return this.unassignedNumbers.map(function(e){return BX.create("span",{props:{className:"tel-set-list-item"},children:[BX.create("input",{props:{id:"phone"+e["ID"],className:"tel-set-list-item-checkbox",type:"checkbox",value:e["ID"]},events:{change:this.onNumberChanged.bind(this)}}),BX.create("label",{props:{className:"tel-set-list-item-num"},attrs:{for:"phone"+e["ID"]},text:e["NAME"]})]})},this)},showError:function(e){BX.adjust(this.elements.error,{children:[BX.create("div",{props:{className:"ui-alert ui-alert-danger ui-alert-icon-danger"},children:[BX.create("span",{props:{className:"ui-alert-message"},text:e})]})]})},hideError:function(){BX.cleanNode(this.elements.error)},onSliderClose:function(e){this.slider.destroy();this.callBacks.onClose()},onSliderDestroy:function(e){this.slider=null},onNumberChanged:function(e){var t=e.currentTarget.value;var n=e.currentTarget.checked;if(n){this.selectedNumbers[t]=true}else{delete this.selectedNumbers[t]}},onCreateButtonClick:function(e){this.hideError();if(this.unassignedNumbers.length===0){return}BX.addClass(this.elements.createButton,"ui-btn-wait");BX.ajax.runComponentAction("bitrix:voximplant.lines","createGroup",{data:{name:this.groupName,numbers:Object.keys(this.selectedNumbers)}}).then(function(e){BX.removeClass(this.elements.createButton,"ui-btn-wait");this.slider.close()}.bind(this)).catch(function(e){BX.removeClass(this.elements.createButton,"ui-btn-wait");var t=e.errors[0];this.showError(t.message)}.bind(this))},onCancelButtonClick:function(e){this.slider.close()}}})();
//# sourceMappingURL=script.map.js