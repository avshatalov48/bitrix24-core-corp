(function(){"use strict";var e="/bitrix/components/bitrix/voximplant.ivr.edit/ajax.php";var t={VOICE_LIST:null,SPEED_LIST:null,VOLUME_LIST:null,DEFAULT_VOICE:null,DEFAULT_SPEED:null,DEFAULT_VOLUME:null,IVR_LIST_URL:null,TELEPHONY_GROUPS:[],STRUCTURE:{},USERS:{},IS_ENABLED:false,MAX_DEPTH:0,MAX_GROUPS:-1};var i=function(e){var t="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";var i="";for(var s=e;s>0;--s)i+=t[Math.floor(Math.random()*t.length)];return i};BX.IvrEditor=function(e){this.node=e.node;this.isNew=e.isNew;this.ttsDisclaimer=e.ttsDisclaimer;if(this.isNew){this.ivrData={ID:0,NAME:"",ROOT_ITEM:this.createItem({LEVEL:0,ACTIONS:[this.createAction({DIGIT:"0",ACTION:"exit"}),this.createAction({DIGIT:"1"}),this.createAction({DIGIT:"2"}),this.createAction({DIGIT:"3"}),this.createAction({DIGIT:"4"}),this.createAction({DIGIT:"5"})]})}}else{this.ivrData=e.ivrData}this.saving=false;this.keypadPopup=null;this.actionTypeMenu=null;this.currentGroupAction=null;this.elements={saveButton:null}};BX.IvrEditor.setDefaults=function(e){t.VOICE_LIST=e.VOICE_LIST;t.SPEED_LIST=e.SPEED_LIST;t.VOLUME_LIST=e.VOLUME_LIST;t.DEFAULT_VOICE=e.DEFAULT_VOICE;t.DEFAULT_SPEED=e.DEFAULT_SPEED;t.DEFAULT_VOLUME=e.DEFAULT_VOLUME;t.IVR_LIST_URL=e.IVR_LIST_URL;t.TELEPHONY_GROUPS=e.TELEPHONY_GROUPS||[];t.STRUCTURE=e.STRUCTURE||{};t.USERS=e.USERS||{};t.IS_ENABLED=e.IS_ENABLED==true;t.MAX_DEPTH=e.MAX_DEPTH||0;t.MAX_GROUPS=BX.prop.getInteger(e,"MAX_GROUPS",-1)};BX.IvrEditor.prototype.init=function(){var e=this;if(!t.IS_ENABLED){this.showUnavailablePopup()}BX.addCustomEvent(window,"SidePanel.Slider:onClose",this._onSliderClosed.bind(this));BX.addCustomEvent(window,"SidePanel.Slider:onMessage",this._onSliderMessageReceived.bind(this));this.render()};BX.IvrEditor.prototype.getNode=function(e,t){if(!t)t=this.getMainNode();return t?t.querySelector('[data-role="'+e+'"]'):null};BX.IvrEditor.prototype.getMainNode=function(){return this.node};BX.IvrEditor.prototype.getTemplate=function(e,t){if(!t)t=this.getMainNode();var i=t.querySelector('script[data-template="'+e+'"]');return i?i.innerHTML:""};BX.IvrEditor.prototype.render=function(){var e=this;BX.cleanNode(this.node);var i=BX.create("div",{props:{className:"ivr-wrap"},children:[BX.create("div",{props:{className:"ivr-root-lvl"},children:[BX.create("div",{props:{className:"ivr-block"},children:[BX.create("div",{props:{className:"ivr-block-row ivr-title-editable"},children:[BX.create("input",{attrs:{className:"ivr-input-text",value:this.ivrData.NAME,placeholder:BX.message("VOX_IVR_EDIT_MENU_TITLE")},events:{bxchange:function(t){e.ivrData.NAME=t.target.value}}})]})]}),this.renderItem(this.ivrData.ROOT_ITEM)]}),BX.create("div",{props:{className:"tel-set-footer-btn-fixed"},children:[this.elements.saveButton=!t.IS_ENABLED?null:BX.create("button",{props:{className:"ui-btn ui-btn-success"},text:BX.message("VOX_IVR_EDIT_SAVE"),events:{click:this._onSaveButtonClick.bind(this)}}),BX.create("span",{props:{className:"ui-btn ui-btn-link"},text:BX.message("VOX_IVR_EDIT_CANCEL"),events:{click:this._onCancelButtonClick.bind(this)}})]})]});this.node.appendChild(i)};BX.IvrEditor.prototype.hide=function(e){if(BX.type.isArray(e)){e.forEach((function(e){e.style.display="none"}))}else if(BX.type.isDomNode(e)){e.style.display="none"}};BX.IvrEditor.prototype.show=function(e){if(BX.type.isArray(e)){e.forEach((function(e){e.style.removeProperty("display")}))}else if(BX.type.isDomNode(e)){e.style.removeProperty("display")}};BX.IvrEditor.prototype.renderItem=function(e){var i=this;var s={fileUploader:null,fileDescription:null,textInputContainer:null,additionalTtsBlock:null,ivrExitHint:null,textInput:null,ttsDisclaimer:null};var o=BX.create("div",{children:[BX.create("div",{props:{className:"ivr-block"},children:[BX.create("h4",{props:{className:"ivr-block-title"},text:BX.message("VOX_IVR_EDIT_MENU_SOURCE")}),BX.create("div",{props:{className:"ivr-block-row"},children:[BX.create("select",{props:{className:"ivr-input-select"},children:[BX.create("option",{attrs:{value:"file",selected:e.TYPE=="file"},text:BX.message("VOX_IVR_EDIT_MENU_SOURCE_FILE")}),BX.create("option",{attrs:{value:"message",selected:e.TYPE=="message"},text:BX.message("VOX_IVR_EDIT_MENU_SOURCE_MESSAGE")})],events:{change:function(t){e.TYPE=t.target.value;switch(e.TYPE){case"file":i.hide([s.textInputContainer,s.ttsDisclaimer]);i.show([s.fileUploader,s.fileDescription]);if(e._uploader){e._uploader.resize()}break;case"message":i.show([s.textInputContainer,s.ttsDisclaimer]);i.hide([s.fileUploader,s.fileDescription]);break}}}}),s.fileUploader=BX.create("div",{props:{className:"ivr-uploader-container"},style:e.TYPE=="message"?{display:"none"}:{}})]}),s.ttsDisclaimer=BX.create("div",{props:{className:"ivr-block-row"},style:e.TYPE=="file"?{display:"none"}:{},children:[BX.create("div",{props:{className:"ui-alert ui-alert-warning ui-alert-icon-danger "},children:[BX.create("span",{props:{className:"ui-alert-message"},html:this.ttsDisclaimer}),BX.create("span",{props:{className:"ui-alert-close-btn"},events:{click:()=>this.hide(s.ttsDisclaimer)}})]})]}),s.fileDescription=BX.create("div",{props:{className:"ivr-block-row"},style:e.TYPE=="message"?{display:"none"}:{},children:[BX.create("div",{props:{className:"ivr-block-description"},text:BX.message("VOX_IVR_EDIT_MENU_DESCRIPTION_FILE")})]})]}),s.textInputContainer=BX.create("div",{props:{className:"ivr-block"},style:e.TYPE=="file"?{display:"none"}:{},children:[BX.create("h4",{props:{className:"ivr-block-title"},text:BX.message("VOX_IVR_EDIT_MENU_TEXT_TO_PRONOUNCE")}),BX.create("div",{props:{className:"ivr-block-row"},children:[BX.create("div",{props:{className:"ivr-block-description"},text:BX.message("VOX_IVR_EDIT_MENU_DESCRIPTION_TEXT")}),s.textInput=BX.create("textarea",{props:{className:"ivr-input-textarea",value:e.MESSAGE},events:{bxchange:BX.debounce((function(t){e.MESSAGE=t.target.value;this._adjustTextAreaSize(t.target)}),100,this)}}),BX.create("div",{children:[BX.create("span",{props:{className:"ivr-input-text-additional"},text:BX.message("VOX_IVR_EDIT_MENU_CHANGE_TTS_SETTINGS"),events:{click:function(){BX.toggleClass(s.additionalTtsBlock,"ivr-input-text-additional-block-folded")}}})]})]}),s.additionalTtsBlock=BX.create("div",{props:{className:"ivr-input-text-additional-block ivr-input-text-additional-block-folded"},children:[BX.create("h4",{props:{className:"ivr-block-title"},text:BX.message("VOX_IVR_EDIT_MENU_CHANGE_TTS_VOICE")}),BX.create("select",{props:{className:"ivr-input-select"},children:this._createOptions(t.VOICE_LIST,e.TTS_VOICE),events:{bxchange:function(t){e.TTS_VOICE=t.target.value}}}),BX.create("h4",{props:{className:"ivr-block-title"},text:BX.message("VOX_IVR_EDIT_MENU_CHANGE_TTS_SPEED")}),BX.create("select",{props:{className:"ivr-input-select"},children:this._createOptions(t.SPEED_LIST,e.TTS_SPEED),events:{bxchange:function(t){e.TTS_SPEED=t.target.value}}}),BX.create("h4",{props:{className:"ivr-block-title"},text:BX.message("VOX_IVR_EDIT_MENU_CHANGE_TTS_VOLUME")}),BX.create("select",{props:{className:"ivr-input-select"},children:this._createOptions(t.VOLUME_LIST,e.TTS_VOLUME),events:{bxchange:function(t){e.TTS_VOLUME=t.target.value}}})]})]}),BX.create("div",{props:{className:"ivr-block"},children:[BX.create("h4",{props:{className:"ivr-block-title"},text:BX.message("VOX_IVR_EDIT_MENU_TIMEOUT_ACTION")}),BX.create("div",{props:{id:"ivrHint",className:"ivr-block-row"},children:[BX.create("select",{props:{className:"ivr-input-select"},children:[BX.create("option",{attrs:{value:"exit",selected:e.TIMEOUT_ACTION=="exit"},text:BX.message("VOX_IVR_EDIT_MENU_ACTION_EXIT")}),BX.create("option",{attrs:{value:"repeat",selected:e.TIMEOUT_ACTION=="repeat"},text:BX.message("VOX_IVR_EDIT_MENU_ACTION_REPEAT")})],events:{change:function(t){e.TIMEOUT_ACTION=t.target.value;if(e.TIMEOUT_ACTION=="exit")s.ivrExitHint.style.maxHeight="20px";else s.ivrExitHint.style.maxHeight="0"}}}),BX.create("span",{style:{padding:"0 5px"},text:BX.message("VOX_IVR_EDIT_MENU_TIMEOUT")+":"}),BX.create("input",{attrs:{type:"number"},props:{className:"ivr-input-number",value:e.TIMEOUT},style:{width:"3em"},events:{change:function(t){e.TIMEOUT=t.target.value}}})]}),s.ivrExitHint=BX.create("div",{props:{className:"ivr-block-description ivr-block-description-animated"},text:BX.message("VOX_IVR_EXIT_HINT"),style:{maxHeight:e.TIMEOUT_ACTION=="exit"?"20px":"0"}})]}),BX.create("div",{props:{className:"ivr-block"},children:[BX.create("h4",{props:{className:"ivr-block-title"},text:BX.message("VOX_IVR_EDIT_MENU_ACTIONS")}),BX.create("div",{props:{className:"ivr-actions-container"},children:[e._actionsContainer=BX.create("div",{props:{className:"ivr-logic-tree"},children:this.renderActions(e.ACTIONS,e)})]}),BX.create("div",{props:{className:"ivr-logic-tree-section ivr-logic-tree-section-new"},children:[BX.create("div",{props:{className:"ivr-logic-tree-section-new-btn"},events:{click:function(){i.selectDigit({node:this,occupiedDigits:BX.IvrEditor._getOccupiedDigits(e),onSelect:function(t){var s=i.createAction({DIGIT:t.digit});var n=i.renderAction(s,e);s._node=n;e.ACTIONS.push(s);e._actionsContainer.appendChild(n)}})}}})]})]})]});e._uploader=n.create({node:s.fileUploader,fileId:e.FILE_ID,fileUrl:e.FILE_SRC,onSelect:function(t){e.FILE_ID=t.FILE_ID},onDelete:function(t){e.FILE_ID=""}});setTimeout((function(){s.textInput.style.height=s.textInput.scrollHeight+"px"}),50);e._node=o;return o};BX.IvrEditor.prototype.renderActions=function(e,t){if(!BX.type.isArray(e))return[];var i=this;var s=[];e.map((function(e){var n=i.renderAction(e,t);s.push(n);e._node=n}));s.push();return s};BX.IvrEditor.prototype.renderAction=function(e,i){var s=this;var n;var r;var a;var c;var l;var p;var d;var u;var E;var h;if(e.ACTION==""){r=null}else if(e.ACTION=="item"){r=BX.create("div",{props:{className:"ivr-logic-tree-section-content"},children:[BX.create("div",{props:{className:"ivr-block"},children:[BX.create("div",{props:{className:"ivr-block-row"},children:[BX.create("div",{props:{className:"ivr-logic-tree-section-title"},children:[BX.create("span",{props:{className:"ivr-logic-tree-section-title-text"},text:BX.IvrEditor.message("VOX_IVR_EDIT_ENCLOSED_MENU",{"#DIGIT#":e.DIGIT})}),BX.create("span",{props:{className:"ivr-logic-tree-section-collapse-btn"},text:BX.message("VOX_IVR_EDIT_FOLD"),events:{click:function(e){clearTimeout(h);if(l.dataset.collapsed==1){l.style.height=0;h=setTimeout((function(){l.style.height=p.clientHeight.toString()+"px";l.dataset.collapsed=0;e.target.innerText=BX.message("VOX_IVR_EDIT_FOLD")}),100)}else{l.style.height=p.clientHeight.toString()+"px";h=setTimeout((function(){l.style.height=0;l.dataset.collapsed=1;e.target.innerText=BX.message("VOX_IVR_EDIT_UNFOLD")}),100)}}}})]})]})]}),l=BX.create("div",{props:{className:"ivr-logic-tree-subsection-content"},dataset:{collapsed:0},children:[p=BX.create("div",{props:{className:"ivr-logic-tree-subsection-measuring-wrapper"},children:[d=this.renderItem(e.ITEM)]})],events:{transitionend:function(){if(l.dataset.collapsed==0){l.style.removeProperty("height")}}}})]})}else{r=BX.create("div",{props:{className:"ivr-logic-tree-section-content"},children:[BX.create("div",{props:{className:"ivr-block"},children:[BX.create("div",{props:{className:"ivr-block-row"},children:[BX.create("select",{props:{className:"ivr-input-select"},children:[BX.create("option",{props:{value:"user",selected:e.ACTION=="user"},text:BX.message("VOX_IVR_EDIT_MENU_ACTION_USER")}),BX.create("option",{props:{value:"queue",selected:e.ACTION=="queue"},text:BX.message("VOX_IVR_EDIT_MENU_ACTION_QUEUE")}),BX.create("option",{props:{value:"phone",selected:e.ACTION=="phone"},text:BX.message("VOX_IVR_EDIT_MENU_ACTION_PHONE")}),BX.create("option",{props:{value:"directCode",selected:e.ACTION=="directCode"},text:BX.message("VOX_IVR_EDIT_MENU_ACTION_DIRECTCODE")}),BX.create("option",{props:{value:"voicemail",selected:e.ACTION=="voicemail"},text:BX.message("VOX_IVR_EDIT_MENU_ACTION_VOICEMAIL")}),BX.create("option",{props:{value:"repeat",selected:e.ACTION=="repeat"},text:BX.message("VOX_IVR_EDIT_MENU_ACTION_REPEAT")}),i.LEVEL>0?BX.create("option",{props:{value:"return",selected:e.ACTION=="return"},text:BX.message("VOX_IVR_EDIT_MENU_ACTION_RETURN")}):null,BX.create("option",{props:{value:"exit",selected:e.ACTION=="exit"},text:BX.message("VOX_IVR_EDIT_MENU_ACTION_EXIT")})],events:{change:function(t){s._onActionChangeType(e,i,t.target.value)}}})]}),BX.create("div",{props:{className:"ivr-block-description"},text:BX.message("VOX_IVR_EXIT_HINT"),style:{display:e.ACTION==="exit"?"block":"none"}})]}),BX.create("div",{style:{display:e.ACTION==="repeat"?"block":"none"},dataset:{role:"action-parameters",actionType:"repeat"}}),BX.create("div",{props:{className:"ivr-block"},style:{display:e.ACTION==="queue"?"block":"none"},dataset:{role:"action-parameters",actionType:"queue"},children:[BX.create("div",{props:{className:"ivr-block-row"},children:[E=BX.create("select",{props:{className:"ivr-input-select"},events:{bxchange:function(i){if(i.target.value=="new"){var n=i.target.options.length-2;if(t.MAX_GROUPS>-1&&n>=t.MAX_GROUPS){i.target.value=i.target.options.item(2).value;if(t.MAX_GROUPS==0){BX.UI.InfoHelper.show("limit_contact_center_telephony_groups_zero")}else{BX.UI.InfoHelper.show("limit_contact_center_telephony_groups")}}else{s.showGroupSettings(e,0)}}else{e.PARAMETERS.QUEUE_ID=i.target.value}}},children:BX.IvrEditor._groupsToOptions(t.TELEPHONY_GROUPS,e.PARAMETERS.QUEUE_ID)}),BX.create("span",{props:{className:"ivr-group-show-config"},text:BX.message("VOX_IVR_GROUP_SETTINGS"),dataset:{settingsOpen:"N"},events:{click:function(t){s.showGroupSettings(e,E.value)}}})]})]}),BX.create("div",{props:{className:"ivr-block"},style:{display:e.ACTION==="user"?"block":"none"},dataset:{role:"action-parameters",actionType:"user"},children:[BX.create("div",{props:{className:"ivr-block-row"},children:[a=BX.create("div")]})]}),BX.create("div",{props:{className:"ivr-block"},style:{display:e.ACTION==="phone"?"block":"none"},dataset:{role:"action-parameters",actionType:"phone"},children:[BX.create("div",{props:{className:"ivr-block-row"},children:[BX.create("input",{props:{className:"ivr-input-select",value:e.PARAMETERS.PHONE_NUMBER},events:{bxchange:function(t){e.PARAMETERS.PHONE_NUMBER=t.target.value}}})]})]}),BX.create("div",{style:{display:e.ACTION==="directCode"?"block":"none"},dataset:{role:"action-parameters",actionType:"directCode"}}),BX.create("div",{props:{className:"ivr-block"},style:{display:e.ACTION==="voicemail"?"block":"none"},dataset:{role:"action-parameters",actionType:"voicemail"},children:[BX.create("h4",{props:{className:"ivr-block-title"},text:BX.message("VOX_IVR_EDIT_VOICEMAIL_RECEIVER")}),BX.create("div",{props:{className:"ivr-block-row"},children:[c=BX.create("div")]})]})]})}if(e.ACTION=="user"){o.create({node:a,userId:e.PARAMETERS.USER_ID,onSelect:function(t){e.PARAMETERS.USER_ID=t.userId},onDelete:function(){e.PARAMETERS.USER_ID=""}})}else if(e.ACTION=="voicemail"){o.create({node:c,userId:e.PARAMETERS.USER_ID,onSelect:function(t){e.PARAMETERS.USER_ID=t.userId},onDelete:function(){e.PARAMETERS.USER_ID=""}})}u=BX.create("div",{props:{className:e.ACTION==""?"ivr-logic-tree-section ivr-logic-tree-section-empty":"ivr-logic-tree-section"},children:[BX.create("div",{props:{className:"ivr-logic-tree-section-number-container"},children:[BX.create("div",{props:{className:"ivr-logic-tree-section-number"},children:[n=BX.create("span",{props:{className:"ivr-logic-tree-section-number-value"},text:e.DIGIT}),BX.create("span",{props:{className:"ivr-logic-tree-section-number-value-change-btn"},events:{click:function(){s.selectDigit({node:this,occupiedDigits:BX.IvrEditor._getOccupiedDigits(i),onSelect:function(t){n.innerText=t.digit;e.DIGIT=t.digit}})}}}),BX.create("div",{props:{className:"ivr-logic-tree-section-remove-btn"},events:{click:function(t){s._onActionRemoveClick(e,i)}}})]}),BX.create("div",{props:{className:"ivr-logic-tree-section-number-action"},events:{click:function(t){s._onActionSelectTypeClick(e,i,t.target)}}})]}),BX.create("div",{props:{className:"ivr-logic-tree-section-line"}}),r]});return u};BX.IvrEditor.prototype.selectDigit=function(e){var t=this;if(this.keypadPopup)this.keypadPopup.close();this.keypadPopup=s.create({node:e.node,occupiedDigits:e.occupiedDigits,onSelect:function(i){e.onSelect(i);t.keypadPopup.close()},onClose:function(){t.keypadPopup.dispose();t.keypadPopup=null}});this.keypadPopup.show()};BX.IvrEditor.prototype._onActionChangeType=function(e,i,s){var n=this;e.ACTION=s;e.LEAD_FIELDS=null;e.PARAMETERS={};e.ITEM_ID="";switch(s){case"phone":e.PARAMETERS.PHONE_NUMBER="";break;case"queue":e.PARAMETERS.QUEUE_ID=t.TELEPHONY_GROUPS[0].ID;break;case"user":e.PARAMETERS.USER_ID="";break}var o=this.renderAction(e,i);e._node.parentNode.replaceChild(o,e._node);e._node=o};BX.IvrEditor.prototype._onActionSelectTypeClick=function(e,i,s){var n=this;if(e.ACTION==""){this.selectActionType({node:s,item:i,onSelect:function(s){var o;if(s.type==="item"){var r=parseInt(i.LEVEL)+1;if(t.MAX_DEPTH==0||r<t.MAX_DEPTH){e.ITEM=n.createItem({LEVEL:r,ACTIONS:[n.createAction({DIGIT:"0",ACTION:"exit"})]});e.ACTION=s.type;o=n.renderAction(e,i);e._node.parentNode.replaceChild(o,e._node);e._node=o}else{n.showLimitReachedPopup()}}else{switch(s.type){case"phone":e.PARAMETERS.PHONE_NUMBER="";break;case"queue":e.PARAMETERS.QUEUE_ID=t.TELEPHONY_GROUPS[0].ID;break;case"user":e.PARAMETERS.USER_ID="";break}e.ACTION=s.type;o=n.renderAction(e,i);e._node.parentNode.replaceChild(o,e._node);e._node=o}}})}else{e.ACTION="";e.ITEM_ID="";e.ITEM=null;e.LEAD_FIELDS=null;e.PARAMETERS={};var o=n.renderAction(e,i);e._node.parentNode.replaceChild(o,e._node);e._node=o}};BX.IvrEditor.prototype._onActionRemoveClick=function(e,t){var i=this;var s=null;t.ACTIONS.forEach((function(t,i){if(t==e){s=i}}));if(s===null)return;t.ACTIONS.splice(s,1);BX.cleanNode(e._node,true)};BX.IvrEditor.prototype._onCancelButtonClick=function(){if(BX.SidePanel.Instance.isOpen()){BX.SidePanel.Instance.close()}else{document.location.href=t.IVR_LIST_URL}};BX.IvrEditor.prototype._onSaveButtonClick=function(){if(this.saving)return;this.saving=true;var i=this;var s=BX.create("span",{props:{className:"wait"}});BX.addClass(this.elements.saveButton,"webform-small-button-wait webform-small-button-active");this.elements.saveButton.appendChild(s);var n={action:"save",sessid:BX.bitrix_sessid(),IVR:JSON.stringify(this.ivrData)};BX.ajax({url:e,method:"POST",data:n,onsuccess:function(e){BX.removeClass(i.elements.saveButton,"webform-small-button-wait webform-small-button-active");BX.remove(s);try{e=JSON.parse(e)}catch(e){BX.debug("Error decoding server response");return false}if(e.SUCCESS===true){if(BX.SidePanel.Instance.isOpen()){BX.SidePanel.Instance.postMessage(window,"IvrEditor::onSave",{ivrId:e.DATA.IVR.ID,ivr:e.DATA.IVR});BX.SidePanel.Instance.close()}else{document.location.href=t.IVR_LIST_URL}}else{alert(e.ERROR);i.saving=false}}})};BX.IvrEditor.prototype.selectActionType=function(e){var t=this;var i=e.item;if(!BX.type.isPlainObject(e))e={};if(!BX.type.isFunction(e.onSelect))e.onSelect=BX.DoNothing;var s=function(i){return function(){var s={type:i};t.actionTypeMenu.popupWindow.close();e.onSelect(s)}};var n=[{id:"ivr-action-menu-user",text:BX.message("VOX_IVR_EDIT_MENU_ACTION_USER"),onclick:s("user")},{id:"ivr-action-menu-queue",text:BX.message("VOX_IVR_EDIT_MENU_ACTION_QUEUE"),onclick:s("queue")},{id:"ivr-action-menu-phone",text:BX.message("VOX_IVR_EDIT_MENU_ACTION_PHONE"),onclick:s("phone")},{id:"ivr-action-menu-directCode",text:BX.message("VOX_IVR_EDIT_MENU_ACTION_DIRECTCODE"),onclick:s("directCode")},{id:"ivr-action-menu-voicemail",text:BX.message("VOX_IVR_EDIT_MENU_ACTION_VOICEMAIL"),onclick:s("voicemail")},{id:"ivr-action-menu-repeat",text:BX.message("VOX_IVR_EDIT_MENU_ACTION_REPEAT"),onclick:s("repeat")}];if(i.LEVEL>0){n.push({id:"ivr-action-menu-return",text:BX.message("VOX_IVR_EDIT_MENU_ACTION_RETURN"),onclick:s("return")})}n.push({id:"ivr-action-menu-exit",text:BX.message("VOX_IVR_EDIT_MENU_ACTION_EXIT"),onclick:s("exit")});n.push({delimiter:true});n.push({id:"ivr-action-menu-item",text:BX.message("VOX_IVR_EDIT_MENU_ACTION_NEW_ITEM"),onclick:s("item")});this.actionTypeMenu=BX.PopupMenu.create("ivr-action-type-menu",e.node,n,{closeByEsc:true,autoHide:true,offsetTop:0,offsetLeft:12,angle:{position:"top"},events:{onPopupClose:function(){t.actionTypeMenu.popupWindow.destroy();BX.PopupMenu.destroy("ivr-action-type-menu")},onPopupDestroy:function(){t.actionTypeMenu=null}}});this.actionTypeMenu.popupWindow.show()};BX.IvrEditor.prototype.createAction=function(e){if(!BX.type.isPlainObject(e))e={};return{ID:null,ACTION:e.ACTION||"",DIGIT:e.DIGIT,ITEM_ID:"",LEAD_FIELDS:null,PARAMETERS:{}}};BX.IvrEditor.prototype.createItem=function(e){return{ID:null,TYPE:"message",MESSAGE:"",TTS_VOICE:t.DEFAULT_VOICE,TTS_SPEED:t.DEFAULT_SPEED,TTS_VOLUME:t.DEFAULT_VOLUME,TIMEOUT:15,TIMEOUT_ACTION:"exit",ACTIONS:BX.type.isArray(e.ACTIONS)?e.ACTIONS:[],LEVEL:e.LEVEL}};BX.IvrEditor.prototype._createOptions=function(e,t){var i=[];if(!BX.type.isPlainObject(e))return i;for(var s in e){if(e.hasOwnProperty(s)&&BX.type.isNotEmptyString(e[s])){i.push(BX.create("option",{props:{value:s,selected:s==t},text:BX.util.htmlspecialchars(e[s])}))}}return i};BX.IvrEditor.prototype._adjustTextAreaSize=function(e){if(!BX.type.isDomNode)return false;if(e.scrollHeight>e.clientHeight)e.style.height=e.scrollHeight+"px"};BX.IvrEditor.prototype.showUnavailablePopup=function(){BX.UI.InfoHelper.show("limit_contact_center_telephony_ivr")};BX.IvrEditor.prototype.showLimitReachedPopup=function(){BX.UI.InfoHelper.show("limit_contact_center_telephony_ivr")};BX.IvrEditor.prototype.showGroupSettings=function(e,t){this.currentGroupAction=e;BX.SidePanel.Instance.open("/telephony/editgroup.php?ID="+t,{cacheable:false})};BX.IvrEditor.prototype._onSliderClosed=function(e){this.render();this.currentGroupAction=null};BX.IvrEditor.prototype._onSliderMessageReceived=function(e){var t=e.getEventId();if(t==="QueueEditor::onSave"){var i=e.getData()["DATA"]["GROUP"];if(!i["ID"]){return}this.afterGroupSaved(i);this.render()}};BX.IvrEditor.prototype.afterGroupSaved=function(e){var i=false;for(var s=0;s<t.TELEPHONY_GROUPS.length;s++){if(t.TELEPHONY_GROUPS[s].ID==e.ID){t.TELEPHONY_GROUPS[s].NAME=e.NAME;i=true;break}}if(!i){t.TELEPHONY_GROUPS.push({ID:e.ID,NAME:e.NAME})}if(this.currentGroupAction){this.currentGroupAction.PARAMETERS["QUEUE_ID"]=e.ID}};BX.IvrEditor._groupsToOptions=function(e,t){var i=[BX.create("option",{props:{value:"new"},text:BX.message("VOX_IVR_HIDE_GROUP_CREATE")}),BX.create("option",{props:{disabled:true},html:"&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;"})];if(!BX.type.isArray(e))return i;e.forEach((function(e){i.push(BX.create("option",{props:{value:e.ID,selected:e.ID==t},text:e.NAME}))}));return i};BX.IvrEditor._getOccupiedDigits=function(e){var t=[];e.ACTIONS.forEach((function(e){t.push(e.DIGIT)}));return t};BX.IvrEditor.message=function(e,t){var i=BX.message(e);if(BX.type.isPlainObject(t)){for(var s in t){if(t.hasOwnProperty(s))i=i.replace(s,t[s])}}return i};var s=function(e){this.node=e.node;this.occupiedDigits=BX.type.isArray(e.occupiedDigits)?e.occupiedDigits:[];this.callbacks={onSelect:BX.type.isFunction(e.onSelect)?e.onSelect:BX.DoNothing,onClose:BX.type.isFunction(e.onClose)?e.onClose:BX.DoNothing};this.popup=null};s.create=function(e){return new s(e)};s.prototype.show=function(){var e=this;if(this.popup)this.popup.show();this.popup=new BX.PopupWindow(this.createId(),this.node,{content:this.createLayout(),closeByEsc:true,autoHide:true,overlay:{backgroundColor:"black",opacity:30},events:{onPopupClose:function(){e.callbacks.onClose()}}});this.popup.show()};s.prototype.close=function(){if(this.popup)this.popup.close()};s.prototype.createLayout=function(){var e=this;var t=function(t){var i=e.occupiedDigits.indexOf(t)===-1?"ivr-keypad-btn":"ivr-keypad-btn ivr-keypad-btn-occupied";var s=t==="*"?"ivr-keypad-btn-value ivr-keypad-btn-value-star":"ivr-keypad-btn-value";return BX.create("span",{props:{className:i},dataset:{digit:t},events:{click:e.onDigitClick.bind(e,t)},children:[BX.create("span",{props:{className:s},text:t})]})};return BX.create("div",{props:{className:"ivr-keypad-container"},children:[t("1"),t("2"),t("3"),t("4"),t("5"),t("6"),t("7"),t("8"),t("9"),t("*"),t("0"),t("#")]})};s.prototype.createId=function(){return"vox-ivr-keypad-"+(new Date).getTime().toString()};s.prototype.onDigitClick=function(e){if(this.occupiedDigits.indexOf(e)!=-1)return;this.callbacks.onSelect({digit:e})};s.prototype.dispose=function(){if(this.popup)this.popup.destroy();this.popup=null};var n=function(e){this.node=e.node;this.fileId=e.fileId||0;this.fileUrl=e.fileUrl||"";this.maxFileSize=2097152;this.callbacks={onSelect:BX.type.isFunction(e.onSelect)?e.onSelect:BX.DoNothing,onDelete:BX.type.isFunction(e.onDelete)?e.onDelete:BX.DoNothing};this.elements={fileInput:null};this.playerId="";this.init()};n.create=function(e){return new n(e)};n.prototype.init=function(){this.render()};n.prototype.render=function(){var e=this;var t;BX.cleanNode(this.node);if(this.fileId==0&&this.fileUrl==""){t=BX.create("div",{props:{id:"ivrHint",className:"ivr-dot-btn-box"},children:[BX.create("div",{children:[BX.create("span",{props:{className:"ivr-dot-btn"},text:BX.message("VOX_IVR_EDIT_MENU_LOAD_FILE"),events:{click:this._onUploadButtonClick.bind(this)}}),this.elements.fileInput=BX.create("input",{attrs:{type:"file",accept:"audio/*"},style:{display:"none"},events:{change:this._onFileSelected.bind(this)}})]}),BX.create("div",{children:[BX.UI.Hint.createNode(BX.message("VOX_IVR_EDIT_MENU_DESCRIPTION_FILE"))]})]})}else{this.playerId="file_player_"+BX.util.getRandomString(10);t=BX.create("div",{props:{className:"ivr-uploader-subcontainer"},children:[BX.create("div",{props:{className:"ivr-uploader-wrap"},children:[this.elements.playerContainer=BX.create("div",{props:{className:"ivr-uploader-wrap"},attrs:{id:this.playerId}})]}),BX.create("div",{props:{className:"ivr-uploader-delete-icon"},children:[BX.create("i",{props:{className:"fa fa-times"},attrs:{"aria-hidden":"true"},events:{click:this._onDeleteButtonClick.bind(this)}})]})]});setTimeout((function(){jwplayer(e.playerId).setup({height:24,width:200,file:e.fileUrl,controlbar:"bottom",primary:"html5",fallback:false,modes:[{type:"html5"}],flashplayer:"/bitrix/components/bitrix/player/mediaplayer/player"})}),10)}this.node.appendChild(t)};n.prototype.resize=function(){var e=jwplayer(this.playerId);if(e)e.resize(200,24)};n.prototype._onUploadButtonClick=function(){if(this.elements.fileInput)this.elements.fileInput.click()};n.prototype._onFileSelected=function(e){var t=this;var i=e.target.files[0];if(!(i instanceof File))return;this.upload(i,(function(e){t.fileId=e.FILE_ID;t.fileUrl=e.FILE_SRC;t.render();t.callbacks.onSelect(e)}))};n.prototype._onDeleteButtonClick=function(){this.fileId=0;this.fileUrl="";this.render();this.callbacks.onDelete()};n.prototype.upload=function(t,i){var s=new FormData;s.append("sessid",BX.bitrix_sessid());s.append("action","upload_file");s.append("FILE",t);BX.ajax({url:e,method:"POST",data:s,preparePost:false,onsuccess:function(e){var t;try{t=JSON.parse(e)}catch(e){BX.debug("Error parsing server response");return}if(!t.SUCCESS){alert(t.ERROR)}else{i(t.DATA)}}})};var o=function(e){this.id="ivr-user-selector-"+i(16);this.node=e.node;this.callbacks={onSelect:BX.type.isFunction(e.onSelect)?e.onSelect:BX.DoNothing,onDelete:BX.type.isFunction(e.onDelete)?e.onDelete:BX.DoNothing};this.elements={container:null,item:null,inputBox:null,input:null,addButton:null};this.userId=e.userId||0;this.userName=this.getUserName(this.userId);this.init()};o.create=function(e){return new o(e)};o.prototype.init=function(){var e=this;this.render();BX.SocNetLogDestination.init({name:this.id,searchInput:this.elements.input,departmentSelectDisable:true,extranetUser:false,allowAddSocNetGroup:false,bindMainPopup:{node:this.elements.container,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:this.elements.container,offsetTop:"5px",offsetLeft:"15px"},callback:{select:this.onSelect.bind(this),unSelect:BX.DoNothing,openDialog:this.onOpenDialog.bind(this),closeDialog:this.onCloseDialog.bind(this),openSearch:BX.DoNothing,closeSearch:this.onCloseSearch.bind(this)},items:{users:{},groups:{},sonetgroups:{},department:t.STRUCTURE.department,departmentRelation:t.STRUCTURE.department_relation},itemsLast:{users:{},sonetgroups:{},department:{},groups:{}},itemsSelected:{},destSort:{}})};o.prototype.render=function(){var e=this;BX.cleanNode(this.node);var t=BX.create("div",{props:{className:"tel-set-destination-container"},children:[this.elements.container=BX.create("span",{props:{className:"bx-destination-wrap"},children:[this.elements.item=BX.create("span",{children:this.renderUsers()}),this.elements.inputBox=BX.create("span",{props:{className:"bx-destination-input-box"},children:[this.elements.input=BX.create("input",{props:{className:"bx-destination-input"},events:{keyup:this.onInputKeyUp.bind(this),keydown:this.onInputKeyDown.bind(this)}})]}),this.elements.addButton=BX.create("a",{props:{className:"bx-destination-add"},text:this.userId==0?BX.message("VOX_IVR_EDIT_SELECT"):BX.message("VOX_IVR_EDIT_CHANGE"),events:{click:function(t){BX.SocNetLogDestination.deleteLastItem(e.id);BX.SocNetLogDestination.openDialog(e.id);BX.PreventDefault(t)}}})]})]});this.node.appendChild(t)};o.prototype.renderUsers=function(){var e=[];if(this.userId>0&&this.userName!=""){e.push(BX.create("span",{props:{className:"bx-destination bx-destination-users"},dataset:{userId:this.userId},children:[BX.create("span",{props:{className:"bx-destination-text"},text:BX.util.htmlspecialchars(this.userName)}),BX.create("span",{props:{className:"bx-destination-del-but"}})]}))}return e};o.prototype.onInputKeyDown=function(e){if(e.keyCode==8&&this.elements.input.value.length<=0){BX.SocNetLogDestination.sendEvent=false;BX.SocNetLogDestination.deleteLastItem(this.id)}return true};o.prototype.onInputKeyUp=function(e){if(e.keyCode==16||e.keyCode==17||e.keyCode==18||e.keyCode==20||e.keyCode==244||e.keyCode==224||e.keyCode==91)return false;if(e.keyCode==13){BX.SocNetLogDestination.selectFirstSearchItem(this.id);return true}if(e.keyCode==27){this.elements.input.value="";BX.style(this.elements.addButton,"display","inline")}else{BX.SocNetLogDestination.search(this.elements.input.value,true,this.id)}if(!BX.SocNetLogDestination.isOpenDialog()&&this.elements.input.value.length<=0){BX.SocNetLogDestination.openDialog(this.id)}else if(BX.SocNetLogDestination.sendEvent&&BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.closeDialog()}if(e.keyCode==8){BX.SocNetLogDestination.sendEvent=true}return true};o.prototype.onOpenDialog=function(){BX.style(this.elements.inputBox,"display","inline-block");BX.style(this.elements.addButton,"display","none");BX.focus(this.elements.input)};o.prototype.onCloseDialog=function(){if(this.elements.input.value.length<=0){BX.style(this.elements.inputBox,"display","none");BX.style(this.elements.addButton,"display","inline-block");this.elements.input.value=""}};o.prototype.onCloseSearch=function(){BX.style(this.elements.inputBox,"display","none");BX.style(this.elements.addButton,"display","inline-block");this.elements.input.value=""};o.prototype.onSelect=function(e){this.userId=e.entityId;this.userName=e.name;if(BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.closeDialog()}BX.cleanNode(this.elements.item);BX.adjust(this.elements.item,{children:this.renderUsers()});this.elements.addButton.innerText=BX.message("VOX_IVR_EDIT_CHANGE");this.callbacks.onSelect({userId:this.userId,userName:this.userName})};o.prototype.onDelete=function(){this.userId=0;this.userName="";this.cleanNode(this.elements.item);this.elements.addButton.innerText=BX.message("VOX_IVR_EDIT_SELECT");this.callbacks.onDelete()};o.prototype.getUserName=function(e){e=parseInt(e);if(e==0)return"";if(t.USERS["U"+e])return t.USERS["U"+e]["name"];else return""}})();
//# sourceMappingURL=script.map.js