(function(){if(window.BX.ViGroupEdit)return;var e="/bitrix/components/bitrix/voximplant.queue.edit/ajax.php";var t={wait:"wait",talk:"talk",hungup:"hungup",pstn:"pstn",pstn_specific:"pstn_specific",user:"user",voicemail:"voicemail",queue:"queue",next_queue:"next_queue"};var i=function(e,t){var n={},s,o,a;if(t[e]){for(a in t[e]){if(t[e].hasOwnProperty(a)){s=t[e][a];o=[];if(t[s]&&t[s].length>0)o=i(s,t);n[s]={id:s,type:"category",items:o}}}}return n};var n=function(e){var t={},n;for(var s in e){if(e.hasOwnProperty(s)){n=e[s]["parent"];if(!t[n])t[n]=[];t[n][t[n].length]=s}}return i("DR0",t)};var s=function(e,t){this.p=!!e?e:{};if(!!e["SELECTED"]){var i={},s,o;for(s in e["SELECTED"]){if(e["SELECTED"].hasOwnProperty(s)&&typeof e["SELECTED"][s]=="object"){for(o in e["SELECTED"][s]){if(e["SELECTED"][s].hasOwnProperty(o)){if(s=="USERS")i["U"+e["SELECTED"][s][o]]="users";else if(s=="SG")i["SG"+e["SELECTED"][s][o]]="sonetgroups";else if(s=="DR")i["DR"+e["SELECTED"][s][o]]="department"}}}}this.p["SELECTED"]=i}this.maximumGroupMembers=e.maximumGroupMembers;this.nodes={};if(true||t=="users"){this.params={name:null,searchInput:null,extranetUser:this.p["EXTRANET_USER"]=="Y",bindMainPopup:{node:null,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:null,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:true,callback:{select:BX.delegate(this.select,this),unSelect:BX.delegate(this.unSelect,this),openDialog:BX.delegate(this.openDialog,this),closeDialog:BX.delegate(this.closeDialog,this),openSearch:BX.delegate(this.openDialog,this),closeSearch:BX.delegate(this.closeSearch,this)},items:{users:!!this.p["USERS"]?this.p["USERS"]:{},groups:{},sonetgroups:{},department:!!this.p["DEPARTMENT"]?this.p["DEPARTMENT"]:{},departmentRelation:!!this.p["DEPARTMENT"]?n(this.p["DEPARTMENT"]):{},contacts:{},companies:{},leads:{},deals:{}},itemsLast:{users:!!this.p["LAST"]&&!!this.p["LAST"]["USERS"]?this.p["LAST"]["USERS"]:{},sonetgroups:{},department:{},groups:{},contacts:{},companies:{},leads:{},deals:{},crm:[]},itemsSelected:!!this.p["SELECTED"]?BX.clone(this.p["SELECTED"]):{},isCrmFeed:false,destSort:!!this.p["DEST_SORT"]?BX.clone(this.p["DEST_SORT"]):{}}}};s.prototype={setInput:function(e,t){if(BX.type.isDomNode(e)&&!e.hasAttribute("bx-destination-id")){var i="destination"+(""+(new Date).getTime()).substr(6);e.setAttribute("bx-destination-id",i);var n=new o({id:i,node:e,inputName:t,destination:this});this.nodes[i]=e;BX.defer_proxy(function(){this.params.name=n.id;this.params.searchInput=n.nodes.input;this.params.bindMainPopup.node=n.nodes.container;this.params.bindSearchPopup.node=n.nodes.container;BX.SocNetLogDestination.init(this.params)},this)()}},select:function(e,t,i,n,s){if(this.maximumGroupMembers>0&&this.getSelectedCount()>this.maximumGroupMembers){BX.Voximplant.showLicensePopup("groups");this.deleteLastItem();BX.SocNetLogDestination.closeDialog(this.params.name);return}var o=t,a="S";if(t=="groups"){o="all-users"}else if(BX.util.in_array(t,["contacts","companies","leads","deals"])){o="crm"}if(t=="sonetgroups"){a="SG"}else if(t=="groups"){a="UA"}else if(t=="users"){a="U"}else if(t=="department"){a="DR"}else if(t=="contacts"){a="CRMCONTACT"}else if(t=="companies"){a="CRMCOMPANY"}else if(t=="leads"){a="CRMLEAD"}else if(t=="deals"){a="CRMDEAL"}var r=n?" bx-destination-undelete":"";r+=t=="sonetgroups"&&typeof window["arExtranetGroupID"]!="undefined"&&BX.util.in_array(e.entityId,window["arExtranetGroupID"])?" bx-destination-extranet":"";var p=BX.create("span",{attrs:{"data-id":e.id},props:{className:"bx-destination bx-destination-"+o+r},children:[BX.create("span",{props:{className:"bx-destination-text"},html:e.name})]});if(!n){p.appendChild(BX.create("span",{props:{className:"bx-destination-del-but"},events:{click:function(i){BX.SocNetLogDestination.deleteItem(e.id,t,s);BX.PreventDefault(i)},mouseover:function(){BX.addClass(this.parentNode,"bx-destination-hover")},mouseout:function(){BX.removeClass(this.parentNode,"bx-destination-hover")}}}))}BX.onCustomEvent(this.nodes[s],"select",[e,p,a])},unSelect:function(e,t,i,n){BX.onCustomEvent(this.nodes[n],"unSelect",[e])},openDialog:function(e){BX.onCustomEvent(this.nodes[e],"openDialog",[])},closeDialog:function(e){if(!BX.SocNetLogDestination.isOpenSearch()){BX.onCustomEvent(this.nodes[e],"closeDialog",[]);this.disableBackspace()}},closeSearch:function(e){if(!BX.SocNetLogDestination.isOpenSearch()){BX.onCustomEvent(this.nodes[e],"closeSearch",[]);this.disableBackspace()}},disableBackspace:function(){if(BX.SocNetLogDestination.backspaceDisable||BX.SocNetLogDestination.backspaceDisable!==null)BX.unbind(window,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.bind(window,"keydown",BX.SocNetLogDestination.backspaceDisable=function(e){if(e.keyCode==8){BX.PreventDefault(e);return false}return true});setTimeout(function(){BX.unbind(window,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.SocNetLogDestination.backspaceDisable=null},5e3)},getSelectedCount:function(){return BX.SocNetLogDestination.getSelectedCount(this.params.name)},deleteLastItem:function(){return BX.SocNetLogDestination.deleteLastItem(this.params.name)}};var o=function(e){this.node=e.node;this.nodes={inputBox:null,input:null,container:null,button:null};this.id=e.id;this.inputName=e.inputName;this.destination=e.destination;this.render();this.bind()};o.prototype={render:function(){BX.cleanNode(this.node);this.node.appendChild(BX.create("span",{props:{className:"bx-destination-wrap"},children:[this.nodes.container=BX.create("span",{events:{click:this.onAddButtonClick.bind(this)},children:[BX.create("span",{props:{className:"bx-destination-wrap-item"}})]}),this.nodes.inputBox=BX.create("span",{props:{className:"bx-destination-input-box"},children:[this.nodes.input=BX.create("input",{props:{className:"bx-destination-input"},events:{keyup:this.onInputKeyUp.bind(this),keydown:this.onInputKeyDown.bind(this)}})]}),this.nodes.button=BX.create("span")]}))},renderLock:function(){var e=[BX.create("span",{props:{className:"bx-destination-add"},text:this.destination.getSelectedCount()<=0?BX.message("LM_ADD1"):BX.message("LM_ADD2"),events:{click:this.onAddButtonClick.bind(this)}})];if(this.destination.maximumGroupMembers==0)return e;if(this.destination.getSelectedCount()<this.destination.maximumGroupMembers){e.push(BX.create("span",{props:{className:"tel-lock-holder-destination"},children:[BX.create("span",{props:{className:"tel-lock tel-lock-half"},events:{click:function(e){BX.Voximplant.showLicensePopup("groups")}}})]}))}else{e.push(BX.create("span",{props:{className:"tel-lock-holder-destination"},children:[BX.create("span",{props:{className:"tel-lock"},events:{click:function(e){BX.Voximplant.showLicensePopup("groups")}}})]}))}return e},bind:function(){this.onChangeDestination();BX.addCustomEvent(this.node,"select",this.onSelect.bind(this));BX.addCustomEvent(this.node,"unSelect",this.onUnSelect.bind(this));BX.addCustomEvent(this.node,"openDialog",this.onOpenDialog.bind(this));BX.addCustomEvent(this.node,"closeDialog",this.onCloseDialog.bind(this));BX.addCustomEvent(this.node,"closeSearch",this.onCloseSearch.bind(this))},onAddButtonClick:function(e){if(this.destination.maximumGroupMembers>0&&this.destination.getSelectedCount()>=this.destination.maximumGroupMembers){BX.Voximplant.showLicensePopup("groups")}else{BX.SocNetLogDestination.openDialog(this.id)}e.preventDefault();e.stopPropagation()},onSelect:function(e,t,i){if(!BX.findChild(this.nodes.container,{attr:{"data-id":e.id}},false,false)){t.appendChild(BX.create("INPUT",{props:{type:"hidden",name:this.inputName+"[]",value:e.entityId}}));this.nodes.container.appendChild(t)}this.onChangeDestination()},onUnSelect:function(e){var t=BX.findChildren(this.nodes.container,{attribute:{"data-id":""+e.id+""}},true);if(t!==null){for(var i=0;i<t.length;i++)BX.remove(t[i])}this.onChangeDestination()},onChangeDestination:function(){this.nodes.input.innerHTML="";BX.cleanNode(this.nodes.button);BX.adjust(this.nodes.button,{children:this.renderLock()})},onOpenDialog:function(){BX.style(this.nodes.inputBox,"display","inline-block");this.nodes.button.style.display="none";BX.focus(this.nodes.input)},onCloseDialog:function(){if(this.nodes.input.value.length<=0){BX.style(this.nodes.inputBox,"display","none");this.nodes.button.style.removeProperty("display");this.nodes.input.value=""}},onCloseSearch:function(){if(this.nodes.input.value.length>0){BX.style(this.nodes.inputBox,"display","none");this.nodes.button.style.removeProperty("display");this.nodes.input.value=""}},onInputKeyDown:function(e){if(e.keyCode==8&&this.nodes.input.value.length<=0){BX.SocNetLogDestination.sendEvent=false;BX.SocNetLogDestination.deleteLastItem(this.id)}return true},onInputKeyUp:function(e){if(e.keyCode==16||e.keyCode==17||e.keyCode==18||e.keyCode==20||e.keyCode==244||e.keyCode==224||e.keyCode==91)return false;if(e.keyCode==13){BX.SocNetLogDestination.selectFirstSearchItem(this.id);return true}if(e.keyCode==27){this.nodes.input.value="";BX.style(this.nodes.button,"display","inline")}else{BX.SocNetLogDestination.search(this.nodes.input.value,true,this.id)}if(!BX.SocNetLogDestination.isOpenDialog()&&this.nodes.input.value.length<=0){BX.SocNetLogDestination.openDialog(this.id)}else if(BX.SocNetLogDestination.sendEvent&&BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.closeDialog()}if(e.keyCode==8){BX.SocNetLogDestination.sendEvent=true}return true}};BX.ViGroupEdit=function(e){this.node=e.node;this.destinationParams=e.destinationParams;this.groupListUrl=e.groupListUrl;this.inlineMode=e.inlineMode;this.externalRequestId=e.externalRequestId;this.destinationParams.maximumGroupMembers=e.maximumGroupMembers;this.popupTooltip={};this.init()};BX.ViGroupEdit.prototype.init=function(){this.bindEvents();this.destination=new s(this.destinationParams);this.destination.setInput(BX("users_for_queue"),"USERS");BX.onCustomEvent(window,"onViGroupEditInit",[this])};BX.ViGroupEdit.prototype.bindEvents=function(){var e=this;var i=BX.findChildrenByClassName(BX("tel-set-main-wrap"),"tel-context-help");if(BX.type.isArray(i)){i.forEach(function(t,i){t.setAttribute("data-id",i);BX.bind(t,"mouseover",function(){var t=this.getAttribute("data-id");var i=this.getAttribute("data-text");e.showTooltip(t,this,i)});BX.bind(t,"mouseout",function(){var t=this.getAttribute("data-id");e.hideTooltip(t)})})}BX.bind(BX("vi_no_answer_rule"),"change",function(e){BX.PreventDefault(e);switch(e.target.value){case t.pstn_specific:BX("vi_forward_number").classList.remove("inactive");BX("vi_next_queue").classList.add("inactive");break;case t.next_queue:BX("vi_forward_number").classList.add("inactive");BX("vi_next_queue").classList.remove("inactive");break;default:BX("vi_forward_number").classList.add("inactive");BX("vi_next_queue").classList.add("inactive");break}});BX.bind(BX("vi_allow_intercept"),"bxchange",function(e){if(e.target.dataset.locked==1){BX.PreventDefault(e);e.target.checked=false;BX.Voximplant.showLicensePopup("main");return false}});var n=this.getNode("vi-group-edit-submit");if(n)BX.bind(n,"click",this._onSubmitClick.bind(this));var s=this.getNode("vi-group-edit-cancel");if(s)BX.bind(s,"click",this._onCancelClick.bind(this))};BX.ViGroupEdit.prototype.getNode=function(e,t){if(!t)t=this.node;return t?t.querySelector('[data-role="'+e+'"]'):null};BX.ViGroupEdit.prototype.showTooltip=function(e,t,i){if(this.popupTooltip[e])this.popupTooltip[e].close();this.popupTooltip[e]=new BX.PopupWindow("bx-voximplant-tooltip",t,{lightShadow:true,autoHide:false,darkMode:true,offsetLeft:0,offsetTop:2,bindOptions:{position:"top"},zIndex:200,events:{onPopupClose:function(){this.destroy()}},content:BX.create("div",{attrs:{style:"padding-right: 5px; width: 250px;"},html:i})});this.popupTooltip[e].setAngle({offset:13,position:"bottom"});this.popupTooltip[e].show();return true};BX.ViGroupEdit.prototype.hideTooltip=function(e){this.popupTooltip[e].close();this.popupTooltip[e]=null};BX.ViGroupEdit.prototype._onSubmitClick=function(e){this.save()};BX.ViGroupEdit.prototype.save=function(t){var i=this;var n=new FormData;var s=this.node.querySelectorAll("input, select");var o;for(var a=0;a<s.length;a++){o=s.item(a);if(o.tagName.toUpperCase()=="INPUT"){switch(o.type.toUpperCase()){case"TEXT":n.append(o.name,o.value);break;case"HIDDEN":n.append(o.name,o.value);break;case"CHECKBOX":if(o.checked)n.append(o.name,o.value);break}}else if(o.tagName.toUpperCase()=="SELECT"){n.append(o.name,o.value)}}var r=this.getNode("vi-group-edit-submit");var p=BX.create("span",{props:{className:"wait"}});BX.addClass(r,"webform-small-button-wait webform-small-button-active");r.appendChild(p);BX.ajax({url:e,method:"POST",data:n,preparePost:false,onsuccess:function(e){BX.removeClass(r,"webform-small-button-wait webform-small-button-active");BX.remove(p);try{e=JSON.parse(e)}catch(e){BX.debug("Error decoding server response");return false}if(e.SUCCESS===true){if(BX.type.isFunction(t)){t(e.DATA,i.externalRequestId)}else if(BX.SidePanel.Instance.isOpen()){BX.SidePanel.Instance.postMessage(window,"QueueEditor::onSave",{DATA:e.DATA});BX.SidePanel.Instance.close()}else{jsUtils.Redirect([],i.groupListUrl)}}else{alert(e.ERROR)}},onfailure:function(){BX.removeClass(r,"webform-small-button-wait webform-small-button-active");BX.remove(p);BX.debug("Failed to save group")}})};BX.ViGroupEdit.prototype._onCancelClick=function(e){BX.onCustomEvent(this,"onCancel",[this.externalRequestId]);BX.SidePanel.Instance.close()};BX.ViGroupEdit.prototype.destroy=function(){this.destination=null;BX.onCustomEvent(this,"onDestroy",[])}})();
//# sourceMappingURL=script.map.js