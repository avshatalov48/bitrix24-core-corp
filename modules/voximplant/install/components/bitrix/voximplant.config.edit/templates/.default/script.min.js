(function(e){BX.namespace("BX.Voximplant");if(e.BX.Voximplant.ConfigEditor){return}var t={isPaid:false,isDemo:false,ivrEnabled:false,canSelectLine:false,isTimemanInstalled:false,isBitrix24:false,maximumGroups:0};var i="/bitrix/components/bitrix/voximplant.config.edit/ajax.php";BX.Voximplant.ConfigEditor=function(e){this.node=e.node;this.melodies=e.melodies;this.accessCodes=e.accessCodes||{};this.portalMode=e.portalMode;this.sipConfig=e.sipConfig;this.popupTooltip={};this.groupSliderOpen=false;this.currentGroupId=null;this.previousGroupId=null;this.ivrSliderOpen=false;this.currentIvrId=null;this.previousIvrId=null;this._onTooltipMouseOverHandler=this._onTooltipMouseOver.bind(this);this._onTooltipMouseOutHandler=this._onTooltipMouseOut.bind(this);this.pages={};this.getNodes("page",document).forEach(function(e){this.pages[e.dataset.page]=e},this);this.map={"welcome-melody":"welcome-melody-settings","enable-ivr":"ivr-settings","enable-crm-forward":"crm-forward-settings","enable-recording":"recording-settings","enable-worktime":"worktime-settings","number-selection":"number-selection-settings","callback-redial":"callback-redial-settings","backup-number":"backup-number-settings","enable-sip-detect-line-number":"sip-detect-line-number-settings"};this.sipNumberSelector=BX.UI.TileSelector.getById("sip-numbers");this.numberInputPopup=null;Object.keys(this.map).forEach(function(e){var t=this.getNode(e);var i=this.getNode(this.map[e]);if(t&&i){BX.bind(t,"change",this._onCheckBoxChange.bind(this))}},this);this.elements={sipNeedUpdate:BX("sip-need-update"),sipStatus:BX("sip-status"),sipStatusText:BX("sip-status-text")};this.init();this.bindEvents()};BX.Voximplant.ConfigEditor.setDefaults=function(e){for(var i in e){if(e.hasOwnProperty(i)&&t.hasOwnProperty(i)){t[i]=e[i]}}};BX.Voximplant.ConfigEditor.prototype.getNode=function(e,t){if(!t)t=this.node;return t?t.querySelector('[data-role="'+e+'"]'):null};BX.Voximplant.ConfigEditor.prototype.getNodes=function(e,t){if(!t)t=this.node;return t?t.querySelectorAll('[data-role="'+e+'"]'):null};BX.Voximplant.ConfigEditor.prototype.init=function(){this.currentGroupId=this.getNode("select-group").value;for(var e in this.melodies){if(this.melodies.hasOwnProperty(e)){this.loadMelody(e,this.melodies[e])}}if(this.getNode("crm-create")){this.setCrmCreate(this.getNode("crm-create").value)}if(this.portalMode==="SIP"&&this.sipConfig.TYPE==="cloud"){this.checkSipState()}this.sipNumberSelector.getTiles().forEach(function(e){e.changeRemoving(e.data.canRemove)},this)};BX.Voximplant.ConfigEditor.prototype.bindEvents=function(){var i=this;var o=this.getNode("line-access");if(o){this.lineAccessEditor=new AccessEdit({node:o,accessCodes:this.accessCodes})}var n=BX.findChildrenByClassName(BX("tel-set-main-wrap"),"tel-context-help");BX.bind(this.getNode("show-group-config"),"click",this.onShowGroupClick.bind(this));BX.bind(this.getNode("show-crm-exception-list"),"click",this.onShowCrmExceptionListClick.bind(this));BX.bind(this.getNode("show-ivr-config"),"click",this.onShowIvrClick.bind(this));BX.bind(this.getNode("select-group"),"change",this._onGroupIdChanged.bind(this));BX.bind(this.getNode("select-ivr"),"change",this._onIvrIdChanged.bind(this));BX.bind(this.getNode("input-line-prefix"),"input",this._onInputLinePrefixInput.bind(this));BX.bind(this.getNode("more-tunes"),"click",this._onMoreTunesClick.bind(this));BX.bind(this.getNode("delete-caller-id"),"click",this._onDeleteCallerIdClick.bind(this));BX.bind(this.getNode("delete-number"),"click",this._onDeleteNumberClick.bind(this));BX.bind(this.getNode("cancel-number-delete"),"click",this._onCancelNumberDeleteClick.bind(this));BX.bind(BX("config_edit_form").elements["MELODY_LANG"],"change",this._onMelodyLangChange.bind(this));this.getNodes("menu-item",document).forEach(function(e){BX.bind(e,"click",this.onMenuItemClick.bind(this))},this);BX.addCustomEvent(e,"SidePanel.Slider:onClose",this._onSliderClosed.bind(this));BX.addCustomEvent(e,"SidePanel.Slider:onMessage",this._onSliderMessageReceived.bind(this));BX.bind(this.getNode("crm-create"),"change",this._onCrmCreateChange.bind(this));if(!t.isTimemanInstalled){BX.bind(BX("vi_timeman"),"change",function(e){BX("vi_timeman").checked=false;BX.Voximplant.alert(BX.message("VI_CONFIG_EDIT_ERROR"),t.isBitrix24?BX.message("VI_CONFIG_EDIT_TIMEMAN_SUPPORT_B24"):BX.message("VI_CONFIG_EDIT_TIMEMAN_SUPPORT_CP"))})}BX.addCustomEvent(this.sipNumberSelector,this.sipNumberSelector.events.buttonAdd,this.onAddSipNumberButtonClick.bind(this));BX.addCustomEvent(this.sipNumberSelector,this.sipNumberSelector.events.tileRemove,this.onNumberSelectorRemoveTile.bind(this))};BX.Voximplant.ConfigEditor.prototype.onMenuItemClick=function(e){var t=e.currentTarget.dataset.page;this.setActivePage(t)};BX.Voximplant.ConfigEditor.prototype.setActivePage=function(e){for(var t in this.pages){if(!this.pages.hasOwnProperty(t)){continue}if(t==e){this.pages[t].classList.add("active")}else{this.pages[t].classList.remove("active")}}if(e==="unlink"){this.getNode("button-panel").style.display="none"}else{this.getNode("button-panel").style.display="block"}};BX.Voximplant.ConfigEditor.prototype.checkSipState=function(){var e=this.sipConfig.REG_ID;BX.ajax.runComponentAction("bitrix:voximplant.config.edit","checkConnection",{data:{registrationId:e}}).then(function(e){var t=e.data;var i;var o=[BX.create("div",{text:BX.message("VI_CONFIG_SIP_C_STATUS_"+t.statusResult.toUpperCase()+"_DESC")})];if(t.statusResult==="success"){i="ui-alert ui-alert-success ui-alert-icon-info"}else if(t.statusResult==="in_progress"){i="ui-alert ui-alert-warning ui-alert-icon-warning";setTimeout(this.checkSipState.bind(this),3e4)}else if(t.statusResult==="error"){i="ui-alert ui-alert-danger ui-alert-icon-danger";this.elements.sipNeedUpdate.value="Y";o=[BX.create("div",{text:BX.message("VI_CONFIG_SIP_ERROR_1").replace("#DATE#",t.lastUpdated)}),BX.create("div",{text:BX.message("VI_CONFIG_SIP_ERROR_2").replace("#CODE#",t.statusCode)}),BX.create("div",{text:BX.message("VI_CONFIG_SIP_ERROR_3").replace("#MESSAGE#",t.errorMessage)})]}BX.cleanNode(this.elements.sipStatus);BX.cleanNode(this.elements.sipStatusText);BX.adjust(this.elements.sipStatus,{props:{className:i},children:[BX.create("span",{props:{className:"ui-alert-message"},text:BX.message("VI_CONFIG_SIP_C_STATUS_"+t.statusResult.toUpperCase())})]});BX.adjust(this.elements.sipStatusText,{props:{className:"ui-alert ui-alert-warning"},children:[BX.create("span",{props:{className:"ui-alert-message"},children:o})]})}.bind(this)).catch(function(e){var t=e.errors[0];BX.cleanNode(this.elements.sipStatus);BX.cleanNode(this.elements.sipStatusText);BX.adjust(this.elements.sipStatus,{props:{className:"ui-alert ui-alert-danger ui-alert-icon-danger"},children:[BX.create("span",{props:{className:"ui-alert-message"},text:BX.message("VI_CONFIG_SIP_C_STATUS_ERROR")})]});BX.adjust(this.elements.sipStatusText,{props:{className:"ui-alert ui-alert-warning"},children:[BX.create("span",{props:{className:"ui-alert-message"},children:[BX.create("div",{text:BX.message("VI_CONFIG_SIP_ERROR_1").replace("#DATE#","n/a")}),BX.create("div",{text:BX.message("VI_CONFIG_SIP_ERROR_2").replace("#CODE#","ACCOUNT_ERROR")}),BX.create("div",{text:BX.message("VI_CONFIG_SIP_ERROR_3").replace("#MESSAGE#",t.message)})]})]})}.bind(this))};BX.Voximplant.ConfigEditor.prototype.loadMelody=function(t,i){if(typeof i!=="object")return;var o=i.INPUT_NAME||"";var n=i.DEFAULT_MELODY||"";var s=BX["MFInput"]?BX.MFInput.get(t):null;var r=this.getNode("melody-container-"+t);if(r&&!i.HIDDEN){r.classList.add("active")}BX(t+"span").appendChild(BX("file_input_"+t));if(s){BX.bind(BX(t+"default"),"click",function(){s.clear()});BX.addCustomEvent(s,"onDeleteFile",function(){BX.hide(BX(t+"default"));BX.show(BX(t+"notice"));var e=BX.Fileman.PlayerManager.getPlayerById(t+"player");e.setSource(n.replace("#LANG_ID#",BX("config_edit_form").elements["MELODY_LANG"].value))});BX.addCustomEvent(s,"onUploadDone",function(e,i){BX.show(BX(t+"default"));BX.hide(BX(t+"notice"));var o=BX.Fileman.PlayerManager.getPlayerById(t+"player");o.setSource(e["url"]+(e["url"].indexOf(".mp3")>0?"":"&/melody.mp3"))})}else{BX.bind(BX(t+"default"),"click",function(){e["FILE_INPUT_"+t]._deleteFile(BX("config_edit_form").elements[o])});BX.addCustomEvent(e["FILE_INPUT_"+t],"onSubmit",function(){BX(t+"span").appendChild(BX.create("SPAN",{attrs:{id:t+"waiter"},props:{className:"webform-field-upload-list"},html:"<i></i>"}))});BX.addCustomEvent(e["FILE_INPUT_"+t],"onFileUploaderChange",function(){e["FILE_INPUT_"+t].INPUT.disabled=false});BX.addCustomEvent(e["FILE_INPUT_"+t],"onDeleteFile",function(i){BX.hide(BX(t+"default"));BX(t+"notice").innerHTML=BX.message("VI_CONFIG_EDIT_DOWNLOAD_TUNE_TIP");var o=BX.Fileman.PlayerManager.getPlayerById(t+"player");o.setSource(n.replace("#LANG_ID#",BX("config_edit_form").elements["MELODY_LANG"].value));e["FILE_INPUT_"+t].INPUT.disabled=false});BX.addCustomEvent(e["FILE_INPUT_"+t],"onDone",function(e,i,o){BX.remove(BX(t+"waiter"));if(!!e&&e.length>0){var n=BX(t+"notice");if(o===false&&!!e[0]){if(i!=="init"){n.innerHTML=BX.message("VI_CONFIG_EDIT_UPLOAD_SUCCESS");var s=BX.Fileman.PlayerManager.getPlayerById(t+"player");s.setSource(e[0]["fileURL"]);BX(t+"default").style.display=""}}else if(!!e[0]&&e[0]["error"]){n.innerHTML=e[0]["error"]}}})}};BX.Voximplant.ConfigEditor.prototype._onTooltipMouseOver=function(e){this.showTooltip(e.target.dataset.id,e.target,e.target.dataset.text)};BX.Voximplant.ConfigEditor.prototype._onTooltipMouseOut=function(e){this.hideTooltip(e.target.dataset.id)};BX.Voximplant.ConfigEditor.prototype.showTooltip=function(e,t,i){if(this.popupTooltip[e])this.popupTooltip[e].close();this.popupTooltip[e]=new BX.PopupWindow("bx-voximplant-tooltip",t,{lightShadow:true,autoHide:false,darkMode:true,offsetLeft:0,offsetTop:2,bindOptions:{position:"top"},zIndex:200,events:{onPopupClose:function(){this.destroy()}},content:BX.create("div",{attrs:{style:"padding-right: 5px; width: 250px;"},html:i})});this.popupTooltip[e].setAngle({offset:13,position:"bottom"});this.popupTooltip[e].show();return true};BX.Voximplant.ConfigEditor.prototype.hideTooltip=function(e){this.popupTooltip[e].close();this.popupTooltip[e]=null};BX.Voximplant.ConfigEditor.prototype.onShowGroupClick=function(e){this.showGroupSettings({groupId:this.getNode("select-group").value})};BX.Voximplant.ConfigEditor.prototype.onShowCrmExceptionListClick=function(e){BX.SidePanel.Instance.open("/crm/configs/exclusion/",{cacheable:false})};BX.Voximplant.ConfigEditor.prototype.onShowIvrClick=function(e){this.showIvrSettings({ivrId:this.getNode("select-ivr").value})};BX.Voximplant.ConfigEditor.prototype.onAddSipNumberButtonClick=function(e){this.numberInputPopup=new o({bindElement:this.sipNumberSelector.buttonAdd,onAdd:this.addSipNumber.bind(this),onCancel:function(){this.numberInputPopup.close()}.bind(this),onDestroy:function(){this.numberInputPopup=null}.bind(this)});this.numberInputPopup.show()};BX.Voximplant.ConfigEditor.prototype.addSipNumber=function(e){BX.ajax.runComponentAction("bitrix:voximplant.config.edit","addSipNumber",{data:{sipId:this.sipConfig.ID,number:e.number}}).then(function(e){this.numberInputPopup.close();var t=e.data;this.sipNumberSelector.addTile(t["FORMATTED_NUMBER"],{canRemove:true},t["NUMBER"])}.bind(this)).catch(function(e){this.numberInputPopup.close();BX.Voximplant.alert(" ",e.errors[0].message)}.bind(this))};BX.Voximplant.ConfigEditor.prototype.onNumberSelectorRemoveTile=function(e){BX.ajax.runComponentAction("bitrix:voximplant.config.edit","removeSipNumber",{data:{sipId:this.sipConfig.ID,number:e.id}}).catch(function(e){console.error(e.errors[0].message)})};BX.Voximplant.ConfigEditor.prototype.showGroupSettings=function(e){var t=parseInt(e.groupId);if(BX.SidePanel.Instance.open("/telephony/editgroup.php?ID="+t,{cacheable:false})){this.groupSliderOpen=true}};BX.Voximplant.ConfigEditor.prototype.showIvrSettings=function(e){var t=parseInt(e.ivrId);if(BX.SidePanel.Instance.open("/telephony/editivr.php?ID="+t,{cacheable:false})){this.ivrSliderOpen=true}};BX.Voximplant.ConfigEditor.prototype.deleteCallerId=function(e){BX.Voximplant.confirm(BX.message("VOX_CONFIG_CONFIRM_ACTION"),BX.message("VOX_CONFIG_CALLERID_DELETE_CONFIRM").replace("#NUMBER#",e)).then(function(t){if(!t){return}BX.Voximplant.showLoader();BX.ajax.runAction("voximplant.callerId.delete",{data:{phoneNumber:e}}).then(function(){BX.Voximplant.hideLoader();BX.SidePanel.Instance.close()}).catch(function(e){BX.Voximplant.hideLoader();var t=e.errors[0];BX.Voximplant.alert(BX.message("VOX_LINES_ERROR"),t.message)})})};BX.Voximplant.ConfigEditor.prototype.deleteNumber=function(e){BX.Voximplant.NumberRent.create().deleteNumber(e).then(function(){BX.SidePanel.Instance.close()})};BX.Voximplant.ConfigEditor.prototype.cancelDeleteNumber=function(e){BX.Voximplant.NumberRent.create().cancelNumberDeletion(e).then(function(){BX.SidePanel.Instance.close()})};BX.Voximplant.ConfigEditor.prototype._onGroupIdChanged=function(e){var i=e.target.value;var o=e.target.options.length-2;if(i==="new"){if(t.maximumGroups>0&&o>=t.maximumGroups){e.target.value=e.target.options.item(2).value;BX.Voximplant.showLicensePopup("groups")}else{this.showGroupSettings({groupId:0})}}this.previousGroupId=this.currentGroupId;this.currentGroupId=i;BX.PreventDefault(e)};BX.Voximplant.ConfigEditor.prototype._onIvrIdChanged=function(e){var t=e.target.value;if(t==="new"){this.showIvrSettings({ivrId:0})}this.previousIvrId=this.currentIvrId;this.currentIvrId=t;BX.PreventDefault(e)};BX.Voximplant.ConfigEditor.prototype._onSliderClosed=function(e){if(this.groupSliderOpen){this.groupSliderOpen=false;if(this.currentGroupId==="new"){this.getNode("select-group").value=this.previousGroupId;this.currentGroupId=this.previousGroupId}}else if(this.ivrSliderOpen){if(this.currentIvrId==="new"){this.getNode("select-ivr").value=this.previousIvrId;this.currentIvrId=this.previousIvrId}}};BX.Voximplant.ConfigEditor.prototype._onSliderMessageReceived=function(e){var t=e.getEventId();if(t==="QueueEditor::onSave"){var i=e.getData()["DATA"]["GROUP"];if(!i["ID"]){return}this.afterGroupSaved(i)}else if(t==="IvrEditor::onSave"){var o=e.getData()["ivr"];if(!o["ID"]){return}this.afterIvrSaved(o)}};BX.Voximplant.ConfigEditor.prototype.setCrmCreate=function(e){if(e==="lead"){this.getNode("crm-source-select").disabled=false;this.getNode("crm-create-call-type").disabled=false}else{this.getNode("crm-source-select").disabled=true;this.getNode("crm-create-call-type").disabled=true}};BX.Voximplant.ConfigEditor.prototype._onCrmCreateChange=function(e){this.setCrmCreate(e.currentTarget.value)};BX.Voximplant.ConfigEditor.prototype._onCheckBoxChange=function(e){var t=e.currentTarget;var i=t.dataset.role;var o=t.dataset.locked==="Y";var n=t.dataset.licensePopup;if(o&&n){BX.Voximplant.showLicensePopup(n);t.checked=false;e.preventDefault()}else if(this.map.hasOwnProperty(i)){var s=this.getNode(this.map[i]);if(s){if(t.checked){s.style.maxHeight=s.dataset.height}else{s.style.maxHeight=0}}}};BX.Voximplant.ConfigEditor.prototype._onInputLinePrefixInput=function(e){var t=e.target;t.value=t.value.replace(/[^\d#*]/g,"");e.preventDefault()};BX.Voximplant.ConfigEditor.prototype._onMelodyLangChange=function(e){var t=e.currentTarget.value;for(var i in this.melodies){if(!this.melodies.hasOwnProperty(i)){continue}var o=this.melodies[i]["INPUT_NAME"];var n=BX.Fileman.PlayerManager.getPlayerById(i+"player");var s=this.melodies[i]["DEFAULT_MELODY"];if(!BX("config_edit_form").elements[o]){n.setSource(s.replace("#LANG_ID#",t))}}};BX.Voximplant.ConfigEditor.prototype._onMoreTunesClick=function(e){for(var t in this.melodies){var i=this.getNode("melody-container-"+t);if(i){i.classList.add("active")}}BX.remove(e.currentTarget)};BX.Voximplant.ConfigEditor.prototype._onDeleteCallerIdClick=function(e){var t=e.currentTarget.dataset.number;if(BX.type.isNotEmptyString(t)){this.deleteCallerId(t)}};BX.Voximplant.ConfigEditor.prototype._onDeleteNumberClick=function(e){var t=e.currentTarget.dataset.number;if(BX.type.isNotEmptyString(t)){this.deleteNumber(t)}};BX.Voximplant.ConfigEditor.prototype._onCancelNumberDeleteClick=function(e){var t=e.currentTarget.dataset.number;if(BX.type.isNotEmptyString(t)){this.cancelDeleteNumber(t)}};BX.Voximplant.ConfigEditor.prototype.afterGroupSaved=function(e){var t=this.getNode("select-group");var i=false;var o;for(var n=0;n<t.options.length;n++){o=t.options.item(n);if(o.value==e.ID){o.innerText=BX.util.htmlspecialchars(e.NAME);i=true;break}}if(!i){t.add(BX.create("option",{attrs:{value:e.ID},text:BX.util.htmlspecialchars(e.NAME)}))}t.value=e.ID;this.currentGroupId=e.ID};BX.Voximplant.ConfigEditor.prototype.afterIvrSaved=function(e){var t=this.getNode("select-ivr");var i=false;var o;for(var n=0;n<t.options.length;n++){o=t.options.item(n);if(o.value==e.ID){o.innerText=BX.util.htmlspecialchars(e.NAME);i=true;break}}if(!i){t.add(BX.create("option",{attrs:{value:e.ID},text:BX.util.htmlspecialchars(e.NAME)}))}t.value=e.ID;this.currentIvrId=e.ID};var o=function(e){this.popup=null;this.bindElement=e.bindElement;this.input=null;this.value="";this.callbacks={onAdd:BX.type.isFunction(e.onAdd)?e.onAdd:BX.DoNothing,onCancel:BX.type.isFunction(e.onCancel)?e.onCancel:BX.DoNothing,onDestroy:BX.type.isFunction(e.onDestroy)?e.onDestroy:BX.DoNothing}};o.prototype={show:function(){if(this.popup){this.popup.show();return}this.popup=new BX.PopupWindow("vox-config-add-number",this.bindElement,{autoHide:true,closeByEsc:true,closeIcon:false,contentNoPaddings:true,contentColor:"white",events:{onPopupClose:function(){this.destroy()}.bind(this),onPopupDestroy:function(){this.popup=null}.bind(this)},content:BX.create("div",{children:[this.input=BX.create("input",{props:{className:"voximplant-control-input"},events:{keyup:this.onInputKeyUp.bind(this)}})]}),buttons:[new BX.PopupWindowCustomButton({id:"button-add",text:BX.message("VI_CONFIG_SIP_ADD"),className:"ui-btn ui-btn-sm ui-btn-primary",events:{click:this.onAddButtonClick.bind(this)}}),new BX.PopupWindowCustomButton({id:"button-cancel",text:BX.message("VI_CONFIG_SIP_CANCEL"),className:"ui-btn ui-btn-sm ui-btn-link",events:{click:this.onCancelButtonClick.bind(this)}})]});this.inputFormatted=new BX.PhoneNumber.Input({node:this.input,onChange:this.onInputChange.bind(this)});this.popup.show();this.input.focus()},close:function(){if(this.popup){this.popup.close()}},onInputChange:function(e){this.value=e.value},onInputKeyUp:function(e){if(e.key==="Enter"){this.onAddButtonClick();e.preventDefault();e.stopPropagation()}},onAddButtonClick:function(){this.popup.getButton("button-add").addClassName("ui-btn-wait");this.callbacks.onAdd({number:this.value})},onCancelButtonClick:function(){this.close()},destroy:function(){this.popup.destroy();this.callbacks.onDestroy()}}})(window);
//# sourceMappingURL=script.map.js